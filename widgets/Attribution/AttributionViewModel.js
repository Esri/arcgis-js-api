// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../geometry","../../core/arrayUtils","../../core/asyncUtils","../../core/Collection","../../core/HandleOwner","../../core/watchUtils","../../core/accessorSupport/decorators","../../geometry/support/contains","../../geometry/support/webMercatorUtils"],(function(t,e,i,n,r,o,a,s,u,c,l,d){"use strict";function p(t,e,i){i&&e&&(r.find(t,(function(t){return t.layerView===e&&t.text===i}))||t.push({text:i,layerView:e}))}var h=[];return function(t){function e(e){var i=t.call(this,e)||this;return i.clear=function(){i._fetchedAttributionData.clear(),i._pendingAttributions.clear(),i.handles.remove("suspension"),i.notifyChange("state")},i._pendingAttributions=new Set,i._fetchedAttributionData=new Map,i.items=new a,i.view=null,i._allLayerViewsChange=function(t){i.handles.remove("suspension");var e=i.get("view.allLayerViews");e&&i.handles.add(e.map((function(t){return t.watch(["suspended","attributionVisible"],i._updateAttributionItems)})),"suspension"),t&&t.removed&&t.removed.forEach((function(t){i._pendingAttributions.delete(t),i._fetchedAttributionData.delete(t)})),i._updateAttributionItems()},i._updateAttributionItems=function(){var t,e,n=i.get("view.allLayerViews");(h.length=0,n)?(n.forEach((function(t){if(!t.suspended&&t.get("layer.attributionVisible")){var e=t.layer;if(function(t){return t&&"copyright"in t&&"function"==typeof t.originOf&&"user"===t.originOf("copyright")}(e))p(h,t,e.copyright);else if(e.hasAttributionData){if(i._fetchedAttributionData.has(t)){var n=i._fetchedAttributionData.get(t);return void(n&&p(h,t,i._getDynamicAttribution(n,i.view,e)))}i._fetchAttributionData(t)}else{var r=e.get("portalItem.accessInformation");p(h,t,r||e.copyright)}}})),t=i.items,e=h,(t.length!==e.length||t.some((function(t,i){return t.text!==e[i].text})))&&(i.items.removeAll(),i.items.addMany(h)),h.length=0,i.notifyChange("state")):i.clear()},i.handles.add([u.on(i,"view.allLayerViews","change",i._allLayerViewsChange,i._allLayerViewsChange,i.clear),u.whenTrue(i,"view.stationary",(function(){return i._updateAttributionItems()}))]),i}return i.__extends(e,t),e.prototype.destroy=function(){this.view=null,this._fetchedAttributionData.clear(),this._pendingAttributions.clear(),this.items.removeAll()},Object.defineProperty(e.prototype,"state",{get:function(){return this.get("view.ready")?this._pendingAttributions.size>0?"loading":"ready":"disabled"},enumerable:!1,configurable:!0}),e.prototype._fetchAttributionData=function(t){return i.__awaiter(this,void 0,void 0,(function(){var e,n;return i.__generator(this,(function(i){switch(i.label){case 0:return this._pendingAttributions.has(t)?[2]:(this._pendingAttributions.add(t),[4,o.result(t.layer.fetchAttributionData())]);case 1:return e=i.sent(),this._pendingAttributions.has(t)&&(n=e.ok?this._createContributionIndex(e.value,"bing-maps"===t.layer.type):null,this._pendingAttributions.delete(t),this._fetchedAttributionData.set(t,n)),this._updateAttributionItems(),[2]}}))}))},e.prototype._createContributionIndex=function(t,e){var i=t.contributors,r={};if(!i)return r;for(var o=0;o<i.length;o++){var a=i[o],s=a.coverageAreas;if(!s)return;for(var u=0,c=s;u<c.length;u++)for(var l=c[u],p=l.bbox,h=l.zoomMin-(e&&l.zoomMin?1:0),f=l.zoomMax-(e&&l.zoomMax?1:0),b={xmin:p[1],ymin:p[0],xmax:p[3],ymax:p[2],spatialReference:n.SpatialReference.WGS84},y={extent:d.geographicToWebMercator(b),attribution:a.attribution||"",score:null!=l.score?l.score:100,id:o},g=h;g<=f;g++)r[g]=r[g]||[],r[g].push(y)}return r.maxKey=Math.max.apply(null,Object.keys(r)),r},e.prototype._getDynamicAttribution=function(t,e,i){var n=e.extent,r=e.scale,o=i.tileInfo.scaleToZoom(r);if(o=Math.min(t.maxKey,Math.round(o)),!n||null==o||o<=-1)return"";var a=t[o],s=d.project(n.center.clone().normalize(),e.spatialReference),u={};return a?a.filter((function(t){var e=!u[t.id]&&s&&l.extentContainsPoint(t.extent,s);return e&&(u[t.id]=!0),e})).sort((function(t,e){return e.score-t.score||t.objectId-e.objectId})).map((function(t){return t.attribution})).join(", "):""},i.__decorate([c.property({readOnly:!0,type:a})],e.prototype,"items",void 0),i.__decorate([c.property({dependsOn:["view.ready"],readOnly:!0})],e.prototype,"state",null),i.__decorate([c.property()],e.prototype,"view",void 0),e=i.__decorate([c.subclass("esri.widgets.Attribution.AttributionViewModel")],e)}(s.HandleOwner)}));