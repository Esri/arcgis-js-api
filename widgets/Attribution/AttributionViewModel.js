/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/has","../../core/Logger","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/subclass","../../core/urlUtils","../../core/uuid","../../portal/support/resourceExtension","../../geometry/SpatialReference","../../geometry/support/webMercatorUtils","../../geometry/support/contains","../../geometry","../../core/Collection","../../core/asyncUtils","../../core/watchUtils","../../core/HandleOwner"],(function(t,e,i,n,r,o,a,s,c,u,l,d,p,h,y,b,f,g){"use strict";function m(t,e,i){if(!i||!e)return;t.find((t=>t.layerView===e&&t.text===i))||t.push({text:i,layerView:e})}const _=[];let A=function(e){function i(i){var n;return(n=e.call(this,i)||this).clear=()=>{n._fetchedAttributionData.clear(),n._pendingAttributions.clear(),n.handles.remove("suspension"),n.notifyChange("state")},n._pendingAttributions=new Set,n._fetchedAttributionData=new Map,n.items=new y,n.view=null,n._allLayerViewsChange=t=>{n.handles.remove("suspension");const e=n.get("view.allLayerViews");e&&n.handles.add(e.map((t=>t.watch(["suspended","attributionVisible"],n._updateAttributionItems))),"suspension"),t&&t.removed&&t.removed.forEach((t=>{n._pendingAttributions.delete(t),n._fetchedAttributionData.delete(t)})),n._updateAttributionItems()},n._updateAttributionItems=()=>{const t=n.get("view.allLayerViews");var e,i;(_.length=0,t)?(t.forEach((t=>{if(t.suspended||!t.get("layer.attributionVisible"))return;const e=t.layer;if(function(t){return t&&"copyright"in t&&"function"==typeof t.originOf&&"user"===t.originOf("copyright")}(e))return void m(_,t,e.copyright);if(e.hasAttributionData){if(n._fetchedAttributionData.has(t)){const i=n._fetchedAttributionData.get(t);return void(i&&m(_,t,n._getDynamicAttribution(i,n.view,e)))}return void n._fetchAttributionData(t)}const i=e.get("portalItem.accessInformation");m(_,t,i||e.copyright)})),e=n.items,i=_,(e.length!==i.length||e.some(((t,e)=>t.text!==i[e].text)))&&(n.items.removeAll(),n.items.addMany(_)),_.length=0,n.notifyChange("state")):n.clear()},n.handles.add([f.on(t._assertThisInitialized(n),"view.allLayerViews","change",n._allLayerViewsChange,n._allLayerViewsChange,n.clear),f.whenTrue(t._assertThisInitialized(n),"view.stationary",(()=>n._updateAttributionItems()))]),n}t._inheritsLoose(i,e);var n=i.prototype;return n.destroy=function(){this.view=null,this._fetchedAttributionData.clear(),this._pendingAttributions.clear(),this.items.removeAll()},n._fetchAttributionData=async function(t){if(this._pendingAttributions.has(t))return;this._pendingAttributions.add(t);const e=await b.result(t.layer.fetchAttributionData());if(this._pendingAttributions.has(t)){const i=e.ok?this._createContributionIndex(e.value,"bing-maps"===t.layer.type):null;this._pendingAttributions.delete(t),this._fetchedAttributionData.set(t,i)}this._updateAttributionItems()},n._createContributionIndex=function(t,e){const i=t.contributors,n={};if(!i)return n;for(let t=0;t<i.length;t++){const r=i[t],o=r.coverageAreas;if(!o)return;for(const i of o){const o=i.bbox,a=i.zoomMin-(e&&i.zoomMin?1:0),s=i.zoomMax-(e&&i.zoomMax?1:0),c={xmin:o[1],ymin:o[0],xmax:o[3],ymax:o[2],spatialReference:l.WGS84},u={extent:d.geographicToWebMercator(c),attribution:r.attribution||"",score:null!=i.score?i.score:100,id:t};for(let t=a;t<=s;t++)n[t]=n[t]||[],n[t].push(u)}}return n.maxKey=Math.max.apply(null,Object.keys(n)),n},n._getDynamicAttribution=function(t,e,i){const{extent:n,scale:r}=e;let o=i.tileInfo.scaleToZoom(r);if(o=Math.min(t.maxKey,Math.round(o)),!n||null==o||o<=-1)return"";const a=t[o],s=d.project(n.center.clone().normalize(),e.spatialReference),c={};return a?a.filter((t=>{const e=!c[t.id]&&s&&p.extentContainsPoint(t.extent,s);return e&&(c[t.id]=!0),e})).sort(((t,e)=>e.score-t.score||t.objectId-e.objectId)).map((t=>t.attribution)).join(", "):""},t._createClass(i,[{key:"state",get:function(){return this.get("view.ready")?this._pendingAttributions.size>0?"loading":"ready":"disabled"}}]),i}(g.HandleOwner);return e.__decorate([o.property({readOnly:!0,type:y})],A.prototype,"items",void 0),e.__decorate([o.property({dependsOn:["view.ready"],readOnly:!0})],A.prototype,"state",null),e.__decorate([o.property()],A.prototype,"view",void 0),A=e.__decorate([a.subclass("esri.widgets.Attribution.AttributionViewModel")],A),A}));
