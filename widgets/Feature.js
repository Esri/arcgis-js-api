/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["require","../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../intl","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/cast","../core/arrayUtils","../core/accessorSupport/decorators/subclass","./Widget","./Feature/FeatureAttachments","./Feature/FeatureContent","./Feature/FeatureExpression","./Feature/FeatureFields","./Feature/FeatureMedia","./Feature/FeatureRelationship","./Feature/FeatureViewModel","./Feature/resources","./Feature/support/FeatureContentMixin","./support/Heading","./support/widgetUtils","./support/decorators/messageBundle","./support/jsxFactory","../intl/substitute"],(function(e,t,n,s,i,r,o,l,d,a,c,u,p,h,y,m,v,f,g,_,w,M,C,E){"use strict";var S;const b={title:!0,content:!0,lastEditedInfo:!0},x="relationship-handles";let F=S=function(n){function s(e,t){var s;return(s=n.call(this,e,t)||this)._contentWidgets=[],s.flowItems=null,s.headingLevel=2,s.messages=null,s.messagesCommon=null,s.messagesURIUtils=null,s.visibleElements={...b},s.viewModel=new v,s}t._inheritsLoose(s,n);var r=s.prototype;return r.initialize=function(){this.addHandles(i.watch((()=>this.viewModel?.contentViewModels),(()=>this._setupContentWidgets()),i.initial))},r.loadDependencies=function(){return new Promise(((t,n)=>e(["../chunks/calcite-notice"],t,n)))},r.destroy=function(){this._destroyContentWidgets()},r.castVisibleElements=function(e){return{...b,...e}},r.render=function(){const{state:e}=this.viewModel,t=C.tsx("div",{class:f.CSS.container,key:"container"},this.renderTitle(),"error"===e?this.renderError():"loading"===e?this.renderLoading():this.renderContentContainer());return C.tsx("div",{class:this.classes(f.CSS.base,f.CSS.esriWidget)},t)},r.setActiveMedia=function(e,t){return this.viewModel.setActiveMedia(e,t)},r.nextMedia=function(e){return this.viewModel.nextMedia(e)},r.previousMedia=function(e){return this.viewModel.previousMedia(e)},r.renderError=function(){const{messagesCommon:e,messages:t,visibleElements:n}=this;return C.tsx("calcite-notice",{open:!0,kind:"danger",icon:"exclamation-mark-circle",scale:"s"},n.title?C.tsx("div",{key:"error-title",slot:"title"},e.errorMessage):null,C.tsx("div",{key:"error-message",slot:"message"},t.loadingError))},r.renderLoading=function(){return C.tsx("div",{key:"loading-container",class:f.CSS.loadingSpinnerContainer},C.tsx("span",{class:this.classes(f.CSS.iconLoading,f.CSS.spinner)}))},r.renderContentContainer=function(){const{visibleElements:e}=this;return e.content?C.tsx("div",{class:f.CSS.main},[this.renderContent(),this.renderLastEditInfo()]):null},r.renderTitle=function(){const{visibleElements:e,title:t}=this;return e.title?C.tsx(_.Heading,{level:this.headingLevel,class:f.CSS.title,innerHTML:t}):null},r.renderContent=function(){const e=this.viewModel.content,t="content";if(!e)return null;if(Array.isArray(e))return e.length?C.tsx("div",{class:f.CSS.contentNode,key:`${t}-content-elements`},e.map(this.renderContentElement,this)):null;if("string"==typeof e){const e=this._contentWidgets[0];return!e||e.destroyed?null:C.tsx("div",{class:f.CSS.contentNode,key:`${t}-content`},e.render())}return this.renderNodeContent(e)},r.renderContentElement=function(e,t){const{visibleElements:n}=this;if("boolean"!=typeof n.content&&!n.content?.[e.type])return null;switch(e.type){case"attachments":return this.renderAttachments(t);case"custom":return this.renderCustom(e,t);case"fields":return this.renderFields(t);case"media":return this.renderMedia(t);case"text":return this.renderText(e,t);case"expression":return this.renderExpression(t);case"relationship":return this.renderRelationship(t);default:return null}},r.renderAttachments=function(e){const t=this._contentWidgets[e];if(!t||t.destroyed)return null;const{state:n,attachmentInfos:s}=t.viewModel;return"loading"===n||s.length>0?C.tsx("div",{key:this._buildKey("attachments-element",e),class:this.classes(f.CSS.contentElement)},t.render()):null},r.renderRelationship=function(e){const t=this._contentWidgets[e];return t&&!t.destroyed&&this.flowItems?C.tsx("div",{key:this._buildKey("relationship-element",e),class:f.CSS.contentElement},t.render()):null},r.renderExpression=function(e){const t=this._contentWidgets[e];return!t||t.destroyed?null:C.tsx("div",{key:this._buildKey("expression-element",e),class:f.CSS.contentElement},t.render())},r.renderCustom=function(e,t){const{creator:n}=e,s=this._contentWidgets[t];return!s||s.destroyed?null:n?C.tsx("div",{key:this._buildKey("custom-element",t),class:f.CSS.contentElement},s.render()):null},r.renderFields=function(e){const t=this._contentWidgets[e];return!t||t.destroyed?null:C.tsx("div",{key:this._buildKey("fields-element",e),class:f.CSS.contentElement},t.render())},r.renderMedia=function(e){const t=this._contentWidgets[e];return!t||t.destroyed?null:C.tsx("div",{key:this._buildKey("media-element",e),class:f.CSS.contentElement},t.render())},r.renderLastEditInfo=function(){const{visibleElements:e,messages:t}=this,{lastEditInfo:n}=this.viewModel;if(!n||!e.lastEditedInfo)return null;const{date:s,user:i}=n,r="edit"===n.type?i?t.lastEditedByUser:t.lastEdited:i?t.lastCreatedByUser:t.lastCreated,o=E.substitute(r,{date:s,user:i});return C.tsx("div",{key:"edit-info-element",class:this.classes(f.CSS.lastEditedInfo,f.CSS.contentElement)},o)},r.renderText=function(e,t){const n=e.text,s=this._contentWidgets[t];return!s||s.destroyed?null:n?C.tsx("div",{key:this._buildKey("text-element",t),class:this.classes(f.CSS.contentElement,f.CSS.text)},s.render()):null},r._buildKey=function(e,...t){return`${e}__${this.get("viewModel.graphic.uid")||"0"}-${t.join("-")}`},r._destroyContentWidget=function(e){e&&(e.viewModel=null,!e.destroyed&&e.destroy())},r._destroyContentWidgets=function(){this.removeHandles(x),this._contentWidgets.forEach((e=>this._destroyContentWidget(e))),this._contentWidgets=[]},r._addFeatureRelationshipHandles=function(e){const{flowItems:t,visibleElements:n}=this;this.addHandles([i.on((()=>e),"select-record",(({featureViewModel:e})=>{t&&(e.abilities={relationshipContent:!0},t.push(new S({flowItems:t,viewModel:e,visibleElements:n})))})),i.on((()=>e),"show-all-records",(()=>{if(!t)return;const{viewModel:n}=e;n.showAllEnabled=!0;const s=new m({visibleElements:{title:!1,description:!1},viewModel:n});this._addFeatureRelationshipHandles(s),t.push(s)}))],x)},r._setupContentWidgets=function(){this._destroyContentWidgets();const{headingLevel:e,visibleElements:t}=this,n=this.get("viewModel.content"),{contentViewModels:s}=this.viewModel;if(Array.isArray(n))n.forEach(((n,i)=>{if("attachments"===n.type&&(this._contentWidgets[i]=new c({displayType:n.displayType,headingLevel:t.title?e+1:e,viewModel:s[i]})),"fields"===n.type&&(this._contentWidgets[i]=new h({viewModel:s[i]})),"media"===n.type&&(this._contentWidgets[i]=new y({viewModel:s[i]})),"text"===n.type&&(this._contentWidgets[i]=new u({viewModel:s[i]})),"custom"===n.type&&(this._contentWidgets[i]=new u({viewModel:s[i]})),"expression"===n.type&&(this._contentWidgets[i]=new p({viewModel:s[i]})),"relationship"===n.type){const e=new m({viewModel:s[i]});this._addFeatureRelationshipHandles(e),this._contentWidgets[i]=e}}),this);else{const e=s[0];e&&!e.destroyed&&(this._contentWidgets[0]=new u({viewModel:e}))}this.scheduleRender()},t._createClass(s,[{key:"graphic",get:function(){return this.viewModel.graphic},set:function(e){this.viewModel.graphic=e}},{key:"defaultPopupTemplateEnabled",get:function(){return this.viewModel.defaultPopupTemplateEnabled},set:function(e){this.viewModel.defaultPopupTemplateEnabled=e}},{key:"isTable",get:function(){return this.viewModel.isTable}},{key:"label",get:function(){return this.messages?.widgetLabel??""},set:function(e){this._overrideIfSome("label",e)}},{key:"spatialReference",get:function(){return this.viewModel.spatialReference},set:function(e){this.viewModel.spatialReference=e}},{key:"title",get:function(){return this.viewModel.title}},{key:"map",get:function(){return this.viewModel.map},set:function(e){this.viewModel.map=e}},{key:"view",get:function(){return this.viewModel.view},set:function(e){this.viewModel.view=e}}]),s}(g.FeatureContentMixin(a));n.__decorate([r.property()],F.prototype,"graphic",null),n.__decorate([r.property()],F.prototype,"defaultPopupTemplateEnabled",null),n.__decorate([r.property()],F.prototype,"flowItems",void 0),n.__decorate([r.property()],F.prototype,"headingLevel",void 0),n.__decorate([r.property({readOnly:!0})],F.prototype,"isTable",null),n.__decorate([r.property()],F.prototype,"label",null),n.__decorate([r.property(),M.messageBundle("esri/widgets/Feature/t9n/Feature")],F.prototype,"messages",void 0),n.__decorate([r.property(),M.messageBundle("esri/t9n/common")],F.prototype,"messagesCommon",void 0),n.__decorate([r.property(),M.messageBundle("esri/widgets/support/t9n/uriUtils")],F.prototype,"messagesURIUtils",void 0),n.__decorate([r.property()],F.prototype,"spatialReference",null),n.__decorate([r.property({readOnly:!0})],F.prototype,"title",null),n.__decorate([r.property()],F.prototype,"visibleElements",void 0),n.__decorate([o.cast("visibleElements")],F.prototype,"castVisibleElements",null),n.__decorate([r.property()],F.prototype,"map",null),n.__decorate([r.property()],F.prototype,"view",null),n.__decorate([r.property({type:v})],F.prototype,"viewModel",void 0),F=S=n.__decorate([d.subclass("esri.widgets.Feature")],F);return F}));
