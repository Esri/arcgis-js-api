// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["../../core/domUtils","../../core/promiseUtils","../../core/requestAnimationFrame","../../portal/Portal","../../symbols/support/styleUtils","./support/symbolFetcher","./support/symbolStorage","dijit/_TemplatedMixin","dijit/_WidgetBase","dijit/_WidgetsInTemplateMixin","dijit/Tooltip","dojo/dom-class","dojo/dom-construct","dojo/on","dojo/store/Memory","dojo/store/Observable","dojo/i18n!./nls/SymbolStyler","dojo/text!./templates/MarkerSymbolPicker.html","dijit/form/Select","@dojo/framework/shim/AbortController","@dojo/framework/shim/IntersectionObserver"],function(e,t,i,o,s,r,l,n,a,m,d,h,c,y,u,b,p,_){function S(){return!0}var f={id:"customTypes",keywords:"custom symbols",name:p.customImages,title:p.customImages},v={root:"esri-marker-symbol-picker",symbolGrid:"esri-symbol-grid",symbol:"esri-symbol",noSymbols:"esri-no-symbols",defaultSymbols:"esri-default-symbols",loader:"esri-loading-indicator",loading:"esri-loading",typeInput:"esri-type-input",categorySelect:"esri-marker-symbol-picker__category-select",loadingSymbols:"esri-marker-symbol-picker--loading",symbolViewport:"esri-marker-symbol-picker__symbolViewport",selectedSymbol:"esri-symbol--selected",dimensionalityFlat:"esri-marker-symbol-picker--dimensionality-flat",dimensionalityVolumetric:"esri-marker-symbol-picker--dimensionality-volumetric",blocked:"esri-marker-symbol-picker--blocked",header:"esri-marker-symbol-picker__header",showingOverlay:"esri-marker-symbol-picker--showing-overlay",hidden:"esri-hidden"};return a.createSubclass([n,m],{baseClass:v.root,declaredClass:"esri.widgets.SymbolStyler.MarkerSymbolPicker",templateString:_,css:v,postCreate:function(){this.inherited(arguments),this._sourceSymbolTypesStore=new u,this._symbolTypesStore=new b(new u),this._activeSymbolFetch={},this._portalToSourcesMap=new Map,this.dap_markerCategoryInput.set({labelAttr:"title",sortByLabel:!1}),this._symbolTooltip=new d({connectId:this.dap_symbolGrid,selector:".esri-symbol",getContent:function(e){return e.item.get("data.title")||""}.bind(this)}),this.own(this._symbolTooltip)},startup:function(){this.inherited(arguments),l.init();var e=this;y(this.dap_symbolGrid,".esri-symbol:click",function(){this.item.getSymbol().then(function(t){e._selectedNode&&h.remove(e._selectedNode,v.selectedSymbol),e._selectedNode=this,h.add(this,v.selectedSymbol),e.emit("symbol-select",{selection:t.clone()})}.bind(this))}),this.dap_markerCategoryInput.on("change",function(e){this.clearSelection(),this._fetchSymbols(e)}.bind(this)),this.refresh()},destroy:function(){this.inherited(arguments),this._portalToSourcesMap.clear(),this._portalToSourcesMap=null,this._symbolIntersectionObserver&&(this._symbolIntersectionObserver.disconnect(),this._symbolIntersectionObserver=null)},_3dSymbolsFilter:"volumetric",_symbolTypesStore:null,_sourceSymbolTypesStore:null,_symbolItemSurfaces:null,_noSymbolsOverlay:null,_symbolGrid:null,_portal:null,_portalLoadTimeoutInMs:3e3,_portalToSourcesMap:null,_selectedNode:null,_symbolTooltip:null,_symbolIntersectionObserver:null,_webStyleItemKeywordBlacklist:{EsriThematicShapesStyle:!0},displayMode:"portal",filters:null,_setFiltersAttr:function(e){var t={source:e&&e.source||S,symbol:e&&e.symbol||S};this._set("filters",t)},portal:null,symbolSource:"symbol-set",addCustomImageSymbol:function(e){var t=e.clone(),i=l.loadCustomItems()||[],o=t.url.split("/").pop();i.some(function(e){return e.url===t.url})||(t.type="esriPMS",t.name=o,i.push(t),this.dap_markerCategoryInput.set("value",f.id),this.clearSelection(),this._fetchSymbols(f.id))},_getDimensionality:function(){return this.symbolSource.split(":")[1]},_updateDisplay:function(){var t=this.dap_markerCategoryInput;this.clearSelection(),"portal"===this.displayMode&&(this._fetchSymbols(t.value),e.show(t.domNode),h.remove(this.domNode,v.defaultSymbols))},refresh:function(e){e=e||{},e.freshStorage&&l.empty(),this._blockInteraction(!0),this._setUpDimensionality(),this._setUpSymbolCategories().then(this._updateDisplay.bind(this)).then(function(){this._blockInteraction(!1)}.bind(this))},_blockInteraction:function(e){this.dap_markerCategoryInput.set("disabled",e),h.toggle(this.domNode,v.blocked,e)},clearSelection:function(){for(var e=this.dap_symbolGrid;e.lastChild;)e.removeChild(e.lastChild)},_activeSymbolFetch:null,_fetchSymbols:function(e){if(e){var t;this._activeSymbolFetch.controller&&(this._activeSymbolFetch.controller.abort(),this._activeSymbolFetch.controller=null,this._activeSymbolFetch.id=null),t=this._symbolTypesStore.query({id:e})[0],this._showLoadingIndicator(),this._activeSymbolFetch.id=e;var i=new AbortController;this._activeSymbolFetch.controller=i,this._getSymbolItems(t,i.signal).then(function(i){l.saveRecentItem({id:e,dimensionality:i[0]&&i[0].data.dimensionality});var o=this._symbolTypesStore.query({defaultType:!0})[0];o&&o.id,e===this._activeSymbolFetch.id&&this._updateSymbolOptions(this._filterSymbols(i,t))}.bind(this))}},_filterSymbols:function(e,t){return e.filter(function(e){var i={name:e.data.name};return this.filters.symbol(i,t)},this)},_showLoadingIndicator:function(){h.add(this.domNode,v.loadingSymbols)},_hideLoadingIndicator:function(){h.remove(this.domNode,v.loadingSymbols)},_showNoSymbolsMessage:function(){this._hideLoadingIndicator(),h.add(this.domNode,v.noSymbols),this._showMessageOverlay(p.symbolLoadError)},_showMessageOverlay:function(e){h.add(this.dap_symbolViewport,v.showingOverlay),this._noSymbolsOverlay||(this._noSymbolsOverlay=c.create("div")),this._noSymbolsOverlay.innerHTML=e,this.dap_symbolViewport.appendChild(this._noSymbolsOverlay)},_hideMessageOverlay:function(){h.remove(this.dap_symbolViewport,v.showingOverlay),this._noSymbolsOverlay&&this._noSymbolsOverlay.parentNode&&this._noSymbolsOverlay.parentNode.removeChild(this._noSymbolsOverlay)},_setUpSymbolCategories:function(){return this._showLoadingIndicator(),h.remove(this.dap_markerCategoryInput.domNode,v.hidden),h.add(this.dap_symbolTypeHeader,v.hidden),this._hideMessageOverlay(),this._initPortal().then(function(e){if(0===this.symbolSource.indexOf("symbol-set"))return r.fetchSymbolSetSymbolSources(e);var t=this._portalToSourcesMap.get(e);return t||r.fetchWebStyleSymbolSources(e).then(function(e){return e.sort(function(e,t){var i=s.styleNameFromItem(e.portalItem),o=s.styleNameFromItem(t.portalItem);return i>o?1:i<o?-1:0})}).then(function(t){return this._portalToSourcesMap.set(e,t),t}.bind(this))}.bind(this)).then(this._filterSourcesInternally.bind(this)).then(this._setUpSymbolSelect.bind(this)).then(function(){this._hideLoadingIndicator(),0===this._symbolTypesStore.data.length?this._showMessageOverlay(p.noSymbolsAvailable):this._hideMessageOverlay()}.bind(this)).catch(this._showNoSymbolsMessage.bind(this))},_filterSourcesInternally:function(e){return t.resolve(e).then(function(e){var t=this._webStyleItemKeywordBlacklist;return e.filter(function(e){return!e.portalItem.typeKeywords.some(function(e){return t[e]})})}.bind(this)).then(function(e){if(0===this.symbolSource.indexOf("symbol-set"))return e;var i=this._getDimensionality(),o=e.map(function(e){return e.fetchData()});return t.eachAlways(o).then(function(t){var o=[r.getPrimitives(i)];return t.forEach(function(t,r){var l=t.value;if(l&&l.items&&Array.isArray(l.items)&&0!==l.items.length){var n=s.styleNameFromItem(e[r].portalItem),a="EsriIconsStyle"===n?"flat":"volumetric";(l.items[0].dimensionality||a)===i&&o.push(e[r])}}),o}).then(this._filterSources.bind(this))}.bind(this))},_filterSources:function(e){return e.filter(this.filters.source,this)},_setUpDimensionality:function(){var e="volumetric"===this._getDimensionality();h.toggle(this.domNode,v.dimensionalityVolumetric,e),h.toggle(this.domNode,v.dimensionalityFlat,!e)},_setUpSymbolSelect:function(e){var t,i,o=this._sourceSymbolTypesStore;o.setData(e),e.forEach(function(e){e.defaultType&&(t=e.id)}),(i=l.loadRecentSymbolItem())&&o.query({id:i.id})[0]&&this._matchesDimensionality(i)&&(t=i.id);var s=this._symbolTypesStore;s.setData(o.query());var r=this.dap_markerCategoryInput;r.set("store",s),r.set("value",t,!1),this.dap_symbolTypeHeader.innerHTML=r.get("displayedValue");var n=s.data.length;h.toggle(r.domNode,v.hidden,n<=1),h.toggle(this.dap_symbolTypeHeader,v.hidden,1!=n)},_matchesDimensionality:function(e){var t=this._getDimensionality(),i=e.dimensionality;return"volumetric"===i&&"volumetric"===t||"flat"===i&&"flat"===t},_injectCustomSymbolType:function(e){return e.push(f),e},_initPortal:function(){var e,i=this.portal||o.getDefault();return e=t.timeout(i.load().then(function(){return this._portal=i,i}.bind(this)),this._portalLoadTimeoutInMs),this.own(e),e},_getSymbolItems:function(e,i){return t.isAborted(i)?t.reject(t.createAbortError()):e.id===f.id?l.loadCustomItems():e.getItems(i).then(function(e){return e.filter(function(e){var t=this.symbolSource.split(":")[1],i=e.data.dimensionality;return!t||i===t},this)}.bind(this))},_getActiveSource:function(){var e=this.dap_markerCategoryInput.get("value");return this._symbolTypesStore.query({id:e})[0]},_updateSymbolOptions:function(e){var t=document.createDocumentFragment();if(this._symbolIntersectionObserver&&this._symbolIntersectionObserver.disconnect(),this._symbolIntersectionObserver=new IntersectionObserver(function(e,t){function i(){o++,s[o]&&(s[o](),delete s[o],i())}var o=e[0].target.index,s={};e.forEach(function(e){if(e.isIntersecting){var r=e.target;r.item.getThumbnail(r).then(function(e){r.index===o?(e(),i()):s[r.index]=e}),r.item.getSymbol(),t.unobserve(r)}})},{root:this.dap_symbolViewport}),e.forEach(function(e,i){var o=c.create("div",{class:v.symbol});o.item=e,o.index=i,this._symbolIntersectionObserver.observe(o),t.appendChild(o)},this),this._hideLoadingIndicator(),0===e.length)return void this._showMessageOverlay(p.noSymbolsAvailable);this._hideMessageOverlay(),this.dap_symbolGrid.appendChild(t);var o=this.dap_symbolViewport;i(function(){o.scrollTop=0})}})});