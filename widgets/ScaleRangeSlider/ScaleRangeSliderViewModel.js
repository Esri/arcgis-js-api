/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/Accessor","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/arrayUtils","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass","./ScaleRanges","../Slider/SliderViewModel"],(function(e,i,t,a,l,n,r,s,c,o){"use strict";let d=function(i){function t(e){var t;return(t=i.call(this,e)||this).layer=null,t.scaleRanges=c.fromScaleRange({minScale:0,maxScale:0}),t.sliderViewModel=(()=>{const{max:e}=t._getSliderIndexRange(t.scaleRanges.length-1);return new o({precision:10,min:0,max:e,values:[0,e]})})(),t}e._inheritsLoose(t,i);var l=t.prototype;return l.initialize=function(){this.own([a.watch((()=>({loaded:this.layer?.loaded,ready:this.view?.ready})),(({loaded:e,ready:i})=>{if(e&&i){if(this._hasTiledLayer()){const e=this._getLayerResampling()?void 0:this.mapScaleToSlider(this._getTiledLayerMaxScale()),i=this.mapScaleToSlider(this._getTiledLayerMinScale());this.sliderViewModel.effectiveMax=e,this.sliderViewModel.effectiveMin=i}"minScale"in this.layer&&"maxScale"in this.layer?(this.minScale=this.layer.minScale,this.maxScale=this.layer.maxScale):(this.minScale=void 0,this.maxScale=void 0)}}),a.initial)])},l.mapScaleToSlider=function(e){const i=this.scaleRanges.scaleToRangeIndex(e),t=this.scaleRanges.findScaleRangeByIndex(i),{maxScale:a,minScale:l}=t,{max:n,min:r}=this._getSliderIndexRange(i);return this._mapToRange(e,l,a,r,n)},l.mapSliderToScale=function(e){const i=this.scaleRanges.findScaleRangeByIndex(e),{maxScale:t,minScale:a}=i,{max:l,min:n}=this._getSliderIndexRange(e);return this._mapToRange(e,n,l,a,t)},l._setSliderRange=function(e){this.scaleRanges=c.fromScaleRange(e);const{max:i}=this._getSliderIndexRange(this.scaleRanges.length-1);this.sliderViewModel.max=i,this.sliderViewModel.min=0,this.notifyChange("maxScaleLimit"),this.notifyChange("minScaleLimit")},l._getSliderIndexRange=function(e){const i=Math.floor(e);return{min:i,max:i+.99999}},l._mapToRange=function(e,i,t,a,l){return a+(e-i)*(l-a)/(t-i)},l._setMaxScaleOnSlider=function(e){const{scaleRanges:i,sliderViewModel:t}=this;if(void 0!==e){const a=this.mapScaleToSlider(this._constrainMaxScaleToLayer(i.clampMaxScale(e)));t.values=[t.values[0],a]}},l._setMinScaleOnSlider=function(e){const{scaleRanges:i,sliderViewModel:t}=this;if(void 0!==e){const a=this.mapScaleToSlider(this._constrainMinScaleToLayer(i.clampMinScale(e)));t.values=[a,t.values[1]]}},l._constrainMinScaleToLayer=function(e){const{scaleRanges:i}=this;if(this._hasTiledLayer()){const{firstRange:t}=i,a=this._getTiledLayerMinScale(),l=.85;e=this._mapToRange(e,t.maxScale,t.minScale,0,1)>l||e>a?a:e}return e},l._constrainMaxScaleToLayer=function(e){if(this._hasTiledLayer()&&!this._getLayerResampling()){const i=this._getTiledLayerMaxScale();e=e<i?i:e}return e},l._normalizeScale=function(e,i){const t="max"===e?"maxScale":"minScale",a=this._hasTiledLayer()?"min"===e?this._getTiledLayerMinScale():this._getTiledLayerMaxScale():this.scaleRanges[t],l=this._hasTiledLayer()?"min"===e?this._getTiledLayerRealMinScale():this._getTiledLayerRealMaxScale():a,n=1e-6,r=0===i||l===i||Math.abs(l-i)<=n;return Number((r?0:i).toFixed(6))},l._getLayerLODS=function(){if(!this.layer?.loaded||!("tileInfo"in this.layer))return null;return"imagery-tile"===this.layer?.type&&"Raster"===this.layer.raster?.tileType?null:this.layer.tileInfo.lods},l._getLayerResampling=function(){return!!this.layer?.loaded&&(!("resampling"in this.layer)||this.layer.resampling)},l._getTiledLayerMinScale=function(){const e=this._getLayerLODS();return this.scaleRanges.clampMinScale(e[0].scale)},l._getTiledLayerMaxScale=function(){const e=this._getLayerLODS();return e[e.length-1].scale},l._getTiledLayerRealMinScale=function(){const e=this._getLayerLODS(),i="sourceJSON"in this.layer?this.layer.sourceJSON?.tileInfo?.lods??e:e;return this.scaleRanges.clampMinScale(i[0].scale)},l._getTiledLayerRealMaxScale=function(){const e=this._getLayerLODS(),i="sourceJSON"in this.layer?this.layer.sourceJSON?.tileInfo?.lods??e:e;return i[i.length-1].scale},l._hasTiledLayer=function(){return!!this._getLayerLODS()},e._createClass(t,[{key:"effectiveMaxScale",get:function(){return 0===this.maxScale?this.maxScaleLimit:this.maxScale}},{key:"effectiveMinScale",get:function(){return 0===this.minScale?this.minScaleLimit:this.minScale}},{key:"effectiveMaxScaleLimit",get:function(){return this.mapSliderToScale(this._hasTiledLayer()&&!this._getLayerResampling()?this.sliderViewModel.effectiveMax:this.sliderViewModel.max)}},{key:"effectiveMinScaleLimit",get:function(){return this.mapSliderToScale(this._hasTiledLayer()?this.sliderViewModel.effectiveMin:this.sliderViewModel.min)}},{key:"maxScale",get:function(){const e=this.mapSliderToScale(this.sliderViewModel.values[1]);return this._normalizeScale("max",e)},set:function(e){this._setMaxScaleOnSlider(e)}},{key:"maxScaleLimit",get:function(){return this.mapSliderToScale(this.sliderViewModel.max)},set:function(e){this._setSliderRange({maxScale:e,minScale:this.minScaleLimit})}},{key:"minScale",get:function(){const e=this.mapSliderToScale(this.sliderViewModel.values[0]);return this._normalizeScale("min",e)},set:function(e){this._setMinScaleOnSlider(e)}},{key:"minScaleLimit",get:function(){return this.mapSliderToScale(this.sliderViewModel.min)},set:function(e){this._setSliderRange({maxScale:this.maxScaleLimit,minScale:e})}},{key:"state",get:function(){const{view:e,layer:i}=this;return!e&&!i||!e&&i&&i.loaded||!i&&e&&e.ready||e&&e.ready&&i&&i.loaded?"ready":"disabled"}},{key:"view",set:function(e){this._set("view",e)}}]),t}(t);i.__decorate([l.property({readOnly:!0})],d.prototype,"effectiveMaxScale",null),i.__decorate([l.property({readOnly:!0})],d.prototype,"effectiveMinScale",null),i.__decorate([l.property()],d.prototype,"effectiveMaxScaleLimit",null),i.__decorate([l.property()],d.prototype,"effectiveMinScaleLimit",null),i.__decorate([l.property()],d.prototype,"layer",void 0),i.__decorate([l.property()],d.prototype,"maxScale",null),i.__decorate([l.property()],d.prototype,"maxScaleLimit",null),i.__decorate([l.property()],d.prototype,"minScale",null),i.__decorate([l.property()],d.prototype,"minScaleLimit",null),i.__decorate([l.property()],d.prototype,"scaleRanges",void 0),i.__decorate([l.property()],d.prototype,"sliderViewModel",void 0),i.__decorate([l.property({readOnly:!0})],d.prototype,"state",null),i.__decorate([l.property()],d.prototype,"view",null),d=i.__decorate([s.subclass("esri.widgets.ScaleRangeSlider.ScaleRangeSliderViewModel")],d);return d}));
