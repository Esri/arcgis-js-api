/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/Accessor","../../core/HandleOwner","../../core/watchUtils","../../core/accessorSupport/decorators/property","../../core/arrayUtils","../../core/has","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass","./ScaleRanges","../Slider/SliderViewModel"],(function(e,a,i,t,n,l,s,r,c,o,d,S){"use strict";let h=function(a){function i(e){var i;return(i=a.call(this,e)||this).layer=null,i.scaleRanges=d.fromScaleRange({minScale:0,maxScale:0}),i.sliderViewModel=(()=>{const{max:e}=i._getSliderIndexRange(i.scaleRanges.length-1);return new S({precision:10,min:0,max:e,values:[0,e]})})(),i}e._inheritsLoose(i,a);var t=i.prototype;return t.initialize=function(){var a=this;this.handles.add([n.init(this,"sliderViewModel.values",(()=>{if(!this._hasTiledLayer())return;const[e,a]=this.sliderViewModel.values,i=this.mapScaleToSlider(this._getTiledLayerMaxScale()),t=this.mapScaleToSlider(this._getTiledLayerMinScale());(a>i||e<t)&&(this.sliderViewModel.values=[Math.max(e,t),Math.min(a,i)])})),n.init(this,"layer.loaded",e._asyncToGenerator((function*(){const{layer:e,view:i}=a;if(e)if(i&&(yield i.when()),yield e.when(),"minScale"in e&&"maxScale"in e){const{minScale:i,maxScale:t}=e;a.set({minScale:i,maxScale:t})}else a.set({minScale:void 0,maxScale:void 0})})))])},t.mapScaleToSlider=function(e){const a=this.scaleRanges.scaleToRangeIndex(e),i=this.scaleRanges.findScaleRangeByIndex(a),{maxScale:t,minScale:n}=i,{max:l,min:s}=this._getSliderIndexRange(a);return this._mapToRange(e,n,t,s,l)},t.mapSliderToScale=function(e){const a=this.scaleRanges.findScaleRangeByIndex(e),{maxScale:i,minScale:t}=a,{max:n,min:l}=this._getSliderIndexRange(e);return this._mapToRange(e,l,n,t,i)},t._setSliderRange=function(e){this.scaleRanges=d.fromScaleRange(e);const{max:a}=this._getSliderIndexRange(this.scaleRanges.length-1);this.sliderViewModel.max=a,this.sliderViewModel.min=0,this.notifyChange("maxScaleLimit"),this.notifyChange("minScaleLimit")},t._getSliderIndexRange=function(e){const a=Math.floor(e);return{min:a,max:a+.99999}},t._mapToRange=function(e,a,i,t,n){return t+(e-a)*(n-t)/(i-a)},t._setMaxScaleOnSlider=function(e){const{scaleRanges:a,sliderViewModel:i}=this;if(void 0!==e){const t=this.mapScaleToSlider(this._constrainMaxScaleToLayer(a.clampMaxScale(e)));i.values=[i.values[0],t]}},t._setMinScaleOnSlider=function(e){const{scaleRanges:a,sliderViewModel:i}=this;if(void 0!==e){const t=this.mapScaleToSlider(this._constrainMinScaleToLayer(a.clampMinScale(e)));i.values=[t,i.values[1]]}},t._constrainMinScaleToLayer=function(e){const{scaleRanges:a}=this;if(this._hasTiledLayer()){const{firstRange:i}=a,t=this._getTiledLayerMinScale(),n=.85;e=this._mapToRange(e,i.maxScale,i.minScale,0,1)>n||e>t?t:e}return e},t._constrainMaxScaleToLayer=function(e){if(this._hasTiledLayer()){const a=this._getTiledLayerMaxScale();e=e<a?a:e}return e},t._normalizeScale=function(e,a){const i="max"===e?"maxScale":"minScale",t=this._hasTiledLayer()?"min"===e?this._getTiledLayerMinScale():this._getTiledLayerMaxScale():this.scaleRanges[i],n=1e-6,l=0===a||t===a||Math.abs(t-a)<=n;return Number((l?0:a).toFixed(6))},t._getLayerLODS=function(){var e,a;return"imagery-tile"===(null==(e=this.layer)?void 0:e.type)&&"Raster"===(null==(a=this.layer.raster)?void 0:a.tileType)?null:this.get("layer.tileInfo.lods")},t._getTiledLayerMinScale=function(){const e=this._getLayerLODS();return this.scaleRanges.clampMinScale(e[0].scale)},t._getTiledLayerMaxScale=function(){const e=this._getLayerLODS();return e[e.length-1].scale},t._hasTiledLayer=function(){return!!this._getLayerLODS()},e._createClass(i,[{key:"maxScale",get:function(){const e=this.mapSliderToScale(this.sliderViewModel.values[1]);return this._normalizeScale("max",e)},set:function(e){this._setMaxScaleOnSlider(e)}},{key:"maxScaleLimit",get:function(){return this.mapSliderToScale(this.sliderViewModel.max)},set:function(e){this._setSliderRange({maxScale:e,minScale:this.minScaleLimit})}},{key:"minScale",get:function(){const e=this.mapSliderToScale(this.sliderViewModel.values[0]);return this._normalizeScale("min",e)},set:function(e){this._setMinScaleOnSlider(e)}},{key:"minScaleLimit",get:function(){return this.mapSliderToScale(this.sliderViewModel.min)},set:function(e){this._setSliderRange({maxScale:this.maxScaleLimit,minScale:e})}},{key:"state",get:function(){const{view:e,layer:a}=this;return!e&&!a||!e&&a&&a.loaded||!a&&e&&e.ready||e&&e.ready&&a&&a.loaded?"ready":"disabled"}},{key:"view",set:function(e){this._set("view",e)}}]),i}(t.HandleOwnerMixin(i));a.__decorate([l.property()],h.prototype,"layer",void 0),a.__decorate([l.property()],h.prototype,"maxScale",null),a.__decorate([l.property()],h.prototype,"maxScaleLimit",null),a.__decorate([l.property()],h.prototype,"minScale",null),a.__decorate([l.property()],h.prototype,"minScaleLimit",null),a.__decorate([l.property()],h.prototype,"scaleRanges",void 0),a.__decorate([l.property()],h.prototype,"sliderViewModel",void 0),a.__decorate([l.property({readOnly:!0})],h.prototype,"state",null),a.__decorate([l.property()],h.prototype,"view",null),h=a.__decorate([o.subclass("esri.widgets.ScaleRangeSlider.ScaleRangeSliderViewModel")],h);return h}));
