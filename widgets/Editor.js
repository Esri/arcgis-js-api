// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","@dojo/framework/shim/Map","../intl","../core/events","../core/HandleOwner","../core/watchUtils","../core/accessorSupport/decorators","../layers/support/fieldUtils","./Attachments","./FeatureForm","./FeatureTemplates","./Spinner","./Widget","./Editor/EditorViewModel","./FeatureTemplates/ItemList","./support/widget"],(function(e,t,r,a,i,n,s,o,l,d,c,u,p,h,m,_,f,v){"use strict";var y="esri-editor esri-widget esri-widget--panel",w="esri-editor__header",g="esri-editor__scroller",k="esri-editor__content",b="esri-editor__content-group",M="esri-editor__temp-wrapper",x="esri-editor__message",A="esri-editor__controls",F="esri-editor__title",W="esri-editor__back-button",T="esri-editor__mode-selection",C="esri-editor__progress-bar",E="esri-editor__warning-card",H="esri-editor__warning-header",D="esri-editor__warning-heading",I="esri-editor__warning-message",U="esri-editor__warning-divider",S="esri-editor__warning-option",B="esri-editor__warning-option--primary",L="esri-editor__warning-option--negative",O="esri-editor__warning-option--positive",V="esri-editor__feature-list-item",P="esri-editor__feature-list-item--disabled",R="esri-editor__feature-list-name",q="esri-editor__feature-list-icon",K="esri-editor__control-button",j="esri-editor__overlay",G="esri-icon-right",N="esri-icon-left",z="esri-icon-notice-triangle",J="esri-icon-edit",Q="esri-button",X="esri-button--disabled",Y="esri-button--secondary",Z="esri-button--tertiary",$="esri-heading",ee="esri-interactive";function te(e){e.focus()}return function(e){function t(t,r){var a=e.call(this,t,r)||this;return a._candidateCommitted=!1,a._featureForm=new u,a._attachments=new c({visibleElements:{addSubmitButton:!1,cancelAddButton:!1,cancelUpdateButton:!1,deleteButton:!1,errorMessage:!1,progressBar:!1,updateButton:!1}}),a._featureTemplates=new p,a._filterText="",a._prompt=null,a._spinner=new h,a.activeWorkflow=null,a.allowedWorkflows=null,a.iconClass=J,a.label=void 0,a.layerInfos=null,a.messages=null,a.messagesCommon=null,a.messagesTemplates=null,a.supportingWidgetDefaults=null,a.view=null,a.viewModel=new _,a._handleHeaderClickOrKeyDown=function(e){e.currentTarget["data-prevent-back"]||a._handleBack.call(a,e)},a._setCandidateFeature=function(e,t){if(void 0===t&&(t=!1),!a._candidateCommitted){var r=a.viewModel.activeWorkflow;r.data.edits.feature=e,t&&(r.next(),a._candidateCommitted=!0)}},a._handleSave=a._handleSave.bind(a),a._handleBack=a._handleBack.bind(a),a._handleDone=a._handleDone.bind(a),a._handleDelete=a._handleDelete.bind(a),a._handleAdd=a._handleAdd.bind(a),a._handleEdit=a._handleEdit.bind(a),a._handleAttachmentAdd=a._handleAttachmentAdd.bind(a),a._handleAttachmentUpdate=a._handleAttachmentUpdate.bind(a),a._handleAttachmentDelete=a._handleAttachmentDelete.bind(a),a}return r.__extends(t,e),t.prototype.initialize=function(){var e=this,t=this.messages,r=this.messagesCommon;this.own([o.init(this,"viewModel",(function(t){e._featureForm.viewModel=t?t.featureFormViewModel:null,e._attachments.viewModel=t?t.attachmentsViewModel:null,e._featureTemplates.viewModel=t?t.featureTemplatesViewModel:null,e._spinner.viewModel=t?t.spinnerViewModel:null})),o.init(this,"view",(function(t,r){var a="editor-"+e.id+"-spinner";r&&r.ui.remove(e._spinner,a),t&&t.ui.add(e._spinner,{key:a,position:"manual"})})),o.on(this,"viewModel.sketchViewModel","create",(function(){e.scheduleRender()})),o.on(this,"viewModel.activeWorkflow","cancel-request",(function(a){var i=a.controller;e._prompt={title:t.cancelRequestTitle,message:t.cancelRequestWarningMessage,options:[{label:r.form.no,type:"neutral",action:function(){return i.deny(),e._prompt=null}},{label:r.form.yes,type:"negative",action:function(){i.allow(),e._prompt=null}}]},e.scheduleRender()})),o.init(this,"supportingWidgetDefaults",(function(t){t&&(e._featureForm.set(t.featureForm),e._attachments.set(t.attachments),e._featureTemplates.set(t.featureTemplates),e.viewModel.sketchViewModel.set(t.sketch))})),o.watch(this,"_attachments.error",(function(a){a&&(e._prompt={title:t.errorWarningTitle,message:a.message,options:[{label:r.form.ok,type:"neutral",action:function(){e._prompt=null}}]})})),o.watch(this,"viewModel.failures",(function(r){if(r){var a=r[0],n=a.error,s=a.retry,o=a.cancel;e._prompt={title:t.errorWarningTitle,message:i.substitute(t.errorWarningMessageTemplate,{errorMessage:n.message}),options:[{label:t.retry,type:"positive",action:function(){s(),e._prompt=null}},{label:t.ignore,type:"neutral",action:function(){return o(),e._prompt=null}}]}}})),o.watch(this,"viewModel.state",(function(t){"awaiting-update-feature-candidate"===t&&(e._candidateCommitted=!1)})),o.watch(this,["_attachments.selectedFile","_attachments.submitting"],(function(){return e.scheduleRender()})),o.whenNot(this,"viewModel.activeWorkflow",(function(){return e._featureTemplates.filterText=""}))])},t.prototype.destroy=function(){this._attachments.destroy(),this._featureForm.destroy(),this._featureTemplates.destroy()},t.prototype.startCreateWorkflowAtFeatureTypeSelection=function(){return this.viewModel.startCreateWorkflowAtFeatureTypeSelection()},t.prototype.startCreateWorkflowAtFeatureCreation=function(e){return this.viewModel.startCreateWorkflowAtFeatureCreation(e)},t.prototype.startCreateWorkflowAtFeatureEdit=function(e){return this.viewModel.startCreateWorkflowAtFeatureEdit(e)},t.prototype.startUpdateWorkflowAtFeatureSelection=function(){return this.viewModel.startUpdateWorkflowAtFeatureSelection()},t.prototype.startUpdateWorkflowAtMultipleFeatureSelection=function(e){return this.viewModel.startUpdateWorkflowAtMultipleFeatureSelection(e)},t.prototype.startUpdateWorkflowAtFeatureEdit=function(e){return this.viewModel.startUpdateWorkflowAtFeatureEdit(e)},t.prototype.deleteFeatureFromWorkflow=function(){return this.viewModel.deleteFeatureFromWorkflow()},t.prototype.cancelWorkflow=function(e){return this.viewModel.cancelWorkflow(e)},t.prototype.render=function(){var e=this._attachments,t=this.viewModel;if(!t)return v.tsx("div",{class:y});var r=t.state,a=this._prompt?v.tsx("div",{class:j,key:"overlay"},this.renderPrompt({message:this._prompt.message,title:this._prompt.title,options:this._prompt.options})):null;return v.tsx("div",{class:y},t.syncing||e.submitting?this.renderProgressBar():null,"disabled"===r?null:"ready"===r?this.renderLanding():"awaiting-feature-creation-info"===r?this.renderTemplates():"editing-new-feature"===r||"editing-existing-feature"===r?this.renderAttributeEditing():"awaiting-feature-to-update"===r?this.renderFeatureUpdating():"awaiting-update-feature-candidate"===r?this.renderFeatureList():"awaiting-feature-to-create"===r?this.renderFeatureCreation():"adding-attachment"===r?this.renderAttachmentAdding():"editing-attachment"===r?this.renderAttachmentEditing():null,a)},t.prototype.renderTemplates=function(){return v.tsx("div",{class:M,key:"wrapper"},this.renderHeader(this.messages.selectTemplate,!0),v.tsx("div",{key:"content",class:k},this._featureTemplates.render()))},t.prototype.renderAttributeEditing=function(){var e=this.viewModel,t=e.activeWorkflow,r=e.featureFormViewModel,a=t.data.edits.feature,n="update"===t.type&&!t.data.edits.modified||r.inputFields.length>0&&!r.valid,s=this.messages,o=this.messagesCommon,l="create"===t.type?o.add:o.update,d=[{label:l,type:"primary",disabled:n,clickHandler:this._handleSave}],c=!1;"update"===t.type&&(t.data.editableItem.hasAttachments&&(c=!0),t.data.editableItem.supports.indexOf("delete")>-1&&d.push({label:o.delete,type:"tertiary",clickHandler:this._handleDelete}));var u=this._getLabel(a);return v.tsx("div",{class:M,key:"wrapper"},this.renderHeader(u,!0),v.tsx("div",{key:"content",class:this.classes(k,g)},v.tsx("div",{class:b},r.inputFields.length>0?this._featureForm.render():this.renderMessage(i.substitute(s.clickToFinishTemplate,{button:l})),c?v.tsx("div",{key:"attachments"},v.tsx("div",null,s.attachments),this._attachments.render()):null)),this.renderControls(d))},t.prototype.renderAttachmentAdding=function(){var e=this._attachments,t=this.messages,r=this.messagesCommon,a=[{label:e.submitting?r.cancel:r.add,disabled:e.submitting||!e.selectedFile,type:"primary",clickHandler:this._handleAttachmentAdd}];return v.tsx("div",{class:M,key:"wrapper"},this.renderHeader(t.addAttachment,!0,e.submitting),v.tsx("div",{key:"content",class:this.classes(k,g)},e.render()),this.renderControls(a))},t.prototype.renderAttachmentEditing=function(){var e=this._attachments,t=this.messages,r=this.messagesCommon,a=[{label:r.update,disabled:e.submitting||!e.selectedFile,type:"primary",clickHandler:this._handleAttachmentUpdate},{label:r.delete,disabled:e.submitting,type:"tertiary",clickHandler:this._handleAttachmentDelete}];return v.tsx("div",{class:M,key:"wrapper"},this.renderHeader(t.editAttachment,!0,e.submitting),v.tsx("div",{key:"content",class:this.classes(k,g)},e.render()),this.renderControls(a))},t.prototype.renderFeatureUpdating=function(){var e=this.messages;return v.tsx("div",{class:M,key:"wrapper"},this.renderHeader(e.selectFeature,!0),v.tsx("div",{key:"content",class:this.classes(k,g)},this.renderMessage(e.selectFeatureToEdit)))},t.prototype.renderMessage=function(e){return v.tsx("div",{class:x},e)},t.prototype.renderFeatureCreation=function(){var e=this.messages,t=this.viewModel,r=t.sketchViewModel,a=t.activeWorkflow.data.creationInfo.layer,i=r.canUndo()&&r.createGraphic?r.createGraphic:null,n=this._getSketchingTip(a.geometryType,i);return v.tsx("div",{class:M,key:"wrapper"},this.renderHeader(e.placeFeature,!0),v.tsx("div",{key:"content",class:this.classes(k,g)},this.renderMessage(n)))},t.prototype.renderControls=function(e){var t=this;return v.tsx("div",{class:A,key:"controls"},e.map((function(e,r){var a=e.disabled,i=void 0!==a&&a,n=e.label,s=e.type,o=e.clickHandler;return t.renderButton({label:n,class:t.classes(K,Q,"secondary"===s?Y:"tertiary"===s?Z:null,i?X:null),disabled:i,clickHandler:o,key:r})})))},t.prototype.renderPrompt=function(e){var t=this,r=e.title,a=e.message,i=e.options,s=void 0===i?[]:i;return v.tsx("div",{class:E,role:"alert"},v.tsx("div",{class:H},v.tsx("span",{class:z,"aria-hidden":"true"}),v.tsx("h4",{class:this.classes($,D)},r)),v.tsx("div",{class:I},a),v.tsx("div",{class:U}),s.map((function(e,r){var a=e.label,i=e.action,s=e.type,o=0===r;return v.tsx("div",{afterCreate:o?te:null,class:t.classes(S,o?B:null,"positive"===s?O:"negative"===s?L:null),key:r,onclick:i,onkeydown:function(e){var t=n.eventKey(e);"Enter"!==t&&" "!==t||(e.preventDefault(),i.call(null))},tabIndex:0,role:"button"},a)})))},t.prototype.renderProgressBar=function(){return v.tsx("div",{class:this.classes(C),key:"progress-bar"})},t.prototype.renderButton=function(e){return v.tsx("button",{class:e.class,disabled:e.disabled,key:e.key,onclick:e.clickHandler,type:"button"},e.label)},t.prototype.renderHeader=function(e,t,r){void 0===t&&(t=!1),void 0===r&&(r=!1);var a=this.messagesCommon;return v.tsx("header",{class:w,key:"header"},t?v.tsx("div",{"aria-label":a.back,class:this.classes(W,ee,r?X:null),key:"back-button","data-prevent-back":r,onclick:this._handleHeaderClickOrKeyDown,onkeydown:this._handleHeaderClickOrKeyDown,role:"button",tabIndex:0,title:a.back},v.tsx("span",{"aria-hidden":"true",class:v.isRTL()?G:N})):null,v.tsx("h4",{class:this.classes(F,$)},e))},t.prototype.renderLanding=function(){var e=this.messages,t=this.viewModel,r=t.allowedWorkflows,a=t.canCreate,i=t.canUpdate,n=v.isRTL()?N:G;return v.tsx("div",{class:M,key:"wrapper"},this.renderHeader(e.widgetLabel),v.tsx("div",{key:"content",class:k,role:"group"},v.tsx("div",{class:T,key:"mode-selection"},r.indexOf("update")>-1?v.tsx("div",{"aria-disabled":i?"false":"true",class:this.classes(V,i?null:P),key:"update",onclick:this._handleEdit,onkeydown:this._handleEdit,role:"button",tabIndex:i?0:-1},v.tsx("span",{class:R},e.editFeature),v.tsx("span",{"aria-hidden":"true",class:this.classes(q,n)})):null,r.indexOf("create")>-1?v.tsx("div",{class:this.classes(V,a?null:P),key:"create",onclick:this._handleAdd,onkeydown:this._handleAdd,role:"button",tabIndex:a?0:-1},v.tsx("span",{class:R},e.addFeature),v.tsx("span",{"aria-hidden":"true",class:this.classes(q,n)})):null)))},t.prototype.renderFeatureList=function(){var e=this,t=this.messages,r=this.messagesTemplates,n=this.viewModel,s=n.editableItems,o=n.activeWorkflow.data.candidates,l=i.substitute(t.multipleFeaturesTemplate,{total:o.length}),d=new a.default;o.map((function(t){return{label:e._getLabel(t),id:t.attributes[t.layer.objectIdField],data:t}})).filter((function(t){var r=t.label,a=t.data,i=e._filterText.toLowerCase(),n=a.layer.title;return e.viewModel.editableItems.find((function(e){return e.layer===a.layer})).supports.indexOf("update")>-1&&(!i||r.toLowerCase().indexOf(i)>-1||n.toLowerCase().indexOf(i)>-1)})).forEach((function(e){var t=e.data.layer;d.has(t)?d.get(t).items.push(e):d.set(t,{id:""+t.id,label:t.title,items:[e]})}));var c=s.filter((function(e){var t=e.layer;return d.has(t)})).map((function(e){var t=e.layer;return d.get(t)})).toArray();return v.tsx("div",{class:M,key:"wrapper"},this.renderHeader(l,!0),v.tsx("div",{key:"content",class:this.classes(k,g)},f.ItemList({id:this.id,filterText:this._filterText,items:c,messages:{filterPlaceholder:r.filterPlaceholder,noItems:r.noItems,noMatches:r.noMatches},onItemMouseEnter:function(t){var r=t.data;return e._setCandidateFeature(r)},onItemMouseLeave:function(){return e._setCandidateFeature(null)},onItemSelect:function(t){var r=t.data;return e._setCandidateFeature(r,!0)},onFilterChange:function(t){return e._filterText=t}})))},t.prototype._getSketchingTip=function(e,t){var r=this.messages;if("point"===e)return r.tips.clickToAddPoint;if("polygon"===e||"polyline"===e){if(!t)return r.tips.clickToStart;var a=t.geometry["polygon"===e?"rings":"paths"][0];return"polygon"===e&&a<4?r.tips.clickToContinue:r.tips.clickToContinueThenDoubleClickToEnd}return r.tips.clickToAddFeature},t.prototype._getLabel=function(e){var t=e.layer,r=t.objectIdField,a=e.attributes,n=d.getDisplayFieldName(t);return n&&""+a[n]||i.substitute(this.messages.untitledFeatureTemplate,{id:a[r]})},t.prototype._handleDelete=function(){var e=this,t=this.messages,r=this.messagesCommon;this._prompt={title:t.deleteWarningTitle,message:t.deleteWarningMessage,options:[{label:t.keepFeature,type:"neutral",action:function(){return e._prompt=null}},{label:r.delete,type:"positive",action:function(){e.viewModel.deleteFeatureFromWorkflow(),e._prompt=null}}]}},t.prototype._handleSave=function(){this.viewModel.activeWorkflow.commit()},t.prototype._handleAttachmentAdd=function(){var e=this._attachments,t=this.viewModel.activeWorkflow;e.addAttachment().then((function(){return t.previous()}))},t.prototype._handleAttachmentUpdate=function(){var e=this._attachments,t=this.viewModel.activeWorkflow;e.updateAttachment().then((function(){return t.previous()}))},t.prototype._handleAttachmentDelete=function(){var e=this,t=this.messages,r=this.messagesCommon;this._prompt={title:t.deleteAttachmentWarningTitle,message:t.deleteAttachmentWarningMessage,options:[{label:t.keepAttachment,type:"neutral",action:function(){return e._prompt=null}},{label:r.delete,type:"positive",action:function(){var t=e._attachments,r=e.viewModel.activeWorkflow;t.deleteAttachment(t.viewModel.activeAttachmentInfo).then((function(){r.previous(),e._prompt=null}))}}]}},t.prototype._handleAdd=function(){this.viewModel.canCreate&&this.viewModel.startCreateWorkflowAtFeatureTypeSelection()},t.prototype._handleEdit=function(){this.viewModel.canUpdate&&this.viewModel.startUpdateWorkflowAtFeatureSelection()},t.prototype._handleDone=function(){this.viewModel.cancelWorkflow({force:!0})},t.prototype._handleBack=function(){var e=this,t=this.messages,r=this.viewModel.activeWorkflow,a=r.stepId,i=r.data,n=r.type,s=function(){r.hasPreviousStep?r.previous():e.viewModel.cancelWorkflow({force:!0})};if("editing-new-feature"===a||"editing-existing-feature"===a&&i.edits.modified){var o="create"===n?t.cancelAddWarningMessage:t.cancelEditWarningMessage,l="create"===n?t.cancelAddTitle:t.cancelEditTitle,d="create"===n?t.continueAdding:t.continueEditing,c="create"===n?t.discardFeature:t.discardEdits;this._prompt={title:l,message:o,options:[{label:d,type:"neutral",action:function(){return e._prompt=null}},{label:c,type:"negative",action:function(){s(),e._prompt=null}}]}}else s()},r.__decorate([l.property()],t.prototype,"_attachments",void 0),r.__decorate([l.aliasOf("viewModel.activeWorkflow")],t.prototype,"activeWorkflow",void 0),r.__decorate([l.aliasOf("viewModel.allowedWorkflows")],t.prototype,"allowedWorkflows",void 0),r.__decorate([l.property()],t.prototype,"iconClass",void 0),r.__decorate([l.property({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],t.prototype,"label",void 0),r.__decorate([l.aliasOf("viewModel.layerInfos")],t.prototype,"layerInfos",void 0),r.__decorate([l.property(),v.renderable(),v.messageBundle("esri/widgets/Editor/t9n/Editor")],t.prototype,"messages",void 0),r.__decorate([l.property(),v.renderable(),v.messageBundle("esri/t9n/common")],t.prototype,"messagesCommon",void 0),r.__decorate([l.property(),v.renderable(),v.messageBundle("esri/widgets/FeatureTemplates/t9n/FeatureTemplates")],t.prototype,"messagesTemplates",void 0),r.__decorate([l.property()],t.prototype,"supportingWidgetDefaults",void 0),r.__decorate([l.aliasOf("viewModel.view")],t.prototype,"view",void 0),r.__decorate([l.property(),v.renderable(["viewModel.canCreate","viewModel.canUpdate","viewModel.failures","viewModel.state","viewModel.syncing","viewModel.activeWorkflow.data.edits.modified"]),v.vmEvent(["workflow-cancel","workflow-commit"])],t.prototype,"viewModel",void 0),r.__decorate([v.accessibleHandler()],t.prototype,"_handleDelete",null),r.__decorate([v.accessibleHandler()],t.prototype,"_handleAttachmentAdd",null),r.__decorate([v.accessibleHandler()],t.prototype,"_handleAttachmentUpdate",null),r.__decorate([v.accessibleHandler()],t.prototype,"_handleAttachmentDelete",null),r.__decorate([v.accessibleHandler()],t.prototype,"_handleAdd",null),r.__decorate([v.accessibleHandler()],t.prototype,"_handleEdit",null),r.__decorate([v.accessibleHandler()],t.prototype,"_handleDone",null),r.__decorate([v.accessibleHandler()],t.prototype,"_handleBack",null),t=r.__decorate([l.subclass("esri.widgets.Editor")],t)}(s.HandleOwnerMixin(m))}));