/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["require","../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../intl","../core/HandleOwner","../core/Logger","../core/maybe","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/arrayUtils","../core/accessorSupport/decorators/cast","../core/accessorSupport/decorators/subclass","../layers/support/fieldUtils","./Attachments","./FeatureForm","./FeatureTemplates","./Spinner","./Widget","./Editor/deprecationUtils","./Editor/EditorViewModel","./FeatureTemplates/ItemList","./support/Heading","./support/SnappingControls","./support/decorators/accessibleHandler","./support/decorators/messageBundle","./support/decorators/vmEvent","./support/jsxFactory","./support/widgetUtils","../intl/substitute"],(function(e,t,n,a,s,i,o,r,l,d,c,p,u,h,m,g,_,f,w,v,k,y,b,C,M,F,A,x,T){"use strict";const W={base:"esri-editor esri-widget esri-widget--panel",message:"esri-editor__message",controls:"esri-editor__controls",controlButton:"esri-editor__control-button",progressBar:"esri-editor__progress-bar",panelToolbar:"esri-editor__panel-toolbar",panelToolbarSnappingButton:"esri-editor__panel-toolbar__snapping-button",panelContent:"esri-editor__panel-content",panelContentMessage:"esri-editor__panel-content__message",panelContentSection:"esri-editor__panel-content__section",panelContentSectionGroup:"esri-editor__panel-content__section__group",snappingControlsPopover:"esri-editor__snapping-controls-popover",updateFeaturesActionButtons:"esri-editor__update-features-action-buttons",updateFeaturesActionButtonsButton:"esri-editor__update-features-action-buttons--button",featureTemplatesContainer:"esri-editor__feature-templates-container",promptContainer:"esri-editor__prompt",promptHeader:"esri-editor__prompt__header",promptHeading:"esri-editor__prompt__header__heading",promptMessage:"esri-editor__prompt__message",promptDivider:"esri-editor__prompt__divider",promptActions:"esri-editor__prompt__actions",warningIcon:"esri-icon-notice-triangle",widgetIcon:"esri-icon-edit",button:"esri-button",buttonDisabled:"esri-button--disabled",buttonSecondary:"esri-button--secondary",buttonTertiary:"esri-button--tertiary"},E={undoRedoButtons:!1,snappingControls:!0,snappingControlsElements:{header:!1,enabledToggle:!0,selfEnabledToggle:!0,featureEnabledToggle:!0,layerList:!0}};function S(e){e.focus()}const B="esri.widgets.Editor",P=i.getLogger(B);let L=function(n){function a(e,a){var s;return(s=n.call(this,e,a)||this)._candidateCommitted=!1,s._featureForm=new m,s._stateStack=[],s._attachments=new h({visibleElements:{addSubmitButton:!1,cancelAddButton:!1,cancelUpdateButton:!1,deleteButton:!1,errorMessage:!1,progressBar:!1,updateButton:!1}}),s._featureTemplates=new g({enableListScroll:!1}),s._filterText="",s._prompt=null,s._spinner=new _,s._snappingButton=null,s._snappingPopover=null,s.useDeprecatedCreateWorkflow=!1,s.headingLevel=4,s.iconClass=W.widgetIcon,s.messages=null,s.messagesCommon=null,s.messagesTemplates=null,s.supportingWidgetDefaults=null,s.viewModel=new v,s.visibleElements={...E},s._setCandidateFeature=(e,t=!1)=>{if(s._candidateCommitted)return;const n=s._assertActiveUpdateWorkflow();n.data.edits.feature=e,t&&(n.next(),s._candidateCommitted=!0)},s._handleSave=s._handleSave.bind(t._assertThisInitialized(s)),s._handleBack=s._handleBack.bind(t._assertThisInitialized(s)),s._handleDone=s._handleDone.bind(t._assertThisInitialized(s)),s._handleDelete=s._handleDelete.bind(t._assertThisInitialized(s)),s._handleAdd=s._handleAdd.bind(t._assertThisInitialized(s)),s._handleEdit=s._handleEdit.bind(t._assertThisInitialized(s)),s._handleAttachmentAdd=s._handleAttachmentAdd.bind(t._assertThisInitialized(s)),s._handleAttachmentUpdate=s._handleAttachmentUpdate.bind(t._assertThisInitialized(s)),s._handleAttachmentDelete=s._handleAttachmentDelete.bind(t._assertThisInitialized(s)),s.EditorPanel=s.EditorPanel.bind(t._assertThisInitialized(s)),s}t._inheritsLoose(a,n);var s=a.prototype;return s.initialize=function(){const{view:e,snappingOptions:t}=this;this._snappingControls=new b({snappingOptions:t,view:e,visibleElements:this.visibleElements.snappingControlsElements}),this.addHandles([r.watch((()=>this.headingLevel),(e=>{this._featureForm.headingLevel=y.incrementHeadingLevel(e),this._featureTemplates.headingLevel=y.incrementHeadingLevel(e)}),r.initial),this.viewModel.featureTemplatesViewModel.on("select",(({item:e})=>this.useDeprecatedCreateWorkflow?this.startCreateWorkflowAtFeatureCreation(e):this.startCreateFeaturesWorkflowAtFeatureCreation(e))),r.watch((()=>this.viewModel.state),((e,t)=>{const n=this._stateStack.indexOf(e);-1===n?this._stateStack.push(t):this._stateStack.splice(n)})),r.watch((()=>this.viewModel),(e=>{this._featureForm.viewModel=e?e.featureFormViewModel:null,this._attachments.viewModel=e?e.attachmentsViewModel:null,this._featureTemplates.viewModel=e?e.featureTemplatesViewModel:null,this._spinner.viewModel=e?e.spinnerViewModel:null}),r.initial),r.watch((()=>this.view),((e,t)=>{const n=`editor-${this.id}-spinner`;t&&t.ui.remove(this._spinner,n),e&&e.ui.add(this._spinner,{key:n,position:"manual"})}),r.initial),r.on((()=>this.viewModel?.sketchViewModel),"create",(()=>{this.scheduleRender()})),r.on((()=>this.viewModel?.activeWorkflow),"cancel-request",(({controller:e})=>{const{messages:t,messagesCommon:n}=this;this._prompt={title:t.cancelRequestTitle,message:t.cancelRequestWarningMessage,context:"danger",actions:{primary:{label:n.form.yes,action:()=>{e.allow(),this._prompt=null}},secondary:{label:n.form.no,action:()=>(e.deny(),this._prompt=null)}}},this.scheduleRender()})),r.watch((()=>this.supportingWidgetDefaults),(e=>{e&&(this._featureForm.set(e.featureForm),this._attachments.set(e.attachments),this._featureTemplates.set(e.featureTemplates),this.viewModel.sketchViewModel.set(e.sketch))}),r.initial),r.watch((()=>this._attachments?.error),(e=>{if(!e)return;const{messages:t,messagesCommon:n}=this;this._prompt={title:t.errorWarningTitle,message:e.message,context:"warning",actions:{primary:{label:n.form.ok,action:()=>{this._prompt=null}}}}})),r.watch((()=>this.viewModel?.failures),(e=>{if(!e)return;const{messages:t}=this,[{error:n,retry:a,cancel:s}]=e;this._prompt={title:t.errorWarningTitle,message:T.substitute(t.errorWarningMessageTemplate,{errorMessage:n.message}),context:"warning",actions:{primary:{label:t.retry,action:()=>{a(),this._prompt=null}},secondary:{label:t.ignore,action:()=>(s(),this._prompt=null)}}}})),r.watch((()=>this.viewModel?.state),(e=>{if("awaiting-feature-to-update"===e&&(this._filterText=""),"awaiting-update-feature-candidate"===e&&(this._candidateCommitted=!1),"editing-existing-feature"===e){const{activeWorkflow:e}=this.viewModel;this._featureForm.disabled="update"===e?.type&&!1===e?.data.editableItem.attributeUpdatesEnabled}})),r.watch((()=>[this._attachments?.selectedFile,this._attachments?.submitting]),(()=>this.scheduleRender())),r.watch((()=>this.viewModel?.activeWorkflow),(()=>this._featureForm.disabled=!1)),r.when((()=>!this.viewModel?.activeWorkflow),(()=>this._featureTemplates.filterText="")),r.on((()=>this.view),"key-down",(e=>{"Escape"===e.key&&this.viewModel?.activeWorkflow&&this._handleBack()}))])},s.destroy=function(){this._attachments.destroy(),this._featureForm.destroy(),this._featureTemplates.destroy(),this._snappingControls.destroy()},s.loadDependencies=function(){return Promise.all([new Promise(((t,n)=>e(["../chunks/calcite-action"],t,n))),new Promise(((t,n)=>e(["../chunks/calcite-button"],t,n))),new Promise(((t,n)=>e(["../chunks/calcite-flow"],t,n))),new Promise(((t,n)=>e(["../chunks/calcite-icon"],t,n))),new Promise(((t,n)=>e(["../chunks/calcite-flow-item"],t,n))),new Promise(((t,n)=>e(["../chunks/calcite-popover"],t,n))),new Promise(((t,n)=>e(["../chunks/calcite-scrim"],t,n)))])},s.castVisibleElements=function(e){const t={...E,...e,snappingControlsElements:{...E.snappingControlsElements,...e?.snappingControlsElements}};return o.isSome(this._snappingControls)&&(this._snappingControls.visibleElements=t.snappingControlsElements),t},s.startCreateWorkflowAtFeatureTypeSelection=function(){return w.workflowDeprecation(P,"startCreateWorkflowAtFeatureTypeSelection","startCreateFeaturesWorkflowAtFeatureTypeSelection"),this.viewModel.startCreateWorkflowAtFeatureTypeSelection()},s.startCreateFeaturesWorkflowAtFeatureTypeSelection=function(){return this.viewModel.startCreateFeaturesWorkflowAtFeatureTypeSelection()},s.startCreateWorkflowAtFeatureCreation=function(e){return w.workflowDeprecation(P,"startCreateWorkflowAtFeatureCreation","startCreateFeaturesWorkflowAtFeatureCreation"),this.viewModel.startCreateWorkflowAtFeatureCreation(e)},s.startCreateFeaturesWorkflowAtFeatureCreation=function(e){return this.viewModel.startCreateFeaturesWorkflowAtFeatureCreation(e)},s.startCreateWorkflowAtFeatureEdit=function(e){return w.workflowDeprecation(P,"startCreateWorkflowAtFeatureEdit"),this.viewModel.startCreateWorkflowAtFeatureEdit(e)},s.startUpdateWorkflowAtFeatureSelection=function(){return this.viewModel.startUpdateWorkflowAtFeatureSelection()},s.startUpdateWorkflowAtMultipleFeatureSelection=function(e){return this.viewModel.startUpdateWorkflowAtMultipleFeatureSelection(e)},s.startUpdateWorkflowAtFeatureEdit=function(e){return this.viewModel.startUpdateWorkflowAtFeatureEdit(e)},s.deleteFeatureFromWorkflow=function(){return this.viewModel.deleteFeatureFromWorkflow()},s.cancelWorkflow=function(e){return this.viewModel.cancelWorkflow(e)},s.render=function(){const{_attachments:e,_prompt:t,viewModel:n}=this;if(!n)return A.tsx("div",{class:W.base});const{state:a}=n,s=o.isSome(t)?A.tsx("calcite-scrim",null,this.renderPrompt(t)):null;return A.tsx("div",{class:W.base},n.syncing||e.submitting?this.renderProgressBar():null,A.tsx("calcite-flow",null,this._stateStack.map((e=>this.renderState(e))),this.renderState(a)),s)},s.renderState=function(e){switch(e){case"disabled":break;case"ready":return this.renderLanding(e);case"awaiting-feature-creation-info":return this.renderTemplates(e);case"creating-features":case"editing-new-feature":case"editing-existing-feature":return this.renderAttributeEditing(e);case"awaiting-feature-to-update":return this.renderFeatureUpdating(e);case"awaiting-update-feature-candidate":return this.renderFeatureList(e);case"awaiting-feature-to-create":return this.renderFeatureCreation(e);case"adding-attachment":return this.renderAttachmentAdding(e);case"editing-attachment":return this.renderAttachmentEditing(e)}return A.tsx("div",null)},s.isPanelActive=function(e){return this.viewModel.state===e},s.renderTemplates=function(e){const{EditorPanel:t,headingLevel:n,messages:a,messagesCommon:s,_handleBack:i,_snappingControls:o,viewModel:{sketchViewModel:r}}=this;return A.tsx(t,{active:this.isPanelActive(e),key:"templates-panel",handleBack:i,heading:a.selectTemplate,headingLevel:n,messages:a,messagesCommon:s,sketchViewModel:r,snappingControls:o},A.tsx("div",{class:W.panelContent},this._featureTemplates.render()))},s.renderAttributeEditing=function(e){const{activeWorkflow:t,EditorPanel:n,messages:a,messagesCommon:s,headingLevel:i,_handleBack:o,_snappingControls:r,viewModel:l}=this,{sketchViewModel:d}=l,c=l.featureFormViewModel;if("create-features"===t.type&&t.pendingFeatures.length<1)return this.renderFeatureCreation(e);const p="update"===t.type&&!t.data.edits.modified||l.syncing||c.updating,u="update"===t.type?a.editFeature:a.createFeatures,h="update"===t.type?s.update:s.create,m="create-features"===t.type&&"create-new"===t.createFeatureState,g="update"===t.type&&t.data.editableItem.supports.includes("delete"),_=this._shouldShowAttachmentsForWorkflow(t),f=[{label:"create-features"===t.type&&t.numPendingFeatures>1?T.substitute(a.createFeaturesTemplate,{numFeatures:t.numPendingFeatures}):h,type:"primary",disabled:p,clickHandler:this._handleSave,width:g?"half":"full"}];g&&f.push({label:s.delete,type:"tertiary",clickHandler:this._handleDelete,disabled:l.syncing,appearance:"outline",width:"half"});const w=c.inputFields.every((e=>!e.visible))&&!_?this.renderMessage(T.substitute(a.clickToFinishTemplate,{button:h})):A.tsx("div",{class:W.panelContentSection},A.tsx("div",{class:W.panelContentSectionGroup},this._featureForm.render(),_?A.tsx("div",{key:"attachments"},A.tsx(y.Heading,{level:y.incrementHeadingLevel(i)},a.attachments),this._attachments.render()):null));return A.tsx(n,{active:this.isPanelActive(e),key:"attribute-editing-panel",heading:u,headingLevel:i,handleBack:o,messages:a,messagesCommon:s,sketchViewModel:d,snappingControls:r},A.tsx("div",{class:W.panelContent},w,m?A.tsx("calcite-scrim",null):null),this.renderFooterActions(f))},s.renderAttachmentAdding=function(e){const{_attachments:t,EditorPanel:n,_handleBack:a,headingLevel:s,messages:i,messagesCommon:o,_snappingControls:r,viewModel:{sketchViewModel:l}}=this,d=[{label:t.submitting?o.cancel:o.add,disabled:t.submitting||!t.selectedFile,type:"primary",clickHandler:this._handleAttachmentAdd,width:"full"}];return A.tsx(n,{active:this.isPanelActive(e),key:"attachment-adding-panel",heading:i.addAttachment,headingLevel:s,handleBack:a,messages:i,messagesCommon:o,sketchViewModel:l,snappingControls:r},A.tsx("div",{class:W.panelContent},t.render()),this.renderFooterActions(d))},s.renderAttachmentEditing=function(e){const{_attachments:t,EditorPanel:n,_handleBack:a,headingLevel:s,messages:i,messagesCommon:o,_snappingControls:r,viewModel:{sketchViewModel:l}}=this,d=[{label:o.update,disabled:t.submitting||!t.selectedFile,type:"primary",clickHandler:this._handleAttachmentUpdate,width:"half"},{label:o.delete,disabled:t.submitting,type:"tertiary",clickHandler:this._handleAttachmentDelete,width:"half",appearance:"outline"}];return A.tsx(n,{active:this.isPanelActive(e),key:"attachment-editing-panel",heading:i.editAttachment,headingLevel:s,handleBack:a,messages:i,messagesCommon:o,sketchViewModel:l,snappingControls:r},A.tsx("div",{class:W.panelContent},t.render()),this.renderFooterActions(d))},s.renderFeatureUpdating=function(e){const{EditorPanel:t,_handleBack:n,headingLevel:a,messages:s,messagesCommon:i,_snappingControls:o,viewModel:{sketchViewModel:r}}=this;return A.tsx(t,{active:this.isPanelActive(e),key:"feature-updating-panel",heading:s.selectFeature,headingLevel:a,handleBack:n,messages:s,messagesCommon:i,sketchViewModel:r,snappingControls:o},A.tsx("div",{class:W.panelContent},this.renderMessage(s.selectFeatureToEdit)))},s.renderMessage=function(e){return A.tsx("div",{class:W.panelContentMessage},e)},s.renderFeatureCreation=function(e){const{EditorPanel:t,_handleBack:n,headingLevel:a,messages:s,messagesCommon:i,_snappingControls:o,viewModel:r}=this,{sketchViewModel:l}=r,d=r.sketchViewModel,c=this._assertActiveCreateWorkflow().data.creationInfo.layer,p=d.canUndo()&&d.createGraphic?d.createGraphic:null,u=this._getSketchingTip(c.geometryType,p);return A.tsx(t,{active:this.isPanelActive(e),key:"feature-creation-panel",heading:s.placeFeature,headingLevel:a,handleBack:n,messages:s,messagesCommon:i,sketchViewModel:l,snappingControls:o},A.tsx("div",{class:W.panelContent},this.renderMessage(u)))},s.renderFooterActions=function(e){return e.map((({type:e,disabled:t,class:n,...a},s)=>this.renderButton({class:this.classes(W.controlButton,"secondary"===e?W.buttonSecondary:"tertiary"===e?W.buttonTertiary:null,t?W.buttonDisabled:null,n),disabled:t??!1,key:s,slot:"footer-actions",...a})))},s.renderPrompt=function({title:e,message:t,context:n,actions:a}){const s=!!a.secondary,i=A.tsx("calcite-button",{appearance:"solid",color:"danger"===n?"red":"blue",width:s?"half":"full",onclick:a.primary.action,key:"prompt-primary-button",afterCreate:S},a.primary.label),o=s?A.tsx("calcite-button",{appearance:"clear",color:"danger"===n?"red":"blue",width:"half",onclick:a.secondary.action,key:"prompt-secondary-button"},a.secondary.label):null;return A.tsx("div",{class:`${W.promptContainer}--${n}`},A.tsx("div",{class:W.promptHeader},A.tsx("calcite-icon",{icon:"exclamation-mark-triangle"}),A.tsx(y.Heading,{class:W.promptHeading,level:this.headingLevel},e)),A.tsx("div",{class:W.promptMessage},t),A.tsx("div",{class:W.promptDivider}),A.tsx("div",{class:W.promptActions},o,i))},s.renderProgressBar=function(){return A.tsx("div",{class:this.classes(W.progressBar),key:"progress-bar"})},s.renderButton=function(e){const{disabled:t,class:n,key:a,clickHandler:s,label:i,...o}=e;return A.tsx("calcite-button",{class:n,disabled:t,key:a,onclick:s,type:"button",...o},i)},s.renderLanding=function(e){const{EditorPanel:t,headingLevel:n,messages:a,messagesCommon:s,_snappingControls:i,_featureTemplates:{viewModel:{numberOfFeatureTemplates:o}},viewModel:{canUpdate:r,sketchViewModel:l}}=this,d=!r&&0===o;return A.tsx(t,{active:this.isPanelActive(e),key:"landing-panel",heading:a.widgetLabel,headingLevel:n,showBackButton:!1,messages:a,messagesCommon:s,sketchViewModel:l,snappingControls:i},A.tsx("div",{class:W.panelContent},r?A.tsx("div",{key:"edit-actions",class:W.panelContentSection},this.renderUpdateActions()):void 0,o>0?A.tsx("div",{key:"create-actions",class:W.panelContentSection},this.renderCreateActions()):void 0,d?A.tsx("div",{key:"no-content",class:W.panelContentSection},a.noEditableLayers):void 0))},s.renderUpdateActions=function(){const{messages:e,messagesCommon:t}=this;return A.tsx("div",null,A.tsx(y.Heading,{level:y.incrementHeadingLevel(this.headingLevel)},e.editFeatures),A.tsx("div",{class:W.updateFeaturesActionButtons},A.tsx("calcite-action",{text:t.select,textEnabled:!0,icon:"cursor",alignment:"start",class:W.updateFeaturesActionButtonsButton,onclick:this._handleEdit})))},s.renderCreateActions=function(){const{_featureTemplates:e,headingLevel:t,messages:n}=this;return A.tsx("div",null,A.tsx(y.Heading,{level:y.incrementHeadingLevel(t)},n.createFeatures),A.tsx("div",{key:"templates",class:W.featureTemplatesContainer},e.render()))},s.renderFeatureList=function(e){const{EditorPanel:t,_handleBack:n,headingLevel:a,messages:s,messagesCommon:i,messagesTemplates:o,_snappingControls:r,viewModel:{editableItems:l,sketchViewModel:d}}=this,c=this._assertActiveUpdateWorkflow().data.candidates,p=T.substitute(s.multipleFeaturesTemplate,{total:c.length}),u=new Map;let h=0;c.map((e=>({label:this._getLabel(e),id:e.attributes[e.layer.objectIdField],data:e}))).filter((e=>{const{label:t,data:n}=e,a=this._filterText.toLowerCase(),{title:s}=n.layer,i=this.viewModel.editableItems.find((e=>e.layer===n.layer));return i.supports.includes("update")&&(!a||t.toLowerCase().includes(a)||s.toLowerCase().includes(a))})).forEach((e=>{h++;const t=e.data.layer;u.has(t)?u.get(t).items.push(e):u.set(t,{id:`${t.id}`,label:t.title,items:[e]})}));const m=l.filter((({layer:e})=>u.has(e))).map((({layer:e})=>u.get(e))).toArray(),g=h>10||this._filterText.length>0;return A.tsx(t,{active:this.isPanelActive(e),key:"feature-list",heading:p,headingLevel:a,handleBack:n,messages:s,messagesCommon:i,sketchViewModel:d,snappingControls:r},A.tsx("div",{class:W.panelContent},A.tsx("div",{class:W.panelContentSection},k.ItemList({id:this.id,enableListScroll:!1,filterEnabled:g,filterText:this._filterText,items:m,messages:{filterPlaceholder:o.filterPlaceholder,noItems:o.noItems,noMatches:o.noMatches},onItemMouseEnter:({data:e})=>this._setCandidateFeature(e),onItemMouseLeave:()=>this._setCandidateFeature(null),onItemSelect:({data:e})=>this._setCandidateFeature(e,!0),onFilterChange:e=>this._filterText=e}))))},s.EditorPanel=function(e,...t){const{active:n,handleBack:a,heading:s,headingLevel:i,key:o,messages:r,messagesCommon:l,showBackButton:d,sketchViewModel:c,snappingControls:p}=e,{snappingControls:u,undoRedoButtons:h}=this.visibleElements;return A.tsx("calcite-flow-item",{bind:this,key:o,heading:s,headingLevel:i,showBackButton:d??!0,"intl-back":l.back,closable:!1,onCalciteFlowItemScroll:this._closeSnappingPopover,onCalciteFlowItemBackClick:a??null},A.tsx("div",{class:W.panelToolbar},u?[A.tsx("calcite-popover",{autoClose:n,afterCreate:this._setSnappingPopover,afterUpdate:this._setSnappingPopover,bind:this,label:r.snappingSettings,heading:r.snappingSettings,referenceElement:this._snappingButton||null,"overlay-positioning":"fixed",placement:"bottom"},A.tsx("div",{class:W.snappingControlsPopover},p.render())),A.tsx("calcite-button",{id:`${o}__snappingButton`,afterCreate:this._setSnappingButton,afterUpdate:this._setSnappingButton,bind:this,text:r.snapping,appearance:"transparent",color:"neutral",alignment:"icon-end-space-between","icon-start":"vertex-gps","icon-end":"caret-down",width:"full",class:W.panelToolbarSnappingButton,onkeydown:e=>{"Escape"===e.key&&this._closeSnappingPopover()}},r.snapping)]:null,h?[A.tsx("calcite-button",{key:"undo-button",text:l.undo,appearance:"transparent",color:"neutral",alignment:"center","icon-start":"undo",scale:"l",disabled:!c.canUndo(),onclick:c.undo.bind(c)}),A.tsx("calcite-button",{key:"redo-button",text:l.redo,appearance:"transparent",color:"neutral",alignment:"center","icon-start":"redo",scale:"l",disabled:!c.canRedo(),onclick:c.redo.bind(c)})]:null),t)},s._closeSnappingPopover=function(){this._snappingPopover?.open&&this._snappingPopover.toggle()},s._setSnappingPopover=function(e){this._snappingPopover=e},s._setSnappingButton=function(e){this._snappingButton=e,this.scheduleRender()},s._getSketchingTip=function(e,t){const{messages:n}=this;if("point"===e)return n.tips.clickToAddPoint;if("polygon"===e||"polyline"===e){if(!t)return n.tips.clickToStart;const a=t.geometry,s="polygon"===e?"rings":"paths",[i]=a[s];return"polygon"===e&&i<4?n.tips.clickToContinue:n.tips.clickToContinueThenDoubleClickToEnd}return n.tips.clickToAddFeature},s._getLabel=function(e){const t=e.layer;if(!t)return null;const{objectIdField:n}=t,{attributes:a}=e,s=u.getDisplayFieldName(t);return s&&a[s]&&`${a[s]}`||T.substitute(this.messages.untitledFeatureTemplate,{id:a[n]})},s._handleDelete=function(){const{messages:e,messagesCommon:t}=this;this._prompt={title:e.deleteWarningTitle,message:e.deleteWarningMessage,context:"danger",actions:{primary:{label:t.delete,action:()=>{this.viewModel.deleteFeatureFromWorkflow(),this._prompt=null}},secondary:{label:e.keepFeature,action:()=>this._prompt=null}}}},s._handleSave=function(){const{featureFormViewModel:e}=this.viewModel;e.submit(),!e.submittable||e.validateContingencyConstraints(e.getValues(),{includeIncompleteViolations:!0}).length>0||this.viewModel.activeWorkflow.commit()},s._handleAttachmentAdd=function(){const{_attachments:e}=this,{activeWorkflow:t}=this.viewModel;"create-features"===t.type?(e.addFile(),t.previous()):e.addAttachment().then((()=>t.previous()))},s._handleAttachmentUpdate=function(){const{_attachments:e}=this,{activeWorkflow:t}=this.viewModel;"create-features"===t.type?(e.updateFile(),t.previous()):e.updateAttachment().then((()=>t.previous()))},s._handleAttachmentDelete=function(){const{messages:e,messagesCommon:t}=this;this._prompt={title:e.deleteAttachmentWarningTitle,message:e.deleteAttachmentWarningMessage,context:"danger",actions:{primary:{label:t.delete,action:()=>{const{_attachments:e}=this,{activeWorkflow:t}=this.viewModel;"create-features"===t.type?(e.deleteFile(),t.previous(),this._prompt=null):e.deleteAttachment(e.viewModel.activeAttachmentInfo).then((()=>{t.previous(),this._prompt=null}))}},secondary:{label:e.keepAttachment,action:()=>this._prompt=null}}}},s._handleAdd=function(){this.viewModel.canCreate},s._handleEdit=function(){this.viewModel.canUpdate&&this.viewModel.startUpdateWorkflowAtFeatureSelection()},s._handleDone=function(){this.viewModel.cancelWorkflow({force:!0})},s._handleBack=function(){var e=t._asyncToGenerator((function*(e){if(!this.activeWorkflow)return;const t=this.activeWorkflow;if(e?.stopPropagation(),this.viewModel.syncing)return;const n=()=>{t.hasPreviousStep?t.previous({cancelCurrentStep:!0}):this.viewModel.cancelWorkflow({force:!0})};if("create"===t.type||"create-features"===t.type&&t.numPendingFeatures>0||"editing-existing-feature"===t.stepId&&t.data.edits.modified){const{messages:e}=this,{type:a}=t,s="create"===a?e.cancelAddWarningMessage:e.cancelEditWarningMessage,i="create"===a?e.cancelAddTitle:e.cancelEditTitle,o="create"===a?e.continueAdding:e.continueEditing,r="create"===a?e.discardFeature:e.discardEdits;return this._prompt={title:i,message:s,context:"danger",actions:{primary:{label:r,action:()=>{this._prompt=null,n()}},secondary:{label:o,action:()=>this._prompt=null}}},void this.scheduleRender()}n()}));function n(t){return e.apply(this,arguments)}return n}(),s._assertActiveCreateWorkflow=function(){const{type:e}=this.viewModel.activeWorkflow;if("create"===e||"create-features"===e)return this.viewModel.activeWorkflow;throw new Error("Expected activeWorkflow to be instance of CreateWorkflow or CreateFeaturesWorkflow")},s._assertActiveUpdateWorkflow=function(){if("update"===this.viewModel.activeWorkflow.type)return this.viewModel.activeWorkflow;throw new Error("Expected activeWorkflow to be an UpdateWorkflow")},s._shouldShowAttachmentsForWorkflow=function(e){const t="create-features"===e.type&&e.data.creationInfo;let n=!1;if(t){const{layerInfos:e}=this,{layer:a}=t,{data:s}=a.capabilities,i=e&&e.find((e=>e.layer===a));n="supportsAttachment"in s&&s.supportsAttachment&&(!i||!1!==i.allowAttachments)}return n||"update"===e.type&&e.data.editableItem.hasAttachments},t._createClass(a,[{key:"activeWorkflow",get:function(){return this.viewModel.activeWorkflow}},{key:"allowedWorkflows",get:function(){return this.viewModel.allowedWorkflows},set:function(e){this.viewModel.allowedWorkflows=e}},{key:"label",get:function(){return this.messages?.widgetLabel??""},set:function(e){this._overrideIfSome("label",e)}},{key:"labelOptions",get:function(){return this.viewModel.labelOptions},set:function(e){this.viewModel.labelOptions=e}},{key:"layerInfos",get:function(){return this.viewModel.layerInfos},set:function(e){this.viewModel.layerInfos=e}},{key:"snappingOptions",get:function(){return this.viewModel.snappingOptions},set:function(e){this.viewModel.snappingOptions=e}},{key:"tooltipOptions",get:function(){return this.viewModel.tooltipOptions},set:function(e){this.viewModel.tooltipOptions=e}},{key:"view",get:function(){return this.viewModel.view},set:function(e){this.viewModel.view=e}}]),a}(s.HandleOwnerMixin(f));n.__decorate([l.property()],L.prototype,"_attachments",void 0),n.__decorate([l.property({readOnly:!0})],L.prototype,"activeWorkflow",null),n.__decorate([l.property()],L.prototype,"allowedWorkflows",null),n.__decorate([l.property()],L.prototype,"useDeprecatedCreateWorkflow",void 0),n.__decorate([l.property()],L.prototype,"headingLevel",void 0),n.__decorate([l.property()],L.prototype,"iconClass",void 0),n.__decorate([l.property()],L.prototype,"label",null),n.__decorate([l.property()],L.prototype,"labelOptions",null),n.__decorate([l.property()],L.prototype,"layerInfos",null),n.__decorate([l.property(),M.messageBundle("esri/widgets/Editor/t9n/Editor")],L.prototype,"messages",void 0),n.__decorate([l.property(),M.messageBundle("esri/t9n/common")],L.prototype,"messagesCommon",void 0),n.__decorate([l.property(),M.messageBundle("esri/widgets/FeatureTemplates/t9n/FeatureTemplates")],L.prototype,"messagesTemplates",void 0),n.__decorate([l.property()],L.prototype,"snappingOptions",null),n.__decorate([l.property()],L.prototype,"tooltipOptions",null),n.__decorate([l.property()],L.prototype,"supportingWidgetDefaults",void 0),n.__decorate([l.property()],L.prototype,"view",null),n.__decorate([l.property(),F.vmEvent(["workflow-cancel","workflow-commit"])],L.prototype,"viewModel",void 0),n.__decorate([l.property()],L.prototype,"visibleElements",void 0),n.__decorate([c.cast("visibleElements")],L.prototype,"castVisibleElements",null),n.__decorate([C.accessibleHandler()],L.prototype,"_handleDelete",null),n.__decorate([C.accessibleHandler()],L.prototype,"_handleAttachmentAdd",null),n.__decorate([C.accessibleHandler()],L.prototype,"_handleAttachmentUpdate",null),n.__decorate([C.accessibleHandler()],L.prototype,"_handleAttachmentDelete",null),n.__decorate([C.accessibleHandler()],L.prototype,"_handleAdd",null),n.__decorate([C.accessibleHandler()],L.prototype,"_handleEdit",null),n.__decorate([C.accessibleHandler()],L.prototype,"_handleDone",null),L=n.__decorate([p.subclass(B)],L);return L}));
