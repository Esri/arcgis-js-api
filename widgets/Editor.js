/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../intl","../core/events","../core/HandleOwner","../core/watchUtils","../core/accessorSupport/decorators/aliasOf","../core/has","../core/accessorSupport/ensureType","../core/Logger","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/subclass","../layers/support/fieldUtils","../views/interactive/snapping/SnappingOptions","./Attachments","./FeatureForm","./FeatureTemplates","./Spinner","./Widget","./Editor/EditorViewModel","./FeatureTemplates/ItemList","./support/Heading","./support/decorators/accessibleHandler","./support/decorators/messageBundle","./support/decorators/vmEvent","./support/jsxFactory","./support/widgetUtils","../intl/substitute"],(function(e,t,i,s,r,a,n,o,l,d,c,p,u,h,m,_,g,w,f,v,y,b,k,A,M,W,x,T){"use strict";const F={base:"esri-editor esri-widget esri-widget--panel",header:"esri-editor__header",scroller:"esri-editor__scroller",content:"esri-editor__content",contentGroup:"esri-editor__content-group",contentWrapper:"esri-editor__temp-wrapper",message:"esri-editor__message",controls:"esri-editor__controls",title:"esri-editor__title",backButton:"esri-editor__back-button",modeSelection:"esri-editor__mode-selection",progressBar:"esri-editor__progress-bar",warningCard:"esri-editor__warning-card",warningHeader:"esri-editor__warning-header",warningHeading:"esri-editor__warning-heading",warningMessage:"esri-editor__warning-message",warningDivider:"esri-editor__warning-divider",warningOption:"esri-editor__warning-option",warningOptionPrimary:"esri-editor__warning-option--primary",warningOptionNegative:"esri-editor__warning-option--negative",warningOptionPositive:"esri-editor__warning-option--positive",featureList:"esri-editor__feature-list",featureListItem:"esri-editor__feature-list-item",featureListItemDisabled:"esri-editor__feature-list-item--disabled",featureListName:"esri-editor__feature-list-name",featureListIcon:"esri-editor__feature-list-icon",featureListIndex:"esri-editor__feature-list-index",controlButton:"esri-editor__control-button",overlay:"esri-editor__overlay",errorIcon:"esri-icon-error2",basemapIcon:"esri-basemap",rightArrowIcon:"esri-icon-right",leftArrowIcon:"esri-icon-left",warningIcon:"esri-icon-notice-triangle",widgetIcon:"esri-icon-edit",button:"esri-button",buttonDisabled:"esri-button--disabled",buttonSecondary:"esri-button--secondary",buttonTertiary:"esri-button--tertiary",buttonDrillIn:"esri-button--drill-in",buttonDrillInTitle:"esri-button--drill-in__title",input:"esri-input",interactive:"esri-interactive",select:"esri-select"};function C(e){e.focus()}let I=function(t){function i(i,s){var r;return(r=t.call(this,i,s)||this)._candidateCommitted=!1,r._featureForm=new _,r._attachments=new m({visibleElements:{addSubmitButton:!1,cancelAddButton:!1,cancelUpdateButton:!1,deleteButton:!1,errorMessage:!1,progressBar:!1,updateButton:!1}}),r._featureTemplates=new g,r._filterText="",r._prompt=null,r._spinner=new w,r.activeWorkflow=null,r.allowedWorkflows=null,r.headingLevel=4,r.iconClass=F.widgetIcon,r.label=void 0,r.layerInfos=null,r.messages=null,r.messagesCommon=null,r.messagesTemplates=null,r.snappingOptions=new h,r.supportingWidgetDefaults=null,r.view=null,r.viewModel=new v,r._handleHeaderClickOrKeyDown=t=>{t.currentTarget["data-prevent-back"]||r._handleBack.call(e._assertThisInitialized(r),t)},r._setCandidateFeature=(e,t=!1)=>{if(r._candidateCommitted)return;const i=r._assertActiveUpdateWorkflow();i.data.edits.feature=e,t&&(i.next(),r._candidateCommitted=!0)},r._handleSave=r._handleSave.bind(e._assertThisInitialized(r)),r._handleBack=r._handleBack.bind(e._assertThisInitialized(r)),r._handleDone=r._handleDone.bind(e._assertThisInitialized(r)),r._handleDelete=r._handleDelete.bind(e._assertThisInitialized(r)),r._handleAdd=r._handleAdd.bind(e._assertThisInitialized(r)),r._handleEdit=r._handleEdit.bind(e._assertThisInitialized(r)),r._handleAttachmentAdd=r._handleAttachmentAdd.bind(e._assertThisInitialized(r)),r._handleAttachmentUpdate=r._handleAttachmentUpdate.bind(e._assertThisInitialized(r)),r._handleAttachmentDelete=r._handleAttachmentDelete.bind(e._assertThisInitialized(r)),r}e._inheritsLoose(i,t);var r=i.prototype;return r.initialize=function(){this.own([a.init(this,"headingLevel",(e=>{this._featureForm.headingLevel=e+1,this._featureTemplates.headingLevel=e+1})),a.init(this,"viewModel",(e=>{this._featureForm.viewModel=e?e.featureFormViewModel:null,this._attachments.viewModel=e?e.attachmentsViewModel:null,this._featureTemplates.viewModel=e?e.featureTemplatesViewModel:null,this._spinner.viewModel=e?e.spinnerViewModel:null})),a.init(this,"view",((e,t)=>{const i=`editor-${this.id}-spinner`;t&&t.ui.remove(this._spinner,i),e&&e.ui.add(this._spinner,{key:i,position:"manual"})})),a.on(this,"viewModel.sketchViewModel","create",(()=>{this.scheduleRender()})),a.on(this,"viewModel.activeWorkflow","cancel-request",(({controller:e})=>{const{messages:t,messagesCommon:i}=this;this._prompt={title:t.cancelRequestTitle,message:t.cancelRequestWarningMessage,options:[{label:i.form.no,type:"neutral",action:()=>(e.deny(),this._prompt=null)},{label:i.form.yes,type:"negative",action:()=>{e.allow(),this._prompt=null}}]},this.scheduleRender()})),a.init(this,"supportingWidgetDefaults",(e=>{e&&(this._featureForm.set(e.featureForm),this._attachments.set(e.attachments),this._featureTemplates.set(e.featureTemplates),this.viewModel.sketchViewModel.set(e.sketch))})),a.watch(this,"_attachments.error",(e=>{if(!e)return;const{messages:t,messagesCommon:i}=this;this._prompt={title:t.errorWarningTitle,message:e.message,options:[{label:i.form.ok,type:"neutral",action:()=>{this._prompt=null}}]}})),a.watch(this,"viewModel.failures",(e=>{if(!e)return;const{messages:t}=this,[{error:i,retry:s,cancel:r}]=e;this._prompt={title:t.errorWarningTitle,message:T.substitute(t.errorWarningMessageTemplate,{errorMessage:i.message}),options:[{label:t.retry,type:"positive",action:()=>{s(),this._prompt=null}},{label:t.ignore,type:"neutral",action:()=>(r(),this._prompt=null)}]}})),a.watch(this,"viewModel.state",(e=>{"awaiting-update-feature-candidate"===e&&(this._candidateCommitted=!1)})),a.watch(this,["_attachments.selectedFile","_attachments.submitting"],(()=>this.scheduleRender())),a.whenNot(this,"viewModel.activeWorkflow",(()=>this._featureTemplates.filterText=""))])},r.destroy=function(){this._attachments.destroy(),this._featureForm.destroy(),this._featureTemplates.destroy()},r.startCreateWorkflowAtFeatureTypeSelection=function(){return this.viewModel.startCreateWorkflowAtFeatureTypeSelection()},r.startCreateWorkflowAtFeatureCreation=function(e){return this.viewModel.startCreateWorkflowAtFeatureCreation(e)},r.startCreateWorkflowAtFeatureEdit=function(e){return this.viewModel.startCreateWorkflowAtFeatureEdit(e)},r.startUpdateWorkflowAtFeatureSelection=function(){return this.viewModel.startUpdateWorkflowAtFeatureSelection()},r.startUpdateWorkflowAtMultipleFeatureSelection=function(e){return this.viewModel.startUpdateWorkflowAtMultipleFeatureSelection(e)},r.startUpdateWorkflowAtFeatureEdit=function(e){return this.viewModel.startUpdateWorkflowAtFeatureEdit(e)},r.deleteFeatureFromWorkflow=function(){return this.viewModel.deleteFeatureFromWorkflow()},r.cancelWorkflow=function(e){return this.viewModel.cancelWorkflow(e)},r.render=function(){const{_attachments:e,viewModel:t}=this;if(!t)return W.tsx("div",{class:F.base});const{state:i}=t,s=this._prompt?W.tsx("div",{class:F.overlay,key:"overlay"},this.renderPrompt({message:this._prompt.message,title:this._prompt.title,options:this._prompt.options})):null;return W.tsx("div",{class:F.base},t.syncing||e.submitting?this.renderProgressBar():null,"disabled"===i?null:"ready"===i?this.renderLanding():"awaiting-feature-creation-info"===i?this.renderTemplates():"editing-new-feature"===i||"editing-existing-feature"===i?this.renderAttributeEditing():"awaiting-feature-to-update"===i?this.renderFeatureUpdating():"awaiting-update-feature-candidate"===i?this.renderFeatureList():"awaiting-feature-to-create"===i?this.renderFeatureCreation():"adding-attachment"===i?this.renderAttachmentAdding():"editing-attachment"===i?this.renderAttachmentEditing():null,s)},r.renderTemplates=function(){return W.tsx("div",{class:F.contentWrapper,key:"wrapper"},this.renderHeader(this.messages.selectTemplate,!0),W.tsx("div",{key:"content",class:F.content},this._featureTemplates.render()))},r.renderAttributeEditing=function(){const e=this.viewModel.featureFormViewModel,t=this._assertActiveCreateOrUpdateWorklow(),i=t.data.edits.feature,s="update"===t.type&&!t.data.edits.modified||e.inputFields.length>0&&!e.valid,{messages:r,messagesCommon:a}=this,n="create"===t.type?a.add:a.update,o=[{label:n,type:"primary",disabled:s,clickHandler:this._handleSave}];let l=!1;"update"===t.type&&(t.data.editableItem.hasAttachments&&(l=!0),t.data.editableItem.supports.includes("delete")&&o.push({label:a.delete,type:"tertiary",clickHandler:this._handleDelete}));const d=this._getLabel(i);return W.tsx("div",{class:F.contentWrapper,key:"wrapper"},this.renderHeader(d,!0),W.tsx("div",{key:"content",class:this.classes(F.content,F.scroller)},W.tsx("div",{class:F.contentGroup},e.inputFields.length>0?this._featureForm.render():this.renderMessage(T.substitute(r.clickToFinishTemplate,{button:n})),l?W.tsx("div",{key:"attachments"},W.tsx("div",null,r.attachments),this._attachments.render()):null)),this.renderControls(o))},r.renderAttachmentAdding=function(){const{_attachments:e,messages:t,messagesCommon:i}=this,s=[{label:e.submitting?i.cancel:i.add,disabled:e.submitting||!e.selectedFile,type:"primary",clickHandler:this._handleAttachmentAdd}];return W.tsx("div",{class:F.contentWrapper,key:"wrapper"},this.renderHeader(t.addAttachment,!0,e.submitting),W.tsx("div",{key:"content",class:this.classes(F.content,F.scroller)},e.render()),this.renderControls(s))},r.renderAttachmentEditing=function(){const{_attachments:e,messages:t,messagesCommon:i}=this,s=[{label:i.update,disabled:e.submitting||!e.selectedFile,type:"primary",clickHandler:this._handleAttachmentUpdate},{label:i.delete,disabled:e.submitting,type:"tertiary",clickHandler:this._handleAttachmentDelete}];return W.tsx("div",{class:F.contentWrapper,key:"wrapper"},this.renderHeader(t.editAttachment,!0,e.submitting),W.tsx("div",{key:"content",class:this.classes(F.content,F.scroller)},e.render()),this.renderControls(s))},r.renderFeatureUpdating=function(){const{messages:e}=this;return W.tsx("div",{class:F.contentWrapper,key:"wrapper"},this.renderHeader(e.selectFeature,!0),W.tsx("div",{key:"content",class:this.classes(F.content,F.scroller)},this.renderMessage(e.selectFeatureToEdit)))},r.renderMessage=function(e){return W.tsx("div",{class:F.message},e)},r.renderFeatureCreation=function(){const{messages:e,viewModel:t}=this,i=t.sketchViewModel,s=this._assertActiveCreateWorkflow().data.creationInfo.layer,r=i.canUndo()&&i.createGraphic?i.createGraphic:null,a=this._getSketchingTip(s.geometryType,r);return W.tsx("div",{class:F.contentWrapper,key:"wrapper"},this.renderHeader(e.placeFeature,!0),W.tsx("div",{key:"content",class:this.classes(F.content,F.scroller)},this.renderMessage(a)))},r.renderControls=function(e){return W.tsx("div",{class:F.controls,key:"controls"},e.map((({disabled:e=!1,label:t,type:i,clickHandler:s},r)=>this.renderButton({label:t,class:this.classes(F.controlButton,F.button,"secondary"===i?F.buttonSecondary:"tertiary"===i?F.buttonTertiary:null,e?F.buttonDisabled:null),disabled:e,clickHandler:s,key:r}))))},r.renderPrompt=function({title:e,message:t,options:i=[]}){return W.tsx("div",{class:F.warningCard,role:"alert"},W.tsx("div",{class:F.warningHeader},W.tsx("span",{class:F.warningIcon,"aria-hidden":"true"}),W.tsx(b.Heading,{class:F.warningHeading,level:this.headingLevel},e)),W.tsx("div",{class:F.warningMessage},t),W.tsx("div",{class:F.warningDivider}),i.map((({label:e,action:t,type:i},r)=>{const a=0===r;return W.tsx("div",{afterCreate:a?C:null,class:this.classes(F.warningOption,a?F.warningOptionPrimary:null,"positive"===i?F.warningOptionPositive:"negative"===i?F.warningOptionNegative:null),key:r,onclick:t,onkeydown:e=>{const i=s.eventKey(e);x.isActivationKey(i)&&(e.preventDefault(),t.call(null))},tabIndex:0,role:"button"},e)})))},r.renderProgressBar=function(){return W.tsx("div",{class:this.classes(F.progressBar),key:"progress-bar"})},r.renderButton=function(e){return W.tsx("button",{class:e.class,disabled:e.disabled,key:e.key,onclick:e.clickHandler,type:"button"},e.label)},r.renderHeader=function(e,t=!1,i=!1){const{messagesCommon:s}=this;return W.tsx("header",{class:F.header,key:"header"},t?W.tsx("div",{"aria-label":s.back,class:this.classes(F.backButton,F.interactive,i?F.buttonDisabled:null),key:"back-button","data-prevent-back":i,onclick:this._handleHeaderClickOrKeyDown,onkeydown:this._handleHeaderClickOrKeyDown,role:"button",tabIndex:0,title:s.back},W.tsx("span",{"aria-hidden":"true",class:x.isRTL()?F.rightArrowIcon:F.leftArrowIcon})):null,W.tsx(b.Heading,{class:F.title,level:this.headingLevel},e))},r.renderLanding=function(){const{messages:e}=this,{allowedWorkflows:t,canCreate:i,canUpdate:s}=this.viewModel,r=x.isRTL()?F.leftArrowIcon:F.rightArrowIcon;return W.tsx("div",{class:F.contentWrapper,key:"wrapper"},this.renderHeader(e.widgetLabel),W.tsx("div",{key:"content",class:F.content,role:"group"},W.tsx("div",{class:F.modeSelection,key:"mode-selection"},t.indexOf("update")>-1?W.tsx("div",{"aria-disabled":s?"false":"true",class:this.classes(F.featureListItem,s?null:F.featureListItemDisabled),key:"update",onclick:this._handleEdit,onkeydown:this._handleEdit,role:"button",tabIndex:s?0:-1},W.tsx("span",{class:F.featureListName},e.editFeature),W.tsx("span",{"aria-hidden":"true",class:this.classes(F.featureListIcon,r)})):null,t.indexOf("create")>-1?W.tsx("div",{class:this.classes(F.featureListItem,i?null:F.featureListItemDisabled),key:"create",onclick:this._handleAdd,onkeydown:this._handleAdd,role:"button",tabIndex:i?0:-1},W.tsx("span",{class:F.featureListName},e.addFeature),W.tsx("span",{"aria-hidden":"true",class:this.classes(F.featureListIcon,r)})):null)))},r.renderFeatureList=function(){const{messages:e,messagesTemplates:t,viewModel:{editableItems:i}}=this,s=this._assertActiveUpdateWorkflow().data.candidates,r=T.substitute(e.multipleFeaturesTemplate,{total:s.length}),a=new Map;s.map((e=>({label:this._getLabel(e),id:e.attributes[e.layer.objectIdField],data:e}))).filter((e=>{const{label:t,data:i}=e,s=this._filterText.toLowerCase(),{title:r}=i.layer;return this.viewModel.editableItems.find((e=>e.layer===i.layer)).supports.indexOf("update")>-1&&(!s||t.toLowerCase().indexOf(s)>-1||r.toLowerCase().indexOf(s)>-1)})).forEach((e=>{const t=e.data.layer;a.has(t)?a.get(t).items.push(e):a.set(t,{id:`${t.id}`,label:t.title,items:[e]})}));const n=i.filter((({layer:e})=>a.has(e))).map((({layer:e})=>a.get(e))).toArray();return W.tsx("div",{class:F.contentWrapper,key:"wrapper"},this.renderHeader(r,!0),W.tsx("div",{key:"content",class:this.classes(F.content,F.scroller)},y.ItemList({id:this.id,filterText:this._filterText,items:n,messages:{filterPlaceholder:t.filterPlaceholder,noItems:t.noItems,noMatches:t.noMatches},onItemMouseEnter:({data:e})=>this._setCandidateFeature(e),onItemMouseLeave:()=>this._setCandidateFeature(null),onItemSelect:({data:e})=>this._setCandidateFeature(e,!0),onFilterChange:e=>this._filterText=e})))},r._getSketchingTip=function(e,t){const{messages:i}=this;if("point"===e)return i.tips.clickToAddPoint;if("polygon"===e||"polyline"===e){if(!t)return i.tips.clickToStart;const s=t.geometry,r="polygon"===e?"rings":"paths",[a]=s[r];return"polygon"===e&&a<4?i.tips.clickToContinue:i.tips.clickToContinueThenDoubleClickToEnd}return i.tips.clickToAddFeature},r._getLabel=function(e){const t=e.layer,{objectIdField:i}=t,{attributes:s}=e,r=u.getDisplayFieldName(t);return r&&s[r]&&`${s[r]}`||T.substitute(this.messages.untitledFeatureTemplate,{id:s[i]})},r._handleDelete=function(){const{messages:e,messagesCommon:t}=this;this._prompt={title:e.deleteWarningTitle,message:e.deleteWarningMessage,options:[{label:e.keepFeature,type:"neutral",action:()=>this._prompt=null},{label:t.delete,type:"positive",action:()=>{this.viewModel.deleteFeatureFromWorkflow(),this._prompt=null}}]}},r._handleSave=function(){this.viewModel.activeWorkflow.commit()},r._handleAttachmentAdd=function(){const{_attachments:e}=this,{activeWorkflow:t}=this.viewModel;e.addAttachment().then((()=>t.previous()))},r._handleAttachmentUpdate=function(){const{_attachments:e}=this,{activeWorkflow:t}=this.viewModel;e.updateAttachment().then((()=>t.previous()))},r._handleAttachmentDelete=function(){const{messages:e,messagesCommon:t}=this;this._prompt={title:e.deleteAttachmentWarningTitle,message:e.deleteAttachmentWarningMessage,options:[{label:e.keepAttachment,type:"neutral",action:()=>this._prompt=null},{label:t.delete,type:"positive",action:()=>{const{_attachments:e}=this,{activeWorkflow:t}=this.viewModel;e.deleteAttachment(e.viewModel.activeAttachmentInfo).then((()=>{t.previous(),this._prompt=null}))}}]}},r._handleAdd=function(){this.viewModel.canCreate&&this.viewModel.startCreateWorkflowAtFeatureTypeSelection()},r._handleEdit=function(){this.viewModel.canUpdate&&this.viewModel.startUpdateWorkflowAtFeatureSelection()},r._handleDone=function(){this.viewModel.cancelWorkflow({force:!0})},r._handleBack=function(){const{messages:e}=this,t=this._assertActiveCreateOrUpdateWorklow(),{stepId:i,data:s,type:r}=t,a=()=>{t.hasPreviousStep?t.previous({cancelCurrentStep:!0}):this.viewModel.cancelWorkflow({force:!0})};if("editing-new-feature"===i||"editing-existing-feature"===i&&s.edits.modified){const t="create"===r?e.cancelAddWarningMessage:e.cancelEditWarningMessage,i="create"===r?e.cancelAddTitle:e.cancelEditTitle,s="create"===r?e.continueAdding:e.continueEditing,n="create"===r?e.discardFeature:e.discardEdits;this._prompt={title:i,message:t,options:[{label:s,type:"neutral",action:()=>this._prompt=null},{label:n,type:"negative",action:()=>{a(),this._prompt=null}}]}}else a()},r._assertActiveCreateWorkflow=function(){if("create"===this.viewModel.activeWorkflow.type)return this.viewModel.activeWorkflow;throw Error("Expected activeWorkflow to be a CreateWorkflow")},r._assertActiveUpdateWorkflow=function(){if("update"===this.viewModel.activeWorkflow.type)return this.viewModel.activeWorkflow;throw Error("Expected activeWorkflow to be an UpdateWorkflow")},r._assertActiveCreateOrUpdateWorklow=function(){switch(this.viewModel.activeWorkflow.type){case"create":case"update":return this.viewModel.activeWorkflow}throw Error("Expected activeWorkflow to be either CreateWorkflow or UpdateWorkflow")},i}(r.HandleOwnerMixin(f));return t.__decorate([c.property()],I.prototype,"_attachments",void 0),t.__decorate([n.aliasOf("viewModel.activeWorkflow")],I.prototype,"activeWorkflow",void 0),t.__decorate([n.aliasOf("viewModel.allowedWorkflows")],I.prototype,"allowedWorkflows",void 0),t.__decorate([c.property()],I.prototype,"headingLevel",void 0),t.__decorate([c.property()],I.prototype,"iconClass",void 0),t.__decorate([c.property({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],I.prototype,"label",void 0),t.__decorate([n.aliasOf("viewModel.layerInfos")],I.prototype,"layerInfos",void 0),t.__decorate([c.property(),A.messageBundle("esri/widgets/Editor/t9n/Editor")],I.prototype,"messages",void 0),t.__decorate([c.property(),A.messageBundle("esri/t9n/common")],I.prototype,"messagesCommon",void 0),t.__decorate([c.property(),A.messageBundle("esri/widgets/FeatureTemplates/t9n/FeatureTemplates")],I.prototype,"messagesTemplates",void 0),t.__decorate([n.aliasOf("viewModel.snappingOptions")],I.prototype,"snappingOptions",void 0),t.__decorate([c.property()],I.prototype,"supportingWidgetDefaults",void 0),t.__decorate([n.aliasOf("viewModel.view")],I.prototype,"view",void 0),t.__decorate([c.property(),M.vmEvent(["workflow-cancel","workflow-commit"])],I.prototype,"viewModel",void 0),t.__decorate([k.accessibleHandler()],I.prototype,"_handleDelete",null),t.__decorate([k.accessibleHandler()],I.prototype,"_handleAttachmentAdd",null),t.__decorate([k.accessibleHandler()],I.prototype,"_handleAttachmentUpdate",null),t.__decorate([k.accessibleHandler()],I.prototype,"_handleAttachmentDelete",null),t.__decorate([k.accessibleHandler()],I.prototype,"_handleAdd",null),t.__decorate([k.accessibleHandler()],I.prototype,"_handleEdit",null),t.__decorate([k.accessibleHandler()],I.prototype,"_handleDone",null),t.__decorate([k.accessibleHandler()],I.prototype,"_handleBack",null),I=t.__decorate([p.subclass("esri.widgets.Editor")],I),I}));
