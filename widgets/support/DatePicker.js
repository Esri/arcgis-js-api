// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../intl","../../core/events","../../core/Logger","../../core/accessorSupport/decorators","../../intl/moment","../Widget","./datePickerUtils","./DatePickerViewModel","./Popover","./widget"],(function(e,t,a,r,i,o,s,n,d,l,c,h,u){"use strict";var _="esri-date-picker",p="esri-date-picker__calendar",y="esri-date-picker__month-picker",v="esri-date-picker__day-picker",f="esri-date-picker__week-item",k="esri-date-picker__day-item--nearby-month",D="esri-date-picker__day-item--active",m="esri-date-picker__day-item--today",g="esri-date-picker__day-item--selected",b="esri-date-picker__day-item",w="esri-date-picker__day-item--header",P="esri-date-picker__year-picker",O="esri-date-picker__year-picker-item--selected",x="esri-date-picker__year-picker-item",M="esri-date-picker__month-dropdown",I="esri-date-picker__date",B="esri-date-picker__calendar-toggle",C="esri-date-picker__input",N="esri-date-picker__text-input",F="esri-date-picker__icon--leading",T="esri-icon-left",A="esri-icon-right",S="esri-icon-calendar",Y="esri-widget",U="esri-widget--button",E="esri-input",K="esri-select",L={year:"numeric",month:"2-digit",day:"2-digit"},H=[" ","ArrowDown","ArrowLeft","ArrowRight","ArrowUp","End","Enter","Home","PageDown","PageUp"],q=o.getLogger("esri.widgets.support.DatePicker"),W="onfocusout"in HTMLElement.prototype,R="formatToParts"in Intl.DateTimeFormat.prototype;return function(e){function t(t,a){var r=e.call(this,t,a)||this;return r._activeDate=null,r._calendarNode=null,r._calendarPopover=new h({owner:r,placement:"bottom-start",anchorElement:function(){return r._rootNode},renderContentFunction:r._renderCalendar}),r._closedByUserAction=!1,r._isOpen=!1,r._requestDayPickerFocusOnCreate=!1,r._rootNode=null,r.dateInputEnabled=!1,r.label=void 0,r.messages=null,r.value=null,r.commitOnMonthChange=!1,r.viewModel=new c,r._handleDatePickerBlur=W?null:r._handleDatePickerBlurOrFocusOut,r._handleDatePickerFocusOut=W?r._handleDatePickerBlurOrFocusOut:null,r._toggle=r._toggle.bind(r),r}return a.__extends(t,e),t.prototype.loadLocale=function(){return a.__awaiter(this,void 0,void 0,(function(){var e;return a.__generator(this,(function(t){switch(t.label){case 0:return e=this,[4,n.loadMoment()];case 1:return e._moment=t.sent(),this._isOpen&&(this._activeDate=this._moment(this._activeDate.toDate())),[2]}}))}))},t.prototype.destroy=function(){this._calendarPopover.destroy()},t.prototype.render=function(){return u.tsx("div",{afterCreate:u.storeNode,bind:this,class:this.classes(_,Y),"data-node-ref":"_rootNode"},R&&this.dateInputEnabled?this.renderInputAndButtonMode():this.renderButtonOnlyMode())},t.prototype.renderButtonOnlyMode=function(){var e=r.formatDate(this.viewModel.value,L),t=this._isOpen,a=this.messages;return u.tsx("div",{afterUpdate:this._focusSelectedOrClosed,"aria-controls":t?this._getCalendarId():null,"aria-expanded":t.toString(),"aria-haspopup":"true","aria-label":a.setDate,"aria-pressed":t.toString(),class:this.classes(U,K,B),onclick:this._toggle,onkeydown:this._toggle,role:"button",tabIndex:0},u.tsx("span",{class:I},e))},t.prototype.renderInputAndButtonMode=function(){var e=r.formatDate(this.viewModel.value,L),t=this._isOpen,a=this.messages;return u.tsx("div",{class:this.classes(C)},u.tsx("input",{"aria-controls":t?this._getCalendarId():null,"aria-haspopup":"true","aria-label":a.setDate,bind:this,class:this.classes(N,E),key:"date-input",onblur:this._handleDateInputBlur,onfocus:this._handleDateInputFocus,onkeydown:this._handleDateInputKeyDown,type:"text",value:e}),u.tsx("span",{"aria-hidden":"true",class:this.classes(F,S)}))},t.prototype._handleDateInputKeyDown=function(e){"Enter"===e.key&&this._handleDateText(e)},t.prototype._handleDateInputBlur=function(e){this._handleDatePickerBlurOrFocusOut(e),this._isOpen||this._handleDateText(e)},t.prototype._handleDateInputFocus=function(){this._open(this.viewModel.value,!1)},t.prototype._handleDateText=function(e){var t,a=e.currentTarget;try{t=l.parseDateIntoParts(a.value,L)}catch(e){return q.warn(e),void(a.value=r.formatDate(this.viewModel.value,L))}var i=this._moment(t);i.isValid()?(this.viewModel.value=i.toDate(),this._activeDate=i):a.value=r.formatDate(this.viewModel.value,L)},t.prototype._focusSelectedOrClosed=function(e){this._closedByUserAction&&(this._closedByUserAction=!1,e.focus())},t.prototype._handleDatePickerKeydown=function(e){"Escape"===i.eventKey(e)&&(this._closedByUserAction=!0,this._close(),e.preventDefault(),e.stopPropagation())},t.prototype._renderCalendar=function(){var e=this._activeDate,t=this._moment(this.viewModel.value);return u.tsx("div",{afterCreate:u.storeNode,bind:this,class:this.classes(p,Y),"data-node-ref":"_calendarNode",id:this._getCalendarId(),key:"esri-date-picker__calendar",onkeydown:this._handleDatePickerKeydown},this._renderMonthPicker(e),this._renderDayPicker(e,t),this._renderYearPicker(e))},t.prototype._getCalendarId=function(){return"date-picker__calendar--"+this.id},t.prototype._handleDatePickerBlurOrFocusOut=function(e){if(!(e.currentTarget!==e.target)){var t=e.relatedTarget;this._calendarNode.contains(t)||this._rootNode.contains(t)||this._close()}},t.prototype._renderMonthPicker=function(e){var t=u.isRTL(),a=t?A:T,r=t?T:A,i=this._moment.months().map((function(t,a){var r=e.month()===a;return u.tsx("option",{selected:r},t)})),o=this.messages;return u.tsx("div",{class:y},u.tsx("div",{"aria-label":o.goToPreviousMonth,bind:this,class:U,onblur:this._handleDatePickerBlur,onclick:this._setPreviousMonth,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._setPreviousMonth,role:"button",tabIndex:0,title:o.goToPreviousMonth},u.tsx("span",{"aria-hidden":"true",class:a})),u.tsx("select",{"aria-live":"assertive","aria-label":o.selectMonth,bind:this,class:this.classes(M,K),id:this.id+"__month-picker",onblur:this._handleDatePickerBlur,onchange:this._setMonth,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._setMonth,title:o.selectMonth},i),u.tsx("div",{"aria-label":o.goToNextMonth,bind:this,class:U,onblur:this._handleDatePickerBlur,onclick:this._setNextMonth,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._setNextMonth,role:"button",tabIndex:0,title:o.goToNextMonth},u.tsx("span",{"aria-hidden":"true",class:r})))},t.prototype._renderDayPicker=function(e,t){var a=this,r=e.clone().day(this._moment.localeData().firstDayOfWeek()),i=this._getWeekLabels(r),o=this._getDayId(e),s=this._renderMonth(e,t);return u.tsx("div",{afterCreate:this._handleDayPickerCreate,"aria-activedescendant":o,"aria-labelledby":this.id+"__month-picker "+this.id+"__selected-year",bind:this,class:v,id:this.id+"__day-picker",onblur:this._handleDatePickerBlur,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._handleDayPickerKeydown,role:"grid",tabIndex:0},u.tsx("div",{class:f,role:"row"},i.map((function(e){return u.tsx("div",{"aria-label":e.name,class:a.classes(b,w),role:"columnheader",title:e.name},e.abbr)}))),s)},t.prototype._getDayId=function(e){return this.id+"__"+r.formatDate(e.valueOf(),L)},t.prototype._handleDayPickerCreate=function(e){this._requestDayPickerFocusOnCreate&&(this._requestDayPickerFocusOnCreate=!1,e.focus())},t.prototype._getWeekLabels=function(e){for(var t=[],a={weekday:"long"},i={weekday:"narrow"},o=0;o<7;o++)t.push({name:r.formatDate(e.valueOf(),a),abbr:r.formatDate(e.valueOf(),i)}),e.add(1,"day");return t},t.prototype._handleDayPickerKeydown=function(e){var t=e.ctrlKey,a=e.shiftKey,r=i.eventKey(e),o=this._activeDate;if(-1!==H.indexOf(r)){if("ArrowLeft"===r)o.subtract(1,"day");else if("ArrowRight"===r)o.add(1,"day");else if("ArrowUp"===r)o.subtract(1,"week");else if("ArrowDown"===r)o.add(1,"week");else if("PageUp"===r){var s=a?"year":"month";o.subtract(1,s)}else if("PageDown"===r){s=a?"year":"month";o.add(1,s)}else if("Home"===r){s=t?"year":"month";o.startOf(s)}else if("End"===r){s=t?"year":"month";o.endOf(s)}else"Enter"!==r&&" "!==r||(this.viewModel.value=o.toDate(),this._closedByUserAction=!0,this._close());e.preventDefault(),e.stopPropagation()}},t.prototype._renderMonth=function(e,t){for(var a,r=this._moment(),i=e.clone().startOf("month"),o=e.clone().endOf("month"),s=i.clone().subtract(i.weekday(),"day"),n=[],d=0;d<6;d++){for(var l=[],c=0;c<7;c++){var h=s.date(),_=s.isSame(e,"day"),p=s.isSame(t,"day"),y=this._getDayId(s),v=((a={})[k]=!s.isBetween(i,o,null,"[]"),a[m]=s.isSame(r,"day"),a[D]=_,a[g]=p,a);l.push(u.tsx("div",{"aria-label":h.toString(),"aria-selected":_.toString(),bind:this,class:this.classes(b,v),"data-iso-date":s.toISOString(),id:y,onclick:this._handleSelectedDate,onkeydown:this._handleSelectedDate,role:"gridcell"},h)),s.add(1,"day")}n.push(u.tsx("div",{class:f,role:"row"},l))}return n},t.prototype._renderYearPicker=function(e){var t={year:"numeric"},a=e.clone(),i=r.formatDate(a.valueOf(),t),o=r.formatDate(a.add(1,"year").valueOf(),t),s=r.formatDate(a.subtract(2,"year").valueOf(),t),n=this.messages;return u.tsx("div",{class:P},u.tsx("div",{"aria-label":n.goToPreviousYear,bind:this,class:x,onblur:this._handleDatePickerBlur,onclick:this._setPreviousYear,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._setPreviousYear,tabIndex:0,title:n.goToPreviousYear},s),u.tsx("div",{class:this.classes(x,O),id:this.id+"__selected-year"},i),u.tsx("div",{"aria-label":n.goToNextYear,bind:this,class:x,onblur:this._handleDatePickerBlur,onclick:this._setNextYear,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._setNextYear,tabIndex:0,title:n.goToNextYear},o))},t.prototype._toggle=function(){this._isOpen?this._close():this._open(this.viewModel.value)},t.prototype._setMonth=function(e){var t=e.target.value;this._activeDate.month(t),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate.toDate())},t.prototype._close=function(){this._activeDate=null,this._isOpen=!1,this._calendarPopover.open=!1},t.prototype._open=function(e,t){void 0===t&&(t=!0),this._activeDate=this._moment(e),this._isOpen=!0,this._calendarPopover.open=!0,this._requestDayPickerFocusOnCreate=t},t.prototype._setPreviousMonth=function(){this._activeDate.subtract(1,"month"),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate.toDate())},t.prototype._setNextMonth=function(){this._activeDate.add(1,"month"),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate.toDate())},t.prototype._setPreviousYear=function(){this._activeDate.subtract(1,"year")},t.prototype._setNextYear=function(){this._activeDate.add(1,"year")},t.prototype._handleSelectedDate=function(e){var t=e.target;this.viewModel.value=this._moment(t.getAttribute("data-iso-date")).toDate(),this._closedByUserAction=!0,this._close()},a.__decorate([s.property(),u.renderable()],t.prototype,"dateInputEnabled",void 0),a.__decorate([s.property({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],t.prototype,"label",void 0),a.__decorate([s.property(),u.renderable(),u.messageBundle("esri/widgets/support/t9n/DatePicker")],t.prototype,"messages",void 0),a.__decorate([s.aliasOf("viewModel.value")],t.prototype,"value",void 0),a.__decorate([s.property()],t.prototype,"commitOnMonthChange",void 0),a.__decorate([s.property({type:c}),u.renderable("viewModel.value")],t.prototype,"viewModel",void 0),a.__decorate([u.accessibleHandler()],t.prototype,"_toggle",null),a.__decorate([u.accessibleHandler()],t.prototype,"_setPreviousMonth",null),a.__decorate([u.accessibleHandler()],t.prototype,"_setNextMonth",null),a.__decorate([u.accessibleHandler()],t.prototype,"_setPreviousYear",null),a.__decorate([u.accessibleHandler()],t.prototype,"_setNextYear",null),a.__decorate([u.accessibleHandler()],t.prototype,"_handleSelectedDate",null),t=a.__decorate([s.subclass("esri.widgets.support.DatePicker")],t)}(d)}));