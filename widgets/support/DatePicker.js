/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/has","../../core/Logger","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/aliasOf","../../core/accessorSupport/decorators/subclass","../../core/urlUtils","../../core/uuid","../../portal/support/resourceExtension","../../core/events","../../intl/date","../../intl","../../intl/moment","./widgetUtils","./decorators/accessibleHandler","./decorators/messageBundle","./decorators/renderable","../../chunks/index","../Widget","./Popover","./DatePickerViewModel","./datePickerUtils"],(function(e,t,a,s,i,r,o,n,c,l,d,h,u,_,p,v,y,f,k,m,D,g,b,w){"use strict";const P="esri-date-picker",O="esri-date-picker__calendar",x="esri-date-picker__month-picker",M="esri-date-picker__day-picker",I="esri-date-picker__week-item",B="esri-date-picker__day-item--nearby-month",j="esri-date-picker__day-item--active",C="esri-date-picker__day-item--today",N="esri-date-picker__day-item--selected",T="esri-date-picker__day-item",F="esri-date-picker__day-item--header",S="esri-date-picker__year-picker",A="esri-date-picker__year-picker-item--selected",U="esri-date-picker__year-picker-item",Y="esri-date-picker__month-dropdown",E="esri-date-picker__date",H="esri-date-picker__calendar-toggle",L="esri-date-picker__input",K="esri-date-picker__text-input",$="esri-date-picker__icon--leading",q="esri-icon-left",W="esri-icon-right",R="esri-icon-calendar",z="esri-widget",V="esri-widget--button",G="esri-input",J="esri-select",Q={year:"numeric",month:"2-digit",day:"2-digit"},X=[" ","ArrowDown","ArrowLeft","ArrowRight","ArrowUp","End","Enter","Home","PageDown","PageUp"],Z="esri.widgets.support.DatePicker",ee=s.getLogger(Z),te="onfocusout"in HTMLElement.prototype,ae="formatToParts"in Intl.DateTimeFormat.prototype;let se=function(t){function a(a,s){var i;return(i=t.call(this,a,s)||this)._activeDate=null,i._calendarNode=null,i._calendarPopover=new g({owner:e._assertThisInitialized(i),placement:"bottom-start",anchorElement:()=>i._rootNode,renderContentFunction:i._renderCalendar}),i._closedByUserAction=!1,i._isOpen=!1,i._requestDayPickerFocusOnCreate=!1,i._rootNode=null,i.dateInputEnabled=!1,i.label=void 0,i.messages=null,i.value=null,i.commitOnMonthChange=!1,i.viewModel=new b,i._handleDatePickerBlur=te?null:i._handleDatePickerBlurOrFocusOut,i._handleDatePickerFocusOut=te?i._handleDatePickerBlurOrFocusOut:null,i._toggle=i._toggle.bind(e._assertThisInitialized(i)),i}e._inheritsLoose(a,t);var s=a.prototype;return s.loadLocale=async function(){this._moment=await p.loadMoment(),this._isOpen&&(this._activeDate=this._moment(this._activeDate.toDate()))},s.destroy=function(){this._calendarPopover.destroy()},s.render=function(){return m.jsx("div",{afterCreate:v.storeNode,bind:this,class:this.classes(P,z),"data-node-ref":"_rootNode"},ae&&this.dateInputEnabled?this.renderInputAndButtonMode():this.renderButtonOnlyMode())},s.renderButtonOnlyMode=function(){const e=u.formatDate(this.viewModel.value,Q),{_isOpen:t,messages:a}=this;return m.jsx("div",{afterUpdate:this._focusSelectedOrClosed,"aria-controls":t?this._getCalendarId():null,"aria-expanded":t.toString(),"aria-haspopup":"true","aria-label":a.setDate,"aria-pressed":t.toString(),class:this.classes(V,J,H),onclick:this._toggle,onkeydown:this._toggle,role:"button",tabIndex:0},m.jsx("span",{class:E},e))},s.renderInputAndButtonMode=function(){const e=u.formatDate(this.viewModel.value,Q),{_isOpen:t,messages:a}=this;return m.jsx("div",{class:this.classes(L)},m.jsx("input",{"aria-controls":t?this._getCalendarId():null,"aria-haspopup":"true","aria-label":a.setDate,bind:this,class:this.classes(K,G),key:"date-input",onblur:this._handleDateInputBlur,onfocus:this._handleDateInputFocus,onkeydown:this._handleDateInputKeyDown,type:"text",value:e}),m.jsx("span",{"aria-hidden":"true",class:this.classes($,R)}))},s._handleDateInputKeyDown=function(e){"Enter"===e.key&&this._handleDateText(e)},s._handleDateInputBlur=function(e){this._handleDatePickerBlurOrFocusOut(e),this._isOpen||this._handleDateText(e)},s._handleDateInputFocus=function(){this._open(this.viewModel.value,!1)},s._handleDateText=function(e){const t=e.currentTarget;let a;try{a=w.parseDateIntoParts(t.value,Q)}catch(e){return ee.warn(e),void(t.value=u.formatDate(this.viewModel.value,Q))}const s=this._moment(a);s.isValid()?(this.viewModel.value=s.toDate(),this._activeDate=s):t.value=u.formatDate(this.viewModel.value,Q)},s._focusSelectedOrClosed=function(e){this._closedByUserAction&&(this._closedByUserAction=!1,e.focus())},s._handleDatePickerKeydown=function(e){"Escape"===h.eventKey(e)&&(this._closedByUserAction=!0,this._close(),e.preventDefault(),e.stopPropagation())},s._renderCalendar=function(){const e=this._activeDate,t=this._moment(this.viewModel.value);return m.jsx("div",{afterCreate:v.storeNode,bind:this,class:this.classes(O,z),"data-node-ref":"_calendarNode",id:this._getCalendarId(),key:"esri-date-picker__calendar",onkeydown:this._handleDatePickerKeydown},this._renderMonthPicker(e),this._renderDayPicker(e,t),this._renderYearPicker(e))},s._getCalendarId=function(){return`date-picker__calendar--${this.id}`},s._handleDatePickerBlurOrFocusOut=function(e){if(e.currentTarget!==e.target)return;const t=e.relatedTarget;this._calendarNode.contains(t)||this._rootNode.contains(t)||this._close()},s._renderMonthPicker=function(e){const t=v.isRTL(),a=t?W:q,s=t?q:W,i=this._moment.months().map(((t,a)=>{const s=e.month()===a;return m.jsx("option",{selected:s},t)})),{messages:r}=this;return m.jsx("div",{class:x},m.jsx("div",{"aria-label":r.goToPreviousMonth,bind:this,class:V,onblur:this._handleDatePickerBlur,onclick:this._setPreviousMonth,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._setPreviousMonth,role:"button",tabIndex:0,title:r.goToPreviousMonth},m.jsx("span",{"aria-hidden":"true",class:a})),m.jsx("select",{"aria-live":"assertive","aria-label":r.selectMonth,bind:this,class:this.classes(Y,J),id:`${this.id}__month-picker`,onblur:this._handleDatePickerBlur,onchange:this._setMonth,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._setMonth,title:r.selectMonth},i),m.jsx("div",{"aria-label":r.goToNextMonth,bind:this,class:V,onblur:this._handleDatePickerBlur,onclick:this._setNextMonth,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._setNextMonth,role:"button",tabIndex:0,title:r.goToNextMonth},m.jsx("span",{"aria-hidden":"true",class:s})))},s._renderDayPicker=function(e,t){const a=e.clone().day(this._moment.localeData().firstDayOfWeek()),s=this._getWeekLabels(a),i=this._getDayId(e),r=this._renderMonth(e,t);return m.jsx("div",{afterCreate:this._handleDayPickerCreate,"aria-activedescendant":i,"aria-labelledby":`${this.id}__month-picker ${this.id}__selected-year`,bind:this,class:M,id:`${this.id}__day-picker`,onblur:this._handleDatePickerBlur,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._handleDayPickerKeydown,role:"grid",tabIndex:0},m.jsx("div",{class:I,role:"row"},s.map((e=>m.jsx("div",{"aria-label":e.name,class:this.classes(T,F),role:"columnheader",title:e.name},e.abbr)))),r)},s._getDayId=function(e){return`${this.id}__${u.formatDate(e.valueOf(),Q)}`},s._handleDayPickerCreate=function(e){this._requestDayPickerFocusOnCreate&&(this._requestDayPickerFocusOnCreate=!1,e.focus())},s._getWeekLabels=function(e){const t=[],a={weekday:"long"},s={weekday:"narrow"};for(let i=0;i<7;i++)t.push({name:u.formatDate(e.valueOf(),a),abbr:u.formatDate(e.valueOf(),s)}),e.add(1,"day");return t},s._handleDayPickerKeydown=function(e){const{ctrlKey:t,shiftKey:a}=e,s=h.eventKey(e),i=this._activeDate;if(-1!==X.indexOf(s)){if("ArrowLeft"===s)i.subtract(1,"day");else if("ArrowRight"===s)i.add(1,"day");else if("ArrowUp"===s)i.subtract(1,"week");else if("ArrowDown"===s)i.add(1,"week");else if("PageUp"===s){const e=a?"year":"month";i.subtract(1,e)}else if("PageDown"===s){const e=a?"year":"month";i.add(1,e)}else if("Home"===s){const e=t?"year":"month";i.startOf(e)}else if("End"===s){const e=t?"year":"month";i.endOf(e)}else"Enter"!==s&&" "!==s||(this.viewModel.value=i.toDate(),this._closedByUserAction=!0,this._close());e.preventDefault(),e.stopPropagation()}},s._renderMonth=function(e,t){const a=this._moment(),s=e.clone().startOf("month"),i=e.clone().endOf("month"),r=s.clone().subtract(s.weekday(),"day"),o=[];for(let n=0;n<6;n++){const n=[];for(let o=0;o<7;o++){const o=r.date(),c=r.isSame(e,"day"),l=r.isSame(t,"day"),d=this._getDayId(r),h={[B]:!r.isBetween(s,i,null,"[]"),[C]:r.isSame(a,"day"),[j]:c,[N]:l};n.push(m.jsx("div",{"aria-label":o.toString(),"aria-selected":c.toString(),bind:this,class:this.classes(T,h),"data-iso-date":r.toISOString(),id:d,onclick:this._handleSelectedDate,onkeydown:this._handleSelectedDate,role:"gridcell"},o)),r.add(1,"day")}o.push(m.jsx("div",{class:I,role:"row"},n))}return o},s._renderYearPicker=function(e){const t={year:"numeric"},a=e.clone(),s=u.formatDate(a.valueOf(),t),i=u.formatDate(a.add(1,"year").valueOf(),t),r=u.formatDate(a.subtract(2,"year").valueOf(),t),{messages:o}=this;return m.jsx("div",{class:S},m.jsx("div",{"aria-label":o.goToPreviousYear,bind:this,class:U,onblur:this._handleDatePickerBlur,onclick:this._setPreviousYear,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._setPreviousYear,tabIndex:0,title:o.goToPreviousYear},r),m.jsx("div",{class:this.classes(U,A),id:`${this.id}__selected-year`},s),m.jsx("div",{"aria-label":o.goToNextYear,bind:this,class:U,onblur:this._handleDatePickerBlur,onclick:this._setNextYear,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._setNextYear,tabIndex:0,title:o.goToNextYear},i))},s._toggle=function(){this._isOpen?this._close():this._open(this.viewModel.value)},s._setMonth=function(e){const t=e.target.value;this._activeDate.month(t),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate.toDate())},s._close=function(){this._activeDate=null,this._isOpen=!1,this._calendarPopover.open=!1},s._open=function(e,t=!0){this._activeDate=this._moment(e),this._isOpen=!0,this._calendarPopover.open=!0,this._requestDayPickerFocusOnCreate=t},s._setPreviousMonth=function(){this._activeDate.subtract(1,"month"),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate.toDate())},s._setNextMonth=function(){this._activeDate.add(1,"month"),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate.toDate())},s._setPreviousYear=function(){this._activeDate.subtract(1,"year")},s._setNextYear=function(){this._activeDate.add(1,"year")},s._handleSelectedDate=function(e){const t=e.target;this.viewModel.value=this._moment(t.getAttribute("data-iso-date")).toDate(),this._closedByUserAction=!0,this._close()},a}(D);return t.__decorate([r.property(),k.renderable()],se.prototype,"dateInputEnabled",void 0),t.__decorate([r.property({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],se.prototype,"label",void 0),t.__decorate([r.property(),k.renderable(),f.messageBundle("esri/widgets/support/t9n/DatePicker")],se.prototype,"messages",void 0),t.__decorate([o.aliasOf("viewModel.value")],se.prototype,"value",void 0),t.__decorate([r.property()],se.prototype,"commitOnMonthChange",void 0),t.__decorate([r.property({type:b}),k.renderable("viewModel.value")],se.prototype,"viewModel",void 0),t.__decorate([y.accessibleHandler()],se.prototype,"_toggle",null),t.__decorate([y.accessibleHandler()],se.prototype,"_setPreviousMonth",null),t.__decorate([y.accessibleHandler()],se.prototype,"_setNextMonth",null),t.__decorate([y.accessibleHandler()],se.prototype,"_setPreviousYear",null),t.__decorate([y.accessibleHandler()],se.prototype,"_setNextYear",null),t.__decorate([y.accessibleHandler()],se.prototype,"_handleSelectedDate",null),se=t.__decorate([n.subclass(Z)],se),se}));
