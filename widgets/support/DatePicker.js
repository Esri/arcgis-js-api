/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/has","../../core/Logger","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/aliasOf","../../core/accessorSupport/decorators/subclass","../../core/urlUtils","../../core/uuid","../../portal/support/resourceExtension","../../core/events","../../intl/date","../../intl","../../intl/moment","./widgetUtils","./decorators/accessibleHandler","./decorators/messageBundle","../../chunks/index","../Widget","./Popover","./DatePickerViewModel","./datePickerUtils"],(function(e,t,a,s,i,o,r,n,c,d,l,u,h,_,p,y,v,k,D,m,f,g,b){"use strict";const w={base:"esri-date-picker",datePicker:"esri-date-picker__calendar",monthPicker:"esri-date-picker__month-picker",dayPicker:"esri-date-picker__day-picker",week:"esri-date-picker__week-item",nearbyMonth:"esri-date-picker__day-item--nearby-month",activeDay:"esri-date-picker__day-item--active",today:"esri-date-picker__day-item--today",selectedDay:"esri-date-picker__day-item--selected",day:"esri-date-picker__day-item",dayHeader:"esri-date-picker__day-item--header",yearPicker:"esri-date-picker__year-picker",selectedYear:"esri-date-picker__year-picker-item--selected",year:"esri-date-picker__year-picker-item",monthDropdown:"esri-date-picker__month-dropdown",date:"esri-date-picker__date",datePickerToggle:"esri-date-picker__calendar-toggle",dateInput:"esri-date-picker__input",dateTextInput:"esri-date-picker__text-input",leadingIcon:"esri-date-picker__icon--leading",previousIcon:"esri-icon-left",nextIcon:"esri-icon-right",calendarIcon:"esri-icon-calendar",widget:"esri-widget",button:"esri-widget--button",input:"esri-input",select:"esri-select"},P={year:"numeric",month:"2-digit",day:"2-digit"},x=[" ","ArrowDown","ArrowLeft","ArrowRight","ArrowUp","End","Enter","Home","PageDown","PageUp"],O="esri.widgets.support.DatePicker",M=s.getLogger(O),I="onfocusout"in HTMLElement.prototype,B="formatToParts"in Intl.DateTimeFormat.prototype;let T=function(t){function a(a,s){var i;return(i=t.call(this,a,s)||this)._activeDate=null,i._calendarNode=null,i._calendarPopover=new f({owner:e._assertThisInitialized(i),placement:"bottom-start",anchorElement:()=>i._rootNode,renderContentFunction:i._renderCalendar}),i._closedByUserAction=!1,i._isOpen=!1,i._requestDayPickerFocusOnCreate=!1,i._rootNode=null,i.dateInputEnabled=!1,i.label=void 0,i.messages=null,i.value=null,i.commitOnMonthChange=!1,i.viewModel=new g,i._handleDatePickerBlur=I?null:i._handleDatePickerBlurOrFocusOut,i._handleDatePickerFocusOut=I?i._handleDatePickerBlurOrFocusOut:null,i._toggle=i._toggle.bind(e._assertThisInitialized(i)),i}e._inheritsLoose(a,t);var s=a.prototype;return s.loadLocale=async function(){this._moment=await p.loadMoment(),this._isOpen&&(this._activeDate=this._moment(this._activeDate.toDate()))},s.destroy=function(){this._calendarPopover.destroy()},s.render=function(){return D.jsx("div",{afterCreate:y.storeNode,bind:this,class:this.classes(w.base,w.widget),"data-node-ref":"_rootNode"},B&&this.dateInputEnabled?this.renderInputAndButtonMode():this.renderButtonOnlyMode())},s.renderButtonOnlyMode=function(){const e=h.formatDate(this.viewModel.value,P),{_isOpen:t,messages:a}=this;return D.jsx("div",{afterUpdate:this._focusSelectedOrClosed,"aria-controls":t?this._getCalendarId():null,"aria-expanded":t.toString(),"aria-haspopup":"true","aria-label":a.setDate,"aria-pressed":t.toString(),class:this.classes(w.button,w.select,w.datePickerToggle),onclick:this._toggle,onkeydown:this._toggle,role:"button",tabIndex:0},D.jsx("span",{class:w.date},e))},s.renderInputAndButtonMode=function(){const e=h.formatDate(this.viewModel.value,P),{_isOpen:t,messages:a}=this;return D.jsx("div",{class:this.classes(w.dateInput)},D.jsx("input",{"aria-controls":t?this._getCalendarId():null,"aria-haspopup":"true","aria-label":a.setDate,bind:this,class:this.classes(w.dateTextInput,w.input),key:"date-input",onblur:this._handleDateInputBlur,onfocus:this._handleDateInputFocus,onkeydown:this._handleDateInputKeyDown,type:"text",value:e}),D.jsx("span",{"aria-hidden":"true",class:this.classes(w.leadingIcon,w.calendarIcon)}))},s._handleDateInputKeyDown=function(e){"Enter"===e.key&&this._handleDateText(e)},s._handleDateInputBlur=function(e){this._handleDatePickerBlurOrFocusOut(e),this._isOpen||this._handleDateText(e)},s._handleDateInputFocus=function(){this._open(this.viewModel.value,!1)},s._handleDateText=function(e){const t=e.currentTarget;let a;try{a=b.parseDateIntoParts(t.value,P)}catch(i){return M.warn(i),void(t.value=h.formatDate(this.viewModel.value,P))}const s=this._moment(a);s.isValid()?(this.viewModel.value=s.toDate(),this._activeDate=s):t.value=h.formatDate(this.viewModel.value,P)},s._focusSelectedOrClosed=function(e){this._closedByUserAction&&(this._closedByUserAction=!1,e.focus())},s._handleDatePickerKeydown=function(e){"Escape"===u.eventKey(e)&&(this._closedByUserAction=!0,this._close(),e.preventDefault(),e.stopPropagation())},s._renderCalendar=function(){const e=this._activeDate,t=this._moment(this.viewModel.value);return D.jsx("div",{afterCreate:y.storeNode,bind:this,class:this.classes(w.datePicker,w.widget),"data-node-ref":"_calendarNode",id:this._getCalendarId(),key:"esri-date-picker__calendar",onkeydown:this._handleDatePickerKeydown},this._renderMonthPicker(e),this._renderDayPicker(e,t),this._renderYearPicker(e))},s._getCalendarId=function(){return`date-picker__calendar--${this.id}`},s._handleDatePickerBlurOrFocusOut=function(e){if(e.currentTarget!==e.target)return;const t=e.relatedTarget;this._calendarNode.contains(t)||this._rootNode.contains(t)||this._close()},s._renderMonthPicker=function(e){const t=y.isRTL(),a=t?w.nextIcon:w.previousIcon,s=t?w.previousIcon:w.nextIcon,i=this._moment.months().map(((t,a)=>{const s=e.month()===a;return D.jsx("option",{selected:s},t)})),{messages:o}=this;return D.jsx("div",{class:w.monthPicker},D.jsx("div",{"aria-label":o.goToPreviousMonth,bind:this,class:w.button,onblur:this._handleDatePickerBlur,onclick:this._setPreviousMonth,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._setPreviousMonth,role:"button",tabIndex:0,title:o.goToPreviousMonth},D.jsx("span",{"aria-hidden":"true",class:a})),D.jsx("select",{"aria-live":"assertive","aria-label":o.selectMonth,bind:this,class:this.classes(w.monthDropdown,w.select),id:`${this.id}__month-picker`,onblur:this._handleDatePickerBlur,onchange:this._setMonth,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._setMonth,title:o.selectMonth},i),D.jsx("div",{"aria-label":o.goToNextMonth,bind:this,class:w.button,onblur:this._handleDatePickerBlur,onclick:this._setNextMonth,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._setNextMonth,role:"button",tabIndex:0,title:o.goToNextMonth},D.jsx("span",{"aria-hidden":"true",class:s})))},s._renderDayPicker=function(e,t){const a=e.clone().day(this._moment.localeData().firstDayOfWeek()),s=this._getWeekLabels(a),i=this._getDayId(e),o=this._renderMonth(e,t);return D.jsx("div",{afterCreate:this._handleDayPickerCreate,"aria-activedescendant":i,"aria-labelledby":`${this.id}__month-picker ${this.id}__selected-year`,bind:this,class:w.dayPicker,id:`${this.id}__day-picker`,onblur:this._handleDatePickerBlur,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._handleDayPickerKeydown,role:"grid",tabIndex:0},D.jsx("div",{class:w.week,role:"row"},s.map((e=>D.jsx("div",{"aria-label":e.name,class:this.classes(w.day,w.dayHeader),role:"columnheader",title:e.name},e.abbr)))),o)},s._getDayId=function(e){return`${this.id}__${h.formatDate(e.valueOf(),P)}`},s._handleDayPickerCreate=function(e){this._requestDayPickerFocusOnCreate&&(this._requestDayPickerFocusOnCreate=!1,e.focus())},s._getWeekLabels=function(e){const t=[],a={weekday:"long"},s={weekday:"narrow"};for(let i=0;i<7;i++)t.push({name:h.formatDate(e.valueOf(),a),abbr:h.formatDate(e.valueOf(),s)}),e.add(1,"day");return t},s._handleDayPickerKeydown=function(e){const{ctrlKey:t,shiftKey:a}=e,s=u.eventKey(e),i=this._activeDate;if(-1!==x.indexOf(s)){if("ArrowLeft"===s)i.subtract(1,"day");else if("ArrowRight"===s)i.add(1,"day");else if("ArrowUp"===s)i.subtract(1,"week");else if("ArrowDown"===s)i.add(1,"week");else if("PageUp"===s){const e=a?"year":"month";i.subtract(1,e)}else if("PageDown"===s){const e=a?"year":"month";i.add(1,e)}else if("Home"===s){const e=t?"year":"month";i.startOf(e)}else if("End"===s){const e=t?"year":"month";i.endOf(e)}else"Enter"!==s&&" "!==s||(this.viewModel.value=i.toDate(),this._closedByUserAction=!0,this._close());e.preventDefault(),e.stopPropagation()}},s._renderMonth=function(e,t){const a=this._moment(),s=e.clone().startOf("month"),i=e.clone().endOf("month"),o=6,r=7,n=s.clone().subtract(s.weekday(),"day"),c=[];for(let d=0;d<o;d++){const o=[];for(let c=0;c<r;c++){const r=n.date(),c=n.isSame(e,"day"),d=n.isSame(t,"day"),l=this._getDayId(n),u={[w.nearbyMonth]:!n.isBetween(s,i,null,"[]"),[w.today]:n.isSame(a,"day"),[w.activeDay]:c,[w.selectedDay]:d};o.push(D.jsx("div",{"aria-label":r.toString(),"aria-selected":c.toString(),bind:this,class:this.classes(w.day,u),"data-iso-date":n.toISOString(),id:l,onclick:this._handleSelectedDate,onkeydown:this._handleSelectedDate,role:"gridcell"},r)),n.add(1,"day")}c.push(D.jsx("div",{class:w.week,role:"row"},o))}return c},s._renderYearPicker=function(e){const t={year:"numeric"},a=e.clone(),s=h.formatDate(a.valueOf(),t),i=h.formatDate(a.add(1,"year").valueOf(),t),o=h.formatDate(a.subtract(2,"year").valueOf(),t),{messages:r}=this;return D.jsx("div",{class:w.yearPicker},D.jsx("div",{"aria-label":r.goToPreviousYear,bind:this,class:w.year,onblur:this._handleDatePickerBlur,onclick:this._setPreviousYear,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._setPreviousYear,tabIndex:0,title:r.goToPreviousYear},o),D.jsx("div",{class:this.classes(w.year,w.selectedYear),id:`${this.id}__selected-year`},s),D.jsx("div",{"aria-label":r.goToNextYear,bind:this,class:w.year,onblur:this._handleDatePickerBlur,onclick:this._setNextYear,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._setNextYear,tabIndex:0,title:r.goToNextYear},i))},s._toggle=function(){this._isOpen?this._close():this._open(this.viewModel.value)},s._setMonth=function(e){const t=e.target.value;this._activeDate.month(t),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate.toDate())},s._close=function(){this._activeDate=null,this._isOpen=!1,this._calendarPopover.open=!1},s._open=function(e,t=!0){this._activeDate=this._moment(e),this._isOpen=!0,this._calendarPopover.open=!0,this._requestDayPickerFocusOnCreate=t},s._setPreviousMonth=function(){this._activeDate.subtract(1,"month"),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate.toDate())},s._setNextMonth=function(){this._activeDate.add(1,"month"),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate.toDate())},s._setPreviousYear=function(){this._activeDate.subtract(1,"year")},s._setNextYear=function(){this._activeDate.add(1,"year")},s._handleSelectedDate=function(e){const t=e.target;this.viewModel.value=this._moment(t.getAttribute("data-iso-date")).toDate(),this._closedByUserAction=!0,this._close()},a}(m);return t.__decorate([o.property()],T.prototype,"dateInputEnabled",void 0),t.__decorate([o.property({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],T.prototype,"label",void 0),t.__decorate([o.property(),k.messageBundle("esri/widgets/support/t9n/DatePicker")],T.prototype,"messages",void 0),t.__decorate([r.aliasOf("viewModel.value")],T.prototype,"value",void 0),t.__decorate([o.property()],T.prototype,"commitOnMonthChange",void 0),t.__decorate([o.property({type:g})],T.prototype,"viewModel",void 0),t.__decorate([v.accessibleHandler()],T.prototype,"_toggle",null),t.__decorate([v.accessibleHandler()],T.prototype,"_setPreviousMonth",null),t.__decorate([v.accessibleHandler()],T.prototype,"_setNextMonth",null),t.__decorate([v.accessibleHandler()],T.prototype,"_setPreviousYear",null),t.__decorate([v.accessibleHandler()],T.prototype,"_setNextYear",null),t.__decorate([v.accessibleHandler()],T.prototype,"_handleSelectedDate",null),T=t.__decorate([n.subclass(O)],T),T}));
