/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import"../../intl.js";import{eventKey as t,pausable as i}from"../../core/events.js";import a from"../../core/Logger.js";import{isNone as s}from"../../core/maybe.js";import{watch as r,sync as o}from"../../core/reactiveUtils.js";import{aliasOf as n}from"../../core/accessorSupport/decorators/aliasOf.js";import"../../core/arrayUtils.js";import"../../core/has.js";import"../../core/accessorSupport/ensureType.js";import{property as d}from"../../core/accessorSupport/decorators/property.js";import{subclass as l}from"../../core/accessorSupport/decorators/subclass.js";import c from"../Widget.js";import{parseDateIntoParts as h,getFirstDayOfWeek as u,getLocaleDayOfWeek as p}from"./datePickerUtils.js";import _ from"./DatePickerViewModel.js";import y from"./Popover.js";import{accessibleHandler as v}from"./decorators/accessibleHandler.js";import{messageBundle as m}from"./decorators/messageBundle.js";import{tsx as k}from"./jsxFactory.js";import{storeNode as g,isActivationKey as w,isRTL as D}from"./widgetUtils.js";import{DateTime as b,Info as f,Interval as M}from"luxon";import{formatDate as P}from"../../intl/date.js";import{getLocale as I}from"../../intl/locale.js";const O={base:"esri-date-picker",datePicker:"esri-date-picker__calendar",monthPicker:"esri-date-picker__month-picker",dayPicker:"esri-date-picker__day-picker",week:"esri-date-picker__week-item",nearbyMonth:"esri-date-picker__day-item--nearby-month",activeDay:"esri-date-picker__day-item--active",today:"esri-date-picker__day-item--today",selectedDay:"esri-date-picker__day-item--selected",day:"esri-date-picker__day-item",dayHeader:"esri-date-picker__day-item--header",yearPicker:"esri-date-picker__year-picker",selectedYear:"esri-date-picker__year-picker-item--selected",year:"esri-date-picker__year-picker-item",monthDropdown:"esri-date-picker__month-dropdown",date:"esri-date-picker__date",datePickerToggle:"esri-date-picker__calendar-toggle",dateInput:"esri-date-picker__input",dateTextInput:"esri-date-picker__text-input",leadingIcon:"esri-date-picker__icon--leading",previousIcon:"esri-icon-left",nextIcon:"esri-icon-right",calendarIcon:"esri-icon-calendar",widget:"esri-widget",button:"esri-widget--button",input:"esri-input",select:"esri-select"},x={year:"numeric",month:"2-digit",day:"2-digit"},C=[" ","ArrowDown","ArrowLeft","ArrowRight","ArrowUp","End","Enter","Home","PageDown","PageUp"],S="esri.widgets.support.DatePicker",N=a.getLogger(S);let j=class extends c{constructor(e,t){super(e,t),this._activeDate=null,this._calendarNode=null,this._calendarPopover=new y({owner:this,placement:"bottom-start",anchorElement:()=>this._rootNode,renderContentFunction:this._renderCalendar}),this._inputOrButtonNode=null,this._isOpen=!1,this._requestDayPickerFocusOnCreate=!1,this._rootNode=null,this.dateInputEnabled=!1,this.label=void 0,this.messages=null,this.value=null,this.commitOnMonthChange=!1,this.viewModel=new _,this.disabled=!1,this._toggle=this._toggle.bind(this)}initialize(){this.own(r((()=>({viewModel:this.viewModel,value:this.viewModel?.value})),(({viewModel:e,value:t})=>{this.destroyed||!e||s(this.onChange)||this.onChange(t)}),o))}destroy(){this._calendarPopover.destroy()}render(){return k("div",{afterCreate:g,bind:this,class:this.classes(O.base,O.widget),"data-node-ref":"_rootNode"},this.dateInputEnabled?this.renderInputAndButtonMode():this.renderButtonOnlyMode())}renderButtonOnlyMode(){const e=P(this.viewModel.value,x),{disabled:t,_isOpen:i,messages:a}=this;return k("div",{key:`date-button-${t}`,afterCreate:g,"aria-controls":i?this._getCalendarId():null,"aria-expanded":i.toString(),"aria-haspopup":"true","aria-label":a.setDate,"aria-pressed":i.toString(),bind:this,class:this.classes(O.button,O.select,O.datePickerToggle),"data-node-ref":"_inputOrButtonNode",onclick:this._toggle,onkeydown:this._handleDateButtonKeyDown,role:"button",tabIndex:t?null:0},k("span",{class:O.date},e))}renderInputAndButtonMode(){const e=P(this.viewModel.value,x),{_isOpen:t,messages:i}=this;return k("div",{class:this.classes(O.dateInput)},k("input",{afterCreate:g,"data-node-ref":"_inputOrButtonNode","aria-controls":t?this._getCalendarId():null,"aria-haspopup":"true","aria-label":i.setDate,bind:this,class:this.classes(O.dateTextInput,O.input),key:"date-input",onblur:this._handleDateInputBlur,onclick:this._handleDateInputClick,onkeydown:this._handleDateInputKeyDown,type:"text",value:e}),k("span",{"aria-hidden":"true",class:this.classes(O.leadingIcon,O.calendarIcon)}))}_handleDateInputClick(){this._open(this.viewModel.value,!1)}_handleDateInputKeyDown(e){const{key:t}=e;this._isOpen?"Enter"===t?this._handleDateText(e):"Escape"===t&&this._close():"ArrowDown"===t&&(this._open(this.viewModel.value),e.preventDefault())}_handleDateButtonKeyDown(e){const{key:t,shiftKey:i}=e;this._isOpen&&"Tab"===t&&i?this._close():w(t)&&this._toggle()}_handleDateInputBlur(e){this._isOpen||this._handleDateText(e)}_handleDateText(e){const t=e.currentTarget;let i;try{i=h(t.value,x)}catch(s){return N.warn(s),void(t.value=P(this.viewModel.value,x))}const a=b.fromObject(i);a.isValid?(this.viewModel.value=a.toJSDate(),this._activeDate=a):t.value=P(this.viewModel.value,x)}_handleDatePickerKeydown(e){"Escape"===t(e)&&(this._close(),e.preventDefault(),e.stopPropagation())}_renderCalendar(){const e=this._activeDate,t=b.fromJSDate(this.viewModel.value);return k("div",{afterCreate:g,bind:this,class:this.classes(O.datePicker,O.widget),"data-node-ref":"_calendarNode",id:this._getCalendarId(),key:"esri-date-picker__calendar",onkeydown:this._handleDatePickerKeydown},this._renderMonthPicker(e),this._renderDayPicker(e,t),this._renderYearPicker(e))}_getCalendarId(){return`date-picker__calendar--${this.id}`}_renderMonthPicker(e){const t=D(this.container),i=t?O.nextIcon:O.previousIcon,a=t?O.previousIcon:O.nextIcon,s=f.months("long",{locale:I()}).map(((t,i)=>{const a=e.month-1===i;return k("option",{selected:a,value:i.toString()},t)})),{disabled:r,messages:o}=this;return k("div",{class:O.monthPicker},k("div",{key:`previous-month-${r}`,"aria-label":o.goToPreviousMonth,bind:this,class:O.button,onclick:this._setPreviousMonth,onkeydown:this._handlePreviousMonthKeyDown,role:"button",tabIndex:r?null:0,title:o.goToPreviousMonth},k("span",{"aria-hidden":"true",class:i})),k("select",{"aria-live":"assertive","aria-label":o.selectMonth,bind:this,class:this.classes(O.monthDropdown,O.select),disabled:r,id:`${this.id}__month-picker`,onchange:this._setMonth,onkeydown:this._setMonth,title:o.selectMonth},s),k("div",{key:`next-month-${r}`,"aria-label":o.goToNextMonth,bind:this,class:O.button,onclick:this._setNextMonth,onkeydown:this._setNextMonth,role:"button",tabIndex:r?null:0,title:o.goToNextMonth},k("span",{"aria-hidden":"true",class:a})))}_renderDayPicker(e,t){const i=this._getWeekLabels(),a=this._getDayId(e),s=this._renderMonth(e,t),{id:r,disabled:o}=this;return k("div",{key:`day-picker-${o}`,afterCreate:this._handleDayPickerCreate,"aria-activedescendant":a,"aria-labelledby":`${r}__month-picker ${r}__selected-year`,bind:this,class:O.dayPicker,id:`${r}__day-picker`,onkeydown:this._handleDayPickerKeydown,role:"grid",tabIndex:o?null:0},k("div",{class:O.week,role:"row"},i.map((e=>k("div",{"aria-label":e.name,class:this.classes(O.day,O.dayHeader),role:"columnheader",title:e.name},e.abbr)))),s)}_getDayId(e){return`${this.id}__${P(e.valueOf(),x)}`}_handleDayPickerCreate(e){this._requestDayPickerFocusOnCreate&&(this._requestDayPickerFocusOnCreate=!1,e.focus())}_getWeekLabels(){const e=[],t={weekday:"long"},i={weekday:"narrow"};let a=b.now().set({weekday:u(I())});for(let s=0;s<7;s++)e.push({name:P(a.valueOf(),t),abbr:P(a.valueOf(),i)}),a=a.plus({day:1});return e}_handleDayPickerKeydown(e){const{ctrlKey:i,shiftKey:a}=e,s=t(e);if(!C.includes(s))return;let r=this._activeDate;if("ArrowLeft"===s)r=r.minus({day:1});else if("ArrowRight"===s)r=r.plus({day:1});else if("ArrowUp"===s)r=r.minus({week:1});else if("ArrowDown"===s)r=r.plus({week:1});else if("PageUp"===s){const e=a?"year":"month";r=r.minus({[e]:1})}else if("PageDown"===s){const e=a?"year":"month";r=r.plus({[e]:1})}else if("Home"===s){const e=i?"year":"month";r=r.startOf(e)}else if("End"===s){const e=i?"year":"month";r=r.endOf(e)}else w(s)&&(this.viewModel.value=r.toJSDate(),this._close());this._activeDate=r,e.preventDefault(),e.stopPropagation()}_renderMonth(e,t){const i=b.now(),a=e.startOf("month"),s=e.endOf("month"),r=6,o=7;let n=a.minus({day:p(I(),a.weekday)});const d=[];for(let l=0;l<r;l++){const r=[];for(let d=0;d<o;d++){const o=n.day,d=n.hasSame(e,"day"),l=n.hasSame(t,"day"),c=this._getDayId(n),h=M.fromDateTimes(a,s),u={[O.nearbyMonth]:!h.contains(n),[O.today]:n.hasSame(i,"day"),[O.activeDay]:d,[O.selectedDay]:l};r.push(k("div",{"aria-label":o.toString(),"aria-selected":d.toString(),bind:this,class:this.classes(O.day,u),"data-iso-date":n.toISO(),id:c,onclick:this._handleSelectedDate,onkeydown:this._handleSelectedDate,role:"gridcell"},o)),n=n.plus({day:1})}d.push(k("div",{class:O.week,role:"row"},r))}return d}_renderYearPicker(e){const t={year:"numeric"},i=e,a=P(i.valueOf(),t),s=P(i.plus({year:1}).valueOf(),t),r=P(i.minus({year:1}).valueOf(),t),{disabled:o,messages:n}=this;return k("div",{class:O.yearPicker},k("div",{key:`previous-year-${o}`,"aria-label":n.goToPreviousYear,bind:this,class:O.year,onclick:this._setPreviousYear,onkeydown:this._setPreviousYear,tabIndex:o?null:0,title:n.goToPreviousYear},r),k("div",{class:this.classes(O.year,O.selectedYear),id:`${this.id}__selected-year`},a),k("div",{key:`next-year-${o}`,"aria-label":n.goToNextYear,bind:this,class:O.year,onclick:this._setNextYear,onkeydown:this._handleNextYearKeyDown,tabIndex:o?null:0,title:n.goToNextYear},s))}_toggle(){this._isOpen?this._close():this._open(this.viewModel.value)}_setMonth(e){const t=e.target,i=Number(t.value)+1;this._activeDate=this._activeDate.set({month:i}),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate.toJSDate())}_close(e=!0){this._activeDate=null,this._isOpen=!1,this._calendarPopover.open=!1,this.pageClickHandler.pause(),e&&this._inputOrButtonNode.focus()}_open(e,t=!0){this._activeDate=b.fromJSDate(e),this._isOpen=!0,this._calendarPopover.open=!0,this._requestDayPickerFocusOnCreate=t,this.pageClickHandler||(this.pageClickHandler=i(document,"click",(({target:e})=>{this._calendarNode?.contains(e)||this._rootNode?.contains(e)||this._close()})),this.own(this.pageClickHandler)),this.pageClickHandler.resume()}_setPreviousMonth(){this._activeDate=this._activeDate.minus({month:1}),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate.toJSDate())}_handlePreviousMonthKeyDown(e){if("Tab"===e.key&&e.shiftKey)return e.preventDefault(),void this._close();w(e.key)&&this._setPreviousMonth()}_setNextMonth(){this._activeDate=this._activeDate.plus({month:1}),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate.toJSDate())}_setPreviousYear(){this._activeDate=this._activeDate.minus({year:1})}_setNextYear(){this._activeDate=this._activeDate.plus({year:1})}_handleNextYearKeyDown(e){if("Tab"===e.key&&!e.shiftKey)return e.preventDefault(),void this._close();w(e.key)&&this._setNextYear()}_handleSelectedDate(e){const t=e.target;this.viewModel.value=b.fromISO(t.getAttribute("data-iso-date")).toJSDate(),this._close()}};e([d()],j.prototype,"dateInputEnabled",void 0),e([d({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],j.prototype,"label",void 0),e([d(),m("esri/widgets/support/t9n/DatePicker")],j.prototype,"messages",void 0),e([n("viewModel.value")],j.prototype,"value",void 0),e([d()],j.prototype,"commitOnMonthChange",void 0),e([d({type:_})],j.prototype,"viewModel",void 0),e([d()],j.prototype,"onChange",void 0),e([d()],j.prototype,"disabled",void 0),e([v()],j.prototype,"_setNextMonth",null),e([v()],j.prototype,"_setPreviousYear",null),e([v()],j.prototype,"_handleSelectedDate",null),j=e([l(S)],j);const T=j;export{T as default};
