/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../intl","../../core/events","../../core/Logger","../../core/maybe","../../core/reactiveUtils","../../core/accessorSupport/decorators/aliasOf","../../core/arrayUtils","../../core/has","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/subclass","../Widget","./datePickerUtils","./DatePickerViewModel","./Popover","./decorators/accessibleHandler","./decorators/messageBundle","./jsxFactory","./widgetUtils","../../chunks/datetime","../../intl/date","../../intl/locale"],(function(e,t,a,i,s,n,o,r,d,l,c,h,u,_,p,v,y,k,D,f,g,m,w,b){"use strict";const P={base:"esri-date-picker",datePicker:"esri-date-picker__calendar",monthPicker:"esri-date-picker__month-picker",dayPicker:"esri-date-picker__day-picker",week:"esri-date-picker__week-item",nearbyMonth:"esri-date-picker__day-item--nearby-month",activeDay:"esri-date-picker__day-item--active",today:"esri-date-picker__day-item--today",selectedDay:"esri-date-picker__day-item--selected",day:"esri-date-picker__day-item",dayHeader:"esri-date-picker__day-item--header",yearPicker:"esri-date-picker__year-picker",selectedYear:"esri-date-picker__year-picker-item--selected",year:"esri-date-picker__year-picker-item",monthDropdown:"esri-date-picker__month-dropdown",date:"esri-date-picker__date",datePickerToggle:"esri-date-picker__calendar-toggle",dateInput:"esri-date-picker__input",dateTextInput:"esri-date-picker__text-input",leadingIcon:"esri-date-picker__icon--leading",previousIcon:"esri-icon-left",nextIcon:"esri-icon-right",calendarIcon:"esri-icon-calendar",widget:"esri-widget",button:"esri-widget--button",input:"esri-input",select:"esri-select"},x={year:"numeric",month:"2-digit",day:"2-digit"},M=[" ","ArrowDown","ArrowLeft","ArrowRight","ArrowUp","End","Enter","Home","PageDown","PageUp"],I="esri.widgets.support.DatePicker",O=s.getLogger(I);let C=function(t){function a(a,i){var s;return(s=t.call(this,a,i)||this)._activeDate=null,s._calendarNode=null,s._calendarPopover=new y({owner:e._assertThisInitialized(s),placement:"bottom-start",anchorElement:()=>s._rootNode,renderContentFunction:s._renderCalendar}),s._inputOrButtonNode=null,s._isOpen=!1,s._requestDayPickerFocusOnCreate=!1,s._rootNode=null,s.dateInputEnabled=!1,s.label=void 0,s.messages=null,s.value=null,s.commitOnMonthChange=!1,s.viewModel=new v,s._toggle=s._toggle.bind(e._assertThisInitialized(s)),s}e._inheritsLoose(a,t);var s=a.prototype;return s.initialize=function(){this.own(o.watch((()=>{var e;return{viewModel:this.viewModel,value:null==(e=this.viewModel)?void 0:e.value}}),(({viewModel:e,value:t})=>{this.destroyed||!e||n.isNone(this.onChange)||this.onChange(t)}),o.sync))},s.destroy=function(){this._calendarPopover.destroy()},s.render=function(){return f.tsx("div",{afterCreate:g.storeNode,bind:this,class:this.classes(P.base,P.widget),"data-node-ref":"_rootNode"},this.dateInputEnabled?this.renderInputAndButtonMode():this.renderButtonOnlyMode())},s.renderButtonOnlyMode=function(){const e=w.formatDate(this.viewModel.value,x),{_isOpen:t,messages:a}=this;return f.tsx("div",{afterCreate:g.storeNode,"aria-controls":t?this._getCalendarId():null,"aria-expanded":t.toString(),"aria-haspopup":"true","aria-label":a.setDate,"aria-pressed":t.toString(),bind:this,class:this.classes(P.button,P.select,P.datePickerToggle),"data-node-ref":"_inputOrButtonNode",onclick:this._toggle,onkeydown:this._handleDateButtonKeyDown,role:"button",tabIndex:0},f.tsx("span",{class:P.date},e))},s.renderInputAndButtonMode=function(){const e=w.formatDate(this.viewModel.value,x),{_isOpen:t,messages:a}=this;return f.tsx("div",{class:this.classes(P.dateInput)},f.tsx("input",{afterCreate:g.storeNode,"data-node-ref":"_inputOrButtonNode","aria-controls":t?this._getCalendarId():null,"aria-haspopup":"true","aria-label":a.setDate,bind:this,class:this.classes(P.dateTextInput,P.input),key:"date-input",onblur:this._handleDateInputBlur,onclick:this._handleDateInputClick,onkeydown:this._handleDateInputKeyDown,type:"text",value:e}),f.tsx("span",{"aria-hidden":"true",class:this.classes(P.leadingIcon,P.calendarIcon)}))},s._handleDateInputClick=function(){this._open(this.viewModel.value,!1)},s._handleDateInputKeyDown=function(e){const{key:t}=e;this._isOpen?"Enter"===t?this._handleDateText(e):"Escape"===t&&this._close():"ArrowDown"===t&&(this._open(this.viewModel.value),e.preventDefault())},s._handleDateButtonKeyDown=function(e){const{key:t,shiftKey:a}=e;this._isOpen&&"Tab"===t&&a?this._close():g.isActivationKey(t)&&this._toggle()},s._handleDateInputBlur=function(e){this._isOpen||this._handleDateText(e)},s._handleDateText=function(e){const t=e.currentTarget;let a;try{a=p.parseDateIntoParts(t.value,x)}catch(s){return O.warn(s),void(t.value=w.formatDate(this.viewModel.value,x))}const i=m.DateTime.fromObject(a);i.isValid?(this.viewModel.value=i.toJSDate(),this._activeDate=i):t.value=w.formatDate(this.viewModel.value,x)},s._handleDatePickerKeydown=function(e){"Escape"===i.eventKey(e)&&(this._close(),e.preventDefault(),e.stopPropagation())},s._renderCalendar=function(){const e=this._activeDate,t=m.DateTime.fromJSDate(this.viewModel.value);return f.tsx("div",{afterCreate:g.storeNode,bind:this,class:this.classes(P.datePicker,P.widget),"data-node-ref":"_calendarNode",id:this._getCalendarId(),key:"esri-date-picker__calendar",onkeydown:this._handleDatePickerKeydown},this._renderMonthPicker(e),this._renderDayPicker(e,t),this._renderYearPicker(e))},s._getCalendarId=function(){return`date-picker__calendar--${this.id}`},s._renderMonthPicker=function(e){const t=g.isRTL(this.container),a=t?P.nextIcon:P.previousIcon,i=t?P.previousIcon:P.nextIcon,s=m.Info.months("long",{locale:b.getLocale()}).map(((t,a)=>{const i=e.month-1===a;return f.tsx("option",{selected:i,value:a.toString()},t)})),{messages:n}=this;return f.tsx("div",{class:P.monthPicker},f.tsx("div",{"aria-label":n.goToPreviousMonth,bind:this,class:P.button,onclick:this._setPreviousMonth,onkeydown:this._handlePreviousMonthKeyDown,role:"button",tabIndex:0,title:n.goToPreviousMonth},f.tsx("span",{"aria-hidden":"true",class:a})),f.tsx("select",{"aria-live":"assertive","aria-label":n.selectMonth,bind:this,class:this.classes(P.monthDropdown,P.select),id:`${this.id}__month-picker`,onchange:this._setMonth,onkeydown:this._setMonth,title:n.selectMonth},s),f.tsx("div",{"aria-label":n.goToNextMonth,bind:this,class:P.button,onclick:this._setNextMonth,onkeydown:this._setNextMonth,role:"button",tabIndex:0,title:n.goToNextMonth},f.tsx("span",{"aria-hidden":"true",class:i})))},s._renderDayPicker=function(e,t){const a=this._getWeekLabels(),i=this._getDayId(e),s=this._renderMonth(e,t);return f.tsx("div",{afterCreate:this._handleDayPickerCreate,"aria-activedescendant":i,"aria-labelledby":`${this.id}__month-picker ${this.id}__selected-year`,bind:this,class:P.dayPicker,id:`${this.id}__day-picker`,onkeydown:this._handleDayPickerKeydown,role:"grid",tabIndex:0},f.tsx("div",{class:P.week,role:"row"},a.map((e=>f.tsx("div",{"aria-label":e.name,class:this.classes(P.day,P.dayHeader),role:"columnheader",title:e.name},e.abbr)))),s)},s._getDayId=function(e){return`${this.id}__${w.formatDate(e.valueOf(),x)}`},s._handleDayPickerCreate=function(e){this._requestDayPickerFocusOnCreate&&(this._requestDayPickerFocusOnCreate=!1,e.focus())},s._getWeekLabels=function(){const e=[],t={weekday:"long"},a={weekday:"narrow"};let i=m.DateTime.now().set({weekday:p.getFirstDayOfWeek(b.getLocale())});for(let s=0;s<7;s++)e.push({name:w.formatDate(i.valueOf(),t),abbr:w.formatDate(i.valueOf(),a)}),i=i.plus({day:1});return e},s._handleDayPickerKeydown=function(e){const{ctrlKey:t,shiftKey:a}=e,s=i.eventKey(e);if(-1===M.indexOf(s))return;let n=this._activeDate;if("ArrowLeft"===s)n=n.minus({day:1});else if("ArrowRight"===s)n=n.plus({day:1});else if("ArrowUp"===s)n=n.minus({week:1});else if("ArrowDown"===s)n=n.plus({week:1});else if("PageUp"===s){const e=a?"year":"month";n=n.minus({[e]:1})}else if("PageDown"===s){const e=a?"year":"month";n=n.plus({[e]:1})}else if("Home"===s){const e=t?"year":"month";n=n.startOf(e)}else if("End"===s){const e=t?"year":"month";n=n.endOf(e)}else g.isActivationKey(s)&&(this.viewModel.value=n.toJSDate(),this._close());this._activeDate=n,e.preventDefault(),e.stopPropagation()},s._renderMonth=function(e,t){const a=m.DateTime.now(),i=e.startOf("month"),s=e.endOf("month"),n=6,o=7;let r=i.minus({day:p.getLocaleDayOfWeek(b.getLocale(),i.weekday)});const d=[];for(let l=0;l<n;l++){const n=[];for(let d=0;d<o;d++){const o=r.day,d=r.hasSame(e,"day"),l=r.hasSame(t,"day"),c=this._getDayId(r),h=m.Interval.fromDateTimes(i,s),u={[P.nearbyMonth]:!h.contains(r),[P.today]:r.hasSame(a,"day"),[P.activeDay]:d,[P.selectedDay]:l};n.push(f.tsx("div",{"aria-label":o.toString(),"aria-selected":d.toString(),bind:this,class:this.classes(P.day,u),"data-iso-date":r.toISO(),id:c,onclick:this._handleSelectedDate,onkeydown:this._handleSelectedDate,role:"gridcell"},o)),r=r.plus({day:1})}d.push(f.tsx("div",{class:P.week,role:"row"},n))}return d},s._renderYearPicker=function(e){const t={year:"numeric"},a=e,i=w.formatDate(a.valueOf(),t),s=w.formatDate(a.plus({year:1}).valueOf(),t),n=w.formatDate(a.minus({year:1}).valueOf(),t),{messages:o}=this;return f.tsx("div",{class:P.yearPicker},f.tsx("div",{"aria-label":o.goToPreviousYear,bind:this,class:P.year,onclick:this._setPreviousYear,onkeydown:this._setPreviousYear,tabIndex:0,title:o.goToPreviousYear},n),f.tsx("div",{class:this.classes(P.year,P.selectedYear),id:`${this.id}__selected-year`},i),f.tsx("div",{"aria-label":o.goToNextYear,bind:this,class:P.year,onclick:this._setNextYear,onkeydown:this._handleNextYearKeyDown,tabIndex:0,title:o.goToNextYear},s))},s._toggle=function(){this._isOpen?this._close():this._open(this.viewModel.value)},s._setMonth=function(e){const t=e.target,a=Number(t.value)+1;this._activeDate=this._activeDate.set({month:a}),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate.toJSDate())},s._close=function(e=!0){this._activeDate=null,this._isOpen=!1,this._calendarPopover.open=!1,this.pageClickHandler.pause(),e&&this._inputOrButtonNode.focus()},s._open=function(e,t=!0){this._activeDate=m.DateTime.fromJSDate(e),this._isOpen=!0,this._calendarPopover.open=!0,this._requestDayPickerFocusOnCreate=t,this.pageClickHandler||(this.pageClickHandler=i.pausable(document,"click",(({target:e})=>{var t,a;(null==(t=this._calendarNode)?void 0:t.contains(e))||(null==(a=this._rootNode)?void 0:a.contains(e))||this._close()})),this.own(this.pageClickHandler)),this.pageClickHandler.resume()},s._setPreviousMonth=function(){this._activeDate=this._activeDate.minus({month:1}),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate.toJSDate())},s._handlePreviousMonthKeyDown=function(e){if("Tab"===e.key&&e.shiftKey)return e.preventDefault(),void this._close();g.isActivationKey(e.key)&&this._setPreviousMonth()},s._setNextMonth=function(){this._activeDate=this._activeDate.plus({month:1}),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate.toJSDate())},s._setPreviousYear=function(){this._activeDate=this._activeDate.minus({year:1})},s._setNextYear=function(){this._activeDate=this._activeDate.plus({year:1})},s._handleNextYearKeyDown=function(e){if("Tab"===e.key&&!e.shiftKey)return e.preventDefault(),void this._close();g.isActivationKey(e.key)&&this._setNextYear()},s._handleSelectedDate=function(e){const t=e.target;this.viewModel.value=m.DateTime.fromISO(t.getAttribute("data-iso-date")).toJSDate(),this._close()},a}(_);t.__decorate([h.property()],C.prototype,"dateInputEnabled",void 0),t.__decorate([h.property({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],C.prototype,"label",void 0),t.__decorate([h.property(),D.messageBundle("esri/widgets/support/t9n/DatePicker")],C.prototype,"messages",void 0),t.__decorate([r.aliasOf("viewModel.value")],C.prototype,"value",void 0),t.__decorate([h.property()],C.prototype,"commitOnMonthChange",void 0),t.__decorate([h.property({type:v})],C.prototype,"viewModel",void 0),t.__decorate([h.property()],C.prototype,"onChange",void 0),t.__decorate([k.accessibleHandler()],C.prototype,"_setNextMonth",null),t.__decorate([k.accessibleHandler()],C.prototype,"_setPreviousYear",null),t.__decorate([k.accessibleHandler()],C.prototype,"_handleSelectedDate",null),C=t.__decorate([u.subclass(I)],C);return C}));
