// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../intl","../../core/events","../../core/accessorSupport/decorators","../../intl/moment","../Widget","./TimePickerViewModel","./widget"],(function(e,t,i,r,a,n,s,o,u,l){"use strict";var h="esri-time-picker esri-widget",p="esri-time-picker__input",c="esri-input",d={hour:"numeric",minute:"numeric"},_=["ArrowDown","ArrowLeft","ArrowRight","ArrowUp","Tab"];function v(e){return r.formatDate(e.valueOf(),d).indexOf(" ")>-1}return function(e){function t(t,i){var r=e.call(this,t,i)||this;return r._activeTime=null,r.label=void 0,r.messages=null,r.value=null,r.viewModel=new u,r}return i.__extends(t,e),t.prototype.loadLocale=function(){return i.__awaiter(this,void 0,void 0,(function(){var e;return i.__generator(this,(function(t){switch(t.label){case 0:return e=this,[4,s.loadMoment()];case 1:return e._moment=t.sent(),[2]}}))}))},t.prototype.render=function(){var e=this._activeTime||this.viewModel.value;return l.tsx("div",{class:h},l.tsx("input",{afterUpdate:this._handleInputUpdate,"aria-label":this.messages.inputTitle,bind:this,class:this.classes(p,c),onblur:this._handleInputBlur,onfocus:this._handleInputFocus,onkeydown:this._handleInputKeydown,onclick:this._handleInputClick,onpaste:this._handleInputPaste,onwheel:this._handleInputWheel,value:r.formatDate(e.valueOf(),d)}))},t.prototype._handleInputBlur=function(){this._activeTime.isValid()&&(this.viewModel.value=this._activeTime.toDate()),this._activeTime=null,this._activePart=null},t.prototype._handleInputUpdate=function(e){this._selectPart(e,this._activePart)},t.prototype._selectPart=function(e,t){var i=this._activeTime;if(i){var a=r.formatDate(i.valueOf(),d),n=a.indexOf(":");if("hours"!==t){var s=n+1,o=s+2;if("minutes"!==t){var u=o+1,l=a.length;"meridiem"!==t||e.setSelectionRange(u,l)}else e.setSelectionRange(s,o)}else e.setSelectionRange(0,n)}},t.prototype._handleInputFocus=function(e){this._activePart="hours",this._activeTime=this._moment(this.viewModel.value).startOf("minute"),this._selectPart(e.target,"hours")},t.prototype._caretIndexToPartName=function(e){var t=this._activeTime.format("LT"),i=t.indexOf(":"),r=t.indexOf(" ");return e<=i?"hours":e>i&&e<=r?"minutes":"meridiem"},t.prototype._handleInputKeydown=function(e){var t=e.ctrlKey,i=e.metaKey,r=e.shiftKey,n=a.eventKey(e),s=this._activeTime,o=this._activePart,u=/\d/.test(n),l=/^a|p$/i.test(n),h=i||t;if(_.indexOf(n)>-1||u||"meridiem"===o&&l&&!h){if("ArrowLeft"===n)this._activePart=this._prevPart();else if("ArrowRight"===n)this._activePart=this._nextPart();else if("Tab"===n){var p=r?this._prevPart():this._nextPart();if(p===this._activePart)return;this._activePart=p}else if("ArrowUp"===n)this._shift("up",s,o);else if("ArrowDown"===n)this._shift("down",s,o);else if(u)this._setTime(s,o,Number(n));else if(l){var c=n.toLowerCase(),d=s.hour();("a"===c&&d>=12||"p"===c&&d<12)&&this._shift("up",s,o)}e.preventDefault(),e.stopImmediatePropagation()}else h||(e.preventDefault(),e.stopImmediatePropagation())},t.prototype._handleInputClick=function(e){var t=e.target;this._activePart=null,this.renderNow(),this._activePart=this._caretIndexToPartName(t.selectionStart)},t.prototype._getOrderedParts=function(){return v(this._activeTime)?["hours","minutes","meridiem"]:["hours","minutes"]},t.prototype._prevPart=function(){var e=this._getOrderedParts(),t=e.indexOf(this._activePart)-1;return e[Math.max(t,0)]},t.prototype._nextPart=function(){var e=this._getOrderedParts(),t=e.indexOf(this._activePart)+1;return e[Math.min(t,e.length-1)]},t.prototype._setTime=function(e,t,i){if("hours"===t){var r=v(e)?12:24,a=""+e.hour()%r,n=i,s=Number(""+a+i);2===a.length||s>r?e.hour(n):s<=r&&e.hour(s)}else if("minutes"===t){var o=""+e.minute(),u=i,l=Number(""+o+i);2===o.length||l>59?e.minute(u):l<59&&e.minute(l)}},t.prototype._handleInputPaste=function(e){var t=e.clipboardData.getData("text/plain"),i=this._moment(t);i.isValid()&&(this._activeTime=i),e.preventDefault(),e.stopImmediatePropagation()},t.prototype._handleInputWheel=function(e){var t=e.deltaY<0?"up":"down";this._shift(t,this._activeTime,this._activePart)},t.prototype._shift=function(e,t,i){if(e&&t&&i){var r="meridiem"===i?12:1,a="hours"===i?"hour":"minutes"===i?"minute":"hours";t["up"===e?"add":"subtract"](r,a)}},i.__decorate([n.property({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],t.prototype,"label",void 0),i.__decorate([n.property(),l.renderable(),l.messageBundle("esri/widgets/support/t9n/TimePicker")],t.prototype,"messages",void 0),i.__decorate([n.aliasOf("viewModel.value")],t.prototype,"value",void 0),i.__decorate([n.property({type:u}),l.renderable("viewModel.value")],t.prototype,"viewModel",void 0),t=i.__decorate([n.subclass("esri.widgets.support.TimePicker")],t)}(o)}));