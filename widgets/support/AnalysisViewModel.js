/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/Accessor","../../core/asyncUtils","../../core/Logger","../../core/maybe","../../core/promiseUtils","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/accessorSupport/decorators/subclass"],(function(e,t,i,s,n,o,r,a,l,c,y,h,p){"use strict";var u;function w(e){return r.isSome(e)&&e.state>=u.RUNNING?(e.abort(),null):e}!function(e){e[e.PENDING=0]="PENDING",e[e.WAIT_FOR_VIEW_READY=1]="WAIT_FOR_VIEW_READY",e[e.RUNNING=2]="RUNNING"}(u||(u={})),e.AnalysisViewModel=function(e){function i(t={}){var i;(i=e.call(this,t)||this).view=null,i.analysisView=null,i._reconnectViewTask=null,i._forceInteractiveHandle=null,i._parentChangeFromReconnect=!1,i._startUserOperation=null,i.logger=o.getLogger(i.declaredClass);const s=t?.analysis;return r.isSome(s)?i.analysis=s:(i._set("analysis",i.constructAnalysis()),i._set("isAnalysisOwner",!0)),t&&null!=t.visible&&(i.visible=t.visible),i}t._inheritsLoose(i,e);var s=i.prototype;return s.normalizeCtorArgs=function(e){const{analysis:t,...i}=e;return i},s.initialize=function(){this.addHandles([l.watch((()=>({readyAndNotSupported:r.isSome(this.view)&&this.view.ready&&!this.supported})),(({readyAndNotSupported:e})=>{e&&this.logger.errorOnce(this.unsupportedErrorMessage)}),l.syncAndInitial),l.watch((()=>r.applySome(this.analysis,(({parent:e})=>e))),(e=>{this._parentChangeFromReconnect||e===this.view||this._set("isAnalysisOwner",!1);const t=!this._parentChangeFromReconnect;this._parentChangeFromReconnect=!1,t&&this._scheduleViewReconnect()}),l.sync),l.watch((()=>({view:this.view,ready:r.isSome(this.view)&&this.view.ready,supported:this.supported})),(({view:e},t)=>{const i=t?.view;e!==i&&(this._startUserOperation=r.abortMaybe(this._startUserOperation),this._disconnectFromView(i)),this._scheduleViewReconnect()}),l.syncAndInitial)])},s.destroy=function(){this._reconnectViewTask=r.abortMaybe(this._reconnectViewTask),this._startUserOperation=r.abortMaybe(this._startUserOperation),r.isSome(this.analysisView)&&(this.analysisView.visible=void 0),this._disconnectFromView(this.view),this._set("view",null),r.isSome(this.analysis)&&this.isAnalysisOwner&&(this.analysis.destroy(),this._set("analysis",null))},s.clear=function(){this._startUserOperation=r.abortMaybe(this._startUserOperation),this._resetInteractiveCreationState(),r.isSome(this.tool)&&r.isSome(this.view)&&this.view.activeTool===this.tool&&(this.view.activeTool=null)},s.start=function(){var e=t._asyncToGenerator((function*(){var e=this;this.clear();const i={task:null,abort:null,state:u.PENDING},s=n.createTask(function(){var s=t._asyncToGenerator((function*(t){if(i.state=u.WAIT_FOR_VIEW_READY,yield l.whenOnce((()=>e.ready),t),i.state=u.RUNNING,r.isNone(e.analysisView)||r.isNone(e.view))return;const s=e.analysisView.tool;r.isNone(s)||(e.view.activeTool=s,l.when((()=>s.created),(()=>{s.active&&r.isSome(e.view)&&(e.view.activeTool=null)}),{initial:!0,once:!0}))}));return function(e){return s.apply(this,arguments)}}());return i.task=s,i.abort=()=>s.abort(),this._startUserOperation=i,s.promise}));function i(){return e.apply(this,arguments)}return i}(),s.onConnectToAnalysisView=function(e){},s.onDisconnectFromAnalysisView=function(){},s._scheduleViewReconnect=function(){var e=this;this._reconnectViewTask=r.abortMaybe(this._reconnectViewTask);const i=n.createTask(function(){var s=t._asyncToGenerator((function*(t){try{yield e._reconnectView(t)}catch(s){if(a.throwIfAborted(t),!a.isAbortError(s))return void e.logger.warn("Failed to use analysis in view model",s);throw s}finally{i===e._reconnectViewTask&&(e._reconnectViewTask=null)}}));return function(e){return s.apply(this,arguments)}}());this._reconnectViewTask=i},s._reconnectView=function(){var e=t._asyncToGenerator((function*(e){const{view:t}=this,i=r.isSome(t)&&t.ready&&this.supported,s=this.analysis;if(this._startUserOperation=w(this._startUserOperation),this._disconnectFromView(t),i&&!r.isNone(t)&&!r.isNone(s)){if(this.isAnalysisOwner){if(r.isSome(s.parent))return void this.logger.errorOnce("expected owned analysis to have null parent when connecting to view");this._parentChangeFromReconnect=!0,t.analyses.add(s)}this.analysisView=yield t.whenAnalysisView(s),a.isAborted(e)?this._startUserOperation=w(this._startUserOperation):(this.analysisView.visible=this.visible,this._forceInteractiveHandle=this.analysisView.forceInteractiveForViewModel(),this.addHandles(this._forceInteractiveHandle),this.onConnectToAnalysisView(this.analysisView))}}));function i(t){return e.apply(this,arguments)}return i}(),s._disconnectFromView=function(e){r.isSome(e)&&this.isAnalysisOwner&&e.analyses.includes(this.analysis)&&(this._parentChangeFromReconnect=!0,this.analysis.clear(),e.analyses.remove(this.analysis)),this.onDisconnectFromAnalysisView(),this._forceInteractiveHandle=r.removeMaybe(this._forceInteractiveHandle),this.analysisView=null},s._setExternalAnalysis=function(e){r.isSome(this.analysisView)&&!this.isAnalysisOwner&&(this.analysisView.visible=void 0,this._forceInteractiveHandle=r.removeMaybe(this._forceInteractiveHandle)),this.analysisView=null,this._set("isAnalysisOwner",!1),this._set("analysis",e),this._parentChangeFromReconnect=!1},s._resetInteractiveCreationState=function(){this.analysis.clear(),r.isSome(this.tool)&&this.tool.resetCreated()},t._createClass(i,[{key:"supported",get:function(){return r.isNone(this.view)||this.view.type===this.supportedViewType}},{key:"visible",set:function(e){this._set("visible",e),r.isSome(this.analysisView)&&(this.analysisView.visible=e)}},{key:"active",get:function(){return r.isSome(this.tool)&&this.tool.active}},{key:"disabled",get:function(){return r.isNone(this.view)||!this.view.ready||!this.supported}},{key:"analysis",set:function(e){e!==this._get("analysis")&&(this._startUserOperation=r.abortMaybe(this._startUserOperation),this._disconnectFromView(this.view),this._setExternalAnalysis(e),this._scheduleViewReconnect())}},{key:"ready",get:function(){return r.isSome(this.analysisView)&&!this.connectingToView}},{key:"connectingToView",get:function(){return r.isSome(this._reconnectViewTask)}},{key:"isAnalysisOwner",get:function(){return this._get("isAnalysisOwner")}},{key:"tool",get:function(){return r.isSome(this.analysisView)?this.analysisView.tool:null}},{key:"testInfo",get:function(){return{analysisView:this.analysisView}}}]),i}(s),i.__decorate([c.property()],e.AnalysisViewModel.prototype,"supported",null),i.__decorate([c.property()],e.AnalysisViewModel.prototype,"view",void 0),i.__decorate([c.property({type:Boolean,value:!0})],e.AnalysisViewModel.prototype,"visible",null),i.__decorate([c.property()],e.AnalysisViewModel.prototype,"active",null),i.__decorate([c.property()],e.AnalysisViewModel.prototype,"disabled",null),i.__decorate([c.property({nonNullable:!0})],e.AnalysisViewModel.prototype,"analysis",null),i.__decorate([c.property()],e.AnalysisViewModel.prototype,"analysisView",void 0),i.__decorate([c.property()],e.AnalysisViewModel.prototype,"ready",null),i.__decorate([c.property()],e.AnalysisViewModel.prototype,"connectingToView",null),i.__decorate([c.property({readOnly:!0})],e.AnalysisViewModel.prototype,"isAnalysisOwner",null),i.__decorate([c.property()],e.AnalysisViewModel.prototype,"_reconnectViewTask",void 0),i.__decorate([c.property()],e.AnalysisViewModel.prototype,"_forceInteractiveHandle",void 0),i.__decorate([c.property()],e.AnalysisViewModel.prototype,"tool",null),e.AnalysisViewModel=i.__decorate([p.subclass("esri.widgets.support.AnalysisViewModel")],e.AnalysisViewModel),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
