/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/Accessor","../../core/Error","../../core/Handles","../../core/maybe","../../core/promiseUtils","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/arrayUtils","../../core/has","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass","../../views/interactive/interactiveToolUtils"],(function(e,t,o,i,s,n,r,a,l,c,h,d,u,p,y){"use strict";e.InteractiveToolViewModel=function(e){function o(t){var o;return(o=e.call(this,t)||this).analysis=null,o.tool=null,o._baseHandles=new n,o._loggedUnsupportedErrorOnce=!1,o._reconnectViewTask=null,o._isAnalysisOwner=!0,o._parentChangeFromReconnect=!1,o._toolCreationTask=null,t&&null!=t.visible&&(o.visible=t.visible),o}t._inheritsLoose(o,e);var i=o.prototype;return i.initialize=function(){this._baseHandles.add([l.react((()=>({ready:r.isSome(this.view)&&this.view.ready,supported:this.supported})),(({ready:e,supported:t})=>{!e||t||this._loggedUnsupportedErrorOnce||(this.logError(this.unsupportedErrorMessage),this._loggedUnsupportedErrorOnce=!0),this._scheduleViewReconnect()}),l.syncAndInitial),l.react((()=>r.isSome(this.analysis)?this.analysis.parent:null),(e=>{this._isAnalysisOwner&&r.isSome(e)&&e!==this.view&&(this._isAnalysisOwner=!1),this._parentChangeFromReconnect||this._scheduleViewReconnect()}),{sync:!0})])},i.destroy=function(){this.removeTool(),this._reconnectViewTask=r.abortMaybe(this._reconnectViewTask),this._disconnectFromView(this.view),this.view=null,this._baseHandles=r.destroyMaybe(this._baseHandles),this._isAnalysisOwner&&r.isSome(this.analysis)&&(this.analysis.destroy(),this._set("analysis",null))},i.onConnectToAnalysisView=function(e){},i.onDisconnectFromAnalysisView=function(){},i.createTool=function(){var e=t._asyncToGenerator((function*(){var e=this;const o="Tool creation was interrupted by another tool being created.";if(r.isSome(this.tool)&&this.tool.rejectCreation(o),this.removeTool(),r.isNone(this.view)||!this.supported)return Promise.reject(new s("tool:create","The view does not support the tool.",this.unsupportedErrorMessage));this._toolCreationTask=a.createTask(function(){var i=t._asyncToGenerator((function*(t){yield r.unwrap(e.view).whenReady(),a.throwIfAborted(t,o);const i=e.createToolParams(),s=y.evaluateToolConstructorArguments(i.constructorArguments);r.isSome(e.analysis)&&(s.analysis=e.analysis);const n=new i.toolConstructor({visible:e.visible,...s,view:e.view});return yield n.whenCreationStarted(),a.isAborted(t)&&n.rejectCreation(o),a.throwIfAborted(t,o),n}));return function(e){return i.apply(this,arguments)}}());const i=yield this._toolCreationTask.promise;this._set("tool",i),i.completed?this.view.tools.add(i):(this.view.addAndActivateTool(i),l.reactTruthy((()=>i.completed),(()=>{i.active&&r.isSome(this.view)&&(this.view.activeTool=null)}),{initial:!0,once:!0}))}));function o(){return e.apply(this,arguments)}return o}(),i.removeTool=function(){this._toolCreationTask=r.abortMaybe(this._toolCreationTask),r.isNone(this.tool)||(r.isSome(this.view)&&this.view.tools&&this.view.tools.remove(this.tool),this.tool.rejectCreation("Rejecting creation because tool is removed."),this.tool.destroyed||this.tool.destroy(),this._set("tool",null))},i._scheduleViewReconnect=function(){this._reconnectViewTask=r.abortMaybe(this._reconnectViewTask),this._reconnectViewTask=a.createTask((e=>this._reconnectView(e)))},i._reconnectView=function(){var e=t._asyncToGenerator((function*(e){const t=r.isSome(this.view)&&this.view.ready&&this.supported;if(a.isAborted(e))return;if(this._disconnectFromView(this.view),!t||r.isNone(this.view))return;const o=this.view;if(r.isSome(this.analysis)){if(this._isAnalysisOwner){if(r.isSome(this.analysis.parent))return void this.logError("expected owned analysis to have null parent when connecting to view");this._parentChangeFromReconnect=!0,o.analyses.add(this.analysis),this._parentChangeFromReconnect=!1}const t=yield o.whenAnalysisView(this.analysis);if(a.isAborted(e))return void this._disconnectFromView(o);if(r.isNone(t))return void this.logError("Unable to retrieve analysis view for analysis. Analysis may not be part of the scene.");this.onConnectToAnalysisView(t)}}));function o(t){return e.apply(this,arguments)}return o}(),i._disconnectFromView=function(e){r.isSome(this.analysis)&&(r.isSome(e)&&this._isAnalysisOwner&&(this._parentChangeFromReconnect=!0,e.analyses.remove(this.analysis),this._parentChangeFromReconnect=!1),this.onDisconnectFromAnalysisView())},i.logError=function(...e){this.logger.error(...e)},t._createClass(o,[{key:"supported",get:function(){return r.isNone(this.view)||this.view.type===this.supportedViewType}},{key:"view",get:function(){return this._get("view")},set:function(e){if(e===this.view)return;this._disconnectFromView(this.view),this.removeTool(),this._set("view",e);const t="tools";this._baseHandles.remove(t),r.isNone(e)||this._baseHandles.add(e.tools.on("change",(e=>{if(this.tool)for(const t of e.removed)if(this.tool===t){t.destroyed||t.destroy(),this._set("tool",null);break}})),t)}},{key:"visible",set:function(e){this._set("visible",e),r.isSome(this.tool)&&(this.tool.visible=e),e||(this._toolCreationTask=r.abortMaybe(this._toolCreationTask))}},{key:"active",get:function(){return r.isSome(this._toolCreationTask)&&!this._toolCreationTask.finished||r.isSome(this.tool)&&this.tool.active}},{key:"disabled",get:function(){return r.isNone(this.view)||!this.view.ready||!this.supported}},{key:"creatingTool",get:function(){return r.isSome(this._toolCreationTask)&&!this._toolCreationTask.finished}}]),o}(i),o.__decorate([c.property({constructOnly:!0})],e.InteractiveToolViewModel.prototype,"analysis",void 0),o.__decorate([c.property({constructOnly:!0})],e.InteractiveToolViewModel.prototype,"tool",void 0),o.__decorate([c.property()],e.InteractiveToolViewModel.prototype,"supported",null),o.__decorate([c.property({value:null})],e.InteractiveToolViewModel.prototype,"view",null),o.__decorate([c.property({type:Boolean,value:!0})],e.InteractiveToolViewModel.prototype,"visible",null),o.__decorate([c.property()],e.InteractiveToolViewModel.prototype,"active",null),o.__decorate([c.property()],e.InteractiveToolViewModel.prototype,"disabled",null),o.__decorate([c.property()],e.InteractiveToolViewModel.prototype,"_toolCreationTask",void 0),o.__decorate([c.property({readOnly:!0})],e.InteractiveToolViewModel.prototype,"creatingTool",null),e.InteractiveToolViewModel=o.__decorate([p.subclass("esri.widgets.support.InteractiveToolViewModel")],e.InteractiveToolViewModel),Object.defineProperty(e,"__esModule",{value:!0})}));
