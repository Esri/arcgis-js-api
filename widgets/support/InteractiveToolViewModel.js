/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/Accessor","../../core/Error","../../core/Handles","../../core/maybe","../../core/promiseUtils","../../core/watchUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/accessorSupport/ensureType","../../core/Logger","../../core/accessorSupport/decorators/subclass","../../views/interactive/interactiveToolUtils"],(function(e,o,t,r,i,s,n,l,a,c,d,u,p,h,v){"use strict";e.InteractiveToolViewModel=function(e){function t(o){var t;return(t=e.call(this,o)||this).tool=null,t._baseHandles=new s,t._loggedUnsupportedErrorOnce=!1,t._toolCreationTask=null,o&&null!=o.visible&&(t.visible=o.visible),t}o._inheritsLoose(t,e);var r=t.prototype;return r.initialize=function(){this._baseHandles.add(a.init(this,["view.ready","isSupported"],(()=>{!(this.view&&this.view.ready)||this.supported||this._loggedUnsupportedErrorOnce||(this.logError(this.unsupportedErrorMessage),this._loggedUnsupportedErrorOnce=!0)})))},r.destroy=function(){this.removeTool(),this.view=null,this._baseHandles=n.destroyMaybe(this._baseHandles)},r.createTool=function(){var e=o._asyncToGenerator((function*(){var e=this;const t="Tool creation was interrupted by another tool being created.";if(n.isSome(this.tool)&&this.tool.rejectCreation(t),this.removeTool(),!this.supported)return Promise.reject(new i("tool:create","The view does not support the tool.",this.unsupportedErrorMessage));this._toolCreationTask=l.createTask(function(){var r=o._asyncToGenerator((function*(o){yield e.view.whenReady(),l.throwIfAborted(o,t);const r=e.createToolParams(),i=v.evaluateToolConstructorArguments(r.constructorArguments),s=new r.toolConstructor({visible:e.visible,...i,view:e.view});return yield s.whenCreationStarted(),l.isAborted(o)&&s.rejectCreation(t),l.throwIfAborted(o,t),s}));return function(e){return r.apply(this,arguments)}}());const r=yield this._toolCreationTask.promise;this._set("tool",r),this.view.addAndActivateTool(r),a.whenOnce(r,"completed").then((()=>{r.active&&(this.view.activeTool=null)}))}));function t(){return e.apply(this,arguments)}return t}(),r.removeTool=function(){this._toolCreationTask=n.abortMaybe(this._toolCreationTask),n.isNone(this.tool)||(this.view&&this.view.tools&&this.view.tools.remove(this.tool),this.tool.rejectCreation("Rejecting creation because tool is removed."),this.tool.destroyed||this.tool.destroy(),this._set("tool",null))},r.logError=function(...e){this.logger.error(...e)},o._createClass(t,[{key:"supported",get:function(){return!this.view||this.view.type===this.supportedViewType}},{key:"view",get:function(){return this._get("view")},set:function(e){if(e===this.view)return;this.removeTool(),this._set("view",e);const o="tools";this._baseHandles.remove(o),e&&this._baseHandles.add(e.tools.on("change",(e=>{if(this.tool)for(const o of e.removed)if(this.tool===o){o.destroyed||o.destroy(),this._set("tool",null);break}})),o)}},{key:"visible",set:function(e){this._set("visible",e),n.isSome(this.tool)&&(this.tool.visible=e),e||(this._toolCreationTask=n.abortMaybe(this._toolCreationTask))}},{key:"active",get:function(){return n.isSome(this._toolCreationTask)||n.isSome(this.tool)&&this.tool.active}},{key:"disabled",get:function(){return!this.view||!this.view.ready||!this.supported}},{key:"creatingTool",get:function(){return n.isSome(this._toolCreationTask)}}]),t}(r),t.__decorate([c.property({constructOnly:!0})],e.InteractiveToolViewModel.prototype,"tool",void 0),t.__decorate([c.property()],e.InteractiveToolViewModel.prototype,"supported",null),t.__decorate([c.property({value:null})],e.InteractiveToolViewModel.prototype,"view",null),t.__decorate([c.property({type:Boolean,value:!0})],e.InteractiveToolViewModel.prototype,"visible",null),t.__decorate([c.property()],e.InteractiveToolViewModel.prototype,"active",null),t.__decorate([c.property()],e.InteractiveToolViewModel.prototype,"disabled",null),t.__decorate([c.property()],e.InteractiveToolViewModel.prototype,"_toolCreationTask",void 0),t.__decorate([c.property({readOnly:!0})],e.InteractiveToolViewModel.prototype,"creatingTool",null),e.InteractiveToolViewModel=t.__decorate([h.subclass("esri.widgets.support.InteractiveToolViewModel")],e.InteractiveToolViewModel),Object.defineProperty(e,"__esModule",{value:!0})}));
