/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/asyncUtils","../../core/Handles","../../core/maybe","../../core/promiseUtils","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/arrayUtils","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass","./InteractiveToolViewModel"],(function(e,s,t,i,n,a,r,o,l,c,y,h,u){"use strict";var w;function _(e){return a.isSome(e)&&e.state>=w.RUNNING?(e.abort(),null):e}!function(e){e[e.PENDING=0]="PENDING",e[e.WAIT_FOR_VIEW_READY=1]="WAIT_FOR_VIEW_READY",e[e.RUNNING=2]="RUNNING"}(w||(w={})),e.InteractiveAnalysisViewModel=function(e){function t(s={}){var t;(t=e.call(this,s)||this).analysisView=null,t._reconnectViewTask=null,t._analysisBaseHandles=new n,t._parentChangeFromReconnect=!1,t._startUserOperation=null;const i=s?.analysis;return a.isSome(i)?t.analysis=i:(t._set("analysis",t.constructAnalysis()),t._set("isAnalysisOwner",!0)),t}s._inheritsLoose(t,e);var l=t.prototype;return l.normalizeCtorArgs=function(e){const{analysis:s,...t}=e;return t},l.initialize=function(){this._analysisBaseHandles.add([o.watch((()=>a.applySome(this.analysis,(({parent:e})=>e))),(e=>{this._parentChangeFromReconnect||e===this.view||this._set("isAnalysisOwner",!1);const s=!this._parentChangeFromReconnect;this._parentChangeFromReconnect=!1,s&&this._scheduleViewReconnect()}),o.sync),o.watch((()=>({view:this.view,ready:a.isSome(this.view)&&this.view.ready,supported:this.supported})),(({view:e},{view:s})=>{e!==s&&(this._startUserOperation=a.abortMaybe(this._startUserOperation),this._disconnectFromView(s)),this._scheduleViewReconnect()}),o.syncAndInitial),o.watch((()=>this.analysis.isEditable),((e,s)=>{a.isNone(this.analysisView)||(e&&!s&&a.isNone(this.tool)?this.createTool():!e&&s&&a.isSome(this.tool)&&!this.tool.active&&this.removeTool())}))])},l.destroy=function(){this._analysisBaseHandles=a.destroyMaybe(this._analysisBaseHandles),this._reconnectViewTask=a.abortMaybe(this._reconnectViewTask),this._startUserOperation=a.abortMaybe(this._startUserOperation),a.isSome(this.analysisView)&&(this.analysisView.visible=void 0),this._disconnectFromView(this.view),a.isSome(this.analysis)&&this.isAnalysisOwner&&(this.analysis.destroy(),this._set("analysis",null))},l.start=function(){var e=s._asyncToGenerator((function*(){var e=this;this.clear();const t={task:null,abort:null,state:w.PENDING},n=i.createTask(function(){var i=s._asyncToGenerator((function*(s){t.state=w.WAIT_FOR_VIEW_READY,yield o.whenOnce((()=>e.ready),s),t.state=w.RUNNING,e.createTool({interactive:!0})}));return function(e){return i.apply(this,arguments)}}());return t.task=n,t.abort=()=>n.abort(),this._startUserOperation=t,n.promise}));function t(){return e.apply(this,arguments)}return t}(),l.clear=function(){this._startUserOperation=a.abortMaybe(this._startUserOperation),this.removeTool(),this.analysis.clear()},l.onConnectToAnalysisView=function(e){},l.onDisconnectFromAnalysisView=function(){},l._scheduleViewReconnect=function(){var e=this;this._reconnectViewTask=a.abortMaybe(this._reconnectViewTask);const t=i.createTask(function(){var i=s._asyncToGenerator((function*(s){try{yield e._reconnectView(s)}catch(i){if(r.throwIfAborted(s),!r.isAbortError(i))return void e.logger.warn("Failed to use analysis in view model",i);throw i}finally{t===e._reconnectViewTask&&(e._reconnectViewTask=null)}}));return function(e){return i.apply(this,arguments)}}());this._reconnectViewTask=t},l._reconnectView=function(){var e=s._asyncToGenerator((function*(e){const{view:s}=this,t=a.isSome(s)&&s.ready&&this.supported,i=this.analysis;if(this._startUserOperation=_(this._startUserOperation),this._disconnectFromView(s),t&&!a.isNone(s)&&!a.isNone(i)){if(this.isAnalysisOwner){if(a.isSome(i.parent))return void this.logError("expected owned analysis to have null parent when connecting to view");this._parentChangeFromReconnect=!0,s.analyses.add(i)}this.analysisView=yield s.whenAnalysisView(i),r.isAborted(e)?this._startUserOperation=_(this._startUserOperation):(this.analysisView.visible=this.visible,this.onConnectToAnalysisView(this.analysisView),this.createTool())}}));function t(s){return e.apply(this,arguments)}return t}(),l._disconnectFromView=function(e){this.removeTool(),a.isSome(e)&&this.isAnalysisOwner&&(this._parentChangeFromReconnect=!0,e.analyses.remove(this.analysis),this.analysis.clear()),this.analysisView=null,this.onDisconnectFromAnalysisView()},l._setExternalAnalysis=function(e){a.isSome(this.analysisView)&&!this.isAnalysisOwner&&(this.analysisView.visible=!0),this.analysisView=null,this._set("isAnalysisOwner",!1),this._set("analysis",e),this._parentChangeFromReconnect=!1},s._createClass(t,[{key:"analysis",set:function(e){e!==this._get("analysis")&&(this._startUserOperation=a.abortMaybe(this._startUserOperation),this._disconnectFromView(this.view),this._setExternalAnalysis(e),this._scheduleViewReconnect())}},{key:"ready",get:function(){return a.isSome(this.analysisView)&&!this.connectingToView}},{key:"connectingToView",get:function(){return a.isSome(this._reconnectViewTask)}},{key:"isAnalysisOwner",get:function(){return this._get("isAnalysisOwner")}},{key:"visible",set:function(e){this._set("visible",e),a.isSome(this.analysisView)&&(this.analysisView.visible=e)}},{key:"testInfo",get:function(){return{analysisView:this.analysisView}}}]),t}(u.InteractiveToolViewModel),t.__decorate([l.property({nonNullable:!0})],e.InteractiveAnalysisViewModel.prototype,"analysis",null),t.__decorate([l.property()],e.InteractiveAnalysisViewModel.prototype,"analysisView",void 0),t.__decorate([l.property()],e.InteractiveAnalysisViewModel.prototype,"ready",null),t.__decorate([l.property()],e.InteractiveAnalysisViewModel.prototype,"connectingToView",null),t.__decorate([l.property({readOnly:!0})],e.InteractiveAnalysisViewModel.prototype,"isAnalysisOwner",null),t.__decorate([l.property({type:Boolean,value:!0})],e.InteractiveAnalysisViewModel.prototype,"visible",null),t.__decorate([l.property()],e.InteractiveAnalysisViewModel.prototype,"_reconnectViewTask",void 0),e.InteractiveAnalysisViewModel=t.__decorate([h.subclass("esri.widgets.support.InteractiveAnalysisViewModel")],e.InteractiveAnalysisViewModel),Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
