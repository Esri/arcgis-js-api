/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/Handles","../../core/maybe","../../core/promiseUtils","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/arrayUtils","../../core/has","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass","./InteractiveToolViewModel"],(function(e,s,i,n,t,a,o,r,l,c,y,h,w){"use strict";e.InteractiveAnalysisViewModel=function(e){function i(s={}){var i;(i=e.call(this,s)||this).analysisView=null,i._reconnectViewTask=null,i._analysisBaseHandles=new n,i._parentChangeFromReconnect=!1;const a=null==s?void 0:s.analysis;return t.isSome(a)?i.analysis=a:(i._set("analysis",i.constructAnalysis()),i._set("isAnalysisOwner",!0)),i}s._inheritsLoose(i,e);var r=i.prototype;return r.normalizeCtorArgs=function(e){const{analysis:s,...i}=e;return i},r.initialize=function(){this._analysisBaseHandles.add([o.watch((()=>({analysis:this.analysis,parent:t.applySome(this.analysis,(({parent:e})=>e))})),(({parent:e})=>{this._parentChangeFromReconnect||e===this.view||this._set("isAnalysisOwner",!1);const s=!this._parentChangeFromReconnect;this._parentChangeFromReconnect=!1,s&&this._scheduleViewReconnect()})),o.watch((()=>({view:this.view,ready:t.isSome(this.view)&&this.view.ready,supported:this.supported})),(({view:e},{view:s})=>{e!==s&&this._disconnectFromView(s),this._scheduleViewReconnect()}),o.syncAndInitial),o.watch((()=>this.analysis.isEditable),((e,s)=>{t.isNone(this.analysisView)||(e&&!s&&t.isNone(this.tool)?this.createTool():!e&&s&&t.isSome(this.tool)&&!this.tool.active&&this.removeTool())}))]),this.analysis.visible=this.visible},r.destroy=function(){this._analysisBaseHandles=t.destroyMaybe(this._analysisBaseHandles),this._reconnectViewTask=t.abortMaybe(this._reconnectViewTask),this._disconnectFromView(this.view),t.isSome(this.analysis)&&(this.isAnalysisOwner?(this.analysis.destroy(),this._set("analysis",null)):this.analysis.visible=!0)},r.start=function(){var e=s._asyncToGenerator((function*(){this.clear(),this.ready||(yield o.whenOnce((()=>this.ready))),this.createTool({interactive:!0})}));function i(){return e.apply(this,arguments)}return i}(),r.onConnectToAnalysisView=function(e){},r.onDisconnectFromAnalysisView=function(){},r._scheduleViewReconnect=function(){var e=this;this._reconnectViewTask=t.abortMaybe(this._reconnectViewTask);const i=a.createTask(function(){var n=s._asyncToGenerator((function*(s){try{yield e._reconnectView(s)}catch(n){if(a.throwIfAborted(s),!a.isAbortError(n))return void e.logger.warn("Failed to use analysis in view model",n);throw n}finally{i===e._reconnectViewTask&&(e._reconnectViewTask=null)}}));return function(e){return n.apply(this,arguments)}}());this._reconnectViewTask=i},r._reconnectView=function(){var e=s._asyncToGenerator((function*(e){const{view:s}=this,i=t.isSome(s)&&s.ready&&this.supported,n=this.analysis;if(this._disconnectFromView(s),i&&!t.isNone(s)&&!t.isNone(n)){if(this.isAnalysisOwner){if(t.isSome(n.parent))return void this.logError("expected owned analysis to have null parent when connecting to view");this._parentChangeFromReconnect=!0,s.analyses.add(n)}this.analysisView=yield s.whenAnalysisView(n),a.isAborted(e)?this._disconnectFromView(s):(this.onConnectToAnalysisView(this.analysisView),!this.analysis.visible&&this.isAnalysisOwner||this.createTool())}}));function i(s){return e.apply(this,arguments)}return i}(),r._disconnectFromView=function(e){t.isSome(e)&&this.isAnalysisOwner&&(this._parentChangeFromReconnect=!0,e.analyses.remove(this.analysis)),this.analysisView=null,this.onDisconnectFromAnalysisView(),this.removeTool()},r._setExternalAnalysis=function(e){if(t.isSome(this.analysis)&&!this.isAnalysisOwner&&(this.analysis.visible=!0),this._set("analysis",e),this._set("isAnalysisOwner",!1),this._parentChangeFromReconnect=!1,!e.isEditable){const s=e.nonEditableMessage;this.logger.warn(`The assigned ${e.type} analysis object will not be editable in the view. ${s}`)}},s._createClass(i,[{key:"analysis",set:function(e){e!==this._get("analysis")&&(this._disconnectFromView(this.view),this._setExternalAnalysis(e),this._scheduleViewReconnect())}},{key:"ready",get:function(){return t.isSome(this.analysisView)&&!this.connectingToView}},{key:"connectingToView",get:function(){return t.isSome(this._reconnectViewTask)}},{key:"isAnalysisOwner",get:function(){return this._get("isAnalysisOwner")}}]),i}(w.InteractiveToolViewModel),i.__decorate([r.property({nonNullable:!0})],e.InteractiveAnalysisViewModel.prototype,"analysis",null),i.__decorate([r.property()],e.InteractiveAnalysisViewModel.prototype,"analysisView",void 0),i.__decorate([r.property()],e.InteractiveAnalysisViewModel.prototype,"ready",null),i.__decorate([r.property()],e.InteractiveAnalysisViewModel.prototype,"connectingToView",null),i.__decorate([r.property({readOnly:!0})],e.InteractiveAnalysisViewModel.prototype,"isAnalysisOwner",null),i.__decorate([r.property()],e.InteractiveAnalysisViewModel.prototype,"_reconnectViewTask",void 0),e.InteractiveAnalysisViewModel=i.__decorate([h.subclass("esri.widgets.support.InteractiveAnalysisViewModel")],e.InteractiveAnalysisViewModel),Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
