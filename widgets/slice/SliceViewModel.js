/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/Collection","../../core/collectionUtils","../../core/Handles","../../core/Logger","../../core/maybe","../../core/promiseUtils","../../core/watchUtils","../../core/accessorSupport/decorators/aliasOf","../../core/has","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/subclass","../../layers/SliceLayer","../../views/3d/interactive/analysisTools/slice/SliceTool","../support/InteractiveToolViewModel"],(function(e,t,o,r,i,s,l,a,c,n,d,u,h,y,p,w,f){"use strict";const _=s.getLogger("esri.widgets.Slice.SliceViewModel"),m=new Set;let S=function(t){function s(o){var r;return(r=t.call(this,o)||this).layerView=null,r.supportedViewType="3d",r.handles=new i,r.model=new p({listMode:"hide"}),r.shape=null,r.tiltEnabled=!1,r.ready=!1,m.add(e._assertThisInitialized(r)),r}e._inheritsLoose(s,t);var n=s.prototype;return n.initialize=function(){this.handles.add(this.watch("shape",((e,t)=>{l.isNone(t)&&l.isSome(e)?this.tool||this.creatingTool||this.createTool():l.isSome(t)&&l.isNone(e)&&this.tool&&this.removeTool()}),!0)),this.handles.add(this.watch("tiltEnabled",(e=>this._updateToolOrRecreate((t=>t.tiltEnabled=e))),!0)),this.handles.add(this.watch("view",(e=>{this._disconnectFromView(),this._connectToView(e)}),!0)),this._connectToView(this.view)},n.destroy=function(){this._disconnectFromView(),m.delete(this),this.handles.destroy()},n.start=function(){var t=e._asyncToGenerator((function*(){this.removeTool(),this.ready||(yield c.whenTrueOnce(this,"ready")),m.forEach((e=>{e.view===this.view&&e!==this&&e.clear()})),yield this.createTool()}));function o(){return t.apply(this,arguments)}return o}(),n.clear=function(){this.removeTool(),this.excludeGroundSurface=!1,this.excludedLayers=new o},n.removeSliceAndStart=function(){return this.removeTool(),this.shape=null,this.start()},n.enterExcludeLayerMode=function(){this.tool&&this.tool.enterExcludeLayerMode()},n.exitExcludeLayerMode=function(){this.tool&&this.tool.exitExcludeLayerMode()},n._updateToolOrRecreate=function(e){this.tool?e(this.tool):this.creatingTool&&a.ignoreAbortErrors(this.createTool())},n.createToolParams=function(){return{toolConstructor:w,constructorArguments:()=>({tiltEnabled:this.tiltEnabled,analysis:this.model})}},n.logUnsupportedError=function(){this.logError("Slice widget is not implemented for MapView")},n.logError=function(...e){_.error(...e)},n._connectToView=function(e){if(!l.isNone(e)&&(e.map.layers.includes(this.model)||e.map.layers.add(this.model),"3d"===e.type)){const t=e;t.whenLayerView(this.model).then((e=>{this.destroyed||t!==this.view||(e.layerViewData.excludeGroundSurface=this.excludeGroundSurface,e.layerViewData.excludedLayers=this.excludedLayers,this.layerView=e,this.ready=!0)}))}},n._disconnectFromView=function(){null!=this.view&&(this.view.map.remove(this.model),this.layerView=null)},e._createClass(s,[{key:"state",get:function(){return this.isDisabled||!this.ready?"disabled":this.tool&&"pending"!==this.tool.toolState?this.tool.state:"ready"}},{key:"excludedLayers",get:function(){return l.isSome(this.layerView)?this.layerView.layerViewData.excludedLayers:this._get("excludedLayers")||new o},set:function(e){this._set("excludedLayers",r.referenceSetter(e,this.excludedLayers)),l.isSome(this.layerView)&&(this.layerView.layerViewData.excludedLayers=e)}},{key:"excludeGroundSurface",get:function(){return l.isSome(this.layerView)?this.layerView.layerViewData.excludeGroundSurface:this._get("excludeGroundSurface")||!1},set:function(e){this._set("excludeGroundSurface",e),l.isSome(this.layerView)&&(this.layerView.layerViewData.excludeGroundSurface=e)}}]),s}(f.InteractiveToolViewModel);return t.__decorate([h.property()],S.prototype,"layerView",void 0),t.__decorate([h.property({readOnly:!0})],S.prototype,"state",null),t.__decorate([h.property()],S.prototype,"tool",void 0),t.__decorate([h.property()],S.prototype,"model",void 0),t.__decorate([h.property({aliasOf:"model.plane"})],S.prototype,"shape",void 0),t.__decorate([h.property({aliasOf:"model.tiltEnabled"})],S.prototype,"tiltEnabled",void 0),t.__decorate([n.aliasOf("tool.layersMode")],S.prototype,"layersMode",void 0),t.__decorate([h.property({cast:r.castForReferenceSetter})],S.prototype,"excludedLayers",null),t.__decorate([h.property({nonNullable:!0})],S.prototype,"excludeGroundSurface",null),t.__decorate([h.property()],S.prototype,"ready",void 0),S=t.__decorate([y.subclass("esri.widgets.slice.SliceViewModel")],S),S}));
