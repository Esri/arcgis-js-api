/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/Collection","../../core/collectionUtils","../../core/Handles","../../core/Logger","../../core/maybe","../../core/promiseUtils","../../core/reactiveUtils","../../core/watchUtils","../../core/accessorSupport/decorators/aliasOf","../../core/has","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/subclass","../../layers/SliceLayer","../../views/3d/interactive/analysisTools/slice/SliceTool","../support/InteractiveToolViewModel"],(function(e,t,o,i,r,s,a,l,n,c,d,u,h,y,p,w,f,_){"use strict";const m=s.getLogger("esri.widgets.Slice.SliceViewModel"),S=new Set;let v=function(t){function s(o){var i;return(i=t.call(this,o)||this).layerView=null,i.logger=m,i.supportedViewType="3d",i.unsupportedErrorMessage="SliceViewModel is only supported in 3D views.",i.handles=new r,i.model=new w({listMode:"hide"}),i.shape=null,i.tiltEnabled=!1,i.ready=!1,S.add(e._assertThisInitialized(i)),i}e._inheritsLoose(s,t);var d=s.prototype;return d.initialize=function(){this.handles.add(this.watch("shape",((e,t)=>{a.isNone(t)&&a.isSome(e)?a.isNone(this.tool)&&!this.creatingTool&&this.createTool():a.isSome(t)&&a.isNone(e)&&this.removeTool()}),!0)),this.handles.add(this.watch("tiltEnabled",(e=>this._updateToolOrRecreate((t=>t.tiltEnabled=e))),!0)),this.handles.add(n.react((()=>({view:this.view,ready:a.isSome(this.view)&&this.view.ready})),(({view:e})=>{this._disconnectFromView(),this._connectToView(e)}),{sync:!0})),this._connectToView(this.view)},d.destroy=function(){this._disconnectFromView(),S.delete(this),this.handles=a.destroyMaybe(this.handles)},d.start=function(){var t=e._asyncToGenerator((function*(){return this.removeTool(),this.ready||(yield c.whenTrueOnce(this,"ready")),S.forEach((e=>{e.view===this.view&&e!==this&&e.clear()})),this.createTool()}));function o(){return t.apply(this,arguments)}return o}(),d.clear=function(){this.removeTool(),this.excludeGroundSurface=!1,this.excludedLayers=new o},d.removeSliceAndStart=function(){return this.removeTool(),this.shape=null,this.start()},d.enterExcludeLayerMode=function(){a.isSome(this.tool)&&this.tool.enterExcludeLayerMode()},d.exitExcludeLayerMode=function(){a.isSome(this.tool)&&this.tool.exitExcludeLayerMode()},d._updateToolOrRecreate=function(e){a.isSome(this.tool)?e(this.tool):this.creatingTool&&l.ignoreAbortErrors(this.createTool())},d.createToolParams=function(){return{toolConstructor:f,constructorArguments:()=>({tiltEnabled:this.tiltEnabled,analysis:this.model})}},d._connectToView=function(e){if(!a.isNone(e)&&e.ready&&(e.map.layers.includes(this.model)||e.map.layers.add(this.model),"3d"===e.type)){const t=e;t.whenLayerView(this.model).then((e=>{this.destroyed||t!==this.view||(e.layerViewData.excludeGroundSurface=this.excludeGroundSurface,e.layerViewData.excludedLayers=this.excludedLayers,this.layerView=e,this.ready=!0)}))}},d._disconnectFromView=function(){this.ready=!1,null!=this.view&&(this.view.map.remove(this.model),this.layerView=null)},e._createClass(s,[{key:"state",get:function(){return this.disabled||!this.ready?"disabled":a.isNone(this.tool)||"pending"===this.tool.toolState?"ready":this.tool.state}},{key:"excludedLayers",get:function(){return a.isSome(this.layerView)?this.layerView.layerViewData.excludedLayers:this._get("excludedLayers")||new o},set:function(e){this._set("excludedLayers",i.referenceSetter(e,this.excludedLayers)),a.isSome(this.layerView)&&(this.layerView.layerViewData.excludedLayers=e)}},{key:"excludeGroundSurface",get:function(){return a.isSome(this.layerView)?this.layerView.layerViewData.excludeGroundSurface:this._get("excludeGroundSurface")||!1},set:function(e){this._set("excludeGroundSurface",e),a.isSome(this.layerView)&&(this.layerView.layerViewData.excludeGroundSurface=e)}}]),s}(_.InteractiveToolViewModel);return t.__decorate([y.property()],v.prototype,"layerView",void 0),t.__decorate([y.property({readOnly:!0})],v.prototype,"state",null),t.__decorate([y.property()],v.prototype,"model",void 0),t.__decorate([y.property({aliasOf:"model.plane"})],v.prototype,"shape",void 0),t.__decorate([y.property({aliasOf:"model.tiltEnabled"})],v.prototype,"tiltEnabled",void 0),t.__decorate([d.aliasOf("tool.layersMode")],v.prototype,"layersMode",void 0),t.__decorate([y.property({cast:i.castForReferenceSetter})],v.prototype,"excludedLayers",null),t.__decorate([y.property({nonNullable:!0})],v.prototype,"excludeGroundSurface",null),t.__decorate([y.property()],v.prototype,"ready",void 0),v=t.__decorate([p.subclass("esri.widgets.slice.SliceViewModel")],v),v}));
