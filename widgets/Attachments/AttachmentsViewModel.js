// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../Graphic","../../core/Collection","../../core/Error","../../core/HandleOwner","../../core/maybe","../../core/watchUtils","../../core/accessorSupport/decorators","../../layers/support/AttachmentInfo","../../tasks/support/AttachmentQuery","../Feature/support/featureUtils"],(function(t,e,a,n,r,i,o,c,s,h,d,u,p){"use strict";var l={editing:!1,operations:{add:!0,update:!0,delete:!0}},m=r.ofType(d);return function(t){function e(e){var n=t.call(this,e)||this;return n._getAttachmentsPromise=null,n._attachmentLayer=null,n.abilities=a.__assign({},l),n.activeAttachmentInfo=null,n.attachmentInfos=new m,n.graphic=null,n.mode="view",n.handles.add([s.init(n,"graphic",(function(){return n._graphicChanged()}))]),n}return a.__extends(e,t),e.prototype.destroy=function(){this._attachmentLayer=null,this.graphic=null},e.prototype.castAbilities=function(t){return a.__assign(a.__assign({},l),t)},Object.defineProperty(e.prototype,"state",{get:function(){return this._getAttachmentsPromise?"loading":this.graphic?"ready":"disabled"},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"supportsResizeAttachments",{get:function(){return this.get("graphic.layer.capabilities.operations.supportsResizeAttachments")||!1},enumerable:!1,configurable:!0}),e.prototype.getAttachments=function(){return a.__awaiter(this,void 0,void 0,(function(){var t,e,n,r,o,c,s,h;return a.__generator(this,(function(a){switch(a.label){case 0:if(e=(t=this)._attachmentLayer,n=t.attachmentInfos,!e||"function"!=typeof e.queryAttachments)throw new i("invalid-layer","getAttachments(): A valid layer is required.");return r=this._getFeatureId(),o=new u({objectIds:[r],returnMetadata:!0}),c=[],s=e.queryAttachments(o).then((function(t){return t[r]||c})).catch((function(){return c})),this._getAttachmentsPromise=s,this.notifyChange("state"),[4,s];case 1:return h=a.sent(),n.removeAll(),h.length&&n.addMany(h),this._getAttachmentsPromise=null,this.notifyChange("state"),[2,h]}}))}))},e.prototype.addAttachment=function(t){return a.__awaiter(this,void 0,void 0,(function(){var e,n,r,o,c,s,h=this;return a.__generator(this,(function(a){switch(a.label){case 0:if(n=(e=this)._attachmentLayer,r=e.attachmentInfos,o=e.graphic,c=e.abilities,!t)throw new i("invalid-attachment","addAttachment(): An attachment is required.",{attachment:t});if(!c.operations.add)throw new i("invalid-abilities","addAttachment(): add abilities are required.");if(!n||"function"!=typeof n.addAttachment)throw new i("invalid-layer","addAttachment(): A valid layer is required.");return[4,n.addAttachment(o,t).then((function(t){return h._queryAttachment(t.objectId)}))];case 1:return s=a.sent(),r.add(s),[2,s]}}))}))},e.prototype.deleteAttachment=function(t){return a.__awaiter(this,void 0,void 0,(function(){var e,n,r,o,c,s;return a.__generator(this,(function(a){switch(a.label){case 0:if(n=(e=this)._attachmentLayer,r=e.attachmentInfos,o=e.graphic,c=e.abilities,!t)throw new i("invalid-attachment-info","deleteAttachment(): An attachmentInfo is required.",{attachmentInfo:t});if(!c.operations.delete)throw new i("invalid-abilities","deleteAttachment(): delete abilities are required.");if(!n||"function"!=typeof n.deleteAttachments)throw new i("invalid-layer","deleteAttachment(): A valid layer is required.");return[4,n.deleteAttachments(o,[t.id]).then((function(){return t}))];case 1:return s=a.sent(),r.remove(s),[2,s]}}))}))},e.prototype.updateAttachment=function(t,e){return void 0===e&&(e=this.activeAttachmentInfo),a.__awaiter(this,void 0,void 0,(function(){var n,r,o,c,s,h,d,u=this;return a.__generator(this,(function(a){switch(a.label){case 0:if(r=(n=this)._attachmentLayer,o=n.attachmentInfos,c=n.graphic,s=n.abilities,!t)throw new i("invalid-attachment","updateAttachment(): An attachment is required.",{attachment:t});if(!e)throw new i("invalid-attachment-info","updateAttachment(): An attachmentInfo is required.",{attachmentInfo:e});if(!s.operations.update)throw new i("invalid-abilities","updateAttachment(): Update abilities are required.");if(h=o.findIndex((function(t){return t===e})),!r||"function"!=typeof r.updateAttachment)throw new i("invalid-layer","updateAttachment(): A valid layer is required.");return[4,r.updateAttachment(c,e.id,t).then((function(t){return u._queryAttachment(t.objectId)}))];case 1:return d=a.sent(),o.splice(h,1,d),[2,d]}}))}))},e.prototype._queryAttachment=function(t){return a.__awaiter(this,void 0,void 0,(function(){var e,n,r;return a.__generator(this,(function(a){if(!t)throw new i("invalid-attachment-id","Could not query attachment.");return e=this._attachmentLayer,n=this._getFeatureId(),r=new u({objectIds:[n],attachmentsWhere:"AttachmentId="+t,returnMetadata:!0}),[2,e.queryAttachments(r).then((function(t){return t[n][0]}))]}))}))},e.prototype._getFeatureId=function(){var t=this._attachmentLayer,e=this.graphic;if(!t||!e)return null;var a=t.objectIdField,n=e.attributes;return n&&n[a]},e.prototype._graphicChanged=function(){this.graphic&&(this._setAttachmentLayer(),this.getAttachments().catch((function(){})))},e.prototype._setAttachmentLayer=function(){var t=this.graphic,e=p.getSourceLayer(t);this._attachmentLayer=e?"scene"===e.type&&c.isSome(e.associatedLayer)?e.associatedLayer:e:null},a.__decorate([h.property()],e.prototype,"abilities",void 0),a.__decorate([h.cast("abilities")],e.prototype,"castAbilities",null),a.__decorate([h.property()],e.prototype,"activeAttachmentInfo",void 0),a.__decorate([h.property({readOnly:!0,type:m})],e.prototype,"attachmentInfos",void 0),a.__decorate([h.property({type:n})],e.prototype,"graphic",void 0),a.__decorate([h.property()],e.prototype,"mode",void 0),a.__decorate([h.property({dependsOn:["graphic"],readOnly:!0})],e.prototype,"state",null),a.__decorate([h.property({readOnly:!0,dependsOn:["graphic","graphic.layer","graphic.layer.loaded","graphic.layer.capabilities.operations.supportsResizeAttachments"]})],e.prototype,"supportsResizeAttachments",null),e=a.__decorate([h.subclass("esri.widgets.Attachments.AttachmentsViewModel")],e)}(o.HandleOwner)}));