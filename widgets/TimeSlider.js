// COPYRIGHT © 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../core/tsSupport/assignHelper","dojo/i18n!../nls/common","dojo/i18n!./TimeSlider/nls/TimeSlider","../TimeInterval","../core/arrayUtils","../core/Collection","../core/compilerUtils","../core/Error","../core/events","../core/mathUtils","../core/maybe","../core/throttle","../core/accessorSupport/decorators","../intl/date","../layers/support/timeUtils","./Slider","./Widget","./TimeSlider/TimeSliderViewModel","./support/widget"],function(e,t,i,n,r,s,o,a,l,u,m,d,c,v,p,f,w,h,y,x,_,b,g){var S={widgetIcon:"esri-icon-time-clock",esriWidget:"esri-widget",esriWidgetButton:"esri-widget--button",esriButtonDisabled:"esri-button--disabled",timeSlider:"esri-time-slider",timeSliderMode:"esri-time-slider__mode--",timeSliderLayout:"esri-time-slider__layout--",timeSliderRow:"esri-time-slider__row",animation:"esri-time-slider__animation",animationButton:"esri-time-slider__animation-button",animationPlay:"esri-icon-play",animationPause:"esri-icon-pause",timeExtent:"esri-time-slider__time-extent",timeExtentGroup:"esri-time-slider__time-extent-group",timeExtentDate:"esri-time-slider__time-extent-date",timeExtentTime:"esri-time-slider__time-extent-time",timeExtentSeparator:"esri-time-slider__time-extent-separator",min:"esri-time-slider__min",minDate:"esri-time-slider__min-date",slider:"esri-time-slider__slider",sliderMajorTick:"majorTick",sliderMinorTick:"minorTick",max:"esri-time-slider__max",maxDate:"esri-time-slider__max-date",previous:"esri-time-slider__previous",previousButton:"esri-time-slider__previous-button",previousIcon:"esri-icon-reverse",next:"esri-time-slider__next",nextButton:"esri-time-slider__next-button",nextIcon:"esri-icon-forward"},k=new u([{minor:new a({value:100,unit:"milliseconds"}),major:new a({value:1,unit:"seconds"}),format:{second:"numeric"}},{minor:new a({value:500,unit:"milliseconds"}),major:new a({value:5,unit:"seconds"}),format:{second:"numeric"}},{minor:new a({value:1,unit:"seconds"}),major:new a({value:20,unit:"seconds"}),format:{minute:"numeric",second:"numeric"}},{minor:new a({value:2,unit:"seconds"}),major:new a({value:30,unit:"seconds"}),format:{minute:"numeric",second:"numeric"}},{minor:new a({value:10,unit:"seconds"}),major:new a({value:1,unit:"minutes"}),format:{minute:"numeric"}},{minor:new a({value:15,unit:"seconds"}),major:new a({value:5,unit:"minutes"}),format:{hour:"numeric",minute:"numeric"}},{minor:new a({value:1,unit:"minutes"}),major:new a({value:20,unit:"minutes"}),format:{hour:"numeric",minute:"numeric"}},{minor:new a({value:5,unit:"minutes"}),major:new a({value:2,unit:"hours"}),format:{hour:"numeric",minute:"numeric"}},{minor:new a({value:15,unit:"minutes"}),major:new a({value:6,unit:"hours"}),format:{hour:"numeric",minute:"numeric"}},{minor:new a({value:1,unit:"hours"}),major:new a({value:1,unit:"days"}),format:{day:"numeric",month:"short"}},{minor:new a({value:6,unit:"hours"}),major:new a({value:1,unit:"weeks"}),format:{day:"numeric",month:"short"}},{minor:new a({value:1,unit:"days"}),major:new a({value:1,unit:"months"}),format:{month:"long"}},{minor:new a({value:2,unit:"days"}),major:new a({value:1,unit:"months"}),format:{month:"short"}},{minor:new a({value:3,unit:"days"}),major:new a({value:1,unit:"months"}),format:{month:"short"}},{minor:new a({value:4,unit:"days"}),major:new a({value:3,unit:"months"}),format:{month:"short",year:"numeric"}},{minor:new a({value:1,unit:"weeks"}),major:new a({value:1,unit:"years"}),format:{year:"numeric"}},{minor:new a({value:1,unit:"months"}),major:new a({value:1,unit:"years"}),format:{year:"numeric"}},{minor:new a({value:2,unit:"months"}),major:new a({value:2,unit:"years"}),format:{year:"numeric"}},{minor:new a({value:1,unit:"years"}),major:new a({value:1,unit:"decades"}),format:{year:"numeric"}},{minor:new a({value:2,unit:"years"}),major:new a({value:5,unit:"decades"}),format:{year:"numeric"}},{minor:new a({value:5,unit:"decades"}),major:new a({value:10,unit:"centuries"}),format:{era:"short",year:"numeric"}},{minor:new a({value:1,unit:"centuries"}),major:new a({value:10,unit:"centuries"}),format:{era:"short",year:"numeric"}},{minor:new a({value:2,unit:"centuries"}),major:new a({value:20,unit:"centuries"}),format:{era:"short",year:"numeric"}},{minor:new a({value:5,unit:"centuries"}),major:new a({value:50,unit:"centuries"}),format:{era:"short",year:"numeric"}},{minor:new a({value:10,unit:"centuries"}),major:new a({value:100,unit:"centuries"}),format:{era:"short",year:"numeric"}},{minor:new a({value:20,unit:"centuries"}),major:new a({value:200,unit:"centuries"}),format:{era:"short",year:"numeric"}},{minor:new a({value:50,unit:"centuries"}),major:new a({value:500,unit:"centuries"}),format:{era:"short",year:"numeric"}},{minor:new a({value:100,unit:"centuries"}),major:new a({value:1e3,unit:"centuries"}),format:{era:"short",year:"numeric"}},{minor:new a({value:200,unit:"centuries"}),major:new a({value:1e3,unit:"centuries"}),format:{era:"short",year:"numeric"}},{minor:new a({value:500,unit:"centuries"}),major:new a({value:5e3,unit:"centuries"}),format:{era:"short",year:"numeric"}},{minor:new a({value:1e3,unit:"centuries"}),major:new a({value:1e4,unit:"centuries"}),format:{era:"short",year:"numeric"}}]);return function(e){function t(t){var i=e.call(this)||this;return i._slider=null,i._tickFormat=null,i.effectiveStops=null,i.fullTimeExtent=null,i.iconClass=S.widgetIcon,i.label=o.widgetLabel,i.loop=!0,i.playRate=1e3,i.mode="time-window",i.stops={count:10},i.timeExtent=null,i.timeVisible=!1,i.values=null,i.view=null,i.viewModel=new b,i}return i(t,e),t.prototype.postInitialize=function(){var e=this;this._slider=new x({precision:0,rangeLabelsVisible:!1,rangeLabelInputsEnabled:!1});var t=f.throttle(function(){return e.scheduleRender()},100);this.own([this._slider.watch("values",function(t){e.set("values",t.map(function(e){return new Date(e)}))}),c.on(window,"resize",t),this.watch("effectiveStops",function(){e._updateSliderSteps()}),this.watch(["stops","fullTimeExtent"],function(){e._createDefaultValues()})]),this._updateSliderSteps(),this._createDefaultValues(),this._validateTimeExtent()},t.prototype.destroy=function(){this.view=null,this._slider.destroy(),this._tickFormat=null},t.prototype.next=function(){},t.prototype.play=function(){},t.prototype.previous=function(){},t.prototype.stop=function(){return null},t.prototype.render=function(){var e=this,t=e.domNode,i=e.fullTimeExtent,n=e.mode,r=e._slider,o=e.effectiveStops,a=e.timeVisible,u=e.values,m=e.viewModel;if(null!=i){var d=i.start,c=i.end;if(null==d||null==c)return;var v=d.getTime(),f=c.getTime(),w=r.min!==v||r.max!==f;w&&(r.min=v,r.max=f);var y=r.trackElement?r.trackElement.offsetWidth:400,x=(f-v)/y,_=k.find(function(e){return e.minor.toMilliseconds()>3*x}),b=this._tickFormat!==_&&null!=_;if(b&&(this._tickFormat=_),w||b){var T=this._getTickPositions(_.minor),j={mode:"position",values:T,labelsVisible:!1,tickCreatedFunction:function(e,t,i){t.classList.add(S.sliderMinorTick)}},E=this._getTickPositions(_.major),M={mode:"position",values:E,labelsVisible:!0,tickCreatedFunction:function(e,t,i){t.classList.add(S.sliderMajorTick)},labelFormatFunction:function(e){return h.formatDate(e,_.format)}};r.tickConfigs=[j,M]}}var D=u?u.map(function(e){return e.getTime()}):null;l.equals(r.values,D)||(r.values=D);var O=i&&i.start,C=p.isSome(O)?this._formateDate(O):null,B=a&&p.isSome(O)?this._formateTime(O):null,V=i&&i.end,I=p.isSome(V)?this._formateDate(V):null,R=a&&p.isSome(V)?this._formateTime(V):null,F=null,W=null,L=null,P=null;if(u&&u.length>0){var H=u[0];F=this._formateDate(H),a&&(W=this._formateTime(H))}if("time-window"===n&&u&&u.length>1){var H=u[1];L=this._formateDate(H),a&&(P=this._formateTime(H))}var U=m.state,G="ready"===U,q="playing"===U,z="disabled"===U||0===o.length,A=g.tsx("div",{class:S.animation},g.tsx("button",{"aria-disabled":z?"true":"false","aria-label":q?s.control.stop:s.control.play,bind:this,class:this.classes(S.esriWidgetButton,S.animationButton,z&&S.esriButtonDisabled),disabled:z,title:q?s.control.stop:s.control.play,onclick:this._playOrStopClick},g.tsx("div",{class:this.classes((G||z)&&S.animationPlay,q&&S.animationPause)}))),N=g.tsx("div",{class:S.timeExtent},p.isSome(F)&&g.tsx("div",{key:"start-date-group",class:S.timeExtentGroup},g.tsx("div",{key:"start-date",class:S.timeExtentDate},F),p.isSome(W)&&g.tsx("div",{key:"start-time",class:S.timeExtentTime},W)),p.isSome(L)&&g.tsx("div",{key:"separator",class:S.timeExtentSeparator},"–"),p.isSome(F)&&g.tsx("div",{key:"end-date-group",class:S.timeExtentGroup},g.tsx("div",{key:"end-date",class:S.timeExtentDate},L),p.isSome(P)&&g.tsx("div",{key:"end-time",class:S.timeExtentTime},P))),J=g.tsx("div",{class:S.min},p.isSome(C)&&g.tsx("div",{key:"min-date",class:S.minDate},C),p.isSome(B)&&g.tsx("div",{key:"min-time"},B)),K=g.tsx("div",{class:S.slider},r.render()),Q=g.tsx("div",{class:S.max},p.isSome(I)&&g.tsx("div",{key:"max-date",class:S.maxDate},I),p.isSome(R)&&g.tsx("div",{key:"max-time"},R)),X=g.tsx("div",{class:S.previous},g.tsx("button",{"aria-disabled":z?"true":"false","aria-label":s.pagination.previous,bind:this,class:this.classes(S.esriWidgetButton,S.previousButton,(q||z)&&S.esriButtonDisabled),disabled:z,title:s.pagination.previous,onclick:this._previousClick},g.tsx("div",{class:S.previousIcon}))),Y=g.tsx("div",{class:S.next},g.tsx("button",{"aria-disabled":z?"true":"false","aria-label":s.pagination.next,bind:this,class:this.classes(S.esriWidgetButton,S.nextButton,(q||z)&&S.esriButtonDisabled),disabled:z,title:s.pagination.next,onclick:this._nextClick},g.tsx("div",{class:S.nextIcon}))),Z=t.clientWidth<858?"compact":"wide";return g.tsx("div",{class:this.classes(S.timeSlider,S.esriWidget,""+S.timeSliderMode+n,""+S.timeSliderLayout+Z)},"wide"===Z&&g.tsx("div",{class:S.timeSliderRow},[A,N,J,K,Q,X,Y]),"compact"===Z&&[g.tsx("div",{key:"time-slider-row-1",class:S.timeSliderRow},[N]),g.tsx("div",{key:"time-slider-row-2",class:S.timeSliderRow},[K]),g.tsx("div",{key:"time-slider-row-3",class:S.timeSliderRow},[J,X,A,Y,Q])])},t.prototype._createDefaultValues=function(){var e=this,t=e.fullTimeExtent,i=e.effectiveStops,n=e.mode,r=e.values;t&&i&&n&&!r&&(this.values="time-window"===n?i.length>1?[i[0],i[1]]:null:i.length>0?[i[0]]:null)},t.prototype._getTickPositions=function(e){for(var t=this.fullTimeExtent,i=t.start,n=t.end,r=[],s=e.value,o=e.unit,a=y.truncateDate(i,o);a.getTime()<=n.getTime();)a.getTime()>=i.getTime()&&r.push(a.getTime()),a=y.offsetDate(a,s,o);return r},t.prototype._formateDate=function(e){return h.formatDate(e,h.convertDateFormatToIntlOptions("short-date"))},t.prototype._formateTime=function(e){return h.formatDate(e,h.convertDateFormatToIntlOptions("long-time"))},t.prototype._updateSliderSteps=function(){this._slider.steps=this.effectiveStops.length>0?this.effectiveStops.map(function(e){return e.getTime()}):null},t.prototype._validateTimeExtent=function(){var e=this;if(this.fullTimeExtent&&this.mode&&this.values){if(!Array.isArray(this.values))throw new d("time-slider:invalid-values","Values must be an array of dates.");if(0===this.values.length||this.values.some(function(e){return!(e instanceof Date)}))throw new d("time-slider:invalid-values","Values must be an array of dates.");switch(this.values=this.values.map(function(t){var i=t.getTime(),n=v.clamp(i,e.fullTimeExtent.start.getTime(),e.fullTimeExtent.end.getTime());return new Date(n)}),this.mode){case"instant":case"cumulative-from-start":case"cumulative-from-end":this.values.length>1&&this.values.splice(1);break;case"time-window":1===this.values.length?this.values.push(this.fullTimeExtent.end):this.values.length>2&&this.values.splice(2),this.values.sort(function(e,t){return e.getTime()-t.getTime()});break;default:m.neverReached(this.mode)}}},t.prototype._playOrStopClick=function(){switch(this.viewModel.state){case"ready":this.viewModel.play();break;case"playing":this.viewModel.stop();break;case"disabled":break;default:m.neverReached(this.viewModel.state)}},t.prototype._previousClick=function(){this.viewModel.previous()},t.prototype._nextClick=function(){this.viewModel.next()},n([w.aliasOf("viewModel.effectiveStops"),g.renderable()],t.prototype,"effectiveStops",void 0),n([w.aliasOf("viewModel.fullTimeExtent"),g.renderable()],t.prototype,"fullTimeExtent",void 0),n([w.property()],t.prototype,"iconClass",void 0),n([w.property()],t.prototype,"label",void 0),n([w.aliasOf("viewModel.loop")],t.prototype,"loop",void 0),n([w.aliasOf("viewModel.playRate")],t.prototype,"playRate",void 0),n([w.aliasOf("viewModel.mode"),g.renderable()],t.prototype,"mode",void 0),n([w.aliasOf("viewModel.stops")],t.prototype,"stops",void 0),n([w.aliasOf("viewModel.timeExtent")],t.prototype,"timeExtent",void 0),n([w.property({nonNullable:!0}),g.renderable()],t.prototype,"timeVisible",void 0),n([w.aliasOf("viewModel.values"),g.renderable()],t.prototype,"values",void 0),n([w.aliasOf("viewModel.view")],t.prototype,"view",void 0),n([w.property({type:b}),g.renderable(["viewModel.state"])],t.prototype,"viewModel",void 0),n([w.aliasOf("viewModel.next")],t.prototype,"next",null),n([w.aliasOf("viewModel.play")],t.prototype,"play",null),n([w.aliasOf("viewModel.previous")],t.prototype,"previous",null),n([w.aliasOf("viewModel.stop")],t.prototype,"stop",null),n([g.accessibleHandler()],t.prototype,"_playOrStopClick",null),n([g.accessibleHandler()],t.prototype,"_previousClick",null),n([g.accessibleHandler()],t.prototype,"_nextClick",null),t=n([w.subclass("esri.widgets.TimeSlider")],t)}(w.declared(_))});