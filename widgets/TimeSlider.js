// COPYRIGHT © 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../TimeInterval","../core/arrayUtils","../core/Collection","../core/compilerUtils","../core/Error","../core/events","../core/mathUtils","../core/throttle","../core/watchUtils","../core/accessorSupport/decorators","../intl/date","../layers/support/timeUtils","./Slider","./Widget","./support/widget","./TimeSlider/TimeSliderViewModel"],(function(e,t,i,a,r,o,n,s,l,u,d,m,c,v,p,f,y,h,_){"use strict";var w="esri-icon-time-clock",b="esri-widget",x="esri-widget--button",g="esri-button--disabled",k="esri-disabled",T="esri-time-slider",j="esri-time-slider__mode--",M="esri-time-slider__layout--",C="esri-time-slider__row",O="esri-time-slider__animation",F="esri-time-slider__animation-button",S="esri-icon-play",E="esri-icon-pause",D="esri-time-slider__time-extent",L="esri-time-slider__time-extent-group",U="esri-time-slider__time-extent-date",V="esri-time-slider__time-extent-time",R="esri-time-slider__time-extent-separator",P="esri-time-slider__min",A="esri-time-slider__min-date",I="esri-time-slider__slider",q="majorTick",H="minorTick",W="esri-time-slider__max",z="esri-time-slider__max-date",B="esri-time-slider__previous",N="esri-time-slider__previous-button",G="esri-icon-reverse",J="esri-time-slider__next",K="esri-time-slider__next-button",Q="esri-icon-forward",X=new o([{minor:new a({value:100,unit:"milliseconds"}),major:new a({value:1,unit:"seconds"}),format:{second:"numeric"}},{minor:new a({value:500,unit:"milliseconds"}),major:new a({value:5,unit:"seconds"}),format:{second:"numeric"}},{minor:new a({value:1,unit:"seconds"}),major:new a({value:20,unit:"seconds"}),format:{minute:"numeric",second:"numeric"}},{minor:new a({value:2,unit:"seconds"}),major:new a({value:30,unit:"seconds"}),format:{minute:"numeric",second:"numeric"}},{minor:new a({value:10,unit:"seconds"}),major:new a({value:1,unit:"minutes"}),format:{minute:"numeric"}},{minor:new a({value:15,unit:"seconds"}),major:new a({value:5,unit:"minutes"}),format:{hour:"numeric",minute:"numeric"}},{minor:new a({value:1,unit:"minutes"}),major:new a({value:20,unit:"minutes"}),format:{hour:"numeric",minute:"numeric"}},{minor:new a({value:5,unit:"minutes"}),major:new a({value:2,unit:"hours"}),format:{hour:"numeric",minute:"numeric"}},{minor:new a({value:15,unit:"minutes"}),major:new a({value:6,unit:"hours"}),format:{hour:"numeric",minute:"numeric"}},{minor:new a({value:1,unit:"hours"}),major:new a({value:1,unit:"days"}),format:{day:"numeric",month:"short"}},{minor:new a({value:6,unit:"hours"}),major:new a({value:1,unit:"weeks"}),format:{day:"numeric",month:"short"}},{minor:new a({value:1,unit:"days"}),major:new a({value:1,unit:"months"}),format:{month:"long"}},{minor:new a({value:2,unit:"days"}),major:new a({value:1,unit:"months"}),format:{month:"short"}},{minor:new a({value:3,unit:"days"}),major:new a({value:1,unit:"months"}),format:{month:"short"}},{minor:new a({value:4,unit:"days"}),major:new a({value:3,unit:"months"}),format:{month:"short",year:"numeric"}},{minor:new a({value:1,unit:"weeks"}),major:new a({value:1,unit:"years"}),format:{year:"numeric"}},{minor:new a({value:1,unit:"months"}),major:new a({value:1,unit:"years"}),format:{year:"numeric"}},{minor:new a({value:2,unit:"months"}),major:new a({value:2,unit:"years"}),format:{year:"numeric"}},{minor:new a({value:1,unit:"years"}),major:new a({value:1,unit:"decades"}),format:{year:"numeric"}},{minor:new a({value:2,unit:"years"}),major:new a({value:5,unit:"decades"}),format:{year:"numeric"}},{minor:new a({value:5,unit:"decades"}),major:new a({value:10,unit:"centuries"}),format:{era:"short",year:"numeric"}},{minor:new a({value:1,unit:"centuries"}),major:new a({value:10,unit:"centuries"}),format:{era:"short",year:"numeric"}},{minor:new a({value:2,unit:"centuries"}),major:new a({value:20,unit:"centuries"}),format:{era:"short",year:"numeric"}},{minor:new a({value:5,unit:"centuries"}),major:new a({value:50,unit:"centuries"}),format:{era:"short",year:"numeric"}},{minor:new a({value:10,unit:"centuries"}),major:new a({value:100,unit:"centuries"}),format:{era:"short",year:"numeric"}},{minor:new a({value:20,unit:"centuries"}),major:new a({value:200,unit:"centuries"}),format:{era:"short",year:"numeric"}},{minor:new a({value:50,unit:"centuries"}),major:new a({value:500,unit:"centuries"}),format:{era:"short",year:"numeric"}},{minor:new a({value:100,unit:"centuries"}),major:new a({value:1e3,unit:"centuries"}),format:{era:"short",year:"numeric"}},{minor:new a({value:200,unit:"centuries"}),major:new a({value:1e3,unit:"centuries"}),format:{era:"short",year:"numeric"}},{minor:new a({value:500,unit:"centuries"}),major:new a({value:5e3,unit:"centuries"}),format:{era:"short",year:"numeric"}},{minor:new a({value:1e3,unit:"centuries"}),major:new a({value:1e4,unit:"centuries"}),format:{era:"short",year:"numeric"}}]);return function(e){function t(t,i){var a=e.call(this,t,i)||this;return a._slider=new f({precision:0,visibleElements:{rangeLabels:!1},rangeLabelInputsEnabled:!1}),a._tickFormat=null,a.disabled=!1,a.effectiveStops=null,a.fullTimeExtent=null,a.iconClass=w,a.label=void 0,a.labelFormatFunction=null,a.loop=!1,a.messages=null,a.messagesCommon=null,a.mode="time-window",a.playRate=1e3,a.stops={count:10},a.tickConfigs=null,a.timeExtent=null,a.timeVisible=!1,a.values=null,a.view=null,a.viewModel=new _,a}return i.__extends(t,e),t.prototype.initialize=function(){var e=this;this.own([this._slider.watch("values",(function(t){var i,a=null===(i=e.values)||void 0===i?void 0:i.map((function(e){return e.getTime()}));r.equals(t,a)||e.set("values",t.map((function(e){return new Date(e)})))})),l.on(window,"resize",d.throttle((function(){return e.scheduleRender()}),100)),m.init(this,"effectiveStops",(function(){return e._updateSliderSteps()}))]),this._validateTimeExtent()},t.prototype.destroy=function(){this._slider.destroy(),this._tickFormat=null},Object.defineProperty(t.prototype,"interactive",{get:function(){return!this.disabled&&this.viewModel&&"disabled"!==this.viewModel.state},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"layout",{set:function(e){-1===["auto","compact","wide"].indexOf(e)&&(e="auto"),this._set("layout",e)},enumerable:!1,configurable:!0}),t.prototype.next=function(){},t.prototype.play=function(){},t.prototype.previous=function(){},t.prototype.stop=function(){return null},t.prototype.render=function(){var e,t,i,a=this,o=a._slider,n=a.domNode,s=a.effectiveStops,l=a.fullTimeExtent,u=a.interactive,d=a.messagesCommon,m=a.mode,c=a.tickConfigs,p=a.timeVisible,f=a.values,y=a.viewModel;if(null!=l){var _=l.start,w=l.end;if(null!=_&&null!=w){var Y=_.getTime(),Z=w.getTime(),$=o.min!==Y||o.max!==Z;if($&&(o.min=Y,o.max=Z),null!=c)o.tickConfigs!==c&&(o.tickConfigs=c);else{var ee=(Z-Y)/(null!==(t=null===(e=o.trackElement)||void 0===e?void 0:e.offsetWidth)&&void 0!==t?t:400),te=X.find((function(e){return e.minor.toMilliseconds()>3*ee})),ie=this._tickFormat!==te&&null!=te;if(ie&&(this._tickFormat=te),$||ie){var ae={mode:"position",values:this._getTickPositions(te.minor),labelsVisible:!1,tickCreatedFunction:function(e,t){t.classList.add(H)}},re={mode:"position",values:this._getTickPositions(te.major),labelsVisible:!0,tickCreatedFunction:function(e,t){t.classList.add(q)},labelFormatFunction:function(e){return v.formatDate(e,te.format)}};o.tickConfigs=[ae,re]}}}}var oe=null==f?void 0:f.map((function(e){return e.getTime()}));r.equals(o.values,oe)||(o.values=oe),o.disabled=!u;var ne=null==l?void 0:l.start,se=null==l?void 0:l.end,le=null!==(i=null==f?void 0:f.length)&&void 0!==i?i:0,ue=le&&this._formatDate(f[0]),de=le&&p&&this._formatTime(f[0]),me=le>1&&"time-window"===m&&this._formatDate(f[1]),ce=le>1&&"time-window"===m&&p&&this._formatTime(f[1]),ve=y.state,pe="ready"===ve,fe="playing"===ve,ye=!u||0===s.length,he="auto"===this.layout?n.clientWidth<858?"compact":"wide":this.layout,_e=h.tsx("div",{class:O},h.tsx("button",{"aria-disabled":ye?"true":"false","aria-label":fe?d.control.stop:d.control.play,bind:this,class:this.classes(x,F,ye&&g),disabled:ye,title:fe?d.control.stop:d.control.play,onclick:this._playOrStopClick,type:"button"},h.tsx("div",{class:this.classes((pe||ye)&&S,fe&&E)}))),we=this.labelFormatFunction?h.tsx("div",{key:"extent",bind:this,class:U,"data-type":"extent","data-layout":he,"data-date":f,afterCreate:this._createLabel,afterUpdate:this._createLabel}):[ue&&h.tsx("div",{key:"start-date-group",class:L},h.tsx("div",{key:"start-date",class:U},ue),de&&h.tsx("div",{key:"start-time",class:V},de)),me&&h.tsx("div",{key:"separator",class:R},"–"),ue&&h.tsx("div",{key:"end-date-group",class:L},h.tsx("div",{key:"end-date",class:U},me),ce&&h.tsx("div",{key:"end-time",class:V},ce))],be=h.tsx("div",{class:this.classes(D,!u&&g)},[we]),xe=this.labelFormatFunction?h.tsx("div",{key:"min-date",bind:this,class:A,"data-date":ne,"data-type":"min","data-layout":he,afterCreate:this._createLabel,afterUpdate:this._createLabel}):[ne&&h.tsx("div",{key:"min-date",class:A},this._formatDate(ne)),ne&&p&&h.tsx("div",{key:"min-time"},this._formatTime(ne))],ge=h.tsx("div",{class:this.classes(P,!u&&g)},[xe]),ke=h.tsx("div",{class:I},o.render()),Te=this.labelFormatFunction?h.tsx("div",{key:"max-date",bind:this,class:z,"data-date":se,"data-type":"max","data-layout":he,afterCreate:this._createLabel,afterUpdate:this._createLabel}):[se&&h.tsx("div",{key:"max-date",class:z},this._formatDate(se)),se&&p&&h.tsx("div",{key:"max-time"},this._formatTime(se))],je=h.tsx("div",{class:this.classes(W,!u&&g)},[Te]),Me=h.tsx("div",{class:B},h.tsx("button",{"aria-disabled":ye?"true":"false","aria-label":d.pagination.previous,bind:this,class:this.classes(x,N,(fe||ye)&&g),disabled:ye,title:d.pagination.previous,onclick:this._previousClick,type:"button"},h.tsx("div",{class:G}))),Ce=h.tsx("div",{class:J},h.tsx("button",{"aria-disabled":ye?"true":"false","aria-label":d.pagination.next,bind:this,class:this.classes(x,K,(fe||ye)&&g),disabled:ye,title:d.pagination.next,onclick:this._nextClick,type:"button"},h.tsx("div",{class:Q})));return h.tsx("div",{class:this.classes(T,b,""+j+m,""+M+he,!u&&k)},"wide"===he&&h.tsx("div",{class:C},[_e,be,ge,ke,je,Me,Ce]),"compact"===he&&[h.tsx("div",{key:"time-slider-row-1",class:C},[be]),h.tsx("div",{key:"time-slider-row-2",class:C},[ke]),h.tsx("div",{key:"time-slider-row-3",class:C},[ge,Me,_e,Ce,je])])},t.prototype._createLabel=function(e){var t=e.getAttribute("data-type"),i=e.getAttribute("data-layout"),a=e["data-date"];this.labelFormatFunction(a,t,e,i)},t.prototype._getTickPositions=function(e){for(var t=this.fullTimeExtent,i=t.start,a=t.end,r=[],o=e.value,n=e.unit,s=p.truncateDate(i,n);s.getTime()<=a.getTime();)s.getTime()>=i.getTime()&&r.push(s.getTime()),s=p.offsetDate(s,o,n);return r},t.prototype._formatDate=function(e){return v.formatDate(e,v.convertDateFormatToIntlOptions("short-date"))},t.prototype._formatTime=function(e){return v.formatDate(e,v.convertDateFormatToIntlOptions("long-time"))},t.prototype._updateSliderSteps=function(){this._slider.steps=this.effectiveStops&&this.effectiveStops.length>0?this.effectiveStops.map((function(e){return e.getTime()})):null},t.prototype._validateTimeExtent=function(){var e=this;if(this.fullTimeExtent&&this.mode&&this.values){if(!Array.isArray(this.values))throw new s("time-slider:invalid-values","Values must be an array of dates.");if(0===this.values.length||this.values.some((function(e){return!(e instanceof Date)})))throw new s("time-slider:invalid-values","Values must be an array of dates.");switch(this.values=this.values.map((function(t){var i=t.getTime(),a=u.clamp(i,e.fullTimeExtent.start.getTime(),e.fullTimeExtent.end.getTime());return new Date(a)})),this.mode){case"instant":case"cumulative-from-start":case"cumulative-from-end":this.values.length>1&&this.values.splice(1);break;case"time-window":1===this.values.length?this.values.push(this.fullTimeExtent.end):this.values.length>2&&this.values.splice(2),this.values.sort((function(e,t){return e.getTime()-t.getTime()}));break;default:n.neverReached(this.mode)}}},t.prototype._playOrStopClick=function(){switch(this.viewModel.state){case"ready":this.viewModel.play();break;case"playing":this.viewModel.stop();break;case"disabled":break;default:n.neverReached(this.viewModel.state)}},t.prototype._previousClick=function(){this.viewModel.previous()},t.prototype._nextClick=function(){this.viewModel.next()},i.__decorate([c.property()],t.prototype,"disabled",void 0),i.__decorate([c.aliasOf("viewModel.effectiveStops"),h.renderable()],t.prototype,"effectiveStops",void 0),i.__decorate([c.aliasOf("viewModel.fullTimeExtent"),h.renderable()],t.prototype,"fullTimeExtent",void 0),i.__decorate([c.property()],t.prototype,"iconClass",void 0),i.__decorate([c.property({dependsOn:["disabled","viewModel.state"],readOnly:!0}),h.renderable()],t.prototype,"interactive",null),i.__decorate([c.property({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],t.prototype,"label",void 0),i.__decorate([c.property()],t.prototype,"labelFormatFunction",void 0),i.__decorate([c.property({value:"auto"}),h.renderable()],t.prototype,"layout",null),i.__decorate([c.aliasOf("viewModel.loop")],t.prototype,"loop",void 0),i.__decorate([c.property(),h.renderable(),h.messageBundle("esri/widgets/TimeSlider/t9n/TimeSlider")],t.prototype,"messages",void 0),i.__decorate([c.property(),h.renderable(),h.messageBundle("esri/t9n/common")],t.prototype,"messagesCommon",void 0),i.__decorate([c.aliasOf("viewModel.mode"),h.renderable()],t.prototype,"mode",void 0),i.__decorate([c.aliasOf("viewModel.playRate")],t.prototype,"playRate",void 0),i.__decorate([c.aliasOf("viewModel.stops")],t.prototype,"stops",void 0),i.__decorate([c.property(),h.renderable()],t.prototype,"tickConfigs",void 0),i.__decorate([c.aliasOf("viewModel.timeExtent")],t.prototype,"timeExtent",void 0),i.__decorate([c.property({nonNullable:!0}),h.renderable()],t.prototype,"timeVisible",void 0),i.__decorate([c.aliasOf("viewModel.values"),h.renderable()],t.prototype,"values",void 0),i.__decorate([c.aliasOf("viewModel.view")],t.prototype,"view",void 0),i.__decorate([c.property({type:_}),h.renderable(["viewModel.state"])],t.prototype,"viewModel",void 0),i.__decorate([c.aliasOf("viewModel.next")],t.prototype,"next",null),i.__decorate([c.aliasOf("viewModel.play")],t.prototype,"play",null),i.__decorate([c.aliasOf("viewModel.previous")],t.prototype,"previous",null),i.__decorate([c.aliasOf("viewModel.stop")],t.prototype,"stop",null),i.__decorate([h.accessibleHandler()],t.prototype,"_playOrStopClick",null),i.__decorate([h.accessibleHandler()],t.prototype,"_previousClick",null),i.__decorate([h.accessibleHandler()],t.prototype,"_nextClick",null),t=i.__decorate([c.subclass("esri.widgets.TimeSlider")],t)}(y)}));