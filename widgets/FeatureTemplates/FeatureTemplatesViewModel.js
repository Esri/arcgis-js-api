/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/has","../../core/Evented","../../core/HandleOwner","../../core/maybe","../../core/ObjectPool","../../core/watchUtils","../../core/accessorSupport/decorators/property","../../core/arrayUtils","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass","./TemplateItem","./TemplateItemGroup"],(function(e,t,r,o,s,n,l,a,i,u,p,c,y,m){"use strict";var h;const _=({layer:e})=>({key:e,label:e.title}),f=({layer:e})=>({key:e.geometryType,label:e.geometryType});let d=h=function(t){function r(e){var r;return(r=t.call(this,e)||this)._itemPool=new l(y),r._groupPool=new l(m),r.filterFunction=null,r.selectedItem=null,r}e._inheritsLoose(r,t);var o=r.prototype;return o.initialize=function(){this._get("groupBy")||(this.groupBy="layer")},o.destroy=function(){this._templateToLayer.clear()},o.refresh=function(){this.notifyChange("items")},o.select=function(e){const t=(null==e?void 0:e.clone())||null;this._set("selectedItem",t),this.emit("select",{item:t,template:(null==t?void 0:t.template)||null})},o._createItem=function(e,t){const r=this._itemPool.acquire();return r.set({template:e,layer:t}),r},o._createGroup=function(e,t){const r=this._groupPool.acquire();return r.set("label",e),r.items=t,r},o._releasePreviousItems=function(){this._destroyItems(this._get("items"))},o._destroyItems=function(e){if(!e)return;e[0]instanceof y?e.forEach((e=>this._destroyItem(e))):e.forEach((e=>this._destroyGroup(e)))},o._destroyGroup=function(e){e.items.forEach((e=>this._destroyItem(e))),e.items.length=0,this._groupPool.release(e)},o._destroyItem=function(e){e.layer=null,e.template=null,this._itemPool.release(e)},o._ensureGroupByObject=function(e){return"string"==typeof e?{key:e,label:e}:e},e._createClass(r,[{key:"_templateToLayer",get:function(){const e=new Map;for(const[t,r]of this._featureTemplatesByLayer)for(const o of r)e.set(o,t);return e}},{key:"groupBy",set:function(e){if(this._set("groupBy",e),"function"!=typeof e)switch(e){case"none":this._groupByFunction=null;break;case"layer":this._groupByFunction=_;break;case"geometry":this._groupByFunction=f}else this._groupByFunction=t=>this._ensureGroupByObject(e(t))}},{key:"layers",get:function(){return this._get("layers")},set:function(e){const t="layers";if(this.handles.remove(t),e){const t=()=>this.notifyChange("state");this.handles.add(e.map((e=>a.when(e,"loadStatus",t))),"layers")}this._set("layers",e)}},{key:"state",get:function(){const{layers:e}=this;return e&&0!==e.length?e.some((e=>"loading"===e.loadStatus||"not-loaded"===e.loadStatus))?"loading":"ready":"disabled"}},{key:"_featureTemplatesByLayer",get:function(){if(!this.layers)return new Map;const e=[];for(const t of this.layers){const r="templates"in t&&t.templates?t.templates:[],o="types"in t&&t.types?g(t.types):[];e.push([t,[...r,...o]])}return new Map(e)}},{key:"numberOfFeatureTemplates",get:function(){return Array.from(this._featureTemplatesByLayer.values()).reduce(((e,t)=>e+t.length),0)}},{key:"items",get:function(){if(0===this.numberOfFeatureTemplates)return this._releasePreviousItems(),[];const e=this._featureTemplatesByLayer,t=[],r=n.isSome(this.filterFunction)?this.filterFunction:h._nullFilterFunction;for(const[n,l]of e){const{loadStatus:e,capabilities:{operations:{supportsEditing:o,supportsAdd:s}}}=n;if("loaded"===e&&o&&s)for(const a of l)t.push({layer:n,template:a,matchesFilter:r({label:a.name})})}if(n.isNone(this._groupByFunction)){const e=t.filter((({matchesFilter:e})=>e)).map((({template:e,layer:t})=>this._createItem(e,t)));return this._releasePreviousItems(),e}const o=new Map;for(const l of t){const{template:e,layer:t}=l,r=this._groupByFunction({template:e,layer:t}),{key:s,label:a}=n.isSome(r.key)?r:h.nullGroupBy;o.has(s)||o.set(s,{label:a,templateItemInfos:[]}),o.get(s).templateItemInfos.push(l)}const s=[];for(const n of o.values()){const{label:e,templateItemInfos:t}=n,o=t.filter((({matchesFilter:e})=>e)),l=r({label:e})?t:t.length>0?o:[];if(l.length>0){const t=l.map((({template:e,layer:t})=>this._createItem(e,t)));s.push(this._createGroup(e,t))}}return 1===s.length&&s[0].label===h.nullGroupBy.label?(this._releasePreviousItems(),s[0].items):(this._releasePreviousItems(),s)}}]),r}(s.HandleOwnerMixin(o.EventedAccessor));function g(e){return e.reduce(((e,t)=>[...e,...t.templates]),[])}d.nullGroupBy={key:Symbol(),label:"Otherâ€‹"},d._nullFilterFunction=e=>!0,t.__decorate([i.property()],d.prototype,"_groupByFunction",void 0),t.__decorate([i.property({readOnly:!0})],d.prototype,"_templateToLayer",null),t.__decorate([i.property()],d.prototype,"filterFunction",void 0),t.__decorate([i.property()],d.prototype,"groupBy",null),t.__decorate([i.property()],d.prototype,"layers",null),t.__decorate([i.property()],d.prototype,"state",null),t.__decorate([i.property({readOnly:!0})],d.prototype,"_featureTemplatesByLayer",null),t.__decorate([i.property({readOnly:!0})],d.prototype,"numberOfFeatureTemplates",null),t.__decorate([i.property({readOnly:!0})],d.prototype,"items",null),t.__decorate([i.property({readOnly:!0})],d.prototype,"selectedItem",void 0),t.__decorate([i.property()],d.prototype,"select",null),d=h=t.__decorate([c.subclass("esri.widgets.FeatureTemplates.FeatureTemplatesViewModel")],d);return d}));
