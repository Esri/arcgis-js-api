/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/Evented","../../core/HandleOwner","../../core/ObjectPool","../../core/watchUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/accessorSupport/ensureType","../../core/Logger","../../core/accessorSupport/decorators/subclass","./TemplateItem","./TemplateItemGroup"],(function(e,t,r,o,s,l,a,n,i,p,c,u,y){"use strict";const m=({layer:e})=>({key:e,label:e.title}),h=({layer:e})=>e.geometryType;let f=function(t){function r(e){var r;return(r=t.call(this,e)||this)._itemPool=new s(u),r._groupPool=new s(y),r.filterFunction=null,r.groupBy="layer",r.selectedItem=null,r}e._inheritsLoose(r,t);var o=r.prototype;return o.destroy=function(){this._templateToLayer.clear()},o.refresh=function(){this.notifyChange("items")},o.select=function(e){const t=(null==e?void 0:e.clone())||null;this._set("selectedItem",t),this.emit("select",{item:t,template:(null==t?void 0:t.template)||null})},o._getTemplatesForLayer=function(e){const t=e.templates||[],r=(e.types||[]).map((e=>e.templates)).reduce(((e,t)=>[...e,...t]),[]);return[...t,...r]},o._createItem=function(e){const t=this._itemPool.acquire();return t.set({template:e,layer:this._templateToLayer.get(e)}),t},o._createGroup=function(e,t){const r=this._groupPool.acquire();return r.set("label",e),r.items=t,r},o._releasePreviousItems=function(){this._destroyItems(this._get("items"))},o._destroyItems=function(e){if(!e)return;e[0]instanceof u?e.forEach((e=>this._destroyItem(e))):e.forEach((e=>this._destroyGroup(e)))},o._destroyGroup=function(e){e.items.forEach((e=>this._destroyItem(e))),e.items.length=0,this._groupPool.release(e)},o._destroyItem=function(e){e.layer=null,e.template=null,this._itemPool.release(e)},e._createClass(r,[{key:"_templateToLayer",get:function(){const e=new Map;for(const{layer:t,templates:r}of this._featureTemplateInfos)for(const o of r)e.set(o,t);return e}},{key:"layers",get:function(){return this._get("layers")},set:function(e){const t="layers";if(this.handles.remove(t),e){const t=()=>this.notifyChange("state");this.handles.add(e.map((e=>l.when(e,"loadStatus",t))),"layers")}this._set("layers",e)}},{key:"state",get:function(){const{layers:e}=this;return e&&0!==e.length?e.some((e=>"loading"===e.loadStatus||"not-loaded"===e.loadStatus))?"loading":"ready":"disabled"}},{key:"_featureTemplateInfos",get:function(){return this.layers?this.layers.filter((({capabilities:e,loaded:t})=>t&&e.operations.supportsEditing&&e.operations.supportsAdd)).map((e=>({layer:e,templates:this._getTemplatesForLayer(e)}))).filter((e=>null!=e&&e.templates.length>0)):[]}},{key:"numberOfFeatureTemplates",get:function(){return this._featureTemplateInfos.reduce(((e,t)=>e+t.templates.length),0)}},{key:"items",get:function(){const e=this._featureTemplateInfos;if(0===e.length)return this._releasePreviousItems(),[];const{groupBy:t}=this;if("none"===t){const t=e.map((({templates:e})=>e.filter((({name:e})=>!this.filterFunction||this.filterFunction({label:e}))))).map((e=>e.map((e=>this._createItem(e))))).reduce(((e,t)=>[...e,...t]),[]);return this._releasePreviousItems(),t}const r=e.reduce(((e,{layer:r,templates:o})=>(o.forEach((o=>{const s=("layer"===t?m:"geometry"===t?h:t)({template:o,layer:r});if(s){const t="string"==typeof s?s:s.key,r="string"==typeof s?s:s.label;e.has(t)||e.set(t,{label:r,templates:[]}),e.get(t).templates.push(o)}})),e)),new Map);if(0===r.size)return this._releasePreviousItems(),[];const o=[],{filterFunction:s}=this;return r.forEach((e=>{const{label:t,templates:r}=e;if(!s||this.filterFunction(e))o.push(this._createGroup(t,r.map((e=>this._createItem(e)))));else{const e=r.filter((({name:e})=>this.filterFunction({label:e}))).map((e=>this._createItem(e)));e.length>0&&o.push(this._createGroup(t,e))}})),this._releasePreviousItems(),o}}]),r}(o.HandleOwnerMixin(r.EventedAccessor));return t.__decorate([a.property({readOnly:!0})],f.prototype,"_templateToLayer",null),t.__decorate([a.property()],f.prototype,"filterFunction",void 0),t.__decorate([a.property()],f.prototype,"groupBy",void 0),t.__decorate([a.property()],f.prototype,"layers",null),t.__decorate([a.property()],f.prototype,"state",null),t.__decorate([a.property({readOnly:!0})],f.prototype,"_featureTemplateInfos",null),t.__decorate([a.property({readOnly:!0})],f.prototype,"numberOfFeatureTemplates",null),t.__decorate([a.property({readOnly:!0})],f.prototype,"items",null),t.__decorate([a.property({readOnly:!0})],f.prototype,"selectedItem",void 0),t.__decorate([a.property()],f.prototype,"select",null),f=t.__decorate([c.subclass("esri.widgets.FeatureTemplates.FeatureTemplatesViewModel")],f),f}));
