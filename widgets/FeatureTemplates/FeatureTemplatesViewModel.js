/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/has","../../core/Logger","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/subclass","../../core/urlUtils","../../core/uuid","../../portal/support/resourceExtension","../../core/ObjectPool","../../core/Evented","../../core/watchUtils","../../core/HandleOwner","./TemplateItem","./TemplateItemGroup"],(function(e,t,r,o,s,a,l,n,i,c,p,u,h,y,m,d){"use strict";const f=({layer:e})=>({key:e,label:e.title}),_=({layer:e})=>e.geometryType;let g=function(t){function r(e){var r;return(r=t.call(this,e)||this)._templateToLayer=new Map,r._itemPool=new p(m),r._groupPool=new p(d),r.filterFunction=null,r.groupBy="layer",r}e._inheritsLoose(r,t);var o=r.prototype;return o.destroy=function(){this._templateToLayer.clear(),this._templateToLayer=null},o.refresh=function(){this.notifyChange("items")},o.select=function(e){const t=e.clone();this.emit("select",{item:t,template:t.template})},o._getTemplatesForLayer=function(e){return[...e.templates||[],...(e.types||[]).map((e=>e.templates)).reduce(((e,t)=>[...e,...t]),[])]},o._createItem=function(e){const t=this._itemPool.acquire();return t.set({template:e,layer:this._templateToLayer.get(e)}),t},o._createGroup=function(e,t){const r=this._groupPool.acquire();return r.set("label",e),r.items=t,r},o._destroyItems=function(e){if(!e)return;e[0]instanceof m?e.forEach((e=>this._destroyItem(e))):e.forEach((e=>this._destroyGroup(e)))},o._destroyGroup=function(e){e.items.forEach((e=>this._destroyItem(e))),e.items.length=0,this._groupPool.release(e)},o._destroyItem=function(e){e.layer=null,e.template=null,this._itemPool.release(e)},e._createClass(r,[{key:"layers",get:function(){return this._get("layers")},set:function(e){if(this.handles.removeAll(),e){const t=()=>this.notifyChange("state");this.handles.add(e.map((e=>h.when(e,"loadStatus",t))))}this._set("layers",e)}},{key:"state",get:function(){const{layers:e}=this;return e&&0!==e.length?e.some((e=>"loading"===e.loadStatus||"not-loaded"===e.loadStatus))?"loading":"ready":"disabled"}},{key:"items",get:function(){const{layers:e}=this;if(this._destroyItems(this._get("items")),!e||0===e.length)return[];this._templateToLayer.clear();const t=e.filter((({capabilities:e,loaded:t})=>t&&e.operations.supportsEditing&&e.operations.supportsAdd)).map((e=>{const t=this._getTemplatesForLayer(e);if(t.length>0)return t.forEach((t=>this._templateToLayer.set(t,e))),t})).filter((e=>null!=e)),{groupBy:r}=this;if("none"===r)return t.map((e=>e.filter((({name:e})=>!this.filterFunction||this.filterFunction({label:e}))))).map((e=>e.map((e=>this._createItem(e))))).reduce(((e,t)=>[...e,...t]),[]);const o=t.reduce(((e,t)=>(t.forEach((t=>{const o=("layer"===r?f:"geometry"===r?_:r)({template:t,layer:this._templateToLayer.get(t)});if(o){const r="string"==typeof o?o:o.key,s="string"==typeof o?o:o.label;e.has(r)||e.set(r,{label:s,templates:[]}),e.get(r).templates.push(t)}})),e)),new Map);if(0===o.size)return[];const s=[],{filterFunction:a}=this;return o.forEach((e=>{const{label:t,templates:r}=e;if(!a||this.filterFunction(e))s.push(this._createGroup(t,r.map((e=>this._createItem(e)))));else{const e=r.filter((({name:e})=>this.filterFunction({label:e}))).map((e=>this._createItem(e)));e.length>0&&s.push(this._createGroup(t,e))}})),s}}]),r}(y.HandleOwnerMixin(u.EventedAccessor));return t.__decorate([a.property()],g.prototype,"filterFunction",void 0),t.__decorate([a.property()],g.prototype,"groupBy",void 0),t.__decorate([a.property()],g.prototype,"layers",null),t.__decorate([a.property()],g.prototype,"state",null),t.__decorate([a.property({readOnly:!0})],g.prototype,"items",null),g=t.__decorate([l.subclass("esri.widgets.FeatureTemplates.FeatureTemplatesViewModel")],g),g}));
