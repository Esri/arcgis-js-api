/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../intl","../../../core/Error","../../../core/lang","../../../core/Logger","../../../core/maybe","../../../core/unitUtils","../../../geometry/Polygon","./geometryUtils","../../../intl/substitute","../../../intl/date"],(function(e,t,i,r,n,l,o,s,u,a,c,d){"use strict";const f=/https?:\/\/services.*\.arcgis\.com/i,g=/(?:\{([^}]+)\})/g,y=l.getLogger("esri.widgets.Search.support.layerSearchUtils");function p(e,t){const{exactMatch:i=!1,location:n,maxResults:l,spatialReference:o,source:u,sourceIndex:a,suggestResult:c,view:d}=e,{layer:f,filter:g,zoomScale:p}=u,m=d&&d.scale,x=h(u,d),$=t&&t.signal;return v(f).then((()=>{const e=f.popupTemplate;return e?e.getRequiredFields(f.fieldsIndex):null})).then((e=>{var t,h;const{objectIdField:v,returnZ:T}=f,I=b(u);if(!S(f,I))throw y.error("invalid-field: displayField is invalid."),new r("getResults():invalid-field","displayField is invalid.");const E=e&&e.length?e:[I],M=u.outFields||E,j=F(M);-1!==M.indexOf(v)||j||M.push(v);if(!(j||R(f,M)))throw y.error("invalid-field: outField is invalid."),new r("getResults():invalid-field","outField is invalid.");const O=f.createQuery(),{orderByFields:P}=u;if(P&&(O.orderByFields=P),o){O.outSpatialReference=o;const e=1/s.getMetersPerUnitForSR(o);e&&(O.maxAllowableOffset=e)}const k="mesh"===f.geometryType||"multipatch"===f.geometryType,C=(null==(t=f.capabilities)||null==(h=t.data)?void 0:h.supportsZ)&&!k;if(O.returnZ=C&&!1!==T,O.returnGeometry=!0,O.multipatchOption=k?"xyFootprint":null,M&&(O.outFields=M),n)O.geometry=n;else if(c.key)O.objectIds=[c.key];else{const e=u.searchFields||[I];if(!R(f,e))throw y.error("invalid-field: search field is invalid."),new r("getResults():invalid-field","search field is invalid.");w(f)&&(O.num=l),x&&(O.geometry=x);if(!c.text.trim())return[];const{prefix:t="",suffix:n=""}=u,o=D({searchTerm:L(`${t}${c.text}${n}`),layer:f,searchFields:e,filter:g,exactMatch:i,type:"search"});if(!o)return[];O.where=o}return f.queryFeatures(O,{signal:$}).then((e=>B(e,d,u,a,I,m,p)))}))}function m(e,t){const{source:i,spatialReference:n,view:l,suggestTerm:o,maxSuggestions:s,sourceIndex:u,exactMatch:a}=e,{layer:c,filter:d}=i,f=t&&t.signal,p=h(i,l);return v(c).then((()=>{if(!w(c))return[];const e=b(i),t=i.searchFields||[e],l=[];i.suggestionTemplate?i.suggestionTemplate.replace(g,((e,t)=>(l.push(t),e))):l.push(e);const m=F(l);-1!==l.indexOf(c.objectIdField)||m||l.push(c.objectIdField);const h=S(c,e),v=m||R(c,l),x=R(c,t);if(!h)throw y.error("invalid-field: displayField is invalid."),new r("getSuggestions():invalid-field","displayField is invalid.");if(!v)throw y.error("invalid-field: outField is invalid."),new r("getSuggestions():invalid-field","outField is invalid.");if(!x)throw y.error("invalid-field: search field is invalid."),new r("getSuggestions():invalid-field","search field is invalid.");const $=c.createQuery(),{orderByFields:T}=i;T&&($.orderByFields=T),$.outSpatialReference=n,$.returnGeometry=!1,$.num=s,$.outFields=l,p&&($.geometry=p);if(!o.trim())return[];const{prefix:I="",suffix:E=""}=i,M=D({searchTerm:L(`${I}${o}${E}`),layer:c,searchFields:t,filter:d,exactMatch:a,type:"suggest"});return M?($.where=M,c.queryFeatures($,{signal:f}).then((t=>N(t,i,u,e)))):[]}))}function h(e,t){const{filter:i,withinViewEnabled:r}=e,n=t&&t.extent;return i&&i.geometry||(r&&n?n:void 0)}function F(e){return e&&-1!==e.indexOf("*")}function v(e){return x.apply(this,arguments)}function x(){return(x=t._asyncToGenerator((function*(e){e&&(yield e.load())}))).apply(this,arguments)}function w(e){var t,i,r;return null!=(t=null==e||null==(i=e.capabilities)||null==(r=i.query)?void 0:r.supportsPagination)&&t}function $(e){var t,i,r,n;return null!=(t=null==e||null==(i=e.fieldsIndex)||null==(r=i.fields)||null==(n=r.find((e=>"string"===e.type)))?void 0:n.name)?t:""}function b(e){return e.displayField||e.layer.displayField||$(e.layer)}function R(e,t){return!(!e||!t)&&t.every((t=>S(e,t)))}function S(e,t){return!!e.getField(t)}function T(e){for(let t=0;t<e.length;t++)if(e.charCodeAt(t)>255)return!0;return!1}function I(e,t,i){let r=null;const{codedValues:n}=e;return n&&n.some((e=>{const n=e.name,l=i?n:n.toLowerCase();return(i?t:t.toLowerCase())===l&&(r=e.code.toString(),!0)})),r}function L(e){return e.replace(/\'/g,"''")}function E(e,t){const i=t&&t.where;return i?`(${e}) AND (${i})`:e}function M({currentTerm:e,field:t,filter:i,exactMatch:r,url:n,type:l}){const o=t.type,s=t.name;if("string"===o||"date"===o||"global-id"===o){const t=f.test(n),o=t&&T(e)?"N":"";if(r&&"search"===l)return E(`${s} = ${o}'${e}'`,i);const u=t?s:`UPPER(${s})`,a=t?e:e.toUpperCase();return E(`${u} LIKE ${o}${r?`'${a}%'`:`'%${a}%'`}`,i)}if("oid"===o||"small-integer"===o||"integer"===o||"single"===o||"double"===o){const t=Number(e);return isNaN(t)?null:E(`${s} = ${t}`,i)}return E(`${s} = ${e}`,i)}function j(e,t){return e?` OR (${t})`:`(${t})`}function D({searchTerm:e,layer:t,searchFields:i,filter:r,exactMatch:n,type:l}){const{definitionExpression:o,url:s}=t;let u="";return e&&i&&i.forEach((i=>{const o=t.getField(i),a="function"==typeof t.getFieldDomain&&t.getFieldDomain(i),c=(a&&"coded-value"===a.type?I(a,e,n):null)||e||null;if(null!==c){const e=M({currentTerm:c,field:o,filter:r,exactMatch:n,url:s,type:l});e&&(u+=j(u,e))}})),o?`(${o}) AND (${u})`:u}function O(e,t){let i=null;const{codedValues:r}=e;return r&&r.length&&r.some((e=>e.code===t&&(i=e.name,!0))),i}function P(e,t){return e[Object.keys(e).find((e=>e.toLowerCase()===t.toLowerCase()))]}function k(e,t,i){const r=e.sourceLayer,{attributes:n}=e,l="function"==typeof r.getFieldDomain&&r.getFieldDomain(i);if(t)return c.substitute(t,n);if(i&&n){const e=r.getField(i),t=P(n,i);return null==t?"":l&&"coded-value"===l.type?O(l,t):"date"===(null==e?void 0:e.type)?d.formatDate(new Date(t)):"number"==typeof t?t.toString():"string"!=typeof t?"":t.trim()}return""}function C(e,t,i,r){const n=e.sourceLayer,{attributes:l}=e,{objectIdField:o}=n,s=l[o];return{text:k(e,t.suggestionTemplate,r),key:s,sourceIndex:i}}function N(e,t,i,r){return e.features.map((e=>C(e,t,i,r)))}function U(e,t,i,r,l,s,c){const d=e.clone(),f=e.sourceLayer,g=f&&f.objectIdField,y=g&&e.attributes[g],p=k(e,i.searchTemplate,l),m=a.createExtentFromGeometry(d.geometry,t,s),h="number"==typeof c?a.scaleExtent(n.clone(m),t,c):m,F=e.clone();return o.isSome(h)&&(F.geometry=u.fromExtent(h)),{extent:h,target:F,feature:d,key:y,name:p,sourceIndex:r}}function B(e,t,i,r,n,l,o){return e.features.map((e=>U(e,t,i,r,n,l,o)))}e.getResults=p,e.getSuggestions=m,Object.defineProperty(e,"__esModule",{value:!0})}));
