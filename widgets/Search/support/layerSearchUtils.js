/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../intl","../../../core/Error","../../../core/lang","../../../core/Logger","../../../core/maybe","../../../core/unitUtils","../../../geometry/Polygon","./geometryUtils","../../../intl/substitute","../../../intl/date"],(function(e,t,n,i,r,l,o,s,u,a,d,c){"use strict";const f=/https?:\/\/services.*\.arcgis\.com/i,g=/(?:\{([^}]+)\})/g,p=l.getLogger("esri.widgets.Search.support.layerSearchUtils");function y(e,t){const{exactMatch:n=!1,location:r,maxResults:l,spatialReference:o,source:u,sourceIndex:a,suggestResult:d,view:c}=e,{layer:f,filter:g,zoomScale:y}=u,m=c&&c.scale,x=h(u,c),b=t&&t.signal;return F(f).then((()=>{const e=f.popupTemplate;return e?e.getRequiredFields(f.fieldsIndex):null})).then((e=>{var t,h;const{objectIdField:F,returnZ:I}=f,L=$(u);if(!S(f,L))throw p.error("invalid-field: displayField is invalid."),new i("getResults():invalid-field","displayField is invalid.");const T=e&&e.length?e:[L],j=u.outFields||T,D=v(j);-1!==j.indexOf(F)||D||j.push(F);if(!(D||R(f,j)))throw p.error("invalid-field: outField is invalid."),new i("getResults():invalid-field","outField is invalid.");const P=f.createQuery(),{orderByFields:k}=u;if(k&&(P.orderByFields=k),o){P.outSpatialReference=o;const e=1/s.getMetersPerUnitForSR(o);e&&(P.maxAllowableOffset=e)}const C="mesh"===f.geometryType||"multipatch"===f.geometryType,N=(null==(t=f.capabilities)||null==(h=t.data)?void 0:h.supportsZ)&&!C;if(P.returnZ=N&&!1!==I,P.returnGeometry=!0,P.multipatchOption=C?"xyFootprint":null,j&&(P.outFields=j),r)P.geometry=r;else if(d.key)P.objectIds=[d.key];else{const e=u.searchFields||[L];if(!R(f,e))throw p.error("invalid-field: search field is invalid."),new i("getResults():invalid-field","search field is invalid.");w(f)&&(P.num=l),x&&(P.geometry=x);if(!d.text.trim())return[];const{prefix:t="",suffix:r=""}=u,o=O(E(`${t}${d.text}${r}`),f,e,g,n);if(!o)return[];P.where=o}return f.queryFeatures(P,{signal:b}).then((e=>q(e,c,u,a,L,m,y)))}))}function m(e,t){const{source:n,spatialReference:r,view:l,suggestTerm:o,maxSuggestions:s,sourceIndex:u}=e,{layer:a,filter:d}=n,c=t&&t.signal,f=h(n,l);return F(a).then((()=>{if(!w(a))return[];const e=$(n),t=n.searchFields||[e],l=[];n.suggestionTemplate?n.suggestionTemplate.replace(g,((e,t)=>(l.push(t),e))):l.push(e);const y=v(l);-1!==l.indexOf(a.objectIdField)||y||l.push(a.objectIdField);const m=S(a,e),h=y||R(a,l),F=R(a,t);if(!m)throw p.error("invalid-field: displayField is invalid."),new i("getSuggestions():invalid-field","displayField is invalid.");if(!h)throw p.error("invalid-field: outField is invalid."),new i("getSuggestions():invalid-field","outField is invalid.");if(!F)throw p.error("invalid-field: search field is invalid."),new i("getSuggestions():invalid-field","search field is invalid.");const x=a.createQuery(),{orderByFields:b}=n;b&&(x.orderByFields=b),x.outSpatialReference=r,x.returnGeometry=!1,x.num=s,x.outFields=l,f&&(x.geometry=f);if(!o.trim())return[];const{prefix:I="",suffix:L=""}=n,T=O(E(`${I}${o}${L}`),a,t,d,!1);return T?(x.where=T,a.queryFeatures(x,{signal:c}).then((t=>U(t,n,u,e)))):[]}))}function h(e,t){const{filter:n,withinViewEnabled:i}=e,r=t&&t.extent;return n&&n.geometry||(i&&r?r:void 0)}function v(e){return e&&-1!==e.indexOf("*")}function F(e){return x.apply(this,arguments)}function x(){return(x=t._asyncToGenerator((function*(e){e&&(yield e.load())}))).apply(this,arguments)}function w(e){var t,n,i;return null!=(t=null==e||null==(n=e.capabilities)||null==(i=n.query)?void 0:i.supportsPagination)&&t}function b(e){var t,n,i,r;return null!=(t=null==e||null==(n=e.fieldsIndex)||null==(i=n.fields)||null==(r=i.find((e=>"string"===e.type)))?void 0:r.name)?t:""}function $(e){return e.displayField||e.layer.displayField||b(e.layer)}function R(e,t){return!(!e||!t)&&t.every((t=>S(e,t)))}function S(e,t){return!!e.getField(t)}function I(e){for(let t=0;t<e.length;t++)if(e.charCodeAt(t)>255)return!0;return!1}function L(e,t,n){let i=null;const{codedValues:r}=e;return r&&r.some((e=>{const r=e.name,l=n?r:r.toLowerCase();return(n?t:t.toLowerCase())===l&&(i=e.code.toString(),!0)})),i}function E(e){return e.replace(/\'/g,"''")}function T(e,t){const n=t&&t.where;return n?`(${e}) AND (${n})`:e}function j(e,t,n,i,r){const l=t.type,o=t.name;if("string"===l||"date"===l||"global-id"===l){if(r)return T(`${o} = ${n}'${e}'`,i);return T(`UPPER(${o}) LIKE ${n}'%${e.toUpperCase()}%'`,i)}if("oid"===l||"small-integer"===l||"integer"===l||"single"===l||"double"===l){const t=Number(e);return isNaN(t)?null:T(`${o} = ${t}`,i)}return T(`${o} = ${e}`,i)}function D(e,t){return e?` OR (${t})`:`(${t})`}function O(e,t,n,i,r){const{definitionExpression:l}=t;let o="";if(e){const l=f.test(t.url)&&I(e)?"N":"";n&&n.forEach((n=>{const s=t.getField(n),u="function"==typeof t.getFieldDomain&&t.getFieldDomain(n),a=(u&&"coded-value"===u.type?L(u,e,r):null)||e||null;if(null!==a){const e=j(a,s,l,i,r);e&&(o+=D(o,e))}}))}return l?`(${l}) AND (${o})`:o}function P(e,t){let n=null;const{codedValues:i}=e;return i&&i.length&&i.some((e=>e.code===t&&(n=e.name,!0))),n}function k(e,t){return e[Object.keys(e).find((e=>e.toLowerCase()===t.toLowerCase()))]}function C(e,t,n){const i=e.sourceLayer,{attributes:r}=e,l="function"==typeof i.getFieldDomain&&i.getFieldDomain(n);if(t)return d.substitute(t,r);if(n&&r){const e=i.getField(n),t=k(r,n);return null==t?"":l&&"coded-value"===l.type?P(l,t):"date"===(null==e?void 0:e.type)?c.formatDate(new Date(t)):"number"==typeof t?t.toString():"string"!=typeof t?"":t.trim()}return""}function N(e,t,n,i){const r=e.sourceLayer,{attributes:l}=e,{objectIdField:o}=r,s=l[o];return{text:C(e,t.suggestionTemplate,i),key:s,sourceIndex:n}}function U(e,t,n,i){return e.features.map((e=>N(e,t,n,i)))}function B(e,t,n,i,l,s,d){const c=e.clone(),f=e.sourceLayer,g=f&&f.objectIdField,p=g&&e.attributes[g],y=C(e,n.searchTemplate,l),m=a.createExtentFromGeometry(c.geometry,t,s),h="number"==typeof d?a.scaleExtent(r.clone(m),t,d):m,v=e.clone();return o.isSome(h)&&(v.geometry=u.fromExtent(h)),{extent:h,target:v,feature:c,key:p,name:y,sourceIndex:i}}function q(e,t,n,i,r,l,o){return e.features.map((e=>B(e,t,n,i,r,l,o)))}e.getResults=y,e.getSuggestions=m,Object.defineProperty(e,"__esModule",{value:!0})}));
