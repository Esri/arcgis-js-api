/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../intl","../../../core/Error","../../../core/lang","../../../core/Logger","../../../core/maybe","../../../core/unitUtils","../../../geometry/Polygon","./geometryUtils","../../../intl/substitute","../../../intl/date"],(function(e,t,r,i,n,l,o,s,u,a,c,d){"use strict";const f=/https?:\/\/services.*\.arcgis\.com/i,g=/(?:\{([^}]+)\})/g,p=l.getLogger("esri.widgets.Search.support.layerSearchUtils");function y(e,t){const{exactMatch:r=!1,location:n,maxResults:l,spatialReference:o,source:u,sourceIndex:a,suggestResult:c,view:d}=e,{layer:f,filter:g,zoomScale:y}=u,m=d&&d.scale,x=h(u,d),$=t&&t.signal;return v(f).then((()=>{const e=f.popupTemplate;return e?e.getRequiredFields(f.fieldsIndex):null})).then((e=>{var t,h,v;const{objectIdField:S,returnZ:T}=f,E=b(u);if(!R(f,E))throw p.error("invalid-field: displayField is invalid."),new i("getResults():invalid-field","displayField is invalid.");const M=e&&e.length?e:[E],j=u.outFields||M,O=F(j);-1!==j.indexOf(S)||O||j.push(S),null!=(t=f.floorInfo)&&t.floorField&&j.push(f.floorInfo.floorField);if(!(O||I(f,j)))throw p.error("invalid-field: outField is invalid."),new i("getResults():invalid-field","outField is invalid.");const P=f.createQuery(),{orderByFields:k}=u;if(k&&(P.orderByFields=k),o){P.outSpatialReference=o;const e=1/s.getMetersPerUnitForSR(o);e&&(P.maxAllowableOffset=e)}const C="mesh"===f.geometryType||"multipatch"===f.geometryType,N=(null==(h=f.capabilities)||null==(v=h.data)?void 0:v.supportsZ)&&!C;if(P.returnZ=N&&!1!==T,P.returnGeometry=!0,P.multipatchOption=C?"xyFootprint":null,j&&(P.outFields=j),n)P.geometry=n;else if(c.key)P.objectIds=[c.key];else{const e=u.searchFields||[E];if(!I(f,e))throw p.error("invalid-field: search field is invalid."),new i("getResults():invalid-field","search field is invalid.");w(f)&&(P.num=l),x&&(P.geometry=x);if(!c.text.trim())return[];const{prefix:t="",suffix:n=""}=u,o=D({searchTerm:L(`${t}${c.text}${n}`),layer:f,searchFields:e,filter:g,exactMatch:r,type:"search"});if(!o)return[];P.where=o}return f.queryFeatures(P,{signal:$}).then((e=>B(e,d,u,a,E,m,y)))}))}function m(e,t){const{source:r,spatialReference:n,view:l,suggestTerm:o,maxSuggestions:s,sourceIndex:u,exactMatch:a}=e,{layer:c,filter:d}=r,f=t&&t.signal,y=h(r,l);return v(c).then((()=>{if(!w(c))return[];const e=b(r),t=r.searchFields||[e],l=[];r.suggestionTemplate?r.suggestionTemplate.replace(g,((e,t)=>(l.push(t),e))):l.push(e);const m=F(l);-1!==l.indexOf(c.objectIdField)||m||l.push(c.objectIdField);const h=R(c,e),v=m||I(c,l),x=I(c,t);if(!h)throw p.error("invalid-field: displayField is invalid."),new i("getSuggestions():invalid-field","displayField is invalid.");if(!v)throw p.error("invalid-field: outField is invalid."),new i("getSuggestions():invalid-field","outField is invalid.");if(!x)throw p.error("invalid-field: search field is invalid."),new i("getSuggestions():invalid-field","search field is invalid.");const $=c.createQuery(),{orderByFields:S}=r;S&&($.orderByFields=S),$.outSpatialReference=n,$.returnGeometry=!1,$.num=s,$.outFields=l,y&&($.geometry=y);if(!o.trim())return[];const{prefix:T="",suffix:E=""}=r,M=D({searchTerm:L(`${T}${o}${E}`),layer:c,searchFields:t,filter:d,exactMatch:a,type:"suggest"});return M?($.where=M,c.queryFeatures($,{signal:f}).then((t=>N(t,r,u,e)))):[]}))}function h(e,t){const{filter:r,withinViewEnabled:i}=e,n=t&&t.extent;return r&&r.geometry||(i&&n?n:void 0)}function F(e){return e&&-1!==e.indexOf("*")}function v(e){return x.apply(this,arguments)}function x(){return(x=t._asyncToGenerator((function*(e){e&&(yield e.load())}))).apply(this,arguments)}function w(e){var t,r,i;return null!=(t=null==e||null==(r=e.capabilities)||null==(i=r.query)?void 0:i.supportsPagination)&&t}function $(e){var t,r,i,n;return null!=(t=null==e||null==(r=e.fieldsIndex)||null==(i=r.fields)||null==(n=i.find((e=>"string"===e.type)))?void 0:n.name)?t:""}function b(e){return e.displayField||e.layer.displayField||$(e.layer)}function I(e,t){return!(!e||!t)&&t.every((t=>R(e,t)))}function R(e,t){return!!e.getField(t)}function S(e){for(let t=0;t<e.length;t++)if(e.charCodeAt(t)>255)return!0;return!1}function T(e,t,r){let i=null;const{codedValues:n}=e;return n&&n.some((e=>{const n=e.name,l=r?n:n.toLowerCase();return(r?t:t.toLowerCase())===l&&(i=e.code.toString(),!0)})),i}function L(e){return e.replace(/\'/g,"''")}function E(e,t){const r=t&&t.where;return r?`(${e}) AND (${r})`:e}function M({currentTerm:e,field:t,filter:r,exactMatch:i,url:n,type:l}){const o=t.type,s=t.name;if("string"===o||"date"===o||"global-id"===o){const t=f.test(n),o=t&&S(e)?"N":"";if(i&&"search"===l)return E(`${s} = ${o}'${e}'`,r);const u=t?s:`UPPER(${s})`,a=t?e:e.toUpperCase();return E(`${u} LIKE ${o}${i?`'${a}%'`:`'%${a}%'`}`,r)}if("oid"===o||"small-integer"===o||"integer"===o||"single"===o||"double"===o){const t=Number(e);return isNaN(t)?null:E(`${s} = ${t}`,r)}return E(`${s} = ${e}`,r)}function j(e,t){return e?` OR (${t})`:`(${t})`}function D({searchTerm:e,layer:t,searchFields:r,filter:i,exactMatch:n,type:l}){const{definitionExpression:o,url:s}=t;let u="";return e&&r&&r.forEach((r=>{const o=t.getField(r),a="function"==typeof t.getFieldDomain&&t.getFieldDomain(r),c=(a&&"coded-value"===a.type?T(a,e,n):null)||e||null;if(null!==c){const e=M({currentTerm:c,field:o,filter:i,exactMatch:n,url:s,type:l});e&&(u+=j(u,e))}})),o?`(${o}) AND (${u})`:u}function O(e,t){let r=null;const{codedValues:i}=e;return i&&i.length&&i.some((e=>e.code===t&&(r=e.name,!0))),r}function P(e,t){return e[Object.keys(e).find((e=>e.toLowerCase()===t.toLowerCase()))]}function k(e,t,r){const i=e.sourceLayer,{attributes:n}=e,l="function"==typeof i.getFieldDomain&&i.getFieldDomain(r);if(t)return c.substitute(t,n);if(r&&n){const e=i.getField(r),t=P(n,r);return null==t?"":l&&"coded-value"===l.type?O(l,t):"date"===(null==e?void 0:e.type)?d.formatDate(new Date(t)):"number"==typeof t?t.toString():"string"!=typeof t?"":t.trim()}return""}function C(e,t,r,i){const n=e.sourceLayer,{attributes:l}=e,{objectIdField:o}=n,s=l[o];return{text:k(e,t.suggestionTemplate,i),key:s,sourceIndex:r}}function N(e,t,r,i){return e.features.map((e=>C(e,t,r,i)))}function U(e,t,r,i,l,s,c){const d=e.clone(),f=e.sourceLayer,g=f&&f.objectIdField,p=g&&e.attributes[g],y=k(e,r.searchTemplate,l),m=a.createExtentFromGeometry(d.geometry,t,s),h="number"==typeof c?a.scaleExtent(n.clone(m),t,c):m,F=e.clone();return o.isSome(h)&&(F.geometry=u.fromExtent(h)),{extent:h,target:F,feature:d,key:p,name:y,sourceIndex:i}}function B(e,t,r,i,n,l,o){return e.features.map((e=>U(e,t,r,i,n,l,o)))}e.getResults=y,e.getSuggestions=m,Object.defineProperty(e,"__esModule",{value:!0})}));
