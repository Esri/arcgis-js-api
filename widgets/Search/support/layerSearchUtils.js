/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../intl","../../../core/Error","../../../core/lang","../../../core/Logger","../../../core/maybe","../../../core/unitUtils","../../../geometry/Polygon","./geometryUtils","../../../intl/substitute","../../../intl/date"],(function(e,t,i,r,n,l,o,s,u,a,c,d){"use strict";const f=/https?:\/\/services.*\.arcgis\.com/i,g=/(?:\{([^}]+)\})/g,p=l.getLogger("esri.widgets.Search.support.layerSearchUtils");function y(e,t){const{exactMatch:i=!1,location:n,maxResults:l,spatialReference:o,source:u,sourceIndex:a,suggestResult:c,view:d}=e,{layer:f,filter:g,zoomScale:y}=u,m=d&&d.scale,x=h(u,d),b=t&&t.signal;return v(f).then((()=>{const e=f.popupTemplate;return e?e.getRequiredFields(f.fieldsIndex):null})).then((e=>{var t,h,v;const{objectIdField:T,returnZ:R}=f,M=$(u);if(!I(f,M))throw p.error("invalid-field: displayField is invalid."),new r("getResults():invalid-field","displayField is invalid.");const E=e&&e.length?e:[M],j=u.outFields||E,O=F(j);-1!==j.indexOf(T)||O||j.push(T),null!=(t=f.floorInfo)&&t.floorField&&j.push(f.floorInfo.floorField);if(!(O||S(f,j)))throw p.error("invalid-field: outField is invalid."),new r("getResults():invalid-field","outField is invalid.");const P=f.createQuery(),{orderByFields:k}=u;if(k&&(P.orderByFields=k),o){P.outSpatialReference=o;const e=1/s.getMetersPerUnitForSR(o);e&&(P.maxAllowableOffset=e)}const C="mesh"===f.geometryType||"multipatch"===f.geometryType,N=(null==(h=f.capabilities)||null==(v=h.data)?void 0:v.supportsZ)&&!C;if(P.returnZ=N&&!1!==R,P.returnGeometry=!0,P.multipatchOption=C?"xyFootprint":null,j&&(P.outFields=j),n)P.geometry=n;else if(c.key)P.objectIds=[c.key];else{const e=u.searchFields||[M];if(!S(f,e))throw p.error("invalid-field: search field is invalid."),new r("getResults():invalid-field","search field is invalid.");w(f)&&(P.num=l),x&&(P.geometry=x);if(!c.text.trim())return[];const{prefix:t="",suffix:n=""}=u,o=D({searchTerm:L(`${t}${c.text}${n}`),layer:f,searchFields:e,filter:g,exactMatch:i,type:"search"});if(!o)return[];P.where=o}return f.queryFeatures(P,{signal:b}).then((e=>B(e,d,u,a,M,m,y)))}))}function m(e,t){const{source:i,spatialReference:n,view:l,suggestTerm:o,maxSuggestions:s,sourceIndex:u,exactMatch:a}=e,{layer:c,filter:d}=i,f=t&&t.signal,y=h(i,l);return v(c).then((()=>{if(!w(c))return[];const e=$(i),t=i.searchFields||[e],l=[];i.suggestionTemplate?i.suggestionTemplate.replace(g,((e,t)=>(l.push(t),e))):l.push(e);const m=F(l);-1!==l.indexOf(c.objectIdField)||m||l.push(c.objectIdField);const h=I(c,e),v=m||S(c,l),x=S(c,t);if(!h)throw p.error("invalid-field: displayField is invalid."),new r("getSuggestions():invalid-field","displayField is invalid.");if(!v)throw p.error("invalid-field: outField is invalid."),new r("getSuggestions():invalid-field","outField is invalid.");if(!x)throw p.error("invalid-field: search field is invalid."),new r("getSuggestions():invalid-field","search field is invalid.");const b=c.createQuery(),{orderByFields:T}=i;T&&(b.orderByFields=T),b.outSpatialReference=n,b.returnGeometry=!1,b.num=s,b.outFields=l,y&&(b.geometry=y);if(!o.trim())return[];const{prefix:R="",suffix:M=""}=i,E=D({searchTerm:L(`${R}${o}${M}`),layer:c,searchFields:t,filter:d,exactMatch:a,type:"suggest"});return E?(b.where=E,c.queryFeatures(b,{signal:f}).then((t=>N(t,i,u,e)))):[]}))}function h(e,t){const{filter:i,withinViewEnabled:r}=e,n=t&&t.extent;return i&&i.geometry||(r&&n?n:void 0)}function F(e){return e&&-1!==e.indexOf("*")}function v(e){return x.apply(this,arguments)}function x(){return(x=t._asyncToGenerator((function*(e){e&&(yield e.load())}))).apply(this,arguments)}function w(e){var t,i,r;return null!=(t=null==e||null==(i=e.capabilities)||null==(r=i.query)?void 0:r.supportsPagination)&&t}function b(e){var t,i,r,n;return null!=(t=null==e||null==(i=e.fieldsIndex)||null==(r=i.fields)||null==(n=r.find((e=>"string"===e.type)))?void 0:n.name)?t:""}function $(e){return e.displayField||e.layer.displayField||b(e.layer)}function S(e,t){return!(!e||!t)&&t.every((t=>I(e,t)))}function I(e,t){return!!e.getField(t)}function T(e){for(let t=0;t<e.length;t++)if(e.charCodeAt(t)>255)return!0;return!1}function R(e,t,i){let r=null;const{codedValues:n}=e;return n&&n.some((e=>{const n=e.name,l=i?n:n.toLowerCase();return(i?t:t.toLowerCase())===l&&(r=e.code.toString(),!0)})),r}function L(e){return e.replace(/\'/g,"''")}function M(e,t){const i=t&&t.where;return i?`(${e}) AND (${i})`:e}function E({currentTerm:e,field:t,filter:i,exactMatch:r,url:n,type:l}){const o=t.type,s=t.name;if("string"===o||"date"===o||"global-id"===o){const t=f.test(n),o=t&&T(e)?"N":"";if(r&&"search"===l)return M(`${s} = ${o}'${e}'`,i);const u=t?s:`UPPER(${s})`,a=t?e:e.toUpperCase();return M(`${u} LIKE ${o}${r?`'${a}%'`:`'%${a}%'`}`,i)}if("oid"===o||"small-integer"===o||"integer"===o||"single"===o||"double"===o){const t=Number(e);return isNaN(t)?null:M(`${s} = ${t}`,i)}return M(`${s} = ${e}`,i)}function j(e,t){return e?` OR (${t})`:`(${t})`}function D({searchTerm:e,layer:t,searchFields:i,filter:r,exactMatch:n,type:l}){const{definitionExpression:o,url:s}=t;let u="";return e&&i&&i.forEach((i=>{const o=t.getField(i),a="function"==typeof t.getFieldDomain&&t.getFieldDomain(i),c=(a&&"coded-value"===a.type?R(a,e,n):null)||e||null;if(null!==c){const e=E({currentTerm:c,field:o,filter:r,exactMatch:n,url:s,type:l});e&&(u+=j(u,e))}})),o?`(${o}) AND (${u})`:u}function O(e,t){let i=null;const{codedValues:r}=e;return r&&r.length&&r.some((e=>e.code===t&&(i=e.name,!0))),i}function P(e,t){return e[Object.keys(e).find((e=>e.toLowerCase()===t.toLowerCase()))]}function k(e,t,i){const r=e.sourceLayer,{attributes:n}=e,l="function"==typeof r.getFieldDomain&&r.getFieldDomain(i);if(t)return c.substitute(t,n);if(i&&n){const e=r.getField(i),t=P(n,i);return null==t?"":l&&"coded-value"===l.type?O(l,t):"date"===(null==e?void 0:e.type)?d.formatDate(new Date(t)):"number"==typeof t?t.toString():"string"!=typeof t?"":t.trim()}return""}function C(e,t,i,r){const n=e.sourceLayer,{attributes:l}=e,{objectIdField:o}=n,s=l[o];return{text:k(e,t.suggestionTemplate,r),key:s,sourceIndex:i}}function N(e,t,i,r){return e.features.map((e=>C(e,t,i,r)))}function U(e,t,i,r,l,s,c){const d=e.clone(),f=e.sourceLayer,g=f&&f.objectIdField,p=g&&e.attributes[g],y=k(e,i.searchTemplate,l),m=a.createExtentFromGeometry(d.geometry,t,s),h="number"==typeof c?a.scaleExtent(n.clone(m),t,c):m,F=e.clone();return o.isSome(h)&&(F.geometry=u.fromExtent(h)),{extent:h,target:F,feature:d,key:p,name:y,sourceIndex:r}}function B(e,t,i,r,n,l,o){return e.features.map((e=>U(e,t,i,r,n,l,o)))}e.getResults=y,e.getSuggestions=m,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
