/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../intl","../../../core/Error","../../../core/lang","../../../core/Logger","../../../core/maybe","../../../core/unitUtils","../../../geometry/Polygon","../../../rest/support/FullTextSearch","./geometryUtils","../../../intl/substitute","../../../intl/date"],(function(e,t,r,i,n,l,s,o,u,a,c,d,f){"use strict";const g=/https?:\/\/services.*\.arcgis\.com/i,p=/(?:\{([^}]+)\})/g,y=l.getLogger("esri.widgets.Search.support.layerSearchUtils");function h(e,t){const{exactMatch:r=!1,location:n,maxResults:l,spatialReference:s,source:u,sourceIndex:a,suggestResult:c,view:d}=e,{layer:f,filter:g,zoomScale:p}=u,h=d&&d.scale,m=F(u,d),w=t&&t.signal;return v(f).then((()=>{const e=f.popupTemplate;return e?e.getRequiredFields(f.fieldsIndex):null})).then((e=>{const{objectIdField:t,returnZ:F}=f,v=R(u);if(!M(f,v))throw y.error("invalid-field: displayField is invalid."),new i("getResults():invalid-field","displayField is invalid.");const L=e&&e.length?e:[v],j=u.outFields||L,q=x(j);j.includes(t)||q||j.push(t),f.floorInfo?.floorField&&j.push(f.floorInfo.floorField);if(!(q||E(f,j)))throw y.error("invalid-field: outField is invalid."),new i("getResults():invalid-field","outField is invalid.");const D=f.createQuery(),{orderByFields:k}=u;if(k&&(D.orderByFields=k),s){D.outSpatialReference=s;const e=1/o.getMetersPerUnitForSR(s);e&&(D.maxAllowableOffset=e)}const N="mesh"===f.geometryType||"multipatch"===f.geometryType,B=f.capabilities?.data?.supportsZ&&!N;if(D.returnZ=B&&!1!==F,D.returnGeometry=!0,D.multipatchOption=N?"xyFootprint":null,j&&(D.outFields=j),n)D.geometry=n;else if(c.key)D.objectIds=[c.key];else{const e=u.searchFields||[v];if(!E(f,e))throw y.error("invalid-field: search field is invalid."),new i("getResults():invalid-field","search field is invalid.");I(f)&&(D.num=l),m&&(D.geometry=m);if(!c.text.trim())return[];const t=c.text,{prefix:n="",suffix:s=""}=u,o=C(`${n}${t}${s}`);S(f)&&b(f,e)&&!r&&t&&(D.fullText=T({text:t,searchFields:e}));const a=O({searchTerm:o,layer:f,searchFields:e,filter:g,exactMatch:r,query:D,type:"search"});if(D.where=a,!$(D))return[]}return f.queryFeatures(D,{signal:w}).then((e=>Z(e,d,u,a,v,h,p)))}))}function m(e,t){const{source:r,spatialReference:n,view:l,suggestTerm:s,maxSuggestions:o,sourceIndex:u,exactMatch:a}=e,{layer:c,filter:d}=r,f=t&&t.signal,g=F(r,l);return v(c).then((()=>{if(!I(c))return[];const e=R(r),t=r.searchFields||[e],l=[];r.suggestionTemplate?r.suggestionTemplate.replace(p,((e,t)=>(l.push(t),e))):l.push(e);const h=x(l);l.includes(c.objectIdField)||h||l.push(c.objectIdField);const m=M(c,e),F=h||E(c,l),v=E(c,t);if(!m)throw y.error("invalid-field: displayField is invalid."),new i("getSuggestions():invalid-field","displayField is invalid.");if(!F)throw y.error("invalid-field: outField is invalid."),new i("getSuggestions():invalid-field","outField is invalid.");if(!v)throw y.error("invalid-field: search field is invalid."),new i("getSuggestions():invalid-field","search field is invalid.");const w=c.createQuery(),{orderByFields:L}=r;L&&(w.orderByFields=L),w.outSpatialReference=n,w.returnGeometry=!1,w.num=o,w.outFields=l,g&&(w.geometry=g);if(!s.trim())return[];const{prefix:j="",suffix:q=""}=r,D=C(`${j}${s}${q}`);S(c)&&b(c,t)&&!a&&s&&(w.fullText=T({text:s,searchFields:t}));const k=O({searchTerm:D,layer:c,searchFields:t,filter:d,exactMatch:a,query:w,type:"suggest"});return w.where=k,$(w)?c.queryFeatures(w,{signal:f}).then((t=>U(t,r,u,e))):[]}))}function F(e,t){const{filter:r,withinViewEnabled:i}=e,n=t&&t.extent;return r&&r.geometry||(i&&n?n:void 0)}function x(e){return e&&e.includes("*")}function v(e){return w.apply(this,arguments)}function w(){return(w=t._asyncToGenerator((function*(e){e&&(yield e.load())}))).apply(this,arguments)}function $(e){return!(!e.fullText&&!e.where)}function b(e,t){const r=e?.indexes;if(!r||!t?.length)return!1;return r.filter((e=>"FullText"===e.indexType)).some((e=>{const r=e.fields?.split(",").map((e=>e.trim().toLowerCase()))||[];return t.every((e=>r.includes(e.toLowerCase())))}))}function T({text:e,searchFields:t}){return e.trim().split(" ").filter((e=>!!e.trim())).map((e=>new a({onFields:t,searchTerm:e,searchType:"prefix"})))}function S(e){return e?.capabilities?.query?.supportsFullTextSearch??!1}function I(e){return e?.capabilities?.query?.supportsPagination??!1}function L(e){return e?.fieldsIndex?.fields?.find((e=>"string"===e.type))?.name??""}function R(e){return e.displayField||e.layer.displayField||L(e.layer)}function E(e,t){return!(!e||!t?.length)&&t.every((t=>M(e,t)))}function M(e,t){return!!e.getField(t)}function j(e){for(let t=0;t<e.length;t++)if(e.charCodeAt(t)>255)return!0;return!1}function q(e,t,r){let i=null;const{codedValues:n}=e;return n&&n.some((e=>{const n=e.name,l=r?n:n.toLowerCase();return(r?t:t.toLowerCase())===l&&(i=e.code.toString(),!0)})),i}function C(e){return e.replace(/\'/g,"''")}function D(e,t){const r=t&&t.where;return r?`(${e}) AND (${r})`:e}function k({currentTerm:e,field:t,filter:r,exactMatch:i,url:n,type:l}){const s=t.type,o=t.name;if("string"===s||"date"===s||"global-id"===s){const t=g.test(n),s=t&&j(e)?"N":"";if(i&&"search"===l)return D(`${o} = ${s}'${e}'`,r);if(t){return D(`${o} LIKE ${s}${`'${e}%'`}`,r)}return D(`${`LOWER(${o})`} LIKE ${s}${`'${e.toLowerCase()}%'`}`,r)}if("oid"===s||"small-integer"===s||"integer"===s||"single"===s||"double"===s){const t=Number(e);return isNaN(t)?null:D(`${o} = ${t}`,r)}return D(`${o} = ${e}`,r)}function N(e,t){return e?` OR (${t})`:`(${t})`}function O({searchTerm:e,layer:t,searchFields:r,filter:i,exactMatch:n,query:l,type:s}){const{definitionExpression:o,url:u}=t;let a="";return!l.fullText&&e&&r&&r.forEach((r=>{const l=t.getField(r),o="function"==typeof t.getFieldDomain&&t.getFieldDomain(r),c=(o&&"coded-value"===o.type?q(o,e,n):null)||e||null;if(null!==c){const e=k({currentTerm:c,field:l,filter:i,exactMatch:n,url:u,type:s});e&&(a+=N(a,e))}})),o&&a?`(${o}) AND (${a})`:o||a}function B(e,t){let r=null;const{codedValues:i}=e;return i&&i.length&&i.some((e=>e.code===t&&(r=e.name,!0))),r}function P(e,t){return e[Object.keys(e).find((e=>e.toLowerCase()===t.toLowerCase()))]}function A(e,t,r){const i=e.sourceLayer,{attributes:n}=e,l="function"==typeof i.getFieldDomain&&i.getFieldDomain(r);if(t)return d.substitute(t,n);if(r&&n){const e=i.getField(r),t=P(n,r);return null==t?"":l&&"coded-value"===l.type?B(l,t):"date"===e?.type?f.formatDate(new Date(t)):"number"==typeof t?t.toString():"string"!=typeof t?"":t.trim()}return""}function G(e,t,r,i){const n=e.sourceLayer,{attributes:l}=e,{objectIdField:s}=n,o=l[s];return{text:A(e,t.suggestionTemplate,i),key:o,sourceIndex:r}}function U(e,t,r,i){return e.features.map((e=>G(e,t,r,i)))}function V(e,t,r,i,l,o,a){const d=e.clone(),f=e.sourceLayer,g=f&&f.objectIdField,p=g&&e.attributes[g],y=A(e,r.searchTemplate,l),h=c.createExtentFromGeometry(d.geometry,t,o),m="number"==typeof a?c.scaleExtent(n.clone(h),t,a):h,F=e.clone();return s.isSome(m)&&(F.geometry=u.fromExtent(m)),{extent:m,target:F,feature:d,key:p,name:y,sourceIndex:i}}function Z(e,t,r,i,n,l,s){return e.features.map((e=>V(e,t,r,i,n,l,s)))}e.createFullTextSearchInfos=T,e.getResults=h,e.getSuggestions=m,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
