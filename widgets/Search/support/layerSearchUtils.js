/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../core/lang","../../../core/maybe","../../../core/Logger","../../../core/Error","../../../core/promiseUtils","../../../geometry/Polygon","../../../intl/date","../../../intl/substitute","../../../intl","../../../core/unitUtils","./geometryUtils"],(function(e,t,i,n,r,o,l,s,u,a,d,c){"use strict";const f=/https?:\/\/services.*\.arcgis\.com/i,g=/(?:\{([^}]+)\})/g,p=n.getLogger("esri.widgets.Search.support.layerSearchUtils");function y(e,t){const{filter:i,withinViewEnabled:n}=e,r=t&&t.extent;return i&&i.geometry||(n&&r?r:void 0)}function m(e){return e&&-1!==e.indexOf("*")}function h(e){return e?e.load().then(o.resolve).catch(o.reject):o.resolve()}function v(e){var t,i,n;return null!=(t=null==e||null==(i=e.capabilities)||null==(n=i.query)?void 0:n.supportsPagination)&&t}function F(e){return e.displayField||e.layer.displayField||function(e){let t="";if(e){const{fields:i}=e;i&&i.some((e=>"string"===e.type&&(t=e.name,!0)))}return t}(e.layer)}function w(e,t){return!(!e||!t)&&t.every((t=>x(e,t)))}function x(e,t){return!!e.getField(t)}function b(e){return e.replace(/\'/g,"''")}function $(e,t){const i=t&&t.where;return i?`(${e}) AND (${i})`:e}function R(e,t,i,n,r){const{definitionExpression:o}=t;let l="";if(e){const o=f.test(t.url)&&function(e){for(let t=0;t<e.length;t++)if(e.charCodeAt(t)>255)return!0;return!1}(e)?"N":"";i&&i.forEach((i=>{const s=t.getField(i),u="function"==typeof t.getFieldDomain&&t.getFieldDomain(i),a=(u&&"coded-value"===u.type?function(e,t,i){let n=null;const{codedValues:r}=e;return r&&r.some((e=>{const r=e.name,o=i?r:r.toLowerCase();return(i?t:t.toLowerCase())===o&&(n=e.code.toString(),!0)})),n}(u,e,r):null)||e||null;if(null!==a){const e=function(e,t,i,n,r){const o=t.type,l=t.name;if("string"===o||"date"===o||"global-id"===o)return $(r?`${l} = ${i}'${e}'`:`UPPER(${l}) LIKE ${i}'%${e.toUpperCase()}%'`,n);if("oid"===o||"small-integer"===o||"integer"===o||"single"===o||"double"===o){const t=Number(e);return isNaN(t)?null:$(`${l} = ${t}`,n)}return $(`${l} = ${e}`,n)}(a,s,o,n,r);e&&(l+=function(e,t){return e?` OR (${t})`:`(${t})`}(l,e))}}))}return o?`(${o}) AND (${l})`:l}function S(e,t,i){const n=e.sourceLayer,{attributes:r}=e,o="function"==typeof n.getFieldDomain&&n.getFieldDomain(i);if(t)return u.substitute(t,r);if(i&&r){const e=n.getField(i),t=(a=i,(l=r)[Object.keys(l).find((e=>e.toLowerCase()===a.toLowerCase()))]);return null==t?"":o&&"coded-value"===o.type?function(e,t){let i=null;const{codedValues:n}=e;return n&&n.length&&n.some((e=>e.code===t&&(i=e.name,!0))),i}(o,t):"date"===(null==e?void 0:e.type)?s.formatDate(new Date(t)):"number"==typeof t?t.toString():"string"!=typeof t?"":t.trim()}var l,a;return""}e.getResults=function(e,n){const{exactMatch:o=!1,location:s,maxResults:u,spatialReference:a,source:f,sourceIndex:g,suggestResult:$,view:I}=e,{layer:L,filter:j,zoomScale:E}=f,D=I&&I.scale,O=y(f,I),T=n&&n.signal;return h(L).then((()=>{const e=L.popupTemplate;return e?e.getRequiredFields(L.fields):null})).then((e=>{var n,y;const{objectIdField:h,returnZ:U}=L,C=F(f);if(!x(L,C))throw p.error("invalid-field: displayField is invalid."),new r("getResults():invalid-field","displayField is invalid.");const N=e&&e.length?e:[C],P=f.outFields||N,k=m(P);-1!==P.indexOf(h)||k||P.push(h);if(!(k||w(L,P)))throw p.error("invalid-field: outField is invalid."),new r("getResults():invalid-field","outField is invalid.");const q=L.createQuery(),{orderByFields:A}=f;if(A&&(q.orderByFields=A),a){q.outSpatialReference=a;const e=1/d.getMetersPerUnitForSR(a);e&&(q.maxAllowableOffset=e)}const B="mesh"===L.geometryType||"multipatch"===L.geometryType,G=(null==(n=L.capabilities)||null==(y=n.data)?void 0:y.supportsZ)&&!B;if(q.returnZ=G&&!1!==U,q.returnGeometry=!0,q.multipatchOption=B?"xyFootprint":null,P&&(q.outFields=P),s)q.geometry=s;else if($.key)q.objectIds=[parseInt($.key,10)];else{const e=f.searchFields||[C];if(!w(L,e))throw p.error("invalid-field: search field is invalid."),new r("getResults():invalid-field","search field is invalid.");v(L)&&(q.num=u),O&&(q.geometry=O);if(!$.text.trim())return[];const{prefix:t="",suffix:i=""}=f,n=R(b(`${t}${$.text}${i}`),L,e,j,o);if(!n)return[];q.where=n}return L.queryFeatures(q,{signal:T}).then((e=>function(e,n,r,o,s,u,a){return e.features.map((e=>function(e,n,r,o,s,u,a){const d=e.clone(),f=e.sourceLayer,g=f&&f.objectIdField,p=g&&e.attributes[g],y=S(e,r.searchTemplate,s),m=c.createExtentFromGeometry(d.geometry,n,u),h="number"==typeof a?c.scaleExtent(t.clone(m),n,a):m,v=e.clone();i.isSome(h)&&(v.geometry=l.fromExtent(h));return{extent:h,target:v,feature:d,key:p,name:y,sourceIndex:o}}(e,n,r,o,s,u,a)))}(e,I,f,g,C,D,E)))}))},e.getSuggestions=function(e,t){const{source:i,spatialReference:n,view:o,suggestTerm:l,maxSuggestions:s,sourceIndex:u}=e,{layer:a,filter:d}=i,c=t&&t.signal,f=y(i,o);return h(a).then((()=>{if(!v(a))return[];const e=F(i),t=i.searchFields||[e],o=[];i.suggestionTemplate?i.suggestionTemplate.replace(g,((e,t)=>(o.push(t),e))):o.push(e);const y=m(o);-1!==o.indexOf(a.objectIdField)||y||o.push(a.objectIdField);const h=x(a,e),$=y||w(a,o),I=w(a,t);if(!h)throw p.error("invalid-field: displayField is invalid."),new r("getSuggestions():invalid-field","displayField is invalid.");if(!$)throw p.error("invalid-field: outField is invalid."),new r("getSuggestions():invalid-field","outField is invalid.");if(!I)throw p.error("invalid-field: search field is invalid."),new r("getSuggestions():invalid-field","search field is invalid.");const L=a.createQuery(),{orderByFields:j}=i;j&&(L.orderByFields=j),L.outSpatialReference=n,L.returnGeometry=!1,L.num=s,L.outFields=o,f&&(L.geometry=f);if(!l.trim())return[];const{prefix:E="",suffix:D=""}=i,O=R(b(`${E}${l}${D}`),a,t,d,!1);return O?(L.where=O,a.queryFeatures(L,{signal:c}).then((t=>function(e,t,i,n){return e.features.map((e=>function(e,t,i,n){const r=e.sourceLayer,{attributes:o}=e,{objectIdField:l}=r,s=o[l];return{text:S(e,t.suggestionTemplate,n),key:s,sourceIndex:i}}(e,t,i,n)))}(t,i,u,e)))):[]}))},Object.defineProperty(e,"__esModule",{value:!0})}));
