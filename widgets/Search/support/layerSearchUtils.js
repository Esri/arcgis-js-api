/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../core/lang","../../../core/maybe","../../../core/Logger","../../../core/Error","../../../geometry/Polygon","../../../intl/date","../../../intl/substitute","../../../intl","../../../core/unitUtils","./geometryUtils"],(function(e,t,i,n,r,o,l,s,u,a,d){"use strict";const c=/https?:\/\/services.*\.arcgis\.com/i,f=/(?:\{([^}]+)\})/g,g=n.getLogger("esri.widgets.Search.support.layerSearchUtils");function p(e,t){const{exactMatch:i=!1,location:n,maxResults:o,spatialReference:l,source:s,sourceIndex:u,suggestResult:d,view:c}=e,{layer:f,filter:p,zoomScale:y}=s,w=c&&c.scale,R=m(s,c),S=t&&t.signal;return v(f).then((()=>{const e=f.popupTemplate;return e?e.getRequiredFields(f.fields):null})).then((e=>{var t,m;const{objectIdField:v,returnZ:L}=f,E=x(s);if(!$(f,E))throw g.error("invalid-field: displayField is invalid."),new r("getResults():invalid-field","displayField is invalid.");const j=e&&e.length?e:[E],O=s.outFields||j,T=h(O);-1!==O.indexOf(v)||T||O.push(v);if(!(T||b(f,O)))throw g.error("invalid-field: outField is invalid."),new r("getResults():invalid-field","outField is invalid.");const C=f.createQuery(),{orderByFields:N}=s;if(N&&(C.orderByFields=N),l){C.outSpatialReference=l;const e=1/a.getMetersPerUnitForSR(l);e&&(C.maxAllowableOffset=e)}const P="mesh"===f.geometryType||"multipatch"===f.geometryType,U=(null==(t=f.capabilities)||null==(m=t.data)?void 0:m.supportsZ)&&!P;if(C.returnZ=U&&!1!==L,C.returnGeometry=!0,C.multipatchOption=P?"xyFootprint":null,O&&(C.outFields=O),n)C.geometry=n;else if(d.key)C.objectIds=[parseInt(d.key,10)];else{const e=s.searchFields||[E];if(!b(f,e))throw g.error("invalid-field: search field is invalid."),new r("getResults():invalid-field","search field is invalid.");F(f)&&(C.num=o),R&&(C.geometry=R);if(!d.text.trim())return[];const{prefix:t="",suffix:n=""}=s,l=D(I(`${t}${d.text}${n}`),f,e,p,i);if(!l)return[];C.where=l}return f.queryFeatures(C,{signal:S}).then((e=>k(e,c,s,u,E,w,y)))}))}function y(e,t){const{source:i,spatialReference:n,view:o,suggestTerm:l,maxSuggestions:s,sourceIndex:u}=e,{layer:a,filter:d}=i,c=t&&t.signal,p=m(i,o);return v(a).then((()=>{if(!F(a))return[];const e=x(i),t=i.searchFields||[e],o=[];i.suggestionTemplate?i.suggestionTemplate.replace(f,((e,t)=>(o.push(t),e))):o.push(e);const y=h(o);-1!==o.indexOf(a.objectIdField)||y||o.push(a.objectIdField);const m=$(a,e),v=y||b(a,o),w=b(a,t);if(!m)throw g.error("invalid-field: displayField is invalid."),new r("getSuggestions():invalid-field","displayField is invalid.");if(!v)throw g.error("invalid-field: outField is invalid."),new r("getSuggestions():invalid-field","outField is invalid.");if(!w)throw g.error("invalid-field: search field is invalid."),new r("getSuggestions():invalid-field","search field is invalid.");const R=a.createQuery(),{orderByFields:S}=i;S&&(R.orderByFields=S),R.outSpatialReference=n,R.returnGeometry=!1,R.num=s,R.outFields=o,p&&(R.geometry=p);if(!l.trim())return[];const{prefix:L="",suffix:E=""}=i,j=D(I(`${L}${l}${E}`),a,t,d,!1);return j?(R.where=j,a.queryFeatures(R,{signal:c}).then((t=>P(t,i,u,e)))):[]}))}function m(e,t){const{filter:i,withinViewEnabled:n}=e,r=t&&t.extent;return i&&i.geometry||(n&&r?r:void 0)}function h(e){return e&&-1!==e.indexOf("*")}async function v(e){e&&await e.load()}function F(e){var t,i,n;return null!=(t=null==e||null==(i=e.capabilities)||null==(n=i.query)?void 0:n.supportsPagination)&&t}function w(e){let t="";if(e){const{fields:i}=e;i&&i.some((e=>"string"===e.type&&(t=e.name,!0)))}return t}function x(e){return e.displayField||e.layer.displayField||w(e.layer)}function b(e,t){return!(!e||!t)&&t.every((t=>$(e,t)))}function $(e,t){return!!e.getField(t)}function R(e){for(let t=0;t<e.length;t++)if(e.charCodeAt(t)>255)return!0;return!1}function S(e,t,i){let n=null;const{codedValues:r}=e;return r&&r.some((e=>{const r=e.name,o=i?r:r.toLowerCase();return(i?t:t.toLowerCase())===o&&(n=e.code.toString(),!0)})),n}function I(e){return e.replace(/\'/g,"''")}function L(e,t){const i=t&&t.where;return i?`(${e}) AND (${i})`:e}function E(e,t,i,n,r){const o=t.type,l=t.name;if("string"===o||"date"===o||"global-id"===o){if(r)return L(`${l} = ${i}'${e}'`,n);return L(`UPPER(${l}) LIKE ${i}'%${e.toUpperCase()}%'`,n)}if("oid"===o||"small-integer"===o||"integer"===o||"single"===o||"double"===o){const t=Number(e);return isNaN(t)?null:L(`${l} = ${t}`,n)}return L(`${l} = ${e}`,n)}function j(e,t){return e?` OR (${t})`:`(${t})`}function D(e,t,i,n,r){const{definitionExpression:o}=t;let l="";if(e){const o=c.test(t.url)&&R(e)?"N":"";i&&i.forEach((i=>{const s=t.getField(i),u="function"==typeof t.getFieldDomain&&t.getFieldDomain(i),a=(u&&"coded-value"===u.type?S(u,e,r):null)||e||null;if(null!==a){const e=E(a,s,o,n,r);e&&(l+=j(l,e))}}))}return o?`(${o}) AND (${l})`:l}function O(e,t){let i=null;const{codedValues:n}=e;return n&&n.length&&n.some((e=>e.code===t&&(i=e.name,!0))),i}function T(e,t){return e[Object.keys(e).find((e=>e.toLowerCase()===t.toLowerCase()))]}function C(e,t,i){const n=e.sourceLayer,{attributes:r}=e,o="function"==typeof n.getFieldDomain&&n.getFieldDomain(i);if(t)return s.substitute(t,r);if(i&&r){const e=n.getField(i),t=T(r,i);return null==t?"":o&&"coded-value"===o.type?O(o,t):"date"===(null==e?void 0:e.type)?l.formatDate(new Date(t)):"number"==typeof t?t.toString():"string"!=typeof t?"":t.trim()}return""}function N(e,t,i,n){const r=e.sourceLayer,{attributes:o}=e,{objectIdField:l}=r,s=o[l];return{text:C(e,t.suggestionTemplate,n),key:s,sourceIndex:i}}function P(e,t,i,n){return e.features.map((e=>N(e,t,i,n)))}function U(e,n,r,l,s,u,a){const c=e.clone(),f=e.sourceLayer,g=f&&f.objectIdField,p=g&&e.attributes[g],y=C(e,r.searchTemplate,s),m=d.createExtentFromGeometry(c.geometry,n,u),h="number"==typeof a?d.scaleExtent(t.clone(m),n,a):m,v=e.clone();return i.isSome(h)&&(v.geometry=o.fromExtent(h)),{extent:h,target:v,feature:c,key:p,name:y,sourceIndex:l}}function k(e,t,i,n,r,o,l){return e.features.map((e=>U(e,t,i,n,r,o,l)))}e.getResults=p,e.getSuggestions=y,Object.defineProperty(e,"__esModule",{value:!0})}));
