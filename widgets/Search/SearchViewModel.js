/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/has","../../config","../../core/maybe","../../core/Logger","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/subclass","../../core/Error","../../core/urlUtils","../../core/uuid","../../portal/support/resourceExtension","../../core/promiseUtils","../../core/Accessor","../../geometry/SpatialReference","../../geometry/Point","../../core/Evented","../../core/Collection","../../intl/locale","../../PopupTemplate","../../symbols/SimpleLineSymbol","../../intl/messages","../../assets","../../portal/Portal","../../symbols/PictureMarkerSymbol","../../symbols/SimpleFillSymbol","../../symbols/SimpleMarkerSymbol","../../symbols/TextSymbol","../../Graphic","../../core/Handles","../../core/watchUtils","../../views/support/layerViewUtils","../support/GoTo","../../chunks/location","./SearchSource","./support/geometryUtils","./LayerSearchSource","./support/locatorUtils","./LocatorSearchSource","../support/geolocationUtils"],(function(e,t,r,o,s,n,i,l,a,u,c,p,h,d,g,y,m,_,f,S,v,w,b,x,I,P,T,L,R,E,G,C,A,F,O,k,D,N,M,j,B){"use strict";function V(e,t){return e.hasOwnProperty(t)&&null!=e[t]&&""!==e[t]}const J=()=>b.fetchMessageBundle("esri/widgets/Search/t9n/Search"),U="esri.widgets.Search.SearchViewModel",W=n.getLogger(U),H="highlight",z=f.ofType({key:e=>e.layer?"layer":"locator",base:k,typeMap:{layer:N,locator:j}}),Q=y.WGS84,Z="esri/images/search/search-symbol-32.svg",q="esri/images/search/search-symbol-32.png",K=/<(?:.|\s)*?>/g,X=-1;let Y=function(t){function n(e){var o;return(o=t.call(this,e)||this)._handles=new G,o._gotoController=null,o._searching=null,o.autoNavigate=!0,o.autoSelect=!0,o.defaultPopupTemplate=null,o.defaultSources=new z,o.defaultSymbol=new P({url:x.getAssetUrl(r("trident")?q:Z),size:24,width:24,height:24}),o.includeDefaultSources=!0,o.maxInputLength=128,o.maxResults=6,o.maxSuggestions=6,o.messages=null,o.minSuggestCharacters=1,o.popupEnabled=!0,o.popupTemplate=null,o.portal=I.getDefault(),o.resultCount=null,o.resultGraphicEnabled=!0,o.resultGraphic=null,o.results=null,o.selectedSuggestion=null,o.searchAllEnabled=!0,o.selectedResult=null,o.sources=new z,o.suggestionDelay=150,o.suggestionCount=null,o.suggestions=null,o.suggestionsEnabled=!0,o.view=null,o}e._inheritsLoose(n,t);var i=n.prototype;return i.initialize=function(){const e=async()=>{const e=await J();this.messages=e,this.defaultPopupTemplate=new v({title:e.searchResult,content:"{Match_addr}"})};e(),this._handles.add([C.on(this,["defaultSources","sources"],"change",(()=>this.notifyChange("allSources"))),C.init(this,["includeDefaultSources","view","portal"],(()=>this._update())),S.onLocaleChange(e)])},i.destroy=function(){this._abortGoTo(),this.clearGraphics(),this._handles.destroy(),this._handles=null},i.clear=function(){this.searchTerm=""},i.clearGraphics=function(){this._removeHighlight(),this._closePopup(),this.view&&this.view.graphics.remove(this.resultGraphic),this._set("resultGraphic",null)},i.search=function(e,t){this.emit("search-start"),this.clearGraphics();const r=this._createSuggestionForSearch(e),o=this.when().then((()=>this._getResultsFromSources(r,t).then((e=>{const t={activeSourceIndex:this.activeSourceIndex,searchTerm:r.text,numResults:0,numErrors:0,errors:[],results:[]};this._formatResponse(t,e,r);const o=this._getFirstResult(t.results),s=(r.location&&o?o.name:r.text).replace(K,"");return this._set("searchTerm",s),(r.key&&"number"==typeof r.sourceIndex||r.location)&&this._set("selectedSuggestion",r),this._set("results",t.results),this._set("resultCount",t.results.reduce(((e,t)=>e+t.results.length),0)),this.emit("search-complete",t),this._selectFirstResult(o).then((()=>t))})))).then((e=>(this._clearSearching(),e)),(e=>{throw this._clearSearching(),e}));return this._searching=o,this.notifyChange("state"),o},i.searchNearby=function(e){if(!this.locationEnabled){const e=new u("searchNearby:geolocation-unsupported","Geolocation API is unsupported.",{geolocation:navigator.geolocation});return W.error(e),Promise.reject(e)}const t=B.getCurrentPosition().then((t=>B.positionToPoint({position:t,view:this.view},e))).then((t=>this.search(t,e)));return this._searching=t,this.notifyChange("state"),t.catch((()=>{})).then((()=>this._clearSearching())),t},i.select=function(e){if(this.clearGraphics(),!e){const t=new u("select:missing-parameter","Cannot select without a searchResult.",{searchResult:e});return W.error(t),Promise.reject(t)}const{view:t}=this,r=V(e,"sourceIndex")?e.sourceIndex:this._getSourceIndexOfResult(e),o=this.allSources.getItemAt(r);if(!o){const e=new u("select:missing-source","Cannot select without a source.",{source:o});return W.error(e),Promise.reject(e)}const n=o instanceof N?this._getLayerSourcePopupTemplate(o):o.popupTemplate,i=o.resultSymbol||this._getDefaultSymbol(e),l=V(o,"resultGraphicEnabled")?o.resultGraphicEnabled:this.resultGraphicEnabled,a=V(o,"autoNavigate")?o.autoNavigate:this.autoNavigate,c=V(o,"popupEnabled")?o.popupEnabled:this.popupEnabled,p=c?n||this.popupTemplate||this.defaultPopupTemplate:null,{feature:h}=e;if(!h){const e=new u("select:missing-feature","Cannot select without a feature.",{feature:h});return W.error(e),Promise.reject(e)}const{attributes:g,geometry:y,layer:m,sourceLayer:_}=h,f=D.getPointFromGeometry(y),S={layerViewQuery:this._getLayerView(h),elevationQuery:t&&s.isSome(f)?D.getPointWithElevation(f,t).catch((()=>f)):Promise.resolve(f)};return d.eachAlways(S).then((n=>{const u=n.layerViewQuery.value,d=n.elevationQuery.value;i instanceof R&&(i.text=e.name);const f=t&&a?e.target||e.extent:null;return(s.isSome(f)?this._goToSearchResult(f):Promise.resolve()).then((()=>{var s;const n=u?h:new E({geometry:y,symbol:i,attributes:g,layer:m,sourceLayer:_,popupTemplate:p}),a=c&&(null==(s=this.view)?void 0:s.popup),f=a&&n.getEffectivePopupTemplate(a.defaultPopupTemplateEnabled);return f&&t.popup.open({features:[n],location:d}),u&&A.highlightsSupported(u)&&!f&&this._highlightFeature({graphic:n,layerView:u}),!u&&l&&t&&t.graphics.push(n),this._set("selectedResult",e),this._set("resultGraphic",n),this.emit("select-result",{result:e,source:o,sourceIndex:r}),e}))}))},i.suggest=function(e,t,r){const o=e||this.searchTerm;return this.emit("suggest-start",{searchTerm:o}),this._suggestTimer(t,r).then((()=>this._suggestImmediate(o,r).then((e=>(this._set("suggestions",e.results),this._set("suggestionCount",e.results.reduce(((e,t)=>e+t.results.length),0)),this.emit("suggest-complete",e),e)))))},i.when=async function(){await C.whenFalseOnce(this,"updating")},i._update=async function(){const{portal:e,view:t}=this;if(this.includeDefaultSources){const r=this._updatingPromise=d.eachAlways([null==e?void 0:e.load(),null==t?void 0:t.when()]);if(this.destroyed)return;if(this.notifyChange("updating"),await r,r!==this._updatingPromise)return}this._updatingPromise=null,this.notifyChange("updating");const r=C.whenOnce(this,"messages");this.destroyed||(this._handles.add(r),await r,this._updateDefaultSources())},i._clearSearching=function(){this._searching=null,this.notifyChange("state")},i._convertHelperServices=function(){var e,t;const r=null==(e=this.portal)||null==(t=e.helperServices)?void 0:t.geocode;if(!r)return[];return r.map((e=>{var t;if(!1===e.placefinding)return;const r=o.apiKey&&M.isArcGISWorldGeocoder(e.url)?{url:"https://geocode-api.arcgis.com/arcgis/rest/services/World/GeocodeServer"}:null,s=j.fromJSON({...e,...r}),n=null==(t=s.locator)?void 0:t.url;if(M.isArcGISWorldGeocoder(n)||M.isProxiedArcGISWorldGeocoder(n)||M.isMeteredArcGISWorldGeocoder(n)){const e=s.outFields||["Addr_type","Match_addr","StAddr","City"],t=s.placeholder||this.messages.placeholder,r="number"==typeof s.defaultZoomScale?s.defaultZoomScale:2500;s.set({singleLineFieldName:"SingleLine",outFields:e,placeholder:t,defaultZoomScale:r})}return s.singleLineFieldName?s:void 0})).filter(Boolean)},i._getLayerSources=function(e,t){var r;const o=null==(r=this.view)?void 0:r.map;return e.map((e=>{const r=o.findLayerById(e.id);if(!r)return;const s=this._getLayerJSON(e),n=N.fromJSON(s);return n.placeholder=t,this._getLayer(r,s).then((e=>{n.layer=e})),n})).filter(Boolean).toArray()},i._getTableSources=function(e,t){var r;const o=null==(r=this.view)?void 0:r.map;return e.map((e=>{const r=o.findTableById(e.id);if(!r)return;const s=this._getLayerJSON(e),n=N.fromJSON(s);return n.placeholder=t,this._getLayer(r,s).then((e=>{n.layer=e})),n})).filter(Boolean).toArray()},i._convertApplicationProperties=function(){var e,t,r;const o=null==(e=this.view)?void 0:e.map,s=null==o||null==(t=o.applicationProperties)||null==(r=t.viewing)?void 0:r.search;if(!s)return[];const{enabled:n,hintText:i,layers:l,tables:a}=s;if(!n)return[];return[...this._getLayerSources(l,i),...this._getTableSources(a,i)]},i._getSubLayer=function(e,t){return e.load().then((()=>{if(!e.allSublayers)return Promise.reject();const r=e.allSublayers.find((e=>e.id===t.subLayer));return r?r.createFeatureLayer():Promise.reject()}))},i._getBuildingSubLayer=async function(e,t){await e.load();const r=e.allSublayers.find((e=>e.id===t.subLayer));return"building-component"!==(null==r?void 0:r.type)?Promise.reject():(await r.load(),null==r.associatedLayer?Promise.reject():(await r.associatedLayer.load(),r))},i._getLayer=function(e,t){return"feature"===e.type||"scene"===e.type||"csv"===e.type||"geojson"===e.type||"ogc-feature"===e.type?Promise.resolve(e):"map-image"===e.type?this._getSubLayer(e,t).catch((()=>{const t=new u("search:create-featurelayer","Could not create a FeatureLayer from the MapImageLayer",{layer:e});return W.error(t),null})):"building-scene"===e.type?this._getBuildingSubLayer(e,t):Promise.resolve(null)},i._getLayerJSON=function(e){return"function"==typeof e.toJSON?e.toJSON():e},i._updateDefaultSources=function(){const{defaultSources:e,includeDefaultSources:t}=this;e.removeAll(),t&&e.addMany([...this._convertApplicationProperties(),...this._convertHelperServices()]),this.notifyChange("allSources")},i._abortGoTo=function(){this._gotoController&&this._gotoController.abort(),this._gotoController=null},i._clear=function(){this._abortGoTo(),this._set("resultCount",null),this._set("results",null),this._set("suggestions",null),this._set("suggestionCount",null),this._set("selectedResult",null),this._set("selectedSuggestion",null),this.emit("search-clear")},i._closePopup=function(){var e;const t=null==(e=this.view)?void 0:e.popup,{resultGraphic:r}=this;if(!t||!r)return;const{selectedFeature:o}=t;o&&o===r&&t.close()},i._suggestTimer=function(e,t){const r=null!=e?e:this.suggestionDelay;return d.after(r,null,t&&t.signal)},i._createLocationForSearch=function(e){return e instanceof E?D.getPointFromGeometry(e.geometry):e instanceof m?e:Array.isArray(e)&&2===e.length?new m({longitude:e[0],latitude:e[1]}):null},i._createSuggestionForSearch=function(e){if(e&&V(e,"key")&&V(e,"text")&&V(e,"sourceIndex"))return e;const t=this._createLocationForSearch(e),r="string"==typeof e?e:this.searchTerm,{selectedSuggestion:o,selectedResult:n}=this,i=!e&&o&&n,l=i&&o.key===n.key&&o.sourceIndex===n.sourceIndex,a=i&&o.location;return l||a?o:{location:s.unwrap(t),text:t?"":r,sourceIndex:null,key:null}},i._getFirstResult=function(e){let t=null;return e&&e.some((e=>{const{results:r}=e,o=r[0],s=!!o;return s&&(t=o),s})),t},i._selectFirstResult=function(e){return this.autoSelect&&e?this.select(e):Promise.resolve(null)},i._suggestImmediate=function(e,t){return this.when().then((()=>this._getSuggestionsFromSources(e,t))).then((t=>{const r={activeSourceIndex:this.activeSourceIndex,searchTerm:e,numResults:0,numErrors:0,errors:[],results:[]};return this._formatResponse(r,t),r}))},i._formatSourceResponse=function(e,t,r){const o=t&&t.value||[],s=t&&t.error,n=this.allSources.getItemAt(r);if(s){const t={sourceIndex:r,source:n,error:s};e.errors.push(t),e.numErrors++}else{const t={sourceIndex:r,source:n,results:o};e.results.push(t),e.numResults+=o.length}},i._formatResponse=function(e,t,r){if(t)if(e.activeSourceIndex===X){const o=r&&V(r,"sourceIndex")&&-1!==r.sourceIndex?r.sourceIndex:void 0;t.forEach(((t,r)=>{const s=void 0!==o?o:r;this._formatSourceResponse(e,t,s)}))}else this._formatSourceResponse(e,t[0],e.activeSourceIndex)},i._getResultsFromSources=function(e,t){const{allSources:r}=this,o=!e.location&&V(e,"sourceIndex")?e.sourceIndex:this.activeSourceIndex,s=[];if(!r.length){const e=new u("search:no-sources-defined","At least one source is required.",{allSources:r});return W.error(e),Promise.reject(e)}return o===X?r.forEach(((r,o)=>{s.push(this._getResultsFromSource(e,o,t))})):s.push(this._getResultsFromSource(e,o,t)),d.eachAlways(s)},i._getSuggestionsFromSources=function(e,t){const{allSources:r,activeSourceIndex:o}=this,s=[];if(!r.length){const e=new u("suggest:no-sources-defined","At least one source is required.",{allSources:r});return W.error(e),Promise.reject(e)}return o===X?r.forEach(((r,o)=>{s.push(this._getSuggestionsFromSource(e,o,t))})):s.push(this._getSuggestionsFromSource(e,o,t)),d.eachAlways(s)},i._getResultsFromSource=function(e,t,r){var o;const s=this.allSources.getItemAt(t),{location:n=null}=e,i=(null==(o=this.view)?void 0:o.spatialReference)||Q,l=V(s,"maxResults")?s.maxResults:this.maxResults,a=!!(s instanceof N&&V(s,"exactMatch"))&&s.exactMatch,{view:u}=this;return s.getResults({view:u,sourceIndex:t,location:n,suggestResult:e,spatialReference:i,exactMatch:a,maxResults:l},r)},i._getSuggestionsFromSource=function(e,t,r){const o=this.allSources.getItemAt(t),s=V(o,"suggestionsEnabled")?o.suggestionsEnabled:this.suggestionsEnabled,n=e.length,i=V(o,"minSuggestCharacters")?o.minSuggestCharacters:this.minSuggestCharacters;if(s&&e.trim()&&n>=i){var l;const s=(null==(l=this.view)?void 0:l.spatialReference)||Q,n=V(o,"maxSuggestions")?o.maxSuggestions:this.maxSuggestions,{view:i}=this;return o.getSuggestions({view:i,sourceIndex:t,suggestTerm:e,spatialReference:s,maxSuggestions:n},r)}return Promise.resolve(null)},i.createDefaultSymbol=function(e,t){if("point"===t){const t=e;return new L({color:e.color,size:t.size,outline:{color:t.outline.color,width:t.outline.width}})}if("polyline"===t){const t=e;return new w({color:t.color,width:t.width})}if("polygon"===t){const t=e;return new T({color:t.color,outline:{color:t.outline.color,width:t.outline.width}})}},i._getLayerSourcePopupTemplate=function(e){const{layer:t}=e;if(t)return V(e,"popupTemplate")?e.popupTemplate:t.popupTemplate},i._getSourceIndexOfResult=function(e){const t=this.results;let r=null;return t.some((t=>t.results.some((o=>o===e&&(r=t.sourceIndex,!0))))),r},i._goToSearchResult=async function(e){const t=!!e;this._abortGoTo();const r=d.createAbortController();this._gotoController=r;const o={target:{target:e},options:{animate:t,signal:r.signal}};await this.callGoTo(o),this._gotoController=null},i._getDefaultSymbol=function(e){var t,r,o;const n=null==(t=this.view)||null==(r=t.map)||null==(o=r.basemap)?void 0:o.id,i=s.get(e,"feature","geometry","type");if(s.isSome(i)){const e=O.getSchemes({basemap:n,geometryType:i})||O.getSchemes({basemap:"topo",geometryType:i}),t=e&&e.primaryScheme;if(t)return t.color&&V(t,"opacity")&&(t.color.a=t.opacity),this.createDefaultSymbol(t,i)}return this.defaultSymbol},i._removeHighlight=function(){this._handles.remove(H)},i._getLayerView=async function(e){const{view:t}=this;if(!e||!t||"building-component"===e.layer.type)return Promise.resolve(null);const{layer:r}=e;return await t.when(),t.whenLayerView(r)},i._highlightFeature=function(e){const{graphic:t,layerView:r}=e,{attributes:o,layer:s}=t,{objectIdField:n}=s,i=o&&o[n],l=r.highlight(i||t);this._handles.add(l,H)},e._createClass(n,[{key:"activeSource",get:function(){return this.allSources.getItemAt(this.activeSourceIndex)||null}},{key:"activeSourceIndex",get:function(){return 1===this.allSources.length||!this.searchAllEnabled?0:X},set:function(e){void 0!==e?this._override("activeSourceIndex",e):this._clearOverride("activeSourceIndex")}},{key:"allPlaceholder",get:function(){var e;return null==(e=this.messages)?void 0:e.allPlaceholder},set:function(e){e?this._override("allPlaceholder",e):this._clearOverride("allPlaceholder")}},{key:"allSources",get:function(){const{sources:e,defaultSources:t,includeDefaultSources:r}=this,o="function"==typeof r?r.call(null,{sources:e,defaultSources:t}):r?t.concat(e):e,s=this._get("allSources")||new z;return s.removeAll(),s.addMany(o.filter(Boolean)),s}},{key:"locationEnabled",get:function(){return this._get("locationEnabled")||B.supported()},set:function(e){if(void 0===e)return void this._clearOverride("locationEnabled");const t=B.supported();if(e&&!t){const e=new u("locationEnabled:geolocation-unsupported","Geolocation API is unsupported.",{geolocation:navigator.geolocation});W.error(e)}this._override("locationEnabled",e&&t)}},{key:"placeholder",get:function(){const{allSources:e,activeSourceIndex:t,allPlaceholder:r}=this;if(t===X)return r;const o=e.getItemAt(t);return o?o.placeholder:""}},{key:"searchTerm",get:function(){return this._get("searchTerm")||""},set:function(e){this._set("searchTerm",e||""),this.clearGraphics(),this.selectedSuggestion&&this.selectedSuggestion.text!==e&&this._set("selectedSuggestion",null),""===e&&this._clear()}},{key:"state",get:function(){return this._searching?"searching":this.updating?"loading":0===this.allSources.length?"disabled":"ready"}},{key:"updating",get:function(){return null!=this._updatingPromise}}]),n}(F.GoToMixin(_.EventedMixin(g)));return Y.ALL_INDEX=X,t.__decorate([l.property({readOnly:!0,value:null})],Y.prototype,"activeSource",null),t.__decorate([l.property()],Y.prototype,"activeSourceIndex",null),t.__decorate([l.property()],Y.prototype,"allPlaceholder",null),t.__decorate([l.property({readOnly:!0,dependsOn:["defaultSources.length","sources.length","includeDefaultSources"]})],Y.prototype,"allSources",null),t.__decorate([l.property()],Y.prototype,"autoNavigate",void 0),t.__decorate([l.property()],Y.prototype,"autoSelect",void 0),t.__decorate([l.property()],Y.prototype,"defaultPopupTemplate",void 0),t.__decorate([l.property({readOnly:!0})],Y.prototype,"defaultSources",void 0),t.__decorate([l.property()],Y.prototype,"defaultSymbol",void 0),t.__decorate([l.property()],Y.prototype,"includeDefaultSources",void 0),t.__decorate([l.property()],Y.prototype,"locationEnabled",null),t.__decorate([l.property()],Y.prototype,"maxInputLength",void 0),t.__decorate([l.property()],Y.prototype,"maxResults",void 0),t.__decorate([l.property()],Y.prototype,"maxSuggestions",void 0),t.__decorate([l.property()],Y.prototype,"messages",void 0),t.__decorate([l.property()],Y.prototype,"minSuggestCharacters",void 0),t.__decorate([l.property({readOnly:!0})],Y.prototype,"placeholder",null),t.__decorate([l.property()],Y.prototype,"popupEnabled",void 0),t.__decorate([l.property({type:v})],Y.prototype,"popupTemplate",void 0),t.__decorate([l.property({type:I})],Y.prototype,"portal",void 0),t.__decorate([l.property()],Y.prototype,"resultCount",void 0),t.__decorate([l.property()],Y.prototype,"resultGraphicEnabled",void 0),t.__decorate([l.property({readOnly:!0})],Y.prototype,"resultGraphic",void 0),t.__decorate([l.property({readOnly:!0})],Y.prototype,"results",void 0),t.__decorate([l.property({readOnly:!0})],Y.prototype,"selectedSuggestion",void 0),t.__decorate([l.property()],Y.prototype,"searchAllEnabled",void 0),t.__decorate([l.property({readOnly:!0})],Y.prototype,"selectedResult",void 0),t.__decorate([l.property()],Y.prototype,"searchTerm",null),t.__decorate([l.property({type:z})],Y.prototype,"sources",void 0),t.__decorate([l.property({readOnly:!0,dependsOn:["allSources.length","updating"]})],Y.prototype,"state",null),t.__decorate([l.property()],Y.prototype,"suggestionDelay",void 0),t.__decorate([l.property()],Y.prototype,"suggestionCount",void 0),t.__decorate([l.property({readOnly:!0})],Y.prototype,"suggestions",void 0),t.__decorate([l.property()],Y.prototype,"suggestionsEnabled",void 0),t.__decorate([l.property({readOnly:!0})],Y.prototype,"updating",null),t.__decorate([l.property()],Y.prototype,"view",void 0),t.__decorate([l.property()],Y.prototype,"clear",null),Y=t.__decorate([a.subclass(U)],Y),Y}));
