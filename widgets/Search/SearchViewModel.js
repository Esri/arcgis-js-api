// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../assets","../../Graphic","../../PopupTemplate","../../core/Accessor","../../core/Collection","../../core/Error","../../core/Evented","../../core/geolocationUtils","../../core/Handles","../../core/has","../../core/Logger","../../core/maybe","../../core/promiseUtils","../../core/watchUtils","../../core/accessorSupport/decorators","../../geometry/Point","../../geometry/SpatialReference","../../intl/locale","../../intl/messages","../../portal/Portal","../../smartMapping/symbology/location","../../symbols/PictureMarkerSymbol","../../symbols/SimpleFillSymbol","../../symbols/SimpleLineSymbol","../../symbols/SimpleMarkerSymbol","../../symbols/TextSymbol","../../views/support/layerViewUtils","./LayerSearchSource","./LocatorSearchSource","./SearchSource","./support/geometryUtils","./support/locatorUtils","../support/GoTo"],(function(e,t,r,o,n,s,a,i,l,u,c,p,h,d,g,y,f,_,v,m,S,b,w,x,I,T,P,R,O,E,C,A,L,F,G,j){function D(e,t){return e.hasOwnProperty(t)&&null!=e[t]&&""!==e[t]}var M=d.getLogger("esri.widgets.Search.SearchViewModel"),N=i.ofType({key:function(e){return e.layer?"layer":"locator"},base:L,typeMap:{layer:C,locator:A}}),V=m.WGS84,k=/<(?:.|\s)*?>/g;return function(e){function t(t){var r=e.call(this,t)||this;return r._handles=new p,r._gotoController=null,r._searching=null,r.autoNavigate=!0,r.autoSelect=!0,r.defaultPopupTemplate=null,r.defaultSources=new N,r.defaultSymbol=new I({url:o.getAssetUrl(h("trident")?"esri/images/search/search-symbol-32.png":"esri/images/search/search-symbol-32.svg"),size:24,width:24,height:24}),r.includeDefaultSources=!0,r.maxInputLength=128,r.maxResults=6,r.maxSuggestions=6,r.messages=null,r.minSuggestCharacters=1,r.popupEnabled=!0,r.popupTemplate=null,r.portal=w.getDefault(),r.resultCount=null,r.resultGraphicEnabled=!0,r.resultGraphic=null,r.results=null,r.selectedSuggestion=null,r.searchAllEnabled=!0,r.selectedResult=null,r.sources=new N,r.suggestionDelay=150,r.suggestionCount=null,r.suggestions=null,r.suggestionsEnabled=!0,r.view=null,r}return r.__extends(t,e),t.prototype.initialize=function(){var e=this,t=function(){return r.__awaiter(e,void 0,void 0,(function(){var e;return r.__generator(this,(function(t){switch(t.label){case 0:return[4,b.loadMessageBundle("esri/widgets/Search/t9n/Search")];case 1:return e=t.sent(),this.messages=e,this.defaultPopupTemplate=new s({title:e.searchResult,content:"{Match_addr}"}),[2]}}))}))};t(),this._handles.add([f.on(this,["defaultSources","sources"],"change",(function(){return e.notifyChange("allSources")})),f.init(this,["includeDefaultSources","view","portal"],(function(){return e._update()})),S.onLocaleChange(t)])},t.prototype.destroy=function(){this._abortGoTo(),this.clearGraphics(),this._handles.destroy(),this._handles=null},Object.defineProperty(t.prototype,"activeSource",{get:function(){return this.allSources.getItemAt(this.activeSourceIndex)||null},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activeSourceIndex",{get:function(){return 1===this.allSources.length||!this.searchAllEnabled?0:-1},set:function(e){void 0!==e?this._override("activeSourceIndex",e):this._clearOverride("activeSourceIndex")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"allPlaceholder",{get:function(){var e;return null===(e=this.messages)||void 0===e?void 0:e.allPlaceholder},set:function(e){e?this._override("allPlaceholder",e):this._clearOverride("allPlaceholder")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"allSources",{get:function(){var e=this.sources,t=this.defaultSources,r=this.includeDefaultSources,o="function"==typeof r?r.call(null,{sources:e,defaultSources:t}):r?t.concat(e):e,n=this._get("allSources")||new N;return n.removeAll(),n.addMany(o.filter(Boolean)),n},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"locationEnabled",{get:function(){return this._get("locationEnabled")||c.supported()},set:function(e){if(void 0!==e){var t=c.supported();if(e&&!t){var r=new l("locationEnabled:geolocation-unsupported","Geolocation API is unsupported.",{geolocation:navigator.geolocation});M.error(r)}this._override("locationEnabled",e&&t)}else this._clearOverride("locationEnabled")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"placeholder",{get:function(){var e=this.allSources,t=this.activeSourceIndex,r=this.allPlaceholder;if(-1===t)return r;var o=e.getItemAt(t);return o?o.placeholder:""},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"searchTerm",{get:function(){return this._get("searchTerm")||""},set:function(e){this._set("searchTerm",e||""),this.clearGraphics(),this.selectedSuggestion&&this.selectedSuggestion.text!==e&&this._set("selectedSuggestion",null),""===e&&this._clear()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"state",{get:function(){return this._searching?"searching":this.updating?"loading":0===this.allSources.length?"disabled":"ready"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updating",{get:function(){return null!=this._updatingPromise},enumerable:!0,configurable:!0}),t.prototype.clear=function(){this.searchTerm=""},t.prototype.clearGraphics=function(){this._removeHighlight(),this._closePopup(),this.view&&this.view.graphics.remove(this.resultGraphic),this._set("resultGraphic",null)},t.prototype.search=function(e,t){var r=this;this.emit("search-start"),this.clearGraphics();var o=this._createSuggestionForSearch(e),n=this.when().then((function(){return r._getResultsFromSources(o,t).then((function(e){var t={activeSourceIndex:r.activeSourceIndex,searchTerm:o.text,numResults:0,numErrors:0,errors:[],results:[]};r._formatResponse(t,e,o);var n=r._getFirstResult(t.results),s=(o.location&&n?n.name:o.text).replace(k,"");return r._set("searchTerm",s),(o.key&&"number"==typeof o.sourceIndex||o.location)&&r._set("selectedSuggestion",o),r._set("results",t.results),r._set("resultCount",t.results.reduce((function(e,t){return e+t.results.length}),0)),r.emit("search-complete",t),r._selectFirstResult(n).then((function(){return t}))}))})).then((function(e){return r._clearSearching(),e}),(function(e){throw r._clearSearching(),e}));return this._searching=n,this.notifyChange("state"),n},t.prototype.searchNearby=function(e){var t=this;if(!this.locationEnabled){var r=new l("searchNearby:geolocation-unsupported","Geolocation API is unsupported.",{geolocation:navigator.geolocation});return M.error(r),y.reject(r)}var o=c.getCurrentPosition().then((function(r){return c.positionToPoint({position:r,view:t.view},e)})).then((function(r){return t.search(r,e)}));return this._searching=o,this.notifyChange("state"),o.catch((function(){})).then((function(){return t._clearSearching()})),o},t.prototype.select=function(e){var t=this;if(this.clearGraphics(),!e){var r=new l("select:missing-parameter","Cannot select without a searchResult.",{searchResult:e});return M.error(r),y.reject(r)}var o=this.view,s=D(e,"sourceIndex")?e.sourceIndex:this._getSourceIndexOfResult(e),a=this.allSources.getItemAt(s);if(!a){r=new l("select:missing-source","Cannot select without a source.",{source:a});return M.error(r),y.reject(r)}var i=a instanceof C?this._getLayerSourcePopupTemplate(a):a.popupTemplate,u=a.resultSymbol||this._getDefaultSymbol(e),c=D(a,"resultGraphicEnabled")?a.resultGraphicEnabled:this.resultGraphicEnabled,p=D(a,"autoNavigate")?a.autoNavigate:this.autoNavigate,h=D(a,"popupEnabled")?a.popupEnabled:this.popupEnabled,d=h?i||this.popupTemplate||this.defaultPopupTemplate:null,f=e.feature;if(!f){r=new l("select:missing-feature","Cannot select without a feature.",{feature:f});return M.error(r),y.reject(r)}var _=f.attributes,v=f.geometry,m=f.layer,S=f.sourceLayer,b=F.getPointFromGeometry(v),w={layerViewQuery:this._getLayerView(f),elevationQuery:o&&g.isSome(b)?F.getPointWithElevation(b,o).catch((function(){return b})):y.resolve(b)};return y.eachAlways(w).then((function(r){var i=r.layerViewQuery.value,l=r.elevationQuery.value;u instanceof O&&(u.text=e.name);var b=o&&p?e.target||e.extent:null;return(g.isSome(b)?t._goToSearchResult(b):y.resolve()).then((function(){var r=i?f:new n({geometry:v,symbol:u,attributes:_,layer:m,sourceLayer:S,popupTemplate:d}),p=h&&t.get("view.popup"),g=p&&r.getEffectivePopupTemplate(p.defaultPopupTemplateEnabled);return g&&o.popup.open({features:[r],location:l}),i&&E.highlightsSupported(i)&&!g&&t._highlightFeature({graphic:r,layerView:i}),!i&&c&&o&&o.graphics.push(r),t._set("selectedResult",e),t._set("resultGraphic",r),t.emit("select-result",{result:e,source:a,sourceIndex:s}),e}))}))},t.prototype.suggest=function(e,t,r){var o=this,n=e||this.searchTerm;return this.emit("suggest-start",{searchTerm:n}),this._suggestTimer(t,r).then((function(){return o._suggestImmediate(n,r).then((function(e){return o._set("suggestions",e.results),o._set("suggestionCount",e.results.reduce((function(e,t){return e+t.results.length}),0)),o.emit("suggest-complete",e),e}))}))},t.prototype.when=function(){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){switch(e.label){case 0:return[4,f.whenFalseOnce(this,"updating")];case 1:return e.sent(),[2]}}))}))},t.prototype._update=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t,o,n,s;return r.__generator(this,(function(r){switch(r.label){case 0:return t=(e=this).portal,o=e.view,this.includeDefaultSources?(n=this._updatingPromise=y.eachAlways([null==t?void 0:t.load(),null==o?void 0:o.when()]),this.destroyed?[2]:(this.notifyChange("updating"),[4,n])):[3,2];case 1:if(r.sent(),n!==this._updatingPromise)return[2];r.label=2;case 2:return this._updatingPromise=null,this.notifyChange("updating"),s=f.whenOnce(this,"messages"),this.destroyed?[2]:(this._handles.add(s),[4,s]);case 3:return r.sent(),this._updateDefaultSources(),[2]}}))}))},t.prototype._clearSearching=function(){this._searching=null,this.notifyChange("state")},t.prototype._convertHelperServices=function(){var e=this,t=this.get("portal.helperServices.geocode");return t?t.map((function(t){if(!1!==t.placefinding){var r=A.fromJSON(t);if(G.isArcGISWorldGeocoder(r.get("locator.url"))&&r.set({singleLineFieldName:"SingleLine",outFields:["Addr_type","Match_addr","StAddr","City"],placeholder:e.messages.placeholder,defaultZoomScale:2500}),r.singleLineFieldName)return r}})).filter(Boolean):[]},t.prototype._convertApplicationProperties=function(){var e=this,t=this.get("view.map.applicationProperties.viewing.search"),r=this.get("view.map");if(!r||!t)return[];var o=t.enabled,n=t.hintText,s=t.layers;return o?s.map((function(t){var o=r.findLayerById(t.id);if(o){var s=e._getLayerJSON(t),a=C.fromJSON(s);return a.placeholder=n,e._getLayer(o,s).then((function(e){a.layer=e})),a}})).filter(Boolean).toArray():[]},t.prototype._getSubLayer=function(e,t){if(!e||!e.allSublayers)return y.reject();var r=e.allSublayers.find((function(e){return e.id===t.subLayer}));return r?r.createFeatureLayer():y.reject()},t.prototype._getLayer=function(e,t){var r=this;return"feature"===e.type||"scene"===e.type?y.resolve(e):"map-image"===e.type?e.load().then((function(){return r._getSubLayer(e,t).catch((function(){var t=new l("search:create-featurelayer","Could not create a FeatureLayer from the MapImageLayer",{layer:e});return M.error(t),null}))})):void 0},t.prototype._getLayerJSON=function(e){return"function"==typeof e.toJSON?e.toJSON():e},t.prototype._updateDefaultSources=function(){var e=this.defaultSources,t=this.includeDefaultSources;e.removeAll(),t&&e.addMany(r.__spreadArrays(this._convertApplicationProperties(),this._convertHelperServices())),this.notifyChange("allSources")},t.prototype._abortGoTo=function(){this._gotoController&&this._gotoController.abort(),this._gotoController=null},t.prototype._clear=function(){this._abortGoTo(),this._set("resultCount",null),this._set("results",null),this._set("suggestions",null),this._set("suggestionCount",null),this._set("selectedResult",null),this._set("selectedSuggestion",null),this.emit("search-clear")},t.prototype._closePopup=function(){var e=this.get("view.popup"),t=this.resultGraphic;if(e&&t){var r=e.selectedFeature;r&&r===t&&e.close()}},t.prototype._suggestTimer=function(e,t){var r=null!=e?e:this.suggestionDelay;return y.after(r,null,t&&t.signal)},t.prototype._createLocationForSearch=function(e){return e instanceof n?F.getPointFromGeometry(e.geometry):e instanceof v?e:Array.isArray(e)&&2===e.length?new v({longitude:e[0],latitude:e[1]}):null},t.prototype._createSuggestionForSearch=function(e){if(e&&D(e,"key")&&D(e,"text")&&D(e,"sourceIndex"))return e;var t=this._createLocationForSearch(e),r="string"==typeof e?e:this.searchTerm,o=this.selectedSuggestion,n=this.selectedResult,s=!e&&o&&n,a=s&&o.key===n.key&&o.sourceIndex===n.sourceIndex,i=s&&o.location;return a||i?o:{location:g.unwrap(t),text:t?"":r,sourceIndex:null,key:null}},t.prototype._getFirstResult=function(e){var t=null;return e&&e.some((function(e){var r=e.results[0],o=!!r;return o&&(t=r),o})),t},t.prototype._selectFirstResult=function(e){return this.autoSelect&&e?this.select(e):y.resolve()},t.prototype._suggestImmediate=function(e,t){var r=this;return this.when().then((function(){return r._getSuggestionsFromSources(e,t)})).then((function(t){var o={activeSourceIndex:r.activeSourceIndex,searchTerm:e,numResults:0,numErrors:0,errors:[],results:[]};return r._formatResponse(o,t),o}))},t.prototype._formatSourceResponse=function(e,t,r){var o=t&&t.value||[],n=t&&t.error,s=this.allSources.getItemAt(r);if(n){var a={sourceIndex:r,source:s,error:n};e.errors.push(a),e.numErrors++}else{var i={sourceIndex:r,source:s,results:o};e.results.push(i),e.numResults+=o.length}},t.prototype._formatResponse=function(e,t,r){var o=this;if(t)if(-1===e.activeSourceIndex){var n=r&&D(r,"sourceIndex")&&-1!==r.sourceIndex?r.sourceIndex:void 0;t.forEach((function(t,r){var s=void 0!==n?n:r;o._formatSourceResponse(e,t,s)}))}else this._formatSourceResponse(e,t[0],e.activeSourceIndex)},t.prototype._getResultsFromSources=function(e,t){var r=this,o=this.allSources,n=!e.location&&D(e,"sourceIndex")?e.sourceIndex:this.activeSourceIndex,s=[];if(!o.length){var a=new l("search:no-sources-defined","At least one source is required.",{allSources:o});return M.error(a),y.reject(a)}return-1===n?o.forEach((function(o,n){s.push(r._getResultsFromSource(e,n,t))})):s.push(this._getResultsFromSource(e,n,t)),y.eachAlways(s)},t.prototype._getSuggestionsFromSources=function(e,t){var r=this,o=this.allSources,n=this.activeSourceIndex,s=[];if(!o.length){var a=new l("suggest:no-sources-defined","At least one source is required.",{allSources:o});return M.error(a),y.reject(a)}return-1===n?o.forEach((function(o,n){s.push(r._getSuggestionsFromSource(e,n,t))})):s.push(this._getSuggestionsFromSource(e,n,t)),y.eachAlways(s)},t.prototype._getResultsFromSource=function(e,t,r){var o=this.allSources.getItemAt(t),n=e.location,s=void 0===n?null:n,a=this.get("view.spatialReference")||V,i=D(o,"maxResults")?o.maxResults:this.maxResults,l=!!(o instanceof C&&D(o,"exactMatch"))&&o.exactMatch,u=this.view;return o.getResults({view:u,sourceIndex:t,location:s,suggestResult:e,spatialReference:a,exactMatch:l,maxResults:i},r)},t.prototype._getSuggestionsFromSource=function(e,t,r){var o=this.allSources.getItemAt(t),n=D(o,"suggestionsEnabled")?o.suggestionsEnabled:this.suggestionsEnabled,s=e.length,a=D(o,"minSuggestCharacters")?o.minSuggestCharacters:this.minSuggestCharacters;if(n&&e.trim()&&s>=a){var i=this.get("view.spatialReference")||V,l=D(o,"maxSuggestions")?o.maxSuggestions:this.maxSuggestions,u=this.view;return o.getSuggestions({view:u,sourceIndex:t,suggestTerm:e,spatialReference:i,maxSuggestions:l},r)}return y.resolve()},t.prototype.createDefaultSymbol=function(e,t){if("point"===t){var r=e;return new R({color:e.color,size:r.size,outline:{color:r.outline.color,width:r.outline.width}})}if("polyline"===t){var o=e;return new P({color:o.color,width:o.width})}if("polygon"===t){var n=e;return new T({color:n.color,outline:{color:n.outline.color,width:n.outline.width}})}},t.prototype._getLayerSourcePopupTemplate=function(e){var t=e.layer;if(t)return D(e,"popupTemplate")?e.popupTemplate:t.popupTemplate},t.prototype._getSourceIndexOfResult=function(e){var t=this.results,r=null;return t.some((function(t){return t.results.some((function(o){return o===e&&(r=t.sourceIndex,!0)}))})),r},t.prototype._goToSearchResult=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,o,n;return r.__generator(this,(function(r){switch(r.label){case 0:return t=!!e,this._abortGoTo(),o=y.createAbortController(),this._gotoController=o,n={target:{target:e},options:{animate:t,signal:o.signal}},[4,this.callGoTo(n)];case 1:return r.sent(),this._gotoController=null,[2]}}))}))},t.prototype._getDefaultSymbol=function(e){var t=this.get("view.map.basemap.id"),r=g.get(e,"feature","geometry","type");if(g.isSome(r)){var o=x.getSchemes({basemap:t,geometryType:r})||x.getSchemes({basemap:"topo",geometryType:r}),n=o&&o.primaryScheme;if(n)return n.color&&D(n,"opacity")&&(n.color.a=n.opacity),this.createDefaultSymbol(n,r)}return this.defaultSymbol},t.prototype._removeHighlight=function(){this._handles.remove("highlight")},t.prototype._getLayerView=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,o;return r.__generator(this,(function(r){switch(r.label){case 0:return t=this.view,e&&t?(o=e.layer,[4,t.when()]):[2,y.resolve(null)];case 1:return r.sent(),[2,t.whenLayerView(o)]}}))}))},t.prototype._highlightFeature=function(e){var t=e.graphic,r=e.layerView,o=t.attributes,n=t.layer.objectIdField,s=o&&o[n],a=r.highlight(s||t);this._handles.add(a,"highlight")},t.ALL_INDEX=-1,r.__decorate([_.property({readOnly:!0,dependsOn:["activeSourceIndex","allSources.length"],value:null})],t.prototype,"activeSource",null),r.__decorate([_.property({dependsOn:["allSources.length","searchAllEnabled"]})],t.prototype,"activeSourceIndex",null),r.__decorate([_.property({dependsOn:["messages"]})],t.prototype,"allPlaceholder",null),r.__decorate([_.property({dependsOn:["defaultSources.length","sources.length","includeDefaultSources"],readOnly:!0})],t.prototype,"allSources",null),r.__decorate([_.property()],t.prototype,"autoNavigate",void 0),r.__decorate([_.property()],t.prototype,"autoSelect",void 0),r.__decorate([_.property()],t.prototype,"defaultPopupTemplate",void 0),r.__decorate([_.property({readOnly:!0})],t.prototype,"defaultSources",void 0),r.__decorate([_.property()],t.prototype,"defaultSymbol",void 0),r.__decorate([_.property()],t.prototype,"includeDefaultSources",void 0),r.__decorate([_.property()],t.prototype,"locationEnabled",null),r.__decorate([_.property()],t.prototype,"maxInputLength",void 0),r.__decorate([_.property()],t.prototype,"maxResults",void 0),r.__decorate([_.property()],t.prototype,"maxSuggestions",void 0),r.__decorate([_.property()],t.prototype,"messages",void 0),r.__decorate([_.property()],t.prototype,"minSuggestCharacters",void 0),r.__decorate([_.property({readOnly:!0,dependsOn:["activeSourceIndex","activeSource.placeholder","allPlaceholder","allSources"]})],t.prototype,"placeholder",null),r.__decorate([_.property()],t.prototype,"popupEnabled",void 0),r.__decorate([_.property({type:s})],t.prototype,"popupTemplate",void 0),r.__decorate([_.property({type:w})],t.prototype,"portal",void 0),r.__decorate([_.property()],t.prototype,"resultCount",void 0),r.__decorate([_.property()],t.prototype,"resultGraphicEnabled",void 0),r.__decorate([_.property({readOnly:!0})],t.prototype,"resultGraphic",void 0),r.__decorate([_.property({readOnly:!0})],t.prototype,"results",void 0),r.__decorate([_.property({readOnly:!0})],t.prototype,"selectedSuggestion",void 0),r.__decorate([_.property()],t.prototype,"searchAllEnabled",void 0),r.__decorate([_.property({readOnly:!0})],t.prototype,"selectedResult",void 0),r.__decorate([_.property()],t.prototype,"searchTerm",null),r.__decorate([_.property({type:N})],t.prototype,"sources",void 0),r.__decorate([_.property({readOnly:!0,dependsOn:["allSources.length","updating"]})],t.prototype,"state",null),r.__decorate([_.property()],t.prototype,"suggestionDelay",void 0),r.__decorate([_.property()],t.prototype,"suggestionCount",void 0),r.__decorate([_.property({readOnly:!0})],t.prototype,"suggestions",void 0),r.__decorate([_.property()],t.prototype,"suggestionsEnabled",void 0),r.__decorate([_.property({readOnly:!0})],t.prototype,"updating",null),r.__decorate([_.property()],t.prototype,"view",void 0),r.__decorate([_.property()],t.prototype,"clear",null),t=r.__decorate([_.subclass("esri.widgets.Search.SearchViewModel")],t)}(j.GoToMixin(u.EventedMixin(a)))}));