// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../Color","../core/watchUtils","../core/accessorSupport/decorators","../core/accessorSupport/ensureType","./Histogram","./Slider","./Widget","./HistogramRangeSlider/HistogramRangeSliderViewModel","./smartMapping/support/utils","./support/widget"],(function(e,t,a,r,i,o,n,l,s,d,u,c,p){"use strict";var h="esri-histogram-range-slider",v="esri-histogram-range-slider__slider-container",g="esri-histogram-range-slider__histogram-container",_="esri-histogram-range-slider__range-type--",m="esri-widget",b="esri-disabled";return function(e){function t(t,a){var i=e.call(this,t,a)||this;return i._barElements=[],i._histogram=null,i._slider=null,i.average=null,i.barCreatedFunction=null,i.bins=null,i.dataLines=null,i.dataLineCreatedFunction=null,i.excludedBarColor=new r("#d7e5f0"),i.hasTimeData=null,i.includedBarColor=new r("#599dd4"),i.label=void 0,i.labelFormatFunction=null,i.max=null,i.messages=null,i.min=null,i.precision=4,i.rangeType=null,i.standardDeviation=null,i.standardDeviationCount=1,i.values=null,i.viewModel=new u,i}return a.__extends(t,e),t.prototype.initialize=function(){var e=this,t=this,a=t.average,r=t.bins,o=t.hasTimeData,n=t.max,d=t.min,u=t.viewModel;this._updateBarFill=this._updateBarFill.bind(this),this._histogram=new l({average:a,bins:r,barCreatedFunction:function(t,a){0===t&&(e._barElements=[]),e._barElements.push(a),e._updateBarFill(t,a),e.barCreatedFunction&&e.barCreatedFunction(t,a)},dataLines:this._getDataLines(),dataLineCreatedFunction:function(t,a){e.dataLineCreatedFunction&&e.dataLineCreatedFunction(t,a)},labelFormatFunction:this.labelFormatFunction,layout:"horizontal",max:n,min:d}),this._slider=new s({labelFormatFunction:this.labelFormatFunction,layout:"horizontal",visibleElements:{labels:!0,rangeLabels:!0},rangeLabelInputsEnabled:!o,viewModel:u}),this.own(this._slider.on(["max-change","min-change"],(function(t){return e.emit(t.type,t)})),this._slider.on(["segment-drag","thumb-change","thumb-drag"],(function(t){e._updateBarFills(),e.emit(t.type,t)})),i.watch(this,"bins",(function(){var t=e,a=t._histogram,r=t.bins;if(r&&a.bins){var i=a.bins.length-r.length;e._barElements.splice(-i,i)}else e._barElements=[];a.set({bins:r}),e._updateBarFills(),e.scheduleRender()})),i.watch(this,["max","min","rangeType","values"],(function(){var t=e,a=t._histogram,r=t.max,i=t.min;a.set({max:r,min:i}),e._updateBarFills(),e.scheduleRender()})),i.watch(this,["average","dataLines","standardDeviation","standardDeviationCount"],(function(){var t=e,a=t._histogram,r=t.average;a.set({average:r,dataLines:e._getDataLines()})})),i.watch(this,"labelFormatFunction",(function(){var t=e,a=t._histogram,r=t.labelFormatFunction;a.set({labelFormatFunction:r})})),i.watch(this,"hasTimeData",(function(){e._slider.set({rangeLabelInputsEnabled:!e.hasTimeData})})))},t.prototype.generateWhereClause=function(e){return this.viewModel.generateWhereClause(e)},t.prototype.render=function(){var e=this.rangeType,t=this.viewModel,a=this.label,r=this.classes(h,m,""+_+e,"disabled"===t.state?b:null);return p.tsx("div",{"aria-label":a,class:r},"disabled"===t.state?null:this.renderContent())},t.prototype.renderContent=function(){return[this.renderHistogram(),this.renderSlider()]},t.prototype.renderSlider=function(){return p.tsx("div",{key:this.id+"-slider-container",class:v},this._slider.render())},t.prototype.renderHistogram=function(){return p.tsx("div",{class:g},this._histogram.render())},t.prototype._getDataLines=function(){return a.__spreadArrays(this._getStandardDeviationDataLines(),this.dataLines||[])},t.prototype._getStandardDeviationDataLines=function(){var e=this.average,t=this.standardDeviation,a=this.standardDeviationCount;return c.getDeviationValues(t,e,a).map((function(e){return{value:e}}))},t.prototype._updateBarFills=function(){var e=this;this._barElements.forEach((function(t,a){return e._updateBarFill(a,t)}))},t.prototype._updateBarFill=function(e,t){t.setAttribute("fill",this._getFillForBar(e).toHex())},t.prototype._getFillForBar=function(e){var t=this.bins,a=this.rangeType,r=this.values;if(!(t&&t.length&&a&&r.length))return null;var i=t[e];if(!i)return null;var o=i.maxValue,n=i.minValue,l=o-n;switch(a){case"equal":case"not-equal":return this.includedBarColor;case"less-than":case"at-most":return r[0]>n&&r[0]<o?this._getBlendedColor((r[0]-n)/l):n<r[0]?this.includedBarColor:this.excludedBarColor;case"greater-than":case"at-least":return r[0]>n&&r[0]<o?this._getBlendedColor(1-(r[0]-n)/l):n>r[0]?this.includedBarColor:this.excludedBarColor;case"between":if(2===r.length)return r[0]>n&&r[0]<o?this._getBlendedColor(1-(r[0]-n)/l):r[1]>n&&r[1]<o?this._getBlendedColor((r[1]-n)/l):n>=r[0]&&o<=r[1]?this.includedBarColor:this.excludedBarColor;case"not-between":if(2===r.length)return r[0]>n&&r[0]<o?this._getBlendedColor((r[0]-n)/l):r[1]>n&&r[1]<o?this._getBlendedColor(1-(r[1]-n)/l):n>r[0]&&o<r[1]?this.excludedBarColor:this.includedBarColor;default:return this.includedBarColor}},t.prototype._getBlendedColor=function(e){return r.blendColors(this.excludedBarColor,this.includedBarColor,e)},a.__decorate([o.aliasOf("viewModel.average")],t.prototype,"average",void 0),a.__decorate([o.property(),p.renderable()],t.prototype,"barCreatedFunction",void 0),a.__decorate([o.aliasOf("viewModel.bins")],t.prototype,"bins",void 0),a.__decorate([o.property(),p.renderable()],t.prototype,"dataLines",void 0),a.__decorate([o.property(),p.renderable()],t.prototype,"dataLineCreatedFunction",void 0),a.__decorate([o.property({type:r,json:{type:[n.Integer],write:!0}})],t.prototype,"excludedBarColor",void 0),a.__decorate([o.aliasOf("viewModel.hasTimeData")],t.prototype,"hasTimeData",void 0),a.__decorate([o.property({type:r,json:{type:[n.Integer],write:!0}})],t.prototype,"includedBarColor",void 0),a.__decorate([o.property({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],t.prototype,"label",void 0),a.__decorate([o.aliasOf("viewModel.labelFormatFunction")],t.prototype,"labelFormatFunction",void 0),a.__decorate([o.aliasOf("viewModel.max")],t.prototype,"max",void 0),a.__decorate([o.property(),p.renderable(),p.messageBundle("esri/widgets/HistogramRangeSlider/t9n/HistogramRangeSlider")],t.prototype,"messages",void 0),a.__decorate([o.aliasOf("viewModel.min")],t.prototype,"min",void 0),a.__decorate([o.aliasOf("viewModel.precision")],t.prototype,"precision",void 0),a.__decorate([o.aliasOf("viewModel.rangeType")],t.prototype,"rangeType",void 0),a.__decorate([o.aliasOf("viewModel.standardDeviation")],t.prototype,"standardDeviation",void 0),a.__decorate([o.property(),p.renderable()],t.prototype,"standardDeviationCount",void 0),a.__decorate([p.renderable(),o.aliasOf("viewModel.values")],t.prototype,"values",void 0),a.__decorate([o.property(),p.renderable(["viewModel.average","viewModel.hasTimeData","viewModel.labelFormatFunction","viewModel.max","viewModel.min","viewModel.precision","viewModel.rangeType","viewModel.standardDeviation","viewModel.values"])],t.prototype,"viewModel",void 0),t=a.__decorate([o.subclass("esri.widgets.HistogramRangeSlider")],t)}(d)}));