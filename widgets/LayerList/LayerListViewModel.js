// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../core/Collection","../../core/Evented","../../core/Handles","../../core/watchUtils","../../core/accessorSupport/decorators","./ListItem","./support/layerListUtils"],(function(e,t,i,r,n,o,s,a,l,d){"use strict";var c="view",h="view-layers",p="map-layers",u="layer-views",m="layer-list-mode",y=r.ofType(l);return function(e){function t(t){var i=e.call(this,t)||this;return i._handles=new o,i.listItemCreatedFunction=null,i.operationalItems=new y,i.view=null,i}return i.__extends(t,e),t.prototype.initialize=function(){var e=this;this._handles.add(s.init(this,["view","view.ready"],(function(){return e._viewHandles()})),c)},t.prototype.destroy=function(){this._handles.destroy(),this._handles=null,this.view=null,this.operationalItems.removeAll()},Object.defineProperty(t.prototype,"state",{get:function(){var e=this.get("view");return this.get("view.ready")?"ready":e?"loading":"disabled"},enumerable:!1,configurable:!0}),t.prototype.triggerAction=function(e,t){e&&!e.disabled&&this.emit("trigger-action",{action:e,item:t})},t.prototype.moveListItem=function(e,t,i,r){var n,o,s=null==e?void 0:e.layer;if(s){var a=null===(o=null===(n=this.view)||void 0===n?void 0:n.map)||void 0===o?void 0:o.layers,l=t?d.getItemLayers(t):a,c=i?d.getItemLayers(i):a;if(l&&c){var h=this.operationalItems,p=(null==t?void 0:t.children)||h,u=(null==i?void 0:i.children)||h,m=c.length-r;e.parent=i||null,p.includes(e)&&p.remove(e),l.includes(s)&&l.remove(s),u.includes(e)||u.add(e,m),c.includes(s)||c.add(s,m)}}},t.prototype._createLayerViewHandles=function(e){var t=this,i=this._handles;i.remove(u),this._compileList(),e&&i.add(e.on("change",(function(){return t._compileList()})),u)},t.prototype._createMapLayerHandles=function(e){var t=this,i=this._handles;i.remove(p),this._compileList(),e&&i.add(e.on("change",(function(){return t._compileList()})),p)},t.prototype._watchItemProperties=function(e){var t=this;this._handles.add([e.children.on("change",(function(){t._modifyListItemChildren(e.children)}))],"children-change-"+e.uid)},t.prototype._modifyListItemChildren=function(e){var t=this;e.forEach((function(e){return t._modifyListItem(e)}))},t.prototype._modifyListItem=function(e){if("function"==typeof this.listItemCreatedFunction){var t={item:e};this.listItemCreatedFunction.call(null,t)}this._modifyListItemChildren(e.children)},t.prototype._createListItem=function(e){var t=this.view,i=new l({layer:e,view:t});return this._watchItemProperties(i),i},t.prototype._removeAllItems=function(){var e=this._handles,t=this.operationalItems;t.forEach((function(t){e.remove("children-change-"+t.uid)})),t.removeAll()},t.prototype._getViewableLayers=function(e){if(e)return e.filter((function(e){return"hide"!==d.findLayerListMode(e)}))},t.prototype._watchLayersListMode=function(e){var t=this,i=this._handles;i.remove(m),e&&e.forEach((function(e){i.add(s.watch(e,"listMode",(function(){return t._compileList()})),m)}))},t.prototype._compileList=function(){var e=this.get("view.map.layers");this._watchLayersListMode(e);var t=this._getViewableLayers(e);t&&t.length?(this._createNewItems(t),this._modifyOrRemoveItems(t),this._sortItems(t)):this._removeAllItems()},t.prototype._createNewItems=function(e){var t=this,i=this.operationalItems;e.forEach((function(e){i.find((function(t){return t.layer===e}))||i.add(t._createListItem(e))}))},t.prototype._modifyOrRemoveItems=function(e){var t=this,i=this._handles,r=this.operationalItems,n=[];r.forEach((function(r){r&&e&&e.find((function(e){return r.layer===e}))?t._modifyListItem(r):(i.remove("children-change-"+r.uid),n.push(r))})),r.removeMany(n)},t.prototype._sortItems=function(e){this.operationalItems.sort((function(t,i){var r=e.indexOf(t.layer),n=e.indexOf(i.layer);return r>n?-1:r<n?1:0}))},t.prototype._viewHandles=function(){var e=this,t=this._handles,i=this.view;t.remove([p,u,h]),this._compileList(),i&&i.ready&&t.add([s.init(this,"view.map.layers",(function(t){return e._createMapLayerHandles(t)})),s.init(this,"view.layerViews",(function(t){return e._createLayerViewHandles(t)})),s.init(this,"listItemCreatedFunction",(function(){return e._compileList()}))],h)},i.__decorate([a.property()],t.prototype,"listItemCreatedFunction",void 0),i.__decorate([a.property({type:y})],t.prototype,"operationalItems",void 0),i.__decorate([a.property({dependsOn:["view.ready"],readOnly:!0})],t.prototype,"state",null),i.__decorate([a.property()],t.prototype,"view",void 0),t=i.__decorate([a.subclass("esri.widgets.LayerList.LayerListViewModel")],t)}(n.EventedAccessor)}));