/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/Accessor","../../core/Collection","../../core/HandleOwner","../../core/Identifiable","../../core/maybe","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/cast","../../core/arrayUtils","../../core/accessorSupport/decorators/subclass","../../support/actions/ActionBase","../../support/actions/ActionButton","../../support/actions/ActionSlider","../../support/actions/ActionToggle","./ListItemPanel","./support/layerListUtils"],(function(e,t,i,r,n,o,a,l,s,c,p,d,h,u,y,_,f,b){"use strict";var v;const w=r.ofType({key:"type",defaultKeyValue:"button",base:h,typeMap:{button:u,toggle:_,slider:y}}),g=r.ofType(w),S="layer",m="child-list-mode",C="hide",L="esri.widgets.LayerList.ListItem";let k=v=function(t){function i(e){var i;return(i=t.call(this,e)||this).actionsSections=new g,i.actionsOpen=!1,i.checkPublishStatusEnabled=!1,i.children=new(r.ofType(v)),i.childrenSortable=!0,i.hidden=!1,i.layer=null,i.layerView=null,i.listItemCreatedFunction=null,i.open=!1,i.panel=null,i.parent=null,i.sortable=!0,i.view=null,i}e._inheritsLoose(i,t);var n=i.prototype;return n.initialize=function(){if(this.handles.add([l.watch((()=>this.layer),(e=>this._watchLayerProperties(e)),l.initial),l.watch((()=>this.checkPublishStatusEnabled),(e=>this._updateChildrenPublishing(e)),l.initial),l.watch((()=>this.view),(e=>this._updateChildrenView(e)),l.initial),l.watch((()=>this.panel),(e=>this._setListItemOnPanel(e)),l.initial),l.watch((()=>[this.layer,this.view]),(()=>this._getLayerView()),l.initial)]),"function"==typeof this.listItemCreatedFunction){const e={item:this};this.listItemCreatedFunction.call(null,e)}},n.destroy=function(){this.view=null},n.castPanel=function(e){return this.get("panel.open")&&!e.hasOwnProperty("open")&&(e.open=!0),e?new f(e):null},n.clone=function(){return new v({actionsSections:this.actionsSections.clone(),actionsOpen:this.actionsOpen,checkPublishStatusEnabled:this.checkPublishStatusEnabled,children:this.children.clone(),layer:this.layer,listItemCreatedFunction:this.listItemCreatedFunction,open:this.open,panel:this.panel,title:this.title,view:this.view,visible:this.visible})},n._setListItemOnPanel=function(e){e&&(e.listItem=this)},n._updateChildrenPublishing=function(e){const t=this.children;t&&t.forEach((t=>t.checkPublishStatusEnabled=e))},n._updateChildrenView=function(e){const t=this.children;t&&t.forEach((t=>t.view=e))},n._addChildren=function(e){if(this.handles.remove(m),this.children.removeAll(),!e)return;e.forEach((t=>{this.handles.add(l.watch((()=>t.listMode),(()=>this._addChildren(e))),m)}));const t=e.filter((e=>b.findLayerListMode(e)!==C));this.children.addMany(this._makeChildren(t))},n._watchSublayerChanges=function(e){e&&this.handles.add(e.on("change",(()=>{this._addChildren(e)})),S)},n._initializeChildLayers=function(e){this._addChildren(e),this._watchSublayerChanges(e)},n._makeChildren=function(e){return e.map((e=>b.canDisplayLayer(e)?new v({layer:e,checkPublishStatusEnabled:this.checkPublishStatusEnabled,listItemCreatedFunction:this.listItemCreatedFunction,parent:this,view:this.view}):null)).filter(a.isSome).reverse()},n._watchLayerProperties=function(e){if(!this.handles)return;if(this.handles.remove(S),this.handles.remove(m),!e)return;this.handles.add(l.watch((()=>e.listMode),(()=>this._watchLayerProperties(e))),S);if("hide-children"===b.findLayerListMode(e))return void this.children.removeAll();const t=b.getNormalizedChildLayerProperty(e);t&&this.handles.add(l.watch((()=>e[t]),(()=>{e.hasOwnProperty(t)&&this._initializeChildLayers(e[t])}),l.initial),S)},n._getLayerView=function(){var t=e._asyncToGenerator((function*(){const{layer:e,view:t}=this;if(e&&t)try{const i=yield t.whenLayerView(e);if(i.layer!==this.layer)return;this._set("layerView",i)}catch{}}));function i(){return t.apply(this,arguments)}return i}(),e._createClass(i,[{key:"connectionStatus",get:function(){const{layerView:e,publishing:t}=this;if(!t&&e&&"connectionStatus"in e)return e.connectionStatus}},{key:"error",get:function(){return this.layer?.loadError}},{key:"incompatible",get:function(){const{layerView:e}=this;return!(!e||!("spatialReferenceSupported"in e))&&!e.spatialReferenceSupported}},{key:"title",get:function(){const e=this.get("layer.layer");return(!e||e&&this.get("layer.layer.loaded"))&&this.get("layer.title")||this.get("layer.attributes.title")||""},set:function(e){this._override("title",e)}},{key:"publishing",get:function(){const{layer:e,checkPublishStatusEnabled:t}=this;return t&&e&&"publishingInfo"in e&&"publishing"===e.publishingInfo?.status}},{key:"updating",get:function(){const{layerView:e,connectionStatus:t,layer:i,publishing:r}=this;return!r&&!t&&(e?e.updating:"loading"===i?.loadStatus||!1)}},{key:"visible",get:function(){return this.layer?.visible},set:function(e){const t=this.layer;t&&(t.visible=e)}},{key:"visibleAtCurrentScale",get:function(){return!b.isLayerOutsideScaleRange(this.layer,this.get("view.scale"))}},{key:"visibilityMode",get:function(){return b.findLayerVisibilityMode(this.layer)}}]),i}(o.IdentifiableMixin(n.HandleOwnerMixin(i)));t.__decorate([s.property({type:g})],k.prototype,"actionsSections",void 0),t.__decorate([s.property()],k.prototype,"actionsOpen",void 0),t.__decorate([s.property()],k.prototype,"checkPublishStatusEnabled",void 0),t.__decorate([s.property({type:r})],k.prototype,"children",void 0),t.__decorate([s.property()],k.prototype,"childrenSortable",void 0),t.__decorate([s.property({readOnly:!0})],k.prototype,"connectionStatus",null),t.__decorate([s.property({readOnly:!0})],k.prototype,"error",null),t.__decorate([s.property()],k.prototype,"hidden",void 0),t.__decorate([s.property({readOnly:!0})],k.prototype,"incompatible",null),t.__decorate([s.property()],k.prototype,"layer",void 0),t.__decorate([s.property({readOnly:!0})],k.prototype,"layerView",void 0),t.__decorate([s.property()],k.prototype,"listItemCreatedFunction",void 0),t.__decorate([s.property()],k.prototype,"open",void 0),t.__decorate([s.property({type:f})],k.prototype,"panel",void 0),t.__decorate([c.cast("panel")],k.prototype,"castPanel",null),t.__decorate([s.property()],k.prototype,"parent",void 0),t.__decorate([s.property()],k.prototype,"sortable",void 0),t.__decorate([s.property()],k.prototype,"title",null),t.__decorate([s.property({readOnly:!0})],k.prototype,"publishing",null),t.__decorate([s.property({readOnly:!0})],k.prototype,"updating",null),t.__decorate([s.property()],k.prototype,"view",void 0),t.__decorate([s.property()],k.prototype,"visible",null),t.__decorate([s.property({readOnly:!0})],k.prototype,"visibleAtCurrentScale",null),t.__decorate([s.property({readOnly:!0})],k.prototype,"visibilityMode",null),k=v=t.__decorate([d.subclass(L)],k);return k}));
