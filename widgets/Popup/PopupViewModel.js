// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../geometry","../../core/Collection","../../core/Error","../../core/Handles","../../core/Logger","../../core/maybe","../../core/promiseUtils","../../core/watchUtils","../../core/accessorSupport/decorators","../../geometry/support/webMercatorUtils","../../layers/Layer","../../support/actions/ActionBase","../../support/actions/ActionButton","../../support/actions/ActionToggle","../../views/input/InputManager","../../views/support/layerViewUtils","../Feature/FeatureViewModel","./actions","../support/AnchorElementViewModel","../support/GoTo"],(function(e,t,o,r,n,i,a,s,u,l,p,c,d,h,f,g,y,_,v,m,w,b,F){"use strict";var P=n.ofType({key:"type",defaultKeyValue:"button",base:f,typeMap:{button:g,toggle:y}}),C=s.getLogger("esri.widgets.Popup.PopupViewModel");return function(e){function t(t){var o=e.call(this,t)||this;return o._handles=new a,o._pendingPromises=new Set,o._zoomToLocation=null,o._fetchFeaturesController=null,o.actions=new P([w.zoomToFeature.clone()]),o.defaultPopupTemplateEnabled=!1,o.autoCloseEnabled=!1,o.autoOpenEnabled=!0,o.content=null,o.featureViewModels=[],o.highlightEnabled=!0,o.title=null,o.updateLocationEnabled=!1,o.view=null,o.visible=!1,o.zoomFactor=4,o}return o.__extends(t,e),t.prototype.initialize=function(){var e=this;this._handles.add([p.init(this,["autoOpenEnabled","view"],(function(){return e._autoOpenEnabledChange()})),this.on("view-change",(function(){return e._autoClose()})),p.watch(this,["highlightEnabled","selectedFeature","visible","view"],(function(){return e._highlightFeature()})),p.watch(this,"view.animation.state",(function(t){return e._animationStateChange(t)})),p.watch(this,"location",(function(t){return e._locationChange(t)})),p.watch(this,"selectedFeature",(function(t){return e._selectedFeatureChange(t)})),this.on("trigger-action",(function(t){return w.triggerAction({event:t,view:e.view})})),p.whenFalse(this,"waitingForResult",(function(){return e._waitingForResultChange()})),p.watch(this,["features","view","view.map","view.spatialReference"],(function(){return e._updateFeatureVMs()}))])},t.prototype.destroy=function(){this._cancelFetchingFeatures(),this._handles.destroy(),this._handles=null,this._pendingPromises.clear(),this.view=null},Object.defineProperty(t.prototype,"active",{get:function(){return!(!this.visible||this.waitingForResult)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"allActions",{get:function(){var e=this._get("allActions")||new P;e.removeAll();var t=this.selectedFeature&&("function"==typeof this.selectedFeature.getEffectivePopupTemplate&&this.selectedFeature.getEffectivePopupTemplate(this.defaultPopupTemplateEnabled)||this.selectedFeature.popupTemplate),o=t&&t.actions,r=t&&t.overwriteActions?o:o?o.concat(this.actions):this.actions;return r&&r.filter(Boolean).forEach((function(t){return e.add(t)})),e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"featureCount",{get:function(){return this.features.length},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"features",{get:function(){return this._get("features")||[]},set:function(e){var t=e||[];this._set("features",t);var o=this.pendingPromisesCount,r=this.promiseCount,n=this.selectedFeatureIndex,i=r&&t.length;i&&o&&-1===n?this.selectedFeatureIndex=0:i&&-1!==n||(this.selectedFeatureIndex=t.length?0:-1)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"location",{get:function(){return this._get("location")||null},set:function(e){var t=this.get("view.spatialReference.isWebMercator");e&&e.get("spatialReference.isWGS84")&&t&&(e=d.geographicToWebMercator(e)),this._set("location",e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"pendingPromisesCount",{get:function(){return this._pendingPromises.size},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"waitingForResult",{get:function(){return!(!(!!this._fetchFeaturesController||this.pendingPromisesCount>0)||0!==this.featureCount)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"promiseCount",{get:function(){return this.promises.length},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"promises",{get:function(){return this._get("promises")||[]},set:function(e){var t=this;if(this._pendingPromises.clear(),this.features=[],!Array.isArray(e)||!e.length)return this._set("promises",[]),void this.notifyChange("pendingPromisesCount");this._set("promises",e),(e=e.slice(0)).forEach((function(e){t._pendingPromises.add(e);e.then((function(o){t._pendingPromises.has(e)&&t._updateFeatures(o),t._updatePendingPromises(e)}),(function(){return t._updatePendingPromises(e)}))})),this.notifyChange("pendingPromisesCount")},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"selectedFeature",{get:function(){var e=this.features,t=this.selectedFeatureIndex;return-1===t?null:e[t]||null},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"selectedFeatureIndex",{get:function(){var e=this._get("selectedFeatureIndex");return"number"==typeof e?e:-1},set:function(e){var t=this.featureCount;e=isNaN(e)||e<-1||!t?-1:(e+t)%t,this._set("selectedFeatureIndex",e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"selectedFeatureViewModel",{get:function(){return this.featureViewModels[this.selectedFeatureIndex]||null},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"state",{get:function(){return this.get("view.ready")?"ready":"disabled"},enumerable:!1,configurable:!0}),t.prototype.centerAtLocation=function(){var e=this.view,t=this._getSelectedTarget();if(!t){var o=new i("center-at-location:invalid-target-or-view","Cannot center at a location without a target and view.",{target:t,view:e});return C.error(o),l.reject(o)}return this.callGoTo({target:{target:t,scale:e.scale}})},t.prototype.clear=function(){this.set({promises:[],features:[],content:null,title:null,location:null})},t.prototype.fetchFeatures=function(e,t){var o=this.view;if(!o||!e){var r=new i("fetch-features:invalid-screenpoint-or-view","Cannot fetch features without a screenPoint and view.",{screenPoint:e,view:o});return C.error(r),l.reject(r)}return o.fetchPopupFeatures(e,{event:t&&t.event,defaultPopupTemplateEnabled:this.defaultPopupTemplateEnabled,signal:t&&t.signal})},t.prototype.open=function(e){var t=o.__assign(o.__assign({updateLocationEnabled:!1,promises:[],fetchFeatures:!1},e),{visible:!0}),r=t.fetchFeatures;delete t.fetchFeatures,r&&this._setFetchFeaturesPromises(t.location),this.set(t)},t.prototype.triggerAction=function(e){var t=this.allActions.getItemAt(e);t&&!t.disabled&&this.emit("trigger-action",{action:t})},t.prototype.next=function(){return this.selectedFeatureIndex=this.selectedFeatureIndex+1,this},t.prototype.previous=function(){return this.selectedFeatureIndex=this.selectedFeatureIndex-1,this},t.prototype.zoomToLocation=function(){var e=this,t=this.location,o=this.selectedFeature,r=this.view,n=this.zoomFactor,a=this._getSelectedTarget();if(!a){var s=new i("zoom-to:invalid-target-or-view","Cannot zoom to location without a target and view.",{target:a,view:r});return C.error(s),l.reject(s)}var u=r.scale/n,p=this.get("selectedFeature.geometry")||t,c=p&&"point"===p.type&&this._isZoomScreenSize(o);w.zoomToFeature.active=!0,w.zoomToFeature.disabled=!0;var d=this.callGoTo({target:{target:a,scale:c?u:void 0}}).catch((function(){w.zoomToFeature.active=!1,w.zoomToFeature.disabled=!1,e._zoomToLocation=null})).then((function(){c&&(e.location=p)}));return this._zoomToLocation=d,d},t.prototype._animationStateChange=function(e){this._zoomToLocation||(w.zoomToFeature.disabled="waiting-for-target"===e)},t.prototype._locationChange=function(e){var t=this.selectedFeature;this.updateLocationEnabled&&e&&(!t||t.geometry)&&this.centerAtLocation()},t.prototype._selectedFeatureChange=function(e){var t=this;if(e){var o=this.location,r=this.updateLocationEnabled,n=this.view;!r&&o||!e.geometry?r&&!e.geometry&&this.centerAtLocation().then((function(){t.location=n.center.clone()})):this.location=u.unwrap(this._getPointFromGeometry(e.geometry))}},t.prototype._waitingForResultChange=function(){!this.featureCount&&this.promises&&(this.visible=!1)},t.prototype._setFetchFeaturesPromises=function(e){var t=this;return this._fetchFeaturesWithController(this._getScreenPoint(e||this.location)).then((function(e){var r=e.clientOnlyGraphics,n=e.promisesPerLayerView,i=l.resolve(r),a=n.map((function(e){return e.promise}));t.promises=o.__spreadArrays([i],a)}))},t.prototype._destroyFeatureVMs=function(){this.featureViewModels.forEach((function(e){return e&&!e.destroyed&&e.destroy()})),this._set("featureViewModels",[])},t.prototype._updateFeatureVMs=function(){var e=this,t=this.features,o=this.featureViewModels;if(this._destroyFeatureVMs(),t&&t.length){var r=o.slice(0),n=[];t.forEach((function(t,o){var i,a;if(t){var s=null;if(r.some((function(e,o){return e&&e.graphic===t&&(s=e,r.splice(o,1)),!!s})),s)n[o]=s;else{var u=new m({defaultPopupTemplateEnabled:e.defaultPopupTemplateEnabled,graphic:t,spatialReference:null===(i=e.view)||void 0===i?void 0:i.spatialReference,map:null===(a=e.view)||void 0===a?void 0:a.map});n[o]=u}}})),r.forEach((function(e){return e&&!e.destroyed&&e.destroy()})),this._set("featureViewModels",n)}},t.prototype._getScreenPoint=function(e){var t=this.view;return t&&e&&"function"==typeof t.toScreen?t.toScreen(e):null},t.prototype._getSelectedTarget=function(){var e=this.selectedFeature,t=this.location,o=this.view;return o?"3d"===o.type?e||t:this.get("selectedFeature.geometry")||t:null},t.prototype._autoOpenEnabledChange=function(){var e=this,t=this._handles,o=this.autoOpenEnabled;if(t.remove("auto-fetch-features"),o&&this.view){var r=this.view.on("click",(function(t){"mouse"===t.pointerType&&0!==t.button||e._fetchFeaturesAndOpen(t)}),_.ViewEventPriorities.WIDGET);t.add(r,"auto-fetch-features")}},t.prototype._cancelFetchingFeatures=function(){var e=this._fetchFeaturesController;e&&e.abort(),this._fetchFeaturesController=null,this.notifyChange("waitingForResult")},t.prototype._fetchFeaturesWithController=function(e,t){var o=this;this._cancelFetchingFeatures();var r=l.createAbortController(),n=r.signal;this._fetchFeaturesController=r,this.notifyChange("waitingForResult");var i=this.fetchFeatures(e,{signal:n,event:t});return i.catch((function(){})).then((function(){o._fetchFeaturesController=null,o.notifyChange("waitingForResult")})),i},t.prototype._fetchFeaturesAndOpen=function(e){var t=e.screenPoint,r=e.mapPoint,n=this.view;this._fetchFeaturesWithController(t,e).then((function(e){var t=e.clientOnlyGraphics,i=e.promisesPerLayerView,a=e.location,s=l.resolve(t),u=o.__spreadArrays([s],i.map((function(e){return e.promise})));return n.popup.open({location:a||r,promises:u}),e}))},t.prototype._updatePendingPromises=function(e){e&&this._pendingPromises.has(e)&&(this._pendingPromises.delete(e),this.notifyChange("pendingPromisesCount"))},t.prototype._autoClose=function(){this.autoCloseEnabled&&(this.visible=!1)},t.prototype._isZoomScreenSize=function(e){var t=this.view;if("3d"!==t.type||!e||"esri.Graphic"!==e.declaredClass)return!0;var o=t.getViewForGraphic(e);if(o&&"whenGraphicBounds"in o){var r=!1;return o.whenGraphicBounds(e,{useViewElevation:!0}).then((function(e){r=!e||!e.boundingBox||e.boundingBox[0]===e.boundingBox[3]&&e.boundingBox[1]===e.boundingBox[4]&&e.boundingBox[2]===e.boundingBox[5]})).catch((function(){var t=new i("zoom-to:invalid-graphic","Could not zoom to the location of the graphic.",{graphic:e});C.error(t)})),r}return!0},t.prototype._getPointFromGeometry=function(e){return u.isNone(e)?null:"point"===e.type?e:"extent"===e.type?e.center:"polygon"===e.type?e.centroid:"multipoint"===e.type?e.extent.center:"polyline"===e.type?e.extent.center:null},t.prototype._getLayerView=function(e,t){return o.__awaiter(this,void 0,void 0,(function(){return o.__generator(this,(function(o){switch(o.label){case 0:return[4,e.when()];case 1:return o.sent(),[2,e.whenLayerView(t)]}}))}))},t.prototype._highlightFeature=function(){return o.__awaiter(this,void 0,void 0,(function(){var e,t,r,n,i,a,s,u,l,p,c,d,f;return o.__generator(this,(function(o){switch(o.label){case 0:return e="highlight",this._handles.remove(e),r=(t=this).selectedFeature,n=t.highlightEnabled,i=t.view,a=t.visible,r&&i&&n&&a?(s=r.layer)&&s instanceof h?(u=this._getLayerView(i,s),this._highlightPromise=u,[4,u]):[2]:[2];case 1:return(l=o.sent())&&v.highlightsSupported(l)&&this._highlightPromise===u&&this.selectedFeature&&this.highlightEnabled&&this.visible?(p="objectIdField"in s&&s.objectIdField,c=r.attributes,d=c&&p&&c[p],f=l.highlight(d||r),this._handles.add(f,e),[2]):[2]}}))}))},t.prototype._updateFeatures=function(e){var t=this.features;if(e&&e.length)if(t.length){var o=e.filter((function(e){return-1===t.indexOf(e)}));this.features=t.concat(o)}else this.features=e},o.__decorate([c.property({type:P})],t.prototype,"actions",void 0),o.__decorate([c.property({readOnly:!0,dependsOn:["visible","waitingForResult"]})],t.prototype,"active",null),o.__decorate([c.property({dependsOn:["actions.length","selectedFeature.sourceLayer.popupTemplate.actions.length","selectedFeature.sourceLayer.popupTemplate.overwriteActions","selectedFeature.popupTemplate.actions.length","selectedFeature.popupTemplate.overwriteActions"],readOnly:!0})],t.prototype,"allActions",null),o.__decorate([c.property({type:Boolean})],t.prototype,"defaultPopupTemplateEnabled",void 0),o.__decorate([c.property()],t.prototype,"autoCloseEnabled",void 0),o.__decorate([c.property()],t.prototype,"autoOpenEnabled",void 0),o.__decorate([c.property()],t.prototype,"content",void 0),o.__decorate([c.property({readOnly:!0,dependsOn:["features"]})],t.prototype,"featureCount",null),o.__decorate([c.property()],t.prototype,"features",null),o.__decorate([c.property({readOnly:!0})],t.prototype,"featureViewModels",void 0),o.__decorate([c.property()],t.prototype,"highlightEnabled",void 0),o.__decorate([c.property({type:r.Point})],t.prototype,"location",null),o.__decorate([c.property({readOnly:!0,dependsOn:["promises"]})],t.prototype,"pendingPromisesCount",null),o.__decorate([c.property({readOnly:!0,dependsOn:["featureCount","pendingPromisesCount"]})],t.prototype,"waitingForResult",null),o.__decorate([c.property({readOnly:!0,dependsOn:["promises"]})],t.prototype,"promiseCount",null),o.__decorate([c.property()],t.prototype,"promises",null),o.__decorate([c.property({value:null,readOnly:!0,dependsOn:["features","selectedFeatureIndex","updateLocationEnabled"]})],t.prototype,"selectedFeature",null),o.__decorate([c.property({value:-1})],t.prototype,"selectedFeatureIndex",null),o.__decorate([c.property({readOnly:!0,dependsOn:["featureViewModels","selectedFeatureIndex"]})],t.prototype,"selectedFeatureViewModel",null),o.__decorate([c.property({readOnly:!0,dependsOn:["view.ready"]})],t.prototype,"state",null),o.__decorate([c.property()],t.prototype,"title",void 0),o.__decorate([c.property()],t.prototype,"updateLocationEnabled",void 0),o.__decorate([c.property()],t.prototype,"view",void 0),o.__decorate([c.property()],t.prototype,"visible",void 0),o.__decorate([c.property()],t.prototype,"zoomFactor",void 0),o.__decorate([c.property()],t.prototype,"centerAtLocation",null),o.__decorate([c.property()],t.prototype,"zoomToLocation",null),t=o.__decorate([c.subclass("esri.widgets.Popup.PopupViewModel")],t)}(F.GoToMixin(b))}));