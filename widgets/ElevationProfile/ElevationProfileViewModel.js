/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/has","../../core/maybe","../../core/Logger","../../core/accessorSupport/ensureType","../../core/handleUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/subclass","../../core/urlUtils","../../core/uuid","../../portal/support/resourceExtension","../../core/arrayUtils","../../core/Accessor","../../core/Collection","../../core/collectionUtils","../../Graphic","../../core/Handles","../../core/watchUtils","../../core/unitUtils","../../core/LRUCache","../support/commonProperties","../../layers/support/ElevationQueryTileCache","./support/geometryUtils","./ElevationProfileInteraction","./ElevationProfileLineGround","./elevationProfileLineTypes","./support/constants","./support/statisticsUtils","./support/profileUtils","./ElevationProfileLineUpdater","./support/ElevationProfileVisualization"],(function(e,t,i,o,r,n,s,l,a,c,u,p,h,d,f,y,_,v,g,m,P,U,C,w,S,b,O,k,E,D,L,T){"use strict";const R="profiles",z="visible-profiles";let M=function(t){function i(i){var o;return(o=t.call(this,i)||this).view=null,o.input=null,o.geodesicDistanceThreshold=1e5,o.hoveredChartPosition=null,o.defaultUnit=null,o.queue=null,o._currentTileCache=null,o.defaultProfileLineGround=new b,o._handles=new v,o._visualization=new T.ElevationProfileVisualization(e._assertThisInitialized(o)),o._userUnitOptions=null,o._userUnit=null,i.profiles||(o.profiles=new f([o.defaultProfileLineGround])),o}e._inheritsLoose(i,t);var r=i.prototype;return r.initialize=function(){var e;this.queue=D.createProfileQueue("3d"===this.view.type?null==(e=this.view.resourceController)?void 0:e.scheduler:void 0),this._interaction=new S.default({parentViewModel:this}),this._handles.add(this._watchAndUpdateProfiles()),this._visualization.initialize()},r.destroy=function(){this._handles.destroy(),this._handles=null,this.defaultProfileLineGround.destroy(),this.defaultProfileLineGround=null,this._visualization.destroy(),this._visualization=null,this._interaction.destroy(),this._interaction=null,this.queue=o.destroyMaybe(this.queue),this._currentTileCache=o.destroyMaybe(this._currentTileCache)},r.start=function(e){this._interaction.start(e)},r.stop=function(){this._interaction.stop()},r.cancel=function(){this._interaction.cancel()},r.clear=function(){this._interaction.clear()},r._watchAndUpdateProfiles=function(){const e=()=>{this._handles.remove(R);const e=[];for(const t of this.profiles){const i=new L({line:t,viewModel:this});e.push(s.makeHandle((()=>i.destroy())),t.watch("visible",(()=>this.notifyChange("visibleProfiles"))))}this._handles.add(e,R),this.notifyChange("visibleProfiles")};return[g.on(this,"profiles","change",e,e,e),g.init(this,"visibleProfiles",(()=>{this._handles.remove(z);const e=[];for(const t of this.visibleProfiles)e.push(t.watch(["id","title","color","samples","progress"],(()=>this.notifyChange("chartData"))),t.watch("minDemResolution",(()=>this.notifyChange("minDemResolutions"))),t.watch("statistics",(()=>this.notifyChange("statistics"))),t.watch("result",(()=>this.notifyChange("effectiveUnits"))),t.watch("progress",(()=>this.notifyChange("progress"))),t.watch(["color","hoveredPoint"],(()=>this.notifyChange("hoveredPoints"))));this._handles.add(e,z)}))]},r._findSelectableUnit=function(e,t){const i=this.unitOptions;return o.isSome(e)&&-1!==i.indexOf(e)?e:t?this._findSelectableUnit(t):i[0]},r._filteredOrAllUnits=function(e){const t=(o.isSome(e)?e:[]).filter((e=>-1!==m.measurementLengthUnits.indexOf(e)));return 0===t.length?m.measurementLengthUnits.slice():t},e._createClass(i,[{key:"profiles",set:function(e){const t=this._get("profiles"),i=null!=e?e:new f;this._set("profiles",y.referenceSetter(i,t))}},{key:"state",get:function(){var e;switch(null==(e=this._interaction)?void 0:e.state){case S.State.Ready:return k.ElevationProfileState.Ready;case S.State.Creating:return k.ElevationProfileState.Creating;case S.State.Selecting:return k.ElevationProfileState.Selecting;case S.State.Selected:return k.ElevationProfileState.Selected;case S.State.Reshaping:return k.ElevationProfileState.Created}}},{key:"progress",get:function(){let e=0,t=0;for(const i of this.visibleProfiles)e++,t+=i.progress;return e>0?t/e:0}},{key:"unitOptions",set:function(e){this._userUnitOptions=e,this._set("unitOptions",this._filteredOrAllUnits(this._userUnitOptions))},get:function(){return this._filteredOrAllUnits(this._userUnitOptions)}},{key:"unit",set:function(e){this._userUnit=e?this._findSelectableUnit(e,this._userUnit):null,this.notifyChange("unit")},get:function(){return this._userUnit?(this._userUnit=this._findSelectableUnit(this._userUnit,this.defaultUnit),this._userUnit):this._findSelectableUnit(this.defaultUnit)}},{key:"effectiveUnits",get:function(){const e=E.getBoundsInMeters(this.visibleProfiles.map((e=>e.result)));return{distance:m.preferredLengthUnit(e.maxDistance,"meters",this.unit),elevation:m.preferredVerticalLengthUnit(e.maxElevation,"meters",this.unit)}}},{key:"hoveredPoints",get:function(){return o.isNone(this.input)?[]:this.visibleProfiles.map((e=>{const t=e.hoveredPoint;return o.isSome(t)?{hoveredPoint:t,color:e.color}:null})).filter(o.isSome)}},{key:"statistics",get:function(){return E.mergeStatistics(this.visibleProfiles.map((e=>e.statistics)))}},{key:"chartData",get:function(){if(o.isNone(this.input))return null;const e=[];for(const{id:t,type:i,title:r,color:n,samples:s,progress:l,showFill:a}of this.visibleProfiles){o.unwrapOr(s,[]).some((e=>o.isSome(e.z)))&&e.push({id:t,type:i,title:r,color:n,samples:s,progress:l,showFill:a})}return 0===e.length?null:{lines:e,effectiveUnits:this.effectiveUnits,statistics:this.statistics,progress:this.progress}}},{key:"visibleProfiles",get:function(){return this.profiles.toArray().filter((e=>e.visible))}},{key:"minDemResolutions",get:function(){const e=[];for(const{minDemResolution:t}of this.visibleProfiles)o.isSome(t)&&e.push(t);return e}},{key:"elevationUnitsPerPixel",get:function(){return h.max(this.minDemResolutions)}},{key:"minDemResolution",get:function(){return h.min(this.minDemResolutions)}},{key:"canStopCreating",get:function(){return this._interaction.canStopCreating}},{key:"errorState",get:function(){const e=o.applySome(this.input,(e=>e.geometry));return w.isMultiPathPolyline(e)?1:w.isValidInputPath(e)?0===this.visibleProfiles.length?2:o.isNone(this.chartData)&&1===this.progress?3:4:0}},{key:"tileCache",get:function(){var e,t;return o.destroyMaybe(this._currentTileCache),this._currentTileCache="3d"===(null==(e=this.view)?void 0:e.type)&&null!=(t=this.view)&&t.resourceController?new C.ElevationQueryTileCache(this.view.resourceController.memoryController.getMemCache("elevation-profile-widget")):new C.ElevationQueryTileCache(new P(20971520)),this._currentTileCache}},{key:"test",get:function(){return{interaction:this._interaction}}}]),i}(d);return t.__decorate([l.property()],M.prototype,"view",void 0),t.__decorate([l.property({type:_})],M.prototype,"input",void 0),t.__decorate([l.property({type:O.ElevationProfileLineCollection,nonNullable:!0})],M.prototype,"profiles",null),t.__decorate([l.property({readOnly:!0})],M.prototype,"state",null),t.__decorate([l.property({readOnly:!0})],M.prototype,"progress",null),t.__decorate([l.property()],M.prototype,"unitOptions",null),t.__decorate([l.property()],M.prototype,"unit",null),t.__decorate([l.property({readOnly:!0})],M.prototype,"effectiveUnits",null),t.__decorate([l.property({type:Number})],M.prototype,"geodesicDistanceThreshold",void 0),t.__decorate([l.property()],M.prototype,"hoveredChartPosition",void 0),t.__decorate([l.property({readOnly:!0})],M.prototype,"hoveredPoints",null),t.__decorate([l.property({readOnly:!0})],M.prototype,"statistics",null),t.__decorate([l.property()],M.prototype,"chartData",null),t.__decorate([l.property()],M.prototype,"visibleProfiles",null),t.__decorate([l.property()],M.prototype,"minDemResolutions",null),t.__decorate([l.property()],M.prototype,"elevationUnitsPerPixel",null),t.__decorate([l.property({readOnly:!0})],M.prototype,"minDemResolution",null),t.__decorate([l.property({readOnly:!0})],M.prototype,"canStopCreating",null),t.__decorate([l.property({readOnly:!0})],M.prototype,"errorState",null),t.__decorate([l.property(U.defaultUnitPropertyMetadata)],M.prototype,"defaultUnit",void 0),t.__decorate([l.property()],M.prototype,"queue",void 0),t.__decorate([l.property()],M.prototype,"tileCache",null),t.__decorate([l.property()],M.prototype,"_visualization",void 0),t.__decorate([l.property()],M.prototype,"_interaction",void 0),t.__decorate([l.property()],M.prototype,"_userUnitOptions",void 0),t.__decorate([l.property()],M.prototype,"_userUnit",void 0),M=t.__decorate([a.subclass("esri.widgets.ElevationProfile.ElevationProfileViewModel")],M),M}));
