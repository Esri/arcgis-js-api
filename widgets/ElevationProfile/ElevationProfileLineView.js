/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/has","../../core/maybe","../../core/Logger","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/subclass","../../core/urlUtils","../../core/uuid","../../portal/support/resourceExtension","../../Color","../../chunks/vec3","../../core/Handles","../../core/watchUtils","../../geometry/projectionEllipsoid","../../core/unitUtils","../../chunks/vec4f64","../../views/3d/support/geometryUtils","../../views/3d/webgl-engine/lib/Intersector","./ElevationProfileLine","../../layers/support/ElevationQuery"],(function(e,t,r,o,n,i,s,c,l,a,u,p,d,y,h,_,v,f,w,m,g,I){"use strict";let b=function(t){function r(e){var r;return(r=t.call(this,e)||this).type="view",r.color=new p([191,76,245]),r.include=null,r.exclude=null,r.numSamplesForPreview=50,r.numSamplesPerChunk=100,r._vecA=f.create(),r._vecB=f.create(),r._ray=w.ray.create(),r}e._inheritsLoose(r,t);var n=r.prototype;return n.queryElevation=async function(e,{noDataValue:t,signal:r}){const n=this._view;if(o.isNone(n))throw new Error("can only query SceneView");const i=this._viewModel.input,s=o.isSome(i)?C(i):null,c=this._intersector,l=this._maxIntersectionDistance,a=n.spatialReference,u=await I.GeometryDescriptor.fromGeometry(e).project(a,r);for(const e of u.coordinates){var p;const r=this._vecA,i=this._vecB;d.set(i,e.x,e.y,null!=(p=e.z)?p:0),n.renderCoordsHelper.toRenderCoords(i,a,i),d.copy(r,i),n.renderCoordsHelper.setAltitude(2e5,r);const u=w.ray.fromPoints(r,i,this._ray);n.sceneIntersectionHelper.computeIntersection(u,c,this._intersectOptions);const y=c.results.all.find((e=>{if(e.distanceInRenderSpace>l)return!1;const t=e.toGraphic(n);return o.isNone(t)||C(t)!==s}));if(y){const t=this._vecA;y.getIntersectionPoint(t),n.renderCoordsHelper.fromRenderCoords(t,t,a),e.z=t[2]}else e.z=t}return{geometry:u.export(),noDataValue:t}},n.attach=function(e){const r=new y;r.add(t.prototype.attach.call(this,e));const o=()=>{this.notifyChange("_intersectOptions")},n=()=>{this._watchLayerVisibilities(r,e.view,this._onChange),this._onChange()};return r.add([h.init(this,"_intersectOptions",this._onChange),h.on(this,"include","change",o,o,o),h.on(this,"exclude","change",o,o,o),h.when(e,"view.stationary",(()=>this._onChange())),h.on(e,"view.elevationProvider","elevation-change",this._onChange),h.on(e,"view.map.allLayers","change",n,n,n)]),r},n._watchLayerVisibilities=function(e,t,r){var o,n,i;e.remove("layer-visibilities");const s=null!=(o=null==(n=t.map)||null==(i=n.allLayers)?void 0:i.toArray())?o:[];e.add(s.map((e=>e.watch("visible",r))),"layer-visibilities")},e._createClass(r,[{key:"minDemResolution",get:function(){var e,t,r;const o=null==(e=this._viewModel)?void 0:e.view;if(!o||"3d"!==o.type)return null;const n=null==(t=o.pointsOfInterest)||null==(r=t.focus)?void 0:r.renderLocation;if(!n)return null;return o.state.camera.computeRenderPixelSizeAt(n)*v.getMetersPerVerticalUnitForSR(o.spatialReference)}},{key:"_intersectOptions",get:function(){const e=this._view;return o.isSome(e)?e.externalToInternalIntersectOptions({include:this.include,exclude:this.exclude}):{}}},{key:"_view",get:function(){const e=this._viewModel.view;return"3d"===(null==e?void 0:e.type)?e:null}},{key:"_maxIntersectionDistance",get:function(){const e=this._view;return o.isNone(e)?Number.POSITIVE_INFINITY:_.getReferenceEllipsoid(e.spatialReference).radius/e.renderCoordsHelper.unitInMeters}},{key:"_intersector",get:function(){const e=this._view;if(o.isNone(e))return null;const t=new m.Intersector(e.state.mode),r=t.options;return r.hud=!1,r.invisibleTerrain=!1,r.backfacesTerrain=!1,r.selectionMode=!1,r.store=2,t}}]),r}(g.ElevationProfileLine);function C(e){if(e.layer&&"objectIdField"in e.layer){const t=e.attributes[e.layer.objectIdField];if(t)return`o-${e.layer.id}-${t}`}return`u-${e.uid}`}return t.__decorate([s.property({type:p,nonNullable:!0})],b.prototype,"color",void 0),t.__decorate([s.property()],b.prototype,"include",void 0),t.__decorate([s.property()],b.prototype,"exclude",void 0),t.__decorate([s.property({readOnly:!0})],b.prototype,"minDemResolution",null),t.__decorate([s.property()],b.prototype,"_intersectOptions",null),t.__decorate([s.property()],b.prototype,"_view",null),t.__decorate([s.property()],b.prototype,"_maxIntersectionDistance",null),t.__decorate([s.property()],b.prototype,"_intersector",null),b=t.__decorate([c.subclass("esri.widgets.ElevationProfile.ElevationProfileLineView")],b),b}));
