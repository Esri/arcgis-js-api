/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/has","../../core/maybe","../../core/Logger","../../core/accessorSupport/ensureType","../../core/handleUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/aliasOf","../../core/accessorSupport/decorators/subclass","../../core/urlUtils","../../core/uuid","../../portal/support/resourceExtension","../../core/promiseUtils","../../core/Accessor","../../symbols/CIMSymbol","../../core/Handles","../../core/watchUtils","../../layers/GraphicsLayer","../../views/DOMContainer","../Sketch/SketchViewModel","./support/geometryUtils"],(function(t,e,i,s,n,o,a,r,c,l,h,p,u,_,d,y,S,I,g,f,v,m,k){"use strict";var M;(M=t.State||(t.State={})).Ready="ready",M.Creating="creating",M.Reshaping="reshaping",M.Selecting="selecting",M.Selected="selected";const b="selection-interaction";let w=function(i){function s(e){var s;return(s=i.call(this,e)||this).state=t.State.Ready,s._handles=new I,s._prevInput=null,s._hasPrevInput=!1,s._prevInputIsInternal=!1,s._toolPromise=d.resolve(),s}e._inheritsLoose(s,i);var o=s.prototype;return o.initialize=function(){const t=this.parentViewModel.view;this._graphicsLayer=new f({listMode:"hide",elevationInfo:{mode:"on-the-ground",offset:null}});const e="2d"===t.type?new S({data:{type:"CIMSymbolReference",symbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",effects:[{type:"CIMGeometricEffectDashes",dashTemplate:[5,4],lineDashEnding:"FullGap",controlPointEnding:"NoConstraint"}],enable:!0,capStyle:"Butt",joinStyle:"Round",width:1.5,color:[0,0,0,255]},{type:"CIMSolidStroke",enable:!0,capStyle:"Butt",joinStyle:"Round",width:1.5,color:[255,255,255,255]}]}}}):null;this._sketchVM=new m({layer:this._graphicsLayer,view:t,defaultCreateOptions:{mode:"click",hasZ:!1},updateOnGraphicClick:!1,defaultUpdateOptions:{enableMidpoints:!0,enableRotation:!1,enableScaling:!1,enableMoveAllGraphics:!1,enableZ:!1,multipleSelectionEnabled:!1,toggleToolOnClick:!1,enableMoveGraphic:!1,tool:"reshape"},polylineSymbol:e,activeLineSymbol:e,updatePolylineSymbol:e}),this._handles.add([g.init(this.parentViewModel,["input"],(()=>this._update()),!0),g.init(t,"map",(t=>{null==t||t.add(this._graphicsLayer),this._update()})),this._sketchVM.on("create",(t=>this._onSketchViewModelCreate(t))),this._sketchVM.on("update",(t=>this._onSketchViewModelUpdate(t)))])},o.destroy=function(){var t,e;this._handles.destroy(),this._handles=null,null==(t=this.parentViewModel.view)||null==(e=t.map)||e.remove(this._graphicsLayer),this._sketchVM.destroy(),this._sketchVM=null,this._graphicsLayer.destroy(),this._graphicsLayer=null},o.start=function(e={mode:"sketch"}){this._sketchVM.cancel(),this._stopSelectionInteraction(),this._prevInput||this._storePreviousInput(this._input),this._input=null,this._graphicsLayer.removeAll(),"sketch"===e.mode?(this._set("state",t.State.Creating),this._toolPromise=this._sketchVM.create("polyline")):(this._set("state",t.State.Selecting),this._startSelectionInteraction())},o.stop=function(){switch(this.state){case t.State.Creating:this._stopCreationInteraction(),this._afterInteraction();break;case t.State.Selecting:this._stopSelectionInteraction(),this._afterInteraction()}},o.cancel=function(){switch(this.state){case t.State.Creating:this._sketchVM.cancel(),this._restorePreviousInput(),this._afterInteraction();break;case t.State.Selecting:this._stopSelectionInteraction(),this._restorePreviousInput(),this._afterInteraction()}},o.clear=function(){this._sketchVM.cancel(),this._set("state",t.State.Ready),this._clearPreviousInput(),this._input=null},o._stopCreationInteraction=function(){const t=this._input,e=this.canStopCreating;this._sketchVM.cancel(),!n.isNone(t)&&e?(this._removeLastPoint(t),this._graphicsLayer.removeAll(),this._graphicsLayer.add(t),this._input=t):this._input=null},o._startSelectionInteraction=function(){this._stopSelectionInteraction();const e=this.parentViewModel.view,i=e.cursor;e.cursor="crosshair";const s=r.makeHandle((()=>e.cursor=i));let o=null;const a=r.makeHandle((()=>{n.isSome(o)&&(o.abort(),o=null)})),c=e.on("immediate-click",(i=>{i.preventDefault(),i.stopPropagation(),o=d.createTask((async s=>{const{results:o}=await e.hitTest(i);d.throwIfAborted(s);const a=o.map((t=>t.graphic)).find((t=>n.isSome(t.geometry)&&"polyline"===t.geometry.type));a&&(this._input=a,this._clearPreviousInput(),this._set("state",t.State.Selected),this._stopSelectionInteraction())}))})),l=e.on("key-down",(t=>{"Escape"===t.key&&this.cancel()}));this._handles.add([c,l,a,s],b),e.ready&&v.isDOMContainer(e)&&e.focus()},o._stopSelectionInteraction=function(){this._handles.remove(b)},o._update=function(){const e=this.state,{input:i}=this.parentViewModel;if(e!==t.State.Selecting){if(!(e===t.State.Creating||e===t.State.Reshaping&&this._isInternalGraphic(i))){if(this._sketchVM.cancel(),n.isNone(i))return this._graphicsLayer.removeAll(),void this._set("state",t.State.Ready);this._isInternalGraphic(i)?(this._set("state",t.State.Reshaping),this._toolPromise=this._sketchVM.update(i,{tool:"reshape"})):(this._graphicsLayer.removeAll(),this._set("state",t.State.Selected))}}else this.stop()},o._afterInteraction=function(){this._toolPromise=null,this._clearPreviousInput(),this._set("state",t.State.Ready),this._update()},o._onSketchViewModelCreate=function(t){if("polyline"===t.tool)switch(t.state){case"complete":this._input=t.graphic,this._afterInteraction();break;case"cancel":this.cancel();break;case"active":case"start":this._input=t.graphic}},o._onSketchViewModelUpdate=function(t){switch(t.state){case"complete":this._afterInteraction();break;case"active":case"start":this._input=t.graphics[0]}},o._removeLastPoint=function(t){const e=t.geometry;if(k.isPolyline(e)){const i=e.clone();i.paths=[i.paths[0].slice(0,-1)],t.geometry=i}},o._storePreviousInput=function(t){this._hasPrevInput=!0,this._prevInput=t,this._prevInputIsInternal=this._isInternalGraphic(t)},o._restorePreviousInput=function(){if(!this._hasPrevInput)return;const t=this._prevInput;n.isSome(t)&&this._prevInputIsInternal&&(this._graphicsLayer.removeAll(),this._graphicsLayer.add(t)),this._input=t,this._clearPreviousInput()},o._clearPreviousInput=function(){this._hasPrevInput=null,this._prevInput=null,this._prevInputIsInternal=!1},o._isInternalGraphic=function(t){return n.isSome(t)&&this._graphicsLayer.graphics.includes(t)},e._createClass(s,[{key:"canStopCreating",get:function(){const t=n.applySome(this.parentViewModel.input,(t=>t.geometry));return k.isPolyline(t)&&t.paths.length>0&&t.paths[0].length>2}},{key:"test",get:function(){return{sketchVM:this._sketchVM,toolPromise:this._toolPromise}}}]),s}(y);i.__decorate([c.property({nonNullable:!0})],w.prototype,"state",void 0),i.__decorate([c.property({nonNullable:!0})],w.prototype,"parentViewModel",void 0),i.__decorate([c.property()],w.prototype,"canStopCreating",null),i.__decorate([l.aliasOf("parentViewModel.input")],w.prototype,"_input",void 0),w=i.__decorate([h.subclass("esri.widgets.ElevationProfile.ElevationProfileInteraction")],w);var P=w;t.default=P,Object.defineProperty(t,"__esModule",{value:!0})}));
