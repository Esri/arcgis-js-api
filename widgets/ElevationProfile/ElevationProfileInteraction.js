/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../Graphic","../../core/Accessor","../../core/asyncUtils","../../core/Handles","../../core/handleUtils","../../core/maybe","../../core/promiseUtils","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/arrayUtils","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass","../../layers/GraphicsLayer","../../symbols/CIMSymbol","../../symbols/SimpleLineSymbol","./support/geometryUtils","../Sketch/SketchViewModel"],(function(t,e,i,n,s,o,a,r,c,l,h,p,d,u,_,y,v,S,f,m){"use strict";var g,I;function b(t){return"2d"===t?new v({data:{type:"CIMSymbolReference",symbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",effects:[{type:"CIMGeometricEffectDashes",dashTemplate:[5,4],lineDashEnding:"FullGap",controlPointEnding:"NoConstraint"}],enable:!0,capStyle:"Butt",joinStyle:"Round",width:1.5,color:[0,0,0,255]},{type:"CIMSolidStroke",enable:!0,capStyle:"Butt",joinStyle:"Round",width:1.5,color:[255,255,255,255]}]}}}):new S({color:[0,0,0,0]})}function k(t){if(f.isPolyline(t)){const e=t.clone();return e.paths=[e.paths[0].slice(0,-1)],e}return t}t.State=void 0,(g=t.State||(t.State={})).Ready="ready",g.Creating="creating",g.Reshaping="reshaping",g.ReshapingDisabled="rehsaping-disabled",g.Selecting="selecting",g.Selected="selected",function(t){t.View="view",t.Main="main",t.Interaction="interaction"}(I||(I={})),t.ElevationProfileInteraction=function(i){function s(e){var n;return(n=i.call(this,e)||this).state=t.State.Ready,n._handles=new a,n._pendingStartOptions=null,n._previousInputInfo=null,n._shouldRemoveLastPoint=!1,n._sketchedGraphics=new WeakSet,n._creationToolPromise=null,n._updateToolPromise=null,n._updateDisabled=!1,n}e._inheritsLoose(s,i);var p=s.prototype;return p.initialize=function(){this._handles.add(h.watch((()=>({view:this.tool.viewModel.view,visible:this.tool.visible})),(({view:t,visible:e})=>{c.isSome(t)&&e?this._attach(t):this._detach()}),h.syncAndInitial),I.View)},p.destroy=function(){this._detach(),this._handles=c.destroyMaybe(this._handles)},p.start=function(e={mode:"sketch"}){if(!this.tool.editable)return;const i=this._view;if(!c.isNone(i)&&i.ready)switch(this._pendingStartOptions=null,this._stopInteraction(),c.isNone(this._previousInputInfo)&&this._storePreviousInput(this._input),this._setSketchedGraphic(null),e.mode){case"sketch":this._set("state",t.State.Creating),this._startCreationInteraction();break;case"select":this._set("state",t.State.Selecting),this._startSelectionInteraction()}else this._pendingStartOptions=e},p.stop=function(){this._pendingStartOptions=null,this._stopInteractionAndUpdate(),this._clearPreviousInput()},p.cancel=function(){this._pendingStartOptions=null,this._stopInteractionAndUpdate(),this._restorePreviousInput()},p.clear=function(){this._stopInteractionAndUpdate(),this._set("state",t.State.Ready),this._clearPreviousInput(),this._input=null,this._pendingStartOptions=null},p.isSketchedGraphic=function(t){return c.isSome(t)&&this._sketchedGraphics.has(t)},p._attach=function(t){this._detach();const e={mode:"3d"===t.type?"relative-to-ground":"on-the-ground",offset:null};this._graphicsLayer=new y({listMode:"hide",internal:!0,elevationInfo:e});const i=b(t.type);this._sketchVM=new m({layer:this._graphicsLayer,view:t,defaultCreateOptions:{mode:"click",hasZ:!1},updateOnGraphicClick:!1,defaultUpdateOptions:{reshapeOptions:{shapeOperation:"none"},enableRotation:!1,enableScaling:!1,enableMoveAllGraphics:!1,enableZ:!1,multipleSelectionEnabled:!1,toggleToolOnClick:!1,tool:"reshape"},polylineSymbol:i,updatePolylineSymbol:i,activeLineSymbol:i}),this._handles.add([h.when((()=>t.ready),(()=>c.applySome(this._pendingStartOptions,(t=>this.start(t)))),h.syncAndInitial),h.watch((()=>[this._input,this._visibleAndEditable]),(()=>this._update()),h.syncAndInitial),h.watch((()=>({map:t.map,graphicsLayer:this._graphicsLayer})),(({map:t,graphicsLayer:e})=>{c.isSome(t)&&c.isSome(e)&&t.add(e),this._update()}),h.syncAndInitial)],I.Main)},p._detach=function(){this._handles.remove(I.Main),this._sketchVM=c.destroyMaybe(this._sketchVM),this._creationToolPromise=null,this._updateToolPromise=null;const e=c.applySome(this._view,(t=>t.map)),i=this._graphicsLayer;c.isSome(e)&&c.isSome(i)&&e.remove(i),this._graphicsLayer=c.destroyMaybe(this._graphicsLayer),this._shouldRemoveLastPoint=!1,this._set("state",t.State.Ready)},p._startCreationInteraction=function(){this._stopInteractionAndUpdate();const t=this._view,e=this._sketchVM;if(c.isNone(t)||c.isNone(e))return;this._shouldRemoveLastPoint=!1;const i=e.on("create",(t=>{const e=t.graphic;switch(t.state){case"complete":this._shouldRemoveLastPoint=!1,this._setSketchedGraphic(e),this._stopInteractionAndUpdate(),this._clearPreviousInput();break;case"cancel":this.cancel();break;case"active":this._setSketchedGraphic(e),"cursor-update"===t.toolEventInfo.type&&(this._shouldRemoveLastPoint=!0);break;case"start":this._setSketchedGraphic(e)}})),s=()=>{i.remove();const t=this.canStopCreating,s=c.applySome(this._geometry,(t=>t.clone()));e.cancel(),this._creationToolPromise=null,!c.isNone(s)&&t?this._shouldRemoveLastPoint&&this._setSketchedGraphic(new n({geometry:k(s)})):this._input=null};this._handles.remove(I.Interaction),this._handles.add(r.makeHandle(s),I.Interaction),this._creationToolPromise=l.ignoreAbortErrors(e.create("polyline"))},p._startReshapeInteraction=function(){this._stopInteraction();const t=this._view,e=this._sketchVM;if(c.isNone(t)||c.isNone(e))return;const i=e.on("update",(t=>{const e=t.graphics[0];switch(t.state){case"complete":this._setSketchedGraphic(e),this._stopInteractionAndUpdate(),this._clearPreviousInput();break;case"active":case"start":this._setSketchedGraphic(e)}})),n=()=>{i.remove(),e.cancel(),this._updateToolPromise=null};this._handles.remove(I.Interaction),this._handles.add(r.makeHandle(n),I.Interaction),c.applySome(this._input,(t=>{t.visible=!0,this._updateToolPromise=l.ignoreAbortErrors(e.update(t,{tool:"reshape"}))}))},p._startSelectionInteraction=function(){var t=this;this._stopInteraction();const i=this._view;if(c.isNone(i))return;const n=i.cursor,s=r.makeHandle((()=>i.cursor=n));i.cursor="crosshair",i.popup.close();let a=null;const h=r.makeHandle((()=>c.abortMaybe(a))),p=i.on("immediate-click",(n=>{n.preventDefault(),n.stopPropagation(),c.abortMaybe(a),a=o.createTask(function(){var s=e._asyncToGenerator((function*(e){const{results:s}=yield i.hitTest(n);l.throwIfAborted(e);const o=s.filter((t=>"graphic"===t.type&&null!=t.graphic)).map((t=>t.graphic)).find((t=>c.isSome(t.geometry)&&"polyline"===t.geometry.type));o&&(t._input=o,t._clearPreviousInput(),t._stopInteractionAndUpdate())}));return function(t){return s.apply(this,arguments)}}())})),d=i.on("key-down",(t=>{"Escape"===t.key&&this.cancel()}));this._handles.remove(I.Interaction),this._handles.add([p,d,h,s],I.Interaction),i.ready&&i.focus()},p._stopInteraction=function(){this._handles.remove(I.Interaction)},p._stopInteractionAndUpdate=function(){this._handles.has(I.Interaction)&&(this._updateDisabled=!0,this._stopInteraction(),this._updateDisabled=!1,this._triggerUpdate())},p._triggerUpdate=function(){this._set("state",t.State.Ready),this._update()},p._update=function(){if(this._updateDisabled)return;const e=this.state;if(e!==t.State.Selecting){if(this._visibleAndEditable){if(e===t.State.Creating||e===t.State.Reshaping&&this.isSketchedGraphic(this._input))return}else this.cancel();this._set("state",this._getNextState()),this._updateVisuals()}else this.stop()},p._getNextState=function(){return c.isNone(this._input)?t.State.Ready:this.isSketchedGraphic(this._input)?this.state===t.State.Creating?t.State.Creating:this._visibleAndEditable?t.State.Reshaping:t.State.ReshapingDisabled:t.State.Selected},p._updateVisuals=function(){switch(this.state){case t.State.Creating:break;case t.State.Reshaping:this._startReshapeInteraction();break;case t.State.ReshapingDisabled:{this._stopInteractionAndUpdate();const t=this._input;c.isSome(t)&&this.isSketchedGraphic(t)&&(t.visible=!1);break}case t.State.Ready:case t.State.Selected:this._stopInteractionAndUpdate();case t.State.Selecting:}this._updateSketchedGraphic()},p._storePreviousInput=function(t){this._previousInputInfo={graphic:t}},p._restorePreviousInput=function(){const t=this._previousInputInfo;c.isNone(t)||(this._clearPreviousInput(),this._input=t.graphic,this._triggerUpdate())},p._clearPreviousInput=function(){this._previousInputInfo=null},p._updateSketchedGraphic=function(){const t=this._graphicsLayer;if(c.isNone(t))return;const e=t.graphics,i=this._input;if(c.isNone(i)||!this.isSketchedGraphic(i))return void e.removeAll();if(-1===e.indexOf(i))e.removeAll(),e.add(i);else if(1!==e.length){const t=e.filter((t=>t!==i));e.removeMany(t)}},p._setSketchedGraphic=function(t){c.isSome(t)&&this._sketchedGraphics.add(t),this._input=t,this._updateSketchedGraphic()},e._createClass(s,[{key:"canStopCreating",get:function(){const t=this._geometry,e=this._shouldRemoveLastPoint?3:2;return f.isPolyline(t)&&t.paths.length>0&&t.paths[0].length>=e}},{key:"_input",get:function(){return this.tool.viewModel.input},set:function(t){this.tool.viewModel.input=t}},{key:"_geometry",get:function(){return c.applySome(this._input,(t=>t.geometry))}},{key:"_visibleAndEditable",get:function(){return this.tool.visible&&this.tool.editable}},{key:"_view",get:function(){return this.tool.viewModel.view}},{key:"test",get:function(){return{sketchVM:this._sketchVM,toolPromise:Promise.all([c.unwrapOr(this._creationToolPromise,Promise.resolve()),c.unwrapOr(this._updateToolPromise,Promise.resolve())])}}}]),s}(s),i.__decorate([p.property({nonNullable:!0})],t.ElevationProfileInteraction.prototype,"state",void 0),i.__decorate([p.property({nonNullable:!0})],t.ElevationProfileInteraction.prototype,"tool",void 0),i.__decorate([p.property()],t.ElevationProfileInteraction.prototype,"canStopCreating",null),i.__decorate([p.property()],t.ElevationProfileInteraction.prototype,"_graphicsLayer",void 0),i.__decorate([p.property()],t.ElevationProfileInteraction.prototype,"_sketchVM",void 0),i.__decorate([p.property()],t.ElevationProfileInteraction.prototype,"_input",null),i.__decorate([p.property()],t.ElevationProfileInteraction.prototype,"_geometry",null),i.__decorate([p.property()],t.ElevationProfileInteraction.prototype,"_visibleAndEditable",null),i.__decorate([p.property()],t.ElevationProfileInteraction.prototype,"_view",null),i.__decorate([p.property()],t.ElevationProfileInteraction.prototype,"_shouldRemoveLastPoint",void 0),t.ElevationProfileInteraction=i.__decorate([_.subclass("esri.widgets.ElevationProfile.ElevationProfileInteraction")],t.ElevationProfileInteraction),Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
