/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/Accessor","../../core/Handles","../../core/handleUtils","../../core/maybe","../../core/memoize","../../core/promiseUtils","../../core/reactiveUtils","../../core/throttle","../../core/accessorSupport/decorators/property","../../core/arrayUtils","../../core/has","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass","../../support/elevationInfoUtils","./support/constants","./support/geometryUtils","./support/profileUtils"],(function(e,t,o,r,i,a,l,s,n,p,c,u,d,h,f,_,m,P,v,y){"use strict";const g="line-change";e.ElevationProfileController=function(e){function o(t){var o;return(o=e.call(this,t)||this)._handles=new i,o._updateTask=null,o._paramsPerProfile=new Map,o._getUpdateParametersMemoized=s.memoize(((e,t,o)=>({stationary:e,visibleProfiles:t,generationParameters:o}))),o._getGenerationParametersMemoized=s.memoize(((e,t,o,r,i,a,s)=>v.isPolyline(t)&&v.isValidInputPath(t)&&!l.isNone(r)?{view:e,geometry:t,elevationInfo:o,options:a,queue:r,cache:i,slicePlane:s}:null)),o._getElevationInfoMemoized=s.memoize(((e,t)=>({mode:e,offset:t}))),o._getOptionsMemoized=s.memoize(((e,t,o)=>({geodesicDistanceThreshold:e,samplingDistance:t,densificationMaxSamples:Math.round(P.DENSIFICATION_MAX_SAMPLES/o),maxTotalSamples:P.MAX_TOTAL_SAMPLES}))),o._updateThrottled=c.throttle((e=>n.ignoreAbortErrors(o._update(e))),P.UPDATE_THROTTLE_MILLIS),o}t._inheritsLoose(o,e);var r=o.prototype;return r.initialize=function(){const e=this.viewModel;this._handles.add([p.watch((()=>e.profiles.toArray()),(e=>{this._abortUpdate(),this._paramsPerProfile.clear(),this._handles.remove(g),this._handles.add(e.map((e=>a.handlesGroup([e.attach(this.viewModel),e.on("change",(()=>{this._invalidateProfile(e)}))]))),g)}),p.syncAndInitial),this._updateThrottled,p.watch((()=>this._updateParameters),this._updateThrottled,p.syncAndInitial)])},r.destroy=function(){this._handles.destroy(),this._paramsPerProfile.clear()},r._update=function(){var e=t._asyncToGenerator((function*({stationary:e,visibleProfiles:o,generationParameters:r}){var i=this;this._abortUpdate(),e&&(l.isNone(r)?this._clearResults():this._updateTask=n.createTask(function(){var e=t._asyncToGenerator((function*(e){i.viewModel.error=null;const a=o.filter((e=>!i._isProfileValid(e,r))),l=y.generateProfiles({...r,providers:a},{signal:e});try{var s,p=!1,c=!1;try{for(var u,d=t._asyncIterator(l);p=!(u=yield d.next()).done;p=!1){const t=u.value;n.throwIfAborted(e),i._clearInvalidResults(r);for(let e=0;e<a.length;e++)a[e].result=t[e]}}catch(h){c=!0,s=h}finally{try{p&&null!=d.return&&(yield d.return())}finally{if(c)throw s}}for(const e of a)i._paramsPerProfile.set(e,r)}catch(f){n.throwIfAbortError(f),i._abortUpdate(),i.viewModel.error=f,a.forEach((e=>{e.result=null}))}}));return function(t){return e.apply(this,arguments)}}()))}));function o(t){return e.apply(this,arguments)}return o}(),r._abortUpdate=function(){this._updateTask=l.abortMaybe(this._updateTask)},r._isProfileValid=function(e,t){return this._paramsPerProfile.has(e)&&this._paramsPerProfile.get(e)===t},r._invalidateProfile=function(e){this._paramsPerProfile.delete(e),this._updateThrottled(this._updateParameters)},r._clearInvalidResults=function(e){for(const t of this.viewModel.profiles.items)this._isProfileValid(t,e)||(t.result=null,this._paramsPerProfile.delete(t))},r._clearResults=function(){for(const e of this.viewModel.profiles.items)e.result=null,this._paramsPerProfile.delete(e)},t._createClass(o,[{key:"_updateParameters",get:function(){const{viewModel:e}=this,t=e.view;return this._getUpdateParametersMemoized(!l.isSome(t)||t.stationary,this.viewModel.visibleProfiles,this._generationParameters)}},{key:"_generationParameters",get:function(){const{view:e,input:t,queue:o,tileCache:r}=this.viewModel;return l.isNone(e)||!e.ready?null:this._getGenerationParametersMemoized(e,l.applySome(t,(e=>e.geometry)),this._elevationInfo,o,r,this._options,"3d"===e.type?e.slicePlane:null)}},{key:"_elevationInfo",get:function(){const e=l.applySome(this.viewModel.input,(e=>m.hasGraphicFeatureExpressionInfo(e)?null:m.getGraphicEffectiveElevationInfo(e)));return l.isSome(e)?this._getElevationInfoMemoized(e.mode,e.offset):null}},{key:"_options",get:function(){const e=this.viewModel,t=e.visibleProfiles.length;let o=l.unwrapOr(e.minDemResolution,P.DEFAULT_DEM_RESOLUTION);return o=parseFloat(o.toFixed(2)),this._getOptionsMemoized(e.geodesicDistanceThreshold,o,t)}}]),o}(r),o.__decorate([u.property({nonNullable:!0})],e.ElevationProfileController.prototype,"viewModel",void 0),o.__decorate([u.property()],e.ElevationProfileController.prototype,"_updateParameters",null),o.__decorate([u.property()],e.ElevationProfileController.prototype,"_generationParameters",null),o.__decorate([u.property()],e.ElevationProfileController.prototype,"_elevationInfo",null),o.__decorate([u.property()],e.ElevationProfileController.prototype,"_options",null),e.ElevationProfileController=o.__decorate([_.subclass("esri.widgets.ElevationProfile.ElevationProfileController")],e.ElevationProfileController),Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
