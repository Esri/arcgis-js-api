/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/Accessor","../../core/asyncUtils","../../core/Handles","../../core/handleUtils","../../core/maybe","../../core/memoize","../../core/promiseUtils","../../core/reactiveUtils","../../core/throttle","../../core/accessorSupport/decorators/property","../../core/arrayUtils","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass","../../support/elevationInfoUtils","./support/constants","./support/geometryUtils","./support/profileUtils"],(function(e,t,o,r,i,a,l,s,n,p,c,u,d,f,h,_,m,P,v,y){"use strict";const g="line-change";e.ElevationProfileController=function(e){function o(t){var o;return(o=e.call(this,t)||this)._handles=new a,o._updateTask=null,o._paramsPerProfile=new Map,o._getUpdateParametersMemoized=n.memoize(((e,t,o)=>({stationary:e,visibleProfiles:t,generationParameters:o}))),o._getGenerationParametersMemoized=n.memoize(((e,t,o,r,i,a,l)=>v.isPolyline(t)&&v.isValidInputPath(t)&&!s.isNone(r)?{view:e,geometry:t,elevationInfo:o,options:a,queue:r,cache:i,slicePlane:l}:null)),o._getElevationInfoMemoized=n.memoize(((e,t)=>({mode:e,offset:t}))),o._getOptionsMemoized=n.memoize(((e,t,o)=>{const{densificationMaxSamples:r,maxTotalSamples:i}=P.getConfig();return{geodesicDistanceThreshold:e,samplingDistance:t,densificationMaxSamples:Math.round(r/o),maxTotalSamples:i}})),o._updateThrottled=u.throttle((e=>p.ignoreAbortErrors(o._update(e))),P.getConfig().updateThrottleMillis),o}t._inheritsLoose(o,e);var r=o.prototype;return r.initialize=function(){const e=this.viewModel;this._handles.add([c.watch((()=>e.profiles.toArray()),(e=>{this._abortUpdate(),this._paramsPerProfile.clear(),this._handles.remove(g),this._handles.add(e.map((e=>l.handlesGroup([e.attach(this.viewModel),e.on("change",(()=>{this._invalidateProfile(e)}))]))),g)}),c.syncAndInitial),this._updateThrottled,c.watch((()=>this._updateParameters),this._updateThrottled,c.syncAndInitial)])},r.destroy=function(){this._handles.destroy(),this._paramsPerProfile.clear()},r._update=function(){var e=t._asyncToGenerator((function*({stationary:e,visibleProfiles:o,generationParameters:r}){var a=this;this._abortUpdate(),e&&(s.isNone(r)?this._clearResults():this._updateTask=i.createTask(function(){var e=t._asyncToGenerator((function*(e){a.viewModel.error=null;const i=o.filter((e=>!a._isProfileValid(e,r))),l=y.generateProfiles({...r,providers:i},{signal:e});try{var s,n=!1,c=!1;try{for(var u,d=t._asyncIterator(l);n=!(u=yield d.next()).done;n=!1){const t=u.value;p.throwIfAborted(e),a._clearInvalidResults(r);for(let e=0;e<i.length;e++)i[e].result=t[e]}}catch(f){c=!0,s=f}finally{try{n&&null!=d.return&&(yield d.return())}finally{if(c)throw s}}for(const e of i)a._paramsPerProfile.set(e,r)}catch(h){p.throwIfAbortError(h),a._abortUpdate(),a.viewModel.error=h,i.forEach((e=>{e.result=null}))}}));return function(t){return e.apply(this,arguments)}}()))}));function o(t){return e.apply(this,arguments)}return o}(),r._abortUpdate=function(){this._updateTask=s.abortMaybe(this._updateTask)},r._isProfileValid=function(e,t){return this._paramsPerProfile.has(e)&&this._paramsPerProfile.get(e)===t},r._invalidateProfile=function(e){this._paramsPerProfile.delete(e),this._updateThrottled(this._updateParameters)},r._clearInvalidResults=function(e){for(const t of this.viewModel.profiles.items)this._isProfileValid(t,e)||(t.result=null,this._paramsPerProfile.delete(t))},r._clearResults=function(){for(const e of this.viewModel.profiles.items)e.result=null,this._paramsPerProfile.delete(e)},t._createClass(o,[{key:"_updateParameters",get:function(){const{viewModel:e}=this,t=e.view;return this._getUpdateParametersMemoized(!s.isSome(t)||t.stationary,this.viewModel.visibleProfiles,this._generationParameters)}},{key:"_generationParameters",get:function(){const{view:e,input:t,queue:o,tileCache:r}=this.viewModel;return s.isNone(e)||!e.ready?null:this._getGenerationParametersMemoized(e,s.applySome(t,(e=>e.geometry)),this._elevationInfo,o,r,this._options,"3d"===e.type?e.slicePlane:null)}},{key:"_elevationInfo",get:function(){const e=s.applySome(this.viewModel.input,(e=>m.hasGraphicFeatureExpressionInfo(e)?null:m.getGraphicEffectiveElevationInfo(e)));return s.isSome(e)?this._getElevationInfoMemoized(e.mode,e.offset):null}},{key:"_options",get:function(){const e=this.viewModel,t=e.visibleProfiles.length;let o=s.unwrapOr(e.minDemResolution,P.getConfig().defaultDemResolution);return o=parseFloat(o.toFixed(2)),this._getOptionsMemoized(e.geodesicDistanceThreshold,o,t)}}]),o}(r),o.__decorate([d.property({nonNullable:!0})],e.ElevationProfileController.prototype,"viewModel",void 0),o.__decorate([d.property()],e.ElevationProfileController.prototype,"_updateParameters",null),o.__decorate([d.property()],e.ElevationProfileController.prototype,"_generationParameters",null),o.__decorate([d.property()],e.ElevationProfileController.prototype,"_elevationInfo",null),o.__decorate([d.property()],e.ElevationProfileController.prototype,"_options",null),e.ElevationProfileController=o.__decorate([_.subclass("esri.widgets.ElevationProfile.ElevationProfileController")],e.ElevationProfileController),Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
