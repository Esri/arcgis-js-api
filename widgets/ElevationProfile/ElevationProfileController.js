/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/has","../../core/maybe","../../core/Logger","../../core/accessorSupport/ensureType","../../core/handleUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/subclass","../../core/urlUtils","../../core/uuid","../../portal/support/resourceExtension","../../core/promiseUtils","../../core/accessorSupport/trackingUtils","../../core/Accessor","../../core/Handles","../../core/memoize","../../core/throttle","../../support/elevationInfoUtils","./support/constants","./support/geometryUtils","./support/profileUtils"],(function(e,t,r,o,i,s,a,l,n,p,c,u,d,h,_,f,P,m,v,g,y,M,E){"use strict";const T="line-change";e.ElevationProfileController=function(e){function r(t){var r;return(r=e.call(this,t)||this)._handles=new P,r._updateTask=null,r._paramsPerProfile=new Map,r._getUpdateParametersMemoized=m.memoize(((e,t,r)=>({stationary:e,visibleProfiles:t,generationParameters:r}))),r._getGenerationParametersMemoized=m.memoize(((e,t,r,o,s,a)=>M.isPolyline(t)&&M.isValidInputPath(t)&&!i.isNone(o)?{view:e,geometry:t,elevationInfo:r,options:a,queue:o,cache:s}:null)),r._getOptionsMemoized=m.memoize(((e,t,r)=>({geodesicDistanceThreshold:e,samplingDistance:i.unwrapOr(t,y.DEFAULT_DEM_RESOLUTION),densificationMaxSamples:Math.round(y.DENSIFICATION_MAX_SAMPLES/r),maxTotalSamples:y.MAX_TOTAL_SAMPLES}))),r._updateThrottled=v.throttle((e=>h.ignoreAbortErrors(r._update(e))),y.UPDATE_THROTTLE_MILLIS),r}t._inheritsLoose(r,e);var o=r.prototype;return o.initialize=function(){const e=this.viewModel;this._handles.add([_.reactionInit((()=>e.profiles.toArray()),(e=>{this._abortUpdate(),this._paramsPerProfile.clear(),this._handles.remove(T),this._handles.add(e.map((e=>l.handlesGroup([e.attach(this.viewModel),e.on("change",(()=>{this._invalidateProfile(e)}))]))),T)})),this._updateThrottled,_.reactionInit((()=>this._updateParameters),this._updateThrottled)])},o.destroy=function(){this._handles.destroy(),this._paramsPerProfile.clear()},o._update=async function({stationary:e,visibleProfiles:t,generationParameters:r}){this._abortUpdate(),e&&(i.isNone(r)?this._clearResults():this._updateTask=h.createTask((async e=>{this.viewModel.error=null;const o=t.filter((e=>!this._isProfileValid(e,r))),i=E.generateProfiles({...r,providers:o},{signal:e});try{for await(const t of i){h.throwIfAborted(e),this._clearInvalidResults(r);for(let e=0;e<o.length;e++)o[e].result=t[e]}for(const e of o)this._paramsPerProfile.set(e,r)}catch(s){h.throwIfAbortError(s),this._abortUpdate(),this.viewModel.error=s,o.forEach((e=>{e.result=null}))}})))},o._abortUpdate=function(){this._updateTask=i.abortMaybe(this._updateTask)},o._isProfileValid=function(e,t){return this._paramsPerProfile.has(e)&&this._paramsPerProfile.get(e)===t},o._invalidateProfile=function(e){this._paramsPerProfile.delete(e),this._updateThrottled(this._updateParameters)},o._clearInvalidResults=function(e){for(const t of this.viewModel.profiles.items)this._isProfileValid(t,e)||(t.result=null,this._paramsPerProfile.delete(t))},o._clearResults=function(){for(const e of this.viewModel.profiles.items)e.result=null,this._paramsPerProfile.delete(e)},t._createClass(r,[{key:"_updateParameters",get:function(){const{viewModel:e}=this,t=e.view;return this._getUpdateParametersMemoized(!i.isSome(t)||t.stationary,this.viewModel.visibleProfiles,this._generationParameters)}},{key:"_generationParameters",get:function(){const{view:e,input:t,queue:r,tileCache:o}=this.viewModel;if(i.isNone(e))return null;const s=i.applySome(t,(e=>e.geometry)),a=i.applySome(t,(e=>g.hasGraphicFeatureExpressionInfo(e)?null:g.getGraphicEffectiveElevationInfo(e)));return this._getGenerationParametersMemoized(e,s,a,r,o,this._options)}},{key:"_options",get:function(){const e=this.viewModel,t=e.visibleProfiles.length;return this._getOptionsMemoized(e.geodesicDistanceThreshold,e.minDemResolution,t)}}]),r}(f),r.__decorate([n.property({nonNullable:!0})],e.ElevationProfileController.prototype,"viewModel",void 0),r.__decorate([n.property()],e.ElevationProfileController.prototype,"_updateParameters",null),r.__decorate([n.property()],e.ElevationProfileController.prototype,"_generationParameters",null),r.__decorate([n.property()],e.ElevationProfileController.prototype,"_options",null),e.ElevationProfileController=r.__decorate([p.subclass("esri.widgets.ElevationProfile.ElevationProfileController")],e.ElevationProfileController),Object.defineProperty(e,"__esModule",{value:!0})}));
