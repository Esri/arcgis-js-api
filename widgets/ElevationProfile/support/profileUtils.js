/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../core/maybe","../../../core/arrayUtils","../../../core/promiseUtils","../../../geometry/Multipoint","../../../core/unitUtils","../../../views/support/Scheduler","../../../geometry/support/geodesicUtils","../../../views/support/QueueProcessor","./geometryUtils","./constants","./statisticsUtils","./traversal"],(function(e,t,s,r,n,i,o,a,l,c,u,p,d){"use strict";async function f({densificationResult:e,result:t,provider:s,queue:r,signal:i,cache:o},a,l){const{densifiedPath:c,pathLength:d}=e,f=c.paths[0],h=a.map((e=>f[e])),g=l?Math.round(d/s.numSamplesForPreview):Math.round(d/f.length);await r.push({geometry:new n({spatialReference:c.spatialReference,points:h,hasZ:c.hasZ}),provider:s,indices:a,result:t,queryOptions:{...u.DEFAULT_ELEVATION_PROFILE_QUERY_OPTIONS,minDemResolution:g,cache:o}},{signal:i});const y=t.samples.filter((e=>e.processed));return t.progress=l?0:t.progress+a.length/f.length,t.statistics=p.getStatistics(t.samples,t.spatialReference),{...t,samples:y}}function h(e){const s=e.densifiedPath,r=s.spatialReference,n=e.densifiedPathInMeasurementSR;let o=s.paths[0];const l=o.length;let c=0;const u=new Array(l);if(u[0]=g(o[0],c),t.isSome(n)){const e=o;o=n.paths[0];const t=i.getMetersPerUnitForSR(r),s={distance:0},p=n.spatialReference;for(let r=1;r<l;r++)a.inverseGeodeticSolver(s,o[r-1],o[r],p),c+=s.distance/t,u[r]=g(e[r],c)}else for(let e=1;e<l;e++){const t=o[e],s=o[e-1],r=t[0]-s[0],n=t[1]-s[1];c+=Math.sqrt(r*r+n*n),u[e]=g(t,c)}return{progress:0,samples:u,statistics:null,spatialReference:r}}function g([e,t],s){return{x:e,y:t,z:null,distance:s,processed:!1}}e.createProfileQueue=function(e){return new l.QueueProcessor({task:o.Task.ELEVATION_PROFILE,concurrency:1,scheduler:e,process:async e=>{r.throwIfAborted(e.queryOptions);try{await async function({geometry:e,provider:t,indices:s,result:r,queryOptions:n}){if(0===s.length)return null;const i=(await t.queryElevation(e,n)).geometry,o=n.noDataValue,a=r.samples;for(let e=0;e<s.length;e++){const t=a[s[e]],{hasZ:r,z:n}=i.getPoint(e);t.z=r&&n!==o?n:null,t.processed=!0}}(e)}catch(e){if(r.isAbortError(e))return}}})},e.generateProfile=async function*(e){const t={signal:e.signal},n=e.path;if(!c.isPolyline(n)||!c.isValidInputPath(n))return null;const i=e.view.spatialReference,o=await c.densifyPath(n,i,e.options,t),a={...e,path:n,densificationResult:o,result:h(o)},l=d.getIndices(0,o.densifiedPath.paths[0].length),p=l.slice(0,a.provider.numSamplesForPreview);yield await f(a,p,!0),r.throwIfAborted(t),await r.after(u.DELAY_AFTER_PREVIEW_MILLIS),r.throwIfAborted(t);const g=s.splitIntoChunks(l,a.provider.numSamplesPerChunk);for(const e of g)yield await f(a,e,!1),r.throwIfAborted(t);a.result.progress=1,yield a.result},Object.defineProperty(e,"__esModule",{value:!0})}));
