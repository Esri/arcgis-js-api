/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/arrayUtils","../../../core/mathUtils","../../../core/maybe","../../../core/promiseUtils","../../../geometry/Multipoint","../../../views/support/QueueProcessor","../../../views/support/Scheduler","./constants","./geometryUtils","./ProfileGenerationError","./statisticsUtils","../../support/traversalUtils"],(function(e,r,t,n,o,i,s,l,a,u,c,p,f,d){"use strict";function h(e,r){return y.apply(this,arguments)}function y(){return(y=r._wrapAsyncGenerator((function*(e,t){var n;const{view:s,geometry:l,elevationInfo:a,providers:f,options:d}=e;if(o.isNone(l)||!c.isValidInputPath(l))throw new p.ProfileGenerationError(p.ProfileGenerationErrorCause.InvalidGeometry);const h=s.spatialReference,y=f.length;if(0===y)return o.none;const P=Math.round(d.maxTotalSamples/y);if(c.countPoints(l)>P)throw new p.ProfileGenerationError(p.ProfileGenerationErrorCause.TooComplex);const g=yield r._awaitAsyncGenerator(c.densifyPath(l,a,s,h,d,P,t));let w=0;const E=new Array(y),v=new Array(y);for(let r=0;r<y;r++){const n=R(g);E[r]=n,w+=n.samples.length;const o={...e,provider:f[r],result:n,densificationResult:g};v[r]=m(o,t)[Symbol.iterator]()}if(w>d.maxTotalSamples)throw new p.ProfileGenerationError(p.ProfileGenerationErrorCause.TooComplex);const _=yield r._awaitAsyncGenerator(Promise.all(v.map((e=>{const r=e.next();return!0===r.done?Promise.resolve(null):r.value}))));i.throwIfAborted(t);for(let r=0;r<y;r++)E[r]=_[r];yield E,yield r._awaitAsyncGenerator(i.after(null!=(n=e.delayAfterPreview)?n:u.DELAY_AFTER_PREVIEW_MILLIS,null,t.signal));const A=[];try{let e;do{e=!1;for(let r=0;r<y;r++){const t=v[r].next();!1===t.done&&(A.push({resultPromise:t.value,index:r}),e=!0)}}while(e)}finally{v.forEach((e=>null==e.return?void 0:e.return()))}for(const{resultPromise:o,index:u}of A)E[u]=yield r._awaitAsyncGenerator(o),i.throwIfAborted(t),yield E;o.forEachSome(E,(e=>{e.progress=1})),yield E}))).apply(this,arguments)}function*m(e,r){const{densificationResult:n}=e,o={...e,abortOptions:r,densificationResult:n},i=d.breadthFirstBinaryPartitioning(0,o.result.samples.length),s=i.slice(0,o.provider.numSamplesForPreview);yield P(o,s,!0);const l=t.splitIntoChunks(i,o.provider.numSamplesPerChunk);for(const t of l)yield P(o,t,!1)}function P(e,r,t){return g.apply(this,arguments)}function g(){return(g=r._asyncToGenerator((function*({densificationResult:e,result:r,provider:t,queue:n,abortOptions:o,cache:l},a,c){const{densifiedPath:p,pathLength:f}=e,d=r.spatialReference,{samples:h}=r,y=new Array(a.length);for(let i=0;i<a.length;i++){const e=h[a[i]];y[i]=e.coordinate}try{return yield n.push({geometry:new s({spatialReference:d,points:y,hasZ:p.hasZ}),provider:t,indices:a,preview:c,result:r,queryOptions:{...u.DEFAULT_ELEVATION_PROFILE_QUERY_OPTIONS,minDemResolution:c?Math.round(f/t.numSamplesForPreview):Math.round(f/h.length),cache:l}},o),{...r}}catch(m){return i.isAbortError(m)?null:u.ERROR_RESULT}}))).apply(this,arguments)}function w(e){return new l.QueueProcessor({priority:a.TaskPriority.ELEVATION_PROFILE,concurrency:1,scheduler:e,process:(t=r._asyncToGenerator((function*(e){i.throwIfAborted(e.queryOptions);try{yield E(e)}catch(r){i.throwIfNotAbortError(r)}})),function(e){return t.apply(this,arguments)})});var t}function E(e){return v.apply(this,arguments)}function v(){return(v=r._asyncToGenerator((function*({geometry:e,provider:r,indices:t,preview:n,result:o,queryOptions:i}){if(0===t.length)return;const s=(yield T(r,e,i)).geometry,{hasZ:l,points:a}=s,u=i.noDataValue,{samples:c}=o;for(let p=0;p<t.length;p++){const e=c[t[p]];if(e.isHole)continue;const r=l?a[p][2]:null;null===r||r===u?e.sampledZ=null:(o.hasZ=!0,e.sampledZ=r),e.sampled=!0}_(c),o.progress=n?0:o.progress+t.length/c.length,o.statistics=f.getStatistics(o.samples,o.spatialReference)}))).apply(this,arguments)}function _(e){const r=e.length-1;let t=0;for(let n=1;n<=r;n++){(e[n].sampled||n===r)&&(A(e,t,n),t=n)}}function A(e,r,t){if(t-r==1)return;const i=e[r],s=i.sampledZ,l=e[t],a=l.sampledZ;if(o.isNone(s)||o.isNone(a)){for(let n=r+1;n<t;n++)e[n].sampledZ=null;return}const u=i.distance,c=l.distance-u;for(let o=r+1;o<t;o++){const r=e[o],t=(r.distance-u)/c;r.sampledZ=n.lerp(s,a,t)}}function R({densifiedPath:e,distances:r}){const t=e.spatialReference,n=e.paths,o=n.length,i=2*(o-1),s=n.reduce(((e,r)=>e+r.length),0)+i,l=new Array(s);let a=0,u=null,c=0;const p=(e,r,t,n)=>{l[a++]=I(e,t),l[a++]=I(r,n)};for(let f=0;f<o;f++){const e=n[f],t=r[f];for(let r=0;r<e.length;r++){const n=e[r],o=t[r];u&&0===r&&p(u,n,c,o),l[a++]=G(n,o),u=n,c=o}}return{progress:0,samples:l,hasZ:!1,statistics:null,spatialReference:t}}function G(e,r){return{coordinate:e,distance:r,sampledZ:null,sampled:!1,isHole:!1}}function I(e,r){return{coordinate:e,distance:r,sampledZ:null,sampled:!0,isHole:!0}}function T(e,r,t){return S.apply(this,arguments)}function S(){return(S=r._asyncToGenerator((function*(e,r,t){try{return yield e.queryElevation(r,t)}catch(n){throw new p.ProfileGenerationError(p.ProfileGenerationErrorCause.ElevationQueryError)}}))).apply(this,arguments)}e.createProfileQueue=w,e.generateProfile=m,e.generateProfiles=h,e.interpolateElevations=_,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
