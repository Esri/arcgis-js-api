/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/arrayUtils","../../../core/mathUtils","../../../core/maybe","../../../core/promiseUtils","../../../geometry/Multipoint","../../../geometry/support/coordsUtils","../../../geometry/support/spatialReferenceUtils","../../../views/support/QueueProcessor","../../../views/support/Scheduler","./constants","./geometryUtils","./ProfileGenerationError","./statisticsUtils","../../support/traversalUtils"],(function(e,t,r,n,o,i,s,l,a,u,c,p,f,d,y,h){"use strict";function m(e,t){return g.apply(this,arguments)}function g(){return(g=t._wrapAsyncGenerator((function*(e,r){const{view:n,geometry:s,elevationInfo:l,providers:a,options:u}=e,c=n.spatialReference;if(!c||o.isNone(s)||!f.isValidInputPath(s))throw new d.ProfileGenerationError(d.ProfileGenerationErrorCause.InvalidGeometry);const y=a.length;if(0===y)return o.none;const h=Math.round(u.maxTotalSamples/y);if(f.countPoints(s)>h)throw new d.ProfileGenerationError(d.ProfileGenerationErrorCause.TooComplex);const m=yield t._awaitAsyncGenerator(f.densifyPath(s,l,n,c,u,h,r));let g=0;const w=new Array(y),v=new Array(y);for(let t=0;t<y;t++){const n=Z(m);w[t]=n,g+=n.samples.length;const o={...e,provider:a[t],result:n,densificationResult:m};v[t]=P(o,r)[Symbol.iterator]()}if(g>u.maxTotalSamples)throw new d.ProfileGenerationError(d.ProfileGenerationErrorCause.TooComplex);const E=yield t._awaitAsyncGenerator(Promise.all(v.map((e=>{const t=e.next();return!0===t.done?Promise.resolve(null):t.value}))));i.throwIfAborted(r);for(let t=0;t<y;t++)w[t]=E[t];yield w,yield t._awaitAsyncGenerator(i.after(e.delayAfterPreview??p.getConfig().delayAfterPreviewMillis,null,r.signal));const G=[];try{let e;do{e=!1;for(let t=0;t<y;t++){const r=v[t].next();!1===r.done&&(G.push({resultPromise:r.value,index:t}),e=!0)}}while(e)}finally{v.forEach((e=>e.return?.()))}for(const{resultPromise:o,index:p}of G)w[p]=yield t._awaitAsyncGenerator(o),i.throwIfAborted(r),yield w;o.forEachSome(w,(e=>{e.progress=1})),yield w}))).apply(this,arguments)}function*P(e,t){const{densificationResult:n}=e,o={...e,abortOptions:t,densificationResult:n},i=h.breadthFirstBinaryPartitioning(0,o.result.samples.length),s=i.slice(0,o.provider.numSamplesForPreview);yield w(o,s,!0);const l=r.splitIntoChunks(i,o.provider.numSamplesPerChunk);for(const r of l)yield w(o,r,!1)}function w(e,t,r){return v.apply(this,arguments)}function v(){return(v=t._asyncToGenerator((function*({densificationResult:e,result:t,provider:r,queue:n,abortOptions:o,cache:l},a,u){const{densifiedPath:c,pathLength:f}=e,d=t.spatialReference,{samples:y}=t,h=[];for(let i=0;i<a.length;i++){const e=y[a[i]];h[i]=e.coordinate}try{return yield n.push({geometry:new s({spatialReference:d,points:h,hasZ:c.hasZ}),provider:r,indices:a,preview:u,result:t,queryOptions:{...p.getConfig().defaultQueryOptions(),minDemResolution:u?Math.round(f/r.numSamplesForPreview):Math.round(f/y.length),cache:l}},o),{...t}}catch(m){return i.isAbortError(m)?null:p.ERROR_RESULT}}))).apply(this,arguments)}function E(e){return new u.QueueProcessor({priority:c.TaskPriority.ELEVATION_PROFILE,concurrency:1,scheduler:e,process:(r=t._asyncToGenerator((function*(e){i.throwIfAborted(e.queryOptions);try{yield G(e)}catch(t){i.throwIfNotAbortError(t)}})),function(e){return r.apply(this,arguments)})});var r}function G(e){return R.apply(this,arguments)}function R(){return(R=t._asyncToGenerator((function*({geometry:e,provider:t,indices:r,preview:n,result:o,queryOptions:i}){if(0===r.length)return;const s=(yield C(t,e,i)).geometry,{hasZ:l,points:a}=s,u=i.noDataValue,{samples:c}=o;for(let p=0;p<r.length;p++){const e=c[r[p]];if(e.isHole)continue;const t=l?a[p][2]:null;null===t||t===u?e.sampledZ=null:(o.hasZ=!0,e.sampledZ=t),e.sampled=!0}A(c),o.progress=n?0:o.progress+r.length/c.length,o.statistics=y.getStatistics(o.samples,o.spatialReference)}))).apply(this,arguments)}function A(e){const t=e.length-1;let r=0;for(let n=1;n<=t;n++){(e[n].sampled||n===t)&&(b(e,r,n),r=n)}}function b(e,t,r){if(r-t==1)return;const i=e[t],s=i.sampledZ,l=e[r],a=l.sampledZ;if(o.isNone(s)||o.isNone(a)){for(let n=t+1;n<r;n++)e[n].sampledZ=null;return}const u=i.distance,c=l.distance-u;for(let o=t+1;o<r;o++){const t=e[o],r=(t.distance-u)/c;t.sampledZ=n.lerp(s,a,r)}}function Z({densifiedPath:e,distances:t}){const r=e.spatialReference,n=a.getInfo(r),o=e.paths,i=o.length,s=[];let u=null,c=0;for(let a=0;a<i;a++){const e=o[a],r=e.length,i=t[a];for(let t=0;t<r;t++){const r=e[t],o=i[t];n&&(r[0]=l.unnormalizedCoordinate(r[0],n.valid[0],n.valid[1])),u&&0===t&&S(s,u,r,c,o),s.push(T(r,o)),u=r,c=o}}return{progress:0,samples:s,hasZ:!1,statistics:null,spatialReference:r}}function S(e,t,r,n,o){e.push(_(t,n)),e.push(_(r,o))}function T(e,t){return{coordinate:e,distance:t,sampledZ:null,sampled:!1,isHole:!1}}function _(e,t){return{coordinate:e,distance:t,sampledZ:null,sampled:!0,isHole:!0}}function C(e,t,r){return I.apply(this,arguments)}function I(){return(I=t._asyncToGenerator((function*(e,t,r){try{return yield e.queryElevation(t,r)}catch(n){throw new d.ProfileGenerationError(d.ProfileGenerationErrorCause.ElevationQueryError)}}))).apply(this,arguments)}e.createProfileQueue=E,e.generateProfile=P,e.generateProfiles=m,e.interpolateElevations=A,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
