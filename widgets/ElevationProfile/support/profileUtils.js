/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/arrayUtils","../../../core/mathUtils","../../../core/maybe","../../../core/promiseUtils","../../../geometry/Multipoint","../../../views/support/QueueProcessor","../../../views/support/Scheduler","./constants","./geometryUtils","./ProfileGenerationError","./statisticsUtils","../../support/traversalUtils"],(function(e,t,r,n,o,s,i,l,a,c,u,p,f,d){"use strict";function h(e,t){return y.apply(this,arguments)}function y(){return(y=t._wrapAsyncGenerator((function*(e,r){var n;const{view:i,geometry:l,elevationInfo:a,providers:f,options:d}=e;if(o.isNone(l)||!u.isValidInputPath(l))throw new p.ProfileGenerationError("invalid-geometry");const h=i.spatialReference,y=f.length;if(0===y)return o.none;const g=Math.round(d.maxTotalSamples/y);if(u.countPoints(l)>g)throw new p.ProfileGenerationError("too-complex");const w=yield t._awaitAsyncGenerator(u.densifyPath(l,a,i,h,d,g,r));let P=0;const v=new Array(y),E=new Array(y);for(let t=0;t<y;t++){const n=R(w);v[t]=n,P+=n.samples.length;const o={...e,provider:f[t],result:n,densificationResult:w};E[t]=m(o,r)[Symbol.iterator]()}if(P>d.maxTotalSamples)throw new p.ProfileGenerationError("too-complex");const _=yield t._awaitAsyncGenerator(Promise.all(E.map((e=>{const t=e.next();return!0===t.done?Promise.resolve(null):t.value}))));s.throwIfAborted(r);for(let t=0;t<y;t++)v[t]=_[t];yield v,yield t._awaitAsyncGenerator(s.after(null!=(n=e.delayAfterPreview)?n:c.DELAY_AFTER_PREVIEW_MILLIS,null,r.signal));const A=[];try{let e;do{e=!1;for(let t=0;t<y;t++){const r=E[t].next();!1===r.done&&(A.push({resultPromise:r.value,index:t}),e=!0)}}while(e)}finally{E.forEach((e=>null==e.return?void 0:e.return()))}for(const{resultPromise:o,index:c}of A)v[c]=yield t._awaitAsyncGenerator(o),s.throwIfAborted(r),yield v;o.forEachSome(v,(e=>{e.progress=1})),yield v}))).apply(this,arguments)}function*m(e,t){const{densificationResult:n}=e,o={...e,abortOptions:t,densificationResult:n},s=d.breadthFirstBinaryPartitioning(0,o.result.samples.length),i=s.slice(0,o.provider.numSamplesForPreview);yield g(o,i,!0);const l=r.splitIntoChunks(s,o.provider.numSamplesPerChunk);for(const r of l)yield g(o,r,!1)}function g(e,t,r){return w.apply(this,arguments)}function w(){return(w=t._asyncToGenerator((function*({densificationResult:e,result:t,provider:r,queue:n,abortOptions:o,cache:l},a,u){const{densifiedPath:p,pathLength:f}=e,d=t.spatialReference,{samples:h}=t,y=new Array(a.length);for(let s=0;s<a.length;s++){const e=h[a[s]];y[s]=e.coordinate}try{return yield n.push({geometry:new i({spatialReference:d,points:y,hasZ:p.hasZ}),provider:r,indices:a,preview:u,result:t,queryOptions:{...c.DEFAULT_ELEVATION_PROFILE_QUERY_OPTIONS,minDemResolution:u?Math.round(f/r.numSamplesForPreview):Math.round(f/h.length),cache:l}},o),{...t}}catch(m){return s.isAbortError(m)?null:c.ERROR_RESULT}}))).apply(this,arguments)}function P(e){return new l.QueueProcessor({priority:a.TaskPriority.ELEVATION_PROFILE,concurrency:1,scheduler:e,process:(r=t._asyncToGenerator((function*(e){s.throwIfAborted(e.queryOptions);try{yield v(e)}catch(t){s.throwIfNotAbortError(t)}})),function(e){return r.apply(this,arguments)})});var r}function v(e){return E.apply(this,arguments)}function E(){return(E=t._asyncToGenerator((function*({geometry:e,provider:t,indices:r,preview:n,result:o,queryOptions:s}){if(0===r.length)return;const i=(yield O(t,e,s)).geometry,{hasZ:l,points:a}=i,c=s.noDataValue,{samples:u}=o;for(let p=0;p<r.length;p++){const e=u[r[p]];if(e.isHole)continue;const t=l?a[p][2]:null;null===t||t===c?e.sampledZ=null:(o.hasZ=!0,e.sampledZ=t),e.sampled=!0}_(u),o.progress=n?0:o.progress+r.length/u.length,o.statistics=f.getStatistics(o.samples,o.spatialReference)}))).apply(this,arguments)}function _(e){const t=e.length-1;let r=0;for(let n=1;n<=t;n++){(e[n].sampled||n===t)&&(A(e,r,n),r=n)}}function A(e,t,r){if(r-t==1)return;const s=e[t],i=s.sampledZ,l=e[r],a=l.sampledZ;if(o.isNone(i)||o.isNone(a)){for(let n=t+1;n<r;n++)e[n].sampledZ=null;return}const c=s.distance,u=l.distance-c;for(let o=t+1;o<r;o++){const t=e[o],r=(t.distance-c)/u;t.sampledZ=n.lerp(i,a,r)}}function R({densifiedPath:e,distances:t}){const r=e.spatialReference,n=e.paths,o=n.length,s=2*(o-1),i=n.reduce(((e,t)=>e+t.length),0)+s,l=new Array(i);let a=0,c=null,u=0;const p=(e,t,r,n)=>{l[a++]=G(e,r),l[a++]=G(t,n)};for(let f=0;f<o;f++){const e=n[f],r=t[f];for(let t=0;t<e.length;t++){const n=e[t],o=r[t];c&&0===t&&p(c,n,u,o),l[a++]=I(n,o),c=n,u=o}}return{progress:0,samples:l,hasZ:!1,statistics:null,spatialReference:r}}function I(e,t){return{coordinate:e,distance:t,sampledZ:null,sampled:!1,isHole:!1}}function G(e,t){return{coordinate:e,distance:t,sampledZ:null,sampled:!0,isHole:!0}}function O(e,t,r){return T.apply(this,arguments)}function T(){return(T=t._asyncToGenerator((function*(e,t,r){try{return yield e.queryElevation(t,r)}catch(n){throw new p.ProfileGenerationError("elevation-query-error")}}))).apply(this,arguments)}e.createProfileQueue=P,e.generateProfile=m,e.generateProfiles=h,e.interpolateElevations=_,Object.defineProperty(e,"__esModule",{value:!0})}));
