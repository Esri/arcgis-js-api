/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../core/maybe","../../../core/arrayUtils","../../../core/promiseUtils","../../../geometry/Multipoint","../../../core/mathUtils","../../../views/support/Scheduler","../../../views/support/QueueProcessor","./constants","./ProfileGenerationError","./geometryUtils","./statisticsUtils","./traversal"],(function(e,t,r,n,o,s,i,l,a,c,u,p,f){"use strict";async function*d(e,r){var o;const{view:s,geometry:i,elevationInfo:l,providers:p,options:f}=e;if(t.isNone(i)||!u.isValidInputPath(i))throw new c.ProfileGenerationError("invalid-geometry");const d=s.spatialReference,m=p.length;if(0===m)return t.none;const y=Math.round(f.maxTotalSamples/m);if(u.countPoints(i)>y)throw new c.ProfileGenerationError("too-complex");const w=await u.densifyPath(i,l,s,d,f,y,r);let g=0;const P=new Array(m),E=new Array(m);for(let t=0;t<m;t++){const n=v(w);P[t]=n,g+=n.samples.length;const o={...e,provider:p[t],result:n,densificationResult:w};E[t]=h(o,r)[Symbol.iterator]()}if(g>f.maxTotalSamples)throw new c.ProfileGenerationError("too-complex");const R=await Promise.all(E.map((e=>{const t=e.next();return!0===t.done?Promise.resolve(null):t.value})));n.throwIfAborted(r);for(let t=0;t<m;t++)P[t]=R[t];yield P,await n.after(null!=(o=e.delayAfterPreview)?o:a.DELAY_AFTER_PREVIEW_MILLIS,null,r.signal);const I=[];try{let e;do{e=!1;for(let t=0;t<m;t++){const r=E[t].next();!1===r.done&&(I.push({resultPromise:r.value,index:t}),e=!0)}}while(e)}finally{E.forEach((e=>null==e.return?void 0:e.return()))}for(const{resultPromise:t,index:a}of I)P[a]=await t,n.throwIfAborted(r),yield P;t.forEachSome(P,(e=>{e.progress=1})),yield P}function*h(e,t){const{densificationResult:n}=e,o={...e,abortOptions:t,densificationResult:n},s=f.getIndices(0,o.result.samples.length),i=s.slice(0,o.provider.numSamplesForPreview);yield m(o,i,!0);const l=r.splitIntoChunks(s,o.provider.numSamplesPerChunk);for(const r of l)yield m(o,r,!1)}async function m({densificationResult:e,result:t,provider:r,queue:s,abortOptions:i,cache:l},c,u){const{densifiedPath:p,pathLength:f}=e,d=t.spatialReference,{samples:h}=t,m=new Array(c.length);for(let n=0;n<c.length;n++){const e=h[c[n]];m[n]=e.coordinate}try{return await s.push({geometry:new o({spatialReference:d,points:m,hasZ:p.hasZ}),provider:r,indices:c,preview:u,result:t,queryOptions:{...a.DEFAULT_ELEVATION_PROFILE_QUERY_OPTIONS,minDemResolution:u?Math.round(f/r.numSamplesForPreview):Math.round(f/h.length),cache:l}},i),{...t}}catch(y){return n.isAbortError(y)?null:a.ERROR_RESULT}}function y(e){return new l.QueueProcessor({task:i.Task.ELEVATION_PROFILE,concurrency:1,scheduler:e,process:async e=>{n.throwIfAborted(e.queryOptions);try{await w(e)}catch(t){n.throwIfNotAbortError(t)}}})}async function w({geometry:e,provider:t,indices:r,preview:n,result:o,queryOptions:s}){if(0===r.length)return;const i=(await I(t,e,s)).geometry,{hasZ:l,points:a}=i,c=s.noDataValue,{samples:u}=o;for(let p=0;p<r.length;p++){const e=u[r[p]];if(e.isHole)continue;const t=l?a[p][2]:null;null===t||t===c?e.sampledZ=null:(o.hasZ=!0,e.sampledZ=t),e.sampled=!0}g(u),o.progress=n?0:o.progress+r.length/u.length,o.statistics=p.getStatistics(o.samples,o.spatialReference)}function g(e){const t=e.length-1;let r=0;for(let n=1;n<=t;n++){(e[n].sampled||n===t)&&(P(e,r,n),r=n)}}function P(e,r,n){if(n-r==1)return;const o=e[r],i=o.sampledZ,l=e[n],a=l.sampledZ;if(t.isNone(i)||t.isNone(a)){for(let t=r+1;t<n;t++)e[t].sampledZ=null;return}const c=o.distance,u=l.distance-c;for(let t=r+1;t<n;t++){const r=e[t],n=(r.distance-c)/u;r.sampledZ=s.lerp(i,a,n)}}function v({densifiedPath:e,distances:t}){const r=e.spatialReference,n=e.paths,o=n.length,s=2*(o-1),i=n.reduce(((e,t)=>e+t.length),0)+s,l=new Array(i);let a=0,c=null,u=0;const p=(e,t,r,n)=>{l[a++]=R(e,r),l[a++]=R(t,n)};for(let f=0;f<o;f++){const e=n[f],r=t[f];for(let t=0;t<e.length;t++){const n=e[t],o=r[t];c&&0===t&&p(c,n,u,o),l[a++]=E(n,o),c=n,u=o}}return{progress:0,samples:l,hasZ:!1,statistics:null,spatialReference:r}}function E(e,t){return{coordinate:e,distance:t,sampledZ:null,sampled:!1,isHole:!1}}function R(e,t){return{coordinate:e,distance:t,sampledZ:null,sampled:!0,isHole:!0}}async function I(e,t,r){try{return await e.queryElevation(t,r)}catch(n){throw new c.ProfileGenerationError("elevation-query-error")}}e.createProfileQueue=y,e.generateProfile=h,e.generateProfiles=d,e.interpolateElevations=g,Object.defineProperty(e,"__esModule",{value:!0})}));
