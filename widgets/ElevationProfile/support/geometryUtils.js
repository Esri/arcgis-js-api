/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["require","exports","../../../core/maybe","../../../core/promiseUtils","../../../geometry/SpatialReference","../../../geometry/Polyline","../../../core/mathUtils","../../../chunks/vec3","../../../core/unitUtils","../../../geometry/projection","../../../geometry/support/geodesicUtils","../../../chunks/vec2","./ProfileGenerationError"],(function(e,t,n,r,o,s,i,a,c,u,l,h,f){"use strict";async function p(t,n,s,i,a,h,p){let m,w,y;const P=t.spatialReference,R=P.isGeographic||P.isWebMercator,v=await new Promise((function(t,n){e(["../../../geometry/geometryEngineAsync"],t,n)}));r.throwIfAborted(p);let S=0;R||(S=await v.planarLength(t,"meters"),r.throwIfAborted(p));const M=1/c.getMetersPerUnitForSR(i);if(R||S>=a.geodesicDistanceThreshold){await u.initializeProjection([{source:P,dest:i},{source:P,dest:o.WGS84}],p);const e=E(t);m=l.geodesicLengths([e],"meters")[0];const r=d(m,a);if(I(t,m,r)>h)throw new f.ProfileGenerationError("too-complex");const c=g(e,n,s);({densifiedPath:w,distances:y}=b(c,r,M)),w=u.project(w,i)}else{await u.initializeProjection([{source:P,dest:i}],p),m=S;const e=d(m,a);if(I(t,m,e)>h)throw new f.ProfileGenerationError("too-complex");const o=g(t,n,s);({densifiedPath:w,distances:y}=A(o,e,M)),r.throwIfAborted(p),w=u.project(w,i)}return{densifiedPath:w,pathLength:m*M,distances:y}}function d(e,t){const n=e/t.densificationMaxSamples;return Math.max(t.samplingDistance,n)}function g(e,t,r){if(n.isNone(t))return y(e);const o=e.spatialReference,i=t.mode,a=n.unwrapOr(t.offset,0);let c=null;switch(r.type){case"2d":c=m(e,i,a);break;case"3d":c=w(e,i,a,r)}return n.isNone(c)?y(e):new s({hasZ:!0,hasM:!1,spatialReference:o,paths:P(e.paths,c)})}function m({hasZ:e},t,n){switch(t){case"absolute-height":return e?([e,t,r])=>[e,t,r+n]:([e,t])=>[e,t,n];default:return null}}function w({spatialReference:e,hasZ:t},r,o,{elevationProvider:s}){const i=(t,r,o,i)=>n.unwrapOr(s.getElevation(t,r,o,e,i),0);switch(r){case"on-the-ground":return([e,t])=>[e,t,i(e,t,0,"ground")];case"absolute-height":return t?([e,t,n])=>[e,t,n+o]:([e,t])=>[e,t,o];case"relative-to-ground":return t?([e,t,n])=>[e,t,n+i(e,t,n,"ground")+o]:([e,t])=>[e,t,i(e,t,0,"ground")+o];case"relative-to-scene":return t?([e,t,n])=>[e,t,n+i(e,t,n,"scene")+o]:([e,t])=>[e,t,i(e,t,0,"scene")+o];default:return null}}function y(e){return e.hasZ?new s({hasZ:!1,hasM:!1,spatialReference:e.spatialReference,paths:P(e.paths,(([e,t])=>[e,t]))}):e}function P(e,t){const n=e.length,r=new Array(n);for(let o=0;o<n;++o){const n=e[o],s=n.length,i=new Array(n.length);r[o]=i;for(let e=0;e<s;++e)i[e]=t(n[e])}return r}function R(e){return v(e)&&e.paths.length>0&&e.paths.every((e=>e.length>=2))}function v(e){return n.isSome(e)&&"polyline"===e.type}function S(e,t,n,r,o){const{spatialReference:i,hasZ:a}=e,u={from:null,to:null,distance:0,azimuth:0,reverseAzimuth:0,spatialReference:i,metersPerSR:c.getMetersPerUnitForSR(i)},l=new Array(e.paths.length),h=new Array(e.paths.length);let f=0;for(let s=0;s<e.paths.length;++s){const i=e.paths[s],a=new Array,c=new Array;let p=0;for(let e=1;e<i.length;++e){const s=i[e-1],l=i[e],h=r(u,s,l);let d;for(d=p;d<h.distance;d+=t)a.push(o(h,d)),c.push((f+d)*n);p=d-h.distance,f+=h.distance,a.push(l),c.push(f*n)}l[s]=a,h[s]=c}return{densifiedPath:new s({spatialReference:i,hasZ:a,paths:l}),distances:h}}function A(e,t,n){const{hasZ:r}=e;return S(e,t,n,G,r?z:x)}function b(e,t,n){const{hasZ:r}=e;return S(e,t,n,M,r?j:Z)}function M(e,t,n){return e.distance=0,l.inverseGeodeticSolver(e,t,n,e.spatialReference),e.from=t,e.to=n,e}function G(e,t,n){return e.from=t,e.to=n,e.distance=h.distance(n,t)*e.metersPerSR,e}function Z({from:e,azimuth:t,spatialReference:n},r){return l.directGeodeticSolver([0,0],e,t,r,n)}function j({from:e,to:t,azimuth:n,distance:r,spatialReference:o},s){const a=s/r,c=[0,0,i.lerp(e[2],t[2],a)];return l.directGeodeticSolver(c,e,n,s,o),c}function x({from:e,to:t,distance:n},r){return h.lerp([0,0],e,t,r/n)}function z({from:e,to:t,distance:n},r){return a.lerp([0,0,0],e,t,r/n)}function E(e){return l.isSupported(e.spatialReference)?e:u.project(e,o.WGS84)}function U(e){return e.paths.reduce(((e,t)=>e+t.length),0)}function I(e,t,n){return U(e)+Math.floor(t/n)+Math.max(0,e.paths.reduce((e=>1+e),0)-1)}t.countPoints=U,t.densifyPath=p,t.isPolyline=v,t.isValidInputPath=R,t.toAbsoluteHeightElevation=g,Object.defineProperty(t,"__esModule",{value:!0})}));
