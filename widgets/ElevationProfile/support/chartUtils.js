/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../core/has","../../../core/maybe","../../../core/Logger","../../../core/handleUtils","../../../core/arrayUtils","../../../core/promiseUtils","../../../intl/number","../../../intl/substitute","../../../intl","../../../core/unitUtils","../../../core/unitFormatUtils","../../support/widgetUtils","../../support/chartUtils","../css","./constants","./intlUtils","./niceScale"],(function(e,i,t,o,n,a,s,l,r,d,c,p,u,x,m,g,f,b){"use strict";const h="#f8f8f8",T="#a9a9a9",y="#323232",A="line",S="fill",v=15,C=12,L=30,k=.001,P=3,F=2,z=30,M={sideSpacing:v,paddingBottom:0,paddingLeft:0,paddingRight:0,paddingTop:0,axisFontSize:9,axisFontWeight:"400",axisGridStroke:"#f4f4f4",axisLabelsFontSize:9,axisLabelsFontWeight:"400",axisLabelsColor:T,axisTooltipFontSize:12,axisTooltipBackgroundColor:y,axisTooltipLabelColor:h,axisTooltipPaddingTop:Math.round(C/4),axisTooltipPaddingBottom:Math.round(C/4),axisTooltipPaddingHorizontal:Math.round(v/4),xAxisMinGridDistance:50,xAxisLabelsSpacing:Math.round(C/2),xAxisMinLabelPosition:.05,xAxisMaxLabelPosition:.9,yAxisMinGridDistance:30,yAxisExtraFactorTop:.25,yAxisExtraFactorBottom:.02,yAxisLabelSpacing:Math.round(v/4),yAxisMinLabelPosition:0,yAxisMaxLabelPosition:.8,seriesTooltipFontSize:12,seriesTooltipBackgroundColor:h,seriesTooltipLabelColor:y,seriesFillLighten:.9,seriesTooltipSpacing:C/2,seriesTooltipPaddingVertical:Math.round(v/4),seriesTooltipPaddingHorizontal:Math.round(v/4),tooltipBorderRadius:0},w={...M,axisGridStroke:y,axisLabelsColor:T,axisTooltipBackgroundColor:y,axisTooltipLabelColor:h,seriesTooltipBackgroundColor:y,seriesTooltipLabelColor:h,seriesFillLighten:-.75};async function I(e){const i=await x.loadChartsModule();s.throwIfAborted(e.abortOptions);const{am4core:o,am4charts:a}=i;o.options.minPolylineStep=P,o.options.autoSetClassName=!0,o.options.animationsEnabled=!1;const l=u.isDarkTheme(),r=l?w:M;l&&o.useTheme(i.am4themes_dark);const d=o.create(e.container,a.XYChart);d.arrangeTooltips=!1,d.preloader.disabled=!0,d.zoomOutButton.disabled=!0;const c=u.isRTL();d.rtl=c,d.padding(r.paddingTop,c?r.paddingLeft:r.paddingRight,r.paddingBottom,c?r.paddingRight:r.paddingLeft);const p=d.plotContainer.background;p.strokeWidth=0,p.strokeOpacity=0,p.stroke=null;const m=d.xAxes.push(new a.ValueAxis),g=d.yAxes.push(new a.ValueAxis),f={params:e,amCharts4Index:i,amChart:d,xAxis:m,yAxis:g,series:new Map,data:null,messages:null,theme:r};d.cursor=O(f),R(f),N(f),E(f);const b=[$(f,e.onRangeChange),Y(f,e.onCursorPositionChange),X(f)];let h=null,T=!1;const y=()=>{t.isNone(h)||("undefined"!=typeof window&&"cancelIdleCallback"in window?window.cancelIdleCallback(h):clearTimeout(h),h=null)};return{...f,destroy(){T=!0,y(),n.handlesGroup(b).remove(),d.dispose()},update(e){if(e.data===f.data&&e.messages===f.messages)return;if(y(),T)return;const i=()=>{T||(h=null,B(f,e))};h="undefined"!=typeof window&&"requestIdleCallback"in window?window.requestIdleCallback(i,{timeout:z}):setTimeout(i,z)},zoomOut(){T||f.xAxis.zoom({start:0,end:1},!1,!0)}}}function O(e){const i=new e.amCharts4Index.am4charts.XYCursor;return i.trackable=!0,i.lineY.disabled=!0,i.behavior="zoomX",i}function R(e){const i=e.theme,t=e.amChart.tooltip,{am4core:o}=e.amCharts4Index;t.id="series-tooltip",t.fitPointerToBounds=!0,t.pointerOrientation="vertical",t.zIndex=-1,t.getFillFromObject=!1,t.label.fontSize=i.seriesTooltipFontSize,t.label.fill=o.color(i.seriesTooltipLabelColor),t.label.padding(i.seriesTooltipPaddingVertical,i.seriesTooltipPaddingHorizontal,i.seriesTooltipPaddingVertical,i.seriesTooltipPaddingHorizontal),t.background.cornerRadius=i.tooltipBorderRadius,t.background.stroke=null,t.background.fill=o.color(i.seriesTooltipBackgroundColor),t.background.padding(0,0,0,0),t.adapter.add("dy",(()=>i.seriesTooltipSpacing*(t.background.pointerY<=0?1:-1))),u.isRTL()&&(t.label.textAlign="middle")}function N(e){const{xAxis:i,theme:t}=e,{am4core:o}=e.amCharts4Index;i.numberFormatter=ee(e,"distance"),i.strictMinMax=!0,i.cursorTooltipEnabled=!1,i.title.visible=!1;const n=i.renderer;n.line.visible=!1,n.minGridDistance=t.xAxisMinGridDistance,n.minLabelPosition=t.xAxisMinLabelPosition,n.maxLabelPosition=t.xAxisMaxLabelPosition,n.fontWeight=t.axisFontWeight,n.fontSize=t.axisFontSize,n.baseGrid.disabled=!0;const a=n.labels.template;a.fontSize=t.axisLabelsFontSize,a.fontWeight=t.axisLabelsFontWeight,a.fill=o.color(t.axisLabelsColor),a.paddingTop=t.xAxisLabelsSpacing,a.horizontalCenter="left",a.paddingLeft=0;const s=i.tooltip;s.id="axis-tooltip",s.background.fill=o.color(t.axisTooltipBackgroundColor),s.background.stroke=null,s.background.padding(0,0,0,0),s.label.fontSize=t.axisTooltipFontSize,s.label.fill=o.color(t.axisTooltipLabelColor),s.label.padding(t.axisTooltipPaddingTop,t.axisTooltipPaddingHorizontal,t.axisTooltipPaddingBottom,t.axisTooltipPaddingHorizontal);const l=n.grid.template;l.strokeOpacity=1,l.stroke=o.color(t.axisGridStroke)}function E(e){const{yAxis:i,theme:t}=e,{am4core:o}=e.amCharts4Index;i.numberFormatter=ee(e,"elevation"),i.title.visible=!1,i.cursorTooltipEnabled=!1,i.strictMinMax=!0,i.baseValue=g.NO_DATA_VALUE;const n=i.renderer;n.inside=!0,n.line.opacity=0,n.line.visible=!1,n.minGridDistance=t.yAxisMinGridDistance,n.minLabelPosition=t.yAxisMinLabelPosition,n.maxLabelPosition=t.yAxisMaxLabelPosition,n.fontWeight=t.axisFontWeight,n.fontSize=t.axisFontSize,n.baseGrid.disabled=!0;const a=n.labels.template;a.fontSize=t.axisLabelsFontSize,a.fontWeight=t.axisLabelsFontWeight,a.fill=o.color(t.axisLabelsColor),a.verticalCenter="bottom",a.paddingLeft=t.yAxisLabelSpacing,a.paddingBottom=0;const s=n.grid.template;s.strokeOpacity=1,s.stroke=o.color(t.axisGridStroke),u.isRTL()&&(n.opposite=!0,a.textAlign="middle",a.paddingLeft=0,a.paddingRight=t.yAxisLabelSpacing)}function B(e,{data:i,messages:o}){q(e);const n=t.isSome(i)&&i.fullyRefined;e.amChart.cursor.disabled=!n,e.amChart.htmlContainer.classList.toggle(m.CHART_CSS.cursorEnabled,n);const a=e.data!==i,s=t.applySome(e.data,(e=>e.effectiveUnits))!==t.applySome(i,(e=>e.effectiveUnits));e.data=i,e.messages=o,a&&(U(e),D(e),H(e)),s&&(e.yAxis.invalidateLabels(),e.xAxis.invalidateLabels())}function U({xAxis:e,data:i}){if(t.isNone(i))return;let o=0;for(const s of i.lines){var n;const e=t.unwrapOr(s.samples,[]),i=null==(n=a.last(e))?void 0:n.distance;t.isSome(i)&&i>o&&(o=i)}e.min=0,e.max=o}function D({yAxis:e,data:i,theme:o}){if(t.isNone(i))return;const n=t.applySome(i.statistics,(e=>e.maxDistance)),a=t.applySome(i.statistics,(e=>e.minElevation)),s=t.applySome(i.statistics,(e=>e.maxElevation));if(t.isSome(n)&&t.isSome(a)&&t.isSome(s)){let t=a,l=s;if(i.dynamicElevationRange){let e=n;const o=s-a,r=i.effectiveUnits;e=c.convertUnit(n,r.distance,"meters");let d=c.convertUnit(o,r.elevation,"meters");d=Math.max(d,e/g.MAX_CHART_RATIO,d),d=c.convertUnit(d,"meters",r.elevation),t=a,l=t+d}const r=Math.max(l-t,k);t-=o.yAxisExtraFactorBottom*r,l+=o.yAxisExtraFactorTop*r,[e.min,e.max]=b.niceScale(t,l,10)}else e.min=void 0,e.max=void 0}function H(e){const{amChart:i,data:o}=e;if(t.isNone(o)||0===o.lines.length)return void i.series.clear();const n=new Map,a=new Set(i.series.values),s=o.lines.length;for(let l=0;l<s;l++){const r=o.lines[l];let d=e.series.get(r.id);d?(t.applySome(d.fill,(e=>a.delete(e))),a.delete(d.line)):(d=_(e,r),t.applySome(d.fill,(e=>i.series.push(e))),i.series.push(d.line)),n.set(d.id,d);const c=s-l-1;t.applySome(d.fill,(e=>e.zIndex=c)),d.line.zIndex=s+c,G(e,d,r)}e.series=n;for(const t of a)i.series.removeValue(t)}function G(e,{line:i,fill:o},n){const{theme:a}=e,{am4core:s}=e.amCharts4Index,{r:l,g:r,b:d,a:c}=n.color,p=s.color({r:l,g:r,b:d,a:c}),u=t.unwrapOr(n.samples,[]),x=u.length>0;i.stroke=p,i.visible=x,t.applySome(o,(e=>{e.visible=x,e.fill=p.lighten(a.seriesFillLighten)}));const m=u.length,g=i.data;if(g.length===m){for(let e=0;e<m;++e)W(g[e],u[e]);i.invalidateRawData(),t.applySome(o,(e=>e.invalidateRawData()))}else i.data=u,t.applySome(o,(e=>e.data=u))}function W(e,i){e.x=i.x,e.y=i.y,e.z=i.z,e.distance=i.distance,e.elevation=i.elevation}function _(e,i){const{id:t}=i,o=V(e,`${A}-${t}`);o.strokeWidth=i.chartStrokeWidth,o.dy=i.chartStrokeOffsetY;let n=null;return i.chartFillEnabled&&(n=V(e,`${S}-${t}`),n.fillOpacity=1),{id:t,line:o,fill:n}}function V(e,i){const t=new e.amCharts4Index.am4charts.LineSeries;t.id=i,t.showOnInit=!1,t.simplifiedProcessing=!0,t.minDistance=F,t.excludeFromTotal=!0,t.clickable=!1,t.contextMenuDisabled=!0,t.cursorHoverEnabled=!1,t.cursorTooltipEnabled=!1,t.connect=!1,t.fill=null,t.stroke=null;const o="distance";t.dataFields.valueX=o;const n="elevation";return t.dataFields.valueY=n,t}function $({xAxis:e},i){const t=e.events.on("rangechangeended",(()=>{i(e.zoomFactor)}));return n.makeHandle((()=>t.dispose()))}function X({xAxis:e,yAxis:i}){const t=e=>()=>{e.renderer.grid.each((e=>{e.visible="none"!==e.dataItem.label.dom.getAttribute("display")}))},o=[e.events.on("rangechangeended",t(e)),e.events.on("validated",t(e)),i.events.on("rangechangeended",t(i)),i.events.on("validated",t(i))];return n.makeHandle((()=>{o.forEach((e=>e.dispose()))}))}function Y(e,i){const{amChart:t,xAxis:o,yAxis:a}=e,{cursor:s}=t;let l=!1;const r=()=>{const t=o.toAxisPosition(s.xPosition),n=a.toAxisPosition(s.yPosition);i(t,n),j(e)},d=()=>{l=!1,i(null,null),q(e)},c=[s.events.on("cursorpositionchanged",(()=>{l&&r()})),t.events.on("over",(()=>{l=!0})),t.events.on("out",d),t.events.on("blur",d)];return n.makeHandle((()=>{c.forEach((e=>e.dispose()))}))}function j(e){const{amChart:i,xAxis:o,theme:n}=e;if(q(e),!t.applySome(e.data,(e=>e.fullyRefined)))return;const a=i.tooltip,s=o.tooltip,l=J(e);if(t.isSome(l)){a.text=l.text,a.show(0),a.validate();const t=l.y-a.contentHeight-n.seriesTooltipSpacing;a.pointerOrientation=t<L?"up":"down",a.pointTo(l,!0),s.text=Z(e),s.show(),i.cursor.show()}}function q({amChart:e,xAxis:i}){e.cursor.hide(),e.tooltip.hide(),i.hideTooltip()}function J(e){const{amChart:i,yAxis:o,data:n}=e;if(t.isNone(n))return null;const a=n.lines.map((i=>({line:i,y:t.applySome(ie(e,i),(e=>e.elevation))}))).sort(K),s=a.length?a[0].y:null;if(t.isNone(s))return null;const l=i.cursor,r=o.measuredHeight,d=r+i.pixelPaddingTop;return{text:a.map((({y:i,line:t})=>Q(e,t,i))).join("\n"),x:l.point.x+l.parent.pixelX+i.pixelPaddingLeft,y:d-o.valueToPosition(s)*r}}function K({y:e},{y:i}){return t.isNone(e)?1:t.isNone(i)?-1:i-e}function Q(e,i,o){const{data:n,messages:a}=e;if(t.isNone(n)||t.isNone(a))return"";const s=r.substitute(a.chartTooltip,{name:f.getTranslatedLineTitle(i,a),elevation:t.isSome(o)?p.formatDecimal(a,o,n.effectiveUnits.elevation,g.FORMAT_PRECISION):g.NOT_AVAILABLE});return`[${i.color.toHex()}]●[/] ${s}`}function Z(e){const{data:i,messages:o}=e;if(t.isNone(i)||t.isNone(o))return"";const n=i.lines[0],a=n?ie(e,n):null;return t.isSome(a)?p.formatDecimal(o,a.distance,i.effectiveUnits.distance,g.FORMAT_PRECISION):"-"}function ee(e,i){const o=e.xAxis.numberFormatter.clone();return o.format=(o,n,a)=>{const{messages:s,data:r}=e;if(t.isNone(s)||t.isNone(r)||"string"==typeof o)return"";return`${l.formatNumber(o,{maximumFractionDigits:a})} ${p.unitName(s,r.effectiveUnits[i],"abbr")}`},o}function ie({amChart:e,xAxis:i},o){const n=t.unwrapOr(o.samples,[]);if(0===n.length)return null;const s=i.toAxisPosition(e.cursor.xPosition),l=i.positionToValue(s);return a.binaryFindClosest(n,l,(e=>e.distance))}e.createChart=I,Object.defineProperty(e,"__esModule",{value:!0})}));
