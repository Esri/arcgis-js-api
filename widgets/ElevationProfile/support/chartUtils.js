/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../core/maybe","../../../core/handleUtils","../../../core/arrayUtils","../../../core/events","../../../core/promiseUtils","../../../intl/substitute","../../../intl","../../../core/unitFormatUtils","../../support/widgetUtils","../../support/chartUtils","./intlUtils","./constants"],(function(e,t,i,o,n,s,a,l,r,c,d,u,m){"use strict";const p="#e0e0e0",f="#0079c1",x="#00598e",h="#00598e",g="400",v=p,b="400",y="#ffffff",A="#323232";function S(e,{line:i,fill:o},n){const{r:s,g:a,b:l,a:r}=n.color,c=e.am4core.color({r:s,g:a,b:l,a:r}),d=t.unwrapOr(n.samples,[]),u=d.length>0;i.data=d,i.stroke=c,i.visible=u,t.applySome(o,(e=>{e.data=d,e.visible=u,e.fill=c.lighten(.9)}))}function C(e,{id:t,showFill:i}){const{am4charts:o}=e,n=new o.LineSeries;n.id=`line-${t}`,n.showOnInit=!1,n.simplifiedProcessing=!0,n.connect=!1,n.strokeWidth=1.5,n.fillOpacity=0;n.dataFields.valueX="distance";n.dataFields.valueY="elevation";let s=null;return i&&(s=n.clone(),s.id=`fill-${t}`,s.strokeWidth=0,s.fillOpacity=1),{id:t,line:n,fill:s}}function P(e,t){const{amChart:o,xAxis:s,yAxis:a}=e,l=o.cursor,r=l.events.on("cursorpositionchanged",(()=>{const e=s.toAxisPosition(l.xPosition),i=a.toAxisPosition(l.yPosition);t(e,i)})),c=n.on(o.chartContainer.htmlContainer,["mouseleave","pointerleave"],(()=>{t(null,null)}));return i.makeHandle((()=>{r.dispose(),c.remove()}))}function T(e){const{amChart:o,xAxis:n}=e,s=o.cursor.events.on("cursorpositionchanged",(()=>{if(1!==t.applySome(e.data,(e=>e.progress)))return;const i=o.tooltip,s=function(e){const{amChart:i,yAxis:o,data:n,messages:s}=e;if(t.isNone(n)||t.isNone(s))return null;const l=n.effectiveUnits.elevation,c=[];let d=null;for(const i of n.lines){const o=O(e,i),n=t.applySome(o,(e=>e.elevation));(t.isNone(d)||t.isSome(n)&&n>d)&&(d=n);const p=a.substitute(s.chartTooltip,{name:u.getTranslatedLineTitle(i,s),elevation:t.isSome(n)?r.formatDecimal(s,n,l,m.FORMAT_PRECISION):m.NOT_AVAILABLE});c.push(`[${i.color.toHex()}]●[/] ${p}`)}if(t.isNone(d))return null;const p=i.cursor,f=o.measuredHeight,x=f+i.pixelPaddingTop;return{text:c.join("\n"),point:{x:p.point.x+p.parent.pixelX+i.pixelPaddingLeft,y:x-o.valueToPosition(d)*f-10}}}(e);t.isSome(s)?(i.text=s.text,i.pointTo(s.point,!0),i.show()):i.hide(),n.tooltip.text=function(e){const{data:i,messages:o}=e;if(t.isNone(i)||t.isNone(o))return"";const n=i.lines[0],s=n?O(e,n):null;return t.isSome(s)?r.formatDecimal(o,s.distance,i.effectiveUnits.distance,m.FORMAT_PRECISION):"-"}(e),n.showTooltip()}));return i.makeHandle((()=>s.dispose()))}function k({amChart:e,xAxis:t}){return n.on(e.chartContainer.htmlContainer,["mouseleave","pointerleave"],(()=>{e.tooltip.hide(),t.hideTooltip()}))}function w(e,i){const o=e.xAxis.numberFormatter.clone();return o.format=(o,n,s)=>{const{messages:a,data:l}=e;return t.isSome(a)&&t.isSome(l)&&"string"!=typeof o?r.formatDecimal(a,o,l.effectiveUnits[i],s):""},o}function O({amChart:e,xAxis:i},n){const s=t.unwrapOr(n.samples,[]);if(0===s.length)return null;const a=i.toAxisPosition(e.cursor.xPosition),l=i.positionToValue(a);return o.binaryFindClosest(s,l,(e=>e.distance))}e.createChart=async function(e){const n=await d.loadChartsModule();s.throwIfAborted(e.abortOptions);const{am4core:a,am4charts:l}=n;a.options.minPolylineStep=2,a.options.autoSetClassName=!0;const r=a.create(e.container,l.XYChart);c.isRTL()?(r.rtl=!0,r.padding(20,-10,0,1)):r.padding(20,1,0,-10),r.cursor=function(e){const t=new e.am4charts.XYCursor;return t.trackable=!0,t.lineY.disabled=!0,t}(n);const u=r.plotContainer.background;u.strokeWidth=1,u.strokeOpacity=1,u.stroke=a.color("#e0e0e0");const m=r.xAxes.push(new l.ValueAxis),p=r.yAxes.push(new l.ValueAxis),O={params:e,amChart:r,xAxis:m,yAxis:p,series:new Map,data:null,elevationUnitsPerPixel:null,messages:null};!function(e,{am4core:t}){const i=e.amChart.zoomOutButton.background;i.fill=t.color(f),i.states.getKey("hover").properties.fill=t.color(x),i.states.getKey("down").properties.fill=t.color(h)}(O,n),function({amChart:{tooltip:e}},{am4core:t}){e.zIndex=-1,e.pointerOrientation="down",e.getFillFromObject=!1,e.label.fill=t.color(A),e.background.cornerRadius=0,e.background.stroke=null,e.background.fill=t.color(y),c.isRTL()&&(e.label.textAlign="middle")}(O,n),function(e,t){const{am4core:i}=t,{xAxis:o}=e;o.numberFormatter=w(e,"distance"),o.strictMinMax=!0,o.title.visible=!1;const n=o.renderer;n.line.visible=!1,n.minGridDistance=80,n.maxLabelPosition=.98,n.fontWeight=g,n.fontSize=10;const s=n.labels.template;s.fontSize=8,s.fontWeight=b,s.paddingTop=5,s.horizontalCenter="left",s.paddingLeft=0;const a=n.grid.template;a.strokeOpacity=1,a.stroke=i.color(v),c.isRTL()&&(n.inversed=!0,o.tooltip.label.textAlign="middle",s.textAlign="middle")}(O,n),function(e,t){const{am4core:i}=t,{yAxis:o}=e;o.numberFormatter=w(e,"elevation"),o.title.visible=!1,o.cursorTooltipEnabled=!1,o.strictMinMax=!1,o.extraMax=.02,o.extraMin=.02;const n=o.renderer;n.line.visible=!1,n.minGridDistance=30,n.maxLabelPosition=.98,n.fontWeight=g,n.fontSize=10;const s=n.labels.template;s.fontSize=8,s.fontWeight=b,s.paddingRight=5,s.verticalCenter="bottom",s.paddingBottom=0;const a=n.grid.template;a.strokeOpacity=1,a.stroke=i.color(v),c.isRTL()&&(n.opposite=!0,s.textAlign="middle")}(O,n);const M=[P(O,e.onCursorPositionChange),T(O),k(O)];let U=null;const L=()=>{t.isSome(U)&&(clearTimeout(U),U=null)};return{...O,update(e){e.data===O.data&&e.messages===O.messages||(L(),U=setTimeout((()=>{U=null,function(e,i,{data:n,elevationUnitsPerPixel:s,messages:a}){const{amChart:l}=i;l.tooltip.hide();const r=i.data!==n,c=i.elevationUnitsPerPixel!==s;i.data=n,i.elevationUnitsPerPixel=s,i.messages=a,r&&function({xAxis:e,data:i}){if(t.isNone(i))return;let n=0;for(const e of i.lines){var s;const i=t.unwrapOr(e.samples,[]),a=null==(s=o.last(i))?void 0:s.distance;t.isSome(a)&&a>n&&(n=a)}e.min=0,e.max=n,e.invalidateLabels()}(i);(r||c)&&function({yAxis:e,data:i,elevationUnitsPerPixel:o}){if(t.isNone(i))return;const n=t.applySome(i.statistics,(e=>e.minElevation)),s=t.applySome(i.statistics,(e=>e.maxElevation));if(t.isSome(o)&&t.isSome(n)&&t.isSome(s)){const t=s-n,i=Math.max(0,o-t)/2;e.min=Math.round(n-i),e.max=Math.round(s+i)}else e.min=void 0,e.max=void 0;e.invalidateLabels()}(i);r&&function(e,i){const{amChart:o,data:n}=i;if(t.isNone(n)||0===n.lines.length)return void o.series.clear();const s=new Map,a=new Set(o.series.values),l=n.lines.length;for(let r=0;r<l;r++){const c=n.lines[r];let d=i.series.get(c.id);d?(t.applySome(d.fill,(e=>a.delete(e))),a.delete(d.line)):(d=C(e,c),t.applySome(d.fill,(e=>o.series.push(e))),o.series.push(d.line)),s.set(d.id,d);const u=l-r-1;t.applySome(d.fill,(e=>e.zIndex=u)),d.line.zIndex=l+u,S(e,d,c)}i.series=s;for(const e of a)o.series.removeValue(e)}(e,i)}(n,O,e)})))},destroy(){L(),i.handlesGroup(M).remove(),r.dispose()}}},Object.defineProperty(e,"__esModule",{value:!0})}));
