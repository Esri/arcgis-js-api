// COPYRIGHT © 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../intl","../../../core/arrayUtils","../../../core/events","../../../core/Handles","../../../core/maybe","../../../core/promiseUtils","../../../core/unitFormatUtils","../../../core/unitUtils","../../support/chartUtils","../../support/widget"],(function(e,t,i,n,r,o,a,s,l,u,c,m,d){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.onCursorPositionChange=t.createChart=t.getChartData=void 0;function v(e,t){var i=e.am4core,n=new e.am4charts.LineSeries;n.id=t.id,n.name=t.name,n.dataFields.valueX="x",n.dataFields.valueY="y",n.simplifiedProcessing=!0,n.connect=!1,n.showOnInit=!1;var r=t.color.toRgba(),o=r[0],a=r[1],s=r[2],l=r[3];n.stroke=i.color({r:o,g:a,b:s,a:l}),n.fill=i.color({r:o,g:a,b:s,a:l}),n.strokeWidth=1.5,n.fillOpacity=1;var u=new i.LinearGradientModifier;return u.opacities=[.3,0],u.offsets=[0,.3],u.gradient.rotation=90,n.segments.template.fillModifier=u,n}function f(e,t){var i=e.amChart,n=e.xAxis,r=e.yAxis,a=i.cursor,s=a.events.on("cursorpositionchanged",(function(){var e=n.toAxisPosition(a.xPosition),i=r.toAxisPosition(a.yPosition);t(e,i)})),l=o.on(i.chartContainer.htmlContainer,["mouseleave","pointerleave"],(function(){t(null,null)}));return{remove:function(){s.dispose(),l.remove()}}}function x(e){var t=e.amChart,i=e.xAxis,n=t.cursor.events.on("cursorpositionchanged",(function(){var n=t.tooltip,r=function(e){var t=e.amChart,i=e.yAxis,n=e.data,r=e.messages;if(s.isNone(n)||s.isNone(r))return null;for(var o="",a=null,l=0;l<n.lines.length;l++){var c=s.applySome(p(e,n.lines[l]),(function(e){return e.y})),m=t.series.getIndex(l);if(m){var d=s.isSome(c)?u.formatDecimal(r,c,n.elevationUnit):"-";o+="["+m.stroke.hex+"]●[/] "+m.name+": "+d+"\n",s.isSome(c)&&(a=c)}}var v=t.cursor;if(s.isNone(a))return null;var f=i.measuredHeight,x=f+t.pixelPaddingTop;return{text:o,point:{x:v.point.x+v.parent.pixelX+t.pixelPaddingLeft,y:x-i.valueToPosition(a)*f-10}}}(e);s.isSome(r)?(n.text=r.text,n.pointTo(r.point,!0),n.show()):n.hide(),i.tooltip.text=function(e){var t=e.data,i=e.messages;if(s.isNone(t)||s.isNone(i))return"";var n=t.lines[0],r=n?p(e,n):null;return s.isSome(r)?u.formatDecimal(i,r.x,t.distanceUnit):"-"}(e),i.showTooltip()}));return{remove:function(){return n.dispose()}}}function h(e){var t=e.amChart,i=e.xAxis;return o.on(t.chartContainer.htmlContainer,["mouseleave","pointerleave"],(function(){t.tooltip.hide(),i.hideTooltip()}))}function p(e,t){var i=e.amChart,n=e.xAxis,o=t.points;if(0===o.length)return null;var a=n.toAxisPosition(i.cursor.xPosition),s=n.xToValue(a);return r.binaryFindClosest(o,s,(function(e){return e.x}))}t.getChartData=function(e,t,i){var n=function(e){for(var t,i,n,o=0,a=0,l=e;a<l.length;a++){var u=l[a],c=u.samples,m=u.stats;if(!s.isNone(c)&&!s.isNone(m)){var d=null===(t=r.last(c))||void 0===t?void 0:t.distance;void 0!==d&&d>o&&(o=d),(void 0===i||m.minElevation<i)&&(i=m.minElevation),(void 0===n||m.maxElevation>n)&&(n=m.maxElevation)}}void 0===i&&(i=0);void 0===n&&(n=0);return{minDistance:0,maxDistance:o,minElevation:i,maxElevation:n}}(e),o=n.minDistance,a=n.maxDistance,l=n.minElevation,u=n.maxElevation,m=c.getMetersPerUnitForSR(t),d=c.getMetersPerVerticalUnitForSR(t);o*=m,a*=m,l*=d,u*=d;for(var v=c.preferredLengthUnit(a,"meters",i),f=c.preferredVerticalLengthUnit(u,"meters",i),x=[],h=0,p=e;h<p.length;h++){var g=p[h],b=[];if(!s.isNone(g.samples)){for(var C=0,U=g.samples;C<U.length;C++){var y=U[C],A=y.z,P=y.distance;b.push({x:c.convertUnit(P*m,"meters",v),y:s.applySome(A,(function(e){return c.convertUnit(e*d,"meters",f)}))})}x.push({id:g.id,name:g.label,color:g.color,points:b})}}return{lines:x,distanceUnit:v,elevationUnit:f,minX:c.convertUnit(o,"meters",v),maxX:c.convertUnit(a,"meters",v),minY:c.convertUnit(l,"meters",f),maxY:c.convertUnit(u,"meters",f)}},t.createChart=function(e){return i.__awaiter(this,void 0,void 0,(function(){var t,o,u,c,p,g,b,C,U,y;return i.__generator(this,(function(A){switch(A.label){case 0:return[4,m.loadChartsModule()];case 1:return t=A.sent(),l.throwIfAborted(e.abortOptions),o=t.am4core,u=t.am4charts,(c=o.create(e.container,u.XYChart)).rtl=d.isRTL(),c.padding(20,10,0,10),(p=c.tooltip).pointerOrientation="down",p.getFillFromObject=!1,p.label.fill=o.color("#323232"),p.background.cornerRadius=0,p.background.stroke=null,p.background.fill=o.color("#ffffff"),(g=c.xAxes.push(new u.ValueAxis)).strictMinMax=!0,g.fontWeight="500",g.fontSize=10,g.renderer.labels.template.fontWeight="400",g.renderer.minGridDistance=50,(b=c.yAxes.push(new u.ValueAxis)).cursorTooltipEnabled=!1,b.strictMinMax=!0,b.fontWeight="500",b.fontSize=10,b.renderer.labels.template.fontWeight="400",b.renderer.minGridDistance=15,(C=new u.XYCursor).trackable=!0,C.lineY.disabled=!0,c.cursor=C,U={amChart:c,xAxis:g,yAxis:b,data:null,messages:null},(y=new a).add([f(U,e.onCursorPositionChange),x(U),h(U)]),[2,i.__assign(i.__assign({},U),{update:function(e){!function(e,t,i){var o=i.data,a=i.messages,l=t.amChart,u=t.xAxis,c=t.yAxis;if(l.tooltip.hide(),s.isNone(o)||0===o.lines.length)return void l.series.clear();t.data=o,t.messages=a,u.title.text=n.substitute(a.elevationLabel,{units:a.units[o.distanceUnit].abbr}),u.min=o.minX,u.max=o.maxX,c.title.text=n.substitute(a.elevationLabel,{units:a.units[o.elevationUnit].abbr});var m=o.maxY-o.minY;if(c.min=o.minY-.1*m,c.max=o.maxY+.2*m,r.equals(l.series.values,o.lines,(function(e,t){return e.id+e.name===t.id+t.name})))l.series.each((function(t,i){var n=o.lines[i],r=n.color,a=n.name,s=n.points,l=r.toRgba(),u=l[0],c=l[1],m=l[2],d=l[3];t.stroke=e.am4core.color({r:u,g:c,b:m,a:d}),t.name=a,t.data=s}));else{l.series.clear();for(var d=0,f=o.lines;d<f.length;d++){var x=f[d];l.series.push(v(e,x))}}}(t,U,e)},destroy:function(){y.destroy(),c.dispose()}})]}}))}))},t.onCursorPositionChange=f}));