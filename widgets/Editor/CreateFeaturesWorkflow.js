/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/arrayUtils","../../core/handleUtils","../../core/maybe","../../core/reactiveUtils","../../core/uuid","../../core/Logger","../../core/accessorSupport/ensureType","../../core/Error","../../core/has","../../core/accessorSupport/decorators/subclass","../../views/interactive/snapping/FeatureSnappingLayerSource","./CreateFeaturesWorkflowData","./Workflow","./workflowUtils"],(function(e,t,a,n,r,i,o,s,l,c,d,u,f,h,p,v){"use strict";var m;const g=Symbol();let w=m=function(t){function s(e){var a;return(a=t.call(this,e)||this).type="create-features",a.createFeatureState="create-new",a._featureFormHandle=null,a._visualVariableAttributes={rotation:null,size:null},a._attachmentFileInfos=new Map,a._highlightHandles=new Map,a._preventDefaultActionOnCancel=!1,a}e._inheritsLoose(s,t);var l=s.prototype;return l.updatePendingFeature=function(){var t=e._asyncToGenerator((function*(e,t){return this._preventDefaultActionOnCancel=!0,this.data.viewModel.sketchViewModel.cancel(),a.remove(this._lastActiveGraphics,e),this._startUpdating(e,t)}));function n(e,a){return t.apply(this,arguments)}return n}(),s.create=function(t,a,n,i,o){const s=new m({data:new h.CreateFeaturesWorkflowData({creationInfo:r.unwrap(a),viewModel:t}),onCommit:(l=e._asyncToGenerator((function*(e){const t=e.viewModel.sketchViewModel.layer.graphics.toArray(),a=e.creationInfo.layer,n=a.capabilities.editing.supportsGlobalId&&"globalIdField"in a,r=s._attachmentFileInfos;if(0===r.size)return void(yield i(a,{addFeatures:t}));if(n){const e=s._getAttachmentEditsWithGlobalIds(t,a,r),n="addAttachments"in e?{globalIdUsed:!0}:void 0;return void(yield i(a,e,n))}const{addFeatureResults:l}=yield i(a,{addFeatures:t}),c=s._getAddAttachmentsData(t,l,a,r);yield o(a,c)})),function(e){return l.apply(this,arguments)})});var l;return s._set("steps",this._createWorkflowSteps(s,n)),s},l._fadeExistingFeatures=function(e){if("effect"in e){const t=e.effect;return e.effect="saturate(0.6) opacity(0.8)",n.makeHandle((()=>e.effect=t))}const t=e.opacity;return e.opacity=.7,n.makeHandle((()=>e.opacity=t))},l._highlight=function(e){const t=this.data.viewModel.view;"3d"===t.type&&this._highlightHandles.set(e,t.highlight(e))},l._removeHighlight=function(e){r.removeMaybe(this._highlightHandles.get(e)),this._highlightHandles.delete(e)},l._startCreating=function(){var t=e._asyncToGenerator((function*(e){return this.createFeatureState="create-new",v.startCreatingNewFeature(this.data.viewModel.sketchViewModel,this.data.creationInfo,e)}));function a(e){return t.apply(this,arguments)}return a}(),l._startUpdating=function(){var t=e._asyncToGenerator((function*(t,a){const{featureFormViewModel:i,layerInfos:o,sketchViewModel:s,view:l}=this.data.viewModel,c=this.data.creationInfo.layer,d=v.findLayerInfo(o,c)?.formTemplate,u=l.spatialReference;return i.set({arcadeEditType:"INSERT",feature:t,formTemplate:d,spatialReference:u,view:l}),r.removeMaybe(this._featureFormHandle),this._featureFormHandle=n.handlesGroup([i.on("value-change",e._asyncToGenerator((function*(){t.attributes=i.getValues(),yield v.updateGraphicSymbolWhenRequired(t,a)}))),s.on(["update","undo","redo"],(e=>{("undo"===e.type||"redo"===e.type||"update"===e.type&&r.isSome(e.toolEventInfo)&&v.isTerminalUpdateEventType(e.toolEventInfo.type))&&i.notifyFeatureGeometryChanged()}))]),this._removeHighlight(t),this.createFeatureState="update-pending",this._visualVariableAttributes=v.getVisualVariableAttributes(t),v.startUpdatingFeature(s,t,c,this._visualVariableAttributes,a)}));function a(e,a){return t.apply(this,arguments)}return a}(),s._createWorkflowSteps=function(t,o="awaiting-feature-creation-info"){const{data:s,handles:l}=t;let c=null,d=!0;const u=new Map,h={"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",setUp(){var t=this;return e._asyncToGenerator((function*(){s.creationInfo=null,l.add(s.viewModel.featureTemplatesViewModel.on("select",(({item:e})=>{s.creationInfo={layer:e.layer,template:e.template},s.viewModel.activeWorkflow.next()})),t.id)}))()},tearDown(){var t=this;return e._asyncToGenerator((function*(){l.remove(t.id)}))()}}),"creating-features":()=>({id:"creating-features",setUp(){var o=this;return e._asyncToGenerator((function*(){if(l.has(o.id))return;const h=s.viewModel.view,p=s.viewModel.sketchViewModel;d=p.updateOnGraphicClick,p.updateOnGraphicClick=!1,t._lastActiveGraphics=[],t._featureFormHandle=r.removeMaybe(t._featureFormHandle),t._visualVariableAttributes={rotation:null,size:null};const m="2d"===h.type?t._fadeExistingFeatures(s.creationInfo.layer):null,w=p.on("create",function(){var a=e._asyncToGenerator((function*(e){if("cancel"===e.state){if(t._preventDefaultActionOnCancel)return void(t._preventDefaultActionOnCancel=!1);if(t._lastActiveGraphics.length<1)return t._startCreating(u);const e=t._lastActiveGraphics.pop();return t._startUpdating(e,u)}if("complete"===e.state)return t._startUpdating(e.graphic,u)}));return function(e){return a.apply(this,arguments)}}()),y=p.on("update",function(){var a=e._asyncToGenerator((function*(e){const a=e.graphics[0];if("complete"===e.state){if(a!==c&&(t._lastActiveGraphics.push(a),t._highlight(a)),c=null,"add"!==s.viewModel.attachmentsViewModel.mode&&"edit"!==s.viewModel.attachmentsViewModel.mode||s.viewModel.activeWorkflow.previous(),e.aborted&&t._preventDefaultActionOnCancel)return void(t._preventDefaultActionOnCancel=!1);const r=h.cursor;return h.cursor="progress",l.add([n.makeHandle((()=>h.cursor=r)),h.on("click",(e=>e.preventDefault()))],g),i.whenOnce((()=>!s.viewModel.featureFormViewModel.updating)).then((()=>{l.remove(g),t._startCreating(u)}))}if("start"===e.state){t._removeHighlight(a);const e=s.viewModel.attachmentsViewModel;"add"!==e.mode&&"edit"!==e.mode||s.viewModel.activeWorkflow.previous(),e.fileInfos.removeAll(),e.graphic=a,e.mode="view";(t._attachmentFileInfos.get(a)||[]).forEach((({file:t,form:a})=>e.addFile(t,a)))}yield v.visualVariableInteractiveUpdate(h,a,e,t._visualVariableAttributes,u);const o=a.attributes;if(r.isSome(t._visualVariableAttributes.rotation)){const{field:e}=t._visualVariableAttributes.rotation;s.viewModel.featureFormViewModel.setValue(e,o[e])}if(r.isSome(t._visualVariableAttributes.size)){const{field:e}=t._visualVariableAttributes.size;s.viewModel.featureFormViewModel.setValue(e,o[e])}}));return function(e){return a.apply(this,arguments)}}()),_=p.on("delete",function(){var n=e._asyncToGenerator((function*(e){const n=e.graphics[0];a.remove(t._lastActiveGraphics,n),c=n}));return function(e){return n.apply(this,arguments)}}());let M=null;const b=i.watch((()=>{const e=p.snappingOptions.featureSources.find((e=>e.layer===s.creationInfo.layer));return{hasFeatureLayerSource:!!e,enabled:e?.enabled??!1}}),(({hasFeatureLayerSource:e,enabled:t})=>{const a=p.snappingOptions.featureSources;e?(r.isNone(M)&&(M=new f({layer:p.layer,enabled:t}),a.add(M)),M.enabled=t):(r.isSome(M)&&a.remove(M),M=r.destroyMaybe(M))}),i.syncAndInitial),F=h.on("immediate-click",function(){var a=e._asyncToGenerator((function*(e){const{results:a}=yield h.hitTest(e,{include:p.layer}),n=a.find((e=>"graphic"===e.type));if(n){const e=n.graphic;if("transform"===p.activeTool||"reshape"===p.activeTool){if(p.updateGraphics.getItemAt(0)===e)return;yield t.updatePendingFeature(e,u)}}}));return function(e){return a.apply(this,arguments)}}()),I=i.watch((()=>s.viewModel.attachmentsViewModel.mode),(e=>{"add"===e&&s.viewModel.activeWorkflow.go("adding-attachment"),"edit"===e&&s.viewModel.activeWorkflow.go("editing-attachment")}));yield t._startCreating(u);const A={remove:()=>{r.removeMaybe(t._featureFormHandle),w.remove(),y.remove(),_.remove(),b.remove(),r.isSome(M)&&p.snappingOptions.featureSources.remove(M),M=r.destroyMaybe(M),p.cancel(),F.remove(),I.remove(),r.removeMaybe(m)}};l.add(A,o.id)}))()},tearDown(a){var n=this;return e._asyncToGenerator((function*(){a.cancelled&&(s.viewModel.sketchViewModel.layer.removeAll(),l.remove([n.id,g]),s.viewModel.attachmentsViewModel.fileInfos.removeAll(),t._attachmentFileInfos.clear(),s.viewModel.sketchViewModel.updateOnGraphicClick=d)}))()}}),"adding-attachment":()=>({id:"adding-attachment",parent:"creating-features",setUp:()=>e._asyncToGenerator((function*(){}))(),tearDown:()=>e._asyncToGenerator((function*(){const{graphic:e,fileInfos:a}=s.viewModel.attachmentsViewModel;t._attachmentFileInfos.set(e,a.toArray()),s.viewModel.attachmentsViewModel.mode="view"}))()}),"editing-attachment":()=>({id:"editing-attachment",parent:"creating-features",setUp:()=>e._asyncToGenerator((function*(){}))(),tearDown:()=>e._asyncToGenerator((function*(){const{graphic:e,fileInfos:a}=s.viewModel.attachmentsViewModel;t._attachmentFileInfos.set(e,a.toArray()),s.viewModel.attachmentsViewModel.mode="view"}))()})},p=v.createWorkflowSteps(["awaiting-feature-creation-info","creating-features","adding-attachment","editing-attachment"],o,h);return v.avoidFeatureTemplateSelectionWithOnlyOneItem(s,p)},l._getAddAttachmentsData=function(e,t,a,n){const r=[];return t.forEach(((t,i)=>{if(!t.error){const o=e[i],s=n.get(o)||[];o.attributes[a.objectIdField]=t.objectId,s.forEach((({form:e})=>r.push({feature:o,attachment:e})))}})),r},l._getAttachmentEditsWithGlobalIds=function(e,t,a){const n=[];return e.forEach(((i,s)=>{const l=a.get(i)||[];let c=i.attributes[t.globalIdField];r.isNone(c)&&(c=o.generateUUID(),e[s].attributes[t.globalIdField]=c),l.forEach((({file:e})=>n.push({feature:i,attachment:{globalId:o.generateUUID(),data:e}})))})),n.length?{addFeatures:e,addAttachments:n}:{addFeatures:e}},e._createClass(s,[{key:"numPendingFeatures",get:function(){return this.data.viewModel.sketchViewModel.layer.graphics.length}},{key:"pendingFeatures",get:function(){return this.data.viewModel.sketchViewModel.layer.graphics}}]),s}(p);w=m=t.__decorate([u.subclass("esri.widgets.Editor.CreateFeaturesWorkflow")],w);return w}));
