/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/arrayUtils","../../core/handleUtils","../../core/maybe","../../core/reactiveUtils","../../core/Logger","../../core/accessorSupport/ensureType","../../core/has","../../core/accessorSupport/set","../../core/accessorSupport/decorators/subclass","../../views/interactive/snapping/FeatureSnappingLayerSource","./CreateFeaturesWorkflowData","./Workflow","./workflowUtils"],(function(e,t,a,r,n,i,o,s,l,c,u,d,f,h,p){"use strict";var v;let y=v=function(t){function o(e){var a;return(a=t.call(this,e)||this).type="create-features",a.createFeatureState="create-new",a.featureFormHandle=null,a.visualVariableAttributes={rotation:null,size:null},a.highlightHandles=new Map,a.preventDefaultActionOnCancel=!1,a}e._inheritsLoose(o,t);var s=o.prototype;return s.updatePendingFeature=function(){var t=e._asyncToGenerator((function*(e){return this.preventDefaultActionOnCancel=!0,this.data.viewModel.sketchViewModel.cancel(),a.remove(this.lastActiveGraphics,e),this._startUpdating(e)}));function r(e){return t.apply(this,arguments)}return r}(),o.create=function(t,a,r,i){const o=new v({data:new f.CreateFeaturesWorkflowData({creationInfo:n.unwrap(a),viewModel:t}),onCommit:(s=e._asyncToGenerator((function*(e){yield i(e.creationInfo.layer,{addFeatures:e.viewModel.sketchViewModel.layer.graphics.toArray()})})),function(e){return s.apply(this,arguments)})});var s;return o._set("steps",this._createWorkflowSteps(o,r)),o},s._fadeExistingFeatures=function(e){if("effect"in e){const t=e.effect;return e.effect="saturate(0.6) opacity(0.8)",r.makeHandle((()=>e.effect=t))}const t=e.opacity;return e.opacity=.7,r.makeHandle((()=>e.opacity=t))},s._highlight=function(e){const t=this.data.viewModel.view;"3d"===t.type&&this.highlightHandles.set(e,t.highlight(e))},s._removeHighlight=function(e){n.removeMaybe(this.highlightHandles.get(e)),this.highlightHandles.delete(e)},s._startCreating=function(){var t=e._asyncToGenerator((function*(){return this.createFeatureState="create-new",p.startCreatingNewFeature(this.data.viewModel.sketchViewModel,this.data.creationInfo)}));function a(){return t.apply(this,arguments)}return a}(),s._startUpdating=function(){var t=e._asyncToGenerator((function*(t){const a=this.data.viewModel,r=a.sketchViewModel,i=this.data.creationInfo.layer,o=p.findLayerInfo(a.layerInfos,i),s=null==o?void 0:o.formTemplate;return a.featureFormViewModel.set({feature:t,formTemplate:s}),n.removeMaybe(this.featureFormHandle),this.featureFormHandle=a.featureFormViewModel.on("value-change",e._asyncToGenerator((function*(){t.attributes=a.featureFormViewModel.getValues(),yield p.updateGraphicSymbolWhenRequired(t)}))),this._removeHighlight(t),this.createFeatureState="update-pending",this.visualVariableAttributes=p.getVisualVariableAttributes(t),p.startUpdatingFeature(r,t,i,this.visualVariableAttributes)}));function a(e){return t.apply(this,arguments)}return a}(),o._createWorkflowSteps=function(t,r="awaiting-feature-creation-info"){const{data:o,handles:s}=t;let l=null,c=!0;const u={"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",setUp(){var t=this;return e._asyncToGenerator((function*(){o.creationInfo=null,s.add(o.viewModel.featureTemplatesViewModel.on("select",(({item:e})=>{o.creationInfo={layer:e.layer,template:e.template},o.viewModel.activeWorkflow.next()})),t.id)}))()},tearDown(){var t=this;return e._asyncToGenerator((function*(){s.remove(t.id)}))()}}),"creating-features":()=>({id:"creating-features",setUp(){var r=this;return e._asyncToGenerator((function*(){const u=o.viewModel.view,f=o.viewModel.sketchViewModel;c=f.updateOnGraphicClick,f.updateOnGraphicClick=!1,t.lastActiveGraphics=[],t.featureFormHandle=n.removeMaybe(t.featureFormHandle),t.visualVariableAttributes={rotation:null,size:null};const h="2d"===u.type?t._fadeExistingFeatures(o.creationInfo.layer):null,v=f.on("create",function(){var a=e._asyncToGenerator((function*(e){if("cancel"===e.state){if(t.preventDefaultActionOnCancel)return void(t.preventDefaultActionOnCancel=!1);if(t.lastActiveGraphics.length<1)return t._startCreating();const e=t.lastActiveGraphics.pop();return t._startUpdating(e)}if("complete"===e.state)return t._startUpdating(e.graphic)}));return function(e){return a.apply(this,arguments)}}()),y=f.on("update",function(){var a=e._asyncToGenerator((function*(e){const a=e.graphics[0];if("complete"===e.state)return a!==l&&(t.lastActiveGraphics.push(a),t._highlight(a)),l=null,e.aborted&&t.preventDefaultActionOnCancel?void(t.preventDefaultActionOnCancel=!1):t._startCreating();"start"===e.state&&t._removeHighlight(a),yield p.visualVariableInteractiveUpdate(u,a,e,t.visualVariableAttributes);const r=a.attributes;if(n.isSome(t.visualVariableAttributes.rotation)){const{field:e}=t.visualVariableAttributes.rotation;o.viewModel.featureFormViewModel.setValue(e,r[e])}if(n.isSome(t.visualVariableAttributes.size)){const{field:e}=t.visualVariableAttributes.size;o.viewModel.featureFormViewModel.setValue(e,r[e])}}));return function(e){return a.apply(this,arguments)}}()),g=f.on("delete",function(){var r=e._asyncToGenerator((function*(e){const r=e.graphics[0];a.remove(t.lastActiveGraphics,r),l=r}));return function(e){return r.apply(this,arguments)}}());let w=null;const m=i.watch((()=>{var e;const t=f.snappingOptions.featureSources.find((e=>e.layer===o.creationInfo.layer));return{hasFeatureLayerSource:!!t,enabled:null!=(e=null==t?void 0:t.enabled)&&e}}),(({hasFeatureLayerSource:e,enabled:t})=>{const a=f.snappingOptions.featureSources;e?(n.isNone(w)&&(w=new d({layer:f.layer,enabled:t}),a.add(w)),w.enabled=t):(n.isSome(w)&&a.remove(w),w=n.destroyMaybe(w))}),i.syncAndInitial),b=u.on("immediate-click",function(){var a=e._asyncToGenerator((function*(e){const a=yield u.hitTest(e,{include:f.layer});if(a.results.length>0){const e=a.results[0].graphic;if("transform"===f.activeTool||"reshape"===f.activeTool){if(f.updateGraphics.getItemAt(0)===e)return;yield t.updatePendingFeature(e)}}}));return function(e){return a.apply(this,arguments)}}());yield t._startCreating();const M={remove:()=>{n.removeMaybe(t.featureFormHandle),v.remove(),y.remove(),g.remove(),m.remove(),n.isSome(w)&&f.snappingOptions.featureSources.remove(w),w=n.destroyMaybe(w),f.cancel(),b.remove(),n.removeMaybe(h)}};s.add(M,r.id)}))()},tearDown(t){var a=this;return e._asyncToGenerator((function*(){t.cancelled&&o.viewModel.sketchViewModel.layer.removeAll(),s.remove(a.id),o.viewModel.sketchViewModel.updateOnGraphicClick=c}))()}})},f=p.createWorkflowSteps(["awaiting-feature-creation-info","creating-features"],r,u);return p.avoidFeatureTemplateSelectionWithOnlyOneItem(o,f)},e._createClass(o,[{key:"numPendingFeatures",get:function(){return this.data.viewModel.sketchViewModel.layer.graphics.length}},{key:"pendingFeatures",get:function(){return this.data.viewModel.sketchViewModel.layer.graphics}}]),o}(h);y=v=t.__decorate([u.subclass("esri.widgets.Editor.CreateFeaturesWorkflow")],y);return y}));
