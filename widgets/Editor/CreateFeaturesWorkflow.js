/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/arrayUtils","../../core/handleUtils","../../core/maybe","../../core/reactiveUtils","../../core/uuid","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass","../../layers/support/layerUtils","../../views/draw/support/helpMessageUtils","../../views/interactive/snapping/FeatureSnappingLayerSource","./CreateFeaturesWorkflowData","./Workflow","./workflowUtils"],(function(e,t,a,r,n,i,o,s,l,c,d,u,h,f,p,v){"use strict";var g;const m=Symbol();let w=g=function(t){function s(e){var a;return(a=t.call(this,e)||this).type="create-features",a.createFeatureState="create-new",a._featureFormHandle=null,a._visualVariableAttributes={rotation:null,size:null},a._attachmentFileInfos=new Map,a._highlightHandles=new Map,a._preventDefaultActionOnCancel=!1,a._lastActiveGraphics=[],a}e._inheritsLoose(s,t);var l=s.prototype;return l.updatePendingFeature=function(){var t=e._asyncToGenerator((function*(e,t){return this._preventDefaultActionOnCancel=!0,this.data.viewModel.sketchViewModel.cancel(),a.remove(this._lastActiveGraphics,e),this._startUpdating(e,t)}));function r(e,a){return t.apply(this,arguments)}return r}(),s.create=function(t,a,r,i,o){const s=new g({data:new f.CreateFeaturesWorkflowData({creationInfo:n.unwrap(a),viewModel:t}),onCommit:(l=e._asyncToGenerator((function*(e){const t=e.viewModel.sketchViewModel.layer.graphics.toArray(),a=e.creationInfo.layer,r=a.capabilities.editing.supportsGlobalId&&"globalIdField"in a,n=s._attachmentFileInfos;if(0===n.size)return void(yield i(a,{addFeatures:t}));if(r){const e=s._getAttachmentEditsWithGlobalIds(t,a,n),r="addAttachments"in e?{globalIdUsed:!0}:void 0;return void(yield i(a,e,r))}const{addFeatureResults:l}=yield i(a,{addFeatures:t}),c=s._getAddAttachmentsData(t,l,a,n);yield o(a,c)})),function(e){return l.apply(this,arguments)})});var l;return s._set("steps",this._createWorkflowSteps(s,r)),s},l._fadeExistingFeatures=function(e){if("effect"in e){const t=e.effect;return e.effect="saturate(0.6) opacity(0.8)",r.makeHandle((()=>e.effect=t))}const t=e.opacity;return e.opacity=.7,r.makeHandle((()=>e.opacity=t))},l._highlight=function(e){const t=this.data.viewModel.view;"3d"===t?.type&&this._highlightHandles.set(e,t.highlight(e))},l._removeHighlight=function(e){n.removeMaybe(this._highlightHandles.get(e)),this._highlightHandles.delete(e)},l._startCreating=function(){var t=e._asyncToGenerator((function*(e){return this.createFeatureState="create-new",v.startCreatingNewFeature(this.data.viewModel.sketchViewModel,this.data.creationInfo,e)}));function a(e){return t.apply(this,arguments)}return a}(),l._startUpdating=function(){var t=e._asyncToGenerator((function*(t,a){const{featureFormViewModel:i,layerInfos:o,sketchViewModel:s,view:l}=this.data.viewModel;if(!l)return;const c=this.data.creationInfo.layer,d=v.findLayerInfo(o,c)?.formTemplate,u=l.spatialReference;return i.set({arcadeEditType:"INSERT",feature:t,formTemplate:d,spatialReference:u,view:l}),n.removeMaybe(this._featureFormHandle),this._featureFormHandle=r.handlesGroup([i.on("value-change",e._asyncToGenerator((function*(){t.attributes=i.getValues(),yield v.updateGraphicSymbolWhenRequired(t,a)}))),s.on(["update","undo","redo"],(e=>{("undo"===e.type||"redo"===e.type||"update"===e.type&&n.isSome(e.toolEventInfo)&&v.isTerminalUpdateEventType(e.toolEventInfo.type))&&i.notifyFeatureGeometryChanged()}))]),this._removeHighlight(t),this.createFeatureState="update-pending",this._visualVariableAttributes=v.getVisualVariableAttributes(t),v.startUpdatingFeature(s,t,c,this._visualVariableAttributes,a)}));function a(e,a){return t.apply(this,arguments)}return a}(),s._createWorkflowSteps=function(t,o="awaiting-feature-creation-info"){const{data:s,handles:l}=t;let c=null,d=!0;const u=new Map,f={"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",setUp(){var t=this;return e._asyncToGenerator((function*(){s.creationInfo=null,l.add(s.viewModel.featureTemplatesViewModel.on("select",(({item:e})=>{e&&(s.creationInfo=e,s.viewModel.activeWorkflow?.next())})),t.id)}))()},tearDown(){var t=this;return e._asyncToGenerator((function*(){l.remove(t.id)}))()}}),"creating-features":()=>({id:"creating-features",setUp(){var o=this;return e._asyncToGenerator((function*(){if(l.has(o.id))return;const f=s.viewModel.view;if(!f)return;const p=s.viewModel.sketchViewModel;d=p.updateOnGraphicClick,p.updateOnGraphicClick=!1,t._lastActiveGraphics=[],t._featureFormHandle=n.removeMaybe(t._featureFormHandle),t._visualVariableAttributes={rotation:null,size:null},v.prepareAttachmentsForCreateWorkflow(s.viewModel.attachmentsViewModel);const g="2d"===f.type?t._fadeExistingFeatures(s.creationInfo.layer):null,w=p.on("create",function(){var a=e._asyncToGenerator((function*(e){if("cancel"===e.state){if(t._preventDefaultActionOnCancel)return void(t._preventDefaultActionOnCancel=!1);if(t._lastActiveGraphics.length<1)return t._startCreating(u);const e=t._lastActiveGraphics.pop();return t._startUpdating(e,u)}if("complete"===e.state&&e.graphic)return t._startUpdating(e.graphic,u)}));return function(e){return a.apply(this,arguments)}}()),y=p.on("update",function(){var a=e._asyncToGenerator((function*(e){const a=e.graphics[0];if("complete"===e.state){if(a!==c&&(t._lastActiveGraphics.push(a),t._highlight(a)),c=null,"add"!==s.viewModel.attachmentsViewModel.mode&&"edit"!==s.viewModel.attachmentsViewModel.mode||s.viewModel.activeWorkflow?.previous(),e.aborted&&t._preventDefaultActionOnCancel)return void(t._preventDefaultActionOnCancel=!1);const n=f.cursor;return f.cursor="progress",l.add([r.makeHandle((()=>f.cursor=n)),f.on("click",(e=>e.preventDefault()))],m),i.whenOnce((()=>!s.viewModel.featureFormViewModel.updating)).then((()=>{l.remove(m),t._startCreating(u)}))}if("start"===e.state){t._removeHighlight(a);const e=s.viewModel.attachmentsViewModel;"add"!==e.mode&&"edit"!==e.mode||s.viewModel.activeWorkflow?.previous(),e.fileInfos.removeAll(),e.graphic=a,e.mode="view";(t._attachmentFileInfos.get(a)||[]).forEach((({file:t,form:a})=>e.addFile(t,a)))}yield v.visualVariableInteractiveUpdate(f,a,e,t._visualVariableAttributes,u);const o=a.attributes;if(n.isSome(t._visualVariableAttributes.rotation)){const{field:e}=t._visualVariableAttributes.rotation;s.viewModel.featureFormViewModel.setValue(e,o[e])}if(n.isSome(t._visualVariableAttributes.size)){const{field:e}=t._visualVariableAttributes.size;s.viewModel.featureFormViewModel.setValue(e,o[e])}}));return function(e){return a.apply(this,arguments)}}()),_=p.on("delete",function(){var r=e._asyncToGenerator((function*(e){const r=e.graphics[0];a.remove(t._lastActiveGraphics,r),c=r}));return function(e){return r.apply(this,arguments)}}());let M=null;const b=i.watch((()=>{const e=p.snappingOptions.featureSources.find((e=>e.layer===s.creationInfo.layer));return{hasFeatureLayerSource:!!e,enabled:e?.enabled??!1}}),(({hasFeatureLayerSource:e,enabled:t})=>{const a=p.snappingOptions.featureSources;e?(n.isNone(M)&&(M=new h({layer:p.layer,enabled:t}),a.add(M)),M.enabled=t):(n.isSome(M)&&a.remove(M),M=n.destroyMaybe(M))}),i.syncAndInitial),A=f.on("immediate-click",function(){var a=e._asyncToGenerator((function*(e){const{results:a}=yield f.hitTest(e,{include:p.layer}),r=a.find((e=>"graphic"===e.type));if(r){const e=r.graphic;if("transform"===p.activeTool||"reshape"===p.activeTool){if(p.updateGraphics.getItemAt(0)===e)return;yield t.updatePendingFeature(e,u)}}}));return function(e){return a.apply(this,arguments)}}()),F=i.watch((()=>s.viewModel.attachmentsViewModel.mode),(e=>{"add"===e&&s.viewModel.activeWorkflow.go("adding-attachment"),"edit"===e&&s.viewModel.activeWorkflow.go("editing-attachment")}));yield t._startCreating(u);const I={remove:()=>{n.removeMaybe(t._featureFormHandle),w.remove(),y.remove(),_.remove(),b.remove(),n.isSome(M)&&p.snappingOptions.featureSources.remove(M),M=n.destroyMaybe(M),p.cancel(),A.remove(),F.remove(),n.removeMaybe(g)}};l.add(I,o.id)}))()},tearDown(a){var r=this;return e._asyncToGenerator((function*(){a.cancelled&&(s.viewModel.sketchViewModel.layer.removeAll(),l.remove([r.id,m]),s.viewModel.attachmentsViewModel.fileInfos.removeAll(),t._attachmentFileInfos.clear(),s.viewModel.sketchViewModel.updateOnGraphicClick=d)}))()}}),"adding-attachment":()=>({id:"adding-attachment",parent:"creating-features",setUp:()=>e._asyncToGenerator((function*(){}))(),tearDown:()=>e._asyncToGenerator((function*(){const{graphic:e,fileInfos:a}=s.viewModel.attachmentsViewModel;t._attachmentFileInfos.set(e,a.toArray()),s.viewModel.attachmentsViewModel.mode="view"}))()}),"editing-attachment":()=>({id:"editing-attachment",parent:"creating-features",setUp:()=>e._asyncToGenerator((function*(){}))(),tearDown:()=>e._asyncToGenerator((function*(){const{graphic:e,fileInfos:a}=s.viewModel.attachmentsViewModel;t._attachmentFileInfos.set(e,a.toArray()),s.viewModel.attachmentsViewModel.mode="view"}))()})},p=v.createWorkflowSteps(["awaiting-feature-creation-info","creating-features","adding-attachment","editing-attachment"],o,f);return v.avoidFeatureTemplateSelectionWithOnlyOneItem(s,p)},l._getAddAttachmentsData=function(e,t,a,r){const n=[];return t.forEach(((t,i)=>{if(!t.error){const o=e[i],s=r.get(o)||[];o.attributes[a.objectIdField]=t.objectId,s.forEach((({form:e})=>n.push({feature:o,attachment:e})))}})),n},l._getAttachmentEditsWithGlobalIds=function(e,t,a){const r=[],i=t.globalIdField;return e.forEach(((t,s)=>{const l=a.get(t)||[];let c=t.attributes[i];n.isNone(c)&&(c=o.generateUUID(),e[s].attributes[i]=c),l.forEach((({file:e})=>r.push({feature:t,attachment:{globalId:o.generateUUID(),data:e}})))})),r.length?{addFeatures:e,addAttachments:r}:{addFeatures:e}},e._createClass(s,[{key:"numPendingFeatures",get:function(){return this.data.viewModel.sketchViewModel.layer.graphics.length}},{key:"pendingFeatures",get:function(){return this.data.viewModel.sketchViewModel.layer.graphics}},{key:"reliesOnOwnerAdminPrivileges",get:function(){const{layer:e}=this.data.creationInfo,t=e.capabilities?.operations.supportsAdd,a=d.getEffectiveLayerCapabilities(e)?.operations.supportsAdd;return d.getEffectiveEditingEnabled(e)&&!e.editingEnabled||!!a&&!t}},{key:"shouldShowAttachments",get:function(){return!!(this.data&&this.data.creationInfo&&this.data.viewModel)&&v.shouldShowAttachmentsForCreateWorkflow(this.data)}},{key:"shouldAllowAttachmentEditing",get:function(){return this.shouldShowAttachments}},{key:"helpMessage",get:function(){if("creating-features"!==this.stepId)return;const{creationInfo:e,viewModel:t}=this.data;return u.getDrawHelpMessage(e.layer.geometryType,t.sketchViewModel.createGraphic?.geometry)}}]),s}(p);t.__decorate([s.property()],w.prototype,"reliesOnOwnerAdminPrivileges",null),t.__decorate([s.property()],w.prototype,"shouldShowAttachments",null),t.__decorate([s.property()],w.prototype,"shouldAllowAttachmentEditing",null),t.__decorate([s.property()],w.prototype,"helpMessage",null),w=g=t.__decorate([c.subclass("esri.widgets.Editor.CreateFeaturesWorkflow")],w);return w}));
