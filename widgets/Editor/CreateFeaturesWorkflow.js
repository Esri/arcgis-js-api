/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import{remove as t}from"../../core/arrayUtils.js";import{makeHandle as a}from"../../core/handleUtils.js";import{unwrap as r,removeMaybe as i,isSome as s,isNone as o,destroyMaybe as n}from"../../core/maybe.js";import{watch as l,syncAndInitial as c}from"../../core/reactiveUtils.js";import"../../core/Logger.js";import"../../core/accessorSupport/ensureType.js";import"../../core/has.js";import"../../core/accessorSupport/set.js";import{subclass as u}from"../../core/accessorSupport/decorators/subclass.js";import d from"../../views/interactive/snapping/FeatureSnappingLayerSource.js";import{CreateFeaturesWorkflowData as p}from"./CreateFeaturesWorkflowData.js";import h from"./Workflow.js";import{startCreatingNewFeature as f,findLayerInfo as m,updateGraphicSymbolWhenRequired as g,getVisualVariableAttributes as v,startUpdatingFeature as w,createWorkflowSteps as y,avoidFeatureTemplateSelectionWithOnlyOneItem as M,visualVariableInteractiveUpdate as b}from"./workflowUtils.js";var V;let F=V=class extends h{constructor(e){super(e),this.type="create-features",this.createFeatureState="create-new",this.featureFormHandle=null,this.visualVariableAttributes={rotation:null,size:null},this.highlightHandles=new Map,this.preventDefaultActionOnCancel=!1}get numPendingFeatures(){return this.data.viewModel.sketchViewModel.layer.graphics.length}get pendingFeatures(){return this.data.viewModel.sketchViewModel.layer.graphics}async updatePendingFeature(e,a){return this.preventDefaultActionOnCancel=!0,this.data.viewModel.sketchViewModel.cancel(),t(this.lastActiveGraphics,e),this._startUpdating(e,a)}static create(e,t,a,i){const s=new V({data:new p({creationInfo:r(t),viewModel:e}),onCommit:async e=>{await i(e.creationInfo.layer,{addFeatures:e.viewModel.sketchViewModel.layer.graphics.toArray()})}});return s._set("steps",this._createWorkflowSteps(s,a)),s}_fadeExistingFeatures(e){if("effect"in e){const t=e.effect;return e.effect="saturate(0.6) opacity(0.8)",a((()=>e.effect=t))}const t=e.opacity;return e.opacity=.7,a((()=>e.opacity=t))}_highlight(e){const t=this.data.viewModel.view;"3d"===t.type&&this.highlightHandles.set(e,t.highlight(e))}_removeHighlight(e){i(this.highlightHandles.get(e)),this.highlightHandles.delete(e)}async _startCreating(e){return this.createFeatureState="create-new",f(this.data.viewModel.sketchViewModel,this.data.creationInfo,e)}async _startUpdating(e,t){const a=this.data.viewModel,r=a.sketchViewModel,s=this.data.creationInfo.layer,o=m(a.layerInfos,s)?.formTemplate,n=a.view.spatialReference;return a.featureFormViewModel.set({feature:e,formTemplate:o,spatialReference:n}),i(this.featureFormHandle),this.featureFormHandle=a.featureFormViewModel.on("value-change",(async()=>{e.attributes=a.featureFormViewModel.getValues(),await g(e,t)})),this._removeHighlight(e),this.createFeatureState="update-pending",this.visualVariableAttributes=v(e),w(r,e,s,this.visualVariableAttributes,t)}static _createWorkflowSteps(e,a="awaiting-feature-creation-info"){const{data:r,handles:u}=e;let p=null,h=!0;const f=new Map,m=y(["awaiting-feature-creation-info","creating-features"],a,{"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",async setUp(){r.creationInfo=null,u.add(r.viewModel.featureTemplatesViewModel.on("select",(({item:e})=>{r.creationInfo={layer:e.layer,template:e.template},r.viewModel.activeWorkflow.next()})),this.id)},async tearDown(){u.remove(this.id)}}),"creating-features":()=>({id:"creating-features",async setUp(){const a=r.viewModel.view,m=r.viewModel.sketchViewModel;h=m.updateOnGraphicClick,m.updateOnGraphicClick=!1,e.lastActiveGraphics=[],e.featureFormHandle=i(e.featureFormHandle),e.visualVariableAttributes={rotation:null,size:null};const g="2d"===a.type?e._fadeExistingFeatures(r.creationInfo.layer):null,v=m.on("create",(async t=>{if("cancel"===t.state){if(e.preventDefaultActionOnCancel)return void(e.preventDefaultActionOnCancel=!1);if(e.lastActiveGraphics.length<1)return e._startCreating(f);const t=e.lastActiveGraphics.pop();return e._startUpdating(t,f)}if("complete"===t.state)return e._startUpdating(t.graphic,f)})),w=m.on("update",(async t=>{const i=t.graphics[0];if("complete"===t.state)return i!==p&&(e.lastActiveGraphics.push(i),e._highlight(i)),p=null,t.aborted&&e.preventDefaultActionOnCancel?void(e.preventDefaultActionOnCancel=!1):e._startCreating(f);"start"===t.state&&e._removeHighlight(i),await b(a,i,t,e.visualVariableAttributes,f);const o=i.attributes;if(s(e.visualVariableAttributes.rotation)){const{field:t}=e.visualVariableAttributes.rotation;r.viewModel.featureFormViewModel.setValue(t,o[t])}if(s(e.visualVariableAttributes.size)){const{field:t}=e.visualVariableAttributes.size;r.viewModel.featureFormViewModel.setValue(t,o[t])}})),y=m.on("delete",(async a=>{const r=a.graphics[0];t(e.lastActiveGraphics,r),p=r}));let M=null;const V=l((()=>{const e=m.snappingOptions.featureSources.find((e=>e.layer===r.creationInfo.layer));return{hasFeatureLayerSource:!!e,enabled:e?.enabled??!1}}),(({hasFeatureLayerSource:e,enabled:t})=>{const a=m.snappingOptions.featureSources;e?(o(M)&&(M=new d({layer:m.layer,enabled:t}),a.add(M)),M.enabled=t):(s(M)&&a.remove(M),M=n(M))}),c),F=a.on("immediate-click",(async t=>{const{results:r}=await a.hitTest(t,{include:m.layer}),i=r.find((e=>"graphic"===e.type));if(i){const t=i.graphic;if("transform"===m.activeTool||"reshape"===m.activeTool){if(m.updateGraphics.getItemAt(0)===t)return;await e.updatePendingFeature(t,f)}}}));await e._startCreating(f);const A={remove:()=>{i(e.featureFormHandle),v.remove(),w.remove(),y.remove(),V.remove(),s(M)&&m.snappingOptions.featureSources.remove(M),M=n(M),m.cancel(),F.remove(),i(g)}};u.add(A,this.id)},async tearDown(e){e.cancelled&&r.viewModel.sketchViewModel.layer.removeAll(),u.remove(this.id),r.viewModel.sketchViewModel.updateOnGraphicClick=h}})});return M(r,m)}};F=V=e([u("esri.widgets.Editor.CreateFeaturesWorkflow")],F);const A=F;export{A as default};
