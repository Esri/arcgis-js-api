// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../Graphic","../../core/arrayUtils","../../core/compilerUtils","../../core/maybe","../../core/promiseUtils","../../core/screenUtils","../../core/accessorSupport/diffUtils","../../layers/support/fieldUtils","../../renderers/support/clickToleranceUtils","../../renderers/support/utils","../../renderers/visualVariables/support/sizeVariableUtils","../../renderers/visualVariables/support/visualVariableUtils","../../symbols/support/symbolConversion","../../symbols/support/symbolUtils","../../views/support/drapedUtils","@dojo/framework/shim/Promise"],(function(e,t,r,n,i,a,s,u,l,o,c,f,d,p,y,v,h,b){"use strict";function m(e){var t=e.layer,r=function(e){switch(e.type){case"class-breaks":case"simple":case"unique-value":case"dot-density":case"dictionary":return!0;default:return!1}}(t.renderer)&&y.getVisualVariableValues(t.renderer,e),n=r?r.map((function(e){return e.variable})):[],i=n.filter((function(e){return"rotation"===e.type&&(!e.axis||"heading"===e.axis)})),a=i[0],s=1===i.length&&a.field&&!a.valueExpression,u=n.filter((function(e){return"size"===e.type})),l=u[0],o=1===u.length&&"real-world-size"===p.getTransformationType(l)&&l.field&&!l.useSymbolValue&&!l.valueExpression;return{rotation:s?g(a,t):null,size:o?S(l,t):null}}function g(e,t){var r="heading"===(e.axis||"heading")&&"arithmetic"===e.rotationType?-1:1,n=e.field,i=t.fields&&t.fields.filter((function(e){return e.name===n})),a=i&&1===i.length?i[0].type:"double",s={initial:0,current:0};return{field:n,getDefault:function(){return u.resolve(0)},getValue:function(e){return s.current=s.initial-r*e,U((s.current+360)%360,a)},initValue:function(e){s.initial=null!=e?e:s.current,s.current=0},isUpdatingInteractively:!1}}function _(e,t){switch(t){case"width":return e[0];case"depth":return e[1];case"height":return e[2];default:return e[2]||e[1]||e[0]}}function w(n,i,u){return r.__awaiter(this,void 0,void 0,(function(){var l,o,c,f,d,p,y;return r.__generator(this,(function(r){switch(r.label){case 0:if(s.isNone(i))return[2,0];if(l=v.to3D(i).symbol,s.isNone(l)||"web-style"===l.type)return[2,0];if(!(o=l.symbolLayers.getItemAt(0)))return[2,0];switch(o.type){case"icon":return[3,1];case"text":return[3,5];case"line":return[3,6];case"object":return[3,7];case"path":case"extrude":return[3,10];case"fill":case"water":return[3,11]}return[3,12];case 1:return[4,new Promise((function(t,r){e(["../../symbols/support/symbolLayerUtils"],t,r)}))];case 2:return c=r.sent().computeIconLayerResourceSize,(f=o.size)?[3,4]:(p=(d=Math).min,y=[t.sizeDefaults.icon],[4,c(o,t.sizeDefaults.icon)]);case 3:f=p.apply(d,y.concat([r.sent()[0]])),r.label=4;case 4:return[2,f||t.sizeDefaults.icon];case 5:return[2,o.size||t.sizeDefaults.text];case 6:return[2,o.size||t.sizeDefaults.line];case 7:return[4,new Promise((function(t,r){e(["../../symbols/support/symbolLayerUtils"],t,r)}))];case 8:return[4,(0,r.sent().computeObjectLayerResourceSize)(o,n.scale/t.sizeDefaults.viewScaleSizeFactor)];case 9:return[2,_(r.sent(),u)];case 10:return[2,o.size||n.scale/t.sizeDefaults.viewScaleSizeFactor];case 11:return[2,0];case 12:return a.neverReached(o),[2,0]}}))}))}function S(e,t){var n,i=this,a=e.field,s=e.axis,u=t.fields&&t.fields.filter((function(e){return e.name===a})),l=u&&1===u.length?u[0].type:"double",o={updating:!1,initial:0,current:0},c=d.meterIn[e.valueUnit];return n="area"===e.valueRepresentation?function(e){return Math.pow(e*c/2,2)*Math.PI}:"radius"===e.valueRepresentation||"distance"===e.valueRepresentation?function(e){return e*c/2}:function(e){return e*c},{field:a,getDefault:function(e,t){return r.__awaiter(i,void 0,void 0,(function(){var i,a;return r.__generator(this,(function(r){switch(r.label){case 0:return i=U,a=n,[4,w(t,e,s)];case 1:return[2,i.apply(void 0,[a.apply(void 0,[r.sent()]),l])]}}))}))},getValue:function(e,t){return o.initial||(o.initial=t.pixelSizeAt(t.center)),o.current=o.initial*e,U(o.current,l)},initValue:function(e){o.initial=null!=e?e:o.current,o.current=0},isUpdatingInteractively:!1}}function U(e,t){switch(t){case"small-integer":case"integer":case"long":return Math.round(e);case"double":case"single":return e;default:return 0}}function I(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,h.getDisplayedSymbol(e,{ignoreGraphicSymbol:!0})];case 1:return t=r.sent(),n=o.diff(e.symbol,t),s.isSome(n)&&(e.symbol=t),[2]}}))}))}function V(e,t,i){return r.__awaiter(this,void 0,void 0,(function(){var a,u,l,o,c,f,d,p,y,v,b,g,_;return r.__generator(this,(function(w){switch(w.label){case 0:return"3d"!==i.type?[2]:(a=t.layer,u=r.__assign({},t.template.prototype.attributes),l=new n({layer:a,sourceLayer:a,attributes:u}),o=m(l),c=o.rotation,f=o.size,[4,h.getDisplayedSymbol(l)]);case 1:d=w.sent(),p=!1,y=0,v=[f,c],w.label=2;case 2:return y<v.length?(b=v[y],s.isNone(b)?[3,4]:null!=u[b.field]?[3,4]:(g=u,_=b.field,[4,b.getDefault(d,i)])):[3,5];case 3:g[_]=w.sent(),p=!0,w.label=4;case 4:return y++,[3,2];case 5:return p?[4,h.getDisplayedSymbol(l)]:[3,7];case 6:d=w.sent(),w.label=7;case 7:switch(null==d?void 0:d.type){case"simple-fill":case"polygon-3d":e.polygonSymbol=d;break;case"simple-line":case"line-3d":e.polylineSymbol=d;break;case"simple-marker":case"point-3d":e.pointSymbol=d}return[2]}}))}))}function z(e,t,n){return r.__awaiter(this,void 0,void 0,(function(){var i,a;return r.__generator(this,(function(r){switch(r.label){case 0:return 0===e.length?[2,[]]:[4,t.hitTest(n)];case 1:return 0===(i=r.sent()).results.length?[2,[]]:(a=new Map,i.results.forEach((function(e){var t=e.graphic,r=t.layer;a.has(r)||a.set(r,[]),a.get(r).push(t)})),[2,u.eachAlways(e.items.filter((function(e){var t=e.layer;return e.supports.indexOf("update")>-1&&a.has(t)})).map((function(e){var t=e.layer,r=t.objectIdField,n=t.displayField,i=[r];c.hasField(t.fields,n)&&i.push(n);var s=a.get(t);if(!!s.some((function(e){return i.some((function(t){return!(t in e.attributes)}))}))){var l=t.createQuery();return l.outFields=i,l.returnGeometry=!1,l.objectIds=s.map((function(e){return e.getObjectId()})),t.queryFeatures(l).then((function(e){return e.features}))}return u.resolve(s)})))])}}))}))}function F(e,t,n){return r.__awaiter(this,void 0,void 0,(function(){var i,a;return r.__generator(this,(function(r){switch(r.label){case 0:return 0===e.length?[2,[]]:[4,t.hitTest(n)];case 1:return 0===(i=r.sent()).results.length?[2,[]]:(a=new Set,i.results.forEach((function(e){var t=e.graphic;return a.add(t.layer)})),[2,u.eachAlways(e.items.filter((function(e){var t=e.layer;return e.supports.indexOf("update")>-1&&a.has(t)})).map((function(e){var r=e.layer,i=r.objectIdField,a=r.displayField,s=[i];c.hasField(r.fields,a)&&s.push(a);var u=r.createQuery();u.outFields=s,u.returnGeometry=!1;var l=f.calculateTolerance({renderer:r.renderer,event:n});return u.geometry=b.createQueryGeometry(n.mapPoint,l,t),r.queryFeatures(u).then((function(e){return e.features}))})))])}}))}))}Object.defineProperty(t,"__esModule",{value:!0}),t.sizeDefaults=t.setUpGeometryUpdate=t.fetchFullFeature=t.fetchCandidates=t.findLayerInfo=t.setUpFeatureAdd=t.getVisualVariableAttributes=void 0,t.getVisualVariableAttributes=m,t.setUpFeatureAdd=function(e,t,n,i){return r.__awaiter(this,void 0,void 0,(function(){var a,s,u,l=this;return r.__generator(this,(function(o){switch(o.label){case 0:return a=t.layer,[4,V(e,t,n)];case 1:return o.sent(),e.layer.elevationInfo=a.elevationInfo,[4,(s=function(){return e.create(a.geometryType,{hasZ:a.capabilities.data.supportsZ})})()];case 2:return o.sent(),u=e.on("create",(function(n){return r.__awaiter(l,void 0,void 0,(function(){var u,l,o;return r.__generator(this,(function(c){switch(c.label){case 0:return u=n.state,l=n.graphic,"cancel"===u?(s(),[2]):"complete"!==u?[3,2]:((o=l.clone()).attributes=r.__assign({},t.template.prototype.attributes),o.layer=a,e.layer.remove(l),[4,I(o)]);case 1:c.sent(),i(o),c.label=2;case 2:return[2]}}))}))})),n.map.add(e.layer),[2,{remove:function(){u.remove(),n.map.remove(e.layer),e.cancel()}}]}}))}))},t.findLayerInfo=function(e,t){return e&&i.find(e,(function(e){return e.layer===t}))},t.fetchCandidates=function(e,t,n){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(r){switch(t.type){case"3d":return[2,z(e,t,n)];case"2d":return[2,F(e,t,n)];default:return a.neverReached(t),[2,null]}return[2]}))}))},t.fetchFullFeature=function(e,t,r){var n=e.layer,i=n.createQuery();return i.objectIds=[e.getAttribute(n.objectIdField)],i.outFields=["*"],i.outSpatialReference=t.spatialReference,i.returnM=n.capabilities.data.supportsM,i.returnZ=n.capabilities.data.supportsZ,n.queryFeatures(i,r).then((function(e){return e.features[0]}))},t.setUpGeometryUpdate=function(e,t,n,i,a){return r.__awaiter(this,void 0,void 0,(function(){var u,l,o,c,f,d,p,y,v,h=this;return r.__generator(this,(function(b){switch(b.label){case 0:return[4,I(u=e.clone())];case 1:return b.sent(),n.layer.add(u),u.sourceLayer=e.layer,l=function(){var t=e.layer;if("graphics"===t.type)return{remove:function(){}};var r=t.objectIdField,n=e.attributes[r],a=i.whenLayerView(t);return a.then((function(e){return e.setVisibility(n,!1)}),(function(){})),{remove:function(){a.then((function(e){return e.setVisibility(n,!0)}),(function(){}))}}}(),o=e.layer,c=t.size,f=t.rotation,d={multipleSelectionEnabled:!1},"point"===o.geometryType&&(d.enableRotation=!!f,d.enableScaling=!!c),n.layer.elevationInfo=o.elevationInfo,n.update(u,d),p=(s.isSome(c)||s.isSome(f))&&e.watch("attributes",(function(e){return r.__awaiter(h,void 0,void 0,(function(){var t,n,a;return r.__generator(this,(function(r){switch(r.label){case 0:for(n in t=!1,e)(a=e[n])!==u.attributes[n]&&(u.setAttribute(n,a),t=!0,s.isSome(c)&&!c.isUpdatingInteractively&&c.field===n&&c.initValue(a),s.isSome(f)&&!f.isUpdatingInteractively&&f.field===n&&f.initValue(a));return t&&"3d"===i.type?[4,I(u)]:[3,2];case 1:r.sent(),r.label=2;case 2:return[2]}}))}))})),[f,c].forEach((function(t){return r.__awaiter(h,void 0,void 0,(function(){var n,a;return r.__generator(this,(function(r){switch(r.label){case 0:return s.isNone(t)?[2]:null==(n=e.attributes[t.field])?[3,1]:(t.initValue(n),[3,4]);case 1:return[4,t.getDefault(u.symbol,i)];case 2:return a=r.sent(),t.initValue(a),u.setAttribute(t.field,a),"3d"!==i.type?[3,4]:[4,I(u)];case 3:r.sent(),r.label=4;case 4:return[2]}}))}))})),y=n.on("update",(function(e){return r.__awaiter(h,void 0,void 0,(function(){var t,l,o,p,y,v,h,b;return r.__generator(this,(function(r){switch(r.label){case 0:return t=e.graphics[0],l=e.state,o=e.toolEventInfo,"complete"===l?(n.update(t,d),[2]):(p=o,s.isSome(f)&&p&&(v=f.field,h=f.getValue,b=f.initValue,"rotate-stop"===p.type?(f.isUpdatingInteractively=!1,b()):null!=p.angle&&(f.isUpdatingInteractively=!0,u.attributes[v]=h(p.angle/Math.PI*180,i))),y=o,s.isSome(c)&&y&&(v=c.field,h=c.getValue,b=c.initValue,"scale-stop"===y.type?(c.isUpdatingInteractively=!1,b()):null!=y.xScale&&(c.isUpdatingInteractively=!0,u.attributes[v]=h(y.xScale,i))),"3d"!==i.type?[3,2]:[4,I(u)]);case 1:r.sent(),r.label=2;case 2:return a(t.clone()),[2]}}))}))})),i.map.add(n.layer),v=function(){},[2,{interactive:{remove:function(){y.remove(),n.cancel(),p&&p.remove(),this.remove=v}},visual:{remove:function(){l.remove(),i.map.remove(n.layer),n.layer.removeAll(),this.remove=v}}}]}}))}))},t.sizeDefaults={icon:l.px2pt(24),text:l.px2pt(12),line:l.px2pt(1),viewScaleSizeFactor:100}}));