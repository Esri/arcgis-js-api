/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["require","exports","../../core/has","../../core/maybe","../../core/promiseUtils","../../layers/support/fieldUtils","../../core/screenUtils","../../Graphic","../../renderers/support/lengthUtils","../../renderers/visualVariables/support/sizeVariableUtils","../../renderers/visualVariables/support/visualVariableUtils","../../symbols/support/symbolConversion","../../core/accessorSupport/diffUtils","../../symbols/support/symbolUtils","../../views/support/hitTestSelectUtils","../../renderers/support/clickToleranceUtils","../../views/support/drapedUtils"],(function(e,t,a,i,r,n,s,l,o,c,u,p,y,d,f,m,b){"use strict";function h(e){const t=e.layer,a=U(t.renderer)&&u.getVisualVariableValues(t.renderer,e),i=a?a.map((e=>e.variable)):[],r=i.filter((e=>"rotation"===e.type&&(!e.axis||"heading"===e.axis))),n=r[0],s=1===r.length&&n.field&&!n.valueExpression,l=i.filter((e=>"size"===e.type)),o=l[0],p=1===l.length&&"real-world-size"===c.getTransformationType(o)&&o.field&&!o.useSymbolValue&&!o.valueExpression;return{rotation:s?g(n,t):null,size:p?S(o,t):null}}function g(e,t){const a="heading"===(e.axis||"heading")&&"arithmetic"===e.rotationType?-1:1,i=e.field,r=t.fields&&t.fields.filter((e=>e.name===i)),n=r&&1===r.length?r[0].type:"double",s={initial:0,current:0};return{field:i,getDefault:()=>Promise.resolve(0),getValue:e=>(s.current=s.initial-a*e,I((s.current+360)%360,n)),initValue:e=>{s.initial=null!=e?e:s.current,s.current=0},isUpdatingInteractively:!1}}function v(e,t){switch(t){case"width":return e[0];case"depth":return e[1];case"height":return e[2];default:return e[2]||e[1]||e[0]}}async function w(t,a,r){if(i.isNone(a))return 0;const{symbol:n}=p.to3D(a);if(i.isNone(n)||"web-style"===n.type)return 0;const s=n.symbolLayers.getItemAt(0);if(!s)return 0;switch(s.type){case"icon":{const{computeIconLayerResourceSize:t}=await new Promise((function(t,a){e(["../../symbols/support/symbolLayerUtils"],t,a)}));return s.size||Math.min(T.icon,(await t(s,T.icon))[0])||T.icon}case"text":return s.size||T.text;case"line":return s.size||T.line;case"object":{const{computeObjectLayerResourceSize:a}=await new Promise((function(t,a){e(["../../symbols/support/symbolLayerUtils"],t,a)}));return v(await a(s,t.scale/T.viewScaleSizeFactor),r)}case"path":case"extrude":return s.size||t.scale/T.viewScaleSizeFactor;case"fill":case"water":default:return 0}}function S(e,t){const a=e.field,i=e.axis,r=t.fields&&t.fields.filter((e=>e.name===a)),n=r&&1===r.length?r[0].type:"double",s={updating:!1,initial:0,current:0},l=o.meterIn[e.valueUnit];let c;return c="area"===e.valueRepresentation?e=>(e*l/2)**2*Math.PI:"radius"===e.valueRepresentation||"distance"===e.valueRepresentation?e=>e*l/2:e=>e*l,{field:a,getDefault:async(e,t)=>I(c(await w(t,e,i)),n),getValue:(e,t)=>(s.initial||(s.initial=t.pixelSizeAt(t.center)),s.current=s.initial*e,I(s.current,n)),initValue:e=>{s.initial=null!=e?e:s.current,s.current=0},isUpdatingInteractively:!1}}function I(e,t){switch(t){case"small-integer":case"integer":case"long":return Math.round(e);case"double":case"single":return e;default:return 0}}function U(e){switch(e.type){case"class-breaks":case"simple":case"unique-value":case"dot-density":case"dictionary":return!0;default:return!1}}async function V(e){const t=await d.getDisplayedSymbol(e,{ignoreGraphicSymbol:!0}),a=y.diff(e.symbol,t);i.isSome(a)&&(e.symbol=t)}async function F(e,t,a,i){const r=t.layer;await x(e,t,a),e.layer.elevationInfo=r.elevationInfo;const n=()=>e.create(r.geometryType,{hasZ:r.capabilities.data.supportsZ});await n();const s=e.on("create",(async a=>{const{state:s,graphic:l}=a;if("cancel"!==s){if("complete"===s){const a=l.clone();a.attributes={...t.template.prototype.attributes},a.layer=r,e.layer.remove(l),await V(a),i(a)}}else n()}));return a.map.add(e.layer),{remove:()=>{s.remove(),a.map.remove(e.layer),e.cancel()}}}async function x(e,t,a){var r;if("3d"!==a.type)return;const n=t.layer,s={...t.template.prototype.attributes},o=new l({layer:n,sourceLayer:n,attributes:s}),{rotation:c,size:u}=h(o);let p=await d.getDisplayedSymbol(o),y=!1;for(const l of[u,c]){if(i.isNone(l))continue;null==s[l.field]&&(s[l.field]=await l.getDefault(p,a),y=!0)}switch(y&&(p=await d.getDisplayedSymbol(o)),null==(r=p)?void 0:r.type){case"simple-fill":case"polygon-3d":e.polygonSymbol=p;break;case"simple-line":case"line-3d":e.polylineSymbol=p;break;case"simple-marker":case"point-3d":e.pointSymbol=p}}function z(e,t){return e&&e.find((e=>e.layer===t))}async function A(e,t,a,i){if(0===e.length)return[];const{updatable:s,graphicsByLayer:l}=await a.async((async()=>{const{results:n}=await r.whenOrAbort(f.hitTestSelectSameDistance(t,a),i),s=new Map,l=({layer:e})=>{const t=s.get(e);if(!t){const t=new Array;return s.set(e,t),t}return t};n.forEach((({graphic:e})=>l(e).push(e)));const o=e.filter((({supports:e,layer:t})=>e.indexOf("update")>-1&&s.has(t)));return 0!==o.length&&a.stopPropagation(),{updatable:o,graphicsByLayer:s}}));return r.whenOrAbort(r.eachAlways(s.map((async({layer:e})=>{const{objectIdField:t,displayField:a}=e,r=[t];n.hasField(e.fields,a)&&r.push(a);const s=l.get(e);if(!!s.some((e=>r.some((t=>!(t in e.attributes)))))){const t=e.createQuery();return t.outFields=r,t.returnGeometry=!1,t.objectIds=s.map((e=>e.getObjectId())),e.queryFeatures(t,{signal:i}).then((({features:e})=>e))}return s}))),i)}async function L(e,t,a,i){if(0===e.length)return[];const s=await a.async((async()=>{const{results:n}=await r.whenOrAbort(t.hitTest(a),i);if(0===n.length)return[];const s=new Set;n.forEach((({graphic:e})=>s.add(e.layer)));const l=e.items.filter((({layer:e,supports:t})=>t.indexOf("update")>-1&&s.has(e)));return l.length>0&&a.stopPropagation(),l}));return r.whenOrAbort(r.eachAlways(s.map((({layer:e})=>{const{objectIdField:r,displayField:s}=e,l=[r];n.hasField(e.fields,s)&&l.push(s);const o=e.createQuery();o.outFields=l,o.returnGeometry=!1;const c=m.calculateTolerance({renderer:e.renderer,event:a});return o.geometry=b.createQueryGeometry(a.mapPoint,c,t),o.outSpatialReference=t.spatialReference,e.queryFeatures(o,{signal:i}).then((({features:e})=>e))}))),i)}async function j(e,t,a,i){switch(t.type){case"3d":return A(e,t,a,i);case"2d":return L(e,t,a,i)}}async function D(e,t,a){const i=e.layer,r=i.createQuery();return r.objectIds=[e.getAttribute(i.objectIdField)],r.outFields=["*"],r.outSpatialReference=t.spatialReference,r.returnM=i.capabilities.data.supportsM,r.returnZ=i.capabilities.data.supportsZ,(await i.queryFeatures(r,{signal:a})).features[0]}async function R(e,t,a,r,n){const s=e.clone();await V(s),a.layer.add(s),s.sourceLayer=e.layer;const l=(()=>{const{layer:t}=e;if("graphics"===t.type)return{remove(){}};const{objectIdField:a}=t,i=e.attributes[a],n=r.whenLayerView(t);return n.then((e=>e.setVisibility(i,!1)),(()=>{})),{remove(){n.then((e=>e.setVisibility(i,!0)),(()=>{}))}}})(),o=e.layer,c=t.size,u=t.rotation,p={multipleSelectionEnabled:!1};"point"===o.geometryType&&(p.enableRotation=!!u,p.enableScaling=!!c),a.layer.elevationInfo=o.elevationInfo,a.update(s,p);const y=(i.isSome(c)||i.isSome(u))&&e.watch("attributes",(async e=>{let t=!1;for(const a in e){const r=e[a];r!==s.attributes[a]&&(s.setAttribute(a,r),t=!0,i.isSome(c)&&!c.isUpdatingInteractively&&c.field===a&&c.initValue(r),i.isSome(u)&&!u.isUpdatingInteractively&&u.field===a&&u.initValue(r))}t&&"3d"===r.type&&await V(s)}));[u,c].forEach((async t=>{if(i.isNone(t))return;const a=e.attributes[t.field];if(null!=a)t.initValue(a);else{const e=await t.getDefault(s.symbol,r);t.initValue(e),s.setAttribute(t.field,e),"3d"===r.type&&await V(s)}}));const d=a.on("update",(async e=>{const{graphics:[t],state:l,toolEventInfo:o}=e;if("complete"===l)return void a.update(t,p);const y=o;if(i.isSome(u)&&y){const{field:e,getValue:t,initValue:a}=u;"rotate-stop"===y.type?(u.isUpdatingInteractively=!1,a()):null!=y.angle&&(u.isUpdatingInteractively=!0,s.attributes[e]=t(y.angle,r))}const d=o;if(i.isSome(c)&&d){const{field:e,getValue:t,initValue:a}=c;"scale-stop"===d.type?(c.isUpdatingInteractively=!1,a()):null!=d.xScale&&(c.isUpdatingInteractively=!0,s.attributes[e]=t(d.xScale,r))}"3d"===r.type&&await V(s),n(t.clone())})),f=a.on(["undo","redo"],(async e=>{const{graphics:[t]}=e;n(t.clone())}));r.map.add(a.layer);const m=()=>{};return{interactive:{remove(){f.remove(),d.remove(),a.cancel(),y&&y.remove(),this.remove=m}},visual:{remove(){l.remove(),r.map.remove(a.layer),a.layer.removeAll(),this.remove=m}}}}const T={icon:s.px2pt(24),text:s.px2pt(12),line:s.px2pt(1),viewScaleSizeFactor:100};t.fetchCandidates=j,t.fetchFullFeature=D,t.findLayerInfo=z,t.getVisualVariableAttributes=h,t.setUpFeatureAdd=F,t.setUpGeometryUpdate=R,t.sizeDefaults=T,Object.defineProperty(t,"__esModule",{value:!0})}));
