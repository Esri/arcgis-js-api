/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["require","exports","../../core/has","../../core/maybe","../../core/promiseUtils","../../layers/support/fieldUtils","../../core/screenUtils","../../chunks/symbols","../../Graphic","../../renderers/support/lengthUtils","../../renderers/visualVariables/support/sizeVariableUtils","../../renderers/visualVariables/support/visualVariableUtils","../../core/accessorSupport/diffUtils","../../views/support/hitTestSelectUtils","../../renderers/support/clickToleranceUtils","../../views/support/drapedUtils","../../symbols/support/symbolUtils"],(function(e,t,a,i,r,n,s,l,o,c,u,p,y,d,f,m,b){"use strict";function h(e){const t=e.layer,a=function(e){switch(e.type){case"class-breaks":case"simple":case"unique-value":case"dot-density":case"dictionary":return!0;default:return!1}}(t.renderer)&&p.getVisualVariableValues(t.renderer,e),i=a?a.map((e=>e.variable)):[],r=i.filter((e=>"rotation"===e.type&&(!e.axis||"heading"===e.axis))),n=r[0],s=1===r.length&&n.field&&!n.valueExpression,l=i.filter((e=>"size"===e.type)),o=l[0],c=1===l.length&&"real-world-size"===u.getTransformationType(o)&&o.field&&!o.useSymbolValue&&!o.valueExpression;return{rotation:s?g(n,t):null,size:c?v(o,t):null}}function g(e,t){const a="heading"===(e.axis||"heading")&&"arithmetic"===e.rotationType?-1:1,i=e.field,n=t.fields&&t.fields.filter((e=>e.name===i)),s=n&&1===n.length?n[0].type:"double",l={initial:0,current:0};return{field:i,getDefault:()=>r.resolve(0),getValue:e=>(l.current=l.initial-a*e,w((l.current+360)%360,s)),initValue:e=>{l.initial=null!=e?e:l.current,l.current=0},isUpdatingInteractively:!1}}function v(t,a){const r=t.field,n=t.axis,s=a.fields&&a.fields.filter((e=>e.name===r)),o=s&&1===s.length?s[0].type:"double",u={updating:!1,initial:0,current:0},p=c.meterIn[t.valueUnit];let y;return y="area"===t.valueRepresentation?e=>Math.pow(e*p/2,2)*Math.PI:"radius"===t.valueRepresentation||"distance"===t.valueRepresentation?e=>e*p/2:e=>e*p,{field:r,getDefault:async(t,a)=>w(y(await async function(t,a,r){if(i.isNone(a))return 0;const{symbol:n}=l.to3D(a);if(i.isNone(n)||"web-style"===n.type)return 0;const s=n.symbolLayers.getItemAt(0);if(!s)return 0;switch(s.type){case"icon":{const{computeIconLayerResourceSize:t}=await new Promise((function(t,a){e(["../../symbols/support/symbolLayerUtils"],t,a)}));return s.size||Math.min(U.icon,(await t(s,U.icon))[0])||U.icon}case"text":return s.size||U.text;case"line":return s.size||U.line;case"object":{const{computeObjectLayerResourceSize:a}=await new Promise((function(t,a){e(["../../symbols/support/symbolLayerUtils"],t,a)}));return function(e,t){switch(t){case"width":return e[0];case"depth":return e[1];case"height":return e[2];default:return e[2]||e[1]||e[0]}}(await a(s,t.scale/U.viewScaleSizeFactor),r)}case"path":case"extrude":return s.size||t.scale/U.viewScaleSizeFactor;case"fill":case"water":default:return 0}}(a,t,n)),o),getValue:(e,t)=>(u.initial||(u.initial=t.pixelSizeAt(t.center)),u.current=u.initial*e,w(u.current,o)),initValue:e=>{u.initial=null!=e?e:u.current,u.current=0},isUpdatingInteractively:!1}}function w(e,t){switch(t){case"small-integer":case"integer":case"long":return Math.round(e);case"double":case"single":return e;default:return 0}}async function S(e){const t=await b.getDisplayedSymbol(e,{ignoreGraphicSymbol:!0}),a=y.diff(e.symbol,t);i.isSome(a)&&(e.symbol=t)}async function I(e,t,a,i){if(0===e.length)return[];const{updatable:s,graphicsByLayer:l}=await a.async((async()=>{const{results:n}=await r.whenOrAbort(d.hitTestSelectSameDistance(t,a),i),s=new Map;n.forEach((({graphic:e})=>(({layer:e})=>{const t=s.get(e);if(!t){const t=new Array;return s.set(e,t),t}return t})(e).push(e)));const l=e.filter((({supports:e,layer:t})=>e.indexOf("update")>-1&&s.has(t)));return 0!==l.length&&a.stopPropagation(),{updatable:l,graphicsByLayer:s}}));return r.eachAlways(s.map((async({layer:e})=>{const{objectIdField:t,displayField:a}=e,r=[t];n.hasField(e.fields,a)&&r.push(a);const s=l.get(e);if(!!s.some((e=>r.some((t=>!(t in e.attributes)))))){const t=e.createQuery();return t.outFields=r,t.returnGeometry=!1,t.objectIds=s.map((e=>e.getObjectId())),e.queryFeatures(t,{signal:i}).then((({features:e})=>e))}return s})),i)}const U={icon:s.px2pt(24),text:s.px2pt(12),line:s.px2pt(1),viewScaleSizeFactor:100};t.fetchCandidates=async function(e,t,a,i){switch(t.type){case"3d":return I(e,t,a,i);case"2d":return async function(e,t,a,i){if(0===e.length)return[];const{results:s}=await r.whenOrAbort(t.hitTest(a),i);if(0===s.length)return[];const l=new Set;return s.forEach((({graphic:e})=>l.add(e.layer))),r.eachAlways(e.items.filter((({layer:e,supports:t})=>t.indexOf("update")>-1&&l.has(e))).map((({layer:e})=>{const{objectIdField:r,displayField:s}=e,l=[r];n.hasField(e.fields,s)&&l.push(s);const o=e.createQuery();o.outFields=l,o.returnGeometry=!1;const c=f.calculateTolerance({renderer:e.renderer,event:a});return o.geometry=m.createQueryGeometry(a.mapPoint,c,t),e.queryFeatures(o,{signal:i}).then((({features:e})=>e))})),i)}(e,t,a,i)}},t.fetchFullFeature=async function(e,t,a){const i=e.layer,r=i.createQuery();return r.objectIds=[e.getAttribute(i.objectIdField)],r.outFields=["*"],r.outSpatialReference=t.spatialReference,r.returnM=i.capabilities.data.supportsM,r.returnZ=i.capabilities.data.supportsZ,(await i.queryFeatures(r,{signal:a})).features[0]},t.findLayerInfo=function(e,t){return e&&e.find((e=>e.layer===t))},t.getVisualVariableAttributes=h,t.setUpFeatureAdd=async function(e,t,a,r){const n=t.layer;await async function(e,t,a){var r;if("3d"!==a.type)return;const n=t.layer,s={...t.template.prototype.attributes},l=new o({layer:n,sourceLayer:n,attributes:s}),{rotation:c,size:u}=h(l);let p=await b.getDisplayedSymbol(l),y=!1;for(const e of[u,c]){if(i.isNone(e))continue;null==s[e.field]&&(s[e.field]=await e.getDefault(p,a),y=!0)}y&&(p=await b.getDisplayedSymbol(l));switch(null==(r=p)?void 0:r.type){case"simple-fill":case"polygon-3d":e.polygonSymbol=p;break;case"simple-line":case"line-3d":e.polylineSymbol=p;break;case"simple-marker":case"point-3d":e.pointSymbol=p}}(e,t,a),e.layer.elevationInfo=n.elevationInfo;const s=()=>e.create(n.geometryType,{hasZ:n.capabilities.data.supportsZ});await s();const l=e.on("create",(async a=>{const{state:i,graphic:l}=a;if("cancel"!==i){if("complete"===i){const a=l.clone();a.attributes={...t.template.prototype.attributes},a.layer=n,e.layer.remove(l),await S(a),r(a)}}else s()}));return a.map.add(e.layer),{remove:()=>{l.remove(),a.map.remove(e.layer),e.cancel()}}},t.setUpGeometryUpdate=async function(e,t,a,r,n){const s=e.clone();await S(s),a.layer.add(s),s.sourceLayer=e.layer;const l=(()=>{const{layer:t}=e;if("graphics"===t.type)return{remove(){}};const{objectIdField:a}=t,i=e.attributes[a],n=r.whenLayerView(t);return n.then((e=>e.setVisibility(i,!1)),(()=>{})),{remove(){n.then((e=>e.setVisibility(i,!0)),(()=>{}))}}})(),o=e.layer,c=t.size,u=t.rotation,p={multipleSelectionEnabled:!1};"point"===o.geometryType&&(p.enableRotation=!!u,p.enableScaling=!!c),a.layer.elevationInfo=o.elevationInfo,a.update(s,p);const y=(i.isSome(c)||i.isSome(u))&&e.watch("attributes",(async e=>{let t=!1;for(const a in e){const r=e[a];r!==s.attributes[a]&&(s.setAttribute(a,r),t=!0,i.isSome(c)&&!c.isUpdatingInteractively&&c.field===a&&c.initValue(r),i.isSome(u)&&!u.isUpdatingInteractively&&u.field===a&&u.initValue(r))}t&&"3d"===r.type&&await S(s)}));[u,c].forEach((async t=>{if(i.isNone(t))return;const a=e.attributes[t.field];if(null!=a)t.initValue(a);else{const e=await t.getDefault(s.symbol,r);t.initValue(e),s.setAttribute(t.field,e),"3d"===r.type&&await S(s)}}));const d=a.on("update",(async e=>{const{graphics:[t],state:l,toolEventInfo:o}=e;if("complete"===l)return void a.update(t,p);const y=o;if(i.isSome(u)&&y){const{field:e,getValue:t,initValue:a}=u;"rotate-stop"===y.type?(u.isUpdatingInteractively=!1,a()):null!=y.angle&&(u.isUpdatingInteractively=!0,s.attributes[e]=t(y.angle/Math.PI*180,r))}const d=o;if(i.isSome(c)&&d){const{field:e,getValue:t,initValue:a}=c;"scale-stop"===d.type?(c.isUpdatingInteractively=!1,a()):null!=d.xScale&&(c.isUpdatingInteractively=!0,s.attributes[e]=t(d.xScale,r))}"3d"===r.type&&await S(s),n(t.clone())}));r.map.add(a.layer);const f=()=>{};return{interactive:{remove(){d.remove(),a.cancel(),y&&y.remove(),this.remove=f}},visual:{remove(){l.remove(),r.map.remove(a.layer),a.layer.removeAll(),this.remove=f}}}},t.sizeDefaults=U,Object.defineProperty(t,"__esModule",{value:!0})}));
