/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["require","exports","../../chunks/_rollupPluginBabelHelpers","../../Graphic","../../core/has","../../core/maybe","../../core/promiseUtils","../../core/screenUtils","../../core/watchUtils","../../core/accessorSupport/diffUtils","../../renderers/support/clickToleranceUtils","../../renderers/support/lengthUtils","../../renderers/visualVariables/support/sizeVariableUtils","../../renderers/visualVariables/support/visualVariableUtils","../../symbols/support/symbolConversion","../../symbols/support/symbolUtils","../../views/3d/layers/graphics/GraphicState","../../views/support/drapedUtils","../../views/support/hitTestSelectUtils"],(function(e,t,n,r,i,a,s,o,l,u,c,p,y,f,d,h,m,b,g){"use strict";function v(e){const t=e.sourceLayer,n=U(t.renderer)&&f.getVisualVariableValues(t.renderer,e),r=n?n.map((e=>e.variable)):[],i=r.filter((e=>"rotation"===e.type&&(!e.axis||"heading"===e.axis))),a=i[0],s=1===i.length&&a.field&&!a.valueExpression,o=r.filter((e=>"size"===e.type)),l=o[0],u=1===o.length&&"real-world-size"===y.getTransformationType(l)&&l.field&&!l.useSymbolValue&&!l.valueExpression;return{rotation:s?w(a,t):null,size:u?I(l,t):null}}function w(e,t){const n="heading"===(e.axis||"heading")&&"arithmetic"===e.rotationType?-1:1,r=e.field,i=t.fields&&t.fields.filter((e=>e.name===r)),a=i&&1===i.length?i[0].type:"double",s={initial:0,current:0};return{field:r,getDefault:()=>Promise.resolve(0),getValue:e=>(s.current=s.initial-n*e,V((s.current+360)%360,a)),initValue:e=>{s.initial=null!=e?e:s.current,s.current=0},isUpdatingInteractively:!1}}function S(e,t){switch(t){case"width":return e[0];case"depth":return e[1];case"height":return e[2];default:return e[2]||e[1]||e[0]}}function T(e,t,n){return G.apply(this,arguments)}function G(){return(G=n._asyncToGenerator((function*(t,n,r){if(a.isNone(n))return 0;const{symbol:i}=d.to3D(n);if(a.isNone(i)||"web-style"===i.type)return 0;const s=i.symbolLayers.getItemAt(0);if(!s)return 0;switch(s.type){case"icon":{const{computeIconLayerResourceSize:t}=yield new Promise((function(t,n){e(["../../symbols/support/symbolLayerUtils"],t,n)}));return s.size||Math.min($.icon,(yield t(s,$.icon))[0])||$.icon}case"text":return s.size||$.text;case"line":return s.size||$.line;case"object":{const{computeObjectLayerResourceSize:n}=yield new Promise((function(t,n){e(["../../symbols/support/symbolLayerUtils"],t,n)}));return S(yield n(s,t.scale/$.viewScaleSizeFactor),r)}case"path":case"extrude":return s.size||t.scale/$.viewScaleSizeFactor;case"fill":case"water":default:return 0}}))).apply(this,arguments)}function I(e,t){const r=e.field,i=e.axis,a=t.fields&&t.fields.filter((e=>e.name===r)),s=a&&1===a.length?a[0].type:"double",o={updating:!1,initial:0,current:0},l=p.meterIn[e.valueUnit];let u;return u="area"===e.valueRepresentation?e=>(e*l/2)**2*Math.PI:"radius"===e.valueRepresentation||"distance"===e.valueRepresentation?e=>e*l/2:e=>e*l,{field:r,getDefault:(c=n._asyncToGenerator((function*(e,t){return V(u(yield T(t,e,i)),s)})),function(e,t){return c.apply(this,arguments)}),getValue:(e,t)=>(o.initial||(o.initial=t.pixelSizeAt(t.center)),o.current=o.initial*e,V(o.current,s)),initValue:e=>{o.initial=null!=e?e:o.current,o.current=0},isUpdatingInteractively:!1};var c}function V(e,t){switch(t){case"small-integer":case"integer":case"long":return Math.round(e);case"double":case"single":return e;default:return 0}}function U(e){switch(e.type){case"class-breaks":case"simple":case"unique-value":case"dot-density":case"dictionary":return!0;default:return!1}}function _(e){return F.apply(this,arguments)}function F(){return(F=n._asyncToGenerator((function*(e){const t=yield h.getDisplayedSymbol(e,{useSourceLayer:!0,ignoreGraphicSymbol:!0}),n=u.diff(e.symbol,t);a.isSome(n)&&(e.symbol=t)}))).apply(this,arguments)}function x(e){if("mesh"===e||"multipatch"===e)throw new Error("Mesh and Multipatch not supported");return e}function z(e,t,n){return L.apply(this,arguments)}function L(){return(L=n._asyncToGenerator((function*(e,t,r){yield M(e,t);const i=e.on("create",function(){var i=n._asyncToGenerator((function*(n){if("cancel"===n.state)return M(e,t);if("complete"===n.state){const e=n.graphic;e.sourceLayer||(e.sourceLayer=t.layer),e.attributes||(e.attributes={...t.template.prototype.attributes}),yield _(e),r(e)}}));return function(e){return i.apply(this,arguments)}}());return{remove:()=>{i.remove(),e.cancel()}}}))).apply(this,arguments)}function M(e,t){return A.apply(this,arguments)}function A(){return(A=n._asyncToGenerator((function*(e,t){const n=t.layer,r={...t.template.prototype.attributes};yield O(e,n,r);const i={graphicProperties:{attributes:r,sourceLayer:n},hasZ:n.capabilities.data.supportsZ};e.layer.elevationInfo=n.elevationInfo,e.create(x(n.geometryType),i)}))).apply(this,arguments)}function O(e,t,n){return R.apply(this,arguments)}function R(){return(R=n._asyncToGenerator((function*(e,t,n){var i;if("3d"!==e.view.type)return;const s=new r({sourceLayer:t,attributes:n}),{rotation:o,size:l}=v(s);let u=yield h.getDisplayedSymbol(s,{useSourceLayer:!0}),c=!1;for(const r of[l,o]){if(a.isNone(r))continue;null==n[r.field]&&(n[r.field]=yield r.getDefault(u,e.view),c=!0)}switch(c&&(u=yield h.getDisplayedSymbol(s,{useSourceLayer:!0})),null==(i=u)?void 0:i.type){case"simple-fill":case"polygon-3d":e.polygonSymbol=u;break;case"simple-line":case"line-3d":e.polylineSymbol=u;break;case"simple-marker":case"point-3d":e.pointSymbol=u}}))).apply(this,arguments)}function j(e,t){return e&&e.find((e=>e.layer===t))}function D(e,t,n,r){return P.apply(this,arguments)}function P(){return(P=n._asyncToGenerator((function*(e,t,r,i){if(0===e.length)return[];const{updatable:a,graphicsByLayer:o}=yield r.async(n._asyncToGenerator((function*(){const{results:n}=yield s.whenOrAbort(g.hitTestSelectSameDistance(t,r),i),a=new Map,o=({layer:e})=>{const t=a.get(e);if(!t){const t=new Array;return a.set(e,t),t}return t};n.forEach((({graphic:e})=>o(e).push(e)));const l=e.filter((({supports:e,layer:t})=>e.indexOf("update")>-1&&a.has(t)));return 0!==l.length&&r.stopPropagation(),{updatable:l,graphicsByLayer:a}})));return s.whenOrAbort(s.eachAlways(a.map(function(){var e=n._asyncToGenerator((function*({layer:e}){const{objectIdField:t,displayField:n}=e,r=[t];e.fieldsIndex.has(n)&&r.push(n);const a=o.get(e);if(!!a.some((e=>r.some((t=>!(t in e.attributes)))))){const t=e.createQuery();return t.outFields=r,t.returnGeometry=!1,t.objectIds=a.map((e=>e.getObjectId())),e.queryFeatures(t,{signal:i}).then((({features:e})=>e))}return a}));return function(t){return e.apply(this,arguments)}}())),i)}))).apply(this,arguments)}function E(e,t,n,r){return k.apply(this,arguments)}function k(){return(k=n._asyncToGenerator((function*(e,t,r,i){if(0===e.length)return[];const a=yield r.async(n._asyncToGenerator((function*(){const{results:n}=yield s.whenOrAbort(t.hitTest(r),i);if(0===n.length)return[];const a=new Set;n.forEach((({graphic:e})=>a.add(e.layer)));const o=e.items.filter((({layer:e,supports:t})=>t.indexOf("update")>-1&&a.has(e)));return o.length>0&&r.stopPropagation(),o})));return s.whenOrAbort(s.eachAlways(a.map((({layer:e})=>{const{objectIdField:n,displayField:a}=e,s=[n];e.fieldsIndex.has(a)&&s.push(a);const o=e.createQuery();o.outFields=s,o.returnGeometry=!1;const l="renderer"in e?c.calculateTolerance({renderer:e.renderer,event:r}):0;return o.geometry=b.createQueryGeometry(r.mapPoint,l,t),o.outSpatialReference=t.spatialReference,e.queryFeatures(o,{signal:i}).then((({features:e})=>e))}))),i)}))).apply(this,arguments)}function q(e,t,n,r){return N.apply(this,arguments)}function N(){return(N=n._asyncToGenerator((function*(e,t,n,r){switch(t.type){case"3d":return D(e,t,n,r);case"2d":return E(e,t,n,r)}}))).apply(this,arguments)}function C(e,t,n){return Q.apply(this,arguments)}function Q(){return(Q=n._asyncToGenerator((function*(e,t,n){const r=e.layer,i=r.createQuery();return i.objectIds=[e.getAttribute(r.objectIdField)],i.outFields=["*"],i.outSpatialReference=t.spatialReference,i.returnM=r.capabilities.data.supportsM,i.returnZ=r.capabilities.data.supportsZ,(yield r.queryFeatures(i,{signal:n})).features[0]}))).apply(this,arguments)}function Z(e,t,n,r){return B.apply(this,arguments)}function B(){return(B=n._asyncToGenerator((function*(e,t,r,i){let s=!1;const{rotation:o,size:l}=i;[o,l].forEach(function(){var r=n._asyncToGenerator((function*(n){if(a.isNone(n))return;const r=t.attributes[n.field];if(a.isSome(r))n.initValue(r);else{const r=yield n.getDefault(t.symbol,e.view);n.initValue(r),t.setAttribute(n.field,r),s=!0}}));return function(e){return r.apply(this,arguments)}}()),s&&"3d"===e.view.type&&(yield _(t));const u={multipleSelectionEnabled:!1};return"point"===r.geometryType&&(u.enableRotation=a.isSome(o),u.enableScaling=a.isSome(l)),e.layer.elevationInfo=r.elevationInfo,e.update(t,u)}))).apply(this,arguments)}function W(e){return!e||"rotate-start"!==e.type&&"rotate"!==e.type&&"rotate-stop"!==e.type?null:e}function H(e){return!e||"scale-start"!==e.type&&"scale"!==e.type&&"scale-stop"!==e.type?null:e}function J(e,t,n,r){return K.apply(this,arguments)}function K(){return(K=n._asyncToGenerator((function*(e,t,n,r){var i;if(!a.isSome(t.geometry)||"point"!==(null==(i=t.geometry)?void 0:i.type))return;const s=r.rotation,o=W(n.toolEventInfo);if(a.isSome(s)&&a.isSome(o))if("rotate-stop"===o.type)s.isUpdatingInteractively=!1,s.initValue();else{s.isUpdatingInteractively=!0;const{field:n,getValue:r}=s;t.attributes[n]=r(o.angle,e)}const l=r.size,u=H(n.toolEventInfo);if(a.isSome(l)&&a.isSome(u))if("scale-stop"===u.type)l.isUpdatingInteractively=!1,l.initValue();else{l.isUpdatingInteractively=!0;const{field:n,getValue:r}=l;t.attributes[n]=r(u.xScale,e)}"3d"===e.type&&(yield _(t))}))).apply(this,arguments)}function X(e,t,n,r,i){return Y.apply(this,arguments)}function Y(){return(Y=n._asyncToGenerator((function*(e,t,r,i,s){const o=e.clone();yield _(o),r.layer.add(o);const u=e.sourceLayer,c=i.whenLayerView(u),p=()=>{const t=e.layer,n=e.attributes[t.objectIdField];return c.then((e=>e.setVisibility(n,!1)),(()=>{})),{remove(){c.then((e=>e.setVisibility(n,!0)),(()=>{}))}}};let y=null,f=null;if("3d"===i.type){const e=new m.GraphicState({graphic:o});y=i.trackGraphicState(e),l.init(e,"displaying",(e=>{f=e?p():a.removeMaybe(f)}))}else f=p();Z(r,o,u,t);let d=null;c.then((e=>d=e),(()=>{}));const h=t.size,b=t.rotation,g=e.watch("attributes",function(){var e=n._asyncToGenerator((function*(e){let t=!1;for(const n in e){const r=e[n];r!==o.attributes[n]&&(o.setAttribute(n,r),a.isSome(h)&&!h.isUpdatingInteractively&&h.field===n&&h.initValue(r),a.isSome(b)&&!b.isUpdatingInteractively&&b.field===n&&b.initValue(r),(a.isNone(d)||d.requiredFields.includes(n))&&(t=!0))}t&&"3d"===i.type&&(yield _(o))}));return function(t){return e.apply(this,arguments)}}()),v=r.on("update",function(){var e=n._asyncToGenerator((function*(e){const n=e.graphics[0];if("complete"===e.state)return Z(r,n,u,t);yield J(i,n,e,t),s(n.clone())}));return function(t){return e.apply(this,arguments)}}()),w=r.on(["undo","redo"],function(){var e=n._asyncToGenerator((function*(e){s(e.graphics[0].clone())}));return function(t){return e.apply(this,arguments)}}());i.map.add(r.layer);const S=()=>{};return{interactive:{remove(){w.remove(),v.remove(),r.cancel(),g&&g.remove(),this.remove=S}},visual:{remove(){a.removeMaybe(f),i.whenLayerView(u).then((e=>l.whenFalseOnce(e,"updating"))).then((()=>{a.removeMaybe(y),r.layer.remove(o),this.remove=S}))}}}}))).apply(this,arguments)}const $={icon:o.px2pt(24),text:o.px2pt(12),line:o.px2pt(1),viewScaleSizeFactor:100};function ee(e,t,n){let r=!1;return e.filter((e=>!!r||(r=e===t,r))).map((e=>n[e]()))}function te(e){if(1!==e.length)return null;const t=e[0];if("items"in t){const e=t;return 1===e.items.length?e.items[0]:null}return t}function ne(e,t){if(e.viewModel.refreshCreationTemplates(),"awaiting-feature-creation-info"===t[0].id){const n=te(e.viewModel.featureTemplatesViewModel.items);a.isSome(n)&&(e.creationInfo={layer:n.layer,template:n.template},t.shift())}return t}t.avoidFeatureTemplateSelectionWithOnlyOneItem=ne,t.createWorkflowSteps=ee,t.fetchCandidates=q,t.fetchFullFeature=C,t.findLayerInfo=j,t.getVisualVariableAttributes=v,t.setUpFeatureAdd=z,t.setUpGeometryUpdate=X,t.sizeDefaults=$,t.startCreatingNewFeature=M,t.startUpdatingFeature=Z,t.updateGraphicSymbolWhenRequired=_,t.visualVariableInteractiveUpdate=J,Object.defineProperty(t,"__esModule",{value:!0})}));
