/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["require","exports","../../chunks/_rollupPluginBabelHelpers","../../Graphic","../../core/has","../../core/handleUtils","../../core/maybe","../../core/promiseUtils","../../core/reactiveUtils","../../core/screenUtils","../../core/accessorSupport/diffUtils","../../renderers/support/clickToleranceUtils","../../renderers/support/lengthUtils","../../renderers/visualVariables/support/sizeVariableUtils","../../renderers/visualVariables/support/visualVariableUtils","../../symbols/support/symbolConversion","../../symbols/support/symbolUtils","../../views/3d/layers/graphics/GraphicState","../../views/support/drapedUtils","../../views/support/hitTestSelectUtils"],(function(e,t,n,r,i,a,s,o,l,u,c,p,y,d,f,h,m,b,g,v){"use strict";function S(e){const t=e.sourceLayer;if(!t||"feature"!==t.type||!F(t.renderer))return{rotation:null,size:null};let n=null,r=null;const i=t.renderer.getVisualVariablesForType("rotation").filter((t=>(!t.axis||"heading"===t.axis)&&t.field&&!t.valueExpression&&s.isSome(f.getRotationAngle(t,e))));1===i.length&&(n=w(i[0],t));const a=t.renderer.getVisualVariablesForType("size").filter((t=>t.field&&!t.useSymbolValue&&!t.valueExpression&&d.getTransformationType(t)===d.TransformationType.RealWorldSize&&s.isSome(f.getSize(t,e))));return 1===a.length&&(r=G(a[0],t)),{rotation:n,size:r}}function w(e,t){const n="heading"===(e.axis||"heading")&&"arithmetic"===e.rotationType?-1:1,r=e.field,i=t.fields&&t.fields.filter((e=>e.name===r)),a=i&&1===i.length?i[0].type:"double",s={initial:0,current:0};return{field:r,fieldType:a,getDefault:()=>Promise.resolve(0),getValue:e=>(s.current=s.initial-n*e,V((s.current+360)%360,a)),initValue:e=>{s.initial=null!=e?e:s.current,s.current=0},isUpdatingInteractively:!1,rotationType:e.rotationType??"geographic"}}function T(e,t){switch(t){case"width":return e[0];case"depth":return e[1];case"height":return e[2];default:return e[2]||e[1]||e[0]}}function I(e,t,n){return U.apply(this,arguments)}function U(){return(U=n._asyncToGenerator((function*(t,n,r){if(s.isNone(n))return 0;const{symbol:i}=h.to3D(n);if(s.isNone(i)||"web-style"===i.type||"cim"===i.type)return 0;const a=i.symbolLayers.getItemAt(0);if(!a)return 0;switch(a.type){case"icon":{const{computeIconLayerResourceSize:t}=yield new Promise(((t,n)=>e(["../../symbols/support/symbolLayerUtils"],t,n)));return a.size||Math.min(te.icon,(yield t(a,te.icon))[0])||te.icon}case"text":return a.size||te.text;case"line":return a.size||te.line;case"object":{const{computeObjectLayerResourceSize:n}=yield new Promise(((t,n)=>e(["../../symbols/support/symbolLayerUtils"],t,n)));return T(yield n(a,t.scale/te.viewScaleSizeFactor),r)}case"path":return(null!=a.width?a.width:a.height)||t.scale/te.viewScaleSizeFactor;case"extrude":return a.size||t.scale/te.viewScaleSizeFactor;default:return 0}}))).apply(this,arguments)}function G(e,t){const r=e.field,i=e.axis,a=t.fields&&t.fields.filter((e=>e.name===r)),s=a&&1===a.length?a[0].type:"double",o={updating:!1,initial:0,current:0},l=y.meterIn[e.valueUnit]??1;let u;return u="area"===e.valueRepresentation?e=>(e*l/2)**2*Math.PI:"radius"===e.valueRepresentation||"distance"===e.valueRepresentation?e=>e*l/2:e=>e*l,{field:r,fieldType:s,getDefault:(c=n._asyncToGenerator((function*(e,t){return V(u(yield I(t,e,i)),s)})),function(e,t){return c.apply(this,arguments)}),getValue:(e,t)=>(o.initial||(o.initial=t.pixelSizeAt(t.center)),o.current=o.initial*e,V(o.current,s)),initValue:e=>{o.initial=null!=e?e:o.current,o.current=0},isUpdatingInteractively:!1,displayUnit:ae(e.valueUnit),axis:e.axis};var c}function V(e,t){switch(t){case"small-integer":case"integer":case"long":return Math.round(e);case"double":case"single":return e;default:return 0}}function F(e){switch(e?.type){case"class-breaks":case"simple":case"unique-value":case"dot-density":case"dictionary":case"pie-chart":return!0;default:return!1}}function z(e,t){return x.apply(this,arguments)}function x(){return(x=n._asyncToGenerator((function*(e,t){const n=yield m.getDisplayedSymbol(e,{useSourceLayer:!0,ignoreGraphicSymbol:!0,webStyleCache:t}),r=c.diff(e.symbol,n);s.isSome(r)&&(e.symbol=n)}))).apply(this,arguments)}function _(e){if(!e)throw new Error("no geometry type");if("mesh"===e||"multipatch"===e)throw new Error("Mesh and Multipatch not supported");return e}function L(e,t,n,r){return A.apply(this,arguments)}function A(){return A=n._asyncToGenerator((function*(e,t,r,i){yield E(e,t,i);const a=e.on("create",function(){var a=n._asyncToGenerator((function*(n){if("cancel"===n.state)return E(e,t,i);if("complete"===n.state){const e=n.graphic;e.sourceLayer||(e.sourceLayer=t.layer),e.attributes||(e.attributes={...t.template.prototype.attributes}),yield z(e,i),r(e)}}));return function(e){return a.apply(this,arguments)}}());return{remove:()=>{a.remove(),e.cancel()}}})),A.apply(this,arguments)}function E(e,t,n){return O.apply(this,arguments)}function O(){return(O=n._asyncToGenerator((function*(e,t,n){const r=t.layer,i={...t.template.prototype.attributes};yield M(e,r,i,n);const a={graphicProperties:{attributes:i,sourceLayer:r},hasZ:r.capabilities.data.supportsZ};return e.layer.elevationInfo=r.elevationInfo,e.create(_(r.geometryType),a)}))).apply(this,arguments)}function M(e,t,n,r){return R.apply(this,arguments)}function R(){return(R=n._asyncToGenerator((function*(e,t,n,i){const a=new r({sourceLayer:t,attributes:n}),{rotation:o,size:l}=S(a);let u=yield m.getDisplayedSymbol(a,{useSourceLayer:!0,webStyleCache:i}),c=!1;for(const r of[l,o]){if(s.isNone(r))continue;null==n[r.field]&&(n[r.field]=yield r.getDefault(u,e.view),c=!0)}switch(c&&(u=yield m.getDisplayedSymbol(a,{useSourceLayer:!0,webStyleCache:i})),u?.type){case"simple-fill":case"polygon-3d":e.polygonSymbol=u;break;case"simple-line":case"line-3d":e.polylineSymbol=u;break;case"simple-marker":case"picture-marker":case"point-3d":case"cim":e.pointSymbol=u}j(e.tooltipOptions,l,o)}))).apply(this,arguments)}function j(e,t,n){s.isSome(t)||s.isSome(n)?e.visualVariables={size:s.isSome(t)?{unit:t.displayUnit,axis:t.axis,valueType:t.fieldType}:null,rotation:s.isSome(n)?{valueType:n.fieldType,rotationType:n.rotationType??"geographic"}:null}:e.visualVariables=null}function k(e,t){return e?e.find((e=>e.layer===t)):void 0}function C(e,t,n,r){return D.apply(this,arguments)}function D(){return D=n._asyncToGenerator((function*(e,t,r,i){if(0===e.length)return[];const{updatable:a,graphicsByLayer:s}=yield r.async(n._asyncToGenerator((function*(){const{results:n}=yield o.whenOrAbort(v.hitTestSelectSimilarDistance(t,r),i),a=new Map,s=e=>{const t=e.layer,n=a.get(t);if(!n){const e=new Array;return a.set(t,e),e}return n};v.filterGraphicHits(n).forEach((({graphic:e})=>s(e).push(e)));const l=e.filter((({supports:e,layer:t})=>e.includes("update")&&a.has(t)));return 0!==l.length&&r.stopPropagation(),{updatable:l,graphicsByLayer:a}})));return o.whenOrAbort(o.eachAlways(a.map(function(){var e=n._asyncToGenerator((function*({layer:e}){const{objectIdField:t}=e,n="displayField"in e?e.displayField:null,r=[t];null!=n&&e.fieldsIndex.has(n)&&r.push(n);const a=s.get(e);if(!!a.some((e=>r.some((t=>!(t in e.attributes)))))){const t=e.createQuery();return t.outFields=r,t.returnGeometry=!1,t.objectIds=a.map((e=>e.getObjectId())),e.queryFeatures(t,{signal:i}).then((({features:e})=>e))}return a}));return function(t){return e.apply(this,arguments)}}())),i)})),D.apply(this,arguments)}function P(e,t,n,r){return q.apply(this,arguments)}function q(){return(q=n._asyncToGenerator((function*(e,t,r,i){if(0===e.length)return[];let a=null;const s=yield r.async(n._asyncToGenerator((function*(){const{results:n}=yield o.whenOrAbort(t.hitTest(r),i);if(0===n.length)return[];const s=new Set;a=v.filterGraphicHits(n),a.forEach((({graphic:e})=>e&&s.add(e.layer)));const l=e.items.filter((({layer:e,supports:t,attachmentsOnUpdateEnabled:n})=>s.has(e)&&(t.includes("update")||t.includes("delete")||n)));return l.length>0&&r.stopPropagation(),l})));return o.whenOrAbort(o.eachAlways(s.map((({layer:e})=>{const n=e.objectIdField,s="displayField"in e?e.displayField:null,o=[n];null!=s&&e.fieldsIndex.has(s)&&o.push(s);const l=e.createQuery();l.outFields=o,l.returnGeometry=!1;const u="renderer"in e?p.calculateTolerance({renderer:e.renderer,event:r}):0;return l.geometry=g.createQueryGeometry(r.mapPoint,u,t),l.outSpatialReference=t.spatialReference,e.queryFeatures(l,{signal:i}).then((({features:t})=>(a?.forEach((({graphic:n})=>{n.layer!==e||t.some((e=>e.getObjectId()===n.getObjectId()))||t.push(n)})),t)))}))),i)}))).apply(this,arguments)}function N(e,t,n,r){return W.apply(this,arguments)}function W(){return(W=n._asyncToGenerator((function*(e,t,n,r){switch(t.type){case"3d":return C(e,t,n,r);case"2d":return P(e,t,n,r)}}))).apply(this,arguments)}function Q(e,t,n){return Z.apply(this,arguments)}function Z(){return(Z=n._asyncToGenerator((function*(e,t,n){const{sourceLayer:r}=e,i=r.createQuery();return i.objectIds=[e.getAttribute(r.objectIdField)],i.outFields=["*"],i.outSpatialReference=t.spatialReference,i.returnM=r.capabilities.data.supportsM,i.returnZ=r.capabilities.data.supportsZ,(yield r.queryFeatures(i,{signal:n})).features[0]}))).apply(this,arguments)}function B(e,t,n,r,i){return H.apply(this,arguments)}function H(){return H=n._asyncToGenerator((function*(e,t,r,i,a){let o=!1;const{rotation:l,size:u}=i;[l,u].forEach(function(){var r=n._asyncToGenerator((function*(n){if(s.isNone(n))return;const r=t.attributes[n.field];if(s.isSome(r))n.initValue(r);else{const r=yield n.getDefault(t.symbol,e.view);n.initValue(r),t.setAttribute(n.field,r),o=!0}}));return function(e){return r.apply(this,arguments)}}()),o&&(yield z(t,a));const c={multipleSelectionEnabled:!1};return"point"===r.geometryType&&(c.enableRotation=s.isSome(l),c.enableScaling=s.isSome(u)),j(e.tooltipOptions,u,l),e.layer.elevationInfo=r.elevationInfo,e.update(t,c)})),H.apply(this,arguments)}function J(e){return!s.isSome(e)||"rotate-start"!==e.type&&"rotate"!==e.type&&"rotate-stop"!==e.type?null:e}function K(e){return!s.isSome(e)||"scale-start"!==e.type&&"scale"!==e.type&&"scale-stop"!==e.type?null:e}function X(e,t,n,r,i){return Y.apply(this,arguments)}function Y(){return(Y=n._asyncToGenerator((function*(e,t,n,r,i){if(!s.isSome(t.geometry)||"point"!==t.geometry?.type)return;const a=r.rotation,o=J(n.toolEventInfo);if(s.isSome(a)&&s.isSome(o))if("rotate-stop"===o.type)a.isUpdatingInteractively=!1,a.initValue();else{a.isUpdatingInteractively=!0;const{field:n,getValue:r}=a;t.attributes[n]=r(o.angle,e)}const l=r.size,u=K(n.toolEventInfo);if(s.isSome(l)&&s.isSome(u))if("scale-stop"===u.type)l.isUpdatingInteractively=!1,l.initValue();else{l.isUpdatingInteractively=!0;const{field:n,getValue:r}=l;t.attributes[n]=r(u.xScale,e)}yield z(t,i)}))).apply(this,arguments)}function $(e,t,n,r,i,a){return ee.apply(this,arguments)}function ee(){return ee=n._asyncToGenerator((function*(e,t,r,i,o,u){const c=e.clone();yield z(c,u),i.map.add(r.layer),r.layer.add(c);const p=e.sourceLayer,y=ue(i,p),d=()=>{const t=e.layer,n=e.attributes[t.objectIdField];return y.then((e=>e.setVisibility?.(n,!1)),(()=>{})),{remove(){y.then((e=>e.setVisibility?.(n,!0)),(()=>{}))}}};let f=null,h=null;if("3d"===i.type){const e=new b.GraphicState({graphic:c});f=a.handlesGroup([i.trackGraphicState(e),l.watch((()=>e.displaying),(e=>{h=e?d():s.removeMaybe(h)}),l.initial)])}else h=d();yield B(r,c,p,t,u);let m=null;y.then((e=>m=e),(()=>{}));const g=t.size,v=t.rotation,S=l.watch((()=>e.attributes),function(){var e=n._asyncToGenerator((function*(e){let t=!1;for(const n in e){const r=e[n];r!==c.attributes[n]&&(c.setAttribute(n,r),s.isSome(g)&&!g.isUpdatingInteractively&&g.field===n&&g.initValue(r),s.isSome(v)&&!v.isUpdatingInteractively&&v.field===n&&v.initValue(r),(s.isNone(m)||m.requiredFields.includes(n))&&(t=!0))}t&&(yield z(c,u))}));return function(t){return e.apply(this,arguments)}}()),w=r.on("update",function(){var e=n._asyncToGenerator((function*(e){const n=e.graphics[0];if("complete"===e.state)return B(r,n,p,t,u);yield X(i,n,e,t,u),o(n.clone(),e)}));return function(t){return e.apply(this,arguments)}}()),T=r.on(["undo","redo"],function(){var e=n._asyncToGenerator((function*(e){o(e.graphics[0].clone(),e)}));return function(t){return e.apply(this,arguments)}}()),I=()=>{};return{interactive:{remove(){T.remove(),w.remove(),r.cancel(),S&&S.remove(),this.remove=I}},visual:{remove(){s.removeMaybe(h),ue(i,p).then((e=>l.whenOnce((()=>!e.updating)))).then((()=>{s.removeMaybe(f),r.layer.remove(c),this.remove=I}))}}}})),ee.apply(this,arguments)}const te={icon:u.px2pt(24),text:u.px2pt(12),line:u.px2pt(1),viewScaleSizeFactor:100};function ne(e,t,n){let r=!1;return e.filter((e=>!!r||(r=e===t,r))).map((e=>n[e]()))}function re(e){if(1!==e.length)return null;const t=e[0];if("items"in t){const e=t;return 1===e.items.length?e.items[0]:null}return t}function ie(e,t){if(e.viewModel.refreshCreationTemplates(),"awaiting-feature-creation-info"===t[0].id){const n=re(e.viewModel.featureTemplatesViewModel.items);s.isSome(n)&&(e.creationInfo=n,t.shift())}return t}function ae(e){switch(e){case"unknown":case"decimal-degrees":return null;default:return e}}function se(e){e.set({abilities:{editing:!0,operations:{add:!0,update:!0,delete:!0}},filesEnabled:!0,mode:"view"})}function oe(e){const{creationInfo:{layer:t},viewModel:n}=e,r=n.editableItems.find((e=>e.layer===t));if(r)return r.attachmentsOnCreateEnabled;const i=t.capabilities?.data,a=n.layerInfos?.find((e=>e.layer===t));return!(!(i&&"supportsAttachment"in i&&i.supportsAttachment)||a&&(!1===a.allowAttachments||!1===a.attachmentsOnUpdateEnabled))}const le=e=>/-stop/.test(e)||/vertex-/.test(e),ue=(e,t)=>{const n="subtype-sublayer"===t.type?t.parent:t;return e.whenLayerView(n)};t.avoidFeatureTemplateSelectionWithOnlyOneItem=ie,t.createWorkflowSteps=ne,t.fetchCandidates=N,t.fetchFullFeature=Q,t.findLayerInfo=k,t.getVisualVariableAttributes=S,t.isTerminalUpdateEventType=le,t.prepareAttachmentsForCreateWorkflow=se,t.setUpFeatureAdd=L,t.setUpGeometryUpdate=$,t.shouldShowAttachmentsForCreateWorkflow=oe,t.sizeDefaults=te,t.sizeVariableUnitToLengthUnit=ae,t.startCreatingNewFeature=E,t.startUpdatingFeature=B,t.updateGraphicSymbolWhenRequired=z,t.visualVariableInteractiveUpdate=X,t.whenEditorLayerView=ue,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
