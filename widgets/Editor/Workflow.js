/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/has","../../core/Logger","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/subclass","../../core/Error","../../core/urlUtils","../../core/uuid","../../portal/support/resourceExtension","../../core/promiseUtils","../../core/Evented","../../core/HandleOwner"],(function(t,e,s,i,o,r,n,a,p,c,d,h,l,_){"use strict";let u=function(e){function s(t){var s;return(s=e.call(this,t)||this)._indexHistory=[],s._lastStepIndex=-1,s._stepIndex=-1,s._handleKeys={afterCommit:"after-commit",beforeCommit:"before-commit"},s.data=null,s.started=!1,s.steps=null,s.type=null,s}t._inheritsLoose(s,e);var i=s.prototype;return i.cancel=async function(t={force:!0}){return!1!==t.force?this._cancel():h.create(((t,e)=>{this.emit("cancel-request",{controller:{allow:()=>{this._cancel().then(t)},deny:()=>e(new a("workflow:cancel-denied","Request to cancel workflow was denied."))}})}))},i.commit=async function(){const{data:t}=this;this.handles.remove(this._handleKeys.beforeCommit);const e=t.edits.feature,s=e.clone();if(!t.edits.attributesModified){const{objectIdField:t}=e.layer;s.attributes={[t]:e.getAttribute(t)}}t.edits.geometryModified||(s.geometry=null),await this.afterCommit(s),this.handles.remove(this._handleKeys.afterCommit),this.emit("commit");this.started&&await this.reset()},i.go=async function(t){const{steps:e}=this,s=e.findIndex((e=>e.id===t));this._indexHistory.push(this._stepIndex),await this._go(s)},i.next=async function(){this._indexHistory.push(this._stepIndex),await this._go(this._stepIndex+1)},i.previous=async function(){await this._go(this._indexHistory.pop())},i.reset=async function(){await this._cancel(!1),await this.start()},i.start=async function(){this._set("started",!0);const t=-1===this._stepIndex?0:this._stepIndex;await this._go(t)},i._cancel=async function(t=!0){this.started&&(this._set("started",!1),await this.steps[this._stepIndex].tearDown()),this.handles.remove([this._handleKeys.afterCommit,this._handleKeys.beforeCommit]),this._resetIndexing(t),t&&this.emit("cancel")},i._go=async function(t=-1){if(!(t<=-1||t>=this.steps.length)){if(!this.started)return this._stepIndex=t,void this._notifyStepProps();this._lastStepIndex>-1&&await this.steps[this._lastStepIndex].tearDown(),await this.steps[t].setUp(),this._lastStepIndex=t,this._stepIndex=t,this._notifyStepProps()}},i._resetIndexing=function(t=!0){this._stepIndex=-1,this._lastStepIndex=-1,this._indexHistory.length=0,t&&this._notifyStepProps()},i._notifyStepProps=function(){this.notifyChange("stepId"),this.notifyChange("hasPreviousStep"),this.notifyChange("hasNextStep")},t._createClass(s,[{key:"hasNextStep",get:function(){const{steps:t}=this;return!!(t&&this._stepIndex<t.filter((t=>!t.parent)).length-1)}},{key:"hasPreviousStep",get:function(){return this._stepIndex>0}},{key:"stepId",get:function(){const{steps:t}=this,e=t&&t[this._stepIndex];return e&&e.id}}]),s}(_.HandleOwnerMixin(l.EventedAccessor));return e.__decorate([r.property()],u.prototype,"afterCommit",void 0),e.__decorate([r.property()],u.prototype,"data",void 0),e.__decorate([r.property()],u.prototype,"hasNextStep",null),e.__decorate([r.property()],u.prototype,"hasPreviousStep",null),e.__decorate([r.property()],u.prototype,"started",void 0),e.__decorate([r.property({readOnly:!0,dependsOn:["steps"]})],u.prototype,"stepId",null),e.__decorate([r.property()],u.prototype,"steps",void 0),e.__decorate([r.property()],u.prototype,"type",void 0),e.__decorate([r.property()],u.prototype,"commit",null),u=e.__decorate([n.subclass("esri.widgets.Editor.Workflow")],u),u}));
