/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/maybe","../../core/accessorSupport/decorators/property","../../core/has","../../core/accessorSupport/ensureType","../../core/Logger","../../core/accessorSupport/decorators/subclass","./CreateWorkflowData","./Edits","./Workflow","./workflowUtils"],(function(e,t,r,a,o,i,n,s,l,u,c,d){"use strict";var f;let w=f=function(t){function a(e){var r;return(r=t.call(this,e)||this).type="create",r}return e._inheritsLoose(a,t),a.create=function(t,r,a){const o=new f({data:new l({edits:new u.Edits,viewModel:t}),onCommit:(i=e._asyncToGenerator((function*(e){yield a(e.creationInfo.layer,{addFeatures:[e.edits.feature]})})),function(e){return i.apply(this,arguments)})});var i;return o._set("steps",this._createWorkflowSteps(o,r)),o},a._createWorkflowSteps=function(t,a="awaiting-feature-creation-info"){const{data:o,handles:i}=t,n={"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",setUp(){var t=this;return e._asyncToGenerator((function*(){o.creationInfo=null,o.edits.feature=null,o.viewModel.featureTemplatesViewModel.select(null),i.add(o.viewModel.featureTemplatesViewModel.on("select",(({item:e})=>{o.creationInfo={layer:e.layer,template:e.template},o.viewModel.activeWorkflow.next()})),t.id)}))()},tearDown(){var t=this;return e._asyncToGenerator((function*(){i.remove(t.id)}))()}}),"awaiting-feature-to-create":()=>({id:"awaiting-feature-to-create",setUp(){var t=this;return e._asyncToGenerator((function*(){i.add(yield d.setUpFeatureAdd(o.viewModel.sketchViewModel,o.creationInfo,(e=>{o.edits.feature=e,o.viewModel.activeWorkflow.next()})),t.id)}))()},tearDown(){var t=this;return e._asyncToGenerator((function*(){i.remove(t.id)}))()}}),"editing-new-feature":()=>({id:"editing-new-feature",setUp(){var t=this;return e._asyncToGenerator((function*(){var a;const n=o.edits.feature,s=n.sourceLayer,l=o.viewModel,u=l.sketchViewModel;l.featureFormViewModel.set({feature:n,fieldConfig:null==(a=d.findLayerInfo(l.layerInfos,s))?void 0:a.fieldConfig}),u.allowDeleteKey=!1;const c=d.getVisualVariableAttributes(n);yield d.startUpdatingFeature(u,n,s,c);const f=u.on("update",function(){var t=e._asyncToGenerator((function*(e){const t=e.graphics[0];if("complete"===e.state)return d.startUpdatingFeature(u,t,s,c);yield d.visualVariableInteractiveUpdate(u.view,t,e,c);const a=t.attributes;if(r.isSome(c.rotation)){const{field:e}=c.rotation;l.featureFormViewModel.setValue(e,a[e])}if(r.isSome(c.size)){const{field:e}=c.size;l.featureFormViewModel.setValue(e,a[e])}}));return function(e){return t.apply(this,arguments)}}());i.add([o.viewModel.featureFormViewModel.on("value-change",e._asyncToGenerator((function*(){o.edits.updateAttributes(o.viewModel.featureFormViewModel.getValues()),n.attributes=o.edits.feature.attributes,"3d"===u.view.type&&(yield d.updateGraphicSymbolWhenRequired(n))}))),f],t.id)}))()},tearDown(t){var r=this;return e._asyncToGenerator((function*(){t.cancelled&&o.viewModel.sketchViewModel.layer.removeAll(),i.remove(r.id)}))()}})},s=d.createWorkflowSteps(["awaiting-feature-creation-info","awaiting-feature-to-create","editing-new-feature"],a,n);return d.avoidFeatureTemplateSelectionWithOnlyOneItem(o,s)},a}(c);return w=f=t.__decorate([s.subclass("esri.widgets.Editor.CreateWorkflow")],w),w}));
