/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/maybe","../../core/reactiveUtils","../../core/Logger","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/Error","../../core/has","../../core/accessorSupport/decorators/subclass","./CreateWorkflowData","./Edits","./Workflow","./workflowUtils"],(function(e,t,a,r,i,n,o,s,c,d,l,u,f,w){"use strict";var p;let v=p=function(t){function i(e){var a;return(a=t.call(this,e)||this).type="create",a}return e._inheritsLoose(i,t),i.create=function(t,a,r){const i=new p({data:new l({edits:new u.Edits,viewModel:t}),onCommit:(n=e._asyncToGenerator((function*(e){yield r(e.creationInfo.layer,{addFeatures:[e.edits.feature]})})),function(e){return n.apply(this,arguments)})});var n;return i._set("steps",this._createWorkflowSteps(i,a)),i},i._createWorkflowSteps=function(t,i="awaiting-feature-creation-info"){const{data:n,handles:o}=t,s=new Map,c={"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",setUp(){var t=this;return e._asyncToGenerator((function*(){n.creationInfo=null,n.edits.feature=null,n.viewModel.featureTemplatesViewModel.select(null),o.add(n.viewModel.featureTemplatesViewModel.on("select",(({item:e})=>{n.creationInfo={layer:e.layer,template:e.template},n.viewModel.activeWorkflow.next()})),t.id)}))()},tearDown(){var t=this;return e._asyncToGenerator((function*(){o.remove(t.id)}))()}}),"awaiting-feature-to-create":()=>({id:"awaiting-feature-to-create",setUp(){var t=this;return e._asyncToGenerator((function*(){o.add(yield w.setUpFeatureAdd(n.viewModel.sketchViewModel,n.creationInfo,(e=>{n.edits.feature=e,n.viewModel.activeWorkflow.next()}),s),t.id)}))()},tearDown(){var t=this;return e._asyncToGenerator((function*(){o.remove(t.id)}))()}}),"editing-new-feature":()=>({id:"editing-new-feature",setUp(){var t=this;return e._asyncToGenerator((function*(){const i=n.edits.feature,c=i.sourceLayer,d=n.viewModel,l=d.sketchViewModel,u=w.findLayerInfo(d.layerInfos,c)?.formTemplate,{spatialReference:f}=d.view;d.featureFormViewModel.set({arcadeEditType:"INSERT",feature:i,formTemplate:u,spatialReference:f}),l.allowDeleteKey=!1;const p=w.getVisualVariableAttributes(i);yield w.startUpdatingFeature(l,i,c,p,s);const v=l.on("update",function(){var t=e._asyncToGenerator((function*(e){const t=e.graphics[0];if("complete"===e.state)return w.startUpdatingFeature(l,t,c,p,s);yield w.visualVariableInteractiveUpdate(l.view,t,e,p,s);const r=t.attributes;if(a.isSome(p.rotation)){const{field:e}=p.rotation;d.featureFormViewModel.setValue(e,r[e])}if(a.isSome(p.size)){const{field:e}=p.size;d.featureFormViewModel.setValue(e,r[e])}}));return function(e){return t.apply(this,arguments)}}());o.add([n.viewModel.featureFormViewModel.on("value-change",e._asyncToGenerator((function*(){n.edits.updateAttributes(n.viewModel.featureFormViewModel.getValues()),i.attributes=n.edits.feature.attributes,"3d"===l.view.type&&(yield w.updateGraphicSymbolWhenRequired(i,s))}))),v,r.watch((()=>n.viewModel.attachmentsViewModel.mode),(e=>{"add"===e&&n.viewModel.activeWorkflow.go("adding-attachment"),"edit"===e&&n.viewModel.activeWorkflow.go("editing-attachment")}))],t.id)}))()},tearDown(t){var a=this;return e._asyncToGenerator((function*(){t.cancelled&&n.viewModel.sketchViewModel.layer.removeAll(),o.remove(a.id)}))()}}),"adding-attachment":()=>({id:"adding-attachment",parent:"editing-new-feature",setUp:()=>e._asyncToGenerator((function*(){}))(),tearDown:()=>e._asyncToGenerator((function*(){n.viewModel.attachmentsViewModel.mode="view"}))()}),"editing-attachment":()=>({id:"editing-attachment",parent:"editing-new-feature",setUp:()=>e._asyncToGenerator((function*(){}))(),tearDown:()=>e._asyncToGenerator((function*(){n.viewModel.attachmentsViewModel.mode="view"}))()})},d=w.createWorkflowSteps(["awaiting-feature-creation-info","awaiting-feature-to-create","editing-new-feature","adding-attachment","editing-attachment"],i,c);return w.avoidFeatureTemplateSelectionWithOnlyOneItem(n,d)},i}(f);v=p=t.__decorate([d.subclass("esri.widgets.Editor.CreateWorkflow")],v);return v}));
