/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/maybe","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/accessorSupport/decorators/subclass","../../layers/support/layerUtils","../../views/draw/support/helpMessageUtils","./CreateWorkflowData","./Edits","./Workflow","./workflowUtils"],(function(e,t,a,r,o,i,n,s,d,l,c,u,f,w){"use strict";var p;let h=p=function(t){function o(e){var a;return(a=t.call(this,e)||this).type="create",a}return e._inheritsLoose(o,t),o.create=function(t,a,r){const o=new p({data:new c({edits:new u.Edits,viewModel:t}),onCommit:(i=e._asyncToGenerator((function*(e){yield r(e.creationInfo.layer,{addFeatures:[e.edits.feature]})})),function(e){return i.apply(this,arguments)})});var i;return o._set("steps",this._createWorkflowSteps(o,a)),o},o._createWorkflowSteps=function(t,o="awaiting-feature-creation-info"){const{data:i,handles:n}=t,s=new Map,d={"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",setUp(){var t=this;return e._asyncToGenerator((function*(){i.creationInfo=null,i.edits.feature=null,i.viewModel.featureTemplatesViewModel.select(null),n.add(i.viewModel.featureTemplatesViewModel.on("select",(({item:e})=>{e&&(i.creationInfo=e,i.viewModel.activeWorkflow?.next())})),t.id)}))()},tearDown(){var t=this;return e._asyncToGenerator((function*(){n.remove(t.id)}))()}}),"awaiting-feature-to-create":()=>({id:"awaiting-feature-to-create",setUp(){var t=this;return e._asyncToGenerator((function*(){n.add(yield w.setUpFeatureAdd(i.viewModel.sketchViewModel,i.creationInfo,(e=>{i.edits.feature=e,i.viewModel.activeWorkflow?.next()}),s),t.id)}))()},tearDown(){var t=this;return e._asyncToGenerator((function*(){n.remove(t.id)}))()}}),"editing-new-feature":()=>({id:"editing-new-feature",setUp(){var t=this;return e._asyncToGenerator((function*(){const o=i.edits.feature,d=o.sourceLayer,l=i.viewModel,c=l.sketchViewModel,u=w.findLayerInfo(l.layerInfos,d)?.formTemplate,{spatialReference:f}=l.view;l.featureFormViewModel.set({arcadeEditType:"INSERT",feature:o,formTemplate:u,spatialReference:f}),c.allowDeleteKey=!1,w.prepareAttachmentsForCreateWorkflow(l.attachmentsViewModel);const p=w.getVisualVariableAttributes(o);yield w.startUpdatingFeature(c,o,d,p,s);const h=c.on("update",function(){var t=e._asyncToGenerator((function*(e){const t=e.graphics[0];if("complete"===e.state)return w.startUpdatingFeature(c,t,d,p,s);yield w.visualVariableInteractiveUpdate(c.view,t,e,p,s);const r=t.attributes;if(a.isSome(p.rotation)){const{field:e}=p.rotation;l.featureFormViewModel.setValue(e,r[e])}if(a.isSome(p.size)){const{field:e}=p.size;l.featureFormViewModel.setValue(e,r[e])}}));return function(e){return t.apply(this,arguments)}}());n.add([i.viewModel.featureFormViewModel.on("value-change",e._asyncToGenerator((function*(){i.edits.updateAttributes(i.viewModel.featureFormViewModel.getValues()),o.attributes=i.edits.feature.attributes,"3d"===c.view.type&&(yield w.updateGraphicSymbolWhenRequired(o,s))}))),h,r.watch((()=>i.viewModel.attachmentsViewModel.mode),(e=>{"add"===e&&i.viewModel.activeWorkflow.go("adding-attachment"),"edit"===e&&i.viewModel.activeWorkflow.go("editing-attachment")}))],t.id)}))()},tearDown(t){var a=this;return e._asyncToGenerator((function*(){t.cancelled&&i.viewModel.sketchViewModel.layer.removeAll(),n.remove(a.id)}))()}}),"adding-attachment":()=>({id:"adding-attachment",parent:"editing-new-feature",setUp:()=>e._asyncToGenerator((function*(){}))(),tearDown:()=>e._asyncToGenerator((function*(){i.viewModel.attachmentsViewModel.mode="view"}))()}),"editing-attachment":()=>({id:"editing-attachment",parent:"editing-new-feature",setUp:()=>e._asyncToGenerator((function*(){}))(),tearDown:()=>e._asyncToGenerator((function*(){i.viewModel.attachmentsViewModel.mode="view"}))()})},l=w.createWorkflowSteps(["awaiting-feature-creation-info","awaiting-feature-to-create","editing-new-feature","adding-attachment","editing-attachment"],o,d);return w.avoidFeatureTemplateSelectionWithOnlyOneItem(i,l)},e._createClass(o,[{key:"shouldShowAttachments",get:function(){return!!(this.data&&this.data.creationInfo&&this.data.viewModel)&&w.shouldShowAttachmentsForCreateWorkflow(this.data)}},{key:"shouldAllowAttachmentEditing",get:function(){return this.shouldShowAttachments}},{key:"helpMessage",get:function(){if("editing-new-feature"!==this.stepId)return;const{creationInfo:e,viewModel:t}=this.data;return l.getDrawHelpMessage(e.layer.geometryType,t.sketchViewModel.createGraphic?.geometry)}},{key:"reliesOnOwnerAdminPrivileges",get:function(){const{layer:e}=this.data.creationInfo,t=e.capabilities?.operations.supportsAdd,a=d.getEffectiveLayerCapabilities(e)?.operations.supportsAdd;return d.getEffectiveEditingEnabled(e)&&!e.editingEnabled||!!a&&!t}}]),o}(f);t.__decorate([o.property()],h.prototype,"shouldShowAttachments",null),t.__decorate([o.property()],h.prototype,"shouldAllowAttachmentEditing",null),t.__decorate([o.property()],h.prototype,"helpMessage",null),t.__decorate([o.property()],h.prototype,"reliesOnOwnerAdminPrivileges",null),h=p=t.__decorate([s.subclass("esri.widgets.Editor.CreateWorkflow")],h);return h}));
