/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/handleUtils","../../core/maybe","../../core/promiseUtils","../../core/reactiveUtils","../../core/Logger","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/Error","../../core/has","../../core/accessorSupport/decorators/subclass","../../views/support/layerViewUtils","./Edits","./UpdateWorkflowData","./Workflow","./workflowUtils"],(function(e,t,i,a,n,r,o,d,s,l,c,u,f,h,g,w,p){"use strict";var m;const v="candidate-highlight";let y=m=function(t){function o(e){var i;return(i=t.call(this,e)||this).type="update",i}e._inheritsLoose(o,t),o.create=function(t,i,a){const n=new m({data:new g({edits:new h.Edits,viewModel:t}),onCommit:(r=e._asyncToGenerator((function*(e){const t=e.edits.feature,i=t.sourceLayer,n=t.clone();if(!e.edits.attributesModified){const{objectIdField:e}=i;n.attributes={[e]:t.getAttribute(e)}}e.edits.geometryModified||(n.geometry=null),yield a(i,{updateFeatures:[n]})})),function(e){return r.apply(this,arguments)})});var r;return n._set("steps",this._createWorkflowSteps(n,i)),n};var d=o.prototype;return d.highlight=function(e){const{data:{viewModel:{view:t}}}=this,i=e&&t.allLayerViews.items.find((({layer:t})=>t===e.layer));f.highlightsSupported(i)&&this.handles.add(i.highlight(e),v)},d.unhighlight=function(){this.handles.remove(v)},o._createWorkflowSteps=function(t,o="awaiting-feature-to-update"){const{data:d,handles:s}=t,l=new Map,c={"awaiting-feature-to-update":()=>({id:"awaiting-feature-to-update",setUp(){var t=this;return e._asyncToGenerator((function*(){const{spinnerViewModel:e,view:i}=d.viewModel;let a=null;s.add({remove(){a&&(a.abort(),a=null)}},t.id),d.edits.feature=null;const r=i.on("immediate-click",(t=>{e.location=t.mapPoint,e.visible=!0,a&&a.abort();const{editableItems:r}=d.viewModel;a=new AbortController,new Promise(((e,o)=>{n.onAbort(a.signal,(()=>o(n.createAbortError()))),e(p.fetchCandidates(r,i,t,a.signal))})).then((e=>{if(n.throwIfAborted(a),d.candidates=e.reduce(((e,t)=>t.error?e:[...e,...t.value]),[]),d.viewModel.spinnerViewModel.visible=1===d.candidates.length,0!==d.candidates.length)if(1===d.candidates.length){const e=d.candidates[0];d.edits.feature=e,d.viewModel.activeWorkflow.go("editing-existing-feature").catch((()=>{})).then((()=>d.viewModel.spinnerViewModel.visible=!1))}else d.viewModel.activeWorkflow.next()}))}));i.focus(),s.add(r,t.id)}))()},tearDown(){var t=this;return e._asyncToGenerator((function*(){s.remove(t.id)}))()}}),"awaiting-update-feature-candidate":()=>({id:"awaiting-update-feature-candidate",setUp(){var i=this;return e._asyncToGenerator((function*(){const{edits:e}=d;e.feature=null,s.add(r.watch((()=>e.feature),(e=>{t.unhighlight(),t.highlight(e)})),i.id)}))()},tearDown(){var i=this;return e._asyncToGenerator((function*(){t.unhighlight(),s.remove(i.id)}))()}}),"editing-existing-feature":()=>({id:"editing-existing-feature",setUp(){var o=this;return e._asyncToGenerator((function*(){if(s.has("editing-existing-feature"))return;const e=d.edits.feature,{attachmentsViewModel:c,editableItems:u,featureFormViewModel:f,layerInfos:h,sketchViewModel:g,view:w}=d.viewModel;d.editableItem=u.find((t=>t.layer===e.layer));const m=new AbortController;s.add({remove:()=>m.abort()},o.id);const v=w.whenLayerView(e.layer),y=p.fetchFullFeature(e,w,m.signal),b=yield v,M=yield y;if(n.isAborted(m))return;d.edits.updateGeometry(M.geometry),d.edits.updateAttributes(M.attributes),d.edits.trackChanges(),c.set({graphic:M,mode:"view"});const _=M.sourceLayer,k=p.findLayerInfo(h,_)?.formTemplate,T=w.spatialReference;f.set({arcadeEditType:"UPDATE",feature:M,formTemplate:k,spatialReference:T,view:w});const U="createInteractiveEditSession"in b?b.createInteractiveEditSession(e):null,V=[f.on("value-change",(e=>{d.edits.updateAttributes(f.getValues()),M.attributes=d.edits.feature.attributes,U&&U.setAttribute(e.fieldName,e.value)})),r.watch((()=>c.mode),(e=>{"add"===e&&d.viewModel.activeWorkflow.go("adding-attachment"),"edit"===e&&d.viewModel.activeWorkflow.go("editing-attachment")}))];U&&(V.push(i.makeHandle((()=>U.rollback()))),s.add(i.makeHandle((()=>U.commit())),t._handleKeys.afterCommit));if(d.editableItem.geometryUpdatesEnabled){g.allowDeleteKey=!1;const e=p.getVisualVariableAttributes(M),{interactive:i,visual:n}=yield p.setUpGeometryUpdate(M,e,g,w,(({geometry:t,attributes:i},n)=>{if(a.isSome(e.rotation)){const{field:t}=e.rotation;f.setValue(t,i[t])}if(a.isSome(e.size)){const{field:t}=e.size;f.setValue(t,i[t])}d.edits.updateAttributes(i),d.edits.updateGeometry(t),f.feature.geometry=t,("undo"===n.type||"redo"===n.type||"update"===n.type&&a.isSome(n.toolEventInfo)&&p.isTerminalUpdateEventType(n.toolEventInfo.type))&&f.notifyFeatureGeometryChanged()}),l);V.push(i,n),s.add(i,t._handleKeys.beforeCommit),s.add(n,t._handleKeys.afterCommit)}else t.highlight(M);s.add(V,o.id)}))()},tearDown({cancelled:i}){var a=this;return e._asyncToGenerator((function*(){i&&(t.unhighlight(),s.remove(a.id))}))()}}),"adding-attachment":()=>({id:"adding-attachment",parent:"editing-existing-feature",setUp:()=>e._asyncToGenerator((function*(){}))(),tearDown:()=>e._asyncToGenerator((function*(){d.viewModel.attachmentsViewModel.mode="view"}))()}),"editing-attachment":()=>({id:"editing-attachment",parent:"editing-existing-feature",setUp:()=>e._asyncToGenerator((function*(){}))(),tearDown:()=>e._asyncToGenerator((function*(){d.viewModel.attachmentsViewModel.mode="view"}))()})};return p.createWorkflowSteps(["awaiting-feature-to-update","awaiting-update-feature-candidate","editing-existing-feature","adding-attachment","editing-attachment"],o,c)},o}(w);y=m=t.__decorate([u.subclass("esri.widgets.Editor.UpdateWorkflow")],y);return y}));
