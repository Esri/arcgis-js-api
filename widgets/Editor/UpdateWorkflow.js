/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/handleUtils","../../core/maybe","../../core/promiseUtils","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/accessorSupport/decorators/subclass","../../layers/support/layerUtils","../../views/support/layerViewUtils","./Edits","./UpdateWorkflowData","./Workflow","./workflowUtils"],(function(e,t,i,a,n,r,o,s,d,l,u,c,p,h,f,g){"use strict";var w;const y="candidate-highlight";let m=w=function(t){function o(e){var i;return(i=t.call(this,e)||this).type="update",i}e._inheritsLoose(o,t),o.create=function(t,i,a){const n=new w({data:new h({edits:new p.Edits,viewModel:t}),onCommit:(r=e._asyncToGenerator((function*(e){const t=e.edits.feature;if(!t)return;const i=t.sourceLayer,n=t.clone();if(!e.edits.attributesModified){const e=i.objectIdField;n.attributes={[e]:t.getAttribute(e)}}e.edits.geometryModified||(n.geometry=null),yield a(i,{updateFeatures:[n]})})),function(e){return r.apply(this,arguments)})});var r;return n._set("steps",this._createWorkflowSteps(n,i)),n};var s=o.prototype;return s.highlight=function(e){const t=this.data.viewModel.view;if(!t||!e)return;const i=e&&t.allLayerViews.items.find((({layer:t})=>t===e.layer||"subtype-sublayer"===e.layer.type&&e.layer.parent===t));c.highlightsSupported(i)&&this.handles.add(i.highlight(e),y)},s.unhighlight=function(){this.handles.remove(y)},o._createWorkflowSteps=function(t,o="awaiting-feature-to-update"){const{data:s,handles:d}=t,l=new Map,u={"awaiting-feature-to-update":()=>({id:"awaiting-feature-to-update",setUp(){var t=this;return e._asyncToGenerator((function*(){const{spinnerViewModel:e}=s.viewModel,i=s.viewModel.view;let a=null;d.add({remove(){a&&(a.abort(),a=null)}},t.id),s.edits.feature=null;const r=i.on("immediate-click",(t=>{e.location=t.mapPoint,e.visible=!0,a?.abort();const{editableItems:r}=s.viewModel;a=new AbortController,new Promise(((e,o)=>{n.onAbort(a?.signal,(()=>o(n.createAbortError()))),e(g.fetchCandidates(r,i,t,a?.signal))})).then((e=>{if(n.throwIfAborted(a),s.candidates=e.reduce(((e,t)=>t.error?e:[...e,...t.value]),[]),s.viewModel.spinnerViewModel.visible=1===s.candidates.length,0===s.candidates.length)return;const t=s.viewModel.activeWorkflow;if(1===s.candidates.length){const e=s.candidates[0];s.edits.feature=e,t.go("editing-existing-feature").catch((()=>{})).then((()=>s.viewModel.spinnerViewModel.visible=!1))}else t.next()}))}));i.focus(),d.add(r,t.id)}))()},tearDown(){var t=this;return e._asyncToGenerator((function*(){d.remove(t.id)}))()}}),"awaiting-update-feature-candidate":()=>({id:"awaiting-update-feature-candidate",setUp(){var i=this;return e._asyncToGenerator((function*(){const{edits:e}=s;e.feature=null,d.add(r.watch((()=>e.feature),(e=>{t.unhighlight(),t.highlight(e)})),i.id)}))()},tearDown(){var i=this;return e._asyncToGenerator((function*(){t.unhighlight(),d.remove(i.id)}))()}}),"editing-existing-feature":()=>({id:"editing-existing-feature",setUp(){var o=this;return e._asyncToGenerator((function*(){if(d.has("editing-existing-feature"))return;const e=s.edits.feature,u=s.viewModel.view,{attachmentsViewModel:c,editableItems:p,featureFormViewModel:h,layerInfos:f,sketchViewModel:w}=s.viewModel;s.editableItem=p.find((t=>t.layer===e.layer));const y=new AbortController;d.add({remove:()=>y.abort()},o.id);const m=g.whenEditorLayerView(u,e.layer),b=g.fetchFullFeature(e,u,y.signal),_=yield m,M=yield b;if(n.isAborted(y))return;s.edits.updateGeometry(M.geometry),s.edits.updateAttributes(M.attributes),s.edits.trackChanges();const k=s.editableItem.supports,E=k.includes("create"),U=k.includes("update");c.set({abilities:{editing:!0,operations:{add:E||U,update:U,delete:U}},graphic:M,filesEnabled:!1,mode:"view"});const A=M.sourceLayer,T=g.findLayerInfo(f,A)?.formTemplate,I=u.spatialReference;h.set({arcadeEditType:"UPDATE",feature:M,formTemplate:T,spatialReference:I,view:u});const V=v(_)?_.createInteractiveEditSession(e):null,G=[h.on("value-change",(e=>{s.edits.updateAttributes(h.getValues()),M.attributes=s.edits.feature.attributes,V&&V.setAttribute(e.fieldName,e.value)})),r.watch((()=>c.mode),(e=>{"add"===e&&s.viewModel.activeWorkflow.go("adding-attachment"),"edit"===e&&s.viewModel.activeWorkflow.go("editing-attachment")}))];V&&(G.push(i.makeHandle((()=>V.rollback()))),d.add(i.makeHandle((()=>V.commit())),t._handleKeys.afterCommit));if(s.editableItem.geometryUpdatesEnabled){w.allowDeleteKey=!1;const e=g.getVisualVariableAttributes(M),{interactive:i,visual:n}=yield g.setUpGeometryUpdate(M,e,w,u,(({geometry:t,attributes:i},n)=>{if(a.isSome(e.rotation)){const{field:t}=e.rotation;h.setValue(t,i[t])}if(a.isSome(e.size)){const{field:t}=e.size;h.setValue(t,i[t])}s.edits.updateAttributes(i),s.edits.updateGeometry(t),h.feature.geometry=t,("undo"===n.type||"redo"===n.type||"update"===n.type&&a.isSome(n.toolEventInfo)&&g.isTerminalUpdateEventType(n.toolEventInfo.type))&&h.notifyFeatureGeometryChanged()}),l);G.push(i,n),d.add(i,t._handleKeys.beforeCommit),d.add(n,t._handleKeys.afterCommit)}else t.highlight(M);d.add(G,o.id)}))()},tearDown({cancelled:i}){var a=this;return e._asyncToGenerator((function*(){i&&(t.unhighlight(),d.remove(a.id))}))()}}),"adding-attachment":()=>({id:"adding-attachment",parent:"editing-existing-feature",setUp:()=>e._asyncToGenerator((function*(){}))(),tearDown:()=>e._asyncToGenerator((function*(){s.viewModel.attachmentsViewModel.mode="view"}))()}),"editing-attachment":()=>({id:"editing-attachment",parent:"editing-existing-feature",setUp:()=>e._asyncToGenerator((function*(){}))(),tearDown:()=>e._asyncToGenerator((function*(){s.viewModel.attachmentsViewModel.mode="view"}))()})};return g.createWorkflowSteps(["awaiting-feature-to-update","awaiting-update-feature-candidate","editing-existing-feature","adding-attachment","editing-attachment"],o,u)},e._createClass(o,[{key:"shouldShowAttachments",get:function(){return!!this.data?.editableItem.attachmentsOnUpdateEnabled}},{key:"shouldAllowAttachmentEditing",get:function(){return!!this.data?.editableItem.supports.includes("update")}},{key:"helpMessage",get:function(){return"awaiting-feature-to-update"===this.stepId?"select":void 0}},{key:"reliesOnOwnerAdminPrivileges",get:function(){const{layer:e}=this.data.editableItem,t=e.capabilities?.operations.supportsUpdate,i=u.getEffectiveLayerCapabilities(e)?.operations.supportsUpdate;return u.getEffectiveEditingEnabled(e)&&!e.editingEnabled||!!i&&!t}}]),o}(f);function v(e){return"createInteractiveEditSession"in e}t.__decorate([o.property()],m.prototype,"shouldShowAttachments",null),t.__decorate([o.property()],m.prototype,"shouldAllowAttachmentEditing",null),t.__decorate([o.property()],m.prototype,"helpMessage",null),t.__decorate([o.property()],m.prototype,"reliesOnOwnerAdminPrivileges",null),m=w=t.__decorate([l.subclass("esri.widgets.Editor.UpdateWorkflow")],m);return m}));
