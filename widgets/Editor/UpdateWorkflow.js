/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/handleUtils","../../core/maybe","../../core/promiseUtils","../../core/watchUtils","../../core/Logger","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/has","../../core/accessorSupport/set","../../core/accessorSupport/decorators/subclass","../../views/support/layerViewUtils","./Edits","./UpdateWorkflowData","./Workflow","./workflowUtils"],(function(e,t,i,a,r,n,o,s,d,l,c,u,h,f,g,w,p){"use strict";var m;const v="candidate-highlight";let y=m=function(t){function o(e){var i;return(i=t.call(this,e)||this).type="update",i}e._inheritsLoose(o,t),o.create=function(t,i,a){const r=new m({data:new g({edits:new f.Edits,viewModel:t}),onCommit:(n=e._asyncToGenerator((function*(e){const t=e.edits.feature,i=t.sourceLayer,r=t.clone();if(!e.edits.attributesModified){const{objectIdField:e}=i;r.attributes={[e]:t.getAttribute(e)}}e.edits.geometryModified||(r.geometry=null),yield a(i,{updateFeatures:[r]})})),function(e){return n.apply(this,arguments)})});var n;return r._set("steps",this._createWorkflowSteps(r,i)),r};var s=o.prototype;return s.highlight=function(e){const{data:{viewModel:{view:t}}}=this,i=e&&t.allLayerViews.items.find((({layer:t})=>t===e.layer));h.highlightsSupported(i)&&this.handles.add(i.highlight(e),v)},s.unhighlight=function(){this.handles.remove(v)},o._createWorkflowSteps=function(t,o="awaiting-feature-to-update"){const{data:s,handles:d}=t,l={"awaiting-feature-to-update":()=>({id:"awaiting-feature-to-update",setUp(){var t=this;return e._asyncToGenerator((function*(){const{spinnerViewModel:e,view:i}=s.viewModel;let a=null;d.add({remove(){a&&(a.abort(),a=null)}},t.id),s.edits.feature=null;const n=i.on("immediate-click",(t=>{e.location=t.mapPoint,e.visible=!0,a&&a.abort();const{editableItems:n}=s.viewModel;a=new AbortController,new Promise(((e,o)=>{r.onAbort(a.signal,(()=>o(r.createAbortError()))),e(p.fetchCandidates(n,i,t,a.signal))})).then((e=>{if(r.throwIfAborted(a),s.candidates=e.reduce(((e,t)=>t.error?e:[...e,...t.value]),[]),s.viewModel.spinnerViewModel.visible=1===s.candidates.length,0!==s.candidates.length)if(1===s.candidates.length){const e=s.candidates[0];s.edits.feature=e,s.viewModel.activeWorkflow.go("editing-existing-feature").catch((()=>{})).then((()=>s.viewModel.spinnerViewModel.visible=!1))}else s.viewModel.activeWorkflow.next()}))}));d.add(n,t.id)}))()},tearDown(){var t=this;return e._asyncToGenerator((function*(){d.remove(t.id)}))()}}),"awaiting-update-feature-candidate":()=>({id:"awaiting-update-feature-candidate",setUp(){var i=this;return e._asyncToGenerator((function*(){const{edits:e}=s;e.feature=null,d.add(n.watch(e,"feature",(e=>{t.unhighlight(),t.highlight(e)})),i.id)}))()},tearDown(){var i=this;return e._asyncToGenerator((function*(){t.unhighlight(),d.remove(i.id)}))()}}),"editing-existing-feature":()=>({id:"editing-existing-feature",setUp(){var n=this;return e._asyncToGenerator((function*(){const e=s.edits.feature,o=s.viewModel;s.editableItem=o.editableItems.find((t=>t.layer===e.layer));const l=new AbortController;d.add({remove:()=>l.abort()},n.id);const c=o.view.whenLayerView(e.layer),u=p.fetchFullFeature(e,o.view,l.signal),h=yield c,f=yield u;if(r.isAborted(l))return;s.edits.updateGeometry(f.geometry),s.edits.updateAttributes(f.attributes),s.edits.trackChanges(),o.attachmentsViewModel.set({graphic:f,mode:"view"});const g=f.sourceLayer,w=p.findLayerInfo(o.layerInfos,g),m=null==w?void 0:w.formTemplate;o.featureFormViewModel.set({feature:f,formTemplate:m});const v="createInteractiveEditSession"in h?h.createInteractiveEditSession(e):null,y=[o.featureFormViewModel.on("value-change",(e=>{s.edits.updateAttributes(o.featureFormViewModel.getValues()),f.attributes=s.edits.feature.attributes,v&&v.setAttribute(e.fieldName,e.value)})),o.attachmentsViewModel.watch("mode",(e=>{"add"===e&&s.viewModel.activeWorkflow.go("adding-attachment"),"edit"===e&&s.viewModel.activeWorkflow.go("editing-attachment")}))];v&&(y.push(i.makeHandle((()=>v.rollback()))),d.add(i.makeHandle((()=>v.commit())),t._handleKeys.afterCommit));const{supportsGeometryUpdate:b}=g.capabilities.editing;if(b){o.sketchViewModel.allowDeleteKey=!1;const e=p.getVisualVariableAttributes(f),{interactive:i,visual:r}=yield p.setUpGeometryUpdate(f,e,o.sketchViewModel,o.view,(({geometry:t,attributes:i})=>{if(a.isSome(e.rotation)){const{field:t}=e.rotation;o.featureFormViewModel.setValue(t,i[t])}if(a.isSome(e.size)){const{field:t}=e.size;o.featureFormViewModel.setValue(t,i[t])}s.edits.updateAttributes(i),s.edits.updateGeometry(t)}));y.push(i,r),d.add(i,t._handleKeys.beforeCommit),d.add(r,t._handleKeys.afterCommit)}else t.highlight(f);d.add(y,n.id)}))()},tearDown(){var i=this;return e._asyncToGenerator((function*(){t.unhighlight(),d.remove(i.id)}))()}}),"adding-attachment":()=>({id:"adding-attachment",parent:"editing-existing-feature",setUp:()=>e._asyncToGenerator((function*(){}))(),tearDown:()=>e._asyncToGenerator((function*(){}))()}),"editing-attachment":()=>({id:"editing-attachment",parent:"editing-existing-feature",setUp:()=>e._asyncToGenerator((function*(){}))(),tearDown:()=>e._asyncToGenerator((function*(){}))()})};return p.createWorkflowSteps(["awaiting-feature-to-update","awaiting-update-feature-candidate","editing-existing-feature","adding-attachment","editing-attachment"],o,l)},o}(w);y=m=t.__decorate([u.subclass("esri.widgets.Editor.UpdateWorkflow")],y);return y}));
