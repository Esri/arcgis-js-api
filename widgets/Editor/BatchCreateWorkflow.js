/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/arrayUtils","../../core/maybe","../../core/accessorSupport/decorators/property","../../core/has","../../core/accessorSupport/ensureType","../../core/Logger","../../core/accessorSupport/decorators/subclass","../../core/accessorSupport/trackingUtils","../../views/interactive/snapping/FeatureSnappingLayerSource","./BatchCreateWorkflowData","./Workflow","./workflowUtils"],(function(e,t,a,r,n,i,o,s,l,c,u,d,h,f){"use strict";var p;let v=p=function(t){function n(e){var a;return(a=t.call(this,e)||this).type="batch-create",a.createFeatureState="create-new",a.featureFormHandle=null,a.visualVariableAttributes={rotation:null,size:null},a.highlightHandles=new Map,a.preventDefaultActionOnCancel=!1,a}e._inheritsLoose(n,t);var i=n.prototype;return i.updatePendingFeature=function(){var t=e._asyncToGenerator((function*(e){return this.preventDefaultActionOnCancel=!0,this.data.viewModel.sketchViewModel.cancel(),a.remove(this.lastActiveGraphics,e),this.startUpdating(e)}));function r(e){return t.apply(this,arguments)}return r}(),n.create=function(t,a,r,n){const i=new p({data:new d.BatchCreateWorkflowData({creationInfo:a,viewModel:t}),onCommit:(o=e._asyncToGenerator((function*(e){yield n(e.creationInfo.layer,{addFeatures:e.viewModel.sketchViewModel.layer.graphics.toArray()})})),function(e){return o.apply(this,arguments)})});var o;return i._set("steps",this._createWorkflowSteps(i,r)),i},i.highlight=function(e){const t=this.data.viewModel.view;"3d"===t.type&&this.highlightHandles.set(e,t.highlight(e))},i.removeHighlight=function(e){r.removeMaybe(this.highlightHandles.get(e)),this.highlightHandles.delete(e)},i.startCreating=function(){var t=e._asyncToGenerator((function*(){return this.createFeatureState="create-new",f.startCreatingNewFeature(this.data.viewModel.sketchViewModel,this.data.creationInfo)}));function a(){return t.apply(this,arguments)}return a}(),i.startUpdating=function(){var t=e._asyncToGenerator((function*(t){var a;const n=this.data.viewModel,i=n.sketchViewModel,o=this.data.creationInfo.layer;return n.featureFormViewModel.set({feature:t,fieldConfig:null==(a=f.findLayerInfo(n.layerInfos,o))?void 0:a.fieldConfig}),r.removeMaybe(this.featureFormHandle),this.featureFormHandle=n.featureFormViewModel.on("value-change",e._asyncToGenerator((function*(){t.attributes=n.featureFormViewModel.getValues(),"3d"===i.view.type&&(yield f.updateGraphicSymbolWhenRequired(t))}))),this.removeHighlight(t),this.createFeatureState="update-pending",this.visualVariableAttributes=f.getVisualVariableAttributes(t),f.startUpdatingFeature(i,t,o,this.visualVariableAttributes)}));function a(e){return t.apply(this,arguments)}return a}(),n._createWorkflowSteps=function(t,n="awaiting-feature-creation-info"){const{data:i,handles:o}=t;let s=null,l=!0;const d={"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",setUp(){var t=this;return e._asyncToGenerator((function*(){i.creationInfo=null,o.add(i.viewModel.featureTemplatesViewModel.on("select",(({item:e})=>{i.creationInfo={layer:e.layer,template:e.template},i.viewModel.activeWorkflow.next()})),t.id)}))()},tearDown(){var t=this;return e._asyncToGenerator((function*(){o.remove(t.id)}))()}}),"batch-creating-features":()=>({id:"batch-creating-features",setUp(){var n=this;return e._asyncToGenerator((function*(){const d=i.viewModel.view,h=i.viewModel.sketchViewModel;l=h.updateOnGraphicClick,h.updateOnGraphicClick=!1,t.lastActiveGraphics=[],t.featureFormHandle=r.removeMaybe(t.featureFormHandle),t.visualVariableAttributes={rotation:null,size:null};const p=h.on("create",function(){var a=e._asyncToGenerator((function*(e){if("cancel"===e.state){if(t.preventDefaultActionOnCancel)return void(t.preventDefaultActionOnCancel=!1);if(t.lastActiveGraphics.length<1)return t.startCreating();const e=t.lastActiveGraphics.pop();return t.startUpdating(e)}if("complete"===e.state)return t.startUpdating(e.graphic)}));return function(e){return a.apply(this,arguments)}}()),v=h.on("update",function(){var a=e._asyncToGenerator((function*(e){const a=e.graphics[0];if("complete"===e.state)return a!==s&&(t.lastActiveGraphics.push(a),t.highlight(a)),s=null,e.aborted&&t.preventDefaultActionOnCancel?void(t.preventDefaultActionOnCancel=!1):t.startCreating();"start"===e.state&&t.removeHighlight(a),yield f.visualVariableInteractiveUpdate(d,a,e,t.visualVariableAttributes);const n=a.attributes;if(r.isSome(t.visualVariableAttributes.rotation)){const{field:e}=t.visualVariableAttributes.rotation;i.viewModel.featureFormViewModel.setValue(e,n[e])}if(r.isSome(t.visualVariableAttributes.size)){const{field:e}=t.visualVariableAttributes.size;i.viewModel.featureFormViewModel.setValue(e,n[e])}}));return function(e){return a.apply(this,arguments)}}()),g=h.on("delete",function(){var r=e._asyncToGenerator((function*(e){const r=e.graphics[0];a.remove(t.lastActiveGraphics,r),s=r}));return function(e){return r.apply(this,arguments)}}());let y=null;const w=c.reactionInit((()=>{var e;const t=h.snappingOptions.featureSources.find((e=>e.layer===i.creationInfo.layer));return{hasFeatureLayerSource:!!t,enabled:null!=(e=null==t?void 0:t.enabled)&&e}}),(({hasFeatureLayerSource:e,enabled:t})=>{const a=h.snappingOptions.featureSources;e?(r.isNone(y)&&(y=new u({layer:h.layer,enabled:t}),a.add(y)),y.enabled=t):(r.isSome(y)&&a.remove(y),y=r.destroyMaybe(y))})),m=d.on("immediate-click",function(){var a=e._asyncToGenerator((function*(e){const a=yield d.hitTest(e,{include:h.layer});if(a.results.length>0){const e=a.results[0].graphic;if("transform"===h.activeTool||"reshape"===h.activeTool){if(h.updateGraphics.getItemAt(0)===e)return;yield t.updatePendingFeature(e)}}}));return function(e){return a.apply(this,arguments)}}());yield t.startCreating();const b={remove:()=>{r.removeMaybe(t.featureFormHandle),p.remove(),v.remove(),g.remove(),w.remove(),r.isSome(y)&&h.snappingOptions.featureSources.remove(y),y=r.destroyMaybe(y),h.cancel(),m.remove()}};o.add(b,n.id)}))()},tearDown(t){var a=this;return e._asyncToGenerator((function*(){t.cancelled&&i.viewModel.sketchViewModel.layer.removeAll(),o.remove(a.id),i.viewModel.sketchViewModel.updateOnGraphicClick=l}))()}})},h=f.createWorkflowSteps(["awaiting-feature-creation-info","batch-creating-features"],n,d);return f.avoidFeatureTemplateSelectionWithOnlyOneItem(i,h)},e._createClass(n,[{key:"numPendingFeatures",get:function(){return this.data.viewModel.sketchViewModel.layer.graphics.length}},{key:"pendingFeatures",get:function(){return this.data.viewModel.sketchViewModel.layer.graphics}}]),n}(h);return v=p=t.__decorate([l.subclass("esri.widgets.Editor.BatchCreateWorkflow")],v),v}));
