/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/arrayUtils","../../core/maybe","../../core/reactiveUtils","../../core/Logger","../../core/accessorSupport/ensureType","../../core/has","../../core/accessorSupport/set","../../core/accessorSupport/decorators/subclass","../../views/interactive/snapping/FeatureSnappingLayerSource","./BatchCreateWorkflowData","./Workflow","./workflowUtils"],(function(e,t,a,r,n,i,o,s,l,c,u,d,h,f){"use strict";var p;let v=p=function(t){function i(e){var a;return(a=t.call(this,e)||this).type="batch-create",a.createFeatureState="create-new",a.featureFormHandle=null,a.visualVariableAttributes={rotation:null,size:null},a.highlightHandles=new Map,a.preventDefaultActionOnCancel=!1,a}e._inheritsLoose(i,t);var o=i.prototype;return o.updatePendingFeature=function(){var t=e._asyncToGenerator((function*(e){return this.preventDefaultActionOnCancel=!0,this.data.viewModel.sketchViewModel.cancel(),a.remove(this.lastActiveGraphics,e),this.startUpdating(e)}));function r(e){return t.apply(this,arguments)}return r}(),i.create=function(t,a,r,n){const i=new p({data:new d.BatchCreateWorkflowData({creationInfo:a,viewModel:t}),onCommit:(o=e._asyncToGenerator((function*(e){yield n(e.creationInfo.layer,{addFeatures:e.viewModel.sketchViewModel.layer.graphics.toArray()})})),function(e){return o.apply(this,arguments)})});var o;return i._set("steps",this._createWorkflowSteps(i,r)),i},o.highlight=function(e){const t=this.data.viewModel.view;"3d"===t.type&&this.highlightHandles.set(e,t.highlight(e))},o.removeHighlight=function(e){r.removeMaybe(this.highlightHandles.get(e)),this.highlightHandles.delete(e)},o.startCreating=function(){var t=e._asyncToGenerator((function*(){return this.createFeatureState="create-new",f.startCreatingNewFeature(this.data.viewModel.sketchViewModel,this.data.creationInfo)}));function a(){return t.apply(this,arguments)}return a}(),o.startUpdating=function(){var t=e._asyncToGenerator((function*(t){const a=this.data.viewModel,n=a.sketchViewModel,i=this.data.creationInfo.layer,o=f.findLayerInfo(a.layerInfos,i),s=null==o?void 0:o.formTemplate,l=s?null:null==o?void 0:o.fieldConfig;return a.featureFormViewModel.set({feature:t,fieldConfig:l,formTemplate:s}),r.removeMaybe(this.featureFormHandle),this.featureFormHandle=a.featureFormViewModel.on("value-change",e._asyncToGenerator((function*(){t.attributes=a.featureFormViewModel.getValues(),"3d"===n.view.type&&(yield f.updateGraphicSymbolWhenRequired(t))}))),this.removeHighlight(t),this.createFeatureState="update-pending",this.visualVariableAttributes=f.getVisualVariableAttributes(t),f.startUpdatingFeature(n,t,i,this.visualVariableAttributes)}));function a(e){return t.apply(this,arguments)}return a}(),i._createWorkflowSteps=function(t,i="awaiting-feature-creation-info"){const{data:o,handles:s}=t;let l=null,c=!0;const d={"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",setUp(){var t=this;return e._asyncToGenerator((function*(){o.creationInfo=null,s.add(o.viewModel.featureTemplatesViewModel.on("select",(({item:e})=>{o.creationInfo={layer:e.layer,template:e.template},o.viewModel.activeWorkflow.next()})),t.id)}))()},tearDown(){var t=this;return e._asyncToGenerator((function*(){s.remove(t.id)}))()}}),"batch-creating-features":()=>({id:"batch-creating-features",setUp(){var i=this;return e._asyncToGenerator((function*(){const d=o.viewModel.view,h=o.viewModel.sketchViewModel;c=h.updateOnGraphicClick,h.updateOnGraphicClick=!1,t.lastActiveGraphics=[],t.featureFormHandle=r.removeMaybe(t.featureFormHandle),t.visualVariableAttributes={rotation:null,size:null};const p=h.on("create",function(){var a=e._asyncToGenerator((function*(e){if("cancel"===e.state){if(t.preventDefaultActionOnCancel)return void(t.preventDefaultActionOnCancel=!1);if(t.lastActiveGraphics.length<1)return t.startCreating();const e=t.lastActiveGraphics.pop();return t.startUpdating(e)}if("complete"===e.state)return t.startUpdating(e.graphic)}));return function(e){return a.apply(this,arguments)}}()),v=h.on("update",function(){var a=e._asyncToGenerator((function*(e){const a=e.graphics[0];if("complete"===e.state)return a!==l&&(t.lastActiveGraphics.push(a),t.highlight(a)),l=null,e.aborted&&t.preventDefaultActionOnCancel?void(t.preventDefaultActionOnCancel=!1):t.startCreating();"start"===e.state&&t.removeHighlight(a),yield f.visualVariableInteractiveUpdate(d,a,e,t.visualVariableAttributes);const n=a.attributes;if(r.isSome(t.visualVariableAttributes.rotation)){const{field:e}=t.visualVariableAttributes.rotation;o.viewModel.featureFormViewModel.setValue(e,n[e])}if(r.isSome(t.visualVariableAttributes.size)){const{field:e}=t.visualVariableAttributes.size;o.viewModel.featureFormViewModel.setValue(e,n[e])}}));return function(e){return a.apply(this,arguments)}}()),g=h.on("delete",function(){var r=e._asyncToGenerator((function*(e){const r=e.graphics[0];a.remove(t.lastActiveGraphics,r),l=r}));return function(e){return r.apply(this,arguments)}}());let y=null;const w=n.react((()=>{var e;const t=h.snappingOptions.featureSources.find((e=>e.layer===o.creationInfo.layer));return{hasFeatureLayerSource:!!t,enabled:null!=(e=null==t?void 0:t.enabled)&&e}}),(({hasFeatureLayerSource:e,enabled:t})=>{const a=h.snappingOptions.featureSources;e?(r.isNone(y)&&(y=new u({layer:h.layer,enabled:t}),a.add(y)),y.enabled=t):(r.isSome(y)&&a.remove(y),y=r.destroyMaybe(y))}),n.syncAndInitial),m=d.on("immediate-click",function(){var a=e._asyncToGenerator((function*(e){const a=yield d.hitTest(e,{include:h.layer});if(a.results.length>0){const e=a.results[0].graphic;if("transform"===h.activeTool||"reshape"===h.activeTool){if(h.updateGraphics.getItemAt(0)===e)return;yield t.updatePendingFeature(e)}}}));return function(e){return a.apply(this,arguments)}}());yield t.startCreating();const b={remove:()=>{r.removeMaybe(t.featureFormHandle),p.remove(),v.remove(),g.remove(),w.remove(),r.isSome(y)&&h.snappingOptions.featureSources.remove(y),y=r.destroyMaybe(y),h.cancel(),m.remove()}};s.add(b,i.id)}))()},tearDown(t){var a=this;return e._asyncToGenerator((function*(){t.cancelled&&o.viewModel.sketchViewModel.layer.removeAll(),s.remove(a.id),o.viewModel.sketchViewModel.updateOnGraphicClick=c}))()}})},h=f.createWorkflowSteps(["awaiting-feature-creation-info","batch-creating-features"],i,d);return f.avoidFeatureTemplateSelectionWithOnlyOneItem(o,h)},e._createClass(i,[{key:"numPendingFeatures",get:function(){return this.data.viewModel.sketchViewModel.layer.graphics.length}},{key:"pendingFeatures",get:function(){return this.data.viewModel.sketchViewModel.layer.graphics}}]),i}(h);v=p=t.__decorate([c.subclass("esri.widgets.Editor.BatchCreateWorkflow")],v);return v}));
