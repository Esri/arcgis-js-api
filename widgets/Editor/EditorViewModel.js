/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/Collection","../../core/Error","../../core/Evented","../../core/HandleOwner","../../core/Logger","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/arrayUtils","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass","../../layers/GraphicsLayer","../Attachments/AttachmentsViewModel","./CreateFeaturesWorkflow","./CreateWorkflow","./deprecationUtils","./UpdateWorkflow","../FeatureForm/FeatureFormViewModel","../FeatureTemplates/FeatureTemplatesViewModel","../Sketch/SketchViewModel","../Spinner/SpinnerViewModel"],(function(e,t,r,o,i,a,n,s,l,c,u,d,p,f,h,w,y,_,k,v,W,m){"use strict";const g="esri.widgets.Editor.EditorViewModel",b=n.getLogger(g),C=["create","create-features","update"];function F(e,t,r){b.error(new o(e,t,r))}function E(e,t){return e&&e.find((e=>e.layer===t))}let T=function(t){function i(e){var r;return(r=t.call(this,e)||this)._sketchGraphicsLayer=new p({listMode:"hide",internal:!0}),r.activeWorkflow=null,r._activityQueue=[],r.failures=[],r.attachmentsViewModel=new f({abilities:{editing:!0}}),r.featureFormViewModel=new k,r.featureTemplatesViewModel=new v,r.layerInfos=null,r.sketchViewModel=new W({layer:r._sketchGraphicsLayer}),r.spinnerViewModel=new m,r}e._inheritsLoose(i,t);var a=i.prototype;return a.initialize=function(){this.handles.add([s.on((()=>this.activeWorkflow),"cancel",(()=>this.emit("workflow-cancel"))),s.on((()=>this.activeWorkflow),"commit",(()=>this.emit("workflow-commit"))),s.when((()=>this.view?.map),(e=>{e.add(this._sketchGraphicsLayer)}),s.initial),s.watch((()=>this.editableItems.toArray()),(()=>{const{activeWorkflow:e}=this;if(this.refreshCreationTemplates(),!e)return;const{stepId:t}=e;"create"!==e.type?"update"===e.type&&("awaiting-feature-to-update"===t&&!this.canUpdate||"awaiting-update-feature-candidate"===t&&!e.data.candidates.some((e=>{const t=this.editableItems.find((t=>t.layer===e.layer));return t&&t.supports.includes("update")})))&&this._cancelWorkflow():"awaiting-feature-creation-info"!==t||this.canCreate||this._cancelWorkflow()}))])},a.destroy=function(){this._cancelWorkflow().then((()=>{this.view?.map&&this.view.map.remove(this._sketchGraphicsLayer),this.view=null}))},a.startCreateWorkflowAtFeatureTypeSelection=function(){var t=e._asyncToGenerator((function*(){if(y.workflowDeprecation(b,"startCreateWorkflowAtFeatureTypeSelection","startCreateFeaturesWorkflowAtFeatureTypeSelection"),!this.canCreate)return void F("editing:unsupported-workflow","Create workflow is unsupported or disabled.");yield this._cancelWorkflow();const e=this._createCreateWorkflow();yield e.start(),this._set("activeWorkflow",e)}));function r(){return t.apply(this,arguments)}return r}(),a.startCreateFeaturesWorkflowAtFeatureTypeSelection=function(){var t=e._asyncToGenerator((function*(){return this.startCreateFeaturesWorkflow()}));function r(){return t.apply(this,arguments)}return r}(),a.startCreateWorkflowAtFeatureCreation=function(){var t=e._asyncToGenerator((function*(e){if(y.workflowDeprecation(b,"startCreateWorkflowAtFeatureCreation","startCreateFeaturesWorkflowAtFeatureCreation"),!this.canCreate)return void F("editing:unsupported-workflow","Create workflow is unsupported or disabled.");yield this._cancelWorkflow();const t=this._createCreateWorkflow("awaiting-feature-to-create");t.data.creationInfo=e,yield t.start(),this._set("activeWorkflow",t)}));function r(e){return t.apply(this,arguments)}return r}(),a.startCreateFeaturesWorkflowAtFeatureCreation=function(){var t=e._asyncToGenerator((function*(e){return this.startCreateFeaturesWorkflow(e,"creating-features")}));function r(e){return t.apply(this,arguments)}return r}(),a.startCreateFeaturesWorkflow=function(){var t=e._asyncToGenerator((function*(e,t="awaiting-feature-creation-info"){if(!this.canCreate)throw new o("editing:unsupported-workflow","Creating features is unsupported or disabled.");yield this._cancelWorkflow();const r=this._createCreateFeaturesWorkflow(e,t);yield r.start(),this._set("activeWorkflow",r)}));function r(e){return t.apply(this,arguments)}return r}(),a.startCreateWorkflowAtFeatureEdit=function(){var t=e._asyncToGenerator((function*(e){if(y.workflowDeprecation(b,"startCreateWorkflowAtFeatureEdit"),!this.canCreate)return void F("editing:unsupported-workflow","Create workflow is unsupported or disabled.");yield this._cancelWorkflow();const t=this._createCreateWorkflow("editing-new-feature");t.data.edits.feature=e,yield t.start(),this._set("activeWorkflow",t)}));function r(e){return t.apply(this,arguments)}return r}(),a.startUpdateWorkflowAtFeatureSelection=function(){var t=e._asyncToGenerator((function*(){if(!this.canUpdate)return void F("editing:unsupported-workflow","Update workflow is unsupported or disabled.");yield this._cancelWorkflow();const e=this._createUpdateWorkflow();yield e.start(),this._set("activeWorkflow",e)}));function r(){return t.apply(this,arguments)}return r}(),a.startUpdateWorkflowAtMultipleFeatureSelection=function(){var t=e._asyncToGenerator((function*(e){if(!this.canUpdate)return void F("editing:unsupported-workflow","Update workflow is unsupported or disabled.");yield this._cancelWorkflow();const t=this._createUpdateWorkflow("awaiting-update-feature-candidate");t.data.candidates=e,yield t.start(),this._set("activeWorkflow",t)}));function r(e){return t.apply(this,arguments)}return r}(),a.startUpdateWorkflowAtFeatureEdit=function(){var t=e._asyncToGenerator((function*(e){if(!this.canUpdate)return void F("editing:unsupported-workflow","Update workflow is unsupported or disabled.");yield this._cancelWorkflow();const t=this._createUpdateWorkflow("editing-existing-feature");t.data.edits.feature=e,yield t.start(),this._set("activeWorkflow",t)}));function r(e){return t.apply(this,arguments)}return r}(),a.deleteFeatureFromWorkflow=function(){var t=e._asyncToGenerator((function*(){const{activeWorkflow:e}=this;e&&"update"===e.type?(yield this._delete(e.data.edits.feature),yield e.reset()):F("editing:unsupported-workflow","Deleting requires an active update workflow.")}));function r(){return t.apply(this,arguments)}return r}(),a.cancelWorkflow=function(){var t=e._asyncToGenerator((function*(e){return this._cancelWorkflow({warn:!0,...e})}));function r(e){return t.apply(this,arguments)}return r}(),a.refreshCreationTemplates=function(){const e=[];for(const{layer:t,supports:r}of this.editableItems)t.loaded&&r.includes("create")&&e.push(t);this.featureTemplatesViewModel.layers=e},a._cancelWorkflow=function(){var t=e._asyncToGenerator((function*(e){const t=this.activeWorkflow;if(!t)return void(e&&e.warn&&F("editing:no-active-workflow","There is no active workflow to cancel."));if(!e||!1!==e.force)return this.emit("workflow-cancel"),this._set("activeWorkflow",null),void(yield t.cancel(e));yield t.cancel(e),this._set("activeWorkflow",null)}));function r(e){return t.apply(this,arguments)}return r}(),a._createCreateFeaturesWorkflow=function(e,t){return h.create(this,e,t,((e,t,r)=>this._applyEdits(e,t,r)),((e,t)=>this._addAttachments(e,t)))},a._createCreateWorkflow=function(e){return w.create(this,e,((e,t,r)=>this._applyEdits(e,t,r)))},a._createUpdateWorkflow=function(e){return _.create(this,e,((e,t)=>this._applyEdits(e,t)))},a._delete=function(){var t=e._asyncToGenerator((function*(e){const t=e.sourceLayer;"applyEdits"in t&&(yield this._applyEdits(t,{deleteFeatures:[e]}))}));function r(e){return t.apply(this,arguments)}return r}(),a._addAttachments=function(e,t){const r=[];return t?.forEach((t=>r.push(this._addAttachment(e,t.feature,t.attachment)))),Promise.all(r)},a._addAttachment=function(){var t=e._asyncToGenerator((function*(t,r,o){let i=null;return yield this._queueOperation(e._asyncToGenerator((function*(){return i=yield t.addAttachment(r,o).catch((e=>{throw e?.error||e})),i}))),i}));function r(e,r,o){return t.apply(this,arguments)}return r}(),a._applyEdits=function(){var t=e._asyncToGenerator((function*(t,r,o){var i=this;let a=null;return yield this._queueOperation(e._asyncToGenerator((function*(){if(t.capabilities.operations.supportsQuery){const e=yield i.view.whenLayerView(t);return a=yield t.applyEdits(r,o),yield s.whenOnce((()=>!e.updating)),a}return a=yield t.applyEdits(r,o),a}))),a}));function r(e,r,o){return t.apply(this,arguments)}return r}(),a._queueOperation=function(e){this._activityQueue.push(e),this.notifyChange("syncing");const t=(e,t)=>{const r=t.indexOf(e);r>-1&&t.splice(r,1)};return e().then((e=>{if("error"in e&&e.error)throw e.error;if("addFeatureResults"in e){const{addFeatureResults:t,deleteFeatureResults:r,updateFeatureResults:o}=e,i=t.find((e=>!!e.error))||o.find((e=>!!e.error))||r.find((e=>!!e.error));if(i)throw i.error}return e})).catch((r=>{F("editing:operation-error","An error occurred.",{error:r});const o={error:r,retry:()=>(t(o,this.failures),this._queueOperation(e)),cancel:()=>{t(o,this.failures)}};this._set("failures",[...this.failures,o])})).then((()=>{t(e,this._activityQueue),this.notifyChange("syncing")}))},a._getEditableItemFromLayer=function(e,t=!0){const{data:r,editing:o,operations:i}=e.capabilities,a=E(this.layerInfos,e),n=!(!r.supportsAttachment||a&&!1===a.allowAttachments),s=o.supportsGeometryUpdate&&(!a||!1!==a.geometryUpdatesEnabled),l=!a||!1!==a.attributeUpdatesEnabled;if(t)return{hasAttachments:n,layer:e,supports:[],geometryUpdatesEnabled:s,attributeUpdatesEnabled:l};const c=[];return i.supportsAdd&&(this.allowedWorkflows.includes("create")||this.allowedWorkflows.includes("create-features"))&&(!a||!1!==a.enabled&&!1!==a.addEnabled)&&c.push("create"),i.supportsUpdate&&this.allowedWorkflows.includes("update")&&(!a||!1!==a.enabled&&!1!==a.updateEnabled)&&c.push("update"),!1!==(a&&a.deleteEnabled)&&i.supportsDelete&&c.push("delete"),{hasAttachments:n,layer:e,supports:c,geometryUpdatesEnabled:s,attributeUpdatesEnabled:l}},e._createClass(i,[{key:"allowedWorkflows",get:function(){return this._get("allowedWorkflows")},set:function(e){e&&0!==e.length||(e=[...C]),this._set("allowedWorkflows",e)}},{key:"canCreate",get:function(){return this.editableItems.some((e=>e.supports.includes("create")))}},{key:"canUpdate",get:function(){return this.editableItems.some((e=>e.supports.includes("update")))}},{key:"editableItems",get:function(){const e=this.view?.allLayerViews;if(!e)return new r;const t=this.view?.map?.editableLayers,o=new Set(t),i=t?.filter((e=>e.visible&&e.capabilities.operations.supportsAdd&&!e.capabilities.operations.supportsQuery)),a=e.filter((e=>o.has(e.layer))).map((({layer:e,suspended:t})=>this._getEditableItemFromLayer(e,t))).reverse();return i?.forEach((e=>a.push(this._getEditableItemFromLayer(e,!1)))),a}},{key:"labelOptions",get:function(){return this.sketchViewModel.labelOptions},set:function(e){this.sketchViewModel.labelOptions=e}},{key:"snappingOptions",get:function(){return this.sketchViewModel.snappingOptions},set:function(e){this.sketchViewModel.snappingOptions=e}},{key:"state",get:function(){if(!this.get("view.ready")||0===this.editableItems.length)return"disabled";const e=this.attachmentsViewModel.mode;if("add"===e)return"adding-attachment";if("edit"===e)return"editing-attachment";const{activeWorkflow:t}=this;return t?t.stepId:"ready"}},{key:"syncing",get:function(){return this._activityQueue.length>0}},{key:"tooltipOptions",get:function(){return this.sketchViewModel.tooltipOptions},set:function(e){this.sketchViewModel.tooltipOptions=e}},{key:"view",set:function(e){this.sketchViewModel.view=e,this.spinnerViewModel.view=e,this._set("view",e)}}]),i}(a.HandleOwnerMixin(i.EventedAccessor));t.__decorate([l.property({readOnly:!0})],T.prototype,"activeWorkflow",void 0),t.__decorate([l.property({readOnly:!0})],T.prototype,"_activityQueue",void 0),t.__decorate([l.property({value:[...C]})],T.prototype,"allowedWorkflows",null),t.__decorate([l.property({readOnly:!0})],T.prototype,"canCreate",null),t.__decorate([l.property({readOnly:!0})],T.prototype,"canUpdate",null),t.__decorate([l.property({readOnly:!0})],T.prototype,"editableItems",null),t.__decorate([l.property({readOnly:!0})],T.prototype,"failures",void 0),t.__decorate([l.property()],T.prototype,"attachmentsViewModel",void 0),t.__decorate([l.property()],T.prototype,"featureFormViewModel",void 0),t.__decorate([l.property()],T.prototype,"featureTemplatesViewModel",void 0),t.__decorate([l.property()],T.prototype,"labelOptions",null),t.__decorate([l.property()],T.prototype,"layerInfos",void 0),t.__decorate([l.property()],T.prototype,"sketchViewModel",void 0),t.__decorate([l.property()],T.prototype,"snappingOptions",null),t.__decorate([l.property()],T.prototype,"spinnerViewModel",void 0),t.__decorate([l.property()],T.prototype,"state",null),t.__decorate([l.property({readOnly:!0})],T.prototype,"syncing",null),t.__decorate([l.property()],T.prototype,"tooltipOptions",null),t.__decorate([l.property()],T.prototype,"view",null),T=t.__decorate([d.subclass(g)],T);return T}));
