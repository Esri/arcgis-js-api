// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../core/arrayUtils","../../core/Collection","../../core/Error","../../core/Evented","../../core/HandleOwner","../../core/Logger","../../core/watchUtils","../../core/accessorSupport/decorators","../../layers/GraphicsLayer","../../layers/graphics/editingSupport","../Attachments/AttachmentsViewModel","./CreateWorkflow","./UpdateWorkflow","../FeatureForm/FeatureFormViewModel","../FeatureTemplates/FeatureTemplatesViewModel","../Sketch/SketchViewModel","../Spinner/SpinnerViewModel"],(function(e,t,r,o,n,a,i,s,u,c,l,d,p,f,w,h,_,y,v,k){"use strict";var g=u.getLogger("esri.widgets.Editor.EditorViewModel"),b=["create","update"];function m(e,t,r){g.error(new a(e,t,r))}function W(e){return e&&p.isEditableLayer(e.layer)}return function(e){function t(t){var r=e.call(this,t)||this;return r._sketchGraphicsLayer=new d({listMode:"hide"}),r.activeWorkflow=null,r.activityQueue=[],r.failures=[],r.attachmentsViewModel=new f({abilities:{editing:!0}}),r.featureFormViewModel=new _,r.featureTemplatesViewModel=new y,r.layerInfos=null,r.sketchViewModel=new v({layer:r._sketchGraphicsLayer}),r.spinnerViewModel=new k,r}return r.__extends(t,e),t.prototype.initialize=function(){var e=this;this.handles.add([c.on(this,"activeWorkflow","cancel",(function(){return e.emit("workflow-cancel")})),c.on(this,"activeWorkflow","commit",(function(){return e.emit("workflow-commit")})),c.on(this,"view.allLayerViews","change",(function(){return e.notifyChange("editableItems")})),c.watch(this,"editableItems",(function(){var t=e.activeWorkflow;if(t){var r=t.stepId;if("create"===t.type)return e.refreshCreationTemplates(),void("awaiting-feature-creation-info"!==r||e.canCreate||e._cancelWorkflow());"update"===t.type&&("awaiting-feature-to-update"===r&&!e.canUpdate||"awaiting-update-feature-candidate"===r&&!t.data.candidates.some((function(t){var r=e.editableItems.find((function(e){return e.layer===t.layer}));return r&&r.supports.indexOf("update")>-1})))&&e._cancelWorkflow()}}))])},t.prototype.destroy=function(){var e=this;this._cancelWorkflow().then((function(){return e.view=null}))},Object.defineProperty(t.prototype,"allowedWorkflows",{get:function(){return this._get("allowedWorkflows")},set:function(e){e&&0!==e.length||(e=r.__spreadArrays(b)),this._set("allowedWorkflows",e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"canCreate",{get:function(){return this.editableItems.some((function(e){return e.supports.indexOf("create")>-1}))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"canUpdate",{get:function(){return this.editableItems.some((function(e){return e.supports.indexOf("update")>-1}))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"editableItems",{get:function(){var e=this,t=this.get("view.allLayerViews");if(!t)return new n;this.handles.remove("layer-view-property-watchers");var r=function(){return e.notifyChange("editableItems")};return t.filter(W).map((function(t){e.handles.add(c.watch(t,["suspended","suspendInfo"],r),"layer-view-property-watchers");var n=t.layer,a=t.suspendInfo,i=[],s=e.allowedWorkflows,u=n.capabilities,l=u.data,d=u.operations,p=function(e,t){return e&&o.find(e,(function(e){return e.layer===t}))}(e.layerInfos,n),f=l.supportsAttachment&&(!p||!1!==p.allowAttachments),w=s.filter((function(e){return!p||!1!==p.enabled&&("create"===e&&!1!==p.addEnabled||"update"===e&&!1!==p.updateEnabled)})),h=a&&(a.layerInvisible||a.layerNotLoaded||a.outsideScaleRange||a.viewNotReady);return!h&&o.find(w,(function(e){return"create"===e}))&&d.supportsAdd&&i.push("create"),!h&&o.find(w,(function(e){return"update"===e}))&&d.supportsUpdate&&i.push("update"),!h&&!1!==(p&&p.deleteEnabled)&&d.supportsDelete&&i.push("delete"),{hasAttachments:f,layer:n,supports:i}})).reverse()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"state",{get:function(){if(!this.get("view.ready")||0===this.editableItems.length)return"disabled";var e=this.attachmentsViewModel.mode;if("add"===e)return"adding-attachment";if("edit"===e)return"editing-attachment";var t=this.activeWorkflow;return t?t.stepId:"ready"},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"syncing",{get:function(){return this.activityQueue.length>0},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"view",{set:function(e){this.sketchViewModel.view=e,this.spinnerViewModel.view=e,this._set("view",e)},enumerable:!1,configurable:!0}),t.prototype.startCreateWorkflowAtFeatureTypeSelection=function(){return r.__awaiter(this,void 0,void 0,(function(){var e;return r.__generator(this,(function(t){switch(t.label){case 0:return this.canCreate?[4,this._cancelWorkflow()]:(m("editing:unsupported-workflow","Create workflow is unsupported or disabled."),[2]);case 1:return t.sent(),[4,(e=this._createCreateWorkflow()).start()];case 2:return t.sent(),this._set("activeWorkflow",e),[2]}}))}))},t.prototype.startCreateWorkflowAtFeatureCreation=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(r){switch(r.label){case 0:return this.canCreate?[4,this._cancelWorkflow()]:(m("editing:unsupported-workflow","Update workflow is unsupported or disabled."),[2]);case 1:return r.sent(),(t=this._createCreateWorkflow("awaiting-feature-to-create")).data.creationInfo=e,[4,t.start()];case 2:return r.sent(),this._set("activeWorkflow",t),[2]}}))}))},t.prototype.startCreateWorkflowAtFeatureEdit=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(r){switch(r.label){case 0:return this.canCreate?[4,this._cancelWorkflow()]:(m("editing:unsupported-workflow","Update workflow is unsupported or disabled."),[2]);case 1:return r.sent(),(t=this._createCreateWorkflow("editing-new-feature")).data.edits.feature=e,[4,t.start()];case 2:return r.sent(),this._set("activeWorkflow",t),[2]}}))}))},t.prototype.startUpdateWorkflowAtFeatureSelection=function(){return r.__awaiter(this,void 0,void 0,(function(){var e;return r.__generator(this,(function(t){switch(t.label){case 0:return this.canUpdate?[4,this._cancelWorkflow()]:(m("editing:unsupported-workflow","Update workflow is unsupported or disabled."),[2]);case 1:return t.sent(),[4,(e=this._createUpdateWorkflow()).start()];case 2:return t.sent(),this._set("activeWorkflow",e),[2]}}))}))},t.prototype.startUpdateWorkflowAtMultipleFeatureSelection=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(r){switch(r.label){case 0:return this.canUpdate?[4,this._cancelWorkflow()]:(m("editing:unsupported-workflow","Update workflow is unsupported or disabled."),[2]);case 1:return r.sent(),(t=this._createUpdateWorkflow("awaiting-update-feature-candidate")).data.candidates=e,[4,t.start()];case 2:return r.sent(),this._set("activeWorkflow",t),[2]}}))}))},t.prototype.startUpdateWorkflowAtFeatureEdit=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(r){switch(r.label){case 0:return this.canUpdate?[4,this._cancelWorkflow()]:(m("editing:unsupported-workflow","Update workflow is unsupported or disabled."),[2]);case 1:return r.sent(),(t=this._createUpdateWorkflow("editing-existing-feature")).data.edits.feature=e,[4,t.start()];case 2:return r.sent(),this._set("activeWorkflow",t),[2]}}))}))},t.prototype.deleteFeatureFromWorkflow=function(){return r.__awaiter(this,void 0,void 0,(function(){var e;return r.__generator(this,(function(t){switch(t.label){case 0:return(e=this.activeWorkflow)&&"create"!==e.type?[4,this._delete(e.data.edits.feature)]:(m("editing:unsupported-workflow","Deleting requires an active update workflow."),[2]);case 1:return t.sent(),[4,e.reset()];case 2:return t.sent(),[2]}}))}))},t.prototype.cancelWorkflow=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){return[2,this._cancelWorkflow(r.__assign({warn:!0},e))]}))}))},t.prototype.refreshCreationTemplates=function(){this.featureTemplatesViewModel.layers=this.editableItems.filter((function(e){return e.supports.indexOf("create")>-1})).map((function(e){return e.layer})).toArray()},t.prototype._cancelWorkflow=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(r){switch(r.label){case 0:return(t=this.activeWorkflow)?!e||!1!==e.force?(this.emit("workflow-cancel"),this._set("activeWorkflow",null),[4,t.cancel(e)]):[3,2]:(e&&e.warn&&m("editing:no-active-workflow","There is no active workflow to cancel."),[2]);case 1:return r.sent(),[2];case 2:return[4,t.cancel(e)];case 3:return r.sent(),this._set("activeWorkflow",null),[2]}}))}))},t.prototype._createCreateWorkflow=function(e){var t=this;return w.create(this,e,(function(e){return t._create(e)}))},t.prototype._createUpdateWorkflow=function(e){var t=this;return h.create(this,e,(function(e){return t._update(e)}))},t.prototype._create=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){switch(t.label){case 0:return[4,this._applyEdits(e.layer,{addFeatures:[e]})];case 1:return t.sent(),[2]}}))}))},t.prototype._delete=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){switch(t.label){case 0:return[4,this._applyEdits(e.layer,{deleteFeatures:[e]})];case 1:return t.sent(),[2]}}))}))},t.prototype._update=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){switch(t.label){case 0:return[4,this._applyEdits(e.layer,{updateFeatures:[e]})];case 1:return t.sent(),[2]}}))}))},t.prototype._applyEdits=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var o;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,this._queueOperation((function(){return e.applyEdits(t)}))];case 1:return r.sent(),[4,this.view.whenLayerView(e)];case 2:return o=r.sent(),[4,c.whenFalseOnce(o,"updating")];case 3:return r.sent(),[2]}}))}))},t.prototype._queueOperation=function(e){var t=this;this.activityQueue.push(e),this.notifyChange("syncing");var n=function(e,t){var r=t.indexOf(e);r>-1&&t.splice(r,1)};return e().then((function(e){var t=e.addFeatureResults,r=e.deleteFeatureResults,n=e.updateFeatureResults,a=o.find(t,(function(e){return!!e.error}))||o.find(n,(function(e){return!!e.error}))||o.find(r,(function(e){return!!e.error}));if(a)throw a.error})).catch((function(o){m("editing:operation-error","An error occurred.",{error:o});var a={error:o,retry:function(){return n(a,t.failures),t._queueOperation(e)},cancel:function(){n(a,t.failures)}};t._set("failures",r.__spreadArrays(t.failures,[a]))})).then((function(){n(e,t.activityQueue),t.notifyChange("syncing")}))},r.__decorate([l.property({readOnly:!0})],t.prototype,"activeWorkflow",void 0),r.__decorate([l.property({readOnly:!0})],t.prototype,"activityQueue",void 0),r.__decorate([l.property({value:r.__spreadArrays(b)})],t.prototype,"allowedWorkflows",null),r.__decorate([l.property({readOnly:!0,dependsOn:["editableItems"]})],t.prototype,"canCreate",null),r.__decorate([l.property({readOnly:!0,dependsOn:["editableItems"]})],t.prototype,"canUpdate",null),r.__decorate([l.property({dependsOn:["allowedWorkflows","layerInfos","view.allLayerViews","view.ready"],readOnly:!0})],t.prototype,"editableItems",null),r.__decorate([l.property({readOnly:!0})],t.prototype,"failures",void 0),r.__decorate([l.property()],t.prototype,"attachmentsViewModel",void 0),r.__decorate([l.property()],t.prototype,"featureFormViewModel",void 0),r.__decorate([l.property()],t.prototype,"featureTemplatesViewModel",void 0),r.__decorate([l.property()],t.prototype,"layerInfos",void 0),r.__decorate([l.property()],t.prototype,"sketchViewModel",void 0),r.__decorate([l.property()],t.prototype,"spinnerViewModel",void 0),r.__decorate([l.property({dependsOn:["attachmentsViewModel.mode","editableItems","activeWorkflow.stepId","view.ready"]})],t.prototype,"state",null),r.__decorate([l.property({readOnly:!0})],t.prototype,"syncing",null),r.__decorate([l.property()],t.prototype,"view",null),t=r.__decorate([l.subclass("esri.widgets.Editor.EditorViewModel")],t)}(s.HandleOwnerMixin(i.EventedAccessor))}));