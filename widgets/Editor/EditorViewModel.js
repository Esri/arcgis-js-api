/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/has","../../core/Logger","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/aliasOf","../../core/accessorSupport/decorators/subclass","../../core/Error","../../core/urlUtils","../../core/uuid","../../portal/support/resourceExtension","../../core/Evented","../../core/Collection","../../core/watchUtils","../../core/HandleOwner","../../layers/GraphicsLayer","../Attachments/AttachmentsViewModel","../Spinner/SpinnerViewModel","../../views/interactive/snapping/SnappingOptions","../FeatureForm/FeatureFormViewModel","../FeatureTemplates/FeatureTemplatesViewModel","../../layers/graphics/editingSupport","./CreateWorkflow","./UpdateWorkflow","../Sketch/SketchViewModel"],(function(e,t,r,a,o,i,n,s,l,c,d,p,u,w,f,h,y,k,_,v,g,W,m,b,C,M){"use strict";const O="esri.widgets.Editor.EditorViewModel",V=a.getLogger(O),F=["create","update"];function U(e,t,r){V.error(new l(e,t,r))}function E(e){return e&&m.isEditableLayer(e.layer)}function A(e,t){return e&&e.find((e=>e.layer===t))}const I="all-layer-views-prop-watcher";let S=function(t){function r(e){var r;return(r=t.call(this,e)||this)._sketchGraphicsLayer=new y({listMode:"hide",internal:!0}),r.activeWorkflow=null,r.activityQueue=[],r.failures=[],r.attachmentsViewModel=new k({abilities:{editing:!0}}),r.featureFormViewModel=new g,r.featureTemplatesViewModel=new W,r.layerInfos=null,r.sketchViewModel=new M({layer:r._sketchGraphicsLayer}),r.snappingOptions=new v,r.spinnerViewModel=new _,r}e._inheritsLoose(r,t);var a=r.prototype;return a.initialize=function(){this.handles.add([f.on(this,"activeWorkflow","cancel",(()=>this.emit("workflow-cancel"))),f.on(this,"activeWorkflow","commit",(()=>this.emit("workflow-commit"))),f.on(this,"view.allLayerViews","change",(()=>{this.handles.remove(I),this.notifyChange("editableItems")})),f.watch(this,"editableItems",(()=>{const{activeWorkflow:e}=this;if(!e)return;const{stepId:t}=e;if("create"===e.type)return this.refreshCreationTemplates(),void("awaiting-feature-creation-info"!==t||this.canCreate||this._cancelWorkflow());"update"===e.type&&("awaiting-feature-to-update"===t&&!this.canUpdate||"awaiting-update-feature-candidate"===t&&!e.data.candidates.some((e=>{const t=this.editableItems.find((t=>t.layer===e.layer));return t&&t.supports.indexOf("update")>-1})))&&this._cancelWorkflow()}))])},a.destroy=function(){this._cancelWorkflow().then((()=>this.view=null))},a.startCreateWorkflowAtFeatureTypeSelection=async function(){if(!this.canCreate)return void U("editing:unsupported-workflow","Create workflow is unsupported or disabled.");await this._cancelWorkflow();const e=this._createCreateWorkflow();await e.start(),this._set("activeWorkflow",e)},a.startCreateWorkflowAtFeatureCreation=async function(e){if(!this.canCreate)return void U("editing:unsupported-workflow","Update workflow is unsupported or disabled.");await this._cancelWorkflow();const t=this._createCreateWorkflow("awaiting-feature-to-create");t.data.creationInfo=e,await t.start(),this._set("activeWorkflow",t)},a.startCreateWorkflowAtFeatureEdit=async function(e){if(!this.canCreate)return void U("editing:unsupported-workflow","Update workflow is unsupported or disabled.");await this._cancelWorkflow();const t=this._createCreateWorkflow("editing-new-feature");t.data.edits.feature=e,await t.start(),this._set("activeWorkflow",t)},a.startUpdateWorkflowAtFeatureSelection=async function(){if(!this.canUpdate)return void U("editing:unsupported-workflow","Update workflow is unsupported or disabled.");await this._cancelWorkflow();const e=this._createUpdateWorkflow();await e.start(),this._set("activeWorkflow",e)},a.startUpdateWorkflowAtMultipleFeatureSelection=async function(e){if(!this.canUpdate)return void U("editing:unsupported-workflow","Update workflow is unsupported or disabled.");await this._cancelWorkflow();const t=this._createUpdateWorkflow("awaiting-update-feature-candidate");t.data.candidates=e,await t.start(),this._set("activeWorkflow",t)},a.startUpdateWorkflowAtFeatureEdit=async function(e){if(!this.canUpdate)return void U("editing:unsupported-workflow","Update workflow is unsupported or disabled.");await this._cancelWorkflow();const t=this._createUpdateWorkflow("editing-existing-feature");t.data.edits.feature=e,await t.start(),this._set("activeWorkflow",t)},a.deleteFeatureFromWorkflow=async function(){const{activeWorkflow:e}=this;e&&"create"!==e.type?(await this._delete(e.data.edits.feature),await e.reset()):U("editing:unsupported-workflow","Deleting requires an active update workflow.")},a.cancelWorkflow=async function(e){return this._cancelWorkflow({warn:!0,...e})},a.refreshCreationTemplates=function(){this.featureTemplatesViewModel.layers=this.editableItems.filter((({supports:e})=>e.indexOf("create")>-1)).map((({layer:e})=>e)).toArray()},a._cancelWorkflow=async function(e){const t=this.activeWorkflow;if(!t)return void(e&&e.warn&&U("editing:no-active-workflow","There is no active workflow to cancel."));if(!e||!1!==e.force)return this.emit("workflow-cancel"),this._set("activeWorkflow",null),void await t.cancel(e);await t.cancel(e),this._set("activeWorkflow",null)},a._createCreateWorkflow=function(e){return b.create(this,e,(e=>this._create(e)))},a._createUpdateWorkflow=function(e){return C.create(this,e,(e=>this._update(e)))},a._create=async function(e){await this._applyEdits(e.layer,{addFeatures:[e]})},a._delete=async function(e){await this._applyEdits(e.layer,{deleteFeatures:[e]})},a._update=async function(e){await this._applyEdits(e.layer,{updateFeatures:[e]})},a._applyEdits=async function(e,t){await this._queueOperation((()=>e.applyEdits(t)));const r=await this.view.whenLayerView(e);await f.whenFalseOnce(r,"updating")},a._queueOperation=function(e){this.activityQueue.push(e),this.notifyChange("syncing");const t=(e,t)=>{const r=t.indexOf(e);r>-1&&t.splice(r,1)};return e().then((({addFeatureResults:e,deleteFeatureResults:t,updateFeatureResults:r})=>{const a=e.find((e=>!!e.error))||r.find((e=>!!e.error))||t.find((e=>!!e.error));if(a)throw a.error})).catch((r=>{U("editing:operation-error","An error occurred.",{error:r});const a={error:r,retry:()=>(t(a,this.failures),this._queueOperation(e)),cancel:()=>{t(a,this.failures)}};this._set("failures",[...this.failures,a])})).then((()=>{t(e,this.activityQueue),this.notifyChange("syncing")}))},e._createClass(r,[{key:"allowedWorkflows",get:function(){return this._get("allowedWorkflows")},set:function(e){e&&0!==e.length||(e=[...F]),this._set("allowedWorkflows",e)}},{key:"canCreate",get:function(){return this.editableItems.some((e=>e.supports.indexOf("create")>-1))}},{key:"canUpdate",get:function(){return this.editableItems.some((e=>e.supports.indexOf("update")>-1))}},{key:"editableItems",get:function(){const e=this.get("view.allLayerViews");if(!e)return new w;const t=()=>this.notifyChange("editableItems");return e.filter(E).map((e=>{this.handles.add(f.watch(e,["suspended","layer.editingEnabled"],t),I);const{layer:r,suspended:a}=e,{data:o,operations:i}=r.capabilities,n=A(this.layerInfos,r),s="supportsAttachment"in o&&o.supportsAttachment&&(!n||!1!==n.allowAttachments);if(a)return{hasAttachments:s,layer:r,supports:[]};const l=this.allowedWorkflows.filter((e=>!n||!1!==n.enabled&&("create"===e&&!1!==n.addEnabled||"update"===e&&!1!==n.updateEnabled))),c=e=>l.find((t=>t===e)),d=[];return c("create")&&i.supportsAdd&&d.push("create"),c("update")&&i.supportsUpdate&&d.push("update"),!1!==(n&&n.deleteEnabled)&&i.supportsDelete&&d.push("delete"),{hasAttachments:s,layer:r,supports:d}})).reverse()}},{key:"state",get:function(){if(!this.get("view.ready")||0===this.editableItems.length)return"disabled";const e=this.attachmentsViewModel.mode;if("add"===e)return"adding-attachment";if("edit"===e)return"editing-attachment";const{activeWorkflow:t}=this;return t?t.stepId:"ready"}},{key:"syncing",get:function(){return this.activityQueue.length>0}},{key:"view",set:function(e){this.sketchViewModel.view=e,this.spinnerViewModel.view=e,this._set("view",e)}}]),r}(h.HandleOwnerMixin(u.EventedAccessor));return t.__decorate([i.property({readOnly:!0})],S.prototype,"activeWorkflow",void 0),t.__decorate([i.property({readOnly:!0})],S.prototype,"activityQueue",void 0),t.__decorate([i.property({value:[...F]})],S.prototype,"allowedWorkflows",null),t.__decorate([i.property({readOnly:!0})],S.prototype,"canCreate",null),t.__decorate([i.property({readOnly:!0})],S.prototype,"canUpdate",null),t.__decorate([i.property({readOnly:!0})],S.prototype,"editableItems",null),t.__decorate([i.property({readOnly:!0})],S.prototype,"failures",void 0),t.__decorate([i.property()],S.prototype,"attachmentsViewModel",void 0),t.__decorate([i.property()],S.prototype,"featureFormViewModel",void 0),t.__decorate([i.property()],S.prototype,"featureTemplatesViewModel",void 0),t.__decorate([i.property()],S.prototype,"layerInfos",void 0),t.__decorate([i.property()],S.prototype,"sketchViewModel",void 0),t.__decorate([n.aliasOf("sketchViewModel.snappingOptions")],S.prototype,"snappingOptions",void 0),t.__decorate([i.property()],S.prototype,"spinnerViewModel",void 0),t.__decorate([i.property()],S.prototype,"state",null),t.__decorate([i.property({readOnly:!0})],S.prototype,"syncing",null),t.__decorate([i.property()],S.prototype,"view",null),S=t.__decorate([s.subclass(O)],S),S}));
