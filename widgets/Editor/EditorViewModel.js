/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/asyncUtils","../../core/Collection","../../core/deprecate","../../core/Error","../../core/Evented","../../core/HandleOwner","../../core/Logger","../../core/maybe","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/accessorSupport/decorators/subclass","../../layers/GraphicsLayer","../../layers/support/layerUtils","../../portal/support/urlUtils","../Attachments/AttachmentsViewModel","./CreateFeaturesWorkflow","./CreateWorkflow","./deprecationUtils","./UpdateWorkflow","./workflowUtils","../FeatureForm/FeatureFormViewModel","../FeatureTemplates/FeatureTemplatesViewModel","../Sketch/SketchViewModel","../Spinner/SpinnerViewModel"],(function(e,t,r,a,o,i,n,s,l,c,d,u,p,f,y,h,w,_,k,m,g,v,b,W,C,E,F,T){"use strict";const I="esri.widgets.Editor.EditorViewModel",O=l.getLogger(I),U=["create","create-features","update"];function A(e,t,r){O.error(new i(e,t,r))}function M(e,t){return e?e.find((e=>e.layer===t)):void 0}let V=function(t){function n(r){var o;return(o=t.call(this,r)||this)._sketchGraphicsLayer=new h({listMode:"hide",internal:!0}),o._updateEditableItemsTask=null,o.activeWorkflow=null,o._activityQueue=[],o.editableItems=new a,o.failures=[],o.attachmentsViewModel=new k({abilities:{editing:!0}}),o.featureFormViewModel=new C,o.featureTemplatesViewModel=new E,o.sketchViewModel=new F({layer:o._sketchGraphicsLayer}),o.spinnerViewModel=new T,o.pageStack=[],o.showDiscardPrompt=()=>Promise.resolve(),o._candidateCommitted=!1,o.back=e._asyncToGenerator((function*(){const e=o.activeWorkflow;if(e&&o.canGoBack){if(o.hasPendingEdits)try{yield o.showDiscardPrompt()}catch(t){return}e.hasPreviousStep?yield e.previous({cancelCurrentStep:!0}):yield o.cancelWorkflow({force:!0})}})),o.save=()=>{const{featureFormViewModel:t}=e._assertThisInitialized(o);t.submit(),!t.submittable||t.validateContingencyConstraints(t.getValues(),{includeIncompleteViolations:!0}).length>0||o.activeWorkflow?.commit()},o.selectFeature=(e,t=!1)=>{const r=o.activeWorkflow;o._candidateCommitted||"update"!==r?.type||(r.data.edits.feature=e,t&&(r.next(),o._candidateCommitted=!0))},o}e._inheritsLoose(n,t);var s=n.prototype;return s.initialize=function(){this.handles.add([d.watch((()=>{const e=this.view?.map?.editableLayers.filter((({parent:e,visible:t})=>e&&"visible"in e?t&&e.visible:t)),t=this.view?.allLayerViews,r=t?.filter((t=>!!e?.includes(t.layer)&&!t.suspended));return[e,r,this.layerInfos,this.allowedWorkflows]}),(()=>this._updateEditableItems()),d.initial),d.on((()=>this.activeWorkflow),"cancel",(()=>this.emit("workflow-cancel"))),d.on((()=>this.activeWorkflow),"commit",(()=>this.emit("workflow-commit"))),d.when((()=>this.view?.map),(e=>{e.add(this._sketchGraphicsLayer)}),d.initial),d.watch((()=>this.editableItems.toArray()),(()=>{const{activeWorkflow:e}=this;if(this.refreshCreationTemplates(),!e)return;const{stepId:t}=e;"create"!==e.type?"update"===e.type&&("awaiting-feature-to-update"===t&&!this.canUpdate||"awaiting-update-feature-candidate"===t&&!e.data.candidates.some((e=>{const t=this.editableItems.find((t=>t.layer===e.layer));return t&&t.supports.includes("update")})))&&this._cancelWorkflow():"awaiting-feature-creation-info"!==t||this.canCreate||this._cancelWorkflow()})),d.watch((()=>this.page),((e,t)=>{const r=this.pageStack.slice(),a=r.indexOf(e);-1===a&&t?r.push(t):r.splice(a),this.pageStack=r})),d.when((()=>"awaiting-update-feature-candidate"===this.state),(()=>this._candidateCommitted=!1))])},s.destroy=function(){this._cancelWorkflow().then((()=>{this.view?.map&&this.view.map.remove(this._sketchGraphicsLayer),this.view=null})),this._updateEditableItemsTask=c.abortMaybe(this._updateEditableItemsTask)},s.startCreateWorkflowAtFeatureTypeSelection=function(){var t=e._asyncToGenerator((function*(){if(v.workflowDeprecation(O,"startCreateWorkflowAtFeatureTypeSelection","startCreateFeaturesWorkflowAtFeatureTypeSelection"),yield d.whenOnce((()=>!this.updating)),!this.canCreate)return void A("editing:unsupported-workflow","Create workflow is unsupported or disabled.");yield this._cancelWorkflow();const e=this._createCreateWorkflow();yield e.start(),this._set("activeWorkflow",e)}));function r(){return t.apply(this,arguments)}return r}(),s.startCreateFeaturesWorkflowAtFeatureTypeSelection=function(){var t=e._asyncToGenerator((function*(){return this.startCreateFeaturesWorkflow()}));function r(){return t.apply(this,arguments)}return r}(),s.startCreateWorkflowAtFeatureCreation=function(){var t=e._asyncToGenerator((function*(e){if(v.workflowDeprecation(O,"startCreateWorkflowAtFeatureCreation","startCreateFeaturesWorkflowAtFeatureCreation"),yield d.whenOnce((()=>!this.updating)),!this.canCreate)return void A("editing:unsupported-workflow","Create workflow is unsupported or disabled.");yield this._cancelWorkflow();const t=this._createCreateWorkflow("awaiting-feature-to-create");t.data.creationInfo=e,yield t.start(),this._set("activeWorkflow",t)}));function r(e){return t.apply(this,arguments)}return r}(),s.startCreateFeaturesWorkflowAtFeatureCreation=function(){var t=e._asyncToGenerator((function*(e){return this.startCreateFeaturesWorkflow(e,"creating-features")}));function r(e){return t.apply(this,arguments)}return r}(),s.startCreateFeaturesWorkflow=function(){var t=e._asyncToGenerator((function*(e,t="awaiting-feature-creation-info"){if(yield d.whenOnce((()=>!this.updating)),!this.canCreate)throw new i("editing:unsupported-workflow","Creating features is unsupported or disabled.");yield this._cancelWorkflow();const r=this._createCreateFeaturesWorkflow(e,t);yield r.start(),this._set("activeWorkflow",r)}));function r(e){return t.apply(this,arguments)}return r}(),s.startCreateWorkflowAtFeatureEdit=function(){var t=e._asyncToGenerator((function*(e){if(v.workflowDeprecation(O,"startCreateWorkflowAtFeatureEdit"),yield d.whenOnce((()=>!this.updating)),!this.canCreate)return void A("editing:unsupported-workflow","Create workflow is unsupported or disabled.");yield this._cancelWorkflow();const t=this._createCreateWorkflow("editing-new-feature");t.data.edits.feature=e,yield t.start(),this._set("activeWorkflow",t)}));function r(e){return t.apply(this,arguments)}return r}(),s.startUpdateWorkflowAtFeatureSelection=function(){var t=e._asyncToGenerator((function*(){if(yield d.whenOnce((()=>!this.updating)),!this.canUpdate)return void A("editing:unsupported-workflow","Update workflow is unsupported or disabled.");yield this._cancelWorkflow();const e=this._createUpdateWorkflow();yield e.start(),this._set("activeWorkflow",e)}));function r(){return t.apply(this,arguments)}return r}(),s.startUpdateWorkflowAtMultipleFeatureSelection=function(){var t=e._asyncToGenerator((function*(e){if(yield d.whenOnce((()=>!this.updating)),!this.canUpdate)return void A("editing:unsupported-workflow","Update workflow is unsupported or disabled.");yield this._cancelWorkflow();const t=this._createUpdateWorkflow("awaiting-update-feature-candidate");t.data.candidates=e,yield t.start(),this._set("activeWorkflow",t)}));function r(e){return t.apply(this,arguments)}return r}(),s.startUpdateWorkflowAtFeatureEdit=function(){var t=e._asyncToGenerator((function*(e){if(yield d.whenOnce((()=>!this.updating)),!this.canUpdate)return void A("editing:unsupported-workflow","Update workflow is unsupported or disabled.");yield this._cancelWorkflow();const t=this._createUpdateWorkflow("editing-existing-feature");t.data.edits.feature=e,yield t.start(),this._set("activeWorkflow",t)}));function r(e){return t.apply(this,arguments)}return r}(),s.deleteFeatureFromWorkflow=function(){var t=e._asyncToGenerator((function*(){const{activeWorkflow:e}=this;e&&"update"===e.type?(yield this._delete(e.data.edits.feature),yield e.reset()):A("editing:unsupported-workflow","Deleting requires an active update workflow.")}));function r(){return t.apply(this,arguments)}return r}(),s.cancelWorkflow=function(){var t=e._asyncToGenerator((function*(e){return this._cancelWorkflow({warn:!0,...e})}));function r(e){return t.apply(this,arguments)}return r}(),s.findEditableItemForLayer=function(e){const t="subtype-sublayer"===e.type?e.parent:e;return this.editableItems.find((e=>e.layer===t))},s.refreshCreationTemplates=function(){const e=[];for(const{layer:t,supports:r}of this.editableItems)t.loaded&&r.includes("create")&&e.push(t);this.featureTemplatesViewModel.layers=e},s._updateEditableItems=function(){var t=e._asyncToGenerator((function*(){var t=this;c.abortMaybe(this._updateEditableItemsTask);const o=r.createTask(function(){var r=e._asyncToGenerator((function*(e){const r=t.view?.allLayerViews,o=t.view?.map?.editableLayers;if(!r||!o)return;const i=new Set(o),n=o?.filter((e=>{const t=w.getEffectiveLayerCapabilities(e)?.operations;return!(!e.visible||!t?.supportsAdd||t?.supportsQuery)})),s=r.filter((e=>i.has(e.layer))),l=[];for(const a of s.reverse()){const{layer:e,suspended:r}=a;"subtype-group"===e.type?(yield e.loadAll(),l.push(...e.sublayers.slice().reverse().map((e=>t._makeEditableItemForLayer(e,r))))):l.push(t._makeEditableItemForLayer(e,r))}for(const a of n.reverse())"subtype-group"===a.type?(yield a.loadAll(),l.push(...a.sublayers.map((e=>t._makeEditableItemForLayer(e,!1))))):l.push(t._makeEditableItemForLayer(a,!1));if(e.aborted)return;const c=t.editableItems;t.editableItems=new a(l),c.destroy()}));return function(e){return r.apply(this,arguments)}}());this.updatingHandles.addPromise(o.promise),this._updateEditableItemsTask=o}));function o(){return t.apply(this,arguments)}return o}(),s._cancelWorkflow=function(){var t=e._asyncToGenerator((function*(e){const t=this.activeWorkflow;if(!t)return void(e&&e.warn&&A("editing:no-active-workflow","There is no active workflow to cancel."));if(!e||!1!==e.force)return this.emit("workflow-cancel"),this._set("activeWorkflow",null),void(yield t.cancel(e));yield t.cancel(e),this._set("activeWorkflow",null)}));function r(e){return t.apply(this,arguments)}return r}(),s._createCreateFeaturesWorkflow=function(e,t){return m.create(this,e,t,((e,t,r)=>this._applyEdits(e,t,r)),((e,t)=>this._addAttachments(e,t)))},s._createCreateWorkflow=function(e){return g.create(this,e,((e,t,r)=>this._applyEdits(e,t,r)))},s._createUpdateWorkflow=function(e){return b.create(this,e,((e,t)=>this._applyEdits(e,t)))},s._delete=function(){var t=e._asyncToGenerator((function*(e){const t=e?.sourceLayer;t&&"applyEdits"in t&&(yield this._applyEdits(t,{deleteFeatures:[e]}))}));function r(e){return t.apply(this,arguments)}return r}(),s._addAttachments=function(e,t){const r=[];return t?.forEach((t=>r.push(this._addAttachment(e,t.feature,t.attachment)))),Promise.all(r)},s._addAttachment=function(){var t=e._asyncToGenerator((function*(t,r,a){let o=null;if("geojson"===t.type||"scene"===t.type||"oriented-imagery"===t.type)throw new i("editor:attachments-not-supported","Adding attachments is not supported for this layer type");return yield this._queueOperation(e._asyncToGenerator((function*(){return o=(yield t.addAttachment?.(r,a).catch((e=>{throw e?.error||e})))??null,o}))),o}));function r(e,r,a){return t.apply(this,arguments)}return r}(),s._applyEdits=function(){var t=e._asyncToGenerator((function*(t,r,a){var o=this;let i=null;const n=t.url?yield w.getOwningPortalUrl(t.url):null,s={returnServiceEditsOption:(!n||!_.parseKnownArcGISOnlineDomain(n))&&!RegExp("/hosted/","i").test(t.url)?"original-and-current-features":void 0,...a};return yield this._queueOperation(e._asyncToGenerator((function*(){if(w.getEffectiveLayerCapabilities(t)?.operations.supportsQuery){const e=yield W.whenEditorLayerView(o.view,t);return i=yield t.applyEdits(r,s),yield d.whenOnce((()=>!e.updating)),i}return i=yield t.applyEdits(r,s),i}))),i}));function r(e,r,a){return t.apply(this,arguments)}return r}(),s._queueOperation=function(e){this._activityQueue.push(e),this.notifyChange("syncing");const t=(e,t)=>{const r=t.indexOf(e);r>-1&&t.splice(r,1)};return e().then((e=>{if("error"in e&&e.error)throw e.error;if("addFeatureResults"in e){const{addFeatureResults:t,deleteFeatureResults:r,updateFeatureResults:a}=e,o=t.find((e=>!!e.error))||a.find((e=>!!e.error))||r.find((e=>!!e.error));if(o)throw o.error}return e})).catch((r=>{A("editing:operation-error","An error occurred.",{error:r});const a={error:r,retry:()=>(t(a,this.failures),this._queueOperation(e)),cancel:()=>{t(a,this.failures)}};this._set("failures",[...this.failures,a])})).then((()=>{t(e,this._activityQueue),this.notifyChange("syncing")}))},s._makeEditableItemForLayer=function(e,t=!0){const r=w.getEffectiveLayerCapabilities(e),a=r?.operations,o=M(this.layerInfos,e),i=this.allowedWorkflows,n=i.includes("create")||i.includes("create-features"),s=i.includes("update"),l=e=>!o||!1!==o.enabled&&!1!==o[e],c=n&&!!a?.supportsAdd&&l("addEnabled"),d=s&&!!a?.supportsUpdate&&l("updateEnabled"),u=s&&!!a?.supportsDelete&&l("deleteEnabled"),p=[];t||(c&&p.push("create"),d&&p.push("update"),u&&p.push("delete"));const f=d&&(!o||!1!==o.attributeUpdatesEnabled),y=d&&!!r?.editing?.supportsGeometryUpdate&&(!o||!1!==o.geometryUpdatesEnabled),h=!(!r?.data?.supportsAttachment||o&&!1===o.allowAttachments);return{layer:e,supports:p,attributeUpdatesEnabled:f,geometryUpdatesEnabled:y,hasAttachments:h,attachmentsOnCreateEnabled:h&&n&&(!o||!1!==o.attachmentsOnCreateEnabled),attachmentsOnUpdateEnabled:h&&(!o||!1!==o.attachmentsOnUpdateEnabled)}},e._createClass(n,[{key:"allowedWorkflows",get:function(){return this._get("allowedWorkflows")},set:function(e){e&&0!==e.length||(e=[...U]),this._set("allowedWorkflows",e)}},{key:"canCreate",get:function(){return this.editableItems.some((e=>e.supports.includes("create")))}},{key:"canUpdate",get:function(){return this.editableItems.some((e=>e.supports.includes("update")||e.supports.includes("delete")||e.attachmentsOnUpdateEnabled))}},{key:"labelOptions",get:function(){return this.sketchViewModel.labelOptions},set:function(e){this.sketchViewModel.labelOptions=e}},{key:"layerInfos",set:function(e){e?.some((e=>("allowAttachments"in e&&o.deprecated(O,"Property: layerInfo.allowAttachments",{replacement:"layerInfo.attachmentsOnCreateEnabled or layerInfo.attachmentsOnUpdateEnabled",version:"4.26"}),!0))),this._set("layerInfos",e)}},{key:"snappingOptions",get:function(){return this.sketchViewModel.snappingOptions},set:function(e){this.sketchViewModel.snappingOptions=e}},{key:"state",get:function(){if(!this.get("view.ready")||0===this.editableItems.length)return"disabled";const e=this.attachmentsViewModel.mode;if("add"===e)return"adding-attachment";if("edit"===e)return"editing-attachment";const{activeWorkflow:t}=this;return t?t.stepId:"ready"}},{key:"syncing",get:function(){return this._activityQueue.length>0}},{key:"updating",get:function(){return this.updatingHandles.updating}},{key:"tooltipOptions",get:function(){return this.sketchViewModel.tooltipOptions},set:function(e){this.sketchViewModel.tooltipOptions=e}},{key:"view",set:function(e){this.sketchViewModel.view=e,this.spinnerViewModel.view=e,this._set("view",e)}},{key:"page",get:function(){const{activeWorkflow:e,state:t}=this;return"awaiting-feature-to-update"===t||"awaiting-feature-to-create"===t||"create-features"===e?.type&&0===e.pendingFeatures.length?"ready":t??"disabled"}},{key:"selectedTemplateItem",get:function(){const{activeWorkflow:e}=this;if("create-features"===e?.type&&0===e.pendingFeatures.length){const{template:t}=e.data.creationInfo;for(const e of this.featureTemplatesViewModel.items)if("findByTemplate"in e){const r=e.findByTemplate(t);if(r)return r}else if(e.template===t)return e}}},{key:"featureFormDisabled",get:function(){const{activeWorkflow:e}=this;return"update"===e?.type&&!1===e?.data.editableItem?.attributeUpdatesEnabled}},{key:"canGoBack",get:function(){return c.isSome(this.activeWorkflow)&&!this.syncing}},{key:"shouldShowDeleteButton",get:function(){const{activeWorkflow:e}=this;return!!e&&"update"===e.type&&e.data.editableItem.supports.includes("delete")}},{key:"hasPendingEdits",get:function(){const{activeWorkflow:e}=this;return!!e&&("create"===e.type||"create-features"===e.type&&e.numPendingFeatures>0||"editing-existing-feature"===e.stepId&&e.data.edits.modified)}}]),n}(s.HandleOwnerMixin(n.EventedAccessor));t.__decorate([u.property({readOnly:!0})],V.prototype,"activeWorkflow",void 0),t.__decorate([u.property({readOnly:!0})],V.prototype,"_activityQueue",void 0),t.__decorate([u.property({value:[...U]})],V.prototype,"allowedWorkflows",null),t.__decorate([u.property({readOnly:!0})],V.prototype,"canCreate",null),t.__decorate([u.property({readOnly:!0})],V.prototype,"canUpdate",null),t.__decorate([u.property()],V.prototype,"editableItems",void 0),t.__decorate([u.property({readOnly:!0})],V.prototype,"failures",void 0),t.__decorate([u.property()],V.prototype,"attachmentsViewModel",void 0),t.__decorate([u.property()],V.prototype,"featureFormViewModel",void 0),t.__decorate([u.property()],V.prototype,"featureTemplatesViewModel",void 0),t.__decorate([u.property()],V.prototype,"labelOptions",null),t.__decorate([u.property()],V.prototype,"layerInfos",null),t.__decorate([u.property()],V.prototype,"sketchViewModel",void 0),t.__decorate([u.property()],V.prototype,"snappingOptions",null),t.__decorate([u.property()],V.prototype,"spinnerViewModel",void 0),t.__decorate([u.property()],V.prototype,"state",null),t.__decorate([u.property({readOnly:!0})],V.prototype,"syncing",null),t.__decorate([u.property()],V.prototype,"updating",null),t.__decorate([u.property()],V.prototype,"tooltipOptions",null),t.__decorate([u.property()],V.prototype,"view",null),t.__decorate([u.property()],V.prototype,"pageStack",void 0),t.__decorate([u.property()],V.prototype,"showDiscardPrompt",void 0),t.__decorate([u.property()],V.prototype,"_candidateCommitted",void 0),t.__decorate([u.property()],V.prototype,"page",null),t.__decorate([u.property()],V.prototype,"selectedTemplateItem",null),t.__decorate([u.property()],V.prototype,"featureFormDisabled",null),t.__decorate([u.property()],V.prototype,"canGoBack",null),t.__decorate([u.property()],V.prototype,"shouldShowDeleteButton",null),t.__decorate([u.property()],V.prototype,"hasPendingEdits",null),V=t.__decorate([y.subclass(I)],V);return V}));
