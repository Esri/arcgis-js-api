/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["require","../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../intl","../core/deprecate","../core/HandleOwner","../core/Logger","../core/maybe","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/arrayUtils","../core/accessorSupport/decorators/cast","../core/accessorSupport/decorators/subclass","./Widget","./FeatureTable/FeatureTableViewModel","./FeatureTable/Grid/support/ButtonMenu","./FeatureTable/Grid/support/ButtonMenuItem","./support/Heading","./support/widgetUtils","./support/decorators/messageBundle","./support/jsxFactory","../intl/substitute"],(function(e,t,i,n,o,l,s,r,a,c,d,u,h,p,g,m,f,_,y,v,b,w){"use strict";const M={header:!0,menu:!0,menuItems:{clearSelection:!0,refreshData:!0,toggleColumns:!0,selectedRecordsShowAllToggle:!0,selectedRecordsShowSelectedToggle:!0,zoomToSelection:!0,deleteSelection:!0},selectionColumn:!0,columnMenus:!0},C={base:"esri-feature-table",header:"esri-feature-table__header",title:"esri-feature-table__title",content:"esri-feature-table__content",loader:"esri-feature-table__loader",loaderContainer:"esri-feature-table__loader-container",menuContainer:"esri-feature-table__menu",menuIcon:"esri-icon-handle-horizontal",menuItemGroupOpenedIcon:"esri-icon-down",menuItemGroupClosedIcon:"esri-icon-right",checkmarkIcon:"esri-icon-check-mark",promptContainer:"esri-feature-table__prompt",promptHeader:"esri-feature-table__prompt__header",promptHeading:"esri-feature-table__prompt__header__heading",promptMessage:"esri-feature-table__prompt__message",promptDivider:"esri-feature-table__prompt__divider",promptActions:"esri-feature-table__prompt__actions",widget:"esri-widget"},S=s.getLogger("esri.widgets.FeatureTable");let E=function(i){function n(e,n){var o;return(o=i.call(this,e,n)||this)._prompt=null,o.menu=null,o.menuConfig=null,o.viewModel=new g,o.visibleElements={...M},o._showDeletePrompt=o._showDeletePrompt.bind(t._assertThisInitialized(o)),o._onDeleteSelectionClick=o._onDeleteSelectionClick.bind(t._assertThisInitialized(o)),o}t._inheritsLoose(n,i);var l=n.prototype;return l.initialize=function(){this.handles.add([a.on((()=>this.viewModel.columns),"change",(()=>this._syncMenuConfig())),a.on((()=>this.viewModel.activeFilters),"change",(()=>this._syncMenuConfig())),a.on((()=>this.highlightIds),"change",(e=>{this._syncMenuConfig(),this._onSelectionChange(e)})),a.watch((()=>[this.viewModel.store.querying,this.viewModel.store.syncing,this.editingEnabled]),(()=>this.scheduleRender())),a.watch((()=>[this.menuConfig,this.editingEnabled]),(()=>this._syncMenuConfig())),a.watch((()=>this.messages),(()=>{this.menu.label=this.messages?.options,this._syncMenuConfig()}))]),this._set("menu",new m({label:this.messages?.options,iconClass:C.menuIcon,...this.menuConfig}));const{attachmentsEnabled:e,relatedRecordsEnabled:t}=this;this.viewModel?.store?.set({attachmentsEnabled:e,relatedRecordsEnabled:t})},l.loadDependencies=function(){return Promise.all([new Promise(((t,i)=>e(["../chunks/calcite-scrim"],t,i))),new Promise(((t,i)=>e(["../chunks/calcite-button"],t,i))),new Promise(((t,i)=>e(["../chunks/calcite-icon"],t,i)))])},l.destroy=function(){this._prompt=null,this.handles.removeAll(),this.menu?.destroy()},l.castVisibleElements=function(e){const t={...M,...e};return this.grid?.set("visibleElements",{...this.grid.visibleElements,selectionColumn:t.selectionColumn,columnMenus:t.columnMenus}),t},l.clearHighlights=function(){return o.deprecated(S,"`FeatureTable.clearHighlights` is deprecated in favor of FeatureTable.highlightIds'",{replacement:"FeatureTable.highlightIds",version:"4.25",see:"https://developers.arcgis.com/javascript/latest/api-reference/esri-widgets-FeatureTable.html#highlightIds"}),this.viewModel.clearHighlights()},l.clearSelection=function(){return o.deprecated(S,"`FeatureTable.clearSelection` is deprecated in favor of FeatureTable.highlightIds'",{replacement:"FeatureTable.highlightIds",version:"4.25",see:"https://developers.arcgis.com/javascript/latest/api-reference/esri-widgets-FeatureTable.html#highlightIds"}),this.viewModel.clearSelection()},l.clearSelectionFilter=function(){return this.viewModel.clearSelectionFilter()},l.deleteSelection=function(e){return this.highlightIds.length?e?(this._showDeletePrompt(),this.scheduleRender(),Promise.resolve()):this.viewModel.deleteSelection():Promise.resolve()},l.deselectRows=function(e){return this.viewModel.deselectRows(e)},l.filterBySelection=function(){return this.viewModel.filterBySelection()},l.findColumn=function(e){return this.viewModel.findColumn(e)},l.hideColumn=function(e){this.grid?.hideColumn(e),this._syncMenuConfig()},l.refresh=function(){return this.viewModel.refresh()},l.showAllColumns=function(){return this.viewModel.showAllColumns()},l.showColumn=function(e){this.grid?.showColumn(e),this._syncMenuConfig()},l.sortColumn=function(e,t){return this.viewModel.sortColumn(e,t)},l.selectRows=function(e){return this.viewModel.selectRows(e)},l.scrollToIndex=function(e){return this.viewModel.scrollToIndex(e)},l.zoomToSelection=function(){return this.viewModel.zoomToSelection()},l.render=function(){const{_prompt:e}=this,t=r.isSome(e)?b.tsx("calcite-scrim",null,this.renderPrompt(e)):null;return b.tsx("div",{bind:this,class:this.classes(C.base,C.widget)},this.visibleElements.header?this._renderHeader():null,b.tsx("div",{class:C.content},"disabled"!==this.state&&this.grid?.render()),t)},l.renderPrompt=function({title:e,message:t,context:i,actions:n}){const o=!!n.secondary,l=b.tsx("calcite-button",{appearance:"solid",color:"danger"===i?"red":"blue",width:o?"half":"full",onclick:n.primary.action,key:"prompt-primary-button"},n.primary.label),s=o?b.tsx("calcite-button",{appearance:"clear",color:"danger"===i?"red":"blue",width:"half",onclick:n.secondary.action,key:"prompt-secondary-button"},n.secondary.label):null;return b.tsx("div",{class:`${C.promptContainer}--${i}`},b.tsx("div",{class:C.promptHeader},b.tsx("calcite-icon",{icon:"exclamation-mark-triangle"}),b.tsx(_.Heading,{class:C.promptHeading,level:2},e)),b.tsx("div",{class:C.promptMessage},t),b.tsx("div",{class:C.promptDivider}),b.tsx("div",{class:C.promptActions},s,l))},l._renderHeader=function(){return b.tsx("div",{key:"header",class:C.header},this._renderLoader(),this._renderTitle(),this.visibleElements.menu?this._renderMenu():null)},l._renderTitle=function(){return b.tsx("div",{class:C.title,key:"title"},this._getTitle())},l._getTitle=function(){const{grid:e,highlightIds:t,layer:i,messages:n,viewModel:{size:o}}=this;return e&&i?w.substitute(n.header,{title:i.title,count:o,selected:t.length||0}):""},l._renderLoader=function(){const{state:e,store:t}=this.viewModel,i="loading"===e||t.syncing||t.querying;return b.tsx("div",{class:C.loaderContainer},i?b.tsx("div",{class:C.loader,key:"loader"}):null)},l._renderMenu=function(){return b.tsx("div",{class:C.menuContainer},this.menu.render())},l._onSelectionChange=function(e){const{added:t,removed:i}=e,n=t.map((e=>this.viewModel.store.getLocalItemByKey(e)||{objectId:e,feature:null,attachments:null,relatedRecords:null})),o=i.map((e=>this.viewModel.store.getLocalItemByKey(e)||{objectId:e,feature:null,attachments:null,relatedRecords:null}));this.emit("selection-change",{added:n,removed:o})},l._syncMenuConfig=function(){this.menu?.set({...this.menuConfig,items:this._getMenuItems()})},l._getMenuItems=function(){const e=this.menuConfig?.items,t=this._getDefaultMenuItems(),i=[];return t?.length&&i.push(...t),e?.length&&i.push(...e),i},l._getDefaultMenuItems=function(){const{highlightIds:e,messages:t,viewModel:i,visibleElements:n}=this,{menuItems:o}=n,l=[];if(o?.refreshData&&l.push(new f({selectionEnabled:!1,label:t?.refreshData,clickFunction:()=>this.refresh()})),e.length){const i=this._getSelectionFilter();if(o?.clearSelection&&l.push(new f({selectionEnabled:!1,label:t?.clearSelection,clickFunction:()=>this.highlightIds?.removeAll()})),o?.zoomToSelection&&this.view&&l.push(new f({selectionEnabled:!1,label:t?.zoomToSelection,clickFunction:()=>this.viewModel.zoomToSelection()})),o?.selectedRecordsShowSelectedToggle&&(!i||e.length!==i.objectIds.length)){const e=t.showSelected,i=new f({selectionEnabled:!1,label:e,clickFunction:()=>{this.filterBySelection(),i.set("label",e)}});l.push(i)}o?.deleteSelection&&this.editingEnabled&&this.layer?.capabilities?.operations?.supportsDelete&&l.push(new f({selectionEnabled:!1,label:t.deleteSelection,clickFunction:this._showDeletePrompt}))}if(o?.selectedRecordsShowAllToggle&&this._hasSelectionFilter()){const e=t.showAllRecords,i=new f({selectionEnabled:!1,label:e,clickFunction:()=>{this.clearSelectionFilter(),i.set("label",e)}});l.push(i)}return o?.toggleColumns&&l.push(new f({iconClass:C.menuItemGroupClosedIcon,label:t?.toggleColumns,clickFunction:this._toggleMenuItemSelectedIcon,items:i?.columns?.items.map((({header:e,hidden:t,path:i})=>new f({label:e||i,selected:!t,selectionEnabled:!0,iconClass:C.checkmarkIcon,clickFunction:()=>this._toggleColumnFromMenuItem(i)})))})),l.length?l:null},l._toggleMenuItemSelectedIcon=function({item:e}){e?.set("iconClass",e?.selected?C.menuItemGroupOpenedIcon:C.menuItemGroupClosedIcon)},l._toggleColumnFromMenuItem=function(e){const{grid:t,viewModel:i}=this;i.findColumn(e)?.hidden?t.showColumn(e):t.hideColumn(e)},l._showDeletePrompt=function(){const{messages:e,messagesCommon:t}=this,i=this.highlightIds.length||0,n=w.substitute(e.deleteSelectionCount,{count:i});this.menu.open=!1,this._prompt={title:n,message:e.deleteRecordsRemoved,context:"danger",actions:{primary:{label:t.delete,action:this._onDeleteSelectionClick},secondary:{label:e.keepRecords,action:()=>this._prompt=null}}}},l._onDeleteSelectionClick=function(){var e=t._asyncToGenerator((function*(){yield this.viewModel.deleteSelection(),this._prompt=null}));function i(){return e.apply(this,arguments)}return i}(),l._getSelectionFilter=function(){return this.viewModel.activeFilters?.find((e=>"selection"===e.type))},l._hasSelectionFilter=function(){return!!this._getSelectionFilter()},t._createClass(n,[{key:"activeFilters",get:function(){return this.viewModel.activeFilters}},{key:"activeSortOrders",get:function(){return this.viewModel.activeSortOrders}},{key:"attachmentsEnabled",get:function(){return this.viewModel.attachmentsEnabled},set:function(e){this.viewModel.attachmentsEnabled=e}},{key:"autoRefreshEnabled",get:function(){return this.viewModel.autoRefreshEnabled},set:function(e){this.viewModel.autoRefreshEnabled=e}},{key:"columnReorderingEnabled",get:function(){return this.viewModel.columnReorderingEnabled},set:function(e){this.viewModel.columnReorderingEnabled=e}},{key:"columns",get:function(){return this.viewModel.columns}},{key:"editingEnabled",get:function(){return this.viewModel.editingEnabled},set:function(e){this.viewModel.editingEnabled=e}},{key:"fieldConfigs",get:function(){return this.viewModel.fieldConfigs},set:function(e){this.viewModel.fieldConfigs=e}},{key:"filterGeometry",get:function(){return this.viewModel.filterGeometry},set:function(e){this.viewModel.filterGeometry=e}},{key:"grid",get:function(){return this.viewModel.grid}},{key:"hiddenFields",get:function(){return this.viewModel.hiddenFields},set:function(e){this.viewModel.hiddenFields=e}},{key:"highlightEnabled",get:function(){return this.viewModel.highlightEnabled},set:function(e){this.viewModel.highlightEnabled=e}},{key:"highlightIds",get:function(){return this.viewModel.highlightIds},set:function(e){this.viewModel.highlightIds=e}},{key:"highlightOnRowSelectEnabled",get:function(){return this.viewModel.highlightEnabled},set:function(e){this.viewModel.highlightEnabled=e}},{key:"label",get:function(){return this.messages?.widgetLabel??""},set:function(e){this._overrideIfSome("label",e)}},{key:"layer",get:function(){return this.viewModel.layer},set:function(e){this.viewModel.layer=e}},{key:"messages",get:function(){return this.viewModel.messages},set:function(e){this.viewModel.messages=e}},{key:"messagesCommon",get:function(){return this.viewModel.messagesCommon},set:function(e){this.viewModel.messagesCommon=e}},{key:"messagesURIUtils",get:function(){return this.viewModel.messagesURIUtils},set:function(e){this.viewModel.messagesURIUtils=e}},{key:"multiSortEnabled",get:function(){return this.viewModel.multiSortEnabled},set:function(e){this.viewModel.multiSortEnabled=e}},{key:"pageSize",get:function(){return this.viewModel.pageSize},set:function(e){this.viewModel.pageSize=e}},{key:"relatedRecordsEnabled",get:function(){return this.viewModel.relatedRecordsEnabled},set:function(e){this.viewModel.relatedRecordsEnabled=e}},{key:"state",get:function(){return this.viewModel.state}},{key:"tableTemplate",get:function(){return this.viewModel.tableTemplate},set:function(e){this.viewModel.tableTemplate=e}},{key:"timeExtent",get:function(){return this.viewModel.timeExtent},set:function(e){this.viewModel.timeExtent=e}},{key:"view",get:function(){return this.viewModel.view},set:function(e){this.viewModel.view=e}}]),n}(l.HandleOwnerMixin(p));i.__decorate([c.property({readOnly:!0})],E.prototype,"activeFilters",null),i.__decorate([c.property({readOnly:!0})],E.prototype,"activeSortOrders",null),i.__decorate([c.property()],E.prototype,"attachmentsEnabled",null),i.__decorate([c.property()],E.prototype,"autoRefreshEnabled",null),i.__decorate([c.property()],E.prototype,"columnReorderingEnabled",null),i.__decorate([c.property({readOnly:!0})],E.prototype,"columns",null),i.__decorate([c.property()],E.prototype,"editingEnabled",null),i.__decorate([c.property()],E.prototype,"fieldConfigs",null),i.__decorate([c.property()],E.prototype,"filterGeometry",null),i.__decorate([c.property({readOnly:!0})],E.prototype,"grid",null),i.__decorate([c.property()],E.prototype,"hiddenFields",null),i.__decorate([c.property()],E.prototype,"highlightEnabled",null),i.__decorate([c.property()],E.prototype,"highlightIds",null),i.__decorate([c.property()],E.prototype,"highlightOnRowSelectEnabled",null),i.__decorate([c.property()],E.prototype,"label",null),i.__decorate([c.property()],E.prototype,"layer",null),i.__decorate([c.property(),v.messageBundle("esri/widgets/FeatureTable/t9n/FeatureTable")],E.prototype,"messages",null),i.__decorate([c.property(),v.messageBundle("esri/t9n/common")],E.prototype,"messagesCommon",null),i.__decorate([c.property(),v.messageBundle("esri/widgets/support/t9n/uriUtils")],E.prototype,"messagesURIUtils",null),i.__decorate([c.property({readOnly:!0})],E.prototype,"menu",void 0),i.__decorate([c.property()],E.prototype,"menuConfig",void 0),i.__decorate([c.property()],E.prototype,"multiSortEnabled",null),i.__decorate([c.property()],E.prototype,"pageSize",null),i.__decorate([c.property()],E.prototype,"relatedRecordsEnabled",null),i.__decorate([c.property({readOnly:!0})],E.prototype,"state",null),i.__decorate([c.property()],E.prototype,"tableTemplate",null),i.__decorate([c.property()],E.prototype,"timeExtent",null),i.__decorate([c.property()],E.prototype,"view",null),i.__decorate([c.property()],E.prototype,"viewModel",void 0),i.__decorate([c.property()],E.prototype,"visibleElements",void 0),i.__decorate([u.cast("visibleElements")],E.prototype,"castVisibleElements",null),E=i.__decorate([h.subclass("esri.widgets.FeatureTable")],E);return E}));
