/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/global","../core/has","../core/Logger","../core/accessorSupport/ensureType","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/aliasOf","../core/accessorSupport/decorators/subclass","../core/urlUtils","../core/uuid","../portal/support/resourceExtension","../core/events","./support/widgetUtils","./support/decorators/accessibleHandler","./support/decorators/messageBundle","./support/decorators/renderable","../chunks/index","./Widget","./CoordinateConversion/support/Conversion","./CoordinateConversion/CoordinateConversionViewModel"],(function(e,t,o,s,i,n,r,a,l,d,c,p,u,_,h,v,g,m,b,x,f){"use strict";const y="esri-coordinate-conversion esri-widget",C="esri-coordinate-conversion--capture-mode",w="esri-coordinate-conversion--no-basemap",j="esri-coordinate-conversion__popup",k="esri-coordinate-conversion__conversion-list",I="esri-coordinate-conversion__row",M="esri-coordinate-conversion__display",V="esri-coordinate-conversion__conversions-view--expanded",P="esri-coordinate-conversion__conversions-view--expand-down",T="esri-coordinate-conversion__conversions-view--expand-up",F="esri-coordinate-conversion__conversions-view",O="esri-coordinate-conversion__select-primary",S="esri-coordinate-conversion__select-row",$="esri-coordinate-conversion__tools",D="esri-coordinate-conversion__mode-toggle",L="esri-coordinate-conversion__row-button",B="esri-coordinate-conversion__back-button",E="esri-coordinate-conversion__button",H="esri-coordinate-conversion__input-coordinate",R="esri-coordinate-conversion__input-form",A="esri-coordinate-conversion__input-group",U="esri-coordinate-conversion__input-coordinate--rejected",q="esri-coordinate-conversion__heading",G="esri-coordinate-conversion__pattern-input",N="esri-coordinate__settings",z="esri-coordinate-conversion__settings-group",K="esri-coordinate-conversion__settings-group-horizontal",W="esri-coordinate-conversion__preview-coordinate",J="esri-disabled",Q="esri-input",X="esri-button",Y="esri-widget__heading",Z="esri-widget--button",ee="esri-icon-left-arrow",te="esri-icon-right-arrow",oe="esri-icon-map-pin",se="esri-icon-up",ie="esri-icon-duplicate",ne="esri-icon-edit",re="esri-select",ae="esri-icon-down",le="esri-icon-refresh",de="esri-icon-close",ce="esri-icon-settings2",pe=i.getLogger("esri.widgets.CoordinateConversion");let ue=function(t){function s(e,o){var s;return(s=t.call(this,e,o)||this)._popupMessage=null,s._popupId=null,s._coordinateInput=null,s._badInput=!1,s._goToEnabled=!1,s._conversionFormat=null,s._settingsFormat=null,s._previewConversion=null,s._expanded=!1,s._popupVisible=!1,s._settingsVisible=!1,s._inputVisible=!1,s.conversions=null,s.currentLocation=null,s.formats=null,s.goToOverride=null,s.label=void 0,s.messages=null,s.messagesCommon=null,s.mode=null,s.orientation="auto",s.requestDelay=null,s.view=null,s.viewModel=new f,s}e._inheritsLoose(s,t);var i=s.prototype;return i.reverseConvert=function(e,t){return this.viewModel.reverseConvert(e,t)},i.render=function(){const e=this.get("viewModel.state"),t="disabled"===e?m.jsx("div",{key:"esri-coordinate__no-basemap"},this.messages.noBasemap):null,o=!t&&this._inputVisible?this._renderInputForm():null,s=!t&&this._settingsVisible?this._renderSettings():null,i=t||o||s?null:this._renderConversionsView(),n=this._popupVisible?this._renderPopup():null,r={[C]:"capture"===this.mode,[J]:"loading"===e,[w]:"disabled"===e};return m.jsx("div",{class:this.classes(y,r)},n,t,i,s,o)},i._addConversion=function(e){const t=e.target,o=t.options[t.options.selectedIndex]["data-format"],s=t["data-index"],i=new x({format:o});t.options.selectedIndex=0,s>=0&&this.conversions.removeAt(s),this.conversions.add(i,s)},i._findSettingsFormat=function(){return this._settingsFormat||this.conversions.reduceRight(((e,t)=>{const o=t.format;return o.get("hasDisplayProperties")?o:e}),null)||this.formats.find((e=>e.hasDisplayProperties))},i._hidePopup=function(){this._popupId&&(clearTimeout(this._popupId),this._popupId=null),this._popupVisible=!1,this._popupMessage=null,this.scheduleRender()},i._onConvertComplete=function(){this._inputVisible=!1,this._coordinateInput.value=""},i._onCopy=function(e){const t=e.currentTarget["data-conversion"].displayCoordinate;"clipboardData"in o?o.clipboardData.setData("text",t):e.clipboardData.setData("text/plain",t),this._showPopup(this.messages.copySuccessMessage),e.preventDefault()},i._processUserInput=function(e){const t=u.eventKey(e),o=this.viewModel;if("Enter"!==t&&t)this._badInput&&(this._badInput=!1);else{const e=this._coordinateInput["data-format"],t=this._coordinateInput.value;this._reverseConvert(t,e).then((e=>{"capture"===this.mode?o.resume():this.mode="capture",this.currentLocation=e,o.setLocation(e),this._onConvertComplete()})).catch((e=>{pe.error(e),this._showPopup(this.messages.invalidCoordinate),this._badInput=!0}))}},i._reverseConvert=function(e,t){const o=this.viewModel;return t.reverseConvert(e).then((e=>(this._goToEnabled&&o.goToLocation(e).catch((e=>{pe.warn(e),this._showPopup(this.messages.locationOffBasemap)})),e)))},i._setInputFormat=function(e){const t=e.target,o=t[t.options.selectedIndex]["data-format"];this._conversionFormat=o},i._setPreviewConversion=function(){const e=this._findSettingsFormat(),t=this.viewModel;if(e){const o=this.conversions.find((t=>t.format===e));this._previewConversion=new x({format:e,position:{location:this.currentLocation,coordinate:o&&o.position.coordinate}}),this._previewConversion.position.coordinate||t.previewConversion(this._previewConversion)}},i._setSettingsFormat=function(e){const t=e.target,o=t[t.options.selectedIndex]["data-format"];this._settingsFormat=o,this._setPreviewConversion()},i._showPopup=function(e,t=2500){this._popupMessage=e,this._popupVisible?clearTimeout(this._popupId):this._popupVisible=!0,this.scheduleRender(),this._popupId=setTimeout((()=>{this._popupId=null,this._hidePopup()}),t)},i._toggleGoTo=function(){this._goToEnabled=!this._goToEnabled},i._updateCurrentPattern=function(e){e.stopPropagation();const t=e.target,o=this._findSettingsFormat();o&&(o.currentPattern=t.value)},i._renderConversion=function(e,t){const{messages:o}=this,s=`${this.id}__list-item-${t}`,i=`${e.format.name} ${o.conversionOutputSuffix}`,n=0===t,r=n||this._expanded,a=n?this._renderFirstConversion(e):this._renderTools(t,e,s),l=n&&!e.displayCoordinate?o.noLocation:e.displayCoordinate,d=m.jsx("div",{"aria-label":l,class:M,"data-conversion":e,role:"listitem",tabindex:"0",title:l},l),c=this._renderOptions(this.formats.filter((t=>t!==e.format)));return r?m.jsx("li",{"aria-label":i,class:I,id:s,key:e,role:"group",title:i,tabindex:"0"},m.jsx("select",{"aria-controls":s,"aria-label":o.selectFormat,class:this.classes(re,S),bind:this,"data-index":t,onchange:this._addConversion,title:o.selectFormat},m.jsx("option",{"aria-label":e.format.name,selected:!0,title:e.format.name},e.format.name.toUpperCase()),c),d,a):null},i._renderCopyButton=function(e){return m.jsx("li",{"aria-label":this.messagesCommon.copy,bind:this,class:this.classes(Z,L),"data-conversion":e,onclick:this._copyCoordinateOutput,onkeydown:this._copyCoordinateOutput,oncopy:this._onCopy,role:"button",tabindex:"0",title:this.messagesCommon.copy},m.jsx("span",{"aria-hidden":"true",class:ie}))},i._renderFirstConversion=function(e){const t=this.id,o={[ae]:!this._expanded,[se]:this._expanded},{messages:s,messagesCommon:i}=this,n="live"===this.mode?s.captureMode:s.liveMode,r=this._expanded?i.collapse:i.expand,a=e.displayCoordinate&&"capture"===this.mode?this._renderCopyButton(e):null,l=this.multipleConversions?m.jsx("li",{"aria-controls":`${t}__${k}`,"aria-label":r,bind:this,class:Z,key:"esri-coordinate-conversion__expand-button",onclick:this._toggleExpand,onkeydown:this._toggleExpand,role:"button",tabindex:"0",title:r},m.jsx("span",{"aria-hidden":"true",class:this.classes(o)})):m.jsx("li",{"aria-label":n,bind:this,class:this.classes(Z,D),key:"esri-coordinate-conversion__mode-toggle",onclick:this._toggleMode,onkeydown:this._toggleMode,role:"button",tabindex:"0",title:n},m.jsx("span",{"aria-hidden":"true",class:oe}));return m.jsx("ul",{class:$},a,l)},i._renderInputForm=function(){const e=this._conversionFormat||this.conversions.getItemAt(0).format,t=this.formats.findIndex((t=>t.name===e.name)),o=this.id,s=`${o}__${H}`,i=`${o}__${H}__header`,n=this._renderOptions(this.formats,!0,t),r={[U]:this._badInput},{messages:a,messagesCommon:l}=this;return m.jsx("div",{"aria-labelledby":i,class:R,key:"esri-coordinate-conversion__input-form",role:"search"},m.jsx("div",{class:q},m.jsx("div",{"aria-label":l.back,bind:this,class:this.classes(Z,B),onclick:this._toggleInputVisibility,onkeydown:this._toggleInputVisibility,role:"button",tabindex:"0",title:l.back},this._renderBackIcon()),m.jsx("h4",{class:Y,id:i},a.inputCoordTitle)),m.jsx("div",{class:A},m.jsx("select",{"aria-controls":s,"aria-label":a.selectFormat,bind:this,class:this.classes(re,S),onchange:this._setInputFormat,title:a.selectFormat},n),m.jsx("input",{afterCreate:_.storeNode,"aria-labelledby":i,"aria-required":"true",bind:this,class:this.classes(H,Q,r),"data-format":e,"data-node-ref":"_coordinateInput",id:s,onkeydown:this._processUserInput,placeholder:a.inputCoordTitle,role:"textbox",spellcheck:!1,title:a.inputCoordTitle,type:"text"})),m.jsx("div",{class:A},m.jsx("label",{"aria-label":a.goTo},m.jsx("input",{bind:this,checked:this._goToEnabled,onclick:this._toggleGoTo,title:a.goTo,type:"checkbox"}),a.goTo),m.jsx("button",{"aria-label":a.convert,bind:this,class:this.classes(E,X),onclick:this._processUserInput,title:a.convert,type:"button"},a.convert)))},i._renderConversionsView=function(){const e=`${this.id}__${k}`,t=this._renderPrimaryTools(),o=this._renderOptions(this.formats),s=this.conversions.map(((e,t)=>this._renderConversion(e,t))).toArray(),{messages:i}=this,n=this._expanded?m.jsx("div",{class:I},m.jsx("select",{"aria-controls":e,"aria-label":i.addConversion,bind:this,class:this.classes(re,O),onchange:this._addConversion,title:i.addConversion},m.jsx("option",{disabled:!0,selected:!0,value:""},i.addConversion),o),t):null,r={[V]:this._expanded,[T]:"expand-up"===this.orientation,[P]:"expand-down"===this.orientation};return m.jsx("div",{class:this.classes(F,r),key:"esri-coordinate-conversion__main-view"},m.jsx("ul",{"aria-expanded":this._expanded?"true":"false",class:k,id:e},s),n)},i._renderOptions=function(e,t,o){const s=this.conversions.getItemAt(0);return e.map(((e,i)=>{const n=!(t||!s)&&(s.format.name===e.name||this.conversions.map((e=>e.format.name)).includes(e.name));return m.jsx("option",{"aria-label":e.name,"data-format":e,disabled:n,key:e.name,selected:i===o,value:e.name},e.name.toUpperCase())})).toArray()},i._renderPopup=function(){return m.jsx("div",{class:j,role:"alert"},this._popupMessage)},i._renderPrimaryTools=function(){const{messages:e}=this,t="live"===this.mode?e.captureMode:e.liveMode;return m.jsx("ul",{class:$},m.jsx("li",{bind:this,class:Z,onclick:this._toggleInputVisibility,onkeydown:this._toggleInputVisibility,role:"button",tabindex:"0",title:e.inputCoordTitle},m.jsx("span",{"aria-hidden":"true",class:ne})),m.jsx("li",{bind:this,class:this.classes(Z,D),onclick:this._toggleMode,onkeydown:this._toggleMode,role:"button",tabindex:"0",title:t},m.jsx("span",{"aria-hidden":"true",class:oe})),m.jsx("li",{bind:this,class:Z,onclick:this._toggleSettingsVisibility,onkeydown:this._toggleSettingsVisibility,role:"button",tabindex:"0",title:e.settingsTitle},m.jsx("span",{"aria-hidden":"true",class:ce})))},i._renderSettings=function(){const e=this.id,t=`${e}__${G}`,o=`${e}__${G}__header`,s=`${e}__${W}`,i=this.formats.filter((e=>e.hasDisplayProperties)),n=this._findSettingsFormat(),r=i.indexOf(n),a=this._renderOptions(i,!0,r),l=n.get("currentPattern"),{messages:d,messagesCommon:c}=this;return m.jsx("div",{"aria-labelledby":o,class:N,key:"esri-coordinate-conversion__settings"},m.jsx("div",{class:q},m.jsx("div",{bind:this,class:this.classes(Z,B),onclick:this._toggleSettingsVisibility,onkeydown:this._toggleSettingsVisibility,role:"button",tabindex:"0",title:c.back},this._renderBackIcon()),m.jsx("h4",{class:Y,id:o},d.settingsTitle)),m.jsx("div",{class:z},m.jsx("label",{for:t},d.changeCoordinateDisplay),m.jsx("select",{"aria-label":d.selectFormat,class:re,bind:this,onchange:this._setSettingsFormat,title:d.selectFormat},a),m.jsx("div",{class:K},m.jsx("input",{"aria-controls":s,bind:this,class:this.classes(G,Q),id:t,oninput:this._updateCurrentPattern,spellcheck:!1,title:d.changeCoordinateDisplay,type:"text",value:l}),m.jsx("div",{"aria-controls":t,bind:this,class:Z,onclick:this._setDefaultPattern,onkeydown:this._setDefaultPattern,role:"button",tabindex:"0",title:d.defaultPattern},m.jsx("span",{"aria-hidden":"true",class:le})))),m.jsx("div",{class:z},m.jsx("label",null,c.preview,m.jsx("div",{class:W,id:s,tabindex:"0"},this._previewConversion.displayCoordinate))))},i._renderBackIcon=function(){return m.jsx("span",{"aria-hidden":"true",class:_.isRTL()?te:ee})},i._renderTools=function(e,t,o){const s=t.displayCoordinate&&"capture"===this.mode?this._renderCopyButton(t):null,{messages:i}=this;return m.jsx("ul",{class:$,role:"listitem"},s,m.jsx("li",{"aria-controls":o,"aria-label":i.removeConversion,bind:this,class:this.classes(Z,L),"data-index":e,key:`${o}__${Z}`,onclick:this._removeConversion,onkeydown:this._removeConversion,tabindex:"0",role:"button",title:i.removeConversion},m.jsx("span",{"aria-hidden":"true",class:de})))},i._copyCoordinateOutput=function(e){const t=e.target;if(!("createTextRange"in document.body)){const e=window.getSelection(),o=document.createRange();o.selectNodeContents(t),e.removeAllRanges(),e.addRange(o)}document.execCommand("copy")},i._removeConversion=function(e){const t=e.currentTarget["data-index"];this.conversions.removeAt(t)},i._setDefaultPattern=function(e){e.stopPropagation();const t=this._findSettingsFormat();t&&(t.currentPattern=t.get("defaultPattern"))},i._toggleExpand=function(){this._expanded=!this._expanded},i._toggleInputVisibility=function(){this._inputVisible=!this._inputVisible,this._popupVisible&&this._hidePopup(),this._inputVisible?this.viewModel.pause():this.viewModel.resume()},i._toggleMode=function(){this.mode="live"===this.mode?"capture":"live"},i._toggleSettingsVisibility=function(){this._settingsVisible=!this._settingsVisible,this._popupVisible&&this._hidePopup(),this._settingsVisible?(this._setPreviewConversion(),this.viewModel.pause()):this.viewModel.resume()},e._createClass(s,[{key:"multipleConversions",set:function(e){!1===e&&(this._expanded=!1,this.conversions.splice(1,this.conversions.length-1)),this._set("multipleConversions",e)},get:function(){const e=this._get("multipleConversions");return"boolean"!=typeof e||e}}]),s}(b);return t.__decorate([a.aliasOf("viewModel.conversions")],ue.prototype,"conversions",void 0),t.__decorate([a.aliasOf("viewModel.currentLocation"),g.renderable()],ue.prototype,"currentLocation",void 0),t.__decorate([a.aliasOf("viewModel.formats"),g.renderable()],ue.prototype,"formats",void 0),t.__decorate([a.aliasOf("viewModel.goToOverride")],ue.prototype,"goToOverride",void 0),t.__decorate([r.property({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],ue.prototype,"label",void 0),t.__decorate([r.property(),g.renderable(),v.messageBundle("esri/widgets/CoordinateConversion/t9n/CoordinateConversion")],ue.prototype,"messages",void 0),t.__decorate([r.property(),g.renderable(),v.messageBundle("esri/t9n/common")],ue.prototype,"messagesCommon",void 0),t.__decorate([a.aliasOf("viewModel.mode"),g.renderable()],ue.prototype,"mode",void 0),t.__decorate([r.property(),g.renderable()],ue.prototype,"orientation",void 0),t.__decorate([a.aliasOf("viewModel.requestDelay")],ue.prototype,"requestDelay",void 0),t.__decorate([r.property(),g.renderable()],ue.prototype,"multipleConversions",null),t.__decorate([a.aliasOf("viewModel.locationSymbol")],ue.prototype,"locationSymbol",void 0),t.__decorate([a.aliasOf("viewModel.view"),g.renderable()],ue.prototype,"view",void 0),t.__decorate([r.property({type:f}),g.renderable(["viewModel.state","viewModel.waitingForConversions"])],ue.prototype,"viewModel",void 0),t.__decorate([h.accessibleHandler()],ue.prototype,"_copyCoordinateOutput",null),t.__decorate([h.accessibleHandler()],ue.prototype,"_removeConversion",null),t.__decorate([h.accessibleHandler()],ue.prototype,"_setDefaultPattern",null),t.__decorate([h.accessibleHandler()],ue.prototype,"_toggleExpand",null),t.__decorate([h.accessibleHandler()],ue.prototype,"_toggleInputVisibility",null),t.__decorate([h.accessibleHandler()],ue.prototype,"_toggleMode",null),t.__decorate([h.accessibleHandler()],ue.prototype,"_toggleSettingsVisibility",null),ue=t.__decorate([l.subclass("esri.widgets.CoordinateConversion")],ue),ue}));
