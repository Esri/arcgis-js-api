// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../core/events","../core/global","../core/Logger","../core/accessorSupport/decorators","./Widget","./CoordinateConversion/CoordinateConversionViewModel","./CoordinateConversion/support/Conversion","./support/widget"],(function(e,t,o,i,s,n,r,a,l,d,c){"use strict";var p="esri-coordinate-conversion esri-widget",u="esri-coordinate-conversion--capture-mode",_="esri-coordinate-conversion--no-basemap",h="esri-coordinate-conversion__popup",v="esri-coordinate-conversion__conversion-list",g="esri-coordinate-conversion__row",m="esri-coordinate-conversion__display",b="esri-coordinate-conversion__conversions-view--expanded",y="esri-coordinate-conversion__conversions-view--expand-down",f="esri-coordinate-conversion__conversions-view--expand-up",x="esri-coordinate-conversion__conversions-view",C="esri-coordinate-conversion__select-primary",w="esri-coordinate-conversion__select-row",k="esri-coordinate-conversion__tools",I="esri-coordinate-conversion__mode-toggle",M="esri-coordinate-conversion__row-button",V="esri-coordinate-conversion__back-button",P="esri-coordinate-conversion__button",T="esri-coordinate-conversion__input-coordinate",F="esri-coordinate-conversion__input-form",O="esri-coordinate-conversion__input-group",S="esri-coordinate-conversion__input-coordinate--rejected",D="esri-coordinate-conversion__heading",L="esri-coordinate-conversion__pattern-input",E="esri-coordinate__settings",A="esri-coordinate-conversion__settings-group",B="esri-coordinate-conversion__settings-group-horizontal",H="esri-coordinate-conversion__preview-coordinate",R="esri-disabled",q="esri-input",U="esri-button",j="esri-widget__heading",G="esri-widget--button",N="esri-icon-left-arrow",z="esri-icon-map-pin",K="esri-icon-up",W="esri-icon-duplicate",J="esri-icon-edit",Q="esri-select",X="esri-icon-down",Y="esri-icon-refresh",Z="esri-icon-close",$="esri-icon-settings2",ee=n.getLogger("esri.widgets.CoordinateConversion");return function(e){function t(t,o){var i=e.call(this,t,o)||this;return i._popupMessage=null,i._popupId=null,i._coordinateInput=null,i._badInput=!1,i._goToEnabled=!1,i._conversionFormat=null,i._settingsFormat=null,i._previewConversion=null,i._expanded=!1,i._popupVisible=!1,i._settingsVisible=!1,i._inputVisible=!1,i.conversions=null,i.currentLocation=null,i.formats=null,i.goToOverride=null,i.label=void 0,i.messages=null,i.messagesCommon=null,i.mode=null,i.orientation="auto",i.requestDelay=null,i.view=null,i.viewModel=new l,i}return o.__extends(t,e),Object.defineProperty(t.prototype,"multipleConversions",{get:function(){var e=this._get("multipleConversions");return"boolean"!=typeof e||e},set:function(e){!1===e&&(this._expanded=!1,this.conversions.splice(1,this.conversions.length-1)),this._set("multipleConversions",e)},enumerable:!1,configurable:!0}),t.prototype.reverseConvert=function(e,t){return this.viewModel.reverseConvert(e,t)},t.prototype.render=function(){var e,t=this.get("viewModel.state"),o="disabled"===t?c.tsx("div",{key:"esri-coordinate__no-basemap"},this.messages.noBasemap):null,i=!o&&this._inputVisible?this._renderInputForm():null,s=!o&&this._settingsVisible?this._renderSettings():null,n=o||i||s?null:this._renderConversionsView(),r=this._popupVisible?this._renderPopup():null,a=((e={})[u]="capture"===this.mode,e[R]="loading"===t,e[_]="disabled"===t,e);return c.tsx("div",{class:this.classes(p,a)},r,o,n,s,i)},t.prototype._addConversion=function(e){var t=e.target,o=t.options[t.options.selectedIndex]["data-format"],i=t["data-index"],s=new d({format:o});t.options.selectedIndex=0,i>=0&&this.conversions.removeAt(i),this.conversions.add(s,i)},t.prototype._findSettingsFormat=function(){return this._settingsFormat||this.conversions.reduceRight((function(e,t){var o=t.format;return o.get("hasDisplayProperties")?o:e}),null)||this.formats.find((function(e){return e.hasDisplayProperties}))},t.prototype._hidePopup=function(){this._popupId&&(clearTimeout(this._popupId),this._popupId=null),this._popupVisible=!1,this._popupMessage=null,this.scheduleRender()},t.prototype._onConvertComplete=function(){this._inputVisible=!1,this._coordinateInput.value=""},t.prototype._onCopy=function(e){var t=e.currentTarget["data-conversion"].displayCoordinate;"clipboardData"in s?s.clipboardData.setData("text",t):e.clipboardData.setData("text/plain",t),this._showPopup(this.messages.copySuccessMessage),e.preventDefault()},t.prototype._processUserInput=function(e){var t=this,o=i.eventKey(e),s=this.viewModel;if("Enter"!==o&&o)this._badInput&&(this._badInput=!1);else{var n=this._coordinateInput["data-format"],r=this._coordinateInput.value;this._reverseConvert(r,n).then((function(e){"capture"===t.mode?s.resume():t.mode="capture",t.currentLocation=e,s.setLocation(e),t._onConvertComplete()})).catch((function(e){ee.error(e),t._showPopup(t.messages.invalidCoordinate),t._badInput=!0}))}},t.prototype._reverseConvert=function(e,t){var o=this,i=this.viewModel;return t.reverseConvert(e).then((function(e){return o._goToEnabled&&i.goToLocation(e).catch((function(e){ee.warn(e),o._showPopup(o.messages.locationOffBasemap)})),e}))},t.prototype._setInputFormat=function(e){var t=e.target,o=t[t.options.selectedIndex]["data-format"];this._conversionFormat=o},t.prototype._setPreviewConversion=function(){var e=this._findSettingsFormat(),t=this.viewModel;if(e){var o=this.conversions.find((function(t){return t.format===e}));this._previewConversion=new d({format:e,position:{location:this.currentLocation,coordinate:o&&o.position.coordinate}}),this._previewConversion.position.coordinate||t.previewConversion(this._previewConversion)}},t.prototype._setSettingsFormat=function(e){var t=e.target,o=t[t.options.selectedIndex]["data-format"];this._settingsFormat=o,this._setPreviewConversion()},t.prototype._showPopup=function(e,t){var o=this;void 0===t&&(t=2500),this._popupMessage=e,this._popupVisible?clearTimeout(this._popupId):this._popupVisible=!0,this.scheduleRender(),this._popupId=setTimeout((function(){o._popupId=null,o._hidePopup()}),t)},t.prototype._toggleGoTo=function(){this._goToEnabled=!this._goToEnabled},t.prototype._updateCurrentPattern=function(e){e.stopPropagation();var t=e.target,o=this._findSettingsFormat();o&&(o.currentPattern=t.value)},t.prototype._renderConversion=function(e,t){var o=this.messages,i=this.id+"__list-item-"+t,s=e.format.name+" "+o.conversionOutputSuffix,n=0===t,r=n||this._expanded,a=n?this._renderFirstConversion(e):this._renderTools(t,e,i),l=n&&!e.displayCoordinate?o.noLocation:e.displayCoordinate,d=c.tsx("div",{"aria-label":l,class:m,"data-conversion":e,role:"listitem",tabindex:"0",title:l},l),p=this._renderOptions(this.formats.filter((function(t){return t!==e.format})));return r?c.tsx("li",{"aria-label":s,class:g,id:i,key:e,role:"group",title:s,tabindex:"0"},c.tsx("select",{"aria-controls":i,"aria-label":o.selectFormat,class:this.classes(Q,w),bind:this,"data-index":t,onchange:this._addConversion,title:o.selectFormat},c.tsx("option",{"aria-label":e.format.name,selected:!0,title:e.format.name},e.format.name.toUpperCase()),p),d,a):null},t.prototype._renderCopyButton=function(e){return c.tsx("li",{"aria-label":this.messagesCommon.copy,bind:this,class:this.classes(G,M),"data-conversion":e,onclick:this._copyCoordinateOutput,onkeydown:this._copyCoordinateOutput,oncopy:this._onCopy,role:"button",tabindex:"0",title:this.messagesCommon.copy},c.tsx("span",{"aria-hidden":"true",class:W}))},t.prototype._renderFirstConversion=function(e){var t,o=this.id,i=((t={})[X]=!this._expanded,t[K]=this._expanded,t),s=this.messages,n=this.messagesCommon,r="live"===this.mode?s.captureMode:s.liveMode,a=this._expanded?n.collapse:n.expand,l=e.displayCoordinate&&"capture"===this.mode?this._renderCopyButton(e):null,d=this.multipleConversions?c.tsx("li",{"aria-controls":o+"__"+v,"aria-label":a,bind:this,class:G,key:"esri-coordinate-conversion__expand-button",onclick:this._toggleExpand,onkeydown:this._toggleExpand,role:"button",tabindex:"0",title:a},c.tsx("span",{"aria-hidden":"true",class:this.classes(i)})):c.tsx("li",{"aria-label":r,bind:this,class:this.classes(G,I),key:"esri-coordinate-conversion__mode-toggle",onclick:this._toggleMode,onkeydown:this._toggleMode,role:"button",tabindex:"0",title:r},c.tsx("span",{"aria-hidden":"true",class:z}));return c.tsx("ul",{class:k},l,d)},t.prototype._renderInputForm=function(){var e,t=this._conversionFormat||this.conversions.getItemAt(0).format,o=this.formats.findIndex((function(e){return e.name===t.name})),i=this.id,s=i+"__"+T,n=i+"__"+T+"__header",r=this._renderOptions(this.formats,!0,o),a=((e={})[S]=this._badInput,e),l=this.messages,d=this.messagesCommon;return c.tsx("div",{"aria-labelledby":n,class:F,key:"esri-coordinate-conversion__input-form",role:"search"},c.tsx("div",{class:D},c.tsx("div",{"aria-label":d.back,bind:this,class:this.classes(G,V),onclick:this._toggleInputVisibility,onkeydown:this._toggleInputVisibility,role:"button",tabindex:"0",title:d.back},c.tsx("span",{"aria-hidden":"true",class:N})),c.tsx("h4",{class:j,id:n},l.inputCoordTitle)),c.tsx("div",{class:O},c.tsx("select",{"aria-controls":s,"aria-label":l.selectFormat,bind:this,class:this.classes(Q,w),onchange:this._setInputFormat,title:l.selectFormat},r),c.tsx("input",{afterCreate:c.storeNode,"aria-labelledby":n,"aria-required":"true",bind:this,class:this.classes(T,q,a),"data-format":t,"data-node-ref":"_coordinateInput",id:s,onkeydown:this._processUserInput,placeholder:l.inputCoordTitle,role:"textbox",spellcheck:!1,title:l.inputCoordTitle,type:"text"})),c.tsx("div",{class:O},c.tsx("label",{"aria-label":l.goTo},c.tsx("input",{bind:this,checked:this._goToEnabled,onclick:this._toggleGoTo,title:l.goTo,type:"checkbox"}),l.goTo),c.tsx("button",{"aria-label":l.convert,bind:this,class:this.classes(P,U),onclick:this._processUserInput,title:l.convert,type:"button"},l.convert)))},t.prototype._renderConversionsView=function(){var e,t=this,o=this.id+"__"+v,i=this._renderPrimaryTools(),s=this._renderOptions(this.formats),n=this.conversions.map((function(e,o){return t._renderConversion(e,o)})).toArray(),r=this.messages,a=this._expanded?c.tsx("div",{class:g},c.tsx("select",{"aria-controls":o,"aria-label":r.addConversion,bind:this,class:this.classes(Q,C),onchange:this._addConversion,title:r.addConversion},c.tsx("option",{disabled:!0,selected:!0,value:""},r.addConversion),s),i):null,l=((e={})[b]=this._expanded,e[f]="expand-up"===this.orientation,e[y]="expand-down"===this.orientation,e);return c.tsx("div",{class:this.classes(x,l),key:"esri-coordinate-conversion__main-view"},c.tsx("ul",{"aria-expanded":this._expanded?"true":"false",class:v,id:o},n),a)},t.prototype._renderOptions=function(e,t,o){var i=this,s=this.conversions.getItemAt(0);return e.map((function(e,n){var r=!(t||!s)&&(s.format.name===e.name||i.conversions.map((function(e){return e.format.name})).includes(e.name));return c.tsx("option",{"aria-label":e.name,"data-format":e,disabled:r,key:e.name,selected:n===o,value:e.name},e.name.toUpperCase())})).toArray()},t.prototype._renderPopup=function(){return c.tsx("div",{class:h,role:"alert"},this._popupMessage)},t.prototype._renderPrimaryTools=function(){var e=this.messages,t="live"===this.mode?e.captureMode:e.liveMode;return c.tsx("ul",{class:k},c.tsx("li",{bind:this,class:G,onclick:this._toggleInputVisibility,onkeydown:this._toggleInputVisibility,role:"button",tabindex:"0",title:e.inputCoordTitle},c.tsx("span",{"aria-hidden":"true",class:J})),c.tsx("li",{bind:this,class:this.classes(G,I),onclick:this._toggleMode,onkeydown:this._toggleMode,role:"button",tabindex:"0",title:t},c.tsx("span",{"aria-hidden":"true",class:z})),c.tsx("li",{bind:this,class:G,onclick:this._toggleSettingsVisibility,onkeydown:this._toggleSettingsVisibility,role:"button",tabindex:"0",title:e.settingsTitle},c.tsx("span",{"aria-hidden":"true",class:$})))},t.prototype._renderSettings=function(){var e=this.id,t=e+"__"+L,o=e+"__"+L+"__header",i=e+"__"+H,s=this.formats.filter((function(e){return e.hasDisplayProperties})),n=this._findSettingsFormat(),r=s.indexOf(n),a=this._renderOptions(s,!0,r),l=n.get("currentPattern"),d=this.messages,p=this.messagesCommon;return c.tsx("div",{"aria-labelledby":o,class:E,key:"esri-coordinate-conversion__settings"},c.tsx("div",{class:D},c.tsx("div",{bind:this,class:this.classes(G,V),onclick:this._toggleSettingsVisibility,onkeydown:this._toggleSettingsVisibility,role:"button",tabindex:"0",title:p.back},c.tsx("span",{"aria-hidden":"true",class:N})),c.tsx("h4",{class:j,id:o},d.settingsTitle)),c.tsx("div",{class:A},c.tsx("label",{for:t},d.changeCoordinateDisplay),c.tsx("select",{"aria-label":d.selectFormat,class:Q,bind:this,onchange:this._setSettingsFormat,title:d.selectFormat},a),c.tsx("div",{class:B},c.tsx("input",{"aria-controls":i,bind:this,class:this.classes(L,q),id:t,oninput:this._updateCurrentPattern,spellcheck:!1,title:d.changeCoordinateDisplay,type:"text",value:l}),c.tsx("div",{"aria-controls":t,bind:this,class:G,onclick:this._setDefaultPattern,onkeydown:this._setDefaultPattern,role:"button",tabindex:"0",title:d.defaultPattern},c.tsx("span",{"aria-hidden":"true",class:Y})))),c.tsx("div",{class:A},c.tsx("label",null,p.preview,c.tsx("div",{class:H,id:i,tabindex:"0"},this._previewConversion.displayCoordinate))))},t.prototype._renderTools=function(e,t,o){var i=t.displayCoordinate&&"capture"===this.mode?this._renderCopyButton(t):null,s=this.messages;return c.tsx("ul",{class:k,role:"listitem"},i,c.tsx("li",{"aria-controls":o,"aria-label":s.removeConversion,bind:this,class:this.classes(G,M),"data-index":e,key:o+"__"+G,onclick:this._removeConversion,onkeydown:this._removeConversion,tabindex:"0",role:"button",title:s.removeConversion},c.tsx("span",{"aria-hidden":"true",class:Z})))},t.prototype._copyCoordinateOutput=function(e){var t=e.target;if(!("createTextRange"in document.body)){var o=window.getSelection(),i=document.createRange();i.selectNodeContents(t),o.removeAllRanges(),o.addRange(i)}document.execCommand("copy")},t.prototype._removeConversion=function(e){var t=e.currentTarget["data-index"];this.conversions.removeAt(t)},t.prototype._setDefaultPattern=function(e){e.stopPropagation();var t=this._findSettingsFormat();t&&(t.currentPattern=t.get("defaultPattern"))},t.prototype._toggleExpand=function(){this._expanded=!this._expanded},t.prototype._toggleInputVisibility=function(){this._inputVisible=!this._inputVisible,this._popupVisible&&this._hidePopup(),this._inputVisible?this.viewModel.pause():this.viewModel.resume()},t.prototype._toggleMode=function(){this.mode="live"===this.mode?"capture":"live"},t.prototype._toggleSettingsVisibility=function(){this._settingsVisible=!this._settingsVisible,this._popupVisible&&this._hidePopup(),this._settingsVisible?(this._setPreviewConversion(),this.viewModel.pause()):this.viewModel.resume()},o.__decorate([r.aliasOf("viewModel.conversions")],t.prototype,"conversions",void 0),o.__decorate([r.aliasOf("viewModel.currentLocation"),c.renderable()],t.prototype,"currentLocation",void 0),o.__decorate([r.aliasOf("viewModel.formats"),c.renderable()],t.prototype,"formats",void 0),o.__decorate([r.aliasOf("viewModel.goToOverride")],t.prototype,"goToOverride",void 0),o.__decorate([r.property({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],t.prototype,"label",void 0),o.__decorate([r.property(),c.renderable(),c.messageBundle("esri/widgets/CoordinateConversion/t9n/CoordinateConversion")],t.prototype,"messages",void 0),o.__decorate([r.property(),c.renderable(),c.messageBundle("esri/t9n/common")],t.prototype,"messagesCommon",void 0),o.__decorate([r.aliasOf("viewModel.mode"),c.renderable()],t.prototype,"mode",void 0),o.__decorate([r.property(),c.renderable()],t.prototype,"orientation",void 0),o.__decorate([r.aliasOf("viewModel.requestDelay")],t.prototype,"requestDelay",void 0),o.__decorate([r.property(),c.renderable()],t.prototype,"multipleConversions",null),o.__decorate([r.aliasOf("viewModel.locationSymbol")],t.prototype,"locationSymbol",void 0),o.__decorate([r.aliasOf("viewModel.view"),c.renderable()],t.prototype,"view",void 0),o.__decorate([r.property({type:l}),c.renderable(["viewModel.state","viewModel.waitingForConversions"])],t.prototype,"viewModel",void 0),o.__decorate([c.accessibleHandler()],t.prototype,"_copyCoordinateOutput",null),o.__decorate([c.accessibleHandler()],t.prototype,"_removeConversion",null),o.__decorate([c.accessibleHandler()],t.prototype,"_setDefaultPattern",null),o.__decorate([c.accessibleHandler()],t.prototype,"_toggleExpand",null),o.__decorate([c.accessibleHandler()],t.prototype,"_toggleInputVisibility",null),o.__decorate([c.accessibleHandler()],t.prototype,"_toggleMode",null),o.__decorate([c.accessibleHandler()],t.prototype,"_toggleSettingsVisibility",null),t=o.__decorate([r.subclass("esri.widgets.CoordinateConversion")],t)}(a)}));