/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["require","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../geometry","../../Graphic","../../symbols","../../core/Collection","../../core/has","../../core/Error","../../core/Evented","../../core/Handles","../../core/Logger","../../core/maybe","../../core/promiseUtils","../../core/screenUtils","../../core/watchUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass","../../geometry/projectionEllipsoid","../../geometry/support/coordsUtils","../../layers/GraphicsLayer","../../views/DOMContainer","../../views/3d/interactive/editingTools/isSupportedGraphicUtils","../../views/3d/interactive/editingTools/moveGraphic/isSupportedGraphic","../../views/3d/interactive/editingTools/reshapeGraphic/isSupportedGraphic","../../views/3d/interactive/editingTools/transformGraphic/isSupportedGraphic","../../views/draw/Draw","../../views/draw/DrawAction","../../views/draw/support/createUtilsAsync","../../views/draw/support/layerUtils","../../views/input/InputManager","../../views/interactive/keybindings","../../views/interactive/snapping/SnappingManager","../../views/interactive/snapping/SnappingOptions","../../views/support/screenUtils","./support/OperationHandle","../../geometry/Point","../../symbols/SimpleMarkerSymbol","../../symbols/SimpleFillSymbol","../../symbols/CIMSymbol","../../symbols/SimpleLineSymbol"],(function(e,t,i,o,r,a,n,s,p,c,l,h,d,u,y,v,g,m,_,f,G,w,E,S,T,b,C,O,I,x,A,P,k,H,M,K,R,D,L,U,V,F){"use strict";function Y(e){return Object.freeze({__proto__:null,default:e})}const W="esri.widgets.Sketch.SketchViewModel",q=h.getLogger(W),Z={defaultZ:0},z={reshapeOptions:{edgeOperation:"split",shapeOperation:"move",vertexOperation:"move"},enableMoveAllGraphics:!0,enableRotation:!0,enableScaling:!0,multipleSelectionEnabled:!0,preserveAspectRatio:!1,toggleToolOnClick:!0,enableZ:!0,tool:"transform"};let N=function(i){function o(e){var t;return(t=i.call(this,e)||this)._activeFillGraphic=null,t._activeLineGraphic=null,t._centerIndicatorGraphic=null,t._centerSymbol=new L({style:"cross",size:6,color:[255,255,255]}),t._defaultSegmentOffset=48,t._numUpdating=0,t._handles=new l,t._internalGraphicsLayer=new w({listMode:"hide",internal:!0,title:"SVM Internal"}),t._lineGraphic=null,t._operationHandle=null,t._vertexGraphics=[],t._viewHandles=new l,t._doUnnormalization=!1,t.activeFillSymbol=new U({style:"solid",color:[150,150,150,.2],outline:{color:[50,50,50],width:0}}),t.activeLineSymbol=new V({data:{type:"CIMSymbolReference",symbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",effects:[{type:"CIMGeometricEffectDashes",dashTemplate:[3.75,3.75],lineDashEnding:"HalfPattern",controlPointEnding:"NoConstraint"}],enable:!0,capStyle:"Butt",joinStyle:"Round",miterLimit:10,width:1.6,color:[255,255,255,255]},{type:"CIMSolidStroke",enable:!0,capStyle:"Butt",joinStyle:"Round",miterLimit:10,width:2,color:[0,0,0,255]}]}}}),t.activeVertexSymbol=new L({style:"circle",size:6,color:[255,127,0,1],outline:{color:[50,50,50],width:1}}),t.allowDeleteKey=!0,t.layer=null,t.pointSymbol=new L({style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}}),t.polygonSymbol=new U({color:[150,150,150,.2],outline:{color:[50,50,50],width:2}}),t.polylineSymbol=new F({color:[130,130,130,1],width:2}),t._snappingManager=null,t.updateGraphics=new n,t.updateOnGraphicClick=!0,t.updatePointSymbol=new L({size:10,color:[0,200,255,.5],outline:{color:"black",width:1}}),t.updatePolygonSymbol=new U({color:[12,207,255,.2],outline:{join:"round",color:[12,207,255],width:2}}),t.updatePolylineSymbol=new F({color:[12,207,255],width:2}),t.vertexSymbol=new L({style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}}),t._moduleLoaderAbortController=null,t._viewReadyAbortController=null,t._originalAutoOpenEnabled=null,t.defaultCreateOptions=Z,t.defaultUpdateOptions=z,t.snappingOptions=new M,t}t._inheritsLoose(o,i);var a=o.prototype;return a.initialize=function(){this._handles.add([v.watch(this,"layer",(()=>{this.cancel(),this._internalGraphicsLayer.elevationInfo=d.isSome(this.layer)?this.layer.elevationInfo:null})),v.on(this,"view.map.layers","change",(e=>{e.removed.includes(this.layer)&&this.cancel()})),v.on(this,"layer.graphics","change",(e=>{if(d.isSome(this._operationHandle))for(const t of e.removed)this.updateGraphics.includes(t)&&(this.updateGraphics.length>1?this._operationHandle.removeFromSelection(t):this._operationHandle.cancel())})),v.init(this,"layer.elevationInfo",(()=>{this.cancel(),this._internalGraphicsLayer.elevationInfo=d.isSome(this.layer)?this.layer.elevationInfo:null}),!0),v.init(this,"view",(t=>{d.destroyMaybe(this._snappingManager),t&&(this._snappingManager=new H.SnappingManager({view:t,options:this.snappingOptions}),"3d"===t.type&&(new Promise((function(t,i){e(["../../views/3d/interactive/editingTools"],t,i)})),new Promise((function(t,i){e(["../../views/3d/layers/GraphicsLayerView3D"],(function(e){t(Y(e))}),i)}))))}),!0)])},a.destroy=function(){this.cancel(),this._handles=d.destroyMaybe(this._handles),this._viewHandles=d.destroyMaybe(this._viewHandles),this._removeDefaultLayer(),d.destroyMaybe(this._draw),d.destroyMaybe(this._snappingManager),this._set("view",null),this.emit("destroy")},a.cancel=function(){this._moduleLoaderAbortController=d.abortMaybe(this._moduleLoaderAbortController),this._viewReadyAbortController=d.abortMaybe(this._viewReadyAbortController),this._operationHandle&&this._operationHandle.cancel()},a.complete=function(){this._operationHandle&&this._operationHandle.complete()},a.delete=function(){const{state:e,updateGraphics:t}=this;if("active"===e&&t.length){const{activeTool:e,layer:i}=this,o=t.toArray();i.removeMany(o),this.cancel(),this._emitDeleteEvent({graphics:o,tool:e})}},a.create=function(){var e=t._asyncToGenerator((function*(e,t){if(yield this._waitViewReady(),"disabled"===this.state)throw this.layer||this._logError("sketch:missing-property","Property 'layer' is missing on SketchViewModel."),this.view||this._logError("sketch:missing-property","Property 'view' is missing on SketchViewModel."),u.createAbortError();if(this.cancel(),this.view.activeTool=null,!e)return void this._logError("sketch:missing-parameter","Missing parameter 'tool'.");const i=yield this._setupCreateOperation(e,t);if(d.isNone(i)||this.destroyed)return;let o=null;"2d"===this.view.type&&(o=this.view.map.layers.findIndex((e=>e.id===I.SNAPPING_GRAPHICS_LAYER_ID)),o=o>-1?o:null),A.addUniqueLayer(this.view,this._internalGraphicsLayer,o);const r=()=>{if(i===this._operationHandle){const t=this.createGraphic,o=this._operationHandle.cancelled;this._operationHandle.destroy(),this._operationHandle=null,this._set("createGraphic",null),this.view&&this.view.map&&this.view.map.remove(this._internalGraphicsLayer),i.cancelled||null==t||this.layer.add(t),this.emit("create",{graphic:t,state:o?"cancel":"complete",tool:e,toolEventInfo:null,type:"create"})}};i.on("complete",r),this._operationHandle=i,this.view.ready&&E.isDOMContainer(this.view)&&this.view.focus()}));function i(t,i){return e.apply(this,arguments)}return i}(),a.update=function(){var e=t._asyncToGenerator((function*(e,t){yield this._waitViewReady();const{layer:i,view:o,state:r}=this;if("disabled"===r)throw o||this._logError("sketch:missing-property","Property 'view' is missing on SketchViewModel."),i||this._logError("sketch:missing-property","Property 'layer' is missing on SketchViewModel."),u.createAbortError();this.cancel(),this.view.activeTool=null;const a=Array.isArray(e)?e:[e];if(null==e||!a||!a.length)return void this._logError("sketch:missing-parameter","Missing parameter 'graphics'.");if(a.some((e=>e.layer!==i?(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics missing from the supplied GraphicsLayer."),!0):d.isNone(e.geometry)?(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics with an unsupported geometry."),!0):"2d"===o.type&&!o.spatialReference.equals(e.geometry.spatialReference)&&(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics with a spatial reference different from the supplied IMapView."),!0))))return;const n=yield this._setupUpdateOperation(a,t);this.destroyed||d.isNone(n)||Q(n)||(A.addUniqueLayer(this.view,this._internalGraphicsLayer),this._setUpdateOperationHandle(n,t),this.emit("update",{graphics:a,state:"start",aborted:!1,tool:n.tool,toolEventInfo:null,type:"update"}))}));function i(t,i){return e.apply(this,arguments)}return i}(),a.undo=function(){this.canUndo()&&this._operationHandle.undo()},a.redo=function(){this.canRedo()&&this._operationHandle.redo()},a.canUndo=function(){return!(!this._operationHandle||!this._operationHandle.canUndo())},a.canRedo=function(){return!(!this._operationHandle||!this._operationHandle.canRedo())},a.toggleUpdateTool=function(){this._operationHandle&&this._operationHandle.toggleTool&&this._operationHandle.toggleTool()},a._getFirstHit=function(){var e=t._asyncToGenerator((function*(e){const t=[];switch(this.view.type){case"2d":{const r=yield this.view.hitTest(e);if(r.results.length>0){const e=r.results[0];if(e.graphic){var i,o;const r=e.graphic;"vector-tile"!==(null==(i=r.layer)?void 0:i.type)&&"imagery"!==(null==(o=r.layer)?void 0:o.type)&&t.push(e)}}}break;case"3d":{const i=[this.view.map.ground];this.view.map.allLayers.forEach((e=>{"integrated-mesh"===e.type&&i.push(e)}));const o=yield this.view.hitTest(e,{exclude:i});if(o.results.length>0){const e=o.results[0];(!o.ground.mapPoint||this.view.map.ground.opacity<1||o.ground.distance-e.distance>-Math.min(3*o.ground.distance,"global"===this.view.viewingMode?f.getReferenceEllipsoid(this.view.renderCoordsHelper.spatialReference).radius/this.view.renderCoordsHelper.unitInMeters:Number.POSITIVE_INFINITY))&&t.push(e)}}}return{screenPoint:e,results:t}}));function i(t){return e.apply(this,arguments)}return i}(),a._generateViewHandles=function(e){var i=this;return[e.on("immediate-click",function(){var o=t._asyncToGenerator((function*(t){const o="active"===i.state&&"create"===i._operationHandle.type;if("disabled"===i.state||o||!i.updateOnGraphicClick)return;i._beginAsyncOperation();const r=(yield t.async((()=>i._getFirstHit(K.createScreenPointFromEvent(t))))).results;let a=null;if(r.length){for(const n of r)if(n.graphic){const o=n.graphic;if(i.updateGraphics.includes(o)||o.layer===i.layer){t.stopPropagation(),a=o;break}"2d"!==e.type||i._isComponentGraphic(o)||"active"!==i.state||i.cancel()}}else"active"===i.state&&i.cancel();d.isSome(a)&&!i.updateGraphics.includes(a)&&(yield i.update([a],{...i.defaultUpdateOptions,reshapeOptions:{...i.defaultUpdateOptions.reshapeOptions}})),i._endAsyncOperation()}));return function(e){return o.apply(this,arguments)}}(),P.ViewEventPriorities.WIDGET)]},a._setupCreateOperation=function(){var e=t._asyncToGenerator((function*(e,t){if(!e)return null;const i={hasZ:"3d"===this.view.type,...this.defaultCreateOptions,...t};let o;if("2d"===this.view.type)switch(e){case"point":o=this._setupCreatePointOperation(e,i);break;case"multipoint":o=yield this._setupCreateMultipointOperation(e,i);break;case"polygon":case"polyline":o=yield this._setupCreatePolyOperation(e,i);break;case"rectangle":o=yield this._setupCreateRectangleOperation(e,i);break;case"circle":o=yield this._setupCreateCircleOperation(e,i)}else{const t=yield this._setupCreate3DOperation(e,this.view,i);if(d.isNone(t)||Q(t))return null;o=t}return o}));function i(t,i){return e.apply(this,arguments)}return i}(),a._setupCreate3DOperation=function(){var i=t._asyncToGenerator((function*(t,i,o){if("multipoint"===t)return null;this._removeCreateOperationGraphics();const r="rectangle"!==t,a="rectangle"!==t;this.snappingOptions.enabledToggled=!1;const n=yield this._requireModule(new Promise((function(t,i){e(["../../views/3d/interactive/editingTools"],t,i)})));if(Q(n))return n;if(this.destroyed)return null;const s=new n.module.DrawGraphicTool({view:i,mode:"rectangle"===t||"circle"===t?"hybrid":"click",...o,elevationInfo:this.layer.elevationInfo,geometryType:t,createGraphicSymbol:this._getGraphicSymbolFromTool(t),snapToScene:!d.isSome(this.layer.elevationInfo)||"absolute-height"===this.layer.elevationInfo.mode,snappingManager:this._snappingManager,forceUniformSize:a,centered:r});this.view.tools.add(s);let p=null;this.view.activeTool=s;const c=[this.view.on("key-down",(e=>{if(e.key===k.SKETCH_KEYS.pan)e.stopPropagation(),e.repeat||(s.enabled=!1);else if(e.key===k.SKETCH_KEYS.complete)e.stopPropagation(),s.completeCreateOperation();else if(e.key!==k.SKETCH_KEYS.vertexAdd||e.repeat)e.key===k.SKETCH_KEYS.undo?(e.stopPropagation(),l.undo()):e.key===k.SKETCH_KEYS.redo?(e.stopPropagation(),l.redo()):e.key!==k.SKETCH_KEYS.snappingToggle||"rectangle"===t||"circle"===t||e.repeat?e.key!==k.SKETCH_KEYS.constraint||"rectangle"!==t&&"circle"!==t||e.repeat?e.key===k.SKETCH_KEYS.center&&(e.repeat||(s.centered=!r,e.stopPropagation())):(s.forceUniformSize=!a,e.stopPropagation()):(this.snappingOptions.enabledToggled=!0,e.stopPropagation());else{const t=s.drawOperation.geometryType;"polyline"!==t&&"polygon"!==t||(e.stopPropagation(),s.drawOperation.commitStagedVertex())}}),P.ViewEventPriorities.WIDGET),this.view.on("key-up",(e=>{e.key===k.SKETCH_KEYS.pan?s.enabled=!0:e.key===k.SKETCH_KEYS.snappingToggle&&"rectangle"!==t&&"circle"!==t?(this.snappingOptions.enabledToggled=!1,e.stopPropagation()):e.key!==k.SKETCH_KEYS.constraint||"rectangle"!==t&&"circle"!==t?e.key===k.SKETCH_KEYS.center&&(s.centered=r,e.stopPropagation()):(s.forceUniformSize=a,e.stopPropagation())}),P.ViewEventPriorities.WIDGET),s.on("vertex-add",(e=>{switch(p=d.isNone(p)?"start":"active",e.operation){case"apply":this.emit("create",{graphic:d.unwrap(s.createGraphic),state:p,tool:this.activeTool,toolEventInfo:e,type:"create"});break;case"undo":this._emitUndoEvent({graphics:[d.unwrap(s.createGraphic)],tool:t});break;case"redo":this._emitRedoEvent({graphics:[d.unwrap(s.createGraphic)],tool:t})}})),s.on("cursor-update",(e=>{s.drawOperation.numCommittedVertices>0&&this.emit("create",{graphic:d.unwrap(s.createGraphic),state:"active",tool:this.activeTool,toolEventInfo:{coordinates:e.vertices[0].coordinates,type:"cursor-update"},type:"create"})})),s.on("vertex-remove",(e=>{switch(e.operation){case"apply":this.emit("create",{graphic:d.unwrap(s.createGraphic),state:"active",tool:this.activeTool,toolEventInfo:e,type:"create"});break;case"undo":this._emitUndoEvent({graphics:[d.unwrap(s.createGraphic)],tool:t});break;case"redo":this._emitRedoEvent({graphics:[d.unwrap(s.createGraphic)],tool:t})}})),s.on("complete",(e=>{this._removeCreateOperationGraphics(),this._set("createGraphic",d.unwrap(e.graphic)),p="complete",e.aborted?l&&l.cancel():l&&l.complete()}))],l=new R.OperationHandle({activeComponent:s,tool:t,type:"update",onEnd:()=>{var e;c.forEach((e=>e.remove())),c.length=0,null==(e=this.view.tools)||e.remove(s),s.destroy()},undo:()=>{s.canUndo&&s.undo()},redo:()=>{s.canRedo&&s.redo()},canUndo:()=>s.canUndo,canRedo:()=>s.canRedo});return l}));function o(e,t,o){return i.apply(this,arguments)}return o}(),a._getGraphicSymbolFromTool=function(e){switch(e){case"point":return this.pointSymbol;case"polyline":return this.polylineSymbol;case"circle":case"rectangle":case"polygon":return this.polygonSymbol;default:return null}},a._setupCreatePointOperation=function(e,t){const i={elevationInfo:this.layer.elevationInfo,hasZ:t.hasZ,defaultZ:t.defaultZ,snappingManager:this._snappingManager,interactiveUndoDisabled:!0},o=this._draw.create(e,i),a=[o.on("cursor-update",(e=>{d.isSome(e.vertexIndex)?this._displayCrosshairCursor():this._displayDefaultCursor()})),o.on("draw-complete",(e=>{const t=this.createPointFromVertex(e.vertices[0]),i=new r(t,this.pointSymbol);this._set("createGraphic",i),s&&s.complete()}))],n=[this.view.on("key-down",(e=>{e.key===k.SKETCH_KEYS.cancel&&(s&&s.cancel(),e.stopPropagation())}),P.ViewEventPriorities.WIDGET)],s=this._operationHandleForCreateAction(o,[...a,...n],e);return s},a._setupCreateMultipointOperation=function(){var e=t._asyncToGenerator((function*(e,t){const i=yield x.loadCreateUtils(),o={...t,elevationInfo:this.layer.elevationInfo,snappingManager:this._snappingManager,interactiveUndoDisabled:!0},r=this._draw.create(e,o);let a=null;const n=[],s=this._operationHandleForCreateAction(r,n,e);return n.push(r.on("vertex-add",(t=>{const{type:o,vertexIndex:r,vertices:n}=t,s=n[r];a=t,this._drawMultipointGraphic(i,n,!0),this.emit("create",{graphic:this.createGraphic,state:1===n.length?"start":"active",tool:e,toolEventInfo:{added:s,vertices:[{coordinates:s,componentIndex:0,vertexIndex:r}],type:o},type:"create"})})),r.on("vertex-remove",(t=>{const{type:o,vertexIndex:r,vertices:n}=t,s=n[r];a=t,this._drawMultipointGraphic(i,n,!0),this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{removed:s,vertices:[{coordinates:s,componentIndex:0,vertexIndex:r}],type:o},type:"create"})})),r.on("vertex-update",(t=>{const{type:o,vertexIndex:r,vertices:n}=t,s=n[r];a=t,this._drawMultipointGraphic(i,n,!0),this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{type:o,updated:s,vertices:[{coordinates:s,componentIndex:0,vertexIndex:r}]},type:"create"})})),r.on("cursor-update",(e=>{a=e})),r.on("draw-complete",(e=>{const t=e.vertices.slice(0),o=i.createMultipoint(t,this.view.spatialReference);o&&this.createGraphic&&(this.createGraphic.geometry=o),s&&s.complete()})),r.on("undo",(e=>{const t=e.vertices,o=a&&"cursor-update"!==a.type;this._resetCreateOperationGraphics(),t.length&&this._drawMultipointGraphic(i,t,o)})),r.on("redo",(e=>{const t=e.vertices,o=a&&"cursor-update"!==a.type;this._resetCreateOperationGraphics(),t.length&&this._drawMultipointGraphic(i,t,o)}))),n.push(this.view.on("pointer-move",(()=>this._displayCrosshairCursor()),P.ViewEventPriorities.WIDGET),this.view.on("key-down",(e=>this._getCommonUpdateOperationKeyDownHandlers(s,e)),P.ViewEventPriorities.WIDGET)),s}));function i(t,i){return e.apply(this,arguments)}return i}(),a._setupCreatePolyOperation=function(){var e=t._asyncToGenerator((function*(e,t){const i=yield x.loadCreateUtils(),o={...t,elevationInfo:this.layer.elevationInfo,snappingManager:this._snappingManager,interactiveUndoDisabled:!0};let r=null;("polyline"===e||"polygon"===e)&&(r=this._draw.create(e,o));let a=null;const n=[r.on("vertex-add",(t=>{const{type:o,vertexIndex:r,vertices:n}=t,s=n[r];this._snapLastPolygonVertexToFirst(e,n),a=t,this._drawVertexGraphics(i,e,n,{userClicked:!0}),this.emit("create",{graphic:this.createGraphic,state:1===n.length?"start":"active",tool:e,toolEventInfo:{added:s,vertices:[{coordinates:s,componentIndex:0,vertexIndex:r}],type:o},type:"create"})})),r.on("vertex-remove",(t=>{const{type:o,vertexIndex:r,vertices:n}=t,s=n[r];this._snapLastPolygonVertexToFirst(e,n),a=t,this._drawVertexGraphics(i,e,n,{userClicked:!0}),this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{removed:s,vertices:[{coordinates:s,componentIndex:0,vertexIndex:r}],type:o},type:"create"})})),r.on("vertex-update",(t=>{const{type:o,vertexIndex:r,vertices:n}=t,s=n[r];this._snapLastPolygonVertexToFirst(e,n),a=t,this._drawVertexGraphics(i,e,n,{userClicked:!0}),this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{type:o,updated:s,vertices:[{coordinates:s,componentIndex:0,vertexIndex:r}]},type:"create"})})),r.on("cursor-update",(t=>{const{type:o,vertices:r}=t;if(t.mapPoint&&(this._snapLastPolygonVertexToFirst(e,r),a=t,this._drawVertexGraphics(i,e,r,{userClicked:!1}),r.length>1)){const t=r[r.length-1];this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{coordinates:t,type:o},type:"create"})}})),r.on("draw-complete",(t=>{const o=t.vertices.slice(0);let r=null;"polyline"===e?r=i.createPolyline([o],this.view.spatialReference,this._doUnnormalization):"polygon"===e&&(r=i.createPolygon([o],this.view.spatialReference,this._doUnnormalization,!0)),r&&(this.createGraphic.geometry=r),p&&p.complete()})),r.on("undo",(t=>{const o=t.vertices,r=a&&"cursor-update"!==a.type;this._resetCreateOperationGraphics(),this._snapLastPolygonVertexToFirst(e,o),o.length&&this._drawVertexGraphics(i,e,o,{userClicked:r})})),r.on("redo",(t=>{const o=t.vertices,r=a&&"cursor-update"!==a.type;this._resetCreateOperationGraphics(),this._snapLastPolygonVertexToFirst(e,o),o.length&&this._drawVertexGraphics(i,e,o,{userClicked:r})}))],s=[this.view.on("pointer-move",(e=>{d.isSome(r.getCoordsFromScreenPoint(y.createScreenPoint(e.x,e.y)))?this._displayCrosshairCursor():this._displayDefaultCursor()}),P.ViewEventPriorities.WIDGET),this.view.on("key-down",(e=>{e.key!==k.SKETCH_KEYS.snappingToggle||e.repeat?e.key===k.SKETCH_KEYS.undo&&p&&p.canUndo()?(e.stopPropagation(),p.undo()):e.key===k.SKETCH_KEYS.redo&&p&&p.canRedo()?(e.stopPropagation(),p.redo()):e.key===k.SKETCH_KEYS.cancel&&p&&p.cancel():(this.snappingOptions.enabledToggled=!0,e.stopPropagation())}),P.ViewEventPriorities.WIDGET),this.view.on("key-up",(e=>{e.key===k.SKETCH_KEYS.snappingToggle&&(this.snappingOptions.enabledToggled=!1,e.stopPropagation())}),P.ViewEventPriorities.WIDGET)];if("polygon"===e){const e=(e,t,i)=>{if(!e||!e.layer||!e.visible)return!1;const o=this.view.toScreen(e.geometry);return this._isWithinScreenDistance(o,t,i)},t=t=>{if(!(this._vertexGraphics.length<=2))return e(this._vertexGraphics[0],t,this._getVertexIntersectDistance())};let i=!1;s.push(this.view.on("pointer-move",(()=>{i=!1}),P.ViewEventPriorities.WIDGET),this.view.on("pointer-down",(o=>{if(t(o))return i=!0,void o.stopPropagation();this._vertexGraphics.some((t=>e(t,o,this._getVertexIntersectDistance())))&&o.stopPropagation()}),P.ViewEventPriorities.WIDGET),this.view.on("pointer-up",(e=>{i&&(e.stopPropagation(),r.complete())})))}const p=this._operationHandleForCreateAction(r,[...n,...s],e);return p}));function i(t,i){return e.apply(this,arguments)}return i}(),a._setupCreateCircleOperation=function(){var e=t._asyncToGenerator((function*(e,t){const i=yield x.loadCreateUtils(),o={...t,elevationInfo:this.layer.elevationInfo,snappingManager:this._snappingManager,interactiveUndoDisabled:!0},a=this._draw.create(e,o);let n=!1,s=!0;const p=[a.on("vertex-add",(t=>{const{type:o,vertexIndex:r,vertices:p}=t,c=p[r];this._drawSegmentGraphic(i,e,p,{centered:s,constrainToggle:n},a.viewAlignedCoordinateSystem),this.emit("create",{graphic:this.createGraphic,state:1===p.length?"start":"active",tool:e,toolEventInfo:{added:c,vertices:[{coordinates:c,componentIndex:0,vertexIndex:r}],type:o},type:"create"})})),a.on("cursor-update",(t=>{const{type:o,vertices:r}=t;if(this._drawSegmentGraphic(i,e,r,{centered:s,constrainToggle:n},a.viewAlignedCoordinateSystem),2===r.length){const t=r[r.length-1];this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{coordinates:t,type:o},type:"create"})}})),a.on("draw-complete",(e=>{const t=e.vertices.slice(0);let o;1===t.length?(t.push(a.viewAlignedCoordinateSystem.makeMapPoint(t[0][0]+this._defaultSegmentOffset*this.view.resolution,t[0][1])),o=i.createCircle(t,a.viewAlignedCoordinateSystem,!0,this.view.resolution)):o=n?i.createEllipse(t,a.viewAlignedCoordinateSystem,s):i.createCircle(t,a.viewAlignedCoordinateSystem,s,this.view.resolution),this.createGraphic?this.createGraphic.geometry=o:(this._removeCreateGraphic(),this._set("createGraphic",new r(o,this.polygonSymbol))),l&&l.complete()}))],c=[this.view.on("pointer-move",(e=>{d.isSome(a.getCoordsFromScreenPoint(y.createScreenPoint(e.x,e.y)))?this._displayCrosshairCursor():this._displayDefaultCursor()}),P.ViewEventPriorities.WIDGET),this.view.on("key-down",(t=>{t.key===k.SKETCH_KEYS.constraint?n||(n=!0,this._drawSegmentGraphic(i,e,a.vertices,{centered:s,constrainToggle:n},a.viewAlignedCoordinateSystem)):t.key===k.SKETCH_KEYS.center?s&&(s=!1,this._drawSegmentGraphic(i,e,a.vertices,{centered:s,constrainToggle:n},a.viewAlignedCoordinateSystem)):t.key===k.SKETCH_KEYS.cancel&&l&&l.cancel()}),P.ViewEventPriorities.WIDGET),this.view.on("key-up",(t=>{t.key===k.SKETCH_KEYS.constraint?(n=!1,this._drawSegmentGraphic(i,e,a.vertices,{centered:s,constrainToggle:n},a.viewAlignedCoordinateSystem)):t.key===k.SKETCH_KEYS.center&&(s=!0,this._drawSegmentGraphic(i,e,a.vertices,{centered:s,constrainToggle:n},a.viewAlignedCoordinateSystem))}),P.ViewEventPriorities.WIDGET)],l=this._operationHandleForCreateAction(a,[...p,...c],e);return l}));function i(t,i){return e.apply(this,arguments)}return i}(),a._setupCreateRectangleOperation=function(){var e=t._asyncToGenerator((function*(e,t){const i=yield x.loadCreateUtils(),o={...t,elevationInfo:this.layer.elevationInfo,snappingManager:this._snappingManager,interactiveUndoDisabled:!0},a=this._draw.create(e,o);let n=!1,s=!1;const p=[a.on("vertex-add",(t=>{const{type:o,vertexIndex:r,vertices:p}=t,c=p[r];this._drawSegmentGraphic(i,e,p,{centered:s,constrainToggle:n},a.viewAlignedCoordinateSystem),this.emit("create",{graphic:this.createGraphic,state:1===p.length?"start":"active",tool:e,toolEventInfo:{added:c,vertices:[{coordinates:c,componentIndex:0,vertexIndex:r}],type:o},type:"create"})})),a.on("cursor-update",(t=>{const{type:o,vertices:r}=t;if(this._drawSegmentGraphic(i,e,r,{centered:s,constrainToggle:n},a.viewAlignedCoordinateSystem),2===r.length){const t=r[r.length-1];this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{coordinates:t,type:o},type:"create"})}})),a.on("draw-complete",(e=>{const t=e.vertices.slice(0);let o=null;1===t.length&&(n=!1,s=!1),o=n?i.createSquare(t,a.viewAlignedCoordinateSystem,s):i.createRectangle(t,a.viewAlignedCoordinateSystem,s),this.createGraphic?this.createGraphic.geometry=o:(this._removeCreateGraphic(),this._set("createGraphic",new r(o,this.polygonSymbol))),l&&l.complete()}))],c=[this.view.on("pointer-move",(e=>{d.isSome(a.getCoordsFromScreenPoint(y.createScreenPoint(e.x,e.y)))?this._displayCrosshairCursor():this._displayDefaultCursor()}),P.ViewEventPriorities.WIDGET),this.view.on("key-down",(t=>{t.key===k.SKETCH_KEYS.constraint?n||(n=!0,this._drawSegmentGraphic(i,e,a.vertices,{centered:s,constrainToggle:n},a.viewAlignedCoordinateSystem)):t.key===k.SKETCH_KEYS.center?s||(s=!0,this._drawSegmentGraphic(i,e,a.vertices,{centered:s,constrainToggle:n},a.viewAlignedCoordinateSystem)):t.key===k.SKETCH_KEYS.cancel&&l&&l.cancel()}),P.ViewEventPriorities.WIDGET),this.view.on("key-up",(t=>{t.key===k.SKETCH_KEYS.constraint?(n=!1,this._drawSegmentGraphic(i,e,a.vertices,{centered:s,constrainToggle:n},a.viewAlignedCoordinateSystem)):t.key===k.SKETCH_KEYS.center&&(s=!1,this._drawSegmentGraphic(i,e,a.vertices,{centered:s,constrainToggle:n},a.viewAlignedCoordinateSystem))}),P.ViewEventPriorities.WIDGET)],l=this._operationHandleForCreateAction(a,[...p,...c],e);return l}));function i(t,i){return e.apply(this,arguments)}return i}(),a._setupUpdateOperation=function(){var e=t._asyncToGenerator((function*(e,t){const{layer:i,view:o}=this,r={tool:this._defaultUpdateTool,...this.defaultUpdateOptions,...t,reshapeOptions:{...this.defaultUpdateOptions.reshapeOptions,...null==t?void 0:t.reshapeOptions}},a=r.tool;for(const n of e)i.remove(n),i.add(n);if("3d"===o.type){if(0===e.length)return null;switch(a){case"move":return this._setupMove3DOperation(e,r,o,a);case"reshape":{if(e.length>1)return this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),null;const t=b.isSupportedGraphic(e[0]);return 0===t?this._setupReshape3DOperation(e[0],r,o):(this._logError("sketch:reshape",`Reshape operation not supported for provided graphic(s) (${S.isSupportedGraphicResultMessage(t)}).`),null)}case"transform":return this._setupGraphicTransform3DOperation(e,r,o)}}switch(a){case"move":return this._setupMoveOperation(e,r,o);case"reshape":{if(e.length>1)return this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),null;const t=b.isSupportedGraphic(e[0]);return 0===t?this._setupTransformOrReshapeOperation(e,a,r,o):(this._logError("sketch:reshape",`Reshape operation not supported for provided graphic(s) (${S.isSupportedGraphicResultMessage(t)}).`),null)}case"transform":return this._setupTransformOrReshapeOperation(e,1===e.length&&"point"===d.get(e[0].geometry,"type")?"reshape":a,r,o)}}));function i(t,i){return e.apply(this,arguments)}return i}(),a._setupMove3DOperation=function(){var i=t._asyncToGenerator((function*(i,o,r,a,n=!1){var s=this;for(const e of i){const t=T.isSupportedGraphic(e);if(0!==t)return this._logError("sketch:move",`Move operation not supported for provided graphic(s) (${S.isSupportedGraphicResultMessage(t)}).`),null}const p=yield this._requireModule(new Promise((function(t,i){e(["../../views/3d/interactive/editingTools"],t,i)})));if(Q(p))return p;const c=new p.module.GraphicMoveTool({view:r,enableZ:o.enableZ,snappingManager:this._snappingManager});this.view.tools.add(c),c.graphics.addMany(i),n||this.updateGraphics.addMany(i);const l=[],h=new R.OperationHandle({activeComponent:c,tool:a,type:"update",onEnd:()=>{var e;l.forEach((e=>e.remove())),l.length=0,null==(e=this.view.tools)||e.remove(c),c.destroyed||c.destroy()},undo:()=>{B(h,this.updateGraphics.toArray()),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:a})},redo:()=>{j(h,this.updateGraphics.toArray()),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:a})},addToSelection:e=>{this.updateGraphics.push(e),c.graphics.push(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:e=>{const t=this.updateGraphics.indexOf(e);h.history.undo.forEach((e=>e.updates.splice(t,1))),h.history.redo.forEach((e=>e.updates.splice(t,1))),this.updateGraphics.remove(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),0!==this.updateGraphics.length?c.graphics.remove(e):h.complete()},toggleTool:(d=t._asyncToGenerator((function*(){if(1!==s.updateGraphics.length||!1===o.toggleToolOnClick)return;if("transform"!==a)return;const e=s.updateGraphics.getItemAt(0);if(0!==b.isSupportedGraphic(e))return;const t=yield s._setupReshape3DOperation(e,o,r,!0);Q(t)||(h.onEnd(),h.destroy(),s._setUpdateOperationHandle(t,o))})),function(){return d.apply(this,arguments)})});var d;return l.push(...this._getHandlesForComponent(h,o),this.view.on("immediate-click",(e=>this._getCommonUpdateOperationClickHandlers(h,e,o)),P.ViewEventPriorities.WIDGET),r.on("key-down",(e=>{this._getCommonUpdateOperationKeyDownHandlers(h,e),e.key===k.SKETCH_KEYS.snappingToggle&&(this.snappingOptions.enabledToggled=!0,e.stopPropagation())}),P.ViewEventPriorities.WIDGET),r.on("key-up",(e=>{e.key===k.SKETCH_KEYS.snappingToggle&&(this.snappingOptions.enabledToggled=!1,e.stopPropagation())}),P.ViewEventPriorities.WIDGET)),h}));function o(e,t,o,r){return i.apply(this,arguments)}return o}(),a._setupGraphicTransform3DOperation=function(e,t,i,o=!1){if(1===e.length&&0===C.isSupportedGraphic(e[0])){const r=e[0],a=r.geometry;if(d.isSome(a)&&("point"===a.type||"mesh"===a.type))return this._setupPointTransform3DOperation(r,t,i);if(d.isSome(a)&&("polygon"===a.type||"polyline"===a.type))return this._setupPolyTransform3DOperation(r,t,i,o)}return this._setupMove3DOperation(e,t,i,"transform",o)},a._setupPointTransform3DOperation=function(){var i=t._asyncToGenerator((function*(i,o,r){var a=this;const n="transform",{enableRotation:s,enableScaling:p,enableZ:c}=o,l=yield this._requireModule(new Promise((function(t,i){e(["../../views/3d/interactive/editingTools"],t,i)})));if(Q(l))return l;const h=new l.module.GraphicTransformTool({graphic:i,view:r,enableRotation:s,enableScaling:p,enableZ:c,snappingManager:this._snappingManager});this.view.tools.add(h),this.updateGraphics.add(i);const d=[],u=new R.OperationHandle({activeComponent:h,tool:n,type:"update",onEnd:()=>{var e;d.forEach((e=>e.remove())),d.length=0,null==(e=this.view.tools)||e.remove(h),h.destroyed||h.destroy()},undo:()=>{B(u,this.updateGraphics.toArray()),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:n})},redo:()=>{j(u,this.updateGraphics.toArray()),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:n})},addToSelection:(y=t._asyncToGenerator((function*(e){a.updateGraphics.add(e),a.emit("update",{graphics:a.updateGraphics.toArray(),state:"active",aborted:!1,tool:a.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"});const t=yield a._setupMove3DOperation(a.updateGraphics.toArray(),o,r,"transform",!0);Q(t)||(u.onEnd(),u.destroy(),a._setUpdateOperationHandle(t,o))})),function(e){return y.apply(this,arguments)}),removeFromSelection:e=>{this.updateGraphics.remove(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),u.complete()},toggleTool:()=>{}});var y;return d.push(...this._getHandlesForComponent(u,o),this.view.on("immediate-click",(e=>this._getCommonUpdateOperationClickHandlers(u,e,o)),P.ViewEventPriorities.WIDGET),r.on("key-down",(e=>{this._getCommonUpdateOperationKeyDownHandlers(u,e),e.key===k.SKETCH_KEYS.snappingToggle&&(this.snappingOptions.enabledToggled=!0,e.stopPropagation())}),P.ViewEventPriorities.WIDGET),r.on("key-up",(e=>{e.key===k.SKETCH_KEYS.snappingToggle&&(this.snappingOptions.enabledToggled=!1,e.stopPropagation())}),P.ViewEventPriorities.WIDGET)),u}));function o(e,t,o){return i.apply(this,arguments)}return o}(),a._setupPolyTransform3DOperation=function(){var i=t._asyncToGenerator((function*(i,o,r,a=!1){var n=this;const s="transform",{enableRotation:p,enableScaling:c,enableZ:l,preserveAspectRatio:h}=o,d=yield this._requireModule(new Promise((function(t,i){e(["../../views/3d/interactive/editingTools"],t,i)})));if(Q(d))return d;const u=new d.module.ExtentTransformTool({graphic:i,view:r,enableRotation:p,enableScaling:c,enableZ:l,preserveAspectRatio:h});this.view.tools.add(u),a||this.updateGraphics.add(i);const y=[],v=new R.OperationHandle({activeComponent:u,tool:s,type:"update",onEnd:()=>{var e;y.forEach((e=>e.remove())),y.length=0,null==(e=this.view.tools)||e.remove(u),u.destroyed||u.destroy()},canUndo:()=>u.canUndo,undo:()=>{u.undo(),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:s})},canRedo:()=>u.canRedo,redo:()=>{u.redo(),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:s})},addToSelection:(m=t._asyncToGenerator((function*(e){n.updateGraphics.add(e),n.emit("update",{graphics:n.updateGraphics.toArray(),state:"active",aborted:!1,tool:n.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"});const t=yield n._setupMove3DOperation(n.updateGraphics.toArray(),o,r,"transform",!0);Q(t)||(v.onEnd(),v.destroy(),n._setUpdateOperationHandle(t,o))})),function(e){return m.apply(this,arguments)}),removeFromSelection:e=>{this.updateGraphics.remove(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),v.complete()},toggleTool:(g=t._asyncToGenerator((function*(){if(1!==n.updateGraphics.length||!1===o.toggleToolOnClick)return;const e=n.updateGraphics.getItemAt(0);if(0!==b.isSupportedGraphic(e))return;const t=yield n._setupReshape3DOperation(e,o,r,!0);Q(t)||(v.onEnd(),v.destroy(),n._setUpdateOperationHandle(t,o))})),function(){return g.apply(this,arguments)})});var g,m;return y.push(...this._getHandlesForComponent(v,o),this.view.on("immediate-click",(e=>this._getCommonUpdateOperationClickHandlers(v,e,o)),P.ViewEventPriorities.WIDGET),this.view.on("key-down",(e=>this._getCommonUpdateOperationKeyDownHandlers(v,e)),P.ViewEventPriorities.WIDGET),this.view.on("key-down",(e=>{e.key!==k.SKETCH_KEYS.constraint||e.repeat||(u.preserveAspectRatio=!u.preserveAspectRatio,e.stopPropagation())}),P.ViewEventPriorities.WIDGET),this.view.on("key-up",(e=>{e.key===k.SKETCH_KEYS.constraint&&(u.preserveAspectRatio=!u.preserveAspectRatio,e.stopPropagation())}),P.ViewEventPriorities.WIDGET)),v}));function o(e,t,o){return i.apply(this,arguments)}return o}(),a._setupMoveOperation=function(){var e=t._asyncToGenerator((function*(e,t,i){const o="move";this.updateGraphics.addMany(e);const r=yield this._getGraphicMover(e,t,i);if(Q(r))return r;const a=new R.OperationHandle({activeComponent:r,tool:o,type:"update",onEnd:()=>{var e;this._displayDefaultCursor(),p.forEach((e=>e.remove())),s.forEach((e=>e.remove())),p=[],s=[],r.destroy(),null==(e=this._internalGraphicsLayer)||e.removeMany([...this.updateGraphics.toArray()])},undo:()=>{const e=this.updateGraphics.toArray();B(a,e),a.refreshComponent(),this._emitUndoEvent({graphics:e,tool:o})},redo:()=>{const e=this.updateGraphics.toArray();j(a,e),a.refreshComponent(),this._emitRedoEvent({graphics:e,tool:o})},addToSelection:e=>{this.updateGraphics.push(e),r.graphics=this.updateGraphics.toArray(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:e=>{const t=this.updateGraphics.indexOf(e);a.history.undo.forEach((e=>e.updates.splice(t,1))),a.history.redo.forEach((e=>e.updates.splice(t,1))),this.updateGraphics.remove(e);const i=this.updateGraphics.toArray();this.emit("update",{graphics:i,state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),0!==this.updateGraphics.length?r.graphics=i:a.complete()}});let n=!1,s=[i.on("immediate-click",(e=>this._getCommonUpdateOperationClickHandlers(a,e,t)),P.ViewEventPriorities.WIDGET),i.on("key-down",(e=>{this._getCommonUpdateOperationKeyDownHandlers(a,e),e.key!==k.SKETCH_KEYS.constraint||e.repeat||(n=!0,r.enableMoveAllGraphics=!r.enableMoveAllGraphics)}),P.ViewEventPriorities.WIDGET),i.on("key-up",(e=>{e.key===k.SKETCH_KEYS.constraint&&n&&(n=!1,r.enableMoveAllGraphics=!r.enableMoveAllGraphics)}),P.ViewEventPriorities.WIDGET)],p=this._getHandlesForComponent(a,t);return a}));function i(t,i,o){return e.apply(this,arguments)}return i}(),a._setupReshape3DOperation=function(){var i=t._asyncToGenerator((function*(i,o,r,a=!1){var n=this;const s="reshape",p=yield this._requireModule(new Promise((function(t,i){e(["../../views/3d/interactive/editingTools"],t,i)})));if(Q(p))return p;this.snappingOptions.enabledToggled=!1;const c=new p.module.GraphicReshapeTool({view:r,graphic:i,enableZVertex:o.enableZ&&"move"===o.reshapeOptions.vertexOperation,enableZShape:o.enableZ&&"move"===o.reshapeOptions.shapeOperation,enableMoveGraphic:"move"===o.reshapeOptions.shapeOperation||"move-xy"===o.reshapeOptions.shapeOperation,enableMidpoints:"split"===o.reshapeOptions.edgeOperation,enableEdgeOffset:"offset"===o.reshapeOptions.edgeOperation,snappingManager:this._snappingManager});r.tools.add(c),a||this.updateGraphics.add(i);const l=[],h=new R.OperationHandle({activeComponent:c,tool:s,type:"update",onEnd:()=>{var e;l.forEach((e=>e.remove())),l.length=0,null==(e=this.view.tools)||e.remove(c),c.destroyed||c.destroy()},canUndo:()=>c.canUndo,undo:()=>{c.undo(),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:s})},canRedo:()=>c.canRedo,redo:()=>{c.redo(),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:s})},addToSelection:(u=t._asyncToGenerator((function*(e){n.updateGraphics.add(e),n.emit("update",{graphics:n.updateGraphics.toArray(),state:"active",aborted:!1,tool:n.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"});const t=yield n._setupMove3DOperation(n.updateGraphics.toArray(),o,r,"transform",!0);Q(t)||(h.onEnd(),h.destroy(),n._setUpdateOperationHandle(t,o))})),function(e){return u.apply(this,arguments)}),removeFromSelection:e=>{this.updateGraphics.remove(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),h.complete()},toggleTool:(d=t._asyncToGenerator((function*(){if(!1===o.toggleToolOnClick)return;const e=yield n._setupGraphicTransform3DOperation(n.updateGraphics.toArray(),o,r,!0);Q(e)||(h.onEnd(),h.destroy(),n._setUpdateOperationHandle(e,o))})),function(){return d.apply(this,arguments)})});var d,u;return l.push(...this._getHandlesForComponent(h,o),r.on("immediate-click",(e=>this._getCommonUpdateOperationClickHandlers(h,e,o)),P.ViewEventPriorities.WIDGET),r.on("key-down",(e=>{this._getCommonUpdateOperationKeyDownHandlers(h,e),e.key===k.SKETCH_KEYS.snappingToggle&&(this.snappingOptions.enabledToggled=!0,e.stopPropagation())}),P.ViewEventPriorities.WIDGET),r.on("key-up",(e=>{e.key===k.SKETCH_KEYS.snappingToggle&&(this.snappingOptions.enabledToggled=!1,e.stopPropagation())}),P.ViewEventPriorities.WIDGET)),h}));function o(e,t,o){return i.apply(this,arguments)}return o}(),a._setupTransformOrReshapeOperation=function(){var e=t._asyncToGenerator((function*(e,i,o,r){var a=this;const{multipleSelectionEnabled:n}=o;this.updateGraphics.addMany(e);const s="transform"===i?yield this._getBox(e,o,r):yield this._getReshape(e,o,r);if(Q(s))return s;const p=new R.OperationHandle({activeComponent:s,type:"update",onEnd:()=>{y.forEach((e=>e.remove())),u.forEach((e=>e.remove())),y=[],u=[],p.activeComponent&&!p.activeComponent.destroyed&&p.activeComponent.destroy(),this._internalGraphicsLayer.removeMany(this.updateGraphics.toArray())},undo:()=>{B(p,this.updateGraphics.toArray()),p.refreshComponent(),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:p.tool})},redo:()=>{j(p,this.updateGraphics.toArray()),p.refreshComponent(),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:p.tool})},addToSelection:(h=t._asyncToGenerator((function*(e){let t=p.activeComponent;if("reshape"===t.type){const t=[...a.updateGraphics,e];a.updateGraphics.removeAll();const i=yield a._setupMoveOperation(t,o,r);if(Q(i))return;p.onEnd(),p.destroy(),a._setUpdateOperationHandle(i,o)}else a.updateGraphics.add(e),t=t,t.graphics=a.updateGraphics.toArray(),t.refresh(),p.resetHistory();a.emit("update",{graphics:a.updateGraphics.toArray(),state:"active",aborted:!1,tool:a.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"})})),function(e){return h.apply(this,arguments)}),removeFromSelection:(l=t._asyncToGenerator((function*(e){const t=a.updateGraphics.indexOf(e);p.history.undo.forEach((e=>e.updates.splice(t,1))),p.history.redo.forEach((e=>e.updates.splice(t,1))),a.updateGraphics.remove(e);const i=a.updateGraphics.toArray();0===i.length?p.complete():1===i.length&&d.isSome(i[0].geometry)&&"point"===i[0].geometry.type?p.toggleTool():p.activeComponent.graphics=i,a.emit("update",{graphics:i,state:"active",aborted:!1,tool:a.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"})})),function(e){return l.apply(this,arguments)}),toggleTool:(c=t._asyncToGenerator((function*(){if(a.updateGraphics.length>1)return;const e=a.updateGraphics.getItemAt(0);if(d.isSome(e.geometry)&&("transform"===p.tool&&"extent"===e.geometry.type||"reshape"===p.tool&&"point"===e.geometry.type))return;let t=null;"transform"===p.tool?t=yield a._getReshape([e],o,r):"reshape"===p.tool&&(t=yield a._getBox([e],o,r)),Q(t)||(p.activeComponent.destroy(),p.activeComponent=t,p.activeComponent&&(y.forEach((e=>e.remove())),y=a._getHandlesForComponent(p,o)))})),function(){return c.apply(this,arguments)})});var c,l,h;let u=[r.on("immediate-click",function(){var e=t._asyncToGenerator((function*(e){var t;const i=yield e.async((()=>a._getFirstHit(K.createScreenPointFromEvent(e))));null!=(t=i.results)&&t.length?i.results.some((t=>{if(t.graphic){var i;const o=t.graphic;if(null!=(i=e.native)&&i.shiftKey&&n)return e.stopPropagation(),p.addToSelection(o),!0;if(o.layer===a.layer)return p.complete(),!0}return!1})):p.complete()}));return function(t){return e.apply(this,arguments)}}(),P.ViewEventPriorities.WIDGET),r.on("key-down",(e=>{if(this._getCommonUpdateOperationKeyDownHandlers(p,e),e.key!==k.SKETCH_KEYS.snappingToggle||e.repeat||(this.snappingOptions.enabledToggled=!0,e.stopPropagation()),e.key===k.SKETCH_KEYS.constraint&&!e.repeat&&p){const e=p.activeComponent;e&&"box"===e.type&&(e.preserveAspectRatio=!e.preserveAspectRatio)}}),P.ViewEventPriorities.WIDGET),r.on("key-up",(e=>{var t;if(e.key===k.SKETCH_KEYS.snappingToggle&&"reshape"===(null==p||null==(t=p.activeComponent)?void 0:t.type)&&(this.snappingOptions.enabledToggled=!1,e.stopPropagation()),e.key===k.SKETCH_KEYS.constraint&&p){const e=p.activeComponent;e&&"box"===e.type&&(e.preserveAspectRatio=!e.preserveAspectRatio)}}),P.ViewEventPriorities.WIDGET)],y=this._getHandlesForComponent(p,o);return p}));function i(t,i,o,r){return e.apply(this,arguments)}return i}(),a._getGraphicMover=function(){var i=t._asyncToGenerator((function*(t,i,o){const{enableMoveAllGraphics:r}=i,a=yield this._requireModule(new Promise((function(t,i){e(["../../views/draw/support/GraphicMover"],(function(e){t(Y(e))}),i)})));return Q(a)?a:new a.module.default({enableMoveAllGraphics:r,graphics:t,view:o,callbacks:{onGraphicMoveStart:({dx:e,dy:t,graphic:i})=>{this._displayGrabbingCursor(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:i,type:"move-start"},type:"update"})},onGraphicMove:({dx:e,dy:t,graphic:i})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:i,type:"move"},type:"update"}),onGraphicMoveStop:({dx:e,dy:t,graphic:i})=>{this._displayPointerCursor(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:i,type:"move-stop"},type:"update"})},onGraphicPointerOver:()=>this._displayPointerCursor(),onGraphicPointerOut:()=>this._displayDefaultCursor()}})}));function o(e,t,o){return i.apply(this,arguments)}return o}(),a._getBox=function(){var i=t._asyncToGenerator((function*(t,i,o){const{enableRotation:r,enableScaling:a,preserveAspectRatio:n}=i,s=yield this._requireModule(new Promise((function(t,i){e(["../../views/draw/support/Box"],(function(e){t(Y(e))}),i)})));return Q(s)?s:new s.module.default({graphics:t,enableRotation:r,enableScaling:a,preserveAspectRatio:n,layer:this._internalGraphicsLayer,view:o,callbacks:{onMoveStart:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onMove:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onMoveStop:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onScaleStart:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onScale:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onScaleStop:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onRotateStart:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onRotate:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onRotateStop:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"})}})}));function o(e,t,o){return i.apply(this,arguments)}return o}(),a._getReshape=function(){var i=t._asyncToGenerator((function*(t,i,o){var r,a;const n="split"===(null==(r=i.reshapeOptions)?void 0:r.edgeOperation),s="move"===(null==(a=i.reshapeOptions)?void 0:a.shapeOperation),p=yield this._requireModule(new Promise((function(t,i){e(["../../views/draw/support/Reshape"],(function(e){t(Y(e))}),i)})));return Q(p)?p:new p.module.default({enableMidpoints:n,enableMovement:s,graphic:t[0],layer:this._internalGraphicsLayer,snappingManager:this._snappingManager,view:o,callbacks:{onReshapeStart:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onReshape:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onReshapeStop:({mover:e,type:t})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e,type:t},type:"update"}),onMoveStart:({dx:e,dy:t,mover:i,type:o})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:i,type:o},type:"update"}),onMove:({dx:e,dy:t,mover:i,type:o})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:i,type:o},type:"update"}),onMoveStop:({dx:e,dy:t,mover:i,type:o})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:i,type:o},type:"update"}),onVertexAdd:({added:e,type:t,vertices:i})=>{const o=e.map((e=>G.geometryToCoordinates(e.geometry)));this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:o,vertices:i,type:t},type:"update"})},onVertexRemove:({removed:e,type:t,vertices:i})=>{const o=e.map((e=>G.geometryToCoordinates(e.geometry)));this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{removed:o,vertices:i,type:t},type:"update"})}}})}));function o(e,t,o){return i.apply(this,arguments)}return o}(),a._getHandlesForComponent=function(e,t){const i=e.activeComponent;switch(i.type){case"graphic-mover":return[i.on("graphic-click",(({graphic:t,viewEvent:i})=>{var o;null!=(o=i.native)&&o.shiftKey&&(i.stopPropagation(),e.removeFromSelection(t))})),i.on("graphic-move-start",(t=>e.addToHistory(J(t.allGraphics))))];case"box":return[i.on("graphic-click",(i=>this._onTransformOrReshape2DGraphicClick(e,t,i))),i.on("move-start",(t=>e.addToHistory(J(t.graphics)))),i.on("rotate-start",(t=>e.addToHistory(J(t.graphics)))),i.on("scale-start",(t=>e.addToHistory(J(t.graphics))))];case"reshape":return[i.on("graphic-click",(i=>this._onTransformOrReshape2DGraphicClick(e,t,i))),i.on("move-start",(t=>e.addToHistory(J([t.mover])))),i.on("reshape-start",(t=>e.addToHistory(J([t.graphic])))),i.on("vertex-add",(t=>e.addToHistory(J([t.oldGraphic])))),i.on("vertex-remove",(t=>e.addToHistory(J([t.oldGraphic]))))];case"move-3d":return[i.on("graphic-move-start",(t=>{e.addToHistory(J(t.allGraphics)),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:0,dy:0,mover:t.allGraphics.length>0?t.allGraphics[0]:null,type:"move-start"},type:"update"})})),i.on("graphic-move",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e.dx,dy:e.dy,mover:e.allGraphics.length>0?e.allGraphics[0]:null,type:"move"},type:"update"})})),i.on("graphic-move-stop",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:0,dy:0,mover:e.allGraphics.length>0?e.allGraphics[0]:null,type:"move-stop"},type:"update"})})),i.on("immediate-click",(i=>{i.shiftKey?this._toggleSelection([i.graphic],e,t):e.toggleTool()}))];case"transform-3d":return[i.on("record-undo",(({record:t})=>{e.addToHistory({updates:[t]})})),i.on("graphic-translate-start",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,dx:e.dxScreen,dy:e.dyScreen,type:"move-start"},type:"update"})})),i.on("graphic-translate-stop",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,dx:e.dxScreen,dy:e.dyScreen,type:"move-stop"},type:"update"})})),i.on("graphic-rotate-start",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,angle:e.angle,type:"rotate-start"},type:"update"})})),i.on("graphic-rotate-stop",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,angle:e.angle,type:"rotate-stop"},type:"update"})})),i.on("graphic-scale-start",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,xScale:e.xScale,yScale:e.yScale,type:"scale-start"},type:"update"})})),i.on("graphic-scale-stop",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,xScale:e.xScale,yScale:e.yScale,type:"scale-stop"},type:"update"})})),i.on("graphic-translate",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,dx:e.dxScreen,dy:e.dyScreen,type:"move"},type:"update"})})),i.on("graphic-rotate",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,angle:e.angle,type:"rotate"},type:"update"})})),i.on("graphic-scale",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,xScale:e.xScale,yScale:e.yScale,type:"scale"},type:"update"})})),i.on("immediate-click",(i=>{i.shiftKey?this._toggleSelection([i.graphic],e,t):e.toggleTool()}))];case"reshape-3d":return[i.on("reshape",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:e,type:"update"})})),i.on("move",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:e,type:"update"})})),i.on("vertex-add",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:e,type:"update"})})),i.on("vertex-remove",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:e,type:"update"})})),i.on("immediate-click",(i=>{i.shiftKey?this._toggleSelection([i.graphic],e,t):e.toggleTool()}))];case"draw":case"draw-3d":return null;default:return}},a._onTransformOrReshape2DGraphicClick=function(e,t,i){var o;const{graphic:r,viewEvent:a}=i;return null!=(o=a.native)&&o.shiftKey?(a.stopPropagation(),e.removeFromSelection(r)):t.toggleToolOnClick?(a.stopPropagation(),e.toggleTool()):void 0},a._setUpdateOperationHandle=function(e,t){this._operationHandle=e;const i=this.view.map;this._disablePopup(t);const o=()=>{if(e===this._operationHandle){const o=this.updateGraphics.toArray(),r=this._operationHandle.tool;this._operationHandle.destroy(),this._operationHandle=null,this._internalGraphicsLayer.removeMany(this.updateGraphics.toArray()),this.updateGraphics.removeAll(),i&&i.remove(this._internalGraphicsLayer),this._restorePopup(t),this.emit("update",{graphics:o,state:"complete",aborted:e.cancelled,tool:r,toolEventInfo:null,type:"update"})}};e.on("complete",o)},a._getCommonUpdateOperationClickHandlers=function(){var e=t._asyncToGenerator((function*(e,t,i){const o=K.createScreenPointFromEvent(t),r=(yield t.async((()=>this._getFirstHit(o)))).results;if(!r.length)return void e.complete();if(t.native.shiftKey&&this._toggleSelection(r.map((e=>e.graphic)),e,i))return void t.stopPropagation();r.some((e=>e.graphic&&this.updateGraphics.includes(e.graphic)))?t.stopPropagation():e.complete()}));function i(t,i,o){return e.apply(this,arguments)}return i}(),a._toggleSelection=function(e,t,i){const o=!!i.multipleSelectionEnabled;return e.some((e=>null!=e&&(!(!o||e.layer!==this.layer)&&(this.updateGraphics.includes(e)?t.removeFromSelection(e):t.addToSelection(e),!0))))},a._getCommonUpdateOperationKeyDownHandlers=function(e,t){if(!e)return;const i=t.key;i===k.SKETCH_KEYS.undo&&e.canUndo()?(t.stopPropagation(),e.undo()):i===k.SKETCH_KEYS.redo&&e.canRedo()?(t.stopPropagation(),e.redo()):i===k.SKETCH_KEYS.cancel?(t.stopPropagation(),e.cancel()):this.allowDeleteKey&&k.SKETCH_KEYS.delete.includes(i)&&this._onDeleteKey(t)},a._onDeleteKey=function(e){if(!this._operationHandle||"update"!==this._operationHandle.type)return;const t=this.activeComponent,i=this.updateGraphics.toArray();d.isNone(t)||"reshape-3d"===t.type||("reshape"!==t.type||1===i.length&&"point"===d.get(i[0].geometry,"type"))&&(e.stopPropagation(),this.delete())},a._drawMultipointGraphic=function(e,t,i){let o=null;if(!i&&t.length>1){const i=t.slice(0);i.pop(),o=e.createMultipoint(i,this.view.spatialReference)}else o=e.createMultipoint(t,this.view.spatialReference);this.createGraphic?this.createGraphic.geometry=o:this._set("createGraphic",new r(o,this.pointSymbol)),i&&1===t.length&&this._internalGraphicsLayer.add(this.createGraphic)},a._drawVertexGraphics=function(e,t,i,o){if(!i.length)return;const{_doUnnormalization:a,activeLineSymbol:n,activeVertexSymbol:s,polygonSymbol:p,polylineSymbol:c,vertexSymbol:l,view:{spatialReference:h}}=this,d=!(!o||!o.userClicked),u="polygon"===t,y=u?p:c;if(1===i.length){this._removeLineGraphic(),this._removeActiveLineGraphic();const t=this.createPointFromVertex(i[0]),o=u?e.createPolygon([i],h,a,!0):e.createPolyline([i],h,a);this._vertexGraphics.length?this._vertexGraphics[0].geometry=t:this._vertexGraphics.push(new r(t,s)),this.createGraphic?this.createGraphic.set({geometry:o,symbol:y}):this._set("createGraphic",new r(o,y)),d&&this._internalGraphicsLayer.add(this._vertexGraphics[0])}else if(2===i.length){const t=this.createPointFromVertex(i[1]),o=e.createPolyline([i],h,a),n=u?e.createPolygon([i],h,a,!0):e.createPolyline([i],h,a);if(!this._vertexGraphics.length){const e=this.createPointFromVertex(i[0]),t=new r(e,l);this._vertexGraphics.push(t)}if(1===this._vertexGraphics.length){const e=this._vertexGraphics[0],i=new r(t,l);this._removeLineGraphic(),this._removeActiveFillGraphic(),this._vertexGraphics.push(i),this._internalGraphicsLayer.remove(e),this._internalGraphicsLayer.add(e)}else this._vertexGraphics[1].geometry=t;this._showActiveLineGraphic(o);const s=this._vertexGraphics[0];d&&(this._activeLineGraphic.symbol=c,s.symbol=l,this._internalGraphicsLayer.add(this._vertexGraphics[1])),this.createGraphic?this.createGraphic.set({geometry:n,symbol:y}):this._set("createGraphic",new r(n,y)),this._internalGraphicsLayer.remove(s),this._internalGraphicsLayer.add(s)}else if(i.length>2){const o=u?e.createPolygon([i],h,a,!0):e.createPolyline([i],h,a);"polygon"===t&&this._showFillGraphic(o);const p=i.map((e=>e.slice())),v=p.pop(),g=[p[p.length-1],v],m=e.createPolyline([p],h,a),_=e.createPolyline([g],h,a);this._showLineGraphic(m),this._showActiveLineGraphic(_);for(let e=0;e<p.length;e++){const t=this._vertexGraphics[e];if(t)d||e!==this._vertexGraphics.length-1?t.symbol=l:t.symbol=s;else{const t=this.createPointFromVertex(i[e]);this._showVertexGraphic(t)}}if(d){this._activeLineGraphic.symbol=c;const e=i.length-1,t=this.createPointFromVertex(i[e]);this._showVertexGraphic(t)}else this._activeLineGraphic.symbol=n;this.createGraphic?this.createGraphic.set({geometry:o,symbol:y}):(this._removeCreateGraphic(),this._set("createGraphic",new r(o,y)));for(const e of this._vertexGraphics)this._internalGraphicsLayer.remove(e),this._internalGraphicsLayer.add(e)}},a._drawSegmentGraphic=function(e,t,i,o,a){if(!i.length)return;const n=!(null==o||!o.centered),s=!(null==o||!o.constrainToggle);let p;1===i.length?this._removeCenterIndicatorGraphic():("rectangle"===t?p=s?e.createSquare(i,a,n):e.createRectangle(i,a,n):"circle"===t&&(p=s?e.createEllipse(i,a,n):e.createCircle(i,a,n,this.view.resolution)),d.isSome(p)&&p.extent&&p.extent.center&&this._showCenterIndicatorGraphic(p.extent.center)),p?this.createGraphic?this.createGraphic.geometry=p:(this._removeCreateGraphic(),this._set("createGraphic",new r(p,this.polygonSymbol)),this._internalGraphicsLayer.add(this.createGraphic)):this._removeCreateGraphic()},a._showCenterIndicatorGraphic=function(e){this._centerIndicatorGraphic?this._centerIndicatorGraphic.geometry=e:(this._centerIndicatorGraphic=new r(e,this._centerSymbol),this._internalGraphicsLayer.add(this._centerIndicatorGraphic))},a._removeCenterIndicatorGraphic=function(){this._centerIndicatorGraphic&&(this._internalGraphicsLayer.remove(this._centerIndicatorGraphic),this._centerIndicatorGraphic.destroy(),this._centerIndicatorGraphic=null)},a._showActiveLineGraphic=function(e){this._activeLineGraphic?(this._activeLineGraphic.set({geometry:e,symbol:this.activeLineSymbol}),this._internalGraphicsLayer.remove(this._activeLineGraphic)):this._activeLineGraphic=new r(e,this.activeLineSymbol),this._internalGraphicsLayer.add(this._activeLineGraphic)},a._showFillGraphic=function(e){this._activeFillGraphic?(this._activeFillGraphic.set({geometry:e,symbol:this.activeFillSymbol}),this._internalGraphicsLayer.remove(this._activeFillGraphic)):this._activeFillGraphic=new r(e,this.activeFillSymbol),this._internalGraphicsLayer.add(this._activeFillGraphic)},a._showLineGraphic=function(e){this._lineGraphic?(this._lineGraphic.set({geometry:e,symbol:this.polylineSymbol}),this._internalGraphicsLayer.remove(this._lineGraphic)):this._lineGraphic=new r(e,this.polylineSymbol),this._internalGraphicsLayer.add(this._lineGraphic)},a._showVertexGraphic=function(e,t){const i=t?this.activeVertexSymbol:this.vertexSymbol,o=new r(e,i);this._vertexGraphics.push(o),this._internalGraphicsLayer.add(o)},a._resetCreateOperationGraphics=function(){this._removeActiveFillGraphic(),this._removeLineGraphic(),this._removeActiveLineGraphic(),this._removeVertexGraphics()},a._removeCreateGraphic=function(){this.createGraphic&&(this._internalGraphicsLayer.remove(this.createGraphic),this._set("createGraphic",null))},a._removeCreateOperationGraphics=function(){this._removeCenterIndicatorGraphic(),this._removeActiveLineGraphic(),this._removeActiveFillGraphic(),this._removeLineGraphic(),this._removeVertexGraphics()},a._removeActiveLineGraphic=function(){this._activeLineGraphic&&(this._internalGraphicsLayer.remove(this._activeLineGraphic),this._activeLineGraphic.destroy(),this._activeLineGraphic=null)},a._removeActiveFillGraphic=function(){this._activeFillGraphic&&(this._internalGraphicsLayer.remove(this._activeFillGraphic),this._activeFillGraphic.destroy(),this._activeFillGraphic=null)},a._removeLineGraphic=function(){this._lineGraphic&&(this._internalGraphicsLayer.remove(this._lineGraphic),this._lineGraphic.destroy(),this._lineGraphic=null)},a._removeVertexGraphics=function(){this._vertexGraphics.length&&(this._internalGraphicsLayer.removeMany(this._vertexGraphics),this._vertexGraphics.forEach((e=>e.destroy())),this._vertexGraphics=[])},a._removeDefaultLayer=function(){this._internalGraphicsLayer&&(this.view&&this.view.map&&this.view.map.remove(this._internalGraphicsLayer),this._internalGraphicsLayer.destroy(),this._internalGraphicsLayer=null)},a._operationHandleForCreateAction=function(e,t,i){return new R.OperationHandle({activeComponent:this._draw,tool:i,type:"create",onEnd:()=>{t.forEach((e=>e.remove())),t.length=0,this._removeCreateOperationGraphics(),this._internalGraphicsLayer&&this._internalGraphicsLayer.remove(this.createGraphic),this._displayDefaultCursor()},undo:()=>{e.undo(),this._emitUndoEvent({graphics:[this.createGraphic],tool:i})},redo:()=>{e.redo(),this._emitRedoEvent({graphics:[this.createGraphic],tool:i})},canUndo:()=>e&&e.canUndo(),canRedo:()=>e&&e.canRedo()})},a._isComponentGraphic=function(e){const{activeComponent:t}=this;return!(!e||d.isNone(t))&&(!(!e.attributes||!e.attributes.esriSketchTool)||("box"===t.type||"reshape"===t.type)&&t.isUIGraphic(e))},a._snapLastPolygonVertexToFirst=function(e,t){if("polygon"!==e&&t.length<=2)return;const i=t[0],o=t[t.length-1],r=this.view.toScreen(new D(i[0],i[1],this.view.spatialReference)),a=this.view.toScreen(new D(o[0],o[1],this.view.spatialReference));this._isWithinScreenDistance(r,a,this._getVertexIntersectDistance())&&(o[0]=i[0],o[1]=i[1])},a._getVertexIntersectDistance=function(){const e=3;return this.vertexSymbol&&"simple-marker"===this.vertexSymbol.type?y.pt2px(this.vertexSymbol.size)/2+e:e},a._isWithinScreenDistance=function(e,t,i){const o=e.x-t.x,r=e.y-t.y;return Math.sqrt(o*o+r*r)<=i},a._displayPointerCursor=function(){this.view&&this.view.container&&"pointer"!==this.view.cursor&&(this.view.cursor="pointer")},a._displayGrabbingCursor=function(){this.view&&this.view.container&&"grabbing"!==this.view.cursor&&(this.view.cursor="grabbing")},a._displayCrosshairCursor=function(){this.view&&this.view.container&&"crosshair"!==this.view.cursor&&(this.view.cursor="crosshair")},a._displayDefaultCursor=function(){this.view&&this.view.container&&null!==this.view.cursor&&(this.view.cursor=null)},a._logError=function(e,t,i){q.error(new p(e,t,i))},a._requireModule=function(){var e=t._asyncToGenerator((function*(e){const t=new AbortController;this._moduleLoaderAbortController=t;const i=yield e;return this._moduleLoaderAbortController!==t||t.signal.aborted?{requireError:"aborted"}:{module:i}}));function i(t){return e.apply(this,arguments)}return i}(),a._emitUndoEvent=function(e){this.emit("undo",{...e,type:"undo"})},a._emitRedoEvent=function(e){this.emit("redo",{...e,type:"redo"})},a._emitDeleteEvent=function(e){this.emit("delete",{...e,type:"delete"})},a.createPointFromVertex=function(e){return e.length>2?new D(e[0],e[1],e[2],this.view.spatialReference):new D(e[0],e[1],this.view.spatialReference)},a.test=function(){return{operationHandle:this._operationHandle,defaultUpdateOptions:z}},a.wait=function(){return v.whenNotOnce(this,"updating")},a._beginAsyncOperation=function(){this._numUpdating+=1,this.notifyChange("updating")},a._endAsyncOperation=function(){this._numUpdating-=1,this.notifyChange("updating")},a._disablePopupEnabled=function(e){var t;return"3d"!==(null==(t=this.view)?void 0:t.type)||this.updateOnGraphicClick||d.isSome(e)&&e.toggleToolOnClick},a._disablePopup=function(e){if(!this._disablePopupEnabled(e))return;const t=this.view.popup;t&&d.isNone(this._originalAutoOpenEnabled)&&(this._originalAutoOpenEnabled=t.autoOpenEnabled,t.autoOpenEnabled=!1)},a._restorePopup=function(e){if(!this._disablePopupEnabled(e))return;const t=this.view.popup;t&&d.isSome(this._originalAutoOpenEnabled)&&(t.autoOpenEnabled=this._originalAutoOpenEnabled,this._originalAutoOpenEnabled=null)},a._waitViewReady=function(){var e=t._asyncToGenerator((function*(){this.view&&(d.abortMaybe(this._viewReadyAbortController),this._viewReadyAbortController=u.createAbortController(),yield u.whenOrAbort(v.whenOnce(this.view,"ready"),this._viewReadyAbortController.signal))}));function i(){return e.apply(this,arguments)}return i}(),t._createClass(o,[{key:"_defaultUpdateTool",get:function(){return"3d"===this.view.type?"move":"transform"}},{key:"_draw",get:function(){return"ready"===this.state||"active"===this.state?new O({view:this.view}):null}},{key:"updating",get:function(){return this._numUpdating>0}},{key:"activeTool",get:function(){return this._operationHandle&&this._operationHandle.tool?this._operationHandle.tool:null}},{key:"activeComponent",get:function(){return this._operationHandle?this._operationHandle.activeComponent:null}},{key:"createGraphic",get:function(){return this.view&&"3d"===this.view.type&&d.isSome(this.activeComponent)&&"draw-3d"===this.activeComponent.type?d.unwrap(this.activeComponent.createGraphic):this._get("createGraphic")}},{key:"defaultCreateOptions",set:function(e){this._set("defaultCreateOptions",{...Z,...e})}},{key:"defaultUpdateOptions",set:function(e){this._set("defaultUpdateOptions",{...z,...e,reshapeOptions:{...z.reshapeOptions,...null==e?void 0:e.reshapeOptions}})}},{key:"snappingOptions",set:function(e){d.isSome(this._snappingManager)&&(this._snappingManager.options=e),this._set("snappingOptions",e)}},{key:"state",get:function(){var e;const t=!(null==(e=this.view)||!e.ready||!this.layer),i=this._operationHandle;return t&&i?"active":t?"ready":"disabled"}},{key:"view",get:function(){return this._get("view")},set:function(e){const t=this._get("view");if(t){const{container:e,map:i}=t;e&&(t.cursor=null),i&&i.remove(this._internalGraphicsLayer),this._viewHandles.removeAll(),this.cancel()}this._doUnnormalization=null!=e&&"3d"===e.type&&"global"===e.viewingMode;const i="view-ready";this._handles.remove(i),e&&this._handles.add(v.when(e,"ready",(t=>{this._viewHandles.removeAll(),t&&this._viewHandles.add(this._generateViewHandles(e))}),!0),i),this._set("view",e)}}]),o}(c.EventedAccessor);function B(e,t){$("undo",e.history.undo,e.history.redo,t)}function j(e,t){$("redo",e.history.redo,e.history.undo,t)}function $(e,t,i,o){const r=t.pop().updates,a=[];o.forEach(((t,i)=>{const o=r[i];null!=o&&("geometry"in o&&d.isSome(o.geometry)&&(a.push({geometry:t.geometry}),t.geometry=o.geometry),"symbol"in o&&d.isSome(o.symbol)&&(a.push({symbol:t.symbol}),t.symbol=o.symbol),"undo"in o&&(a.push(o),o[e](t)))})),i.push({updates:a})}function J(e){return{updates:e.map((e=>({geometry:e.geometry})))}}function Q(e){return"requireError"in e&&"aborted"===e.requireError}return i.__decorate([g.property({readOnly:!0})],N.prototype,"_draw",null),i.__decorate([g.property()],N.prototype,"updating",null),i.__decorate([g.property()],N.prototype,"_operationHandle",void 0),i.__decorate([g.property({readOnly:!0})],N.prototype,"activeTool",null),i.__decorate([g.property()],N.prototype,"activeFillSymbol",void 0),i.__decorate([g.property()],N.prototype,"activeLineSymbol",void 0),i.__decorate([g.property()],N.prototype,"activeVertexSymbol",void 0),i.__decorate([g.property()],N.prototype,"allowDeleteKey",void 0),i.__decorate([g.property({readOnly:!0})],N.prototype,"createGraphic",null),i.__decorate([g.property()],N.prototype,"defaultCreateOptions",null),i.__decorate([g.property()],N.prototype,"defaultUpdateOptions",null),i.__decorate([g.property()],N.prototype,"layer",void 0),i.__decorate([g.property({types:a.symbolTypes})],N.prototype,"pointSymbol",void 0),i.__decorate([g.property({types:a.symbolTypes})],N.prototype,"polygonSymbol",void 0),i.__decorate([g.property({types:a.symbolTypes})],N.prototype,"polylineSymbol",void 0),i.__decorate([g.property({type:M,nonNullable:!0})],N.prototype,"snappingOptions",null),i.__decorate([g.property()],N.prototype,"_snappingManager",void 0),i.__decorate([g.property({readOnly:!0})],N.prototype,"state",null),i.__decorate([g.property({readOnly:!0})],N.prototype,"updateGraphics",void 0),i.__decorate([g.property()],N.prototype,"updateOnGraphicClick",void 0),i.__decorate([g.property({types:a.symbolTypes})],N.prototype,"updatePointSymbol",void 0),i.__decorate([g.property({types:a.symbolTypes})],N.prototype,"updatePolygonSymbol",void 0),i.__decorate([g.property({types:a.symbolTypes})],N.prototype,"updatePolylineSymbol",void 0),i.__decorate([g.property({types:a.symbolTypes})],N.prototype,"vertexSymbol",void 0),i.__decorate([g.property({value:null})],N.prototype,"view",null),i.__decorate([g.property()],N.prototype,"cancel",null),i.__decorate([g.property()],N.prototype,"complete",null),i.__decorate([g.property()],N.prototype,"delete",null),i.__decorate([g.property()],N.prototype,"create",null),i.__decorate([g.property()],N.prototype,"update",null),i.__decorate([g.property()],N.prototype,"undo",null),i.__decorate([g.property()],N.prototype,"redo",null),i.__decorate([g.property()],N.prototype,"canUndo",null),i.__decorate([g.property()],N.prototype,"canRedo",null),i.__decorate([g.property()],N.prototype,"toggleUpdateTool",null),N=i.__decorate([_.subclass(W)],N),N}));
