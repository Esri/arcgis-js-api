/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["require","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../symbols","../../core/Collection","../../core/has","../../core/Error","../../core/Evented","../../core/Handles","../../core/Logger","../../core/maybe","../../core/promiseUtils","../../core/reactiveUtils","../../core/watchUtils","../../core/accessorSupport/decorators/property","../../core/arrayUtils","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass","../../geometry/projectionEllipsoid","../../geometry/support/coordsUtils","../../layers/GraphicsLayer","../../views/DOMContainer","../../views/3d/interactive/editingTools/isSupportedGraphicUtils","../../views/3d/interactive/editingTools/moveGraphic/isSupportedGraphic","../../views/3d/interactive/editingTools/reshapeGraphic/isSupportedGraphic","../../views/3d/interactive/editingTools/transformGraphic/isSupportedGraphic","../../views/draw/support/layerUtils","../../views/input/InputManager","../../views/interactive/keybindings","../../views/interactive/snapping/SnappingManager","../../views/interactive/snapping/SnappingOptions","../../views/support/screenUtils","./support/OperationHandle","../../symbols/SimpleMarkerSymbol","../../symbols/SimpleFillSymbol","../../symbols/SimpleLineSymbol"],(function(e,t,o,i,r,a,n,s,p,l,c,d,h,u,y,v,g,m,_,f,w,T,G,E,b,S,O,C,A,H,k,P,M,I,R,U){"use strict";const K=e=>Object.freeze({__proto__:null,default:e}),D="esri.widgets.Sketch.SketchViewModel",x=l.getLogger(D),V={defaultZ:0},L={reshapeOptions:{edgeOperation:"split",shapeOperation:"move",vertexOperation:"move"},enableMoveAllGraphics:!0,enableRotation:!0,enableScaling:!0,multipleSelectionEnabled:!0,preserveAspectRatio:!1,toggleToolOnClick:!0,enableZ:!0,tool:"transform"};let F=function(o){function i(e){var t;return(t=o.call(this,e)||this)._numUpdating=0,t._handles=new p,t._internalGraphicsLayer=new w({listMode:"hide",internal:!0,title:"SVM Internal"}),t._operationHandle=null,t._viewHandles=new p,t.activeFillSymbol=null,t.activeLineSymbol=null,t.activeVertexSymbol=null,t.allowDeleteKey=!0,t.layer=null,t.pointSymbol=new I({style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}}),t.polygonSymbol=new R({color:[150,150,150,.2],outline:{color:[50,50,50],width:2}}),t.polylineSymbol=new U({color:[130,130,130,1],width:2}),t._snappingManager=null,t.updateGraphics=new r,t.updateOnGraphicClick=!0,t.updatePointSymbol=new I({size:10,color:[0,200,255,.5],outline:{color:"black",width:1}}),t.updatePolygonSymbol=new R({color:[12,207,255,.2],outline:{join:"round",color:[12,207,255],width:2}}),t.updatePolylineSymbol=new U({color:[12,207,255],width:2}),t.vertexSymbol=new I({style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}}),t._moduleLoaderAbortController=null,t._viewReadyAbortController=null,t._originalAutoOpenEnabled=null,t.defaultCreateOptions=V,t.defaultUpdateOptions=L,t.snappingOptions=new k,t}t._inheritsLoose(i,o);var a=i.prototype;return a.initialize=function(){this._handles.add([u.watch(this,"layer",(()=>{this.cancel(),this._internalGraphicsLayer.elevationInfo=c.isSome(this.layer)?this.layer.elevationInfo:null})),u.on(this,"view.map.layers","change",(e=>{e.removed.includes(this.layer)&&this.cancel()})),u.on(this,"layer.graphics","change",(e=>{if(c.isSome(this._operationHandle))for(const t of e.removed)this.updateGraphics.includes(t)&&(this.updateGraphics.length>1?this._operationHandle.removeFromSelection(t):this._operationHandle.cancel())})),u.init(this,"layer.elevationInfo",(()=>{this.cancel(),this._internalGraphicsLayer.elevationInfo=c.isSome(this.layer)?this.layer.elevationInfo:null}),!0),u.init(this,"view",(t=>{c.destroyMaybe(this._snappingManager),t&&(this._snappingManager=new H.SnappingManager({view:t,options:this.snappingOptions}),"2d"===t.type?new Promise(((t,o)=>e(["../../views/2d/interactive/editingTools"],t,o))):"3d"===t.type&&(new Promise(((t,o)=>e(["../../views/3d/interactive/editingTools"],t,o))),new Promise(((t,o)=>e(["../../views/3d/layers/GraphicsLayerView3D"],(e=>t(K(e))),o)))))}),!0)])},a.destroy=function(){this.cancel(),this._handles=c.destroyMaybe(this._handles),this._viewHandles=c.destroyMaybe(this._viewHandles),this._removeDefaultLayer(),this._snappingManager=c.destroyMaybe(this._snappingManager),this._set("view",null),this.emit("destroy")},a.cancel=function(){this._moduleLoaderAbortController=c.abortMaybe(this._moduleLoaderAbortController),this._viewReadyAbortController=c.abortMaybe(this._viewReadyAbortController),this._operationHandle&&this._operationHandle.cancel()},a.complete=function(){this._operationHandle&&this._operationHandle.complete()},a.delete=function(){const{state:e,updateGraphics:t}=this;if("active"===e&&t.length){const{activeTool:e,layer:o}=this,i=t.toArray();o.removeMany(i),this.cancel(),this._emitDeleteEvent({graphics:i,tool:e})}},a.create=function(){var e=t._asyncToGenerator((function*(e,t){if(this.cancel(),yield this._waitViewReady(),"disabled"===this.state)throw this.layer||this._logError("sketch:missing-property","Property 'layer' is missing on SketchViewModel."),this.view||this._logError("sketch:missing-property","Property 'view' is missing on SketchViewModel."),d.createAbortError();if(c.isSome(this.view.activeTool)&&(this.view.activeTool=null),!e)return void this._logError("sketch:missing-parameter","Missing parameter 'tool'.");O.addUniqueLayer(this.view,this._internalGraphicsLayer);const o=yield this._setupCreateOperation(e,t);if(c.isNone(o)||this.destroyed)return void this.view.map.remove(this._internalGraphicsLayer);const i=()=>{if(o===this._operationHandle){const t=this.createGraphic,i=this._operationHandle.cancelled;this._operationHandle.destroy(),this._operationHandle=null,this._set("createGraphic",null),this.view&&this.view.map&&this.view.map.remove(this._internalGraphicsLayer),o.cancelled||null==t||this.layer.add(t),this.emit("create",{graphic:t,state:i?"cancel":"complete",tool:e,toolEventInfo:null,type:"create"})}};o.on("complete",i),this._operationHandle=o,this.view.ready&&T.isDOMContainer(this.view)&&this.view.focus()}));function o(t,o){return e.apply(this,arguments)}return o}(),a.update=function(){var e=t._asyncToGenerator((function*(e,t){this.cancel(),yield this._waitViewReady();const{layer:o,view:i,state:r}=this;if("disabled"===r)throw i||this._logError("sketch:missing-property","Property 'view' is missing on SketchViewModel."),o||this._logError("sketch:missing-property","Property 'layer' is missing on SketchViewModel."),d.createAbortError();c.isSome(this.view.activeTool)&&(this.view.activeTool=null);const a=Array.isArray(e)?e:[e];if(null==e||!a||!a.length)return void this._logError("sketch:missing-parameter","Missing parameter 'graphics'.");if(a.some((e=>e.layer!==o?(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics missing from the supplied GraphicsLayer."),!0):c.isNone(e.geometry)?(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics with an unsupported geometry."),!0):"2d"===i.type&&!i.spatialReference.equals(e.geometry.spatialReference)&&(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics with a spatial reference different from the supplied MapView."),!0))))return;const n=yield this._setupUpdateOperation(a,t);this.destroyed||c.isNone(n)||z(n)||(O.addUniqueLayer(this.view,this._internalGraphicsLayer),this._setUpdateOperationHandle(n,t),this.emit("update",{graphics:a,state:"start",aborted:!1,tool:n.tool,toolEventInfo:null,type:"update"}))}));function o(t,o){return e.apply(this,arguments)}return o}(),a.undo=function(){this.canUndo()&&this._operationHandle.undo()},a.redo=function(){this.canRedo()&&this._operationHandle.redo()},a.canUndo=function(){return!(!this._operationHandle||!this._operationHandle.canUndo())},a.canRedo=function(){return!(!this._operationHandle||!this._operationHandle.canRedo())},a.toggleUpdateTool=function(){this._operationHandle&&this._operationHandle.toggleTool&&this._operationHandle.toggleTool()},a._getFirstHit=function(){var e=t._asyncToGenerator((function*(e){const t=[];switch(this.view.type){case"2d":{const o=[];this.view.map.allLayers.forEach((e=>{"vector-tile"!==e.type&&"imagery"!==e.type||o.push(e)}));const i=yield this.view.hitTest(e,{exclude:o});if(i.results.length>0){const e=i.results[0];e.graphic&&t.push(e)}}break;case"3d":{const o=[this.view.map.ground];this.view.map.allLayers.forEach((e=>{"integrated-mesh"===e.type&&o.push(e)}));const i=yield this.view.hitTest(e,{exclude:o});if(i.results.length>0){const e=i.results[0];(!i.ground.mapPoint||this.view.map.ground.opacity<1||i.ground.distance-c.unwrapOr(e.distance,0)>-Math.min(3*i.ground.distance,"global"===this.view.viewingMode?_.getReferenceEllipsoid(this.view.renderCoordsHelper.spatialReference).radius/this.view.renderCoordsHelper.unitInMeters:Number.POSITIVE_INFINITY))&&t.push(e)}}}return{screenPoint:e,results:t}}));function o(t){return e.apply(this,arguments)}return o}(),a._generateViewHandles=function(e){var o=this;return[e.on("immediate-click",function(){var i=t._asyncToGenerator((function*(t){const i="active"===o.state&&"create"===o._operationHandle.type;if("disabled"===o.state||i||!o.updateOnGraphicClick)return;o._beginAsyncOperation();const r=(yield t.async((()=>o._getFirstHit(P.createScreenPointFromEvent(t))))).results;let a=null;if(r.length){for(const n of r)if(n.graphic){const i=n.graphic;if(o.updateGraphics.includes(i)||i.layer===o.layer){t.stopPropagation(),a=i;break}"2d"!==e.type||o._isComponentGraphic(i)||"active"!==o.state||o.cancel()}}else"active"===o.state&&o.cancel();c.isSome(a)&&!o.updateGraphics.includes(a)&&(yield o.update([a],{...o.defaultUpdateOptions,reshapeOptions:{...o.defaultUpdateOptions.reshapeOptions}})),o._endAsyncOperation()}));return function(e){return i.apply(this,arguments)}}(),C.ViewEventPriorities.WIDGET)]},a._setupCreateOperation=function(){var e=t._asyncToGenerator((function*(e,t){const o={hasZ:"3d"===this.view.type,...this.defaultCreateOptions,...t},i=yield this._setupDrawGraphicTool(e,this.view,o);return c.isNone(i)?null:(this.view.tools.add(i),this.view.activeTool=i,this._setupCreateOperationHandle(i))}));function o(t,o){return e.apply(this,arguments)}return o}(),a._setupDrawGraphicTool=function(){var e=t._asyncToGenerator((function*(e,t,o){if("multipoint"===e&&"3d"===t.type)return this._logError("sketch:create","Multipoint geometries are not supported in SceneView"),null;const i="rectangle"!==e,r="rectangle"!==e;this.snappingOptions.enabledToggled=!1;const a={view:t,mode:"rectangle"===e||"circle"===e?"hybrid":"click",...o,snapToScene:!1,geometryType:e,graphicSymbol:this._getGraphicSymbolFromTool(e),snappingManager:this._snappingManager,forceUniformSize:r,centered:i};return"2d"===this.view.type?this._makeDrawGraphicTool2D(a):this._makeDrawGraphicTool3D(a)}));function o(t,o,i){return e.apply(this,arguments)}return o}(),a._makeDrawGraphicTool2D=function(){var o=t._asyncToGenerator((function*(t){const o=yield this._requireModule(new Promise(((t,o)=>e(["../../views/2d/interactive/editingTools"],t,o))));return z(o)||this.destroyed?null:new o.module.DrawGraphicTool2D({...t,activeVertexSymbol:this.activeVertexSymbol,regularVerticesSymbol:this.vertexSymbol,activeLineSymbol:this.activeLineSymbol,activeFillSymbol:Y(t.geometryType)?this.activeFillSymbol:null})}));function i(e){return o.apply(this,arguments)}return i}(),a._makeDrawGraphicTool3D=function(){var o=t._asyncToGenerator((function*(t){const o=yield this._requireModule(new Promise(((t,o)=>e(["../../views/3d/interactive/editingTools"],t,o))));return z(o)||this.destroyed?null:new o.module.DrawGraphicTool3D({...t,elevationInfo:this.layer.elevationInfo,snapToScene:!c.isSome(this.layer.elevationInfo)||"absolute-height"===this.layer.elevationInfo.mode})}));function i(e){return o.apply(this,arguments)}return i}(),a._setupCreateOperationHandle=function(e){let t=null;const o=e.forceUniformSize,i=e.centered,r=[this.view.on("key-down",(t=>{if(t.key===A.SKETCH_KEYS.pan)t.stopPropagation(),t.repeat||(e.enabled=!1);else if(t.key===A.SKETCH_KEYS.complete)t.stopPropagation(),e.completeCreateOperation();else if(t.key!==A.SKETCH_KEYS.vertexAdd||t.repeat)t.key===A.SKETCH_KEYS.undo?(t.stopPropagation(),a.undo()):t.key===A.SKETCH_KEYS.redo?(t.stopPropagation(),a.redo()):t.key!==A.SKETCH_KEYS.snappingToggle||"rectangle"===e.geometryType||"circle"===e.geometryType||t.repeat?t.key!==A.SKETCH_KEYS.constraint||"rectangle"!==e.geometryType&&"circle"!==e.geometryType||t.repeat?t.key===A.SKETCH_KEYS.center&&(t.repeat||(e.centered=!i,t.stopPropagation())):(e.forceUniformSize=!o,t.stopPropagation()):(this.snappingOptions.enabledToggled=!0,t.stopPropagation());else{const o=e.drawOperation.geometryType;"polyline"!==o&&"polygon"!==o&&"multipoint"!==o||(t.stopPropagation(),e.drawOperation.commitStagedVertex())}}),C.ViewEventPriorities.WIDGET),this.view.on("key-up",(t=>{t.key===A.SKETCH_KEYS.pan?e.enabled=!0:t.key===A.SKETCH_KEYS.snappingToggle&&"rectangle"!==e.geometryType&&"circle"!==e.geometryType?(this.snappingOptions.enabledToggled=!1,t.stopPropagation()):t.key!==A.SKETCH_KEYS.constraint||"rectangle"!==e.geometryType&&"circle"!==e.geometryType?t.key===A.SKETCH_KEYS.center&&(e.centered=i,t.stopPropagation()):(e.forceUniformSize=o,t.stopPropagation())}),C.ViewEventPriorities.WIDGET),e.on("vertex-add",(o=>{switch(t=c.isNone(t)?"start":"active",o.operation){case"apply":this.emit("create",{graphic:c.unwrap(e.graphic),state:t,tool:this.activeTool,toolEventInfo:o,type:"create"});break;case"undo":this._emitUndoEvent({graphics:[c.unwrap(e.graphic)],tool:e.geometryType});break;case"redo":this._emitRedoEvent({graphics:[c.unwrap(e.graphic)],tool:e.geometryType})}})),e.on("cursor-update",(t=>{e.drawOperation.numCommittedVertices>0&&this.emit("create",{graphic:c.unwrap(e.graphic),state:"active",tool:this.activeTool,toolEventInfo:{coordinates:t.vertices[0].coordinates,type:"cursor-update"},type:"create"})})),e.on("vertex-remove",(t=>{switch(t.operation){case"apply":this.emit("create",{graphic:c.unwrap(e.graphic),state:"active",tool:this.activeTool,toolEventInfo:t,type:"create"});break;case"undo":this._emitUndoEvent({graphics:[c.unwrap(e.graphic)],tool:e.geometryType});break;case"redo":this._emitRedoEvent({graphics:[c.unwrap(e.graphic)],tool:e.geometryType})}})),e.on("complete",(e=>{this._set("createGraphic",c.unwrap(e.graphic)),t="complete",e.aborted?a&&a.cancel():a&&a.complete()})),h.react((()=>this._getGraphicSymbolFromTool(e.geometryType)),(t=>{e.graphicSymbol=t}))],a=new M.OperationHandle({activeComponent:e,tool:e.geometryType,type:"create",onEnd:()=>{var t;r.forEach((e=>e.remove())),r.length=0,null==(t=this.view.tools)||t.remove(e),e.destroy()},undo:()=>{e.canUndo&&e.undo()},redo:()=>{e.canRedo&&e.redo()},canUndo:()=>e.canUndo,canRedo:()=>e.canRedo});return a},a._getGraphicSymbolFromTool=function(e){switch(e){case"point":case"multipoint":return this.pointSymbol;case"polyline":return this.polylineSymbol;case"circle":case"rectangle":case"polygon":return this.polygonSymbol;default:return null}},a._setupUpdateOperation=function(){var e=t._asyncToGenerator((function*(e,t){const{layer:o,view:i}=this,r={tool:this._defaultUpdateTool,...this.defaultUpdateOptions,...t,reshapeOptions:{...this.defaultUpdateOptions.reshapeOptions,...null==t?void 0:t.reshapeOptions}};let a=r.tool;for(const n of e)o.remove(n),o.add(n);if("3d"===i.type){if(0===e.length)return null;switch(a){case"move":return this._setupMove3DOperation(e,r,i,a);case"reshape":{if(e.length>1)return this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),null;const t=b.isSupportedGraphic(e[0]);return 0===t?this._setupReshape3DOperation(e[0],r,i):(this._logError("sketch:reshape",`Reshape operation not supported for provided graphic(s) (${G.isSupportedGraphicResultMessage(t)}).`),null)}case"transform":return this._setupGraphicTransform3DOperation(e,r,i)}}switch(a){case"move":return this._setupMoveOperation(e,r,i);case"reshape":{if(e.length>1)return this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),null;const t=b.isSupportedGraphic(e[0]);return 0===t?this._setupTransformOrReshapeOperation(e,a,r,i):(this._logError("sketch:reshape",`Reshape operation not supported for provided graphic(s) (${G.isSupportedGraphicResultMessage(t)}).`),null)}case"transform":if(1===e.length){const t=c.get(e[0].geometry,"type");"point"!==t&&"multipoint"!==t||(a="reshape")}return this._setupTransformOrReshapeOperation(e,a,r,i)}}));function o(t,o){return e.apply(this,arguments)}return o}(),a._setupMove3DOperation=function(){var o=t._asyncToGenerator((function*(o,i,r,a,n=!1){var s=this;for(const e of o){const t=E.isSupportedGraphic(e);if(0!==t)return this._logError("sketch:move",`Move operation not supported for provided graphic(s) (${G.isSupportedGraphicResultMessage(t)}).`),null}const p=yield this._requireModule(new Promise(((t,o)=>e(["../../views/3d/interactive/editingTools"],t,o))));if(z(p))return p;const l=new p.module.GraphicMoveTool({view:r,enableZ:i.enableZ,snappingManager:this._snappingManager});this.view.tools.add(l),l.graphics.addMany(o),n||this.updateGraphics.addMany(o);const c=[],d=new M.UpdateOperationHandle({activeComponent:l,tool:a,type:"update",onEnd:()=>{var e;c.forEach((e=>e.remove())),c.length=0,null==(e=this.view.tools)||e.remove(l),l.destroyed||l.destroy()},undo:()=>{W(d,this.updateGraphics.toArray()),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:a})},redo:()=>{q(d,this.updateGraphics.toArray()),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:a})},addToSelection:e=>{this.updateGraphics.push(e),l.graphics.push(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:e=>{const t=this.updateGraphics.indexOf(e);d.history.undo.forEach((e=>e.updates.splice(t,1))),d.history.redo.forEach((e=>e.updates.splice(t,1))),this.updateGraphics.remove(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),0!==this.updateGraphics.length?l.graphics.remove(e):d.complete()},toggleTool:(h=t._asyncToGenerator((function*(){if(1!==s.updateGraphics.length||!1===i.toggleToolOnClick)return;if("transform"!==a)return;const e=s.updateGraphics.getItemAt(0);if(0!==b.isSupportedGraphic(e))return;const t=yield s._setupReshape3DOperation(e,i,r,!0);z(t)||(d.onEnd(),d.destroy(),s._setUpdateOperationHandle(t,i))})),function(){return h.apply(this,arguments)})});var h;return c.push(...this._getHandlesForComponent(d,i),this.view.on("immediate-click",(e=>this._getCommonUpdateOperationClickHandlers(d,e,i)),C.ViewEventPriorities.WIDGET),r.on("key-down",(e=>{this._getCommonUpdateOperationKeyDownHandlers(d,e),e.key===A.SKETCH_KEYS.snappingToggle&&(this.snappingOptions.enabledToggled=!0,e.stopPropagation())}),C.ViewEventPriorities.WIDGET),r.on("key-up",(e=>{e.key===A.SKETCH_KEYS.snappingToggle&&(this.snappingOptions.enabledToggled=!1,e.stopPropagation())}),C.ViewEventPriorities.WIDGET)),d}));function i(e,t,i,r){return o.apply(this,arguments)}return i}(),a._setupGraphicTransform3DOperation=function(e,t,o,i=!1){if(1===e.length&&0===S.isSupportedGraphic(e[0])){const r=e[0],a=r.geometry;if(c.isSome(a)&&("point"===a.type||"mesh"===a.type))return this._setupPointTransform3DOperation(r,t,o);if(c.isSome(a)&&("polygon"===a.type||"polyline"===a.type))return this._setupPolyTransform3DOperation(r,t,o,i)}return this._setupMove3DOperation(e,t,o,"transform",i)},a._setupPointTransform3DOperation=function(){var o=t._asyncToGenerator((function*(o,i,r){var a=this;const n="transform",{enableRotation:s,enableScaling:p,enableZ:l}=i,c=yield this._requireModule(new Promise(((t,o)=>e(["../../views/3d/interactive/editingTools"],t,o))));if(z(c))return c;const d=new c.module.GraphicTransformTool({graphic:o,view:r,enableRotation:s,enableScaling:p,enableZ:l,snappingManager:this._snappingManager});this.view.tools.add(d),this.updateGraphics.add(o);const h=[],u=new M.UpdateOperationHandle({activeComponent:d,tool:n,type:"update",onEnd:()=>{var e;h.forEach((e=>e.remove())),h.length=0,null==(e=this.view.tools)||e.remove(d),d.destroyed||d.destroy()},undo:()=>{W(u,this.updateGraphics.toArray()),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:n})},redo:()=>{q(u,this.updateGraphics.toArray()),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:n})},addToSelection:(y=t._asyncToGenerator((function*(e){a.updateGraphics.add(e),a.emit("update",{graphics:a.updateGraphics.toArray(),state:"active",aborted:!1,tool:a.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"});const t=yield a._setupMove3DOperation(a.updateGraphics.toArray(),i,r,"transform",!0);z(t)||(u.onEnd(),u.destroy(),a._setUpdateOperationHandle(t,i))})),function(e){return y.apply(this,arguments)}),removeFromSelection:e=>{this.updateGraphics.remove(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),u.complete()},toggleTool:()=>{}});var y;return h.push(...this._getHandlesForComponent(u,i),this.view.on("immediate-click",(e=>this._getCommonUpdateOperationClickHandlers(u,e,i)),C.ViewEventPriorities.WIDGET),r.on("key-down",(e=>{this._getCommonUpdateOperationKeyDownHandlers(u,e),e.key===A.SKETCH_KEYS.snappingToggle&&(this.snappingOptions.enabledToggled=!0,e.stopPropagation())}),C.ViewEventPriorities.WIDGET),r.on("key-up",(e=>{e.key===A.SKETCH_KEYS.snappingToggle&&(this.snappingOptions.enabledToggled=!1,e.stopPropagation())}),C.ViewEventPriorities.WIDGET)),u}));function i(e,t,i){return o.apply(this,arguments)}return i}(),a._setupPolyTransform3DOperation=function(){var o=t._asyncToGenerator((function*(o,i,r,a=!1){var n=this;const s="transform",{enableRotation:p,enableScaling:l,enableZ:c,preserveAspectRatio:d}=i,h=yield this._requireModule(new Promise(((t,o)=>e(["../../views/3d/interactive/editingTools"],t,o))));if(z(h))return h;const u=new h.module.ExtentTransformTool({graphic:o,view:r,enableRotation:p,enableScaling:l,enableZ:c,preserveAspectRatio:d});this.view.tools.add(u),a||this.updateGraphics.add(o);const y=[],v=new M.UpdateOperationHandle({activeComponent:u,tool:s,type:"update",onEnd:()=>{var e;y.forEach((e=>e.remove())),y.length=0,null==(e=this.view.tools)||e.remove(u),u.destroyed||u.destroy()},canUndo:()=>u.canUndo,undo:()=>{u.undo(),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:s})},canRedo:()=>u.canRedo,redo:()=>{u.redo(),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:s})},addToSelection:(m=t._asyncToGenerator((function*(e){n.updateGraphics.add(e),n.emit("update",{graphics:n.updateGraphics.toArray(),state:"active",aborted:!1,tool:n.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"});const t=yield n._setupMove3DOperation(n.updateGraphics.toArray(),i,r,"transform",!0);z(t)||(v.onEnd(),v.destroy(),n._setUpdateOperationHandle(t,i))})),function(e){return m.apply(this,arguments)}),removeFromSelection:e=>{this.updateGraphics.remove(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),v.complete()},toggleTool:(g=t._asyncToGenerator((function*(){if(1!==n.updateGraphics.length||!1===i.toggleToolOnClick)return;const e=n.updateGraphics.getItemAt(0);if(0!==b.isSupportedGraphic(e))return;const t=yield n._setupReshape3DOperation(e,i,r,!0);z(t)||(v.onEnd(),v.destroy(),n._setUpdateOperationHandle(t,i))})),function(){return g.apply(this,arguments)})});var g,m;return y.push(...this._getHandlesForComponent(v,i),this.view.on("immediate-click",(e=>this._getCommonUpdateOperationClickHandlers(v,e,i)),C.ViewEventPriorities.WIDGET),this.view.on("key-down",(e=>this._getCommonUpdateOperationKeyDownHandlers(v,e)),C.ViewEventPriorities.WIDGET),this.view.on("key-down",(e=>{e.key!==A.SKETCH_KEYS.constraint||e.repeat||(u.preserveAspectRatio=!u.preserveAspectRatio,e.stopPropagation())}),C.ViewEventPriorities.WIDGET),this.view.on("key-up",(e=>{e.key===A.SKETCH_KEYS.constraint&&(u.preserveAspectRatio=!u.preserveAspectRatio,e.stopPropagation())}),C.ViewEventPriorities.WIDGET)),v}));function i(e,t,i){return o.apply(this,arguments)}return i}(),a._setupMoveOperation=function(){var e=t._asyncToGenerator((function*(e,t,o){const i="move";this.updateGraphics.addMany(e);const r=yield this._getGraphicMover(e,t,o);if(z(r))return r;const a=new M.UpdateOperationHandle({activeComponent:r,tool:i,type:"update",onEnd:()=>{var e;this._displayDefaultCursor(),p.forEach((e=>e.remove())),s.forEach((e=>e.remove())),p=[],s=[],r.destroy(),null==(e=this._internalGraphicsLayer)||e.removeMany([...this.updateGraphics.toArray()])},undo:()=>{const e=this.updateGraphics.toArray();W(a,e),a.refreshComponent(),this._emitUndoEvent({graphics:e,tool:i})},redo:()=>{const e=this.updateGraphics.toArray();q(a,e),a.refreshComponent(),this._emitRedoEvent({graphics:e,tool:i})},addToSelection:e=>{this.updateGraphics.push(e),r.graphics=this.updateGraphics.toArray(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:e=>{const t=this.updateGraphics.indexOf(e);a.history.undo.forEach((e=>e.updates.splice(t,1))),a.history.redo.forEach((e=>e.updates.splice(t,1))),this.updateGraphics.remove(e);const o=this.updateGraphics.toArray();this.emit("update",{graphics:o,state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),0!==this.updateGraphics.length?r.graphics=o:a.complete()}});let n=!1,s=[o.on("immediate-click",(e=>this._getCommonUpdateOperationClickHandlers(a,e,t)),C.ViewEventPriorities.WIDGET),o.on("key-down",(e=>{this._getCommonUpdateOperationKeyDownHandlers(a,e),e.key!==A.SKETCH_KEYS.constraint||e.repeat||(n=!0,r.enableMoveAllGraphics=!r.enableMoveAllGraphics)}),C.ViewEventPriorities.WIDGET),o.on("key-up",(e=>{e.key===A.SKETCH_KEYS.constraint&&n&&(n=!1,r.enableMoveAllGraphics=!r.enableMoveAllGraphics)}),C.ViewEventPriorities.WIDGET)],p=this._getHandlesForComponent(a,t);return a}));function o(t,o,i){return e.apply(this,arguments)}return o}(),a._setupReshape3DOperation=function(){var o=t._asyncToGenerator((function*(o,i,r,a=!1){var n=this;const s="reshape",p=yield this._requireModule(new Promise(((t,o)=>e(["../../views/3d/interactive/editingTools"],t,o))));if(z(p))return p;this.snappingOptions.enabledToggled=!1;const l=new p.module.GraphicReshapeTool({view:r,graphic:o,enableZVertex:i.enableZ&&"move"===i.reshapeOptions.vertexOperation,enableZShape:i.enableZ&&"move"===i.reshapeOptions.shapeOperation,enableMoveGraphic:"move"===i.reshapeOptions.shapeOperation||"move-xy"===i.reshapeOptions.shapeOperation,enableMidpoints:"split"===i.reshapeOptions.edgeOperation,enableEdgeOffset:"offset"===i.reshapeOptions.edgeOperation,snappingManager:this._snappingManager});r.tools.add(l),a||this.updateGraphics.add(o);const c=[],d=new M.UpdateOperationHandle({activeComponent:l,tool:s,type:"update",onEnd:()=>{var e;c.forEach((e=>e.remove())),c.length=0,null==(e=this.view.tools)||e.remove(l),l.destroyed||l.destroy()},canUndo:()=>l.canUndo,undo:()=>{l.undo(),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:s})},canRedo:()=>l.canRedo,redo:()=>{l.redo(),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:s})},addToSelection:(u=t._asyncToGenerator((function*(e){n.updateGraphics.add(e),n.emit("update",{graphics:n.updateGraphics.toArray(),state:"active",aborted:!1,tool:n.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"});const t=yield n._setupMove3DOperation(n.updateGraphics.toArray(),i,r,"transform",!0);z(t)||(d.onEnd(),d.destroy(),n._setUpdateOperationHandle(t,i))})),function(e){return u.apply(this,arguments)}),removeFromSelection:e=>{this.updateGraphics.remove(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),d.complete()},toggleTool:(h=t._asyncToGenerator((function*(){if(!1===i.toggleToolOnClick)return;const e=yield n._setupGraphicTransform3DOperation(n.updateGraphics.toArray(),i,r,!0);z(e)||(d.onEnd(),d.destroy(),n._setUpdateOperationHandle(e,i))})),function(){return h.apply(this,arguments)})});var h,u;return c.push(...this._getHandlesForComponent(d,i),r.on("immediate-click",(e=>this._getCommonUpdateOperationClickHandlers(d,e,i)),C.ViewEventPriorities.WIDGET),r.on("key-down",(e=>{this._getCommonUpdateOperationKeyDownHandlers(d,e),e.key===A.SKETCH_KEYS.snappingToggle&&(this.snappingOptions.enabledToggled=!0,e.stopPropagation())}),C.ViewEventPriorities.WIDGET),r.on("key-up",(e=>{e.key===A.SKETCH_KEYS.snappingToggle&&(this.snappingOptions.enabledToggled=!1,e.stopPropagation())}),C.ViewEventPriorities.WIDGET)),d}));function i(e,t,i){return o.apply(this,arguments)}return i}(),a._setupTransformOrReshapeOperation=function(){var e=t._asyncToGenerator((function*(e,o,i,r){var a=this;const{multipleSelectionEnabled:n}=i;this.updateGraphics.addMany(e);const s="transform"===o?yield this._getBox(e,i,r):yield this._getReshape(e,i,r);if(z(s))return s;const p=new M.UpdateOperationHandle({activeComponent:s,type:"update",onEnd:()=>{y.forEach((e=>e.remove())),u.forEach((e=>e.remove())),y=[],u=[],p.activeComponent&&!p.activeComponent.destroyed&&p.activeComponent.destroy(),this._internalGraphicsLayer.removeMany(this.updateGraphics.toArray())},undo:()=>{W(p,this.updateGraphics.toArray()),p.refreshComponent(),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:p.tool})},redo:()=>{q(p,this.updateGraphics.toArray()),p.refreshComponent(),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:p.tool})},addToSelection:(h=t._asyncToGenerator((function*(e){let t=p.activeComponent;if("reshape"===t.type){const t=[...a.updateGraphics,e];a.updateGraphics.removeAll();const o=yield a._setupMoveOperation(t,i,r);if(z(o))return;p.onEnd(),p.destroy(),a._setUpdateOperationHandle(o,i)}else a.updateGraphics.add(e),t=t,t.graphics=a.updateGraphics.toArray(),t.refresh(),p.resetHistory();a.emit("update",{graphics:a.updateGraphics.toArray(),state:"active",aborted:!1,tool:a.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"})})),function(e){return h.apply(this,arguments)}),removeFromSelection:(d=t._asyncToGenerator((function*(e){const t=a.updateGraphics.indexOf(e);p.history.undo.forEach((e=>e.updates.splice(t,1))),p.history.redo.forEach((e=>e.updates.splice(t,1))),a.updateGraphics.remove(e);const o=a.updateGraphics.toArray();if(0===o.length)p.complete();else{const e=o[0].geometry;1!==o.length||!c.isSome(e)||"point"!==e.type&&"multipoint"!==e.type?p.activeComponent.graphics=o:p.toggleTool()}a.emit("update",{graphics:o,state:"active",aborted:!1,tool:a.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"})})),function(e){return d.apply(this,arguments)}),toggleTool:(l=t._asyncToGenerator((function*(){if(a.updateGraphics.length>1)return;const e=a.updateGraphics.getItemAt(0),t=e.geometry;if(c.isSome(t)&&("reshape"===p.tool&&("point"===t.type||"multipoint"===t.type)||"transform"===p.tool&&"extent"===t.type))return;let o=null;"transform"===p.tool?o=yield a._getReshape([e],i,r):"reshape"===p.tool&&(o=yield a._getBox([e],i,r)),z(o)||(p.activeComponent.destroy(),p.activeComponent=o,p.activeComponent&&(y.forEach((e=>e.remove())),y=a._getHandlesForComponent(p,i)))})),function(){return l.apply(this,arguments)})});var l,d,h;let u=[r.on("immediate-click",function(){var e=t._asyncToGenerator((function*(e){var t;const o=yield e.async((()=>a._getFirstHit(P.createScreenPointFromEvent(e))));null!=(t=o.results)&&t.length?o.results.some((t=>{if(t.graphic){var o;const i=t.graphic;if(null!=(o=e.native)&&o.shiftKey&&n)return e.stopPropagation(),p.addToSelection(i),!0;if(i.layer===a.layer)return p.complete(),!0}return!1})):p.complete()}));return function(t){return e.apply(this,arguments)}}(),C.ViewEventPriorities.WIDGET),r.on("key-down",(e=>{if(this._getCommonUpdateOperationKeyDownHandlers(p,e),e.key!==A.SKETCH_KEYS.snappingToggle||e.repeat||(this.snappingOptions.enabledToggled=!0,e.stopPropagation()),e.key===A.SKETCH_KEYS.constraint&&!e.repeat&&p){const e=p.activeComponent;e&&"box"===e.type&&(e.preserveAspectRatio=!e.preserveAspectRatio)}}),C.ViewEventPriorities.WIDGET),r.on("key-up",(e=>{var t;if(e.key===A.SKETCH_KEYS.snappingToggle&&"reshape"===(null==p||null==(t=p.activeComponent)?void 0:t.type)&&(this.snappingOptions.enabledToggled=!1,e.stopPropagation()),e.key===A.SKETCH_KEYS.constraint&&p){const e=p.activeComponent;e&&"box"===e.type&&(e.preserveAspectRatio=!e.preserveAspectRatio)}}),C.ViewEventPriorities.WIDGET)],y=this._getHandlesForComponent(p,i);return p}));function o(t,o,i,r){return e.apply(this,arguments)}return o}(),a._getGraphicMover=function(){var o=t._asyncToGenerator((function*(t,o,i){const{enableMoveAllGraphics:r}=o,a=yield this._requireModule(new Promise(((t,o)=>e(["../../views/draw/support/GraphicMover"],(e=>t(K(e))),o))));return z(a)?a:new a.module.default({enableMoveAllGraphics:r,graphics:t,view:i,callbacks:{onGraphicMoveStart:({dx:e,dy:t,graphic:o})=>{this._displayGrabbingCursor(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:o,type:"move-start"},type:"update"})},onGraphicMove:({dx:e,dy:t,graphic:o})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:o,type:"move"},type:"update"}),onGraphicMoveStop:({dx:e,dy:t,graphic:o})=>{this._displayPointerCursor(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:o,type:"move-stop"},type:"update"})},onGraphicPointerOver:()=>this._displayPointerCursor(),onGraphicPointerOut:()=>this._displayDefaultCursor()}})}));function i(e,t,i){return o.apply(this,arguments)}return i}(),a._getBox=function(){var o=t._asyncToGenerator((function*(t,o,i){const{enableRotation:r,enableScaling:a,preserveAspectRatio:n}=o,s=yield this._requireModule(new Promise(((t,o)=>e(["../../views/draw/support/Box"],(e=>t(K(e))),o))));return z(s)?s:new s.module.default({graphics:t,enableRotation:r,enableScaling:a,preserveAspectRatio:n,layer:this._internalGraphicsLayer,view:i,callbacks:{onMoveStart:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onMove:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onMoveStop:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onScaleStart:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onScale:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onScaleStop:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onRotateStart:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onRotate:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onRotateStop:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"})}})}));function i(e,t,i){return o.apply(this,arguments)}return i}(),a._getReshape=function(){var o=t._asyncToGenerator((function*(t,o,i){var r,a;const n="split"===(null==(r=o.reshapeOptions)?void 0:r.edgeOperation),s="move"===(null==(a=o.reshapeOptions)?void 0:a.shapeOperation),p=yield this._requireModule(new Promise(((t,o)=>e(["../../views/draw/support/Reshape"],(e=>t(K(e))),o))));return z(p)?p:new p.module.default({enableMidpoints:n,enableMovement:s,graphic:t[0],layer:this._internalGraphicsLayer,snappingManager:this._snappingManager,view:i,callbacks:{onReshapeStart:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onReshape:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onReshapeStop:({mover:e,type:t})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e,type:t},type:"update"}),onMoveStart:({dx:e,dy:t,mover:o,type:i})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:o,type:i},type:"update"}),onMove:({dx:e,dy:t,mover:o,type:i})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:o,type:i},type:"update"}),onMoveStop:({dx:e,dy:t,mover:o,type:i})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:o,type:i},type:"update"}),onVertexAdd:({added:e,type:t,vertices:o})=>{const i=e.map((e=>f.geometryToCoordinates(e.geometry)));this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:i,vertices:o,type:t},type:"update"})},onVertexRemove:({removed:e,type:t,vertices:o})=>{const i=e.map((e=>f.geometryToCoordinates(e.geometry)));this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{removed:i,vertices:o,type:t},type:"update"})}}})}));function i(e,t,i){return o.apply(this,arguments)}return i}(),a._getHandlesForComponent=function(e,t){const o=e.activeComponent;switch(o.type){case"graphic-mover":return[o.on("graphic-click",(({graphic:t,viewEvent:o})=>{var i;null!=(i=o.native)&&i.shiftKey&&(o.stopPropagation(),e.removeFromSelection(t))})),o.on("graphic-move-start",(t=>e.addToHistory(Z(t.allGraphics))))];case"box":return[o.on("graphic-click",(o=>this._onTransformOrReshape2DGraphicClick(e,t,o))),o.on("move-start",(t=>e.addToHistory(Z(t.graphics)))),o.on("rotate-start",(t=>e.addToHistory(Z(t.graphics)))),o.on("scale-start",(t=>e.addToHistory(Z(t.graphics))))];case"reshape":return[o.on("graphic-click",(o=>this._onTransformOrReshape2DGraphicClick(e,t,o))),o.on("move-start",(t=>e.addToHistory(Z([t.mover])))),o.on("reshape-start",(t=>e.addToHistory(Z([t.graphic])))),o.on("vertex-add",(t=>e.addToHistory(Z([t.oldGraphic])))),o.on("vertex-remove",(t=>e.addToHistory(Z([t.oldGraphic]))))];case"move-3d":return[o.on("graphic-move-start",(t=>{e.addToHistory(Z(t.allGraphics)),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:0,dy:0,mover:t.allGraphics.length>0?t.allGraphics[0]:null,type:"move-start"},type:"update"})})),o.on("graphic-move",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e.dx,dy:e.dy,mover:e.allGraphics.length>0?e.allGraphics[0]:null,type:"move"},type:"update"})})),o.on("graphic-move-stop",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:0,dy:0,mover:e.allGraphics.length>0?e.allGraphics[0]:null,type:"move-stop"},type:"update"})})),o.on("immediate-click",(o=>{o.shiftKey?this._toggleSelection([o.graphic],e,t):e.toggleTool()}))];case"transform-3d":return[o.on("record-undo",(({record:t})=>{e.addToHistory({updates:[t]})})),o.on("graphic-translate-start",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,dx:e.dxScreen,dy:e.dyScreen,type:"move-start"},type:"update"})})),o.on("graphic-translate-stop",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,dx:e.dxScreen,dy:e.dyScreen,type:"move-stop"},type:"update"})})),o.on("graphic-rotate-start",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,angle:e.angle,type:"rotate-start"},type:"update"})})),o.on("graphic-rotate-stop",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,angle:e.angle,type:"rotate-stop"},type:"update"})})),o.on("graphic-scale-start",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,xScale:e.xScale,yScale:e.yScale,type:"scale-start"},type:"update"})})),o.on("graphic-scale-stop",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,xScale:e.xScale,yScale:e.yScale,type:"scale-stop"},type:"update"})})),o.on("graphic-translate",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,dx:e.dxScreen,dy:e.dyScreen,type:"move"},type:"update"})})),o.on("graphic-rotate",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,angle:e.angle,type:"rotate"},type:"update"})})),o.on("graphic-scale",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,xScale:e.xScale,yScale:e.yScale,type:"scale"},type:"update"})})),o.on("immediate-click",(o=>{o.shiftKey?this._toggleSelection([o.graphic],e,t):e.toggleTool()}))];case"reshape-3d":return[o.on("reshape",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:e,type:"update"})})),o.on("move",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:e,type:"update"})})),o.on("vertex-add",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:e,type:"update"})})),o.on("vertex-remove",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:e,type:"update"})})),o.on("immediate-click",(o=>{o.shiftKey?this._toggleSelection([o.graphic],e,t):e.toggleTool()}))];default:return}},a._onTransformOrReshape2DGraphicClick=function(e,t,o){var i;const{graphic:r,viewEvent:a}=o;return null!=(i=a.native)&&i.shiftKey&&r.layer===this.layer?(a.stopPropagation(),e.removeFromSelection(r)):t.toggleToolOnClick?(a.stopPropagation(),e.toggleTool()):void 0},a._setUpdateOperationHandle=function(e,t){this._operationHandle=e;const o=this.view.map;this._disablePopup(t);const i=()=>{if(e===this._operationHandle){const i=this.updateGraphics.toArray(),r=this._operationHandle.tool;this._operationHandle.destroy(),this._operationHandle=null,this._internalGraphicsLayer.removeMany(this.updateGraphics.toArray()),this.updateGraphics.removeAll(),o&&o.remove(this._internalGraphicsLayer),this._restorePopup(t),this.emit("update",{graphics:i,state:"complete",aborted:e.cancelled,tool:r,toolEventInfo:null,type:"update"})}};e.on("complete",i)},a._getCommonUpdateOperationClickHandlers=function(){var e=t._asyncToGenerator((function*(e,t,o){const i=P.createScreenPointFromEvent(t),r=(yield t.async((()=>this._getFirstHit(i)))).results;if(!r.length)return void e.complete();if(t.native.shiftKey&&this._toggleSelection(r.map((e=>e.graphic)),e,o))return void t.stopPropagation();r.some((e=>e.graphic&&this.updateGraphics.includes(e.graphic)))?t.stopPropagation():e.complete()}));function o(t,o,i){return e.apply(this,arguments)}return o}(),a._toggleSelection=function(e,t,o){const i=!!o.multipleSelectionEnabled;return e.some((e=>null!=e&&(!(!i||e.layer!==this.layer)&&(this.updateGraphics.includes(e)?t.removeFromSelection(e):t.addToSelection(e),!0))))},a._getCommonUpdateOperationKeyDownHandlers=function(e,t){if(!e)return;const o=t.key;o===A.SKETCH_KEYS.undo&&e.canUndo()?(t.stopPropagation(),e.undo()):o===A.SKETCH_KEYS.redo&&e.canRedo()?(t.stopPropagation(),e.redo()):o===A.SKETCH_KEYS.cancel?(t.stopPropagation(),e.cancel()):this.allowDeleteKey&&A.SKETCH_KEYS.delete.includes(o)&&this._onDeleteKey(t)},a._onDeleteKey=function(e){if(!this._operationHandle||"update"!==this._operationHandle.type)return;const t=this.activeComponent,o=this.updateGraphics.toArray();c.isNone(t)||"reshape-3d"===t.type||("reshape"!==t.type||1===o.length&&"point"===c.get(o[0].geometry,"type"))&&(e.stopPropagation(),this.delete())},a._removeDefaultLayer=function(){this._internalGraphicsLayer&&(this.view&&this.view.map&&this.view.map.remove(this._internalGraphicsLayer),this._internalGraphicsLayer=c.destroyMaybe(this._internalGraphicsLayer))},a._isComponentGraphic=function(e){const{activeComponent:t}=this;return!(!e||c.isNone(t))&&(e.attributes&&e.attributes.esriSketchTool||"draw-2d"===t.type&&t.graphic===e||("box"===t.type||"reshape"===t.type)&&t.isUIGraphic(e))},a._displayPointerCursor=function(){this.view&&this.view.container&&"pointer"!==this.view.cursor&&(this.view.cursor="pointer")},a._displayGrabbingCursor=function(){this.view&&this.view.container&&"grabbing"!==this.view.cursor&&(this.view.cursor="grabbing")},a._displayDefaultCursor=function(){this.view&&this.view.container&&null!==this.view.cursor&&(this.view.cursor=null)},a._logError=function(e,t,o){x.error(new n(e,t,o))},a._requireModule=function(){var e=t._asyncToGenerator((function*(e){const t=new AbortController;this._moduleLoaderAbortController=t;const o=yield e;return this._moduleLoaderAbortController!==t||t.signal.aborted?{requireError:"aborted"}:{module:o}}));function o(t){return e.apply(this,arguments)}return o}(),a._emitUndoEvent=function(e){this.emit("undo",{...e,type:"undo"})},a._emitRedoEvent=function(e){this.emit("redo",{...e,type:"redo"})},a._emitDeleteEvent=function(e){this.emit("delete",{...e,type:"delete"})},a.test=function(){return{operationHandle:this._operationHandle,defaultUpdateOptions:L}},a.wait=function(){return u.whenNotOnce(this,"updating")},a._beginAsyncOperation=function(){this._numUpdating+=1,this.notifyChange("updating")},a._endAsyncOperation=function(){this._numUpdating-=1,this.notifyChange("updating")},a._disablePopupEnabled=function(e){var t;return"3d"!==(null==(t=this.view)?void 0:t.type)||this.updateOnGraphicClick||c.isSome(e)&&e.toggleToolOnClick},a._disablePopup=function(e){if(!this._disablePopupEnabled(e))return;const t=this.view.popup;t&&c.isNone(this._originalAutoOpenEnabled)&&(this._originalAutoOpenEnabled=t.autoOpenEnabled,t.autoOpenEnabled=!1)},a._restorePopup=function(e){if(!this._disablePopupEnabled(e))return;const t=this.view.popup;t&&c.isSome(this._originalAutoOpenEnabled)&&(t.autoOpenEnabled=this._originalAutoOpenEnabled,this._originalAutoOpenEnabled=null)},a._waitViewReady=function(){var e=t._asyncToGenerator((function*(){this.view&&(c.abortMaybe(this._viewReadyAbortController),this._viewReadyAbortController=new AbortController,yield d.whenOrAbort(u.whenOnce(this.view,"ready"),this._viewReadyAbortController.signal))}));function o(){return e.apply(this,arguments)}return o}(),t._createClass(i,[{key:"_defaultUpdateTool",get:function(){return"3d"===this.view.type?"move":"transform"}},{key:"updating",get:function(){return this._numUpdating>0}},{key:"activeTool",get:function(){return this._operationHandle&&this._operationHandle.tool?this._operationHandle.tool:null}},{key:"activeComponent",get:function(){return this._operationHandle?this._operationHandle.activeComponent:null}},{key:"createGraphic",get:function(){return!c.isSome(this.activeComponent)||"draw-3d"!==this.activeComponent.type&&"draw-2d"!==this.activeComponent.type?this._get("createGraphic"):c.unwrap(this.activeComponent.graphic)}},{key:"defaultCreateOptions",set:function(e){this._set("defaultCreateOptions",{...V,...e})}},{key:"defaultUpdateOptions",set:function(e){this._set("defaultUpdateOptions",{...L,...e,reshapeOptions:{...L.reshapeOptions,...null==e?void 0:e.reshapeOptions}})}},{key:"snappingOptions",set:function(e){c.isSome(this._snappingManager)&&(this._snappingManager.options=e),this._set("snappingOptions",e)}},{key:"state",get:function(){var e;const t=!(null==(e=this.view)||!e.ready||!this.layer),o=this._operationHandle;return t&&o?"active":t?"ready":"disabled"}},{key:"view",get:function(){return this._get("view")},set:function(e){const t=this._get("view");if(t){const{container:e,map:o}=t;e&&(t.cursor=null),o&&o.remove(this._internalGraphicsLayer),this._viewHandles.removeAll(),this.cancel()}const o="view-ready";this._handles.remove(o),e&&this._handles.add(u.when(e,"ready",(t=>{this._viewHandles.removeAll(),t&&this._viewHandles.add(this._generateViewHandles(e))}),!0),o),this._set("view",e)}}]),i}(s.EventedAccessor);function Y(e){return"polygon"===e||"rectangle"===e||"circle"===e}function W(e,t){N("undo",e.history.undo,e.history.redo,t)}function q(e,t){N("redo",e.history.redo,e.history.undo,t)}function N(e,t,o,i){const r=t.pop().updates,a=[];i.forEach(((t,o)=>{const i=r[o];null!=i&&("geometry"in i&&c.isSome(i.geometry)&&(a.push({geometry:t.geometry}),t.geometry=i.geometry),"symbol"in i&&c.isSome(i.symbol)&&(a.push({symbol:t.symbol}),t.symbol=i.symbol),"undo"in i&&(a.push(i),i[e](t)))})),o.push({updates:a})}function Z(e){return{updates:e.map((e=>({geometry:e.geometry})))}}function z(e){return"requireError"in e&&"aborted"===e.requireError}o.__decorate([y.property()],F.prototype,"updating",null),o.__decorate([y.property()],F.prototype,"_operationHandle",void 0),o.__decorate([y.property({readOnly:!0})],F.prototype,"activeTool",null),o.__decorate([y.property()],F.prototype,"activeFillSymbol",void 0),o.__decorate([y.property()],F.prototype,"activeLineSymbol",void 0),o.__decorate([y.property()],F.prototype,"activeVertexSymbol",void 0),o.__decorate([y.property()],F.prototype,"allowDeleteKey",void 0),o.__decorate([y.property({readOnly:!0})],F.prototype,"createGraphic",null),o.__decorate([y.property()],F.prototype,"defaultCreateOptions",null),o.__decorate([y.property()],F.prototype,"defaultUpdateOptions",null),o.__decorate([y.property()],F.prototype,"layer",void 0),o.__decorate([y.property({types:i.symbolTypes})],F.prototype,"pointSymbol",void 0),o.__decorate([y.property({types:i.symbolTypes})],F.prototype,"polygonSymbol",void 0),o.__decorate([y.property({types:i.symbolTypes})],F.prototype,"polylineSymbol",void 0),o.__decorate([y.property({type:k,nonNullable:!0})],F.prototype,"snappingOptions",null),o.__decorate([y.property()],F.prototype,"_snappingManager",void 0),o.__decorate([y.property({readOnly:!0})],F.prototype,"state",null),o.__decorate([y.property({readOnly:!0})],F.prototype,"updateGraphics",void 0),o.__decorate([y.property()],F.prototype,"updateOnGraphicClick",void 0),o.__decorate([y.property({types:i.symbolTypes})],F.prototype,"updatePointSymbol",void 0),o.__decorate([y.property({types:i.symbolTypes})],F.prototype,"updatePolygonSymbol",void 0),o.__decorate([y.property({types:i.symbolTypes})],F.prototype,"updatePolylineSymbol",void 0),o.__decorate([y.property({types:i.symbolTypes})],F.prototype,"vertexSymbol",void 0),o.__decorate([y.property({value:null})],F.prototype,"view",null),o.__decorate([y.property()],F.prototype,"cancel",null),o.__decorate([y.property()],F.prototype,"complete",null),o.__decorate([y.property()],F.prototype,"delete",null),o.__decorate([y.property()],F.prototype,"create",null),o.__decorate([y.property()],F.prototype,"update",null),o.__decorate([y.property()],F.prototype,"undo",null),o.__decorate([y.property()],F.prototype,"redo",null),o.__decorate([y.property()],F.prototype,"canUndo",null),o.__decorate([y.property()],F.prototype,"canRedo",null),o.__decorate([y.property()],F.prototype,"toggleUpdateTool",null),F=o.__decorate([m.subclass(D)],F);return F}));
