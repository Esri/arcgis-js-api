// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../geometry","../../Graphic","../../symbols","../../core/Collection","../../core/compilerUtils","../../core/Error","../../core/Evented","../../core/Handles","../../core/Logger","../../core/maybe","../../core/screenUtils","../../core/watchUtils","../../core/accessorSupport/decorators","../../geometry/support/coordsUtils","../../geometry/support/geodesicConstants","../../layers/GraphicsLayer","../../symbols/SimpleFillSymbol","../../symbols/SimpleLineSymbol","../../symbols/SimpleMarkerSymbol","../../views/DOMContainer","../../views/3d/interactive/editingTools/isSupportedGraphicUtils","../../views/3d/interactive/editingTools/moveGraphic/isSupportedGraphic","../../views/3d/interactive/editingTools/reshapeGraphic/isSupportedGraphic","../../views/3d/interactive/editingTools/transformGraphic/isSupportedGraphic","../../views/draw/Draw","../../views/draw/support/createUtils","../../views/draw/support/layerUtils","../../views/input/InputManager","./support/OperationHandle","@dojo/framework/shim/Promise"],(function(e,t,r,o,i,a,n,s,p,c,l,d,h,u,y,v,m,_,g,f,w,G,b,S,E,x,C,T,A,I,P,O){"use strict";var k=d.getLogger("esri.widgets.Sketch.SketchViewModel"),H={redoKey:"r",undoKey:"z",centerKey:"Alt",constraintKey:"Control",snappingKey:"Shift",cancelKey:"Escape",deleteKeys:["Backspace","Delete"],complete:"c",pan:" "};function L(e,t){var r=e.history.undo.pop().updates,o=[];t.forEach((function(e,t){var i=r[t],a={};null!=i&&(h.isSome(i.geometry)&&(a.geometry=e.geometry,e.geometry=i.geometry),h.isSome(i.symbol)&&(a.symbol=e.symbol,e.symbol=i.symbol),o.push(a))})),e.history.redo.push({updates:o})}function U(e,t){var r=e.history.redo.pop().updates,o=[];t.forEach((function(e,t){var i=r[t],a={};null!=i&&(h.isSome(i.geometry)&&(a.geometry=e.geometry,e.geometry=i.geometry),h.isSome(i.symbol)&&(a.symbol=e.symbol,e.symbol=i.symbol),o.push(a))})),e.history.undo.push({updates:o})}function M(e){return{updates:e.map((function(e){return{geometry:e.geometry}}))}}function D(e){return{updates:e.map((function(e){return{symbol:e.symbol}}))}}function R(e){return"requireError"in e&&"aborted"===e.requireError}return(function(t){function c(e){var r=t.call(this,e)||this;return r._activeFillGraphic=null,r._activeLineGraphic=null,r._centerIndicatorGraphic=null,r._centerSymbol=new G({style:"cross",size:6,color:[255,255,255]}),r._defaultSegmentOffset=48,r._numUpdating=0,r._handles=new l,r._internalGraphicsLayer=new g({listMode:"hide"}),r._lineGraphic=null,r._operationHandle=null,r._vertexGraphics=[],r._viewHandles=new l,r._doUnnormalization=!1,r.activeFillSymbol=new f({style:"solid",color:[150,150,150,.2],outline:{color:[0,0,0,0]}}),r.activeLineSymbol=new w({color:[12,207,255,1],width:2,style:"dash"}),r.activePointSymbol=new G({style:"circle",size:6,color:[12,207,255],outline:{color:[50,50,50],width:1}}),r.activeVertexSymbol=new G({style:"circle",size:6,color:[12,207,255],outline:{color:[50,50,50],width:1}}),r.createGraphic=null,r.defaultCreateOptions={mode:"hybrid"},r.defaultUpdateOptions={enableMidpoints:!0,enableMoveAllGraphics:!0,enableRotation:!0,enableScaling:!0,multipleSelectionEnabled:!0,preserveAspectRatio:!1,toggleToolOnClick:!0,tool:"transform",enableZ:!0},r.layer=null,r.pointSymbol=new G({style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}}),r.polygonSymbol=new f({color:[150,150,150,.2],outline:{color:[50,50,50],width:2}}),r.polylineSymbol=new w({color:[130,130,130,1],width:2}),r.updateGraphics=new n,r.updateOnGraphicClick=!0,r.updatePointSymbol=new G({size:10,color:[0,200,255,.5],outline:{color:"black",width:1}}),r.updatePolygonSymbol=new f({color:[12,207,255,.2],outline:{join:"round",color:[12,207,255],width:2}}),r.updatePolylineSymbol=new w({color:[12,207,255],width:2}),r.vertexSymbol=new G({style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}}),r._originalAutoOpenEnabled=null,r}return r.__extends(c,t),c.prototype.initialize=function(){var e=this;this._handles.add([y.watch(this,"layer",(function(){e.cancel(),e._internalGraphicsLayer.elevationInfo=h.isSome(e.layer)?e.layer.elevationInfo:null})),y.on(this,"view.map.layers","change",(function(t){t.removed.indexOf(e.layer)>=0&&e.cancel()})),y.on(this,"layer.graphics","change",(function(t){if(h.isSome(e._operationHandle))for(var r=0,o=t.removed;r<o.length;r++){var i=o[r];e.updateGraphics.includes(i)&&(e.updateGraphics.length>1?e._operationHandle.removeFromSelection(i):e._operationHandle.cancel())}})),y.init(this,"layer.elevationInfo",(function(){e.cancel(),e._internalGraphicsLayer.elevationInfo=h.isSome(e.layer)?e.layer.elevationInfo:null}),!0)])},c.prototype.destroy=function(){this.cancel(),this._handles.removeAll(),this._handles=null,this._viewHandles.removeAll(),this._viewHandles=null,this._removeDefaultLayer(),this._draw&&this._draw.destroy(),this._set("view",null),this.emit("destroy")},Object.defineProperty(c.prototype,"_defaultUpdateTool",{get:function(){return"3d"===this.view.type?"move":"transform"},enumerable:!1,configurable:!0}),Object.defineProperty(c.prototype,"_draw",{get:function(){return"ready"===this.state||"active"===this.state?new T({view:this.view}):null},enumerable:!1,configurable:!0}),Object.defineProperty(c.prototype,"updating",{get:function(){return this._numUpdating>0},enumerable:!1,configurable:!0}),Object.defineProperty(c.prototype,"activeTool",{get:function(){return this._operationHandle&&this._operationHandle.tool?this._operationHandle.tool:null},enumerable:!1,configurable:!0}),Object.defineProperty(c.prototype,"activeComponent",{get:function(){return this._operationHandle?this._operationHandle.activeComponent:null},enumerable:!1,configurable:!0}),Object.defineProperty(c.prototype,"state",{get:function(){var e=!(!this.get("view.ready")||!this.layer),t=this._operationHandle;return e&&t?"active":e?"ready":"disabled"},enumerable:!1,configurable:!0}),Object.defineProperty(c.prototype,"view",{get:function(){return this._get("view")},set:function(e){var t=this,r=this._get("view");if(r){var o=r.container,i=r.map;o&&(r.cursor=null),i&&i.remove(this._internalGraphicsLayer),this._viewHandles.removeAll(),this.cancel()}this._doUnnormalization=null!=e&&"3d"===e.type&&"global"===e.viewingMode;this._handles.remove("view-ready"),e&&this._handles.add(y.when(e,"ready",(function(r){t._viewHandles.removeAll(),r&&t._viewHandles.add(t._generateViewHandles(e))}),!0),"view-ready"),this._set("view",e)},enumerable:!1,configurable:!0}),c.prototype.cancel=function(){this._moduleLoaderAbortController&&(this._moduleLoaderAbortController.abort(),this._moduleLoaderAbortController=null),this._operationHandle&&this._operationHandle.cancel()},c.prototype.complete=function(){this._operationHandle&&this._operationHandle.complete()},c.prototype.delete=function(){var e=this.state,t=this.updateGraphics;if("active"===e&&t.length){var r=this.activeTool,o=this.layer,i=t.toArray();o.removeMany(i),this.cancel(),this._emitDeleteEvent({graphics:i,tool:r})}},c.prototype.create=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var o,i,a=this;return r.__generator(this,(function(r){switch(r.label){case 0:return"disabled"===this.state?(this.layer||this._logError("sketch:missing-property","Property 'layer' is missing on SketchViewModel."),this.view||this._logError("sketch:missing-property","Property 'view' is missing on SketchViewModel."),[2]):(this.cancel(),e?[4,this._setupCreateOperation(e,t)]:(this._logError("sketch:missing-parameter","Missing parameter 'tool'."),[2]));case 1:return o=r.sent(),h.isNone(o)?[2]:(I.addUniqueLayer(this.view,this._internalGraphicsLayer),i=function(){if(o===a._operationHandle){var t=a.createGraphic,r=a._operationHandle.cancelled;a._operationHandle.destroy(),a._operationHandle=null,a._set("createGraphic",null),a.view&&a.view.map&&a.view.map.remove(a._internalGraphicsLayer),o.cancelled||a.layer.add(t),a.emit("create",{graphic:t,state:r?"cancel":"complete",tool:e,toolEventInfo:null,type:"create"})}},o.on("complete",i),this._operationHandle=o,this.view.ready&&b.isDOMContainer(this.view)&&this.view.focus(),[2])}}))}))},c.prototype.update=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var o,i,a,n,s,p,c=this;return r.__generator(this,(function(r){switch(r.label){case 0:return i=(o=this).layer,a=o.state,n=o.view,"disabled"===a?(i||this._logError("sketch:missing-property","Property 'layer' is missing on SketchViewModel."),n||this._logError("sketch:missing-property","Property 'view' is missing on SketchViewModel."),[2]):(this.cancel(),s=Array.isArray(e)?e:[e],null!=e&&s&&s.length?s.some((function(e){return e.layer!==i?(c._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics missing from the supplied GraphicsLayer."),!0):h.isNone(e.geometry)?(c._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics with an unsupported geometry."),!0):"2d"===n.type&&!n.spatialReference.equals(e.geometry.spatialReference)&&(c._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics with a spatial reference different from the supplied MapView."),!0)}))?[2]:[4,this._setupUpdateOperation(s,t)]:(this._logError("sketch:missing-parameter","Missing parameter 'graphics'."),[2]));case 1:return p=r.sent(),h.isNone(p)||R(p)?[2]:(I.addUniqueLayer(this.view,this._internalGraphicsLayer),this.emit("update",{graphics:s,state:"start",aborted:!1,tool:p.tool,toolEventInfo:null,type:"update"}),this._setUpdateOperationHandle(p),[2])}}))}))},c.prototype.undo=function(){this.canUndo()&&this._operationHandle.undo()},c.prototype.redo=function(){this.canRedo()&&this._operationHandle.redo()},c.prototype.canUndo=function(){return!(!this._operationHandle||!this._operationHandle.canUndo())},c.prototype.canRedo=function(){return!(!this._operationHandle||!this._operationHandle.canRedo())},c.prototype.toggleUpdateTool=function(){this._operationHandle&&this._operationHandle.toggleTool&&this._operationHandle.toggleTool()},Object.defineProperty(c.prototype,"snapToScene",{set:function(e){this._operationHandle&&this._operationHandle.setSnapToScene&&this._operationHandle.setSnapToScene(e),this._set("snapToScene",e)},enumerable:!1,configurable:!0}),c.prototype._getFirstHit=function(e){var t,o;return r.__awaiter(this,void 0,void 0,(function(){var i,a,n,s,p;return r.__generator(this,(function(r){switch(r.label){case 0:switch(i=[],this.view.type){case"2d":return[3,1];case"3d":return[3,3]}return[3,5];case 1:return[4,this.view.hitTest(e)];case 2:return(s=r.sent()).results.length>0&&(p=s.results[0]).graphic&&(a=p.graphic,"vector-tile"!==(null===(t=a.layer)||void 0===t?void 0:t.type)&&"imagery"!==(null===(o=a.layer)||void 0===o?void 0:o.type)&&i.push(p)),[3,5];case 3:return n=[this.view.map.ground],this.view.map.allLayers.forEach((function(e){"integrated-mesh"===e.type&&n.push(e)})),[4,this.view.hitTest(e,{exclude:n})];case 4:return(s=r.sent()).results.length>0&&(p=s.results[0],(!s.ground||this.view.map.ground.opacity<1||s.ground.distance-p.distance>-Math.min(3*s.ground.distance,"global"===this.view.viewingMode?_.earthRadius/this.view.renderCoordsHelper.unitInMeters:Number.POSITIVE_INFINITY))&&i.push(p)),[3,5];case 5:return[2,{screenPoint:e,results:i}]}}))}))},c.prototype._generateViewHandles=function(e){var t=this;return[e.on("immediate-click",(function(o){var i=t,a=i._operationHandle,n=i.defaultUpdateOptions,s=i.layer,p=i.state,c=i.updateGraphics,l=i.updateOnGraphicClick,d="active"===p&&"create"===a.type;"disabled"!==p&&!d&&l&&(t._beginAsyncOperation(),t._getFirstHit(u.createScreenPointFromEvent(o)).then((function(r){var i=r.results;if(i.length)for(var a=0;a<i.length;++a){var n=i[a];if(n.graphic){var l=n.graphic;if(c.indexOf(l)>-1||l.layer===s)return o.stopPropagation(),l;"2d"!==e.type||t._isComponentGraphic(l)||"active"!==p||t.cancel()}}else"active"===p&&t.cancel();return null})).then((function(e){return h.isSome(e)&&-1===c.indexOf(e)?t.update([e],r.__assign({},n)):null})).then((function(){t._endAsyncOperation()})))}),P.ViewEventPriorities.WIDGET)]},c.prototype._setupCreateOperation=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var o,i,a;return r.__generator(this,(function(n){switch(n.label){case 0:if(!e)return[2,null];if(o=r.__assign(r.__assign({hasZ:"3d"===this.view.type,defaultZ:0},this.defaultCreateOptions),t),"2d"!==this.view.type)return[3,1];switch(e){case"point":i=this._setupCreatePointOperation(e,o);break;case"multipoint":i=this._setupCreateMultipointOperation(e,null);break;case"polygon":case"polyline":i=this._setupCreatePolyOperation(e,o);break;case"rectangle":i=this._setupCreateRectangleOperation(e,o);break;case"circle":i=this._setupCreateCircleOperation(e,o)}return[3,3];case 1:return[4,this._setupCreate3DOperation(e,this.view,o)];case 2:if(a=n.sent(),h.isNone(a)||R(a))return[2,null];i=a,n.label=3;case 3:return[2,i]}}))}))},c.prototype._setupCreate3DOperation=function(t,o,i){return r.__awaiter(this,void 0,void 0,(function(){var a,n,s,p,c,l,d,u,y=this;return r.__generator(this,(function(v){switch(v.label){case 0:return t?"multipoint"===t?[2,null]:(a={point:this.pointSymbol,multipoint:null,polyline:this.polylineSymbol,polygon:this.polygonSymbol,rectangle:this.polygonSymbol,circle:this.polygonSymbol},n=a[t],this._removeCreateOperationGraphics(),s=r.__assign(r.__assign(r.__assign({view:o,hasZ:!0,defaultZ:0,mode:"hybrid",elevationInfo:this.layer.elevationInfo,geometryType:t},this.defaultCreateOptions),i),{createGraphicSymbol:n,snapToScene:this._getDefaultSnapToScene(),forceUniformSize:!1,centered:"rectangle"!==t}),[4,this._requireModule(new Promise((function(t,r){e(["../../views/3d/interactive/editingTools"],t,r)})))]):[2,null];case 1:return R(p=v.sent())?[2,p]:(c=new p.module.DrawGraphicTool(s),this.view.tools.add(c),l=null,this.view.activeTool=c,d=[],u=new O.OperationHandle({activeComponent:c,tool:t,type:"update",onEnd:function(){var e;d.forEach((function(e){return e.remove()})),d.length=0,null===(e=y.view.tools)||void 0===e||e.remove(c),c.destroy()},undo:function(){c.canUndo&&c.undo()},redo:function(){c.canRedo&&c.redo()},canUndo:function(){return c.canUndo},canRedo:function(){return c.canRedo},setSnapToScene:function(e){c.snapToScene=e}}),d.push(this.view.on("key-down",(function(e){e.key===H.pan?(e.stopPropagation(),e.repeat||(c.enabled=!1)):e.key===H.complete?(e.stopPropagation(),c.completeCreateOperation()):e.key===H.undoKey?(e.stopPropagation(),u.undo()):e.key===H.redoKey?(e.stopPropagation(),u.redo()):e.key===H.constraintKey?e.repeat||(c.forceUniformSize=!0,e.stopPropagation()):e.key===H.centerKey&&(e.repeat||(c.centered="rectangle"===t,e.stopPropagation()))}),P.ViewEventPriorities.WIDGET),this.view.on("key-up",(function(e){e.key===H.pan?c.enabled=!0:e.key===H.constraintKey?(c.forceUniformSize=!1,e.stopPropagation()):e.key===H.centerKey&&(c.centered="rectangle"!==t,e.stopPropagation())}),P.ViewEventPriorities.WIDGET),c.on("vertex-add",(function(e){switch(l=h.isNone(l)?"start":"active",e.operation){case"apply":y.emit("create",{graphic:h.unwrap(c.createGraphic),state:l,tool:y.activeTool,toolEventInfo:e,type:"create"});break;case"undo":y._emitUndoEvent({graphics:[h.unwrap(c.createGraphic)],tool:t});break;case"redo":y._emitRedoEvent({graphics:[h.unwrap(c.createGraphic)],tool:t})}})),c.on("cursor-update",(function(e){c.drawOperation.numCommittedVertices>0&&y.emit("create",{graphic:h.unwrap(c.createGraphic),state:"active",tool:y.activeTool,toolEventInfo:{coordinates:e.vertices[0].coordinates,type:"cursor-update"},type:"create"})})),c.on("vertex-remove",(function(e){switch(e.operation){case"apply":y.emit("create",{graphic:h.unwrap(c.createGraphic),state:"active",tool:y.activeTool,toolEventInfo:e,type:"create"});break;case"undo":y._emitUndoEvent({graphics:[h.unwrap(c.createGraphic)],tool:t});break;case"redo":y._emitRedoEvent({graphics:[h.unwrap(c.createGraphic)],tool:t})}})),c.on("complete",(function(e){y._removeCreateOperationGraphics(),y._set("createGraphic",h.unwrap(e.graphic)),l="complete",e.aborted?u&&u.cancel():u&&u.complete()}))),[2,u])}}))}))},c.prototype._setupCreatePointOperation=function(e,t){var o=this,a={elevationInfo:this.layer.elevationInfo,hasZ:t.hasZ,defaultZ:t.defaultZ,interactiveUndoDisabled:!0},n=this._draw.create(e,a),s=[n.on("cursor-update",(function(e){h.isSome(e.vertexIndex)?o._displayCrosshairCursor():o._displayDefaultCursor()})),n.on("draw-complete",(function(e){var t=o.createPointFromVertex(e.vertices[0]),r=new i(t,o.pointSymbol);o._set("createGraphic",r),c&&c.complete()}))],p=[this.view.on("key-down",(function(e){e.key===H.cancelKey&&(c&&c.cancel(),e.stopPropagation())}),P.ViewEventPriorities.WIDGET)],c=this._operationHandleForCreateAction(n,r.__spreadArrays(s,p),e);return c},c.prototype._setupCreateMultipointOperation=function(e,t){var o=this,i=r.__assign(r.__assign({},t),{undoDisabled:!0}),a=this._draw.create(e,i),n=null,s=[],p=this._operationHandleForCreateAction(a,s,e);return s.push(a.on("vertex-add",(function(t){var r=t.type,i=t.vertexIndex,a=t.vertices,s=a[i];n=t,o._drawMultipointGraphic(a,!0),o.emit("create",{graphic:o.createGraphic,state:1===a.length?"start":"active",tool:e,toolEventInfo:{added:s,vertices:[{coordinates:s,componentIndex:0,vertexIndex:i}],type:r},type:"create"})})),a.on("vertex-remove",(function(t){var r=t.type,i=t.vertexIndex,a=t.vertices,s=a[i];n=t,o._drawMultipointGraphic(a,!0),o.emit("create",{graphic:o.createGraphic,state:"active",tool:e,toolEventInfo:{removed:s,vertices:[{coordinates:s,componentIndex:0,vertexIndex:i}],type:r},type:"create"})})),a.on("vertex-update",(function(t){var r=t.type,i=t.vertexIndex,a=t.vertices,s=a[i];n=t,o._drawMultipointGraphic(a,!0),o.emit("create",{graphic:o.createGraphic,state:"active",tool:e,toolEventInfo:{type:r,updated:s,vertices:[{coordinates:s,componentIndex:0,vertexIndex:i}]},type:"create"})})),a.on("cursor-update",(function(e){n=e})),a.on("draw-complete",(function(e){var t=e.vertices.slice(0),r=A.createMultipoint(t,o.view.spatialReference);r&&o.createGraphic&&(o.createGraphic.geometry=r),p&&p.complete()})),a.on("undo",(function(e){var t=e.vertices,r=n&&"cursor-update"!==n.type;o._resetCreateOperationGraphics(),t.length&&o._drawMultipointGraphic(t,r)})),a.on("redo",(function(e){var t=e.vertices,r=n&&"cursor-update"!==n.type;o._resetCreateOperationGraphics(),t.length&&o._drawMultipointGraphic(t,r)}))),s.push(this.view.on("pointer-move",(function(){return o._displayCrosshairCursor()}),P.ViewEventPriorities.WIDGET),this.view.on("key-down",(function(e){return o._getCommonUpdateOperationKeyDownHandlers(p,e)}),P.ViewEventPriorities.WIDGET)),p},c.prototype._getDefaultSnapToScene=function(){if("2d"===this.view.type)return!1;return h.isSome(this.snapToScene)?this.snapToScene:!h.isSome(this.layer.elevationInfo)||"absolute-height"===this.layer.elevationInfo.mode},c.prototype._setupCreatePolyOperation=function(e,t){var i=this,a=r.__assign(r.__assign({},t),{elevationInfo:this.layer.elevationInfo,interactiveUndoDisabled:!0}),n=null;"polyline"===e?n=this._draw.create(e,a):"polygon"===e&&(n=this._draw.create(e,a));var s=new o.Point,p=null,c=!1,l=[n.on("vertex-add",(function(t){var r=t.type,o=t.vertexIndex,a=t.vertices,n=a[o];i._snap(e,a,c),p=t,i._drawVertexGraphics(e,a,{userClicked:!0}),i.emit("create",{graphic:i.createGraphic,state:1===a.length?"start":"active",tool:e,toolEventInfo:{added:n,vertices:[{coordinates:n,componentIndex:0,vertexIndex:o}],type:r},type:"create"})})),n.on("vertex-remove",(function(t){var r=t.type,o=t.vertexIndex,a=t.vertices,n=a[o];i._snap(e,a,c),p=t,i._drawVertexGraphics(e,a,{userClicked:!0}),i.emit("create",{graphic:i.createGraphic,state:"active",tool:e,toolEventInfo:{removed:n,vertices:[{coordinates:n,componentIndex:0,vertexIndex:o}],type:r},type:"create"})})),n.on("vertex-update",(function(t){var r=t.type,o=t.vertexIndex,a=t.vertices,n=a[o];i._snap(e,a,c),p=t,i._drawVertexGraphics(e,a,{userClicked:!0}),i.emit("create",{graphic:i.createGraphic,state:"active",tool:e,toolEventInfo:{type:r,updated:n,vertices:[{coordinates:n,componentIndex:0,vertexIndex:o}]},type:"create"})})),n.on("cursor-update",(function(t){var r=t.type,o=t.vertices;if(t.mapPoint&&(i._snap(e,o,c),p=t,s=t.mapPoint,i._drawVertexGraphics(e,o,{userClicked:!1}),o.length>1)){var a=o[o.length-1];i.emit("create",{graphic:i.createGraphic,state:"active",tool:e,toolEventInfo:{coordinates:a,type:r},type:"create"})}})),n.on("draw-complete",(function(t){var r=t.vertices.slice(0),o=null;"polyline"===e?o=A.createPolyline([r],i.view.spatialReference,i._doUnnormalization):"polygon"===e&&(o=A.createPolygon([r],i.view.spatialReference,i._doUnnormalization,!0)),o&&(i.createGraphic.geometry=o),v&&v.complete()})),n.on("undo",(function(t){var r=t.vertices,o=p&&"cursor-update"!==p.type;i._resetCreateOperationGraphics(),i._snap(e,r,c),r.length&&i._drawVertexGraphics(e,r,{userClicked:o})})),n.on("redo",(function(t){var r=t.vertices,o=p&&"cursor-update"!==p.type;i._resetCreateOperationGraphics(),i._snap(e,r,c),r.length&&i._drawVertexGraphics(e,r,{userClicked:o})}))],d=[this.view.on("pointer-move",(function(e){i.view.toMap(u.createScreenPoint(e.x,e.y))?i._displayCrosshairCursor():i._displayDefaultCursor()}),P.ViewEventPriorities.WIDGET),this.view.on("key-down",(function(t){var r=n.vertices.slice(0),o=p&&"cursor-update"!==p.type;t.key===H.constraintKey?"2d"===i.view.type&&(c||(c=!0,i._snap(e,r,!o),i._drawVertexGraphics(e,r,{userClicked:o}))):t.key===H.undoKey&&v&&v.canUndo()?(t.stopPropagation(),v.undo()):t.key===H.redoKey&&v&&v.canRedo()?(t.stopPropagation(),v.redo()):t.key===H.cancelKey&&v&&v.cancel()}),P.ViewEventPriorities.WIDGET),this.view.on("key-up",(function(t){var r=n.vertices.slice(0),o=p&&"cursor-update"!==p.type;t.key===H.constraintKey&&c&&(o||(r.pop(),r.push([s.x,s.y]),i._drawVertexGraphics(e,r,{userClicked:o})),c=!1)}),P.ViewEventPriorities.WIDGET)];if("polygon"===e){var h=function(e,t,r){if(!e||!e.layer||!e.visible)return!1;var o=i.view.toScreen(e.geometry);return i._isWithinScreenDistance(o,t,r)},y=!1;d.push(this.view.on("pointer-move",(function(){y=!1}),P.ViewEventPriorities.WIDGET),this.view.on("pointer-down",(function(e){if(function(e){if(!(i._vertexGraphics.length<=2))return h(i._vertexGraphics[0],e,i._getVertexIntersectDistance())}(e))return y=!0,void e.stopPropagation();i._vertexGraphics.some((function(t){return h(t,e,i._getVertexIntersectDistance())}))&&e.stopPropagation()}),P.ViewEventPriorities.WIDGET),this.view.on("pointer-up",(function(e){y&&(e.stopPropagation(),n.complete())})))}var v=this._operationHandleForCreateAction(n,r.__spreadArrays(l,d),e);return v},c.prototype._setupCreateCircleOperation=function(e,t){var o=this,a=r.__assign(r.__assign({},t),{elevationInfo:this.layer.elevationInfo,interactiveUndoDisabled:!0}),n=this._draw.create(e,a),s=!1,p=!0,c=[n.on("vertex-add",(function(t){var r=t.type,i=t.vertexIndex,a=t.vertices,c=a[i];o._drawSegmentGraphic(e,a,{centered:p,constrained:s},n.viewAlignedCoordinateSystem),o.emit("create",{graphic:o.createGraphic,state:1===a.length?"start":"active",tool:e,toolEventInfo:{added:c,vertices:[{coordinates:c,componentIndex:0,vertexIndex:i}],type:r},type:"create"})})),n.on("cursor-update",(function(t){var r=t.type,i=t.vertices;if(o._drawSegmentGraphic(e,i,{centered:p,constrained:s},n.viewAlignedCoordinateSystem),2===i.length){var a=i[i.length-1];o.emit("create",{graphic:o.createGraphic,state:"active",tool:e,toolEventInfo:{coordinates:a,type:r},type:"create"})}})),n.on("draw-complete",(function(e){var t=e.vertices.slice(0),r=null;1===t.length?(t.push(n.viewAlignedCoordinateSystem.makeMapPoint(t[0][0]+o._defaultSegmentOffset*o.view.resolution,t[0][1])),r=A.createCircle(t,n.viewAlignedCoordinateSystem,!0,o.view.resolution)):r=s?A.createEllipse(t,n.viewAlignedCoordinateSystem,p):A.createCircle(t,n.viewAlignedCoordinateSystem,p,o.view.resolution),o.createGraphic?o.createGraphic.geometry=r:(o._removeCreateGraphic(),o._set("createGraphic",new i(r,o.polygonSymbol))),d&&d.complete()}))],l=[this.view.on("pointer-move",(function(e){h.isSome(n.getCoordsFromScreenPoint(u.createScreenPoint(e.x,e.y)))?o._displayCrosshairCursor():o._displayDefaultCursor()}),P.ViewEventPriorities.WIDGET),this.view.on("key-down",(function(t){t.key===H.constraintKey?s||(s=!0,o._drawSegmentGraphic(e,n.vertices,{centered:p,constrained:s},n.viewAlignedCoordinateSystem)):t.key===H.centerKey?p&&(p=!1,o._drawSegmentGraphic(e,n.vertices,{centered:p,constrained:s},n.viewAlignedCoordinateSystem)):t.key===H.cancelKey&&d&&d.cancel()}),P.ViewEventPriorities.WIDGET),this.view.on("key-up",(function(t){t.key===H.constraintKey?(s=!1,o._drawSegmentGraphic(e,n.vertices,{centered:p,constrained:s},n.viewAlignedCoordinateSystem)):t.key===H.centerKey&&(p=!0,o._drawSegmentGraphic(e,n.vertices,{centered:p,constrained:s},n.viewAlignedCoordinateSystem))}),P.ViewEventPriorities.WIDGET)],d=this._operationHandleForCreateAction(n,r.__spreadArrays(c,l),e);return d},c.prototype._setupCreateRectangleOperation=function(e,t){var o=this,a=r.__assign(r.__assign({},t),{elevationInfo:this.layer.elevationInfo,interactiveUndoDisabled:!0}),n=this._draw.create(e,a),s=!1,p=!1,c=[n.on("vertex-add",(function(t){var r=t.type,i=t.vertexIndex,a=t.vertices,c=a[i];o._drawSegmentGraphic(e,a,{centered:p,constrained:s},n.viewAlignedCoordinateSystem),o.emit("create",{graphic:o.createGraphic,state:1===a.length?"start":"active",tool:e,toolEventInfo:{added:c,vertices:[{coordinates:c,componentIndex:0,vertexIndex:i}],type:r},type:"create"})})),n.on("cursor-update",(function(t){var r=t.type,i=t.vertices;if(o._drawSegmentGraphic(e,i,{centered:p,constrained:s},n.viewAlignedCoordinateSystem),2===i.length){var a=i[i.length-1];o.emit("create",{graphic:o.createGraphic,state:"active",tool:e,toolEventInfo:{coordinates:a,type:r},type:"create"})}})),n.on("draw-complete",(function(e){var t,r=e.vertices.slice(0);1===r.length&&(s=!1,p=!1),t=s?A.createSquare(r,n.viewAlignedCoordinateSystem,p):A.createRectangle(r,n.viewAlignedCoordinateSystem,p),o.createGraphic?o.createGraphic.geometry=t:(o._removeCreateGraphic(),o._set("createGraphic",new i(t,o.polygonSymbol))),d&&d.complete()}))],l=[this.view.on("pointer-move",(function(e){h.isSome(n.getCoordsFromScreenPoint(u.createScreenPoint(e.x,e.y)))?o._displayCrosshairCursor():o._displayDefaultCursor()}),P.ViewEventPriorities.WIDGET),this.view.on("key-down",(function(t){t.key===H.constraintKey?s||(s=!0,o._drawSegmentGraphic(e,n.vertices,{centered:p,constrained:s},n.viewAlignedCoordinateSystem)):t.key===H.centerKey?p||(p=!0,o._drawSegmentGraphic(e,n.vertices,{centered:p,constrained:s},n.viewAlignedCoordinateSystem)):t.key===H.cancelKey&&d&&d.cancel()}),P.ViewEventPriorities.WIDGET),this.view.on("key-up",(function(t){t.key===H.constraintKey?(s=!1,o._drawSegmentGraphic(e,n.vertices,{centered:p,constrained:s},n.viewAlignedCoordinateSystem)):t.key===H.centerKey&&(p=!1,o._drawSegmentGraphic(e,n.vertices,{centered:p,constrained:s},n.viewAlignedCoordinateSystem))}),P.ViewEventPriorities.WIDGET)],d=this._operationHandleForCreateAction(n,r.__spreadArrays(c,l),e);return d},c.prototype._setupUpdateOperation=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var o,i,a,n,s,p,c,l,d,u,y,v;return r.__generator(this,(function(m){for(i=(o=this)._defaultUpdateTool,a=o.defaultUpdateOptions,n=o.layer,s=o.view,p=r.__assign(r.__assign({},a),t),c=p.tool||i,l=0,d=e;l<d.length;l++)y=d[l],n.remove(y),n.add(y);if("3d"===s.type){if(0===e.length)return[2,null];switch(c){case"move":return[2,this._setupMove3DOperation(e,p,s,c)];case"reshape":return e.length>1?(this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),[2,null]):0===(u=x.isSupportedGraphic(e[0]))?[2,this._setupReshape3DOperation(e[0],p,s)]:(this._logError("sketch:reshape","Reshape operation not supported for provided graphic(s) ("+S.isSupportedGraphicResultMessage(u)+")."),[2,null]);case"transform":return 1===e.length&&0===C.isSupportedGraphic(e[0])?[2,this._setupPointTransform3DOperation(e[0],p,s)]:[2,this._setupMove3DOperation(e,p,s,c)]}}if("move"===c)return[2,this._setupMoveOperation(e,p,s)];if(e.length>1)return"reshape"===c?(this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),[2,null]):[2,this._setupTransformOrReshapeOperation(e,c,p,s)];if(1===e.length){if(y=e[0],"point"===(v=h.get(y.geometry,"type"))||"multipoint"===v)return[2,this._setupMoveOperation(e,p,s)];if("transform"===c||"reshape"===c)return[2,this._setupTransformOrReshapeOperation(e,c,p,s)]}return[2,null]}))}))},c.prototype._setupMove3DOperation=function(t,o,i,a,n){return void 0===n&&(n=!1),r.__awaiter(this,void 0,void 0,(function(){var s,p,c,l,d,h,u,y,v=this;return r.__generator(this,(function(m){switch(m.label){case 0:for(s=0,p=t;s<p.length;s++)if(c=p[s],0!==(l=E.isSupportedGraphic(c)))return this._logError("sketch:move","Move operation not supported for provided graphic(s) ("+S.isSupportedGraphicResultMessage(l)+")."),[2,null];return[4,this._requireModule(new Promise((function(t,r){e(["../../views/3d/interactive/editingTools"],t,r)})))];case 1:return R(d=m.sent())?[2,d]:(h=new d.module.GraphicMoveTool({view:i,enableZ:o.enableZ}),this.view.tools.add(h),h.graphics.addMany(t),n||this.updateGraphics.addMany(t),u=[],y=new O.OperationHandle({activeComponent:h,tool:a,type:"update",onEnd:function(){var e;u.forEach((function(e){return e.remove()})),u.length=0,null===(e=v.view.tools)||void 0===e||e.remove(h),h.destroyed||h.destroy()},undo:function(){L(y,v.updateGraphics.toArray()),v._emitUndoEvent({graphics:v.updateGraphics.toArray(),tool:a})},redo:function(){U(y,v.updateGraphics.toArray()),v._emitRedoEvent({graphics:v.updateGraphics.toArray(),tool:a})},addToSelection:function(e){v.updateGraphics.push(e),h.graphics.push(e),v.emit("update",{graphics:v.updateGraphics.toArray(),state:"active",aborted:!1,tool:v.activeTool,toolEventInfo:{added:[e],type:"selection-change"},type:"update"})},removeFromSelection:function(e){var t=v.updateGraphics.indexOf(e);y.history.undo.forEach((function(e){return e.updates.splice(t,1)})),y.history.redo.forEach((function(e){return e.updates.splice(t,1)})),v.updateGraphics.remove(e),0!==v.updateGraphics.length?h.graphics.remove(e):y.complete()},toggleTool:function(){return r.__awaiter(v,void 0,void 0,(function(){var e,t;return r.__generator(this,(function(r){switch(r.label){case 0:return 1!==this.updateGraphics.length||!1===o.toggleToolOnClick?[2]:"transform"!==a?[2]:(e=this.updateGraphics.getItemAt(0),0!==x.isSupportedGraphic(e)?[2]:[4,this._setupReshape3DOperation(e,o,i,!0)]);case 1:return R(t=r.sent())?[2]:(y.onEnd(),y.destroy(),this._setUpdateOperationHandle(t),[2])}}))}))}}),u.push.apply(u,r.__spreadArrays(this._getHandlesForComponent(y,o),[this.view.on("immediate-click",(function(e){return v._getCommonUpdateOperationClickHandlers(y,e)}),P.ViewEventPriorities.WIDGET),this.view.on("key-down",(function(e){return v._getCommonUpdateOperationKeyDownHandlers(y,e)}),P.ViewEventPriorities.WIDGET)])),[2,y])}}))}))},c.prototype._setupPointTransform3DOperation=function(t,o,i){return r.__awaiter(this,void 0,void 0,(function(){var a,n,s,p,c,l,d,h,u=this;return r.__generator(this,(function(y){switch(y.label){case 0:return a="transform",n=o.enableRotation,s=o.enableScaling,p=o.enableZ,[4,this._requireModule(new Promise((function(t,r){e(["../../views/3d/interactive/editingTools"],t,r)})))];case 1:return R(c=y.sent())?[2,c]:(l=new c.module.GraphicTransformTool({graphic:t,view:i,enableRotation:n,enableScaling:s,enableZ:p,snapToScene:this.snapToScene}),this.view.tools.add(l),this.updateGraphics.add(t),d=[],h=new O.OperationHandle({activeComponent:l,tool:a,type:"update",onEnd:function(){var e;d.forEach((function(e){return e.remove()})),d.length=0,null===(e=u.view.tools)||void 0===e||e.remove(l),l.destroyed||l.destroy()},undo:function(){L(h,u.updateGraphics.toArray()),u._emitUndoEvent({graphics:u.updateGraphics.toArray(),tool:a})},redo:function(){U(h,u.updateGraphics.toArray()),u._emitRedoEvent({graphics:u.updateGraphics.toArray(),tool:a})},addToSelection:function(e){return r.__awaiter(u,void 0,void 0,(function(){var t;return r.__generator(this,(function(r){switch(r.label){case 0:return this.updateGraphics.add(e),[4,this._setupMove3DOperation(this.updateGraphics.toArray(),o,i,"transform",!0)];case 1:return R(t=r.sent())?[2]:(h.onEnd(),h.destroy(),this._setUpdateOperationHandle(t),[2])}}))}))},setSnapToScene:function(e){l.snapToScene=e}}),d.push.apply(d,r.__spreadArrays(this._getHandlesForComponent(h,o),[this.view.on("immediate-click",(function(e){return u._getCommonUpdateOperationClickHandlers(h,e)}),P.ViewEventPriorities.WIDGET),this.view.on("key-down",(function(e){return u._getCommonUpdateOperationKeyDownHandlers(h,e)}),P.ViewEventPriorities.WIDGET)])),[2,h])}}))}))},c.prototype._setupMoveOperation=function(e,t,o){return r.__awaiter(this,void 0,void 0,(function(){var a,n,s,p,c,l,d=this;return r.__generator(this,(function(r){switch(r.label){case 0:return a=[],n="move",e.forEach((function(e){a.push(new i(e.geometry,e.symbol,e.attributes)),e.symbol=d._getUpdateSymbol(e.geometry)})),this.updateGraphics.addMany(e),[4,this._getGraphicMover(e,t,o)];case 1:return R(s=r.sent())?[2,s]:(p=new O.OperationHandle({activeComponent:s,tool:n,type:"update",onEnd:function(){l.forEach((function(e){return e.remove()})),c.forEach((function(e){return e.remove()})),l=[],c=[],s.destroy(),d._internalGraphicsLayer&&d._internalGraphicsLayer.removeMany(d.updateGraphics.toArray()),d.updateGraphics.forEach((function(e,t){e.symbol=a[t].symbol}))},undo:function(){L(p,d.updateGraphics.toArray()),d._emitUndoEvent({graphics:d.updateGraphics.toArray(),tool:n})},redo:function(){U(p,d.updateGraphics.toArray()),d._emitRedoEvent({graphics:d.updateGraphics.toArray(),tool:n})},addToSelection:function(e){a.push(new i(e.geometry,e.symbol,e.attributes)),e.symbol=d._getUpdateSymbol(e.geometry),d.updateGraphics.push(e),s.graphics=d.updateGraphics.toArray(),d.emit("update",{graphics:d.updateGraphics.toArray(),state:"active",aborted:!1,tool:d.activeTool,toolEventInfo:{added:[e],type:"selection-change"},type:"update"})},removeFromSelection:function(e){var t=d.updateGraphics.indexOf(e);p.history.undo.forEach((function(e){return e.updates.splice(t,1)})),p.history.redo.forEach((function(e){return e.updates.splice(t,1)}));var r=a.splice(t,1)[0];e.symbol=r.symbol,d.updateGraphics.remove(e),0!==d.updateGraphics.length?s.graphics=d.updateGraphics.toArray():p.complete()}}),c=[o.on("immediate-click",(function(e){return d._getCommonUpdateOperationClickHandlers(p,e,t)}),P.ViewEventPriorities.WIDGET),o.on("key-down",(function(e){d._getCommonUpdateOperationKeyDownHandlers(p,e),e.key!==H.constraintKey||e.repeat||(s.enableMoveAllGraphics=!s.enableMoveAllGraphics)}),P.ViewEventPriorities.WIDGET),o.on("key-up",(function(e){e.key===H.constraintKey&&(s.enableMoveAllGraphics=!s.enableMoveAllGraphics)}),P.ViewEventPriorities.WIDGET)],l=this._getHandlesForComponent(p,t),[2,p])}}))}))},c.prototype._setupReshape3DOperation=function(t,o,i,a){return void 0===a&&(a=!1),r.__awaiter(this,void 0,void 0,(function(){var n,s,p,c,l,d=this;return r.__generator(this,(function(h){switch(h.label){case 0:return n="reshape",[4,this._requireModule(new Promise((function(t,r){e(["../../views/3d/interactive/editingTools"],t,r)})))];case 1:return R(s=h.sent())?[2,s]:(p=new s.module.GraphicReshapeTool({view:i,graphic:t,enableZ:o.enableZ}),i.tools.add(p),a||this.updateGraphics.add(t),c=[],l=new O.OperationHandle({activeComponent:p,tool:n,type:"update",onEnd:function(){var e;c.forEach((function(e){return e.remove()})),c.length=0,null===(e=d.view.tools)||void 0===e||e.remove(p),p.destroyed||p.destroy()},undo:function(){L(l,d.updateGraphics.toArray()),d._emitUndoEvent({graphics:d.updateGraphics.toArray(),tool:n})},redo:function(){U(l,d.updateGraphics.toArray()),d._emitRedoEvent({graphics:d.updateGraphics.toArray(),tool:n})},addToSelection:function(e){return r.__awaiter(d,void 0,void 0,(function(){var t;return r.__generator(this,(function(r){switch(r.label){case 0:return this.updateGraphics.add(e),[4,this._setupMove3DOperation(this.updateGraphics.toArray(),o,i,"transform",!0)];case 1:return R(t=r.sent())?[2]:(l.onEnd(),l.destroy(),this._setUpdateOperationHandle(t),[2])}}))}))},toggleTool:function(){return r.__awaiter(d,void 0,void 0,(function(){var e;return r.__generator(this,(function(t){switch(t.label){case 0:return!1===o.toggleToolOnClick?[2]:[4,this._setupMove3DOperation(this.updateGraphics.toArray(),o,i,"transform",!0)];case 1:return R(e=t.sent())?[2]:(l.onEnd(),l.destroy(),this._setUpdateOperationHandle(e),[2])}}))}))}}),c.push.apply(c,r.__spreadArrays(this._getHandlesForComponent(l,o),[i.on("immediate-click",(function(e){return d._getCommonUpdateOperationClickHandlers(l,e)}),P.ViewEventPriorities.WIDGET),i.on("key-down",(function(e){return d._getCommonUpdateOperationKeyDownHandlers(l,e)}),P.ViewEventPriorities.WIDGET)])),[2,l])}}))}))},c.prototype._setupTransformOrReshapeOperation=function(e,t,o,a){return r.__awaiter(this,void 0,void 0,(function(){var n,s,p,c,l,d,y,v,m,_,g=this;return r.__generator(this,(function(f){switch(f.label){case 0:return n=o.multipleSelectionEnabled,s=void 0===n||n,p=o.toggleToolOnClick,c=void 0===p||p,l=[],e.forEach((function(e){l.push(new i(e.geometry,e.symbol,e.attributes)),e.symbol=g._getUpdateSymbol(e.geometry)})),this.updateGraphics.addMany(e),"transform"!==t?[3,2]:[4,this._getBox(e,o,a)];case 1:return y=f.sent(),[3,4];case 2:return[4,this._getReshape(e,o,a)];case 3:y=f.sent(),f.label=4;case 4:return R(d=y)?[2,d]:(v=new O.OperationHandle({activeComponent:d,type:"update",onEnd:function(){_.forEach((function(e){return e.remove()})),m.forEach((function(e){return e.remove()})),_=[],m=[],v.activeComponent&&!v.activeComponent.destroyed&&v.activeComponent.destroy(),g._internalGraphicsLayer.removeMany(g.updateGraphics.toArray()),g.updateGraphics.forEach((function(e,t){l[t]&&l[t].symbol&&(e.symbol=l[t].symbol)}))},undo:function(){L(v,g.updateGraphics.toArray()),v.refreshComponent(),g._emitUndoEvent({graphics:g.updateGraphics.toArray(),tool:v.tool})},redo:function(){U(v,g.updateGraphics.toArray()),v.refreshComponent(),g._emitRedoEvent({graphics:g.updateGraphics.toArray(),tool:v.tool})},addToSelection:function(e){var t=v.activeComponent;l.push(new i(e.geometry,e.symbol,e.attributes)),e.symbol=g._getUpdateSymbol(e.geometry),g.updateGraphics.add(e),t.graphics=g.updateGraphics.toArray(),t.refresh(),v.resetHistory(),g.emit("update",{graphics:g.updateGraphics.toArray(),state:"active",aborted:!1,tool:g.activeTool,toolEventInfo:{added:[e],type:"selection-change"},type:"update"})},removeFromSelection:function(e){var t=v.activeComponent,r=g.updateGraphics.indexOf(e);v.history.undo.forEach((function(e){return e.updates.splice(r,1)})),v.history.redo.forEach((function(e){return e.updates.splice(r,1)}));var o=l.splice(r,1)[0];e.symbol=o.symbol,g.updateGraphics.remove(e),0!==g.updateGraphics.length?t.graphics=g.updateGraphics.toArray():v.complete()},toggleTool:function(){return r.__awaiter(g,void 0,void 0,(function(){var t;return r.__generator(this,(function(r){switch(r.label){case 0:return this.updateGraphics.length>1?[2]:(t=null,"transform"!==v.tool?[3,2]:[4,this._getReshape(e,o,a)]);case 1:return t=r.sent(),[3,4];case 2:return"reshape"!==v.tool?[3,4]:[4,this._getBox(e,o,a)];case 3:t=r.sent(),r.label=4;case 4:return R(t)?[2]:(v.activeComponent.destroy(),v.activeComponent=t,v.activeComponent&&(_.forEach((function(e){return e.remove()})),_=this._getHandlesForComponent(v,o)),[2])}}))}))}}),m=[a.on("immediate-click",(function(e){g._getFirstHit(u.createScreenPointFromEvent(e)).then((function(t){if(v){var r=t.results;if(r.length){var o=v.activeComponent,i=e.native&&e.native.shiftKey;r.some((function(e){if(e.graphic){var t=e.graphic;if(s&&i&&o&&"box"===o.type&&!o.isUIGraphic(t))return v.addToSelection(t),!0;if(o&&"box"===o.type&&o.isUIGraphic(t)){if(!1!==c&&1===g.updateGraphics.length){var r=g.updateGraphics.getItemAt(0).geometry;"extent"===h.get(r,"type")?g._logError("sketch:reshape-extent","Reshape operation does not support graphics with geometry of type 'extent'."):v.toggleTool()}return!0}if(o&&"reshape"===o.type){if(t===o.graphic)return!1!==c&&v.toggleTool(),!0;if(o.isUIGraphic(t))return!0;if(t.layer===g._internalGraphicsLayer)return!0}else t.layer===g.layer&&v.complete()}return!1}))&&e.stopPropagation()}else v.complete()}}))}),P.ViewEventPriorities.WIDGET),a.on("key-down",(function(e){if(g._getCommonUpdateOperationKeyDownHandlers(v,e),e.key===H.constraintKey&&!e.repeat&&v){var t=v.activeComponent;t&&"box"===t.type&&(t.preserveAspectRatio=!t.preserveAspectRatio)}}),P.ViewEventPriorities.WIDGET),a.on("key-up",(function(e){if(e.key===H.constraintKey&&v){var t=v.activeComponent;t&&"box"===t.type&&(t.preserveAspectRatio=!t.preserveAspectRatio)}}),P.ViewEventPriorities.WIDGET)],_=this._getHandlesForComponent(v,o),[2,v])}}))}))},c.prototype._getGraphicMover=function(t,o,i){return r.__awaiter(this,void 0,void 0,(function(){var a,n,s,p=this;return r.__generator(this,(function(r){switch(r.label){case 0:return a=o.enableMoveAllGraphics,n=void 0===a||a,[4,this._requireModule(new Promise((function(t,r){e(["../../views/draw/support/GraphicMover"],t,r)})))];case 1:return R(s=r.sent())?[2,s]:[2,new s.module({enableMoveAllGraphics:n,graphics:t,view:i,callbacks:{onGraphicMoveStart:function(e){var t=e.dx,r=e.dy,o=e.graphic;return p.emit("update",{graphics:p.updateGraphics.toArray(),state:"active",aborted:!1,tool:p.activeTool,toolEventInfo:{dx:t,dy:r,mover:o,type:"move-start"},type:"update"})},onGraphicMove:function(e){var t=e.dx,r=e.dy,o=e.graphic;return p.emit("update",{graphics:p.updateGraphics.toArray(),state:"active",aborted:!1,tool:p.activeTool,toolEventInfo:{dx:t,dy:r,mover:o,type:"move"},type:"update"})},onGraphicMoveStop:function(e){var t=e.dx,r=e.dy,o=e.graphic;return p.emit("update",{graphics:p.updateGraphics.toArray(),state:"active",aborted:!1,tool:p.activeTool,toolEventInfo:{dx:t,dy:r,mover:o,type:"move-stop"},type:"update"})},onGraphicPointerOver:function(){return p._displayDefaultCursor()},onGraphicPointerOut:function(){return p._displayDefaultCursor()}}})]}}))}))},c.prototype._getBox=function(t,o,i){return r.__awaiter(this,void 0,void 0,(function(){var a,n,s,p,c,l,d,h=this;return r.__generator(this,(function(u){switch(u.label){case 0:return a=o.enableRotation,n=void 0===a||a,s=o.enableScaling,p=void 0===s||s,c=o.preserveAspectRatio,l=void 0!==c&&c,[4,this._requireModule(new Promise((function(t,r){e(["../../views/draw/support/Box"],t,r)})))];case 1:return R(d=u.sent())?[2,d]:[2,new d.module({graphics:t,enableRotation:n,enableScaling:p,preserveAspectRatio:l,layer:this._internalGraphicsLayer,view:i,callbacks:{onMoveStart:function(e){return h.emit("update",{graphics:h.updateGraphics.toArray(),state:"active",aborted:!1,tool:h.activeTool,toolEventInfo:r.__assign({},e),type:"update"})},onMove:function(e){return h.emit("update",{graphics:h.updateGraphics.toArray(),state:"active",aborted:!1,tool:h.activeTool,toolEventInfo:r.__assign({},e),type:"update"})},onMoveStop:function(e){return h.emit("update",{graphics:h.updateGraphics.toArray(),state:"active",aborted:!1,tool:h.activeTool,toolEventInfo:r.__assign({},e),type:"update"})},onScaleStart:function(e){return h.emit("update",{graphics:h.updateGraphics.toArray(),state:"active",aborted:!1,tool:h.activeTool,toolEventInfo:r.__assign({},e),type:"update"})},onScale:function(e){return h.emit("update",{graphics:h.updateGraphics.toArray(),state:"active",aborted:!1,tool:h.activeTool,toolEventInfo:r.__assign({},e),type:"update"})},onScaleStop:function(e){return h.emit("update",{graphics:h.updateGraphics.toArray(),state:"active",aborted:!1,tool:h.activeTool,toolEventInfo:r.__assign({},e),type:"update"})},onRotateStart:function(e){return h.emit("update",{graphics:h.updateGraphics.toArray(),state:"active",aborted:!1,tool:h.activeTool,toolEventInfo:r.__assign({},e),type:"update"})},onRotate:function(e){return h.emit("update",{graphics:h.updateGraphics.toArray(),state:"active",aborted:!1,tool:h.activeTool,toolEventInfo:r.__assign({},e),type:"update"})},onRotateStop:function(e){return h.emit("update",{graphics:h.updateGraphics.toArray(),state:"active",aborted:!1,tool:h.activeTool,toolEventInfo:r.__assign({},e),type:"update"})}}})]}}))}))},c.prototype._getReshape=function(t,o,i){return r.__awaiter(this,void 0,void 0,(function(){var a,n,s,p=this;return r.__generator(this,(function(c){switch(c.label){case 0:return a=o.enableMidpoints,n=void 0===a||a,[4,this._requireModule(new Promise((function(t,r){e(["../../views/draw/support/Reshape"],t,r)})))];case 1:return R(s=c.sent())?[2,s]:[2,new s.module({enableMidpoints:n,graphic:t[0],layer:this._internalGraphicsLayer,view:i,callbacks:{onReshapeStart:function(e){return p.emit("update",{graphics:p.updateGraphics.toArray(),state:"active",aborted:!1,tool:p.activeTool,toolEventInfo:r.__assign({},e),type:"update"})},onReshape:function(e){return p.emit("update",{graphics:p.updateGraphics.toArray(),state:"active",aborted:!1,tool:p.activeTool,toolEventInfo:r.__assign({},e),type:"update"})},onReshapeStop:function(e){var t=e.mover,r=e.type;return p.emit("update",{graphics:p.updateGraphics.toArray(),state:"active",aborted:!1,tool:p.activeTool,toolEventInfo:{mover:t,type:r},type:"update"})},onMoveStart:function(e){var t=e.dx,r=e.dy,o=e.mover,i=e.type;return p.emit("update",{graphics:p.updateGraphics.toArray(),state:"active",aborted:!1,tool:p.activeTool,toolEventInfo:{dx:t,dy:r,mover:o,type:i},type:"update"})},onMove:function(e){var t=e.dx,r=e.dy,o=e.mover,i=e.type;return p.emit("update",{graphics:p.updateGraphics.toArray(),state:"active",aborted:!1,tool:p.activeTool,toolEventInfo:{dx:t,dy:r,mover:o,type:i},type:"update"})},onMoveStop:function(e){var t=e.dx,r=e.dy,o=e.mover,i=e.type;return p.emit("update",{graphics:p.updateGraphics.toArray(),state:"active",aborted:!1,tool:p.activeTool,toolEventInfo:{dx:t,dy:r,mover:o,type:i},type:"update"})},onVertexAdd:function(e){var t=e.added,r=e.type,o=e.vertices,i=t.map((function(e){return m.geometryToCoordinates(e.geometry)}));p.emit("update",{graphics:p.updateGraphics.toArray(),state:"active",aborted:!1,tool:p.activeTool,toolEventInfo:{added:i,vertices:o,type:r},type:"update"})},onVertexRemove:function(e){var t=e.removed,r=e.type,o=e.vertices,i=t.map((function(e){return m.geometryToCoordinates(e.geometry)}));p.emit("update",{graphics:p.updateGraphics.toArray(),state:"active",aborted:!1,tool:p.activeTool,toolEventInfo:{removed:i,vertices:o,type:r},type:"update"})}}})]}}))}))},c.prototype._getHandlesForComponent=function(e,t){var r=this,o=e.activeComponent;switch(o.type){case"graphic-mover":return[o.on("graphic-move-start",(function(t){return e.addToHistory(M(t.allGraphics))}))];case"box":return[o.on("move-start",(function(t){return e.addToHistory(M(t.graphics))})),o.on("rotate-start",(function(t){return e.addToHistory(M(t.graphics))})),o.on("scale-start",(function(t){return e.addToHistory(M(t.graphics))}))];case"reshape":return[o.on("move-start",(function(t){return e.addToHistory(M([t.mover]))})),o.on("reshape-start",(function(t){return e.addToHistory(M([t.graphic]))})),o.on("vertex-add",(function(t){return e.addToHistory(M([t.oldGraphic]))})),o.on("vertex-remove",(function(t){return e.addToHistory(M([t.oldGraphic]))}))];case"move-3d":return[o.on("graphic-move-start",(function(t){e.addToHistory(M(t.allGraphics)),r.emit("update",{graphics:r.updateGraphics.toArray(),state:"active",aborted:!1,tool:r.activeTool,toolEventInfo:{dx:0,dy:0,mover:t.allGraphics.length>0?t.allGraphics[0]:null,type:"move-start"},type:"update"})})),o.on("graphic-move",(function(e){r.emit("update",{graphics:r.updateGraphics.toArray(),state:"active",aborted:!1,tool:r.activeTool,toolEventInfo:{dx:e.dx,dy:e.dy,mover:e.allGraphics.length>0?e.allGraphics[0]:null,type:"move"},type:"update"})})),o.on("graphic-move-stop",(function(e){r.emit("update",{graphics:r.updateGraphics.toArray(),state:"active",aborted:!1,tool:r.activeTool,toolEventInfo:{dx:0,dy:0,mover:e.allGraphics.length>0?e.allGraphics[0]:null,type:"move-stop"},type:"update"})})),o.on("immediate-click",(function(o){o.shiftKey?r._toggleSelection([o.graphic],e,t):e.toggleTool()}))];case"transform-3d":return[o.on("graphic-translate-start",(function(t){e.addToHistory(M([t.graphic])),r.emit("update",{graphics:r.updateGraphics.toArray(),state:"active",aborted:!1,tool:r.activeTool,toolEventInfo:{mover:t.graphic,dx:t.dxScreen,dy:t.dyScreen,type:"move-start"},type:"update"})})),o.on("graphic-translate-stop",(function(e){r.emit("update",{graphics:r.updateGraphics.toArray(),state:"active",aborted:!1,tool:r.activeTool,toolEventInfo:{mover:e.graphic,dx:e.dxScreen,dy:e.dyScreen,type:"move-stop"},type:"update"})})),o.on("graphic-rotate-start",(function(t){e.addToHistory(D([t.graphic])),r.emit("update",{graphics:r.updateGraphics.toArray(),state:"active",aborted:!1,tool:r.activeTool,toolEventInfo:{mover:t.graphic,angle:t.angle,type:"rotate-start"},type:"update"})})),o.on("graphic-rotate-stop",(function(e){r.emit("update",{graphics:r.updateGraphics.toArray(),state:"active",aborted:!1,tool:r.activeTool,toolEventInfo:{mover:e.graphic,angle:e.angle,type:"rotate-stop"},type:"update"})})),o.on("graphic-scale-start",(function(t){e.addToHistory(D([t.graphic])),r.emit("update",{graphics:r.updateGraphics.toArray(),state:"active",aborted:!1,tool:r.activeTool,toolEventInfo:{mover:t.graphic,xScale:t.scale,yScale:t.scale,type:"scale-start"},type:"update"})})),o.on("graphic-scale-stop",(function(e){r.emit("update",{graphics:r.updateGraphics.toArray(),state:"active",aborted:!1,tool:r.activeTool,toolEventInfo:{mover:e.graphic,xScale:e.scale,yScale:e.scale,type:"scale-stop"},type:"update"})})),o.on("graphic-translate",(function(e){r.emit("update",{graphics:r.updateGraphics.toArray(),state:"active",aborted:!1,tool:r.activeTool,toolEventInfo:{mover:e.graphic,dx:e.dxScreen,dy:e.dyScreen,type:"move"},type:"update"})})),o.on("graphic-rotate",(function(e){r.emit("update",{graphics:r.updateGraphics.toArray(),state:"active",aborted:!1,tool:r.activeTool,toolEventInfo:{mover:e.graphic,angle:e.angle,type:"rotate"},type:"update"})})),o.on("graphic-scale",(function(e){r.emit("update",{graphics:r.updateGraphics.toArray(),state:"active",aborted:!1,tool:r.activeTool,toolEventInfo:{mover:e.graphic,xScale:e.scale,yScale:e.scale,type:"scale"},type:"update"})}))];case"reshape-3d":return[o.on("reshape",(function(t){"reshape-start"===t.type&&e.addToHistory(M([t.mover])),r.emit("update",{graphics:r.updateGraphics.toArray(),state:"active",aborted:!1,tool:r.activeTool,toolEventInfo:t,type:"update"})})),o.on("move",(function(t){"move-start"===t.type&&e.addToHistory(M([t.mover])),r.emit("update",{graphics:r.updateGraphics.toArray(),state:"active",aborted:!1,tool:r.activeTool,toolEventInfo:t,type:"update"})})),o.on("vertex-add",(function(e){r.emit("update",{graphics:r.updateGraphics.toArray(),state:"active",aborted:!1,tool:r.activeTool,toolEventInfo:e,type:"update"})})),o.on("vertex-remove",(function(e){r.emit("update",{graphics:r.updateGraphics.toArray(),state:"active",aborted:!1,tool:r.activeTool,toolEventInfo:e,type:"update"})})),o.on("immediate-click",(function(){return e.toggleTool()}))];case"draw":case"draw-3d":return null;default:return void s.neverReached(o)}},c.prototype._setUpdateOperationHandle=function(e){var t=this;this._operationHandle=e;var r=this.view.map;this._disablePopup();e.on("complete",(function(){if(e===t._operationHandle){var o=t.updateGraphics.toArray(),i=t._operationHandle.tool;t._operationHandle.destroy(),t._operationHandle=null,t._internalGraphicsLayer.removeMany(t.updateGraphics.toArray()),t.updateGraphics.removeAll(),r&&r.remove(t._internalGraphicsLayer),t._restorePopup(),t.emit("update",{graphics:o,state:"complete",aborted:e.cancelled,tool:i,toolEventInfo:null,type:"update"})}}))},c.prototype._getCommonUpdateOperationClickHandlers=function(e,t,r){var o=this,i=u.createScreenPointFromEvent(t);this._getFirstHit(i).then((function(i){var a=i.results;a.length?t.native.shiftKey&&o._toggleSelection(a.map((function(e){return e.graphic})),e,r)?t.stopPropagation():a.some((function(e){return e.graphic&&o.updateGraphics.indexOf(e.graphic)>-1}))?t.stopPropagation():e.complete():e.complete()}))},c.prototype._toggleSelection=function(e,t,r){var o=this,i=!r||!!r.multipleSelectionEnabled;return e.some((function(e){return null!=e&&(!(!i||e.layer!==o.layer)&&(-1===o.updateGraphics.indexOf(e)?t.addToSelection(e):t.removeFromSelection(e),!0))}))},c.prototype._getCommonUpdateOperationKeyDownHandlers=function(e,t){if(e){var r=t.key;r===H.undoKey&&e.canUndo()?(t.stopPropagation(),e.undo()):r===H.redoKey&&e.canRedo()?(t.stopPropagation(),e.redo()):r===H.cancelKey?(t.stopPropagation(),e.cancel()):H.deleteKeys.indexOf(r)>=0&&this._onDeleteKey(t)}},c.prototype._onDeleteKey=function(e){if(this._operationHandle&&"update"===this._operationHandle.type){var t=this.activeComponent;if(t&&"reshape"!==t.type&&"reshape-3d"!==t.type){e.stopPropagation();var r=this.updateGraphics.toArray();this.layer.removeMany(r),this._emitDeleteEvent({graphics:r,tool:this.activeTool})}}},c.prototype._getCreateSymbol=function(e,t){void 0===t&&(t=!1);var r="3d"!==this.view.type&&t;switch(e.type){case"point":case"multipoint":return r?this.activePointSymbol:this.pointSymbol;case"polyline":return r?this.activeLineSymbol:this.polylineSymbol;case"polygon":return r?this.activeFillSymbol:this.polygonSymbol}return null},c.prototype._getUpdateSymbol=function(e){if(h.isNone(e))return null;switch(e.type){case"point":case"multipoint":return this.updatePointSymbol;case"polyline":return this.updatePolylineSymbol;case"polygon":case"extent":return this.updatePolygonSymbol}return null},c.prototype._drawMultipointGraphic=function(e,t){var r=null;if(!t&&e.length>1){var o=e.slice(0);o.pop(),r=A.createMultipoint(o,this.view.spatialReference)}else r=A.createMultipoint(e,this.view.spatialReference);this.createGraphic?this.createGraphic.geometry=r:this._set("createGraphic",new i(r,this.pointSymbol)),t&&1===e.length&&this._internalGraphicsLayer.add(this.createGraphic)},c.prototype._drawVertexGraphics=function(e,t,r){var o=!(!r||!r.userClicked),a="polygon"===e,n=a?this.polygonSymbol:this.polylineSymbol;if(1===t.length){this._removeLineGraphic(),this._removeActiveLineGraphic();var s=this.createPointFromVertex(t[0]),p=a?A.createPolygon([t],this.view.spatialReference,this._doUnnormalization,!0):A.createPolyline([t],this.view.spatialReference,this._doUnnormalization);this._vertexGraphics.length?this._vertexGraphics[0].geometry=s:this._vertexGraphics.push(new i(s,this.activeVertexSymbol)),this.createGraphic?this.createGraphic.geometry=p:this._set("createGraphic",new i(p,n)),o&&this._internalGraphicsLayer.add(this._vertexGraphics[0])}else if(2===t.length){var c=this.createPointFromVertex(t[1]),l=this.vertexSymbol,d=A.createPolyline([t],this.view.spatialReference,this._doUnnormalization);p=a?A.createPolygon([t],this.view.spatialReference,this._doUnnormalization,!0):A.createPolyline([t],this.view.spatialReference,this._doUnnormalization);if(!this._vertexGraphics.length){s=this.createPointFromVertex(t[0]);var h=new i(s,l);this._vertexGraphics.push(h)}if(1===this._vertexGraphics.length){var u=this._vertexGraphics[0],y=new i(c,l);this._removeLineGraphic(),this._removeActiveFillGraphic(),this._vertexGraphics.push(y),this._internalGraphicsLayer.remove(u),this._internalGraphicsLayer.add(u)}else this._vertexGraphics[1].geometry=c;this._showActiveLineGraphic(d);var v=this._vertexGraphics[0];o&&(this._activeLineGraphic.symbol=this.polylineSymbol,v.symbol=this.vertexSymbol,this._internalGraphicsLayer.add(this._vertexGraphics[1])),this.createGraphic?this.createGraphic.geometry=p:this._set("createGraphic",new i(p,this.polygonSymbol)),this._internalGraphicsLayer.remove(v),this._internalGraphicsLayer.add(v)}else if(t.length>2){p=a?A.createPolygon([t],this.view.spatialReference,this._doUnnormalization,!0):A.createPolyline([t],this.view.spatialReference,this._doUnnormalization);"polygon"===e&&this._showFillGraphic(p);var m=t.map((function(e){return e.slice()})),_=m.pop(),g=[m[m.length-1],_],f=A.createPolyline([m],this.view.spatialReference,this._doUnnormalization),w=A.createPolyline([g],this.view.spatialReference,this._doUnnormalization);this._showLineGraphic(f),this._showActiveLineGraphic(w);for(var G=0;G<m.length;G++){var b=this._vertexGraphics[G];if(b)o||G!==this._vertexGraphics.length-1?b.symbol=this.vertexSymbol:b.symbol=this.activeVertexSymbol;else{var S=this.createPointFromVertex(t[G]);this._showVertexGraphic(S)}}if(o){this._activeLineGraphic.symbol=this.polylineSymbol;G=t.length-1,S=this.createPointFromVertex(t[G]);this._showVertexGraphic(S)}else this._activeLineGraphic.symbol=this.activeLineSymbol;this.createGraphic?this.createGraphic.geometry=p:(this._removeCreateGraphic(),this._set("createGraphic",new i(p,n)));for(var E=0,x=this._vertexGraphics;E<x.length;E++){h=x[E];this._internalGraphicsLayer.remove(h),this._internalGraphicsLayer.add(h)}}},c.prototype._drawSegmentGraphic=function(e,t,r,o){if(t.length){var a=!(!r||!r.centered),n=!(!r||!r.constrained),s=null;1===t.length?this._removeCenterIndicatorGraphic():("rectangle"===e?s=n?A.createSquare(t,o,a):A.createRectangle(t,o,a):"circle"===e&&(s=n?A.createEllipse(t,o,a):A.createCircle(t,o,a,this.view.resolution)),s.extent&&s.extent.center&&this._showCenterIndicatorGraphic(s.extent.center)),s?this.createGraphic?this.createGraphic.geometry=s:(this._removeCreateGraphic(),this._set("createGraphic",new i(s,this.polygonSymbol)),this._internalGraphicsLayer.add(this.createGraphic)):this._removeCreateGraphic()}},c.prototype._showCenterIndicatorGraphic=function(e){this._centerIndicatorGraphic?this._centerIndicatorGraphic.geometry=e:(this._centerIndicatorGraphic=new i(e,this._centerSymbol),this._internalGraphicsLayer.add(this._centerIndicatorGraphic))},c.prototype._removeCenterIndicatorGraphic=function(){this._centerIndicatorGraphic&&(this._internalGraphicsLayer.remove(this._centerIndicatorGraphic),this._centerIndicatorGraphic.destroy(),this._centerIndicatorGraphic=null)},c.prototype._showActiveLineGraphic=function(e){this._activeLineGraphic?this._activeLineGraphic.geometry=e:(this._activeLineGraphic=new i(e,this.activeLineSymbol),this._internalGraphicsLayer.graphics.add(this._activeLineGraphic,0))},c.prototype._showFillGraphic=function(e){this._activeFillGraphic?this._activeFillGraphic.geometry=e:(this._activeFillGraphic=new i(e,this._getCreateSymbol(e,!0)),this._internalGraphicsLayer.add(this._activeFillGraphic))},c.prototype._showLineGraphic=function(e){this._lineGraphic?this._lineGraphic.geometry=e:(this._lineGraphic=new i(e,this.polylineSymbol),this._internalGraphicsLayer.graphics.add(this._lineGraphic,0))},c.prototype._showVertexGraphic=function(e,t){var r=t?this.activeVertexSymbol:this.vertexSymbol,o=new i(e,r);this._vertexGraphics.push(o),this._internalGraphicsLayer.add(o)},c.prototype._resetCreateOperationGraphics=function(){this._removeActiveFillGraphic(),this._removeLineGraphic(),this._removeActiveLineGraphic(),this._removeVertexGraphics()},c.prototype._removeCreateGraphic=function(){this.createGraphic&&(this._internalGraphicsLayer.remove(this.createGraphic),this._set("createGraphic",null))},c.prototype._removeCreateOperationGraphics=function(){this._removeCenterIndicatorGraphic(),this._removeActiveLineGraphic(),this._removeActiveFillGraphic(),this._removeLineGraphic(),this._removeVertexGraphics()},c.prototype._removeActiveLineGraphic=function(){this._activeLineGraphic&&(this._internalGraphicsLayer.remove(this._activeLineGraphic),this._activeLineGraphic.destroy(),this._activeLineGraphic=null)},c.prototype._removeActiveFillGraphic=function(){this._activeFillGraphic&&(this._internalGraphicsLayer.remove(this._activeFillGraphic),this._activeFillGraphic.destroy(),this._activeFillGraphic=null)},c.prototype._removeLineGraphic=function(){this._lineGraphic&&(this._internalGraphicsLayer.remove(this._lineGraphic),this._lineGraphic.destroy(),this._lineGraphic=null)},c.prototype._removeVertexGraphics=function(){this._vertexGraphics.length&&(this._internalGraphicsLayer.removeMany(this._vertexGraphics),this._vertexGraphics.forEach((function(e){return e.destroy()})),this._vertexGraphics=[])},c.prototype._removeDefaultLayer=function(){this._internalGraphicsLayer&&(this.view&&this.view.map&&this.view.map.remove(this._internalGraphicsLayer),this._internalGraphicsLayer.destroy(),this._internalGraphicsLayer=null)},c.prototype._operationHandleForCreateAction=function(e,t,r){var o=this;return new O.OperationHandle({activeComponent:this._draw,tool:r,type:"create",onEnd:function(){t.forEach((function(e){return e.remove()})),t.length=0,o._removeCreateOperationGraphics(),o._internalGraphicsLayer&&o._internalGraphicsLayer.remove(o.createGraphic),o._displayDefaultCursor()},undo:function(){e.undo(),o._emitUndoEvent({graphics:[o.createGraphic],tool:r})},redo:function(){e.redo(),o._emitRedoEvent({graphics:[o.createGraphic],tool:r})},canUndo:function(){return e&&e.canUndo()},canRedo:function(){return e&&e.canRedo()},setSnapToScene:function(t){e.snapToScene=t}})},c.prototype._isComponentGraphic=function(e){var t=this.activeComponent;return!(!e||!t)&&(!(!e.attributes||!e.attributes.esriSketchTool)||("box"===t.type||"reshape"===t.type)&&t.isUIGraphic(e))},c.prototype._snap=function(e,t,r){r&&this._snapLastVertexToAxis(t),"polygon"===e&&this._snapLastPolygonVertexToFirst(t)},c.prototype._snapLastPolygonVertexToFirst=function(e){if(!(e.length<=2)){var t=e[0],r=e[e.length-1],i=this.view.toScreen(new o.Point(t[0],t[1],this.view.spatialReference)),a=this.view.toScreen(new o.Point(r[0],r[1],this.view.spatialReference));this._isWithinScreenDistance(i,a,this._getVertexIntersectDistance())&&(r[0]=t[0],r[1]=t[1])}},c.prototype._getVertexIntersectDistance=function(){return this.vertexSymbol&&"simple-marker"===this.vertexSymbol.type?u.pt2px(this.vertexSymbol.size)/2+3:3},c.prototype._isWithinScreenDistance=function(e,t,r){var o=e.x-t.x,i=e.y-t.y;return Math.sqrt(o*o+i*i)<=r},c.prototype._snapLastVertexToAxis=function(e){if(!(e.length<2)){var t=e.pop(),r=e[e.length-1],o=A.createViewAlignedCoordinateSystem(this.view,r),i=o.mapToLocal(r),a=o.mapToLocal(t),n=Math.abs(a.x-i.x),s=Math.abs(a.y-i.y),p=o.localToMap(A.makeSurfacePoint(n>s?a.x:i.x,n>s?i.y:a.y));e.push(p)}},c.prototype._displayCrosshairCursor=function(){this.view&&this.view.container&&"crosshair"!==this.view.cursor&&(this.view.cursor="crosshair")},c.prototype._displayDefaultCursor=function(){this.view&&this.view.container&&null!==this.view.cursor&&(this.view.cursor=null)},c.prototype._logError=function(e,t,r){k.error(new p(e,t,r))},c.prototype._requireModule=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,o;return r.__generator(this,(function(r){switch(r.label){case 0:return t=new AbortController,this._moduleLoaderAbortController=t,[4,e];case 1:return o=r.sent(),this._moduleLoaderAbortController!==t||t.signal.aborted?[2,{requireError:"aborted"}]:[2,{module:o}]}}))}))},c.prototype._emitUndoEvent=function(e){this.emit("undo",r.__assign(r.__assign({},e),{type:"undo"}))},c.prototype._emitRedoEvent=function(e){this.emit("redo",r.__assign(r.__assign({},e),{type:"redo"}))},c.prototype._emitDeleteEvent=function(e){this.emit("delete",r.__assign(r.__assign({},e),{type:"delete"}))},c.prototype.createPointFromVertex=function(e){return e.length>2?new o.Point(e[0],e[1],e[2],this.view.spatialReference):new o.Point(e[0],e[1],this.view.spatialReference)},c.prototype.test=function(){return this._operationHandle},c.prototype.wait=function(){return y.whenNotOnce(this,"updating")},c.prototype._beginAsyncOperation=function(){this._numUpdating+=1,this.notifyChange("updating")},c.prototype._endAsyncOperation=function(){this._numUpdating-=1,this.notifyChange("updating")},c.prototype._disablePopup=function(){var e=this.view.popup;e&&h.isNone(this._originalAutoOpenEnabled)&&(this._originalAutoOpenEnabled=e.autoOpenEnabled,e.autoOpenEnabled=!1)},c.prototype._restorePopup=function(){var e=this.view.popup;e&&h.isSome(this._originalAutoOpenEnabled)&&(e.autoOpenEnabled=this._originalAutoOpenEnabled,this._originalAutoOpenEnabled=null)},r.__decorate([v.property({dependsOn:["state"],readOnly:!0})],c.prototype,"_draw",null),r.__decorate([v.property()],c.prototype,"updating",null),r.__decorate([v.property()],c.prototype,"_operationHandle",void 0),r.__decorate([v.property({dependsOn:["_operationHandle","_operationHandle.tool"],readOnly:!0})],c.prototype,"activeTool",null),r.__decorate([v.property()],c.prototype,"activeFillSymbol",void 0),r.__decorate([v.property()],c.prototype,"activeLineSymbol",void 0),r.__decorate([v.property()],c.prototype,"activePointSymbol",void 0),r.__decorate([v.property()],c.prototype,"activeVertexSymbol",void 0),r.__decorate([v.property({readOnly:!0})],c.prototype,"createGraphic",void 0),r.__decorate([v.property()],c.prototype,"defaultCreateOptions",void 0),r.__decorate([v.property()],c.prototype,"defaultUpdateOptions",void 0),r.__decorate([v.property()],c.prototype,"layer",void 0),r.__decorate([v.property({types:a.symbolTypes})],c.prototype,"pointSymbol",void 0),r.__decorate([v.property({types:a.symbolTypes})],c.prototype,"polygonSymbol",void 0),r.__decorate([v.property({types:a.symbolTypes})],c.prototype,"polylineSymbol",void 0),r.__decorate([v.property({dependsOn:["view.ready","layer","_operationHandle"],readOnly:!0})],c.prototype,"state",null),r.__decorate([v.property({readOnly:!0})],c.prototype,"updateGraphics",void 0),r.__decorate([v.property()],c.prototype,"updateOnGraphicClick",void 0),r.__decorate([v.property({types:a.symbolTypes})],c.prototype,"updatePointSymbol",void 0),r.__decorate([v.property({types:a.symbolTypes})],c.prototype,"updatePolygonSymbol",void 0),r.__decorate([v.property({types:a.symbolTypes})],c.prototype,"updatePolylineSymbol",void 0),r.__decorate([v.property({types:a.symbolTypes})],c.prototype,"vertexSymbol",void 0),r.__decorate([v.property({value:null})],c.prototype,"view",null),r.__decorate([v.property()],c.prototype,"cancel",null),r.__decorate([v.property()],c.prototype,"complete",null),r.__decorate([v.property()],c.prototype,"delete",null),r.__decorate([v.property()],c.prototype,"create",null),r.__decorate([v.property()],c.prototype,"update",null),r.__decorate([v.property()],c.prototype,"undo",null),r.__decorate([v.property()],c.prototype,"redo",null),r.__decorate([v.property()],c.prototype,"canUndo",null),r.__decorate([v.property()],c.prototype,"canRedo",null),r.__decorate([v.property()],c.prototype,"toggleUpdateTool",null),r.__decorate([v.property({value:null})],c.prototype,"snapToScene",null),c=r.__decorate([v.subclass("esri.widgets.Sketch.SketchViewModel")],c)}(c.EventedAccessor))}));