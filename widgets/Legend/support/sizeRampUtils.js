// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../Color","../../../symbols","../../../core/promiseUtils","../../../renderers/support/numberUtils","../../../symbols/support/cimSymbolUtils","../../../symbols/support/utils","./utils","@dojo/framework/shim/Promise"],(function(e,r,n,t,l,i,s,o,a,u){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.getRampStops=r.REAL_WORLD_MIN_SIZE=r.REAL_WORLD_MAX_SIZE=void 0,r.REAL_WORLD_MAX_SIZE=30,r.REAL_WORLD_MIN_SIZE=12;var c=[255,255,255],m=[200,200,200],f=[128,128,128];function p(r,t,l,i){return n.__awaiter(this,void 0,void 0,(function(){var o,a,u,c,m;return n.__generator(this,(function(n){switch(n.label){case 0:return[4,new Promise((function(r,n){e(["../../../renderers/visualVariables/support/visualVariableUtils"],r,n)}))];case 1:if(o=n.sent().getSizeRangeAtScale(r,l,i),a=o&&function(e){for(var r=e.minSize,n=e.maxSize,t=(n-r)/4,l=[],i=0;i<5;i++)l.push(r+t*i);return l}(o),!o&&!a)return[2,void 0];u=a.map((function(e){return function(e,r,n){var t=n.minSize,l=n.maxSize,i=r.minDataValue,s=r.maxDataValue,o=null;if(e<=t)o=i;else if(e>=l)o=s;else{o=(e-t)/(l-t)*(s-i)+i}return o}(e,r,o)})),u=s.round(u),c=1,n.label=2;case 2:return c<u.length-1?[4,b(r,t,u[c],u[c-1],l,i)]:[3,5];case 3:(m=n.sent())&&(u[c]=m[0],a[c]=m[1]),n.label=4;case 4:return c++,[3,2];case 5:return[2,u]}}))}))}function b(e,r,t,l,i,o){return n.__awaiter(this,void 0,void 0,(function(){var a,u,c,m,f,p,b,h,d,v,_,S,g,w,L,z,E,R,D,M,V,I;return n.__generator(this,(function(n){switch(n.label){case 0:return[4,y(e,r,t,i,o)];case 1:return a=n.sent(),[4,y(e,r,l,i,o)];case 2:u=n.sent(),c=s.numDigits(t),m=c.fractional,f=20,p=c.integer,b=null,h=null,t>0&&t<1&&(b=Math.pow(10,m),t*=b,p=s.numDigits(t).integer),d=p-1,n.label=3;case 3:return d>=0?(v=Math.pow(10,d),_=Math.floor(t/v)*v,S=Math.ceil(t/v)*v,null!=b&&(_/=b,S/=b),g=(_+S)/2,I=s.round([_,g,S],{indexes:[1]}),g=I[1],[4,y(e,r,_,i,o)]):[3,8];case 4:return w=n.sent(),[4,y(e,r,S,i,o)];case 5:return L=n.sent(),[4,y(e,r,g,i,o)];case 6:if(z=n.sent(),E=s.percentChange(a,w,u,null),R=s.percentChange(a,L,u,null),D=s.percentChange(a,z,u,null),M=E.previous<=f,V=R.previous<=f,M&&V&&(E.previous<=R.previous?(M=!0,V=!1):(V=!0,M=!1)),M?h=[_,w]:V?h=[S,L]:D.previous<=f&&(h=[g,z]),h)return[3,8];n.label=7;case 7:return d--,[3,3];case 8:return[2,h]}}))}))}function y(r,t,l,i,s){return n.__awaiter(this,void 0,void 0,(function(){return n.__generator(this,(function(n){switch(n.label){case 0:return[4,new Promise((function(r,n){e(["../../../renderers/visualVariables/support/visualVariableUtils"],r,n)}))];case 1:return[2,(0,n.sent().getSize)(r,l,{scale:i,view:s,shape:"simple-marker"===t.type?t.style:null})]}}))}))}r.getRampStops=function(e,b,h,d,v,_){return n.__awaiter(this,void 0,void 0,(function(){var S,g,w,L,z,E,R,D,M,V,I,O,x,A,C,k,W=this;return n.__generator(this,(function(Z){switch(Z.label){case 0:return S=b.legendOptions,g=S&&S.customValues,w=function(e,r){var n=null,i=null;if("simple"===e.type)n=e.symbol;else if("class-breaks"===e.type){var s=e.classBreakInfos;n=s&&s[0]&&s[0].symbol,i=s.length>1}else if("unique-value"===e.type){s=e.uniqueValueInfos;n=s&&s[0]&&s[0].symbol,i=s.length>1}if(!n||function(e){if(e){return l.isSymbol3D(e)?!!e.symbolLayers&&e.symbolLayers.some((function(e){return e&&"fill"===e.type})):-1!==e.type.indexOf("fill")}return!1}(n))return null;n=n.clone(),(r||i)&&(n.type.indexOf("3d")>-1?function(e){a.isVolumetricSymbol(e)||("line-3d"===e.type?e.symbolLayers.forEach((function(e){e.material={color:f}})):e.symbolLayers.forEach((function(e){"icon"!==e.type||e.resource&&e.resource.href?e.material={color:m}:(e.material={color:c},e.outline={color:f,size:1.5})})))}(n):function(e){"cim"===e.type?o.applyCIMSymbolColor(e,new t(m)):-1!==e.type.indexOf("line")?e.color=f:(e.color=c,"simple-marker"===e.type&&(e.outline={color:f,width:1.5}))}(n));return n}(e,h),L=!!w,z=!!g,E=null!=b.minSize&&null!=b.maxSize,R=b.stops&&b.stops.length>1,D=!!b.target,L&&(z||E||R&&!D)?(M=a.isVolumetricSymbol(w),V=null,I=null,O=null,!M||R?[3,1]:(I=s.round([b.minDataValue,b.maxDataValue]),[3,4])):[2,void 0];case 1:return(x=g)?[3,3]:[4,p(b,w,d,v)];case 2:x=Z.sent(),Z.label=3;case 3:I=x,Z.label=4;case 4:return!I&&R&&(I=b.stops.map((function(e){return e.value})),(V=b.stops.some((function(e){return!!e.label})))&&(O=b.stops.map((function(e){return e.label})))),M&&I&&I.length>2&&(I=[I[0],I[I.length-1]]),I?(A=[r.REAL_WORLD_MIN_SIZE,r.REAL_WORLD_MAX_SIZE],C=a.getSymbolOutlineSize(w),k=V?null:function(e,r){var n=e.length-1;return e.map((function(e,t){return u.createStopLabel(e,t,n,r)}))}(I,_),[4,i.all(I.map((function(e,r){return n.__awaiter(W,void 0,void 0,(function(){var t,i,s,o;return n.__generator(this,(function(n){switch(n.label){case 0:return M?(s=A[r],[3,3]):[3,1];case 1:return[4,y(b,w,e,d,v)];case 2:s=n.sent(),n.label=3;case 3:return i=function(e,r){var n=e.clone();if(l.isSymbol3D(n))a.isVolumetricSymbol(n)||n.symbolLayers.forEach((function(e){"fill"!==e.type&&(e.size=r)}));else if("esri.symbols.SimpleMarkerSymbol"===n.declaredClass)n.size=r;else if(function(e){return"esri.symbols.PictureMarkerSymbol"===e.declaredClass}(n)){var t=n.width,i=n.height;n.height=r,n.width=r*(t/i)}else!function(e){return"esri.symbols.SimpleLineSymbol"===e.declaredClass}(n)?function(e){return"esri.symbols.TextSymbol"===e.declaredClass}(n)&&n.font&&(n.font.size=r):n.width=r;return n}(w,t=s),o=V?O[r]:k[r],[2,{value:e,symbol:i,label:o,size:t,outlineSize:C}]}}))}))})))]):[2,null];case 5:return[2,Z.sent().reverse()]}}))}))}}));