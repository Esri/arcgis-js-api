/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["require","exports","../../../core/promiseUtils","../../../Color","../../../chunks/symbols","../../../symbols/support/cimSymbolUtils","../../../symbols/support/utils","../../../renderers/support/numberUtils","./utils"],(function(e,l,t,n,s,i,o,r,a){"use strict";const u=[255,255,255],c=[200,200,200],m=[128,128,128];function p(e){o.isVolumetricSymbol(e)||("line-3d"===e.type?e.symbolLayers.forEach((e=>{e.material={color:m}})):e.symbolLayers.forEach((e=>{"icon"!==e.type||e.resource&&e.resource.href?e.material={color:c}:(e.material={color:u},e.outline={color:m,size:1.5})})))}function y(e){"cim"===e.type?i.applyCIMSymbolColor(e,new n(c)):-1!==e.type.indexOf("line")?e.color=m:(e.color=u,"simple-marker"===e.type&&(e.outline={color:m,width:1.5}))}async function f(e,l,t,n,s,i){const o=await b(e,l,t,s,i),a=await b(e,l,n,s,i),u=r.numDigits(t),c=u.fractional;let m=u.integer,p=null,y=null;t>0&&t<1&&(p=Math.pow(10,c),t*=p,m=r.numDigits(t).integer);for(let n=m-1;n>=0;n--){const u=Math.pow(10,n);let c=Math.floor(t/u)*u,m=Math.ceil(t/u)*u;null!=p&&(c/=p,m/=p);let f=(c+m)/2;[,f]=r.round([c,f,m],{indexes:[1]});const d=await b(e,l,c,s,i),h=await b(e,l,m,s,i),S=await b(e,l,f,s,i),g=r.percentChange(o,d,a,null),v=r.percentChange(o,h,a,null),w=r.percentChange(o,S,a,null);let z=g.previous<=20,V=v.previous<=20;if(z&&V&&(g.previous<=v.previous?(z=!0,V=!1):(V=!0,z=!1)),z?y=[c,d]:V?y=[m,h]:w.previous<=20&&(y=[f,S]),y)break}return y}async function b(l,t,n,s,i){const{getSize:o}=await new Promise((function(l,t){e(["../../../renderers/visualVariables/support/visualVariableUtils"],l,t)}));return o(l,n,{scale:s,view:i,shape:"simple-marker"===t.type?t.style:null})}l.REAL_WORLD_MAX_SIZE=30,l.REAL_WORLD_MIN_SIZE=12,l.getRampStops=async function(l,n,i,u,c,m){const d=n.legendOptions,h=d&&d.customValues,S=function(e,l){let t=null,n=null;if("simple"===e.type)t=e.symbol;else if("class-breaks"===e.type){const l=e.classBreakInfos;t=l&&l[0]&&l[0].symbol,n=l.length>1}else if("unique-value"===e.type){const l=e.uniqueValueInfos;t=l&&l[0]&&l[0].symbol,n=l.length>1}if(!t||function(e){if(e){if(s.isSymbol3D(e)){return!!e.symbolLayers&&e.symbolLayers.some((e=>e&&"fill"===e.type))}return-1!==e.type.indexOf("fill")}return!1}(t))return null;t=t.clone(),(l||n)&&(t.type.indexOf("3d")>-1?p(t):y(t));return t}(l,i),g=!!S,v=!!h,w=null!=n.minSize&&null!=n.maxSize,z=n.stops&&n.stops.length>1,V=!!n.target;if(!g||!v&&!(w||z&&!V))return;const x=o.isVolumetricSymbol(S);let L=null,k=null,C=null;k=x&&!z?r.round([n.minDataValue,n.maxDataValue]):h||await async function(l,t,n,s){const i=(await new Promise((function(l,t){e(["../../../renderers/visualVariables/support/visualVariableUtils"],l,t)}))).getSizeRangeAtScale(l,n,s),o=i&&function(e){const l=e.minSize,t=e.maxSize,n=5,s=(t-l)/(n-1),i=[];for(let e=0;e<n;e++)i.push(l+s*e);return i}(i);if(!i&&!o)return;let a=o.map((e=>function(e,l,t){const n=t.minSize,s=t.maxSize,i=l.minDataValue,o=l.maxDataValue;let r=null;if(e<=n)r=i;else if(e>=s)r=o;else{r=(e-n)/(s-n)*(o-i)+i}return r}(e,l,i)));a=r.round(a);for(let e=1;e<a.length-1;e++){const i=await f(l,t,a[e],a[e-1],n,s);i&&(a[e]=i[0],o[e]=i[1])}return a}(n,S,u,c);const D=null==l?void 0:l.authoringInfo,M="univariate-color-size"===(null==D?void 0:D.type)&&"above-and-below"===(null==D?void 0:D.univariateTheme);if(!k&&z&&(k=M?a.getUnivariateAboveAndBelowStopValues(n,D):n.stops.map((e=>e.value)),L=n.stops.some((e=>!!e.label)),L&&(C=n.stops.map((e=>e.label)))),x&&k&&k.length>2&&(k=[k[0],k[k.length-1]]),!k)return null;const O=[12,30],I=o.getSymbolOutlineSize(S),_=L?null:function(e,l){const t=e.length-1;return e.map(((e,n)=>a.createStopLabel(e,n,t,l)))}(k,m);return(await t.all(k.map((async(e,t)=>{const i=x?O[t]:await b(n,S,e,u,c);return{value:e,symbol:function(e,l){const t=e.clone();if(s.isSymbol3D(t))o.isVolumetricSymbol(t)||t.symbolLayers.forEach((e=>{"fill"!==e.type&&(e.size=l)}));else if("esri.symbols.SimpleMarkerSymbol"===t.declaredClass)t.size=l;else if(function(e){return"esri.symbols.PictureMarkerSymbol"===e.declaredClass}(t)){const e=t.width,n=t.height;t.height=l,t.width=l*(e/n)}else!function(e){return"esri.symbols.SimpleLineSymbol"===e.declaredClass}(t)?function(e){return"esri.symbols.TextSymbol"===e.declaredClass}(t)&&t.font&&(t.font.size=l):t.width=l;return t}(M&&"class-breaks"===l.type?function(e,l){const t=e.classBreakInfos,n=t.length,s=l>=2,i=n<2||!s?t[0].symbol.clone():t[n-1].symbol.clone();e.visualVariables.some((e=>"color"===e.type))&&(i.type.indexOf("3d")>-1?p(i):y(i));return i}(l,t):S,i),label:L?C[t]:_[t],size:i,outlineSize:I}})))).reverse()},Object.defineProperty(l,"__esModule",{value:!0})}));
