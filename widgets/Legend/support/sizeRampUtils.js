/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["require","exports","../../../chunks/_rollupPluginBabelHelpers","../../../Color","../../../symbols","../../../renderers/support/numberUtils","../../../symbols/support/cimSymbolUtils","../../../symbols/support/utils","./utils"],(function(e,l,n,t,i,o,r,s,u){"use strict";const a=30,c=12,p=[255,255,255],y=[200,200,200],m=[128,128,128],f=20,d=5;function b(e){return"esri.symbols.SimpleMarkerSymbol"===e.declaredClass}function h(e){return"esri.symbols.PictureMarkerSymbol"===e.declaredClass}function v(e){return"esri.symbols.SimpleLineSymbol"===e.declaredClass}function g(e){return"esri.symbols.TextSymbol"===e.declaredClass}function S(e,l){const n=e.length-1;return e.map(((e,t)=>u.createStopLabel(e,t,n,l)))}function z(e,l,n,t,i,o){return _.apply(this,arguments)}function _(){return _=n._asyncToGenerator((function*(e,l,t,i,r,u){var a,c;const p=l.legendOptions,y=p&&p.customValues,m=L(e,t),f=!!m,d=!!y,b=null!=l.minSize&&null!=l.maxSize,h=l.stops&&l.stops.length>1,v=!!l.target;if(!f||!d&&!(b||h&&!v))return;const g=s.isVolumetricSymbol(m);let z=null,_=null,k=null;_=g&&!h?o.round([l.minDataValue,l.maxDataValue]):y||(yield D(l,m,i,r));const w=null==e?void 0:e.authoringInfo,C="univariate-color-size"===(null==w?void 0:w.type),I=C&&"above-and-below"===(null==w?void 0:w.univariateTheme);if(!_&&h&&(_=l.stops.map((e=>e.value)),z=l.stops.some((e=>!!e.label)),z&&(k=l.stops.map((e=>e.label)))),g&&(null==(a=_)?void 0:a.length)>2&&!I&&(_=[_[0],_[_.length-1]]),!_)return null;C&&5!==(null==(c=_)?void 0:c.length)&&(_=O({minSize:_[0],maxSize:_[_.length-1]}));const M=g?x(e,_):null,T=s.getSymbolOutlineSize(m),E=z?null:S(_,u),R=yield Promise.all(_.map(function(){var t=n._asyncToGenerator((function*(n,t){const o=g?M[t]:yield P(l,m,n,i,r);return{value:n,symbol:G(I&&"class-breaks"===e.type?V(e,t):m,o),label:z?k[t]:E[t],size:o,outlineSize:T}}));return function(e,l){return t.apply(this,arguments)}}()));return R.reverse()})),_.apply(this,arguments)}function x(e,l){const n=null==e?void 0:e.authoringInfo,t="univariate-color-size"===(null==n?void 0:n.type);let i=[c,a];if(t){const e=l[0],n=l[l.length-1],t=c,o=a;i=l.map((l=>t+(l-e)/(n-e)*(o-t)))}return t&&"below"===(null==n?void 0:n.univariateTheme)&&i.reverse(),i}function V(e,l){const n=e.classBreakInfos,t=n.length,i=t<2||!(l>=2)?n[0].symbol.clone():n[t-1].symbol.clone();return e.visualVariables.some((e=>"color"===e.type))&&(i.type.indexOf("3d")>-1?w(i):C(i)),i}function L(e,l){let n=null,t=null;if("simple"===e.type)n=e.symbol;else if("class-breaks"===e.type){const l=e.classBreakInfos;n=l&&l[0]&&l[0].symbol,t=l.length>1}else if("unique-value"===e.type){const l=e.uniqueValueInfos;n=l&&l[0]&&l[0].symbol,t=l.length>1}return!n||k(n)?null:(n=n.clone(),(l||t)&&(n.type.indexOf("3d")>-1?w(n):C(n)),n)}function k(e){if(e){if(i.isSymbol3D(e)){return!!e.symbolLayers&&e.symbolLayers.some((e=>e&&"fill"===e.type))}return-1!==e.type.indexOf("fill")}return!1}function w(e){"line-3d"===e.type?e.symbolLayers.forEach((e=>{e.material={color:m}})):e.symbolLayers.forEach((e=>{"icon"!==e.type||e.resource&&e.resource.href?e.material={color:y}:(e.material={color:p},e.outline={color:m,size:1.5})}))}function C(e){"cim"===e.type?r.applyCIMSymbolColor(e,new t(y)):-1!==e.type.indexOf("line")?e.color=m:(e.color=p,"simple-marker"===e.type&&(e.outline={color:m,width:1.5}))}function D(e,l,n,t){return I.apply(this,arguments)}function I(){return(I=n._asyncToGenerator((function*(l,n,t,i){const r=(yield new Promise((function(l,n){e(["../../../renderers/visualVariables/support/visualVariableUtils"],l,n)}))).getSizeRangeAtScale(l,t,i),s=r&&O(r);if(!r&&!s)return;let u=s.map((e=>M(e,l,r)));u=o.round(u);for(let e=1;e<u.length-1;e++){const o=yield T(l,n,u[e],u[e-1],t,i);o&&(u[e]=o[0],s[e]=o[1])}return u}))).apply(this,arguments)}function O(e){const l=e.minSize,n=e.maxSize,t=d,i=(n-l)/(t-1),o=[];for(let r=0;r<t;r++)o.push(l+i*r);return o}function M(e,l,n){const t=n.minSize,i=n.maxSize,o=l.minDataValue,r=l.maxDataValue;let s=null;if(e<=t)s=o;else if(e>=i)s=r;else{s=(e-t)/(i-t)*(r-o)+o}return s}function T(e,l,n,t,i,o){return E.apply(this,arguments)}function E(){return(E=n._asyncToGenerator((function*(e,l,n,t,i,r){const s=yield P(e,l,n,i,r),u=yield P(e,l,t,i,r),a=o.numDigits(n),c=a.fractional,p=f;let y=a.integer,m=null,d=null;n>0&&n<1&&(m=10**c,n*=m,y=o.numDigits(n).integer);for(let f=y-1;f>=0;f--){const t=10**f;let a=Math.floor(n/t)*t,c=Math.ceil(n/t)*t;null!=m&&(a/=m,c/=m);let y=(a+c)/2;[,y]=o.round([a,y,c],{indexes:[1]});const b=yield P(e,l,a,i,r),h=yield P(e,l,c,i,r),v=yield P(e,l,y,i,r),g=o.percentChange(s,b,u,null),S=o.percentChange(s,h,u,null),z=o.percentChange(s,v,u,null);let _=g.previous<=p,x=S.previous<=p;if(_&&x&&(g.previous<=S.previous?(_=!0,x=!1):(x=!0,_=!1)),_?d=[a,b]:x?d=[c,h]:z.previous<=p&&(d=[y,v]),d)break}return d}))).apply(this,arguments)}function P(e,l,n,t,i){return R.apply(this,arguments)}function R(){return(R=n._asyncToGenerator((function*(l,n,t,i,o){const{getSize:r}=yield new Promise((function(l,n){e(["../../../renderers/visualVariables/support/visualVariableUtils"],l,n)}));return r(l,t,{scale:i,view:o,shape:"simple-marker"===n.type?n.style:null})}))).apply(this,arguments)}function G(e,l){const n=e.clone();if(i.isSymbol3D(n))s.isVolumetricSymbol(n)||n.symbolLayers.forEach((e=>{"fill"!==e.type&&(e.size=l)}));else if(b(n))n.size=l;else if(h(n)){const e=n.width,t=n.height;n.height=l,n.width=l*(e/t)}else v(n)?n.width=l:g(n)&&n.font&&(n.font.size=l);return n}l.REAL_WORLD_MAX_SIZE=a,l.REAL_WORLD_MIN_SIZE=c,l.getRampStops=z,Object.defineProperty(l,"__esModule",{value:!0})}));
