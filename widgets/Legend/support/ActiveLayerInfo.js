// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../Color","../../../request","../../../symbols","../../../core/Accessor","../../../core/addTokenParameter","../../../core/arrayUtils","../../../core/Collection","../../../core/Handles","../../../core/jsonMap","../../../core/Logger","../../../core/maybe","../../../core/promiseUtils","../../../core/screenUtils","../../../core/urlUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators","../../../layers/support/ExportImageParameters","../../../layers/support/fieldUtils","../../../renderers/support/jsonUtils","../../../renderers/visualVariables/support/SizeVariableLegendOptions","../../../symbols/support/cimSymbolUtils","../../../symbols/support/symbolUtils","../../../symbols/support/utils","./clusterUtils","./colorRampUtils","./heatmapRampUtils","./relationshipRampUtils","./sizeRampUtils","./utils","@dojo/framework/shim/Promise"],(function(e,t,r,n,i,l,a,s,o,u,c,d,y,p,h,f,m,b,g,_,v,S,w,L,E,R,C,I,F,T,V,z){"use strict";var M=y.getLogger("esri.widgets.Legend.support.ActiveLayerInfo"),O=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i,x=new d.default({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"}),P={u1:[0,1],u2:[0,3],u4:[0,15],u8:[0,255],s8:[-128,127],u16:[0,65535],s16:[-32768,32767],u32:[0,4294967295],s32:[-2147483648,2147483647],f32:[-34e38,34e38],f64:[-Number.MAX_VALUE,Number.MAX_VALUE]},D=new l.SimpleMarkerSymbol({size:6,outline:{color:[128,128,128,.5],width:.5}}),A=new l.SimpleFillSymbol({style:"solid"});function k(e){return"vector-field"===e.type}function B(e){return"raster-colormap"===e.type}function U(e){return"raster-stretch"===e.type}function N(e){return"raster-shaded-relief"===e.type}function W(e){return"esri.renderers.SimpleRenderer"===e.declaredClass}function j(e){return"esri.renderers.ClassBreaksRenderer"===e.declaredClass}function q(e){return"esri.renderers.UniqueValueRenderer"===e.declaredClass}function G(e){return"esri.renderers.HeatmapRenderer"===e.declaredClass}function H(e){return"esri.renderers.PointCloudClassBreaksRenderer"===e.declaredClass}function J(e){return"esri.renderers.PointCloudStretchRenderer"===e.declaredClass}function X(e){return"esri.renderers.PointCloudUniqueValueRenderer"===e.declaredClass}function $(e){return"esri.renderers.DotDensityRenderer"===e.declaredClass}function Z(e){return"esri.layers.BuildingSceneLayer"===e.declaredClass}function Q(e){return"esri.layers.MapImageLayer"===e.declaredClass}function K(e){return"esri.layers.ImageryLayer"===e.declaredClass}function Y(e){return"esri.layers.WCSLayer"===e.declaredClass}var ee=new l.SimpleMarkerSymbol({style:"path",path:"M10,5 L5,0 0,5 M5,0 L5,15",size:15,outline:{width:1,color:[85,85,85,1]}}),te={};return function(t){function a(e){var r=t.call(this,e)||this;return r._handles=new c,r._hasColorRamp=!1,r._hasOpacityRamp=!1,r._hasSizeRamp=!1,r._webStyleSymbolCache=new Map,r._dotDensityUrlCache=new Map,r._scaleDrivenSizeVariable=null,r._hasClusterSizeVariable=!1,r.children=new u,r.layerView=null,r.layer=null,r.legendElements=[],r.parent=null,r.keepCacheOnDestroy=!1,r.respectLayerVisibility=!0,r.sublayerIds=[],r.title=null,r.view=null,r}return r.__extends(a,t),a.prototype.initialize=function(){var e=this,t=function(){return e.notifyChange("ready")};this._handles.add([b.on(this,"children","change",(function(r){var n=r.added,i=r.removed,l=e._handles;n.map((function(e){var r="activeLayerInfo-ready-watcher-"+e.layer.uid;l.add(b.init(e,"ready",t),r)})),i.forEach((function(e){return l.remove(e.layer.uid)})),t()}))]),this.keepCacheOnDestroy||(te={})},a.prototype.destroy=function(){this._handles.destroy(),this._handles=null,this._webStyleSymbolCache=null,this._dotDensityUrlCache=null,this._scaleDrivenSizeVariable=null,this.keepCacheOnDestroy||(te=null)},Object.defineProperty(a.prototype,"opacity",{get:function(){var e,t=this.layer.opacity,r=null===(e=this.parent)||void 0===e?void 0:e.opacity,n=this.layer.parent,i=n&&"uid"in n?this._getParentLayerOpacity(n):null;return null!=r?r*t:null!=i?i*t:t},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"ready",{get:function(){return null===this.layer||(this.children.length>0?this._isGroupActive():this.legendElements.length>0)},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"scale",{get:function(){return this.view&&this.view.scale},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"isScaleDriven",{get:function(){var e=this,t=this.layer;if(null===t)return!1;if("featureReduction"in t&&t.featureReduction&&"cluster"===t.featureReduction.type)return!0;if("renderer"in t&&t.renderer){if("dot-density"===t.renderer.type)return!0;var r=t.get("renderer.valueExpression");if(O.test(r))return!0;var n=t.get("renderer.visualVariables");if(n)return n.some((function(t){return e._isScaleDrivenSizeVariable(t)}))}return this._isLayerScaleDriven(this.layer)},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"version",{get:function(){return this._get("version")+1},enumerable:!1,configurable:!0}),a.prototype.buildLegendElementsForFeatureCollections=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n=this;return r.__generator(this,(function(r){return this.legendElements=[],t=e.map((function(e){if("esri.layers.FeatureLayer"===e.declaredClass)return n._buildRendererLegendElements(e.renderer,{title:e.title,mode:0});if(e.featureSet&&e.featureSet.features.length){var t=e.layerDefinition,r=t&&t.drawingInfo,i=r&&S.fromJSON(r.renderer),l=x.read(t.geometryType);return i?n._buildRendererLegendElements(i,{title:e.name,mode:0,geometryType:l}):(M.warn("drawingInfo not available!"),null)}return null})),[2,h.eachAlways(t).then((function(){}))]}))}))},a.prototype.buildLegendElementsForRenderer=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){return[2,this._buildRendererLegendElements(e)]}))}))},a.prototype.buildLegendElementsForTools=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t=this;return r.__generator(this,(function(r){switch(r.label){case 0:return function(e){return"esri.layers.WMTSLayer"===e.declaredClass}(e=this.layer)?(this._constructLegendElementsForWMTSlayer(),[3,8]):[3,1];case 1:return function(e){return"esri.layers.WMSLayer"===e.declaredClass}(e)?(this._constructLegendElementsForWMSSublayers(),[3,8]):[3,2];case 2:return Z(e)?[4,this._constructLegendElementsForBuildingSceneLayer()]:[3,4];case 3:return r.sent(),[3,8];case 4:return Q(e)||function(e){return"esri.layers.TileLayer"===e.declaredClass}(e)||Z(e)?[4,this._constructLegendElementsForSublayers()]:[3,6];case 5:return r.sent(),[3,8];case 6:return this._handles.remove("imageryLayers-watcher"),[4,this._getLegendLayers().then((function(r){t.legendElements=[],r.forEach((function(r){if(K(e)){var n=e.watch("renderingRule, bandIds",(function(){te.default=null,t.buildLegendElementsForTools()}));t._handles.add(n,"imageryLayers-watcher")}var i=t._generateSymbolTableElementForLegendLayer(r);i&&i.infos.length&&(K(e)&&(i.title=e.title),t.legendElements.push(i)),t.notifyChange("ready")})),t.notifyChange("ready")})).catch((function(e){M.warn("Request to server for legend has failed!",e)}))];case 7:r.sent(),r.label=8;case 8:return[2]}}))}))},a.prototype._getParentLayerOpacity=function(e){var t=1,r=e.parent;return r&&"uid"in r&&(t=this._getParentLayerOpacity(r)),e.opacity*t},a.prototype._isGroupActive=function(){var e=this.children;return!!e.length&&e.some((function(e){return e.ready}))},a.prototype._isScaleDrivenSizeVariable=function(e){if(e&&"size"!==e.type)return!1;var t=e,r=t.minSize,n=t.maxSize;return"object"==typeof r&&r?this._isScaleDrivenSizeVariable(r):"object"==typeof n&&n?this._isScaleDrivenSizeVariable(n):!!t.expression||O.test(t.valueExpression)},a.prototype._isLayerScaleDriven=function(e){var t=this;if("minScale"in e&&e.minScale>0||"maxScale"in e&&e.maxScale>0)return!0;if("sublayers"in e&&e.sublayers)return e.sublayers.some((function(e){return t._isLayerScaleDriven(e)}));var r=e.parent;if(!1===e.loaded&&r&&Q(r)&&"source"in e&&e.source&&"map-layer"===e.source.type)for(var n=0,i=r.sourceJSON.layers;n<i.length;n++){var l=i[n];if(l.id===e.source.mapLayerId&&(l.minScale>0||l.maxScale>0))return!0}return!1},a.prototype._buildRendererLegendElements=function(e,t){return void 0===t&&(t={}),r.__awaiter(this,void 0,void 0,(function(){var n,i;return r.__generator(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,this._getRendererLegendElements(e,{title:t.title,geometryType:t.geometryType})];case 1:return n=r.sent(),0===t.mode?Array.prototype.push.apply(this.legendElements,n):this.legendElements=n,this.notifyChange("ready"),[3,3];case 2:return i=r.sent(),M.warn("error while building legend for layer!",i),[3,3];case 3:return[2]}}))}))},a.prototype._constructLegendElementsForWMTSlayer=function(){var e=this;this.legendElements=[],this._handles.remove("wmts-activeLayer-watcher");var t=this.layer.activeLayer;if(this._handles.add(b.watch(this.layer,"activeLayer",(function(){return e._constructLegendElementsForWMTSlayer()})),"wmts-activeLayer-watcher"),t.styleId&&t.styles){var r=null;t.styles.some((function(e){return t.styleId===e.id&&(r=e.legendUrl,!0)})),r&&(this.legendElements=[{type:"symbol-table",title:t.title,infos:[{src:r,opacity:this.opacity}]}])}this.notifyChange("ready")},a.prototype._constructLegendElementsForWMSSublayers=function(){var e=this;this.legendElements=[],this._handles.remove("wms-sublayers-watcher");var t=this.layer,n=null;(t.customParameters||t.customLayerParameters)&&(n=r.__assign(r.__assign({},t.customParameters),t.customLayerParameters)),this._handles.add(b.watch(this.layer,"sublayers",(function(){return e._constructLegendElementsForWMSSublayers()})),"wms-sublayers-watcher"),this.legendElements=this._generateLegendElementsForWMSSublayers(t.sublayers,n),this.notifyChange("ready")},a.prototype._generateLegendElementsForWMSSublayers=function(e,t){var r=this,n=[];return this._handles.add(e.on("change",(function(){return r._constructLegendElementsForWMSSublayers()})),"wms-sublayers-watcher"),e.forEach((function(e){var i=e.watch("title, visible, legendEnabled",(function(){return r._constructLegendElementsForWMSSublayers()}));if(r._handles.add(i,"wms-sublayers-watcher"),e.visible&&e.legendEnabled){var l=r._generateSymbolTableElementForWMSSublayer(e,t);l&&l.infos.length&&n.unshift(l)}})),n},a.prototype._generateSymbolTableElementForWMSSublayer=function(e,t){if(!e.legendUrl&&e.sublayers){var r=this._generateLegendElementsForWMSSublayers(e.sublayers,t).filter((function(e){return e}));return{type:"symbol-table",title:e.title,infos:r}}return this._generateSymbolTableElementForLegendUrl(e,t)},a.prototype._generateSymbolTableElementForLegendUrl=function(e,t){var r=e.legendUrl;if(r){var n={type:"symbol-table",title:e.title||e.name||e.id&&e.id+"",infos:[]};return t&&(r+="?"+m.objectToQuery(t)),n.infos.push({src:r,opacity:e.layer&&e.layer.opacity}),n}},a.prototype._getLegendLayers=function(e){var t=e&&e.hasDynamicLayers?e.dynamicLayers:null,r=t||"default",n=te&&te[r];return n?h.resolve(n):this._legendRequest(t).then((function(e){var t=e.layers;return te[r]=t,t}))},a.prototype._legendRequest=function(e){var t=this.layer,n={f:"json",dynamicLayers:e};if(K(t)){var l=t.exportImageServiceParameters.renderingRule;if(l&&(n.renderingRule=JSON.stringify(l.toJSON())),t.bandIds&&(n.bandIds=t.bandIds.join()),t.raster||t.viewId){var a=t.raster,s=t.viewId;n=r.__assign({raster:a,viewId:s},n)}}var o=t.url.replace(/(\/)+$/,"");if("version"in t&&t.version>=10.01){var u=o.indexOf("?");u>-1?o=o.substring(0,u)+"/legend"+o.substring(u):o+="/legend"}else{var c=o.toLowerCase().indexOf("/rest/"),d=o.substring(0,c)+o.substring(c+5,o.length);o="https://utility.arcgis.com/sharing/tools/legend?soapUrl="+encodeURI(d)+"&returnbytes=true"}return i(o,{query:n}).then((function(e){return e.data}))},a.prototype._constructLegendElementsForBuildingSceneLayer=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t,n,i=this;return r.__generator(this,(function(r){switch(r.label){case 0:this.legendElements=[],this._handles.remove("sublayers-watcher"),e=this.layer,this._handles.add(b.watch(e,"sublayers",(function(){return i._constructLegendElementsForBuildingSceneLayer()})),"sublayers-watcher"),r.label=1;case 1:return r.trys.push([1,3,,4]),t=this,[4,this._generateLegendElementsForBuildingSublayers(e.sublayers,this.opacity)];case 2:return t.legendElements=r.sent(),this.notifyChange("ready"),[3,4];case 3:return n=r.sent(),M.warn("Request to server for legend has failed!",n),[3,4];case 4:return[2]}}))}))},a.prototype._generateLegendElementsForBuildingSublayers=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var n,i,l,a,s,o,u,c,d,y,p,h=this;return r.__generator(this,(function(f){switch(f.label){case 0:n=[],this._handles.add(e.on("change",(function(){return h._constructLegendElementsForBuildingSceneLayer()})),"sublayers-watcher"),i=e.toArray(),l=0,a=i,f.label=1;case 1:return l<a.length?(s=a[l],o=s.watch("renderer, opacity, title, visible",(function(){return h._constructLegendElementsForBuildingSceneLayer()})),this._handles.add(o,"sublayers-watcher"),s.visible?(u=s&&null!=s.opacity?s.opacity:null,c=null!=u?u*t:t,"building-group"!==s.type?[3,3]:(d={type:"symbol-table",title:s.title,infos:[]},[4,this._generateLegendElementsForBuildingSublayers(s.sublayers,c)])):[3,5]):[3,6];case 2:return y=f.sent(),(p=d.infos).push.apply(p,y),n=r.__spreadArrays([d],n),[3,5];case 3:return s.renderer?[4,this._getRendererLegendElements(s.renderer,{title:s.title,opacity:c,sublayer:s})]:[3,5];case 4:y=f.sent(),n=r.__spreadArrays(y,n),f.label=5;case 5:return l++,[3,1];case 6:return[2,n.filter((function(e){return!!e&&(!("infos"in e)||e.infos.length>0)}))]}}))}))},a.prototype._constructLegendElementsForSublayers=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t,n,i=this;return r.__generator(this,(function(r){switch(r.label){case 0:this.legendElements=[],this._handles.remove("sublayers-watcher"),e=this.layer,this._handles.add(b.watch(e,"sublayers",(function(){return i._constructLegendElementsForSublayers})),"sublayers-watcher"),r.label=1;case 1:return r.trys.push([1,3,,4]),t=this,[4,this._generateLegendElementsForSublayers(e.sublayers,this.opacity)];case 2:return t.legendElements=r.sent(),this.notifyChange("ready"),[3,4];case 3:return n=r.sent(),M.warn("Request to server for legend has failed!",n),[3,4];case 4:return[2]}}))}))},a.prototype._generateLegendElementsForSublayers=function(e,t,n){return r.__awaiter(this,void 0,void 0,(function(){var i,l,a,s,o,u,c,d,y,p,h=this;return r.__generator(this,(function(f){switch(f.label){case 0:i=[],this._handles.add(e.on("change",(function(){return h._constructLegendElementsForSublayers()})),"sublayers-watcher"),l=e.toArray(),!n&&this.sublayerIds&&this.sublayerIds.length&&(a=this.layer,l=this.sublayerIds.map((function(e){return a.findSublayerById(e)})).filter(Boolean)),s=new _.ExportImageParameters({layer:this.layer}),o=s.hasDynamicLayers&&s.dynamicLayers||"default",s.destroy(),u=function(e){var l,a,s,u,d;return r.__generator(this,(function(y){switch(y.label){case 0:return l=e.watch("renderer, opacity, title, visible, legendEnabled",(function(t,r,i){var l=te&&te[o];l&&!n&&(n=new Map,l.forEach((function(e){return n.set(e.layerId,e)})));var a=null==n?void 0:n.get(e.id);("renderer"!==i||e.originIdOf("renderer")>2||!a)&&h._constructLegendElementsForSublayers()})),c._handles.add(l,"sublayers-watcher"),e.visible&&e.legendEnabled?(a=e&&null!=e.opacity?e.opacity:null,s=null!=a?a*t:t,e.renderer&&!e.sublayers&&e.originIdOf("renderer")>2?c.respectLayerVisibility&&!c._isSublayerInScale(e)?[3,3]:[4,e.load()]:[3,4]):[3,6];case 1:return y.sent(),[4,c._getRendererLegendElements(e.renderer,{title:e.title,opacity:s,sublayer:e})];case 2:u=y.sent(),i=r.__spreadArrays(u,i),y.label=3;case 3:return[3,6];case 4:return[4,c._generateSymbolTableElementForSublayer(e,s,n)];case 5:(d=y.sent())&&i.unshift(d),y.label=6;case 6:return[2]}}))},c=this,d=0,y=l,f.label=1;case 1:return d<y.length?(p=y[d],[5,u(p)]):[3,4];case 2:f.sent(),f.label=3;case 3:return d++,[3,1];case 4:return[2,i.filter((function(e){return!!e&&(!("infos"in e)||e.infos.length>0)}))]}}))}))},a.prototype._generateSymbolTableElementForSublayer=function(e,t,n){return r.__awaiter(this,void 0,void 0,(function(){var i,l,a;return r.__generator(this,(function(r){switch(r.label){case 0:if(n)return[3,4];n=new Map,i=new _.ExportImageParameters({layer:this.layer}),r.label=1;case 1:return r.trys.push([1,,3,4]),[4,this._getLegendLayers(i)];case 2:return r.sent().forEach((function(e){return n.set(e.layerId,e)})),[3,4];case 3:return i.destroy(),[7];case 4:return(l=n.get(e.id))||!e.sublayers?[3,6]:[4,this._generateLegendElementsForSublayers(e.sublayers,t,n)];case 5:return a=r.sent(),[2,{type:"symbol-table",title:e.title,infos:a}];case 6:return[2,this._generateSymbolTableElementForLegendLayer(l,e,t)]}}))}))},a.prototype._generateSymbolTableElementForLegendLayer=function(e,t,r){var n=this;if(!e||!e.legend||this.respectLayerVisibility&&!this._isLegendLayerInScale(e,t))return null;var i=t&&t.renderer,l=t&&t.title||e.layerName;if(i){var a=t&&t.title||this._getRendererTitle(i,t);a&&(l&&(a.title=l),l=a)}var o={type:"symbol-table",title:l,infos:[]};e.legendType&&(o.legendType=e.legendType);var u=t?this._sanitizeLegendForSublayer(e.legend.slice(),t):e.legend;return o.infos=u.map((function(t){var i=t.url;if(t.imageData&&t.imageData.length>0)i="data:image/png;base64,"+t.imageData;else{if(0===i.indexOf("http"))return null;i=s.addTokenParameter(n.layer.url+"/"+e.layerId+"/images/"+i)}return{label:t.label,src:i,opacity:null==r?n.opacity:r,width:t.width,height:t.height}})).filter((function(e){return!!e})),o.infos.length?o:null},a.prototype._isSublayerInScale=function(e){var t=e.minScale||0,r=e.maxScale||0;return!(t>0&&t<this.scale||r>this.scale)},a.prototype._isLegendLayerInScale=function(e,t){var r=t||this.layer,n=null,i=null,l=!0;return!r.minScale&&0!==r.minScale||!r.maxScale&&0!==r.maxScale?(0===e.minScale&&r.tileInfo&&(n=r.tileInfo.lods[0].scale),0===e.maxScale&&r.tileInfo&&(i=r.tileInfo.lods[r.tileInfo.lods.length-1].scale)):(n=Math.min(r.minScale,e.minScale)||r.minScale||e.minScale,i=Math.max(r.maxScale,e.maxScale)),(n>0&&n<this.scale||i>this.scale)&&(l=!1),l},a.prototype._sanitizeLegendForSublayer=function(e,t){if("version"in this.layer&&this.layer.version<10.1||0===e.length)return e;var r=t.renderer,n=e.some((function(e){return e.values})),i=null,l=null;return n&&e.some((function(e,t){return e.values||(i=t,(l=e).label||(l.label="others")),null!=l})),r?"unique-value"===r.type?l&&(e.splice(i,1),e.push(l)):"class-breaks"===r.type&&(l&&e.splice(i,1),e.reverse(),l&&e.push(l)):l&&(e.splice(i,1),e.push(l)),e},a.prototype._getRendererLegendElements=function(e,t){return void 0===t&&(t={}),r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(r){return function(e){return W(e)||j(e)||q(e)||U(e)||B(e)||G(e)||H(e)||J(e)||X(e)||$(e)||k(e)||N(e)}(e)?function(e){return H(e)||J(e)||X(e)||function(e){return"esri.renderers.PointCloudRGBRenderer"===e.declaredClass}(e)}(e)?[2,this._constructPointCloudRendererLegendElements(e,t)]:$(e)?[2,this._constructDotDensityRendererLegendElements(e)]:[2,this._constructRendererLegendElements(e,t)]:(M.warn("Renderer not supported!"),[2,[]])}))}))},a.prototype._getPointCloudRendererTitle=function(e){return e.legendOptions&&e.legendOptions.title||e.field},a.prototype._constructPointCloudRendererLegendElements=function(e,t){var r=this;void 0===t&&(t={});var n=t.title,i=[],l=null,a=null;if(H(e))l={type:"symbol-table",title:n||this._getPointCloudRendererTitle(e),infos:[]},e.colorClassBreakInfos.forEach((function(e){l.infos.unshift({label:e.label||e.minValue+" - "+e.maxValue,value:[e.minValue,e.maxValue],symbol:r._getAppliedCloneSymbol(D,e.color)})}));else if(J(e)){var s=e.stops,o=null;if(s.length&&(1===s.length&&(o=s[0].color),!o)){var u=s[0].value,c=s[s.length-1].value;if(null!=u&&null!=c){var d=u+(c-u)/2;o=I.getColorFromPointCloudStops(d,s)}}l={type:"symbol-table",title:null,infos:[{label:null,value:null,symbol:this._getAppliedCloneSymbol(D,o||D.color)}]};var y=I.getRampStopsForPointCloud(e.stops);a={type:"color-ramp",title:n||this._getPointCloudRendererTitle(e),infos:y,preview:E.renderColorRampPreviewHTML(y.map((function(e){return e.color})))}}else X(e)&&(l={type:"symbol-table",title:n||this._getPointCloudRendererTitle(e),infos:[]},e.colorUniqueValueInfos.forEach((function(e){l.infos.push({label:e.label||e.values.join(", "),value:e.values.join(", "),symbol:r._getAppliedCloneSymbol(D,e.color)})})));l&&l.infos.length&&i.push(l),a&&a.infos.length&&i.push(a);var p=i.reduce((function(e,t){return e.concat(t.infos)}),[]).filter((function(e){return!!e.symbol})).map((function(e){return r._getSymbolPreview(e,r.opacity)}));return h.eachAlways(p).then((function(){return i}))},a.prototype._getElementInfoForDotDensity=function(e,t){var r=e.backgroundColor,n=e.outline,i=e.dotSize+"-"+t+"-"+r+"-"+(n&&JSON.stringify(n.toJSON())),l=this._dotDensityUrlCache,a=l.has(i)?l.get(i):E.renderDotDensityPreviewHTML(e,t);return l.set(i,a),{opacity:1,src:a.src,preview:a,width:a.width,height:a.height}},a.prototype._constructDotDensityRendererLegendElements=function(e){var t=this,r=e.calculateDotValue(this.view.scale),n=e.legendOptions&&e.legendOptions.unit,i={type:"symbol-table",title:{value:r&&Math.round(r),unit:n||""},infos:[]};return e.attributes.forEach((function(r){var n=t._getElementInfoForDotDensity(e,r.color);n.label=r.label||r.valueExpressionTitle||r.field,i.infos.push(n)})),h.resolve([i])},a.prototype._constructRendererLegendElements=function(e,t){return void 0===t&&(t={}),r.__awaiter(this,void 0,void 0,(function(){var n,i,a,s,o,u,c,d,y,f,m,b,g,_,v,S,w,L,R,C,I,V,z,M,O,x,P,D,H,J,X,$,Z,Q,te,re,ne,ie,le,ae,se,oe=this;return r.__generator(this,(function(r){switch(r.label){case 0:return n=t.title,i=t.sublayer,a=i||this.layer,[4,this._loadRenderer(e)];case 1:return s=r.sent(),this._hasColorRamp=!1,this._hasOpacityRamp=!1,this._hasSizeRamp=!1,this._scaleDrivenSizeVariable=null,[4,this._getVisualVariableLegendElements(s,a)];case 2:return o=r.sent()||[],u={type:"symbol-table",title:n||this._getRendererTitle(s,a),infos:[]},c=null,d=!1,y=new Set,G(s)?(f=F.getHeatmapRampStops(s),o.push({type:"heatmap-ramp",title:n,infos:f,preview:E.renderColorRampPreviewHTML(f.map((function(e){return e.color})))}),[3,12]):[3,3];case 3:if(!q(s))return[3,4];if(m=s&&s.authoringInfo,m&&"relationship"===m.type){if(b=m.focus,g=m.numClasses,_=m.field1,v=m.field2,g&&_&&v){for(S=[_,v],w=T.getRotationAngleForFocus(b)||0,L=0,R=S;L<R.length;L++)I=(C=R[L]).field,V=C.normalizationField,z=C.label,M=z||{field:this._getFieldAlias(I,a),normField:V&&this._getFieldAlias(V,a)},(re=ee.clone()).angle=w,u.infos.push({label:M,symbol:re}),y.add(re),w+=90;O=T.getRelationshipRampElement({focus:b,numClasses:g,infos:s.uniqueValueInfos}),o.unshift(O)}}else x=s.field,s.uniqueValueInfos.forEach((function(e){if(e.symbol){var t=e.symbol.clone();K(oe.layer)&&(t=l.SimpleMarkerSymbol.fromJSON({color:t.color,style:"square"})),u.infos.push({label:e.label||oe._getDomainName(x,e.value,a)||e.value,value:e.value,symbol:t})}}));return s.defaultSymbol&&(u.infos.push({label:s.defaultLabel||"others",symbol:s.defaultSymbol}),d=!0),[3,12];case 4:return j(s)?(c=this._isUnclassedRenderer(s),(!c||!this._hasSizeRamp)&&(s.classBreakInfos.forEach((function(e){if(e.symbol){var t=e.symbol.clone();K(oe.layer)&&(t=l.SimpleMarkerSymbol.fromJSON({color:t.color,style:"square"})),u.infos.unshift({label:e.label||(c?null:e.minValue+" - "+e.maxValue),value:[e.minValue,e.maxValue],symbol:t})}})),c&&(u.title=null),this._updateInfosforClassedSizeRenderer(s,u.infos)),s.defaultSymbol&&!c&&(u.infos.push({label:s.defaultLabel||"others",symbol:s.defaultSymbol}),d=!0),[3,12]):[3,5];case 5:return U(s)?function(e){return"esri.layers.ImageryTileLayer"===e.declaredClass}(this.layer)||Y(this.layer)?(P=this._constructTileImageryStretchRendererElements(s),"stretch-ramp"===P.type?o.push(P):u.infos=P,[3,10]):[3,6]:[3,11];case 6:return D=this.layer,H=void 0,J=void 0,s.statistics&&s.statistics.length&&(H=s.statistics[0].min||s.statistics[0][0],J=s.statistics[0].max||s.statistics[0][1]),X=[],Z=p.unwrap,D.renderingRule?[4,D.generateRasterInfo(D.renderingRule)]:[3,8];case 7:return Q=r.sent(),[3,9];case 8:Q=D.serviceRasterInfo,r.label=9;case 9:$=Z.apply(void 0,[Q]),te=$.keyProperties.BandProperties,1===$.bandCount?(H=H||$.statistics&&$.statistics[0].min,J=J||$.statistics&&$.statistics[0].max,H||J?o.push(this._getStretchLegendElements(s,{min:H,max:J})):this.buildLegendElementsForTools()):D.bandIds&&1===D.bandIds.length?(H=H||$.statistics&&$.statistics[D.bandIds[0]].min,J=J||$.statistics&&$.statistics[D.bandIds[0]].max,H||J?o.push(this._getStretchLegendElements(s,{min:H,max:J})):this.buildLegendElementsForTools()):$.bandCount>=3?te&&te.length>=$.bandCount?D.bandIds&&3===D.bandIds.length?(X=D.bandIds.map((function(e){return te[e].BandName})),u.infos=this._createSymbolTableElementMultiBand(X)):"lerc"===D.format?(X=[0,1,2].map((function(e){return te[e].BandName})),u.infos=this._createSymbolTableElementMultiBand(X)):this.buildLegendElementsForTools():"lerc"===D.format?(X=["band1","band2","band3"],u.infos=this._createSymbolTableElementMultiBand(X)):this.buildLegendElementsForTools():this.buildLegendElementsForTools(),r.label=10;case 10:return[3,12];case 11:if(B(s))s.colormapInfos.forEach((function(e){u.infos.push({label:e.label,value:e.value,symbol:oe._getAppliedCloneSymbol(A,e.color)})}));else if(W(s)){switch(re=s.symbol,t.geometryType){case"point":re="pointSymbol"in a&&a.pointSymbol;break;case"polyline":re="lineSymbol"in a&&a.lineSymbol;break;case"polygon":re="polygonSymbol"in a&&a.polygonSymbol}s.symbol&&!this._hasSizeRamp&&u.infos.push({label:s.label,symbol:re})}else k(s)?(s.outputUnit&&(this.title="("+s.toJSON().outputUnit+")"),u.title=s.attributeField,(null==(ne=s.getClassBreakInfos())?void 0:ne.length)?ne.forEach((function(e){u.infos.push({label:e.minValue+" - "+e.maxValue,symbol:e.symbol})})):u.infos.push({label:s.attributeField,symbol:s.getDefaultSymbol()})):N(s)&&o.push(this._getStretchLegendElements(s,{min:0,max:255}));r.label=12;case 12:return!(ie=s.defaultSymbol)||d||W(s)||c&&!this._hasColorRamp&&!this._hasSizeRamp&&!this._hasOpacityRamp||o.push({type:"symbol-table",infos:[{label:s.defaultLabel||"others",symbol:ie}]}),u.infos.length&&o.unshift(u),le=null==t.opacity?this.opacity:t.opacity,ae=this._getSymbolConfig("visualVariables"in s&&s.visualVariables),se=o.reduce((function(e,t){return e.concat(t.infos)}),[]).filter((function(e){return!(!e||!e.symbol)})).map((function(e){return oe._getSymbolPreview(e,le,{applyScaleDrivenSize:!y.has(e.symbol),symbolConfig:ae})})),s=null,[4,h.eachAlways(se)];case 13:return r.sent(),[2,o]}}))}))},a.prototype._constructTileImageryStretchRendererElements=function(e){var t,r,n,i=this.layer,l=i.rasterInfo,a=l.bandCount||e.statistics.length,s=l.keyProperties&&l.keyProperties.BandProperties;if(e.statistics&&e.statistics.length)t=void 0!==e.statistics[0].min?e.statistics[0].min:e.statistics[0][0],r=e.statistics[0].max||e.statistics[0][1];else if(Y(i)){var o=P[i.rasterInfo.pixelType.toLowerCase()];t=o[0],r=o[1]}if(1===l.bandCount)return this._getStretchLegendElements(e,{min:t,max:r});function u(e){var t,r=((null===(t=null==i?void 0:i.bandIds)||void 0===t?void 0:t.length)===l.bandCount?i.bandIds:Array.from(Array(Math.min(l.bandCount,3)).keys())).map((function(t){return e&&e[t]&&e[t].BandName||"band"+(t+1)}));return r.length<3?r.push(r[1]):r.length>3&&r.splice(3),r}return n=s&&s.length>=a?u(s):u(),this._createSymbolTableElementMultiBand(n)},a.prototype._getStretchLegendElements=function(e,t){var r=e.colorRamp,n=I.getStrectchRampStops(r,t);return{type:"stretch-ramp",title:"",infos:n,preview:E.renderColorRampPreviewHTML(n.map((function(e){return e.color})))}},a.prototype._createSymbolTableElementMultiBand=function(e){var t=[],r=["red","green","blue"];return e.forEach((function(e,n){t.push({label:{colorName:r[n],bandName:e},src:z.RGB_IMG_SOURCE[n],opacity:1})})),t},a.prototype._updateInfosforClassedSizeRenderer=function(e,t){var r=e.authoringInfo&&"class-breaks-size"===e.authoringInfo.type,n=e.classBreakInfos.some((function(e){return R.isVolumetricSymbol(e.symbol)}));if(r&&n){var i=V.REAL_WORLD_MAX_SIZE,l=V.REAL_WORLD_MIN_SIZE,a=e.classBreakInfos.length,s=(i-l)/(a>1?a-1:a);t.forEach((function(e,t){e.size=i-s*t}))}},a.prototype._getSymbolConfig=function(e){var t=!1,r=!1;if(e)for(var n=0;n<e.length&&(!t||!r);n++){var i=e[n];"size"===i.type&&("height"===i.axis&&(t=!0),"width-and-depth"===i.axis&&(r=!0))}return t&&r?"tall":null},a.prototype._getSymbolPreview=function(t,n,i){return r.__awaiter(this,void 0,void 0,(function(){var l,a;return r.__generator(this,(function(r){switch(r.label){case 0:return l=null==t.size&&this._hasSizeRamp?f.px2pt(22):t.size,this._scaleDrivenSizeVariable&&(null==i?void 0:i.applyScaleDrivenSize)?[4,new Promise((function(t,r){e(["../../../renderers/visualVariables/support/visualVariableUtils"],t,r)}))]:[3,2];case 1:a=r.sent().getSize,l=a(this._scaleDrivenSizeVariable,null,{view:this.view,scale:this.scale,shape:"simple-marker"===t.symbol.type?t.symbol.style:null}),r.label=2;case 2:return[2,E.renderPreviewHTML(t.symbol,{size:l,opacity:n,scale:!1,symbolConfig:null==i?void 0:i.symbolConfig,rotation:t.symbol.angle}).then((function(e){return t.preview=e,t})).catch((function(){return t.preview=null,t}))]}}))}))},a.prototype._loadRenderer=function(e){var t,n;return r.__awaiter(this,void 0,void 0,(function(){var i,l,a,s,o,u,c,d,y,f,m,b,g=this;return r.__generator(this,(function(r){switch(r.label){case 0:return i=[],l=this.layer,e=e.clone(),this._hasClusterSizeVariable=!1,a="visualVariables"in e&&(null===(t=e.visualVariables)||void 0===t?void 0:t.some((function(e){return"size"===e.type&&"outline"!==e.target&&!O.test(e.valueExpression)}))),e&&"visualVariables"in e&&!a&&"featureReduction"in l&&"cluster"===(null===(n=l.featureReduction)||void 0===n?void 0:n.type)&&(s=this.layerView._effectiveRenderer,(o=p.unwrap(C.getClusterSizeVariable(s,this.view)))&&("clusterMinSize"in(u=l.featureReduction)&&"clusterMaxSize"in u&&(c=u.clusterMinSize,d=u.clusterMaxSize,o.legendOptions=new w({showLegend:c!==d})),y=e.visualVariables||[],e.visualVariables=y.concat([o]),this._hasClusterSizeVariable=!0)),[4,this._getMedianColor(e)];case 1:return f=r.sent(),(j(e)||q(e))&&(m=e.classBreakInfos||e.uniqueValueInfos,b=m.map((function(e){return g._fetchSymbol(e.symbol,f).then((function(t){e.symbol=t})).catch((function(){e.symbol=null}))})),Array.prototype.push.apply(i,b)),i.push(this._fetchSymbol(e.symbol||e.defaultSymbol,e.defaultSymbol?null:f).then((function(t){g._applySymbolToRenderer(e,t,W(e))})).catch((function(){g._applySymbolToRenderer(e,null,W(e))}))),[2,h.eachAlways(i).then((function(){return e}))]}}))}))},a.prototype._applySymbolToRenderer=function(e,t,r){r?e.symbol=t:e.defaultSymbol=t},a.prototype._getMedianColor=function(t){return r.__awaiter(this,void 0,void 0,(function(){var n,i,l,a;return r.__generator(this,(function(r){switch(r.label){case 0:if(!("visualVariables"in t&&t.visualVariables))return[2,null];if(!(n=o.find(t.visualVariables,(function(e){return"color"===e.type}))))return[2,null];if(i=null,l=null,n.stops){if(1===n.stops.length)return[2,n.stops[0].color];i=n.stops[0].value,l=n.stops[n.stops.length-1].value}return a=i+(l-i)/2,[4,new Promise((function(t,r){e(["../../../renderers/visualVariables/support/visualVariableUtils"],t,r)}))];case 1:return[2,(0,r.sent().getColor)(n,a)]}}))}))},a.prototype._fetchSymbol=function(e,t){var r=this;if(!e)return h.reject();if("web-style"===e.type){var n=e.portal,i=n&&n.url,l=n&&n.user&&n.user.username,a=e.name+"-"+e.styleName+"-"+e.styleUrl+"-"+i+"-"+l,s=this._webStyleSymbolCache;return s.has(a)||("2d"===this.view.type?s.set(a,e.fetchCIMSymbol()):s.set(a,e.fetchSymbol())),s.get(a).then((function(e){return r._getAppliedCloneSymbol(e,t)})).catch((function(){return M.warn("Fetching web-style failed!"),h.reject()}))}return h.resolve(this._getAppliedCloneSymbol(e,t))},a.prototype._getAppliedCloneSymbol=function(e,t){if(!e||!t)return e;var r=e.clone(),i=t&&t.toRgba();return r.type.indexOf("3d")>-1?this._applyColorTo3dSymbol(r,i):"cim"===r.type?L.applyCIMSymbolColor(r,t):r.color&&(r.color=new n(i||r.color)),r},a.prototype._applyColorTo3dSymbol=function(e,t){t&&e.symbolLayers.forEach((function(e){e&&(e.material||(e.material={}),e.material.color=new n(t))}))},a.prototype._getVisualVariableLegendElements=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var n,i,l,a,s,o,u,c,d,y,f,m,b=this;return r.__generator(this,(function(g){switch(g.label){case 0:if(!("visualVariables"in e&&e.visualVariables&&"vector-field"!==e.type))return[2,null];for(n=e.visualVariables,i=[],l=[],a=[],s=0,o=n;s<o.length;s++)"color"===(u=o[s]).type?i.push(u):"size"===u.type?l.push(u):"opacity"===u.type&&a.push(u);return c=r.__spreadArrays(i,l,a),0===i.length&&j(e)&&e.classBreakInfos&&1===e.classBreakInfos.length&&(f=e.classBreakInfos[0],d=f&&f.symbol),0===i.length&&W(e)&&(d=e.symbol),d&&(d.type.indexOf("3d")>-1?"water"===(m=d.symbolLayers.getItemAt(0)).type?p.isSome(m.color)&&(y=m.color):p.isSome(m.material)&&p.isSome(m.material.color)&&(y=m.material.color):d.url||(y=d.color)),[4,h.all(c.map((function(n){return r.__awaiter(b,void 0,void 0,(function(){var i,l,a,s,o,u,c,d;return r.__generator(this,(function(r){switch(r.label){case 0:return n.legendOptions&&!1===n.legendOptions.showLegend?[3,10]:(i=this._getRampTitle(n,t),l=null,a="getField"in t&&t.getField&&t.getField(n.field),s=a&&v.isDateField(a),"color"!==n.type?[3,2]:[4,I.getRampStops(n,null,s)]);case 1:return d=r.sent(),l={type:"color-ramp",title:i,infos:d,preview:E.renderColorRampPreviewHTML(d.map((function(e){return e.color})))},this._hasColorRamp||(this._hasColorRamp=!(null==l.infos||!l.infos.length)),[3,9];case 2:return"size"!==n.type||"outline"===n.target?[3,7]:O.test(n.valueExpression)?(this._hasClusterSizeVariable||(this._scaleDrivenSizeVariable=n),[3,6]):[3,3];case 3:return o={type:"size-ramp",title:this._hasClusterSizeVariable?this._getClusterTitle(n):i},u=V.getRampStops,c=[e,n],[4,this._getMedianColor(e)];case 4:return[4,u.apply(void 0,c.concat([r.sent(),this.scale,this.view,s]))];case 5:o.infos=r.sent(),l=o,this._hasSizeRamp||(this._hasSizeRamp=!(null==l.infos||!l.infos.length)),r.label=6;case 6:return[3,9];case 7:return"opacity"!==n.type?[3,9]:[4,I.getRampStops(n,y,s)];case 8:d=r.sent(),l={type:"opacity-ramp",title:i,infos:d,preview:E.renderColorRampPreviewHTML(d.map((function(e){return e.color})))},this._hasOpacityRamp||(this._hasOpacityRamp=!(null==l.infos||!l.infos.length)),r.label=9;case 9:return[2,l&&l.infos?l:null];case 10:return[2,void 0]}}))}))})))];case 1:return[2,g.sent().filter((function(e){return!!e}))]}}))}))},a.prototype._getDomainName=function(e,t,r){if(e&&"function"!=typeof e){var n="getField"in r&&r.getField&&r.getField(e),i=n&&"getFieldDomain"in r&&r.getFieldDomain?r.getFieldDomain(n.name):null;return i&&"coded-value"===i.type?i.getName(t):null}return null},a.prototype._getClusterTitle=function(e){var t=this.layer,r=e.field;if("featureReduction"in t&&t.featureReduction&&"cluster"===t.featureReduction.type){var n=t.featureReduction,i="popupTemplate"in n&&n.popupTemplate,l=i&&i.fieldInfos;if(l)for(var a=0,s=l;a<s.length;a++){var o=s[a];if(o.fieldName===r)return"cluster_count"===r?o.label||{showCount:!0}:o.label}}return{showCount:!0}},a.prototype._getRampTitle=function(e,t){var r=e.field,n=e.normalizationField,i=!1,l=!1,a=!1,s=null;r="function"==typeof r?null:r,n="function"==typeof n?null:n;var o=e.legendOptions&&e.legendOptions.title;if(null!=o)s=o;else if(e.valueExpressionTitle)s=e.valueExpressionTitle;else{if("renderer"in t&&t.renderer&&"authoringInfo"in t.renderer&&t.renderer.authoringInfo&&t.renderer.authoringInfo.visualVariables)for(var u=t.renderer.authoringInfo.visualVariables,c=0;c<u.length;c++){var d=u[c];if("color"===d.type){if("ratio"===d.style){i=!0;break}if("percent"===d.style){l=!0;break}if("percent-of-total"===d.style){a=!0;break}}}s={field:r&&this._getFieldAlias(r,t),normField:n&&this._getFieldAlias(n,t),ratio:i,ratioPercent:l,ratioPercentTotal:a}}return s},a.prototype._getRendererTitle=function(e,t){var r=e;if(r.legendOptions&&r.legendOptions.title)return r.legendOptions.title;if(r.valueExpressionTitle)return r.valueExpressionTitle;var n=r.field,i=null,l=null;j(r)&&(i=r.normalizationField,l="percent-of-total"===r.normalizationType),i="function"==typeof i?null:i;var a=null;return((n="function"==typeof n?null:n)||i)&&(a={field:n&&this._getFieldAlias(n,t),normField:i&&this._getFieldAlias(i,t),normByPct:l}),a},a.prototype._getFieldAlias=function(e,t){var r="popupTemplate"in t&&t.popupTemplate,n=r&&r.fieldInfos,i=null;n&&n.some((function(t){return e===t.fieldName&&(i=t,!0)}));var l=null;"getField"in t&&t.getField?l=t.getField(e):"fieldsIndex"in t&&t.fieldsIndex&&(l=t.fieldsIndex.get(e));var a=i||l,s=null;return a&&(s=i&&i.label||l&&l.alias||"name"in a&&a.name||"fieldName"in a&&a.fieldName),s},a.prototype._isUnclassedRenderer=function(e){var t=e.visualVariables,r=!1;return j(e)&&e.classBreakInfos&&1===e.classBreakInfos.length&&t&&(r=e.field?t.some((function(t){return!(!t||e.field!==t.field||(e.normalizationField||t.normalizationField)&&e.normalizationField!==t.normalizationField)})):!!t.length),r},r.__decorate([g.property()],a.prototype,"children",void 0),r.__decorate([g.property()],a.prototype,"layerView",void 0),r.__decorate([g.property()],a.prototype,"layer",void 0),r.__decorate([g.property()],a.prototype,"legendElements",void 0),r.__decorate([g.property({dependsOn:["parent","parent.opacity","layer","layer.opacity"],readOnly:!0})],a.prototype,"opacity",null),r.__decorate([g.property()],a.prototype,"parent",void 0),r.__decorate([g.property({readOnly:!0})],a.prototype,"ready",null),r.__decorate([g.property()],a.prototype,"keepCacheOnDestroy",void 0),r.__decorate([g.property()],a.prototype,"respectLayerVisibility",void 0),r.__decorate([g.property({dependsOn:["view.scale"],readOnly:!0})],a.prototype,"scale",null),r.__decorate([g.property()],a.prototype,"sublayerIds",void 0),r.__decorate([g.property({dependsOn:["layer.renderer?.valueExpression?","layer.renderer?.visualVariables?","layer.featureReduction?","scale"],readOnly:!0})],a.prototype,"isScaleDriven",null),r.__decorate([g.property()],a.prototype,"title",void 0),r.__decorate([g.property({dependsOn:["ready"],readOnly:!0,value:0})],a.prototype,"version",null),r.__decorate([g.property()],a.prototype,"view",void 0),a=r.__decorate([g.subclass("esri.widgets.Legend.support.ActiveLayerInfo")],a)}(a)}));