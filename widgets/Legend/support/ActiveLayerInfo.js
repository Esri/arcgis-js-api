/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["require","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/has","../../../core/maybe","../../../core/Logger","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/property","../../../core/jsonMap","../../../core/accessorSupport/decorators/subclass","../../../core/urlUtils","../../../core/uuid","../../../portal/support/resourceExtension","../../../core/promiseUtils","../../../core/Accessor","../../../core/Collection","../../../layers/support/fieldUtils","../../../Color","../../../core/screenUtils","../../../kernel","../../../request","../../../symbols/SimpleFillSymbol","../../../symbols/SimpleMarkerSymbol","../../../symbols","../../../core/Handles","../../../core/watchUtils","../../../renderers/visualVariables/support/SizeVariableLegendOptions","../../../symbols/support/cimSymbolUtils","../../../symbols/support/utils","../../../renderers/support/jsonUtils","../../../layers/support/ExportImageParameters","../../../symbols/support/symbolUtils","../../../renderers/support/rendererConversion","./clusterUtils","./utils","./colorRampUtils","./heatmapRampUtils","./relationshipRampUtils","./sizeRampUtils"],(function(e,t,n,l,s,r,i,a,o,u,c,d,y,h,p,m,f,g,b,_,S,v,w,L,E,C,R,I,F,T,V,z,M,x,P,D,O,A,k){"use strict";const B=r.getLogger("esri.widgets.Legend.support.ActiveLayerInfo"),U="https://utility.arcgis.com/sharing/tools/legend",N="esri.layers.ImageryLayer",W="esri.layers.ImageryTileLayer",q="esri.layers.WCSLayer",G=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i,$=new o.JSONMap({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"}),j={u1:[0,1],u2:[0,3],u4:[0,15],u8:[0,255],s8:[-128,127],u16:[0,65535],s16:[-32768,32767],u32:[0,4294967295],s32:[-2147483648,2147483647],f32:[-34e38,34e38],f64:[-Number.MAX_VALUE,Number.MAX_VALUE]},H=new w({size:6,outline:{color:[128,128,128,.5],width:.5}}),J=new v({style:"solid"});function X(e){return"vector-field"===e.type}function Z(e){return"raster-colormap"===e.type}function Q(e){return"raster-stretch"===e.type}function K(e){return"raster-shaded-relief"===e.type}function Y(e){return"esri.renderers.SimpleRenderer"===e.declaredClass}function ee(e){return"esri.renderers.ClassBreaksRenderer"===e.declaredClass}function te(e){return"esri.renderers.UniqueValueRenderer"===e.declaredClass}function ne(e){return"esri.renderers.HeatmapRenderer"===e.declaredClass}function le(e){return re(e)||ie(e)||ae(e)||se(e)}function se(e){return"esri.renderers.PointCloudRGBRenderer"===e.declaredClass}function re(e){return"esri.renderers.PointCloudClassBreaksRenderer"===e.declaredClass}function ie(e){return"esri.renderers.PointCloudStretchRenderer"===e.declaredClass}function ae(e){return"esri.renderers.PointCloudUniqueValueRenderer"===e.declaredClass}function oe(e){return"esri.renderers.DotDensityRenderer"===e.declaredClass}function ue(e,t){return Y(e)||ee(e)||te(e)||ne(e)||oe(e)?"2d"===t.type||M.isSupportedRenderer3D(e):Q(e)||Z(e)||K(e)||re(e)||ie(e)||ae(e)||X(e)}function ce(e){return"esri.layers.BuildingSceneLayer"===e.declaredClass}function de(e){return"esri.layers.WMSLayer"===e.declaredClass}function ye(e){return"esri.layers.WMTSLayer"===e.declaredClass}function he(e){return"esri.layers.MapImageLayer"===e.declaredClass}function pe(e){return"esri.layers.TileLayer"===e.declaredClass}function me(e){return"esri.layers.FeatureLayer"===e.declaredClass}function fe(e){return e.declaredClass===N}function ge(e){return e.declaredClass===W}function be(e){return e.declaredClass===q}function _e(e){return"stretch-ramp"===e.type}function Se(e){const t="authoringInfo"in e&&(null==e?void 0:e.authoringInfo);return"univariate-color-size"===(null==t?void 0:t.type)}function ve(e){const t="authoringInfo"in e&&(null==e?void 0:e.authoringInfo);return"univariate-color-size"===(null==t?void 0:t.type)&&"above-and-below"===(null==t?void 0:t.univariateTheme)}const we=new w({style:"path",path:"M10,5 L5,0 0,5 M5,0 L5,15",size:15,outline:{width:1,color:[85,85,85,1]}});let Le={},Ee=function(n){function l(e){var t;return(t=n.call(this,e)||this)._handles=new E,t._hasColorRamp=!1,t._hasOpacityRamp=!1,t._hasSizeRamp=!1,t._webStyleSymbolCache=new Map,t._dotDensityUrlCache=new Map,t._scaleDrivenSizeVariable=null,t._hasClusterSizeVariable=!1,t.children=new m,t.layerView=null,t.layer=null,t.legendElements=[],t.parent=null,t.keepCacheOnDestroy=!1,t.respectLayerVisibility=!0,t.sublayerIds=[],t.title=null,t.view=null,t}t._inheritsLoose(l,n);var r=l.prototype;return r.initialize=function(){const e=()=>this.notifyChange("ready");this._handles.add([C.on(this,"children","change",(t=>{const{added:n,removed:l}=t,s=this._handles;n.map((t=>{const n=`activeLayerInfo-ready-watcher-${t.layer.uid}`;s.add(C.init(t,"ready",e),n)})),l.forEach((e=>s.remove(e.layer.uid))),e()}))]),this.keepCacheOnDestroy||(Le={})},r.destroy=function(){this._handles.destroy(),this._handles=null,this._webStyleSymbolCache=null,this._dotDensityUrlCache=null,this._scaleDrivenSizeVariable=null,this.keepCacheOnDestroy||(Le=null)},r.buildLegendElementsForFeatureCollections=async function(e){const t=e.map((e=>{if(me(e))return this._getRendererLegendElements(e.renderer,{title:e.title});if(e.featureSet&&e.featureSet.features.length){const t=e.layerDefinition,n=t&&t.drawingInfo,l=n&&T.fromJSON(n.renderer),s=$.read(t.geometryType);return l?this._getRendererLegendElements(l,{title:e.name,geometryType:s}):(B.warn("drawingInfo not available!"),null)}return null}));try{const e=[];await h.eachAlways(t).then((t=>{t.forEach((({value:t})=>t&&e.push(...t)))})),this.legendElements=e,this.notifyChange("ready")}catch(n){B.warn("error while building legend for layer!",n)}},r.buildLegendElementsForRenderer=async function(e){try{const t=await this._getRendererLegendElements(e);this.legendElements=t,this.notifyChange("ready")}catch(t){B.warn("error while building legend for layer!",t)}},r.buildLegendElementsForTools=async function(){const e=this.layer;ye(e)?this._constructLegendElementsForWMTSlayer():de(e)?await this._constructLegendElementsForWMSSublayers():ce(e)?await this._constructLegendElementsForBuildingSceneLayer():he(e)||pe(e)||ce(e)?await this._constructLegendElementsForSublayers():(this._handles.remove("imageryLayers-watcher"),await this._getLegendLayers(`${e.uid}-default`).then((async t=>{this.legendElements=[],this.notifyChange("ready");const n=t.map((async t=>{if(fe(e)||ge(e)){const t=e.watch(["renderingRule","bandIds"],(()=>h.debounce((async()=>{Le.default=null,e.renderer?await this.buildLegendElementsForRenderer(e.renderer):await this.buildLegendElementsForTools()}))()));this._handles.add(t,"imageryLayers-watcher")}const n=this._generateSymbolTableElementForLegendLayer(t);n&&n.infos.length&&(fe(e)&&(n.title=e.title),this.legendElements.push(n)),this.notifyChange("ready")}));await Promise.allSettled(n)})).catch((e=>{B.warn("Request to server for legend has failed!",e)})))},r._getParentLayerOpacity=function(e){let t=1;const n=e.parent;return n&&"uid"in n&&(t=this._getParentLayerOpacity(n)),e.opacity*t},r._isGroupActive=function(){const e=this.children;return!!e.length&&e.some((e=>e.ready))},r._isScaleDrivenSizeVariable=function(e){if(e&&"size"!==e.type)return!1;const t=e,n=t.minSize,l=t.maxSize;return"object"==typeof n&&n?this._isScaleDrivenSizeVariable(n):"object"==typeof l&&l?this._isScaleDrivenSizeVariable(l):!!t.expression||G.test(t.valueExpression)},r._isLayerScaleDriven=function(e){if("minScale"in e&&e.minScale>0||"maxScale"in e&&e.maxScale>0)return!0;if("sublayers"in e&&e.sublayers)return e.sublayers.some((e=>this._isLayerScaleDriven(e)));const t=e.parent;if(!1===e.loaded&&t&&he(t)&&"source"in e&&e.source&&"map-layer"===e.source.type)for(const n of t.sourceJSON.layers)if(n.id===e.source.mapLayerId&&(n.minScale>0||n.maxScale>0))return!0;return!1},r._constructLegendElementsForWMTSlayer=function(){this.legendElements=[],this._handles.remove("wmts-activeLayer-watcher");const e=this.layer.activeLayer;if(this._handles.add(C.watch(this.layer,"activeLayer",(()=>this._constructLegendElementsForWMTSlayer())),"wmts-activeLayer-watcher"),e.styleId&&e.styles){let t=null;e.styles.some((n=>e.styleId===n.id&&(t=n.legendUrl,!0))),t&&(this.legendElements=[{type:"symbol-table",title:e.title,infos:[{src:t,opacity:this.opacity}]}])}this.notifyChange("ready")},r._constructLegendElementsForWMSSublayers=async function(){this.legendElements=[],this._handles.remove("wms-sublayers-watcher");const e=this.layer;let t=null;(e.customParameters||e.customLayerParameters)&&(t={...e.customParameters,...e.customLayerParameters}),this._handles.add(C.watch(this.layer,"sublayers",(()=>this._constructLegendElementsForWMSSublayers())),"wms-sublayers-watcher"),this.legendElements=await this._generateLegendElementsForWMSSublayers(e.sublayers,t),this.notifyChange("ready")},r._generateLegendElementsForWMSSublayers=async function(e,t){const n=[];this._handles.add(e.on("change",(()=>this._constructLegendElementsForWMSSublayers())),"wms-sublayers-watcher");const l=e.toArray();for(const s of l){const e=s.watch(["title","visible","legendEnabled"],(()=>this._constructLegendElementsForWMSSublayers()));if(this._handles.add(e,"wms-sublayers-watcher"),s.visible&&s.legendEnabled){const e=await this._generateSymbolTableElementForWMSSublayer(s,t);e&&e.infos.length&&n.unshift(e)}}return n},r._generateSymbolTableElementForWMSSublayer=async function(e,t){if(!e.legendUrl&&e.sublayers){const n=(await this._generateLegendElementsForWMSSublayers(e.sublayers,t)).filter((e=>e));return{type:"symbol-table",title:e.title,infos:n}}return this._generateSymbolTableElementForLegendUrl(e,t)},r._generateSymbolTableElementForLegendUrl=async function(e,t){var n;let l=e.legendUrl;if(!l)return;const s={type:"symbol-table",title:e.title||e.name||e.id&&e.id+"",infos:[]};t&&(l+="?"+c.objectToQuery(t));let r=null;const i=null==(n=e.layer)?void 0:n.opacity;try{r=(await S(l,{responseType:"image"})).data,r&&(r.style.opacity=i)}catch{}return s.infos.push({src:l,preview:r,opacity:i}),s},r._getLegendLayers=function(e,t){const n=Le&&Le[e];return n?Promise.resolve(n):this._legendRequest(t).then((t=>{const n=t.layers;return Le[e]=n,n}))},r._legendRequest=function(e){const t=this.layer;let n={f:"json",dynamicLayers:e};if(fe(t)){const e=t.exportImageServiceParameters.renderingRule;if(e&&(n.renderingRule=JSON.stringify(e.toJSON())),t.bandIds&&(n.bandIds=t.bandIds.join()),t.raster||t.viewId){const{raster:e,viewId:l}=t;n={raster:e,viewId:l,...n}}}let l=t.url.replace(/(\/)+$/,"");if("version"in t&&t.version>=10.01){const e=l.indexOf("?");e>-1?l=l.substring(0,e)+"/legend"+l.substring(e):l+="/legend"}else{const e=l.toLowerCase().indexOf("/rest/"),t=l.substring(0,e)+l.substring(e+5,l.length);l=U+"?soapUrl="+encodeURI(t)+"&returnbytes=true"}return S(l,{query:n}).then((e=>e.data))},r._constructLegendElementsForBuildingSceneLayer=async function(){this.legendElements=[],this._handles.remove("sublayers-watcher");const e=this.layer;this._handles.add(C.watch(e,"sublayers",(()=>this._constructLegendElementsForBuildingSceneLayer())),"sublayers-watcher");try{this.legendElements=await this._generateLegendElementsForBuildingSublayers(e.sublayers,this.opacity),this.notifyChange("ready")}catch(t){B.warn("Request to server for legend has failed!",t)}},r._generateLegendElementsForBuildingSublayers=async function(e,t){let n=[];this._handles.add(e.on("change",(()=>this._constructLegendElementsForBuildingSceneLayer())),"sublayers-watcher");const l=e.toArray();for(const s of l){const e=s.watch(["renderer","opacity","title","visible"],(()=>this._constructLegendElementsForBuildingSceneLayer()));if(this._handles.add(e,"sublayers-watcher"),s.visible){const e=s&&null!=s.opacity?s.opacity:null,l=null!=e?e*t:t;if("building-group"===s.type){const e={type:"symbol-table",title:s.title,infos:[]},t=await this._generateLegendElementsForBuildingSublayers(s.sublayers,l);e.infos.push(...t),n=[e,...n]}else if(s.renderer){n=[...await this._getRendererLegendElements(s.renderer,{title:s.title,opacity:l,sublayer:s}),...n]}}}return n.filter((e=>!!e&&(!("infos"in e)||e.infos.length>0)))},r._constructLegendElementsForSublayers=async function(){this.legendElements=[],this._handles.remove("sublayers-watcher");const e=this.layer;this._handles.add(C.watch(e,"sublayers",(()=>this._constructLegendElementsForSublayers)),"sublayers-watcher");try{this.legendElements=await this._generateLegendElementsForSublayers(e.sublayers,this.opacity),this.notifyChange("ready")}catch(t){B.warn("Request to server for legend has failed!",t)}},r._generateLegendElementsForSublayers=async function(e,t,n){const l=this.layer;let s=[];this._handles.add(e.on("change",(()=>this._constructLegendElementsForSublayers())),"sublayers-watcher");let r=e.toArray();!n&&this.sublayerIds&&this.sublayerIds.length&&(r=this.sublayerIds.map((e=>l.findSublayerById(e))).filter(Boolean));for(const i of r){const e=i.watch("renderer, opacity, title, visible, legendEnabled",(()=>this._constructLegendElementsForSublayers()));if(this._handles.add(e,"sublayers-watcher"),i.visible&&i.legendEnabled&&(!this.respectLayerVisibility||this._isSublayerInScale(i))){const e=i&&null!=i.opacity?i.opacity:null,l=null!=e?e*t:t;if(i.renderer&&!i.sublayers&&i.originIdOf("renderer")>2){await i.load();s=[...await this._getRendererLegendElements(i.renderer,{title:i.title,opacity:l,sublayer:i}),...s]}else{const e=await this._generateSymbolTableElementForSublayer(i,l,n);e&&s.unshift(e)}}}return s.filter((e=>!!e&&(!("infos"in e)||e.infos.length>0)))},r._generateSymbolTableElementForSublayer=async function(e,t,n){if(!n){n=new Map;const t=new V.ExportImageParameters({layer:this.layer}),l=t.hasDynamicLayers?t.dynamicLayers:null;t.destroy();const s=l||`${this.layer.uid}-${e.id}-default`;(await this._getLegendLayers(s,l)).forEach((e=>n.set(e.layerId,e)))}const l=n.get(e.id);if(!l&&e.sublayers){const l=await this._generateLegendElementsForSublayers(e.sublayers,t,n);return{type:"symbol-table",title:e.title,infos:l}}return this._generateSymbolTableElementForLegendLayer(l,e,t)},r._generateSymbolTableElementForLegendLayer=function(e,t,n){var l;if(!e||!e.legend||this.respectLayerVisibility&&!this._isLegendLayerInScale(e,t))return null;const s=null==t?void 0:t.renderer;let r=(null==t?void 0:t.title)||e.layerName;if(s&&(!t||(null==t?void 0:t.originIdOf("renderer"))>2)){const e=(null==t?void 0:t.title)||this._getRendererTitle(s,t);e&&(r&&"string"!=typeof e&&"title"in e&&(e.title=r),r=e)}const i={type:"symbol-table",title:r,legendType:e.legendType?e.legendType:null,infos:[]},a=t?this._sanitizeLegendForSublayer(e.legend.slice(),t):e.legend;return(null==(l=e.legendGroups)?void 0:l.length)>0?e.legendGroups.forEach((t=>{var l;const s={type:"symbol-table",title:t.heading,legendType:e.legendType?e.legendType:null,infos:this._generateSymbolTableElementInfosForLegendLayer(a.filter((e=>e.groupId===t.id)),e.layerId,n)};(null==(l=s.infos)?void 0:l.length)>0&&i.infos.push(s)})):i.infos=this._generateSymbolTableElementInfosForLegendLayer(a,e.layerId,n),i.infos.length>0?i:null},r._generateSymbolTableElementInfosForLegendLayer=function(e,t,n){return e.map((e=>{let l=e.url;if(e.imageData&&e.imageData.length>0)l=`data:image/png;base64,${e.imageData}`;else{if(0===l.indexOf("http"))return null;l=_.addTokenParameter(`${this.layer.url}/${t}/images/${l}`)}return{label:e.label,src:l,opacity:null==n?this.opacity:n,width:e.width,height:e.height}})).filter((e=>!!e))},r._isSublayerInScale=function(e){const t=e.minScale||0,n=e.maxScale||0;return!(t>0&&t<this.scale||n>this.scale)},r._isLegendLayerInScale=function(e,t){const n=t||this.layer;let l=null,s=null,r=!0;return!n.minScale&&0!==n.minScale||!n.maxScale&&0!==n.maxScale?(0===e.minScale&&n.tileInfo&&(l=n.tileInfo.lods[0].scale),0===e.maxScale&&n.tileInfo&&(s=n.tileInfo.lods[n.tileInfo.lods.length-1].scale)):(l=Math.min(n.minScale,e.minScale)||n.minScale||e.minScale,s=Math.max(n.maxScale,e.maxScale)),(l>0&&l<this.scale||s>this.scale)&&(r=!1),r},r._sanitizeLegendForSublayer=function(e,t){if("version"in this.layer&&this.layer.version<10.1||0===e.length)return e;const n=t.renderer,l=e.some((e=>e.values));let s=null,r=null;return l&&e.some(((e,t)=>(e.values||(s=t,r=e,r.label||(r.label="others")),null!=r))),n?"unique-value"===n.type?r&&(e.splice(s,1),e.push(r)):"class-breaks"===n.type&&(r&&e.splice(s,1),e.reverse(),r&&e.push(r)):r&&(e.splice(s,1),e.push(r)),e},r._getRendererLegendElements=async function(e,t={}){return ue(e,this.view)?le(e)?this._constructPointCloudRendererLegendElements(e,t):oe(e)?this._constructDotDensityRendererLegendElements(e):this._constructRendererLegendElements(e,t):(B.warn(`Renderer of type '${e.type}' not supported!`),[])},r._getPointCloudRendererTitle=function(e){return e.legendOptions&&e.legendOptions.title||e.field},r._constructPointCloudRendererLegendElements=function(e,t={}){const n=t.title,l=[];let s=null,r=null;if(re(e))s={type:"symbol-table",title:n||this._getPointCloudRendererTitle(e),infos:[]},e.colorClassBreakInfos.forEach((e=>{s.infos.unshift({label:e.label||e.minValue+" - "+e.maxValue,value:[e.minValue,e.maxValue],symbol:this._getAppliedCloneSymbol(H,e.color)})}));else if(ie(e)){const t=e.stops;let l=null;if(t.length&&(1===t.length&&(l=t[0].color),!l)){const e=t[0].value,n=t[t.length-1].value;if(null!=e&&null!=n){const s=e+(n-e)/2;l=D.getColorFromPointCloudStops(s,t)}}s={type:"symbol-table",title:null,infos:[{label:null,value:null,symbol:this._getAppliedCloneSymbol(H,l||H.color)}]};const i=D.getRampStopsForPointCloud(e.stops);r={type:"color-ramp",title:n||this._getPointCloudRendererTitle(e),infos:i,preview:z.renderColorRampPreviewHTML(i.map((e=>e.color)))}}else ae(e)&&(s={type:"symbol-table",title:n||this._getPointCloudRendererTitle(e),infos:[]},e.colorUniqueValueInfos.forEach((e=>{s.infos.push({label:e.label||e.values.join(", "),value:e.values.join(", "),symbol:this._getAppliedCloneSymbol(H,e.color)})})));s&&s.infos.length&&l.push(s),r&&r.infos.length&&l.push(r);const i=l.reduce(((e,t)=>e.concat(t.infos)),[]).filter((e=>!!e.symbol)).map((t=>this._getSymbolPreview(t,this.opacity,{symbolConfig:{applyColorModulation:!!e.colorModulation}})));return h.eachAlways(i).then((()=>l))},r._getElementInfoForDotDensity=function(e,t){const{backgroundColor:n,outline:l,dotSize:s}=e,r=s+"-"+t+"-"+n+"-"+(l&&JSON.stringify(l.toJSON())),i=this._dotDensityUrlCache,a=i.has(r)?i.get(r):z.renderDotDensityPreviewHTML(e,t);return i.set(r,a),{opacity:1,src:a.src,preview:a,width:a.width,height:a.height}},r._constructDotDensityRendererLegendElements=function(e){const t=e.calculateDotValue(this.view.scale),n=e.legendOptions&&e.legendOptions.unit,l={type:"symbol-table",title:{value:t&&Math.round(t),unit:n||""},infos:[]};return e.attributes.forEach((t=>{const n=this._getElementInfoForDotDensity(e,t.color);n.label=t.label||t.valueExpressionTitle||t.field,l.infos.push(n)})),Promise.resolve([l])},r._constructRendererLegendElements=async function(e,t={}){const{title:n,sublayer:l}=t,r=l||this.layer;let i=await this._loadRenderer(e);this._hasColorRamp=!1,this._hasOpacityRamp=!1,this._hasSizeRamp=!1,this._scaleDrivenSizeVariable=null;const a=await this._getVisualVariableLegendElements(i,r)||[],o={type:"symbol-table",title:n||this._getRendererTitle(i,r),infos:[]};let u=null,c=!1;const d=new Set;if(Se(i)){let e=n;const t=ve(i)?"univariate-above-and-below-ramp":"univariate-color-size-ramp",l=a.findIndex((e=>"color-ramp"===e.type)),s=a.splice(l,1)[0],r=a.findIndex((e=>"size-ramp"===e.type)),o=a.splice(r,1)[0],u=[];s&&(e=s.title,u.push(s)),o&&(e=o.title,u.push(o)),u.length>0&&a.push({type:t,title:e,infos:u})}else if(ne(i)){const e=O.getHeatmapRampStops(i);a.push({type:"heatmap-ramp",title:n,infos:e,preview:z.renderColorRampPreviewHTML(e.map((e=>e.color)))})}else if(te(i)){const e=i&&i.authoringInfo;if(e&&"relationship"===e.type){const{focus:t,numClasses:n,field1:l,field2:s}=e;if(n&&l&&s){const e=[l,s];let u=A.getRotationAngleForFocus(t)||0;for(const t of e){const{field:e,normalizationField:n,label:l}=t,s=l||{field:this._getFieldAlias(e,r),normField:n&&this._getFieldAlias(n,r)},i=we.clone();i.angle=u,o.infos.push({label:s,symbol:i}),d.add(i),u+=90}const c=A.getRelationshipRampElement({focus:t,numClasses:n,infos:i.uniqueValueInfos});a.unshift(c)}}else{const e=i.field;i.uniqueValueInfos.forEach((t=>{t.symbol&&o.infos.push({label:t.label||this._getDomainName(e,t.value,r)||t.value,value:t.value,symbol:t.symbol})}))}i.defaultSymbol&&(o.infos.push({label:i.defaultLabel||"others",symbol:i.defaultSymbol}),c=!0)}else if(ee(i)){u=this._isUnclassedRenderer(i);(!u||!this._hasSizeRamp)&&(i.classBreakInfos.forEach((e=>{e.symbol&&o.infos.unshift({label:e.label||(u?null:e.minValue+" - "+e.maxValue),value:[e.minValue,e.maxValue],symbol:e.symbol})})),u&&(o.title=null),this._updateInfosforClassedSizeRenderer(i,o.infos)),i.defaultSymbol&&!u&&(o.infos.push({label:i.defaultLabel||"others",symbol:i.defaultSymbol}),c=!0)}else if(Q(i)){var y,p;if(ge(this.layer)&&"Map"===(null==(y=this.layer)||null==(p=y.raster)?void 0:p.tileType))this._getServerSideLegend();else if(ge(this.layer)||be(this.layer)){const e=this._constructTileImageryStretchRendererElements(i);_e(e)?a.push(e):o.infos=e}else{const e=this.layer;let t,n;var m,f;if(i.statistics&&i.statistics.length)t=null!=i.statistics[0].min?i.statistics[0].min:i.statistics[0][0],n=null!=i.statistics[0].max?i.statistics[0].max:i.statistics[0][1];else t=null==(m=i)?void 0:m.outputMin,n=null==(f=i)?void 0:f.outputMax;let l=[];const r=s.unwrap(e.renderingRule?await e.generateRasterInfo(e.renderingRule):e.serviceRasterInfo),u=r.keyProperties.BandProperties;1===r.bandCount?(t=null!=t?t:r.statistics&&r.statistics[0].min,n=null!=n?n:r.statistics&&r.statistics[0].max,t||n?a.push(this._getStretchLegendElements(i,{min:t,max:n})):this._getServerSideLegend()):e.bandIds&&1===e.bandIds.length?(t=null!=t?t:r.statistics&&r.statistics[e.bandIds[0]].min,n=null!=n?n:r.statistics&&r.statistics[e.bandIds[0]].max,t||n?a.push(this._getStretchLegendElements(i,{min:t,max:n})):this._getServerSideLegend()):r.bandCount>=3?u&&u.length>=r.bandCount?e.bandIds&&3===e.bandIds.length?(l=e.bandIds.map((e=>u[e].BandName)),o.infos=this._createSymbolTableElementMultiBand(l)):"lerc"===e.format?(l=[0,1,2].map((e=>u[e].BandName)),o.infos=this._createSymbolTableElementMultiBand(l)):this._getServerSideLegend():"lerc"===e.format?(l=["band1","band2","band3"],o.infos=this._createSymbolTableElementMultiBand(l)):this._getServerSideLegend():this._getServerSideLegend()}}else if(Z(i))i.colormapInfos.forEach((e=>{o.infos.push({label:e.label,value:e.value,symbol:this._getAppliedCloneSymbol(J,e.color)})}));else if(Y(i)){let e=i.symbol;switch(t.geometryType){case"point":e="pointSymbol"in r&&r.pointSymbol;break;case"polyline":e="lineSymbol"in r&&r.lineSymbol;break;case"polygon":e="polygonSymbol"in r&&r.polygonSymbol}i.symbol&&!this._hasSizeRamp&&o.infos.push({label:i.label,symbol:e})}else if(X(i)){i.outputUnit&&(this.title="("+i.toJSON().outputUnit+")"),o.title=i.attributeField;const e=i.getClassBreakInfos();null!=e&&e.length?e.forEach((e=>{o.infos.push({label:e.minValue+" - "+e.maxValue,symbol:e.symbol})})):o.infos.push({label:i.attributeField,symbol:i.getDefaultSymbol()})}else K(i)&&a.push(this._getStretchLegendElements(i,{min:0,max:255}));const g=i.defaultSymbol;!g||c||Y(i)||u&&!this._hasColorRamp&&!this._hasSizeRamp&&!this._hasOpacityRamp||a.push({type:"symbol-table",infos:[{label:i.defaultLabel||"others",symbol:g}]}),o.infos.length&&a.unshift(o);const b=null==t.opacity?this.opacity:t.opacity,_=this._isTallSymbol("visualVariables"in i&&i.visualVariables),S=fe(this.layer)||ge(this.layer),v=a.reduce(((e,t)=>e.concat(this._getAllInfos(t))),[]).filter((e=>!(!e||!e.symbol))).map((e=>this._getSymbolPreview(e,b,{applyScaleDrivenSize:!d.has(e.symbol),symbolConfig:{isTall:_,isSquareFill:S}})));return i=null,await h.eachAlways(v),a},r._getServerSideLegend=function(){setTimeout((()=>this.buildLegendElementsForTools()),0)},r._getAllInfos=function(e){const t=null==e?void 0:e.infos;return t?t.reduce(((e,t)=>e.concat(this._getAllInfos(t))),[]):[e]},r._constructTileImageryStretchRendererElements=function(e){var t,n;const l=this.layer,s=l.rasterInfo,r=s.bandCount||e.statistics.length;let i,a,o=[];const u=s.keyProperties&&s.keyProperties.BandProperties,c=null!=e&&null!=(t=e.statistics)&&t.length?e.statistics:null==s?void 0:s.statistics;if(c)i=void 0!==c[0].min?c[0].min:c[0][0],a=c[0].max||c[0][1];else{const e=j[l.rasterInfo.pixelType.toLowerCase()];i=e[0],a=e[1]}if(1===s.bandCount||1===(null==(n=l.bandIds)?void 0:n.length))return this._getStretchLegendElements(e,{min:i,max:a});function d(e){var t;const n=(null!=l&&null!=(t=l.bandIds)&&t.length?l.bandIds:Array.from(Array(Math.min(s.bandCount,3)).keys())).map((t=>e&&e[t]&&e[t].BandName||"band"+(t+1)));return n.length<3?n.push(n[1]):n.length>3&&n.splice(3),n}return o=u&&u.length>=r?d(u):d(),this._createSymbolTableElementMultiBand(o)},r._getStretchLegendElements=function(e,t){const n=e.colorRamp,l=D.getStrectchRampStops(n,t);return{type:"stretch-ramp",title:"",infos:l,preview:z.renderColorRampPreviewHTML(l.map((e=>e.color)))}},r._createSymbolTableElementMultiBand=function(e){const t=[],n=["red","green","blue"];return e.forEach(((e,l)=>{t.push({label:{colorName:n[l],bandName:e},src:P.RGB_IMG_SOURCE[l],opacity:1})})),t},r._updateInfosforClassedSizeRenderer=function(e,t){const n=e.authoringInfo&&"class-breaks-size"===e.authoringInfo.type,l=e.classBreakInfos.some((e=>F.isVolumetricSymbol(e.symbol)));if(n&&l){const n=k.REAL_WORLD_MAX_SIZE,l=k.REAL_WORLD_MIN_SIZE,s=e.classBreakInfos.length,r=(n-l)/(s>1?s-1:s);t.forEach(((e,t)=>{e.size=n-r*t}))}},r._isTallSymbol=function(e){let t=!1,n=!1;if(e)for(let l=0;l<e.length&&(!t||!n);l++){const s=e[l];"size"===s.type&&("height"===s.axis&&(t=!0),"width-and-depth"===s.axis&&(n=!0))}return t&&n},r._getSymbolPreview=async function(t,n,l){let s=null==t.size&&this._hasSizeRamp?b.px2pt(22):t.size;if(this._scaleDrivenSizeVariable&&null!=l&&l.applyScaleDrivenSize){const{getSize:n}=await new Promise((function(t,n){e(["../../../renderers/visualVariables/support/visualVariableUtils"],t,n)}));s=n(this._scaleDrivenSizeVariable,null,{view:this.view.type,scale:this.scale,shape:"simple-marker"===t.symbol.type?t.symbol.style:null})}return z.renderPreviewHTML(t.symbol,{size:s,opacity:n,scale:!1,symbolConfig:null==l?void 0:l.symbolConfig}).then((e=>(t.preview=e,t))).catch((()=>(t.preview=null,t)))},r._loadRenderer=async function(e){var t,n;const l=[],r=this.layer;e=e.clone(),this._hasClusterSizeVariable=!1;const i="visualVariables"in e&&(null==(t=e.visualVariables)?void 0:t.some((e=>"size"===e.type&&"outline"!==e.target&&!G.test(e.valueExpression))));if(e&&"visualVariables"in e&&!i&&"featureReduction"in r&&"cluster"===(null==(n=r.featureReduction)?void 0:n.type)){const t=this.layerView._effectiveRenderer,n=s.unwrap(x.getClusterSizeVariable(t,this.view));if(n){const t=r.featureReduction;if("clusterMinSize"in t&&"clusterMaxSize"in t){const{clusterMinSize:e,clusterMaxSize:l}=t;n.legendOptions=new R({showLegend:e!==l})}const l=e.visualVariables||[];e.visualVariables=l.concat([n]),this._hasClusterSizeVariable=!0}}const a=await this._getMedianColor(e);if(ee(e)||te(e)){const t=(e.classBreakInfos||e.uniqueValueInfos).map((e=>this._fetchSymbol(e.symbol,a).then((t=>{e.symbol=t})).catch((()=>{e.symbol=null}))));Array.prototype.push.apply(l,t)}return l.push(this._fetchSymbol(e.symbol||e.defaultSymbol,e.defaultSymbol?null:a).then((t=>{this._applySymbolToRenderer(e,t,Y(e))})).catch((()=>{this._applySymbolToRenderer(e,null,Y(e))}))),h.eachAlways(l).then((()=>e))},r._applySymbolToRenderer=function(e,t,n){n?e.symbol=t:e.defaultSymbol=t},r._getMedianColor=async function(t){if(!("visualVariables"in t)||!t.visualVariables)return null;const n=t.visualVariables.find((e=>"color"===e.type));if(!n)return null;let l=null,s=null;if(n.stops){if(1===n.stops.length)return n.stops[0].color;l=n.stops[0].value,s=n.stops[n.stops.length-1].value}const r=l+(s-l)/2,{getColor:i}=await new Promise((function(t,n){e(["../../../renderers/visualVariables/support/visualVariableUtils"],t,n)}));return i(n,r)},r._fetchSymbol=function(e,t){if(!e)return Promise.reject();if("web-style"===e.type){const n=e.portal,l=n&&n.url,s=n&&n.user&&n.user.username,r=e.name+"-"+e.styleName+"-"+e.styleUrl+"-"+l+"-"+s,i=this._webStyleSymbolCache;return i.has(r)||("2d"===this.view.type?i.set(r,e.fetchCIMSymbol()):i.set(r,e.fetchSymbol())),i.get(r).then((e=>this._getAppliedCloneSymbol(e,t))).catch((()=>(B.warn("Fetching web-style failed!"),Promise.reject())))}return Promise.resolve(this._getAppliedCloneSymbol(e,t))},r._getAppliedCloneSymbol=function(e,t){if(!e||!t)return e;const n=e.clone(),l=t&&t.toRgba();return n.type.indexOf("3d")>-1?this._applyColorTo3dSymbol(n,l):"cim"===n.type?I.applyCIMSymbolColor(n,t):n.color&&(n.color=new g(l||n.color)),n},r._applyColorTo3dSymbol=function(e,t){t&&e.symbolLayers.forEach((e=>{e&&(e.material||(e.material={}),e.material.color=new g(t))}))},r._getVisualVariableLegendElements=async function(e,t){if(!("visualVariables"in e)||!e.visualVariables||"vector-field"===e.type)return null;const n=e.visualVariables,l=[],r=[],i=[];for(const s of n)"color"===s.type?l.push(s):"size"===s.type?r.push(s):"opacity"===s.type&&i.push(s);const a=[...l,...r,...i];let o,u;if(0===l.length&&ee(e)&&e.classBreakInfos&&1===e.classBreakInfos.length){const t=e.classBreakInfos[0];o=t&&t.symbol}if(0===l.length&&Y(e)&&(o=e.symbol),o)if(o.type.indexOf("3d")>-1){const e=o.symbolLayers.getItemAt(0);"water"===e.type?s.isSome(e.color)&&(u=e.color):s.isSome(e.material)&&s.isSome(e.material.color)&&(u=e.material.color)}else o.url||(u=o.color);return(await Promise.all(a.map((async n=>{if(!n.legendOptions||!1!==n.legendOptions.showLegend){const l=this._getRampTitle(n,t);let s=null;const r="getField"in t&&t.getField&&t.getField(n.field),i=r&&f.isDateField(r);if("color"===n.type){const e=await D.getRampStops(n,null,i);s={type:"color-ramp",title:l,infos:e,preview:z.renderColorRampPreviewHTML(e.map((e=>e.color)))},this._hasColorRamp||(this._hasColorRamp=!(null==s.infos||!s.infos.length))}else if("size"===n.type&&"outline"!==n.target)G.test(n.valueExpression)?this._hasClusterSizeVariable||(this._scaleDrivenSizeVariable=n):(s={type:"size-ramp",title:this._hasClusterSizeVariable?this._getClusterTitle(n):l,infos:await k.getRampStops(e,n,await this._getMedianColor(e),this.scale,this.view.type,i)},this._hasSizeRamp||(this._hasSizeRamp=!(null==s.infos||!s.infos.length)));else if("opacity"===n.type){const e=await D.getRampStops(n,u,i);s={type:"opacity-ramp",title:l,infos:e,preview:z.renderColorRampPreviewHTML(e.map((e=>e.color)))},this._hasOpacityRamp||(this._hasOpacityRamp=!(null==s.infos||!s.infos.length))}return s&&s.infos?s:null}})))).filter((e=>!!e))},r._getDomainName=function(e,t,n){if(e&&"function"!=typeof e){const l="getField"in n&&n.getField&&n.getField(e),s=l&&"getFieldDomain"in n&&n.getFieldDomain?n.getFieldDomain(l.name):null;return s&&"coded-value"===s.type?s.getName(t):null}return null},r._getClusterTitle=function(e){const t=this.layer,n=e.field;if("featureReduction"in t&&t.featureReduction&&"cluster"===t.featureReduction.type){const e=t.featureReduction,l="popupTemplate"in e&&e.popupTemplate,s=l&&l.fieldInfos;if(s)for(const t of s)if(t.fieldName===n)return"cluster_count"===n?t.label||{showCount:!0}:t.label}return{showCount:!0}},r._getRampTitle=function(e,t){let n=e.field,l=e.normalizationField,s=!1,r=!1,i=!1,a=null;n="function"==typeof n?null:n,l="function"==typeof l?null:l;const o=e.legendOptions&&e.legendOptions.title;if(null!=o)a=o;else if(e.valueExpressionTitle)a=e.valueExpressionTitle;else{if("renderer"in t&&t.renderer&&"authoringInfo"in t.renderer&&t.renderer.authoringInfo&&t.renderer.authoringInfo.visualVariables){const e=t.renderer.authoringInfo.visualVariables;for(let t=0;t<e.length;t++){const n=e[t];if("color"===n.type){if("ratio"===n.style){s=!0;break}if("percent"===n.style){r=!0;break}if("percent-of-total"===n.style){i=!0;break}}}}a={field:n&&this._getFieldAlias(n,t),normField:l&&this._getFieldAlias(l,t),ratio:s,ratioPercent:r,ratioPercentTotal:i}}return a},r._getRendererTitle=function(e,t){const n=e;if(n.legendOptions&&n.legendOptions.title)return n.legendOptions.title;if(n.valueExpressionTitle)return n.valueExpressionTitle;let l=n.field,s=null,r=null;ee(n)&&(s=n.normalizationField,r="percent-of-total"===n.normalizationType),l="function"==typeof l?null:l,s="function"==typeof s?null:s;let i=null;return(l||s)&&(i={field:l&&this._getFieldAlias(l,t),normField:s&&this._getFieldAlias(s,t),normByPct:r}),i},r._getFieldAlias=function(e,t){const n="popupTemplate"in t&&t.popupTemplate,l=n&&n.fieldInfos;let s=null;l&&l.some((t=>e===t.fieldName&&(s=t,!0)));let r=null;"getField"in t&&t.getField?r=t.getField(e):"fieldsIndex"in t&&t.fieldsIndex&&(r=t.fieldsIndex.get(e));const i=s||r;let a=null;return i&&(a=s&&s.label||r&&r.alias||"name"in i&&i.name||"fieldName"in i&&i.fieldName),a},r._isUnclassedRenderer=function(e){const t=e.visualVariables;let n=!1;return ee(e)&&e.classBreakInfos&&1===e.classBreakInfos.length&&t&&(n=e.field?t.some((t=>!(!t||e.field!==t.field||(e.normalizationField||t.normalizationField)&&e.normalizationField!==t.normalizationField))):!!t.length),n},t._createClass(l,[{key:"opacity",get:function(){var e;const t=this.layer.opacity,n=null==(e=this.parent)?void 0:e.opacity,l=this.layer.parent,s=l&&"uid"in l?this._getParentLayerOpacity(l):null;return null!=n?n*t:null!=s?s*t:t}},{key:"ready",get:function(){return null===this.layer||(this.children.length>0?this._isGroupActive():this.legendElements.length>0)}},{key:"scale",get:function(){return this.view&&this.view.scale}},{key:"isScaleDriven",get:function(){const e=this.layer;if(null===e)return!1;if("featureReduction"in e&&e.featureReduction&&"cluster"===e.featureReduction.type)return!0;if("renderer"in e&&e.renderer){if("dot-density"===e.renderer.type)return!0;const t=e.get("renderer.valueExpression");if(G.test(t))return!0;const n=e.get("renderer.visualVariables");if(n)return n.some((e=>this._isScaleDrivenSizeVariable(e)))}return this._isLayerScaleDriven(this.layer)}},{key:"version",get:function(){return this._get("version")+1}}]),l}(p);return n.__decorate([a.property()],Ee.prototype,"children",void 0),n.__decorate([a.property()],Ee.prototype,"layerView",void 0),n.__decorate([a.property()],Ee.prototype,"layer",void 0),n.__decorate([a.property()],Ee.prototype,"legendElements",void 0),n.__decorate([a.property({readOnly:!0})],Ee.prototype,"opacity",null),n.__decorate([a.property()],Ee.prototype,"parent",void 0),n.__decorate([a.property({readOnly:!0,dependsOn:[]})],Ee.prototype,"ready",null),n.__decorate([a.property()],Ee.prototype,"keepCacheOnDestroy",void 0),n.__decorate([a.property()],Ee.prototype,"respectLayerVisibility",void 0),n.__decorate([a.property({readOnly:!0})],Ee.prototype,"scale",null),n.__decorate([a.property()],Ee.prototype,"sublayerIds",void 0),n.__decorate([a.property({readOnly:!0})],Ee.prototype,"isScaleDriven",null),n.__decorate([a.property()],Ee.prototype,"title",void 0),n.__decorate([a.property({readOnly:!0,dependsOn:["ready"],value:0})],Ee.prototype,"version",null),n.__decorate([a.property()],Ee.prototype,"view",void 0),Ee=n.__decorate([u.subclass("esri.widgets.Legend.support.ActiveLayerInfo")],Ee),Ee}));
