/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["require","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../Color","../../../kernel","../../../request","../../../symbols","../../../core/Accessor","../../../core/Collection","../../../core/Handles","../../../core/jsonMap","../../../core/Logger","../../../core/maybe","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/screenUtils","../../../core/urlUtils","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../../core/accessorSupport/PropertyOrigin","../../../layers/effects/EffectView","../../../layers/effects/jsonUtils","../../../layers/support/ExportImageParameters","../../../layers/support/fieldUtils","../../../renderers/support/jsonUtils","../../../renderers/support/rendererConversion","../../../renderers/visualVariables/support/SizeVariableLegendOptions","../../../symbols/support/cimSymbolUtils","../../../symbols/support/previewUtils","../../../symbols/support/renderUtils","../../../symbols/support/symbolUtils","../../../symbols/support/utils","./clusterUtils","./colorRampUtils","./heatmapRampUtils","./relationshipRampUtils","./sizeRampUtils","./utils","../../smartMapping/support/utils","../../../symbols/SimpleMarkerSymbol","../../../symbols/SimpleFillSymbol"],(function(e,t,n,r,l,i,s,a,o,u,c,d,y,h,f,p,m,g,b,_,S,v,L,w,C,E,R,I,T,F,V,z,P,x,D,O,A,M,k,G,B,N,U){"use strict";const q="https://utility.arcgis.com/sharing/tools/legend",$="esri.layers.ImageryLayer",W="esri.layers.ImageryTileLayer",H="esri.layers.WCSLayer",j=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i,J=new c.JSONMap({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"}),Q={u1:[0,1],u2:[0,3],u4:[0,15],u8:[0,255],s8:[-128,127],u16:[0,65535],s16:[-32768,32767],u32:[0,4294967295],s32:[-2147483648,2147483647],f32:[-34e38,34e38],f64:[-Number.MAX_VALUE,Number.MAX_VALUE]},X=new N({size:6,outline:{color:[128,128,128,.5],width:.5}}),Z=new U({style:"solid"});function K(e){return"flow"===e.type}function Y(e){return"vector-field"===e.type}function ee(e){return"raster-colormap"===e.type}function te(e){return"raster-stretch"===e.type}function ne(e){return"raster-shaded-relief"===e.type}function re(e){return"esri.renderers.SimpleRenderer"===e.declaredClass}function le(e){return"esri.renderers.ClassBreaksRenderer"===e.declaredClass}function ie(e){return"esri.renderers.UniqueValueRenderer"===e.declaredClass}function se(e){return"esri.renderers.HeatmapRenderer"===e.declaredClass}function ae(e){return ue(e)||ce(e)||de(e)||oe(e)}function oe(e){return"esri.renderers.PointCloudRGBRenderer"===e.declaredClass}function ue(e){return"esri.renderers.PointCloudClassBreaksRenderer"===e.declaredClass}function ce(e){return"esri.renderers.PointCloudStretchRenderer"===e.declaredClass}function de(e){return"esri.renderers.PointCloudUniqueValueRenderer"===e.declaredClass}function ye(e){return"esri.renderers.DotDensityRenderer"===e.declaredClass}function he(e){return"esri.renderers.PieChartRenderer"===e.declaredClass}function fe(e,t){return re(e)||le(e)||ie(e)||se(e)||ye(e)||he(e)?"2d"===t.type||I.isSupportedRenderer3D(e):te(e)||ee(e)||ne(e)||ue(e)||ce(e)||de(e)||Y(e)||K(e)}function pe(e){return"esri.layers.BuildingSceneLayer"===e.declaredClass}function me(e){return"esri.layers.SubtypeGroupLayer"===e.declaredClass}function ge(e){return"esri.layers.VoxelLayer"===e.declaredClass}function be(e){return"esri.layers.WMSLayer"===e.declaredClass}function _e(e){return"esri.layers.WMTSLayer"===e.declaredClass}function Se(e){return"esri.layers.MapImageLayer"===e.declaredClass}function ve(e){return"esri.layers.TileLayer"===e.declaredClass}function Le(e){return"esri.layers.FeatureLayer"===e.declaredClass}function we(e){return e.declaredClass===$}function Ce(e){return e.declaredClass===W}function Ee(e){return e.declaredClass===H}function Re(e){return"stretch-ramp"===e.type}function Ie(e){return"univariate-color-size"===("authoringInfo"in e&&e?.authoringInfo)?.type}function Te(e){const t="authoringInfo"in e&&e?.authoringInfo;return"univariate-color-size"===t?.type&&"above-and-below"===t?.univariateTheme}const Fe=new N({style:"path",path:"M10,5 L5,0 0,5 M5,0 L5,15",size:15,outline:{width:1,color:[85,85,85,1]}});let Ve={},ze=function(n){function s(e){var t;return(t=n.call(this,e)||this)._handles=new u,t._hasColorRamp=!1,t._hasOpacityRamp=!1,t._hasSizeRamp=!1,t._webStyleSymbolCache=new Map,t._dotDensityUrlCache=new Map,t._scaleDrivenSizeVariable=null,t._hasClusterSizeVariable=!1,t.children=new o,t.layerView=null,t.layer=null,t.legendElements=[],t.parent=null,t.hideLayersNotInCurrentView=!1,t.keepCacheOnDestroy=!1,t.respectLayerVisibility=!0,t.sublayerIds=[],t.title=null,t.view=null,t}t._inheritsLoose(s,n);var a=s.prototype;return a.initialize=function(){const e=()=>this.notifyChange("ready");this._handles.add([f.on((()=>this.children),"change",(t=>{const{added:n,removed:r}=t,l=this._handles;n.forEach((t=>{const n=`activeLayerInfo-ready-watcher-${t.layer.uid}`;l.add(f.watch((()=>t.ready),e,f.initial),n)})),r.forEach((e=>l.remove(e.layer.uid))),e()}))]),this.keepCacheOnDestroy||(Ve={})},a.destroy=function(){this._handles.destroy(),this._handles=null,this._webStyleSymbolCache=null,this._dotDensityUrlCache=null,this._scaleDrivenSizeVariable=null,this.keepCacheOnDestroy||(Ve=null)},a.buildLegendElementsForFeatureCollections=function(){var e=t._asyncToGenerator((function*(e){if(!(!this.hideLayersNotInCurrentView||(yield this._isLayerInCurrentView())))return this.legendElements=[],void this.notifyChange("ready");const t=Array.from(e,(e=>{if(Le(e))return this._getRendererLegendElements(e.renderer,{title:e.title});if(e.featureSet&&e.featureSet.features.length){const t=e.layerDefinition,n=t&&t.drawingInfo,r=n&&R.fromJSON(n.renderer),l=J.read(t.geometryType);return r?this._getRendererLegendElements(r,{title:e.name,geometryType:l}):(d.getLogger(this.declaredClass).warn("drawingInfo not available!"),null)}return null}));try{const e=[];yield h.eachAlways(t).then((t=>{t.forEach((({value:t})=>t&&e.push(...t)))})),this.legendElements=e,this.notifyChange("ready")}catch(n){d.getLogger(this.declaredClass).warn("error while building legend for layer!",n)}}));function n(t){return e.apply(this,arguments)}return n}(),a.buildLegendElementsForRenderer=function(){var e=t._asyncToGenerator((function*(e){try{const t=!this.hideLayersNotInCurrentView||(yield this._isLayerInCurrentView());this.legendElements=t?yield this._getRendererLegendElements(e):[],this.notifyChange("ready")}catch(t){d.getLogger(this.declaredClass).warn("error while building legend for layer!",t)}}));function n(t){return e.apply(this,arguments)}return n}(),a.buildLegendElementsForFeatureReduction=function(){var e=t._asyncToGenerator((function*(e){try{const t=!this.hideLayersNotInCurrentView||(yield this._isLayerInCurrentView());this.legendElements=t?yield this._getLegendElementsForFeatureReduction(e):[],this.notifyChange("ready")}catch(t){d.getLogger(this.declaredClass).warn("error while building legend for layer!",t)}}));function n(t){return e.apply(this,arguments)}return n}(),a.buildLegendElementsForTools=function(){var e=t._asyncToGenerator((function*(){var e=this;const n=this.layer;if(ge(n))this._constructLegendElementsForVoxellayer();else if(_e(n))this._constructLegendElementsForWMTSlayer();else if(be(n))yield this._constructLegendElementsForWMSSublayers();else if(pe(n))yield this._constructLegendElementsForBuildingSceneLayer();else if(Se(n)||ve(n)||me(n))yield this._constructLegendElementsForSublayers();else{this._handles.remove("imageryLayers-watcher");let r="default";if(we(n)){r=(n?.renderingRule?.functionName||"default")+"_"+(n.bandIds?.length?n.bandIds.join(""):"###")}yield this._getLegendLayers(`${n.uid}-${r}`).then(function(){var r=t._asyncToGenerator((function*(r){e.legendElements=[],e.notifyChange("ready");const l=r.map(function(){var r=t._asyncToGenerator((function*(r){if(we(n)||Ce(n)){const r=f.watch((()=>["renderingRule"in n&&n.renderingRule,n.bandIds]),(()=>h.debounce(t._asyncToGenerator((function*(){Ve.default=null,n.renderer?yield e.buildLegendElementsForRenderer(n.renderer):yield e.buildLegendElementsForTools()})))()));e._handles.add(r,"imageryLayers-watcher")}const l=e._generateSymbolTableElementForLegendLayer(r);l&&l.infos.length&&(we(n)&&(l.title=n.title),e.legendElements.push(l)),e.notifyChange("ready")}));return function(e){return r.apply(this,arguments)}}());yield h.eachAlways(l)}));return function(e){return r.apply(this,arguments)}}()).catch((e=>{d.getLogger(this.declaredClass).warn("Request to server for legend has failed!",e)}))}}));function n(){return e.apply(this,arguments)}return n}(),a._isLayerInCurrentView=function(){var e=t._asyncToGenerator((function*(){const e=this.layer,t=this.layerView,n=t&&"createQuery"in t&&"queryFeatureCount"in t;if(!n&&!(t&&"createQuery"in e&&"queryFeatureCount"in e))return!0;yield f.whenOnce((()=>!t.updating));const r=n?"createQuery"in t&&t.createQuery():"createQuery"in e&&e.createQuery();r.geometry=this.view.extent;return 0!==(n?"queryFeatureCount"in t&&(yield t.queryFeatureCount(r)):"queryFeatureCount"in e&&(yield e.queryFeatureCount(r)))}));function n(){return e.apply(this,arguments)}return n}(),a._getParentLayerOpacity=function(e){let t=1;const n=e.parent;return n&&"uid"in n&&(t=this._getParentLayerOpacity(n)),e.opacity*t},a._isGroupActive=function(){const e=this.children;return!!e.length&&e.some((e=>e.ready))},a._isRendererScaleDriven=function(e){if("dot-density"===e.type)return!0;const t="valueExpression"in e&&e.valueExpression;if(j.test(t))return!0;const n="visualVariables"in e&&e.visualVariables;return!!n&&n.some((e=>this._isScaleDrivenSizeVariable(e)))},a._isScaleDrivenSizeVariable=function(e){if(e&&"size"!==e.type)return!1;const t=e,n=t.minSize,r=t.maxSize;return"object"==typeof n&&n?this._isScaleDrivenSizeVariable(n):"object"==typeof r&&r?this._isScaleDrivenSizeVariable(r):!!t.expression||j.test(t.valueExpression)},a._isLayerScaleDriven=function(e){if("minScale"in e&&e.minScale>0||"maxScale"in e&&e.maxScale>0)return!0;if("sublayers"in e&&e.sublayers)return e.sublayers.some((e=>this._isLayerScaleDriven(e)));const t=e.parent;if(!1===e.loaded&&t&&Se(t)&&"source"in e&&e.source&&"map-layer"===e.source.type)for(const n of t.sourceJSON.layers)if(n.id===e.source.mapLayerId&&(n.minScale>0||n.maxScale>0))return!0;return!1},a._constructLegendElementsForVoxellayer=function(){var e=t._asyncToGenerator((function*(){this.legendElements=[],this._handles.remove("voxel-style-watcher"),this._handles.remove("voxel-current-variable");const e=this.layer;this._handles.add(f.watch((()=>e.currentVariableId),(()=>this._constructLegendElementsForVoxellayer())),"voxel-current-variable"),this._handles.add(f.watch((()=>e.getVariableStyles()),(()=>this._constructLegendElementsForVoxellayer())),"voxel-style-watcher");const t=y.unwrap(e.getVariableStyle(null)),n=[];if(t)if(t.uniqueValues?.length){const e=[];t.uniqueValues.forEach((t=>{t.enabled&&e.push({label:t.label||`${t.value}`,value:t.value,symbol:new U({color:t.color,outline:null})})})),e.length&&n.push({type:"symbol-table",title:t.label,infos:e})}else if(t.transferFunction){const{colorStops:e,stretchRange:r}=t.transferFunction,l=e.toArray().reverse(),i=r.map(((e,t)=>`${0===t?G.SPECIAL_CHARS_LESS_THAN:G.SPECIAL_CHARS_GREATER_THAN} ${B.formatNumberLabel(e)}`)).reverse(),s=l.map((e=>({color:e.color,value:null,label:null})));s[0].label=i[0],s[s.length-1].label=i[1],n.push({type:"color-ramp",title:t.label,infos:s,preview:P.renderColorRampPreviewHTML(l.map((e=>e.color)))})}const r=e.opacity,l=n.reduce(((e,t)=>e.concat(this._getAllInfos(t))),[]).filter((e=>!!e?.symbol)).map((e=>this._getSymbolPreview(e,r)));yield h.eachAlways(l),this.legendElements=n,this.notifyChange("ready")}));function n(){return e.apply(this,arguments)}return n}(),a._constructLegendElementsForWMTSlayer=function(){this.legendElements=[],this._handles.remove("wmts-activeLayer-watcher");const e=this.layer.activeLayer;if(this._handles.add(f.watch((()=>{const{layer:e}=this;return e&&"activeLayer"in e&&e.activeLayer}),(()=>this._constructLegendElementsForWMTSlayer())),"wmts-activeLayer-watcher"),e.styleId&&e.styles){let t=null;e.styles.some((n=>e.styleId===n.id&&(t=n.legendUrl,!0))),t&&(this.legendElements=[{type:"symbol-table",title:e.title,infos:[{src:t,opacity:this.opacity}]}])}this.notifyChange("ready")},a._constructLegendElementsForWMSSublayers=function(){var e=t._asyncToGenerator((function*(){this.legendElements=[],this._handles.remove("wms-sublayers-watcher");const e=this.layer;let t=null;(e.customParameters||e.customLayerParameters)&&(t={...e.customParameters,...e.customLayerParameters}),this._handles.add(f.watch((()=>{const{layer:e}=this;return e&&"sublayers"in e&&e.sublayers}),(()=>this._constructLegendElementsForWMSSublayers())),"wms-sublayers-watcher"),this.legendElements=yield this._generateLegendElementsForWMSSublayers(e.sublayers,t),this.notifyChange("ready")}));function n(){return e.apply(this,arguments)}return n}(),a._generateLegendElementsForWMSSublayers=function(){var e=t._asyncToGenerator((function*(e,t){const n=[];this._handles.add(e.on("change",(()=>this._constructLegendElementsForWMSSublayers())),"wms-sublayers-watcher");const r=e.toArray();for(const l of r){const e=f.watch((()=>[l.title,l.visible,l.legendEnabled]),(()=>this._constructLegendElementsForWMSSublayers()));if(this._handles.add(e,"wms-sublayers-watcher"),!this.respectLayerVisibility||l.visible&&l.legendEnabled){const e=yield this._generateSymbolTableElementForWMSSublayer(l,t);e&&e.infos.length&&n.unshift(e)}}return n}));function n(t,n){return e.apply(this,arguments)}return n}(),a._generateSymbolTableElementForWMSSublayer=function(){var e=t._asyncToGenerator((function*(e,t){if(!e.legendUrl&&e.sublayers){const n=(yield this._generateLegendElementsForWMSSublayers(e.sublayers,t)).filter((e=>e));return{type:"symbol-table",title:e.title,infos:n}}return this._generateSymbolTableElementForLegendUrl(e,t)}));function n(t,n){return e.apply(this,arguments)}return n}(),a._generateSymbolTableElementForLegendUrl=function(){var e=t._asyncToGenerator((function*(e,t){let n=e.legendUrl;if(!n)return;const r={type:"symbol-table",title:e.title||e.name||e.id&&e.id+"",infos:[]};t&&(n=m.addQueryParameters(n,t));let l=null;const s=e.layer?.opacity;try{l=(yield i(n,{responseType:"image"})).data,l&&(l.style.opacity=s)}catch{}return r.infos.push({src:n,preview:l,opacity:s}),r}));function n(t,n){return e.apply(this,arguments)}return n}(),a._getLegendLayers=function(e,t){const n=Ve&&Ve[e];return n?Promise.resolve(n):this._legendRequest(t).then((t=>{const n=t.layers;return Ve[e]=n,n}))},a._legendRequest=function(e){const t=this.layer;let n={f:"json",dynamicLayers:e};if(we(t)){const e=t.exportImageServiceParameters.renderingRule;if(e&&(n.renderingRule=JSON.stringify(e.rasterFunctionDefinition||e.toJSON())),t.bandIds&&(n.bandIds=t.bandIds.join()),t.raster||t.viewId||t.customParameters){const{raster:e,viewId:r,customParameters:l}=t;n={raster:e,viewId:r,...n,...l}}}let r=t.url.replace(/(\/)+$/,"");if("version"in t&&t.version>=10.01){const e=r.indexOf("?");e>-1?r=r.substring(0,e)+"/legend"+r.substring(e):r+="/legend"}else{const e=r.toLowerCase().indexOf("/rest/"),t=r.substring(0,e)+r.substring(e+5,r.length);r=q+"?soapUrl="+encodeURI(t)+"&returnbytes=true"}return i(r,{query:n}).then((e=>e.data))},a._constructLegendElementsForBuildingSceneLayer=function(){var e=t._asyncToGenerator((function*(){this.legendElements=[],this._handles.remove("sublayers-watcher");const e=this.layer;this._handles.add(f.watch((()=>e.sublayers),(()=>this._constructLegendElementsForBuildingSceneLayer())),"sublayers-watcher");try{this.legendElements=yield this._generateLegendElementsForBuildingSublayers(e.sublayers,this.opacity),this.notifyChange("ready")}catch(t){d.getLogger(this.declaredClass).warn("Request to server for legend has failed!",t)}}));function n(){return e.apply(this,arguments)}return n}(),a._generateLegendElementsForBuildingSublayers=function(){var e=t._asyncToGenerator((function*(e,t){let n=[];this._handles.add(e.on("change",(()=>this._constructLegendElementsForBuildingSceneLayer())),"sublayers-watcher");const r=e.toArray();for(const l of r){const e=f.watch((()=>["renderer"in l&&l.renderer,l.opacity,l.title,l.visible]),(()=>this._constructLegendElementsForBuildingSceneLayer()));if(this._handles.add(e,"sublayers-watcher"),!this.respectLayerVisibility||l.visible){const e=l&&null!=l.opacity?l.opacity:null,r=null!=e?e*t:t;if("building-group"===l.type){const e={type:"symbol-table",title:l.title,infos:[]},t=yield this._generateLegendElementsForBuildingSublayers(l.sublayers,r);e.infos.push(...t),n=[e,...n]}else if(l.renderer){n=[...yield this._getRendererLegendElements(l.renderer,{title:l.title,opacity:r,sublayer:l}),...n]}}}return n.filter((e=>!!e&&(!("infos"in e)||e.infos.length>0)))}));function n(t,n){return e.apply(this,arguments)}return n}(),a._constructLegendElementsForSublayers=function(){var e=t._asyncToGenerator((function*(){this.legendElements=[],this._handles.remove("sublayers-watcher");const e=this.layer;this._handles.add(f.watch((()=>e.sublayers),(()=>this._constructLegendElementsForSublayers)),"sublayers-watcher");try{this.legendElements=yield this._generateLegendElementsForSublayers(e.sublayers,this.opacity),this.notifyChange("ready")}catch(t){d.getLogger(this.declaredClass).warn("Request to server for legend has failed!",t)}}));function n(){return e.apply(this,arguments)}return n}(),a._generateLegendElementsForSublayers=function(){var e=t._asyncToGenerator((function*(e,t,n){const r=this.layer;let l=[];this._handles.add(e.on("change",(()=>this._constructLegendElementsForSublayers())),"sublayers-watcher");let i=e.toArray();!n&&this.sublayerIds&&this.sublayerIds.length&&(i=this.sublayerIds.map((e=>r.findSublayerById(e))).filter(Boolean));for(const s of i){const e=f.watch((()=>[s.renderer,s.opacity,s.title,s.visible,s.legendEnabled]),(()=>this._constructLegendElementsForSublayers()));if(this._handles.add(e,"sublayers-watcher"),!this.respectLayerVisibility||s.visible&&s.legendEnabled&&this._isSublayerInScale(s)){const e=s&&null!=s.opacity?s.opacity:null,i=null!=e?e*t:t,a=!!me(r)||s.originIdOf("renderer")>v.OriginId.SERVICE;if(s.renderer&&!s.sublayers&&a){yield s.load();l=[...yield this._getRendererLegendElements(s.renderer,{title:s.title,opacity:i,sublayer:s}),...l]}else{const e=yield this._generateSymbolTableElementForSublayer(s,i,n);e&&l.unshift(e)}}}return l.filter((e=>!!e&&(!("infos"in e)||e.infos.length>0)))}));function n(t,n,r){return e.apply(this,arguments)}return n}(),a._generateSymbolTableElementForSublayer=function(){var e=t._asyncToGenerator((function*(e,t,n){if(!n){n=new Map;const t=this.layer,r=e.source;let l=null;if(!(!r||"map-layer"===r.type&&r.mapLayerId===e.id&&(!r.gdbVersion||r.gdbVersion===("gdbVersion"in t&&t.gdbVersion)))||e.originIdOf("renderer")>v.OriginId.SERVICE||e.originIdOf("labelingInfo")>v.OriginId.SERVICE||e.originIdOf("labelsVisible")>v.OriginId.SERVICE){const e=new C.ExportImageParameters({layer:this.layer});l=e.hasDynamicLayers?e.dynamicLayers:null,e.destroy()}const i=l||`${t.uid}-default`;(yield this._getLegendLayers(i,l)).forEach((e=>n.set(e.layerId,e)))}const r=n.get(e.id);if((!r||r?.subLayerIds&&r.defaultVisibility)&&e.sublayers){const r=yield this._generateLegendElementsForSublayers(e.sublayers,t,n);return{type:"symbol-table",title:e.title,infos:r}}return this._generateSymbolTableElementForLegendLayer(r,e,t)}));function n(t,n,r){return e.apply(this,arguments)}return n}(),a._generateSymbolTableElementForLegendLayer=function(e,t,n){if(!e||!e.legend||this.respectLayerVisibility&&!this._isLegendLayerInScale(e,t))return null;const r=t?.renderer;let l=t?.title||e.layerName;if(r&&(!t||t?.originIdOf("renderer")>v.OriginId.SERVICE)){const e=t?.title||this._getRendererTitle(r,t);e&&(l&&"string"!=typeof e&&"title"in e&&(e.title=l),l=e)}const i={type:"symbol-table",title:l,legendType:e.legendType?e.legendType:null,infos:[]},s=t?this._sanitizeLegendForSublayer(e.legend.slice(),t):e.legend;return e.legendGroups?.length>0?e.legendGroups.forEach((t=>{const r={type:"symbol-table",title:t.heading,legendType:e.legendType?e.legendType:null,infos:this._generateSymbolTableElementInfosForLegendLayer(s.filter((e=>e.groupId===t.id)),e.layerId,n)};r.infos?.length>0&&i.infos.push(r)})):i.infos=this._generateSymbolTableElementInfosForLegendLayer(s,e.layerId,n),i.infos.length>0?i:null},a._generateSymbolTableElementInfosForLegendLayer=function(e,t,n){return e.map((e=>{let r=e.url;if(e.imageData&&e.imageData.length>0)r=`data:image/png;base64,${e.imageData}`;else{if(0===r.indexOf("http"))return null;r=l.addTokenParameter(`${this.layer.url}/${t}/images/${r}`)}return{label:e.label,src:r,opacity:n??this.opacity,width:e.width,height:e.height}})).filter((e=>!!e))},a._isSublayerInScale=function(e){const t=e.minScale||0,n=e.maxScale||0;return!(t>0&&t<this.scale||n>this.scale)},a._isLegendLayerInScale=function(e,t){const n=t||this.layer;let r=null,l=null,i=!0;return!n.minScale&&0!==n.minScale||!n.maxScale&&0!==n.maxScale?(0===e.minScale&&n.tileInfo&&(r=n.tileInfo.lods[0].scale),0===e.maxScale&&n.tileInfo&&(l=n.tileInfo.lods[n.tileInfo.lods.length-1].scale)):(r=Math.min(n.minScale,e.minScale)||n.minScale||e.minScale,l=Math.max(n.maxScale,e.maxScale)),(r>0&&r<this.scale||l>this.scale)&&(i=!1),i},a._sanitizeLegendForSublayer=function(e,t){if("version"in this.layer&&this.layer.version<10.1||0===e.length)return e;const n=t.renderer,r=e.some((e=>e.values));let l=null,i=null;return r&&e.some(((e,t)=>(e.values||(l=t,i=e,i.label||(i.label="others")),null!=i))),n?"unique-value"===n.type?i&&(e.splice(l,1),e.push(i)):"class-breaks"===n.type&&(i&&e.splice(l,1),e.reverse(),i&&e.push(i)):i&&(e.splice(l,1),e.push(i)),e},a._getRendererLegendElements=function(){var e=t._asyncToGenerator((function*(e,t={}){if(!fe(e,this.view))return d.getLogger(this.declaredClass).warn(`Renderer of type '${e.type}' not supported!`),[];if(ae(e))return this._constructPointCloudRendererLegendElements(e,t);if(ye(e))return this._constructDotDensityRendererLegendElements(e);const n=yield this._loadRenderer(e);return he(n)?this._constructPieChartRendererLegendElements(n):this._constructRendererLegendElements(n,t)}));function n(t){return e.apply(this,arguments)}return n}(),a._getLegendElementsForFeatureReduction=function(){var e=t._asyncToGenerator((function*(e){let t=null;return"binning"===e.type?t=e.renderer:"cluster"===e.type&&(t=this._getClusterRenderer(e)),t?this._getRendererLegendElements(t):[]}));function n(t){return e.apply(this,arguments)}return n}(),a._getPointCloudRendererTitle=function(e){return e.legendOptions&&e.legendOptions.title||e.field},a._constructPointCloudRendererLegendElements=function(e,t={}){const n=t.title,r=[];let l=null,i=null;if(ue(e))l={type:"symbol-table",title:n||this._getPointCloudRendererTitle(e),infos:[]},e.colorClassBreakInfos.forEach((e=>{l.infos.unshift({label:e.label||e.minValue+" - "+e.maxValue,value:[e.minValue,e.maxValue],symbol:this._getAppliedCloneSymbol(X,e.color)})}));else if(ce(e)){const t=e.stops;let r=null;if(t.length&&(1===t.length&&(r=t[0].color),!r)){const e=t[0].value,n=t[t.length-1].value;if(null!=e&&null!=n){const l=e+(n-e)/2;r=O.getColorFromPointCloudStops(l,t)}}l={type:"symbol-table",title:null,infos:[{label:null,value:null,symbol:this._getAppliedCloneSymbol(X,r||X.color)}]};const s=O.getRampStopsForPointCloud(e.stops);i={type:"color-ramp",title:n||this._getPointCloudRendererTitle(e),infos:s,preview:P.renderColorRampPreviewHTML(s.map((e=>e.color)))}}else de(e)&&(l={type:"symbol-table",title:n||this._getPointCloudRendererTitle(e),infos:[]},e.colorUniqueValueInfos.forEach((e=>{l.infos.push({label:e.label||e.values.join(", "),value:e.values.join(", "),symbol:this._getAppliedCloneSymbol(X,e.color)})})));l&&l.infos.length&&r.push(l),i&&i.infos.length&&r.push(i);const s=r.reduce(((e,t)=>e.concat(t.infos)),[]).filter((e=>!!e.symbol)).map((t=>this._getSymbolPreview(t,this.opacity,{symbolConfig:{applyColorModulation:!!e.colorModulation}})));return h.eachAlways(s).then((()=>r))},a._getElementInfoForDotDensity=function(e,t){const{backgroundColor:n,outline:r,dotSize:l}=e,i=this.effectList?.effects.map((e=>e.toJSON())),s=w.effectFunctionsFromJSON(i),a=l+"-"+t+"-"+n+"-"+(r&&JSON.stringify(r.toJSON()))+"-"+s,o=this._dotDensityUrlCache,u=o.has(a)?o.get(a):P.renderDotDensityPreviewHTML(e,t);o.set(a,u);const c={shape:{type:"image",x:0,y:0,width:u.width,height:u.height,src:u.src},fill:null,stroke:null,offset:[0,0]},d=z.renderSymbol([[c]],[u.width,u.height],{effectView:this.effectList});return{opacity:1,src:u.src,preview:d,width:u.width,height:u.height}},a._constructDotDensityRendererLegendElements=function(e){const t=e.calculateDotValue(this.view.scale),n=e.legendOptions&&e.legendOptions.unit,r={type:"symbol-table",title:{value:t&&Math.round(t),unit:n||""},infos:[]};return e.attributes.forEach((t=>{const n=this._getElementInfoForDotDensity(e,t.color);n.label=t.label||t.valueExpressionTitle||t.field,r.infos.push(n)})),Promise.resolve([r])},a._constructPieChartRendererLegendElements=function(){var e=t._asyncToGenerator((function*(e){const t=this.layer.opacity,n=[],r="Others",l=e.outline;e.attributes.forEach((e=>{const t=new N({color:e.color,outline:l}),r=e.label||e.valueExpressionTitle||e.field;n.push({label:r,symbol:t})}));const i=n.length?[...n]:[];if(e.othersCategory?.color&&0!==e.othersCategory?.threshold){const t=new N({color:e.othersCategory.color,outline:l});n.push({label:e.othersCategory.label||r,symbol:t})}if(e.defaultColor?.a){const t=new N({color:e.defaultColor,outline:l});n.push({label:e.defaultLabel,symbol:t})}const s=(yield this._getVisualVariableLegendElements(e,this.layer))||[];if(n.length){s.unshift({type:"symbol-table",title:null,infos:n});const t=i.filter((e=>e.label!==r)).map((e=>e.symbol.color)).filter(Boolean),a=P.renderPieChartPreviewHTML(t,{holePercentage:e.holePercentage,backgroundColor:e.backgroundFillSymbol?.color,effectList:this.effectList,outline:l});s.unshift({type:"pie-chart-ramp",title:this._getRendererTitle(e,this.layer),infos:n,preview:a})}const a=s.reduce(((e,t)=>e.concat(this._getAllInfos(t))),[]).filter((e=>!!e?.symbol&&!e?.preview)).map((e=>this._getSymbolPreview(e,t,{effectList:this.effectList})));return yield h.eachAlways(a),s}));function n(t){return e.apply(this,arguments)}return n}(),a._constructRendererLegendElements=function(){var e=t._asyncToGenerator((function*(e,t={}){const{title:n,sublayer:r}=t,l=r||this.layer;this._hasColorRamp=!1,this._hasOpacityRamp=!1,this._hasSizeRamp=!1,this._scaleDrivenSizeVariable=null;const i=(yield this._getVisualVariableLegendElements(e,l))||[],s={type:"symbol-table",title:n||this._getRendererTitle(e,l),infos:[]};let a=null,o=!1;const u=new Set;if(K(e)&&!this._hasSizeRamp){const t=yield G.getSymbolForFlowRenderer(e);s.infos.push({label:null,symbol:t})}else if(Ie(e)){let t=n;const r=Te(e)?"univariate-above-and-below-ramp":"univariate-color-size-ramp",l=i.findIndex((e=>"color-ramp"===e.type)),s=-1!==l?i.splice(l,1)[0]:null,a=i.findIndex((e=>"size-ramp"===e.type)),o=-1!==a?i.splice(a,1)[0]:null,u=[];s&&(t=s.title,u.push(s)),o&&(t=o.title,u.push(o)),u.length>0&&i.push({type:r,title:t,infos:u})}else if(se(e)){const t=A.getHeatmapRampStops(e);i.push({type:"heatmap-ramp",title:n||this._getRendererTitle(e,l),infos:t,preview:P.renderColorRampPreviewHTML(t.map((e=>e.color)),{effectList:this.effectList})})}else if(ie(e)){const t=e&&e.authoringInfo;if(t&&"relationship"===t.type){const{focus:n,numClasses:r,field1:a,field2:o}=t;if(r&&a&&o){const t=[a,o];let c=M.getRotationAngleForFocus(n)||0;for(const e of t){const{field:t,normalizationField:n,label:r}=e,i=r||{field:this._getFieldAlias(t,l),normField:n&&this._getFieldAlias(n,l)},a=Fe.clone();a.angle=c,s.infos.push({label:i,symbol:a}),u.add(a),c+=90}const d=M.getRelationshipRampElement({focus:n,numClasses:r,infos:e.uniqueValueInfos});i.unshift(d)}}else if(we(this.layer)||Ce(this.layer))e.uniqueValueInfos.forEach((e=>{e.symbol&&s.infos.push({label:e.label||e.value,value:e.value,symbol:e.symbol})}));else{const{field:t,field2:n,field3:r,fieldDelimiter:i,valueExpression:a}=e,o=!(!t&&!a||!n&&!r),u=[];if(e.uniqueValueGroups.forEach((e=>{const s={type:"symbol-table",title:e.heading,infos:[]};e.classes.forEach((e=>{const{symbol:u,values:c}=e;if(u){const d=[],y=[];for(const e of c){const{value:s,value2:u,value3:c}=e,h=[],f=[];(t||a)&&(h.push(s),f.push(this._getDomainName(t,s,l))),n&&(h.push(u),f.push(this._getDomainName(n,u,l))),r&&(h.push(c),f.push(this._getDomainName(r,c,l))),d.push(o?h.join(i||""):h[0]),y.push(f.join(" - "))}const h=d.join(", ");let f=e.label;if(!f){const e=y.filter(Boolean);f=e.length?e.join(", "):h}s.infos.push({label:f,value:h,symbol:u})}})),s.infos.length&&u.push(s)})),u.length){const e=u[0];1===u.length&&"title"in e&&!e.title?s.infos.push(...e.infos):s.infos.push(...u)}}e.defaultSymbol&&(s.infos.push({label:e.defaultLabel||"others",symbol:e.defaultSymbol}),o=!0)}else if(le(e)){a=this._isUnclassedRenderer(e);(!a||!this._hasSizeRamp)&&(e.classBreakInfos.forEach((e=>{e.symbol&&s.infos.unshift({label:e.label||(a?null:e.minValue+" - "+e.maxValue),value:[e.minValue,e.maxValue],symbol:e.symbol})})),a&&(s.title=null),this._updateInfosforClassedSizeRenderer(e,s.infos)),e.defaultSymbol&&!a&&(s.infos.push({label:e.defaultLabel||"others",symbol:e.defaultSymbol}),o=!0)}else if(te(e))if(Ce(this.layer)||Ee(this.layer)){const t=this._constructTileImageryStretchRendererElements(e);Re(t)?i.push(t):s.infos=t}else{const t=this.layer;let n,r;e.statistics&&e.statistics.length&&(n=null!=e.statistics[0].min?e.statistics[0].min:e.statistics[0][0],r=null!=e.statistics[0].max?e.statistics[0].max:e.statistics[0][1]);let l=[];const a=y.unwrap(t.renderingRule?yield t.generateRasterInfo(t.renderingRule):t.serviceRasterInfo),o=a.keyProperties.BandProperties,u=Q[t.rasterInfo.pixelType.toLowerCase()];1===a.bandCount||t.bandIds&&1===t.bandIds.length?(n=null!=n?n:a.statistics?a.statistics[t.bandIds[0]].min:u[0],r=null!=r?r:a.statistics?a.statistics[t.bandIds[0]].max:u[1],n||r?i.push(this._getStretchLegendElements(e,{min:n,max:r})):this._getServerSideLegend()):a.bandCount>=3?o&&o.length>=a.bandCount?t.bandIds&&3===t.bandIds.length?(l=t.bandIds.map((e=>o[e].BandName)),s.infos=this._createSymbolTableElementMultiBand(l)):"lerc"===t.format?(l=[0,1,2].map((e=>o[e].BandName)),s.infos=this._createSymbolTableElementMultiBand(l)):this._getServerSideLegend():"lerc"===t.format?(l=["band1","band2","band3"],s.infos=this._createSymbolTableElementMultiBand(l)):this._getServerSideLegend():this._getServerSideLegend()}else if(ee(e))e.colormapInfos.forEach((e=>{s.infos.push({label:e.label,value:e.value,symbol:this._getAppliedCloneSymbol(Z,e.color)})}));else if(re(e)){let n=e.symbol;switch(t.geometryType){case"point":n="pointSymbol"in l&&l.pointSymbol;break;case"polyline":n="lineSymbol"in l&&l.lineSymbol;break;case"polygon":n="polygonSymbol"in l&&l.polygonSymbol}const r=this._hasClusterSizeVariable&&this._getClusterSymbol()||!this._hasSizeRamp;e.symbol&&r&&s.infos.push({label:e.label,symbol:n})}else if(Y(e)){e.outputUnit&&(this.title="("+e.toJSON().outputUnit+")"),s.title=e.attributeField;const t=e.getClassBreakInfos();t?.length?t.forEach((e=>{s.infos.push({label:e.minValue+" - "+e.maxValue,symbol:e.symbol})})):s.infos.push({label:e.attributeField,symbol:e.getDefaultSymbol()})}else ne(e)&&i.push(this._getStretchLegendElements(e,{min:0,max:255}));const c=e.defaultSymbol;!c||o||re(e)||a&&!this._hasColorRamp&&!this._hasSizeRamp&&!this._hasOpacityRamp||i.push({type:"symbol-table",infos:[{label:e.defaultLabel||"others",symbol:c}]}),s.infos.length&&i.unshift(s);const d=null==t.opacity?this.opacity:t.opacity,f=this._isTallSymbol("visualVariables"in e&&e.visualVariables),p=we(this.layer)||Ce(this.layer),m=i.reduce(((e,t)=>e.concat(this._getAllInfos(t))),[]).filter((e=>!!e?.symbol)).map((e=>this._getSymbolPreview(e,d,{isDefault:e.symbol===c,applyScaleDrivenSize:!u.has(e.symbol),symbolConfig:{isTall:f,isSquareFill:p},effectList:u.has(e.symbol)?null:this.effectList})));return e=null,yield h.eachAlways(m),i}));function n(t){return e.apply(this,arguments)}return n}(),a._getServerSideLegend=function(){setTimeout((()=>this.buildLegendElementsForTools()),0)},a._getAllInfos=function(e){const t=e?.infos;return t?t.reduce(((e,t)=>e.concat(this._getAllInfos(t))),[]):[e]},a._constructTileImageryStretchRendererElements=function(e){const t=this.layer,n=t.rasterInfo,r=n.bandCount||e.statistics.length;let l,i,s=[];const a=n.keyProperties&&n.keyProperties.BandProperties,o=e?.statistics?.length?e.statistics:n?.statistics;if(o)l=void 0!==o[0].min?o[0].min:o[0][0],i=o[0].max||o[0][1];else{const e=Q[t.rasterInfo.pixelType.toLowerCase()];l=e[0],i=e[1]}if(t.hasStandardTime()&&(l=t.getStandardTimeValue(l),i=t.getStandardTimeValue(i)),1===n.bandCount||1===t.bandIds?.length)return this._getStretchLegendElements(e,{min:l,max:i});function u(e){const r=(t?.bandIds?.length?t.bandIds:Array.from(Array(Math.min(n.bandCount,3)).keys())).map((t=>e&&e[t]&&e[t].BandName||"band"+(t+1)));return r.length<3?r.push(r[1]):r.length>3&&r.splice(3),r}return s=a&&a.length>=r?u(a):u(),this._createSymbolTableElementMultiBand(s)},a._getStretchLegendElements=function(e,t){const n=e.colorRamp,r=O.getStrectchRampStops(n,t);return{type:"stretch-ramp",title:"",infos:r,preview:P.renderColorRampPreviewHTML(r.map((e=>e.color)))}},a._getClusterSymbol=function(){const e=this.layer,t="featureReduction"in e&&e.featureReduction,n=t&&"symbol"in t&&t.renderer;return n&&!0!==n?.authoringInfo?.isAutoGenerated?null:t&&"symbol"in t&&t.symbol},a._getSizeLegendElement=function(){var e=t._asyncToGenerator((function*(e,t,n,r){return{type:"size-ramp",title:this._hasClusterSizeVariable?this._getClusterTitle(t):e,infos:yield k.getRampStops(n,t,yield G.getMedianColor(n),this.scale,this.view.type,r,this._hasClusterSizeVariable?this._getClusterSymbol():null)}}));function n(t,n,r,l){return e.apply(this,arguments)}return n}(),a._createSymbolTableElementMultiBand=function(e){const t=[],n=["red","green","blue"];return e.forEach(((e,r)=>{t.push({label:{colorName:n[r],bandName:e},src:G.RGB_IMG_SOURCE[r],opacity:this.opacity??1})})),t},a._updateInfosforClassedSizeRenderer=function(e,t){const n=e.authoringInfo&&"class-breaks-size"===e.authoringInfo.type,r=e.classBreakInfos.some((e=>x.isVolumetricSymbol(e.symbol)));if(n&&r){const n=k.REAL_WORLD_MAX_SIZE,r=k.REAL_WORLD_MIN_SIZE,l=e.classBreakInfos.length,i=(n-r)/(l>1?l-1:l);t.forEach(((e,t)=>{e.size=n-i*t}))}},a._isTallSymbol=function(e){let t=!1,n=!1;if(e)for(let r=0;r<e.length&&(!t||!n);r++){const l=e[r];"size"===l.type&&("height"===l.axis&&(t=!0),"width-and-depth"===l.axis&&(n=!0))}return t&&n},a._getSymbolPreview=function(){var n=t._asyncToGenerator((function*(t,n,r){let l=!r?.isDefault&&null==t.size&&this._hasSizeRamp?p.px2pt(V.SymbolSizeDefaults.size):t.size;if(this._scaleDrivenSizeVariable&&r?.applyScaleDrivenSize){const{getSize:n}=yield new Promise(((t,n)=>e(["../../../renderers/visualVariables/support/visualVariableUtils"],t,n)));l=n(this._scaleDrivenSizeVariable,null,{view:this.view.type,scale:this.scale,shape:"simple-marker"===t.symbol.type?t.symbol.style:null})}return P.renderPreviewHTML(t.symbol,{size:l,opacity:n,scale:!1,symbolConfig:r?.symbolConfig,effectView:r?.effectList}).then((e=>(t.preview=e,t))).catch((()=>(t.preview=null,t)))}));function r(e,t,r){return n.apply(this,arguments)}return r}(),a._getClusterRenderer=function(e){this._hasClusterSizeVariable=!1;const t="renderer"in this.layer&&this.layer.renderer,n=e.renderer?.clone()||t?.clone(),r=y.unwrap(D.getClusterSizeVariable(this.layerView._effectiveRenderer,this.view));if(r&&"visualVariables"in n){const t=n.visualVariables?.some((e=>"size"===e.type&&"outline"!==e.target&&!j.test(e.valueExpression)));if(!t){if("clusterMinSize"in e&&"clusterMaxSize"in e){const{clusterMinSize:t,clusterMaxSize:n}=e;r.legendOptions=new T({showLegend:t!==n})}const t=n.visualVariables||[];n.visualVariables=t.concat([r]),this._hasClusterSizeVariable=!0}}return n},a._loadRenderer=function(){var e=t._asyncToGenerator((function*(e){const t=[],n=e.clone(),r=yield G.getMedianColor(n);if(le(n)||ie(n)){const e=(n.classBreakInfos||n.uniqueValueInfos).map((e=>this._fetchSymbol(e.symbol,r).then((t=>{e.symbol=t})).catch((()=>{e.symbol=null}))));Array.prototype.push.apply(t,e)}return t.push(this._fetchSymbol(n.symbol||n.defaultSymbol,n.defaultSymbol?null:r).then((e=>{this._applySymbolToRenderer(n,e,re(n))})).catch((()=>{this._applySymbolToRenderer(n,null,re(n))}))),h.eachAlways(t).then((()=>n))}));function n(t){return e.apply(this,arguments)}return n}(),a._applySymbolToRenderer=function(e,t,n){n?e.symbol=t:e.defaultSymbol=t},a._fetchSymbol=function(){var e=t._asyncToGenerator((function*(e,t){if(!e)throw new Error;if("web-style"===e.type){const n=this._webStyleSymbolCache;try{const r=yield"2d"===this.view.type?e.fetchCIMSymbol({cache:n}):e.fetchSymbol({cache:n});return this._getAppliedCloneSymbol(r,t)}catch{throw d.getLogger(this.declaredClass).warn("Fetching web-style failed!"),new Error}}return this._getAppliedCloneSymbol(e,t)}));function n(t,n){return e.apply(this,arguments)}return n}(),a._getAppliedCloneSymbol=function(e,t){if(!e||!t)return e;const n=e.clone(),l=t&&t.toRgba();return n.type.includes("3d")?this._applyColorTo3dSymbol(n,l):"cim"===n.type?F.applyCIMSymbolColor(n,t):n.color&&(n.color=new r(l||n.color)),n},a._applyColorTo3dSymbol=function(e,t){t&&e.symbolLayers.forEach((e=>{e&&(e.material||(e.material={}),e.material.color=new r(t))}))},a._getVisualVariableLegendElements=function(){var e=t._asyncToGenerator((function*(e,n){var r=this;if(!("visualVariables"in e)||!e.visualVariables||"vector-field"===e.type)return null;const l=e.visualVariables,i=[],s=[],a=[];for(const t of l)"color"===t.type?i.push(t):"size"===t.type?s.push(t):"opacity"===t.type&&a.push(t);const o=[...i,...s,...a];let u,c;if(0===i.length&&le(e)&&e.classBreakInfos&&1===e.classBreakInfos.length){const t=e.classBreakInfos[0];u=t&&t.symbol}if(0===i.length&&re(e)&&(u=e.symbol),u)if(u.type.includes("3d")){const e=u.symbolLayers.getItemAt(0);"water"===e.type?y.isSome(e.color)&&(c=e.color):y.isSome(e.material)&&y.isSome(e.material.color)&&(c=e.material.color)}else u.url||(c=u.color);const d=this.effectList;return(yield Promise.all(o.map(function(){var l=t._asyncToGenerator((function*(t){if(!t.legendOptions||!1!==t.legendOptions.showLegend){const l=K(e)?t.field:r._getRampTitle(t,n);let i=null;const s="getField"in n&&n.getField&&n.getField(t.field),a=s&&E.isDateField(s);if("color"===t.type){const e=yield O.getRampStops(t,null,a);i={type:"color-ramp",title:l,infos:e,preview:P.renderColorRampPreviewHTML(e.map((e=>e.color)),{effectList:d})},r._hasColorRamp||(r._hasColorRamp=!(null==i.infos||!i.infos.length))}else if("size"===t.type&&"outline"!==t.target)j.test(t.valueExpression)?r._hasClusterSizeVariable||(r._scaleDrivenSizeVariable=t):(i=yield r._getSizeLegendElement(l,t,e,a),r._hasSizeRamp||(r._hasSizeRamp=!(null==i.infos||!i.infos.length)));else if("opacity"===t.type){const e=yield O.getRampStops(t,c,a);i={type:"opacity-ramp",title:l,infos:e,preview:P.renderColorRampPreviewHTML(e.map((e=>e.color)),{effectList:d})},r._hasOpacityRamp||(r._hasOpacityRamp=!(null==i.infos||!i.infos.length))}return i&&i.infos?i:null}}));return function(e){return l.apply(this,arguments)}}()))).filter((e=>!!e))}));function n(t,n){return e.apply(this,arguments)}return n}(),a._getDomainName=function(e,t,n){if(e&&"function"!=typeof e){const r="getField"in n&&n.getField&&n.getField(e),l=r&&"getFieldDomain"in n&&n.getFieldDomain?n.getFieldDomain(r.name):null;return l&&"coded-value"===l.type?l.getName(t):null}return null},a._getClusterTitle=function(e){const t=this.layer,n=e.field;if("featureReduction"in t&&t.featureReduction&&"cluster"===t.featureReduction.type){const e=t.featureReduction,r="popupTemplate"in e&&e.popupTemplate,l=r&&r.fieldInfos;if(l)for(const t of l)if(t.fieldName===n)return"cluster_count"===n?t.label||{showCount:!0}:t.label}return{showCount:!0}},a._getRampTitle=function(e,t){let n=e.field,r=e.normalizationField,l=!1,i=!1,s=!1,a=null;n="function"==typeof n?null:n,r="function"==typeof r?null:r;const o=e.legendOptions&&e.legendOptions.title;if(null!=o)a=o;else if(e.valueExpressionTitle)a=e.valueExpressionTitle;else{if("renderer"in t&&t.renderer&&"authoringInfo"in t.renderer&&t.renderer.authoringInfo&&t.renderer.authoringInfo.visualVariables){const e=t.renderer.authoringInfo.visualVariables;for(let t=0;t<e.length;t++){const n=e[t];if("color"===n.type){if("ratio"===n.style){l=!0;break}if("percent"===n.style){i=!0;break}if("percent-of-total"===n.style){s=!0;break}}}}a={field:n&&this._getFieldAlias(n,t),normField:r&&this._getFieldAlias(r,t),ratio:l,ratioPercent:i,ratioPercentTotal:s}}return a},a._getRendererTitle=function(e,t){const n=e;if(n.legendOptions&&n.legendOptions.title)return n.legendOptions.title;if(n.valueExpressionTitle)return n.valueExpressionTitle;let r=n.field,l=null,i=null;if(le(n)&&(l=n.normalizationField,i="percent-of-total"===n.normalizationType),r="function"==typeof r?null:r,l="function"==typeof l?null:l,ie(n)){const{field2:e,field3:l,fieldDelimiter:i}=n;let s=r&&this._getFieldAlias(r,t);return e&&(s=`<${s}>${i}<${this._getFieldAlias(e,t)}>`,l&&(s=`${s}${i}<${this._getFieldAlias(l,t)}>`)),s}let s=null;return(r||l)&&(s={field:r&&this._getFieldAlias(r,t),normField:l&&this._getFieldAlias(l,t),normByPct:i}),s},a._getFieldAlias=function(e,t){const n="popupTemplate"in t&&t.popupTemplate,r=n&&n.fieldInfos;let l=null;r&&r.some((t=>e===t.fieldName&&(l=t,!0)));let i=null;"getField"in t&&t.getField?i=t.getField(e):"fieldsIndex"in t&&t.fieldsIndex&&(i=t.fieldsIndex.get(e));let s=null;const a="featureReduction"in t&&t.featureReduction;a&&(!l&&"popupTemplate"in a&&a.popupTemplate&&a.popupTemplate.fieldInfos&&a.popupTemplate.fieldInfos.some((t=>e?.toLowerCase()===t.fieldName?.toLowerCase()&&(l=t,!0))),"fields"in a&&a.fields&&(s=a.fields.find((t=>t.name?.toLowerCase()===e?.toLowerCase()))));const o=l||i||s;let u=null;return o&&(u=l?.label||i?.alias||s?.alias||"name"in o&&o.name||"fieldName"in o&&o.fieldName),u},a._isUnclassedRenderer=function(e){const t=e.visualVariables;let n=!1;return le(e)&&e.classBreakInfos&&1===e.classBreakInfos.length&&t&&(n=e.field?t.some((t=>!(!t||e.field!==t.field||(e.normalizationField||t.normalizationField)&&e.normalizationField!==t.normalizationField))):!!t.length),n},t._createClass(s,[{key:"effectList",get:function(){const e=this.layer;let t=null;return"effect"in e&&e.effect&&(t=new L.EffectView,t.effect=e.effect,t.endTransitions(),t.scale=this.scale),t}},{key:"opacity",get:function(){const e=this.layer.opacity,t=this.parent?.opacity,n=this.layer.parent,r=n&&"uid"in n?this._getParentLayerOpacity(n):null;return null!=t?t*e:null!=r?r*e:e}},{key:"ready",get:function(){return null===this.layer||(this.children.length>0?this._isGroupActive():this.legendElements.length>0)}},{key:"scale",get:function(){return this.view&&this.view.scale}},{key:"isScaleDriven",get:function(){const e=this.layer;if(null===e)return!1;if("effect"in e&&e.effect&&Array.isArray(e.effect))return!0;if("featureReduction"in e&&e.featureReduction){if("cluster"===e.featureReduction.type)return!0;if("binning"===e.featureReduction.type&&"renderer"in e.featureReduction&&e.featureReduction.renderer)return this._isRendererScaleDriven(e.featureReduction.renderer)}return"renderer"in e&&e.renderer?this._isRendererScaleDriven(e.renderer):this._isLayerScaleDriven(this.layer)}},{key:"version",get:function(){return this._get("version")+1}}]),s}(a);n.__decorate([g.property()],ze.prototype,"children",void 0),n.__decorate([g.property({readOnly:!0})],ze.prototype,"effectList",null),n.__decorate([g.property()],ze.prototype,"layerView",void 0),n.__decorate([g.property()],ze.prototype,"layer",void 0),n.__decorate([g.property()],ze.prototype,"legendElements",void 0),n.__decorate([g.property({readOnly:!0})],ze.prototype,"opacity",null),n.__decorate([g.property()],ze.prototype,"parent",void 0),n.__decorate([g.property({readOnly:!0,dependsOn:[]})],ze.prototype,"ready",null),n.__decorate([g.property()],ze.prototype,"hideLayersNotInCurrentView",void 0),n.__decorate([g.property()],ze.prototype,"keepCacheOnDestroy",void 0),n.__decorate([g.property()],ze.prototype,"respectLayerVisibility",void 0),n.__decorate([g.property({readOnly:!0})],ze.prototype,"scale",null),n.__decorate([g.property()],ze.prototype,"sublayerIds",void 0),n.__decorate([g.property({readOnly:!0})],ze.prototype,"isScaleDriven",null),n.__decorate([g.property()],ze.prototype,"title",void 0),n.__decorate([g.property({readOnly:!0,dependsOn:["ready"],value:0})],ze.prototype,"version",null),n.__decorate([g.property()],ze.prototype,"view",void 0),ze=n.__decorate([S.subclass("esri.widgets.Legend.support.ActiveLayerInfo")],ze);return ze}));
