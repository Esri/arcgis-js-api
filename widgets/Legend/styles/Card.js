/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import"../../../intl.js";import t from"../../../core/Handles.js";import{watch as s}from"../../../core/reactiveUtils.js";import{pt2px as i}from"../../../core/screenUtils.js";import{property as r}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/arrayUtils.js";import"../../../core/has.js";import"../../../core/accessorSupport/ensureType.js";import{subclass as a}from"../../../core/accessorSupport/decorators/subclass.js";import{renderSVG as o}from"../../../symbols/support/svgUtils.js";import{getCSSFilterFromEffectList as l}from"../../../symbols/support/utils.js";import n from"../../Widget.js";import{renderRelationshipRamp as c}from"./support/relationshipUtils.js";import{getUnivariateAboveAndBelowRampElements as d,getUnivariateSizeRampSize as p,getUnivariateColorRampSize as m,getUnivariateColorRampPreview as h,getUnivariateColorRampMargin as y,getUnivariateColorSizeRampElements as g}from"./support/univariateUtils.js";import{getTitle as _,attachToNode as v,isImageryStretchedLegend as u}from"../support/styleUtils.js";import{Heading as f,incrementHeadingLevel as b}from"../../support/Heading.js";import{accessibleHandler as w}from"../../support/decorators/accessibleHandler.js";import{messageBundle as L}from"../../support/decorators/messageBundle.js";import{tsx as C}from"../../support/jsxFactory.js";import{isRTL as x}from"../../support/widgetUtils.js";import{substitute as S}from"../../../intl/substitute.js";const R={activated:"esri-legend--card__carousel-indicator--activated",base:"esri-legend--card",stacked:"esri-legend--stacked",carouselTitle:"esri-legend--card__carousel-title",indicator:"esri-legend--card__carousel-indicator",intervalSeparator:"esri-legend--card__interval-separator",imageryLayerStretchedImage:"esri-legend--card__imagery-layer-image--stretched",imageLabel:"esri-legend--card__image-label",layerCaption:"esri-legend--card__layer-caption",labelElement:"esri-legend--card__label-element",layerRow:"esri-legend--card__layer-row",labelCell:"esri-legend--card__label-cell",message:"esri-legend--card__message",rampLabel:"esri-legend--card__ramp-label",section:"esri-legend--card__section",relationshipSection:"esri-legend--card__relationship-section",serviceCaptionText:"esri-legend--card__service-caption-text",serviceContent:"esri-legend--card__service-content",service:"esri-legend--card__service",groupLayer:"esri-legend--card__group-layer",groupLayerChild:"esri-legend--card__group-layer-child",symbol:"esri-legend--card__symbol",sizeRampRow:"esri-legend--card__size-ramp-row",symbolRow:"esri-legend--card__symbol-row",symbolCell:"esri-legend--card__symbol-cell",indicatorContainer:"esri-legend--card__carousel-indicator-container",intervalSeparatorsContainer:"esri-legend--card__interval-separators-container",relationshipLabelContainer:"esri-legend--card__relationship-label-container",labelContainer:"esri-legend--card__label-container",serviceCaptionContainer:"esri-legend--card__service-caption-container",symbolContainer:"esri-legend--card__symbol-container",sizeRampContainer:"esri-legend--card__size-ramp-container",sizeRampPreview:"esri-legend--card__size-ramp-preview",pieChartRampPreview:"esri-legend--card__pie-chart-ramp-preview",rampContainer:"esri-legend__ramps",sizeRampHorizontal:"esri-legend__size-ramp--horizontal",rampLabelsContainer:"esri-legend__ramp-labels",layerInfo:"esri-legend__layer-cell esri-legend__layer-cell--info",univariateAboveAndBelowColorRamp:"esri-univariate-above-and-below-ramp__color--card",hidden:"esri-hidden"},z=25,$=25,I=768,k=100;var A;!function(e){e.Auto="auto",e.Stack="stack",e.SideBySide="side-by-side"}(A||(A={}));const N="#ddd",j=window.devicePixelRatio;function E(e){if(e){if(e.type.includes("3d")){const t=e.symbolLayers&&e.symbolLayers.length;if(!t)return;const s=e.symbolLayers.getItemAt(t-1),i=s.resource&&s.resource.primitive;return"circle"===i||"cross"===i||"kite"===i||"sphere"===i||"cube"===i||"diamond"===i}{const t=e.style;return"circle"===t||"diamond"===t||"cross"===t}}}function F(e){if(e){if(e.type.includes("3d")){const t=e.symbolLayers&&e.symbolLayers.length;if(!t)return;const s=e.symbolLayers.getItemAt(t-1).get("resource.primitive");return"triangle"===s||"cone"===s||"tetrahedron"===s}return"triangle"===e.style}}let T=class extends n{constructor(e,s){super(e,s),this._handles=new t,this._hasIndicators=!1,this._selectedSectionName=null,this._sectionNames=[],this._sectionMap=new Map,this.activeLayerInfos=null,this.headingLevel=3,this.layout=A.Stack,this.messages=null,this.messagesCommon=null,this.type="card",this.view=null}initialize(){this.own(s((()=>this.activeLayerInfos),(e=>{this._handles.removeAll(),this._watchForSectionChanges(e)})))}destroy(){this._handles.destroy(),this._handles=null}render(){this._hasIndicators=this.layout===A.Auto&&this.view.container.clientWidth<=I||this.layout===A.Stack;const e=this.activeLayerInfos,t=e&&e.toArray().map((e=>this._renderLegendForLayer(e))).filter((e=>!!e));this._hasIndicators?this._selectedSectionName&&this._sectionNames.includes(this._selectedSectionName)||(this._selectedSectionName=this._sectionNames&&this._sectionNames[0]):this._selectedSectionName=null;const s=this._sectionNames.length,i=this._sectionNames.map(((e,t)=>{const i=S(this.messagesCommon.pagination.pageText,{index:t+1,total:s});return C("div",{key:e,role:"tab",id:e,"aria-label":i,"aria-controls":`${e}-panel`,"aria-selected":(this._selectedSectionName===e).toString(),tabIndex:this._selectedSectionName===e?0:-1,title:i,onclick:this._selectSection,onkeydown:this._focusSection,bind:this,class:this.classes(R.indicator,{[R.activated]:this._selectedSectionName===e}),"data-section-name":e})})),r=this._hasIndicators&&s>1?C("div",{class:R.indicatorContainer,key:"carousel-navigation",role:"tablist"},i):null,a=this._hasIndicators?this._sectionMap.get(this._selectedSectionName):t&&t.length?t:null,o={[R.stacked]:this._hasIndicators};return C("div",{class:this.classes(R.base,o)},a||C("div",{class:R.message},this.messages.noLegend),r)}_selectSection(e){const t=e.target.getAttribute("data-section-name");t&&(this._selectedSectionName=t)}_focusSection(e){switch(e.key){case"ArrowLeft":case"ArrowRight":this._switchSectionOnArrowPress(e);break;case"Enter":case" ":this._selectSection(e)}}_switchSectionOnArrowPress(e){const t=e.key,s="ArrowLeft"===t?-1:1,i=e.target.getAttribute("data-section-name"),r=this._sectionNames.indexOf(i),a=this._sectionNames;let o=null;-1!==r&&(a[r+s]?o=document.getElementById(a[r+s]):"ArrowLeft"===t?o=document.getElementById(a[a.length-1]):"ArrowRight"===t&&(o=document.getElementById(a[0])),o&&o.focus())}_watchForSectionChanges(e){if(this._generateSectionNames(),e){e.forEach((e=>{const t=`activeLayerInfo-${e.layer.uid}-version-change`;this._handles.remove(t),this._watchForSectionChanges(e.children),this._handles.add(s((()=>e.version),(()=>this._generateSectionNames())),t)}));const t="activeLayerInfos-collection-change";this._handles.remove(t),this._handles.add(e.on("change",(()=>this._watchForSectionChanges(e))),t)}}_generateSectionNames(){this._sectionNames.length=0,this._selectedSectionName=null,this.activeLayerInfos&&this.activeLayerInfos.forEach(this._generateSectionNamesForActiveLayerInfo,this)}_getSectionName(e,t,s){return`${this.id}${e.uid}-type-${t.type}-${s}`}_generateSectionNamesForActiveLayerInfo(e){e.children.forEach(this._generateSectionNamesForActiveLayerInfo,this),e.legendElements&&e.legendElements.forEach(((t,s)=>{this._sectionNames.push(this._getSectionName(e.layer,t,s))}))}_renderLegendForLayer(e){if(!e.ready)return null;if(e.children.length){const t=e.children.map((e=>this._renderLegendForLayer(e))).toArray();return C("div",{key:e.layer.uid,class:this.classes(R.service,R.groupLayer)},C("div",{class:R.serviceCaptionContainer},e.title),t)}{const t=e.legendElements;if(t&&!t.length)return null;const s=t.some((e=>"relationship-ramp"===e.type)),i=t.map(((t,i)=>this._renderLegendForElement(t,e,i,s))).filter((e=>!!e));if(!i.length)return null;const r={[R.groupLayerChild]:!!e.parent};return C("div",{key:e.layer.uid,class:this.classes(R.service,r)},C("div",{class:R.serviceCaptionContainer},C("div",{class:R.serviceCaptionText},e.title)),C("div",{class:R.serviceContent},i))}}_renderLegendForElement(e,t,s,i=!1){const r="color-ramp"===e.type,a="opacity-ramp"===e.type,o="size-ramp"===e.type,l=t.layer;let n=null;if("string"==typeof e.title)n=e.title;else if(e.title){const t=e.title,s=_(this.messages,t,r||a);n=t.title?`${t.title} (${s})`:s}const d=this._getSectionName(l,e,s),p=this._hasIndicators?C("div",null,C(f,{level:this.headingLevel,class:R.carouselTitle},t.title),C(f,{level:b(this.headingLevel),class:R.layerCaption},n)):n?C(f,{level:this.headingLevel,class:R.layerCaption},n):null,m=t.effectList;let h=null;if("symbol-table"===e.type){const s=e.infos.map(((s,i)=>this._renderLegendForElementInfo(s,t,e.legendType,i))).filter((e=>!!e));if(s.length){const e=s[0].properties.classes&&s[0].properties.classes[R.symbolRow],t={[R.labelContainer]:!e&&!i,[R.relationshipLabelContainer]:i};h=C("div",{class:this.classes(t)},s)}}else"color-ramp"===e.type||"opacity-ramp"===e.type||"heatmap-ramp"===e.type?h=this._renderLegendForRamp(e,l.opacity,m):o?h=this._renderSizeRamp(e,l.opacity):"pie-chart-ramp"===e.type?h=this._renderPieChartRamp(e):"relationship-ramp"===e.type?h=c(e,this.id,l.opacity,m):"univariate-above-and-below-ramp"===e.type?h=this._renderUnivariateAboveAndBelowRamp(e,l.opacity,m):"univariate-color-size-ramp"===e.type&&(h=this._renderUnivariateColorSizeRamp(e,l.opacity,m));if(!h)return null;const y=C("div",{key:d,class:R.section,id:`${d}-panel`,role:"tabpanel","aria-labelledby":d,tabIndex:0},[p,h]);return this._sectionMap.set(d,y),y}_renderPieChartRamp(e){return C("div",{class:R.pieChartRampPreview,bind:e.preview,afterCreate:v})}_renderUnivariateAboveAndBelowRamp(e,t,s){const{sizeRampElement:i,colorRampElement:r}=d(e,t,"horizontal");if(!i)return null;const a=p(i,"full",!0,"horizontal"),o=m(i,"above",!0,"horizontal"),l=m(i,"below",!0,"horizontal"),n=12,c=h(r,{width:o,height:n,rampAlignment:"horizontal",opacity:t,type:"above",effectList:s}),g=h(r,{width:l,height:n,rampAlignment:"horizontal",opacity:t,type:"below",effectList:s}),_=y(i,"card"),u=i.infos.map((e=>e.label)),f=u.length-1,b=u.map(((e,t)=>0===t||t===f?C("div",{key:t},e):null)),w={display:"flex",flexDirection:"column"},L={display:"flex",flexDirection:"row"},S={marginTop:"3px",display:"flex"};x(this.container)?S.marginRight=`${_}px`:S.marginLeft=`${_}px`;const z={width:`${a}px`,display:"flex",flexDirection:"row",justifyContent:"space-between"};return C("div",{class:R.layerRow,key:"size-ramp-preview",styles:w},C("div",{class:this.classes(R.symbolContainer,R.sizeRampHorizontal),styles:L},i.infos.map(((e,t)=>C("div",{key:t,class:R.symbol,bind:e.preview,afterCreate:v})))),c?C("div",{class:R.univariateAboveAndBelowColorRamp,styles:S,key:"color-ramp-preview"},C("div",{bind:c,afterCreate:v}),C("div",{bind:g,afterCreate:v})):null,C("div",{class:R.layerInfo},C("div",{class:R.rampLabelsContainer,styles:z},b)))}_renderUnivariateColorSizeRamp(e,t,s){const{sizeRampElement:i,colorRampElement:r}=g(e,"horizontal");if(!i)return null;const a=p(i,"full",!1,"horizontal"),o=m(i,"full",!1,"horizontal"),l=h(r,{width:o,height:12,rampAlignment:"horizontal",opacity:t,type:"full",effectList:s}),n=y(i,"card"),c=i.infos.length-1,d=i.infos.map(((e,t)=>0===t||t===c?C("div",{key:t},e.label):null)),_={display:"flex",flexDirection:"column"},u={display:"flex",flexDirection:"row"},f={marginTop:"3px",display:"flex"};x(this.container)?f.marginRight=`${n}px`:f.marginLeft=`${n}px`;const b={width:`${a}px`,display:"flex",flexDirection:"row",justifyContent:"space-between"};return C("div",{class:R.layerRow,key:"size-ramp-preview",styles:_},C("div",{class:this.classes(R.symbolContainer,R.sizeRampHorizontal),styles:u},i.infos.map(((e,t)=>C("div",{key:t,class:R.symbol,bind:e.preview,afterCreate:v})))),C("div",{class:R.univariateAboveAndBelowColorRamp,styles:f,key:"color-ramp-preview"},C("div",{bind:l,afterCreate:v})),C("div",{class:R.layerInfo},C("div",{class:R.rampLabelsContainer,styles:b},d)))}_renderLegendForElementInfo(e,t,s,i){const r=t.layer;if(e.type)return this._renderLegendForElement(e,t,i);const a=u(r,s);if(e.preview){if(!e.symbol||!e.symbol.type.includes("simple-fill")){if(!e.label)return C("div",{key:i,bind:e.preview,afterCreate:v});const t={[R.symbolCell]:this._hasIndicators};return C("div",{key:i,class:this.classes(R.layerRow,{[R.symbolRow]:this._hasIndicators})},C("div",{class:this.classes(t),bind:e.preview,afterCreate:v}),C("div",{class:this.classes(R.imageLabel,{[R.labelCell]:this._hasIndicators})},_(this.messages,e.label,!1)||""))}let s=255,a=255,o=255,n=0,c=255,d=255,p=255,m=0;const h=e.symbol.color&&e.symbol.color.a,y=e.symbol.outline&&e.symbol.outline.color&&e.symbol.outline.color.a;h&&(s=e.symbol.color.r,a=e.symbol.color.g,o=e.symbol.color.b,n=e.symbol.color.a*r.opacity),y&&(c=e.symbol.outline.color.r,d=e.symbol.outline.color.g,p=e.symbol.outline.color.b,m=e.symbol.outline.color.a*r.opacity);const g=e.symbol.color?.isBright??!0,u=g?"rgba(255, 255, 255, .6)":"rgba(0, 0, 0, .6)",f={background:h?`rgba(${s}, ${a}, ${o}, ${n})`:"none",color:g?"black":"white",textShadow:`-1px -1px 0 ${u},\n                                              1px -1px 0 ${u},\n                                              -1px 1px 0 ${u},\n                                              1px 1px 0 ${u}`,border:y?`1px solid rgba(${c}, ${d}, ${p}, ${m})`:"none",filter:l(t.effectList)};return C("div",{key:i,class:R.layerRow},C("div",{class:R.labelElement,styles:f}," ",e.label," "))}if(e.src){const t=this._renderImage(e,r,a);return C("div",{key:i,class:R.layerRow},t,C("div",{class:R.imageLabel},e.label||""))}}_renderImage(e,t,s){const{label:i,src:r,opacity:a}=e,o={[R.imageryLayerStretchedImage]:s,[R.symbol]:!s},l={opacity:`${null!=a?a:t.opacity}`};return C("img",{alt:_(this.messages,i,!1),src:r,border:0,width:e.width,height:e.height,class:this.classes(o),styles:l})}_renderSizeRampLines(e){const t=e.infos,s=t[0],r=t[t.length-1],a=s.symbol,o=this._hasIndicators,l=i(s.size+s.outlineSize)*j,n=i(r.size+r.outlineSize)*j,c=o?l:l+50*j,d=o?l/2+50*j:l,p=F(a),m=E(a),h=document.createElement("canvas");h.width=c,h.height=d,h.style.width=h.width/j+"px",h.style.height=h.height/j+"px";const y=h.getContext("2d");if(o){y.beginPath();const e=0,t=0,s=c/2-n/2,i=d;y.moveTo(e,t),y.lineTo(s,i);const r=c,a=0,o=c/2+n/2,l=d;y.moveTo(r,a),y.lineTo(o,l)}else{y.beginPath();const e=0,t=d/2-n/2,s=c,i=0;y.moveTo(e,t),y.lineTo(s,i);const r=0,a=d/2+n/2,o=c,l=d;y.moveTo(r,a),y.lineTo(o,l)}return y.strokeStyle=N,y.stroke(),C("div",{bind:h,afterCreate:v,styles:o?{display:"flex",marginTop:`-${p?0:m?l/2:0}px`,marginBottom:`-${p?n:m?n/2:0}px`}:{display:"flex",marginRight:`-${p?0:m?l/2:0}px`,marginLeft:`-${p?0:m?n/2:0}px`}})}_renderSizeRamp(e,t){const s=e.infos,i=s[0].label,r=s[s.length-1].label;let a=s[0].preview,o=s[s.length-1].preview;const l=this._hasIndicators,n={"flex-direction":l?"column":"row-reverse"};a&&(a=a.cloneNode(!0),a.style.display="flex"),o&&(o=o.cloneNode(!0),o.style.display="flex");const c={opacity:null!=t?`${t}`:""};return C("div",{class:this.classes(R.layerRow,{[R.sizeRampRow]:l})},C("div",{class:R.rampLabel},l?i:r),C("div",{class:R.sizeRampContainer,styles:n},C("div",{bind:a,afterCreate:v,class:R.sizeRampPreview,styles:c}),this._renderSizeRampLines(e),C("div",{bind:o,afterCreate:v,class:R.sizeRampContainer,styles:c})),C("div",{class:R.rampLabel},l?r:i))}_renderLegendForRamp(e,t,s){const i=e.infos,r="heatmap-ramp"===e.type,a=i.length-1,n=$,c=a>2&&!r?z*a:k,d=c+20,p=10,m=i.slice(0).reverse();m.forEach(((e,t)=>{e.offset=r?e.ratio:t/a}));const h=m.length-1,y=m.length%2!=0&&m[m.length/2|0],g=y&&C("div",{class:R.intervalSeparatorsContainer},C("div",{class:R.intervalSeparator},"|"),C("div",{class:R.rampLabel},y.label)),_=i[i.length-1].label,v=i[0].label,u=[[{shape:{type:"path",path:`M0 ${n/2} L${p} 0 L${p} ${n} Z`},fill:m[0].color,stroke:{width:0}},{shape:{type:"rect",x:p,y:0,width:c,height:n},fill:{type:"linear",x1:p,y1:0,x2:c+p,y2:0,colors:m},stroke:{width:0}},{shape:{type:"path",path:`M${c+p} 0 L${d} ${n/2} L${c+p} ${n} Z`},fill:m[h].color,stroke:{width:0}}]],f=o(u,d,n),{messages:b}=this,w={filter:l(s),opacity:null==t?null:`${t}`},L={justifyContent:"center"};return C("div",{class:R.layerRow,styles:L},C("div",{class:R.rampLabel},r?b[_]:_),C("div",{class:R.symbolContainer},C("div",{styles:w},f),g),C("div",{class:R.rampLabel},r?b[v]:v))}};e([r()],T.prototype,"activeLayerInfos",void 0),e([r()],T.prototype,"headingLevel",void 0),e([r()],T.prototype,"layout",void 0),e([r(),L("esri/widgets/Legend/t9n/Legend")],T.prototype,"messages",void 0),e([r(),L("esri/t9n/common")],T.prototype,"messagesCommon",void 0),e([r({readOnly:!0})],T.prototype,"type",void 0),e([r()],T.prototype,"view",void 0),e([w()],T.prototype,"_selectSection",null),T=e([a("esri.widgets.Legend.styles.Card")],T);const B=T;export{B as default};
