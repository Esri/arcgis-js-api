/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../intl","../../../core/Handles","../../../core/screenUtils","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../../symbols/support/svgUtils","../../../symbols/support/utils","../../Widget","./support/relationshipUtils","./support/univariateUtils","../support/styleUtils","../../support/Heading","../../support/decorators/accessibleHandler","../../support/decorators/messageBundle","../../../core/Logger","../../support/jsxFactory","../../support/widgetUtils","../../../intl/substitute"],(function(e,t,s,i,a,r,n,o,l,c,d,p,h,m,y,g,u,_,v,f,b,x,w){"use strict";const L={activated:"esri-legend--card__carousel-indicator--activated",base:"esri-legend--card",stacked:"esri-legend--stacked",carouselTitle:"esri-legend--card__carousel-title",indicator:"esri-legend--card__carousel-indicator",intervalSeparator:"esri-legend--card__interval-separator",imageryLayerStretchedImage:"esri-legend--card__imagery-layer-image--stretched",imageLabel:"esri-legend--card__image-label",layerCaption:"esri-legend--card__layer-caption",labelElement:"esri-legend--card__label-element",layerRow:"esri-legend--card__layer-row",labelCell:"esri-legend--card__label-cell",message:"esri-legend--card__message",rampLabel:"esri-legend--card__ramp-label",section:"esri-legend--card__section",relationshipSection:"esri-legend--card__relationship-section",serviceCaptionText:"esri-legend--card__service-caption-text",serviceContent:"esri-legend--card__service-content",service:"esri-legend--card__service",groupLayer:"esri-legend--card__group-layer",groupLayerChild:"esri-legend--card__group-layer-child",symbol:"esri-legend--card__symbol",sizeRampRow:"esri-legend--card__size-ramp-row",symbolRow:"esri-legend--card__symbol-row",symbolCell:"esri-legend--card__symbol-cell",indicatorContainer:"esri-legend--card__carousel-indicator-container",intervalSeparatorsContainer:"esri-legend--card__interval-separators-container",relationshipLabelContainer:"esri-legend--card__relationship-label-container",labelContainer:"esri-legend--card__label-container",serviceCaptionContainer:"esri-legend--card__service-caption-container",symbolContainer:"esri-legend--card__symbol-container",sizeRampContainer:"esri-legend--card__size-ramp-container",sizeRampPreview:"esri-legend--card__size-ramp-preview",rampContainer:"esri-legend__ramps",sizeRampHorizontal:"esri-legend__size-ramp--horizontal",rampLabelsContainer:"esri-legend__ramp-labels",layerInfo:"esri-legend__layer-cell esri-legend__layer-cell--info",univariateAboveAndBelowColorRamp:"esri-univariate-above-and-below-ramp__color--card",hidden:"esri-hidden"},C=25,S=25,R=768,z=100;var $;!function(e){e.Auto="auto",e.Stack="stack",e.SideBySide="side-by-side"}($||($={}));const N="#ddd",I=window.devicePixelRatio;function k(e){if(e){if(e.type.indexOf("3d")>-1){const t=e.symbolLayers&&e.symbolLayers.length;if(!t)return;const s=e.symbolLayers.getItemAt(t-1),i=s.resource&&s.resource.primitive;return"circle"===i||"cross"===i||"kite"===i||"sphere"===i||"cube"===i||"diamond"===i}{const t=e.style;return"circle"===t||"diamond"===t||"cross"===t}}}function A(e){if(e){if(e.type.indexOf("3d")>-1){const t=e.symbolLayers&&e.symbolLayers.length;if(!t)return;const s=e.symbolLayers.getItemAt(t-1).get("resource.primitive");return"triangle"===s||"cone"===s||"tetrahedron"===s}return"triangle"===e.style}}let T=function(t){function s(e,s){var a;return(a=t.call(this,e,s)||this)._handles=new i,a._hasIndicators=!1,a._selectedSectionName=null,a._sectionNames=[],a._sectionMap=new Map,a.activeLayerInfos=null,a.headingLevel=3,a.layout=$.Stack,a.messages=null,a.messagesCommon=null,a.type="card",a.view=null,a}e._inheritsLoose(s,t);var r=s.prototype;return r.initialize=function(){this.own([this.watch("activeLayerInfos",(e=>{this._handles.removeAll(),this._watchForSectionChanges(e)}))])},r.destroy=function(){this._handles.destroy(),this._handles=null},r.render=function(){this._hasIndicators=this.layout===$.Auto&&this.view.container.clientWidth<=R||this.layout===$.Stack;const e=this.activeLayerInfos,t=e&&e.toArray().map((e=>this._renderLegendForLayer(e))).filter((e=>!!e));this._hasIndicators?this._selectedSectionName&&-1!==this._sectionNames.indexOf(this._selectedSectionName)||(this._selectedSectionName=this._sectionNames&&this._sectionNames[0]):this._selectedSectionName=null;const s=this._sectionNames.length,i=this._sectionNames.map(((e,t)=>{const i=w.substitute(this.messagesCommon.pagination.pageText,{index:t+1,total:s});return b.tsx("div",{key:e,role:"tab",id:e,"aria-label":i,"aria-controls":`${e}-panel`,"aria-selected":(this._selectedSectionName===e).toString(),tabIndex:this._selectedSectionName===e?0:-1,title:i,onclick:this._selectSection,onkeydown:this._focusSection,bind:this,class:this.classes(L.indicator,{[L.activated]:this._selectedSectionName===e}),"data-section-name":e})})),a=this._hasIndicators&&s>1?b.tsx("div",{class:L.indicatorContainer,key:"carousel-navigation",role:"tablist"},i):null,r=this._hasIndicators?this._sectionMap.get(this._selectedSectionName):t&&t.length?t:null,n={[L.stacked]:this._hasIndicators};return b.tsx("div",{class:this.classes(L.base,n)},r||b.tsx("div",{class:L.message},this.messages.noLegend),a)},r._selectSection=function(e){const t=e.target.getAttribute("data-section-name");t&&(this._selectedSectionName=t)},r._focusSection=function(e){switch(e.key){case"ArrowLeft":case"ArrowRight":this._switchSectionOnArrowPress(e);break;case"Enter":case" ":this._selectSection(e)}},r._switchSectionOnArrowPress=function(e){const t=e.key,s="ArrowLeft"===t?-1:1,i=e.target.getAttribute("data-section-name"),a=this._sectionNames.indexOf(i),r=this._sectionNames;let n=null;-1!==a&&(r[a+s]?n=document.getElementById(r[a+s]):"ArrowLeft"===t?n=document.getElementById(r[r.length-1]):"ArrowRight"===t&&(n=document.getElementById(r[0])),n&&n.focus())},r._watchForSectionChanges=function(e){if(this._generateSectionNames(),e){e.forEach((e=>{const t=`activeLayerInfo-${e.layer.uid}-version-change`;this._handles.remove(t),this._watchForSectionChanges(e.children),this._handles.add(e.watch("version",(()=>this._generateSectionNames())),t)}));const t="activeLayerInfos-collection-change";this._handles.remove(t),this._handles.add(e.on("change",(()=>this._watchForSectionChanges(e))),t)}},r._generateSectionNames=function(){this._sectionNames.length=0,this._selectedSectionName=null,this.activeLayerInfos&&this.activeLayerInfos.forEach(this._generateSectionNamesForActiveLayerInfo,this)},r._getSectionName=function(e,t,s){return`${this.id}${e.uid}-type-${t.type}-${s}`},r._generateSectionNamesForActiveLayerInfo=function(e){e.children.forEach(this._generateSectionNamesForActiveLayerInfo,this),e.legendElements&&e.legendElements.forEach(((t,s)=>{this._sectionNames.push(this._getSectionName(e.layer,t,s))}))},r._renderLegendForLayer=function(e){if(!e.ready)return null;if(e.children.length){const t=e.children.map((e=>this._renderLegendForLayer(e))).toArray();return b.tsx("div",{key:e.layer.uid,class:this.classes(L.service,L.groupLayer)},b.tsx("div",{class:L.serviceCaptionContainer},e.title),t)}{const t=e.legendElements;if(t&&!t.length)return null;const s=t.some((e=>"relationship-ramp"===e.type)),i=t.map(((t,i)=>this._renderLegendForElement(t,e,i,s))).filter((e=>!!e));if(!i.length)return null;const a={[L.groupLayerChild]:!!e.parent};return b.tsx("div",{key:e.layer.uid,class:this.classes(L.service,a)},b.tsx("div",{class:L.serviceCaptionContainer},b.tsx("div",{class:L.serviceCaptionText},e.title)),b.tsx("div",{class:L.serviceContent},i))}},r._renderLegendForElement=function(e,t,s,i=!1){const a="color-ramp"===e.type,r="opacity-ramp"===e.type,n="size-ramp"===e.type,o=t.layer;let l=null;if("string"==typeof e.title)l=e.title;else if(e.title){const t=e.title,s=g.getTitle(this.messages,t,a||r);l=t.title?`${t.title} (${s})`:s}const c=this._getSectionName(o,e,s),d=this._hasIndicators?b.tsx("div",null,b.tsx(u.Heading,{level:this.headingLevel,class:L.carouselTitle},t.title),b.tsx(u.Heading,{level:u.incrementHeadingLevel(this.headingLevel),class:L.layerCaption},l)):l?b.tsx(u.Heading,{level:this.headingLevel,class:L.layerCaption},l):null,p=t.effectList;let h=null;if("symbol-table"===e.type){const s=e.infos.map(((s,i)=>this._renderLegendForElementInfo(s,t,e.legendType,i))).filter((e=>!!e));if(s.length){const e=s[0].properties.classes&&s[0].properties.classes[L.symbolRow],t={[L.labelContainer]:!e&&!i,[L.relationshipLabelContainer]:i};h=b.tsx("div",{class:this.classes(t)},s)}}else"color-ramp"===e.type||"opacity-ramp"===e.type||"heatmap-ramp"===e.type?h=this._renderLegendForRamp(e,o.opacity,p):n?h=this._renderSizeRamp(e,o.opacity):"relationship-ramp"===e.type?h=m.renderRelationshipRamp(e,this.id,o.opacity,p):"univariate-above-and-below-ramp"===e.type?h=this._renderUnivariateAboveAndBelowRamp(e,o.opacity,p):"univariate-color-size-ramp"===e.type&&(h=this._renderUnivariateColorSizeRamp(e,o.opacity,p));if(!h)return null;const y=b.tsx("div",{key:c,class:L.section,id:`${c}-panel`,role:"tabpanel","aria-labelledby":c,tabIndex:0},[d,h]);return this._sectionMap.set(c,y),y},r._renderUnivariateAboveAndBelowRamp=function(e,t,s){const{sizeRampElement:i,colorRampElement:a}=y.getUnivariateAboveAndBelowRampElements(e,t,"horizontal");if(!i)return null;const r=y.getUnivariateSizeRampSize(i,"full",!0,"horizontal"),n=y.getUnivariateColorRampSize(i,"above",!0,"horizontal"),o=y.getUnivariateColorRampSize(i,"below",!0,"horizontal"),l=12,c=y.getUnivariateColorRampPreview(a,{width:n,height:l,rampAlignment:"horizontal",opacity:t,type:"above",effectList:s}),d=y.getUnivariateColorRampPreview(a,{width:o,height:l,rampAlignment:"horizontal",opacity:t,type:"below",effectList:s}),p=y.getUnivariateColorRampMargin(i,"card"),h=i.infos.map((e=>e.label)),m=h.length-1,u=h.map(((e,t)=>0===t||t===m?b.tsx("div",{key:t},e):null)),_={display:"flex",flexDirection:"column"},v={display:"flex",flexDirection:"row"},f={marginTop:"3px",display:"flex"};x.isRTL(this.container)?f.marginRight=`${p}px`:f.marginLeft=`${p}px`;const w={width:`${r}px`,display:"flex",flexDirection:"row",justifyContent:"space-between"};return b.tsx("div",{class:L.layerRow,key:"size-ramp-preview",styles:_},b.tsx("div",{class:this.classes(L.symbolContainer,L.sizeRampHorizontal),styles:v},i.infos.map(((e,t)=>b.tsx("div",{key:t,class:L.symbol,bind:e.preview,afterCreate:g.attachToNode})))),c?b.tsx("div",{class:L.univariateAboveAndBelowColorRamp,styles:f,key:"color-ramp-preview"},b.tsx("div",{bind:c,afterCreate:g.attachToNode}),b.tsx("div",{bind:d,afterCreate:g.attachToNode})):null,b.tsx("div",{class:L.layerInfo},b.tsx("div",{class:L.rampLabelsContainer,styles:w},u)))},r._renderUnivariateColorSizeRamp=function(e,t,s){const{sizeRampElement:i,colorRampElement:a}=y.getUnivariateColorSizeRampElements(e,"horizontal");if(!i)return null;const r=y.getUnivariateSizeRampSize(i,"full",!1,"horizontal"),n=y.getUnivariateColorRampSize(i,"full",!1,"horizontal"),o=12,l=y.getUnivariateColorRampPreview(a,{width:n,height:o,rampAlignment:"horizontal",opacity:t,type:"full",effectList:s}),c=y.getUnivariateColorRampMargin(i,"card"),d=i.infos.length-1,p=i.infos.map(((e,t)=>0===t||t===d?b.tsx("div",{key:t},e.label):null)),h={display:"flex",flexDirection:"column"},m={display:"flex",flexDirection:"row"},u={marginTop:"3px",display:"flex"};x.isRTL(this.container)?u.marginRight=`${c}px`:u.marginLeft=`${c}px`;const _={width:`${r}px`,display:"flex",flexDirection:"row",justifyContent:"space-between"};return b.tsx("div",{class:L.layerRow,key:"size-ramp-preview",styles:h},b.tsx("div",{class:this.classes(L.symbolContainer,L.sizeRampHorizontal),styles:m},i.infos.map(((e,t)=>b.tsx("div",{key:t,class:L.symbol,bind:e.preview,afterCreate:g.attachToNode})))),b.tsx("div",{class:L.univariateAboveAndBelowColorRamp,styles:u,key:"color-ramp-preview"},b.tsx("div",{bind:l,afterCreate:g.attachToNode})),b.tsx("div",{class:L.layerInfo},b.tsx("div",{class:L.rampLabelsContainer,styles:_},p)))},r._renderLegendForElementInfo=function(e,t,s,i){const a=t.layer;if(e.type)return this._renderLegendForElement(e,t,i);const r=g.isImageryStretchedLegend(a,s);if(e.preview){var n,o;if(!e.symbol||-1===e.symbol.type.indexOf("simple-fill")){if(!e.label)return b.tsx("div",{key:i,bind:e.preview,afterCreate:g.attachToNode});const t={[L.symbolCell]:this._hasIndicators};return b.tsx("div",{key:i,class:this.classes(L.layerRow,{[L.symbolRow]:this._hasIndicators})},b.tsx("div",{class:this.classes(t),bind:e.preview,afterCreate:g.attachToNode}),b.tsx("div",{class:this.classes(L.imageLabel,{[L.labelCell]:this._hasIndicators})},g.getTitle(this.messages,e.label,!1)||""))}let s=255,r=255,l=255,c=0,d=255,h=255,m=255,y=0;const u=e.symbol.color&&e.symbol.color.a,_=e.symbol.outline&&e.symbol.outline.color&&e.symbol.outline.color.a;u&&(s=e.symbol.color.r,r=e.symbol.color.g,l=e.symbol.color.b,c=e.symbol.color.a*a.opacity),_&&(d=e.symbol.outline.color.r,h=e.symbol.outline.color.g,m=e.symbol.outline.color.b,y=e.symbol.outline.color.a*a.opacity);const v=null==(n=null==(o=e.symbol.color)?void 0:o.isBright)||n,f=v?"rgba(255, 255, 255, .6)":"rgba(0, 0, 0, .6)",x={background:u?`rgba(${s}, ${r}, ${l}, ${c})`:"none",color:v?"black":"white",textShadow:`-1px -1px 0 ${f},\n                                              1px -1px 0 ${f},\n                                              -1px 1px 0 ${f},\n                                              1px 1px 0 ${f}`,border:_?`1px solid rgba(${d}, ${h}, ${m}, ${y})`:"none",filter:p.getCSSFilterFromEffectList(t.effectList)};return b.tsx("div",{key:i,class:L.layerRow},b.tsx("div",{class:L.labelElement,styles:x}," ",e.label," "))}if(e.src){const t=this._renderImage(e,a,r);return b.tsx("div",{key:i,class:L.layerRow},t,b.tsx("div",{class:L.imageLabel},e.label||""))}},r._renderImage=function(e,t,s){const{label:i,src:a,opacity:r}=e,n={[L.imageryLayerStretchedImage]:s,[L.symbol]:!s},o={opacity:`${null!=r?r:t.opacity}`};return b.tsx("img",{alt:g.getTitle(this.messages,i,!1),src:a,border:0,width:e.width,height:e.height,class:this.classes(n),styles:o})},r._renderSizeRampLines=function(e){const t=e.infos,s=t[0],i=t[t.length-1],r=s.symbol,n=this._hasIndicators,o=a.pt2px(s.size+s.outlineSize)*I,l=a.pt2px(i.size+i.outlineSize)*I,c=n?o:o+50*I,d=n?o/2+50*I:o,p=A(r),h=k(r),m=document.createElement("canvas");m.width=c,m.height=d,m.style.width=m.width/I+"px",m.style.height=m.height/I+"px";const y=m.getContext("2d");if(n){y.beginPath();const e=0,t=0,s=c/2-l/2,i=d;y.moveTo(e,t),y.lineTo(s,i);const a=c,r=0,n=c/2+l/2,o=d;y.moveTo(a,r),y.lineTo(n,o)}else{y.beginPath();const e=0,t=d/2-l/2,s=c,i=0;y.moveTo(e,t),y.lineTo(s,i);const a=0,r=d/2+l/2,n=c,o=d;y.moveTo(a,r),y.lineTo(n,o)}return y.strokeStyle=N,y.stroke(),b.tsx("div",{bind:m,afterCreate:g.attachToNode,styles:n?{display:"flex",marginTop:`-${p?0:h?o/2:0}px`,marginBottom:`-${p?l:h?l/2:0}px`}:{display:"flex",marginRight:`-${p?0:h?o/2:0}px`,marginLeft:`-${p?0:h?l/2:0}px`}})},r._renderSizeRamp=function(e,t){const s=e.infos,i=s[0].label,a=s[s.length-1].label;let r=s[0].preview,n=s[s.length-1].preview;const o=this._hasIndicators,l={"flex-direction":o?"column":"row-reverse"};r&&(r=r.cloneNode(!0),r.style.display="flex"),n&&(n=n.cloneNode(!0),n.style.display="flex");const c={opacity:null!=t?`${t}`:""};return b.tsx("div",{class:this.classes(L.layerRow,{[L.sizeRampRow]:o})},b.tsx("div",{class:L.rampLabel},o?i:a),b.tsx("div",{class:L.sizeRampContainer,styles:l},b.tsx("div",{bind:r,afterCreate:g.attachToNode,class:L.sizeRampPreview,styles:c}),this._renderSizeRampLines(e),b.tsx("div",{bind:n,afterCreate:g.attachToNode,class:L.sizeRampContainer,styles:c})),b.tsx("div",{class:L.rampLabel},o?a:i))},r._renderLegendForRamp=function(e,t,s){const i=e.infos,a="heatmap-ramp"===e.type,r=i.length-1,n=S,o=r>2&&!a?C*r:z,l=o+20,c=10,h=i.slice(0).reverse();h.forEach(((e,t)=>{e.offset=a?e.ratio:t/r}));const m=h.length-1,y=h.length%2!=0&&h[h.length/2|0],g=y&&b.tsx("div",{class:L.intervalSeparatorsContainer},b.tsx("div",{class:L.intervalSeparator},"|"),b.tsx("div",{class:L.rampLabel},y.label)),u=i[i.length-1].label,_=i[0].label,v=[[{shape:{type:"path",path:`M0 ${n/2} L${c} 0 L${c} ${n} Z`},fill:h[0].color,stroke:{width:0}},{shape:{type:"rect",x:c,y:0,width:o,height:n},fill:{type:"linear",x1:c,y1:0,x2:o+c,y2:0,colors:h},stroke:{width:0}},{shape:{type:"path",path:`M${o+c} 0 L${l} ${n/2} L${o+c} ${n} Z`},fill:h[m].color,stroke:{width:0}}]],f=d.renderSVG(v,l,n),{messages:x}=this,w={filter:p.getCSSFilterFromEffectList(s),opacity:null==t?null:`${t}`},R={justifyContent:"center"};return b.tsx("div",{class:L.layerRow,styles:R},b.tsx("div",{class:L.rampLabel},a?x[u]:u),b.tsx("div",{class:L.symbolContainer},b.tsx("div",{styles:w},f),g),b.tsx("div",{class:L.rampLabel},a?x[_]:_))},s}(h);t.__decorate([r.property()],T.prototype,"activeLayerInfos",void 0),t.__decorate([r.property()],T.prototype,"headingLevel",void 0),t.__decorate([r.property()],T.prototype,"layout",void 0),t.__decorate([r.property(),v.messageBundle("esri/widgets/Legend/t9n/Legend")],T.prototype,"messages",void 0),t.__decorate([r.property(),v.messageBundle("esri/t9n/common")],T.prototype,"messagesCommon",void 0),t.__decorate([r.property({readOnly:!0})],T.prototype,"type",void 0),t.__decorate([r.property()],T.prototype,"view",void 0),t.__decorate([_.accessibleHandler()],T.prototype,"_selectSection",null),T=t.__decorate([c.subclass("esri.widgets.Legend.styles.Card")],T);return T}));
