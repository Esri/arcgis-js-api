/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/has","../../../core/Logger","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass","../../../core/urlUtils","../../../core/uuid","../../../portal/support/resourceExtension","../../../core/screenUtils","../../../intl/substitute","../../../intl","../../../core/Handles","../../support/widgetUtils","../../support/decorators/accessibleHandler","../../support/decorators/messageBundle","../../../chunks/index","../../Widget","../../../symbols/support/svgUtils","./support/relationshipUtils","./support/univariateUtils","../support/styleUtils"],(function(e,t,s,i,a,r,o,n,l,c,d,p,h,m,y,g,_,u,v,b,f,x,w){"use strict";const C={activated:"esri-legend--card__carousel-indicator--activated",base:"esri-legend--card",stacked:"esri-legend--stacked",carouselTitle:"esri-legend--card__carousel-title",indicator:"esri-legend--card__carousel-indicator",intervalSeparator:"esri-legend--card__interval-separator",imageryLayerStretchedImage:"esri-legend--card__imagery-layer-image--stretched",imageLabel:"esri-legend--card__image-label",layerCaption:"esri-legend--card__layer-caption",labelElement:"esri-legend--card__label-element",layerRow:"esri-legend--card__layer-row",labelCell:"esri-legend--card__label-cell",message:"esri-legend--card__message",rampLabel:"esri-legend--card__ramp-label",section:"esri-legend--card__section",relationshipSection:"esri-legend--card__relationship-section",serviceCaptionText:"esri-legend--card__service-caption-text",serviceContent:"esri-legend--card__service-content",service:"esri-legend--card__service",groupLayer:"esri-legend--card__group-layer",groupLayerChild:"esri-legend--card__group-layer-child",symbol:"esri-legend--card__symbol",sizeRampRow:"esri-legend--card__size-ramp-row",symbolRow:"esri-legend--card__symbol-row",symbolCell:"esri-legend--card__symbol-cell",indicatorContainer:"esri-legend--card__carousel-indicator-container",intervalSeparatorsContainer:"esri-legend--card__interval-separators-container",relationshipLabelContainer:"esri-legend--card__relationship-label-container",labelContainer:"esri-legend--card__label-container",serviceCaptionContainer:"esri-legend--card__service-caption-container",symbolContainer:"esri-legend--card__symbol-container",sizeRampContainer:"esri-legend--card__size-ramp-container",sizeRampPreview:"esri-legend--card__size-ramp-preview",rampContainer:"esri-legend__ramps",sizeRampHorizontal:"esri-legend__size-ramp--horizontal",rampLabelsContainer:"esri-legend__ramp-labels",layerInfo:"esri-legend__layer-cell esri-legend__layer-cell--info",univariateAboveAndBelowColorRamp:"esri-univariate-above-and-below-ramp__color--card",hidden:"esri-hidden",header:"esri-widget__heading"},L=25,S=25,j=768,R=100,z="#ddd",N=window.devicePixelRatio;function $(e){if(e){if(e.type.indexOf("3d")>-1){const t=e.symbolLayers&&e.symbolLayers.length;if(!t)return;const s=e.symbolLayers.getItemAt(t-1),i=s.resource&&s.resource.primitive;return"circle"===i||"cross"===i||"kite"===i||"sphere"===i||"cube"===i||"diamond"===i}{const t=e.style;return"circle"===t||"diamond"===t||"cross"===t}}}function I(e){if(e){if(e.type.indexOf("3d")>-1){const t=e.symbolLayers&&e.symbolLayers.length;if(!t)return;const s=e.symbolLayers.getItemAt(t-1).get("resource.primitive");return"triangle"===s||"cone"===s||"tetrahedron"===s}return"triangle"===e.style}}let k=function(t){function s(e,s){var i;return(i=t.call(this,e,s)||this)._handles=new m,i._hasIndicators=!1,i._selectedSectionName=null,i._sectionNames=[],i._sectionMap=new Map,i.activeLayerInfos=null,i.layout="stack",i.messages=null,i.messagesCommon=null,i.type="card",i.view=null,i}e._inheritsLoose(s,t);var i=s.prototype;return i.initialize=function(){this.own([this.watch("activeLayerInfos",(e=>{this._handles.removeAll(),this._watchForSectionChanges(e)}))])},i.destroy=function(){this._handles.destroy(),this._handles=null},i.render=function(){this._hasIndicators="auto"===this.layout&&this.view.container.clientWidth<=j||"stack"===this.layout;const e=this.activeLayerInfos,t=e&&e.toArray().map((e=>this._renderLegendForLayer(e))).filter((e=>!!e));this._hasIndicators?this._selectedSectionName&&-1!==this._sectionNames.indexOf(this._selectedSectionName)||(this._selectedSectionName=this._sectionNames&&this._sectionNames[0]):this._selectedSectionName=null;const s=this._sectionNames.length,i=this._sectionNames.map(((e,t)=>{const i=p.substitute(this.messagesCommon.pagination.pageText,{index:t+1,total:s});return u.jsx("div",{key:e,role:"tab",id:e,"aria-label":i,"aria-controls":`${e}-panel`,"aria-selected":(this._selectedSectionName===e).toString(),tabIndex:this._selectedSectionName===e?0:-1,title:i,onclick:this._selectSection,onkeydown:this._focusSection,bind:this,class:this.classes(C.indicator,{[C.activated]:this._selectedSectionName===e}),"data-section-name":e})})),a=this._hasIndicators&&s>1?u.jsx("div",{class:C.indicatorContainer,key:"carousel-navigation",role:"tablist"},i):null,r=this._hasIndicators?this._sectionMap.get(this._selectedSectionName):t&&t.length?t:null,o={[C.stacked]:this._hasIndicators};return u.jsx("div",{class:this.classes(C.base,o)},r||u.jsx("div",{class:C.message},this.messages.noLegend),a)},i._selectSection=function(e){const t=e.target.getAttribute("data-section-name");t&&(this._selectedSectionName=t)},i._focusSection=function(e){switch(e.key){case"ArrowLeft":case"ArrowRight":this._switchSectionOnArrowPress(e);break;case"Enter":case" ":this._selectSection(e)}},i._switchSectionOnArrowPress=function(e){const t=e.key,s="ArrowLeft"===t?-1:1,i=e.target.getAttribute("data-section-name"),a=this._sectionNames.indexOf(i),r=this._sectionNames;let o=null;-1!==a&&(r[a+s]?o=document.getElementById(r[a+s]):"ArrowLeft"===t?o=document.getElementById(r[r.length-1]):"ArrowRight"===t&&(o=document.getElementById(r[0])),o&&o.focus())},i._watchForSectionChanges=function(e){if(this._generateSectionNames(),e){e.forEach((e=>{const t=`activeLayerInfo-${e.layer.uid}-version-change`;this._handles.remove(t),this._watchForSectionChanges(e.children),this._handles.add(e.watch("version",(()=>this._generateSectionNames())),t)}));const t="activeLayerInfos-collection-change";this._handles.remove(t),this._handles.add(e.on("change",(()=>this._watchForSectionChanges(e))),t)}},i._generateSectionNames=function(){this._sectionNames.length=0,this._selectedSectionName=null,this.activeLayerInfos&&this.activeLayerInfos.forEach(this._generateSectionNamesForActiveLayerInfo,this)},i._getSectionName=function(e,t,s){return`${this.id}${e.uid}-type-${t.type}-${s}`},i._generateSectionNamesForActiveLayerInfo=function(e){e.children.forEach(this._generateSectionNamesForActiveLayerInfo,this),e.legendElements&&e.legendElements.forEach(((t,s)=>{this._sectionNames.push(this._getSectionName(e.layer,t,s))}))},i._renderLegendForLayer=function(e){if(!e.ready)return null;if(e.children.length){const t=e.children.map((e=>this._renderLegendForLayer(e))).toArray();return u.jsx("div",{key:e.layer.uid,class:this.classes(C.service,C.groupLayer)},u.jsx("div",{class:C.serviceCaptionContainer},e.title),t)}{const t=e.legendElements;if(t&&!t.length)return null;const s=t.some((e=>"relationship-ramp"===e.type)),i=t.map(((t,i)=>this._renderLegendForElement(t,e,i,s))).filter((e=>!!e));if(!i.length)return null;const a={[C.groupLayerChild]:!!e.parent};return u.jsx("div",{key:e.layer.uid,class:this.classes(C.service,a)},u.jsx("div",{class:C.serviceCaptionContainer},u.jsx("div",{class:C.serviceCaptionText},e.title)),u.jsx("div",{class:C.serviceContent},i))}},i._renderLegendForElement=function(e,t,s,i=!1){const a="color-ramp"===e.type,r="opacity-ramp"===e.type,o="size-ramp"===e.type,n=t.layer,l=e.title;let c=null;if("string"==typeof l)c=l;else if(l){const e=w.getTitle(this.messages,l,a||r);c=l.title?`${l.title} (${e})`:e}const d=this._getSectionName(n,e,s),p=this._hasIndicators?u.jsx("div",null,u.jsx("h3",{class:this.classes(C.header,C.carouselTitle)},t.title),u.jsx("h4",{class:this.classes(C.header,C.layerCaption)},c)):c?u.jsx("h4",{class:this.classes(C.header,C.layerCaption)},c):null;let h=null;if("symbol-table"===e.type){const s=e.infos.map(((s,i)=>this._renderLegendForElementInfo(s,t,e.legendType,i))).filter((e=>!!e));if(s.length){const e=s[0].properties.classes&&s[0].properties.classes[C.symbolRow],t={[C.labelContainer]:!e&&!i,[C.relationshipLabelContainer]:i};h=u.jsx("div",{class:this.classes(t)},s)}}else"color-ramp"===e.type||"opacity-ramp"===e.type||"heatmap-ramp"===e.type?h=this._renderLegendForRamp(e,n.opacity):o?h=this._renderSizeRamp(e,n.opacity):"relationship-ramp"===e.type?h=f.renderRelationshipRamp(e,this.id,n.opacity):"univariate-above-and-below-ramp"===e.type?h=this._renderUnivariateAboveAndBelowRamp(e,n.opacity):"univariate-color-size-ramp"===e.type&&(h=this._renderUnivariateColorSizeRamp(e,n.opacity));if(!h)return null;const m=u.jsx("div",{key:d,class:C.section,id:`${d}-panel`,role:"tabpanel","aria-labelledby":d,tabIndex:0},[p,h]);return this._sectionMap.set(d,m),m},i._renderUnivariateAboveAndBelowRamp=function(e,t){const{sizeRampElement:s,colorRampElement:i}=x.getUnivariateAboveAndBelowRampElements(e,t,"horizontal"),a=x.getUnivariateSizeRampSize(s,"full",!0,"horizontal"),r=x.getUnivariateColorRampSize(s,"above",!0,"horizontal"),o=x.getUnivariateColorRampSize(s,"below",!0,"horizontal"),n=12,l=x.getUnivariateColorRampPreview(i,{width:r,height:n,rampAlignment:"horizontal",opacity:t,type:"above"}),c=x.getUnivariateColorRampPreview(i,{width:o,height:n,rampAlignment:"horizontal",opacity:t,type:"below"}),d=x.getUnivariateColorRampMargin(s,"card"),p=s.infos.map((e=>e.label)),h=p.length-1,m=p.map(((e,t)=>0===t||t===h?u.jsx("div",{key:t},e):null)),y={display:"flex",flexDirection:"column"},g={display:"flex",flexDirection:"row"},_={marginTop:"3px",marginLeft:`${d}px`,display:"flex"},v={width:`${a}px`,display:"flex",flexDirection:"row",justifyContent:"space-between"};return u.jsx("div",{class:C.layerRow,key:"size-ramp-preview",styles:y},u.jsx("div",{class:this.classes(C.symbolContainer,C.sizeRampHorizontal),styles:g},s.infos.map(((e,t)=>u.jsx("div",{key:t,class:C.symbol,bind:e.preview,afterCreate:w.attachToNode})))),l?u.jsx("div",{class:C.univariateAboveAndBelowColorRamp,styles:_,key:"color-ramp-preview"},u.jsx("div",{bind:l,afterCreate:w.attachToNode}),u.jsx("div",{bind:c,afterCreate:w.attachToNode})):null,u.jsx("div",{class:C.layerInfo},u.jsx("div",{class:C.rampLabelsContainer,styles:v},m)))},i._renderUnivariateColorSizeRamp=function(e,t){const{sizeRampElement:s,colorRampElement:i}=x.getUnivariateColorSizeRampElements(e,"horizontal"),a=x.getUnivariateSizeRampSize(s,"full",!1,"horizontal"),r=x.getUnivariateColorRampSize(s,"full",!1,"horizontal"),o=12,n=x.getUnivariateColorRampPreview(i,{width:r,height:o,rampAlignment:"horizontal",opacity:t,type:"full"}),l=x.getUnivariateColorRampMargin(s,"card"),c=s.infos.length-1,d=s.infos.map(((e,t)=>0===t||t===c?u.jsx("div",{key:t},e.label):null)),p={display:"flex",flexDirection:"column"},h={display:"flex",flexDirection:"row"},m={marginTop:"3px",marginLeft:`${l}px`,display:"flex"},y={width:`${a}px`,display:"flex",flexDirection:"row",justifyContent:"space-between"};return u.jsx("div",{class:C.layerRow,key:"size-ramp-preview",styles:p},u.jsx("div",{class:this.classes(C.symbolContainer,C.sizeRampHorizontal),styles:h},s.infos.map(((e,t)=>u.jsx("div",{key:t,class:C.symbol,bind:e.preview,afterCreate:w.attachToNode})))),u.jsx("div",{class:C.univariateAboveAndBelowColorRamp,styles:m,key:"color-ramp-preview"},u.jsx("div",{bind:n,afterCreate:w.attachToNode})),u.jsx("div",{class:C.layerInfo},u.jsx("div",{class:C.rampLabelsContainer,styles:y},d)))},i._renderLegendForElementInfo=function(e,t,s,i){const a=t.layer;if(e.type)return this._renderLegendForElement(e,t,i);const r=w.isImageryStretchedLegend(a,s);if(e.preview){var o,n;if(!e.symbol||-1===e.symbol.type.indexOf("simple-fill")){if(!e.label)return u.jsx("div",{key:i,bind:e.preview,afterCreate:w.attachToNode});const t={[C.symbolCell]:this._hasIndicators};return u.jsx("div",{key:i,class:this.classes(C.layerRow,{[C.symbolRow]:this._hasIndicators})},u.jsx("div",{class:this.classes(t),bind:e.preview,afterCreate:w.attachToNode}),u.jsx("div",{class:this.classes(C.imageLabel,{[C.labelCell]:this._hasIndicators})},w.getTitle(this.messages,e.label,!1)||""))}let t=255,s=255,r=255,l=0,c=255,d=255,p=255,h=0;const m=e.symbol.color&&e.symbol.color.a,y=e.symbol.outline&&e.symbol.outline.color&&e.symbol.outline.color.a;m&&(t=e.symbol.color.r,s=e.symbol.color.g,r=e.symbol.color.b,l=e.symbol.color.a*a.opacity),y&&(c=e.symbol.outline.color.r,d=e.symbol.outline.color.g,p=e.symbol.outline.color.b,h=e.symbol.outline.color.a*a.opacity);const g=null==(o=null==(n=e.symbol.color)?void 0:n.isBright)||o,_=g?"rgba(255, 255, 255, .6)":"rgba(0, 0, 0, .6)",v={background:m?`rgba(${t}, ${s}, ${r}, ${l})`:"none",color:g?"black":"white",textShadow:`-1px -1px 0 ${_},\n                                              1px -1px 0 ${_},\n                                              -1px 1px 0 ${_},\n                                              1px 1px 0 ${_}`,border:y?`1px solid rgba(${c}, ${d}, ${p}, ${h})`:"none"};return u.jsx("div",{key:i,class:C.layerRow},u.jsx("div",{class:C.labelElement,styles:v}," ",e.label," "))}if(e.src){const t=this._renderImage(e,a,r);return u.jsx("div",{key:i,class:C.layerRow},t,u.jsx("div",{class:C.imageLabel},e.label||""))}},i._renderImage=function(e,t,s){const{label:i,src:a,opacity:r}=e,o={[C.imageryLayerStretchedImage]:s,[C.symbol]:!s},n={opacity:`${null!=r?r:t.opacity}`};return u.jsx("img",{alt:w.getTitle(this.messages,i,!1),src:a,border:0,width:e.width,height:e.height,class:this.classes(o),styles:n})},i._renderSizeRampLines=function(e){const t=e.infos,s=t[0],i=t[t.length-1],a=s.symbol,r=this._hasIndicators,o=d.pt2px(s.size+s.outlineSize)*N,n=d.pt2px(i.size+i.outlineSize)*N,l=r?o:o+50*N,c=r?o/2+50*N:o,p=I(a),h=$(a),m=document.createElement("canvas");m.width=l,m.height=c,m.style.width=m.width/N+"px",m.style.height=m.height/N+"px";const y=m.getContext("2d");if(r){y.beginPath();const e=0,t=0,s=l/2-n/2,i=c;y.moveTo(e,t),y.lineTo(s,i);const a=l,r=0,o=l/2+n/2,d=c;y.moveTo(a,r),y.lineTo(o,d)}else{y.beginPath();const e=0,t=c/2-n/2,s=l,i=0;y.moveTo(e,t),y.lineTo(s,i);const a=0,r=c/2+n/2,o=l,d=c;y.moveTo(a,r),y.lineTo(o,d)}return y.strokeStyle=z,y.stroke(),u.jsx("div",{bind:m,afterCreate:w.attachToNode,styles:r?{display:"flex",marginTop:`-${p?0:h?o/2:0}px`,marginBottom:`-${p?n:h?n/2:0}px`}:{display:"flex",marginRight:`-${p?0:h?o/2:0}px`,marginLeft:`-${p?0:h?n/2:0}px`}})},i._renderSizeRamp=function(e,t){const s=e.infos,i=s[0].label,a=s[s.length-1].label;let r=s[0].preview,o=s[s.length-1].preview;const n=this._hasIndicators,l={"flex-direction":n?"column":"row-reverse"};r&&(r=r.cloneNode(!0),r.style.display="flex"),o&&(o=o.cloneNode(!0),o.style.display="flex");const c={opacity:null!=t?`${t}`:""};return u.jsx("div",{class:this.classes(C.layerRow,{[C.sizeRampRow]:n})},u.jsx("div",{class:C.rampLabel},n?i:a),u.jsx("div",{class:C.sizeRampContainer,styles:l},u.jsx("div",{bind:r,afterCreate:w.attachToNode,class:C.sizeRampPreview,styles:c}),this._renderSizeRampLines(e),u.jsx("div",{bind:o,afterCreate:w.attachToNode,class:C.sizeRampContainer,styles:c})),u.jsx("div",{class:C.rampLabel},n?a:i))},i._renderLegendForRamp=function(e,t){const s=e.infos,i="heatmap-ramp"===e.type,a=s.length-1,r=S,o=a>2&&!i?L*a:R,n=o+20,l=10,c=s.slice(0).reverse();c.forEach(((e,t)=>{e.offset=i?e.ratio:t/a}));const d=c.length-1,p=c.length%2!=0&&c[c.length/2|0],h=p&&u.jsx("div",{class:C.intervalSeparatorsContainer},u.jsx("div",{class:C.intervalSeparator},"|"),u.jsx("div",{class:C.rampLabel},p.label)),m=s[s.length-1].label,y=s[0].label;let g=null;null!=t&&(g=`opacity: ${t}`);const _=[[{shape:{type:"path",path:`M0 ${r/2} L${l} 0 L${l} ${r} Z`},fill:c[0].color,stroke:{width:0}},{shape:{type:"rect",x:l,y:0,width:o,height:r},fill:{type:"linear",x1:l,y1:0,x2:o+l,y2:0,colors:c},stroke:{width:0}},{shape:{type:"path",path:`M${o+l} 0 L${n} ${r/2} L${o+l} ${r} Z`},fill:c[d].color,stroke:{width:0}}]],v=b.renderSVG(_,n,r),{messages:f}=this;return u.jsx("div",{class:C.layerRow},u.jsx("div",{class:C.rampLabel},i?f[m]:m),u.jsx("div",{class:C.symbolContainer},u.jsx("div",{style:g},v),h),u.jsx("div",{class:C.rampLabel},i?f[y]:y))},s}(v);return t.__decorate([r.property()],k.prototype,"activeLayerInfos",void 0),t.__decorate([r.property()],k.prototype,"layout",void 0),t.__decorate([r.property(),_.messageBundle("esri/widgets/Legend/t9n/Legend")],k.prototype,"messages",void 0),t.__decorate([r.property(),_.messageBundle("esri/t9n/common")],k.prototype,"messagesCommon",void 0),t.__decorate([r.property({readOnly:!0})],k.prototype,"type",void 0),t.__decorate([r.property()],k.prototype,"view",void 0),t.__decorate([g.accessibleHandler()],k.prototype,"_selectSection",null),k=t.__decorate([o.subclass("esri.widgets.Legend.styles.Card")],k),k}));
