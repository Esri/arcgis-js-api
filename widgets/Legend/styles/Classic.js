// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","dojo/i18n!../../Legend/nls/Legend","dojox/gfx","../../../core/accessorSupport/decorators","../../Widget","./common","../support/styleUtils","../../support/widget"],function(e,r,t,l,a,s,i,n,o,d,y){var c={widget:"esri-widget",base:"esri-legend esri-widget--panel",service:"esri-legend__service",label:"esri-legend__service-label",layer:"esri-legend__layer",groupLayer:"esri-legend__group-layer",groupLayerChild:"esri-legend__group-layer-child",layerTable:"esri-legend__layer-table",layerTableSizeRamp:"esri-legend__layer-table--size-ramp",layerChildTable:"esri-legend__layer-child-table",layerCaption:"esri-legend__layer-caption",layerBody:"esri-legend__layer-body",layerRow:"esri-legend__layer-row",layerCell:"esri-legend__layer-cell",layerInfo:"esri-legend__layer-cell esri-legend__layer-cell--info",imageryLayerStretchedImage:"esri-legend__imagery-layer-image--stretched",imageryLayerCellStretched:"esri-legend__imagery-layer-cell--stretched",imageryLayerInfoStretched:"esri-legend__imagery-layer-info--stretched",symbolContainer:"esri-legend__layer-cell esri-legend__layer-cell--symbols",symbol:"esri-legend__symbol",rampContainer:"esri-legend__ramps",sizeRamp:"esri-legend__size-ramp",colorRamp:"esri-legend__color-ramp",opacityRamp:"esri-legend__opacity-ramp",borderlessRamp:"esri-legend__borderless-ramp",rampTick:"esri-legend__ramp-tick",rampFirstTick:"esri-legend__ramp-tick-first",rampLastTick:"esri-legend__ramp-tick-last",rampLabelsContainer:"esri-legend__ramp-labels",rampLabel:"esri-legend__ramp-label",message:"esri-legend__message",header:"esri-widget__heading",hidden:"esri-hidden"};return function(e){function r(r){var t=e.call(this)||this;return t.activeLayerInfos=null,t.type="classic",t}return t(r,e),r.prototype.render=function(){var e=this,r=this.activeLayerInfos,t=this.classes(c.base,c.widget),l=r&&r.toArray().map(function(r){return e._renderLegendForLayer(r)}).filter(function(e){return!!e});return y.tsx("div",{class:t},l&&l.length?l:y.tsx("div",{class:c.message},a.noLegend))},r.prototype._renderLegendForLayer=function(e){var r,t=this;if(!e.ready)return null;var l=!!e.children.length,a="esri-legend__"+e.layer.uid+"-version-"+e.version,s=e.title?y.tsx("h3",{class:this.classes(c.header,c.label)},e.title):null;if(l){var i=e.children.map(function(e){return t._renderLegendForLayer(e)}).toArray();return y.tsx("div",{key:a,class:this.classes(c.service,c.groupLayer)},s,i)}var n=e.legendElements;if(n&&!n.length)return null;var o=n.map(function(r){return t._renderLegendForElement(r,e.layer)}).filter(function(e){return!!e});if(!o.length)return null;var d=(r={},r[c.groupLayerChild]=!!e.parent,r);return y.tsx("div",{key:a,class:this.classes(c.service,d)},s,y.tsx("div",{class:c.layer},o))},r.prototype._renderLegendForElement=function(e,r,t){var l,a=this,s="color-ramp"===e.type,i="opacity-ramp"===e.type,n="size-ramp"===e.type,p=null;if("symbol-table"===e.type||n){var g=e.infos.map(function(t){return a._renderLegendForElementInfo(t,r,n,e.legendType)}).filter(function(e){return!!e});g.length&&(p=y.tsx("div",{class:c.layerBody},g))}else"color-ramp"===e.type||"opacity-ramp"===e.type||"heatmap-ramp"===e.type?p=this._renderLegendForRamp(e):"relationship-ramp"===e.type&&(p=o.renderRelationshipRamp(e,this.id));if(!p)return null;var m=e.title,_=null;if("string"==typeof m)_=m;else if(m){var u=d.getTitle(m,s||i);_=d.isRendererTitle(m,s||i)&&m.title?m.title+" ("+u+")":u}var h=t?c.layerChildTable:c.layerTable,f=_?y.tsx("div",{class:c.layerCaption},_):null,v=(l={},l[c.layerTableSizeRamp]=n||!t,l);return y.tsx("div",{class:this.classes(h,v)},f,p)},r.prototype._renderLegendForRamp=function(e){var r=e.infos,t="opacity-ramp"===e.type,l="heatmap-ramp"===e.type,i=r.length-1,n=null;n=i>2&&!l?25*i:l?75:50;var o=document.createElement("div"),p=t?c.opacityRamp:"";o.className=c.colorRamp+" "+p,o.style.height=n+"px";var g=s.createSurface(o,"100%",n);try{if(l||r.forEach(function(e,r){e.offset=r/i}),g.createRect({x:0,y:0,width:"100%",height:n}).setFill({type:"linear",x1:0,y1:0,x2:0,y2:n,colors:r}).setStroke(null),"color-ramp"===e.type||"opacity-ramp"===e.type){var m=e.overlayColor;m&&m.a>0&&g.createRect({x:0,y:0,width:"100%",height:n}).setFill(m).setStroke(null)}}catch(e){g.clear(),g.destroy()}if(!g)return null;var _=r.filter(function(e){return!!e.label}).map(function(e){return y.tsx("div",{class:c.rampLabel},l?a[e.label]:e.label)}),u={width:"24px"},h={height:n+"px"};return y.tsx("div",{class:c.layerRow},y.tsx("div",{class:c.symbolContainer,styles:u},y.tsx("div",{class:c.rampContainer,bind:o,afterCreate:d.attachToNode})),y.tsx("div",{class:c.layerInfo},y.tsx("div",{class:c.rampLabelsContainer,styles:h},_)))},r.prototype._renderLegendForElementInfo=function(e,r,t,l){var a,s;if(e.type)return this._renderLegendForElement(e,r,!0);var i=null,n=d.isImageryStretchedLegend(r,l);if(e.symbol&&e.preview?i=y.tsx("div",{class:c.symbol,bind:e.preview,afterCreate:d.attachToNode}):e.src&&(i=this._renderImage(e,r,n)),!i)return null;var o=(a={},a[c.imageryLayerInfoStretched]=n,a),p=(s={},s[c.imageryLayerInfoStretched]=n,s[c.sizeRamp]=!n&&t,s);return y.tsx("div",{class:c.layerRow},y.tsx("div",{class:this.classes(c.symbolContainer,p)},i),y.tsx("div",{class:this.classes(c.layerInfo,o)},d.getTitle(e.label,!1)||""))},r.prototype._renderImage=function(e,r,t){var l,a=e.label,s=e.src,i=e.opacity,n=(l={},l[c.imageryLayerStretchedImage]=t,l[c.symbol]=!t,l),o={opacity:""+(null!=i?i:r.opacity)};return y.tsx("img",{alt:a,src:s,border:0,width:e.width,height:e.height,class:this.classes(n),styles:o})},l([y.renderable(),i.property()],r.prototype,"activeLayerInfos",void 0),l([i.property({readOnly:!0})],r.prototype,"type",void 0),r=l([i.subclass("esri.widgets.Legend.styles.Classic")],r)}(i.declared(n))});