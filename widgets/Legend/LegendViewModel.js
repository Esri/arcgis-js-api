/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../intl","../../core/Accessor","../../core/Collection","../../core/Handles","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/accessorSupport/decorators/subclass","./support/ActiveLayerInfo","../../intl/locale"],(function(e,t,i,r,s,a,n,o,l,y,d,c,h){"use strict";const u={state:"state",view:"view",allLayerViews:"all-layer-views",legendProperties:"legend-properties"},L=s.ofType(c),f=["esri.layers.BuildingSceneLayer","esri.layers.CSVLayer","esri.layers.FeatureLayer","esri.layers.GeoJSONLayer","esri.layers.GeoRSSLayer","esri.layers.GroupLayer","esri.layers.HeatmapLayer","esri.layers.ImageryLayer","esri.layers.ImageryTileLayer","esri.layers.MapImageLayer","esri.layers.OGCFeatureLayer","esri.layers.PointCloudLayer","esri.layers.StreamLayer","esri.layers.SceneLayer","esri.layers.SubtypeGroupLayer","esri.layers.TileLayer","esri.layers.VoxelLayer","esri.layers.WFSLayer","esri.layers.WMSLayer","esri.layers.WMTSLayer","esri.layers.WCSLayer","esri.layers.LinkChartLayer","esri.layers.knowledgeGraph.KnowledgeGraphSubLayer"],_="view.basemapView.baseLayerViews",p="view.groundView.layerViews",v="view.basemapView.referenceLayerViews",w=[_,p,"view.layerViews",v];let I=function(t){function i(e){var i;return(i=t.call(this,e)||this)._handles=new a,i._layerViewByLayerId={},i._layerInfosByLayerViewId={},i._activeLayerInfosByLayerViewId={},i._activeLayerInfosWithNoParent=new s,i.activeLayerInfos=new L,i.basemapLegendVisible=!1,i.groundLegendVisible=!1,i.hideLayersNotInCurrentView=!1,i.keepCacheOnDestroy=!1,i.respectLayerVisibility=!0,i.layerInfos=[],i.view=null,i}e._inheritsLoose(i,t);var r=i.prototype;return r.initialize=function(){this._handles.add(n.watch((()=>this.view),(()=>this._viewHandles()),n.initial),u.view),this._handles.add(h.onLocaleChange((()=>this._refresh())))},r.destroy=function(){this._destroyViewActiveLayerInfos(),this._handles.destroy(),this._handles=null,this.view=null},r._viewHandles=function(){this._handles.remove(u.state),this.view&&this._handles.add(n.watch((()=>this.state),(()=>this._stateHandles()),n.initial),u.state)},r._stateHandles=function(){this._resetAll(),"ready"===this.state&&this._watchPropertiesAndAllLayerViews()},r._resetAll=function(){this._handles.remove([u.allLayerViews,u.legendProperties]),this._destroyViewActiveLayerInfos(),this.activeLayerInfos.removeAll()},r._destroyViewActiveLayerInfos=function(){Object.keys(this._activeLayerInfosByLayerViewId).forEach(this._destroyViewActiveLayerInfo,this)},r._destroyViewActiveLayerInfo=function(e){this._handles.remove(e);const t=this._activeLayerInfosByLayerViewId[e];delete this._activeLayerInfosByLayerViewId[e],t&&t.parent&&t.parent.children.remove(t)},r._watchPropertiesAndAllLayerViews=function(){const{allLayerViews:e}=this.view;e.length&&this._refresh(),this._handles.add(e.on("change",(e=>this._allLayerViewsChangeHandle(e))),u.allLayerViews),this._handles.add(n.watch((()=>[this.layerInfos,this.basemapLegendVisible,this.groundLegendVisible]),(()=>this._propertiesChangeHandle())),u.legendProperties)},r._allLayerViewsChangeHandle=function(e){e.removed.forEach((e=>this._destroyViewActiveLayerInfo(e.uid))),this._refresh()},r._propertiesChangeHandle=function(){this._destroyViewActiveLayerInfos(),this._refresh()},r._refresh=function(){this._layerInfosByLayerViewId={},this.activeLayerInfos.removeAll(),this._generateLayerViews().filter(this._filterLayerViewsByLayerInfos,this).filter(this._isLayerViewSupported,this).forEach(this._generateActiveLayerInfo,this),this._sortActiveLayerInfos(this.activeLayerInfos)},r._sortActiveLayerInfos=function(e){if(e.length<2)return;const t=[];e.forEach((i=>{if(!i.parent){const r=i.layer.parent,s=r&&"uid"in r&&this._layerViewByLayerId[r.uid],a=s&&this._activeLayerInfosByLayerViewId[s.uid];a&&e.includes(a)&&(t.push(i),i.parent=a,a.children.add(i),this._sortActiveLayerInfos(a.children))}})),e.removeMany(t);const i={};this.view.allLayerViews.forEach(((e,t)=>i[e.layer.uid]=t)),e.sort(((e,t)=>{const r=i[e.layer.uid]||0;return(i[t.layer.uid]||0)-r}))},r._generateLayerViews=function(){const e=[];return w.filter(this._filterLayerViews,this).map(this.get,this).filter((e=>null!=e)).forEach(this._collectLayerViews("layerViews",e)),e},r._filterLayerViews=function(e){const t=!this.basemapLegendVisible&&(e===_||e===v),i=!this.groundLegendVisible&&e===p;return!t&&!i},r._collectLayerViews=function(e,t){const i=r=>(r&&r.forEach((r=>{t.push(r),i(r[e])})),t);return i},r._filterLayerViewsByLayerInfos=function(e){const t=this.layerInfos;return!t||!t.length||t.some((t=>this._hasLayerInfo(t,e)))},r._hasLayerInfo=function(e,t){const i=this._isLayerUIDMatching(e.layer,t.layer.uid);return i&&(this._layerInfosByLayerViewId[t.uid]=e),i},r._isLayerUIDMatching=function(e,t){return e&&(e.uid===t||this._hasLayerUID(e.layers,t))},r._hasLayerUID=function(e,t){return e&&e.some((e=>this._isLayerUIDMatching(e,t)))},r._isLayerViewSupported=function(e){return!!f.includes(e.layer.declaredClass)&&(this._layerViewByLayerId[e.layer.uid]=e,!0)},r._generateActiveLayerInfo=function(e){this._isLayerActive(e)?this._buildActiveLayerInfo(e):(this._handles.remove(e.uid),this._handles.add(n.watch((()=>[e.legendEnabled,e.layer?.legendEnabled]),(()=>this._layerActiveHandle(e))),e.uid))},r._layerActiveHandle=function(e){this._isLayerActive(e)&&(this._handles.remove(e.uid),this._buildActiveLayerInfo(e))},r._isLayerActive=function(e){return!this.respectLayerVisibility||e.legendEnabled&&e.get("layer.legendEnabled")},r._buildActiveLayerInfo=function(e){const t=e.layer,i=e.uid,r=this._layerInfosByLayerViewId[i];let s=this._activeLayerInfosByLayerViewId[i];if(!s){const a=r&&void 0!==r.title&&r.layer.uid===t.uid;s=new c({layer:t,layerView:e,title:a?r.title:t.title,view:this.view,respectLayerVisibility:this.respectLayerVisibility,hideLayersNotInCurrentView:this.hideLayersNotInCurrentView,keepCacheOnDestroy:this.keepCacheOnDestroy,sublayerIds:r&&r.sublayerIds||[]}),this._activeLayerInfosByLayerViewId[i]=s}const a=t.parent&&"uid"in t.parent&&this._layerViewByLayerId[t.parent?.uid];if(s.parent=this._activeLayerInfosByLayerViewId[a?.uid],!this._handles.has(i)){const r=[n.watch((()=>t.title),(e=>this._titleHandle(e,s))),n.watch((()=>[t.opacity,"renderer"in t&&t.renderer,"pointSymbol"in t&&t.pointSymbol,"lineSymbol"in t&&t.lineSymbol,"polygonSymbol"in t&&t.polygonSymbol]),(()=>this._constructLegendElements(s))),n.when((()=>!0===this.view?.stationary),(()=>this._scaleHandle(s)),n.initial),n.watch((()=>e._effectiveRenderer),(()=>this._constructLegendElements(s))),n.watch((()=>"effect"in t&&t.effect),(()=>this._constructLegendElements(s)))];if(this.respectLayerVisibility){const i=n.watch((()=>e.legendEnabled),(e=>this._legendEnabledHandle(e,s))),a=n.watch((()=>t.legendEnabled),(e=>this._legendEnabledHandle(e,s)));r.push(i,a)}this._handles.add(r,i)}s.isScaleDriven||this._constructLegendElements(s),this._addActiveLayerInfo(s)},r._titleHandle=function(e,t){t.title=e,this._constructLegendElements(t)},r._legendEnabledHandle=function(e,t){e?this._addActiveLayerInfo(t):this._removeActiveLayerInfo(t)},r._scaleHandle=function(e){(e.isScaleDriven||e.hideLayersNotInCurrentView)&&this._constructLegendElements(e)},r._addActiveLayerInfo=function(e){const{layerView:t,layer:i}=e;if(this._isLayerActive(t)&&!this.activeLayerInfos.includes(e)){const t=e.parent;if(t)t.children.includes(e)||t.children.push(e),this._sortActiveLayerInfos(t.children);else{const t=this.layerInfos?.some((e=>e.layer.uid===i.uid));i.parent&&"uid"in i.parent&&!t?this._activeLayerInfosWithNoParent.add(e):(this.activeLayerInfos.add(e),this._sortActiveLayerInfos(this.activeLayerInfos))}if(this._activeLayerInfosWithNoParent.length){const e=[];this._activeLayerInfosWithNoParent.forEach((t=>{const i=t.layer.parent,r=i&&"uid"in i&&this._layerViewByLayerId[i?.uid],s=this._activeLayerInfosByLayerViewId[r?.uid];s&&(e.push(t),t.parent=s)})),e.length&&(this._activeLayerInfosWithNoParent.removeMany(e),e.forEach((e=>this._addActiveLayerInfo(e))))}}},r._removeActiveLayerInfo=function(e){const t=e.parent;t?t.children.remove(e):this.activeLayerInfos.remove(e)},r._constructLegendElements=function(e){const t=e.layer;"featureCollections"in t&&t.featureCollections?e.buildLegendElementsForFeatureCollections(t.featureCollections):"featureReduction"in t&&t.featureReduction&&"renderer"in t.featureReduction&&("binning"===t.featureReduction.type||"cluster"===t.featureReduction.type)?e.buildLegendElementsForFeatureReduction(t.featureReduction):"renderer"in t&&t.renderer&&!("sublayers"in t)?e.buildLegendElementsForRenderer(t.renderer):"url"in t&&t.url?e.buildLegendElementsForTools():e.children.forEach((e=>this._constructLegendElements(e)))},e._createClass(i,[{key:"state",get:function(){return this.get("view.ready")?"ready":"disabled"}}]),i}(r);t.__decorate([o.property({type:L})],I.prototype,"activeLayerInfos",void 0),t.__decorate([o.property()],I.prototype,"basemapLegendVisible",void 0),t.__decorate([o.property()],I.prototype,"groundLegendVisible",void 0),t.__decorate([o.property()],I.prototype,"hideLayersNotInCurrentView",void 0),t.__decorate([o.property()],I.prototype,"keepCacheOnDestroy",void 0),t.__decorate([o.property()],I.prototype,"respectLayerVisibility",void 0),t.__decorate([o.property()],I.prototype,"layerInfos",void 0),t.__decorate([o.property({readOnly:!0})],I.prototype,"state",null),t.__decorate([o.property()],I.prototype,"view",void 0),I=t.__decorate([d.subclass("esri.widgets.Legend.LegendViewModel")],I);return I}));
