/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/has","../core/Logger","../core/accessorSupport/ensureType","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/aliasOf","../core/accessorSupport/decorators/subclass","../core/urlUtils","../core/uuid","../portal/support/resourceExtension","../core/events","../core/Collection","../core/Handles","../core/watchUtils","./support/widgetUtils","./support/decorators/accessibleHandler","./support/decorators/messageBundle","./support/decorators/vmEvent","../chunks/index","./Widget","../chunks/sortable.esm","./TableList/ListItem","./TableList/TableListViewModel","./TableList/support/tableListUtils"],(function(e,t,i,s,n,o,r,a,l,c,d,u,m,g,h,_,p,b,f,y,v,I,A,S,w){"use strict";function T(e,t,i){e.splice(i,0,e.splice(t,1)[0])}const x=m.ofType(A),C="root-tables",O="data-layer-uid",k="layerUid",E={base:"esri-table-list",esriWidget:"esri-widget",esriWidgetPanel:"esri-widget--panel",noItems:"esri-table-list__no-items",list:"esri-table-list__list",listRoot:"esri-table-list__list--root",item:"esri-table-list__item",itemChosen:"esri-table-list__item--chosen",itemError:"esri-table-list__item--error",itemSelectable:"esri-table-list__item--selectable",itemContainer:"esri-table-list__item-container",actionsMenu:"esri-table-list__item-actions-menu",actionsMenuItem:"esri-table-list__item-actions-menu-item",actionsMenuItemActive:"esri-table-list__item-actions-menu-item--active",actions:"esri-table-list__item-actions",actionsList:"esri-table-list__item-actions-list",action:"esri-table-list__item-action",actionIcon:"esri-table-list__item-action-icon",actionImage:"esri-table-list__item-action-image",actionTitle:"esri-table-list__item-action-title",actionToggle:"esri-table-list__action-toggle",actionToggleOn:"esri-table-list__action-toggle--on",errorMessage:"esri-table-list__item-error-message",title:"esri-table-list__item-title",disabled:"esri-disabled",disabledElement:"esri-disabled-element",hidden:"esri-hidden",rotating:"esri-rotating",iconEllipses:"esri-icon-handle-horizontal",iconNoticeTriangle:"esri-icon-notice-triangle",iconLoading:"esri-icon-loading-indicator",iconDefaultAction:"esri-icon-default-action",widgetIcon:"esri-icon-table"},L={actions:"actions",actionSection:"action-section",items:"items"};function M(e){const{actionsOpen:t}=e;t&&(e.actionsOpen=!1)}let j=function(t){function i(e,i){var s;return(s=t.call(this,e,i)||this)._handles=new g,s._sortable=null,s._sortableNode=null,s._focusSortUid=null,s.visibleItems=null,s.iconClass=E.widgetIcon,s.label=void 0,s.listItemCreatedFunction=null,s.map=null,s.messages=null,s.messagesCommon=null,s.multipleSelectionEnabled=!1,s.selectionEnabled=!1,s.selectedItems=new x,s.tableItems=null,s.viewModel=new S,s}e._inheritsLoose(i,t);var s=i.prototype;return s.initialize=function(){this._setVisibleItems(this.tableItems),this.own(h.on(this.viewModel,"tableItems","change",(()=>this._itemsChanged())),h.init(this,"selectionEnabled",(()=>this._toggleSorting())))},s.destroy=function(){this._destroySortable(),this._handles.destroy(),this._handles=null},s.triggerAction=function(e,t){this.viewModel.triggerAction(e,t)},s.render=function(){var e;const{visibleItems:t}=this,i=null==(e=this.viewModel)?void 0:e.state,s={[E.hidden]:"loading"===i,[E.disabled]:"disabled"===i};return y.jsx("div",{class:this.classes(E.base,E.esriWidget,E.esriWidgetPanel,s)},null!=t&&t.length?this.renderList():this.renderNoItems())},s.renderNoItems=function(){return y.jsx("div",{class:E.noItems},this.messages.noItemsToDisplay)},s.renderList=function(){const{visibleItems:e,messages:t,selectionEnabled:i}=this;return y.jsx("ul",{"aria-label":t.widgetLabel,role:i?"listbox":void 0,afterCreate:this._sortNodeCreated,afterRemoved:this._destroySortable,"data-node-ref":"_sortableNode",bind:this,class:this.classes(E.list,E.listRoot)},e.map((e=>this.renderItem(e))).toArray())},s.renderItem=function(e){const{id:t,selectionEnabled:i,selectedItems:s}=this,n=`${`${t}_${e.uid}`}__title`,o=!!e.error,r={[E.itemError]:!!o,[E.itemSelectable]:i};if(i){var a;const t={[O]:null==(a=e.layer)?void 0:a.uid};return y.jsx("li",Object.assign({key:`item-with-selection-${e.uid}`,bind:this,afterCreate:this._focusListItem,afterUpdate:this._focusListItem,class:this.classes(E.item,r),"aria-labelledby":n,onclick:this._toggleSelection,onkeydown:this._selectionKeydown,"data-item":e,tabIndex:0,"aria-selected":w.findSelectedItem(e,s)?"true":"false",role:"option"},t),this.renderItemContent(e,n))}return y.jsx("li",{key:`item-no-selection-${e.uid}`,bind:this,afterCreate:this._focusListItem,afterUpdate:this._focusListItem,class:this.classes(E.item,r),"aria-labelledby":n},this.renderItemContent(e,n))},s.renderActionsMenuIcon=function(e,t){const{messagesCommon:i}=this,s={[E.actionsMenuItemActive]:e.actionsOpen},n=e.actionsOpen?i.close:i.open;return y.jsx("div",{key:"actions-menu-toggle","data-item":e,bind:this,onclick:this._toggleActionsOpen,onkeydown:this._toggleActionsOpen,class:this.classes(E.actionsMenuItem,s),tabindex:"0",role:"button","aria-controls":t,"aria-label":n,title:n},y.jsx("span",{"aria-hidden":"true",class:E.iconEllipses}))},s.renderActionsMenu=function(e,t,i,s){const n=1===i&&this._getSingleActionButton(t),o=n?this.renderAction({item:e,action:n,singleAction:!0}):null,r=!n&&i?this.renderActionsMenuIcon(e,s):null;return r||n?y.jsx("div",{key:"actions-menu",class:E.actionsMenu},o,r):null},s.renderError=function(e){return e.error?y.jsx("div",{key:"error",class:E.errorMessage,role:"alert"},y.jsx("span",null,this.messages.tableError)):null},s.renderItemContent=function(e,t){const{id:i}=this,s=`${`${i}_${e.uid}`}_actions`,n=this._filterActions(e.actionsSections),o=this._countActions(n);return[y.jsx("div",{key:"list-item-container",class:E.itemContainer},this.renderLabel(e,t),this.renderActionsMenu(e,n,o,s)),this.renderError(e),o?this.renderActionsSections(e,n,s):null]},s.renderTitle=function(e,t){const{messages:i}=this,s=e.title||i.untitledTable;return y.jsx("span",{key:"layer-title-container",id:t,class:E.title},s)},s.renderItemError=function(e){return e.error?y.jsx("span",{key:"notice-triangle","aria-hidden":"true",class:E.iconNoticeTriangle}):null},s.renderLabel=function(e,t){return e.error?[this.renderItemError(e),this.renderTitle(e,t)]:this.renderTitle(e,t)},s.renderActionsSections=function(e,t,i){const s=t.toArray().map(((t,i)=>y.jsx("ul",{key:`${e}-action-section-${i}`,class:E.actionsList},this.renderActionSection(e,t))));return y.jsx("div",{role:"group","aria-expanded":e.actionsOpen?"true":"false",key:"actions-section",id:i,class:E.actions,hidden:!e.actionsOpen||null},s)},s.renderActionSection=function(e,t){return(t&&t.toArray()).map((t=>this.renderAction({item:e,action:t})))},s.renderActionIcon=function(e){const{active:t,className:i}=e,s=this._getIconImageStyles(e),n="button"!==e.type||e.image||i?i:E.iconDefaultAction,o={[E.actionImage]:!t&&!!s["background-image"],[E.iconLoading]:t,[E.rotating]:t};return n&&!t&&(o[n]=!0),y.jsx("span",{key:"action-icon","aria-hidden":"true",class:this.classes(E.actionIcon,o),styles:s})},s.renderActionTitle=function(e,t){return t?null:y.jsx("span",{key:"action-title",class:E.actionTitle},e)},s.renderAction=function(e){const{item:t,action:i,singleAction:s}=e,{active:n,disabled:o,title:r}=i,a={[E.actionsMenuItem]:s&&"button"===i.type,[E.action]:n||!s&&"toggle"!==i.type,[E.actionToggle]:!n&&"toggle"===i.type,[E.actionToggleOn]:!n&&"toggle"===i.type&&i.value,[E.disabledElement]:o},l=[this.renderActionIcon(i),this.renderActionTitle(r,s)];return s?y.jsx("div",{bind:this,"data-item":t,"data-action":i,role:"button",key:`single-action-${i.uid}`,onclick:this._triggerAction,onkeydown:this._triggerAction,classes:a,tabindex:"0",title:r,"aria-label":r},l):y.jsx("li",{bind:this,"data-item":t,"data-action":i,key:`action-${i.uid}`,onclick:this._triggerAction,onkeydown:this._triggerAction,classes:a,tabindex:"0",role:"button",title:r,"aria-label":r},l)},s._filterActions=function(e){return e.map((e=>e.filter((e=>e.visible))))},s._setVisibleItems=function(e){this.visibleItems=null==e?void 0:e.filter((e=>this.errorsVisible||!e.error))},s._destroySortable=function(){const{_sortable:e}=this;e&&e.destroy(),this._sortable=null},s._toggleSorting=function(){const{_sortable:e,_sortableNode:t,selectionEnabled:i}=this;if(t)if(e)e.option("disabled",!i);else{const e=I.Sortable.create(t,{dataIdAttr:O,group:C,fallbackTolerance:4,disabled:!i,onSort:()=>this._sortTablesToItems(e.toArray()),chosenClass:E.itemChosen});this._sortable=e}},s._sortNodeCreated=function(e){this._sortableNode=e,this._toggleSorting()},s._sortTablesToItems=function(e){var t;const i=null==(t=this.map)?void 0:t.tables;i&&i.sort(((t,i)=>{const s=e.indexOf(t.uid),n=e.indexOf(i.uid);return s>n?-1:s<n?1:0}))},s._getSingleActionButton=function(e){return e.reduce((e=>e)).filter((e=>e&&"button"===e.type)).getItemAt(0)},s._focusListItem=function(e){var t;const{_focusSortUid:i}=this;if(!e||!i)return;(null==(t=e["data-item"].layer)?void 0:t.uid)===i&&(e.focus(),this._focusSortUid=null)},s._watchActionSectionChanges=function(e,t){const i=L.actionSection+t,s=()=>this.scheduleRender();this._handles.add(e.on("change",s),i),e.forEach((e=>this._renderOnActionChanges(e,t)))},s._renderOnActionChanges=function(e,t){const i=L.actions+t,s=()=>this.scheduleRender();"toggle"!==e.type?"slider"!==e.type?this._handles.add([h.init(e,["className","image","id","title","visible"],s)],i):this._handles.add([h.init(e,["className","id","title","visible","value","displayValueEnabled","max","min","step"],s)],i):this._handles.add([h.init(e,["className","image","id","title","visible","value"],s)],i)},s._renderOnItemChanges=function(e){const t=e.uid,i=L.items+t,s=()=>this.scheduleRender();this._handles.add([h.init(e,["actionsOpen","open","title","error"],s),e.actionsSections.on("change",s)],i),e.actionsSections.forEach((e=>this._watchActionSectionChanges(e,t)))},s._itemsChanged=function(){const{tableItems:e}=this.viewModel;this._setVisibleItems(e),this._handles.removeAll(),e.forEach((e=>this._renderOnItemChanges(e))),this.scheduleRender()},s._countActions=function(e){return e.reduce(((e,t)=>e+t.length),0)},s._getIconImageStyles=function(e){const t="esri.support.Action.ActionButton"===e.declaredClass||"esri.support.Action.ActionToggle"===e.declaredClass?e.image:null;return{"background-image":t?`url("${t}")`:null}},s._selectionKeydown=function(e){const t=["ArrowDown","ArrowUp"],i=u.eventKey(e);if(-1===t.indexOf(i))return void this._toggleSelection(e);e.stopPropagation();const s=e.currentTarget["data-item"],{_sortable:n,selectedItems:o}=this,r=w.findSelectedItem(s,o),a=n.toArray(),l=e.target,c=a.indexOf(l.dataset[k]);if(-1!==c){if("ArrowDown"===i){const e=c+1;if(e>=a.length)return;var d,m;if(r)T(a,c,e),n.sort(a),this._sortTablesToItems(n.toArray()),this._focusSortUid=null==(d=s.layer)?void 0:d.uid;else this._focusSortUid=null==(m=s.layer)?void 0:m.uid,this.scheduleRender()}if("ArrowUp"===i){const e=c-1;if(e<=-1)return;var g,h;if(r)T(a,c,e),n.sort(a),this._sortTablesToItems(n.toArray()),this._focusSortUid=null==(g=s.layer)?void 0:g.uid;else this._focusSortUid=null==(h=s.layer)?void 0:h.uid,this.scheduleRender()}}},s._toggleActionsOpen=function(e){const t=e.currentTarget["data-item"],{actionsOpen:i}=t,s=!i;s&&this.tableItems.forEach((e=>M(e))),t.actionsOpen=s,e.stopPropagation()},s._triggerAction=function(e){const t=e.currentTarget,i=t["data-action"],s=t["data-item"];"toggle"===i.type&&(i.value=!i.value),this.triggerAction(i,s),e.stopPropagation()},s._toggleSelection=function(e){e.stopPropagation();const{multipleSelectionEnabled:t,selectedItems:i}=this,s=t&&(e.metaKey||e.ctrlKey),n=e.currentTarget["data-item"],o=w.findSelectedItem(n,i),{length:r}=i;if(!s)return r&&!(o&&1===r)?(i.removeAll(),void i.add(n)):void(o?i.remove(o):i.add(n));o?i.remove(o):i.add(n)},i}(v);return t.__decorate([o.property()],j.prototype,"visibleItems",void 0),t.__decorate([o.property()],j.prototype,"iconClass",void 0),t.__decorate([o.property()],j.prototype,"errorsVisible",void 0),t.__decorate([o.property({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],j.prototype,"label",void 0),t.__decorate([r.aliasOf("viewModel.listItemCreatedFunction")],j.prototype,"listItemCreatedFunction",void 0),t.__decorate([r.aliasOf("viewModel.map")],j.prototype,"map",void 0),t.__decorate([o.property(),b.messageBundle("esri/widgets/TableList/t9n/TableList")],j.prototype,"messages",void 0),t.__decorate([o.property(),b.messageBundle("esri/t9n/common")],j.prototype,"messagesCommon",void 0),t.__decorate([o.property()],j.prototype,"multipleSelectionEnabled",void 0),t.__decorate([o.property()],j.prototype,"selectionEnabled",void 0),t.__decorate([o.property()],j.prototype,"selectedItems",void 0),t.__decorate([r.aliasOf("viewModel.tableItems")],j.prototype,"tableItems",void 0),t.__decorate([f.vmEvent("trigger-action"),o.property({type:S})],j.prototype,"viewModel",void 0),t.__decorate([r.aliasOf("viewModel.triggerAction")],j.prototype,"triggerAction",null),t.__decorate([p.accessibleHandler()],j.prototype,"_toggleActionsOpen",null),t.__decorate([p.accessibleHandler()],j.prototype,"_triggerAction",null),t.__decorate([p.accessibleHandler()],j.prototype,"_toggleSelection",null),j=t.__decorate([a.subclass("esri.widgets.TableList")],j),j}));
