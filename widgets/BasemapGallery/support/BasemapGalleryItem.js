/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/HandleOwner","../../../core/Identifiable","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../../support/basemapUtils"],(function(e,t,r,s,i,a,o,n,l,c,p,h){"use strict";let u=function(t){function r(e){var r;return(r=t.call(this,e)||this).compatibilityFunction=null,r.error=null,r.state="loading",r.view=null,r}e._inheritsLoose(r,t);var s=r.prototype;return s.initialize=function(){const e=()=>this.refresh();this.handles.add([o.watch((()=>this.basemap?.loadStatus),e),o.watch((()=>this.compatibilityFunction),e),o.watch((()=>this.view&&"basemapTerrain"in this.view&&this.view.basemapTerrain?.tilingScheme),e),o.watch((()=>this.view?.ready),e),o.watch((()=>this.view?.spatialReference),e)]),this.refresh()},s.destroy=function(){this._cancelRefresh(),this.basemap=null,this.compatibilityFunction=null,this.view=null},s.refresh=function(){this._cancelRefresh(),this._set("state","loading");const e=this.basemap?.loadStatus;if("loaded"!==e&&"failed"!==e)return;if(!this.compatibilityFunction)return void("loaded"===e?(this._set("state","ready"),this._set("error",null)):(this._set("state","error"),this._set("error",this.basemap.loadError)));const t=new AbortController,{signal:r}=t;this.compatibilityFunction(this,{signal:r}).then((()=>o.whenOnce((()=>!this._spatialReferenceTask.updating),r))).then((()=>{this._set("state","ready"),this._set("error",null)})).catch((e=>{a.isAbortError(e)||(this._set("state","error"),this._set("error",e))})),this._refreshController=t},s._cancelRefresh=function(){this._refreshController&&(this._refreshController.abort(),this._refreshController=null)},e._createClass(r,[{key:"_spatialReferenceTask",get:function(){return h.findSpatialReference(this.view,this.basemap)}},{key:"basemap",set:function(e){const t=this._get("basemap");t&&t.cancelLoad(),e&&e.load().catch((()=>{})),this._set("basemap",e)}},{key:"spatialReference",get:function(){return this._spatialReferenceTask.spatialReference}}]),r}(i.IdentifiableMixin(s.HandleOwnerMixin(r)));t.__decorate([n.property({readOnly:!0})],u.prototype,"_spatialReferenceTask",null),t.__decorate([n.property()],u.prototype,"basemap",null),t.__decorate([n.property()],u.prototype,"compatibilityFunction",void 0),t.__decorate([n.property({readOnly:!0})],u.prototype,"error",void 0),t.__decorate([n.property({readOnly:!0})],u.prototype,"spatialReference",null),t.__decorate([n.property({readOnly:!0})],u.prototype,"state",void 0),t.__decorate([n.property()],u.prototype,"view",void 0),u=t.__decorate([p.subclass("esri.widgets.BasemapGallery.support.BasemapGalleryItem")],u);return u}));
