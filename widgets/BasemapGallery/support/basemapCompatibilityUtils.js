/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import e from"../../../core/Error.js";import{isNone as t,isSome as a}from"../../../core/maybe.js";import{throwIfAborted as i}from"../../../core/promiseUtils.js";import{isTiledLayer as r,isBasemapSupportedLayer as n}from"../../../layers/support/layerUtils.js";import{stringFromViewingMode as s,ViewingMode as o}from"../../../views/ViewingMode.js";import{getTileInfoAndExtentFromWMTSLayer as l,checkIfTileInfoSupportedForView as p}from"../../../views/3d/terrain/terrainUtils.js";import{TilingScheme as c}from"../../../views/3d/terrain/TilingScheme.js";import{isSpatialReferenceSupported as m}from"../../../views/support/spatialReferenceSupport.js";async function f(e,t={}){await y(e,t),i(t)}async function u(e,t={}){const{basemap:a,view:n}=e;if(i(t),"spatialReferenceLocked"in n&&!n.spatialReferenceLocked)return;if(await a.load(t),i(t),0===a.baseLayers.length)return;const s=a.baseLayers.getItemAt(0);if(!r(s))return;if(a.spatialReference){if(n.spatialReference.equals(a.spatialReference))return;w()}await s.load(t),i(t);const o=(("supportedSpatialReferences"in s?s.supportedSpatialReferences:null)||["tileInfo"in s?s.tileInfo.spatialReference:null]).filter(Boolean);0!==o.length&&o.every((e=>!n.spatialReference.equals(e)))&&w()}function w(){throw new e("basemap-compatibility:incompatible-spatial-reference","Basemap spatial reference is not compatible with the view")}async function y(t,a){const{basemap:i,view:r}=t;if(await i.load(a),0===i.baseLayers.length)return;const s=i.baseLayers.concat(i.referenceLayers).toArray().filter((e=>!n(e))).map((t=>new e("basemap-compatibility:unsupported-basemap-layer-type","Unsupported basemap layer type ${operationalLayerType}",{layer:t,operationalLayerType:t.operationalLayerType||"unknown"})));if(s.length)throw s[0];const o=i.baseLayers.getItemAt(0);if(n(o)){try{await o.load(a)}catch(l){const t="basemap-compatibility:unknown-error",a="Unknown basemap compatibility error",{name:i=t,message:r=a,details:n}=l;throw new e(i,r,n)}b(o,r)}}function b(i,r){const n=r.state.viewingMode;if(!n)return;let f,u;if("wmts"===i?.type){const a=l(i,r.spatialReference,n);if(t(a.tileInfo))throw new e("basemapgalleryitem:tiling-scheme-incompatible","Basemap tiling scheme is incompatible with the view");f=a.tileInfo,u=a.fullExtent}else f=i.tileInfo,u=i.fullExtent;if(t(f))return;if(!m(f.spatialReference,n))throw new e(`basemapgalleryitem:spatial-reference-unsupported-${s(n)}`,`Basemap spatial reference is unsupported in ${s(n)} mode`);const w=f.spatialReference.isGeographic,y="vector-tile"===i?.type?f.getOrCreateCompatible(256,w?1:2):null;if(n===o.Global){let t=p(f,u,null,n);if(t&&"vector-tile"===i?.type&&a(u)&&y&&!p(y,u,null,n)&&(t=null),t){const a=f.spatialReference.isWebMercator?"web-mercator":"wgs84";throw new e(`basemapgalleryitem:tiling-scheme-unsupported-${a}-global`,"Basemap tiling scheme is unsupported in global mode",{error:t})}}else if(c.checkUnsupported(f))throw new e("basemapgalleryitem:tiling-scheme-unsupported-local","Basemap tiling scheme is unsupported in local mode");const b=r.get("basemapTerrain.tilingScheme");if(b&&!b.compatibleWith(f)&&("vector-tile"!==i?.type||!y||!b.compatibleWith(y)))throw new e("basemapgalleryitem:tiling-scheme-incompatible","Basemap tiling scheme is incompatible with the view")}export{u as default2DCompatibility,f as default3DCompatibility};
