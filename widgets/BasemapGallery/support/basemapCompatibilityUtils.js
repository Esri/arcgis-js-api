/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/Error","../../../core/maybe","../../../core/promiseUtils","../../../layers/support/layerUtils","../../../views/ViewingMode","../../../views/3d/terrain/terrainUtils","../../../views/3d/terrain/TilingScheme","../../../views/support/spatialReferenceSupport"],(function(e,t,i,a,r,n,o,l,s,p){"use strict";function c(e){return f.apply(this,arguments)}function f(){return(f=t._asyncToGenerator((function*(e,t={}){yield d(e,t),r.throwIfAborted(t)}))).apply(this,arguments)}function m(e){return u.apply(this,arguments)}function u(){return(u=t._asyncToGenerator((function*(e,t={}){const{basemap:i,view:o}=e;if(r.throwIfAborted(t),"spatialReferenceLocked"in o&&!o.spatialReferenceLocked)return;if(yield i.load(t),r.throwIfAborted(t),0===i.baseLayers.length)return;const l=i.baseLayers.getItemAt(0);if(!n.isTiledLayer(l))return;if(i.spatialReference){if(o.spatialReference.equals(i.spatialReference))return;y()}yield l.load(t),r.throwIfAborted(t);const s=(("supportedSpatialReferences"in l?l.supportedSpatialReferences:null)||["tileInfo"in l?l.tileInfo?.spatialReference:null]).filter(a.isSome);0!==s.length&&s.every((e=>!o.spatialReference.equals(e)))&&y()}))).apply(this,arguments)}function y(){throw new i("basemap-compatibility:incompatible-spatial-reference","Basemap spatial reference is not compatible with the view")}function d(e,t){return b.apply(this,arguments)}function b(){return(b=t._asyncToGenerator((function*(e,t){const{basemap:a,view:r}=e;if(yield a.load(t),0===a.baseLayers.length)return;const o=a.baseLayers.concat(a.referenceLayers).toArray().filter((e=>!n.isBasemapSupportedLayer(e))).map((e=>new i("basemap-compatibility:unsupported-basemap-layer-type","Unsupported basemap layer type ${operationalLayerType}",{layer:e,operationalLayerType:e.operationalLayerType||"unknown"})));if(o.length)throw o[0];const l=a.baseLayers.getItemAt(0);if(n.isBasemapSupportedLayer(l)){try{yield l.load(t)}catch(s){const e="basemap-compatibility:unknown-error",t="Unknown basemap compatibility error",{name:a=e,message:r=t,details:n}=s;throw new i(a,r,n)}h(l,r)}}))).apply(this,arguments)}function h(e,t){const r=t.state.viewingMode;if(!r)return;let n,c;if("wmts"===e?.type){const o=l.getTileInfoAndExtentFromWMTSLayer(e,t.spatialReference,r);if(a.isNone(o.tileInfo))throw new i("basemapgalleryitem:tiling-scheme-incompatible","Basemap tiling scheme is incompatible with the view");n=o.tileInfo,c=o.fullExtent}else n=e.tileInfo,c=e.fullExtent;if(a.isNone(n))return;if(!p.isSpatialReferenceSupported(n.spatialReference,r))throw new i(`basemapgalleryitem:spatial-reference-unsupported-${o.stringFromViewingMode(r)}`,`Basemap spatial reference is unsupported in ${o.stringFromViewingMode(r)} mode`);const f=n.spatialReference.isGeographic,m="vector-tile"===e?.type?n.getOrCreateCompatible(256,f?1:2):null;if(r===o.ViewingMode.Global){let t=l.checkIfTileInfoSupportedForView(n,c,null,r);if(t&&"vector-tile"===e?.type&&a.isSome(c)&&m&&!l.checkIfTileInfoSupportedForView(m,c,null,r)&&(t=null),t){const e=n.spatialReference.isWebMercator?"web-mercator":"wgs84";throw new i(`basemapgalleryitem:tiling-scheme-unsupported-${e}-global`,"Basemap tiling scheme is unsupported in global mode",{error:t})}}else if(s.TilingScheme.checkUnsupported(n))throw new i("basemapgalleryitem:tiling-scheme-unsupported-local","Basemap tiling scheme is unsupported in local mode");const u=t.get("basemapTerrain.tilingScheme");if(u&&!u.compatibleWith(n)&&("vector-tile"!==e?.type||!m||!u.compatibleWith(m)))throw new i("basemapgalleryitem:tiling-scheme-incompatible","Basemap tiling scheme is incompatible with the view")}e.default2DCompatibility=m,e.default3DCompatibility=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
