/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/Error","../../../core/maybe","../../../core/promiseUtils","../../../layers/support/layerUtils","../../../views/ViewingMode","../../../views/3d/terrain/terrainUtils","../../../views/3d/terrain/TilingScheme","../../../views/support/spatialReferenceSupport"],(function(e,t,i,a,r,n,o,l,s,p){"use strict";function c(e){return u.apply(this,arguments)}function u(){return(u=t._asyncToGenerator((function*(e,t={}){yield d(e,t),r.throwIfAborted(t)}))).apply(this,arguments)}function f(e){return m.apply(this,arguments)}function m(){return(m=t._asyncToGenerator((function*(e,t={}){const{basemap:i,view:a}=e;if(r.throwIfAborted(t),"spatialReferenceLocked"in a&&!a.spatialReferenceLocked)return;if(yield i.load(t),r.throwIfAborted(t),0===i.baseLayers.length)return;const o=i.baseLayers.getItemAt(0);if(!n.isTiledLayer(o))return;if(i.spatialReference){if(a.spatialReference.equals(i.spatialReference))return;y()}yield o.load(t),r.throwIfAborted(t);const l=(("supportedSpatialReferences"in o?o.supportedSpatialReferences:null)||["tileInfo"in o?o.tileInfo.spatialReference:null]).filter(Boolean);0!==l.length&&l.every((e=>!a.spatialReference.equals(e)))&&y()}))).apply(this,arguments)}function y(){throw new i("basemap-compatibility:incompatible-spatial-reference","Basemap spatial reference is not compatible with the view")}function d(e,t){return b.apply(this,arguments)}function b(){return(b=t._asyncToGenerator((function*(e,t){const{basemap:a,view:r}=e;if(yield a.load(t),0===a.baseLayers.length)return;const o=a.baseLayers.concat(a.referenceLayers).toArray().filter((e=>!n.isBasemapSupportedLayer(e))).map((e=>new i("basemap-compatibility:unsupported-basemap-layer-type","Unsupported basemap layer type ${operationalLayerType}",{layer:e,operationalLayerType:e.operationalLayerType||"unknown"})));if(o.length)throw o[0];const l=a.baseLayers.getItemAt(0);if(n.isBasemapSupportedLayer(l)){try{yield l.load(t)}catch(s){const e="basemap-compatibility:unknown-error",t="Unknown basemap compatibility error",{name:a=e,message:r=t,details:n}=s;throw new i(a,r,n)}h(l,r)}}))).apply(this,arguments)}function h(e,t){const r=t.state.viewingMode;if(!r)return;let n,c;if("wmts"===e?.type){const o=l.getTileInfoAndExtentFromWMTSLayer(e,t.spatialReference,r);if(a.isNone(o.tileInfo))throw new i("basemapgalleryitem:tiling-scheme-incompatible","Basemap tiling scheme is incompatible with the view");n=o.tileInfo,c=o.fullExtent}else n=e.tileInfo,c=e.fullExtent;if(a.isNone(n))return;if(!p.isSpatialReferenceSupported(n.spatialReference,r))throw new i(`basemapgalleryitem:spatial-reference-unsupported-${o.stringFromViewingMode(r)}`,`Basemap spatial reference is unsupported in ${o.stringFromViewingMode(r)} mode`);const u=n.spatialReference.isGeographic,f="vector-tile"===e?.type?n.getOrCreateCompatible(256,u?1:2):null;if(r===o.ViewingMode.Global){let t=l.checkIfTileInfoSupportedForView(n,c,null,r);if(t&&"vector-tile"===e?.type&&a.isSome(c)&&f&&!l.checkIfTileInfoSupportedForView(f,c,null,r)&&(t=null),t){const e=n.spatialReference.isWebMercator?"web-mercator":"wgs84";throw new i(`basemapgalleryitem:tiling-scheme-unsupported-${e}-global`,"Basemap tiling scheme is unsupported in global mode",{error:t})}}else if(s.TilingScheme.checkUnsupported(n))throw new i("basemapgalleryitem:tiling-scheme-unsupported-local","Basemap tiling scheme is unsupported in local mode");const m=t.get("basemapTerrain.tilingScheme");if(m&&!m.compatibleWith(n)&&("vector-tile"!==e?.type||!f||!m.compatibleWith(f)))throw new i("basemapgalleryitem:tiling-scheme-incompatible","Basemap tiling scheme is incompatible with the view")}e.default2DCompatibility=f,e.default3DCompatibility=c,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
