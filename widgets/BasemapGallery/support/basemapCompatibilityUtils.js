/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/Error","../../../core/maybe","../../../core/promiseUtils","../../../layers/support/layerUtils","../../../views/ViewingMode","../../../views/3d/terrain/terrainUtils","../../../views/3d/terrain/TilingScheme","../../../views/support/spatialReferenceSupport"],(function(e,t,i,a,r,n,o,l,s,p){"use strict";function c(e){return u.apply(this,arguments)}function u(){return(u=t._asyncToGenerator((function*(e,t={}){yield d(e,t),r.throwIfAborted(t)}))).apply(this,arguments)}function f(e){return m.apply(this,arguments)}function m(){return(m=t._asyncToGenerator((function*(e,t={}){const{basemap:i,view:a}=e;if(r.throwIfAborted(t),"spatialReferenceLocked"in a&&!a.spatialReferenceLocked)return;if(yield i.load(t),r.throwIfAborted(t),0===i.baseLayers.length)return;const o=i.baseLayers.getItemAt(0);if(!n.isTiledLayer(o))return;if(i.spatialReference){if(a.spatialReference.equals(i.spatialReference))return;y()}yield o.load(t),r.throwIfAborted(t);const l=(("supportedSpatialReferences"in o?o.supportedSpatialReferences:null)||["tileInfo"in o?o.tileInfo.spatialReference:null]).filter(Boolean);0!==l.length&&l.every((e=>!a.spatialReference.equals(e)))&&y()}))).apply(this,arguments)}function y(){throw new i("basemap-compatibility:incompatible-spatial-reference","Basemap spatial reference is not compatible with the view")}function d(e,t){return b.apply(this,arguments)}function b(){return(b=t._asyncToGenerator((function*(e,t){const{basemap:a,view:r}=e;if(yield a.load(t),0===a.baseLayers.length)return;const n=h(a.baseLayers.concat(a.referenceLayers));if(n.length)throw n[0];const o=a.baseLayers.getItemAt(0);try{yield o.load(t)}catch(l){const e="basemap-compatibility:unknown-error",t="Unknown basemap compatibility error",{name:a=e,message:r=t,details:n}=l;throw new i(a,r,n)}w(o,r)}))).apply(this,arguments)}function h(e){const t=["ArcGISTiledImageServiceLayer","ArcGISTiledMapServiceLayer","OpenStreetMap","VectorTileLayer","WebTiledLayer"];return e.toArray().filter((e=>-1===t.indexOf(e.operationalLayerType))).map((e=>new i("basemap-compatibility:unsupported-basemap-layer-type","Unsupported basemap layer type ${operationalLayerType}",{layer:e,operationalLayerType:e.operationalLayerType||"unknown"})))}function w(e,t){const r=t.state.viewingMode;if(!r)return;let c=e.tileInfo,u=e.fullExtent;if(n.isWMTSLayer(e)){const n=l.getTileInfoAndExtentFromWMTSLayer(e,t.spatialReference,r);if(a.isNone(n.tileInfo))throw new i("basemapgalleryitem:tiling-scheme-incompatible","Basemap tiling scheme is incompatible with the view");c=n.tileInfo,u=n.fullExtent}if(a.isNone(c))return;if(!p.isSpatialReferenceSupported(c.spatialReference,r))throw new i(`basemapgalleryitem:spatial-reference-unsupported-${o.stringFromViewingMode(r)}`,`Basemap spatial reference is unsupported in ${o.stringFromViewingMode(r)} mode`);const f=c.spatialReference.isGeographic,m=l.isVectorTileLayer(e)?c.getOrCreateCompatible(256,f?1:2):null;if(r===o.ViewingMode.Global){let t=l.checkIfTileInfoSupportedForView(c,u,null,r);if(t&&l.isVectorTileLayer(e)&&a.isSome(u)&&m&&!l.checkIfTileInfoSupportedForView(m,u,null,r)&&(t=null),t){const e=c.spatialReference.isWebMercator?"web-mercator":"wgs84";throw new i(`basemapgalleryitem:tiling-scheme-unsupported-${e}-global`,"Basemap tiling scheme is unsupported in global mode",{error:t})}}else if(s.default.checkUnsupported(c))throw new i("basemapgalleryitem:tiling-scheme-unsupported-local","Basemap tiling scheme is unsupported in local mode");const y=t.get("basemapTerrain.tilingScheme");if(y&&!y.compatibleWith(c)&&!(l.isVectorTileLayer(e)&&m&&y.compatibleWith(m)))throw new i("basemapgalleryitem:tiling-scheme-incompatible","Basemap tiling scheme is incompatible with the view")}e.default2DCompatibility=f,e.default3DCompatibility=c,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
