/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../core/compilerUtils","../../../core/Error","../../../core/promiseUtils","../../../views/support/spatialReferenceSupport","../../../layers/support/layerUtils","../../../views/3d/terrain/TilingScheme","../../../views/3d/terrain/terrainUtils"],(function(e,t,a,i,r,n,o,l){"use strict";async function s(e,t={}){await m(e,t),i.throwIfAborted(t)}async function p(e,t={}){const{basemap:a,view:r}=e;if(await a.load(t),i.throwIfAborted(t),0===a.baseLayers.length)return;const o=a.baseLayers.getItemAt(0);if(!n.isTiledLayer(o))return;if(a.spatialReference){if(r.spatialReference.equals(a.spatialReference))return;c()}await o.load(t),i.throwIfAborted(t);const l=(o.get("supportedSpatialReferences")||[o.get("tileInfo.spatialReference")]).filter(Boolean);0!==l.length&&l.every((e=>!r.spatialReference.equals(e)))&&c()}function c(){throw new a("basemap-compatibility:incompatible-spatial-reference","Basemap spatial reference is not compatible with the view")}async function m(e,i){const{basemap:r,view:n}=e;if(await r.load(i),0===r.baseLayers.length)return;const o=f(r.baseLayers.concat(r.referenceLayers));if(o.length)throw o[0];const l=t.typeCast(r.baseLayers.getItemAt(0))();try{await l.load(i)}catch(s){const e="basemap-compatibility:unknown-error",t="Unknown basemap compatibility error",{name:i=e,message:r=t,details:n}=s;throw new a(i,r,n)}u(l,n)}function f(e){const t=["ArcGISTiledImageServiceLayer","ArcGISTiledMapServiceLayer","OpenStreetMap","VectorTileLayer","WebTiledLayer"];return e.toArray().filter((e=>-1===t.indexOf(e.operationalLayerType))).map((e=>new a("basemap-compatibility:unsupported-basemap-layer-type","Unsupported basemap layer type ${operationalLayerType}",{layer:e,operationalLayerType:e.operationalLayerType||"unknown"})))}function u(e,t){const i=e.tileInfo;if(!i)return;const n=t.viewingMode;if(!n)return;if(!r.isSpatialReferenceSupported(i.spatialReference,n))throw new a(`basemapgalleryitem:spatial-reference-unsupported-${n}`,`Basemap spatial reference is unsupported in ${n} mode`);if("global"===n){let t=l.checkIfTileInfoSupportedForView(i,e.fullExtent,null,1);if(t&&e.compatibleTileInfo256&&!l.checkIfTileInfoSupportedForView(e.compatibleTileInfo256,e.fullExtent,null,1)&&(t=null),t){const e=i.spatialReference.isWebMercator?"web-mercator":"wgs84";throw new a(`basemapgalleryitem:tiling-scheme-unsupported-${e}-global`,"Basemap tiling scheme is unsupported in global mode",{error:t})}}else if(o.checkUnsupported(i))throw new a("basemapgalleryitem:tiling-scheme-unsupported-local","Basemap tiling scheme is unsupported in local mode");const s=t.get("basemapTerrain.tilingScheme");if(s&&!s.compatibleWith(i)&&(!e.compatibleTileInfo256||!s.compatibleWith(e.compatibleTileInfo256)))throw new a("basemapgalleryitem:tiling-scheme-incompatible","Basemap tiling scheme is incompatible with the view")}e.default2DCompatibility=p,e.default3DCompatibility=s,Object.defineProperty(e,"__esModule",{value:!0})}));
