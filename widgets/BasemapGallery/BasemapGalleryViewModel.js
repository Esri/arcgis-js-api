/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../Basemap","../../core/Collection","../../core/HandleOwner","../../core/Loadable","../../core/maybe","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/cast","../../core/arrayUtils","../../core/accessorSupport/decorators/subclass","../../geometry/projection","../../geometry/support/spatialReferenceUtils","../../support/basemapUtils","./support/basemapCompatibilityUtils","./support/BasemapGalleryItem","./support/LocalBasemapsSource","./support/PortalBasemapsSource"],(function(e,t,i,a,s,r,o,n,c,p,l,u,d,m,h,y,v,f,_){"use strict";const b=a.ofType(v);function w(e){return e&&"esri.portal.Portal"===e.declaredClass}function g(e){return e&&!(e instanceof _)&&(!!e.portal||!!e.query)}function B(e){return e&&"basemaps"in e&&"state"in e&&"refresh"in e}let I=function(t){function s(e){var i;return(i=t.call(this,e)||this)._loadingProjectionEngine=!1,i.items=new b,i.source=new _,i.view=null,i}e._inheritsLoose(s,t);var c=s.prototype;return c.initialize=function(){const e=()=>this._recreateItems();this.handles.add([n.watch((()=>"ready"===this.state?this.compatibilityFunction:null),(()=>this._updateItems())),n.on((()=>this.source?.basemaps),"change",e,{onListenerAdd:e})])},c.castSource=function(e){return Array.isArray(e)||a.isCollection(e)?new f({basemaps:e}):w(e)?new _({portal:e}):g(e)?new _(e):B(e)?e:null},c.basemapEquals=function(e,t){return h.contentEquals(e,t)},c.refresh=function(){this._recreateItems()},c.load=function(e){return this.addResolvingPromise(r.isLoadable(this.source)?this.source.load(e):null),Promise.resolve(this)},c._recreateItems=function(){const e=this.source?.basemaps,{view:t,compatibilityFunction:i}=this;this.items.removeAll().forEach((e=>e.destroy())),e&&this.items.addMany(e.map((e=>new v({basemap:e,compatibilityFunction:i,view:t}))))},c._updateItems=function(){for(const e of this.items)e.compatibilityFunction=this.compatibilityFunction,e.view=this.view},e._createClass(s,[{key:"activeBasemap",get:function(){return this.view?.map?.basemap??null},set:function(e){if(!this.view.map)return;const t="string"==typeof e?i.fromId(e):e;if(!t||!this.view.ready)return this.view.map.basemap=t,void this._clearOverride("activeBasemap");const a=t.spatialReference||this.items?.find((e=>this.basemapEquals(t,e.basemap)))?.spatialReference;if(a&&"spatialReferenceLocked"in this.view&&!this.view.spatialReferenceLocked){const i=this.view.spatialReference;if(o.isSome(a)&&!m.equals(i,a)&&!d.canProjectWithoutEngine(this.view.spatialReference,a)&&!d.isLoaded())return this._override("activeBasemap",t),this._loadingProjectionEngine=!0,void d.load().then((()=>{this._get("activeBasemap")===e&&(this.view.map.basemap=e,this.view.spatialReference=a,this._clearOverride("activeBasemap"))}),(()=>{})).then((()=>{this._loadingProjectionEngine=!1}));this.view.map.basemap=t,this._clearOverride("activeBasemap"),o.isSome(a)&&!m.equals(this.view.spatialReference,a)&&(this.view.spatialReference=a)}else this.view.map.basemap=t,this._clearOverride("activeBasemap")}},{key:"activeBasemapIndex",get:function(){const{state:e,items:t,activeBasemap:i}=this;if("ready"!==e)return-1;const a=t.findIndex((e=>e.basemap===i));return-1===a?t.findIndex((e=>this.basemapEquals(e.basemap,i))):a}},{key:"compatibilityFunction",get:function(){return"3d"===this.view?.type?y.default3DCompatibility:y.default2DCompatibility},set:function(e){this._overrideIfSome("compatibilityFunction",e)}},{key:"state",get:function(){return this.view?.ready&&this.source?this._loadingProjectionEngine?"loading":"ready":"disabled"}}]),s}(s.HandleOwnerMixin(r));t.__decorate([c.property()],I.prototype,"_loadingProjectionEngine",void 0),t.__decorate([c.property()],I.prototype,"activeBasemap",null),t.__decorate([c.property({readOnly:!0})],I.prototype,"activeBasemapIndex",null),t.__decorate([c.property()],I.prototype,"compatibilityFunction",null),t.__decorate([c.property({readOnly:!0,type:b})],I.prototype,"items",void 0),t.__decorate([c.property()],I.prototype,"source",void 0),t.__decorate([p.cast("source")],I.prototype,"castSource",null),t.__decorate([c.property({readOnly:!0})],I.prototype,"state",null),t.__decorate([c.property()],I.prototype,"view",void 0),I=t.__decorate([u.subclass("esri.widgets.BasemapGallery.BasemapGalleryViewModel")],I);return I}));
