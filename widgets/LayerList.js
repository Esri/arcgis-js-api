// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.5/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../core/accessorSupport/decorators","./Widget","./support/widget","dojo/i18n!../nls/common","dojo/i18n!./LayerList/nls/LayerList","../core/HandleRegistry","./LayerList/LayerListViewModel","../core/watchUtils"],function(e,i,t,n,r,s,o,l,a,c,d,u){var p={base:"esri-layer-list esri-widget esri-widget--panel",noItems:"esri-layer-list__no-items",list:"esri-layer-list__list",listRoot:"esri-layer-list__list--root",listExclusive:"esri-layer-list__list--exclusive",listInherited:"esri-layer-list__list--inherited",listIndependent:"esri-layer-list__list--independent",item:"esri-layer-list__item",itemError:"esri-layer-list__item--error",itemInvisibleAtScale:"esri-layer-list__item--invisible-at-scale",itemUpdating:"esri-layer-list__item--updating",itemChildren:"esri-layer-list__item--has-children",itemContainer:"esri-layer-list__item-container",actionsMenu:"esri-layer-list__item-actions-menu",actionsMenuItem:"esri-layer-list__item-actions-menu-item",actions:"esri-layer-list__item-actions",actionsList:"esri-layer-list__item-actions-list",action:"esri-layer-list__item-action",actionIcon:"esri-layer-list__item-action-icon",actionImage:"esri-layer-list__item-action-image",actionTitle:"esri-layer-list__item-action-title",label:"esri-layer-list__item-label",errorMessage:"esri-layer-list__item-error-message",title:"esri-layer-list__item-title",toggleVisible:"esri-layer-list__item-toggle",toggleVisibleIcon:"esri-layer-list__item-toggle-icon",childToggle:"esri-layer-list__child-toggle",childToggleOpen:"esri-layer-list__child-toggle--open",childOpened:"esri-layer-list__child-toggle-icon--opened",childClosed:"esri-layer-list__child-toggle-icon--closed",childClosed_RTL:"esri-layer-list__child-toggle-icon--closed-rtl",disabled:"esri-disabled",hidden:"esri-hidden",iconClose:"esri-icon-close",iconEllipses:"esri-icon-handle-horizontal",iconVisible:"esri-icon-visible",iconInvisible:"esri-icon-non-visible",iconRadioSelected:"esri-icon-radio-checked",iconRadioUnselected:"esri-icon-radio-unchecked",iconNoticeTriangle:"esri-icon-notice-triangle",iconChildrenOpen:"esri-icon-down-arrow",iconDownArrow:"esri-icon-down-arrow",iconRightArrow:"esri-icon-right-triangle-arrow",iconLeftArrow:"esri-icon-left-triangle-arrow"},g={actions:"actions",actionSection:"action-section",items:"items"},_={exclusive:"exclusive",inherited:"inherited",independent:"independent"},h=e.toUrl("./LayerList/images/default-action.svg"),y=function(e){function i(){var i=e.call(this)||this;return i._handleRegistry=new c,i.createActionsFunction=null,i.statusIndicatorsVisible=!0,i.listItemCreatedFunction=null,i.operationalItems=null,i.view=null,i.viewModel=new d,i}return t(i,e),i.prototype.postInitialize=function(){var e=this,i=this.operationalItems;this.own(u.on(this,"operationalItems","change",function(){return e._itemsChanged(i)}))},i.prototype.destroy=function(){this._handleRegistry.destroy(),this._handleRegistry=null},i.prototype.triggerAction=function(e,i){},i.prototype.render=function(){var e=this,i=this._getItems(),t=this.get("viewModel.state"),n=0===i.length?o.tsx("div",{"class":p.noItems},a.noItemsToDisplay):o.tsx("ul",{"class":o.join(p.list,p.listRoot,p.listIndependent)},i.map(function(i,t){return e._renderItem(i,null)})),r=(s={},s[p.hidden]="loading"===t,s[p.disabled]="disabled"===t,s);return o.tsx("div",{"class":p.base,classes:r},n);var s},i.prototype._getItems=function(){var e=this;return this.operationalItems.toArray().filter(function(i){return e.errorsVisible||!i.error})},i.prototype._renderItem=function(e,i){var t=this,n=this.id,r=n+"_"+e.uid,s=r+"_actions",c=r+"__list",d=r+"__title",u=e.children.length,g=!!u,h=!!e.error,y=h?a.layerError:"",m=e.visibilityMode,v=e.children&&e.children.toArray(),b=_.exclusive,f=_.inherited,A=(H={},H[p.listExclusive]=m===b,H[p.listInherited]=m===f,H[p.listIndependent]=m!==f&&m!==b,H),I=(j={},j[p.itemChildren]=g,j[p.itemError]=!!y,j[p.itemUpdating]=e.updating&&!i&&this.statusIndicatorsVisible,j[p.itemInvisibleAtScale]=!e.visibleAtCurrentScale,j),x=this._countActions(e.actionsSections),w=x?this._renderActionMenuItem(e,e.actionsSections):null,k=(F={},F[p.iconEllipses]=!e.actionsOpen,F[p.iconClose]=e.actionsOpen,F),C=e.actionsOpen?l.close:l.open,O=x>1?o.tsx("div",{key:r+"__actions-menu-toggle","data-item":e,onclick:this._toggleActionsOpen,onkeydown:this._toggleActionsOpen,"class":p.actionsMenuItem,tabindex:"0",role:"button","aria-controls":s,"aria-label":C,title:C},o.tsx("span",{"aria-hidden":"true",classes:k})):null,S=x?o.tsx("div",{key:r+"__actions-menu","class":p.actionsMenu},w,O):null,R=x>1?this._renderActionsSections(e,e.actionsSections,s):null,M=g?o.tsx("ul",{key:c,id:c,"class":p.list,classes:A,"aria-expanded":e.open?"true":"false",role:m===b?"radiogroup":"group",hidden:e.open?null:!0},v.map(function(i,n){return t._renderItem(i,e)})):null,L=(U={},U[p.childToggleOpen]=e.open,U),T=e.open?l.collapse:l.expand,E=g?o.tsx("span",{onclick:this._toggleChildrenClick,onkeydown:this._toggleChildrenClick,"data-item":e,key:r+"__toggle-children","class":p.childToggle,classes:L,tabindex:"0",role:"button","aria-controls":c,"aria-label":T,title:T},o.tsx("span",{"aria-hidden":"true","class":o.join(p.childClosed,p.iconRightArrow)}),o.tsx("span",{"aria-hidden":"true","class":o.join(p.childOpened,p.iconDownArrow)}),o.tsx("span",{"aria-hidden":"true","class":o.join(p.childClosed_RTL,p.iconLeftArrow)})):null,V=this._createLabelNode(e,i,r,d),N=h?o.tsx("div",{key:r+"__error","class":p.errorMessage,role:"alert"},o.tsx("span",{"aria-hidden":"true","class":p.iconNoticeTriangle}),o.tsx("span",null,y)):null;return o.tsx("li",{key:r+"__list-item","class":p.item,classes:I,"aria-labelledby":d},o.tsx("div",{key:r+"__list-item-container","class":p.itemContainer},E,V,S),N,R,M);var H,j,F,U},i.prototype._createLabelNode=function(e,i,t,n){var r=t+"__label",s=_.exclusive,l=_.inherited,c=i&&i.visibilityMode,d=(m={},m[p.iconRadioSelected]=c===s&&e.visible,m[p.iconRadioUnselected]=c===s&&!e.visible,m[p.iconVisible]=c!==s&&e.visible,m[p.iconInvisible]=c!==s&&!e.visible,m),u=c===s?"radio":"checkbox",g=e.title||a.untitledLayer,h=e.visibleAtCurrentScale?g:g+" ("+a.layerInvisibleAtScale+")",y=o.tsx("span",{id:n,title:h,"aria-label":h,"class":p.title},g);return c===l?o.tsx("div",{key:r,"class":p.label},y):o.tsx("div",{key:r,onclick:this._labelClick,onkeydown:this._labelClick,"data-item":e,"data-parent-visibility":c,tabindex:"0","aria-checked":e.visible?"true":"false",role:u,"aria-labelledby":n,"class":p.label},o.tsx("span",{"class":p.toggleVisible},o.tsx("span",{"class":p.toggleVisibleIcon,"aria-hidden":"true",classes:d})),y);var m},i.prototype._renderActionMenuItem=function(e,i){var t=i.getItemAt(0),n=t&&t.getItemAt(0);if(n){var r=this._getActionImageStyles(n),s=(a={},a[n.className]=!!n.className,a[p.actionImage]=!!r["background-image"],a),l=n.title;return o.tsx("div",{key:n.uid+"__action-menu-item",bind:this,"data-item":e,"data-action":n,onclick:this._triggerAction,onkeydown:this._triggerAction,"class":p.actionsMenuItem,role:"button",tabindex:"0",title:l,"aria-label":l},o.tsx("span",{classes:s,styles:r}))}var a},i.prototype._watchActionSectionChanges=function(e,i){var t=this,n=g.actionSection+i;this._handleRegistry.add(e.on("change",this.scheduleRender.bind(this)),n),e.forEach(function(e){return t._renderOnActionChanges(e,i)})},i.prototype._renderOnActionChanges=function(e,i){var t=this,n=g.actions+i;this._handleRegistry.add([u.init(e,"className, image, id, title, visible",function(){return t.scheduleRender()})],n)},i.prototype._renderOnItemChanges=function(e){var i=this,t=e.uid,n=g.items+t;this._handleRegistry.add([u.init(e,"actionsOpen, visible, open, updating, title, visibleAtCurrentScale, error, visibilityMode",function(){return i.scheduleRender()}),e.actionsSections.on("change",function(){return i.scheduleRender()}),e.children.on("change",function(){return i.scheduleRender()})],n),e.children.forEach(function(e){return i._renderOnItemChanges(e)}),e.actionsSections.forEach(function(e){return i._watchActionSectionChanges(e,t)})},i.prototype._itemsChanged=function(e){var i=this;this._handleRegistry.removeAll(),e.forEach(function(e){return i._renderOnItemChanges(e)}),this.scheduleRender()},i.prototype._renderActionsSections=function(e,i,t){var n=this,r=this.id,s=r+"_"+e.uid,l=i.toArray(),a=l.map(function(i){return o.tsx("ul",{key:s+"__actions-list","class":p.actionsList},n._renderActionSection(e,i))});return o.tsx("div",{role:"group","aria-expanded":e.actionsOpen?"true":"false",key:s+"__actions-section",id:t,"class":p.actions,hidden:e.actionsOpen?null:!0},a)},i.prototype._renderActionSection=function(e,i){var t=this,n=i&&i.toArray();return n.map(function(i){return t._renderAction(e,i)})},i.prototype._renderAction=function(e,i){var t=this._getActionImageStyles(i),n=(r={},r[i.className]=!!i.className,r[p.actionImage]=!!t["background-image"],r);return o.tsx("li",{key:i.uid+"__action",bind:this,"data-item":e,"data-action":i,onclick:this._triggerAction,onkeydown:this._triggerAction,"class":p.action,tabindex:"0",role:"button",title:i.title,"aria-label":i.title},o.tsx("span",{"aria-hidden":"true","class":p.actionIcon,classes:n,styles:t}),o.tsx("span",{"class":p.actionTitle},i.title));var r},i.prototype._countActions=function(e){return e.reduce(function(e,i){return e+i.length},0)},i.prototype._getActionImageStyles=function(e){var i=e.image||null;return e.className||i||(i=h),{"background-image":i?'url("'+i+'")':null}},i.prototype._toggleActionsOpen=function(e){var i=e.currentTarget,t=i["data-item"];t.actionsOpen=!t.actionsOpen},i.prototype._triggerAction=function(e){var i=e.currentTarget,t=i["data-action"],n=i["data-item"];this.triggerAction(t,n)},i.prototype._labelClick=function(e){var i=e.currentTarget,t=i.getAttribute("data-parent-visibility"),n=i["data-item"];t===_.exclusive&&n.visible||(n.visible=!n.visible)},i.prototype._toggleChildrenClick=function(e){var i=e.currentTarget,t=i["data-item"];t.open=!t.open},n([r.aliasOf("viewModel.createActionsFunction"),o.renderable()],i.prototype,"createActionsFunction",void 0),n([r.property(),o.renderable()],i.prototype,"statusIndicatorsVisible",void 0),n([r.property(),o.renderable()],i.prototype,"errorsVisible",void 0),n([r.aliasOf("viewModel.listItemCreatedFunction"),o.renderable()],i.prototype,"listItemCreatedFunction",void 0),n([r.aliasOf("viewModel.operationalItems"),o.renderable()],i.prototype,"operationalItems",void 0),n([r.aliasOf("viewModel.view"),o.renderable()],i.prototype,"view",void 0),n([o.vmEvent("trigger-action"),r.property({type:d}),o.renderable("viewModel.state")],i.prototype,"viewModel",void 0),n([r.aliasOf("viewModel.triggerAction")],i.prototype,"triggerAction",null),n([o.accessibleHandler()],i.prototype,"_toggleActionsOpen",null),n([o.accessibleHandler()],i.prototype,"_triggerAction",null),n([o.accessibleHandler()],i.prototype,"_labelClick",null),n([o.accessibleHandler()],i.prototype,"_toggleChildrenClick",null),i=n([r.subclass("esri.widgets.LayerList")],i)}(r.declared(s));return y});