// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","dojo/i18n!../nls/common","dojo/i18n!./LayerList/nls/LayerList","../core/Handles","../core/watchUtils","../core/accessorSupport/decorators","./Widget","./LayerList/LayerListViewModel","./support/widget"],function(e,t,i,n,s,r,l,o,a,c,d,u){function p(e){var t=e.actionsOpen,i=e.children;t&&(e.actionsOpen=!1),i.forEach(function(e){return p(e)})}var g={base:"esri-layer-list esri-widget esri-widget--panel",noItems:"esri-layer-list__no-items",list:"esri-layer-list__list",listRoot:"esri-layer-list__list--root",listExclusive:"esri-layer-list__list--exclusive",listInherited:"esri-layer-list__list--inherited",listIndependent:"esri-layer-list__list--independent",item:"esri-layer-list__item",itemContent:"esri-layer-list__item-content",itemError:"esri-layer-list__item--error",itemInvisibleAtScale:"esri-layer-list__item--invisible-at-scale",itemUpdating:"esri-layer-list__item--updating",itemChildren:"esri-layer-list__item--has-children",itemContainer:"esri-layer-list__item-container",actionsMenu:"esri-layer-list__item-actions-menu",actionsMenuItem:"esri-layer-list__item-actions-menu-item",actionsMenuItemActive:"esri-layer-list__item-actions-menu-item--active",actions:"esri-layer-list__item-actions",actionsList:"esri-layer-list__item-actions-list",action:"esri-layer-list__item-action",actionIcon:"esri-layer-list__item-action-icon",actionImage:"esri-layer-list__item-action-image",actionTitle:"esri-layer-list__item-action-title",actionToggle:"esri-layer-list__action-toggle",actionToggleOn:"esri-layer-list__action-toggle--on",label:"esri-layer-list__item-label",errorMessage:"esri-layer-list__item-error-message",title:"esri-layer-list__item-title",toggleVisible:"esri-layer-list__item-toggle",toggleVisibleIcon:"esri-layer-list__item-toggle-icon",childToggle:"esri-layer-list__child-toggle",childToggleOpen:"esri-layer-list__child-toggle--open",childOpened:"esri-layer-list__child-toggle-icon--opened",childClosed:"esri-layer-list__child-toggle-icon--closed",childClosed_RTL:"esri-layer-list__child-toggle-icon--closed-rtl",disabled:"esri-disabled",disabledElement:"esri-disabled-element",hidden:"esri-hidden",rotating:"esri-rotating",iconEllipses:"esri-icon-handle-horizontal",iconVisible:"esri-icon-visible",iconInvisible:"esri-icon-non-visible",iconRadioSelected:"esri-icon-radio-checked",iconRadioUnselected:"esri-icon-radio-unchecked",iconNoticeTriangle:"esri-icon-notice-triangle",iconChildrenOpen:"esri-icon-down-arrow",iconDownArrow:"esri-icon-down-arrow",iconRightArrow:"esri-icon-right-triangle-arrow",iconLeftArrow:"esri-icon-left-triangle-arrow",iconLoading:"esri-icon-loading-indicator",iconDefaultAction:"esri-icon-default-action",widgetIcon:"esri-icon-layers"},h={actions:"actions",actionSection:"action-section",items:"items"},_={exclusive:"exclusive",inherited:"inherited",independent:"independent"};return function(e){function t(){var t=e.call(this)||this;return t._handles=new l,t.iconClass=g.widgetIcon,t.statusIndicatorsVisible=!0,t.label=r.widgetLabel,t.listItemCreatedFunction=null,t.operationalItems=null,t.view=null,t.viewModel=new d,t}return i(t,e),t.prototype.postInitialize=function(){var e=this,t=this.operationalItems;this.own(o.on(this,"operationalItems","change",function(){return e._itemsChanged(t)}))},t.prototype.destroy=function(){this._handles.destroy(),this._handles=null},t.prototype.triggerAction=function(e,t){},t.prototype.render=function(){var e,t=this,i=this._getItems(),n=this.get("viewModel.state"),s=0===i.length?u.tsx("div",{class:g.noItems},r.noItemsToDisplay):u.tsx("ul",{class:this.classes(g.list,g.listRoot,g.listIndependent)},i.map(function(e,i){return t._renderItem(e,null)})),l=(e={},e[g.hidden]="loading"===n,e[g.disabled]="disabled"===n,e);return u.tsx("div",{class:this.classes(g.base,l)},s)},t.prototype._getItems=function(){var e=this;return this.operationalItems.toArray().filter(function(t){return e.errorsVisible||!t.error})},t.prototype._getSingleActionButton=function(e){return e.actionsSections.reduce(function(e){return e}).filter(function(e){return e&&"button"===e.type}).getItemAt(0)},t.prototype._renderItem=function(e,t){var i,n,l,o,a=this,c=this.id,d=c+"_"+e.uid,p=d+"_actions",h=d+"__list",y=d+"__title",m=e.children.length,b=!!m,v=!!e.error,f=v?r.layerError:"",I=e.visibilityMode,A=e.children&&e.children.toArray(),x=_.exclusive,w=_.inherited,k=(i={},i[g.listExclusive]=I===x,i[g.listInherited]=I===w,i[g.listIndependent]=I!==w&&I!==x,i),C=(n={},n[g.itemChildren]=b,n[g.itemError]=!!f,n[g.itemUpdating]=e.updating&&!t&&this.statusIndicatorsVisible,n[g.itemInvisibleAtScale]=!e.visibleAtCurrentScale,n),O=this._countActions(e.actionsSections),S=e.panel,M=S&&S.open?S.render():null,L=S&&S.visible?this._renderPanelButton(S):null,T=(l={},l[g.actionsMenuItemActive]=e.actionsOpen,l),E=e.actionsOpen?s.close:s.open,R=1===O&&this._getSingleActionButton(e),V=R?this._renderAction({item:e,action:R,singleAction:!0}):null,N=!R&&O?u.tsx("div",{key:"actions-menu-toggle","data-item":e,bind:this,onclick:this._toggleActionsOpen,onkeydown:this._toggleActionsOpen,class:this.classes(g.actionsMenuItem,T),tabindex:"0",role:"button","aria-controls":p,"aria-label":E,title:E},u.tsx("span",{"aria-hidden":"true",class:g.iconEllipses})):null,H=N||L||V?u.tsx("div",{key:"esri-layer-list__actions-menu",class:g.actionsMenu},L,V,N):null,D=O?this._renderActionsSections(e,e.actionsSections,p):null,P=b?u.tsx("ul",{key:"esri-layer-list__list-items",id:h,class:this.classes(g.list,k),"aria-expanded":e.open?"true":"false",role:I===x?"radiogroup":"group",hidden:!e.open||null},A.map(function(t,i){return a._renderItem(t,e)})):null,U=(o={},o[g.childToggleOpen]=e.open,o),B=e.open?s.collapse:s.expand,F=b?u.tsx("span",{onclick:this._toggleChildrenClick,onkeydown:this._toggleChildrenClick,"data-item":e,key:"esri-layer-list__toggle-children",class:this.classes(g.childToggle,U),tabindex:"0",role:"button","aria-controls":h,"aria-label":B,title:B},u.tsx("span",{"aria-hidden":"true",class:this.classes(g.childClosed,g.iconRightArrow)}),u.tsx("span",{"aria-hidden":"true",class:this.classes(g.childOpened,g.iconDownArrow)}),u.tsx("span",{"aria-hidden":"true",class:this.classes(g.childClosed_RTL,g.iconLeftArrow)})):null,j=this._createLabelNode(e,t,y),z=v?u.tsx("div",{key:"esri-layer-list__error",class:g.errorMessage,role:"alert"},u.tsx("span",{"aria-hidden":"true",class:g.iconNoticeTriangle}),u.tsx("span",null,f)):null;return u.tsx("li",{key:e,class:this.classes(g.item,C),"aria-labelledby":y},u.tsx("div",{key:"esri-layer-list__list-item-container",class:g.itemContainer},F,j,H),z,D,M,P)},t.prototype._createLabelNode=function(e,t,i){var n,s=_.exclusive,l=_.inherited,o=t&&t.visibilityMode,a=(n={},n[g.iconRadioSelected]=o===s&&e.visible,n[g.iconRadioUnselected]=o===s&&!e.visible,n[g.iconVisible]=o!==s&&e.visible,n[g.iconInvisible]=o!==s&&!e.visible,n),c=o===s?"radio":"checkbox",d=e.title||r.untitledLayer,p=e.visibleAtCurrentScale?d:d+" ("+r.layerInvisibleAtScale+")",h=u.tsx("span",{id:i,title:p,"aria-label":p,class:g.title},d);return o===l?u.tsx("div",{key:e,class:g.label},h):u.tsx("div",{key:e,onclick:this._labelClick,onkeydown:this._labelClick,"data-item":e,"data-parent-visibility":o,tabindex:"0","aria-checked":e.visible?"true":"false",role:c,"aria-labelledby":i,class:g.label},u.tsx("span",{class:g.toggleVisible},u.tsx("span",{class:this.classes(g.toggleVisibleIcon,a),"aria-hidden":"true"})),h)},t.prototype._renderPanelButton=function(e){var t,i,n=e.className,s=e.open,r=e.title,l=e.image,o=l||n?n:g.iconDefaultAction,a=this._getIconImageStyles(e),c=(t={},t[g.actionsMenuItemActive]=s,t),d=(i={},i[g.actionImage]=!!a["background-image"],i);return o&&(d[o]=!!o),u.tsx("div",{key:e,bind:this,"data-panel":e,onclick:this._triggerPanel,onkeydown:this._triggerPanel,class:this.classes(g.actionsMenuItem,c),role:"button",tabindex:"0",title:r,"aria-label":r},u.tsx("span",{class:this.classes(d),styles:a}))},t.prototype._watchActionSectionChanges=function(e,t){var i=this,n=h.actionSection+t;this._handles.add(e.on("change",this.scheduleRender.bind(this)),n),e.forEach(function(e){return i._renderOnActionChanges(e,t)})},t.prototype._renderOnActionChanges=function(e,t){var i=this,n=h.actions+t;return"toggle"===e.type?void this._handles.add([o.init(e,["className","image","id","title","visible","value"],function(){return i.scheduleRender()})],n):"slider"===e.type?void this._handles.add([o.init(e,["className","id","title","visible","value","displayValueEnabled","max","min","step"],function(){return i.scheduleRender()})],n):void this._handles.add([o.init(e,["className","image","id","title","visible"],function(){return i.scheduleRender()})],n)},t.prototype._renderOnItemChanges=function(e){var t=this,i=e.uid,n=h.items+i;this._handles.add([o.init(e,["actionsOpen","visible","open","updating","title","visibleAtCurrentScale","error","visibilityMode","panel","panel.title","panel.content","panel.className"],function(){return t.scheduleRender()}),e.actionsSections.on("change",function(){return t.scheduleRender()}),e.children.on("change",function(){return t.scheduleRender()})],n),e.children.forEach(function(e){return t._renderOnItemChanges(e)}),e.actionsSections.forEach(function(e){return t._watchActionSectionChanges(e,i)})},t.prototype._itemsChanged=function(e){var t=this;this._handles.removeAll(),e.forEach(function(e){return t._renderOnItemChanges(e)}),this.scheduleRender()},t.prototype._renderActionsSections=function(e,t,i){var n=this,s=t.toArray(),r=s.map(function(t){return u.tsx("ul",{key:t,class:g.actionsList},n._renderActionSection(e,t))});return u.tsx("div",{role:"group","aria-expanded":e.actionsOpen?"true":"false",key:"esri-layer-list__actions-section",id:i,class:g.actions,hidden:!e.actionsOpen||null},r)},t.prototype._renderActionSection=function(e,t){var i=this;return(t&&t.toArray()).map(function(t){return i._renderAction({item:e,action:t})})},t.prototype._renderAction=function(e){var t,i,n=e.item,s=e.action,r=e.singleAction,l=this._getIconImageStyles(s),o=s.active,a=s.className,c=s.disabled,d=s.title,p="button"!==s.type||s.image||a?a:g.iconDefaultAction,h=(t={},t[g.actionsMenuItem]=r&&"button"===s.type,t[g.action]=!r&&"toggle"!==s.type,t[g.actionToggle]="toggle"===s.type,t[g.actionToggleOn]="toggle"===s.type&&s.value,t[g.disabledElement]=c,t),_=(i={},i[g.actionImage]=!o&&!!l["background-image"],i[g.iconLoading]=o,i[g.rotating]=o,i);p&&(_[p]=!0);var y=u.tsx("span",{"aria-hidden":"true",class:this.classes(g.actionIcon,_),styles:l}),m=r?null:u.tsx("span",{class:g.actionTitle},d),b=[y,m];return r?u.tsx("div",{bind:this,"data-item":n,"data-action":s,role:"button",key:s,onclick:this._triggerAction,onkeydown:this._triggerAction,classes:h,tabindex:"0",title:d,"aria-label":d},b):u.tsx("li",{bind:this,"data-item":n,"data-action":s,key:s,onclick:this._triggerAction,onkeydown:this._triggerAction,classes:h,tabindex:"0",role:"button",title:d,"aria-label":d},b)},t.prototype._countActions=function(e){return e.reduce(function(e,t){return e+t.length},0)},t.prototype._getIconImageStyles=function(e){var t=e.declaredClass=e.image;return{"background-image":t?'url("'+t+'")':null}},t.prototype._toggleActionsOpen=function(e){var t=e.currentTarget,i=t["data-item"],n=i.actionsOpen,s=!n;s&&this.operationalItems.forEach(function(e){return p(e)}),i.actionsOpen=s},t.prototype._triggerPanel=function(e){var t=e.currentTarget,i=t["data-panel"];i&&(i.open=!i.open)},t.prototype._triggerAction=function(e){var t=e.currentTarget,i=t["data-action"],n=t["data-item"];"toggle"===i.type&&(i.value=!i.value),this.triggerAction(i,n)},t.prototype._labelClick=function(e){var t=e.currentTarget,i=t.getAttribute("data-parent-visibility"),n=t["data-item"];i===_.exclusive&&n.visible||(n.visible=!n.visible)},t.prototype._toggleChildrenClick=function(e){var t=e.currentTarget,i=t["data-item"];i.open=!i.open},n([a.property()],t.prototype,"iconClass",void 0),n([a.property(),u.renderable()],t.prototype,"statusIndicatorsVisible",void 0),n([a.property(),u.renderable()],t.prototype,"errorsVisible",void 0),n([a.property()],t.prototype,"label",void 0),n([a.aliasOf("viewModel.listItemCreatedFunction"),u.renderable()],t.prototype,"listItemCreatedFunction",void 0),n([a.aliasOf("viewModel.operationalItems"),u.renderable()],t.prototype,"operationalItems",void 0),n([a.aliasOf("viewModel.view"),u.renderable()],t.prototype,"view",void 0),n([u.vmEvent("trigger-action"),a.property({type:d}),u.renderable("viewModel.state")],t.prototype,"viewModel",void 0),n([a.aliasOf("viewModel.triggerAction")],t.prototype,"triggerAction",null),n([u.accessibleHandler()],t.prototype,"_toggleActionsOpen",null),n([u.accessibleHandler()],t.prototype,"_triggerPanel",null),n([u.accessibleHandler()],t.prototype,"_triggerAction",null),n([u.accessibleHandler()],t.prototype,"_labelClick",null),n([u.accessibleHandler()],t.prototype,"_toggleChildrenClick",null),t=n([a.subclass("esri.widgets.LayerList")],t)}(a.declared(c))});