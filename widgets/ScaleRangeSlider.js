/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../intl","../core/domUtils","../core/events","../core/HandleOwner","../core/watchUtils","../core/accessorSupport/decorators/property","../core/arrayUtils","../core/has","../core/accessorSupport/decorators/cast","../core/accessorSupport/decorators/subclass","./Slider","./Widget","./ScaleRangeSlider/scalePreviewUtils","./ScaleRangeSlider/ScaleRanges","./ScaleRangeSlider/ScaleRangeSliderViewModel","./support/Popover","./support/decorators/accessibleHandler","./support/decorators/messageBundle","../core/Logger","./support/jsxFactory","./support/widgetUtils","../intl/number","../intl/substitute"],(function(e,a,t,l,i,n,s,c,r,o,d,u,m,_,p,v,h,S,g,M,w,f,b,y,x){"use strict";const I={base:"esri-scale-range-slider",scaleIndicator:"esri-scale-range-slider__scale-indicator",scaleIndicatorIcon:"esri-scale-range-slider__scale-indicator-icon",scaleIndicatorContainer:"esri-scale-range-slider__scale-indicator-container",scaleMenuContainer:"esri-scale-range-slider__scale-menu-container",scaleMenuToggle:"esri-scale-range-slider__scale-menu-toggle",scaleMenuToggleText:"esri-scale-range-slider__scale-menu-toggle-text",scaleMenuToggleIcon:"esri-scale-range-slider__scale-menu-toggle-icon",scaleMenuToggleActive:"esri-scale-range-slider__scale-menu-toggle--active",scaleMenu:"esri-scale-range-slider__scale-menu",scaleMenuList:"esri-scale-range-slider__scale-menu-list",scaleMenuListItem:"esri-scale-range-slider__scale-menu-item",scaleMenuListItemActive:"esri-scale-range-slider__scale-menu-item--active",scaleMenuScroller:"esri-scale-range-slider__scale-menu-scroller",scaleItemLabel:"esri-scale-range-slider__scale-item-label",scaleItemValue:"esri-scale-range-slider__scale-item-value",scaleItemValueEditable:"esri-scale-range-slider__scale-item-value--editable",scalePreview:"esri-scale-range-slider__scale-preview",scalePreviewThumbnail:"esri-scale-range-slider__scale-preview-thumbnail",slider:"esri-slider",expandIcon:"esri-icon-down",heading:"esri-widget__heading",hidden:"esri-hidden",input:"esri-input",button:"esri-button",disabled:"esri-disabled",widget:"esri-widget"},T={preview:!0},C={maximumFractionDigits:0},R=e=>`1:${y.formatNumber(e,C)}`,L=e=>{const a=/[^\d.\s]/g,t=e.replace(/.*\(/,"").replace(/\).*$/,"").replace(/.*:/,"").replace(a,"");return parseFloat(t)};let P=function(a){function t(t,n){var s;return(s=a.call(this,t,n)||this)._activeMenu=null,s._activeMenuNode=null,s._activeMenuToggleNode=null,s._activeThumb=null,s._customMaxScale=-1,s._customMinScale=-1,s._focusedMenuItemIndex=-1,s._previewAutoCloseTimeoutId=null,s._previewPopover=new S({owner:e._assertThisInitialized(s),placement:"top",anchorElement:()=>0===s._activeThumb?s._minThumbNode:s._maxThumbNode,offset:[0,16],renderContentFunction:s.renderScalePreview}),s._maxScaleMenuPopover=new S({owner:e._assertThisInitialized(s),placement:"bottom-end",anchorElement:()=>s._activeMenuToggleNode,renderContentFunction:s.renderMaxScaleMenu}),s._minScaleMenuPopover=new S({owner:e._assertThisInitialized(s),placement:"bottom-start",anchorElement:()=>s._activeMenuToggleNode,renderContentFunction:s.renderMinScaleMenu}),s._scaleMenuNode=null,s._slider=new m({thumbCreatedFunction:(a,t,l)=>{0===a&&(s._minThumbNode=l),1===a&&(s._maxThumbNode=l),s.own([i.on(l,"mouseenter",(()=>{const{visibleElements:{preview:t}}=e._assertThisInitialized(s);s._activeThumb=a,s._previewPopover.open=t,s.scheduleRender()})),i.on(l,"mouseleave",(()=>{s._previewAutoCloseTimeoutId||(s._activeThumb=null,s._previewPopover.open=!1,s.scheduleRender())}))])}}),s.disabled=!1,s.label=void 0,s.layer=null,s.maxScale=null,s.maxScaleLimit=null,s.messages=null,s.minScale=null,s.minScaleLimit=null,s.region="US",s.view=null,s.viewModel=new h,s.visibleElements=T,s._handleScaleMenuToggleClick=e=>{const a=e.currentTarget,t=a.getAttribute("data-type"),n="menu-closing-click-handle";if(s.handles.remove(n),t===s._activeMenu)return s._setActiveMenu(null),void(s._activeMenuToggleNode=null);s._setActiveMenu(t),s._activeMenuToggleNode=a,s.handles.add(i.on(document,"mousedown",(e=>{const a=e.target,t=l.closest(a,`.${I.scaleMenuToggle}`),i=t&&t.getAttribute("data-type");if(t&&i===s._activeMenu)return;!i&&s._scaleMenuNode&&!s._scaleMenuNode.contains(a)&&(s._setActiveMenu(null),s.handles.remove(n),s.scheduleRender())})),n)},s._afterMenuListCreate=e=>{s._activeMenuNode=e,e.children[0].focus({preventScroll:!0})},s._handleCustomScaleEntry=e=>{s._setScaleFromMenuSelection(e),s._customMaxScale=-1,s._customMinScale=-1},s._handleCustomScaleInputBlur=()=>{"max"===s._activeMenu?s._customMaxScale=-1:s._customMinScale=-1},s._handleCustomScaleInputKeyDown=a=>{const t=a.currentTarget,{handleCustomScaleSelect:l}=t["data-render-props"],{key:i,ctrlKey:n,metaKey:c}=a,{viewModel:{scaleRanges:r}}=e._assertThisInitialized(s);if("Enter"===i){const e=L(t.value);return l(isNaN(e)?-1:r.clampScale(e)),a.preventDefault(),void a.stopPropagation()}if(i.length>1||n||c)return;/[:,.\d]/.test(i)||(a.preventDefault(),a.stopPropagation())},s._handleScaleMenuKeyDown=e=>{const a=i.eventKey(e);if("Escape"===a||"Tab"===a)return s._setActiveMenu(null),void s._activeMenuToggleNode.focus();if("ArrowUp"!==a&&"ArrowDown"!==a)return;const t=s._activeMenuNode.children,l=s._focusedMenuItemIndex,n="ArrowUp"===a?(0===l?t.length:l)-1:(l+1)%t.length;e.preventDefault(),e.stopPropagation(),t[n].focus(),s._focusedMenuItemIndex=n},s}e._inheritsLoose(t,a);var n=t.prototype;return n.initialize=function(){this.own([s.init(this,"viewModel",(e=>this._slider.viewModel=e?e.sliderViewModel:null)),s.init(this,"_interactive",(e=>{this._slider.disabled=!e,e||this._setActiveMenu(null)})),this._slider.on("thumb-drag",(({index:e})=>{const{visibleElements:{preview:a}}=this;this._activeThumb=e,this._previewPopover.open=a,clearTimeout(this._previewAutoCloseTimeoutId);const t=250;this._previewAutoCloseTimeoutId=setTimeout((()=>{this._previewAutoCloseTimeoutId=null,this._activeThumb=null,this._previewPopover.open=!1,this.scheduleRender()}),t)})),s.whenTrue(this,"view.stationary",(()=>this.scheduleRender()))])},n.destroy=function(){this._previewPopover.destroy(),this._previewPopover=null,this._maxScaleMenuPopover.destroy(),this._maxScaleMenuPopover=null,this._minScaleMenuPopover.destroy(),this._minScaleMenuPopover=null,this._slider.destroy(),this._slider=null},n.castVisibleElements=function(e){return{...T,...e}},n.render=function(){const{_interactive:e,_slider:a,label:t,messages:l,view:i,viewModel:{scaleRanges:n,state:s}}=this,c=l.scaleRangeLabels[n.findScaleRangeByIndex(a.values[0]).id],r=l.scaleRangeLabels[n.findScaleRangeByIndex(a.values[1]).id];return a.layout=b.isRTL(this.container)?"horizontal-reversed":"horizontal",f.tsx("div",{"aria-label":t,class:this.classes(I.base,I.widget,e?null:I.disabled)},"ready"===s&&i?this.renderCurrentScaleIndicator():null,a.render(),f.tsx("div",{class:I.scaleMenuContainer,key:"scale-menu-toggles"},this.renderScaleMenuToggle("min",c),this.renderScaleMenuToggle("max",r)))},n.renderMinScaleMenu=function(){const{_effectiveMaxScale:e,minScaleLimit:a,view:t,viewModel:{scaleRanges:l}}=this,i=t?t.scale:void 0;return this.renderScaleMenu({type:"min",min:a,max:l.findScaleRange(e).minScale,map:i})},n.renderMaxScaleMenu=function(){const{_effectiveMinScale:e,maxScaleLimit:a,view:t,viewModel:{scaleRanges:l}}=this,i=t?t.scale:void 0;return this.renderScaleMenu({type:"max",min:l.findScaleRange(e).maxScale,max:a,map:i})},n.renderScalePreview=function(){const{_activeThumb:e,_slider:a,region:t,viewModel:{scaleRanges:l}}=this,i=0===e?a.values[0]:a.values[1],n=Object.keys(v.RecommendedScales).indexOf(l.findScaleRangeByIndex(i).id),s={backgroundImage:p.getScalePreviewSource(t),backgroundPosition:p.getScalePreviewSpriteBackgroundPosition(n)};return f.tsx("div",{class:I.scalePreview},f.tsx("div",{class:I.scalePreviewThumbnail,styles:s}))},n.renderScaleMenu=function({map:e,min:a,max:t,type:l}){const i=v.fromScaleRange({minScale:a,maxScale:t}),n=this.messages.featuredScaleLabels,s=v.RecommendedScales,c=Object.keys(s).filter((e=>i.contains(s[e]))).map((e=>this.renderScaleMenuItem({scaleLabel:n[e],scaleValue:s[e],valueVisible:"world"!==e,handleNamedScaleSelect:this._handleRecommendedScaleClick}))),{_customMaxScale:r,_customMinScale:o,messages:d}=this,u="max"===l?r:o;return f.tsx("div",{bind:this,class:I.scaleMenu,"data-type":l,id:`${this.id}__scale-menu--${l}`,key:`${l}-scale-menu`,afterCreate:b.storeNode,"data-node-ref":"_scaleMenuNode",onkeydown:this._handleScaleMenuKeyDown},f.tsx("div",{class:I.scaleMenuScroller},f.tsx("ul",{class:I.scaleMenuList,afterCreate:this._afterMenuListCreate},this.renderScaleMenuItem({scaleValue:u,scaleLabel:d.featuredScaleLabels.custom,valueVisible:!1,handleNamedScaleSelect:this._handleScaleSelection,handleCustomScaleSelect:this._handleCustomScaleEntry}),null!=e?this.renderScaleMenuItem({scaleValue:e,scaleLabel:d.featuredScaleLabels.current,valueVisible:!0,handleNamedScaleSelect:this._handleRecommendedScaleClick}):null,c)))},n._handleScaleSelection=function(){"max"===this._activeMenu?this._customMaxScale=this._effectiveMaxScale:this._customMinScale=this._effectiveMinScale},n.renderScaleMenuToggle=function(e,a){const{_activeMenu:t,_interactive:l}=this,i=t===e;return f.tsx("button",{"aria-controls":i?`${this.id}__scale-menu--${e}`:"","aria-pressed":i?"true":"false",class:this.classes(I.scaleMenuToggle,i?I.scaleMenuToggleActive:null),"data-type":e,key:`${e}-scale-menu-toggle`,onclick:this._handleScaleMenuToggleClick,disabled:!l,type:"button"},f.tsx("div",{class:I.scaleMenuToggleText,"aria-label":a,title:a},a),f.tsx("span",{class:this.classes(I.scaleMenuToggleIcon,I.expandIcon),"aria-hidden":"true"}))},n.renderScaleMenuItem=function(e){const{scaleValue:a,scaleLabel:t,valueVisible:l,handleNamedScaleSelect:i,handleCustomScaleSelect:n=null}=e,{id:s}=this,c=`${s}__custom-scale-input`;return f.tsx("li",{bind:this,class:I.scaleMenuListItem,"data-scale":a,key:t,onclick:i,onkeydown:i,tabIndex:-1},f.tsx("label",{class:I.scaleItemLabel,for:c},t),a>-1?n?f.tsx("input",{afterCreate:this._focusAndSelectInputOnCreate,class:this.classes(I.scaleItemValue,I.scaleItemValueEditable),"data-render-props":e,id:c,key:"value",value:R(a),onkeydown:this._handleCustomScaleInputKeyDown,onblur:this._handleCustomScaleInputBlur}):l?f.tsx("div",{class:I.scaleItemValue,key:"value"},R(a)):null:null)},n._focusAndSelectInputOnCreate=function(e){e.focus(),e.select()},n.renderCurrentScaleIndicator=function(){const{_slider:e,messages:a,view:t,viewModel:{scaleRanges:l}}=this,i=l.clampScale(t.scale),n=this.viewModel.mapScaleToSlider(i),s=n/e.max,c=a.scaleRangeLabels[l.findScaleRangeByIndex(n).id],r=x.substitute(a.currentScaleTooltip,{scaleLabel:c});return f.tsx("div",{class:I.scaleIndicatorContainer,key:"scale-indicator"},f.tsx("div",{"aria-label":r,class:I.scaleIndicator,styles:{left:(b.isRTL(this.container)?-1:1)*s*100+"%"},title:r},this.renderCurrentScaleIndicatorIcon()))},n.renderCurrentScaleIndicatorIcon=function(){return f.tsx("svg",{class:I.scaleIndicatorIcon,height:"8",width:"8",viewBox:"0 0 8 8",version:"1.1",xmlns:"http://www.w3.org/2000/svg"},f.tsx("polygon",{points:"4 0 8 8 0 8"}))},n._handleRecommendedScaleClick=function(e){const a=e.currentTarget,t=Number(a["data-scale"]);this._setScaleFromMenuSelection(t)},n._setScaleFromMenuSelection=function(e){"max"===this._activeMenu?this.maxScale=Math.min(e,this._effectiveMinScale-1):this.minScale=Math.max(e,this._effectiveMaxScale+1),this._setActiveMenu(null),this._activeMenuToggleNode.focus()},n._setActiveMenu=function(e){this._activeMenu=e,this._maxScaleMenuPopover.open="max"===e,this._minScaleMenuPopover.open="min"===e,this._focusedMenuItemIndex=e?0:-1},e._createClass(t,[{key:"_effectiveMaxScale",get:function(){return 0===this.maxScale?this.maxScaleLimit:this.maxScale}},{key:"_effectiveMinScale",get:function(){return 0===this.minScale?this.minScaleLimit:this.minScale}},{key:"_interactive",get:function(){return"disabled"!==this.get("viewModel.state")&&!this.disabled}}]),t}(n.HandleOwnerMixin(_));a.__decorate([c.property()],P.prototype,"_slider",void 0),a.__decorate([c.property()],P.prototype,"_effectiveMaxScale",null),a.__decorate([c.property()],P.prototype,"_effectiveMinScale",null),a.__decorate([c.property({readOnly:!0})],P.prototype,"_interactive",null),a.__decorate([c.property()],P.prototype,"disabled",void 0),a.__decorate([c.property({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],P.prototype,"label",void 0),a.__decorate([c.property({aliasOf:"viewModel.layer"})],P.prototype,"layer",void 0),a.__decorate([c.property({aliasOf:"viewModel.maxScale"})],P.prototype,"maxScale",void 0),a.__decorate([c.property({aliasOf:"viewModel.maxScaleLimit"})],P.prototype,"maxScaleLimit",void 0),a.__decorate([c.property(),M.messageBundle("esri/widgets/ScaleRangeSlider/t9n/ScaleRangeSlider")],P.prototype,"messages",void 0),a.__decorate([c.property({aliasOf:"viewModel.minScale"})],P.prototype,"minScale",void 0),a.__decorate([c.property({aliasOf:"viewModel.minScaleLimit"})],P.prototype,"minScaleLimit",void 0),a.__decorate([c.property()],P.prototype,"region",void 0),a.__decorate([c.property({aliasOf:"viewModel.view"})],P.prototype,"view",void 0),a.__decorate([c.property()],P.prototype,"viewModel",void 0),a.__decorate([c.property()],P.prototype,"visibleElements",void 0),a.__decorate([d.cast("visibleElements")],P.prototype,"castVisibleElements",null),a.__decorate([g.accessibleHandler()],P.prototype,"_handleScaleSelection",null),a.__decorate([g.accessibleHandler()],P.prototype,"_handleRecommendedScaleClick",null),P=a.__decorate([u.subclass("esri.widgets.ScaleRangeSlider")],P);return P}));
