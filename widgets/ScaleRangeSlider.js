/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../intl","../core/domUtils","../core/events","../core/HandleOwner","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/arrayUtils","../core/accessorSupport/decorators/cast","../core/accessorSupport/decorators/subclass","./Slider","./Widget","./ScaleRangeSlider/scalePreviewUtils","./ScaleRangeSlider/ScaleRanges","./ScaleRangeSlider/ScaleRangeSliderViewModel","./support/Popover","./support/decorators/accessibleHandler","./support/decorators/messageBundle","./support/jsxFactory","./support/widgetUtils","../intl/substitute","../intl/number"],(function(e,t,l,a,n,i,s,c,r,o,u,d,m,_,p,v,h,S,M,g,f,y,b){"use strict";const w={base:"esri-scale-range-slider",scaleIndicator:"esri-scale-range-slider__scale-indicator",scaleIndicatorIcon:"esri-scale-range-slider__scale-indicator-icon",scaleIndicatorContainer:"esri-scale-range-slider__scale-indicator-container",scaleMenuContainer:"esri-scale-range-slider__scale-menu-container",scaleMenuToggle:"esri-scale-range-slider__scale-menu-toggle",scaleMenuToggleText:"esri-scale-range-slider__scale-menu-toggle-text",scaleMenuToggleIcon:"esri-scale-range-slider__scale-menu-toggle-icon",scaleMenuToggleActive:"esri-scale-range-slider__scale-menu-toggle--active",scaleMenu:"esri-scale-range-slider__scale-menu",scaleMenuList:"esri-scale-range-slider__scale-menu-list",scaleMenuListItem:"esri-scale-range-slider__scale-menu-item",scaleMenuListItemActive:"esri-scale-range-slider__scale-menu-item--active",scaleMenuScroller:"esri-scale-range-slider__scale-menu-scroller",scaleItemLabel:"esri-scale-range-slider__scale-item-label",scaleItemValue:"esri-scale-range-slider__scale-item-value",scaleItemValueEditable:"esri-scale-range-slider__scale-item-value--editable",scalePreview:"esri-scale-range-slider__scale-preview",scalePreviewThumbnail:"esri-scale-range-slider__scale-preview-thumbnail",slider:"esri-slider",expandIcon:"esri-icon-down",heading:"esri-widget__heading",hidden:"esri-hidden",input:"esri-input",button:"esri-button",disabled:"esri-disabled",widget:"esri-widget"},x={preview:!0,scaleMenus:{maxScaleMenu:!0,minScaleMenu:!0}},I={maximumFractionDigits:0},T=e=>`1:${b.formatNumber(e,I)}`,k=e=>{const t=/[^\d.\s]/g,l=e.replace(/.*\(/,"").replace(/\).*$/,"").replace(/.*:/,"").replace(t,"");return parseFloat(l)};let C=function(t){function l(l,i){var s;return(s=t.call(this,l,i)||this)._activeMenu=null,s._activeMenuNode=null,s._activeMenuToggleNode=null,s._activeThumb=null,s._customMaxScale=-1,s._customMinScale=-1,s._focusedMenuItemIndex=-1,s._maxScaleMenuPopover=new h({owner:e._assertThisInitialized(s),placement:"bottom-end",anchorElement:()=>s._activeMenuToggleNode,renderContentFunction:()=>s._maxScaleMenuEnabled?s.renderMaxScaleMenu():null}),s._minScaleMenuPopover=new h({owner:e._assertThisInitialized(s),placement:"bottom-start",anchorElement:()=>s._activeMenuToggleNode,renderContentFunction:()=>s._minScaleMenuEnabled?s.renderMinScaleMenu():null}),s._previewAutoCloseTimeoutId=null,s._previewPopover=new h({owner:e._assertThisInitialized(s),placement:"top",anchorElement:()=>0===s._activeThumb?s._minThumbNode:s._maxThumbNode,offset:[0,16],renderContentFunction:s.renderScalePreview}),s._scaleMenuNode=null,s._slider=new d({thumbCreatedFunction:(t,l,a)=>{0===t&&(s._minThumbNode=a),1===t&&(s._maxThumbNode=a),s.addHandles([n.on(a,"mouseenter",(()=>{const{visibleElements:{preview:l}}=e._assertThisInitialized(s);s._activeThumb=t,s._previewPopover.open=l,s.scheduleRender()})),n.on(a,"mouseleave",(()=>{s._previewAutoCloseTimeoutId||(s._activeThumb=null,s._previewPopover.open=!1,s.scheduleRender())}))])}}),s.disabled=!1,s.messages=null,s.region="US",s.viewModel=new v,s.visibleElements=x,s._handleScaleMenuToggleClick=e=>{const t=e.currentTarget,l=t.getAttribute("data-type"),i="menu-closing-click-handle";if(s.handles.remove(i),l===s._activeMenu)return s._setActiveMenu(null),void(s._activeMenuToggleNode=null);s._setActiveMenu(l),s._activeMenuToggleNode=t,s.handles.add(n.on(document,"mousedown",(e=>{const t=e.target,l=a.closest(t,`.${w.scaleMenuToggle}`),n=l&&l.getAttribute("data-type");if(l&&n===s._activeMenu)return;!n&&s._scaleMenuNode&&!s._scaleMenuNode.contains(t)&&(s._setActiveMenu(null),s.handles.remove(i),s.scheduleRender())})),i)},s._afterMenuListCreate=e=>{s._activeMenuNode=e,e.children[0].focus({preventScroll:!0})},s._handleCustomScaleEntry=e=>{s._setScaleFromMenuSelection(e),s._customMaxScale=-1,s._customMinScale=-1},s._handleCustomScaleInputBlur=()=>{"max"===s._activeMenu?s._customMaxScale=-1:s._customMinScale=-1},s._handleCustomScaleInputKeyDown=t=>{const l=t.currentTarget,{handleCustomScaleSelect:a}=l["data-render-props"],{key:n,ctrlKey:i,metaKey:c}=t,{viewModel:{scaleRanges:r}}=e._assertThisInitialized(s);if("Enter"===n){const e=k(l.value);return a(isNaN(e)?-1:r.clampScale(e)),t.preventDefault(),void t.stopPropagation()}if(n.length>1||i||c)return;/[:,.\d]/.test(n)||(t.preventDefault(),t.stopPropagation())},s._handleScaleMenuKeyDown=e=>{const t=n.eventKey(e);if("Escape"===t||"Tab"===t)return s._setActiveMenu(null),void s._activeMenuToggleNode.focus();if("ArrowUp"!==t&&"ArrowDown"!==t)return;const l=s._activeMenuNode.children,a=s._focusedMenuItemIndex,i="ArrowUp"===t?(0===a?l.length:a)-1:(a+1)%l.length;e.preventDefault(),e.stopPropagation(),l[i].focus(),s._focusedMenuItemIndex=i},s}e._inheritsLoose(l,t);var i=l.prototype;return i.initialize=function(){this.addHandles([s.watch((()=>this.viewModel),(e=>this._slider.viewModel=e?e.sliderViewModel:null),s.initial),s.watch((()=>this._interactive),(e=>{this._slider.disabled=!e,e||this._setActiveMenu(null)}),s.initial),this._slider.on("thumb-drag",(({index:e})=>{const{visibleElements:{preview:t}}=this;this._activeThumb=e,this._previewPopover.open=t,clearTimeout(this._previewAutoCloseTimeoutId);const l=250;this._previewAutoCloseTimeoutId=setTimeout((()=>{this._previewAutoCloseTimeoutId=null,this._activeThumb=null,this._previewPopover.open=!1,this.scheduleRender()}),l)})),s.when((()=>!0===this.view?.stationary),(()=>this.scheduleRender()))])},i.destroy=function(){this._previewPopover.destroy(),this._previewPopover=null,this._maxScaleMenuPopover.destroy(),this._maxScaleMenuPopover=null,this._minScaleMenuPopover.destroy(),this._minScaleMenuPopover=null,this._slider.destroy(),this._slider=null},i.castVisibleElements=function(e){return{...x,...e,scaleMenus:"boolean"==typeof e?.scaleMenus?e.scaleMenus:{...x.scaleMenus,...e?.scaleMenus}}},i.render=function(){const{_interactive:e,_slider:t,label:l,messages:a,view:n,viewModel:{scaleRanges:i,state:s}}=this,c=a.scaleRangeLabels[i.findScaleRangeByIndex(t.values[0]).id],r=a.scaleRangeLabels[i.findScaleRangeByIndex(t.values[1]).id];return t.layout=f.isRTL(this.container)?"horizontal-reversed":"horizontal",g.tsx("div",{"aria-label":l,class:this.classes(w.base,w.widget,e?null:w.disabled)},"ready"===s&&n?this.renderCurrentScaleIndicator():null,t.render(),g.tsx("div",{class:w.scaleMenuContainer,key:"scale-menu-toggles"},this._minScaleMenuEnabled?this.renderScaleMenuToggle("min",c):null,this._maxScaleMenuEnabled?this.renderScaleMenuToggle("max",r):null))},i.renderMinScaleMenu=function(){const{effectiveMaxScale:e,effectiveMinScaleLimit:t,view:l,viewModel:{scaleRanges:a}}=this,n=l?l.scale:void 0;return this.renderScaleMenu({type:"min",min:t,max:a.findScaleRange(e).minScale,map:n})},i.renderMaxScaleMenu=function(){const{effectiveMinScale:e,effectiveMaxScaleLimit:t,view:l,viewModel:{scaleRanges:a}}=this,n=l?l.scale:void 0;return this.renderScaleMenu({type:"max",min:a.findScaleRange(e).maxScale,max:t,map:n})},i.renderScalePreview=function(){const{_activeThumb:e,_slider:t,region:l,viewModel:{scaleRanges:a}}=this,n=0===e?t.values[0]:t.values[1],i=Object.keys(p.RecommendedScales).indexOf(a.findScaleRangeByIndex(n).id),s={backgroundImage:_.getScalePreviewSource(l),backgroundPosition:_.getScalePreviewSpriteBackgroundPosition(i)};return g.tsx("div",{class:w.scalePreview},g.tsx("div",{class:w.scalePreviewThumbnail,styles:s}))},i.renderScaleMenu=function({map:e,min:t,max:l,type:a}){const n=p.fromScaleRange({minScale:t,maxScale:l}),i=this.messages.featuredScaleLabels,s=p.RecommendedScales,c=Object.keys(s).filter((e=>n.contains(s[e]))).map((e=>this.renderScaleMenuItem({scaleLabel:i[e],scaleValue:s[e],valueVisible:"world"!==e,handleNamedScaleSelect:this._handleRecommendedScaleClick}))),{_customMaxScale:r,_customMinScale:o,messages:u}=this,d="max"===a?r:o;return g.tsx("div",{bind:this,class:w.scaleMenu,"data-type":a,id:`${this.id}__scale-menu--${a}`,key:`${a}-scale-menu`,afterCreate:f.storeNode,"data-node-ref":"_scaleMenuNode",onkeydown:this._handleScaleMenuKeyDown},g.tsx("div",{class:w.scaleMenuScroller},g.tsx("ul",{class:w.scaleMenuList,afterCreate:this._afterMenuListCreate},this.renderScaleMenuItem({scaleValue:d,scaleLabel:u.featuredScaleLabels.custom,valueVisible:!1,handleNamedScaleSelect:this._handleScaleSelection,handleCustomScaleSelect:this._handleCustomScaleEntry}),null!=e?this.renderScaleMenuItem({scaleValue:e,scaleLabel:u.featuredScaleLabels.current,valueVisible:!0,handleNamedScaleSelect:this._handleRecommendedScaleClick}):null,c)))},i._handleScaleSelection=function(){"max"===this._activeMenu?this._customMaxScale=this.effectiveMaxScale:this._customMinScale=this.effectiveMinScale},i.renderScaleMenuToggle=function(e,t){const{_activeMenu:l,_interactive:a}=this,n=l===e;return g.tsx("button",{"aria-controls":n?`${this.id}__scale-menu--${e}`:"","aria-pressed":n?"true":"false",class:this.classes(w.scaleMenuToggle,n?w.scaleMenuToggleActive:null),"data-type":e,key:`${e}-scale-menu-toggle`,onclick:this._handleScaleMenuToggleClick,disabled:!a,type:"button"},g.tsx("div",{class:w.scaleMenuToggleText,"aria-label":t,title:t},t),g.tsx("span",{class:this.classes(w.scaleMenuToggleIcon,w.expandIcon),"aria-hidden":"true"}))},i.renderScaleMenuItem=function(e){const{scaleValue:t,scaleLabel:l,valueVisible:a,handleNamedScaleSelect:n,handleCustomScaleSelect:i=null}=e,{id:s}=this,c=`${s}__custom-scale-input`;return g.tsx("li",{bind:this,class:w.scaleMenuListItem,"data-scale":t,key:l,onclick:n,onkeydown:n,tabIndex:-1},g.tsx("label",{class:w.scaleItemLabel,for:c},l),t>-1?i?g.tsx("input",{afterCreate:this._focusAndSelectInputOnCreate,class:this.classes(w.scaleItemValue,w.scaleItemValueEditable),"data-render-props":e,id:c,key:"value",value:T(t),onkeydown:this._handleCustomScaleInputKeyDown,onblur:this._handleCustomScaleInputBlur}):a?g.tsx("div",{class:w.scaleItemValue,key:"value"},T(t)):null:null)},i._focusAndSelectInputOnCreate=function(e){e.focus(),e.select()},i.renderCurrentScaleIndicator=function(){const{_slider:e,messages:t,view:l,viewModel:{scaleRanges:a}}=this,n=a.clampScale(l.scale),i=this.viewModel.mapScaleToSlider(n),s=i/e.max,c=t.scaleRangeLabels[a.findScaleRangeByIndex(i).id],r=y.substitute(t.currentScaleTooltip,{scaleLabel:c});return g.tsx("div",{class:w.scaleIndicatorContainer,key:"scale-indicator"},g.tsx("div",{"aria-label":r,class:w.scaleIndicator,styles:{left:(f.isRTL(this.container)?-1:1)*s*100+"%"},title:r},this.renderCurrentScaleIndicatorIcon()))},i.renderCurrentScaleIndicatorIcon=function(){return g.tsx("svg",{class:w.scaleIndicatorIcon,height:"8",width:"8",viewBox:"0 0 8 8",version:"1.1",xmlns:"http://www.w3.org/2000/svg"},g.tsx("polygon",{points:"4 0 8 8 0 8"}))},i._handleRecommendedScaleClick=function(e){const t=e.currentTarget,l=Number(t["data-scale"]);this._setScaleFromMenuSelection(l)},i._setScaleFromMenuSelection=function(e){"max"===this._activeMenu?this.maxScale=Math.min(e,this.effectiveMinScale-1):this.minScale=Math.max(e,this.effectiveMaxScale+1),this._setActiveMenu(null),this._activeMenuToggleNode.focus()},i._setActiveMenu=function(e){this._activeMenu=e,this._maxScaleMenuPopover.open="max"===e,this._minScaleMenuPopover.open="min"===e,this._focusedMenuItemIndex=e?0:-1},e._createClass(l,[{key:"_maxScaleMenuEnabled",get:function(){const{scaleMenus:e}=this.visibleElements;return!0===e||"boolean"!=typeof e&&e.maxScaleMenu}},{key:"_minScaleMenuEnabled",get:function(){const{scaleMenus:e}=this.visibleElements;return!0===e||"boolean"!=typeof e&&e.minScaleMenu}},{key:"_interactive",get:function(){return"disabled"!==this.get("viewModel.state")&&!this.disabled}},{key:"effectiveMaxScale",get:function(){return this.viewModel.effectiveMaxScale}},{key:"effectiveMinScale",get:function(){return this.viewModel.effectiveMinScale}},{key:"effectiveMaxScaleLimit",get:function(){return this.viewModel.effectiveMaxScaleLimit}},{key:"effectiveMinScaleLimit",get:function(){return this.viewModel.effectiveMinScaleLimit}},{key:"label",get:function(){return this.messages?.widgetLabel??""},set:function(e){this._overrideIfSome("label",e)}},{key:"layer",get:function(){return this.viewModel.layer},set:function(e){this.viewModel.layer=e}},{key:"maxScale",get:function(){return this.viewModel.maxScale},set:function(e){this.viewModel.maxScale=e}},{key:"maxScaleLimit",get:function(){return this.viewModel.maxScaleLimit},set:function(e){this.viewModel.maxScaleLimit=e}},{key:"minScale",get:function(){return this.viewModel.minScale},set:function(e){this.viewModel.minScale=e}},{key:"minScaleLimit",get:function(){return this.viewModel.minScaleLimit},set:function(e){this.viewModel.minScaleLimit=e}},{key:"view",get:function(){return this.viewModel.view},set:function(e){this.viewModel.view=e}}]),l}(i.HandleOwnerMixin(m));t.__decorate([c.property()],C.prototype,"_maxScaleMenuEnabled",null),t.__decorate([c.property()],C.prototype,"_minScaleMenuEnabled",null),t.__decorate([c.property()],C.prototype,"_slider",void 0),t.__decorate([c.property({readOnly:!0})],C.prototype,"_interactive",null),t.__decorate([c.property()],C.prototype,"disabled",void 0),t.__decorate([c.property()],C.prototype,"effectiveMaxScale",null),t.__decorate([c.property()],C.prototype,"effectiveMinScale",null),t.__decorate([c.property()],C.prototype,"effectiveMaxScaleLimit",null),t.__decorate([c.property()],C.prototype,"effectiveMinScaleLimit",null),t.__decorate([c.property()],C.prototype,"label",null),t.__decorate([c.property()],C.prototype,"layer",null),t.__decorate([c.property()],C.prototype,"maxScale",null),t.__decorate([c.property()],C.prototype,"maxScaleLimit",null),t.__decorate([c.property(),M.messageBundle("esri/widgets/ScaleRangeSlider/t9n/ScaleRangeSlider")],C.prototype,"messages",void 0),t.__decorate([c.property()],C.prototype,"minScale",null),t.__decorate([c.property()],C.prototype,"minScaleLimit",null),t.__decorate([c.property()],C.prototype,"region",void 0),t.__decorate([c.property()],C.prototype,"view",null),t.__decorate([c.property()],C.prototype,"viewModel",void 0),t.__decorate([c.property()],C.prototype,"visibleElements",void 0),t.__decorate([o.cast("visibleElements")],C.prototype,"castVisibleElements",null),t.__decorate([S.accessibleHandler()],C.prototype,"_handleScaleSelection",null),t.__decorate([S.accessibleHandler()],C.prototype,"_handleRecommendedScaleClick",null),C=t.__decorate([u.subclass("esri.widgets.ScaleRangeSlider")],C);return C}));
