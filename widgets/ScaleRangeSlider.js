/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/has","../core/Logger","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/cast","../core/accessorSupport/decorators/subclass","../core/urlUtils","../core/uuid","../portal/support/resourceExtension","../core/events","../intl/number","../intl/substitute","../intl","../core/watchUtils","../core/HandleOwner","../core/domUtils","./support/widgetUtils","./support/decorators/accessibleHandler","./support/decorators/messageBundle","./support/decorators/renderable","../chunks/index","./Widget","./support/Popover","./Slider","./ScaleRangeSlider/scalePreviewUtils","./ScaleRangeSlider/ScaleRanges","./ScaleRangeSlider/ScaleRangeSliderViewModel"],(function(e,t,a,l,i,n,s,r,c,o,d,u,m,_,p,v,h,S,g,M,w,f,y,b,x,T,I,R){"use strict";const C="esri-scale-range-slider",k="esri-scale-range-slider__scale-indicator",L="esri-scale-range-slider__scale-indicator-icon",P="esri-scale-range-slider__scale-indicator-container",N="esri-scale-range-slider__scale-menu-container",j="esri-scale-range-slider__scale-menu-toggle",A="esri-scale-range-slider__scale-menu-toggle-icon",O="esri-scale-range-slider__scale-menu-toggle--active",E="esri-scale-range-slider__scale-menu",V="esri-scale-range-slider__scale-menu-list",B="esri-scale-range-slider__scale-menu-item",$="esri-scale-range-slider__scale-menu-scroller",D="esri-scale-range-slider__scale-item-label",F="esri-scale-range-slider__scale-item-value",z="esri-scale-range-slider__scale-item-value--editable",U="esri-scale-range-slider__scale-preview",K="esri-scale-range-slider__scale-preview-thumbnail",H="esri-icon-down",W="esri-disabled",q="esri-widget",G={preview:!0},J={maximumFractionDigits:0},Q=e=>`1:${u.formatNumber(e,J)}`;let X=function(t){function a(a,l){var i;return(i=t.call(this,a,l)||this)._activeMenu=null,i._activeMenuNode=null,i._activeMenuToggleNode=null,i._activeThumb=null,i._customMaxScale=-1,i._customMinScale=-1,i._focusedMenuItemIndex=-1,i._previewAutoCloseTimeoutId=null,i._previewPopover=new b({owner:e._assertThisInitialized(i),placement:"top",anchorElement:()=>0===i._activeThumb?i._minThumbNode:i._maxThumbNode,offset:[0,16],renderContentFunction:i.renderScalePreview}),i._maxScaleMenuPopover=new b({owner:e._assertThisInitialized(i),placement:"bottom-end",anchorElement:()=>i._activeMenuToggleNode,renderContentFunction:i.renderMaxScaleMenu}),i._minScaleMenuPopover=new b({owner:e._assertThisInitialized(i),placement:"bottom-start",anchorElement:()=>i._activeMenuToggleNode,renderContentFunction:i.renderMinScaleMenu}),i._scaleMenuNode=null,i._slider=new x({thumbCreatedFunction:(t,a,l)=>{0===t&&(i._minThumbNode=l),1===t&&(i._maxThumbNode=l),i.own([d.on(l,"mouseenter",(()=>{const{visibleElements:{preview:a}}=e._assertThisInitialized(i);i._activeThumb=t,i._previewPopover.open=a,i.scheduleRender()})),d.on(l,"mouseleave",(()=>{i._previewAutoCloseTimeoutId||(i._activeThumb=null,i._previewPopover.open=!1,i.scheduleRender())}))])}}),i.disabled=!1,i.label=void 0,i.layer=null,i.maxScale=null,i.maxScaleLimit=null,i.messages=null,i.minScale=null,i.minScaleLimit=null,i.region="US",i.view=null,i.viewModel=new R,i.visibleElements=G,i._handleScaleMenuToggleClick=e=>{const t=e.currentTarget,a=t.getAttribute("data-type"),l="menu-closing-click-handle";if(i.handles.remove(l),a===i._activeMenu)return i._setActiveMenu(null),void(i._activeMenuToggleNode=null);i._setActiveMenu(a),i._activeMenuToggleNode=t,i.handles.add(d.on(document,"mousedown",(e=>{const t=e.target,a=h.closest(t,`.${j}`),n=a&&a.getAttribute("data-type");if(a&&n===i._activeMenu)return;!n&&i._scaleMenuNode&&!i._scaleMenuNode.contains(t)&&(i._setActiveMenu(null),i.handles.remove(l),i.scheduleRender())})),l)},i._afterMenuListCreate=e=>{i._activeMenuNode=e,e.children[0].focus({preventScroll:!0})},i._handleCustomScaleEntry=e=>{i._setScaleFromMenuSelection(e),i._customMaxScale=-1,i._customMinScale=-1},i._handleCustomScaleInputBlur=()=>{"max"===i._activeMenu?i._customMaxScale=-1:i._customMinScale=-1},i.handleCustomScaleInputKeyDown=t=>{const a=t.currentTarget,{handleCustomScaleSelect:l}=a["data-render-props"],{key:n,ctrlKey:s,metaKey:r}=t,{viewModel:{scaleRanges:c}}=e._assertThisInitialized(i);if("Enter"===n){const e=(e=>{const t=e.replace(/.*\(/,"").replace(/\).*$/,"").replace(/.*:/,"").replace(/[^\d.\s]/g,"");return parseFloat(t)})(a.value);return l(isNaN(e)?-1:c.clampScale(e)),t.preventDefault(),void t.stopPropagation()}if(n.length>1||s||r)return;/[:,.\d]/.test(n)||(t.preventDefault(),t.stopPropagation())},i._handleScaleMenuKeyDown=e=>{const t=d.eventKey(e);if("Escape"===t||"Tab"===t)return i._setActiveMenu(null),void i._activeMenuToggleNode.focus();if("ArrowUp"!==t&&"ArrowDown"!==t)return;const a=i._activeMenuNode.children,l=i._focusedMenuItemIndex,n="ArrowUp"===t?(0===l?a.length:l)-1:(l+1)%a.length;e.preventDefault(),e.stopPropagation(),a[n].focus(),i._focusedMenuItemIndex=n},i}e._inheritsLoose(a,t);var l=a.prototype;return l.initialize=function(){this.own([p.init(this,"viewModel",(e=>this._slider.viewModel=e?e.sliderViewModel:null)),p.init(this,"_interactive",(e=>{this._slider.disabled=!e,e||this._setActiveMenu(null)})),this._slider.on("thumb-drag",(({index:e})=>{const{visibleElements:{preview:t}}=this;this._activeThumb=e,this._previewPopover.open=t,clearTimeout(this._previewAutoCloseTimeoutId);this._previewAutoCloseTimeoutId=setTimeout((()=>{this._previewAutoCloseTimeoutId=null,this._activeThumb=null,this._previewPopover.open=!1,this.scheduleRender()}),250)})),p.whenTrue(this,"view.stationary",(()=>this.scheduleRender()))])},l.destroy=function(){this._previewPopover.destroy(),this._previewPopover=null,this._maxScaleMenuPopover.destroy(),this._maxScaleMenuPopover=null,this._minScaleMenuPopover.destroy(),this._minScaleMenuPopover=null,this._slider.destroy(),this._slider=null},l.castVisibleElements=function(e){return{...G,...e}},l.render=function(){const{_interactive:e,_slider:t,label:a,messages:l,view:i,viewModel:{scaleRanges:n,state:s}}=this,r=l.scaleRangeLabels[n.findScaleRangeByIndex(t.values[0]).id],c=l.scaleRangeLabels[n.findScaleRangeByIndex(t.values[1]).id];return t.layout=S.isRTL()?"horizontal-reversed":"horizontal",f.jsx("div",{"aria-label":a,class:this.classes(C,q,e?null:W)},"ready"===s&&i?this.renderCurrentScaleIndicator():null,t.render(),f.jsx("div",{class:N,key:"scale-menu-toggles"},this.renderScaleMenuToggle("min",r),this.renderScaleMenuToggle("max",c)))},l.renderMinScaleMenu=function(){const{_effectiveMaxScale:e,minScaleLimit:t,view:a,viewModel:{scaleRanges:l}}=this,i=a?a.scale:void 0;return this.renderScaleMenu({type:"min",min:t,max:l.findScaleRange(e).minScale,map:i})},l.renderMaxScaleMenu=function(){const{_effectiveMinScale:e,maxScaleLimit:t,view:a,viewModel:{scaleRanges:l}}=this,i=a?a.scale:void 0;return this.renderScaleMenu({type:"max",min:l.findScaleRange(e).maxScale,max:t,map:i})},l.renderScalePreview=function(){const{_activeThumb:e,_slider:t,region:a,viewModel:{scaleRanges:l}}=this,i=0===e?t.values[0]:t.values[1],n=Object.keys(I.RecommendedScales).indexOf(l.findScaleRangeByIndex(i).id),s={backgroundImage:T.getScalePreviewSource(a),backgroundPosition:T.getScalePreviewSpriteBackgroundPosition(n)};return f.jsx("div",{class:U},f.jsx("div",{class:K,styles:s}))},l.renderScaleMenu=function({map:e,min:t,max:a,type:l}){const i=I.fromScaleRange({minScale:t,maxScale:a}),n=this.messages.featuredScaleLabels,s=I.RecommendedScales,r=Object.keys(s).filter((e=>i.contains(s[e]))).map((e=>this.renderScaleMenuItem({scaleLabel:n[e],scaleValue:s[e],valueVisible:"world"!==e,handleNamedScaleSelect:this._handleRecommendedScaleClick}))),{_customMaxScale:c,_customMinScale:o,messages:d}=this,u="max"===l?c:o;return f.jsx("div",{bind:this,class:E,"data-type":l,id:`${this.id}__scale-menu--${l}`,key:`${l}-scale-menu`,afterCreate:S.storeNode,"data-node-ref":"_scaleMenuNode",onkeydown:this._handleScaleMenuKeyDown},f.jsx("div",{class:$},f.jsx("ul",{class:V,afterCreate:this._afterMenuListCreate},this.renderScaleMenuItem({scaleValue:u,scaleLabel:d.featuredScaleLabels.custom,valueVisible:!1,handleNamedScaleSelect:this._handleScaleSelection,handleCustomScaleSelect:this._handleCustomScaleEntry}),null!=e?this.renderScaleMenuItem({scaleValue:e,scaleLabel:d.featuredScaleLabels.current,valueVisible:!0,handleNamedScaleSelect:this._handleRecommendedScaleClick}):null,r)))},l._handleScaleSelection=function(){"max"===this._activeMenu?this._customMaxScale=this._effectiveMaxScale:this._customMinScale=this._effectiveMinScale},l.renderScaleMenuToggle=function(e,t){const{_activeMenu:a,_interactive:l}=this,i=a===e;return f.jsx("button",{"aria-controls":i?`${this.id}__scale-menu--${e}`:"","aria-pressed":i?"true":"false",class:this.classes(j,i?O:null),"data-type":e,key:`${e}-scale-menu-toggle`,onclick:this._handleScaleMenuToggleClick,disabled:!l,type:"button"},t,f.jsx("span",{class:this.classes(A,H),"aria-hidden":"true"}))},l.renderScaleMenuItem=function(e){const{scaleValue:t,scaleLabel:a,valueVisible:l,handleNamedScaleSelect:i,handleCustomScaleSelect:n=null}=e,{id:s}=this,r=`${s}__custom-scale-input`;return f.jsx("li",{bind:this,class:B,"data-scale":t,key:a,onclick:i,onkeydown:i,tabIndex:-1},f.jsx("label",{class:D,for:r},a),t>-1?n?f.jsx("input",{afterCreate:this.focusAndSelectInputOnCreate,class:this.classes(F,z),"data-render-props":e,id:r,key:"value",value:Q(t),onkeydown:this.handleCustomScaleInputKeyDown,onblur:this._handleCustomScaleInputBlur}):l?f.jsx("div",{class:F,key:"value"},Q(t)):null:null)},l.focusAndSelectInputOnCreate=function(e){e.focus(),e.select()},l.renderCurrentScaleIndicator=function(){const{_slider:e,messages:t,view:a,viewModel:{scaleRanges:l}}=this,i=l.clampScale(a.scale),n=this.viewModel.mapScaleToSlider(i),s=n/e.max,r=t.scaleRangeLabels[l.findScaleRangeByIndex(n).id],c=m.substitute(t.currentScaleTooltip,{scaleLabel:r});return f.jsx("div",{class:P,key:"scale-indicator"},f.jsx("div",{"aria-label":c,class:k,styles:{left:(S.isRTL()?-1:1)*s*100+"%"},title:c},this.renderCurrentScaleIndicatorIcon()))},l.renderCurrentScaleIndicatorIcon=function(){return f.jsx("svg",{class:L,height:"8",width:"8",viewBox:"0 0 8 8",version:"1.1",xmlns:"http://www.w3.org/2000/svg"},f.jsx("polygon",{points:"4 0 8 8 0 8"}))},l._handleRecommendedScaleClick=function(e){const t=e.currentTarget,a=Number(t["data-scale"]);this._setScaleFromMenuSelection(a)},l._setScaleFromMenuSelection=function(e){"max"===this._activeMenu?this.maxScale=Math.min(e,this._effectiveMinScale-1):this.minScale=Math.max(e,this._effectiveMaxScale+1),this._setActiveMenu(null)},l._setActiveMenu=function(e){this._activeMenu=e,this._maxScaleMenuPopover.open="max"===e,this._minScaleMenuPopover.open="min"===e,this._focusedMenuItemIndex=e?0:-1},e._createClass(a,[{key:"_effectiveMaxScale",get:function(){return 0===this.maxScale?this.maxScaleLimit:this.maxScale}},{key:"_effectiveMinScale",get:function(){return 0===this.minScale?this.minScaleLimit:this.minScale}},{key:"_interactive",get:function(){return"disabled"!==this.get("viewModel.state")&&!this.disabled}}]),a}(v.HandleOwnerMixin(y));return t.__decorate([i.property()],X.prototype,"_slider",void 0),t.__decorate([i.property({dependsOn:["viewModel.maxScaleLimit","viewModel.maxScale"]})],X.prototype,"_effectiveMaxScale",null),t.__decorate([i.property({dependsOn:["viewModel.minScaleLimit","viewModel.minScale"]})],X.prototype,"_effectiveMinScale",null),t.__decorate([i.property({dependsOn:["disabled","viewModel.state"],readOnly:!0})],X.prototype,"_interactive",null),t.__decorate([i.property(),w.renderable()],X.prototype,"disabled",void 0),t.__decorate([i.property({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],X.prototype,"label",void 0),t.__decorate([i.property({aliasOf:"viewModel.layer"})],X.prototype,"layer",void 0),t.__decorate([i.property({aliasOf:"viewModel.maxScale"})],X.prototype,"maxScale",void 0),t.__decorate([i.property({aliasOf:"viewModel.maxScaleLimit"})],X.prototype,"maxScaleLimit",void 0),t.__decorate([i.property(),w.renderable(),M.messageBundle("esri/widgets/ScaleRangeSlider/t9n/ScaleRangeSlider")],X.prototype,"messages",void 0),t.__decorate([i.property({aliasOf:"viewModel.minScale"})],X.prototype,"minScale",void 0),t.__decorate([i.property({aliasOf:"viewModel.minScaleLimit"})],X.prototype,"minScaleLimit",void 0),t.__decorate([i.property(),w.renderable()],X.prototype,"region",void 0),t.__decorate([i.property({aliasOf:"viewModel.view"})],X.prototype,"view",void 0),t.__decorate([i.property(),w.renderable("viewModel.state")],X.prototype,"viewModel",void 0),t.__decorate([i.property(),w.renderable()],X.prototype,"visibleElements",void 0),t.__decorate([n.cast("visibleElements")],X.prototype,"castVisibleElements",null),t.__decorate([g.accessibleHandler()],X.prototype,"_handleScaleSelection",null),t.__decorate([g.accessibleHandler()],X.prototype,"_handleRecommendedScaleClick",null),X=t.__decorate([s.subclass("esri.widgets.ScaleRangeSlider")],X),X}));
