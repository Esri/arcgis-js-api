// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../intl","../core/domUtils","../core/events","../core/HandleOwner","../core/watchUtils","../core/accessorSupport/decorators","./Slider","./Widget","./ScaleRangeSlider/scalePreviewUtils","./ScaleRangeSlider/ScaleRanges","./ScaleRangeSlider/ScaleRangeSliderViewModel","./support/Popover","./support/widget"],(function(e,t,a,l,n,i,r,s,o,c,d,u,p,m,_,v){"use strict";var S="esri-scale-range-slider",h="esri-scale-range-slider__scale-indicator",g="esri-scale-range-slider__scale-indicator-icon",f="esri-scale-range-slider__scale-indicator-container",M="esri-scale-range-slider__scale-menu-container",y="esri-scale-range-slider__scale-menu-toggle",w="esri-scale-range-slider__scale-menu-toggle-icon",b="esri-scale-range-slider__scale-menu-toggle--active",x="esri-scale-range-slider__scale-menu",T="esri-scale-range-slider__scale-menu-list",R="esri-scale-range-slider__scale-menu-item",C="esri-scale-range-slider__scale-menu-scroller",I="esri-scale-range-slider__scale-item-label",P="esri-scale-range-slider__scale-item-value",L="esri-scale-range-slider__scale-item-value--editable",N="esri-scale-range-slider__scale-preview",k="esri-scale-range-slider__scale-preview-thumbnail",O="esri-icon-down",A="esri-disabled",E="esri-widget",V={preview:!0},B={maximumFractionDigits:0},D=function(e){return"1:"+l.formatNumber(e,B)};return function(e){function t(t,a){var l=e.call(this,t,a)||this;return l._activeMenu=null,l._activeMenuNode=null,l._activeMenuToggleNode=null,l._activeThumb=null,l._customMaxScale=-1,l._customMinScale=-1,l._focusedMenuItemIndex=-1,l._previewAutoCloseTimeoutId=null,l._previewPopover=new _({owner:l,placement:"top",anchorElement:function(){return 0===l._activeThumb?l._minThumbNode:l._maxThumbNode},offset:[0,16],renderContentFunction:l.renderScalePreview}),l._maxScaleMenuPopover=new _({owner:l,placement:"bottom-end",anchorElement:function(){return l._activeMenuToggleNode},renderContentFunction:l.renderMaxScaleMenu}),l._minScaleMenuPopover=new _({owner:l,placement:"bottom-start",anchorElement:function(){return l._activeMenuToggleNode},renderContentFunction:l.renderMinScaleMenu}),l._scaleMenuNode=null,l._slider=new c({thumbCreatedFunction:function(e,t,a){0===e&&(l._minThumbNode=a),1===e&&(l._maxThumbNode=a),l.own([i.on(a,"mouseenter",(function(){var t=l.visibleElements.preview;l._activeThumb=e,l._previewPopover.open=t,l.scheduleRender()})),i.on(a,"mouseleave",(function(){l._previewAutoCloseTimeoutId||(l._activeThumb=null,l._previewPopover.open=!1,l.scheduleRender())}))])}}),l.disabled=!1,l.label=void 0,l.layer=null,l.maxScale=null,l.maxScaleLimit=null,l.messages=null,l.minScale=null,l.minScaleLimit=null,l.region="US",l.view=null,l.viewModel=new m,l.visibleElements=V,l._handleScaleMenuToggleClick=function(e){var t=e.currentTarget,a=t.getAttribute("data-type"),r="menu-closing-click-handle";if(l.handles.remove(r),a===l._activeMenu)return l._setActiveMenu(null),void(l._activeMenuToggleNode=null);l._setActiveMenu(a),l._activeMenuToggleNode=t,l.handles.add(i.on(document,"mousedown",(function(e){var t=e.target,a=n.closest(t,"."+y),i=a&&a.getAttribute("data-type");a&&i===l._activeMenu||!i&&l._scaleMenuNode&&!l._scaleMenuNode.contains(t)&&(l._setActiveMenu(null),l.handles.remove(r),l.scheduleRender())})),r)},l._afterMenuListCreate=function(e){l._activeMenuNode=e,e.children[0].focus({preventScroll:!0})},l._handleCustomScaleEntry=function(e){l._setScaleFromMenuSelection(e),l._customMaxScale=-1,l._customMinScale=-1},l._handleCustomScaleInputBlur=function(){"max"===l._activeMenu?l._customMaxScale=-1:l._customMinScale=-1},l.handleCustomScaleInputKeyDown=function(e){var t,a,n=e.currentTarget,i=n["data-render-props"].handleCustomScaleSelect,r=e.key,s=e.ctrlKey,o=e.metaKey,c=l.viewModel.scaleRanges;if("Enter"===r){var d=(t=n.value,a=t.replace(/.*\(/,"").replace(/\).*$/,"").replace(/.*:/,"").replace(/[^\d.\s]/g,""),parseFloat(a));return i(isNaN(d)?-1:c.clampScale(d)),e.preventDefault(),void e.stopPropagation()}if(!(r.length>1||s||o)){/[:,.\d]/.test(r)||(e.preventDefault(),e.stopPropagation())}},l._handleScaleMenuKeyDown=function(e){var t=i.eventKey(e);if("Escape"===t||"Tab"===t)return l._setActiveMenu(null),void l._activeMenuToggleNode.focus();if("ArrowUp"===t||"ArrowDown"===t){var a=l._activeMenuNode.children,n=l._focusedMenuItemIndex,r="ArrowUp"===t?(0===n?a.length:n)-1:(n+1)%a.length;e.preventDefault(),e.stopPropagation(),a[r].focus(),l._focusedMenuItemIndex=r}},l}return a.__extends(t,e),t.prototype.initialize=function(){var e=this;this.own([s.init(this,"viewModel",(function(t){return e._slider.viewModel=t?t.sliderViewModel:null})),s.init(this,"_interactive",(function(t){e._slider.disabled=!t,t||e._setActiveMenu(null)})),this._slider.on("thumb-drag",(function(t){var a=t.index,l=e.visibleElements.preview;e._activeThumb=a,e._previewPopover.open=l,clearTimeout(e._previewAutoCloseTimeoutId);e._previewAutoCloseTimeoutId=setTimeout((function(){e._previewAutoCloseTimeoutId=null,e._activeThumb=null,e._previewPopover.open=!1,e.scheduleRender()}),250)})),s.whenTrue(this,"view.stationary",(function(){return e.scheduleRender()}))])},t.prototype.destroy=function(){this._previewPopover.destroy(),this._previewPopover=null,this._maxScaleMenuPopover.destroy(),this._maxScaleMenuPopover=null,this._minScaleMenuPopover.destroy(),this._minScaleMenuPopover=null,this._slider.destroy(),this._slider=null},Object.defineProperty(t.prototype,"_effectiveMaxScale",{get:function(){return 0===this.maxScale?this.maxScaleLimit:this.maxScale},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"_effectiveMinScale",{get:function(){return 0===this.minScale?this.minScaleLimit:this.minScale},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"_interactive",{get:function(){return"disabled"!==this.get("viewModel.state")&&!this.disabled},enumerable:!1,configurable:!0}),t.prototype.castVisibleElements=function(e){return a.__assign(a.__assign({},V),e)},t.prototype.render=function(){var e=this,t=e._interactive,a=e._slider,l=e.label,n=e.messages,i=e.view,r=e.viewModel,s=r.scaleRanges,o=r.state,c=n.scaleRangeLabels[s.findScaleRangeByIndex(a.values[0]).id],d=n.scaleRangeLabels[s.findScaleRangeByIndex(a.values[1]).id];return a.layout=v.isRTL()?"horizontal-reversed":"horizontal",v.tsx("div",{"aria-label":l,class:this.classes(S,E,t?null:A)},"ready"===o&&i?this.renderCurrentScaleIndicator():null,a.render(),v.tsx("div",{class:M,key:"scale-menu-toggles"},this.renderScaleMenuToggle("min",c),this.renderScaleMenuToggle("max",d)))},t.prototype.renderMinScaleMenu=function(){var e=this._effectiveMaxScale,t=this.minScaleLimit,a=this.view,l=this.viewModel.scaleRanges,n=a?a.scale:void 0;return this.renderScaleMenu({type:"min",min:t,max:l.findScaleRange(e).minScale,map:n})},t.prototype.renderMaxScaleMenu=function(){var e=this._effectiveMinScale,t=this.maxScaleLimit,a=this.view,l=this.viewModel.scaleRanges,n=a?a.scale:void 0;return this.renderScaleMenu({type:"max",min:l.findScaleRange(e).maxScale,max:t,map:n})},t.prototype.renderScalePreview=function(){var e=this._activeThumb,t=this._slider,a=this.region,l=this.viewModel.scaleRanges,n=0===e?t.values[0]:t.values[1],i=Object.keys(p.RecommendedScales).indexOf(l.findScaleRangeByIndex(n).id),r={backgroundImage:u.getScalePreviewSource(a),backgroundPosition:u.getScalePreviewSpriteBackgroundPosition(i)};return v.tsx("div",{class:N},v.tsx("div",{class:k,styles:r}))},t.prototype.renderScaleMenu=function(e){var t=this,a=e.map,l=e.min,n=e.max,i=e.type,r=p.fromScaleRange({minScale:l,maxScale:n}),s=this.messages.featuredScaleLabels,o=p.RecommendedScales,c=Object.keys(o).filter((function(e){return r.contains(o[e])})).map((function(e){return t.renderScaleMenuItem({scaleLabel:s[e],scaleValue:o[e],valueVisible:"world"!==e,handleNamedScaleSelect:t._handleRecommendedScaleClick})})),d=this._customMaxScale,u=this._customMinScale,m=this.messages,_="max"===i?d:u;return v.tsx("div",{bind:this,class:x,"data-type":i,id:this.id+"__scale-menu--"+i,key:i+"-scale-menu",afterCreate:v.storeNode,"data-node-ref":"_scaleMenuNode",onkeydown:this._handleScaleMenuKeyDown},v.tsx("div",{class:C},v.tsx("ul",{class:T,afterCreate:this._afterMenuListCreate},this.renderScaleMenuItem({scaleValue:_,scaleLabel:m.featuredScaleLabels.custom,valueVisible:!1,handleNamedScaleSelect:this._handleScaleSelection,handleCustomScaleSelect:this._handleCustomScaleEntry}),null!=a?this.renderScaleMenuItem({scaleValue:a,scaleLabel:m.featuredScaleLabels.current,valueVisible:!0,handleNamedScaleSelect:this._handleRecommendedScaleClick}):null,c)))},t.prototype._handleScaleSelection=function(){"max"===this._activeMenu?this._customMaxScale=this._effectiveMaxScale:this._customMinScale=this._effectiveMinScale},t.prototype.renderScaleMenuToggle=function(e,t){var a=this._activeMenu,l=this._interactive,n=a===e;return v.tsx("button",{"aria-controls":n?this.id+"__scale-menu--"+e:"","aria-pressed":n?"true":"false",class:this.classes(y,n?b:null),"data-type":e,key:e+"-scale-menu-toggle",onclick:this._handleScaleMenuToggleClick,disabled:!l,type:"button"},t,v.tsx("span",{class:this.classes(w,O),"aria-hidden":"true"}))},t.prototype.renderScaleMenuItem=function(e){var t=e.scaleValue,a=e.scaleLabel,l=e.valueVisible,n=e.handleNamedScaleSelect,i=e.handleCustomScaleSelect,r=void 0===i?null:i,s=this.id+"__custom-scale-input";return v.tsx("li",{bind:this,class:R,"data-scale":t,key:a,onclick:n,onkeydown:n,tabIndex:-1},v.tsx("label",{class:I,for:s},a),t>-1?r?v.tsx("input",{afterCreate:this.focusAndSelectInputOnCreate,class:this.classes(P,L),"data-render-props":e,id:s,key:"value",value:D(t),onkeydown:this.handleCustomScaleInputKeyDown,onblur:this._handleCustomScaleInputBlur}):l?v.tsx("div",{class:P,key:"value"},D(t)):null:null)},t.prototype.focusAndSelectInputOnCreate=function(e){e.focus(),e.select()},t.prototype.renderCurrentScaleIndicator=function(){var e=this._slider,t=this.messages,a=this.view,n=this.viewModel.scaleRanges,i=n.clampScale(a.scale),r=this.viewModel.mapScaleToSlider(i),s=r/e.max,o=t.scaleRangeLabels[n.findScaleRangeByIndex(r).id],c=l.substitute(t.currentScaleTooltip,{scaleLabel:o});return v.tsx("div",{class:f,key:"scale-indicator"},v.tsx("div",{"aria-label":c,class:h,styles:{left:(v.isRTL()?-1:1)*s*100+"%"},title:c},this.renderCurrentScaleIndicatorIcon()))},t.prototype.renderCurrentScaleIndicatorIcon=function(){return v.tsx("svg",{class:g,height:"8",width:"8",viewBox:"0 0 8 8",version:"1.1",xmlns:"http://www.w3.org/2000/svg"},v.tsx("polygon",{points:"4 0 8 8 0 8"}))},t.prototype._handleRecommendedScaleClick=function(e){var t=e.currentTarget,a=Number(t["data-scale"]);this._setScaleFromMenuSelection(a)},t.prototype._setScaleFromMenuSelection=function(e){"max"===this._activeMenu?this.maxScale=Math.min(e,this._effectiveMinScale-1):this.minScale=Math.max(e,this._effectiveMaxScale+1),this._setActiveMenu(null)},t.prototype._setActiveMenu=function(e){this._activeMenu=e,this._maxScaleMenuPopover.open="max"===e,this._minScaleMenuPopover.open="min"===e,this._focusedMenuItemIndex=e?0:-1},a.__decorate([o.property()],t.prototype,"_slider",void 0),a.__decorate([o.property({dependsOn:["viewModel.maxScaleLimit","viewModel.maxScale"]})],t.prototype,"_effectiveMaxScale",null),a.__decorate([o.property({dependsOn:["viewModel.minScaleLimit","viewModel.minScale"]})],t.prototype,"_effectiveMinScale",null),a.__decorate([o.property({dependsOn:["disabled","viewModel.state"],readOnly:!0})],t.prototype,"_interactive",null),a.__decorate([o.property(),v.renderable()],t.prototype,"disabled",void 0),a.__decorate([o.property({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],t.prototype,"label",void 0),a.__decorate([o.property({aliasOf:"viewModel.layer"})],t.prototype,"layer",void 0),a.__decorate([o.property({aliasOf:"viewModel.maxScale"})],t.prototype,"maxScale",void 0),a.__decorate([o.property({aliasOf:"viewModel.maxScaleLimit"})],t.prototype,"maxScaleLimit",void 0),a.__decorate([o.property(),v.renderable(),v.messageBundle("esri/widgets/ScaleRangeSlider/t9n/ScaleRangeSlider")],t.prototype,"messages",void 0),a.__decorate([o.property({aliasOf:"viewModel.minScale"})],t.prototype,"minScale",void 0),a.__decorate([o.property({aliasOf:"viewModel.minScaleLimit"})],t.prototype,"minScaleLimit",void 0),a.__decorate([o.property(),v.renderable()],t.prototype,"region",void 0),a.__decorate([o.property({aliasOf:"viewModel.view"})],t.prototype,"view",void 0),a.__decorate([o.property(),v.renderable("viewModel.state")],t.prototype,"viewModel",void 0),a.__decorate([o.property(),v.renderable()],t.prototype,"visibleElements",void 0),a.__decorate([o.cast("visibleElements")],t.prototype,"castVisibleElements",null),a.__decorate([v.accessibleHandler()],t.prototype,"_handleScaleSelection",null),a.__decorate([v.accessibleHandler()],t.prototype,"_handleRecommendedScaleClick",null),t=a.__decorate([o.subclass("esri.widgets.ScaleRangeSlider")],t)}(r.HandleOwnerMixin(d))}));