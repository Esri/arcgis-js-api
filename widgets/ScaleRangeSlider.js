/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/has","../core/Logger","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/cast","../core/accessorSupport/decorators/subclass","../core/urlUtils","../core/uuid","../portal/support/resourceExtension","../core/events","../intl/number","../intl/substitute","../intl","../core/watchUtils","../core/HandleOwner","../core/domUtils","./support/widgetUtils","./support/decorators/accessibleHandler","./support/decorators/messageBundle","../chunks/index","./Widget","./support/Popover","./Slider","./ScaleRangeSlider/scalePreviewUtils","./ScaleRangeSlider/ScaleRanges","./ScaleRangeSlider/ScaleRangeSliderViewModel"],(function(e,a,l,t,i,n,s,c,r,o,d,u,m,_,p,v,h,S,g,M,w,f,b,y,x,I,T){"use strict";const C={base:"esri-scale-range-slider",scaleIndicator:"esri-scale-range-slider__scale-indicator",scaleIndicatorIcon:"esri-scale-range-slider__scale-indicator-icon",scaleIndicatorContainer:"esri-scale-range-slider__scale-indicator-container",scaleMenuContainer:"esri-scale-range-slider__scale-menu-container",scaleMenuToggle:"esri-scale-range-slider__scale-menu-toggle",scaleMenuToggleIcon:"esri-scale-range-slider__scale-menu-toggle-icon",scaleMenuToggleActive:"esri-scale-range-slider__scale-menu-toggle--active",scaleMenu:"esri-scale-range-slider__scale-menu",scaleMenuList:"esri-scale-range-slider__scale-menu-list",scaleMenuListItem:"esri-scale-range-slider__scale-menu-item",scaleMenuListItemActive:"esri-scale-range-slider__scale-menu-item--active",scaleMenuScroller:"esri-scale-range-slider__scale-menu-scroller",scaleItemLabel:"esri-scale-range-slider__scale-item-label",scaleItemValue:"esri-scale-range-slider__scale-item-value",scaleItemValueEditable:"esri-scale-range-slider__scale-item-value--editable",scalePreview:"esri-scale-range-slider__scale-preview",scalePreviewThumbnail:"esri-scale-range-slider__scale-preview-thumbnail",slider:"esri-slider",expandIcon:"esri-icon-down",heading:"esri-widget__heading",hidden:"esri-hidden",input:"esri-input",button:"esri-button",disabled:"esri-disabled",widget:"esri-widget"},R={preview:!0},L={maximumFractionDigits:0},k=e=>`1:${u.formatNumber(e,L)}`,P=e=>{const a=/[^\d.\s]/g,l=e.replace(/.*\(/,"").replace(/\).*$/,"").replace(/.*:/,"").replace(a,"");return parseFloat(l)};let N=function(a){function l(l,t){var i;return(i=a.call(this,l,t)||this)._activeMenu=null,i._activeMenuNode=null,i._activeMenuToggleNode=null,i._activeThumb=null,i._customMaxScale=-1,i._customMinScale=-1,i._focusedMenuItemIndex=-1,i._previewAutoCloseTimeoutId=null,i._previewPopover=new b({owner:e._assertThisInitialized(i),placement:"top",anchorElement:()=>0===i._activeThumb?i._minThumbNode:i._maxThumbNode,offset:[0,16],renderContentFunction:i.renderScalePreview}),i._maxScaleMenuPopover=new b({owner:e._assertThisInitialized(i),placement:"bottom-end",anchorElement:()=>i._activeMenuToggleNode,renderContentFunction:i.renderMaxScaleMenu}),i._minScaleMenuPopover=new b({owner:e._assertThisInitialized(i),placement:"bottom-start",anchorElement:()=>i._activeMenuToggleNode,renderContentFunction:i.renderMinScaleMenu}),i._scaleMenuNode=null,i._slider=new y({thumbCreatedFunction:(a,l,t)=>{0===a&&(i._minThumbNode=t),1===a&&(i._maxThumbNode=t),i.own([d.on(t,"mouseenter",(()=>{const{visibleElements:{preview:l}}=e._assertThisInitialized(i);i._activeThumb=a,i._previewPopover.open=l,i.scheduleRender()})),d.on(t,"mouseleave",(()=>{i._previewAutoCloseTimeoutId||(i._activeThumb=null,i._previewPopover.open=!1,i.scheduleRender())}))])}}),i.disabled=!1,i.label=void 0,i.layer=null,i.maxScale=null,i.maxScaleLimit=null,i.messages=null,i.minScale=null,i.minScaleLimit=null,i.region="US",i.view=null,i.viewModel=new T,i.visibleElements=R,i._handleScaleMenuToggleClick=e=>{const a=e.currentTarget,l=a.getAttribute("data-type"),t="menu-closing-click-handle";if(i.handles.remove(t),l===i._activeMenu)return i._setActiveMenu(null),void(i._activeMenuToggleNode=null);i._setActiveMenu(l),i._activeMenuToggleNode=a,i.handles.add(d.on(document,"mousedown",(e=>{const a=e.target,l=h.closest(a,`.${C.scaleMenuToggle}`),n=l&&l.getAttribute("data-type");if(l&&n===i._activeMenu)return;!n&&i._scaleMenuNode&&!i._scaleMenuNode.contains(a)&&(i._setActiveMenu(null),i.handles.remove(t),i.scheduleRender())})),t)},i._afterMenuListCreate=e=>{i._activeMenuNode=e,e.children[0].focus({preventScroll:!0})},i._handleCustomScaleEntry=e=>{i._setScaleFromMenuSelection(e),i._customMaxScale=-1,i._customMinScale=-1},i._handleCustomScaleInputBlur=()=>{"max"===i._activeMenu?i._customMaxScale=-1:i._customMinScale=-1},i.handleCustomScaleInputKeyDown=a=>{const l=a.currentTarget,{handleCustomScaleSelect:t}=l["data-render-props"],{key:n,ctrlKey:s,metaKey:c}=a,{viewModel:{scaleRanges:r}}=e._assertThisInitialized(i);if("Enter"===n){const e=P(l.value);return t(isNaN(e)?-1:r.clampScale(e)),a.preventDefault(),void a.stopPropagation()}if(n.length>1||s||c)return;/[:,.\d]/.test(n)||(a.preventDefault(),a.stopPropagation())},i._handleScaleMenuKeyDown=e=>{const a=d.eventKey(e);if("Escape"===a||"Tab"===a)return i._setActiveMenu(null),void i._activeMenuToggleNode.focus();if("ArrowUp"!==a&&"ArrowDown"!==a)return;const l=i._activeMenuNode.children,t=i._focusedMenuItemIndex,n="ArrowUp"===a?(0===t?l.length:t)-1:(t+1)%l.length;e.preventDefault(),e.stopPropagation(),l[n].focus(),i._focusedMenuItemIndex=n},i}e._inheritsLoose(l,a);var t=l.prototype;return t.initialize=function(){this.own([p.init(this,"viewModel",(e=>this._slider.viewModel=e?e.sliderViewModel:null)),p.init(this,"_interactive",(e=>{this._slider.disabled=!e,e||this._setActiveMenu(null)})),this._slider.on("thumb-drag",(({index:e})=>{const{visibleElements:{preview:a}}=this;this._activeThumb=e,this._previewPopover.open=a,clearTimeout(this._previewAutoCloseTimeoutId);const l=250;this._previewAutoCloseTimeoutId=setTimeout((()=>{this._previewAutoCloseTimeoutId=null,this._activeThumb=null,this._previewPopover.open=!1,this.scheduleRender()}),l)})),p.whenTrue(this,"view.stationary",(()=>this.scheduleRender()))])},t.destroy=function(){this._previewPopover.destroy(),this._previewPopover=null,this._maxScaleMenuPopover.destroy(),this._maxScaleMenuPopover=null,this._minScaleMenuPopover.destroy(),this._minScaleMenuPopover=null,this._slider.destroy(),this._slider=null},t.castVisibleElements=function(e){return{...R,...e}},t.render=function(){const{_interactive:e,_slider:a,label:l,messages:t,view:i,viewModel:{scaleRanges:n,state:s}}=this,c=t.scaleRangeLabels[n.findScaleRangeByIndex(a.values[0]).id],r=t.scaleRangeLabels[n.findScaleRangeByIndex(a.values[1]).id];return a.layout=S.isRTL()?"horizontal-reversed":"horizontal",w.jsx("div",{"aria-label":l,class:this.classes(C.base,C.widget,e?null:C.disabled)},"ready"===s&&i?this.renderCurrentScaleIndicator():null,a.render(),w.jsx("div",{class:C.scaleMenuContainer,key:"scale-menu-toggles"},this.renderScaleMenuToggle("min",c),this.renderScaleMenuToggle("max",r)))},t.renderMinScaleMenu=function(){const{_effectiveMaxScale:e,minScaleLimit:a,view:l,viewModel:{scaleRanges:t}}=this,i=l?l.scale:void 0;return this.renderScaleMenu({type:"min",min:a,max:t.findScaleRange(e).minScale,map:i})},t.renderMaxScaleMenu=function(){const{_effectiveMinScale:e,maxScaleLimit:a,view:l,viewModel:{scaleRanges:t}}=this,i=l?l.scale:void 0;return this.renderScaleMenu({type:"max",min:t.findScaleRange(e).maxScale,max:a,map:i})},t.renderScalePreview=function(){const{_activeThumb:e,_slider:a,region:l,viewModel:{scaleRanges:t}}=this,i=0===e?a.values[0]:a.values[1],n=Object.keys(I.RecommendedScales).indexOf(t.findScaleRangeByIndex(i).id),s={backgroundImage:x.getScalePreviewSource(l),backgroundPosition:x.getScalePreviewSpriteBackgroundPosition(n)};return w.jsx("div",{class:C.scalePreview},w.jsx("div",{class:C.scalePreviewThumbnail,styles:s}))},t.renderScaleMenu=function({map:e,min:a,max:l,type:t}){const i=I.fromScaleRange({minScale:a,maxScale:l}),n=this.messages.featuredScaleLabels,s=I.RecommendedScales,c=Object.keys(s).filter((e=>i.contains(s[e]))).map((e=>this.renderScaleMenuItem({scaleLabel:n[e],scaleValue:s[e],valueVisible:"world"!==e,handleNamedScaleSelect:this._handleRecommendedScaleClick}))),{_customMaxScale:r,_customMinScale:o,messages:d}=this,u="max"===t?r:o;return w.jsx("div",{bind:this,class:C.scaleMenu,"data-type":t,id:`${this.id}__scale-menu--${t}`,key:`${t}-scale-menu`,afterCreate:S.storeNode,"data-node-ref":"_scaleMenuNode",onkeydown:this._handleScaleMenuKeyDown},w.jsx("div",{class:C.scaleMenuScroller},w.jsx("ul",{class:C.scaleMenuList,afterCreate:this._afterMenuListCreate},this.renderScaleMenuItem({scaleValue:u,scaleLabel:d.featuredScaleLabels.custom,valueVisible:!1,handleNamedScaleSelect:this._handleScaleSelection,handleCustomScaleSelect:this._handleCustomScaleEntry}),null!=e?this.renderScaleMenuItem({scaleValue:e,scaleLabel:d.featuredScaleLabels.current,valueVisible:!0,handleNamedScaleSelect:this._handleRecommendedScaleClick}):null,c)))},t._handleScaleSelection=function(){"max"===this._activeMenu?this._customMaxScale=this._effectiveMaxScale:this._customMinScale=this._effectiveMinScale},t.renderScaleMenuToggle=function(e,a){const{_activeMenu:l,_interactive:t}=this,i=l===e;return w.jsx("button",{"aria-controls":i?`${this.id}__scale-menu--${e}`:"","aria-pressed":i?"true":"false",class:this.classes(C.scaleMenuToggle,i?C.scaleMenuToggleActive:null),"data-type":e,key:`${e}-scale-menu-toggle`,onclick:this._handleScaleMenuToggleClick,disabled:!t,type:"button"},a,w.jsx("span",{class:this.classes(C.scaleMenuToggleIcon,C.expandIcon),"aria-hidden":"true"}))},t.renderScaleMenuItem=function(e){const{scaleValue:a,scaleLabel:l,valueVisible:t,handleNamedScaleSelect:i,handleCustomScaleSelect:n=null}=e,{id:s}=this,c=`${s}__custom-scale-input`;return w.jsx("li",{bind:this,class:C.scaleMenuListItem,"data-scale":a,key:l,onclick:i,onkeydown:i,tabIndex:-1},w.jsx("label",{class:C.scaleItemLabel,for:c},l),a>-1?n?w.jsx("input",{afterCreate:this.focusAndSelectInputOnCreate,class:this.classes(C.scaleItemValue,C.scaleItemValueEditable),"data-render-props":e,id:c,key:"value",value:k(a),onkeydown:this.handleCustomScaleInputKeyDown,onblur:this._handleCustomScaleInputBlur}):t?w.jsx("div",{class:C.scaleItemValue,key:"value"},k(a)):null:null)},t.focusAndSelectInputOnCreate=function(e){e.focus(),e.select()},t.renderCurrentScaleIndicator=function(){const{_slider:e,messages:a,view:l,viewModel:{scaleRanges:t}}=this,i=t.clampScale(l.scale),n=this.viewModel.mapScaleToSlider(i),s=n/e.max,c=a.scaleRangeLabels[t.findScaleRangeByIndex(n).id],r=m.substitute(a.currentScaleTooltip,{scaleLabel:c});return w.jsx("div",{class:C.scaleIndicatorContainer,key:"scale-indicator"},w.jsx("div",{"aria-label":r,class:C.scaleIndicator,styles:{left:(S.isRTL()?-1:1)*s*100+"%"},title:r},this.renderCurrentScaleIndicatorIcon()))},t.renderCurrentScaleIndicatorIcon=function(){return w.jsx("svg",{class:C.scaleIndicatorIcon,height:"8",width:"8",viewBox:"0 0 8 8",version:"1.1",xmlns:"http://www.w3.org/2000/svg"},w.jsx("polygon",{points:"4 0 8 8 0 8"}))},t._handleRecommendedScaleClick=function(e){const a=e.currentTarget,l=Number(a["data-scale"]);this._setScaleFromMenuSelection(l)},t._setScaleFromMenuSelection=function(e){"max"===this._activeMenu?this.maxScale=Math.min(e,this._effectiveMinScale-1):this.minScale=Math.max(e,this._effectiveMaxScale+1),this._setActiveMenu(null),this._activeMenuToggleNode.focus()},t._setActiveMenu=function(e){this._activeMenu=e,this._maxScaleMenuPopover.open="max"===e,this._minScaleMenuPopover.open="min"===e,this._focusedMenuItemIndex=e?0:-1},e._createClass(l,[{key:"_effectiveMaxScale",get:function(){return 0===this.maxScale?this.maxScaleLimit:this.maxScale}},{key:"_effectiveMinScale",get:function(){return 0===this.minScale?this.minScaleLimit:this.minScale}},{key:"_interactive",get:function(){return"disabled"!==this.get("viewModel.state")&&!this.disabled}}]),l}(v.HandleOwnerMixin(f));return a.__decorate([i.property()],N.prototype,"_slider",void 0),a.__decorate([i.property()],N.prototype,"_effectiveMaxScale",null),a.__decorate([i.property()],N.prototype,"_effectiveMinScale",null),a.__decorate([i.property({readOnly:!0})],N.prototype,"_interactive",null),a.__decorate([i.property()],N.prototype,"disabled",void 0),a.__decorate([i.property({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],N.prototype,"label",void 0),a.__decorate([i.property({aliasOf:"viewModel.layer"})],N.prototype,"layer",void 0),a.__decorate([i.property({aliasOf:"viewModel.maxScale"})],N.prototype,"maxScale",void 0),a.__decorate([i.property({aliasOf:"viewModel.maxScaleLimit"})],N.prototype,"maxScaleLimit",void 0),a.__decorate([i.property(),M.messageBundle("esri/widgets/ScaleRangeSlider/t9n/ScaleRangeSlider")],N.prototype,"messages",void 0),a.__decorate([i.property({aliasOf:"viewModel.minScale"})],N.prototype,"minScale",void 0),a.__decorate([i.property({aliasOf:"viewModel.minScaleLimit"})],N.prototype,"minScaleLimit",void 0),a.__decorate([i.property()],N.prototype,"region",void 0),a.__decorate([i.property({aliasOf:"viewModel.view"})],N.prototype,"view",void 0),a.__decorate([i.property()],N.prototype,"viewModel",void 0),a.__decorate([i.property()],N.prototype,"visibleElements",void 0),a.__decorate([n.cast("visibleElements")],N.prototype,"castVisibleElements",null),a.__decorate([g.accessibleHandler()],N.prototype,"_handleScaleSelection",null),a.__decorate([g.accessibleHandler()],N.prototype,"_handleRecommendedScaleClick",null),N=a.__decorate([s.subclass("esri.widgets.ScaleRangeSlider")],N),N}));
