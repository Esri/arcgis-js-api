/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../intl","../core/domUtils","../core/events","../core/HandleOwner","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/cast","../core/arrayUtils","../core/accessorSupport/decorators/subclass","./Slider","./Widget","./ScaleRangeSlider/css","./ScaleRangeSlider/scalePreviewUtils","./ScaleRangeSlider/ScaleRanges","./ScaleRangeSlider/ScaleRangeSliderViewModel","./support/Popover","./support/decorators/accessibleHandler","./support/decorators/messageBundle","./support/jsxFactory","./support/widgetUtils","../intl/substitute","../intl/number"],(function(e,t,n,l,a,i,s,c,o,r,u,d,S,m,p,v,_,h,M,f,g,y,w,b){"use strict";const x={preview:!0,scaleMenus:{maxScaleMenu:!0,minScaleMenu:!0}},C={maximumFractionDigits:0},I=e=>`1:${b.formatNumber(e,C)}`,T=e=>{const t=/[^\d.\s]/g,n=e.replace(/.*\(/,"").replace(/\).*$/,"").replace(/.*:/,"").replace(t,"");return parseFloat(n)};let k=function(t){function n(n,i){var s;return(s=t.call(this,n,i)||this)._activeMenu=null,s._activeMenuNode=null,s._activeMenuToggleNode=null,s._activeThumb=null,s._customMaxScale=-1,s._customMinScale=-1,s._focusedMenuItemIndex=-1,s._maxScaleMenuPopover=new h({owner:e._assertThisInitialized(s),placement:"bottom-end",anchorElement:()=>s._activeMenuToggleNode,renderContentFunction:()=>s._maxScaleMenuEnabled?s.renderMaxScaleMenu():null}),s._minScaleMenuPopover=new h({owner:e._assertThisInitialized(s),placement:"bottom-start",anchorElement:()=>s._activeMenuToggleNode,renderContentFunction:()=>s._minScaleMenuEnabled?s.renderMinScaleMenu():null}),s._previewAutoCloseTimeoutId=null,s._previewPopover=new h({owner:e._assertThisInitialized(s),placement:"top",anchorElement:()=>0===s._activeThumb?s._minThumbNode:s._maxThumbNode,offset:[0,16],renderContentFunction:s.renderScalePreview}),s._scaleMenuNode=null,s._slider=new d({thumbCreatedFunction:(t,n,l)=>{0===t&&(s._minThumbNode=l),1===t&&(s._maxThumbNode=l),s.addHandles([a.on(l,"mouseenter",(()=>{const{visibleElements:{preview:n}}=e._assertThisInitialized(s);s._activeThumb=t,s._previewPopover.open=n,s.scheduleRender()})),a.on(l,"mouseleave",(()=>{s._previewAutoCloseTimeoutId||(s._activeThumb=null,s._previewPopover.open=!1,s.scheduleRender())}))])}}),s.disabled=!1,s.messages=null,s.region="US",s.viewModel=new _,s.visibleElements=x,s._handleScaleMenuToggleClick=e=>{const t=e.currentTarget,n=t.getAttribute("data-type"),i="menu-closing-click-handle";if(s.handles.remove(i),n===s._activeMenu)return s._setActiveMenu(null),void(s._activeMenuToggleNode=null);s._setActiveMenu(n),s._activeMenuToggleNode=t,s.handles.add(a.on(document,"mousedown",(e=>{const t=e.target,n=l.closest(t,`.${m.CSS.scaleMenuToggle}`),a=n&&n.getAttribute("data-type");if(n&&a===s._activeMenu)return;!a&&s._scaleMenuNode&&!s._scaleMenuNode.contains(t)&&(s._setActiveMenu(null),s.handles.remove(i),s.scheduleRender())})),i)},s._afterMenuListCreate=e=>{s._activeMenuNode=e,e.children[0].focus({preventScroll:!0})},s._handleCustomScaleEntry=e=>{s._setScaleFromMenuSelection(e),s._customMaxScale=-1,s._customMinScale=-1},s._handleCustomScaleInputBlur=()=>{"max"===s._activeMenu?s._customMaxScale=-1:s._customMinScale=-1},s._handleCustomScaleInputKeyDown=t=>{const n=t.currentTarget,{handleCustomScaleSelect:l}=n["data-render-props"],{key:a,ctrlKey:i,metaKey:c}=t,{viewModel:{scaleRanges:o}}=e._assertThisInitialized(s);if("Enter"===a){const e=T(n.value);return l(isNaN(e)?-1:o.clampScale(e)),t.preventDefault(),void t.stopPropagation()}if(a.length>1||i||c)return;/[:,.\d]/.test(a)||(t.preventDefault(),t.stopPropagation())},s._handleScaleMenuKeyDown=e=>{const t=a.eventKey(e);if("Escape"===t||"Tab"===t)return s._setActiveMenu(null),void s._activeMenuToggleNode.focus();if("ArrowUp"!==t&&"ArrowDown"!==t)return;const n=s._activeMenuNode.children,l=s._focusedMenuItemIndex,i="ArrowUp"===t?(0===l?n.length:l)-1:(l+1)%n.length;e.preventDefault(),e.stopPropagation(),n[i].focus(),s._focusedMenuItemIndex=i},s}e._inheritsLoose(n,t);var i=n.prototype;return i.initialize=function(){this.addHandles([s.watch((()=>this.viewModel),(e=>this._slider.viewModel=e?e.sliderViewModel:null),s.initial),s.watch((()=>this._interactive),(e=>{this._slider.disabled=!e,e||this._setActiveMenu(null)}),s.initial),this._slider.on("thumb-drag",(({index:e})=>{const{visibleElements:{preview:t}}=this;this._activeThumb=e,this._previewPopover.open=t,clearTimeout(this._previewAutoCloseTimeoutId);const n=250;this._previewAutoCloseTimeoutId=setTimeout((()=>{this._previewAutoCloseTimeoutId=null,this._activeThumb=null,this._previewPopover.open=!1,this.scheduleRender()}),n)})),s.when((()=>!0===this.view?.stationary),(()=>this.scheduleRender()))])},i.destroy=function(){this._previewPopover.destroy(),this._previewPopover=null,this._maxScaleMenuPopover.destroy(),this._maxScaleMenuPopover=null,this._minScaleMenuPopover.destroy(),this._minScaleMenuPopover=null,this._slider.destroy(),this._slider=null},i.castVisibleElements=function(e){return{...x,...e,scaleMenus:"boolean"==typeof e?.scaleMenus?e.scaleMenus:{...x.scaleMenus,...e?.scaleMenus}}},i.render=function(){const{_interactive:e,_slider:t,label:n,messages:l,view:a,viewModel:{scaleRanges:i,state:s}}=this,c=l.scaleRangeLabels[i.findScaleRangeByIndex(t.values[0]).id],o=l.scaleRangeLabels[i.findScaleRangeByIndex(t.values[1]).id];return t.layout=y.isRTL(this.container)?"horizontal-reversed":"horizontal",g.tsx("div",{"aria-label":n,class:this.classes(m.CSS.base,m.CSS.widget,e?null:m.CSS.disabled)},"ready"===s&&a?this.renderCurrentScaleIndicator():null,t.render(),g.tsx("div",{class:m.CSS.scaleMenuContainer,key:"scale-menu-toggles"},this._minScaleMenuEnabled?this.renderScaleMenuToggle("min",c):null,this._maxScaleMenuEnabled?this.renderScaleMenuToggle("max",o):null))},i.renderMinScaleMenu=function(){const{effectiveMaxScale:e,effectiveMinScaleLimit:t,view:n,viewModel:{scaleRanges:l}}=this,a=n?n.scale:void 0;return this.renderScaleMenu({type:"min",min:t,max:l.findScaleRange(e).minScale,map:a})},i.renderMaxScaleMenu=function(){const{effectiveMinScale:e,effectiveMaxScaleLimit:t,view:n,viewModel:{scaleRanges:l}}=this,a=n?n.scale:void 0;return this.renderScaleMenu({type:"max",min:l.findScaleRange(e).maxScale,max:t,map:a})},i.renderScalePreview=function(){const{_activeThumb:e,_slider:t,region:n,viewModel:{scaleRanges:l}}=this,a=0===e?t.values[0]:t.values[1],i=Object.keys(v.RecommendedScales).indexOf(l.findScaleRangeByIndex(a).id),s={backgroundImage:p.getScalePreviewSource(n),backgroundPosition:p.getScalePreviewSpriteBackgroundPosition(i)};return g.tsx("div",{class:m.CSS.scalePreview},g.tsx("div",{class:m.CSS.scalePreviewThumbnail,styles:s}))},i.renderScaleMenu=function({map:e,min:t,max:n,type:l}){const a=v.fromScaleRange({minScale:t,maxScale:n}),i=this.messages.featuredScaleLabels,s=v.RecommendedScales,c=Object.keys(s).filter((e=>a.contains(s[e]))).map((e=>this.renderScaleMenuItem({scaleLabel:i[e],scaleValue:s[e],valueVisible:"world"!==e,handleNamedScaleSelect:this._handleRecommendedScaleClick}))),{_customMaxScale:o,_customMinScale:r,messages:u}=this,d="max"===l?o:r;return g.tsx("div",{bind:this,class:m.CSS.scaleMenu,"data-type":l,id:`${this.id}__scale-menu--${l}`,key:`${l}-scale-menu`,afterCreate:y.storeNode,"data-node-ref":"_scaleMenuNode",onkeydown:this._handleScaleMenuKeyDown},g.tsx("div",{class:m.CSS.scaleMenuScroller},g.tsx("ul",{class:m.CSS.scaleMenuList,afterCreate:this._afterMenuListCreate},this.renderScaleMenuItem({scaleValue:d,scaleLabel:u.featuredScaleLabels.custom,valueVisible:!1,handleNamedScaleSelect:this._handleScaleSelection,handleCustomScaleSelect:this._handleCustomScaleEntry}),null!=e?this.renderScaleMenuItem({scaleValue:e,scaleLabel:u.featuredScaleLabels.current,valueVisible:!0,handleNamedScaleSelect:this._handleRecommendedScaleClick}):null,c)))},i._handleScaleSelection=function(){"max"===this._activeMenu?this._customMaxScale=this.effectiveMaxScale:this._customMinScale=this.effectiveMinScale},i.renderScaleMenuToggle=function(e,t){const{_activeMenu:n,_interactive:l}=this,a=n===e;return g.tsx("button",{"aria-controls":a?`${this.id}__scale-menu--${e}`:"","aria-pressed":a?"true":"false",class:this.classes(m.CSS.scaleMenuToggle,a?m.CSS.scaleMenuToggleActive:null),"data-type":e,key:`${e}-scale-menu-toggle`,onclick:this._handleScaleMenuToggleClick,disabled:!l,type:"button"},g.tsx("div",{class:m.CSS.scaleMenuToggleText,"aria-label":t,title:t},t),g.tsx("span",{class:this.classes(m.CSS.scaleMenuToggleIcon,m.CSS.expandIcon),"aria-hidden":"true"}))},i.renderScaleMenuItem=function(e){const{scaleValue:t,scaleLabel:n,valueVisible:l,handleNamedScaleSelect:a,handleCustomScaleSelect:i=null}=e,{id:s}=this,c=`${s}__custom-scale-input`;return g.tsx("li",{bind:this,class:m.CSS.scaleMenuListItem,"data-scale":t,key:n,onclick:a,onkeydown:a,tabIndex:-1},g.tsx("label",{class:m.CSS.scaleItemLabel,for:c},n),t>-1?i?g.tsx("input",{afterCreate:this._focusAndSelectInputOnCreate,class:this.classes(m.CSS.scaleItemValue,m.CSS.scaleItemValueEditable),"data-render-props":e,id:c,key:"value",value:I(t),onkeydown:this._handleCustomScaleInputKeyDown,onblur:this._handleCustomScaleInputBlur}):l?g.tsx("div",{class:m.CSS.scaleItemValue,key:"value"},I(t)):null:null)},i._focusAndSelectInputOnCreate=function(e){e.focus(),e.select()},i.renderCurrentScaleIndicator=function(){const{_slider:e,messages:t,view:n,viewModel:{scaleRanges:l}}=this,a=l.clampScale(n.scale),i=this.viewModel.mapScaleToSlider(a),s=i/e.max,c=t.scaleRangeLabels[l.findScaleRangeByIndex(i).id],o=w.substitute(t.currentScaleTooltip,{scaleLabel:c});return g.tsx("div",{class:m.CSS.scaleIndicatorContainer,key:"scale-indicator"},g.tsx("div",{"aria-label":o,class:m.CSS.scaleIndicator,styles:{left:(y.isRTL(this.container)?-1:1)*s*100+"%"},title:o},this.renderCurrentScaleIndicatorIcon()))},i.renderCurrentScaleIndicatorIcon=function(){return g.tsx("svg",{class:m.CSS.scaleIndicatorIcon,height:"8",width:"8",viewBox:"0 0 8 8",version:"1.1",xmlns:"http://www.w3.org/2000/svg"},g.tsx("polygon",{points:"4 0 8 8 0 8"}))},i._handleRecommendedScaleClick=function(e){const t=e.currentTarget,n=Number(t["data-scale"]);this._setScaleFromMenuSelection(n)},i._setScaleFromMenuSelection=function(e){"max"===this._activeMenu?this.maxScale=Math.min(e,this.effectiveMinScale-1):this.minScale=Math.max(e,this.effectiveMaxScale+1),this._setActiveMenu(null),this._activeMenuToggleNode.focus()},i._setActiveMenu=function(e){this._activeMenu=e,this._maxScaleMenuPopover.open="max"===e,this._minScaleMenuPopover.open="min"===e,this._focusedMenuItemIndex=e?0:-1},e._createClass(n,[{key:"_maxScaleMenuEnabled",get:function(){const{scaleMenus:e}=this.visibleElements;return!0===e||"boolean"!=typeof e&&e.maxScaleMenu}},{key:"_minScaleMenuEnabled",get:function(){const{scaleMenus:e}=this.visibleElements;return!0===e||"boolean"!=typeof e&&e.minScaleMenu}},{key:"_interactive",get:function(){return"disabled"!==this.get("viewModel.state")&&!this.disabled}},{key:"effectiveMaxScale",get:function(){return this.viewModel.effectiveMaxScale}},{key:"effectiveMinScale",get:function(){return this.viewModel.effectiveMinScale}},{key:"effectiveMaxScaleLimit",get:function(){return this.viewModel.effectiveMaxScaleLimit}},{key:"effectiveMinScaleLimit",get:function(){return this.viewModel.effectiveMinScaleLimit}},{key:"label",get:function(){return this.messages?.widgetLabel??""},set:function(e){this._overrideIfSome("label",e)}},{key:"layer",get:function(){return this.viewModel.layer},set:function(e){this.viewModel.layer=e}},{key:"maxScale",get:function(){return this.viewModel.maxScale},set:function(e){this.viewModel.maxScale=e}},{key:"maxScaleLimit",get:function(){return this.viewModel.maxScaleLimit},set:function(e){this.viewModel.maxScaleLimit=e}},{key:"minScale",get:function(){return this.viewModel.minScale},set:function(e){this.viewModel.minScale=e}},{key:"minScaleLimit",get:function(){return this.viewModel.minScaleLimit},set:function(e){this.viewModel.minScaleLimit=e}},{key:"view",get:function(){return this.viewModel.view},set:function(e){this.viewModel.view=e}}]),n}(i.HandleOwnerMixin(S));t.__decorate([c.property()],k.prototype,"_maxScaleMenuEnabled",null),t.__decorate([c.property()],k.prototype,"_minScaleMenuEnabled",null),t.__decorate([c.property()],k.prototype,"_slider",void 0),t.__decorate([c.property({readOnly:!0})],k.prototype,"_interactive",null),t.__decorate([c.property()],k.prototype,"disabled",void 0),t.__decorate([c.property()],k.prototype,"effectiveMaxScale",null),t.__decorate([c.property()],k.prototype,"effectiveMinScale",null),t.__decorate([c.property()],k.prototype,"effectiveMaxScaleLimit",null),t.__decorate([c.property()],k.prototype,"effectiveMinScaleLimit",null),t.__decorate([c.property()],k.prototype,"label",null),t.__decorate([c.property()],k.prototype,"layer",null),t.__decorate([c.property()],k.prototype,"maxScale",null),t.__decorate([c.property()],k.prototype,"maxScaleLimit",null),t.__decorate([c.property(),f.messageBundle("esri/widgets/ScaleRangeSlider/t9n/ScaleRangeSlider")],k.prototype,"messages",void 0),t.__decorate([c.property()],k.prototype,"minScale",null),t.__decorate([c.property()],k.prototype,"minScaleLimit",null),t.__decorate([c.property()],k.prototype,"region",void 0),t.__decorate([c.property()],k.prototype,"view",null),t.__decorate([c.property()],k.prototype,"viewModel",void 0),t.__decorate([c.property()],k.prototype,"visibleElements",void 0),t.__decorate([o.cast("visibleElements")],k.prototype,"castVisibleElements",null),t.__decorate([M.accessibleHandler()],k.prototype,"_handleScaleSelection",null),t.__decorate([M.accessibleHandler()],k.prototype,"_handleRecommendedScaleClick",null),k=t.__decorate([u.subclass("esri.widgets.ScaleRangeSlider")],k);return k}));
