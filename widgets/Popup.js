// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../core/tsSupport/assignHelper","../core/tsSupport/generatorHelper","../core/tsSupport/awaiterHelper","dojo/i18n!../nls/common","dojo/i18n!./Popup/nls/Popup","../intl","../core/events","../core/Handles","../core/Logger","../core/promiseUtils","../core/watchUtils","../core/accessorSupport/decorators","./Spinner","./Widget","./Popup/PopupViewModel","./support/widget","./support/widgetUtils"],function(e,t,o,i,n,r,s,a,l,u,p,c,d,h,f,g,_,v,b,y,w){function m(e,t){return void 0===t?C+"__"+e:C+"__"+e+"-"+t}function M(){return s(this,void 0,void 0,function(){return r(this,function(t){return[2,h.create(function(t){e(["./Feature"],function(e){t(e)})})]})})}var k={iconLeftTriangleArrow:"esri-icon-left-triangle-arrow",iconRightTriangleArrow:"esri-icon-right-triangle-arrow",iconDockToTop:"esri-icon-maximize",iconDockToBottom:"esri-icon-dock-bottom",iconDockToLeft:"esri-icon-dock-left",iconDockToRight:"esri-icon-dock-right",iconClose:"esri-icon-close",iconUndock:"esri-icon-minimize",iconCheckMark:"esri-icon-check-mark",iconLoading:"esri-icon-loading-indicator",iconDefaultAction:"esri-icon-default-action",iconActionsMenu:"esri-icon-handle-horizontal",rotating:"esri-rotating",base:"esri-popup",widget:"esri-widget",main:"esri-popup__main-container",loadingContainer:"esri-popup__loading-container",isCollapsible:"esri-popup--is-collapsible",isCollapsed:"esri-popup--is-collapsed",shadow:"esri-popup--shadow",isDocked:"esri-popup--is-docked",isDockedTopLeft:"esri-popup--is-docked-top-left",isDockedTopCenter:"esri-popup--is-docked-top-center",isDockedTopRight:"esri-popup--is-docked-top-right",isDockedBottomLeft:"esri-popup--is-docked-bottom-left",isDockedBottomCenter:"esri-popup--is-docked-bottom-center",isDockedBottomRight:"esri-popup--is-docked-bottom-right",alignTopCenter:"esri-popup--aligned-top-center",alignBottomCenter:"esri-popup--aligned-bottom-center",alignTopLeft:"esri-popup--aligned-top-left",alignBottomLeft:"esri-popup--aligned-bottom-left",alignTopRight:"esri-popup--aligned-top-right",alignBottomRight:"esri-popup--aligned-bottom-right",isFeatureMenuOpen:"esri-popup--feature-menu-open",isActionsMenuOpen:"esri-popup--actions-menu-open",hasFeatureUpdated:"esri-popup--feature-updated",header:"esri-popup__header",headerButtons:"esri-popup__header-buttons",headerContainer:"esri-popup__header-container",headerContainerButton:"esri-popup__header-container--button",headerTitle:"esri-popup__header-title",content:"esri-popup__content",footer:"esri-popup__footer",footerHasPagination:"esri-popup__footer--has-pagination",footerHasActions:"esri-popup__footer--has-actions",footerHasActionsMenu:"esri-popup__footer--has-actions-menu",button:"esri-popup__button",buttonDisabled:"esri-popup__button--disabled",buttonDock:"esri-popup__button--dock",icon:"esri-popup__icon",iconDock:"esri-popup__icon--dock-icon",inlineActionsContainer:"esri-popup__inline-actions-container",actionsMenuButton:"esri-popup__actions-menu-button",actions:"esri-popup__actions",action:"esri-popup__action",actionImage:"esri-popup__action-image",actionText:"esri-popup__action-text",actionToggle:"esri-popup__action-toggle",actionToggleOn:"esri-popup__action-toggle--on",pointer:"esri-popup__pointer",pointerDirection:"esri-popup__pointer-direction",navigation:"esri-popup__navigation",paginationPrevious:"esri-popup__pagination-previous",paginationNext:"esri-popup__pagination-next",paginationPreviousIconLTR:"esri-popup__pagination-previous-icon",paginationPreviousIconRTL:"esri-popup__pagination-previous-icon--rtl",paginationNextIconLTR:"esri-popup__pagination-next-icon",paginationNextIconRTL:"esri-popup__pagination-next-icon--rtl",featureMenu:"esri-popup__feature-menu",featureMenuList:"esri-popup__feature-menu-list",featureMenuItem:"esri-popup__feature-menu-item",featureMenuViewport:"esri-popup__feature-menu-viewport",featureMenuHeader:"esri-popup__feature-menu-header",featureMenuNote:"esri-popup__feature-menu-note",featureMenuSelected:"esri-popup__feature-menu-item--selected",featureMenuButton:"esri-popup__feature-menu-button",featureMenuTitle:"esri-popup__feature-menu-title",collapseButton:"esri-popup__collapse-button"},x={buttonEnabled:!0,position:"auto",breakpoint:{width:544}},C="esri-popup",F=d.getLogger("esri.widgets.Popup");return function(e){function t(t){var o=e.call(this)||this;return o._blurContainer=!1,o._containerNode=null,o._mainContainerNode=null,o._featureMenuNode=null,o._actionsMenuNode=null,o._focusContainer=!1,o._focusDockButton=!1,o._focusFeatureMenuButton=!1,o._focusActionsMenuButton=!1,o._focusFirstFeature=!1,o._focusFirstAction=!1,o._handles=new c,o._pointerOffsetInPx=16,o._spinner=null,o.actions=null,o.alignment="auto",o.autoCloseEnabled=null,o.autoOpenEnabled=null,o.defaultPopupTemplateEnabled=null,o.content=null,o.collapsed=!1,o.collapseEnabled=!0,o.dockEnabled=!1,o.featureCount=null,o.featureMenuOpen=!1,o.features=null,o.featureNavigationEnabled=!0,o.goToOverride=null,o.highlightEnabled=null,o.location=null,o.featureWidgets=[],o.promises=null,o.selectedFeature=null,o.selectedFeatureIndex=null,o.selectedFeatureWidget=null,o.spinnerEnabled=!0,o.title=null,o.updateLocationEnabled=null,o.view=null,o.viewModel=new b,o.visible=null,o._addSelectedFeatureIndexHandle(),o.own([f.watch(o,"viewModel.screenLocation",function(){return o._positionContainer()}),f.watch(o,["viewModel.visible","dockEnabled"],function(){return o._toggleScreenLocationEnabled()}),f.watch(o,"viewModel.screenLocation",function(e,t){!!e!=!!t&&o.reposition()}),f.watch(o,"viewModel.features",function(){return o._updateFeatureWidgets()}),f.watch(o,["viewModel.view.padding","viewModel.view.size","viewModel.visible","viewModel.waitingForResult","viewModel.location","alignment"],function(){return o.reposition()}),f.watch(o,"spinnerEnabled",function(e){return o._spinnerEnabledChange(e)}),f.watch(o,"viewModel.view.size",function(e,t){return o._updateDockEnabledForViewSize(e,t)}),f.watch(o,"viewModel.view",function(e,t){return o._viewChange(e,t)}),f.watch(o,"viewModel.view.ready",function(e,t){return o._viewReadyChange(e,t)}),f.watch(o,["viewModel.waitingForResult","viewModel.location"],function(){return o._displaySpinner()}),f.watch(o,["featureWidgets","viewModel.selectedFeatureIndex"],function(){return o._updateFeatureWidget()}),f.watch(o,"selectedFeatureWidget.viewModel.title",function(e){return o._setTitleFromFeatureWidget(e)}),f.watch(o,["selectedFeatureWidget.viewModel.content","selectedFeatureWidget.viewModel.waitingForContent"],function(){return o._setContentFromFeatureWidget()}),f.whenFalse(o,"collapsed",function(){"xsmall"===o.get("viewModel.view.widthBreakpoint")&&o.visible&&o.collapseEnabled&&o.viewModel.centerAtLocation()}),f.on(o,"viewModel.allActions","change",function(){return o._watchActions()}),f.init(o,"viewModel.allActions",function(){return o._watchActions()})]),o}return o(t,e),t.prototype.destroy=function(){this._destroyFeatureWidgets(),this._destroySpinner(),this._handles&&this._handles.destroy(),this._handles=null},Object.defineProperty(t.prototype,"actionsMenuOpen",{get:function(){return!!this.viewModel.visible&&this._get("actionsMenuOpen")},set:function(e){this._set("actionsMenuOpen",!!e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"currentAlignment",{get:function(){return this._getCurrentAlignment()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"currentDockPosition",{get:function(){return this._getCurrentDockPosition()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"dockOptions",{get:function(){return this._get("dockOptions")||x},set:function(e){var t=n({},x),o=this.get("viewModel.view.breakpoints"),i={};o&&(i.width=o.xsmall,i.height=o.xsmall);var r=n({},t,e),s=n({},t.breakpoint,i),a=r.breakpoint;!0===a?r.breakpoint=s:"object"==typeof a&&(r.breakpoint=n({},s,a)),this._set("dockOptions",r),this._setCurrentDockPosition(),this.reposition()},enumerable:!0,configurable:!0}),t.prototype.blur=function(){this.visible||F.warn("Popup cannot be blurred while visible is false"),this._blurContainer=!0,this.scheduleRender()},t.prototype.clear=function(){},t.prototype.close=function(){this.visible=!1},t.prototype.focus=function(){this.visible||F.warn("Popup cannot be focused while visible is false"),this._focusContainer=!0,this.scheduleRender()},t.prototype.next=function(){return null},t.prototype.open=function(e){this._handles.remove("selected-index");var t=!!e&&!!e.featureMenuOpen,o=!!e&&!!e.actionsMenuOpen,i=!!e&&!!e.collapsed,n={collapsed:i,actionsMenuOpen:o,featureMenuOpen:t};"xsmall"===this.get("viewModel.view.widthBreakpoint")&&(n.collapsed=!0),this.set(n),this.viewModel.open(e),this._addSelectedFeatureIndexHandle()},t.prototype.previous=function(){return null},t.prototype.reposition=function(){this.renderNow(),this._positionContainer(),this._setCurrentAlignment()},t.prototype.triggerAction=function(e){return null},t.prototype.render=function(){var e,t,o,i,n,r,s,p=this,c=this,d=c.actionsMenuOpen,h=c.collapsed,f=c.collapseEnabled,g=c.dockEnabled,_=c.featureMenuOpen,v=c.featureNavigationEnabled,b=c.featureWidgets,M=c.visible,x=this.viewModel,C=x.content,F=x.featureCount,A=x.pendingPromisesCount,O=x.selectedFeatureIndex,T=x.title,E=M&&F>1&&v,D=E?2:3,P=this._divideActions(D),N=P.inlineActions,L=P.menuActions,B=E&&_,I=L.length>1&&d,W=E&&this._getPageText(F,O),R=this._renderContent(),S=w.isRTL(),H=!!(this.get("selectedFeatureWidget")?this.get("selectedFeatureWidget.viewModel.waitingForContent")||this.get("selectedFeatureWidget.viewModel.content"):R),U=!!(f&&T&&H),V=U&&!B&&h,K=this.get("viewModel.view.widthBreakpoint"),z=g?l.undock:l.dock,j=this,q=j.currentAlignment,G=j.currentDockPosition,J=A?y.tsx("div",{key:m("loading-container"),role:"presentation",class:k.loadingContainer,"aria-label":a.loading,title:a.loading},y.tsx("span",{"aria-hidden":"true",class:this.classes(k.icon,k.iconLoading,k.rotating)})):null,Q=(e={},e[k.iconRightTriangleArrow]=S,e[k.paginationPreviousIconRTL]=S,e[k.iconLeftTriangleArrow]=!S,e[k.paginationPreviousIconLTR]=!S,e),X=y.tsx("span",{"aria-hidden":"true",class:this.classes(k.icon,Q)}),Y=y.tsx("div",{role:"button",tabIndex:0,bind:this,onclick:this._previous,onkeydown:this._previous,class:this.classes(k.button,k.paginationPrevious),"aria-label":l.previous,title:l.previous},X),Z=(t={},t[k.iconLeftTriangleArrow]=S,t[k.paginationNextIconRTL]=S,t[k.iconRightTriangleArrow]=!S,t[k.paginationNextIconLTR]=!S,t),$=y.tsx("span",{"aria-hidden":"true",class:this.classes(k.icon,Z)}),ee=y.tsx("div",{role:"button",tabIndex:0,bind:this,onclick:this._next,onkeydown:this._next,class:this.classes(k.button,k.paginationNext),"aria-label":l.next,title:l.next},$),te=w.cssTransition("enter",k.hasFeatureUpdated),oe=this.id+"-feature-menu",ie=y.tsx("div",{role:"button",tabIndex:0,bind:this,onclick:this._toggleFeatureMenu,onkeydown:this._toggleFeatureMenu,afterCreate:this._focusFeatureMenuButtonNode,afterUpdate:this._focusFeatureMenuButtonNode,class:this.classes(k.button,k.featureMenuButton),"aria-haspopup":"true","aria-controls":oe,"aria-expanded":_,"aria-label":a.menu,title:a.menu},W),ne=E?[Y,J||ie,ee]:null,re=this._wouldDockTo(),se=(o={},o[k.iconUndock]=g,o[k.iconDock]=!g,o[k.iconDockToRight]=!g&&("top-right"===re||"bottom-right"===re),o[k.iconDockToLeft]=!g&&("top-left"===re||"bottom-left"===re),o[k.iconDockToTop]=!g&&"top-center"===re,o[k.iconDockToBottom]=!g&&"bottom-center"===re,o),ae=y.tsx("span",{"aria-hidden":"true",class:this.classes(se,k.icon)}),le="xsmall"!==K&&this.get("dockOptions.buttonEnabled")?y.tsx("div",{role:"button","aria-label":z,title:z,tabIndex:0,bind:this,onclick:this._toggleDockEnabled,onkeydown:this._toggleDockEnabled,afterCreate:this._focusDockButtonNode,afterUpdate:this._focusDockButtonNode,class:this.classes(k.button,k.buttonDock)},ae):null,ue=(i={},i[k.headerContainerButton]=U,i),pe=U?"button":"heading",ce=U?V?a.expand:a.collapse:"",de=this.id+"-popup-title",he=T?y.tsx("div",{class:this.classes(k.headerContainer,ue),key:T,enterAnimation:te,id:de,role:pe,"aria-label":ce,title:ce,tabIndex:U?0:-1,bind:this,onclick:this._toggleCollapsed,onkeydown:this._toggleCollapsed},y.tsx("h2",{class:k.headerTitle,innerHTML:T})):null,fe=y.tsx("span",{"aria-hidden":"true",class:this.classes(k.icon,k.iconClose)}),ge=y.tsx("div",{role:"button",tabIndex:0,bind:this,onclick:this._close,onkeydown:this._close,class:k.button,"aria-label":a.close,title:a.close},fe),_e=y.tsx("header",{class:k.header},he,y.tsx("div",{class:k.headerButtons},le,ge)),ve=this.id+"-popup-content",be=!H||U&&V?null:y.tsx("article",{key:C,enterAnimation:te,id:ve,class:k.content},R),ye="bottom-left"===q||"bottom-center"===q||"bottom-right"===q||"top-left"===G||"top-center"===G||"top-right"===G,we="top-left"===q||"top-center"===q||"top-right"===q||"bottom-left"===G||"bottom-center"===G||"bottom-right"===G,me=d?a.close:a.open,Me=L.length?y.tsx("div",{key:m("actions-menu-button"),class:this.classes(k.button,k.actionsMenuButton),role:"button",id:this.id+"-actions-menu-button","aria-haspopup":"true","aria-controls":d?this.id+"-actions-menu":null,tabIndex:0,bind:this,onclick:this._toggleActionsMenu,onkeydown:this._toggleActionsMenu,afterCreate:this._focusActionsMenuButtonNode,afterUpdate:this._focusActionsMenuButtonNode,"aria-label":me,title:me},y.tsx("span",{"aria-hidden":"true",class:k.iconActionsMenu})):null,ke=N.length&&N.toArray().map(function(e,t){return p._renderAction({action:e,index:t,type:"inline"})}),xe=L.length&&d?y.tsx("ul",{id:this.id+"-actions-menu",role:"menu","aria-labelledby":this.id+"-actions-menu-button",key:m("actions"),class:k.actions,bind:this,onkeyup:this._handleActionMenuKeyup,afterCreate:this._actionsMenuNodeUpdated,afterUpdate:this._actionsMenuNodeUpdated},L.toArray().map(function(e,t){return p._renderAction({action:e,index:t+D,type:"menu-item"})})):null,Ce=ke?y.tsx("div",{key:"inline-actions-container",class:k.inlineActionsContainer},ke,Me,xe):null,Fe=E?y.tsx("section",{key:m("navigation"),class:this.classes(k.navigation)},ne):null,Ae=(n={},n[k.footerHasPagination]=E,n[k.footerHasActions]=!!N.length,n[k.footerHasActionsMenu]=!!L.length,n),Oe=E||N.length?y.tsx("div",{key:m("feature-buttons"),class:this.classes(k.footer,Ae)},Ce,Fe):null,Te=this._renderFeatureMenuNode(b,O,oe),Ee=u.substitute(l.selectedFeatures,{total:b.length}),De=y.tsx("section",{key:m("menu"),class:k.featureMenu},y.tsx("h2",{class:k.featureMenuHeader},Ee),y.tsx("nav",{class:k.featureMenuViewport,afterCreate:this._featureMenuViewportNodeUpdated,afterUpdate:this._featureMenuViewportNodeUpdated},Te)),Pe=g?null:y.tsx("div",{key:m("pointer"),class:k.pointer,role:"presentation"},y.tsx("div",{class:this.classes(k.pointerDirection,k.shadow)})),Ne=this.get("selectedFeature.layer.title"),Le=this.get("selectedFeature.layer.id"),Be=(r={},r[k.shadow]=g,r[k.isCollapsible]=U,r[k.isCollapsed]=V,r),Ie=(s={},s[k.alignTopCenter]=M&&"top-center"===q,s[k.alignBottomCenter]=M&&"bottom-center"===q,s[k.alignTopLeft]=M&&"top-left"===q,s[k.alignBottomLeft]=M&&"bottom-left"===q,s[k.alignTopRight]=M&&"top-right"===q,s[k.alignBottomRight]="bottom-right"===q,s[k.isDocked]=M&&g,s[k.shadow]=M&&!g,s[k.isDockedTopLeft]=M&&"top-left"===G,s[k.isDockedTopCenter]=M&&"top-center"===G,s[k.isDockedTopRight]=M&&"top-right"===G,s[k.isDockedBottomLeft]=M&&"bottom-left"===G,s[k.isDockedBottomCenter]=M&&"bottom-center"===G,s[k.isDockedBottomRight]=M&&"bottom-right"===G,s[k.isFeatureMenuOpen]=M&&B,s[k.isActionsMenuOpen]=M&&I,s),We=ye?De:null,Re=we?De:null,Se=ye?Oe:null,He=we?Oe:null,Ue=y.tsx("div",{class:this.classes(k.main,k.widget,Be),tabIndex:-1,role:"dialog","aria-labelledby":he?de:"","aria-describedby":be?ve:"",bind:this,onkeyup:this._handleMainKeyup,afterCreate:this._mainContainerNodeUpdated,afterUpdate:this._mainContainerNodeUpdated},Se,We,_e,be,He,Re);return y.tsx("div",{key:m("base"),class:this.classes(k.base,Ie),role:"presentation","data-layer-title":Ne,"data-layer-id":Le,bind:this,afterCreate:this._positionContainer,afterUpdate:this._positionContainer},M?[Ue,Pe]:null)},t.prototype._watchActions=function(){var e=this,t=this.viewModel.allActions;this._handles.remove("actions"),t&&t.forEach(function(t){e._handles.add(f.watch(t,["active","className","disabled","id","title","image","visible"],function(){return e.scheduleRender()}),"actions")})},t.prototype._divideActions=function(e){var t=this.viewModel.allActions;return{inlineActions:t.slice(0,e),menuActions:t.slice(e)}},t.prototype._featureMenuOpenChanged=function(e){e?this._focusFirstFeature=!0:this._focusFeatureMenuButton=!0},t.prototype._actionsMenuOpenChanged=function(e){e?this._focusFirstAction=!0:this._focusActionsMenuButton=!0},t.prototype._setTitleFromFeatureWidget=function(e){this.selectedFeatureWidget&&(this.viewModel.title=e||"")},t.prototype._setContentFromFeatureWidget=function(){var e=this.selectedFeatureWidget;e&&(this.viewModel.content=e)},t.prototype._handleFeatureMenuKeyup=function(e){"Escape"===p.eventKey(e)&&(e.stopPropagation(),this._focusFeatureMenuButton=!0,this.featureMenuOpen=!1,this.scheduleRender())},t.prototype._handleActionMenuKeyup=function(e){"Escape"===p.eventKey(e)&&(e.stopPropagation(),this._focusActionsMenuButton=!0,this.actionsMenuOpen=!1,this.scheduleRender())},t.prototype._handleFeatureMenuItemKeyup=function(e){var t=p.eventKey(e),o=this._featureMenuNode,i=e.currentTarget,n=i["data-feature-index"];if(o){var r=o.querySelectorAll("li"),s=r.length;if("ArrowUp"===t){e.stopPropagation();var a=n-1,l=(a+s)%s;return void r[l].focus()}if("ArrowDown"===t){e.stopPropagation();var u=n+1,l=(u+s)%s;return void r[l].focus()}if("Home"===t){e.stopPropagation();return void r[0].focus()}if("End"===t){e.stopPropagation();return void r[r.length-1].focus()}}},t.prototype._handleActionMenuItemKeyup=function(e){var t=p.eventKey(e),o=this._actionsMenuNode,i=e.currentTarget,n=i["data-action-index"];if(o){var r=o.querySelectorAll("li"),s=r.length;if("ArrowUp"===t){e.stopPropagation();var a=n-1,l=(a+s)%s;return void r[l].focus()}if("ArrowDown"===t){e.stopPropagation();var u=n+1,l=(u+s)%s;return void r[l].focus()}if("Home"===t){e.stopPropagation();return void r[0].focus()}if("End"===t){e.stopPropagation();return void r[r.length-1].focus()}}},t.prototype._handleMainKeyup=function(e){var t=p.eventKey(e);"ArrowLeft"===t&&(e.stopPropagation(),this.previous()),"ArrowRight"===t&&(e.stopPropagation(),this.next())},t.prototype._spinnerEnabledChange=function(e){if(this._destroySpinner(),e){var t=this.get("viewModel.view");this._createSpinner(t)}},t.prototype._displaySpinner=function(){var e=this._spinner;if(e){var t=this.viewModel,o=t.location;if(t.waitingForResult)return void e.show({location:o});e.hide()}},t.prototype._getIconStyles=function(e){return{"background-image":e?"url("+e+")":""}},t.prototype._renderAction=function(e){var t,o,i=e.action,n=e.index,r=e.type,s=this.get("selectedFeature.attributes"),a=i.title,l=i.className,p=i.image,c=p||l?l:k.iconDefaultAction,d=a&&s?u.substitute(a,s):a,h=c&&s?u.substitute(c,s):c,f=p&&s?u.substitute(p,s):p,g=(t={},t[k.iconLoading]=i.active,t[k.rotating]=i.active,t[k.icon]=!!c,t[k.actionImage]=!i.active&&!!f,t);h&&(g[h]=!i.active);var _=(o={},o[k.action]="toggle"!==i.type,o[k.actionToggle]="toggle"===i.type,o[k.actionToggleOn]="toggle"===i.type&&i.value,o[k.buttonDisabled]=i.disabled,o),v=y.tsx("span",{key:"text",class:k.actionText},d),b=y.tsx("span",{key:"icon","aria-hidden":"true",class:this.classes(k.icon,g),styles:this._getIconStyles(f)}),w=[b,v],m="menu-item"===r?y.tsx("li",{key:i,role:"menuitem",tabIndex:0,title:d,"aria-label":d,class:this.classes(k.button,_),onkeyup:this._handleActionMenuItemKeyup,bind:this,"data-action-index":n,onclick:this._triggerAction,onkeydown:this._triggerAction},w):y.tsx("div",{key:i,role:"button",tabIndex:0,title:d,"aria-label":d,class:this.classes(k.button,_),onkeyup:this._handleActionMenuItemKeyup,bind:this,"data-action-index":n,onclick:this._triggerAction,onkeydown:this._triggerAction},w);return i.visible?m:null},t.prototype._addSelectedFeatureIndexHandle=function(){var e=this,t=f.watch(this,"viewModel.selectedFeatureIndex",function(t,o){return e._selectedFeatureIndexUpdated(t,o)});this._handles.add(t,"selected-index")},t.prototype._selectedFeatureIndexUpdated=function(e,t){this.featureCount&&e!==t&&-1!==e&&(this.actionsMenuOpen=!1,this.featureMenuOpen=!1)},t.prototype._updateFeatureWidget=function(){var e=this.featureWidgets,t=this.viewModel.selectedFeatureIndex,o=e[t]||null;this._set("selectedFeatureWidget",o)},t.prototype._destroyFeatureWidgets=function(){this.featureWidgets.forEach(function(e){return e.destroy()}),this._set("featureWidgets",[])},t.prototype._updateFeatureWidgets=function(){return s(this,void 0,void 0,function(){var e,t,o,i,s,a,l=this;return r(this,function(r){switch(r.label){case 0:return e=this,t=e.features,o=e.featureWidgets,t&&t.length?[4,M()]:(this._destroyFeatureWidgets(),[2]);case 1:return i=r.sent(),s=o.slice(0),a=[],t.forEach(function(e,t){if(e){var o=null;if(s.some(function(t,i){return t&&t.graphic===e&&(o=t,s.splice(i,1)),!!o}),o)a[t]=o;else{var r=new i({defaultPopupTemplateEnabled:l.defaultPopupTemplateEnabled,graphic:e,spatialReference:l.get("view.spatialReference"),map:l.get("view.map")});r.visibleElements=n({},r.visibleElements,{title:!1}),a[t]=r}}}),s.forEach(function(e){return e&&e.destroy()}),this._set("featureWidgets",a),[2]}})})},t.prototype._isScreenLocationWithinView=function(e,t){return e.x>-1&&e.y>-1&&e.x<=t.width&&e.y<=t.height},t.prototype._isOutsideView=function(e){var t=e.popupHeight,o=e.popupWidth,i=e.screenLocation,n=e.side,r=e.view;if(isNaN(o)||isNaN(t)||!r||!i)return!1;var s=r.padding;return"right"===n&&i.x+o/2>r.width-s.right||("left"===n&&i.x-o/2<s.left||("top"===n&&i.y-t<s.top||"bottom"===n&&i.y+t>r.height-s.bottom))},t.prototype._determineCurrentAlignment=function(){function e(e){return parseInt(e.replace(/[^-\d\.]/g,""),10)}var t=this,o=t._pointerOffsetInPx,i=t._containerNode,n=t._mainContainerNode,r=t.viewModel,s=r.screenLocation,a=r.view;if(!s||!a||!i)return"top-center";if(!this._isScreenLocationWithinView(s,a))return this._get("currentAlignment")||"top-center";var l=n?window.getComputedStyle(n,null):null,u=l?e(l.getPropertyValue("max-height")):0,p=l?e(l.getPropertyValue("height")):0,c=i.getBoundingClientRect(),d=c.height,h=c.width,f=h+o,g=Math.max(d,u,p)+o,_=this._isOutsideView({popupHeight:g,popupWidth:f,screenLocation:s,side:"right",view:a}),v=this._isOutsideView({popupHeight:g,popupWidth:f,screenLocation:s,side:"left",view:a}),b=this._isOutsideView({popupHeight:g,popupWidth:f,screenLocation:s,side:"top",view:a}),y=this._isOutsideView({popupHeight:g,popupWidth:f,screenLocation:s,side:"bottom",view:a});return v?b?"bottom-right":"top-right":_?b?"bottom-left":"top-left":b?y?"top-center":"bottom-center":"top-center"},t.prototype._getCurrentAlignment=function(){var e=this,t=e.alignment;return e.dockEnabled?null:"auto"===t?this._determineCurrentAlignment():"function"==typeof t?t.call(this):t},t.prototype._setCurrentAlignment=function(){this._set("currentAlignment",this._getCurrentAlignment())},t.prototype._setCurrentDockPosition=function(){this._set("currentDockPosition",this._getCurrentDockPosition())},t.prototype._getDockPosition=function(){var e=this.get("dockOptions.position");return"auto"===e?this._determineCurrentDockPosition():"function"==typeof e?e.call(this):e},t.prototype._getCurrentDockPosition=function(){return this.dockEnabled?this._getDockPosition():null},t.prototype._wouldDockTo=function(){return this.dockEnabled?null:this._getDockPosition()},t.prototype._renderFeatureMenuItemNode=function(e,t,o){var i,n=t===o,r=(i={},i[k.featureMenuSelected]=n,i),s=n?y.tsx("span",{key:m("feature-menu-selected-feature-"+o),title:l.selectedFeature,"aria-label":l.selectedFeature,class:k.iconCheckMark}):null,u=y.tsx("span",{innerHTML:e.title||a.untitled});return y.tsx("li",{role:"menuitem",tabIndex:-1,key:m("feature-menu-feature-"+o),class:this.classes(r,k.featureMenuItem),bind:this,"data-feature-index":t,onkeyup:this._handleFeatureMenuItemKeyup,onclick:this._selectFeature,onkeydown:this._selectFeature},y.tsx("span",{class:k.featureMenuTitle},u,s))},t.prototype._renderFeatureMenuNode=function(e,t,o){var i=this;return e.length>1?y.tsx("ol",{class:k.featureMenuList,id:o,bind:this,afterCreate:this._featureMenuNodeUpdated,afterUpdate:this._featureMenuNodeUpdated,onkeyup:this._handleFeatureMenuKeyup,role:"menu"},e.map(function(e,o){return i._renderFeatureMenuItemNode(e,o,t)})):null},t.prototype._determineCurrentDockPosition=function(){var e=this.get("viewModel.view"),t=w.isRTL()?"top-left":"top-right";if(!e)return t;var o=e.padding||{left:0,right:0,top:0,bottom:0},i=e.width-o.left-o.right,n=e.get("breakpoints");return n&&i<=n.xsmall?"bottom-center":t},t.prototype._renderContent=function(){var e=this.get("viewModel.content");return e?"string"==typeof e?y.tsx("div",{key:e,innerHTML:e}):y.isWidget(e)&&!e.destroyed?y.tsx("div",{key:e},e.render()):e instanceof HTMLElement?y.tsx("div",{key:e,bind:e,afterCreate:this._attachToNode}):y.isWidgetBase(e)?y.tsx("div",{key:e,bind:e.domNode,afterCreate:this._attachToNode}):void 0:null},t.prototype._attachToNode=function(e){var t=this;e.appendChild(t)},t.prototype._positionContainer=function(e){if(void 0===e&&(e=this._containerNode),e&&(this._containerNode=e),e){var t=this.viewModel.screenLocation,o=e.getBoundingClientRect().width,i=this._calculatePositionStyle(t,o);i&&(e.style.top=i.top,e.style.left=i.left,e.style.bottom=i.bottom,e.style.right=i.right)}},t.prototype._calculateFullWidth=function(e){var t=this,o=t.currentAlignment,i=t._pointerOffsetInPx;return"top-left"===o||"bottom-left"===o||"top-right"===o||"bottom-right"===o?e+i:e},t.prototype._calculateAlignmentPosition=function(e,t,o,i){var n=this,r=n.currentAlignment,s=n._pointerOffsetInPx,a=i/2,l=o.height-t,u=o.width-e,p=this.view.padding;return"bottom-center"===r?{top:t+s-p.top,left:e-a-p.left}:"top-left"===r?{bottom:l+s-p.bottom,right:u+s-p.right}:"bottom-left"===r?{top:t+s-p.top,right:u+s-p.right}:"top-right"===r?{bottom:l+s-p.bottom,left:e+s-p.left}:"bottom-right"===r?{top:t+s-p.top,left:e+s-p.left}:"top-center"===r?{bottom:l+s-p.bottom,left:e-a-p.left}:void 0},t.prototype._calculatePositionStyle=function(e,t){var o=this,i=o.dockEnabled,n=o.view;if(n){if(i)return{left:"",top:"",right:"",bottom:""};if(e&&t){var r=this._calculateFullWidth(t),s=this._calculateAlignmentPosition(e.x,e.y,n,r);if(s)return{top:void 0!==s.top?s.top+"px":"auto",left:void 0!==s.left?s.left+"px":"auto",bottom:void 0!==s.bottom?s.bottom+"px":"auto",right:void 0!==s.right?s.right+"px":"auto"}}}},t.prototype._viewChange=function(e,t){e&&t&&(this.close(),this.clear())},t.prototype._viewReadyChange=function(e,t){if(e){var o=this.get("viewModel.view");return void this._wireUpView(o)}t&&(this.close(),this.clear())},t.prototype._wireUpView=function(e){if(this._destroySpinner(),e){this.spinnerEnabled&&this._createSpinner(e),this._setDockEnabledForViewSize(this.dockOptions)}},t.prototype._dockingThresholdCrossed=function(e,t,o){var i=e[0],n=e[1],r=t[0],s=t[1],a=o.width,l=o.height;return i<=a&&r>a||i>a&&r<=a||n<=l&&s>l||n>l&&s<=l},t.prototype._updateDockEnabledForViewSize=function(e,t){if(e&&t){var o=this.get("viewModel.view.padding")||{left:0,right:0,top:0,bottom:0},i=o.left+o.right,n=o.top+o.bottom,r=[],s=[];r[0]=e[0]-i,r[1]=e[1]-n,s[0]=t[0]-i,s[1]=t[1]-n;var a=this.dockOptions,l=a.breakpoint;this._dockingThresholdCrossed(r,s,l)&&this._setDockEnabledForViewSize(a),this._setCurrentDockPosition()}},t.prototype._focusDockButtonNode=function(e){this._focusDockButton&&(this._focusDockButton=!1,e.focus())},t.prototype._mainContainerNodeUpdated=function(e){return this._mainContainerNode=e,this._focusContainer?(this._focusContainer=!1,void e.focus()):this._blurContainer?(this._blurContainer=!1,void e.blur()):void 0},t.prototype._featureMenuNodeUpdated=function(e){if(this._featureMenuNode=e,e&&this._focusFirstFeature){this._focusFirstFeature=!1;var t=e.querySelectorAll("li");if(t.length){t[0].focus()}}},t.prototype._actionsMenuNodeUpdated=function(e){if(this._actionsMenuNode=e,e&&this._focusFirstAction){this._focusFirstAction=!1;var t=e.querySelectorAll("li");if(t.length){t[0].focus()}}},t.prototype._focusFeatureMenuButtonNode=function(e){this._focusFeatureMenuButton&&(this._focusFeatureMenuButton=!1,e.focus())},t.prototype._focusActionsMenuButtonNode=function(e){this._focusActionsMenuButton&&(this._focusActionsMenuButton=!1,e.focus())},t.prototype._featureMenuViewportNodeUpdated=function(e){e&&(e.scrollTop=0)},t.prototype._toggleScreenLocationEnabled=function(){var e=this,t=e.dockEnabled,o=e.visible,i=e.viewModel;if(i){var n=o&&!t;i.screenLocationEnabled=n}},t.prototype._shouldDockAtCurrentViewSize=function(e){var t=e.breakpoint,o=this.get("viewModel.view.ui"),i=o.width,n=o.height;if(isNaN(i)||isNaN(n))return!1;var r=t.hasOwnProperty("width")&&i<=t.width,s=t.hasOwnProperty("height")&&n<=t.height;return r||s},t.prototype._setDockEnabledForViewSize=function(e){e.breakpoint&&(this.dockEnabled=this._shouldDockAtCurrentViewSize(e))},t.prototype._getPageText=function(e,t){return u.substitute(l.pageText,{index:t+1,total:e})},t.prototype._destroySpinner=function(){var e=this,t=e._spinner,o=e.view;t&&(o&&o.ui&&o.ui.remove(this._spinner,"popup-spinner"),t.destroy(),this._spinner=null)},t.prototype._createSpinner=function(e){e&&(this._spinner=new _({view:e}),e.ui.add(this._spinner,{key:"popup-spinner",position:"manual"}))},t.prototype._toggleCollapsed=function(){this.collapsed=!this.collapsed},t.prototype._close=function(){this.close(),this.view&&this.view.focus()},t.prototype._toggleDockEnabled=function(){this.dockEnabled=!this.dockEnabled,this._focusDockButton=!0,this.scheduleRender()},t.prototype._toggleFeatureMenu=function(){var e=!this.featureMenuOpen;this._featureMenuOpenChanged(e),this.actionsMenuOpen=!1,this.featureMenuOpen=e},t.prototype._toggleActionsMenu=function(){var e=!this.actionsMenuOpen;this._actionsMenuOpenChanged(e),this.featureMenuOpen=!1,this.actionsMenuOpen=e},t.prototype._triggerAction=function(e){var t=e.currentTarget,o=t["data-action-index"],i=this.viewModel.allActions.getItemAt(o);i&&"toggle"===i.type&&(i.value=!i.value),this.actionsMenuOpen=!1,this.viewModel.triggerAction(o)},t.prototype._selectFeature=function(e){var t=e.currentTarget,o=t["data-feature-index"];isNaN(o)||(this.viewModel.selectedFeatureIndex=o),this.featureMenuOpen=!1,this._focusFeatureMenuButton=!0,this.scheduleRender()},t.prototype._next=function(){this.next()},t.prototype._previous=function(){this.previous()},i([g.aliasOf("viewModel.actions"),y.renderable()],t.prototype,"actions",void 0),i([g.property({dependsOn:["viewModel.visible"]}),y.renderable()],t.prototype,"actionsMenuOpen",null),i([g.property()],t.prototype,"alignment",void 0),i([g.aliasOf("viewModel.autoCloseEnabled")],t.prototype,"autoCloseEnabled",void 0),i([g.aliasOf("viewModel.autoOpenEnabled")],t.prototype,"autoOpenEnabled",void 0),i([g.aliasOf("viewModel.defaultPopupTemplateEnabled")],t.prototype,"defaultPopupTemplateEnabled",void 0),i([g.aliasOf("viewModel.content"),y.renderable()],t.prototype,"content",void 0),i([g.property(),y.renderable()],t.prototype,"collapsed",void 0),i([g.property(),y.renderable()],t.prototype,"collapseEnabled",void 0),i([g.property({readOnly:!0,dependsOn:["dockEnabled","alignment"]}),y.renderable()],t.prototype,"currentAlignment",null),i([g.property({readOnly:!0,dependsOn:["viewModel.view.ready","dockEnabled","dockOptions"]}),y.renderable()],t.prototype,"currentDockPosition",null),i([g.property(),y.renderable()],t.prototype,"dockOptions",null),i([g.property(),y.renderable()],t.prototype,"dockEnabled",void 0),i([g.aliasOf("viewModel.featureCount"),y.renderable()],t.prototype,"featureCount",void 0),i([g.property(),y.renderable()],t.prototype,"featureMenuOpen",void 0),i([g.aliasOf("viewModel.features"),y.renderable()],t.prototype,"features",void 0),
i([g.property(),y.renderable()],t.prototype,"featureNavigationEnabled",void 0),i([g.aliasOf("viewModel.goToOverride")],t.prototype,"goToOverride",void 0),i([g.aliasOf("viewModel.highlightEnabled")],t.prototype,"highlightEnabled",void 0),i([g.aliasOf("viewModel.location"),y.renderable()],t.prototype,"location",void 0),i([g.property({readOnly:!0}),y.renderable()],t.prototype,"featureWidgets",void 0),i([g.aliasOf("viewModel.promises")],t.prototype,"promises",void 0),i([g.aliasOf("viewModel.selectedFeature"),y.renderable()],t.prototype,"selectedFeature",void 0),i([g.aliasOf("viewModel.selectedFeatureIndex"),y.renderable()],t.prototype,"selectedFeatureIndex",void 0),i([g.property({readOnly:!0}),y.renderable()],t.prototype,"selectedFeatureWidget",void 0),i([g.property()],t.prototype,"spinnerEnabled",void 0),i([g.aliasOf("viewModel.title"),y.renderable()],t.prototype,"title",void 0),i([g.aliasOf("viewModel.updateLocationEnabled")],t.prototype,"updateLocationEnabled",void 0),i([g.aliasOf("viewModel.view")],t.prototype,"view",void 0),i([g.property({type:b}),y.renderable(["viewModel.view.widthBreakpoint","viewModel.allActions","viewModel.screenLocation","viewModel.screenLocationEnabled","viewModel.state","viewModel.pendingPromisesCount","viewModel.promiseCount","viewModel.waitingForResult"]),y.vmEvent(["triggerAction","trigger-action"])],t.prototype,"viewModel",void 0),i([g.aliasOf("viewModel.visible"),y.renderable()],t.prototype,"visible",void 0),i([g.aliasOf("viewModel.clear")],t.prototype,"clear",null),i([g.aliasOf("viewModel.next")],t.prototype,"next",null),i([g.aliasOf("viewModel.previous")],t.prototype,"previous",null),i([g.aliasOf("viewModel.triggerAction")],t.prototype,"triggerAction",null),i([y.accessibleHandler()],t.prototype,"_toggleCollapsed",null),i([y.accessibleHandler()],t.prototype,"_close",null),i([y.accessibleHandler()],t.prototype,"_toggleDockEnabled",null),i([y.accessibleHandler()],t.prototype,"_toggleFeatureMenu",null),i([y.accessibleHandler()],t.prototype,"_toggleActionsMenu",null),i([y.accessibleHandler()],t.prototype,"_triggerAction",null),i([y.accessibleHandler()],t.prototype,"_selectFeature",null),i([y.accessibleHandler()],t.prototype,"_next",null),i([y.accessibleHandler()],t.prototype,"_previous",null),t=i([g.subclass("esri.widgets.Popup")],t)}(g.declared(v))});