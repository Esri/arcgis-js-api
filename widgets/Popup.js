// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../intl","../core/Collection","../core/deprecate","../core/events","../core/Handles","../core/Logger","../core/throttle","../core/watchUtils","../core/accessorSupport/decorators","./Feature","./Spinner","./Widget","./Feature/support/FeatureContentMixin","./Popup/PopupViewModel","./support/widget","./support/widgetUtils","@dojo/framework/shim/Promise"],(function(e,t,o,i,n,r,s,a,l,u,d,p,c,h,_,f,v,g,y){"use strict";var b="esri-icon-left-triangle-arrow",m="esri-icon-right-triangle-arrow",w="esri-icon-maximize",M="esri-icon-dock-bottom",k="esri-icon-dock-left",A="esri-icon-dock-right",x="esri-icon-close",C="esri-icon-minimize",O="esri-icon-check-mark",F="esri-icon-loading-indicator",P="esri-icon-default-action",E="esri-icon-handle-horizontal",I="esri-rotating",N="esri-popup",B="esri-widget",D="esri-popup__main-container",V="esri-popup__loading-container",S="esri-popup--is-collapsible",T="esri-popup--is-collapsed",L="esri-popup--shadow",U="esri-popup--is-docked",W="esri-popup--is-docked-top-left",H="esri-popup--is-docked-top-center",R="esri-popup--is-docked-top-right",j="esri-popup--is-docked-bottom-left",K="esri-popup--is-docked-bottom-center",z="esri-popup--is-docked-bottom-right",q="esri-popup--aligned-top-center",G="esri-popup--aligned-bottom-center",J="esri-popup--aligned-top-left",Q="esri-popup--aligned-bottom-left",X="esri-popup--aligned-top-right",Y="esri-popup--aligned-bottom-right",Z="esri-popup--feature-menu-open",$="esri-popup--actions-menu-open",ee="esri-popup--feature-updated",te="esri-popup__header",oe="esri-popup__header-buttons",ie="esri-popup__header-container",ne="esri-popup__header-container--button",re="esri-popup__header-title",se="esri-popup__content",ae="esri-popup__footer",le="esri-popup__footer--has-pagination",ue="esri-popup__footer--has-actions",de="esri-popup__footer--has-actions-menu",pe="esri-popup__button",ce="esri-popup__button--disabled",he="esri-popup__button--dock",_e="esri-popup__icon",fe="esri-popup__icon--dock-icon",ve="esri-popup__inline-actions-container",ge="esri-popup__actions-menu-button",ye="esri-popup__actions",be="esri-popup__action",me="esri-popup__action-image",we="esri-popup__action-text",Me="esri-popup__action-toggle",ke="esri-popup__action-toggle--on",Ae="esri-popup__pointer",xe="esri-popup__pointer-direction",Ce="esri-popup__navigation",Oe="esri-popup__pagination-previous",Fe="esri-popup__pagination-next",Pe="esri-popup__pagination-previous-icon",Ee="esri-popup__pagination-previous-icon--rtl",Ie="esri-popup__pagination-next-icon",Ne="esri-popup__pagination-next-icon--rtl",Be="esri-popup__feature-menu",De="esri-popup__feature-menu-list",Ve="esri-popup__feature-menu-item",Se="esri-popup__feature-menu-viewport",Te="esri-popup__feature-menu-header",Le="esri-popup__feature-menu-item--selected",Ue="esri-popup__feature-menu-button",We="esri-popup__feature-menu-title",He={buttonEnabled:!0,position:"auto",breakpoint:{width:544}};function Re(e,t){return void 0===t?"esri-popup__"+e:"esri-popup__"+e+"-"+t}var je=l.getLogger("esri.widgets.Popup"),Ke={closeButton:!0,featureNavigation:!0};return function(e){function t(t,i){var n=e.call(this,t,i)||this;return n._blurContainer=!1,n._containerNode=null,n._mainContainerNode=null,n._featureMenuNode=null,n._actionsMenuNode=null,n._focusContainer=!1,n._focusDockButton=!1,n._focusFeatureMenuButton=!1,n._focusActionsMenuButton=!1,n._focusFirstFeature=!1,n._focusFirstAction=!1,n._handles=new a,n._pointerOffsetInPx=16,n._spinner=null,n._feature=null,n._displaySpinnerThrottled=u.throttle((function(){return n._displaySpinner()}),0),n.actions=null,n.alignment="auto",n.autoCloseEnabled=null,n.autoOpenEnabled=null,n.defaultPopupTemplateEnabled=null,n.content=null,n.collapsed=!1,n.collapseEnabled=!0,n.dockEnabled=!1,n.featureCount=null,n.featureMenuOpen=!1,n.features=null,n.goToOverride=null,n.highlightEnabled=null,n.location=null,n.label=void 0,n.maxInlineActions=3,n.messages=null,n.messagesCommon=null,n.promises=null,n.selectedFeature=null,n.selectedFeatureIndex=null,n.spinnerEnabled=!0,n.title=null,n.updateLocationEnabled=null,n.view=null,n.viewModel=new v,n.visible=null,n.visibleElements=o.__assign({},Ke),n._addSelectedFeatureIndexHandle(),n.own([d.watch(n,"viewModel.screenLocation",(function(){return n._positionContainer()})),d.watch(n,["viewModel.active","dockEnabled"],(function(){return n._toggleScreenLocationEnabled()})),d.watch(n,"viewModel.screenLocation",(function(e,t){!!e!=!!t&&n.reposition()})),d.watch(n,["viewModel.view.padding","viewModel.view.size","viewModel.active","viewModel.location","alignment"],(function(){return n.reposition()})),d.watch(n,"spinnerEnabled",(function(e){return n._spinnerEnabledChange(e)})),d.watch(n,"viewModel.view.size",(function(e,t){return n._updateDockEnabledForViewSize(e,t)})),d.watch(n,"viewModel.view",(function(e,t){return n._viewChange(e,t)})),d.watch(n,"viewModel.view.ready",(function(e,t){return n._viewReadyChange(e,t)})),d.watch(n,["viewModel.waitingForResult","viewModel.location"],(function(){n._hideSpinner(),n._displaySpinnerThrottled()})),d.watch(n,"selectedFeatureWidget.viewModel.title",(function(e){return n._setTitleFromFeatureWidget(e)})),d.watch(n,["selectedFeatureWidget.viewModel.content","selectedFeatureWidget.viewModel.waitingForContent"],(function(){return n._setContentFromFeatureWidget()})),d.whenFalse(n,"collapsed",(function(){var e,t;"xsmall"===(null===(t=null===(e=n.viewModel)||void 0===e?void 0:e.view)||void 0===t?void 0:t.widthBreakpoint)&&n.viewModel.active&&n.collapseEnabled&&n.viewModel.centerAtLocation()})),d.on(n,"viewModel.allActions","change",(function(){return n._watchActions()})),d.init(n,"viewModel.allActions",(function(){return n._watchActions()}))]),n}return o.__extends(t,e),t.prototype.destroy=function(){this._destroySelectedFeatureWidget(),this._destroySpinner(),this._handles&&this._handles.destroy(),this._handles=null},Object.defineProperty(t.prototype,"actionsMenuId",{get:function(){return this.id+"-actions-menu"},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"actionsMenuButtonId",{get:function(){return this.id+"-actions-menu-button"},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"featureMenuId",{get:function(){return this.id+"-feature-menu"},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"titleId",{get:function(){return this.id+"-popup-title"},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"contentId",{get:function(){return this.id+"-popup-content"},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"hasContent",{get:function(){var e,t,o,i,n;return!!(this.selectedFeatureWidget?(null===(t=null===(e=this.selectedFeatureWidget)||void 0===e?void 0:e.viewModel)||void 0===t?void 0:t.waitingForContent)||(null===(i=null===(o=this.selectedFeatureWidget)||void 0===o?void 0:o.viewModel)||void 0===i?void 0:i.content):null===(n=this.viewModel)||void 0===n?void 0:n.content)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"featureNavigationVisible",{get:function(){return this.viewModel.active&&this.viewModel.featureCount>1&&this.visibleElements.featureNavigation},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"collapsible",{get:function(){return!!(this.collapseEnabled&&this.viewModel.title&&this.hasContent)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"featureMenuVisible",{get:function(){return this.featureNavigationVisible&&this.featureMenuOpen},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"contentCollapsed",{get:function(){return this.collapsible&&!this.featureMenuVisible&&this.collapsed},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"dividedActions",{get:function(){return this._divideActions()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"actionsMenuOpen",{get:function(){return!!this.viewModel.active&&this._get("actionsMenuOpen")},set:function(e){this._set("actionsMenuOpen",!!e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"currentAlignment",{get:function(){return this._getCurrentAlignment()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"currentDockPosition",{get:function(){return this._getCurrentDockPosition()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"dockOptions",{get:function(){return this._get("dockOptions")||He},set:function(e){var t=o.__assign({},He),i=this.get("viewModel.view.breakpoints"),n={};i&&(n.width=i.xsmall,n.height=i.xsmall);var r=o.__assign(o.__assign({},t),e),s=o.__assign(o.__assign({},t.breakpoint),n),a=r.breakpoint;!0===a?r.breakpoint=s:"object"==typeof a&&(r.breakpoint=o.__assign(o.__assign({},s),a)),this._set("dockOptions",r),this._setCurrentDockPosition(),this.reposition()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"featureNavigationEnabled",{set:function(e){r.deprecatedProperty(je,"featureNavigationEnabled",{replacement:"visibleElements.featureNavigation",version:"4.15"}),this.visibleElements=o.__assign(o.__assign({},this.visibleElements),{featureNavigation:e})},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"selectedFeatureWidget",{get:function(){var e=this._feature,t=this.visibleElements,i=this.viewModel.selectedFeatureViewModel,n=o.__assign(o.__assign({},t),{title:!1});return i?(e?(e.viewModel=i,e.visibleElements=n):this._feature=new c({viewModel:i,visibleElements:n}),this._feature):null},enumerable:!1,configurable:!0}),t.prototype.castVisibleElements=function(e){return o.__assign(o.__assign({},Ke),e)},t.prototype.blur=function(){this.viewModel.active||je.warn("Popup can only be blurred when currently active."),this._blurContainer=!0,this.scheduleRender()},t.prototype.clear=function(){this.viewModel.clear()},t.prototype.close=function(){this.visible=!1},t.prototype.fetchFeatures=function(e,t){return this.viewModel.fetchFeatures(e,t)},t.prototype.focus=function(){this.viewModel.active||je.warn("Popup can only be focused when currently active."),this._focusContainer=!0,this.scheduleRender()},t.prototype.next=function(){return this.viewModel.next()},t.prototype.open=function(e){var t,o;this._handles.remove("selected-index");var i=!!e&&!!e.featureMenuOpen,n=!!e&&!!e.actionsMenuOpen,r={collapsed:!!e&&!!e.collapsed,actionsMenuOpen:n,featureMenuOpen:i};"xsmall"===(null===(o=null===(t=this.viewModel)||void 0===t?void 0:t.view)||void 0===o?void 0:o.widthBreakpoint)&&(r.collapsed=!0),this.set(r),this.viewModel.open(e),this._addSelectedFeatureIndexHandle()},t.prototype.previous=function(){return this.viewModel.previous()},t.prototype.reposition=function(){this.renderNow(),this._positionContainer(),this._setCurrentAlignment()},t.prototype.triggerAction=function(e){this.viewModel.triggerAction(e)},t.prototype.render=function(){var e,t,o,i,n,r=this,s=r.actionsMenuOpen,a=r.dockEnabled,l=r.featureMenuVisible,u=r.dividedActions,d=r.currentAlignment,p=r.currentDockPosition,c=this.viewModel.active,h=u.menuActions,_=c&&h.length>1&&s,f=c&&a,v=c&&!a,y=null===(o=null===(t=this.selectedFeature)||void 0===t?void 0:t.layer)||void 0===o?void 0:o.title,b=null===(n=null===(i=this.selectedFeature)||void 0===i?void 0:i.layer)||void 0===n?void 0:n.id,m=((e={})[q]="top-center"===d,e[G]="bottom-center"===d,e[J]="top-left"===d,e[Q]="bottom-left"===d,e[X]="top-right"===d,e[Y]="bottom-right"===d,e[U]=f,e[L]=v,e[W]="top-left"===p,e[H]="top-center"===p,e[R]="top-right"===p,e[j]="bottom-left"===p,e[K]="bottom-center"===p,e[z]="bottom-right"===p,e[Z]=l,e[$]=_,e);return g.tsx("div",{class:this.classes(N,m),role:"presentation","data-layer-title":y,"data-layer-id":b,bind:this,afterCreate:this._positionContainer,afterUpdate:this._positionContainer},c?[this.renderMainContainer(),this.renderPointer()]:null)},t.prototype.renderLoadingIcon=function(){return g.tsx("span",{"aria-hidden":"true",class:this.classes(_e,F,I)})},t.prototype.renderNavigationLoading=function(){var e=this.messagesCommon;return this.viewModel.pendingPromisesCount?g.tsx("div",{key:Re("loading-container"),role:"presentation",class:V,"aria-label":e.loading,title:e.loading},this.renderLoadingIcon()):null},t.prototype.renderPreviousIcon=function(){var e,t=y.isRTL(),o=((e={})[m]=t,e[Ee]=t,e[b]=!t,e[Pe]=!t,e);return g.tsx("span",{"aria-hidden":"true",class:this.classes(_e,o)})},t.prototype.renderPreviousButton=function(){var e=this.messages;return g.tsx("div",{role:"button",tabIndex:0,bind:this,onclick:this._previous,onkeydown:this._previous,class:this.classes(pe,Oe),"aria-label":e.previous,title:e.previous},this.renderPreviousIcon())},t.prototype.renderNextIcon=function(){var e,t=y.isRTL(),o=((e={})[b]=t,e[Ne]=t,e[m]=!t,e[Ie]=!t,e);return g.tsx("span",{"aria-hidden":"true",class:this.classes(_e,o)})},t.prototype.renderNextButton=function(){var e=this.messages;return g.tsx("div",{role:"button",tabIndex:0,bind:this,onclick:this._next,onkeydown:this._next,class:this.classes(pe,Fe),"aria-label":e.next,title:e.next},this.renderNextIcon())},t.prototype.renderFeatureMenuButton=function(){var e=this.featureMenuOpen,t=this.featureMenuId,o=this.messagesCommon,i=this.viewModel,n=i.featureCount,r=i.selectedFeatureIndex;return g.tsx("div",{role:"button",tabIndex:0,bind:this,onclick:this._toggleFeatureMenu,onkeydown:this._toggleFeatureMenu,afterCreate:this._focusFeatureMenuButtonNode,afterUpdate:this._focusFeatureMenuButtonNode,class:this.classes(pe,Ue),"aria-haspopup":"true","aria-controls":t,"aria-expanded":e,"aria-label":o.menu,title:o.menu},this._getPageText(n,r))},t.prototype.renderNavigationButtons=function(){return this.featureNavigationVisible?[this.renderPreviousButton(),this.renderNavigationLoading()||this.renderFeatureMenuButton(),this.renderNextButton()]:null},t.prototype.renderDockIcon=function(){var e,t=this.dockEnabled,o=this._wouldDockTo(),i=((e={})[C]=t,e[fe]=!t,e[A]=!t&&("top-right"===o||"bottom-right"===o),e[k]=!t&&("top-left"===o||"bottom-left"===o),e[w]=!t&&"top-center"===o,e[M]=!t&&"bottom-center"===o,e);return g.tsx("span",{"aria-hidden":"true",class:this.classes(i,_e)})},t.prototype.renderDockButton=function(){var e,t,o,i=this.dockEnabled,n=this.messages,r=null===(t=null===(e=this.viewModel)||void 0===e?void 0:e.view)||void 0===t?void 0:t.widthBreakpoint,s=i?n.undock:n.dock;return"xsmall"!==r&&(null===(o=this.dockOptions)||void 0===o?void 0:o.buttonEnabled)?g.tsx("div",{role:"button","aria-label":s,title:s,tabIndex:0,bind:this,onclick:this._toggleDockEnabled,onkeydown:this._toggleDockEnabled,afterCreate:this._focusDockButtonNode,afterUpdate:this._focusDockButtonNode,class:this.classes(pe,he)},this.renderDockIcon()):null},t.prototype.renderTitle=function(){var e,t=this.viewModel.title,o=this.titleId,i=this.collapsible,n=this.contentCollapsed,r=this.messagesCommon,s=i?n?r.expand:r.collapse:"",a=((e={})[ne]=i,e);return t?g.tsx("div",{class:this.classes(ie,a),key:t,enterAnimation:this._createFeatureUpdatedAnimation(),id:o,role:i?"button":"heading","aria-label":s,title:s,tabIndex:i?0:-1,bind:this,onclick:this._toggleCollapsed,onkeydown:this._toggleCollapsed},g.tsx("h2",{class:re,innerHTML:t})):null},t.prototype.renderCloseIcon=function(){return g.tsx("span",{"aria-hidden":"true",class:this.classes(_e,x)})},t.prototype.renderCloseButton=function(){var e=this.visibleElements,t=this.messagesCommon;return e.closeButton?g.tsx("div",{role:"button",tabIndex:0,bind:this,onclick:this._close,onkeydown:this._close,class:pe,"aria-label":t.close,title:t.close},this.renderCloseIcon()):null},t.prototype.renderHeader=function(){return g.tsx("header",{class:te},this.renderTitle(),g.tsx("div",{class:oe},this.renderDockButton(),this.renderCloseButton()))},t.prototype.renderContentContainer=function(){var e=this.contentId,t=this.hasContent,o=this.contentCollapsed,i=this.viewModel.content;return t&&!o?g.tsx("article",{key:i,enterAnimation:this._createFeatureUpdatedAnimation(),id:e,class:se},this.renderContent()):null},t.prototype.renderActionsMenuButton=function(){var e=this,t=e.actionsMenuId,o=e.actionsMenuButtonId,i=e.actionsMenuOpen,n=e.dividedActions,r=e.messagesCommon,s=i?r.close:r.open;return n.menuActions.length?g.tsx("div",{key:Re("actions-menu-button"),class:this.classes(pe,ge),role:"button",id:o,"aria-haspopup":"true","aria-controls":i?t:null,tabIndex:0,bind:this,onclick:this._toggleActionsMenu,onkeydown:this._toggleActionsMenu,afterCreate:this._focusActionsMenuButtonNode,afterUpdate:this._focusActionsMenuButtonNode,"aria-label":s,title:s},g.tsx("span",{"aria-hidden":"true",class:E})):null},t.prototype.renderMenuActions=function(){var e=this,t=this.actionsMenuId,o=this.actionsMenuButtonId,i=this.actionsMenuOpen,n=this.dividedActions,r=n.menuActions,s=n.inlineActions;return r.length&&i?g.tsx("ul",{id:t,role:"menu","aria-labelledby":o,key:Re("actions"),class:ye,bind:this,onkeyup:this._handleActionMenuKeyup,afterCreate:this._actionsMenuNodeUpdated,afterUpdate:this._actionsMenuNodeUpdated},r.toArray().map((function(t,o){return e.renderAction({action:t,index:o+s.length,type:"menu-item"})}))):null},t.prototype.renderInlineActions=function(){var e=this,t=this.dividedActions.inlineActions;return!!t.length&&t.toArray().map((function(t,o){return e.renderAction({action:t,index:o,type:"inline"})}))},t.prototype.renderInlineActionsContainer=function(){var e=this.dividedActions,t=e.inlineActions,o=e.menuActions,i=!!t.length,n=!!o.length;return i||n?g.tsx("div",{key:"inline-actions-container","data-inline-actions":i.toString(),"data-menu-actions":n.toString(),class:ve},this.renderInlineActions(),this.renderActionsMenuButton(),this.renderMenuActions()):null},t.prototype.renderNavigation=function(){return this.featureNavigationVisible?g.tsx("section",{key:Re("navigation"),class:this.classes(Ce)},this.renderNavigationButtons()):null},t.prototype.renderFooter=function(){var e,t=this.featureNavigationVisible,o=this.dividedActions,i=o.inlineActions,n=o.menuActions,r=!!i.length,s=!!n.length,a=((e={})[le]=t,e[ue]=r,e[de]=s,e);return t||r?g.tsx("div",{key:Re("feature-buttons"),class:this.classes(ae,a)},this.renderInlineActionsContainer(),this.renderNavigation()):null},t.prototype.renderFeatureMenuContainer=function(){var e=this.messages,t=this.viewModel.featureViewModels,o=i.substitute(e.selectedFeatures,{total:t.length});return g.tsx("section",{key:Re("menu"),class:Be},g.tsx("h2",{class:Te},o),g.tsx("nav",{class:Se,afterCreate:this._featureMenuViewportNodeUpdated,afterUpdate:this._featureMenuViewportNodeUpdated},this.renderFeatureMenu()))},t.prototype.renderPointer=function(){return this.dockEnabled?null:g.tsx("div",{key:Re("pointer"),class:Ae,role:"presentation"},g.tsx("div",{class:this.classes(xe,L)}))},t.prototype.renderMainContainer=function(){var e,t=this,o=t.dockEnabled,i=t.currentAlignment,n=t.currentDockPosition,r=t.titleId,s=t.contentId,a=t.collapsible,l=t.hasContent,u=t.contentCollapsed,d=this.viewModel.title,p="bottom-left"===i||"bottom-center"===i||"bottom-right"===i||"top-left"===n||"top-center"===n||"top-right"===n,c="top-left"===i||"top-center"===i||"top-right"===i||"bottom-left"===n||"bottom-center"===n||"bottom-right"===n,h=((e={})[L]=o,e[S]=a,e[T]=u,e);return g.tsx("div",{class:this.classes(D,B,h),tabIndex:-1,role:"dialog","aria-labelledby":d?r:"","aria-describedby":l&&!u?s:"",bind:this,onkeyup:this._handleMainKeyup,afterCreate:this._mainContainerNodeUpdated,afterUpdate:this._mainContainerNodeUpdated},p?this.renderFooter():null,p?this.renderFeatureMenuContainer():null,this.renderHeader(),this.renderContentContainer(),c?this.renderFooter():null,c?this.renderFeatureMenuContainer():null)},t.prototype.renderContent=function(){var e,t=null===(e=this.viewModel)||void 0===e?void 0:e.content;return t?"string"==typeof t?g.tsx("div",{key:t,innerHTML:t}):this.renderNodeContent(t):null},t.prototype.renderActionText=function(e){return g.tsx("span",{key:"text",class:we},e)},t.prototype.renderActionIcon=function(e){var t,o=this._getActionClass(e),i=this._getActionImage(e),n=((t={})[F]=e.active,t[I]=e.active,t[_e]=!!o,t[me]=!e.active&&!!i,t);return o&&(n[o]=!e.active),g.tsx("span",{key:"icon","aria-hidden":"true",class:this.classes(_e,n),styles:this._getIconStyles(i)})},t.prototype.renderAction=function(e){var t,o=e.action,i=e.index,n=e.type,r=this._getActionTitle(o),s=((t={})[be]="toggle"!==o.type,t[Me]="toggle"===o.type,t[ke]="toggle"===o.type&&o.value,t[ce]=o.disabled,t),a=[this.renderActionIcon(o),this.renderActionText(r)],l="menu-item"===n?g.tsx("li",{key:o,role:"menuitem",tabIndex:0,title:r,"aria-label":r,class:this.classes(pe,s),onkeyup:this._handleActionMenuItemKeyup,bind:this,"data-action-index":i,onclick:this._triggerAction,onkeydown:this._triggerAction},a):g.tsx("div",{key:o,role:"button",tabIndex:0,title:r,"aria-label":r,class:this.classes(pe,s),onkeyup:this._handleActionMenuItemKeyup,bind:this,"data-action-index":i,onclick:this._triggerAction,onkeydown:this._triggerAction},a);return o.visible?l:null},t.prototype.renderFeatureMenuItem=function(e,t){var o,i=this.messages,n=this.messagesCommon,r=this.viewModel,s=r.selectedFeatureIndex,a=e===r.selectedFeatureViewModel,l=((o={})[Le]=a,o),u=a?g.tsx("span",{key:Re("feature-menu-selected-feature-"+s),title:i.selectedFeature,"aria-label":i.selectedFeature,class:O}):null,d=g.tsx("span",{innerHTML:e.title||n.untitled});return g.tsx("li",{role:"menuitem",tabIndex:-1,key:Re("feature-menu-feature-"+s),class:this.classes(l,Ve),bind:this,"data-feature-index":t,onkeyup:this._handleFeatureMenuItemKeyup,onclick:this._selectFeature,onkeydown:this._selectFeature},g.tsx("span",{class:We},d,u))},t.prototype.renderFeatureMenu=function(){var e=this,t=this.featureMenuId,o=this.viewModel.featureViewModels;return o.length>1?g.tsx("ol",{class:De,id:t,bind:this,afterCreate:this._featureMenuNodeUpdated,afterUpdate:this._featureMenuNodeUpdated,onkeyup:this._handleFeatureMenuKeyup,role:"menu"},o.map((function(t,o){return e.renderFeatureMenuItem(t,o)}))):null},t.prototype._getActionTitle=function(e){var t=this.messages,o=this.selectedFeature,n=this.messagesCommon,r=e.id,s=null==o?void 0:o.attributes,a="zoom-to-feature"===r?i.substitute(e.title,{messages:t}):"remove-selected-feature"===r?i.substitute(e.title,{messages:n}):e.title;return a&&s?i.substitute(a,s):a},t.prototype._getActionClass=function(e){var t=this.selectedFeature,o=null==t?void 0:t.attributes,n=e.className,r=e.image||n?n:P;return r&&o?i.substitute(r,o):r},t.prototype._getActionImage=function(e){var t=this.selectedFeature,o=null==t?void 0:t.attributes,n=e.image;return n&&o?i.substitute(n,o):n},t.prototype._createFeatureUpdatedAnimation=function(){return y.cssTransition("enter",ee)},t.prototype._getInlineActionCount=function(){var e=this.maxInlineActions,t=this.featureNavigationVisible;if("number"!=typeof e)return null;var o=Math.round(e);return Math.max(t?o-1:o,0)},t.prototype._watchActions=function(){var e=this,t=this.viewModel.allActions;this.notifyChange("dividedActions");this._handles.remove("actions"),t&&t.forEach((function(t){e._handles.add(d.watch(t,["active","className","disabled","id","title","image","visible"],(function(){return e.scheduleRender()})),"actions")}))},t.prototype._divideActions=function(){var e=this.viewModel.allActions,t=this._getInlineActionCount(),o=null===t,i=0===t;return{inlineActions:o?e.slice(0):i?new n:e.slice(0,t),menuActions:o?new n:i?e.slice(0):e.slice(t)}},t.prototype._featureMenuOpenChanged=function(e){e?this._focusFirstFeature=!0:this._focusFeatureMenuButton=!0},t.prototype._actionsMenuOpenChanged=function(e){e?this._focusFirstAction=!0:this._focusActionsMenuButton=!0},t.prototype._setTitleFromFeatureWidget=function(e){this.selectedFeatureWidget&&(this.viewModel.title=e||"")},t.prototype._setContentFromFeatureWidget=function(){var e=this.selectedFeatureWidget;e&&(this.viewModel.content=e)},t.prototype._handleFeatureMenuKeyup=function(e){"Escape"===s.eventKey(e)&&(e.stopPropagation(),this._focusFeatureMenuButton=!0,this.featureMenuOpen=!1,this.scheduleRender())},t.prototype._handleActionMenuKeyup=function(e){"Escape"===s.eventKey(e)&&(e.stopPropagation(),this._focusActionsMenuButton=!0,this.actionsMenuOpen=!1,this.scheduleRender())},t.prototype._handleFeatureMenuItemKeyup=function(e){var t=s.eventKey(e),o=this._featureMenuNode,i=e.currentTarget["data-feature-index"];if(o){var n=o.querySelectorAll("li"),r=n.length;if("ArrowUp"===t)return e.stopPropagation(),void n[(i-1+r)%r].focus();if("ArrowDown"===t)return e.stopPropagation(),void n[(i+1+r)%r].focus();if("Home"===t)return e.stopPropagation(),void n[0].focus();if("End"===t)return e.stopPropagation(),void n[n.length-1].focus()}},t.prototype._handleActionMenuItemKeyup=function(e){var t=s.eventKey(e),o=this._actionsMenuNode,i=e.currentTarget["data-action-index"];if(o){var n=o.querySelectorAll("li"),r=n.length;if("ArrowUp"===t)return e.stopPropagation(),void n[(i-1+r)%r].focus();if("ArrowDown"===t)return e.stopPropagation(),void n[(i+1+r)%r].focus();if("Home"===t)return e.stopPropagation(),void n[0].focus();if("End"===t)return e.stopPropagation(),void n[n.length-1].focus()}},t.prototype._handleMainKeyup=function(e){var t=s.eventKey(e);"ArrowLeft"===t&&(e.stopPropagation(),this.previous()),"ArrowRight"===t&&(e.stopPropagation(),this.next())},t.prototype._spinnerEnabledChange=function(e){if(this._destroySpinner(),e){var t=this.get("viewModel.view");this._createSpinner(t)}},t.prototype._hideSpinner=function(){var e=this._spinner;e&&(e.location=null,e.hide())},t.prototype._displaySpinner=function(){var e=this._spinner;if(e){var t=this.viewModel,o=t.location;t.waitingForResult?e.show({location:o}):e.hide()}},t.prototype._getIconStyles=function(e){return{"background-image":e?"url("+e+")":""}},t.prototype._addSelectedFeatureIndexHandle=function(){var e=this,t=d.watch(this,"viewModel.selectedFeatureIndex",(function(t,o){return e._selectedFeatureIndexUpdated(t,o)}));this._handles.add(t,"selected-index")},t.prototype._selectedFeatureIndexUpdated=function(e,t){this.featureCount&&e!==t&&-1!==e&&(this.actionsMenuOpen=!1,this.featureMenuOpen=!1)},t.prototype._destroySelectedFeatureWidget=function(){var e=this._feature;e&&(e.viewModel=null,e&&!e.destroyed&&e.destroy()),this._feature=null},t.prototype._isScreenLocationWithinView=function(e,t){return e.x>-1&&e.y>-1&&e.x<=t.width&&e.y<=t.height},t.prototype._isOutsideView=function(e){var t=e.popupHeight,o=e.popupWidth,i=e.screenLocation,n=e.side,r=e.view;if(isNaN(o)||isNaN(t)||!r||!i)return!1;var s=r.padding;return"right"===n&&i.x+o/2>r.width-s.right||("left"===n&&i.x-o/2<s.left||("top"===n&&i.y-t<s.top||"bottom"===n&&i.y+t>r.height-s.bottom))},t.prototype._calculateAutoAlignment=function(e){if("auto"!==e)return e;var t=this._pointerOffsetInPx,o=this._containerNode,i=this._mainContainerNode,n=this.viewModel,r=n.screenLocation,s=n.view;if(!r||!s||!o)return"top-center";if(!this._isScreenLocationWithinView(r,s))return this._get("currentAlignment")||"top-center";function a(e){return parseInt(e.replace(/[^-\d\.]/g,""),10)}var l=i?window.getComputedStyle(i,null):null,u=l?a(l.getPropertyValue("max-height")):0,d=l?a(l.getPropertyValue("height")):0,p=o.getBoundingClientRect(),c=p.height,h=p.width+t,_=Math.max(c,u,d)+t,f=this._isOutsideView({popupHeight:_,popupWidth:h,screenLocation:r,side:"right",view:s}),v=this._isOutsideView({popupHeight:_,popupWidth:h,screenLocation:r,side:"left",view:s}),g=this._isOutsideView({popupHeight:_,popupWidth:h,screenLocation:r,side:"top",view:s}),y=this._isOutsideView({popupHeight:_,popupWidth:h,screenLocation:r,side:"bottom",view:s});return v?g?"bottom-right":"top-right":f?g?"bottom-left":"top-left":g?y?"top-center":"bottom-center":"top-center"},t.prototype._callCurrentAlignment=function(e){return"function"==typeof e?e.call(this):e},t.prototype._getCurrentAlignment=function(){var e=this.alignment;return this.dockEnabled||!this.viewModel.active?null:this._calculatePositionResult(this._calculateAutoAlignment(this._callCurrentAlignment(e)))},t.prototype._setCurrentAlignment=function(){this._set("currentAlignment",this._getCurrentAlignment())},t.prototype._setCurrentDockPosition=function(){this._set("currentDockPosition",this._getCurrentDockPosition())},t.prototype._calculatePositionResult=function(e){var t=["left","right"];return y.isRTL()&&t.reverse(),e.replace(/leading/gi,t[0]).replace(/trailing/gi,t[1])},t.prototype._callDockPosition=function(e){return"function"==typeof e?e.call(this):e},t.prototype._getDockPosition=function(){var e;return this._calculatePositionResult(this._calculateAutoDockPosition(this._callDockPosition(null===(e=this.dockOptions)||void 0===e?void 0:e.position)))},t.prototype._getCurrentDockPosition=function(){return this.dockEnabled&&this.viewModel.active?this._getDockPosition():null},t.prototype._wouldDockTo=function(){return this.dockEnabled?null:this._getDockPosition()},t.prototype._calculateAutoDockPosition=function(e){var t;if("auto"!==e)return e;var o=null===(t=this.viewModel)||void 0===t?void 0:t.view,i=y.isRTL()?"top-left":"top-right";if(!o)return i;var n=o.padding||{left:0,right:0,top:0,bottom:0},r=o.width-n.left-n.right,s=o.breakpoints;return s&&r<=s.xsmall?"bottom-center":i},t.prototype._positionContainer=function(e){if(void 0===e&&(e=this._containerNode),e&&(this._containerNode=e),e){var t=this.viewModel.screenLocation,o=e.getBoundingClientRect().width,i=this._calculatePositionStyle(t,o);i&&(e.style.top=i.top,e.style.left=i.left,e.style.bottom=i.bottom,e.style.right=i.right)}},t.prototype._calculateFullWidth=function(e){var t=this.currentAlignment,o=this._pointerOffsetInPx;return"top-left"===t||"bottom-left"===t||"top-right"===t||"bottom-right"===t?e+o:e},t.prototype._calculateAlignmentPosition=function(e,t,o,i){var n=this.currentAlignment,r=this._pointerOffsetInPx,s=i/2,a=o.height-t,l=o.width-e,u=this.view.padding;return"bottom-center"===n?{top:t+r-u.top,left:e-s-u.left}:"top-left"===n?{bottom:a+r-u.bottom,right:l+r-u.right}:"bottom-left"===n?{top:t+r-u.top,right:l+r-u.right}:"top-right"===n?{bottom:a+r-u.bottom,left:e+r-u.left}:"bottom-right"===n?{top:t+r-u.top,left:e+r-u.left}:"top-center"===n?{bottom:a+r-u.bottom,left:e-s-u.left}:void 0},t.prototype._calculatePositionStyle=function(e,t){var o=this.dockEnabled,i=this.view;if(i){if(o)return{left:"",top:"",right:"",bottom:""};if(e&&t){var n=this._calculateFullWidth(t),r=this._calculateAlignmentPosition(e.x,e.y,i,n);if(r)return{top:void 0!==r.top?r.top+"px":"auto",left:void 0!==r.left?r.left+"px":"auto",bottom:void 0!==r.bottom?r.bottom+"px":"auto",right:void 0!==r.right?r.right+"px":"auto"}}}},t.prototype._viewChange=function(e,t){e&&t&&(this.close(),this.clear())},t.prototype._viewReadyChange=function(e,t){if(e){var o=this.get("viewModel.view");this._wireUpView(o)}else t&&(this.close(),this.clear())},t.prototype._wireUpView=function(e){(this._destroySpinner(),e)&&(this.spinnerEnabled&&this._createSpinner(e),this._setDockEnabledForViewSize(this.dockOptions))},t.prototype._dockingThresholdCrossed=function(e,t,o){var i=e[0],n=e[1],r=t[0],s=t[1],a=o.width,l=o.height;return i<=a&&r>a||i>a&&r<=a||n<=l&&s>l||n>l&&s<=l},t.prototype._updateDockEnabledForViewSize=function(e,t){if(e&&t){var o=this.get("viewModel.view.padding")||{left:0,right:0,top:0,bottom:0},i=o.left+o.right,n=o.top+o.bottom,r=[],s=[];r[0]=e[0]-i,r[1]=e[1]-n,s[0]=t[0]-i,s[1]=t[1]-n;var a=this.dockOptions,l=a.breakpoint;this._dockingThresholdCrossed(r,s,l)&&this._setDockEnabledForViewSize(a),this._setCurrentDockPosition()}},t.prototype._focusDockButtonNode=function(e){this._focusDockButton&&(this._focusDockButton=!1,e.focus())},t.prototype._mainContainerNodeUpdated=function(e){return this._mainContainerNode=e,this._focusContainer?(this._focusContainer=!1,void e.focus()):this._blurContainer?(this._blurContainer=!1,void e.blur()):void 0},t.prototype._featureMenuNodeUpdated=function(e){if(this._featureMenuNode=e,e&&this._focusFirstFeature){this._focusFirstFeature=!1;var t=e.querySelectorAll("li");if(t.length)t[0].focus()}},t.prototype._actionsMenuNodeUpdated=function(e){if(this._actionsMenuNode=e,e&&this._focusFirstAction){this._focusFirstAction=!1;var t=e.querySelectorAll("li");if(t.length)t[0].focus()}},t.prototype._focusFeatureMenuButtonNode=function(e){this._focusFeatureMenuButton&&(this._focusFeatureMenuButton=!1,e.focus())},t.prototype._focusActionsMenuButtonNode=function(e){this._focusActionsMenuButton&&(this._focusActionsMenuButton=!1,e.focus())},t.prototype._featureMenuViewportNodeUpdated=function(e){e&&(e.scrollTop=0)},t.prototype._toggleScreenLocationEnabled=function(){var e=this.dockEnabled,t=this.viewModel;if(t){var o=t.active&&!e;t.screenLocationEnabled=o}},t.prototype._shouldDockAtCurrentViewSize=function(e){var t=e.breakpoint,o=this.get("viewModel.view.ui"),i=o.width,n=o.height;if(isNaN(i)||isNaN(n))return!1;var r=t.hasOwnProperty("width")&&i<=t.width,s=t.hasOwnProperty("height")&&n<=t.height;return r||s},t.prototype._setDockEnabledForViewSize=function(e){e.breakpoint&&(this.dockEnabled=this._shouldDockAtCurrentViewSize(e))},t.prototype._getPageText=function(e,t){return this.featureNavigationVisible?i.substitute(this.messages.pageText,{index:t+1,total:e}):null},t.prototype._destroySpinner=function(){var e=this._spinner,t=this.view;e&&(t&&t.ui&&t.ui.remove(this._spinner,"popup-spinner"),e.destroy(),this._spinner=null)},t.prototype._createSpinner=function(e){e&&(this._spinner=new h({view:e}),e.ui.add(this._spinner,{key:"popup-spinner",position:"manual"}))},t.prototype._toggleCollapsed=function(){this.collapsed=!this.collapsed},t.prototype._close=function(){this.close(),this.view&&this.view.focus()},t.prototype._toggleDockEnabled=function(){this.dockEnabled=!this.dockEnabled,this._focusDockButton=!0,this.scheduleRender()},t.prototype._toggleFeatureMenu=function(){var e=!this.featureMenuOpen;this._featureMenuOpenChanged(e),this.actionsMenuOpen=!1,this.featureMenuOpen=e},t.prototype._toggleActionsMenu=function(){var e=!this.actionsMenuOpen;this._actionsMenuOpenChanged(e),this.featureMenuOpen=!1,this.actionsMenuOpen=e},t.prototype._triggerAction=function(e){var t=e.currentTarget["data-action-index"],o=this.viewModel.allActions.getItemAt(t);o&&"toggle"===o.type&&(o.value=!o.value),this.actionsMenuOpen=!1,this.viewModel.triggerAction(t)},t.prototype._selectFeature=function(e){var t=e.currentTarget["data-feature-index"];isNaN(t)||(this.viewModel.selectedFeatureIndex=t),this.featureMenuOpen=!1,this._focusFeatureMenuButton=!0,this.scheduleRender()},t.prototype._next=function(){this.next()},t.prototype._previous=function(){this.previous()},o.__decorate([p.property({readOnly:!0,dependsOn:["id"]}),g.renderable()],t.prototype,"actionsMenuId",null),o.__decorate([p.property({readOnly:!0,dependsOn:["id"]}),g.renderable()],t.prototype,"actionsMenuButtonId",null),o.__decorate([p.property({readOnly:!0,dependsOn:["id"]}),g.renderable()],t.prototype,"featureMenuId",null),o.__decorate([p.property({readOnly:!0,dependsOn:["id"]}),g.renderable()],t.prototype,"titleId",null),o.__decorate([p.property({readOnly:!0,dependsOn:["id"]}),g.renderable()],t.prototype,"contentId",null),o.__decorate([p.property({readOnly:!0,dependsOn:["selectedFeatureWidget","selectedFeatureWidget.viewModel","selectedFeatureWidget.viewModel.waitingForContent","selectedFeatureWidget.viewModel.content","viewModel.content"]}),g.renderable()],t.prototype,"hasContent",null),o.__decorate([p.property({readOnly:!0,dependsOn:["viewModel.active","viewModel.featureCount","visibleElements.featureNavigation"]}),g.renderable()],t.prototype,"featureNavigationVisible",null),o.__decorate([p.property({readOnly:!0,dependsOn:["collapseEnabled","viewModel.title","hasContent"]}),g.renderable()],t.prototype,"collapsible",null),o.__decorate([p.property({readOnly:!0,dependsOn:["featureNavigationVisible","featureMenuOpen"]}),g.renderable()],t.prototype,"featureMenuVisible",null),o.__decorate([p.property({readOnly:!0,dependsOn:["collapsible","featureMenuVisible","collapsed"]}),g.renderable()],t.prototype,"contentCollapsed",null),o.__decorate([p.property({readOnly:!0,dependsOn:["featureNavigationVisible","maxInlineActions","viewModel.allActions","viewModel.allActions.length"]}),g.renderable()],t.prototype,"dividedActions",null),o.__decorate([p.aliasOf("viewModel.actions"),g.renderable()],t.prototype,"actions",void 0),o.__decorate([p.property({dependsOn:["viewModel.active"]}),g.renderable()],t.prototype,"actionsMenuOpen",null),o.__decorate([p.property()],t.prototype,"alignment",void 0),o.__decorate([p.aliasOf("viewModel.autoCloseEnabled")],t.prototype,"autoCloseEnabled",void 0),o.__decorate([p.aliasOf("viewModel.autoOpenEnabled")],t.prototype,"autoOpenEnabled",void 0),o.__decorate([p.aliasOf("viewModel.defaultPopupTemplateEnabled")],t.prototype,"defaultPopupTemplateEnabled",void 0),o.__decorate([p.aliasOf("viewModel.content"),g.renderable()],t.prototype,"content",void 0),o.__decorate([p.property(),g.renderable()],t.prototype,"collapsed",void 0),o.__decorate([p.property(),g.renderable()],t.prototype,"collapseEnabled",void 0),o.__decorate([p.property({readOnly:!0,dependsOn:["dockEnabled","alignment","viewModel.active"]}),g.renderable()],t.prototype,"currentAlignment",null),o.__decorate([p.property({readOnly:!0,dependsOn:["viewModel.view.ready","dockEnabled","dockOptions","viewModel.active"]}),g.renderable()],t.prototype,"currentDockPosition",null),o.__decorate([p.property(),g.renderable()],t.prototype,"dockOptions",null),o.__decorate([p.property(),g.renderable()],t.prototype,"dockEnabled",void 0),o.__decorate([p.aliasOf("viewModel.featureCount"),g.renderable()],t.prototype,"featureCount",void 0),o.__decorate([p.property(),g.renderable()],t.prototype,"featureMenuOpen",void 0),o.__decorate([p.aliasOf("viewModel.features"),g.renderable()],t.prototype,"features",void 0),o.__decorate([p.property(),g.renderable()],t.prototype,"featureNavigationEnabled",null),o.__decorate([p.aliasOf("viewModel.goToOverride")],t.prototype,"goToOverride",void 0),o.__decorate([p.aliasOf("viewModel.highlightEnabled")],t.prototype,"highlightEnabled",void 0),o.__decorate([p.aliasOf("viewModel.location"),g.renderable()],t.prototype,"location",void 0),o.__decorate([p.property({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],t.prototype,"label",void 0),o.__decorate([p.property(),g.renderable()],t.prototype,"maxInlineActions",void 0),o.__decorate([p.property(),g.renderable(),g.messageBundle("esri/widgets/Popup/t9n/Popup")],t.prototype,"messages",void 0),o.__decorate([p.property(),g.renderable(),g.messageBundle("esri/t9n/common")],t.prototype,"messagesCommon",void 0),o.__decorate([p.aliasOf("viewModel.promises")],t.prototype,"promises",void 0),o.__decorate([p.aliasOf("viewModel.selectedFeature"),g.renderable()],t.prototype,"selectedFeature",void 0),o.__decorate([p.aliasOf("viewModel.selectedFeatureIndex"),g.renderable()],t.prototype,"selectedFeatureIndex",void 0),o.__decorate([p.property({readOnly:!0,dependsOn:["viewModel.selectedFeatureViewModel","visibleElements"]}),g.renderable()],t.prototype,"selectedFeatureWidget",null),o.__decorate([p.property()],t.prototype,"spinnerEnabled",void 0),o.__decorate([p.aliasOf("viewModel.title"),g.renderable()],t.prototype,"title",void 0),o.__decorate([p.aliasOf("viewModel.updateLocationEnabled")],t.prototype,"updateLocationEnabled",void 0),o.__decorate([p.aliasOf("viewModel.view")],t.prototype,"view",void 0),o.__decorate([p.property({type:v}),g.renderable(["viewModel.active","viewModel.view.widthBreakpoint","viewModel.allActions","viewModel.screenLocation","viewModel.screenLocationEnabled","viewModel.state","viewModel.pendingPromisesCount","viewModel.promiseCount","viewModel.waitingForResult"]),g.vmEvent(["triggerAction","trigger-action"])],t.prototype,"viewModel",void 0),o.__decorate([p.aliasOf("viewModel.visible"),g.renderable()],t.prototype,"visible",void 0),o.__decorate([p.property(),g.renderable()],t.prototype,"visibleElements",void 0),o.__decorate([p.cast("visibleElements")],t.prototype,"castVisibleElements",null),o.__decorate([g.accessibleHandler()],t.prototype,"_toggleCollapsed",null),o.__decorate([g.accessibleHandler()],t.prototype,"_close",null),o.__decorate([g.accessibleHandler()],t.prototype,"_toggleDockEnabled",null),o.__decorate([g.accessibleHandler()],t.prototype,"_toggleFeatureMenu",null),o.__decorate([g.accessibleHandler()],t.prototype,"_toggleActionsMenu",null),o.__decorate([g.accessibleHandler()],t.prototype,"_triggerAction",null),o.__decorate([g.accessibleHandler()],t.prototype,"_selectFeature",null),o.__decorate([g.accessibleHandler()],t.prototype,"_next",null),o.__decorate([g.accessibleHandler()],t.prototype,"_previous",null),t=o.__decorate([p.subclass("esri.widgets.Popup")],t)}(f.FeatureContentMixin(_))}));