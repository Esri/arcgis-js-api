/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../intl","../core/Collection","../core/events","../core/Handles","../core/Logger","../core/maybe","../core/throttle","../core/watchUtils","../core/accessorSupport/decorators/aliasOf","../core/has","../core/accessorSupport/decorators/cast","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/subclass","./Feature","./Spinner","./Widget","./Feature/support/FeatureContentMixin","./Popup/PopupViewModel","./support/Heading","./support/decorators/accessibleHandler","./support/decorators/messageBundle","./support/decorators/vmEvent","./support/jsxFactory","./support/widgetUtils","../intl/substitute"],(function(e,t,n,i,o,s,r,a,l,u,c,d,p,h,_,f,g,v,b,M,m,w,y,k,C,A,x){"use strict";const F="selected-index",I=0,O="popup-spinner",T={iconLeftTriangleArrow:"esri-icon-left-triangle-arrow",iconRightTriangleArrow:"esri-icon-right-triangle-arrow",iconDockToTop:"esri-icon-maximize",iconDockToBottom:"esri-icon-dock-bottom",iconDockToLeft:"esri-icon-dock-left",iconDockToRight:"esri-icon-dock-right",iconClose:"esri-icon-close",iconUndock:"esri-icon-minimize",iconCheckMark:"esri-icon-check-mark",iconLoading:"esri-icon-loading-indicator",iconDefaultAction:"esri-icon-default-action",iconActionsMenu:"esri-icon-handle-horizontal",rotating:"esri-rotating",base:"esri-popup",widget:"esri-widget",main:"esri-popup__main-container",loadingContainer:"esri-popup__loading-container",isCollapsible:"esri-popup--is-collapsible",isCollapsed:"esri-popup--is-collapsed",shadow:"esri-popup--shadow",isDocked:"esri-popup--is-docked",isDockedTopLeft:"esri-popup--is-docked-top-left",isDockedTopCenter:"esri-popup--is-docked-top-center",isDockedTopRight:"esri-popup--is-docked-top-right",isDockedBottomLeft:"esri-popup--is-docked-bottom-left",isDockedBottomCenter:"esri-popup--is-docked-bottom-center",isDockedBottomRight:"esri-popup--is-docked-bottom-right",alignTopCenter:"esri-popup--aligned-top-center",alignBottomCenter:"esri-popup--aligned-bottom-center",alignTopLeft:"esri-popup--aligned-top-left",alignBottomLeft:"esri-popup--aligned-bottom-left",alignTopRight:"esri-popup--aligned-top-right",alignBottomRight:"esri-popup--aligned-bottom-right",isFeatureMenuOpen:"esri-popup--feature-menu-open",isActionsMenuOpen:"esri-popup--actions-menu-open",hasFeatureUpdated:"esri-popup--feature-updated",header:"esri-popup__header",headerButtons:"esri-popup__header-buttons",headerContainer:"esri-popup__header-container",headerContainerButton:"esri-popup__header-container--button",headerTitle:"esri-popup__header-title",content:"esri-popup__content",footer:"esri-popup__footer",footerHasPagination:"esri-popup__footer--has-pagination",footerHasActions:"esri-popup__footer--has-actions",footerHasActionsMenu:"esri-popup__footer--has-actions-menu",button:"esri-popup__button",buttonDisabled:"esri-popup__button--disabled",buttonDock:"esri-popup__button--dock",icon:"esri-popup__icon",iconDock:"esri-popup__icon--dock-icon",inlineActionsContainer:"esri-popup__inline-actions-container",actionsMenuButton:"esri-popup__actions-menu-button",actions:"esri-popup__actions",action:"esri-popup__action",actionImage:"esri-popup__action-image",actionText:"esri-popup__action-text",actionToggle:"esri-popup__action-toggle",actionToggleOn:"esri-popup__action-toggle--on",pointer:"esri-popup__pointer",pointerDirection:"esri-popup__pointer-direction",navigation:"esri-popup__navigation",paginationPrevious:"esri-popup__pagination-previous",paginationNext:"esri-popup__pagination-next",paginationPreviousIconLTR:"esri-popup__pagination-previous-icon",paginationPreviousIconRTL:"esri-popup__pagination-previous-icon--rtl",paginationNextIconLTR:"esri-popup__pagination-next-icon",paginationNextIconRTL:"esri-popup__pagination-next-icon--rtl",featureMenu:"esri-popup__feature-menu",featureMenuList:"esri-popup__feature-menu-list",featureMenuItem:"esri-popup__feature-menu-item",featureMenuViewport:"esri-popup__feature-menu-viewport",featureMenuHeader:"esri-popup__feature-menu-header",featureMenuNote:"esri-popup__feature-menu-note",featureMenuSelected:"esri-popup__feature-menu-item--selected",featureMenuButton:"esri-popup__feature-menu-button",featureMenuTitle:"esri-popup__feature-menu-title",featureMenuObserver:"esri-popup__feature-menu-observer",featureMenuLoader:"esri-popup__feature-menu-loader",collapseButton:"esri-popup__collapse-button"},N={buttonEnabled:!0,position:"auto",breakpoint:{width:544}},B="esri-popup";function D(e,t){return void 0===t?`${B}__${e}`:`${B}__${e}-${t}`}const E="esri.widgets.Popup",P=r.getLogger(E),L={closeButton:!0,featureNavigation:!0};let S=function(t){function n(n,i){var o;return(o=t.call(this,n,i)||this)._blurClose=!1,o._blurContainer=!1,o._containerNode=null,o._mainContainerNode=null,o._featureMenuNode=null,o._actionsMenuNode=null,o._focusClose=!1,o._focusContainer=!1,o._focusDockButton=!1,o._focusFeatureMenuButton=!1,o._focusActionsMenuButton=!1,o._focusFirstFeature=!1,o._focusFirstAction=!1,o._handles=new s,o._pointerOffsetInPx=16,o._spinner=null,o._feature=null,o._featureMenuIntersectionObserverCallback=([e])=>{null!=e&&e.isIntersecting&&o.viewModel.featurePage++},o._featureMenuIntersectionObserver=new IntersectionObserver(o._featureMenuIntersectionObserverCallback),o._displaySpinnerThrottled=l.throttle((()=>o._displaySpinner()),I),o.actions=null,o.alignment="auto",o.autoCloseEnabled=null,o.autoOpenEnabled=null,o.defaultPopupTemplateEnabled=null,o.content=null,o.collapsed=!1,o.collapseEnabled=!0,o.dockEnabled=!1,o.featureCount=null,o.featureMenuOpen=!1,o.features=null,o.goToOverride=null,o.headingLevel=2,o.highlightEnabled=null,o.location=null,o.label=void 0,o.maxInlineActions=3,o.messages=null,o.messagesCommon=null,o.promises=null,o.selectedFeature=null,o.selectedFeatureIndex=null,o.spinnerEnabled=!0,o.title=null,o.updateLocationEnabled=null,o.view=null,o.viewModel=new M,o.visible=null,o.visibleElements={...L},o._addSelectedFeatureIndexHandle(),o.own([u.watch(e._assertThisInitialized(o),"viewModel.screenLocation",(()=>o._positionContainer())),u.watch(e._assertThisInitialized(o),["viewModel.active","dockEnabled"],(()=>o._toggleScreenLocationEnabled())),u.watch(e._assertThisInitialized(o),"viewModel.screenLocation",((e,t)=>{!!e!=!!t&&o.reposition()})),u.watch(e._assertThisInitialized(o),["viewModel.view.padding","viewModel.view.size","viewModel.active","viewModel.location","alignment"],(()=>o.reposition())),u.watch(e._assertThisInitialized(o),"spinnerEnabled",(e=>o._spinnerEnabledChange(e))),u.watch(e._assertThisInitialized(o),"viewModel.view.size",((e,t)=>o._updateDockEnabledForViewSize(e,t))),u.watch(e._assertThisInitialized(o),"viewModel.view",((e,t)=>o._viewChange(e,t))),u.watch(e._assertThisInitialized(o),"viewModel.view.ready",((e,t)=>o._viewReadyChange(e,t))),u.watch(e._assertThisInitialized(o),["viewModel.waitingForResult","viewModel.location"],(()=>{o._hideSpinner(),o._displaySpinnerThrottled()})),u.watch(e._assertThisInitialized(o),["selectedFeatureWidget.viewModel.title","selectedFeatureWidget.viewModel.state"],(()=>o._setTitleFromFeatureWidget())),u.watch(e._assertThisInitialized(o),["selectedFeatureWidget.viewModel.content","selectedFeatureWidget.viewModel.state"],(()=>o._setContentFromFeatureWidget())),u.whenFalse(e._assertThisInitialized(o),"collapsed",(()=>{var e,t;"xsmall"===(null==(e=o.viewModel)||null==(t=e.view)?void 0:t.widthBreakpoint)&&o.viewModel.active&&o.collapseEnabled&&o.viewModel.centerAtLocation()})),u.on(e._assertThisInitialized(o),"viewModel.allActions","change",(()=>o._watchActions())),u.init(e._assertThisInitialized(o),"viewModel.allActions",(()=>o._watchActions())),u.watch(e._assertThisInitialized(o),"viewModel.featureViewModels",(()=>o._featureMenuViewportScrollTop()))]),o}e._inheritsLoose(n,t);var r=n.prototype;return r.destroy=function(){var e,t;this._destroySelectedFeatureWidget(),this._destroySpinner(),null==(e=this._handles)||e.destroy(),this._unobserveFeatureMenuObserver(),null==(t=this._featureMenuIntersectionObserver)||t.disconnect(),this._handles=null},r.castVisibleElements=function(e){return{...L,...e}},r.blur=function(){const{active:e}=this.viewModel;e||P.warn("Popup can only be blurred when currently active."),this.visibleElements.closeButton?this._blurClose=!0:this._blurContainer=!0,this.scheduleRender()},r.clear=function(){this.viewModel.clear()},r.close=function(){this.visible=!1},r.fetchFeatures=function(e,t){return this.viewModel.fetchFeatures(e,t)},r.focus=function(){const{active:e}=this.viewModel;e||P.warn("Popup can only be focused when currently active."),this.visibleElements.closeButton?this._focusClose=!0:this._focusContainer=!0,this.scheduleRender()},r.next=function(){return this.viewModel.next()},r.open=function(e){var t,n;this._handles.remove(F);const i=!!e&&!!e.featureMenuOpen,o=!!e&&!!e.actionsMenuOpen,s={collapsed:!!e&&!!e.collapsed,actionsMenuOpen:o,featureMenuOpen:i};"xsmall"===(null==(t=this.viewModel)||null==(n=t.view)?void 0:n.widthBreakpoint)&&(s.collapsed=!0),this.set(s),this.viewModel.open(e),this._addSelectedFeatureIndexHandle()},r.previous=function(){return this.viewModel.previous()},r.reposition=function(){this.renderNow(),this._positionContainer(),this._setCurrentAlignment()},r.triggerAction=function(e){this.viewModel.triggerAction(e)},r.render=function(){var e,t,n,i;const{actionsMenuOpen:o,dockEnabled:s,featureMenuVisible:r,dividedActions:a,currentAlignment:l,currentDockPosition:u}=this,{active:c}=this.viewModel,{menuActions:d}=a,p=c&&d.length>1&&o,h=c&&s,_=c&&!s,f=null==(e=this.selectedFeature)||null==(t=e.layer)?void 0:t.title,g=null==(n=this.selectedFeature)||null==(i=n.layer)?void 0:i.id,v={[T.alignTopCenter]:"top-center"===l,[T.alignBottomCenter]:"bottom-center"===l,[T.alignTopLeft]:"top-left"===l,[T.alignBottomLeft]:"bottom-left"===l,[T.alignTopRight]:"top-right"===l,[T.alignBottomRight]:"bottom-right"===l,[T.isDocked]:h,[T.shadow]:_,[T.isDockedTopLeft]:"top-left"===u,[T.isDockedTopCenter]:"top-center"===u,[T.isDockedTopRight]:"top-right"===u,[T.isDockedBottomLeft]:"bottom-left"===u,[T.isDockedBottomCenter]:"bottom-center"===u,[T.isDockedBottomRight]:"bottom-right"===u,[T.isFeatureMenuOpen]:r,[T.isActionsMenuOpen]:p};return C.tsx("div",{class:this.classes(T.base,v),role:"presentation","data-layer-title":f,"data-layer-id":g,bind:this,afterCreate:this._positionContainer,afterUpdate:this._positionContainer},c?[this.renderMainContainer(),this.renderPointer()]:null)},r.renderLoadingIcon=function(){return C.tsx("span",{"aria-hidden":"true",class:this.classes(T.icon,T.iconLoading,T.rotating)})},r.renderNavigationLoading=function(){const{messagesCommon:e}=this;return this.viewModel.pendingPromisesCount?C.tsx("div",{key:D("loading-container"),role:"presentation",class:T.loadingContainer,"aria-label":e.loading,title:e.loading},this.renderLoadingIcon()):null},r.renderPreviousIcon=function(){const e=A.isRTL(this.container),t={[T.iconRightTriangleArrow]:e,[T.paginationPreviousIconRTL]:e,[T.iconLeftTriangleArrow]:!e,[T.paginationPreviousIconLTR]:!e};return C.tsx("span",{"aria-hidden":"true",class:this.classes(T.icon,t)})},r.renderPreviousButton=function(){const{messages:e}=this;return C.tsx("div",{role:"button",tabIndex:0,bind:this,onclick:this._previous,onkeydown:this._previous,class:this.classes(T.button,T.paginationPrevious),"aria-label":e.previous,title:e.previous},this.renderPreviousIcon())},r.renderNextIcon=function(){const e=A.isRTL(this.container),t={[T.iconLeftTriangleArrow]:e,[T.paginationNextIconRTL]:e,[T.iconRightTriangleArrow]:!e,[T.paginationNextIconLTR]:!e};return C.tsx("span",{"aria-hidden":"true",class:this.classes(T.icon,t)})},r.renderNextButton=function(){const{messages:e}=this;return C.tsx("div",{role:"button",tabIndex:0,bind:this,onclick:this._next,onkeydown:this._next,class:this.classes(T.button,T.paginationNext),"aria-label":e.next,title:e.next},this.renderNextIcon())},r.renderFeatureMenuButton=function(){const{featureMenuOpen:e,featureMenuId:t,messagesCommon:n}=this,{featureCount:i,selectedFeatureIndex:o}=this.viewModel;return C.tsx("div",{role:"button",tabIndex:0,bind:this,onclick:this._toggleFeatureMenu,onkeydown:this._toggleFeatureMenu,afterCreate:this._focusFeatureMenuButtonNode,afterUpdate:this._focusFeatureMenuButtonNode,class:this.classes(T.button,T.featureMenuButton),"aria-haspopup":"true","aria-controls":t,"aria-expanded":e.toString(),"aria-label":n.menu,title:n.menu},this._getPageText(i,o))},r.renderNavigationButtons=function(){return this.featureNavigationVisible?[this.renderPreviousButton(),this.renderNavigationLoading()||this.renderFeatureMenuButton(),this.renderNextButton()]:null},r.renderDockIcon=function(){const{dockEnabled:e}=this,t=this._wouldDockTo(),n={[T.iconUndock]:e,[T.iconDock]:!e,[T.iconDockToRight]:!e&&("top-right"===t||"bottom-right"===t),[T.iconDockToLeft]:!e&&("top-left"===t||"bottom-left"===t),[T.iconDockToTop]:!e&&"top-center"===t,[T.iconDockToBottom]:!e&&"bottom-center"===t};return C.tsx("span",{"aria-hidden":"true",class:this.classes(n,T.icon)})},r.renderDockButton=function(){var e,t,n;const{dockEnabled:i,messages:o}=this,s=null==(e=this.viewModel)||null==(t=e.view)?void 0:t.widthBreakpoint,r=i?o.undock:o.dock;return"xsmall"!==s&&null!=(n=this.dockOptions)&&n.buttonEnabled?C.tsx("div",{role:"button","aria-label":r,title:r,tabIndex:0,bind:this,onclick:this._toggleDockEnabled,onkeydown:this._toggleDockEnabled,afterCreate:this._focusDockButtonNode,afterUpdate:this._focusDockButtonNode,class:this.classes(T.button,T.buttonDock)},this.renderDockIcon()):null},r.renderTitle=function(){const{title:e}=this.viewModel,{titleId:t,collapsible:n,contentCollapsed:i,messagesCommon:o}=this,s={[T.headerContainerButton]:n},r=C.tsx(m.Heading,{level:this.headingLevel,class:T.headerTitle,innerHTML:e}),a=n?C.tsx("button",{key:`${e}--collapsible`,id:t,title:i?o.expand:o.collapse,bind:this,enterAnimation:this._createFeatureUpdatedAnimation(),class:this.classes(T.headerContainer,s),"aria-expanded":i?"false":"true",onclick:this._toggleCollapsed},r):C.tsx("div",{key:e,id:t,bind:this,enterAnimation:this._createFeatureUpdatedAnimation(),class:this.classes(T.headerContainer,s)},r);return e?a:null},r.renderCloseIcon=function(){return C.tsx("span",{"aria-hidden":"true",class:this.classes(T.icon,T.iconClose)})},r.renderCloseButton=function(){const{visibleElements:e,messagesCommon:t}=this;return e.closeButton?C.tsx("div",{role:"button",tabIndex:0,bind:this,onclick:this._close,onkeydown:this._close,class:T.button,"aria-label":t.close,title:t.close,afterCreate:this._closeButtonNodeUpdated,afterUpdate:this._closeButtonNodeUpdated},this.renderCloseIcon()):null},r.renderHeader=function(){return C.tsx("header",{class:T.header},this.renderTitle(),C.tsx("div",{class:T.headerButtons},this.renderDockButton(),this.renderCloseButton()))},r.renderContentContainer=function(){const{contentId:e,hasContent:t,contentCollapsed:n}=this,{content:i}=this.viewModel;return t&&!n?C.tsx("article",{key:i,enterAnimation:this._createFeatureUpdatedAnimation(),id:e,class:T.content},this.renderContent()):null},r.renderActionsMenuButton=function(){const{actionsMenuId:e,actionsMenuButtonId:t,actionsMenuOpen:n,dividedActions:i,messagesCommon:o}=this,s=n?o.close:o.open,{menuActions:r}=i;return r.length?C.tsx("div",{key:D("actions-menu-button"),class:this.classes(T.button,T.actionsMenuButton),role:"button",id:t,"aria-haspopup":"true","aria-controls":n?e:null,tabIndex:0,bind:this,onclick:this._toggleActionsMenu,onkeydown:this._toggleActionsMenu,afterCreate:this._focusActionsMenuButtonNode,afterUpdate:this._focusActionsMenuButtonNode,"aria-label":s,title:s},C.tsx("span",{"aria-hidden":"true",class:T.iconActionsMenu})):null},r.renderMenuActions=function(){const{actionsMenuId:e,actionsMenuButtonId:t,actionsMenuOpen:n,dividedActions:i}=this,{menuActions:o,inlineActions:s}=i;return o.length&&n?C.tsx("ul",{id:e,role:"menu","aria-labelledby":t,key:D("actions"),class:T.actions,bind:this,onkeyup:this._handleActionMenuKeyup,afterCreate:this._actionsMenuNodeUpdated,afterUpdate:this._actionsMenuNodeUpdated},o.toArray().map(((e,t)=>this.renderAction({action:e,index:t+s.length,type:"menu-item"})))):null},r.renderInlineActions=function(){const{inlineActions:e}=this.dividedActions;return!!e.length&&e.toArray().map(((e,t)=>this.renderAction({action:e,index:t,type:"inline"})))},r.renderInlineActionsContainer=function(){const{inlineActions:e,menuActions:t}=this.dividedActions,n=!!e.length,i=!!t.length;return n||i?C.tsx("div",{key:"inline-actions-container","data-inline-actions":n.toString(),"data-menu-actions":i.toString(),class:T.inlineActionsContainer},this.renderInlineActions(),this.renderActionsMenuButton(),this.renderMenuActions()):null},r.renderNavigation=function(){return this.featureNavigationVisible?C.tsx("section",{key:D("navigation"),class:this.classes(T.navigation)},this.renderNavigationButtons()):null},r.renderFooter=function(){const{featureNavigationVisible:e,dividedActions:t}=this,{inlineActions:n,menuActions:i}=t,o=!!n.length,s=!!i.length,r={[T.footerHasPagination]:e,[T.footerHasActions]:o,[T.footerHasActionsMenu]:s};return e||o?C.tsx("div",{key:D("feature-buttons"),class:this.classes(T.footer,r)},this.renderInlineActionsContainer(),this.renderNavigation()):null},r.renderFeatureMenuContainer=function(){const{messages:e}=this,{featureViewModels:t,isLoadingFeature:n}=this.viewModel,i=x.substitute(e.selectedFeatures,{total:t.length});return C.tsx("section",{key:D("menu"),class:T.featureMenu},C.tsx("strong",{class:T.featureMenuHeader},i),C.tsx("nav",{bind:this,class:T.featureMenuViewport,"data-node-ref":"_featureMenuViewportNode",afterCreate:A.storeNode},this.renderFeatureMenu(),C.tsx("div",{class:T.featureMenuObserver,bind:this,afterCreate:this._featureMenuIntersectionObserverCreated}),n?C.tsx("div",{class:T.featureMenuLoader},this.renderLoadingIcon()):null))},r.renderPointer=function(){return this.dockEnabled?null:C.tsx("div",{key:D("pointer"),class:T.pointer,role:"presentation"},C.tsx("div",{class:this.classes(T.pointerDirection,T.shadow)}))},r.renderMainContainer=function(){const{dockEnabled:e,currentAlignment:t,currentDockPosition:n,titleId:i,contentId:o,collapsible:s,hasContent:r,contentCollapsed:a,visibleElements:l}=this,{title:u}=this.viewModel,c="bottom-left"===t||"bottom-center"===t||"bottom-right"===t||"top-left"===n||"top-center"===n||"top-right"===n,d="top-left"===t||"top-center"===t||"top-right"===t||"bottom-left"===n||"bottom-center"===n||"bottom-right"===n,p={[T.shadow]:e,[T.isCollapsible]:s,[T.isCollapsed]:a};return C.tsx("div",{class:this.classes(T.main,T.widget,p),tabIndex:l.closeButton?null:-1,role:"dialog","aria-labelledby":u?i:"","aria-describedby":r&&!a?o:"",bind:this,onkeyup:this._handleMainKeyup,afterCreate:this._mainContainerNodeUpdated,afterUpdate:this._mainContainerNodeUpdated},c?this.renderFooter():null,c?this.renderFeatureMenuContainer():null,this.renderHeader(),this.renderContentContainer(),d?this.renderFooter():null,d?this.renderFeatureMenuContainer():null)},r.renderContent=function(){var e;const t=null==(e=this.viewModel)?void 0:e.content;return t?"string"==typeof t?C.tsx("div",{key:t,innerHTML:t}):this.renderNodeContent(t):null},r.renderActionText=function(e){return C.tsx("span",{key:"text",class:T.actionText},e)},r.renderActionIcon=function(e){const t=this._getActionClass(e),n=this._getActionImage(e),i={[T.iconLoading]:e.active,[T.rotating]:e.active,[T.icon]:!!t,[T.actionImage]:!e.active&&!!n};return t&&(i[t]=!e.active),C.tsx("span",{key:"icon","aria-hidden":"true",class:this.classes(T.icon,i),styles:this._getIconStyles(n)})},r.renderAction=function(e){const{action:t,index:n,type:i}=e,o=this._getActionTitle(t),s={[T.action]:"toggle"!==t.type,[T.actionToggle]:"toggle"===t.type,[T.actionToggleOn]:"toggle"===t.type&&t.value,[T.buttonDisabled]:t.disabled},r=[this.renderActionIcon(t),this.renderActionText(o)],a="menu-item"===i?C.tsx("li",{key:t.uid,role:"menuitem",tabIndex:0,title:o,"aria-label":o,class:this.classes(T.button,s),onkeyup:this._handleActionMenuItemKeyup,bind:this,"data-action-index":n,onclick:this._triggerAction,onkeydown:this._triggerAction},r):C.tsx("div",{key:t.uid,role:"button",tabIndex:0,title:o,"aria-label":o,class:this.classes(T.button,s),onkeyup:this._handleActionMenuItemKeyup,bind:this,"data-action-index":n,onclick:this._triggerAction,onkeydown:this._triggerAction},r);return t.visible?a:null},r.renderFeatureMenuItem=function(e,t){const{messages:n,messagesCommon:i}=this,{selectedFeatureIndex:o,selectedFeatureViewModel:s}=this.viewModel,r=e===s,a={[T.featureMenuSelected]:r},l=r?C.tsx("span",{key:D(`feature-menu-selected-feature-${o}`),title:n.selectedFeature,"aria-label":n.selectedFeature,class:T.iconCheckMark}):null,u=C.tsx("span",{innerHTML:e.title||i.untitled});return C.tsx("li",{role:"menuitem",tabIndex:-1,key:D(`feature-menu-feature-${o}`),class:this.classes(a,T.featureMenuItem),bind:this,"data-feature-index":t,onkeyup:this._handleFeatureMenuItemKeyup,onclick:this._selectFeature,onkeydown:this._selectFeature},C.tsx("span",{class:T.featureMenuTitle},u,l))},r.renderFeatureMenu=function(){const{featureMenuId:e}=this,{featureViewModels:t}=this.viewModel;return t.length>1?C.tsx("ol",{class:T.featureMenuList,id:e,bind:this,afterCreate:this._featureMenuNodeUpdated,afterUpdate:this._featureMenuNodeUpdated,onkeyup:this._handleFeatureMenuKeyup,role:"menu"},t.filter((e=>!!e.graphic)).map(((e,t)=>this.renderFeatureMenuItem(e,t)))):null},r._getActionTitle=function(e){const{messages:t,selectedFeature:n,messagesCommon:i}=this,{id:o}=e,s=null==n?void 0:n.attributes,r="zoom-to-feature"===o?x.substitute(e.title,{messages:t}):"remove-selected-feature"===o?x.substitute(e.title,{messages:i}):"zoom-to-clustered-features"===o||"browse-clustered-features"===o?x.substitute(e.title,{messages:t}):e.title;return r&&s?x.substitute(r,s):r},r._getActionClass=function(e){const{selectedFeature:t}=this,n=null==t?void 0:t.attributes,{className:i,image:o}=e,s=o||i?i:T.iconDefaultAction;return s&&n?x.substitute(s,n):s},r._getActionImage=function(e){const{selectedFeature:t}=this,n=null==t?void 0:t.attributes,{image:i}=e;return i&&n?x.substitute(i,n):i},r._createFeatureUpdatedAnimation=function(){return A.cssTransition("enter",T.hasFeatureUpdated)},r._getInlineActionCount=function(){const{maxInlineActions:e,featureNavigationVisible:t}=this;if("number"!=typeof e)return null;const n=Math.round(e);return Math.max(t?n-1:n,0)},r._watchActions=function(){const{allActions:e}=this.viewModel;this.notifyChange("dividedActions");const t="actions";this._handles.remove(t),e&&e.forEach((e=>{this._handles.add(u.watch(e,["active","className","disabled","id","title","image","visible"],(()=>this.scheduleRender())),t)}))},r._divideActions=function(){const{allActions:e}=this.viewModel,t=this._getInlineActionCount(),n=null===t,o=0===t;return{inlineActions:n?e.slice(0):o?new i:e.slice(0,t),menuActions:n?new i:o?e.slice(0):e.slice(t)}},r._featureMenuOpenChanged=function(e){e?this._focusFirstFeature=!0:this._focusFeatureMenuButton=!0},r._actionsMenuOpenChanged=function(e){e?this._focusFirstAction=!0:this._focusActionsMenuButton=!0},r._setTitleFromFeatureWidget=function(){const{selectedFeatureWidget:e,messagesCommon:t}=this;var n,i;e&&(this.viewModel.title="error"===(null==(n=e.viewModel)?void 0:n.state)?t.errorMessage:(null==(i=e.viewModel)?void 0:i.title)||"")},r._setContentFromFeatureWidget=function(){const{selectedFeatureWidget:e}=this;e&&(this.viewModel.content=e)},r._unobserveFeatureMenuObserver=function(){this._featureMenuIntersectionObserverNode&&this._featureMenuIntersectionObserver.unobserve(this._featureMenuIntersectionObserverNode)},r._featureMenuIntersectionObserverCreated=function(e){this._unobserveFeatureMenuObserver(),this._featureMenuIntersectionObserver.observe(e),this._featureMenuIntersectionObserverNode=e},r._handleFeatureMenuKeyup=function(e){"Escape"===o.eventKey(e)&&(e.stopPropagation(),this._focusFeatureMenuButton=!0,this.featureMenuOpen=!1,this.scheduleRender())},r._handleActionMenuKeyup=function(e){"Escape"===o.eventKey(e)&&(e.stopPropagation(),this._focusActionsMenuButton=!0,this.actionsMenuOpen=!1,this.scheduleRender())},r._handleFeatureMenuItemKeyup=function(e){const t=o.eventKey(e),{_featureMenuNode:n}=this,i=e.currentTarget["data-feature-index"];if(!n)return;const s=n.querySelectorAll("li"),r=s.length;if("ArrowUp"!==t)if("ArrowDown"!==t)if("Home"!==t)if("End"!==t);else{e.stopPropagation();s[s.length-1].focus()}else{e.stopPropagation();s[0].focus()}else{e.stopPropagation();s[(i+1+r)%r].focus()}else{e.stopPropagation();s[(i-1+r)%r].focus()}},r._handleActionMenuItemKeyup=function(e){const t=o.eventKey(e),{_actionsMenuNode:n}=this,i=e.currentTarget["data-action-index"];if(!n)return;const s=n.querySelectorAll("li"),r=s.length;if("ArrowUp"!==t)if("ArrowDown"!==t)if("Home"!==t)if("End"!==t);else{e.stopPropagation();s[s.length-1].focus()}else{e.stopPropagation();s[0].focus()}else{e.stopPropagation();s[(i+1+r)%r].focus()}else{e.stopPropagation();s[(i-1+r)%r].focus()}},r._handleMainKeyup=function(e){const t=o.eventKey(e);"ArrowLeft"===t&&(e.stopPropagation(),this.previous()),"ArrowRight"===t&&(e.stopPropagation(),this.next())},r._spinnerEnabledChange=function(e){if(this._destroySpinner(),!e)return;const t=this.get("viewModel.view");this._createSpinner(t)},r._hideSpinner=function(){const{_spinner:e}=this;e&&(e.location=null,e.hide())},r._displaySpinner=function(){const{_spinner:e}=this;if(!e)return;const{location:t,waitingForResult:n}=this.viewModel;n?e.show({location:t}):e.hide()},r._getIconStyles=function(e){return{"background-image":e?`url(${e})`:""}},r._addSelectedFeatureIndexHandle=function(){const e=u.watch(this,"viewModel.selectedFeatureIndex",((e,t)=>this._selectedFeatureIndexUpdated(e,t)));this._handles.add(e,F)},r._selectedFeatureIndexUpdated=function(e,t){const{featureCount:n}=this;n&&e!==t&&-1!==e&&(this.actionsMenuOpen=!1,this.featureMenuOpen=!1)},r._destroySelectedFeatureWidget=function(){const{_feature:e}=this;e&&(e.viewModel=null,e&&!e.destroyed&&e.destroy()),this._feature=null},r._isScreenLocationWithinView=function(e,t){return e.x>-1&&e.y>-1&&e.x<=t.width&&e.y<=t.height},r._isOutsideView=function(e){const{popupHeight:t,popupWidth:n,screenLocation:i,side:o,view:s}=e;if(isNaN(n)||isNaN(t)||!s||!i)return!1;const r=s.padding;return"right"===o&&i.x+n/2>s.width-r.right||("left"===o&&i.x-n/2<r.left||("top"===o&&i.y-t<r.top||"bottom"===o&&i.y+t>s.height-r.bottom))},r._calculateAutoAlignment=function(e){if("auto"!==e)return e;const{_pointerOffsetInPx:t,_containerNode:n,_mainContainerNode:i,viewModel:o}=this,{screenLocation:s,view:r}=o;if(a.isNone(s)||!r||!n)return"top-center";if(!this._isScreenLocationWithinView(s,r))return this._get("currentAlignment")||"top-center";function l(e){return parseInt(e.replace(/[^-\d\.]/g,""),10)}const u=i?window.getComputedStyle(i,null):null,c=u?l(u.getPropertyValue("max-height")):0,d=u?l(u.getPropertyValue("height")):0,{height:p,width:h}=n.getBoundingClientRect(),_=h+t,f=Math.max(p,c,d)+t,g=this._isOutsideView({popupHeight:f,popupWidth:_,screenLocation:s,side:"right",view:r}),v=this._isOutsideView({popupHeight:f,popupWidth:_,screenLocation:s,side:"left",view:r}),b=this._isOutsideView({popupHeight:f,popupWidth:_,screenLocation:s,side:"top",view:r}),M=this._isOutsideView({popupHeight:f,popupWidth:_,screenLocation:s,side:"bottom",view:r});return v?b?"bottom-right":"top-right":g?b?"bottom-left":"top-left":b?M?"top-center":"bottom-center":"top-center"},r._callCurrentAlignment=function(e){return"function"==typeof e?e.call(this):e},r._getCurrentAlignment=function(){const{alignment:e,dockEnabled:t}=this;return t||!this.viewModel.active?null:this._calculatePositionResult(this._calculateAutoAlignment(this._callCurrentAlignment(e)))},r._setCurrentAlignment=function(){this._set("currentAlignment",this._getCurrentAlignment())},r._setCurrentDockPosition=function(){this._set("currentDockPosition",this._getCurrentDockPosition())},r._calculatePositionResult=function(e){const t=["left","right"];return A.isRTL(this.container)&&t.reverse(),e.replace(/leading/gi,t[0]).replace(/trailing/gi,t[1])},r._callDockPosition=function(e){return"function"==typeof e?e.call(this):e},r._getDockPosition=function(){var e;return this._calculatePositionResult(this._calculateAutoDockPosition(this._callDockPosition(null==(e=this.dockOptions)?void 0:e.position)))},r._getCurrentDockPosition=function(){return this.dockEnabled&&this.viewModel.active?this._getDockPosition():null},r._wouldDockTo=function(){return this.dockEnabled?null:this._getDockPosition()},r._calculateAutoDockPosition=function(e){var t;if("auto"!==e)return e;const n=null==(t=this.viewModel)?void 0:t.view,i=A.isRTL(this.container)?"top-left":"top-right";if(!n)return i;const o=n.padding||{left:0,right:0,top:0,bottom:0},s=n.width-o.left-o.right,{breakpoints:r}=n;return r&&s<=r.xsmall?"bottom-center":i},r._positionContainer=function(e=this._containerNode){if(e&&(this._containerNode=e),!e)return;const{screenLocation:t}=this.viewModel,{width:n}=e.getBoundingClientRect(),i=this._calculatePositionStyle(t,n);i&&(e.style.top=i.top,e.style.left=i.left,e.style.bottom=i.bottom,e.style.right=i.right)},r._calculateFullWidth=function(e){const{currentAlignment:t,_pointerOffsetInPx:n}=this;return"top-left"===t||"bottom-left"===t||"top-right"===t||"bottom-right"===t?e+n:e},r._calculateAlignmentPosition=function(e,t,n,i){const{currentAlignment:o,_pointerOffsetInPx:s}=this,r=i/2,a=n.height-t,l=n.width-e,{padding:u}=this.view;return"bottom-center"===o?{top:t+s-u.top,left:e-r-u.left}:"top-left"===o?{bottom:a+s-u.bottom,right:l+s-u.right}:"bottom-left"===o?{top:t+s-u.top,right:l+s-u.right}:"top-right"===o?{bottom:a+s-u.bottom,left:e+s-u.left}:"bottom-right"===o?{top:t+s-u.top,left:e+s-u.left}:"top-center"===o?{bottom:a+s-u.bottom,left:e-r-u.left}:void 0},r._calculatePositionStyle=function(e,t){const{dockEnabled:n,view:i}=this;if(!i)return;if(n)return{left:"",top:"",right:"",bottom:""};if(a.isNone(e)||!t)return;const o=this._calculateFullWidth(t),s=this._calculateAlignmentPosition(e.x,e.y,i,o);return s?{top:void 0!==s.top?`${s.top}px`:"auto",left:void 0!==s.left?`${s.left}px`:"auto",bottom:void 0!==s.bottom?`${s.bottom}px`:"auto",right:void 0!==s.right?`${s.right}px`:"auto"}:void 0},r._viewChange=function(e,t){e&&t&&(this.close(),this.clear())},r._viewReadyChange=function(e,t){if(e){const e=this.get("viewModel.view");this._wireUpView(e)}else t&&(this.close(),this.clear())},r._wireUpView=function(e){if(this._destroySpinner(),!e)return;const{spinnerEnabled:t}=this;t&&this._createSpinner(e),this._setDockEnabledForViewSize(this.dockOptions)},r._dockingThresholdCrossed=function(e,t,n){const[i,o]=e,[s,r]=t,{width:a,height:l}=n;return i<=a&&s>a||i>a&&s<=a||o<=l&&r>l||o>l&&r<=l},r._updateDockEnabledForViewSize=function(e,t){if(!e||!t)return;const n=this.get("viewModel.view.padding")||{left:0,right:0,top:0,bottom:0},i=n.left+n.right,o=n.top+n.bottom,s=[],r=[];s[0]=e[0]-i,s[1]=e[1]-o,r[0]=t[0]-i,r[1]=t[1]-o;const{dockOptions:a}=this,l=a.breakpoint;this._dockingThresholdCrossed(s,r,l)&&this._setDockEnabledForViewSize(a),this._setCurrentDockPosition()},r._focusDockButtonNode=function(e){this._focusDockButton&&(this._focusDockButton=!1,e.focus())},r._closeButtonNodeUpdated=function(e){return this._focusClose?(this._focusClose=!1,void e.focus()):this._blurClose?(this._blurClose=!1,void e.blur()):void 0},r._mainContainerNodeUpdated=function(e){return this._mainContainerNode=e,this._focusContainer?(this._focusContainer=!1,void e.focus()):this._blurContainer?(this._blurContainer=!1,void e.blur()):void 0},r._featureMenuNodeUpdated=function(e){if(this._featureMenuNode=e,!e||!this._focusFirstFeature)return;this._focusFirstFeature=!1;const t=e.querySelectorAll("li");if(t.length){t[0].focus()}},r._actionsMenuNodeUpdated=function(e){if(this._actionsMenuNode=e,!e||!this._focusFirstAction)return;this._focusFirstAction=!1;const t=e.querySelectorAll("li");if(t.length){t[0].focus()}},r._focusFeatureMenuButtonNode=function(e){this._focusFeatureMenuButton&&(this._focusFeatureMenuButton=!1,e.focus())},r._focusActionsMenuButtonNode=function(e){this._focusActionsMenuButton&&(this._focusActionsMenuButton=!1,e.focus())},r._featureMenuViewportScrollTop=function(){this._featureMenuViewportNode&&(this._featureMenuViewportNode.scrollTop=0)},r._toggleScreenLocationEnabled=function(){const{dockEnabled:e,viewModel:t}=this;if(!t)return;const n=t.active&&!e;t.screenLocationEnabled=n},r._shouldDockAtCurrentViewSize=function(e){var t,n;const i=e.breakpoint,o=null==(t=this.viewModel)||null==(n=t.view)?void 0:n.ui;if(!o)return!1;const{width:s,height:r}=o;if(isNaN(s)||isNaN(r))return!1;const a=i.hasOwnProperty("width")&&s<=i.width,l=i.hasOwnProperty("height")&&r<=i.height;return a||l},r._setDockEnabledForViewSize=function(e){e.breakpoint&&(this.dockEnabled=this._shouldDockAtCurrentViewSize(e))},r._getPageText=function(e,t){return this.featureNavigationVisible?x.substitute(this.messages.pageText,{index:t+1,total:e}):null},r._destroySpinner=function(){const{_spinner:e,view:t}=this;e&&(t&&t.ui&&t.ui.remove(this._spinner,O),e.destroy(),this._spinner=null)},r._createSpinner=function(e){e&&(this._spinner=new g({view:e}),e.ui.add(this._spinner,{key:O,position:"manual"}))},r._toggleCollapsed=function(){this.collapsed=!this.collapsed},r._close=function(){this.close(),this.view&&this.view.focus()},r._toggleDockEnabled=function(){this.dockEnabled=!this.dockEnabled,this._focusDockButton=!0,this.scheduleRender()},r._toggleFeatureMenu=function(){const e=!this.featureMenuOpen;this._featureMenuOpenChanged(e),this.actionsMenuOpen=!1,this.featureMenuOpen=e},r._toggleActionsMenu=function(){const e=!this.actionsMenuOpen;this._actionsMenuOpenChanged(e),this.featureMenuOpen=!1,this.actionsMenuOpen=e},r._triggerAction=function(e){const t=e.currentTarget["data-action-index"],n=this.viewModel.allActions.getItemAt(t);n&&"toggle"===n.type&&(n.value=!n.value),this.actionsMenuOpen=!1,this.viewModel.triggerAction(t)},r._selectFeature=function(e){const t=e.currentTarget["data-feature-index"];isNaN(t)||(this.viewModel.selectedFeatureIndex=t),this.featureMenuOpen=!1,this._focusFeatureMenuButton=!0,this.scheduleRender()},r._next=function(){this.next()},r._previous=function(){this.previous()},e._createClass(n,[{key:"actionsMenuId",get:function(){return`${this.id}-actions-menu`}},{key:"actionsMenuButtonId",get:function(){return`${this.id}-actions-menu-button`}},{key:"featureMenuId",get:function(){return`${this.id}-feature-menu`}},{key:"titleId",get:function(){return`${this.id}-popup-title`}},{key:"contentId",get:function(){return`${this.id}-popup-content`}},{key:"hasContent",get:function(){var e,t,n,i,o,s,r;return!!(this.selectedFeatureWidget?(null==(e=this.selectedFeatureWidget)||null==(t=e.viewModel)?void 0:t.waitingForContent)||"error"===(null==(n=this.selectedFeatureWidget)||null==(i=n.viewModel)?void 0:i.state)||(null==(o=this.selectedFeatureWidget)||null==(s=o.viewModel)?void 0:s.content):null==(r=this.viewModel)?void 0:r.content)}},{key:"featureNavigationVisible",get:function(){return this.viewModel.active&&this.viewModel.featureCount>1&&this.visibleElements.featureNavigation}},{key:"collapsible",get:function(){return!!(this.collapseEnabled&&this.viewModel.title&&this.hasContent)}},{key:"featureMenuVisible",get:function(){return this.featureNavigationVisible&&this.featureMenuOpen}},{key:"contentCollapsed",get:function(){return this.collapsible&&!this.featureMenuVisible&&this.collapsed}},{key:"dividedActions",get:function(){return this._divideActions()}},{key:"actionsMenuOpen",get:function(){return!!this.viewModel.active&&this._get("actionsMenuOpen")},set:function(e){this._set("actionsMenuOpen",!!e)}},{key:"currentAlignment",get:function(){return this._getCurrentAlignment()}},{key:"currentDockPosition",get:function(){return this._getCurrentDockPosition()}},{key:"dockOptions",get:function(){return this._get("dockOptions")||N},set:function(e){const t={...N},n=this.get("viewModel.view.breakpoints"),i={};n&&(i.width=n.xsmall,i.height=n.xsmall);const o={...t,...e},s={...t.breakpoint,...i},{breakpoint:r}=o;!0===r?o.breakpoint=s:"object"==typeof r&&(o.breakpoint={...s,...r}),this._set("dockOptions",o),this._setCurrentDockPosition(),this.reposition()}},{key:"selectedFeatureWidget",get:function(){const{_feature:e,visibleElements:t,headingLevel:n}=this,{selectedFeatureViewModel:i}=this.viewModel,o={...t,title:!1};return i?(e?(e.viewModel=i,e.visibleElements=o):this._feature=new f({headingLevel:n+1,viewModel:i,visibleElements:o}),this._feature):null}}]),n}(b.FeatureContentMixin(v));return t.__decorate([h.property({readOnly:!0})],S.prototype,"actionsMenuId",null),t.__decorate([h.property({readOnly:!0})],S.prototype,"actionsMenuButtonId",null),t.__decorate([h.property({readOnly:!0})],S.prototype,"featureMenuId",null),t.__decorate([h.property({readOnly:!0})],S.prototype,"titleId",null),t.__decorate([h.property({readOnly:!0})],S.prototype,"contentId",null),t.__decorate([h.property({readOnly:!0})],S.prototype,"hasContent",null),t.__decorate([h.property({readOnly:!0})],S.prototype,"featureNavigationVisible",null),t.__decorate([h.property({readOnly:!0})],S.prototype,"collapsible",null),t.__decorate([h.property({readOnly:!0})],S.prototype,"featureMenuVisible",null),t.__decorate([h.property({readOnly:!0})],S.prototype,"contentCollapsed",null),t.__decorate([h.property({readOnly:!0})],S.prototype,"dividedActions",null),t.__decorate([c.aliasOf("viewModel.actions")],S.prototype,"actions",void 0),t.__decorate([h.property()],S.prototype,"actionsMenuOpen",null),t.__decorate([h.property()],S.prototype,"alignment",void 0),t.__decorate([c.aliasOf("viewModel.autoCloseEnabled")],S.prototype,"autoCloseEnabled",void 0),t.__decorate([c.aliasOf("viewModel.autoOpenEnabled")],S.prototype,"autoOpenEnabled",void 0),t.__decorate([c.aliasOf("viewModel.defaultPopupTemplateEnabled")],S.prototype,"defaultPopupTemplateEnabled",void 0),t.__decorate([c.aliasOf("viewModel.content")],S.prototype,"content",void 0),t.__decorate([h.property()],S.prototype,"collapsed",void 0),t.__decorate([h.property()],S.prototype,"collapseEnabled",void 0),t.__decorate([h.property({readOnly:!0})],S.prototype,"currentAlignment",null),t.__decorate([h.property({readOnly:!0})],S.prototype,"currentDockPosition",null),t.__decorate([h.property()],S.prototype,"dockOptions",null),t.__decorate([h.property()],S.prototype,"dockEnabled",void 0),t.__decorate([c.aliasOf("viewModel.featureCount")],S.prototype,"featureCount",void 0),t.__decorate([h.property()],S.prototype,"featureMenuOpen",void 0),t.__decorate([c.aliasOf("viewModel.features")],S.prototype,"features",void 0),t.__decorate([c.aliasOf("viewModel.goToOverride")],S.prototype,"goToOverride",void 0),t.__decorate([h.property()],S.prototype,"headingLevel",void 0),t.__decorate([c.aliasOf("viewModel.highlightEnabled")],S.prototype,"highlightEnabled",void 0),t.__decorate([c.aliasOf("viewModel.location")],S.prototype,"location",void 0),t.__decorate([h.property({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],S.prototype,"label",void 0),t.__decorate([h.property()],S.prototype,"maxInlineActions",void 0),t.__decorate([h.property(),y.messageBundle("esri/widgets/Popup/t9n/Popup")],S.prototype,"messages",void 0),t.__decorate([h.property(),y.messageBundle("esri/t9n/common")],S.prototype,"messagesCommon",void 0),t.__decorate([c.aliasOf("viewModel.promises")],S.prototype,"promises",void 0),t.__decorate([c.aliasOf("viewModel.selectedFeature")],S.prototype,"selectedFeature",void 0),t.__decorate([c.aliasOf("viewModel.selectedFeatureIndex")],S.prototype,"selectedFeatureIndex",void 0),t.__decorate([h.property({readOnly:!0})],S.prototype,"selectedFeatureWidget",null),t.__decorate([h.property()],S.prototype,"spinnerEnabled",void 0),t.__decorate([c.aliasOf("viewModel.title")],S.prototype,"title",void 0),t.__decorate([c.aliasOf("viewModel.updateLocationEnabled")],S.prototype,"updateLocationEnabled",void 0),t.__decorate([c.aliasOf("viewModel.view")],S.prototype,"view",void 0),t.__decorate([h.property({type:M}),k.vmEvent(["triggerAction","trigger-action"])],S.prototype,"viewModel",void 0),t.__decorate([c.aliasOf("viewModel.visible")],S.prototype,"visible",void 0),t.__decorate([h.property()],S.prototype,"visibleElements",void 0),t.__decorate([p.cast("visibleElements")],S.prototype,"castVisibleElements",null),t.__decorate([w.accessibleHandler()],S.prototype,"_close",null),t.__decorate([w.accessibleHandler()],S.prototype,"_toggleDockEnabled",null),t.__decorate([w.accessibleHandler()],S.prototype,"_toggleFeatureMenu",null),t.__decorate([w.accessibleHandler()],S.prototype,"_toggleActionsMenu",null),t.__decorate([w.accessibleHandler()],S.prototype,"_triggerAction",null),t.__decorate([w.accessibleHandler()],S.prototype,"_selectFeature",null),t.__decorate([w.accessibleHandler()],S.prototype,"_next",null),t.__decorate([w.accessibleHandler()],S.prototype,"_previous",null),S=t.__decorate([_.subclass(E)],S),S}));
