// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["../Color","./ColorPicker/HexPalette","./support/colorUtils","./Widgette","../core/lang","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/a11yclick","dojo/dom-class","dojo/dom-construct","dojo/dom-style","dojo/on","dojo/query","dojo/i18n!./ColorPicker/nls/ColorPicker","dojo/i18n!../nls/common","dojo/text!./ColorPicker/templates/ColorPicker.html","dojo/NodeList-dom"],function(t,e,o,s,r,i,a,l,n,c,h,d,u,_,p,g){var C={root:"esri-color-picker",container:"esri-container",header:"esri-header",footer:"esri-footer",middle:"esri-middle",swatch:"esri-swatch",swatchRow:"esri-swatch-row",swatchEmpty:"esri-swatch-empty",swatchPreview:"esri-swatch-preview",swatchTransparencyBackground:"esri-swatch-transparency-background",palette:"esri-palette",paletteOptions:"esri-palette-options",paletteToggle:"esri-palette-toggle",label:"esri-label",hexInput:"esri-hex-input",recent:"esri-recent",suggested:"esri-suggested",selected:"esri-selected",disabled:"esri-disabled",section:"esri-section",transparencySlider:"esri-transparency-slider",ticks:"esri-color-picker-ticks",alt:"esri-alt",hidden:"esri-hidden"};return s.createSubclass([i,a],{declaredClass:"esri.widgets.ColorPicker",templateString:g,labels:_,baseClass:C.root,css:C,constructor:function(t){t=t||{},this._brightsPalette=new e({colors:t.palette}),this._pastelsPalette=new e({colors:this._toPastels(this._brightsPalette.colors)}),this._activePalette=this._brightsPalette,this._swatches={}},buildRendering:function(){this.inherited(arguments),this._createPalettes(),this.required||(this._noColorSwatchNode=c.create("div",{className:C.swatch+" "+C.swatchEmpty},this.dap_hexInput,"after")),this._addTicks(this.dap_ticks),n.toggle(this.dap_transparencySection,C.hidden,!this.showTransparencySlider),n.toggle(this.dap_recentColorSection,C.hidden,!this.showRecentColors),n.toggle(this.dap_suggestedColorSection,C.hidden,!this.showSuggestedColors)},postCreate:function(){this.inherited(arguments),this._addListeners(),this._selectColor()},_activePalette:null,_brightsPalette:null,_pastelsPalette:null,_swatches:null,_noColorSwatchNode:null,_previousColor:null,color:null,_getColorAttr:function(){var e=this._get("color");return null===e?null:new t(e)},_setColorAttr:function(e,s){if(e=e||null,s=s||void 0===s,!this.required){if(null===e)return this._set("color",null),this._previousColor=null,this.dap_transparencySlider.value=0,this._disableTransparencySlider(),this._clearSelection(),this._updateHexInput(null),this._updatePreviewSwatch(e),n.add(this._noColorSwatchNode,C.selected),void(s&&this.emit("color-change",{color:null}));this._enableTransparencySlider(),n.remove(this._noColorSwatchNode,C.selected)}var r,i=o.normalizeColor(e),a=this._previousColor;if(a){if(o.equal(a,i))return;var l=this._findColorSwatch(a);l&&(n.remove(l,C.selected),h.set(l,"borderColor",""))}r=new t(i),this._set("color",r),this._previousColor=i,this.dap_transparencySlider.value=1-r.a,this._updatePreviewSwatch(r),this._checkSelection(),this._updateHexInput(r),this.trackColors&&this._addRecentColor(r.toHex()),s&&this.emit("color-change",{color:new t(r)})},colorsPerRow:13,_setColorsPerRowAttr:function(t){var e=t>0?t:13;this._set("colorsPerRow",e)},_setPaletteAttr:function(t){var e=this._activePalette===this._brightsPalette;this._brightsPalette.colors=t,this._pastelsPalette.colors=this._toPastels(this._brightsPalette.colors),this._activePalette=e?this._brightsPalette:this._pastelsPalette,this._createPalettes(),this._togglePalette(!e)},recentColors:[],_getRecentColorsAttr:function(){return this._get("recentColors").map(function(t){return o.normalizeColor(t)})},_setRecentColorsAttr:function(t){var e=t||[];this.showRecentColors&&(e=e.map(function(t){return o.normalizeColor(t).toHex()})),this._set("recentColors",e),0===e.length?this._clearRecentSwatches():this._renderRecentSwatches()},required:!1,showRecentColors:!0,showSuggestedColors:!1,showTransparencySlider:!0,suggestedColors:null,_getSuggestedColorsAttr:function(){return this._get("suggestedColors").map(function(t){return o.normalizeColor(t)})},_setSuggestedColorsAttr:function(t){if(this.showSuggestedColors){this._clearSuggestedSwatches();var e=t||[];e=e.map(function(t){return o.normalizeColor(t).toHex()}),this._set("suggestedColors",e),e.length>0&&this._renderSuggestedSwatches()}},trackColors:!0,addRecentColor:function(t){t&&null!==t&&this._addRecentColor(o.normalizeColor(t).toHex())},saveRecentColors:function(t){localStorage.setItem(t,JSON.stringify(this.get("recentColors")))},loadRecentColors:function(t){this.set("recentColors",JSON.parse(localStorage.getItem(t)))},_addTicks:function(t){var e=[0,50,100],o=document.createDocumentFragment();e.forEach(function(t){c.create("span",{innerHTML:r.substitute({percent:t},p.percent)},o)}),t.appendChild(o)},_toPastels:function(e){var o=new t([238,238,238]);return e.map(function(e){return t.blendColors(new t(e),o,.2)})},_createSwatch:function(t){var e=t.className,o=t.hexColor||"transparent",s=t.paletteNode;return c.create("span",{className:e,style:{backgroundColor:o}},s)},_createSwatches:function(t,e){var o;e.colors.forEach(function(e,s){var r;s%this.colorsPerRow==0&&(o=c.create("div",{className:C.swatchRow},t)),r=this._createSwatch({className:C.swatch,hexColor:e,paletteNode:o}),this._swatches[e]=r},this)},_selectColor:function(){this.set("color",this.required?this.color||this._activePalette.colors[0]:this.color)},_setColorWithCurrentAlpha:function(t){null!==t&&null!==this.color&&(t=o.normalizeColor(t),t.a=this.color.a),this.set("color",t)},_updatePreviewSwatch:function(t){var e,s=this.dap_previewSwatch;if(null===t)return n.add(s,C.swatchEmpty),void h.set(s,{backgroundColor:"",borderColor:""});e=o.getContrastingColor(t),n.remove(s,C.swatchEmpty),h.set(s,{backgroundColor:t.toCss(!0),borderColor:e.toCss(!0)})},_showBrights:function(){n.remove(this.dap_paletteContainer,C.alt),this._activePalette=this._brightsPalette},_showPastels:function(){n.add(this.dap_paletteContainer,C.alt),this._activePalette=this._pastelsPalette},_setColorFromSwatch:function(t){var e=h.get(t,"backgroundColor");this._setColorWithCurrentAlpha(e)},_checkSelection:function(){var t=this.get("color");this._activePalette.contains(t)?this._highlightColor(t):this._clearSelection()},_addListeners:function(){var t="."+C.swatch;this.own(d(this.dap_paletteContainer,d.selector(t,"click"),function(t){this._setColorFromSwatch(t.target)}.bind(this)),d(this.dap_recentColorPalette,d.selector(t,"click"),function(t){this._setColorFromSwatch(t.target)}.bind(this)),d(this.dap_suggestedColorPalette,d.selector(t,"click"),function(t){this._setColorFromSwatch(t.target)}.bind(this))),this.required||this.own(d(this._noColorSwatchNode,"click",function(){this.set("color",null)}.bind(this)));var e=this.dap_hexInput;d(e,"blur",function(){var t=o.normalizeHex(e.value);if(o.isShorthandHex(t))return void this._setColorWithCurrentAlpha(t);this._updateHexInput(this.color)}.bind(this)),d(e,"change",function(){var t=o.normalizeHex(e.value);o.isLonghandHex(t)&&this.color.toHex()!==t&&this._setColorWithCurrentAlpha(t)}.bind(this)),d(this.dap_transparencySlider,"change, input",function(t){var e,s=this.get("color");null!==s&&(e=o.normalizeColor(s),e.a=1-t.target.value,this._updatePreviewSwatch(e),this._updateHexInput(e),this.set("color",e))}.bind(this)),d(this.dap_paletteToggle,l,function(t){var e="true"===t.target.getAttribute("aria-pressed");this._togglePalette(!e)}.bind(this))},_togglePalette:function(t){this.dap_paletteToggle.setAttribute("aria-pressed",t),t?this._showPastels():this._showBrights(),this._checkSelection()},_createPalettes:function(){this._swatches={},c.empty(this.dap_primaryPalette),c.empty(this.dap_secondaryPalette),this._createSwatches(this.dap_primaryPalette,this._brightsPalette),this._createSwatches(this.dap_secondaryPalette,this._pastelsPalette)},_updateHexInput:function(t){this.dap_hexInput.value=null===t?"":t.toHex()},_addRecentColor:function(t){if(t){var e=this.recentColors,o=e.indexOf(t);o>-1&&e.splice(o,1),e.unshift(t),e.length>this.colorsPerRow&&e.pop(),this._renderRecentSwatches()}},_renderRecentSwatches:function(){if(this.recentColors){var t="."+C.recent+"."+C.swatch,e=u(t,this.dap_recentColorPalette);this.recentColors.forEach(function(t,o){if(o<this.colorsPerRow){if(o+1>e.length){var s=this._createSwatch({hexColor:t,className:C.swatch+" "+C.recent,paletteNode:this.dap_recentColorPalette});e.push(s)}h.set(e[o],"backgroundColor",t)}},this)}},_renderSuggestedSwatches:function(){if(this.suggestedColors){var t="."+C.suggested+"."+C.swatch,e=u(t,this.dap_recentColorPalette);this.suggestedColors.forEach(function(t,o){if(o<this.colorsPerRow){if(o+1>e.length){var s=this._createSwatch({hexColor:t,className:C.swatch+" "+C.suggested,paletteNode:this.dap_suggestedColorPalette});e.push(s)}h.set(e[o],"backgroundColor",t)}},this)}},_clearRecentSwatches:function(){c.empty(this.dap_recentColorPalette)},_clearSuggestedSwatches:function(){c.empty(this.dap_suggestedColorPalette)},_clearSelection:function(){u("."+C.selected,this.dap_paletteContainer).removeClass(C.selected)},_highlightColor:function(t){var e,s=this._findColorSwatch(t);s&&(t=o.normalizeColor(t),e=o.getContrastingColor(t),n.add(s,C.selected),h.set(s,"borderColor",e.toHex()))},_findColorSwatch:function(t){var e,s=this._activePalette.colors,r=o.toHex(t);return s.indexOf(r)>-1&&(e=this._swatches[r]),e},_enableTransparencySlider:function(){this.dap_transparencySlider.disabled=!1},_disableTransparencySlider:function(){this.dap_transparencySlider.disabled=!0}})});