/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/asyncUtils","../../core/Collection","../../core/Error","../../core/HandleOwner","../../core/maybe","../../core/promiseUtils","../../core/reactiveUtils","../../core/time","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/accessorSupport/decorators/subclass","../../webdoc/Widgets","../../webdoc/widgets/FloorFilter","../support/GoTo"],(function(e,t,i,l,r,s,o,n,a,c,u,f,d,h,y,p,v){"use strict";function _(e){return"esri.WebMap"===e.declaredClass}function F(e){return"esri.WebScene"===e.declaredClass}let m=function(t){function s(e){var i;return(i=t.call(this,e)||this).filterMenuOpen=!1,i.filterMenuType="site",i.filterMode="base-floors",i.levelsExpanded=!0,i.searchTerm=null,i.view=null,i._updateFloorFilterTask=null,i}e._inheritsLoose(s,t);var u=s.prototype;return u.initialize=function(){var t=this;this.handles.add([a.watch((()=>this.view?.map),(l=>{o.isSome(this._updateFloorFilterTask)&&(this._updateFloorFilterTask.abort(),this._updateFloorFilterTask=null),this._updateFloorFilterTask=i.createTask(function(){var i=e._asyncToGenerator((function*(e){yield t._updateFloorFilterFromMap(l),n.throwIfAborted(e),t._setInitialViewState(l)}));return function(e){return i.apply(this,arguments)}}())}),a.initial),a.watch((()=>this.view),((e,t)=>{this._unregisterWidget(t),this._registerWidget(e),this._watchSearchResults(e)}),a.syncAndInitial),a.watch((()=>this.view?.widthBreakpoint),(e=>{this._viewWidthBreakpoint=e})),a.watch((()=>this.view?.heightBreakpoint),(e=>{this._viewHeightBreakpoint=e}))])},u.destroy=function(){this._unregisterWidget(this.view),this.view=null,o.isSome(this._updateFloorFilterTask)&&(this._updateFloorFilterTask.abort(),this._updateFloorFilterTask=null)},u.filterFacilities=function(e){let t=e;this.searchTerm&&(t=e.filter((e=>{const{name:t}=e;return t.toLowerCase().includes(this.searchTerm.toLowerCase())}))),this.site&&(t=t.filter((e=>e.siteId===this.site)));return t.sort(((e,t)=>{const i=e.name,l=t.name;return i>l?1:i===l?0:-1}))},u.filterSites=function(e){let t=e;this.searchTerm&&(t=e.filter((e=>{const{name:t}=e;return t.toLowerCase().includes(this.searchTerm.toLowerCase())})));return t.sort(((e,t)=>{const i=e.name,l=t.name;return i>l?1:i===l?0:-1}))},u.getBaseLevel=function(e){const t=this.filterFeatures?.levels?.levelsInfo;let i=null;if(e){const{id:l}=e;if(t&&t.length>0&&(t.forEach((e=>{0===e.verticalOrder&&e.facilityId===l&&(i=e)})),!i)){let e=null;t.forEach((t=>{t.facilityId===l&&(e?t.verticalOrder>=0?(e.verticalOrder<0||t.verticalOrder<e.verticalOrder)&&(e=t):e.verticalOrder<0&&t.verticalOrder>e.verticalOrder&&(e=t):e=t)})),e&&(i=e)}}return i},u.getFacility=function(e){return this.filterFeatures?.facilities?.facilitiesInfo?.find((t=>t.id===e))??null},u.getFacilityLevels=function(e){if(!e||!this.filterFeatures?.levels?.levelsInfo)return[];return this.filterFeatures.levels.levelsInfo.filter((t=>t.facilityId===e)).sort(((e,t)=>{const i=e.verticalOrder,l=t.verticalOrder;return i>l?-1:i===l?0:1}))},u.getLevel=function(e){return this.filterFeatures?.levels?.levelsInfo?.find((t=>t.id===e))??null},u.getSite=function(e){return this.filterFeatures?.sites?.sitesInfo?.find((t=>t.id===e))??null},u.goTo=function(e){const{view:t}=this;if(!t||!e)return;const{geometry:i}=e;if(i&&i.extent){const e={duration:c.Milliseconds(1e3),easing:"out-back"},t={target:i.extent,options:e};this.callGoTo(t)}},u.setFloors=function(e){this.view?.map?.allLayers?.forEach((e=>{"feature"===e.type&&this._computeViewAllModeFloors(e)})),this.view.floors=new l(this._computeFloors(e))},u.updateWebDocument=function(e){if(_(e)){const t=new p({enabled:this.enabled,longNames:this.longNames,minimized:this.minimized,pinnedLevels:this.pinnedLevels,site:this.site??null,facility:this.facility??null,level:this.level??null});e.widgets?e.widgets.floorFilter=t:e.widgets=new y({floorFilter:t})}},u._computeFloors=function(e){if("single-floor"===this.filterMode)this._computeSingleFloor(e);else if("base-floors"===this.filterMode)return"3d"===this.view.type?this._computeBaseFloors3D(e):this._computeBaseFloors(e);return this._computeEmptyFloors()},u._computeSingleFloor=function(e){if(!e)return this._computeEmptyFloors();const t=[];if("all"===e?.id){this.getFacilityLevels(e.facilityId).forEach((e=>{e.id&&t.push(e.id)}))}else e&&t.push(e.id);return t},u._computeBaseFloors=function(e){const t=this.filterFeatures?.levels?.levelsInfo;if(!t||!t.length)return this._computeEmptyFloors();const i=[];if("all"===e?.id){this.getFacilityLevels(e.facilityId).forEach((e=>{e.id&&i.push(e.id)}))}else e&&i.push(e.id);const l=e?.facilityId;return t.forEach((e=>{const{id:t,facilityId:r,verticalOrder:s}=e;(l||0!==s||i.includes(t))&&(r===l||0!==s||i.includes(t))||i.push(t)})),i},u._computeBaseFloors3D=function(e){const t=this.filterFeatures?.levels?.levelsInfo;if(!t||!t.length)return this._computeEmptyFloors();const i=[],l=e?.id.split("--");if(l?.length>1&&"all"===l[0]){this.getFacilityLevels(e.facilityId).forEach((e=>{e.id&&i.push(e.id)}))}else e&&i.push(e.id);const r=e?.facilityId;return t.forEach((e=>{const{id:t,facilityId:l}=e;(r||i.includes(t))&&(l===r||i.includes(t))||i.push(t)})),i},u._computeEmptyFloors=function(){return[]},u._setFilterLayers=function(){var t=e._asyncToGenerator((function*(){const{view:e}=this;if(!this._isOverridden("filterLayers")){if(!_(e.map)&&!F(e.map))throw new r("Map must be a webmap or webscene");{const t=e.map,i=t?.allLayers;if(i?.items?.length>0){const e={siteLayer:null,facilityLayer:null,levelLayer:null},l=t.floorInfo?.siteLayer?.layerId,r=t.floorInfo?.facilityLayer?.layerId,s=t.floorInfo?.levelLayer?.layerId,o=t.floorInfo?.siteLayer?.sublayerId||t.floorInfo?.facilityLayer?.sublayerId||t.floorInfo?.levelLayer?.sublayerId;if(!r||!s)return;const n=i.items.filter((e=>"feature"===e.type||"scene"===e.type)),a=i.items.filter((e=>"map-image"===e.type));if(a?.length>0&&o){yield Promise.all(a.map((e=>e.load())));const i=t.floorInfo?.siteLayer?.sublayerId,o=t.floorInfo?.facilityLayer?.sublayerId,n=t.floorInfo?.levelLayer?.sublayerId;a.forEach((t=>{const a=t.id,c=t?.allSublayers,u=c?.items;(a===l||a===r||a===s)&&u?.length>0&&c.items.forEach((t=>{const r=t.id;a===l&&r===i?e.siteLayer=t:r===o?e.facilityLayer=t:r===n&&(e.levelLayer=t)}))}))}n?.length>0&&n.forEach((t=>{const i=t.id;i===l?e.siteLayer=t:i===r?e.facilityLayer=t:i===s&&(e.levelLayer=t)})),this.filterLayers=e}}}}));function i(){return t.apply(this,arguments)}return i}(),u._getFilterFeatures=function(){var t=e._asyncToGenerator((function*(){if(this._isOverridden("filterFeatures"))return this.filterFeatures;const e={sites:null,facilities:null,levels:null},t=yield this._getSites();e.sites=t;const i=yield this._getFacilities();e.facilities=i;const l=yield this._getLevels();return e.levels=l,e}));function i(){return t.apply(this,arguments)}return i}(),u._getSites=function(){var t=e._asyncToGenerator((function*(){const{filterLayers:e,view:t}=this,i=t.map,{siteLayer:l}=e,r={sitesInfo:[]};if(!l||!i?.floorInfo?.siteLayer)return r;const s=l.createQuery();s.returnGeometry=!0,s.outFields=["*"],s.returnZ=!0,"type"in l&&"scene"===l.type&&(s.multipatchOption="xyFootprint");const{siteIdField:o,nameField:n}=i.floorInfo.siteLayer,a=yield l.queryFeatures(s);if(a?.features?.length>0){const e=a.features,t=l?.fieldsIndex.get(o)?.name||o,i=l?.fieldsIndex.get(n)?.name||n;e.forEach((e=>{const l=e.attributes,s=e.geometry,o=l[t],n=l[i];o&&n&&r.sitesInfo.push({id:o,name:n,geometry:s})}))}return r}));function i(){return t.apply(this,arguments)}return i}(),u._getFacilities=function(){var t=e._asyncToGenerator((function*(){const{filterLayers:e,view:t}=this,i=t.map,{facilityLayer:l}=e,r={facilitiesInfo:[]};if(!l||!i?.floorInfo?.facilityLayer)return r;const s=l.createQuery();s.returnGeometry=!0,s.outFields=["*"],s.returnZ=!0,"type"in l&&"scene"===l.type&&(s.multipatchOption="xyFootprint");const{facilityIdField:o,siteIdField:n,nameField:a}=i.floorInfo.facilityLayer,c=yield l.queryFeatures(s);if(c?.features?.length>0){const e=c.features,t=l?.fieldsIndex.get(o)?.name||o,i=l?.fieldsIndex.get(n)?.name||n,s=l?.fieldsIndex.get(a)?.name||a;e.forEach((e=>{const l=e.attributes,o=e.geometry,n=l[t],a=l[i],c=l[s];n&&c&&r.facilitiesInfo.push({id:n,siteId:a,name:c,geometry:o})}))}return r}));function i(){return t.apply(this,arguments)}return i}(),u._getLevels=function(){var t=e._asyncToGenerator((function*(){const{filterLayers:e,view:t}=this,i=t.map,{levelLayer:l}=e,r={levelsInfo:[]};if(!l||!i?.floorInfo?.levelLayer)return r;const s=l.createQuery();s.returnGeometry=!0,s.outFields=["*"],s.returnZ=!0;const{levelIdField:o,facilityIdField:n,longNameField:a,shortNameField:c,levelNumberField:u,verticalOrderField:f}=i.floorInfo.levelLayer,d=yield l.queryFeatures(s);if(d?.features?.length>0){const e=d.features,t=l?.fieldsIndex.get(o)?.name||o,i=l?.fieldsIndex.get(n)?.name||n,s=l?.fieldsIndex.get(a)?.name||a,h=l?.fieldsIndex.get(c)?.name||c,y=l?.fieldsIndex.get(u)?.name||u,p=l?.fieldsIndex.get(f)?.name||f;e.forEach((e=>{const l=e.attributes,o=l[t],n=l[i],a=l[s],c=l[h],u=l[y],f=l[p];o&&n&&a&&c&&"number"==typeof u&&"number"==typeof f&&r.levelsInfo.push({id:o,facilityId:n,longName:a,shortName:c,levelNumber:u,verticalOrder:f})}))}return r}));function i(){return t.apply(this,arguments)}return i}(),u._registerWidget=function(e){const t=e?.persistableViewModels.includes(this);t||e?.persistableViewModels.add(this)},u._unregisterWidget=function(e){e?.persistableViewModels.remove(this)},u._watchSearchResults=function(e){e?.on("select-result-floor",(e=>{const t=this.getLevel(e);t&&this.level!==e&&(this.level=e,this.setFloors(t))}))},u._setInitialViewState=function(){var t=e._asyncToGenerator((function*(e){if(this.view)try{yield this.view.when(),yield this._setFilterLayers();const t=yield this._getFilterFeatures();if(!t)return;if(this.filterFeatures=t,!this.hasFacilities||!this.hasLevels)return void console.error("Facilities and Levels are required for the Floor Filter widget");if(this.hasMultipleSites||(this.filterMenuType="facility"),this.facility&&this.level){this.filterMenuType="facility";const e=this.getFacility(this.facility),t=this.getLevel(this.level);this.site||(this.site=e.siteId||void 0),this.setFloors(t)}else if(this.facility&&!this.level){this.filterMenuType="facility";const e=this.getFacility(this.facility),t=this.getBaseLevel(e);this.site||(this.site=e.siteId||void 0),this.level=t?.id||void 0,this.setFloors(t)}else if(!this.facility&&this.level){this.filterMenuType="facility";const e=this.getLevel(this.level),t=this.getFacility(e?.facilityId);this.facility=t?.id||void 0,this.site||(this.site=t?.siteId||void 0),this.setFloors(e)}else if(!this.site||this.facility||this.level){if(!e||!_(e))return void this.setFloors(null);const t=e?.widgets?.floorFilter;if(!t)return void this.setFloors(null);t.site&&!this.site&&(this.site=t.site,this.filterMenuType="facility"),this.setFloors(null)}else this.filterMenuType="site",this.setFloors(null)}catch(t){console.error("Couldn't retrieve sites, facilities, and levels",t)}}));function i(e){return t.apply(this,arguments)}return i}(),u._callOverride=function(e,t){this._override(e,t)},u._updateFloorFilterFromMap=function(){var t=e._asyncToGenerator((function*(e){if(!e||!_(e))return;const t=e?.widgets?.floorFilter;t&&(this._isOverridden("enabled")||(this.enabled=t.enabled),this._isOverridden("longNames")||(this.longNames=t.longNames),this._isOverridden("minimized")||(this.minimized=t.minimized),this._isOverridden("pinnedLevels")||(this.pinnedLevels=t.pinnedLevels),this._isOverridden("site")||(this.site=t.site),this._isOverridden("facility")||(this.facility=t.facility),this._isOverridden("level")||(this.level=t.level))}));function i(e){return t.apply(this,arguments)}return i}(),u._computeViewAllModeFloors=function(e){const{filterFeatures:t}=this;if(e.floorInfo?.viewAllMode&&this.hasLevels&&this.hasFacilities&&"base-floors"===this.filterMode){const{level:i,facility:r}=this,s=[];t.levels.levelsInfo.forEach((e=>{const{id:t,facilityId:l}=e;r&&l===r?i&&t===i&&s.push(t):s.push(t)})),e.floorInfo.viewAllLevelIds=new l(s)}},e._createClass(s,[{key:"enabled",set:function(e){this._callOverride("enabled",e)}},{key:"facility",set:function(e){if(e&&this._isOverridden("facility")){const t=this.getFacility(e);this.hasMultipleSites&&(this.site=t?.siteId||null)}this._callOverride("facility",e)}},{key:"filterFeatures",set:function(e){this._callOverride("filterFeatures",e)}},{key:"filterLayers",set:function(e){this._callOverride("filterLayers",e)}},{key:"hasFacilities",get:function(){return this.filterLayers?.facilityLayer&&this.filterFeatures?.facilities?.facilitiesInfo?.length>0}},{key:"hasLevels",get:function(){return this.filterLayers?.levelLayer&&this.filterFeatures?.levels?.levelsInfo?.length>0}},{key:"hasMultipleSites",get:function(){return this.filterLayers?.siteLayer&&this.filterFeatures?.sites?.sitesInfo?.length>1}},{key:"isNormalMode",get:function(){let e=!0;const t=this._viewWidthBreakpoint;return"xsmall"!==this._viewHeightBreakpoint&&"xsmall"!==t||(e=!1),e}},{key:"level",set:function(e){if(!e)return this._callOverride("level",e),this.facility=null,this.site=null,void this.setFloors(null);let t=null,i=null;const l=e?.split("--");if(l?.length>1&&"all"===l[0]?(i=l[1],t={id:e,facilityId:i,shortName:null,longName:null,levelNumber:null,verticalOrder:null}):(t=this.getLevel(e),i=t?.facilityId||null),this.level!==e||this.isNormalMode||this.levelsExpanded)t&&this.hasFacilities&&this.hasLevels?(this.facility=i,this.hasMultipleSites&&(this.site=this.getFacility(i)?.siteId||null),this.setFloors(t)):this._isOverridden("level")&&(this.facility=null,this.site=null,this.hasMultipleSites&&(this.filterMenuType="site"),this.setFloors(null)),this._callOverride("level",e);else{this.getFacilityLevels(i)?.length>1&&(this.levelsExpanded=!0)}}},{key:"longNames",set:function(e){this._callOverride("longNames",e)}},{key:"minimized",set:function(e){this._callOverride("minimized",e)}},{key:"pinnedLevels",set:function(e){this._callOverride("pinnedLevels",e)}},{key:"site",set:function(e){this._callOverride("site",e)}},{key:"state",get:function(){return this.view&&this.filterFeatures&&this.hasFacilities&&this.hasLevels?"ready":this.view&&!this.filterFeatures?"loading":"disabled"}}]),s}(v.GoToMixin(s.HandleOwner));t.__decorate([u.property({value:!1})],m.prototype,"enabled",null),t.__decorate([u.property({value:void 0})],m.prototype,"facility",null),t.__decorate([u.property({value:null})],m.prototype,"filterFeatures",null),t.__decorate([u.property({value:null})],m.prototype,"filterLayers",null),t.__decorate([u.property()],m.prototype,"filterMenuOpen",void 0),t.__decorate([u.property()],m.prototype,"filterMenuType",void 0),t.__decorate([u.property()],m.prototype,"filterMode",void 0),t.__decorate([u.property()],m.prototype,"hasFacilities",null),t.__decorate([u.property()],m.prototype,"hasLevels",null),t.__decorate([u.property()],m.prototype,"hasMultipleSites",null),t.__decorate([u.property({readOnly:!0})],m.prototype,"isNormalMode",null),t.__decorate([u.property({value:void 0})],m.prototype,"level",null),t.__decorate([u.property({value:!1})],m.prototype,"longNames",null),t.__decorate([u.property()],m.prototype,"levelsExpanded",void 0),t.__decorate([u.property({value:!1})],m.prototype,"minimized",null),t.__decorate([u.property({value:!1})],m.prototype,"pinnedLevels",null),t.__decorate([u.property()],m.prototype,"searchTerm",void 0),t.__decorate([u.property({value:void 0})],m.prototype,"site",null),t.__decorate([u.property({readOnly:!0})],m.prototype,"state",null),t.__decorate([u.property()],m.prototype,"view",void 0),t.__decorate([u.property()],m.prototype,"_viewHeightBreakpoint",void 0),t.__decorate([u.property()],m.prototype,"_viewWidthBreakpoint",void 0),t.__decorate([u.property()],m.prototype,"updateWebDocument",null),m=t.__decorate([h.subclass("esri/widgets/FloorFilter/FloorFilterViewModel")],m);return m}));
