/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/has","../../../core/Logger","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass","../../../core/Error","../../../core/urlUtils","../../../core/uuid","../../../portal/support/resourceExtension","../../../core/promiseUtils","../../../core/Accessor","../../../geometry/support/spatialReferenceUtils","../../../geometry/SpatialReference","../../../geometry/support/webMercatorUtils","../../../geometry","../../../geometry/projection","../../../geometry/coordinateFormatter","./coordinateConversionUtils"],(function(e,t,r,o,n,i,a,s,c,l,p,u,d,h,m,f,g,v,y,_){"use strict";let S=function(t){function r(e){var r;return(r=t.call(this,e)||this).conversionInfo=null,r.coordinateSegments=null,r.defaultPattern=null,r.name=null,r.viewModel=null,r}e._inheritsLoose(r,t);var o=r.prototype;return o.convert=function(e,t){if(!_.isValidPoint(e))return u.reject(new s("format:invalid-point","Could not convert invalid point.",{point:e}));const r=this.get("conversionInfo.convert");return r?u.resolve().then((()=>r(e))):this._project(e,this.spatialReference,t).then((e=>this._getCoordinate(e).then((t=>({location:e,coordinate:t})))))},o.getConversionStrategy=function(){const e=this._viewSpatialReference;return this.get("conversionInfo.convert")||this.get("viewModel.formatterAvailable")||"xy"===this.name&&(e.isWebMercator||e.isWGS84)||"basemap"===this.name?"client":"server"},o.getDisplayCoordinate=function(e){if(!e)return null;if(!this.coordinateSegments||!this.currentPattern)return e;let t=this.currentPattern;const r=this._getSegmentMatches(e,!1);for(let e=this.coordinateSegments.length-1;e>=0;e--){const o=this.coordinateSegments[e];t=t.replace(o.alias,r[e])}return t},o.parseUserInput=function(e){let t=this.defaultPattern.replace(this._additionalCharactersPattern,"");e=e.replace(this._additionalCharactersPattern,"");const r=this._getSegmentMatches(e,!0);for(let e=this.coordinateSegments.length-1;e>=0;e--){const o=this.coordinateSegments[e];t=t.replace(o.alias,r[e])}return t},o._getSegmentMatches=function(e,t){const r=[];for(let o=0;o<this.coordinateSegments.length;o++){const n=this.coordinateSegments[o],i=e.match(n.searchPattern);if(!i){r.push("");continue}let a=i[0];if(e=e.replace(a,"").trim(),n.substitution){const e=t?n.substitution.input(a):n.substitution.output(a);e&&(a=e)}r.push(a)}return r},o.reverseConvert=function(e){const t=this.parseUserInput(e),r=this.get("conversionInfo.reverseConvert"),o=_.isSupportedNotation(this.name);let n;if(r)n=r(t);else if("xy"===this.name||"basemap"===this.name)n=_.fromXY(t,this.spatialReference);else if(this.viewModel.formatterAvailable)switch(this.name){case"dd":case"ddm":case"dms":n=y.fromLatitudeLongitude(t,this.spatialReference);break;case"mgrs":{const e="automatic";n=y.fromMgrs(t,this.spatialReference,e);break}case"utm":{const e="latitude-band-indicators";n=y.fromUtm(t,this.spatialReference,e);break}case"usng":n=y.fromUsng(t,this.spatialReference);break;default:n=null}else if(o)return _.fromGeoCoordinateString({coordinate:t,spatialReference:this.spatialReference,formatName:this.name,geometryServicePromise:this.get("viewModel.geometryServicePromise")});return n?this._project(n,this._viewSpatialReference):u.reject(new s("format:invalid-input","Could not parse input into point.",{userInput:e}))},o._getCoordinate=function(e){const t=this.get("viewModel.view.scale");if(!_.isValidPoint(e))return u.reject(new s("format:invalid-point","Could not transform invalid point into coordinate.",{point:e}));if(this.get("viewModel.formatterAvailable")||"basemap"===this.name||"xy"===this.name)switch(this.name){case"dd":case"ddm":case"dms":{const r=_.getDegreePrecision(t);return u.resolve(y.toLatitudeLongitude(e,this.name,r))}case"mgrs":{const t=!1,r=5,o="automatic";return u.resolve(y.toMgrs(e,o,r,t))}case"usng":{const t=!1,r=5;return u.resolve(y.toUsng(e,r,t))}case"utm":{const t=!0,r="latitude-band-indicators";return u.resolve(y.toUtm(e,r,t))}default:return u.resolve(_.pointToCoordinate(e,t))}return _.isSupportedNotation(this.name)?_.toGeoCoordinateString({formatName:this.name,location:e,geometryServicePromise:this.get("viewModel.geometryServicePromise")}):u.resolve(_.pointToCoordinate(e,t))},o._project=function(e,t,r){return h.equals(e.spatialReference,t)||!t?u.resolve(e):this.get("viewModel.formatterAvailable")&&v.isLoaded()?u.resolve(v.project(e,t)):this.get("viewModel.formatterAvailable")?null:f.canProject(e,t)?u.resolve(f.project(e,t)):_.project({location:e,spatialReference:t,geometryServicePromise:this.get("viewModel.geometryServicePromise"),scale:this.get("viewModel.view.scale")},r).then((e=>e.location))},e._createClass(r,[{key:"currentPattern",get:function(){return this._get("currentPattern")||this._get("defaultPattern")},set:function(e){this._set("currentPattern",e)}},{key:"hasDisplayProperties",get:function(){return!(!this.defaultPattern||!this.coordinateSegments)}},{key:"spatialReference",get:function(){const e=this.get("conversionInfo.spatialReference")||m.WGS84;return"basemap"===this.name?this._viewSpatialReference:e},set:function(e){void 0===e&&this._clearOverride("spatialReference"),this._override("spatialReference",e)}},{key:"_viewSpatialReference",get:function(){return this.get("viewModel.view.spatialReference")||m.WGS84}},{key:"_additionalCharactersPattern",get:function(){const e=this.get("coordinateSegments");if(!e)return null;const t=e.map((e=>e.alias)),r=this.currentPattern.replace(new RegExp(`["nsew${t.join()}]`,"gi"),"").replace(/\ /g,"");return new RegExp(`[${r}]`,"g")}}]),r}(d);return t.__decorate([i.property()],S.prototype,"conversionInfo",void 0),t.__decorate([i.property()],S.prototype,"coordinateSegments",void 0),t.__decorate([i.property()],S.prototype,"currentPattern",null),t.__decorate([i.property()],S.prototype,"defaultPattern",void 0),t.__decorate([i.property({readOnly:!0,dependsOn:["defaultPattern","coordinateSegments"]})],S.prototype,"hasDisplayProperties",null),t.__decorate([i.property()],S.prototype,"name",void 0),t.__decorate([i.property({dependsOn:["_viewSpatialReference","name"],type:m})],S.prototype,"spatialReference",null),t.__decorate([i.property()],S.prototype,"viewModel",void 0),t.__decorate([i.property({dependsOn:["viewModel.view.spatialReference"],readOnly:!0})],S.prototype,"_viewSpatialReference",null),t.__decorate([i.property({readOnly:!0,dependsOn:["currentPattern"]})],S.prototype,"_additionalCharactersPattern",null),S=t.__decorate([a.subclass("esri.widgets.CoordinateConversion.support.Format")],S),S}));
