// COPYRIGHT © 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../intl","../core/maybe","../core/accessorSupport/decorators","./Widget","./Histogram/HistogramViewModel","./support/widget"],(function(e,t,r,i,a,s,n,o,l){"use strict";var d="esri-histogram",u="esri-histogram--horizontal",c="esri-histogram--vertical",p="esri-histogram__content",h="esri-histogram__svg",g="esri-histogram__bar",v="esri-histogram__bars",_="esri-histogram__label",m="esri-histogram__data-lines",b="esri-histogram__data-lines-subgroup",f="esri-histogram__data-line",y="esri-histogram__average-label",x="esri-histogram__average-data-line",w="esri-histogram__average-symbol",L="esri-widget",C="esri-disabled";return function(e){function t(t,r){var i=e.call(this,t,r)||this;return i._containerNode=null,i._defaultBarColor="#d8d8d8",i.average=null,i.barCreatedFunction=null,i.bins=null,i.dataLines=null,i.dataLineCreatedFunction=null,i.label=void 0,i.labelFormatFunction=null,i.max=null,i.messages=null,i.min=null,i.state=null,i.viewModel=new o,i}var n;return r.__extends(t,e),n=t,Object.defineProperty(t.prototype,"layout",{set:function(e){"vertical"!==e&&(e="horizontal"),this._set("layout",e)},enumerable:!1,configurable:!0}),t.fromHistogramResult=function(e){var t=e.bins,r=e.maxValue,i=e.minValue;return new n({bins:t,max:r,min:i})},t.prototype.render=function(){var e=this.label,t=this.layout,r=this.state,i=this.classes(d,L,"horizontal"===t?u:c,"disabled"===r?C:null);return l.tsx("div",{"aria-label":e,afterCreate:l.storeNode,bind:this,class:i,"data-node-ref":"_containerNode"},"ready"===r?this.renderContent():null)},t.prototype.renderContent=function(){if(this._containerNode)return l.tsx("div",{class:p},l.tsx("svg",{class:h,xmlns:"http://www.w3.org/2000/svg"},this.renderBarsGroup(),this.renderLinesGroup()))},t.prototype.renderBarsGroup=function(){return l.tsx("g",{class:this.classes(v)},this.renderBars())},t.prototype.renderBars=function(){var e=this,t=this.layout,r=this.viewModel,i=r.binRange,a=r.range;if(i&&a){var s=i/a,n=this._getContainerDimensions(),o=n[0],l=n[1];if(0!==o||0!==l){if(0!==o||0===l){var d="vertical"===t?[o*s,l]:[o,l*s],u=d[0],c=d[1];return this._getBarDimensions(u,c).map((function(t,r){var i=t[0],a=t[1];return e.renderBar(r,i,a)}))}this.scheduleRender()}}},t.prototype.renderBar=function(e,t,r){var a=this,s=a.bins,n=a.layout,o=a.max,d=a.messages,u=a.viewModel.range,c=this._getContainerDimensions(),p=c[0],h=c[1],v=s.slice()[e],_=v.count,m=v.maxValue,b=v.minValue,f=o-m,y="vertical"===n?[0,f*(p/u)]:[h-r-f*(h/u),p-t],x=y[0],w=y[1],L=i.substitute(d.barLabel,{count:_,maxValue:m,minValue:b});return l.tsx("rect",{"aria-label":L,afterCreate:this._afterBarCreate,bind:this,class:g,"data-index":e,fill:this._defaultBarColor,height:t,role:"img","shape-rendering":"crispEdges","stroke-width":"0",width:r,x:x,y:w})},t.prototype.renderLinesGroup=function(){return l.tsx("g",{class:this.classes(m)},this.renderAverageLine(),this.renderCustomLines())},t.prototype.renderAverageLine=function(){var e=this.average;if(a.isSome(e)){var t=[l.tsx("tspan",{class:this.classes(w)},"x̄ "),l.tsx("tspan",{class:this.classes(y)},this.labelFormatFunction?this.labelFormatFunction(e,"average"):e)];return l.tsx("g",{afterCreate:this._afterLinesSubgroupCreate,bind:this,class:this.classes(b)},this.renderLine(e,this.classes(x)),this.renderLabel(e,t))}},t.prototype.renderCustomLines=function(){var e=this;if(this.dataLines&&this.dataLines.length)return this.dataLines.map((function(t,r){var i=t.value,a=t.label;return e.renderLineSubgroup(r,i,a)}))},t.prototype.renderLineSubgroup=function(e,t,r){return l.tsx("g",{afterCreate:this._afterLinesSubgroupCreate,bind:this,class:this.classes(b),"data-index":e},this.renderLine(t),this.renderLabel(t,r))},t.prototype.renderLine=function(e,t){var r=this._getLinePosition(e),i=r[0],a=r[1],s=r[2],n=r[3];return l.tsx("line",{class:this.classes(f,t),x1:i,x2:a,y1:s,y2:n,"shape-rendering":"crispEdges"})},t.prototype.renderLabel=function(e,t,r){var i=this._getLabelPosition(e),a=i[0],s=i[1];return l.tsx("text",{class:this.classes(_,r),"text-anchor":"end",transform:"horizontal"===this.layout?"rotate(270)":null,x:a,y:s-2},t)},t.prototype._afterBarCreate=function(e){if(this.barCreatedFunction){var t=e.dataset?parseInt(e.dataset.index,10):e.getAttribute("data-index")?parseInt(e.getAttribute("data-index"),10):null;this.barCreatedFunction(isNaN(t)?null:t,e)}},t.prototype._afterLinesSubgroupCreate=function(e){if(this.dataLineCreatedFunction){var t=e.dataset?parseInt(e.dataset.index,10):e.getAttribute("data-index")?parseInt(e.getAttribute("data-index"),10):null,r=e.childNodes[0],i=e.childNodes[1]?e.childNodes[1]:null;this.dataLineCreatedFunction(r,i,isNaN(t)?null:t)}},t.prototype._getContainerDimensions=function(){var e=this._containerNode;return e?[e.offsetHeight,e.offsetWidth]:[0,0]},t.prototype._getBarDimensions=function(e,t){var r=this.bins,i=this.layout,a=r?r.map((function(e){return e.count})):[],s=Math.max.apply(Math,a);return a.map((function(r){return"vertical"===i?[e/a.length,0!==s?r/s*t:0]:[0!==s?r/s*e:0,t/a.length]}))},t.prototype._getLinePosition=function(e){var t=this.layout,r=(e-this.min)/this.viewModel.range,i=this._getContainerDimensions(),a=i[0],s=[r*i[1],a-r*a],n=s[0],o=s[1];return"vertical"===t?[0,"100%",o,o]:[n,n,"100%",0]},t.prototype._getLabelPosition=function(e){var t=this.layout,r=(e-this.min)/this.viewModel.range,i=this._getContainerDimensions(),a=i[0],s=i[1];return"vertical"===t?[s,a-r*a]:[0,r*s]},r.__decorate([s.aliasOf("viewModel.average")],t.prototype,"average",void 0),r.__decorate([s.property(),l.renderable()],t.prototype,"barCreatedFunction",void 0),r.__decorate([s.aliasOf("viewModel.bins")],t.prototype,"bins",void 0),r.__decorate([s.property(),l.renderable()],t.prototype,"dataLines",void 0),r.__decorate([s.property(),l.renderable()],t.prototype,"dataLineCreatedFunction",void 0),r.__decorate([s.property({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],t.prototype,"label",void 0),r.__decorate([s.aliasOf("viewModel.labelFormatFunction")],t.prototype,"labelFormatFunction",void 0),r.__decorate([s.property({value:"horizontal"})],t.prototype,"layout",null),r.__decorate([s.aliasOf("viewModel.max")],t.prototype,"max",void 0),r.__decorate([s.property(),l.renderable(),l.messageBundle("esri/widgets/Histogram/t9n/Histogram")],t.prototype,"messages",void 0),r.__decorate([s.aliasOf("viewModel.min")],t.prototype,"min",void 0),r.__decorate([s.aliasOf("viewModel.state")],t.prototype,"state",void 0),r.__decorate([s.property(),l.renderable(["viewModel.average","viewModel.bins","viewModel.labelFormatFunction","viewModel.max","viewModel.min","viewModel.state"])],t.prototype,"viewModel",void 0),t=n=r.__decorate([s.subclass("esri.widgets.Histogram")],t)}(n)}));