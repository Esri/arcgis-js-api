// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/assignHelper","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","dojo/i18n!./Histogram/nls/Histogram","../intl","../core/maybe","../core/accessorSupport/decorators","./Widget","./Histogram/HistogramViewModel","./support/widget"],function(e,t,r,a,i,n,s,o,l,d,u,p){var c={base:"esri-histogram",horizontalLayout:"esri-histogram--horizontal",verticalLayout:"esri-histogram--vertical",content:"esri-histogram__content",svg:"esri-histogram__svg",bar:"esri-histogram__bar",bars:"esri-histogram__bars",label:"esri-histogram__label",dataLines:"esri-histogram__data-lines",dataLinesSubgroup:"esri-histogram__data-lines-subgroup",dataLine:"esri-histogram__data-line",averageLabel:"esri-histogram__average-label",averageDataLine:"esri-histogram__average-data-line",averageSymbol:"esri-histogram__average-symbol",esriWidget:"esri-widget",widgetIcon:"esri-icon-edit",disabled:"esri-disabled"};return function(e){function t(t){var r=e.call(this,t)||this;return r._containerNode=null,r._defaultBarColor="#d8d8d8",r.average=null,r.barCreatedFunction=null,r.bins=null,r.dataLines=null,r.dataLineCreatedFunction=null,r.label=n.title,r.labelFormatFunction=null,r.max=null,r.min=null,r.state=null,r.viewModel=new u,r}a(t,e),r=t,Object.defineProperty(t.prototype,"layout",{set:function(e){"vertical"!==e&&(e="horizontal"),this._set("layout",e)},enumerable:!0,configurable:!0}),t.fromHistogramResult=function(e){var t=e.bins,a=e.maxValue,i=e.minValue;return new r({bins:t,max:a,min:i})},t.prototype.render=function(){var e=this,t=e.label,r=e.layout,a=e.state,i=this.classes(c.base,c.esriWidget,"horizontal"===r?c.horizontalLayout:c.verticalLayout,"disabled"===a?c.disabled:null);return p.tsx("div",{"aria-label":t,afterCreate:p.storeNode,bind:this,class:i,"data-node-ref":"_containerNode"},"ready"===a?this.renderContent():null)},t.prototype.renderContent=function(){if(this._containerNode)return p.tsx("div",{class:c.content},p.tsx("svg",{class:c.svg,xmlns:"http://www.w3.org/2000/svg"},this.renderBarsGroup(),this.renderLinesGroup()))},t.prototype.renderBarsGroup=function(){return p.tsx("g",{class:this.classes(c.bars)},this.renderBars())},t.prototype.renderBars=function(){var e=this,t=this,r=t.layout,a=t.viewModel,i=a.binRange,n=a.range;if(i&&n){var s=i/n,o=this._getContainerDimensions(),l=o[0],d=o[1];if(0!==l||0!==d){if(0===l&&0!==d)return void this.scheduleRender();var u="vertical"===r?[l*s,d]:[l,d*s],p=u[0],c=u[1];return this._getBarDimensions(p,c).map(function(t,r){var a=t[0],i=t[1];return e.renderBar(r,a,i)})}}},t.prototype.renderBar=function(e,t,r){var a=this,i=a.bins,o=a.layout,l=a.max,d=a.viewModel.range,u=this._getContainerDimensions(),h=u[0],g=u[1],v=i.slice(),b=v[e],m=b.count,f=b.maxValue,y=b.minValue,L=l-f,_="vertical"===o?[0,L*(h/d)]:[g-r-L*(g/d),h-t],x=_[0],w=_[1],C=s.substitute(n.barLabel,{count:m,maxValue:f,minValue:y});return p.tsx("rect",{"aria-label":C,afterCreate:this._afterBarCreate,bind:this,class:c.bar,"data-index":e,fill:this._defaultBarColor,height:t,role:"img","shape-rendering":"crispEdges","stroke-width":"0",tabindex:0,width:r,x:x,y:w})},t.prototype.renderLinesGroup=function(){return p.tsx("g",{class:this.classes(c.dataLines)},this.renderAverageLine(),this.renderCustomLines())},t.prototype.renderAverageLine=function(){var e=this.average;if(o.isSome(e)){var t=[p.tsx("tspan",{class:this.classes(c.averageSymbol)},n.xAverage),p.tsx("tspan",{class:this.classes(c.averageLabel)},this.labelFormatFunction?this.labelFormatFunction(e,"average"):e)];return p.tsx("g",{afterCreate:this._afterLinesSubgroupCreate,bind:this,class:this.classes(c.dataLinesSubgroup)},this.renderLine(e,this.classes(c.averageDataLine)),this.renderLabel(e,t))}},t.prototype.renderCustomLines=function(){var e=this;if(this.dataLines&&this.dataLines.length)return this.dataLines.map(function(t,r){var a=t.value,i=t.label;return e.renderLineSubgroup(r,a,i)})},t.prototype.renderLineSubgroup=function(e,t,r){return p.tsx("g",{afterCreate:this._afterLinesSubgroupCreate,bind:this,class:this.classes(c.dataLinesSubgroup),"data-index":e},this.renderLine(t),this.renderLabel(t,r))},t.prototype.renderLine=function(e,t){var r=this._getLinePosition(e),a=r[0],i=r[1],n=r[2],s=r[3];return p.tsx("line",{class:this.classes(c.dataLine,t),x1:a,x2:i,y1:n,y2:s,"shape-rendering":"crispEdges"})},t.prototype.renderLabel=function(e,t,r){var a=this._getLabelPosition(e),i=a[0],n=a[1];return p.tsx("text",{class:this.classes(c.label,r),"text-anchor":"end",transform:"horizontal"===this.layout?"rotate(270)":null,x:i,y:n-2},t)},t.prototype._afterBarCreate=function(e){if(this.barCreatedFunction){var t=e.dataset?parseInt(e.dataset.index,10):e.getAttribute("data-index")?parseInt(e.getAttribute("data-index"),10):null;this.barCreatedFunction(isNaN(t)?null:t,e)}},t.prototype._afterLinesSubgroupCreate=function(e){if(this.dataLineCreatedFunction){var t=e.dataset?parseInt(e.dataset.index,10):e.getAttribute("data-index")?parseInt(e.getAttribute("data-index"),10):null,r=e.childNodes[0],a=e.childNodes[1]?e.childNodes[1]:null;this.dataLineCreatedFunction(r,a,isNaN(t)?null:t)}},t.prototype._getContainerDimensions=function(){var e=this._containerNode;return e?[e.offsetHeight,e.offsetWidth]:[0,0]},t.prototype._getBarDimensions=function(e,t){var r=this,a=r.bins,i=r.layout,n=a?a.map(function(e){return e.count}):[],s=Math.max.apply(Math,n);return n.map(function(r,a){return"vertical"===i?[e/n.length,r/s*t]:[r/s*e,t/n.length]})},t.prototype._getLinePosition=function(e){var t=this,r=t.layout,a=t.min,i=t.viewModel.range,n=(e-a)/i,s=this._getContainerDimensions(),o=s[0],l=s[1],d=[n*l,o-n*o],u=d[0],p=d[1];return"vertical"===r?[0,"100%",p,p]:[u,u,"100%",0]},t.prototype._getLabelPosition=function(e){var t=this,r=t.layout,a=t.min,i=t.viewModel.range,n=(e-a)/i,s=this._getContainerDimensions(),o=s[0],l=s[1];return"vertical"===r?[l,o-n*o]:[0,n*l]};var r;return i([l.aliasOf("viewModel.average")],t.prototype,"average",void 0),i([l.property(),p.renderable()],t.prototype,"barCreatedFunction",void 0),i([l.aliasOf("viewModel.bins")],t.prototype,"bins",void 0),i([l.property(),p.renderable()],t.prototype,"dataLines",void 0),i([l.property(),p.renderable()],t.prototype,"dataLineCreatedFunction",void 0),i([l.property()],t.prototype,"label",void 0),i([l.aliasOf("viewModel.labelFormatFunction")],t.prototype,"labelFormatFunction",void 0),i([l.property({value:"horizontal"})],t.prototype,"layout",null),i([l.aliasOf("viewModel.max")],t.prototype,"max",void 0),i([l.aliasOf("viewModel.min")],t.prototype,"min",void 0),i([l.aliasOf("viewModel.state")],t.prototype,"state",void 0),i([l.property(),p.renderable(["viewModel.average","viewModel.bins","viewModel.labelFormatFunction","viewModel.max","viewModel.min","viewModel.state"])],t.prototype,"viewModel",void 0),t=r=i([l.subclass("esri.widgets.Histogram")],t)}(l.declared(d))});