// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../core/arrayUtils","../../../core/events","../../../core/Handles","../../../core/mathUtils","../../../core/maybe","../../../core/watchUtils","../../../core/accessorSupport/decorators","../../../core/libs/pep/pep","../../Widget","../BuildingLevel","./constants","./Label","./LevelItem","../../support/widget"],(function(e,t,o,n,i,r,l,s,a,v,d,_,h,p,u,c,g){"use strict";var L={selectLevel:"selectLevel",clearLevel:"clearLevel",nextLevel:"nextLevel",previousLevel:"previousLevel",currentLevel:"{{value}}"},y="esri-building-level-picker",f={container:y,noLevel:y+"--no-level",animateLevel:y+"--animate-level",levelsContainer:y+"__levels-container",innerLevelsContainer:y+"__inner-levels-container",labelContainer:y+"__label-container",arrowUp:y+"__arrow-up",arrowDown:y+"__arrow-down"};return function(e){function t(t,o){var n=e.call(this,t,o)||this;return n._defaultViewModel=new h,n.viewModel=n._defaultViewModel,n.messages=L,n._levelHandles=new r,n._levelEventHandles=new r,n._levelWidgets=[],n._labelWidget=new u.Label({onClear:function(){return n.viewModel.clear()}}),n._hoveredLevel=null,n._expandedLevelsHeight=void 0,n._normalizedPointerPosition=0,n._hovering=!1,n._containerPosTop=null,n._levelsContainer=null,n._onPointerUp=function(){window.getSelection().removeAllRanges(),s.isSome(n._hoveredLevel)&&(n.viewModel.enabled&&n._hoveredLevel===n.viewModel.value?n.viewModel.clear():n.viewModel.select(n._hoveredLevel))},n._onPointerEnter=function(){var e;!n._hovering&&s.isSome(n._levelsContainer)&&(n._hovering=!0,n._containerPosTop=null!==(e=n._levelsContainer.getBoundingClientRect().top)&&void 0!==e?e:0)},n._onPointerLeave=function(){n._hovering&&(n._normalizedPointerPosition=0,n._hoveredLevel=null,n._hovering=!1)},n._onPointerMove=function(e){if(!n._hovering)return!1;if(window.getSelection().removeAllRanges(),s.isSome(n._containerPosTop)){var t=n._containerPosTop,o=p.LEVELS_PADDING*p.LEVELS_MARGIN_FACTOR,i=n._expandedLevelsMargin,r=n._levelsHeight,l=t+o+i,a=n._levelHeight/2;l+=a,r-=a;var v=(e.clientY-l)/r;v+=p.LEVELS_POINTER_ADJUSTMENT,n._normalizedPointerPosition=v}return!1},n}return o.__extends(t,e),t.prototype.postInitialize=function(){var e=this;this.own(a.init(this,"_levelsContainer",(function(){return e._onContainerChange()})),a.init(this,"_levels",(function(){return e._createLevelWidgets()})),a.init(this,"messages",(function(){return e._labelWidget.messages=e.messages})))},t.prototype.destroy=function(){this._levelHandles.destroy(),this._levelEventHandles.destroy(),this._levelWidgets.forEach((function(e){return e.destroy()})),this._labelWidget.destroy(),this.viewModel!==this._defaultViewModel&&this._defaultViewModel.destroy()},Object.defineProperty(t.prototype,"_levelsHeight",{get:function(){return Math.round(this._levelHeight*this._numLevels)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"_expandedLevelsMargin",{get:function(){return Math.round((this._expandedLevelsHeight-this._levelsHeight)/2)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"_levelWidth",{get:function(){var e=p.LEVEL_WIDTH_NOMINATOR,t=p.LEVEL_WIDTH_CONSTANT,o=e/Math.sqrt(this._numLevels)+t;return Math.round(l.clamp(o,p.LEVEL_WIDTH_MIN,p.LEVEL_WIDTH_MAX))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"_levelHeight",{get:function(){var e=p.LEVEL_HEIGHT_DEFAULT,t=2*e/Math.sqrt(this._numLevels);return Math.round(l.clamp(t,2,e))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"_gaussianFactor",{get:function(){var e=this._numLevels;return e/Math.log(p.ALPHA_LEVEL_DEPENDENCY_FACTOR*e)*p.ALPHA_SPREAD_FACTOR},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"_levelClosestToPointer",{get:function(){if(!this._hovering)return null;var e=this._numLevels-1,t=this._normalizedPointerPosition;return e>=0&&s.isSome(t)?this._levels[Math.round((1-t)*e)]:null},enumerable:!1,configurable:!0}),t.prototype.render=function(){var e,t=this._levelWidgets.length,o=t>1?this._levelWidgets.map((function(e){return e.render()})):null,n=p.LEVELS_PADDING*p.LEVELS_MARGIN_FACTOR,i=-n/p.LEVELS_MARGIN_FACTOR,r=this._levelsHeight,l=r+2*n;return g.tsx("div",{bind:this,key:this,class:this.classes("esri-widget",f.container,(e={},e[f.animateLevel]=!this._hovering,e[f.noLevel]=t<2,e)),onkeydown:this._onKeyDown},this._renderLabelContainer(),g.tsx("div",{bind:this,class:f.levelsContainer,styles:{height:l+"px",marginTop:i+"px",marginBottom:i+"px"},onfocus:this._onFocus,afterCreate:g.storeNode,"data-node-ref":"_levelsContainer"},g.tsx("div",{styles:{height:r+"px",margin:p.LEVELS_PADDING-this._expandedLevelsMargin+"px 0 0 0"},class:f.innerLevelsContainer},o)))},t.prototype._renderLabelContainer=function(){var e=this.messages.previousLevel,t=this.messages.nextLevel;return g.tsx("div",{class:f.labelContainer,tabIndex:0},g.tsx("button",{bind:this,class:f.arrowUp,disabled:!this.viewModel.hasNext,onclick:this._onArrowUpClick,"aria-label":t,title:t,type:"button"}),this._labelWidget.render(),g.tsx("button",{bind:this,class:f.arrowDown,disabled:!this.viewModel.hasPrevious,onclick:this._onArrowDownClick,"aria-label":e,title:e,type:"button"}))},t.prototype._updateComponents=function(){var e=this,t=this.viewModel.enabled?this.viewModel.value:null,o=s.isSome(this._hoveredLevel)?this._hoveredLevel:t;this._levelWidgets.forEach((function(o){var n,i,r=e.viewModel.getValueLabel(o.level);o.label=s.isSome(r)?r:null===(i=null===(n=e.messages)||void 0===n?void 0:n.currentLevel)||void 0===i?void 0:i.replace("{{level}}",String(o.level)),o.active=o.level===t,o.hovering=o.level===e._hoveredLevel})),this._labelWidget.level=o,this._labelWidget.active=o===t,this._labelWidget.hovering=s.isSome(this._hoveredLevel)},t.prototype._onWidthChange=function(){var e=this;this._levelWidgets.forEach((function(t){t.width=e._levelWidth}))},t.prototype._createLevelWidgets=function(){var e=this;this._levelWidgets.forEach((function(e){return e.destroy()})),this._levelWidgets=this._levels.map((function(t){return new c.LevelItem({level:t,onSelect:function(){return e._onLevelToggle(t)}})})),this._levelHandles.removeAll(),this._levelHandles.add([a.init(this,["messages","viewModel.value","viewModel.enabled","_hoveredLevel","_hovering"],(function(){return e._updateComponents()})),a.init(this,["_normalizedPointerPosition","_hovering"],(function(){return e._onPointerPositionChange()})),a.init(this,"_width",(function(){return e._onWidthChange()}))])},t.prototype._onContainerChange=function(){var e=this._levelsContainer;s.isSome(e)&&(d.applyLocal(e),this._levelEventHandles.removeAll(),this._levelEventHandles.add([i.on(e,"pointerenter",this._onPointerEnter),i.on(e,"pointerover",this._onPointerEnter),i.on(e,"pointerleave",this._onPointerLeave),i.on(e,"pointerup",this._onPointerUp),i.on(e,"pointermove",this._onPointerMove)]))},t.prototype._onKeyDown=function(e){switch(e.key){case"ArrowDown":case"ArrowLeft":e.preventDefault(),e.stopPropagation(),this.viewModel.previous(),this._focusCurrentLevel();break;case"ArrowUp":case"ArrowRight":e.preventDefault(),e.stopPropagation(),this.viewModel.next(),this._focusCurrentLevel()}},t.prototype._focusCurrentLevel=function(){var e=this,t=n.find(this._levelWidgets,(function(t){return t.level===e.viewModel.value}));t&&t.focus()},t.prototype._onFocus=function(){this._hoveredLevel=this._levels.length>0?this._levels[0]:null},t.prototype._onLevelToggle=function(e){this.viewModel.enabled&&this.viewModel.value===e?this.viewModel.clear():this.viewModel.select(e)},t.prototype._onArrowUpClick=function(){this.viewModel.next()},t.prototype._onArrowDownClick=function(){this.viewModel.previous()},t.prototype._onPointerPositionChange=function(){var e=this,t=0;this._levelWidgets.forEach((function(o,n){var i=e._getLevelWidgetSize(n),r=i.width,l=i.height;o.height=l,o.width=r,t+=l})),this._hoveredLevel=this._levelClosestToPointer;var o=this._expandedLevelsHeight;(null==o||Math.abs(o-t)>30)&&(this._expandedLevelsHeight=t)},t.prototype._getLevelWidgetSize=function(e){var t={width:this._levelWidth,height:this._levelHeight};if(this._hovering){var o=this._getGaussianFactor(e,this._normalizedPointerPosition);t.width+=p.LEVEL_HOVERED_EXTRA_WIDTH*o,t.height+=p.LEVEL_HOVERED_EXTRA_HEIGHT*o}return t},t.prototype._getGaussianFactor=function(e,t){var o=this._numLevels-1,n=(o-e)/o,i=this._gaussianFactor*(n-t);return Math.exp(-Math.pow(i,2))},o.__decorate([v.property({type:h}),g.renderable(["viewModel.hasNext","viewModel.hasPrevious"])],t.prototype,"viewModel",void 0),o.__decorate([v.property()],t.prototype,"messages",void 0),o.__decorate([v.property(),g.renderable()],t.prototype,"_levelWidgets",void 0),o.__decorate([v.property(),g.renderable()],t.prototype,"_labelWidget",void 0),o.__decorate([v.property(),g.renderable()],t.prototype,"_hoveredLevel",void 0),o.__decorate([v.aliasOf("viewModel.allowedValues"),g.renderable()],t.prototype,"_levels",void 0),o.__decorate([v.aliasOf("_levels.length"),g.renderable()],t.prototype,"_numLevels",void 0),o.__decorate([v.property({readOnly:!0,dependsOn:["_numLevels","_levelHeight"]}),g.renderable()],t.prototype,"_levelsHeight",null),o.__decorate([v.property(),g.renderable()],t.prototype,"_expandedLevelsHeight",void 0),o.__decorate([v.property({readOnly:!0,dependsOn:["_expandedLevelsHeight","_levelsHeight"]}),g.renderable()],t.prototype,"_expandedLevelsMargin",null),o.__decorate([v.property({readOnly:!0,dependsOn:["_numLevels"]})],t.prototype,"_levelWidth",null),o.__decorate([v.property({readOnly:!0,dependsOn:["_numLevels"]})],t.prototype,"_levelHeight",null),o.__decorate([v.property({readOnly:!0,dependsOn:["_numLevels"]})],t.prototype,"_gaussianFactor",null),o.__decorate([v.property({readOnly:!0,dependsOn:["_levels","_numLevels","_hovering","_normalizedPointerPosition"]})],t.prototype,"_levelClosestToPointer",null),o.__decorate([v.property({type:Number,range:{min:0,max:1}}),g.renderable()],t.prototype,"_normalizedPointerPosition",void 0),o.__decorate([v.property()],t.prototype,"_hovering",void 0),o.__decorate([v.property()],t.prototype,"_containerPosTop",void 0),o.__decorate([v.property()],t.prototype,"_levelsContainer",void 0),t=o.__decorate([v.subclass("esri.widgets.BuildingExplorer.BuildingLevelPicker.BuildingLevelPicker")],t)}(_)}));