/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/has","../../../core/maybe","../../../core/Logger","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/aliasOf","../../../core/accessorSupport/decorators/subclass","../../../core/urlUtils","../../../core/uuid","../../../portal/support/resourceExtension","../../../core/events","../../../core/mathUtils","../../../core/Handles","../../../core/watchUtils","../../support/widgetUtils","../../support/decorators/renderable","../../../chunks/index","../../Widget","../BuildingLevel","../../../chunks/constants","./Label","./LevelItem"],(function(e,t,o,i,n,l,s,r,a,_,d,v,h,c,p,u,g,L,w,y,m,E,b,f){"use strict";const M={selectLevel:"selectLevel",clearLevel:"clearLevel",nextLevel:"nextLevel",previousLevel:"previousLevel",currentLevel:"{{value}}"},P="esri-building-level-picker",C={container:P,noLevel:`${P}--no-level`,animateLevel:`${P}--animate-level`,levelsContainer:`${P}__levels-container`,innerLevelsContainer:`${P}__inner-levels-container`,labelContainer:`${P}__label-container`,arrowUp:`${P}__arrow-up`,arrowDown:`${P}__arrow-down`};let H=function(t){function o(e,o){var n;return(n=t.call(this,e,o)||this)._defaultViewModel=new m,n.viewModel=n._defaultViewModel,n.messages=M,n._levelHandles=new p,n._levelEventHandles=new p,n._levelWidgets=[],n._labelWidget=new b.Label({onClear:()=>n.viewModel.clear()}),n._hoveredLevel=null,n._expandedLevelsHeight=void 0,n._normalizedPointerPosition=0,n._hovering=!1,n._containerPosTop=null,n._levelsContainer=null,n._onPointerUp=()=>{window.getSelection().removeAllRanges(),i.isSome(n._hoveredLevel)&&(n.viewModel.enabled&&n._hoveredLevel===n.viewModel.value?n.viewModel.clear():n.viewModel.select(n._hoveredLevel))},n._onPointerEnter=()=>{var e;!n._hovering&&i.isSome(n._levelsContainer)&&(n._hovering=!0,n._containerPosTop=null!=(e=n._levelsContainer.getBoundingClientRect().top)?e:0)},n._onPointerLeave=()=>{n._hovering&&(n._normalizedPointerPosition=0,n._hoveredLevel=null,n._hovering=!1)},n._onPointerMove=e=>{if(!n._hovering)return!1;if(window.getSelection().removeAllRanges(),i.isSome(n._containerPosTop)){const t=n._containerPosTop,o=E.LEVELS_PADDING*E.LEVELS_MARGIN_FACTOR,i=n._expandedLevelsMargin;let l=n._levelsHeight,s=t+o+i;const r=n._levelHeight/2;s+=r,l-=r;let a=(e.clientY-s)/l;a+=E.LEVELS_POINTER_ADJUSTMENT,n._normalizedPointerPosition=a}return!1},n}e._inheritsLoose(o,t);var n=o.prototype;return n.postInitialize=function(){this.own(u.init(this,"_levelsContainer",(()=>this._onContainerChange())),u.init(this,"_levels",(()=>this._createLevelWidgets())),u.init(this,"messages",(()=>this._labelWidget.messages=this.messages)))},n.destroy=function(){this._levelHandles.destroy(),this._levelEventHandles.destroy(),this._levelWidgets.forEach((e=>e.destroy())),this._labelWidget.destroy(),this.viewModel!==this._defaultViewModel&&this._defaultViewModel.destroy()},n.render=function(){const e=this._levelWidgets.length,t=e>1?this._levelWidgets.map((e=>e.render())):null,o=E.LEVELS_PADDING*E.LEVELS_MARGIN_FACTOR,i=-o/E.LEVELS_MARGIN_FACTOR,n=this._levelsHeight,l=n+2*o;return w.jsx("div",{bind:this,key:this,class:this.classes("esri-widget",C.container,{[C.animateLevel]:!this._hovering,[C.noLevel]:e<2}),onkeydown:this._onKeyDown},this._renderLabelContainer(),w.jsx("div",{bind:this,class:C.levelsContainer,styles:{height:`${l}px`,marginTop:`${i}px`,marginBottom:`${i}px`},onfocus:this._onFocus,afterCreate:g.storeNode,"data-node-ref":"_levelsContainer"},w.jsx("div",{styles:{height:`${n}px`,margin:E.LEVELS_PADDING-this._expandedLevelsMargin+"px 0 0 0"},class:C.innerLevelsContainer},t)))},n._renderLabelContainer=function(){const e=this.messages.previousLevel,t=this.messages.nextLevel;return w.jsx("div",{class:C.labelContainer,tabIndex:0},w.jsx("button",{bind:this,class:C.arrowUp,disabled:!this.viewModel.hasNext,onclick:this._onArrowUpClick,"aria-label":t,title:t,type:"button"}),this._labelWidget.render(),w.jsx("button",{bind:this,class:C.arrowDown,disabled:!this.viewModel.hasPrevious,onclick:this._onArrowDownClick,"aria-label":e,title:e,type:"button"}))},n._updateComponents=function(){const e=this.viewModel.enabled?this.viewModel.value:null,t=i.isSome(this._hoveredLevel)?this._hoveredLevel:e;this._levelWidgets.forEach((t=>{var o,n;const l=this.viewModel.getValueLabel(t.level);t.label=i.isSome(l)?l:null==(o=this.messages)||null==(n=o.currentLevel)?void 0:n.replace("{{level}}",String(t.level)),t.active=t.level===e,t.hovering=t.level===this._hoveredLevel})),this._labelWidget.level=t,this._labelWidget.active=t===e,this._labelWidget.hovering=i.isSome(this._hoveredLevel)},n._onWidthChange=function(){this._levelWidgets.forEach((e=>{e.width=this._levelWidth}))},n._createLevelWidgets=function(){this._levelWidgets.forEach((e=>e.destroy())),this._levelWidgets=this._levels.map((e=>new f.LevelItem({level:e,onSelect:()=>this._onLevelToggle(e)}))),this._levelHandles.removeAll(),this._levelHandles.add([u.init(this,["messages","viewModel.value","viewModel.enabled","_hoveredLevel","_hovering"],(()=>this._updateComponents())),u.init(this,["_normalizedPointerPosition","_hovering"],(()=>this._onPointerPositionChange())),u.init(this,"_width",(()=>this._onWidthChange()))])},n._onContainerChange=function(){const e=this._levelsContainer;i.isSome(e)&&(this._levelEventHandles.removeAll(),this._levelEventHandles.add([h.on(e,"pointerenter",this._onPointerEnter),h.on(e,"pointerover",this._onPointerEnter),h.on(e,"pointerleave",this._onPointerLeave),h.on(e,"pointerup",this._onPointerUp),h.on(e,"pointermove",this._onPointerMove)]))},n._onKeyDown=function(e){switch(e.key){case"ArrowDown":case"ArrowLeft":e.preventDefault(),e.stopPropagation(),this.viewModel.previous(),this._focusCurrentLevel();break;case"ArrowUp":case"ArrowRight":e.preventDefault(),e.stopPropagation(),this.viewModel.next(),this._focusCurrentLevel()}},n._focusCurrentLevel=function(){const e=this._levelWidgets.find((e=>e.level===this.viewModel.value));e&&e.focus()},n._onFocus=function(){this._hoveredLevel=this._levels.length>0?this._levels[0]:null},n._onLevelToggle=function(e){this.viewModel.enabled&&this.viewModel.value===e?this.viewModel.clear():this.viewModel.select(e)},n._onArrowUpClick=function(){this.viewModel.next()},n._onArrowDownClick=function(){this.viewModel.previous()},n._onPointerPositionChange=function(){let e=0;this._levelWidgets.forEach(((t,o)=>{const{width:i,height:n}=this._getLevelWidgetSize(o);t.height=n,t.width=i,e+=n})),this._hoveredLevel=this._levelClosestToPointer;const t=this._expandedLevelsHeight;(null==t||Math.abs(t-e)>30)&&(this._expandedLevelsHeight=e)},n._getLevelWidgetSize=function(e){const t={width:this._levelWidth,height:this._levelHeight};if(this._hovering){const o=this._getGaussianFactor(e,this._normalizedPointerPosition);t.width+=E.LEVEL_HOVERED_EXTRA_WIDTH*o,t.height+=E.LEVEL_HOVERED_EXTRA_HEIGHT*o}return t},n._getGaussianFactor=function(e,t){const o=this._numLevels-1,i=(o-e)/o,n=this._gaussianFactor*(i-t);return Math.exp(-(n**2))},e._createClass(o,[{key:"_levelsHeight",get:function(){return Math.round(this._levelHeight*this._numLevels)}},{key:"_expandedLevelsMargin",get:function(){return Math.round((this._expandedLevelsHeight-this._levelsHeight)/2)}},{key:"_levelWidth",get:function(){const{LEVEL_WIDTH_NOMINATOR:e,LEVEL_WIDTH_CONSTANT:t}=E.constants,o=e/Math.sqrt(this._numLevels)+t;return Math.round(c.clamp(o,E.LEVEL_WIDTH_MIN,E.LEVEL_WIDTH_MAX))}},{key:"_levelHeight",get:function(){const e=E.LEVEL_HEIGHT_DEFAULT,t=2*e/Math.sqrt(this._numLevels);return Math.round(c.clamp(t,2,e))}},{key:"_gaussianFactor",get:function(){const e=this._numLevels;return e/Math.log(E.ALPHA_LEVEL_DEPENDENCY_FACTOR*e)*E.ALPHA_SPREAD_FACTOR}},{key:"_levelClosestToPointer",get:function(){if(!this._hovering)return null;const e=this._numLevels-1,t=this._normalizedPointerPosition;return e>=0&&i.isSome(t)?this._levels[Math.round((1-t)*e)]:null}}]),o}(y);return t.__decorate([s.property({type:m}),L.renderable(["viewModel.hasNext","viewModel.hasPrevious"])],H.prototype,"viewModel",void 0),t.__decorate([s.property()],H.prototype,"messages",void 0),t.__decorate([s.property(),L.renderable()],H.prototype,"_levelWidgets",void 0),t.__decorate([s.property(),L.renderable()],H.prototype,"_labelWidget",void 0),t.__decorate([s.property(),L.renderable()],H.prototype,"_hoveredLevel",void 0),t.__decorate([r.aliasOf("viewModel.allowedValues"),L.renderable()],H.prototype,"_levels",void 0),t.__decorate([r.aliasOf("_levels.length"),L.renderable()],H.prototype,"_numLevels",void 0),t.__decorate([s.property({readOnly:!0,dependsOn:["_numLevels","_levelHeight"]}),L.renderable()],H.prototype,"_levelsHeight",null),t.__decorate([s.property(),L.renderable()],H.prototype,"_expandedLevelsHeight",void 0),t.__decorate([s.property({readOnly:!0,dependsOn:["_expandedLevelsHeight","_levelsHeight"]}),L.renderable()],H.prototype,"_expandedLevelsMargin",null),t.__decorate([s.property({readOnly:!0,dependsOn:["_numLevels"]})],H.prototype,"_levelWidth",null),t.__decorate([s.property({readOnly:!0,dependsOn:["_numLevels"]})],H.prototype,"_levelHeight",null),t.__decorate([s.property({readOnly:!0,dependsOn:["_numLevels"]})],H.prototype,"_gaussianFactor",null),t.__decorate([s.property({readOnly:!0,dependsOn:["_levels","_numLevels","_hovering","_normalizedPointerPosition"]})],H.prototype,"_levelClosestToPointer",null),t.__decorate([s.property({type:Number,range:{min:0,max:1}}),L.renderable()],H.prototype,"_normalizedPointerPosition",void 0),t.__decorate([s.property()],H.prototype,"_hovering",void 0),t.__decorate([s.property()],H.prototype,"_containerPosTop",void 0),t.__decorate([s.property()],H.prototype,"_levelsContainer",void 0),H=t.__decorate([a.subclass("esri.widgets.BuildingExplorer.BuildingLevelPicker.BuildingLevelPicker")],H),H}));
