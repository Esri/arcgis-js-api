/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/events","../../../core/Handles","../../../core/mathUtils","../../../core/maybe","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../Widget","../../../chunks/constants","./Label","./LevelItem","../../support/widgetUtils","../../support/jsxFactory"],(function(e,t,n,o,i,l,r,s,a,_,v,h,d,c,p,u,g){"use strict";const L={selectLevel:"selectLevel",clearLevel:"clearLevel",nextLevel:"nextLevel",previousLevel:"previousLevel",currentLevel:"{{value}}"},y="esri-building-level-picker",m={container:y,noLevel:`${y}--no-level`,animateLevel:`${y}--animate-level`,levelsContainer:`${y}__levels-container`,innerLevelsContainer:`${y}__inner-levels-container`,labelContainer:`${y}__label-container`,arrowUp:`${y}__arrow-up`,arrowDown:`${y}__arrow-down`};let E=function(t){function s(n,i){var r;return(r=t.call(this,n,i)||this)._levelHandles=new o,r._levelEventHandles=new o,r._levelWidgets=[],r._labelWidget=new c.Label({onClear:()=>r.vm.clear()}),r._hoveredLevel=null,r._expandedLevelsHeight=void 0,r._normalizedPointerPosition=0,r._hovering=!1,r._containerPosTop=null,r._levelsContainer=null,r._onPointerUp=()=>{if(window.getSelection().removeAllRanges(),l.isNone(r._hoveredLevel))return;const{vm:t}=e._assertThisInitialized(r);t.enabled&&r._hoveredLevel===t.value?t.clear():t.select(r._hoveredLevel)},r._onPointerEnter=()=>{r._hovering||l.isNone(r._levelsContainer)||(r._hovering=!0,r._containerPosTop=r._levelsContainer.getBoundingClientRect().top??0)},r._onPointerLeave=()=>{r._hovering&&(r._normalizedPointerPosition=0,r._hoveredLevel=null,r._hovering=!1)},r._onPointerMove=e=>{if(!r._hovering)return!1;if(window.getSelection().removeAllRanges(),l.isSome(r._containerPosTop)){const t=r._containerPosTop,n=d.LEVELS_PADDING*d.LEVELS_MARGIN_FACTOR,o=r._expandedLevelsMargin;let i=r._levelsHeight,l=t+n+o;const s=r._levelHeight/2;l+=s,i-=s;let a=(e.clientY-l)/i;a+=d.LEVELS_POINTER_ADJUSTMENT,r._normalizedPointerPosition=a}return!1},r}e._inheritsLoose(s,t);var a=s.prototype;return a.postInitialize=function(){this.addHandles([r.watch((()=>this._levelsContainer),(()=>this._onContainerChange()),r.initial),r.watch((()=>this._levels),(()=>this._createLevelWidgets()),r.initial),r.watch((()=>this.messages),(()=>{this._labelWidget.messages=l.unwrapOr(this.messages,L)}),r.initial)])},a.destroy=function(){this._levelHandles.destroy(),this._levelEventHandles.destroy(),this._levelWidgets.forEach((e=>e.destroy())),this._labelWidget.destroy()},a.render=function(){const e=this._levelWidgets.length,t=e>1?this._levelWidgets.map((e=>e.render())):null,n=d.LEVELS_PADDING*d.LEVELS_MARGIN_FACTOR,o=-n/d.LEVELS_MARGIN_FACTOR,i=this._levelsHeight,l=i+2*n;return g.tsx("div",{bind:this,key:this,class:this.classes("esri-widget",m.container,{[m.animateLevel]:!this._hovering,[m.noLevel]:e<2}),onkeydown:this._onKeyDown},this._renderLabelContainer(),g.tsx("div",{bind:this,class:m.levelsContainer,styles:{height:`${l}px`,marginTop:`${o}px`,marginBottom:`${o}px`},onfocus:this._onFocus,afterCreate:u.storeNode,"data-node-ref":"_levelsContainer"},g.tsx("div",{styles:{height:`${i}px`,margin:d.LEVELS_PADDING-this._expandedLevelsMargin+"px 0 0 0"},class:m.innerLevelsContainer},t)))},a._renderLabelContainer=function(){const e=l.unwrapOr(this.messages,L),t=e.previousLevel,n=e.nextLevel;return g.tsx("div",{class:m.labelContainer,tabIndex:0},g.tsx("button",{bind:this,class:m.arrowUp,disabled:!this.vm.hasNext,onclick:this._onArrowUpClick,"aria-label":n,title:n,type:"button"}),this._labelWidget.render(),g.tsx("button",{bind:this,class:m.arrowDown,disabled:!this.vm.hasPrevious,onclick:this._onArrowDownClick,"aria-label":t,title:t,type:"button"}))},a._updateComponents=function(){const e=l.unwrapOr(this.messages,L),t=this.vm.enabled?this.vm.value:null,n=l.isSome(this._hoveredLevel)?this._hoveredLevel:t;this._levelWidgets.forEach((n=>{const o=this.vm.getValueLabel(n.level);n.label=l.isSome(o)?o:e.currentLevel?.replace("{{level}}",String(n.level)),n.active=n.level===t,n.hovering=n.level===this._hoveredLevel})),this._labelWidget.level=n,this._labelWidget.active=n===t,this._labelWidget.hovering=l.isSome(this._hoveredLevel)},a._createLevelWidgets=function(){this._levelWidgets.forEach((e=>e.destroy())),this._levelWidgets=this._levels.map((e=>new p.LevelItem({level:e,onSelect:()=>this._onLevelToggle(e)}))),this._levelHandles.removeAll(),this._levelHandles.add([r.watch((()=>{const{vm:e}=this;return[this.messages,e?.value,e?.enabled,this._hoveredLevel,this._hovering]}),(()=>this._updateComponents()),r.initial),r.watch((()=>[this._normalizedPointerPosition,this._hovering]),(()=>this._onPointerPositionChange()),r.initial),r.watch((()=>this._levelWidth),(e=>this._levelWidgets.forEach((t=>t.width=e))),r.initial)])},a._onContainerChange=function(){const e=this._levelsContainer;l.isNone(e)||(this._levelEventHandles.removeAll(),this._levelEventHandles.add([n.on(e,"pointerenter",this._onPointerEnter),n.on(e,"pointerover",this._onPointerEnter),n.on(e,"pointerleave",this._onPointerLeave),n.on(e,"pointerup",this._onPointerUp),n.on(e,"pointermove",this._onPointerMove)]))},a._onKeyDown=function(e){switch(e.key){case"ArrowDown":case"ArrowLeft":e.preventDefault(),e.stopPropagation(),this.vm.previous(),this._focusCurrentLevel();break;case"ArrowUp":case"ArrowRight":e.preventDefault(),e.stopPropagation(),this.vm.next(),this._focusCurrentLevel()}},a._focusCurrentLevel=function(){const e=this._levelWidgets.find((e=>e.level===this.vm.value));e&&e.focus()},a._onFocus=function(){this._hoveredLevel=this._levels.length>0?this._levels[0]:null},a._onLevelToggle=function(e){const{vm:t}=this;t.enabled&&t.value===e?t.clear():t.select(e)},a._onArrowUpClick=function(){this.vm.next()},a._onArrowDownClick=function(){this.vm.previous()},a._onPointerPositionChange=function(){let e=0;this._levelWidgets.forEach(((t,n)=>{const{width:o,height:i}=this._getLevelWidgetSize(n);t.height=i,t.width=o,e+=i})),this._hoveredLevel=this._levelClosestToPointer;const t=this._expandedLevelsHeight;(null==t||Math.abs(t-e)>30)&&(this._expandedLevelsHeight=e)},a._getLevelWidgetSize=function(e){const t={width:this._levelWidth,height:this._levelHeight};if(this._hovering){const n=this._getGaussianFactor(e,this._normalizedPointerPosition);t.width+=d.LEVEL_HOVERED_EXTRA_WIDTH*n,t.height+=d.LEVEL_HOVERED_EXTRA_HEIGHT*n}return t},a._getGaussianFactor=function(e,t){const n=this._numLevels-1,o=(n-e)/n,i=this._gaussianFactor*(o-t);return Math.exp(-(i**2))},e._createClass(s,[{key:"_levels",get:function(){return this.vm.allowedValues}},{key:"_numLevels",get:function(){return this._levels.length}},{key:"_levelsHeight",get:function(){return Math.round(this._levelHeight*this._numLevels)}},{key:"_expandedLevelsMargin",get:function(){return Math.round((this._expandedLevelsHeight-this._levelsHeight)/2)}},{key:"_levelWidth",get:function(){const{LEVEL_WIDTH_NOMINATOR:e,LEVEL_WIDTH_CONSTANT:t}=d.constants,n=e/Math.sqrt(this._numLevels)+t;return Math.round(i.clamp(n,d.LEVEL_WIDTH_MIN,d.LEVEL_WIDTH_MAX))}},{key:"_levelHeight",get:function(){const e=d.LEVEL_HEIGHT_DEFAULT,t=2*e/Math.sqrt(this._numLevels);return Math.round(i.clamp(t,2,e))}},{key:"_gaussianFactor",get:function(){const e=this._numLevels;return e/Math.log(d.ALPHA_LEVEL_DEPENDENCY_FACTOR*e)*d.ALPHA_SPREAD_FACTOR}},{key:"_levelClosestToPointer",get:function(){if(!this._hovering)return null;const e=this._numLevels-1,t=this._normalizedPointerPosition;return e>=0&&l.isSome(t)?this._levels[Math.round((1-t)*e)]:null}}]),s}(h);t.__decorate([s.property()],E.prototype,"vm",void 0),t.__decorate([s.property()],E.prototype,"messages",void 0),t.__decorate([s.property()],E.prototype,"_levelWidgets",void 0),t.__decorate([s.property()],E.prototype,"_labelWidget",void 0),t.__decorate([s.property()],E.prototype,"_hoveredLevel",void 0),t.__decorate([s.property()],E.prototype,"_levels",null),t.__decorate([s.property()],E.prototype,"_numLevels",null),t.__decorate([s.property({readOnly:!0})],E.prototype,"_levelsHeight",null),t.__decorate([s.property()],E.prototype,"_expandedLevelsHeight",void 0),t.__decorate([s.property({readOnly:!0})],E.prototype,"_expandedLevelsMargin",null),t.__decorate([s.property({readOnly:!0})],E.prototype,"_levelWidth",null),t.__decorate([s.property({readOnly:!0})],E.prototype,"_levelHeight",null),t.__decorate([s.property({readOnly:!0})],E.prototype,"_gaussianFactor",null),t.__decorate([s.property({readOnly:!0})],E.prototype,"_levelClosestToPointer",null),t.__decorate([s.property({type:Number,range:{min:0,max:1}})],E.prototype,"_normalizedPointerPosition",void 0),t.__decorate([s.property()],E.prototype,"_hovering",void 0),t.__decorate([s.property()],E.prototype,"_containerPosTop",void 0),t.__decorate([s.property()],E.prototype,"_levelsContainer",void 0),E=t.__decorate([v.subclass("esri.widgets.BuildingExplorer.BuildingLevelPicker.BuildingLevelPicker")],E);return E}));
