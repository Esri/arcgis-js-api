/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/Accessor","../../core/Collection","../../core/collectionUtils","../../core/Handles","../../core/Logger","../../core/maybe","../../core/promiseUtils","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/arrayUtils","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass","../../layers/BuildingSceneLayer","../../layers/support/BuildingFilter","./BuildingDisciplinesViewModel","./BuildingLevel","./BuildingPhase","./support/buildingLayerUtils","./support/filterUtils","./support/layerUtils"],(function(e,t,s,r,i,l,o,a,n,d,p,c,y,h,u,_,g,f,v,w,L,B){"use strict";let S=function(t){function s(e){var s;return(s=t.call(this,e)||this).view=null,s.state="disabled",s.level=new f,s.phase=new v,s.disciplines=new g,s._handles=new l,s._loadLayers=B.createLoadLayersFunction(),s.layers=new r,s}e._inheritsLoose(s,t);var p=s.prototype;return p.initialize=function(){this._handles.add([this.layers.on("change",(()=>this._onLayersChange())),d.watch((()=>({state:this.state,layers:this.layers,filter:this._filter})),(({state:e,layers:t,filter:s})=>{"ready"===e&&L.setFilterOnLayers(t,s)}),{initial:!0})]),this._onLayersChange()},p.destroy=function(){this._handles.destroy(),this.level.destroyed||this.level.destroy(),this.phase.destroyed||this.phase.destroy(),this.disciplines.destroyed||this.disciplines.destroy()},p._onLayersChange=function(){var t=e._asyncToGenerator((function*(){const e=this.layers;if(this.level.layers=e,this.phase.layers=e,this.disciplines.layers=e,0!==e.length){this._set("state","loading");try{yield this._loadLayers(e),yield Promise.all([d.whenOnce((()=>"ready"===this.level.state)),d.whenOnce((()=>"ready"===this.phase.state)),d.whenOnce((()=>"ready"===this.disciplines.state))]),e.forEach(w.showFullModel),this._set("state","ready")}catch(t){n.isAbortError(t)||this._set("state","failed")}}else this._set("state","disabled")}));function s(){return t.apply(this,arguments)}return s}(),e._createClass(s,[{key:"isSupported",get:function(){return"3d"===this.view?.type}},{key:"layers",get:function(){return this._get("layers")},set:function(e){const t=e.filter((e=>e instanceof u));t.length!==e.length&&o.getLogger(this.declaredClass).error("Some layers are not BuildingSceneLayers but only BuildingSceneLayers can be passed to the widget."),this._set("layers",i.referenceSetter(t,this._get("layers")))}},{key:"_filter",get:function(){const e=this.level.filterExpressions,t=this.phase.filterExpressions,s=[],r=L.getFilterBlockSolid([e.solid,t.solid]);a.isSome(r)&&s.push(r);const i=L.getFilterBlockXRay([e.xRay,t.xRay]);return a.isSome(i)&&s.push(i),0===s.length?null:new _({id:L.generateFilterId(),name:"Building Explorer Filter",filterBlocks:s})}}]),s}(s);t.__decorate([p.property({value:null})],S.prototype,"view",void 0),t.__decorate([p.property()],S.prototype,"isSupported",null),t.__decorate([p.property({type:r,nonNullable:!0})],S.prototype,"layers",null),t.__decorate([p.property({readOnly:!0})],S.prototype,"state",void 0),t.__decorate([p.property({readOnly:!0,type:f})],S.prototype,"level",void 0),t.__decorate([p.property({readOnly:!0,type:v})],S.prototype,"phase",void 0),t.__decorate([p.property({readOnly:!0,type:g})],S.prototype,"disciplines",void 0),t.__decorate([p.property()],S.prototype,"_filter",null),S=t.__decorate([h.subclass("esri.widgets.BuildingExplorer.BuildingExplorerViewModel")],S);return S}));
