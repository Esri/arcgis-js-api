/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/has","../../core/maybe","../../core/Logger","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/subclass","../../core/urlUtils","../../core/uuid","../../portal/support/resourceExtension","../../core/promiseUtils","../../core/Accessor","../../core/Collection","../../core/collectionUtils","../../core/Handles","../../core/watchUtils","../../layers/support/BuildingFilter","../../layers/BuildingSceneLayer","./support/buildingLayerUtils","./support/layerUtils","./BuildingDisciplinesViewModel","./support/filterUtils","./BuildingLevel","./BuildingPhase"],(function(e,t,s,r,i,l,o,a,n,p,d,c,y,h,u,_,g,f,v,w,B,L,E,S,b){"use strict";const x=i.getLogger("esri.widgets.BuildingExplorer.BuildingExplorerViewModel");let O=function(t){function s(e){var s;return(s=t.call(this,e)||this).view=null,s.state="disabled",s.level=new S,s.phase=new b,s.disciplines=new L,s._handles=new _,s._loadLayers=B.createLoadLayersFunction(),s.layers=new h,s}e._inheritsLoose(s,t);var i=s.prototype;return i.initialize=function(){this._handles.add([this.layers.on("change",(()=>this._onLayersChange())),g.init(this,"_filter",(()=>E.setFilterOnLayers(this.layers,this._filter)))]),this._onLayersChange()},i.destroy=function(){this._handles.destroy(),this.level.destroyed||this.level.destroy(),this.phase.destroyed||this.phase.destroy(),this.disciplines.destroyed||this.disciplines.destroy()},i._onLayersChange=async function(){if(this.level.layers=this.layers,this.phase.layers=this.layers,this.disciplines.layers=this.layers,0!==this.layers.length){this._set("state","loading");try{await this._loadLayers(this.layers),await c.all([g.whenEqualOnce(this.level,"state","ready"),g.whenEqualOnce(this.phase,"state","ready"),g.whenEqualOnce(this.disciplines,"state","ready")]),this.layers.forEach(w.showFullModel),this._set("state","ready")}catch(e){c.isAbortError(e)||this._set("state","failed")}}else this._set("state","disabled")},e._createClass(s,[{key:"isSupported",get:function(){var e;return"3d"===(null==(e=this.view)?void 0:e.type)}},{key:"layers",set:function(e){const t=e.filter((e=>e instanceof v));t.length!==e.length&&x.error("Some layers are not BuildingSceneLayers but only BuildingSceneLayers can be passed to the widget."),this._set("layers",u.referenceSetter(t,this._get("layers")))}},{key:"_filter",get:function(){const e=this.level.filterExpressions,t=this.phase.filterExpressions,s=[],i=E.getFilterBlockSolid([e.solid,t.solid]);r.isSome(i)&&s.push(i);const l=E.getFilterBlockXRay([e.xRay,t.xRay]);return r.isSome(l)&&s.push(l),0===s.length?null:new f({id:E.generateFilterId(),name:"Building Explorer Filter",filterBlocks:s})}}]),s}(y);return t.__decorate([o.property({value:null})],O.prototype,"view",void 0),t.__decorate([o.property({dependsOn:["view.type"]})],O.prototype,"isSupported",null),t.__decorate([o.property({type:h,nonNullable:!0})],O.prototype,"layers",null),t.__decorate([o.property({readOnly:!0})],O.prototype,"state",void 0),t.__decorate([o.property({readOnly:!0,type:S})],O.prototype,"level",void 0),t.__decorate([o.property({readOnly:!0,type:b})],O.prototype,"phase",void 0),t.__decorate([o.property({readOnly:!0,type:L})],O.prototype,"disciplines",void 0),t.__decorate([o.property({readOnly:!0,dependsOn:["level.filterExpressions","phase.filterExpressions"]})],O.prototype,"_filter",null),O=t.__decorate([a.subclass("esri.widgets.BuildingExplorer.BuildingExplorerViewModel")],O),O}));
