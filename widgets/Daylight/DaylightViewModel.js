/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/has","../../core/maybe","../../core/Logger","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/subclass","../../core/urlUtils","../../core/uuid","../../portal/support/resourceExtension","../../core/scheduling","../../core/watchUtils","../../core/HandleOwner","../../views/3d/environment/SceneViewLighting","../../views/3d/support/earthUtils","../../views/SceneView","./daylightUtils","./support/SliderWithDropdownViewModel","../support/DatePickerViewModel"],(function(e,t,i,n,a,s,o,r,l,h,d,p,g,c,u,y,_,m,w,f){"use strict";let v=function(t){function i(e){var i;return(i=t.call(this,e)||this).view=null,i.datePickerViewModel=new f,i.timeSliderViewModel=new w.SliderWithDropdownViewModel,i.lightingUpdateInterval=200,i._cachedLightingDateUTC=new Date(0),i._cachedDisplayUTCOffset=0,i._enableShadowsOnFirstInteraction=!0,i._lastLightingUpdate=0,i._nextLightingUpdate=null,i.playSpeedMultiplier=1,i}e._inheritsLoose(i,t);var a=i.prototype;return a.initialize=function(){this.handles.add([g.init(this,"view",(()=>{this.view&&this.view.when((()=>this._updateLighting(null)))})),g.watch(this,"view.environment.lighting.date",(e=>this._scheduleUpdateLighting(e))),g.on(this,"view.environment.lighting","timezone-will-change",(e=>this._timezoneWillChange(e)),(()=>this._timezoneWillChange(null))),g.init(this,"view.stationary",(()=>{(this.dayPlaying||this.yearPlaying)&&this._updateSunriseAndSunset()})),this.watch(["timeSliderPosition","timeSliderViewModel.state"],(()=>{"ready"===this.timeSliderViewModel.state&&this.timeSliderViewModel.setValue(0,this.timeSliderPosition)})),this.timeSliderViewModel.watch("currentItem",(e=>this.utcOffset=e.abbr)),this.timeSliderViewModel.watch("isDropdownOpen",(()=>this.stopPlaying())),this.timeSliderViewModel.watch("values",(e=>this.timeSliderPosition=e[0])),this.datePickerViewModel.watch("value",(e=>{this.dayPlaying=!1,this.localDate=e})),this.watch("localDate",(async e=>{this.datePickerViewModel.value.valueOf()!==e.getTime()&&this.datePickerViewModel.set("value",e)}))])},a.destroy=function(){this._nextLightingUpdate&&(clearTimeout(this._nextLightingUpdate),this._nextLightingUpdate=null),this.view=null},a._timezoneFromCamera=function(e){var t;const i=null==(t=e.camera)?void 0:t.position;if(!i||!e.environment.lighting.cameraTrackingEnabled)return 0;const a=n.unwrap(y.positionToTimezone([i.longitude,i.latitude]));return Math.round(a.hours+a.minutes/60+a.seconds/3600)},a.stopPlaying=function(){this.playingState="none"},a.toggleDayPlaying=function(){this.dayPlaying=!this.dayPlaying},a.toggleYearPlaying=function(){this.yearPlaying=!this.yearPlaying},a.toggleDirectShadows=function(){this.stopPlaying(),this.directShadowsEnabled=!this.directShadowsEnabled},a._updateLighting=function(e){var t,i;const n=Date.now();this._lastLightingUpdate=n;const a=null==(t=this.view)||null==(i=t.environment)?void 0:i.lighting;if(!a)return;const s=e||a.date,o=a.displayUTCOffset,r=null!==o?o:this._timezoneFromCamera(this.view);this._cachedLightingDateUTC.getTime()!==s.getTime()&&(this._cachedLightingDateUTC=new Date(s.getTime())),this._cachedDisplayUTCOffset!==r&&(this._cachedDisplayUTCOffset=r)},a._timezoneWillChange=function(e){var t,i;const n=null==(t=this.view)||null==(i=t.environment)?void 0:i.lighting;if(!n||!n.cameraTrackingEnabled)return;let a;if(e)a=e.timezoneOffset;else{if(null!=n.displayUTCOffset)return;a=u.calculateTimezoneOffset(n.positionTimezoneInfo)}n.displayUTCOffset=a,this._scheduleUpdateLighting(null)},a._scheduleUpdateLighting=function(e){if(this._nextLightingUpdate)return;const t=Date.now()-this._lastLightingUpdate,i=this.lightingUpdateInterval-t;i<=0?p.schedule((()=>this._updateLighting(e))):this._nextLightingUpdate=setTimeout((()=>{this._updateLighting(null),this._nextLightingUpdate=null}),i)},a._play=function(){var e;const t=this.view;if(null!=(e=this.view)&&e.environment&&(this.dayPlaying||this.yearPlaying)){const e=(new Date).getTime()-this._lastTime;if(this.dayPlaying){this._lastTime=(new Date).getTime();const i=m.calculatePlaySpeed(this._sunrise,this._sunset,t.environment.lighting.date)*this.playSpeedMultiplier/100*e;if(i>0){let e=new Date(t.environment.lighting.date.getTime()+i);if(((e.getUTCHours()+t.environment.lighting.displayUTCOffset)%24+24)%24<((t.environment.lighting.date.getUTCHours()+t.environment.lighting.displayUTCOffset)%24+24)%24){const n=864e5;e=new Date(t.environment.lighting.date.getTime()+i-n)}t.environment.lighting.date=e}}else{if(e>1e3){this._lastTime=(new Date).getTime();const e=(t.environment.lighting.date.getUTCMonth()+1)%12,i=new Date(t.environment.lighting.date.getTime());i.setUTCMonth(e),t.environment.lighting.date=i}}requestAnimationFrame((()=>this._play()))}},a._updateSunriseAndSunset=function(){const e=m.getSunriseAndSunsetTimes(this.view.environment.lighting.date,this.view.camera.position.latitude,this.view.camera.position.longitude,this.view.environment.lighting.displayUTCOffset);this._sunrise=new Date(e.sunrise),this._sunset=new Date(e.sunset)},e._createClass(i,[{key:"isSupported",get:function(){return!this.view||"3d"===this.view.type}},{key:"utcOffset",get:function(){return this._cachedDisplayUTCOffset},set:function(e){e!==this.utcOffset&&(this.view.environment.lighting.displayUTCOffset=e,this._updateLighting(null))}},{key:"localDate",get:function(){return m.dateTimeToLocalDate(this._lightingDateDisplay)},set:function(e){if(e.getTime()!==this.localDate.getTime()){const t=m.localDateToDateTime(this._lightingDateDisplay,e);this._lightingDateDisplay=t}}},{key:"timeSliderPosition",get:function(){return m.dateTimeToSliderPos(this._lightingDateDisplay)},set:function(e){if(Math.abs(e-this.timeSliderPosition)>1/60){const t=m.sliderPosToDateTime(this._lightingDateDisplay,e);this._lightingDateDisplay=t,this.stopPlaying(),this._enableShadowsOnFirstInteraction&&(this.directShadowsEnabled=!0,this._enableShadowsOnFirstInteraction=!1)}}},{key:"_lightingDateDisplay",get:function(){return m.dateAddHours(this._cachedLightingDateUTC,this._cachedDisplayUTCOffset)},set:function(e){const t=m.dateAddHours(e,-this._cachedDisplayUTCOffset);t.getTime()!==this.view.environment.lighting.date.getTime()&&(this.view.environment.lighting.date=t,this._updateLighting(null))}},{key:"playingState",set:function(e){this.playingState!==e&&(this._set("playingState",e),"none"!==e&&(this._updateSunriseAndSunset(),this._lastTime=(new Date).getTime(),this._play(),this._enableShadowsOnFirstInteraction&&(this.directShadowsEnabled=!0,this._enableShadowsOnFirstInteraction=!1)))}},{key:"dayPlaying",get:function(){return"day"===this.playingState},set:function(e){e?this.playingState="day":this.dayPlaying&&(this.playingState="none")}},{key:"yearPlaying",get:function(){return"year"===this.playingState},set:function(e){e?this.playingState="year":this.yearPlaying&&(this.playingState="none")}},{key:"currentSeason",get:function(){return m.getSeasonFromDate(this.localDate,this._currentHemisphere)},set:function(e){this.stopPlaying();const t=m.getNorthernHemisphereSeason(e,this._currentHemisphere);this.localDate=m.getSeasonDate(this.localDate,t,m.Hemisphere.NORTHERN)}},{key:"_currentHemisphere",get:function(){var e,t;const i=null==(e=this.view)||null==(t=e.camera)?void 0:t.position;return i?i.latitude>=0?m.Hemisphere.NORTHERN:m.Hemisphere.SOUTHERN:m.Hemisphere.NORTHERN}}]),i}(c.HandleOwner);return t.__decorate([o.property({type:_})],v.prototype,"view",void 0),t.__decorate([o.property({type:f})],v.prototype,"datePickerViewModel",void 0),t.__decorate([o.property({type:w.SliderWithDropdownViewModel})],v.prototype,"timeSliderViewModel",void 0),t.__decorate([o.property({dependsOn:["view.type"]})],v.prototype,"isSupported",null),t.__decorate([o.property()],v.prototype,"lightingUpdateInterval",void 0),t.__decorate([o.property()],v.prototype,"_cachedLightingDateUTC",void 0),t.__decorate([o.property()],v.prototype,"_cachedDisplayUTCOffset",void 0),t.__decorate([o.property()],v.prototype,"_enableShadowsOnFirstInteraction",void 0),t.__decorate([o.property({dependsOn:["_cachedDisplayUTCOffset"]})],v.prototype,"utcOffset",null),t.__decorate([o.property({dependsOn:["_lightingDateDisplay"]})],v.prototype,"localDate",null),t.__decorate([o.property({dependsOn:["_lightingDateDisplay"]})],v.prototype,"timeSliderPosition",null),t.__decorate([o.property({dependsOn:["_cachedDisplayUTCOffset","_cachedLightingDateUTC"]})],v.prototype,"_lightingDateDisplay",null),t.__decorate([o.property({aliasOf:"view.environment.lighting.directShadowsEnabled"})],v.prototype,"directShadowsEnabled",void 0),t.__decorate([o.property({type:["none","day","year"],value:"none"})],v.prototype,"playingState",null),t.__decorate([o.property({dependsOn:["playingState"]})],v.prototype,"dayPlaying",null),t.__decorate([o.property({dependsOn:["playingState"]})],v.prototype,"yearPlaying",null),t.__decorate([o.property()],v.prototype,"playSpeedMultiplier",void 0),t.__decorate([o.property({dependsOn:["localDate","_currentHemisphere"]})],v.prototype,"currentSeason",null),t.__decorate([o.property()],v.prototype,"_lastTime",void 0),t.__decorate([o.property()],v.prototype,"_sunrise",void 0),t.__decorate([o.property()],v.prototype,"_sunset",void 0),t.__decorate([o.property({readOnly:!0,dependsOn:["view.camera.position.latitude"]})],v.prototype,"_currentHemisphere",null),v=t.__decorate([r.subclass("esri.widgets.Daylight.DaylightViewModel")],v),v}));
