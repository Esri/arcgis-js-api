/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/HandleOwner","../../core/maybe","../../core/reactiveUtils","../../core/scheduling","../../core/timeUtils","../../core/accessorSupport/decorators/property","../../core/arrayUtils","../../core/has","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass","../../views/SceneView","../../views/3d/environment/SunLighting","../../views/3d/support/earthUtils","./support/daylightUtils","./support/SliderWithDropdownViewModel","../support/DatePickerViewModel","../support/timeWidgetUtils"],(function(e,t,i,n,a,o,s,r,l,h,d,p,g,c,u,y,_,v,m){"use strict";let f=function(t){function i(e){var i;return(i=t.call(this,e)||this).view=null,i.datePickerViewModel=new v,i.timeSliderViewModel=new _.SliderWithDropdownViewModel,i.lightingUpdateInterval=200,i._cachedLightingDateUTC=new Date(0),i._cachedDisplayUTCOffset=0,i._enableShadowsOnFirstInteraction=!0,i._lastLightingUpdate=0,i._nextLightingUpdate=null,i.playSpeedMultiplier=1,i}e._inheritsLoose(i,t);var r=i.prototype;return r.initialize=function(){this.handles.add([a.when((()=>this.view),(e=>e.when((()=>this._updateLighting(null)))),a.initial),a.watch((()=>{var e;return null==(e=this.view)?void 0:e.environment.lighting.date}),(e=>this._scheduleUpdateLighting(e))),a.on((()=>{var e;return null==(e=this.view)?void 0:e.environment.lighting}),"timezone-will-change",(e=>this._timezoneWillChange(e)),{onListenerAdd:()=>this._timezoneWillChange(null)}),a.watch((()=>{var e;return null==(e=this.view)?void 0:e.stationary}),(()=>{(this.dayPlaying||this.yearPlaying)&&this._updateSunriseAndSunset()}),a.initial),a.watch((()=>{const e=this.timeSliderViewModel;return{vm:e,state:e.state,sliderPosition:this.timeSliderPosition}}),(({vm:e,state:t,sliderPosition:i})=>{"ready"===t&&e.setValue(0,i)})),a.watch((()=>{var e;return null==(e=this.timeSliderViewModel.currentItem)?void 0:e.utcOffset}),(e=>this.utcOffset=e)),a.watch((()=>this.timeSliderViewModel.isDropdownOpen),(()=>this.stopPlaying())),a.watch((()=>this.timeSliderViewModel.values),(e=>this.timeSliderPosition=e[0])),a.watch((()=>this.datePickerViewModel.value),(e=>{this.dayPlaying=!1,this.localDate=e})),a.watch((()=>this.localDate),(e=>{this.datePickerViewModel.value.valueOf()!==e.getTime()&&this.datePickerViewModel.set("value",e)}))])},r.destroy=function(){this._nextLightingUpdate&&(clearTimeout(this._nextLightingUpdate),this._nextLightingUpdate=null),this.view=null},r._timezoneFromCamera=function(e){var t;const i=null==(t=e.camera)?void 0:t.position;if(!i||"virtual"===e.environment.lighting.type||!e.environment.lighting.cameraTrackingEnabled)return 0;const a=n.unwrap(u.positionToTimezoneInfo([i.longitude,i.latitude]));return Math.round(a.hours+a.minutes/60+a.seconds/3600)},r.stopPlaying=function(){this.playingState="none"},r.toggleDayPlaying=function(){this.dayPlaying=!this.dayPlaying},r.toggleYearPlaying=function(){this.yearPlaying=!this.yearPlaying},r.toggleDirectShadows=function(){this.stopPlaying(),this.directShadowsEnabled=!this.directShadowsEnabled},r._updateLighting=function(e){var t;const i=Date.now();this._lastLightingUpdate=i;const n=null==(t=this.view)?void 0:t.environment.lighting;if(!n||"virtual"===n.type)return;const a=e||n.date,o=n.displayUTCOffset,s=null!==o?o:this._timezoneFromCamera(this.view);this._cachedLightingDateUTC.getTime()!==a.getTime()&&(this._cachedLightingDateUTC=new Date(a.getTime())),this._cachedDisplayUTCOffset!==s&&(this._cachedDisplayUTCOffset=s)},r._timezoneWillChange=function(e){var t;const i=null==(t=this.view)?void 0:t.environment.lighting;if(!i||"virtual"===i.type||!i.cameraTrackingEnabled)return;let n;if(e)n=e.timezoneOffset;else{if(null!=i.displayUTCOffset)return;n=c.calculateTimezoneOffset(i.positionTimezoneInfo)}i.displayUTCOffset=n,this._scheduleUpdateLighting(null)},r._scheduleUpdateLighting=function(e){if(this._nextLightingUpdate)return;const t=Date.now()-this._lastLightingUpdate,i=this.lightingUpdateInterval-t;i<=0?o.schedule((()=>this._updateLighting(e))):this._nextLightingUpdate=setTimeout((()=>{this._updateLighting(null),this._nextLightingUpdate=null}),i)},r._play=function(){var e;const t=this.view;if(null!=(e=this.view)&&e.environment&&"virtual"!==this.view.environment.lighting.type&&(this.dayPlaying||this.yearPlaying)){const e=Date.now()-this._lastTime;if(this.dayPlaying){this._lastTime=Date.now();const i=y.calculatePlaySpeed(this._sunrise,this._sunset,t.environment.lighting.date)*this.playSpeedMultiplier/100*e;if(i>0){let e=new Date(t.environment.lighting.date.getTime()+i);if(((e.getUTCHours()+t.environment.lighting.displayUTCOffset)%24+24)%24<((t.environment.lighting.date.getUTCHours()+t.environment.lighting.displayUTCOffset)%24+24)%24){const n=864e5;e=new Date(t.environment.lighting.date.getTime()+i-n)}t.environment.lighting.date=e}}else{if(e>1e3){this._lastTime=Date.now();const e=(t.environment.lighting.date.getUTCMonth()+1)%12,i=new Date(t.environment.lighting.date.getTime());i.setUTCMonth(e),t.environment.lighting.date=i}}requestAnimationFrame((()=>this._play()))}},r._updateSunriseAndSunset=function(){const e=m.getSunriseAndSunsetTimes(this.view.environment.lighting.date,this.view.camera.position.latitude,this.view.camera.position.longitude,this.view.environment.lighting.displayUTCOffset);this._sunrise=new Date(e.sunrise),this._sunset=new Date(e.sunset)},e._createClass(i,[{key:"isSupported",get:function(){return!this.view||"3d"===this.view.type}},{key:"utcOffset",get:function(){return this._cachedDisplayUTCOffset},set:function(e){e!==this.utcOffset&&(this.view.environment.lighting.displayUTCOffset=e,this._updateLighting(null))}},{key:"localDate",get:function(){return s.truncateLocalTime(this._lightingDateDisplay)},set:function(e){e.getTime()!==this.localDate.getTime()&&(this._lightingDateDisplay=s.resetUTCDate(this._lightingDateDisplay,e))}},{key:"timeSliderPosition",get:function(){return y.dateTimeToSliderPos(this._lightingDateDisplay)},set:function(e){Math.abs(e-this.timeSliderPosition)>1/60&&(this._lightingDateDisplay=y.sliderPosToDateTime(this._lightingDateDisplay,e),this.stopPlaying(),this._enableShadowsOnFirstInteraction&&(this.directShadowsEnabled=!0,this._enableShadowsOnFirstInteraction=!1))}},{key:"_lightingDateDisplay",get:function(){return s.offsetDate(this._cachedLightingDateUTC,this._cachedDisplayUTCOffset,"hours")},set:function(e){if("virtual"!==this.view.environment.lighting.type){const t=s.offsetDate(e,-this._cachedDisplayUTCOffset,"hours");t.getTime()!==this.view.environment.lighting.date.getTime()&&(this.view.environment.lighting.date=t,this._updateLighting(null))}}},{key:"playingState",set:function(e){this.playingState!==e&&"virtual"!==this.view.environment.lighting.type&&(this._set("playingState",e),"none"!==e&&(this._updateSunriseAndSunset(),this._lastTime=Date.now(),this._play(),this._enableShadowsOnFirstInteraction&&(this.directShadowsEnabled=!0,this._enableShadowsOnFirstInteraction=!1)))}},{key:"dayPlaying",get:function(){return"day"===this.playingState},set:function(e){e?this.playingState="day":this.dayPlaying&&(this.playingState="none")}},{key:"yearPlaying",get:function(){return"year"===this.playingState},set:function(e){e?this.playingState="year":this.yearPlaying&&(this.playingState="none")}},{key:"currentSeason",get:function(){return y.getSeasonFromDate(this.localDate,this._currentHemisphere)},set:function(e){this.stopPlaying();const t=y.getNorthernHemisphereSeason(e,this._currentHemisphere);this.localDate=y.getSeasonDate(this.localDate,t,y.Hemisphere.NORTHERN)}},{key:"_currentHemisphere",get:function(){var e,t;const i=null==(e=this.view)||null==(t=e.camera)?void 0:t.position;return i?i.latitude>=0?y.Hemisphere.NORTHERN:y.Hemisphere.SOUTHERN:y.Hemisphere.NORTHERN}}]),i}(i.HandleOwner);t.__decorate([r.property({type:g})],f.prototype,"view",void 0),t.__decorate([r.property({type:v,nonNullable:!0})],f.prototype,"datePickerViewModel",void 0),t.__decorate([r.property({type:_.SliderWithDropdownViewModel,nonNullable:!0})],f.prototype,"timeSliderViewModel",void 0),t.__decorate([r.property()],f.prototype,"isSupported",null),t.__decorate([r.property()],f.prototype,"lightingUpdateInterval",void 0),t.__decorate([r.property()],f.prototype,"_cachedLightingDateUTC",void 0),t.__decorate([r.property()],f.prototype,"_cachedDisplayUTCOffset",void 0),t.__decorate([r.property()],f.prototype,"_enableShadowsOnFirstInteraction",void 0),t.__decorate([r.property()],f.prototype,"utcOffset",null),t.__decorate([r.property()],f.prototype,"localDate",null),t.__decorate([r.property()],f.prototype,"timeSliderPosition",null),t.__decorate([r.property()],f.prototype,"_lightingDateDisplay",null),t.__decorate([r.property({aliasOf:"view.environment.lighting.directShadowsEnabled"})],f.prototype,"directShadowsEnabled",void 0),t.__decorate([r.property({type:["none","day","year"],value:"none"})],f.prototype,"playingState",null),t.__decorate([r.property()],f.prototype,"dayPlaying",null),t.__decorate([r.property()],f.prototype,"yearPlaying",null),t.__decorate([r.property()],f.prototype,"playSpeedMultiplier",void 0),t.__decorate([r.property()],f.prototype,"currentSeason",null),t.__decorate([r.property()],f.prototype,"_lastTime",void 0),t.__decorate([r.property()],f.prototype,"_sunrise",void 0),t.__decorate([r.property()],f.prototype,"_sunset",void 0),t.__decorate([r.property({readOnly:!0})],f.prototype,"_currentHemisphere",null),f=t.__decorate([p.subclass("esri.widgets.Daylight.DaylightViewModel")],f);return f}));
