/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/HandleOwner","../../core/maybe","../../core/scheduling","../../core/timeUtils","../../core/watchUtils","../../core/accessorSupport/decorators/property","../../core/arrayUtils","../../core/has","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass","../../views/SceneView","../../views/3d/environment/SceneViewLighting","../../views/3d/support/earthUtils","./support/daylightUtils","./support/SliderWithDropdownViewModel","../support/DatePickerViewModel","../support/timeWidgetUtils"],(function(e,t,i,n,a,s,o,r,l,h,d,p,g,c,u,y,_,m,f){"use strict";let w=function(t){function i(e){var i;return(i=t.call(this,e)||this).view=null,i.datePickerViewModel=new m,i.timeSliderViewModel=new _.SliderWithDropdownViewModel,i.lightingUpdateInterval=200,i._cachedLightingDateUTC=new Date(0),i._cachedDisplayUTCOffset=0,i._enableShadowsOnFirstInteraction=!0,i._lastLightingUpdate=0,i._nextLightingUpdate=null,i.playSpeedMultiplier=1,i}e._inheritsLoose(i,t);var r=i.prototype;return r.initialize=function(){var t=this;this.handles.add([o.init(this,"view",(()=>{this.view&&this.view.when((()=>this._updateLighting(null)))})),o.watch(this,"view.environment.lighting.date",(e=>this._scheduleUpdateLighting(e))),o.on(this,"view.environment.lighting","timezone-will-change",(e=>this._timezoneWillChange(e)),(()=>this._timezoneWillChange(null))),o.init(this,"view.stationary",(()=>{(this.dayPlaying||this.yearPlaying)&&this._updateSunriseAndSunset()})),this.watch(["timeSliderPosition","timeSliderViewModel.state"],(()=>{"ready"===this.timeSliderViewModel.state&&this.timeSliderViewModel.setValue(0,this.timeSliderPosition)})),this.timeSliderViewModel.watch("currentItem",(e=>{this.utcOffset=e.utcOffset})),this.timeSliderViewModel.watch("isDropdownOpen",(()=>this.stopPlaying())),this.timeSliderViewModel.watch("values",(e=>this.timeSliderPosition=e[0])),this.datePickerViewModel.watch("value",(e=>{this.dayPlaying=!1,this.localDate=e})),this.watch("localDate",function(){var i=e._asyncToGenerator((function*(e){t.datePickerViewModel.value.valueOf()!==e.getTime()&&t.datePickerViewModel.set("value",e)}));return function(e){return i.apply(this,arguments)}}())])},r.destroy=function(){this._nextLightingUpdate&&(clearTimeout(this._nextLightingUpdate),this._nextLightingUpdate=null),this.view=null},r._timezoneFromCamera=function(e){var t;const i=null==(t=e.camera)?void 0:t.position;if(!i||!e.environment.lighting.cameraTrackingEnabled)return 0;const a=n.unwrap(u.positionToTimezoneInfo([i.longitude,i.latitude]));return Math.round(a.hours+a.minutes/60+a.seconds/3600)},r.stopPlaying=function(){this.playingState="none"},r.toggleDayPlaying=function(){this.dayPlaying=!this.dayPlaying},r.toggleYearPlaying=function(){this.yearPlaying=!this.yearPlaying},r.toggleDirectShadows=function(){this.stopPlaying(),this.directShadowsEnabled=!this.directShadowsEnabled},r._updateLighting=function(e){var t,i;const n=Date.now();this._lastLightingUpdate=n;const a=null==(t=this.view)||null==(i=t.environment)?void 0:i.lighting;if(!a)return;const s=e||a.date,o=a.displayUTCOffset,r=null!==o?o:this._timezoneFromCamera(this.view);this._cachedLightingDateUTC.getTime()!==s.getTime()&&(this._cachedLightingDateUTC=new Date(s.getTime())),this._cachedDisplayUTCOffset!==r&&(this._cachedDisplayUTCOffset=r)},r._timezoneWillChange=function(e){var t,i;const n=null==(t=this.view)||null==(i=t.environment)?void 0:i.lighting;if(!n||!n.cameraTrackingEnabled)return;let a;if(e)a=e.timezoneOffset;else{if(null!=n.displayUTCOffset)return;a=c.calculateTimezoneOffset(n.positionTimezoneInfo)}n.displayUTCOffset=a,this._scheduleUpdateLighting(null)},r._scheduleUpdateLighting=function(e){if(this._nextLightingUpdate)return;const t=Date.now()-this._lastLightingUpdate,i=this.lightingUpdateInterval-t;i<=0?a.schedule((()=>this._updateLighting(e))):this._nextLightingUpdate=setTimeout((()=>{this._updateLighting(null),this._nextLightingUpdate=null}),i)},r._play=function(){var e;const t=this.view;if(null!=(e=this.view)&&e.environment&&(this.dayPlaying||this.yearPlaying)){const e=(new Date).getTime()-this._lastTime;if(this.dayPlaying){this._lastTime=(new Date).getTime();const i=y.calculatePlaySpeed(this._sunrise,this._sunset,t.environment.lighting.date)*this.playSpeedMultiplier/100*e;if(i>0){let e=new Date(t.environment.lighting.date.getTime()+i);if(((e.getUTCHours()+t.environment.lighting.displayUTCOffset)%24+24)%24<((t.environment.lighting.date.getUTCHours()+t.environment.lighting.displayUTCOffset)%24+24)%24){const n=864e5;e=new Date(t.environment.lighting.date.getTime()+i-n)}t.environment.lighting.date=e}}else{if(e>1e3){this._lastTime=(new Date).getTime();const e=(t.environment.lighting.date.getUTCMonth()+1)%12,i=new Date(t.environment.lighting.date.getTime());i.setUTCMonth(e),t.environment.lighting.date=i}}requestAnimationFrame((()=>this._play()))}},r._updateSunriseAndSunset=function(){const e=f.getSunriseAndSunsetTimes(this.view.environment.lighting.date,this.view.camera.position.latitude,this.view.camera.position.longitude,this.view.environment.lighting.displayUTCOffset);this._sunrise=new Date(e.sunrise),this._sunset=new Date(e.sunset)},e._createClass(i,[{key:"isSupported",get:function(){return!this.view||"3d"===this.view.type}},{key:"utcOffset",get:function(){return this._cachedDisplayUTCOffset},set:function(e){e!==this.utcOffset&&(this.view.environment.lighting.displayUTCOffset=e,this._updateLighting(null))}},{key:"localDate",get:function(){return s.truncateLocalTime(this._lightingDateDisplay)},set:function(e){e.getTime()!==this.localDate.getTime()&&(this._lightingDateDisplay=s.resetUTCDate(this._lightingDateDisplay,e))}},{key:"timeSliderPosition",get:function(){return y.dateTimeToSliderPos(this._lightingDateDisplay)},set:function(e){Math.abs(e-this.timeSliderPosition)>1/60&&(this._lightingDateDisplay=y.sliderPosToDateTime(this._lightingDateDisplay,e),this.stopPlaying(),this._enableShadowsOnFirstInteraction&&(this.directShadowsEnabled=!0,this._enableShadowsOnFirstInteraction=!1))}},{key:"_lightingDateDisplay",get:function(){return s.offsetDate(this._cachedLightingDateUTC,this._cachedDisplayUTCOffset,"hours")},set:function(e){const t=s.offsetDate(e,-this._cachedDisplayUTCOffset,"hours");t.getTime()!==this.view.environment.lighting.date.getTime()&&(this.view.environment.lighting.date=t,this._updateLighting(null))}},{key:"playingState",set:function(e){this.playingState!==e&&(this._set("playingState",e),"none"!==e&&(this._updateSunriseAndSunset(),this._lastTime=(new Date).getTime(),this._play(),this._enableShadowsOnFirstInteraction&&(this.directShadowsEnabled=!0,this._enableShadowsOnFirstInteraction=!1)))}},{key:"dayPlaying",get:function(){return"day"===this.playingState},set:function(e){e?this.playingState="day":this.dayPlaying&&(this.playingState="none")}},{key:"yearPlaying",get:function(){return"year"===this.playingState},set:function(e){e?this.playingState="year":this.yearPlaying&&(this.playingState="none")}},{key:"currentSeason",get:function(){return y.getSeasonFromDate(this.localDate,this._currentHemisphere)},set:function(e){this.stopPlaying();const t=y.getNorthernHemisphereSeason(e,this._currentHemisphere);this.localDate=y.getSeasonDate(this.localDate,t,y.Hemisphere.NORTHERN)}},{key:"_currentHemisphere",get:function(){var e,t;const i=null==(e=this.view)||null==(t=e.camera)?void 0:t.position;return i?i.latitude>=0?y.Hemisphere.NORTHERN:y.Hemisphere.SOUTHERN:y.Hemisphere.NORTHERN}}]),i}(i.HandleOwner);t.__decorate([r.property({type:g})],w.prototype,"view",void 0),t.__decorate([r.property({type:m})],w.prototype,"datePickerViewModel",void 0),t.__decorate([r.property({type:_.SliderWithDropdownViewModel})],w.prototype,"timeSliderViewModel",void 0),t.__decorate([r.property()],w.prototype,"isSupported",null),t.__decorate([r.property()],w.prototype,"lightingUpdateInterval",void 0),t.__decorate([r.property()],w.prototype,"_cachedLightingDateUTC",void 0),t.__decorate([r.property()],w.prototype,"_cachedDisplayUTCOffset",void 0),t.__decorate([r.property()],w.prototype,"_enableShadowsOnFirstInteraction",void 0),t.__decorate([r.property()],w.prototype,"utcOffset",null),t.__decorate([r.property()],w.prototype,"localDate",null),t.__decorate([r.property()],w.prototype,"timeSliderPosition",null),t.__decorate([r.property()],w.prototype,"_lightingDateDisplay",null),t.__decorate([r.property({aliasOf:"view.environment.lighting.directShadowsEnabled"})],w.prototype,"directShadowsEnabled",void 0),t.__decorate([r.property({type:["none","day","year"],value:"none"})],w.prototype,"playingState",null),t.__decorate([r.property()],w.prototype,"dayPlaying",null),t.__decorate([r.property()],w.prototype,"yearPlaying",null),t.__decorate([r.property()],w.prototype,"playSpeedMultiplier",void 0),t.__decorate([r.property()],w.prototype,"currentSeason",null),t.__decorate([r.property()],w.prototype,"_lastTime",void 0),t.__decorate([r.property()],w.prototype,"_sunrise",void 0),t.__decorate([r.property()],w.prototype,"_sunset",void 0),t.__decorate([r.property({readOnly:!0})],w.prototype,"_currentHemisphere",null),w=t.__decorate([p.subclass("esri.widgets.Daylight.DaylightViewModel")],w);return w}));
