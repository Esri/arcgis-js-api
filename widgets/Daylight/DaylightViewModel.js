// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../core/HandleOwner","../../core/maybe","../../core/scheduling","../../core/watchUtils","../../core/accessorSupport/decorators","../../views/SceneView","../../views/3d/environment/SceneViewLighting","../../views/3d/support/earthUtils","./daylightUtils","./daylightUtils","./support/SliderWithDropdownViewModel","../support/DatePickerViewModel"],(function(e,t,i,n,o,a,r,l,s,p,d,h,g,u,c){"use strict";return function(e){function t(t){var i=e.call(this,t)||this;return i.view=null,i.datePickerViewModel=new c,i.timeSliderViewModel=new u.SliderWithDropdownViewModel,i.lightingUpdateInterval=200,i._cachedLightingDateUTC=new Date(0),i._cachedDisplayUTCOffset=0,i._enableShadowsOnFirstInteraction=!0,i._lastLightingUpdate=0,i._nextLightingUpdate=null,i.playSpeedMultiplier=1,i}return i.__extends(t,e),t.prototype.initialize=function(){var e=this;this.handles.add([r.init(this,"view",(function(){e.view&&e.view.when((function(){return e._updateLighting(null)}))})),r.watch(this,"view.environment.lighting.date",(function(t){return e._scheduleUpdateLighting(t)})),r.on(this,"view.environment.lighting","timezone-will-change",(function(t){return e._timezoneWillChange(t)}),(function(){return e._timezoneWillChange(null)})),r.init(this,"view.stationary",(function(){(e.dayPlaying||e.yearPlaying)&&e._updateSunriseAndSunset()})),this.watch(["timeSliderPosition","timeSliderViewModel.state"],(function(){"ready"===e.timeSliderViewModel.state&&e.timeSliderViewModel.setValue(0,e.timeSliderPosition)})),this.timeSliderViewModel.watch("currentItem",(function(t){return e.utcOffset=t.abbr})),this.timeSliderViewModel.watch("isDropdownOpen",(function(){return e.stopPlaying()})),this.timeSliderViewModel.watch("values",(function(t){return e.timeSliderPosition=t[0]})),this.datePickerViewModel.watch("value",(function(t){e.dayPlaying=!1,e.localDate=t})),this.watch("localDate",(function(t){return i.__awaiter(e,void 0,void 0,(function(){return i.__generator(this,(function(e){return this.datePickerViewModel.value.valueOf()!==t.getTime()&&this.datePickerViewModel.set("value",t),[2]}))}))}))])},t.prototype.destroy=function(){this._nextLightingUpdate&&(clearTimeout(this._nextLightingUpdate),this._nextLightingUpdate=null),this.view=null},Object.defineProperty(t.prototype,"isSupported",{get:function(){return!this.view||"3d"===this.view.type},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"utcOffset",{get:function(){return this._cachedDisplayUTCOffset},set:function(e){e!==this.utcOffset&&(this.view.environment.lighting.displayUTCOffset=e,this._updateLighting(null))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"localDate",{get:function(){return h.dateTimeToLocalDate(this._lightingDateDisplay)},set:function(e){if(e.getTime()!==this.localDate.getTime()){var t=h.localDateToDateTime(this._lightingDateDisplay,e);this._lightingDateDisplay=t}},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"timeSliderPosition",{get:function(){return h.dateTimeToSliderPos(this._lightingDateDisplay)},set:function(e){if(Math.abs(e-this.timeSliderPosition)>1/60){var t=h.sliderPosToDateTime(this._lightingDateDisplay,e);this._lightingDateDisplay=t,this.stopPlaying(),this._enableShadowsOnFirstInteraction&&(this.directShadowsEnabled=!0,this._enableShadowsOnFirstInteraction=!1)}},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"_lightingDateDisplay",{get:function(){return h.dateAddHours(this._cachedLightingDateUTC,this._cachedDisplayUTCOffset)},set:function(e){var t=h.dateAddHours(e,-this._cachedDisplayUTCOffset);t.getTime()!==this.view.environment.lighting.date.getTime()&&(this.view.environment.lighting.date=t,this._updateLighting(null))},enumerable:!1,configurable:!0}),t.prototype._timezoneFromCamera=function(e){var t=e.camera.position,i=d.positionToTimezone([t.longitude,t.latitude]);return o.isSome(i)?Math.round(i.hours+i.minutes/60+i.seconds/3600):0},Object.defineProperty(t.prototype,"playingState",{set:function(e){this.playingState!==e&&(this._set("playingState",e),"none"!==e&&(this._updateSunriseAndSunset(),this._lastTime=(new Date).getTime(),this._play(),this._enableShadowsOnFirstInteraction&&(this.directShadowsEnabled=!0,this._enableShadowsOnFirstInteraction=!1)))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"dayPlaying",{get:function(){return"day"===this.playingState},set:function(e){e?this.playingState="day":this.dayPlaying&&(this.playingState="none")},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"yearPlaying",{get:function(){return"year"===this.playingState},set:function(e){e?this.playingState="year":this.yearPlaying&&(this.playingState="none")},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"currentSeason",{get:function(){return h.getSeasonFromDate(this.localDate,this._currentHemisphere)},set:function(e){this.stopPlaying();var t=h.getNorthernHemisphereSeason(e,this._currentHemisphere);this.localDate=h.getSeasonDate(this.localDate,t,g.Hemisphere.NORTHERN)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"_currentHemisphere",{get:function(){var e,t,i=null===(t=null===(e=this.view)||void 0===e?void 0:e.camera)||void 0===t?void 0:t.position;return i?i.latitude>=0?g.Hemisphere.NORTHERN:g.Hemisphere.SOUTHERN:g.Hemisphere.NORTHERN},enumerable:!1,configurable:!0}),t.prototype.stopPlaying=function(){this.playingState="none"},t.prototype.toggleDayPlaying=function(){this.dayPlaying=!this.dayPlaying},t.prototype.toggleYearPlaying=function(){this.yearPlaying=!this.yearPlaying},t.prototype.toggleDirectShadows=function(){this.stopPlaying(),this.directShadowsEnabled=!this.directShadowsEnabled},t.prototype._updateLighting=function(e){var t,i,n=Date.now();this._lastLightingUpdate=n;var o=null===(i=null===(t=this.view)||void 0===t?void 0:t.environment)||void 0===i?void 0:i.lighting;if(o){var a=e||o.date,r=o.displayUTCOffset,l=null!==r?r:this._timezoneFromCamera(this.view);this._cachedLightingDateUTC.getTime()!==a.getTime()&&(this._cachedLightingDateUTC=new Date(a.getTime())),this._cachedDisplayUTCOffset!==l&&(this._cachedDisplayUTCOffset=l)}},t.prototype._timezoneWillChange=function(e){var t,i,n=null===(i=null===(t=this.view)||void 0===t?void 0:t.environment)||void 0===i?void 0:i.lighting;if(n){var o;if(e)o=e.timezoneOffset;else{if(null!=n.displayUTCOffset)return;o=p.calculateTimezoneOffset(n.positionTimezoneInfo)}n.displayUTCOffset=o,this._scheduleUpdateLighting(null)}},t.prototype._scheduleUpdateLighting=function(e){var t=this;if(!this._nextLightingUpdate){var i=Date.now()-this._lastLightingUpdate,n=this.lightingUpdateInterval-i;n<=0?a.schedule((function(){return t._updateLighting(e)})):this._nextLightingUpdate=setTimeout((function(){t._updateLighting(null),t._nextLightingUpdate=null}),n)}},t.prototype._play=function(){var e,t=this,i=this.view;if((null===(e=this.view)||void 0===e?void 0:e.environment)&&(this.dayPlaying||this.yearPlaying)){var n=(new Date).getTime()-this._lastTime;if(this.dayPlaying){this._lastTime=(new Date).getTime();var o=h.calculatePlaySpeed(this._sunrise,this._sunset,i.environment.lighting.date)*this.playSpeedMultiplier/100*n;if(o>0){var a=new Date(i.environment.lighting.date.getTime()+o);if(((a.getUTCHours()+i.environment.lighting.displayUTCOffset)%24+24)%24<((i.environment.lighting.date.getUTCHours()+i.environment.lighting.displayUTCOffset)%24+24)%24){a=new Date(i.environment.lighting.date.getTime()+o-864e5)}i.environment.lighting.date=a}}else{if(n>1e3){this._lastTime=(new Date).getTime();var r=(i.environment.lighting.date.getUTCMonth()+1)%12,l=new Date(i.environment.lighting.date.getTime());l.setUTCMonth(r),i.environment.lighting.date=l}}requestAnimationFrame((function(){return t._play()}))}},t.prototype._updateSunriseAndSunset=function(){var e=h.getSunriseAndSunsetTimes(this.view.environment.lighting.date,this.view.camera.position.latitude,this.view.camera.position.longitude,this.view.environment.lighting.displayUTCOffset);this._sunrise=new Date(e.sunrise),this._sunset=new Date(e.sunset)},i.__decorate([l.property({type:s})],t.prototype,"view",void 0),i.__decorate([l.property({type:c})],t.prototype,"datePickerViewModel",void 0),i.__decorate([l.property({type:u.SliderWithDropdownViewModel})],t.prototype,"timeSliderViewModel",void 0),i.__decorate([l.property({dependsOn:["view.type"]})],t.prototype,"isSupported",null),i.__decorate([l.property()],t.prototype,"lightingUpdateInterval",void 0),i.__decorate([l.property()],t.prototype,"_cachedLightingDateUTC",void 0),i.__decorate([l.property()],t.prototype,"_cachedDisplayUTCOffset",void 0),i.__decorate([l.property()],t.prototype,"_enableShadowsOnFirstInteraction",void 0),i.__decorate([l.property({dependsOn:["_cachedDisplayUTCOffset"]})],t.prototype,"utcOffset",null),i.__decorate([l.property({dependsOn:["_lightingDateDisplay"]})],t.prototype,"localDate",null),i.__decorate([l.property({dependsOn:["_lightingDateDisplay"]})],t.prototype,"timeSliderPosition",null),i.__decorate([l.property({dependsOn:["_cachedDisplayUTCOffset","_cachedLightingDateUTC"]})],t.prototype,"_lightingDateDisplay",null),i.__decorate([l.property({aliasOf:"view.environment.lighting.directShadowsEnabled"})],t.prototype,"directShadowsEnabled",void 0),i.__decorate([l.property({type:["none","day","year"],value:"none"})],t.prototype,"playingState",null),i.__decorate([l.property({dependsOn:["playingState"]})],t.prototype,"dayPlaying",null),i.__decorate([l.property({dependsOn:["playingState"]})],t.prototype,"yearPlaying",null),i.__decorate([l.property()],t.prototype,"playSpeedMultiplier",void 0),i.__decorate([l.property({dependsOn:["localDate","_currentHemisphere"]})],t.prototype,"currentSeason",null),i.__decorate([l.property()],t.prototype,"_lastTime",void 0),i.__decorate([l.property()],t.prototype,"_sunrise",void 0),i.__decorate([l.property()],t.prototype,"_sunset",void 0),i.__decorate([l.property({readOnly:!0,dependsOn:["view.camera.position.latitude"]})],t.prototype,"_currentHemisphere",null),t=i.__decorate([l.subclass("esri.widgets.Daylight.DaylightViewModel")],t)}(n.HandleOwner)}));