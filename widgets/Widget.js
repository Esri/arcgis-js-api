/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../intl","../core/domUtils","../core/Evented","../core/events","../core/Handles","../core/has","../core/lang","../core/Logger","../core/maybe","../core/Promise","../core/promiseUtils","../core/reactiveUtils","../core/uuid","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/cast","../core/accessorSupport/decorators/subclass","../core/accessorSupport/tracking","../core/accessorSupport/tracking/SimpleTrackingTarget","../libs/maquette-advanced-projector/projector","./support/componentsUtils","./support/jsxWidgetSupport","./support/symbols","./support/tests","./support/vnodeCache","./support/widgetUtils","../intl/locale","../intl/messages"],(function(e,t,r,o,n,i,s,c,a,d,l,p,u,h,_,y,g,f,v,m,b,T,k,w,C,I,S,E,N){"use strict";var R;const j="esri.widgets.Widget";let L=0;const P={widgetIcon:"esri-icon-checkbox-unchecked"};function A(e,t){for(const r in t)null!=e[r]&&("object"==typeof e[r]&&"object"==typeof t[r]?A(e[r],t?.[r]):e[r]=t[r]);return e}const H=b.createAdvancedProjector({postProcessProjectionOptions(e){const t=e.eventHandlerInterceptor,r=/capture$/i;e.eventHandlerInterceptor=(e,o,n,i)=>{const s=t?.(e,o,n,i),c=r.test(e);if(!((e=e.replace(r,"")).toLowerCase()in n)||c){const t=e[2].toLowerCase()+e.slice(3),r=e=>s?.call(n,e);n.addEventListener(t,r,c);const o=()=>n.removeEventListener(t,r,c),a=i.afterRemoved;i.afterRemoved=e=>{a?.(e),o()}}return s}},handleInterceptedEvent(e,t,r,o){const{eventPhase:n,type:i}=o,s=n===Event.CAPTURING_PHASE;let c=`on${i}${s?"capture":""}`;const a=t.properties;(a&&c in a||(c=`on${i[0].toUpperCase()}${i.slice(1)}${s?"Capture":""}`,a&&c in a))&&(I.clearVNodeCache(),e.scheduleRender(),a[c].call(a.bind||r,o))}});let z=!1,U=function(t,r){function n(r,o){var n;(n=t.call(this,r,o)||this)._attached=!1,n._internalHandles=new s,n._projector=H,n._readyForTrueRender=!1,n.iconClass=P.widgetIcon,n.key=e._assertThisInitialized(n),n._loadLocale=u.debounce(e._asyncToGenerator((function*(){if(n._messageBundleProps&&n._messageBundleProps.length){const t=yield u.eachAlways(n._messageBundleProps.map(function(){var t=e._asyncToGenerator((function*({bundlePath:e,propertyName:t}){let r=yield N.fetchMessageBundle(e);n.uiStrings&&Object.keys(n.uiStrings)&&(r=A(a.clone(r),n.uiStrings)),n[t]=r}));return function(e){return t.apply(this,arguments)}}()));for(const e of t)e.error&&d.getLogger(n.declaredClass).error("widget-intl:locale-error",n.declaredClass,e.error)}yield n.loadLocale()}))),T.commitAssetPath();const i="esri-widget-uid-"+_.generateUUID(),c=n.render.bind(e._assertThisInitialized(n));n._trackingTarget=new m.SimpleTrackingTarget((()=>n.scheduleRender()));const l=()=>{if(!n._readyForTrueRender||n.destroyed)return null;if(!n.visible)return{vnodeSelector:"div",properties:{key:i,class:"",styles:{display:"none"}},domNode:null,children:void 0,text:void 0};const t=c();let{properties:r}=t;r||(t.properties=r={});let{key:o,styles:s}=r;o||(r.key=i),s||(r.styles=s={}),s.display||(s.display="");let a=0;return t.children?.forEach((e=>{if(k.isWidgetConstructor(e.vnodeSelector))return;let{properties:t}=e;t||(e.properties=t={}),t.key||(t.key=`${n.id}--${a++}`)})),k.processWidgets(e._assertThisInitialized(n),t)};return n.render=()=>{if(z)return l();let t=I.getVNodeCache(e._assertThisInitialized(n))??null;if(t)return t;n._trackingTarget.clear(),z=!0;try{t=v.runTracked(n._trackingTarget,l)}catch(r){throw console.error(r),r}finally{z=!1}return t&&I.setVNodeCache(e._assertThisInitialized(n),t),t},n.addResolvingPromise(n._resourcesFetch=n.beforeFirstRender().then((()=>{n._readyForTrueRender=!0,n._postInitialize()}))),C.registerLoading(n._resourcesFetch),n}e._inheritsLoose(n,t);var c=n.prototype;return c.normalizeCtorArgs=function(e,t){const r={...e};return t&&(r.container=t),r},c.postInitialize=function(){},c.beforeFirstRender=function(){return Promise.all([this.loadDependencies(),this._loadLocale()]).then((()=>{})).catch(u.throwIfNotAbortError)},c.loadDependencies=function(){var t=e._asyncToGenerator((function*(){}));function r(){return t.apply(this,arguments)}return r}(),c.loadLocale=function(){var t=e._asyncToGenerator((function*(){}));function r(){return t.apply(this,arguments)}return r}(),c.destroy=function(){this.destroyed||(l.destroyMaybe(this._trackingTarget),l.destroyMaybe(this.viewModel),this._detach(this.container),this._set("container",null),this._internalHandles.destroy(),this._emitter.clear(),this.render=()=>null,this._projector=null,I.deleteVNodeCache(this))},c.castContainer=function(e){return o.byId(e)},c.render=function(){throw new Error("not implemented")},c.scheduleRender=function(){this.destroyed||(I.deleteVNodeCache(this),this._projector.scheduleRender())},c.classes=function(...e){return S.classes.apply(this,e)},c.renderNow=function(){I.deleteVNodeCache(this),this._projector.renderNow()},c._postInitialize=function(){var t=this;if(this.destroyed)return;this.scheduleRender(),this._delegatedEventNames?.length&&this._internalHandles.add(h.watch((()=>this.viewModel),((e,t)=>{t&&this._internalHandles.remove("delegated-events"),e&&i.isEventTarget(e)&&this._internalHandles.add(this._delegatedEventNames.map((t=>i.on(e,t,(e=>{this.emit(t,e)})))),"delegated-events")}),h.initial)),this.postInitialize();const r=function(){var r=e._asyncToGenerator((function*(){yield t._loadLocale().catch(u.throwIfNotAbortError),t.scheduleRender()}));return function(){return r.apply(this,arguments)}}();this._internalHandles.add([E.onLocaleChange(r),h.watch((()=>this.uiStrings),r),h.when((()=>this.container),(e=>{this.destroyed||this._attach(e)}),{initial:!0,once:!0})])},c._attach=function(e){e&&(this._projector.merge(e,this.render),this._attached=!0)},c._detach=function(e){this._attached&&(this._projector.detach(this.render),this._attached=!1),e?.parentNode?.removeChild(e)},e._createClass(n,[{key:"container",set:function(e){this._get("container")||this._set("container",e)}},{key:"domNode",get:function(){return this.container},set:function(e){this.container=e}},{key:"id",get:function(){return this._get("id")||this.get("container.id")||Date.now().toString(16)+"-widget-"+L++},set:function(e){e&&this._set("id",e)}},{key:"label",get:function(){return this.declaredClass.split(".").pop()},set:function(e){this._overrideIfSome("label",e)}},{key:"renderable",get:function(){return this._resourcesFetch}},{key:"visible",get:function(){return this._get("visible")},set:function(e){this._set("visible",e)}},{key:r,get:function(){return{projector:this._projector}}}]),n}(p.EsriPromiseMixin(n.EventedAccessor),(R=w.WIDGET_SYMBOL,w.WIDGET_TEST_DATA_SYMBOL));U[R]=!0,t.__decorate([y.property()],U.prototype,"_readyForTrueRender",void 0),t.__decorate([y.property({value:null})],U.prototype,"container",null),t.__decorate([g.cast("container")],U.prototype,"castContainer",null),t.__decorate([y.property()],U.prototype,"iconClass",void 0),t.__decorate([y.property()],U.prototype,"id",null),t.__decorate([y.property()],U.prototype,"label",null),t.__decorate([y.property()],U.prototype,"renderable",null),t.__decorate([y.property()],U.prototype,"uiStrings",void 0),t.__decorate([y.property()],U.prototype,"viewModel",void 0),t.__decorate([y.property({value:!0})],U.prototype,"visible",null),t.__decorate([y.property()],U.prototype,"key",void 0),t.__decorate([y.property()],U.prototype,"children",void 0),t.__decorate([y.property()],U.prototype,"afterCreate",void 0),t.__decorate([y.property()],U.prototype,"afterUpdate",void 0),t.__decorate([y.property()],U.prototype,"afterRemoved",void 0),U=t.__decorate([f.subclass(j)],U);return U}));
