// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../geometry","../../Graphic","../../intl","../../symbols","../../core/Handles","../../core/unitFormatUtils","../../core/unitUtils","../../core/watchUtils","../../core/accessorSupport/decorators","../../geometry/geometryEngine","../../geometry/projection","../../geometry/support/geodesicUtils","../../layers/GraphicsLayer","../../layers/GroupLayer","../../views/2d/draw/Draw","../../views/interactive/dragEventPipeline","../../views/interactive/GraphicManipulator","../../views/interactive/InteractiveToolBase"],(function(e,t,r,i,o,a,s,n,l,c,p,h,u,d,y,m,_,v,f,g,w){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createDistanceMeasurementLabel=t.isSupported=t.createDistanceMeasurementInfo2D=void 0;var L=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._drawActive=!1,t._handles=new n,t._polylineLayer=new m,t._manipulatorLayer=new m,t._groupLayer=new _({layers:[t._polylineLayer,t._manipulatorLayer],listMode:"hide",visible:!1}),t._vertices=[],t.deferCreation=!0,t.geodesicDistanceThreshold=1e5,t.measurement=null,t.measurementLabel=null,t}return r.__extends(t,e),t.prototype.initialize=function(){var e=this;a.loadMessageBundle("esri/core/t9n/Units").then((function(t){e.messages=t})),this._handles.add(a.onLocaleChange((function(){return r.__awaiter(e,void 0,void 0,(function(){var e;return r.__generator(this,(function(t){switch(t.label){case 0:return e=this,[4,a.loadMessageBundle("esri/core/t9n/Units")];case 1:return e.messages=t.sent(),[2]}}))}))})))},t.prototype.destroy=function(){this.detach(),this._draw&&(this._draw.destroy(),this._draw=null),this._handles&&(this._handles.destroy(),this._handles=null),this._polylineLayer&&(this._polylineLayer.destroy(),this._polylineLayer=null),this._manipulatorLayer&&(this._manipulatorLayer.destroy(),this._manipulatorLayer=null)},Object.defineProperty(t.prototype,"editable",{set:function(e){this._set("editable",e),e||this._draw.reset()},enumerable:!1,configurable:!0}),t.prototype.activate=function(){this._drawActive||0!==this._vertices.length||this._startSketch()},t.prototype.onAttach=function(){var e=this,t=this.view;this._draw=new v({view:t}),t.map.add(this._groupLayer),t.focus(),this._handles.add([p.init(this,["unit","geodesicDistanceThreshold","palette","messages"],(function(){e._vertices.length>0&&e._updatePolylines()})),p.init(this,"view.spatialReference",(function(e){S(e)&&!d.isLoaded()&&d.load()}))]),this.create()},t.prototype.onDetach=function(){var e=this.view.map;this._draw.view=null,this._draw.destroy(),this._draw=null,e.remove(this._groupLayer),this._handles.removeAll(),this._polylineLayer.removeAll(),this._manipulatorLayer.removeAll(),this._set("measurement",null),this._set("measurementLabel",null)},t.prototype.onShow=function(){this._groupLayer.visible=!0},t.prototype.onHide=function(){this._groupLayer.visible=!1},t.prototype.reset=function(){this._vertices=[],this._polylineLayer.removeAll(),this._set("measurement",null),this._set("measurementLabel",null),this._draw.reset(),this._drawActive=!1,this._updateSketch([])},t.prototype.onInputEvent=function(e){"pointer-move"===e.type&&this._updateCursor()},t.prototype._startSketch=function(){var e=this;this._drawActive=!0;var t=this._draw.create("polyline",{mode:"click"});t.on(["vertex-add","vertex-update","vertex-remove","cursor-update","undo","redo"],(function(t){return e._updateSketch(t.vertices)})),t.on("draw-complete",(function(){e._stopSketch()}))},t.prototype._stopSketch=function(){this.manipulators.forEach((function(e){e.manipulator.interactive=!0})),this._drawActive=!1,this.complete()},t.prototype._updateSketch=function(e){var t=this;if(!S(this.view.spatialReference)||d.isLoaded()){if(e.length<2)return this._vertices=[],this.manipulators.removeAll(),void this._polylineLayer.removeAll();this.create();for(var r=this.view.spatialReference;this._vertices.length>e.length;){var a=this._vertices.pop().manipulatorId;this.manipulators.remove(a)}for(var n=function(a){var n=e[a],c=n[0],p=n[1],h=function(e,t,r,i){var a=new s.SimpleMarkerSymbol({style:"circle",color:i.handleColor,size:i.handleWidth,outline:{type:"simple-line",width:0}}),n=new s.SimpleMarkerSymbol({style:"circle",color:i.handleColor,size:1.5*i.handleWidth,outline:{type:"simple-line",width:0}}),l=new o({geometry:e,symbol:a});return new g.GraphicManipulator({view:t,layer:r,graphic:l,focusedSymbol:n})}(new i.Point({x:c,y:p,spatialReference:r}),l.view,l._manipulatorLayer,l.palette),u=l.manipulators.add(h);f.createManipulatorDragEventPipeline(h,(function(e,r){r.next(f.screenToMap(t.view)).next(f.dragGraphic(e.graphic)).next((function(){var r=e.graphic.geometry;t._vertices[a].coord=[r.x,r.y],t._updatePolylines()}))})),l._vertices.push({manipulatorId:u,coord:[c,p]})},l=this,c=this._vertices.length;c<e.length;c++)n(c);var p=this._vertices.length-1,h=this._vertices[p],u=e[p],y=u[0],m=u[1];if(h.coord[0]!==y||h.coord[1]!==m){h.coord=[y,m];var _=new i.Point({x:y,y:m,spatialReference:r});this.manipulators.findById(h.manipulatorId).graphic.geometry=_}var v=this._drawActive?this._vertices[p].manipulatorId:null;this.manipulators.forEach((function(e){e.manipulator.interactive=null==v||e.id!==v})),this._updatePolylines()}},t.prototype._updateCursor=function(){this.cursor=this._drawActive?"crosshair":null},t.prototype._updatePolylines=function(){this._polylineLayer.removeAll();var e=b(this._vertices.map((function(e){return e.coord})),this.view.spatialReference,this.geodesicDistanceThreshold),t=e.measurement,r=e.drawing,i=e.original;this._set("measurement",t);var a=D(this.messages,t,this.unit);this._set("measurementLabel",a);var s=this.palette,n=s.pathPrimaryColor,l=s.pathSecondaryColor,c=s.pathWidth,p=[];p.push(new o({geometry:r,symbol:{type:"simple-line",cap:"butt",join:"round",color:n,width:c}})),p.push(new o({geometry:r,symbol:{type:"simple-line",style:"dash",cap:"butt",join:"round",color:l,width:c-2}})),p.push(new o({geometry:i.extent.center,symbol:{type:"text",color:[255,255,255,1],haloColor:[0,0,0,.5],haloSize:2,text:a,font:{size:14,family:"sans-serif"}}})),this._polylineLayer.addMany(p)},r.__decorate([h.property()],t.prototype,"cursor",void 0),r.__decorate([h.property({value:!0})],t.prototype,"editable",null),r.__decorate([h.property({type:Number})],t.prototype,"geodesicDistanceThreshold",void 0),r.__decorate([h.property({readOnly:!0})],t.prototype,"measurement",void 0),r.__decorate([h.property({readOnly:!0})],t.prototype,"measurementLabel",void 0),r.__decorate([h.property()],t.prototype,"messages",void 0),r.__decorate([h.property()],t.prototype,"palette",void 0),r.__decorate([h.property()],t.prototype,"unit",void 0),r.__decorate([h.property({constructOnly:!0})],t.prototype,"view",void 0),t=r.__decorate([h.subclass("esri.widgets.DistanceMeasurement2D.DistanceMeasurement2DTool")],t)}(w.InteractiveToolBase);function b(e,t,r){var o,a,s=new i.Polyline({paths:[e],spatialReference:t});if(t.isGeographic)if(y.isSupported(t))o=y.geodesicLengths([s],"meters")[0],a=y.geodesicDensify(s,1e5);else{var n=d.project(s,i.SpatialReference.WGS84),l=y.geodesicDensify(n,1e5);o=y.geodesicLengths([n],"meters")[0],a=d.project(l,t)}else if(t.isWebMercator)o=u.geodesicLength(s,"meters"),a=u.geodesicDensify(s,1e5,"meters");else{var c=u.planarLength(s,"meters");if(c>=r){n=d.project(s,i.SpatialReference.WGS84),l=y.geodesicDensify(n,1e5);o=y.geodesicLengths([n],"meters")[0],a=d.project(l,t)}else o=c,a=s}return{measurement:{geometry:a,length:o},original:s,drawing:a}}function S(e){if(!e)return!1;var t=e.isGeographic,r=e.isWebMercator,i=e.isWGS84;return t&&!i&&!y.isSupported(e)||!t&&!r}function D(e,t,r){if(!t||!e)return null;switch(r){case"metric":return l.formatMetricLength(e,t.length,"meters");case"imperial":return l.formatImperialLength(e,t.length,"meters");default:return l.formatDecimal(e,c.convertUnit(t.length,"meters",r),r)}}t.createDistanceMeasurementInfo2D=b,t.isSupported=function(e){return null!=e&&(!S(e)||d.isSupported())},t.createDistanceMeasurementLabel=D,t.default=L}));