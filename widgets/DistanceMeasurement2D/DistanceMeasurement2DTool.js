/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/has","../../core/Logger","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/subclass","../../core/urlUtils","../../core/uuid","../../portal/support/resourceExtension","../../geometry/SpatialReference","../../geometry/Point","../../geometry/Polyline","../../geometry","../../intl/locale","../../symbols/CIMSymbol","../../symbols/Font","../../intl/messages","../../intl","../../symbols/SimpleMarkerSymbol","../../symbols/TextSymbol","../../chunks/symbols","../../Graphic","../../core/Handles","../../core/watchUtils","../../core/unitUtils","../../geometry/projection","../../core/unitFormatUtils","../../geometry/support/geodesicUtils","../../geometry/geometryEngine","../../layers/GraphicsLayer","../../layers/GroupLayer","../../views/interactive/dragEventPipeline","../../views/interactive/InteractiveToolBase","../../views/draw/Draw","../../views/interactive/GraphicManipulator"],(function(e,t,i,r,s,o,n,a,l,c,h,p,d,u,y,m,_,v,g,f,w,L,b,S,M,D,C,I,k,A,x,G,P,R,T,E,j){"use strict";const B=1e5;let U=function(e){function i(){var t;return(t=e.apply(this,arguments)||this)._drawActive=!1,t._handles=new M,t._polylineLayer=new G,t._manipulatorLayer=new G,t._groupLayer=new P({layers:[t._polylineLayer,t._manipulatorLayer],listMode:"hide",visible:!1}),t._vertices=[],t.deferCreation=!0,t.geodesicDistanceThreshold=1e5,t.measurement=null,t.measurementLabel=null,t}t._inheritsLoose(i,e);var r=i.prototype;return r.initialize=function(){g.fetchMessageBundle("esri/core/t9n/Units").then((e=>{this.messages=e})),this._handles.add(m.onLocaleChange((async()=>{this.messages=await g.fetchMessageBundle("esri/core/t9n/Units")})))},r.destroy=function(){this.detach(),this._draw&&(this._draw.destroy(),this._draw=null),this._handles&&(this._handles.destroy(),this._handles=null),this._polylineLayer&&(this._polylineLayer.destroy(),this._polylineLayer=null),this._manipulatorLayer&&(this._manipulatorLayer.destroy(),this._manipulatorLayer=null)},r.activate=function(){this._drawActive||0!==this._vertices.length||this._startSketch()},r.onAttach=function(){const e=this.view;this._draw=new E({view:e}),e.map.add(this._groupLayer),e.focus(),this._handles.add([D.init(this,["unit","geodesicDistanceThreshold","palette","messages"],(()=>{this._vertices.length>0&&this._updatePolylines()})),D.init(this,"view.spatialReference",(e=>{O(e)&&!I.isLoaded()&&I.load()}))]),this.create()},r.onDetach=function(){const{map:e}=this.view;this._draw.view=null,this._draw.destroy(),this._draw=null,e.remove(this._groupLayer),this._handles.removeAll(),this._polylineLayer.removeAll(),this._manipulatorLayer.removeAll(),this._set("measurement",null),this._set("measurementLabel",null)},r.onShow=function(){this._groupLayer.visible=!0},r.onHide=function(){this._groupLayer.visible=!1},r.reset=function(){this._vertices=[],this._polylineLayer.removeAll(),this._set("measurement",null),this._set("measurementLabel",null),this._draw.reset(),this._drawActive=!1,this._updateSketch([])},r.onInputEvent=function(e){"pointer-move"===e.type&&this._updateCursor()},r._startSketch=function(){this._drawActive=!0;const e=this._draw.create("polyline",{mode:"click"});e.on(["vertex-add","vertex-update","vertex-remove","cursor-update","undo","redo"],(e=>this._updateSketch(e.vertices))),e.on("draw-complete",(()=>{this._stopSketch()}))},r._stopSketch=function(){this.manipulators.forEach((e=>{e.manipulator.interactive=!0})),this._drawActive=!1,this.complete()},r._updateSketch=function(e){if(O(this.view.spatialReference)&&!I.isLoaded())return;if(e.length<2)return this._vertices=[],this.manipulators.removeAll(),void this._polylineLayer.removeAll();this.create();const{spatialReference:t}=this.view;for(;this._vertices.length>e.length;){const{manipulatorId:e}=this._vertices.pop();this.manipulators.remove(e)}for(let i=this._vertices.length;i<e.length;i++){const[r,s]=e[i],o=W(new d({x:r,y:s,spatialReference:t}),this.view,this._manipulatorLayer,this.palette),n=this.manipulators.add(o);R.createManipulatorDragEventPipeline(o,((e,t)=>{t.next(R.screenToMap(this.view)).next(R.dragGraphic(e.graphic)).next((()=>{const t=e.graphic.geometry;this._vertices[i].coord=[t.x,t.y],this._updatePolylines()}))})),this._vertices.push({manipulatorId:n,coord:[r,s]})}const i=this._vertices.length-1,r=this._vertices[i],[s,o]=e[i];if(r.coord[0]!==s||r.coord[1]!==o){r.coord=[s,o];const e=new d({x:s,y:o,spatialReference:t});this.manipulators.findById(r.manipulatorId).graphic.geometry=e}const n=this._drawActive?this._vertices[i].manipulatorId:null;this.manipulators.forEach((e=>{e.manipulator.interactive=null==n||e.id!==n})),this._updatePolylines()},r._updateCursor=function(){this.cursor=this._drawActive?"crosshair":null},r._updatePolylines=function(){const e=this._vertices.map((e=>e.coord)),{measurement:t,drawing:i,original:r}=z(e,this.view.spatialReference,this.geodesicDistanceThreshold);this._set("measurement",t);const s=F(this.messages,t,this.unit);this._set("measurementLabel",s);const{pathPrimaryColor:o,pathSecondaryColor:n,pathWidth:a}=this.palette;this._polylineLayer.removeAll(),this._polylineLayer.addMany([new S({geometry:i,symbol:new _({data:{type:"CIMSymbolReference",symbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",effects:[{type:"CIMGeometricEffectDashes",dashTemplate:[14,12],lineDashEnding:"FullGap",controlPointEnding:"NoConstraint"}],enable:!0,capStyle:"Butt",joinStyle:"Round",width:a-1.5,color:n},{type:"CIMSolidStroke",enable:!0,capStyle:"Butt",joinStyle:"Round",width:a,color:o}]}}})}),new S({geometry:r.extent.center,symbol:new L({color:[255,255,255,1],haloColor:[0,0,0,.5],haloSize:2,font:new v({size:14,family:"sans-serif"}),text:s})})])},t._createClass(i,[{key:"editable",set:function(e){this._set("editable",e),e||this._draw.reset()}}]),i}(T.InteractiveToolBase);function W(e,t,i,r){const s=new w({style:"circle",color:r.handleColor,size:r.handleWidth,outline:{type:"simple-line",width:0}}),o=new w({style:"circle",color:r.handleColor,size:1.5*r.handleWidth,outline:{type:"simple-line",width:0}}),n=new S({geometry:e,symbol:s});return new j.GraphicManipulator({view:t,layer:i,graphic:n,focusedSymbol:o})}function z(e,t,i){const r=new u({paths:[e],spatialReference:t});let s,o;if(t.isGeographic)if(A.isSupported(t))s=A.geodesicLengths([r],"meters")[0],o=A.geodesicDensify(r,B);else{const e=I.project(r,p.WGS84),i=A.geodesicDensify(e,B);s=A.geodesicLengths([e],"meters")[0],o=I.project(i,t)}else if(t.isWebMercator)s=x.geodesicLength(r,"meters"),o=x.geodesicDensify(r,B,"meters");else{const e=x.planarLength(r,"meters");if(e>=i){const e=I.project(r,p.WGS84),i=A.geodesicDensify(e,B);s=A.geodesicLengths([e],"meters")[0],o=I.project(i,t)}else s=e,o=r}return{measurement:{geometry:o,length:s},original:r,drawing:o}}function O(e){if(!e)return!1;const{isGeographic:t,isWebMercator:i,isWGS84:r}=e;return t&&!r&&!A.isSupported(e)||!t&&!i}function F(e,t,i){if(!t||!e)return null;switch(i){case"metric":return k.formatMetricLength(e,t.length,"meters");case"imperial":return k.formatImperialLength(e,t.length,"meters");default:return k.formatDecimal(e,C.convertUnit(t.length,"meters",i),i)}}i.__decorate([n.property()],U.prototype,"cursor",void 0),i.__decorate([n.property({value:!0})],U.prototype,"editable",null),i.__decorate([n.property({type:Number})],U.prototype,"geodesicDistanceThreshold",void 0),i.__decorate([n.property({readOnly:!0})],U.prototype,"measurement",void 0),i.__decorate([n.property({readOnly:!0})],U.prototype,"measurementLabel",void 0),i.__decorate([n.property()],U.prototype,"messages",void 0),i.__decorate([n.property()],U.prototype,"palette",void 0),i.__decorate([n.property()],U.prototype,"unit",void 0),i.__decorate([n.property({constructOnly:!0})],U.prototype,"view",void 0),U=i.__decorate([a.subclass("esri.widgets.DistanceMeasurement2D.DistanceMeasurement2DTool")],U);var H=U;e.createDistanceMeasurementInfo2D=z,e.createDistanceMeasurementLabel=F,e.default=H,e.isSupported=function(e){return null!=e&&(!O(e)||I.isSupported())},Object.defineProperty(e,"__esModule",{value:!0})}));
