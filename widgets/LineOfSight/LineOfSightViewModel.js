/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../analysis/LineOfSight","../../analysis/LineOfSightTarget","../../core/Collection","../../core/collectionUtils","../../core/Handles","../../core/handleUtils","../../core/Logger","../../core/maybe","../../core/reactiveUtils","../../core/watchUtils","../../core/accessorSupport/decorators/property","../../core/arrayUtils","../../core/has","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass","../../views/3d/interactive/analysisTools/lineOfSight/LineOfSightTool","./LineOfSightTarget","../support/InteractiveToolViewModel"],(function(e,t,o,s,n,i,r,a,l,c,d,h,g,y,u,p,T,v,f,w){"use strict";const _=l.getLogger("esri.widgets.LineOfSight.LineOfSightViewModel"),m=n.ofType(f);let M=function(t){function n(e){var s;return(s=t.call(this,e)||this).logger=_,s.supportedViewType="3d",s.unsupportedErrorMessage="LineOfSightViewModel is only supported in 3D views.",s.handles=new r,s._vmTargetsToConnection=new Map,s._analysisTargetsToConnection=new Map,s.ready=!1,s.analysis=new o,s.analysisView=null,s.observer=null,s}e._inheritsLoose(n,t);var l=n.prototype;return l.initialize=function(){this.handles.add([this.targets.on("after-add",(e=>this._onViewModelTargetAdded(e.item))),this.targets.on("after-remove",(e=>this._onViewModelTargetRemoved(e.item))),this.analysis.targets.on("after-add",(e=>this._onAnalysisTargetAdded(e.item))),this.analysis.targets.on("after-remove",(e=>this._onAnalysisTargetRemoved(e.item)))])},l.destroy=function(){this._analysisTargetsToConnection.forEach((e=>e.remove())),this.handles=c.destroyMaybe(this.handles)},l.start=function(){var t=e._asyncToGenerator((function*(){return this.ready||(yield h.whenTrueOnce(this,"ready")),this.createTool()}));function o(){return t.apply(this,arguments)}return o}(),l.clear=function(){this.removeTool(),this.observer=null,this.targets.removeAll()},l.continue=function(){c.isSome(this.tool)&&this.tool.continue()},l.stop=function(){c.isSome(this.tool)&&this.tool.stop()},l.createToolParams=function(){return{toolConstructor:v.LineOfSightTool,constructorArguments:()=>({analysis:this.analysis})}},l.onConnectToAnalysisView=function(){var t=e._asyncToGenerator((function*(e){this.analysisView=e,this.ready=!0,this.handles.add([this.analysisView.on("result-changed",(e=>{const t=this._analysisTargetsToConnection.get(e.target);c.isSome(e.result)?(t.viewModelTarget.intersectedGraphic=e.result.intersectedGraphic,t.viewModelTarget.intersectedLocation=c.unwrap(e.result.intersectedLocation),t.viewModelTarget.visible=e.result.visible):(t.viewModelTarget.intersectedGraphic=null,t.viewModelTarget.intersectedLocation=null,t.viewModelTarget.visible=void 0)}))],"view")}));function o(e){return t.apply(this,arguments)}return o}(),l.onDisconnectFromAnalysisView=function(){this.ready=!1,null!=this.handles&&this.handles.remove("view"),this.analysisView=null},l._onViewModelTargetAdded=function(e){if(this._vmTargetsToConnection.get(e))return;const t=new s({location:e.location});this._connectViewModelWithAnalysisTarget(e,t),this.analysis.targets.add(t)},l._onViewModelTargetRemoved=function(e){const t=this._vmTargetsToConnection.get(e);t&&(t.remove(),this.analysis.targets.remove(t.analysisTarget))},l._onAnalysisTargetAdded=function(e){if(this._analysisTargetsToConnection.get(e))return;const t=new f({location:c.applySome(e.location,(e=>e.clone()))});this._connectViewModelWithAnalysisTarget(t,e),this.targets.add(t)},l._onAnalysisTargetRemoved=function(e){const t=this._analysisTargetsToConnection.get(e);t&&(t.remove(),this.targets.remove(t.viewModelTarget))},l._connectViewModelWithAnalysisTarget=function(e,t){let o=!1;const s=a.handlesGroup([d.react((()=>t.location),(t=>{o||(o=!0,e.location=c.applySome(t,(e=>e.clone())),o=!1)}),{sync:!0}),d.react((()=>e.location),(e=>{o||(o=!0,t.location=c.applySome(e,(e=>e.clone())),o=!1)}),{sync:!0})]),n={analysisTarget:t,viewModelTarget:e,remove:()=>{s.remove(),this._vmTargetsToConnection.delete(e),this._analysisTargetsToConnection.delete(t)}};this._vmTargetsToConnection.set(e,n),this._analysisTargetsToConnection.set(t,n)},e._createClass(n,[{key:"state",get:function(){return this.disabled||!this.ready?"disabled":c.isNone(this.tool)||"pending"===this.tool.toolState?"ready":this.tool.state}},{key:"targets",get:function(){return this._get("targets")||new m},set:function(e){this._set("targets",i.referenceSetter(e,this.targets,m))}},{key:"testInfo",get:function(){return{getAnalysisTargetFromViewModelTarget:e=>c.applySome(this._vmTargetsToConnection.get(e),(e=>e.analysisTarget))}}}]),n}(w.InteractiveToolViewModel);t.__decorate([g.property({readOnly:!0})],M.prototype,"state",null),t.__decorate([g.property()],M.prototype,"ready",void 0),t.__decorate([g.property()],M.prototype,"analysis",void 0),t.__decorate([g.property()],M.prototype,"analysisView",void 0),t.__decorate([g.property({aliasOf:"analysis.observer"})],M.prototype,"observer",void 0),t.__decorate([g.property({type:m,cast:i.castForReferenceSetter,nonNullable:!0})],M.prototype,"targets",null),M=t.__decorate([T.subclass("esri.widgets.lineOfSight.LineOfSightViewModel")],M);return M}));
