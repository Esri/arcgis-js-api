/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/Collection","../../core/collectionUtils","../../core/Handles","../../core/handleUtils","../../core/Logger","../../core/maybe","../../core/reactiveUtils","../../core/watchUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass","../../layers/LineOfSightLayer","../../layers/LineOfSightTarget","../../views/3d/interactive/analysisTools/lineOfSight/LineOfSightTool","./LineOfSightTarget","../support/InteractiveToolViewModel"],(function(e,t,o,r,i,n,s,a,l,c,d,h,g,y,u,p,T,v,w){"use strict";const m=s.getLogger("esri.widgets.LineOfSight.LineOfSightViewModel"),f=o.ofType(v);let _=function(t){function o(e){var o;return(o=t.call(this,e)||this).logger=m,o.supportedViewType="3d",o.unsupportedErrorMessage="LineOfSightViewModel is only supported in 3D views.",o.handles=new i,o._vmTargetsToConnection=new Map,o._layerTargetsToConnection=new Map,o.ready=!1,o.model=new u({listMode:"hide"}),o.layerView=null,o.observer=null,o}e._inheritsLoose(o,t);var s=o.prototype;return s.initialize=function(){this.handles.add([this.targets.on("after-add",(e=>this._onViewModelTargetAdded(e.item))),this.targets.on("after-remove",(e=>this._onViewModelTargetRemoved(e.item))),this.model.targets.on("after-add",(e=>this._onLayerTargetAdded(e.item))),this.model.targets.on("after-remove",(e=>this._onLayerTargetRemoved(e.item))),l.react((()=>({view:this.view,ready:a.isSome(this.view)&&this.view.ready})),(({view:e})=>{this._disconnectFromView(),this._connectToView(e)}),{sync:!0})]),this._connectToView(this.view)},s.destroy=function(){this._disconnectFromView(),this._layerTargetsToConnection.forEach((e=>e.remove())),this.model=a.destroyMaybe(this.model),this.handles=a.destroyMaybe(this.handles)},s.start=function(){var t=e._asyncToGenerator((function*(){return this.ready||(yield c.whenTrueOnce(this,"ready")),this.createTool()}));function o(){return t.apply(this,arguments)}return o}(),s.clear=function(){this.removeTool(),this.observer=null,this.targets.removeAll()},s.continue=function(){a.isSome(this.tool)&&this.tool.continue()},s.stop=function(){a.isSome(this.tool)&&this.tool.stop()},s.createToolParams=function(){return{toolConstructor:T.LineOfSightTool,constructorArguments:()=>({model:this.model})}},s._connectToView=function(){var t=e._asyncToGenerator((function*(e){if(!a.isNone(e)&&e.ready&&(e.map.layers.add(this.model),"3d"===e.type)){const t=e,o=yield t.whenLayerView(this.model);if(this.destroyed||t!==this.view)return;this.layerView=o,this.ready=!0,this.handles.add([this.layerView.on("result-changed",(e=>{const t=this._layerTargetsToConnection.get(e.target);a.isSome(e.result)?(t.viewModelTarget.intersectedGraphic=e.result.intersectedGraphic,t.viewModelTarget.intersectedLocation=a.unwrap(e.result.intersectedLocation),t.viewModelTarget.visible=e.result.visible):(t.viewModelTarget.intersectedGraphic=null,t.viewModelTarget.intersectedLocation=null,t.viewModelTarget.visible=void 0)}))],"view")}}));function o(e){return t.apply(this,arguments)}return o}(),s._disconnectFromView=function(){this.ready=!1,null!=this.view&&(this.view.map.remove(this.model),this.handles.remove("view"),this.layerView=null)},s._onViewModelTargetAdded=function(e){if(this._vmTargetsToConnection.get(e))return;const t=new p.LineOfSightTarget({location:e.location});this._connectViewModelWithLayerTarget(e,t),this.model.targets.add(t)},s._onViewModelTargetRemoved=function(e){const t=this._vmTargetsToConnection.get(e);t&&(t.remove(),this.model.targets.remove(t.layerTarget))},s._onLayerTargetAdded=function(e){if(this._layerTargetsToConnection.get(e))return;const t=new v({location:a.applySome(e.location,(e=>e.clone()))});this._connectViewModelWithLayerTarget(t,e),this.targets.add(t)},s._onLayerTargetRemoved=function(e){const t=this._layerTargetsToConnection.get(e);t&&(t.remove(),this.targets.remove(t.viewModelTarget))},s._connectViewModelWithLayerTarget=function(e,t){let o=!1;const r=n.handlesGroup([l.react((()=>t.location),(t=>{o||(o=!0,e.location=a.applySome(t,(e=>e.clone())),o=!1)}),{sync:!0}),l.react((()=>e.location),(e=>{o||(o=!0,t.location=a.applySome(e,(e=>e.clone())),o=!1)}),{sync:!0})]),i={layerTarget:t,viewModelTarget:e,remove:()=>{r.remove(),this._vmTargetsToConnection.delete(e),this._layerTargetsToConnection.delete(t)}};this._vmTargetsToConnection.set(e,i),this._layerTargetsToConnection.set(t,i)},e._createClass(o,[{key:"state",get:function(){return this.disabled||!this.ready?"disabled":a.isNone(this.tool)||"pending"===this.tool.toolState?"ready":this.tool.state}},{key:"targets",get:function(){return this._get("targets")||new f},set:function(e){this._set("targets",r.referenceSetter(e,this.targets,f))}},{key:"testInfo",get:function(){return{getLayerTargetFromViewModelTarget:e=>a.applySome(this._vmTargetsToConnection.get(e),(e=>e.layerTarget))}}}]),o}(w.InteractiveToolViewModel);return t.__decorate([d.property({readOnly:!0})],_.prototype,"state",null),t.__decorate([d.property()],_.prototype,"ready",void 0),t.__decorate([d.property()],_.prototype,"model",void 0),t.__decorate([d.property()],_.prototype,"layerView",void 0),t.__decorate([d.property({aliasOf:"model.observer"})],_.prototype,"observer",void 0),t.__decorate([d.property({type:f,cast:r.castForReferenceSetter,nonNullable:!0})],_.prototype,"targets",null),_=t.__decorate([y.subclass("esri.widgets.lineOfSight.LineOfSightViewModel")],_),_}));
