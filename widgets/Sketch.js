/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["require","../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../intl","../core/Collection","../core/handleUtils","../core/maybe","../core/accessorSupport/decorators/aliasOf","../core/arrayUtils","../core/has","../core/accessorSupport/decorators/cast","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/subclass","../views/interactive/snapping/SnappingOptions","./Widget","./Sketch/SketchViewModel","./support/SelectionToolbar","./support/SnappingControls","./support/widgetUtils","./support/decorators/messageBundle","../core/Logger","./support/decorators/vmEvent","./support/jsxFactory","../intl/substitute"],(function(e,t,o,n,i,s,l,a,r,c,u,d,p,h,v,_,g,f,y,w,b,m,C,M){"use strict";const T={base:"esri-sketch",verticalLayout:"esri-sketch--vertical",panel:"esri-sketch__panel",infoPanel:"esri-sketch__info-panel",section:"esri-sketch__section",toolSection:"esri-sketch__tool-section",infoSection:"esri-sketch__info-section",infoCountSection:"esri-sketch__info-count-section",menuContainer:"esri-sketch__menu-container",menuHeader:"esri-sketch__menu-header",menuTitle:"esri-sketch__menu-title",featureCountBadge:"esri-sketch__feature-count-badge",featureCountText:"esri-sketch__feature-count-text",featureCountNumber:"esri-sketch__feature-count-number",actionToggle:"esri-sketch__action-toggle",actionToggleOn:"esri-sketch__action-toggle--on",actionTitle:"esri-sketch__item-action-title",actionIcon:"esri-sketch__item-action-icon",disabled:"esri-disabled",esriWidget:"esri-widget",rotating:"esri-rotating",widgetIcon:"esri-icon-edit"},k={createTools:{point:!0,polyline:!0,polygon:!0,rectangle:!0,circle:!0},selectionTools:{"rectangle-selection":!0,"lasso-selection":!0},undoRedoMenu:!0,settingsMenu:!0,snappingControls:!0,snappingControlsElements:{header:!1,enabledToggle:!0,selfEnabledToggle:!0,featureEnabledToggle:!0,layerList:!0}};let x=function(o){function n(e,n){var s;return(s=o.call(this,e,n)||this)._activeCreateOptions=null,s._defaultViewModel=null,s._menuOpen=!1,s._selectionToolbar=null,s._selectionHandlesGroup=null,s._snappingControls=null,s._viewModelHandlesGroup=null,s.availableCreateTools=["point","polyline","polygon","rectangle","circle"],s.createGraphic=null,s.creationMode="continuous",s.defaultCreateOptions=null,s.defaultUpdateOptions=null,s.iconClass=T.widgetIcon,s.label=void 0,s.layer=null,s.layout="horizontal",s.messages=null,s.snappingOptions=new h,s.updateGraphics=new i,s.view=null,s.visibleElements={...k},s._activateCreateTool=s._activateCreateTool.bind(t._assertThisInitialized(s)),null!=e&&e.viewModel||(s._defaultViewModel=new _,s.viewModel=s._defaultViewModel),s}t._inheritsLoose(n,o);var a=n.prototype;return a.initialize=function(){const{layer:e,view:t}=this,o=new g({view:"2d"===(null==t?void 0:t.type)?t:null,layers:e?[e]:null});this._selectionHandlesGroup=s.handlesGroup([o.watch("activeToolInfo",(e=>{e&&this.viewModel.cancel()})),o.on("complete",(e=>this._onSelectionOperationComplete(e)))]),this._selectionToolbar=o,this._setUpSnappingControls()},a.loadDependencies=function(){return Promise.all([new Promise(((t,o)=>e(["../chunks/calcite-action"],t,o))),new Promise(((t,o)=>e(["../chunks/calcite-icon"],t,o)))])},a.destroy=function(){this._selectionToolbar.destroy(),this._cleanupViewModel(),this._selectionHandlesGroup=l.removeMaybe(this._selectionHandlesGroup),this._snappingControls=l.destroyMaybe(this._snappingControls)},a.castVisibleElements=function(e){const t={...k,...e,createTools:{...k.createTools,...null==e?void 0:e.createTools},selectionTools:{...k.selectionTools,...null==e?void 0:e.selectionTools},snappingControlsElements:{...k.snappingControlsElements,...null==e?void 0:e.snappingControlsElements}};return l.isSome(this._snappingControls)&&(this._snappingControls.visibleElements=t.snappingControlsElements),t},a.create=function(e,t){this._activeCreateOptions=t||null,this.viewModel.create(e,t)},a.update=function(e,t){return this.viewModel.update(e,t)},a.complete=function(){},a.cancel=function(){this._selectionToolbar.cancel(),this.viewModel.cancel()},a.undo=function(){var e;this.viewModel.undo(),null==(e=this.view)||e.focus()},a.redo=function(){var e;this.viewModel.redo(),null==(e=this.view)||e.focus()},a.delete=function(){},a.render=function(){const{label:e,layout:t,viewModel:{state:o}}=this;return C.tsx("div",{"aria-label":e,class:this.classes(T.base,T.esriWidget,{[T.disabled]:"disabled"===o,[T.verticalLayout]:"vertical"===t})},C.tsx("div",{role:"toolbar",class:T.panel},this.renderTopPanelContents()),C.tsx("div",{class:this.classes(T.panel,T.infoPanel)},this.renderInfoPanelContents()))},a.renderTopPanelContents=function(){const e=this.classes(T.section,T.toolSection),{availableCreateTools:t,visibleElements:o}=this;return[C.tsx("div",{role:"menu",key:"selection-button-container",class:e},this.renderDefaultSelectionButton(),this.renderSelectionToolbar()),t&&t.length?C.tsx("div",{role:"menu",class:e},this.renderDrawButtons()):null,o.undoRedoMenu?C.tsx("div",{role:"menu",key:"undo-redo-menu-button-container",class:e},this.renderUndoRedoMenuButtons()):null,o.settingsMenu?C.tsx("div",{key:"settings-menu-button-container",class:T.section},this.renderSettingsMenuButton()):null]},a.renderInfoPanelContents=function(){return this._menuOpen?this.renderSettingsMenu():this.updateGraphics.length?[C.tsx("div",{class:this.classes(T.section,T.infoSection,T.infoCountSection),key:"feature-count-container"},this.renderFeatureCount()),C.tsx("div",{class:this.classes(T.section,T.infoSection),key:"delete-button-container"},this.renderDeleteButton())]:void 0},a.renderSettingsMenu=function(){const{settings:e}=this.messages;return[C.tsx("div",{role:"menu",class:T.menuContainer,key:"settings-menu-container"},C.tsx("header",{class:T.menuHeader,key:"settings-menu-header"},C.tsx("span",{class:T.menuTitle},e)),this.renderSnappingControls())]},a.renderSnappingControls=function(){const{snappingControls:e}=this.visibleElements;if(l.isSome(this._snappingControls)&&e)return this._snappingControls.render()},a.renderFeatureCount=function(){const{layout:e,messages:t,updateGraphics:{length:o}}=this,n=M.substitute(1===o?t.featureCount:t.featuresCount,{count:o});return C.tsx("div",{class:T.featureCountBadge,"aria-label":n},C.tsx("span",{class:T.featureCountNumber},"vertical"===e?o:n))},a.renderDeleteButton=function(){const e=this.messages.deleteFeature;return C.tsx("calcite-action",{bind:this,label:e,onclick:this.delete,scale:"s",text:e,title:e},C.tsx("calcite-icon",{scale:"s",icon:"trash"}))},a.renderDefaultSelectionButton=function(){if(!this.viewModel.updateOnGraphicClick)return;const e=this.messages.selectFeature;return C.tsx("calcite-action",{active:"ready"===this.state,bind:this,label:e,onclick:this._activateDefaultSelectTool,scale:"s",text:e,title:e},C.tsx("calcite-icon",{scale:"s",icon:"cursor"}))},a.renderSelectionToolbar=function(){var e;if("2d"!==(null==(e=this.view)?void 0:e.type))return;const t=this.visibleElements.selectionTools;return this._selectionToolbar.visibleElements={lassoTool:!!t["lasso-selection"],rectangleTool:!!t["rectangle-selection"]},this._selectionToolbar.render()},a.renderDrawButtons=function(){const e=this.visibleElements.createTools;return this.availableCreateTools.map((t=>"point"===t&&e.point?this.renderPointButton():"polyline"===t&&e.polyline?this.renderPolylineButton():"polygon"===t&&e.polygon?this.renderPolygonButton():"rectangle"===t&&e.rectangle?this.renderRectangleButton():"circle"===t&&e.circle?this.renderCircleButton():void 0))},a.renderPointButton=function(){const e="point",t=this.messages.drawPoint;return C.tsx("calcite-action",{active:this.activeTool===e,bind:this,label:t,onclick:()=>this._activateCreateTool(e),scale:"s",text:t,title:t},C.tsx("calcite-icon",{scale:"s",icon:"pin"}))},a.renderPolygonButton=function(){const e="polygon",t=this.messages.drawPolygon;return C.tsx("calcite-action",{active:this.activeTool===e,bind:this,label:t,onclick:()=>this._activateCreateTool(e),scale:"s",text:t,title:t},C.tsx("calcite-icon",{scale:"s",icon:"polygon"}))},a.renderPolylineButton=function(){const e="polyline",t=this.messages.drawPolyline;return C.tsx("calcite-action",{active:this.activeTool===e,bind:this,label:t,onclick:()=>this._activateCreateTool(e),scale:"s",text:t,title:t},C.tsx("calcite-icon",{scale:"s",icon:"line"}))},a.renderCircleButton=function(){const e="circle",t=this.messages.drawCircle;return C.tsx("calcite-action",{active:this.activeTool===e,bind:this,label:t,onclick:()=>this._activateCreateTool(e),scale:"s",text:t,title:t},C.tsx("calcite-icon",{scale:"s",icon:"circle"}))},a.renderRectangleButton=function(){const e="rectangle",t=this.messages.drawRectangle;return C.tsx("calcite-action",{active:this.activeTool===e,bind:this,label:t,onclick:()=>this._activateCreateTool(e),scale:"s",text:t,title:t},C.tsx("calcite-icon",{scale:"s",icon:"rectangle"}))},a.renderUndoRedoMenuButtons=function(){return[this.renderUndoButton(),this.renderRedoButton()]},a.renderUndoButton=function(){const e=this.messages.undo;return C.tsx("calcite-action",{disabled:!this.viewModel.canUndo(),bind:this,label:e,onclick:this.undo,scale:"s",text:e,title:e},C.tsx("calcite-icon",{scale:"s",icon:y.isRTL(this.container)?"redo":"undo"}))},a.renderRedoButton=function(){const e=this.messages.redo;return C.tsx("calcite-action",{disabled:!this.viewModel.canRedo(),bind:this,label:e,onclick:this.redo,scale:"s",text:e,title:e},C.tsx("calcite-icon",{scale:"s",icon:y.isRTL(this.container)?"undo":"redo"}))},a.renderSettingsMenuButton=function(){const e=this.messages.settings;return C.tsx("calcite-action",{active:this._menuOpen,bind:this,label:e,onclick:this._toggleMenu,scale:"s",text:e,title:e},C.tsx("calcite-icon",{scale:"s",icon:"gear"}))},a._activateCreateTool=function(e){this.activeTool!==e?(this._selectionToolbar.cancel(),this.create(e)):this.cancel()},a._onCreateOperation=function(e){if("complete"!==e.state)return;const{creationMode:t}=this,{type:o}=e;if("create"===o){const{tool:o,graphic:n}=e,i=this._activeCreateOptions;this._activeCreateOptions=null,"continuous"===t?this.create(o,i):"update"===t&&this.update([n])}},a._toggleMenu=function(){this._menuOpen=!this._menuOpen,this.scheduleRender()},a._onSelectionOperationComplete=function(e){const{viewModel:{defaultUpdateOptions:t}}=this,{selection:o}=e;if(!e.aborted&&o.length){const e=t.tool,n=o.length>1&&"reshape"===e?"transform":e;this.update(o,{...t,tool:n})}this.notifyChange("state")},a._activateDefaultSelectTool=function(){var e;this.cancel(),null==(e=this.view)||e.focus()},a._cleanupViewModel=function(){this._defaultViewModel=l.destroyMaybe(this._defaultViewModel),this._viewModelHandlesGroup=l.removeMaybe(this._viewModelHandlesGroup)},a._setUpSnappingControls=function(){const{snappingOptions:e,view:t}=this;if(this._snappingControls=l.destroyMaybe(this._snappingControls),!e||!t)return;const o=new f({snappingOptions:e,view:t,visibleElements:this.visibleElements.snappingControlsElements});this._snappingControls=o},t._createClass(n,[{key:"activeTool",get:function(){const e=this._selectionToolbar.activeToolInfo;if(e)switch(e.toolName){case"lasso":return"lasso-selection";case"rectangle":return"rectangle-selection";case"default":return"custom-selection"}return this.viewModel.activeTool}},{key:"state",get:function(){return this._selectionToolbar.activeToolInfo?"active":this.viewModel.state}},{key:"viewModel",set:function(e){e!==this._get("viewModel")&&((l.isNone(this._defaultViewModel)||this._defaultViewModel!==e)&&this._cleanupViewModel(),this._set("viewModel",e),this.viewModel&&(this._viewModelHandlesGroup=s.handlesGroup([this.viewModel.on("create",(e=>{this.scheduleRender(),this._onCreateOperation(e)})),this.viewModel.on("update",(()=>this.scheduleRender())),this.viewModel.on("delete",(e=>this.emit("delete",e))),this.viewModel.on("undo",(()=>this.scheduleRender())),this.viewModel.on("redo",(()=>this.scheduleRender())),this.viewModel.watch("layer",(e=>{this._selectionToolbar.layers=e?[e]:null})),this.viewModel.watch("view",(e=>{this._selectionToolbar.view="2d"===(null==e?void 0:e.type)?e:null,this._setUpSnappingControls()})),this.viewModel.watch("state",(()=>this.notifyChange("state")))])))}}]),n}(v);o.__decorate([d.property()],x.prototype,"activeTool",null),o.__decorate([d.property({cast:e=>{if(!e||!e.length)return null;const t=new Set(["point","polyline","polygon","rectangle","circle"]);return e.filter((e=>t.has(e)))}})],x.prototype,"availableCreateTools",void 0),o.__decorate([a.aliasOf("viewModel.createGraphic")],x.prototype,"createGraphic",void 0),o.__decorate([d.property()],x.prototype,"creationMode",void 0),o.__decorate([a.aliasOf("viewModel.defaultCreateOptions")],x.prototype,"defaultCreateOptions",void 0),o.__decorate([a.aliasOf("viewModel.defaultUpdateOptions")],x.prototype,"defaultUpdateOptions",void 0),o.__decorate([d.property()],x.prototype,"iconClass",void 0),o.__decorate([d.property({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],x.prototype,"label",void 0),o.__decorate([a.aliasOf("viewModel.layer")],x.prototype,"layer",void 0),o.__decorate([d.property({type:["horizontal","vertical"]})],x.prototype,"layout",void 0),o.__decorate([d.property(),w.messageBundle("esri/widgets/Sketch/t9n/Sketch")],x.prototype,"messages",void 0),o.__decorate([a.aliasOf("viewModel.snappingOptions")],x.prototype,"snappingOptions",void 0),o.__decorate([d.property()],x.prototype,"state",null),o.__decorate([a.aliasOf("viewModel.updateGraphics")],x.prototype,"updateGraphics",void 0),o.__decorate([a.aliasOf("viewModel.view")],x.prototype,"view",void 0),o.__decorate([d.property(),m.vmEvent(["create","update","undo","redo"])],x.prototype,"viewModel",null),o.__decorate([d.property()],x.prototype,"visibleElements",void 0),o.__decorate([u.cast("visibleElements")],x.prototype,"castVisibleElements",null),o.__decorate([a.aliasOf("viewModel.complete")],x.prototype,"complete",null),o.__decorate([a.aliasOf("viewModel.delete")],x.prototype,"delete",null),x=o.__decorate([p.subclass("esri.widgets.Sketch")],x);return x}));
