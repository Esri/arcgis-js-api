/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/maybe","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/cast","../../../core/arrayUtils","../../../core/accessorSupport/decorators/subclass","../../../popup/FieldInfo","../../../popup/content/support/ChartMediaInfoValueSeries","../support/featureUtils","../support/relatedFeatureUtils"],(function(e,t,i,o,r,a,s,n,l,d,p,u){"use strict";const f={chartAnimation:!0};let c=function(t){function i(e){var i;return(i=t.call(this,e)||this).abilities={...f},i.activeMediaInfoIndex=0,i.attributes=null,i.description=null,i.fieldInfoMap=null,i.formattedAttributes=null,i.expressionAttributes=null,i.isAggregate=!1,i.layer=null,i.mediaInfos=null,i.popupTemplate=null,i.relatedInfos=null,i.title=null,i}e._inheritsLoose(i,t);var r=i.prototype;return r.castAbilities=function(e){return{...f,...e}},r.setActiveMedia=function(e){this._setContentElementMedia(e)},r.next=function(){this._pageContentElementMedia(1)},r.previous=function(){this._pageContentElementMedia(-1)},r._setContentElementMedia=function(e){const{formattedMediaInfoCount:t}=this,i=(e+t)%t;this.activeMediaInfoIndex=i},r._pageContentElementMedia=function(e){const{activeMediaInfoIndex:t}=this,i=t+e;this._setContentElementMedia(i)},r._formatMediaInfos=function(){const{mediaInfos:e,layer:t}=this,i=this.attributes??{},r=this.formattedAttributes??{},a=this.expressionAttributes??{},s=this.fieldInfoMap??new Map;return e?.map((e=>{const o=e?.clone();if(!o)return null;if(o.title=p.substituteFieldsInLinksAndAttributes({attributes:i,fieldInfoMap:s,globalAttributes:r,expressionAttributes:a,layer:t,text:o.title}),o.caption=p.substituteFieldsInLinksAndAttributes({attributes:i,fieldInfoMap:s,globalAttributes:r,expressionAttributes:a,layer:t,text:o.caption}),o.altText=p.substituteFieldsInLinksAndAttributes({attributes:i,fieldInfoMap:s,globalAttributes:r,expressionAttributes:a,layer:t,text:o.altText}),"image"===o.type){const{value:e}=o;return this._setImageValue({value:e,formattedAttributes:r,layer:t}),o.value.sourceURL?o:void 0}if("pie-chart"===o.type||"line-chart"===o.type||"column-chart"===o.type||"bar-chart"===o.type){const{value:e}=o;return this._setChartValue({value:e,chartType:o.type,attributes:i,formattedAttributes:r,layer:t,expressionAttributes:a}),o}return null})).filter(o.isSome)??[]},r._setImageValue=function(e){const t=this.fieldInfoMap??new Map,{value:i,formattedAttributes:o,layer:r}=e,{linkURL:a,sourceURL:s}=i;if(s){const e=p.fixTokens(s,r);i.sourceURL=p.substituteAttributes({formattedAttributes:o,template:e,fieldInfoMap:t})}if(a){const e=p.fixTokens(a,r);i.linkURL=p.substituteAttributes({formattedAttributes:o,template:e,fieldInfoMap:t})}},r._setChartValue=function(e){const{value:t,attributes:i,formattedAttributes:o,chartType:r,layer:a,expressionAttributes:s}=e,{popupTemplate:n,relatedInfos:l}=this,{fields:d,normalizeField:u}=t,f=a;t.fields=p.getFixedFieldNames(d,f),u&&(t.normalizeField=p.getFixedFieldName(u,f));if(!d.some((e=>!!(null!=o[e]||p.isRelatedField(e)&&l?.size))))return;const c=n?.fieldInfos??[];d.forEach((e=>{if(p.isRelatedField(e))return void(t.series=[...t.series,...this._getRelatedChartInfos({fieldInfos:c,fieldName:e,formattedAttributes:o,chartType:r,value:t})]);const a=this._getChartOption({value:t,attributes:i,chartType:r,formattedAttributes:o,expressionAttributes:s,fieldName:e,fieldInfos:c});t.series.push(a)}))},r._getRelatedChartInfos=function(e){const{fieldInfos:t,fieldName:i,formattedAttributes:o,chartType:r,value:a}=e,s=[],n=u.getRelatedFieldInfo(i),l=n&&this.relatedInfos?.get(n.layerId.toString());if(!l)return s;const{relatedFeatures:d,relation:p}=l;if(!p||!d)return s;const{cardinality:f}=p;d.forEach((e=>{const{attributes:l}=e;l&&Object.keys(l).forEach((e=>{e===n.fieldName&&s.push(this._getChartOption({value:a,attributes:l,formattedAttributes:o,fieldName:i,chartType:r,relatedFieldName:e,hasMultipleRelatedFeatures:d?.length>1,fieldInfos:t}))}))}));return"one-to-many"===f||"many-to-many"===f?s:[s[0]]},r._getTooltip=function({label:e,value:t,chartType:i}){return"pie-chart"===i?`${e}`:`${e}: ${t}`},r._getChartOption=function(e){const{value:t,attributes:i,formattedAttributes:o,expressionAttributes:r,fieldName:a,relatedFieldName:s,fieldInfos:n,chartType:f,hasMultipleRelatedFeatures:c}=e,y=this.layer,m=this.fieldInfoMap??new Map,{normalizeField:b,tooltipField:h}=t,I=b?p.isRelatedField(b)?i[u.getRelatedFieldInfo(b).fieldName]:i[b]:null,_=p.isExpressionField(a)&&r&&void 0!==r[a]?r[a]:s&&void 0!==i[s]?i[s]:void 0!==i[a]?i[a]:o[a],v=new d({fieldName:a,value:void 0===_?null:_&&I?_/I:_});if(p.isRelatedField(a)){const e=m.get(a.toLowerCase()),t=h&&m.get(h.toLowerCase()),r=e?.fieldName??a,n=c&&h?u.getRelatedFieldInfo(h).fieldName:t?.fieldName??h,l=c&&n?i[n]:o[n]??e?.label??e?.fieldName??s,d=c&&s?i[s]:o[r];return v.tooltip=this._getTooltip({label:l,value:d,chartType:f}),v}const g=p.getFieldInfo(n,a),A=p.getFixedFieldName(a,y),M=h&&void 0!==o[h]?o[h]:p.getFieldInfoLabel(g||new l({fieldName:A}),this.popupTemplate?.expressionInfos),F=o[A];return v.tooltip=this._getTooltip({label:M,value:F,chartType:f}),v},e._createClass(i,[{key:"activeMediaInfo",get:function(){return this.formattedMediaInfos[this.activeMediaInfoIndex]||null}},{key:"formattedMediaInfos",get:function(){return this._formatMediaInfos()||[]}},{key:"formattedMediaInfoCount",get:function(){return this.formattedMediaInfos.length}}]),i}(i);t.__decorate([r.property()],c.prototype,"abilities",void 0),t.__decorate([a.cast("abilities")],c.prototype,"castAbilities",null),t.__decorate([r.property()],c.prototype,"activeMediaInfoIndex",void 0),t.__decorate([r.property({readOnly:!0})],c.prototype,"activeMediaInfo",null),t.__decorate([r.property()],c.prototype,"attributes",void 0),t.__decorate([r.property()],c.prototype,"description",void 0),t.__decorate([r.property()],c.prototype,"fieldInfoMap",void 0),t.__decorate([r.property()],c.prototype,"formattedAttributes",void 0),t.__decorate([r.property()],c.prototype,"expressionAttributes",void 0),t.__decorate([r.property({readOnly:!0})],c.prototype,"formattedMediaInfos",null),t.__decorate([r.property()],c.prototype,"isAggregate",void 0),t.__decorate([r.property()],c.prototype,"layer",void 0),t.__decorate([r.property({readOnly:!0})],c.prototype,"formattedMediaInfoCount",null),t.__decorate([r.property()],c.prototype,"mediaInfos",void 0),t.__decorate([r.property()],c.prototype,"popupTemplate",void 0),t.__decorate([r.property()],c.prototype,"relatedInfos",void 0),t.__decorate([r.property()],c.prototype,"title",void 0),c=t.__decorate([n.subclass("esri.widgets.Feature.FeatureMedia.FeatureMediaViewModel")],c);return c}));
