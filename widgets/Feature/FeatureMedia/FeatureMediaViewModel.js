/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/accessorSupport/decorators/cast","../../../core/accessorSupport/decorators/subclass","../../../popup/FieldInfo","../../../popup/content/support/ChartMediaInfoValueSeries","../support/featureUtils","../support/relatedFeatureUtils"],(function(e,t,i,o,r,a,s,n,l,d,u){"use strict";const p={chartAnimation:!0};let f=function(t){function i(e){var i;return(i=t.call(this,e)||this).abilities={...p},i.activeMediaInfoIndex=0,i.attributes=null,i.description=null,i.fieldInfoMap=null,i.formattedAttributes=null,i.expressionAttributes=null,i.layer=null,i.mediaInfos=null,i.popupTemplate=null,i.relatedInfos=null,i.title=null,i}e._inheritsLoose(i,t);var o=i.prototype;return o.castAbilities=function(e){return{...p,...e}},o.setActiveMedia=function(e){this._setContentElementMedia(e)},o.next=function(){this._pageContentElementMedia(1)},o.previous=function(){this._pageContentElementMedia(-1)},o._setContentElementMedia=function(e){const{formattedMediaInfoCount:t}=this,i=(e+t)%t;this.activeMediaInfoIndex=i},o._pageContentElementMedia=function(e){const{activeMediaInfoIndex:t}=this,i=t+e;this._setContentElementMedia(i)},o._formatMediaInfos=function(){const{attributes:e,mediaInfos:t,formattedAttributes:i,expressionAttributes:o,fieldInfoMap:r,layer:a}=this;return t?.map((t=>{const s=t?.clone();if(!s)return null;if(s.title=d.substituteFieldsInLinksAndAttributes({attributes:e,fieldInfoMap:r,globalAttributes:i,expressionAttributes:o,layer:a,text:s.title}),s.caption=d.substituteFieldsInLinksAndAttributes({attributes:e,fieldInfoMap:r,globalAttributes:i,expressionAttributes:o,layer:a,text:s.caption}),s.altText=d.substituteFieldsInLinksAndAttributes({attributes:e,fieldInfoMap:r,globalAttributes:i,expressionAttributes:o,layer:a,text:s.altText}),"image"===s.type){const{value:e}=s;return this._setImageValue({value:e,formattedAttributes:i,layer:a}),s.value.sourceURL?s:void 0}if("pie-chart"===s.type||"line-chart"===s.type||"column-chart"===s.type||"bar-chart"===s.type){const{value:t}=s;return this._setChartValue({value:t,chartType:s.type,attributes:e,formattedAttributes:i,layer:a,expressionAttributes:o}),s}return null})).filter(Boolean)},o._setImageValue=function(e){const{fieldInfoMap:t}=this,{value:i,formattedAttributes:o,layer:r}=e,{linkURL:a,sourceURL:s}=i;if(s){const e=d.fixTokens(s,r);i.sourceURL=d.substituteAttributes({formattedAttributes:o,template:e,fieldInfoMap:t})}if(a){const e=d.fixTokens(a,r);i.linkURL=d.substituteAttributes({formattedAttributes:o,template:e,fieldInfoMap:t})}},o._setChartValue=function(e){const{value:t,attributes:i,formattedAttributes:o,chartType:r,layer:a,expressionAttributes:s}=e,{popupTemplate:n,relatedInfos:l}=this,{fields:u,normalizeField:p}=t;t.fields=d.getFixedFieldNames(u,a),p&&(t.normalizeField=d.getFixedFieldName(p,a));if(!u.some((e=>!!(null!=o[e]||d.isRelatedField(e)&&l.size))))return;const f=n?.fieldInfos;u.forEach((e=>{if(d.isRelatedField(e))return void(t.series=[...t.series,...this._getRelatedChartInfos({fieldInfos:f,fieldName:e,formattedAttributes:o,chartType:r,value:t})]);const a=this._getChartOption({value:t,attributes:i,chartType:r,formattedAttributes:o,expressionAttributes:s,fieldName:e,fieldInfos:f});t.series.push(a)}))},o._getRelatedChartInfos=function(e){const{fieldInfos:t,fieldName:i,formattedAttributes:o,chartType:r,value:a}=e,s=[],n=u.getRelatedFieldInfo(i),{layerId:l,fieldName:d}=n,p=this.relatedInfos?.get(l.toString());if(!p)return s;const{relatedFeatures:f,relation:c}=p;if(!c||!f)return s;const{cardinality:y}=c;f.forEach((e=>{const{attributes:n}=e;n&&Object.keys(n).forEach((e=>{e===d&&s.push(this._getChartOption({value:a,attributes:n,formattedAttributes:o,fieldName:i,chartType:r,relatedFieldName:e,fieldInfos:t}))}))}));return"one-to-many"===y||"many-to-many"===y?s:[s[0]]},o._getTooltip=function({label:e,value:t,chartType:i}){return"pie-chart"===i?`${e}`:`${e}: ${t}`},o._getChartOption=function(e){const{value:t,attributes:i,formattedAttributes:o,expressionAttributes:r,fieldName:a,relatedFieldName:s,fieldInfos:p,chartType:f}=e,{layer:c,fieldInfoMap:y}=this,{normalizeField:b,tooltipField:m}=t,h=b?d.isRelatedField(b)?i[u.getRelatedFieldInfo(b).fieldName]:i[b]:null,I=d.isExpressionField(a)&&r&&void 0!==r[a]?r[a]:s&&void 0!==i[s]?i[s]:void 0!==i[a]?i[a]:o[a],_=new l({fieldName:a,value:void 0===I?null:I&&h?I/h:I});if(d.isRelatedField(a)){const e=y.get(a.toLowerCase()),t=y.get(m.toLowerCase()),i=e?.fieldName??a,r=o[t?.fieldName??m]??e?.label??e?.fieldName??s,n=o[i];return _.tooltip=this._getTooltip({label:r,value:n,chartType:f}),_}const v=d.getFieldInfo(p,a),A=d.getFixedFieldName(a,c),M=m&&void 0!==o[m]?o[m]:d.getFieldInfoLabel(v||new n({fieldName:A}),this.popupTemplate?.expressionInfos),g=o[A];return _.tooltip=this._getTooltip({label:M,value:g,chartType:f}),_},e._createClass(i,[{key:"activeMediaInfo",get:function(){return this.formattedMediaInfos[this.activeMediaInfoIndex]||null}},{key:"formattedMediaInfos",get:function(){return this._formatMediaInfos()||[]}},{key:"formattedMediaInfoCount",get:function(){return this.formattedMediaInfos.length}}]),i}(i);t.__decorate([o.property()],f.prototype,"abilities",void 0),t.__decorate([a.cast("abilities")],f.prototype,"castAbilities",null),t.__decorate([o.property()],f.prototype,"activeMediaInfoIndex",void 0),t.__decorate([o.property({readOnly:!0})],f.prototype,"activeMediaInfo",null),t.__decorate([o.property()],f.prototype,"attributes",void 0),t.__decorate([o.property()],f.prototype,"description",void 0),t.__decorate([o.property()],f.prototype,"fieldInfoMap",void 0),t.__decorate([o.property()],f.prototype,"formattedAttributes",void 0),t.__decorate([o.property()],f.prototype,"expressionAttributes",void 0),t.__decorate([o.property({readOnly:!0})],f.prototype,"formattedMediaInfos",null),t.__decorate([o.property()],f.prototype,"layer",void 0),t.__decorate([o.property({readOnly:!0})],f.prototype,"formattedMediaInfoCount",null),t.__decorate([o.property()],f.prototype,"mediaInfos",void 0),t.__decorate([o.property()],f.prototype,"popupTemplate",void 0),t.__decorate([o.property()],f.prototype,"relatedInfos",void 0),t.__decorate([o.property()],f.prototype,"title",void 0),f=t.__decorate([s.subclass("esri.widgets.Feature.FeatureMedia.FeatureMediaViewModel")],f);return f}));
