/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/decorators/cast","../../../core/accessorSupport/decorators/subclass","../../../popup/FieldInfo","../../../popup/content/support/ChartMediaInfoValueSeries","../support/featureUtils","../support/relatedFeatureUtils"],(function(e,t,i,o,r,a,n,l,s,d,u,p){"use strict";const f={chartAnimation:!0};let c=function(t){function i(e){var i;return(i=t.call(this,e)||this).abilities={...f},i.activeMediaInfoIndex=0,i.attributes=null,i.description=null,i.fieldInfoMap=null,i.formattedAttributes=null,i.expressionAttributes=null,i.layer=null,i.mediaInfos=null,i.popupTemplate=null,i.relatedInfos=null,i.title=null,i}e._inheritsLoose(i,t);var o=i.prototype;return o.castAbilities=function(e){return{...f,...e}},o.setActiveMedia=function(e){this._setContentElementMedia(e)},o.next=function(){this._pageContentElementMedia(1)},o.previous=function(){this._pageContentElementMedia(-1)},o._setContentElementMedia=function(e){const{formattedMediaInfoCount:t}=this,i=(e+t)%t;this.activeMediaInfoIndex=i},o._pageContentElementMedia=function(e){const{activeMediaInfoIndex:t}=this,i=t+e;this._setContentElementMedia(i)},o._formatMediaInfos=function(){const{attributes:e,mediaInfos:t,formattedAttributes:i,expressionAttributes:o,fieldInfoMap:r,layer:a}=this;return null==t?void 0:t.map((t=>{const n=null==t?void 0:t.clone();if(!n)return null;if(n.title=u.substituteFieldsInLinksAndAttributes({attributes:e,fieldInfoMap:r,globalAttributes:i,expressionAttributes:o,layer:a,text:n.title}),n.caption=u.substituteFieldsInLinksAndAttributes({attributes:e,fieldInfoMap:r,globalAttributes:i,expressionAttributes:o,layer:a,text:n.caption}),n.altText=u.substituteFieldsInLinksAndAttributes({attributes:e,fieldInfoMap:r,globalAttributes:i,expressionAttributes:o,layer:a,text:n.altText}),"image"===n.type){const{value:e}=n;return this._setImageValue({value:e,formattedAttributes:i,layer:a}),n.value.sourceURL?n:void 0}if("pie-chart"===n.type||"line-chart"===n.type||"column-chart"===n.type||"bar-chart"===n.type){const{value:t}=n;return this._setChartValue({value:t,chartType:n.type,attributes:e,formattedAttributes:i,layer:a}),n}return null})).filter(Boolean)},o._setImageValue=function(e){const{fieldInfoMap:t}=this,{value:i,formattedAttributes:o,layer:r}=e,{linkURL:a,sourceURL:n}=i;if(n){const e=u.fixTokens(n,r);i.sourceURL=u.substituteAttributes({formattedAttributes:o,template:e,fieldInfoMap:t})}if(a){const e=u.fixTokens(a,r);i.linkURL=u.substituteAttributes({formattedAttributes:o,template:e,fieldInfoMap:t})}},o._setChartValue=function(e){const{value:t,attributes:i,formattedAttributes:o,chartType:r,layer:a}=e,{popupTemplate:n,relatedInfos:l}=this,{fields:s,normalizeField:d}=t;t.fields=u.getFixedFieldNames(s,a),d&&(t.normalizeField=u.getFixedFieldName(d,a));if(!s.some((e=>!!(null!=o[e]||u.isRelatedField(e)&&l.size))))return;const p=null==n?void 0:n.fieldInfos;s.forEach((e=>{if(u.isRelatedField(e))return void(t.series=[...t.series,...this._getRelatedChartInfos({fieldInfos:p,fieldName:e,formattedAttributes:o,chartType:r,value:t})]);const a=this._getChartOption({value:t,attributes:i,chartType:r,formattedAttributes:o,fieldName:e,fieldInfos:p});t.series.push(a)}))},o._getRelatedChartInfos=function(e){var t;const{fieldInfos:i,fieldName:o,formattedAttributes:r,chartType:a,value:n}=e,l=[],s=p.getRelatedFieldInfo(o),{layerId:d,fieldName:u}=s,f=null==(t=this.relatedInfos)?void 0:t.get(d.toString());if(!f)return l;const{relatedFeatures:c,relation:y}=f;if(!y||!c)return l;const{cardinality:m}=y;c.forEach((e=>{const{attributes:t}=e;t&&Object.keys(t).forEach((e=>{e===u&&l.push(this._getChartOption({value:n,attributes:t,formattedAttributes:r,fieldName:o,chartType:a,relatedFieldName:e,fieldInfos:i}))}))}));return"one-to-many"===m||"many-to-many"===m?l:[l[0]]},o._getTooltip=function({label:e,value:t,chartType:i}){return"pie-chart"===i?e:`${e}: ${t}`},o._getChartOption=function(e){var t;const{value:i,attributes:o,formattedAttributes:r,fieldName:a,relatedFieldName:n,fieldInfos:l,chartType:f}=e,{layer:c}=this,{normalizeField:y,tooltipField:m}=i,b=y?u.isRelatedField(y)?o[p.getRelatedFieldInfo(y).fieldName]:o[y]:null,I=n&&void 0!==o[n]?o[n]:void 0!==o[a]?o[a]:r[a],h=void 0===I?null:I&&b?I/b:I,_=new d({value:h});if(u.isRelatedField(a)){const e=p.getRelatedFieldInfo(a),t=p.getRelatedFieldInfo(m),i=t?t.fieldName:null,r=u.formatValueToFieldInfo(h,{fieldInfos:l,fieldName:n,layer:c,preventPlacesFormatting:!!b}),s=e?e.label||e.fieldName:n,d=i&&void 0!==o[i]?o[i]:s;return _.tooltip=this._getTooltip({label:d,value:r,chartType:f}),_}const v=u.getFieldInfo(l,a),A=u.getFixedFieldName(a,c),M=m&&void 0!==r[m]?r[m]:u.getFieldInfoLabel(v||new s({fieldName:A}),null==(t=this.popupTemplate)?void 0:t.expressionInfos),g=r[A];return _.tooltip=this._getTooltip({label:M,value:g,chartType:f}),_},e._createClass(i,[{key:"activeMediaInfo",get:function(){return this.formattedMediaInfos[this.activeMediaInfoIndex]||null}},{key:"formattedMediaInfos",get:function(){return this._formatMediaInfos()||[]}},{key:"formattedMediaInfoCount",get:function(){return this.formattedMediaInfos.length}}]),i}(i);t.__decorate([o.property()],c.prototype,"abilities",void 0),t.__decorate([n.cast("abilities")],c.prototype,"castAbilities",null),t.__decorate([o.property()],c.prototype,"activeMediaInfoIndex",void 0),t.__decorate([o.property({readOnly:!0})],c.prototype,"activeMediaInfo",null),t.__decorate([o.property()],c.prototype,"attributes",void 0),t.__decorate([o.property()],c.prototype,"description",void 0),t.__decorate([o.property()],c.prototype,"fieldInfoMap",void 0),t.__decorate([o.property()],c.prototype,"formattedAttributes",void 0),t.__decorate([o.property()],c.prototype,"expressionAttributes",void 0),t.__decorate([o.property({readOnly:!0})],c.prototype,"formattedMediaInfos",null),t.__decorate([o.property()],c.prototype,"layer",void 0),t.__decorate([o.property({readOnly:!0})],c.prototype,"formattedMediaInfoCount",null),t.__decorate([o.property()],c.prototype,"mediaInfos",void 0),t.__decorate([o.property()],c.prototype,"popupTemplate",void 0),t.__decorate([o.property()],c.prototype,"relatedInfos",void 0),t.__decorate([o.property()],c.prototype,"title",void 0),c=t.__decorate([l.subclass("esri.widgets.Feature.FeatureMedia.FeatureMediaViewModel")],c);return c}));
