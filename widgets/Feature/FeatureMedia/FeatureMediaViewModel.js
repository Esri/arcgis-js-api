/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{_ as t}from"../../../chunks/tslib.es6.js";import e from"../../../core/Accessor.js";import{property as o}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/arrayUtils.js";import"../../../core/has.js";import{cast as i}from"../../../core/accessorSupport/decorators/cast.js";import{subclass as r}from"../../../core/accessorSupport/decorators/subclass.js";import a from"../../../popup/FieldInfo.js";import s from"../../../popup/content/support/ChartMediaInfoValueSeries.js";import{substituteFieldsInLinksAndAttributes as l,fixTokens as n,substituteAttributes as p,getFixedFieldNames as d,getFixedFieldName as u,isRelatedField as f,getFieldInfo as c,getFieldInfoLabel as m}from"../support/featureUtils.js";import{getRelatedFieldInfo as h}from"../support/relatedFeatureUtils.js";const y={chartAnimation:!0};let I=class extends e{constructor(t){super(t),this.abilities={...y},this.activeMediaInfoIndex=0,this.attributes=null,this.description=null,this.fieldInfoMap=null,this.formattedAttributes=null,this.expressionAttributes=null,this.layer=null,this.mediaInfos=null,this.popupTemplate=null,this.relatedInfos=null,this.title=null}castAbilities(t){return{...y,...t}}get activeMediaInfo(){return this.formattedMediaInfos[this.activeMediaInfoIndex]||null}get formattedMediaInfos(){return this._formatMediaInfos()||[]}get formattedMediaInfoCount(){return this.formattedMediaInfos.length}setActiveMedia(t){this._setContentElementMedia(t)}next(){this._pageContentElementMedia(1)}previous(){this._pageContentElementMedia(-1)}_setContentElementMedia(t){const{formattedMediaInfoCount:e}=this,o=(t+e)%e;this.activeMediaInfoIndex=o}_pageContentElementMedia(t){const{activeMediaInfoIndex:e}=this,o=e+t;this._setContentElementMedia(o)}_formatMediaInfos(){const{attributes:t,mediaInfos:e,formattedAttributes:o,expressionAttributes:i,fieldInfoMap:r,layer:a}=this;return e?.map((e=>{const s=e?.clone();if(!s)return null;if(s.title=l({attributes:t,fieldInfoMap:r,globalAttributes:o,expressionAttributes:i,layer:a,text:s.title}),s.caption=l({attributes:t,fieldInfoMap:r,globalAttributes:o,expressionAttributes:i,layer:a,text:s.caption}),s.altText=l({attributes:t,fieldInfoMap:r,globalAttributes:o,expressionAttributes:i,layer:a,text:s.altText}),"image"===s.type){const{value:t}=s;return this._setImageValue({value:t,formattedAttributes:o,layer:a}),s.value.sourceURL?s:void 0}if("pie-chart"===s.type||"line-chart"===s.type||"column-chart"===s.type||"bar-chart"===s.type){const{value:e}=s;return this._setChartValue({value:e,chartType:s.type,attributes:t,formattedAttributes:o,layer:a}),s}return null})).filter(Boolean)}_setImageValue(t){const{fieldInfoMap:e}=this,{value:o,formattedAttributes:i,layer:r}=t,{linkURL:a,sourceURL:s}=o;if(s){const t=n(s,r);o.sourceURL=p({formattedAttributes:i,template:t,fieldInfoMap:e})}if(a){const t=n(a,r);o.linkURL=p({formattedAttributes:i,template:t,fieldInfoMap:e})}}_setChartValue(t){const{value:e,attributes:o,formattedAttributes:i,chartType:r,layer:a}=t,{popupTemplate:s,relatedInfos:l}=this,{fields:n,normalizeField:p}=e;e.fields=d(n,a),p&&(e.normalizeField=u(p,a));if(!n.some((t=>!!(null!=i[t]||f(t)&&l.size))))return;const c=s?.fieldInfos;n.forEach((t=>{if(f(t))return void(e.series=[...e.series,...this._getRelatedChartInfos({fieldInfos:c,fieldName:t,formattedAttributes:i,chartType:r,value:e})]);const a=this._getChartOption({value:e,attributes:o,chartType:r,formattedAttributes:i,fieldName:t,fieldInfos:c});e.series.push(a)}))}_getRelatedChartInfos(t){const{fieldInfos:e,fieldName:o,formattedAttributes:i,chartType:r,value:a}=t,s=[],l=h(o),{layerId:n,fieldName:p}=l,d=this.relatedInfos?.get(n.toString());if(!d)return s;const{relatedFeatures:u,relation:f}=d;if(!f||!u)return s;const{cardinality:c}=f;u.forEach((t=>{const{attributes:l}=t;l&&Object.keys(l).forEach((t=>{t===p&&s.push(this._getChartOption({value:a,attributes:l,formattedAttributes:i,fieldName:o,chartType:r,relatedFieldName:t,fieldInfos:e}))}))}));return"one-to-many"===c||"many-to-many"===c?s:[s[0]]}_getTooltip({label:t,value:e,chartType:o}){return"pie-chart"===o?`${t}`:`${t}: ${e}`}_getChartOption(t){const{value:e,attributes:o,formattedAttributes:i,fieldName:r,relatedFieldName:l,fieldInfos:n,chartType:p}=t,{layer:d,fieldInfoMap:y}=this,{normalizeField:I,tooltipField:b}=e,v=I?f(I)?o[h(I).fieldName]:o[I]:null,M=l&&void 0!==o[l]?o[l]:void 0!==o[r]?o[r]:i[r],A=new s({fieldName:r,value:void 0===M?null:M&&v?M/v:M});if(f(r)){const t=y.get(r.toLowerCase()),e=y.get(b.toLowerCase()),o=t?.fieldName??r,a=i[e?.fieldName??b]??t?.label??t?.fieldName??l,s=i[o];return A.tooltip=this._getTooltip({label:a,value:s,chartType:p}),A}const g=c(n,r),_=u(r,d),x=b&&void 0!==i[b]?i[b]:m(g||new a({fieldName:_}),this.popupTemplate?.expressionInfos),C=i[_];return A.tooltip=this._getTooltip({label:x,value:C,chartType:p}),A}};t([o()],I.prototype,"abilities",void 0),t([i("abilities")],I.prototype,"castAbilities",null),t([o()],I.prototype,"activeMediaInfoIndex",void 0),t([o({readOnly:!0})],I.prototype,"activeMediaInfo",null),t([o()],I.prototype,"attributes",void 0),t([o()],I.prototype,"description",void 0),t([o()],I.prototype,"fieldInfoMap",void 0),t([o()],I.prototype,"formattedAttributes",void 0),t([o()],I.prototype,"expressionAttributes",void 0),t([o({readOnly:!0})],I.prototype,"formattedMediaInfos",null),t([o()],I.prototype,"layer",void 0),t([o({readOnly:!0})],I.prototype,"formattedMediaInfoCount",null),t([o()],I.prototype,"mediaInfos",void 0),t([o()],I.prototype,"popupTemplate",void 0),t([o()],I.prototype,"relatedInfos",void 0),t([o()],I.prototype,"title",void 0),I=t([r("esri.widgets.Feature.FeatureMedia.FeatureMediaViewModel")],I);const b=I;export{b as default};
