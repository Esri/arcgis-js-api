/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/has","../../../core/Logger","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass","../../../core/urlUtils","../../../core/uuid","../../../portal/support/resourceExtension","../../../core/Accessor","../../../popup/FieldInfo","../../../popup/content/support/ChartMediaInfoValueSeries","../support/featureUtils","../support/relatedFeatureUtils"],(function(e,t,o,i,r,a,n,l,s,d,u,f,p,c,m){"use strict";let I=function(t){function o(e){var o;return(o=t.call(this,e)||this).activeMediaInfoIndex=0,o.attributes=null,o.fieldInfoMap=null,o.formattedAttributes=null,o.layer=null,o.mediaInfos=null,o.popupTemplate=null,o.relatedInfos=null,o}e._inheritsLoose(o,t);var i=o.prototype;return i.setActiveMedia=function(e){this._setContentElementMedia(e)},i.next=function(){this._pageContentElementMedia(1)},i.previous=function(){this._pageContentElementMedia(-1)},i._setContentElementMedia=function(e){const{formattedMediaInfoCount:t}=this,o=(e+t)%t;this.activeMediaInfoIndex=o},i._pageContentElementMedia=function(e){const{activeMediaInfoIndex:t}=this,o=t+e;this._setContentElementMedia(o)},i._formatMediaInfos=function(){const{attributes:e,mediaInfos:t,formattedAttributes:o,fieldInfoMap:i,layer:r}=this,a={...o,...e};return null==t?void 0:t.map((t=>{if(!t)return null;const n=t.title?c.processFieldsInLinks(t.title,a,r):"";t.title=n?c.substituteAttributes({formattedAttributes:o,template:n,fieldInfoMap:i}):"";const l=t.caption?c.processFieldsInLinks(t.caption,a,r):"";t.caption=l?c.substituteAttributes({formattedAttributes:o,template:l,fieldInfoMap:i}):"";const s=t.altText?c.processFieldsInLinks(t.altText,a,r):"";if(t.altText=s?c.substituteAttributes({formattedAttributes:o,template:s,fieldInfoMap:i}):"","image"===t.type){const{value:e}=t;return this._setImageValue({value:e,formattedAttributes:o,layer:r}),t.value.sourceURL?t:void 0}if("pie-chart"===t.type||"line-chart"===t.type||"column-chart"===t.type||"bar-chart"===t.type){const{value:i}=t;return this._setChartValue({value:i,chartType:t.type,attributes:e,formattedAttributes:o,layer:r}),t}return null})).filter(Boolean)},i._setImageValue=function(e){const{fieldInfoMap:t}=this,{value:o,formattedAttributes:i,layer:r}=e,{linkURL:a,sourceURL:n}=o;if(n){const e=c.fixTokens(n,r);o.sourceURL=c.substituteAttributes({formattedAttributes:i,template:e,fieldInfoMap:t})}if(a){const e=c.fixTokens(a,r);o.linkURL=c.substituteAttributes({formattedAttributes:i,template:e,fieldInfoMap:t})}},i._setChartValue=function(e){const{value:t,attributes:o,formattedAttributes:i,chartType:r,layer:a}=e,{popupTemplate:n,relatedInfos:l}=this,{fields:s,normalizeField:d}=t;t.fields=c.getFixedFieldNames(s,a),d&&(t.normalizeField=c.getFixedFieldName(d,a));if(!s.some((e=>!!(null!=i[e]||c.isRelatedField(e)&&l.size))))return;const u=null==n?void 0:n.fieldInfos;s.forEach((e=>{if(c.isRelatedField(e))return void(t.series=[...t.series,...this._getRelatedChartInfos({fieldInfos:u,fieldName:e,formattedAttributes:i,chartType:r,value:t})]);const a=this._getChartOption({value:t,attributes:o,chartType:r,formattedAttributes:i,fieldName:e,fieldInfos:u});t.series.push(a)}))},i._getRelatedChartInfos=function(e){var t;const{fieldInfos:o,fieldName:i,formattedAttributes:r,chartType:a,value:n}=e,l=[],s=m.getRelatedFieldInfo(i),{layerId:d,fieldName:u}=s,f=null==(t=this.relatedInfos)?void 0:t.get(d.toString());if(!f)return l;const{relatedFeatures:p,relation:c}=f;if(!c||!p)return l;const{cardinality:I}=c;p.forEach((e=>{const{attributes:t}=e;t&&Object.keys(t).forEach((e=>{e===u&&l.push(this._getChartOption({value:n,attributes:t,formattedAttributes:r,fieldName:i,chartType:a,relatedFieldName:e,fieldInfos:o}))}))}));return"one-to-many"===I||"many-to-many"===I?l:[l[0]]},i._getTooltip=function({label:e,value:t,chartType:o}){return"pie-chart"===o?e:`${e}: ${t}`},i._getChartOption=function(e){var t;const{value:o,attributes:i,formattedAttributes:r,fieldName:a,relatedFieldName:n,fieldInfos:l,chartType:s}=e,{layer:d}=this,{normalizeField:u,tooltipField:I}=o,y=u?c.isRelatedField(u)?i[m.getRelatedFieldInfo(u).fieldName]:i[u]:null,h=n&&void 0!==i[n]?i[n]:void 0!==i[a]?i[a]:r[a],v=void 0===h?null:h&&y?h/y:h,b=new p({value:v});if(c.isRelatedField(a)){const e=m.getRelatedFieldInfo(a),t=m.getRelatedFieldInfo(I),o=t?t.fieldName:null,r=c.formatValueToFieldInfo(v,{fieldInfos:l,fieldName:n,layer:d,preventPlacesFormatting:!!y}),u=e?e.label||e.fieldName:n,f=o&&void 0!==i[o]?i[o]:u;return b.tooltip=this._getTooltip({label:f,value:r,chartType:s}),b}const _=c.getFieldInfo(l,a),M=c.getFixedFieldName(a,d),g=I&&void 0!==r[I]?r[I]:c.getFieldInfoLabel(_||new f({fieldName:M}),null==(t=this.popupTemplate)?void 0:t.expressionInfos),F=r[M];return b.tooltip=this._getTooltip({label:g,value:F,chartType:s}),b},e._createClass(o,[{key:"activeMediaInfo",get:function(){return this.formattedMediaInfos[this.activeMediaInfoIndex]||null}},{key:"formattedMediaInfos",get:function(){return this._formatMediaInfos()||[]}},{key:"formattedMediaInfoCount",get:function(){return this.formattedMediaInfos.length}}]),o}(u);return t.__decorate([a.property()],I.prototype,"activeMediaInfoIndex",void 0),t.__decorate([a.property({readOnly:!0,dependsOn:["formattedMediaInfos","activeMediaInfoIndex"]})],I.prototype,"activeMediaInfo",null),t.__decorate([a.property()],I.prototype,"attributes",void 0),t.__decorate([a.property()],I.prototype,"fieldInfoMap",void 0),t.__decorate([a.property()],I.prototype,"formattedAttributes",void 0),t.__decorate([a.property({readOnly:!0,dependsOn:["attributes","fieldInfoMap","formattedAttributes","mediaInfos","popupTemplate","layer","relatedInfos"]})],I.prototype,"formattedMediaInfos",null),t.__decorate([a.property()],I.prototype,"layer",void 0),t.__decorate([a.property({readOnly:!0,dependsOn:["formattedMediaInfos"]})],I.prototype,"formattedMediaInfoCount",null),t.__decorate([a.property()],I.prototype,"mediaInfos",void 0),t.__decorate([a.property()],I.prototype,"popupTemplate",void 0),t.__decorate([a.property()],I.prototype,"relatedInfos",void 0),I=t.__decorate([n.subclass("esri.widgets.Feature.FeatureMedia.FeatureMediaViewModel")],I),I}));
