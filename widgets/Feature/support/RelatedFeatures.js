// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../../request","../../../core/Accessor","../../../core/Error","../../../core/Logger","../../../core/promiseUtils","../../../core/accessorSupport/decorators","../../../tasks/QueryTask","../../../tasks/support/Query","../../../tasks/support/StatisticDefinition","./featureUtils"],(function(e,t,r,a,o,i,n,s,u,l,d,f,c){var p=new Map,y="esri.widgets.Popup.support.RelatedFeatures",h=n.getLogger(y);return function(e){function t(t){var r=e.call(this,t)||this;return r.relatedInfoCount=null,r.relatedInfos=new Map,r}return r.__extends(t,e),t.prototype.destroy=function(){this.relatedInfos.clear()},t.prototype.addRelatedFeatureAttributes=function(e){var t=this;this.relatedInfos.forEach((function(r){return t._addRelatedFeatureAttribute(e,r)}))},t.prototype.getRelatedFieldInfo=function(e){if(!(-1!==e.indexOf("relationships/")))return null;var t=e.split("/").slice(1);return{layerId:t[0],fieldName:t[1]}},t.prototype.getRelatedInfo=function(e){return this.relatedInfos.get(e.toString())},t.prototype.isRelatedField=function(e){return void 0===e&&(e=""),!!e&&-1!==e.indexOf("relationships/")},t.prototype.queryRelatedInfos=function(e,t,r){var a=this;this.relatedInfos.clear();var o=c.getSourceLayer(e);if(!o)return s.resolve();var i=t.filter((function(e){return e&&a.isRelatedField(e.fieldName)}));return i&&i.length?(this._createRelatedInfos(t,o),this._queryLayerInfos(o,r).then((function(t){return a._updateRelatedInfoLayerInfos(t),a._queryRelatedFeatureMap(e,r).then((function(e){return Object.keys(e).forEach((function(t){a._setRelatedFeatures(e[t],t.toString())})),e}))}))):s.resolve()},t.prototype._addRelatedFeatureAttribute=function(e,t){var r=this;e&&t&&(t.relatedFeatures&&t.relatedFeatures&&t.relatedFeatures.forEach((function(a){return r._addAttributesFromFeature(e,a,t)})),t.relatedStatsFeatures&&t.relatedStatsFeatures&&t.relatedStatsFeatures.forEach((function(a){return r._addAttributesFromFeature(e,a,t)})))},t.prototype._updateRelatedInfoLayerInfo=function(e,t){var r=e.value;r&&(this.getRelatedInfo(t).layerInfo=r.data)},t.prototype._updateRelatedInfoLayerInfos=function(e){var t=this;Object.keys(e).forEach((function(r){return t._updateRelatedInfoLayerInfo(e[r],r.toString())}))},t.prototype._addAttributesFromFeature=function(e,t,r){var a=this;e&&t&&r&&Object.keys(t.attributes).forEach((function(o){var i=a._relatedFieldInfoToString({layerId:r.relation.id.toString(),fieldName:o});e[i]=t.attributes[o]}))},t.prototype._relatedFieldInfoToString=function(e){return e?"relationships/"+e.layerId+"/"+e.fieldName:""},t.prototype._createRelatedInfoForFieldInfo=function(e,t){var r=this.getRelatedFieldInfo(e.fieldName);if(r){var a=r.layerId,o=r.fieldName;if(a){var i=this.getRelatedInfo(a)||this._createRelatedInfo(a,t);if(i&&(i.relatedFields.push(o),e.statisticType)){var n=new f({statisticType:e.statisticType,onStatisticField:o,outStatisticFieldName:o});i.outStatistics.push(n)}}}},t.prototype._createRelatedInfos=function(e,t){var r=this;e.forEach((function(e){return r._createRelatedInfoForFieldInfo(e,t)}))},t.prototype._queryRelatedFeatureMap=function(e,t){var r=this,a={};return this.relatedInfos.forEach((function(o,i){o.layerInfo&&(a[i]=r._queryRelatedLayerFeatures(e,o,t))})),s.eachAlways(a)},t.prototype._queryLayerInfos=function(e,t){var r=this,a={};return this.relatedInfos.forEach((function(o,n){var s=o.relation;if(!s){var u=new i("relation-required","A relation is required on a layer to retrieve related records.");throw h.error(u),u}var l=s.relatedTableId;if("number"!=typeof l){u=new i("A related table ID is required on a layer to retrieve related records.");throw h.error(u),u}var d=e.url+"/"+l,f=p.get(d),c=f||r._queryLayerInfo(d,t);f||p.set(d,c),a[n]=c})),s.eachAlways(a)},t.prototype._queryLayerInfo=function(e,t){return a(e,{query:{f:"json"},signal:t&&t.signal})},t.prototype._queryRelatedLayerFeatures=function(e,t,r){var a=c.getSourceLayer(e).layerId.toString(),o=t.layerInfo,i=t.queryTask,n=t.relation,u=this._getDestinationRelation(o,a);if(u){var l=n.keyField,f=u.keyField,p="string"===this._getDestinationFieldType(o,u)?f+"='"+e.attributes[l]+"'":f+"="+e.attributes[l],y=i.execute(new d({where:p,outFields:t.relatedFields}),r),h=t.outStatistics&&t.outStatistics.length>0&&o.supportsStatistics?i.execute(new d({where:p,outFields:t.relatedFields,outStatistics:t.outStatistics}),r):null;return s.eachAlways({features:y,statsFeatures:h||s.resolve()})}return s.resolve()},t.prototype._setRelatedFeatures=function(e,t){var r=this.getRelatedInfo(t);if(r){var a=e.value;if(a){var o=a.features,i=a.statsFeatures,n=o&&o.value;r.relatedFeatures=n?n.features:[];var s=i&&i.value;r.relatedStatsFeatures=s?s.features:[]}}},t.prototype._getRelation=function(e,t){if(!t.relationships)return null;var r=null;return t.relationships.some((function(t){return t.id===parseInt(e,10)&&(r=t,!0)})),r},t.prototype._createRelatedInfo=function(e,t){var r=this._getRelation(e,t);if(r){var a=t.url+"/"+r.relatedTableId,o={url:a,queryTask:new l({url:a,sourceSpatialReference:t.spatialReference}),relation:r,relatedFields:[],outStatistics:[]};return this.relatedInfos.set(e,o),o}},t.prototype._getDestinationRelation=function(e,t){var r;return e&&e.relationships&&e.relationships.some((function(e){return""+e.relatedTableId===t&&(r=e,!0)})),r},t.prototype._getDestinationFieldType=function(e,t){var r=void 0;return e.fields.some((function(e){if(e.name===t.keyField){return r=-1!==["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble"].indexOf(e.type)?"number":"string",!0}return!1})),r},r.__decorate([u.aliasOf("relatedInfos.size")],t.prototype,"relatedInfoCount",void 0),r.__decorate([u.property()],t.prototype,"relatedInfos",void 0),t=r.__decorate([u.subclass(y)],t)}(o)}));