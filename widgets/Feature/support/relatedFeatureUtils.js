/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../core/Logger","../../../core/Error","../../../core/promiseUtils","../../../layers/support/fieldUtils","../../../request","../../../tasks/support/StatisticDefinition","../../../tasks/support/Query","../../../tasks/QueryTask","./featureUtils"],(function(e,t,r,s,i,a,n,l,o,u){"use strict";const c=t.getLogger("esri.widgets.Feature.support.relatedFeatureUtils"),d=new Map;function f({originRelationship:e,relationships:t,layerId:r}){let s;return t&&t.some((t=>(`${t.relatedTableId}`===r&&t.id===e.id&&(s=t),!!s))),s}e.createRelatedInfo=function(e,t){const r=function(e,t){if(!t.relationships)return null;let r=null;const{relationships:s}=t;return s.some((t=>t.id===parseInt(e,10)&&(r=t,!0))),r}(e,t);if(!r)return;const s=`${t.url}/${r.relatedTableId}`;return{url:s,queryTask:new o({url:s,sourceSpatialReference:t.spatialReference}),relation:r,relatedFields:[],outStatistics:[]}},e.getDestinationRelation=f,e.getRelatedFieldInfo=function(e){if(!u.isRelatedField(e))return null;const[t,r]=e.split("/").slice(1);return{layerId:t,fieldName:r}},e.queryLayerInfos=function({relatedInfos:e,layer:t},i){const n={};return e.forEach(((e,s)=>{const{relation:l}=e;if(!l){const e=new r("relation-required","A relation is required on a layer to retrieve related records.");throw c.error(e),e}const{relatedTableId:o}=l;if("number"!=typeof o){const e=new r("A related table ID is required on a layer to retrieve related records.");throw c.error(e),e}const u=`${t.url}/${o}`,f=d.get(u),p=f||function(e,t){return a(e,{query:{f:"json"},signal:t&&t.signal})}(u,i);f||d.set(u,p),n[s]=p})),s.eachAlways(n)},e.queryRelatedFeatures=function({graphic:e,relatedInfos:t,layer:r},a){const n={};return t.forEach(((t,o)=>{t.layerInfo&&(n[o]=async function(e,t,r,a){var n;const o=r.layerId.toString(),{layerInfo:u,queryTask:c,relation:d}=t,p=null==(n=f({originRelationship:d,relationships:u.relationships,layerId:o}))?void 0:n.keyField;if(p){const r=i.isNumericField(i.getField(u.fields,p)),n=function(e,t){const r=t.toLowerCase();for(const t in e)if(t.toLowerCase()===r)return e[t];return null}(e.attributes,d.keyField),o=r?`${p}=${n}`:`${p}='${n}'`,f=c.execute(new l({where:o,outFields:t.relatedFields}),a),y=t.outStatistics&&t.outStatistics.length>0&&u.supportsStatistics?c.execute(new l({where:o,outFields:t.relatedFields,outStatistics:t.outStatistics}),a):null,F={features:f};return y&&(F.statsFeatures=y),s.eachAlways(F)}return null}(e,t,r,a))})),s.eachAlways(n)},e.setRelatedFeatures=function(e,t){if(!t)return;if(!e)return;const{features:r,statsFeatures:s}=e,i=r&&r.value;t.relatedFeatures=i?i.features:[];const a=s&&s.value;t.relatedStatsFeatures=a?a.features:[]},e.updateRelatedInfo=function({relatedInfo:e,fieldName:t,fieldInfo:r}){if(e.relatedFields.push(t),r.statisticType){const s=new n({statisticType:r.statisticType,onStatisticField:t,outStatisticFieldName:t});e.outStatistics.push(s)}},Object.defineProperty(e,"__esModule",{value:!0})}));
