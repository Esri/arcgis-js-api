/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../request","../../../core/Error","../../../core/Logger","../../../core/promiseUtils","../../../layers/support/fieldUtils","../../../core/has","../../../layers/support/source/DataLayerSource","../../../rest/query/executeQueryJSON","../../../config","../../../kernel","../../../core/arrayUtils","../../../core/urlUtils","../../../core/unitUtils","../../../geometry/support/spatialReferenceUtils","../../../layers/graphics/featureConversionUtils","../../../geometry/Extent","../../../geometry/Geometry","../../../geometry/Multipoint","../../../geometry/Point","../../../geometry/Polygon","../../../geometry/Polyline","../../../geometry/support/normalizeUtils","../../../core/pbf","../../../rest/support/FeatureSet","../../../rest/support/Query","../../../rest/query/support/AttachmentInfo","../../../rest/support/AttachmentQuery","../../../geometry","../../../rest/support/RelationshipQuery","../../../rest/support/TopFeaturesQuery","../../../rest/support/StatisticDefinition","./featureUtils"],(function(e,t,r,s,i,o,n,a,l,u,c,d,f,p,y,h,g,F,I,S,m,w,b,R,T,$,q,U,A,N,j,v,L,Q){"use strict";const O="esri.widgets.Feature.support.relatedFeatureUtils",P=i.getLogger(O),x=new Map;function k(e){if(!Q.isRelatedField(e))return null;const[t,r]=e.split("/").slice(1);return{layerId:t,fieldName:r}}function C(e,t){if(!t.relationships)return null;let r=null;const{relationships:s}=t;return s.some((t=>t.id===parseInt(e,10)&&(r=t,!0))),r}function D({originRelationship:e,relationships:t,layerId:r}){let s=null;return t&&t.some((t=>(`${t.relatedTableId}`===r&&t.id===e?.id&&(s=t),!!s))),s}function E(e,t){const r=t.toLowerCase();for(const s in e)if(s.toLowerCase()===r)return e[s];return null}function J(e,t){const r=C(e,t);if(!r)return;return{url:`${t.url}/${r.relatedTableId}`,sourceSpatialReference:t.spatialReference,relation:r,relatedFields:[],outStatistics:[]}}function M(e,t){if(!t)return;if(!e)return;const{features:r,statsFeatures:s}=e,i=r&&r.value;t.relatedFeatures=i?i.features:[];const o=s&&s.value;t.relatedStatsFeatures=o?o.features:[]}function G(e,t,r,s){const i=new j;return i.outFields=["*"],i.relationshipId="number"==typeof t.id?t.id:parseInt(t.id,10),i.objectIds=[e.attributes[r.objectIdField]],r.queryRelatedFeatures?.(i,s)??Promise.resolve({})}function _(e,t,r){let s=0;const i=[];for(;s<t.length;)i.push(`${e} IN (${t.slice(s,r+s)})`),s+=r;return i.join(" OR ")}function z(e,t,r,s){return B.apply(this,arguments)}function B(){return(B=t._asyncToGenerator((function*(e,t,r,s){const i=r.layerId.toString(),{layerInfo:a,relation:l,relatedFields:c,outStatistics:d,url:f,sourceSpatialReference:p}=t;if(!a||!l)return null;const y=D({originRelationship:l,relationships:a.relationships,layerId:i});if(y?.relationshipTableId&&y.keyFieldInRelationshipTable){const t=(yield G(e,y,r,s))[e.attributes[r.objectIdField]];if(!t)return null;const i=t.features.map((e=>e.attributes[a.objectIdField]));if(d?.length&&a.supportsStatistics){const e=new q;e.where=_(a.objectIdField,i,1e3),e.outFields=c,e.outStatistics=d,e.sourceSpatialReference=p;const r={features:Promise.resolve(t),statsFeatures:u.executeQueryJSON(f,e)};return o.eachAlways(r)}}const h=y?.keyField;if(h){const r=n.isNumericField(X(a.fields,h)),i=E(e.attributes,l.keyField),c=r?`${h}=${i}`:`${h}='${i}'`,d=u.executeQueryJSON(f,new q({where:c,outFields:t.relatedFields,sourceSpatialReference:p}),s),y=t.outStatistics&&t.outStatistics.length>0&&a.supportsStatistics?u.executeQueryJSON(f,new q({where:c,outFields:t.relatedFields,outStatistics:t.outStatistics,sourceSpatialReference:p}),s):null,g={features:d};return y&&(g.statsFeatures=y),o.eachAlways(g)}return null}))).apply(this,arguments)}function H(e,t){return r(e,{query:{f:"json"},signal:t&&t.signal})}function K({relatedInfos:e,layer:t},r){const i={};return e.forEach(((e,r)=>{const{relation:o}=e;if(!o){const e=new s("relation-required","A relation is required on a layer to retrieve related records.");throw P.error(e),e}const{relatedTableId:n}=o;if("number"!=typeof n){const e=new s("A related table ID is required on a layer to retrieve related records.");throw P.error(e),e}const a=`${t.url}/${n}`,l=x.get(a),u=l||H(a);l||x.set(a,u),i[r]=u})),o.whenOrAbort(o.eachAlways(i),r)}function V({graphic:e,relatedInfos:t,layer:r},s){const i={};return t.forEach(((t,o)=>{t.layerInfo&&(i[o]=z(e,t,r,s))})),o.eachAlways(i)}function W({relatedInfo:e,fieldName:t,fieldInfo:r}){if(e.relatedFields?.push(t),r.statisticType){const s=new L({statisticType:r.statisticType,onStatisticField:t,outStatisticFieldName:t});e.outStatistics?.push(s)}}function X(e,t){if(null!=e){t=t.toLowerCase();for(const r of e)if(r&&r.name.toLowerCase()===t)return r}return null}e.createRelatedInfo=J,e.getDestinationRelation=D,e.getRelatedFieldInfo=k,e.queryLayerInfos=K,e.queryRelatedFeatures=V,e.setRelatedFeatures=M,e.updateRelatedInfo=W,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
