/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../core/Logger","../../../core/Error","../../../core/promiseUtils","../../../layers/support/fieldUtils","../../../request","../../../tasks/support/StatisticDefinition","../../../tasks/support/Query","../../../tasks/support/RelationshipQuery","../../../tasks/QueryTask","./featureUtils"],(function(e,t,r,s,i,n,a,o,l,u,c){"use strict";const d="esri.widgets.Feature.support.relatedFeatureUtils",f=t.getLogger(d),p=new Map;function y(e){if(!c.isRelatedField(e))return null;const[t,r]=e.split("/").slice(1);return{layerId:t,fieldName:r}}function F(e,t){if(!t.relationships)return null;let r=null;const{relationships:s}=t;return s.some((t=>t.id===parseInt(e,10)&&(r=t,!0))),r}function h({originRelationship:e,relationships:t,layerId:r}){let s;return t&&t.some((t=>(`${t.relatedTableId}`===r&&t.id===e.id&&(s=t),!!s))),s}function I(e,t){const r=t.toLowerCase();for(const s in e)if(s.toLowerCase()===r)return e[s];return null}function w(e,t){const r=F(e,t);if(!r)return;const s=`${t.url}/${r.relatedTableId}`;return{url:s,queryTask:new u({url:s,sourceSpatialReference:t.spatialReference}),relation:r,relatedFields:[],outStatistics:[]}}function g(e,t){if(!t)return;if(!e)return;const{features:r,statsFeatures:s}=e,i=r&&r.value;t.relatedFeatures=i?i.features:[];const n=s&&s.value;t.relatedStatsFeatures=n?n.features:[]}function b(e,t,r,s){const i=new l;return i.outFields=["*"],i.relationshipId="number"==typeof t.id?t.id:parseInt(t.id,10),i.objectIds=[e.attributes[r.objectIdField]],r.queryRelatedFeatures(i,s)}function S(e,t,r){let s=0;const i=[];for(;s<t.length;)i.push(`${e} IN (${t.slice(s,r+s)})`),s+=r;return i.join(" OR ")}async function R(e,t,r,n){const a=r.layerId.toString(),{layerInfo:l,queryTask:u,relation:c,relatedFields:d,outStatistics:f}=t,p=h({originRelationship:c,relationships:l.relationships,layerId:a});if(p.relationshipTableId&&p.keyFieldInRelationshipTable){const t=(await b(e,p,r,n))[e.attributes[r.objectIdField]];if(!t)return null;const i=t.features.map((e=>e.attributes[l.objectIdField]));if((null==f?void 0:f.length)>0&&l.supportsStatistics){const e=new o;e.where=S(l.objectIdField,i,1e3),e.outFields=d,e.outStatistics=f;const r={features:Promise.resolve(t),statsFeatures:u.execute(e)};return s.eachAlways(r)}}const y=null==p?void 0:p.keyField;if(y){const r=i.isNumericField(i.getField(l.fields,y)),a=I(e.attributes,c.keyField),d=r?`${y}=${a}`:`${y}='${a}'`,f=u.execute(new o({where:d,outFields:t.relatedFields}),n),p=t.outStatistics&&t.outStatistics.length>0&&l.supportsStatistics?u.execute(new o({where:d,outFields:t.relatedFields,outStatistics:t.outStatistics}),n):null,F={features:f};return p&&(F.statsFeatures=p),s.eachAlways(F)}return null}function m(e,t){return n(e,{query:{f:"json"},signal:t&&t.signal})}function T({relatedInfos:e,layer:t},i){const n={};return e.forEach(((e,s)=>{const{relation:a}=e;if(!a){const e=new r("relation-required","A relation is required on a layer to retrieve related records.");throw f.error(e),e}const{relatedTableId:o}=a;if("number"!=typeof o){const e=new r("A related table ID is required on a layer to retrieve related records.");throw f.error(e),e}const l=`${t.url}/${o}`,u=p.get(l),c=u||m(l,i);u||p.set(l,c),n[s]=c})),s.eachAlways(n)}function $({graphic:e,relatedInfos:t,layer:r},i){const n={};return t.forEach(((t,s)=>{t.layerInfo&&(n[s]=R(e,t,r,i))})),s.eachAlways(n)}function k({relatedInfo:e,fieldName:t,fieldInfo:r}){if(e.relatedFields.push(t),r.statisticType){const s=new a({statisticType:r.statisticType,onStatisticField:t,outStatisticFieldName:t});e.outStatistics.push(s)}}e.createRelatedInfo=w,e.getDestinationRelation=h,e.getRelatedFieldInfo=y,e.queryLayerInfos=T,e.queryRelatedFeatures=$,e.setRelatedFeatures=g,e.updateRelatedInfo=k,Object.defineProperty(e,"__esModule",{value:!0})}));
