// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../intl","../../../core/Error","../../../core/Logger","../../../core/string","../../../intl/date","../../../intl/number","../../../layers/support/fieldUtils","../../../popup/support/FieldInfoFormat"],(function(e,t,r,n,i,a,o,u,l,f,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.addRelatedFeatureAttribute=t.isRelatedField=t.queryRequiredFields=t.formatAttributes=t.applyTextFormattingHTML=t.htmlEntities=t.getAllFieldInfos=t.createfieldInfoMap=t.formatEditInfo=t.getFieldInfo=t.formatValueToFieldInfo=t.processFieldsInLinks=t.fixTokens=t.substituteAttributes=t.getFixedFieldNames=t.getFixedFieldName=t.getFieldInfoLabel=t.isExpressionField=t.shouldOpenInNewTab=t.graphicCallback=t.getSourceLayer=void 0;var d=a.getLogger("esri.widgets.Feature.support.featureUtils"),c=/href=(""|'')/gi,p=/(\{([^\{\r\n]+)\})/g,m=/\'/g,g=/^\s*expression\//i,v=/(\n)/gi,F=/[\u00A0-\u9999<>\&]/gim,y=/href\s*=\s*(?:\"([^\"]+)\"|\'([^\']+)\')/gi,h=/^(?:mailto:|tel:)/,b=u.convertDateFormatToIntlOptions("short-date-short-time");function I(e){return g.test(e)}function N(e,t){var r=w(t,e);return r?r.name:e}function w(e,t){return e&&"function"==typeof e.getField?e.getField(t):null}function _(e){return(""+e).trim()}function L(e,t){void 0===t&&(t=!1);var n=r.__assign({},e);return Object.keys(n).forEach((function(e){return function(e,t,r){void 0===r&&(r=!1);var n=t[e];if("string"==typeof n){var i=(r?encodeURIComponent(n):n).replace(m,"%27");t[e]=i}}(e,n,t)})),n}function T(e,t){return e.replace(p,(function(e,r,n){var i=w(t,n);return i?"{"+i.name+"}":r}))}function x(e,t){var n=t.fieldInfos,i=t.fieldName,a=q(n,i),o=null==a?void 0:a.clone(),u=t.preventPlacesFormatting,f=w(t.layer,i);if(o&&f&&"date"===f.type){var d=o.format||new s;d.dateFormat=d.dateFormat||"short-date-short-time",o.format=d}var c=o&&o.format;return"string"==typeof(e=function(e,t){if("string"==typeof e&&t&&null==t.dateFormat&&(null!=t.places||null!=t.digitSeparator)){var r=Number(e);if(!isNaN(r))return r}return e}(e,c))||null==e||null==c?e:u?l.formatNumber(e,r.__assign(r.__assign({},l.convertNumberFormatToIntlOptions(c)),{minimumFractionDigits:0,maximumFractionDigits:20})):c.format(e)}function q(e,t){if(e&&e.length&&t){var r=t.toLowerCase(),n=void 0;return e.some((function(e){return!(!e.fieldName||e.fieldName.toLowerCase()!==r)&&(n=e,!0)})),n}}function E(e){return"string"==typeof e?e.replace(v,'<br class="esri-text-new-line" />'):e}function A(e){var t=e.value,r=e.fieldName,i=e.fieldInfos,a=e.fieldInfoMap,o=e.layer,u=e.graphic;if(null==t)return"";var l=function(e){var t=e.fieldName,r=e.value,n=e.graphic,i=e.layer;if(D(t))return null;if(!i||"function"!=typeof i.getFieldDomain)return null;var a=i.getFieldDomain(t,{feature:n});return a&&"coded-value"===a.type?a.getName(r):null}({fieldName:r,value:t,graphic:u,layer:o});if(l)return l;var f=function(e){var t=e.fieldName,r=e.graphic,n=e.layer;if(D(t))return null;if(!n||"function"!=typeof n.getFeatureType)return null;var i=n.typeIdField;if(!i||t!==i)return null;var a=n.getFeatureType(r);return a?a.name:null}({fieldName:r,graphic:u,layer:o});if(f)return f;if(a.get(r.toLowerCase()))return x(t,{fieldInfos:i,fieldName:r,layer:o});var s=o&&o.fieldsIndex;return s&&s.isDateField(r)?n.formatDate(t,b):E(t)}function C(e,t){return r.__awaiter(this,void 0,void 0,(function(){var n,a,o,u,l,f,s,c,p;return r.__generator(this,(function(r){switch(r.label){case 0:if(n=e.layer,a=e.graphic,o=e.outFields,u=e.objectIds,"number"!=typeof(l=u[0]))throw c=new i("layer-query-features-invalid-objectid",f="Could not query required fields for the specified feature. The feature's ID is invalid.",s={layer:n,graphic:a,objectId:l,requiredFields:o}),d.warn(f,s),c;if("function"!=typeof n.queryFeatures)throw c=new i("layer-query-features-unsupported",f="The specified layer does not support the method 'queryFeatures'. The following fields will not be available.",s={layer:n,graphic:a,requiredFields:o}),d.warn(f,s),c;return(p=n.createQuery()).objectIds=u,p.outFields=o,p.returnGeometry=!0,[4,n.queryFeatures(p,t)];case 1:return[2,r.sent().features[0]]}}))}))}function D(e){return void 0===e&&(e=""),!!e&&-1!==e.indexOf("relationships/")}function j(e){var t=e.attributes,r=e.graphic,n=e.relatedInfo;t&&r&&n&&Object.keys(r.attributes).forEach((function(e){var i,a=(i={layerId:n.relation.id.toString(),fieldName:e})?"relationships/"+i.layerId+"/"+i.fieldName:"";t[a]=r.attributes[e]}))}function M(e,t){e&&t&&(t.relatedFeatures&&t.relatedFeatures&&t.relatedFeatures.forEach((function(r){return j({attributes:e,graphic:r,relatedInfo:t})})),t.relatedStatsFeatures&&t.relatedStatsFeatures&&t.relatedStatsFeatures.forEach((function(r){return j({attributes:e,graphic:r,relatedInfo:t})})))}t.getSourceLayer=function(e){if(e)return e.get("sourceLayer")||e.get("layer")},t.graphicCallback=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(r){return[2,"function"==typeof e?e.call(null,t):e]}))}))},t.shouldOpenInNewTab=function(e){if(void 0===e&&(e=""),e)return!h.test(e.trim().toLowerCase())},t.isExpressionField=I,t.getFieldInfoLabel=function(e,t){var r=function(e,t){if(!I(t)||!e)return null;var r,n=t.replace(g,"").toLowerCase();return e.some((function(e){return e.name.toLowerCase()===n&&(r=e,!0)})),r}(t,null==e?void 0:e.fieldName);return r?r.title||null:e?e.label||e.fieldName:null},t.getFixedFieldName=N,t.getFixedFieldNames=function(e,t){return e&&e.map((function(e){return N(e,t)}))},t.substituteAttributes=function(e){var t=e.formattedAttributes,r=e.template,n=e.fieldInfoMap;return _(o.replace(o.replace(r,(function(e){return function(e,t){var r=t.get(e.toLowerCase());return"{"+(r&&r.fieldName||e)+"}"}(e,n)})),t).replace(c,""))},t.fixTokens=T,t.processFieldsInLinks=function(e,t,r){var n=T(e,r);return n?n.replace(y,(function(e,r,n){return function(e,t,r){var n=(t=_(t))&&"{"!==t[0];return o.replace(e,L(r,n))}(e,r||n,t)})):n},t.formatValueToFieldInfo=x,t.getFieldInfo=q,t.formatEditInfo=function(e,t){var r=e.creatorField,i=e.creationDateField,a=e.editorField,o=e.editDateField;if(t){var u=t[o];if("number"==typeof u){var l=t[a];return{type:"edit",date:n.formatDate(u,b),user:l}}var f=t[i];if("number"==typeof f){var s=t[r];return{type:"create",date:n.formatDate(f,b),user:s}}return null}},t.createfieldInfoMap=function(e,t){var r=new Map;return e&&e.forEach((function(e){var n=N(e.fieldName,t);e.fieldName=n,r.set(n.toLowerCase(),e)})),r},t.getAllFieldInfos=function(e){var t=[];if(!e)return t;var r=e.fieldInfos,n=e.content;return r&&t.push.apply(t,r),n&&Array.isArray(n)?(n.forEach((function(e){if("fields"===e.type){var r=e&&e.fieldInfos;r&&t.push.apply(t,r)}})),t):t},t.htmlEntities=function(e){return e.replace(F,(function(e){return"&#"+e.charCodeAt(0)+";"}))},t.applyTextFormattingHTML=E,t.formatAttributes=function(e){var t=e.fieldInfos,r=e.attributes,n=e.layer,i=e.graphic,a=e.fieldInfoMap;return e.relatedInfos.forEach((function(e){return M(r,e)})),Object.keys(r).forEach((function(e){var o=r[e];r[e]=A({fieldName:e,fieldInfos:t,fieldInfoMap:a,layer:n,value:o,graphic:i})})),r},t.queryRequiredFields=function(e,t){var n=e.graphic,i=e.popupTemplate,a=e.layer;return r.__awaiter(this,void 0,void 0,(function(){var e,o,u,l;return r.__generator(this,(function(s){switch(s.label){case 0:return a&&i?"function"!=typeof a.load?[3,2]:[4,a.load(t)]:[2,null];case 1:s.sent(),s.label=2;case 2:return e=n.attributes[a.objectIdField],o=[e],[4,i.getRequiredFields(a.fields)];case 3:return u=s.sent(),f.featureHasFields(u,n)?[2,null]:[4,C({layer:a,graphic:n,outFields:u,objectIds:o},t)];case 4:return(l=s.sent())&&(n.geometry=l.geometry,n.attributes=r.__assign(r.__assign({},n.attributes),l.attributes)),[2]}}))}))},t.isRelatedField=D,t.addRelatedFeatureAttribute=M}));