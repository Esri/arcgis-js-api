/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../core/maybe","../../../core/string","../../../core/Logger","../../../core/Error","../../../layers/support/fieldUtils","../../../intl/date","../../../intl/number","../../../popup/support/FieldInfoFormat","../../../intl"],(function(e,t,r,n,i,o,a,u,l,s){"use strict";const f="esri.widgets.Feature.support.featureUtils",c=n.getLogger(f),d=/href=(""|'')/gi,p=/(\{([^\{\r\n]+)\})/g,m=/\'/g,y=/^\s*expression\//i,g=/(\n)/gi,F=/[\u00A0-\u9999<>\&]/gim,b=/href\s*=\s*(?:\"([^\"]+)\"|\'([^\']+)\')/gi,h=/^(?:mailto:|tel:)/,I="relationships/",N=a.convertDateFormatToIntlOptions("short-date-short-time");function w(e){if(!t.isNone(e))return e.get("sourceLayer")||e.get("layer")}async function L(e,t){return"function"==typeof e?e.call(null,t):e}function v(e=""){if(e)return!h.test(e.trim().toLowerCase())}function T(e){return y.test(e)}function x(e,t){if(!T(t)||!e)return null;const r=t.replace(y,"").toLowerCase();let n;return e.some((e=>e.name.toLowerCase()===r&&(n=e,!0))),n}function A(e,t){const r=x(t,null==e?void 0:e.fieldName);return r?r.title||null:e?e.label||e.fieldName:null}function C(e,t){const r=t.get(e.toLowerCase());return`{${r&&r.fieldName||e}}`}function D(e){return e.replace(d,"")}function E(e,t){const r=j(t,e);return r?r.name:e}function q(e,t){return e&&e.map((e=>E(e,t)))}function j(e,t){return e&&"function"==typeof e.getField?e.getField(t):null}function M(e){return`${e}`.trim()}function O({attributes:e,globalAttributes:t,layer:r,text:n,fieldInfoMap:i}){return n?R({formattedAttributes:t,template:U(n,{...t,...e},r),fieldInfoMap:i}):""}function R({formattedAttributes:e,template:t,fieldInfoMap:n}){return M(D(r.replace(r.replace(t,(e=>C(e,n))),e)))}function S(e,t,r=!1){const n=t[e];if("string"==typeof n){const i="%27",o=(r?encodeURIComponent(n):n).replace(m,i);t[e]=o}}function $(e,t=!1){const r={...e};return Object.keys(r).forEach((e=>S(e,r,t))),r}function k(e,t,n){const i=(t=M(t))&&"{"!==t[0];return r.replace(e,$(n,i))}function G(e,t){return e.replace(p,((e,r,n)=>{const i=j(t,n);return i?`{${i.name}}`:r}))}function U(e,t,r){const n=G(e,r);return n?n.replace(b,((e,r,n)=>k(e,r||n,t))):n}function H(e,t){if("string"==typeof e&&t&&null==t.dateFormat&&(null!=t.places||null!=t.digitSeparator)){const t=Number(e);if(!isNaN(t))return t}return e}function P(e,t){const r=t.fieldInfos,n=t.fieldName,i=_(r,n),o=null==i?void 0:i.clone(),a=t.preventPlacesFormatting,s=j(t.layer,n);if(o&&s&&"date"===s.type){const e=o.format||new l;e.dateFormat=e.dateFormat||"short-date-short-time",o.format=e}const f=o&&o.format;return"string"==typeof(e=H(e,f))||null==e||null==f?e:a?u.formatNumber(e,{...u.convertNumberFormatToIntlOptions(f),minimumFractionDigits:0,maximumFractionDigits:20}):f.format(e)}function _(e,t){if(!e||!e.length||!t)return;const r=t.toLowerCase();let n;return e.some((e=>!(!e.fieldName||e.fieldName.toLowerCase()!==r)&&(n=e,!0))),n}function Q({fieldName:e,graphic:t,layer:r}){if(te(e))return null;if(!r||"function"!=typeof r.getFeatureType)return null;const{typeIdField:n}=r;if(!n||e!==n)return null;const i=r.getFeatureType(t);return i?i.name:null}function V({fieldName:e,value:t,graphic:r,layer:n}){if(te(e))return null;if(!n||"function"!=typeof n.getFieldDomain)return null;const i=n.getFieldDomain(e,{feature:r});return i&&"coded-value"===i.type?i.getName(t):null}function z(e,t){const{creatorField:r,creationDateField:n,editorField:i,editDateField:o}=e;if(!t)return;const u=t[o];if("number"==typeof u){const e=t[i];return{type:"edit",date:a.formatDate(u,N),user:e}}const l=t[n];if("number"==typeof l){const e=t[r];return{type:"create",date:a.formatDate(l,N),user:e}}return null}function B(e,t){const r=new Map;return e&&e.forEach((e=>{const n=E(e.fieldName,t);e.fieldName=n,r.set(n.toLowerCase(),e)})),r}function J(e){const t=[];if(!e)return t;const{fieldInfos:r,content:n}=e;return r&&t.push(...r),n&&Array.isArray(n)?(n.forEach((e=>{if("fields"===e.type){const r=e&&e.fieldInfos;r&&t.push(...r)}})),t):t}function K(e){return e.replace(F,(e=>`&#${e.charCodeAt(0)};`))}function W(e){return"string"==typeof e?e.replace(g,'<br class="esri-text-new-line" />'):e}function X(e){const{value:t,fieldName:r,fieldInfos:n,fieldInfoMap:i,layer:o,graphic:u}=e;if(null==t)return"";const l=V({fieldName:r,value:t,graphic:u,layer:o});if(l)return l;const s=Q({fieldName:r,graphic:u,layer:o});if(s)return s;if(i.get(r.toLowerCase()))return P(t,{fieldInfos:n,fieldName:r,layer:o});const f=o&&o.fieldsIndex;return f&&f.isDateField(r)?a.formatDate(t,N):W(t)}function Y({fieldInfos:e,attributes:t,layer:r,graphic:n,fieldInfoMap:i,relatedInfos:o}){const a={...t};return null==o||o.forEach((e=>ie(a,e))),Object.keys(a).forEach((t=>{const o=a[t];a[t]=X({fieldName:t,fieldInfos:e,fieldInfoMap:i,layer:r,value:o,graphic:n})})),a}async function Z(e,t){const{layer:r,graphic:n,outFields:o,objectIds:a,returnGeometry:u,spatialReference:l}=e,s=a[0];if("number"!=typeof s&&"string"!=typeof s){const e="Could not query required fields for the specified feature. The feature's ID is invalid.",t={layer:r,graphic:n,objectId:s,requiredFields:o},a=new i("layer-query-features-invalid-objectid",e,t);throw c.warn(e,t),a}if("function"!=typeof r.queryFeatures){const e="The specified layer does not support the method 'queryFeatures'. The following fields will not be available.",t={layer:r,graphic:n,requiredFields:o},a=new i("layer-query-features-unsupported",e,t);throw c.warn(e,t),a}const f=r.createQuery();f.objectIds=a,f.outFields=o,f.returnGeometry=!!u,f.outSpatialReference=l;return(await r.queryFeatures(f,t)).features[0]}async function ee({graphic:e,popupTemplate:t,layer:r,spatialReference:n},i){if(!r||!t)return;const{returnGeometry:a}=t;"function"==typeof r.load&&await r.load(i);const u=e.attributes[r.objectIdField];if(null==u)return;const l=[u],s=await t.getRequiredFields(r.fields),f=o.featureHasFields(s,e),c=f?[]:s;if(f&&!a)return;const d=await Z({layer:r,graphic:e,outFields:c,objectIds:l,returnGeometry:a,spatialReference:n},i);d&&(d.geometry&&(e.geometry=d.geometry),d.attributes&&(e.attributes={...e.attributes,...d.attributes}))}function te(e=""){return!!e&&-1!==e.indexOf(I)}function re(e){return e?`${I}${e.layerId}/${e.fieldName}`:""}function ne({attributes:e,graphic:t,relatedInfo:r}){e&&t&&r&&Object.keys(t.attributes).forEach((n=>{const i=re({layerId:r.relation.id.toString(),fieldName:n});e[i]=t.attributes[n]}))}function ie(e,t){e&&t&&(t.relatedFeatures&&t.relatedFeatures&&t.relatedFeatures.forEach((r=>ne({attributes:e,graphic:r,relatedInfo:t}))),t.relatedStatsFeatures&&t.relatedStatsFeatures&&t.relatedStatsFeatures.forEach((r=>ne({attributes:e,graphic:r,relatedInfo:t}))))}e.applyTextFormattingHTML=W,e.createfieldInfoMap=B,e.fixTokens=G,e.formatAttributes=Y,e.formatEditInfo=z,e.formatValueToFieldInfo=P,e.getAllFieldInfos=J,e.getFieldInfo=_,e.getFieldInfoLabel=A,e.getFixedFieldName=E,e.getFixedFieldNames=q,e.getSourceLayer=w,e.graphicCallback=L,e.htmlEntities=K,e.isExpressionField=T,e.isRelatedField=te,e.queryUpdatedFeature=ee,e.shouldOpenInNewTab=v,e.substituteAttributes=R,e.substituteFieldsInLinksAndAttributes=O,Object.defineProperty(e,"__esModule",{value:!0})}));
