/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["require","exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/Logger","../../../core/promiseUtils","../../../layers/FeatureLayer","./featureUtils"],(function(e,t,r,a,i,n,s){"use strict";const o=["$datastore","$map","$layer","$aggregatedfeatures"],c="esri.widgets.Feature.support.arcadeFeatureUtils",p=a.getLogger(c);function l(e){return`<ul class="esri-widget__list">${e.map((e=>`<li>${"string"==typeof e?s.applyTextFormattingHTML(s.htmlEntities(e)):e}</li>`)).join("")}</ul>`}function u(e){return`<table class="esri-widget__table">${e.keys().map((t=>{const r=e.field(t);return`<tr><th>${t}</th><td>${"string"==typeof r?s.applyTextFormattingHTML(s.htmlEntities(r)):r}</td></tr>`})).join("")}</table>`}function y({aggregatedFeatures:e,arcadeUtils:t,featureSetVars:r,context:a,viewInfo:i,map:s,graphic:o,interceptor:c}){r.forEach((r=>{const p=r.toLowerCase(),l={map:s,spatialReference:i.sr,interceptor:c};if("$map"===p&&(a.vars[p]=t.convertMapToFeatureSetCollection(l)),"$layer"===p&&(a.vars[p]=t.convertFeatureLayerToFeatureSet({layer:o.sourceLayer,spatialReference:i.sr,interceptor:c})),"$datastore"===p&&(a.vars[p]=t.convertServiceUrlToWorkspace({url:o.sourceLayer.url,spatialReference:i.sr,interceptor:c})),"$aggregatedfeatures"===p){const r=o.layer,{fields:s,objectIdField:l,geometryType:u,spatialReference:y,displayField:f}=r,d=new n({fields:s,objectIdField:l,geometryType:u,spatialReference:y,displayField:f,..."feature"===r.type?{templates:r.templates,typeIdField:r.typeIdField,types:r.types}:null,source:e});a.vars[p]=t.convertFeatureLayerToFeatureSet({layer:d,spatialReference:i.sr,interceptor:c})}}))}function f(){return new Promise((function(t,r){e(["../../../support/arcadeUtils"],t,r)}))}function d(e){return g.apply(this,arguments)}function g(){return(g=r._asyncToGenerator((function*({graphic:e,view:t}){const{isAggregate:r,layer:a}=e;if(!r||!a||"2d"!==(null==t?void 0:t.type))return[];const i=yield t.whenLayerView(a);if(!i.createQuery||!i.queryFeatures)return[];const n=i.createQuery();n.aggregateIds=[e.getObjectId()];const{features:s}=yield i.queryFeatures(n);return s}))).apply(this,arguments)}function h(e){return m.apply(this,arguments)}function m(){return(m=r._asyncToGenerator((function*({expressionAttributes:e,info:t,arcadeUtils:r,interceptor:a,spatialReference:i,map:n,graphic:c,view:f}){const g=`expression/${t.name}`,h=r.createSyntaxTree(t.expression),m=o.filter((e=>r.hasVariable(h,e)));yield r.loadScriptDependencies(h,!0,m);const F=r.getViewInfo({spatialReference:i}),v=r.createExecContext(c,F);v.interceptor=a,v.useAsync=!0;y({aggregatedFeatures:yield d({graphic:c,view:f}),arcadeUtils:r,featureSetVars:m,context:v,viewInfo:F,map:n,graphic:c,interceptor:a});const x=r.createFunction(h,v),w=yield r.executeAsyncFunction(x,v).catch((e=>p.error("arcade-execution-error",{error:e,graphic:c,expressionInfo:t})));e[g]="string"==typeof w?s.applyTextFormattingHTML(s.htmlEntities(w)):Array.isArray(w)?l(w):w&&"esri.arcade.Dictionary"===w.declaredClass?u(w):w}))).apply(this,arguments)}function F(e){return v.apply(this,arguments)}function v(){return(v=r._asyncToGenerator((function*({popupTemplate:e,spatialReference:t,graphic:r,interceptor:a,map:n,view:s}){const o=e.expressionInfos,c=[],p={};if(!o||!o.length)return p;const l=yield f();for(const i of o)c.push(h({expressionAttributes:p,info:i,arcadeUtils:l,interceptor:a,spatialReference:t,map:n,graphic:r,view:s}));return yield i.eachAlways(c),p}))).apply(this,arguments)}t.createCompiledExpressions=F,Object.defineProperty(t,"__esModule",{value:!0})}));
