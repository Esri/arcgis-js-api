/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["require","exports","../../../core/Logger","../../../core/promiseUtils","../../../layers/FeatureLayer","./featureUtils"],(function(e,t,r,a,s,i){"use strict";const n=["$datastore","$map","$layer","$aggregatedfeatures"],o="esri.widgets.Feature.support.arcadeFeatureUtils",c=r.getLogger(o);function p(e){return`<ul class="esri-widget__list">${e.map((e=>`<li>${"string"==typeof e?i.applyTextFormattingHTML(i.htmlEntities(e)):e}</li>`)).join("")}</ul>`}function l(e){return`<table class="esri-widget__table">${e.keys().map((t=>{const r=e.field(t);return`<tr><th>${t}</th><td>${"string"==typeof r?i.applyTextFormattingHTML(i.htmlEntities(r)):r}</td></tr>`})).join("")}</table>`}function u({aggregatedFeatures:e,arcadeUtils:t,featureSetVars:r,context:a,viewInfo:i,map:n,graphic:o}){r.forEach((r=>{const c=r.toLowerCase(),p={map:n,spatialReference:i.sr};if("$map"===c&&(a.vars[c]=t.convertMapToFeatureSetCollection(p)),"$layer"===c&&(a.vars[c]=t.convertFeatureLayerToFeatureSet(o.sourceLayer,i.sr)),"$datastore"===c&&(a.vars[c]=t.convertServiceUrlToWorkspace(o.sourceLayer.url,i.sr)),"$aggregatedfeatures"===c){const r=o.layer,{fields:n,objectIdField:p,geometryType:l,spatialReference:u,displayField:d}=r,f=new s({fields:n,objectIdField:p,geometryType:l,spatialReference:u,displayField:d,..."feature"===r.type?{templates:r.templates,typeIdField:r.typeIdField,types:r.types}:null,source:e});a.vars[c]=t.convertFeatureLayerToFeatureSet(f,i.sr)}}))}function d(){return new Promise((function(t,r){e(["../../../support/arcadeUtils"],t,r)}))}async function f({graphic:e,view:t}){const{isAggregate:r,layer:a}=e;if(!r||!a||"2d"!==(null==t?void 0:t.type))return[];const s=await t.whenLayerView(a);if(!s.createQuery||!s.queryFeatures)return[];const i=s.createQuery();i.aggregateIds=[e.getObjectId()];const{features:n}=await s.queryFeatures(i);return n}async function g({expressionAttributes:e,info:t,arcadeUtils:r,spatialReference:a,map:s,graphic:o,view:d}){const g=`expression/${t.name}`,y=r.createSyntaxTree(t.expression),m=n.filter((e=>r.hasVariable(y,e)));await r.loadScriptDependencies(y,!0,m);const w=r.getViewInfo({spatialReference:a}),F=r.createExecContext(o,w);F.useAsync=!0;u({aggregatedFeatures:await f({graphic:o,view:d}),arcadeUtils:r,featureSetVars:m,context:F,viewInfo:w,map:s,graphic:o});const h=r.createFunction(y,F),v=await r.executeAsyncFunction(h,F).catch((e=>c.error("arcade-execution-error",{error:e,graphic:o,expressionInfo:t})));e[g]="string"==typeof v?i.applyTextFormattingHTML(i.htmlEntities(v)):Array.isArray(v)?p(v):v&&"esri.arcade.Dictionary"===v.declaredClass?l(v):v}async function y({popupTemplate:e,spatialReference:t,graphic:r,map:s,view:i}){const n=e.expressionInfos,o=[],c={};if(!n||!n.length)return c;const p=await d();for(const a of n)o.push(g({expressionAttributes:c,info:a,arcadeUtils:p,spatialReference:t,map:s,graphic:r,view:i}));return await a.eachAlways(o),c}t.createFormattedExpressions=y,Object.defineProperty(t,"__esModule",{value:!0})}));
