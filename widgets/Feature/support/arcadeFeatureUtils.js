/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["require","exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/Logger","../../../core/promiseUtils","../../../layers/FeatureLayer","./featureUtils"],(function(e,t,r,a,i,s,n){"use strict";const o=["$datastore","$map","$layer","$aggregatedfeatures"],c="esri.widgets.Feature.support.arcadeFeatureUtils",l=a.getLogger(c);function p(e){return`<ul class="esri-widget__list">${e.map((e=>`<li>${"string"==typeof e?n.applyTextFormattingHTML(n.htmlEntities(e)):e}</li>`)).join("")}</ul>`}function u(e){return`<table class="esri-widget__table">${e.keys().map((t=>{const r=e.field(t);return`<tr><th>${t}</th><td>${"string"==typeof r?n.applyTextFormattingHTML(n.htmlEntities(r)):r}</td></tr>`})).join("")}</table>`}function y({aggregatedFeatures:e,arcadeUtils:t,featureSetVars:r,context:a,viewInfo:i,map:n,graphic:o}){r.forEach((r=>{const c=r.toLowerCase(),l={map:n,spatialReference:i.sr};if("$map"===c&&(a.vars[c]=t.convertMapToFeatureSetCollection(l)),"$layer"===c&&(a.vars[c]=t.convertFeatureLayerToFeatureSet(o.sourceLayer,i.sr)),"$datastore"===c&&(a.vars[c]=t.convertServiceUrlToWorkspace(o.sourceLayer.url,i.sr)),"$aggregatedfeatures"===c){const r=o.layer,{fields:n,objectIdField:l,geometryType:p,spatialReference:u,displayField:y}=r,d=new s({fields:n,objectIdField:l,geometryType:p,spatialReference:u,displayField:y,..."feature"===r.type?{templates:r.templates,typeIdField:r.typeIdField,types:r.types}:null,source:e});a.vars[c]=t.convertFeatureLayerToFeatureSet(d,i.sr)}}))}function d(){return new Promise((function(t,r){e(["../../../support/arcadeUtils"],t,r)}))}function f(e){return g.apply(this,arguments)}function g(){return(g=r._asyncToGenerator((function*({graphic:e,view:t}){const{isAggregate:r,layer:a}=e;if(!r||!a||"2d"!==(null==t?void 0:t.type))return[];const i=yield t.whenLayerView(a);if(!i.createQuery||!i.queryFeatures)return[];const s=i.createQuery();s.aggregateIds=[e.getObjectId()];const{features:n}=yield i.queryFeatures(s);return n}))).apply(this,arguments)}function h(e){return m.apply(this,arguments)}function m(){return(m=r._asyncToGenerator((function*({expressionAttributes:e,info:t,arcadeUtils:r,spatialReference:a,map:i,graphic:s,view:c}){const d=`expression/${t.name}`,g=r.createSyntaxTree(t.expression),h=o.filter((e=>r.hasVariable(g,e)));yield r.loadScriptDependencies(g,!0,h);const m=r.getViewInfo({spatialReference:a}),F=r.createExecContext(s,m);F.useAsync=!0;y({aggregatedFeatures:yield f({graphic:s,view:c}),arcadeUtils:r,featureSetVars:h,context:F,viewInfo:m,map:i,graphic:s});const v=r.createFunction(g,F),x=yield r.executeAsyncFunction(v,F).catch((e=>l.error("arcade-execution-error",{error:e,graphic:s,expressionInfo:t})));e[d]="string"==typeof x?n.applyTextFormattingHTML(n.htmlEntities(x)):Array.isArray(x)?p(x):x&&"esri.arcade.Dictionary"===x.declaredClass?u(x):x}))).apply(this,arguments)}function F(e){return v.apply(this,arguments)}function v(){return(v=r._asyncToGenerator((function*({popupTemplate:e,spatialReference:t,graphic:r,map:a,view:s}){const n=e.expressionInfos,o=[],c={};if(!n||!n.length)return c;const l=yield d();for(const i of n)o.push(h({expressionAttributes:c,info:i,arcadeUtils:l,spatialReference:t,map:a,graphic:r,view:s}));return yield i.eachAlways(o),c}))).apply(this,arguments)}t.createCompiledExpressions=F,Object.defineProperty(t,"__esModule",{value:!0})}));
