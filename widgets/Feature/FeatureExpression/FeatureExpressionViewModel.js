/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../Graphic","../../../core/Accessor","../../../core/HandleOwner","../../../core/reactiveUtils","../../../core/throttle","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../../popup/content/AttachmentsContent","../../../popup/content/Content","../../../popup/content/CustomContent","../../../popup/content/ExpressionContent","../../../popup/content/FieldsContent","../../../popup/content/MediaContent","../../../popup/content/RelationshipContent","../../../popup/content/TextContent","../../../popup/ElementExpressionInfo","../FeatureContent/FeatureContentViewModel","../FeatureFields/FeatureFieldsViewModel","../FeatureMedia/FeatureMediaViewModel","../support/arcadeFeatureUtils"],(function(e,t,o,n,r,l,i,p,s,c,a,d,u,_,y,m,f,h,w,C,E,v,b,M){"use strict";const x=1;let F=function(t){function o(o){var n;return(n=t.call(this,o)||this)._abortController=null,n.expressionInfo=null,n.graphic=null,n.contentElement=null,n.contentElementViewModel=null,n.interceptor=null,n.view=null,n._cancelQuery=()=>{const{_abortController:t}=e._assertThisInitialized(n);t&&t.abort(),n._abortController=null},n._createVM=()=>{const e=n.contentElement?.type;n.contentElementViewModel?.destroy();const t="fields"===e?new v:"media"===e?new b:"text"===e?new E:null;n._set("contentElementViewModel",t)},n._compile=e._asyncToGenerator((function*(){n._cancelQuery();const e=new AbortController;n._abortController=e,yield n._compileExpression(),n._abortController===e&&(n._abortController=null)})),n._compileThrottled=i.throttle(n._compile,x,e._assertThisInitialized(n)),n._compileExpression=e._asyncToGenerator((function*(){const{expressionInfo:t,graphic:o,interceptor:r,spatialReference:l,map:i,view:p,_abortController:s}=e._assertThisInitialized(n);if(!(t&&o&&l&&i))return void n._set("contentElement",null);const c=yield M.loadArcadeUtils();if(s!==n._abortController)return;const a=yield M.createCompiledExpression({arcadeUtils:c,expressionInfo:t,graphic:o,interceptor:r,map:i,spatialReference:l,view:p});if(!a||"esri.arcade.Dictionary"!==a.declaredClass)return void n._set("contentElement",null);const d=yield a.castAsJsonAsync(s.signal),u=d?.type,_="media"===u?f.fromJSON(d):"text"===u?w.fromJSON(d):"fields"===u?m.fromJSON(d):null;n._set("contentElement",_)})),n.handles.add([l.watch((()=>[n.expressionInfo,n.graphic,n.map,n.spatialReference,n.view]),(()=>n._compileThrottled()),l.initial),l.watch((()=>[n.contentElement]),(()=>n._createVM()),l.initial)]),n}return e._inheritsLoose(o,t),o.prototype.destroy=function(){this._cancelQuery(),this.contentElementViewModel?.destroy(),this._set("contentElementViewModel",null),this._set("contentElement",null)},e._createClass(o,[{key:"spatialReference",get:function(){return this.view?.spatialReference??null},set:function(e){this._override("spatialReference",e)}},{key:"state",get:function(){const{_abortController:e,contentElement:t,contentElementViewModel:o}=this;return e?"loading":t||o?"ready":"disabled"}},{key:"map",get:function(){return this.view?.map??null},set:function(e){this._override("map",e)}}]),o}(r.HandleOwnerMixin(n));t.__decorate([p.property()],F.prototype,"_abortController",void 0),t.__decorate([p.property({type:C})],F.prototype,"expressionInfo",void 0),t.__decorate([p.property({type:o})],F.prototype,"graphic",void 0),t.__decorate([p.property({readOnly:!0})],F.prototype,"contentElement",void 0),t.__decorate([p.property({readOnly:!0})],F.prototype,"contentElementViewModel",void 0),t.__decorate([p.property()],F.prototype,"interceptor",void 0),t.__decorate([p.property()],F.prototype,"spatialReference",null),t.__decorate([p.property({readOnly:!0})],F.prototype,"state",null),t.__decorate([p.property()],F.prototype,"map",null),t.__decorate([p.property()],F.prototype,"view",void 0),F=t.__decorate([a.subclass("esri.widgets.Feature.FeatureExpression.FeatureExpressionViewModel")],F);return F}));
