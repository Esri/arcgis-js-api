/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import t from"../../../Graphic.js";import{d as o}from"../../../chunks/languageUtils.js";import r from"../../../core/Accessor.js";import{HandleOwnerMixin as n}from"../../../core/HandleOwner.js";import{watch as s,initial as i}from"../../../core/reactiveUtils.js";import{throttle as l}from"../../../core/throttle.js";import{property as p}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/arrayUtils.js";import"../../../core/has.js";import"../../../core/accessorSupport/ensureType.js";import{subclass as a}from"../../../core/accessorSupport/decorators/subclass.js";import"../../../popup/content/AttachmentsContent.js";import"../../../popup/content/Content.js";import"../../../popup/content/CustomContent.js";import"../../../popup/content/ExpressionContent.js";import c from"../../../popup/content/FieldsContent.js";import m from"../../../popup/content/MediaContent.js";import d from"../../../popup/content/TextContent.js";import h from"../../../popup/ElementExpressionInfo.js";import u from"../FeatureContent/FeatureContentViewModel.js";import f from"../FeatureFields/FeatureFieldsViewModel.js";import _ from"../FeatureMedia/FeatureMediaViewModel.js";import{loadArcadeUtils as y,createCompiledExpression as w}from"../support/arcadeFeatureUtils.js";const j=1;let v=class extends(n(r)){constructor(e){super(e),this._abortController=null,this.expressionInfo=null,this.graphic=null,this.contentElement=null,this.contentElementViewModel=null,this.interceptor=null,this.view=null,this._cancelQuery=()=>{const{_abortController:e}=this;e&&e.abort(),this._abortController=null},this._createVM=()=>{const e=this.contentElement?.type;this.contentElementViewModel?.destroy();const t="fields"===e?new f:"media"===e?new _:"text"===e?new u:null;this._set("contentElementViewModel",t)},this._compile=async()=>{this._cancelQuery();const e=new AbortController;this._abortController=e,await this._compileExpression(),this._abortController===e&&(this._abortController=null)},this._compileThrottled=l(this._compile,j,this),this._compileExpression=async()=>{const{expressionInfo:e,graphic:t,interceptor:r,spatialReference:n,map:s,view:i,_abortController:l}=this;if(!(e&&t&&n&&s))return void this._set("contentElement",null);const p=await y();if(l!==this._abortController)return;const a=await w({arcadeUtils:p,expressionInfo:e,graphic:t,interceptor:r,map:s,spatialReference:n,view:i});if(!a||"esri.arcade.Dictionary"!==a.declaredClass)return void this._set("contentElement",null);const h=await o(a,l.signal),u=h?.type,f="media"===u?m.fromJSON(h):"text"===u?d.fromJSON(h):"fields"===u?c.fromJSON(h):null;this._set("contentElement",f)},this.handles.add([s((()=>[this.expressionInfo,this.graphic,this.map,this.spatialReference,this.view]),(()=>this._compileThrottled()),i),s((()=>[this.contentElement]),(()=>this._createVM()),i)])}destroy(){this._cancelQuery(),this.contentElementViewModel?.destroy(),this._set("contentElementViewModel",null),this._set("contentElement",null)}get spatialReference(){return this.view?.spatialReference||null}set spatialReference(e){void 0!==e?this._override("spatialReference",e):this._clearOverride("spatialReference")}get state(){const{_abortController:e,contentElement:t,contentElementViewModel:o}=this;return e?"loading":t||o?"ready":"disabled"}get map(){return this.view?.map||null}set map(e){void 0!==e?this._override("map",e):this._clearOverride("map")}};e([p()],v.prototype,"_abortController",void 0),e([p({type:h})],v.prototype,"expressionInfo",void 0),e([p({type:t})],v.prototype,"graphic",void 0),e([p({readOnly:!0})],v.prototype,"contentElement",void 0),e([p({readOnly:!0})],v.prototype,"contentElementViewModel",void 0),e([p()],v.prototype,"interceptor",void 0),e([p()],v.prototype,"spatialReference",null),e([p({readOnly:!0})],v.prototype,"state",null),e([p()],v.prototype,"map",null),e([p()],v.prototype,"view",void 0),v=e([a("esri.widgets.Feature.FeatureExpression.FeatureExpressionViewModel")],v);const E=v;export{E as default};
