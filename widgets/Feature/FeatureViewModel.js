// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../Graphic","../../core/Accessor","../../core/Handles","../../core/Logger","../../core/promiseUtils","../../core/throttle","../../core/watchUtils","../../core/accessorSupport/decorators","../../popup/content/TextContent","../Attachments/AttachmentsViewModel","./FeatureContent/FeatureContentViewModel","./FeatureFields/FeatureFieldsViewModel","./FeatureMedia/FeatureMediaViewModel","./support/arcadeFeatureUtils","./support/featureUtils","./support/relatedFeatureUtils"],(function(e,t,r,o,i,n,a,p,l,s,c,u,d,f,h,_,y,g,m){"use strict";var v=a.getLogger("esri.widgets.FeatureViewModel");return function(e){function t(t){var r=e.call(this,t)||this;return r._handles=new n,r._featureAbortController=null,r._graphicChangedThrottled=l.throttle(r._graphicChanged,1,r),r.content=null,r.contentViewModels=[],r.defaultPopupTemplateEnabled=!1,r.formattedAttributes=null,r.lastEditInfo=null,r.relatedInfos=new Map,r.title="",r.view=null,r._handles.add(s.init(r,["graphic","_effectivePopupTemplate"],(function(){return r._graphicChangedThrottled()}))),r}return r.__extends(t,e),t.prototype.destroy=function(){this._clear(),this._cancelFeatureQuery(),this._handles.destroy(),this._handles=null,this.graphic=null,this._destroyContentViewModels(),this.relatedInfos.clear()},Object.defineProperty(t.prototype,"_effectivePopupTemplate",{get:function(){var e;return(null===(e=this.graphic)||void 0===e?void 0:e.getEffectivePopupTemplate(this.defaultPopupTemplateEnabled))||null},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"_fieldInfoMap",{get:function(){return g.createfieldInfoMap(g.getAllFieldInfos(this._effectivePopupTemplate),this._sourceLayer)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"_sourceLayer",{get:function(){return g.getSourceLayer(this.graphic)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"graphic",{set:function(e){this._set("graphic",e?e.clone():null)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"spatialReference",{get:function(){return this.get("view.spatialReference")||null},set:function(e){void 0!==e?this._override("spatialReference",e):this._clearOverride("spatialReference")},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"map",{get:function(){return this.get("view.map")||null},set:function(e){void 0!==e?this._override("map",e):this._clearOverride("map")},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"waitingForContent",{get:function(){return!!this._featureAbortController},enumerable:!1,configurable:!0}),t.prototype.setActiveMedia=function(e,t){var r=this.contentViewModels[e];r instanceof _&&r.setActiveMedia(t)},t.prototype.nextMedia=function(e){var t=this.contentViewModels[e];t instanceof _&&t.next()},t.prototype.previousMedia=function(e){var t=this.contentViewModels[e];t instanceof _&&t.previous()},t.prototype._clear=function(){this._set("title",""),this._set("content",null),this._set("formattedAttributes",null)},t.prototype._graphicChanged=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t,o;return r.__generator(this,(function(r){switch(r.label){case 0:if(this._cancelFeatureQuery(),this._clear(),!(e=this.graphic))return[2];t=p.createAbortController(),this._featureAbortController=t,r.label=1;case 1:return r.trys.push([1,3,,4]),[4,this._queryFeature({signal:t.signal})];case 2:return r.sent(),[3,4];case 3:return o=r.sent(),v.error("error","error loading popupTemplate for graphic",{error:o,graphic:e}),[3,4];case 4:return this._featureAbortController===t&&(this._featureAbortController=null),[2]}}))}))},t.prototype._cancelFeatureQuery=function(){var e=this._featureAbortController;e&&e.abort(),this._featureAbortController=null},t.prototype._compileContent=function(e){var t=this;if(this._destroyContentViewModels(),this.graphic)return Array.isArray(e)?e.map((function(e,r){return"attachments"===e.type?t._compileAttachments(e,r):"custom"===e.type?t._compileCustom(e,r):"fields"===e.type?t._compileFields(e,r):"media"===e.type?t._compileMedia(e,r):"text"===e.type?t._compileText(e,r):void 0})):"string"==typeof e?this._compileText(new u({text:e}),0).text:e},t.prototype._destroyContentViewModels=function(){this.contentViewModels.forEach((function(e){return e&&!e.destroyed&&e.destroy()})),this._set("contentViewModels",[])},t.prototype._compileAttachments=function(e,t){var r=this.graphic;return this.contentViewModels[t]=new d({graphic:r}),e},t.prototype._compileCustom=function(e,t){var r=this.graphic,o=e.creator,i=e.destroyer;return this.contentViewModels[t]=new f({graphic:r,creator:o,destroyer:i}),e},t.prototype._compileFields=function(e,t){var o=this._effectivePopupTemplate,i=this.formattedAttributes,n=e.clone(),a=(null==e?void 0:e.fieldInfos)||(null==o?void 0:o.fieldInfos),p=null==o?void 0:o.expressionInfos,l=r.__assign(r.__assign({},i.global),i.content[t]),s=new h({attributes:l,expressionInfos:p,fieldInfos:a});return this.contentViewModels[t]=s,n.fieldInfos=s.formattedFieldInfos.slice(0),n},t.prototype._compileMedia=function(e,t){var r=this,o=r.graphic,i=r._fieldInfoMap,n=r._effectivePopupTemplate,a=r.relatedInfos,p=r._sourceLayer,l=o.attributes,s=this.formattedAttributes.global,c=e.clone(),u=c.mediaInfos,d=new _({activeMediaInfoIndex:c.activeMediaInfoIndex||0,attributes:l,layer:p,fieldInfoMap:i,formattedAttributes:s,mediaInfos:u,popupTemplate:n,relatedInfos:a});return c.mediaInfos=d.formattedMediaInfos.slice(0),this.contentViewModels[t]=d,c},t.prototype._compileText=function(e,t){var o=e.clone(),i=this.graphic,n=this._fieldInfoMap,a=this._sourceLayer;if(o&&o.text){var p=i.attributes,l=this.formattedAttributes.global,s=g.processFieldsInLinks(o.text,r.__assign(r.__assign({},l),p),a);o.text=g.substituteAttributes({formattedAttributes:l,template:s,fieldInfoMap:n})}return this.contentViewModels[t]=new f({graphic:i,creator:o.text}),o},t.prototype._compileLastEditInfo=function(){var e=this._effectivePopupTemplate,t=this._sourceLayer,r=this.graphic;if(e){var o=e.lastEditInfoEnabled,i=null==t?void 0:t.editFieldsInfo;if(o&&i)return g.formatEditInfo(i,r.attributes)}},t.prototype._compileTitle=function(e){var t=this._fieldInfoMap,o=this._sourceLayer,i=this.graphic.attributes,n=this.formattedAttributes.global;if(e){var a=g.processFieldsInLinks(e,r.__assign(r.__assign({},n),i),o);return g.substituteAttributes({formattedAttributes:n,template:a,fieldInfoMap:t})}return""},t.prototype._getTitle=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t,o,i;return r.__generator(this,(function(r){return t=(e=this)._effectivePopupTemplate,o=e.graphic,i=null==t?void 0:t.title,[2,g.graphicCallback(i,{graphic:o})]}))}))},t.prototype._getContent=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t,o,i;return r.__generator(this,(function(r){return t=(e=this)._effectivePopupTemplate,o=e.graphic,i=null==t?void 0:t.content,[2,g.graphicCallback(i,{graphic:o})]}))}))},t.prototype._queryFeature=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,o,i,n,a,l,s,c,u,d,f;return r.__generator(this,(function(r){switch(r.label){case 0:return o=(t=this)._featureAbortController,i=t._sourceLayer,n=t.graphic,a=t._effectivePopupTemplate,l=t.spatialReference,s=t.map,[4,p.eachAlways({content:this._getContent(),title:this._getTitle()})];case 1:return c=r.sent(),u=c.content.value,d=c.title.value,o===this._featureAbortController&&n?[4,p.eachAlways({checkForRelatedFeatures:this._checkForRelatedFeatures(e),expressionAttributes:y.createFormattedExpressions({popupTemplate:this._effectivePopupTemplate,spatialReference:l,graphic:n,map:s}),queryRequiredFields:g.queryRequiredFields({graphic:n,popupTemplate:a,layer:i},e)})]:[2];case 2:return f=r.sent().expressionAttributes.value,o===this._featureAbortController&&n?(this._set("formattedAttributes",this._createFormattedAttributes(u,f)),this._set("title",this._compileTitle(d)),this._set("lastEditInfo",this._compileLastEditInfo()||null),this._set("content",this._compileContent(u)||null),[2]):[2]}}))}))},t.prototype._createFormattedAttributes=function(e,t){var o=this,i=o._effectivePopupTemplate,n=o.graphic,a=o.relatedInfos,p=o._sourceLayer,l=o._fieldInfoMap,s=null==i?void 0:i.fieldInfos,c=r.__assign(r.__assign({},n.attributes),t),u={global:g.formatAttributes({fieldInfos:s,graphic:n,attributes:c,layer:p,fieldInfoMap:l,relatedInfos:a}),content:[]};return Array.isArray(e)&&e.forEach((function(e,t){"fields"===e.type&&e.fieldInfos&&(u.content[t]=g.formatAttributes({fieldInfos:e.fieldInfos,graphic:n,attributes:c,layer:p,fieldInfoMap:l,relatedInfos:a}))})),u},t.prototype._checkForRelatedFeatures=function(e){var t=this.graphic,r=this._effectivePopupTemplate;return this._queryRelatedInfos(t,g.getAllFieldInfos(r),e)},t.prototype._queryRelatedInfos=function(e,t,o){return r.__awaiter(this,void 0,void 0,(function(){var i,n,a,p,l,s,c=this;return r.__generator(this,(function(r){switch(r.label){case 0:return n=(i=this).relatedInfos,a=i._sourceLayer,n.clear(),a?(p=t.filter((function(e){return e&&g.isRelatedField(e.fieldName)})))&&p.length?(t.forEach((function(e){return c._configureRelatedInfo(e,a)})),[4,m.queryLayerInfos({relatedInfos:n,layer:a},o)]):[2]:[2];case 1:return l=r.sent(),Object.keys(l).forEach((function(e){var t,r=n.get(e.toString()),o=null===(t=l[e])||void 0===t?void 0:t.value;r&&o&&(r.layerInfo=o.data)})),[4,m.queryRelatedFeatures({graphic:e,relatedInfos:n,layer:a},o)];case 2:return s=r.sent(),Object.keys(s).forEach((function(e){var t;m.setRelatedFeatures(null===(t=s[e])||void 0===t?void 0:t.value,n.get(e.toString()))})),[2]}}))}))},t.prototype._configureRelatedInfo=function(e,t){var r=this.relatedInfos,o=m.getRelatedFieldInfo(e.fieldName);if(o){var i=o.layerId,n=o.fieldName;if(i){var a=r.get(i.toString())||m.createRelatedInfo(i,t);a&&(m.updateRelatedInfo({relatedInfo:a,fieldName:n,fieldInfo:e}),this.relatedInfos.set(i,a))}}},r.__decorate([c.property()],t.prototype,"_featureAbortController",void 0),r.__decorate([c.property({readOnly:!0,dependsOn:["graphic","graphic.sourceLayer.popupTemplate","graphic.sourceLayer.popupTemplate.title","graphic.sourceLayer.popupTemplate.content","graphic.sourceLayer.popupTemplate.expressionInfos","graphic.sourceLayer.popupTemplate.fieldInfos","graphic.sourceLayer.popupTemplate.lastEditInfoEnabled","graphic.sourceLayer.popupTemplate.outFields","graphic.sourceLayer.popupTemplate.relatedRecordsInfo","graphic.popupTemplate","graphic.popupTemplate.title","graphic.popupTemplate.content","graphic.popupTemplate.expressionInfos","graphic.popupTemplate.fieldInfos","graphic.popupTemplate.lastEditInfoEnabled","graphic.popupTemplate.outFields","graphic.popupTemplate.relatedRecordsInfo","defaultPopupTemplateEnabled"]})],t.prototype,"_effectivePopupTemplate",null),r.__decorate([c.property({readOnly:!0,dependsOn:["_effectivePopupTemplate","_sourceLayer"]})],t.prototype,"_fieldInfoMap",null),r.__decorate([c.property({readOnly:!0,dependsOn:["graphic.layer","graphic.sourceLayer"]})],t.prototype,"_sourceLayer",null),r.__decorate([c.property({readOnly:!0})],t.prototype,"content",void 0),r.__decorate([c.property({readOnly:!0})],t.prototype,"contentViewModels",void 0),r.__decorate([c.property({type:Boolean})],t.prototype,"defaultPopupTemplateEnabled",void 0),r.__decorate([c.property({readOnly:!0})],t.prototype,"formattedAttributes",void 0),r.__decorate([c.property({type:o,value:null})],t.prototype,"graphic",null),r.__decorate([c.property({readOnly:!0})],t.prototype,"lastEditInfo",void 0),r.__decorate([c.property()],t.prototype,"relatedInfos",void 0),r.__decorate([c.property({dependsOn:["view"]})],t.prototype,"spatialReference",null),r.__decorate([c.property({readOnly:!0})],t.prototype,"title",void 0),r.__decorate([c.property({dependsOn:["view"]})],t.prototype,"map",null),r.__decorate([c.property({readOnly:!0,dependsOn:["_featureAbortController"]})],t.prototype,"waitingForContent",null),r.__decorate([c.property()],t.prototype,"view",void 0),t=r.__decorate([c.subclass("esri.widgets.FeatureViewModel")],t)}(i)}));