/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/has","../../core/maybe","../../core/Logger","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/subclass","../../core/urlUtils","../../core/uuid","../../portal/support/resourceExtension","../../core/promiseUtils","../../core/Accessor","../../popup/content/TextContent","../../Graphic","../../core/Handles","../../core/watchUtils","../../core/throttle","./support/featureUtils","./FeatureAttachments/FeatureAttachmentsViewModel","./FeatureContent/FeatureContentViewModel","./FeatureFields/FeatureFieldsViewModel","./support/relatedFeatureUtils","./FeatureMedia/FeatureMediaViewModel","./support/arcadeFeatureUtils"],(function(e,t,r,o,i,n,a,s,l,c,p,u,d,f,h,_,y,g,m,b,I,v,A,M,w){"use strict";const F=1,T="esri.widgets.FeatureViewModel",C=i.getLogger(T);let x=function(t){function r(r){var o;return(o=t.call(this,r)||this)._handles=new _,o._featureAbortController=null,o.graphicChangedThrottled=g.throttle(o.graphicChanged,F,e._assertThisInitialized(o)),o.content=null,o.contentViewModels=[],o.defaultPopupTemplateEnabled=!1,o.formattedAttributes=null,o.lastEditInfo=null,o.relatedInfos=new Map,o.title="",o.view=null,o._handles.add(y.init(e._assertThisInitialized(o),["graphic","_effectivePopupTemplate"],(()=>o.graphicChangedThrottled()))),o}e._inheritsLoose(r,t);var i=r.prototype;return i.destroy=function(){this._clear(),this._cancelFeatureQuery(),this._handles.destroy(),this._handles=null,this.graphic=null,this._destroyContentViewModels(),this.relatedInfos.clear()},i.setActiveMedia=function(e,t){const r=this.contentViewModels[e];r instanceof M&&r.setActiveMedia(t)},i.nextMedia=function(e){const t=this.contentViewModels[e];t instanceof M&&t.next()},i.previousMedia=function(e){const t=this.contentViewModels[e];t instanceof M&&t.previous()},i._clear=function(){this._set("title",""),this._set("content",null),this._set("formattedAttributes",null)},i.graphicChanged=async function(){this._cancelFeatureQuery(),this._clear();const{graphic:e}=this;if(!e)return;const t=u.createAbortController();this._featureAbortController=t;try{await this._queryFeature({signal:t.signal})}catch(r){C.error("error","error loading popupTemplate for graphic",{error:r,graphic:e})}this._featureAbortController===t&&(this._featureAbortController=null)},i._cancelFeatureQuery=function(){const{_featureAbortController:e}=this;e&&e.abort(),this._featureAbortController=null},i._compileContent=function(e){if(this._destroyContentViewModels(),this.graphic)return Array.isArray(e)?e.map(((e,t)=>"attachments"===e.type?this._compileAttachments(e,t):"custom"===e.type?this._compileCustom(e,t):"fields"===e.type?this._compileFields(e,t):"media"===e.type?this._compileMedia(e,t):"text"===e.type?this._compileText(e,t):void 0)):"string"==typeof e?this._compileText(new f({text:e}),0).text:e},i._destroyContentViewModels=function(){this.contentViewModels.forEach((e=>e&&!e.destroyed&&e.destroy())),this._set("contentViewModels",[])},i._compileAttachments=function(e,t){const{graphic:r}=this,{description:o,title:i}=e;return this.contentViewModels[t]=new b({graphic:r,...this._compileTitleAndDesc({title:i,description:o})}),e},i._compileCustom=function(e,t){const{graphic:r}=this,{creator:o,destroyer:i}=e;return this.contentViewModels[t]=new I({graphic:r,creator:o,destroyer:i}),e},i._compileTitleAndDesc=function({title:e,description:t}){const{_fieldInfoMap:r,_sourceLayer:o,graphic:i,formattedAttributes:n}=this,{attributes:a}=i,s=n.global;return{title:m.substituteFieldsInLinksAndAttributes({attributes:a,fieldInfoMap:r,globalAttributes:s,layer:o,text:e}),description:m.substituteFieldsInLinksAndAttributes({attributes:a,fieldInfoMap:r,globalAttributes:s,layer:o,text:t})}},i._compileFields=function(e,t){const{_effectivePopupTemplate:r,formattedAttributes:o}=this,i=e.clone(),n=(null==e?void 0:e.fieldInfos)||(null==r?void 0:r.fieldInfos),a=null==r?void 0:r.expressionInfos,s={...o.global,...o.content[t]},{description:l,title:c}=i,p=new v({attributes:s,expressionInfos:a,fieldInfos:n,...this._compileTitleAndDesc({title:c,description:l})});return this.contentViewModels[t]=p,i.fieldInfos=p.formattedFieldInfos.slice(0),i},i._compileMedia=function(e,t){const{graphic:r,_fieldInfoMap:o,_effectivePopupTemplate:i,relatedInfos:n,_sourceLayer:a}=this,{attributes:s}=r,l=this.formattedAttributes.global,c=e.clone(),{description:p,mediaInfos:u,title:d}=c,f=new M({activeMediaInfoIndex:c.activeMediaInfoIndex||0,attributes:s,layer:a,fieldInfoMap:o,formattedAttributes:l,mediaInfos:u,popupTemplate:i,relatedInfos:n,...this._compileTitleAndDesc({title:d,description:p})});return c.mediaInfos=f.formattedMediaInfos.slice(0),this.contentViewModels[t]=f,c},i._compileText=function(e,t){const r=e.clone(),{graphic:o,_fieldInfoMap:i,_sourceLayer:n}=this;if(r&&r.text){const{attributes:e}=o,t=this.formattedAttributes.global;r.text=m.substituteFieldsInLinksAndAttributes({attributes:e,fieldInfoMap:i,globalAttributes:t,layer:n,text:r.text})}return this.contentViewModels[t]=new I({graphic:o,creator:r.text}),r},i._compileLastEditInfo=function(){const{_effectivePopupTemplate:e,_sourceLayer:t,graphic:r}=this;if(!e)return;const{lastEditInfoEnabled:o}=e,i=null==t?void 0:t.editFieldsInfo;return o&&i?m.formatEditInfo(i,r.attributes):void 0},i._compileTitle=function(e){const{_fieldInfoMap:t,_sourceLayer:r,graphic:o}=this,{attributes:i}=o,n=this.formattedAttributes.global;return m.substituteFieldsInLinksAndAttributes({attributes:i,fieldInfoMap:t,globalAttributes:n,layer:r,text:e})},i._getTitle=async function(){const{_effectivePopupTemplate:e,graphic:t}=this,r=null==e?void 0:e.title;return m.graphicCallback(r,{graphic:t})},i._getContent=async function(){const{_effectivePopupTemplate:e,graphic:t}=this,r=null==e?void 0:e.content;return m.graphicCallback(r,{graphic:t})},i._queryFeature=async function(e){const{_featureAbortController:t,_sourceLayer:r,graphic:o,_effectivePopupTemplate:i,spatialReference:n,map:a,view:s}=this,{content:{value:l},title:{value:c}}=await u.eachAlways({content:this._getContent(),title:this._getTitle()});if(t!==this._featureAbortController||!o)return;const{expressionAttributes:{value:p}}=await u.eachAlways({checkForRelatedFeatures:this._checkForRelatedFeatures(e),expressionAttributes:w.createFormattedExpressions({popupTemplate:this._effectivePopupTemplate,spatialReference:n,graphic:o,map:a,view:s}),queryUpdatedFeature:m.queryUpdatedFeature({graphic:o,popupTemplate:i,layer:r,spatialReference:n},e)});t===this._featureAbortController&&o&&(this._set("formattedAttributes",this._createFormattedAttributes(l,p)),this._set("title",this._compileTitle(c)),this._set("lastEditInfo",this._compileLastEditInfo()||null),this._set("content",this._compileContent(l)||null))},i._createFormattedAttributes=function(e,t){const{_effectivePopupTemplate:r,graphic:o,relatedInfos:i,_sourceLayer:n,_fieldInfoMap:a}=this,s=null==r?void 0:r.fieldInfos,l={...o.attributes,...t},c={global:m.formatAttributes({fieldInfos:s,graphic:o,attributes:l,layer:n,fieldInfoMap:a,relatedInfos:i}),content:[]};return Array.isArray(e)&&e.forEach(((e,t)=>{"fields"===e.type&&e.fieldInfos&&(c.content[t]=m.formatAttributes({fieldInfos:e.fieldInfos,graphic:o,attributes:l,layer:n,fieldInfoMap:a,relatedInfos:i}))})),c},i._checkForRelatedFeatures=function(e){const{graphic:t,_effectivePopupTemplate:r}=this;return this._queryRelatedInfos(t,m.getAllFieldInfos(r),e)},i._queryRelatedInfos=async function(e,t,r){const{relatedInfos:i,_sourceLayer:n}=this;i.clear();const a=o.isSome(n.associatedLayer)?await n.associatedLayer.load(r):n;if(!a)return;const s=t.filter((e=>e&&m.isRelatedField(e.fieldName)));if(!s||!s.length)return;t.forEach((e=>this._configureRelatedInfo(e,a)));const l=await A.queryLayerInfos({relatedInfos:i,layer:a},r);Object.keys(l).forEach((e=>{var t;const r=i.get(e.toString()),o=null==(t=l[e])?void 0:t.value;r&&o&&(r.layerInfo=o.data)}));const c=await A.queryRelatedFeatures({graphic:e,relatedInfos:i,layer:a},r);Object.keys(c).forEach((e=>{var t;A.setRelatedFeatures(null==(t=c[e])?void 0:t.value,i.get(e.toString()))}))},i._configureRelatedInfo=function(e,t){const{relatedInfos:r}=this,o=A.getRelatedFieldInfo(e.fieldName);if(!o)return;const{layerId:i,fieldName:n}=o;if(!i)return;const a=r.get(i.toString())||A.createRelatedInfo(i,t);a&&(A.updateRelatedInfo({relatedInfo:a,fieldName:n,fieldInfo:e}),this.relatedInfos.set(i,a))},e._createClass(r,[{key:"_effectivePopupTemplate",get:function(){return o.isSome(this.graphic)?this.graphic.getEffectivePopupTemplate(this.defaultPopupTemplateEnabled):null}},{key:"_fieldInfoMap",get:function(){return m.createfieldInfoMap(m.getAllFieldInfos(this._effectivePopupTemplate),this._sourceLayer)}},{key:"_sourceLayer",get:function(){return m.getSourceLayer(this.graphic)}},{key:"graphic",set:function(e){this._set("graphic",e?e.clone():null)}},{key:"spatialReference",get:function(){return this.get("view.spatialReference")||null},set:function(e){void 0!==e?this._override("spatialReference",e):this._clearOverride("spatialReference")}},{key:"map",get:function(){return this.get("view.map")||null},set:function(e){void 0!==e?this._override("map",e):this._clearOverride("map")}},{key:"waitingForContent",get:function(){return!!this._featureAbortController}}]),r}(d);return t.__decorate([a.property()],x.prototype,"_featureAbortController",void 0),t.__decorate([a.property({readOnly:!0})],x.prototype,"_effectivePopupTemplate",null),t.__decorate([a.property({readOnly:!0})],x.prototype,"_fieldInfoMap",null),t.__decorate([a.property({readOnly:!0})],x.prototype,"_sourceLayer",null),t.__decorate([a.property({readOnly:!0})],x.prototype,"content",void 0),t.__decorate([a.property({readOnly:!0})],x.prototype,"contentViewModels",void 0),t.__decorate([a.property({type:Boolean})],x.prototype,"defaultPopupTemplateEnabled",void 0),t.__decorate([a.property({readOnly:!0})],x.prototype,"formattedAttributes",void 0),t.__decorate([a.property({type:h,value:null})],x.prototype,"graphic",null),t.__decorate([a.property({readOnly:!0})],x.prototype,"lastEditInfo",void 0),t.__decorate([a.property()],x.prototype,"relatedInfos",void 0),t.__decorate([a.property()],x.prototype,"spatialReference",null),t.__decorate([a.property({readOnly:!0})],x.prototype,"title",void 0),t.__decorate([a.property()],x.prototype,"map",null),t.__decorate([a.property({readOnly:!0})],x.prototype,"waitingForContent",null),t.__decorate([a.property()],x.prototype,"view",void 0),x=t.__decorate([s.subclass(T)],x),x}));
