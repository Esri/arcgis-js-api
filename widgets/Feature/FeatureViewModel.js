/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../Graphic","../../arcade/featureset/support/FeatureSetQueryInterceptor","../../core/Accessor","../../core/Handles","../../core/Logger","../../core/maybe","../../core/promiseUtils","../../core/throttle","../../core/watchUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/accessorSupport/decorators/cast","../../core/accessorSupport/decorators/subclass","../../popup/content/TextContent","./FeatureAttachments/FeatureAttachmentsViewModel","./FeatureContent/FeatureContentViewModel","./FeatureFields/FeatureFieldsViewModel","./FeatureMedia/FeatureMediaViewModel","./support/arcadeFeatureUtils","./support/featureUtils","./support/relatedFeatureUtils"],(function(e,t,r,o,i,n,s,a,l,c,p,u,d,f,h,_,y,b,m,g,I,A,v){"use strict";var C;const T=1,M="esri.widgets.FeatureViewModel",F=s.getLogger(M),w={attachmentsContent:!0,customContent:!0,fieldsContent:!0,mediaContent:!0,textContent:!0};let x=C=function(t){function r(r){var o;return(o=t.call(this,r)||this)._handles=new n,o._error=null,o._featureAbortController=null,o.graphicChangedThrottled=c.throttle(o.graphicChanged,T,e._assertThisInitialized(o)),o._expressionAttributes=null,o.abilities={...w},o.content=null,o.contentViewModels=[],o.defaultPopupTemplateEnabled=!1,o.formattedAttributes=null,o.lastEditInfo=null,o.relatedInfos=new Map,o.title="",o.view=null,o._isAllowedContentType=t=>{const{abilities:r}=e._assertThisInitialized(o);return"attachments"===t.type&&r.attachmentsContent||"custom"===t.type&&r.customContent||"fields"===t.type&&r.fieldsContent||"media"===t.type&&r.mediaContent||"text"===t.type&&r.textContent},o._handles.add(p.init(e._assertThisInitialized(o),["graphic","_effectivePopupTemplate","abilities"],(()=>o.graphicChangedThrottled()))),o}e._inheritsLoose(r,t);var o=r.prototype;return o.destroy=function(){this._clear(),this._cancelFeatureQuery(),this._error=null,this._handles.destroy(),this._handles=null,this.graphic=null,this._destroyContentViewModels(),this.relatedInfos.clear()},o.castAbilities=function(e){return{...w,...e}},o.setActiveMedia=function(e,t){const r=this.contentViewModels[e];r instanceof g&&r.setActiveMedia(t)},o.nextMedia=function(e){const t=this.contentViewModels[e];t instanceof g&&t.next()},o.previousMedia=function(e){const t=this.contentViewModels[e];t instanceof g&&t.previous()},o._clear=function(){this._set("title",""),this._set("content",null),this._set("formattedAttributes",null)},o.graphicChanged=function(){var t=e._asyncToGenerator((function*(){this._cancelFeatureQuery(),this._error=null,this._clear();const{graphic:e}=this;if(!e)return;const t=l.createAbortController();this._featureAbortController=t;try{yield this._queryFeature({signal:t.signal})}catch(r){this._error=r,F.error("error","The popupTemplate could not be displayed for this feature.",{error:r,graphic:e,popupTemplate:this._effectivePopupTemplate})}this._featureAbortController===t&&(this._featureAbortController=null)}));function r(){return t.apply(this,arguments)}return r}(),o._cancelFeatureQuery=function(){const{_featureAbortController:e}=this;e&&e.abort(),this._featureAbortController=null},o._compileContent=function(e){if(this._destroyContentViewModels(),this.graphic)return Array.isArray(e)?e.filter(this._isAllowedContentType).map(((e,t)=>"attachments"===e.type?this._compileAttachments(e,t):"custom"===e.type?this._compileCustom(e,t):"fields"===e.type?this._compileFields(e,t):"media"===e.type?this._compileMedia(e,t):"text"===e.type?this._compileText(e,t):void 0)):"string"==typeof e?this._compileText(new _({text:e}),0).text:e},o._destroyContentViewModels=function(){this.contentViewModels.forEach((e=>e&&!e.destroyed&&e.destroy())),this._set("contentViewModels",[])},o._compileAttachments=function(e,t){const{graphic:r}=this,{description:o,title:i}=e;return this.contentViewModels[t]=new y({graphic:r,...this._compileTitleAndDesc({title:i,description:o})}),e},o._compileCustom=function(e,t){const{graphic:r}=this,{creator:o,destroyer:i}=e;return this.contentViewModels[t]=new b({graphic:r,creator:o,destroyer:i}),e},o._compileTitleAndDesc=function({title:e,description:t}){const{_fieldInfoMap:r,_sourceLayer:o,graphic:i,formattedAttributes:n,_expressionAttributes:s}=this,{attributes:a}=i,l=n.global;return{title:A.substituteFieldsInLinksAndAttributes({attributes:a,fieldInfoMap:r,globalAttributes:l,expressionAttributes:s,layer:o,text:e}),description:A.substituteFieldsInLinksAndAttributes({attributes:a,fieldInfoMap:r,globalAttributes:l,expressionAttributes:s,layer:o,text:t})}},o._compileFields=function(e,t){const{_effectivePopupTemplate:r,formattedAttributes:o}=this,i=e.clone(),n=(null==e?void 0:e.fieldInfos)||(null==r?void 0:r.fieldInfos),s=null==r?void 0:r.expressionInfos,a={...o.global,...o.content[t]},{description:l,title:c}=i,p=new m({attributes:a,expressionInfos:s,fieldInfos:n,...this._compileTitleAndDesc({title:c,description:l})});return this.contentViewModels[t]=p,i.fieldInfos=p.formattedFieldInfos.slice(0),i},o._compileMedia=function(e,t){const{graphic:r,_fieldInfoMap:o,_effectivePopupTemplate:i,relatedInfos:n,_sourceLayer:s,_expressionAttributes:a}=this,{attributes:l}=r,c=this.formattedAttributes.global,p=e.clone(),{description:u,mediaInfos:d,title:f}=p,h=new g({activeMediaInfoIndex:p.activeMediaInfoIndex||0,attributes:l,layer:s,fieldInfoMap:o,formattedAttributes:c,expressionAttributes:a,mediaInfos:d,popupTemplate:i,relatedInfos:n,...this._compileTitleAndDesc({title:f,description:u})});return p.mediaInfos=h.formattedMediaInfos.slice(0),this.contentViewModels[t]=h,p},o._compileText=function(e,t){const r=e.clone(),{graphic:o,_fieldInfoMap:i,_sourceLayer:n,_expressionAttributes:s}=this;if(r&&r.text){const{attributes:e}=o,t=this.formattedAttributes.global;r.text=A.substituteFieldsInLinksAndAttributes({attributes:e,fieldInfoMap:i,globalAttributes:t,expressionAttributes:s,layer:n,text:r.text})}return this.contentViewModels[t]=new b({graphic:o,creator:r.text}),r},o._compileLastEditInfo=function(){const{_effectivePopupTemplate:e,_sourceLayer:t,graphic:r}=this;if(!e)return;const{lastEditInfoEnabled:o}=e,i=null==t?void 0:t.editFieldsInfo;return o&&i?A.formatEditInfo(i,r.attributes):void 0},o._compileTitle=function(e){const{_fieldInfoMap:t,_sourceLayer:r,graphic:o,_expressionAttributes:i}=this,{attributes:n}=o,s=this.formattedAttributes.global;return A.substituteFieldsInLinksAndAttributes({attributes:n,fieldInfoMap:t,globalAttributes:s,expressionAttributes:i,layer:r,text:e})},o._getTitle=function(){var t=e._asyncToGenerator((function*(){const{_effectivePopupTemplate:e,graphic:t}=this,r=null==e?void 0:e.title;return A.graphicCallback(r,{graphic:t})}));function r(){return t.apply(this,arguments)}return r}(),o._getContent=function(){var t=e._asyncToGenerator((function*(){const{_effectivePopupTemplate:e,graphic:t}=this,r=null==e?void 0:e.content;return A.graphicCallback(r,{graphic:t})}));function r(){return t.apply(this,arguments)}return r}(),o._queryFeature=function(){var t=e._asyncToGenerator((function*(e){const{_featureAbortController:t,_sourceLayer:r,graphic:o,_effectivePopupTemplate:i,spatialReference:n,map:s,view:a}=this,{content:{value:c},title:{value:p}}=yield l.eachAlways({content:this._getContent(),title:this._getTitle()});if(t!==this._featureAbortController||!o)return;yield A.queryUpdatedFeature({graphic:o,popupTemplate:i,layer:r,spatialReference:n},e);const{expressionAttributes:{value:u}}=yield l.eachAlways({checkForRelatedFeatures:this._checkForRelatedFeatures(e),expressionAttributes:I.createCompiledExpressions({popupTemplate:this._effectivePopupTemplate,spatialReference:n,graphic:o,map:s,interceptor:C.interceptor,view:a})});t===this._featureAbortController&&o&&(this._expressionAttributes=u,this._set("formattedAttributes",this._createFormattedAttributes(c,u)),this._set("title",this._compileTitle(p)),this._set("lastEditInfo",this._compileLastEditInfo()||null),this._set("content",this._compileContent(c)||null))}));function r(e){return t.apply(this,arguments)}return r}(),o._createFormattedAttributes=function(e,t){const{_effectivePopupTemplate:r,graphic:o,relatedInfos:i,_sourceLayer:n,_fieldInfoMap:s}=this,a=null==r?void 0:r.fieldInfos,l={...o.attributes,...t},c={global:A.formatAttributes({fieldInfos:a,graphic:o,attributes:l,layer:n,fieldInfoMap:s,relatedInfos:i}),content:[]};return Array.isArray(e)&&e.forEach(((e,t)=>{"fields"===e.type&&e.fieldInfos&&(c.content[t]=A.formatAttributes({fieldInfos:e.fieldInfos,graphic:o,attributes:l,layer:n,fieldInfoMap:s,relatedInfos:i}))})),c},o._checkForRelatedFeatures=function(e){const{graphic:t,_effectivePopupTemplate:r}=this;return this._queryRelatedInfos(t,A.getAllFieldInfos(r),e)},o._queryRelatedInfos=function(){var t=e._asyncToGenerator((function*(e,t,r){const{relatedInfos:o,_sourceLayer:i}=this;o.clear();const n=a.isSome(i.associatedLayer)?yield i.associatedLayer.load(r):i;if(!n)return;const s=t.filter((e=>e&&A.isRelatedField(e.fieldName)));if(!s||!s.length)return;t.forEach((e=>this._configureRelatedInfo(e,n)));const l=yield v.queryLayerInfos({relatedInfos:o,layer:n},r);Object.keys(l).forEach((e=>{var t;const r=o.get(e.toString()),i=null==(t=l[e])?void 0:t.value;r&&i&&(r.layerInfo=i.data)}));const c=yield v.queryRelatedFeatures({graphic:e,relatedInfos:o,layer:n},r);Object.keys(c).forEach((e=>{var t;v.setRelatedFeatures(null==(t=c[e])?void 0:t.value,o.get(e.toString()))}))}));function r(e,r,o){return t.apply(this,arguments)}return r}(),o._configureRelatedInfo=function(e,t){const{relatedInfos:r}=this,o=v.getRelatedFieldInfo(e.fieldName);if(!o)return;const{layerId:i,fieldName:n}=o;if(!i)return;const s=r.get(i.toString())||v.createRelatedInfo(i,t);s&&(v.updateRelatedInfo({relatedInfo:s,fieldName:n,fieldInfo:e}),this.relatedInfos.set(i,s))},e._createClass(r,[{key:"_effectivePopupTemplate",get:function(){return a.isSome(this.graphic)?this.graphic.getEffectivePopupTemplate(this.defaultPopupTemplateEnabled):null}},{key:"_fieldInfoMap",get:function(){return A.createfieldInfoMap(A.getAllFieldInfos(this._effectivePopupTemplate),this._sourceLayer)}},{key:"_sourceLayer",get:function(){return A.getSourceLayer(this.graphic)}},{key:"state",get:function(){return this.graphic?this._error?"error":this.waitingForContent?"loading":"ready":"disabled"}},{key:"graphic",set:function(e){this._set("graphic",e?e.clone():null)}},{key:"spatialReference",get:function(){return this.get("view.spatialReference")||null},set:function(e){void 0!==e?this._override("spatialReference",e):this._clearOverride("spatialReference")}},{key:"map",get:function(){return this.get("view.map")||null},set:function(e){void 0!==e?this._override("map",e):this._clearOverride("map")}},{key:"waitingForContent",get:function(){return!!this._featureAbortController}}]),r}(i);return x.interceptor=new o.FeatureSetQueryInterceptor(A.preLayerQueryCallback,A.preRequestCallback),t.__decorate([u.property()],x.prototype,"_error",void 0),t.__decorate([u.property()],x.prototype,"_featureAbortController",void 0),t.__decorate([u.property({readOnly:!0})],x.prototype,"_effectivePopupTemplate",null),t.__decorate([u.property({readOnly:!0})],x.prototype,"_fieldInfoMap",null),t.__decorate([u.property({readOnly:!0})],x.prototype,"_sourceLayer",null),t.__decorate([u.property()],x.prototype,"abilities",void 0),t.__decorate([f.cast("abilities")],x.prototype,"castAbilities",null),t.__decorate([u.property({readOnly:!0})],x.prototype,"content",void 0),t.__decorate([u.property({readOnly:!0})],x.prototype,"contentViewModels",void 0),t.__decorate([u.property({type:Boolean})],x.prototype,"defaultPopupTemplateEnabled",void 0),t.__decorate([u.property({readOnly:!0})],x.prototype,"state",null),t.__decorate([u.property({readOnly:!0})],x.prototype,"formattedAttributes",void 0),t.__decorate([u.property({type:r,value:null})],x.prototype,"graphic",null),t.__decorate([u.property({readOnly:!0})],x.prototype,"lastEditInfo",void 0),t.__decorate([u.property()],x.prototype,"relatedInfos",void 0),t.__decorate([u.property()],x.prototype,"spatialReference",null),t.__decorate([u.property({readOnly:!0})],x.prototype,"title",void 0),t.__decorate([u.property()],x.prototype,"map",null),t.__decorate([u.property({readOnly:!0})],x.prototype,"waitingForContent",null),t.__decorate([u.property()],x.prototype,"view",void 0),x=C=t.__decorate([h.subclass(M)],x),x}));
