/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/has","../../core/maybe","../../core/Logger","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/subclass","../../core/urlUtils","../../core/uuid","../../portal/support/resourceExtension","../../core/promiseUtils","../../core/Accessor","../../popup/content/TextContent","../../Graphic","../../core/Handles","../../core/watchUtils","../../core/throttle","./support/featureUtils","../Attachments/AttachmentsViewModel","./FeatureContent/FeatureContentViewModel","./FeatureFields/FeatureFieldsViewModel","./support/relatedFeatureUtils","./FeatureMedia/FeatureMediaViewModel","./support/arcadeFeatureUtils"],(function(e,t,r,o,i,a,n,s,l,p,c,u,d,f,h,_,y,g,m,I,b,v,T,A,w){"use strict";const M="esri.widgets.FeatureViewModel",F=i.getLogger(M);let C=function(t){function r(r){var o;return(o=t.call(this,r)||this)._handles=new _,o._featureAbortController=null,o.graphicChangedThrottled=g.throttle(o.graphicChanged,1,e._assertThisInitialized(o)),o.content=null,o.contentViewModels=[],o.defaultPopupTemplateEnabled=!1,o.formattedAttributes=null,o.lastEditInfo=null,o.relatedInfos=new Map,o.title="",o.view=null,o._handles.add(y.init(e._assertThisInitialized(o),["graphic","_effectivePopupTemplate"],(()=>o.graphicChangedThrottled()))),o}e._inheritsLoose(r,t);var i=r.prototype;return i.destroy=function(){this._clear(),this._cancelFeatureQuery(),this._handles.destroy(),this._handles=null,this.graphic=null,this._destroyContentViewModels(),this.relatedInfos.clear()},i.setActiveMedia=function(e,t){const r=this.contentViewModels[e];r instanceof A&&r.setActiveMedia(t)},i.nextMedia=function(e){const t=this.contentViewModels[e];t instanceof A&&t.next()},i.previousMedia=function(e){const t=this.contentViewModels[e];t instanceof A&&t.previous()},i._clear=function(){this._set("title",""),this._set("content",null),this._set("formattedAttributes",null)},i.graphicChanged=async function(){this._cancelFeatureQuery(),this._clear();const{graphic:e}=this;if(!e)return;const t=u.createAbortController();this._featureAbortController=t;try{await this._queryFeature({signal:t.signal})}catch(t){F.error("error","error loading popupTemplate for graphic",{error:t,graphic:e})}this._featureAbortController===t&&(this._featureAbortController=null)},i._cancelFeatureQuery=function(){const{_featureAbortController:e}=this;e&&e.abort(),this._featureAbortController=null},i._compileContent=function(e){if(this._destroyContentViewModels(),this.graphic)return Array.isArray(e)?e.map(((e,t)=>"attachments"===e.type?this._compileAttachments(e,t):"custom"===e.type?this._compileCustom(e,t):"fields"===e.type?this._compileFields(e,t):"media"===e.type?this._compileMedia(e,t):"text"===e.type?this._compileText(e,t):void 0)):"string"==typeof e?this._compileText(new f({text:e}),0).text:e},i._destroyContentViewModels=function(){this.contentViewModels.forEach((e=>e&&!e.destroyed&&e.destroy())),this._set("contentViewModels",[])},i._compileAttachments=function(e,t){const{graphic:r}=this;return this.contentViewModels[t]=new I({graphic:r}),e},i._compileCustom=function(e,t){const{graphic:r}=this,{creator:o,destroyer:i}=e;return this.contentViewModels[t]=new b({graphic:r,creator:o,destroyer:i}),e},i._compileFields=function(e,t){const{_effectivePopupTemplate:r,formattedAttributes:o}=this,i=e.clone(),a=(null==e?void 0:e.fieldInfos)||(null==r?void 0:r.fieldInfos),n=null==r?void 0:r.expressionInfos,s={...o.global,...o.content[t]},l=new v({attributes:s,expressionInfos:n,fieldInfos:a});return this.contentViewModels[t]=l,i.fieldInfos=l.formattedFieldInfos.slice(0),i},i._compileMedia=function(e,t){const{graphic:r,_fieldInfoMap:o,_effectivePopupTemplate:i,relatedInfos:a,_sourceLayer:n}=this,{attributes:s}=r,l=this.formattedAttributes.global,p=e.clone(),{mediaInfos:c}=p,u=new A({activeMediaInfoIndex:p.activeMediaInfoIndex||0,attributes:s,layer:n,fieldInfoMap:o,formattedAttributes:l,mediaInfos:c,popupTemplate:i,relatedInfos:a});return p.mediaInfos=u.formattedMediaInfos.slice(0),this.contentViewModels[t]=u,p},i._compileText=function(e,t){const r=e.clone(),{graphic:o,_fieldInfoMap:i,_sourceLayer:a}=this;if(r&&r.text){const{attributes:e}=o,t=this.formattedAttributes.global,n=m.processFieldsInLinks(r.text,{...t,...e},a);r.text=m.substituteAttributes({formattedAttributes:t,template:n,fieldInfoMap:i})}return this.contentViewModels[t]=new b({graphic:o,creator:r.text}),r},i._compileLastEditInfo=function(){const{_effectivePopupTemplate:e,_sourceLayer:t,graphic:r}=this;if(!e)return;const{lastEditInfoEnabled:o}=e,i=null==t?void 0:t.editFieldsInfo;return o&&i?m.formatEditInfo(i,r.attributes):void 0},i._compileTitle=function(e){const{_fieldInfoMap:t,_sourceLayer:r,graphic:o}=this,{attributes:i}=o,a=this.formattedAttributes.global;if(e){const o=m.processFieldsInLinks(e,{...a,...i},r);return m.substituteAttributes({formattedAttributes:a,template:o,fieldInfoMap:t})}return""},i._getTitle=async function(){const{_effectivePopupTemplate:e,graphic:t}=this,r=null==e?void 0:e.title;return m.graphicCallback(r,{graphic:t})},i._getContent=async function(){const{_effectivePopupTemplate:e,graphic:t}=this,r=null==e?void 0:e.content;return m.graphicCallback(r,{graphic:t})},i._queryFeature=async function(e){const{_featureAbortController:t,_sourceLayer:r,graphic:o,_effectivePopupTemplate:i,spatialReference:a,map:n}=this,{content:{value:s},title:{value:l}}=await u.eachAlways({content:this._getContent(),title:this._getTitle()});if(t!==this._featureAbortController||!o)return;const{expressionAttributes:{value:p}}=await u.eachAlways({checkForRelatedFeatures:this._checkForRelatedFeatures(e),expressionAttributes:w.createFormattedExpressions({popupTemplate:this._effectivePopupTemplate,spatialReference:a,graphic:o,map:n}),queryUpdatedFeature:m.queryUpdatedFeature({graphic:o,popupTemplate:i,layer:r},e)});t===this._featureAbortController&&o&&(this._set("formattedAttributes",this._createFormattedAttributes(s,p)),this._set("title",this._compileTitle(l)),this._set("lastEditInfo",this._compileLastEditInfo()||null),this._set("content",this._compileContent(s)||null))},i._createFormattedAttributes=function(e,t){const{_effectivePopupTemplate:r,graphic:o,relatedInfos:i,_sourceLayer:a,_fieldInfoMap:n}=this,s=null==r?void 0:r.fieldInfos,l={...o.attributes,...t},p={global:m.formatAttributes({fieldInfos:s,graphic:o,attributes:l,layer:a,fieldInfoMap:n,relatedInfos:i}),content:[]};return Array.isArray(e)&&e.forEach(((e,t)=>{"fields"===e.type&&e.fieldInfos&&(p.content[t]=m.formatAttributes({fieldInfos:e.fieldInfos,graphic:o,attributes:l,layer:a,fieldInfoMap:n,relatedInfos:i}))})),p},i._checkForRelatedFeatures=function(e){const{graphic:t,_effectivePopupTemplate:r}=this;return this._queryRelatedInfos(t,m.getAllFieldInfos(r),e)},i._queryRelatedInfos=async function(e,t,r){const{relatedInfos:i,_sourceLayer:a}=this;i.clear();const n=o.isSome(a.associatedLayer)?await a.associatedLayer.load(r):a;if(!n)return;const s=t.filter((e=>e&&m.isRelatedField(e.fieldName)));if(!s||!s.length)return;t.forEach((e=>this._configureRelatedInfo(e,n)));const l=await T.queryLayerInfos({relatedInfos:i,layer:n},r);Object.keys(l).forEach((e=>{var t;const r=i.get(e.toString()),o=null==(t=l[e])?void 0:t.value;r&&o&&(r.layerInfo=o.data)}));const p=await T.queryRelatedFeatures({graphic:e,relatedInfos:i,layer:n},r);Object.keys(p).forEach((e=>{var t;T.setRelatedFeatures(null==(t=p[e])?void 0:t.value,i.get(e.toString()))}))},i._configureRelatedInfo=function(e,t){const{relatedInfos:r}=this,o=T.getRelatedFieldInfo(e.fieldName);if(!o)return;const{layerId:i,fieldName:a}=o;if(!i)return;const n=r.get(i.toString())||T.createRelatedInfo(i,t);n&&(T.updateRelatedInfo({relatedInfo:n,fieldName:a,fieldInfo:e}),this.relatedInfos.set(i,n))},e._createClass(r,[{key:"_effectivePopupTemplate",get:function(){return o.isSome(this.graphic)?this.graphic.getEffectivePopupTemplate(this.defaultPopupTemplateEnabled):null}},{key:"_fieldInfoMap",get:function(){return m.createfieldInfoMap(m.getAllFieldInfos(this._effectivePopupTemplate),this._sourceLayer)}},{key:"_sourceLayer",get:function(){return m.getSourceLayer(this.graphic)}},{key:"graphic",set:function(e){this._set("graphic",e?e.clone():null)}},{key:"spatialReference",get:function(){return this.get("view.spatialReference")||null},set:function(e){void 0!==e?this._override("spatialReference",e):this._clearOverride("spatialReference")}},{key:"map",get:function(){return this.get("view.map")||null},set:function(e){void 0!==e?this._override("map",e):this._clearOverride("map")}},{key:"waitingForContent",get:function(){return!!this._featureAbortController}}]),r}(d);return t.__decorate([n.property()],C.prototype,"_featureAbortController",void 0),t.__decorate([n.property({readOnly:!0,dependsOn:["graphic","graphic.sourceLayer.popupTemplate.title","graphic.sourceLayer.popupTemplate.content","graphic.sourceLayer.popupTemplate.expressionInfos","graphic.sourceLayer.popupTemplate.fieldInfos","graphic.sourceLayer.popupTemplate.lastEditInfoEnabled","graphic.sourceLayer.popupTemplate.outFields","graphic.sourceLayer.popupTemplate.relatedRecordsInfo","graphic.popupTemplate.title","graphic.popupTemplate.content","graphic.popupTemplate.expressionInfos","graphic.popupTemplate.fieldInfos","graphic.popupTemplate.lastEditInfoEnabled","graphic.popupTemplate.outFields","graphic.popupTemplate.relatedRecordsInfo","defaultPopupTemplateEnabled"]})],C.prototype,"_effectivePopupTemplate",null),t.__decorate([n.property({readOnly:!0,dependsOn:["_effectivePopupTemplate","_sourceLayer"]})],C.prototype,"_fieldInfoMap",null),t.__decorate([n.property({readOnly:!0,dependsOn:["graphic.layer","graphic.sourceLayer"]})],C.prototype,"_sourceLayer",null),t.__decorate([n.property({readOnly:!0})],C.prototype,"content",void 0),t.__decorate([n.property({readOnly:!0})],C.prototype,"contentViewModels",void 0),t.__decorate([n.property({type:Boolean})],C.prototype,"defaultPopupTemplateEnabled",void 0),t.__decorate([n.property({readOnly:!0})],C.prototype,"formattedAttributes",void 0),t.__decorate([n.property({type:h,value:null})],C.prototype,"graphic",null),t.__decorate([n.property({readOnly:!0})],C.prototype,"lastEditInfo",void 0),t.__decorate([n.property()],C.prototype,"relatedInfos",void 0),t.__decorate([n.property({dependsOn:["view"]})],C.prototype,"spatialReference",null),t.__decorate([n.property({readOnly:!0})],C.prototype,"title",void 0),t.__decorate([n.property({dependsOn:["view"]})],C.prototype,"map",null),t.__decorate([n.property({readOnly:!0,dependsOn:["_featureAbortController"]})],C.prototype,"waitingForContent",null),t.__decorate([n.property()],C.prototype,"view",void 0),C=t.__decorate([s.subclass(M)],C),C}));
