/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/events","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/accessorSupport/decorators/subclass","../../renderers/support/utils","../Widget","./FeatureMedia/FeatureMediaViewModel","./support/FeatureElementInfo","./support/featureUtils","../support/chartUtils","../support/widgetUtils","../support/decorators/messageBundle","../support/jsxFactory","../../support/themeUtils"],(function(e,t,i,r,o,n,s,a,l,d,c,u,p,h,m,f,_,v){"use strict";const M="esri-feature-media",y={base:M,mediaContainer:`${M}__container`,mediaItemContainer:`${M}__item-container`,mediaItem:`${M}__item`,mediaItemTitle:`${M}__item-title`,mediaItemCaption:`${M}__item-caption`,mediaPrevious:`${M}__previous`,mediaPreviousIconLTR:`${M}__previous-icon`,mediaPreviousIconRTL:`${M}__previous-icon--rtl`,mediaNext:`${M}__next`,mediaNextIconLTR:`${M}__next-icon`,mediaNextIconRTL:`${M}__next-icon--rtl`,mediaChart:`${M}__chart`,mediaButton:`${M}__button`,mediaIcon:`${M}__icon`,iconLeftTriangleArrow:"esri-icon-left-triangle-arrow",iconRightTriangleArrow:"esri-icon-right-triangle-arrow"},I=.05,g=.95,w=15,T="color",x="tooltip",C="value",b="default-line-value";let R=function(t){function o(i,r){var o;return(o=t.call(this,i,r)||this)._refreshTimer=null,o._refreshIntervalInfo=null,o._featureElementInfo=null,o.viewModel=new c,o.messages=null,o._getChartDependencies=function(){var t=e._asyncToGenerator((function*(t){const i=yield h.loadChartsModule(),{destroyed:r,viewModel:n}=e._assertThisInitialized(o);if(r||!n||!t)return;const{activeMediaInfo:s}=n,a=yield o._getRendererColors(i);o._renderChart({chartDiv:t,mediaInfo:s,chartsModule:i,colorMap:a})}));return function(e){return t.apply(this,arguments)}}(),o}e._inheritsLoose(o,t);var n=o.prototype;return n.initialize=function(){this._featureElementInfo=new u,this.addHandles([r.watch((()=>[this.viewModel?.activeMediaInfo,this.viewModel?.activeMediaInfoIndex]),(()=>this._setupMediaRefreshTimer()),r.initial),r.watch((()=>[this.viewModel?.description,this.viewModel?.title]),(()=>this._setupFeatureElementInfo()),r.initial)])},n.destroy=function(){this._clearMediaRefreshTimer(),this._featureElementInfo?.destroy()},n.render=function(){return _.tsx("div",{bind:this,class:y.base,onkeyup:this._handleMediaKeyup},this._featureElementInfo?.render(),this.renderMedia())},n.renderMedia=function(){const{formattedMediaInfoCount:e}=this.viewModel;return e?_.tsx("div",{key:"media-element-container",class:y.mediaContainer},this.renderMediaPageButton("previous"),this.renderMediaInfo(),this.renderMediaPageButton("next")):null},n.renderImageMediaInfo=function(e){const{_refreshIntervalInfo:t}=this,{activeMediaInfoIndex:i,formattedMediaInfoCount:r}=this.viewModel,{value:o,refreshInterval:n,altText:s,title:a,type:l}=e,{sourceURL:d,linkURL:c}=o,u=p.shouldOpenInNewTab(c??void 0)?"_blank":"_self",h="_blank"===u?"noreferrer":"",m=n?t:null,f=m?m.timestamp:0,v=m?m.sourceURL:d,M=_.tsx("img",{alt:s||a,key:`media-${l}-${i}-${r}-${f}`,src:v??void 0}),y=c?_.tsx("a",{title:a,href:c,rel:h,target:u},M):null;return y||M},n.renderChartMediaInfo=function(e){const{activeMediaInfoIndex:t,formattedMediaInfoCount:i}=this.viewModel;return _.tsx("div",{key:`media-${e.type}-${t}-${i}`,bind:this,class:y.mediaChart,afterCreate:this._getChartDependencies})},n.renderMediaInfoType=function(){const{activeMediaInfo:e}=this.viewModel;return e?"image"===e.type?this.renderImageMediaInfo(e):e.type.includes("chart")?this.renderChartMediaInfo(e):null:null},n.renderMediaInfo=function(){const{activeMediaInfo:e}=this.viewModel;if(!e)return null;const t=e.title?_.tsx("div",{key:"media-title",class:y.mediaItemTitle,innerHTML:e.title}):null,i=e.caption?_.tsx("div",{key:"media-caption",class:y.mediaItemCaption,innerHTML:e.caption}):null;return _.tsx("div",{key:"media-container",class:y.mediaItemContainer},_.tsx("div",{key:"media-item-container",class:y.mediaItem},this.renderMediaInfoType()),t,i)},n.renderMediaPageButton=function(e){if(this.viewModel.formattedMediaInfoCount<2)return null;const t="previous"===e,i=t?this.messages.previous:this.messages.next,r=t?this.classes(y.mediaButton,y.mediaPrevious):this.classes(y.mediaButton,y.mediaNext),o=t?this.classes(y.mediaIcon,y.mediaPreviousIconLTR,y.iconLeftTriangleArrow):this.classes(y.mediaIcon,y.mediaNextIconLTR,y.iconRightTriangleArrow),n=t?this.classes(y.mediaIcon,y.mediaPreviousIconRTL,y.iconRightTriangleArrow):this.classes(y.mediaIcon,y.mediaNextIconRTL,y.iconLeftTriangleArrow),s=t?"media-previous":"media-next",a=t?this._previous:this._next;return _.tsx("button",{type:"button",key:s,title:i,"aria-label":i,tabIndex:0,class:r,bind:this,onclick:a},_.tsx("span",{"aria-hidden":"true",class:o}),_.tsx("span",{"aria-hidden":"true",class:n}))},n._setupFeatureElementInfo=function(){const{description:e,title:t}=this;this._featureElementInfo?.set({description:e,title:t})},n._next=function(){this.viewModel.next()},n._previous=function(){this.viewModel.previous()},n._getRenderer=function(){const{isAggregate:e,layer:t}=this.viewModel;return e&&t?.featureReduction&&"renderer"in t.featureReduction?t.featureReduction.renderer:t?.renderer},n._getRendererColors=function(){var t=e._asyncToGenerator((function*(e){const{am4core:t}=e,i=new Map,r=this._getRenderer(),o="default";if(!r)return i;const n=yield l.getColorsFromRenderer(r);n.delete(o);return Array.from(n.values()).every((e=>1===e?.length))?(i.set(b,t.color({r:50,g:50,b:50,a:1})),Array.from(n.keys()).forEach((e=>{e&&i.set(e,t.color(n.get(e)?.[0].toCss(!0)))})),i):i}));function i(e){return t.apply(this,arguments)}return i}(),n._handleMediaKeyup=function(e){const t=i.eventKey(e);"ArrowLeft"===t&&(e.stopPropagation(),this.viewModel.previous()),"ArrowRight"===t&&(e.stopPropagation(),this.viewModel.next())},n._renderChart=function(e){const{abilities:t}=this.viewModel,{chartsModule:i,chartDiv:r,mediaInfo:o,colorMap:n}=e,{value:s,type:a}=o,{am4core:l}=i,d=h.getColorSet(l);function c(e){e instanceof l.ColorSet&&d&&(e.list=d)}v.isDarkTheme()&&l.useTheme(i.am4themes_dark);const u=window.matchMedia("(prefers-reduced-motion: reduce)");t.chartAnimation&&!u.matches?l.useTheme(i.am4themes_animated):l.unuseTheme(i.am4themes_animated),l.useTheme(c);const p="pie-chart"===a?this._createPieChart(e):this._createXYChart(e);r.setAttribute("aria-label",o.altText||o.title),p.data=s.series.map((e=>({[x]:e.tooltip,[C]:e.value,[T]:n.get(e.fieldName)}))).filter((e=>"pie-chart"!==a||null!=e.value&&e.value>0))},n._customizeChartTooltip=function(e,t){e&&(e.label.wrap=!0,e.label.maxWidth=200,e.autoTextColor=!1,e.getFillFromObject=!1,e.label.fill=t.color("#ffffff"),e.background.fill=t.color({r:0,g:0,b:0,a:.7}))},n._createPieChart=function(e){const{chartDiv:t,chartsModule:i}=e,{am4core:r,am4charts:o}=i,n=r.create(t,o.PieChart);n.rtl=m.isRTL(this.container);const s=n.series.push(new o.PieSeries);return s.labels.template.disabled=!0,s.ticks.template.disabled=!0,s.dataFields.value=C,s.dataFields.category=x,this._customizeChartTooltip(s.tooltip,r),s.slices.template.propertyFields.fill=T,s.slices.template.propertyFields.stroke=T,n},n._getMinSeriesValue=function(e){let t=0;return e.forEach((e=>t=Math.min(e.value,t))),t},n._createColumnChart=function(e,t){const{chartsModule:i,mediaInfo:r}=t,{value:o}=r,{am4core:n,am4charts:s}=i,a=e.xAxes.push(new s.CategoryAxis);a.dataFields.category=x,a.renderer.labels.template.disabled=!0;const l=a.tooltip;this._customizeChartTooltip(l,n),l.events.on("sizechanged",(()=>{l.dy=-l.contentHeight}));const d=e.yAxes.push(new s.ValueAxis),c=d.renderer.labels.template;d.renderer.minLabelPosition=I,d.renderer.maxLabelPosition=g,d.min=this._getMinSeriesValue(o.series),this._customizeChartTooltip(d.tooltip,n),c.wrap=!0;const u=e.series.push(new s.ColumnSeries);u.dataFields.valueY=C,u.dataFields.categoryX=x,u.columns.template.propertyFields.fill=T,u.columns.template.propertyFields.stroke=T,e.cursor=new s.XYCursor,o.series.length>w&&(e.scrollbarX=new n.Scrollbar)},n._createBarChart=function(e,t){const{chartsModule:i,mediaInfo:r}=t,{value:o}=r,{am4core:n,am4charts:s}=i,a=e.yAxes.push(new s.CategoryAxis);a.dataFields.category=x,a.renderer.inversed=!0,a.renderer.labels.template.disabled=!0;const l=a.tooltip;this._customizeChartTooltip(l,n),l.events.on("sizechanged",(()=>{l.dx=l.contentWidth}));const d=e.xAxes.push(new s.ValueAxis),c=d.renderer.labels.template;d.renderer.minLabelPosition=I,d.renderer.maxLabelPosition=g,d.min=this._getMinSeriesValue(o.series),this._customizeChartTooltip(d.tooltip,n),c.wrap=!0;const u=e.series.push(new s.ColumnSeries);u.dataFields.valueX=C,u.dataFields.categoryY=x,u.columns.template.propertyFields.fill=T,u.columns.template.propertyFields.stroke=T,e.cursor=new s.XYCursor,o.series.length>w&&(e.scrollbarY=new n.Scrollbar)},n._createLineChart=function(e,t){const{chartsModule:i,mediaInfo:r,colorMap:o}=t,{value:n}=r,{am4core:s,am4charts:a}=i,l=e.xAxes.push(new a.CategoryAxis);l.dataFields.category=x,l.renderer.labels.template.disabled=!0;const d=l.tooltip;this._customizeChartTooltip(d,s),d.events.on("sizechanged",(()=>{d.dy=-d.contentHeight}));const c=e.yAxes.push(new a.ValueAxis),u=c.renderer.labels.template;c.renderer.minLabelPosition=I,c.renderer.maxLabelPosition=g,c.min=this._getMinSeriesValue(n.series),this._customizeChartTooltip(c.tooltip,s),u.wrap=!0;const p=e.series.push(new a.LineSeries);p.dataFields.categoryX=x,p.dataFields.valueY=C,p.strokeWidth=1;const h=o.get(b);h&&(p.stroke=h);const m=p.bullets.push(new a.CircleBullet);m.propertyFields.fill=T,m.propertyFields.stroke=T,e.cursor=new a.XYCursor,n.series.length>w&&(e.scrollbarX=new s.Scrollbar)},n._createXYChart=function(e){const{chartDiv:t,chartsModule:i,mediaInfo:r}=e,{type:o}=r,{am4core:n,am4charts:s}=i,a=n.create(t,s.XYChart);return a.rtl=m.isRTL(this.container),"column-chart"===o&&this._createColumnChart(a,e),"bar-chart"===o&&this._createBarChart(a,e),"line-chart"===o&&this._createLineChart(a,e),a},n._clearMediaRefreshTimer=function(){const{_refreshTimer:e}=this;e&&(clearTimeout(e),this._refreshTimer=null)},n._updateMediaInfoTimestamp=function(e){const t=Date.now();this._refreshIntervalInfo={timestamp:t,sourceURL:e&&this._getImageSource(e,t)},this.scheduleRender()},n._setupMediaRefreshTimer=function(){this._clearMediaRefreshTimer();const{activeMediaInfo:e}=this.viewModel;e&&"image"===e.type&&e.refreshInterval&&this._setRefreshTimeout(e)},n._setRefreshTimeout=function(e){const{refreshInterval:t,value:i}=e;if(!t)return;const r=6e4*t;this._updateMediaInfoTimestamp(i.sourceURL);const o=setInterval((()=>{this._updateMediaInfoTimestamp(i.sourceURL)}),r);this._refreshTimer=o},n._getImageSource=function(e,t){const i=e.includes("?")?"&":"?",[r,o=""]=e.split("#");return`${r}${i}timestamp=${t}${o?"#":""}${o}`},e._createClass(o,[{key:"attributes",get:function(){return this.viewModel.attributes},set:function(e){this.viewModel.attributes=e}},{key:"activeMediaInfoIndex",get:function(){return this.viewModel.activeMediaInfoIndex},set:function(e){this.viewModel.activeMediaInfoIndex=e}},{key:"description",get:function(){return this.viewModel.description},set:function(e){this.viewModel.description=e}},{key:"fieldInfoMap",get:function(){return this.viewModel.fieldInfoMap},set:function(e){this.viewModel.fieldInfoMap=e}},{key:"layer",get:function(){return this.viewModel.layer},set:function(e){this.viewModel.layer=e}},{key:"mediaInfos",get:function(){return this.viewModel.mediaInfos},set:function(e){this.viewModel.mediaInfos=e}},{key:"popupTemplate",get:function(){return this.viewModel.popupTemplate},set:function(e){this.viewModel.popupTemplate=e}},{key:"relatedInfos",get:function(){return this.viewModel.relatedInfos},set:function(e){this.viewModel.relatedInfos=e}},{key:"title",get:function(){return this.viewModel.title},set:function(e){this.viewModel.title=e}}]),o}(d);t.__decorate([o.property()],R.prototype,"attributes",null),t.__decorate([o.property()],R.prototype,"activeMediaInfoIndex",null),t.__decorate([o.property()],R.prototype,"description",null),t.__decorate([o.property()],R.prototype,"fieldInfoMap",null),t.__decorate([o.property()],R.prototype,"layer",null),t.__decorate([o.property()],R.prototype,"mediaInfos",null),t.__decorate([o.property()],R.prototype,"popupTemplate",null),t.__decorate([o.property()],R.prototype,"relatedInfos",null),t.__decorate([o.property()],R.prototype,"title",null),t.__decorate([o.property({type:c})],R.prototype,"viewModel",void 0),t.__decorate([o.property(),f.messageBundle("esri/widgets/Feature/t9n/Feature")],R.prototype,"messages",void 0),R=t.__decorate([a.subclass("esri.widgets.Feature.FeatureMedia")],R);return R}));
