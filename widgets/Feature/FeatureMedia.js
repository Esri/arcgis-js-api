/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/events","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/arrayUtils","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass","../../renderers/support/utils","../Widget","./FeatureMedia/FeatureMediaViewModel","./support/FeatureElementInfo","./support/featureUtils","../support/chartUtils","../support/widgetUtils","../support/decorators/messageBundle","../support/jsxFactory","../../support/themeUtils"],(function(e,t,i,r,o,a,n,s,l,d,c,u,p,h,m,f,_,v){"use strict";const M={base:"esri-feature-media",mediaContainer:"esri-feature-media__container",mediaItemContainer:"esri-feature-media__item-container",mediaItem:"esri-feature-media__item",mediaItemTitle:"esri-feature-media__item-title",mediaItemCaption:"esri-feature-media__item-caption",mediaPrevious:"esri-feature-media__previous",mediaPreviousIconLTR:"esri-feature-media__previous-icon",mediaPreviousIconRTL:"esri-feature-media__previous-icon--rtl",mediaNext:"esri-feature-media__next",mediaNextIconLTR:"esri-feature-media__next-icon",mediaNextIconRTL:"esri-feature-media__next-icon--rtl",mediaChart:"esri-feature-media__chart",mediaButton:"esri-feature-media__button",mediaIcon:"esri-feature-media__icon",iconLeftTriangleArrow:"esri-icon-left-triangle-arrow",iconRightTriangleArrow:"esri-icon-right-triangle-arrow"},y=.05,I=.95,g=15,w="color",T="tooltip",x="value",C="default-line-value";let b=function(t){function o(i,r){var o;return(o=t.call(this,i,r)||this)._refreshTimer=null,o._refreshIntervalInfo=null,o._featureElementInfo=null,o.viewModel=new c,o.messages=null,o._getChartDependencies=function(){var t=e._asyncToGenerator((function*(t){const i=yield h.loadChartsModule(),{destroyed:r,viewModel:a}=e._assertThisInitialized(o);if(r||!a||!t)return;const{activeMediaInfo:n}=a,s=yield o._getRendererColors(i);o._renderChart({chartDiv:t,mediaInfo:n,chartsModule:i,colorMap:s})}));return function(e){return t.apply(this,arguments)}}(),o}e._inheritsLoose(o,t);var a=o.prototype;return a.initialize=function(){this._featureElementInfo=new u,this.addHandles([r.watch((()=>[this.viewModel?.activeMediaInfo,this.viewModel?.activeMediaInfoIndex]),(()=>this._setupMediaRefreshTimer()),r.initial),r.watch((()=>[this.viewModel?.description,this.viewModel?.title]),(()=>this._setupFeatureElementInfo()),r.initial)])},a.destroy=function(){this._clearMediaRefreshTimer(),this._featureElementInfo.destroy()},a.render=function(){return _.tsx("div",{bind:this,class:M.base,onkeyup:this._handleMediaKeyup},this._featureElementInfo?.render(),this.renderMedia())},a.renderMedia=function(){const{formattedMediaInfoCount:e}=this.viewModel;return e?_.tsx("div",{key:"media-element-container",class:M.mediaContainer},this.renderMediaPageButton("previous"),this.renderMediaInfo(),this.renderMediaPageButton("next")):null},a.renderImageMediaInfo=function(e){const{_refreshIntervalInfo:t}=this,{activeMediaInfoIndex:i,formattedMediaInfoCount:r}=this.viewModel,{value:o,refreshInterval:a,altText:n,title:s,type:l}=e,{sourceURL:d,linkURL:c}=o,u=p.shouldOpenInNewTab(c)?"_blank":"_self",h="_blank"===u?"noreferrer":"",m=a?t:null,f=m?m.timestamp:0,v=m?m.sourceURL:d,M=_.tsx("img",{alt:n||s,key:`media-${l}-${i}-${r}-${f}`,src:v}),y=c?_.tsx("a",{title:s,href:c,rel:h,target:u},M):null;return y||M},a.renderChartMediaInfo=function(e){const{activeMediaInfoIndex:t,formattedMediaInfoCount:i}=this.viewModel;return _.tsx("div",{key:`media-${e.type}-${t}-${i}`,bind:this,class:M.mediaChart,afterCreate:this._getChartDependencies})},a.renderMediaInfoType=function(){const{activeMediaInfo:e}=this.viewModel;return e?"image"===e.type?this.renderImageMediaInfo(e):e.type.includes("chart")?this.renderChartMediaInfo(e):null:null},a.renderMediaInfo=function(){const{activeMediaInfo:e}=this.viewModel;if(!e)return null;const t=e.title?_.tsx("div",{key:"media-title",class:M.mediaItemTitle,innerHTML:e.title}):null,i=e.caption?_.tsx("div",{key:"media-caption",class:M.mediaItemCaption,innerHTML:e.caption}):null;return _.tsx("div",{key:"media-container",class:M.mediaItemContainer},_.tsx("div",{key:"media-item-container",class:M.mediaItem},this.renderMediaInfoType()),t,i)},a.renderMediaPageButton=function(e){if(this.viewModel.formattedMediaInfoCount<2)return null;const t="previous"===e,i=t?this.messages.previous:this.messages.next,r=t?this.classes(M.mediaButton,M.mediaPrevious):this.classes(M.mediaButton,M.mediaNext),o=t?this.classes(M.mediaIcon,M.mediaPreviousIconLTR,M.iconLeftTriangleArrow):this.classes(M.mediaIcon,M.mediaNextIconLTR,M.iconRightTriangleArrow),a=t?this.classes(M.mediaIcon,M.mediaPreviousIconRTL,M.iconRightTriangleArrow):this.classes(M.mediaIcon,M.mediaNextIconRTL,M.iconLeftTriangleArrow),n=t?"media-previous":"media-next",s=t?this._previous:this._next;return _.tsx("button",{type:"button",key:n,title:i,"aria-label":i,tabIndex:0,class:r,bind:this,onclick:s},_.tsx("span",{"aria-hidden":"true",class:o}),_.tsx("span",{"aria-hidden":"true",class:a}))},a._setupFeatureElementInfo=function(){const{description:e,title:t}=this;this._featureElementInfo.set({description:e,title:t})},a._next=function(){this.viewModel.next()},a._previous=function(){this.viewModel.previous()},a._getRendererColors=function(){var t=e._asyncToGenerator((function*(e){const{am4core:t}=e,i=new Map,r=this.viewModel?.layer?.renderer,o="default";if(!r)return i;const a=yield l.getColorsFromRenderer(r);a.delete(o);return Array.from(a.values()).every((e=>1===e?.length))?(i.set(C,t.color({r:50,g:50,b:50,a:1})),Array.from(a.keys()).forEach((e=>{e&&i.set(e,t.color(a.get(e)[0].toCss(!0)))})),i):i}));function i(e){return t.apply(this,arguments)}return i}(),a._handleMediaKeyup=function(e){const t=i.eventKey(e);"ArrowLeft"===t&&(e.stopPropagation(),this.viewModel.previous()),"ArrowRight"===t&&(e.stopPropagation(),this.viewModel.next())},a._renderChart=function(e){const{abilities:t}=this.viewModel,{chartsModule:i,chartDiv:r,mediaInfo:o,colorMap:a}=e,{value:n,type:s}=o,{am4core:l}=i,d=h.getColorSet(l);function c(e){e instanceof l.ColorSet&&d&&(e.list=d)}v.isDarkTheme()&&l.useTheme(i.am4themes_dark);const u=window.matchMedia("(prefers-reduced-motion: reduce)");t.chartAnimation&&!u.matches?l.useTheme(i.am4themes_animated):l.unuseTheme(i.am4themes_animated),l.useTheme(c);const p="pie-chart"===s?this._createPieChart(e):this._createXYChart(e);r.setAttribute("aria-label",o.altText||o.title),p.data=n.series.map((e=>({[T]:e.tooltip,[x]:e.value,[w]:a.get(e.fieldName)}))).filter((e=>"pie-chart"!==s||e.value>0))},a._customizeChartTooltip=function(e,t){e.label.wrap=!0,e.label.maxWidth=200,e.autoTextColor=!1,e.getFillFromObject=!1,e.label.fill=t.color("#ffffff"),e.background.fill=t.color({r:0,g:0,b:0,a:.7})},a._createPieChart=function(e){const{chartDiv:t,chartsModule:i}=e,{am4core:r,am4charts:o}=i,a=r.create(t,o.PieChart);a.rtl=m.isRTL(this.container);const n=a.series.push(new o.PieSeries);return n.labels.template.disabled=!0,n.ticks.template.disabled=!0,n.dataFields.value=x,n.dataFields.category=T,this._customizeChartTooltip(n.tooltip,r),n.slices.template.propertyFields.fill=w,n.slices.template.propertyFields.stroke=w,a},a._getMinSeriesValue=function(e){let t=0;return e.forEach((e=>t=Math.min(e.value,t))),t},a._createColumnChart=function(e,t){const{chartsModule:i,mediaInfo:r}=t,{value:o}=r,{am4core:a,am4charts:n}=i,s=e.xAxes.push(new n.CategoryAxis);s.dataFields.category=T,s.renderer.labels.template.disabled=!0,this._customizeChartTooltip(s.tooltip,a),s.tooltip.events.on("sizechanged",(()=>{s.tooltip.dy=-s.tooltip.contentHeight}));const l=e.yAxes.push(new n.ValueAxis),d=l.renderer.labels.template;l.renderer.minLabelPosition=y,l.renderer.maxLabelPosition=I,l.min=this._getMinSeriesValue(o.series),this._customizeChartTooltip(l.tooltip,a),d.wrap=!0;const c=e.series.push(new n.ColumnSeries);c.dataFields.valueY=x,c.dataFields.categoryX=T,c.columns.template.propertyFields.fill=w,c.columns.template.propertyFields.stroke=w,e.cursor=new n.XYCursor,o.series.length>g&&(e.scrollbarX=new a.Scrollbar)},a._createBarChart=function(e,t){const{chartsModule:i,mediaInfo:r}=t,{value:o}=r,{am4core:a,am4charts:n}=i,s=e.yAxes.push(new n.CategoryAxis);s.dataFields.category=T,s.renderer.inversed=!0,s.renderer.labels.template.disabled=!0,this._customizeChartTooltip(s.tooltip,a),s.tooltip.events.on("sizechanged",(()=>{s.tooltip.dx=s.tooltip.contentWidth}));const l=e.xAxes.push(new n.ValueAxis),d=l.renderer.labels.template;l.renderer.minLabelPosition=y,l.renderer.maxLabelPosition=I,l.min=this._getMinSeriesValue(o.series),this._customizeChartTooltip(l.tooltip,a),d.wrap=!0;const c=e.series.push(new n.ColumnSeries);c.dataFields.valueX=x,c.dataFields.categoryY=T,c.columns.template.propertyFields.fill=w,c.columns.template.propertyFields.stroke=w,e.cursor=new n.XYCursor,o.series.length>g&&(e.scrollbarY=new a.Scrollbar)},a._createLineChart=function(e,t){const{chartsModule:i,mediaInfo:r,colorMap:o}=t,{value:a}=r,{am4core:n,am4charts:s}=i,l=e.xAxes.push(new s.CategoryAxis);l.dataFields.category=T,l.renderer.labels.template.disabled=!0,this._customizeChartTooltip(l.tooltip,n),l.tooltip.events.on("sizechanged",(()=>{l.tooltip.dy=-l.tooltip.contentHeight}));const d=e.yAxes.push(new s.ValueAxis),c=d.renderer.labels.template;d.renderer.minLabelPosition=y,d.renderer.maxLabelPosition=I,d.min=this._getMinSeriesValue(a.series),this._customizeChartTooltip(d.tooltip,n),c.wrap=!0;const u=e.series.push(new s.LineSeries);u.dataFields.categoryX=T,u.dataFields.valueY=x,u.strokeWidth=1;const p=o.get(C);p&&(u.stroke=p);const h=u.bullets.push(new s.CircleBullet);h.propertyFields.fill=w,h.propertyFields.stroke=w,e.cursor=new s.XYCursor,a.series.length>g&&(e.scrollbarX=new n.Scrollbar)},a._createXYChart=function(e){const{chartDiv:t,chartsModule:i,mediaInfo:r}=e,{type:o}=r,{am4core:a,am4charts:n}=i,s=a.create(t,n.XYChart);return s.rtl=m.isRTL(this.container),"column-chart"===o&&this._createColumnChart(s,e),"bar-chart"===o&&this._createBarChart(s,e),"line-chart"===o&&this._createLineChart(s,e),s},a._clearMediaRefreshTimer=function(){const{_refreshTimer:e}=this;e&&(clearTimeout(e),this._refreshTimer=null)},a._updateMediaInfoTimestamp=function(e){const t=Date.now();this._refreshIntervalInfo={timestamp:t,sourceURL:this._getImageSource(e,t)},this.scheduleRender()},a._setupMediaRefreshTimer=function(){this._clearMediaRefreshTimer();const{activeMediaInfo:e}=this.viewModel;e&&"image"===e.type&&e.refreshInterval&&this._setRefreshTimeout(e)},a._setRefreshTimeout=function(e){const{refreshInterval:t,value:i}=e;if(!t)return;const r=6e4*t;this._updateMediaInfoTimestamp(i.sourceURL);const o=setInterval((()=>{this._updateMediaInfoTimestamp(i.sourceURL)}),r);this._refreshTimer=o},a._getImageSource=function(e,t){const i=e.includes("?")?"&":"?",[r,o=""]=e.split("#");return`${r}${i}timestamp=${t}${o?"#":""}${o}`},e._createClass(o,[{key:"attributes",get:function(){return this.viewModel.attributes},set:function(e){this.viewModel.attributes=e}},{key:"activeMediaInfoIndex",get:function(){return this.viewModel.activeMediaInfoIndex},set:function(e){this.viewModel.activeMediaInfoIndex=e}},{key:"description",get:function(){return this.viewModel.description},set:function(e){this.viewModel.description=e}},{key:"fieldInfoMap",get:function(){return this.viewModel.fieldInfoMap},set:function(e){this.viewModel.fieldInfoMap=e}},{key:"layer",get:function(){return this.viewModel.layer},set:function(e){this.viewModel.layer=e}},{key:"mediaInfos",get:function(){return this.viewModel.mediaInfos},set:function(e){this.viewModel.mediaInfos=e}},{key:"popupTemplate",get:function(){return this.viewModel.popupTemplate},set:function(e){this.viewModel.popupTemplate=e}},{key:"relatedInfos",get:function(){return this.viewModel.relatedInfos},set:function(e){this.viewModel.relatedInfos=e}},{key:"title",get:function(){return this.viewModel.title},set:function(e){this.viewModel.title=e}}]),o}(d);t.__decorate([o.property()],b.prototype,"attributes",null),t.__decorate([o.property()],b.prototype,"activeMediaInfoIndex",null),t.__decorate([o.property()],b.prototype,"description",null),t.__decorate([o.property()],b.prototype,"fieldInfoMap",null),t.__decorate([o.property()],b.prototype,"layer",null),t.__decorate([o.property()],b.prototype,"mediaInfos",null),t.__decorate([o.property()],b.prototype,"popupTemplate",null),t.__decorate([o.property()],b.prototype,"relatedInfos",null),t.__decorate([o.property()],b.prototype,"title",null),t.__decorate([o.property({type:c})],b.prototype,"viewModel",void 0),t.__decorate([o.property(),f.messageBundle("esri/widgets/Feature/t9n/Feature")],b.prototype,"messages",void 0),b=t.__decorate([s.subclass("esri.widgets.Feature.FeatureMedia")],b);return b}));
