// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../core/events","../../core/watchUtils","../../core/accessorSupport/decorators","../Widget","./FeatureMedia/FeatureMediaViewModel","./support/featureUtils","../support/chartUtils","../support/widget","../support/widgetUtils"],(function(e,t,i,r,a,o,s,n,l,d,u,p){"use strict";var c="esri-feature-media",h="esri-feature-media__container",f="esri-feature-media__item-container",v="esri-feature-media__item",m="esri-feature-media__item-title",_="esri-feature-media__item-caption",M="esri-feature-media__previous",y="esri-feature-media__previous-icon",I="esri-feature-media__previous-icon--rtl",w="esri-feature-media__next",g="esri-feature-media__next-icon",x="esri-feature-media__next-icon--rtl",b="esri-feature-media__chart",C="esri-feature-media__button",T="esri-feature-media__icon",L="esri-icon-left-triangle-arrow",F="esri-icon-right-triangle-arrow";return function(e){function t(t,i){var r=e.call(this,t,i)||this;return r._refreshTimer=null,r._refreshIntervalInfo=null,r.attributes=null,r.activeMediaInfoIndex=null,r.fieldInfoMap=null,r.layer=null,r.mediaInfos=null,r.popupTemplate=null,r.relatedInfos=null,r.viewModel=new n,r.messages=null,r}return i.__extends(t,e),t.prototype.initialize=function(){var e=this;this.own(a.init(this,["viewModel.activeMediaInfo","viewModel.activeMediaInfoIndex"],(function(){return e._setupMediaRefreshTimer()})))},t.prototype.destroy=function(){this._clearMediaRefreshTimer()},t.prototype.render=function(){return u.tsx("div",{bind:this,class:c,onkeyup:this._handleMediaKeyup},this.renderMedia())},t.prototype.renderMedia=function(){return this.viewModel.formattedMediaInfoCount?u.tsx("div",{key:"media-element-container",class:h},this.renderMediaPageButton("previous"),this.renderMediaInfo(),this.renderMediaPageButton("next")):null},t.prototype.renderImageMediaInfo=function(e){var t=this._refreshIntervalInfo,i=this.viewModel,r=i.activeMediaInfoIndex,a=i.formattedMediaInfoCount,o=e.value,s=e.refreshInterval,n=e.altText,d=e.title,p=e.type,c=o.sourceURL,h=o.linkURL,f=l.shouldOpenInNewTab(h)?"_blank":"_self",v="_blank"===f?"noreferrer":"",m=s?t:null,_=m?m.timestamp:0,M=m?m.sourceURL:c,y=u.tsx("img",{alt:n||d,key:"media-"+p+"-"+r+"-"+a+"-"+_,src:M}),I=h?u.tsx("a",{title:d,href:h,rel:v,target:f},y):null;return I||y},t.prototype.renderChartMediaInfo=function(e){var t=this.viewModel,i=t.activeMediaInfoIndex,r=t.formattedMediaInfoCount;return u.tsx("div",{key:"media-"+e.type+"-"+i+"-"+r,bind:this,class:b,afterCreate:this._getChartDependencies})},t.prototype.renderMediaInfoType=function(){var e=this.viewModel.activeMediaInfo;return e?"image"===e.type?this.renderImageMediaInfo(e):-1!==e.type.indexOf("chart")?this.renderChartMediaInfo(e):null:null},t.prototype.renderMediaInfo=function(){var e=this.viewModel.activeMediaInfo,t=e.title?u.tsx("div",{key:"media-title",class:m,innerHTML:e.title}):null,i=e.caption?u.tsx("div",{key:"media-caption",class:_,innerHTML:e.caption}):null;return u.tsx("div",{key:"media-container",class:f},t,i,u.tsx("div",{key:"media-item-container",class:v},this.renderMediaInfoType()))},t.prototype.renderMediaPageButton=function(e){if(this.viewModel.formattedMediaInfoCount<2)return null;var t="previous"===e,i=t?this.messages.previous:this.messages.next,r=t?this.classes(C,M):this.classes(C,w),a=t?this.classes(T,y,L):this.classes(T,g,F),o=t?this.classes(T,I,F):this.classes(T,x,L),s=t?"media-previous":"media-next",n=t?this._previous:this._next;return u.tsx("button",{type:"button",key:s,title:i,"aria-label":i,tabIndex:0,class:r,bind:this,onkeydown:n,onclick:n},u.tsx("span",{"aria-hidden":"true",class:a}),u.tsx("span",{"aria-hidden":"true",class:o}))},t.prototype._next=function(){this.viewModel.next()},t.prototype._previous=function(){this.viewModel.previous()},t.prototype._getChartDependencies=function(e){return i.__awaiter(this,void 0,void 0,(function(){var t,r;return i.__generator(this,(function(i){switch(i.label){case 0:return[4,d.loadChartsModule()];case 1:return t=i.sent(),r=this.viewModel.activeMediaInfo,this._renderChart({chartDiv:e,mediaInfo:r,chartsModule:t}),[2]}}))}))},t.prototype._handleMediaKeyup=function(e){var t=r.eventKey(e);"ArrowLeft"===t&&(e.stopPropagation(),this.viewModel.previous()),"ArrowRight"===t&&(e.stopPropagation(),this.viewModel.next())},t.prototype._renderChart=function(e){var t=e.chartsModule,i=e.chartDiv,r=e.mediaInfo,a=r.value,o=r.type,s=t.am4core,n=d.getColorSet(s);s.useTheme(t.am4themes_animated),s.useTheme((function(e){e instanceof s.ColorSet&&n&&(e.list=n)}));var l="pie-chart"===o?this._createPieChart(e):this._createXYChart(e);i.setAttribute("aria-label",r.altText||r.title),l.data=a.series.map((function(e){return{tooltip:e.tooltip,value:e.value}})).filter((function(e){return"pie-chart"!==o||e.value>0}))},t.prototype._customizeChartTooltip=function(e,t){e.label.wrap=!0,e.label.maxWidth=200,e.autoTextColor=!1,e.getFillFromObject=!1,e.label.fill=t.color("#ffffff"),e.background.fill=t.color({r:0,g:0,b:0,a:.7})},t.prototype._createPieChart=function(e){var t=e.chartDiv,i=e.chartsModule,r=i.am4core,a=i.am4charts,o=r.create(t,a.PieChart);o.rtl=p.isRTL();var s=o.series.push(new a.PieSeries);return s.labels.template.disabled=!0,s.ticks.template.disabled=!0,s.dataFields.value="value",s.dataFields.category="tooltip",this._customizeChartTooltip(s.tooltip,r),o},t.prototype._getMinSeriesValue=function(e){var t=0;return e.forEach((function(e){return t=Math.min(e.value,t)})),t},t.prototype._createColumnChart=function(e,t){var i=t.chartsModule,r=t.mediaInfo.value,a=i.am4core,o=i.am4charts,s=e.xAxes.push(new o.CategoryAxis);s.dataFields.category="tooltip",s.renderer.labels.template.disabled=!0,this._customizeChartTooltip(s.tooltip,a),s.tooltip.events.on("sizechanged",(function(){s.tooltip.dy=-s.tooltip.contentHeight}));var n=e.yAxes.push(new o.ValueAxis),l=n.renderer.labels.template;n.renderer.minLabelPosition=.05,n.renderer.maxLabelPosition=.95,n.min=this._getMinSeriesValue(r.series),this._customizeChartTooltip(n.tooltip,a),l.wrap=!0;var d=e.series.push(new o.ColumnSeries);d.dataFields.valueY="value",d.dataFields.categoryX="tooltip",e.cursor=new o.XYCursor,r.series.length>15&&(e.scrollbarX=new a.Scrollbar)},t.prototype._createBarChart=function(e,t){var i=t.chartsModule,r=t.mediaInfo.value,a=i.am4core,o=i.am4charts,s=e.yAxes.push(new o.CategoryAxis);s.dataFields.category="tooltip",s.renderer.inversed=!0,s.renderer.labels.template.disabled=!0,this._customizeChartTooltip(s.tooltip,a),s.tooltip.events.on("sizechanged",(function(){s.tooltip.dx=s.tooltip.contentWidth}));var n=e.xAxes.push(new o.ValueAxis),l=n.renderer.labels.template;n.renderer.minLabelPosition=.05,n.renderer.maxLabelPosition=.95,n.min=this._getMinSeriesValue(r.series),this._customizeChartTooltip(n.tooltip,a),l.wrap=!0;var d=e.series.push(new o.ColumnSeries);d.dataFields.valueX="value",d.dataFields.categoryY="tooltip",e.cursor=new o.XYCursor,r.series.length>15&&(e.scrollbarY=new a.Scrollbar)},t.prototype._createLineChart=function(e,t){var i=t.chartsModule,r=t.mediaInfo.value,a=i.am4core,o=i.am4charts,s=e.xAxes.push(new o.CategoryAxis);s.dataFields.category="tooltip",s.renderer.labels.template.disabled=!0,this._customizeChartTooltip(s.tooltip,a),s.tooltip.events.on("sizechanged",(function(){s.tooltip.dy=-s.tooltip.contentHeight}));var n=e.yAxes.push(new o.ValueAxis),l=n.renderer.labels.template;n.renderer.minLabelPosition=.05,n.renderer.maxLabelPosition=.95,n.min=this._getMinSeriesValue(r.series),this._customizeChartTooltip(n.tooltip,a),l.wrap=!0;var d=e.series.push(new o.LineSeries);d.dataFields.categoryX="tooltip",d.dataFields.valueY="value",e.cursor=new o.XYCursor,r.series.length>15&&(e.scrollbarX=new a.Scrollbar)},t.prototype._createXYChart=function(e){var t=e.chartDiv,i=e.chartsModule,r=e.mediaInfo.type,a=i.am4core,o=i.am4charts,s=a.create(t,o.XYChart);return s.rtl=p.isRTL(),"column-chart"===r&&this._createColumnChart(s,e),"bar-chart"===r&&this._createBarChart(s,e),"line-chart"===r&&this._createLineChart(s,e),s},t.prototype._clearMediaRefreshTimer=function(){var e=this._refreshTimer;e&&(clearTimeout(e),this._refreshTimer=null)},t.prototype._updateMediaInfoTimestamp=function(e){var t=Date.now();this._refreshIntervalInfo={timestamp:t,sourceURL:this._getImageSource(e,t)},this.scheduleRender()},t.prototype._setupMediaRefreshTimer=function(){this._clearMediaRefreshTimer();var e=this.viewModel.activeMediaInfo;e&&"image"===e.type&&e.refreshInterval&&this._setRefreshTimeout(e)},t.prototype._setRefreshTimeout=function(e){var t=this,i=e.refreshInterval,r=e.value;if(i){var a=6e4*i;this._updateMediaInfoTimestamp(r.sourceURL);var o=setInterval((function(){t._updateMediaInfoTimestamp(r.sourceURL)}),a);this._refreshTimer=o}},t.prototype._getImageSource=function(e,t){var i=-1!==e.indexOf("?")?"&":"?",r=e.split("#"),a=r[0],o=r[1],s=void 0===o?"":o;return""+a+i+"timestamp="+t+(s?"#":"")+s},i.__decorate([o.aliasOf("viewModel.attributes")],t.prototype,"attributes",void 0),i.__decorate([o.aliasOf("viewModel.activeMediaInfoIndex")],t.prototype,"activeMediaInfoIndex",void 0),i.__decorate([o.aliasOf("viewModel.fieldInfoMap")],t.prototype,"fieldInfoMap",void 0),i.__decorate([o.aliasOf("viewModel.layer")],t.prototype,"layer",void 0),i.__decorate([o.aliasOf("viewModel.mediaInfos")],t.prototype,"mediaInfos",void 0),i.__decorate([o.aliasOf("viewModel.popupTemplate")],t.prototype,"popupTemplate",void 0),i.__decorate([o.aliasOf("viewModel.relatedInfos")],t.prototype,"relatedInfos",void 0),i.__decorate([o.property({type:n}),u.renderable(["viewModel.formattedMediaInfos","viewModel.activeMediaInfoIndex","viewModel.activeMediaInfo"])],t.prototype,"viewModel",void 0),i.__decorate([o.property(),u.renderable(),u.messageBundle("esri/widgets/Feature/t9n/Feature")],t.prototype,"messages",void 0),t=i.__decorate([o.subclass("esri.widgets.Feature.FeatureMedia")],t)}(s)}));