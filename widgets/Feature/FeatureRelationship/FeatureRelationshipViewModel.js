/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../Graphic","../../../core/Accessor","../../../core/Clonable","../../../core/Collection","../../../core/HandleOwner","../../../core/Identifiable","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/throttle","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../../rest/support/RelationshipQuery","../support/featureUtils"],(function(e,r,t,o,l,a,n,i,u,s,d,y,c,p,_,h,C){"use strict";const b=100;let g=function(r){function t(t){var o;return(o=r.call(this,t)||this)._queryAbortController=null,o._queryPageAbortController=null,o._queryFeatureCountAbortController=null,o.featuresPerPage=10,o.description=null,o.graphic=null,o.layer=null,o.map=null,o.orderByFields=null,o.featureCount=0,o.relationshipId=null,o.showAllEnabled=!1,o.title=null,o._cancelQuery=()=>{const{_queryAbortController:r}=e._assertThisInitialized(o);r&&r.abort(),o._queryAbortController=null},o._cancelQueryFeatureCount=()=>{const{_queryFeatureCountAbortController:r}=e._assertThisInitialized(o);r&&r.abort(),o._queryFeatureCountAbortController=null},o._cancelQueryPage=()=>{const{_queryPageAbortController:r}=e._assertThisInitialized(o);r&&r.abort(),o._queryPageAbortController=null},o._queryController=e._asyncToGenerator((function*(){o._cancelQuery();const e=new AbortController;o._queryAbortController=e,yield u.ignoreAbortErrors(o._query()),o._queryAbortController===e&&(o._queryAbortController=null)})),o._queryFeatureCountController=e._asyncToGenerator((function*(){o._cancelQueryFeatureCount();const e=new AbortController;o._queryFeatureCountAbortController=e,yield u.ignoreAbortErrors(o._queryFeatureCount()),o._queryFeatureCountAbortController===e&&(o._queryFeatureCountAbortController=null)})),o._queryPageController=e._asyncToGenerator((function*(){const e=new AbortController;o._queryPageAbortController=e,yield u.ignoreAbortErrors(o._queryPage()),o._queryPageAbortController===e&&(o._queryPageAbortController=null)})),o._queryThrottled=d.throttle(o._queryController,b,e._assertThisInitialized(o)),o._queryFeatureCountThrottled=d.throttle(o._queryFeatureCountController,b,e._assertThisInitialized(o)),o._queryPageThrottled=d.throttle(o._queryPageController,b,e._assertThisInitialized(o)),o._query=e._asyncToGenerator((function*(){const{_queryAbortController:r,relatedFeatures:t}=e._assertThisInitialized(o);o._destroyRelatedFeatureViewModels(),o.featurePage=1,t.removeAll(),t.addMany(o._sliceFeatures(yield o._queryRelatedFeatures({signal:r?.signal})))})),o.handles.add([s.watch((()=>[o.displayCount,o.graphic,o.layer,o.map,o.orderByFieldsFixedCasing,o.relationshipId,o.featuresPerPage,o.showAllEnabled]),(()=>o._queryThrottled()),s.initial),s.watch((()=>[o.featurePage,o.showAllEnabled]),(()=>o._queryPageThrottled())),s.watch((()=>[o.layer,o.relationshipId,o.objectId]),(()=>o._queryFeatureCountThrottled()))]),o}e._inheritsLoose(t,r);var o=t.prototype;return o.destroy=function(){this._destroyRelatedFeatureViewModels(),this.relatedFeatures.removeAll(),this._cancelQuery(),this._cancelQueryFeatureCount(),this._cancelQueryPage()},o._destroyRelatedFeatureViewModels=function(){this.relatedFeatureViewModels?.forEach((e=>!e.destroyed&&e.destroy())),this.relatedFeatureViewModels.removeAll()},o._queryFeatureCount=function(){var r=e._asyncToGenerator((function*(){const{layer:e,relatedLayer:r,relationshipId:t,objectId:o,_queryFeatureCountAbortController:l}=this;if(yield e?.load(),!r||"number"!=typeof o||!e?.capabilities?.queryRelated?.supportsCount)return void this._set("featureCount",0);yield r.load();const a=r.createQuery(),n=e.capabilities?.queryRelated?.supportsCacheHint??!1,i=new h({cacheHint:n,relationshipId:t,returnGeometry:!1,objectIds:[o],where:a.where}),u=yield e.queryRelatedFeaturesCount(i,{signal:l?.signal});this._set("featureCount",u[o]||0)}));function t(){return r.apply(this,arguments)}return t}(),o._sliceFeatures=function(e){const{showAllEnabled:r,displayCount:t}=this;return r?e:t?e.slice(0,t):[]},o._queryPage=function(){var r=e._asyncToGenerator((function*(){const{relatedFeatures:e,featurePage:r,showAllEnabled:t,_queryPageAbortController:o}=this;!t||r<2||e.addMany(yield this._queryRelatedFeatures({signal:o?.signal}))}));function t(){return r.apply(this,arguments)}return t}(),o._queryRelatedFeatures=function(){var r=e._asyncToGenerator((function*(e){const{orderByFieldsFixedCasing:r,showAllEnabled:t,featuresPerPage:o,displayCount:l,layer:a,relationshipId:n,featurePage:i,featureCount:u,relatedLayer:s}=this;yield a?.load();const{relationship:d,objectId:y}=this;if(!d||"number"!=typeof y||!a?.capabilities?.queryRelated?.supportsPagination)return[];const c=t?((i-1)*o+u)%u:0,p=t?o:l;if(!s)return[];yield s.load();const _=s.objectIdField,C=[...r?.map((e=>e.field)),_],b=r?.map((e=>`${e.field} ${e.order}`)),g=a.capabilities?.queryRelated?.supportsCacheHint||!1,f=s.createQuery(),F=new h({orderByFields:b,start:c,num:p,outFields:C,cacheHint:g,relationshipId:n,returnGeometry:!1,objectIds:[y],where:f.where}),q=(yield a.queryRelatedFeatures(F,{signal:e?.signal}))[y]?.features||[];return q.forEach((e=>e.sourceLayer=s)),q}));function t(e){return r.apply(this,arguments)}return t}(),e._createClass(t,[{key:"featurePage",get:function(){return this._get("featurePage")},set:function(e){const{featuresPerPage:r,featureCount:t}=this,o=1,l=Math.ceil(t/r)||1;this._set("featurePage",Math.min(Math.max(e,o),l))}},{key:"orderByFieldsFixedCasing",get:function(){const{orderByFields:e,relatedLayer:r}=this;return e&&r?.loaded?e.map((e=>{const t=e.clone(),o=C.getFixedFieldName(e.field,r);return t.field=o,t})):e}},{key:"itemDescriptionFieldName",get:function(){return this.orderByFieldsFixedCasing?.[0]?.field||null}},{key:"displayCount",get:function(){return this._get("displayCount")},set:function(e){const r=0,t=10;this._set("displayCount",Math.min(Math.max(e,r),t))}},{key:"objectId",get:function(){return this.graphic?.attributes?.[this.objectIdField]??null}},{key:"objectIdField",get:function(){return this.layer?.objectIdField||null}},{key:"relatedFeatures",get:function(){return this._get("relatedFeatures")||new a}},{key:"relatedLayer",get:function(){const{layer:e,map:r,relationship:t}=this;return e?.loaded?C.findRelatedLayer(r,e,t):null}},{key:"relationship",get:function(){const{relationshipId:e,layer:r}=this;return"number"==typeof e?r?.relationships?.find((({id:r})=>r===e))??null:null}},{key:"relatedFeatureViewModels",get:function(){return this._get("relatedFeatureViewModels")||new a}},{key:"state",get:function(){const{_queryAbortController:e,_queryFeatureCountAbortController:r,_queryPageAbortController:t,graphic:o,relatedLayer:l}=this;return r?"loading":e||t?"querying":o&&l?"ready":"disabled"}}]),t}(l.ClonableMixin(i.IdentifiableMixin(n.HandleOwnerMixin(o))));r.__decorate([y.property()],g.prototype,"_queryAbortController",void 0),r.__decorate([y.property()],g.prototype,"_queryPageAbortController",void 0),r.__decorate([y.property()],g.prototype,"_queryFeatureCountAbortController",void 0),r.__decorate([y.property({value:1})],g.prototype,"featurePage",null),r.__decorate([y.property()],g.prototype,"featuresPerPage",void 0),r.__decorate([y.property({readOnly:!0})],g.prototype,"orderByFieldsFixedCasing",null),r.__decorate([y.property()],g.prototype,"description",void 0),r.__decorate([y.property({readOnly:!0})],g.prototype,"itemDescriptionFieldName",null),r.__decorate([y.property({value:3})],g.prototype,"displayCount",null),r.__decorate([y.property({type:t})],g.prototype,"graphic",void 0),r.__decorate([y.property()],g.prototype,"layer",void 0),r.__decorate([y.property()],g.prototype,"map",void 0),r.__decorate([y.property({readOnly:!0})],g.prototype,"objectId",null),r.__decorate([y.property({readOnly:!0})],g.prototype,"objectIdField",null),r.__decorate([y.property()],g.prototype,"orderByFields",void 0),r.__decorate([y.property({readOnly:!0})],g.prototype,"relatedFeatures",null),r.__decorate([y.property({readOnly:!0})],g.prototype,"relatedLayer",null),r.__decorate([y.property({readOnly:!0})],g.prototype,"relationship",null),r.__decorate([y.property({readOnly:!0})],g.prototype,"featureCount",void 0),r.__decorate([y.property({readOnly:!0})],g.prototype,"relatedFeatureViewModels",null),r.__decorate([y.property()],g.prototype,"relationshipId",void 0),r.__decorate([y.property()],g.prototype,"showAllEnabled",void 0),r.__decorate([y.property({readOnly:!0})],g.prototype,"state",null),r.__decorate([y.property()],g.prototype,"title",void 0),g=r.__decorate([_.subclass("esri.widgets.Feature.FeatureRelationship.FeatureRelationshipViewModel")],g);return g}));
