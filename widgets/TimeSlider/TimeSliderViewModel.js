/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/has","../../core/lang","../../core/maybe","../../core/Logger","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/subclass","../../core/urlUtils","../../core/uuid","../../portal/support/resourceExtension","../../core/promiseUtils","../../core/mathUtils","../../core/CollectionFlattener","../../layers/support/timeUtils","../../TimeExtent","../../TimeInterval","../../core/watchUtils","../../webdoc/widgets/TimeSlider","../../webdoc/Widgets","../../layers/mixins/TemporalLayer","../../core/HandleOwner"],(function(t,e,i,n,r,o,s,l,a,u,m,d,p,c,h,f,_,v,y,T,g,w,x){"use strict";const E=1e4;function S(t){return void 0!==t.count}function b(t){return void 0!==t.interval}function C(t){return void 0!==t.dates}function k(t){return"esri.WebMap"===t.declaredClass}function F(t){return"group"===(null==t?void 0:t.type)}function D(t){return"feature"===(null==t?void 0:t.type)}function M(t){return"map-image"===(null==t?void 0:t.type)}const O=o.getLogger("esri.widgets.TimeSlider.TimeSliderViewModel");let R=function(e){function i(t){var i;return(i=e.call(this,t)||this).timerId=null,i.view=null,i._animationController=null,i._updateTimeSliderTask=null,i}t._inheritsLoose(i,e);var o=i.prototype;return o.initialize=function(){this.handles.add([y.init(this,"effectiveStops",(()=>{this.values||(this._set("values",this._getDefaultValues()),this.view&&(this.view.timeExtent=this.timeExtent))})),y.init(this,"view.map",(t=>{r.isSome(this._updateTimeSliderTask)&&(this._updateTimeSliderTask.abort(),this._updateTimeSliderTask=null),this._updateTimeSliderTask=p.createTask((e=>this._updateTimeSliderFromMap(t,e)))})),y.init(this,"view",((t,e)=>{this._unregisterWidget(e),this._registerWidget(t)}),!0)])},o.destroy=function(){var t;null!=this.timerId&&(clearInterval(this.timerId),this.timerId=null),this._unregisterWidget(this.view),this.view=null,null==(t=this._animationController)||t.abort(),this._animationController=null,r.isSome(this._updateTimeSliderTask)&&(this._updateTimeSliderTask.abort(),this._updateTimeSliderTask=null)},o.next=function(){this.values&&this.fullTimeExtent&&this._step({forward:!0,allowRestart:!1})},o.play=function(){this._startAnimation()},o.previous=function(){this._step({forward:!1,allowRestart:!1})},o.stop=function(){this._stopAnimation()},o.updateWebDocument=function(t){if(k(t)){const e=new T({currentTimeExtent:this.timeExtent,fullTimeExtent:this.fullTimeExtent,loop:this.loop,numStops:S(this.stops)?this.stops.count:null,numThumbs:"time-window"===this.mode?2:1,stopDelay:this.playRate,stopInterval:b(this.stops)?this.stops.interval:null,stops:C(this.stops)?this.stops.dates:null});t.widgets?t.widgets.timeSlider=e:t.widgets=new g({timeSlider:e})}},o._animate=async function(){try{await Promise.all([p.after(this.playRate,null,this._animationController.signal),this.view&&y.whenFalseOnce(this.view,"updating",this._animationController.signal)])}catch(t){return p.isAbortError(t)||O.error(t),void(this._animationController=null)}this._step({forward:!0,allowRestart:!1}),this._animationController&&this._animate()},o._divideTimeExtentByCount=function(t,e=10){if(!t||!e)return[];const{start:i,end:n}=t;if(!i||!n)return[];if(e>E)return this._divideTimeExtentByCount(t);const r=[],o=i.getTime(),s=n.getTime()-o;for(let l=0;l<=e;l++)r.push(new Date(o+l/e*s));return r},o._divideTimeExtentByInterval=function(t,e,i=E){if(!t||!e)return[];const{start:n,end:r}=t;if(!n||!r)return[];if((r.getTime()-n.getTime())/e.toMilliseconds()>i)return this._divideTimeExtentByCount(t);const o=[],{value:s,unit:l}=e;let a=n;for(;a.getTime()<=r.getTime();)o.push(new Date(a.getTime())),a=f.offsetDate(a,s,l);return o},o._getDefaultValues=function(){const{effectiveStops:t,mode:e}=this;return t&&e?"time-window"===e?t.length>1?[t[0],t[1]]:null:t.length>0?[t[0]]:null:null},o._getFullTimeExtentFromWebDocument=async function(t,e){const{fullTimeExtent:i}=t.widgets.timeSlider;if(i)return i;const n=new h({root:t,rootCollectionNames:["layers"],getChildrenFunction:t=>F(t)?t.layers:null,itemFilterFunction:t=>w.isTemporalLayer(t)&&t.useViewTime});await Promise.all(n.map((t=>t.load({signal:e}))));const r=n.map((t=>t.timeInfo));let o;if(r.some((t=>t.hasLiveData))){const t=n.filter((t=>D(t)||M(t))).map((t=>t.fetchRecomputedExtents({signal:e})));o=(await Promise.all(t)).map((t=>t.timeExtent))}else o=r.map((t=>t.fullTimeExtent));return o.reduce(((t,e)=>t.union(e)))},o._getModeFromTimeSlider=function(t){var e;const i=null!=(e=t.numThumbs)?e:2,n=t.currentTimeExtent;if(n){const{start:t,end:e}=n;return t&&e&&t.getTime()===e.getTime()?"instant":2===i?"time-window":t&&0!==t.getTime()?"cumulative-from-end":"cumulative-from-start"}return 2===i?"time-window":"cumulative-from-start"},o._getStopsFromTimeSlider=function(t){const{numStops:e,stopInterval:i,stops:r}=t;return r?{dates:n.clone(r)}:i?{interval:i.clone()}:{count:null!=e?e:5}},o._getValuesFromTimeSlider=function(t,e){const i=t.currentTimeExtent;if(i){const{start:t,end:n}=i;switch(e){case"time-window":return[t,n];case"cumulative-from-start":return[n];case"cumulative-from-end":case"instant":return[t]}}return this._getDefaultValues()},o._registerWidget=function(t){(null==t?void 0:t.persistableViewModels.some((t=>t===this)))||null==t||t.persistableViewModels.add(this)},o._startAnimation=function(){this._stopAnimation(),this._animationController=p.createAbortController(),this._step({forward:!0,allowRestart:!0}),this._animate()},o._step=function(t){const{forward:e,allowRestart:i}=t,{effectiveStops:n,values:r}=this;if(!r||0===r.length||r.length>n.length)return;const o=n.map((t=>t.getTime())).sort(((t,e)=>t-e)),s=r.map((t=>t.getTime())).map((t=>{const e=o.indexOf(t);if(-1!==e)return e;const i=o.reduce(((e,i)=>Math.abs(i-t)<Math.abs(e-t)?i:e));return o.indexOf(i)})),l=s.map((t=>t+(e?1:-1))),a=l.some((t=>t<0||t>o.length-1)),{loop:u,state:m}=this;if(a)if(u||i){const t=Math.min(...s),i=Math.max(...s),n=e?s.map((e=>e-t)):s.map((t=>t+(o.length-1-i)));this.values=n.map((t=>new Date(o[t])))}else"playing"===m&&this.stop();else this.values=l.map((t=>new Date(o[t])))},o._stopAnimation=function(){var t;null==(t=this._animationController)||t.abort(),this._animationController=null},o._toTimeExtent=function(t){if(!t||0===t.length)return null;const e=t[0],i=t.length>1?t[1]:t[0];switch(this.mode){case"instant":case"time-window":return new _({start:e,end:i});case"cumulative-from-start":return new _({start:null,end:e});case"cumulative-from-end":return new _({start:e,end:null});default:return null}},o._unregisterWidget=function(t){null==t||t.persistableViewModels.remove(this)},o._updateTimeSliderFromMap=async function(t,e){var i;if(!t||!k(t))return;await t.load({signal:e});const n=null==t||null==(i=t.widgets)?void 0:i.timeSlider;if(!n)return;const r=this._getModeFromTimeSlider(n);var o;(this._isOverridden("mode")||(this.mode=r),this._isOverridden("fullTimeExtent")||(this.fullTimeExtent=await this._getFullTimeExtentFromWebDocument(t,e)),this._isOverridden("playRate"))||(this.playRate=null!=(o=n.stopDelay)?o:2e3);this._isOverridden("stops")||(this.stops=this._getStopsFromTimeSlider(n)),this._isOverridden("values")||(this.values=this._getValuesFromTimeSlider(n,r)),this._isOverridden("loop")||(this.loop=n.loop)},t._createClass(i,[{key:"effectiveStops",get:function(){const{fullTimeExtent:t,stops:e}=this;if(!e)return[];if("dates"in e){const{dates:i}=e;if(null==i||0===i.length)return null;const n=i.sort(((t,e)=>t.getTime()-e.getTime()));return t?n.filter((e=>{const{start:i,end:n}=t;return!(e.getTime()<i.getTime()||e.getTime()>n.getTime())})):n}if(S(e)){const i=e.timeExtent||t;return this._divideTimeExtentByCount(i,e.count)}if(b(e)){const i=e.timeExtent||t;return this._divideTimeExtentByInterval(i,e.interval)}return[]}},{key:"fullTimeExtent",set:function(t){this._override("fullTimeExtent",t)}},{key:"loop",set:function(t){this._override("loop",t)}},{key:"mode",set:function(t){this._override("mode",t)}},{key:"playRate",set:function(t){t<=0||t>36e5||("playing"===this.state&&this._startAnimation(),this._override("playRate",t))}},{key:"state",get:function(){return this.values&&this.fullTimeExtent?this._animationController?"playing":"ready":"disabled"}},{key:"stops",set:function(t){this._override("stops",t)}},{key:"timeExtent",get:function(){const{mode:t,values:e}=this;if(!e||0===e.length)return null;switch(t){case"instant":return new _({start:e[0],end:e[0]});case"time-window":return e.length>1?new _({start:e[0],end:e[1]}):null;case"cumulative-from-start":return new _({start:null,end:e[0]});case"cumulative-from-end":return new _({start:e[0],end:null});default:return}}},{key:"values",set:function(t){const{fullTimeExtent:e,view:i}=this;if(e){const{start:i,end:n}=e,r=i.getTime(),o=n.getTime();t=t&&t.filter((t=>t)).map((t=>{const e=t.getTime(),i=c.clamp(e,r,o);return new Date(i)}))}i&&(i.timeExtent=this._toTimeExtent(t)),this._override("values",t)}}]),i}(x.HandleOwner);return e.__decorate([l.property({readOnly:!0})],R.prototype,"effectiveStops",null),e.__decorate([l.property({type:_,value:null})],R.prototype,"fullTimeExtent",null),e.__decorate([l.property({nonNullable:!0,value:!1})],R.prototype,"loop",null),e.__decorate([l.property({nonNullable:!0,value:"time-window"})],R.prototype,"mode",null),e.__decorate([l.property({nonNullable:!0,value:1e3})],R.prototype,"playRate",null),e.__decorate([l.property({readOnly:!0})],R.prototype,"state",null),e.__decorate([l.property({cast:t=>t?(b(t)&&(t.interval=s.ensureType(v,t.interval)),(b(t)||S(t))&&(t.timeExtent=s.ensureType(_,t.timeExtent)),t):null,value:{count:10}})],R.prototype,"stops",null),e.__decorate([l.property({readOnly:!0})],R.prototype,"timeExtent",null),e.__decorate([l.property()],R.prototype,"timerId",void 0),e.__decorate([l.property({value:null})],R.prototype,"values",null),e.__decorate([l.property()],R.prototype,"view",void 0),e.__decorate([l.property()],R.prototype,"_animationController",void 0),e.__decorate([l.property()],R.prototype,"next",null),e.__decorate([l.property()],R.prototype,"play",null),e.__decorate([l.property()],R.prototype,"previous",null),e.__decorate([l.property()],R.prototype,"stop",null),e.__decorate([l.property()],R.prototype,"updateWebDocument",null),R=e.__decorate([a.subclass("esri.widgets.TimeSlider.TimeSliderViewModel")],R),R}));
