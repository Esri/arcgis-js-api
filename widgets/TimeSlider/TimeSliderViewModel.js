/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../TimeExtent","../../TimeInterval","../../core/deprecate","../../core/HandleOwner","../../core/lang","../../core/Logger","../../core/maybe","../../core/promiseUtils","../../core/timeUtils","../../core/watchUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/has","../../core/accessorSupport/decorators/subclass","../../layers/mixins/TemporalLayer","../../webdoc/Widgets","../../webdoc/widgets/TimeSlider"],(function(t,e,i,n,r,o,s,l,a,u,m,d,c,p,h,f,_,v,y){"use strict";const T=1e4;function w(t){return a.isSome(t)&&void 0!==t.count}function g(t){return a.isSome(t)&&void 0!==t.interval}function x(t){return a.isSome(t)&&void 0!==t.dates}function E(t){return"esri.WebMap"===t.declaredClass}function S(t){return"feature"===(null==t?void 0:t.type)}function b(t){return"map-image"===(null==t?void 0:t.type)}const C=l.getLogger("esri.widgets.TimeSlider.TimeSliderViewModel");let N=function(e){function n(t){var i;return(i=e.call(this,t)||this)._animationController=null,i._loadingWebDocument=!1,i._timerId=null,i._updateTimeSliderTask=null,i.view=null,i}t._inheritsLoose(n,e);var o=n.prototype;return o.initialize=function(){var e=this;this.handles.add([d.init(this,"effectiveStops",(()=>{a.isNone(this.timeExtent)&&this._set("timeExtent",this._getDefaultTimeExtent())})),d.init(this,"view.map",(i=>{a.isSome(this._updateTimeSliderTask)&&(this._updateTimeSliderTask.abort(),this._updateTimeSliderTask=null),this._updateTimeSliderTask=u.createTask(function(){var n=t._asyncToGenerator((function*(t){e._loadingWebDocument=!0,yield e._updateTimeSliderFromMap(i,t),e._loadingWebDocument=!1}));return function(t){return n.apply(this,arguments)}}())})),d.init(this,"view",((t,e)=>{this._unregisterWidget(e),this._registerWidget(t)}),!0),d.init(this,"timeExtent",(t=>{a.isSome(this.view)&&(this.view.timeExtent=t)}))])},o.destroy=function(){a.isSome(this._timerId)&&(clearInterval(this._timerId),this._timerId=null),this._unregisterWidget(this.view),this.view=null,a.isSome(this._animationController)&&(this._animationController.abort(),this._animationController=null),a.isSome(this._updateTimeSliderTask)&&(this._updateTimeSliderTask.abort(),this._updateTimeSliderTask=null)},o.next=function(){this._step({forward:!0,allowRestart:!1})},o.play=function(){this._startAnimation()},o.previous=function(){this._step({forward:!1,allowRestart:!1})},o.stop=function(){this._stopAnimation()},o.updateWebDocument=function(t){if(E(t)){const e=new y({currentTimeExtent:this.timeExtent,fullTimeExtent:this.fullTimeExtent,loop:this.loop,numStops:w(this.stops)?this.stops.count:null,numThumbs:"time-window"===this.mode?2:1,stopDelay:this.playRate,stopInterval:g(this.stops)?this.stops.interval:null,stops:x(this.stops)?this.stops.dates:null});t.widgets?t.widgets.timeSlider=e:t.widgets=new v({timeSlider:e})}},o.valuesToTimeExtent=function(t){if(a.isNone(t))return null;const e=t.length>0?new Date(t[0]):null,n=t.length>1?new Date(t[1]):null;switch(this.mode){case"time-window":return new i({start:e,end:n});case"instant":return new i({start:e,end:e});case"cumulative-from-start":return new i({start:null,end:e});case"cumulative-from-end":return new i({start:e,end:null});default:return i.allTime}},o._animate=function(){var e=t._asyncToGenerator((function*(){try{yield Promise.all([u.after(this.playRate,null,a.isSome(this._animationController)&&this._animationController.signal),a.isSome(this.view)&&d.whenFalseOnce(this.view,"updating",a.isSome(this._animationController)&&this._animationController.signal)])}catch(t){return u.isAbortError(t)||C.error(t),void(this._animationController=null)}this._step({forward:!0,allowRestart:!1}),a.isNone(this._animationController)||this._animate()}));function i(){return e.apply(this,arguments)}return i}(),o._divideTimeExtentByCount=function(t,e=10){if(!t||!e)return[];const{start:i,end:n}=t;if(a.isNone(i)||a.isNone(n))return[];if(e>T)return this._divideTimeExtentByCount(t);const r=[],o=i.getTime(),s=n.getTime()-o;for(let l=0;l<=e;l++)r.push(new Date(o+l/e*s));return r},o._divideTimeExtentByInterval=function(t,e,i=T){if(!t||!e)return[];const{start:n,end:r}=t;if(a.isNone(n)||a.isNone(r))return[];if((r.getTime()-n.getTime())/e.toMilliseconds()>i)return this._divideTimeExtentByCount(t);const o=[],{value:s,unit:l}=e;let u=n;for(;u.getTime()<=r.getTime();)o.push(new Date(u.getTime())),u=m.offsetDate(u,s,l);return o},o._getDefaultTimeExtent=function(){const{effectiveStops:t,mode:e}=this;if(a.isNone(t)||!e)return null;switch(e){case"time-window":return t.length>1?new i({start:t[0],end:t[1]}):null;case"cumulative-from-start":return t.length>0?new i({start:null,end:t[0]}):null;case"cumulative-from-end":return t.length>0?new i({start:t[0],end:null}):null;case"instant":return t.length>0?new i({start:t[0],end:t[0]}):null;default:return null}},o._getFullTimeExtentFromWebDocument=function(){var e=t._asyncToGenerator((function*(t,e){const{fullTimeExtent:i}=t.widgets.timeSlider;if(i)return i;const n=t.allLayers.filter((t=>_.isTemporalLayer(t)&&t.useViewTime));yield Promise.all(n.map((t=>t.load({signal:e}))));const r=n.map((t=>t.timeInfo));let o;if(r.some((t=>t.hasLiveData))){const t=n.filter((t=>S(t)||b(t))).map((t=>t.fetchRecomputedExtents({signal:e})));o=(yield Promise.all(t)).map((t=>t.timeExtent))}else o=r.map((t=>t.fullTimeExtent));return o.reduce(((t,e)=>t.union(e)))}));function i(t,i){return e.apply(this,arguments)}return i}(),o._getModeFromTimeSlider=function(t){var e;const i=null!=(e=t.numThumbs)?e:2,n=t.currentTimeExtent;if(n){const{start:t,end:e}=n;return a.isSome(t)&&a.isSome(e)&&t.getTime()===e.getTime()?"instant":2===i?"time-window":a.isNone(t)||0===t.getTime()?"cumulative-from-start":"cumulative-from-end"}return 2===i?"time-window":"cumulative-from-start"},o._getStopsFromTimeSlider=function(t){const{numStops:e,stopInterval:i,stops:n}=t;return n?{dates:s.clone(n)}:i?{interval:i.clone()}:{count:null!=e?e:5}},o._getTimeExtentFromTimeSlider=function(t,e){const n=t.currentTimeExtent;if(n){var r;const{start:t,end:o}=n,s=null!=(r=null!=t?t:o)?r:null;switch(e){case"time-window":return new i({start:t,end:o});case"cumulative-from-start":return new i({start:null,end:s});case"cumulative-from-end":return new i({start:s,end:null});case"instant":return new i({start:s,end:s})}}return this._getDefaultTimeExtent()},o._registerWidget=function(t){if(a.isSome(t)){t.persistableViewModels.some((t=>t===this))||t.persistableViewModels.add(this)}},o._startAnimation=function(){this._stopAnimation(),this._animationController=u.createAbortController(),this._step({forward:!0,allowRestart:!0}),this._animate()},o._step=function(t){const{forward:e,allowRestart:i}=t,{effectiveStops:n}=this;if(a.isNone(this.timeExtentValues)||a.isNone(n))return;const r=n.map((t=>t.getTime())),o=this.timeExtentValues.map((t=>{const e=r.indexOf(t);if(-1!==e)return e;const i=r.reduce(((e,i)=>Math.abs(i-t)<Math.abs(e-t)?i:e));return r.indexOf(i)})),s=o.map((t=>t+(e?1:-1))),l=s.some((t=>t<0||t>r.length-1)),{loop:u,state:m}=this;if(l)if(u||i){const t=Math.min(...o),i=Math.max(...o),n=(e?o.map((e=>e-t)):o.map((t=>t+(r.length-1-i)))).map((t=>r[t]));this.timeExtent=this.valuesToTimeExtent(n)}else"playing"===m&&this.stop();else{const t=s.map((t=>r[t]));this.timeExtent=this.valuesToTimeExtent(t)}},o._stopAnimation=function(){a.isSome(this._animationController)&&(this._animationController.abort(),this._animationController=null)},o._unregisterWidget=function(t){a.isSome(t)&&t.persistableViewModels.remove(this)},o._updateTimeSliderFromMap=function(){var e=t._asyncToGenerator((function*(t,e){var i;if(!t||!E(t))return;yield t.load({signal:e});const n=null==t||null==(i=t.widgets)?void 0:i.timeSlider;if(!n)return;const r=this._getModeFromTimeSlider(n);var o;(this._isOverridden("mode")||(this.mode=r),this._isOverridden("fullTimeExtent")||(this.fullTimeExtent=yield this._getFullTimeExtentFromWebDocument(t,e)),this._isOverridden("playRate"))||(this.playRate=null!=(o=n.stopDelay)?o:2e3);this._isOverridden("stops")||(this.stops=this._getStopsFromTimeSlider(n)),this._isOverridden("timeExtent")||(this.timeExtent=this._getTimeExtentFromTimeSlider(n,r)),this._isOverridden("loop")||(this.loop=n.loop)}));function i(t,i){return e.apply(this,arguments)}return i}(),t._createClass(n,[{key:"effectiveStops",get:function(){const{fullTimeExtent:t,stops:e}=this;if(x(e)){const{dates:i}=e;if(null==i||0===i.length)return null;const n=i.sort(((t,e)=>t.getTime()-e.getTime()));if(a.isNone(t))return n;const{start:r,end:o}=t;if(a.isNone(r)||a.isNone(o))return n;return n.filter((t=>!(t.getTime()<r.getTime()||t.getTime()>o.getTime())))}if(w(e)){var i;const n=null!=(i=e.timeExtent)?i:a.unwrap(t);return this._divideTimeExtentByCount(n,e.count)}if(g(e)){var n;const i=null!=(n=e.timeExtent)?n:a.unwrap(t);return this._divideTimeExtentByInterval(i,e.interval)}return[]}},{key:"fullTimeExtent",set:function(t){this._override("fullTimeExtent",t)}},{key:"loop",set:function(t){this._override("loop",t)}},{key:"mode",set:function(t){this._override("mode",t)}},{key:"playRate",set:function(t){t<=0||t>36e5||("playing"===this.state&&this._startAnimation(),this._override("playRate",t))}},{key:"state",get:function(){return a.isNone(this.fullTimeExtent)||this._loadingWebDocument?"disabled":a.isSome(this._animationController)?"playing":"ready"}},{key:"stops",set:function(t){this._override("stops",t)}},{key:"timeExtent",set:function(t){this._override("timeExtent",t)}},{key:"timeExtentValues",get:function(){const{mode:t,timeExtent:e}=this;if(a.isNone(e)||e.isAllTime||e.isEmpty)return null;const{start:i,end:n}=e;switch(t){case"cumulative-from-end":case"instant":return a.isSome(i)?[i.getTime()]:null;case"cumulative-from-start":return a.isSome(n)?[n.getTime()]:null;case"time-window":return a.isSome(i)&&a.isSome(n)?[i.getTime(),n.getTime()]:null}}},{key:"values",get:function(){r.deprecatedProperty(C,"values",{replacement:"timeExtent",version:"4.20"});const{mode:t,timeExtent:e}=this;if(a.isNone(e))return null;if(e.isAllTime)return"time-window"===t?[null,null]:[null];if(e.isEmpty)return"time-window"===t?[void 0,void 0]:[void 0];const{start:i,end:n}=e;switch(t){case"time-window":return[i,n];case"instant":case"cumulative-from-end":return[i];case"cumulative-from-start":return[n]}},set:function(t){if(r.deprecatedProperty(C,"values",{replacement:"timeExtent",version:"4.20"}),a.isNone(t))return void(this.timeExtent=null);const e=t[0];if(a.isNone(e))return void(this.timeExtent=new i({start:e,end:e}));const n=t.length>1&&t[1];switch(this.mode){case"time-window":return void(this.timeExtent=new i({start:e,end:n}));case"instant":return void(this.timeExtent=new i({start:e,end:e}));case"cumulative-from-end":return void(this.timeExtent=new i({start:e,end:null}));case"cumulative-from-start":return void(this.timeExtent=new i({start:null,end:e}))}}}]),n}(o.HandleOwner);return e.__decorate([c.property()],N.prototype,"_animationController",void 0),e.__decorate([c.property()],N.prototype,"_loadingWebDocument",void 0),e.__decorate([c.property({readOnly:!0})],N.prototype,"effectiveStops",null),e.__decorate([c.property({type:i,value:null})],N.prototype,"fullTimeExtent",null),e.__decorate([c.property({nonNullable:!0,value:!1})],N.prototype,"loop",null),e.__decorate([c.property({nonNullable:!0,value:"time-window"})],N.prototype,"mode",null),e.__decorate([c.property({nonNullable:!0,value:1e3})],N.prototype,"playRate",null),e.__decorate([c.property({readOnly:!0})],N.prototype,"state",null),e.__decorate([c.property({cast:t=>a.isNone(t)?null:(g(t)&&(t.interval=p.ensureType(n,t.interval)),(g(t)||w(t))&&(t.timeExtent=p.ensureType(i,t.timeExtent)),t),value:{count:10}})],N.prototype,"stops",null),e.__decorate([c.property({type:i,value:null})],N.prototype,"timeExtent",null),e.__decorate([c.property({readOnly:!0})],N.prototype,"timeExtentValues",null),e.__decorate([c.property({value:null})],N.prototype,"values",null),e.__decorate([c.property()],N.prototype,"view",void 0),e.__decorate([c.property()],N.prototype,"next",null),e.__decorate([c.property()],N.prototype,"play",null),e.__decorate([c.property()],N.prototype,"previous",null),e.__decorate([c.property()],N.prototype,"stop",null),e.__decorate([c.property()],N.prototype,"updateWebDocument",null),N=e.__decorate([f.subclass("esri.widgets.TimeSlider.TimeSliderViewModel")],N),N}));
