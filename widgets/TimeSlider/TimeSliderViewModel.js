/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["require","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../TimeExtent","../../TimeInterval","../../core/Collection","../../core/Evented","../../core/HandleOwner","../../core/Logger","../../core/maybe","../../core/promiseUtils","../../core/reactiveUtils","../../core/timeUtils","../../core/accessorSupport/decorators/property","../../core/arrayUtils","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass","../../webdoc/Widgets","../../webdoc/widgets/TimeSlider"],(function(t,e,i,n,o,r,s,l,a,u,m,p,c,d,h,f,_,y,w){"use strict";const g=1e4;function T(t){return u.isSome(t)&&void 0!==t.count}function v(t){return u.isSome(t)&&void 0!==t.interval}function x(t){return u.isSome(t)&&void 0!==t.dates}function E(t){return"esri.WebMap"===t.declaredClass}let S=function(i){function o(t){var e;return(e=i.call(this,t)||this)._animationController=null,e._isViewTimeExtentInitialized=!1,e._timerId=null,e.actions=new r,e.fullTimeExtent=null,e.loop=!1,e.mode="time-window",e.stops={count:10},e.timeExtent=null,e.view=null,e}e._inheritsLoose(o,i);var s=o.prototype;return s.initialize=function(){this.handles.add([p.watch((()=>this.effectiveStops),(()=>{u.isNone(this.timeExtent)&&(this.timeExtent=this._getDefaultTimeExtent())}),p.initial),p.watch((()=>this.view),((t,e)=>{this._unregisterWidget(e),this._registerWidget(t)}),p.syncAndInitial),p.watch((()=>this.timeExtent),(t=>{if(u.isNone(this.view))return;const e=this.view.timeExtent;(u.isNone(t)||t.isAllTime)&&(u.isNone(e)||e.isAllTime)||u.isSome(t)&&u.isSome(e)&&t.equals(e)||(this.view.timeExtent=u.unwrap(t))}),p.initial),p.watch((()=>u.applySome(this.view,(t=>t.timeExtent))),(t=>{this._isViewTimeExtentInitialized?(u.isNone(t)||t.isAllTime)&&(u.isNone(this.timeExtent)||this.timeExtent.isAllTime)||u.isSome(t)&&u.isSome(this.timeExtent)&&t.equals(this.timeExtent)||(this.timeExtent=t):this._isViewTimeExtentInitialized=!0}))])},s.destroy=function(){u.isSome(this._timerId)&&(clearInterval(this._timerId),this._timerId=null),this._unregisterWidget(this.view),this.view=null,u.isSome(this._animationController)&&(this._animationController.abort(),this._animationController=null)},o.getPropertiesFromWebMap=function(){var i=e._asyncToGenerator((function*(e,i){if(u.isNone(e)||!E(e))return null;yield e.load({signal:i});const n=e?.widgets?.timeSlider;if(!n)return null;const{getFullTimeExtentFromWebDocument:o,getModeFromTimeSlider:r,getStopsFromTimeSlider:s,getTimeExtentFromTimeSlider:l}=yield new Promise(((e,i)=>t(["./utils"],e,i))),a=yield o(e,i),m=n.loop,p=r(n);return{fullTimeExtent:a,loop:m,mode:p,playRate:n.stopDelay??2e3,stops:s(n),timeExtent:l(n,p)}}));function n(t,e){return i.apply(this,arguments)}return n}(),s.next=function(){this._step({forward:!0,allowRestart:!1})},s.play=function(){this._startAnimation()},s.previous=function(){this._step({forward:!1,allowRestart:!1})},s.stop=function(){this._stopAnimation()},s.triggerAction=function(t){this.emit("trigger-action",{action:t})},s.updateWebDocument=function(t){if(E(t)){const e=new w({currentTimeExtent:this.timeExtent,fullTimeExtent:this.fullTimeExtent,loop:this.loop,numStops:T(this.stops)?this.stops.count:null,numThumbs:"time-window"===this.mode?2:1,stopDelay:this.playRate,stopInterval:v(this.stops)?this.stops.interval:null,stops:x(this.stops)?this.stops.dates:null});t.widgets?t.widgets.timeSlider=e:t.widgets=new y({timeSlider:e})}},s.valuesToTimeExtent=function(t){if(u.isNone(t))return null;const e=t.sort(((t,e)=>t-e)).map((t=>new Date(t))),i=e.length>0?e[0]:null,o=e.length>1?e[1]:null;switch(this.mode){case"time-window":return new n({start:i,end:o});case"instant":return new n({start:i,end:i});case"cumulative-from-start":return new n({start:null,end:i});case"cumulative-from-end":return new n({start:i,end:null});default:return n.allTime}},s._animate=function(){var t=e._asyncToGenerator((function*(){try{const t=this.view,e=u.applySome(this._animationController,(t=>t.signal));yield Promise.all([m.after(this.playRate,null,e),u.isSome(t)&&p.whenOnce((()=>!1===t.updating),e)])}catch(t){return m.isAbortError(t)||a.getLogger(this.declaredClass).error(t),void(this._animationController=null)}this._step({forward:!0,allowRestart:!1}),u.isNone(this._animationController)||this._animate()}));function i(){return t.apply(this,arguments)}return i}(),s._divideTimeExtentByCount=function(t,e=10){if(!t||!e)return[];const{start:i,end:n}=t;if(u.isNone(i)||u.isNone(n))return[];if(e>g)return this._divideTimeExtentByCount(t);const o=[],r=i.getTime(),s=n.getTime()-r;for(let l=0;l<=e;l++)o.push(new Date(r+l/e*s));return o},s._divideTimeExtentByInterval=function(t,e,i=g){if(!t||!e)return[];const{start:n,end:o}=t;if(u.isNone(n)||u.isNone(o))return[];const r=o.getTime()-n.getTime(),s=e.toMilliseconds();if(s<=0||r/s>i)return this._divideTimeExtentByCount(t);const l=[],{value:a,unit:m}=e;let p=n;for(;p.getTime()<=o.getTime();)l.push(new Date(p.getTime())),p=c.offsetDate(p,a,m);return l},s._getDefaultTimeExtent=function(){const{effectiveStops:t,mode:e}=this;if(u.isNone(t)||!e)return null;switch(e){case"time-window":return t.length>1?new n({start:t[0],end:t[1]}):null;case"cumulative-from-start":return t.length>0?new n({start:null,end:t[0]}):null;case"cumulative-from-end":return t.length>0?new n({start:t[0],end:null}):null;case"instant":return t.length>0?new n({start:t[0],end:t[0]}):null;default:return null}},s._registerWidget=function(t){if(u.isSome(t)){t.persistableViewModels.includes(this)||t.persistableViewModels.add(this)}},s._startAnimation=function(){this._stopAnimation(),this._animationController=new AbortController,this._step({forward:!0,allowRestart:!0}),this._animate()},s._step=function(t){const{forward:e,allowRestart:i}=t,{effectiveStops:n}=this;if(u.isNone(this.timeExtentValues)||u.isNone(n))return;const o=n.map((t=>t.getTime())),r=this.timeExtentValues.map((t=>{const e=o.indexOf(t);if(-1!==e)return e;const i=o.reduce(((e,i)=>Math.abs(i-t)<Math.abs(e-t)?i:e));return o.indexOf(i)})),s=r.map((t=>t+(e?1:-1))),l=s.some((t=>t<0||t>o.length-1)),{loop:a,state:m}=this;if(l)if(a||i){const t=Math.min(...r),i=Math.max(...r),n=(e?r.map((e=>e-t)):r.map((t=>t+(o.length-1-i)))).map((t=>o[t]));this.timeExtent=this.valuesToTimeExtent(n)}else"playing"===m&&this.stop();else{const t=s.map((t=>o[t]));this.timeExtent=this.valuesToTimeExtent(t)}},s._stopAnimation=function(){u.isSome(this._animationController)&&(this._animationController.abort(),this._animationController=null)},s._unregisterWidget=function(t){u.isSome(t)&&t.persistableViewModels.remove(this)},e._createClass(o,[{key:"effectiveStops",get:function(){const{fullTimeExtent:t,stops:e}=this;if(x(e)){const{dates:i}=e;if(null==i||0===i.length)return null;const n=i.sort(((t,e)=>t.getTime()-e.getTime()));if(u.isNone(t))return n;const{start:o,end:r}=t;if(u.isNone(o)||u.isNone(r))return n;return n.filter((t=>!(t.getTime()<o.getTime()||t.getTime()>r.getTime())))}if(T(e)){const i=e.timeExtent??u.unwrap(t);return this._divideTimeExtentByCount(i,e.count)}if(v(e)){const i=e.timeExtent??u.unwrap(t);return this._divideTimeExtentByInterval(i,e.interval)}return[]}},{key:"playRate",set:function(t){t<=0||t>36e5||("playing"===this.state&&this._startAnimation(),this._set("playRate",t))}},{key:"state",get:function(){return u.isNone(this.fullTimeExtent)?"disabled":u.isSome(this._animationController)?"playing":"ready"}},{key:"timeExtentValues",get:function(){const{mode:t,timeExtent:e}=this;if(u.isNone(e)||e.isAllTime||e.isEmpty)return null;const{start:i,end:n}=e;switch(t){case"cumulative-from-end":case"instant":return u.isSome(i)?[i.getTime()]:null;case"cumulative-from-start":return u.isSome(n)?[n.getTime()]:null;case"time-window":return u.isSome(i)&&u.isSome(n)?[i.getTime(),n.getTime()]:null}}}]),o}(l.HandleOwnerMixin(s.EventedAccessor));i.__decorate([d.property()],S.prototype,"_animationController",void 0),i.__decorate([d.property({type:r})],S.prototype,"actions",void 0),i.__decorate([d.property({readOnly:!0})],S.prototype,"effectiveStops",null),i.__decorate([d.property({type:n})],S.prototype,"fullTimeExtent",void 0),i.__decorate([d.property({nonNullable:!0})],S.prototype,"loop",void 0),i.__decorate([d.property({nonNullable:!0})],S.prototype,"mode",void 0),i.__decorate([d.property({nonNullable:!0,value:1e3})],S.prototype,"playRate",null),i.__decorate([d.property({readOnly:!0})],S.prototype,"state",null),i.__decorate([d.property({cast:t=>u.isNone(t)?null:(v(t)&&(t.interval=f.ensureType(o,t.interval)),(v(t)||T(t))&&(t.timeExtent=f.ensureType(n,t.timeExtent)),t)})],S.prototype,"stops",void 0),i.__decorate([d.property({type:n})],S.prototype,"timeExtent",void 0),i.__decorate([d.property({readOnly:!0})],S.prototype,"timeExtentValues",null),i.__decorate([d.property()],S.prototype,"view",void 0),i.__decorate([d.property()],S.prototype,"next",null),i.__decorate([d.property()],S.prototype,"play",null),i.__decorate([d.property()],S.prototype,"previous",null),i.__decorate([d.property()],S.prototype,"stop",null),i.__decorate([d.property()],S.prototype,"updateWebDocument",null),S=i.__decorate([_.subclass("esri.widgets.TimeSlider.TimeSliderViewModel")],S);return S}));
