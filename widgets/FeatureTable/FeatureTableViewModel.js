/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../Graphic","../../intl","../../core/Collection","../../core/HandleOwner","../../core/Handles","../../core/watchUtils","../../core/accessorSupport/decorators/property","../../core/arrayUtils","../../core/has","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass","../../views/support/layerViewUtils","./AttachmentsColumn","./FieldColumn","./Grid/Grid","./Grid/GridViewModel","./support/FeatureStore","../../intl/locale","../../intl/messages"],(function(e,t,s,r,i,o,n,l,a,d,h,c,u,g,m,p,y,f,_,v,C){"use strict";let b=function(t){function r(s){var r;(r=t.call(this,s)||this)._defaultHiddenFields=["CreationDate","Creator","EditDate","Editor","GlobalID"],r._highlights=new n,r.cellClassNameGenerator=(e,t)=>e.path||null,r.dataProvider=function(){var t=e._asyncToGenerator((function*(t,s){const{store:i}=e._assertThisInitialized(r),{page:o,pageSize:n,sortOrders:l}=t,a=r._sortOrdersToLayerOrderByFields(l);s&&(i?(yield i.set({orderByFields:a}),"loaded"!==i.state&&"loading"!==i.state&&(yield i.load()),s&&s(yield i.fetchItems({page:o,pageSize:n}))):s&&s([]))}));return function(e,s){return t.apply(this,arguments)}}(),r.editingEnabled=!1,r.grid=null,r.hiddenFields=new i,r.highlightOnRowSelectEnabled=!0,r.itemIdPath="objectId",r.messagesCommon=null,r.relatedRecordsEnabled=!1,r.store=null,r.view=null;const{hiddenFields:o,itemIdPath:l}=e._assertThisInitialized(r);return o.addMany(r._defaultHiddenFields),r._set("store",new _),r._set("grid",new y({itemIdPath:l,viewModel:e._assertThisInitialized(r)})),r}e._inheritsLoose(r,t);var o=r.prototype;return o.initialize=function(){var t=this;const s=function(){var s=e._asyncToGenerator((function*(){t.messages=yield C.fetchMessageBundle("esri/widgets/FeatureTable/t9n/FeatureTable"),t.messagesCommon=yield C.fetchMessageBundle("esri/t9n/common")}));return function(){return s.apply(this,arguments)}}();s(),this.handles.add([v.onLocaleChange(s),l.on(this,"grid.selectedItems","change",(e=>this._onSelectionChange(e))),l.watch(this,"relatedRecordsEnabled",(e=>this.store.relatedRecordsEnabled=e)),l.watch(this,["layer.loaded"],(()=>{var e;null!=(e=this.layer)&&e.loaded&&this._onLayerLoad()})),l.watch(this.store,"state",(e=>{var t;"loaded"===e&&(null==(t=this.grid)||t.scrollToTop())})),l.watch(this,["editingEnabled","messages"],(()=>{var e;return(null==(e=this.layer)?void 0:e.loaded)&&this._generateColumns()})),l.watch(this,"layer.definitionExpression",((e,t)=>(e||t)&&"loaded"===this.store.state&&this.refresh()))])},o.destroy=function(){var e,t;this._resetColumns(),this.handles.removeAll(),this._highlights.removeAll(),this._highlights.destroy(),null==(e=this.grid)||e.destroy(),null==(t=this.columns)||t.destroy(),this.layer=null,this.view=null},o.clearHighlights=function(){this._highlights.removeAll()},o.clearSelection=function(){var e;null==(e=this.grid)||e.clearSelection()},o.deselectRows=function(e){const t=this._getStoreItemsFromSelectionParams(e);this.grid.deselectRows(t)},o.getObjectIdIndex=function(e){var t;return null==(t=this.store)?void 0:t.getObjectIdIndex(e)},o.getValue=function(e,t){var s;const r=this.store.getItemByObjectId(e);return null==r||null==(s=r.feature)?void 0:s.attributes[t]},o.refresh=function(){var e;null==(e=this.grid)||e.refresh()},o.selectRows=function(e){const t=this._getStoreItemsFromSelectionParams(e);this.grid.selectRows(t)},o.scrollToIndex=function(e){var t;null==(t=this.grid)||t.scrollToIndex(e)},o._onLayerLoad=function(){const e=this.layer.capabilities.query.maxRecordCount;e&&e<this.pageSize&&this.grid&&(this.grid.pageSize=e),this._generateColumns()},o._generateColumns=function(){this._resetColumns(),this.columns.addMany([...this._createFieldColumns()]),this.attachmentsEnabled&&this.columns.push(this._createAttachmentsColumn())},o._createFieldColumns=function(){return this.fieldConfigs&&this.fieldConfigs.length?this._createColumnsFromConfigs():this._createColumnsFromFields()},o._createColumnsFromConfigs=function(){var e,t;const{editingEnabled:s,fieldConfigs:r,grid:i,hiddenFields:o,layer:n,messages:l,messagesCommon:a,store:d}=this,h=null!=(e=null==(t=this.layer)?void 0:t.fields)?e:[];return r.filter((e=>(h||[]).find((t=>e.name===t.name)))).map((e=>{const t=e.direction||null,r=e.formatFunction||null,c=e.textAlign||null,u=(h||[]).find((t=>e.name===t.name)),g=!1===e.visible||!0!==e.visible&&o.indexOf(u.name)>-1;return new p({config:e,direction:t,editingEnabled:s,field:u,formatFunction:r,grid:i,hidden:g,layer:n,store:d,messages:l,messagesCommon:a,textAlign:c})}))},o._createColumnsFromFields=function(){var e,t;const{editingEnabled:s,grid:r,hiddenFields:i,layer:o,messages:n,messagesCommon:l,store:a}=this;return(null!=(e=null==(t=this.layer)?void 0:t.fields)?e:[]).map((e=>{const t=i.indexOf(e.name)>-1;return new p({editingEnabled:s,field:e,grid:r,hidden:t,layer:o,store:a,messages:n,messagesCommon:l})}))},o._createAttachmentsColumn=function(){var e;return new m({header:null==(e=this.messages)?void 0:e.attachments})},o._sortOrdersToLayerOrderByFields=function(e){return e&&e.length?e.filter(((e,t,s)=>s.map((e=>e.path)).indexOf(e.path)===t)).map((({direction:e,path:t})=>e?t+" "+e.toUpperCase():"")):[]},o._highlight=function(e){const{view:t}=this,s=t&&e&&t.allLayerViews.items.find((({layer:t})=>t===e.layer));g.highlightsSupported(s)&&this._highlights.add(s.highlight(e),`feature-${e.getObjectId()}`)},o._unhighlight=function(e){e&&this._highlights.remove(`feature-${e.getObjectId()}`)},o._getStoreItemsFromSelectionParams=function(e){const t=[];return(e=e instanceof Array?e:[e]).forEach((e=>{let r=e instanceof s?e:null;const i=r?r.getObjectId():e;if("number"==typeof i||"string"==typeof i){if(!r){const e=this.store.getItemByObjectId(i);e&&(r=e.feature)}t.push({objectId:i,feature:r})}})),t},o._onSelectionChange=function(e){const{highlightOnRowSelectEnabled:t}=this,{added:s,removed:r}=e;t&&s.forEach((e=>this._highlight(e.feature))),t&&r.forEach((e=>this._unhighlight(e.feature)))},o._resetColumns=function(){this.columns.items.forEach((e=>e.destroy())),this.columns.removeAll()},e._createClass(r,[{key:"attachmentsEnabled",set:function(e){this.attachmentsEnabled!==e&&(this._set("attachmentsEnabled",e),this._generateColumns(),this.store.attachmentsEnabled=e)}},{key:"fieldConfigs",set:function(e){var t;this._set("fieldConfigs",e),(null==(t=this.layer)?void 0:t.loaded)&&this._generateColumns()}},{key:"filterGeometry",set:function(e){(this.filterGeometry||e)&&(this.clearSelection(),this._set("filterGeometry",e),this.store.filterGeometry=e)}},{key:"layer",set:function(e){var t;this._set("layer",e),null==(t=this.grid)||t.clearSort(),this._resetColumns(),this.store.layer=e,e&&(e.loaded?this._onLayerLoad():e.load()),this.notifyChange("state")}},{key:"messages",set:function(e){var t;null==(t=this.grid)||t.set("messages",e),this._set("messages",e)}}]),r}(o.HandleOwnerMixin(f));t.__decorate([a.property()],b.prototype,"attachmentsEnabled",null),t.__decorate([a.property()],b.prototype,"cellClassNameGenerator",void 0),t.__decorate([a.property()],b.prototype,"dataProvider",void 0),t.__decorate([a.property()],b.prototype,"editingEnabled",void 0),t.__decorate([a.property()],b.prototype,"fieldConfigs",null),t.__decorate([a.property()],b.prototype,"filterGeometry",null),t.__decorate([a.property({readOnly:!0})],b.prototype,"grid",void 0),t.__decorate([a.property()],b.prototype,"hiddenFields",void 0),t.__decorate([a.property()],b.prototype,"highlightOnRowSelectEnabled",void 0),t.__decorate([a.property({readOnly:!0})],b.prototype,"itemIdPath",void 0),t.__decorate([a.property()],b.prototype,"layer",null),t.__decorate([a.property()],b.prototype,"messages",null),t.__decorate([a.property()],b.prototype,"messagesCommon",void 0),t.__decorate([a.property()],b.prototype,"relatedRecordsEnabled",void 0),t.__decorate([a.property({readOnly:!0,type:_})],b.prototype,"store",void 0),t.__decorate([a.property()],b.prototype,"view",void 0),b=t.__decorate([u.subclass("esri.widgets.FeatureTable.FeatureTableViewModel")],b);return b}));
