/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../Graphic","../../intl","../../core/Collection","../../core/HandleOwner","../../core/Handles","../../core/maybe","../../core/promiseUtils","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/arrayUtils","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass","../../views/support/layerViewUtils","./AttachmentsColumn","./FieldColumn","./Grid/Column","./Grid/Grid","./Grid/GridViewModel","./Grid/GroupColumn","./support/FeatureStore","../support/widgetUtils","../support/decorators/messageBundle","../../intl/locale","../../intl/messages"],(function(e,t,i,s,r,n,o,l,a,h,d,c,g,u,m,p,y,f,_,b,v,I,w,C,E,F){"use strict";let T=function(t){function s(i){var s;(s=t.call(this,i)||this)._debounceRefresh=a.debounce((()=>s._refresh())),s._defaultHiddenFields=["CreationDate","Creator","EditDate","Editor","GlobalID"],s._highlights=new o,s.activeFilters=new r,s.autoRefreshEnabled=!0,s.cellClassNameGenerator=(e,t)=>e.path||null,s.columns=new r,s.dataProvider=function(){var t=e._asyncToGenerator((function*(t,i){const{store:r}=e._assertThisInitialized(s),{page:n,pageSize:o,sortOrders:l}=t,a=s._sortOrdersToLayerOrderByFields(l);i&&(r?(yield r.set({orderByFields:a}),"loaded"!==r.state&&"loading"!==r.state&&(yield r.load()),i&&i(yield r.fetchItems({page:n,pageSize:o}))):i&&i([]))}));return function(e,i){return t.apply(this,arguments)}}(),s.editingEnabled=!1,s.fieldConfigs=null,s.grid=null,s.highlightEnabled=!0,s.itemIdPath="objectId",s.messagesCommon=null,s.messagesURIUtils=null,s.relatedRecordsEnabled=!1,s.store=null,s.tableTemplate=null,s.view=null;const{hiddenFields:n,itemIdPath:l}=e._assertThisInitialized(s);return n.addMany(s._defaultHiddenFields),s._onLayerRefresh=s._onLayerRefresh.bind(e._assertThisInitialized(s)),s._set("store",new I),s._set("grid",new _({itemIdPath:l,viewModel:e._assertThisInitialized(s)})),s}e._inheritsLoose(s,t);var n=s.prototype;return n.initialize=function(){var t=this;const i=function(){var i=e._asyncToGenerator((function*(){t.messages=yield F.fetchMessageBundle("esri/widgets/FeatureTable/t9n/FeatureTable"),t.messagesCommon=yield F.fetchMessageBundle("esri/t9n/common"),t.messagesURIUtils=yield F.fetchMessageBundle("esri/widgets/support/t9n/uriUtils")}));return function(){return i.apply(this,arguments)}}();i(),this.handles.add([E.onLocaleChange((()=>{i(),this._generateColumns()})),h.on((()=>this.highlightIds),"change",(e=>this._onHighlightIdsChange(e)),{onListenerAdd:()=>{this.highlightIds.forEach((e=>this._highlight(e)))},onListenerRemove:()=>{this.highlightIds.forEach((e=>this._unhighlight(e)))}}),h.watch((()=>this.layerView),(()=>{this._highlights.removeAll(),this.layerView&&this.highlightEnabled&&this.highlightIds?.forEach((e=>this._highlight(e)))})),h.watch((()=>this.highlightEnabled),(()=>{this._highlights.removeAll(),this.highlightEnabled&&this.highlightIds?.forEach((e=>this._highlight(e)))})),h.watch((()=>this.relatedRecordsEnabled),(e=>this.store.relatedRecordsEnabled=e)),h.watch((()=>this.layer?.loaded),(e=>e&&this._onLayerLoad())),h.watch((()=>this.store.state),(e=>{"loaded"===e&&this.grid?.scrollToTop()})),h.watch((()=>[this.messages,this.tableTemplate,this.fieldConfigs]),(()=>this.layer?.loaded&&this._generateColumns())),h.watch((()=>this.editingEnabled),(e=>this.columns.forEach((t=>{"editingEnabled"in t&&(t.editingEnabled=e)})))),h.watch((()=>this.layer?.definitionExpression),((e,t)=>(e||t)&&"loaded"===this.store.state&&this.reset())),h.watch((()=>this.layer&&"timeExtent"in this.layer&&this.layer.timeExtent),((e,t)=>(e||t)&&!this.timeExtent&&"loaded"===this.store.state&&this.reset())),h.on((()=>this.layer),"refresh",(e=>this._onLayerRefresh(e)))])},n.destroy=function(){this._resetColumns(),this.handles.removeAll(),this._highlights.removeAll(),this._highlights.destroy(),this.grid?.destroy(),this.columns?.destroy(),this.layer=null,this.view=null},n.clearHighlights=function(){this._highlights.removeAll()},n.clearSelection=function(){this.grid?.clearSelection()},n.deleteSelection=function(){var t=e._asyncToGenerator((function*(){const e=this.highlightIds.toArray();if(!e?.length)return;const{deleteFeatureResults:t}=yield this.store.deleteRowsByObjectId(e),i=t.filter((e=>!e.error)).map((e=>e.objectId));i.length&&(this.deselectRows(i),yield this.refresh())}));function i(){return t.apply(this,arguments)}return i}(),n.deselectRows=function(e){const t=this._getStoreItemsFromSelectionParams(e);this.grid.deselectRows(t)},n.filterBySelection=function(){const e=this.highlightIds.toArray();e.length&&(this.clearSelectionFilter(),this.store.objectIds=e,this.activeFilters.add({type:"selection",objectIds:e}))},n.getObjectIdIndex=function(e){return this.store?.getObjectIdIndex(e)},n.getValue=function(e,t){return this.store.getItemByObjectId(e)?.feature?.attributes[t]},n.refresh=function(){var t=e._asyncToGenerator((function*(){return a.ignoreAbortErrors(this._debounceRefresh())}));function i(){return t.apply(this,arguments)}return i}(),n.reset=function(){this.grid.reset()},n.selectRows=function(e){const t=this._getStoreItemsFromSelectionParams(e);return this.grid.selectRows(t)},n.scrollToIndex=function(e){this.grid?.scrollToIndex(e)},n.clearSelectionFilter=function(){this.store.objectIds=null;const e=this.activeFilters.find((e=>"selection"===e.type));e&&this.activeFilters.remove(e)},n.zoomToSelection=function(){const{layer:e,view:t}=this,i=this.highlightIds.toArray();if(!e||!t||!i.length)return;const s=e.createQuery();s.objectIds=i,s.returnGeometry=!0,e.queryFeatures(s).then((e=>{t.goTo(e.features).catch((e=>{"AbortError"!==e.name&&console.error(e)}))}))},n._refresh=function(){var t=e._asyncToGenerator((function*(){yield this.store.refreshLayerInfo();const e=this.highlightIds.toArray();if(e.length){(yield this.store.verifyFeaturesByObjectId(e)).forEach(((t,i)=>{t||this.deselectRows(e[i])}))}this.grid.refreshPageCache()}));function i(){return t.apply(this,arguments)}return i}(),n._onLayerLoad=function(){const e=this.layer.capabilities.query.maxRecordCount;e&&e<this.pageSize&&this.grid&&(this.grid.pageSize=e),this._generateColumns()},n._onLayerRefresh=function(e){this.autoRefreshEnabled&&e.dataChanged&&this.refresh()},n._generateColumns=function(){this._resetColumns();const e=[],t=this.tableTemplate?.columnTemplates?this._generateColumnsFromTemplates(this.tableTemplate.columnTemplates):this.fieldConfigs?.length?this._generateColumnsFromConfigs():this._generateDefaultFieldColumns();e.push(...t),this.attachmentsEnabled&&e.push(this._generateDefaultAttachmentColumn()),this.columns.addMany([...e])},n._generateColumnsFromTemplates=function(e){const{editingEnabled:t,grid:i,hiddenFields:s,layer:r,messages:n,messagesCommon:o,messagesURIUtils:l,store:a,tableTemplate:h}=this,d=this.layer?.fields??[];return e.filter((e=>(d||[]).find((t=>"fieldName"in e&&e.fieldName===t.name))||"group"===e.type&&"columnTemplates"in e)).map((e=>{if("fieldName"in e){const c=(d||[]).find((t=>e.fieldName===t.name)),g=!1===e.visible||!0!==e.visible&&s.includes(c.name),{direction:u,formatFunction:m,initialSortPriority:p,menuConfig:f,textAlign:_}=e,b=h.expressionInfos||null;return new y({direction:u,editingEnabled:t,expressionInfos:b,field:c,formatFunction:m,grid:i,hidden:g,initialSortPriority:p,layer:r,messages:n,messagesCommon:o,messagesURIUtils:l,menuConfig:f,store:a,template:e,textAlign:_})}if("group"===e.type&&"columnTemplates"in e){const t=this._generateColumnsFromTemplates(e.columnTemplates),i=!1===e.visible||!0!==e.visible&&s.includes(e.label),{label:r}=e;return new v({header:r,columns:t,hidden:i})}return new f({...e})}))},n._generateColumnsFromConfigs=function(){const{editingEnabled:e,fieldConfigs:t,grid:i,hiddenFields:s,layer:r,messages:n,messagesCommon:o,messagesURIUtils:a,store:h}=this,d=this.layer?.fields??[];return t.filter((e=>(d||[]).find((t=>e.name===t.name)))).map((t=>{const c=t.direction||null,g=t.formatFunction||null,u=t.textAlign||null,m=l.isSome(t.initialSortPriority)?t.initialSortPriority:null,p=(d||[]).find((e=>t.name===e.name)),f=!1===t.visible||!0!==t.visible&&s.includes(p.name),_=t.menuConfig||null;return new y({config:t,direction:c,editingEnabled:e,field:p,formatFunction:g,grid:i,hidden:f,layer:r,store:h,messages:n,messagesCommon:o,messagesURIUtils:a,menuConfig:_,textAlign:u,initialSortPriority:m})}))},n._generateDefaultFieldColumns=function(){const{editingEnabled:e,grid:t,hiddenFields:i,layer:s,messages:r,messagesCommon:n,messagesURIUtils:o,store:l}=this;return(this.layer?.fields??[]).map((a=>{const h=i.includes(a.name);return new y({editingEnabled:e,field:a,grid:t,hidden:h,layer:s,store:l,messages:r,messagesCommon:n,messagesURIUtils:o})}))},n._generateDefaultAttachmentColumn=function(){return new p({header:this.messages?.attachments})},n._sortOrdersToLayerOrderByFields=function(e){return e&&e.length?e.filter(((e,t,i)=>i.map((e=>e.path)).indexOf(e.path)===t)).filter((({direction:e})=>!!e)).map((({direction:e,path:t})=>t+" "+e.toUpperCase())):[]},n._highlight=function(e){this.layerView&&m.highlightsSupported(this.layerView)&&this._highlights.add(this.layerView.highlight(e),e)},n._unhighlight=function(e){this._highlights.remove(e)},n._getStoreItemsFromSelectionParams=function(e){const t=[];return(e=e instanceof Array?e:[e]).forEach((e=>{let s=e instanceof i?e:null;const r=s?s.getObjectId():e;if("number"==typeof r||"string"==typeof r){if(!s){const e=this.store.getItemByObjectId(r);e&&(s=e.feature)}t.push({objectId:r,feature:s})}})),t},n._onHighlightIdsChange=function(e){const{highlightEnabled:t}=this,{added:i,removed:s}=e;t&&(i.forEach((e=>this._highlight(e))),s.forEach((e=>this._unhighlight(e))))},n._resetColumns=function(){this.columns.items.forEach((e=>e.destroy())),this.columns.removeAll()},e._createClass(s,[{key:"activeSortOrders",get:function(){return this.grid?.sortOrders?this.grid.sortOrders.map((({path:e,direction:t})=>({fieldName:e,direction:t}))):[]}},{key:"attachmentsEnabled",set:function(e){this.attachmentsEnabled!==e&&(this._set("attachmentsEnabled",e),this._generateColumns(),this.store.attachmentsEnabled=e)}},{key:"filterGeometry",set:function(e){if(!this.filterGeometry&&!e)return;const t=this.activeFilters.find((e=>"geometry"===e.type));t&&this.activeFilters.remove(t),this._set("filterGeometry",e),this.store.filterGeometry=e,e&&this.activeFilters.add({type:"geometry",geometry:e})}},{key:"hiddenFields",get:function(){return this._get("hiddenFields")||new r},set:function(e){Array.isArray(e)?this._set("hiddenFields",new r(e)):this._set("hiddenFields",e)}},{key:"highlightOnRowSelectEnabled",get:function(){return this.highlightEnabled},set:function(e){this.highlightEnabled=e}},{key:"layer",set:function(e){this._set("layer",e),this.grid?.clearSort(),this._resetColumns(),this.store.layer=e,e&&(e.loaded?this._onLayerLoad():e.load()),this.notifyChange("state")}},{key:"layerView",get:function(){return this.view?.allLayerViews.find((e=>e.layer===this.layer))||null}},{key:"messages",set:function(e){this.grid?.set("messages",e),this._set("messages",e)}},{key:"state",get:function(){const{store:e}=this;return e&&"disabled"!==e.state?"loading"===e.state?"loading":"loaded"===e.state?"loaded":"ready":"disabled"}},{key:"timeExtent",set:function(e){this._set("timeExtent",e),this.store.timeExtent=e}},{key:"highlightIds",get:function(){return this._get("highlightIds")||new r},set:function(e){Array.isArray(e)?this._set("highlightIds",new r(e)):this._set("highlightIds",e)}}]),s}(n.HandleOwnerMixin(b));t.__decorate([d.property({readOnly:!0})],T.prototype,"activeFilters",void 0),t.__decorate([d.property({readOnly:!0})],T.prototype,"activeSortOrders",null),t.__decorate([d.property()],T.prototype,"attachmentsEnabled",null),t.__decorate([d.property()],T.prototype,"autoRefreshEnabled",void 0),t.__decorate([d.property()],T.prototype,"cellClassNameGenerator",void 0),t.__decorate([d.property({readOnly:!0})],T.prototype,"columns",void 0),t.__decorate([d.property()],T.prototype,"dataProvider",void 0),t.__decorate([d.property()],T.prototype,"editingEnabled",void 0),t.__decorate([d.property()],T.prototype,"fieldConfigs",void 0),t.__decorate([d.property()],T.prototype,"filterGeometry",null),t.__decorate([d.property({readOnly:!0})],T.prototype,"grid",void 0),t.__decorate([d.property()],T.prototype,"hiddenFields",null),t.__decorate([d.property()],T.prototype,"highlightEnabled",void 0),t.__decorate([d.property()],T.prototype,"highlightOnRowSelectEnabled",null),t.__decorate([d.property({readOnly:!0})],T.prototype,"itemIdPath",void 0),t.__decorate([d.property()],T.prototype,"layer",null),t.__decorate([d.property()],T.prototype,"layerView",null),t.__decorate([d.property()],T.prototype,"messages",null),t.__decorate([d.property(),C.messageBundle("esri/t9n/common")],T.prototype,"messagesCommon",void 0),t.__decorate([d.property(),C.messageBundle("esri/widgets/support/t9n/uriUtils")],T.prototype,"messagesURIUtils",void 0),t.__decorate([d.property()],T.prototype,"relatedRecordsEnabled",void 0),t.__decorate([d.property({readOnly:!0})],T.prototype,"state",null),t.__decorate([d.property({readOnly:!0,type:I})],T.prototype,"store",void 0),t.__decorate([d.property()],T.prototype,"tableTemplate",void 0),t.__decorate([d.property()],T.prototype,"timeExtent",null),t.__decorate([d.property()],T.prototype,"view",void 0),t.__decorate([d.property()],T.prototype,"highlightIds",null),T=t.__decorate([u.subclass("esri.widgets.FeatureTable.FeatureTableViewModel")],T);return T}));
