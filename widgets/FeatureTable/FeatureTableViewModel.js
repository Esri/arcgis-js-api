/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../Graphic","../../intl","../../core/Collection","../../core/HandleOwner","../../core/Handles","../../core/maybe","../../core/promiseUtils","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/arrayUtils","../../core/has","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass","../../views/support/layerViewUtils","./AttachmentsColumn","./FieldColumn","./Grid/Grid","./Grid/GridViewModel","./support/FeatureStore","../../intl/locale","../../intl/messages"],(function(e,t,r,i,s,o,n,a,l,d,c,h,u,g,y,f,p,m,_,v,b,C,F){"use strict";let w=function(t){function i(r){var i;(i=t.call(this,r)||this)._debounceRefresh=l.debounce((()=>i._refresh())),i._defaultHiddenFields=["CreationDate","Creator","EditDate","Editor","GlobalID"],i._highlights=new n,i.activeFilters=new s,i.autoRefreshEnabled=!0,i.cellClassNameGenerator=(e,t)=>e.path||null,i.dataProvider=function(){var t=e._asyncToGenerator((function*(t,r){const{store:s}=e._assertThisInitialized(i),{page:o,pageSize:n,sortOrders:a}=t,l=i._sortOrdersToLayerOrderByFields(a);r&&(s?(yield s.set({orderByFields:l}),"loaded"!==s.state&&"loading"!==s.state&&(yield s.load()),r&&r(yield s.fetchItems({page:o,pageSize:n}))):r&&r([]))}));return function(e,r){return t.apply(this,arguments)}}(),i.editingEnabled=!1,i.grid=null,i.hiddenFields=new s,i.highlightOnRowSelectEnabled=!0,i.itemIdPath="objectId",i.messagesCommon=null,i.relatedRecordsEnabled=!1,i.store=null,i.view=null;const{hiddenFields:o,itemIdPath:a}=e._assertThisInitialized(i);return o.addMany(i._defaultHiddenFields),i._onLayerRefresh=i._onLayerRefresh.bind(e._assertThisInitialized(i)),i._set("store",new b),i._set("grid",new _({itemIdPath:a,viewModel:e._assertThisInitialized(i)})),i}e._inheritsLoose(i,t);var o=i.prototype;return o.initialize=function(){var t=this;const r=function(){var r=e._asyncToGenerator((function*(){t.messages=yield F.fetchMessageBundle("esri/widgets/FeatureTable/t9n/FeatureTable"),t.messagesCommon=yield F.fetchMessageBundle("esri/t9n/common")}));return function(){return r.apply(this,arguments)}}();r(),this.handles.add([C.onLocaleChange(r),d.on((()=>this.grid.selectedItems),"change",(e=>this._onSelectionChange(e))),d.watch((()=>this.relatedRecordsEnabled),(e=>this.store.relatedRecordsEnabled=e)),d.watch((()=>{var e;return null==(e=this.layer)?void 0:e.loaded}),(e=>e&&this._onLayerLoad())),d.watch((()=>this.store.state),(e=>{var t;"loaded"===e&&(null==(t=this.grid)||t.scrollToTop())})),d.watch((()=>[this.editingEnabled,this.messages]),(()=>{var e;return(null==(e=this.layer)?void 0:e.loaded)&&this._generateColumns()})),d.watch((()=>{var e;return null==(e=this.layer)?void 0:e.definitionExpression}),((e,t)=>(e||t)&&"loaded"===this.store.state&&this.reset())),d.on((()=>this.layer),"refresh",(e=>this._onLayerRefresh(e)))])},o.destroy=function(){var e,t;this._resetColumns(),this.handles.removeAll(),this._highlights.removeAll(),this._highlights.destroy(),null==(e=this.grid)||e.destroy(),null==(t=this.columns)||t.destroy(),this.layer=null,this.view=null},o.clearHighlights=function(){this._highlights.removeAll()},o.clearSelection=function(){var e;null==(e=this.grid)||e.clearSelection()},o.deselectRows=function(e){const t=this._getStoreItemsFromSelectionParams(e);this.grid.deselectRows(t)},o.filterBySelection=function(){const e=this.grid.getSelectedRowIds();e.length&&(this.clearSelectionFilter(),this.store.objectIds=e,this.activeFilters.add({type:"selection",objectIds:e}))},o.getObjectIdIndex=function(e){var t;return null==(t=this.store)?void 0:t.getObjectIdIndex(e)},o.getValue=function(e,t){var r;const i=this.store.getItemByObjectId(e);return null==i||null==(r=i.feature)?void 0:r.attributes[t]},o.refresh=function(){var t=e._asyncToGenerator((function*(){return l.ignoreAbortErrors(this._debounceRefresh())}));function r(){return t.apply(this,arguments)}return r}(),o.reset=function(){this.grid.reset()},o.selectRows=function(e){const t=this._getStoreItemsFromSelectionParams(e);this.grid.selectRows(t)},o.scrollToIndex=function(e){var t;null==(t=this.grid)||t.scrollToIndex(e)},o.clearSelectionFilter=function(){this.store.objectIds=null;const e=this.activeFilters.find((e=>"selection"===e.type));e&&this.activeFilters.remove(e)},o.zoomToSelection=function(){const{layer:e,view:t}=this,r=this.grid.getSelectedRowIds();if(!e||!t||!r.length)return;const i=e.createQuery();i.objectIds=r,i.returnGeometry=!0,e.queryFeatures(i).then((e=>{t.goTo(e.features).catch((e=>{"AbortError"!==e.name&&console.error(e)}))}))},o._refresh=function(){var t=e._asyncToGenerator((function*(){yield this.store.refreshLayerInfo();const e=this.grid.getSelectedRowIds();if(e.length){(yield this.store.verifyFeaturesByObjectId(e)).forEach(((t,r)=>{t||this.deselectRows(e[r])}))}this.grid.refreshPageCache()}));function r(){return t.apply(this,arguments)}return r}(),o._onLayerLoad=function(){const e=this.layer.capabilities.query.maxRecordCount;e&&e<this.pageSize&&this.grid&&(this.grid.pageSize=e),this._generateColumns()},o._onLayerRefresh=function(e){this.autoRefreshEnabled&&e.dataChanged&&this.refresh()},o._generateColumns=function(){this._resetColumns(),this.columns.addMany([...this._createFieldColumns()]),this.attachmentsEnabled&&this.columns.push(this._createAttachmentsColumn())},o._createFieldColumns=function(){return this.fieldConfigs&&this.fieldConfigs.length?this._createColumnsFromConfigs():this._createColumnsFromFields()},o._createColumnsFromConfigs=function(){var e,t;const{editingEnabled:r,fieldConfigs:i,grid:s,hiddenFields:o,layer:n,messages:l,messagesCommon:d,store:c}=this,h=null!=(e=null==(t=this.layer)?void 0:t.fields)?e:[];return i.filter((e=>(h||[]).find((t=>e.name===t.name)))).map((e=>{const t=e.direction||null,i=e.formatFunction||null,u=e.textAlign||null,g=a.isSome(e.initialSortPriority)?e.initialSortPriority:null,y=(h||[]).find((t=>e.name===t.name)),f=!1===e.visible||!0!==e.visible&&o.indexOf(y.name)>-1;return new m({config:e,direction:t,editingEnabled:r,field:y,formatFunction:i,grid:s,hidden:f,layer:n,store:c,messages:l,messagesCommon:d,textAlign:u,initialSortPriority:g})}))},o._createColumnsFromFields=function(){var e,t;const{editingEnabled:r,grid:i,hiddenFields:s,layer:o,messages:n,messagesCommon:a,store:l}=this;return(null!=(e=null==(t=this.layer)?void 0:t.fields)?e:[]).map((e=>{const t=s.indexOf(e.name)>-1;return new m({editingEnabled:r,field:e,grid:i,hidden:t,layer:o,store:l,messages:n,messagesCommon:a})}))},o._createAttachmentsColumn=function(){var e;return new p({header:null==(e=this.messages)?void 0:e.attachments})},o._sortOrdersToLayerOrderByFields=function(e){return e&&e.length?e.filter(((e,t,r)=>r.map((e=>e.path)).indexOf(e.path)===t)).filter((({direction:e})=>!!e)).map((({direction:e,path:t})=>t+" "+e.toUpperCase())):[]},o._highlight=function(e){const{view:t}=this,r=t&&e&&t.allLayerViews.items.find((({layer:t})=>t===e.layer));f.highlightsSupported(r)&&this._highlights.add(r.highlight(e),`feature-${e.getObjectId()}`)},o._unhighlight=function(e){e&&this._highlights.remove(`feature-${e.getObjectId()}`)},o._getStoreItemsFromSelectionParams=function(e){const t=[];return(e=e instanceof Array?e:[e]).forEach((e=>{let i=e instanceof r?e:null;const s=i?i.getObjectId():e;if("number"==typeof s||"string"==typeof s){if(!i){const e=this.store.getItemByObjectId(s);e&&(i=e.feature)}t.push({objectId:s,feature:i})}})),t},o._onSelectionChange=function(e){const{highlightOnRowSelectEnabled:t}=this,{added:r,removed:i}=e;t&&r.forEach((e=>this._highlight(e.feature))),t&&i.forEach((e=>this._unhighlight(e.feature)))},o._resetColumns=function(){this.columns.items.forEach((e=>e.destroy())),this.columns.removeAll()},e._createClass(i,[{key:"activeSortOrders",get:function(){var e;return(null==(e=this.grid)?void 0:e.sortOrders)||[]}},{key:"attachmentsEnabled",set:function(e){this.attachmentsEnabled!==e&&(this._set("attachmentsEnabled",e),this._generateColumns(),this.store.attachmentsEnabled=e)}},{key:"fieldConfigs",set:function(e){var t;this._set("fieldConfigs",e),(null==(t=this.layer)?void 0:t.loaded)&&this._generateColumns()}},{key:"filterGeometry",set:function(e){if(!this.filterGeometry&&!e)return;const t=this.activeFilters.find((e=>"geometry"===e.type));t&&this.activeFilters.remove(t),this.clearSelection(),this._set("filterGeometry",e),this.store.filterGeometry=e,e&&this.activeFilters.add({type:"geometry",geometry:e})}},{key:"layer",set:function(e){var t;this._set("layer",e),null==(t=this.grid)||t.clearSort(),this._resetColumns(),this.store.layer=e,e&&(e.loaded?this._onLayerLoad():e.load()),this.notifyChange("state")}},{key:"messages",set:function(e){var t;null==(t=this.grid)||t.set("messages",e),this._set("messages",e)}}]),i}(o.HandleOwnerMixin(v));t.__decorate([c.property({readOnly:!0})],w.prototype,"activeFilters",void 0),t.__decorate([c.property({readOnly:!0})],w.prototype,"activeSortOrders",null),t.__decorate([c.property()],w.prototype,"attachmentsEnabled",null),t.__decorate([c.property()],w.prototype,"autoRefreshEnabled",void 0),t.__decorate([c.property()],w.prototype,"cellClassNameGenerator",void 0),t.__decorate([c.property()],w.prototype,"dataProvider",void 0),t.__decorate([c.property()],w.prototype,"editingEnabled",void 0),t.__decorate([c.property()],w.prototype,"fieldConfigs",null),t.__decorate([c.property()],w.prototype,"filterGeometry",null),t.__decorate([c.property({readOnly:!0})],w.prototype,"grid",void 0),t.__decorate([c.property()],w.prototype,"hiddenFields",void 0),t.__decorate([c.property()],w.prototype,"highlightOnRowSelectEnabled",void 0),t.__decorate([c.property({readOnly:!0})],w.prototype,"itemIdPath",void 0),t.__decorate([c.property()],w.prototype,"layer",null),t.__decorate([c.property()],w.prototype,"messages",null),t.__decorate([c.property()],w.prototype,"messagesCommon",void 0),t.__decorate([c.property()],w.prototype,"relatedRecordsEnabled",void 0),t.__decorate([c.property({readOnly:!0,type:b})],w.prototype,"store",void 0),t.__decorate([c.property()],w.prototype,"view",void 0),w=t.__decorate([y.subclass("esri.widgets.FeatureTable.FeatureTableViewModel")],w);return w}));
