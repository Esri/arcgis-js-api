// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../Graphic","../../intl","../../core/arrayUtils","../../core/Collection","../../core/HandleOwner","../../core/Handles","../../core/watchUtils","../../core/accessorSupport/decorators","../../layers/FeatureLayer","../../views/support/layerViewUtils","./AttachmentsColumn","./FieldColumn","./Grid/Grid","./Grid/GridViewModel","./support/FeatureStore"],(function(e,t,r,o,n,i,a,s,l,d,c,u,h,p,g,f,y,_){return function(e){function t(t){var o=e.call(this,t)||this;o._defaultHiddenFields=["CreationDate","Creator","EditDate","Editor","GlobalID"],o._highlights=new l,o.attachmentsEnabled=!1,o.cellClassNameGenerator=function(e,t){return e.path||null},o.dataProvider=function(e,t){return r.__awaiter(o,void 0,void 0,(function(){var o,n,i,a,s,l;return r.__generator(this,(function(r){switch(r.label){case 0:return o=this.store,n=e.page,i=e.pageSize,a=e.sortOrders,s=this._sortOrdersToLayerOrderByFields(a),t?o?[4,o.set({orderByFields:s})]:(t&&t([]),[2]):[2];case 1:return r.sent(),"loaded"===o.state||"loading"===o.state?[3,3]:[4,o.load()];case 2:r.sent(),r.label=3;case 3:return t?(l=t,[4,o.fetchItems({page:n,pageSize:i})]):[3,5];case 4:l.apply(void 0,[r.sent()]),r.label=5;case 5:return[2]}}))}))},o.editingEnabled=!1,o.grid=null,o.hiddenFields=new a,o.highlightOnRowSelectEnabled=!0,o.itemIdPath="objectId",o.relatedRecordsEnabled=!1,o.store=null,o.view=null;var n=o,i=n.hiddenFields,s=n.itemIdPath;return i.addMany(o._defaultHiddenFields),o._set("store",new _),o._set("grid",new f({itemIdPath:s,viewModel:o})),o}return r.__extends(t,e),t.prototype.initialize=function(){var e=this,t=function(){return r.__awaiter(e,void 0,void 0,(function(){var e;return r.__generator(this,(function(t){switch(t.label){case 0:return e=this,[4,n.loadMessageBundle("esri/widgets/FeatureTable/t9n/FeatureTable")];case 1:return[2,e.messages=t.sent()]}}))}))};t(),this.handles.add([n.onLocaleChange(t),d.on(this,"grid.selectedItems","change",(function(t){return e._onSelectionChange(t)})),d.watch(this,"relatedRecordsEnabled",(function(t){return e.store.relatedRecordsEnabled=t})),d.watch(this,["layer.loaded"],(function(){var t;if(null===(t=e.layer)||void 0===t?void 0:t.loaded){var r=e._getPageSizeFromLayer();r&&e.grid.set({pageSize:r}),e._generateColumns()}})),d.watch(this,["editingEnabled","messages"],(function(){var t;return(null===(t=e.layer)||void 0===t?void 0:t.loaded)&&e._generateColumns()})),d.watch(this,"layer.definitionExpression",(function(t,r){return(t||r)&&"loaded"===e.store.state&&e.refresh()})),d.watch(this,"attachmentsEnabled",(function(t,r){(t||r)&&"loaded"===e.store.state&&(e.store.attachmentsEnabled=!0,e.refresh(),e._generateColumns())}))])},t.prototype.destroy=function(){this._resetColumns(),this.columns.destroy(),this.handles.removeAll(),this._highlights.removeAll(),this._highlights.destroy(),this.layer=null,this.view=null},Object.defineProperty(t.prototype,"fieldConfigs",{set:function(e){var t;this._set("fieldConfigs",e),(null===(t=this.layer)||void 0===t?void 0:t.loaded)&&this._generateColumns()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"layer",{set:function(e){this._set("layer",e),this._resetColumns(),this.store.set({layer:e}),e&&e.load(),this.notifyChange("state")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"messages",{set:function(e){var t;null===(t=this.grid)||void 0===t||t.set("messages",e),this._set("messages",e)},enumerable:!0,configurable:!0}),t.prototype.clearHighlights=function(){this._highlights.removeAll()},t.prototype.clearSelection=function(){var e;null===(e=this.grid)||void 0===e||e.clearSelection()},t.prototype.deselectRows=function(e){var t=this;(e=e instanceof Array?e:[e]).forEach((function(e){return t._deselectRow(e)}))},t.prototype.getObjectIdIndex=function(e){var t;return null===(t=this.store)||void 0===t?void 0:t.getObjectIdIndex(e)},t.prototype.getValue=function(e,t){var r,o=this.store.getItemByObjectId(e);return null===(r=null==o?void 0:o.feature)||void 0===r?void 0:r.attributes[t]},t.prototype.refresh=function(){var e;null===(e=this.grid)||void 0===e||e.refresh()},t.prototype.selectRows=function(e){var t=this;(e=e instanceof Array?e:[e]).forEach((function(e){return t._selectRow(e)}))},t.prototype._generateColumns=function(){this._resetColumns(),this.columns.addMany(r.__spreadArrays(this._createFieldColumns())),this.attachmentsEnabled&&this.columns.push(this._createAttachmentsColumn())},t.prototype._createFieldColumns=function(){return this.fieldConfigs&&this.fieldConfigs.length?this._createColumnsFromConfigs():this._createColumnsFromFields()},t.prototype._createColumnsFromConfigs=function(){var e=this,t=e.editingEnabled,r=e.fieldConfigs,o=e.grid,n=e.hiddenFields,a=e.layer,s=e.messages,l=e.store,d=this.get("layer.fields")||[];return r.map((function(e){var r=i.find(d||[],(function(t){return e.name===t.name})),c=n.indexOf(r.name)>-1;return new g({config:e,direction:e.direction||null,editingEnabled:t,field:r,grid:o,hidden:c,layer:a,store:l,messages:s})}))},t.prototype._createColumnsFromFields=function(){var e=this,t=e.editingEnabled,r=e.grid,o=e.hiddenFields,n=e.layer,i=e.messages,a=e.store;return(this.get("layer.fields")||[]).map((function(e){var s=o.indexOf(e.name)>-1;return new g({editingEnabled:t,field:e,grid:r,hidden:s,layer:n,store:a,messages:i})}))},t.prototype._createAttachmentsColumn=function(){var e;return new p({header:null===(e=this.messages)||void 0===e?void 0:e.attachments})},t.prototype._sortOrdersToLayerOrderByFields=function(e){return e&&e.length?e.filter((function(e,t,r){return r.map((function(e){return e.path})).indexOf(e.path)===t})).map((function(e){var t=e.direction;return e.path+" "+t.toUpperCase()})):[]},t.prototype._highlight=function(e){var t=this.view,r=t&&e&&i.find(t.allLayerViews.items,(function(t){return t.layer===e.layer}));h.highlightsSupported(r)&&this._highlights.add(r.highlight(e),"feature-"+e.getObjectId())},t.prototype._unhighlight=function(e){e&&this._highlights.remove("feature-"+e.getObjectId())},t.prototype._selectRow=function(e){var t=this.grid,r=e instanceof o?e:null,n=r?r.getObjectId():e,i=this.getObjectIdIndex(n);-1===i?null==t||t.selectItem({objectId:n,feature:r}):null==t||t.selectRow(i)},t.prototype._deselectRow=function(e){var t=this.grid,r=e instanceof o?e.getObjectId():e,n=this.getObjectIdIndex(r);-1===n?null==t||t.deselectItem({objectId:r}):null==t||t.deselectRow(n)},t.prototype._onSelectionChange=function(e){var t=this,r=this.highlightOnRowSelectEnabled,o=e.added,n=e.removed;r&&o.forEach((function(e){return t._highlight(e.feature)})),r&&n.forEach((function(e){return t._unhighlight(e.feature)}))},t.prototype._resetColumns=function(){this.columns.items.forEach((function(e){return e.destroy()})),this.columns.removeAll()},t.prototype._getPageSizeFromLayer=function(){var e,t,r;return(null===(r=null===(t=null===(e=this.layer)||void 0===e?void 0:e.capabilities)||void 0===t?void 0:t.query)||void 0===r?void 0:r.maxRecordCount)||0},r.__decorate([c.property()],t.prototype,"attachmentsEnabled",void 0),r.__decorate([c.property()],t.prototype,"cellClassNameGenerator",void 0),r.__decorate([c.property()],t.prototype,"dataProvider",void 0),r.__decorate([c.property()],t.prototype,"editingEnabled",void 0),r.__decorate([c.property({dependsOn:["messages","layer.loaded"]})],t.prototype,"fieldConfigs",null),r.__decorate([c.property({readOnly:!0})],t.prototype,"grid",void 0),r.__decorate([c.property()],t.prototype,"hiddenFields",void 0),r.__decorate([c.property()],t.prototype,"highlightOnRowSelectEnabled",void 0),r.__decorate([c.property({readOnly:!0})],t.prototype,"itemIdPath",void 0),r.__decorate([c.property({type:u})],t.prototype,"layer",null),r.__decorate([c.property()],t.prototype,"messages",null),r.__decorate([c.property()],t.prototype,"relatedRecordsEnabled",void 0),r.__decorate([c.property({readOnly:!0,type:_})],t.prototype,"store",void 0),r.__decorate([c.property()],t.prototype,"view",void 0),t=r.__decorate([c.subclass("esri.widgets.FeatureTable.FeatureTableViewModel")],t)}(s.HandleOwnerMixin(y))}));