/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/has","../../core/Logger","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/subclass","../../core/urlUtils","../../core/uuid","../../portal/support/resourceExtension","../../core/Collection","../../intl/locale","../../intl/messages","../../intl","../../Graphic","../../core/Handles","../../core/watchUtils","../../layers/FeatureLayer","../../core/HandleOwner","../../views/support/layerViewUtils","./AttachmentsColumn","./FieldColumn","./Grid/Grid","./Grid/GridViewModel","./support/FeatureStore"],(function(e,t,s,i,r,o,n,l,a,d,h,c,u,g,m,p,f,y,_,v,b,C,w,I,E){"use strict";let F=function(t){function s(s){var i;(i=t.call(this,s)||this)._defaultHiddenFields=["CreationDate","Creator","EditDate","Editor","GlobalID"],i._highlights=new p,i.cellClassNameGenerator=(e,t)=>e.path||null,i.dataProvider=async(t,s)=>{const{store:r}=e._assertThisInitialized(i),{page:o,pageSize:n,sortOrders:l}=t,a=i._sortOrdersToLayerOrderByFields(l);s&&(r?(await r.set({orderByFields:a}),"loaded"!==r.state&&"loading"!==r.state&&await r.load(),s&&s(await r.fetchItems({page:o,pageSize:n}))):s&&s([]))},i.editingEnabled=!1,i.grid=null,i.hiddenFields=new h,i.highlightOnRowSelectEnabled=!0,i.itemIdPath="objectId",i.messagesCommon=null,i.relatedRecordsEnabled=!1,i.store=null,i.view=null;const{hiddenFields:r,itemIdPath:o}=e._assertThisInitialized(i);return r.addMany(i._defaultHiddenFields),i._set("store",new E),i._set("grid",new w({itemIdPath:o,viewModel:e._assertThisInitialized(i)})),i}e._inheritsLoose(s,t);var i=s.prototype;return i.initialize=function(){const e=async()=>{this.messages=await u.fetchMessageBundle("esri/widgets/FeatureTable/t9n/FeatureTable"),this.messagesCommon=await u.fetchMessageBundle("esri/t9n/common")};e(),this.handles.add([c.onLocaleChange(e),f.on(this,"grid.selectedItems","change",(e=>this._onSelectionChange(e))),f.watch(this,"relatedRecordsEnabled",(e=>this.store.relatedRecordsEnabled=e)),f.watch(this,["layer.loaded"],(()=>{var e;if(null!=(e=this.layer)&&e.loaded){const e=this.layer.capabilities.query.maxRecordCount;var t;if(e&&e<this.pageSize)null==(t=this.grid)||t.set({pageSize:e});this._generateColumns()}})),f.watch(this.store,"state",(e=>{var t;"loaded"===e&&(null==(t=this.grid)||t.scrollToTop())})),f.watch(this,["editingEnabled","messages"],(()=>{var e;return(null==(e=this.layer)?void 0:e.loaded)&&this._generateColumns()})),f.watch(this,"layer.definitionExpression",((e,t)=>(e||t)&&"loaded"===this.store.state&&this.refresh()))])},i.destroy=function(){var e,t;this._resetColumns(),this.handles.removeAll(),this._highlights.removeAll(),this._highlights.destroy(),null==(e=this.grid)||e.destroy(),null==(t=this.columns)||t.destroy(),this.layer=null,this.view=null},i.clearHighlights=function(){this._highlights.removeAll()},i.clearSelection=function(){var e;null==(e=this.grid)||e.clearSelection()},i.deselectRows=function(e){(e=e instanceof Array?e:[e]).forEach((e=>this._deselectRow(e)))},i.getObjectIdIndex=function(e){var t;return null==(t=this.store)?void 0:t.getObjectIdIndex(e)},i.getValue=function(e,t){var s;const i=this.store.getItemByObjectId(e);return null==i||null==(s=i.feature)?void 0:s.attributes[t]},i.refresh=function(){var e;null==(e=this.grid)||e.refresh()},i.selectRows=function(e){(e=e instanceof Array?e:[e]).forEach((e=>this._selectRow(e)))},i.scrollToIndex=function(e){var t;null==(t=this.grid)||t.scrollToIndex(e)},i._generateColumns=function(){this._resetColumns(),this.columns.addMany([...this._createFieldColumns()]),this.attachmentsEnabled&&this.columns.push(this._createAttachmentsColumn())},i._createFieldColumns=function(){return this.fieldConfigs&&this.fieldConfigs.length?this._createColumnsFromConfigs():this._createColumnsFromFields()},i._createColumnsFromConfigs=function(){const{editingEnabled:e,fieldConfigs:t,grid:s,hiddenFields:i,layer:r,messages:o,messagesCommon:n,store:l}=this,a=this.get("layer.fields")||[];return t.filter((e=>(a||[]).find((t=>e.name===t.name)))).map((t=>{const d=t.direction||null,h=t.formatFunction||null,c=(a||[]).find((e=>t.name===e.name)),u=!1===t.visible||!0!==t.visible&&i.indexOf(c.name)>-1;return new C({config:t,direction:d,editingEnabled:e,field:c,formatFunction:h,grid:s,hidden:u,layer:r,store:l,messages:o,messagesCommon:n})}))},i._createColumnsFromFields=function(){const{editingEnabled:e,grid:t,hiddenFields:s,layer:i,messages:r,messagesCommon:o,store:n}=this;return(this.get("layer.fields")||[]).map((l=>{const a=s.indexOf(l.name)>-1;return new C({editingEnabled:e,field:l,grid:t,hidden:a,layer:i,store:n,messages:r,messagesCommon:o})}))},i._createAttachmentsColumn=function(){var e;return new b({header:null==(e=this.messages)?void 0:e.attachments})},i._sortOrdersToLayerOrderByFields=function(e){return e&&e.length?e.filter(((e,t,s)=>s.map((e=>e.path)).indexOf(e.path)===t)).map((({direction:e,path:t})=>t+" "+e.toUpperCase())):[]},i._highlight=function(e){const{view:t}=this,s=t&&e&&t.allLayerViews.items.find((({layer:t})=>t===e.layer));v.highlightsSupported(s)&&this._highlights.add(s.highlight(e),`feature-${e.getObjectId()}`)},i._unhighlight=function(e){e&&this._highlights.remove(`feature-${e.getObjectId()}`)},i._selectRow=function(e){const{grid:t}=this,s=e instanceof m?e:null,i=s?s.getObjectId():e;if("number"!=typeof i&&"string"!=typeof i)return;const r=this.getObjectIdIndex(i);-1===r?null==t||t.selectItem({objectId:i}):null==t||t.selectRow(r)},i._deselectRow=function(e){const{grid:t}=this,s=e instanceof m?e.getObjectId():e,i=this.getObjectIdIndex(s);-1===i?null==t||t.deselectItem({objectId:s}):null==t||t.deselectRow(i)},i._onSelectionChange=function(e){const{highlightOnRowSelectEnabled:t}=this,{added:s,removed:i}=e;t&&s.forEach((e=>this._highlight(e.feature))),t&&i.forEach((e=>this._unhighlight(e.feature)))},i._resetColumns=function(){this.columns.items.forEach((e=>e.destroy())),this.columns.removeAll()},e._createClass(s,[{key:"attachmentsEnabled",set:function(e){this.attachmentsEnabled!==e&&(this._set("attachmentsEnabled",e),this._generateColumns(),this.store.attachmentsEnabled=e)}},{key:"fieldConfigs",set:function(e){var t;this._set("fieldConfigs",e),(null==(t=this.layer)?void 0:t.loaded)&&this._generateColumns()}},{key:"filterGeometry",set:function(e){(this.filterGeometry||e)&&(this.clearSelection(),this._set("filterGeometry",e),this.store.filterGeometry=e)}},{key:"layer",set:function(e){var t;this._set("layer",e),null==(t=this.grid)||t.clearSort(),this._resetColumns(),this.store.set({layer:e}),e&&e.load(),this.notifyChange("state")}},{key:"messages",set:function(e){var t;null==(t=this.grid)||t.set("messages",e),this._set("messages",e)}}]),s}(_.HandleOwnerMixin(I));return t.__decorate([o.property()],F.prototype,"attachmentsEnabled",null),t.__decorate([o.property()],F.prototype,"cellClassNameGenerator",void 0),t.__decorate([o.property()],F.prototype,"dataProvider",void 0),t.__decorate([o.property()],F.prototype,"editingEnabled",void 0),t.__decorate([o.property()],F.prototype,"fieldConfigs",null),t.__decorate([o.property()],F.prototype,"filterGeometry",null),t.__decorate([o.property({readOnly:!0})],F.prototype,"grid",void 0),t.__decorate([o.property()],F.prototype,"hiddenFields",void 0),t.__decorate([o.property()],F.prototype,"highlightOnRowSelectEnabled",void 0),t.__decorate([o.property({readOnly:!0})],F.prototype,"itemIdPath",void 0),t.__decorate([o.property({type:y})],F.prototype,"layer",null),t.__decorate([o.property()],F.prototype,"messages",null),t.__decorate([o.property()],F.prototype,"messagesCommon",void 0),t.__decorate([o.property()],F.prototype,"relatedRecordsEnabled",void 0),t.__decorate([o.property({readOnly:!0,type:E})],F.prototype,"store",void 0),t.__decorate([o.property()],F.prototype,"view",void 0),F=t.__decorate([n.subclass("esri.widgets.FeatureTable.FeatureTableViewModel")],F),F}));
