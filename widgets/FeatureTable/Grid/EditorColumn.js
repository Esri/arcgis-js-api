// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../core/accessorSupport/decorators","./Column"],(function(t,e,n,o,r){"use strict";var i="esri-editor-column__cell-input",a="esri-editor-column__cell-input--container",u="Enter",l="Escape";return function(t){function e(e){var n=t.call(this,e)||this;return n.activeEditInfo=null,n.cellValueValidatorFunction=function(t){return t.oldValue!==t.value},n.editable=!1,n.inputRenderFunction=function(t){var e,o,r=t.root,i=t.column,a=t.rowData;if((null===(e=n.activeEditInfo)||void 0===e||!e.updating)&&n.editable){var u=n.getCellValue(i,a),l=n.createInputElement({root:r,column:i,rowData:a,value:u});n._set("activeEditInfo",{column:i,input:l,root:r,rowData:a,updating:!0,oldValue:u});var c=n.createInputContainer();c.appendChild(l),n.removeCellContent(r),r.appendChild(c),l.focus(),l instanceof HTMLInputElement&&l.select(),null===(o=n.grid)||void 0===o||o.notifyResize()}},n.loadingMessage="",n.inputType="text",n.maxLength=null,n.parseInputValueFunction=function(t){return t.input.value},n.renderFunction=function(t){var e,o=t.root,r=t.column,i=t.rowData,a=n.activeEditInfo;if(!a||!a.updating){var c=n.getCellValue(r,i),d=n.cellValueFormatFunction({column:r,rowData:i,value:c});o.onclick=function(){return o.focus()},o.ondblclick=function(){return n.inputRenderFunction(t)},o.ontouchend=function(){return n.inputRenderFunction(t)};var p=null===(e=n.grid)||void 0===e?void 0:e.getSlotElementByName(o.slot),s=null==p?void 0:p.parentElement;s&&(s.onkeydown=function(e){e.key!==u||n.activeEditInfo||n.inputRenderFunction(t),e.key===l&&n.activeEditInfo&&n.cancel()}),(null==d?void 0:d.toString())!==o.innerHTML&&(o.innerHTML=d)}},n.required=!1,n.store=null,n.updateRowItemFunction=function(t){var e=t.rowData,n=t.column,o=t.value;e.item[n.path]=o},n.updateStoreItemFunction=function(t){var e,o=t.rowData,r=t.column,i=t.value;return null===(e=n.store)||void 0===e?void 0:e.updateItem({index:o.index,name:r.path,value:i})},n}return n.__extends(e,t),e.prototype.cancel=function(){var t,e=this.activeEditInfo;if(e){var n=e.column,o=e.root,r=e.rowData,i=e.oldValue;this._set("activeEditInfo",null);var a=this.cellValueFormatFunction({column:n,rowData:r,value:i});o.innerHTML=a,null===(t=this.grid)||void 0===t||t.notifyResize()}},e.prototype.createInputContainer=function(){var t=document.createElement("div");return t.classList.add(a),t},e.prototype.createInputElement=function(t){var e=this,n=t.value,o=document.createElement("input");return o.classList.add(i),o.maxLength=this.maxLength,o.type=this.inputType,o.value=n,o.onblur=function(){o.onblur=null,e.submit()},o},e.prototype.submit=function(){var t,e;return n.__awaiter(this,void 0,void 0,(function(){var o,r,i,a,u,l,c,d,p;return n.__generator(this,(function(n){switch(n.label){case 0:if(!(o=this.activeEditInfo))return[2];if(r=o.column,i=o.input,a=o.root,u=o.rowData,l=o.oldValue,c=this.parseInputValueFunction({input:i,column:r,rowData:u}),!this.cellValueValidatorFunction({value:c,oldValue:l,column:r,rowData:u}))return this.cancel(),[2];a.innerHTML=this.loadingMessage,null===(t=this.grid)||void 0===t||t.notifyResize(),n.label=1;case 1:return n.trys.push([1,3,,4]),[4,this.updateStoreItemFunction({rowData:u,column:r,value:c})];case 2:return n.sent(),this.updateRowItemFunction({rowData:u,column:r,value:c}),d=this.getCellValue(r,u),p=this.cellValueFormatFunction({column:r,rowData:u,value:d}),a.innerHTML=p,this.emit("value-change",{column:r,rowData:u,value:d}),this._set("activeEditInfo",null),null===(e=this.grid)||void 0===e||e.notifyResize(),[3,4];case 3:return n.sent(),this.cancel(),[3,4];case 4:return[2]}}))}))},n.__decorate([o.property({readOnly:!0})],e.prototype,"activeEditInfo",void 0),n.__decorate([o.property()],e.prototype,"cellValueValidatorFunction",void 0),n.__decorate([o.property()],e.prototype,"editable",void 0),n.__decorate([o.property()],e.prototype,"inputRenderFunction",void 0),n.__decorate([o.property({constructOnly:!0})],e.prototype,"loadingMessage",void 0),n.__decorate([o.property()],e.prototype,"inputType",void 0),n.__decorate([o.property()],e.prototype,"maxLength",void 0),n.__decorate([o.property()],e.prototype,"parseInputValueFunction",void 0),n.__decorate([o.property()],e.prototype,"renderFunction",void 0),n.__decorate([o.property()],e.prototype,"required",void 0),n.__decorate([o.property()],e.prototype,"store",void 0),n.__decorate([o.property()],e.prototype,"updateRowItemFunction",void 0),n.__decorate([o.property()],e.prototype,"updateStoreItemFunction",void 0),e=n.__decorate([o.subclass("esri.widgets.FeatureTable.EditorColumn")],e)}(r)}));