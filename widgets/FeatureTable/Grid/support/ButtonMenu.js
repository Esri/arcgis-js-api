// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../core/events","../../../../core/HandleOwner","../../../../core/maybe","../../../../core/watchUtils","../../../../core/accessorSupport/decorators","../../../Widget","./ButtonMenuViewModel","../../../support/Popover","../../../support/widget"],(function(e,t,n,o,i,r,s,u,a,d,l,c){"use strict";var p="esri-button-menu",m="esri-button-menu__content",h="esri-button-menu__item-wrapper",_="esri-button-menu__icon",b="esri-button-menu__item",v="esri-button-menu__item-label",f="esri-button-menu__item-label-content",y="esri-button-menu__item--selectable",C="esri-button-menu__item--selected",M="esri-button-menu__checkbox",w="esri-button-menu__embedded-content-wrapper",x="esri-button-menu__button",k="esri-button-menu__button--selected",I="esri-icon-menu",N="esri-widget";return function(e){function t(t,n){var o=e.call(this,t,n)||this;return o._menuContentNode=null,o._popover=null,o._rootNode=null,o.iconClass=null,o.items=null,o.label=null,o.open=!1,o.viewModel=new d,o}return n.__extends(t,e),t.prototype.initialize=function(){var e=this;this.when((function(){e._popover=new l({owner:e,placement:c.isRTL()?"bottom-start":"bottom-end",renderContentFunction:e.renderMenuContent,anchorElement:e._rootNode}),e.handles.add([s.watch(e,"open",(function(t){return e._popover.set("open",t)}))])})),document.addEventListener("click",(function(t){return e._handleOutsideClick(t)}))},t.prototype.destroy=function(){var e,t=this;null===(e=this._popover)||void 0===e||e.destroy(),this._popover=null,document.removeEventListener("click",(function(e){return t._handleOutsideClick(e)}))},t.prototype._handleOutsideClick=function(e){var t,n;if(this.open&&this._rootNode&&this._menuContentNode){var o=e.target;(null===(t=this._menuContentNode)||void 0===t?void 0:t.contains(o))||(null===(n=this._rootNode)||void 0===n?void 0:n.contains(o))||(this.open=!1)}},t.prototype.render=function(){return c.tsx("div",{afterCreate:this._afterRootNodeCreate,bind:this,"data-node-ref":"_rootNode",class:this.classes(p,N),key:"menu"},this.renderMenuButton())},t.prototype.renderMenuButton=function(){var e=this.iconClass,t=this.id,n=this.label,o=this.open,i=this.classes([x,e||I,o?k:null]);return c.tsx("button",{"aria-pressed":o.toString(),"aria-controls":t+"-menu","aria-expanded":o,"aria-haspopup":"true","aria-label":n,bind:this,class:i,id:t+"-button",title:n,selected:o,onclick:this._toggleOpen,tabindex:"0",type:"button"})},t.prototype.renderMenuContent=function(){var e,t=this.id,n=this.open;return c.tsx("div",{afterCreate:this._afterMenuContentNodeCreate,bind:this,class:m,"data-node-ref":"_menuContentNode",key:"esri-button-menu-content",hidden:!n},c.tsx("ul",{"aria-labelledby":t+"-button",bind:this,class:h,id:t+"-menu",role:"menu"},(null===(e=this.items)||void 0===e?void 0:e.length)&&this.renderItems()))},t.prototype.renderItems=function(){var e,t=this;return null===(e=this.items)||void 0===e?void 0:e.map((function(e,n){return t.renderItem(e,n)}))},t.prototype.renderItem=function(e,t,n){var o,i=this,s=r.isSome(n)?this.id+"-menu-item-"+t+"-"+n:this.id+"-menu-item-"+t,u=s+"-label",a=this.classes(b,e.selectionEnabled?y:null,e.selectionEnabled&&e.selected?C:null);return c.tsx("li",{afterCreate:this._afterMenuItemCreate,bind:this,class:a,"data-item-index":t,"data-item-subIndex":n,for:s,key:s,onkeydown:function(t){return i._handleMenuItemKeydown(t,e)},onclick:function(t){return i._handleMenuItemInteraction(t,e)},role:"menuitem",tabindex:"0"},c.tsx("input",{disabled:!0,checked:e.selected,class:M,id:s,name:s,tabindex:"-1",type:"checkbox"}),c.tsx("label",{bind:this,class:this.classes(x,v),for:s,id:u},c.tsx("span",{class:this.classes(_,e.iconClass),"aria-hidden":!0}),c.tsx("span",{class:f},e.label)),c.tsx("ul",{"aria-labelledby":u,class:w,id:this.id+"-submenu",role:"menu"},null===(o=null==e?void 0:e.items)||void 0===o?void 0:o.map((function(e,n){return i.renderItem(e,t,n)}))))},t.prototype._afterRootNodeCreate=function(e){var t;this._rootNode=e,null===(t=this._popover)||void 0===t||t.set("anchorElement",(function(){return e}))},t.prototype._handleMenuItemInteraction=function(e,t){t.selected=!t.selected,t.open=!(!t.selected||!t.items),t.autoCloseMenu&&this.set("open",!1),t.clickFunction&&t.clickFunction({event:e,item:t}),e.stopPropagation()},t.prototype._handleMenuItemKeydown=function(e,t){var n=o.eventKey(e);"Enter"!==n&&" "!==n||this._handleMenuItemInteraction(e,t),"Escape"===n&&(this.open=!1,e.preventDefault(),e.stopPropagation())},t.prototype._afterMenuContentNodeCreate=function(e){this._menuContentNode=e,e.focus()},t.prototype._toggleOpen=function(){this.open=!this.open},t.prototype._afterMenuItemCreate=function(e){0===e["data-item-index"]&&e.focus()},n.__decorate([u.property(),c.renderable()],t.prototype,"iconClass",void 0),n.__decorate([u.aliasOf("viewModel.items")],t.prototype,"items",void 0),n.__decorate([u.property(),c.renderable()],t.prototype,"label",void 0),n.__decorate([u.aliasOf("viewModel.open")],t.prototype,"open",void 0),n.__decorate([u.property(),c.renderable(["viewModel.items","viewModel.open"])],t.prototype,"viewModel",void 0),t=n.__decorate([u.subclass("esri.widgets.FeatureTable.Grid.support.ButtonMenu")],t)}(i.HandleOwnerMixin(a))}));