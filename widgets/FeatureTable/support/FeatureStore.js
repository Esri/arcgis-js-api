// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../../Graphic","../../../core/Accessor","../../../core/arrayUtils","../../../core/arrayUtils","../../../core/Collection","../../../core/Error","../../../core/lang","../../../core/Logger","../../../core/promiseUtils","../../../core/accessorSupport/decorators","../../../tasks/support/AttachmentQuery","../../../tasks/support/Query"],(function(e,t,r,n,o,i,a,u,s,c,h,p,d,y,l){var f="esri.widgets.FeatureTable.support.FeatureStore",_=h.getLogger(f);function g(e,t,r){_.error(new s(e,t,r))}return function(e){function t(t){var r=e.call(this,t)||this;return r._loaded=!1,r._loadError=!1,r._loading=!1,r._editOperationQueue=[],r._queryOperationQueue=[],r.attachmentsEnabled=!1,r.count=0,r.failures=new u,r.itemCache=new u,r.relatedRecordsEnabled=!1,r}return r.__extends(t,e),t.prototype.destroy=function(){this.layer=null,this.itemCache&&this.itemCache.destroy(),this.failures&&this.failures.destroy(),this._set("itemCache",null)},Object.defineProperty(t.prototype,"layer",{get:function(){return this._get("layer")||null},set:function(e){this._reset(),this._set("layer",e),this.notifyChange("state")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"orderByFields",{get:function(){return this._get("orderByFields")||[]},set:function(e){var t=this.orderByFields;a.equals(e,t)||(this.itemCache.removeAll(),this._set("orderByFields",e))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"querying",{get:function(){return this._queryOperationQueue.length>0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"state",{get:function(){var e=this.layer,t=this._loaded,r=this._loadError,n=this._loading;return r?"error":!e||this.get("layer.loadError")?"disabled":n?"loading":"loaded"===this.get("layer.loadStatus")&&t?"loaded":"ready"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"syncing",{get:function(){return this._editOperationQueue.length>0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"where",{get:function(){return this._get("where")||null},set:function(e){this._reset(),this._set("where",e),this.notifyChange("state")},enumerable:!0,configurable:!0}),t.prototype.load=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t;return r.__generator(this,(function(r){switch(r.label){case 0:if(this._reset(),!(e=this.layer))return[2,p.resolve()];this._loading=!0,this.notifyChange("state"),r.label=1;case 1:return r.trys.push([1,4,,5]),[4,e.when()];case 2:return r.sent(),[4,this._setCount()];case 3:return r.sent(),this._loading=!1,this._loaded=!0,this.notifyChange("state"),[3,5];case 4:throw t=r.sent(),this._reset(),this._loadError=!0,this.notifyChange("state"),g("store:load-error","An error ocurred.",{error:t}),t;case 5:return[2]}}))}))},t.prototype.addItems=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){return[2]}))}))},t.prototype.fetchItems=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n,o,i,a,u,s,c;return r.__generator(this,(function(r){switch(r.label){case 0:return t=e.page,n=e.pageSize,i=(o=t*n)+n,u=(a=this).layer,s=a.state,u&&"loaded"===s?(this.notifyChange("querying"),[4,this._query({start:o,num:i})]):[2,p.resolve([])];case 1:return c=r.sent(),this.notifyChange("state"),[2,c]}}))}))},t.prototype.query=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n,o,i;return r.__generator(this,(function(r){switch(r.label){case 0:return n=(t=this).layer,o=t.state,n&&"loaded"===o?(this.notifyChange("querying"),[4,this._query(e)]):[2,[]];case 1:return i=r.sent(),this.notifyChange("state"),[2,i]}}))}))},t.prototype.removeItemAt=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){return[2]}))}))},t.prototype.reset=function(){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){return this._reset(),[2]}))}))},t.prototype.updateItem=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){return[2,this._update(e)]}))}))},t.prototype.getItemByObjectId=function(e){var t=this.itemCache,r=this.layer.objectIdField;return t.find((function(t){return t.feature.attributes[r]===e}))},t.prototype.getLocalItemAt=function(e){return this.itemCache.getItemAt(e)},t.prototype.getItemAt=function(e){return p.resolve(this.itemCache.getItemAt(e))},t.prototype.getObjectIdIndex=function(e){var t=this.itemCache,r=this.layer.objectIdField;return t.findIndex((function(t){return t.feature.attributes[r]===e}))},t.prototype._reset=function(){this.itemCache.removeAll(),this.failures.removeAll(),this._editOperationQueue=[],this._queryOperationQueue=[],this._loading=!1,this._loaded=!1,this._loadError=!1,this._set("count",0),this.notifyChange("querying"),this.notifyChange("syncing"),this.notifyChange("state")},t.prototype._getIdsFromFeatures=function(e){var t=this;return e.map((function(e){return e.attributes[t.layer.objectIdField]}))},t.prototype._toFeatureData=function(e,t){var r=this.layer.objectIdField;return e.map((function(e){var n=e.attributes[r];return{objectId:n,feature:e,attachments:t?t[n]:null,relatedRecords:null}}))},t.prototype._update=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,o,a,u,h,p,d,y,l,f=this;return r.__generator(this,(function(r){switch(r.label){case 0:if(t=this.layer,!t.capabilities.operations.supportsUpdate)throw new s("store:update-error","Update is not supported.");return o=e.index,a=e.name,u=e.value,[4,this.getItemAt(o)];case 1:if(!(h=r.sent())||!h.feature)throw new s("store:update-error","Feature with provided 'objectId' not found.");return p=h.feature,(d=c.clone(p.attributes))[a]=u,y=new n({attributes:d}),l=t.applyEdits({updateFeatures:[y]}).then((function(e){var t=e.updateFeatureResults,r=i.find(t,(function(e){return!!e.error}));if(r)throw r.error;return f._editOperationQueue.indexOf((function(){return l}))>-1&&t&&t.length&&(p.attributes=d),e})),[2,this._queueEditOperation((function(){return l}))]}}))}))},t.prototype._query=function(e){var t=this;return!0===e.refresh?(this.itemCache.removeAll(),this._setCount().then((function(){return t._queryFeatureData(e)}))):this._queryFeatureData(e)},t.prototype._queryFeatureData=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t=this;return r.__generator(this,(function(n){return[2,this._queueQueryOperation((function(){return r.__awaiter(t,void 0,void 0,(function(){var t,n,o;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,this._queryFeatures(e)];case 1:return t=r.sent().features,n=this._getIdsFromFeatures(t),[4,this._queryAttachments(n)];case 2:return o=r.sent(),[2,this._toFeatureData(t,o)||[]]}}))}))}))]}))}))},t.prototype._setCount=function(){var e=this;return this._queryCount().then((function(t){e._set("count",t)}))},t.prototype._queryCount=function(){return this.layer.queryFeatureCount(new l({returnGeometry:!1,where:this._getWhere()}))},t.prototype._queryFeatures=function(e){var t=this.layer,r=t.capabilities,n=r.operations.supportsQuery,o=r.query,i=o.supportsCacheHint,a=o.supportsOrderBy;if(!n)return p.reject(new s("store:query-error","Layer does not support query operation."));var u=e.start,c=e.num,h=this.orderByFields,d=new l({returnGeometry:!1,outFields:["*"],start:u,num:c,where:this._getWhere()});return a&&(d.orderByFields=h),i&&(d.cacheHint=!0),t.queryFeatures(d)},t.prototype._queryAttachments=function(e){var t=this.attachmentsEnabled,r=this.layer,n=this.where,o=r.capabilities,i=o.data.supportsAttachment,a=o.operations.supportsQueryAttachments;return t&&i&&a?r.queryAttachments(new y({objectIds:e,where:n})):p.resolve(null)},t.prototype._queueQueryOperation=function(e){var t=this;return this._queryOperationQueue.push(e),this.notifyChange("querying"),e().then((function(r){return t._queryOperationQueue.indexOf(e)>-1?(t.itemCache.addMany(r),r):[]})).catch((function(r){g("store:query-error","An error ocurred.",{error:r});var n={error:r,retry:function(){t.failures.remove(n),t._queueQueryOperation(e)},cancel:function(){return t.failures.remove(n)}};return t.failures.add(n),[]})).then((function(r){return i.remove(t._queryOperationQueue,e),t.notifyChange("querying"),r}))},t.prototype._queueEditOperation=function(e){var t=this;return this._editOperationQueue.push(e),this.notifyChange("syncing"),e().then((function(){i.remove(t._editOperationQueue,e),t.notifyChange("syncing")})).catch((function(r){g("store:edit-error","An error ocurred.",{error:r});var n={error:r,retry:function(){t.failures.remove(n),t._queueEditOperation(e)},cancel:function(){return t.failures.remove(n)}};throw t.failures.add(n),i.remove(t._editOperationQueue,e),t.notifyChange("syncing"),r}))},t.prototype._getWhere=function(){return this.where||this.layer.definitionExpression||"1=1"},r.__decorate([d.property()],t.prototype,"attachmentsEnabled",void 0),r.__decorate([d.property({readOnly:!0})],t.prototype,"count",void 0),r.__decorate([d.property({readOnly:!0})],t.prototype,"failures",void 0),r.__decorate([d.property({readOnly:!0})],t.prototype,"itemCache",void 0),r.__decorate([d.property()],t.prototype,"layer",null),r.__decorate([d.property()],t.prototype,"orderByFields",null),r.__decorate([d.property({readOnly:!0})],t.prototype,"querying",null),r.__decorate([d.property()],t.prototype,"relatedRecordsEnabled",void 0),r.__decorate([d.property({readOnly:!0,dependsOn:["layer","layer.loadError","layer.loadStatus"]})],t.prototype,"state",null),r.__decorate([d.property({readOnly:!0})],t.prototype,"syncing",null),r.__decorate([d.property()],t.prototype,"where",null),t=r.__decorate([d.subclass(f)],t)}(o)}));