/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/has","../../../core/lang","../../../core/Logger","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass","../../../core/Error","../../../core/urlUtils","../../../core/uuid","../../../portal/support/resourceExtension","../../../core/arrayUtils","../../../core/promiseUtils","../../../core/Accessor","../../../core/Collection","../../../Graphic","../../../tasks/support/AttachmentQuery","../../../tasks/support/Query"],(function(e,t,r,s,n,i,o,a,u,c,h,d,l,y,p,_,f,g,m){"use strict";const b="esri.widgets.FeatureTable.support.FeatureStore",q=n.getLogger(b);function C(e,t,r){q.error(new u(e,t,r))}let w=function(t){function r(e){var r;return(r=t.call(this,e)||this)._loaded=!1,r._loadError=!1,r._loading=!1,r._editOperationQueue=[],r._queryOperationQueue=[],r._objectIds=new _,r._hasStaleCache=!1,r.attachmentsEnabled=!1,r.count=0,r.failures=new _,r.itemCache=new _,r.relatedRecordsEnabled=!1,r}e._inheritsLoose(r,t);var n=r.prototype;return n.destroy=function(){this.layer=null,this.itemCache&&this.itemCache.destroy(),this.failures&&this.failures.destroy(),this._set("itemCache",null)},n.load=async function(){this._reset();const{layer:e}=this;if(!e)return y.resolve();this._loading=!0,this.notifyChange("state");try{await e.when(),await this._syncLayerInfo(),this._loading=!1,this._loaded=!0,this.notifyChange("state")}catch(e){throw this._reset(),this._loadError=!0,this.notifyChange("state"),C("store:load-error","An error ocurred.",{error:e}),e}},n.addItems=async function(e){},n.fetchItems=async function(e){const{page:t,pageSize:r}=e,s=t*r,n=s+r,{layer:i,state:o}=this;if(!i||"loaded"!==o)return y.resolve([]);this.notifyChange("querying");const a=await this._query({start:s,num:n,page:t,pageSize:r});return this.notifyChange("state"),a},n.query=async function(e){const{layer:t,state:r}=this;if(!t||"loaded"!==r)return[];this.notifyChange("querying");const s=await this._query(e);return this.notifyChange("state"),s},n.removeItemAt=async function(e){},n.reset=async function(){this._reset()},n.updateItem=async function(e){return this._update(e)},n.getItemByObjectId=function(e){const{itemCache:t,layer:{objectIdField:r}}=this;return t.find((t=>t.feature.attributes[r]===e))},n.getLocalItemAt=function(e){return this.itemCache.getItemAt(e)},n.getItemAt=function(e){return y.resolve(this.itemCache.getItemAt(e))},n.getObjectIdIndex=function(e){const{itemCache:t,layer:{objectIdField:r}}=this;return t.findIndex((t=>t.feature.attributes[r]===e))},n._reset=function(){this.itemCache.removeAll(),this.failures.removeAll(),this._editOperationQueue=[],this._queryOperationQueue=[],this._hasStaleCache=!1,this._loading=!1,this._loaded=!1,this._loadError=!1,this._set("count",0),this._objectIds.removeAll(),this.notifyChange("querying"),this.notifyChange("syncing"),this.notifyChange("state")},n._getIdsFromFeatures=function(e){return e.map((e=>e.attributes[this.layer.objectIdField]))},n._toFeatureData=function(e,t){const{layer:{objectIdField:r}}=this;return e.map((e=>{const{attributes:s}=e,n=s[r];return{objectId:n,feature:e,attachments:t?t[n]:null,relatedRecords:null}}))},n._update=async function(e){const{layer:t}=this,{operations:r}=t.capabilities;if(!r.supportsUpdate)throw new u("store:update-error","Update is not supported.");const{index:n,name:i,value:o}=e,a=await this.getItemAt(n);if(!a||!a.feature)throw new u("store:update-error","Feature with provided 'objectId' not found.");const{feature:c}=a,h=s.clone(c.attributes);h[i]=o;const d=new f({attributes:h}),l=t.applyEdits({updateFeatures:[d]}).then((e=>{const{updateFeatureResults:t}=e,r=t.find((e=>!!e.error));if(r)throw r.error;return this._editOperationQueue.indexOf((()=>l))>-1&&t&&t.length&&(c.attributes=h),e}));return this._queueEditOperation((()=>l))},n._query=async function(e){const{refresh:t}=e;return!0===t?(this.itemCache.removeAll(),this._syncLayerInfo().then((()=>this._queryFeatureData(e)))):(this._hasStaleCache&&(await this._updateIds(),this._hasStaleCache=!1),this._queryFeatureData(e))},n._queryFeatureData=async function(e){return this._queueQueryOperation((async()=>{const{features:t}=await this._queryFeatures(e),r=this._getIdsFromFeatures(t),s=await this._queryAttachments(r);return this._toFeatureData(t,s)||[]}))},n._syncLayerInfo=async function(){await this._updateCount(),await this._updateIds()},n._updateCount=async function(){await this._queryCount().then((e=>this._set("count",e)))},n._updateIds=async function(){var e,t,r;null!=(e=this.layer)&&null!=(t=e.capabilities)&&null!=(r=t.query)&&r.supportsPagination||(this._objectIds.removeAll(),await this._queryObjectIds().then((e=>this._objectIds.addMany(e))))},n._queryCount=function(){const{layer:e}=this;return e.queryFeatureCount(new m({returnGeometry:!1,where:this._getWhere()}))},n._queryObjectIds=function(){const{layer:e,orderByFields:t}=this,{capabilities:{query:{supportsCacheHint:r,supportsOrderBy:s}}}=e,n=new m({outFields:[e.objectIdField],returnGeometry:!1,where:this._getWhere()});return s&&(n.orderByFields=t),r&&(n.cacheHint=!0),e.queryObjectIds(n)},n._queryFeatures=async function(e){const{layer:t}=this;if(!t.capabilities.operations.supportsQuery)return y.reject(new u("store:query-error","Layer does not support query operation."));const{layer:{capabilities:{query:{supportsCacheHint:r,supportsOrderBy:s,supportsPagination:n}}},orderByFields:i}=this,{start:o,num:a}=e,c=new m({returnGeometry:!1,outFields:["*"]});return n?(c.start=o,c.num=a,c.where=this._getWhere()):c.objectIds=this._getObjectIdsForPage(o,a),s&&(c.orderByFields=i),r&&(c.cacheHint=!0),t.queryFeatures(c)},n._getObjectIdsForPage=function(e,t){const r=this._objectIds.toArray();return r.length>=e+t?r.slice(e,e+t):r.slice(e)},n._queryAttachments=function(e){const{attachmentsEnabled:t,layer:r}=this,{capabilities:{data:{supportsAttachment:s},operations:{supportsQueryAttachments:n}}}=r;return t&&s&&n?r.queryAttachments(new g({objectIds:e,where:this._getWhere()})):y.resolve(null)},n._queueQueryOperation=function(e){return this._queryOperationQueue.push(e),this.notifyChange("querying"),e().then((t=>this._queryOperationQueue.indexOf(e)>-1?(this.itemCache.addMany(t),t):[])).catch((t=>{C("store:query-error","An error ocurred.",{error:t});const r={error:t,retry:()=>{this.failures.remove(r),this._queueQueryOperation(e)},cancel:()=>this.failures.remove(r)};return this.failures.add(r),[]})).then((t=>(l.remove(this._queryOperationQueue,e),this.notifyChange("querying"),t)))},n._queueEditOperation=function(e){return this._editOperationQueue.push(e),this.notifyChange("syncing"),e().then((()=>{l.remove(this._editOperationQueue,e),this.notifyChange("syncing")})).catch((t=>{C("store:edit-error","An error ocurred.",{error:t});const r={error:t,retry:()=>{this.failures.remove(r),this._queueEditOperation(e)},cancel:()=>this.failures.remove(r)};throw this.failures.add(r),l.remove(this._editOperationQueue,e),this.notifyChange("syncing"),t}))},n._getWhere=function(){return this.where||this.layer.definitionExpression||"1=1"},e._createClass(r,[{key:"layer",get:function(){return this._get("layer")||null},set:function(e){this._reset(),this._set("layer",e),this.notifyChange("state")}},{key:"orderByFields",get:function(){return this._get("orderByFields")||[]},set:function(e){const t=this.orderByFields;l.equals(e,t)||(this.itemCache.removeAll(),this._hasStaleCache=!0,this._set("orderByFields",e))}},{key:"querying",get:function(){return this._queryOperationQueue.length>0}},{key:"state",get:function(){const{layer:e,_loaded:t,_loadError:r,_loading:s}=this;return r?"error":!e||this.get("layer.loadError")?"disabled":s?"loading":"loaded"===this.get("layer.loadStatus")&&t?"loaded":"ready"}},{key:"syncing",get:function(){return this._editOperationQueue.length>0}},{key:"where",get:function(){return this._get("where")||null},set:function(e){this._reset(),this._set("where",e),this.notifyChange("state")}}]),r}(p);return t.__decorate([o.property()],w.prototype,"attachmentsEnabled",void 0),t.__decorate([o.property({readOnly:!0})],w.prototype,"count",void 0),t.__decorate([o.property({readOnly:!0})],w.prototype,"failures",void 0),t.__decorate([o.property({readOnly:!0})],w.prototype,"itemCache",void 0),t.__decorate([o.property()],w.prototype,"layer",null),t.__decorate([o.property()],w.prototype,"orderByFields",null),t.__decorate([o.property({readOnly:!0})],w.prototype,"querying",null),t.__decorate([o.property()],w.prototype,"relatedRecordsEnabled",void 0),t.__decorate([o.property({readOnly:!0,dependsOn:["layer","layer.loadError","layer.loadStatus"]})],w.prototype,"state",null),t.__decorate([o.property({readOnly:!0})],w.prototype,"syncing",null),t.__decorate([o.property()],w.prototype,"where",null),w=t.__decorate([a.subclass(b)],w),w}));
