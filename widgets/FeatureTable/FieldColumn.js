/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/has","../../core/Logger","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/subclass","../../core/urlUtils","../../core/uuid","../../portal/support/resourceExtension","../../layers/support/CodedValueDomain","../../layers/support/fieldUtils","../../intl/date","../../intl/number","../support/widgetUtils","../support/DatePicker","../support/TimePicker","../FeatureForm/InputField","./Grid/EditorColumn"],(function(e,t,n,i,o,r,l,a,d,u,c,s,p,m,f,_,h,y,g){"use strict";const v="Escape",b="esri-field-column__header-content",F="esri-field-column__cell-input",E="esri-field-column__cell__input-container",C="esri-field-column__cell__date-input-container",O="esri-field-column__cell__date-input-wrapper",D="esri-field-column__button",w="esri-icon-save",I="esri-icon-trash",T="esri-icon-locked",V=p.convertDateFormatToIntlOptions("short-date-short-time"),L=p.convertDateFormatToIntlOptions("short-date"),k=m.convertNumberFormatToIntlOptions({digitSeparator:!0,places:null});let S=function(t){function n(n){var i;return(i=t.call(this,n)||this)._inputField=null,i.alias=null,i.cellValueFormatFunction=({rowData:t,value:n})=>{if(i.formatFunction){const{config:t,field:o}=e._assertThisInitialized(i);return i.formatFunction({config:t,field:o,value:f.renderingSanitizer.sanitize(n)})}if(null===n)return"&nbsp;";const{config:o,field:r,type:l}=e._assertThisInitialized(i),{item:{feature:a}}=t,d=i._getDomainForFeature(a);if(d)return i._getComputedDomain(n,d);if("date"===l){var u;const e=null!=o&&null!=(u=o.format)&&u.dateFormat?p.convertDateFormatToIntlOptions(o.format.dateFormat):!1===(null==o?void 0:o.includeTime)?L:V;return n?p.formatDate(n,e):null}if(s.isNumericField(r)){const e=null!=o&&o.format?m.convertNumberFormatToIntlOptions(o.format):k;return m.formatNumber(parseFloat(n),e)}return f.renderingSanitizer.sanitize(n)},i.cellValueValidatorFunction=({oldValue:e,value:t})=>e!==t,i.config=null,i.defaultValue=null,i.description=null,i.direction=null,i.editingEnabled=!1,i.field=null,i.formatFunction=null,i.headerRenderFunction=t=>{const{root:n}=t,{editable:o,editingEnabled:r,headerMenuEnabled:l,sortable:a}=e._assertThisInitialized(i);if(i.removeCellContent(n),n.classList.add(b),r&&!o&&n.appendChild(i.createLockedElement()),a)i.headerSorterRenderFunction(t);else{const{header:t,path:o}=e._assertThisInitialized(i),r=document.createElement("div");r.innerHTML=t||o,n.appendChild(r)}l&&i.headerMenuRenderFunction(t)},i.inputRenderFunction=({root:e,column:t,rowData:n})=>{var o,r;if(null!=(o=i.activeEditInfo)&&o.updating)return;if(!i.editable)return;const l=i.getCellValue(t,n),a=i.createInputElement({root:e,column:t,rowData:n,value:l});if(i._set("activeEditInfo",{column:t,input:a,root:e,rowData:n,updating:!0,oldValue:l}),"date"===i.type)return void i._renderDateEditors(l,e,a);const d=i.createInputContainer();d.appendChild(a),i.removeCellContent(e),e.appendChild(d),a.focus(),a instanceof HTMLInputElement&&a.select(),null==(r=i.grid)||r.notifyResize()},i.layer=null,i.menuConfig=null,i.name=null,i.nullable=!0,i.parseInputValueFunction=({input:e})=>{const t=i._inputField,n=e.value,{required:o,type:r}=t;return o||""!==n?"number"===r||"date"===r?parseFloat(n):n:null},i.path=null,i.type=null,i.updateRowItemFunction=({rowData:e,column:t,value:n})=>{e.item.feature.attributes[t.path]=n},i}e._inheritsLoose(n,t);var i=n.prototype;return i.createInputElement=function({rowData:e,value:t}){const{item:n}=e;if(!n||!n.feature)return null;this._inputField=this._setUpInputField(n.feature,t);const{field:i,maxLength:o,required:r}=this,{domain:l}=this._inputField;let a=null;"coded-value"===(null==l?void 0:l.type)?(a=this._createSelectElement(t,l.codedValues.map((({code:e,name:t})=>({value:e,name:t}))),this._inputField),a.onchange=()=>{a.onblur=null,u()}):(a=document.createElement("input"),a.type=s.isNumericField(i)?"number":"text",o>-1&&(a.maxLength=o)),a.classList.add(F),a.value=t,a.required=r;let d=!1;a.onkeydown=e=>{d=e.key===v},a.onblur=()=>{a.onblur=null,u()};const u=()=>{d?this.cancel():this.submit(),this._inputField=null};return a},i.createInputContainer=function(){const e=document.createElement("div");return e.classList.add(E),e},i.createLockedElement=function(){const e=document.createElement("div");return e.classList.add(T),e},i.getCellValue=function({path:e},{item:t}){var n,i,o;return null!=(n=null==t||null==(i=t.feature)||null==(o=i.attributes)?void 0:o[e])?n:null},i._renderDateEditors=function(e,t,n){var i;const{config:o,messagesCommon:r}=this,l=e?new Date(e):new Date(Date.now()),a=new _({dateInputEnabled:!0,value:l}),d=new h({value:l});n.value=l.getTime().toString();let u=!e;const c=()=>{u=!0;const e=this._getCombinedDateTime(a.value,d.value);n.value=e.getTime().toString()},s=()=>{u?this.submit():this.cancel()},p=()=>{n.value=null,this.submit()};a.watch("value",(()=>c())),d.watch("value",(()=>c()));const m=document.createElement("div"),f=document.createElement("div");a.container=m,d.container=f;const y=document.createElement("button");y.classList.add(D,w),y.onclick=()=>s(),y.title=null==r?void 0:r.save;const g=document.createElement("button");g.classList.add(D,I),g.onclick=()=>p(),g.title=null==r?void 0:r.clear;const v=document.createElement("div");v.classList.add(O),v.appendChild(m),!1!==o.includeTime&&v.appendChild(f);const b=document.createElement("div");b.classList.add(C),b.appendChild(v),b.appendChild(y),b.appendChild(g),a.when((()=>{var e;return null==(e=this.grid)?void 0:e.notifyResize()})),d.when((()=>{var e;return null==(e=this.grid)?void 0:e.notifyResize()})),this.removeCellContent(t),t.appendChild(b),null==(i=this.grid)||i.notifyResize()},i._createSelectElement=function(e,t,n){let i=!1;const o=t.map((t=>{t.value===e&&(i=!0);const n=document.createElement("option");return n.text=t.name,n.value=t.value,n}));if(null!=e&&""!==e&&!i){const t=document.createElement("option");t.text=e,t.value=e,o.unshift(t)}if(!n.required&&null==n.value){const e=document.createElement("option");e.value="",o.unshift(e)}const r=document.createElement("select");return o.forEach((e=>r.add(e))),r.value=e,r},i._setUpInputField=function(e,t){const{config:n,field:i,layer:o}=this,r=new y({config:n,feature:e,field:i,layer:o,group:null,messages:null});return r.set("value",t),r},i._isDomainCompatible=function(e){const{field:t}=this;if(e&&"coded-value"===e.type){const n=typeof e.codedValues[0].code;if("string"===n&&s.isStringField(t)||"number"===n&&s.isNumericField(t))return!0}return!(!e||"range"!==e.type||!s.isNumericField(t))},i._getDomainForFeature=function(e){const{layer:t,name:n}=this,{typeIdField:i}=t,o=i===n,r=this.get("field.domain");if(o&&!r)return new c({name:"__internal-type-based-coded-value-domain__",codedValues:t.types.map((({id:e,name:t})=>({code:e,name:t})))});const l=i&&t.getFieldDomain(n,{feature:e})||r,a=this.get("config.domain");return this._isDomainCompatible(a)?a:l},i._getComputedDomain=function(e,t){if(!t)return null;if("range"===t.type)return e;if("coded-value"===t.type){const n=t.codedValues.filter((t=>t.hasOwnProperty("code")&&t.code===e));return n&&n.length?n[0].name:e}return null},i._getCombinedDateTime=function(e,t){return new Date(e.getFullYear(),e.getMonth(),e.getDate(),t.getHours(),t.getMinutes(),t.getSeconds())},e._createClass(n,[{key:"editable",get:function(){var e,t,n;return this.editingEnabled?this.config?!1!==this.config.editable&&(null==(t=this.field)?void 0:t.editable):null==(n=this.field)?void 0:n.editable:!!this.config&&(!0===this.config.editable&&(null==(e=this.field)?void 0:e.editable))}},{key:"header",get:function(){var e;return(null==(e=this.config)?void 0:e.label)||this.alias||this.path||null}},{key:"hidden",get:function(){const{config:e}=this;return!1===(null==e?void 0:e.visible)||this._get("hidden")||!1},set:function(e){this._set("hidden",e)}},{key:"loadingMessage",get:function(){var e;return(null==(e=this.messages)?void 0:e.loading)||"..."}},{key:"maxLength",get:function(){var e,t;const n=null==(e=this.field)?void 0:e.length,i=null==(t=this.config)?void 0:t.maxLength;return!isNaN(i)&&i>=-1&&(-1===n||i<=n)?i:n}},{key:"required",get:function(){const e=this.get("field.nullable"),t=this.get("config.required");return this.editable&&(!e||!0===t)}},{key:"sortable",get:function(){var e;return!1!==(null==(e=this.config)?void 0:e.sortable)}}]),n}(g);return t.__decorate([r.property({readOnly:!0,aliasOf:"field.alias"})],S.prototype,"alias",void 0),t.__decorate([r.property()],S.prototype,"cellValueFormatFunction",void 0),t.__decorate([r.property()],S.prototype,"cellValueValidatorFunction",void 0),t.__decorate([r.property()],S.prototype,"config",void 0),t.__decorate([r.property({readOnly:!0,aliasOf:"field.defaultValue"})],S.prototype,"defaultValue",void 0),t.__decorate([r.property({readOnly:!0,aliasOf:"field.description"})],S.prototype,"description",void 0),t.__decorate([r.property()],S.prototype,"direction",void 0),t.__decorate([r.property({readOnly:!0,dependsOn:["config","editingEnabled","field.editable"]})],S.prototype,"editable",null),t.__decorate([r.property()],S.prototype,"editingEnabled",void 0),t.__decorate([r.property()],S.prototype,"field",void 0),t.__decorate([r.property()],S.prototype,"formatFunction",void 0),t.__decorate([r.property({readOnly:!0,dependsOn:["alias","config"]})],S.prototype,"header",null),t.__decorate([r.property({dependsOn:["config"]})],S.prototype,"hidden",null),t.__decorate([r.property()],S.prototype,"headerRenderFunction",void 0),t.__decorate([r.property()],S.prototype,"inputRenderFunction",void 0),t.__decorate([r.property()],S.prototype,"layer",void 0),t.__decorate([r.property({readOnly:!0,dependsOn:["messages"]})],S.prototype,"loadingMessage",null),t.__decorate([r.property({dependsOn:["field.length","config"]})],S.prototype,"maxLength",null),t.__decorate([r.property({readOnly:!0,aliasOf:"config.menuConfig"})],S.prototype,"menuConfig",void 0),t.__decorate([r.property({readOnly:!0,aliasOf:"field.name"})],S.prototype,"name",void 0),t.__decorate([r.property({readOnly:!0,aliasOf:"field.nullable"})],S.prototype,"nullable",void 0),t.__decorate([r.property()],S.prototype,"parseInputValueFunction",void 0),t.__decorate([r.property({readOnly:!0,aliasOf:"field.name"})],S.prototype,"path",void 0),t.__decorate([r.property({readOnly:!0,dependsOn:["field","config"]})],S.prototype,"required",null),t.__decorate([r.property({dependsOn:["config"]})],S.prototype,"sortable",null),t.__decorate([r.property({readOnly:!0,aliasOf:"field.type"})],S.prototype,"type",void 0),t.__decorate([r.property()],S.prototype,"updateRowItemFunction",void 0),S=t.__decorate([l.subclass("esri.widgets.FeatureTable.FieldColumn")],S),S}));
