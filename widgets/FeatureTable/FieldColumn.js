/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/maybe","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/accessorSupport/decorators/subclass","../../intl/date","../../intl/number","../../layers/support/CodedValueDomain","../../layers/support/editableLayers","../../layers/support/fieldUtils","../../layers/support/layerUtils","../FeatureForm/InputField","./Grid/EditorColumn","../support/DatePicker","../support/TimePicker","../support/widgetUtils"],(function(e,t,n,i,o,r,a,l,u,d,c,p,s,m,f,y,h,_,g){"use strict";const v={cancelEdit:"Escape"},b="esri-field-column",F={headerContent:`${b}__header-content`,headerLabel:`${b}__header-label`,input:`${b}__cell-input`,inputContainer:`${b}__cell__input-container`,dateInputContainer:`${b}__cell__date-input-container`,dateInputWrapper:`${b}__cell__date-input-wrapper`,button:`${b}__button`,saveIcon:"esri-icon-save",trashIcon:"esri-icon-trash",locked:"esri-icon-locked"},C=u.convertDateFormatToIntlOptions("short-date-short-time"),I=u.convertDateFormatToIntlOptions("short-date"),E={useGrouping:!0,maximumFractionDigits:20};let D=function(t){function o(i){var o;return(o=t.call(this,i)||this)._inputField=null,o.cellValueFormatFunction=({rowData:t,value:n})=>{if(o.formatFunction){const{config:t,field:i}=e._assertThisInitialized(o);return o.formatFunction({config:t,field:i,value:g.renderingSanitizer.sanitize(n)})}if(null===n)return"&nbsp;";const{config:i,field:r}=e._assertThisInitialized(o),{item:{feature:a}}=t,l=o._getDomainForFeature(a);if(l)return o._getComputedDomain(n,l);if("date"===r.type){const e=o._getDateFormatOptions(),t="feature"===o.layer?.type&&o.layer.datesInUnknownTimezone?{timeZone:"UTC"}:null;return n?u.formatDate(n,{...e,...t}):null}if(s.isNumericField(r)){const e=i?.format?d.convertNumberFormatToIntlOptions(i.format):E;return d.formatNumber(parseFloat(n),e)}return g.renderingSanitizer.sanitize(n)},o.cellValueValidatorFunction=({oldValue:e,value:t})=>!(o._inputField&&!o._inputField.valid)&&(!(o.required&&(!n.isSome(t)||""===t))&&e!==t),o.config=null,o.editingEnabled=!1,o.expressionInfos=null,o.field=null,o.formatFunction=null,o.headerRenderFunction=t=>{const{root:n}=t,{editable:i,editingEnabled:r,headerMenuEnabled:a,sortable:l}=e._assertThisInitialized(o);if(o.removeCellContent(n),n.classList.add(F.headerContent),r&&!i&&n.appendChild(o.createLockedElement()),l)o.headerSorterRenderFunction(t);else{const e=document.createElement("div");e.classList.add(F.headerLabel),e.textContent=o.label,n.appendChild(e)}a&&o.headerMenuRenderFunction(t)},o.inputRenderFunction=({root:e,column:t,rowData:n})=>{if(o.activeEditInfo?.updating)return;if(!o.editable)return;const i=o.getCellValue(t,n),r=o.createInputElement({root:e,column:t,rowData:n,value:i});if(o._set("activeEditInfo",{column:t,input:r,root:e,rowData:n,updating:!0,oldValue:i}),"date"===o.field.type)return void o._renderDateEditors(i,e,r);const a=o.createInputContainer();a.appendChild(r),o.removeCellContent(e),e.appendChild(a),r.focus(),r instanceof HTMLInputElement&&r.select(),o.grid?.notifyResize()},o.layer=null,o.parseInputValueFunction=({input:e})=>{const t=o._inputField,n=e.value,{required:i,type:r}=t;return i||""!==n?"number"===r||"date"===r?parseFloat(n):"text"===r?n.trim():n:null},o.store=null,o.template=null,o.updateRowItemFunction=({rowData:e,column:t,value:n})=>{e.item.feature.attributes[t.path]=n},o.updateStoreItemFunction=function(){var t=e._asyncToGenerator((function*({rowData:e,column:t,value:n}){if(!e||!o.store)return;const i=e.item.objectId,r=o.store.getObjectIdIndex(i)??e.index;yield o.store.updateItem({index:r,name:t.path,value:n})}));return function(e){return t.apply(this,arguments)}}(),o}e._inheritsLoose(o,t);var r=o.prototype;return r.createInputElement=function({rowData:e,value:t}){const{item:n}=e;if(!n||!n.feature)return null;this._inputField=this._setUpInputField(n.feature,t);const{field:i,maxLength:o,minLength:r,required:a}=this,{domain:l}=this._inputField;let u=null;"coded-value"===l?.type?(u=this._createSelectElement(t,l.codedValues.map((({code:e,name:t})=>({value:e,name:t}))),this._inputField),u.onchange=()=>{u.onblur=null,c()}):(u=document.createElement("input"),u.type=s.isNumericField(i)?"number":"text",o>-1&&(u.maxLength=o),r>0&&(u.minLength=r)),u.classList.add(F.input),u.value=t,u.required=a;let d=!1;u.onkeydown=e=>{d=e.key===v.cancelEdit},u.onblur=()=>{u.onblur=null,c()};const c=()=>{d?this.cancel():this.submit(),this._inputField=null};return u},r.createInputContainer=function(){const e=document.createElement("div");return e.classList.add(F.inputContainer),e},r.createLockedElement=function(){const e=document.createElement("div");return e.classList.add(F.locked),e},r.getCellValue=function({path:e},{item:t}){return t?.feature?.attributes?.[e]??null},r._renderDateEditors=function(e,t,n){const{config:o,messagesCommon:r,template:a}=this,l=e?new Date(e):new Date(Date.now()),u=new h({dateInputEnabled:!0,value:l}),d=new _({value:l});n.value=l.getTime().toString();let c=!e;const p=()=>{c=!0;const e=this._getCombinedDateTime(u.value,d.value);n.value=e.getTime().toString()},s=()=>{c?this.submit():this.cancel()},m=()=>{n.value=null,this.submit()};i.watch((()=>[u.value,d.value]),(()=>p()));const f=document.createElement("div"),y=document.createElement("div");u.container=f,d.container=y;const g=document.createElement("button");g.classList.add(F.button,F.saveIcon),g.onclick=()=>s(),g.title=r?.save;const v=document.createElement("button");v.classList.add(F.button,F.trashIcon),v.onclick=()=>m(),v.title=r?.clear;const b=document.createElement("div");b.classList.add(F.dateInputWrapper),b.appendChild(f),(a&&a.input&&"datetime-picker"===a.input.type&&!1!==a.input.includeTime||o&&!1!==o.includeTime)&&b.appendChild(y);const C=document.createElement("div");C.classList.add(F.dateInputContainer),C.appendChild(b),C.appendChild(g),C.appendChild(v),u.when((()=>this.grid?.notifyResize())),d.when((()=>this.grid?.notifyResize())),this.removeCellContent(t),t.appendChild(C),this.grid?.notifyResize()},r._createSelectElement=function(e,t,n){let i=!1;const o=t.map((t=>{t.value===e&&(i=!0);const n=document.createElement("option");return n.text=t.name,n.value=t.value,n}));if(null!=e&&""!==e&&!i){const t=document.createElement("option");t.text=e,t.value=e,o.unshift(t)}if(!n.required&&null==n.value){const e=document.createElement("option");e.value="",o.unshift(e)}const r=document.createElement("select");return o.forEach((e=>r.add(e))),r.value=e,r},r._setUpInputField=function(e,t){const{config:n,field:i,layer:o}=this,r=new f({config:n,feature:e,initialFeature:e.clone(),field:i,layer:o,group:null,messages:null});return r.set("value",t),r},r._isDomainCompatible=function(e){const{field:t}=this;if(e&&"coded-value"===e.type){const n=typeof e.codedValues[0].code;if("string"===n&&s.isStringField(t)||"number"===n&&s.isNumericField(t))return!0}return!(!e||"range"!==e.type||!s.isNumericField(t))},r._getDomainForFeature=function(e){const{config:t,layer:n,name:i,template:o}=this;if("wfs"===n.type||"geojson"===n.type||"csv"===n.type)return null;if(o?.domain&&this._isDomainCompatible(o.domain))return o.domain;const{typeIdField:r}=n,a=r===i,l=this.field.domain;if(a&&!l)return new c({name:"__internal-type-based-coded-value-domain__",codedValues:n.types.map((({id:e,name:t})=>({code:e,name:t})))});const u=r&&n.getFieldDomain(i,{feature:e})||l,d=t?.domain;return this._isDomainCompatible(d)?d:u},r._getComputedDomain=function(e,t){if(!t)return null;if("range"===t.type)return e;if("coded-value"===t.type){const n=t.codedValues.filter((t=>t.hasOwnProperty("code")&&t.code===e));return n&&n.length?n[0].name:e}return null},r._getCombinedDateTime=function(e,t){return new Date(e.getFullYear(),e.getMonth(),e.getDate(),t.getHours(),t.getMinutes(),t.getSeconds())},r._getDateFormatOptions=function(){const{config:e,template:t}=this,n=t?.format?.dateFormat||e?.format?.dateFormat;return n?u.convertDateFormatToIntlOptions(n):t&&t.input&&"includeTime"in t.input==!1||!1===e?.includeTime?I:C},e._createClass(o,[{key:"alias",get:function(){return this.field?.alias}},{key:"defaultValue",get:function(){return this.field?.defaultValue}},{key:"description",get:function(){return this.template?.description??this.config?.description??this.field?.description??null}},{key:"editable",get:function(){const{config:e,editingEnabled:t,field:i,layer:o,template:r}=this;if(n.isNone(i)||n.isNone(o))return!1;const a=p.isEditableLayer(o),l=m.getEffectiveLayerCapabilities(o)?.operations.supportsUpdate;return!!(i.editable&&a&&l)&&(t?!(!1===r?.editable||!1===e?.editable):!(!r?.editable&&!e?.editable))}},{key:"header",get:function(){return this.template?.label||this.config?.label||this.alias||this.path||null}},{key:"hidden",get:function(){const{config:e}=this;return!1===e?.visible||this._get("hidden")||!1},set:function(e){this._set("hidden",e)}},{key:"loadingMessage",get:function(){return this.messages?.loading||"..."}},{key:"maxLength",get:function(){const{field:e,config:t,template:n}=this,i=e?.length,o=n?.input&&"maxLength"in n.input?n.input.maxLength:t?.maxLength;return!isNaN(o)&&o>=-1&&(-1===i||o<=i)?o:i}},{key:"minLength",get:function(){const{config:e,template:t,maxLength:n}=this,i=t?.input&&"minLength"in t.input?t.input.minLength:e?.minLength||null;return n&&i<=n?i:null}},{key:"name",get:function(){return this.field?.name}},{key:"nullable",get:function(){return this.field?.nullable??!1}},{key:"path",get:function(){return this.field?.name}},{key:"required",get:function(){const{config:e,field:t,template:n}=this,i=t?.nullable,o=e?.required,r=n?.required;return this.editable&&(!i||!0===o||!0===r)}},{key:"sortable",get:function(){return this.template?!1!==this.template?.sortable:!1!==this.config?.sortable}}]),o}(y);t.__decorate([o.property({readOnly:!0})],D.prototype,"alias",null),t.__decorate([o.property()],D.prototype,"cellValueFormatFunction",void 0),t.__decorate([o.property()],D.prototype,"cellValueValidatorFunction",void 0),t.__decorate([o.property()],D.prototype,"config",void 0),t.__decorate([o.property({readOnly:!0})],D.prototype,"defaultValue",null),t.__decorate([o.property({readOnly:!0})],D.prototype,"description",null),t.__decorate([o.property({readOnly:!0})],D.prototype,"editable",null),t.__decorate([o.property()],D.prototype,"editingEnabled",void 0),t.__decorate([o.property()],D.prototype,"expressionInfos",void 0),t.__decorate([o.property()],D.prototype,"field",void 0),t.__decorate([o.property()],D.prototype,"formatFunction",void 0),t.__decorate([o.property({readOnly:!0})],D.prototype,"header",null),t.__decorate([o.property()],D.prototype,"hidden",null),t.__decorate([o.property()],D.prototype,"headerRenderFunction",void 0),t.__decorate([o.property()],D.prototype,"inputRenderFunction",void 0),t.__decorate([o.property()],D.prototype,"layer",void 0),t.__decorate([o.property({readOnly:!0})],D.prototype,"loadingMessage",null),t.__decorate([o.property()],D.prototype,"maxLength",null),t.__decorate([o.property()],D.prototype,"minLength",null),t.__decorate([o.property({readOnly:!0})],D.prototype,"name",null),t.__decorate([o.property({readOnly:!0})],D.prototype,"nullable",null),t.__decorate([o.property()],D.prototype,"parseInputValueFunction",void 0),t.__decorate([o.property({readOnly:!0})],D.prototype,"path",null),t.__decorate([o.property({readOnly:!0})],D.prototype,"required",null),t.__decorate([o.property()],D.prototype,"sortable",null),t.__decorate([o.property()],D.prototype,"store",void 0),t.__decorate([o.property()],D.prototype,"template",void 0),t.__decorate([o.property()],D.prototype,"updateRowItemFunction",void 0),t.__decorate([o.property()],D.prototype,"updateStoreItemFunction",void 0),D=t.__decorate([l.subclass("esri.widgets.FeatureTable.FieldColumn")],D);return D}));
