// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../core/accessorSupport/decorators","../../intl/date","../../intl/number","../../layers/support/CodedValueDomain","../../layers/support/fieldUtils","../FeatureForm/InputField","./Grid/EditorColumn","../support/DatePicker","../support/TimePicker","../support/widgetUtils"],(function(e,t,n,r,o,i,a,l,d,u,p,c,s){"use strict";var f="Escape",v="esri-field-column__header-content",m="esri-field-column__cell-input",y="esri-field-column__cell__input-container",g="esri-field-column__cell__date-input-container",_="esri-field-column__cell__date-input-wrapper",h="esri-field-column__button",b="esri-icon-save",F="esri-icon-trash",O="esri-icon-locked",E=o.convertDateFormatToIntlOptions("short-date-short-time"),C=o.convertDateFormatToIntlOptions("short-date"),D=i.convertNumberFormatToIntlOptions({digitSeparator:!0,places:null});return function(e){function t(t){var n=e.call(this,t)||this;return n._inputField=null,n.alias=null,n.cellValueFormatFunction=function(e){var t,r=e.rowData,a=e.value;if(n.formatFunction){var d=n,u=d.config,p=d.field;return n.formatFunction({config:u,field:p,value:s.renderingSanitizer.sanitize(a)})}if(null===a)return"&nbsp;";var c=n,f=c.config,v=c.field,m=c.type,y=r.item.feature,g=n._getDomainForFeature(y);if(g)return n._getComputedDomain(a,g);if("date"===m){var _=(null===(t=null==f?void 0:f.format)||void 0===t?void 0:t.dateFormat)?o.convertDateFormatToIntlOptions(f.format.dateFormat):!1===(null==f?void 0:f.includeTime)?C:E;return a?o.formatDate(a,_):null}if(l.isNumericField(v)){_=(null==f?void 0:f.format)?i.convertNumberFormatToIntlOptions(f.format):D;return i.formatNumber(parseFloat(a),_)}return s.renderingSanitizer.sanitize(a)},n.cellValueValidatorFunction=function(e){return e.oldValue!==e.value},n.config=null,n.defaultValue=null,n.description=null,n.direction=null,n.editingEnabled=!1,n.field=null,n.formatFunction=null,n.headerRenderFunction=function(e){var t=e.root,r=n,o=r.editable,i=r.editingEnabled,a=r.headerMenuEnabled,l=r.sortable;if(n.removeCellContent(t),t.classList.add(v),i&&!o&&t.appendChild(n.createLockedElement()),l)n.headerSorterRenderFunction(e);else{var d=n,u=d.header,p=d.path,c=document.createElement("div");c.innerHTML=u||p,t.appendChild(c)}a&&n.headerMenuRenderFunction(e)},n.inputRenderFunction=function(e){var t,r,o=e.root,i=e.column,a=e.rowData;if((null===(t=n.activeEditInfo)||void 0===t||!t.updating)&&n.editable){var l=n.getCellValue(i,a),d=n.createInputElement({root:o,column:i,rowData:a,value:l});if(n._set("activeEditInfo",{column:i,input:d,root:o,rowData:a,updating:!0,oldValue:l}),"date"!==n.type){var u=n.createInputContainer();u.appendChild(d),n.removeCellContent(o),o.appendChild(u),d.focus(),d instanceof HTMLInputElement&&d.select(),null===(r=n.grid)||void 0===r||r.notifyResize()}else n._renderDateEditors(l,o,d)}},n.layer=null,n.menuConfig=null,n.name=null,n.nullable=!0,n.parseInputValueFunction=function(e){var t=e.input,r=n._inputField,o=t.value,i=r.required,a=r.type;return i||""!==o?"number"===a?parseFloat(o):"date"===a?parseFloat(o):o:null},n.path=null,n.type=null,n.updateRowItemFunction=function(e){var t=e.rowData,n=e.column,r=e.value;t.item.feature.attributes[n.path]=r},n}return n.__extends(t,e),Object.defineProperty(t.prototype,"editable",{get:function(){var e,t,n;return this.editingEnabled?this.config?!1!==this.config.editable&&(null===(e=this.field)||void 0===e?void 0:e.editable):null===(t=this.field)||void 0===t?void 0:t.editable:!!this.config&&(!0===this.config.editable&&(null===(n=this.field)||void 0===n?void 0:n.editable))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"header",{get:function(){var e;return(null===(e=this.config)||void 0===e?void 0:e.label)||this.alias||this.path||null},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"hidden",{get:function(){var e=this.config;return!1===(null==e?void 0:e.visible)||this._get("hidden")||!1},set:function(e){this._set("hidden",e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"loadingMessage",{get:function(){var e;return(null===(e=this.messages)||void 0===e?void 0:e.loading)||"..."},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"maxLength",{get:function(){var e,t,n=null===(e=this.field)||void 0===e?void 0:e.length,r=null===(t=this.config)||void 0===t?void 0:t.maxLength;return!isNaN(r)&&r>=-1&&(-1===n||r<=n)?r:n},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"required",{get:function(){var e=this.get("field.nullable"),t=this.get("config.required");return this.editable&&(!e||!0===t)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"sortable",{get:function(){var e;return!1!==(null===(e=this.config)||void 0===e?void 0:e.sortable)},enumerable:!1,configurable:!0}),t.prototype.createInputElement=function(e){var t=this,n=e.rowData,r=e.value,o=n.item;if(!o||!o.feature)return null;this._inputField=this._setUpInputField(o.feature,r);var i=this.field,a=this.maxLength,d=this.required,u=this._inputField.domain,p=null;"coded-value"===(null==u?void 0:u.type)?(p=this._createSelectElement(r,u.codedValues.map((function(e){return{value:e.code,name:e.name}})),this._inputField)).onchange=function(){p.onblur=null,s()}:((p=document.createElement("input")).type=l.isNumericField(i)?"number":"text",a>-1&&(p.maxLength=a)),p.classList.add(m),p.value=r,p.required=d;var c=!1;p.onkeydown=function(e){c=e.key===f},p.onblur=function(){p.onblur=null,s()};var s=function(){c?t.cancel():t.submit(),t._inputField=null};return p},t.prototype.createInputContainer=function(){var e=document.createElement("div");return e.classList.add(y),e},t.prototype.createLockedElement=function(){var e=document.createElement("div");return e.classList.add(O),e},t.prototype.getCellValue=function(e,t){var n,r,o=e.path,i=t.item;return(null===(r=null===(n=null==i?void 0:i.feature)||void 0===n?void 0:n.attributes)||void 0===r?void 0:r[o])||null},t.prototype._renderDateEditors=function(e,t,n){var r,o=this,i=this.config,a=this.messagesCommon,l=e?new Date(e):new Date(Date.now()),d=new p({dateInputEnabled:!0,value:l}),u=new c({value:l});n.value=l.getTime().toString();var s=!e,f=function(){s=!0;var e=o._getCombinedDateTime(d.value,u.value);n.value=e.getTime().toString()};d.watch("value",(function(){return f()})),u.watch("value",(function(){return f()}));var v=document.createElement("div"),m=document.createElement("div");d.container=v,u.container=m;var y=document.createElement("button");y.classList.add(h,b),y.onclick=function(){s?o.submit():o.cancel()},y.title=null==a?void 0:a.save;var O=document.createElement("button");O.classList.add(h,F),O.onclick=function(){return n.value=null,void o.submit()},O.title=null==a?void 0:a.clear;var E=document.createElement("div");E.classList.add(_),E.appendChild(v),!1!==i.includeTime&&E.appendChild(m);var C=document.createElement("div");C.classList.add(g),C.appendChild(E),C.appendChild(y),C.appendChild(O),d.when((function(){var e;return null===(e=o.grid)||void 0===e?void 0:e.notifyResize()})),u.when((function(){var e;return null===(e=o.grid)||void 0===e?void 0:e.notifyResize()})),this.removeCellContent(t),t.appendChild(C),null===(r=this.grid)||void 0===r||r.notifyResize()},t.prototype._createSelectElement=function(e,t,n){var r,o=!1,i=t.map((function(t){t.value===e&&(o=!0);var n=document.createElement("option");return n.text=t.name,n.value=t.value,n}));null==e||""===e||o||((r=document.createElement("option")).text=e,r.value=e,i.unshift(r));n.required||null!=n.value||((r=document.createElement("option")).value="",i.unshift(r));var a=document.createElement("select");return i.forEach((function(e){return a.add(e)})),a.value=e,a},t.prototype._setUpInputField=function(e,t){var n=this.config,r=this.field,o=this.layer,i=new d({config:n,feature:e,field:r,layer:o,group:null,messages:null});return i.set("value",t),i},t.prototype._isDomainCompatible=function(e){var t=this.field;if(e&&"coded-value"===e.type){var n=typeof e.codedValues[0].code;if("string"===n&&l.isStringField(t)||"number"===n&&l.isNumericField(t))return!0}return!(!e||"range"!==e.type||!l.isNumericField(t))},t.prototype._getDomainForFeature=function(e){var t=this.layer,n=this.name,r=t.typeIdField,o=r===n,i=this.get("field.domain");if(o&&!i)return new a({name:"__internal-type-based-coded-value-domain__",codedValues:t.types.map((function(e){return{code:e.id,name:e.name}}))});var l=r&&t.getFieldDomain(n,{feature:e})||i,d=this.get("config.domain");return this._isDomainCompatible(d)?d:l},t.prototype._getComputedDomain=function(e,t){if(!t)return null;if("range"===t.type)return e;if("coded-value"===t.type){var n=t.codedValues.filter((function(t){return t.hasOwnProperty("code")&&t.code===e}));return n&&n.length?n[0].name:e}return null},t.prototype._getCombinedDateTime=function(e,t){return new Date(e.getFullYear(),e.getMonth(),e.getDate(),t.getHours(),t.getMinutes(),t.getSeconds())},n.__decorate([r.property({readOnly:!0,aliasOf:"field.alias"})],t.prototype,"alias",void 0),n.__decorate([r.property()],t.prototype,"cellValueFormatFunction",void 0),n.__decorate([r.property()],t.prototype,"cellValueValidatorFunction",void 0),n.__decorate([r.property()],t.prototype,"config",void 0),n.__decorate([r.property({readOnly:!0,aliasOf:"field.defaultValue"})],t.prototype,"defaultValue",void 0),n.__decorate([r.property({readOnly:!0,aliasOf:"field.description"})],t.prototype,"description",void 0),n.__decorate([r.property()],t.prototype,"direction",void 0),n.__decorate([r.property({readOnly:!0,dependsOn:["config","editingEnabled","field.editable"]})],t.prototype,"editable",null),n.__decorate([r.property()],t.prototype,"editingEnabled",void 0),n.__decorate([r.property()],t.prototype,"field",void 0),n.__decorate([r.property()],t.prototype,"formatFunction",void 0),n.__decorate([r.property({readOnly:!0,dependsOn:["alias","config"]})],t.prototype,"header",null),n.__decorate([r.property({dependsOn:["config"]})],t.prototype,"hidden",null),n.__decorate([r.property()],t.prototype,"headerRenderFunction",void 0),n.__decorate([r.property()],t.prototype,"inputRenderFunction",void 0),n.__decorate([r.property()],t.prototype,"layer",void 0),n.__decorate([r.property({readOnly:!0,dependsOn:["messages"]})],t.prototype,"loadingMessage",null),n.__decorate([r.property({dependsOn:["field.length","config"]})],t.prototype,"maxLength",null),n.__decorate([r.property({readOnly:!0,aliasOf:"config.menuConfig"})],t.prototype,"menuConfig",void 0),n.__decorate([r.property({readOnly:!0,aliasOf:"field.name"})],t.prototype,"name",void 0),n.__decorate([r.property({readOnly:!0,aliasOf:"field.nullable"})],t.prototype,"nullable",void 0),n.__decorate([r.property()],t.prototype,"parseInputValueFunction",void 0),n.__decorate([r.property({readOnly:!0,aliasOf:"field.name"})],t.prototype,"path",void 0),n.__decorate([r.property({readOnly:!0,dependsOn:["field","config"]})],t.prototype,"required",null),n.__decorate([r.property({dependsOn:["config"]})],t.prototype,"sortable",null),n.__decorate([r.property({readOnly:!0,aliasOf:"field.type"})],t.prototype,"type",void 0),n.__decorate([r.property()],t.prototype,"updateRowItemFunction",void 0),t=n.__decorate([r.subclass("esri.widgets.FeatureTable.FieldColumn")],t)}(u)}));