/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../intl","../../core/Accessor","../../core/HandleOwner","../../core/maybe","../../core/uid","../../core/accessorSupport/decorators/property","../../core/arrayUtils","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass","../../core/has","../../layers/support/CodedValueDomain","../../layers/support/Domain","../../layers/support/InheritedDomain","../../layers/support/RangeDomain","../../layers/support/domainUtils","../../layers/support/fieldUtils","../../intl/substitute"],(function(e,t,i,r,o,n,l,s,a,u,p,d,c,y,_,m,f,E,h){"use strict";var g,v;!function(e){e.Text="text",e.Number="number",e.Date="date",e.Unsupported="unsupported"}(g||(g={})),function(e){e.TOO_SHORT="length-validation-error::too-short"}(v||(v={}));const b={type:"number"},x={type:"number",intlOptions:{notation:"scientific"}},V={type:"date",intlOptions:{day:"2-digit",month:"2-digit",year:"numeric",hour:"numeric",minute:"numeric",second:"numeric"}};function F(e){return e>=1e7||e<=-1e7}let k=function(t){function i(e){var i;return(i=t.call(this,e)||this)._storedValue=null,i.editableExpressionExecutor=null,i.id=l.generateUID().toString(),i.requiredExpressionExecutor=null,i.valueExpressionExecutor=null,i.visibilityExpressionExecutor=null,i.feature=null,i.field=null,i.fieldElement=null,i.layer=null,i.error=null,i.group=null,i.messages=null,i}e._inheritsLoose(i,t);var r=i.prototype;return r._isDomainCompatible=function(e){const{field:t}=this;if("coded-value"===e?.type){const i=typeof e.codedValues[0].code;if("string"===i&&E.isStringField(t)||"number"===i&&E.isNumericField(t))return!0}return!!("range"===e?.type&&E.isNumericField(t)||E.isDateField(t))},r._validate=function(){const{domain:e,field:t,initialFeature:i,minLength:r,required:o,type:n,valid:l,value:s}=this,a=o&&null===s,u=void 0!==l;return!a&&i.getAttribute(t.name)===s&&u?null:a?E.TypeValidationError.INVALID_TYPE:"text"===n&&r>-1&&"string"==typeof s&&s.length<r?v.TOO_SHORT:e?null!==s||o?f.validateDomainValue(e,s):null:E.validateFieldValue(t,s)},r._isVisibleByDefault=function(){const e=this.field?.type;return"oid"!==e&&"global-id"!==e&&!this._isGeometryField()},r._isEditorField=function(){return E.getFeatureEditFields(this.layer).includes(this.name)},r._isGeometryField=function(){return E.getFeatureGeometryFields(this.layer).includes(this.name)},r._shouldUseValueExpression=function(){return this._layerFieldAllowsEdits&&!this._configAllowsEdits&&n.isSome(this.valueExpressionExecutor)},r._toErrorMessage=function(){const{domain:e,field:t,messages:i,minLength:r,value:o,required:n,type:l}=this,s=this.error;if(n&&null===o)return i.validationErrors.cannotBeNull;if(s===f.DomainValidationError.VALUE_OUT_OF_RANGE||s===E.NumericRangeValidationError.OUT_OF_RANGE){const r=f.getDomainRange(e)||E.getFieldRange(t);return h.substitute(i.validationErrors.outsideRange,r,{format:{max:"date"===l?V:F(r.max)?x:b,min:"date"===l?V:F(r.min)?x:b}})}return s===f.DomainValidationError.INVALID_CODED_VALUE?i.validationErrors.invalidCodedValue:s===E.TypeValidationError.INVALID_TYPE?i.validationErrors.invalidType:s===v.TOO_SHORT?h.substitute(i.validationErrors.tooShort,{min:r}):null},e._createClass(i,[{key:"_configAllowsEdits",get:function(){const{fieldElement:e,layer:t,name:i}=this;if(n.isSome(e))return e.editableExpression?this.evaluatedEditableExpression:!1!==e.editable;return("subtype-group"!==t?.type?t?.popupTemplate?.fieldInfos?.find((({fieldName:e})=>e===i)):null)?.isEditable??!0}},{key:"_layerFieldAllowsEdits",get:function(){const{field:e,layer:t}=this;return t?.capabilities.operations.supportsEditing&&e?.editable}},{key:"isUsingValueExpression",get:function(){return this._shouldUseValueExpression()}},{key:"evaluatedEditableExpression",get:function(){const{editableExpressionExecutor:e}=this;return n.isSome(e)?!!e.lastEvaluatedValue:null}},{key:"evaluatedRequiredExpression",get:function(){const{requiredExpressionExecutor:e}=this;return n.isSome(e)?!!e.lastEvaluatedValue:null}},{key:"evaluatedVisibilityExpression",get:function(){const{visibilityExpressionExecutor:e}=this;return n.isSome(e)?!!e.lastEvaluatedValue:null}},{key:"evaluatedValueExpression",get:function(){const{valueExpressionExecutor:e}=this;return n.isSome(e)?e.lastEvaluatedValue:null}},{key:"initialFeature",set:function(e){this._set("initialFeature",e),this.notifyChange("valid")}},{key:"description",get:function(){return n.unwrap(this.fieldElement)?.description}},{key:"domain",get:function(){const{layer:e}=this,t="typeIdField"in e?e.typeIdField:null,i=t===this.name,r=this.field?.domain;if(i&&!r){const t="subtype-group"===e.type?e.sublayers.map((({subtypeCode:e,title:t})=>({id:e,name:t}))):e.types.map((({id:e,name:t})=>({code:e,name:t})));return new c({name:"__internal-type-based-coded-value-domain__",codedValues:t})}const{feature:o}=this,l=t&&this.layer.getFieldDomain(this.name,{feature:o})||r,s=n.get(this.fieldElement,"domain");return n.isSome(s)&&this._isDomainCompatible(s)?s:l}},{key:"editable",get:function(){return!!this._layerFieldAllowsEdits&&(this.evaluatedEditableExpression??this._configAllowsEdits)}},{key:"inputType",get:function(){return n.unwrap(this.fieldElement)?.input?.type}},{key:"errorMessage",get:function(){return this._toErrorMessage()}},{key:"hint",get:function(){return n.unwrap(this.fieldElement)?.hint}},{key:"includeTime",get:function(){const{fieldElement:e}=this,t=n.isSome(e)&&"datetime-picker"===e.input?.type?e.input.includeTime:void 0;return void 0===t||t}},{key:"label",get:function(){return n.isSome(this.fieldElement)&&this.fieldElement.label||this.field.alias||this.field.name}},{key:"maxLength",get:function(){const e=-1;if(this.type===g.Date)return e;const{field:t,fieldElement:i}=this,r=t?.length,o=n.isSome(i)&&S(i.input)?i.input.maxLength:NaN;return!isNaN(o)&&o>=e&&(r===e||o<=r)?o:r}},{key:"minLength",get:function(){const e=-1;if(this.type===g.Date)return e;const{field:t,fieldElement:i}=this,r=t?.length,o=n.isSome(i)&&S(i.input)?i.input.minLength:NaN;return!isNaN(o)&&o>=e&&(r===e||o<=r)?o:e}},{key:"name",get:function(){return this.field?.name}},{key:"required",get:function(){const{editable:e,evaluatedRequiredExpression:t,field:i,visible:r}=this;return!!e&&(!1===i?.nullable||!(!r||!n.isSome(t))&&t)},set:function(e){this._overrideIfSome("required",e)}},{key:"submittable",get:function(){const{field:e,required:t,valid:i,value:r}=this;return(!t||!n.isNone(r))&&(!!i||this.initialFeature.getAttribute(e.name)===r)}},{key:"type",get:function(){const{field:e}=this;return E.isNumericField(e)?g.Number:E.isStringField(e)?g.Text:E.isDateField(e)?g.Date:g.Unsupported}},{key:"updating",get:function(){const{editableExpressionExecutor:e,valueExpressionExecutor:t}=this;return n.isSome(t)&&t.updating||n.isSome(e)&&e.updating}},{key:"valid",get:function(){const e=this.editable?this._validate():null;return this._set("error",e),null===e}},{key:"value",get:function(){if(this._shouldUseValueExpression()){const e=this.evaluatedValueExpression;if(this.type===g.Date){if(e instanceof Date)return e.getTime();if("number"!=typeof e)return parseInt(e,10)}return n.isSome(e)&&"object"==typeof e?e.toString():e}return this.get("_storedValue")},set:function(e){this.notifyChange("evaluatedVisibilityExpression"),this.set("_storedValue",e)}},{key:"visible",get:function(){return!this._isEditorField()&&(n.isSome(this.evaluatedVisibilityExpression)?this.evaluatedVisibilityExpression:!!n.isSome(this.fieldElement)||this._isVisibleByDefault())}}]),i}(o.HandleOwnerMixin(r));function S(e){return!!e&&"maxLength"in e}t.__decorate([s.property()],k.prototype,"_storedValue",void 0),t.__decorate([s.property()],k.prototype,"_configAllowsEdits",null),t.__decorate([s.property()],k.prototype,"_layerFieldAllowsEdits",null),t.__decorate([s.property()],k.prototype,"editableExpressionExecutor",void 0),t.__decorate([s.property()],k.prototype,"requiredExpressionExecutor",void 0),t.__decorate([s.property()],k.prototype,"valueExpressionExecutor",void 0),t.__decorate([s.property()],k.prototype,"isUsingValueExpression",null),t.__decorate([s.property()],k.prototype,"visibilityExpressionExecutor",void 0),t.__decorate([s.property()],k.prototype,"evaluatedEditableExpression",null),t.__decorate([s.property()],k.prototype,"evaluatedRequiredExpression",null),t.__decorate([s.property()],k.prototype,"evaluatedVisibilityExpression",null),t.__decorate([s.property()],k.prototype,"evaluatedValueExpression",null),t.__decorate([s.property()],k.prototype,"feature",void 0),t.__decorate([s.property()],k.prototype,"field",void 0),t.__decorate([s.property({constructOnly:!0})],k.prototype,"fieldElement",void 0),t.__decorate([s.property()],k.prototype,"initialFeature",null),t.__decorate([s.property()],k.prototype,"layer",void 0),t.__decorate([s.property({readOnly:!0})],k.prototype,"description",null),t.__decorate([s.property()],k.prototype,"domain",null),t.__decorate([s.property()],k.prototype,"editable",null),t.__decorate([s.property({readOnly:!0})],k.prototype,"inputType",null),t.__decorate([s.property({readOnly:!0})],k.prototype,"error",void 0),t.__decorate([s.property({dependsOn:["error","messages","value"]})],k.prototype,"errorMessage",null),t.__decorate([s.property()],k.prototype,"group",void 0),t.__decorate([s.property({readOnly:!0})],k.prototype,"hint",null),t.__decorate([s.property()],k.prototype,"includeTime",null),t.__decorate([s.property()],k.prototype,"label",null),t.__decorate([s.property()],k.prototype,"maxLength",null),t.__decorate([s.property()],k.prototype,"minLength",null),t.__decorate([s.property()],k.prototype,"messages",void 0),t.__decorate([s.property({readOnly:!0})],k.prototype,"name",null),t.__decorate([s.property()],k.prototype,"required",null),t.__decorate([s.property()],k.prototype,"submittable",null),t.__decorate([s.property()],k.prototype,"type",null),t.__decorate([s.property()],k.prototype,"updating",null),t.__decorate([s.property()],k.prototype,"valid",null),t.__decorate([s.property({value:null})],k.prototype,"value",null),t.__decorate([s.property()],k.prototype,"visible",null),k=t.__decorate([p.subclass("esri.widgets.FeatureForm.InputField")],k);return k}));
