/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../intl","../../core/Accessor","../../core/HandleOwner","../../core/maybe","../../core/uid","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/accessorSupport/decorators/subclass","../../layers/support/CodedValue","../../core/has","../../layers/support/CodedValueDomain","../../layers/support/Domain","../../layers/support/InheritedDomain","../../layers/support/RangeDomain","../../layers/support/domainUtils","../../layers/support/fieldUtils","../../layers/support/layerUtils","./featureFormUtils","../../intl/substitute"],(function(e,t,i,r,o,n,l,s,a,u,p,d,c,y,_,m,f,E,h,g,v,x){"use strict";var b,V;!function(e){e.Text="text",e.Number="number",e.Date="date",e.Unsupported="unsupported"}(b||(b={})),function(e){e.TOO_SHORT="length-validation-error::too-short"}(V||(V={}));const F={type:"number"},T={type:"number",intlOptions:{notation:"scientific"}},k={type:"date",intlOptions:{day:"2-digit",month:"2-digit",year:"numeric",hour:"numeric",minute:"numeric",second:"numeric"}},D="__internal-type-based-coded-value-domain__";function S(e){return e>=1e7||e<=-1e7}let N=function(t){function i(e){var i;return(i=t.call(this,e)||this)._storedValue=null,i.arcadeEditType="NA",i.editableExpressionExecutor=null,i.id=l.generateUID().toString(),i.requiredExpressionExecutor=null,i.valueExpressionExecutor=null,i.visibilityExpressionExecutor=null,i.feature=null,i.field=null,i.fieldElement=null,i.layer=null,i.error=null,i.group=null,i.messages=null,i}e._inheritsLoose(i,t);var r=i.prototype;return r._isDomainCompatible=function(e){const{field:t}=this;if("coded-value"===e?.type){const i=typeof e.codedValues[0].code;if("string"===i&&h.isStringField(t)||"number"===i&&h.isNumericField(t))return!0}return!!("range"===e?.type&&h.isNumericField(t)||h.isDateField(t))},r._validate=function(){const{domain:e,field:t,initialFeature:i,minLength:r,required:o,type:n,valid:l,value:s}=this,a=o&&null===s,u=void 0!==l;return!a&&i.getAttribute(t.name)===s&&u?null:a?h.TypeValidationError.INVALID_TYPE:"text"===n&&r>-1&&"string"==typeof s&&s.length<r?V.TOO_SHORT:e?null!==s||o?E.validateDomainValue(e,s):null:h.validateFieldValue(t,s)},r._isVisibleByDefault=function(){const e=this.field?.type;return this.field?.visible&&"oid"!==e&&"global-id"!==e&&!this._isGeometryField()},r._isEditorField=function(){return h.getFeatureEditFields(this.layer).includes(this.name)},r._isGeometryField=function(){return h.getFeatureGeometryFields(this.layer).includes(this.name)},r._shouldUseValueExpression=function(){return this._layerFieldAllowsEdits&&!this._configAllowsEdits&&n.isSome(this.valueExpressionExecutor)},r._toErrorMessage=function(){const{domain:e,field:t,messages:i,minLength:r,value:o,required:n,type:l}=this,s=this.error;if(n&&null===o)return i.validationErrors.cannotBeNull;if(s===E.DomainValidationError.VALUE_OUT_OF_RANGE||s===h.NumericRangeValidationError.OUT_OF_RANGE){const r=E.getDomainRange(e)||h.getFieldRange(t);return x.substitute(i.validationErrors.outsideRange,r,{format:{max:"date"===l?k:S(r.max)?T:F,min:"date"===l?k:S(r.min)?T:F}})}return s===E.DomainValidationError.INVALID_CODED_VALUE?i.validationErrors.invalidCodedValue:s===h.TypeValidationError.INVALID_TYPE?i.validationErrors.invalidType:s===V.TOO_SHORT?x.substitute(i.validationErrors.tooShort,{min:r}):null},e._createClass(i,[{key:"_configAllowsEdits",get:function(){const{fieldElement:e,layer:t,name:i}=this;if(n.isSome(e))return e.editableExpression?this.evaluatedEditableExpression:!1!==e.editable;if(t.userHasUpdateItemPrivileges)return!0;return("popupTemplate"in t?t?.popupTemplate?.fieldInfos?.find((({fieldName:e})=>e===i)):null)?.isEditable??!0}},{key:"_layerFieldAllowsEdits",get:function(){const{field:e,layer:t}=this;if(!t||!e)return!1;const i=g.getEffectiveLayerCapabilities(t),r=i?.operations.supportsEditing,o=e.editable,n=O(i,this.arcadeEditType);return!!(r&&o&&n)}},{key:"isUsingValueExpression",get:function(){return this._shouldUseValueExpression()}},{key:"evaluatedEditableExpression",get:function(){const{editableExpressionExecutor:e}=this;return n.isSome(e)?!!e.lastEvaluatedValue:null}},{key:"evaluatedRequiredExpression",get:function(){const{requiredExpressionExecutor:e}=this;return n.isSome(e)?!!e.lastEvaluatedValue:null}},{key:"evaluatedVisibilityExpression",get:function(){const{visibilityExpressionExecutor:e}=this;return n.isSome(e)?!!e.lastEvaluatedValue:null}},{key:"evaluatedValueExpression",get:function(){const{valueExpressionExecutor:e}=this;return n.isSome(e)?e.lastEvaluatedValue:null}},{key:"initialFeature",set:function(e){this._set("initialFeature",e),this.notifyChange("valid")}},{key:"description",get:function(){return n.unwrap(this.fieldElement)?.description}},{key:"domain",get:function(){const{layer:e}=this,{typeFieldName:t,types:i}=v.getNormalizedFeatureTypeInfo(e);if(t===this.name&&n.isNone(this.field.domain))return new y({name:D,codedValues:i.map((({code:e,name:t})=>new d.CodedValue({code:e,name:t})))});const{feature:r}=this,o=e.getFieldDomain(this.name,{feature:r}),l=n.get(this.fieldElement,"domain");return n.isSome(l)&&this._isDomainCompatible(l)?l:o}},{key:"editable",get:function(){return!!this._layerFieldAllowsEdits&&(this.evaluatedEditableExpression??this._configAllowsEdits)}},{key:"inputType",get:function(){return n.unwrap(this.fieldElement)?.input?.type}},{key:"errorMessage",get:function(){return this._toErrorMessage()}},{key:"hint",get:function(){return n.unwrap(this.fieldElement)?.hint}},{key:"includeTime",get:function(){const{fieldElement:e}=this,t=n.isSome(e)&&"datetime-picker"===e.input?.type?e.input.includeTime:void 0;return void 0===t||t}},{key:"label",get:function(){return n.isSome(this.fieldElement)&&this.fieldElement.label||this.field.alias||this.field.name}},{key:"maxLength",get:function(){const e=-1;if(this.type===b.Date)return e;const{field:t,fieldElement:i}=this,r=t?.length,o=A(i)?i.input.maxLength:NaN;return!isNaN(o)&&o>=e&&(r===e||o<=r)?o:r}},{key:"minLength",get:function(){const e=-1;if(this.type===b.Date)return e;const{field:t,fieldElement:i}=this,r=t?.length,o=A(i)?i.input.minLength:NaN;return!isNaN(o)&&o>=e&&(r===e||o<=r)?o:e}},{key:"name",get:function(){return this.field?.name}},{key:"required",get:function(){const{editable:e,evaluatedRequiredExpression:t,field:i,visible:r}=this;return!!e&&(!1===i?.nullable||!(!r||!n.isSome(t))&&t)},set:function(e){this._overrideIfSome("required",e)}},{key:"submittable",get:function(){const{field:e,required:t,valid:i,value:r}=this;return(!t||!n.isNone(r))&&(!!i||this.initialFeature.getAttribute(e.name)===r)}},{key:"type",get:function(){const{field:e}=this;return h.isNumericField(e)?b.Number:h.isStringField(e)?b.Text:h.isDateField(e)?b.Date:b.Unsupported}},{key:"updating",get:function(){const{editableExpressionExecutor:e,valueExpressionExecutor:t}=this;return n.isSome(t)&&t.updating||n.isSome(e)&&e.updating}},{key:"valid",get:function(){const e=this.editable?this._validate():null;return this._set("error",e),null===e}},{key:"value",get:function(){if(this._shouldUseValueExpression()){const e=this.evaluatedValueExpression;if(this.type===b.Date){if(e instanceof Date)return e.getTime();if("number"!=typeof e)return parseInt(e,10)}return n.isSome(e)&&"object"==typeof e?e.toString():e}return this.get("_storedValue")},set:function(e){this.notifyChange("evaluatedVisibilityExpression"),this.set("_storedValue",e)}},{key:"visible",get:function(){return!this._isEditorField()&&(n.isSome(this.evaluatedVisibilityExpression)?this.evaluatedVisibilityExpression:!!n.isSome(this.fieldElement)||this._isVisibleByDefault())}}]),i}(o.HandleOwnerMixin(r));t.__decorate([s.property()],N.prototype,"_storedValue",void 0),t.__decorate([s.property()],N.prototype,"_configAllowsEdits",null),t.__decorate([s.property()],N.prototype,"_layerFieldAllowsEdits",null),t.__decorate([s.property()],N.prototype,"arcadeEditType",void 0),t.__decorate([s.property()],N.prototype,"editableExpressionExecutor",void 0),t.__decorate([s.property()],N.prototype,"requiredExpressionExecutor",void 0),t.__decorate([s.property()],N.prototype,"valueExpressionExecutor",void 0),t.__decorate([s.property()],N.prototype,"isUsingValueExpression",null),t.__decorate([s.property()],N.prototype,"visibilityExpressionExecutor",void 0),t.__decorate([s.property()],N.prototype,"evaluatedEditableExpression",null),t.__decorate([s.property()],N.prototype,"evaluatedRequiredExpression",null),t.__decorate([s.property()],N.prototype,"evaluatedVisibilityExpression",null),t.__decorate([s.property()],N.prototype,"evaluatedValueExpression",null),t.__decorate([s.property()],N.prototype,"feature",void 0),t.__decorate([s.property()],N.prototype,"field",void 0),t.__decorate([s.property({constructOnly:!0})],N.prototype,"fieldElement",void 0),t.__decorate([s.property()],N.prototype,"initialFeature",null),t.__decorate([s.property()],N.prototype,"layer",void 0),t.__decorate([s.property({readOnly:!0})],N.prototype,"description",null),t.__decorate([s.property()],N.prototype,"domain",null),t.__decorate([s.property()],N.prototype,"editable",null),t.__decorate([s.property({readOnly:!0})],N.prototype,"inputType",null),t.__decorate([s.property({readOnly:!0})],N.prototype,"error",void 0),t.__decorate([s.property({dependsOn:["error","messages","value"]})],N.prototype,"errorMessage",null),t.__decorate([s.property()],N.prototype,"group",void 0),t.__decorate([s.property({readOnly:!0})],N.prototype,"hint",null),t.__decorate([s.property()],N.prototype,"includeTime",null),t.__decorate([s.property()],N.prototype,"label",null),t.__decorate([s.property()],N.prototype,"maxLength",null),t.__decorate([s.property()],N.prototype,"minLength",null),t.__decorate([s.property()],N.prototype,"messages",void 0),t.__decorate([s.property({readOnly:!0})],N.prototype,"name",null),t.__decorate([s.property()],N.prototype,"required",null),t.__decorate([s.property()],N.prototype,"submittable",null),t.__decorate([s.property()],N.prototype,"type",null),t.__decorate([s.property()],N.prototype,"updating",null),t.__decorate([s.property()],N.prototype,"valid",null),t.__decorate([s.property({value:null})],N.prototype,"value",null),t.__decorate([s.property()],N.prototype,"visible",null),N=t.__decorate([p.subclass("esri.widgets.FeatureForm.InputField")],N);const O=(e,t)=>{if(!e)return!0;const{operations:i}=e;switch(t){case"INSERT":return i.supportsAdd;case"UPDATE":case"DELETE":return i.supportsUpdate;default:return!0}},A=e=>n.isSome(e)&&(v.isFieldElementWithInputType(e,"text-box")||v.isFieldElementWithInputType(e,"text-area"));return N}));
