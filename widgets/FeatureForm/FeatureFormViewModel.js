/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../Graphic","../../intl","../../core/Evented","../../core/HandleOwner","../../core/Logger","../../core/ReentrantObjectPool","../../core/watchUtils","../../core/accessorSupport/decorators/property","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/cast","../../core/accessorSupport/decorators/subclass","../../form/FormTemplate","../../support/arcadeOnDemand","./FieldConfig","./FieldGroupConfig","./InputField","./InputFieldGroup","./support/formTemplateUtils","../../intl/locale","../../intl/messages"],(function(e,t,i,r,n,o,l,s,a,u,d,p,c,f,h,y,_,g,m,v,F,C,b){"use strict";function O(e){return!!e.inputFields}function G(e){return!!e.fieldConfig}const E=new i({attributes:{}}),w="esri.widgets.FeatureForm.FeatureFormViewModel",k=l.getLogger(w);let T=function(t){function i(e){var i;return(i=t.call(this,e)||this)._arcade=null,i._fieldPool=new s.ReentrantObjectPool(m),i._fieldGroupPool=new s.ReentrantObjectPool(v),i._featureClone=E.clone(),i._initialFeature=E.clone(),i._needsArcade=!1,i.messages=null,i.strict=!1,i}e._inheritsLoose(i,t);var r=i.prototype;return r.initialize=function(){var t=this;const i=function(){var i=e._asyncToGenerator((function*(){return t.messages=yield b.fetchMessageBundle("esri/widgets/FeatureForm/t9n/FeatureForm")}));return function(){return i.apply(this,arguments)}}();i(),this.handles.add(C.onLocaleChange(i));const r=a.init(this,"fieldConfig",function(){var i=e._asyncToGenerator((function*(e){const i=[];e&&e.forEach((e=>{i.push(e.visibilityExpression),G(e)?e.fieldConfig.forEach((({requiredExpression:e,visibilityExpression:t})=>{i.push(e,t)})):i.push(e.requiredExpression)}));const n=i.filter((e=>!!e)),o=n.length>0;if(o){const e=yield y.loadArcade(),{arcadeUtils:i}=e;n.some((e=>i.hasGeometryOperations(e)))&&(yield i.enableGeometryOperations(),r.remove()),t._arcade=e,t.notifyChange("inputFields")}t._needsArcade=o}));return function(e){return i.apply(this,arguments)}}());this.handles.add(r)},r.destroy=function(){this.fieldConfig=null,this.feature=null,this.layer=null,this._fieldPool.destroy(),this._fieldGroupPool.destroy()},r.castFieldConfig=function(e){return e?e.map((e=>e instanceof _||e instanceof g?e:G(e)?new g(e):new _(e))):null},r.findField=function(e){return this._allInputFields.find((t=>t.name===e))},r.getValue=function(e){var t;const{_featureClone:i,layer:r}=this,n=!(null==r||!r.getField(e));return null!=(t=i.getAttribute(e))?t:n?null:void 0},r.setValue=function(e,t){const{_featureClone:i,strict:r}=this,n=this.findField(e);if(t=""===t?null:t,!n||i.getAttribute(e)===t)return;n.value=t;if(this.get("layer.typeIdField")===n.name&&"types"in this.layer){const e=new Set;this.layer.types.forEach((t=>Object.keys(t.domains).forEach((t=>e.add(t))))),e.forEach((e=>{const t=this.findField(e);t&&t.notifyChange("domain")}))}r&&!n.valid||(i.setAttribute(e,t),this.notifyChange("inputFields"),this._emitChangeEvent(n))},r.getValues=function(){return{...this._featureClone.attributes}},r.submit=function(){const e=this._allInputFields,t=e.filter((e=>e.valid)).map((({name:e})=>e)),i=e.filter((e=>!e.valid)).map((({name:e})=>e)),r=this.getValues();this.emit("submit",{valid:t,invalid:i,values:r})},r._disposeInputOrGroup=function(e){O(e)?this._disposeGroup(e):this._disposeInput(e)},r._disposeGroup=function(e){e.inputFields.forEach((e=>this._disposeInput(e))),this._fieldGroupPool.release(e)},r._disposeInput=function(e){this._fieldPool.release(e)},r._emitChangeEvent=function({name:e,valid:t,value:i}){this.emit("value-change",{layer:this.layer,feature:this.feature,fieldName:e,value:i,valid:t})},e._createClass(i,[{key:"_allInputFields",get:function(){return this.inputFields.reduce(((e,t)=>O(t)?[...e,...t.inputFields]:[...e,t]),[])}},{key:"_inputFieldCache",get:function(){const e=this._get("_inputFieldCache")||new Map;e.forEach((e=>this._disposeInputOrGroup(e))),e.clear();return(this.get("layer.fields")||[]).forEach((t=>e.set(t,this._fieldPool.acquire()))),e}},{key:"_inputFieldGroupCache",get:function(){const e=this._get("_inputFieldGroupCache")||new Map;e.forEach((e=>this._disposeInputOrGroup(e))),e.clear();return(this.fieldConfig||[]).filter(G).forEach((t=>e.set(t,this._fieldGroupPool.acquire()))),e}},{key:"description",get:function(){var e;return null==(e=this.formTemplate)?void 0:e.description},set:function(e){void 0===e?this._clearOverride("description"):this._override("description",e)}},{key:"feature",get:function(){return this._get("feature")},set:function(e){this._featureClone=e?e.clone():E.clone(),this._initialFeature=this._featureClone.clone(),this._set("feature",e)}},{key:"fieldConfig",get:function(){const{formTemplate:e}=this;if(!e)return null;const{config:t,encounteredUnsupportedTypes:i}=F.fieldConfigsFromFormTemplate(e);return i.length>0&&k.warn("form-info::unsupported-type","encountered unsupported elements/types when parsing form info",i),t},set:function(e){e?this._override("fieldConfig",e):this._clearOverride("fieldConfig")}},{key:"formTemplate",get:function(){return this.layer&&"formTemplate"in this.layer?this.layer.formTemplate:null},set:function(e){void 0===e?this._clearOverride("formTemplate"):this._override("formTemplate",e)}},{key:"inputFields",get:function(){const{_arcade:e,_inputFieldCache:t,_inputFieldGroupCache:i,_featureClone:r,messages:n,_needsArcade:o,layer:l,state:s}=this,a=r.clone();if("ready"!==s||o&&!e)return[];const u=this.get("layer.fields")||[],d=this.fieldConfig||[];let p;return p=0!==d.length?d.map((r=>{if(G(r)){const o=i.get(r),s=r.fieldConfig.map((i=>{const r=u.find((e=>e.name===i.name)),s=t.get(r);return s.set({arcade:e,field:r,config:i,feature:a,group:o,initialFeature:this._initialFeature,layer:l,messages:n,value:this.getValue(r.name)}),s})).filter((e=>e.visible));return o.set({arcade:e,config:r,feature:a,inputFields:s}),o}const o=u.find((e=>e.name===r.name)),s=t.get(o);return s.set({arcade:e,field:o,config:r,feature:a,group:null,initialFeature:this._initialFeature,layer:l,messages:n,value:this.getValue(o.name)}),s})):u.map((i=>{const r=t.get(i);return r.set({arcade:e,config:null,field:i,feature:a,group:null,initialFeature:this._initialFeature,layer:l,messages:n,value:this.getValue(i.name)}),r})),p.filter((e=>e.visible))}},{key:"layer",get:function(){var e;return null!=(e=this.feature)&&e.sourceLayer&&"applyEdits"in this.feature.sourceLayer?this.feature.sourceLayer:null},set:function(e){e?this._override("layer",e):this._clearOverride("layer")}},{key:"state",get:function(){return this.messages&&this.get("layer.loaded")?"ready":"disabled"}},{key:"title",get:function(){var e;return null==(e=this.formTemplate)?void 0:e.title},set:function(e){void 0===e?this._clearOverride("title"):this._override("title",e)}},{key:"valid",get:function(){const e=this._allInputFields;return e.length>0&&e.every((({valid:e})=>e))}}]),i}(o.HandleOwnerMixin(n.EventedAccessor));t.__decorate([u.property({readOnly:!0})],T.prototype,"_allInputFields",null),t.__decorate([u.property({readOnly:!0})],T.prototype,"_inputFieldCache",null),t.__decorate([u.property({readOnly:!0})],T.prototype,"_inputFieldGroupCache",null),t.__decorate([u.property()],T.prototype,"description",null),t.__decorate([u.property()],T.prototype,"feature",null),t.__decorate([u.property()],T.prototype,"fieldConfig",null),t.__decorate([c.cast("fieldConfig")],T.prototype,"castFieldConfig",null),t.__decorate([u.property({type:h})],T.prototype,"formTemplate",null),t.__decorate([u.property({readOnly:!0,dependsOn:["messages","feature","fieldConfig","layer.fields","layer.loaded","state"]})],T.prototype,"inputFields",null),t.__decorate([u.property()],T.prototype,"layer",null),t.__decorate([u.property()],T.prototype,"messages",void 0),t.__decorate([u.property()],T.prototype,"state",null),t.__decorate([u.property()],T.prototype,"strict",void 0),t.__decorate([u.property()],T.prototype,"title",null),t.__decorate([u.property()],T.prototype,"valid",null),t.__decorate([u.property()],T.prototype,"getValues",null),t.__decorate([u.property()],T.prototype,"submit",null),T=t.__decorate([f.subclass(w)],T);return T}));
