/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../Graphic","../../intl","../../core/Evented","../../core/HandleOwner","../../core/Logger","../../core/maybe","../../core/Promise","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/arrayUtils","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass","../../form/FormTemplate","../../layers/support/ContingentValue","../../layers/support/editableLayers","../../layers/support/LayerContingentValuesCache","./FormExpressionArcadeExecutor","./FormExpressionsManager","./InputField","./InputFieldGroup","../../intl/locale","../../intl/messages"],(function(e,t,n,s,i,o,r,a,l,u,c,p,d,f,h,y,g,_,m,F,v,C,E,x){"use strict";const I=new n({attributes:{}}),V=["editableExpression","requiredExpression","valueExpression","visibilityExpression"],b=["visibilityExpression"],w="#JSAPI_CONTINGENT_VALUE_EMPTY_HASH",A="#JSAPI_CONTINGENT_VALUE_ANY_HASH",M="#JSAPI_CONTINGENT_VALUE_NULL_HASH";let S=function(t){function n(e){var n;return(n=t.call(this,e)||this)._expressionExecutorLookup=new Map,n._expressionLookup=new Map,n._expressionsManager=null,n._contingentValuesCache=null,n._featureClone=I.clone(),n._initialFeature=I.clone(),n.arcadeEditType="NA",n.contingencyConstraintViolations=new Map,n.inputFields=[],n.messages=null,n.strict=!1,n}e._inheritsLoose(n,t);var s=n.prototype;return s.initialize=function(){var t=this;const n=function(){var n=e._asyncToGenerator((function*(){const e=yield x.fetchMessageBundle("esri/widgets/FeatureForm/t9n/FeatureForm");t.messages=e;for(const n of t.allInputFields)n.messages=e}));return function(){return n.apply(this,arguments)}}();n();const s=u.watch((()=>[this.layer,this.layer?.loaded,this.formTemplate]),(()=>{a.isSome(this.layer)&&this.layer.loaded&&this._updateInputFields()}),{equals:([e,t,n],[s,i,o])=>e===s&&t===i&&n===o,initial:!0}),i=u.watch((()=>this.layer),(e=>{"feature"===e?.type&&this.addResolvingPromise(_.createLoadedLayerContingentValuesCache(e).then((e=>{this._contingentValuesCache=e,this.notifyChange("fieldsWithContingentValues")})))}),{initial:!0});this.handles.add([E.onLocaleChange(n),s,i])},s.destroy=function(){this.feature=null,this.layer=null,this._contingentValuesCache=a.destroyMaybe(this._contingentValuesCache)},s.findField=function(e){return this.allInputFields.find((t=>t.name===e))},s.getValue=function(e){const{_featureClone:t,layer:n}=this,s=!!n?.getField(e);return t.getAttribute(e)??(s?null:void 0)},s.setValue=function(e,t){const{_featureClone:n,strict:s}=this,i=this.findField(e);t=""===t?null:t,i&&n.getAttribute(e)!==t&&(i.value=t,s&&!i.valid||(this._afterValueChange(i),a.isSome(this._expressionsManager)&&this.updatingHandles.addPromise(this._expressionsManager.evaluateInvalidated([i.name]).finally((()=>this._afterExpressionsEvaluated())))))},s.getValues=function(){return{...this._featureClone.attributes}},s.submit=function(){const e=this.allInputFields,t=new Set(e.filter((e=>e.valid)).map((({name:e})=>e))),n=e.filter((e=>!e.valid)).map((({name:e})=>e)),s=this.getValues();if(this.validateContingencyConstraints(s,{includeIncompleteViolations:!0}).length>0)for(const[i,o]of this.contingencyConstraintViolations.entries())"error"===o.type&&(t.delete(i),n.push(i));this.emit("submit",{valid:[...t],invalid:n,values:s})},s.validateContingencyConstraints=function(e,t){const{_contingentValuesCache:n}=this,s=new Map;if(this.contingencyConstraintViolations=s,a.isNone(n))return[];const{invalid:i,incomplete:o}=n.validateContingencyConstraints(e),r=[...i,...t?.includeIncompleteViolations?o:[]];for(const a of r)for(const e of a.fieldGroup.fields)s.set(e,a);return r},s.notifyFeatureGeometryChanged=function(){const{_expressionsManager:e,feature:t,_featureClone:n}=this;n.geometry=t.geometry,a.isSome(e)&&this.updatingHandles.addPromise(e.evaluateInvalidatedByGeometry().finally((()=>this._afterExpressionsEvaluated())))},s._emitChangeEvent=function({name:e,valid:t,value:n}){this.emit("value-change",{layer:this.layer,feature:this.feature,fieldName:e,value:n,valid:t})},s._updateInputFields=function(){const{_featureClone:e,_initialFeature:t,formTemplate:n,inputFields:s,messages:i,layer:o}=this,r={feature:e,initialFeature:t,layer:o,messages:i},l=s.slice(),u=a.isSome(n)&&n.elements.length>0?this._updateInputFieldsFromElements(l,n.elements,r):this._updateInputFieldsFromLayerFields(l,o?.fields,r);this.inputFields=u},s._updateInputFieldsFromElements=function(e,t,n){const s=new Map;for(const r of e)if(T(r)){j(s,r.groupElement,r);for(const e of r.inputFields)j(s,e.fieldElement,e)}else j(s,r.fieldElement,r);const i=new Map,o=this._updateInputFieldsRecursive({existingInputFieldsByElement:s,updatedElements:t.filter(this._isSupportedElement),sharedInitializationProperties:n,group:null,newExpressionExecutorPromises:i});this.updatingHandles.addPromise(Promise.all(Array.from(i.values())).then((()=>{const e=Array.from(this._expressionExecutorLookup.values()),t=N(o);return this._createExpressionsManager(e,t),a.unwrap(this._expressionsManager).evaluateAll().finally((()=>this._afterExpressionsEvaluated()))})));for(const[r,a]of s.entries())s.delete(r),a.destroy();return o},s._updateInputFieldsRecursive=function(e){const{existingInputFieldsByElement:t,updatedElements:n,sharedInitializationProperties:s,group:i,newExpressionExecutorPromises:o}=e,r=[];for(const a of n){const e=t.has(a),n=e?t.get(a):k(a)?this._makeInputFieldGroupFromGroupElement(a,s):this._makeInputFieldFromFieldElement(a,s,i);if(r.push(n),e)if(t.delete(a),T(n)){const{feature:e}=s;n.set({feature:e})}else n.set(s);else this._assignExpressionExecutors(n,a,o);if(k(a)){const e=a.elements.filter((e=>this._isSupportedElement(e)));n.inputFields=this._updateInputFieldsRecursive({existingInputFieldsByElement:t,updatedElements:e,sharedInitializationProperties:s,group:n,newExpressionExecutorPromises:o})}}return r},s._updateInputFieldsFromLayerFields=function(e,t,n){if(!Array.isArray(t))return r.getLogger(this.declaredClass).warn(this.declaredClass,"No attribute fields found."),[];const s=new Map;for(const r of e)if(T(r)){for(const e of r.inputFields)e.destroy();r.inputFields.length=0,r.destroy()}else a.isSome(r.fieldElement)?r.destroy():s.set(r.field,r);const i=[],{feature:o,initialFeature:l,layer:u,messages:c}=n;for(const r of t){const e=s.get(r)??new v({field:r,feature:o,initialFeature:l,layer:u,messages:c,value:o.getAttribute(r.name)??null});i.push(e),s.delete(r)}for(const[r,a]of s.entries())s.delete(r),a.destroy();return i},s._resetInputFieldValues=function(e){for(const t of this.allInputFields)t.value=e.getAttribute(t.name)},s._makeInputFieldFromFieldElement=function(e,t,n=null){const{feature:s,initialFeature:i,layer:o,messages:r}=t;return new v({fieldElement:e,field:this._layerFieldsByName.get(e.fieldName),value:s.getAttribute(e.fieldName)??null,feature:s,initialFeature:i,layer:o,group:n,messages:r})},s._makeInputFieldGroupFromGroupElement=function(e,t){const{feature:n,initialFeature:s}=t;return new C({groupElement:e,inputFields:[],feature:n,initialFeature:s})},s._assignExpressionExecutors=function(e,t,n){const s=k(t)?b:V,i=[];for(const o of s){const s=t[o],{_expressionExecutorLookup:i}=this;if(a.isSome(s)&&""!==s){const t=`${o}Executor`,r=this._expressionLookup.get(s)??this._addToExpressionLookup(s);if(i.has(r))e[t]=i.get(r);else if(n.has(r)){const s=n.get(r).then((n=>(e[t]=n,n)));n.set(r,s)}else{const s=m.createFormExpressionArcadeExecutor(r,this.layer).then((n=>(e[t]=n,i.set(r,n),n)));n.set(r,s)}}}return i},s._createExpressionsManager=function(e,t){const{_arcadeContextInfo:n,_featureClone:s}=this;this._expressionsManager=new F.FormExpressionsManager({executors:e,feature:s,arcadeContextInfo:n,inputFields:t})},s._afterValueChange=function(e){const{name:t,value:n}=e;if(this.get("layer.typeIdField")===t&&"types"in this.layer){const e=new Set;this.layer.types.forEach((t=>Object.keys(t.domains).forEach((t=>e.add(t))))),e.forEach((e=>{const t=this.findField(e);t&&t.notifyChange("domain")}))}this._featureClone.setAttribute(t,n),this._emitChangeEvent(e)},s._afterExpressionsEvaluated=function(){const{_featureClone:e}=this;for(const t of this.allInputFields)t.value!==e.getAttribute(t.name)&&this._afterValueChange(t)},s._addToExpressionLookup=function(e){const{_expressionLookup:t,formTemplate:n}=this,s=(a.isSome(n)&&a.isSome(n.expressionInfos)?Object.values(n.expressionInfos).find((t=>t.name===e)):null)?.expression??e;return t.set(e,s),e!==s&&t.set(s,s),s},s._isSupportedElement=function(e){return"field"===e.type||"group"===e.type||(r.getLogger(this.declaredClass).warn("form-info::unsupported-element-type","Only element types 'field' and 'group' are supported",`Element ${e.label} has unsupported type '${e.type}'`),!1)},s._joinContingentValues=function(){const e=this._contingentValuesCache;if(a.isNone(e))return[];const t="typeIdField"in this.layer?this.layer.typeIdField:null,n=t?this.getValue(t):null,s=[];for(const r of e.fieldGroups){const{contingencies:e,fields:t,name:i}=r,o=[];for(const s of e)s.isRetired||a.isSome(s.subtype)&&s.subtype.code!==n||o.push({values:s.values});o.length>0&&s.push({name:i,fields:t,contingencies:o})}const[i,o]=this._generateJoinPlan(s);return[...i.flatMap((e=>this._joinFieldGroupContingencies(e))),...o.flatMap((e=>e.contingencies))]},s._generateJoinPlan=function(e){const t=new Map,n=[],s=new Set;for(const l of e)for(const e of l.fields)if(t.has(e)){const i=t.get(e),o=l,r=[i.name,o.name].sort().join("|");if(s.has(r))continue;n.push([i,o]),s.add(r),t.set(e,o)}else t.set(e,l);const i=new Set(n.flat()),o=new Set(e);for(const l of i)o.delete(l);const r=new Map,a=new Map;for(const l of new Set(n.flat())){const e=Symbol(l.name);r.set(e,new Set([l])),a.set(l,e)}for(const[l,u]of n){const e=a.get(l),t=a.get(u);if(e===t)continue;const n=r.get(e),s=r.get(t);for(const i of s)n.add(i),a.set(i,e);r.delete(t)}return[[...r.values()].map((e=>[...e])),[...o]]},s._joinFieldGroupContingencies=function(e){const t=e.slice(),n=t.shift();let s=t.shift(),i=this._generateJoinKey(n.fields,s.fields),o=new Set([...n.fields,...s.fields]),r=new Map;for(const a of n.contingencies){const[e]=this._hashContingency(a,i.codedValueFields,!0);r.has(e)?r.get(e).push(a):r.set(e,[a])}for(;t.length>0;){const e=new Map,n=t.shift(),l=this._generateJoinKey(o,n.fields);for(const t of s.contingencies){const[n,s]=this._hashContingency(t,i.codedValueFields),o=s?this._findMatchingContingenciesWithAnyHashMask(r,n):r.get(n);if(r.has(A)&&o.push(...this._findMatchingContingenciesContainingAny(t,r.get(A),i.codedValueFields)),!a.isNone(o))for(const r of o){const n=i.rangeFields.length>0?this._joinContingenciesWithRangeDomains(r,t,i.rangeFields):this._joinContingencies(r,t);if(a.isNone(n))break;const[s]=this._hashContingency(n,l.codedValueFields,!0);e.has(s)?e.get(s).push(n):e.set(s,[n])}}r=e,s=n,i=l,o=new Set([...o,...s.fields])}const l=[];for(const u of s.contingencies){const[e,t]=this._hashContingency(u,i.codedValueFields),n=t?this._findMatchingContingenciesWithAnyHashMask(r,e):r.get(e);if(r.has(A)&&n.push(...this._findMatchingContingenciesContainingAny(u,r.get(A),i.codedValueFields)),!a.isNone(n))for(const s of n){const e=i.rangeFields.length>0?this._joinContingenciesWithRangeDomains(s,u,i.rangeFields):this._joinContingencies(s,u);a.isSome(e)&&l.push(e)}}return l},s._joinContingencies=function(e,t){const n={values:{...e.values,...t.values}};for(const[s,i]of Object.entries(n.values))"any"===i.objectType&&a.isSome(e.values[s])&&(n.values[s]=e.values[s]);return n},s._joinContingenciesWithRangeDomains=function(e,t,n){const s=this._joinContingencies(e,t);for(const i of n){const n=e.values[i],o=t.values[i],{leftIsNull:r,rightIsNull:a,bothAreNull:l,leftIsAny:u,rightIsAny:c,bothAreAny:p,leftIsRange:d,rightIsRange:f}=this._compareObjectTypes(n.objectType,o.objectType);if(l||p)continue;if(r&&c||a&&u){s.values[i]=new y({objectType:"null"});continue}if(r&&f||a&&d)return null;u?(n.minValue=-1/0,n.maxValue=1/0):c&&(o.minValue=-1/0,o.maxValue=1/0);const h=Math.max(n.minValue,o.minValue),g=Math.min(n.maxValue,o.maxValue);if(h>g)return null;s.values[i]=new y({objectType:"range",minValue:h,maxValue:g})}return s},s._findMatchingContingenciesContainingAny=function(e,t,n){return t.filter((t=>n.every((n=>{const s=t.values[n],i=e.values[n];return"any"===s.objectType||"any"===i.objectType||s.codedValue?.code===i.codedValue?.code}))))},s._findMatchingContingenciesWithAnyHashMask=function(e,t){const n=RegExp(`${t}$`),s=[];for(const[i,o]of e){if(i===A)break;n.test(i)&&s.push(...o)}return s},s._generateJoinKey=function(e,t){const n=Array.isArray(e)?new Set(e):e,s=Array.isArray(t)?new Set(t):t,i=n.size<s.size?n:s,o=i===n?s:n,r=new Set,l=new Set;for(const u of i)if(o.has(u)){const e=this.layer.getFieldDomain(u,{feature:this.feature});if(a.isNone(e))continue;switch(e.type){case"coded-value":r.add(u);break;case"range":l.add(u)}}return{codedValueFields:[...r],rangeFields:[...l]}},s._hashContingency=function(e,t,n=!1){if(t.length<1)return[w,!1];const s=[];let i=!1;for(const o of t){const t=e.values[o];if("any"===t.objectType){if(n)return[A,!0];i=!0,s.push(`${o}:.*`)}else"null"===t.objectType?s.push(`${o}:${M}`):s.push(`${o}:${t.codedValue?.code}`)}return[s.sort().join("&"),i]},s._compareObjectTypes=function(e,t){return{leftIsNull:"null"===e,rightIsNull:"null"===t,bothAreNull:"null"===e&&"null"===t,leftIsAny:"any"===e,rightIsAny:"any"===t,bothAreAny:"any"===e&&"any"===t,leftIsRange:"range"===e,rightIsRange:"range"===t}},e._createClass(n,[{key:"_arcadeContextInfo",get:function(){const{_initialFeature:e,arcadeEditType:t,layer:n,spatialReference:s,view:i}=this;return{layer:g.isEditableLayer(n)?n:null,originalFeature:e,editType:t,spatialReference:s,map:i?.map}}},{key:"updating",get:function(){return this.updatingHandles.updating}},{key:"allInputFields",get:function(){return N(this.inputFields)}},{key:"_layerFieldsByName",get:function(){return new Map(this.layer.fields.map((e=>[e.name,e])))}},{key:"feature",get:function(){return this._get("feature")},set:function(e){this._featureClone=e?e.clone():I.clone(),this._initialFeature=this._featureClone.clone(),this._resetInputFieldValues(this._featureClone),this.contingencyConstraintViolations.clear(),a.isSome(this._expressionsManager)&&(this._expressionsManager.resetExecutors(),this._expressionsManager.feature=this._featureClone,this.updatingHandles.addPromise(this._expressionsManager.evaluateAll().finally((()=>this._afterExpressionsEvaluated())))),this._set("feature",e)}},{key:"fieldsWithContingentValues",get:function(){if(a.isNone(this._contingentValuesCache))return new Set;const e=this._contingentValuesCache.fieldGroups.flatMap((e=>e.fields));return new Set(e)}},{key:"formTemplate",get:function(){return this.layer&&"formTemplate"in this.layer?this.layer.formTemplate:null},set:function(e){this._override("formTemplate",e)}},{key:"joinedContingentValues",get:function(){return this._joinContingentValues()}},{key:"layer",get:function(){return this.feature?.sourceLayer&&"applyEdits"in this.feature.sourceLayer?this.feature.sourceLayer:null},set:function(e){this._override("layer",e)}},{key:"spatialReference",get:function(){return this.layer?.spatialReference??null},set:function(e){this._override("spatialReference",e)}},{key:"state",get:function(){return this.messages&&this.get("layer.loaded")?"ready":"disabled"}},{key:"submittable",get:function(){return!!this.valid||this.allInputFields.filter((e=>!e.valid)).every((({submittable:e})=>e))}},{key:"valid",get:function(){const e=this.allInputFields;return e.length>0&&e.every((({valid:e})=>e))}}]),n}(o.HandleOwnerMixin(l.EsriPromiseMixin(i.EventedAccessor)));t.__decorate([c.property()],S.prototype,"_arcadeContextInfo",null),t.__decorate([c.property()],S.prototype,"updating",null),t.__decorate([c.property({readOnly:!0})],S.prototype,"allInputFields",null),t.__decorate([c.property()],S.prototype,"_layerFieldsByName",null),t.__decorate([c.property()],S.prototype,"arcadeEditType",void 0),t.__decorate([c.property()],S.prototype,"contingencyConstraintViolations",void 0),t.__decorate([c.property()],S.prototype,"feature",null),t.__decorate([c.property()],S.prototype,"fieldsWithContingentValues",null),t.__decorate([c.property({type:h})],S.prototype,"formTemplate",null),t.__decorate([c.property()],S.prototype,"inputFields",void 0),t.__decorate([c.property()],S.prototype,"joinedContingentValues",null),t.__decorate([c.property()],S.prototype,"layer",null),t.__decorate([c.property()],S.prototype,"messages",void 0),t.__decorate([c.property()],S.prototype,"spatialReference",null),t.__decorate([c.property()],S.prototype,"state",null),t.__decorate([c.property()],S.prototype,"strict",void 0),t.__decorate([c.property()],S.prototype,"submittable",null),t.__decorate([c.property()],S.prototype,"valid",null),t.__decorate([c.property()],S.prototype,"view",void 0),t.__decorate([c.property()],S.prototype,"getValues",null),t.__decorate([c.property()],S.prototype,"submit",null),S=t.__decorate([f.subclass("esri.widgets.FeatureForm.FeatureFormViewModel")],S);const T=e=>!!e.inputFields,k=e=>"group"===e.type,N=e=>e.reduce(((e,t)=>T(t)?[...e,...t.inputFields]:[...e,t]),[]),j=(e,t,n)=>{a.isSome(t)&&e.set(t,n)};return S}));
