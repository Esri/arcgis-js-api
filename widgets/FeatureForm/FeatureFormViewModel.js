/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/has","../../core/Logger","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/cast","../../core/accessorSupport/decorators/subclass","../../core/urlUtils","../../core/uuid","../../portal/support/resourceExtension","../../core/ReentrantObjectPool","../../core/Evented","../../support/arcadeOnDemand","../../intl/locale","../../intl/messages","../../intl","../../Graphic","../../core/watchUtils","../../form/FormTemplate","../../core/HandleOwner","./FieldConfig","./FieldGroupConfig","./InputField","./InputFieldGroup","./support/formTemplateUtils"],(function(e,t,r,i,n,o,s,l,a,u,d,p,c,f,h,y,_,g,m,v,F,C,O,b,w){"use strict";function E(e){return!!e.inputFields}function G(e){return!!e.fieldConfig}const T=new _({attributes:{}}),k="esri.widgets.FeatureForm.FeatureFormViewModel",I=i.getLogger(k);let P=function(t){function r(e){var r;return(r=t.call(this,e)||this)._arcade=null,r._fieldPool=new d.ReentrantObjectPool(O),r._fieldGroupPool=new d.ReentrantObjectPool(b),r._featureClone=T.clone(),r._needsArcade=!1,r.messages=null,r.strict=!1,r}e._inheritsLoose(r,t);var i=r.prototype;return i.initialize=function(){const e=async()=>this.messages=await h.fetchMessageBundle("esri/widgets/FeatureForm/t9n/FeatureForm");e(),this.handles.add(f.onLocaleChange(e));const t=g.init(this,"fieldConfig",(async e=>{const r=[];e&&e.forEach((e=>{r.push(e.visibilityExpression),G(e)?e.fieldConfig.forEach((({requiredExpression:e,visibilityExpression:t})=>{r.push(e,t)})):r.push(e.requiredExpression)}));const i=r.filter((e=>!!e)),n=i.length>0;if(n){const e=await c.loadArcade(),{arcadeUtils:r}=e;i.some((e=>r.hasGeometryOperations(e)))&&(await r.enableGeometryOperations(),t.remove()),this._arcade=e,this.notifyChange("inputFields")}this._needsArcade=n}));this.handles.add(t)},i.destroy=function(){this.fieldConfig=null,this.feature=null,this.layer=null,this._fieldPool.destroy(),this._fieldGroupPool.destroy()},i.castFieldConfig=function(e){return e?e.map((e=>e instanceof F||e instanceof C?e:G(e)?new C(e):new F(e))):null},i.findField=function(e){return this._allInputFields.find((t=>t.name===e))},i.getValue=function(e){const{_featureClone:t}=this;return t.attributes?t.get(`attributes.${e}`):void 0},i.setValue=function(e,t){const{_featureClone:r,strict:i}=this;if(!r.attributes)return;const n=this.findField(e);if(t=""===t?null:t,!n||r.attributes[e]===t)return;n.value=t;if(this.get("layer.typeIdField")===n.name){const e=new Set;this.layer.types.forEach((t=>Object.keys(t.domains).forEach((t=>e.add(t))))),e.forEach((e=>{const t=this.findField(e);t&&t.notifyChange("domain")}))}i&&!n.valid||(r.attributes[e]=t,this.notifyChange("inputFields"),this._emitChangeEvent(n))},i.getValues=function(){return{...this._featureClone.attributes}},i.submit=function(){const e=this._allInputFields,t=e.filter((e=>e.valid)).map((({name:e})=>e)),r=e.filter((e=>!e.valid)).map((({name:e})=>e)),i=this.getValues();this.emit("submit",{valid:t,invalid:r,values:i})},i._disposeInputOrGroup=function(e){E(e)?this._disposeGroup(e):this._disposeInput(e)},i._disposeGroup=function(e){e.inputFields.forEach((e=>this._disposeInput(e))),this._fieldGroupPool.release(e)},i._disposeInput=function(e){this._fieldPool.release(e)},i._emitChangeEvent=function({name:e,valid:t,value:r}){this.emit("value-change",{layer:this.layer,feature:this.feature,fieldName:e,value:r,valid:t})},e._createClass(r,[{key:"_allInputFields",get:function(){return this.inputFields.reduce(((e,t)=>E(t)?[...e,...t.inputFields]:[...e,t]),[])}},{key:"_inputFieldCache",get:function(){const e=this._get("_inputFieldCache")||new Map;e.forEach((e=>this._disposeInputOrGroup(e))),e.clear();return(this.get("layer.fields")||[]).forEach((t=>e.set(t,this._fieldPool.acquire()))),e}},{key:"_inputFieldGroupCache",get:function(){const e=this._get("_inputFieldGroupCache")||new Map;e.forEach((e=>this._disposeInputOrGroup(e))),e.clear();return(this.fieldConfig||[]).filter(G).forEach((t=>e.set(t,this._fieldGroupPool.acquire()))),e}},{key:"description",get:function(){var e;return null==(e=this.formTemplate)?void 0:e.description},set:function(e){void 0===e?this._clearOverride("description"):this._override("description",e)}},{key:"feature",get:function(){return this._get("feature")},set:function(e){this._featureClone=e?e.clone():T.clone(),this._set("feature",e)}},{key:"fieldConfig",get:function(){const{formTemplate:e}=this;if(!e)return null;const{config:t,encounteredUnsupportedTypes:r}=w.fieldConfigsFromFormTemplate(e);return r.length>0&&I.warn("form-info::unsupported-type","encountered unsupported elements/types when parsing form info",r),t},set:function(e){e?this._override("fieldConfig",e):this._clearOverride("fieldConfig")}},{key:"formTemplate",get:function(){var e;return null==(e=this.layer)?void 0:e.formTemplate},set:function(e){void 0===e?this._clearOverride("formTemplate"):this._override("formTemplate",e)}},{key:"inputFields",get:function(){const{_arcade:e,_inputFieldCache:t,_inputFieldGroupCache:r,_featureClone:i,messages:n,_needsArcade:o,layer:s,state:l}=this,a=i.clone();if("ready"!==l||o&&!e)return[];const u=this.get("layer.fields")||[],d=this.fieldConfig||[];let p;return p=0!==d.length?d.map((i=>{if(G(i)){const o=r.get(i),l=i.fieldConfig.map((r=>{const i=u.find((e=>e.name===r.name)),l=t.get(i);return l.set({arcade:e,field:i,config:r,feature:a,group:o,layer:s,messages:n,value:this.getValue(i.name)}),l})).filter((e=>e.visible));return o.set({arcade:e,config:i,feature:a,inputFields:l}),o}const o=u.find((e=>e.name===i.name)),l=t.get(o);return l.set({arcade:e,field:o,config:i,feature:a,group:null,layer:s,messages:n,value:this.getValue(o.name)}),l})):u.map((r=>{const i=t.get(r);return i.set({arcade:e,config:null,field:r,feature:a,group:null,layer:s,messages:n,value:this.getValue(r.name)}),i})),p.filter((e=>e.visible))}},{key:"layer",get:function(){return this.get("feature.layer")},set:function(e){e?this._override("layer",e):this._clearOverride("layer")}},{key:"state",get:function(){return this.messages&&this.get("layer.loaded")?"ready":"disabled"}},{key:"title",get:function(){var e;return null==(e=this.formTemplate)?void 0:e.title},set:function(e){void 0===e?this._clearOverride("title"):this._override("title",e)}},{key:"valid",get:function(){const e=this._allInputFields;return e.length>0&&e.every((({valid:e})=>e))}}]),r}(v.HandleOwnerMixin(p.EventedAccessor));return t.__decorate([n.property({readOnly:!0,dependsOn:["inputFields"]})],P.prototype,"_allInputFields",null),t.__decorate([n.property({dependsOn:["layer.fields"],readOnly:!0})],P.prototype,"_inputFieldCache",null),t.__decorate([n.property({dependsOn:["fieldConfig"],readOnly:!0})],P.prototype,"_inputFieldGroupCache",null),t.__decorate([n.property({dependsOn:["formTemplate"]})],P.prototype,"description",null),t.__decorate([n.property()],P.prototype,"feature",null),t.__decorate([n.property({dependsOn:["formTemplate"]})],P.prototype,"fieldConfig",null),t.__decorate([o.cast("fieldConfig")],P.prototype,"castFieldConfig",null),t.__decorate([n.property({dependsOn:["layer?.formTemplate"],type:m})],P.prototype,"formTemplate",null),t.__decorate([n.property({readOnly:!0,dependsOn:["messages","feature","fieldConfig","layer.fields","layer.loaded","state"],autoTracked:!1})],P.prototype,"inputFields",null),t.__decorate([n.property({dependsOn:["feature.layer"]})],P.prototype,"layer",null),t.__decorate([n.property()],P.prototype,"messages",void 0),t.__decorate([n.property({dependsOn:["messages","layer.loaded"]})],P.prototype,"state",null),t.__decorate([n.property()],P.prototype,"strict",void 0),t.__decorate([n.property({dependsOn:["formTemplate"]})],P.prototype,"title",null),t.__decorate([n.property({dependsOn:["_allInputFields"]})],P.prototype,"valid",null),t.__decorate([n.property()],P.prototype,"getValues",null),t.__decorate([n.property()],P.prototype,"submit",null),P=t.__decorate([s.subclass(k)],P),P}));
