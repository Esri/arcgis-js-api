// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","../../core/tsSupport/generatorHelper","../../core/tsSupport/awaiterHelper","../../core/arrayUtils","../../core/Evented","../../core/HandleOwner","../../core/lang","../../core/ReentrantObjectPool","../../core/watchUtils","../../core/accessorSupport/decorators","../../core/accessorSupport/decorators/cast","../../support/arcadeOnDemand","./FieldConfig","./FieldGroupConfig","./InputField","./InputFieldGroup"],(function(e,t,r,n,i,o,a,l,u,p,s,f,d,c,y,h,g,v,_){function b(e){return!!e.inputFields}function m(e){return!!e.fieldConfig}return function(e){function t(t){var r=e.call(this,t)||this;return r._arcade=null,r._fieldPool=new s.ReentrantObjectPool(v),r._fieldGroupPool=new s.ReentrantObjectPool(_),r._featureClone=null,r._needsArcade=!1,r.fieldConfig=null,r.strict=!1,r}return r(t,e),t.prototype.initialize=function(){var e=this,t=f.init(this,"fieldConfig",(function(r){return o(e,void 0,void 0,(function(){var e,n,o,a;return i(this,(function(i){switch(i.label){case 0:return e=[],r&&r.forEach((function(t){t.visibilityExpression&&e.push(t.visibilityExpression),m(t)&&t.fieldConfig.forEach((function(t){var r=t.visibilityExpression;r&&e.push(r)}))})),(n=e.length>0)?[4,y.loadArcade()]:[3,4];case 1:return o=i.sent(),a=o.arcadeUtils,e.some((function(e){return a.hasGeometryOperations(e)}))?[4,a.enableGeometryOperations()]:[3,3];case 2:i.sent(),t.remove(),i.label=3;case 3:this._arcade=o,this.notifyChange("inputFields"),i.label=4;case 4:return this._needsArcade=n,[2]}}))}))}));this.handles.add(t)},t.prototype.destroy=function(){this.fieldConfig=null,this.feature=null,this.layer=null,this._fieldPool.destroy(),this._fieldGroupPool.destroy()},Object.defineProperty(t.prototype,"_allInputFields",{get:function(){return this.inputFields.reduce((function(e,t){return b(t)?e.concat(t.inputFields):e.concat([t])}),[])},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"_inputFieldCache",{get:function(){var e=this,t=this._get("_inputFieldCache")||new Map;return t.forEach((function(t){return e._disposeInputOrGroup(t)})),t.clear(),(this.get("layer.fields")||[]).forEach((function(r){return t.set(r,e._fieldPool.acquire())})),t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"_inputFieldGroupCache",{get:function(){var e=this,t=this._get("_inputFieldGroupCache")||new Map;return t.forEach((function(t){return e._disposeInputOrGroup(t)})),t.clear(),(this.fieldConfig||[]).filter(m).forEach((function(r){return t.set(r,e._fieldGroupPool.acquire())})),t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"feature",{get:function(){return this._get("feature")},set:function(e){this._featureClone=e?e.clone():null,this._set("feature",e)},enumerable:!0,configurable:!0}),t.prototype.castFieldConfig=function(e){return e?e.map((function(e){return e instanceof h||e instanceof g?e:m(e)?new g(e):new h(e)})):null},Object.defineProperty(t.prototype,"inputFields",{get:function(){var e=this,t=this,r=t._arcade,n=t._inputFieldCache,i=t._inputFieldGroupCache,o=t._featureClone,l=t._needsArcade,u=t.layer,p=t.state,s=o&&o.clone();if("ready"!==p||l&&!r)return[];var f=this.get("layer.fields")||[],d=this.fieldConfig||[];return(0!==d.length?d.map((function(t){if(m(t)){var o=i.get(t),l=t.fieldConfig.map((function(t){var i=a.find(f,(function(e){return e.name===t.name})),l=n.get(i);return l.set({arcade:r,field:i,config:t,feature:s,group:o,layer:u,value:e.getValue(i.name)}),l})).filter((function(e){return e.visible}));return o.set({arcade:r,config:t,feature:s,inputFields:l}),o}var p=a.find(f,(function(e){return e.name===t.name})),d=n.get(p);return d.set({arcade:r,field:p,config:t,feature:s,group:null,layer:u,value:e.getValue(p.name)}),d})):f.map((function(t){var i=n.get(t);return i.set({arcade:r,config:null,field:t,feature:s,group:null,layer:u,value:e.getValue(t.name)}),i}))).filter((function(e){return e.visible}))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"layer",{get:function(){return this.get("feature.layer")},set:function(e){e?this._override("layer",e):this._clearOverride("layer")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"state",{get:function(){return this.get("layer.loaded")&&this.feature?"ready":"disabled"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"valid",{get:function(){var e=this._allInputFields;return e.length>0&&e.every((function(e){return e.valid}))},enumerable:!0,configurable:!0}),t.prototype.findField=function(e){return a.find(this._allInputFields,(function(t){return t.name===e}))},t.prototype.getValue=function(e){var t=this._featureClone;return t&&t.get("attributes."+e)},t.prototype.setValue=function(e,t){var r=this,n=this._featureClone,i=this.strict;if(n&&n.attributes){var o=this.findField(e);if(o&&n.attributes[e]!==t){if(o.value=t,this.get("layer.typeIdField")===o.name){var a=new Set;this.layer.types.forEach((function(e){return Object.keys(e.domains).forEach((function(e){return a.add(e)}))})),a.forEach((function(e){var t=r.findField(e);t&&t.notifyChange("domain")}))}i&&!o.valid||(n.attributes[e]=t,this.notifyChange("inputFields"),this._emitChangeEvent(o))}}},t.prototype.getValues=function(){var e=this._featureClone;return e&&p.clone(e.attributes)||null},t.prototype.submit=function(){var e=this._allInputFields,t=e.filter((function(e){return e.valid})).map((function(e){return e.name})),r=e.filter((function(e){return!e.valid})).map((function(e){return e.name})),n=this.getValues();this.emit("submit",{valid:t,invalid:r,values:n})},t.prototype._disposeInputOrGroup=function(e){b(e)?this._disposeGroup(e):this._disposeInput(e)},t.prototype._disposeGroup=function(e){var t=this;e.inputFields.forEach((function(e){return t._disposeInput(e)})),this._fieldGroupPool.release(e)},t.prototype._disposeInput=function(e){this._fieldPool.release(e)},t.prototype._emitChangeEvent=function(e){var t=e.name,r=e.valid,n=e.value;this.emit("value-change",{layer:this.layer,feature:this.feature,fieldName:t,value:n,valid:r})},n([d.property({readOnly:!0,dependsOn:["inputFields"]})],t.prototype,"_allInputFields",null),n([d.property({dependsOn:["layer.fields"],readOnly:!0})],t.prototype,"_inputFieldCache",null),n([d.property({dependsOn:["fieldConfig"],readOnly:!0})],t.prototype,"_inputFieldGroupCache",null),n([d.property()],t.prototype,"feature",null),n([d.property()],t.prototype,"fieldConfig",void 0),n([c.cast("fieldConfig")],t.prototype,"castFieldConfig",null),n([d.property({readOnly:!0,dependsOn:["feature","fieldConfig","layer.fields","layer.loaded"]})],t.prototype,"inputFields",null),n([d.property({dependsOn:["feature.layer"]})],t.prototype,"layer",null),n([d.property({dependsOn:["layer.loaded","feature"]})],t.prototype,"state",null),n([d.property()],t.prototype,"strict",void 0),n([d.property({dependsOn:["_allInputFields"]})],t.prototype,"valid",null),n([d.property()],t.prototype,"getValues",null),n([d.property()],t.prototype,"submit",null),t=n([d.subclass("esri.widgets.FeatureForm.FeatureFormViewModel")],t)}(d.declared(u.HandleOwnerMixin(l.EventedAccessor)))}));