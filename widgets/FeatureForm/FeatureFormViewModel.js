/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../Graphic","../../intl","../../core/Evented","../../core/HandleOwner","../../core/Logger","../../core/maybe","../../core/Promise","../../core/reactiveUtils","../../core/ReentrantObjectPool","../../core/accessorSupport/decorators/property","../../core/arrayUtils","../../core/has","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass","../../form/FormTemplate","../../layers/support/ContingentValue","../../layers/support/LayerContingentValuesCache","../../support/arcadeOnDemand","./InputField","./InputFieldGroup","../../intl/locale","../../intl/messages"],(function(e,t,n,i,o,s,r,l,a,u,c,d,p,f,h,y,_,g,m,v,F,C,b,E){"use strict";function I(e){return!!e.inputFields}const V=new n({attributes:{}}),A="esri.widgets.FeatureForm.FeatureFormViewModel",x=r.getLogger(A),w="#JSAPI_CONTINGENT_VALUE_EMPTY_HASH",S="#JSAPI_CONTINGENT_VALUE_ANY_HASH",k="#JSAPI_CONTINGENT_VALUE_NULL_HASH";let T=function(t){function n(e){var n;return(n=t.call(this,e)||this)._arcade=null,n._compiledExpressionLookup=new Map,n._expressionLookup=new Map,n._contingentValuesCache=null,n._fieldPool=new c.ReentrantObjectPool(F,(e=>n.handles.add(u.watch((()=>e.value),(()=>{e.isUsingValueExpression&&n._afterValueChange(e)})),e.id)),(({id:e})=>n.handles.remove(e))),n._fieldGroupPool=new c.ReentrantObjectPool(C),n._featureClone=V.clone(),n._initialFeature=V.clone(),n._needsArcade=!1,n._inputFieldCache=new Map,n._inputFieldGroupCache=new Map,n.contingencyConstraintViolations=new Map,n.messages=null,n.strict=!1,n}e._inheritsLoose(n,t);var i=n.prototype;return i.initialize=function(){var t=this;const n=function(){var n=e._asyncToGenerator((function*(){return t.messages=yield E.fetchMessageBundle("esri/widgets/FeatureForm/t9n/FeatureForm")}));return function(){return n.apply(this,arguments)}}();n();const i=u.watch((()=>this.layer),(e=>{"feature"===(null==e?void 0:e.type)&&this.addResolvingPromise(m.createLoadedLayerContingentValuesCache(e).then((e=>{this._contingentValuesCache=e,this.notifyChange("fieldsWithContingentValues")})))}),{initial:!0}),o=u.watch((()=>{var e,t;const{formTemplate:n}=this;if(l.isNone(n))return null;const i=null!=(e=n.expressionInfos)?e:[],o=null!=(t=n.elements)?t:[];return[...i.map((e=>e.expression)),...null==o?void 0:o.map((e=>this._getExpressionsFromElementRecursive(e))).flat()]}),function(){var n=e._asyncToGenerator((function*(e){if(!e||e.length<1)return t._compiledExpressionLookup.clear(),void t._expressionLookup.clear();const{_compiledExpressionLookup:n,_expressionLookup:i,formTemplate:s}=t,r=new Set(e);if(i.clear(),l.isSome(s)&&l.isSome(s.expressionInfos))for(const t of s.expressionInfos)r.delete(t.name),i.set(t.name,t.expression);for(const t of n.keys())r.delete(t),i.set(t,t);if(r.size<1)return;t._needsArcade=!0;const a=yield v.loadArcade();t._arcade=a;const{arcadeUtils:u}=a;for(const l of r.values())u.hasGeometryOperations(l)&&(yield u.enableGeometryOperations(),o.remove()),i.set(l,l),t._setFunctionForExpression(l);t.notifyChange("inputFields")}));return function(e){return n.apply(this,arguments)}}(),{initial:!0});this.handles.add([b.onLocaleChange(n),o,i])},i.destroy=function(){this.feature=null,this.layer=null,this._contingentValuesCache=l.destroyMaybe(this._contingentValuesCache),this._fieldPool.destroy(),this._fieldGroupPool.destroy()},i.findField=function(e){return this.allInputFields.find((t=>t.name===e))},i.getValue=function(e){var t;const{_featureClone:n,layer:i}=this,o=!(null==i||!i.getField(e));return null!=(t=n.getAttribute(e))?t:o?null:void 0},i.setValue=function(e,t){const{_featureClone:n,strict:i}=this,o=this.findField(e);t=""===t?null:t,o&&n.getAttribute(e)!==t&&(o.value=t,i&&!o.valid||this._afterValueChange(o))},i.getValues=function(){return{...this._featureClone.attributes}},i.submit=function(){const e=this.allInputFields,t=new Set(e.filter((e=>e.valid)).map((({name:e})=>e))),n=e.filter((e=>!e.valid)).map((({name:e})=>e)),i=this.getValues();if(this.validateContingencyConstraints(i,{includeIncompleteViolations:!0}).length>0)for(const[o,s]of this.contingencyConstraintViolations.entries())"error"===s.type&&(t.delete(o),n.push(o));this.emit("submit",{valid:[...t],invalid:n,values:i})},i.validateContingencyConstraints=function(e,t){const{_contingentValuesCache:n}=this,i=new Map;if(this.contingencyConstraintViolations=i,l.isNone(n))return[];const{invalid:o,incomplete:s}=n.validateContingencyConstraints(e),r=[...o,...null!=t&&t.includeIncompleteViolations?s:[]];for(const l of r)for(const e of l.fieldGroup.fields)i.set(e,l);return r},i._cullCaches=function(e,t,n){const i=[],o=[];for(const s of e)I(s)?(o.push(s.label),i.push(...s.inputFields.map((e=>e.name)))):i.push(s.name);this._cullInputFieldCache(i,t),this._cullInputFieldGroupCache(o,n)},i._cullInputFieldCache=function(e,t){const n=t.filter((t=>!e.includes(t)));for(const i in n)this._inputFieldCache.delete(i)},i._cullInputFieldGroupCache=function(e,t){const n=t.filter((t=>!e.includes(t)));for(const i in n)this._inputFieldGroupCache.delete(i)},i._releasePreviousInputFields=function(){const e=this._get("inputFields");if(e&&!(e.length<1))for(const t of e)"groupElement"in t?this._releaseInputFieldGroup(t):this._releaseInputField(t)},i._releaseInputFieldGroup=function(e){e.inputFields.forEach((e=>this._releaseInputField(e))),this._fieldGroupPool.release(e)},i._releaseInputField=function(e){this._fieldPool.release(e)},i._emitChangeEvent=function({name:e,valid:t,value:n}){this.emit("value-change",{layer:this.layer,feature:this.feature,fieldName:e,value:n,valid:t})},i._generateInputFieldsFromElements=function(e,t){const n=[];for(const i of e)this._isSupportedElement(i)&&n.push("group"===i.type?this._acquireAndInitializeInputFieldGroup(i,t):this._acquireAndInitializeInputField({field:this._layerFieldsByName.get(i.fieldName),fieldElement:i,...t}));return n},i._generateInputFieldsFromLayerFields=function(e,t){return Array.isArray(e)?e.map((e=>this._acquireAndInitializeInputField({field:e,fieldElement:null,...t}))):(x.warn(A,"No attribute fields found."),[])},i._acquireAndInitializeInputField=function(e){var t,n,i,o,s,r;const{arcade:l,feature:a,field:u,fieldElement:c,group:d,initialFeature:p,layer:f,messages:h}=e,y=null!=(t=this._getCompiledExpression(null==c?void 0:c.requiredExpression))?t:void 0,_=null!=(n=this._getCompiledExpression(null==c?void 0:c.visibilityExpression))?n:void 0,g=null!=(i=this._getCompiledExpression(null==c?void 0:c.valueExpression))?i:void 0,m=null!=(o=this._getCompiledExpression(null==c?void 0:c.editableExpression))?o:void 0,v=u.name,F=null!=(s=null==(r=this._inputFieldCache.get(v))?void 0:r.value)?s:this.getValue(v),C=this._fieldPool.acquire();return this._inputFieldCache.set(v,C),C.set({field:u,fieldElement:c,arcade:l,feature:a,group:d,initialFeature:p,layer:f,messages:h,requiredFunction:y,visibilityFunction:_,editableFunction:m,valueFunction:g,value:F})},i._acquireAndInitializeInputFieldGroup=function(e,t){var n,i;const o=null!=(n=null==(i=this._inputFieldGroupCache.get(e.label))?void 0:i.state)?n:e.initialState,s=this._fieldGroupPool.acquire();this._inputFieldGroupCache.set(e.label,s);const r=[];for(const c of e.elements)this._isSupportedElement(c)&&r.push(this._acquireAndInitializeInputField({field:this._layerFieldsByName.get(c.fieldName),fieldElement:c,group:s,...t}));const{arcade:l,feature:a}=t,u=this._getCompiledExpression(e.visibilityExpression);return s.set({arcade:l,feature:a,groupElement:e,inputFields:r,state:o,visibilityFunction:u})},i._afterValueChange=function(e){const{name:t,value:n}=e;if(this.get("layer.typeIdField")===e.name&&"types"in this.layer){const e=new Set;this.layer.types.forEach((t=>Object.keys(t.domains).forEach((t=>e.add(t))))),e.forEach((e=>{const t=this.findField(e);t&&t.notifyChange("domain")}))}this._featureClone.setAttribute(t,n),this.notifyChange("inputFields"),this._emitChangeEvent(e)},i._getCompiledExpression=function(e){return this._compiledExpressionLookup.get(this._expressionLookup.get(e))},i._getExpressionsFromElementRecursive=function(e){const t=[];if(e.visibilityExpression&&t.push(e.visibilityExpression),"field"===e.type){const n=["requiredExpression","valueExpression","editableExpression"];for(const i of n)e[i]&&t.push(e[i])}if("group"===e.type&&e.elements)for(const n of e.elements)t.push(...this._getExpressionsFromElementRecursive(n));return t},i._setFunctionForExpression=function(e){const{_arcade:{arcadeUtils:t},_compiledExpressionLookup:n}=this;n.set(e,t.createFunction(e))},i._isSupportedElement=function(e){return"field"===e.type||"group"===e.type||(x.warn("form-info::unsupported-element-type","Only element types 'field' and 'group' are supported",`Element ${e.label} has unsupported type '${e.type}'`),!1)},i._joinContingentValues=function(){const e=this._contingentValuesCache;if(l.isNone(e))return[];const t="typeIdField"in this.layer?this.layer.typeIdField:null,n=t?this.getValue(t):null,i=[];for(const r of e.fieldGroups){const{contingencies:e,fields:t,name:o}=r,s=[];for(const i of e)i.isRetired||l.isSome(i.subtype)&&i.subtype.code!==n||s.push({values:i.values});s.length>0&&i.push({name:o,fields:t,contingencies:s})}const[o,s]=this._generateJoinPlan(i);return[...o.flatMap((e=>this._joinFieldGroupContingencies(e))),...s.flatMap((e=>e.contingencies))]},i._generateJoinPlan=function(e){const t=new Map,n=[],i=new Set;for(const a of e)for(const e of a.fields)if(t.has(e)){const o=t.get(e),s=a,r=[o.name,s.name].sort().join("|");if(i.has(r))continue;n.push([o,s]),i.add(r),t.set(e,s)}else t.set(e,a);const o=new Set(n.flat()),s=new Set(e);for(const a of o)s.delete(a);const r=new Map,l=new Map;for(const a of new Set(n.flat())){const e=Symbol(a.name);r.set(e,new Set([a])),l.set(a,e)}for(const[a,u]of n){const e=l.get(a),t=l.get(u);if(e===t)continue;const n=r.get(e),i=r.get(t);for(const o of i)n.add(o),l.set(o,e);r.delete(t)}return[[...r.values()].map((e=>[...e])),[...s]]},i._joinFieldGroupContingencies=function(e){const t=e.slice(),n=t.shift();let i=t.shift(),o=this._generateJoinKey(n.fields,i.fields),s=new Set([...n.fields,...i.fields]),r=new Map;for(const l of n.contingencies){const[e]=this._hashContingency(l,o.codedValueFields,!0);r.has(e)?r.get(e).push(l):r.set(e,[l])}for(;t.length>0;){const e=new Map,n=t.shift(),a=this._generateJoinKey(s,n.fields);for(const t of i.contingencies){const[n,i]=this._hashContingency(t,o.codedValueFields),s=i?this._findMatchingContingenciesWithAnyHashMask(r,n):r.get(n);if(r.has(S)&&s.push(...this._findMatchingContingenciesContainingAny(t,r.get(S),o.codedValueFields)),!l.isNone(s))for(const r of s){const n=o.rangeFields.length>0?this._joinContingenciesWithRangeDomains(r,t,o.rangeFields):this._joinContingencies(r,t);if(l.isNone(n))break;const[i]=this._hashContingency(n,a.codedValueFields,!0);e.has(i)?e.get(i).push(n):e.set(i,[n])}}r=e,i=n,o=a,s=new Set([...s,...i.fields])}const a=[];for(const u of i.contingencies){const[e,t]=this._hashContingency(u,o.codedValueFields),n=t?this._findMatchingContingenciesWithAnyHashMask(r,e):r.get(e);if(r.has(S)&&n.push(...this._findMatchingContingenciesContainingAny(u,r.get(S),o.codedValueFields)),!l.isNone(n))for(const i of n){const e=o.rangeFields.length>0?this._joinContingenciesWithRangeDomains(i,u,o.rangeFields):this._joinContingencies(i,u);l.isSome(e)&&a.push(e)}}return a},i._joinContingencies=function(e,t){const n={values:{...e.values,...t.values}};for(const[i,o]of Object.entries(n.values))"any"===o.objectType&&l.isSome(e.values[i])&&(n.values[i]=e.values[i]);return n},i._joinContingenciesWithRangeDomains=function(e,t,n){const i=this._joinContingencies(e,t);for(const o of n){const n=e.values[o],s=t.values[o],{leftIsNull:r,rightIsNull:l,bothAreNull:a,leftIsAny:u,rightIsAny:c,bothAreAny:d,leftIsRange:p,rightIsRange:f}=this._compareObjectTypes(n.objectType,s.objectType);if(a||d)continue;if(r&&c||l&&u){i.values[o]=new g({objectType:"null"});continue}if(r&&f||l&&p)return null;u?(n.minValue=-1/0,n.maxValue=1/0):c&&(s.minValue=-1/0,s.maxValue=1/0);const h=Math.max(n.minValue,s.minValue),y=Math.min(n.maxValue,s.maxValue);if(h>y)return null;i.values[o]=new g({objectType:"range",minValue:h,maxValue:y})}return i},i._findMatchingContingenciesContainingAny=function(e,t,n){return t.filter((t=>n.every((n=>{var i,o;const s=t.values[n],r=e.values[n];return"any"===s.objectType||"any"===r.objectType||(null==(i=s.codedValue)?void 0:i.code)===(null==(o=r.codedValue)?void 0:o.code)}))))},i._findMatchingContingenciesWithAnyHashMask=function(e,t){const n=RegExp(`${t}$`),i=[];for(const[o,s]of e){if(o===S)break;n.test(o)&&i.push(...s)}return i},i._generateJoinKey=function(e,t){const n=Array.isArray(e)?new Set(e):e,i=Array.isArray(t)?new Set(t):t,o=n.size<i.size?n:i,s=o===n?i:n,r=new Set,a=new Set;for(const u of o)if(s.has(u)){const e=this.layer.getFieldDomain(u,{feature:this.feature});if(l.isNone(e))continue;switch(e.type){case"coded-value":r.add(u);break;case"range":a.add(u)}}return{codedValueFields:[...r],rangeFields:[...a]}},i._hashContingency=function(e,t,n=!1){if(t.length<1)return[w,!1];const i=[];let o=!1;for(const r of t){const t=e.values[r];if("any"===t.objectType){if(n)return[S,!0];o=!0,i.push(`${r}:.*`)}else if("null"===t.objectType)i.push(`${r}:${k}`);else{var s;i.push(`${r}:${null==(s=t.codedValue)?void 0:s.code}`)}}return[i.sort().join("&"),o]},i._compareObjectTypes=function(e,t){return{leftIsNull:"null"===e,rightIsNull:"null"===t,bothAreNull:"null"===e&&"null"===t,leftIsAny:"any"===e,rightIsAny:"any"===t,bothAreAny:"any"===e&&"any"===t,leftIsRange:"range"===e,rightIsRange:"range"===t}},e._createClass(n,[{key:"allInputFields",get:function(){return this.inputFields.reduce(((e,t)=>I(t)?[...e,...t.inputFields]:[...e,t]),[])}},{key:"_layerFieldsByName",get:function(){return new Map(this.layer.fields.map((e=>[e.name,e])))}},{key:"description",get:function(){const{formTemplate:e}=this;return l.isSome(e)?e.description:""},set:function(e){void 0===e?this._clearOverride("description"):this._override("description",e)}},{key:"feature",get:function(){return this._get("feature")},set:function(e){this._featureClone=e?e.clone():V.clone(),this._initialFeature=this._featureClone.clone(),this._inputFieldCache.clear(),this._inputFieldGroupCache.clear(),this.contingencyConstraintViolations.clear(),this._set("feature",e)}},{key:"fieldsWithContingentValues",get:function(){if(l.isNone(this._contingentValuesCache))return new Set;const e=this._contingentValuesCache.fieldGroups.flatMap((e=>e.fields));return new Set(e)}},{key:"formTemplate",get:function(){return this.layer&&"formTemplate"in this.layer?this.layer.formTemplate:null},set:function(e){void 0===e?this._clearOverride("formTemplate"):this._override("formTemplate",e)}},{key:"inputFields",get:function(){const{_arcade:e,_featureClone:t,_initialFeature:n,_inputFieldCache:i,_inputFieldGroupCache:o,_needsArcade:s,formTemplate:r,messages:a,layer:u,state:c}=this;if("ready"!==c||s&&!e)return[];const d=t.clone(),p=Array.from(i.keys()),f=Array.from(o.keys()),h={arcade:e,feature:d,initialFeature:n,layer:u,messages:a},y=l.isSome(r)&&r.elements.length>0?this._generateInputFieldsFromElements(r.elements,h):this._generateInputFieldsFromLayerFields(null==u?void 0:u.fields,h);return this._cullCaches(y,p,f),this._releasePreviousInputFields(),y.filter((e=>e.visible))}},{key:"joinedContingentValues",get:function(){return this._joinContingentValues()}},{key:"layer",get:function(){var e;return null!=(e=this.feature)&&e.sourceLayer&&"applyEdits"in this.feature.sourceLayer?this.feature.sourceLayer:null},set:function(e){e?this._override("layer",e):this._clearOverride("layer")}},{key:"state",get:function(){return this.messages&&this.get("layer.loaded")?"ready":"disabled"}},{key:"submittable",get:function(){return!!this.valid||this.allInputFields.filter((e=>!e.valid)).every((({submittable:e})=>e))}},{key:"title",get:function(){const{formTemplate:e}=this;return l.isSome(e)?e.title:""},set:function(e){void 0===e?this._clearOverride("title"):this._override("title",e)}},{key:"valid",get:function(){const e=this.allInputFields;return e.length>0&&e.every((({valid:e})=>e))}}]),n}(s.HandleOwnerMixin(a.EsriPromiseMixin(o.EventedAccessor)));t.__decorate([d.property({readOnly:!0})],T.prototype,"allInputFields",null),t.__decorate([d.property()],T.prototype,"_layerFieldsByName",null),t.__decorate([d.property({readOnly:!0})],T.prototype,"_inputFieldCache",void 0),t.__decorate([d.property({readOnly:!0})],T.prototype,"_inputFieldGroupCache",void 0),t.__decorate([d.property()],T.prototype,"contingencyConstraintViolations",void 0),t.__decorate([d.property()],T.prototype,"description",null),t.__decorate([d.property()],T.prototype,"feature",null),t.__decorate([d.property()],T.prototype,"fieldsWithContingentValues",null),t.__decorate([d.property({type:_})],T.prototype,"formTemplate",null),t.__decorate([d.property({readOnly:!0,dependsOn:["formTemplate","messages","feature","layer.fields","layer.loaded","state"]})],T.prototype,"inputFields",null),t.__decorate([d.property()],T.prototype,"joinedContingentValues",null),t.__decorate([d.property()],T.prototype,"layer",null),t.__decorate([d.property()],T.prototype,"messages",void 0),t.__decorate([d.property()],T.prototype,"state",null),t.__decorate([d.property()],T.prototype,"strict",void 0),t.__decorate([d.property()],T.prototype,"submittable",null),t.__decorate([d.property()],T.prototype,"title",null),t.__decorate([d.property()],T.prototype,"valid",null),t.__decorate([d.property()],T.prototype,"getValues",null),t.__decorate([d.property()],T.prototype,"submit",null),T=t.__decorate([y.subclass(A)],T);return T}));
