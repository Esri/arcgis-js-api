/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/Accessor","../../core/MapUtils","../../core/maybe","../../core/promiseUtils","../../core/accessorSupport/decorators/property","../../core/arrayUtils","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass"],(function(e,t,r,o,s,a,n,i,c,u,l){"use strict";const p="#JSAPI_FORM_EXPRESSIONS_MANAGER_GEOMETRY",f="esri.widgets.FeatureForm.FormExpressionsManager";e.FormExpressionsManager=function(e){function r(t){var r;return(r=e.call(this,t)||this)._fieldReferencesLookup=new Map,r._fieldsAffectedLookup=new Map,r._latestFieldValues={...t.feature.attributes},r}t._inheritsLoose(r,e);var o=r.prototype;return o.initialize=function(){this._dependencyGraph=this._buildDependencyGraph()},o.evaluateAll=function(){return this._evaluate(this.executors)},o.evaluateExpressions=function(e){return this._evaluate(e)},o.evaluateInvalidated=function(e){const{_fieldReferencesLookup:t,_latestFieldValues:r,feature:o}=this,s=new Set;for(const a of e)if(r[a]=o.getAttribute(a),t.has(a))for(const e of t.get(a))s.add(e);return this._evaluate([...s])},o.evaluateInvalidatedByGeometry=function(){var e=t._asyncToGenerator((function*(){if(this._fieldReferencesLookup.has(p))return this._evaluate([...this._fieldReferencesLookup.get(p)])}));function r(){return e.apply(this,arguments)}return r}(),o.resetExecutors=function(){for(const e of this.executors)e.reset()},o._buildDependencyGraph=function(){const{_fieldReferencesLookup:e,_fieldsAffectedLookup:t,executors:r}=this,o=new Map(this.inputFields.map((e=>[e.name,e]))),n=new Map(r.map((e=>[e,new Array])));for(const i of r){for(const r of i.fieldsUsed){s.getOrCreateMapValue(e,r,(()=>new Set)).add(i);const c=o.get(r),{valueExpressionExecutor:u,editableExpressionExecutor:l}=c;if(a.isSome(u)){n.get(u).push(i);s.getOrCreateMapValue(t,u,(()=>new Set)).add(c)}if(a.isSome(l)){n.get(l).push(i);s.getOrCreateMapValue(t,l,(()=>new Set)).add(c)}}if(i.geometryUsed){s.getOrCreateMapValue(e,p,(()=>new Set)).add(i)}}return n},o._evaluate=function(){var e=t._asyncToGenerator((function*(e){var r=this;const o=new Map,{_dependencyGraph:s,_fieldsAffectedLookup:a,_latestFieldValues:i}=this;for(const t of e)d(t,o,s);for(const[u,{resolver:l,dependencyPromises:p}]of o){Promise.all(p).then(t._asyncToGenerator((function*(){const[e,t]=r._makeContext(i);return u.executeAsync(e,t)}))).then((()=>{if(a.has(u))for(const e of a.get(u))this._latestFieldValues[e.name]=e.value;l.resolve()}),(e=>{!e||n.isAbortError(e)||_(e)||u.markStale(),l.reject(e)}))}const c=(yield Promise.allSettled(Array.from(o.values(),(({resolver:e})=>e.promise)))).filter((e=>"rejected"===e.status&&!(n.isAbortError(e.reason)||_(e.reason))));if(c.length>0)throw new AggregateError(c,"One or more expression executions failed")}));function r(t){return e.apply(this,arguments)}return r}(),o._makeContext=function(e){const[t,r]=this._baseContext,o=this.feature.clone();return o.attributes=e,[{...t,$feature:o},r]},t._createClass(r,[{key:"_baseContext",get:function(){const{editType:e,layer:t,map:r,originalFeature:o,spatialReference:s}=this.arcadeContextInfo,n="feature"===t?.type?t:"scene"===t?.type&&a.isSome(t.associatedLayer)?t.associatedLayer:void 0;return[{$originalfeature:o,$editcontext:{editType:e},$layer:n,$featureset:n,$datastore:t?.url,$map:r},{spatialReference:s}]}},{key:"feature",set:function(e){this._latestFieldValues={...e?.attributes},this._set("feature",e)}}]),r}(o),r.__decorate([i.property()],e.FormExpressionsManager.prototype,"_baseContext",null),r.__decorate([i.property()],e.FormExpressionsManager.prototype,"feature",null),r.__decorate([i.property()],e.FormExpressionsManager.prototype,"executors",void 0),r.__decorate([i.property()],e.FormExpressionsManager.prototype,"inputFields",void 0),r.__decorate([i.property()],e.FormExpressionsManager.prototype,"arcadeContextInfo",void 0),e.FormExpressionsManager=r.__decorate([l.subclass(f)],e.FormExpressionsManager);const d=(e,t,r)=>{if(t.has(e))return;const o=n.createResolver();t.set(e,{resolver:o,dependencyPromises:[]}),e.abort();const s=r.get(e);for(const a of s)d(a,t,r),t.get(a).dependencyPromises.push(o.promise)},_=e=>e&&"object"==typeof e&&"message"in e&&"Cancelled"===e.message;Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
