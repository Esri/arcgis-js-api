/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../intl","../../request","../../core/Collection","../../core/deprecate","../../core/Error","../../core/Handles","../../core/lang","../../core/Loadable","../../core/Logger","../../core/maybe","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass","../../portal/Portal","../../rest/geoprocessor/execute","../../rest/geoprocessor/GPOptions","../../core/has","../../geometry/support/normalizeUtils","../../layers/support/Field","../../layers/support/MapImage","../../core/urlUtils","../../core/unitUtils","../../rest/support/DataFile","../../rest/support/FeatureSet","../../rest/support/LinearUnit","../../rest/support/ParameterValue","../../rest/support/RasterData","../../rest/support/JobInfo","../../rest/print","../../rest/support/fileFormat","../../rest/support/layoutTemplate","../../rest/support/PrintParameters","../../rest/support/PrintTemplate","./CustomTemplate","../../intl/date"],(function(e,t,r,o,a,n,s,i,l,p,c,u,d,f,m,y,h,v,_,T,x,w,O,g,S,E,b,P,C,L,U,D,F,V,G,I,k){"use strict";const J=6e4,j=a.ofType(I);function N(e){e.layoutOptions||(e.layoutOptions={}),e.layoutOptions.customTextElements||(e.layoutOptions.customTextElements=[]);const t="date";if(!e.layoutOptions.customTextElements.find((e=>t in e))){const{customTextElements:t}=e.layoutOptions;t.push({date:k.formatDate(Date.now(),k.convertDateFormatToIntlOptions("short-date"))})}}let z=function(t){function r(r){var o;return(o=t.call(this,r)||this)._handles=new i,o.allowedFormats="all",o.allowedLayouts="all",o.defaultTemplates=new j,o.extraParameters=null,o.includeDefaultTemplates=!0,o.effectivePrintServiceUrl=null,o.error=null,o.portal=y.getDefault(),o.printServiceUrl=null,o.templatesInfo=null,o.updateDelay=1e3,o.view=null,o.templateCustomTextElements=null,o.print=o.print.bind(e._assertThisInitialized(o)),o}e._inheritsLoose(r,t);var a=r.prototype;return a.destroy=function(){this._handles.destroy(),this._handles=null,this.view=null},a.load=function(){var t=e._asyncToGenerator((function*(e){return this.addResolvingPromise(this._loadResources(e).catch((e=>this.error=e))),this}));function r(e){return t.apply(this,arguments)}return r}(),a.print=function(){var t=e._asyncToGenerator((function*(e){const{view:t,extraParameters:r,updateDelay:o}=this;if(!t)throw new s("print:view-required","view is not set");N(e);const a=new V({view:t,template:e,extraParameters:r,updateDelay:o});try{return yield U.execute(this.effectivePrintServiceUrl,a)}catch(n){throw new s("print:export-error","An error occurred while exporting the web map.",{error:n})}}));function r(e){return t.apply(this,arguments)}return r}(),a.toPrintTemplate=function({attributionEnabled:e,author:t,copyright:r,customTextElements:o,dpi:a,forceFeatureAttributes:n,format:s,height:i,layout:l,legendEnabled:p,title:c,scale:u,scaleEnabled:d,width:f}){const m=new G({attributionVisible:e,layoutOptions:{authorText:t||"",copyrightText:r||"",customTextElements:o,titleText:c||""},forceFeatureAttributes:n,format:s,layout:l,scalePreserved:d,outScale:u});return f&&(m.exportOptions.width=f),i&&(m.exportOptions.height=i),a&&(m.exportOptions.dpi=a),p||(m.layoutOptions.legendLayers=[]),m},a._loadResources=function(){var t=e._asyncToGenerator((function*(e){let t=[];const{printServiceUrl:r}=this;if(!r){var o;if(this.destroyed)return;const{portal:r}=this;try{yield r.load(e)}catch(n){throw new s("print:could-not-load-portal","Cannot load print resource information from portal",{url:this.effectivePrintServiceUrl})}const i=null==(o=r.helperServices)?void 0:o.printTask;var a;if(i)this._set("effectivePrintServiceUrl",i.url),t=(null!=(a=null==i?void 0:i.templates)?a:[]).map((e=>I.fromJSON(e)))}t.length>0&&this.defaultTemplates.addMany(t);if(-1===this.effectivePrintServiceUrl.toLowerCase().split("/").indexOf("gpserver"))throw new s("print:invalid-print-service-url","Can't fetch print templates information from provided URL",{url:this.effectivePrintServiceUrl});this._serviceTemplateCustomTextElements=yield this._getTemplateToCustomTextElements(e),yield this._loadServiceDescription(e)}));function r(e){return t.apply(this,arguments)}return r}(),a._loadServiceDescription=function(){var t=e._asyncToGenerator((function*(e){const t=yield this._getPrintTemplatesFromService(e);this._set("templatesInfo",t)}));function r(e){return t.apply(this,arguments)}return r}(),a._getTemplateToCustomTextElements=function(){var t=e._asyncToGenerator((function*(e){const t={};try{const r=this.effectivePrintServiceUrl.replace(/(\/GPServer\/).+/i,"$1Get%20Layout%20Templates%20Info"),{results:[o]}=yield h.execute(r,null,null,u.unwrap(e));o.value.forEach((({layoutTemplate:e,layoutOptions:{customTextElements:r}})=>t[F.fromJSON(e)]=r))}catch(r){}return Object.freeze(t)}));function r(e){return t.apply(this,arguments)}return r}(),a._getPrintTemplatesFromService=function(){var t=e._asyncToGenerator((function*(e){return o(this.effectivePrintServiceUrl,{...e,query:{f:"json"},timeout:J}).then((e=>{const t=e&&e.data,r=t&&t.parameters;let o=null,a=null;r.forEach((e=>{let t,r=e.choiceList&&e.choiceList.slice();r&&r.length&&e.defaultValue&&(t=r.indexOf(e.defaultValue)),t>-1&&(r.splice(t,1),r.unshift(e.defaultValue));const n=(e,t)=>{const r="all"===t?e:e.filter((e=>t.indexOf(e)>-1));return 0===r.length?e:r};if("Format"===e.name){const t=n(r.map(D.fromJSON),this.allowedFormats),a=D.fromJSON(e.defaultValue);o={defaultValue:t.includes(a)?a:t[0],choiceList:t}}else if("Layout_Template"===e.name){let t,o;r=r.filter((e=>"map_only"!==e.toLowerCase())),r.some(((e,r)=>{const o=e.toLowerCase();return o.indexOf("letter")>-1&&o.indexOf("landscape")>-1?(t=r,!0):o.indexOf("a4")>-1&&o.indexOf("landscape")>-1&&(t=r,!1)})),t&&(o=r[t],r.splice(t,1),r.unshift(o));const s=n(r.map(F.fromJSON),this.allowedLayouts),i=F.fromJSON(e.defaultValue);a={defaultValue:s.includes(i)?i:s[0],choiceList:s}}})),this.error=null;return{format:o,layout:a}})).catch((e=>{throw new s("print:unavailable-service-info","Can't fetch templates info from service",{error:e})}))}));function r(e){return t.apply(this,arguments)}return r}(),e._createClass(r,[{key:"effectiveTemplateCustomTextElements",get:function(){if(!this._serviceTemplateCustomTextElements)return{};const e=l.clone(this._serviceTemplateCustomTextElements);return this.templateCustomTextElements&&Object.keys(this.templateCustomTextElements).forEach((t=>{const r=e[t];if(r){const e=this.templateCustomTextElements[t];r.forEach((t=>{const[r]=Object.entries(t)[0];e.find((e=>{const[o,a]=Object.entries(e)[0];r===o&&(t[r]=a)}))}))}})),Object.freeze(e)}},{key:"state",get:function(){return"loading"===this.loadStatus?"initializing":this.error||"failed"===this.loadStatus?"error":this.get("view.ready")&&"loaded"===this.loadStatus?"ready":"disabled"}},{key:"scaleEnabled",set:function(e){n.deprecatedProperty(c.getLogger(this.declaredClass),"scaleEnabled",{version:"4.22"}),this.set("scaleEnabled",e)}}]),r}(p);t.__decorate([d.property()],z.prototype,"_serviceTemplateCustomTextElements",void 0),t.__decorate([d.property()],z.prototype,"allowedFormats",void 0),t.__decorate([d.property()],z.prototype,"allowedLayouts",void 0),t.__decorate([d.property({type:j})],z.prototype,"defaultTemplates",void 0),t.__decorate([d.property()],z.prototype,"extraParameters",void 0),t.__decorate([d.property()],z.prototype,"includeDefaultTemplates",void 0),t.__decorate([d.property({aliasOf:{source:"printServiceUrl",overridable:!0},readOnly:!0})],z.prototype,"effectivePrintServiceUrl",void 0),t.__decorate([d.property()],z.prototype,"effectiveTemplateCustomTextElements",null),t.__decorate([d.property()],z.prototype,"error",void 0),t.__decorate([d.property({type:y})],z.prototype,"portal",void 0),t.__decorate([d.property()],z.prototype,"printServiceUrl",void 0),t.__decorate([d.property({readOnly:!0})],z.prototype,"state",null),t.__decorate([d.property()],z.prototype,"scaleEnabled",null),t.__decorate([d.property({readOnly:!0})],z.prototype,"templatesInfo",void 0),t.__decorate([d.property()],z.prototype,"updateDelay",void 0),t.__decorate([d.property()],z.prototype,"view",void 0),t.__decorate([d.property()],z.prototype,"templateCustomTextElements",void 0),z=t.__decorate([m.subclass("esri.widgets.Print.PrintViewModel")],z);return z}));
