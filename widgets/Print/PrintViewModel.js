/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../request","../../core/Collection","../../core/Error","../../core/lang","../../core/Loadable","../../core/maybe","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass","../../intl/date","../../intl/locale","../../portal/Portal","../../rest/geoprocessor/execute","../../rest/geoprocessor/GPOptions","../../core/has","../../geometry/support/normalizeUtils","../../layers/support/Field","../../layers/support/MapImage","../../config","../../kernel","../../core/urlUtils","../../rest/support/DataFile","../../rest/support/FeatureSet","../../rest/support/LinearUnit","../../rest/support/ParameterValue","../../rest/support/RasterData","../../rest/support/JobInfo","../../rest/print","../../rest/support/fileFormat","../../rest/support/layoutTemplate","../../rest/support/PrintParameters","../../rest/support/PrintTemplate","./CustomTemplate"],(function(e,t,r,o,n,a,i,s,l,p,c,u,d,f,m,y,h,v,_,T,w,g,x,S,O,P,b,E,L,C,I,U,D,F,G){"use strict";const k=6e4,N=o.ofType(G);function V(e){e.layoutOptions||(e.layoutOptions={}),e.layoutOptions.customTextElements||(e.layoutOptions.customTextElements=[]);const t="date";if(!e.layoutOptions.customTextElements.find((e=>t in e))){const{customTextElements:t}=e.layoutOptions;let r=u.formatDate(Date.now(),u.convertDateFormatToIntlOptions("short-date"));"ar"===d.getLanguage()&&(r="â€"+r),t.push({date:r})}}let A=function(t){function o(r){var o;return(o=t.call(this,r)||this).allowedFormats="all",o.allowedLayouts="all",o.defaultTemplates=new N,o.extraParameters=null,o.includeDefaultTemplates=!0,o.error=null,o.portal=f.getDefault(),o.printServiceUrl=null,o.templatesInfo=null,o.updateDelay=1e3,o.view=null,o.templateCustomTextElements=null,o.print=o.print.bind(e._assertThisInitialized(o)),o}e._inheritsLoose(o,t);var i=o.prototype;return i.destroy=function(){this.view=null},i.load=function(){var t=e._asyncToGenerator((function*(e){return this.addResolvingPromise(this._loadResources(e).catch((e=>this.error=e))),this}));function r(e){return t.apply(this,arguments)}return r}(),i.print=function(){var t=e._asyncToGenerator((function*(e){const{view:t,extraParameters:r,updateDelay:o}=this;if(!t)throw new n("print:view-required","view is not set");V(e);const a=new D({view:t,template:e,extraParameters:r,updateDelay:o});try{return yield C.execute(this.effectivePrintServiceUrl,a)}catch(i){throw new n("print:export-error","An error occurred while exporting the web map.",{error:i})}}));function r(e){return t.apply(this,arguments)}return r}(),i.toPrintTemplate=function({attributionEnabled:e,author:t,copyright:r,customTextElements:o,dpi:n,forceFeatureAttributes:a,format:i,height:s,layout:l,legendEnabled:p,northArrowEnabled:c,scale:u,scaleEnabled:d,title:f,width:m}){const y=new F({attributionVisible:e,forceFeatureAttributes:a,format:i,layout:l,layoutOptions:{authorText:t||"",copyrightText:r||"",customTextElements:o,titleText:f||""},outScale:u,scalePreserved:d});m&&(y.exportOptions.width=m),s&&(y.exportOptions.height=s),n&&(y.exportOptions.dpi=n),p||(y.layoutOptions.legendLayers=[]);const h=this.templateToNorthArrowInfo[l];if(h){h.visible===c||(y.layoutOptions.elementOverrides={[h.name]:{visible:c}})}return y},i._loadResources=function(){var t=e._asyncToGenerator((function*(e){let t=[];const{printServiceUrl:r}=this;if(!r){if(this.destroyed)return;const{portal:r}=this;try{yield r.load(e)}catch(o){throw new n("print:could-not-load-portal","Cannot load print resource information from portal",{url:this.effectivePrintServiceUrl})}const a=r.helperServices?.printTask;a&&(this._set("effectivePrintServiceUrl",a.url),t=(a?.templates??[]).map((e=>G.fromJSON(e))))}t.length>0&&this.defaultTemplates.addMany(t);if(-1===this.effectivePrintServiceUrl.toLowerCase().split("/").indexOf("gpserver"))throw new n("print:invalid-print-service-url","Can't fetch print templates information from provided URL",{url:this.effectivePrintServiceUrl});this._processLayoutTemplateInfos(yield this._getLayoutTemplatesInfo(e)),yield this._loadServiceDescription(e)}));function r(e){return t.apply(this,arguments)}return r}(),i._loadServiceDescription=function(){var t=e._asyncToGenerator((function*(e){const t=yield this._getPrintTemplatesFromService(e);this._set("templatesInfo",t)}));function r(e){return t.apply(this,arguments)}return r}(),i._getLayoutTemplatesInfo=function(){var t=e._asyncToGenerator((function*(t){var r=this;let o=[];const n=function(){var o=e._asyncToGenerator((function*(e){const o=r.effectivePrintServiceUrl.replace(/(\/GPServer\/).+/i,`$1${encodeURI(e)}`);return(yield m.execute(o,null,null,s.unwrap(t))).results[0].value}));return function(e){return o.apply(this,arguments)}}();try{o=yield n("Get Layout Templates Info Task")}catch(a){}if(!o||o.length<1)try{o=yield n("Get Layout Templates Info")}catch(a){}return o}));function r(e){return t.apply(this,arguments)}return r}(),i._processLayoutTemplateInfos=function(e){const t={},r={};e.forEach((({layoutTemplate:e,layoutOptions:{customTextElements:o,mapSurroundInfos:n}})=>{const a=U.fromJSON(e);t[a]=o,n&&(r[a]=n.find((e=>"CIMMarkerNorthArrow"===e.type)))})),this.templateCustomTextElements=Object.freeze(t),this.templateToNorthArrowInfo=r},i._getPrintTemplatesFromService=function(){var t=e._asyncToGenerator((function*(e){return r(this.effectivePrintServiceUrl,{...e,query:{f:"json"},timeout:k}).then((e=>{const t=e&&e.data,r=t&&t.parameters;let o=null,n=null;r.forEach((e=>{let t,r=e.choiceList&&e.choiceList.slice();r&&r.length&&e.defaultValue&&(t=r.indexOf(e.defaultValue)),t>-1&&(r.splice(t,1),r.unshift(e.defaultValue));const a=(e,t)=>{const r="all"===t?e:e.filter((e=>t.includes(e)));return 0===r.length?e:r};if("Format"===e.name){const t=a(r.map(I.fromJSON),this.allowedFormats),n=I.fromJSON(e.defaultValue);o={defaultValue:t.includes(n)?n:t[0],choiceList:t}}else if("Layout_Template"===e.name){let t,o;r=r.filter((e=>"map_only"!==e.toLowerCase())),r.some(((e,r)=>{const o=e.toLowerCase();return o.includes("letter")&&o.includes("landscape")?(t=r,!0):!(!o.includes("a4")||!o.includes("landscape"))&&(t=r,!1)})),t&&(o=r[t],r.splice(t,1),r.unshift(o));const i=a(r.map(U.fromJSON),this.allowedLayouts),s=U.fromJSON(e.defaultValue);n={defaultValue:i.includes(s)?s:i[0],choiceList:i}}})),this.error=null;return{format:o,layout:n}})).catch((e=>{throw new n("print:unavailable-service-info","Can't fetch templates info from service",{error:e})}))}));function o(e){return t.apply(this,arguments)}return o}(),e._createClass(o,[{key:"effectivePrintServiceUrl",get:function(){return this.printServiceUrl??null}},{key:"effectiveTemplateCustomTextElements",get:function(){if(!this._serviceTemplateCustomTextElements)return{};const e=a.clone(this._serviceTemplateCustomTextElements);return this.templateCustomTextElements&&Object.keys(this.templateCustomTextElements).forEach((t=>{const r=e[t];if(r){const e=this.templateCustomTextElements[t];r.forEach((t=>{const[r]=Object.entries(t)[0];e.find((e=>{const[o,n]=Object.entries(e)[0];r===o&&(t[r]=n)}))}))}})),Object.freeze(e)}},{key:"state",get:function(){return"loading"===this.loadStatus?"initializing":this.error||"failed"===this.loadStatus?"error":this.get("view.ready")&&"loaded"===this.loadStatus?"ready":"disabled"}}]),o}(i);t.__decorate([l.property()],A.prototype,"_serviceTemplateCustomTextElements",void 0),t.__decorate([l.property()],A.prototype,"allowedFormats",void 0),t.__decorate([l.property()],A.prototype,"allowedLayouts",void 0),t.__decorate([l.property({type:N})],A.prototype,"defaultTemplates",void 0),t.__decorate([l.property()],A.prototype,"extraParameters",void 0),t.__decorate([l.property()],A.prototype,"includeDefaultTemplates",void 0),t.__decorate([l.property({readOnly:!0})],A.prototype,"effectivePrintServiceUrl",null),t.__decorate([l.property()],A.prototype,"effectiveTemplateCustomTextElements",null),t.__decorate([l.property()],A.prototype,"error",void 0),t.__decorate([l.property({type:f})],A.prototype,"portal",void 0),t.__decorate([l.property()],A.prototype,"printServiceUrl",void 0),t.__decorate([l.property({readOnly:!0})],A.prototype,"state",null),t.__decorate([l.property({readOnly:!0})],A.prototype,"templatesInfo",void 0),t.__decorate([l.property()],A.prototype,"updateDelay",void 0),t.__decorate([l.property()],A.prototype,"view",void 0),t.__decorate([l.property()],A.prototype,"templateCustomTextElements",void 0),t.__decorate([l.property()],A.prototype,"templateToNorthArrowInfo",void 0),A=t.__decorate([c.subclass("esri.widgets.Print.PrintViewModel")],A);return A}));
