// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../geometry","../../Graphic","../../intl","../../symbols","../../core/Handles","../../core/unitFormatUtils","../../core/unitUtils","../../core/watchUtils","../../core/accessorSupport/decorators","../../geometry/geometryEngine","../../geometry/projection","../../geometry/support/geodesicUtils","../../layers/GraphicsLayer","../../layers/GroupLayer","../../views/2d/draw/Draw","../../views/interactive/dragEventPipeline","../../views/interactive/GraphicManipulator","../../views/interactive/InteractiveToolBase"],(function(e,t,r,i,s,a,o,n,l,c,p,u,h,d,m,y,f,v,_,g,w){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createAreaMeasurementLabel=t.isSupported=t.createAreaMeasurementInfo2D=void 0;var L=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._drawActive=!1,t._handles=new n,t._graphicsLayer=new y,t._manipulatorLayer=new y,t._groupLayer=new f({layers:[t._graphicsLayer,t._manipulatorLayer],listMode:"hide",visible:!1}),t._vertices=[],t.deferCreation=!0,t.geodesicDistanceThreshold=1e5,t.measurement=null,t.measurementLabel=null,t}return r.__extends(t,e),t.prototype.initialize=function(){var e=this;a.loadMessageBundle("esri/core/t9n/Units").then((function(t){e.messages=t})),this._handles.add(a.onLocaleChange((function(){return r.__awaiter(e,void 0,void 0,(function(){var e;return r.__generator(this,(function(t){switch(t.label){case 0:return e=this,[4,a.loadMessageBundle("esri/core/t9n/Units")];case 1:return e.messages=t.sent(),[2]}}))}))})))},t.prototype.destroy=function(){this.detach(),this._draw&&(this._draw.destroy(),this._draw=null),this._handles&&(this._handles.destroy(),this._handles=null),this._graphicsLayer&&(this._graphicsLayer.destroy(),this._graphicsLayer=null),this._manipulatorLayer&&(this._manipulatorLayer.destroy(),this._manipulatorLayer=null)},Object.defineProperty(t.prototype,"editable",{set:function(e){this._set("editable",e),e||this._draw.reset()},enumerable:!1,configurable:!0}),t.prototype.activate=function(){this._drawActive||0!==this._vertices.length||this._startSketch()},t.prototype.onAttach=function(){var e=this,t=this.view;this._draw=new v({view:t}),t.map.add(this._groupLayer),t.focus(),this._handles.add([p.init(this,["unit","geodesicDistanceThreshold","palette","messages"],(function(){e._vertices.length>0&&e._updateGraphics()})),p.init(this,"view.spatialReference",(function(e){S(e)&&!d.isLoaded()&&d.load()}))]),this.create()},t.prototype.onDetach=function(){var e=this.view.map;this._draw.view=null,this._draw.destroy(),this._draw=null,e.remove(this._groupLayer),this._handles.removeAll(),this._graphicsLayer.removeAll(),this._manipulatorLayer.removeAll(),this._set("measurement",null),this._set("measurementLabel",null)},t.prototype.onShow=function(){this._groupLayer.visible=!0},t.prototype.onHide=function(){this._groupLayer.visible=!1},t.prototype.reset=function(){this._vertices=[],this._graphicsLayer.removeAll(),this._set("measurement",null),this._set("measurementLabel",null),this._draw.reset(),this._drawActive=!1,this._updateSketch([])},t.prototype.onInputEvent=function(e){"pointer-move"===e.type&&this._updateCursor()},t.prototype._startSketch=function(){var e=this;this._drawActive=!0;var t=this._draw.create("polyline",{mode:"click"});t.on(["vertex-add","vertex-update","vertex-remove","cursor-update","undo","redo"],(function(t){return e._updateSketch(t.vertices)})),t.on("draw-complete",(function(){return e._stopSketch()}))},t.prototype._stopSketch=function(){if(this._vertices.length<3)return this.reset(),void this._startSketch();this.manipulators.forEach((function(e){e.manipulator.interactive=!0})),this._drawActive=!1,this.complete()},t.prototype._updateSketch=function(e){var t=this;if(!S(this.view.spatialReference)||d.isLoaded()){if(e.length<2)return this._vertices=[],this.manipulators.removeAll(),void this._graphicsLayer.removeAll();this.create();for(var r=this.view.spatialReference;this._vertices.length>e.length;){var a=this._vertices.pop().manipulatorId;this.manipulators.remove(a)}for(var n=function(a){var n=e[a],c=n[0],p=n[1],u=function(e,t,r,i){var a=new o.SimpleMarkerSymbol({style:"circle",color:i.handleColor,size:i.handleWidth,outline:{type:"simple-line",width:0}}),n=new o.SimpleMarkerSymbol({style:"circle",color:i.handleColor,size:1.5*i.handleWidth,outline:{type:"simple-line",width:0}}),l=new s({geometry:e,symbol:a});return new g.GraphicManipulator({view:t,layer:r,graphic:l,focusedSymbol:n})}(new i.Point({x:c,y:p,spatialReference:r}),l.view,l._manipulatorLayer,l.palette),h=l.manipulators.add(u);_.createManipulatorDragEventPipeline(u,(function(e,r){r.next(_.screenToMap(t.view)).next(_.dragGraphic(e.graphic)).next((function(){var r=e.graphic.geometry;t._vertices[a].coord=[r.x,r.y],t._updateGraphics()}))})),l._vertices.push({manipulatorId:h,coord:[c,p]})},l=this,c=this._vertices.length;c<e.length;c++)n(c);var p=this._vertices.length-1,u=this._vertices[p],h=e[p],m=h[0],y=h[1];if(u.coord[0]!==m||u.coord[1]!==y){u.coord=[m,y];var f=new i.Point({x:m,y:y,spatialReference:r});this.manipulators.findById(u.manipulatorId).graphic.geometry=f}var v=this._drawActive?this._vertices[p].manipulatorId:null;this.manipulators.forEach((function(e){e.manipulator.interactive=null==v||e.id!==v})),this._updateGraphics()}},t.prototype._updateCursor=function(){this.cursor=this._drawActive?"crosshair":null},t.prototype._updateGraphics=function(){this._graphicsLayer.removeAll();var e=b(this._vertices.map((function(e){return e.coord})),this.view.spatialReference,this.geodesicDistanceThreshold),t=e.measurement,r=e.fillGeometry,i=e.outlineGeometry;this._set("measurement",t);var a=t?A(this.messages,t,this.unit):null;if(this._set("measurementLabel",a),r||i){var n=this.palette,l=n.fillColor,c=n.pathColor,p=n.pathWidth,u=[];r&&u.push(new s({geometry:r,symbol:new o.SimpleFillSymbol({color:l,outline:new o.SimpleLineSymbol({width:0})})})),i&&u.push(new s({geometry:i,symbol:new o.SimpleLineSymbol({color:c,width:p})})),r&&a&&u.push(new s({geometry:r.centroid,symbol:new o.TextSymbol({color:[255,255,255,1],haloColor:[0,0,0,.5],haloSize:2,text:a.area,font:new o.Font({size:14,family:"sans-serif"})})})),this._graphicsLayer.addMany(u)}},r.__decorate([u.property()],t.prototype,"cursor",void 0),r.__decorate([u.property({value:!0})],t.prototype,"editable",null),r.__decorate([u.property({type:Number})],t.prototype,"geodesicDistanceThreshold",void 0),r.__decorate([u.property({readOnly:!0})],t.prototype,"measurement",void 0),r.__decorate([u.property({readOnly:!0})],t.prototype,"measurementLabel",void 0),r.__decorate([u.property()],t.prototype,"messages",void 0),r.__decorate([u.property()],t.prototype,"palette",void 0),r.__decorate([u.property()],t.prototype,"unit",void 0),r.__decorate([u.property({constructOnly:!0})],t.prototype,"view",void 0),t=r.__decorate([u.subclass("esri.widgets.AreaMeasurement2D.AreaMeasurement2DTool")],t)}(w.InteractiveToolBase);function b(e,t,r){if(2===e.length){var s=new i.Polyline({paths:e,spatialReference:t}),a=void 0;if(t.isGeographic)if(m.isSupported(t))a=m.geodesicDensify(s,1e5);else{var o=d.project(s,i.SpatialReference.WGS84),n=m.geodesicDensify(o,1e5);a=d.project(n,t)}else if(t.isWebMercator)a=h.geodesicDensify(s,1e5,"meters");else if((g=h.planarLength(s,"meters"))>=r){o=d.project(s,i.SpatialReference.WGS84),n=m.geodesicDensify(o,1e5);a=d.project(n,t)}else a=s;return{measurement:null,fillGeometry:null,outlineGeometry:a}}e.push(e[0]);var l,c,p=new i.Polyline({paths:[e],spatialReference:t}),u=new i.Polygon({rings:[e],spatialReference:t}),y=null,f=null;if(t.isGeographic)if(m.isSupported(t)){if(y=m.geodesicDensify(p,1e5),f=m.geodesicDensify(u,1e5),!(f=h.simplify(f)))return null;l=m.geodesicLengths([p],"meters")[0],c=m.geodesicAreas([f],"square-meters")[0]}else{o=i.SpatialReference.WGS84;var v=d.project(p,o),_=d.project(u,o);if(y=m.geodesicDensify(v,1e5),f=m.geodesicDensify(_,1e5),!(f=h.simplify(f)))return null;l=m.geodesicLengths([v],"meters")[0],c=m.geodesicAreas([f],"square-meters")[0],y=d.project(y,t),f=d.project(f,t)}else if(t.isWebMercator){if(y=h.geodesicDensify(p,1e5,"meters"),f=h.geodesicDensify(u,1e5,"meters"),!(f=h.simplify(f)))return null;l=h.geodesicLength(p,"meters"),c=h.geodesicArea(f,"square-meters")}else{var g;if((g=h.planarLength(p,"meters"))>=r){o=i.SpatialReference.WGS84,v=d.project(p,o),_=d.project(u,o);if(y=m.geodesicDensify(v,1e5),f=m.geodesicDensify(_,1e5),!(f=h.simplify(f)))return null;l=m.geodesicLengths([v],"meters")[0],c=m.geodesicAreas([f],"square-meters")[0],y=d.project(y,t),f=d.project(f,t)}else{if(y=p,!(f=h.simplify(u)))return null;l=g,c=h.planarArea(f,"square-meters")}}return{measurement:{geometry:f,area:c,perimeter:l},fillGeometry:f,outlineGeometry:y}}function S(e){if(!e)return!1;var t=e.isGeographic,r=e.isWebMercator,i=e.isWGS84;return t&&!i&&!m.isSupported(e)||!t&&!r}function A(e,t,r){if(!t||!e)return null;var i={area:null,perimeter:null},s=t.area,a=t.perimeter;switch(r){case"metric":i.area=l.formatMetricArea(e,s,"square-meters");break;case"imperial":i.area=l.formatImperialArea(e,s,"square-meters");break;default:var o=c.convertUnit(s,"square-meters",r);i.area=l.formatDecimal(e,o,r)}var n=function(e){switch(e){case"metric":return"metric";case"imperial":return"imperial";case"square-inches":return"inches";case"square-feet":return"feet";case"square-yards":return"yards";case"square-miles":return"miles";case"square-us-feet":return"us-feet";case"square-meters":return"meters";case"square-kilometers":return"kilometers";case"acres":return"imperial";case"ares":case"hectares":return"metric";case"square-millimeters":return"millimeters";case"square-centimeters":return"centimeters";case"square-decimeters":return"decimeters";default:return null}}(r);if(n)switch(n){case"metric":i.perimeter=l.formatMetricLength(e,a,"meters");break;case"imperial":i.perimeter=l.formatImperialLength(e,a,"meters");break;default:var p=c.convertUnit(a,"meters",n);i.perimeter=l.formatDecimal(e,p,n)}else i.perimeter="";return i}t.createAreaMeasurementInfo2D=b,t.isSupported=function(e){return null!=e&&(!S(e)||d.isSupported())},t.createAreaMeasurementLabel=A,t.default=L}));