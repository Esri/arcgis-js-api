/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/has","../../core/Logger","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/subclass","../../core/urlUtils","../../core/uuid","../../portal/support/resourceExtension","../../geometry/SpatialReference","../../geometry/Point","../../geometry/Polygon","../../geometry/Polyline","../../geometry","../../intl/locale","../../symbols/SimpleLineSymbol","../../symbols/Font","../../intl/messages","../../intl","../../symbols/SimpleFillSymbol","../../symbols/SimpleMarkerSymbol","../../symbols/TextSymbol","../../symbols","../../Graphic","../../core/Handles","../../core/watchUtils","../../core/unitUtils","../../geometry/projection","../../core/unitFormatUtils","../../geometry/support/geodesicUtils","../../geometry/geometryEngine","../../layers/GraphicsLayer","../../layers/GroupLayer","../../views/interactive/dragEventPipeline","../../views/interactive/InteractiveToolBase","../../views/draw/Draw","../../views/interactive/GraphicManipulator"],(function(e,t,r,s,i,a,o,n,c,l,u,p,h,m,d,y,f,_,g,v,w,L,b,S,A,D,G,k,M,q,j,x,I,W,C,R,T,U,E){"use strict";const P=1e5;let B=function(e){function r(){var t;return(t=e.apply(this,arguments)||this)._drawActive=!1,t._handles=new G,t._graphicsLayer=new W,t._manipulatorLayer=new W,t._groupLayer=new C({layers:[t._graphicsLayer,t._manipulatorLayer],listMode:"hide",visible:!1}),t._vertices=[],t.deferCreation=!0,t.geodesicDistanceThreshold=1e5,t.measurement=null,t.measurementLabel=null,t}t._inheritsLoose(r,e);var s=r.prototype;return s.initialize=function(){v.fetchMessageBundle("esri/core/t9n/Units").then((e=>{this.messages=e})),this._handles.add(f.onLocaleChange((async()=>{this.messages=await v.fetchMessageBundle("esri/core/t9n/Units")})))},s.destroy=function(){this.detach(),this._draw&&(this._draw.destroy(),this._draw=null),this._handles&&(this._handles.destroy(),this._handles=null),this._graphicsLayer&&(this._graphicsLayer.destroy(),this._graphicsLayer=null),this._manipulatorLayer&&(this._manipulatorLayer.destroy(),this._manipulatorLayer=null)},s.activate=function(){this._drawActive||0!==this._vertices.length||this._startSketch()},s.onAttach=function(){const e=this.view;this._draw=new U({view:e}),e.map.add(this._groupLayer),e.focus(),this._handles.add([k.init(this,["unit","geodesicDistanceThreshold","palette","messages"],(()=>{this._vertices.length>0&&this._updateGraphics()})),k.init(this,"view.spatialReference",(e=>{H(e)&&!q.isLoaded()&&q.load()}))]),this.create()},s.onDetach=function(){const{map:e}=this.view;this._draw.view=null,this._draw.destroy(),this._draw=null,e.remove(this._groupLayer),this._handles.removeAll(),this._graphicsLayer.removeAll(),this._manipulatorLayer.removeAll(),this._set("measurement",null),this._set("measurementLabel",null)},s.onShow=function(){this._groupLayer.visible=!0},s.onHide=function(){this._groupLayer.visible=!1},s.reset=function(){this._vertices=[],this._graphicsLayer.removeAll(),this._set("measurement",null),this._set("measurementLabel",null),this._draw.reset(),this._drawActive=!1,this._updateSketch([])},s.onInputEvent=function(e){"pointer-move"===e.type&&this._updateCursor()},s._startSketch=function(){this._drawActive=!0;const e=this._draw.create("polyline",{mode:"click"});e.on(["vertex-add","vertex-update","vertex-remove","cursor-update","undo","redo"],(e=>this._updateSketch(e.vertices))),e.on("draw-complete",(()=>this._stopSketch()))},s._stopSketch=function(){if(this._vertices.length<3)return this.reset(),void this._startSketch();this.manipulators.forEach((e=>{e.manipulator.interactive=!0})),this._drawActive=!1,this.complete()},s._updateSketch=function(e){if(H(this.view.spatialReference)&&!q.isLoaded())return;if(e.length<2)return this._vertices=[],this.manipulators.removeAll(),void this._graphicsLayer.removeAll();this.create();const t=this.view.spatialReference;for(;this._vertices.length>e.length;){const{manipulatorId:e}=this._vertices.pop();this.manipulators.remove(e)}for(let n=this._vertices.length;n<e.length;n++){const[r,s]=e[n],i=z(new h({x:r,y:s,spatialReference:t}),this.view,this._manipulatorLayer,this.palette),a=this.manipulators.add(i);R.createManipulatorDragEventPipeline(i,((e,t)=>{t.next(R.screenToMap(this.view)).next(R.dragGraphic(e.graphic)).next((()=>{const t=e.graphic.geometry;this._vertices[n].coord=[t.x,t.y],this._updateGraphics()}))})),this._vertices.push({manipulatorId:a,coord:[r,s]})}const r=this._vertices.length-1,s=this._vertices[r],[i,a]=e[r];if(s.coord[0]!==i||s.coord[1]!==a){s.coord=[i,a];const e=new h({x:i,y:a,spatialReference:t});this.manipulators.findById(s.manipulatorId).graphic.geometry=e}const o=this._drawActive?this._vertices[r].manipulatorId:null;this.manipulators.forEach((e=>{e.manipulator.interactive=null==o||e.id!==o})),this._updateGraphics()},s._updateCursor=function(){this.cursor=this._drawActive?"crosshair":null},s._updateGraphics=function(){this._graphicsLayer.removeAll();const e=O(this._vertices.map((e=>e.coord)),this.view.spatialReference,this.geodesicDistanceThreshold);if(!e)return;const{measurement:t,fillGeometry:r,outlineGeometry:s}=e;this._set("measurement",t);const i=t?N(this.messages,t,this.unit):null;if(this._set("measurementLabel",i),!r&&!s)return;const{fillColor:a,pathColor:o,pathWidth:n}=this.palette,c=[];r&&c.push(new D({geometry:r,symbol:new L({color:a,outline:new _({width:0})})})),s&&c.push(new D({geometry:s,symbol:new _({color:o,width:n})})),r&&i&&c.push(new D({geometry:r.centroid,symbol:new S({color:[255,255,255,1],font:new g({size:14,family:"sans-serif"}),haloColor:[0,0,0,.5],haloSize:2,text:i.area})})),this._graphicsLayer.addMany(c)},t._createClass(r,[{key:"editable",set:function(e){this._set("editable",e),e||this._draw.reset()}}]),r}(T.InteractiveToolBase);function z(e,t,r,s){const i=new b({style:"circle",color:s.handleColor,size:s.handleWidth,outline:{type:"simple-line",width:0}}),a=new b({style:"circle",color:s.handleColor,size:1.5*s.handleWidth,outline:{type:"simple-line",width:0}}),o=new D({geometry:e,symbol:i});return new E.GraphicManipulator({view:t,layer:r,graphic:o,focusedSymbol:a})}function O(e,t,r){if(2===e.length){const s=new d({paths:e,spatialReference:t});let i;if(t.isGeographic)if(x.isSupported(t))i=x.geodesicDensify(s,P);else{const e=q.project(s,p.WGS84),r=x.geodesicDensify(e,P);i=q.project(r,t)}else if(t.isWebMercator)i=I.geodesicDensify(s,P,"meters");else{if(I.planarLength(s,"meters")>=r){const e=q.project(s,p.WGS84),r=x.geodesicDensify(e,P);i=q.project(r,t)}else i=s}return{measurement:null,fillGeometry:null,outlineGeometry:i}}e.push(e[0]);const s=new d({paths:[e],spatialReference:t}),i=new m({rings:[e],spatialReference:t});let a,o,n=null,c=null;if(t.isGeographic)if(x.isSupported(t)){if(n=x.geodesicDensify(s,P),c=x.geodesicDensify(i,P),c=I.simplify(c),!c)return null;a=x.geodesicLengths([s],"meters")[0],o=x.geodesicAreas([c],"square-meters")[0]}else{const e=p.WGS84,r=q.project(s,e),l=q.project(i,e);if(n=x.geodesicDensify(r,P),c=x.geodesicDensify(l,P),c=I.simplify(c),!c)return null;a=x.geodesicLengths([r],"meters")[0],o=x.geodesicAreas([c],"square-meters")[0],n=q.project(n,t),c=q.project(c,t)}else if(t.isWebMercator){if(n=I.geodesicDensify(s,P,"meters"),c=I.geodesicDensify(i,P,"meters"),c=I.simplify(c),!c)return null;a=I.geodesicLength(s,"meters"),o=I.geodesicArea(c,"square-meters")}else{const e=I.planarLength(s,"meters");if(e>=r){const e=p.WGS84,r=q.project(s,e),l=q.project(i,e);if(n=x.geodesicDensify(r,P),c=x.geodesicDensify(l,P),c=I.simplify(c),!c)return null;a=x.geodesicLengths([r],"meters")[0],o=x.geodesicAreas([c],"square-meters")[0],n=q.project(n,t),c=q.project(c,t)}else{if(n=s,c=I.simplify(i),!c)return null;a=e,o=I.planarArea(c,"square-meters")}}return{measurement:{geometry:c,area:o,perimeter:a},fillGeometry:c,outlineGeometry:n}}function F(e){return null!=e&&(!H(e)||q.isSupported())}function H(e){if(!e)return!1;const{isGeographic:t,isWebMercator:r,isWGS84:s}=e;return t&&!s&&!x.isSupported(e)||!t&&!r}function N(e,t,r){if(!t||!e)return null;const s={area:null,perimeter:null},{area:i,perimeter:a}=t;switch(r){case"metric":s.area=j.formatMetricArea(e,i,"square-meters");break;case"imperial":s.area=j.formatImperialArea(e,i,"square-meters");break;default:{const t=M.convertUnit(i,"square-meters",r);s.area=j.formatDecimal(e,t,r);break}}const o=J(r);if(o)switch(o){case"metric":s.perimeter=j.formatMetricLength(e,a,"meters");break;case"imperial":s.perimeter=j.formatImperialLength(e,a,"meters");break;default:{const t=M.convertUnit(a,"meters",o);s.perimeter=j.formatDecimal(e,t,o);break}}else s.perimeter="";return s}function J(e){switch(e){case"metric":return"metric";case"imperial":return"imperial";case"square-inches":return"inches";case"square-feet":return"feet";case"square-yards":return"yards";case"square-miles":return"miles";case"square-us-feet":return"us-feet";case"square-meters":return"meters";case"square-kilometers":return"kilometers";case"acres":return"imperial";case"ares":case"hectares":return"metric";case"square-millimeters":return"millimeters";case"square-centimeters":return"centimeters";case"square-decimeters":return"decimeters";default:return null}}r.__decorate([o.property()],B.prototype,"cursor",void 0),r.__decorate([o.property({value:!0})],B.prototype,"editable",null),r.__decorate([o.property({type:Number})],B.prototype,"geodesicDistanceThreshold",void 0),r.__decorate([o.property({readOnly:!0})],B.prototype,"measurement",void 0),r.__decorate([o.property({readOnly:!0})],B.prototype,"measurementLabel",void 0),r.__decorate([o.property()],B.prototype,"messages",void 0),r.__decorate([o.property()],B.prototype,"palette",void 0),r.__decorate([o.property()],B.prototype,"unit",void 0),r.__decorate([o.property({constructOnly:!0})],B.prototype,"view",void 0),B=r.__decorate([n.subclass("esri.widgets.AreaMeasurement2D.AreaMeasurement2DTool")],B);var K=B;e.createAreaMeasurementInfo2D=O,e.createAreaMeasurementLabel=N,e.default=K,e.isSupported=F,Object.defineProperty(e,"__esModule",{value:!0})}));
