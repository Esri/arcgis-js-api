// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../core/Error","../core/unitFormatUtils","../core/watchUtils","../core/accessorSupport/decorators","./Widget","./Attachments/AttachmentsViewModel","./Attachments/support/attachmentUtils","./support/widget"],(function(t,e,s,i,a,n,r,o,l,d,c){"use strict";var h={addButton:!0,addSubmitButton:!0,cancelAddButton:!0,cancelUpdateButton:!0,deleteButton:!0,errorMessage:!0,progressBar:!0,updateButton:!0},m="esri-attachments",u="esri-attachments__loader-container",p="esri-attachments__loader",_="esri-attachments__container",b="esri-attachments__container--list",g="esri-attachments__container--preview",v="esri-attachments__actions",f="esri-attachments__delete-button",y="esri-attachments__add-attachment-button",w="esri-attachments__error-message",x="esri-attachments__items",A="esri-attachments__item",M="esri-attachments__item-button",k="esri-attachments__item-mask",F="esri-attachments__item-mask--icon",I="esri-attachments__image",E="esri-attachments__image--resizable",B="esri-attachments__label",z="esri-attachments__filename",C="esri-attachments__item-chevron-icon",S="esri-attachments__item-link",T="esri-attachments__item-link-overlay",U="esri-attachments__item-link-overlay-icon",D="esri-attachments__item-add-icon",O="esri-attachments__form-node",L="esri-attachments__file-fieldset",R="esri-attachments__file-label",V="esri-attachments__file-name",N="esri-attachments__file-input",H="esri-attachments__metadata",P="esri-attachments__metadata-fieldset",j="esri-attachments__progress-bar",q="esri-widget",W="esri-button",X="esri-button--disabled",G="esri-button--secondary",J="esri-button--tertiary",K="esri-button--third",Q="esri-button--small",Y="esri-button--half",Z="esri-widget__content--empty",$="esri-icon-right",tt="esri-icon-left",et="esri-icon-plus",st=window.CSS;return function(t){function e(e,i){var a=t.call(this,e,i)||this;return a.abilities=null,a.displayType="list",a.graphic=null,a.label=void 0,a.messages=null,a.messagesUnits=null,a.selectedFile=null,a.submitting=!1,a.viewModel=new l,a.visibleElements=s.__assign({},h),a._supportsImageOrientation=st&&st.supports&&st.supports("image-orientation","from-image"),a._addAttachmentForm=null,a._updateAttachmentForm=null,a}return s.__extends(e,t),e.prototype.initialize=function(){var t=this;this.own(n.on(this,"viewModel.attachmentInfos","change",(function(){return t.scheduleRender()})),n.init(this,"viewModel.mode",(function(){return t._modeChanged()})))},e.prototype.castVisibleElements=function(t){return s.__assign(s.__assign({},h),t)},e.prototype.addAttachment=function(){var t=this,e=this._addAttachmentForm,s=this.viewModel;return this._set("submitting",!0),this._set("error",null),s.addAttachment(e).then((function(e){return t._set("submitting",!1),t._set("error",null),s.mode="view",e})).catch((function(e){throw t._set("submitting",!1),t._set("error",new i("attachments:add-attachment",t.messages.addErrorMessage,e)),e}))},e.prototype.deleteAttachment=function(t){var e=this,s=this.viewModel;return this._set("submitting",!0),this._set("error",null),s.deleteAttachment(t).then((function(t){return e._set("submitting",!1),e._set("error",null),s.mode="view",t})).catch((function(t){throw e._set("submitting",!1),e._set("error",new i("attachments:delete-attachment",e.messages.deleteErrorMessage,t)),t}))},e.prototype.updateAttachment=function(){var t=this,e=this.viewModel,s=this._updateAttachmentForm;return this._set("submitting",!0),this._set("error",null),e.updateAttachment(s).then((function(s){return t._set("submitting",!1),t._set("error",null),e.mode="view",s})).catch((function(e){throw t._set("submitting",!1),t._set("error",new i("attachments:update-attachment",t.messages.updateErrorMessage,e)),e}))},e.prototype.render=function(){var t=this.submitting,e=this.viewModel.state;return c.tsx("div",{class:this.classes(m,q)},t?this.renderProgressBar():null,"loading"===e?this.renderLoading():this.renderAttachments(),this.renderErrorMessage())},e.prototype.renderErrorMessage=function(){var t=this.error,e=this.visibleElements;return t&&e.errorMessage?c.tsx("div",{key:"error-message",class:w},t.message):null},e.prototype.renderAttachments=function(){var t=this.viewModel,e=t.mode,s=t.activeAttachmentInfo;return"add"===e?this.renderAddForm():"edit"===e?this.renderDetailsForm(s):this.renderAttachmentContainer()},e.prototype.renderLoading=function(){return c.tsx("div",{class:u,key:"loader"},c.tsx("div",{class:p}))},e.prototype.renderProgressBar=function(){return this.visibleElements.progressBar?c.tsx("div",{class:j,key:"progress-bar"}):null},e.prototype.renderAddForm=function(){var t,e=this.submitting,s=this.selectedFile,i=e||!s,a=this.visibleElements.cancelAddButton?c.tsx("button",{type:"button",bind:this,disabled:e,onclick:this._cancelForm,class:this.classes(W,J,Q,Y,e&&X)},this.messages.cancel):null,n=this.visibleElements.addSubmitButton?c.tsx("button",{type:"submit",disabled:i,class:this.classes(W,G,Q,Y,(t={},t[X]=i,t))},this.messages.add):null,r=s?c.tsx("span",{key:"file-name",class:V},s.name):null,o=c.tsx("form",{bind:this,afterCreate:c.storeNode,afterRemoved:c.discardNode,"data-node-ref":"_addAttachmentForm",onsubmit:this._submitAddAttachment},c.tsx("fieldset",{class:L},r,c.tsx("label",{class:this.classes(R,W,G)},s?this.messages.changeFile:this.messages.selectFile,c.tsx("input",{class:N,type:"file",name:"attachment",bind:this,onchange:this._handleFileInputChange}))),n,a);return c.tsx("div",{key:"add-form-container",class:O},o)},e.prototype.renderDetailsForm=function(t){var e,s,i,n=this,r=this.visibleElements,o=this.viewModel,l=this.selectedFile,d=this.submitting,h=t.contentType,m=t.size,u=t.url,p=o.abilities,_=d||!l,b=p.editing&&p.operations.delete&&r.deleteButton?c.tsx("button",{key:"delete-button",type:"button",disabled:d,bind:this,onclick:function(e){return n._submitDeleteAttachment(e,t)},class:this.classes(W,Q,J,f,(e={},e[X]=d,e))},this.messages.delete):null,g=p.editing&&p.operations.update&&r.updateButton?c.tsx("button",{disabled:_,key:"update-button",type:"submit",class:this.classes(W,Q,K,(s={},s[X]=_,s))},this.messages.update):null,y=this.visibleElements.cancelUpdateButton?c.tsx("button",{disabled:d,key:"cancel-button",type:"button",bind:this,onclick:this._cancelForm,class:this.classes(W,Q,J,K,(i={},i[X]=d,i))},this.messages.cancel):null,w=l?c.tsx("span",{key:"file-name",class:V},l.name):null,x=p.editing&&p.operations.update?c.tsx("fieldset",{key:"file",class:L},w,c.tsx("label",{class:this.classes(R,W,G)},this.messages.changeFile,c.tsx("input",{class:N,type:"file",name:"attachment",bind:this,onchange:this._handleFileInputChange}))):null,A=c.tsx("fieldset",{key:"size",class:P},c.tsx("label",null,a.formatFileSize(this.messagesUnits,m))),M=c.tsx("fieldset",{key:"content-type",class:P},c.tsx("label",null,h)),k=c.tsx("form",{bind:this,afterCreate:c.storeNode,afterRemoved:c.discardNode,"data-node-ref":"_updateAttachmentForm",onsubmit:this._submitUpdateAttachment},c.tsx("div",{class:H},A,M),x,c.tsx("div",{class:v},b,y,g));return c.tsx("div",{key:"edit-form-container",class:O},c.tsx("a",{class:S,href:u,rel:"noreferrer",target:"_blank",alt:name},this.renderImageMask({attachmentInfo:t,size:400}),c.tsx("div",{class:T},c.tsx("span",{class:U},c.tsx("svg",{xmlns:"http://www.w3.org/2000/svg",width:"32",height:"32",viewBox:"0 0 32 32"},c.tsx("path",{d:"M28 13h1v16H3V3h16v1H4v24h24zm-5-9h4.293L15.646 15.638l.707.707L28 4.707V9h1V3h-6z"}),c.tsx("path",{fill:"none",d:"M0 0h32v32H0z"}))))),k)},e.prototype.renderImageMask=function(t){var e,s,i=t.attachmentInfo,a=t.size,n=this.viewModel.supportsResizeAttachments,r=i.contentType,o=i.url,l=n&&d.isSupportedImage(r),h=this._getCSSTransform(i,l),m=h?{transform:h,"image-orientation":"none"}:{},u=-1===o.indexOf("?")?"?":"&",p=l?""+o+u+"w="+a:d.getIconPath(r),_=((e={})[F]=!l,e),b=((s={})[E]=n,s);return c.tsx("div",{class:this.classes(_,k)},c.tsx("img",{styles:m,alt:"",src:p,class:this.classes(b,I)}))},e.prototype.renderAttachmentInfo=function(t){var e=this,s=t.attachmentInfo,i=t.displayType,a=this.viewModel.abilities,n=s.name,r=s.url,o=this.renderImageMask({attachmentInfo:s,size:"list"===i?48:400}),l=a.editing?c.tsx("span",{"aria-hidden":"true",class:this.classes(C,c.isRTL()?tt:$)}):null,d=[o,c.tsx("label",{class:B},c.tsx("span",{class:z},n||this.messages.noTitle),l)],h=a.editing?c.tsx("button",{key:"details-button",bind:this,class:M,title:this.messages.attachmentDetails,"aria-label":this.messages.attachmentDetails,"data-attachment-info-id":s.id,onclick:function(){return e._startEditAttachment(s)},type:"button"},d):c.tsx("a",{key:"details-link",class:M,href:r,target:"_blank"},d);return c.tsx("li",{class:A,key:s},h)},e.prototype.renderAttachmentContainer=function(){var t,e=this,s=this.displayType,i=this.viewModel,a=this.visibleElements,n=i.attachmentInfos,r=i.abilities,o=n&&n.length,l=((t={})[b]="preview"!==s,t[g]="preview"===s,t),d=r.editing&&r.operations.add&&a.addButton?c.tsx("button",{bind:this,onclick:function(){return e._startAddAttachment()},class:this.classes(W,J,y),type:"button"},c.tsx("span",{"aria-hidden":"true",class:this.classes(D,et)}),this.messages.add):null,h=o?c.tsx("ul",{class:x},n.toArray().map((function(t){return e.renderAttachmentInfo({attachmentInfo:t,displayType:s})}))):c.tsx("div",{class:Z},this.messages.noAttachments);return c.tsx("div",{key:"attachments-container",class:this.classes(_,l)},h,d)},e.prototype._modeChanged=function(){this._set("error",null),this._set("selectedFile",null)},e.prototype._handleFileInputChange=function(t){var e=t.target,s=e&&e.files&&e.files.item(0);this._set("selectedFile",s)},e.prototype._submitDeleteAttachment=function(t,e){t.preventDefault(),this.deleteAttachment(e)},e.prototype._submitAddAttachment=function(t){t.preventDefault(),this.addAttachment()},e.prototype._submitUpdateAttachment=function(t){t.preventDefault(),this.updateAttachment()},e.prototype._startEditAttachment=function(t){var e=this.viewModel;e.activeAttachmentInfo=t,e.mode="edit"},e.prototype._startAddAttachment=function(){this.viewModel.mode="add"},e.prototype._cancelForm=function(t){t.preventDefault(),this.viewModel.mode="view"},e.prototype._getCSSTransform=function(t,e){var s=t.orientationInfo;return!this._supportsImageOrientation&&e&&s?[s.rotation?"rotate("+s.rotation+"deg)":"",s.mirrored?"scaleX(-1)":""].join(" "):""},s.__decorate([r.aliasOf("viewModel.abilities")],e.prototype,"abilities",void 0),s.__decorate([r.property(),c.renderable()],e.prototype,"displayType",void 0),s.__decorate([r.aliasOf("viewModel.graphic")],e.prototype,"graphic",void 0),s.__decorate([r.property({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],e.prototype,"label",void 0),s.__decorate([r.property(),c.renderable(),c.messageBundle("esri/widgets/Attachments/t9n/Attachments")],e.prototype,"messages",void 0),s.__decorate([r.property(),c.renderable(),c.messageBundle("esri/core/t9n/Units")],e.prototype,"messagesUnits",void 0),s.__decorate([r.property({readOnly:!0})],e.prototype,"selectedFile",void 0),s.__decorate([c.renderable(),r.property({readOnly:!0})],e.prototype,"submitting",void 0),s.__decorate([c.renderable(),r.property({readOnly:!0})],e.prototype,"error",void 0),s.__decorate([r.property({type:l}),c.renderable(["viewModel.activeAttachmentInfo","viewModel.mode","viewModel.state","viewModel.supportsResizeAttachments","viewModel.attachmentInfos","viewModel.graphic","viewModel.abilities","viewModel.abilities.editing","viewModel.abilities.operations"])],e.prototype,"viewModel",void 0),s.__decorate([r.property(),c.renderable()],e.prototype,"visibleElements",void 0),s.__decorate([r.cast("visibleElements")],e.prototype,"castVisibleElements",null),e=s.__decorate([r.subclass("esri.widgets.Attachments")],e)}(o)}));