/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["require","../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/Error","../core/maybe","../core/reactiveUtils","../core/unitFormatUtils","../core/accessorSupport/decorators/property","../core/arrayUtils","../core/accessorSupport/decorators/cast","../core/accessorSupport/decorators/subclass","./Widget","./Attachments/AttachmentsViewModel","./Attachments/support/attachmentUtils","./support/widgetUtils","./support/decorators/messageBundle","./support/jsxFactory"],(function(t,e,s,i,n,a,r,o,l,c,d,m,h,u,p,_,f){"use strict";const g={addButton:!0,addSubmitButton:!0,cancelAddButton:!0,cancelUpdateButton:!0,deleteButton:!0,errorMessage:!0,progressBar:!0,updateButton:!0},b={base:"esri-attachments",loaderContainer:"esri-attachments__loader-container",loader:"esri-attachments__loader",fadeIn:"esri-attachments--fade-in",container:"esri-attachments__container",containerList:"esri-attachments__container--list",containerPreview:"esri-attachments__container--preview",actions:"esri-attachments__actions",deleteButton:"esri-attachments__delete-button",addAttachmentButton:"esri-attachments__add-attachment-button",errorMessage:"esri-attachments__error-message",items:"esri-attachments__items",item:"esri-attachments__item",itemButton:"esri-attachments__item-button",itemMask:"esri-attachments__item-mask",itemMaskIcon:"esri-attachments__item-mask--icon",itemImage:"esri-attachments__image",itemImageResizable:"esri-attachments__image--resizable",itemLabel:"esri-attachments__label",itemFilename:"esri-attachments__filename",itemChevronIcon:"esri-attachments__item-chevron-icon",itemLink:"esri-attachments__item-link",itemLinkOverlay:"esri-attachments__item-link-overlay",itemLinkOverlayIcon:"esri-attachments__item-link-overlay-icon",itemEditIcon:"esri-attachments__item-edit-icon",itemAddIcon:"esri-attachments__item-add-icon",itemAddButton:"esri-attachments__item-add-button",formNode:"esri-attachments__form-node",fileFieldset:"esri-attachments__file-fieldset",fileLabel:"esri-attachments__file-label",fileName:"esri-attachments__file-name",fileInput:"esri-attachments__file-input",metadata:"esri-attachments__metadata",metadataFieldset:"esri-attachments__metadata-fieldset",progressBar:"esri-attachments__progress-bar",esriWidget:"esri-widget",esriButton:"esri-button",buttonDisabled:"esri-button--disabled",esriButtonSecondary:"esri-button--secondary",esriButtonTertiary:"esri-button--tertiary",esriButtonThird:"esri-button--third",esriButtonSmall:"esri-button--small",esriButtonHalf:"esri-button--half",empty:"esri-widget__content--empty",iconExternalLink:"esri-icon-link-external",iconEdit:"esri-icon-edit",iconRight:"esri-icon-right",iconLeft:"esri-icon-left",iconPlus:"esri-icon-plus"},y=window.CSS;let v=function(s){function o(t,e){var i;return(i=s.call(this,t,e)||this).displayType="auto",i.messages=null,i.messagesUnits=null,i.selectedFile=null,i.submitting=!1,i.viewModel=new h,i.visibleElements={...g},i._supportsImageOrientation=y&&y.supports&&y.supports("image-orientation","from-image"),i._addAttachmentForm=null,i._updateAttachmentForm=null,i}e._inheritsLoose(o,s);var l=o.prototype;return l.initialize=function(){this.addHandles([a.on((()=>this.viewModel?.attachmentInfos),"change",(()=>this.scheduleRender())),a.on((()=>this.viewModel?.fileInfos),"change",(()=>this.scheduleRender())),a.watch((()=>this.viewModel?.mode),(()=>this._modeChanged()),a.initial)])},l.loadDependencies=function(){return Promise.all([new Promise(((e,s)=>t(["../chunks/calcite-icon"],e,s)))])},l.castVisibleElements=function(t){return{...g,...t}},l.addAttachment=function(){const{_addAttachmentForm:t,viewModel:e}=this;return this._set("submitting",!0),this._set("error",null),e.addAttachment(t).then((t=>(this._set("submitting",!1),this._set("error",null),e.mode="view",t))).catch((t=>{throw this._set("submitting",!1),this._set("error",new i("attachments:add-attachment",this.messages.addErrorMessage,t)),t}))},l.deleteAttachment=function(t){const{viewModel:e}=this;return this._set("submitting",!0),this._set("error",null),e.deleteAttachment(t).then((t=>(this._set("submitting",!1),this._set("error",null),e.mode="view",t))).catch((t=>{throw this._set("submitting",!1),this._set("error",new i("attachments:delete-attachment",this.messages.deleteErrorMessage,t)),t}))},l.updateAttachment=function(){const{viewModel:t}=this,{_updateAttachmentForm:e}=this;return this._set("submitting",!0),this._set("error",null),t.updateAttachment(e).then((e=>(this._set("submitting",!1),this._set("error",null),t.mode="view",e))).catch((t=>{throw this._set("submitting",!1),this._set("error",new i("attachments:update-attachment",this.messages.updateErrorMessage,t)),t}))},l.addFile=function(){const t=this.viewModel.addFile(this.selectedFile,this._addAttachmentForm);return this.viewModel.mode="view",t},l.updateFile=function(){const{viewModel:t}=this,e=t.updateFile(this.selectedFile,this._updateAttachmentForm,t.activeFileInfo);return t.mode="view",e},l.deleteFile=function(t){const e=this.viewModel.deleteFile(t||this.viewModel.activeFileInfo.file);return this.viewModel.mode="view",e},l.render=function(){const{submitting:t,viewModel:e}=this,{state:s}=e;return f.tsx("div",{class:this.classes(b.base,b.esriWidget)},t?this.renderProgressBar():null,"loading"===s?this.renderLoading():this.renderAttachments(),this.renderErrorMessage())},l.renderErrorMessage=function(){const{error:t,visibleElements:e}=this;return t&&e.errorMessage?f.tsx("div",{key:"error-message",class:b.errorMessage},t.message):null},l.renderAttachments=function(){const{activeFileInfo:t,mode:e,activeAttachmentInfo:s}=this.viewModel;return"add"===e?this.renderAddForm():"edit"===e?this.renderDetailsForm(s||t):this.renderAttachmentContainer()},l.renderLoading=function(){return f.tsx("div",{class:b.loaderContainer,key:"loader"},f.tsx("div",{class:b.loader}))},l.renderProgressBar=function(){return this.visibleElements.progressBar?f.tsx("div",{class:b.progressBar,key:"progress-bar"}):null},l.renderAddForm=function(){const{submitting:t,selectedFile:e}=this,s=t||!e,i=this.visibleElements.cancelAddButton?f.tsx("button",{type:"button",bind:this,disabled:t,onclick:this._cancelForm,class:this.classes(b.esriButton,b.esriButtonTertiary,b.esriButtonSmall,b.esriButtonHalf,t&&b.buttonDisabled)},this.messages.cancel):null,n=this.visibleElements.addSubmitButton?f.tsx("button",{type:"submit",disabled:s,class:this.classes(b.esriButton,b.esriButtonSecondary,b.esriButtonSmall,b.esriButtonHalf,{[b.buttonDisabled]:s})},this.messages.add):null,a=e?f.tsx("span",{key:"file-name",class:b.fileName},e.name):null,r=f.tsx("form",{bind:this,afterCreate:p.storeNode,afterRemoved:p.discardNode,"data-node-ref":"_addAttachmentForm",onsubmit:this._submitAddAttachment},f.tsx("fieldset",{class:b.fileFieldset},a,f.tsx("label",{class:this.classes(b.fileLabel,b.esriButton,b.esriButtonSecondary)},e?this.messages.changeFile:this.messages.selectFile,f.tsx("input",{class:b.fileInput,type:"file",name:"attachment",bind:this,onchange:this._handleFileInputChange}))),n,i);return f.tsx("div",{key:"add-form-container",class:b.formNode},r)},l.renderDetailsForm=function(t){const{visibleElements:e,viewModel:s,selectedFile:i,submitting:a}=this,{abilities:o}=s,l=a||!i;let c,d,m,h;i?(c=i.type,d=i.name,m=i.size):"file"in t?(c=t.file.type,d=t.file.name,m=t.file.size):(c=t.contentType,d=t.name,m=t.size,h=t.url);const u=o.editing&&o.operations.delete&&e.deleteButton?f.tsx("button",{key:"delete-button",type:"button",disabled:a,bind:this,onclick:e=>this._submitDeleteAttachment(e,t),class:this.classes(b.esriButton,b.esriButtonSmall,b.esriButtonTertiary,b.deleteButton,{[b.buttonDisabled]:a})},this.messages.delete):void 0,_=o.editing&&o.operations.update&&e.updateButton?f.tsx("button",{disabled:l,key:"update-button",type:"submit",class:this.classes(b.esriButton,b.esriButtonSmall,b.esriButtonThird,{[b.buttonDisabled]:l})},this.messages.update):void 0,g=this.visibleElements.cancelUpdateButton?f.tsx("button",{disabled:a,key:"cancel-button",type:"button",bind:this,onclick:this._cancelForm,class:this.classes(b.esriButton,b.esriButtonSmall,b.esriButtonTertiary,b.esriButtonThird,{[b.buttonDisabled]:a})},this.messages.cancel):void 0,y=o.editing&&o.operations.update?f.tsx("fieldset",{key:"file",class:b.fileFieldset},f.tsx("span",{key:"file-name",class:b.fileName},d),f.tsx("label",{class:this.classes(b.fileLabel,b.esriButton,b.esriButtonSecondary)},this.messages.changeFile,f.tsx("input",{class:b.fileInput,type:"file",name:"attachment",bind:this,onchange:this._handleFileInputChange}))):void 0,v=f.tsx("fieldset",{key:"size",class:b.metadataFieldset},f.tsx("label",null,r.formatFileSize(this.messagesUnits,m))),k=f.tsx("fieldset",{key:"content-type",class:b.metadataFieldset},f.tsx("label",null,c)),w=n.isSome(h)?f.tsx("a",{class:b.itemLink,href:h,rel:"noreferrer",target:"_blank"},this.renderImageMask(t,400),f.tsx("div",{class:b.itemLinkOverlay},f.tsx("span",{class:b.itemLinkOverlayIcon},f.tsx("calcite-icon",{icon:"launch"})))):this.renderImageMask(t,400),A=f.tsx("form",{bind:this,afterCreate:p.storeNode,afterRemoved:p.discardNode,"data-node-ref":"_updateAttachmentForm",onsubmit:e=>this._submitUpdateAttachment(e,t)},f.tsx("div",{class:b.metadata},v,k),y,f.tsx("div",{class:b.actions},u,g,_));return f.tsx("div",{key:"edit-form-container",class:b.formNode},w,A)},l.renderImageMask=function(t,e){return"file"in t?this.renderGenericImageMask(t.file.name,t.file.type):this.renderImageMaskForAttachment(t,e)},l.renderGenericImageMask=function(t,e){const{supportsResizeAttachments:s}=this.viewModel,i=u.getIconPath(e),n={[b.itemImageResizable]:s};return f.tsx("div",{class:this.classes(b.itemMaskIcon,b.itemMask)},f.tsx("img",{title:t,alt:t,src:i,class:this.classes(n,b.itemImage)}))},l.renderImageMaskForAttachment=function(t,e){const{supportsResizeAttachments:s}=this.viewModel,{contentType:i,name:n,url:a}=t;if(!s||!u.isSupportedImage(i))return this.renderGenericImageMask(n,i);const r=this._getCSSTransform(t),o=r?{transform:r,"image-orientation":"none"}:{},l=`${a}${a.includes("?")?"&":"?"}w=${e}`,c={[b.itemImageResizable]:s};return f.tsx("div",{class:this.classes(b.itemMask)},f.tsx("img",{styles:o,alt:n,title:n,src:l,class:this.classes(c,b.itemImage)}))},l.renderFile=function(t){const{file:e}=t;return f.tsx("li",{class:b.item,key:e},f.tsx("button",{key:"details-button",bind:this,class:b.itemButton,title:this.messages.attachmentDetails,"aria-label":this.messages.attachmentDetails,onclick:()=>this._startEditFile(t),type:"button"},this.renderImageMask(t),f.tsx("label",{class:b.itemLabel},f.tsx("span",{class:b.itemFilename},e.name||this.messages.noTitle),f.tsx("span",{"aria-hidden":"true",class:this.classes(b.itemChevronIcon,p.isRTL(this.container)?b.iconLeft:b.iconRight)}))))},l.renderAttachmentInfo=function({attachmentInfo:t,displayType:e}){const{viewModel:s,effectiveDisplayType:i}=this,{abilities:n,supportsResizeAttachments:a}=s,{contentType:r,name:o,url:l}=t,c=this.renderImageMask(t,"list"===e?48:400),d=n.editing?f.tsx("span",{"aria-hidden":"true",class:this.classes(b.itemChevronIcon,p.isRTL(this.container)?b.iconLeft:b.iconRight)}):null,m=[c,"preview"===i&&a&&u.isSupportedImage(r)?null:f.tsx("label",{class:b.itemLabel},f.tsx("span",{class:b.itemFilename},o||this.messages.noTitle),d)],h=n.editing?f.tsx("button",{key:"details-button",bind:this,class:b.itemButton,title:this.messages.attachmentDetails,"aria-label":this.messages.attachmentDetails,"data-attachment-info-id":t.id,onclick:()=>this._startEditAttachment(t),type:"button"},m):f.tsx("a",{key:"details-link",class:b.itemButton,href:l,target:"_blank"},m);return f.tsx("li",{class:b.item,key:t},h)},l.renderAttachmentContainer=function(){const{effectiveDisplayType:t,viewModel:e,visibleElements:s}=this,{attachmentInfos:i,abilities:n,fileInfos:a}=e,r=!!i?.length,o=!!a?.length,l={[b.containerList]:"preview"!==t,[b.containerPreview]:"preview"===t},c=n.editing&&n.operations.add&&s.addButton?f.tsx("button",{bind:this,onclick:()=>this._startAddAttachment(),class:this.classes(b.esriButton,b.esriButtonTertiary,b.addAttachmentButton),type:"button"},f.tsx("span",{"aria-hidden":"true",class:this.classes(b.itemAddIcon,b.iconPlus)}),this.messages.add):void 0,d=r?f.tsx("ul",{key:"attachments-list",class:b.items},i.toArray().map((e=>this.renderAttachmentInfo({attachmentInfo:e,displayType:t})))):void 0,m=o?f.tsx("ul",{key:"file-list",class:b.items},a.toArray().map((t=>this.renderFile(t)))):void 0,h=o||r?void 0:f.tsx("div",{class:b.empty},this.messages.noAttachments);return f.tsx("div",{key:"attachments-container",class:this.classes(b.container,l)},d,m,h,c)},l._modeChanged=function(){this._set("error",null),this._set("selectedFile",null)},l._handleFileInputChange=function(t){const e=t.target,s=e&&e.files&&e.files.item(0);this._set("selectedFile",s)},l._submitDeleteAttachment=function(t,e){t.preventDefault(),"file"in e?this.deleteFile(e.file):this.deleteAttachment(e)},l._submitAddAttachment=function(t){t.preventDefault(),this.viewModel.filesEnabled?this.addFile():this.addAttachment()},l._submitUpdateAttachment=function(t,e){t.preventDefault(),"file"in e?this.updateFile():this.updateAttachment()},l._startEditAttachment=function(t){const{viewModel:e}=this;e.activeFileInfo=null,e.activeAttachmentInfo=t,e.mode="edit"},l._startEditFile=function(t){const{viewModel:e}=this;e.activeAttachmentInfo=null,e.activeFileInfo=t,e.mode="edit"},l._startAddAttachment=function(){this.viewModel.mode="add"},l._cancelForm=function(t){t.preventDefault(),this.viewModel.mode="view"},l._getCSSTransform=function(t){const{orientationInfo:e}=t;return!this._supportsImageOrientation&&e?[e.rotation?`rotate(${e.rotation}deg)`:"",e.mirrored?"scaleX(-1)":""].join(" "):""},e._createClass(o,[{key:"abilities",get:function(){return this.viewModel.abilities},set:function(t){this.viewModel.abilities=t}},{key:"effectiveDisplayType",get:function(){const{displayType:t}=this;return t&&"auto"!==t?t:this.viewModel.supportsResizeAttachments?"preview":"list"}},{key:"graphic",get:function(){return this.viewModel.graphic},set:function(t){this.viewModel.graphic=t}},{key:"label",get:function(){return this.messages?.widgetLabel??""},set:function(t){this._overrideIfSome("label",t)}}]),o}(m);s.__decorate([o.property()],v.prototype,"abilities",null),s.__decorate([o.property()],v.prototype,"displayType",void 0),s.__decorate([o.property({readOnly:!0})],v.prototype,"effectiveDisplayType",null),s.__decorate([o.property()],v.prototype,"graphic",null),s.__decorate([o.property()],v.prototype,"label",null),s.__decorate([o.property(),_.messageBundle("esri/widgets/Attachments/t9n/Attachments")],v.prototype,"messages",void 0),s.__decorate([o.property(),_.messageBundle("esri/core/t9n/Units")],v.prototype,"messagesUnits",void 0),s.__decorate([o.property({readOnly:!0})],v.prototype,"selectedFile",void 0),s.__decorate([o.property({readOnly:!0})],v.prototype,"submitting",void 0),s.__decorate([o.property({readOnly:!0})],v.prototype,"error",void 0),s.__decorate([o.property({type:h})],v.prototype,"viewModel",void 0),s.__decorate([o.property()],v.prototype,"visibleElements",void 0),s.__decorate([c.cast("visibleElements")],v.prototype,"castVisibleElements",null),v=s.__decorate([d.subclass("esri.widgets.Attachments")],v);return v}));
