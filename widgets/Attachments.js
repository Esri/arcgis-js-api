/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["require","../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/Error","../core/maybe","../core/reactiveUtils","../core/unitFormatUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/cast","../core/arrayUtils","../core/accessorSupport/decorators/subclass","./Widget","./Attachments/AttachmentsViewModel","./Attachments/support/attachmentUtils","./support/widgetUtils","./support/decorators/messageBundle","./support/jsxFactory"],(function(e,t,s,i,n,a,r,o,l,d,c,m,u,h,p,_,f){"use strict";const g={addButton:!0,addSubmitButton:!0,cancelAddButton:!0,cancelUpdateButton:!0,deleteButton:!0,errorMessage:!0,progressBar:!0,updateButton:!0},b="esri-attachments",v="esri-button",y={base:b,loaderContainer:`${b}__loader-container`,loader:`${b}__loader`,fadeIn:`${b}--fade-in`,container:`${b}__container`,containerList:`${b}__container--list`,containerPreview:`${b}__container--preview`,actions:`${b}__actions`,deleteButton:`${b}__delete-button`,addAttachmentButton:`${b}__add-attachment-button`,errorMessage:`${b}__error-message`,items:`${b}__items`,item:`${b}__item`,itemButton:`${b}__item-button`,itemMask:`${b}__item-mask`,itemMaskIcon:`${b}__item-mask--icon`,itemImage:`${b}__image`,itemImageResizable:`${b}__image--resizable`,itemLabel:`${b}__label`,itemFilename:`${b}__filename`,itemChevronIcon:`${b}__item-chevron-icon`,itemLink:`${b}__item-link`,itemLinkOverlay:`${b}__item-link-overlay`,itemLinkOverlayIcon:`${b}__item-link-overlay-icon`,itemEditIcon:`${b}__item-edit-icon`,itemAddIcon:`${b}__item-add-icon`,itemAddButton:`${b}__item-add-button`,formNode:`${b}__form-node`,fileFieldset:`${b}__file-fieldset`,fileLabel:`${b}__file-label`,fileName:`${b}__file-name`,fileInput:`${b}__file-input`,metadata:`${b}__metadata`,metadataFieldset:`${b}__metadata-fieldset`,progressBar:`${b}__progress-bar`,esriWidget:"esri-widget",esriButton:v,buttonDisabled:`${v}--disabled`,esriButtonSecondary:`${v}--secondary`,esriButtonTertiary:`${v}--tertiary`,esriButtonThird:`${v}--third`,esriButtonSmall:`${v}--small`,esriButtonHalf:`${v}--half`,empty:"esri-widget__content--empty",iconExternalLink:"esri-icon-link-external",iconEdit:"esri-icon-edit",iconRight:"esri-icon-right",iconLeft:"esri-icon-left",iconPlus:"esri-icon-plus"},w=window.CSS;let k=function(s){function o(e,t){var i;return(i=s.call(this,e,t)||this).displayType="auto",i.messages=null,i.messagesUnits=null,i.selectedFile=null,i.submitting=!1,i.viewModel=null,i.visibleElements={...g},i._supportsImageOrientation=w&&w.supports&&w.supports("image-orientation","from-image"),i._addAttachmentForm=null,i._updateAttachmentForm=null,i}t._inheritsLoose(o,s);var l=o.prototype;return l.initialize=function(){this.viewModel||(this.viewModel=new u),this.addHandles([a.on((()=>this.viewModel?.attachmentInfos),"change",(()=>this.scheduleRender())),a.on((()=>this.viewModel?.fileInfos),"change",(()=>this.scheduleRender())),a.watch((()=>this.viewModel?.mode),(()=>this._modeChanged()),a.initial)])},l.loadDependencies=function(){return Promise.all([new Promise(((t,s)=>e(["../chunks/calcite-icon"],t,s)))])},l.castVisibleElements=function(e){return{...g,...e}},l.addAttachment=function(){const{_addAttachmentForm:e,viewModel:t}=this;return this._set("submitting",!0),this._set("error",null),t.addAttachment(e).then((e=>(this._set("submitting",!1),this._set("error",null),t.mode="view",e))).catch((e=>{throw this._set("submitting",!1),this._set("error",new i("attachments:add-attachment",this.messages.addErrorMessage,e)),e}))},l.deleteAttachment=function(e){const{viewModel:t}=this;return this._set("submitting",!0),this._set("error",null),t.deleteAttachment(e).then((e=>(this._set("submitting",!1),this._set("error",null),t.mode="view",e))).catch((e=>{throw this._set("submitting",!1),this._set("error",new i("attachments:delete-attachment",this.messages.deleteErrorMessage,e)),e}))},l.updateAttachment=function(){const{viewModel:e}=this,{_updateAttachmentForm:t}=this;return this._set("submitting",!0),this._set("error",null),e.updateAttachment(t).then((t=>(this._set("submitting",!1),this._set("error",null),e.mode="view",t))).catch((e=>{throw this._set("submitting",!1),this._set("error",new i("attachments:update-attachment",this.messages.updateErrorMessage,e)),e}))},l.addFile=function(){const e=this.viewModel.addFile(this.selectedFile,this._addAttachmentForm);return this.viewModel.mode="view",e},l.updateFile=function(){const{viewModel:e}=this,t=e.updateFile(this.selectedFile,this._updateAttachmentForm,e.activeFileInfo);return e.mode="view",t},l.deleteFile=function(e){const t=this.viewModel.deleteFile(e||this.viewModel.activeFileInfo?.file);return this.viewModel.mode="view",t},l.render=function(){const{submitting:e,viewModel:t}=this,{state:s}=t;return f.tsx("div",{class:this.classes(y.base,y.esriWidget)},e?this.renderProgressBar():null,"loading"===s?this.renderLoading():this.renderAttachments(),this.renderErrorMessage())},l.renderErrorMessage=function(){const{error:e,visibleElements:t}=this;return e&&t.errorMessage?f.tsx("div",{key:"error-message",class:y.errorMessage},e.message):null},l.renderAttachments=function(){const{activeFileInfo:e,mode:t,activeAttachmentInfo:s}=this.viewModel;return"add"===t?this.renderAddForm():"edit"===t?this.renderDetailsForm(s||e):this.renderAttachmentContainer()},l.renderLoading=function(){return f.tsx("div",{class:y.loaderContainer,key:"loader"},f.tsx("div",{class:y.loader}))},l.renderProgressBar=function(){return this.visibleElements.progressBar?f.tsx("div",{class:y.progressBar,key:"progress-bar"}):null},l.renderAddForm=function(){const{submitting:e,selectedFile:t}=this,s=e||!t,i=this.visibleElements.cancelAddButton?f.tsx("button",{type:"button",bind:this,disabled:e,onclick:this._cancelForm,class:this.classes(y.esriButton,y.esriButtonTertiary,y.esriButtonSmall,y.esriButtonHalf,e&&y.buttonDisabled)},this.messages.cancel):null,n=this.visibleElements.addSubmitButton?f.tsx("button",{type:"submit",disabled:s,class:this.classes(y.esriButton,y.esriButtonSecondary,y.esriButtonSmall,y.esriButtonHalf,{[y.buttonDisabled]:s})},this.messages.add):null,a=t?f.tsx("span",{key:"file-name",class:y.fileName},t.name):null,r=f.tsx("form",{bind:this,afterCreate:p.storeNode,afterRemoved:p.discardNode,"data-node-ref":"_addAttachmentForm",onsubmit:this._submitAddAttachment},f.tsx("fieldset",{class:y.fileFieldset},a,f.tsx("label",{class:this.classes(y.fileLabel,y.esriButton,y.esriButtonSecondary)},t?this.messages.changeFile:this.messages.selectFile,f.tsx("input",{class:y.fileInput,type:"file",name:"attachment",bind:this,onchange:this._handleFileInputChange}))),n,i);return f.tsx("div",{key:"add-form-container",class:y.formNode},r)},l.renderDetailsForm=function(e){const{visibleElements:t,viewModel:s,selectedFile:i,submitting:a}=this,{abilities:o}=s,l=a||!i;let d,c,m,u;i?(d=i.type,c=i.name,m=i.size):e&&"file"in e?(d=e.file.type,c=e.file.name,m=e.file.size):e&&"contentType"in e&&(d=e.contentType,c=e.name,m=e.size,u=e.url);const h=o.editing&&o.operations?.delete&&t.deleteButton?f.tsx("button",{key:"delete-button",type:"button",disabled:a,bind:this,onclick:t=>this._submitDeleteAttachment(t,e),class:this.classes(y.esriButton,y.esriButtonSmall,y.esriButtonTertiary,y.deleteButton,{[y.buttonDisabled]:a})},this.messages.delete):void 0,_=o.editing&&o.operations?.update&&t.updateButton?f.tsx("button",{disabled:l,key:"update-button",type:"submit",class:this.classes(y.esriButton,y.esriButtonSmall,y.esriButtonThird,{[y.buttonDisabled]:l})},this.messages.update):void 0,g=this.visibleElements.cancelUpdateButton?f.tsx("button",{disabled:a,key:"cancel-button",type:"button",bind:this,onclick:this._cancelForm,class:this.classes(y.esriButton,y.esriButtonSmall,y.esriButtonTertiary,y.esriButtonThird,{[y.buttonDisabled]:a})},this.messages.cancel):void 0,b=o.editing&&o.operations?.update?f.tsx("fieldset",{key:"file",class:y.fileFieldset},f.tsx("span",{key:"file-name",class:y.fileName},c),f.tsx("label",{class:this.classes(y.fileLabel,y.esriButton,y.esriButtonSecondary)},this.messages.changeFile,f.tsx("input",{class:y.fileInput,type:"file",name:"attachment",bind:this,onchange:this._handleFileInputChange}))):void 0,v=f.tsx("fieldset",{key:"size",class:y.metadataFieldset},f.tsx("label",null,r.formatFileSize(this.messagesUnits,m??0))),w=f.tsx("fieldset",{key:"content-type",class:y.metadataFieldset},f.tsx("label",null,d)),k=n.isSome(u)?f.tsx("a",{class:y.itemLink,href:u,rel:"noreferrer",target:"_blank"},this.renderImageMask(e,400),f.tsx("div",{class:y.itemLinkOverlay},f.tsx("span",{class:y.itemLinkOverlayIcon},f.tsx("calcite-icon",{icon:"launch"})))):this.renderImageMask(e,400),A=f.tsx("form",{bind:this,afterCreate:p.storeNode,afterRemoved:p.discardNode,"data-node-ref":"_updateAttachmentForm",onsubmit:t=>this._submitUpdateAttachment(t,e)},f.tsx("div",{class:y.metadata},v,w),b,f.tsx("div",{class:y.actions},h,g,_));return f.tsx("div",{key:"edit-form-container",class:y.formNode},k,A)},l.renderImageMask=function(e,t){return e?"file"in e?this.renderGenericImageMask(e.file.name,e.file.type):this.renderImageMaskForAttachment(e,t):null},l.renderGenericImageMask=function(e,t){const{supportsResizeAttachments:s}=this.viewModel,i=h.getIconPath(t),n={[y.itemImageResizable]:s};return f.tsx("div",{class:this.classes(y.itemMaskIcon,y.itemMask)},f.tsx("img",{title:e,alt:e,src:i,class:this.classes(n,y.itemImage)}))},l.renderImageMaskForAttachment=function(e,t){const{supportsResizeAttachments:s}=this.viewModel;if(!e)return null;const{contentType:i,name:n,url:a}=e;if(!s||!h.isSupportedImage(i))return this.renderGenericImageMask(n,i);const r=this._getCSSTransform(e),o=r?{transform:r,"image-orientation":"none"}:{},l=`${a}${a?.includes("?")?"&":"?"}w=${t}`,d={[y.itemImageResizable]:s};return f.tsx("div",{class:this.classes(y.itemMask)},f.tsx("img",{styles:o,alt:n,title:n,src:l,class:this.classes(d,y.itemImage)}))},l.renderFile=function(e){const{file:t}=e;return f.tsx("li",{class:y.item,key:t},f.tsx("button",{key:"details-button",bind:this,class:y.itemButton,title:this.messages.attachmentDetails,"aria-label":this.messages.attachmentDetails,onclick:()=>this._startEditFile(e),type:"button"},this.renderImageMask(e),f.tsx("label",{class:y.itemLabel},f.tsx("span",{class:y.itemFilename},t.name||this.messages.noTitle),f.tsx("span",{"aria-hidden":"true",class:this.classes(y.itemChevronIcon,p.isRTL(this.container)?y.iconLeft:y.iconRight)}))))},l.renderAttachmentInfo=function({attachmentInfo:e,displayType:t}){const{viewModel:s,effectiveDisplayType:i}=this,{abilities:n,supportsResizeAttachments:a}=s,{contentType:r,name:o,url:l}=e,d=this.renderImageMask(e,"list"===t?48:400),c=n.editing?f.tsx("span",{"aria-hidden":"true",class:this.classes(y.itemChevronIcon,p.isRTL(this.container)?y.iconLeft:y.iconRight)}):null,m=[d,"preview"===i&&a&&h.isSupportedImage(r)?null:f.tsx("label",{class:y.itemLabel},f.tsx("span",{class:y.itemFilename},o||this.messages.noTitle),c)],u=n.editing?f.tsx("button",{key:"details-button",bind:this,class:y.itemButton,title:this.messages.attachmentDetails,"aria-label":this.messages.attachmentDetails,"data-attachment-info-id":e.id,onclick:()=>this._startEditAttachment(e),type:"button"},m):f.tsx("a",{key:"details-link",class:y.itemButton,href:l??void 0,target:"_blank"},m);return f.tsx("li",{class:y.item,key:e},u)},l.renderAttachmentContainer=function(){const{effectiveDisplayType:e,viewModel:t,visibleElements:s}=this,{attachmentInfos:i,abilities:n,fileInfos:a}=t,r=!!i?.length,o=!!a?.length,l={[y.containerList]:"preview"!==e,[y.containerPreview]:"preview"===e},d=n.editing&&n.operations?.add&&s.addButton?f.tsx("button",{bind:this,onclick:()=>this._startAddAttachment(),class:this.classes(y.esriButton,y.esriButtonTertiary,y.addAttachmentButton),type:"button"},f.tsx("span",{"aria-hidden":"true",class:this.classes(y.itemAddIcon,y.iconPlus)}),this.messages.add):void 0,c=r?f.tsx("ul",{key:"attachments-list",class:y.items},i.toArray().map((t=>this.renderAttachmentInfo({attachmentInfo:t,displayType:e})))):void 0,m=o?f.tsx("ul",{key:"file-list",class:y.items},a.toArray().map((e=>this.renderFile(e)))):void 0,u=o||r?void 0:f.tsx("div",{class:y.empty},this.messages.noAttachments);return f.tsx("div",{key:"attachments-container",class:this.classes(y.container,l)},c,m,u,d)},l._modeChanged=function(){this._set("error",null),this._set("selectedFile",null)},l._handleFileInputChange=function(e){const t=e.target,s=t&&t.files&&t.files.item(0);this._set("selectedFile",s)},l._submitDeleteAttachment=function(e,t){e.preventDefault(),t&&("file"in t?this.deleteFile(t.file):t&&this.deleteAttachment(t))},l._submitAddAttachment=function(e){e.preventDefault(),this.viewModel.filesEnabled?this.addFile():this.addAttachment()},l._submitUpdateAttachment=function(e,t){e.preventDefault(),t&&"file"in t?this.updateFile():this.updateAttachment()},l._startEditAttachment=function(e){const{viewModel:t}=this;t.activeFileInfo=null,t.activeAttachmentInfo=e,t.mode="edit"},l._startEditFile=function(e){const{viewModel:t}=this;t.activeAttachmentInfo=null,t.activeFileInfo=e,t.mode="edit"},l._startAddAttachment=function(){this.viewModel.mode="add"},l._cancelForm=function(e){e.preventDefault(),this.viewModel.mode="view"},l._getCSSTransform=function(e){const{orientationInfo:t}=e;return!this._supportsImageOrientation&&t?[t.rotation?`rotate(${t.rotation}deg)`:"",t.mirrored?"scaleX(-1)":""].join(" "):""},t._createClass(o,[{key:"abilities",get:function(){return this.viewModel.abilities},set:function(e){this.viewModel.abilities=e}},{key:"effectiveDisplayType",get:function(){const{displayType:e}=this;return e&&"auto"!==e?e:this.viewModel.supportsResizeAttachments?"preview":"list"}},{key:"graphic",get:function(){return this.viewModel.graphic},set:function(e){this.viewModel.graphic=e}},{key:"label",get:function(){return this.messages?.widgetLabel??""},set:function(e){this._overrideIfSome("label",e)}}]),o}(m);s.__decorate([o.property()],k.prototype,"abilities",null),s.__decorate([o.property()],k.prototype,"displayType",void 0),s.__decorate([o.property({readOnly:!0})],k.prototype,"effectiveDisplayType",null),s.__decorate([o.property()],k.prototype,"graphic",null),s.__decorate([o.property()],k.prototype,"label",null),s.__decorate([o.property(),_.messageBundle("esri/widgets/Attachments/t9n/Attachments")],k.prototype,"messages",void 0),s.__decorate([o.property(),_.messageBundle("esri/core/t9n/Units")],k.prototype,"messagesUnits",void 0),s.__decorate([o.property({readOnly:!0})],k.prototype,"selectedFile",void 0),s.__decorate([o.property({readOnly:!0})],k.prototype,"submitting",void 0),s.__decorate([o.property({readOnly:!0})],k.prototype,"error",void 0),s.__decorate([o.property({type:u})],k.prototype,"viewModel",void 0),s.__decorate([o.property()],k.prototype,"visibleElements",void 0),s.__decorate([l.cast("visibleElements")],k.prototype,"castVisibleElements",null),k=s.__decorate([c.subclass("esri.widgets.Attachments")],k);return k}));
