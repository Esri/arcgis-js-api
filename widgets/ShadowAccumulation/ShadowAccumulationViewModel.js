/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../Color","../../core/Accessor","../../core/has","../../core/Handles","../../core/maybe","../../core/promiseUtils","../../core/screenUtils","../../core/timeUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/Logger","../../core/accessorSupport/decorators/subclass","../../core/accessorSupport/trackingUtils","../../chunks/vec3f64","../../views/3d/support/earthUtils","../../views/3d/support/sunUtils","./DiscreteOptions","./DurationOptions","./ShadowTooltipViewModel","./ThresholdOptions","../support/traversalUtils"],(function(e,t,i,r,o,n,s,a,c,u,l,p,d,_,h,y,f,m,w,v,g,T,b){"use strict";const P=[],D=y.create(),O=[],C=255,U=u.convertTime(1,"hours","milliseconds"),A=300;let S=function(t){function r(e){var i;return(i=t.call(this,e)||this).view=null,i.tooltip=new g.ShadowTooltipViewModel({getDuration:(e,t)=>i.getDuration(e,t)}),i.startTimeOfDay=u.convertTime(10,"hours","milliseconds"),i.endTimeOfDay=u.convertTime(16,"hours","milliseconds"),i.visualizationType="threshold",i.thresholdOptions=new T,i.durationOptions=new v,i.discreteOptions=new w,i._running=!0,i._handles=new n,i._stopPreviewingTask=null,i._forcePreview=null,i._autoRestoreForcePreviewEnabled=!0,i._utcOffset=null,i.date=new Date,i}e._inheritsLoose(r,t);var o=r.prototype;return o.initialize=function(){var t=this;this._handles.add([h.reactionInit((()=>({view:this.view,tooltipEnabled:this._tooltipEnabled})),(({view:e,tooltipEnabled:t})=>{this.tooltip.view=e,this.tooltip.enabled=t})),h.reactionInit((()=>this._getForcePreviewDependencies()),(()=>{s.abortMaybe(this._stopPreviewingTask),this._forcePreview=!0,this._autoRestoreForcePreviewEnabled&&(this._stopPreviewingTask=a.createTask(function(){var i=e._asyncToGenerator((function*(e){yield a.after(A,e),a.throwIfAborted(e),t._forcePreview=!1}));return function(e){return i.apply(this,arguments)}}()))})),h.autorun((()=>this._updateVisualizationParameters())),h.autorun((()=>this._setShadowAccumulationParameters({lightDirections:this._lightDirections}))),h.autorun((()=>this._setShadowAccumulationParameters({enabled:this._running}))),h.autorun((()=>this._setShadowAccumulationParameters({previewing:this._previewing})))])},o.destroy=function(){this.stop(),this._handles=s.destroyMaybe(this._handles),s.destroyMaybe(this.tooltip)},o.start=function(){this._running=!0},o.stop=function(){this._running=!1},o.setRunning=function(e){this._running=e},o.getDuration=function(){var t=e._asyncToGenerator((function*(e,t){const{view:i,_renderView:r}=this;if(s.isNone(i)||s.isNone(r))return 0;const o=i.state.camera.screenToRender(c.createScreenPointArray(e.x,e.y),c.createRenderScreenPointArray()),n=r.readAccumulatedShadow(o),a=this._sampleCount;if(0===a)return 0;return n*a*(this._duration/a)}));function i(e,i){return t.apply(this,arguments)}return i}(),o._setShadowAccumulationParameters=function(e){const t=this._renderView;s.isNone(t)||t.setRenderParameters({shadowAccumulationOptions:e})},o._updateVisualizationParameters=function(){if(this._running)switch(this.visualizationType){case"threshold":this._updateThresholdVisualizationParameters();break;case"duration":this._updateDurationVisualizationParameters();break;case"discrete":this._updateDiscreteVisualizationParameters()}},o._updateThresholdVisualizationParameters=function(){const{value:e,color:t}=this.thresholdOptions,r=this._duration,o=t,n=o.clone();n.a=0,this._setShadowAccumulationParameters({visualization:1,thresholdColors:[i.toUnitRGBA(n),i.toUnitRGBA(o)],threshold:r>0?e/this._duration:0})},o._updateDurationVisualizationParameters=function(){const{color:e,mode:t}=this.durationOptions;this._updateGradientColorRamp(e);const i=this._duration,r=i>0&&"hourly"===t?U/i:0;this._setShadowAccumulationParameters({visualization:0,bandsEnabled:r>0,bandSize:r})},o._updateDiscreteVisualizationParameters=function(){this._updateGradientColorRamp(this.discreteOptions.color),this._setShadowAccumulationParameters({visualization:0,bandsEnabled:!1,bandSize:0})},o._updateGradientColorRamp=function(e){const t=e,r=t.clone();r.a=0;const o=[i.toUnitRGBA(r),i.toUnitRGBA(t)];this._setShadowAccumulationParameters({gradientColorRamp:o})},o._getForcePreviewDependencies=function(){const{view:e}=this;if(s.isNone(e))return null;const t=e.slicePlane,i=e.allLayerViews.toArray().filter(k),r=i.map((e=>e.layer)).filter(s.isSome),o=i.map((e=>e.visible)),n=r.map((e=>e.visible)),a=r.map((e=>e.opacity)),c=r.filter((function(e){return"definitionExpression"in e})).map((e=>e.definitionExpression)),u=i.filter((function(e){return"filter"in e})).map((e=>e.filter));return{slicePlane:t,startDateUTC:this._startDateTimeUTC,endDateUTC:this._endDateTimeUTC,layerViewVisibilities:o,layerVisibilities:n,layerOpacities:a,filters:u,definitionExpressions:c}},e._createClass(r,[{key:"state",get:function(){return s.isSome(this.view)&&this.view.ready&&s.isSome(this._referencePosition)?"ready":"disabled"}},{key:"date",set:function(e){const t=new Date(e);t.setHours(0,0,0,0),this._set("date",t)}},{key:"utcOffset",get:function(){return s.unwrapOr(this._utcOffset,this._utcOffsetAuto)},set:function(e){this._utcOffset=e}},{key:"testData",get:function(){return{setAutoRestoreForcedPreviewEnabled:e=>{this._autoRestoreForcePreviewEnabled=e},setForcedPreview:e=>{this._forcePreview=e},isPreviewing:()=>this._previewing}}},{key:"_previewing",get:function(){const{view:e}=this;return!(!s.isNone(e)&&!s.isNone(e.allLayerViews))||(this._forcePreview||!e.stationary||e.allLayerViews.some((e=>k(e)&&e.updating)))}},{key:"_utcOffsetAuto",get:function(){const e=this._referencePosition;return s.mapOr(e,0,(e=>f.longitudeToTimezone(e[0],!1)))}},{key:"_dateUTCOffset",get:function(){let e=this.date;return e=u.offsetDateUTC(e,-e.getTimezoneOffset(),"minutes"),e=u.offsetDateUTC(e,-this.utcOffset,"hours"),e}},{key:"_startDateTimeUTC",get:function(){return u.offsetDateUTC(this._dateUTCOffset,this.startTimeOfDay)}},{key:"_endDateTimeUTC",get:function(){return u.offsetDateUTC(this._dateUTCOffset,this.endTimeOfDay)}},{key:"_referencePosition",get:function(){return s.applySome(this.view,(e=>s.applySome(e.environmentManager,(e=>e.referencePositionWGS84Comparable))))}},{key:"_sampleCount",get:function(){switch(this.visualizationType){case"threshold":case"duration":return C;case"discrete":{const e=this.discreteOptions.interval;return e>0?Math.floor(this._duration/e):C}}}},{key:"_duration",get:function(){return this.endTimeOfDay-this.startTimeOfDay}},{key:"_lightDirections",get:function(){const{view:e}=this;if(s.isNone(e))return P;const t="global"===e.viewingMode?D:this._referencePosition;if(s.isNone(t))return P;const i=this._sampleCount,r=new Array(i);for(let s=0;s<i;++s)r[s]=y.create();m.computeDirectionsOverTime(this._startDateTimeUTC,this._endDateTimeUTC,t,e.viewingMode,r),O.length=0;const o=b.breadthFirstBinaryPartitioning(0,i,O),n=new Array(i);for(let s=0;s<i;++s)n[s]=r[o[s]];return n}},{key:"_tooltipEnabled",get:function(){return"ready"===this.state&&"discrete"!==this.visualizationType&&this._running&&!this._previewing}},{key:"_renderView",get:function(){const{view:e}=this;if(s.isNone(e))return null;const t=e._stage;return s.isNone(t)?null:t.renderView}}]),r}(r);function k(e){if(e.suspended)return!1;switch(e.type){case"building-scene-3d":case"csv-3d":case"elevation-3d":case"feature-3d":case"geojson-3d":case"graphics-3d":case"integrated-mesh-3d":case"ogc-feature-3d":case"scene-layer-3d":case"scene-layer-graphics-3d":case"slice-3d":case"stream-3d":case"wms-3d":return!0;case"area-measurement-3d":case"base-dynamic-3d":case"direct-line-measurement-3d":case"imagery-3d":case"imagery-tile-3d":case"line-of-sight-3d":case"map-image-3d":case"point-cloud-3d":case"tile-3d":case"vector-tile-3d":case"voxel-3d":case"wfs-3d":case"wmts-3d":case"voxel-3d":return!1;case"group":return e.layerViews.toArray().some((e=>k(e)));default:return!1}}return t.__decorate([l.property()],S.prototype,"state",null),t.__decorate([l.property()],S.prototype,"view",void 0),t.__decorate([l.property()],S.prototype,"tooltip",void 0),t.__decorate([l.property({nonNullable:!0})],S.prototype,"date",null),t.__decorate([l.property({nonNullable:!0})],S.prototype,"utcOffset",null),t.__decorate([l.property({nonNullable:!0})],S.prototype,"startTimeOfDay",void 0),t.__decorate([l.property({nonNullable:!0})],S.prototype,"endTimeOfDay",void 0),t.__decorate([l.property({nonNullable:!0})],S.prototype,"visualizationType",void 0),t.__decorate([l.property({type:T,nonNullable:!0})],S.prototype,"thresholdOptions",void 0),t.__decorate([l.property({type:v,nonNullable:!0})],S.prototype,"durationOptions",void 0),t.__decorate([l.property({type:w,nonNullable:!0})],S.prototype,"discreteOptions",void 0),t.__decorate([l.property()],S.prototype,"_running",void 0),t.__decorate([l.property()],S.prototype,"_handles",void 0),t.__decorate([l.property()],S.prototype,"_stopPreviewingTask",void 0),t.__decorate([l.property()],S.prototype,"_forcePreview",void 0),t.__decorate([l.property()],S.prototype,"_autoRestoreForcePreviewEnabled",void 0),t.__decorate([l.property()],S.prototype,"_previewing",null),t.__decorate([l.property()],S.prototype,"_utcOffset",void 0),t.__decorate([l.property()],S.prototype,"_utcOffsetAuto",null),t.__decorate([l.property()],S.prototype,"_dateUTCOffset",null),t.__decorate([l.property()],S.prototype,"_startDateTimeUTC",null),t.__decorate([l.property()],S.prototype,"_endDateTimeUTC",null),t.__decorate([l.property()],S.prototype,"_referencePosition",null),t.__decorate([l.property()],S.prototype,"_sampleCount",null),t.__decorate([l.property()],S.prototype,"_duration",null),t.__decorate([l.property()],S.prototype,"_lightDirections",null),t.__decorate([l.property()],S.prototype,"_tooltipEnabled",null),S=t.__decorate([_.subclass("esri.widgets.ShadowAccumulation.ShadowAccumulationViewModel")],S),S}));
