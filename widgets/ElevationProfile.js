/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/maybe","../core/memoize","../core/promiseUtils","../core/watchUtils","../core/accessorSupport/decorators/aliasOf","../core/has","../core/accessorSupport/ensureType","../core/Logger","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/subclass","../chunks/ResizeObserver","./Widget","./ElevationProfile/css","./ElevationProfile/ElevationProfileViewModel","./ElevationProfile/ElevationProfileVisibleElements","./ElevationProfile/components/Legend","./ElevationProfile/components/SettingsButton","./ElevationProfile/support/chartUtils","./ElevationProfile/support/constants","./support/widgetUtils","./support/decorators/messageBundle","./support/jsxFactory"],(function(e,t,i,o,n,r,s,a,l,c,h,d,u,p,_,C,m,v,f,y,S,g,b,k){"use strict";const w=[{type:"select"},{type:"sketch"}],B={none:null,"no-valid-input":"noProfile","no-visible-profiles":"noProfile","refined-but-no-chart-data":"noProfile","too-complex":"tooComplex","unknown-error":"unknown","invalid-geometry":"invalidGeometry","invalid-elevation-info":"invalidElevationInfo"};let M=function(t){function s(e,i){var n;return(n=t.call(this,e,i)||this).viewModel=null,n.view=null,n.input=null,n.profiles=null,n.unitOptions=[],n.unit="metric",n.geodesicDistanceThreshold=1e5,n.visibleElements=new m,n.iconClass=_.CSS.widgetIcon,n.label=void 0,n.messages=null,n.messagesCommon=null,n.messagesUnits=null,n._chartContainer=null,n._chart=null,n._chartInitTask=null,n._chartIsRefined=!1,n._resizeObserver=null,n._portrait=!1,n._zoomOutButtonVisible=!1,n._getChartUpdateParamsMemoized=o.memoize(((e,t,i,o)=>({chart:e,data:t,stationary:i,messages:o}))),n._getDetailsPropsMemoized=o.memoize(((e,t)=>({effectiveUnits:e,profiles:t}))),null!=e&&e.viewModel||(n._defaultViewModel=new C({view:null==e?void 0:e.view}),n.viewModel=n._defaultViewModel),n}e._inheritsLoose(s,t);var a=s.prototype;return a.initialize=function(){this._legend=new v.Legend(this._legendProps),this._settingsButton=new f.SettingsButton(this._settingsButtonProps),this.own([this.watch("_legendProps",(e=>this._legend.set(e))),this.watch("_settingsButtonProps",(e=>this._settingsButton.set(e)))])},a.postInitialize=function(){this.own([r.init(this,"_chartContainer",(()=>{this._destroyChart();const e=this._chartContainer;i.isNone(e)||(this._chartInitTask=n.createTask((t=>this._initializeChart(e,t))))})),r.init(this,"_chartUpdateParams",(()=>this._updateChart(this._chartUpdateParams)))])},a.destroy=function(){this._destroyChart(),i.isSome(this._defaultViewModel)&&this.viewModel!==this._defaultViewModel&&this._defaultViewModel.destroy(),this._legend=i.destroyMaybe(this._legend),this._settingsButton=i.destroyMaybe(this._settingsButton),i.isSome(this._resizeObserver)&&(this._resizeObserver.disconnect(),this._resizeObserver=null)},a.render=function(){const{viewModel:e,visible:t}=this;return k.tsx("div",{key:this,class:this.classes({[_.CSS.base]:t,[_.CSS.esriWidget]:t,[_.CSS.esriWidgetDisabled]:t&&"disabled"===e.state,[_.CSS.portrait]:this._portrait,[_.CSS.refined]:1===this.viewModel.progress}),bind:this,afterCreate:this._onAfterCreate,"aria-label":this.messages.widgetLabel},t&&this._renderContentForState())},a._renderContentForState=function(){switch(this.viewModel.state){case S.ElevationProfileState.Ready:return this._renderContentForReadyState();case S.ElevationProfileState.Selecting:return this._renderContentForSelectingState();case S.ElevationProfileState.Creating:return this._renderContentForCreatingState();case S.ElevationProfileState.Selected:return this._renderContentForSelectedState();case S.ElevationProfileState.Created:return this._renderContentForCreatedState();case S.ElevationProfileState.Disabled:return this._renderContentForReadyState()}},a._renderContentForReadyState=function(){const{sketchButton:e,selectButton:t}=this.visibleElements,i=this.messages;let o;if(e&&t)o=i.readyPrompt;else if(e)o=i.readyPromptCreateOnly;else if(t)o=i.readyPromptSelectOnly;else{var n;o=null==(n=i.errors)?void 0:n.noProfile}return this._renderContent({prompt:o,chart:!1,actions:w})},a._renderContentForSelectingState=function(){const e=this.view;if(i.isNone(e))return null;const t=this.messages[`selectingPrompt-${e.type}`];return this._renderContent({prompt:t,chart:!1,actions:[{type:"select-cancel"}]})},a._renderContentForCreatingState=function(){const{view:e,viewModel:t}=this;if(i.isNone(e))return null;const o=t.hasVertices?[{type:"sketch-cancel"},{type:"sketch-done",disabled:!t.tool.interaction.canStopCreating}]:[{type:"select"},{type:"sketch",disabled:!0}];if("no-valid-input"===t.errorState){const t=this.messages[`creatingPrompt-${e.type}`];return this._renderContent({chart:!1,actions:o,prompt:t})}const n=this._getErrorMessage();return n?this._renderContent({chart:!1,actions:o,prompt:n}):this._renderContent({chart:!0,actions:o})},a._renderContentForSelectedState=function(){const e=this._getErrorMessage();return e?this._renderContent({chart:!1,actions:w,prompt:e}):this._renderContent({chart:!0,actions:w})},a._renderContentForCreatedState=function(){const e=this._getErrorMessage();return e?this._renderContent({chart:!1,actions:w,prompt:e}):this._renderContent({chart:!0,actions:w})},a._getErrorMessage=function(){var e,t;const i=B[this.viewModel.errorState];return null==(e=this.messages)||null==(t=e.errors)?void 0:t[i]},a._renderContent=function(e){const t=i.isSome(e.prompt)?this._renderPrompt(e.prompt):e.chart&&this._renderChart(),o=i.isSome(this.viewModel.input);return[k.tsx("header",{key:"header",class:_.CSS.header},this._zoomOutButtonVisible&&this._renderZoomOutButton(),this.visibleElements.clearButton&&o&&this._renderClearButton(),this.visibleElements.settingsButton&&this._settingsButton.render()),k.tsx("div",{class:_.CSS.mainContainer},t),this.visibleElements.legend&&this._legend.render(),this._renderActions(e)]},a._renderZoomOutButton=function(){return k.tsx("button",{key:"zoom-out",class:_.CSS.zoomOutButton,bind:this,onclick:this._onZoomOutButtonClick,title:this.messages.zoomOut})},a._onZoomOutButtonClick=function(){i.applySome(this._chart,(e=>e.zoomOut()))},a._renderClearButton=function(){return k.tsx("button",{key:"clear-profile",class:_.CSS.clearButton,bind:this,onclick:this._onClearButtonClick,title:this.messages.clearProfile})},a._onClearButtonClick=function(){this.viewModel.clear()},a._renderPrompt=function(e){return[k.tsx("div",{key:"prompt-container",bind:this,class:_.CSS.promptContainer},k.tsx("p",null,e))]},a._renderChart=function(){if(!this.visibleElements.chart)return[k.tsx("div",{key:"empty-chart-container",class:_.CSS.chartContainer})];const e=this._chartIsRefined||this._canRenderChart();if(!e)return[this._renderSpinner({size:"large"}),k.tsx("div",{key:"chart-container-empty",class:_.CSS.chartContainer})];const{chartData:t,progress:o}=this.viewModel;return[i.isSome(t)&&o>0&&o<1&&this._renderSpinner({size:e?"small":"large"}),k.tsx("div",{key:"chart-container",bind:this,class:_.CSS.chartContainer,afterCreate:this._onChartContainerAfterCreate,afterRemoved:this._onChartContainerRemoved})]},a._renderSpinner=function(e){return k.tsx("div",{key:"spinner",class:this.classes(_.CSS.chartSpinner,{[_.CSS.chartSpinnerSmall]:"small"===e.size}),afterCreate:this._onSpinnerAfterCreate,exitAnimation:this._onSpinnerExit})},a._onSpinnerAfterCreate=function(e){requestAnimationFrame((()=>e.classList.add(_.CSS.chartSpinnerVisible)))},a._onSpinnerExit=function(e,t){e.classList.remove(_.CSS.chartSpinnerVisible),setTimeout(t,200)},a._canRenderChart=function(){const e=this.viewModel.chartData;if(i.isNone(e))return!1;if(!this.viewModel.inputIsSketched)return e.refined;let t=0;for(const{samples:o}of e.lines)t+=i.isSome(o)?o.length:0;return e.refined||t<=S.LARGE_CHART_SAMPLES},a._renderActions=function({actions:e}){const t=e.map((e=>{switch(e.type){case"sketch":return this.visibleElements.sketchButton&&this._renderAction({action:e,onClick:this._onSketchButtonClick,className:_.CSS.sketchButton,label:this.messages.sketchButtonLabel});case"sketch-cancel":return this.visibleElements.sketchButton&&this._renderAction({action:e,onClick:this._onCancelButtonClick,className:_.CSS.sketchCancelButton,label:this.messagesCommon.cancel});case"sketch-done":return this.visibleElements.sketchButton&&this._renderAction({action:e,onClick:this._onDoneButtonClick,className:_.CSS.sketchDoneButton,label:this.messagesCommon.done});case"select":return this.visibleElements.selectButton&&this._renderAction({action:e,onClick:this._onSelectButtonClick,className:_.CSS.selectButton,label:this.messages.selectButtonLabel});case"select-cancel":return this.visibleElements.selectButton&&this._renderAction({action:e,onClick:this._onCancelButtonClick,className:_.CSS.selectCancelButton,label:this.messagesCommon.cancel})}})).filter(Boolean);return t.length?k.tsx("footer",{key:"footer",class:_.CSS.footer},t):null},a._renderAction=function({action:e,onClick:t,className:i,label:o}){return k.tsx("button",{key:`action-${e.type}`,class:this.classes(_.CSS.actionButton,i,{[_.CSS.buttonDisabled]:e.disabled}),bind:this,disabled:e.disabled,onclick:t},o)},a._onSketchButtonClick=function(){this.viewModel.start({mode:"sketch"})},a._onSelectButtonClick=function(){this.viewModel.start({mode:"select"})},a._onCancelButtonClick=function(){this.viewModel.cancel()},a._onDoneButtonClick=function(){this.viewModel.stop()},a._updateChart=function(e){const{data:t,chart:o,messages:n,stationary:r}=e;!i.isNone(o)&&!i.isNone(n)&&r&&this._canRenderChart()&&(o.update(e),this._chartIsRefined=i.isSome(t)&&t.refined)},a._onChartContainerAfterCreate=function(e){this._chartContainer=e},a._onChartContainerRemoved=function(){this._chartContainer=null},a._initializeChart=function(){var t=e._asyncToGenerator((function*(e,t){this._chart=yield y.createChart({container:e,abortOptions:{signal:t},onRangeChange:(e,t)=>{this._zoomOutButtonVisible=1!==e||1!==t},onCursorPositionChange:e=>{this.viewModel.hoveredChartPosition=e}}),this._updateChart(this._chartUpdateParams)}));function i(e,i){return t.apply(this,arguments)}return i}(),a._destroyChart=function(){this._chartInitTask=i.abortMaybe(this._chartInitTask),this._chart=i.destroyMaybe(this._chart),this._chartIsRefined=!1},a._onAfterCreate=function(e){const t=()=>{this._portrait=e.getBoundingClientRect().width<S.PORTRAIT_MODE_PIXEL_BREAKPOINT};t(),this._resizeObserver=new u.ResizeObserver((()=>t())),this._resizeObserver.observe(e)},e._createClass(s,[{key:"_chartUpdateParams",get:function(){const e=this.view;return this._getChartUpdateParamsMemoized(this._chart,this.viewModel.chartData,!i.isSome(e)||e.stationary,this._chartMessages)}},{key:"_chartMessages",get:function(){return{...this.messagesUnits,...this.messages}}},{key:"_legendProps",get:function(){return this._getDetailsPropsMemoized(this.viewModel.effectiveUnits,this._profilesArray)}},{key:"_profilesArray",get:function(){return this.profiles.toArray()}},{key:"_settingsButtonProps",get:function(){return{viewModel:this.viewModel,visibleElements:this.visibleElements}}}]),s}(p);return t.__decorate([h.property({type:C})],M.prototype,"viewModel",void 0),t.__decorate([s.aliasOf("viewModel.view")],M.prototype,"view",void 0),t.__decorate([s.aliasOf("viewModel.input")],M.prototype,"input",void 0),t.__decorate([s.aliasOf("viewModel.profiles")],M.prototype,"profiles",void 0),t.__decorate([s.aliasOf("viewModel.unitOptions")],M.prototype,"unitOptions",void 0),t.__decorate([s.aliasOf("viewModel.unit")],M.prototype,"unit",void 0),t.__decorate([s.aliasOf("viewModel.geodesicDistanceThreshold")],M.prototype,"geodesicDistanceThreshold",void 0),t.__decorate([h.property({type:m,nonNullable:!0})],M.prototype,"visibleElements",void 0),t.__decorate([h.property()],M.prototype,"iconClass",void 0),t.__decorate([s.aliasOf("messages.widgetLabel",{overridable:!0})],M.prototype,"label",void 0),t.__decorate([s.aliasOf("viewModel.visible")],M.prototype,"visible",void 0),t.__decorate([h.property(),b.messageBundle("esri/widgets/ElevationProfile/t9n/ElevationProfile")],M.prototype,"messages",void 0),t.__decorate([h.property(),b.messageBundle("esri/t9n/common")],M.prototype,"messagesCommon",void 0),t.__decorate([h.property(),b.messageBundle("esri/core/t9n/Units")],M.prototype,"messagesUnits",void 0),t.__decorate([h.property()],M.prototype,"_chartContainer",void 0),t.__decorate([h.property()],M.prototype,"_chart",void 0),t.__decorate([h.property()],M.prototype,"_chartInitTask",void 0),t.__decorate([h.property()],M.prototype,"_chartIsRefined",void 0),t.__decorate([h.property()],M.prototype,"_settingsButton",void 0),t.__decorate([h.property()],M.prototype,"_legend",void 0),t.__decorate([h.property()],M.prototype,"_portrait",void 0),t.__decorate([h.property()],M.prototype,"_zoomOutButtonVisible",void 0),t.__decorate([h.property()],M.prototype,"_chartUpdateParams",null),t.__decorate([h.property()],M.prototype,"_chartMessages",null),t.__decorate([h.property()],M.prototype,"_legendProps",null),t.__decorate([h.property()],M.prototype,"_profilesArray",null),t.__decorate([h.property()],M.prototype,"_settingsButtonProps",null),M=t.__decorate([d.subclass("esri.widgets.ElevationProfile")],M),M}));
