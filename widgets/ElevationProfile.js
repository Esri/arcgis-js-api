/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/maybe","../core/memoize","../core/promiseUtils","../core/reactiveUtils","../core/accessorSupport/decorators/aliasOf","../core/arrayUtils","../core/has","../core/accessorSupport/ensureType","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/subclass","./Widget","./ElevationProfile/css","./ElevationProfile/ElevationProfileViewModel","./ElevationProfile/ElevationProfileVisibleElements","./ElevationProfile/components/Legend","./ElevationProfile/components/SettingsButton","./ElevationProfile/support/chartUtils","./ElevationProfile/support/constants","./support/widgetUtils","./support/decorators/messageBundle","../core/Logger","./support/jsxFactory"],(function(e,t,o,n,i,r,s,a,l,c,h,d,p,u,_,C,f,m,S,v,y,g,b,k){"use strict";var w;!function(e){e.Sketch="sketch",e.SketchCancel="sketch-cancel",e.SketchDone="sketch-done",e.Select="select",e.SelectCancel="select-cancel"}(w||(w={}));const E=[{type:w.Select},{type:w.Sketch}],P={[v.ElevationProfileErrorState.None]:null,[v.ElevationProfileErrorState.NoValidInput]:"noProfile",[v.ElevationProfileErrorState.NoVisibleProfiles]:"noProfile",[v.ElevationProfileErrorState.RefinedButNoChartData]:"noProfile",[v.ElevationProfileErrorState.TooComplex]:"tooComplex",[v.ElevationProfileErrorState.UnknownError]:"unknown",[v.ElevationProfileErrorState.InvalidGeometry]:"invalidGeometry",[v.ElevationProfileErrorState.InvalidElevationInfo]:"invalidElevationInfo"};let B=function(t){function s(e,o){var i;return(i=t.call(this,e,o)||this).viewModel=null,i.view=null,i.input=null,i.profiles=null,i.unitOptions=[],i.unit="metric",i.geodesicDistanceThreshold=1e5,i.visibleElements=new C,i.iconClass=u.CSS.widgetIcon,i.label=void 0,i.messages=null,i.messagesCommon=null,i.messagesUnits=null,i._chartContainer=null,i._chart=null,i._chartInitTask=null,i._chartIsRefined=!1,i._portrait=!1,i._zoomOutButtonVisible=!1,i._getChartUpdateParamsMemoized=n.memoize(((e,t,o,n)=>({chart:e,data:t,stationary:o,messages:n}))),i._getDetailsPropsMemoized=n.memoize(((e,t)=>({effectiveUnits:e,profiles:t}))),null!=e&&e.viewModel||(i._defaultViewModel=new _({view:null==e?void 0:e.view}),i.viewModel=i._defaultViewModel),i}e._inheritsLoose(s,t);var a=s.prototype;return a.initialize=function(){this._legend=new f.Legend(this._legendProps),this._settingsButton=new m.SettingsButton(this._settingsButtonProps),this.own([r.watch((()=>this._legendProps),(e=>this._legend.set(e))),r.watch((()=>this._settingsButtonProps),(e=>this._settingsButton.set(e)))])},a.postInitialize=function(){this.own([r.watch((()=>this._chartContainer),(()=>{this._destroyChart();const e=this._chartContainer;o.isNone(e)||(this._chartInitTask=i.createTask((t=>this._initializeChart(e,t))))}),r.initial),r.watch((()=>this._chartUpdateParams),(()=>this._updateChart(this._chartUpdateParams)),r.initial)])},a.destroy=function(){this._destroyChart(),o.isSome(this._defaultViewModel)&&this.viewModel!==this._defaultViewModel&&this._defaultViewModel.destroy(),this._legend=o.destroyMaybe(this._legend),this._settingsButton=o.destroyMaybe(this._settingsButton)},a.render=function(){const{viewModel:e,visible:t}=this;return k.tsx("div",{key:this,class:this.classes({[u.CSS.base]:t,[u.CSS.esriWidget]:t,[u.CSS.esriWidgetDisabled]:t&&"disabled"===e.state,[u.CSS.portrait]:this._portrait,[u.CSS.refined]:1===e.progress}),"aria-label":this.messages.widgetLabel,afterCreate:e=>{this.own(y.onResize(e,(e=>{this._portrait=e.contentRect.width<v.PORTRAIT_MODE_PIXEL_BREAKPOINT})))}},t&&this._renderContentForState())},a._renderContentForState=function(){switch(this.viewModel.state){case v.ElevationProfileState.Ready:return this._renderContentForReadyState();case v.ElevationProfileState.Selecting:return this._renderContentForSelectingState();case v.ElevationProfileState.Creating:return this._renderContentForCreatingState();case v.ElevationProfileState.Selected:return this._renderContentForSelectedState();case v.ElevationProfileState.Created:return this._renderContentForCreatedState();case v.ElevationProfileState.Disabled:return this._renderContentForReadyState()}},a._renderContentForReadyState=function(){const{sketchButton:e,selectButton:t}=this.visibleElements,o=this.messages;let n;if(e&&t)n=o.readyPrompt;else if(e)n=o.readyPromptCreateOnly;else if(t)n=o.readyPromptSelectOnly;else{var i;n=null==(i=o.errors)?void 0:i.noProfile}return this._renderContent({prompt:n,chart:!1,actions:E})},a._renderContentForSelectingState=function(){const e=this.view;if(o.isNone(e))return null;const t=this.messages[`selectingPrompt-${e.type}`];return this._renderContent({prompt:t,chart:!1,actions:[{type:w.SelectCancel}]})},a._renderContentForCreatingState=function(){const{view:e,viewModel:t}=this;if(o.isNone(e))return null;const n=t.hasVertices?[{type:w.SketchCancel},{type:w.SketchDone,disabled:!t.tool.interaction.canStopCreating}]:[{type:w.Select},{type:w.Sketch,disabled:!0}];if(t.errorState===v.ElevationProfileErrorState.NoValidInput){const t=this.messages[`creatingPrompt-${e.type}`];return this._renderContent({chart:!1,actions:n,prompt:t})}const i=this._getErrorMessage();return i?this._renderContent({chart:!1,actions:n,prompt:i}):this._renderContent({chart:!0,actions:n})},a._renderContentForSelectedState=function(){const e=this._getErrorMessage();return e?this._renderContent({chart:!1,actions:E,prompt:e}):this._renderContent({chart:!0,actions:E})},a._renderContentForCreatedState=function(){const e=this._getErrorMessage();return e?this._renderContent({chart:!1,actions:E,prompt:e}):this._renderContent({chart:!0,actions:E})},a._getErrorMessage=function(){var e,t;const o=P[this.viewModel.errorState];return null==(e=this.messages)||null==(t=e.errors)?void 0:t[o]},a._renderContent=function(e){const t=o.isSome(e.prompt)?this._renderPrompt(e.prompt):e.chart&&this._renderChart(),n=o.isSome(this.viewModel.input);return[k.tsx("header",{key:"header",class:u.CSS.header},this._zoomOutButtonVisible&&this._renderZoomOutButton(),this.visibleElements.clearButton&&n&&this._renderClearButton(),this.visibleElements.settingsButton&&this._settingsButton.render()),k.tsx("div",{class:u.CSS.mainContainer},...t),this.visibleElements.legend&&this._legend.render(),this._renderActions(e)]},a._renderZoomOutButton=function(){return k.tsx("button",{key:"zoom-out",class:u.CSS.zoomOutButton,bind:this,onclick:this._onZoomOutButtonClick,title:this.messages.zoomOut,type:"button"})},a._onZoomOutButtonClick=function(){o.applySome(this._chart,(e=>e.zoomOut()))},a._renderClearButton=function(){return k.tsx("button",{key:"clear-profile",class:u.CSS.clearButton,bind:this,onclick:this._onClearButtonClick,title:this.messages.clearProfile,type:"button"})},a._onClearButtonClick=function(){this.viewModel.clear()},a._renderPrompt=function(e){return[k.tsx("div",{key:"prompt-container",bind:this,class:u.CSS.promptContainer},k.tsx("p",null,e))]},a._renderChart=function(){if(!this.visibleElements.chart)return[k.tsx("div",{key:"empty-chart-container",class:u.CSS.chartContainer})];const e=this._chartIsRefined||this._canRenderChart();if(!e)return[this._renderSpinner({size:"large"}),k.tsx("div",{key:"chart-container-empty",class:u.CSS.chartContainer})];const{chartData:t,progress:n}=this.viewModel;return[o.isSome(t)&&n>0&&n<1&&this._renderSpinner({size:e?"small":"large"}),k.tsx("div",{key:"chart-container",bind:this,class:u.CSS.chartContainer,afterCreate:this._onChartContainerAfterCreate,afterRemoved:this._onChartContainerRemoved})]},a._renderSpinner=function(e){return k.tsx("div",{key:"spinner",class:this.classes(u.CSS.chartSpinner,{[u.CSS.chartSpinnerSmall]:"small"===e.size}),afterCreate:this._onSpinnerAfterCreate,exitAnimation:this._onSpinnerExit})},a._onSpinnerAfterCreate=function(e){requestAnimationFrame((()=>e.classList.add(u.CSS.chartSpinnerVisible)))},a._onSpinnerExit=function(e,t){e.classList.remove(u.CSS.chartSpinnerVisible),setTimeout(t,200)},a._canRenderChart=function(){const e=this.viewModel.chartData;if(o.isNone(e))return!1;if(!this.viewModel.inputIsSketched)return e.refined;let t=0;for(const{samples:n}of e.lines)t+=o.isSome(n)?n.length:0;return e.refined||t<=v.LARGE_CHART_SAMPLES},a._renderActions=function({actions:e}){const t=e.map((e=>{switch(e.type){case w.Sketch:return this.visibleElements.sketchButton&&this._renderAction({action:e,onClick:this._onSketchButtonClick,className:u.CSS.sketchButton,label:this.messages.sketchButtonLabel});case w.SketchCancel:return this.visibleElements.sketchButton&&this._renderAction({action:e,onClick:this._onCancelButtonClick,className:u.CSS.sketchCancelButton,label:this.messagesCommon.cancel});case w.SketchDone:return this.visibleElements.sketchButton&&this._renderAction({action:e,onClick:this._onDoneButtonClick,className:u.CSS.sketchDoneButton,label:this.messagesCommon.done});case w.Select:return this.visibleElements.selectButton&&this._renderAction({action:e,onClick:this._onSelectButtonClick,className:u.CSS.selectButton,label:this.messages.selectButtonLabel});case w.SelectCancel:return this.visibleElements.selectButton&&this._renderAction({action:e,onClick:this._onCancelButtonClick,className:u.CSS.selectCancelButton,label:this.messagesCommon.cancel})}})).filter(Boolean);return t.length?k.tsx("footer",{key:"footer",class:u.CSS.footer},...t):null},a._renderAction=function({action:e,onClick:t,className:o,label:n}){return k.tsx("button",{key:`action-${e.type}`,class:this.classes(u.CSS.actionButton,o,{[u.CSS.buttonDisabled]:e.disabled}),bind:this,disabled:e.disabled,onclick:t,type:"button"},n)},a._onSketchButtonClick=function(){this.viewModel.start({mode:"sketch"})},a._onSelectButtonClick=function(){this.viewModel.start({mode:"select"})},a._onCancelButtonClick=function(){this.viewModel.cancel()},a._onDoneButtonClick=function(){this.viewModel.stop()},a._updateChart=function(e){const{data:t,chart:n,messages:i,stationary:r}=e;!o.isNone(n)&&!o.isNone(i)&&r&&this._canRenderChart()&&(n.update(e),this._chartIsRefined=o.isSome(t)&&t.refined)},a._onChartContainerAfterCreate=function(e){this._chartContainer=e},a._onChartContainerRemoved=function(){this._chartContainer=null},a._initializeChart=function(){var t=e._asyncToGenerator((function*(e,t){this._chart=yield S.createChart({container:e,abortOptions:{signal:t},onRangeChange:(e,t)=>{this._zoomOutButtonVisible=1!==e||1!==t},onCursorPositionChange:e=>{this.viewModel.hoveredChartPosition=e}}),this._updateChart(this._chartUpdateParams)}));function o(e,o){return t.apply(this,arguments)}return o}(),a._destroyChart=function(){this._chartInitTask=o.abortMaybe(this._chartInitTask),this._chart=o.destroyMaybe(this._chart),this._chartIsRefined=!1},e._createClass(s,[{key:"_chartUpdateParams",get:function(){const e=this.view;return this._getChartUpdateParamsMemoized(this._chart,this.viewModel.chartData,!o.isSome(e)||e.stationary,this._chartMessages)}},{key:"_chartMessages",get:function(){return{...this.messagesUnits,...this.messages}}},{key:"_legendProps",get:function(){return this._getDetailsPropsMemoized(this.viewModel.effectiveUnits,this._profilesArray)}},{key:"_profilesArray",get:function(){return this.profiles.toArray()}},{key:"_settingsButtonProps",get:function(){return{viewModel:this.viewModel,visibleElements:this.visibleElements}}}]),s}(p);t.__decorate([h.property({type:_})],B.prototype,"viewModel",void 0),t.__decorate([s.aliasOf("viewModel.view")],B.prototype,"view",void 0),t.__decorate([s.aliasOf("viewModel.input")],B.prototype,"input",void 0),t.__decorate([s.aliasOf("viewModel.profiles")],B.prototype,"profiles",void 0),t.__decorate([s.aliasOf("viewModel.unitOptions")],B.prototype,"unitOptions",void 0),t.__decorate([s.aliasOf("viewModel.unit")],B.prototype,"unit",void 0),t.__decorate([s.aliasOf("viewModel.geodesicDistanceThreshold")],B.prototype,"geodesicDistanceThreshold",void 0),t.__decorate([h.property({type:C,nonNullable:!0})],B.prototype,"visibleElements",void 0),t.__decorate([h.property()],B.prototype,"iconClass",void 0),t.__decorate([s.aliasOf("messages.widgetLabel",{overridable:!0})],B.prototype,"label",void 0),t.__decorate([s.aliasOf("viewModel.visible")],B.prototype,"visible",void 0),t.__decorate([h.property(),g.messageBundle("esri/widgets/ElevationProfile/t9n/ElevationProfile")],B.prototype,"messages",void 0),t.__decorate([h.property(),g.messageBundle("esri/t9n/common")],B.prototype,"messagesCommon",void 0),t.__decorate([h.property(),g.messageBundle("esri/core/t9n/Units")],B.prototype,"messagesUnits",void 0),t.__decorate([h.property()],B.prototype,"_chartContainer",void 0),t.__decorate([h.property()],B.prototype,"_chart",void 0),t.__decorate([h.property()],B.prototype,"_chartInitTask",void 0),t.__decorate([h.property()],B.prototype,"_chartIsRefined",void 0),t.__decorate([h.property()],B.prototype,"_settingsButton",void 0),t.__decorate([h.property()],B.prototype,"_legend",void 0),t.__decorate([h.property()],B.prototype,"_portrait",void 0),t.__decorate([h.property()],B.prototype,"_zoomOutButtonVisible",void 0),t.__decorate([h.property()],B.prototype,"_chartUpdateParams",null),t.__decorate([h.property()],B.prototype,"_chartMessages",null),t.__decorate([h.property()],B.prototype,"_legendProps",null),t.__decorate([h.property()],B.prototype,"_profilesArray",null),t.__decorate([h.property()],B.prototype,"_settingsButtonProps",null),B=t.__decorate([d.subclass("esri.widgets.ElevationProfile")],B);return B}));
