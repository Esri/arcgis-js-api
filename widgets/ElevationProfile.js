/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/asyncUtils","../core/maybe","../core/memoize","../core/promiseUtils","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/ensureType","../core/arrayUtils","../core/accessorSupport/decorators/subclass","./Widget","./ElevationProfile/css","./ElevationProfile/ElevationProfileViewModel","./ElevationProfile/ElevationProfileVisibleElements","./ElevationProfile/components/Legend","./ElevationProfile/components/SettingsButton","./ElevationProfile/support/chartUtils","./ElevationProfile/support/constants","./support/widgetUtils","./support/decorators/messageBundle","./support/jsxFactory"],(function(e,t,n,o,r,i,s,a,l,c,h,d,p,u,_,f,C,m,y,S,v,g){"use strict";var k;!function(e){e.Sketch="sketch",e.SketchCancel="sketch-cancel",e.SketchDone="sketch-done",e.Select="select",e.SelectCancel="select-cancel"}(k||(k={}));const b=[{type:k.Select},{type:k.Sketch}],w={[y.ElevationProfileErrorState.None]:null,[y.ElevationProfileErrorState.NoValidInput]:"noProfile",[y.ElevationProfileErrorState.NoVisibleProfiles]:"noProfile",[y.ElevationProfileErrorState.RefinedButNoChartData]:"noProfile",[y.ElevationProfileErrorState.TooComplex]:"tooComplex",[y.ElevationProfileErrorState.UnknownError]:"unknown",[y.ElevationProfileErrorState.InvalidGeometry]:"invalidGeometry",[y.ElevationProfileErrorState.InvalidElevationInfo]:"invalidElevationInfo"},E=Symbol("resize-observer-handle");let M=function(t){function a(e,n){var o;return(o=t.call(this,e,n)||this).viewModel=null,o.visibleElements=new _,o.iconClass=p.CSS.widgetIcon,o.messages=null,o.messagesCommon=null,o.messagesUnits=null,o._chartContainer=null,o._chart=null,o._chartInitTask=null,o._chartIsRefined=!1,o._width=0,o._zoomOutButtonVisible=!1,o._getChartUpdateParamsMemoized=r.memoize(((e,t,n,o)=>({chart:e,data:t,stationary:n,messages:o}))),o._getDetailsPropsMemoized=r.memoize(((e,t)=>({effectiveUnits:e,profiles:t}))),e?.viewModel||(o._defaultViewModel=new u({view:e?.view}),o.viewModel=o._defaultViewModel),o}e._inheritsLoose(a,t);var l=a.prototype;return l.initialize=function(){this._legend=new f.Legend(this._legendProps),this._settingsButton=new C.SettingsButton(this._settingsButtonProps),this.addHandles([s.watch((()=>this._legendProps),(e=>this._legend.set(e))),s.watch((()=>this._settingsButtonProps),(e=>this._settingsButton.set(e)))])},l.postInitialize=function(){this.addHandles([s.watch((()=>({container:this._chartContainer,width:this._width})),(({container:e,width:t})=>{this._destroyChart(),o.isSome(e)&&t>0&&this._initializeChart(e)}),s.initial),s.watch((()=>this._chartUpdateParams),(()=>this._updateChart(this._chartUpdateParams)),s.initial)])},l.destroy=function(){this._destroyChart(),o.isSome(this._defaultViewModel)&&this.viewModel!==this._defaultViewModel&&this._defaultViewModel.destroy(),this._legend=o.destroyMaybe(this._legend),this._settingsButton=o.destroyMaybe(this._settingsButton)},l.render=function(){const{viewModel:e,visible:t}=this;return g.tsx("div",{key:this,class:this.classes({[p.CSS.base]:t,[p.CSS.esriWidget]:t,[p.CSS.esriWidgetDisabled]:t&&"disabled"===e.state,[p.CSS.portrait]:this._portrait,[p.CSS.refined]:1===e.progress}),"aria-label":this.messages.widgetLabel},g.tsx("div",{key:"content-wrapper",bind:this,afterCreate:this._onContentWrapperAfterCreate,afterRemoved:this._onContentWrapperRemoved},t&&this._renderContentForState()))},l._renderContentForState=function(){switch(this.viewModel.state){case y.ElevationProfileState.Ready:return this._renderContentForReadyState();case y.ElevationProfileState.Selecting:return this._renderContentForSelectingState();case y.ElevationProfileState.Creating:return this._renderContentForCreatingState();case y.ElevationProfileState.Selected:return this._renderContentForSelectedState();case y.ElevationProfileState.Created:return this._renderContentForCreatedState();case y.ElevationProfileState.Disabled:return this._renderContentForReadyState()}},l._renderContentForReadyState=function(){const{sketchButton:e,selectButton:t}=this.visibleElements,n=this.messages;let o;return o=e&&t?n.readyPrompt:e?n.readyPromptCreateOnly:t?n.readyPromptSelectOnly:n.errors?.noProfile,this._renderContent({prompt:o,chart:!1,actions:b})},l._renderContentForSelectingState=function(){const e=this.view;if(o.isNone(e))return null;const t=this.messages[`selectingPrompt-${e.type}`];return this._renderContent({prompt:t,chart:!1,actions:[{type:k.SelectCancel}]})},l._renderContentForCreatingState=function(){const{view:e,viewModel:t}=this;if(o.isNone(e))return null;const n=t.hasVertices?[{type:k.SketchCancel},{type:k.SketchDone,disabled:!t.tool.interaction.canStopCreating}]:[{type:k.Select},{type:k.Sketch,disabled:!0}];if(t.errorState===y.ElevationProfileErrorState.NoValidInput){const t=this.messages[`creatingPrompt-${e.type}`];return this._renderContent({chart:!1,actions:n,prompt:t})}const r=this._getErrorMessage();return r?this._renderContent({chart:!1,actions:n,prompt:r}):this._renderContent({chart:!0,actions:n})},l._renderContentForSelectedState=function(){const e=this._getErrorMessage();return e?this._renderContent({chart:!1,actions:b,prompt:e}):this._renderContent({chart:!0,actions:b})},l._renderContentForCreatedState=function(){const e=this._getErrorMessage();return e?this._renderContent({chart:!1,actions:b,prompt:e}):this._renderContent({chart:!0,actions:b})},l._getErrorMessage=function(){const e=w[this.viewModel.errorState];return e?this.messages?.errors?.[e]:null},l._renderContent=function(e){const t=o.isSome(e.prompt)?this._renderPrompt(e.prompt):e.chart&&this._renderChart(),n=o.isSome(this.viewModel.input);return[g.tsx("header",{key:"header",class:p.CSS.header},this._zoomOutButtonVisible&&this._renderZoomOutButton(),this.visibleElements.clearButton&&n&&this._renderClearButton(),this.visibleElements.settingsButton&&this._settingsButton.render()),g.tsx("div",{class:p.CSS.mainContainer},t),this.visibleElements.legend&&this._legend.render(),this._renderActions(e)]},l._renderZoomOutButton=function(){return g.tsx("button",{key:"zoom-out",class:p.CSS.zoomOutButton,bind:this,onclick:this._onZoomOutButtonClick,title:this.messages.zoomOut,type:"button"})},l._onZoomOutButtonClick=function(){o.applySome(this._chart,(e=>e.zoomOut()))},l._renderClearButton=function(){return g.tsx("button",{key:"clear-profile",class:p.CSS.clearButton,bind:this,onclick:this._onClearButtonClick,title:this.messages.clearProfile,type:"button"})},l._onClearButtonClick=function(){this.viewModel.clear()},l._renderPrompt=function(e){return[g.tsx("div",{key:"prompt-container",bind:this,class:p.CSS.promptContainer},g.tsx("p",null,e))]},l._renderChart=function(){if(!this.visibleElements.chart)return[g.tsx("div",{key:"empty-chart-container",class:p.CSS.chartContainer})];const e=this._chartIsRefined||this._canRenderChart();if(!e)return[this._renderSpinner({size:"large"}),g.tsx("div",{key:"chart-container-empty",class:p.CSS.chartContainer})];const{chartData:t,progress:n}=this.viewModel;return[o.isSome(t)&&n>0&&n<1&&this._renderSpinner({size:e?"small":"large"}),g.tsx("div",{key:"chart-container",bind:this,class:p.CSS.chartContainer,afterCreate:this._onChartContainerAfterCreate,afterRemoved:this._onChartContainerRemoved})]},l._renderSpinner=function(e){return g.tsx("div",{key:"spinner",class:this.classes(p.CSS.chartSpinner,{[p.CSS.chartSpinnerSmall]:"small"===e.size}),afterCreate:this._onSpinnerAfterCreate,exitAnimation:this._onSpinnerExit})},l._onSpinnerAfterCreate=function(e){requestAnimationFrame((()=>e.classList.add(p.CSS.chartSpinnerVisible)))},l._onSpinnerExit=function(e,t){e.classList.remove(p.CSS.chartSpinnerVisible),setTimeout(t,200)},l._canRenderChart=function(){const e=this.viewModel.chartData;if(o.isNone(e))return!1;if(!this.viewModel.inputIsSketched)return e.refined;let t=0;for(const{samples:n}of e.lines)t+=o.isSome(n)?n.length:0;return e.refined||t<=y.getConfig().largeChartSamples},l._renderActions=function({actions:e}){const t=e.map((e=>{switch(e.type){case k.Sketch:return this.visibleElements.sketchButton&&this._renderAction({action:e,onClick:this._onSketchButtonClick,className:p.CSS.sketchButton,label:this.messages.sketchButtonLabel});case k.SketchCancel:return this.visibleElements.sketchButton&&this._renderAction({action:e,onClick:this._onCancelButtonClick,className:p.CSS.sketchCancelButton,label:this.messagesCommon.cancel});case k.SketchDone:return this.visibleElements.sketchButton&&this._renderAction({action:e,onClick:this._onDoneButtonClick,className:p.CSS.sketchDoneButton,label:this.messagesCommon.done});case k.Select:return this.visibleElements.selectButton&&this._renderAction({action:e,onClick:this._onSelectButtonClick,className:p.CSS.selectButton,label:this.messages.selectButtonLabel});case k.SelectCancel:return this.visibleElements.selectButton&&this._renderAction({action:e,onClick:this._onCancelButtonClick,className:p.CSS.selectCancelButton,label:this.messagesCommon.cancel})}})).filter(Boolean);return t.length?g.tsx("footer",{key:"footer",class:p.CSS.footer},t):null},l._renderAction=function({action:e,onClick:t,className:n,label:o}){return g.tsx("button",{key:`action-${e.type}`,class:this.classes(p.CSS.actionButton,n,{[p.CSS.buttonDisabled]:!!e.disabled}),bind:this,disabled:e.disabled,onclick:t,type:"button"},o)},l._onSketchButtonClick=function(){this.viewModel.start({mode:"sketch"})},l._onSelectButtonClick=function(){this.viewModel.start({mode:"select"})},l._onCancelButtonClick=function(){this.viewModel.cancel()},l._onDoneButtonClick=function(){this.viewModel.stop()},l._onContentWrapperAfterCreate=function(e){const t=S.onResize(e,(e=>{this._width=e.contentRect.width}));this.addHandles(t,E)},l._onContentWrapperRemoved=function(){this.removeHandles(E)},l._updateChart=function(e){const{data:t,chart:n,messages:r,stationary:i}=e;!o.isNone(n)&&!o.isNone(r)&&i&&this._canRenderChart()&&(n.update(e),this._chartIsRefined=o.isSome(t)&&t.refined)},l._onChartContainerAfterCreate=function(e){this._chartContainer=e},l._onChartContainerRemoved=function(){this._chartContainer=null},l._initializeChart=function(t){var r=this;o.abortMaybe(this._chartInitTask),this._chartInitTask=n.createTask(function(){var n=e._asyncToGenerator((function*(e){const n=yield m.createChart({container:t,abortOptions:{signal:e},onRangeChange:(e,t)=>{r._zoomOutButtonVisible=1!==e||1!==t},onCursorPositionChange:e=>{r.viewModel.hoveredChartPosition=e}});if(e.aborted)throw o.destroyMaybe(n),i.createAbortError();r._chart=n,r._updateChart(r._chartUpdateParams)}));return function(e){return n.apply(this,arguments)}}())},l._destroyChart=function(){this._chartInitTask=o.abortMaybe(this._chartInitTask),this._chart=o.destroyMaybe(this._chart),this._chartIsRefined=!1},e._createClass(a,[{key:"view",get:function(){return this.viewModel.view},set:function(e){this.viewModel.view=e}},{key:"input",get:function(){return this.viewModel.input},set:function(e){this.viewModel.input=e}},{key:"profiles",get:function(){return this.viewModel.profiles},set:function(e){this.viewModel.profiles=e}},{key:"unitOptions",get:function(){return this.viewModel.unitOptions},set:function(e){this.viewModel.unitOptions=e}},{key:"unit",get:function(){return this.viewModel.unit},set:function(e){this.viewModel.unit=e}},{key:"geodesicDistanceThreshold",get:function(){return this.viewModel.geodesicDistanceThreshold},set:function(e){this.viewModel.geodesicDistanceThreshold=e}},{key:"label",get:function(){return this.messages?.widgetLabel??""},set:function(e){this._overrideIfSome("label",e)}},{key:"visible",get:function(){return this.viewModel.visible},set:function(e){this.viewModel.visible=e}},{key:"_portrait",get:function(){return this._width<y.getConfig().portraitModePixelBreakpoint}},{key:"_chartUpdateParams",get:function(){const e=this.view;return this._getChartUpdateParamsMemoized(this._chart,this.viewModel.chartData,!o.isSome(e)||e.stationary,this._chartMessages)}},{key:"_chartMessages",get:function(){return{...this.messagesUnits,...this.messages}}},{key:"_legendProps",get:function(){return this._getDetailsPropsMemoized(this.viewModel.effectiveUnits,this._profilesArray)}},{key:"_profilesArray",get:function(){return this.profiles.toArray()}},{key:"_settingsButtonProps",get:function(){return{viewModel:this.viewModel,visibleElements:this.visibleElements}}},{key:"test",get:function(){return{chart:this._chart}}}]),a}(d);t.__decorate([a.property({type:u})],M.prototype,"viewModel",void 0),t.__decorate([a.property()],M.prototype,"view",null),t.__decorate([a.property()],M.prototype,"input",null),t.__decorate([a.property()],M.prototype,"profiles",null),t.__decorate([a.property()],M.prototype,"unitOptions",null),t.__decorate([a.property()],M.prototype,"unit",null),t.__decorate([a.property()],M.prototype,"geodesicDistanceThreshold",null),t.__decorate([a.property({type:_,nonNullable:!0})],M.prototype,"visibleElements",void 0),t.__decorate([a.property()],M.prototype,"iconClass",void 0),t.__decorate([a.property()],M.prototype,"label",null),t.__decorate([a.property()],M.prototype,"visible",null),t.__decorate([a.property(),v.messageBundle("esri/widgets/ElevationProfile/t9n/ElevationProfile")],M.prototype,"messages",void 0),t.__decorate([a.property(),v.messageBundle("esri/t9n/common")],M.prototype,"messagesCommon",void 0),t.__decorate([a.property(),v.messageBundle("esri/core/t9n/Units")],M.prototype,"messagesUnits",void 0),t.__decorate([a.property()],M.prototype,"_chartContainer",void 0),t.__decorate([a.property()],M.prototype,"_chart",void 0),t.__decorate([a.property()],M.prototype,"_chartInitTask",void 0),t.__decorate([a.property()],M.prototype,"_chartIsRefined",void 0),t.__decorate([a.property()],M.prototype,"_settingsButton",void 0),t.__decorate([a.property()],M.prototype,"_legend",void 0),t.__decorate([a.property()],M.prototype,"_width",void 0),t.__decorate([a.property()],M.prototype,"_portrait",null),t.__decorate([a.property()],M.prototype,"_zoomOutButtonVisible",void 0),t.__decorate([a.property()],M.prototype,"_chartUpdateParams",null),t.__decorate([a.property()],M.prototype,"_chartMessages",null),t.__decorate([a.property()],M.prototype,"_legendProps",null),t.__decorate([a.property()],M.prototype,"_profilesArray",null),t.__decorate([a.property()],M.prototype,"_settingsButtonProps",null),M=t.__decorate([h.subclass("esri.widgets.ElevationProfile")],M);return M}));
