/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/has","../core/maybe","../core/Logger","../core/accessorSupport/ensureType","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/aliasOf","../core/accessorSupport/decorators/subclass","../core/urlUtils","../core/uuid","../portal/support/resourceExtension","../core/promiseUtils","../core/watchUtils","../core/memoize","./support/widgetUtils","./support/decorators/messageBundle","../chunks/index","./Widget","./ElevationProfile/css","./ElevationProfile/support/constants","./ElevationProfile/ElevationProfileViewModel","./ElevationProfile/ElevationProfileVisibleElements","./ElevationProfile/components/Legend","./ElevationProfile/components/SettingsButton","./ElevationProfile/support/chartUtils"],(function(e,t,i,n,o,s,r,a,l,c,h,d,u,p,_,m,C,v,f,g,S,y,b,k,w,B){"use strict";const P=[{type:"select"},{type:"sketch"}],M={none:null,"no-valid-input":"noProfile","no-visible-profiles":"noProfile","refined-but-no-chart-data":"noProfile","too-complex":"tooComplex","unknown-error":"unknown","invalid-geometry":"invalidGeometry","invalid-elevation-info":"invalidElevationInfo"};let E=function(t){function i(e,i){var n;return(n=t.call(this,e,i)||this).viewModel=null,n.view=null,n.input=null,n.profiles=null,n.unitOptions=[],n.unit="metric",n.geodesicDistanceThreshold=1e5,n.visibleElements=new b,n.iconClass=g.CSS.widgetIcon,n.label=void 0,n.messages=null,n.messagesCommon=null,n.messagesUnits=null,n._chartContainer=null,n._chart=null,n._resizeObserver=null,n._portrait=!1,n._zoomOutButtonVisible=!1,n._chartInitTask=null,n._getChartUpdateParamsMemoized=_.memoize(((e,t,i,n)=>({chart:e,data:t,stationary:i,messages:n}))),n._getDetailsPropsMemoized=_.memoize(((e,t)=>({effectiveUnits:e,profiles:t}))),n._getSettingsButtonPropsMemoized=_.memoize(((e,t,i)=>({unit:e,unitOptions:t,onUnitChange:i}))),n._onUnitChange=e=>{n.unit=e},null!=e&&e.viewModel||(n._defaultViewModel=new y({view:null==e?void 0:e.view}),n.viewModel=n._defaultViewModel),n}e._inheritsLoose(i,t);var o=i.prototype;return o.initialize=function(){this._settingsButton=new w.SettingsButton(this._settingsButtonProps),this.own(this.watch("_detailsProps",(e=>{this._legend.set(e)}))),this._legend=new k.Legend(this._detailsProps),this.own(this.watch("_settingsButtonProps",(e=>{this._settingsButton.set(e)})))},o.postInitialize=function(){this.own([p.init(this,"_chartContainer",(()=>{this._destroyChart();const e=this._chartContainer;n.isNone(e)||(this._chartInitTask=u.createTask((t=>this._initializeChart(e,t))))})),p.init(this,"_chartUpdateParams",(()=>this._updateChart()))])},o.destroy=function(){this._destroyChart(),n.isSome(this._defaultViewModel)&&this.viewModel!==this._defaultViewModel&&this._defaultViewModel.destroy(),this._legend=n.destroyMaybe(this._legend),this._settingsButton=n.destroyMaybe(this._settingsButton),n.isSome(this._resizeObserver)&&(this._resizeObserver.disconnect(),this._resizeObserver=null)},o.render=function(){const{viewModel:e,visible:t}=this;return v.jsx("div",{key:this,class:this.classes({[g.CSS.base]:t,[g.CSS.esriWidget]:t,[g.CSS.esriWidgetDisabled]:t&&"disabled"===e.state,[g.CSS.portrait]:this._portrait,[g.CSS.refined]:1===this.viewModel.progress}),bind:this,afterCreate:this._onAfterCreate,"aria-label":this.messages.widgetLabel},t&&this._renderContentForState())},o._renderContentForState=function(){switch(this.viewModel.state){case S.ElevationProfileState.Ready:return this._renderContentForReadyState();case S.ElevationProfileState.Selecting:return this._renderContentForSelectingState();case S.ElevationProfileState.Creating:return this._renderContentForCreatingState();case S.ElevationProfileState.Selected:return this._renderContentForSelectedState();case S.ElevationProfileState.Created:return this._renderContentForCreatedState();case S.ElevationProfileState.Disabled:return this._renderContentForReadyState()}},o._renderContentForReadyState=function(){const{sketchButton:e,selectButton:t}=this.visibleElements,i=this.messages;let n;if(e&&t)n=i.readyPrompt;else if(e)n=i.readyPromptCreateOnly;else if(t)n=i.readyPromptSelectOnly;else{var o;n=null==(o=i.errors)?void 0:o.noProfile}return this._renderContent({prompt:n,chart:!1,actions:P})},o._renderContentForSelectingState=function(){const e=this.view;if(n.isNone(e))return null;const t=this.messages[`selectingPrompt-${e.type}`];return this._renderContent({prompt:t,chart:!1,actions:[{type:"select-cancel"}]})},o._renderContentForCreatingState=function(){const{view:e,viewModel:t}=this;if(n.isNone(e))return null;const i=t.hasVertices?[{type:"sketch-cancel"},{type:"sketch-done",disabled:!t.tool.interaction.canStopCreating}]:[{type:"select"},{type:"sketch",disabled:!0}];if("no-valid-input"===t.errorState){const t=this.messages[`creatingPrompt-${e.type}`];return this._renderContent({chart:!1,actions:i,prompt:t})}const o=this._getErrorMessage();return o?this._renderContent({chart:!1,actions:i,prompt:o}):this._renderContent({chart:!0,actions:i})},o._renderContentForSelectedState=function(){const e=this._getErrorMessage();return e?this._renderContent({chart:!1,actions:P,prompt:e}):this._renderContent({chart:!0,actions:P})},o._renderContentForCreatedState=function(){const e=this._getErrorMessage();return e?this._renderContent({chart:!1,actions:P,prompt:e}):this._renderContent({chart:!0,actions:P})},o._getErrorMessage=function(){var e,t;const i=M[this.viewModel.errorState];return null==(e=this.messages)||null==(t=e.errors)?void 0:t[i]},o._renderContent=function(e){const t=n.isSome(e.prompt)?this._renderPrompt(e.prompt):e.chart&&this._renderChart();return[v.jsx("header",{key:"header",class:g.CSS.header},this._zoomOutButtonVisible&&this._renderZoomOutButton(),this.visibleElements.settingsButton&&this._settingsButton.render()),v.jsx("div",{class:g.CSS.mainContainer},t),this.visibleElements.legend&&this._legend.render(),this._renderActions(e)]},o._renderZoomOutButton=function(){return v.jsx("button",{key:"zoom-out",class:g.CSS.zoomOutButton,bind:this,onclick:this._onZoomOutButtonClick,title:this.messages.zoomOut})},o._onZoomOutButtonClick=function(){n.applySome(this._chart,(e=>e.zoomOut()))},o._renderPrompt=function(e){return[v.jsx("div",{key:"prompt-container",bind:this,class:g.CSS.promptContainer},v.jsx("p",null,e))]},o._renderChart=function(){if(!this.visibleElements.chart)return[v.jsx("div",{key:"empty-chart-container",class:g.CSS.chartContainer})];const{chartData:e,progress:t}=this.viewModel,i=this._canRenderChart(e);if(!i)return[this._renderSpinner({size:"large"}),v.jsx("div",{key:"chart-container-empty",class:g.CSS.chartContainer})];return[n.isSome(e)&&t>0&&t<1&&this._renderSpinner({size:i?"small":"large"}),v.jsx("div",{key:"chart-container",bind:this,class:g.CSS.chartContainer,afterCreate:this._onChartContainerAfterCreate,afterRemoved:this._onChartContainerRemoved})]},o._renderSpinner=function(e){return v.jsx("div",{key:"spinner",class:this.classes(g.CSS.chartSpinner,{[g.CSS.chartSpinnerSmall]:"small"===e.size}),enterAnimation:this._spinnerEnterAnimation,exitAnimation:this._spinnerExitAnimation})},o._spinnerEnterAnimation=function(e){requestAnimationFrame((()=>e.classList.add(g.CSS.chartSpinnerVisible)))},o._spinnerExitAnimation=function(e,t){e.classList.remove(g.CSS.chartSpinnerVisible),setTimeout(t,200)},o._canRenderChart=function(e){if(n.isNone(e))return!1;if(!this.viewModel.inputIsSketched)return e.fullyRefined;const t=e.lines.reduce(((e,{samples:t})=>n.isSome(t)?e+t.length:e),0);return e.fullyRefined||t<=S.LARGE_CHART_SAMPLES},o._renderActions=function({actions:e}){const t=e.map((e=>{switch(e.type){case"sketch":return this.visibleElements.sketchButton&&this._renderAction({action:e,onClick:this._onSketchButtonClick,className:g.CSS.sketchButton,label:this.messages.sketchButtonLabel});case"sketch-cancel":return this.visibleElements.sketchButton&&this._renderAction({action:e,onClick:this._onCancelButtonClick,className:g.CSS.sketchCancelButton,label:this.messagesCommon.cancel});case"sketch-done":return this.visibleElements.sketchButton&&this._renderAction({action:e,onClick:this._onDoneButtonClick,className:g.CSS.sketchDoneButton,label:this.messagesCommon.done});case"select":return this.visibleElements.selectButton&&this._renderAction({action:e,onClick:this._onSelectButtonClick,className:g.CSS.selectButton,label:this.messages.selectButtonLabel});case"select-cancel":return this.visibleElements.selectButton&&this._renderAction({action:e,onClick:this._onCancelButtonClick,className:g.CSS.selectCancelButton,label:this.messagesCommon.cancel})}})).filter(Boolean);return t.length?v.jsx("footer",{key:"footer",class:g.CSS.footer},t):null},o._renderAction=function({action:e,onClick:t,className:i,label:n}){return v.jsx("button",{key:`action-${e.type}`,class:this.classes(g.CSS.actionButton,i,{[g.CSS.buttonDisabled]:e.disabled}),bind:this,disabled:e.disabled,onclick:t},n)},o._onSketchButtonClick=function(){this.viewModel.start({mode:"sketch"})},o._onSelectButtonClick=function(){this.viewModel.start({mode:"select"})},o._onCancelButtonClick=function(){this.viewModel.cancel()},o._onDoneButtonClick=function(){this.viewModel.stop()},o._updateChart=function(){const e=this._chartUpdateParams;e.stationary&&n.isSome(e.chart)&&e.messages&&e.chart.update(e)},o._onChartContainerAfterCreate=function(e){this._chartContainer=e},o._onChartContainerRemoved=function(){this._chartContainer=null},o._initializeChart=async function(e,t){this._chart=await B.createChart({container:e,abortOptions:{signal:t},onRangeChange:e=>{this._zoomOutButtonVisible=1!==e},onCursorPositionChange:e=>{this.viewModel.hoveredChartPosition=e}}),this._updateChart()},o._destroyChart=function(){n.isSome(this._chartInitTask)&&(this._chartInitTask.abort(),this._chartInitTask=null),n.isSome(this._chart)&&(this._chart.destroy(),this._chart=null)},o._onAfterCreate=function(e){const t=()=>{this._portrait=e.getBoundingClientRect().width<S.PORTRAIT_MODE_PIXEL_BREAKPOINT};t(),this._resizeObserver=new ResizeObserver((()=>t())),this._resizeObserver.observe(e)},e._createClass(i,[{key:"_chartUpdateParams",get:function(){const e=this.view;return this._getChartUpdateParamsMemoized(this._chart,this.viewModel.chartData,!n.isSome(e)||e.stationary,this._chartMessages)}},{key:"_chartMessages",get:function(){return{...this.messagesUnits,...this.messages}}},{key:"_detailsProps",get:function(){return this._getDetailsPropsMemoized(this.viewModel.effectiveUnits,this._profilesArray)}},{key:"_profilesArray",get:function(){return this.profiles.toArray()}},{key:"_settingsButtonProps",get:function(){return this._getSettingsButtonPropsMemoized(this.unit,this.unitOptions,this._onUnitChange)}}]),i}(f);return t.__decorate([r.property({type:y})],E.prototype,"viewModel",void 0),t.__decorate([a.aliasOf("viewModel.view")],E.prototype,"view",void 0),t.__decorate([a.aliasOf("viewModel.input")],E.prototype,"input",void 0),t.__decorate([a.aliasOf("viewModel.profiles")],E.prototype,"profiles",void 0),t.__decorate([a.aliasOf("viewModel.unitOptions")],E.prototype,"unitOptions",void 0),t.__decorate([a.aliasOf("viewModel.unit")],E.prototype,"unit",void 0),t.__decorate([a.aliasOf("viewModel.geodesicDistanceThreshold")],E.prototype,"geodesicDistanceThreshold",void 0),t.__decorate([r.property({type:b,nonNullable:!0})],E.prototype,"visibleElements",void 0),t.__decorate([r.property()],E.prototype,"iconClass",void 0),t.__decorate([a.aliasOf("messages.widgetLabel",{overridable:!0})],E.prototype,"label",void 0),t.__decorate([a.aliasOf("viewModel.visible")],E.prototype,"visible",void 0),t.__decorate([r.property(),C.messageBundle("esri/widgets/ElevationProfile/t9n/ElevationProfile")],E.prototype,"messages",void 0),t.__decorate([r.property(),C.messageBundle("esri/t9n/common")],E.prototype,"messagesCommon",void 0),t.__decorate([r.property(),C.messageBundle("esri/core/t9n/Units")],E.prototype,"messagesUnits",void 0),t.__decorate([r.property()],E.prototype,"_chartContainer",void 0),t.__decorate([r.property()],E.prototype,"_chart",void 0),t.__decorate([r.property()],E.prototype,"_settingsButton",void 0),t.__decorate([r.property()],E.prototype,"_legend",void 0),t.__decorate([r.property()],E.prototype,"_portrait",void 0),t.__decorate([r.property()],E.prototype,"_zoomOutButtonVisible",void 0),t.__decorate([r.property()],E.prototype,"_chartUpdateParams",null),t.__decorate([r.property()],E.prototype,"_chartMessages",null),t.__decorate([r.property()],E.prototype,"_detailsProps",null),t.__decorate([r.property()],E.prototype,"_profilesArray",null),t.__decorate([r.property()],E.prototype,"_settingsButtonProps",null),E=t.__decorate([l.subclass("esri.widgets.ElevationProfile")],E),E}));
