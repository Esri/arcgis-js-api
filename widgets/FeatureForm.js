// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../intl","../core/domUtils","../core/accessorSupport/decorators","../intl/moment","../layers/support/domains","../layers/support/fieldUtils","./Widget","./FeatureForm/FeatureFormViewModel","./support/widget"],(function(e,t,i,a,r,n,l,s,o,d,u,p){"use strict";var f="esri-feature-form",c="esri-feature-form__form",_="esri-feature-form__label",h="esri-feature-form__input",m="esri-feature-form__input--date",v="esri-feature-form__input--time",y="esri-feature-form__input--disabled",g="esri-feature-form__input--invalid",b="esri-feature-form__input-icon--invalid",F="esri-feature-form__field-error-message",w="esri-feature-form__description-text",x="esri-feature-form__date-input-part",D="esri-feature-form__date-input-part--lone",I="esri-feature-form__date-input-container",M="esri-feature-form__date-format-hint",V="esri-feature-form__group",N="esri-feature-form__group-label",C="esri-feature-form__group-header",k="esri-feature-form__group-description",O="esri-feature-form__group--collapsed",E="esri-feature-form__group--sequential",T="esri-feature-form__group--active",S="esri-icon-notice-triangle",K="esri-widget",L="esri-widget--panel",U="esri-input",A="esri-select",G="esri-widget__heading",B="L",R="LTS";function q(e){return e&&e.inputFields}return function(e){function t(t,i){var a=e.call(this,t,i)||this;return a._fieldFocusNeeded=!1,a._activeDateEdit=null,a._activeInputName=null,a._moment=null,a.description=null,a.feature=null,a.fieldConfig=null,a.formTemplate=null,a.groupDisplay="all",a.label=void 0,a.layer=null,a.messages=null,a.strict=null,a.title=null,a.viewModel=new u,a._handleFormKeyDown=a._handleFormKeyDown.bind(a),a._handleInputBlur=a._handleInputBlur.bind(a),a._handleInputFocus=a._handleInputFocus.bind(a),a._handleNumberInputMouseDown=a._handleNumberInputMouseDown.bind(a),a._handleInputKeyDown=a._handleInputKeyDown.bind(a),a._handleOptionChange=a._handleOptionChange.bind(a),a._handleGroupClick=a._handleGroupClick.bind(a),a._handleSubmit=a._handleSubmit.bind(a),a._afterScrollerCreateOrUpdate=a._afterScrollerCreateOrUpdate.bind(a),a}return i.__extends(t,e),t.prototype.loadLocale=function(){return i.__awaiter(this,void 0,void 0,(function(){var e;return i.__generator(this,(function(t){switch(t.label){case 0:return e=this,[4,l.loadMoment()];case 1:return e._moment=t.sent(),[2]}}))}))},t.prototype.initialize=function(){var e=this;this.own(this.watch("feature",(function(){var t=e._getFocusableInput("forward");e._activeInputName=t&&t.name,e._fieldFocusNeeded=!0})),this.on("submit",(function(t){if(t.invalid.length>0){var i=t.invalid[0];e._activeInputName=i,e._fieldFocusNeeded=!0,e.scheduleRender()}})))},t.prototype.getValues=function(){return null},t.prototype.submit=function(){return null},t.prototype.render=function(){var e=this.viewModel.state;return p.tsx("div",{class:this.classes(f,K,L)},"ready"===e?this.renderForm():null)},t.prototype.renderForm=function(){var e=this.title?p.tsx("h1",{class:G,key:"title"},this.title):null,t=this.description?p.tsx("h2",{class:G,key:"description"},this.description):null;return p.tsx("form",{class:c,novalidate:!0,onsubmit:this._handleSubmit,onkeydown:this._handleFormKeyDown},e,t,this.renderFields())},t.prototype.renderFields=function(){var e=this;return this.viewModel.inputFields.map((function(t,i){return q(t)?e.renderGroup(t,i):e.renderLabeledField(t)}))},t.prototype.renderGroup=function(e,t){var i=this,a=e.description,r=e.label,n=e.inputFields,l=e.state,s=this.viewModel.findField(this._activeInputName),o=!(!s||s.group!==e),d=this.id+"_group_"+t,u=this.id+"_group-label_"+t,f=this.id+"_group-description_"+t,c=a?p.tsx("p",{class:this.classes(k,w),id:f},a):null,_="sequential"===this.groupDisplay,h=_?o:"expanded"===l;return p.tsx("fieldset",{"aria-expanded":h.toString(),"aria-labelledby":u,"aria-describedby":a?f:"",class:this.classes(V,_?E:null,h?null:O,o?T:null),"data-group":e,id:d,key:t,onclick:this._handleGroupClick},p.tsx("div",{class:C},p.tsx("div",{class:N,id:u},r),c),n.map((function(e){return i.renderLabeledField(e)})))},t.prototype._getFocusableInput=function(e,t){var i,a=this.viewModel._allInputFields,r="forward"===e?a:a.slice().reverse();if(t)if(q(t))i=r.indexOf(t.inputFields[0]);else{var n=void 0;if(this._isFieldInClosedCollapsibleGroup(t)){var l=t.group.inputFields;n="forward"===e?l[l.length-1]:l[0]}else n=t;i=r.indexOf(n)+1}else i=0;for(var s=i;s<r.length;s++){var o=r[s];if(o.visible&&o.editable)return o}return null},t.prototype.renderLabeledField=function(e){var t=e.label,i=e.layer,a=e.type;return p.tsx("label",{key:i.id+"-"+e.name,class:_},[t,"unsupported"!==a?this.renderInputField(e):this.renderUnsupportedField(e),this.renderAuxiliaryText(e)])},t.prototype.renderInputField=function(e){var t=this.viewModel,a=e.domain,r=e.editable,n=e.name,l=e.type,s=t.getValue(n),o=!r,d=this.getCommonInputProps(e);return a&&"coded-value"===a.type&&!o?this.renderSelectInputField(s,a.codedValues.map((function(e){return{value:e.code,name:e.name}})),d):"text"===l&&"text-area"===e.editorType||"rich-text"===e.editorType?p.tsx("textarea",i.__assign({},d)):"datetime-picker"===e.editorType||"date"===l?this.renderDateInputField(s,d):p.tsx("input",i.__assign({type:"text"===l?"text":"number"},d))},t.prototype.renderDateInputField=function(e,t){var a=this._formatDate(0),r=a.date,n=a.time,l=this.id+"-"+t.key,s=l+"-date",o=l+"-time",d=t["data-field"],u=d.includeTime,f=this._formatDate(e),c=f.date,_=f.time;return p.tsx("div",{key:t.key+"-date",class:I},p.tsx("div",{class:this.classes(x,u?null:D)},p.tsx("input",i.__assign({"aria-label":d.label,"aria-describedby":s,type:"text"},t,{"data-date-part":"date",class:this.classes(t.class,m),value:c})),p.tsx("div",{class:M,id:s},r)),u?p.tsx("div",{class:x,key:"time-input"},p.tsx("input",i.__assign({"aria-describedby":o,"aria-label":d.label,type:"text"},t,{"data-date-part":"time",class:this.classes(t.class,v),value:_})),p.tsx("div",{class:M,id:o},n)):null)},t.prototype.renderUnsupportedField=function(e){var t=this.viewModel.getValue(e.name);return p.tsx("input",{class:this.classes(U,h,y),disabled:!0,type:"text",value:""+t})},t.prototype.renderSelectInputField=function(e,t,a){var r=!1,n=t.map((function(t){return t.value===e&&(r=!0),p.tsx("option",{value:""+t.value,key:t.name},t.name)}));return null==e||""===e||r||n.unshift(p.tsx("option",{value:""+e,key:"outlier-option"},e)),a["data-field"].required||n.unshift(p.tsx("option",{value:"",key:"empty-option"},this.messages.empty)),p.tsx("select",i.__assign({},a,{class:this.classes(a.class,A),onchange:this._handleOptionChange}),n)},t.prototype.renderAuxiliaryText=function(e){return e.valid?e.valid&&e.description?p.tsx("div",{key:"description",class:w},e.description):void 0:p.tsx("div",{key:"error-message"},p.tsx("span",{class:this.classes(b,S)}),p.tsx("div",{class:F},e.errorMessage))},t.prototype.getCommonInputProps=function(e){var t=this.viewModel,a=e.editable,r=e.name,n=e.required,l=e.maxLength,s=e.minLength,o=e.hint,d=e.type,u=e.valid,p=t.getValue(r),f=!a;return i.__assign(i.__assign({afterCreate:this._afterScrollerCreateOrUpdate,afterUpdate:this._afterScrollerCreateOrUpdate,"aria-invalid":u?"false":"true",class:this.classes(U,h,f?y:null,u?null:g),key:r,minlength:s>-1?""+s:"",maxlength:l>-1?""+l:""},this._getNumberFieldConstraints(e)),{disabled:f,value:null==p?"":""+p,"data-field":e,onfocus:this._handleInputFocus,onblur:this._handleInputBlur,onkeydown:this._handleInputKeyDown,onmousedown:"number"===d?this._handleNumberInputMouseDown:null,required:n,title:o})},t.prototype._isFieldInClosedCollapsibleGroup=function(e){var t;return"all"===this.groupDisplay&&!q(e)&&"collapsed"===(null===(t=null==e?void 0:e.group)||void 0===t?void 0:t.state)},t.prototype._handleNumberInputMouseDown=function(e){var t=e.target;t.disabled||t.focus(),this.scheduleRender()},t.prototype._getNumberFieldConstraints=function(e){var t=s.getDomainRange(e.domain)||o.getFieldRange(e.field);return t&&t.max!==Number.MAX_VALUE&&t.min!==Number.MIN_VALUE?t:{min:null,max:null}},t.prototype._afterScrollerCreateOrUpdate=function(e){var t=e["data-field"],i=this.viewModel.findField(this._activeInputName);t.editable&&this._fieldFocusNeeded&&i===t&&(this._fieldFocusNeeded=!1,e.focus())},t.prototype._handleInputFocus=function(e){var t=e.target;this._activeInputName=t["data-field"].name},t.prototype._handleInputBlur=function(e){var t=e.target,i=t["data-field"],a=e.relatedTarget,r=a&&a["data-field"];if(this._syncDateEditsBeforeValueCommit(t),r&&"date"===i.type&&"date"===r.type&&i.field===r.field){if(""!==t.value&&""===a.value){var n=a.getAttribute("data-date-part");a.value=this._formatDate(Date.now())[n]}}else this._commitValue(t),this.scheduleRender()},t.prototype._commitValue=function(e){var t=e["data-field"];if(this._activeDateEdit){var i=this._activeDateEdit,a=i.date,r=i.time,n=this._getDateEditValue(t,"date"),l=this._getDateEditValue(t,"time"),s=""===n||""===l;if(a)a.input.value=s?"":n;if(r)r.input.value=s?"":l;if(this._activeDateEdit=null,a&&r)return void this._updateDateFieldValue(a.input,r.input)}this._updateFieldValue(e)},t.prototype._getDateEditValue=function(e,t){var i=this._activeDateEdit[t];if(i){if(""===i.value)return"";var a=this._parseDate(i.value,t);return a?this._formatDate(a.getTime())[t]:this._formatDate(e.value)[t]}},t.prototype._handleInputKeyDown=function(e){var t=e.key,a=e.altKey,r=e.ctrlKey,n=e.metaKey,l=e.shiftKey,s=e.target,o=s["data-field"];if("Tab"===t){var d=l?"backward":"forward",u=s.getAttribute("data-date-part");if(this._syncDateEditsBeforeValueCommit(s),"backward"===d&&"time"===u||"forward"===d&&"date"===u&&o.includeTime)return;this._commitValue(s);var p=this.viewModel.findField(o.name),f=this._getFocusableInput(d,p);return this._activeInputName=f&&f.name,void(f?(e.preventDefault(),this._fieldFocusNeeded=!0):this.renderNow())}if("Enter"===t)this._isFieldInClosedCollapsibleGroup(o)?o.group.state="expanded":(this._updateFieldValue(e.target),this.scheduleRender());else{var c=o.field.type,_="single"===c||"double"===c;if(("integer"===c||"small-integer"===c||_)&&(!a&&!r&&!n)&&1===t.length){var h=Number(t),m=["-","+"],v=_?i.__spreadArrays(m,["e","."]):m;isNaN(h)&&-1===v.indexOf(t)&&e.preventDefault()}}},t.prototype._syncDateEditsBeforeValueCommit=function(e){var t;if("date"===e["data-field"].type){var a=e.getAttribute("data-date-part");this._activeDateEdit=i.__assign(i.__assign({},this._activeDateEdit),((t={})[a]={value:e.value,input:e},t))}},t.prototype._updateFieldValue=function(e){var t=e["data-field"];this.viewModel.setValue(t.name,this._parseValue(e))},t.prototype._updateDateFieldValue=function(e,t){var i=e["data-field"];this.viewModel.setValue(i.name,this._parseDateTimeValue(e,t))},t.prototype._parseValue=function(e){var t=e["data-field"],i=e.value,a=t.type;if("number"===a)return parseFloat(i);if("date"===a){if(!i)return null;var r=Number(i);if(!isNaN(r))return r;var n=e.getAttribute("data-date-part"),l=this._parseDate(i,n);if(!l)return null;var s=this._moment,o=s(l),d=t.domain,u=s(),p=u;if(d&&"range"===d.type){var f=s(d.maxValue);u.isAfter(f)||(p=f)}var c=this.viewModel.getValue(t.name),_=s(null!=c?c:p);return"date"===n?(o.hour(_.hour()),o.minutes(_.minutes()),o.seconds(_.seconds())):(o.date(_.date()),o.month(_.month()),o.year(_.year())),o.valueOf()}return i},t.prototype._parseDateTimeValue=function(e,t){var i=e.value,a=t.value;if(!i||!a)return null;var r=this._parseDate(i,"date"),n=this._parseDate(a,"time");if(!r||!n)return null;var l=this._moment(r),s=this._moment(n);return l.hour(s.hour()),l.minutes(s.minutes()),l.seconds(s.seconds()),l.valueOf()},t.prototype._handleOptionChange=function(e){this._updateFieldValue(e.target),this.scheduleRender()},t.prototype._handleGroupClick=function(e){var t,i=e.currentTarget["data-group"],a="expanded"===i.state,n="sequential"===this.groupDisplay;if(!(a&&!r.closest(e.target,"."+C))){if(this._activeInputName=null===(t=this._getFocusableInput("forward",i))||void 0===t?void 0:t.name,n){if(a)return;this.viewModel.inputFields.forEach((function(e){q(e)&&e!==i&&(e.state="collapsed")}))}i.state=a?"collapsed":"expanded",this._fieldFocusNeeded=!0,this.scheduleRender()}},t.prototype._handleSubmit=function(e){e.preventDefault()},t.prototype._handleFormKeyDown=function(e){"Enter"===e.key&&this.viewModel.submit()},t.prototype._formatDate=function(e){if(null==e)return{date:"",time:""};var t=this._moment(e);return{date:t.format(B),time:t.format(R)}},t.prototype._parseDate=function(e,t){if(null==e||""===e)return null;var i=this._moment(e,"date"===t?B:R,a.getLocale(),!1);return i.isValid()?i.toDate():null},i.__decorate([n.aliasOf("viewModel.description"),p.renderable()],t.prototype,"description",void 0),i.__decorate([n.aliasOf("viewModel.feature")],t.prototype,"feature",void 0),i.__decorate([n.aliasOf("viewModel.fieldConfig")],t.prototype,"fieldConfig",void 0),i.__decorate([n.aliasOf("viewModel.formTemplate")],t.prototype,"formTemplate",void 0),i.__decorate([n.property(),p.renderable()],t.prototype,"groupDisplay",void 0),i.__decorate([n.property({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],t.prototype,"label",void 0),i.__decorate([n.aliasOf("viewModel.layer")],t.prototype,"layer",void 0),i.__decorate([n.property(),p.renderable(),p.messageBundle("esri/widgets/FeatureForm/t9n/FeatureForm")],t.prototype,"messages",void 0),i.__decorate([n.aliasOf("viewModel.strict")],t.prototype,"strict",void 0),i.__decorate([n.aliasOf("viewModel.title"),p.renderable()],t.prototype,"title",void 0),i.__decorate([n.property(),p.renderable(["viewModel.inputFields","viewModel.state"]),p.vmEvent(["value-change","submit"])],t.prototype,"viewModel",void 0),i.__decorate([n.aliasOf("viewModel.getValues")],t.prototype,"getValues",null),i.__decorate([n.aliasOf("viewModel.submit")],t.prototype,"submit",null),t=i.__decorate([n.subclass("esri.widgets.FeatureForm")],t)}(d)}));