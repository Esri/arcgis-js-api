/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["require","../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../intl","../core/accessorSupport/decorators/aliasOf","../core/arrayUtils","../core/has","../core/accessorSupport/ensureType","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/subclass","../layers/support/domainUtils","../layers/support/fieldUtils","./Widget","./FeatureForm/FeatureFormViewModel","./support/Heading","./support/widgetUtils","./support/decorators/messageBundle","../core/Logger","./support/decorators/vmEvent","./support/jsxFactory","../chunks/datetime","../intl/locale"],(function(e,t,i,a,n,l,r,s,o,u,d,p,c,m,f,h,_,g,v,y,I,b){"use strict";const F={base:"esri-feature-form",form:"esri-feature-form__form",formHeader:"esri-feature-form__form-header",label:"esri-feature-form__label",inputField:"esri-feature-form__input",inputDate:"esri-feature-form__input--date",inputTime:"esri-feature-form__input--time",inputRadioGroup:"esri-feature-form__input--radio-group",inputRadio:"esri-feature-form__input--radio",inputRadioLabel:"esri-feature-form__input--radio-label",inputDisabled:"esri-feature-form__input--disabled",inputSwitch:"esri-feature-form__input--switch",inputInvalid:"esri-feature-form__input--invalid",inputIconInvalid:"esri-feature-form__input-icon--invalid",errorMessage:"esri-feature-form__field-error-message",description:"esri-feature-form__description-text",dateInputPart:"esri-feature-form__date-input-part",loneDateInputPart:"esri-feature-form__date-input-part--lone",dateInputContainer:"esri-feature-form__date-input-container",dateFormatHint:"esri-feature-form__date-format-hint",group:"esri-feature-form__group",groupLabel:"esri-feature-form__group-label",groupHeader:"esri-feature-form__group-header",groupHeading:"esri-feature-form__group-header",groupTitle:"esri-feature-form__group-title",groupDescription:"esri-feature-form__group-description",groupToggleIcon:"esri-feature-form__group-toggle-icon",groupCollapsed:"esri-feature-form__group--collapsed",groupSequential:"esri-feature-form__group--sequential",groupActive:"esri-feature-form__group--active",collapseIcon:"esri-icon-up",errorIcon:"esri-icon-notice-triangle",expandIcon:"esri-icon-down",widget:"esri-widget",panel:"esri-widget--panel",input:"esri-input",select:"esri-select"},w={datePattern:"D",timePattern:"tt"};function D(e){return e&&e.inputFields}let x=function(i){function a(e,a){var n;return(n=i.call(this,e,a)||this)._activeDateFieldEdit=null,n._activeInputName=null,n._fieldFocusNeeded=!1,n._fieldToInitialIncompatibleDomainValue=new Map,n._switchFieldsWithInitialIncompatibleValue=new Set,n._userUpdatedInputFieldNames=new Set,n.description=null,n.feature=null,n.fieldConfig=null,n.formTemplate=null,n.groupDisplay="all",n.headingLevel=2,n.label=void 0,n.layer=null,n.messages=null,n.strict=null,n.title=null,n.viewModel=new m,n._handleSwitchClick=e=>{e.target===e.currentTarget&&e.stopImmediatePropagation()},n._handleRadioInputChange=e=>{n._commitInputValue(e.target)},n._handleInputInput=e=>{n._commitInputValue(e.currentTarget,!0)},n._handleFormKeyDown=n._handleFormKeyDown.bind(t._assertThisInitialized(n)),n._handleInputBlur=n._handleInputBlur.bind(t._assertThisInitialized(n)),n._handleInputFocus=n._handleInputFocus.bind(t._assertThisInitialized(n)),n._handleNumberInputMouseDown=n._handleNumberInputMouseDown.bind(t._assertThisInitialized(n)),n._handleInputKeyDown=n._handleInputKeyDown.bind(t._assertThisInitialized(n)),n._handleOptionChange=n._handleOptionChange.bind(t._assertThisInitialized(n)),n._handleGroupClick=n._handleGroupClick.bind(t._assertThisInitialized(n)),n._handleSubmit=n._handleSubmit.bind(t._assertThisInitialized(n)),n._afterInputCreateOrUpdate=n._afterInputCreateOrUpdate.bind(t._assertThisInitialized(n)),n}t._inheritsLoose(a,i);var n=a.prototype;return n.initialize=function(){this.own(this.watch("feature",(()=>{const e=this._getFocusableInput("forward");this._activeInputName=e&&e.name,this._userUpdatedInputFieldNames.clear(),this._fieldToInitialIncompatibleDomainValue.clear(),this._switchFieldsWithInitialIncompatibleValue.clear(),this._fieldFocusNeeded=!0})),this.on("submit",(e=>{if(e.invalid.length>0){const[t]=e.invalid;e.invalid.forEach((e=>this._userUpdatedInputFieldNames.add(e))),this._activeInputName=t,this._fieldFocusNeeded=!0,this.scheduleRender()}})))},n.loadDependencies=function(){return new Promise(((t,i)=>e(["../chunks/calcite-switch"],t,i)))},n.destroy=function(){this._userUpdatedInputFieldNames.clear(),this._userUpdatedInputFieldNames=null},n.getValues=function(){return null},n.submit=function(){return null},n.render=function(){const{state:e}=this.viewModel;return y.tsx("div",{class:this.classes(F.base,F.widget,F.panel)},"ready"===e?this.renderForm():null)},n.renderForm=function(){const e=this.title?y.tsx(f.Heading,{key:"title",level:this.headingLevel},this.title):null,t=this.description?y.tsx("p",{class:F.description,key:"description"},this.description):null,i=e||t?y.tsx("div",{class:F.formHeader},e,t):null;return y.tsx("form",{class:F.form,novalidate:!0,onsubmit:this._handleSubmit,onkeydown:this._handleFormKeyDown},i,this.renderFields())},n.renderFields=function(){const{viewModel:{inputFields:e}}=this;return e.map(((e,t)=>D(e)?this.renderGroup(e,t):this.renderLabeledField(e)))},n.renderGroup=function(e,t){const{description:i,inputFields:a,label:n,state:l}=e,r=this.viewModel.findField(this._activeInputName),s=!(!r||r.group!==e),o=`${this.id}_group_${t}`,u=`${this.id}_group-label_${t}`,d=`${this.id}_group-description_${t}`,p=i?y.tsx("p",{class:this.classes(F.groupDescription,F.description),id:d},i):null,c="sequential"===this.groupDisplay,m=c?s:"expanded"===l,h=m?F.collapseIcon:F.expandIcon;return y.tsx("fieldset",{"aria-expanded":m.toString(),"aria-labelledby":u,"aria-describedby":i?d:"",class:this.classes(F.group,c?F.groupSequential:null,m?null:F.groupCollapsed,s?F.groupActive:null),"data-group":e,id:o,key:t,onclick:this._handleGroupClick},y.tsx("button",{role:c?"presentation":void 0,class:F.groupHeader,type:"button",tabIndex:c?-1:0},y.tsx("div",{class:F.groupTitle},y.tsx(f.Heading,{class:F.groupLabel,id:u,level:this.headingLevel+(this.title?1:0)},n),p),c?null:y.tsx("span",{class:this.classes(h,F.groupToggleIcon)})),a.map((e=>this.renderLabeledField(e))))},n._getFocusableInput=function(e,t){const i=this.viewModel._allInputFields,a="forward"===e?i:i.slice().reverse();let n;if(t)if(D(t))n=a.indexOf(t.inputFields[0]);else{let i;if(this._isFieldInClosedCollapsibleGroup(t)){const{inputFields:a}=t.group;i="forward"===e?a[a.length-1]:a[0]}else i=t;n=a.indexOf(i)+1}else n=0;for(let l=n;l<a.length;l++){const e=a[l];if(e.visible)return e}return null},n.renderLabeledField=function(e){const{label:t,layer:i,type:a}=e;return y.tsx("label",{key:`${i.id}-${e.name}`,class:F.label},[t,"unsupported"!==a?this.renderInputField(e):this.renderUnsupportedField(e),this.renderAuxiliaryText(e)])},n.renderInputField=function(e){const{viewModel:t}=this,{domain:i,editable:a,name:n,type:l}=e,r=t.getValue(n),s=!a,o=this.getCommonInputProps(e);if("coded-value"===(null==i?void 0:i.type)&&!s){if("switch"===e.editorType){if(!(this._switchFieldsWithInitialIncompatibleValue.has(n)||null==r||e.config.onValue!==r&&e.config.offValue!==r))return this.renderSwitchInputField(r,o);this._switchFieldsWithInitialIncompatibleValue.add(n)}return"radio-buttons"===e.editorType?this.renderRadioButtonsInputField(r,i.codedValues.map((({code:e,name:t})=>({value:e,name:t}))),o):this.renderSelectInputField(r,i.codedValues.map((({code:e,name:t})=>({value:e,name:t}))),o)}return"text"===l&&"text-area"===e.editorType||"rich-text"===e.editorType?y.tsx("textarea",{...o}):"datetime-picker"===e.editorType||"date"===l?this.renderDateInputField(r,o):y.tsx("input",{type:"text"===l?"text":"number",...o})},n._parseDateTime=function(e,t,i){if(i){var a;let n=I.DateTime.fromJSDate(this._parseDate(e,i));const l=I.DateTime.fromMillis(null!=(a=t.value)?a:Date.now());return n="date"===i?n.set({hour:l.hour,minute:l.minute,second:l.second}):n.set({day:l.day,month:l.month,year:l.year}),n.isValid?n.toMillis():null}const n=I.DateTime.fromJSDate(this._parseDate(e));return n.isValid?n.toMillis():null},n.renderDateInputField=function(e,t){const{date:i,time:a}=this._formatDate(0),n=`${this.id}-${t.key}`,l=`${n}-date`,r=`${n}-time`,s=t["data-field"],{includeTime:o}=s,{_activeDateFieldEdit:u}=this;let{date:d,time:p}=this._formatDate(e);var c,m,f,h;(null==u?void 0:u.fieldName)===s.name&&(d=null!=(c=null==(m=u.date.input)?void 0:m.value)?c:d,p=null!=(f=null==(h=u.time.input)?void 0:h.value)?f:p);return y.tsx("div",{key:`${t.key}-date`,class:F.dateInputContainer},y.tsx("div",{class:this.classes(F.dateInputPart,o?null:F.loneDateInputPart)},y.tsx("input",{"aria-label":s.label,"aria-describedby":l,type:"text",...t,"data-date-part":"date",class:this.classes(t.class,F.inputDate),value:d}),y.tsx("div",{class:F.dateFormatHint,id:l},i)),o?y.tsx("div",{class:F.dateInputPart,key:"time-input"},y.tsx("input",{"aria-describedby":r,"aria-label":s.label,type:"text",...t,"data-date-part":"time",class:this.classes(t.class,F.inputTime),value:p}),y.tsx("div",{class:F.dateFormatHint,id:r},a)):null)},n.renderUnsupportedField=function(e){const t=this.getCommonInputProps(e);return y.tsx("input",{afterCreate:t.afterCreate,afterUpdate:t.afterUpdate,class:this.classes(F.input,F.inputField,F.inputDisabled),"data-field":t["data-field"],onfocus:t.onfocus,readOnly:!0,tabIndex:t.tabIndex,type:"text",value:t.value})},n.renderSelectInputField=function(e,t,i){const a=t.map((e=>y.tsx("option",{value:`${e.value}`,key:e.name},e.name))),n=i["data-field"];if(this.registerIncompatibleValue(e,t,n,(e=>{a.unshift(y.tsx("option",{value:`${e}`,key:"incompatible-option",readOnly:!0},e))})),!n.required&&("combo-box"!==n.editorType||n.config.showNoValueOption)){var l;const e="",t=(null==(l=n.config)?void 0:l.noValueOptionLabel)||this.messages.empty;a.unshift(y.tsx("option",{value:e,key:"empty-option"},t))}return y.tsx("select",{...i,class:this.classes(i.class,F.select),onchange:this._handleOptionChange},a)},n.registerIncompatibleValue=function(e,t,i,a){const n=this._fieldToInitialIncompatibleDomainValue,l=n.has(i.name);(l||null!=e&&""!==e&&!t.find((t=>t.value===e))||l)&&(l||n.set(i.name,e),null==a||a(n.get(i.name)))},n.renderRadioButtonsInputField=function(e,t,i){const a=i["data-field"],n=t.map((t=>this.renderRadioButton({key:t.name,label:t.name,name:a.name,value:t.value,selected:t.value===e,props:i})));if(this.registerIncompatibleValue(e,t,a),!a.required&&(!a.config||a.config.showNoValueOption)){var l;const t="",r=(null==(l=a.config)?void 0:l.noValueOptionLabel)||this.messages.empty,s=e===t||null===e;n.unshift(this.renderRadioButton({key:"empty-option",label:r,name:a.name,value:t,selected:s,props:i}))}return y.tsx("div",{key:`${i.key}-radio`,class:F.inputRadioGroup},n)},n.renderSwitchInputField=function(e,t){const i=t["data-field"];return y.tsx("calcite-switch",{...t,class:F.inputSwitch,onclick:this._handleSwitchClick,checked:e===i.config.onValue})},n.renderRadioButton=function({key:e,name:t,value:i,selected:a,label:n,props:l}){return y.tsx("label",{key:e,class:F.inputRadioLabel},y.tsx("input",{...l,class:F.inputRadio,name:t,type:"radio",value:i,checked:a,onchange:this._handleRadioInputChange}),n)},n.renderAuxiliaryText=function(e){return this._userUpdatedInputFieldNames.has(e.name)&&!e.valid?y.tsx("div",{key:"error-message"},y.tsx("span",{class:this.classes(F.inputIconInvalid,F.errorIcon)}),y.tsx("div",{class:F.errorMessage},e.errorMessage)):e.description?y.tsx("div",{key:"description",class:F.description},e.description):void 0},n.getCommonInputProps=function(e){const{groupDisplay:t,viewModel:i}=this,{editable:a,group:n,hint:l,maxLength:r,minLength:s,name:o,required:u,type:d,valid:p}=e,c=i.getValue(o),m=this._userUpdatedInputFieldNames.has(o),f=!a,h="all"===t&&"collapsed"===(null==n?void 0:n.state);return{afterCreate:this._afterInputCreateOrUpdate,afterUpdate:this._afterInputCreateOrUpdate,"aria-invalid":p?"false":"true",class:this.classes(F.input,F.inputField,f?F.inputDisabled:null,m&&!p?F.inputInvalid:null),key:o,minlength:s>-1?`${s}`:"",maxlength:r>-1?`${r}`:"",...this._getNumberFieldConstraints(e),readOnly:f,value:null==c?"":`${c}`,"data-field":e,onfocus:this._handleInputFocus,oninput:this._handleInputInput,onblur:this._handleInputBlur,onkeydown:this._handleInputKeyDown,onmousedown:"number"===d?this._handleNumberInputMouseDown:null,placeholder:"number"===d||"text"===d?l:"",required:u,tabIndex:h?-1:0}},n._isFieldInClosedCollapsibleGroup=function(e){var t;return"all"===this.groupDisplay&&!D(e)&&"collapsed"===(null==e||null==(t=e.group)?void 0:t.state)},n._handleNumberInputMouseDown=function({target:e}){e.focus(),this.scheduleRender()},n._getNumberFieldConstraints=function(e){const t=d.getDomainRange(e.domain)||p.getFieldRange(e.field);return t&&t.max!==Number.MAX_VALUE&&t.min!==Number.MIN_VALUE?t:{min:null,max:null}},n._afterInputCreateOrUpdate=function(e){const t=e["data-field"],i=this.viewModel.findField(this._activeInputName),a=this._fieldToInitialIncompatibleDomainValue.get(t.name)===t.value;this._fieldFocusNeeded&&i===t&&("radio-buttons"!==t.editorType||a||e.checked)&&(this._fieldFocusNeeded=!1,e.focus())},n._handleInputFocus=function(e){const t=e.target,i=t["data-field"];this._activeInputName=i.name,"date"===i.type&&this._syncDateFieldEdits(t)},n._handleInputBlur=function(e){const t=e.target,i=t["data-field"];if("date"===i.type){const n=e.relatedTarget,l=n&&n["data-field"];if(l&&"date"===i.type&&"date"===l.type&&i.field===l.field){if(""!==t.value&&""===n.value){var a;const l=n.getAttribute("data-date-part");n.value=this._formatDate(null!=(a=i.value)?a:Date.now())[l],this._parseDate(t.value,t.getAttribute("data-date-part"))&&this._commitInputValue(e.target,!0,!1)}return}}this._commitInputValue(t),this.scheduleRender()},n._commitInputValue=function(e,t=!1,i=!0){const a=e["data-field"];if(this._activeDateFieldEdit){const{date:o,time:u}=this._activeDateFieldEdit,d=this._parseDateTime(e.value,a,o.active?"date":"time"),p=null!==this.viewModel.getValue(a.name),c=o.input&&(u.input||!a.includeTime),m=null===d;if(t){if(m)return;(c||!i||p)&&this._updateDateFieldValue(a,d)}else{var n,l;if(""===(null==(n=o.input)?void 0:n.value)||""===(null==(l=u.input)?void 0:l.value))this._updateDateFieldValue(a,null);else if(c){var r,s;const e=`${o.input.value} ${null!=(r=null==(s=u.input)?void 0:s.value)?r:""}`,t=this._parseDateTime(e,a);!(null!==t)&&p||this._updateDateFieldValue(a,t)}this._activeDateFieldEdit=null}}else this._updateFieldValue(e)},n._handleInputKeyDown=function(e){const{key:t,altKey:i,ctrlKey:a,metaKey:n}=e,l=e.target["data-field"];if("Enter"===t)this._isFieldInClosedCollapsibleGroup(l)&&(l.group.state="expanded");else{const{type:r}=l.field,s="single"===r||"double"===r,o=!i&&!a&&!n;if(("integer"===r||"small-integer"===r||s)&&o&&1===t.length){const i=Number(t),a=["-","+"],n=["e","."],l=s?[...a,...n]:a;isNaN(i)&&-1===l.indexOf(t)&&e.preventDefault()}}},n._syncDateFieldEdits=function(e){var t,i;const a=e["data-field"];if("date"!==a.type)return;const n=e.getAttribute("data-date-part"),l="date"===n?{value:e.value,input:e,active:!0}:{...null==(t=this._activeDateFieldEdit)?void 0:t.date,active:!1},r="time"===n?{value:e.value,input:e,active:!0}:{...null==(i=this._activeDateFieldEdit)?void 0:i.time,active:!1};this._activeDateFieldEdit={fieldName:a.name,date:l,time:r}},n._updateFieldValue=function(e){const t=e["data-field"];this.viewModel.setValue(t.name,this._parseValue(e)),this._userUpdatedInputFieldNames.add(t.name)},n._updateDateFieldValue=function(e,t){this.viewModel.setValue(e.name,t),this._userUpdatedInputFieldNames.add(e.name)},n._parseValue=function(e){const t=e["data-field"],i=e.value;if("switch"===t.editorType&&!(e instanceof HTMLSelectElement))return e.checked?t.config.onValue:t.config.offValue;if("radio-buttons"===t.editorType&&"radio"===e.type&&!e.checked)return t.value;const{type:a}=t;if("number"===a)return i?parseFloat(i):null;if("date"===a){if(!i)return null;const a=Number(i);if(!isNaN(a))return a;const n=e.getAttribute("data-date-part"),l=this._parseDate(i,n);if(!l)return null;let r=I.DateTime.fromJSDate(l);const s=t.domain,o=I.DateTime.now();let u=o;if(s&&"range"===s.type){const e=I.DateTime.fromMillis(s.maxValue);o<e&&(u=e)}const d=this.viewModel.getValue(t.name),p=null!=d?I.DateTime.fromMillis(d):u;return r="date"===n?r.set({hour:p.hour,minute:p.minute,second:p.second}):r.set({day:p.day,month:p.month,year:p.year}),r.toMillis()}return i},n._handleOptionChange=function(e){this._commitInputValue(e.target),this.scheduleRender()},n._handleGroupClick=function(e){var t;const i=e.currentTarget["data-group"],a="expanded"===i.state,n="sequential"===this.groupDisplay,l=`.${F.groupHeader}`;if(!(a&&!e.target.closest(l))){if(this._activeInputName=null==(t=this._getFocusableInput("forward",i))?void 0:t.name,n){const t=e.target.closest(l);if(a&&!t)return;this.viewModel.inputFields.forEach((e=>{D(e)&&e!==i&&(e.state="collapsed")}))}i.state=a?"collapsed":"expanded",this._fieldFocusNeeded=n,this.scheduleRender()}},n._handleSubmit=function(e){e.preventDefault()},n._handleFormKeyDown=function(e){"Enter"===e.key&&this.viewModel.submit()},n._formatDate=function(e){if(null==e)return{date:"",time:""};const t=I.DateTime.fromMillis(e,{locale:b.getLocale(),numberingSystem:"latn"});return{date:t.toLocaleString({year:"numeric",month:"2-digit",day:"2-digit"}),time:t.toFormat(w.timePattern)}},n._parseDate=function(e,t){if(null==e||""===e)return null;const{timePattern:i,datePattern:a}=w,n=t?"date"===t?a:i:`${a} ${i}`,l=I.DateTime.fromFormat(e,n,{locale:b.getLocale(),numberingSystem:"latn"});return l.isValid?l.toJSDate():null},a}(c);i.__decorate([n.aliasOf("viewModel.description")],x.prototype,"description",void 0),i.__decorate([n.aliasOf("viewModel.feature")],x.prototype,"feature",void 0),i.__decorate([n.aliasOf("viewModel.fieldConfig")],x.prototype,"fieldConfig",void 0),i.__decorate([n.aliasOf("viewModel.formTemplate")],x.prototype,"formTemplate",void 0),i.__decorate([o.property()],x.prototype,"groupDisplay",void 0),i.__decorate([o.property()],x.prototype,"headingLevel",void 0),i.__decorate([o.property({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],x.prototype,"label",void 0),i.__decorate([n.aliasOf("viewModel.layer")],x.prototype,"layer",void 0),i.__decorate([o.property(),_.messageBundle("esri/widgets/FeatureForm/t9n/FeatureForm")],x.prototype,"messages",void 0),i.__decorate([n.aliasOf("viewModel.strict")],x.prototype,"strict",void 0),i.__decorate([n.aliasOf("viewModel.title")],x.prototype,"title",void 0),i.__decorate([o.property(),v.vmEvent(["value-change","submit"])],x.prototype,"viewModel",void 0),i.__decorate([n.aliasOf("viewModel.getValues")],x.prototype,"getValues",null),i.__decorate([n.aliasOf("viewModel.submit")],x.prototype,"submit",null),x=i.__decorate([u.subclass("esri.widgets.FeatureForm")],x);return x}));
