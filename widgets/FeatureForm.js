/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/has","../core/Logger","../core/accessorSupport/ensureType","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/aliasOf","../core/accessorSupport/decorators/subclass","../core/urlUtils","../core/uuid","../portal/support/resourceExtension","../layers/support/domains","../layers/support/fieldUtils","../intl/locale","../intl","../intl/moment","./support/widgetUtils","./support/decorators/messageBundle","./support/decorators/vmEvent","../chunks/index","./Widget","./FeatureForm/FeatureFormViewModel"],(function(e,t,i,a,n,s,r,l,o,d,u,p,c,f,m,h,_,g,v,b,y,I){"use strict";const F={base:"esri-feature-form",form:"esri-feature-form__form",formHeader:"esri-feature-form__form-header",label:"esri-feature-form__label",inputField:"esri-feature-form__input",inputDate:"esri-feature-form__input--date",inputTime:"esri-feature-form__input--time",inputRadioGroup:"esri-feature-form__input--radio-group",inputRadio:"esri-feature-form__input--radio",inputRadioLabel:"esri-feature-form__input--radio-label",inputDisabled:"esri-feature-form__input--disabled",inputInvalid:"esri-feature-form__input--invalid",inputIconInvalid:"esri-feature-form__input-icon--invalid",errorMessage:"esri-feature-form__field-error-message",description:"esri-feature-form__description-text",dateInputPart:"esri-feature-form__date-input-part",loneDateInputPart:"esri-feature-form__date-input-part--lone",dateInputContainer:"esri-feature-form__date-input-container",dateFormatHint:"esri-feature-form__date-format-hint",group:"esri-feature-form__group",groupLabel:"esri-feature-form__group-label",groupHeader:"esri-feature-form__group-header",groupHeading:"esri-feature-form__group-header",groupTitle:"esri-feature-form__group-title",groupDescription:"esri-feature-form__group-description",groupToggleIcon:"esri-feature-form__group-toggle-icon",groupCollapsed:"esri-feature-form__group--collapsed",groupSequential:"esri-feature-form__group--sequential",groupActive:"esri-feature-form__group--active",collapseIcon:"esri-icon-up",errorIcon:"esri-icon-notice-triangle",expandIcon:"esri-icon-down",widget:"esri-widget",panel:"esri-widget--panel",input:"esri-input",select:"esri-select",heading:"esri-widget__heading"},w={datePattern:"L",timePattern:"LTS"};function x(e){return e&&e.inputFields}let D=function(t){function i(i,a){var n;return(n=t.call(this,i,a)||this)._activeDateEdit=null,n._activeInputName=null,n._fieldFocusNeeded=!1,n._fieldToInitialIncompatibleDomainValue=new Map,n._moment=null,n._userUpdatedInputFieldNames=new Set,n.description=null,n.feature=null,n.fieldConfig=null,n.formTemplate=null,n.groupDisplay="all",n.label=void 0,n.layer=null,n.messages=null,n.strict=null,n.title=null,n.viewModel=new I,n._handleRadioInputChange=e=>{n._updateFieldValue(e.target)},n._handleFormKeyDown=n._handleFormKeyDown.bind(e._assertThisInitialized(n)),n._handleInputBlur=n._handleInputBlur.bind(e._assertThisInitialized(n)),n._handleInputFocus=n._handleInputFocus.bind(e._assertThisInitialized(n)),n._handleNumberInputMouseDown=n._handleNumberInputMouseDown.bind(e._assertThisInitialized(n)),n._handleInputKeyDown=n._handleInputKeyDown.bind(e._assertThisInitialized(n)),n._handleOptionChange=n._handleOptionChange.bind(e._assertThisInitialized(n)),n._handleGroupClick=n._handleGroupClick.bind(e._assertThisInitialized(n)),n._handleSubmit=n._handleSubmit.bind(e._assertThisInitialized(n)),n._afterInputCreateOrUpdate=n._afterInputCreateOrUpdate.bind(e._assertThisInitialized(n)),n}e._inheritsLoose(i,t);var a=i.prototype;return a.loadLocale=async function(){this._moment=await h.loadMoment()},a.initialize=function(){this.own(this.watch("feature",(()=>{const e=this._getFocusableInput("forward");this._activeInputName=e&&e.name,this._userUpdatedInputFieldNames.clear(),this._fieldToInitialIncompatibleDomainValue.clear(),this._fieldFocusNeeded=!0})),this.on("submit",(e=>{if(e.invalid.length>0){const[t]=e.invalid;e.invalid.forEach((e=>this._userUpdatedInputFieldNames.add(e))),this._activeInputName=t,this._fieldFocusNeeded=!0,this.scheduleRender()}})))},a.destroy=function(){this._userUpdatedInputFieldNames.clear(),this._userUpdatedInputFieldNames=null},a.getValues=function(){return null},a.submit=function(){return null},a.render=function(){const{state:e}=this.viewModel;return b.jsx("div",{class:this.classes(F.base,F.widget,F.panel)},"ready"===e?this.renderForm():null)},a.renderForm=function(){const e=this.title?b.jsx("h2",{class:F.heading,key:"title"},this.title):null,t=this.description?b.jsx("p",{class:F.description,key:"description"},this.description):null,i=e||t?b.jsx("div",{class:F.formHeader},e,t):null;return b.jsx("form",{class:F.form,novalidate:!0,onsubmit:this._handleSubmit,onkeydown:this._handleFormKeyDown},i,this.renderFields())},a.renderFields=function(){const{viewModel:{inputFields:e}}=this;return e.map(((e,t)=>x(e)?this.renderGroup(e,t):this.renderLabeledField(e)))},a.renderGroup=function(e,t){const{description:i,label:a,inputFields:n,state:s}=e,r=this.viewModel.findField(this._activeInputName),l=!(!r||r.group!==e),o=`${this.id}_group_${t}`,d=`${this.id}_group-label_${t}`,u=`${this.id}_group-description_${t}`,p=i?b.jsx("p",{class:this.classes(F.groupDescription,F.description),id:u},i):null,c="sequential"===this.groupDisplay,f=c?l:"expanded"===s,m=f?F.collapseIcon:F.expandIcon;return b.jsx("fieldset",{"aria-expanded":f.toString(),"aria-labelledby":d,"aria-describedby":i?u:"",class:this.classes(F.group,c?F.groupSequential:null,f?null:F.groupCollapsed,l?F.groupActive:null),"data-group":e,id:o,key:t,onclick:this._handleGroupClick},b.jsx("button",{role:c?"presentation":void 0,class:F.groupHeader,type:"button",tabIndex:c?-1:0},b.jsx("div",{class:F.groupTitle},b.jsx("h4",{class:this.classes(F.groupLabel,F.heading),id:d},a),p),c?null:b.jsx("span",{class:this.classes(m,F.groupToggleIcon)})),n.map((e=>this.renderLabeledField(e))))},a._getFocusableInput=function(e,t){const i=this.viewModel._allInputFields,a="forward"===e?i:i.slice().reverse();let n;if(t)if(x(t))n=a.indexOf(t.inputFields[0]);else{let i;if(this._isFieldInClosedCollapsibleGroup(t)){const{inputFields:a}=t.group;i="forward"===e?a[a.length-1]:a[0]}else i=t;n=a.indexOf(i)+1}else n=0;for(let s=n;s<a.length;s++){const e=a[s];if(e.visible&&e.editable)return e}return null},a.renderLabeledField=function(e){const{label:t,layer:i,type:a}=e;return b.jsx("label",{key:`${i.id}-${e.name}`,class:F.label},[t,"unsupported"!==a?this.renderInputField(e):this.renderUnsupportedField(e),this.renderAuxiliaryText(e)])},a.renderInputField=function(e){const{viewModel:t}=this,{domain:i,editable:a,name:n,type:s}=e,r=t.getValue(n),l=!a,o=this.getCommonInputProps(e);return"coded-value"!==(null==i?void 0:i.type)||l?"text"===s&&"text-area"===e.editorType||"rich-text"===e.editorType?b.jsx("textarea",Object.assign({},o)):"datetime-picker"===e.editorType||"date"===s?this.renderDateInputField(r,o):b.jsx("input",Object.assign({type:"text"===s?"text":"number"},o)):"radio-buttons"===e.editorType?this.renderRadioButtonsInputField(r,i.codedValues.map((({code:e,name:t})=>({value:e,name:t}))),o):this.renderSelectInputField(r,i.codedValues.map((({code:e,name:t})=>({value:e,name:t}))),o)},a.renderDateInputField=function(e,t){const{date:i,time:a}=this._formatDate(0),n=`${this.id}-${t.key}`,s=`${n}-date`,r=`${n}-time`,l=t["data-field"],{includeTime:o}=l,{date:d,time:u}=this._formatDate(e);return b.jsx("div",{key:`${t.key}-date`,class:F.dateInputContainer},b.jsx("div",{class:this.classes(F.dateInputPart,o?null:F.loneDateInputPart)},b.jsx("input",Object.assign({"aria-label":l.label,"aria-describedby":s,type:"text"},t,{"data-date-part":"date",class:this.classes(t.class,F.inputDate),value:d})),b.jsx("div",{class:F.dateFormatHint,id:s},i)),o?b.jsx("div",{class:F.dateInputPart,key:"time-input"},b.jsx("input",Object.assign({"aria-describedby":r,"aria-label":l.label,type:"text"},t,{"data-date-part":"time",class:this.classes(t.class,F.inputTime),value:u})),b.jsx("div",{class:F.dateFormatHint,id:r},a)):null)},a.renderUnsupportedField=function(e){const t=this.viewModel.getValue(e.name);return b.jsx("input",{class:this.classes(F.input,F.inputField,F.inputDisabled),disabled:!0,type:"text",value:`${t}`})},a.renderSelectInputField=function(e,t,i){const a=t.map((e=>b.jsx("option",{value:`${e.value}`,key:e.name},e.name))),n=i["data-field"];if(this.registerIncompatibleValue(e,t,n,(e=>{a.unshift(b.jsx("option",{value:`${e}`,key:"incompatible-option",disabled:!0},e))})),!n.required&&("combo-box"!==n.editorType||n.config.showNoValueOption)){var s;const e="",t=(null==(s=n.config)?void 0:s.noValueOptionLabel)||this.messages.empty;a.unshift(b.jsx("option",{value:e,key:"empty-option"},t))}return b.jsx("select",Object.assign({},i,{class:this.classes(i.class,F.select),onchange:this._handleOptionChange}),a)},a.registerIncompatibleValue=function(e,t,i,a){const n=this._fieldToInitialIncompatibleDomainValue,s=n.has(i.name);(s||null!=e&&""!==e&&!t.find((t=>t.value===e))||s)&&(s||n.set(i.name,e),null==a||a(n.get(i.name)))},a.renderRadioButtonsInputField=function(e,t,i){const a=i["data-field"],n=t.map((t=>this.renderRadioButton({key:t.name,label:t.name,name:a.name,value:t.value,selected:t.value===e,props:i})));if(this.registerIncompatibleValue(e,t,a),!a.required&&(!a.config||a.config.showNoValueOption)){var s;const t="",r=(null==(s=a.config)?void 0:s.noValueOptionLabel)||this.messages.empty,l=e===t||null===e;n.unshift(this.renderRadioButton({key:"empty-option",label:r,name:a.name,value:t,selected:l,props:i}))}return b.jsx("div",{key:`${i.key}-radio`,class:F.inputRadioGroup},n)},a.renderRadioButton=function({key:e,name:t,value:i,selected:a,label:n,props:s}){return b.jsx("label",{key:e,class:F.inputRadioLabel},b.jsx("input",Object.assign({},s,{class:F.inputRadio,name:t,type:"radio",value:i,checked:a,onchange:this._handleRadioInputChange})),n)},a.renderAuxiliaryText=function(e){return this._userUpdatedInputFieldNames.has(e.name)&&!e.valid?b.jsx("div",{key:"error-message"},b.jsx("span",{class:this.classes(F.inputIconInvalid,F.errorIcon)}),b.jsx("div",{class:F.errorMessage},e.errorMessage)):e.description?b.jsx("div",{key:"description",class:F.description},e.description):void 0},a.getCommonInputProps=function(e){const{groupDisplay:t,viewModel:i}=this,{editable:a,group:n,hint:s,maxLength:r,minLength:l,name:o,required:d,type:u,valid:p}=e,c=i.getValue(o),f=this._userUpdatedInputFieldNames.has(o),m=!a,h="all"===t&&"collapsed"===(null==n?void 0:n.state);return{afterCreate:this._afterInputCreateOrUpdate,afterUpdate:this._afterInputCreateOrUpdate,"aria-invalid":p?"false":"true",class:this.classes(F.input,F.inputField,m?F.inputDisabled:null,f&&!p?F.inputInvalid:null),key:o,minlength:l>-1?`${l}`:"",maxlength:r>-1?`${r}`:"",...this._getNumberFieldConstraints(e),disabled:m,value:null==c?"":`${c}`,"data-field":e,onfocus:this._handleInputFocus,onblur:this._handleInputBlur,onkeydown:this._handleInputKeyDown,onmousedown:"number"===u?this._handleNumberInputMouseDown:null,placeholder:"number"===u||"text"===u?s:"",required:d,tabIndex:h?-1:0}},a._isFieldInClosedCollapsibleGroup=function(e){var t;return"all"===this.groupDisplay&&!x(e)&&"collapsed"===(null==e||null==(t=e.group)?void 0:t.state)},a._handleNumberInputMouseDown=function({target:e}){const t=e;t.disabled||t.focus(),this.scheduleRender()},a._getNumberFieldConstraints=function(e){const t=p.getDomainRange(e.domain)||c.getFieldRange(e.field);return t&&t.max!==Number.MAX_VALUE&&t.min!==Number.MIN_VALUE?t:{min:null,max:null}},a._afterInputCreateOrUpdate=function(e){const t=e["data-field"],i=this.viewModel.findField(this._activeInputName),a=this._fieldToInitialIncompatibleDomainValue.get(t.name)===t.value;t.editable&&this._fieldFocusNeeded&&i===t&&("radio-buttons"!==t.editorType||a||e.checked)&&(this._fieldFocusNeeded=!1,e.focus())},a._handleInputFocus=function(e){const t=e.target;this._activeInputName=t["data-field"].name},a._handleInputBlur=function(e){const t=e.target,i=t["data-field"],a=e.relatedTarget,n=a&&a["data-field"];this._syncDateEditsBeforeValueCommit(t);if(n&&"date"===i.type&&"date"===n.type&&i.field===n.field){if(""!==t.value&&""===a.value){const e=a.getAttribute("data-date-part");a.value=this._formatDate(Date.now())[e]}}else("radio-buttons"!==i.editorType||t.checked)&&(this._commitValue(t),this.scheduleRender())},a._commitValue=function(e){const t=e["data-field"];if(this._activeDateEdit){const{date:e,time:i}=this._activeDateEdit,a=this._getDateEditValue(t,"date"),n=this._getDateEditValue(t,"time"),s=""===a||""===n;if(e){const{input:t}=e;t.value=s?"":a}if(i){const{input:e}=i;e.value=s?"":n}if(this._activeDateEdit=null,e&&i)return void this._updateDateFieldValue(e.input,i.input)}this._updateFieldValue(e)},a._getDateEditValue=function(e,t){const i=this._activeDateEdit[t];if(!i)return;const{value:a}=i;if(""===a)return"";const n=this._parseDate(i.value,t);return n?this._formatDate(n.getTime())[t]:this._formatDate(e.value)[t]},a._handleInputKeyDown=function(e){const{key:t,altKey:i,ctrlKey:a,metaKey:n,shiftKey:s}=e,r=e.target,l=r["data-field"];if("Tab"===t){const t=s?"backward":"forward",i=r.getAttribute("data-date-part");this._syncDateEditsBeforeValueCommit(r);if("backward"===t&&"time"===i||"forward"===t&&"date"===i&&l.includeTime)return;this._commitValue(r);const a=this.viewModel.findField(l.name),n=this._getFocusableInput(t,a),o=a.group===(null==n?void 0:n.group);return this._activeInputName=null==n?void 0:n.name,void(n&&("sequential"===this.groupDisplay||o)?(e.preventDefault(),this._fieldFocusNeeded=!0):this.renderNow())}if("Enter"===t)this._isFieldInClosedCollapsibleGroup(l)?l.group.state="expanded":(this._updateFieldValue(e.target),this.scheduleRender());else{const{type:s}=l.field,r="single"===s||"double"===s,o=!i&&!a&&!n;if(("integer"===s||"small-integer"===s||r)&&o&&1===t.length){const i=Number(t),a=["-","+"],n=["e","."],s=r?[...a,...n]:a;isNaN(i)&&-1===s.indexOf(t)&&e.preventDefault()}}},a._syncDateEditsBeforeValueCommit=function(e){if("date"!==e["data-field"].type)return;const t=e.getAttribute("data-date-part");this._activeDateEdit={...this._activeDateEdit,[t]:{value:e.value,input:e}}},a._updateFieldValue=function(e){const t=e["data-field"];this.viewModel.setValue(t.name,this._parseValue(e)),this._userUpdatedInputFieldNames.add(t.name)},a._updateDateFieldValue=function(e,t){const i=e["data-field"];this.viewModel.setValue(i.name,this._parseDateTimeValue(e,t)),this._userUpdatedInputFieldNames.add(i.name)},a._parseValue=function(e){const t=e["data-field"],i=e.value;if("radio-buttons"===t.editorType&&"radio"===e.type&&!e.checked)return t.value;const{type:a}=t;if("number"===a)return i?parseFloat(i):null;if("date"===a){if(!i)return null;const a=Number(i);if(!isNaN(a))return a;const n=e.getAttribute("data-date-part"),s=this._parseDate(i,n);if(!s)return null;const r=this._moment,l=r(s),o=t.domain,d=r();let u=d;if(o&&"range"===o.type){const e=r(o.maxValue);d.isAfter(e)||(u=e)}const p=this.viewModel.getValue(t.name),c=r(null!=p?p:u);return"date"===n?(l.hour(c.hour()),l.minutes(c.minutes()),l.seconds(c.seconds())):(l.date(c.date()),l.month(c.month()),l.year(c.year())),l.valueOf()}return i},a._parseDateTimeValue=function(e,t){const i=e.value,a=t.value;if(!i||!a)return null;const n=this._parseDate(i,"date"),s=this._parseDate(a,"time");if(!n||!s)return null;const r=this._moment(n),l=this._moment(s);return r.hour(l.hour()),r.minutes(l.minutes()),r.seconds(l.seconds()),r.valueOf()},a._handleOptionChange=function(e){this._updateFieldValue(e.target),this.scheduleRender()},a._handleGroupClick=function(e){var t;const i=e.currentTarget["data-group"],a="expanded"===i.state,n="sequential"===this.groupDisplay,s=`.${F.groupHeader}`;if(!(a&&!e.target.closest(s))){if(this._activeInputName=null==(t=this._getFocusableInput("forward",i))?void 0:t.name,n){const t=e.target.closest(s);if(a&&!t)return;this.viewModel.inputFields.forEach((e=>{x(e)&&e!==i&&(e.state="collapsed")}))}i.state=a?"collapsed":"expanded",this._fieldFocusNeeded=n,this.scheduleRender()}},a._handleSubmit=function(e){e.preventDefault()},a._handleFormKeyDown=function(e){"Enter"===e.key&&this.viewModel.submit()},a._formatDate=function(e){if(null==e)return{date:"",time:""};const t=this._moment(e);return{date:t.format(w.datePattern),time:t.format(w.timePattern)}},a._parseDate=function(e,t){if(null==e||""===e)return null;const i=this._moment(e,"date"===t?w.datePattern:w.timePattern,f.getLocale(),!1);return i.isValid()?i.toDate():null},i}(y);return t.__decorate([r.aliasOf("viewModel.description")],D.prototype,"description",void 0),t.__decorate([r.aliasOf("viewModel.feature")],D.prototype,"feature",void 0),t.__decorate([r.aliasOf("viewModel.fieldConfig")],D.prototype,"fieldConfig",void 0),t.__decorate([r.aliasOf("viewModel.formTemplate")],D.prototype,"formTemplate",void 0),t.__decorate([s.property()],D.prototype,"groupDisplay",void 0),t.__decorate([s.property({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],D.prototype,"label",void 0),t.__decorate([r.aliasOf("viewModel.layer")],D.prototype,"layer",void 0),t.__decorate([s.property(),g.messageBundle("esri/widgets/FeatureForm/t9n/FeatureForm")],D.prototype,"messages",void 0),t.__decorate([r.aliasOf("viewModel.strict")],D.prototype,"strict",void 0),t.__decorate([r.aliasOf("viewModel.title")],D.prototype,"title",void 0),t.__decorate([s.property(),v.vmEvent(["value-change","submit"])],D.prototype,"viewModel",void 0),t.__decorate([r.aliasOf("viewModel.getValues")],D.prototype,"getValues",null),t.__decorate([r.aliasOf("viewModel.submit")],D.prototype,"submit",null),D=t.__decorate([l.subclass("esri.widgets.FeatureForm")],D),D}));
