/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/has","../core/Logger","../core/accessorSupport/ensureType","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/aliasOf","../core/accessorSupport/decorators/subclass","../core/urlUtils","../core/uuid","../portal/support/resourceExtension","../layers/support/domains","../layers/support/fieldUtils","../intl/locale","../intl","../intl/moment","./support/widgetUtils","./support/decorators/messageBundle","./support/decorators/renderable","./support/decorators/vmEvent","../chunks/index","./Widget","./FeatureForm/FeatureFormViewModel"],(function(e,t,i,a,s,r,n,l,o,d,u,c,p,f,h,_,m,v,g,b,y,F,w){"use strict";const x="esri-feature-form",I="esri-feature-form__form",D="esri-feature-form__form-header",N="esri-feature-form__label",M="esri-feature-form__input",j="esri-feature-form__input--date",V="esri-feature-form__input--time",C="esri-feature-form__input--disabled",O="esri-feature-form__input--invalid",k="esri-feature-form__input-icon--invalid",T="esri-feature-form__field-error-message",E="esri-feature-form__description-text",U="esri-feature-form__date-input-part",$="esri-feature-form__date-input-part--lone",S="esri-feature-form__date-input-container",L="esri-feature-form__date-format-hint",K="esri-feature-form__group",z="esri-feature-form__group-label",A="esri-feature-form__group-header",B="esri-feature-form__group-title",G="esri-feature-form__group-description",R="esri-feature-form__group-toggle-icon",q="esri-feature-form__group--collapsed",P="esri-feature-form__group--sequential",H="esri-feature-form__group--active",W="esri-icon-up",X="esri-icon-notice-triangle",J="esri-icon-down",Q="esri-widget",Y="esri-widget--panel",Z="esri-input",ee="esri-select",te="esri-widget__heading",ie="L",ae="LTS";function se(e){return e&&e.inputFields}let re=function(t){function i(i,a){var s;return(s=t.call(this,i,a)||this)._activeDateEdit=null,s._activeInputName=null,s._fieldFocusNeeded=!1,s._moment=null,s._userUpdatedInputFieldNames=new Set,s.description=null,s.feature=null,s.fieldConfig=null,s.formTemplate=null,s.groupDisplay="all",s.label=void 0,s.layer=null,s.messages=null,s.strict=null,s.title=null,s.viewModel=new w,s._handleFormKeyDown=s._handleFormKeyDown.bind(e._assertThisInitialized(s)),s._handleInputBlur=s._handleInputBlur.bind(e._assertThisInitialized(s)),s._handleInputFocus=s._handleInputFocus.bind(e._assertThisInitialized(s)),s._handleNumberInputMouseDown=s._handleNumberInputMouseDown.bind(e._assertThisInitialized(s)),s._handleInputKeyDown=s._handleInputKeyDown.bind(e._assertThisInitialized(s)),s._handleOptionChange=s._handleOptionChange.bind(e._assertThisInitialized(s)),s._handleGroupClick=s._handleGroupClick.bind(e._assertThisInitialized(s)),s._handleSubmit=s._handleSubmit.bind(e._assertThisInitialized(s)),s._afterScrollerCreateOrUpdate=s._afterScrollerCreateOrUpdate.bind(e._assertThisInitialized(s)),s}e._inheritsLoose(i,t);var a=i.prototype;return a.loadLocale=async function(){this._moment=await _.loadMoment()},a.initialize=function(){this.own(this.watch("feature",(()=>{const e=this._getFocusableInput("forward");this._activeInputName=e&&e.name,this._userUpdatedInputFieldNames.clear(),this._fieldFocusNeeded=!0})),this.on("submit",(e=>{if(e.invalid.length>0){const[t]=e.invalid;e.invalid.forEach((e=>this._userUpdatedInputFieldNames.add(e))),this._activeInputName=t,this._fieldFocusNeeded=!0,this.scheduleRender()}})))},a.destroy=function(){this._userUpdatedInputFieldNames.clear(),this._userUpdatedInputFieldNames=null},a.getValues=function(){return null},a.submit=function(){return null},a.render=function(){const{state:e}=this.viewModel;return y.jsx("div",{class:this.classes(x,Q,Y)},"ready"===e?this.renderForm():null)},a.renderForm=function(){const e=this.title?y.jsx("h2",{class:te,key:"title"},this.title):null,t=this.description?y.jsx("p",{class:E,key:"description"},this.description):null,i=e||t?y.jsx("div",{class:D},e,t):null;return y.jsx("form",{class:I,novalidate:!0,onsubmit:this._handleSubmit,onkeydown:this._handleFormKeyDown},i,this.renderFields())},a.renderFields=function(){const{viewModel:{inputFields:e}}=this;return e.map(((e,t)=>se(e)?this.renderGroup(e,t):this.renderLabeledField(e)))},a.renderGroup=function(e,t){const{description:i,label:a,inputFields:s,state:r}=e,n=this.viewModel.findField(this._activeInputName),l=!(!n||n.group!==e),o=`${this.id}_group_${t}`,d=`${this.id}_group-label_${t}`,u=`${this.id}_group-description_${t}`,c=i?y.jsx("p",{class:this.classes(G,E),id:u},i):null,p="sequential"===this.groupDisplay,f=p?l:"expanded"===r,h=f?W:J;return y.jsx("fieldset",{"aria-expanded":f.toString(),"aria-labelledby":d,"aria-describedby":i?u:"",class:this.classes(K,p?P:null,f?null:q,l?H:null),"data-group":e,id:o,key:t,onclick:this._handleGroupClick},y.jsx("button",{role:p?"presentation":void 0,class:A,type:"button",tabIndex:p?-1:0},y.jsx("div",{class:B},y.jsx("h4",{class:this.classes(z,te),id:d},a),c),p?null:y.jsx("span",{class:this.classes(h,R)})),s.map((e=>this.renderLabeledField(e))))},a._getFocusableInput=function(e,t){const i=this.viewModel._allInputFields,a="forward"===e?i:i.slice().reverse();let s;if(t)if(se(t))s=a.indexOf(t.inputFields[0]);else{let i;if(this._isFieldInClosedCollapsibleGroup(t)){const{inputFields:a}=t.group;i="forward"===e?a[a.length-1]:a[0]}else i=t;s=a.indexOf(i)+1}else s=0;for(let e=s;e<a.length;e++){const t=a[e];if(t.visible&&t.editable)return t}return null},a.renderLabeledField=function(e){const{label:t,layer:i,type:a}=e;return y.jsx("label",{key:`${i.id}-${e.name}`,class:N},[t,"unsupported"!==a?this.renderInputField(e):this.renderUnsupportedField(e),this.renderAuxiliaryText(e)])},a.renderInputField=function(e){const{viewModel:t}=this,{domain:i,editable:a,name:s,type:r}=e,n=t.getValue(s),l=!a,o=this.getCommonInputProps(e);return i&&"coded-value"===i.type&&!l?this.renderSelectInputField(n,i.codedValues.map((({code:e,name:t})=>({value:e,name:t}))),o):"text"===r&&"text-area"===e.editorType||"rich-text"===e.editorType?y.jsx("textarea",Object.assign({},o)):"datetime-picker"===e.editorType||"date"===r?this.renderDateInputField(n,o):y.jsx("input",Object.assign({type:"text"===r?"text":"number"},o))},a.renderDateInputField=function(e,t){const{date:i,time:a}=this._formatDate(0),s=`${this.id}-${t.key}`,r=`${s}-date`,n=`${s}-time`,l=t["data-field"],{includeTime:o}=l,{date:d,time:u}=this._formatDate(e);return y.jsx("div",{key:`${t.key}-date`,class:S},y.jsx("div",{class:this.classes(U,o?null:$)},y.jsx("input",Object.assign({"aria-label":l.label,"aria-describedby":r,type:"text"},t,{"data-date-part":"date",class:this.classes(t.class,j),value:d})),y.jsx("div",{class:L,id:r},i)),o?y.jsx("div",{class:U,key:"time-input"},y.jsx("input",Object.assign({"aria-describedby":n,"aria-label":l.label,type:"text"},t,{"data-date-part":"time",class:this.classes(t.class,V),value:u})),y.jsx("div",{class:L,id:n},a)):null)},a.renderUnsupportedField=function(e){const t=this.viewModel.getValue(e.name);return y.jsx("input",{class:this.classes(Z,M,C),disabled:!0,type:"text",value:`${t}`})},a.renderSelectInputField=function(e,t,i){let a=!1;const s=t.map((t=>(t.value===e&&(a=!0),y.jsx("option",{value:`${t.value}`,key:t.name},t.name))));null==e||""===e||a||s.unshift(y.jsx("option",{value:`${e}`,key:"outlier-option"},e));return i["data-field"].required||s.unshift(y.jsx("option",{value:"",key:"empty-option"},this.messages.empty)),y.jsx("select",Object.assign({},i,{class:this.classes(i.class,ee),onchange:this._handleOptionChange}),s)},a.renderAuxiliaryText=function(e){return this._userUpdatedInputFieldNames.has(e.name)&&!e.valid?y.jsx("div",{key:"error-message"},y.jsx("span",{class:this.classes(k,X)}),y.jsx("div",{class:T},e.errorMessage)):e.description?y.jsx("div",{key:"description",class:E},e.description):void 0},a.getCommonInputProps=function(e){const{groupDisplay:t,viewModel:i}=this,{editable:a,group:s,hint:r,maxLength:n,minLength:l,name:o,required:d,type:u,valid:c}=e,p=i.getValue(o),f=this._userUpdatedInputFieldNames.has(o),h=!a,_="all"===t&&"collapsed"===(null==s?void 0:s.state);return{afterCreate:this._afterScrollerCreateOrUpdate,afterUpdate:this._afterScrollerCreateOrUpdate,"aria-invalid":c?"false":"true",class:this.classes(Z,M,h?C:null,f&&!c?O:null),key:o,minlength:l>-1?`${l}`:"",maxlength:n>-1?`${n}`:"",...this._getNumberFieldConstraints(e),disabled:h,value:null==p?"":`${p}`,"data-field":e,onfocus:this._handleInputFocus,onblur:this._handleInputBlur,onkeydown:this._handleInputKeyDown,onmousedown:"number"===u?this._handleNumberInputMouseDown:null,required:d,tabIndex:_?-1:0,title:r}},a._isFieldInClosedCollapsibleGroup=function(e){var t;return"all"===this.groupDisplay&&!se(e)&&"collapsed"===(null==e||null==(t=e.group)?void 0:t.state)},a._handleNumberInputMouseDown=function({target:e}){const t=e;t.disabled||t.focus(),this.scheduleRender()},a._getNumberFieldConstraints=function(e){const t=c.getDomainRange(e.domain)||p.getFieldRange(e.field);return t&&t.max!==Number.MAX_VALUE&&t.min!==Number.MIN_VALUE?t:{min:null,max:null}},a._afterScrollerCreateOrUpdate=function(e){const t=e["data-field"],i=this.viewModel.findField(this._activeInputName);t.editable&&this._fieldFocusNeeded&&i===t&&(this._fieldFocusNeeded=!1,e.focus())},a._handleInputFocus=function(e){const t=e.target;this._activeInputName=t["data-field"].name},a._handleInputBlur=function(e){const t=e.target,i=t["data-field"],a=e.relatedTarget,s=a&&a["data-field"];this._syncDateEditsBeforeValueCommit(t);if(s&&"date"===i.type&&"date"===s.type&&i.field===s.field){if(""!==t.value&&""===a.value){const e=a.getAttribute("data-date-part");a.value=this._formatDate(Date.now())[e]}}else this._commitValue(t),this.scheduleRender()},a._commitValue=function(e){const t=e["data-field"];if(this._activeDateEdit){const{date:e,time:i}=this._activeDateEdit,a=this._getDateEditValue(t,"date"),s=this._getDateEditValue(t,"time"),r=""===a||""===s;if(e){const{input:t}=e;t.value=r?"":a}if(i){const{input:e}=i;e.value=r?"":s}if(this._activeDateEdit=null,e&&i)return void this._updateDateFieldValue(e.input,i.input)}this._updateFieldValue(e)},a._getDateEditValue=function(e,t){const i=this._activeDateEdit[t];if(!i)return;const{value:a}=i;if(""===a)return"";const s=this._parseDate(i.value,t);return s?this._formatDate(s.getTime())[t]:this._formatDate(e.value)[t]},a._handleInputKeyDown=function(e){const{key:t,altKey:i,ctrlKey:a,metaKey:s,shiftKey:r}=e,n=e.target,l=n["data-field"];if("Tab"===t){const t=r?"backward":"forward",i=n.getAttribute("data-date-part");this._syncDateEditsBeforeValueCommit(n);if("backward"===t&&"time"===i||"forward"===t&&"date"===i&&l.includeTime)return;this._commitValue(n);const a=this.viewModel.findField(l.name),s=this._getFocusableInput(t,a),o=a.group===(null==s?void 0:s.group);return this._activeInputName=null==s?void 0:s.name,void(s&&("sequential"===this.groupDisplay||o)?(e.preventDefault(),this._fieldFocusNeeded=!0):this.renderNow())}if("Enter"===t)this._isFieldInClosedCollapsibleGroup(l)?l.group.state="expanded":(this._updateFieldValue(e.target),this.scheduleRender());else{const{type:r}=l.field,n="single"===r||"double"===r,o=!i&&!a&&!s;if(("integer"===r||"small-integer"===r||n)&&o&&1===t.length){const i=Number(t),a=["-","+"],s=["e","."],r=n?[...a,...s]:a;isNaN(i)&&-1===r.indexOf(t)&&e.preventDefault()}}},a._syncDateEditsBeforeValueCommit=function(e){if("date"!==e["data-field"].type)return;const t=e.getAttribute("data-date-part");this._activeDateEdit={...this._activeDateEdit,[t]:{value:e.value,input:e}}},a._updateFieldValue=function(e){const t=e["data-field"];this.viewModel.setValue(t.name,this._parseValue(e)),this._userUpdatedInputFieldNames.add(t.name)},a._updateDateFieldValue=function(e,t){const i=e["data-field"];this.viewModel.setValue(i.name,this._parseDateTimeValue(e,t)),this._userUpdatedInputFieldNames.add(i.name)},a._parseValue=function(e){const t=e["data-field"],i=e.value,{type:a}=t;if("number"===a)return parseFloat(i);if("date"===a){if(!i)return null;const a=Number(i);if(!isNaN(a))return a;const s=e.getAttribute("data-date-part"),r=this._parseDate(i,s);if(!r)return null;const n=this._moment,l=n(r),o=t.domain,d=n();let u=d;if(o&&"range"===o.type){const e=n(o.maxValue);d.isAfter(e)||(u=e)}const c=this.viewModel.getValue(t.name),p=n(null!=c?c:u);return"date"===s?(l.hour(p.hour()),l.minutes(p.minutes()),l.seconds(p.seconds())):(l.date(p.date()),l.month(p.month()),l.year(p.year())),l.valueOf()}return i},a._parseDateTimeValue=function(e,t){const i=e.value,a=t.value;if(!i||!a)return null;const s=this._parseDate(i,"date"),r=this._parseDate(a,"time");if(!s||!r)return null;const n=this._moment(s),l=this._moment(r);return n.hour(l.hour()),n.minutes(l.minutes()),n.seconds(l.seconds()),n.valueOf()},a._handleOptionChange=function(e){this._updateFieldValue(e.target),this.scheduleRender()},a._handleGroupClick=function(e){var t;const i=e.currentTarget["data-group"],a="expanded"===i.state,s="sequential"===this.groupDisplay,r=`.${A}`;if(!(a&&!e.target.closest(r))){if(this._activeInputName=null==(t=this._getFocusableInput("forward",i))?void 0:t.name,s){const t=e.target.closest(r);if(a&&!t)return;this.viewModel.inputFields.forEach((e=>{se(e)&&e!==i&&(e.state="collapsed")}))}i.state=a?"collapsed":"expanded",this._fieldFocusNeeded=s,this.scheduleRender()}},a._handleSubmit=function(e){e.preventDefault()},a._handleFormKeyDown=function(e){"Enter"===e.key&&this.viewModel.submit()},a._formatDate=function(e){if(null==e)return{date:"",time:""};const t=this._moment(e);return{date:t.format(ie),time:t.format(ae)}},a._parseDate=function(e,t){if(null==e||""===e)return null;const i=this._moment(e,"date"===t?ie:ae,f.getLocale(),!1);return i.isValid()?i.toDate():null},i}(F);return t.__decorate([n.aliasOf("viewModel.description"),g.renderable()],re.prototype,"description",void 0),t.__decorate([n.aliasOf("viewModel.feature")],re.prototype,"feature",void 0),t.__decorate([n.aliasOf("viewModel.fieldConfig")],re.prototype,"fieldConfig",void 0),t.__decorate([n.aliasOf("viewModel.formTemplate")],re.prototype,"formTemplate",void 0),t.__decorate([r.property(),g.renderable()],re.prototype,"groupDisplay",void 0),t.__decorate([r.property({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],re.prototype,"label",void 0),t.__decorate([n.aliasOf("viewModel.layer")],re.prototype,"layer",void 0),t.__decorate([r.property(),g.renderable(),v.messageBundle("esri/widgets/FeatureForm/t9n/FeatureForm")],re.prototype,"messages",void 0),t.__decorate([n.aliasOf("viewModel.strict")],re.prototype,"strict",void 0),t.__decorate([n.aliasOf("viewModel.title"),g.renderable()],re.prototype,"title",void 0),t.__decorate([r.property(),g.renderable(["viewModel.inputFields","viewModel.state"]),b.vmEvent(["value-change","submit"])],re.prototype,"viewModel",void 0),t.__decorate([n.aliasOf("viewModel.getValues")],re.prototype,"getValues",null),t.__decorate([n.aliasOf("viewModel.submit")],re.prototype,"submit",null),re=t.__decorate([l.subclass("esri.widgets.FeatureForm")],re),re}));
