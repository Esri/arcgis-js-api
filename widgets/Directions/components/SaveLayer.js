/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["require","exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/maybe","../../../core/promiseUtils","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../../portal/Portal","../../Widget","../../support/widgetUtils","../../support/decorators/messageBundle","../../support/jsxFactory"],(function(e,t,s,r,a,o,i,n,l,c,u,d,h,p,m){"use strict";const _="esri-save-layer",g={panel:`${_}`,error:`${_}__error`,errorIcon:`${_}__error-icon`,errorLabel:`${_}__error-label`,layerNameLabel:`${_}__layer-name-label`,portalFolderLabel:`${_}__portal-folder-label`,processLabel:`${_}__process-label`,processLoader:`${_}__process-loader`};t.SaveLayer=function(t){function r(e,s){var r;return(r=t.call(this,e,s)||this)._folders=null,r._layer=null,r._userName=null,r.messages=null,r.messagesCommon=null,r.messagesIdentity=null,r.opened=!1,r.state="initialized",r}s._inheritsLoose(r,t);var i=r.prototype;return i.loadDependencies=function(){return Promise.all([new Promise(((t,s)=>e(["../../../chunks/calcite-button"],t,s))),new Promise(((t,s)=>e(["../../../chunks/calcite-combobox"],t,s))),new Promise(((t,s)=>e(["../../../chunks/calcite-combobox-item"],t,s))),new Promise(((t,s)=>e(["../../../chunks/calcite-icon"],t,s))),new Promise(((t,s)=>e(["../../../chunks/calcite-input"],t,s))),new Promise(((t,s)=>e(["../../../chunks/calcite-label"],t,s))),new Promise(((t,s)=>e(["../../../chunks/calcite-loader"],t,s))),new Promise(((t,s)=>e(["../../../chunks/calcite-panel"],t,s)))])},i.close=function(){this.opened=!1,this.state="initialized"},i.open=function(){var e=s._asyncToGenerator((function*(e){this.state="initialized",this.opened=!0,this._layer=e,this.state="connect-to-portal";const t=u.getDefault();try{yield t._signIn()}catch(r){return void(o.isAbortError(r)||"identity-manager:user-aborted"===r.name?this.close():this.state="connect-to-portal-error")}this.state="fetch-portal-information";const{user:s}=t;this._userName=s.username;try{this._folders=yield s.fetchFolders()}catch{return void(this.state="fetch-portal-information-error")}this.state="save-layer"}));function t(t){return e.apply(this,arguments)}return t}(),i.render=function(){switch(this.state){case"initialized":return this._renderInitialized();case"connect-to-portal":return this._renderProcess(this.messagesIdentity.lblSigning);case"connect-to-portal-error":return this._renderError(this.messages.errors.authenticating);case"fetch-portal-information":return this._renderProcess(this.messages.processing.fetching);case"fetch-portal-information-error":return this._renderError(this.messages.errors.fetching);case"save-layer":return this._renderSaveLayer();case"saving":return this._renderProcess(this.messages.processing.saving);case"saving-error":return this._renderError(this.messages.errors.saving)}},i._renderError=function(e){return m.tsx("calcite-panel",{class:g.panel,heading:this.messages.widgetLabel,key:`${_}-error-panel`},m.tsx("div",{class:g.error},m.tsx("calcite-icon",{class:g.errorIcon,icon:"exclamation-mark-triangle",scale:"l",textLabel:this.messagesCommon.errorMessage}),m.tsx("calcite-label",{class:g.errorLabel},e)),m.tsx("calcite-button",{appearance:"outline",onclick:()=>{this.close()},slot:"footer-actions",width:"half"},this.messagesCommon.close))},i._renderInitialized=function(){return m.tsx("calcite-panel",{class:g.panel,heading:this.messages.widgetLabel,key:`${_}-initialize-panel`})},i._renderProcess=function(e){return m.tsx("calcite-panel",{class:g.panel,heading:this.messages.widgetLabel,key:`${_}-process-panel`},m.tsx("calcite-loader",{class:g.processLoader,label:e,active:!0}),m.tsx("calcite-label",{class:g.processLabel,alignment:"center"},e))},i._renderSaveLayer=function(){if(a.isNone(this._layer)||a.isNone(this._folders)||a.isNone(this._userName))return this._renderInitialized();const{stops:e}=this._layer,t=`${e.getItemAt(0).name} - ${e.getItemAt(e.length-1).name}`,s=this._folders.map((e=>m.tsx("calcite-combobox-item",{key:`${_}-folder-${e.id}`,"text-label":e.title,value:e.id})));return s.unshift(m.tsx("calcite-combobox-item",{key:`${_}-folder-home`,selected:!0,"text-label":`${this._userName} (${this.messagesCommon.home})`,value:null})),m.tsx("calcite-panel",{class:g.panel,heading:this.messages.widgetLabel,key:`${_}-save-panel`},m.tsx("calcite-label",{class:g.layerNameLabel},this.messages.laverName,m.tsx("calcite-input",{afterCreate:e=>{this._layerNameInput=e},label:this.messages.laverName,value:t})),m.tsx("calcite-label",{class:g.portalFolderLabel},this.messages.saveInFolder,m.tsx("calcite-combobox",{afterCreate:e=>{this._portalFolderCombobox=e},label:this.messages.saveInFolder,"overlay-positioning":"fixed","selection-mode":"single"},s)),m.tsx("calcite-button",{onclick:()=>this._saveButtonClick(),slot:"footer-actions",width:"half"},this.messagesCommon.save),m.tsx("calcite-button",{appearance:"outline",onclick:()=>{this.close()},slot:"footer-actions",width:"half"},this.messagesCommon.cancel))},i._saveButtonClick=function(){this.state="saving",this._saveLayer().then((()=>{this.close()})).catch((()=>{this.state="saving-error"}))},i._saveLayer=function(){var e=s._asyncToGenerator((function*(){if(a.isNone(this._layer)||a.isNone(this._folders))return;const e=this._layerNameInput.value,t=this._portalFolderCombobox.value,s=this._folders.find((e=>e.id===t));yield this._layer.saveAs({title:e},{folder:s})}));function t(){return e.apply(this,arguments)}return t}(),s._createClass(r,[{key:"label",get:function(){return this.messages?.widgetLabel??""},set:function(e){this._overrideIfSome("label",e)}}]),r}(d),r.__decorate([i.property()],t.SaveLayer.prototype,"label",null),r.__decorate([i.property(),p.messageBundle("esri/widgets/support/t9n/SaveLayer")],t.SaveLayer.prototype,"messages",void 0),r.__decorate([i.property(),p.messageBundle("esri/t9n/common")],t.SaveLayer.prototype,"messagesCommon",void 0),r.__decorate([i.property(),p.messageBundle("esri/identity/t9n/identity")],t.SaveLayer.prototype,"messagesIdentity",void 0),r.__decorate([i.property()],t.SaveLayer.prototype,"opened",void 0),r.__decorate([i.property()],t.SaveLayer.prototype,"state",void 0),t.SaveLayer=r.__decorate([c.subclass("esri.widgets.Directions.SaveLayer")],t.SaveLayer),Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
