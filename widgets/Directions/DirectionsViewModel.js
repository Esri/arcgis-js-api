/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../Color","../../Graphic","../../symbols","../../core/Collection","../../core/Error","../../core/Evented","../../core/Handles","../../core/Logger","../../core/maybe","../../core/promiseUtils","../../core/watchUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass","../../geometry/support/graphicsUtils","../../intl/locale","../../layers/GraphicsLayer","../../rest/networkService","../../rest/support/NetworkFeatureSet","../../rest/support/RouteParameters","../../tasks/RouteTask","./support/directionsUtils","../support/GoTo","../../symbols/SimpleMarkerSymbol","../../symbols/PictureMarkerSymbol","../../symbols/SimpleLineSymbol"],(function(e,t,r,o,i,s,n,a,l,u,c,p,d,h,y,m,v,g,_,f,w,b,T,S,L,R,C,D,A){"use strict";const M=u.getLogger("esri.widgets.Directions.DirectionsViewModel"),k={first:new C({color:[105,220,255,1],size:19,outline:{color:[51,51,51,1],width:3}}),middle:new C({color:[51,51,51,1],size:12,outline:{color:[105,220,255,1],width:3}}),last:new D({width:23,height:23,url:`data:image/svg+xml;base64,${btoa('<svg width="30" height="30" viewBox="0 0 30 30" xmlns="http://www.w3.org/2000/svg"><g fill-rule="nonzero" fill="none"><path d="M15.15.3C6.9.3.3 6.9.3 15.15S6.9 29.7 15.15 29.7 29.7 23.1 29.7 15.15C29.7 6.9 23.25.3 15.15.3z" fill="#333"/><path d="M15 4.8C9.3 4.8 4.8 9.45 4.8 15c0 5.55 4.65 10.2 10.2 10.2 5.55 0 10.2-4.5 10.2-10.2 0-5.55-4.5-10.2-10.2-10.2z" fill="#69DCFF"/><path fill="#333" d="M10.5 10.5h9v9h-9z"/></g></svg>')}`}),unlocated:new D({height:18,width:18,url:`data:image/svg+xml;base64,${btoa('<svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="M10.1.2C4.6.2.2 4.6.2 10.1s4.4 9.7 9.9 9.7 9.7-4.4 9.7-9.7c0-5.5-4.3-9.9-9.7-9.9z" fill="#333" fill-rule="nonzero"/><path d="M10 2.7c-4.08 0-7.3 3.328-7.3 7.3s3.328 7.3 7.3 7.3 7.3-3.22 7.3-7.3c0-3.972-3.22-7.3-7.3-7.3z" fill="#69DCFF" fill-rule="nonzero"/><path d="M11.414 10l5.304-5.303-1.415-1.415L10 8.586 4.697 3.282 3.282 4.697 8.586 10l-5.304 5.303 1.415 1.415L10 11.414l5.303 5.304 1.415-1.415L11.414 10z" fill="#333"/></g></svg>')}`}),waypoint:new C({color:[255,255,255,1],size:10,outline:{color:[20,89,127,1],width:2.5}})};let N=function(t){function i(e){var r;return(r=t.call(this,e)||this)._handles=new l,r._routeLayer=new f({listMode:"hide"}),r._highlightLayer=new f({listMode:"hide"}),r._stopId=9999,r._stopLayer=new f({listMode:"hide"}),r._serviceDescriptionLoadStatus=0,r.apiKey=void 0,r.departureTime="now",r.lastRoute=null,r.routeSymbol=new A({color:[105,220,255,1],width:7,cap:"round",join:"round"}),r.routeParameters=new T({ignoreInvalidLocations:!0,directionsOutputType:"complete",findBestSequence:!1,preserveFirstStop:!0,preserveLastStop:!0,restrictUTurns:"at-dead-ends-and-intersections",directionsLengthUnits:"kilometers",returnBarriers:!1,returnDirections:!0,returnPolygonBarriers:!1,returnPolylineBarriers:!1,returnRoutes:!1,returnStops:!0,returnZ:!0,startTime:null,startTimeIsUTC:!0,stops:null,useHierarchy:!0,useTimeWindows:!1}),r.routeServiceUrl="https://route-api.arcgis.com/arcgis/rest/services/World/Route/NAServer/Route_World",r.serviceDescription=null,r.error=null,r.stops=new s,r.view=null,r}e._inheritsLoose(i,t);var a=i.prototype;return a.initialize=function(){this._handles.add([d.on(this,"stops","change",(()=>{this.clearResults(),this._addStopsToLayer()})),d.init(this,"view.map",((e,t)=>{const r=[this._routeLayer,this._stopLayer,this._highlightLayer];t&&t.removeMany(r),e&&e.addMany(r)})),d.watch(this,"lastRoute",(()=>this._addRouteToLayer()))])},a.destroy=function(){this.stops.destroy();const e=this.get("view.map");e&&e.removeMany([this._routeLayer,this._stopLayer,this._highlightLayer])},a.load=function(){var t=e._asyncToGenerator((function*(){if(!this.serviceDescription)try{this._serviceDescriptionLoadStatus=1,this.notifyChange("state"),yield this._loadServiceDescription(),this._serviceDescriptionLoadStatus=2,this.notifyChange("state")}catch(e){const t="identity-manager:user-aborted"===e.name;if(this._serviceDescriptionLoadStatus=t?4:3,this.notifyChange("state"),!t){const t=new n("directions-view-model:service-metadata-unavailable","Cannot load route service metadata",{error:e});throw this._set("error",t),t}}}));function r(){return t.apply(this,arguments)}return r}(),a.highlightSegment=function(e){const{view:t,_highlightLayer:i}=this;if(!t||c.isNone(e.symbol))return;this.clearHighlights();const s=e.symbol.clone();s.color=new r([0,0,0,.8]),s.width=Math.ceil(s.width/2);const n=new o({geometry:e.geometry,symbol:s});i.graphics.add(n)},a.clearHighlights=function(){this._highlightLayer.graphics.removeAll()},a.centerAt=function(e){const{view:t}=this;t&&this.callGoTo({target:e})},a.clearResults=function(){this._set("lastRoute",null)},a.getDirections=function(){const{state:e}=this;if("unauthenticated"===e||"initializing"===e||"disabled"===e||3===this._serviceDescriptionLoadStatus)return Promise.reject(new n("directions-view-model:not-loaded","Cannot get directions until view model loads."));this._set("error",null),this._activeRouteController&&(this._activeRouteController.abort(),this._activeRouteController=null);const{apiKey:t,departureTime:r}=this,o="now"===r,i="now"===r?new Date:r;if(i&&!o){const e=60*i.getTimezoneOffset()*1e3;i.setTime(i.getTime()-e)}const s=this.routeParameters.clone();if(s.set({startTime:i,startTimeIsUTC:o,directionsLanguage:this._directionsLanguage,apiKey:t}),this.selectedTravelMode&&(s.travelMode=this.selectedTravelMode),this.stops.length<=1){const e=new n("directions-view-model:not-enough-stops","Not enough stops for routing");return this._set("error",e),Promise.reject(e)}const a=new AbortController,{signal:l}=a;this._activeRouteController=a;const u=this._enqueue((()=>{const e=this.stops.clone().toArray(),t={},r=r=>{const o=r&&r.routeResults&&r.routeResults[0]&&r.routeResults[0].stops||[];(r&&r.routeResults&&r.routeResults[0]&&r.routeResults[0].directions&&r.routeResults[0].directions.features||[]).map((r=>{for(let o=0;o<e.length;o++)if(r.attributes.text.indexOf(e[o].attributes.Name)>-1){const i=e[o].attributes.Name;r.attributes.text=r.attributes.text.replace(i,t[i]),r._associatedStop=e[o];break}})),e.map((e=>e.attributes.Name=t[e.attributes.Name])),o.map((e=>{e.attributes.Name=t[e.attributes.Name]}))},o=e=>{if(e&&e.routeResults&&e.routeResults[0]){const t=e.routeResults[0],r=t.stops||[],o=this.stops.clone().toArray();let i=t.directions&&t.directions.routeName||t.routeName||"";r.map(((e,t)=>{const r=e.attributes,s=o[t].attributes;i=i.replace(r.Name,s.Name),Object.keys(r).forEach((e=>{0===e.indexOf("Cumul_")&&(s[e]=r[e])})),s.ArriveCurbApproach=r.ArriveCurbApproach,s.ArriveTime=r.ArriveTime,s.ArriveTimeUTC=r.ArriveTimeUTC,s.DepartCurbApproach=r.DepartCurbApproach,s.DepartTime=r.DepartTime,s.DepartTimeUTC=r.DepartTimeUTC,s.Sequence=r.Sequence,s.Status=r.Status})),t.directions&&(t.directions.routeName=i),null!==t.route&&(t.route.attributes.Name=i),t.routeName=i}},i=e=>{const r=e&&e.routeResults&&e.routeResults[0]&&e.routeResults[0].stops||[],o=this.stops.toArray();let i=r.length===o.length,s=0;for(;i&&s<r.length;)i=i&&t[r[s].attributes.Name]===o[s++].attributes.Name;return i};return(()=>{e.map((e=>{const r=e.attributes,o=`${(r.Name||"[not yet geocoded]").substr(0,100)}_#${++this._stopId}`;t[o]=r.Name,r.Name=o}))})(),s.stops=new b({doNotLocateOnRestrictedElements:!0,features:e}),this._routeTask.solve(s,{signal:l}).then((e=>i(e)?(o(e),r(e),this._set("lastRoute",e),e):(M.warn("Response stops don't match current stops of the ViewModel, invalidating the results."),this._set("lastRoute",null),null))).catch((e=>{throw r(null),e}))})).then((e=>(this._activeRouteController=null,this.notifyChange("state"),this.zoomToRoute(),e))).catch((e=>{if(this._activeRouteController=null,this.notifyChange("state"),!p.isAbortError(e))throw e=new n("directions-view-model:unable-to-route","Unable to route to these addresses",{error:e}),this._set("error",e),e}));return this.notifyChange("state"),u},a.getCostAttribute=function(e){const t=this.serviceDescription&&this.serviceDescription.networkDataset.networkAttributes||[];let r="";for(let o=0;o<t.length;o++)if(t[o].name===e&&"esriNAUTCost"===t[o].usageType){r=t[o];break}return r},a.reset=function(){this.stops.removeAll(),this.clearHighlights(),this._set("lastRoute",null)},a.zoomToRoute=function(){const{directionLines:e,view:t}=this;if(!e||!t)return;const r=g.graphicsExtent(e),o=r.width>r.height;this.callGoTo({target:r.expand(o?2:1)})},a._loadServiceDescription=function(){var t=e._asyncToGenerator((function*(){const e=yield w.fetchServiceDescription(this.routeServiceUrl,this.apiKey);this._set("serviceDescription",e)}));function r(){return t.apply(this,arguments)}return r}(),a._enqueue=function(e){this._requestQueueTail||(this._requestQueueTail=Promise.resolve());const t=new Promise(((t,r)=>{this._requestQueueTail.catch((()=>{})).then((()=>{try{const o=e.call(this);p.isPromiseLike(o)?o.then(t,r):t(o)}catch(o){r(o)}}))}));return this._requestQueueTail=t,t},a._addStopsToLayer=function(){this._stopLayer.graphics.removeAll();const e=this.stops.clone().map(((e,t)=>{const{first:r,middle:o,last:i,unlocated:s,waypoint:n}=this.stopSymbols;return L.isWaypoint(e)?e.symbol=n:void 0===e.attributes.Status?e.symbol=0===t?r:t===this.stops.length-1?i:o:e.symbol=L.isWaypoint(e)?n:L.isStopLocated(e)?L.isFirstStop(e)?r:L.isLastStop(e)?i:o:s,e}));this._stopLayer.graphics.addMany(e)},a._addRouteToLayer=function(){this._routeLayer.graphics.removeAll();const{directionLines:e}=this;e&&(e.forEach((e=>{e.symbol=this.routeSymbol})),this._routeLayer.graphics.addMany(e))},e._createClass(i,[{key:"_directionsLanguage",get:function(){const{routeParameters:e,serviceDescription:t}=this,{directionsSupportedLanguages:r}=t;if(!r)return;const o=(e.directionsLanguage||_.getLocale()).slice(0,2);return r.find((e=>e.toLowerCase().slice(0,2)===o))}},{key:"_routeTask",get:function(){return new S(this.routeServiceUrl)}},{key:"impedanceAttribute",get:function(){var e,t,r,o,i,s;const n=null!=(e=null!=(t=null==(r=this.routeParameters)||null==(o=r.travelMode)?void 0:o.impedanceAttributeName)?t:null==(i=this.routeParameters)?void 0:i.impedanceAttribute)?e:null==(s=this.serviceDescription)?void 0:s.impedance;return this.getCostAttribute(n)}},{key:"maxStops",set:function(e){const t=50,r=2;e=e<=r?r:e>t?t:e,this._set("maxStops",e)}},{key:"selectedTravelMode",get:function(){const{serviceDescription:e}=this;if(!e)return null;const{defaultTravelMode:t,supportedTravelModes:r=[]}=e;let o=null;for(let i=0;i<r.length;i++)r[i].id===t&&(o=r[i]);return o||r[0]||null},set:function(e){void 0!==e?this._override("selectedTravelMode",e):this._clearOverride("selectedTravelMode")}},{key:"state",get:function(){const e=this._serviceDescriptionLoadStatus;return 4===e?"unauthenticated":0===e?"disabled":1===e?"initializing":this._activeRouteController?"routing":3===e||this.error?"error":"ready"}},{key:"stopSymbols",set:function(e){const t={...k,...e};this._set("stopSymbols",t)}},{key:"timeAttribute",get:function(){var e,t,r,o,i,s;const n=null!=(e=null!=(t=null==(r=this.routeParameters)||null==(o=r.travelMode)?void 0:o.timeAttributeName)?t:null==(i=this.routeParameters)?void 0:i.directionsTimeAttribute)?e:null==(s=this.serviceDescription)?void 0:s.directionsTimeAttribute;return this.getCostAttribute(n)}},{key:"travelModes",get:function(){var e,t;return null!=(e=null==(t=this.serviceDescription)?void 0:t.supportedTravelModes)?e:[]}}]),i}(R.GoToMixin(a.EventedAccessor));return t.__decorate([h.property()],N.prototype,"_directionsLanguage",null),t.__decorate([h.property({type:S})],N.prototype,"_routeTask",null),t.__decorate([h.property()],N.prototype,"apiKey",void 0),t.__decorate([h.property()],N.prototype,"departureTime",void 0),t.__decorate([h.property({aliasOf:"lastRoute.routeResults.0.directions.features"})],N.prototype,"directionLines",void 0),t.__decorate([h.property({readOnly:!0})],N.prototype,"impedanceAttribute",null),t.__decorate([h.property({readOnly:!0})],N.prototype,"lastRoute",void 0),t.__decorate([h.property({value:50})],N.prototype,"maxStops",null),t.__decorate([h.property()],N.prototype,"routeSymbol",void 0),t.__decorate([h.property({type:T})],N.prototype,"routeParameters",void 0),t.__decorate([h.property()],N.prototype,"routeServiceUrl",void 0),t.__decorate([h.property()],N.prototype,"selectedTravelMode",null),t.__decorate([h.property({readOnly:!0})],N.prototype,"serviceDescription",void 0),t.__decorate([h.property({readOnly:!0})],N.prototype,"state",null),t.__decorate([h.property()],N.prototype,"error",void 0),t.__decorate([h.property({type:s})],N.prototype,"stops",void 0),t.__decorate([h.property({value:k})],N.prototype,"stopSymbols",null),t.__decorate([h.property({readOnly:!0})],N.prototype,"timeAttribute",null),t.__decorate([h.property()],N.prototype,"travelModes",null),t.__decorate([h.property()],N.prototype,"view",void 0),t.__decorate([h.property()],N.prototype,"getDirections",null),t.__decorate([h.property()],N.prototype,"zoomToRoute",null),N=t.__decorate([v.subclass("esri.widgets.Directions.DirectionsViewModel")],N),N}));
