/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../Color","../../config","../../Graphic","../../symbols","../../core/Collection","../../core/Error","../../core/Evented","../../core/HandleOwner","../../core/maybe","../../core/promiseUtils","../../core/reactiveUtils","../../core/accessorSupport/decorators/aliasOf","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/cast","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/subclass","../../intl/locale","../../layers/GraphicsLayer","../../layers/RouteLayer","../../layers/support/DefaultSymbols","../../rest/networkService","../../rest/support/RouteParameters","../../rest/support/Stop","../support/GoTo","../../symbols/SimpleLineSymbol","../../symbols/SimpleMarkerSymbol","../../symbols/PictureMarkerSymbol"],(function(e,t,r,o,i,s,n,l,a,c,u,d,p,h,y,v,_,m,f,g,w,S,b,C,T,D,L,M,A,P){"use strict";function z(e){return Array.isArray(e)&&e.length>0&&e[0]instanceof i}function k(e){return n.isCollection(e)&&e.length>0&&e.getItemAt(0)instanceof i}function N(e){return"esri.rest.support.Stop"===(null==e?void 0:e.declaredClass)}const U=[105,220,255],R=new M({color:U,width:7,cap:"round",join:"round"}),O={first:new A({color:U,size:19,outline:{color:[51,51,51],width:3}}),middle:new A({color:[51,51,51],size:12,outline:{color:U,width:3}}),last:new P({width:23,height:23,url:`data:image/svg+xml;base64,${btoa('<svg width="30" height="30" viewBox="0 0 30 30" xmlns="http://www.w3.org/2000/svg"><g fill-rule="nonzero" fill="none"><path d="M15.15.3C6.9.3.3 6.9.3 15.15S6.9 29.7 15.15 29.7 29.7 23.1 29.7 15.15C29.7 6.9 23.25.3 15.15.3z" fill="#333"/><path d="M15 4.8C9.3 4.8 4.8 9.45 4.8 15c0 5.55 4.65 10.2 10.2 10.2 5.55 0 10.2-4.5 10.2-10.2 0-5.55-4.5-10.2-10.2-10.2z" fill="#69DCFF"/><path fill="#333" d="M10.5 10.5h9v9h-9z"/></g></svg>')}`}),unlocated:new P({height:18,width:18,url:`data:image/svg+xml;base64,${btoa('<svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="M10.1.2C4.6.2.2 4.6.2 10.1s4.4 9.7 9.9 9.7 9.7-4.4 9.7-9.7c0-5.5-4.3-9.9-9.7-9.9z" fill="#333" fill-rule="nonzero"/><path d="M10 2.7c-4.08 0-7.3 3.328-7.3 7.3s3.328 7.3 7.3 7.3 7.3-3.22 7.3-7.3c0-3.972-3.22-7.3-7.3-7.3z" fill="#69DCFF" fill-rule="nonzero"/><path d="M11.414 10l5.304-5.303-1.415-1.415L10 8.586 4.697 3.282 3.282 4.697 8.586 10l-5.304 5.303 1.415 1.415L10 11.414l5.303 5.304 1.415-1.415L11.414 10z" fill="#333"/></g></svg>')}`}),waypoint:new A({color:[255,255,255],size:10,outline:{color:[20,89,127],width:2.5}})};var x;!function(e){e[e.Active=0]="Active",e[e.Complete=1]="Complete",e[e.Failed=2]="Failed",e[e.Idle=3]="Idle",e[e.Suspended=4]="Suspended"}(x||(x={}));let I=function(t){function s(e){var r;return(r=t.call(this,e)||this)._highlightLayer=new w({listMode:"hide"}),r._loadPromise=null,r._loadController=null,r._routeLayer=new S({listMode:"hide",defaultSymbols:new b({directionLines:R,directionPoints:new A({size:0}),routeInfo:new M({width:0}),firstStop:O.first,middleStop:O.middle,lastStop:O.last,invalidStop:O.unlocated,waypointStop:O.waypoint,breakStop:O.waypoint}),url:r.routeServiceUrl}),r._routeController=null,r._serviceDescriptionStatus=x.Idle,r.apiKey=void 0,r.departureTime="now",r.lastRoute=null,r.routeParameters=new T({directionsLengthUnits:"kilometers",findBestSequence:!1,restrictUTurns:"at-dead-ends-and-intersections",returnZ:!0,startTime:null,startTimeIsUTC:!0,useHierarchy:!0,useTimeWindows:!1}),r.routeSymbol=R,r.serviceDescription=null,r.error=null,r.stops=null,r.view=null,r}e._inheritsLoose(s,t);var n=s.prototype;return n.initialize=function(){this.handles.add([p.on((()=>this.stops),"change",(()=>{this.clearResults()})),p.watch((()=>{var e;return null==(e=this.view)?void 0:e.map}),((e,t)=>{const r=[this._routeLayer,this._highlightLayer];t&&t.removeMany(r),e&&e.addMany(r)}),p.initial),p.watch((()=>this.routeServiceUrl),(e=>{if(this._routeLayer.url=e,u.isSome(this._loadController))return this._loadController.abort(),this._loadController=null,this._loadPromise=null,this._set("serviceDescription",null),void this.load();this._set("serviceDescription",null)}),p.syncAndInitial)])},n.destroy=function(){var e;null==(e=this.view)||e.map.removeMany([this._routeLayer,this._highlightLayer])},n.castStops=function(e){return z(e)||k(e)?e.map((e=>D.fromPortalJSON(e.toJSON()))):e},n.load=function(){var t=e._asyncToGenerator((function*(){if(u.isSome(this._loadPromise))return this._loadPromise;this._loadPromise=this._load(),yield this._loadPromise,this._loadPromise=null}));function r(){return t.apply(this,arguments)}return r}(),n.highlightSegment=function(e){const{geometry:t,symbol:o}=e;if(u.isNone(this.view)||u.isNone(t)||u.isNone(o))return;this.clearHighlights();const s=o.clone();s.color=new r([0,0,0,.8]),s.width=Math.ceil(s.width/2);const n=new i({geometry:t,symbol:s});this._highlightLayer.add(n)},n.clearHighlights=function(){this._highlightLayer.removeAll()},n.centerAt=function(e){if(u.isNone(this.view))return;const t=N(e)?u.unwrap(e.geometry):e;this.callGoTo({target:t})},n.clearResults=function(){this._set("lastRoute",null)},n.getDirections=function(){var t=e._asyncToGenerator((function*(){const{state:e}=this;if("unauthenticated"===e||"initializing"===e||"disabled"===e||this._serviceDescriptionStatus===x.Failed)return Promise.reject(new l("directions-view-model:not-loaded","Cannot get directions until view model loads."));this._set("error",null),u.isSome(this._routeController)&&(this._routeController.abort(),this._routeController=null);const{apiKey:t,departureTime:r}=this,o="now"===r,i="now"===r?new Date:r;if(i&&!o){const e=60*i.getTimezoneOffset()*1e3;i.setTime(i.getTime()-e)}const s=u.isSome(this.view)?this.view.spatialReference:null,n=this.routeParameters.clone();if(n.set({startTime:i,startTimeIsUTC:o,directionsLanguage:this._directionsLanguage,apiKey:t,outSpatialReference:s}),u.isSome(this.selectedTravelMode)&&(n.travelMode=this.selectedTravelMode),this.stops.length<2){const e=new l("directions-view-model:not-enough-stops","Not enough stops for routing");return this._set("error",e),Promise.reject(e)}this._routeController=new AbortController;const{signal:a}=this._routeController;let c=null;try{c=yield this._routeLayer.solve(n,{signal:a}),this._routeLayer.update(c),this._set("lastRoute",c)}catch(p){if(!d.isAbortError(p)){const e=new l("directions-view-model:unable-to-route","Unable to route to these addresses",{error:p});throw this._set("error",e),this._set("lastRoute",null),e}}finally{this._routeController=null}return this.zoomToRoute(),c}));function r(){return t.apply(this,arguments)}return r}(),n.getCostAttribute=function(e){const t=(u.isSome(this.serviceDescription)?this.serviceDescription.networkDataset.networkAttributes:[]).find((t=>t.name===e&&"esriNAUTCost"===t.usageType));return null!=t?t:null},n.reset=function(){this.clearHighlights(),this.clearResults(),this._routeLayer.removeAll()},n.zoomToRoute=function(){const{view:e,lastRoute:t}=this;if(u.isNone(e)||u.isNone(t))return;const{routeInfo:r}=t;if(u.isNone(r))return;const{geometry:o}=r;if(u.isNone(o))return;const{extent:i}=o,s=i.width>i.height,n=i.clone().expand(s?2:1);this.callGoTo({target:n})},n._load=function(){var t=e._asyncToGenerator((function*(){if(u.isSome(this.serviceDescription))return;u.isSome(this._loadController)&&(this._loadController.abort(),this._loadController=null),this._loadController=new AbortController;const{signal:e}=this._loadController;try{this._serviceDescriptionStatus=x.Active;const t=yield C.fetchServiceDescription(this.routeServiceUrl,this.apiKey,{signal:e});this._set("serviceDescription",t),this._serviceDescriptionStatus=x.Complete}catch(t){if(d.isAbortError(t))return void(this._serviceDescriptionStatus=x.Idle);if("identity-manager:user-aborted"===t.name)return void(this._serviceDescriptionStatus=x.Suspended);const e=new l("directions-view-model:service-metadata-unavailable","Cannot load route service metadata",{error:t});throw this._serviceDescriptionStatus=x.Failed,this._set("error",e),e}finally{this._loadController=null}}));function r(){return t.apply(this,arguments)}return r}(),e._createClass(s,[{key:"_directionsLanguage",get:function(){var e;if(u.isNone(this.serviceDescription))return;const t=this.serviceDescription.directionsSupportedLanguages;if(!t)return;const r=(null!=(e=this.routeParameters.directionsLanguage)?e:g.getLocale()).slice(0,2);return t.find((e=>e.toLowerCase().slice(0,2)===r))}},{key:"impedanceAttribute",get:function(){var e,t,r;const o=u.isSome(this.serviceDescription)?this.serviceDescription.impedance:null,i=null!=(e=null!=(t=null==(r=this.routeParameters.travelMode)?void 0:r.impedanceAttributeName)?t:this.routeParameters.impedanceAttribute)?e:o;return this.getCostAttribute(i)}},{key:"maxStops",set:function(e){const t=50,r=2;e=e<=r?r:e>t?t:e,this._set("maxStops",e)}},{key:"routeLayer",get:function(){return this._routeLayer}},{key:"routeServiceUrl",get:function(){return o.routeServiceUrl},set:function(e){null!=e?this._override("routeServiceUrl",e):this._clearOverride("routeServiceUrl")}},{key:"selectedTravelMode",get:function(){const{serviceDescription:e}=this;if(u.isNone(e))return null;const{defaultTravelMode:t,supportedTravelModes:r=[]}=e;return r.find((e=>e.id===t))||r[0]||null},set:function(e){void 0!==e?this._override("selectedTravelMode",e):this._clearOverride("selectedTravelMode")}},{key:"state",get:function(){if(u.isSome(this._routeController))return"routing";if(u.isSome(this.error))return"error";switch(this._serviceDescriptionStatus){case x.Suspended:return"unauthenticated";case x.Idle:return"disabled";case x.Active:return"initializing";case x.Failed:return"error";default:return"ready"}}},{key:"stopSymbols",set:function(e){const t={...O,...e};this._set("stopSymbols",t)}},{key:"timeAttribute",get:function(){var e,t,r;const o=null!=(e=null!=(t=null==(r=this.routeParameters.travelMode)?void 0:r.timeAttributeName)?t:this.routeParameters.directionsTimeAttribute)?e:u.isSome(this.serviceDescription)?this.serviceDescription.directionsTimeAttribute:null;return this.getCostAttribute(o)}},{key:"travelModes",get:function(){return u.isSome(this.serviceDescription)?this.serviceDescription.supportedTravelModes:[]}}]),s}(c.HandleOwnerMixin(L.GoToMixin(a.EventedAccessor)));t.__decorate([m.property()],I.prototype,"_directionsLanguage",null),t.__decorate([m.property()],I.prototype,"_routeController",void 0),t.__decorate([m.property()],I.prototype,"_serviceDescriptionStatus",void 0),t.__decorate([m.property()],I.prototype,"apiKey",void 0),t.__decorate([m.property()],I.prototype,"departureTime",void 0),t.__decorate([m.property({readOnly:!0})],I.prototype,"impedanceAttribute",null),t.__decorate([m.property({readOnly:!0})],I.prototype,"lastRoute",void 0),t.__decorate([m.property({value:50})],I.prototype,"maxStops",null),t.__decorate([m.property()],I.prototype,"routeLayer",null),t.__decorate([m.property({type:T,nonNullable:!0})],I.prototype,"routeParameters",void 0),t.__decorate([m.property()],I.prototype,"routeServiceUrl",null),t.__decorate([m.property()],I.prototype,"routeSymbol",void 0),t.__decorate([m.property()],I.prototype,"selectedTravelMode",null),t.__decorate([m.property({readOnly:!0})],I.prototype,"serviceDescription",void 0),t.__decorate([m.property({readOnly:!0})],I.prototype,"state",null),t.__decorate([m.property()],I.prototype,"error",void 0),t.__decorate([h.aliasOf("routeLayer.stops")],I.prototype,"stops",void 0),t.__decorate([_.cast("stops")],I.prototype,"castStops",null),t.__decorate([m.property({value:O})],I.prototype,"stopSymbols",null),t.__decorate([m.property({readOnly:!0})],I.prototype,"timeAttribute",null),t.__decorate([m.property()],I.prototype,"travelModes",null),t.__decorate([m.property()],I.prototype,"view",void 0),t.__decorate([m.property()],I.prototype,"getDirections",null),t.__decorate([m.property()],I.prototype,"zoomToRoute",null),I=t.__decorate([f.subclass("esri.widgets.Directions.DirectionsViewModel")],I);return I}));
