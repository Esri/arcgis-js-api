/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../Color","../../Graphic","../../symbols","../../core/analysisThemeUtils","../../core/Collection","../../core/deprecate","../../core/Error","../../core/Evented","../../core/HandleOwner","../../core/Logger","../../core/maybe","../../core/promiseUtils","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/cast","../../core/arrayUtils","../../core/accessorSupport/decorators/subclass","../../intl/locale","../../layers/GraphicsLayer","../../layers/RouteLayer","../../layers/support/RouteStopSymbols","../../layers/support/RouteSymbols","../../rest/networkService","../../rest/support/RouteParameters","../../rest/support/Stop","../../rest/support/TravelMode","../support/GoTo","../../symbols/SimpleLineSymbol","../../symbols/SimpleMarkerSymbol","../../symbols/PictureMarkerSymbol"],(function(e,t,r,o,i,s,n,l,a,c,u,p,d,h,y,m,g,v,f,_,w,S,b,L,T,C,M,D,A,P,N,O){"use strict";function k(e){return"esri.Graphic"===e?.declaredClass}function z(e){return Array.isArray(e)&&e.length&&k(e[0])}function R(e){return n.isCollection(e)&&e.length&&k(e.getItemAt(0))}function x(e){return"esri.rest.support.Stop"===e?.declaredClass}var U;!function(e){e[e.Active=0]="Active",e[e.Complete=1]="Complete",e[e.Failed=2]="Failed",e[e.Idle=3]="Idle",e[e.Suspended=4]="Suspended"}(U||(U={}));const E="esri.widgets.Directions.DirectionsViewModel",G=p.getLogger(E);let I=function(t){function i(e){var r;return(r=t.call(this,e)||this)._highlightLayer=new w({listMode:"hide",internal:!0}),r._highlight=null,r._legacyLayer=null,r._loadPromise=null,r._loadController=null,r._routeController=null,r._serviceDescriptionStatus=U.Idle,r.apiKey=void 0,r.defaultTravelMode=null,r.departureTime="now",r.lastError=null,r.lastRoute=null,r.layer=null,r.maxStops=50,r.routeParameters=new C({directionsLengthUnits:"kilometers",findBestSequence:!1,returnZ:!0,startTime:null,startTimeIsUTC:!0,useTimeWindows:!1}),r.serviceDescription=null,r.view=null,r}e._inheritsLoose(i,t);var c=i.prototype;return c.initialize=function(){this.addHandles([y.on((()=>d.applySome(this.layer,(e=>e.stops))),"change",(()=>{this.clearResults()})),y.watch((()=>this.layer),((e,t)=>{if(d.isSome(e)){for(;e.stops.length<2;)e.stops.add(new M);this._set("defaultTravelMode",null),this.addHandles(y.when((()=>d.isSome(this.serviceDescription)&&d.unwrap(d.unwrap(e.routeInfo)?.analysisSettings)?.travelMode),(e=>{this.defaultTravelMode=this._resolveDefaultTravelMode(e)}),{once:!0}))}d.isNone(e)&&(this.layer=this.legacyLayer),d.isSome(t)&&t===this.legacyLayer&&this.view?.map?.remove(t)}),y.syncAndInitial),y.watch((()=>this.view?.map),((e,t)=>{this.layer===this.legacyLayer&&(t?.remove(this.layer),e?.add(this.layer)),t?.remove(this._highlightLayer),e?.add(this._highlightLayer)}),y.initial)])},c.destroy=function(){this.view?.map?.remove(this._highlightLayer),this.layer===this.legacyLayer&&this.view?.map?.remove(this.layer)},c.castStops=function(e){return z(e)||R(e)?e.map((e=>M.fromGraphic(e))):e},c.load=function(){var t=e._asyncToGenerator((function*(){if(d.isSome(this._loadPromise))return this._loadPromise;this._loadPromise=this._load(),yield this._loadPromise,this._loadPromise=null}));function r(){return t.apply(this,arguments)}return r}(),c.highlight=function(){var t=e._asyncToGenerator((function*(e){this.clearHighlights();const t=yield this.view.whenLayerView(this.layer);this._highlight=t.highlight(e)}));function r(e){return t.apply(this,arguments)}return r}(),c.highlightSegment=function(e){l.deprecatedFunction(G,"highlightSegment",{replacement:"highlight",version:"4.24",warnOnce:!0});const{geometry:t,symbol:i}=e;if(d.isNone(this.view)||d.isNone(t)||d.isNone(i))return;this.clearHighlights();const s=i.clone();s.color=new r([0,0,0,.8]),s.width=Math.ceil(s.width/2);const n=new o({geometry:t,symbol:s});this._highlightLayer.add(n)},c.clearHighlights=function(){this._highlightLayer.removeAll(),d.isSome(this._highlight)&&(this._highlight.remove(),this._highlight=null)},c.centerAt=function(e){if(d.isNone(this.view))return;const t=x(e)||k(e)?e.geometry:e;d.isNone(t)||this.callGoTo({target:t})},c.clearResults=function(){this._set("lastRoute",null),this.layer.removeResult()},c.getDirections=function(){var t=e._asyncToGenerator((function*(){const{apiKey:e,departureTime:t,layer:r,state:o}=this;if(d.isNone(r))throw new a("directions-view-model:missing-route-layer","A route layer must be associated with the view model.");if(r===this.legacyLayer&&l.deprecated(G,"Using the Directions widget or view model without setting `layer` is deprecated.",{see:"https://developers.arcgis.com/javascript/latest/api-reference/esri-widgets-Directions-DirectionsViewModel.html#layer",version:"4.24",warnOnce:!0}),"unauthenticated"===o||"initializing"===o||"disabled"===o||this._serviceDescriptionStatus===U.Failed)throw new a("directions-view-model:not-loaded","Cannot get directions until view model loads.");this._set("lastError",null),d.isSome(this._routeController)&&(this._routeController.abort(),this._routeController=null);const i="now"===t,s="now"===t?new Date:t;if(s&&!i){const e=60*s.getTimezoneOffset()*1e3;s.setTime(s.getTime()-e)}const n=d.isSome(this.view)?this.view.spatialReference:null,c=this.routeParameters.clone();c.set({startTime:s,startTimeIsUTC:i,directionsLanguage:this._directionsLanguage,apiKey:e,outSpatialReference:n}),d.isSome(this.selectedTravelMode)&&(c.travelMode=this.selectedTravelMode);if(r.stops.filter((({geometry:e})=>d.isSome(e))).length<2){const e=new a("directions-view-model:not-enough-stops","Not enough stops for routing");throw this._set("lastError",e),e}this._routeController=new AbortController;const{signal:u}=this._routeController;let p=null;try{p=yield r.solve(c,{signal:u})}catch(y){if(!h.isAbortError(y)){const e=new a("directions-view-model:unable-to-route","Unable to route to these addresses",{error:y});throw this._set("lastError",e),this._set("lastRoute",null),e}}finally{this._routeController=null}for(const l of p.stops)d.isNone(l.geometry)&&(l.name=null);return r.update(p),this._set("lastRoute",p),this.zoomToRoute(),p}));function r(){return t.apply(this,arguments)}return r}(),c.getCostAttribute=function(e){return(d.unwrap(this.serviceDescription)?.networkDataset.networkAttributes??[]).find((({name:t,usageType:r})=>t===e&&"cost"===r))??null},c.reset=function(){this.clearHighlights(),this.clearResults(),d.isSome(this.layer)&&(this.layer.removeAll(),this.layer.stops=new n([new M,new M]))},c.save=function(){return this.layer.save()},c.saveAs=function(e,t={}){return this.layer.saveAs(e,t)},c.zoomToRoute=function(){const{view:e,layer:{routeInfo:t}}=this;if(d.isNone(e)||d.isNone(t))return;const{geometry:r}=t;if(d.isNone(r))return;const{extent:o}=r,i=o.width>o.height,s=o.clone().expand(i?2:1);this.callGoTo({target:s})},c._getLegacyLayer=function(){const e=s.getAccentColor();return new S({listMode:"hide",defaultSymbols:new L({directionLines:new P({color:e,width:7,cap:"round",join:"round"}),directionPoints:null,routeInfo:null,stops:new b({break:new N({color:[255,255,255],size:10,outline:{color:[20,89,127],width:2.5}}),first:new N({color:e,size:19,outline:{color:[51,51,51],width:3}}),last:new O({width:23,height:23,url:`data:image/svg+xml;base64,${btoa(`<svg width="30" height="30" viewBox="0 0 30 30" xmlns="http://www.w3.org/2000/svg"><g fill-rule="nonzero" fill="none"><path d="M15.15.3C6.9.3.3 6.9.3 15.15S6.9 29.7 15.15 29.7 29.7 23.1 29.7 15.15C29.7 6.9 23.25.3 15.15.3z" fill="#333"/><path d="M15 4.8C9.3 4.8 4.8 9.45 4.8 15c0 5.55 4.65 10.2 10.2 10.2 5.55 0 10.2-4.5 10.2-10.2 0-5.55-4.5-10.2-10.2-10.2z" fill="${e.toHex()}"/><path fill="#333" d="M10.5 10.5h9v9h-9z"/></g></svg>`)}`}),middle:new N({color:[51,51,51],size:12,outline:{color:e,width:3}}),unlocated:new O({height:18,width:18,url:`data:image/svg+xml;base64,${btoa(`<svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="M10.1.2C4.6.2.2 4.6.2 10.1s4.4 9.7 9.9 9.7 9.7-4.4 9.7-9.7c0-5.5-4.3-9.9-9.7-9.9z" fill="#333" fill-rule="nonzero"/><path d="M10 2.7c-4.08 0-7.3 3.328-7.3 7.3s3.328 7.3 7.3 7.3 7.3-3.22 7.3-7.3c0-3.972-3.22-7.3-7.3-7.3z" fill="${e.toHex()}" fill-rule="nonzero"/><path d="M11.414 10l5.304-5.303-1.415-1.415L10 8.586 4.697 3.282 3.282 4.697 8.586 10l-5.304 5.303 1.415 1.415L10 11.414l5.303 5.304 1.415-1.415L11.414 10z" fill="#333"/></g></svg>`)}`}),waypoint:new N({color:[255,255,255],size:10,outline:{color:[20,89,127],width:2.5}})})}),stops:[{},{}]})},c._load=function(){var t=e._asyncToGenerator((function*(){if(d.isSome(this.serviceDescription)||d.isNone(this.layer))return;d.isSome(this._loadController)&&(this._loadController.abort(),this._loadController=null),this._loadController=new AbortController;const{signal:e}=this._loadController;try{this._serviceDescriptionStatus=U.Active;const t=yield T.fetchServiceDescription(this.layer.url,this.apiKey,{signal:e});this._set("serviceDescription",t),this._serviceDescriptionStatus=U.Complete}catch(t){if(h.isAbortError(t))return void(this._serviceDescriptionStatus=U.Idle);if("identity-manager:user-aborted"===t.name)return void(this._serviceDescriptionStatus=U.Suspended);const e=new a("directions-view-model:service-metadata-unavailable","Cannot load route service metadata",{error:t});throw this._serviceDescriptionStatus=U.Failed,this._set("lastError",e),e}finally{this._loadController=null}}));function r(){return t.apply(this,arguments)}return r}(),c._resolveDefaultTravelMode=function(e){if(d.isNone(this.serviceDescription))return null;const{defaultTravelMode:t,supportedTravelModes:r}=this.serviceDescription,o=/^<(?<name>.*)>$/i.exec(e.name)?.groups?.name;if(o){const i=r?.find((({name:e})=>e.toLocaleLowerCase()===o.trim().toLocaleLowerCase())),s=i??t;return D.fromJSON({...s.toJSON(),...e.toJSON()})}const i=r?.find((({name:t})=>t.toLocaleLowerCase()===e.name.toLocaleLowerCase()));return i??t},e._createClass(i,[{key:"_directionsLanguage",get:function(){if(d.isNone(this.serviceDescription))return;const e=this.serviceDescription.directionsSupportedLanguages;if(!e)return;const t=d.unwrapOr(this.routeParameters.directionsLanguage,_.getLocale()).slice(0,2);return e.find((e=>e.toLowerCase().slice(0,2)===t))}},{key:"impedanceAttribute",get:function(){const e=d.unwrap(this.routeParameters.travelMode)?.impedanceAttributeName??d.unwrap(this.routeParameters.impedanceAttribute)??d.unwrap(this.serviceDescription)?.impedance??null;return this.getCostAttribute(e)}},{key:"legacyLayer",get:function(){return d.isNone(this._legacyLayer)&&(this._legacyLayer=this._getLegacyLayer()),this._legacyLayer}},{key:"routeServiceUrl",get:function(){return l.deprecatedProperty(G,"routeServiceUrl",{replacement:"layer.url",version:"4.24",warnOnce:!0}),this.legacyLayer.url},set:function(e){l.deprecatedProperty(G,"routeServiceUrl",{replacement:"layer.url",version:"4.24",warnOnce:!0}),this.legacyLayer.url=e}},{key:"routeSymbol",get:function(){return l.deprecatedProperty(G,"routeSymbol",{replacement:"layer.defaultSymbols.directionLines",version:"4.24",warnOnce:!0}),this.legacyLayer.defaultSymbols.directionLines},set:function(e){l.deprecatedProperty(G,"routeSymbol",{replacement:"layer.defaultSymbols.directionLines",version:"4.24",warnOnce:!0}),this.legacyLayer.defaultSymbols.directionLines=e}},{key:"selectedTravelMode",get:function(){return d.isNone(this.serviceDescription)?null:this.defaultTravelMode??this.serviceDescription.defaultTravelMode??this.serviceDescription.supportedTravelModes?.[0]??null},set:function(e){this._override("selectedTravelMode",e)}},{key:"state",get:function(){if(d.isSome(this._routeController))return"routing";if(d.isSome(this.lastError))return"error";switch(this._serviceDescriptionStatus){case U.Suspended:return"unauthenticated";case U.Idle:return"disabled";case U.Active:return"initializing";case U.Failed:return"error";default:return"ready"}}},{key:"stops",get:function(){return l.deprecatedProperty(G,"stops",{replacement:"layer.stops",version:"4.24",warnOnce:!0}),this.legacyLayer.stops},set:function(e){l.deprecatedProperty(G,"stops",{replacement:"layer.stops",version:"4.24",warnOnce:!0}),this.legacyLayer.stops=e}},{key:"stopSymbols",get:function(){return l.deprecatedProperty(G,"stopSymbols",{replacement:"layer.defaultSymbols.stops",version:"4.24",warnOnce:!0}),this.legacyLayer.defaultSymbols.stops},set:function(e){l.deprecatedProperty(G,"stopSymbols",{replacement:"layer.defaultSymbols.stops",version:"4.24",warnOnce:!0}),this.legacyLayer.defaultSymbols.stops=e}},{key:"timeAttribute",get:function(){const e=d.unwrap(this.routeParameters.travelMode)?.timeAttributeName??d.unwrap(this.routeParameters.directionsTimeAttribute)??d.unwrap(this.serviceDescription)?.directionsTimeAttribute??null;return this.getCostAttribute(e)}},{key:"travelModes",get:function(){const e=d.unwrap(this.serviceDescription)?.supportedTravelModes?.slice()??[];return d.isSome(this.defaultTravelMode)&&!e.includes(this.defaultTravelMode)&&e.unshift(this.defaultTravelMode),e}}]),i}(u.HandleOwnerMixin(A.GoToMixin(c.EventedAccessor)));t.__decorate([m.property()],I.prototype,"_directionsLanguage",null),t.__decorate([m.property()],I.prototype,"_routeController",void 0),t.__decorate([m.property()],I.prototype,"_serviceDescriptionStatus",void 0),t.__decorate([m.property()],I.prototype,"apiKey",void 0),t.__decorate([m.property()],I.prototype,"defaultTravelMode",void 0),t.__decorate([m.property()],I.prototype,"departureTime",void 0),t.__decorate([m.property({readOnly:!0})],I.prototype,"impedanceAttribute",null),t.__decorate([m.property()],I.prototype,"lastError",void 0),t.__decorate([m.property({readOnly:!0})],I.prototype,"lastRoute",void 0),t.__decorate([m.property()],I.prototype,"layer",void 0),t.__decorate([m.property({readOnly:!0})],I.prototype,"legacyLayer",null),t.__decorate([m.property({type:Number,range:{min:2,max:50},nonNullable:!0})],I.prototype,"maxStops",void 0),t.__decorate([m.property({type:C,nonNullable:!0})],I.prototype,"routeParameters",void 0),t.__decorate([m.property()],I.prototype,"routeServiceUrl",null),t.__decorate([m.property()],I.prototype,"routeSymbol",null),t.__decorate([m.property()],I.prototype,"selectedTravelMode",null),t.__decorate([m.property({readOnly:!0})],I.prototype,"serviceDescription",void 0),t.__decorate([m.property({readOnly:!0})],I.prototype,"state",null),t.__decorate([m.property()],I.prototype,"stops",null),t.__decorate([g.cast("stops")],I.prototype,"castStops",null),t.__decorate([m.property()],I.prototype,"stopSymbols",null),t.__decorate([m.property({readOnly:!0})],I.prototype,"timeAttribute",null),t.__decorate([m.property()],I.prototype,"travelModes",null),t.__decorate([m.property()],I.prototype,"view",void 0),t.__decorate([m.property()],I.prototype,"getDirections",null),t.__decorate([m.property()],I.prototype,"zoomToRoute",null),I=t.__decorate([f.subclass(E)],I);return I}));
