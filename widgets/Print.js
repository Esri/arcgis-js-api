// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../core/Collection","../core/events","../core/Logger","../core/urlUtils","../core/watchUtils","../core/accessorSupport/decorators","../tasks/support/PrintTemplate","./Widget","./Print/FileLink","./Print/PrintViewModel","./Print/TemplateOptions","./support/widget"],(function(t,e,i,a,s,n,o,l,r,p,d,c,u,h,_){"use strict";var b=a.ofType(c),v="esri-print esri-widget esri-widget--panel",y="esri-print__header-title",x="esri-print__input-text",f="esri-print__layout-tab-list",g="esri-print__layout-tab",m="esri-print__layout-section",O="esri-print__map-only-section",w="esri-print__scale-input",T="esri-print__loader",L="esri-print__advanced-options-button",k="esri-print__advanced-options-button-container",M="esri-print__advanced-options-button-title",I="esri-print__advanced-options-button-icon--opened",S="esri-print__advanced-options-button-icon--closed",F="esri-print__advanced-options-button-icon--closed-rtl",V="esri-print__refresh-button",C="esri-print__swap-button",P="esri-print__export-button",E="esri-print__form-section-container",N="esri-print__advanced-options-section",U="esri-print__advanced-options-container",A="esri-print__author-info-container",R="esri-print__copyright-info-container",D="esri-print__export-panel-container",q="esri-print__export-title",H="esri-print__exported-file",Y="esri-widget__anchor esri-print__exported-file-link",z="esri-print__exported-file-link-title",K="esri-print__height-container",B="esri-print__legend-info-container",W="esri-print__container",j="esri-print__panel-container",G="esri-print__scale-info-container",J="esri-print__scale-input-container",Q="esri-print__size-container",X="esri-print__width-container",Z="esri-widget--button",$="esri-button",tt="esri-select",et="esri-widget__heading",it="esri-input",at="esri-widget__anchor--disabled",st="esri-button--disabled",nt="esri-print__panel--error",ot="esri-print__exported-file--error",lt="esri-rotating",rt="esri-icon-download",pt="esri-icon-launch-link-external",dt="esri-icon-error",ct="esri-icon-right-triangle-arrow",ut="esri-icon-left-triangle-arrow",ht="esri-icon-down-arrow",_t="esri-icon-refresh",bt="esri-icon-loading-indicator",vt="esri-icon-swap",yt="esri-icon-printer",xt=n.getLogger("esri.widgets.Print");return function(t){function e(e,i){var a=t.call(this,e,i)||this;return a._activeTabFocusRequested=!1,a._advancedOptionsVisibleForLayout=!1,a._advancedOptionsVisibleForMapOnly=!1,a._awaitingServerResponse=!1,a._exportedFileNameMap={},a._layoutTabSelected=!0,a._pendingExportScroll=!1,a._rootNode=null,a.allowedFormats=null,a.allowedLayouts=null,a.exportedLinks=new b,a.iconClass=yt,a.label=void 0,a.templateOptions=new h,a.printServiceUrl=null,a.view=null,a.viewModel=new u,a._removeLink=function(t){var e=t.currentTarget["data-item"];e&&"error"===e.state&&a.exportedLinks.remove(e)},a._focusOnTabChange=a._focusOnTabChange.bind(a),a}return i.__extends(e,t),e.prototype.initialize=function(){var t=this;this.own([l.init(this,"viewModel.templatesInfo",(function(e){var i=t.templateOptions,a=i.format,s=i.layout;if(e){var n=s===e.layout.defaultValue||s&&"MAP_ONLY"===s.toUpperCase()||e.layout.choiceList&&e.layout.choiceList.indexOf(s)>-1,o=a===e.format.defaultValue||e.format.choiceList&&e.format.choiceList.indexOf(a)>-1;n||(s&&xt.warn("User sets an invalid layout, resetting it to the default valid one..."),t.templateOptions.layout=e.layout.defaultValue),o||(a&&xt.warn("User sets an invalid format, resetting it to the default valid one..."),t.templateOptions.format=e.format.defaultValue),s&&"MAP_ONLY"===s.toUpperCase()&&(t._layoutTabSelected=!1)}})),l.init(this,"templateOptions.format",(function(e){var i=t.viewModel.templatesInfo;if(i&&e){var a=!1;i.format.choiceList&&i.format.choiceList.forEach((function(i){i.toUpperCase()===e.toUpperCase()&&(t.templateOptions.format=i,a=!0)})),a||(t.templateOptions.format=i.format.defaultValue,xt.warn("User sets an invalid format, resetting it to the default valid one...")),t.scheduleRender()}})),l.init(this,"templateOptions.layout",(function(e){var i=t.viewModel.templatesInfo;if(i&&e){t._layoutTabSelected="MAP_ONLY"!==e.toUpperCase();var a=!t._layoutTabSelected;a||i.layout.choiceList&&i.layout.choiceList.forEach((function(i){i.toUpperCase()===e.toUpperCase()&&(t.templateOptions.layout=i,a=!0)})),a||(t.templateOptions.layout=i.layout.defaultValue,xt.warn("User sets an invalid layout, resetting it to the default valid one...")),t.scheduleRender()}})),l.init(this,"templateOptions.dpi",(function(e){e<=0?t.templateOptions.dpi=1:t.scheduleRender()})),l.init(this,"viewModel.view.scale",(function(e){var i=t.templateOptions,a=i.scale;i.scaleEnabled&&a||(t.templateOptions.scale=e)})),l.whenOnce(this,"printServiceUrl",(function(){var e=setTimeout((function(){t._awaitingServerResponse=!0,t.scheduleRender()}),500);t.viewModel.load().then((function(){return clearTimeout(e)}))}))]);var e=this.templateOptions,i=e.height,a=e.width;this.templateOptions.width=a||800,this.templateOptions.height=i||1100},e.prototype.render=function(){var t,e=this.templateOptions,i=e.attributionEnabled,a=e.author,s=e.copyright,n=e.dpi,o=e.format,l=e.height,r=e.layout,p=e.legendEnabled,d=e.scaleEnabled,c=e.scale,u=e.width,h="ready"!==this.get("viewModel.state"),b=this.renderTitleOrFileNameSection(),T=this.messages,H=this.get("viewModel.templatesInfo.format.choiceList")||[],Y=H.length>0?H.map((function(t){var e=t===o;return _.tsx("option",{key:t,selected:e,value:t},t.toUpperCase())})):_.tsx("option",{key:"format-default-option"},T.formatDefaultOption),z=_.tsx("div",{class:E},_.tsx("label",null,T.fileFormatTitle,_.tsx("select",{class:tt,onchange:this._updateFromOption,"data-target-property":"format",bind:this},Y))),at=this.get("viewModel.templatesInfo.layout.choiceList")||[],ot=at.length>0?at.map((function(t){var e=t===r,i=T[t]||t;return _.tsx("option",{key:t,selected:e,value:t},i)})):_.tsx("option",{key:"layout-default-option"},T.layoutDefaultOption),lt=_.tsx("div",{class:E},_.tsx("label",null,T.layoutTitle,_.tsx("select",{class:tt,onchange:this._updateFromOption,"data-target-property":"layout",bind:this},ot))),rt=_.tsx("div",{class:E},_.tsx("label",null,T.dpi,_.tsx("input",{type:"number",class:this.classes(x,it),"data-input-name":"dpi",onchange:this._handleDPIChange,value:""+n,min:"1",tabIndex:0,bind:this}))),pt=_.tsx("div",{class:this.classes(G,E)},_.tsx("label",null,_.tsx("input",{"data-option-name":"scaleEnabled",checked:d,type:"checkbox",tabIndex:0,onchange:this._toggleInputValue,bind:this}),T.scale),_.tsx("div",{class:J},_.tsx("input",{"aria-label":T.scaleLabel,"aria-valuenow":""+c,role:"spinbutton",type:"number",class:this.classes(x,it,w),tabIndex:0,"data-input-name":"scale",onchange:this._updateInputValue,disabled:!d,value:""+c,bind:this}),_.tsx("button",{type:"button","aria-label":T.reset,class:this.classes(Z,V,_t),tabIndex:0,onclick:this._resetToCurrentScale,bind:this}))),dt=this._advancedOptionsVisibleForLayout?_.tsx("div",{"aria-labelledby":this.id+"__advancedOptionsForLayout",class:U},pt,_.tsx("div",{class:this.classes(A,E)},_.tsx("label",null,T.author,_.tsx("input",{type:"text",value:a,class:this.classes(x,it),tabIndex:0,"data-input-name":"author",onchange:this._updateInputValue,bind:this}))),_.tsx("div",{class:this.classes(R,E)},_.tsx("label",null,T.copyright,_.tsx("input",{type:"text",class:this.classes(x,it),tabIndex:0,value:s,"data-input-name":"copyright",onchange:this._updateInputValue,bind:this}))),rt,_.tsx("div",{class:this.classes(B,E)},_.tsx("label",null,_.tsx("input",{type:"checkbox","data-option-name":"legendEnabled",tabIndex:0,checked:p,onchange:this._toggleInputValue,bind:this}),T.legend))):null,bt=this._advancedOptionsVisibleForMapOnly?_.tsx("div",{"aria-labelledby":this.id+"__advancedOptionsForMapOnly",class:U},pt,rt,_.tsx("div",{class:E},_.tsx("label",null,_.tsx("input",{"data-option-name":"attributionEnabled",type:"checkbox",onchange:this._toggleInputValue,tabIndex:0,checked:i,bind:this}),T.attribution))):null,yt=this._layoutTabSelected?_.tsx("section",{key:"esri-print__layoutContent",id:this.id+"__layoutContent","aria-labelledby":this.id+"__layoutTab",class:m,role:"tabpanel","aria-selected":this._layoutTabSelected},_.tsx("div",{class:j},b,lt,this._layoutTabSelected?z:null),_.tsx("div",{class:this.classes(j,N)},_.tsx("button",{"aria-label":T.advancedOptions,"aria-expanded":this._advancedOptionsVisibleForLayout?"true":"false",class:L,onclick:this._showAdvancedOptions,bind:this,type:"button"},_.tsx("div",{class:k},_.tsx("span",{"aria-hidden":"true",class:this.classes(ct,S)}),_.tsx("span",{"aria-hidden":"true",class:this.classes(ut,F)}),_.tsx("span",{"aria-hidden":"true",class:this.classes(ht,I)}),_.tsx("span",{class:M},T.advancedOptions))),dt)):_.tsx("section",{key:"esri-print__mapOnlyContent",id:this.id+"__mapOnlyContent","aria-selected":!this._layoutTabSelected,"aria-labelledby":this.id+"__mapOnlyTab",class:O,role:"tabpanel"},_.tsx("div",{class:j},b,this._layoutTabSelected?null:z,_.tsx("div",{class:this.classes(Q,E)},_.tsx("div",{class:X},_.tsx("label",null,T.width,_.tsx("input",{type:"number",class:this.classes(x,it),"data-input-name":"width",onchange:this._updateInputValue,value:""+u,tabIndex:0,bind:this}))),_.tsx("div",{class:K},_.tsx("label",null,T.height,_.tsx("input",{type:"number",class:this.classes(x,it),"data-input-name":"height",onchange:this._updateInputValue,value:""+l,tabIndex:0,bind:this}))),_.tsx("button",{type:"button","aria-label":T.swap,class:this.classes(Z,C,vt),onclick:this._switchInput,tabIndex:0,bind:this})),_.tsx("div",{class:this.classes(j,N)},_.tsx("button",{"aria-label":T.advancedOptions,"aria-expanded":this._advancedOptionsVisibleForMapOnly?"true":"false",type:"button",class:L,onclick:this._showAdvancedOptions,bind:this},_.tsx("div",{class:k},_.tsx("span",{"aria-hidden":"true",class:this.classes(ct,S)}),_.tsx("span",{"aria-hidden":"true",class:this.classes(ut,F)}),_.tsx("span",{"aria-hidden":"true",class:this.classes(ht,I)}),_.tsx("span",{class:M},T.advancedOptions))),bt))),xt=this.exportedLinks.toArray(),ft=this._renderExportedLink(xt),gt=((t={})[st]=h||!r&&!o,t),mt=null!=this.get("view")&&"2d"!==this.get("view.type"),Ot=_.tsx("div",{class:nt},mt?T.sceneViewError:T.serviceError),wt=_.tsx("div",null,_.tsx("ul",{class:f,role:"tablist",onclick:this._toggleLayoutPanel,onkeydown:this._handleLayoutPanelKeyDown,bind:this},_.tsx("li",{afterCreate:this._focusOnTabChange,afterUpdate:this._focusOnTabChange,id:this.id+"__layoutTab","data-tab-id":"layoutTab",class:g,role:"tab",tabIndex:0,"aria-selected":""+this._layoutTabSelected},T.layoutTab),_.tsx("li",{afterCreate:this._focusOnTabChange,afterUpdate:this._focusOnTabChange,id:this.id+"__mapOnlyTab","data-tab-id":"mapOnlyTab",class:g,role:"tab",tabIndex:0,"aria-selected":""+!this._layoutTabSelected},T.mapOnlyTab)),yt,_.tsx("button",{"aria-label":T.exportDescription,type:"button",class:this.classes(P,$,gt),disabled:h,tabIndex:0,onclick:this._handlePrintMap,bind:this},T.export),_.tsx("div",{class:D,afterUpdate:this._scrollExportIntoView,bind:this},_.tsx("h3",{class:this.classes(q,et)},T.exportText),xt.length>0?null:_.tsx("div",null,_.tsx("div",null,T.exportHint)),ft)),Tt=_.tsx("div",null,_.tsx("div",{class:W},_.tsx("header",{class:y},T.export),this.error||!this.printServiceUrl||mt||!this.view?Ot:wt)),Lt="initializing"===this.get("viewModel.state")?this._renderLoader():Tt;return _.tsx("div",{afterCreate:_.storeNode,bind:this,class:v,"data-node-ref":"_rootNode"},Lt)},e.prototype.renderTitleOrFileNameSection=function(){var t,e,i,a,s=this.templateOptions,n=this.messages;return this._layoutTabSelected?(t=n.title,e=n.titlePlaceHolder,i=s.title,a="title"):(t=n.fileName,e=n.fileNamePlaceHolder,i=s.fileName,a="fileName"),_.tsx("div",{class:E,key:a},_.tsx("label",null,t,_.tsx("input",{type:"text",tabIndex:0,placeholder:e,class:this.classes(x,it),value:i,"data-input-name":a,onchange:this._updateInputValue,bind:this})))},e.prototype._focusOnTabChange=function(t){if(this._activeTabFocusRequested){var e=t.getAttribute("data-tab-id");("layoutTab"===e&&this._layoutTabSelected||"mapOnlyTab"===e&&!this._layoutTabSelected)&&(t.focus(),this._activeTabFocusRequested=!1)}},e.prototype._renderLoader=function(){var t,e=((t={})[T]=this._awaitingServerResponse,t);return _.tsx("div",{class:this.classes(e),key:"loader"})},e.prototype._createFileLink=function(t,e){var i=e||this.messages.untitled,a=t.format.toLowerCase(),s=a.indexOf("png")>-1?"png":a,n=i+s;return void 0!==this._exportedFileNameMap[n]?this._exportedFileNameMap[n]++:this._exportedFileNameMap[n]=0,new c({name:i,extension:s,count:this._exportedFileNameMap[n]})},e.prototype._toPrintTemplate=function(t){var e=t.attributionEnabled,i=t.author,a=t.copyright,s=t.dpi,n=t.forceFeatureAttributes,o=t.format,l=t.height,r=t.layout,d=t.legendEnabled,c=t.title,u=t.scale,h=t.width,_=new p({attributionVisible:e,layoutOptions:{authorText:i||"",copyrightText:a||"",titleText:c||""},forceFeatureAttributes:n,format:o,layout:r,outScale:u});return h&&(_.exportOptions.width=h),l&&(_.exportOptions.height=l),s&&(_.exportOptions.dpi=s),d||(_.layoutOptions.legendLayers=[]),_},e.prototype._resetToCurrentScale=function(){this.templateOptions.scale=this.viewModel.view.scale},e.prototype._updateInputValue=function(t){var e=t.target,i=e.getAttribute("data-input-name");this.templateOptions[i]=e.value},e.prototype._handleDPIChange=function(t){this._updateInputValue(t);var e=function(t){return{width:Math.round(8.3333*t),height:Math.round(11.4583*t)}}(t.currentTarget.valueAsNumber),i=e.height,a=e.width,s=this.templateOptions;s.height=i,s.width=a},e.prototype._handlePrintMap=function(){var t=this;this._pendingExportScroll=!0;var e=this.templateOptions,i=this._toPrintTemplate(e),a=this._layoutTabSelected?i.layoutOptions.titleText:e.fileName,s=this._createFileLink(i,a);this.exportedLinks.add(s),this.emit("submit",{link:s}),this.viewModel.print(i).then((function(t){s.set({url:t&&t.url,state:"ready"})})).catch((function(t){s.set({error:t,state:"error"})})).then((function(){t.emit("complete",{link:s}),t.scheduleRender()}))},e.prototype._updateFromOption=function(t){var e=t.target,i=e.selectedOptions?e.selectedOptions.item(0).value:e.options[e.selectedIndex].value,a=e.getAttribute("data-target-property");this.templateOptions[a]=i},e.prototype._switchInput=function(){var t;t=[this.templateOptions.height,this.templateOptions.width],this.templateOptions.width=t[0],this.templateOptions.height=t[1]},e.prototype._showAdvancedOptions=function(){this._layoutTabSelected?this._advancedOptionsVisibleForLayout=!this._advancedOptionsVisibleForLayout:this._advancedOptionsVisibleForMapOnly=!this._advancedOptionsVisibleForMapOnly},e.prototype._scrollExportIntoView=function(){if(this._pendingExportScroll){this._pendingExportScroll=!1;var t=this._rootNode,e=this._rootNode,i=e.clientHeight,a=e.scrollHeight-i;a>0&&(t.scrollTop=a)}},e.prototype._toggleInputValue=function(t){var e=t.target,i=e.getAttribute("data-option-name");this.templateOptions[i]=e.checked,"scaleEnabled"===i&&(this.viewModel.scaleEnabled=this.templateOptions.scaleEnabled,this.templateOptions[i]||this._resetToCurrentScale())},e.prototype._renderExportedLink=function(t){var e=this,i=this.messages;return t.map((function(t){var a,s,n,l=t.error,r=t.url,p=t.formattedName,d=t.state,c="error"===d,u="pending"===d,h="ready"===d,b=((a={})[at]=u||c,a),v=r||null;v&&(v=o.addProxy(v));var y,x=o.hasSameOrigin(r,location.href),f=((s={})[bt]=u,s[lt]=u,s[rt]=x&&h,s[pt]=!x&&h,s[dt]=c,s[ot]=c,s),g=((n={})[ot]=c,n);y=u?i.pending:h?i.ready:i.errorMessage;var m=c?l.message:"";return _.tsx("div",{"aria-label":y,class:H,"data-item":t,key:p,onclick:e._removeLink,title:m},_.tsx("a",{"aria-label":p+". "+i.linkReady,download:p,href:v,rel:"noreferrer",tabIndex:0,target:"_blank",class:e.classes(Y,b)},_.tsx("span",{class:e.classes(f)}),_.tsx("span",{class:e.classes(z,g)},p)))}))},e.prototype._toggleLayoutPanel=function(t){var e=t.target;this._toggleTab(e.getAttribute("data-tab-id"))},e.prototype._toggleTab=function(t){if(this._layoutTabSelected="layoutTab"===t,this._layoutTabSelected){var e=this.get("viewModel.templatesInfo.layout.choiceList");this.templateOptions.layout=e&&e[0]}else this.templateOptions.layout="MAP_ONLY";this._activeTabFocusRequested=!0},e.prototype._handleLayoutPanelKeyDown=function(t){var e=s.eventKey(t),i=t.target.getAttribute("data-tab-id");if("Enter"===e||" "===e)return this._toggleTab(i),t.preventDefault(),void t.stopPropagation();"ArrowLeft"!==e&&"ArrowRight"!==e||(this._toggleTab("layoutTab"===i?"mapOnlyTab":"layoutTab"),t.preventDefault(),t.stopPropagation())},i.__decorate([r.aliasOf("viewModel.allowedFormats")],e.prototype,"allowedFormats",void 0),i.__decorate([r.aliasOf("viewModel.allowedLayouts")],e.prototype,"allowedLayouts",void 0),i.__decorate([r.aliasOf("viewModel.error")],e.prototype,"error",void 0),i.__decorate([r.property({type:b}),_.renderable()],e.prototype,"exportedLinks",void 0),i.__decorate([r.property()],e.prototype,"iconClass",void 0),i.__decorate([r.property({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],e.prototype,"label",void 0),i.__decorate([r.property(),_.renderable(),_.messageBundle("esri/widgets/Print/t9n/Print")],e.prototype,"messages",void 0),i.__decorate([_.renderable(),r.property({type:h})],e.prototype,"templateOptions",void 0),i.__decorate([r.aliasOf("viewModel.printServiceUrl")],e.prototype,"printServiceUrl",void 0),i.__decorate([r.aliasOf("viewModel.view"),_.renderable()],e.prototype,"view",void 0),i.__decorate([r.property({type:u}),_.renderable(["viewModel.templatesInfo","viewModel.state"])],e.prototype,"viewModel",void 0),e=i.__decorate([r.subclass("esri.widgets.Print")],e)}(d)}));