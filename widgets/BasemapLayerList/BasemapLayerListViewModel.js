/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/Collection","../../core/Evented","../../core/HandleOwner","../../core/promiseUtils","../../core/watchUtils","../../core/accessorSupport/decorators/property","../../core/arrayUtils","../../core/has","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass","../LayerList/ListItem"],(function(e,t,s,i,r,a,n,c,o,l,m,p,d){"use strict";const y=300,h={view:"view",basemap:"basemap",baseLayers:"base-layers",referenceLayers:"reference-layers",baseLayersListMode:"reference-layers-list-mode",referenceLayersListMode:"base-layers-list-mode",baseLayerViews:"base-layer-views",referenceLayerViews:"reference-layer-views"},f=s.ofType(d);let u=function(t){function s(s){var i;return(i=t.call(this,s)||this).baseItems=new f,i.baseListItemCreatedFunction=null,i.referenceListItemCreatedFunction=null,i.referenceItems=new f,i.view=null,i._callReferenceListItemsCreatedDebounced=a.debounce(function(){var t=e._asyncToGenerator((function*(e){return i._callListItemsCreated({items:e,type:"reference"})}));return function(e){return t.apply(this,arguments)}}(),y),i._callBaseListItemsCreatedDebounced=a.debounce(function(){var t=e._asyncToGenerator((function*(e){return i._callListItemsCreated({items:e,type:"base"})}));return function(e){return t.apply(this,arguments)}}(),y),i._compileBaseList=i._compileBaseList.bind(e._assertThisInitialized(i)),i._compileReferenceList=i._compileReferenceList.bind(e._assertThisInitialized(i)),i}e._inheritsLoose(s,t);var i=s.prototype;return i.initialize=function(){this.handles.add(n.init(this,["view.map.basemap","view","view.ready","view.basemapView"],(()=>this._watchBasemapLayers())),h.view)},i.destroy=function(){this.view=null,this.baseItems.removeAll(),this.referenceItems.removeAll()},i.triggerAction=function(e,t){e&&!e.disabled&&this.emit("trigger-action",{action:e,item:t})},i.transferListItem=function({listItem:e,from:t,to:s,newIndex:i}){const{referenceItems:r,baseItems:a}=this,{layer:n}=e,c=this.get("view.map.basemap.baseLayers"),o=this.get("view.map.basemap.referenceLayers");if(!c||!o||t===s)return;const l="reference"===s?r:a,m="reference"===t?o:c,p="reference"===s?o:c;("reference"===t?r:a).remove(e),m.remove(n),l.add(e,i),p.add(n,i)},i._createItemChangeHandles=function({items:e,key:t,callback:s}){const{handles:i}=this;i.remove(t),s(),e&&i.add(e.on("change",(()=>s())),t)},i._watchItemProperties=function({item:e,type:t}){this.handles.add([e.children.on("change",(()=>{this._callListItemCreatedChildren({type:t,childItems:e.children})}))],`children-change-${e.uid}`)},i._callListItemCreatedChildren=function({childItems:e,type:t}){e.forEach((e=>this._callListItemCreated({type:t,item:e})))},i._callListItemCreated=function({item:e,type:t}){const s={item:e};"base"===t&&"function"==typeof this.baseListItemCreatedFunction&&this.baseListItemCreatedFunction.call(null,s),"reference"===t&&"function"==typeof this.referenceListItemCreatedFunction&&this.referenceListItemCreatedFunction.call(null,s),this._callListItemCreatedChildren({type:t,childItems:e.children})},i._createListItem=function({layer:e,type:t}){const{view:s}=this,i=new d({layer:e,view:s});return this._watchItemProperties({type:t,item:i}),i},i._watchLayersListMode=function({layers:e,key:t,callback:s}){const{handles:i}=this;i.remove(t),e&&e.forEach((e=>{i.add(n.watch(e,"listMode",(()=>s())),t)}))},i._compileListItems=function({layers:e,items:t,key:s,type:i,callback:r}){this._watchLayersListMode({layers:e,key:s,callback:r}),this._createNewItems({type:i,items:t,layers:e}),this._removeItems({items:t,layers:e}),this._sortItems(t,e),this._beforeCallListItemsCreated({items:t,type:i})},i._beforeCallListItemsCreated=function(){var t=e._asyncToGenerator((function*({items:e,type:t}){return"reference"===t?this._callReferenceListItemsCreatedDebounced(e).catch(a.throwIfNotAbortError):"base"===t?this._callBaseListItemsCreatedDebounced(e).catch(a.throwIfNotAbortError):null}));function s(e){return t.apply(this,arguments)}return s}(),i._callListItemsCreated=function(){var t=e._asyncToGenerator((function*({items:e,type:t}){var s;yield null==(s=this.view)?void 0:s.when(),e.forEach((e=>this._callListItemCreated({type:t,item:e})))}));function s(e){return t.apply(this,arguments)}return s}(),i._compileReferenceList=function(){const{referenceItems:e}=this,t=this.get("view.map.basemap.referenceLayers");this._compileListItems({type:"reference",layers:t,items:e,key:h.referenceLayersListMode,callback:this._compileReferenceList})},i._compileBaseList=function(){const{baseItems:e}=this,t=this.get("view.map.basemap.baseLayers");this._compileListItems({type:"base",layers:t,items:e,key:h.baseLayersListMode,callback:this._compileBaseList})},i._compileLists=function(){this._compileReferenceList(),this._compileBaseList()},i._createNewItems=function({items:e,layers:t,type:s}){t&&t.forEach((t=>{e.find((e=>e.layer===t))||e.add(this._createListItem({type:s,layer:t}))}))},i._removeItems=function({items:e,layers:t}){const{handles:s}=this;e&&e.forEach((i=>{if(!i)return;t&&t.find((e=>i.layer===e))||(s.remove(`children-change-${i.uid}`),e.remove(i))}))},i._sortItems=function(e,t){e&&e.sort(((e,s)=>{const i=t.indexOf(e.layer),r=t.indexOf(s.layer);return i>r?-1:i<r?1:0}))},i._watchBasemapLayers=function(){const{handles:e,view:t}=this;e.remove([h.baseLayers,h.referenceLayers,h.basemap,h.baseLayerViews,h.referenceLayerViews]),this._compileLists(),t&&t.ready&&e.add([n.init(this,"view.map.basemap.baseLayers",(e=>this._createItemChangeHandles({items:e,key:h.baseLayers,callback:this._compileBaseList}))),n.init(this,"view.map.basemap.referenceLayers",(e=>this._createItemChangeHandles({items:e,key:h.referenceLayers,callback:this._compileReferenceList}))),n.init(this,"view.basemapView.baseLayerViews",(e=>this._createItemChangeHandles({items:e,key:h.baseLayerViews,callback:this._compileBaseList}))),n.init(this,"view.basemapView.referenceLayerViews",(e=>this._createItemChangeHandles({items:e,key:h.referenceLayerViews,callback:this._compileReferenceList}))),n.init(this,"baseListItemCreatedFunction",(()=>this._compileBaseList())),n.init(this,"referenceListItemCreatedFunction",(()=>this._compileReferenceList()))],h.basemap)},e._createClass(s,[{key:"basemapTitle",get:function(){return this.get("view.map.basemap.title")||null},set:function(e){void 0!==e?this._override("basemapTitle",e):this._clearOverride("basemapTitle")}},{key:"state",get:function(){return this.get("view.ready")?"ready":this.get("view")?"loading":"disabled"}}]),s}(r.HandleOwnerMixin(i.EventedAccessor));t.__decorate([c.property({type:f})],u.prototype,"baseItems",void 0),t.__decorate([c.property()],u.prototype,"basemapTitle",null),t.__decorate([c.property()],u.prototype,"baseListItemCreatedFunction",void 0),t.__decorate([c.property()],u.prototype,"referenceListItemCreatedFunction",void 0),t.__decorate([c.property({type:f})],u.prototype,"referenceItems",void 0),t.__decorate([c.property({readOnly:!0})],u.prototype,"state",null),t.__decorate([c.property()],u.prototype,"view",void 0),t.__decorate([c.property()],u.prototype,"transferListItem",null),u=t.__decorate([p.subclass("esri.widgets.BasemapLayerList.BasemapLayerListViewModel")],u);return u}));
