/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/has","../../core/Logger","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/subclass","../../core/urlUtils","../../core/uuid","../../portal/support/resourceExtension","../../core/Evented","../../core/Collection","../../core/watchUtils","../../core/HandleOwner","../LayerList/ListItem"],(function(e,t,s,i,r,a,n,c,o,l,m,p,y,d,h){"use strict";const f={view:"view",basemap:"basemap",baseLayers:"base-layers",referenceLayers:"reference-layers",baseLayersListMode:"reference-layers-list-mode",referenceLayersListMode:"base-layers-list-mode",baseLayerViews:"base-layer-views",referenceLayerViews:"reference-layer-views"},L=p.ofType(h);let u=function(t){function s(s){var i;return(i=t.call(this,s)||this).baseItems=new L,i.baseListItemCreatedFunction=null,i.referenceListItemCreatedFunction=null,i.referenceItems=new L,i.view=null,i._compileBaseList=i._compileBaseList.bind(e._assertThisInitialized(i)),i._compileReferenceList=i._compileReferenceList.bind(e._assertThisInitialized(i)),i}e._inheritsLoose(s,t);var i=s.prototype;return i.initialize=function(){this.handles.add(y.init(this,["view.map.basemap","view","view.ready","view.basemapView"],(()=>this._watchBasemapLayers())),f.view)},i.destroy=function(){this.view=null,this.baseItems.removeAll(),this.referenceItems.removeAll()},i.triggerAction=function(e,t){e&&!e.disabled&&this.emit("trigger-action",{action:e,item:t})},i.transferListItem=function({listItem:e,from:t,to:s,newIndex:i}){const{referenceItems:r,baseItems:a}=this,{layer:n}=e,c=this.get("view.map.basemap.baseLayers"),o=this.get("view.map.basemap.referenceLayers");if(!c||!o||t===s)return;const l="reference"===s?r:a,m="reference"===t?o:c,p="reference"===s?o:c;("reference"===t?r:a).remove(e),m.remove(n),l.add(e,i),p.add(n,i)},i._createItemChangeHandles=function({items:e,key:t,callback:s}){const{handles:i}=this;i.remove(t),s(),e&&i.add(e.on("change",(()=>s())),t)},i._watchItemProperties=function({item:e,type:t}){this.handles.add([e.children.on("change",(()=>{this._modifyListItemChildren({type:t,childItems:e.children})}))],`children-change-${e.uid}`)},i._modifyListItemChildren=function({childItems:e,type:t}){e.forEach((e=>this._modifyListItem({type:t,item:e})))},i._modifyListItem=function({item:e,type:t}){const s={item:e};"base"===t&&"function"==typeof this.baseListItemCreatedFunction&&this.baseListItemCreatedFunction.call(null,s),"reference"===t&&"function"==typeof this.referenceListItemCreatedFunction&&this.referenceListItemCreatedFunction.call(null,s),this._modifyListItemChildren({type:t,childItems:e.children})},i._createListItem=function({layer:e,type:t}){const{view:s}=this,i=new h({layer:e,view:s});return this._watchItemProperties({type:t,item:i}),i},i._watchLayersListMode=function({layers:e,key:t,callback:s}){const{handles:i}=this;i.remove(t),e&&e.forEach((e=>{i.add(y.watch(e,"listMode",(()=>s())),t)}))},i._compileListItems=function({layers:e,items:t,key:s,type:i,callback:r}){this._watchLayersListMode({layers:e,key:s,callback:r}),this._createNewItems({type:i,items:t,layers:e}),this._modifyOrRemoveItems({type:i,items:t,layers:e}),this._sortItems(t,e)},i._compileReferenceList=function(){const{referenceItems:e}=this,t=this.get("view.map.basemap.referenceLayers");this._compileListItems({type:"reference",layers:t,items:e,key:f.referenceLayersListMode,callback:this._compileReferenceList})},i._compileBaseList=function(){const{baseItems:e}=this,t=this.get("view.map.basemap.baseLayers");this._compileListItems({type:"base",layers:t,items:e,key:f.baseLayersListMode,callback:this._compileBaseList})},i._compileLists=function(){this._compileReferenceList(),this._compileBaseList()},i._createNewItems=function({items:e,layers:t,type:s}){t&&t.forEach((t=>{e.find((e=>e.layer===t))||e.add(this._createListItem({type:s,layer:t}))}))},i._modifyOrRemoveItems=function({items:e,layers:t,type:s}){const{handles:i}=this;e&&e.forEach((r=>{if(!r)return;t&&t.find((e=>r.layer===e))?this._modifyListItem({type:s,item:r}):(i.remove(`children-change-${r.uid}`),e.remove(r))}))},i._sortItems=function(e,t){e&&e.sort(((e,s)=>{const i=t.indexOf(e.layer),r=t.indexOf(s.layer);return i>r?-1:i<r?1:0}))},i._watchBasemapLayers=function(){const{handles:e,view:t}=this;e.remove([f.baseLayers,f.referenceLayers,f.basemap,f.baseLayerViews,f.referenceLayerViews]),this._compileLists(),t&&t.ready&&e.add([y.init(this,"view.map.basemap.baseLayers",(e=>this._createItemChangeHandles({items:e,key:f.baseLayers,callback:this._compileBaseList}))),y.init(this,"view.map.basemap.referenceLayers",(e=>this._createItemChangeHandles({items:e,key:f.referenceLayers,callback:this._compileReferenceList}))),y.init(this,"view.basemapView.baseLayerViews",(e=>this._createItemChangeHandles({items:e,key:f.baseLayerViews,callback:this._compileBaseList}))),y.init(this,"view.basemapView.referenceLayerViews",(e=>this._createItemChangeHandles({items:e,key:f.referenceLayerViews,callback:this._compileReferenceList}))),y.init(this,"baseListItemCreatedFunction",(()=>this._compileBaseList())),y.init(this,"referenceListItemCreatedFunction",(()=>this._compileReferenceList()))],f.basemap)},e._createClass(s,[{key:"basemapTitle",get:function(){return this.get("view.map.basemap.title")||null},set:function(e){void 0!==e?this._override("basemapTitle",e):this._clearOverride("basemapTitle")}},{key:"state",get:function(){return this.get("view.ready")?"ready":this.get("view")?"loading":"disabled"}}]),s}(d.HandleOwnerMixin(m.EventedAccessor));return t.__decorate([a.property({type:L})],u.prototype,"baseItems",void 0),t.__decorate([a.property()],u.prototype,"basemapTitle",null),t.__decorate([a.property()],u.prototype,"baseListItemCreatedFunction",void 0),t.__decorate([a.property()],u.prototype,"referenceListItemCreatedFunction",void 0),t.__decorate([a.property({type:L})],u.prototype,"referenceItems",void 0),t.__decorate([a.property({readOnly:!0})],u.prototype,"state",null),t.__decorate([a.property()],u.prototype,"view",void 0),t.__decorate([a.property()],u.prototype,"transferListItem",null),u=t.__decorate([n.subclass("esri.widgets.BasemapLayerList.BasemapLayerListViewModel")],u),u}));
