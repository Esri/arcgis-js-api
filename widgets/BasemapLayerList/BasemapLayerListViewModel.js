/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/has","../../core/Logger","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/subclass","../../core/urlUtils","../../core/uuid","../../portal/support/resourceExtension","../../core/Evented","../../core/Collection","../../core/watchUtils","../../core/HandleOwner","../LayerList/ListItem"],(function(e,t,i,s,r,a,n,c,o,l,m,p,d,h,y){"use strict";const f="view",u="basemap",_="base-layers",L="reference-layers",b="reference-layers-list-mode",I="base-layers-list-mode",v="base-layer-views",w="reference-layer-views",g=p.ofType(y);let k=function(t){function i(i){var s;return(s=t.call(this,i)||this).baseItems=new g,s.baseListItemCreatedFunction=null,s.referenceListItemCreatedFunction=null,s.referenceItems=new g,s.view=null,s._compileBaseList=s._compileBaseList.bind(e._assertThisInitialized(s)),s._compileReferenceList=s._compileReferenceList.bind(e._assertThisInitialized(s)),s}e._inheritsLoose(i,t);var s=i.prototype;return s.initialize=function(){this.handles.add(d.init(this,["view.map.basemap","view","view.ready","view.basemapView"],(()=>this._watchBasemapLayers())),f)},s.destroy=function(){this.view=null,this.baseItems.removeAll(),this.referenceItems.removeAll()},s.triggerAction=function(e,t){e&&!e.disabled&&this.emit("trigger-action",{action:e,item:t})},s.transferListItem=function({listItem:e,from:t,to:i,newIndex:s}){const{referenceItems:r,baseItems:a}=this,{layer:n}=e,c=this.get("view.map.basemap.baseLayers"),o=this.get("view.map.basemap.referenceLayers");if(!c||!o||t===i)return;const l="reference"===i?r:a,m="reference"===t?o:c,p="reference"===i?o:c;("reference"===t?r:a).remove(e),m.remove(n),l.add(e,s),p.add(n,s)},s._createItemChangeHandles=function({items:e,key:t,callback:i}){const{handles:s}=this;s.remove(t),i(),e&&s.add(e.on("change",(()=>i())),t)},s._watchItemProperties=function({item:e,type:t}){this.handles.add([e.children.on("change",(()=>{this._modifyListItemChildren({type:t,childItems:e.children})}))],`children-change-${e.uid}`)},s._modifyListItemChildren=function({childItems:e,type:t}){e.forEach((e=>this._modifyListItem({type:t,item:e})))},s._modifyListItem=function({item:e,type:t}){const i={item:e};"base"===t&&"function"==typeof this.baseListItemCreatedFunction&&this.baseListItemCreatedFunction.call(null,i),"reference"===t&&"function"==typeof this.referenceListItemCreatedFunction&&this.referenceListItemCreatedFunction.call(null,i),this._modifyListItemChildren({type:t,childItems:e.children})},s._createListItem=function({layer:e,type:t}){const{view:i}=this,s=new y({layer:e,view:i});return this._watchItemProperties({type:t,item:s}),s},s._watchLayersListMode=function({layers:e,key:t,callback:i}){const{handles:s}=this;s.remove(t),e&&e.forEach((e=>{s.add(d.watch(e,"listMode",(()=>i())),t)}))},s._compileListItems=function({layers:e,items:t,key:i,type:s,callback:r}){this._watchLayersListMode({layers:e,key:i,callback:r}),this._createNewItems({type:s,items:t,layers:e}),this._modifyOrRemoveItems({type:s,items:t,layers:e}),this._sortItems(t,e)},s._compileReferenceList=function(){const{referenceItems:e}=this,t=this.get("view.map.basemap.referenceLayers");this._compileListItems({type:"reference",layers:t,items:e,key:I,callback:this._compileReferenceList})},s._compileBaseList=function(){const{baseItems:e}=this,t=this.get("view.map.basemap.baseLayers");this._compileListItems({type:"base",layers:t,items:e,key:b,callback:this._compileBaseList})},s._compileLists=function(){this._compileReferenceList(),this._compileBaseList()},s._createNewItems=function({items:e,layers:t,type:i}){t&&t.forEach((t=>{e.find((e=>e.layer===t))||e.add(this._createListItem({type:i,layer:t}))}))},s._modifyOrRemoveItems=function({items:e,layers:t,type:i}){const{handles:s}=this;e&&e.forEach((r=>{if(!r)return;t&&t.find((e=>r.layer===e))?this._modifyListItem({type:i,item:r}):(s.remove(`children-change-${r.uid}`),e.remove(r))}))},s._sortItems=function(e,t){e&&e.sort(((e,i)=>{const s=t.indexOf(e.layer),r=t.indexOf(i.layer);return s>r?-1:s<r?1:0}))},s._watchBasemapLayers=function(){const{handles:e,view:t}=this;e.remove([_,L,u,v,w]),this._compileLists(),t&&t.ready&&e.add([d.init(this,"view.map.basemap.baseLayers",(e=>this._createItemChangeHandles({items:e,key:_,callback:this._compileBaseList}))),d.init(this,"view.map.basemap.referenceLayers",(e=>this._createItemChangeHandles({items:e,key:L,callback:this._compileReferenceList}))),d.init(this,"view.basemapView.baseLayerViews",(e=>this._createItemChangeHandles({items:e,key:v,callback:this._compileBaseList}))),d.init(this,"view.basemapView.referenceLayerViews",(e=>this._createItemChangeHandles({items:e,key:w,callback:this._compileReferenceList}))),d.init(this,"baseListItemCreatedFunction",(()=>this._compileBaseList())),d.init(this,"referenceListItemCreatedFunction",(()=>this._compileReferenceList()))],u)},e._createClass(i,[{key:"basemapTitle",get:function(){return this.get("view.map.basemap.title")||null},set:function(e){void 0!==e?this._override("basemapTitle",e):this._clearOverride("basemapTitle")}},{key:"state",get:function(){return this.get("view.ready")?"ready":this.get("view")?"loading":"disabled"}}]),i}(h.HandleOwnerMixin(m.EventedAccessor));return t.__decorate([a.property({type:g})],k.prototype,"baseItems",void 0),t.__decorate([a.property({dependsOn:["view","view.map","view.map.basemap","view.map.basemap.title"]})],k.prototype,"basemapTitle",null),t.__decorate([a.property()],k.prototype,"baseListItemCreatedFunction",void 0),t.__decorate([a.property()],k.prototype,"referenceListItemCreatedFunction",void 0),t.__decorate([a.property({type:g})],k.prototype,"referenceItems",void 0),t.__decorate([a.property({dependsOn:["view.ready"],readOnly:!0})],k.prototype,"state",null),t.__decorate([a.property()],k.prototype,"view",void 0),t.__decorate([a.property()],k.prototype,"transferListItem",null),k=t.__decorate([n.subclass("esri.widgets.BasemapLayerList.BasemapLayerListViewModel")],k),k}));
