/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["require","./chunks/_rollupPluginBabelHelpers","./chunks/tslib.es6","./kernel","./Map","./Viewpoint","./core/Collection","./core/Error","./core/Loadable","./core/loadAll","./core/Logger","./core/maybe","./core/MultiOriginJSONSupport","./core/Promise","./core/promiseUtils","./core/reactiveUtils","./core/urlUtils","./core/accessorSupport/decorators/property","./core/accessorSupport/ensureType","./core/arrayUtils","./core/accessorSupport/decorators/reader","./core/accessorSupport/decorators/subclass","./core/accessorSupport/decorators/writer","./core/accessorSupport/originUtils","./core/accessorSupport/read","./geometry/SpatialReference","./geometry/support/spatialReferenceUtils","./geometry/support/webMercatorUtils","./layers/support/arcgisLayerUrl","./layers/support/layerUtils","./networks/UtilityNetwork","./portal/Portal","./portal/PortalItem","./portal/support/portalItemUtils","./rest/geometryService/project","./rest/support/ProjectParameters","./support/basemapUtils","./support/MapFloorInfo","./webdoc/GeotriggersInfo","./webdoc/RangeInfo","./webdoc/Widgets","./webdoc/support/thumbnailUtils","./webdoc/support/writeUtils","./webmap/ApplicationProperties","./webmap/Bookmark","./webmap/InitialViewProperties","./webmap/Version","./webmap/background/ColorBackground"],(function(e,t,r,o,i,a,n,s,l,p,u,c,d,h,y,m,f,_,w,g,b,v,A,S,I,T,O,P,L,U,R,V,F,G,W,k,K,N,M,C,E,x,j,B,J,D,$,z){"use strict";const q=new $.Version(2,27),H="Web Map",Q=n.ofType(J),X=n.ofType(R),Y=new Map;Y.set("image/jpeg","jpeg"),Y.set("image/jpg","jpg"),Y.set("image/png","png"),Y.set("image/gif","gif");const Z="ArcGIS Pro",ee=G.TypeKeyword.JSAPI,te="CollectorDisabled",re="Collector",oe="Data Editing",ie="OfflineDisabled",ae="Offline",ne="Workforce Project",se="Workforce Worker",le="Workforce Dispatcher",pe="Offline Map Areas",ue="FieldMapsDisabled",ce=G.TypeKeyword.DEVELOPER_BASEMAP,de="UtilityNetwork",he=["NatGeo_World_Map","Ocean_Basemap","USA_Topo_Maps","World_Imagery","World_Street_Map","World_Terrain_Base","World_Topo_Map","World_Hillshade","Canvas/World_Light_Gray_Base","Canvas/World_Light_Gray_Reference","Canvas/World_Dark_Gray_Base","Canvas/World_Dark_Gray_Reference","Ocean/World_Ocean_Base","Ocean/World_Ocean_Reference","Reference/World_Boundaries_and_Places","Reference/World_Reference_Overlay","Reference/World_Transportation"].map((e=>e.toLowerCase()));let ye=function(r){function i(e){var t;return(t=r.call(this,e)||this)._isAuthoringAppSetByUser=!1,t._isAuthoringAppVersionSetByUser=!1,t._thumbnailFilename=null,t._updateFromPromise=null,t._resourceReferences={portalItem:null,paths:[]},t.applicationProperties=null,t.bookmarks=new Q,t.floorInfo=null,t.geotriggersInfo=null,t.initialViewProperties=new D,t.portalItem=null,t.presentation=null,t.sourceVersion=null,t.widgets=null,t.utilityNetworks=null,t.authoringApp=t.authoringAppVersion=null,t._isAuthoringAppSetByUser=t._isAuthoringAppVersionSetByUser=!1,t}t._inheritsLoose(i,r);var n=i.prototype;return n.destroy=function(){const e=this.portalItem;this.portalItem=null,e?.destroy()},n.initialize=function(){if(this.when().catch((e=>{u.getLogger(this.declaredClass).error("#load()","Failed to load web map",e)})),this.resourceInfo){let t;try{t=this._validateJSON(this.resourceInfo)}catch(e){return void this.addResolvingPromise(Promise.reject(e))}this.read(t)}},n.writeAuthoringApp=function(e,t){e&&this._isAuthoringAppSetByUser?t.authoringApp=e:t.authoringApp=ee},n.writeAuthoringAppVersion=function(e,t){e&&this._isAuthoringAppVersionSetByUser?t.authoringAppVersion=e:t.authoringAppVersion=o.version},n.readInitialViewProperties=function(e,t){const r=new D;t.background&&(r.background=z.fromJSON(t.background));const o=t.initialState?.viewpoint;if(o){if(o.rotation){$.Version.parse(t.version||"","webmap").lessThan(2,20)&&t.authoringApp===Z&&(o.rotation*=-1)}r.viewpoint=a.fromJSON(o)}return t.mapRangeInfo&&(r.rangeInfo=C.fromJSON(t.mapRangeInfo)),t.spatialReference&&(r.spatialReference=T.fromJSON(t.spatialReference)),r},n.writeInitialViewProperties=function(e,t,r,o){if(!e)return;const i=e.background;i&&i.color&&(t.background=i.write({},o)),e.viewpoint&&(t.initialState={viewpoint:e.viewpoint.write({},o)}),e.rangeInfo&&(t.mapRangeInfo=e.rangeInfo.toJSON(o)),e.spatialReference&&(t.spatialReference=e.spatialReference.write({},o))},n.writeLayers=function(e,t,r,o){t[r]=this._writeLayers(e,o,"operational-layers")},n.readSourceVersion=function(e,t){const[r,o]=t.version.split(".");return new $.Version(parseInt(r,10),parseInt(o,10))},n.writeSourceVersion=function(e,t,r){t[r]=`${q.major}.${q.minor}`},n.writeTables=function(e,t,r,o){const i=this._writeLayers(e,o,"tables");i.length&&(t[r]=i)},n.load=function(e){return this.addResolvingPromise(this._loadFromSource()),Promise.resolve(this)},n.loadAll=function(){return p.loadAll(this,(e=>{e(this.ground,this.basemap,this.layers,this.tables)}))},n.read=function(e,t){t={...t,origin:"web-map"};const o=this._getAuthoringPropsState();I.readLoadable(this,e,(t=>r.prototype.read.call(this,e,t)),t),this._restoreAuthoringPropsFromState(o)},n.write=function(e,t){if("loaded"!==this.loadStatus){const e=new s("webmap:not-loaded","Web map must be loaded before it can be serialized");throw u.getLogger(this.declaredClass).error("#toJSON()","Web map must be loaded before it can be serialized",this.loadError||this.loadStatus),e}return this._removeDanglingLayerRefs(),t={...t,origin:"web-map",restrictedWebMapWriting:!0,webmap:this},r.prototype.write.call(this,e,t)},n.save=function(){var r=t._asyncToGenerator((function*(t){t=t||{},this._validateItem();const r=new Promise(((t,r)=>e(["./webdoc/support/saveUtils"],t,r)));yield this._updateFromPromise,yield this.load(),yield this._loadLayerContainers(),yield this._beforeSave(),yield this._validateMap();const o=this.portalItem,i=f.urlToObject(o.itemUrl),a={origin:"web-map",messages:[],writtenProperties:[],url:i,portal:o.portal||V.getDefault(),portalItem:o,verifyItemRelativeUrls:i?{rootPath:i.path,writtenUrls:[]}:null,blockedRelativeUrls:[],resources:{toAdd:[],toUpdate:[],toKeep:[],pendingOperations:[]}},n=this.write({},a);return yield Promise.all(a.resources.pendingOperations),this._validateJSONForWriting(a,t),yield this._updateItemProperties(o),yield this._updateItem(o,n,a),yield Promise.all([this._updateItemThumbnail(),r.then((({saveResources:e})=>e(this._resourceReferences,a,null)))]),o}));function o(e){return r.apply(this,arguments)}return o}(),n.saveAs=function(){var r=t._asyncToGenerator((function*(t,r){r=r||{};const o=this._getPortalItem(t),i=new Promise(((t,r)=>e(["./webdoc/support/saveUtils"],t,r)));yield this._updateFromPromise,yield this.load(),yield this._loadLayerContainers(),yield this._beforeSave(),yield this._validateMap();const a={origin:"web-map",messages:[],writtenProperties:[],url:null,portal:o.portal,portalItem:o,blockedRelativeUrls:[],resources:{toAdd:[],toUpdate:[],toKeep:[],pendingOperations:[]}},n=this.write({},a);yield Promise.all(a.resources.pendingOperations),this._validateJSONForWriting(a,r),yield this._updateItemPropertiesForSaveAs(o);const s=this._getThumbnailState();return(yield this._createItem(o,n,a,r))&&(this._resourceReferences.portalItem=o),this._restoreThumbnailFromState(s),yield Promise.all([this._updateItemThumbnail(),i.then((({saveResources:e})=>e(this._resourceReferences,a,null)))]),o}));function o(e,t){return r.apply(this,arguments)}return o}(),n.updateFrom=function(){var e=t._asyncToGenerator((function*(e,t){const r=this._updateFromInternal(e,t);this._updateFromPromise=r,yield r;r===this._updateFromPromise&&(this._updateFromPromise=null)}));function r(t,r){return e.apply(this,arguments)}return r}(),n.getLayerJSONFromResourceInfo=function(e){const t=this.resourceInfo;return this._collectAllLayersJSON([...t?.baseMap?.baseMapLayers||[],...t?.operationalLayers||[],...this.basemap?.resourceInfo?.data?.baseMapLayers||[]]).find((t=>t.id===e.id))},n._collectAllLayersJSON=function(e){return e.reduce(((e,t)=>(e.push(t),"GroupLayer"===t.layerType&&(e=e.concat(this._collectAllLayersJSON(t.layers||[]))),e)),[])},n._writeLayers=function(e,t,r){t={...t,layerContainerType:r};return e.map((e=>c.unwrap(j.getLayerJSON(e,"tables"===r?null:this.getLayerJSONFromResourceInfo(e),t)))).filter(Boolean).toArray()},n._loadFromSource=function(){return this.resourceInfo?this._loadFromJSON(this.resourceInfo,{origin:"web-map"}):this.portalItem&&this.portalItem.id?this._loadFromItem(this.portalItem):Promise.resolve()},n._loadFromItem=function(){var e=t._asyncToGenerator((function*(e){if(yield e.load().catch((e=>{throw new s("webmap:load-portal-item","Failed to load portal item",{error:e})})),"Web Map"!==e.type)throw new s("webmap:invalid-portal-item",`Invalid portal item type '${e.type}', expected 'Web Map'`,{type:e.type});const t=yield e.fetchData();this.resourceInfo=t;const r={origin:"web-map",url:f.urlToObject(e.itemUrl),portal:e.portal||V.getDefault(),portalItem:e,readResourcePaths:[]};return yield this._readAndLoadFromJSON(t,r),this._resourceReferences={portalItem:e,paths:r.readResourcePaths??[]},this._computeInitialViewpoint()}));function r(t){return e.apply(this,arguments)}return r}(),n._readAndLoadFromJSON=function(e,t){const r=this._validateJSON(e);return this.read(r,t),this._loadFromJSON(r,t)},n._validateJSON=function(e){const t=$.Version.parse(e.version||"","webmap");return q.validate(t),e.version=`${t.major}.${t.minor}`,e},n._loadFromJSON=function(t,r){const o={context:{...r,layerContainerType:"operational-layers"}};return this.portalItem&&(o.context.portal=this.portalItem.portal||V.getDefault()),new Promise(((t,r)=>e(["./layers/support/layersCreator"],t,r))).then((({populateOperationalLayers:e})=>{const r=[],i=t.operationalLayers;i&&i.length&&r.push(e(this.layers,i,o));const a={...o,context:{...o.context,layerContainerType:"tables"},defaultLayerType:"ArcGISFeatureLayer"},n=t.tables;return n&&n.length&&r.push(e(this.tables,n,a)),y.eachAlways(r).then((()=>{}))}))},n._computeInitialViewpoint=function(){var e=t._asyncToGenerator((function*(){let e=this.initialViewProperties;const t=e?.viewpoint?.targetGeometry;if(t)return;const r=yield this._getExtentFromItem();r&&(e=e?e.clone():new D,e.viewpoint=new a,e.viewpoint.targetGeometry=r,this.initialViewProperties=e)}));function r(){return e.apply(this,arguments)}return r}(),n._getExtentFromItem=function(){var r=t._asyncToGenerator((function*(){const t=this.initialViewProperties?.spatialReference,r=this.portalItem?.extent;if(t&&r){if(t.isWGS84)return r.clone();if(t.isWebMercator)return P.geographicToWebMercator(r);return(yield new Promise(((t,r)=>e(["./portal/support/geometryServiceUtils"],t,r)))).getGeometryServiceURL(this.portalItem).then((e=>{const o=new k;return o.geometries=[r],o.outSpatialReference=t,W.project(e,o)})).then((e=>e[0])).catch((e=>(u.getLogger(this.declaredClass).error("Error projecting item's extent:",e),null)))}return null}));function o(){return r.apply(this,arguments)}return o}(),n._removeDanglingLayerRefs=function(){const e=this.applicationProperties,t=e&&e.viewing&&e.viewing.search,r=e=>this.allLayers.some((t=>t.id===e));t&&t.layers&&(t.layers=t.layers.filter((e=>r(e.id)))),t&&t.tables&&(t.tables=t.tables.filter((e=>this.tables.some((t=>t.id===e.id)))));const o=e&&e.editing&&e.editing.locationTracking;o&&o.info&&!r(o.info.layerId)&&(e.editing=null);const i=this.presentation&&this.presentation.slides;i&&i.forEach((e=>{e.visibleLayers&&(e.visibleLayers=e.visibleLayers.filter((e=>r(e.id))))}))},n._validateMap=function(){var e=t._asyncToGenerator((function*(){if(!this.basemap?.baseLayers.length)throw new s("webmap:save","Map does not have a valid basemap with a base layer.");let e=null;if(yield m.whenOnce((()=>{const t=K.findSpatialReference(this.initialViewProperties,this.basemap);return e=t.spatialReference,!t.updating})),!O.equals(e,this.initialViewProperties.spatialReference))throw new s("webmap:save","The spatial reference of the basemap is not compatible with the one from the map.",{expected:this.initialViewProperties.spatialReference,actual:e})}));function r(){return e.apply(this,arguments)}return r}(),n._validateItem=function(){if(!this.portalItem)throw u.getLogger(this.declaredClass).error("save: requires the portalItem property to be set"),new s("webmap:portal-item-not-set","Portal item to save to has not been set on the WebMap");this._validateItemType(this.portalItem)},n._validateItemType=function(e){if(e.type!==H)throw new s("webmap:portal-item-wrong-type",`Portal item needs to have type "${H}"`)},n._loadLayerContainers=function(){const e=[];return this.basemap&&e.push(this.basemap.load()),this.ground&&e.push(this.ground.load()),y.eachAlways(e).then((()=>{}))},n._beforeSave=function(){var e=t._asyncToGenerator((function*(){const e=[];for(const t of this.allLayers)if("beforeSave"in t&&"function"==typeof t.beforeSave){const r=t.beforeSave();r&&e.push(r)}yield y.eachAlways(e)}));function r(){return e.apply(this,arguments)}return r}(),n._loadAllLayers=function(){const e=this._getAllLayersAndTables().map((e=>e.load()));return y.eachAlways(e).then((()=>{}))},n._getAllLayersAndTables=function(){return this.allLayers.concat(this.allTables)},n._validateJSONForWriting=function(e,t){let r=(e.messages?e.messages:[]).filter((e=>"error"===e.type)).map((e=>new s(e.name,e.message,e.details)));if(e.blockedRelativeUrls&&(r=r.concat(e.blockedRelativeUrls.map((e=>new s("url:unsupported",`Relative url '${e}' is not supported in Web Map`))))),t.ignoreUnsupported&&(r=r.filter((e=>"layer:unsupported"!==e.name&&"symbol:unsupported"!==e.name&&"symbol-layer:unsupported"!==e.name&&"property:unsupported"!==e.name&&"url:unsupported"!==e.name))),r.length>0)throw new s("webmap:save","Failed to save webmap due to unsupported or invalid content. See 'details.errors' for more detailed information",{errors:r})},n._updateItemProperties=function(){var e=t._asyncToGenerator((function*(e){e.extent=yield this._getWGS84Extent(this.initialViewProperties.viewpoint.targetGeometry),yield this._updateTypeKeywords(e)}));function r(t){return e.apply(this,arguments)}return r}(),n._updateItemPropertiesForSaveAs=function(){var e=t._asyncToGenerator((function*(e){G.removeTypeKeyword(e,te),G.removeTypeKeyword(e,ue),G.removeTypeKeyword(e,G.TypeKeyword.METADATA),G.removeTypeKeyword(e,ie),G.removeTypeKeyword(e,pe),G.removeTypeKeyword(e,le),G.removeTypeKeyword(e,ne),G.removeTypeKeyword(e,se),yield this._updateItemProperties(e)}));function r(t){return e.apply(this,arguments)}return r}(),n._getWGS84Extent=function(){var e=t._asyncToGenerator((function*(e){const t=e.clone().normalize();let r;if(t.length>1)for(const o of t)r?o.width>r.width&&(r=o):r=o;else r=t[0];return this._projectToWGS84(r)}));function r(t){return e.apply(this,arguments)}return r}(),n._projectToWGS84=function(){var r=t._asyncToGenerator((function*(t){const r=t.spatialReference;if(r.isWGS84)return t.clone();if(r.isWebMercator)return P.webMercatorToGeographic(t);const o=yield new Promise(((t,r)=>e(["./portal/support/geometryServiceUtils"],t,r))),i=yield o.getGeometryServiceURL(this.portalItem),a=new k;a.geometries=[t],a.outSpatialReference=T.WGS84;return(yield W.project(i,a))[0]}));function o(e){return r.apply(this,arguments)}return o}(),n._updateTypeKeywords=function(){var e=t._asyncToGenerator((function*(e){G.addTypeKeyword(e,ee),yield this._loadAllLayers(),this._evalCollectorKeyword(e),this._evalDataEditingKeyword(e),this._evalOfflineKeyword(e),this._evalDeveloperBasemapKeyword(e),this._evalUtilityNetworkKeyword(e),e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter(((e,t,r)=>r.indexOf(e)===t)))}));function r(t){return e.apply(this,arguments)}return r}(),n._evalCollectorKeyword=function(e){G.hasTypeKeyword(e,te)||G.hasTypeKeyword(e,ne)||G.hasTypeKeyword(e,se)||G.hasTypeKeyword(e,le)||!this._hasEditableFeatureLayer()?G.removeTypeKeyword(e,re):G.addTypeKeyword(e,re)},n._evalDataEditingKeyword=function(e){this._hasEditableFeatureLayer()?G.addTypeKeyword(e,oe):G.removeTypeKeyword(e,oe)},n._evalOfflineKeyword=function(e){!G.hasTypeKeyword(e,ie)&&this._isOfflineCapableMap()?G.addTypeKeyword(e,ae):G.removeTypeKeyword(e,ae)},n._evalDeveloperBasemapKeyword=function(e){K.hasDeveloperBasemapLayer(this.basemap)?G.addTypeKeyword(e,ce):G.removeTypeKeyword(e,ce)},n._evalUtilityNetworkKeyword=function(e){this.utilityNetworks?.length?G.addTypeKeyword(e,de):G.removeTypeKeyword(e,de)},n._hasEditableFeatureLayer=function(){return this._getAllLayersAndTables().some((e=>e.loaded&&U.isFeatureServiceLayer(e)&&e.capabilities.operations.supportsEditing&&e.editingEnabled))},n._isOfflineCapableMap=function(){return this._getAllLayersAndTables().filter((e=>"group"!==e.type)).every((e=>e.loaded&&this._isOfflineCapableLayer(e)))},n._isFeatureCollectionLike=function(e){return U.isFeatureCollectionLayer(e)||"map-notes"===e.type||"route"===e.type},n._isOfflineCapableLayer=function(e){return U.isFeatureServiceLayer(e)&&e.capabilities.operations.supportsSync||this._isFeatureCollectionLike(e)&&!e.portalItem||("tile"===e.type||"vector-tile"===e.type)&&(e.capabilities.operations.supportsExportTiles||this._isExportableAGOLTileLayer(e)||K.isDeveloperBasemapLayer(e))&&e.spatialReference.equals(this.initialViewProperties.spatialReference)},n._isExportableAGOLTileLayer=function(e){return"tile"===e.type&&(L.isServerOrServicesAGOLUrl(e.url)&&he.some((t=>e.url?.toLowerCase().includes("/"+t+"/"))))},n._updateItem=function(){var e=t._asyncToGenerator((function*(e,t,r){yield e.update({data:t}),this._syncUpInstanceWithItem(e,t,r)}));function r(t,r,o){return e.apply(this,arguments)}return r}(),n._createItem=function(){var e=t._asyncToGenerator((function*(e,t,r,o){const i=this.portalItem,a={item:i,authenticated:!(!i?.id||!i.portal.user)},n=e.portal;yield n.signIn();const{copyAllowed:l,itemReloaded:p}=yield this._isCopyAllowed(a,n);if(a.authenticated||(a.authenticated=p),!l)throw new s("webmap:save-as-copy-not-allowed","Owner of this map does not allow others to save a copy");const u=yield this._initializeNewItem(e,a,t,o);return this.portalItem=e,this._syncUpInstanceWithItem(e,t,r),u}));function r(t,r,o,i){return e.apply(this,arguments)}return r}(),n._isCopyAllowed=function(){var e=t._asyncToGenerator((function*(e,t){const{item:r,authenticated:o}=e;return r?.id&&r.typeKeywords?.includes("useOnly")?r.portal.portalHostname!==t.portalHostname?{copyAllowed:!1,itemReloaded:!1}:(o||(yield r.reload()),{copyAllowed:"admin"===r.itemControl||"update"===r.itemControl,itemReloaded:!0}):{copyAllowed:!0,itemReloaded:!1}}));function r(t,r){return e.apply(this,arguments)}return r}(),n._initializeNewItem=function(){var e=t._asyncToGenerator((function*(e,t,r,o){const i=e.portal,{item:a,authenticated:n}=t,{folder:s,copyAllResources:l}=o;let p=!1;if(l&&a?.id&&f.hasSameCanonicalArcGISOnlinePortal(a.portal.url,i.url)&&(n||(yield a.reload()),a.isOrgItem)){const{total:e}=yield a.fetchResources();p=!!e}if(p){const t=yield a.copy({copyResources:"all",folder:s});e.id=t.id,e.portal=t.portal;const o=e.toJSON();yield e.load(),e.read(o),yield e.update({data:r})}else yield i.user?.addItem({item:e,folder:s,data:r});return p}));function r(t,r,o,i){return e.apply(this,arguments)}return r}(),n._syncUpInstanceWithItem=function(e,t,r){d.MultiOriginJSONSupport.prototype.read.call(this,{version:t.version,authoringApp:t.authoringApp,authoringAppVersion:t.authoringAppVersion},{origin:"web-map",ignoreDefaults:!0,url:e.itemUrl&&f.urlToObject(e.itemUrl)}),S.updateOrigins(r),this.resourceInfo=t},n._updateItemThumbnail=function(){var e=t._asyncToGenerator((function*(){this.thumbnailUrl&&this._isOverridden("thumbnailUrl")&&(yield this.portalItem?.updateThumbnail({thumbnail:this.thumbnailUrl,filename:this._thumbnailFilename}),this._clearThumbnailOverride())}));function r(){return e.apply(this,arguments)}return r}(),n._getPortalItem=function(e){let t=F.from(e);return t.id&&(t=t.clone(),t.id=null),t.type||(t.type=H),t.portal||(t.portal=V.getDefault()),this._validateItemType(t),t},n._updateFromInternal=function(){var e=t._asyncToGenerator((function*(e,t){if(t=t||{},yield m.whenOnce((()=>e.ready)),this._updateInitialViewProperties(e,t),e.map===this)for(const r of e.allLayerViews)for(const e of["visible","featureEffect"])e in r&&e in r.layer&&r._isOverridden(e)&&(r.layer[e]=r[e]);yield this._updateThumbnailUrl(e,t)}));function r(t,r){return e.apply(this,arguments)}return r}(),n._updateInitialViewProperties=function(e,t){if(t.backgroundExcluded||(this.initialViewProperties.background=e.background?.clone()),this.initialViewProperties.spatialReference=e.spatialReference?.clone(),t.viewpointExcluded||(this.initialViewProperties.viewpoint=new a({rotation:e.rotation,scale:t.scalePreserved?e.scale:null,targetGeometry:this._getViewExtent(e)})),!t.widgetsExcluded)for(const r of e.persistableViewModels)r.updateWebDocument(this)},n._getViewExtent=function(e){const t=e.center.clone().normalize(),r=e.extent.clone(),o=r.width/2;return r.xmin=t.x-o,r.xmax=t.x+o,r},n._updateThumbnailUrl=function(){var e=t._asyncToGenerator((function*(e,t){if(t.thumbnailExcluded)return;const r=x.getOptimalThumbnailSize(e,t.thumbnailSize),o=yield e.takeScreenshot({format:"png",width:r.width,height:r.height});this._setAutoGeneratedThumbnail(o.dataUrl)}));function r(t,r){return e.apply(this,arguments)}return r}(),n._setAutoGeneratedThumbnail=function(e){this.thumbnailUrl=e,this._thumbnailFilename=null},n._clearThumbnailOverride=function(){this._clearOverride("thumbnailUrl"),this.clear("thumbnailUrl","user"),this._thumbnailFilename=null},n._generateCustomThumbnailFilename=function(e){if(f.isDataProtocol(e)){const t=f.dataComponents(e),r=t&&t.mediaType,o=r&&Y.get(r.toLowerCase())||null,i=`thumbnail${Date.now()}`;return o?`${i}.${o}`:i}return null},n._getThumbnailState=function(){let e=this.thumbnailUrl;return e&&(e=this._isOverridden("thumbnailUrl")?e:f.addQueryParameter(e,"w","8192")),{thumbnailUrl:e,filename:this._thumbnailFilename}},n._restoreThumbnailFromState=function(e){this.thumbnailUrl=e.thumbnailUrl,this._thumbnailFilename=e.filename},n._getAuthoringPropsState=function(){return{authoringApp:this.authoringApp,authoringAppVersion:this.authoringAppVersion,isAuthoringAppSetByUser:this._isAuthoringAppSetByUser,isAuthoringAppVersionSetByUser:this._isAuthoringAppVersionSetByUser}},n._restoreAuthoringPropsFromState=function(e){e.isAuthoringAppSetByUser?this.authoringApp=e.authoringApp:this._isAuthoringAppSetByUser=!1,e.isAuthoringAppVersionSetByUser?this.authoringAppVersion=e.authoringAppVersion:this._isAuthoringAppVersionSetByUser=!1},i.fromJSON=function(e){const t=e;if(!t)throw new s("webmap:empty-resource","Expected a JSON resource but got nothing");return new this({resourceInfo:t})},t._createClass(i,[{key:"authoringApp",set:function(e){this._isAuthoringAppSetByUser=!0,this._set("authoringApp",e)}},{key:"authoringAppVersion",set:function(e){this._isAuthoringAppVersionSetByUser=!0,this._set("authoringAppVersion",e)}},{key:"thumbnailUrl",get:function(){return this.portalItem&&this.portalItem.thumbnailUrl||null},set:function(e){e?(this._override("thumbnailUrl",e),this._thumbnailFilename=this._generateCustomThumbnailFilename(e)):this._clearThumbnailOverride()}}]),i}(d.MultiOriginJSONMixin(l.LoadableMixin(h.EsriPromiseMixin(i))));ye.VERSION=q,r.__decorate([_.property({type:B,json:{write:!0}})],ye.prototype,"applicationProperties",void 0),r.__decorate([_.property({type:String,json:{write:{allowNull:!0,ignoreOrigin:!0}}})],ye.prototype,"authoringApp",null),r.__decorate([A.writer("authoringApp")],ye.prototype,"writeAuthoringApp",null),r.__decorate([_.property({type:String,json:{write:{allowNull:!0,ignoreOrigin:!0}}})],ye.prototype,"authoringAppVersion",null),r.__decorate([A.writer("authoringAppVersion")],ye.prototype,"writeAuthoringAppVersion",null),r.__decorate([_.property({json:{read:{source:"baseMap"},write:{target:"baseMap"}}})],ye.prototype,"basemap",void 0),r.__decorate([_.property({type:Q,json:{write:{overridePolicy:e=>({enabled:!!(e&&e.length>0),ignoreOrigin:!0})}}})],ye.prototype,"bookmarks",void 0),r.__decorate([_.property({type:N,json:{read:{source:"mapFloorInfo"},write:{target:"mapFloorInfo"}}})],ye.prototype,"floorInfo",void 0),r.__decorate([_.property({type:M,json:{write:!0}})],ye.prototype,"geotriggersInfo",void 0),r.__decorate([_.property({type:D,nonNullable:!0,json:{read:{source:["background","initialState.viewpoint","mapRangeInfo","spatialReference"]},write:{ignoreOrigin:!0,target:{background:{type:z},"initialState.viewpoint":{type:a},mapRangeInfo:{type:C},spatialReference:{type:T}}}}})],ye.prototype,"initialViewProperties",void 0),r.__decorate([b.reader("initialViewProperties")],ye.prototype,"readInitialViewProperties",null),r.__decorate([A.writer("initialViewProperties")],ye.prototype,"writeInitialViewProperties",null),r.__decorate([_.property({json:{read:!1,write:{target:"operationalLayers",ignoreOrigin:!0}}})],ye.prototype,"layers",void 0),r.__decorate([A.writer("layers")],ye.prototype,"writeLayers",null),r.__decorate([_.property({type:F})],ye.prototype,"portalItem",void 0),r.__decorate([_.property({json:{write:!0}})],ye.prototype,"presentation",void 0),r.__decorate([_.property()],ye.prototype,"resourceInfo",void 0),r.__decorate([_.property({readOnly:!0,type:$.Version,json:{read:{source:"version"},write:{allowNull:!0,ignoreOrigin:!0,target:"version",isRequired:!0}}})],ye.prototype,"sourceVersion",void 0),r.__decorate([b.reader("sourceVersion")],ye.prototype,"readSourceVersion",null),r.__decorate([A.writer("sourceVersion")],ye.prototype,"writeSourceVersion",null),r.__decorate([_.property({json:{read:!1,write:{ignoreOrigin:!0}}})],ye.prototype,"tables",void 0),r.__decorate([A.writer("tables")],ye.prototype,"writeTables",null),r.__decorate([_.property()],ye.prototype,"thumbnailUrl",null),r.__decorate([_.property({type:E,json:{write:!0}})],ye.prototype,"widgets",void 0),r.__decorate([_.property({type:X,json:{read:!0,write:!0}})],ye.prototype,"utilityNetworks",void 0),ye=r.__decorate([v.subclass("esri.WebMap")],ye);return ye}));
