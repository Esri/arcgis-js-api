// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["../core/declare","dojo/dom-attr","dojo/keys","dijit/registry","dijit/Dialog","../kernel","../core/lang","../core/Error","../core/domUtils","../core/promiseUtils","../intl/substitute","./IdentityManagerBase","dojo/i18n!./nls/identity","dijit/form/Button","dijit/form/Form","dijit/form/ValidationTextBox"],function(e,t,i,s,r,n,a,o,d,l,c,g,_){var u=c.substitute,m=g.IdentityManagerBase,b=g.Credential;return e([m],{declaredClass:"esri.identity.IdentityManager",constructor:function(e){a.mixin(this,e)},_dialogContent:"<div data-dojo-type='dijit.form.Form' data-dojo-props='\"class\":\"esriIdForm\"'><div class='dijitDialogPaneContentArea'><div style='padding-bottom: 5px; word-wrap: break-word;'>{info}</div><div style='margin: 0px; padding: 0px; height: 10px;'></div><div class='esriErrorMsg' style='display: none; color: white; background-color: #D46464; text-align: center; padding-top: 3px; padding-bottom: 3px;'>{invalidUser}</div><div style='margin: 0px; padding: 0px; height: 10px;'></div><table style='width: 100%;'><tr><td>"+'<label>{lblUser}<br/><input data-dojo-type=\'dijit.form.ValidationTextBox\' data-dojo-props=\'type:"text", "class":"esriIdUser", required:true, trim:true, style:"width: 100%;", autocapitalize:"none", autocorrect:"off", spellcheck:false\' /></label></td></tr><tr><td><label>{lblPwd}<br/><input data-dojo-type=\'dijit.form.ValidationTextBox\' data-dojo-props=\'type:"password", "class":"esriIdPwd", required:true, style:"width: 100%;"\' /></label></td></tr></table></div><div class=\'dijitDialogPaneActionBar\'><button data-dojo-type=\'dijit.form.Button\' data-dojo-props=\'type:"button", "class":"esriIdSubmit"\'>{lblOk}</button><button data-dojo-type=\'dijit.form.Button\' data-dojo-props=\'type:"button", "class":"esriIdCancel"\'>{lblCancel}</button></div></div>',signIn:function(e,i,s){this._nls||(this._nls=_),this._loginDialog||(this._loginDialog=this.dialog=this._createLoginDialog(),this.emit("dialog-create"));var r=this._loginDialog,n=s&&s.error,a=s&&s.token,c=l.createResolver();if(s&&s.signal&&l.onAbort(s.signal,function(){r.onCancel()}),r.open){var g=new o("identity-manager:busy","BUSY");return c.reject(g),c.promise}return d.hide(r.errMsg_),n&&n.details&&403==n.details.httpStatus&&a&&(t.set(r.errMsg_,"innerHTML",this._nls.forbidden),d.show(r.errMsg_)),r.dfd_=c,r.serverInfo_=i,r.resUrl_=e,r.admin_=s&&s.isAdmin,r.signal_=s&&s.signal,t.set(r.resLink_,{title:e,innerHTML:"("+(this.getResourceName(e)||this._nls.lblItem)+")"}),t.set(r.serverLink_,{title:i.server,innerHTML:(-1!==i.server.toLowerCase().indexOf("arcgis.com")?"ArcGIS Online":i.server)+" "}),r.txtPwd_.set("value",""),r.show(),c.promise},_createLoginDialog:function(){var e=this._nls,a=u(this._dialogContent,e);a=u(a,{resource:"<span class='resLink' style='word-wrap: break-word;'></span>",server:"<span class='serverLink' style='word-wrap: break-word;'></span>"});var l=new r({title:e.title,content:a,class:" esri-widget esriSignInDialog esriIdentityDialog",style:"width: 18em;",esriIdMgr_:this,onShow:function(){this.domNode.classList.add("esriIdentityDialog--visible")},onHide:function(){this.domNode.classList.remove("esriIdentityDialog--visible")},keypressed_:function(e){e.charOrCode===i.ENTER&&this.execute_()},execute_:function(){var i=this.txtUser_.get("value"),s=this.txtPwd_.get("value"),a=this.dfd_,o=this;if(this.form_.validate()&&i&&s){this.btnSubmit_.set("label",e.lblSigning);var l=n.id.findCredential(o.resUrl_,i),c=function(t){o.btnSubmit_.set("label",e.lblOk),o.btnSubmit_.set("disabled",!1),d.hide(o.errMsg_),o.hide(),r._DialogLevelManager.hide(o);var s=o.serverInfo_;o.dfd_=o.serverInfo_=o.generateDfd_=o.resUrl_=o.signal_=null;var n,c,g,_=l;t&&(n=t.token,c=null!=t.expires?Number(t.expires):null,g=!!t.ssl,_?(_.userId=i,_.token=n,_.expires=c,_.validity=t.validity,_.ssl=g,_.creationTime=Date.now()):_=new b({userId:i,server:s.server,token:n,expires:c,ssl:g,isAdmin:o.admin_,validity:t.validity})),a.resolve(_)};if(l&&!l._enqueued)return void c();o.btnSubmit_.set("disabled",!0),o.generateDfd_=n.id.generateToken(this.serverInfo_,{username:i,password:s},{isAdmin:this.admin_,signal:this.signal_}).then(c,function(i){o.btnSubmit_.set("disabled",!1),o.generateDfd_=null,o.btnSubmit_.set("label",e.lblOk),t.set(o.errMsg_,"innerHTML",i&&i.details&&i.details.httpStatus?e.invalidUser:e.noAuthService),d.show(o.errMsg_)})}},cancel_:function(){var e=l.dfd_,t=l.resUrl_,i=l.serverInfo_;l.btnSubmit_.set("disabled",!1),l.dfd_=l.serverInfo_=l.generateDfd_=l.resUrl_=l.signal_=null,d.hide(l.errMsg_),r._DialogLevelManager.hide(l),l.esriIdMgr_.emit("dialog-cancel",{resourceUrl:t,serverInfo:i});var s=new o("identity-manager:user-aborted","ABORTED");e.reject(s)}}),c=l.domNode;return l.form_=s.byNode(c.getElementsByClassName("esriIdForm")[0]),l.txtUser_=s.byNode(c.getElementsByClassName("esriIdUser")[0]),l.txtPwd_=s.byNode(c.getElementsByClassName("esriIdPwd")[0]),l.btnSubmit_=s.byNode(c.getElementsByClassName("esriIdSubmit")[0]),l.btnCancel_=s.byNode(c.getElementsByClassName("esriIdCancel")[0]),l.resLink_=c.getElementsByClassName("resLink")[0],l.serverLink_=c.getElementsByClassName("serverLink")[0],l.errMsg_=c.getElementsByClassName("esriErrorMsg")[0],l.connect(l.txtUser_,"onKeyPress",l.keypressed_),l.connect(l.txtPwd_,"onKeyPress",l.keypressed_),l.connect(l.btnSubmit_,"onClick",l.execute_),l.connect(l.btnCancel_,"onClick",l.onCancel),l.connect(l,"onCancel",l.cancel_),l}})});