// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["../core/declare","dojo/_base/array","dojo/Deferred","dojo/_base/url","dojo/cookie","dojo/io-query","dojo/regexp","../kernel","../config","../core/global","../core/has","../core/lang","../core/object","./ServerInfo","../core/urlUtils","../core/deferredUtils","../core/Accessor","../request","../core/Error","../core/Evented","./OAuthCredential","./OAuthInfo"],function(e,r,t,s,i,n,o,a,h,l,u,c,d,f,_,v,p,g,m,S,w,I){var k,U={},y=function(e){var r=new s(e.owningSystemUrl).host,t=new s(e.server).host,i=/.+\.arcgis\.com$/i;return i.test(r)&&i.test(t)},T=function(e,t){return!!(y(e)&&t&&r.some(t,function(r){return r.test(e.server)}))},x=e(S,{declaredClass:"esri.identity.IdentityManagerBase",constructor:function(){this._portalConfig=l.esriGeowConfig,this.serverInfos=[],this.oAuthInfos=[],this.credentials=[],this._soReqs=[],this._xoReqs=[],this._portals=[],this._getOAuthHash(),window.addEventListener("pageshow",function(e){this._pageShowHandler(e)}.bind(this))},defaultOAuthInfo:null,defaultTokenValidity:60,tokenValidity:null,signInPage:null,useSignInPage:!0,normalizeWebTierAuth:!1,_busy:null,_rejectOnPersistedPageShow:!1,_oAuthHash:null,_gwTokenUrl:"/sharing/generateToken",_agsRest:"/rest/services",_agsPortal:/\/sharing(\/|$)/i,_agsAdmin:/https?:\/\/[^\/]+\/[^\/]+\/admin\/?(\/.*)?$/i,_adminSvcs:/\/admin\/services(\/|$)/i,_agolSuffix:".arcgis.com",_gwDomains:[{regex:/https?:\/\/www\.arcgis\.com/i,tokenServiceUrl:"https://www.arcgis.com/sharing/generateToken"},{regex:/https?:\/\/dev\.arcgis\.com/i,tokenServiceUrl:"https://dev.arcgis.com/sharing/generateToken"},{regex:/https?:\/\/.*dev[^.]*\.arcgis\.com/i,tokenServiceUrl:"https://devext.arcgis.com/sharing/generateToken"},{regex:/https?:\/\/.*qa[^.]*\.arcgis\.com/i,tokenServiceUrl:"https://qaext.arcgis.com/sharing/generateToken"},{regex:/https?:\/\/.*.arcgis\.com/i,tokenServiceUrl:"https://www.arcgis.com/sharing/generateToken"}],_legacyFed:[],_regexSDirUrl:/http.+\/rest\/services\/?/gi,_regexServerType:/(\/(MapServer|GeocodeServer|GPServer|GeometryServer|ImageServer|NAServer|FeatureServer|GeoDataServer|GlobeServer|MobileServer|GeoenrichmentServer|VectorTileServer|SceneServer)).*/gi,_gwUser:/http.+\/users\/([^\/]+)\/?.*/i,_gwItem:/http.+\/items\/([^\/]+)\/?.*/i,_gwGroup:/http.+\/groups\/([^\/]+)\/?.*/i,_errorCodes:[499,498,403,401],_rePortalTokenSvc:/\/sharing(\/rest)?\/generatetoken/i,_publicUrls:[/\/arcgis\/tokens/i,/\/sharing(\/rest)?\/generatetoken/i,/\/rest\/info/i],_createDefaultOAuthInfo:!0,_hasTestedIfAppIsOnPortal:!1,registerServers:function(e){var t=this.serverInfos;t?(e=r.filter(e,function(e){return!this.findServerInfo(e.server)},this),this.serverInfos=t.concat(e)):this.serverInfos=e,r.forEach(e,function(e){e.owningSystemUrl&&this._portals.push(e.owningSystemUrl),e.hasPortal&&this._portals.push(e.server)},this)},registerOAuthInfos:function(e){var t=this.oAuthInfos;t?(e=r.filter(e,function(e){return!this.findOAuthInfo(e.portalUrl)},this),this.oAuthInfos=t.concat(e)):this.oAuthInfos=e},registerToken:function(e){e=c.mixin({},e);var r,t=this._sanitizeUrl(e.server),s=this.findServerInfo(t),i=this._isServerRsrc(t),n=!0;s||(s=new f,s.server=this._getServerInstanceRoot(t),i?s.hasServer=!0:(s.tokenServiceUrl=this._getTokenSvcUrl(t),s.hasPortal=!0),this.registerServers([s])),r=this._findCredential(t),r?(delete e.server,c.mixin(r,e),n=!1):(r=new k({userId:e.userId,server:s.server,token:e.token,expires:e.expires,ssl:e.ssl,scope:i?"server":"portal"}),r.resources=[t],this.credentials.push(r)),r.emitTokenChange(!1),n||r.refreshServerTokens()},toJSON:function(){return c.fixJson({serverInfos:r.map(this.serverInfos,function(e){return e.toJSON()}),oAuthInfos:r.map(this.oAuthInfos,function(e){return e.toJSON()}),credentials:r.map(this.credentials,function(e){return e.toJSON()})})},initialize:function(e){if(e){"string"==typeof e&&(e=JSON.parse(e));var t=e.serverInfos,s=e.oAuthInfos,i=e.credentials;if(t){var n=[];r.forEach(t,function(e){e.server&&e.tokenServiceUrl&&n.push(e.declaredClass?e:new f(e))}),n.length&&this.registerServers(n)}if(s){var o=[];r.forEach(s,function(e){e.appId&&o.push(e.declaredClass?e:new I(e))}),o.length&&this.registerOAuthInfos(o)}i&&r.forEach(i,function(e){e.server&&e.token&&e.expires&&e.expires>(new Date).getTime()&&(e=e.declaredClass?e:new k(e),e.emitTokenChange(),this.credentials.push(e))},this)}},findServerInfo:function(e){var t;return e=this._sanitizeUrl(e),r.some(this.serverInfos,function(r){return this._hasSameServerInstance(r.server,e)&&(t=r),!!t},this),t},findOAuthInfo:function(e){var t;return e=this._sanitizeUrl(e),r.some(this.oAuthInfos,function(r){return this._hasSameServerInstance(r.portalUrl,e)&&(t=r),!!t},this),t},findCredential:function(e,t){var s,i;return e=this._sanitizeUrl(e),i=this._isServerRsrc(e)?"server":"portal",t?r.some(this.credentials,function(r){return this._hasSameServerInstance(r.server,e)&&t===r.userId&&r.scope===i&&(s=r),!!s},this):r.some(this.credentials,function(r){return this._hasSameServerInstance(r.server,e)&&-1!==this._getIdenticalSvcIdx(e,r)&&r.scope===i&&(s=r),!!s},this),s},getCredential:function(e,r){var t,s,n=!0;null!=r&&("object"==typeof r?(t=!!r.token,s=r.error,n=!1!==r.prompt):t=r),e=this._sanitizeUrl(e);var o,a=v.makeDeferredCancellingPending(),h=this._isAdminResource(e),l=t&&this._doPortalSignIn(e)?this._getEsriAuthCookie():null,u=t?this.findCredential(e):null;if(u&&s&&498===s.code)u.destroy(),l&&l.token===r.token&&i("esri_auth",null,{expires:-1,path:"/",domain:document.domain});else if(l||u){var c=l&&l.email||u&&u.userId;return o=new m("identity-manager:not-authorized","You are currently signed in as: '"+c+"'. You do not have access to this resource: "+e,{error:s}),a.reject(o),a.promise}var d=this._findCredential(e,r);if(d)return a.resolve(d),a.promise;var _=this.findServerInfo(e);if(_)!_.hasServer&&this._isServerRsrc(e)&&(_._restInfoPms=this._getTokenSvcUrl(e),_.hasServer=!0);else{var p=this._getTokenSvcUrl(e);if(!p)return o=new m("identity-manager:unknown-resource","Unknown resource - could not find token service endpoint."),a.reject(o),a.promise;_=new f,_.server=this._getServerInstanceRoot(e),"string"==typeof p?(_.tokenServiceUrl=p,_.hasPortal=!0):(_._restInfoPms=p,_.hasServer=!0),this.registerServers([_])}return n&&_.hasPortal&&void 0===_._selfReq&&!this._findOAuthInfo(e)&&(_._selfReq={owningTenant:r&&r.owningTenant,selfDfd:this._getPortalSelf(_.tokenServiceUrl.replace(this._rePortalTokenSvc,"/sharing/rest/portals/self"),e)}),this._enqueue(e,_,r,a,h)},getResourceName:function(e){return this._isRESTService(e)?e.replace(this._regexSDirUrl,"").replace(this._regexServerType,"")||"":this._gwUser.test(e)&&e.replace(this._gwUser,"$1")||this._gwItem.test(e)&&e.replace(this._gwItem,"$1")||this._gwGroup.test(e)&&e.replace(this._gwGroup,"$1")||""},generateToken:function(e,r,t){var i,n,o,h,l,u,d,f,v,p=this._rePortalTokenSvc.test(e.tokenServiceUrl),S=new s(window.location.href.toLowerCase()),w=this._getEsriAuthCookie(),I=!r,k=e.shortLivedTokenValidity;return r&&(v=a.id.tokenValidity||k||a.id.defaultTokenValidity)>k&&k>0&&(v=k),t&&(i=t.isAdmin,n=t.serverUrl,o=t.token,u=t.ssl,e.customParameters=t.customParameters),i?h=e.adminTokenServiceUrl:(h=e.tokenServiceUrl,l=new s(h.toLowerCase()),w&&(f=w.auth_tier,f=f&&f.toLowerCase()),("web"===f||e.webTierAuth)&&t&&t.serverUrl&&!u&&"http"===S.scheme&&(_.hasSameOrigin(S.uri,h,!0)||"https"===l.scheme&&S.host===l.host&&"7080"===S.port&&"7443"===l.port)&&(h=h.replace(/^https:/i,"http:").replace(/:7443/i,":7080")),I&&p&&(h=h.replace(/\/rest/i,""))),d=c.mixin({query:c.mixin({request:"getToken",username:r&&r.username,password:r&&r.password,serverUrl:n,token:o,expiration:v,referer:i||p?window.location.host:null,client:i?"referer":null,f:"json"},e.customParameters),method:I?"auto":"post",authMode:"anonymous",useProxy:this._useProxy(e,t),responseType:"json"},t&&t.ioArgs),p||(d.withCredentials=!1),g(h,d).then(function(t){var s=t.data;if(!s||!s.token)return new m("identity-manager:authentication-failed","Unable to generate token");var i=e.server;return U[i]||(U[i]={}),r&&(U[i][r.username]=r.password),s.validity=v,s})},isBusy:function(){return!!this._busy},checkSignInStatus:function(e){return this.getCredential(e,{prompt:!1}).then(function(e){if(!e.token)return e;var r=e.server+("portal"===e.scope?"/sharing/rest":"/rest/services");return g(r,{query:{f:"json",token:e.token},authMode:"anonymous"}).then(function(){return e}).catch(function(r){if(498===r.code){e.destroy();throw new m("identity-manager:not-authenticated","User is not signed in.")}return e})})},setRedirectionHandler:function(e){this._redirectFunc=e},setProtocolErrorHandler:function(e){this._protocolFunc=e},signIn:function(){},oAuthSignIn:function(){},destroyCredentials:function(){if(this.credentials){var e=this.credentials.slice();r.forEach(e,function(e){e.destroy()})}this.emit("credentials-destroy")},_getOAuthHash:function(){var e=window.location.hash;if(e){"#"===e.charAt(0)&&(e=e.substring(1));var r=n.queryToObject(e),t=!1;r.access_token&&r.expires_in&&r.state&&r.hasOwnProperty("username")?(r.state=JSON.parse(r.state),this._oAuthHash=r,t=!0):r.error&&r.error_description&&(console.log("IdentityManager OAuth Error: ",r.error," - ",r.error_description),"access_denied"===r.error&&(t=!0)),t&&(!u("ie")||u("ie")>8)&&(window.location.hash="")}},_pageShowHandler:function(e){if(e.persisted&&this.isBusy()&&this._rejectOnPersistedPageShow){var r=new m("identity-manager:user-aborted","ABORTED");this._errbackFunc(r)}},_findCredential:function(e,t){var s,i,n,o,a=-1,h=t&&t.token,l=t&&t.resource,u=this._isServerRsrc(e)?"server":"portal",c=r.filter(this.credentials,function(r){return this._hasSameServerInstance(r.server,e)&&r.scope===u},this);if(e=l||e,c.length)if(1===c.length){if(s=c[0],o=this.findServerInfo(s.server),i=o&&o.owningSystemUrl,n=i&&this.findCredential(i,s.userId),a=this._getIdenticalSvcIdx(e,s),!h)return-1===a&&s.resources.push(e),this._addResource(e,n),s;-1!==a&&(s.resources.splice(a,1),this._removeResource(e,n))}else{var d,f;if(r.some(c,function(r){return-1!==(f=this._getIdenticalSvcIdx(e,r))&&(d=r,o=this.findServerInfo(d.server),i=o&&o.owningSystemUrl,n=i&&this.findCredential(i,d.userId),a=f,!0)},this),h)d&&(d.resources.splice(a,1),this._removeResource(e,n));else if(d)return this._addResource(e,n),d}},_findOAuthInfo:function(e){var t=this.findOAuthInfo(e);return t||r.some(this.oAuthInfos,function(r){return this._isIdProvider(r.portalUrl,e)&&(t=r),!!t},this),t},_addResource:function(e,r){r&&-1===this._getIdenticalSvcIdx(e,r)&&r.resources.push(e)},_removeResource:function(e,r){var t=-1;r&&(t=this._getIdenticalSvcIdx(e,r))>-1&&r.resources.splice(t,1)},_useProxy:function(e,r){return r&&r.isAdmin&&!_.hasSameOrigin(e.adminTokenServiceUrl,window.location.href)||!this._isPortalDomain(e.tokenServiceUrl)&&10.1==e.currentVersion&&!_.hasSameOrigin(e.tokenServiceUrl,window.location.href)},_getOrigin:function(e){var r=new s(e);return r.scheme+"://"+r.host+(null!=r.port?":"+r.port:"")},_getServerInstanceRoot:function(e){var r=e.toLowerCase(),t=r.indexOf(this._agsRest);return-1===t&&this._isAdminResource(e)&&(t=r.indexOf("/admin")),-1===t&&(t=r.indexOf("/sharing")),-1===t&&"/"===r.substr(-1)&&(t=r.length-1),t>-1?e.substring(0,t):e},_hasSameServerInstance:function(e,r){return"/"===e.substr(-1)&&(e=e.slice(0,-1)),e=e.toLowerCase(),r=this._getServerInstanceRoot(r).toLowerCase(),e=this._normalizeAGOLorgDomain(e),r=this._normalizeAGOLorgDomain(r),e=e.substr(e.indexOf(":")),r=r.substr(r.indexOf(":")),e===r},_normalizeAGOLorgDomain:function(e){var r=/^https?:\/\/.+\.maps\.arcgis\.com/i,t=/^https?:\/\/.+\.mapsdevext\.arcgis\.com/i,s=/^https?:\/\/.+\.mapsqa\.arcgis\.com/i;return r.test(e)?e=e.replace(r,"https://www.arcgis.com"):t.test(e)?e=e.replace(t,"https://devext.arcgis.com"):s.test(e)&&(e=e.replace(s,"https://qaext.arcgis.com")),e},_sanitizeUrl:function(e){var r=(h.request.proxyUrl||"").toLowerCase(),t=r?e.toLowerCase().indexOf(r+"?"):-1;return-1!==t&&(e=e.substring(t+r.length+1)),e=_.normalize(e),_.urlToObject(e).path},_isRESTService:function(e){return e.indexOf(this._agsRest)>-1},_isAdminResource:function(e){return this._agsAdmin.test(e)||this._adminSvcs.test(e)},_isServerRsrc:function(e){return this._isRESTService(e)||this._isAdminResource(e)},_isIdenticalService:function(e,r){var t;if(this._isRESTService(e)&&this._isRESTService(r)){var s=this._getSuffix(e).toLowerCase(),i=this._getSuffix(r).toLowerCase();if(!(t=s===i)){var n=/(.*)\/(MapServer|FeatureServer).*/gi;t=s.replace(n,"$1")===i.replace(n,"$1")}}else this._isAdminResource(e)&&this._isAdminResource(r)?t=!0:this._isServerRsrc(e)||this._isServerRsrc(r)||!this._isPortalDomain(e)||(t=!0);return t},_isPortalDomain:function(e){e=e.toLowerCase();var t=new s(e).authority,i=this._portalConfig,n=-1!==t.indexOf(this._agolSuffix);if(!n&&i&&(n=this._hasSameServerInstance(this._getServerInstanceRoot(i.restBaseUrl),e)),!n){if(!this._arcgisUrl){var o=d.getDeepValue("esri.arcgis.utils.arcgisUrl",l);o&&(this._arcgisUrl=new s(o).authority)}this._arcgisUrl&&(n=this._arcgisUrl.toLowerCase()===t)}return n||(n=r.some(this._portals,function(r){return this._hasSameServerInstance(r,e)},this)),n=n||this._agsPortal.test(e)},_isIdProvider:function(e,t){var s=-1,i=-1;r.forEach(this._gwDomains,function(r,n){-1===s&&r.regex.test(e)&&(s=n),-1===i&&r.regex.test(t)&&(i=n)});var n=!1;if(s>-1&&i>-1&&(0===s||4===s?0!==i&&4!==i||(n=!0):1===s?1!==i&&2!==i||(n=!0):2===s?2===i&&(n=!0):3===s&&3===i&&(n=!0)),!n){var o=this.findServerInfo(t),a=o&&o.owningSystemUrl;a&&y(o)&&this._isPortalDomain(a)&&this._isIdProvider(e,a)&&(n=!0)}return n},_isPublic:function(e){return e=this._sanitizeUrl(e),r.some(this._publicUrls,function(r){return r.test(e)})},_getIdenticalSvcIdx:function(e,t){var s=-1;return r.some(t.resources,function(r,t){return!!this._isIdenticalService(e,r)&&(s=t,!0)},this),s},_getSuffix:function(e){return e.replace(this._regexSDirUrl,"").replace(this._regexServerType,"$1")},_getTokenSvcUrl:function(e){var t,i,n,o=this._isRESTService(e);if(o||this._isAdminResource(e))return n=e.toLowerCase().indexOf(o?this._agsRest:"/admin/"),t=e.substring(0,n)+"/admin/generateToken",e=e.substring(0,n)+(o?"/rest/info":"/info"),i=g(e,{query:{f:"json"},responseType:"json"}).then(function(e){return e.data}),{adminUrl:t,promise:i};if(this._isPortalDomain(e)){var a="";if(r.some(this._gwDomains,function(r){return r.regex.test(e)&&(a=r.tokenServiceUrl),!!a}),a||r.some(this._portals,function(r){return this._hasSameServerInstance(r,e)&&(a=r+this._gwTokenUrl),!!a},this),a||-1!==(n=e.toLowerCase().indexOf("/sharing"))&&(a=e.substring(0,n)+this._gwTokenUrl),a||(a=this._getOrigin(e)+this._gwTokenUrl),a){var h=new s(e).port;/^http:\/\//i.test(e)&&"7080"===h&&(a=a.replace(/:7080/i,":7443")),a=a.replace(/http:/i,"https:")}return a}return-1!==e.toLowerCase().indexOf("premium.arcgisonline.com")?"https://premium.arcgisonline.com/server/tokens":void 0},_getPortalSelf:function(e,r){return"https:"===window.location.protocol?e=e.replace(/^http:/i,"https:").replace(/:7080/i,":7443"):/^http:/i.test(r)&&(e=e.replace(/^https:/i,"http:").replace(/:7443/i,":7080")),g(e,{query:{f:"json"},authMode:"anonymous",responseType:"json",withCredentials:!0}).then(function(e){return e.data})},_hasPortalSession:function(){return!!this._getEsriAuthCookie()},_getEsriAuthCookie:function(){var e=null;if(i.isSupported()){var r,t=this._getAllCookies("esri_auth");for(r=0;r<t.length;r++){var s=JSON.parse(t[r]);if(s.portalApp){e=s;break}}}if(e){var n=null;e.expires&&("number"==typeof e.expires?n=e.expires:"string"==typeof e.expires&&(n=Date.parse(e.expires)),isNaN(n)&&(n=null),e.expires=n),n&&n<Date.now()&&(e=null)}return e},_getAllCookies:function(e){var r,t=[],s=document.cookie,i=s.match(new RegExp("(?:^|; )"+o.escapeString(e)+"=([^;]*)","g"));if(i)for(r=0;r<i.length;r++){var n=i[r],a=n.indexOf("=");a>-1&&(n=n.substring(a+1),t.push(decodeURIComponent(n)))}return t},_doPortalSignIn:function(e){if(i.isSupported()){var r=this._getEsriAuthCookie(),t=this._portalConfig,s=window.location.href,n=this.findServerInfo(e);if(this.useSignInPage&&(t||this._isPortalDomain(s)||r)&&(n?n.hasPortal||n.owningSystemUrl&&this._isPortalDomain(n.owningSystemUrl):this._isPortalDomain(e))&&(this._isIdProvider(s,e)||t&&(this._hasSameServerInstance(this._getServerInstanceRoot(t.restBaseUrl),e)||this._isIdProvider(t.restBaseUrl,e))||_.hasSameOrigin(s,e,!0)))return!0}return!1},_checkProtocol:function(e,r,t,s){var i=!0,n=s?r.adminTokenServiceUrl:r.tokenServiceUrl;if(0===n.trim().toLowerCase().indexOf("https:")&&0!==window.location.href.toLowerCase().indexOf("https:")&&_.getProxyRule(n)&&!(i=!!this._protocolFunc&&!!this._protocolFunc({resourceUrl:e,serverInfo:r}))){t(new m("identity-manager:aborted","Aborted the Sign-In process to avoid sending password over insecure connection."))}return i},_enqueue:function(e,r,t,s,i,n){return s||(s=v.makeDeferredCancellingPending()),s.resUrl_=e,s.sinfo_=r,s.options_=t,s.admin_=i,s.refresh_=n,this._busy?this._hasSameServerInstance(this._getServerInstanceRoot(e),this._busy.resUrl_)?(this._oAuthDfd&&this._oAuthDfd.oAuthWin_&&this._oAuthDfd.oAuthWin_.focus(),this._soReqs.push(s)):this._xoReqs.push(s):this._doSignIn(s),s.promise},_doSignIn:function(e){this._busy=e,this._rejectOnPersistedPageShow=!1;var t=this,s=function(s){var i=e.options_&&e.options_.resource,n=e.resUrl_,o=e.refresh_,a=!1;-1===r.indexOf(t.credentials,s)&&(o&&-1!==r.indexOf(t.credentials,o)?(o.userId=s.userId,o.token=s.token,o.expires=s.expires,o.validity=s.validity,o.ssl=s.ssl,o.creationTime=s.creationTime,a=!0,s=o):t.credentials.push(s)),s.resources||(s.resources=[]),s.resources.push(i||n),s.scope=t._isServerRsrc(n)?"server":"portal",s.emitTokenChange();var h=t._soReqs,l={};t._soReqs=[],r.forEach(h,function(e){if(!this._isIdenticalService(n,e.resUrl_)){var r=this._getSuffix(e.resUrl_);l[r]||(l[r]=!0,s.resources.push(e.resUrl_))}},t),e.resolve(s),r.forEach(h,function(e){this._hasSameServerInstance(this._getServerInstanceRoot(n),e.resUrl_)?e.resolve(s):this._soReqs.push(e)},t),t._busy=e.resUrl_=e.sinfo_=e.refresh_=null,a||t.emit("credential-create",{credential:s}),t._soReqs.length?t._doSignIn(t._soReqs.shift()):t._xoReqs.length&&t._doSignIn(t._xoReqs.shift())},i=function(r){e.reject(r),t._busy=e.resUrl_=e.sinfo_=e.refresh_=null,t._soReqs.length?t._doSignIn(t._soReqs.shift()):t._xoReqs.length&&t._doSignIn(t._xoReqs.shift())},n=function(r,n,o,a){var h,l,u=e.sinfo_,c=!e.options_||!1!==e.options_.prompt,d=u.hasPortal&&t._findOAuthInfo(e.resUrl_);if(t._doPortalSignIn(e.resUrl_)){var f=t._getEsriAuthCookie(),_=t._portalConfig;if(f){if(!u.webTierAuth){"web"===(f.auth_tier&&f.auth_tier.toLowerCase())&&(u.webTierAuth=!0)}return void s(new k({userId:f.email,server:u.server,token:f.token,expires:f.expires}))}if(c){var v="",p=window.location.href;return v=t.signInPage?t.signInPage:_?_.baseUrl+_.signin:t._isIdProvider(p,e.resUrl_)?t._getOrigin(p)+"/home/signin.html":u.tokenServiceUrl.replace(t._rePortalTokenSvc,"")+"/home/signin.html",v=v.replace(/http:/i,"https:"),_&&!1===_.useSSL&&(v=v.replace(/https:/i,"http:")),void(0===p.toLowerCase().replace("https","http").indexOf(v.toLowerCase().replace("https","http"))?(l=new m("identity-manager:unexpected-error","Cannot redirect to Sign-In page from within Sign-In page. URL of the resource that triggered this workflow: "+e.resUrl_),i(l)):(t._rejectOnPersistedPageShow=!0,t._redirectFunc?t._redirectFunc({signInPage:v,returnUrlParamName:"returnUrl",returnUrl:p,resourceUrl:e.resUrl_,serverInfo:u}):window.location=v+"?returnUrl="+window.escape(p)))}l=new m("identity-manager:not-authenticated","User is not signed in."),i(l)}else if(r)s(new k({userId:r,server:u.server,token:o,expires:null!=a?Number(a):null,ssl:!!n}));else if(d){var g=d._oAuthCred;if(!g){var S=new w(d,window.localStorage),I=new w(d,window.sessionStorage);S.isValid()&&I.isValid()?S.expires>I.expires?(g=S,I.destroy()):(g=I,S.destroy()):g=S.isValid()?S:I,d._oAuthCred=g}if(g.isValid())s(new k({userId:g.userId,server:u.server,token:g.token,expires:g.expires,ssl:g.ssl,_oAuthCred:g}));else if(t._oAuthHash&&t._oAuthHash.state.portalUrl===d.portalUrl){var U=t._oAuthHash;h=new k({userId:U.username,server:u.server,token:U.access_token,expires:(new Date).getTime()+1e3*Number(U.expires_in),ssl:"true"===U.ssl,oAuthState:U.state,_oAuthCred:g}),g.storage=U.persist?window.localStorage:window.sessionStorage,g.token=h.token,g.expires=h.expires,g.userId=h.userId,g.ssl=h.ssl,g.save(),t._oAuthHash=null,s(h)}else c?e._pendingDfd=t.oAuthSignIn(e.resUrl_,u,d,e.options_).then(s,i):(l=new m("identity-manager:not-authenticated","User is not signed in."),i(l))}else if(c){if(t._checkProtocol(e.resUrl_,u,i,e.admin_)){var y=e.options_;e.admin_&&(y=y||{},y.isAdmin=!0),e._pendingDfd=t.signIn(e.resUrl_,u,y).then(s,i)}}else l=new m("identity-manager:not-authenticated","User is not signed in."),i(l)},o=function(){var n,o,a,h,l=e.sinfo_,u=l.owningSystemUrl,c=e.options_;if(c&&(n=c.token,o=c.error,a=c.prompt),h=t._findCredential(u,{token:n,resource:e.resUrl_}),h||r.some(t.credentials,function(e){return this._isIdProvider(u,e.server)&&(h=e),!!h},t),h){var d=t.findCredential(e.resUrl_,h.userId);if(d)s(d);else if(T(l,t._legacyFed)){var f=h.toJSON();f.server=l.server,f.resources=null,s(new k(f))}else{var _=e._pendingDfd=t.generateToken(t.findServerInfo(h.server),null,{serverUrl:e.resUrl_,token:h.token,ssl:h.ssl});_.then(function(r){s(new k({userId:h.userId,server:l.server,token:r.token,expires:null!=r.expires?Number(r.expires):null,ssl:!!r.ssl,isAdmin:e.admin_,validity:r.validity}))},i)}}else{t._busy=null,n&&(e.options_.token=null);(e._pendingDfd=t.getCredential(u.replace(/\/?$/,"/sharing"),{resource:e.resUrl_,owningTenant:l.owningTenant,token:n,error:o,prompt:a})).then(function(r){t._enqueue(e.resUrl_,e.sinfo_,e.options_,e,e.admin_)},function(e){i(e)})}};this._errbackFunc=i;var a=e.sinfo_.owningSystemUrl,h=this._isServerRsrc(e.resUrl_),l=e.sinfo_._restInfoPms;l?l.promise.then(function(r){var s=e.sinfo_;s.adminTokenServiceUrl=s._restInfoPms.adminUrl,s._restInfoPms=null,s.tokenServiceUrl=d.getDeepValue("authInfo.tokenServicesUrl",r)||d.getDeepValue("authInfo.tokenServiceUrl",r)||d.getDeepValue("tokenServiceUrl",r),s.shortLivedTokenValidity=d.getDeepValue("authInfo.shortLivedTokenValidity",r),s.currentVersion=r.currentVersion,s.owningTenant=r.owningTenant;var i=s.owningSystemUrl=r.owningSystemUrl;i&&t._portals.push(i),h&&i?o():n()},function(){e.sinfo_._restInfoPms=null;var r=new m("identity-manager:server-identification-failed","Unknown resource - could not find token service endpoint.");i(r)}):h&&a?o():e.sinfo_._selfReq?e.sinfo_._selfReq.selfDfd.then(function(r){var s,i,n,o,a={};return r&&(s=r.user&&r.user.username,a.username=s,a.allSSL=r.allSSL,i=r.supportsOAuth,n=r.currentVersion,"multitenant"===r.portalMode&&(o=r.customBaseUrl)),e.sinfo_.webTierAuth=!!s,s&&t.normalizeWebTierAuth?t.generateToken(e.sinfo_,null,{ssl:a.allSSL}).always(function(e){return a.portalToken=e&&e.token,a.tokenExpiration=e&&e.expires,a}):!s&&i&&parseFloat(n)>=4.4&&!t._doPortalSignIn(e.resUrl_)?t._generateOAuthInfo({portalUrl:e.sinfo_.server,customBaseUrl:o,owningTenant:e.sinfo_._selfReq.owningTenant}).always(function(){return a}):a}).always(function(r){e.sinfo_._selfReq=null,r?n(r.username,r.allSSL,r.portalToken,r.tokenExpiration):n()}):n()},_generateOAuthInfo:function(e){var r,s,i=this,n=e.portalUrl,o=e.customBaseUrl,a=e.owningTenant,h=!this.defaultOAuthInfo&&this._createDefaultOAuthInfo&&!this._hasTestedIfAppIsOnPortal;if(h){s=window.location.href;var l=s.indexOf("?");l>-1&&(s=s.slice(0,l)),l=s.search(/\/(apps|home)\//),s=l>-1?s.slice(0,l):null}return h&&s?(this._hasTestedIfAppIsOnPortal=!0,r=g(s+"/sharing/rest",{query:{f:"json"},responseType:"json"}).then(function(){i.defaultOAuthInfo=new I({appId:"arcgisonline",popup:!0,popupCallbackUrl:s+"/home/oauth-callback.html"})})):(r=new t,r.resolve(),r=r.promise),r.then(function(){if(i.defaultOAuthInfo)return n=n.replace(/^http:/i,"https:"),g(n+"/sharing/rest/oauth2/validateRedirectUri",{query:{accountId:a,client_id:i.defaultOAuthInfo.appId,redirect_uri:_.makeAbsolute(i.defaultOAuthInfo.popupCallbackUrl),f:"json"},responseType:"json"}).then(function(e){if(e.data.valid){var r=i.defaultOAuthInfo.clone();e.data.urlKey&&o?r.portalUrl="https://"+e.data.urlKey+"."+o:r.portalUrl=n,i.oAuthInfos.push(r)}})})}});return k=p.createSubclass([S],{declaredClass:"esri.identity.Credential",constructor:function(e){e&&e._oAuthCred&&(this._oAuthCred=e._oAuthCred)},initialize:function(){this.resources=this.resources||[],null==this.creationTime&&(this.creationTime=(new Date).getTime())},_oAuthCred:null,properties:{creationTime:{},expires:{},isAdmin:{},oAuthState:{},resources:{},scope:{},server:{},ssl:{},token:{},tokenRefreshBuffer:2,userId:{},validity:{}},refreshToken:function(){var e,t,s=this,i=this.resources&&this.resources[0],n=a.id.findServerInfo(this.server),o=n&&n.owningSystemUrl,h=!!o&&"server"===this.scope,l=h&&T(n,a.id._legacyFed),u=h&&a.id.findServerInfo(o),c=n.webTierAuth,d=c&&a.id.normalizeWebTierAuth,f=U[this.server],_=f&&f[this.userId],v={username:this.userId,password:_};if((!c||d)&&(h&&!u&&r.some(a.id.serverInfos,function(e){return a.id._isIdProvider(o,e.server)&&(u=e),!!u}),e=u&&a.id.findCredential(u.server,this.userId),!h||e)){if(l)return void e.refreshToken();if(h)t={serverUrl:i,token:e&&e.token,ssl:e&&e.ssl};else if(d)v=null,t={ssl:this.ssl};else{if(!_){var p;return i&&(i=a.id._sanitizeUrl(i),this._enqueued=1,p=a.id._enqueue(i,n,null,null,this.isAdmin,this),p.then(function(){s._enqueued=0,s.refreshServerTokens()}).then(null,function(){s._enqueued=0})),p}this.isAdmin&&(t={isAdmin:!0})}return a.id.generateToken(h?u:n,h?null:v,t).then(function(e){s.token=e.token,s.expires=null!=e.expires?Number(e.expires):null,s.creationTime=(new Date).getTime(),s.validity=e.validity,s.emitTokenChange(),s.refreshServerTokens()}).then(null,function(){})}},refreshServerTokens:function(){"portal"===this.scope&&r.forEach(a.id.credentials,function(e){var r=a.id.findServerInfo(e.server),t=r&&r.owningSystemUrl;e!==this&&e.userId===this.userId&&t&&"server"===e.scope&&(a.id._hasSameServerInstance(this.server,t)||a.id._isIdProvider(t,this.server))&&(T(r,a.id._legacyFed)?(e.token=this.token,e.expires=this.expires,e.creationTime=this.creationTime,e.validity=this.validity,e.emitTokenChange()):e.refreshToken())},this)},emitTokenChange:function(e){clearTimeout(this._refreshTimer);var r=this.server&&a.id.findServerInfo(this.server),t=r&&r.owningSystemUrl,s=t&&a.id.findServerInfo(t);!1===e||t&&"portal"!==this.scope&&(!s||!s.webTierAuth||a.id.normalizeWebTierAuth)||null==this.expires&&null==this.validity||this._startRefreshTimer(),this.emit("token-change")},destroy:function(){this.userId=this.server=this.token=this.expires=this.validity=this.resources=this.creationTime=null,this._oAuthCred&&(this._oAuthCred.destroy(),this._oAuthCred=null);var e=r.indexOf(a.id.credentials,this);e>-1&&a.id.credentials.splice(e,1),this.emitTokenChange(),this.emit("destroy")},toJSON:function(){var e=c.fixJson({userId:this.userId,server:this.server,token:this.token,expires:this.expires,validity:this.validity,ssl:this.ssl,isAdmin:this.isAdmin,creationTime:this.creationTime,scope:this.scope}),r=this.resources;return r&&r.length>0&&(e.resources=r.slice()),e},_startRefreshTimer:function(){clearTimeout(this._refreshTimer);var e=6e4*this.tokenRefreshBuffer,r=this.validity?this.creationTime+6e4*this.validity:this.expires,t=r-(new Date).getTime();t<0&&(t=0),this._refreshTimer=setTimeout(this.refreshToken.bind(this),t>e?t-e:t)}}),x.Credential=k,x});