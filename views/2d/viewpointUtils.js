/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../Viewpoint","../../core/Collection","../../core/maybe","../../core/unitUtils","../../chunks/common","../../chunks/mat2d","../../chunks/mat2df64","../../chunks/vec2","../../chunks/vec2f64","../../geometry/Extent","../../geometry/Geometry","../../geometry/Point","../../geometry/SpatialReference","../../geometry/support/Ellipsoid","../../geometry/support/spatialReferenceUtils","../../geometry/support/webMercatorUtils"],(function(e,t,n,r,o,a,c,i,s,u,l,f,y,m,g,p,d,h){"use strict";const x=39.37,b=180/Math.PI;function M(e,t,n){const r=c.toDegree(t[0]/p.earth.radius);return u.set(e,n?r:r-360*Math.floor((r+180)/360),c.toDegree(.5*Math.PI-2*Math.atan(Math.exp(-t[1]/p.earth.radius))))}function S(e,t){let n=t[1];return n>89.99999?n=89.99999:n<-89.99999&&(n=-89.99999),n=Math.sin(c.toRadian(n)),u.set(e,c.toRadian(t[0])*p.earth.radius,.5*p.earth.radius*Math.log((1+n)/(1-n)))}function G(e,t,n,r){return r&&n&&!r.equals(n)&&h.canProject(r,n)&&r.isWebMercator?r.isWebMercator?S(e,t):M(e,t):u.copy(e,t)}function w(e){return e.wkid?e:e.spatialReference||g.WGS84}function R(e,t){return t.type?u.set(e,t.x,t.y):u.copy(e,t)}function A(e){return a.getMetersPerUnitForSR(e)}function P(e,t){return Math.max(e.width/t[0],e.height/t[1])*U(e.spatialReference)}function k(e,t,n,r){return j.apply(this,arguments)}function j(){return(j=t._asyncToGenerator((function*(e,t,n,a){let c,i;if(!e)return null;if(Array.isArray(e)&&!e.length)return null;if(r.isCollection(e)&&(e=e.toArray()),Array.isArray(e)&&e.length&&"object"==typeof e[0]){const r=e.every((e=>"attributes"in e)),c=e.some((e=>!e.geometry));let i=e;if(r&&c&&t&&t.allLayerViews){const n=new Map;for(const t of e){const e=t.layer,r=n.get(e)||[],o=t.attributes[e.objectIdField];null!=o&&r.push(o),n.set(e,r)}const r=[];n.forEach(((e,n)=>{const o=t.allLayerViews.find((e=>e.layer.id===n.id));if("queryFeatures"in o){const t=n.createQuery();t.objectIds=e,t.returnGeometry=!0,r.push(o.queryFeatures(t))}}));const a=yield Promise.all(r),c=[];for(const e of a)if(e&&e.features&&e.features.length)for(const t of e.features)o.isSome(t.geometry)&&c.push(t.geometry);i=c}for(const e of i)a=yield k(e,t,n,a);return a}if(Array.isArray(e)&&2===e.length&&"number"==typeof e[0]&&"number"==typeof e[1])c=new m(e);else if(e instanceof y)c=e;else if("geometry"in e)if(e.geometry)c=e.geometry;else if(e.layer){const n=e.layer,r=t.allLayerViews.find((e=>e.layer.id===n.id));if("queryFeatures"in r){const t=n.createQuery();t.objectIds=[e.attributes[n.objectIdField]],t.returnGeometry=!0;const a=yield r.queryFeatures(t);c=o.get(a,"features",0,"geometry")}}if(o.isNone(c))return null;if(i="point"===c.type?new f({xmin:c.x,ymin:c.y,xmax:c.x,ymax:c.y,spatialReference:c.spatialReference}):c.extent,!i)return null;const s=h.project(i,n);return o.isNone(s)?null:a=a?a.union(s):s}))).apply(this,arguments)}function v(e){if(e&&(!Array.isArray(e)||"number"!=typeof e[0])&&("object"==typeof e||Array.isArray(e)&&"object"==typeof e[0])){if("layer"in e&&e.layer&&e.layer.minScale&&e.layer.maxScale){const t=e.layer;return{min:t.minScale,max:t.maxScale}}if(Array.isArray(e)&&e.length&&e.every((e=>"layer"in e))){let t=0,n=0;for(const r of e){const e=r.layer;e&&e.minScale&&e.maxScale&&(t=e.minScale<t?e.minScale:t,n=e.maxScale>n?e.maxScale:n)}return t&&n?{min:t,max:n}:null}}}function T(e,t){return z.apply(this,arguments)}function z(){return(z=t._asyncToGenerator((function*(e,t){if(!e||!t)return new n({targetGeometry:new m,scale:0,rotation:0});let r=t.spatialReference;const{constraints:a,padding:c,viewpoint:i,size:s}=t,u=[c?s[0]-c.left-c.right:s[0],c?s[1]-c.top-c.bottom:s[1]];let y=null;e instanceof n?y=e:e.viewpoint?y=e.viewpoint:e.target&&"esri.Viewpoint"===e.target.declaredClass&&(y=e.target);let g=null;y&&y.targetGeometry?g=y.targetGeometry:e instanceof f?g=e:(e||e&&("center"in e||"extent"in e||"target"in e))&&(g=(yield k(e.center,t,r))||(yield k(e.extent,t,r))||(yield k(e.target,t,r))||(yield k(e,t,r))),!g&&i&&i.targetGeometry?g=i.targetGeometry:!g&&t.extent&&(g=t.extent);const p=w(g);if(r||(r=w(t.spatialReference||t.extent||g)),!h.canProject(g,r)&&p&&!p.equals(r))return null;const d=R(l.create(),g.center?g.center:g),x=new m(G(d,d,p,r),r);let b=null;if(y&&o.isSome(y.targetGeometry)&&"point"===y.targetGeometry.type)b=y.scale;else if(e.hasOwnProperty("scale")&&e.scale)b=e.scale;else if(e.hasOwnProperty("zoom")&&-1!==e.zoom&&a&&a.effectiveLODs)b=a.zoomToScale(e.zoom);else if(Array.isArray(g)||"point"===g.type||"extent"===g.type&&0===g.width&&0===g.height){const e=h.project(t.extent,r);b=o.isSome(e)?P(e,u):t.extent?P(t.extent,u):i.scale}else b=h.canProject(g.extent,r)?P(h.project(g.extent,r),u):P(g.extent,u);const M=v(e);M&&(M.min&&M.min>b?b=M.min:M.max&&M.max<b&&(b=M.max));let S=0;y?S=y.rotation:e.hasOwnProperty("rotation")?S=e.rotation:i&&(S=i.rotation);let A=new n({targetGeometry:x,scale:b,rotation:S});return a&&(A=a.fit(A),a.constrainByGeometry(A),a.rotationEnabled||(A.rotation=S)),A}))).apply(this,arguments)}function N(e,t){const n=e.targetGeometry,r=t.targetGeometry;return n.x=r.x,n.y=r.y,n.spatialReference=r.spatialReference,e.scale=t.scale,e.rotation=t.rotation,e}function B(e,t,n){return n?u.set(e,.5*(t[0]-n.right+n.left),.5*(t[1]-n.bottom+n.top)):u.scale(e,t,.5)}const F=function(){const e=l.create();return function(t,n,r){const o=n.targetGeometry;R(e,o);const a=.5*O(n);return t.xmin=e[0]-a*r[0],t.ymin=e[1]-a*r[1],t.xmax=e[0]+a*r[0],t.ymax=e[1]+a*r[1],t.spatialReference=o.spatialReference,t}}();function V(e,t,n,r,o){return te(e,t,n.center),e.scale=P(n,r),o&&o.constraints&&o.constraints.constrain(e),e}function W(e,t,n,r){return H(e,t,n,r),i.invert(e,e)}function I(e,t,n){const r=L(t),o=Math.abs(Math.cos(r)),a=Math.abs(Math.sin(r));return u.set(e,Math.round(n[1]*a+n[0]*o),Math.round(n[1]*o+n[0]*a))}const q=function(){const e=l.create();return function(t,n,r){return u.sub(t,C(t,n),B(e,n,r))}}(),E=function(){const e=s.create(),t=l.create();return function(n,r,o,a){const c=O(r),s=L(r);return u.set(t,c,c),i.fromScaling(e,t),i.rotate(e,e,s),i.translate(e,e,q(t,o,a)),i.translate(e,e,[0,a.top-a.bottom]),u.set(n,e[4],e[5])}}();function O(e){return e.scale*_(e.targetGeometry)}function _(e){return o.isSome(e)&&d.isValid(e.spatialReference)?1/(A(e.spatialReference)*x*D()):1}function L(e){return c.toRadian(e.rotation)||0}function U(e){return d.isValid(e)?A(e)*x*D():1}function C(e,t){return u.scale(e,t,.5)}function D(){return 96}const Q=function(){const e=l.create(),t=l.create(),n=l.create();return function(r,o,a,c,s,l){return u.negate(e,o),u.scale(t,a,.5*l),u.set(n,1/c*l,-1/c*l),i.identity(r),i.translate(r,r,t),s&&i.rotate(r,r,s),i.scale(r,r,n),i.translate(r,r,e),r}}(),H=function(){const e=l.create();return function(t,n,r,o){const a=O(n),c=L(n);return R(e,n.targetGeometry),Q(t,e,r,a,c,o)}}(),J=function(){const e=l.create();return function(t,n,r,o){const a=O(n);return R(e,n.targetGeometry),Q(t,e,r,a,0,o)}}();function K(e){if(e.isWrappable){const t=d.getInfo(e);return t.valid[1]-t.valid[0]}return 0}function X(e,t){return Math.round(K(e)/t)}function Y(e,t){return T(e,t)}const Z=function(){const e=l.create(),t=l.create(),n=[0,0,0];return function(r,o,a){u.subtract(e,r,o),u.normalize(e,e),u.subtract(t,r,a),u.normalize(t,t),u.cross(n,e,t);let c=Math.acos(u.dot(e,t)/(u.length(e)*u.length(t)))*b;return n[2]<0&&(c=-c),isNaN(c)&&(c=0),c}}(),$=function(){const e=l.create();return function(t,n,r,o){const a=t.targetGeometry;return N(t,n),E(e,n,r,o),a.x+=e[0],a.y+=e[1],t}}(),ee=function(){const e=l.create();return function(t,n,r,o){const a=t.targetGeometry;return N(t,n),E(e,n,r,o),a.x-=e[0],a.y-=e[1],t}}(),te=function(){const e=l.create();return function(t,n,r){N(t,n);const o=t.targetGeometry,a=w(r),c=w(o);return R(e,r),G(e,e,a,c),o.x=e[0],o.y=e[1],t}}();function ne(e){return O(e)}const re=function(){const e=l.create();return function(t,n,r,o,a){a||(a="center"),u.sub(e,r,o),u.scale(e,e,.5);const c=e[0],i=e[1];switch(a){case"center":u.set(e,0,0);break;case"left":u.set(e,-c,0);break;case"top":u.set(e,0,i);break;case"right":u.set(e,c,0);break;case"bottom":u.set(e,0,-i);break;case"top-left":u.set(e,-c,i);break;case"bottom-left":u.set(e,-c,-i);break;case"top-right":u.set(e,c,i);break;case"bottom-right":u.set(e,c,-i)}return ye(t,n,e),t}}();function oe(e,t,n){return N(e,t),e.rotation+=n,e}function ae(e,t,n){return N(e,t),e.rotation=n,e}const ce=function(){const e=l.create();return function(t,n,r,o,a){return N(t,n),isNaN(r)||0===r||(le(e,o,n,a),t.scale=n.scale*r,fe(e,e,t,a),ye(t,t,u.set(e,e[0]-o[0],o[1]-e[1]))),t}}();function ie(e,t,n){return N(e,t),e.scale=n,e}const se=function(){const e=l.create();return function(t,n,r,o,a,c){return N(t,n),isNaN(r)||0===r||(le(e,a,n,c),t.scale=n.scale*r,t.rotation+=o,fe(e,e,t,c),ye(t,t,u.set(e,e[0]-a[0],a[1]-e[1]))),t}}(),ue=function(){const e=l.create(),t=l.create();return function(n,r,o,a,c,i,s){return q(t,i,s),u.add(e,c,t),a?se(n,r,o,a,e,i):ce(n,r,o,e,i)}}(),le=function(){const e=s.create();return function(t,n,r,o){return u.transformMat2d(t,n,W(e,r,o,1))}}(),fe=function(){const e=s.create();return function(t,n,r,o){return u.transformMat2d(t,n,H(e,r,o,1))}}(),ye=function(){const e=l.create(),t=s.create();return function(n,r,o){N(n,r);const a=O(r),c=n.targetGeometry;return i.fromRotation(t,L(r)),i.scale(t,t,l.fromValues(a,a)),u.transformMat2d(e,o,t),c.x+=e[0],c.y+=e[1],n}}();e.addPadding=$,e.angleBetween=Z,e.centerAt=te,e.copy=N,e.create=T,e.createAsync=Y,e.extentToScale=P,e.getAnchor=B,e.getExtent=F,e.getMatrix=Q,e.getOuterSize=I,e.getPaddingMapTranslation=E,e.getPaddingScreenTranslation=q,e.getResolution=O,e.getResolutionToScaleFactor=U,e.getTransform=H,e.getTransformNoRotation=J,e.getWorldScreenWidth=X,e.getWorldWidth=K,e.padAndScaleAndRotateBy=ue,e.pixelSize=ne,e.removePadding=ee,e.resize=re,e.rotateBy=oe,e.rotateTo=ae,e.scaleAndRotateBy=se,e.scaleBy=ce,e.scaleTo=ie,e.setExtent=V,e.toMap=le,e.toScreen=fe,e.translateBy=ye,Object.defineProperty(e,"__esModule",{value:!0})}));
