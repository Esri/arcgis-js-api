// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../Viewpoint","../../core/Collection","../../core/maybe","../../core/promiseUtils","../../core/unitUtils","../../core/libs/gl-matrix-2/common","../../core/libs/gl-matrix-2/mat2d","../../core/libs/gl-matrix-2/mat2df64","../../core/libs/gl-matrix-2/vec2","../../core/libs/gl-matrix-2/vec2f64","../../geometry/Extent","../../geometry/Geometry","../../geometry/Point","../../geometry/SpatialReference","../../geometry/support/geodesicConstants","../../geometry/support/spatialReferenceUtils","../../geometry/support/webMercatorUtils","../../geometry/support/webMercatorUtils"],(function(e,t,r,a,n,c,o,i,s,u,l,f,m,y,g,v,d,p,x,h,b){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.translateBy=t.toScreen=t.toMap=t.padAndScaleAndRotateBy=t.scaleAndRotateBy=t.scaleTo=t.scaleBy=t.rotateTo=t.rotateBy=t.resize=t.pixelSize=t.centerAt=t.removePadding=t.addPadding=t.angleBetween=t.createAsync=t.getWorldScreenWidth=t.getWorldWidth=t.getTransformNoRotation=t.getTransform=t.getMatrix=t.getResolutionToScaleFactor=t.getResolution=t.getPaddingMapTranslation=t.getPaddingScreenTranslation=t.getOuterSize=t.getOuterExtent=t.setExtent=t.getExtent=t.getAnchor=t.copy=t.create=t.extentToScale=void 0;var M,R,S,w,A,G,P,T,B,j,z,W=180/Math.PI;function _(e,t,r,a){return a&&r&&!a.equals(r)&&h.canProject(a,r)&&a.isWebMercator?a.isWebMercator?function(e,t){var r=t[1];return r>89.99999?r=89.99999:r<-89.99999&&(r=-89.99999),r=Math.sin(s.common.toRadian(r)),f.vec2.set(e,s.common.toRadian(t[0])*p.earthRadius,.5*p.earthRadius*Math.log((1+r)/(1-r)))}(e,t):function(e,t,r){var a=s.common.toDegree(t[0]/p.earthRadius);return f.vec2.set(e,r?a:a-360*Math.floor((a+180)/360),s.common.toDegree(.5*Math.PI-2*Math.atan(Math.exp(-1*t[1]/p.earthRadius))))}(e,t):f.vec2.copy(e,t)}function k(e){return e.wkid?e:e.spatialReference||d.WGS84}function E(e,t){return t.type?f.vec2.set(e,t.x,t.y):f.vec2.copy(e,t)}function F(e){return i.getMetersPerUnitForSR(e)}function N(e,t){return Math.max(e.width/t[0],e.height/t[1])*D(e.spatialReference)}function O(e,t,a,i){return r.__awaiter(this,void 0,void 0,(function(){var s,u,l,f,m,d,p,x,b,M,R,S,w,A,G,P,T,B,j,z,W,_,k,E,F,N,q;return r.__generator(this,(function(r){switch(r.label){case 0:if(!e)return[2,null];if(Array.isArray(e)&&!e.length)return[2,null];if(n.isCollection(e)&&(e=e.toArray()),!Array.isArray(e)||!e.length||"object"!=typeof e[0])return[3,7];if(u=e.every((function(e){return"attributes"in e})),l=e.some((function(e){return!e.geometry})),f=e,!(u&&l&&t&&t.allLayerViews))return[3,2];for(m=new Map,d=0,p=e;d<p.length;d++)j=p[d],x=j.layer,b=m.get(x)||[],null!=(M=j.attributes[x.objectIdField])&&b.push(M),m.set(x,b);return R=[],m.forEach((function(e,r){var a=t.allLayerViews.find((function(e){return e.layer.id===r.id}));if("queryFeatures"in a){var n=r.createQuery();n.objectIds=e,n.returnGeometry=!0,R.push(a.queryFeatures(n))}})),[4,o.all(R)];case 1:for(S=r.sent(),w=[],A=0,G=S;A<G.length;A++)if((P=G[A])&&P.features&&P.features.length)for(T=0,B=P.features;T<B.length;T++)j=B[T],c.isSome(j.geometry)&&w.push(j.geometry);f=w,r.label=2;case 2:z=0,W=f,r.label=3;case 3:return z<W.length?[4,O(W[z],t,a,i)]:[3,6];case 4:i=r.sent(),r.label=5;case 5:return z++,[3,3];case 6:return[2,i];case 7:return Array.isArray(e)&&2===e.length&&"number"==typeof e[0]&&"number"==typeof e[1]?(s=new v(e),[3,12]):[3,8];case 8:return e instanceof g?(s=e,[3,12]):[3,9];case 9:return"geometry"in e?e.geometry?(s=e.geometry,[3,12]):[3,10]:[3,12];case 10:return e.layer?(_=e.layer,"queryFeatures"in(k=t.allLayerViews.find((function(e){return e.layer.id===_.id})))?((E=_.createQuery()).objectIds=[e.attributes[_.objectIdField]],E.returnGeometry=!0,[4,k.queryFeatures(E)]):[3,12]):[3,12];case 11:F=r.sent(),s=c.get(F,"features",0,"geometry"),r.label=12;case 12:if(c.isNone(s))return[2,null];if(!(N="point"===s.type?new y({xmin:s.x,ymin:s.y,xmax:s.x,ymax:s.y,spatialReference:s.spatialReference}):s.extent))return[2,null];if(q=h.canProject(N,a),!N.spatialReference.equals(a)&&q)N=h.project(N,a);else if(!q)return[2,null];return[2,i=i?i.union(N):N.clone()]}}))}))}function q(e,t){return r.__awaiter(this,void 0,void 0,(function(){var n,c,o,i,s,u,l,f,g,d,p,x,M,R,S,w,A,G,P,T;return r.__generator(this,(function(r){switch(r.label){case 0:return e&&t?(n=t.spatialReference,c=t.constraints,o=t.padding,i=t.viewpoint,s=t.size,u=o?s[0]-o.left-o.right:s[0],l=o?s[1]-o.top-o.bottom:s[1],f=[u,l],g=null,e instanceof a?g=e:e.viewpoint?g=e.viewpoint:e.target&&"esri.Viewpoint"===e.target.declaredClass&&(g=e.target),d=null,g&&g.targetGeometry?(d=g.targetGeometry,[3,10]):[3,1]):[2,new a({targetGeometry:new v,scale:0,rotation:0})];case 1:return e instanceof y?(d=e,[3,10]):[3,2];case 2:return e||e&&("center"in e||"extent"in e||"target"in e)?[4,O(e.center,t,n)]:[3,10];case 3:return(M=r.sent())?[3,5]:[4,O(e.extent,t,n)];case 4:M=r.sent(),r.label=5;case 5:return(x=M)?[3,7]:[4,O(e.target,t,n)];case 6:x=r.sent(),r.label=7;case 7:return(p=x)?[3,9]:[4,O(e,t,n)];case 8:p=r.sent(),r.label=9;case 9:d=p,r.label=10;case 10:return!d&&i&&i.targetGeometry?d=i.targetGeometry:!d&&t.extent&&(d=t.extent),R=k(d),n||(n=k(t.spatialReference||t.extent||d)),b.canProject(d,n)||!R||R.equals(n)?(S=E(m.vec2f64.create(),d.center?d.center:d),w=new v(_(S,S,R,n),n),A=null,A=g&&g.targetGeometry&&"point"===g.targetGeometry.type?g.scale:e.hasOwnProperty("scale")&&e.scale?e.scale:e.hasOwnProperty("zoom")&&-1!==e.zoom&&c&&c.effectiveLODs?c.zoomToScale(e.zoom):Array.isArray(d)||"point"===d.type||"extent"===d.type&&0===d.width&&0===d.height?t.extent&&h.canProject(t.extent,n)?N(h.project(t.extent,n),f):t.extent?N(t.extent,f):i.scale:h.canProject(d.extent,n)?N(h.project(d.extent,n),f):N(d.extent,f),(G=function(e){if(e&&(!Array.isArray(e)||"number"!=typeof e[0])&&("object"==typeof e||Array.isArray(e)&&"object"==typeof e[0])){if("layer"in e&&e.layer&&e.layer.minScale&&e.layer.maxScale)return{min:(c=e.layer).minScale,max:c.maxScale};if(Array.isArray(e)&&e.length&&e.every((function(e){return"layer"in e}))){for(var t=0,r=0,a=0,n=e;a<n.length;a++){var c;(c=n[a].layer)&&c.minScale&&c.maxScale&&(t=c.minScale<t?c.minScale:t,r=c.maxScale>r?c.maxScale:r)}return t&&r?{min:t,max:r}:null}}}(e))&&(G.min&&G.min>A?A=G.min:G.max&&G.max<A&&(A=G.max)),P=0,g?P=g.rotation:e.hasOwnProperty("rotation")?P=e.rotation:i&&(P=i.rotation),T=new a({targetGeometry:w,scale:A,rotation:P}),c&&(T=c.fit(T),c.constrainByGeometry(T),c.rotationEnabled||(T.rotation=P)),[2,T]):[2,null]}}))}))}function V(e,t){var r=e.targetGeometry,a=t.targetGeometry;return r.x=a.x,r.y=a.y,r.spatialReference=a.spatialReference,e.scale=t.scale,e.rotation=t.rotation,e}function I(e,t,r){return r?f.vec2.set(e,.5*(t[0]-r.right+r.left),.5*(t[1]-r.bottom+r.top)):f.vec2.scale(e,t,.5)}function U(e,t,r){var a=L(t),n=Math.abs(Math.cos(a)),c=Math.abs(Math.sin(a));return f.vec2.set(e,Math.round(r[1]*c+r[0]*n),Math.round(r[1]*n+r[0]*c))}function C(e){return e.scale*(t=e.targetGeometry.spatialReference,x.isValid(t)?1/(39.37*F(t)*96):1);var t}function L(e){return s.common.toRadian(e.rotation)||0}function D(e){return x.isValid(e)?39.37*F(e)*96:1}function Q(e){if(e.isWrappable){var t=x.getInfo(e);return t.valid[1]-t.valid[0]}return 0}t.extentToScale=N,t.create=q,t.copy=V,t.getAnchor=I,t.getExtent=(M=m.vec2f64.create(),function(e,t,r){var a=t.targetGeometry;E(M,a);var n=.5*C(t);return e.xmin=M[0]-n*r[0],e.ymin=M[1]-n*r[1],e.xmax=M[0]+n*r[0],e.ymax=M[1]+n*r[1],e.spatialReference=a.spatialReference,e}),t.setExtent=function(e,r,a,n,c){return t.centerAt(e,r,a.center),e.scale=N(a,n),c&&c.constraints&&c.constraints.constrain(e),e},t.getOuterExtent=(R=m.vec2f64.create(),S=m.vec2f64.create(),function(e,t,r){E(R,t.targetGeometry),U(S,t,r);var a=.5*C(t),n=R[0]-a*S[0],c=R[1]-a*S[1],o=R[0]+a*S[0],i=R[1]+a*S[1],s=t.targetGeometry.spatialReference;return e.set({xmin:n,ymin:c,xmax:o,ymax:i,spatialReference:s}),e}),t.getOuterSize=U,t.getPaddingScreenTranslation=(w=m.vec2f64.create(),function(e,t,r){return f.vec2.sub(e,function(e,t){return f.vec2.scale(e,t,.5)}(e,t),I(w,t,r))}),t.getPaddingMapTranslation=function(){var e=l.mat2df64.create(),r=m.vec2f64.create();return function(a,n,c,o){var i=C(n),s=L(n);return f.vec2.set(r,i,i),u.mat2d.fromScaling(e,r),u.mat2d.rotate(e,e,s),u.mat2d.translate(e,e,t.getPaddingScreenTranslation(r,c,o)),u.mat2d.translate(e,e,[0,o.top-o.bottom]),f.vec2.set(a,e[4],e[5])}}(),t.getResolution=C,t.getResolutionToScaleFactor=D,t.getMatrix=function(){var e=m.vec2f64.create(),t=m.vec2f64.create(),r=m.vec2f64.create();return function(a,n,c,o,i,s){return f.vec2.negate(e,n),f.vec2.scale(t,c,.5*s),f.vec2.set(r,1/o*s,-1/o*s),u.mat2d.identity(a),u.mat2d.translate(a,a,t),i&&u.mat2d.rotate(a,a,i),u.mat2d.scale(a,a,r),u.mat2d.translate(a,a,e),a}}(),t.getTransform=function(){var e=m.vec2f64.create();return function(r,a,n,c){var o=C(a),i=L(a);return E(e,a.targetGeometry),t.getMatrix(r,e,n,o,i,c)}}(),t.getTransformNoRotation=function(){var e=m.vec2f64.create();return function(r,a,n,c){var o=C(a);return E(e,a.targetGeometry),t.getMatrix(r,e,n,o,0,c)}}(),t.getWorldWidth=Q,t.getWorldScreenWidth=function(e,t){return Math.round(Q(e)/t)},t.createAsync=function(e,t){return q(e,t)},t.angleBetween=(A=m.vec2f64.create(),G=m.vec2f64.create(),P=[0,0,0],function(e,t,r){f.vec2.subtract(A,e,t),f.vec2.normalize(A,A),f.vec2.subtract(G,e,r),f.vec2.normalize(G,G),f.vec2.cross(P,A,G);var a=Math.acos(f.vec2.dot(A,G)/(f.vec2.length(A)*f.vec2.length(G)))*W;return P[2]<0&&(a=-a),isNaN(a)&&(a=0),a}),t.addPadding=function(){var e=m.vec2f64.create();return function(r,a,n,c){var o=r.targetGeometry;return V(r,a),t.getPaddingMapTranslation(e,a,n,c),o.x+=e[0],o.y+=e[1],r}}(),t.removePadding=function(){var e=m.vec2f64.create();return function(r,a,n,c){var o=r.targetGeometry;return V(r,a),t.getPaddingMapTranslation(e,a,n,c),o.x-=e[0],o.y-=e[1],r}}(),t.centerAt=function(){var e=m.vec2f64.create();return function(t,r,a){V(t,r);var n=t.targetGeometry,c=k(a),o=k(n);return E(e,a),_(e,e,c,o),n.x=e[0],n.y=e[1],t}}(),t.pixelSize=function(e){return C(e)},t.resize=(T=m.vec2f64.create(),function(e,r,a,n,c){c||(c="center"),f.vec2.sub(T,a,n),f.vec2.scale(T,T,.5);var o=T[0],i=T[1];switch(c){case"center":f.vec2.set(T,0,0);break;case"left":f.vec2.set(T,-o,0);break;case"top":f.vec2.set(T,0,i);break;case"right":f.vec2.set(T,o,0);break;case"bottom":f.vec2.set(T,0,-i);break;case"top-left":f.vec2.set(T,-o,i);break;case"bottom-left":f.vec2.set(T,-o,-i);break;case"top-right":f.vec2.set(T,o,i);break;case"bottom-right":f.vec2.set(T,o,-i)}return t.translateBy(e,r,T),e}),t.rotateBy=function(e,t,r){return V(e,t),e.rotation+=r,e},t.rotateTo=function(e,t,r){return V(e,t),e.rotation=r,e},t.scaleBy=function(){var e=m.vec2f64.create();return function(r,a,n,c,o){return V(r,a),isNaN(n)||0===n||(t.toMap(e,c,a,o),r.scale=a.scale*n,t.toScreen(e,e,r,o),t.translateBy(r,r,f.vec2.set(e,e[0]-c[0],c[1]-e[1]))),r}}(),t.scaleTo=function(e,t,r){return V(e,t),e.scale=r,e},t.scaleAndRotateBy=function(){var e=m.vec2f64.create();return function(r,a,n,c,o,i){return V(r,a),isNaN(n)||0===n||(t.toMap(e,o,a,i),r.scale=a.scale*n,r.rotation+=c,t.toScreen(e,e,r,i),t.translateBy(r,r,f.vec2.set(e,e[0]-o[0],o[1]-e[1]))),r}}(),t.padAndScaleAndRotateBy=(B=m.vec2f64.create(),j=m.vec2f64.create(),function(e,r,a,n,c,o,i){return t.getPaddingScreenTranslation(j,o,i),f.vec2.add(B,c,j),n?t.scaleAndRotateBy(e,r,a,n,B,o):t.scaleBy(e,r,a,B,o)}),t.toMap=(z=l.mat2df64.create(),function(e,r,a,n){return f.vec2.transformMat2d(e,r,function(e,r,a,n){return t.getTransform(e,r,a,n),u.mat2d.invert(e,e)}(z,a,n,1))}),t.toScreen=function(){var e=l.mat2df64.create();return function(r,a,n,c){return f.vec2.transformMat2d(r,a,t.getTransform(e,n,c,1))}}(),t.translateBy=function(){var e=m.vec2f64.create(),t=l.mat2df64.create();return function(r,a,n){V(r,a);var c=C(a),o=r.targetGeometry;return u.mat2d.fromRotation(t,L(a)),u.mat2d.scale(t,t,m.vec2f64.fromValues(c,c)),f.vec2.transformMat2d(e,n,t),o.x+=e[0],o.y+=e[1],r}}()}));