/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../Viewpoint","../../core/Collection","../../core/maybe","../../core/unitUtils","../../chunks/common","../../chunks/mat2d","../../chunks/mat2df64","../../chunks/vec2","../../chunks/vec2f64","../../geometry/Extent","../../geometry/Geometry","../../geometry/Point","../../geometry/projection","../../geometry/SpatialReference","../../geometry/support/spatialReferenceUtils"],(function(e,t,n,r,o,a,c,i,s,u,l,f,y,m,g,p,d){"use strict";const x=96,h=39.37,b=180/Math.PI;function S(e){return e.wkid?e:e.spatialReference||p.WGS84}function R(e,t){return t.type?u.set(e,t.x,t.y):u.copy(e,t)}function G(e){return a.getMetersPerUnitForSR(e)}function w(e,t){return Math.max(e.width/t[0],e.height/t[1])*L(e.spatialReference)}function A(e,t,n,r){return k.apply(this,arguments)}function k(){return(k=t._asyncToGenerator((function*(e,t,n,a){let c,i;if(!e)return null;if(Array.isArray(e)&&!e.length)return null;if(r.isCollection(e)&&(e=e.toArray()),Array.isArray(e)&&e.length&&"object"==typeof e[0]){const r=e.every((e=>"attributes"in e)),c=e.some((e=>!e.geometry));let i=e;if(r&&c&&t&&t.allLayerViews){const n=new Map;for(const t of e){const e=t.layer,r=n.get(e)||[],o=t.attributes[e.objectIdField];null!=o&&r.push(o),n.set(e,r)}const r=[];n.forEach(((e,n)=>{const o=t.allLayerViews.find((e=>e.layer.id===n.id));if("queryFeatures"in o){const t=n.createQuery();t.objectIds=e,t.returnGeometry=!0,r.push(o.queryFeatures(t))}}));const a=yield Promise.all(r),c=[];for(const e of a)if(e&&e.features&&e.features.length)for(const t of e.features)o.isSome(t.geometry)&&c.push(t.geometry);i=c}for(const e of i)a=yield A(e,t,n,a);return a}if(Array.isArray(e)&&2===e.length&&"number"==typeof e[0]&&"number"==typeof e[1])c=new m(e);else if(e instanceof y)c=e;else if("geometry"in e)if(e.geometry)c=e.geometry;else if(e.layer){const n=e.layer,r=t.allLayerViews.find((e=>e.layer.id===n.id));if("queryFeatures"in r){const t=n.createQuery();t.objectIds=[e.attributes[n.objectIdField]],t.returnGeometry=!0;const a=yield r.queryFeatures(t);c=o.get(a,"features",0,"geometry")}}if(o.isNone(c))return null;if(i="point"===c.type?new f({xmin:c.x,ymin:c.y,xmax:c.x,ymax:c.y,spatialReference:c.spatialReference}):c.extent,!i)return null;g.isLoaded()||g.canProjectWithoutEngine(i.spatialReference,n)||(yield g.load());const s=g.project(i,n);return s?a=a?a.union(s):s:null}))).apply(this,arguments)}function M(e){if(e&&(!Array.isArray(e)||"number"!=typeof e[0])&&("object"==typeof e||Array.isArray(e)&&"object"==typeof e[0])){if("layer"in e&&e.layer&&e.layer.minScale&&e.layer.maxScale){const t=e.layer;return{min:t.minScale,max:t.maxScale}}if(Array.isArray(e)&&e.length&&e.every((e=>"layer"in e))){let t=0,n=0;for(const r of e){const e=r.layer;e&&e.minScale&&e.maxScale&&(t=e.minScale<t?e.minScale:t,n=e.maxScale>n?e.maxScale:n)}return t&&n?{min:t,max:n}:null}}}function j(e,t){return d.equals(S(e),t)?e:g.project(e,t)}function v(e,t){return T.apply(this,arguments)}function T(){return(T=t._asyncToGenerator((function*(e,t){if(!e||!t)return new n({targetGeometry:new m,scale:0,rotation:0});let r=t.spatialReference;const{constraints:a,padding:c,viewpoint:i,size:s}=t,u=[c?s[0]-c.left-c.right:s[0],c?s[1]-c.top-c.bottom:s[1]];let l=null;e instanceof n?l=e:e.viewpoint?l=e.viewpoint:e.target&&"esri.Viewpoint"===e.target.declaredClass&&(l=e.target);let y=null;l&&l.targetGeometry?y=l.targetGeometry:e instanceof f?y=e:(e||e&&("center"in e||"extent"in e||"target"in e))&&(y=(yield A(e.center,t,r))||(yield A(e.extent,t,r))||(yield A(e.target,t,r))||(yield A(e,t,r))),!y&&i&&i.targetGeometry?y=i.targetGeometry:!y&&t.extent&&(y=t.extent),r||(r=S(t.spatialReference||t.extent||y)),g.isLoaded()||d.equals(y.spatialReference,r)||g.canProjectWithoutEngine(y,r)||(yield g.load());const p=j(y.center?y.center:y,r);let x=null;if(l&&o.isSome(l.targetGeometry)&&"point"===l.targetGeometry.type)x=l.scale;else if("scale"in e&&e.scale)x=e.scale;else if("zoom"in e&&-1!==e.zoom&&a&&a.effectiveLODs)x=a.zoomToScale(e.zoom);else if(Array.isArray(y)||"point"===y.type||"extent"===y.type&&0===y.width&&0===y.height){const e=j(t.extent,r);x=o.isSome(e)?w(e,u):t.extent?w(t.extent,u):i.scale}else x=w(j(y.extent,r),u);const h=M(e);h&&(h.min&&h.min>x?x=h.min:h.max&&h.max<x&&(x=h.max));let b=0;l?b=l.rotation:e.hasOwnProperty("rotation")?b=e.rotation:i&&(b=i.rotation);let R=new n({targetGeometry:p,scale:x,rotation:b});return a&&(R=a.fit(R),a.constrainByGeometry(R),a.rotationEnabled||(R.rotation=b)),R}))).apply(this,arguments)}function P(e,t){const n=e.targetGeometry,r=t.targetGeometry;return n.x=r.x,n.y=r.y,n.spatialReference=r.spatialReference,e.scale=t.scale,e.rotation=t.rotation,e}function z(e,t,n){return n?u.set(e,.5*(t[0]-n.right+n.left),.5*(t[1]-n.bottom+n.top)):u.scale(e,t,.5)}const F=function(){const e=l.create();return function(t,n,r){const o=n.targetGeometry;R(e,o);const a=.5*E(n);return t.xmin=e[0]-a*r[0],t.ymin=e[1]-a*r[1],t.xmax=e[0]+a*r[0],t.ymax=e[1]+a*r[1],t.spatialReference=o.spatialReference,t}}();function N(e,t,n,r,o){return K(e,t,n.center),e.scale=w(n,r),o&&o.constraints&&o.constraints.constrain(e),e}function V(e,t,n,r){return O(e,t,n,r),i.invert(e,e)}const W=function(){const e=l.create();return function(t,n,r){return u.sub(t,_(t,n),z(e,n,r))}}(),B=function(){const e=s.create(),t=l.create();return function(n,r,o,a){const c=E(r),s=I(r);return u.set(t,c,c),i.fromScaling(e,t),i.rotate(e,e,s),i.translate(e,e,W(t,o,a)),i.translate(e,e,[0,a.top-a.bottom]),u.set(n,e[4],e[5])}}();function E(e){return e.scale*q(e.targetGeometry)}function q(e){return o.isSome(e)&&d.isValid(e.spatialReference)?1/(G(e.spatialReference)*h*x):1}function I(e){return c.toRadian(e.rotation)||0}function L(e){return d.isValid(e)?G(e)*h*x:1}function _(e,t){return u.scale(e,t,.5)}const C=function(){const e=l.create(),t=l.create(),n=l.create();return function(r,o,a,c,s,l){return u.negate(e,o),u.scale(t,a,.5*l),u.set(n,1/c*l,-1/c*l),i.fromTranslation(r,t),s&&i.rotate(r,r,s),i.scale(r,r,n),i.translate(r,r,e),r}}(),O=function(){const e=l.create();return function(t,n,r,o){const a=E(n),c=I(n);return R(e,n.targetGeometry),C(t,e,r,a,c,o)}}(),U=function(){const e=l.create();return function(t,n,r,o){const a=E(n);return R(e,n.targetGeometry),C(t,e,r,a,0,o)}}();function Q(e){if(e.isWrappable){const t=d.getInfo(e);return t.valid[1]-t.valid[0]}return 0}function D(e,t){return Math.round(Q(e)/t)}const H=function(){const e=l.create(),t=l.create(),n=[0,0,0];return function(r,o,a){u.subtract(e,r,o),u.normalize(e,e),u.subtract(t,r,a),u.normalize(t,t),u.cross(n,e,t);let c=Math.acos(u.dot(e,t)/(u.length(e)*u.length(t)))*b;return n[2]<0&&(c=-c),isNaN(c)&&(c=0),c}}(),J=function(){const e=l.create();return function(t,n,r,o){const a=t.targetGeometry;return P(t,n),B(e,n,r,o),a.x+=e[0],a.y+=e[1],t}}(),K=function(e,t,n){P(e,t);const r=e.targetGeometry;return r.x=n.x,r.y=n.y,r.spatialReference=n.spatialReference,e},X=function(){const e=l.create();return function(t,n,r,o,a){a||(a="center"),u.sub(e,r,o),u.scale(e,e,.5);const c=e[0],i=e[1];switch(a){case"center":u.set(e,0,0);break;case"left":u.set(e,-c,0);break;case"top":u.set(e,0,i);break;case"right":u.set(e,c,0);break;case"bottom":u.set(e,0,-i);break;case"top-left":u.set(e,-c,i);break;case"bottom-left":u.set(e,-c,-i);break;case"top-right":u.set(e,c,i);break;case"bottom-right":u.set(e,c,-i)}return ae(t,n,e),t}}();function Y(e,t,n){return P(e,t),e.rotation+=n,e}function Z(e,t,n){return P(e,t),e.rotation=n,e}const $=function(){const e=l.create();return function(t,n,r,o,a){return P(t,n),isNaN(r)||0===r||(re(e,o,n,a),t.scale=n.scale*r,oe(e,e,t,a),ae(t,t,u.set(e,e[0]-o[0],o[1]-e[1]))),t}}();function ee(e,t,n){return P(e,t),e.scale=n,e}const te=function(){const e=l.create();return function(t,n,r,o,a,c){return P(t,n),isNaN(r)||0===r||(re(e,a,n,c),t.scale=n.scale*r,t.rotation+=o,oe(e,e,t,c),ae(t,t,u.set(e,e[0]-a[0],a[1]-e[1]))),t}}(),ne=function(){const e=l.create(),t=l.create();return function(n,r,o,a,c,i,s){return W(t,i,s),u.add(e,c,t),a?te(n,r,o,a,e,i):$(n,r,o,e,i)}}(),re=function(){const e=s.create();return function(t,n,r,o){return u.transformMat2d(t,n,V(e,r,o,1))}}(),oe=function(){const e=s.create();return function(t,n,r,o){return u.transformMat2d(t,n,O(e,r,o,1))}}(),ae=function(){const e=l.create(),t=s.create();return function(n,r,o){P(n,r);const a=E(r),c=n.targetGeometry;return i.fromRotation(t,I(r)),i.scale(t,t,l.fromValues(a,a)),u.transformMat2d(e,o,t),c.x+=e[0],c.y+=e[1],n}}();e.addPadding=J,e.angleBetween=H,e.centerAt=K,e.copy=P,e.create=v,e.extentToScale=w,e.getAnchor=z,e.getExtent=F,e.getMatrix=C,e.getPaddingMapTranslation=B,e.getPaddingScreenTranslation=W,e.getResolution=E,e.getResolutionToScaleFactor=L,e.getTransform=O,e.getTransformNoRotation=U,e.getWorldScreenWidth=D,e.getWorldWidth=Q,e.padAndScaleAndRotateBy=ne,e.resize=X,e.rotateBy=Y,e.rotateTo=Z,e.scaleAndRotateBy=te,e.scaleTo=ee,e.setExtent=N,e.toMap=re,e.toScreen=oe,e.translateBy=ae,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
