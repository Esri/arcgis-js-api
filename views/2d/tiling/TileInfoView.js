// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","./LODInfo","./TileKey","./TileSpan","./TileCoverage"],function(o,e,t,r,n,l){var i=function(){function o(o,e,t,r,n,l,i,s){this.x=o,this.ymin=e,this.ymax=t,this.invM=r,this.leftAdjust=n,this.rightAdjust=l,this.leftBound=i,this.rightBound=s}return o.create=function(e,t){e[1]>t[1]&&(c=[t,e],e=c[0],t=c[1]);var r=e[0],n=e[1],l=t[0],i=t[1],s=l-r,a=i-n,u=0!==a?s/a:0,f=(Math.ceil(n)-n)*u,h=(Math.floor(n)-n)*u;return new o(r,Math.floor(n),Math.ceil(i),u,0>s?f:h,0>s?h:f,0>s?l:r,0>s?r:l);var c},o.prototype.incrRow=function(){this.x+=this.invM},o.prototype.getLeftCol=function(){return Math.max(this.x+this.leftAdjust,this.leftBound)},o.prototype.getRightCol=function(){return Math.min(this.x+this.rightAdjust,this.rightBound)},o}(),s=[[0,0],[0,0],[0,0],[0,0]],a=function(){function o(o,e){var r=this;this.tileInfo=o,this.fullExtent=e,this.scales=[],this._lodInfos=null,this._infoByScale={},this._infoByLevel={};var n=o.lods.slice();n.sort(function(o,e){return e.scale-o.scale});var l=this._lodInfos=n.map(function(r){return t.create(o,r,e)});n.forEach(function(o,e){r._infoByLevel[o.level]=l[e],r._infoByScale[o.scale]=l[e],r.scales[e]=o.scale},this),this._wrap=o.isWrappable}return o.prototype.getTileBounds=function(o,e){var t=this._infoByLevel[e.level];return t?t.getTileBounds(o,e):o},o.prototype.getTileCoords=function(o,e){var t=this._infoByLevel[e.level];return t?t.getTileCoords(o,e):o},o.prototype.getTileCoverage=function(o){var e,t,r,a=this.getClosestInfoForScale(o.scale),u=l.pool.acquire(a),f=this._wrap,h=+(1/0),c=-(1/0),p=u.spans;s[0][0]=s[0][1]=s[1][1]=s[3][0]=0,s[1][0]=s[2][0]=o.size[0],s[2][1]=s[3][1]=o.size[1];for(var v=0,d=s;v<d.length;v++){var g=d[v];o.toMap(g,g),g[0]=a.getColumnForX(g[0]),g[1]=a.getRowForY(g[1])}for(var m=[],y=3,w=0;4>w;w++)if(s[w][1]!==s[y][1]){var M=i.create(s[w],s[y]);h=Math.min(M.ymin,h),c=Math.max(M.ymax,c),void 0===m[M.ymin]&&(m[M.ymin]=[]),m[M.ymin].push(M),y=w}else y=w;if(null==h||null==c||c-h>100)return null;var C=[];for(e=h;c>e;){null!=m[e]&&(C=C.concat(m[e])),t=+(1/0),r=-(1/0);for(var w=C.length-1;w>=0;w--){var M=C[w];t=Math.min(t,M.getLeftCol()),r=Math.max(r,M.getRightCol())}if(t=Math.floor(t),r=Math.floor(r),e>=a.first[1]&&e<=a.last[1])if(f)if(a.size[0]<a.worldSize[0])for(var B=Math.floor(r/a.worldSize[0]),w=Math.floor(t/a.worldSize[0]);B>=w;w++)p.push(new n(e,Math.max(a.getFirstColumnForWorld(w),t),Math.min(a.getLastColumnForWorld(w),r)));else p.push(new n(e,t,r));else t>a.last[0]||r<a.first[0]||(t=Math.max(t,a.first[0]),r=Math.min(r,a.last[0]),p.push(new n(e,t,r)));e+=1;for(var w=C.length-1;w>=0;w--){var M=C[w];M.ymax>=e?M.incrRow():C.splice(w,1)}}return u},o.prototype.getTileIdAtParent=function(o,e){var t=r.pool.acquire(e),n=this._infoByLevel[t.level];if(o.resolution<n.resolution)throw new Error("Cannot calculate parent tile. destination LOD's resolution "+o.resolution+" is not a parent resolution of "+n.resolution);if(o.resolution===n.resolution)return t.id;var l=Math.floor(t.col*n.resolution/o.resolution+.01),i=Math.floor(t.row*n.resolution/o.resolution+.01);return r.getId(o.level,i,l,t.world)},o.prototype.getTileParentId=function(o){var e=r.pool.acquire(o),t=this._infoByLevel[e.level],n=this._lodInfos.indexOf(t)-1;if(0>n)return r.pool.release(e),null;var l=this._lodInfos[n],i=this.getTileIdAtParent(l,e);return r.pool.release(e),i},o.prototype.getTileResolution=function(o){var e=this._infoByLevel[o.level];return e?e.resolution:-1},o.prototype.getTileScale=function(o){var e=this._infoByLevel[o.level];return e?e.scale:-1},o.prototype.intersects=function(o,e){var t=r.pool.acquire(e),n=this._infoByLevel[t.level],l=o.lodInfo;if(l.resolution>n.resolution){var i=r.pool.acquire(this.getTileIdAtParent(l,t)),s=l.denormalizeCol(i.col,i.world),a=o.spans.some(function(o){return o.row===i.row&&o.colFrom<=s&&o.colTo>=s});return r.pool.release(t),r.pool.release(i),a}if(l.resolution<n.resolution){var u=o.spans.reduce(function(o,e){return o[0]=Math.min(o[0],e.row),o[1]=Math.max(o[1],e.row),o[2]=Math.min(o[2],e.colFrom),o[3]=Math.max(o[3],e.colTo),o},[+(1/0),-(1/0),+(1/0),-(1/0)]),f=u[0],h=u[1],c=u[2],p=u[3],v=n.denormalizeCol(t.col,t.world),d=l.getColumnForX(n.getXForColumn(v)),g=l.getRowForY(n.getYForRow(t.row)),m=l.getColumnForX(n.getXForColumn(v+1))-1,y=l.getRowForY(n.getYForRow(t.row+1))-1;return r.pool.release(t),!(d>p||c>m||g>h||f>y)}var w=l.denormalizeCol(t.col,t.world),M=o.spans.some(function(o){return o.row===t.row&&o.colFrom<=w&&o.colTo>=w});return r.pool.release(t),M},o.prototype.getClosestInfoForScale=function(o){var e=this.scales;return this._infoByScale[o]?this._infoByScale[o]:(o=e.reduce(function(e,t,r,n){return Math.abs(t-o)<Math.abs(e-o)?t:e},e[0]),this._infoByScale[o])},o}();return a});