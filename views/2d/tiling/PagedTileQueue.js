/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/has","../../../core/Logger","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass","../../../core/urlUtils","../../../core/uuid","../../../portal/support/resourceExtension","../../../core/Accessor","../../../chunks/vec2","../../support/QueueProcessor"],(function(e,t,r,o,s,n,i,u,c,a,h,l,p){"use strict";const y=new Set,_=[],g=new Map,d=[0,0];let f=function(t){function r(e){var r;return(r=t.call(this,e)||this)._keyToItem=new Map,r.concurrency=6,r.strategy="scale-first",r.tileInfoView=null,r}e._inheritsLoose(r,t);var o=r.prototype;return o.initialize=function(){const{concurrency:e,process:t}=this;this._peekByScaleFirst,this._peekByCenterFirst,this._queue=new p.QueueProcessor({concurrency:e,process:(e,r)=>{const o=this._keyToItem.get(e);return t(o,{signal:r})},peeker:e=>e.values().next().value})},o.destroy=function(){this.clear(),this._queue.destroy(),this._queue=null},o.abort=function(e){const t="string"==typeof e?e:e.id;this._queue.abort(t)},o.clear=function(){this._queue.clear(),this._keyToItem.clear(),this.notifyChange("updating")},o.has=function(e){return"string"==typeof e?this._keyToItem.has(e):this._keyToItem.has(e.id)},o.isOngoing=function(e){const t="string"==typeof e?e:e.id;return this.has(t)&&this._queue.isOngoing(t)},o.pause=function(){this._queue.pause()},o.push=function(e,t){const r=e.key.id+"-"+t;if(this.has(r))return this.get(r);const o=this._queue.push(r),s=()=>{this._keyToItem.delete(r),this.notifyChange("updating")};return this._keyToItem.set(r,e),o.then(s,s),this.notifyChange("updating"),o},o.reset=function(){this._queue.reset(),this.notifyChange("updating")},o.resume=function(){this._queue.resume()},o._peekByScaleFirst=function(e){if(!this.state)return e.values().next().value;const t=this.tileInfoView;let r=Number.NEGATIVE_INFINITY,o=Number.POSITIVE_INFINITY;e.forEach((e=>{const t=this._keyToItem.get(e),s=this.tileInfoView.getTileScale(t.key);g.has(s)||(g.set(s,[]),r=Math.max(s,r),o=Math.min(s,o)),g.get(s).push(t.key),y.add(s)}));let s=this.state.scale;var n,i;g.has(s)||(i=y,(n=_).length=0,i.forEach((e=>n.push(e))),_.sort(),s=_.reduce(((e,t)=>Math.abs(t-s)<Math.abs(e-s)?t:e),_[0])),s=Math.min(s,r),s=Math.max(s,o);const u=g.get(s),c=t.getClosestInfoForScale(s),a=c.getColumnForX(this.state.center[0]),h=c.getRowForY(this.state.center[1]);return u.sort(((e,t)=>{const r=c.denormalizeCol(e.col,e.world),o=c.denormalizeCol(t.col,t.world);return Math.sqrt((a-r)*(a-r)+(h-e.row)*(h-e.row))-Math.sqrt((a-o)*(a-o)+(h-t.row)*(h-t.row))})),y.clear(),g.clear(),u[0].id},o._peekByCenterFirst=function(e){if(!this.state)return e.values().next().value;const t=this.tileInfoView,r=this.state.center;let o=Number.POSITIVE_INFINITY,s=null;return e.forEach((e=>{const n=this._keyToItem.get(e);t.getTileCoords(d,n.key);const i=l.distance(d,r);i<o&&(o=i,s=n.key)})),s.id},e._createClass(r,[{key:"length",get:function(){return this._queue?this._queue.length:0}},{key:"onGoingCount",get:function(){return this._keyToItem.size}},{key:"updating",get:function(){return this.length>0||this.onGoingCount>0}}]),r}(h);return t.__decorate([n.property({constructOnly:!0})],f.prototype,"concurrency",void 0),t.__decorate([n.property({constructOnly:!0})],f.prototype,"process",void 0),t.__decorate([n.property()],f.prototype,"state",void 0),t.__decorate([n.property({constructOnly:!0})],f.prototype,"strategy",void 0),t.__decorate([n.property({constructOnly:!0})],f.prototype,"tileInfoView",void 0),t.__decorate([n.property({readOnly:!0})],f.prototype,"updating",null),f=t.__decorate([i.subclass("esri.views.2d.tiling.PagedTileQueue")],f),f}));
