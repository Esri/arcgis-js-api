/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["./TileKey","./TileCoverage","./TileCache"],(function(e,i,t){"use strict";const s=new e(0,0,0,0),l=new Map,h=[],a=[];return function(){function e(e){this._previousScale=Number.POSITIVE_INFINITY,this.cachePolicy="keep",this.coveragePolicy="closest",this.resampling=!0,this.tileIndex=new Map,this.tiles=[],this.buffer=192,this.acquireTile=e.acquireTile,this.releaseTile=e.releaseTile,this.tileInfoView=e.tileInfoView,this.resampling=null==e.resampling||!!e.resampling,e.cachePolicy&&(this.cachePolicy=e.cachePolicy),e.coveragePolicy&&(this.coveragePolicy=e.coveragePolicy),null!=e.buffer&&(this.buffer=e.buffer),e.cacheSize&&(this._tileCache=new t(e.cacheSize,this.tileInfoView,(e=>{this.releaseTile(e)})))}var c=e.prototype;return c.destroy=function(){this.tileIndex.clear()},c.update=function(e){const{resampling:t,tileIndex:c}=this,o=this.tileInfoView.getTileCoverage(e.state,this.buffer,this.coveragePolicy);if(a.length=0,h.length=0,l.clear(),!o)return;const{minScale:n,maxScale:r}=this.tileInfoView.tileInfo,{spans:f,lodInfo:u}=o,{level:d}=u,{scale:p,center:g,resolution:y}=e.state,I=!e.stationary&&p>this._previousScale;if(this._previousScale=p,this.tiles.length=0,!t&&(p>n||p<r))return this.tiles.length=0,l.clear(),c.forEach((e=>{this.releaseTile(e)})),c.clear(),a.length=0,h.length=0,l.clear(),i.pool.release(o),!0;c.forEach((e=>e.visible=!0));let T=0,_=0;if(f.length>0)for(const{row:e,colFrom:i,colTo:t}of f)for(let h=i;h<=t;h++){T++;const i=s.set(d,e,u.normalizeCol(h),u.getWorldForColumn(h)).id;if(c.has(i)){const e=c.get(i);e.isReady?(l.set(i,e),_++):I||this._addParentTile(i,l)}else{let e;if(this._tileCache&&this._tileCache.has(i)){if(e=this._tileCache.pop(i),this.tileIndex.set(i,e),e.isReady){l.set(i,e),_++;continue}}else e=this.acquireTile(s),this.tileIndex.set(i,e);I||this._addParentTile(i,l)}}const v=_===T;c.forEach(((e,i)=>{if(s.set(i),l.has(i))return;const t=this.tileInfoView.intersects(o,s);if(!t||!I&&v)if("purge"===this.cachePolicy){!(s.level!==d)&&t||h.push(i)}else(s.level>d||!t)&&h.push(i);else e.isReady?a.push(i):s.level>d&&h.push(i)}));for(const e of a){const i=c.get(e);i&&i.isReady&&l.set(e,i)}for(const e of h){const i=c.get(e);this._tileCache?this._tileCache.add(i):this.releaseTile(i),c.delete(e)}return l.forEach((e=>this.tiles.push(e))),c.forEach((e=>{l.has(e.key.id)||(e.visible=!1)})),this._tileCache&&this._tileCache.prune(d,g,y),i.pool.release(o),l.clear(),v},c.clear=function(e=!0){const{tileIndex:i}=this;e&&i.forEach((e=>{this.releaseTile(e)})),i.clear()},c._addParentTile=function(e,i){let t=e,s=null;for(;t=this.tileInfoView.getTileParentId(t),t;)if(this.tileIndex.has(t)){if(s=this.tileIndex.get(t),s&&s.isReady){i.has(s.key.id)||i.set(s.key.id,s);break}}else if(this._tileCache&&this._tileCache.has(t)&&(s=this._tileCache.pop(t),this.tileIndex.set(t,s),s&&s.isReady)){i.has(s.key.id)||i.set(s.key.id,s);break}},e}()}));
