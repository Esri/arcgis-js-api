/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["./TileKey","./TileCoverage","./TileCache"],(function(e,i,t){"use strict";const s=new e(0,0,0,0),l=new Map,a=[],h=[];return function(){function e(e){this._previousScale=Number.POSITIVE_INFINITY,this.cachePolicy="keep",this.coveragePolicy="closest",this.resampling=!0,this.tileIndex=new Map,this.tiles=[],this.buffer=192,this.acquireTile=e.acquireTile,this.releaseTile=e.releaseTile,this.tileInfoView=e.tileInfoView,this.resampling=null==e.resampling||!!e.resampling,e.cachePolicy&&(this.cachePolicy=e.cachePolicy),e.coveragePolicy&&(this.coveragePolicy=e.coveragePolicy),null!=e.buffer&&(this.buffer=e.buffer),e.cacheSize&&(this._tileCache=new t(e.cacheSize,this.tileInfoView,(e=>{this.releaseTile(e)})))}var c=e.prototype;return c.destroy=function(){this.tileIndex.clear()},c.update=function(e){const{resampling:t,tileIndex:c}=this,o=this.tileInfoView.getTileCoverage(e.state,this.buffer,this.coveragePolicy);if(h.length=0,a.length=0,l.clear(),!o)return;const{minScale:n,maxScale:r}=this.tileInfoView.tileInfo,{spans:f,lodInfo:u}=o,{level:d}=u,{scale:p,center:g,resolution:y}=e.state,I=!e.stationary&&p>this._previousScale;if(this._previousScale=p,this.tiles.length=0,!t&&(p>n||p<r))return this.tiles.length=0,l.clear(),c.forEach((e=>{this.releaseTile(e)})),c.clear(),h.length=0,a.length=0,l.clear(),i.pool.release(o),!0;c.forEach((e=>e.visible=!0));let T=0,_=0;if(f.length>0)for(const{row:i,colFrom:a,colTo:h}of f)for(let e=a;e<=h;e++){T++;const t=s.set(d,i,u.normalizeCol(e),u.getWorldForColumn(e)).id;if(c.has(t)){const e=c.get(t);e.isReady?(l.set(t,e),_++):I||this._addParentTile(t,l)}else{let e;if(this._tileCache&&this._tileCache.has(t)){if(e=this._tileCache.pop(t),this.tileIndex.set(t,e),e.isReady){l.set(t,e),_++;continue}}else e=this.acquireTile(s),this.tileIndex.set(t,e);I||this._addParentTile(t,l)}}const C=_===T;c.forEach(((e,i)=>{if(s.set(i),l.has(i))return;const t=this.tileInfoView.intersects(o,s),c="purge"===this.cachePolicy?s.level!==d:s.level>d;!t||!I&&C?!c&&t||a.push(i):e.isReady?h.push(i):c&&a.push(i)}));for(const i of h){const e=c.get(i);e&&e.isReady&&l.set(i,e)}for(const i of a){const e=c.get(i);this._tileCache?this._tileCache.add(e):this.releaseTile(e),c.delete(i)}return l.forEach((e=>this.tiles.push(e))),c.forEach((e=>{l.has(e.key.id)||(e.visible=!1)})),this._tileCache&&this._tileCache.prune(d,g,y),i.pool.release(o),l.clear(),C},c.clear=function(e=!0){const{tileIndex:i}=this;e&&i.forEach((e=>{this.releaseTile(e)})),i.clear()},c.updateCacheSize=function(e){this._tileCache&&(this._tileCache.maxSize=e)},c._addParentTile=function(e,i){let t=e,s=null;for(;t=this.tileInfoView.getTileParentId(t),t;)if(this.tileIndex.has(t)){if(s=this.tileIndex.get(t),s&&s.isReady){i.has(s.key.id)||i.set(s.key.id,s);break}}else if(this._tileCache&&this._tileCache.has(t)&&(s=this._tileCache.pop(t),this.tileIndex.set(t,s),s&&s.isReady)){i.has(s.key.id)||i.set(s.key.id,s);break}},e}()}));
