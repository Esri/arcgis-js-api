/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../core/maybe","./TileKey","./TileCoverage"],(function(e,i,t,l){"use strict";let s=function(){function e(e){this._tiles=new Map,this.buffer=0,this.acquireTile=e.acquireTile,this.releaseTile=e.releaseTile,this.tileInfoView=e.tileInfoView,this.buffer=e.buffer}var s=e.prototype;return s.destroy=function(){},s.clear=function(){this._tiles.forEach((e=>this._releaseTile(e)))},s.tileKeys=function(){const e=[];return this._tiles.forEach(((i,t)=>e.push(t))),e},s.update=function(e){const i=this.tileInfoView.getTileCoverage(e.state,this.buffer,"closest"),{spans:s,lodInfo:r}=i,{level:n}=r,a=[],o=[],d=new Set,h=new Set;for(const{row:e,colFrom:i,colTo:l}of s)for(let s=i;s<=l;s++){const i=t.getId(n,e,r.normalizeCol(s),r.getWorldForColumn(s)),l=this._getOrAcquireTile(a,i);d.add(i),l.isReady?l.visible=!0:h.add(l.key)}h.forEach((e=>this._addPlaceholders(d,e))),this._tiles.forEach((e=>{d.has(e.key.id)||(o.push(e.key.id),this._releaseTile(e))})),l.pool.release(i);return{hasMissingTiles:h.size>0,added:a,removed:o}},s._getOrAcquireTile=function(e,i){if(!this._tiles.has(i)){const l=this.acquireTile(new t(i));e.push(i),this._tiles.set(i,l),l.visible=!1}return this._tiles.get(i)},s._getTile=function(e){return this._tiles.get(e)},s._releaseTile=function(e){this._tiles.delete(e.key.id),this.releaseTile(e)},s._addPlaceholders=function(e,i){const t=this._addPlaceholderChildren(e,i);if(!(Math.abs(1-t)<1e-6)){if(!this._addPlaceholderParent(e,i)){this._getTile(i.id).visible=!0}}},s._addPlaceholderChildren=function(e,i){let t=0;return this._tiles.forEach((l=>{t+=this._addPlaceholderChild(e,l,i)})),t},s._addPlaceholderChild=function(e,i,t){if(i.key.level<=t.level||!i.hasData||!t.contains(i.key))return 0;i.visible=!0,e.add(i.key.id);return 1/(1<<2*(i.key.level-t.level))},s._addPlaceholderParent=function(e,t){let l=t.getParentKey(),s=0,r=null;for(;i.isSome(l);){if(e.has(l.id))return!0;const i=this._getTile(l.id);if(null!=i&&i.isReady)return i.visible=!0,e.add(i.key.id),!0;null!=i&&i.hasData&&i.patchCount>s&&(s=i.patchCount,r=i),l=l.getParentKey()}return!!r&&(r.visible=!0,e.add(r.key.id),!0)},e}();e.TileManager=s,Object.defineProperty(e,"__esModule",{value:!0})}));
