// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.5/esri/copyright.txt for details.

define(["require","exports","dojox/gfx/_base","dojo/_base/lang","dojo/_base/Color","dojo/dom","dojo/dom-attr","./svg","./Surface","../gl-matrix/mat2d"],function(t,e,r,i,o,s,a,n,l,h){Object.defineProperty(e,"__esModule",{value:!0});var u=function(){function t(){this.rawNode=null,this.shape=null,this.matrix=null,this.fillStyle=null,this.strokeStyle=null,this.bbox=null,this.parent=null,this.parentMatrix=null}return t.prototype.destroy=function(){if(this.fillStyle&&"type"in this.fillStyle){var t=this.rawNode.getAttribute("fill"),e=n.getRef(t);e&&e.parentNode.removeChild(e)}this.rawNode&&"__gfxObject__"in this.rawNode&&(this.rawNode.__gfxObject__=null),this.rawNode=null},t.prototype.getNode=function(){return this.rawNode},t.prototype.getShape=function(){return this.shape},t.prototype.getTransform=function(){return this.matrix},t.prototype.getFill=function(){return this.fillStyle},t.prototype.getStroke=function(){return this.strokeStyle},t.prototype.getParent=function(){return this.parent},t.prototype.getBoundingBox=function(){return this.bbox},t.prototype.setTransform=function(t){return this.matrix=this.matrix?h.copy(this.matrix,t):h.clone(t),this._applyTransform()},t.prototype.setFill=function(t){if(!t)return this.fillStyle=null,this.rawNode.setAttribute("fill","none"),this.rawNode.setAttribute("fill-opacity",0),this;var e;if("object"==typeof t&&"type"in t){switch(t.type){case"linear":e=r.makeParameters(r.defaultLinearGradient,t);var i=this._setFillObject(e,"linearGradient");i.setAttribute("x1",e.x1.toFixed(8)),i.setAttribute("y1",e.y1.toFixed(8)),i.setAttribute("x2",e.x2.toFixed(8)),i.setAttribute("y2",e.y2.toFixed(8));break;case"radial":e=r.makeParameters(r.defaultRadialGradient,t);var o=this._setFillObject(e,"radialGradient");o.setAttribute("cx",e.cx.toFixed(8)),o.setAttribute("cy",e.cy.toFixed(8)),o.setAttribute("r",e.r.toFixed(8));break;case"pattern":e=r.makeParameters(r.defaultPattern,t);var s=this._setFillObject(e,"pattern");s.setAttribute("x",e.x.toFixed(8)),s.setAttribute("y",e.y.toFixed(8)),s.setAttribute("width",e.width.toFixed(8)),s.setAttribute("height",e.height.toFixed(8))}return this.fillStyle=e,this}return e=r.normalizeColor(t),this.fillStyle=e,this.rawNode.setAttribute("fill",e.toCss()),this.rawNode.setAttribute("fill-opacity",e.a),this.rawNode.setAttribute("fill-rule","evenodd"),this},t.prototype.setStroke=function(t){var e=this.rawNode;if(!t)return this.strokeStyle=null,e.setAttribute("stroke","none"),e.setAttribute("stroke-opacity",0),this;("string"==typeof t||i.isArray(t)||t instanceof o)&&(t={color:t});var s=this.strokeStyle=r.makeParameters(r.defaultStroke,t);if(s.color=r.normalizeColor(s.color),s){var a=s.width<0?0:s.width;e.setAttribute("stroke",s.color.toCss()),e.setAttribute("stroke-opacity",s.color.a),e.setAttribute("stroke-width",a),e.setAttribute("stroke-linecap",s.cap),"number"==typeof s.join?(e.setAttribute("stroke-linejoin","miter"),e.setAttribute("stroke-miterlimit",s.join)):e.setAttribute("stroke-linejoin",s.join);var l=s.style.toLowerCase();if(l in n.dasharray&&(l=n.dasharray[l]),l instanceof Array){l=i._toArray(l);for(var h=0;h<l.length;++h)l[h]*=a;if("butt"!==s.cap){for(var h=0;h<l.length;h+=2)l[h]-=a,l[h]<1&&(l[h]=1);for(var h=1;h<l.length;h+=2)l[h]+=a}l=l.join(",")}e.setAttribute("stroke-dasharray",l),e.setAttribute("dojoGfxStrokeStyle",s.style)}return this},t.prototype._getParentSurface=function(){for(var t=this.parent;t&&!(t instanceof l["default"]);t=t.parent);return t},t.prototype._setFillObject=function(t,e){var i=n.xmlns.svg;this.fillStyle=t;var o=this._getParentSurface(),s=o.defNode,a=this.rawNode.getAttribute("fill"),l=n.getRef(a);if(l)if(a=l,a.tagName.toLowerCase()!==e.toLowerCase()){var h=a.id;a.parentNode.removeChild(a),a=n._createElementNS(i,e),a.setAttribute("id",h),s.appendChild(a)}else for(;a.childNodes.length;)a.removeChild(a.lastChild);else a=n._createElementNS(i,e),a.setAttribute("id",r._base._getUniqueId()),s.appendChild(a);if("pattern"===e){a.setAttribute("patternUnits","userSpaceOnUse");var u=n._createElementNS(i,"image");u.setAttribute("x",0),u.setAttribute("y",0),u.setAttribute("width",(t.width<0?0:t.width).toFixed(8)),u.setAttribute("height",(t.height<0?0:t.height).toFixed(8)),n._setAttributeNS(u,n.xmlns.xlink,"xlink:href",t.src),a.appendChild(u)}else{a.setAttribute("gradientUnits","userSpaceOnUse");for(var d=0;d<t.colors.length;++d){var p=t.colors[d],f=n._createElementNS(i,"stop"),c=p.color=r.normalizeColor(p.color);f.setAttribute("offset",p.offset.toFixed(8)),f.setAttribute("stop-color",c.toCss()),f.setAttribute("stop-opacity",c.a),a.appendChild(f)}}return this.rawNode.setAttribute("fill","url(#"+a.getAttribute("id")+")"),this.rawNode.removeAttribute("fill-opacity"),this.rawNode.setAttribute("fill-rule","evenodd"),a},t.prototype._applyTransform=function(){var t=this.matrix;return t?this.rawNode.setAttribute("transform","matrix("+t[0].toFixed(8)+","+t[1].toFixed(8)+","+t[2].toFixed(8)+","+t[3].toFixed(8)+","+t[4].toFixed(8)+","+t[5].toFixed(8)+")"):this.rawNode.removeAttribute("transform"),this},t.prototype.setRawNode=function(t){var e=this.rawNode=t;"image"!==this.shape.type&&e.setAttribute("fill","none"),e.setAttribute("fill-opacity",0),e.setAttribute("stroke","none"),e.setAttribute("stroke-opacity",0),e.setAttribute("stroke-width",1),e.setAttribute("stroke-linecap","butt"),e.setAttribute("stroke-linejoin","miter"),e.setAttribute("stroke-miterlimit",4),e.__gfxObject__=this},t.prototype.setShape=function(t){this.shape=r.makeParameters(this.shape,t);for(var e in this.shape)if("type"!==e){var i=this.shape[e];("width"===e||"height"===e)&&(i=0>i?0:i),this.rawNode.setAttribute(e,i)}return this.bbox=null,this},t.prototype._moveToFront=function(){return this.rawNode.parentNode.appendChild(this.rawNode),this},t.prototype._moveToBack=function(){return this.rawNode.parentNode.insertBefore(this.rawNode,this.rawNode.parentNode.firstChild),this},t.prototype._removeClipNode=function(){var t,e=a.get(this.rawNode,"clip-path");return e&&(t=s.byId(e.match(/gfx_clip[\d]+/)[0]),t&&t.parentNode.removeChild(t)),t},t.prototype.moveToFront=function(){var t=this.getParent();return t&&(t._moveChildToFront(this),this._moveToFront()),this},t.prototype.moveToBack=function(){var t=this.getParent();return t&&(t._moveChildToBack(this),this._moveToBack()),this},t.prototype.removeShape=function(t){return this.parent&&this.parent.remove(this,t),this},t.prototype._setParent=function(t,e){return this.parent=t,this._updateParentMatrix(e)},t.prototype._updateParentMatrix=function(t){return this.parentMatrix=t?h.clone(t):null,this._applyTransform()},t.prototype._getRealMatrix=function(){for(var t=h.clone(this.matrix||h.create()),e=this.parent;e;)e.matrix&&t&&h.multiply(t,e.matrix,t),e=e.parent;return t},t}();e["default"]=u});