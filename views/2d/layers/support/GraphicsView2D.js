// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/declareExtendsHelper","../../../../core/tsSupport/decorateHelper","../../../../Graphic","../../../../core/Collection","../../../../core/HandleOwner","../../../../core/Identifiable","../../../../core/MapPool","../../../../core/promiseUtils","../../../../core/accessorSupport/decorators","../../../../geometry/Point","../../../../geometry/Polygon","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/jsonUtils","../../../../geometry/support/spatialReferenceUtils","../../../../layers/graphics/data/projectionSupport","../../engine/webgl/GraphicContainer","../../engine/webgl/TileData","../../engine/webgl/WGLTile","../../engine/webgl/mesh/factories/matcherUtils","../../engine/webgl/mesh/factories/MaterialStore","../../engine/webgl/mesh/factories/WGLMeshFactory","../../engine/webgl/mesh/templates/WGLTemplateStore","../features/support/TileStore","../graphics/GraphicProcessingQueue","../graphics/GraphicStore","../graphics/graphicsUtils","../../../layers/GraphicsView"],function(e,t,i,r,a,s,n,o,h,p,l,c,d,u,g,v,f,_,y,m,S,w,b,G,U,O,I,P,T){Object.defineProperty(t,"__esModule",{value:!0});var R=new c,H=new Set,D=[],x=function(e){function t(){for(var t=[],i=0;i<arguments.length;i++)t[i]=arguments[i];var r=e.apply(this,t)||this;return r._hiddenGraphics=[],r._tiles=new Map,r._graphicStoreUpdate=!1,r._highlightIDs=new Set,r._graphicsSet=new Set,r._matcher=null,r._tileUpdateSet=new Set,r.lastUpdateId=-1,r.updateRequested=!1,r.graphicUpdateHandler=r.graphicUpdateHandler.bind(r),r._addOrUpdateGraphic=r._addOrUpdateGraphic.bind(r),r._processAnalyzedGraphics=r._processAnalyzedGraphics.bind(r),r._graphicsChangeHandler=r._graphicsChangeHandler.bind(r),r}return i(t,e),t.prototype.initialize=function(){var e=this;this._tileStore=new U.default(this.view.featuresTilingScheme),this.container=new _.default({tileInfoView:this.view.featuresTilingScheme,highlightOptions:this.view.highlightOptions,highlightIDs:this._highlightIDs}),this._graphicStore=new I.default(this.view.featuresTilingScheme,this.view.state.scale,this.uid,this.renderer,this.graphics),this._graphicProcessingQueue=new O.default({process:this._addOrUpdateGraphic});var t=new w.default,i=new G.default(this.container.getMaterialItems,devicePixelRatio);this.renderer&&(this._matcher=S.createMatcher(this.renderer,t,i,null)),this._meshFactory=new b.default(null,this.uid,null,null,this.view.state.pixelRatio,this.view.spatialReference,t,i,null,this._tileStore.tileScheme.tileInfo),this.watch("renderer",function(r){e._graphicStore.renderer=r,r&&(e._matcher=S.createMatcher(e.renderer,t,i,null))}),this._tileStore.on("update",this._onTileUpdate.bind(this)),this.view.watch("highlightOptions.color,highlightOptions.fillOpacity,highlightOptions.haloOpacity",function(){e.container.requestRender()}),this.container.on("attach",function(){var t=e.graphics.toArray();t.sort(function(t,i){return e.graphics.indexOf(i)-e.graphics.indexOf(t)});for(var i=0,r=t;i<r.length;i++){var a=r[i];e._add(a)}e.handles.add(e.graphics.on("change",e._graphicsChangeHandler),"graphics")})},t.prototype.destroy=function(){this._graphicStore.clear(),this._tileStore.destroy()},Object.defineProperty(t.prototype,"updating",{get:function(){return this._graphicProcessingQueue.updating||this._tileUpdateSet.size>0},enumerable:!0,configurable:!0}),t.prototype.install=function(e){e.addChild(this.container)},t.prototype.uninstall=function(e){e.removeChild(this.container)},t.prototype.addHighlight=function(e){for(var t=0,i=e;t<i.length;t++){var r=i[t];this._highlightIDs.add(r)}this._buildHLList()},t.prototype.highlight=function(e){var t=this;return t.addHighlight(e),{remove:function(){t.removeHighlight(e)}}},t.prototype.hitTest=function(e,t){if(!this.view||!this.view.position)return p.resolve(null);this.view.toMap(e,t,R);var i=this._graphicStore.hittest(R.x,R.y,2,this.view.state.resolution,this.view.state.rotation);return 0===i.length?p.resolve(null):p.resolve(i[0])},t.prototype.removeHighlight=function(e){for(var t=0,i=e;t<i.length;t++){var r=i[t];this._highlightIDs.delete(r)}this._buildHLList()},t.prototype.setHighlight=function(e){this._highlightIDs.clear(),this.addHighlight(e)},t.prototype.update=function(e){var t=e.state,i=this.view.featuresTilingScheme.getClosestInfoForScale(t.scale).level;this._graphicStore.updateLevel(i),this._tileStore.setViewState(t),this._graphicStoreUpdate=!0,this.updateRequested=!1},t.prototype.viewChange=function(){this.requestUpdate()},t.prototype.requestUpdate=function(){this.updateRequested||(this.updateRequested=!0,this.view.requestUpdate(this))},t.prototype.processUpdate=function(e){this.updateRequested&&(this.updateRequested=!1,this.update(e))},t.prototype.graphicUpdateHandler=function(e){var t=e.graphic,i=e.property,r=e.newValue;switch(i){case"attributes":break;case"geometry":case"symbol":this._graphicProcessingQueue.push(t,"update");break;case"visible":this._setVisible(t.uid,r)}},t.prototype._graphicsChangeHandler=function(e){if(!this._graphicStoreUpdate){var t=this.view.state,i=this.view.featuresTilingScheme.getClosestInfoForScale(t.scale).level;this._graphicStore.updateLevel(i),this._tileStore.setViewState(t)}for(var r=e.added,a=e.removed,s=e.moved,n=0,o=a;n<o.length;n++){var h=o[n];this._remove(h)}for(var p=0,l=r;p<l.length;p++){var c=l[p];this._add(c)}for(var d=0,u=s;d<u.length;d++){var g=u[d];this._reorder(g)}},t.prototype._buildHLList=function(){for(var e=0,t=this.container.children;e<t.length;e++){t[e].buildHLList(this._highlightIDs)}this.container.requestRender()},t.prototype._getSymbolResources=function(e){var t=e.symbol;if(!t&&this.renderer&&(t=this.renderer.getSymbol(e,{scale:this.view.scale})),!t||t&&"text"!==t.type)return p.resolve(null);H.clear();for(var i=t,r=i.text,a=0;a<r.length;a++)H.add(r.charCodeAt(a));D.length=0,H.forEach(function(e){return D.push(e)});var s=[];return s.push({symbol:i.toJSON(),id:0,glyphIds:D}),this.container.getMaterialItems(s).then(function(e){return e.length>0?e[0].mosaicItem:null})},t.prototype._projectAndNormalizeGeometry=function(e){var t=this;if(!e.geometry)return p.resolve(null);var i=e.geometry;if(g.isPolygon(i)){var r=i.rings;i.rings=r}else if(g.isPolyline(i)){var a=i.paths;i.paths=a}else g.isExtent(i)&&(i=d.fromExtent(i));return f.checkProjectionSupport(i.spatialReference,this.view.spatialReference).then(function(){return P.normalizeCentralMeridian(i)}).then(function(e){return f.project(e.toJSON(),e.spatialReference,t.view.spatialReference)}).then(function(e){return P.ensureClosedRings(e),e})},t.prototype._onTileUpdate=function(e){var t=this,i=v.getInfo(this.view.spatialReference);if(e.added&&e.added.length>0)for(var r=this,a=0,s=e.added;a<s.length;a++){var n=s[a];!function(e){var a=r._graphicStore.queryTileData(e);if(i)for(var s=Math.round((i.valid[1]-i.valid[0])/e.resolution),n=0,o=a;n<o.length;n++){var h=o[n];h.geometry&&g.isPoint(h.geometry)&&r._wrapPoints(h,s)}r._tileUpdateSet.add(e.key),r.notifyChange("updating"),r._processGraphics(e.key,a).then(function(i){t._addTile(e.key,i),t._tileUpdateSet.delete(e.key),t.notifyChange("updating")}).catch(function(){t._tileUpdateSet.delete(e.key),t.notifyChange("updating")})}(n)}if(e.removed&&e.removed.length>0)for(var o=0,h=e.removed;o<h.length;o++){var p=h[o];this._removeTile(p.key)}},t.prototype._add=function(e){this.container.attached&&(this._graphicsSet.add(e),this._graphicProcessingQueue.has(e)&&this._graphicProcessingQueue.cancel(e),this._graphicProcessingQueue.push(e,"add"))},t.prototype._addOrUpdateGraphic=function(e,t){var i=this;return this._projectAndNormalizeGeometry(e).then(function(r){return i._getSymbolResources(e).then(function(a){return"add"===t?i._addProjectedGraphic(e,a,r):i._updateGraphic(e,a,r)})})},t.prototype._addProjectedGraphic=function(e,t,i){var r=this;if(!this._graphicsSet.has(e))return p.resolve();var a=this._graphicStore.add(e,t,i);if(!a||0===u.width(a)&&0===u.height(a))return p.resolve();e.visible||this._hiddenGraphics.push(e.uid);for(var s=[],n=this._tileStore.boundsIntersections(a),o=this,h=0,l=n;h<l.length;h++){var c=l[h];!function(t){var i=o._getGraphicData(t,e),a=o._processGraphics(t.key,i).then(function(e){r._patchTile(t.key,{addOrUpdate:e,remove:null})});s.push(a)}(c)}return p.all(s)},t.prototype._remove=function(e){this._graphicsSet.has(e)&&this._graphicsSet.delete(e),this._graphicProcessingQueue.has(e)&&this._graphicProcessingQueue.cancel(e);var t=this._graphicStore.getBounds(e);if(t){this._graphicStore.remove(e);for(var i=this._tileStore.boundsIntersections(t),r=0,a=i;r<a.length;r++){var s=a[r];this._patchTile(s.key,{addOrUpdate:null,remove:[e.uid]})}}},t.prototype._reorder=function(e){var t=this;this._graphicStore.reorder(e);var i=this._graphicStore.getBounds(e);if(0===u.width(i)&&0===u.height(i))return p.resolve();for(var r=this._tileStore.boundsIntersections(i),a=[],s=this,n=0,o=r;n<o.length;n++){var h=o[n];!function(i){var r=s._getGraphicData(i,e),n=s._processGraphics(i.key,r).then(function(e){t._patchTile(i.key,{addOrUpdate:e,remove:[]})});a.push(n)}(h)}return p.all(a)},t.prototype._updateGraphic=function(e,t,i){var r=this;if(!this._graphicStore.has(e))return p.resolve();for(var a=this._graphicStore.update(e,t,i),s=a.oldBounds,n=a.newBounds,o=0===u.width(s)&&0===u.height(s),l=0===u.width(n)&&0===u.height(n),c=o?[]:this._tileStore.boundsIntersections(s),d=l?[]:this._tileStore.boundsIntersections(n),g=h.acquire(),v=0,f=c;v<f.length;v++){var _=f[v];g.set(_.key,{addOrUpdate:null,remove:[e.uid]})}for(var y=0,m=d;y<m.length;y++){var _=m[y],S=this._getGraphicData(_,e);if(g.has(_.key)){var w=g.get(_.key);w.remove.length=0,w.addOrUpdate=S}else g.set(_.key,{addOrUpdate:S,remove:null})}var b=[];return g.forEach(function(e,t){var i=r._processGraphics(t,e.addOrUpdate).then(function(i){r._patchTile(t,{addOrUpdate:i,remove:e.remove})});b.push(i)}),h.release(g),p.all(b)},t.prototype._addTile=function(e,t){var i=u.create();this.view.featuresTilingScheme.getTileBounds(i,e);var r=new m(e,i,!0),a={clear:!0,addOrUpdate:t,remove:[]};r.setData(a,!1,!1),r.buildHLList(this._highlightIDs),this._hiddenGraphics.length>0&&r.setVisibility([],this._hiddenGraphics),this._tiles.set(e,r),this.container.addChild(r)},t.prototype._removeTile=function(e){if(this._tiles.has(e)){var t=this._tiles.get(e);this.container.removeChild(t)}},t.prototype._patchTile=function(e,t){if(this._tiles.has(e)){var i=this._tiles.get(e);i.setData(t,!1,!1),i.buildHLList(this._highlightIDs),this._hiddenGraphics.length>0&&i.setVisibility([],this._hiddenGraphics),this.container.requestRender()}},t.prototype._setVisible=function(e,t){var i=[],r=[],a=this._hiddenGraphics.indexOf(e);if(t){if(-1===a)return;this._hiddenGraphics.splice(a,1),i.push(e)}else{if(-1!==a)return;this._hiddenGraphics.push(e),r.push(e)}for(var s=this.container.children,n=0,o=s;n<o.length;n++){var h=o[n];h.data&&h.setVisibility(i,r)}},t.prototype._getGraphicData=function(e,t){var i=this._graphicStore.getGraphicData(e,t),r=[i],a=v.getInfo(this.view.spatialReference);if(a){var s=Math.round((a.valid[1]-a.valid[0])/e.resolution);i.geometry&&g.isPoint(i.geometry)&&this._wrapPoints(i,s)}return r},t.prototype._wrapPoints=function(e,t){var i=e.geometry;512===t?i.x<20?e.geometry={points:[[i.x,i.y],[t,0]]}:i.x>492&&(e.geometry={points:[[i.x,i.y],[-t,0]]}):i.x<-20?e.geometry={points:[[i.x,i.y],[t,0]]}:i.x>532&&(e.geometry={points:[[i.x,i.y],[-t,0]]})},t.prototype._processGraphics=function(e,t){var i=this;return t&&t.length&&this._meshFactory?this._meshFactory.analyze(t,this._matcher).then(function(t){return i._processAnalyzedGraphics(e,t)}):p.resolve(null)},t.prototype._processAnalyzedGraphics=function(e,t){for(var i=this._meshFactory,r=i.createMeshData(t.length),a=0,s=t;a<s.length;a++){var n=s[a];i.write(r,n,null,null,e.level)}return y.fromMeshData(r)},r([l.property()],t.prototype,"_graphicProcessingQueue",void 0),r([l.property(),l.cast(s.ofType(a))],t.prototype,"graphics",void 0),r([l.property({dependsOn:["_graphicProcessingQueue.updating"]})],t.prototype,"updating",null),r([l.property()],t.prototype,"view",void 0),r([l.property()],t.prototype,"updateRequested",void 0),t=r([l.subclass("esri.views.2d.layers.support.GraphicsView2D")],t)}(l.declared(T,n,o.Identifiable));t.default=x});