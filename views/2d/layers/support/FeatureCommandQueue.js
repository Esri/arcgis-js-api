/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/accessorSupport/decorators/subclass","../../../support/QueueProcessor"],(function(e,t,r,s,o,n,i,c){"use strict";function a(e){return e.some((e=>e.globalId))}function u(e){return e.filter((e=>!e.error)).map((e=>e.objectId??e.globalId)).filter((e=>null!=e))}function d(e,t){const r=new Set(e);for(const s of t.values())r.add(s);return r}function p(e,t){const r=new Set(e);for(const s of t.values())r.delete(s);return r}let l=function(t){function r(e){var r;return(r=t.call(this,e)||this)._hasGlobalIds=!1,r._notifyUpdating=()=>{r.notifyChange("updating")},r}e._inheritsLoose(r,t);var s=r.prototype;return s.normalizeCtorArgs=function(e){return this._queueProcessor=new c.QueueProcessor({concurrency:1,process:e.process}),{}},s.destroy=function(){this.clear()},s.clear=function(){this._queueProcessor.clear()},s.push=function(e){const t=this._queueProcessor,r=t.last();switch(e.type){case"update":case"refresh":if(r?.type===e.type)return;t.push(e).then(this._notifyUpdating,this._notifyUpdating);break;case"edit":{const s="processed-edit"===r?.type?r:null;s&&t.popLast();const o=this._mergeEdits(s,e);for(const e of o)e&&t.push(e).then(this._notifyUpdating,this._notifyUpdating);break}}this.notifyChange("updating")},s._mergeEdits=function(e,t){const{addedFeatures:r,deletedFeatures:s,updatedFeatures:o}=t.edits;if(this._hasGlobalIds=this._hasGlobalIds||a(r)||a(o)||a(s),this._hasGlobalIds){return[e,{type:"processed-edit",edits:{addOrModified:[...r,...o],removed:s}}]}const n=new Set(u(e?.edits.addOrModified??[])),i=new Set(u(e?.edits.removed??[])),c=new Set([...u(r),...u(o)]),l=new Set(u(s));return[{type:"processed-edit",edits:{addOrModified:Array.from(d(p(n,l),c)).map((e=>({objectId:e}))),removed:Array.from(d(p(i,c),l)).map((e=>({objectId:e})))}}]},e._createClass(r,[{key:"updating",get:function(){return this._queueProcessor.length>0}}]),r}(r);t.__decorate([s.property({readOnly:!0})],l.prototype,"updating",null),t.__decorate([s.property()],l.prototype,"process",void 0),l=t.__decorate([i.subclass("esri.views.2d.layers.support.FeatureCommandQueue")],l);return l}));
