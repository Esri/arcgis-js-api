/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/accessorSupport/ensureType","../../../../core/Logger","../../../../core/accessorSupport/decorators/subclass","../../../support/QueueProcessor"],(function(e,r,t,s,o,n,u,c,a){"use strict";function d(e){return e.some((e=>e.globalId))}function i(e){return e.filter((e=>!e.error)).map((e=>{var r;return null!=(r=e.objectId)?r:e.globalId}))}function l(e,r){const t=new Set(e);for(const s of r.values())t.add(s);return t}function p(e,r){const t=new Set(e);for(const s of r.values())t.delete(s);return t}let f=function(r){function t(e){var t;return(t=r.call(this)||this)._hasGlobalIds=!1,t._queueProcessor=new a.QueueProcessor({concurrency:1,process:e.process}),t}e._inheritsLoose(t,r);var s=t.prototype;return s.destroy=function(){this._queueProcessor.clear()},s.push=function(e){const r=this._queueProcessor,t=r.last();switch(e.type){case"update":case"refresh":if((null==t?void 0:t.type)===e.type)return;r.push(e).finally((()=>this.notifyChange("updating")));break;case"edit":{const s="processed-edit"===(null==t?void 0:t.type)?t:null;s&&r.popLast();const o=this._mergeEdits(s,e);for(const e of o)r.push(e).finally((()=>this.notifyChange("updating")));break}}this.notifyChange("updating")},s._mergeEdits=function(e,r){var t,s;const{addedFeatures:o,deletedFeatures:n,updatedFeatures:u}=r.edits;if(this._hasGlobalIds=this._hasGlobalIds||d(o)||d(u)||d(n),this._hasGlobalIds){return[e,{type:"processed-edit",edits:{addOrModified:[...o,...u],removed:n}}]}const c=new Set(i(null!=(t=null==e?void 0:e.edits.addOrModified)?t:[])),a=new Set(i(null!=(s=null==e?void 0:e.edits.removed)?s:[])),f=new Set([...i(o),...i(u)]),h=new Set(i(n));return[{type:"processed-edit",edits:{addOrModified:Array.from(l(p(c,h),f)).map((e=>({objectId:e}))),removed:Array.from(l(p(a,f),h)).map((e=>({objectId:e})))}}]},e._createClass(t,[{key:"updating",get:function(){return this._queueProcessor.length>0}}]),t}(t);return r.__decorate([s.property({readOnly:!0})],f.prototype,"updating",null),f=r.__decorate([c.subclass("esri.views.2d.layers.support.FeatureCommandQueue")],f),f}));
