/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/has","../../../../core/Logger","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/decorators/subclass","../../../../core/urlUtils","../../../../core/uuid","../../../../portal/support/resourceExtension","../../../../core/promiseUtils","../../../../core/Accessor","../../../../geometry/support/spatialReferenceUtils","../../../../geometry/Extent","../../../../geometry/support/aaBoundingRect","../../../../layers/support/TileInfo","../../tiling/TileKey","../../tiling/TileInfoView","../../viewStateUtils","../../engine/Bitmap"],(function(e,t,o,r,i,a,n,p,s,c,l,u,d,g,m,h,_,y,f,x){"use strict";const v=m.create(),S=[0,0],R=new _(0,0,0,0),M=2048,w=2048,E=!1,P=!1,z=!1;let B=function(t){function o(e){var o;return(o=t.call(this,e)||this)._imagePromise=null,o.hidpi=z,o.imageMaxWidth=M,o.imageMaxHeight=w,o.imageRotationSupported=E,o.imageNormalizationSupported=P,o.update=l.debounce((async(e,t)=>{const r=e.state,i=d.getInfo(r.spatialReference),a=o.hidpi?e.pixelRatio:1;if(!e.stationary||o.destroyed)return;o.imageRotationSupported?(S[0]=r.size[0],S[1]=r.size[1]):f.getOuterSize(S,r);const n=Math.floor(S[0]*a)>o.imageMaxWidth||Math.floor(S[1]*a)>o.imageMaxHeight,p=i&&(r.extent.xmin<i.valid[0]||r.extent.xmax>i.valid[1]),s=!o.imageNormalizationSupported&&p,c=!n&&!s,l=o.imageRotationSupported?r.rotation:0;if(c)o._imagePromise=o._singleExport(r,S,l,a,t);else{let e=Math.min(o.imageMaxWidth,o.imageMaxHeight);s&&(e=Math.min(r.worldScreenWidth,e)),o._imagePromise=o._tiledExport(r,e,l,a,t)}return o._imagePromise.then((async e=>{o._imagePromise=null,await Promise.all(e.map((e=>(o.container.addChild(e),e.fadeIn()))));for(const t of o.container.children)e.includes(t)||t.fadeOut().then((()=>{o.container.removeChild(t)}))})).catch((e=>{throw o._imagePromise=null,e}))}),5e3),o}e._inheritsLoose(o,t);var r=o.prototype;return r.destroy=function(){},r.updateExports=function(e){for(const t of this.container.children){if(!t.visible||!t.stage)return;e(t)?console.error("ExportStrategy.updateExports doesn't support promise yet"):(t.invalidateTexture(),t.requestRender())}},r._export=function(e,t,o,r,i,a){return l.resolve().then((()=>this.fetchSource(e,Math.floor(t*i),Math.floor(o*i),{rotation:r,pixelRatio:i,signal:a}))).then((o=>{const a=new x.Bitmap(o);return a.x=e.xmin,a.y=e.ymax,a.resolution=e.width/t,a.rotation=r,a.pixelRatio=i,a}))},r._singleExport=function(e,t,o,r,i){f.getBBox(v,e.center,e.resolution,t);const a=new g(v[0],v[1],v[2],v[3],e.spatialReference);return this._export(a,t[0],t[1],o,r,i).then((e=>[e]))},r._tiledExport=function(e,t,o,r,i){const a=h.create({size:t,spatialReference:e.spatialReference,scales:[e.scale]}),n=new y(a),p=n.getTileCoverage(e);if(!p)return null;const s=[];return p.forEach(((a,p,c,l)=>{R.set(a,p,c,l),n.getTileBounds(v,R);const u=new g(v[0],v[1],v[2],v[3],e.spatialReference);s.push(this._export(u,t,t,o,r,i))})),l.all(s)},e._createClass(o,[{key:"updating",get:function(){return null!==this._imagePromise}}]),o}(u);return t.__decorate([a.property()],B.prototype,"_imagePromise",void 0),t.__decorate([a.property()],B.prototype,"container",void 0),t.__decorate([a.property()],B.prototype,"fetchSource",void 0),t.__decorate([a.property()],B.prototype,"hidpi",void 0),t.__decorate([a.property()],B.prototype,"imageMaxWidth",void 0),t.__decorate([a.property()],B.prototype,"imageMaxHeight",void 0),t.__decorate([a.property()],B.prototype,"imageRotationSupported",void 0),t.__decorate([a.property()],B.prototype,"imageNormalizationSupported",void 0),t.__decorate([a.property()],B.prototype,"requestUpdate",void 0),t.__decorate([a.property({dependsOn:["_imagePromise"]})],B.prototype,"updating",null),B=t.__decorate([n.subclass("esri.views.2d.layers.support.ExportStrategy")],B),B}));
