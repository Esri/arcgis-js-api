/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/has","../../../../core/Logger","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/decorators/subclass","../../../../core/urlUtils","../../../../core/uuid","../../../../portal/support/resourceExtension","../../../../core/promiseUtils","../../../../core/Accessor","../../../../geometry/support/spatialReferenceUtils","../../../../geometry/Extent","../../../../geometry/support/aaBoundingRect","../../../../layers/support/TileInfo","../../tiling/TileKey","../../tiling/TileInfoView","../../viewStateUtils","../../engine/Bitmap"],(function(e,t,o,r,i,a,n,p,s,c,l,u,d,g,m,h,y,f,_,x){"use strict";const S=m.create(),v=[0,0],M=new y(0,0,0,0),R={container:null,fetchSource:null,requestUpdate:null,imageMaxWidth:2048,imageMaxHeight:2048,imageRotationSupported:!1,imageNormalizationSupported:!1,hidpi:!1};let w=function(t){function o(e){var o;return(o=t.call(this,e)||this)._imagePromise=null,o.hidpi=R.hidpi,o.imageMaxWidth=R.imageMaxWidth,o.imageMaxHeight=R.imageMaxHeight,o.imageRotationSupported=R.imageRotationSupported,o.imageNormalizationSupported=R.imageNormalizationSupported,o.update=l.debounce((async(e,t)=>{const r=e.state,i=d.getInfo(r.spatialReference),a=o.hidpi?e.pixelRatio:1;if(!e.stationary||o.destroyed)return null;o.imageRotationSupported?(v[0]=r.size[0],v[1]=r.size[1]):_.getOuterSize(v,r);const n=Math.floor(v[0]*a)>o.imageMaxWidth||Math.floor(v[1]*a)>o.imageMaxHeight,p=i&&(r.extent.xmin<i.valid[0]||r.extent.xmax>i.valid[1]),s=!o.imageNormalizationSupported&&p,c=!n&&!s,l=o.imageRotationSupported?r.rotation:0;if(c)o._imagePromise=o._singleExport(r,v,l,a,t);else{let e=Math.min(o.imageMaxWidth,o.imageMaxHeight);s&&(e=Math.min(r.worldScreenWidth,e)),o._imagePromise=o._tiledExport(r,e,l,a,t)}return o._imagePromise.then((async e=>{if(o._imagePromise=null,!o.destroyed){for(const t of o.container.children)e.includes(t)||t.fadeOut().then((()=>{t.remove()}));for(const t of e)o.container.addChild(t),t.fadeIn()}})).catch((e=>{throw o._imagePromise=null,e}))}),5e3),o}e._inheritsLoose(o,t);var r=o.prototype;return r.destroy=function(){},r.updateExports=function(e){for(const t of this.container.children){if(!t.visible||!t.stage)return;e(t)?console.error("ExportStrategy.updateExports doesn't support promise yet"):(t.invalidateTexture(),t.requestRender())}},r._export=function(e,t,o,r,i,a){return Promise.resolve().then((()=>this.fetchSource(e,Math.floor(t*i),Math.floor(o*i),{rotation:r,pixelRatio:i,signal:a}))).then((o=>{const a=new x.Bitmap(o,"additive");return a.x=e.xmin,a.y=e.ymax,a.resolution=e.width/t,a.rotation=r,a.pixelRatio=i,a}))},r._singleExport=function(e,t,o,r,i){_.getBBox(S,e.center,e.resolution,t);const a=new g(S[0],S[1],S[2],S[3],e.spatialReference);return this._export(a,t[0],t[1],o,r,i).then((e=>[e]))},r._tiledExport=function(e,t,o,r,i){const a=h.create({size:t,spatialReference:e.spatialReference,scales:[e.scale]}),n=new f(a),p=n.getTileCoverage(e);if(!p)return null;const s=[];return p.forEach(((a,p,c,l)=>{M.set(a,p,c,l),n.getTileBounds(S,M);const u=new g(S[0],S[1],S[2],S[3],e.spatialReference);s.push(this._export(u,t,t,o,r,i))})),Promise.all(s)},e._createClass(o,[{key:"updating",get:function(){return null!==this._imagePromise}}]),o}(u);return t.__decorate([a.property()],w.prototype,"_imagePromise",void 0),t.__decorate([a.property()],w.prototype,"container",void 0),t.__decorate([a.property()],w.prototype,"fetchSource",void 0),t.__decorate([a.property()],w.prototype,"hidpi",void 0),t.__decorate([a.property()],w.prototype,"imageMaxWidth",void 0),t.__decorate([a.property()],w.prototype,"imageMaxHeight",void 0),t.__decorate([a.property()],w.prototype,"imageRotationSupported",void 0),t.__decorate([a.property()],w.prototype,"imageNormalizationSupported",void 0),t.__decorate([a.property()],w.prototype,"requestUpdate",void 0),t.__decorate([a.property()],w.prototype,"updating",null),w=t.__decorate([n.subclass("esri.views.2d.layers.support.ExportStrategy")],w),w}));
