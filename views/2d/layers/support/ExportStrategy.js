/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/has","../../../../core/promiseUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/accessorSupport/decorators/subclass","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/spatialReferenceUtils","../../../../layers/support/TileInfo","../../viewStateUtils","../../engine/Bitmap","../../tiling/TileInfoView","../../tiling/TileKey"],(function(e,t,o,r,i,a,n,s,p,c,d,l,u,m,h,g){"use strict";const y=c.create(),f=[0,0],_=new g(0,0,0,0),x={container:null,fetchSource:null,requestUpdate:null,imageMaxWidth:2048,imageMaxHeight:2048,imageRotationSupported:!1,imageNormalizationSupported:!1,hidpi:!1};let S=function(t){function o(o){var r;return(r=t.call(this,o)||this)._imagePromise=null,r.bitmaps=[],r.hidpi=x.hidpi,r.imageMaxWidth=x.imageMaxWidth,r.imageMaxHeight=x.imageMaxHeight,r.imageRotationSupported=x.imageRotationSupported,r.imageNormalizationSupported=x.imageNormalizationSupported,r.update=i.debounce(function(){var t=e._asyncToGenerator((function*(e,t){if(i.throwIfAborted(t),!e.stationary||r.destroyed)return;const o=e.state,a=d.getInfo(o.spatialReference),n=r.hidpi?e.pixelRatio:1,s=r.imageNormalizationSupported&&o.worldScreenWidth&&o.worldScreenWidth<o.size[0],p=r.imageMaxWidth??0,c=r.imageMaxHeight??0;s?(f[0]=o.worldScreenWidth,f[1]=o.size[1]):r.imageRotationSupported?(f[0]=o.size[0],f[1]=o.size[1]):u.getOuterSize(f,o);const l=Math.floor(f[0]*n)>p||Math.floor(f[1]*n)>c,m=a&&(o.extent.xmin<a.valid[0]||o.extent.xmax>a.valid[1]),h=!r.imageNormalizationSupported&&m,g=!l&&!h,y=r.imageRotationSupported?o.rotation:0,_=r.container.children.slice();if(g){const e=s?o.paddedViewState.center:o.center;r._imagePromise&&console.error("Image promise was not defined!"),r._imagePromise=r._singleExport(o,f,e,o.resolution,y,n,t)}else{let e=Math.min(p,c);h&&(e=Math.min(o.worldScreenWidth,e)),r._imagePromise=r._tiledExport(o,e,n,t)}try{const e=(yield r._imagePromise)??[];i.throwIfAborted(t);const o=[];if(r._imagePromise=null,r.destroyed)return;r.bitmaps=e;for(const t of _)e.includes(t)||o.push(t.fadeOut().then((()=>{t.remove(),t.destroy()})));for(const t of e)o.push(t.fadeIn());yield Promise.all(o)}catch(x){r._imagePromise=null,i.throwIfAbortError(x)}}));return function(e,o){return t.apply(this,arguments)}}(),5e3),r.updateExports=i.debounce(function(){var t=e._asyncToGenerator((function*(e){const t=[];for(const o of r.container.children){if(!o.visible||!o.stage)return;t.push(e(o).then((()=>{o.invalidateTexture(),o.requestRender()})))}r._imagePromise=i.eachAlways(t).then((()=>r._imagePromise=null)),yield r._imagePromise}));return function(e){return t.apply(this,arguments)}}()),r}e._inheritsLoose(o,t);var r=o.prototype;return r.destroy=function(){this.bitmaps.forEach((e=>e.destroy())),this.bitmaps=[]},r._export=function(){var t=e._asyncToGenerator((function*(e,t,o,r,a,n){const s=yield this.fetchSource(e,Math.floor(t*a),Math.floor(o*a),{rotation:r,pixelRatio:a,signal:n});i.throwIfAborted(n);const p=new m.Bitmap(null,{immutable:!0,requestRenderOnSourceChangedEnabled:!0});return p.x=e.xmin,p.y=e.ymax,p.resolution=e.width/t,p.rotation=r,p.pixelRatio=a,p.opacity=0,this.container.addChild(p),yield p.setSourceAsync(s,n),i.throwIfAborted(n),p}));function o(e,o,r,i,a,n){return t.apply(this,arguments)}return o}(),r._singleExport=function(){var t=e._asyncToGenerator((function*(e,t,o,r,i,a,n){u.getBBox(y,o,r,t);const s=c.toExtent(y,e.spatialReference);return[yield this._export(s,t[0],t[1],i,a,n)]}));function o(e,o,r,i,a,n,s){return t.apply(this,arguments)}return o}(),r._tiledExport=function(e,t,o,r){const i=l.create({size:t,spatialReference:e.spatialReference,scales:[e.scale]}),a=new h(i),n=a.getTileCoverage(e);if(!n)return null;const s=[];return n.forEach(((i,n,p,d)=>{_.set(i,n,p,0),a.getTileBounds(y,_);const l=c.toExtent(y,e.spatialReference);s.push(this._export(l,t,t,0,o,r).then((e=>(0!==d&&(_.set(i,n,p,d),a.getTileBounds(y,_),e.x=y[0],e.y=y[3]),e))))})),Promise.all(s)},e._createClass(o,[{key:"updating",get:function(){return!this.destroyed&&null!==this._imagePromise}}]),o}(o);t.__decorate([a.property()],S.prototype,"_imagePromise",void 0),t.__decorate([a.property()],S.prototype,"bitmaps",void 0),t.__decorate([a.property()],S.prototype,"container",void 0),t.__decorate([a.property()],S.prototype,"fetchSource",void 0),t.__decorate([a.property()],S.prototype,"hidpi",void 0),t.__decorate([a.property()],S.prototype,"imageMaxWidth",void 0),t.__decorate([a.property()],S.prototype,"imageMaxHeight",void 0),t.__decorate([a.property()],S.prototype,"imageRotationSupported",void 0),t.__decorate([a.property()],S.prototype,"imageNormalizationSupported",void 0),t.__decorate([a.property()],S.prototype,"requestUpdate",void 0),t.__decorate([a.property()],S.prototype,"updating",null),S=t.__decorate([p.subclass("esri.views.2d.layers.support.ExportStrategy")],S);return S}));
