/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../core/has","../../../../core/maybe","../../../../core/Logger","../../../../core/Error","../../../../renderers/visualVariables/support/SizeStop","../../../../renderers/visualVariables/SizeVariable","../../../../core/MD5","../../engine/LevelDependentSizeVariable"],(function(e,i,t,s,r,a,n,l,o){"use strict";const u=s.getLogger("esri.views.2d.layers.support.clusterUtils");i.add("esri-cluster-arcade-enabled",1);const c=i("esri-cluster-arcade-enabled"),d=e=>{for(const i of e)if("size"===i.type)return i;return null},p=e=>{for(const i of e)if("cluster_count"===i.field)return!0;return!1},f=(e,i)=>{const s=[new a({value:0,size:0}),new a({value:1})];if(t.isNone(i))return new n({field:"cluster_count",stops:[...s,new a({value:2,size:0})]});const r=Object.keys(i).reduce(((t,r)=>({...t,[r]:[...s,new a({value:Math.max(2,i[r].minValue),size:e.clusterMinSize}),new a({value:Math.max(3,i[r].maxValue),size:e.clusterMaxSize})]})),{});return new o.LevelDependentSizeVariable({field:"cluster_count",levels:r})},v=e=>{const i=i=>u.error(new r("Unsupported-renderer",i,{renderer:e}));if("unique-value"===e.type){if(e.field2||e.field3)return i("FeatureReductionCluster does not support multi-field UniqueValueRenderers"),!1}else if("class-breaks"===e.type){if(e.normalizationField){const t=e.normalizationType;if("field"!==t)return i(`FeatureReductionCluster does not support a normalizationType of ${t}`),!1}}else if("simple"!==e.type)return i(`FeatureReductionCluster does not support renderers of type ${e.type}`),!1;if(!c){if("valueExpression"in e&&e.valueExpression)return i("FeatureReductionCluster does not currently support renderer.valueExpression. Support will be added in a future release"),!1;if(("visualVariables"in e&&e.visualVariables||[]).some((e=>!(!("valueExpression"in e)||!e.valueExpression))))return i("FeatureReductionCluster does not currently support visualVariables with a valueExpression. Support will be added in a future release"),!1}return!0};function m(e,i){const{name:t,outStatistic:s}=i,{onStatisticField:a,onStatisticValueExpression:n,statisticType:o}=s;if(n){const i=l.createMD5Hash(n.toLowerCase());e.push({name:t,outStatistic:{onStatisticField:i,onStatisticValueExpression:n,statisticType:o}})}else a?e.push({name:t,outStatistic:{onStatisticField:a,statisticType:o}}):u.error(new r("mapview-unsupported-field","Unable to handle field",{field:i}))}function S(e,i,t){const s=l.createMD5Hash(i),r="mode"===t?`cluster_type_${s}`:`cluster_avg_${s}`;return e.some((e=>e.name===r))||e.push({name:r,outStatistic:{onStatisticField:s,onStatisticValueExpression:i,statisticType:t}}),r}function b(e,i,t,s){if("cluster_count"===i||e.some((e=>e.name===i)))return i;const r=function(e,i,t){switch(e){case"avg":case"avg_angle":return`cluster_avg_${i}`;case"mode":return`cluster_type_${i}`;case"norm":{const e=t,s="field",r=i.toLowerCase()+",norm:"+s+","+e.toLowerCase();return"cluster_avg_"+l.createMD5Hash(r)}}}(t,i,s);return e.some((e=>e.name===r))||("norm"===t?e.push({name:r,outStatistic:{onStatisticField:i,onStatisticNormalizationField:s,statisticType:t}}):e.push({name:r,outStatistic:{onStatisticField:i,statisticType:t}})),r}e.createClusterCountSizeVariable=f,e.createClusterRenderer=(e,i,s,r)=>{const a=i.clone();if(!v(a))return a;if(s.fields)for(const i of s.fields)m(e,i);if("visualVariables"in a){const i=(a.visualVariables||[]).filter((e=>"$view.scale"!==e.valueExpression)),n=d(i);i.forEach((i=>{"rotation"===i.type?i.field?i.field=b(e,i.field,"avg_angle"):i.valueExpression&&(i.field=S(e,i.valueExpression,"avg_angle"),i.valueExpression=null):i.normalizationField?(i.field=b(e,i.field,"norm",i.normalizationField),i.normalizationField=null):i.field?i.field=b(e,i.field,"avg"):(i.field=S(e,i.valueExpression,"avg"),i.valueExpression=null)})),t.isNone(n)&&!p(i)&&(i.push(f(s,r)),a.dynamicClusterSize=!0),a.visualVariables=i}switch(a.type){case"simple":break;case"unique-value":a.field?a.field=b(e,a.field,"mode"):a.valueExpression&&(a.field=S(e,a.valueExpression,"mode"),a.valueExpression=null);break;case"class-breaks":a.normalizationField?(a.field=b(e,a.field,"norm",a.normalizationField),a.normalizationField=null):a.field?a.field=b(e,a.field,"avg"):(a.field=S(e,a.valueExpression,"avg"),a.valueExpression=null)}return a},e.findSizeVV=d,e.hasClusterCountVV=p,e.isClusterCompatibleRenderer=v,Object.defineProperty(e,"__esModule",{value:!0})}));
