/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Logger","../../../core/maybe","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/accessorSupport/decorators/subclass","../../../geometry/Extent","../engine/BitmapContainer","./LayerView2D","./support/ExportStrategy","../../layers/LayerView","../../layers/RefreshableLayerView","../../layers/WMSLayerView"],(function(e,t,r,i,a,n,o,s,c,p,h,u,d,y,l,m,g){"use strict";let f=function(t){function o(){var e;return(e=t.apply(this,arguments)||this).bitmapContainer=new u.BitmapContainer,e}e._inheritsLoose(o,t);var s=o.prototype;return s.supportsSpatialReference=function(e){return this.layer.serviceSupportsSpatialReference(e)},s.update=function(e){this.strategy.update(e).catch((e=>{a.isAbortError(e)||r.getLogger(this.declaredClass).error(e)}))},s.attach=function(){const{layer:e}=this,{imageMaxHeight:t,imageMaxWidth:r}=e;this.bitmapContainer=new u.BitmapContainer,this.container.addChild(this.bitmapContainer),this.strategy=new y({container:this.bitmapContainer,fetchSource:this.fetchImage.bind(this),requestUpdate:this.requestUpdate.bind(this),imageMaxHeight:t,imageMaxWidth:r,imageRotationSupported:!1,imageNormalizationSupported:!1,hidpi:!1}),this.addAttachHandles(n.watch((()=>this.exportImageVersion),(()=>this.requestUpdate())))},s.detach=function(){this.strategy=i.destroyMaybe(this.strategy),this.container.removeAllChildren()},s.moveStart=function(){},s.viewChange=function(){},s.moveEnd=function(){this.requestUpdate()},s.createFetchPopupFeaturesQuery=function(e){const{view:t,bitmapContainer:r}=this,{x:i,y:a}=e,{spatialReference:n}=t;let o,s=0,c=0;if(r.children.some((e=>{const{width:t,height:r,resolution:p,x:u,y:d}=e,y=u+p*t,l=d-p*r;return i>=u&&i<=y&&a<=d&&a>=l&&(o=new h({xmin:u,ymin:l,xmax:y,ymax:d,spatialReference:n}),s=t,c=r,!0)})),!o)return null;const p=o.width/s,u=Math.round((i-o.xmin)/p),d=Math.round((o.ymax-a)/p);return{extent:o,width:s,height:c,x:u,y:d}},s.doRefresh=function(){var t=e._asyncToGenerator((function*(){this.requestUpdate()}));function r(){return t.apply(this,arguments)}return r}(),s.isUpdating=function(){return this.strategy.updating||this.updateRequested},s.fetchImage=function(e,t,r,i){return this.layer.fetchImageBitmap(e,t,r,{timeExtent:this.timeExtent,...i})},o}(g(m(d.LayerView2DMixin(l))));t.__decorate([o.property()],f.prototype,"strategy",void 0),t.__decorate([o.property()],f.prototype,"updating",void 0),f=t.__decorate([p.subclass("esri.views.2d.layers.WMSLayerView2D")],f);return f}));
