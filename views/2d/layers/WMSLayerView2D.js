/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Error","../../../core/Logger","../../../core/promiseUtils","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../../geometry/Extent","../engine/BitmapContainer","./LayerView2D","./support/ExportStrategy","../../layers/LayerView","../../layers/RefreshableLayerView","../../layers/WMSLayerView"],(function(e,t,r,i,a,n,s,o,h,c,p,u,l,d,y,m,g){"use strict";const f=i.getLogger("esri.views.2d.layers.WMSLayerView2D");let w=function(t){function i(){return t.apply(this,arguments)||this}e._inheritsLoose(i,t);var n=i.prototype;return n.initialize=function(){const{layer:e,view:t}=this;e.supportsSpatialReference(t.spatialReference)||this.addResolvingPromise(Promise.reject(new r("layerview:spatial-reference-incompatible","The spatial references supported by this WMS layer are incompatible with the spatial reference of the view",{layer:e})))},n.update=function(e){this.strategy.update(e).catch((e=>{a.isAbortError(e)||f.error(e)}))},n.attach=function(){const{layer:e}=this,{imageMaxHeight:t,imageMaxWidth:r}=e;this._bitmapContainer=new u.BitmapContainer,this.container.addChild(this._bitmapContainer),this.strategy=new d({container:this._bitmapContainer,fetchSource:this.fetchImage.bind(this),requestUpdate:this.requestUpdate.bind(this),imageMaxHeight:t,imageMaxWidth:r,imageRotationSupported:!1,imageNormalizationSupported:!1,hidpi:!1}),this.handles.add(this.watch("exportImageVersion",(()=>this.requestUpdate())),"exportImageVersion")},n.detach=function(){this.handles.remove("exportImageVersion"),this.strategy.destroy(),this.container.removeChild(this._bitmapContainer),this._bitmapContainer.removeAllChildren()},n.moveStart=function(){},n.viewChange=function(){},n.moveEnd=function(){this.requestUpdate()},n.createFetchPopupFeaturesQuery=function(e){const{view:t}=this,r=this._bitmapContainer,{x:i,y:a}=e,{spatialReference:n}=t;let s=null,o=0,h=0;if(r.children.some((e=>{const{width:t,height:r,resolution:c,x:u,y:l}=e,d=u+c*t,y=l-c*r;return i>=u&&i<=d&&a<=l&&a>=y&&(s=new p({xmin:u,ymin:y,xmax:d,ymax:l,spatialReference:n}),o=t,h=r,!0)})),!s)return null;const c=s.width/o,u=Math.round((i-s.xmin)/c),l=Math.round((s.ymax-a)/c);return{extent:s,width:o,height:h,x:u,y:l}},n.doRefresh=function(){var t=e._asyncToGenerator((function*(){this.requestUpdate()}));function r(){return t.apply(this,arguments)}return r}(),n.isUpdating=function(){return this.strategy.updating||this.updateRequested},n.fetchImage=function(e,t,r,i){return this.layer.fetchImage(e,t,r,{timeExtent:this.timeExtent,...i})},i}(g.WMSLayerView(m.RefreshableLayerView(l.LayerView2DMixin(y))));t.__decorate([n.property()],w.prototype,"strategy",void 0),t.__decorate([n.property()],w.prototype,"updating",void 0),w=t.__decorate([c.subclass("esri.views.2d.layers.WMSLayerView2D")],w);return w}));
