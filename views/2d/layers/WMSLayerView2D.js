/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/has","../../../core/Logger","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass","../../../core/Error","../../../core/urlUtils","../../../core/uuid","../../../portal/support/resourceExtension","../../../core/promiseUtils","../../../geometry/Extent","../../layers/RefreshableLayerView","../../layers/LayerView","../../layers/WMSLayerView","../engine/BitmapContainer","./LayerView2D","./support/ExportStrategy"],(function(e,t,i,r,a,n,s,o,h,c,p,u,l,d,m,y,g,f,w){"use strict";const x=r.getLogger("esri.views.2d.layers.WMSLayerView2D");let b=function(t){function i(){return t.apply(this,arguments)||this}e._inheritsLoose(i,t);var r=i.prototype;return r.initialize=function(){const{layer:e,view:t}=this;e.supportsSpatialReference(t.spatialReference)||this.addResolvingPromise(Promise.reject(new o("layerview:spatial-reference-incompatible","The spatial references supported by this WMS layer are incompatible with the spatial reference of the view",{layer:e})))},r.hitTest=function(){return null},r.update=function(e){this.strategy.update(e).catch((e=>{u.isAbortError(e)||x.error(e)}))},r.attach=function(){const{layer:e}=this,{imageMaxHeight:t,imageMaxWidth:i}=e;this._bitmapContainer=new g.BitmapContainer,this.container.addChild(this._bitmapContainer),this.strategy=new w({container:this._bitmapContainer,fetchSource:this.fetchImage.bind(this),requestUpdate:this.requestUpdate.bind(this),imageMaxHeight:t,imageMaxWidth:i,imageRotationSupported:!1,imageNormalizationSupported:!1,hidpi:!1}),this.handles.add(this.watch("exportImageVersion",(()=>this.requestUpdate())),"exportImageVersion")},r.detach=function(){this.handles.remove("exportImageVersion"),this.strategy.destroy(),this.container.removeChild(this._bitmapContainer),this._bitmapContainer.removeAllChildren()},r.moveStart=function(){},r.viewChange=function(){},r.moveEnd=function(){this.requestUpdate()},r.createFetchPopupFeaturesQuery=function(e){const{view:t}=this,i=this._bitmapContainer,{x:r,y:a}=e,{spatialReference:n}=t;let s=null,o=0,h=0;if(i.children.some((e=>{const{width:t,height:i,resolution:c,x:p,y:u}=e,d=p+c*t,m=u-c*i;return r>=p&&r<=d&&a<=u&&a>=m&&(s=new l({xmin:p,ymin:m,xmax:d,ymax:u,spatialReference:n}),o=t,h=i,!0)})),!s)return null;const c=s.width/o,p=Math.round((r-s.xmin)/c),u=Math.round((s.ymax-a)/c);return{extent:s,width:o,height:h,x:p,y:u}},r.doRefresh=async function(){this.requestUpdate()},r.isUpdating=function(){return this.strategy.updating||this.updateRequested},r.fetchImage=function(e,t,i,r){return this.layer.fetchImage(e,t,i,{timeExtent:this.timeExtent,timestamp:this.refreshTimestamp,...r})},i}(y.WMSLayerView(d.RefreshableLayerView(f.LayerView2DMixin(m))));return t.__decorate([n.property()],b.prototype,"strategy",void 0),t.__decorate([n.property()],b.prototype,"updating",void 0),b=t.__decorate([s.subclass("esri.views.2d.layers.WMSLayerView2D")],b),b}));
