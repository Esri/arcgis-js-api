/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Logger","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../../geometry/Extent","../engine/BitmapContainer","./LayerView2D","./support/ExportStrategy","../../layers/LayerView","../../layers/RefreshableLayerView","../../layers/WMSLayerView"],(function(e,t,r,i,a,n,o,s,c,p,h,u,d,l,y,m){"use strict";let g=function(t){function n(){var e;return(e=t.apply(this,arguments)||this).bitmapContainer=new h.BitmapContainer,e}e._inheritsLoose(n,t);var o=n.prototype;return o.supportsSpatialReference=function(e){return this.layer.serviceSupportsSpatialReference(e)},o.update=function(e){this.strategy.update(e).catch((e=>{i.isAbortError(e)||r.getLogger(this.declaredClass).error(e)}))},o.attach=function(){const{layer:e}=this,{imageMaxHeight:t,imageMaxWidth:r}=e;this.bitmapContainer=new h.BitmapContainer,this.container.addChild(this.bitmapContainer),this.strategy=new d({container:this.bitmapContainer,fetchSource:this.fetchImage.bind(this),requestUpdate:this.requestUpdate.bind(this),imageMaxHeight:t,imageMaxWidth:r,imageRotationSupported:!1,imageNormalizationSupported:!1,hidpi:!1}),this.handles.add(a.watch((()=>this.exportImageVersion),(()=>this.requestUpdate())),"exportImageVersion")},o.detach=function(){this.handles.remove("exportImageVersion"),this.strategy.destroy(),this.strategy=null,this.container.removeAllChildren()},o.moveStart=function(){},o.viewChange=function(){},o.moveEnd=function(){this.requestUpdate()},o.createFetchPopupFeaturesQuery=function(e){const{view:t,bitmapContainer:r}=this,{x:i,y:a}=e,{spatialReference:n}=t;let o=null,s=0,c=0;if(r.children.some((e=>{const{width:t,height:r,resolution:h,x:u,y:d}=e,l=u+h*t,y=d-h*r;return i>=u&&i<=l&&a<=d&&a>=y&&(o=new p({xmin:u,ymin:y,xmax:l,ymax:d,spatialReference:n}),s=t,c=r,!0)})),!o)return null;const h=o.width/s,u=Math.round((i-o.xmin)/h),d=Math.round((o.ymax-a)/h);return{extent:o,width:s,height:c,x:u,y:d}},o.doRefresh=function(){var t=e._asyncToGenerator((function*(){this.requestUpdate()}));function r(){return t.apply(this,arguments)}return r}(),o.isUpdating=function(){return this.strategy.updating||this.updateRequested},o.fetchImage=function(e,t,r,i){return this.layer.fetchImageBitmap(e,t,r,{timeExtent:this.timeExtent,...i})},n}(m(y(u.LayerView2DMixin(l))));t.__decorate([n.property()],g.prototype,"strategy",void 0),t.__decorate([n.property()],g.prototype,"updating",void 0),g=t.__decorate([c.subclass("esri.views.2d.layers.WMSLayerView2D")],g);return g}));
