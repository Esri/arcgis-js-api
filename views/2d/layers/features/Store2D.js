/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["require","exports","../../../../core/has","../../../../core/maybe","../../../../core/promiseUtils","../../../../support/arcadeOnDemand","../../../../core/accessorSupport/diffUtils","../../arcade/callExpressionWithCursor"],(function(e,t,s,i,r,a,c,n){"use strict";const o=new Promise((function(t,s){e(["../../../../layers/support/labelFormatUtils"],t,s)}));let u=function(){function e(e,t){this._canCacheExpressionValue=!1,this._sourceInfo=e,this._bitsets={computed:t.getBitset(t.createBitset())}}var t=e.prototype;return t.updateSchema=async function(e,t){const a=c.diff(this._schema,t);if(this._schema=t,!t||i.isNone(a)||!c.hasDiff(a,"attributes"))return;s("esri-2d-update-debug")&&console.debug("Applying Update - Store:",a),this._bitsets.computed.clear(),e.targets[t.name]=!0;const n=t.attributes,o=[],u=[];for(const e in n){const t=n[e];switch(t.type){case"field":break;case"expression":o.push(this._createArcadeComputedField(t));break;case"label-expression":o.push(this._createLabelArcadeComputedField(t));break;case"statistic":u.push(t)}}this._computedFields=await r.all(o),this._canCacheExpressionValue=!this._computedFields.some((e=>"expression"===e.type&&e.expression.referencesScale())),this._statisticFields=u},t.setComputedAttributes=function(e,t,s,i){const r=this._bitsets.computed;if(!this._canCacheExpressionValue||!r.has(s)){r.set(s);for(const r of this._computedFields){const a=this._evaluateField(t,r,i);switch(r.resultType){case"numeric":e.setComputedNumericAtIndex(s,r.fieldIndex,a);break;case"string":e.setComputedStringAtIndex(s,r.fieldIndex,a)}}}},t._createArcadeComputedField=async function(e){const t=this._sourceInfo.spatialReference,s=this._sourceInfo.fieldsIndex;return{...e,expression:await a.createRendererExpression(e.valueExpression,t,s)}},t._createLabelArcadeComputedField=async function(e){const t=this._sourceInfo.spatialReference,s=this._sourceInfo.fields,{createLabelFunction:i}=await o,r=await i(e.label,s,t);return{...e,builder:r}},t._evaluateField=function(e,t,s){switch(t.type){case"label-expression":{const s=e.readArcadeFeature();return t.builder.evaluate(s)||""}case"expression":{const{expression:i}=t;return n(i,e,{$view:{scale:s}})}}},e}();t.Store2D=u,Object.defineProperty(t,"__esModule",{value:!0})}));
