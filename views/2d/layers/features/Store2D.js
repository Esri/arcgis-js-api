/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["require","exports","../../../../core/has","../../../../core/maybe","../../../../support/arcadeOnDemand","../../../../core/accessorSupport/diffUtils","../../arcade/callExpressionWithCursor"],(function(e,t,s,i,a,r,c){"use strict";const n=new Promise((function(t,s){e(["../../../../layers/support/labelFormatUtils"],t,s)}));let o=function(){function e(e,t){this._canCacheExpressionValue=!1,this._sourceInfo=e,this._bitsets={computed:t.getBitset(t.createBitset())}}var t=e.prototype;return t.invalidate=function(){this._bitsets.computed.clear()},t.updateSchema=async function(e,t){const a=r.diff(this._schema,t);if(this._schema=t,!t||i.isNone(a)||!r.hasDiff(a,"attributes"))return;s("esri-2d-update-debug")&&console.debug("Applying Update - Store:",a),this._bitsets.computed.clear(),e.targets[t.name]=!0;const c=t.attributes,n=[],o=[];for(const s in c){const e=c[s];switch(e.type){case"field":break;case"expression":n.push(this._createArcadeComputedField(e));break;case"label-expression":n.push(this._createLabelArcadeComputedField(e));break;case"statistic":o.push(e)}}this._computedFields=await Promise.all(n),this._canCacheExpressionValue=!this._computedFields.some((e=>"expression"===e.type&&e.expression.referencesScale())),this._statisticFields=o},t.setComputedAttributes=function(e,t,s,i){const a=this._bitsets.computed;if(!this._canCacheExpressionValue||!a.has(s)){a.set(s);for(const a of this._computedFields){const r=this._evaluateField(t,a,i);switch(a.resultType){case"numeric":e.setComputedNumericAtIndex(s,a.fieldIndex,r);break;case"string":e.setComputedStringAtIndex(s,a.fieldIndex,r)}}}},t._createArcadeComputedField=async function(e){const t=this._sourceInfo.spatialReference,s=this._sourceInfo.fieldsIndex;return{...e,expression:await a.createRendererExpression(e.valueExpression,t,s)}},t._createLabelArcadeComputedField=async function(e){const t=this._sourceInfo.spatialReference,s=this._sourceInfo.fields,{createLabelFunction:i}=await n,a=await i(e.label,s,t);return{...e,builder:a}},t._evaluateField=function(e,t,s){switch(t.type){case"label-expression":{const s=e.readArcadeFeature();return t.builder.evaluate(s)||""}case"expression":{const{expression:i}=t;return c(i,e,{$view:{scale:s}})}}},e}();t.Store2D=o,Object.defineProperty(t,"__esModule",{value:!0})}));
