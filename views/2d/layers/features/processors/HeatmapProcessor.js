/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../core/has","../../../../../core/maybe","../../../../../core/Logger","../../../../../core/accessorSupport/ensureType","../../../../../core/accessorSupport/decorators/property","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/urlUtils","../../../../../core/uuid","../../../../../portal/support/resourceExtension","../../../../../core/accessorSupport/diffUtils","../../../../../renderers/support/heatmapUtils","./BaseProcessor"],(function(e,t,r,s,o,i,a,n,c,p,u,d,l,h){"use strict";let y=function(t){function r(){var e;return(e=t.apply(this,arguments)||this).type="heatmap",e._tileKeyToFeatureSets=new Map,e}e._inheritsLoose(r,t);var o=r.prototype;return o.initialize=function(){this.handles.add([this.tileStore.on("update",this.onTileUpdate.bind(this))])},o.update=async function(e,t){const r=t.schema.processors[0];if("heatmap"!==r.type)return;d.diff(this._schema,r)&&(e.mesh=!0,this._schema=r)},o.onTileUpdate=function(e){for(const t of e.removed)this._tileKeyToFeatureSets.delete(t.key.id)},o.onTileData=async function(e,t,r){this._tileKeyToFeatureSets.has(e.key.id)&&"replace"!==t.type||this._tileKeyToFeatureSets.set(e.key.id,new Map);const o=this._tileKeyToFeatureSets.get(e.key.id);s.isSome(t.addOrUpdate)&&o.set(t.addOrUpdate.instance,t);let i=t.end;if(o.forEach((e=>i=i||e.end)),!i)return;const a=[];o.forEach((e=>{s.isSome(e.addOrUpdate)&&a.push(e.addOrUpdate)}));const n=l.calculateHeatmapIntensityInfoReaders(a,this._schema.mesh,512,512),c={tileKey:e.key.id,intensityInfo:n},p=[n.matrix];return this.remoteClient.invoke("tileRenderer.onTileData",c,{...r,transferList:p})},o.onTileError=function(e,t,r){return this.remoteClient.invoke("tileRenderer.onTileError",{tileKey:e.id,error:t},r)},r}(h);return y=t.__decorate([n.subclass("esri.views.2d.layers.features.processors.HeatmapProcessor")],y),y}));
