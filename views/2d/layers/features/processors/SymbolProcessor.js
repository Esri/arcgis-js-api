// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../../core/Error","../../../../../core/has","../../../../../core/Logger","../../../../../core/maybe","../../../../../core/promiseUtils","../../../../../core/accessorSupport/decorators","../../../../../core/accessorSupport/diffUtils","../../../../../geometry/SpatialReference","../../../engine/webgl/definitions","../../../engine/webgl/collisions/CollisionGrid","../../../engine/webgl/mesh/factories/matcherUtils","../../../engine/webgl/mesh/factories/WGLMeshFactory","../../../engine/webgl/mesh/templates/WGLTemplateStore","../../../engine/webgl/util/BidiText","../textUtils","./BaseProcessor","../support/AttributeStore"],(function(e,t,r,o,i,n,s,a,c,l,u,d,p,h,f,y,g,m,_,v){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var b=n.getLogger("esri.views.2d.layers.features.processors.SymbolProcessor");var w=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="symbol",t}return r.__extends(t,e),t.prototype.destroy=function(){},Object.defineProperty(t.prototype,"supportsTileUpdates",{get:function(){return!0},enumerable:!1,configurable:!0}),t.prototype.update=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var o,n;return r.__generator(this,(function(r){return"symbol"!==(o=t.schema.processors[0]).type?(i("esri-2d-debug")&&console.debug("Tried to update symbol processor with schema of type",o.type),[2]):(n=l.diff(this._schema,o),l.hasDiff(n,"mesh")?(i("esri-2d-update-debug")&&console.debug("Applying Update - Processor:",n),e.mesh=!0,e.why.mesh.push("Symbology changed"),this._schema=o,this._factory=this._createFactory(o),this._factory.update(o,this.tileStore.tileScheme.tileInfo),[2]):[2])}))}))},t.prototype.onTileData=function(e,t,r){return a.throwIfAborted(r),this._onTileData(e,t,r)},t.prototype.onTileError=function(e,t,r){var o=r.signal,n={tileKey:e.id,error:t};return i("esri-2d-debug")&&console.debug(t),this.remoteClient.invoke("tileRenderer.onTileError",n,{signal:o})},t.prototype._createFactory=function(e){var t=this,r=this.service,o=r.geometryType,i=r.objectIdField,n={geometryType:o,fields:r.fields,spatialReference:u.fromJSON(this.spatialReference)},s=new y.WGLTemplateStore((function(e,r){return t.remoteClient.invoke("tileRenderer.getMaterialItems",e,r)}),!1);return this._store=s,this._matcher=h.createMatcher(e.mesh.matcher,s,n),new f.WGLMeshFactory(o,i,s)},t.prototype._onTileData=function(e,t,o){return r.__awaiter(this,void 0,void 0,(function(){var i,n,c,l,u,d,p,h,f,y,g,m;return r.__generator(this,(function(r){switch(r.label){case 0:if(i=t.type,n=t.addOrUpdate,c=t.remove,l=t.end,!n)return y={type:i,addOrUpdate:null,remove:c,clear:!1,end:l},[2,this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:e.id,data:y},o)];u=this._processFeatures(e,n,o),d=o.signal,r.label=1;case 1:return r.trys.push([1,3,,4]),[4,u];case 2:return p=r.sent(),h=s.andThen(p,(function(e){return e.message})),f=s.andThen(p,(function(e){return e.transferList}))||[],y={type:i,addOrUpdate:h,remove:c,clear:!1,end:l},g={transferList:s.unwrap(f)||[],signal:d},a.throwIfAborted(g),[2,this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:e.id,data:y},g)];case 3:return m=r.sent(),this._handleError(e,m,o),[3,4];case 4:return[2]}}))}))},t.prototype._processFeatures=function(e,t,o){return r.__awaiter(this,void 0,void 0,(function(){var i,n,c,l,u;return r.__generator(this,(function(r){switch(r.label){case 0:return s.isNone(t)||!t.hasFeatures?[2,null]:(i={transform:e.transform,hasZ:!1,hasM:!1},n=this._factory,c={viewingMode:"",scale:e.scale},[4,this._matcher]);case 1:return l=r.sent(),a.throwIfAborted(o),u=this._getLabelInfos(e,t),[4,n.analyze(t.getCursor(),l,i,c)];case 2:return r.sent(),a.throwIfAborted(o),[2,this._writeFeatureSet(e,t,i,u,n)]}}))}))},t.prototype._writeFeatureSet=function(e,t,r,n,a){for(var c=a.createMeshData(t.getApproximateSize()),l={viewingMode:"",scale:e.scale},u=t.getCursor();u.next();)try{var d=u.getDisplayId(),p=s.isSome(n)?n.get(d):null;a.writeCursor(c,u,r,l,e.level,p)}catch(t){if(i("esri-2d-debug")){var h={tileKey:e.key.id,objectId:u.getObjectId(),error:t};b.error(new o("mapview-mesh-factory","Failed to write feature",h))}}return this._encodeDisplayData(c)},t.prototype._encodeDisplayData=function(e){var t={},r=new Array;return e.encode(t,r),{message:t,transferList:r}},t.prototype._handleError=function(e,t,r){if(!a.isAbortError(t)){var o={tileKey:e.id,error:t.message};return i("esri-2d-debug")&&console.debug(t),this.remoteClient.invoke("tileRenderer.onTileError",o,{signal:r.signal})}},t.prototype._shouldDiscard=function(e,t){switch(this.service.geometryType){case"esriGeometryPoint":var r=t.readLegacyPointGeometry();return!r||e.checkOverlap(r.x,r.y);case"esriGeometryPolygon":var o=t.readLegacyCentroid();return!o||e.checkOverlap(o.x,o.y);default:return!1}},t.prototype._markUsed=function(e,t){switch(this.service.geometryType){case"esriGeometryPoint":var r=t.readLegacyPointGeometry(),o=r.x,i=r.y;return e.markUsed(o,i);case"esriGeometryPolygon":var n=t.readLegacyCentroid();o=n.x,i=n.y;return e.markUsed(o,i)}},t.prototype._getLabelInfos=function(e,t){var r=this._schema.mesh.labels,o=s.andThen(r,(function(t){return t.filter((function(t){return function(e,t){return(!e.minScale||e.minScale>=t)&&(!e.maxScale||e.maxScale<=t)}(t,e.scale)}))}));if(s.isNone(o)||0===o.length)return null;for(var i=new Map,n=new p.CollisionGrid(d.COLLISION_EARLY_REJECT_BUCKET_SIZE),a=t.getCursor(),c=function(){var e=a.getDisplayId();if(l._shouldDiscard(n,a))return i.has(e)||i.set(e,null),"continue";for(var t=!1,r=[],s=v.isAggregateId(e),c=s&&1!==a.readAttribute("cluster_count")?"aggregate":"feature",u=function(o){if(o.target!==c)return"continue";var i=a.getStorage(),n=s&&"feature"===c?i.getComputedStringAtIndex(a.readAttribute("referenceId"),o.fieldIndex):i.getComputedStringAtIndex(e,o.fieldIndex);if(!n)return"continue";var u=g.bidiText(n.toString()),d=u[0],p=u[1];l._store.getMosaicItem(o.symbol,m.codepoints(d)).then((function(e){r[o.index]={glyphs:e.glyphMosaicItems,rtl:p,index:o.index}})),t=!0},d=0,p=o;d<p.length;d++){u(p[d])}i.set(e,r),t&&l._markUsed(n,a)},l=this;a.next();)c();return i},t=r.__decorate([c.subclass("esri.views.2d.layers.features.processors.SymbolProcessor")],t)}(_.default);t.default=w}));