/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/CircularArray","../../../../core/Evented","../../../../core/has","../../../../core/maybe","../../../../chunks/rbush","../../../../geometry/support/aaBoundingBox","./Store2D","./support/FeatureSetReaderPBFIndirect"],(function(t,e,s,n,a,r,i,o,d,c){"use strict";function u(t,e){return t<<16|e}function h(t){return(4294901760&t)>>>16}function I(t){return 65535&t}const l={getObjectId:t=>t.getObjectId(),getAttributes:t=>t.readAttributes(),getAttribute:(t,e)=>t.readAttribute(e),cloneWithGeometry:(t,e)=>t,getGeometry:t=>t.readHydratedGeometry(),getCentroid:(t,e)=>t.readCentroid()};let _=function(t){function a(e,a,r){var o;return(o=t.call(this,e,a)||this).featureAdapter=l,o.events=new n,o._featureSetsByInstance=new Map,o._objectIdToDisplayId=new Map,o._spatialIndexInvalid=!0,o._indexSearchCache=new s(50),o._index=i.rbush(9,(t=>({minX:o._storage.getXMin(t),minY:o._storage.getYMin(t),maxX:o._storage.getXMax(t),maxY:o._storage.getYMax(t)}))),o.mode=r,o}e._inheritsLoose(a,t);var d=a.prototype;return d.hasInstance=function(t){return this._featureSetsByInstance.has(t)},d.onTileData=function(t,e){if(r.isNone(e.addOrUpdate))return e;if(e.addOrUpdate.attachStorage(this._storage),"snapshot"===this.mode){const s=e.addOrUpdate.getCursor();for(;s.next();){const e=s.getDisplayId();this.setComputedAttributes(this._storage,s,e,t.scale)}return e}this._featureSetsByInstance.set(e.addOrUpdate.instance,e.addOrUpdate);const s=e.addOrUpdate.getCursor();for(;s.next();)this._insertFeature(s,t.scale);return this._spatialIndexInvalid=!0,this.events.emit("changed"),e},d.search=function(t){this._rebuildIndex();const e=t.id,s=this._indexSearchCache.find((t=>t.tileId===e));if(r.isSome(s))return s.readers;const n=new Map,a=this._searchIndex(t.bounds),i=[];for(const r of a){const t=this._storage.getInstanceId(r),e=h(t),s=I(t);n.has(e)||n.set(e,[]);n.get(e).push(s)}return n.forEach(((t,e)=>{const s=this._featureSetsByInstance.get(e);i.push(c.FeatureSetReaderIndirect.from(s,t))})),this._indexSearchCache.enqueue({tileId:e,readers:i}),i},d.insert=function(t){const e=t.getCursor(),s=this._storage;for(;e.next();){const t=u(e.instance,e.getIndex()),n=e.getObjectId(),a=this._objectIdToDisplayId.get(n)??this._storage.createDisplayId();e.setDisplayId(a),s.setInstanceId(a,t),this._objectIdToDisplayId.set(n,a)}this._featureSetsByInstance.set(t.instance,t),this._spatialIndexInvalid=!0},d.remove=function(t){const e=this._objectIdToDisplayId.get(t);if(!e)return;const s=this._storage.getInstanceId(e),n=I(s),a=h(s),r=this._featureSetsByInstance.get(a);this._objectIdToDisplayId.delete(t),this._storage.releaseDisplayId(e),r.removeAtIndex(n),r.isEmpty&&this._featureSetsByInstance.delete(a),this._spatialIndexInvalid=!0},d.toArray=function(){const t=new Array;return this.forEach((e=>t.push(e))),t},d.forEach=function(t){this._objectIdToDisplayId.forEach((e=>{const s=this._storage.getInstanceId(e),n=this._lookupFeature(s);t(n)}))},d.forEachUnsafe=function(t){this._objectIdToDisplayId.forEach((e=>{const s=this._storage.getInstanceId(e),n=h(s),a=I(s),r=this._getFeatureSet(n);r.setIndex(a),t(r)}))},d.forEachInBounds=function(t,e){const s=this._searchIndex(t);for(const n of s){const t=this.lookupFeatureByDisplayId(n,this._storage);e(r.unwrap(t))}},d.forEachBounds=function(t,e,s){this._rebuildIndex();const n=[0,0,0,0];for(const a of t){if(!a.readGeometry())continue;const t=a.getDisplayId();n[0]=this._storage.getXMin(t),n[1]=this._storage.getYMin(t),n[2]=this._storage.getXMax(t),n[3]=this._storage.getYMax(t),e(o.fromRect(s,n))}},d.sweepFeatures=function(t,e,s){this._spatialIndexInvalid=!0,this._objectIdToDisplayId.forEach(((n,a)=>{t.has(n)||(e.releaseDisplayId(n),s&&s.unsetAttributeData(n),this._objectIdToDisplayId.delete(a))})),this.events.emit("changed")},d.sweepFeatureSets=function(t){this._spatialIndexInvalid=!0,this._featureSetsByInstance.forEach(((e,s)=>{t.has(s)||this._featureSetsByInstance.delete(s)}))},d.lookupObjectId=function(t,e){const s=this.lookupFeatureByDisplayId(t,e);return r.isNone(s)?null:s.getObjectId()},d.lookupDisplayId=function(t){return this._objectIdToDisplayId.get(t)},d.lookupFeatureByDisplayId=function(t,e){const s=e.getInstanceId(t);return this._lookupFeature(s)},d.lookupByDisplayIdUnsafe=function(t){const e=this._storage.getInstanceId(t),s=h(e),n=I(e),a=this._getFeatureSet(s);return a?(a.setIndex(n),a):null},d._insertFeature=function(t,e){const s=this._storage,n=t.getObjectId(),a=u(t.instance,t.getIndex());s.getInstanceId(t.getDisplayId());let r=this._objectIdToDisplayId.get(n);r||(r=s.createDisplayId(),this._objectIdToDisplayId.set(n,r),this._spatialIndexInvalid=!0),t.setDisplayId(r),s.setInstanceId(r,a),this.setComputedAttributes(s,t,r,e)},d._searchIndex=function(t){this._rebuildIndex();const e={minX:t[0],minY:t[1],maxX:t[2],maxY:t[3]};return this._index.search(e)},d._rebuildIndex=function(){if(!this._spatialIndexInvalid)return;const t=[];"snapshot"===this.mode?this._featureSetsByInstance.forEach((e=>{const s=e.getCursor();for(;s.next();){const e=s.getDisplayId();this._storage.setBounds(e,s)&&t.push(e)}})):this._objectIdToDisplayId.forEach((e=>{const s=this._storage.getInstanceId(e);this._storage.setBounds(e,this._lookupFeature(s))&&t.push(e)})),this._index.clear(),this._index.load(t),this._indexSearchCache.clear(),this._spatialIndexInvalid=!1},d._lookupFeature=function(t){const e=h(t),s=this._getFeatureSet(e);if(!s)return null;const n=s.getCursor(),a=I(t);return n.setIndex(a),n},d._getFeatureSet=function(t){return this._featureSetsByInstance.get(t)},e._createClass(a,[{key:"storeStatistics",get:function(){let t=0,e=0,s=0;return this.forEach((n=>{const a=n.readGeometry();a&&(e+=a.isPoint?1:a.lengths.reduce(((t,e)=>t+e),0),s+=a.isPoint?1:a.lengths.length,t+=1)})),{featureCount:t,vertexCount:e,ringCount:s}}}]),a}(d.Store2D);t.FeatureStore2D=_,t.featureAdapter=l,Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
