/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/Evented","../../../../geometry/support/aaBoundingBox","../../../../chunks/rbush","./Store2D"],(function(t,e,s,n,a,o,r){"use strict";function i(t){return(4294901760&t)>>>16}function u(t){return 65535&t}const d={getObjectId:t=>t.getObjectId(),getAttributes:t=>t.readAttributes(),getAttribute:(t,e)=>t.readAttribute(e),cloneWithGeometry:(t,e)=>t,getGeometry:t=>t.readHydratedGeometry(),getCentroid:(t,e)=>t.readCentroid()};let c=function(t){function r(e,s){var a;return(a=t.call(this,e,s)||this).featureAdapter=d,a.events=new n,a._featureSetsByInstance=new Map,a._objectIdToDisplayId=new Map,a._spatialIndexInvalid=!0,a._index=o.rbush(9,(t=>({minX:a._storage.getXMin(t),minY:a._storage.getYMin(t),maxX:a._storage.getXMax(t),maxY:a._storage.getYMax(t)}))),a}e._inheritsLoose(r,t);var c=r.prototype;return c.onTileData=function(t,e,n){if(s.isNone(e.addOrUpdate))return e;this._featureSetsByInstance.set(e.addOrUpdate.instance,e.addOrUpdate),this._storage=n,e.addOrUpdate._storage=n;const a=e.addOrUpdate.getCursor();for(;a.next();){const e=a.getObjectId(),s=(o=a.instance,r=a.getIndex(),o<<16|r);let i=this._objectIdToDisplayId.get(e);i||(i=n.createDisplayId(),this._objectIdToDisplayId.set(e,i),this._spatialIndexInvalid=!0),a.setDisplayId(i),n.setInstanceId(i,s),this.setComputedAttributes(n,a,i,t.scale)}var o,r;return"update"===e.type&&(this._spatialIndexInvalid=!0),this.events.emit("changed"),e},c.forEach=function(t){this._objectIdToDisplayId.forEach((e=>{const s=this._storage.getInstanceId(e),n=this._lookupFeature(s);t(n)}))},c.forEachUnsafe=function(t){this._objectIdToDisplayId.forEach((e=>{const s=this._storage.getInstanceId(e),n=i(s),a=u(s),o=this._getFeatureSet(n);o.setIndex(a),t(o)}))},c.forEachInBounds=function(t,e){const n=this._searchIndex(t);for(const t of n){const n=this.lookupFeatureByDisplayId(t,this._storage);e(s.unwrap(n))}},c.forEachBounds=function(t,e,s){this._rebuildIndex();const n=[0,0,0,0];for(const o of t){if(!o.readGeometry())continue;const t=o.getDisplayId();n[0]=this._storage.getXMin(t),n[1]=this._storage.getYMin(t),n[2]=this._storage.getXMax(t),n[3]=this._storage.getYMax(t),e(a.fromRect(s,n))}},c.sweepFeatures=function(t,e,s){this._objectIdToDisplayId.forEach(((n,a)=>{t.has(n)||(e.releaseDisplayId(n),s.unsetAttributeData(n),this._objectIdToDisplayId.delete(a))})),this.events.emit("changed")},c.sweepFeatureSets=function(t){this._featureSetsByInstance.forEach(((e,s)=>{t.has(s)||this._featureSetsByInstance.delete(s)}))},c.lookupObjectId=function(t,e){const n=this.lookupFeatureByDisplayId(t,e);return s.isNone(n)?null:n.getObjectId()},c.lookupDisplayId=function(t){return this._objectIdToDisplayId.get(t)},c.lookupFeatureByDisplayId=function(t,e){const s=e.getInstanceId(t);return this._lookupFeature(s)},c.lookupByDisplayIdUnsafe=function(t){const e=this._storage.getInstanceId(t),s=i(e),n=u(e),a=this._getFeatureSet(s);return a?(a.setIndex(n),a):null},c.hasInstance=function(t){return this._featureSetsByInstance.has(t)},c._rebuildIndex=function(){if(!this._spatialIndexInvalid)return;this._index.clear();const t=[];this._objectIdToDisplayId.forEach((e=>{const s=this._storage.getInstanceId(e);this._storage.setBounds(e,this._lookupFeature(s))&&t.push(e)})),this._index.load(t),this._spatialIndexInvalid=!1},c._lookupFeature=function(t){const e=i(t),s=u(t),n=this._getFeatureSet(e);if(!n)return null;const a=n.getCursor();return a.setIndex(s),a},c._getFeatureSet=function(t){return this._featureSetsByInstance.get(t)},c._searchIndex=function(t){this._rebuildIndex();const e={minX:t[0],minY:t[1],maxX:t[2],maxY:t[3]};return this._index.search(e)},e._createClass(r,[{key:"storeStatistics",get:function(){return{featureCount:0,vertexCount:0}}}]),r}(r.Store2D);t.FeatureStore2D=c,t.featureAdapter=d,Object.defineProperty(t,"__esModule",{value:!0})}));
