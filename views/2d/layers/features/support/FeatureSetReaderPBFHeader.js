/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../../core/Error","../../../../../tasks/operations/pbfFeatureServiceParser"],(function(e,t,s){"use strict";const n=268435455;let r=function(){function e(){this.hasFeatures=!1,this.fieldIndexMap=new Map,this.fieldCount=0,this.featureCount=0,this.objectIdFieldIndex=0,this.dateFields=new Set,this.offsets={attributes:new Array,geometry:new Array},this.centroid=new Array}var t=e.prototype;return t.hasFieldIndex=function(e){return this.fieldIndexMap.has(e)},t.isDateField=function(e){return this.dateFields.has(e)},t.getFieldIndex=function(e){return this.fieldIndexMap.get(e)},e}();function a(e){const t=e.getLength(),n=e.pos()+t,r={name:"",isDate:!1};for(;e.pos()<n&&e.next();)switch(e.tag()){case 1:r.name=e.getString();break;case 2:"esriFieldTypeDate"===s.parseFieldType(e.getEnum())&&(r.isDate=!0);break;default:e.skip()}return r}e.FeatureSetHeader=r,e.parseHeader=function(e,i){const o=e.pos(),d=new r;let c=0,f=0,u=null,p=null,l=null,g=!1;for(;e.next();)switch(e.tag()){case 1:u=e.getString();break;case 3:p=e.getString();break;case 12:l=e.processMessage(s.parseTransform);break;case 9:d.exceededTransferLimit=e.getBool(),d.exceededTransferLimit&&(d.offsets.geometry=new Int32Array(8e3),d.centroid=new Int32Array(16e3));break;case 13:{const t=a(e),s=t.name.toLowerCase().trim(),n=c++;d.fieldIndexMap.set(t.name,n),d.fieldIndexMap.set(s,n),t.isDate&&(d.dateFields.add(t.name),d.dateFields.add(s));break}case 15:{const t=e.getLength(),s=e.pos()+t;if(!d.exceededTransferLimit){const e=d.offsets.geometry,t=d.centroid;e.push(0),t.push(n),t.push(n)}!g&&d.exceededTransferLimit&&(g=!0,d.offsets.attributes=new Uint32Array(8e3*c));let r=f*c;for(;e.pos()<s&&e.next();)switch(e.tag()){case 1:{if(g)d.offsets.attributes[r++]=e.pos();else{d.offsets.attributes.push(e.pos())}const t=e.getLength();e.skipLen(t);break}case 2:if(i){const t=e.getLength(),s=e.pos()+t;for(;e.pos()<s&&e.next();)switch(e.tag()){case 3:{e.getUInt32();const t=e.getSInt32(),s=e.getSInt32();d.centroid[2*f]=t,d.centroid[2*f+1]=s;break}default:e.skip()}}else{d.offsets.geometry[f]=e.pos();const t=e.getLength();e.skipLen(t)}break;case 4:{const t=e.getLength(),s=e.pos()+t;for(;e.pos()<s&&e.next();)switch(e.tag()){case 3:{e.getUInt32();const t=e.getSInt32(),s=e.getSInt32();d.centroid[2*f]=t,d.centroid[2*f+1]=s;break}default:e.skip()}break}default:e.skip()}f++,d.hasFeatures=!0;break}default:e.skip()}const h=u||p;if(!h)throw new t("FeatureSet has no objectId or globalId field name");return d.featureCount=f,d.fieldCount=c,d.objectIdFieldIndex=d.getFieldIndex(h),d.transform=l,d.displayIds=new Uint32Array(d.featureCount),d.groupIds=new Uint16Array(d.featureCount),e.move(o),d},Object.defineProperty(e,"__esModule",{value:!0})}));
