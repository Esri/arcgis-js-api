/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../../core/Error","../../../../../rest/query/operations/pbfFeatureServiceParser"],(function(e,t,s){"use strict";const r=268435455;let n=function(){function e(){this.fieldMap=new Map,this.fields=[],this.hasFeatures=!1,this.exceededTransferLimit=!1,this.fieldCount=0,this.featureCount=0,this.objectIdFieldIndex=0,this.vertexCount=0,this.offsets={attributes:new Array,geometry:new Array},this.centroid=new Array}var t=e.prototype;return t.hasField=function(e){return this.fieldMap.has(e)},t.isDateField=function(e){return this.fieldMap.get(e)?.isDate??!1},t.getFieldIndex=function(e){return this.fieldMap.get(e)?.index},e}();function a(e){const t=1,r=2,n=e.asUnsafe(),a=n.getLength(),i=n.pos()+a,o={name:"",isDate:!1};for(;n.pos()<i&&n.next();)switch(n.tag()){case t:o.name=n.getString();break;case r:"esriFieldTypeDate"===s.parseFieldType(n.getEnum())&&(o.isDate=!0);break;default:n.skip()}return o}function i(e){return e.toLowerCase().trim()}function o(e,o,f=!1){const c=1,d=3,u=9,l=12,g=13,p=15,h=e.asUnsafe(),b=h.pos(),m=new n;let w=0,y=0;const k=1,x=2,I=4,F=3;let L=null,S=null,A=null,M=!1;for(;h.next();)switch(h.tag()){case c:L=h.getString();break;case d:S=h.getString();break;case l:A=h.processMessage(s.parseTransform);break;case u:if(m.exceededTransferLimit=h.getBool(),m.exceededTransferLimit){m.offsets.geometry=f?new Float64Array(8e3):new Int32Array(8e3),m.centroid=f?new Float64Array(16e3):new Int32Array(16e3);for(let e=0;e<m.centroid.length;e++)m.centroid[e]=r}break;case g:{const t=a(e),s=t.name,r=i(t.name),n={fieldName:s,index:w++,isDate:t.isDate};m.fields.push(n),m.fieldMap.set(t.name,n),m.fieldMap.set(r,n);break}case p:{const e=h.getLength(),t=h.pos()+e;if(!m.exceededTransferLimit){const e=m.offsets.geometry,t=m.centroid;e.push(0),t.push(r),t.push(r)}!M&&m.exceededTransferLimit&&(M=!0,m.offsets.attributes=f?new Float64Array(8e3*w):new Uint32Array(8e3*w));let s=y*w;for(;h.pos()<t&&h.next();)switch(h.tag()){case k:{if(M)m.offsets.attributes[s++]=h.pos();else{m.offsets.attributes.push(h.pos())}const e=h.getLength();h.skipLen(e);break}case x:if(o){const e=h.getLength(),t=h.pos()+e;for(;h.pos()<t&&h.next();)switch(h.tag()){case F:{h.getUInt32();const e=h.getSInt64(),t=h.getSInt64();m.centroid[2*y]=e,m.centroid[2*y+1]=t;break}default:h.skip()}}else{m.offsets.geometry[y]=h.pos();const e=h.getLength();m.vertexCount+=e,h.skipLen(e)}break;case I:{const e=h.getLength(),t=h.pos()+e;for(;h.pos()<t&&h.next();)switch(h.tag()){case F:{h.getUInt32();const e=h.getSInt64(),t=h.getSInt64();m.centroid[2*y]=e,m.centroid[2*y+1]=t;break}default:h.skip()}break}default:h.skip()}y++,m.hasFeatures=!0;break}default:h.skip()}const C=L||S;if(!C)throw new t("FeatureSet has no objectId or globalId field name");return m.featureCount=y,m.fieldCount=w,m.objectIdFieldIndex=m.getFieldIndex(C),m.transform=A,m.displayIds=new Uint32Array(m.featureCount),m.groupIds=new Uint16Array(m.featureCount),h.move(b),m}e.FeatureSetHeader=n,e.parseHeader=o,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
