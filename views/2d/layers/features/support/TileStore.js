/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/has","../../../../../core/Evented","../../../tiling/TileKey","../../../tiling/TileCoverage","./Tile","../../../../../chunks/rbush"],(function(e,t,i,s,n,o,h){"use strict";const l={added:[],removed:[]},r=new Set,d=new s(0,0,0,0);return function(i){function s(e){var s;return(s=i.call(this)||this)._tiles=new Map,s._index=h.rbush(9,t("csp-restrictions")?e=>({minX:e.bounds[0],minY:e.bounds[1],maxX:e.bounds[2],maxY:e.bounds[3]}):[".bounds[0]",".bounds[1]",".bounds[2]",".bounds[3]"]),s.tiles=[],s.tileScheme=e,s}e._inheritsLoose(s,i);var u=s.prototype;return u.destroy=function(){this.clear()},u.clear=function(){this.tiles.length=0,this._tiles.clear(),this._index.clear()},u.has=function(e){return this._tiles.has(e)},u.get=function(e){return this._tiles.get(e)},u.findByKey=function(e){return this._tiles.get(e.id)},u.minLOD=function(){return Math.min(...this.tiles.map((e=>e.level)))},u.intersections=function(e,t){const i="string"==typeof e?this.get(e):e;if(!i)return[];const s=t*i.resolution,n=i.bounds[0]-s,o=i.bounds[1]-s,h=i.bounds[2]+s,l=i.bounds[3]+s,r=[];for(const d of this._index.search({minX:n,minY:o,maxX:h,maxY:l})){const e=d.bounds.slice();e[0]=Math.max(e[0],n),e[1]=Math.max(e[1],o),e[2]=Math.min(e[2],h),e[3]=Math.min(e[3],l),e[2]-e[0]>0&&e[3]-e[1]>0&&r.push({bounds:e,tile:d})}return r},u.boundsIntersections=function(e){return this._index.search({minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]})},u.updateTiles=function(e){const t={added:[],removed:[]};for(const i of e.added)if(!this.has(i)){const e=new o.Tile(this.tileScheme,i);this._tiles.set(i,e),this._index.insert(e),t.added.push(e)}for(const i of e.removed)if(this.has(i)){const e=this.get(i);this._tiles.delete(i),this._index.remove(e),t.removed.push(e)}this.tiles.length=0,this._tiles.forEach((e=>this.tiles.push(e))),(t.added.length||t.removed.length)&&this.emit("update",t)},u.setViewState=function(e){const t=this.tileScheme.getTileCoverage(e,0);if(!t)return;const{spans:i,lodInfo:s}=t,{level:h}=s;if(i.length>0)for(const{row:n,colFrom:u,colTo:c}of i)for(let e=u;e<=c;e++){const t=d.set(h,n,s.normalizeCol(e),s.getWorldForColumn(e)).id;if(r.add(t),!this.has(t)){const e=new o.Tile(this.tileScheme,t);this._tiles.set(t,e),this._index.insert(e),this.tiles.push(e),l.added.push(e)}}for(let n=this.tiles.length-1;n>=0;n--){const e=this.tiles[n];r.has(e.id)||(this._tiles.delete(e.id),this.tiles.splice(n,1),this._index.remove(e),l.removed.push(e))}(l.added.length||l.removed.length)&&this.emit("update",l),n.pool.release(t),r.clear(),l.added.length=0,l.removed.length=0},s}(i)}));
