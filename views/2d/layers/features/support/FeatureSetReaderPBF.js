// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../../core/Error","../../../../../core/Logger","../../../../../core/pbf","../../../../../layers/graphics/featureConversionUtils","../../../../../layers/graphics/OptimizedFeature","../../../../../layers/graphics/OptimizedGeometry","./FeatureSetReader","./FeatureSetReaderPBFHeader"],(function(e,t,r,i,a,n,o,s,h,u,d){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FeatureSetReaderPBF=void 0;var c=a.getLogger("esri.view.2d.layers.features.support.FeatureSetReaderPBF");function f(e){for(;e.next();)switch(e.tag()){case 1:return e.getMessage();default:e.skip()}return null}var p=function(e){function t(t,r,i,a){var n=e.call(this,t)||this;return n._hasNext=!1,n._isPoints=!1,n._isPolygons=!1,n._featureIndex=-1,n._featureOffset=0,n._cache={area:0,unquantGeometry:void 0,geometry:void 0,centroid:void 0,legacyFeature:void 0,optFeature:void 0},n._geometryType=a,n._reader=r,n._header=i,n._hasNext=i.hasFeatures,n._isPoints="esriGeometryPoint"===a,n._isPolygons="esriGeometryPolygon"===a,n}return r.__extends(t,e),t.fromBuffer=function(e,r){var a=function(e){try{for(var t=new n(new Uint8Array(e),new DataView(e));t.next();)switch(t.tag()){case 2:return f(t.getMessage());default:t.skip()}}catch(e){var r=new i("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:e});c.error(r)}return null}(e),o=d.parseHeader(a,"esriGeometryPoint"===r);return new t(u.FeatureSetReader.createInstance(),a,o,r)},Object.defineProperty(t.prototype,"geometryType",{get:function(){return this._geometryType},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"size",{get:function(){return this._header.featureCount},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"hasZ",{get:function(){return!1},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"hasM",{get:function(){return!1},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"stride",{get:function(){return 2+(this.hasZ?1:0)+(this.hasM?1:0)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"hasFeatures",{get:function(){return this._header.hasFeatures},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"hasNext",{get:function(){return this._hasNext},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"exceededTransferLimit",{get:function(){return this._header.exceededTransferLimit},enumerable:!1,configurable:!0}),t.prototype.getApproximateSize=function(){if(this._hasFilter){var e=Math.abs(this._xmax-this._xmin)*Math.abs(this._ymax-this._ymin),t=this.size*e/262144;return Math.max(Math.round(t),0)}return this.size},t.prototype.getQuantizationTransform=function(){return this._header.transform},t.prototype.getCursor=function(){return this.copy()},t.prototype.getIndex=function(){return this._featureIndex},t.prototype.setIndex=function(e){this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0,this._featureIndex=e},t.prototype.getAttributeHash=function(){var e=this,t="";return this._header.fieldIndexMap.forEach((function(r){t+=e._readAttributeAtIndex(r)+"."})),t},t.prototype.getObjectId=function(){return this._readAttributeAtIndex(this._header.objectIdFieldIndex)},t.prototype.getDisplayId=function(){return this._header.displayIds[this._featureIndex]},t.prototype.setDisplayId=function(e){this._header.displayIds[this._featureIndex]=e},t.prototype.getGroupId=function(){return this._header.groupIds[this._featureIndex]},t.prototype.setGroupId=function(e){this._header.groupIds[this._featureIndex]=e},t.prototype.readLegacyFeature=function(){var e;if(void 0===this._cache.legacyFeature){var t=this.readCentroid(),r={attributes:this.readAttributes(),geometry:this._isPoints?this.readLegacyPointGeometry():this.readLegacyGeometry(),centroid:null!==(e=t&&{x:t.coords[0],y:t.coords[1]})&&void 0!==e?e:null};return this._cache.legacyFeature=r,r}return this._cache.legacyFeature},t.prototype.readOptimizedFeature=function(){if(void 0===this._cache.optFeature){var e=new s.default(this.readGeometry(),this.readAttributes(),this.readCentroid());return this._cache.optFeature=e,e}return this._cache.optFeature},t.prototype.getXHydrate=function(){var e=this._header.centroid[2*this._featureIndex],t=this.getQuantizationTransform();return e*t.scale[0]+t.translate[0]},t.prototype.getYHydrate=function(){var e=this._header.centroid[2*this._featureIndex+1],t=this.getQuantizationTransform();return t.translate[1]-e*t.scale[1]},t.prototype.readLegacyPointGeometry=function(){return{x:this._header.centroid[2*this._featureIndex]+this._tx,y:this._header.centroid[2*this._featureIndex+1]+this._ty}},t.prototype.readLegacyGeometry=function(){var e=this.readGeometry();return o.convertToGeometry(e,this.geometryType,!1,!1)},t.prototype.readLegacyCentroid=function(){var e=this.readCentroid();if(!e)return null;var t=e.coords;return{x:t[0],y:t[1]}},t.prototype.readGeometryArea=function(){return this._cache.area?this._cache.area:(this.readGeometry(),this._cache.area)},t.prototype.readUnquantizedGeometry=function(){if(void 0===this._cache.unquantGeometry){var e=this.readGeometry();if(!e)return this._cache.unquantGeometry=null,null;for(var t=e.clone(),r=t.lengths,i=t.coords,a=0,n=2;a<r.length;a++,n+=2)for(var o=r[a],s=1;s<o;s+=1,n+=2)i[n]+=i[n-2],i[n+1]+=i[n-1];return this._cache.unquantGeometry=t,t}return this._cache.unquantGeometry},t.prototype.readHydratedGeometry=function(){var e=this.readGeometry();if(!e)return null;var t=e.clone();return this._isPoints&&(t.coords[0]-=this._tx,t.coords[1]-=this._ty),o.unquantizeOptimizedGeometry(t,t,this.hasZ,this.hasM,this.getQuantizationTransform()),t},t.prototype.readGeometry=function(){if(void 0===this._cache.geometry){var e=null;if(this._isPoints){var t=this._header.centroid[2*this._featureIndex]+this._tx,r=this._header.centroid[2*this._featureIndex+1]+this._ty;e=new h.default([],[t,r])}else{var i=this._header.offsets.geometry[this._featureIndex],a=this._reader;if(0===i)return null;a.move(i);try{e=this._parseGeometry(a)}catch(e){return console.error("Failed to parse geometry!",e),null}}return this._cache.geometry=e,e}return this._cache.geometry},t.prototype.readCentroid=function(){if(void 0===this._cache.centroid){var e=null,t=this._header.centroid[2*this._featureIndex]+this._tx,r=this._header.centroid[2*this._featureIndex+1]+this._ty;return 268435455===t?(e=this._computeCentroid())&&(this._header.centroid[2*this._featureIndex]=e.coords[0]-this._tx,this._header.centroid[2*this._featureIndex+1]=e.coords[1]-this._ty):e=new h.default([],[t,r]),this._cache.centroid=e,e}return this._cache.centroid},t.prototype.copy=function(){var e=this._reader.clone(),r=new t(this.instance,e,this._header,this.geometryType);return this.copyInto(r),r},t.prototype.next=function(){if(this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0,!this._hasFilter)return++this._featureIndex<this.size;for(;++this._featureIndex<this.size&&!this._passesFilter(););return this._featureIndex<this.size},t.prototype._readAttribute=function(e,t){var r=this._header.hasFieldIndex(e)?e:function(e){return e.toLowerCase().trim()}(e),i=this._header.getFieldIndex(r);if(null!=i){var a=this._readAttributeAtIndex(i);return t&&this._header.isDateField(r)?new Date(a):a}},t.prototype._readAttributes=function(){var e=this,t={};return this._header.fieldIndexMap.forEach((function(r,i){t[i]=e._readAttributeAtIndex(r)})),t},t.prototype.copyInto=function(t){e.prototype.copyInto.call(this,t),t._featureIndex=this._featureIndex,t._featureOffset=this._featureOffset,t._hasNext=this._hasNext},t.prototype._passesFilter=function(){if(!this._hasFilter)return!0;var e=this._header.centroid[2*this._featureIndex],t=this._header.centroid[2*this._featureIndex+1];if(268435455===e){if(this._isPolygons&&!this.readCentroid())return!1;e=this._header.centroid[2*this._featureIndex],t=this._header.centroid[2*this._featureIndex+1]}return e>=this._xmin&&e<=this._xmax&&t>=this._ymin&&t<=this._ymax},t.prototype._readAttributeAtIndex=function(e){var t=this._header.offsets.attributes[this._featureIndex*this._header.fieldCount+e],r=this._reader;return r.move(t),function(e){for(var t=e.getLength(),r=e.pos()+t;e.pos()<r&&e.next();)switch(e.tag()){case 1:var i=e.getString();return""===i?null:i;case 2:return e.getFloat();case 3:return e.getDouble();case 4:return e.getSInt32();case 5:return e.getUInt32();case 6:return e.getInt64();case 7:return e.getUInt64();case 8:return e.getSInt64();case 9:return e.getBool();default:return e.skip(),null}return null}(r)},t.prototype._preprocessPolygon=function(e,t){for(var r=0,i=0,a=0,n=!1,o=!1,s=!1,u=-1,d=[],c=0,f=!1,p=0;p<t.length;p++){for(var _=t[p],y=e[2*r],l=e[2*r+1],g=y,m=y,x=l,v=l,I=0,b=1;b<_;b++){var F=y,G=l,P=y+e[2*(r+b)],w=l+e[2*(r+b)+1],A=(P-F)*(w+G);g=Math.min(g,P),m=Math.max(m,P),x=Math.min(x,w),v=Math.max(v,w),y=P,l=w,I+=.5*A}var M=I>0;if(M&&f&&(i+=_),M||(u++,f=!1),u>=1e6)break;c+=I,n&&M&&o&&(s=!0),e[2*a]=e[2*i],e[2*a+++1]=e[2*i+++1];for(var z=1,O=e[2*i],S=e[2*i+++1],b=2;b<_;b++){var L=e[2*i],C=e[2*i+++1];O*C-L*S==0?(O+=L,S+=C):(e[2*a]=O,e[2*a+++1]=S,z++,O=L,S=C)}e[2*a]=O,e[2*a+++1]=S,z++,d.push(z),n=!1,o=!0,r+=_}return d.length?(this._cache.area=Math.abs(c),new h.default(d,e,s)):null},t.prototype._parseGeometry=function(e){for(var t=e.getLength(),r=e.pos()+t,i=[],a=[];e.pos()<r&&e.next();)switch(e.tag()){case 2:for(var n=e.getUInt32(),o=e.pos()+n;e.pos()<o;)a.push(e.getUInt32());break;case 3:for(var s=e.getUInt32(),u=e.pos()+s;e.pos()<u;)i.push(e.getSInt32()),i.push(e.getSInt32()),this.hasZ&&e.getSInt32(),this.hasM&&e.getSInt32();break;case 1:default:e.skip()}for(var d=0,c=0,f=a;c<f.length;c++){var p=f[c];i[2*d]+=this._tx,i[2*d+1]+=this._ty,d+=p}return this._isPolygons?this._preprocessPolygon(i,a):new h.default(a,i)},t}(u.FeatureSetReader);t.FeatureSetReaderPBF=p}));