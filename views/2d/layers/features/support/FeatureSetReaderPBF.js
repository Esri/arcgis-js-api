/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/maybe","../../../../../core/Logger","../../../../../core/Error","../../../../../layers/graphics/OptimizedFeature","../../../../../layers/graphics/OptimizedGeometry","../../../../../layers/graphics/featureConversionUtils","./FeatureSetReader","../../../../../core/pbf","./FeatureSetReaderPBFHeader"],(function(e,t,r,n,i,s,a,o,h,u,c){"use strict";const d=n.getLogger("esri.view.2d.layers.features.support.FeatureSetReaderPBF"),_=268435455;function f(e){return e.toLowerCase().trim()}function l(e){try{const t=2,r=new u(new Uint8Array(e),new DataView(e));for(;r.next();)switch(r.tag()){case t:return y(r.getMessage());default:r.skip()}}catch(t){const e=new i("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:t});d.error(e)}return null}function y(e){const t=1;for(;e.next();)switch(e.tag()){case t:return e.getMessage();default:e.skip()}return null}function g(e){const t=1,r=2,n=3,i=4,s=5,a=6,o=7,h=8,u=9,c=e.getLength(),d=e.pos()+c;for(;e.pos()<d&&e.next();)switch(e.tag()){case t:{const t=e.getString();return""===t?null:t}case r:return e.getFloat();case n:return e.getDouble();case i:return e.getSInt32();case s:return e.getUInt32();case a:return e.getInt64();case o:return e.getUInt64();case h:return e.getSInt64();case u:return e.getBool();default:return e.skip(),null}return null}let p=function(e){function n(t,r,n,i){var s;return(s=e.call(this,t)||this)._hasNext=!1,s._isPoints=!1,s._isPolygons=!1,s._featureIndex=-1,s._featureOffset=0,s._cache={area:0,unquantGeometry:void 0,geometry:void 0,centroid:void 0,legacyFeature:void 0,optFeature:void 0},s._geometryType=i,s._reader=r,s._header=n,s._hasNext=n.hasFeatures,s._isPoints="esriGeometryPoint"===i,s._isPolygons="esriGeometryPolygon"===i,s}t._inheritsLoose(n,e),n.fromBuffer=function(e,t,r=!1){const i=l(e),s=c.parseHeader(i,"esriGeometryPoint"===t,r);return new n(h.FeatureSetReader.createInstance(),i,s,t)};var i=n.prototype;return i.getApproximateSize=function(){if(this._hasFilter){const e=Math.abs(this._xmax-this._xmin)*Math.abs(this._ymax-this._ymin),t=this.size*e/262144;return Math.max(Math.round(t),0)}return this.size},i.getQuantizationTransform=function(){return this._header.transform},i.getCursor=function(){return this.copy()},i.getIndex=function(){return this._featureIndex},i.setIndex=function(e){this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0,this._featureIndex=e},i.getAttributeHash=function(){let e="";return this._header.fields.forEach((({index:t})=>{e+=this._readAttributeAtIndex(t)+"."})),e},i.getObjectId=function(){return this._readAttributeAtIndex(this._header.objectIdFieldIndex)},i.getDisplayId=function(){return this._header.displayIds[this._featureIndex]},i.setDisplayId=function(e){this._header.displayIds[this._featureIndex]=e},i.getGroupId=function(){return this._header.groupIds[this._featureIndex]},i.setGroupId=function(e){this._header.groupIds[this._featureIndex]=e},i.readLegacyFeature=function(){if(void 0===this._cache.legacyFeature){var e;const t=this.readCentroid(),r={attributes:this.readAttributes(),geometry:this._isPoints?this.readLegacyPointGeometry():this.readLegacyGeometry(),centroid:null!=(e=t&&{x:t.coords[0],y:t.coords[1]})?e:null};return this._cache.legacyFeature=r,r}return this._cache.legacyFeature},i.readOptimizedFeature=function(){if(void 0===this._cache.optFeature){const e=new s(this.readGeometry(),this.readAttributes(),this.readCentroid());return e.objectId=this.getObjectId(),e.displayId=this.getDisplayId(),this._cache.optFeature=e,e}return this._cache.optFeature},i.getXHydrate=function(){const e=this._header.centroid[2*this._featureIndex],t=this.getQuantizationTransform();return r.isNone(t)?e:e*t.scale[0]+t.translate[0]},i.getYHydrate=function(){const e=this._header.centroid[2*this._featureIndex+1],t=this.getQuantizationTransform();return r.isNone(t)?e:t.translate[1]-e*t.scale[1]},i.getX=function(){return this._header.centroid[2*this._featureIndex]*this._sx+this._tx},i.getY=function(){return this._header.centroid[2*this._featureIndex+1]*this._sy+this._ty},i.readLegacyPointGeometry=function(){return{x:this.getX(),y:this.getY()}},i.readLegacyGeometry=function(){const e=this.readGeometry();return o.convertToGeometry(e,this.geometryType,!1,!1)},i.readLegacyCentroid=function(){const e=this.readCentroid();if(!e)return null;const[t,r]=e.coords;return{x:t,y:r}},i.readGeometryArea=function(){return this._cache.area||this.readGeometry(),this._cache.area},i.readUnquantizedGeometry=function(){if(void 0===this._cache.unquantGeometry){const e=this.readGeometry();if(!e)return this._cache.unquantGeometry=null,null;const t=e.clone(),r=t.lengths,n=t.coords;for(let i=0,s=2;i<r.length;i++,s+=2){const e=r[i];for(let t=1;t<e;t+=1,s+=2)n[s]+=n[s-2],n[s+1]+=n[s-1]}return this._cache.unquantGeometry=t,t}return this._cache.unquantGeometry},i.readHydratedGeometry=function(){if(this._isPoints){const e=this.getXHydrate(),t=this.getYHydrate();return new a([],[e,t])}const e=this.readGeometry();if(!e)return null;const t=e.clone(),n=this.getQuantizationTransform();return r.isSome(n)&&o.unquantizeOptimizedGeometry(t,t,this.hasZ,this.hasM,n),t},i.readGeometry=function(){if(void 0===this._cache.geometry){let t=null;if(this._isPoints){const e=this.getX(),r=this.getY();t=new a([],[e,r])}else{const r=this._header.offsets.geometry[this._featureIndex],n=this._reader;if(0===r)return null;n.move(r);try{t=this._parseGeometry(n)}catch(e){return console.error("Failed to parse geometry!",e),null}}return this._cache.geometry=t,t}return this._cache.geometry},i.readCentroid=function(){if(void 0===this._cache.centroid){let e=null;const t=this._header.centroid[2*this._featureIndex]+this._tx,r=this._header.centroid[2*this._featureIndex+1]+this._ty;return t===_?(e=this._computeCentroid(),e&&(this._header.centroid[2*this._featureIndex]=e.coords[0]-this._tx,this._header.centroid[2*this._featureIndex+1]=e.coords[1]-this._ty)):e=new a([],[t,r]),this._cache.centroid=e,e}return this._cache.centroid},i.copy=function(){const e=this._reader.clone(),t=new n(this.instance,e,this._header,this.geometryType);return this.copyInto(t),t},i.next=function(){for(this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0;++this._featureIndex<this.size&&!this._passesFilter()&&!this._getExists(););return this._featureIndex<this.size},i._readAttribute=function(e,t){const r=this._header.hasField(e)?e:f(e),n=this._header.getFieldIndex(r);if(null==n)return;const i=this._readAttributeAtIndex(n);if(!t)return i;if(null==i)return i;return this._header.isDateField(r)?new Date(i):i},i._readAttributes=function(){const e={};return this._header.fields.forEach((({fieldName:t,index:r})=>{e[t]=this._readAttributeAtIndex(r)})),e},i.copyInto=function(t){e.prototype.copyInto.call(this,t),t._featureIndex=this._featureIndex,t._featureOffset=this._featureOffset,t._hasNext=this._hasNext},i._passesFilter=function(){if(!this._hasFilter)return!0;let e=this._header.centroid[2*this._featureIndex],t=this._header.centroid[2*this._featureIndex+1];if(e===_){if(this._isPolygons&&!this.readCentroid())return!1;e=this._header.centroid[2*this._featureIndex],t=this._header.centroid[2*this._featureIndex+1]}return e>=this._xmin&&e<=this._xmax&&t>=this._ymin&&t<=this._ymax},i._readAttributeAtIndex=function(e){const t=this._header.offsets.attributes[this._featureIndex*this._header.fieldCount+e],r=this._reader;return r.move(t),g(r)},i._preprocessPolygon=function(e,t){let r=0,n=0,i=0,s=!1,o=!1,h=!1,u=-1;const c=1e6,d=[];let _=0,f=!1;for(let a=0;a<t.length;a++){const l=t[a];let y=e[2*r],g=e[2*r+1],p=0;for(let t=1;t<l;t++){const n=y,i=g,s=y+e[2*(r+t)],a=g+e[2*(r+t)+1];y=s,g=a,p+=.5*((s-n)*(a+i))}const m=p>0;if(m&&f&&(n+=l),m||(u++,f=!1),u>=c)break;_+=p,s&&m&&o&&(h=!0);{e[2*i]=e[2*n],e[2*i+++1]=e[2*n+++1];let t=1,r=e[2*n],s=e[2*n+++1];for(let a=2;a<l;a++){const a=e[2*n],o=e[2*n+++1];0===r*o-a*s&&r*a+s*o>0?(r+=a,s+=o):(e[2*i]=r,e[2*i+++1]=s,t++,r=a,s=o)}e[2*i]=r,e[2*i+++1]=s,t++,d.push(t)}s=!1,o=!0,r+=l}return d.length?(this._cache.area=Math.abs(_),new a(d,e,h)):null},i._parseGeometry=function(e){const t=1,r=2,n=3,i=e.getLength(),s=e.pos()+i,o=[],h=[];for(;e.pos()<s&&e.next();)switch(e.tag()){case r:{const t=e.getUInt32(),r=e.pos()+t;for(;e.pos()<r;)h.push(e.getUInt32());break}case n:{const t=e.getUInt32(),r=e.pos()+t;for(;e.pos()<r;)o.push(e.getSInt32()),o.push(e.getSInt32()),this.hasZ&&e.getSInt32(),this.hasM&&e.getSInt32();break}case t:default:e.skip()}let u=0;for(const a of h)o[2*u]+=this._tx,o[2*u+1]+=this._ty,u+=a;return this._isPolygons?this._preprocessPolygon(o,h):new a(h,o)},t._createClass(n,[{key:"geometryType",get:function(){return this._geometryType}},{key:"size",get:function(){return this._header.featureCount}},{key:"hasZ",get:function(){return!1}},{key:"hasM",get:function(){return!1}},{key:"stride",get:function(){return 2+(this.hasZ?1:0)+(this.hasM?1:0)}},{key:"hasFeatures",get:function(){return this._header.hasFeatures}},{key:"hasNext",get:function(){return this._hasNext}},{key:"exceededTransferLimit",get:function(){return this._header.exceededTransferLimit}}]),n}(h.FeatureSetReader);e.FeatureSetReaderPBF=p,Object.defineProperty(e,"__esModule",{value:!0})}));
