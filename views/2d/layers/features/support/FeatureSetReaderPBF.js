/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/Error","../../../../../core/Logger","../../../../../core/maybe","../../../../../core/pbf","../../../../../layers/graphics/featureConversionUtils","../../../../../layers/graphics/OptimizedFeature","../../../../../layers/graphics/OptimizedGeometry","./FeatureSetReader","./FeatureSetReaderPBFHeader"],(function(e,t,r,n,s,i,a,o,h,u,c){"use strict";const d=!0,f=268435455,g=128,l=128e3,_={small:{delta:new Int32Array(g),decoded:new Int32Array(g)},large:{delta:new Int32Array(l),decoded:new Int32Array(l)}};function y(e){return e<=_.small.delta.length?_.small:(e<=_.large.delta.length||(_.large.delta=new Int32Array(Math.round(1.25*e)),_.large.decoded=new Int32Array(Math.round(1.25*e))),_.large)}function I(e){return e.toLowerCase().trim()}function p(e){try{const t=2,r=new i(new Uint8Array(e),new DataView(e));for(;r.next();){if(r.tag()===t)return m(r.getMessage());r.skip()}}catch(t){const e=new r("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:t});n.getLogger("esri.view.2d.layers.features.support.FeatureSetReaderPBF").error(e)}return null}function m(e){const t=1;for(;e.next();){if(e.tag()===t)return e.getMessage();e.skip()}return null}function x(e){const t=1,r=2,n=3,s=4,i=5,a=6,o=7,h=8,u=9,c=e.getLength(),d=e.pos()+c;for(;e.pos()<d&&e.next();)switch(e.tag()){case t:return e.getString();case r:return e.getFloat();case n:return e.getDouble();case s:return e.getSInt32();case i:return e.getUInt32();case a:return e.getInt64();case o:return e.getUInt64();case h:return e.getSInt64();case u:return e.getBool();default:return e.skip(),null}return null}function S(e,t,r,n,s,i){return.5*Math.abs(e*n+r*i+s*t-e*i-r*t-s*n)}function F(e,t,r,n){return 0===e*n-r*t&&e*r+t*n>0}let v=function(e){function r(t,r,n,s){var i;return(i=e.call(this,t,s)||this)._hasNext=!1,i._isPoints=!1,i._featureIndex=-1,i._featureOffset=0,i._cache={area:0,unquantGeometry:void 0,geometry:void 0,centroid:void 0,legacyFeature:void 0,optFeature:void 0},i._geometryType=s.geometryType,i._reader=r,i._header=n,i._hasNext=n.hasFeatures,i._isPoints="esriGeometryPoint"===s.geometryType,i}t._inheritsLoose(r,e),r.fromBuffer=function(e,t,n=!1){const s=t.geometryType,i=p(e),a=c.parseHeader(i,"esriGeometryPoint"===s,n);return new r(u.FeatureSetReader.createInstance(),i,a,t)};var n=r.prototype;return n.hasField=function(e){return this._header.hasField(e)||this._header.hasField(I(e))},n.getFieldNames=function(){return this._header.fields.map((e=>e.fieldName))},n.getSize=function(){return this._size},n.getQuantizationTransform=function(){return this._header.transform},n.getCursor=function(){return this.copy()},n.getIndex=function(){return this._featureIndex},n.setIndex=function(e){this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0,this._featureIndex=e},n.getAttributeHash=function(){let e="";return this._header.fields.forEach((({index:t})=>{e+=this._readAttributeAtIndex(t)+"."})),e},n.getObjectId=function(){return this._readAttributeAtIndex(this._header.objectIdFieldIndex)},n.getDisplayId=function(){return this._header.displayIds[this._featureIndex]},n.setDisplayId=function(e){this._header.displayIds[this._featureIndex]=e},n.getGroupId=function(){return this._header.groupIds[this._featureIndex]},n.setGroupId=function(e){this._header.groupIds[this._featureIndex]=e},n.readLegacyFeature=function(){if(void 0===this._cache.legacyFeature){const e=this.readCentroid(),t={attributes:this.readAttributes(),geometry:this._isPoints?this.readLegacyPointGeometry():this.readLegacyGeometry(),centroid:(e&&{x:e.coords[0],y:e.coords[1]})??null};return this._cache.legacyFeature=t,t}return this._cache.legacyFeature},n.readOptimizedFeature=function(){if(void 0===this._cache.optFeature){const e=new o.OptimizedFeature(this.readGeometry(),this.readAttributes(),this.readCentroid());return e.objectId=this.getObjectId(),e.displayId=this.getDisplayId(),this._cache.optFeature=e,e}return this._cache.optFeature},n.getXHydrated=function(){const e=this._header.centroid[2*this._featureIndex],t=this.getQuantizationTransform();return s.isNone(t)?e:e*t.scale[0]+t.translate[0]},n.getYHydrated=function(){const e=this._header.centroid[2*this._featureIndex+1],t=this.getQuantizationTransform();return s.isNone(t)?e:t.translate[1]-e*t.scale[1]},n.getX=function(){return this._header.centroid[2*this._featureIndex]*this._sx+this._tx},n.getY=function(){return this._header.centroid[2*this._featureIndex+1]*this._sy+this._ty},n.readLegacyPointGeometry=function(){return{x:this.getX(),y:this.getY()}},n.readLegacyGeometry=function(e){const t=this.readGeometry(e);return a.convertToGeometry(t,this.geometryType,!1,!1)},n.readLegacyCentroid=function(){const e=this.readCentroid();if(!e)return null;const[t,r]=e.coords;return{x:t,y:r}},n.readGeometryArea=function(){return this._cache.area||this.readGeometry(!0),this._cache.area},n.readUnquantizedGeometry=function(e=!1){if(void 0===this._cache.unquantGeometry){const t=this.readGeometry(e);if(!t)return this._cache.unquantGeometry=void 0,null;const r=y(t.coords.length).decoded,n=t.clone(r),s=n.coords;let i=0;for(const e of n.lengths){for(let t=1;t<e;t++){const e=2*(i+t),r=2*(i+t-1);s[e]+=s[r],s[e+1]+=s[r+1]}i+=e}return this._cache.unquantGeometry=n,n}return this._cache.unquantGeometry},n.readHydratedGeometry=function(){if(this._isPoints){if(this._header.centroid[2*this._featureIndex]===f)return null;const e=this.getXHydrated(),t=this.getYHydrated();return new h([],[e,t])}const e=this.readGeometry();if(!e)return null;const t=e.clone(),r=this.getQuantizationTransform();return s.isSome(r)&&a.unquantizeOptimizedGeometry(t,t,this.hasZ,this.hasM,r),t},n.readGeometry=function(e=!1){if(void 0===this._cache.geometry){let r=null;if(this._isPoints){if(this._header.centroid[2*this._featureIndex]===f)return null;const e=this.getX(),t=this.getY();r=new h([],[e,t])}else{const n=this._header.offsets.geometry[this._featureIndex],s=this._reader;if(0===n){const e=this._readServerCentroid();if(!e)return null;const[t,r]=e.coords;return this.createQuantizedExtrudedQuad(t,r)}s.move(n);try{if(r=e?this._parseGeometryForDisplay(s):this._parseGeometry(s),null===r){const e=this._readServerCentroid();if(!e)return null;const[t,r]=e.coords;return this.createQuantizedExtrudedQuad(t,r)}}catch(t){return console.error("Failed to parse geometry!",t),null}}return this._cache.geometry=r,r}return this._cache.geometry},n.readCentroid=function(){if(void 0===this._cache.centroid){let e;return e=this._computeCentroid(),e||(e=this._readServerCentroid()),this._cache.centroid=e??void 0,e??null}return this._cache.centroid},n.copy=function(){const e=this._reader.clone(),t=new r(this.instance,e,this._header,this.fullSchema());return this.copyInto(t),t},n.next=function(){for(this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0;++this._featureIndex<this._size&&!this._getExists(););return this._featureIndex<this._size},n._readAttribute=function(e,t){const r=this._header.hasField(e)?e:I(e),n=this._header.getFieldIndex(r);if(null==n)return;const s=this._readAttributeAtIndex(n);if(!t)return s;if(null==s)return s;return this._header.isDateField(r)?new Date(s):s},n._readAttributes=function(){const e={};return this._header.fields.forEach((({fieldName:t,index:r})=>{e[t]=this._readAttributeAtIndex(r)})),e},n.copyInto=function(t){e.prototype.copyInto.call(this,t),t._featureIndex=this._featureIndex,t._featureOffset=this._featureOffset,t._hasNext=this._hasNext},n._readAttributeAtIndex=function(e){const t=this._header.offsets.attributes[this._featureIndex*this._header.fieldCount+e],r=this._reader;return r.move(t),x(r)},n._readServerCentroid=function(){const e=this._header.centroid[2*this._featureIndex]+this._tx,t=this._header.centroid[2*this._featureIndex+1]+this._ty;return e===f?null:new h([],[e,t])},n._parseGeometry=function(e){const t=2,r=3,n=e.asUnsafe(),s=n.getLength(),i=n.pos()+s,a=[],o=[];for(;n.pos()<i&&n.next();)switch(n.tag()){case t:{const e=n.getUInt32(),t=n.pos()+e;for(;n.pos()<t;)o.push(n.getUInt32());break}case r:{const e=n.getUInt32(),t=n.pos()+e;for(a.push(n.getSInt32()+this._tx),a.push(n.getSInt32()+this._ty),this.hasZ&&n.getSInt32(),this.hasM&&n.getSInt32();n.pos()<t;)a.push(n.getSInt32()),a.push(n.getSInt32()),this.hasZ&&n.getSInt32(),this.hasM&&n.getSInt32();break}default:n.skip()}return new h(o,a)},n._parseGeometryForDisplay=function(e){const t=2,r=3,n=e.asUnsafe(),i=n.getLength(),a=n.pos()+i,o=[],u=[];let c=0,f=0,g=null,l=0;const _="esriGeometryPolygon"===this.geometryType;for(;n.pos()<a&&n.next();)switch(n.tag()){case t:{const e=n.getUInt32(),t=n.pos()+e;for(;n.pos()<t;){const e=n.getUInt32();o.push(e),c+=e}g=y(2*c).delta;break}case r:{n.getUInt32();const e=2+(this.hasZ?1:0)+(this.hasM?1:0);s.assertIsSome(g);for(const t of o)if(f+e*t>g.length)for(let e=0;e<t;e++)n.getSInt32(),n.getSInt32(),this.hasZ&&n.getSInt32(),this.hasM&&n.getSInt32();else if(_&&d){const e=this.getAreaSimplificationThreshold(t,this._header.vertexCount);let r=2,s=1;const i=!1;let a=n.getSInt32(),o=n.getSInt32();g[f++]=a,g[f++]=o,this.hasZ&&n.getSInt32(),this.hasM&&n.getSInt32();let h=n.getSInt32(),c=n.getSInt32();for(this.hasZ&&n.getSInt32(),this.hasM&&n.getSInt32();r<t;){let t=n.getSInt32(),i=n.getSInt32();this.hasZ&&n.getSInt32(),this.hasM&&n.getSInt32();const u=a+h,d=o+c;S(a,o,u,d,u+t,d+i)>=e?(l+=-.5*(u-a)*(d+o),s>1&&F(g[f-2],g[f-1],h,c)?(g[f-2]+=h,g[f-1]+=c):(g[f++]=h,g[f++]=c,s++),a=u,o=d):(t+=h,i+=c),h=t,c=i,r++}s<3||i?f-=2*s:(l+=-.5*(a+h-a)*(o+c+o),F(g[f-2],g[f-1],h,c)?(g[f-2]+=h,g[f-1]+=c,u.push(s)):(g[f++]=h,g[f++]=c,u.push(++s)))}else{let e=0,r=n.getSInt32(),s=n.getSInt32();this.hasZ&&n.getSInt32(),this.hasM&&n.getSInt32(),g[f++]=r,g[f++]=s,e+=1;for(let i=1;i<t;i++){const t=n.getSInt32(),a=n.getSInt32(),o=r+t,h=s+a;l+=-.5*(o-r)*(h+s),this.hasZ&&n.getSInt32(),this.hasM&&n.getSInt32(),i>2&&F(g[f-2],g[f-1],t,a)?(g[f-2]+=t,g[f-1]+=a):(g[f++]=t,g[f++]=a,e+=1),r=o,s=h}u.push(e)}break}default:n.skip()}if(this._cache.area=l,!u.length)return null;if(this._tx||this._ty){let e=0;s.assertIsSome(g);for(const t of u)g[2*e]+=this._tx,g[2*e+1]+=this._ty,e+=t}return new h(u,g)},t._createClass(r,[{key:"geometryType",get:function(){return this._geometryType}},{key:"_size",get:function(){return this._header.featureCount}},{key:"hasZ",get:function(){return!1}},{key:"hasM",get:function(){return!1}},{key:"stride",get:function(){return 2+(this.hasZ?1:0)+(this.hasM?1:0)}},{key:"hasFeatures",get:function(){return this._header.hasFeatures}},{key:"hasNext",get:function(){return this._hasNext}},{key:"exceededTransferLimit",get:function(){return this._header.exceededTransferLimit}}]),r}(u.FeatureSetReader);e.FeatureSetReaderPBF=v,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
