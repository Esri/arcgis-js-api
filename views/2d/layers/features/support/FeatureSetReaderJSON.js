// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../../layers/graphics/featureConversionUtils","../../../../../layers/graphics/featureConversionUtils","./FeatureSetReader"],(function(e,t,r,n,o,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FeatureSetReaderJSON=void 0;var s=function(e){function t(t,r,n){var o=e.call(this,t)||this;return o._featureIndex=-1,o._dateFields=new Set,o._geometryType=n,o._features=r,o}return r.__extends(t,e),t.fromFeatures=function(e,r,n){for(var i=o.convertFromFeatures([],e,r,!1,!1,n),s=0;s<i.length;s++)i[s].displayId=e[s].displayId;return t.fromOptimizedFeatures(i,r)},t.fromFeatureSet=function(e,r){var o=n.convertFromFeatureSet(e,r);return t.fromOptimizedFeatureSet(o)},t.fromOptimizedFeatureSet=function(e){var r=e.features,n=e.geometryType,o=t.fromOptimizedFeatures(r,n);o._exceededTransferLimit=e.exceededTransferLimit,o._transform=e.transform;for(var i=0,s=e.fields;i<s.length;i++){var a=s[i];"esriFieldTypeDate"===a.type&&o._dateFields.add(a.name)}return o},t.fromOptimizedFeatures=function(e,r,n){var o=new t(i.FeatureSetReader.createInstance(),e,r);return o._transform=n,o},Object.defineProperty(t.prototype,"_current",{get:function(){return this._features[this._featureIndex]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"geometryType",{get:function(){return this._geometryType},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"hasFeatures",{get:function(){return!!this._features.length},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"hasNext",{get:function(){return this._featureIndex+1<this._features.length},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"exceededTransferLimit",{get:function(){return this._exceededTransferLimit},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"hasZ",{get:function(){return!1},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"hasM",{get:function(){return!1},enumerable:!1,configurable:!0}),t.prototype.getApproximateSize=function(){return this._features.length},t.prototype.getCursor=function(){return this.copy()},t.prototype.getQuantizationTransform=function(){return this._transform},t.prototype.getAttributeHash=function(){var e="";for(var t in this._current.attributes)e+=this._current.attributes[t];return e},t.prototype.getIndex=function(){return this._featureIndex},t.prototype.setIndex=function(e){this._featureIndex=e},t.prototype.getObjectId=function(){return this._current.objectId},t.prototype.getDisplayId=function(){return this._current.displayId},t.prototype.setDisplayId=function(e){this._current.displayId=e},t.prototype.getGroupId=function(){return this._current.groupId},t.prototype.setGroupId=function(e){this._current.groupId=e},t.prototype.copy=function(){var e=new t(this.instance,this._features,this.geometryType);return this.copyInto(e),e},t.prototype.next=function(){if(!this._hasFilter)return++this._featureIndex<this._features.length;for(;++this._featureIndex<this._features.length&&!this._passesFilter(););return this._featureIndex<this._features.length},t.prototype.readLegacyFeature=function(){return n.convertToFeature(this._current,this.geometryType,this.hasZ,this.hasM)},t.prototype.readOptimizedFeature=function(){return this._current},t.prototype.readLegacyPointGeometry=function(){var e=this.readGeometry();return e?{x:e.coords[0],y:e.coords[1]}:null},t.prototype.readLegacyGeometry=function(){var e=this.readGeometry();return n.convertToGeometry(e,this.geometryType,this.hasZ,this.hasM)},t.prototype.readLegacyCentroid=function(){var e=this.readCentroid();return e?{x:e.coords[0],y:e.coords[1]}:null},t.prototype.readGeometryArea=function(){return n.getQuantizedArea(this._current.geometry,2)},t.prototype.readUnquantizedGeometry=function(){var e=this.readGeometry();if("esriGeometryPoint"===this.geometryType||!e)return e;var t=e.clone();return function(e){for(var t=e.coords,r=0,n=0,o=e.lengths;n<o.length;n++){for(var i=o[n],s=1;s<i;s++)t[2*(r+s)]+=t[2*(r+s)-2],t[2*(r+s)+1]+=t[2*(r+s)-1];r+=i}}(t),t},t.prototype.readHydratedGeometry=function(){var e=this._current.geometry;if(!e)return null;var t=e.clone();return n.unquantizeOptimizedGeometry(t,t,this.hasZ,this.hasM,this._transform),t},t.prototype.getXHydrate=function(){var e=this._current.geometry.coords[0]+this._tx,t=this.getQuantizationTransform();return e*t.scale[0]+t.translate[0]},t.prototype.getYHydrate=function(){var e=this._current.geometry.coords[1]+this._ty,t=this.getQuantizationTransform();return t.translate[1]-e*t.scale[1]},t.prototype.readGeometry=function(){if(!this._current.hasGeometry)return null;var e=this._current.geometry.clone();if(e.isPoint)return e.coords[0]+=this._tx,e.coords[1]+=this._ty,e;for(var t=0,r=0,n=e.lengths;r<n.length;r++){var o=n[r];e.coords[2*t]+=this._tx,e.coords[2*t+1]+=this._ty,t+=o}return e},t.prototype.readCentroid=function(){if(!this._current.hasGeometry)return null;if(!this._current.centroid){var e=this._computeCentroid();if(!e)return null;e.coords[0]-=this._tx,e.coords[1]-=this._ty,this._current.centroid=e}var t=this._current.centroid.clone();return t.coords[0]+=this._tx,t.coords[1]+=this._ty,t},t.prototype._readAttribute=function(e,t){var r=this._current.attributes[e];if(void 0!==r)return t&&this._dateFields.has(e)?new Date(r):r;var n=this.readAttributes(),o=e.toLocaleLowerCase().trim();for(var i in n)if(i.toLocaleLowerCase().trim()===o){var s=this._current.attributes[i];return this._dateFields.has(i)?new Date(s):s}},t.prototype.copyInto=function(t){e.prototype.copyInto.call(this,t),t._featureIndex=this._featureIndex,t._transform=this._transform,t._dateFields=this._dateFields},t.prototype._readAttributes=function(){return this._current.attributes},t.prototype._passesFilter=function(){var e,t;if(!this._hasFilter)return!0;var r=0,n=0;switch(this.geometryType){case"esriGeometryPoint":var o=this._current.geometry;if(!o)return!1;r=(e=o.coords)[0],n=e[1];break;case"esriGeometryPolygon":var i=this.readCentroid();if(!i)return!1;r=(t=i.coords)[0],n=t[1],r-=this._tx,n-=this._ty;break;default:return!1}return r>=this._xmin&&r<=this._xmax&&n>=this._ymin&&n<=this._ymax},t}(i.FeatureSetReader);t.FeatureSetReaderJSON=s}));