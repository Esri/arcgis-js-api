/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["../../../../../core/SetPool","../../../../../layers/graphics/data/FeatureStore","./Tile"],(function(e,t,s){"use strict";const i=[],r=new Set;return function(){function o(){this._tileById=new Map,this._tilesToFeatures=new Map,this._featureToTiles=new Map}var a=o.prototype;return a.destroy=function(){this.clear()},a.add=function(t){if(this.has(t.id))return;const i=t;this._tileById.set(i.id,i),this._tilesToFeatures.set(i,e.acquire()),this._tilesToFeatures.forEach(((e,t)=>{i!==t&&(s.isParentOf(i,t)?e.forEach((e=>{this._link(i,e)})):s.isChildOf(i,t)&&this.featureStore.forEachInBounds(i.bounds,(t=>{e.has(t.objectId)&&this._link(i,t.objectId)})))}))},a.clear=function(){this._tilesToFeatures.forEach((t=>e.release(t))),this._tilesToFeatures.clear(),this._featureToTiles.forEach((t=>e.release(t))),this._featureToTiles.clear(),this._tileById.clear()},a.delete=function(e){const t=this.get(e.id);i.length=0,this._tilesToFeatures.get(t).forEach((e=>{const s=this._featureToTiles.get(e);s.has(t)&&1===s.size?i.push(e):this._unlink(t,e)}));for(const s of i)this._unlink(t,s);this.featureStore.removeManyById(i),this._tilesToFeatures.delete(t),this._tileById.delete(t.id),i.length=0},a.forEach=function(e,t){return this._tileById.forEach(e,t)},a.get=function(e){return this._tileById.get(e)},a.has=function(e){return this._tileById.has(e)},a.setTileFeatures=function(t,s){const o=this.get(t.id);this._tilesToFeatures.has(o)||(this._tileById.set(o.id,o),this._tilesToFeatures.set(o,e.acquire()));for(const e of s)r.add(e.objectId);i.length=0,this._tilesToFeatures.get(o).forEach((e=>{if(!r.has(e)){const t=this._featureToTiles.get(e);t.has(o)&&1===t.size?i.push(e):this._unlink(o,e)}}));for(const e of i)this._unlink(o,e);this.featureStore.removeManyById(i),this.featureStore.addMany(s),r.forEach((e=>{this._link(o,e)})),r.clear(),i.length=0},a.addOrUpdateFeatures=function(e){const s=new Set,i=new t({geometryType:this.featureStore.geometryType,hasM:this.featureStore.hasM,hasZ:this.featureStore.hasZ});for(const t of this.deleteFeaturesById(e.map((e=>e.objectId))))s.add(t);i.addMany(e),this._tileById.forEach((e=>{i.forEachInBounds(e.bounds,(t=>{this._link(e,t.objectId),s.add(e)}))})),this.featureStore.addMany(e);const r=[];return s.forEach((e=>r.push(e))),r},a.deleteFeaturesById=function(t){const s=new Set;for(const r of t){const t=this._featureToTiles.get(r);t&&(t.forEach((e=>{s.add(e),this._tilesToFeatures.get(e).delete(r)})),e.release(t),this._featureToTiles.delete(r))}this.featureStore.removeManyById(t);const i=[];return s.forEach((e=>i.push(e))),i},a._link=function(t,s){this._featureToTiles.get(s)||this._featureToTiles.set(s,e.acquire()),this._featureToTiles.get(s).add(t),this._tilesToFeatures.get(t).add(s)},a._unlink=function(t,s){this._featureToTiles.get(s).delete(t),this._tilesToFeatures.get(t).delete(s),0===this._featureToTiles.get(s).size&&(e.release(this._featureToTiles.get(s)),this._featureToTiles.delete(s))},o}()}));
