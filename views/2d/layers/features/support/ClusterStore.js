/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../geometry","../../../../../core/Evented","../../../../../core/has","../../../../../core/maybe","../../../../../core/accessorSupport/diffUtils","../../../../../geohash/GeohashTree","../../../../../geohash/geohashUtils","../../../../../geometry/support/aaBoundingBox","../../../../../geometry/support/Ellipsoid","../../../../../geometry/support/spatialReferenceUtils","../../../../../layers/graphics/featureConversionUtils","../../../../../layers/graphics/OptimizedFeature","../../../../../layers/graphics/OptimizedGeometry","../../../../../layers/graphics/data/projectionSupport","../../../engine/webgl/definitions","../../../engine/webgl/DisplayId","../FeatureStore2D","../Store2D","./FeatureSetReaderJSON","../../../../../geometry/SpatialReference","../../../../../geometry/Polygon","../../../../../geometry/Extent"],(function(e,t,s,r,o,i,a,n,h,u,l,c,g,d,f,_,p,y,m,I,v,S,b,L){"use strict";const R=12,E=64,T=1,M=u.create();let C=function(e){function s(t,s,r,o,i){var a;const n=new f([],[s,r]);return(a=e.call(this,n,o,null,t)||this).geohashBoundsInfo=i,a}t._inheritsLoose(s,e),s.create=function(e,t,r,o,i,a,n,h){const u=new s(t,r,o,a,n);return u.displayId=e.createDisplayId(!0),u.referenceId=h,u.tileLevel=i,u};var r=s.prototype;return r.update=function(e,t,s,r,o,i){return this.geometry.coords[0]=e,this.geometry.coords[1]=t,this.tileLevel=s,this.attributes=r,this.geohashBoundsInfo=o,this.referenceId=null,this.referenceId=i,this},r.toJSON=function(){return{attributes:{...this.attributes,aggregateId:this.objectId,referenceId:1===this.attributes.cluster_count?this.referenceId:null},geometry:{x:this.geometry.coords[0],y:this.geometry.coords[1]}}},t._createClass(s,[{key:"count",get:function(){return this.attributes.cluster_count}}]),s}(d.OptimizedFeatureWithGeometry);function F(e){return 57.29577951308232*e}let x=function(e){function s(t,s,o,i){var a;return(a=e.call(this,t,o)||this).type="cluster",a.events=new r,a.objectIdField="aggregateId",a.featureAdapter=m.featureAdapter,a._geohashLevel=0,a._tileLevel=0,a._aggregateValueRanges={},a._aggregateValueRangesChanged=!1,a._geohashBuf=[],a._clusters=new Map,a._tiles=new Map,a._serviceInfo=i,a.geometryInfo=t.geometryInfo,a._spatialReference=s,a._projectionSupportCheck=_.checkProjectionSupport(s,S.WGS84),a._bitsets.geohash=o.getBitset(o.createBitset()),a._bitsets.inserted=o.getBitset(o.createBitset()),a}t._inheritsLoose(s,e);var u=s.prototype;return u.destroy=function(){this._tree.destroy()},u.updateSchema=function(){var s=t._asyncToGenerator((function*(t,s){const r=this._schema;try{yield e.prototype.updateSchema.call(this,t,s),yield this._projectionSupportCheck}catch(u){}this._fields=this._schema.params.fields;const h=a.diff(r,s);s&&(!i.isNone(h)||t.source||t.storage.filters)?((a.hasDiff(h,"params.fields")||!this._tree||t.source)&&(this._tree&&this._tree.destroy(),this._tree=new n.GeohashTree(this._statisticFields,this._serviceInfo),this._rebuildTree(),o("esri-2d-update-debug")&&console.debug("Aggregate mesh needs update due to tree changing")),o("esri-2d-update-debug")&&console.debug("Applying Update - ClusterStore:",h),t.targets[s.name]=!0,t.mesh=!1,this._aggregateValueRanges={}):r&&(t.mesh=!0)}));function r(e,t){return s.apply(this,arguments)}return r}(),u.clear=function(){this._rebuildTree()},u.sweepFeatures=function(e,t){this._bitsets.inserted.forEachSet((s=>{if(!e.has(s)){const e=t.lookupByDisplayIdUnsafe(s);this._remove(e)}}))},u.sweepAggregates=function(e,t,s){this._clusters.forEach(((r,o)=>{r&&r.tileLevel!==s&&(e.releaseDisplayId(r.displayId),t.unsetAttributeData(r.displayId),this._clusters.delete(o))}))},u.onTileData=function(e,t,s,r,o=!0){if(!this._schema||i.isNone(t.addOrUpdate))return t;this.events.emit("changed");const a=this._getTransforms(e,this._spatialReference);{const e=t.addOrUpdate.getCursor();for(;e.next();)this._update(e,r)}if(t.status.mesh||!o)return t;const n=new Array,h=this._schema.params.clusterRadius;this._getClustersForTile(n,e,h,s,a),t.addOrUpdate=v.FeatureSetReaderJSON.fromOptimizedFeatures(n,this._serviceInfo),t.addOrUpdate.attachStorage(s),t.clear=!0,t.end=!0;{const r=t.addOrUpdate.getCursor();for(;r.next();){const t=r.getDisplayId();this._bitsets.computed.unset(t),this.setComputedAttributes(s,r,t,e.scale)}}return this._aggregateValueRangesChanged&&t.end&&(this.events.emit("valueRangesChanged",{valueRanges:this._aggregateValueRanges}),this._aggregateValueRangesChanged=!1),t},u.onTileUpdate=function({added:e,removed:t}){if(e.length){const t=e[0].level;this._tileLevel=t,this._setGeohashLevel(t)}if(!this._schema)return;const s=this._schema.params.clusterRadius;t.forEach((e=>{this._tiles.delete(e.key.id),this._markTileClustersForDeletion(e,s)}))},u.getAggregate=function(e){for(const t of this._clusters.values())if((t?.displayId&y.DISPLAY_ID_TEXEL_MASK)==(e&y.DISPLAY_ID_TEXEL_MASK))return t.toJSON();return null},u.getAggregates=function(){const e=[];for(const t of this._clusters.values())t?.tileLevel===this._tileLevel&&e.push(t.toJSON());return e},u.getDisplayId=function(e){const t=this._clusters.get(e);return t?t.displayId:null},u.getFeatureDisplayIdsForAggregate=function(e){const t=this._clusters.get(e);return t?this._tree.getRegionDisplayIds(t.geohashBoundsInfo):[]},u.getDisplayIdForReferenceId=function(e){for(const t of this._clusters.values())if(t?.referenceId===e)return t.displayId;return null},u.getAggregateValueRanges=function(){return this._aggregateValueRanges},u.forEach=function(e){this._clusters.forEach((t=>{if(!t)return;const s=t.toJSON(),r=v.FeatureSetReaderJSON.fromFeatures([s],{objectIdField:this.objectIdField,globalIdField:null,geometryType:this.geometryInfo.geometryType,fields:this.fields}).getCursor();r.next(),e(r)}))},u.forEachInBounds=function(e,t){},u.forEachBounds=function(e,t){const{hasM:s,hasZ:r}=this.geometryInfo;for(const o of e){const e=g.getBoundsOptimizedGeometry(M,o.readGeometry(),r,s);i.isNone(e)||t(e)}},u.size=function(){let e=0;return this.forEach((t=>e++)),e},u._rebuildTree=function(){this._bitsets.computed.clear(),this._bitsets.inserted.clear(),this._tree&&this._tree.clear()},u._remove=function(e){const t=e.getDisplayId(),s=e.getXHydrated(),r=e.getYHydrated(),o=this._geohashBuf[2*t],i=this._geohashBuf[2*t+1];this._bitsets.inserted.has(t)&&(this._bitsets.inserted.unset(t),this._tree.removeCursor(e,s,r,o,i,this._geohashLevel))},u._update=function(e,t){const s=e.getDisplayId(),r=this._bitsets.inserted,o=t.isVisible(s);if(o===r.has(s))return;if(!o)return void this._remove(e);const i=e.getXHydrated(),a=e.getYHydrated();if(!this._setGeohash(s,i,a))return;const n=this._geohashBuf[2*s],h=this._geohashBuf[2*s+1];this._tree.insertCursor(e,s,i,a,n,h,this._geohashLevel),r.set(s)},u._setGeohash=function(e,t,s){if(this._bitsets.geohash.has(e))return!0;const r=this._geohashBuf;if(this._spatialReference.isWebMercator){const o=F(t/l.earth.radius),i=o-360*Math.floor((o+180)/360),a=F(Math.PI/2-2*Math.atan(Math.exp(-s/l.earth.radius)));h.setGeohashBuf(r,e,a,i,R)}else{const o={x:t,y:s},i=_.project(o,this._spatialReference,S.WGS84);if(!i)return!1;h.setGeohashBuf(r,e,i.y,i.x,R)}return this._bitsets.geohash.set(e),!0},u._getClustersForTile=function(e,t,s,r,o,a=!0){const n=this._schema.params.clusterPixelBuffer,h=2*s,u=Math.ceil(2**t.key.level*p.TILE_SIZE/h)+1,l=Math.ceil(n/h)+0,c=Math.ceil(p.TILE_SIZE/h),{row:f,col:_}=t.key,y=_*p.TILE_SIZE,m=f*p.TILE_SIZE,I=Math.floor(y/h)-l,v=Math.floor(m/h)-l,S=I+c+2*l,b=v+c+2*l,L=t.tileInfoView.getLODInfoAt(t.key.level);for(let p=I;p<=S;p++)for(let s=v;s<=b;s++){let n=p;L.wrap&&(n=p<0?p+u:p%u);const h=L.wrap&&p<0,l=L.wrap&&p%u!==p,c=this._lookupCluster(r,L,t.key.level,n,s,t);if(i.isSome(c)){const t=i.applySome(o,(e=>h?e.left:l?e.right:e.tile));if(a&&i.isNone(t))continue;if(!c.count)continue;if(i.isSome(t)&&a){const s=c.geometry.clone();let r=c.attributes;s.coords[0]=g.quantizeX(t,s.coords[0]),s.coords[1]=g.quantizeY(t,s.coords[1]),1===c.count&&i.isSome(c.referenceId)&&(r={...c.attributes,referenceId:c.referenceId});const o=new d.OptimizedFeature(s,r);o.displayId=c.displayId,e.push(o)}}}},u._getGeohashLevel=function(e){return Math.min(Math.ceil(e/2+2),R)},u._setGeohashLevel=function(e){const t=this._getGeohashLevel(e),s=(Math.floor(t/T)+1)*T-1;if(this._geohashLevel!==s)return this._geohashLevel=s,this._rebuildTree(),void this._bitsets.geohash.clear()},u._getTransforms=function(e,t){const s={originPosition:"upperLeft",scale:[e.resolution,e.resolution],translate:[e.bounds[0],e.bounds[3]]},r=c.getInfo(t);if(!r)return{tile:s,left:null,right:null};const[o,i]=r.valid;return{tile:s,left:{...s,translate:[i,e.bounds[3]]},right:{...s,translate:[o-i+e.bounds[0],e.bounds[3]]}}},u._getClusterId=function(e,t,s){return(15&e)<<28|(16383&t)<<14|16383&s},u._markForDeletion=function(e,t,s){const r=this._getClusterId(e,t,s);this._clusters.delete(r)},u._getClusterBounds=function(e,t,s){const r=this._schema.params.clusterRadius,o=2*r;let i=s%2?t*o:t*o-r;const a=s*o;let n=i+o;const h=a-o,u=2**e.level*p.TILE_SIZE;e.wrap&&i<0&&(i=0),e.wrap&&n>u&&(n=u);const l=i/p.TILE_SIZE,c=a/p.TILE_SIZE,g=n/p.TILE_SIZE,d=h/p.TILE_SIZE;return[e.getXForColumn(l),e.getYForRow(c),e.getXForColumn(g),e.getYForRow(d)]},u._getGeohash=function(e,t,s){const r={geohashX:0,geohashY:0};return h.setGeohashXY(r,t,e,s),r},u._getGeohashBounds=function(e,t){const s=this._getGeohashLevel(e.key.level);if(this._spatialReference.isWebMercator){const[e,r,o,i]=t,a={x:e,y:r},n={x:o,y:i};let u=0,c=0,g=0,d=0;{const e=F(a.x/l.earth.radius);u=e-360*Math.floor((e+180)/360),c=F(Math.PI/2-2*Math.atan(Math.exp(-a.y/l.earth.radius)))}{const e=F(n.x/l.earth.radius);g=e-360*Math.floor((e+180)/360),d=F(Math.PI/2-2*Math.atan(Math.exp(-n.y/l.earth.radius)))}const f={geohashX:0,geohashY:0},_={geohashX:0,geohashY:0};h.setGeohashXY(f,c,u,s),h.setGeohashXY(_,d,g,s);return{bounds:[e,r,o,i],geohashBounds:{xLL:f.geohashX,yLL:f.geohashY,xTR:_.geohashX,yTR:_.geohashY},level:s}}const r=b.fromExtent(L.fromBounds(t,this._spatialReference)),o=_.project(r,this._spatialReference,S.WGS84,{densificationStep:e.resolution*E});if(!o)return null;const i=g.convertFromPolygon(new f,o,!1,!1),a=i.coords.filter(((e,t)=>!(t%2))),n=i.coords.filter(((e,t)=>t%2)),u=Math.min(...a),c=Math.min(...n),d=Math.max(...a),p=Math.max(...n),y=this._getGeohash(u,c,s),m=this._getGeohash(d,p,s);return{bounds:t,geohashBounds:{xLL:y.geohashX,yLL:y.geohashY,xTR:m.geohashX,yTR:m.geohashY},level:s}},u._lookupCluster=function(e,t,s,r,o,a){const n=this._getClusterId(s,r,o),h=this._clusters.get(n),u=this._getClusterBounds(t,r,o),l=this._getGeohashBounds(a,u);if(i.isNone(l))return null;const c=this._tree.getRegionStatistics(l),{count:g,xTotal:d,yTotal:f,referenceId:_}=c,p=g?d/g:0,y=g?f/g:0;if(0===g)return this._clusters.set(n,null),null;const m={cluster_count:g,...c.attributes},I=i.isSome(h)?h.update(p,y,s,m,l,_):C.create(e,n,p,y,s,m,l,_);if(0===g){const[e,t,s,r]=u;I.geometry.coords[0]=(e+s)/2,I.geometry.coords[1]=(t+r)/2}return this._clusters.set(n,I),this._updateAggregateValueRangeForCluster(I,I.tileLevel),I},u._updateAggregateValueRangeForCluster=function(e,t){const s=this._aggregateValueRanges[t]||{minValue:1/0,maxValue:0},r=s.minValue,o=s.maxValue;s.minValue=Math.min(r,e.count),s.maxValue=Math.max(o,e.count),this._aggregateValueRanges[t]=s,r===s.minValue&&o===s.maxValue||(this._aggregateValueRangesChanged=!0)},u._markTileClustersForDeletion=function(e,t){const s=2*t,r=Math.ceil(p.TILE_SIZE/s),{row:o,col:i}=e.key,a=i*p.TILE_SIZE,n=o*p.TILE_SIZE,h=Math.floor(a/s),u=Math.floor(n/s);for(let l=h;l<h+r;l++)for(let t=u;t<u+r;t++)this._markForDeletion(e.key.level,l,t)},t._createClass(s,[{key:"featureSpatialReference",get:function(){return this._spatialReference}},{key:"fields",get:function(){return this._fields}}]),s}(I.Store2D);e.ClusterInfo=C,e.ClusterStore=x,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
