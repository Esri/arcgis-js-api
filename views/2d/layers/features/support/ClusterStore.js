/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../geometry","../../../../../core/Evented","../../../../../core/has","../../../../../core/maybe","../../../../../core/accessorSupport/diffUtils","../../../../../geohash/GeohashTree","../../../../../geohash/geohashUtils","../../../../../geometry/support/Ellipsoid","../../../../../geometry/support/spatialReferenceUtils","../../../../../layers/graphics/featureConversionUtils","../../../../../layers/graphics/OptimizedFeature","../../../../../layers/graphics/OptimizedGeometry","../../../../../layers/graphics/data/projectionSupport","../../../engine/webgl/definitions","../Store2D","./FeatureSetReaderJSON","../../../../../geometry/SpatialReference"],(function(e,t,s,r,i,o,a,n,l,h,u,c,g,d,f,_,p,y,m){"use strict";const I=12,v=1;let b=function(e){function s(t,s,r,i,o){var a;const n=new d([],[s,r]);return(a=e.call(this,n,i,null,t)||this).geohashBoundsInfo=o,a}t._inheritsLoose(s,e),s.create=function(e,t,r,i,o,a,n,l){const h=new s(t,r,i,a,n);return h.displayId=e.createDisplayId(!0),h.referenceId=l,h.tileLevel=o,h};var r=s.prototype;return r.update=function(e,t,s,r,i,o){return this.geometry.coords[0]=e,this.geometry.coords[1]=t,this.tileLevel=s,this.attributes=r,this.geohashBoundsInfo=i,this.referenceId=null,this.referenceId=o,this},r.toJSON=function(){return{objectId:this.objectId,referenceId:1===this.attributes.cluster_count?this.referenceId:null,attributes:{...this.attributes,clusterId:this.objectId},geometry:{x:this.geometry.coords[0],y:this.geometry.coords[1]}}},t._createClass(s,[{key:"count",get:function(){return this.attributes.cluster_count}}]),s}(g.OptimizedFeatureWithGeometry);function L(e){return 57.29577951308232*e}let S=function(e){function s(t,s,i){var o;return(o=e.call(this,t,i)||this).events=new r,o._geohashLevel=0,o._tileLevel=0,o._aggregateValueRanges={},o._aggregateValueRangesChanged=!1,o._geohashBuf=[],o._clusters=new Map,o._tiles=new Map,o.geometryInfo=t.geometryInfo,o._spatialReference=s,o._projectionSupportCheck=f.checkProjectionSupport(s,m.WGS84),o._bitsets.geohash=i.getBitset(i.createBitset()),o._bitsets.inserted=i.getBitset(i.createBitset()),o}t._inheritsLoose(s,e);var d=s.prototype;return d.updateSchema=function(){var s=t._asyncToGenerator((function*(t,s){const r=this._schema;try{yield e.prototype.updateSchema.call(this,t,s),yield this._projectionSupportCheck}catch(h){}const l=a.diff(r,s);s&&(!o.isNone(l)||t.source||t.storage.filters)?((a.hasDiff(l,"params.fields")||!this._tree||t.source)&&(this._tree=new n.GeohashTree(this._statisticFields),this._rebuildTree(),i("esri-2d-update-debug")&&console.debug("Aggregate mesh needs update due to tree changing")),i("esri-2d-update-debug")&&console.debug("Applying Update - ClusterStore:",l),t.targets[s.name]=!0,t.mesh=!1,this._aggregateValueRanges={}):r&&(t.mesh=!0)}));function r(e,t){return s.apply(this,arguments)}return r}(),d.clear=function(){this._rebuildTree()},d.sweepFeatures=function(e,t){this._bitsets.inserted.forEachSet((s=>{if(!e.has(s)){const e=t.lookupByDisplayIdUnsafe(s);this._remove(e)}}))},d.sweepClusters=function(e,t,s){this._clusters.forEach(((r,i)=>{r&&r.tileLevel!==s&&(e.releaseDisplayId(r.displayId),t.unsetAttributeData(r.displayId),this._clusters.delete(i))}))},d.onTileData=function(e,t,s,r,i=!0){if(!this._schema||o.isNone(t.addOrUpdate))return t;const a=this._getTransforms(e,this._spatialReference);{const e=t.addOrUpdate.getCursor();for(;e.next();)this._update(e,r)}if(t.status.mesh||!i)return t;const n=new Array,l=this._schema.params.clusterRadius;this._getClustersForTile(n,e,l,s,a),t.addOrUpdate=y.FeatureSetReaderJSON.fromOptimizedFeatures(n,"esriGeometryPoint"),t.addOrUpdate.attachStorage(s),t.end=!0;{const r=t.addOrUpdate.getCursor();for(;r.next();){const t=r.getDisplayId();this._bitsets.computed.unset(t),this.setComputedAttributes(s,r,t,e.scale)}}return this._aggregateValueRangesChanged&&t.end&&(this.events.emit("valueRangesChanged",{valueRanges:this._aggregateValueRanges}),this._aggregateValueRangesChanged=!1),t},d.onTileUpdate=function({added:e,removed:t}){if(e.length){const t=e[0].level;this._tileLevel=t,this._setGeohashLevel(t)}if(!this._schema)return;const s=this._schema.params.clusterRadius;t.forEach((e=>{this._tiles.delete(e.key.id),this._markTileClustersForDeletion(e,s)}))},d.getAggregate=function(e){for(const t of this._clusters.values())if((null==t?void 0:t.displayId)===e)return t.toJSON();return null},d.getAggregates=function(){const e=[];for(const t of this._clusters.values())(null==t?void 0:t.tileLevel)===this._tileLevel&&e.push(t.toJSON());return e},d.getDisplayId=function(e){const t=this._clusters.get(e);return t?t.displayId:null},d.getFeatureDisplayIdsForAggregate=function(e){const t=this._clusters.get(e);if(!t)return[];const s=t.geohashBoundsInfo;return this._tree.getRegionDisplayIds(s.xLL,s.yLL,s.xTR,s.yTR,s.level)},d.getDisplayIdForReferenceId=function(e){for(const t of this._clusters.values())if((null==t?void 0:t.referenceId)===e)return t.displayId;return null},d.getAggregateValueRanges=function(){return this._aggregateValueRanges},d.forEach=function(e){for(const[t,s]of this._clusters)s&&e(s,t)},d.size=function(){let e=0;return this.forEach((t=>e++)),e},d._rebuildTree=function(){this._bitsets.computed.clear(),this._bitsets.inserted.clear(),this._tree&&this._tree.clear()},d._remove=function(e){const t=e.getDisplayId(),s=e.getXHydrated(),r=e.getYHydrated(),i=this._geohashBuf[2*t],o=this._geohashBuf[2*t+1];this._bitsets.inserted.has(t)&&(this._bitsets.inserted.unset(t),this._tree.removeCursor(e,s,r,i,o,this._geohashLevel))},d._update=function(e,t){const s=e.getDisplayId(),r=this._bitsets.inserted,i=t.isVisible(s);if(i===r.has(s))return;if(!i)return void this._remove(e);const o=e.getXHydrated(),a=e.getYHydrated();if(!this._setGeohash(s,o,a))return;const n=this._geohashBuf[2*s],l=this._geohashBuf[2*s+1];this._tree.insertCursor(e,s,o,a,n,l,this._geohashLevel),r.set(s)},d._setGeohash=function(e,t,s){if(this._bitsets.geohash.has(e))return!0;const r=this._geohashBuf;if(this._spatialReference.isWebMercator){const i=L(t/h.earth.radius),o=i-360*Math.floor((i+180)/360),a=L(Math.PI/2-2*Math.atan(Math.exp(-s/h.earth.radius)));l.setGeohashBuf(r,e,a,o,I)}else{const i={x:t,y:s},o=f.project(i,this._spatialReference,m.WGS84);if(!o)return!1;l.setGeohashBuf(r,e,o.y,o.x,I)}return this._bitsets.geohash.set(e),!0},d._getClustersForTile=function(e,t,s,r,i,a=!0){const n=this._schema.params.clusterPixelBuffer,l=2*s,h=this._getGeohashLevel(t.key.level),u=Math.ceil(2**t.key.level*_.TILE_SIZE/l),d=Math.ceil(n/l)+0,f=Math.ceil(_.TILE_SIZE/l),{row:p,col:y}=t.key,m=y*_.TILE_SIZE,I=p*_.TILE_SIZE,v=Math.floor(m/l)-d,b=Math.floor(I/l)-d,L=v+f+2*d,S=b+f+2*d,R=t.tileInfoView.getLODInfoAt(t.key.level);for(let _=v;_<=L;_++)for(let s=b;s<=S;s++){let n=_;R.wrap&&(n=_<0?_+u:_%u);const l=R.wrap&&_<0,d=R.wrap&&_%u!==_,f=this._lookupCluster(r,R,t.key.level,n,s,h);if(o.isSome(f)){const t=o.andThen(i,(e=>l?e.left:d?e.right:e.tile));if(a&&o.isNone(t))continue;if(!f.count)continue;if(o.isSome(t)&&a){const s=f.geometry.clone();let r=f.attributes;s.coords[0]=c.quantizeX(t,s.coords[0]),s.coords[1]=c.quantizeY(t,s.coords[1]),1===f.count&&o.isSome(f.referenceId)&&(r={...f.attributes,referenceId:f.referenceId});const i=new g.default(s,r);i.displayId=f.displayId,e.push(i)}}}},d._getGeohashLevel=function(e){return Math.min(Math.ceil(e/2+2),I)},d._setGeohashLevel=function(e){const t=this._getGeohashLevel(e),s=(Math.floor(t/v)+1)*v-1;if(this._geohashLevel!==s)return this._geohashLevel=s,this._rebuildTree(),void this._bitsets.geohash.clear()},d._getTransforms=function(e,t){const s={originPosition:"upperLeft",scale:[e.resolution,e.resolution],translate:[e.bounds[0],e.bounds[3]]},r=u.getInfo(t);if(!r)return{tile:s,left:null,right:null};const[i,o]=r.valid;return{tile:s,left:{...s,translate:[o,e.bounds[3]]},right:{...s,translate:[i-o+e.bounds[0],e.bounds[3]]}}},d._getClusterId=function(e,t,s){return(15&e)<<28|(16383&t)<<14|16383&s},d._markForDeletion=function(e,t,s){const r=this._getClusterId(e,t,s);this._clusters.delete(r)},d._getClusterBounds=function(e,t,s){const r=this._schema.params.clusterRadius,i=2*r;let o=s%2?t*i:t*i-r;const a=s*i;let n=o+i;const l=a-i,h=2**e.level*_.TILE_SIZE;e.wrap&&o<0&&(o=0),e.wrap&&n>h&&(n=h);const u=o/_.TILE_SIZE,c=a/_.TILE_SIZE,g=n/_.TILE_SIZE,d=l/_.TILE_SIZE;return[e.getXForColumn(u),e.getYForRow(c),e.getXForColumn(g),e.getYForRow(d)]},d._lookupCluster=function(e,t,s,r,i,a){const n=this._getClusterId(s,r,i),u=this._clusters.get(n),[c,g,d,_]=this._getClusterBounds(t,r,i),p={x:c,y:g},y={x:d,y:_};let I=0,v=0,S=0,R=0;if(this._spatialReference.isWebMercator){{const e=L(p.x/h.earth.radius);I=e-360*Math.floor((e+180)/360),v=L(Math.PI/2-2*Math.atan(Math.exp(-p.y/h.earth.radius)))}{const e=L(y.x/h.earth.radius);S=e-360*Math.floor((e+180)/360),R=L(Math.PI/2-2*Math.atan(Math.exp(-y.y/h.earth.radius)))}}else{const e=f.project(p,this._spatialReference,m.WGS84),t=f.project(y,this._spatialReference,m.WGS84);if(!e||!t)return null;I=e.x,v=e.y,S=t.x,R=t.y}const T={geohashX:0,geohashY:0},C={geohashX:0,geohashY:0};l.setGeohashXY(T,v,I,a),l.setGeohashXY(C,R,S,a);const E=T.geohashX,M=T.geohashY,x=C.geohashX,V=C.geohashY,F={xLL:E,yLL:M,xTR:x,yTR:V,level:a},w=this._tree.getRegionStatistics(E,M,x,V,a),{count:G,xTotal:k,yTotal:B,referenceId:D}=w,O=G?k/G:0,A=G?B/G:0;if(0===G)return this._clusters.set(n,null),null;const U={cluster_count:G,...w.attributes},Z=o.isSome(u)?u.update(O,A,s,U,F,D):b.create(e,n,O,A,s,U,F,D);return 0===G&&(Z.geometry.coords[0]=(c+d)/2,Z.geometry.coords[1]=(g+_)/2),this._clusters.set(n,Z),this._updateAggregateValueRangeForCluster(Z,Z.tileLevel),Z},d._updateAggregateValueRangeForCluster=function(e,t){const s=this._aggregateValueRanges[t]||{minValue:1/0,maxValue:0},r=s.minValue,i=s.maxValue;s.minValue=Math.min(r,e.count),s.maxValue=Math.max(i,e.count),this._aggregateValueRanges[t]=s,r===s.minValue&&i===s.maxValue||(this._aggregateValueRangesChanged=!0)},d._markTileClustersForDeletion=function(e,t){const s=2*t,r=Math.ceil(_.TILE_SIZE/s),{row:i,col:o}=e.key,a=o*_.TILE_SIZE,n=i*_.TILE_SIZE,l=Math.floor(a/s),h=Math.floor(n/s);for(let u=l;u<l+r;u++)for(let t=h;t<h+r;t++)this._markForDeletion(e.key.level,u,t)},s}(p.Store2D);e.ClusterInfo=b,e.ClusterStore=S,Object.defineProperty(e,"__esModule",{value:!0})}));
