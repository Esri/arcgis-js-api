/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/has","../../../../../core/maybe","../../../../../geometry/support/spatialReferenceUtils","../../../../../geometry/SpatialReference","../../../../../geometry/support/Ellipsoid","../../../../../geometry","../../../../../core/Evented","../../../../../core/accessorSupport/diffUtils","../../../../../layers/graphics/OptimizedFeature","../../../../../layers/graphics/OptimizedGeometry","../../../../../layers/graphics/featureConversionUtils","../../../../../geohash/geohashUtils","./FeatureSetReaderJSON","../../../../../geohash/GeohashTree","../../../../../layers/graphics/data/projectionSupport","../../../engine/webgl/definitions","../Store2D"],(function(e,t,s,r,a,o,i,n,h,l,u,c,g,d,f,_,p,y,I){"use strict";let m=function(e){function s(t,s,r,a,o){var i;const n=new c([],[s,r]);return(i=e.call(this,n,a,null,t)||this).geohashBoundsInfo=o,i}t._inheritsLoose(s,e),s.create=function(e,t,r,a,o,i,n,h){const l=new s(t,r,a,i,n);return l.displayId=e.createDisplayId(!0),l.referenceId=h,l.tileLevel=o,l};var r=s.prototype;return r.update=function(e,t,s,r,a,o){return this.geometry.coords[0]=e,this.geometry.coords[1]=t,this.tileLevel=s,this.attributes=r,this.geohashBoundsInfo=a,this.referenceId=null,this.referenceId=o,this},r.toJSON=function(){return{objectId:this.objectId,referenceId:1===this.attributes.cluster_count?this.referenceId:null,attributes:{...this.attributes,clusterId:this.objectId},geometry:{x:this.geometry.coords[0],y:this.geometry.coords[1]}}},t._createClass(s,[{key:"count",get:function(){return this.attributes.cluster_count}}]),s}(u);function b(e){return 57.29577951308232*e}let v=function(e){function n(t,s,r){var a;return(a=e.call(this,t,r)||this).events=new h,a._geohashLevel=0,a._aggregateValueRanges={},a._aggregateValueRangesChanged=!1,a._geohashBuf=[],a._clusters=new Map,a._tiles=new Map,a.geometryInfo=t.geometryInfo,a._spatialReference=s,a._projectionSupportCheck=p.checkProjectionSupport(s,o.WGS84),a._bitsets.geohash=r.getBitset(r.createBitset()),a._bitsets.inserted=r.getBitset(r.createBitset()),a}t._inheritsLoose(n,e);var c=n.prototype;return c.updateSchema=async function(t,a){const o=this._schema;try{await e.prototype.updateSchema.call(this,t,a),await this._projectionSupportCheck}catch(e){}const i=l.diff(o,a);t.mesh&&(t.targets.aggregate=!0),a&&(!r.isNone(i)||t.source||t.storage.filters)&&((l.hasDiff(i,"params.fields")||!this._tree||t.source)&&(this._tree=new _.GeohashTree(this._statisticFields),this._rebuildTree(),s("esri-2d-update-debug")&&console.debug("Aggregate mesh needs update due to tree changing")),s("esri-2d-update-debug")&&console.debug("Applying Update - ClusterStore:",i),t.mesh=!0,t.targets[a.name]=!0,this._aggregateValueRanges={})},c.sweepFeatures=function(e,t){this._bitsets.inserted.forEachSet((s=>{if(!e.has(s)){const e=t.lookupByDisplayIdUnsafe(s);this._remove(e)}}))},c.sweepClusters=function(e,t,s){this._clusters.forEach(((r,a)=>{r&&r.tileLevel!==s&&(e.releaseDisplayId(r.displayId),t.unsetAttributeData(r.displayId),this._clusters.delete(a))}))},c.onTileData=function(e,t,s,a,o){if(!this._schema||r.isNone(t.addOrUpdate))return t;const i=this._tree,n=this._getTransforms(e,this._spatialReference);{const e=t.addOrUpdate.getCursor();for(;e.next();)this._update(e,a,i)}if(!o)return t;const h=new Array,l=this._schema.params.clusterRadius;this._getClustersForTile(h,e,l,s,i,n),t.type="replace"===t.type?"replace":"update",t.addOrUpdate=f.FeatureSetReaderJSON.fromOptimizedFeatures(h,"esriGeometryPoint"),t.addOrUpdate._storage=s;{const r=t.addOrUpdate.getCursor();for(;r.next();){const t=r.getDisplayId();this._bitsets.computed.unset(t),this.setComputedAttributes(s,r,t,e.scale)}}return this._aggregateValueRangesChanged&&t.end&&(this.events.emit("valueRangesChanged",{valueRanges:this._aggregateValueRanges}),this._aggregateValueRangesChanged=!1),t},c.onTileUpdate=function({added:e,removed:t}){if(e.length){const t=e[0].level;this._setGeohashLevel(t)}if(!this._schema)return;const s=this._schema.params.clusterRadius;t.forEach((e=>{this._tiles.delete(e.key.id),this._markTileClustersForDeletion(e,s)}))},c.getAggregate=function(e){let t=null;return this._clusters.forEach((s=>{s&&s.displayId===e&&(t=s.toJSON())})),t},c.getDisplayId=function(e){const t=this._clusters.get(e);return t?t.displayId:null},c.getFeatureDisplayIdsForAggregate=function(e){const t=this._clusters.get(e);if(!t)return[];const s=t.geohashBoundsInfo;return this._tree.getRegionDisplayIds(s.xLL,s.yLL,s.xTR,s.yTR,s.level)},c.getDisplayIdForReferenceId=function(e){let t;return this._clusters.forEach((s=>{s&&s.referenceId===e&&(t=s.displayId)})),t},c.getAggregateValueRanges=function(){return this._aggregateValueRanges},c.forEach=function(e){this._clusters.forEach(((t,s)=>{t&&e(t,s)}))},c.size=function(){let e=0;return this.forEach((t=>e++)),e},c._rebuildTree=function(){this._bitsets.computed.clear(),this._bitsets.inserted.clear(),this._bitsets.geohash.clear(),this._tree&&this._tree.clear()},c._remove=function(e){const t=e.getDisplayId(),s=e.getXHydrate(),r=e.getYHydrate(),a=this._geohashBuf[2*t],o=this._geohashBuf[2*t+1];this._bitsets.inserted.has(t)&&(this._bitsets.inserted.unset(t),this._tree.removeCursor(e,s,r,a,o,this._geohashLevel))},c._update=function(e,t,s){const r=e.getDisplayId(),a=this._bitsets.inserted,o=t.isVisible(r);if(o===a.has(r))return;if(!o)return void this._remove(e);const i=e.getXHydrate(),n=e.getYHydrate();if(!this._setGeohash(r,i,n))return;const h=this._geohashBuf[2*r],l=this._geohashBuf[2*r+1];s.insertCursor(e,r,i,n,h,l,this._geohashLevel),a.set(r)},c._setGeohash=function(e,t,s){if(this._bitsets.geohash.has(e))return!0;const r=this._geohashBuf;if(this._spatialReference.isWebMercator){const a=b(t/i.earth.radius),o=a-360*Math.floor((a+180)/360),n=b(Math.PI/2-2*Math.atan(Math.exp(-1*s/i.earth.radius)));d.setGeohashBuf(r,e,n,o,12)}else{const a={x:t,y:s},i=p.project(a,this._spatialReference,o.WGS84);if(!i)return!1;d.setGeohashBuf(r,e,i.y,i.x,12)}return this._bitsets.geohash.set(e),!0},c._getClustersForTile=function(e,t,s,a,o,i,n=!0){const h=this._schema.params.clusterPixelBuffer,l=2*s,c=this._getGeohashLevel(t.key.level),d=Math.ceil(Math.pow(2,t.key.level)*y.TILE_SIZE/l),f=Math.ceil(h/l)+0,_=Math.ceil(y.TILE_SIZE/l),{row:p,col:I}=t.key,m=I*y.TILE_SIZE,b=p*y.TILE_SIZE,v=Math.floor(m/l)-f,S=Math.floor(b/l)-f,L=v+_+2*f,R=S+_+2*f,E=t.tileInfoView.getLODInfoAt(t.key.level);for(let s=v;s<=L;s++)for(let h=S;h<=R;h++){let l=s;E.wrap&&(l=s<0?s+d:s%d);const f=E.wrap&&s<0,_=E.wrap&&s%d!==s,p=this._lookupCluster(a,E,t.key.level,l,h,c,o);if(r.isSome(p)){const t=r.andThen(i,(e=>f?e.left:_?e.right:e.tile));if(n&&r.isNone(t))continue;if(!p.count)continue;if(r.isSome(t)&&n){const s=p.geometry.clone();let a=p.attributes;s.coords[0]=g.quantizeX(t,s.coords[0]),s.coords[1]=g.quantizeY(t,s.coords[1]),1===p.count&&r.isSome(p.referenceId)&&(a={...p.attributes,referenceId:p.referenceId});const o=new u(s,a);o.displayId=p.displayId,e.push(o)}}}},c._getGeohashLevel=function(e){return Math.min(Math.ceil(e/2+2),12)},c._setGeohashLevel=function(e){const t=this._getGeohashLevel(e),s=1*(Math.floor(t/1)+1)-1;if(this._geohashLevel!==s)return this._geohashLevel=s,void this._rebuildTree()},c._getTransforms=function(e,t){const s={originPosition:"upperLeft",scale:[e.resolution,e.resolution],translate:[e.bounds[0],e.bounds[3]]},r=a.getInfo(t);if(!r)return{tile:s,left:null,right:null};const[o,i]=r.valid;return{tile:s,left:{...s,translate:[i,e.bounds[3]]},right:{...s,translate:[o-i+e.bounds[0],e.bounds[3]]}}},c._getClusterId=function(e,t,s){return(15&e)<<28|(16383&t)<<14|16383&s},c._markForDeletion=function(e,t,s){const r=this._getClusterId(e,t,s);this._clusters.delete(r)},c._getClusterBounds=function(e,t,s){const r=this._schema.params.clusterRadius,a=2*r;let o=s%2?t*a:t*a-r;const i=s*a;let n=o+a;const h=i-a,l=Math.pow(2,e.level)*y.TILE_SIZE;e.wrap&&o<0&&(o=0),e.wrap&&n>l&&(n=l);const u=o/y.TILE_SIZE,c=i/y.TILE_SIZE,g=n/y.TILE_SIZE,d=h/y.TILE_SIZE;return[e.getXForColumn(u),e.getYForRow(c),e.getXForColumn(g),e.getYForRow(d)]},c._lookupCluster=function(e,t,s,a,n,h,l){const u=this._getClusterId(s,a,n),c=this._clusters.get(u),[g,f,_,y]=this._getClusterBounds(t,a,n),I={x:g,y:f},v={x:_,y:y};let S=0,L=0,R=0,E=0;if(this._spatialReference.isWebMercator){{const e=b(I.x/i.earth.radius);S=e-360*Math.floor((e+180)/360),L=b(Math.PI/2-2*Math.atan(Math.exp(-1*I.y/i.earth.radius)))}{const e=b(v.x/i.earth.radius);R=e-360*Math.floor((e+180)/360),E=b(Math.PI/2-2*Math.atan(Math.exp(-1*v.y/i.earth.radius)))}}else{const e=p.project(I,this._spatialReference,o.WGS84),t=p.project(v,this._spatialReference,o.WGS84);if(!e||!t)return null;S=e.x,L=e.y,R=t.x,E=t.y}const C={geohashX:0,geohashY:0},M={geohashX:0,geohashY:0};d.setGeohashXY(C,L,S,h),d.setGeohashXY(M,E,R,h);const T=C.geohashX,x=C.geohashY,w=M.geohashX,V=M.geohashY,F={xLL:T,yLL:x,xTR:w,yTR:V,level:h},k=l.getRegionStatistics(T,x,w,V,h),{count:B,xTotal:D,yTotal:G,referenceId:O}=k,U=B?D/B:0,Z=B?G/B:0;if(0===B)return this._clusters.set(u,null),null;const j={cluster_count:B,...k.attributes},A=r.isSome(c)?c.update(U,Z,s,j,F,O):m.create(e,u,U,Z,s,j,F,O);return 0===B&&(A.geometry.coords[0]=(g+_)/2,A.geometry.coords[1]=(f+y)/2),this._clusters.set(u,A),this._updateAggregateValueRangeForCluster(A,A.tileLevel),A},c._updateAggregateValueRangeForCluster=function(e,t){const s=this._aggregateValueRanges[t]||{minValue:1/0,maxValue:0},r=s.minValue,a=s.maxValue;s.minValue=Math.min(r,e.count),s.maxValue=Math.max(a,e.count),this._aggregateValueRanges[t]=s,r===s.minValue&&a===s.maxValue||(this._aggregateValueRangesChanged=!0)},c._markTileClustersForDeletion=function(e,t){const s=2*t,r=Math.ceil(y.TILE_SIZE/s),{row:a,col:o}=e.key,i=o*y.TILE_SIZE,n=a*y.TILE_SIZE,h=Math.floor(i/s),l=Math.floor(n/s);for(let t=h;t<h+r;t++)for(let s=l;s<l+r;s++)this._markForDeletion(e.key.level,t,s)},n}(I.Store2D);e.ClusterInfo=m,e.ClusterStore=v,Object.defineProperty(e,"__esModule",{value:!0})}));
