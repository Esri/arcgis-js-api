/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../geometry","../../../../../core/Evented","../../../../../core/has","../../../../../core/maybe","../../../../../core/accessorSupport/diffUtils","../../../../../geohash/GeohashTree","../../../../../geohash/geohashUtils","../../../../../geometry/support/Ellipsoid","../../../../../geometry/support/spatialReferenceUtils","../../../../../layers/graphics/featureConversionUtils","../../../../../layers/graphics/OptimizedFeature","../../../../../layers/graphics/OptimizedGeometry","../../../../../layers/graphics/data/projectionSupport","../../../engine/webgl/definitions","../Store2D","./FeatureSetReaderJSON","../../../../../geometry/SpatialReference"],(function(e,t,s,r,i,a,o,n,h,l,u,c,g,d,f,_,p,y,m){"use strict";const I=12,v=1;let b=function(e){function s(t,s,r,i,a){var o;const n=new d([],[s,r]);return(o=e.call(this,n,i,null,t)||this).geohashBoundsInfo=a,o}t._inheritsLoose(s,e),s.create=function(e,t,r,i,a,o,n,h){const l=new s(t,r,i,o,n);return l.displayId=e.createDisplayId(!0),l.referenceId=h,l.tileLevel=a,l};var r=s.prototype;return r.update=function(e,t,s,r,i,a){return this.geometry.coords[0]=e,this.geometry.coords[1]=t,this.tileLevel=s,this.attributes=r,this.geohashBoundsInfo=i,this.referenceId=null,this.referenceId=a,this},r.toJSON=function(){return{objectId:this.objectId,referenceId:1===this.attributes.cluster_count?this.referenceId:null,attributes:{...this.attributes,clusterId:this.objectId},geometry:{x:this.geometry.coords[0],y:this.geometry.coords[1]}}},t._createClass(s,[{key:"count",get:function(){return this.attributes.cluster_count}}]),s}(g.OptimizedFeatureWithGeometry);function L(e){return 57.29577951308232*e}let S=function(e){function s(t,s,i){var a;return(a=e.call(this,t,i)||this).events=new r,a._geohashLevel=0,a._tileLevel=0,a._aggregateValueRanges={},a._aggregateValueRangesChanged=!1,a._geohashBuf=[],a._clusters=new Map,a._tiles=new Map,a.geometryInfo=t.geometryInfo,a._spatialReference=s,a._projectionSupportCheck=f.checkProjectionSupport(s,m.WGS84),a._bitsets.geohash=i.getBitset(i.createBitset()),a._bitsets.inserted=i.getBitset(i.createBitset()),a}t._inheritsLoose(s,e);var d=s.prototype;return d.updateSchema=function(){var s=t._asyncToGenerator((function*(t,s){const r=this._schema;try{yield e.prototype.updateSchema.call(this,t,s),yield this._projectionSupportCheck}catch(l){}const h=o.diff(r,s);s&&(!a.isNone(h)||t.source||t.storage.filters)?((o.hasDiff(h,"params.fields")||!this._tree||t.source)&&(this._tree=new n.GeohashTree(this._statisticFields),this._rebuildTree(),i("esri-2d-update-debug")&&console.debug("Aggregate mesh needs update due to tree changing")),i("esri-2d-update-debug")&&console.debug("Applying Update - ClusterStore:",h),t.targets[s.name]=!0,t.mesh=!1,this._aggregateValueRanges={}):r&&(t.mesh=!0)}));function r(e,t){return s.apply(this,arguments)}return r}(),d.clear=function(){this._rebuildTree()},d.sweepFeatures=function(e,t){this._bitsets.inserted.forEachSet((s=>{if(!e.has(s)){const e=t.lookupByDisplayIdUnsafe(s);this._remove(e)}}))},d.sweepClusters=function(e,t,s){this._clusters.forEach(((r,i)=>{r&&r.tileLevel!==s&&(e.releaseDisplayId(r.displayId),t.unsetAttributeData(r.displayId),this._clusters.delete(i))}))},d.onTileData=function(e,t,s,r,i=!0){if(!this._schema||a.isNone(t.addOrUpdate))return t;const o=this._getTransforms(e,this._spatialReference);{const e=t.addOrUpdate.getCursor();for(;e.next();)this._update(e,r)}if(t.status.mesh||!i)return t;const n=new Array,h=this._schema.params.clusterRadius;this._getClustersForTile(n,e,h,s,o),t.addOrUpdate=y.FeatureSetReaderJSON.fromOptimizedFeatures(n,"esriGeometryPoint"),t.addOrUpdate.attachStorage(s),t.end=!0;{const r=t.addOrUpdate.getCursor();for(;r.next();){const t=r.getDisplayId();this._bitsets.computed.unset(t),this.setComputedAttributes(s,r,t,e.scale)}}return this._aggregateValueRangesChanged&&t.end&&(this.events.emit("valueRangesChanged",{valueRanges:this._aggregateValueRanges}),this._aggregateValueRangesChanged=!1),t},d.onTileUpdate=function({added:e,removed:t}){if(e.length){const t=e[0].level;this._tileLevel=t,this._setGeohashLevel(t)}if(!this._schema)return;const s=this._schema.params.clusterRadius;t.forEach((e=>{this._tiles.delete(e.key.id),this._markTileClustersForDeletion(e,s)}))},d.getAggregate=function(e){let t=null;return this._clusters.forEach((s=>{s&&s.displayId===e&&(t=s.toJSON())})),t},d.getAggregates=function(){const e=[];return this._clusters.forEach((t=>{t&&t.tileLevel===this._tileLevel&&e.push(t.toJSON())})),e},d.getDisplayId=function(e){const t=this._clusters.get(e);return t?t.displayId:null},d.getFeatureDisplayIdsForAggregate=function(e){const t=this._clusters.get(e);if(!t)return[];const s=t.geohashBoundsInfo;return this._tree.getRegionDisplayIds(s.xLL,s.yLL,s.xTR,s.yTR,s.level)},d.getDisplayIdForReferenceId=function(e){let t;return this._clusters.forEach((s=>{s&&s.referenceId===e&&(t=s.displayId)})),t},d.getAggregateValueRanges=function(){return this._aggregateValueRanges},d.forEach=function(e){this._clusters.forEach(((t,s)=>{t&&e(t,s)}))},d.size=function(){let e=0;return this.forEach((t=>e++)),e},d._rebuildTree=function(){this._bitsets.computed.clear(),this._bitsets.inserted.clear(),this._tree&&this._tree.clear()},d._remove=function(e){const t=e.getDisplayId(),s=e.getXHydrated(),r=e.getYHydrated(),i=this._geohashBuf[2*t],a=this._geohashBuf[2*t+1];this._bitsets.inserted.has(t)&&(this._bitsets.inserted.unset(t),this._tree.removeCursor(e,s,r,i,a,this._geohashLevel))},d._update=function(e,t){const s=e.getDisplayId(),r=this._bitsets.inserted,i=t.isVisible(s);if(i===r.has(s))return;if(!i)return void this._remove(e);const a=e.getXHydrated(),o=e.getYHydrated();if(!this._setGeohash(s,a,o))return;const n=this._geohashBuf[2*s],h=this._geohashBuf[2*s+1];this._tree.insertCursor(e,s,a,o,n,h,this._geohashLevel),r.set(s)},d._setGeohash=function(e,t,s){if(this._bitsets.geohash.has(e))return!0;const r=this._geohashBuf;if(this._spatialReference.isWebMercator){const i=L(t/l.earth.radius),a=i-360*Math.floor((i+180)/360),o=L(Math.PI/2-2*Math.atan(Math.exp(-s/l.earth.radius)));h.setGeohashBuf(r,e,o,a,I)}else{const i={x:t,y:s},a=f.project(i,this._spatialReference,m.WGS84);if(!a)return!1;h.setGeohashBuf(r,e,a.y,a.x,I)}return this._bitsets.geohash.set(e),!0},d._getClustersForTile=function(e,t,s,r,i,o=!0){const n=this._schema.params.clusterPixelBuffer,h=2*s,l=this._getGeohashLevel(t.key.level),u=Math.ceil(2**t.key.level*_.TILE_SIZE/h),d=Math.ceil(n/h)+0,f=Math.ceil(_.TILE_SIZE/h),{row:p,col:y}=t.key,m=y*_.TILE_SIZE,I=p*_.TILE_SIZE,v=Math.floor(m/h)-d,b=Math.floor(I/h)-d,L=v+f+2*d,S=b+f+2*d,R=t.tileInfoView.getLODInfoAt(t.key.level);for(let _=v;_<=L;_++)for(let s=b;s<=S;s++){let n=_;R.wrap&&(n=_<0?_+u:_%u);const h=R.wrap&&_<0,d=R.wrap&&_%u!==_,f=this._lookupCluster(r,R,t.key.level,n,s,l);if(a.isSome(f)){const t=a.andThen(i,(e=>h?e.left:d?e.right:e.tile));if(o&&a.isNone(t))continue;if(!f.count)continue;if(a.isSome(t)&&o){const s=f.geometry.clone();let r=f.attributes;s.coords[0]=c.quantizeX(t,s.coords[0]),s.coords[1]=c.quantizeY(t,s.coords[1]),1===f.count&&a.isSome(f.referenceId)&&(r={...f.attributes,referenceId:f.referenceId});const i=new g.default(s,r);i.displayId=f.displayId,e.push(i)}}}},d._getGeohashLevel=function(e){return Math.min(Math.ceil(e/2+2),I)},d._setGeohashLevel=function(e){const t=this._getGeohashLevel(e),s=(Math.floor(t/v)+1)*v-1;if(this._geohashLevel!==s)return this._geohashLevel=s,this._rebuildTree(),void this._bitsets.geohash.clear()},d._getTransforms=function(e,t){const s={originPosition:"upperLeft",scale:[e.resolution,e.resolution],translate:[e.bounds[0],e.bounds[3]]},r=u.getInfo(t);if(!r)return{tile:s,left:null,right:null};const[i,a]=r.valid;return{tile:s,left:{...s,translate:[a,e.bounds[3]]},right:{...s,translate:[i-a+e.bounds[0],e.bounds[3]]}}},d._getClusterId=function(e,t,s){return(15&e)<<28|(16383&t)<<14|16383&s},d._markForDeletion=function(e,t,s){const r=this._getClusterId(e,t,s);this._clusters.delete(r)},d._getClusterBounds=function(e,t,s){const r=this._schema.params.clusterRadius,i=2*r;let a=s%2?t*i:t*i-r;const o=s*i;let n=a+i;const h=o-i,l=2**e.level*_.TILE_SIZE;e.wrap&&a<0&&(a=0),e.wrap&&n>l&&(n=l);const u=a/_.TILE_SIZE,c=o/_.TILE_SIZE,g=n/_.TILE_SIZE,d=h/_.TILE_SIZE;return[e.getXForColumn(u),e.getYForRow(c),e.getXForColumn(g),e.getYForRow(d)]},d._lookupCluster=function(e,t,s,r,i,o){const n=this._getClusterId(s,r,i),u=this._clusters.get(n),[c,g,d,_]=this._getClusterBounds(t,r,i),p={x:c,y:g},y={x:d,y:_};let I=0,v=0,S=0,R=0;if(this._spatialReference.isWebMercator){{const e=L(p.x/l.earth.radius);I=e-360*Math.floor((e+180)/360),v=L(Math.PI/2-2*Math.atan(Math.exp(-p.y/l.earth.radius)))}{const e=L(y.x/l.earth.radius);S=e-360*Math.floor((e+180)/360),R=L(Math.PI/2-2*Math.atan(Math.exp(-y.y/l.earth.radius)))}}else{const e=f.project(p,this._spatialReference,m.WGS84),t=f.project(y,this._spatialReference,m.WGS84);if(!e||!t)return null;I=e.x,v=e.y,S=t.x,R=t.y}const E={geohashX:0,geohashY:0},T={geohashX:0,geohashY:0};h.setGeohashXY(E,v,I,o),h.setGeohashXY(T,R,S,o);const C=E.geohashX,M=E.geohashY,x=T.geohashX,V=T.geohashY,F={xLL:C,yLL:M,xTR:x,yTR:V,level:o},w=this._tree.getRegionStatistics(C,M,x,V,o),{count:G,xTotal:k,yTotal:B,referenceId:D}=w,O=G?k/G:0,A=G?B/G:0;if(0===G)return this._clusters.set(n,null),null;const U={cluster_count:G,...w.attributes},Z=a.isSome(u)?u.update(O,A,s,U,F,D):b.create(e,n,O,A,s,U,F,D);return 0===G&&(Z.geometry.coords[0]=(c+d)/2,Z.geometry.coords[1]=(g+_)/2),this._clusters.set(n,Z),this._updateAggregateValueRangeForCluster(Z,Z.tileLevel),Z},d._updateAggregateValueRangeForCluster=function(e,t){const s=this._aggregateValueRanges[t]||{minValue:1/0,maxValue:0},r=s.minValue,i=s.maxValue;s.minValue=Math.min(r,e.count),s.maxValue=Math.max(i,e.count),this._aggregateValueRanges[t]=s,r===s.minValue&&i===s.maxValue||(this._aggregateValueRangesChanged=!0)},d._markTileClustersForDeletion=function(e,t){const s=2*t,r=Math.ceil(_.TILE_SIZE/s),{row:i,col:a}=e.key,o=a*_.TILE_SIZE,n=i*_.TILE_SIZE,h=Math.floor(o/s),l=Math.floor(n/s);for(let u=h;u<h+r;u++)for(let t=l;t<l+r;t++)this._markForDeletion(e.key.level,u,t)},s}(p.Store2D);e.ClusterInfo=b,e.ClusterStore=S,Object.defineProperty(e,"__esModule",{value:!0})}));
