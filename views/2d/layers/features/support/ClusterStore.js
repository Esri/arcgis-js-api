/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../geometry","../../../../../core/Evented","../../../../../core/has","../../../../../core/maybe","../../../../../core/accessorSupport/diffUtils","../../../../../geohash/GeohashTree","../../../../../geohash/geohashUtils","../../../../../geometry/support/Ellipsoid","../../../../../geometry/support/spatialReferenceUtils","../../../../../layers/graphics/featureConversionUtils","../../../../../layers/graphics/OptimizedFeature","../../../../../layers/graphics/OptimizedGeometry","../../../../../layers/graphics/data/projectionSupport","../../../engine/webgl/definitions","../Store2D","./FeatureSetReaderJSON","../../../../../geometry/SpatialReference"],(function(e,t,s,r,a,o,i,n,h,l,u,c,g,d,f,_,p,y,m){"use strict";const I=12,b=1;let v=function(e){function s(t,s,r,a,o){var i;const n=new d([],[s,r]);return(i=e.call(this,n,a,null,t)||this).geohashBoundsInfo=o,i}t._inheritsLoose(s,e),s.create=function(e,t,r,a,o,i,n,h){const l=new s(t,r,a,i,n);return l.displayId=e.createDisplayId(!0),l.referenceId=h,l.tileLevel=o,l};var r=s.prototype;return r.update=function(e,t,s,r,a,o){return this.geometry.coords[0]=e,this.geometry.coords[1]=t,this.tileLevel=s,this.attributes=r,this.geohashBoundsInfo=a,this.referenceId=null,this.referenceId=o,this},r.toJSON=function(){return{objectId:this.objectId,referenceId:1===this.attributes.cluster_count?this.referenceId:null,attributes:{...this.attributes,clusterId:this.objectId},geometry:{x:this.geometry.coords[0],y:this.geometry.coords[1]}}},t._createClass(s,[{key:"count",get:function(){return this.attributes.cluster_count}}]),s}(g);function S(e){return 57.29577951308232*e}let L=function(e){function s(t,s,a){var o;return(o=e.call(this,t,a)||this).events=new r,o._geohashLevel=0,o._aggregateValueRanges={},o._aggregateValueRangesChanged=!1,o._geohashBuf=[],o._clusters=new Map,o._tiles=new Map,o.geometryInfo=t.geometryInfo,o._spatialReference=s,o._projectionSupportCheck=f.checkProjectionSupport(s,m.WGS84),o._bitsets.geohash=a.getBitset(a.createBitset()),o._bitsets.inserted=a.getBitset(a.createBitset()),o}t._inheritsLoose(s,e);var d=s.prototype;return d.updateSchema=function(){var s=t._asyncToGenerator((function*(t,s){const r=this._schema;try{yield e.prototype.updateSchema.call(this,t,s),yield this._projectionSupportCheck}catch(l){}const h=i.diff(r,s);s&&(!o.isNone(h)||t.source||t.storage.filters)?((i.hasDiff(h,"params.fields")||!this._tree||t.source)&&(this._tree=new n.GeohashTree(this._statisticFields),this._rebuildTree(),a("esri-2d-update-debug")&&console.debug("Aggregate mesh needs update due to tree changing")),a("esri-2d-update-debug")&&console.debug("Applying Update - ClusterStore:",h),t.targets[s.name]=!0,t.mesh=!1,this._aggregateValueRanges={}):r&&(t.mesh=!0)}));function r(e,t){return s.apply(this,arguments)}return r}(),d.sweepFeatures=function(e,t){this._bitsets.inserted.forEachSet((s=>{if(!e.has(s)){const e=t.lookupByDisplayIdUnsafe(s);this._remove(e)}}))},d.sweepClusters=function(e,t,s){this._clusters.forEach(((r,a)=>{r&&r.tileLevel!==s&&(e.releaseDisplayId(r.displayId),t.unsetAttributeData(r.displayId),this._clusters.delete(a))}))},d.onTileData=function(e,t,s,r,a=!0){if(!this._schema||o.isNone(t.addOrUpdate))return t;const i=this._tree,n=this._getTransforms(e,this._spatialReference);{const e=t.addOrUpdate.getCursor();for(;e.next();)this._update(e,r,i)}if(t.status.mesh||!a)return t;const h=new Array,l=this._schema.params.clusterRadius;this._getClustersForTile(h,e,l,s,i,n),t.addOrUpdate=y.FeatureSetReaderJSON.fromOptimizedFeatures(h,"esriGeometryPoint"),t.addOrUpdate.attachStorage(s),t.end=!0;{const r=t.addOrUpdate.getCursor();for(;r.next();){const t=r.getDisplayId();this._bitsets.computed.unset(t),this.setComputedAttributes(s,r,t,e.scale)}}return this._aggregateValueRangesChanged&&t.end&&(this.events.emit("valueRangesChanged",{valueRanges:this._aggregateValueRanges}),this._aggregateValueRangesChanged=!1),t},d.onTileUpdate=function({added:e,removed:t}){if(e.length){const t=e[0].level;this._setGeohashLevel(t)}if(!this._schema)return;const s=this._schema.params.clusterRadius;t.forEach((e=>{this._tiles.delete(e.key.id),this._markTileClustersForDeletion(e,s)}))},d.getAggregate=function(e){let t=null;return this._clusters.forEach((s=>{s&&s.displayId===e&&(t=s.toJSON())})),t},d.getDisplayId=function(e){const t=this._clusters.get(e);return t?t.displayId:null},d.getFeatureDisplayIdsForAggregate=function(e){const t=this._clusters.get(e);if(!t)return[];const s=t.geohashBoundsInfo;return this._tree.getRegionDisplayIds(s.xLL,s.yLL,s.xTR,s.yTR,s.level)},d.getDisplayIdForReferenceId=function(e){let t;return this._clusters.forEach((s=>{s&&s.referenceId===e&&(t=s.displayId)})),t},d.getAggregateValueRanges=function(){return this._aggregateValueRanges},d.forEach=function(e){this._clusters.forEach(((t,s)=>{t&&e(t,s)}))},d.size=function(){let e=0;return this.forEach((t=>e++)),e},d._rebuildTree=function(){this._bitsets.computed.clear(),this._bitsets.inserted.clear(),this._tree&&this._tree.clear()},d._remove=function(e){const t=e.getDisplayId(),s=e.getXHydrate(),r=e.getYHydrate(),a=this._geohashBuf[2*t],o=this._geohashBuf[2*t+1];this._bitsets.inserted.has(t)&&(this._bitsets.inserted.unset(t),this._tree.removeCursor(e,s,r,a,o,this._geohashLevel))},d._update=function(e,t,s){const r=e.getDisplayId(),a=this._bitsets.inserted,o=t.isVisible(r);if(o===a.has(r))return;if(!o)return void this._remove(e);const i=e.getXHydrate(),n=e.getYHydrate();if(!this._setGeohash(r,i,n))return;const h=this._geohashBuf[2*r],l=this._geohashBuf[2*r+1];s.insertCursor(e,r,i,n,h,l,this._geohashLevel),a.set(r)},d._setGeohash=function(e,t,s){if(this._bitsets.geohash.has(e))return!0;const r=this._geohashBuf;if(this._spatialReference.isWebMercator){const a=S(t/l.earth.radius),o=a-360*Math.floor((a+180)/360),i=S(Math.PI/2-2*Math.atan(Math.exp(-1*s/l.earth.radius)));h.setGeohashBuf(r,e,i,o,I)}else{const a={x:t,y:s},o=f.project(a,this._spatialReference,m.WGS84);if(!o)return!1;h.setGeohashBuf(r,e,o.y,o.x,I)}return this._bitsets.geohash.set(e),!0},d._getClustersForTile=function(e,t,s,r,a,i,n=!0){const h=this._schema.params.clusterPixelBuffer,l=2*s,u=this._getGeohashLevel(t.key.level),d=Math.ceil(2**t.key.level*_.TILE_SIZE/l),f=Math.ceil(h/l)+0,p=Math.ceil(_.TILE_SIZE/l),{row:y,col:m}=t.key,I=m*_.TILE_SIZE,b=y*_.TILE_SIZE,v=Math.floor(I/l)-f,S=Math.floor(b/l)-f,L=v+p+2*f,R=S+p+2*f,E=t.tileInfoView.getLODInfoAt(t.key.level);for(let _=v;_<=L;_++)for(let s=S;s<=R;s++){let h=_;E.wrap&&(h=_<0?_+d:_%d);const l=E.wrap&&_<0,f=E.wrap&&_%d!==_,p=this._lookupCluster(r,E,t.key.level,h,s,u,a);if(o.isSome(p)){const t=o.andThen(i,(e=>l?e.left:f?e.right:e.tile));if(n&&o.isNone(t))continue;if(!p.count)continue;if(o.isSome(t)&&n){const s=p.geometry.clone();let r=p.attributes;s.coords[0]=c.quantizeX(t,s.coords[0]),s.coords[1]=c.quantizeY(t,s.coords[1]),1===p.count&&o.isSome(p.referenceId)&&(r={...p.attributes,referenceId:p.referenceId});const a=new g(s,r);a.displayId=p.displayId,e.push(a)}}}},d._getGeohashLevel=function(e){return Math.min(Math.ceil(e/2+2),I)},d._setGeohashLevel=function(e){const t=this._getGeohashLevel(e),s=(Math.floor(t/b)+1)*b-1;if(this._geohashLevel!==s)return this._geohashLevel=s,this._rebuildTree(),void this._bitsets.geohash.clear()},d._getTransforms=function(e,t){const s={originPosition:"upperLeft",scale:[e.resolution,e.resolution],translate:[e.bounds[0],e.bounds[3]]},r=u.getInfo(t);if(!r)return{tile:s,left:null,right:null};const[a,o]=r.valid;return{tile:s,left:{...s,translate:[o,e.bounds[3]]},right:{...s,translate:[a-o+e.bounds[0],e.bounds[3]]}}},d._getClusterId=function(e,t,s){return(15&e)<<28|(16383&t)<<14|16383&s},d._markForDeletion=function(e,t,s){const r=this._getClusterId(e,t,s);this._clusters.delete(r)},d._getClusterBounds=function(e,t,s){const r=this._schema.params.clusterRadius,a=2*r;let o=s%2?t*a:t*a-r;const i=s*a;let n=o+a;const h=i-a,l=2**e.level*_.TILE_SIZE;e.wrap&&o<0&&(o=0),e.wrap&&n>l&&(n=l);const u=o/_.TILE_SIZE,c=i/_.TILE_SIZE,g=n/_.TILE_SIZE,d=h/_.TILE_SIZE;return[e.getXForColumn(u),e.getYForRow(c),e.getXForColumn(g),e.getYForRow(d)]},d._lookupCluster=function(e,t,s,r,a,i,n){const u=this._getClusterId(s,r,a),c=this._clusters.get(u),[g,d,_,p]=this._getClusterBounds(t,r,a),y={x:g,y:d},I={x:_,y:p};let b=0,L=0,R=0,E=0;if(this._spatialReference.isWebMercator){{const e=S(y.x/l.earth.radius);b=e-360*Math.floor((e+180)/360),L=S(Math.PI/2-2*Math.atan(Math.exp(-1*y.y/l.earth.radius)))}{const e=S(I.x/l.earth.radius);R=e-360*Math.floor((e+180)/360),E=S(Math.PI/2-2*Math.atan(Math.exp(-1*I.y/l.earth.radius)))}}else{const e=f.project(y,this._spatialReference,m.WGS84),t=f.project(I,this._spatialReference,m.WGS84);if(!e||!t)return null;b=e.x,L=e.y,R=t.x,E=t.y}const C={geohashX:0,geohashY:0},T={geohashX:0,geohashY:0};h.setGeohashXY(C,L,b,i),h.setGeohashXY(T,E,R,i);const M=C.geohashX,x=C.geohashY,V=T.geohashX,w=T.geohashY,F={xLL:M,yLL:x,xTR:V,yTR:w,level:i},k=n.getRegionStatistics(M,x,V,w,i),{count:B,xTotal:D,yTotal:G,referenceId:O}=k,U=B?D/B:0,Z=B?G/B:0;if(0===B)return this._clusters.set(u,null),null;const j={cluster_count:B,...k.attributes},A=o.isSome(c)?c.update(U,Z,s,j,F,O):v.create(e,u,U,Z,s,j,F,O);return 0===B&&(A.geometry.coords[0]=(g+_)/2,A.geometry.coords[1]=(d+p)/2),this._clusters.set(u,A),this._updateAggregateValueRangeForCluster(A,A.tileLevel),A},d._updateAggregateValueRangeForCluster=function(e,t){const s=this._aggregateValueRanges[t]||{minValue:1/0,maxValue:0},r=s.minValue,a=s.maxValue;s.minValue=Math.min(r,e.count),s.maxValue=Math.max(a,e.count),this._aggregateValueRanges[t]=s,r===s.minValue&&a===s.maxValue||(this._aggregateValueRangesChanged=!0)},d._markTileClustersForDeletion=function(e,t){const s=2*t,r=Math.ceil(_.TILE_SIZE/s),{row:a,col:o}=e.key,i=o*_.TILE_SIZE,n=a*_.TILE_SIZE,h=Math.floor(i/s),l=Math.floor(n/s);for(let u=h;u<h+r;u++)for(let t=l;t<l+r;t++)this._markForDeletion(e.key.level,u,t)},s}(p.Store2D);e.ClusterInfo=v,e.ClusterStore=L,Object.defineProperty(e,"__esModule",{value:!0})}));
