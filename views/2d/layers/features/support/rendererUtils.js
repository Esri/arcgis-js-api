/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import e from"../../../../../core/Error.js";import r from"../../../../../core/has.js";import t from"../../../../../core/Logger.js";import{toPt as o}from"../../../../../core/screenUtils.js";import{getWebGLCapabilities as s}from"../../../../webgl/capabilities.js";const l=8,a=l-2,n=t.getLogger("esri.views.2d.layers.features.support.rendererUtils"),i=e=>{if(!("visualVariables"in e)||!e.visualVariables||!e.visualVariables.length)return e;const r=e.clone(),t=r.visualVariables.map((e=>p(e)?c(e):e));return r.visualVariables=t,r};function u(e){return e.map((e=>p(e)?c(e.clone()):e))}function p(e){return("size"===e.type||"color"===e.type||"opacity"===e.type)&&null!=e.stops}function c(e){return e.stops=g(e.type,e.stops),e}function f(e,r,t){return(1-t)*e+t*r}function b(e,r){const[t,...s]=r,l=s.pop(),n=s[0].value,i=s[s.length-1].value,u=(i-n)/a,p=[];for(let a=n;a<i;a+=u){let t=0;for(;a>=s[t].value;)t++;const l=s[t],n=r[t-1],i=a-n.value,u=l.value===n.value?1:i/(l.value-n.value);if("color"===e){const e=s[t],o=r[t-1],l=e.color.clone();l.r=f(o.color.r,l.r,u),l.g=f(o.color.g,l.g,u),l.b=f(o.color.b,l.b,u),l.a=f(o.color.a,l.a,u),p.push({value:a,color:l,label:e.label})}else if("size"===e){const e=s[t],l=r[t-1],n=o(e.size),i=f(o(l.size),n,u);p.push({value:a,size:i,label:e.label})}else{const e=s[t],o=f(r[t-1].opacity,e.opacity,u);p.push({value:a,opacity:o,label:e.label})}}return[t,...p,l]}function m(e){const[r,...t]=e,o=t.pop();for(;t.length>a;){let e=0,r=0;for(let o=1;o<t.length;o++){const s=t[o-1],l=t[o],a=Math.abs(l.value-s.value);a>r&&(r=a,e=o)}t.splice(e,1)}return[r,...t,o]}function g(e,r){return r.length<=l?r:(n.warn(`Found ${r.length} Visual Variable stops, but MapView only supports ${l}. Displayed stops will be simplified.`),r.length>2*l?b(e,r):m(r))}function h(){if(r("heatmap-force-raster"))return"raster";const{supportsTextureFloat:e,supportsTextureHalfFloat:t,supportsColorBufferFloat:o,supportsColorBufferFloatBlend:l,supportsColorBufferHalfFloat:a}=s("2d");return e&&o&&l||t&&a?"symbol":r("heatmap-allow-raster-fallback")?"raster":"none"}function v(t){if(!t)return!0;switch(t.type){case"dot-density":if(!s("2d").supportsTextureFloat)return n.error(new e("webgl-missing-extension","Missing WebGL extension OES_Texture_Float which is required for DotDensity")),!1;break;case"heatmap":{const t=h();if("none"===t||"raster"===t&&!r("heatmap-force-raster")){const r=s("2d"),o=["supportsTextureFloat","supportsTextureHalfFloat","supportsColorBufferFloat","supportsColorBufferFloatBlend","supportsColorBufferHalfFloat"].filter((e=>!r[e])).join(", ");if("none"===t)return n.errorOnce(new e("webgl-missing-extension",`Missing WebGL${r.type} requirements for Heatmap: ${o}`)),!1;"raster"===t&&n.warnOnce(`Missing WebGL${r.type} requirements for accelerated Heatmap: ${o}. Feature support may be limited.`)}break}}return!0}export{h as getSupportedHeatmapRenderer,v as isRendererSupported,i as simplifyVVRenderer,u as simplifyVisualVariables};
