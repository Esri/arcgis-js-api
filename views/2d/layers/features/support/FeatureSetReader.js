/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../geometry","../../../../../core/has","../../../../../core/maybe","../../../../../layers/graphics/centroid","../../../../../layers/graphics/featureConversionUtils","../../../../../layers/graphics/OptimizedGeometry","./StaticBitSet","../../../../../geometry/support/jsonUtils"],(function(e,t,r,i,n,s,o,u,a,d){"use strict";let c=0;const h=i("featurelayer-simplify-thresholds")??[.5,.5,.5,.5],l=h[0],f=h[1],g=h[2],m=h[3],y=i("featurelayer-simplify-payload-size-factors")??[1,2,4],_=y[0],p=y[1],x=y[2],I=i("featurelayer-simplify-mobile-factor")??2,S=i("esri-mobile");let b=function(){function e(e,t){this.type="FeatureSetReader",this.arcadeDeclaredClass="esri.arcade.Feature",this.seen=!1,this.instance=0,this._tx=0,this._ty=0,this._sx=1,this._sy=1,this._deleted=null,this._joined=[],this._objectIdToIndex=null,this._level=0,this.instance=e,this._layerSchema=t}e.createInstance=function(){return c++,c=c>65535?0:c,c};var r=e.prototype;return r.getAreaSimplificationThreshold=function(e,t){let r=1;const i=S?I:1;t>4e6?r=x*i:t>1e6?r=p*i:t>5e5?r=_*i:t>1e5&&(r=i);let n=0;e>4e3?n=m*r:e>2e3?n=g*r:e>100?n=f:e>15&&(n=l);let s=8;return this._level<4?s=1:this._level<5?s=2:this._level<6&&(s=4),n*s},r.createQuantizedExtrudedQuad=function(e,t){return new u([5],[e-1,t,1,-1,1,1,-1,1,-1,-1])},r.setArcadeSpatialReference=function(e){this._arcadeSpatialReference=e},r.attachStorage=function(e){this._storage=e},r.getQuantizationTransform=function(){throw new Error("Unable to find transform for featureSet")},r.getStorage=function(){return this._storage},r.getComputedNumeric=function(e){return this.getComputedNumericAtIndex(0)},r.setComputedNumeric=function(e,t){return this.setComputedNumericAtIndex(t,0)},r.getComputedString=function(e){return this.getComputedStringAtIndex(0)},r.setComputedString=function(e,t){return this.setComputedStringAtIndex(0,t)},r.getComputedNumericAtIndex=function(e){return this._storage.getComputedNumericAtIndex(this.getDisplayId(),e)},r.setComputedNumericAtIndex=function(e,t){this._storage.setComputedNumericAtIndex(this.getDisplayId(),e,t)},r.getComputedStringAtIndex=function(e){return this._storage.getComputedStringAtIndex(this.getDisplayId(),e)},r.setComputedStringAtIndex=function(e,t){return this._storage.setComputedStringAtIndex(this.getDisplayId(),e,t)},r.transform=function(e,t,r,i){const n=this.copy();return n._tx+=e,n._ty+=t,n._sx*=r,n._sy*=i,n},r.readAttribute=function(e,t=!1){const r=this._readAttribute(e,t);if(void 0!==r)return r;for(const i of this._joined){i.setIndex(this.getIndex());const r=i._readAttribute(e,t);if(void 0!==r)return r}},r.readAttributes=function(){const e=this._readAttributes();for(const t of this._joined){t.setIndex(this.getIndex());const r=t._readAttributes();for(const t of Object.keys(r))e[t]=r[t]}return e},r.joinAttributes=function(e){this._joined.push(e)},r.readArcadeFeature=function(){return this},r.geometry=function(){const e=this.readHydratedGeometry(),t=o.convertToGeometry(e,this.geometryType,this.hasZ,this.hasM),r=d.fromJSON(t);return r&&(r.spatialReference=this._arcadeSpatialReference),r},r.field=function(e){if(this.hasField(e))return this.readAttribute(e,!0);for(const t of this._joined)if(t.setIndex(this.getIndex()),t.hasField(e)){return t._readAttribute(e,!0)}throw new Error(`Field ${e} does not exist`)},r.setField=function(e,t){throw new Error("Unable to update feature attribute values, feature is readonly")},r.keys=function(){return this.getFieldNames()},r.castToText=function(e=!1){if(!e)return JSON.stringify(this.readLegacyFeature());const t=this.readLegacyFeature();if(!t)return JSON.stringify(null);const r={geometry:t.geometry,attributes:{...t.attributes?t.attributes:{}}};for(const i in r.attributes){const e=r.attributes[i];e instanceof Date&&(r.attributes[i]=e.getTime())}return JSON.stringify(r)},r.gdbVersion=function(){return null},r.fullSchema=function(){return this._layerSchema},r.castAsJson=function(e=null){return{attributes:this._readAttributes(),geometry:!0===e?.keepGeometryType?this.geometry():this.geometry().toJSON()}},r.castAsJsonAsync=function(e=null,t=null){return Promise.resolve(this.castAsJson(t))},r.removeIds=function(e){if(n.isNone(this._objectIdToIndex)){const e=new Map,t=this.getCursor();for(;t.next();){const r=n.unwrapOrThrow(t.getObjectId());e.set(r,t.getIndex())}this._objectIdToIndex=e}const t=this._objectIdToIndex;for(const r of e)t.has(r)&&this.removeAtIndex(t.get(r))},r.removeAtIndex=function(e){n.isNone(this._deleted)&&(this._deleted=a.StaticBitSet.create(this.getSize())),this._deleted.set(e)},r.readGeometryForDisplay=function(){return this.readUnquantizedGeometry(!0)},r.readLegacyGeometryForDisplay=function(){return this.readLegacyGeometry(!0)},r.features=function*(){const e=this.getCursor();for(;e.next();)yield e.readOptimizedFeature()},r._getExists=function(){return n.isNone(this._deleted)||!this._deleted.has(this.getIndex())},r._computeCentroid=function(){if("esriGeometryPolygon"!==this.geometryType)return null;const e=this.readUnquantizedGeometry();if(!e||e.hasIndeterminateRingOrder)return null;const t=n.unwrapOr(this.getQuantizationTransform(),null);return s.getCentroidOptimizedGeometry(new u,e,this.hasM,this.hasZ,t)},r.copyInto=function(e){e.seen=this.seen,e._storage=this._storage,e._arcadeSpatialReference=this._arcadeSpatialReference,e._joined=this._joined,e._tx=this._tx,e._ty=this._ty,e._sx=this._sx,e._sy=this._sy,e._deleted=this._deleted,e._objectIdToIndex=this._objectIdToIndex},t._createClass(e,[{key:"isEmpty",get:function(){return n.isSome(this._deleted)&&this._deleted.countSet()===this.getSize()}},{key:"level",set:function(e){this._level=e}}]),e}();e.FeatureSetReader=b,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
