/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../geometry","../../../../../core/has","../../../../../core/maybe","../../../../../layers/graphics/centroid","../../../../../layers/graphics/featureConversionUtils","../../../../../layers/graphics/OptimizedGeometry","./StaticBitSet","../../../../../geometry/support/jsonUtils"],(function(e,t,i,n,r,s,o,u,d,a){"use strict";var c,h,l;let f=0;const _=null!=(c=n("featurelayer-simplify-thresholds"))?c:[.5,.5,.5,.5],m=_[0],g=_[1],p=_[2],y=_[3],I=null!=(h=n("featurelayer-simplify-payload-size-factors"))?h:[1,2,4],x=I[0],S=I[1],A=I[2],b=null!=(l=n("featurelayer-simplify-mobile-factor"))?l:2,C=n("esri-mobile");let j=function(){function e(e){this.type="FeatureSetReader",this.seen=!1,this.instance=0,this._tx=0,this._ty=0,this._sx=1,this._sy=1,this._deleted=null,this._joined=[],this._objectIdToIndex=null,this._level=0,this.instance=e}e.createInstance=function(){return f++,f=f>65535?0:f,f};var i=e.prototype;return i.getAreaSimplificationThreshold=function(e,t){let i=1;const n=C?b:1;t>4e6?i=A*n:t>1e6?i=S*n:t>5e5?i=x*n:t>1e5&&(i=n);let r=0;e>4e3?r=y*i:e>2e3?r=p*i:e>100?r=g:e>15&&(r=m);let s=8;return this._level<4?s=1:this._level<5?s=2:this._level<6&&(s=4),r*s},i.setArcadeSpatialReference=function(e){this._arcadeSpatialReference=e},i.attachStorage=function(e){this._storage=e},i.getQuantizationTransform=function(){throw new Error("Unable to find transform for featureSet")},i.getStorage=function(){return this._storage},i.getComputedNumeric=function(e){return this.getComputedNumericAtIndex(0)},i.setComputedNumeric=function(e,t){return this.setComputedNumericAtIndex(t,0)},i.getComputedString=function(e){return this.getComputedStringAtIndex(0)},i.setComputedString=function(e,t){return this.setComputedStringAtIndex(0,t)},i.getComputedNumericAtIndex=function(e){return this._storage.getComputedNumericAtIndex(this.getDisplayId(),e)},i.setComputedNumericAtIndex=function(e,t){this._storage.setComputedNumericAtIndex(this.getDisplayId(),e,t)},i.getComputedStringAtIndex=function(e){return this._storage.getComputedStringAtIndex(this.getDisplayId(),e)},i.setComputedStringAtIndex=function(e,t){return this._storage.setComputedStringAtIndex(this.getDisplayId(),e,t)},i.transform=function(e,t,i,n){const r=this.copy();return r._tx+=e,r._ty+=t,r._sx*=i,r._sy*=n,r},i.readAttribute=function(e,t=!1){const i=this._readAttribute(e,t);if(void 0!==i)return i;for(const n of this._joined){n.setIndex(this.getIndex());const i=n._readAttribute(e,t);if(void 0!==i)return i}},i.readAttributes=function(){const e=this._readAttributes();for(const t of this._joined){t.setIndex(this.getIndex());const i=t._readAttributes();for(const t of Object.keys(i))e[t]=i[t]}return e},i.joinAttributes=function(e){this._joined.push(e)},i.readArcadeFeature=function(){return this},i.geometry=function(){const e=this.readHydratedGeometry(),t=o.convertToGeometry(e,this.geometryType,this.hasZ,this.hasM),i=a.fromJSON(t);return i&&(i.spatialReference=this._arcadeSpatialReference),i},i.field=function(e){return this.readAttribute(e,!0)},i.hasField=function(e){return!0},i.setField=function(e,t){},i.keys=function(){return[]},i.castToText=function(){return""},i.removeIds=function(e){if(r.isNone(this._objectIdToIndex)){const e=new Map,t=this.getCursor();for(;t.next();)e.set(t.getObjectId(),t.getIndex());this._objectIdToIndex=e}const t=this._objectIdToIndex;for(const i of e)t.has(i)&&this.removeAtIndex(t.get(i))},i.removeAtIndex=function(e){r.isNone(this._deleted)&&(this._deleted=d.StaticBitSet.create(this.getSize())),this._deleted.set(e)},i.readGeometryForDisplay=function(){return this.readUnquantizedGeometry(!0)},i.readLegacyGeometryForDisplay=function(){return this.readLegacyGeometry(!0)},i.features=function*(){const e=this.getCursor();for(;e.next();)yield e.readOptimizedFeature()},i._getExists=function(){return r.isNone(this._deleted)||!this._deleted.has(this.getIndex())},i._computeCentroid=function(){if("esriGeometryPolygon"!==this.geometryType)return null;const e=this.readUnquantizedGeometry();if(!e||e.hasIndeterminateRingOrder)return null;const t=r.unwrapOr(this.getQuantizationTransform(),null);return s.getCentroidOptimizedGeometry(new u,e,this.hasM,this.hasZ,t)},i.copyInto=function(e){e.seen=this.seen,e._storage=this._storage,e._arcadeSpatialReference=this._arcadeSpatialReference,e._joined=this._joined,e._tx=this._tx,e._ty=this._ty,e._sx=this._sx,e._sy=this._sy,e._deleted=this._deleted,e._objectIdToIndex=this._objectIdToIndex},t._createClass(e,[{key:"isEmpty",get:function(){return r.isSome(this._deleted)&&this._deleted.countSet()===this.getSize()}},{key:"level",set:function(e){this._level=e}}]),e}();e.FeatureSetReader=j,Object.defineProperty(e,"__esModule",{value:!0})}));
