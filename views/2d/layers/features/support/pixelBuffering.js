/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{pt2px as t}from"../../../../../core/screenUtils.js";import{CIMSymbolHelper as e}from"../../../../../symbols/cim/CIMSymbolHelper.js";import r from"../../../../../symbols/cim/Rect.js";import{AVERAGE_GLYPH_MOSAIC_ITEM as i}from"../../../engine/webgl/definitions.js";import{getTextSymbolSize as n}from"../../graphics/graphicsUtils.js";import{expandSymbol as s}from"../../support/cimSymbolUtils.js";const a={"simple-marker":1,"picture-marker":1,text:0,"simple-line":0,"simple-fill":0,"picture-fill":0,cim:1,"web-style":1},o=.707;function m(t){if(!("visualVariables"in t))return 0;if(!t.hasVisualVariables("size"))return 0;const e=t.getVisualVariablesForType("size");if(!e[0])return 0;const r=e[0];if("outline"===r.target)return 0;if("stops"===r.transformationType)return r.stops.map((t=>t.size)).reduce(g,0);if("clamped-linear"===r.transformationType){let t=-1/0,e=-1/0;return t="number"==typeof r.maxSize?r.maxSize:r.maxSize.stops.map((t=>t.size)).reduce(g,0),e="number"==typeof r.minSize?r.minSize:r.minSize.stops.map((t=>t.size)).reduce(g,0),Math.max(t,e)}return"real-world-size"===r.transformationType?30:void 0}function c(t){return t.type in a}async function u(e,r,i,n,s,a){if(!e||a&&"cluster"===a.type)return 0;if("heatmap"===e.type)return Math.round(t(e.radius));if("dot-density"===e.type)return 0;if("dictionary"===e.type)return"esriGeometryPoint"===r||"esriGeometryMultipoint"===r?100:200;const o=e.getSymbols(),c=m(e),u=[];for(const t of o)u.push(x(t,c,i,r,n,s));const p=await Promise.all(u);return t(p.reduce(g,0))}const p=[0,0,0,0];function l(t,e){return null==t?e:t}function f(t,e){return null==t.outline?e:l(t.outline.width,e)}const h={sdf:!0,code:99,metrics:i.metrics,rect:new r(0,0,24,24),page:0,textureBinding:2};function y(t){const e=t.text&&t.text.length;if(!e)return{glyphMosaicItems:[h]};const r=[];for(let i=0;i<e;i++)r.push({...h,code:t.text.charCodeAt(i)});return{glyphMosaicItems:r}}async function d(t,r,i,a,m,c){if("simple-marker"===t.type){const e=Math.max(l(t.size,12),r);return M(t)+e*o}if("picture-marker"===t.type){const e=Math.max(l(t.height,12),r),i=l(t.width,12)*(e/l(t.height,12))/2,n=e/2;return M(t)+Math.sqrt(i*i+n*n)}if("text"===t.type){const e=y(t);n(p,t.toJSON(),e);const r=Math.abs(p[0]),i=Math.abs(p[1]),s=p[2],a=p[3];return Math.max(r,i)+Math.max(s,a)}if("simple-line"===t.type){const e=t,i=Math.max(l(e.width,.75),r)/2;return e.marker?Math.max(6*e.width,2*r):i}if("simple-fill"===t.type||"picture-fill"===t.type)return Math.max(f(t,0),r)/2;if("cim"===t.type){const n={geometryType:a,fields:m,spatialReference:c},o={type:"cim",rendererKey:0,data:t.data,maxVVSize:r};await s(o,n,i);const u=e.getEnvelope(t.data,i);return u?Math.sqrt(u.width*u.width+u.height*u.height):0}return"web-style"===t.type?d(await t.fetchCIMSymbol(),r,i,a,m,c):0}async function x(t,e,r,i,n,s){return c(t)?Math.min(await d(t,e,r,i,n,s),75):0}function M(t){const e=l(t.xoffset,0),r=l(t.yoffset,0);return Math.sqrt(e*e+r*r)}function g(t,e){return Math.max(t,e)}export{u as computePxBuffer,m as getPtMaxVVSize};
