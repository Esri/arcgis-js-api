/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/has","../../../../../../core/maybe","../../../../../../layers/graphics/featureConversionUtils","../../../../../../core/workers/workers","../../../../../../rest/query/operations/query","../../support/FeatureSetReaderJSON","../../../../../../layers/ogc/ogcFeatureUtils","../../support/FeatureSetReaderPBF"],(function(e,t,r,i,u,n,a,o,s,c){"use strict";let p=function(){function e(e){this.service=e}return e.prototype.destroy=function(){},e}();function l(e){return Array.isArray(e.source)}function y(e){return e&&e.capabilities&&e.collectionId&&e.layerDefinition&&e.url}function f(e){const{capabilities:t}=e;return y(e.source)?new F(e):l(e)?new d(e):t.query.supportsFormatPBF&&r("featurelayer-pbf")?new h(e):new m(e)}let d=function(e){function r(t){var r;return(r=e.call(this,t)||this)._portsOpen=n.openWithPorts(t.source).then((e=>r.client=e)),r}t._inheritsLoose(r,e);var i=r.prototype;return i.destroy=function(){this.client.close(),this.client=null},i.executeQuery=async function(e,t){await this._portsOpen;const r=await this.client.invoke("queryFeatures",e.toJSON(),t);return o.FeatureSetReaderJSON.fromFeatureSet(r,this.service.objectIdField)},r}(p),h=function(e){function r(){return e.apply(this,arguments)||this}return t._inheritsLoose(r,e),r.prototype.executeQuery=async function(e,t){const{data:r}=await a.executeQueryPBFBuffer(this.service.source,e,{...t,query:{...this.service.customParameters,...null==t?void 0:t.query}}),i=!e.quantizationParameters;return c.FeatureSetReaderPBF.fromBuffer(r,this.service.geometryType,i)},r}(p),m=function(e){function r(){return e.apply(this,arguments)||this}return t._inheritsLoose(r,e),r.prototype.executeQuery=async function(e,t){const{source:r,capabilities:n,spatialReference:s,objectIdField:c}=this.service;if(e.quantizationParameters&&!n.query.supportsQuantization){const i=e.clone();i.quantizationParameters=null;const{data:n}=await a.executeQuery(r,i,s,{...t,query:{...this.service.customParameters,...null==t?void 0:t.query}}),p=u.convertFromFeatureSet(n,c);return u.quantizeOptimizedFeatureSet(t.transform,p),o.FeatureSetReaderJSON.fromOptimizedFeatureSet(p)}const{data:p}=await a.executeQuery(r,e,this.service.spatialReference,{...t,query:{...i.unwrap(this.service.customParameters),...null==t?void 0:t.query}});return o.FeatureSetReaderJSON.fromFeatureSet(p,this.service.objectIdField)},r}(p),F=function(e){function r(){return e.apply(this,arguments)||this}return t._inheritsLoose(r,e),r.prototype.executeQuery=async function(e,t){const{capabilities:r}=this.service;if(e.quantizationParameters&&!r.query.supportsQuantization){e.clone().quantizationParameters=null;const r=await s.queryOptimizedFeatureSet(this.service.source,e,t);return u.quantizeOptimizedFeatureSet(t.transform,r),o.FeatureSetReaderJSON.fromOptimizedFeatureSet(r)}const i=await s.queryOptimizedFeatureSet(this.service.source,e,t);return o.FeatureSetReaderJSON.fromOptimizedFeatureSet(i)},r}(p);e.SourceAdapter=p,e.createSourceAdapter=f,Object.defineProperty(e,"__esModule",{value:!0})}));
