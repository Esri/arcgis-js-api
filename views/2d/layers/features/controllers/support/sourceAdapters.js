/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/has","../../../../../../core/maybe","../../../../../../core/workers/workers","../../../../../../geometry/support/quantizationUtils","../../../../../../layers/graphics/featureConversionUtils","../../../../../../layers/ogc/ogcFeatureUtils","../../../../../../rest/query/operations/query","../../support/FeatureSetReaderJSON","../../support/FeatureSetReaderPBF"],(function(e,t,r,i,n,u,o,a,s,c,l){"use strict";let p=function(){function e(e){this.service=e}return e.prototype.destroy=function(){},e}();function y(e){return Array.isArray(e.source)}function f(e){return e&&e.capabilities&&e.collection&&e.layerDefinition}function d(e){const{capabilities:t}=e;return f(e.source)?new v(e):y(e)?new h(e):t.query.supportsFormatPBF&&r("featurelayer-pbf")?new m(e):new F(e)}let h=function(e){function r(t){var r;return(r=e.call(this,t)||this)._portsOpen=n.openWithPorts(t.source).then((e=>r.client=e)),r}t._inheritsLoose(r,e);var i=r.prototype;return i.destroy=function(){this.client.close(),this.client=null},i.executeQuery=function(){var e=t._asyncToGenerator((function*(e,t){yield this._portsOpen;const r=yield this.client.invoke("queryFeatures",e.toJSON(),t);return c.FeatureSetReaderJSON.fromFeatureSet(r,this.service.objectIdField)}));function r(t,r){return e.apply(this,arguments)}return r}(),r}(p),m=function(e){function r(){return e.apply(this,arguments)||this}return t._inheritsLoose(r,e),r.prototype.executeQuery=function(){var e=t._asyncToGenerator((function*(e,t){const{data:r}=yield s.executeQueryPBFBuffer(this.service.source,e,{signal:null==t?void 0:t.signal,query:{...null==t?void 0:t.query,...this.service.customParameters}}),i=!e.quantizationParameters;return l.FeatureSetReaderPBF.fromBuffer(r,this.service.geometryType,i)}));function r(t,r){return e.apply(this,arguments)}return r}(),r}(p),F=function(e){function r(){return e.apply(this,arguments)||this}return t._inheritsLoose(r,e),r.prototype.executeQuery=function(){var e=t._asyncToGenerator((function*(e,t){const{source:r,capabilities:n,spatialReference:a,objectIdField:l}=this.service;if(i.isSome(e.quantizationParameters)&&!n.query.supportsQuantization){const n=e.clone(),p=u.toQuantizationTransform(i.unwrap(n.quantizationParameters));n.quantizationParameters=null;const{data:y}=yield s.executeQuery(r,n,a,{signal:null==t?void 0:t.signal,query:{...null==t?void 0:t.query,...this.service.customParameters}}),f=o.convertFromFeatureSet(y,l);return o.quantizeOptimizedFeatureSet(p,f),c.FeatureSetReaderJSON.fromOptimizedFeatureSet(f)}const{data:p}=yield s.executeQuery(r,e,this.service.spatialReference,{...t,query:{...null==t?void 0:t.query,...this.service.customParameters}});return c.FeatureSetReaderJSON.fromFeatureSet(p,this.service.objectIdField)}));function r(t,r){return e.apply(this,arguments)}return r}(),r}(p),v=function(e){function r(){return e.apply(this,arguments)||this}return t._inheritsLoose(r,e),r.prototype.executeQuery=function(){var e=t._asyncToGenerator((function*(e,t){const{capabilities:r}=this.service;if(e.quantizationParameters&&!r.query.supportsQuantization){const r=e.clone(),n=u.toQuantizationTransform(i.unwrap(r.quantizationParameters));r.quantizationParameters=null;const s=yield a.queryOptimizedFeatureSet(this.service.source,e,t);return o.quantizeOptimizedFeatureSet(n,s),c.FeatureSetReaderJSON.fromOptimizedFeatureSet(s)}const n=yield a.queryOptimizedFeatureSet(this.service.source,e,t);return c.FeatureSetReaderJSON.fromOptimizedFeatureSet(n)}));function r(t,r){return e.apply(this,arguments)}return r}(),r}(p);e.SourceAdapter=p,e.createSourceAdapter=d,Object.defineProperty(e,"__esModule",{value:!0})}));
