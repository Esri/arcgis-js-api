/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/has","../../../../../../core/maybe","../../../../../../core/workers/Connection","../../../../../../geometry/support/quantizationUtils","../../../../../../layers/graphics/featureConversionUtils","../../../../../../layers/ogc/ogcFeatureUtils","../../../../../../rest/query/operations/query","../../support/FeatureSetReaderJSON","../../support/FeatureSetReaderPBF"],(function(e,t,r,n,i,u,o,a,s,c,p){"use strict";let y=function(){function e(e){this.service=e}return e.prototype.destroy=function(){},e}();function f(e){return Array.isArray(e.source)}function l(e){return"ogc-source"===e?.type}function h(e){const{capabilities:t}=e;return l(e.source)?new z(e):f(e)?new S(e):t.query.supportsFormatPBF&&r("featurelayer-pbf")?new F(e):new v(e)}function d(e){return m.apply(this,arguments)}function m(){return(m=t._asyncToGenerator((function*(e){const t=new i;return yield t.open(e,{}),t}))).apply(this,arguments)}let S=function(e){function r(t){var r;return(r=e.call(this,t)||this)._portsOpen=d(t.source).then((e=>r.client=e)),r}t._inheritsLoose(r,e);var n=r.prototype;return n.destroy=function(){this.client.close(),this.client=null},n.executeQuery=function(){var e=t._asyncToGenerator((function*(e,t){yield this._portsOpen;const r=yield this.client.invoke("queryFeatures",e.toJSON(),t);return c.FeatureSetReaderJSON.fromFeatureSet(r,this.service)}));function r(t,r){return e.apply(this,arguments)}return r}(),r}(y),F=function(e){function r(){return e.apply(this,arguments)||this}return t._inheritsLoose(r,e),r.prototype.executeQuery=function(){var e=t._asyncToGenerator((function*(e,t){const{data:r}=yield s.executeQueryPBFBuffer(this.service.source,e,t),n=!e.quantizationParameters;return p.FeatureSetReaderPBF.fromBuffer(r,this.service,n)}));function r(t,r){return e.apply(this,arguments)}return r}(),r}(y),v=function(e){function r(){return e.apply(this,arguments)||this}return t._inheritsLoose(r,e),r.prototype.executeQuery=function(){var e=t._asyncToGenerator((function*(e,t){const{source:r,capabilities:i,spatialReference:a,objectIdField:p,geometryType:y}=this.service;if(n.isSome(e.quantizationParameters)&&!i.query.supportsQuantization){const i=e.clone(),y=u.toQuantizationTransform(n.unwrap(i.quantizationParameters));i.quantizationParameters=null;const{data:f}=yield s.executeQuery(r,i,a,t),l=o.convertFromFeatureSet(f,p);return o.quantizeOptimizedFeatureSet(y,l),c.FeatureSetReaderJSON.fromOptimizedFeatureSet(l,this.service)}const{data:f}=yield s.executeQuery(r,e,this.service.spatialReference,t);return"esriGeometryPoint"===y&&(f.features=f.features?.filter((e=>{if(n.isSome(e.geometry)){const t=e.geometry;return Number.isFinite(t.x)&&Number.isFinite(t.y)}return!0}))),c.FeatureSetReaderJSON.fromFeatureSet(f,this.service)}));function r(t,r){return e.apply(this,arguments)}return r}(),r}(y),z=function(e){function r(){return e.apply(this,arguments)||this}return t._inheritsLoose(r,e),r.prototype.executeQuery=function(){var e=t._asyncToGenerator((function*(e,t){const{capabilities:r}=this.service;if(e.quantizationParameters&&!r.query.supportsQuantization){const r=e.clone(),i=u.toQuantizationTransform(n.unwrap(r.quantizationParameters));r.quantizationParameters=null;const s=yield a.queryOptimizedFeatureSet(this.service.source,e,t);return o.quantizeOptimizedFeatureSet(i,s),c.FeatureSetReaderJSON.fromOptimizedFeatureSet(s,this.service)}const i=yield a.queryOptimizedFeatureSet(this.service.source,e,t);return c.FeatureSetReaderJSON.fromOptimizedFeatureSet(i,this.service)}));function r(t,r){return e.apply(this,arguments)}return r}(),r}(y);e.SourceAdapter=y,e.createSourceAdapter=h,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
