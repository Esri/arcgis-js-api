/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/workers/workers","../../../../../../layers/graphics/featureConversionUtils","../../../../../../layers/ogc/ogcFeatureUtils","../../../../../../rest/query/operations/query","../../support/FeatureSetReaderJSON","../../support/FeatureSetReaderPBF"],(function(e,t,r,i,n,u,o,s){"use strict";let a=function(){function e(e){this.service=e}return e.prototype.destroy=function(){},e}();function c(e){return Array.isArray(e.source)}function l(e){return e&&e.capabilities&&e.collectionId&&e.layerDefinition&&e.url}function p(e){const{capabilities:t}=e;return l(e.source)?new h(e):c(e)?new y(e):t.query.supportsFormatPBF?new f(e):new d(e)}let y=function(e){function i(t){var i;return(i=e.call(this,t)||this)._portsOpen=r.openWithPorts(t.source).then((e=>i.client=e)),i}t._inheritsLoose(i,e);var n=i.prototype;return n.destroy=function(){this.client.close(),this.client=null},n.executeQuery=function(){var e=t._asyncToGenerator((function*(e,t){yield this._portsOpen;const r=yield this.client.invoke("queryFeatures",e.toJSON(),t);return o.FeatureSetReaderJSON.fromFeatureSet(r,this.service.objectIdField)}));function r(t,r){return e.apply(this,arguments)}return r}(),i}(a),f=function(e){function r(){return e.apply(this,arguments)||this}return t._inheritsLoose(r,e),r.prototype.executeQuery=function(){var e=t._asyncToGenerator((function*(e,t){const{data:r}=yield u.executeQueryPBFBuffer(this.service.source,e,{...t,query:{...this.service.customParameters,...null==t?void 0:t.query}}),i=!e.quantizationParameters;return s.FeatureSetReaderPBF.fromBuffer(r,this.service.geometryType,i)}));function r(t,r){return e.apply(this,arguments)}return r}(),r}(a),d=function(e){function r(){return e.apply(this,arguments)||this}return t._inheritsLoose(r,e),r.prototype.executeQuery=function(){var e=t._asyncToGenerator((function*(e,t){const{source:r,capabilities:n,spatialReference:s,objectIdField:a}=this.service;if(e.quantizationParameters&&!n.query.supportsQuantization){const n=e.clone();n.quantizationParameters=null;const{data:c}=yield u.executeQuery(r,n,s,{...t,query:{...this.service.customParameters,...null==t?void 0:t.query}}),l=i.convertFromFeatureSet(c,a);return i.quantizeOptimizedFeatureSet(t.transform,l),o.FeatureSetReaderJSON.fromOptimizedFeatureSet(l)}const{data:c}=yield u.executeQuery(r,e,this.service.spatialReference,{...t,query:{...this.service.customParameters,...null==t?void 0:t.query}});return o.FeatureSetReaderJSON.fromFeatureSet(c,this.service.objectIdField)}));function r(t,r){return e.apply(this,arguments)}return r}(),r}(a),h=function(e){function r(){return e.apply(this,arguments)||this}return t._inheritsLoose(r,e),r.prototype.executeQuery=function(){var e=t._asyncToGenerator((function*(e,t){const{capabilities:r}=this.service;if(e.quantizationParameters&&!r.query.supportsQuantization){e.clone().quantizationParameters=null;const r=yield n.queryOptimizedFeatureSet(this.service.source,e,t);return i.quantizeOptimizedFeatureSet(t.transform,r),o.FeatureSetReaderJSON.fromOptimizedFeatureSet(r)}const u=yield n.queryOptimizedFeatureSet(this.service.source,e,t);return o.FeatureSetReaderJSON.fromOptimizedFeatureSet(u)}));function r(t,r){return e.apply(this,arguments)}return r}(),r}(a);e.SourceAdapter=a,e.createSourceAdapter=p,Object.defineProperty(e,"__esModule",{value:!0})}));
