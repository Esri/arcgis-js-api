// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../../core/HandleOwner","../../../../../core/has","../../../../../core/maybe","../../../../../core/promiseUtils","../../../../../core/promiseUtils","../../../../../core/watchUtils","../../../../../core/accessorSupport/decorators","../../../../../layers/graphics/featureConversionUtils","../../../../../layers/graphics/data/QueryEngine","../../../../../layers/support/FieldsIndex","../FeatureStore2D","../Source2D","../support/AttributeStore","../support/ClusterStore","../support/ComputedAttributeStorage","../support/FeatureSetReaderJSON","../support/UpdateToken","../../../../support/QueueProcessor"],(function(e,t,r,i,s,n,o,a,u,c,h,p,d,l,g,f,_,y,v,m,S){"use strict";Object.defineProperty(t,"__esModule",{value:!0});function b(e){if(!o.isAbortError(e)&&!function(e){return"worker:port-closed"===e.name}(e))throw e}var w=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._storage=new y.ComputedAttributeStorage,t._markedIdsBufId=t._storage.createBitset(),t._lastCleanup=performance.now(),t._cleanupNeeded=!1,t._invalidated=!1,t._tileToResolver=new Map,t.tileStore=null,t.config=null,t.processor=null,t.remoteClient=null,t.service=null,t._editing=!1,t}return r.__extends(t,e),t.prototype.initialize=function(){var e=this;this._initAttributeStore(),this._initStores(),this._initQueryEngine(),this._initSource(),this._updateQueue=new S.QueueProcessor({concurrency:4,process:function(t,r){return e._onDisplayTilePatch(t,{signal:r})}}),this.handles.add([this.tileStore.on("update",this.onTileUpdate.bind(this)),this.watch("updating",(function(t){return!t&&e.onIdle()}))])},t.prototype.startup=function(){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){return this._initAttributeStore(),[2]}))}))},t.prototype._initSource=function(){var e=this;this._source=new g.Source2D(this.service,this.spatialReference,this.tileStore.tileScheme),this._source.onDisplayTilePatch=function(t,r){return e._invalidated=!0,e._patchTile(t,r)},this._source.canAcceptPatch=function(){return e._updateQueue.length<50};var t=this._source.sourceEvents;if("geoevent"===t.type){var i=t.events;this.handles.add([i.on("connectionStatus",(function(t){return e.remoteClient.invoke("setProperty",{propertyName:"connectionStatus",value:t}).catch(b)})),i.on("errorString",(function(t){return e.remoteClient.invoke("setProperty",{propertyName:"errorString",value:t}).catch(b)})),i.on("feature",(function(t){return e.remoteClient.invoke("emitEvent",{name:"data-received",event:{attributes:t.attributes,centroid:t.centroid,geometry:t.geometry}}).catch(b)})),i.on("updateRate",(function(t){return e.remoteClient.invoke("emitEvent",{name:"update-rate",event:r.__assign({},t)}).catch(b)}))])}},t.prototype._initAttributeStore=function(){var e=this;this.attributeStore?this.attributeStore.invalidateResources():this.attributeStore=new f.default({type:"remote",initialize:function(t,r){return a.ignoreAbortErrors(e.remoteClient.invoke("tileRenderer.featuresView.attributeView.initialize",t,{signal:r}).catch(b))},update:function(t,r){return a.ignoreAbortErrors(e.remoteClient.invoke("tileRenderer.featuresView.attributeView.requestUpdate",t,{signal:r}).catch(b))},render:function(t){return a.ignoreAbortErrors(e.remoteClient.invoke("tileRenderer.featuresView.requestRender",void 0,{signal:t}).catch(b))}})},t.prototype._initStores=function(){var e=this,t={geometryInfo:{geometryType:this.service.geometryType,hasM:!1,hasZ:!1},spatialReference:this.spatialReference,fieldsIndex:this.fieldsIndex,fields:this.service.fields};this.featureStore=new l.FeatureStore2D(t,this._storage),this.aggregateStore=new _.ClusterStore(t,this.spatialReference,this._storage),this.handles.add(this.aggregateStore.events.on("valueRangesChanged",(function(t){e.remoteClient.invoke("emitEvent",{name:"valueRangesChanged",event:{valueRanges:t.valueRanges}}).catch(b)})))},t.prototype._initQueryEngine=function(){var e;null===(e=this.queryEngine)||void 0===e||e.destroy(),this.queryEngine=new p.default({definitionExpression:this.config.definitionExpression,fields:this.service.fields,geometryType:this.service.geometryType,objectIdField:this.service.objectIdField,hasM:!1,hasZ:!1,spatialReference:this.spatialReference.toJSON(),cacheSpatialQueries:!0,featureStore:this.featureStore,timeInfo:this.service.timeInfo})},t.prototype.destroy=function(){this._updateQueue.destroy(),this._source.destroy(),this.queryEngine.destroy(),this.attributeStore&&this.attributeStore.destroy()},Object.defineProperty(t.prototype,"fieldsIndex",{get:function(){return new d(this.service.fields)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"hasAggregates",{get:function(){return!!this.config.schema.targets.aggregate},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"spatialReference",{get:function(){return this.tileStore.tileScheme.spatialReference},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"updating",{get:function(){return this.isUpdating()},enumerable:!1,configurable:!0}),t.prototype.isUpdating=function(){return this._source.updating||!!this._updateQueue.length},t.prototype.enableEvent=function(e){this._source.enableEvent(e.name,e.value)},t.prototype.invalidate=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,i,n,a,c,h=this;return r.__generator(this,(function(r){switch(r.label){case 0:return e.any()?(s("esri-2d-update-debug")&&e.describe(),t=this.tileStore.tiles.map((function(e){var t=e.key,r=o.createResolver();return h._tileToResolver.set(t.id,r),r.promise})),i=this._updateQueue.takeAll(),this._updateQueue.resume(),this.hasAggregates&&e.mesh&&e.targets.aggregate&&!e.queryFilter?(this._repushAggregateMeshTiles(e),[3,3]):[3,1]):[2];case 1:return this._source.resubscribe(e),o.all(t).then((function(){h._source.resume()})),e.mesh?[4,u.whenFalseOnce(this,"updating")]:[3,3];case 2:r.sent(),r.label=3;case 3:return this.notifyChange("updating"),[4,o.all(t)];case 4:for(r.sent(),this._updateQueue.pause(),n=0,a=i;n<a.length;n++)c=a[n],this._patchTile(c);return e.source&&(this._cleanupNeeded=!0),[2]}}))}))},t.prototype.resume=function(){return this._updateQueue.resume(),this._source.resume()},t.prototype.update=function(e,t,i){return void 0===i&&(i=!1),r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(r){switch(r.label){case 0:return this._editing?[4,u.whenFalseOnce(this,"updating")]:[3,2];case 1:r.sent(),r.label=2;case 2:return i&&(this._source.pause(),this._updateQueue.pause()),this._set("config",t),this._schema=t.schema,this._initQueryEngine(),[4,o.all([this._source.update(e,t.schema.source),this.featureStore.updateSchema(e,t.schema.targets.feature),this.attributeStore.update(e,t.schema.processors[0].storage),this.attributeStore.updateFilters(e,this)])];case 3:return r.sent(),[4,this.aggregateStore.updateSchema(e,t.schema.targets.aggregate)];case 4:return r.sent(),[2]}}))}))},t.prototype.refresh=function(){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){switch(e.label){case 0:return this._source.resubscribe(m.UpdateToken.all(),!0),this._cleanupNeeded=!0,this.notifyChange("updating"),[4,u.whenFalseOnce(this,"updating",!0)];case 1:return e.sent(),[2]}}))}))},t.prototype.onTileUpdate=function(e){this.aggregateStore.onTileUpdate(e);for(var t=0,r=e.added;t<r.length;t++){var i=r[t];this._source.subscribe(i),this._level=i.level}for(var s=0,n=e.removed;s<n.length;s++){var o=n[s];this._source.unsubscribe(o),this._cleanupNeeded=!0,this._tileToResolver.has(o.id)&&(this._tileToResolver.get(o.id).resolve(),this._tileToResolver.delete(o.id))}this.notifyChange("updating")},t.prototype.onIdle=function(){this.hasAggregates&&this._invalidated&&(this._repushAggregateMeshTiles(),this._invalidated=!1),this._markAndSweep()},t.prototype.onEdits=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){switch(t.label){case 0:return this._editing?[4,u.whenFalseOnce(this,"updating")]:[3,2];case 1:return t.sent(),[2,this.onEdits(e)];case 2:return this._editing=!0,[4,this._source.onEdits(e)];case 3:return t.sent(),[4,u.whenFalseOnce(this,"updating")];case 4:return t.sent(),this._editing=!1,[2]}}))}))},t.prototype.queryExtent=function(e){return this.queryEngine.executeQueryForExtent(e)},t.prototype.queryFeatures=function(e){return this.queryEngine.executeQuery(e)},t.prototype.queryFeatureCount=function(e){return this.queryEngine.executeQueryForCount(e)},t.prototype.queryLatestObservations=function(e){return this.queryEngine.executeQueryForLatestObservations(e)},t.prototype.queryObjectIds=function(e){return this.queryEngine.executeQueryForIds(e)},t.prototype.queryStatistics=function(){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){return[2,r.__assign(r.__assign({},this.featureStore.storeStatistics),{displayedFeatureCount:0,displayedVertexCount:0,displayPreProcessTime:0})]}))}))},t.prototype.getObjectId=function(e){return this.featureStore.lookupObjectId(e,this._storage)},t.prototype.getDisplayId=function(e){if(this._schema.targets.aggregate){var t=this.aggregateStore.getDisplayId(e);if(n.isNone(t)){var r=this.featureStore.lookupDisplayId(e);return this.aggregateStore.getDisplayIdForReferenceId(r)}return t}return this.featureStore.lookupDisplayId(e)},t.prototype.getFeature=function(e){var t=this.featureStore.lookupFeatureByDisplayId(e,this._storage);if(n.isNone(t))return null;var r=t.readHydratedGeometry(),i=h.convertToGeometry(r,t.geometryType,t.hasZ,t.hasM);return{attributes:t.readAttributes(),geometry:i}},t.prototype.getAggregate=function(e){return this.aggregateStore.getAggregate(e)},t.prototype.setHighlight=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,i=this;return r.__generator(this,(function(r){return t=e.map((function(e){return i.getDisplayId(e)})),[2,this.attributeStore.setHighlight(e,t)]}))}))},t.prototype._repushAggregateMeshTiles=function(e){for(var t=0,r=this.tileStore.tiles;t<r.length;t++){var i=r[t];this._patchTile({type:"replace",id:i.key.id,addOrUpdate:v.FeatureSetReaderJSON.fromOptimizedFeatures([],this.service.geometryType),remove:[],end:!0,noData:!1,update:e||m.UpdateToken.create({mesh:!0,targets:{aggregate:!0}})})}},t.prototype._maybeForceCleanup=function(){performance.now()-this._lastCleanup>5e3&&this._markAndSweep()},t.prototype._patchTile=function(e,t){var r=this,i=this._updateQueue.push(e,t).then((function(){r.notifyChange("updating")})).catch((function(e){s("esri-2d-debug")&&!o.isAbortError(e)&&console.debug(e),r.notifyChange("updating")}));return this.notifyChange("updating"),i},t.prototype._onDisplayTilePatch=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var i,s,a,u,c,h,p,d,l;return r.__generator(this,(function(g){switch(g.label){case 0:for(i=this.tileStore.get(e.id),s=e.update,e.remove.length&&(this._cleanupNeeded=!0),a=[],u=0,c=e.remove;u<c.length;u++)h=c[u],a.push(this.featureStore.lookupDisplayId(h));e.remove=a,o.throwIfAborted(t),g.label=1;case 1:return g.trys.push([1,7,,8]),n.isNone(e.addOrUpdate)?(this.processor.onTileData(i,r.__assign(r.__assign({},e),{addOrUpdate:null}),t).catch((function(e){o.throwIfNotAbortError(e)})),this._finishedPatch(e),[2]):(e.addOrUpdate._storage=this._storage,p=e.addOrUpdate.hasFilter(),d=e.addOrUpdate.instance,e.addOrUpdate._arcadeSpatialReference=this.spatialReference,(!this.featureStore.hasInstance(d)||s.targets.feature&&!p)&&this.featureStore.onTileData(i,e,this._storage),!s.storage.data&&!s.storage.filters||p?[3,4]:(this.attributeStore.onTileData(i,e),this._source.isStream?[4,this.attributeStore.sendUpdates()]:[3,3]));case 2:return g.sent(),[3,4];case 3:this.attributeStore.sendUpdates(),g.label=4;case 4:return this.hasAggregates&&s.targets.aggregate&&(this.aggregateStore.onTileData(i,e,this._storage,this.featureStore,this.attributeStore,s.mesh),s.mesh&&(this.attributeStore.onTileData(i,e),this.attributeStore.sendUpdates())),s.mesh?[4,this.processor.onTileData(i,e,t)]:[3,6];case 5:g.sent(),g.label=6;case 6:return this._maybeForceCleanup(),this._finishedPatch(e),[3,8];case 7:return l=g.sent(),o.throwIfNotAbortError(l),[3,8];case 8:return[2]}}))}))},t.prototype._finishedPatch=function(e){(e.noData||e.end)&&this._tileToResolver.has(e.id)&&(this._tileToResolver.get(e.id).resolve(),this._tileToResolver.delete(e.id))},t.prototype._markAndSweep=function(){var e=this;if(this._lastCleanup=performance.now(),this._cleanupNeeded||this._source.isStream){this._cleanupNeeded=!1;var t=this._storage.getBitset(this._markedIdsBufId),r=new Set;t.clear();for(var i=function(i){var s=e.featureStore.lookupDisplayId(i),n=(4294901760&e._storage.getInstanceId(s))>>>16;s&&(r.add(n),t.set(s))},s=0,o=this.tileStore.tiles;s<o.length;s++){var a=o[s];this._source.forEachRequest(a.key.id,(function(e){if(!n.isNone(e.features))for(var t=e.features.getCursor();t.next();){var r=t.getObjectId();i(r)}}))}this._source.forEachPendingEdit((function(e){return i(e)})),this._updateQueue.forEach((function(e){for(var t=0,r=e.remove;t<r.length;t++){var s=r[t];i(s)}})),this.config.schema.targets.aggregate&&(this.aggregateStore.sweepFeatures(t,this.featureStore),this.aggregateStore.sweepClusters(this._storage,this._level)),this.featureStore.sweepFeatures(t,this._storage),this.featureStore.sweepFeatureSets(r)}},r.__decorate([c.property({constructOnly:!0})],t.prototype,"tileStore",void 0),r.__decorate([c.property()],t.prototype,"config",void 0),r.__decorate([c.property({readOnly:!0,dependsOn:["service"]})],t.prototype,"fieldsIndex",null),r.__decorate([c.property()],t.prototype,"processor",void 0),r.__decorate([c.property({constructOnly:!0})],t.prototype,"remoteClient",void 0),r.__decorate([c.property({constructOnly:!0})],t.prototype,"service",void 0),r.__decorate([c.property({dependsOn:["tileStore"]})],t.prototype,"spatialReference",null),r.__decorate([c.property()],t.prototype,"updating",null),t=r.__decorate([c.subclass("esri.views.2d.layers.features.controllers.FeatureController2D")],t)}(i.HandleOwner);t.default=w}));