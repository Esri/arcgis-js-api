// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/declareExtendsHelper","../../../../../core/tsSupport/decorateHelper","../../../../../core/tsSupport/assignHelper","../../../../../geometry","../../../../../core/Error","../../../../../core/Logger","../../../../../core/promiseUtils","../../../../../core/workers","../../../../../core/accessorSupport/decorators","../../../../../geometry/support/spatialReferenceUtils","../../../../../layers/support/FeatureProcessing","../../../../../tasks/support/QuantizationParameters","../../../../../tasks/support/Query","../../../ViewState","./BaseController","../../../tiling/TileInfoView","../../../tiling/TileQueue"],function(e,t,r,o,i,n,s,u,a,p,c,l,f,y,h,m,d,g,_){Object.defineProperty(t,"__esModule",{value:!0});var v=u.getLogger("esri.views.2d.layers.features.controllers.MemoryController"),S=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="memory",t._processingInMainThread=!1,t._promises=new Map,t}return r(t,e),t.prototype.initialize=function(){var e=this;this._tileQueue=new _({tileInfoView:new g(this.tileStore.tileInfo),process:function(t){return e._fetchFeatureSet(t)}}),this._memorySource=p.open(this.service.source,{client:this}),this.handles.add(this.watch("processor",this._switchProcessor.bind(this)))},t.prototype.destroy=function(){this._promises.forEach(function(e){return e.cancel()}),this._promises.clear()},Object.defineProperty(t.prototype,"processing",{get:function(){return f.fromWorker(this.configuration.processing)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updating",{get:function(){return this._promises.size>0},enumerable:!0,configurable:!0}),t.prototype.setViewState=function(e){this._viewState=m.fromJSON(e),this._tileQueue.pause(),this._tileQueue.state=this._viewState,this._tileQueue.resume()},t.prototype.queryFeatures=function(e){return this._memorySource.invoke("queryFeatures",e)},t.prototype.queryFeatureCount=function(e){return this._memorySource.invoke("queryFeatureCount",e)},t.prototype.queryObjectIds=function(e){return this._memorySource.invoke("queryObjectIds",e)},t.prototype.queryExtent=function(e){return this._memorySource.invoke("queryExtent",e)},t.prototype.tileAdded=function(e){this._fetchTile(e)},t.prototype.tileRemoved=function(e){var t=this._promises.get(e);t&&(t.cancel(),this._promises.delete(e),this.notifyChange("updating"))},t.prototype._switchProcessor=function(e,t){this.handles.remove("processor"),this._tileQueue.pause(),this._tileQueue.reset();for(var r=0,o=this.tileStore.tiles;r<o.length;r++){var i=o[r];this._tileQueue.has(i.key)||this._fetchTile(i)}this._tileQueue.resume()},t.prototype._fetchTile=function(e){var t=this,r=this._tileQueue.push(e.key).then(function(r){t._cleanupPromise(e),t.processor.featureSetReady(e,r)}).catch(function(r){return t._cleanupPromise(e),"cancel"!==r.dojoType&&(t.processor.featureSetReady(e,null,r.message),v.error("query-error",{error:r})),a.reject(r)});this._promises.set(e,r),this.notifyChange("updating")},t.prototype._fetchFeatureSet=function(e){var t=this,r=this.tileStore.findByKey(e),o=this._getQuantizationParameters(r),i=this.processor.queryInfo,n=i.pixelBuffer*r.resolution,s=r.bounds.slice();return s[0]-=n,s[1]-=n,s[2]+=n,s[3]+=n,this._query(s,i,o).then(function(e){var t=i.orderByFields;if(t){var r=t[0].split(" "),o=r[0];"DESC"===r[1]&&e.features.sort(function(e,t){return t.attributes[o]-e.attributes[o]})}return e}).then(function(e){return t._wrapPoints(e,i)}).then(function(e){return e.features.length?e:null})},t.prototype._query=function(e,t,r){var o=this,i=this._createQuery(e,r,t);return this.queryFeatures(i.toJSON()).then(function(e){return o._applyProcessing(e,i)})},t.prototype._createQuery=function(e,t,r){var o=new h;return o.outFields=this.processor.queryInfo.outFields,o.where=this.processor.queryInfo.definitionExpression||"1=1",o.geometry=n.Extent.fromJSON({xmin:e[0],ymin:e[1],xmax:e[2],ymax:e[3],spatialReference:this.spatialReference}),this.service.capabilities.query.supportsQuantization?(o.quantizationParameters=t,"esriGeometryPolyline"===this.service.geometryType&&(o.maxAllowableOffset=t.tolerance)):o.maxAllowableOffset=t.tolerance,o.resultType="tile",o.returnExceededLimitFeatures=!1,o.returnGeometry=!0,o.returnCentroid=r.returnCentroid,o.orderByFields=r.orderByFields,o},t.prototype._applyProcessing=function(e,t){var r=this.processing;if(!r)return e;if(this._processingInMainThread)return this.remoteClient.invoke("executeProcessing",{query:t.toJSON(),featureSet:JSON.stringify(e)}).then(function(e){return JSON.parse(e)});try{var o=r.process(e,t,r.options);return o||a.reject(new s("FeatureLayer","invalid processing.process() method, returns nothing"))}catch(r){return this._processingInMainThread=!0,this.remoteClient.invoke("executeProcessing",{query:t.toJSON(),featureSet:JSON.stringify(e)}).then(function(e){return JSON.parse(e)})}},t.prototype._getQuantizationParameters=function(e){return y.default.fromJSON({mode:"view",originPosition:"upperLeft",tolerance:e.resolution,extent:{xmin:e.bounds[0],ymin:e.bounds[1],xmax:e.bounds[2],ymax:e.bounds[3],spatialReference:this.spatialReference}})},t.prototype._wrapPoints=function(e,t){if(0===e.features.length)return e;var r=t.returnCentroid,o=t.pixelBuffer,n=e.geometryType,s=e.spatialReference,u=e.transform;if("esriGeometryPoint"!==n&&"esriGeometryMultipoint"!==n&&!r||!l.isWrappable(s))return e;var a=e.features,p=l.getInfo(s),c=Math.round((p.valid[1]-p.valid[0])/u.scale[0]);if(512===c){for(var f=[],y=0,h=a;y<h.length;y++){var m=h[y],d=m.geometry,g=m.attributes;if(d)if(d.x<o){var _={geometry:i({},d),attributes:g};_.geometry.x+=c,f.push(_)}else if(d.x>512-o){var _={geometry:i({},d),attributes:g};_.geometry.x-=c,f.push(_)}}a.push.apply(a,f)}else for(var v=0,S=a;v<S.length;v++){var d=S[v].geometry;d&&(d.x<-o?d.x+=c:d.x>512+o&&(d.x-=c))}return e},t.prototype._cleanupPromise=function(e){this._promises.delete(e),this.notifyChange("updating")},o([c.property()],t.prototype,"configuration",void 0),o([c.property({readOnly:!0,dependsOn:["configuration"]})],t.prototype,"processing",null),o([c.property()],t.prototype,"updating",null),t=o([c.subclass()],t)}(c.declared(d.default));t.default=S});