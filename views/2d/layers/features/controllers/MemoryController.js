// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/declareExtendsHelper","../../../../../core/tsSupport/decorateHelper","../../../../../core/tsSupport/assignHelper","../../../../../core/tsSupport/generatorHelper","../../../../../core/tsSupport/awaiterHelper","../../../../../geometry","../../../../../core/Logger","../../../../../core/promiseUtils","../../../../../core/watchUtils","../../../../../core/workers","../../../../../core/accessorSupport/decorators","../../../../../geometry/support/spatialReferenceUtils","../../../../../layers/graphics/featureConversionUtils","../../../engine","./BaseController","../support/TileUpdateQueue"],function(e,t,r,i,o,s,u,n,a,l,c,p,h,f,d,y,m,v){Object.defineProperty(t,"__esModule",{value:!0});var g=a.getLogger("esri.views.2d.layers.features.controllers.MemoryController"),b=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="memory",t}return r(t,e),t.prototype.initialize=function(){var e=this;this._tileQueue=new v.default({tileInfoView:this.tileStore.tileScheme,process:function(t,r,i){return e._fetchFeatureSet(t,r,i)}}),this._memorySource=p.openWithPorts(this.service.source,{client:this}),this.refresh(),this._tileQueue.pause(),this.handles.add([c.once(this,"processor",function(){return e._tileQueue.resume()})])},t.prototype.destroy=function(){this._memorySource.close(),this._memorySource=null,this._tileQueue.clear(),this._tileQueue.pause()},Object.defineProperty(t.prototype,"updating",{get:function(){return this._tileQueue.updating},enumerable:!0,configurable:!0}),t.prototype.update=function(e,t){return u(this,void 0,void 0,function(){var r,i=this;return s(this,function(o){switch(o.label){case 0:return this.validateConfig(e,t),r=this.renderer.getAttributeHash(),this._set("config",e),[4,this.updatePixelBuffer()];case 1:return o.sent(),t?r===this.renderer.getAttributeHash()?[3,3]:[4,this.attributeStore.setAttributeBindings(this.renderer,this.arcadeInfo)]:[3,5];case 2:o.sent(),o.label=3;case 3:return[4,this.attributeStore.updateFilters(this)];case 4:return o.sent(),this.refresh(),[2];case 5:return"heatmap"===this.renderer.type?[2]:r===this.renderer.getAttributeHash()?[3,8]:[4,this.attributeStore.setAttributeBindings(this.renderer,this.arcadeInfo)];case 6:return o.sent(),[4,l.all(this.tileStore.tiles.map(function(e){return i._updateTileAttrData(e)}))];case 7:o.sent(),o.label=8;case 8:return[4,this.attributeStore.updateFilters(this)];case 9:return o.sent(),[4,this.attributeStore.sendUpdates()];case 10:return o.sent(),[2]}})})},t.prototype.invalidate=function(){this.refresh()},t.prototype.onEdits=function(e){this.refresh()},t.prototype.queryFeatures=function(e){return this._memorySource.invoke("queryFeatures",e)},t.prototype.queryFeatureCount=function(e){return this._memorySource.invoke("queryFeatureCount",e)},t.prototype.queryObjectIds=function(e){return this._memorySource.invoke("queryObjectIds",e)},t.prototype.queryExtent=function(e){return this._memorySource.invoke("queryExtent",e)},t.prototype.redraw=function(){this.refresh()},t.prototype.refresh=function(){this._tileQueue.refresh();for(var e=0,t=this.tileStore.tiles;e<t.length;e++){var r=t[e];this._tileQueue.push(r.id,r.updateTimestamp)}},t.prototype.setViewState=function(e){this.inherited(arguments),this._tileQueue.state=e},t.prototype.onTileUpdate=function(e){this._tileQueue.pause();for(var t=0,r=e.removed;t<r.length;t++){var i=r[t];this._tileQueue.abort(i.id)}for(var o=0,s=e.added;o<s.length;o++){var i=s[o];this._tileQueue.push(i.id,i.updateTimestamp)}this._tileQueue.resume()},t.prototype._updateTileAttrData=function(e){return u(this,void 0,void 0,function(){var t,r,i,o,u,n;return s(this,function(s){switch(s.label){case 0:return[4,this._query(e,this.queryInfo)];case 1:for(t=s.sent(),r=d.convertFromFeatureSet(t,this.service.objectIdField),r=d.hydrateOptimizedFeatureSet(r),i=0,o=r.features;i<o.length;i++)u=o[i],n=this.attributeStore.createLocalId(u.objectId),u.localId=n,this.attributeStore.setAttributeData(n,u,this.geometryInfo,this.viewParams);return[2]}})})},t.prototype._fetchFeatureSet=function(e,t,r){var i=this,o=this.tileStore.get(e),s=this.queryInfo;return this._query(o,s,r).then(function(e){return i._wrapPoints(e,s)}).then(function(e){return i._sortFeatures(e,s)}).then(function(e){return e.features.length?e:null}).then(function(e){return o.updateTimestamp=t,i.processor.onTileData(o,{addOrUpdate:e&&e.features,clear:!0,transformParams:e&&y.Utils.getTransformParams(e)},r)}).catch(function(e){return o.updateTimestamp=t,l.isAbortError(e)||(i.processor.onTileError(o,e.message,r),g.error("query-error",{error:e})),l.reject(e)})},t.prototype._query=function(e,t,r){var i=this,o=this._pixelBuffer*e.resolution,s=e.bounds.slice();s[0]-=o,s[1]-=o,s[2]+=o,s[3]+=o;var u=n.Extent.fromBounds(s,this.spatialReference),a=this._createQuery(u,e.extent,e.resolution,this.queryInfo);return this.queryFeatures(a.toJSON()).then(function(e){return t.returnCentroid?e.features=e.features.filter(function(e){return null!=e.geometry&&null!=e.centroid}):e.features=e.features.filter(function(e){return null!=e.geometry}),e}).then(function(e){return i._applyProcessing(e,r)}).then(function(e){var t=d.convertFromFeatureSet(e,i.service.objectIdField);t=d.hydrateOptimizedFeatureSet(t);for(var r=0;r<e.features.length;r++){var o=e.features[r],s=t.features[r],u=i.attributeStore.getLocalId(s.objectId);null==u&&(u=i.attributeStore.createLocalId(s.objectId)),s.localId=u,o.localId=u,i.attributeStore.setAttributeData(u,s,i.geometryInfo,i.viewParams)}return i.attributeStore.sendUpdates(),e})},t.prototype._wrapPoints=function(e,t){if(0===e.features.length)return e;var r=t.returnCentroid,i=this._pixelBuffer,s=e.geometryType,u=e.spatialReference,n=e.transform;if("esriGeometryPoint"!==s&&"esriGeometryMultipoint"!==s&&!r||!f.isWrappable(u))return e;var a=e.features,l=f.getInfo(u),c=Math.round((l.valid[1]-l.valid[0])/n.scale[0]);if(c===y.definitions.TILE_SIZE){for(var p=[],h=0,d=a;h<d.length;h++){var m=d[h],v=m.geometry,g=m.attributes;if(v)if(v.x<i){var b={geometry:o({},v),attributes:g};b.geometry.x+=c,p.push(b)}else if(v.x>y.definitions.TILE_SIZE-i){var b={geometry:o({},v),attributes:g};b.geometry.x-=c,p.push(b)}}a.push.apply(a,p)}else for(var _=0,S=a;_<S.length;_++){var v=S[_].geometry;v&&(v.x<-i?v.x+=c:v.x>y.definitions.TILE_SIZE+i&&(v.x-=c))}return e},t.prototype._sortFeatures=function(e,t){var r=t.orderByFields;if(r){var i=r[0].split(" "),o=i[0];"DESC"===i[1]&&e.features.sort(function(e,t){return t.attributes[o]-e.attributes[o]})}return e},i([h.property()],t.prototype,"_tileQueue",void 0),i([h.property({dependsOn:["_tileQueue.updating"]})],t.prototype,"updating",null),t=i([h.subclass("esri.views.2d.layers.features.controllers.MemoryController")],t)}(h.declared(m.default));t.default=b});