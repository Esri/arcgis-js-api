/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/has","../../../../core/Logger","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/decorators/subclass","../../../../core/urlUtils","../../../../core/uuid","../../../../portal/support/resourceExtension","../../../../core/promiseUtils","../../../../core/HandleOwner","../../../../layers/support/TileInfo","../../ViewState","../../tiling/TileInfoView","./support/TileStore","./processors","./support/UpdateToken","./controllers/FeatureController2D"],(function(e,t,r,o,s,n,i,l,c,a,u,p,d,h,f,y,_,g,S,v){"use strict";const w=new Set;let C=function(e){function r(){var t;return(t=e.apply(this,arguments)||this).controller=null,t.processor=null,t.remoteClient=null,t.tileStore=null,t.service=null,t.viewState=null,t}t._inheritsLoose(r,e);var o=r.prototype;return o.initialize=function(){this.handles.add(this.watch("updating",(e=>{this.remoteClient.invoke("setUpdating",e).catch((e=>{}))})))},o.destroy=function(){var e,t,r;null==(e=this.controller)||e.destroy(),null==(t=this.processor)||t.destroy(),null==(r=this.tileStore)||r.destroy(),this.controller=this.processor=this.tileStore=this.remoteClient=null},o.startup=async function({service:e,config:t,tileInfo:r}){if(this.service=e,!this.tileStore){const e=new y(h.fromJSON(r));this.tileStore=new _(e)}await this._configure(t),this.tileStore.clear()},o.updateTiles=async function(e){this.tileStore.updateTiles(e)},o.update=async function({config:e,pause:t}){const r=S.UpdateToken.empty();return await p.all([this.processor.update(r,e),this.controller.update(r,e,t)]),r.toJSON()},o.invalidate=async function(e){const t=S.UpdateToken.create(e),r=this.controller.invalidate(t);return await this.remoteClient.invoke("setUpdating",this.updating),r},o.setViewState=function(e){const t=f.fromJSON(e);this._set("viewState",t)},o._configure=async function(e){await p.all([this._handleControllerConfig(e),this._handleProcessorConfig(e)]),this.controller.processor=this.processor,await this.update({config:e})},o._handleControllerConfig=async function(e){const t=await this._createController(this.service,e);return await t.startup(),t},o._handleProcessorConfig=async function(e){return this._createProcessor(this.service,e)},o._createController=async function(e,t){this.controller&&this.controller.destroy();const{tileStore:r,remoteClient:o}=this,s=new v({service:e,config:t,tileStore:r,remoteClient:o});return this.controller=s,s},o._createProcessor=async function(e,t){const r=t.schema.processors[0].type,o=(await g.loadProcessorModule(r)).default,{remoteClient:s,tileStore:n}=this,i=new o({service:e,config:t,tileStore:n,remoteClient:s});return this.processor&&this.processor.destroy(),this.processor=i,i},t._createClass(r,[{key:"updating",get:function(){return!this.controller||this.controller.updating}}]),r}(d.HandleOwner);r.__decorate([i.property()],C.prototype,"controller",void 0),r.__decorate([i.property()],C.prototype,"processor",void 0),r.__decorate([i.property({dependsOn:["controller.updating"]})],C.prototype,"updating",null),r.__decorate([i.property()],C.prototype,"viewState",void 0),C=r.__decorate([l.subclass("esri.views.2d.layers.features.Pipeline")],C);var m=C;e.default=m,e.getInstances=function(){return w},Object.defineProperty(e,"__esModule",{value:!0})}));
