/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/HandleOwner","../../../../core/has","../../../../core/accessorSupport/decorators/property","../../../../core/arrayUtils","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","../../../../geometry/support/spatialReferenceUtils","../../../../layers/support/TileInfo","./processors","./controllers/FeatureController2D","./support/TileStore","./support/UpdateToken","../../tiling/TileInfoView"],(function(e,t,r,o,n,s,i,l,c,a,u,p,h,d,f,y){"use strict";const _=new Set;function v(){return _}let g=function(e){function r(){var t;return(t=e.apply(this,arguments)||this).controller=null,t.processor=null,t.remoteClient=null,t.tileStore=null,t.service=null,t.viewState=null,t._paused=!1,t._pendingTileUpdates=[],t}t._inheritsLoose(r,e);var o=r.prototype;return o.initialize=function(){this.handles.add(this.watch("updating",(e=>{this.remoteClient.invoke("setUpdating",e).catch((e=>{}))})))},o.destroy=function(){var e,t;this.stop(),null==(e=this.controller)||e.destroy(),null==(t=this.processor)||t.destroy(),this.controller=this.processor=this.tileStore=this.remoteClient=null},o.stop=function(){var e,t,r;this._paused=!0,Array.isArray(null==(e=this.service)?void 0:e.source)&&(this.service.source.forEach((e=>e.close())),this.service.source.length=0),null==(t=this.tileStore)||t.updateTiles({added:[],removed:this.tileStore.tiles.map((e=>e.id))}),null==(r=this.tileStore)||r.destroy(),this.tileStore=null,this._pendingTileUpdates.length=0},o.startup=function(){var e=t._asyncToGenerator((function*({service:e,config:t,tileInfo:r,tiles:o}){var n;if(this._paused=!0,Array.isArray(null==(n=this.service)?void 0:n.source)&&(this.service.source.forEach((e=>e.close())),this.service.source.length=0),this.service=e,!this.tileStore||!a.equals(this.tileStore.tileScheme.spatialReference,r.spatialReference)){var s,i;const e=new y(u.fromJSON(r));o.added.length=o.removed.length=0,null==(s=this.tileStore)||s.updateTiles({added:[],removed:this.tileStore.tiles.map((e=>e.id))}),null==(i=this.tileStore)||i.destroy(),this.tileStore=new d(e),this._pendingTileUpdates.length=0}for(yield this._createProcessorAndController(t),yield this.update({config:t},!0),this.tileStore.clear(),this.tileStore.updateTiles(o),this._paused=!1;this._pendingTileUpdates.length;)this.tileStore.updateTiles(this._pendingTileUpdates.pop())}));function r(t){return e.apply(this,arguments)}return r}(),o.updateTiles=function(){var e=t._asyncToGenerator((function*(e){this._paused?this._pendingTileUpdates.push(e):this.tileStore.updateTiles(e)}));function r(t){return e.apply(this,arguments)}return r}(),o.update=function(){var e=t._asyncToGenerator((function*({config:e},t=!1){const r=f.UpdateToken.empty();return t||this.controller.pause(),yield Promise.all([this.processor.update(r,e),this.controller.update(r,e)]),r.toJSON()}));function r(t){return e.apply(this,arguments)}return r}(),o.applyUpdate=function(){var e=t._asyncToGenerator((function*(e){return this.controller.applyUpdate(f.UpdateToken.create(e))}));function r(t){return e.apply(this,arguments)}return r}(),o._createProcessorAndController=function(){var e=t._asyncToGenerator((function*(e){yield Promise.all([this._handleControllerConfig(e),this._handleProcessorConfig(e)]),this.controller.processor=this.processor}));function r(t){return e.apply(this,arguments)}return r}(),o._handleControllerConfig=function(){var e=t._asyncToGenerator((function*(e){const t=yield this._createController(this.service,e);return yield t.startup(),t}));function r(t){return e.apply(this,arguments)}return r}(),o._handleProcessorConfig=function(){var e=t._asyncToGenerator((function*(e){return this._createProcessor(this.service,e)}));function r(t){return e.apply(this,arguments)}return r}(),o._createController=function(){var e=t._asyncToGenerator((function*(e,t){this.controller&&this.controller.destroy();const{tileStore:r,remoteClient:o}=this,n=new h({service:e,config:t,tileStore:r,remoteClient:o});return this.controller=n,n}));function r(t,r){return e.apply(this,arguments)}return r}(),o._createProcessor=function(){var e=t._asyncToGenerator((function*(e,t){const r=t.schema.processors[0].type,o=(yield p.loadProcessorModule(r)).default,{remoteClient:n,tileStore:s}=this,i=new o({service:e,config:t,tileStore:s,remoteClient:n});return this.processor&&this.processor.destroy(),this.processor=i,i}));function r(t,r){return e.apply(this,arguments)}return r}(),t._createClass(r,[{key:"updating",get:function(){return!this.controller||this.controller.updating}}]),r}(o.HandleOwner);r.__decorate([s.property()],g.prototype,"controller",void 0),r.__decorate([s.property()],g.prototype,"processor",void 0),r.__decorate([s.property()],g.prototype,"updating",null),r.__decorate([s.property()],g.prototype,"viewState",void 0),g=r.__decorate([c.subclass("esri.views.2d.layers.features.Pipeline")],g);const S=g;e.default=S,e.getInstances=v,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
