/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/has","../../../../../core/maybe","../../../../../layers/graphics/OptimizedGeometry","../../../../../layers/graphics/featureConversionUtils","../support/FeatureSetReaderJSON","../../../../../chunks/rbush","../../../../../layers/graphics/data/StreamFeatureManager","../../../../../layers/graphics/sources/connections/createConnection","./DataTileSource"],(function(e,t,n,o,r,i,s,a,c,u,d){"use strict";function h(e,t){const n=e.weakClone(),o=i.quantizeX(t,e.geometry.coords[0]),s=i.quantizeY(t,e.geometry.coords[1]);return n.geometry=new r([],[o,s]),n}function l(e,t){const n=a.rbush(9,function(e){switch(e){case"esriGeometryPoint":return e=>({minX:e.geometry.coords[0],minY:e.geometry.coords[1],maxX:e.geometry.coords[0],maxY:e.geometry.coords[1]});default:return e=>{let t=1/0,n=1/0,o=-1/0,r=-1/0;return e.geometry.forEachVertex(((e,i)=>{t=Math.min(t,e),n=Math.min(n,i),o=Math.max(o,e),r=Math.max(r,i)})),{minX:t,minY:n,maxX:o,maxY:r}}}}(t));return n.load(e),n}function m(e,t){return e.search({minX:t.bounds[0],minY:t.bounds[1],maxX:t.bounds[2],maxY:t.bounds[3]})}let f=function(){function e(e,t){this.onUpdate=e,this._geometryType=t,this._objectIdToFeature=new Map}var n=e.prototype;return n.add=function(e){this._objectIdToFeature.set(e.objectId,e),this._index=null},n.get=function(e){return this._objectIdToFeature.has(e)?this._objectIdToFeature.get(e):null},n.forEach=function(e){this._objectIdToFeature.forEach(e)},n.search=function(e){return this._index||(this._index=l(this._features,this._geometryType)),m(this._index,e)},n.removeById=function(e){const t=this._objectIdToFeature.get(e);return t?(this._objectIdToFeature.delete(e),this._index=null,t):null},n.update=function(e,t){this.onUpdate(e,t)},t._createClass(e,[{key:"_features",get:function(){const e=[];return this._objectIdToFeature.forEach((t=>e.push(t))),e}},{key:"size",get:function(){return this._objectIdToFeature.size}}]),e}(),_=function(e){function n(n){var o;(o=e.call(this,n)||this).type="geoevent",o._dataReceiveEventEnabled=!1,o._updateInfo={websocket:0,client:0};const{outSR:s}=n,{geometryType:a,objectIdField:d,timeInfo:l,purgeOptions:m,source:_,spatialReference:p,serviceFilter:y,maxReconnectionAttempts:g,maxReconnectionInterval:b,updateInterval:I}=n.serviceInfo,v=new f(o._onUpdate.bind(t._assertThisInitialized(o)),a),T=new c.default(v,d,l,m),F=u.createConnection(_,p,s,a,y,g,b);o._store=v,o._manager=T,o._connection=F,o._quantize=function(e){switch(e){case"esriGeometryPoint":return h;case"esriGeometryPolygon":case"esriGeometryPolyline":default:return(t,n)=>{const o=t.weakClone(),s=new r,a=i.quantizeOptimizedGeometry(s,t.geometry,!1,!1,e,n,!1,!1);return o.geometry=a,o}}}(a),o._handles=[o._connection.on("feature",(e=>o._onFeature(e))),o._connection.watch("connectionStatus",(e=>o.events.emit("connectionStatus",e))),o._connection.watch("errorString",(e=>o.events.emit("errorString",e)))];let w=performance.now();return o._updateIntervalId=setInterval((()=>{const e=performance.now(),t=e-w;if(t>2500){w=e;const n=Math.round(o._updateInfo.client/(t/1e3)),r=Math.round(o._updateInfo.websocket/(t/1e3));o._updateInfo.client=0,o._updateInfo.websocket=0,o.events.emit("updateRate",{client:n,websocket:r})}n.canAcceptRequest()&&o._manager.checkForUpdates()}),I),o}t._inheritsLoose(n,e);var a=n.prototype;return a.destroy=function(){clearInterval(this._updateIntervalId),this._handles.forEach((e=>e.remove())),this._connection.destroy()},a._fetchDataTile=function(){},a.enableEvent=function(e,t){"data-received"===e&&(this._dataReceiveEventEnabled=t)},a.subscribe=function(t){e.prototype.subscribe.call(this,t);const n=this._getTileFeatures(t);this._onRequest({tile:t,id:t.key.id,features:n,end:!0},"new")},a.unsubscribe=function(t){e.prototype.unsubscribe.call(this,t)},a.forEachRequest=function(e,t){const n=this._subscriptions.get(e),{tile:o,signal:r}=n;t({tile:o,id:e,features:this._getTileFeatures(o),end:!0},{signal:r})},a.resend=async function(e){this._subscriptions.forEach((t=>{const{tile:n}=t,o={tile:n,id:n.id,features:this._getTileFeatures(n),end:!0};this._onRequest(o,"update",e)}))},a._getTileFeatures=function(e){const t=this._store.search(e).map((t=>this._quantize(t,e.transform)));return s.FeatureSetReaderJSON.fromOptimizedFeatures(t,this.geometryType,e.transform)},a._onFeature=function(e){this._updateInfo.websocket++;try{this._dataReceiveEventEnabled&&this.events.emit("feature",e);const t=i.convertFromFeature(e,this.geometryType,!1,!1,this._serviceInfo.objectIdField);this._manager.add(t)}catch(e){}},a._onUpdate=async function(e,t){const n=o.andThen(e,(e=>l(e,this.geometryType))),r=o.andThen(t,(e=>l(e,this.geometryType)));o.isSome(e)&&(this._updateInfo.client+=e.length),this._subscriptions.forEach(((e,t)=>{const i=e.tile,a=o.andThen(n,(e=>m(e,i))),c=o.andThen(a,(e=>e.map((e=>this._quantize(e,i.transform))))),u=o.andThen(c,(e=>s.FeatureSetReaderJSON.fromOptimizedFeatures(e,this.geometryType,i.transform))),d=o.andThen(r,(e=>m(e,i))),h=o.andThen(d,(e=>e.map((e=>e.objectId))));this._onRequest({tile:i,id:t,features:u,remove:o.unwrapOr(h,[]),end:!0},"update")}))},t._createClass(n,[{key:"updating",get:function(){return!1}}]),n}(d.DataTileSource);e.GeoEventSource=_,Object.defineProperty(e,"__esModule",{value:!0})}));
