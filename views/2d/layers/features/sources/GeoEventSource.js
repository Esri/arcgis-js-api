/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/has","../../../../../core/maybe","../../../../../chunks/rbush","../../../../../layers/graphics/featureConversionUtils","../../../../../layers/graphics/OptimizedGeometry","../../../../../layers/graphics/data/StreamFeatureManager","../../../../../layers/graphics/sources/connections/createConnection","./DataTileSource","../support/FeatureSetReaderJSON","../support/UpdateToken"],(function(e,t,n,r,o,i,a,s,c,u,d,l){"use strict";const h=2500;function p(e,t){const n=e.weakClone();if(r.isSome(e.geometry)){const r=i.quantizeX(t,e.geometry.coords[0]),o=i.quantizeY(t,e.geometry.coords[1]);n.geometry=new a([],[r,o])}return n}function _(e){return"esriGeometryPoint"===e?p:(t,n)=>{const r=t.weakClone(),o=new a,s=!1,c=!1,u=i.quantizeOptimizedGeometry(o,t.geometry,s,c,e,n,!1,!1);return r.geometry=u,r}}function m(e){return"esriGeometryPoint"===e?e=>r.isSome(e.geometry)?{minX:e.geometry.coords[0],minY:e.geometry.coords[1],maxX:e.geometry.coords[0],maxY:e.geometry.coords[1]}:{minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}:e=>{let t=1/0,n=1/0,o=-1/0,i=-1/0;return r.isSome(e.geometry)&&e.geometry.forEachVertex(((e,r)=>{t=Math.min(t,e),n=Math.min(n,r),o=Math.max(o,e),i=Math.max(i,r)})),{minX:t,minY:n,maxX:o,maxY:i}}}function f(e,t){const n=o.rbush(9,m(t));return n.load(e),n}function y(e,t){return e.search({minX:t.bounds[0],minY:t.bounds[1],maxX:t.bounds[2],maxY:t.bounds[3]})}let v=function(){function e(e,t){this.onUpdate=e,this._geometryType=t,this._objectIdToFeature=new Map}var n=e.prototype;return n.add=function(e){this._objectIdToFeature.set(e.objectId,e),this._index=null},n.get=function(e){return this._objectIdToFeature.has(e)?this._objectIdToFeature.get(e):null},n.forEach=function(e){this._objectIdToFeature.forEach(e)},n.search=function(e){return this._index||(this._index=f(this._features,this._geometryType)),y(this._index,e)},n.removeById=function(e){const t=this._objectIdToFeature.get(e);return t?(this._objectIdToFeature.delete(e),this._index=null,t):null},n.update=function(e,t){this.onUpdate(e,t)},t._createClass(e,[{key:"_features",get:function(){const e=[];return this._objectIdToFeature.forEach((t=>e.push(t))),e}},{key:"size",get:function(){return this._objectIdToFeature.size}}]),e}(),g=function(e){function n(n){var r;(r=e.call(this,n)||this).type="geoevent",r._dataReceiveEventEnabled=!1,r._level=0,r._updateInfo={websocket:0,client:0};const{outSR:o}=n,{geometryType:i,objectIdField:a,timeInfo:u,purgeOptions:d,source:l,spatialReference:p,serviceFilter:m,maxReconnectionAttempts:f,maxReconnectionInterval:y,updateInterval:g,enableDataReceived:b,customParameters:I}=n.serviceInfo,S=new v(r._onUpdate.bind(t._assertThisInitialized(r)),i),F=new s.StreamFeatureManager(S,a,u,d),T=c.createConnection(l,p,o,i,m,f,y,I);return r._store=S,r._manager=F,r._connection=T,r._quantize=_(i),r._dataReceiveEventEnabled=b,r._handles=[r._connection.on("feature",(e=>r._onFeature(e))),r._connection.watch("connectionStatus",(e=>r.events.emit("connectionStatus",e))),r._connection.watch("errorString",(e=>r.events.emit("errorString",e)))],r._initUpdateInterval=()=>{let e=performance.now();r._updateIntervalId=setInterval((()=>{const t=performance.now(),o=t-e;if(o>h){e=t;const n=Math.round(r._updateInfo.client/(o/1e3)),i=Math.round(r._updateInfo.websocket/(o/1e3));r._updateInfo.client=0,r._updateInfo.websocket=0,r.events.emit("updateRate",{client:n,websocket:i})}n.canAcceptRequest()&&r._manager.checkForUpdates()}),g)},r._initUpdateInterval(),r}t._inheritsLoose(n,e);var o=n.prototype;return o.destroy=function(){e.prototype.destroy.call(this),this._clearUpdateInterval(),this._handles.forEach((e=>e.remove())),this._connection.destroy()},o._fetchDataTile=function(){},o.pauseStream=function(){this._clearUpdateInterval()},o.resumeStream=function(){this._initUpdateInterval()},o.enableEvent=function(e,t){"data-received"===e&&(this._dataReceiveEventEnabled=t)},o.subscribe=function(t){e.prototype.subscribe.call(this,t);const n=this._subscriptions.get(t.id);this._level=t.level;const r=this._getTileFeatures(t);this._onMessage({type:"append",id:t.key.id,addOrUpdate:r,end:!0}),n.didSend=!0},o.unsubscribe=function(t){e.prototype.unsubscribe.call(this,t)},o.readers=function*(e){const t=this._subscriptions.get(e),{tile:n}=t;yield this._getTileFeatures(n);for(const o of t.requests.stream.entries)r.isSome(o)&&r.isSome(o.addOrUpdate)&&(yield o.addOrUpdate)},o.createTileQuery=function(e){throw new Error("Service does not support tile  queries")},o.resend=function(){var e=t._asyncToGenerator((function*(){this._subscriptions.forEach((e=>{const{tile:t}=e,n={type:"append",id:t.id,addOrUpdate:this._getTileFeatures(t),end:!0};this._onMessage(n)}))}));function n(){return e.apply(this,arguments)}return n}(),o._getTileFeatures=function(e){const t=this._store.search(e).map((t=>this._quantize(t,e.transform)));return d.FeatureSetReaderJSON.fromOptimizedFeatures(t,this._serviceInfo,e.transform)},o._onFeature=function(e){this._updateInfo.websocket++;try{this._dataReceiveEventEnabled&&this.events.emit("feature",e);const t=i.convertFromFeature(e,this._serviceInfo.geometryType,!1,!1,this._serviceInfo.objectIdField);this._manager.add(t)}catch(t){}},o._clearUpdateInterval=function(){clearInterval(this._updateIntervalId),this._updateIntervalId=0},o._onUpdate=function(e,t){r.isSome(e)&&(this._updateInfo.client+=e.length),this._subscriptions.forEach(((e,t)=>{e.didSend&&e.tile.level===this._level&&this._onMessage({type:"append",id:t,addOrUpdate:null,clear:!0,end:!1})})),this._subscriptions.forEach(((e,t)=>{if(!e.didSend||e.tile.level!==this._level)return;const n=e.tile,r={type:"append",id:t,addOrUpdate:this._getTileFeatures(n),remove:[],end:!0,status:l.UpdateToken.empty()};e.requests.stream.enqueue(r),this._onMessage(r)}))},t._createClass(n,[{key:"updating",get:function(){return!1}}]),n}(u.DataTileSource);e.GeoEventSource=g,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
