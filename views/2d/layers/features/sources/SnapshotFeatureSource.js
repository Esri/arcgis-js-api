/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/has","../../../../../core/maybe","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/promiseUtils","../support/FeatureSetReaderPBFIndirect","../support/UpdateToken","./BaseFeatureSource"],(function(e,t,s,o,n,r,a,i,d,u){"use strict";const l=n.getLogger("esri.views.2d.layers.features.sources.SnapshotFeatureSource");function c(e,t,s){const o=e.getXHydrate(),n=e.getYHydrate(),r=t.getColumnForX(o),a=Math.floor(t.normalizeCol(r));return`${s}/${Math.floor(t.getRowForY(n))}/${a}`}function h(e,t){if(o.isNone(e))return null;const s=t.transform,n=e.getQuantizationTransform();if(o.isNone(n)){const[t,o]=s.scale,[n,r]=s.translate,a=-n/t,i=1/t,d=r/o,u=1/-o;return e.transform(a,d,i,u)}const[r,a]=n.scale,[i,d]=n.translate,[u,l]=s.scale,[c,h]=s.translate,_=r/u,p=(i-c)/u,g=a/l,f=(-d+h)/l;return e.transform(p,f,_,g)}let _=function(e){function s(t){var s;return(s=e.call(this,t)||this).mode="snapshot",s._loading=!0,s._controller=new AbortController,s._downloadPromise=null,s._didSendEnd=!1,s._queries=new Array,s._invalidated=!1,s._hasAggregates=!1,s._random=new r(1e3),s._featureCount=t.featureCount,s._store=t.store,s._markedIdsBufId=s._store.storage.createBitset(),s}t._inheritsLoose(s,e);var n=s.prototype;return n.destroy=function(){e.prototype.destroy.call(this),this._controller.abort()},n.update=function(t,s){e.prototype.update.call(this,t,s),this._hasAggregates=t.targets.aggregate},n.resend=async function(e=!1){if(await this._downloadPromise,this._invalidated||e)return this._invalidated=!1,this._subscriptions.forEach((e=>e.clear())),this._downloadPromise=this._download(this._featureCount),void await this._downloadPromise;const t=this._queries.map((({query:e,reader:t})=>this._sendPatchQuery(e,t)));await Promise.all(t),this._subscriptions.forEach((e=>{e.requests.done.forEach((e=>this._onMessage(e.message)))}))},n.refresh=async function(){await this.resend(!0)},n.edit=async function(e){const t=this._signal,s=[...e.addedFeatures.filter((e=>!e.error)).map((e=>e.objectId)),...e.updatedFeatures.filter((e=>!e.error)).map((e=>e.objectId))],o=[...e.deletedFeatures.filter((e=>!e.error)).map((e=>e.objectId)),...s];for(const a of o)this._store.remove(a);const n=this.createQuery();n.objectIds=s;const r=await this._queue.push({query:n,depth:0,signal:t});a.throwIfAborted({signal:t}),this._store.insert(r),this._send(r),this._invalidateQueries()},n._invalidateQueries=function(){this._invalidated=!0},n._sendPatchQuery=async function(e,t){const s=o.isSome(e.outFields)?e.outFields:[],n=this._queryInfo.outFields,r=n.filter((e=>-1===s.indexOf(e)));if(!r.length)return;const i=e.clone(),d=this._signal;i.returnGeometry=!1,i.returnCentroid=!1,i.outFields=r,e.outFields=n;const u=await this._queue.push({query:i,depth:0,signal:d});a.throwIfAborted({signal:d}),t.joinAttributes(u)},n._fetchDataTile=async function(e){this._downloadPromise||(this._downloadPromise=this._download(this._featureCount));const t=this._store.search(e),s=this._subscriptions.get(e.key.id),o=t.length-1;for(let u=0;u<o;u++){const o=h(t[u],e),n={type:"append",id:e.id,addOrUpdate:o,end:!1,status:d.UpdateToken.empty()};s.add({query:null,message:n}),this._hasAggregates||await a.after(1),this._onMessage(n)}const n=h(o>=0?t[o]:null,e),r=this._didSendEnd,i={type:"append",id:e.id,addOrUpdate:n,end:r,status:d.UpdateToken.empty()};s.add({query:null,message:i}),this._onMessage(i)},n._download=async function(e){try{await this.whenInitialized();const t=this._store.storage.getBitset(this._markedIdsBufId),s=new Set;t.clear();const o=Math.ceil(e/this.pageSize),n=Array.from({length:o},((e,t)=>t)).sort(((e,t)=>this._random.getInt()-this._random.getInt())).map((e=>this._downloadPage(e,t,s)));await Promise.all(n),this._store.sweepFeatures(t,this._store.storage),this._store.sweepFeatureSets(s)}catch(t){l.error("mapview-snapshot-source","Encountered and error when downloading feature snapshot",t)}this._sendEnd(),this._loading=!1},n._downloadPage=async function(e,t,s){const n=this.pageSize,r={start:e*n,num:n,cacheHint:!0};o.isSome(this.maxRecordCountFactor)&&(r.maxRecordCountFactor=this.maxRecordCountFactor);const i=this.createQuery(r),d=this._signal,u=await this._queue.push({query:i,depth:e,signal:d});a.throwIfAborted({signal:d}),this._queries.push({query:i,reader:u}),this._store.insert(u),s.add(u.instance);const l=u.getCursor();for(;l.next();)t.set(l.getDisplayId());this._send(u)},n._send=function(e){if(!this._subscriptions.size)return;let t=null;const s=new Map,n=new Set,r=new Map;this._subscriptions.forEach((e=>{var o;const a=e.tile;s.set(a.key.id,null),t=a.tileInfoView,n.add(a.level);const{row:i,col:d}=a.key,u=`${a.level}/${i}/${d}`,l=null!=(o=r.get(u))?o:[];l.push(e),r.set(u,l)}));for(const a of n){const n=t.getLODInfoAt(a),i=e.getCursor();for(;i.next();){const e=c(i,n,a),t=i.getIndex();if(r.has(e))for(const n of r.get(e)){const e=n.tile.id;let r=s.get(e);o.isNone(r)&&(r=[],s.set(e,r)),r.push(t)}}}s.forEach(((t,s)=>{if(o.isSome(t)){const o=this._subscriptions.get(s),n={type:"append",id:s,addOrUpdate:h(i.FeatureSetReaderIndirect.from(e,t),o.tile),end:!1,status:d.UpdateToken.empty()};o.add({query:null,message:n}),this._onMessage(n)}}))},n._sendEnd=function(){this._subscriptions.forEach((e=>{const t={type:"append",id:e.tile.id,addOrUpdate:null,end:!0,status:d.UpdateToken.empty()};e.add({query:null,message:t}),this._onMessage(t)})),this._didSendEnd=!0},t._createClass(s,[{key:"loading",get:function(){return this._loading}},{key:"_signal",get:function(){return this._controller.signal}}]),s}(u.BaseFeatureSource);e.SnapshotFeatureSource=_,Object.defineProperty(e,"__esModule",{value:!0})}));
