/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/has","../../../../../core/Logger","../../../../../core/maybe","../../../../../core/promiseUtils","../../../../../core/RandomLCG","./BaseFeatureSource","../support/FeatureSetReaderPBFIndirect","../support/UpdateToken"],(function(e,t,n,s,r,o,i,a,u,d){"use strict";function l(e,t,n){const s=e.getXHydrated(),r=e.getYHydrated(),o=t.getColumnForX(s),i=Math.floor(t.normalizeCol(o));return`${n}/${Math.floor(t.getRowForY(r))}/${i}`}function c(e,t){if(r.isNone(e))return null;const n=t.transform,s=e.getQuantizationTransform();if(r.isNone(s)){const[t,s]=n.scale,[r,o]=n.translate,i=-r/t,a=1/t,u=o/s,d=1/-s;return e.transform(i,u,a,d)}const[o,i]=s.scale,[a,u]=s.translate,[d,l]=n.scale,[c,h]=n.translate,p=o/d,f=(a-c)/d,_=i/l,g=(-u+h)/l;return e.transform(f,g,p,_)}let h=function(e){function n(t){var n;return(n=e.call(this,t)||this).mode="snapshot",n._loading=!0,n._controller=new AbortController,n._downloadPromise=null,n._didSendEnd=!1,n._queries=new Array,n._invalidated=!1,n._hasAggregates=!1,n._random=new i(1e3),n._store=t.store,n._markedIdsBufId=n._store.storage.createBitset(),n}t._inheritsLoose(n,e);var a=n.prototype;return a.destroy=function(){e.prototype.destroy.call(this),this._controller.abort()},a.update=function(t,n){e.prototype.update.call(this,t,n),null==this._featureCount&&(this._featureCount=n.initialFeatureCount),r.isSome(n.changedFeatureCount)&&(this._featureCount=n.changedFeatureCount),this._hasAggregates=t.targets.aggregate},a.resend=function(){var e=t._asyncToGenerator((function*(e=!1){if(yield this._downloadPromise,this._invalidated||e){const e=r.unwrapOrThrow(this._featureCount,"Expected featureCount to be defined");return this._invalidated=!1,this._subscriptions.forEach((e=>e.clear())),this._downloadPromise=this._download(e),void(yield this._downloadPromise)}const t=this._queries.map((({query:e,reader:t})=>this._sendPatchQuery(e,t)));yield Promise.all(t),this._subscriptions.forEach((e=>{e.requests.done.forEach((e=>this._onMessage(e.message)))}))}));function n(){return e.apply(this,arguments)}return n}(),a.refresh=function(){var e=t._asyncToGenerator((function*(e,t){t&&(this._featureCount=t.featureCount),yield this.resend(!0)}));function n(t,n){return e.apply(this,arguments)}return n}(),a._sendPatchQuery=function(){var e=t._asyncToGenerator((function*(e,t){const n=r.isSome(e.outFields)?e.outFields:[],s=this._queryInfo.outFields,i=s.filter((e=>!n.includes(e)));if(!i.length)return;const a=e.clone(),u=this._signal;a.returnGeometry=!1,a.returnCentroid=!1,a.outFields=i,e.outFields=s;const d=yield this._queue.push({query:a,depth:0,signal:u});o.throwIfAborted({signal:u}),t.joinAttributes(d)}));function n(t,n){return e.apply(this,arguments)}return n}(),a._fetchDataTile=function(){var e=t._asyncToGenerator((function*(e){if(!this._downloadPromise){const e=r.unwrapOrThrow(this._featureCount,"Expected featureCount to be defined");this._downloadPromise=this._download(e)}const t=this._store.search(e),n=this._subscriptions.get(e.key.id),s=t.length-1;for(let r=0;r<s;r++){const s=c(t[r],e),i={type:"append",id:e.id,addOrUpdate:s,end:!1,status:d.UpdateToken.empty()};n.add({query:null,message:i}),this._hasAggregates||(yield o.after(1)),this._onMessage(i)}const i=c(s>=0?t[s]:null,e),a=this._didSendEnd,u={type:"append",id:e.id,addOrUpdate:i,end:a,status:d.UpdateToken.empty()};n.add({query:null,message:u}),this._onMessage(u)}));function n(t){return e.apply(this,arguments)}return n}(),a._download=function(){var e=t._asyncToGenerator((function*(e){try{yield this.whenInitialized();const t=this._store.storage.getBitset(this._markedIdsBufId),n=new Set;t.clear();const s=Math.ceil(e/this.pageSize),r=Array.from({length:s},((e,t)=>t)).sort(((e,t)=>this._random.getInt()-this._random.getInt())).map((e=>this._downloadPage(e,t,n)));yield Promise.all(r),this._store.sweepFeatures(t,this._store.storage),this._store.sweepFeatureSets(n)}catch(t){s.getLogger("esri.views.2d.layers.features.sources.SnapshotFeatureSource").error("mapview-snapshot-source","Encountered and error when downloading feature snapshot",t)}this._sendEnd(),this._loading=!1}));function n(t){return e.apply(this,arguments)}return n}(),a._downloadPage=function(){var e=t._asyncToGenerator((function*(e,t,n){const s=this.pageSize,i={start:e*s,num:s,cacheHint:!0};r.isSome(this.maxRecordCountFactor)&&(i.maxRecordCountFactor=this.maxRecordCountFactor);const a=this.createQuery(i),u=this._signal,d=yield this._queue.push({query:a,depth:e,signal:u});o.throwIfAborted({signal:u}),this._queries.push({query:a,reader:d}),this._store.insert(d),n.add(d.instance);const l=d.getCursor();for(;l.next();)t.set(l.getDisplayId());this._send(d)}));function n(t,n,s){return e.apply(this,arguments)}return n}(),a._send=function(e){if(!this._subscriptions.size)return;let t=null;const n=new Map,s=new Set,o=new Map;this._subscriptions.forEach((e=>{const r=e.tile;n.set(r.key.id,null),t=r.tileInfoView,s.add(r.level);const{row:i,col:a}=r.key,u=`${r.level}/${i}/${a}`,d=o.get(u)??[];d.push(e),o.set(u,d)}));for(const i of s){const s=t.getLODInfoAt(i),a=e.getCursor();for(;a.next();){const e=l(a,s,i),t=a.getIndex();if(o.has(e))for(const s of o.get(e)){const e=s.tile.id;let o=n.get(e);r.isNone(o)&&(o=[],n.set(e,o)),o.push(t)}}}n.forEach(((t,n)=>{if(r.isSome(t)){const s=this._subscriptions.get(n),r={type:"append",id:n,addOrUpdate:c(u.FeatureSetReaderIndirect.from(e,t),s.tile),end:!1,status:d.UpdateToken.empty()};s.add({query:null,message:r}),this._onMessage(r)}}))},a._sendEnd=function(){this._subscriptions.forEach((e=>{const t={type:"append",id:e.tile.id,addOrUpdate:null,end:!0,status:d.UpdateToken.empty()};e.add({query:null,message:t}),this._onMessage(t)})),this._didSendEnd=!0},t._createClass(n,[{key:"loading",get:function(){return this._loading}},{key:"_signal",get:function(){return this._controller.signal}}]),n}(a.BaseFeatureSource);e.SnapshotFeatureSource=h,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
