/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/has","../../../../../core/Logger","../../../../../core/maybe","../../../../../core/promiseUtils","../../../../../core/RandomLCG","./BaseFeatureSource","../support/FeatureSetReaderPBFIndirect","../support/UpdateToken"],(function(e,t,s,n,r,o,i,a,d,u){"use strict";const l=n.getLogger("esri.views.2d.layers.features.sources.SnapshotFeatureSource");function c(e,t,s){const n=e.getXHydrated(),r=e.getYHydrated(),o=t.getColumnForX(n),i=Math.floor(t.normalizeCol(o));return`${s}/${Math.floor(t.getRowForY(r))}/${i}`}function h(e,t){if(r.isNone(e))return null;const s=t.transform,n=e.getQuantizationTransform();if(r.isNone(n)){const[t,n]=s.scale,[r,o]=s.translate,i=-r/t,a=1/t,d=o/n,u=1/-n;return e.transform(i,d,a,u)}const[o,i]=n.scale,[a,d]=n.translate,[u,l]=s.scale,[c,h]=s.translate,p=o/u,f=(a-c)/u,_=i/l,g=(-d+h)/l;return e.transform(f,g,p,_)}let p=function(e){function s(t){var s;return(s=e.call(this,t)||this).mode="snapshot",s._loading=!0,s._controller=new AbortController,s._downloadPromise=null,s._didSendEnd=!1,s._queries=new Array,s._invalidated=!1,s._hasAggregates=!1,s._random=new i(1e3),s._store=t.store,s._markedIdsBufId=s._store.storage.createBitset(),s}t._inheritsLoose(s,e);var n=s.prototype;return n.destroy=function(){e.prototype.destroy.call(this),this._controller.abort()},n.update=function(t,s){e.prototype.update.call(this,t,s),this._hasAggregates=t.targets.aggregate},n.resend=function(){var e=t._asyncToGenerator((function*(e=!1){if(yield this._downloadPromise,this._invalidated||e){const e=r.unwrapOrThrow(this._schema.featureCount,"Expected featureCount to be defined");return this._invalidated=!1,this._subscriptions.forEach((e=>e.clear())),this._downloadPromise=this._download(e),void(yield this._downloadPromise)}const t=this._queries.map((({query:e,reader:t})=>this._sendPatchQuery(e,t)));yield Promise.all(t),this._subscriptions.forEach((e=>{e.requests.done.forEach((e=>this._onMessage(e.message)))}))}));function s(){return e.apply(this,arguments)}return s}(),n.refresh=function(){var e=t._asyncToGenerator((function*(){yield this.resend(!0)}));function s(){return e.apply(this,arguments)}return s}(),n._sendPatchQuery=function(){var e=t._asyncToGenerator((function*(e,t){const s=r.isSome(e.outFields)?e.outFields:[],n=this._queryInfo.outFields,i=n.filter((e=>-1===s.indexOf(e)));if(!i.length)return;const a=e.clone(),d=this._signal;a.returnGeometry=!1,a.returnCentroid=!1,a.outFields=i,e.outFields=n;const u=yield this._queue.push({query:a,depth:0,signal:d});o.throwIfAborted({signal:d}),t.joinAttributes(u)}));function s(t,s){return e.apply(this,arguments)}return s}(),n._fetchDataTile=function(){var e=t._asyncToGenerator((function*(e){if(!this._downloadPromise){const e=r.unwrapOrThrow(this._schema.featureCount,"Expected featureCount to be defined");this._downloadPromise=this._download(e)}const t=this._store.search(e),s=this._subscriptions.get(e.key.id),n=t.length-1;for(let r=0;r<n;r++){const n=h(t[r],e),i={type:"append",id:e.id,addOrUpdate:n,end:!1,status:u.UpdateToken.empty()};s.add({query:null,message:i}),this._hasAggregates||(yield o.after(1)),this._onMessage(i)}const i=h(n>=0?t[n]:null,e),a=this._didSendEnd,d={type:"append",id:e.id,addOrUpdate:i,end:a,status:u.UpdateToken.empty()};s.add({query:null,message:d}),this._onMessage(d)}));function s(t){return e.apply(this,arguments)}return s}(),n._download=function(){var e=t._asyncToGenerator((function*(e){try{yield this.whenInitialized();const t=this._store.storage.getBitset(this._markedIdsBufId),s=new Set;t.clear();const n=Math.ceil(e/this.pageSize),r=Array.from({length:n},((e,t)=>t)).sort(((e,t)=>this._random.getInt()-this._random.getInt())).map((e=>this._downloadPage(e,t,s)));yield Promise.all(r),this._store.sweepFeatures(t,this._store.storage),this._store.sweepFeatureSets(s)}catch(t){l.error("mapview-snapshot-source","Encountered and error when downloading feature snapshot",t)}this._sendEnd(),this._loading=!1}));function s(t){return e.apply(this,arguments)}return s}(),n._downloadPage=function(){var e=t._asyncToGenerator((function*(e,t,s){const n=this.pageSize,i={start:e*n,num:n,cacheHint:!0};r.isSome(this.maxRecordCountFactor)&&(i.maxRecordCountFactor=this.maxRecordCountFactor);const a=this.createQuery(i),d=this._signal,u=yield this._queue.push({query:a,depth:e,signal:d});o.throwIfAborted({signal:d}),this._queries.push({query:a,reader:u}),this._store.insert(u),s.add(u.instance);const l=u.getCursor();for(;l.next();)t.set(l.getDisplayId());this._send(u)}));function s(t,s,n){return e.apply(this,arguments)}return s}(),n._send=function(e){if(!this._subscriptions.size)return;let t=null;const s=new Map,n=new Set,o=new Map;this._subscriptions.forEach((e=>{var r;const i=e.tile;s.set(i.key.id,null),t=i.tileInfoView,n.add(i.level);const{row:a,col:d}=i.key,u=`${i.level}/${a}/${d}`,l=null!=(r=o.get(u))?r:[];l.push(e),o.set(u,l)}));for(const i of n){const n=t.getLODInfoAt(i),a=e.getCursor();for(;a.next();){const e=c(a,n,i),t=a.getIndex();if(o.has(e))for(const n of o.get(e)){const e=n.tile.id;let o=s.get(e);r.isNone(o)&&(o=[],s.set(e,o)),o.push(t)}}}s.forEach(((t,s)=>{if(r.isSome(t)){const n=this._subscriptions.get(s),r={type:"append",id:s,addOrUpdate:h(d.FeatureSetReaderIndirect.from(e,t),n.tile),end:!1,status:u.UpdateToken.empty()};n.add({query:null,message:r}),this._onMessage(r)}}))},n._sendEnd=function(){this._subscriptions.forEach((e=>{const t={type:"append",id:e.tile.id,addOrUpdate:null,end:!0,status:u.UpdateToken.empty()};e.add({query:null,message:t}),this._onMessage(t)})),this._didSendEnd=!0},t._createClass(s,[{key:"loading",get:function(){return this._loading}},{key:"_signal",get:function(){return this._controller.signal}}]),s}(a.BaseFeatureSource);e.SnapshotFeatureSource=p,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
