/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../TimeExtent","../../../../../core/Evented","../../../../../core/has","../../../../../core/maybe","../../../../../core/promiseUtils","../../../../../core/accessorSupport/diffUtils","../../../../../rest/support/Query","./DataTileSubscription"],(function(e,t,i,r,s,n,o,u,c,a){"use strict";function h(e,t){const i=new Set;return e&&e.forEach((e=>i.add(e))),t&&t.forEach((e=>i.add(e))),i.has("*")?["*"]:Array.from(i)}let l=function(){function e(e){this.events=new r,this._resolver=o.createResolver(),this._didEdit=!1,this._subscriptions=new Map,this._outSR=e.outSR,this._serviceInfo=e.serviceInfo,this._onTileUpdateMessage=e.onMessage}var l=e.prototype;return l.destroy=function(){},l._onMessage=function(){var e=t._asyncToGenerator((function*(e){var t;const i=this._subscriptions.get(e.id);if(!i)return;const r={...e,remove:null!=(t=e.remove)?t:[],status:e.status};return this._onTileUpdateMessage(r,i.options)}));function i(t){return e.apply(this,arguments)}return i}(),l.update=function(e,t){var r;const n=t.fields.length;t.outFields=h(null==(r=this._schema)?void 0:r.outFields,t.outFields),t.outFields=t.outFields.length>=.75*n?["*"]:t.outFields,t.outFields.sort();const o=u.diff(this._schema,t);if(!o)return;s("esri-2d-update-debug")&&console.debug("Applying Update - Source:",o);const c={returnCentroid:s("esri-2d-query-centroid-enabled")&&"esriGeometryPolygon"===this._serviceInfo.geometryType,returnGeometry:!0,outFields:t.outFields,outSpatialReference:this._outSR,orderByFields:[`${this._serviceInfo.objectIdField} ASC`],where:t.definitionExpression||"1=1",gdbVersion:t.gdbVersion,historicMoment:t.historicMoment,timeExtent:i.fromJSON(t.timeExtent)},a=this._schema&&u.hasDiff(o,"outFields");this._schema&&u.hasDiffAny(o,["timeExtent","definitionExpression","gdbVersion","historicMoment"])&&(e.why.mesh.push("Layer filter changed"),e.why.source.push("Layer filter changed"),e.mesh=!0,e.source=!0,e.queryFilter=!0),a&&(e.why.source.push("Layer required fields changed"),e.source=!0),u.diff(c,this._queryInfo)&&(this._queryInfo=c),this._schema=t,this._resolver.resolve()},l.whenInitialized=function(){return this._resolver.promise},l.applyUpdate=function(){var e=t._asyncToGenerator((function*(e){if(e.queryFilter||e.source&&this._didEdit)return this.refresh(),void(this._didEdit=!1);this._subscriptions.forEach((t=>t.applyUpdate(e))),yield this.resend()}));function i(t){return e.apply(this,arguments)}return i}(),l.refresh=function(){for(const e of this._tiles())this.unsubscribe(e),this.subscribe(e)},l.subscribe=function(e){const t=new a.DataTileSubscription(e);this._subscriptions.set(e.id,t)},l.unsubscribe=function(e){const t=this.get(e.id);n.isSome(t)&&t.abort(),this._subscriptions.delete(e.id)},l.createQuery=function(e={}){const t=this._queryInfo.historicMoment?new Date(this._queryInfo.historicMoment):null;return new c({...this._queryInfo,historicMoment:t,...e})},l.get=function(e){return this._subscriptions.has(e)?this._subscriptions.get(e):null},l.queryLastEditDate=function(){var e=t._asyncToGenerator((function*(){throw new Error("Service does not support query type")}));function i(){return e.apply(this,arguments)}return i}(),l.query=function(){var e=t._asyncToGenerator((function*(e){throw new Error("Service does not support query")}));function i(t){return e.apply(this,arguments)}return i}(),l._tiles=function*(){const e=Array.from(this._subscriptions.values());for(const t of e)yield t.tile},l.edit=function(){var e=t._asyncToGenerator((function*(e,i){var r=this;const s=Array.from(this._subscriptions.values()),n=s.map((({tile:e})=>e));for(const t of s)t.removeIds(i);if(e.length){const s=n.map((t=>{const i=this.createTileQuery(t);return i.objectIds=e,{tile:t,query:i}})).map(function(){var e=t._asyncToGenerator((function*({tile:e,query:t}){return{tile:e,result:yield r.query(t),query:t}}));return function(t){return e.apply(this,arguments)}}()),u=(yield o.eachAlwaysValues(s)).map(function(){var s=t._asyncToGenerator((function*({tile:t,result:s}){if(!s.hasFeatures&&!i.length&&!e.length)return;const n=r._subscriptions.get(t.key.id);n&&n.edit(s,e)}));return function(e){return s.apply(this,arguments)}}());yield o.eachAlways(u)}this._didEdit=!0}));function i(t,i){return e.apply(this,arguments)}return i}(),e}();e.DataTileSource=l,Object.defineProperty(e,"__esModule",{value:!0})}));
