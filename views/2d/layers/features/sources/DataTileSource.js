/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../TimeExtent","../../../../../core/Accessor","../../../../../core/Evented","../../../../../core/has","../../../../../core/maybe","../../../../../core/promiseUtils","../../../../../core/accessorSupport/diffUtils","../../../../../rest/support/Query","./DataTileSubscription","../support/UpdateToken"],(function(e,t,r,i,s,n,o,u,c,a,l,h){"use strict";function d(e,t){const r=new Set;return e&&e.forEach((e=>r.add(e))),t&&t.forEach((e=>r.add(e))),r.has("*")?["*"]:Array.from(r)}let f=function(e){function i(t){var r;return(r=e.call(this)||this).events=new s,r._resolver=u.createResolver(),r._didEdit=!1,r._subscriptions=new Map,r._outSR=t.outSR,r._serviceInfo=t.serviceInfo,r._onTileUpdateMessage=t.onMessage,r}t._inheritsLoose(i,e);var f=i.prototype;return f._onMessage=function(){var e=t._asyncToGenerator((function*(e){const t=this._subscriptions.get(e.id);if(!t)return;const r={...e,remove:e.remove??[],status:e.status??h.UpdateToken.empty()};return u.ignoreAbortErrors(this._onTileUpdateMessage(r,t.options))}));function r(t){return e.apply(this,arguments)}return r}(),f.update=function(e,t){const i=t.fields.length;t.outFields=d(this._schema?.outFields,t.outFields),t.outFields=t.outFields.length>=.75*i?["*"]:t.outFields,t.outFields.sort();const s=c.diff(this._schema,t);if(!s)return;n("esri-2d-update-debug")&&console.debug("Applying Update - Source:",s);const o="orderByFields"in this._serviceInfo&&this._serviceInfo.orderByFields?this._serviceInfo.orderByFields:this._serviceInfo.objectIdField+" ASC",u={returnCentroid:"esriGeometryPolygon"===this._serviceInfo.geometryType,returnGeometry:!0,timeReferenceUnknownClient:"stream"!==this._serviceInfo.type&&this._serviceInfo.timeReferenceUnknownClient,outFields:t.outFields,outSpatialReference:this._outSR,orderByFields:[o],where:t.definitionExpression||"1=1",gdbVersion:t.gdbVersion,historicMoment:t.historicMoment,timeExtent:t.timeExtent?r.fromJSON(t.timeExtent):null},a=this._schema&&c.hasDiff(s,"outFields");this._schema&&c.hasDiffAny(s,["timeExtent","definitionExpression","gdbVersion","historicMoment","customParameters"])&&(e.why.mesh.push("Layer filter and/or custom parameters changed"),e.why.source.push("Layer filter and/or custom parameters changed"),e.mesh=!0,e.source=!0,e.queryFilter=!0),a&&(e.why.source.push("Layer required fields changed"),e.source=!0),c.diff(u,this._queryInfo)&&(this._queryInfo=u),this._schema=t,this._resolver.resolve()},f.whenInitialized=function(){return this._resolver.promise},f.applyUpdate=function(){var e=t._asyncToGenerator((function*(e){if(e.queryFilter||e.source&&this._didEdit)return this.refresh(e.version),void(this._didEdit=!1);this._subscriptions.forEach((t=>t.applyUpdate(e))),yield this.resend()}));function r(t){return e.apply(this,arguments)}return r}(),f.refresh=function(e,t){for(const r of this._tiles())this.unsubscribe(r),this.subscribe(r,e)},f.subscribe=function(e,t){const r=new l.DataTileSubscription(e,t);this._subscriptions.set(e.id,r)},f.unsubscribe=function(e){const t=this.getSubscription(e.id);o.isSome(t)&&t.abort(),this._subscriptions.delete(e.id)},f.createQuery=function(e={}){const t=this._queryInfo.historicMoment?new Date(this._queryInfo.historicMoment):null;return new a({...this._queryInfo,historicMoment:t,...e})},f.getSubscription=function(e){return this._subscriptions.has(e)?this._subscriptions.get(e):null},f.queryLastEditDate=function(){var e=t._asyncToGenerator((function*(){throw new Error("Service does not support query type")}));function r(){return e.apply(this,arguments)}return r}(),f.query=function(){var e=t._asyncToGenerator((function*(e,t){throw new Error("Service does not support query")}));function r(t,r){return e.apply(this,arguments)}return r}(),f._tiles=function*(){const e=Array.from(this._subscriptions.values());for(const t of e)yield t.tile},f.edit=function(){var e=t._asyncToGenerator((function*(e,r){var i=this;const s=Array.from(this._subscriptions.values()),o=s.map((({tile:e})=>e));for(const t of s)t.removeIds(r);if(e.length){const s=o.map((t=>{const r=this.createTileQuery(t);return r.objectIds=e,{tile:t,query:r}})).map(function(){var e=t._asyncToGenerator((function*({tile:e,query:t}){return{tile:e,result:yield i.query(t,{query:{tile:n("esri-tiles-debug")?e.id.replace(/\//g,"."):void 0}}),query:t}}));return function(t){return e.apply(this,arguments)}}()),c=(yield u.eachAlwaysValues(s)).map(function(){var s=t._asyncToGenerator((function*({tile:t,result:s}){if(!s.hasFeatures&&!r.length&&!e.length)return;const n=i._subscriptions.get(t.key.id);n&&n.edit(s,e)}));return function(e){return s.apply(this,arguments)}}());yield u.eachAlways(c)}this._didEdit=!0}));function r(t,r){return e.apply(this,arguments)}return r}(),i}(i);e.DataTileSource=f,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
