/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../../core/has","../../../../../core/maybe","../../../../../core/promiseUtils","../../../../../core/Evented","../../../../../TimeExtent","../../../../../core/accessorSupport/diffUtils","../../../../../tasks/support/Query","../controllers/EditsQueue","../support/UpdateToken","./DataTileSubscription"],(function(e,t,s,i,r,n,o,u,a,c,d){"use strict";function h(e,t){const s=new Set;return e&&e.forEach((e=>s.add(e))),t&&t.forEach((e=>s.add(e))),s.has("*")?["*"]:Array.from(s)}let l=function(){function e(e){this.events=new r,this._pendingEdits=new Set,this._resolver=i.createResolver(),this._editsQueue=new a.EditsQueue({processEdits:(e,t)=>this._processEdit(e,t)}),this._subscriptions=new Map,this._outSR=e.outSR,this._serviceInfo=e.serviceInfo,this._onTileUpdateMessage=e.onMessage}var l=e.prototype;return l.destroy=function(){this._editsQueue.clear()},l._onMessage=async function(e){var t;const s=this._subscriptions.get(e.id);if(!s)return;const i={...e,remove:null!=(t=e.remove)?t:[],status:e.status};return this._onTileUpdateMessage(i,s.options)},l.update=function(e,s){var i;const r=s.fields.length;s.outFields=h(null==(i=this._schema)?void 0:i.outFields,s.outFields),s.outFields=s.outFields.length>=.75*r?["*"]:s.outFields,s.outFields.sort();const u=o.diff(this._schema,s);if(!u)return;t("esri-2d-update-debug")&&console.debug("Applying Update - Source:",u);const a={returnCentroid:t("esri-2d-query-centroid-enabled")&&"esriGeometryPolygon"===this._serviceInfo.geometryType,returnGeometry:!0,outFields:s.outFields,outSpatialReference:this._outSR,orderByFields:[`${this._serviceInfo.objectIdField} ASC`],where:s.definitionExpression||"1=1",gdbVersion:s.gdbVersion,historicMoment:s.historicMoment?new Date(s.historicMoment):null,timeExtent:n.fromJSON(s.timeExtent)},c=this._schema&&o.hasDiff(u,"outFields");this._schema&&o.hasDiffAny(u,["timeExtent","definitionExpression","gdbVersion","historicMoment"])&&(e.why.mesh.push("Layer filter changed"),e.why.source.push("Layer filter changed"),e.mesh=!0,e.source=!0,e.queryFilter=!0,this._invalidate("all")),c&&(e.why.source.push("Layer required fields changed"),e.source=!0,this._invalidate("fields")),o.diff(a,this._queryInfo)&&(this._queryInfo=a),this._schema=s,this._resolver.resolve()},l.whenInitialized=function(){return this._resolver.promise},l.applyUpdate=async function(e){e.queryFilter?this.refresh():(this._subscriptions.forEach((t=>t.applyUpdate(e))),await this.resend())},l.refresh=function(){for(const e of this._tiles())this.unsubscribe(e),this.subscribe(e)},l._tiles=function(){const e=[];return this._subscriptions.forEach((t=>e.push(t.tile))),e},l.pause=function(){this._subscriptions.forEach((e=>e.abort()))},l.subscribe=function(e){const t=new d.DataTileSubscription(e);this._subscriptions.set(e.id,t)},l.unsubscribe=function(e){const t=this.get(e.id);s.isSome(t)&&t.abort(),this._subscriptions.delete(e.id)},l.forEachPendingEdit=function(e){Array.from(this._subscriptions.values()).some((e=>"none"!==e.invalid))?this._pendingEdits.forEach(e):this._pendingEdits.clear()},l.edit=async function(e){return this._editsQueue.push(e)},l.createQuery=function(e={}){return new u({...this._queryInfo,...e})},l.get=function(e){return this._subscriptions.has(e)?this._subscriptions.get(e):null},l.queryLastEditDate=async function(){throw new Error("Service does not support query type")},l.query=async function(e,t){throw new Error("Service does not support query")},l._invalidate=function(e){this._subscriptions.forEach((t=>t.invalidate(e)))},l._processEdit=async function(e,t){t.forEach((e=>{this._pendingEdits.has(e)&&this._pendingEdits.delete(e)})),e.forEach((e=>this._pendingEdits.add(e)));const s=Array.from(this._subscriptions.values()).map((({tile:e})=>e)).map((t=>{const s=this.createTileQuery(t);return s.objectIds=e,{tile:t,query:s}})).map((async({tile:e,query:t})=>({tile:e,result:await this.query(t)}))),r=(await i.all(s)).map((async({tile:s,result:i})=>{if(!i.hasFeatures&&!t.length&&!e.length)return;return this._subscriptions.get(s.key.id)?this._onMessage({type:"update",id:s.key.id,addOrUpdate:i,remove:[...e,...t],end:!0,status:c.UpdateToken.empty()}):void 0}));await Promise.all(r),this._invalidate("all")},e}();e.DataTileSource=l,Object.defineProperty(e,"__esModule",{value:!0})}));
