/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/maybe","../../../../../core/Logger","../../../../../core/Error","../../../../../core/promiseUtils","./BaseFeatureSource"],(function(e,t,r,a,o,s,i){"use strict";const n=a.getLogger("esri.views.2d.layers.features.sources.FeatureSource");let d=function(e){function a(t){return e.call(this,t)||this}t._inheritsLoose(a,e);var i=a.prototype;return i._fetchDataTile=async function(e){const t=6,r=20,a=this._subscriptions.get(e.key.id);let i=!1,d=0,u=0;const c=(t,r)=>{u--,s.throwIfAborted(a);const o=e.id,n=t.reader,d=t.query;if(!n.exceededTransferLimit){if(i=!0,0!==r&&!n.hasFeatures){const e={id:o,addOrUpdate:n,end:0===u,type:"append"};return a.add({message:e,query:d}),void this._onMessage(e)}const e={id:o,addOrUpdate:n,end:0===u,type:"append"};return a.add({message:e,query:d}),void this._onMessage(e)}const c={id:o,addOrUpdate:n,end:i&&0===u,type:"append"};a.add({message:c,query:d}),this._onMessage(c)};let h=0,l=0;for(;!i&&l++<r;){let r;for(let t=0;t<h+1;t++){const t=d++;u++,r=this._fetchDataTilePage(e,t,a).then((e=>e&&c(e,t))).catch((t=>{i=!0,s.isAbortError(t)||(n.error(new o("mapview-query-error","Encountered error when fetching tile",{tile:e,error:t})),this._onMessage({id:e.id,addOrUpdate:null,end:i,type:"append"}))}))}await r,s.throwIfAborted(a),h=Math.min(h+2,t)}},i._fetchDataTilePage=async function(e,t,a){const o=this._queryInfo,i={start:this.pageSize*t,num:this.pageSize,returnExceededLimitFeatures:!0,quantizationParameters:e.getQuantizationParameters()};r.isSome(this.maxRecordCountFactor)&&(i.maxRecordCountFactor=this.maxRecordCountFactor);const n=this._createQuery(e,i);try{const r=a.signal,i=await this._queue.push({tile:e,query:n,signal:r,depth:t});return s.throwIfAborted(a),i?o!==this._queryInfo?this._fetchDataTilePage(e,t,a):{reader:i,query:n}:null}catch(d){return s.throwIfNotAbortError(d),null}},a}(i.BaseFeatureSource);e.PagedFeatureSource=d,Object.defineProperty(e,"__esModule",{value:!0})}));
