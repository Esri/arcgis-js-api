/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/Logger","../../../../../core/Error","../../../../../core/promiseUtils","./BaseFeatureSource"],(function(e,t,r,s,o,n){"use strict";const u=r.getLogger("esri.views.2d.layers.features.sources.FeatureSource");let i=function(e){function r(t){return e.call(this,t)||this}t._inheritsLoose(r,e);var n=r.prototype;return n._fetchDataTile=async function(e){const t=this._subscriptions.get(e.key.id);let r=!1,n=0,i=0;const a=(s,n)=>{i--,o.throwIfAborted(t);const u=s.reader,a=s.query;if(!u.exceededTransferLimit){if(r=!0,0!==n&&!u.hasFeatures){const r={tile:e,id:e.id,features:u,end:0===i};return t.requests.done.push({request:r,query:a}),void this._onRequest(r,"new")}const s={tile:e,id:e.id,features:u,end:0===i};return t.requests.done.push({request:s,query:a}),void this._onRequest(s,"new")}const c={tile:e,id:e.id,features:u,end:r&&0===i};t.requests.done.push({request:c,query:a}),this._onRequest(c,"new")};let c=0,d=0;for(;!r&&d++<20;){let d;for(let h=0;h<c+1;h++){const c=n++;i++,d=this._fetchDataTilePage(e,c,t).then((e=>e&&a(e,c))).catch((t=>{r=!0,o.isAbortError(t)||(u.error(new s("mapview-query-error","Encountered error when fetching tile",{tile:e,error:t})),this._onRequest({tile:e,id:e.id,features:null,end:r},"new"))}))}await d,o.throwIfAborted(t),c=Math.min(c+2,6)}},n._fetchDataTilePage=async function(e,t,r){const s=this._sourceQueryInfo,n=this._createQuery(e,{start:8e3*t,num:8e3,maxRecordCountFactor:3,returnExceededLimitFeatures:!0,quantizationParameters:e.getQuantizationParameters()});try{const u=r.signal,i=await this._queue.push({tile:e,query:n,signal:u,depth:t});return o.throwIfAborted(r),i?s!==this._sourceQueryInfo?this._fetchDataTilePage(e,t,r):{reader:i,query:n}:null}catch(e){return o.throwIfNotAbortError(e),null}},r}(n.BaseFeatureSource);e.PagedFeatureSource=i,Object.defineProperty(e,"__esModule",{value:!0})}));
