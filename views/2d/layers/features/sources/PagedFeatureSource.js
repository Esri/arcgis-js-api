/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/Error","../../../../../core/Logger","../../../../../core/maybe","../../../../../core/promiseUtils","./BaseFeatureSource"],(function(e,t,r,o,a,n,s){"use strict";const i=o.getLogger("esri.views.2d.layers.features.sources.FeatureSource");let u=function(e){function o(t){return e.call(this,t)||this}t._inheritsLoose(o,e);var s=o.prototype;return s._fetchDataTile=function(){var e=t._asyncToGenerator((function*(e){const t=6,o=20,a=this._subscriptions.get(e.key.id);let s=!1,u=0,d=0;const c=(t,r)=>{d--,n.throwIfAborted(a);const o=e.id,i=t.reader,u=t.query;if(!i.exceededTransferLimit){if(s=!0,0!==r&&!i.hasFeatures){const e={id:o,addOrUpdate:i,end:0===d,type:"append"};return a.add({message:e,query:u}),void this._onMessage(e)}const e={id:o,addOrUpdate:i,end:0===d,type:"append"};return a.add({message:e,query:u}),void this._onMessage(e)}const c={id:o,addOrUpdate:i,end:s&&0===d,type:"append"};a.add({message:c,query:u}),this._onMessage(c)};let h=0,l=0;for(;!s&&l++<o;){let o;for(let t=0;t<h+1;t++){const t=u++;d++,o=this._fetchDataTilePage(e,t,a).then((e=>e&&c(e,t))).catch((t=>{s=!0,n.isAbortError(t)||(i.error(new r("mapview-query-error","Encountered error when fetching tile",{tile:e,error:t})),this._onMessage({id:e.id,addOrUpdate:null,end:s,type:"append"}))}))}yield o,n.throwIfAborted(a),h=Math.min(h+2,t)}}));function o(t){return e.apply(this,arguments)}return o}(),s._fetchDataTilePage=function(){var e=t._asyncToGenerator((function*(e,t,r){n.throwIfAborted(r);const o=this._queryInfo,s={start:this.pageSize*t,num:this.pageSize,returnExceededLimitFeatures:!0,quantizationParameters:e.getQuantizationParameters()};a.isSome(this.maxRecordCountFactor)&&(s.maxRecordCountFactor=this.maxRecordCountFactor);const i=this.createTileQuery(e,s);try{const a=r.signal,s=yield this._queue.push({tile:e,query:i,signal:a,depth:t});return n.throwIfAborted(r),s?o!==this._queryInfo?this._fetchDataTilePage(e,t,r):{reader:s,query:i}:null}catch(u){return n.throwIfNotAbortError(u),null}}));function r(t,r,o){return e.apply(this,arguments)}return r}(),o}(s.BaseFeatureSource);e.PagedFeatureSource=u,Object.defineProperty(e,"__esModule",{value:!0})}));
