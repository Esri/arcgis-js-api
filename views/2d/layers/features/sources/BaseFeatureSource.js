/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../request","../../../../../core/Error","../../../../../core/has","../../../../../core/Logger","../../../../../core/maybe","../../../../../core/promiseUtils","../controllers/support/sourceAdapters","./DataTileSource","../../../../support/QueueProcessor"],(function(e,t,r,n,s,o,i,u,a,c,l){"use strict";const p=4;let y=function(e){function c(r){var n,o,c;return(n=e.call(this,r)||this).type="feature",n.mode="on-demand",n._adapter=a.createSourceAdapter(r.serviceInfo),n._queue=new l.QueueProcessor({concurrency:8,process:(o=t._asyncToGenerator((function*(e){if(u.throwIfAborted(e),i.isSome(e.tile)){const t=e.tile.key.id,{signal:r}=e,o=s("esri-tiles-debug")?{tile:t.replace(/\//g,"."),depth:e.depth}:void 0,i=yield n._adapter.executeQuery(e.query,{signal:r,query:{...o,...n._schema?.customParameters}});return i.level=e.tile.key.level,i}return n._adapter.executeQuery(e.query,{...e,query:n._schema?.customParameters})})),function(e){return o.apply(this,arguments)})}),n._patchQueue=new l.QueueProcessor({concurrency:8,process:(c=t._asyncToGenerator((function*(e){if(u.throwIfAborted(e),i.isSome(e.tile)){const t=e.tile.key.id,{signal:r}=e,o=s("esri-tiles-debug")?{tile:t.replace(/\//g,"."),depth:e.depth}:void 0,i=yield n._adapter.executeQuery(e.query,{signal:r,query:{...o,...n._schema?.customParameters}});return i.level=e.tile.key.level,i}return n._adapter.executeQuery(e.query,{...e,query:n._schema?.customParameters})})),function(e){return c.apply(this,arguments)})}),n}t._inheritsLoose(c,e);var y=c.prototype;return y.destroy=function(){e.prototype.destroy.call(this),this._adapter.destroy(),this._queue.destroy(),this._patchQueue.destroy()},y.enableEvent=function(e,t){},y.subscribe=function(t,r){e.prototype.subscribe.call(this,t,r);const s=this._subscriptions.get(t.id);this._fetchDataTile(t).catch((e=>{u.isAbortError(e)||o.getLogger("esri.views.2d.layers.features.sources.BaseFeatureSource").error(new n("mapview-query-error","Encountered error when fetching tile",{tile:t,error:e}))})).then((()=>s.end()))},y.unsubscribe=function(t){e.prototype.unsubscribe.call(this,t)},y.readers=function(e){return this._subscriptions.get(e).readers()},y.query=function(){var e=t._asyncToGenerator((function*(e,t={}){const r=t.query??{};return this._adapter.executeQuery(e,{...t,query:{...r,...this._schema?.customParameters}})}));function r(t){return e.apply(this,arguments)}return r}(),y.queryLastEditDate=function(){var e=t._asyncToGenerator((function*(){const e=this._serviceInfo.source,t={...e.query,f:"json"};return(yield r(e.path,{query:t,responseType:"json"})).data.editingInfo.lastEditDate}));function n(){return e.apply(this,arguments)}return n}(),y.createTileQuery=function(e,t={}){const r=this._serviceInfo.geometryType,n=this.createQuery(t);n.quantizationParameters=t.quantizationParameters??e.getQuantizationParameters(),n.resultType="tile",n.geometry=e.extent,this._serviceInfo.capabilities.query.supportsQuantization?"esriGeometryPolyline"===r&&(n.maxAllowableOffset=e.resolution*s("feature-polyline-generalization-factor")):"esriGeometryPolyline"!==r&&"esriGeometryPolygon"!==r||(n.maxAllowableOffset=e.resolution,"esriGeometryPolyline"===r&&(n.maxAllowableOffset*=s("feature-polyline-generalization-factor")));const o=this._serviceInfo.capabilities.query;return n.defaultSpatialReferenceEnabled=o.supportsDefaultSpatialReference,n.compactGeometryEnabled=o.supportsCompactGeometry,n},y._executePatchQuery=function(){var e=t._asyncToGenerator((function*(e,t,r,n){const s=t.clone();s.outFields=[this._serviceInfo.objectIdField,...r],s.returnCentroid=!1,s.returnGeometry=!1;const o=i.isSome(s.start)?s.start/8e3:0,u=n.signal;return this._patchQueue.push({tile:e,query:s,signal:u,depth:o})}));function r(t,r,n,s){return e.apply(this,arguments)}return r}(),y._resend=function(){var e=t._asyncToGenerator((function*(e,t){const{query:r,message:n}=e,s=i.isSome(r.outFields)?r.outFields:[],o=this._queryInfo.outFields,a=o.filter((e=>!s.includes(e)));if(i.isNone(n.addOrUpdate))this._onMessage({...n,type:"append"});else if(a.length)try{const e=this._subscriptions.get(n.id).tile,s=yield this._executePatchQuery(e,r,a,t);u.throwIfAborted(t),r.outFields=o,n.addOrUpdate.joinAttributes(s),this._onMessage({...n,end:n.end,type:"append"})}catch(c){}else this._onMessage({...n,type:"append"})}));function r(t,r){return e.apply(this,arguments)}return r}(),y._resendSubscription=function(){var e=t._asyncToGenerator((function*(e){if(s("esri-2d-update-debug")&&console.debug(e.tile.id,"Resend Subscription"),e.empty)return this._onMessage({id:e.tile.id,addOrUpdate:null,end:!1,type:"append"});const t=e.signal;for(const r of e.requests.done)yield this._resend(r,{signal:t});return i.isSome(e.edits)?this._onMessage(e.edits):void 0}));function r(t){return e.apply(this,arguments)}return r}(),y.resend=function(){var e=t._asyncToGenerator((function*(){const e=Array.from(this._subscriptions.values());yield Promise.all(e.map((e=>this._resendSubscription(e))))}));function r(){return e.apply(this,arguments)}return r}(),t._createClass(c,[{key:"updating",get:function(){return!!this._queue.length||Array.from(this._subscriptions.values()).some((e=>!e.done))}},{key:"maxRecordCountFactor",get:function(){const{query:e}=this._serviceInfo.capabilities;return e.supportsMaxRecordCountFactor?p:null}},{key:"maxPageSize",get:function(){const{query:e}=this._serviceInfo.capabilities;return(e.maxRecordCount??8e3)*i.unwrapOr(this.maxRecordCountFactor,1)}},{key:"pageSize",get:function(){return Math.min(8e3,this.maxPageSize)}}]),c}(c.DataTileSource);e.BaseFeatureSource=y,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
