// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../../request","../../../../../core/Error","../../../../../core/has","../../../../../core/Logger","../../../../../core/maybe","../../../../../core/promiseUtils","../../../../../tasks/support/Query","../controllers/support/sources","./DataTileSource","../../../../support/QueueProcessor"],(function(e,t,r,n,s,i,o,u,a,c,l,d,_){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseFeatureSource=void 0;var p=o.getLogger("esri.views.2d.layers.features.sources.BaseFeatureSource"),f=function(e){function t(t){var n=e.call(this,t)||this;return n.type="feature",n._adapter=l.createSourceAdapter(t.serviceInfo),n._queue=new _.QueueProcessor({concurrency:8,process:function(e){return r.__awaiter(n,void 0,void 0,(function(){var t,n,s,o,u;return r.__generator(this,(function(r){return a.throwIfAborted(e),t=e.tile.key.id,n=e.tile,s=e.signal,o=i("esri-tiles-debug")?{tile:t.replace(/\//g,"."),depth:e.depth}:void 0,u={query:o,signal:s,transform:n.transform},[2,this._adapter.executeQuery(e.query,u)]}))}))}}),n._patchQueue=new _.QueueProcessor({concurrency:8,process:function(e){return r.__awaiter(n,void 0,void 0,(function(){var t,n,s,o,u;return r.__generator(this,(function(r){return a.throwIfAborted(e),t=e.tile.key.id,n=e.tile,s=e.signal,o=i("esri-tiles-debug")?{tile:t.replace(/\//g,"."),depth:e.depth}:void 0,u={query:o,signal:s,transform:n.transform},[2,this._adapter.executeQuery(e.query,u)]}))}))}}),n}return r.__extends(t,e),t.prototype.destroy=function(){this._adapter.destroy(),this._queue.destroy(),this._patchQueue.destroy()},t.prototype.setViewState=function(e){},Object.defineProperty(t.prototype,"updating",{get:function(){return!!this._queue.length},enumerable:!1,configurable:!0}),t.prototype.subscribe=function(t){e.prototype.subscribe.call(this,t),this._fetchDataTile(t).catch((function(e){a.isAbortError(e)||p.error(new s("mapview-query-error","Encountered error when fetching tile",{tile:t,error:e}))}))},t.prototype.unsubscribe=function(t){e.prototype.unsubscribe.call(this,t)},t.prototype.pause=function(){this._queue.pause()},t.prototype.resume=function(){this._queue.resume()},t.prototype.query=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(r){return[2,this._adapter.executeQuery(e,t)]}))}))},t.prototype.queryLastEditDate=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t,s;return r.__generator(this,(function(i){switch(i.label){case 0:return e=this._serviceInfo.source,t=r.__assign(r.__assign({},e.query),{f:"json"}),[4,n(e.path,{query:t,responseType:"json"})];case 1:return s=i.sent(),[2,s.data.editingInfo.lastEditDate]}}))}))},t.prototype.forEachRequest=function(e,t){for(var r=this._subscriptions.get(e),n=r.requests,s=r.signal,i=0,o=n.done;i<o.length;i++){t(o[i].request,{signal:s})}},t.prototype._executePatchQuery=function(e,t,n,s){return r.__awaiter(this,void 0,void 0,(function(){var i,o,u;return r.__generator(this,(function(a){return(i=t.clone()).outFields=r.__spreadArrays([this._serviceInfo.objectIdField],n),i.returnCentroid=!1,i.returnGeometry=!1,o=i.start/8e3,u=s.signal,[2,this._patchQueue.push({tile:e,query:i,signal:u,depth:o})]}))}))},t.prototype._resendRequest=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var n,s,o,c,l,d,_;return r.__generator(this,(function(p){switch(p.label){case 0:if(n=e.query,s=e.request,o=n.outFields,c=this._sourceQueryInfo.outFields,l=c.filter((function(e){return-1===o.indexOf(e)})),u.isNone(s.features))return[2];if(!l.length)return this._onRequest(r.__assign(r.__assign({},s),{end:s.end||t.end}),"new",t),[2];p.label=1;case 1:return p.trys.push([1,3,,4]),[4,this._executePatchQuery(s.tile,n,l,t)];case 2:return d=p.sent(),a.throwIfAborted(t),n.outFields=c,s.features.joinAttributes(d),this._onRequest(r.__assign(r.__assign({},s),{end:s.end||t.end}),"new",t),[3,4];case 3:return _=p.sent(),i("esri-2d-debug")&&!a.isAbortError(_)&&console.debug("Encountered an error when querying:",_),[3,4];case 4:return[2]}}))}))},t.prototype.resend=function(e){var t=e.dataTileOnly;return r.__awaiter(this,void 0,void 0,(function(){var e,n,s,i=this;return r.__generator(this,(function(r){switch(r.label){case 0:for(e=0,n=!1,s=[],this._subscriptions.forEach((function(e){if(!e.requests.done.length){var t=e.tile;i._onRequest({tile:t,id:t.id,features:null,noData:!0,end:!1},"new",{dataTileOnly:!0})}}));!n;)n=!0,this._subscriptions.forEach((function(r){var o=r.requests,u=r.signal;if(o.done.length>e){n=!1;var a=o.done.length===e+1;s.push(i._resendRequest(o.done[e],{signal:u,dataTileOnly:t,end:a}))}})),e++;return[4,a.all(s)];case 1:return r.sent(),[2]}}))}))},t.prototype._createQuery=function(e,t){var n=new c(r.__assign(r.__assign(r.__assign({},this._serviceQueryInfo),this._sourceQueryInfo),t));return this._serviceInfo.capabilities.query.supportsQuantization||(t.quantizationParameters=null,n.maxAllowableOffset=e.resolution),t.quantizationParameters&&"esriGeometryPolyline"===this.geometryType&&(n.maxAllowableOffset=e.resolution),n.resultType="tile",n.geometry=e.extent,n},t}(d.DataTileSource);t.BaseFeatureSource=f}));