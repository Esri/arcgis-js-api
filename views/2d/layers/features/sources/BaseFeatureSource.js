/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/has","../../../../../core/maybe","../../../../../core/Logger","../../../../../core/Error","../../../../../core/promiseUtils","../../../../../request","../../../../../tasks/support/Query","../../../../support/QueueProcessor","../controllers/support/sourceAdapters","./DataTileSource"],(function(e,t,r,s,n,i,o,u,a,c,l,d){"use strict";const p=n.getLogger("esri.views.2d.layers.features.sources.BaseFeatureSource"),y=4;let h=function(e){function n(t){var n;return(n=e.call(this,t)||this).type="feature",n.mode="on-demand",n._adapter=l.createSourceAdapter(t.serviceInfo),n._queue=new c.QueueProcessor({concurrency:8,process:async e=>{if(o.throwIfAborted(e),s.isSome(e.tile)){const t=e.tile.key.id,{tile:s,signal:i}=e,o={query:r("esri-tiles-debug")?{tile:t.replace(/\//g,"."),depth:e.depth}:void 0,signal:i,transform:s.transform};return n._adapter.executeQuery(e.query,o)}return n._adapter.executeQuery(e.query,e)}}),n._patchQueue=new c.QueueProcessor({concurrency:8,process:async e=>{if(o.throwIfAborted(e),s.isSome(e.tile)){const t=e.tile.key.id,{tile:s,signal:i}=e,o={query:r("esri-tiles-debug")?{tile:t.replace(/\//g,"."),depth:e.depth}:void 0,signal:i,transform:s.transform};return n._adapter.executeQuery(e.query,o)}return n._adapter.executeQuery(e.query,e)}}),n}t._inheritsLoose(n,e);var d=n.prototype;return d.destroy=function(){e.prototype.destroy.call(this),this._adapter.destroy(),this._queue.destroy(),this._patchQueue.destroy()},d.enableEvent=function(e,t){},d.subscribe=function(t){e.prototype.subscribe.call(this,t),this._fetchDataTile(t).catch((e=>{o.isAbortError(e)||p.error(new i("mapview-query-error","Encountered error when fetching tile",{tile:t,error:e}))}))},d.unsubscribe=function(t){e.prototype.unsubscribe.call(this,t)},d.resume=function(){this._queue.resume()},d.forEachRequest=function(e,t){const r=this._subscriptions.get(e),{requests:s,signal:n}=r;for(const i of s.done)t(i.message,{signal:n})},d.query=async function(e,t){return this._adapter.executeQuery(e,t)},d.queryLastEditDate=async function(){const e=this._serviceInfo.source,t={...e.query,f:"json"};return(await u(e.path,{query:t,responseType:"json"})).data.editingInfo.lastEditDate},d.createTileQuery=function(e){const t=this.createQuery();return t.quantizationParameters=e.getQuantizationParameters(),t.resultType="tile",t.geometry=e.extent,"esriGeometryPolyline"===this._serviceInfo.geometryType&&(t.maxAllowableOffset=e.resolution),this._serviceInfo.capabilities.query.supportsQuantization||(t.quantizationParameters=null,t.maxAllowableOffset=e.resolution),t},d._createQuery=function(e,t){const r=new a({...this._queryInfo,...t});return this._serviceInfo.capabilities.query.supportsQuantization||(t.quantizationParameters=null,r.maxAllowableOffset=e.resolution),t.quantizationParameters&&"esriGeometryPolyline"===this._serviceInfo.geometryType&&(r.maxAllowableOffset=e.resolution),r.resultType="tile",r.geometry=e.extent,r},d._executePatchQuery=async function(e,t,r,n){const i=t.clone();i.outFields=[this._serviceInfo.objectIdField,...r],i.returnCentroid=!1,i.returnGeometry=!1;const o=s.isSome(i.start)?i.start/8e3:0,u=n.signal;return this._patchQueue.push({tile:e,query:i,signal:u,depth:o})},d._resend=async function(e,t){const{query:r,message:n}=e,i=s.isSome(r.outFields)?r.outFields:[],u=this._queryInfo.outFields,a=u.filter((e=>-1===i.indexOf(e)));if(!s.isNone(n.addOrUpdate))if(a.length)try{const e=this._subscriptions.get(n.id).tile,s=await this._executePatchQuery(e,r,a,t);o.throwIfAborted(t),r.outFields=u,n.addOrUpdate.joinAttributes(s),this._onMessage({...n,end:n.end,type:"append"})}catch(c){}else this._onMessage({...n,end:n.end,type:"append"})},d.resend=async function(){let e=0,t=!1;const r=[];for(this._subscriptions.forEach((e=>{e.requests.done.length||this._onMessage({id:e.tile.id,addOrUpdate:null,end:!1,type:"append"})}));!t;)t=!0,this._subscriptions.forEach((({requests:s,signal:n})=>{s.done.length>e&&(t=!1,r.push(this._resend(s.done[e],{signal:n})))})),e++;await Promise.all(r)},t._createClass(n,[{key:"updating",get:function(){return!!this._queue.length}},{key:"maxRecordCountFactor",get:function(){const{query:e}=this._serviceInfo.capabilities;return e.supportsMaxRecordCountFactor?y:null}},{key:"maxPageSize",get:function(){var e;const{query:t}=this._serviceInfo.capabilities;return(null!=(e=t.maxRecordCount)?e:8e3)*s.unwrapOr(this.maxRecordCountFactor,1)}},{key:"pageSize",get:function(){return Math.min(8e3,this.maxPageSize)}}]),n}(d.DataTileSource);e.BaseFeatureSource=h,Object.defineProperty(e,"__esModule",{value:!0})}));
