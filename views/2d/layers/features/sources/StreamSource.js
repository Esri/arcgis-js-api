/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../core/has","../../../../../core/maybe","../../../../../core/accessorSupport/decorators/property","../../../../../core/accessorSupport/ensureType","../../../../../core/arrayUtils","../../../../../core/accessorSupport/decorators/subclass","../../../../../chunks/rbush","../../../../../layers/graphics/featureConversionUtils","../../../../../layers/graphics/OptimizedGeometry","../../../../../layers/graphics/data/StreamFeatureManager","../../../../../layers/graphics/sources/connections/createConnection","./DataTileSource","../support/FeatureSetReaderJSON","../support/UpdateToken"],(function(e,t,n,r,s,o,i,a,c,u,d,l,p,h,_,m,f){"use strict";const y=2500;function g(e,t){const n=e.weakClone();if(s.isSome(e.geometry)){const r=d.quantizeX(t,e.geometry.coords[0]),s=d.quantizeY(t,e.geometry.coords[1]);n.geometry=new l([],[r,s])}return n}function v(e){return"esriGeometryPoint"===e?g:(t,n)=>{const r=t.weakClone(),s=new l,o=!1,i=!1,a=d.quantizeOptimizedGeometry(s,t.geometry,o,i,e,n,!1,!1);return r.geometry=a,r}}function b(e){return"esriGeometryPoint"===e?e=>s.isSome(e.geometry)?{minX:e.geometry.coords[0],minY:e.geometry.coords[1],maxX:e.geometry.coords[0],maxY:e.geometry.coords[1]}:{minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}:e=>{let t=1/0,n=1/0,r=-1/0,o=-1/0;return s.isSome(e.geometry)&&e.geometry.forEachVertex(((e,s)=>{t=Math.min(t,e),n=Math.min(n,s),r=Math.max(r,e),o=Math.max(o,s)})),{minX:t,minY:n,maxX:r,maxY:o}}}function I(e,t){const n=u.rbush(9,b(t));return n.load(e),n}function S(e,t){return e.search({minX:t.bounds[0],minY:t.bounds[1],maxX:t.bounds[2],maxY:t.bounds[3]})}let T=function(){function e(e,t){this.onUpdate=e,this._geometryType=t,this._objectIdToFeature=new Map,this._index=null}var n=e.prototype;return n.add=function(e){this._objectIdToFeature.set(e.objectId,e),this._index=null},n.get=function(e){return this._objectIdToFeature.has(e)?this._objectIdToFeature.get(e):null},n.forEach=function(e){this._objectIdToFeature.forEach(e)},n.search=function(e){return this._index||(this._index=I(this._features,this._geometryType)),S(this._index,e)},n.clear=function(){this._index=null,this._objectIdToFeature.clear()},n.removeById=function(e){const t=this._objectIdToFeature.get(e);return t?(this._objectIdToFeature.delete(e),this._index=null,t):null},n.update=function(e,t){this.onUpdate(e,t)},t._createClass(e,[{key:"_features",get:function(){const e=[];return this._objectIdToFeature.forEach((t=>e.push(t))),e}},{key:"size",get:function(){return this._objectIdToFeature.size}}]),e}();e.StreamSource=function(e){function n(n){var r;(r=e.call(this,n)||this).type="stream",r._updateIntervalId=0,r._level=0,r._updateInfo={websocket:0,client:0},r._isPaused=!1,r._inUpdate=!1;const{outSR:s}=n,{geometryType:o,objectIdField:i,timeInfo:a,purgeOptions:c,source:u,spatialReference:d,serviceFilter:l,maxReconnectionAttempts:_,maxReconnectionInterval:m,updateInterval:f,customParameters:g,enabledEventTypes:b}=n.serviceInfo,I=new T(r._onUpdate.bind(t._assertThisInitialized(r)),o),S=new p.StreamFeatureManager(I,i,a,c),F=h.createConnection(u,d,s,o,l,_,m,g??{});return r._store=I,r._manager=S,r._connection=F,r._quantize=v(o),r._enabledEventTypes=new Set(b),r._handles=[r._connection.on("data-received",(e=>r._onFeature(e))),r._connection.on("message-received",(e=>r._onWebSocketMessage(e)))],r._initUpdateInterval=()=>{let e=performance.now();r._updateIntervalId=setInterval((()=>{const t=performance.now(),s=t-e;if(s>y){e=t;const n=Math.round(r._updateInfo.client/(s/1e3)),o=Math.round(r._updateInfo.websocket/(s/1e3));r._updateInfo.client=0,r._updateInfo.websocket=0,r.events.emit("updateRate",{client:n,websocket:o})}n.canAcceptRequest()&&!r._inUpdate&&r._manager.checkForUpdates()}),f)},r._initUpdateInterval(),r}t._inheritsLoose(n,e);var r=n.prototype;return r.destroy=function(){e.prototype.destroy.call(this),this._clearUpdateInterval(),this._handles.forEach((e=>e.remove())),this._connection.destroy()},r._fetchDataTile=function(){},r.updateCustomParameters=function(e){this._connection.updateCustomParameters(e)},r.pauseStream=function(){this._isPaused||(this._isPaused=!0,this._clearUpdateInterval())},r.resumeStream=function(){this._isPaused&&(this._isPaused=!1,this._initUpdateInterval())},r.sendMessageToSocket=function(e){this._connection.sendMessageToSocket(e)},r.sendMessageToClient=function(e){this._connection.sendMessageToClient(e)},r.enableEvent=function(e,t){t?this._enabledEventTypes.add(e):this._enabledEventTypes.delete(e)},r.subscribe=function(t,n){e.prototype.subscribe.call(this,t,n);const r=this._subscriptions.get(t.id);this._level=t.level;const s=this._getTileFeatures(t);this._onMessage({type:"append",id:t.key.id,addOrUpdate:s,end:!0}),r.didSend=!0},r.unsubscribe=function(t){e.prototype.unsubscribe.call(this,t)},r.readers=function*(e){const t=this._subscriptions.get(e),{tile:n}=t;yield this._getTileFeatures(n)},r.createTileQuery=function(e){throw new Error("Service does not support tile  queries")},r.resend=function(){var e=t._asyncToGenerator((function*(){this._subscriptions.forEach((e=>{const{tile:t}=e,n={type:"append",id:t.id,addOrUpdate:this._getTileFeatures(t),end:!0};this._onMessage(n)}))}));function n(){return e.apply(this,arguments)}return n}(),r._getTileFeatures=function(e){const t=this._store.search(e).map((t=>this._quantize(t,e.transform)));return m.FeatureSetReaderJSON.fromOptimizedFeatures(t,this._serviceInfo,e.transform)},r._onWebSocketMessage=function(e){if(this._enabledEventTypes.has("message-received")&&this.events.emit("message-received",e),"type"in e)switch(e.type){case"delete":if(e.objectIds)for(const t of e.objectIds)this._manager.removeById(t);if(e.trackIds)for(const t of e.trackIds)this._manager.removeByTrackId(t);break;case"clear":this._store.forEach((e=>this._manager.removeById(e.objectId)))}},r._onFeature=function(e){this._updateInfo.websocket++;try{this._enabledEventTypes.has("data-received")&&this.events.emit("data-received",e);const t=d.convertFromFeature(e,this._serviceInfo.geometryType,!1,!1,this._serviceInfo.objectIdField);this._manager.add(t)}catch(t){}},r._clearUpdateInterval=function(){clearInterval(this._updateIntervalId),this._updateIntervalId=0},r._onUpdate=function(){var e=t._asyncToGenerator((function*(e,t){this._inUpdate=!0;try{s.isSome(e)&&(this._updateInfo.client+=e.length),this._subscriptions.forEach(((e,t)=>{e.didSend&&e.tile.level===this._level&&this._onMessage({type:"append",id:t,addOrUpdate:null,clear:!0,end:!1})}));const t=[];this._subscriptions.forEach(((e,n)=>{if(!e.didSend||e.tile.level!==this._level)return;const r=e.tile,s={type:"append",id:n,addOrUpdate:this._getTileFeatures(r),remove:[],end:!1,status:f.UpdateToken.empty()};e.requests.stream.enqueue(s),t.push(this._onMessage(s))})),yield Promise.all(t),this._subscriptions.forEach(((e,t)=>{e.didSend&&e.tile.level===this._level&&this._onMessage({type:"append",id:t,addOrUpdate:null,end:!0})}))}catch{}this._inUpdate=!1}));function n(t,n){return e.apply(this,arguments)}return n}(),t._createClass(n,[{key:"connectionStatus",get:function(){return this._isPaused?"paused":this._connection?.connectionStatus}},{key:"errorString",get:function(){return this._connection?.errorString}},{key:"updating",get:function(){return!1}}]),n}(_.DataTileSource),n.__decorate([o.property()],e.StreamSource.prototype,"_isPaused",void 0),n.__decorate([o.property()],e.StreamSource.prototype,"connectionStatus",null),n.__decorate([o.property()],e.StreamSource.prototype,"errorString",null),e.StreamSource=n.__decorate([c.subclass("esri.views.2d.layers.features.sources")],e.StreamSource),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
