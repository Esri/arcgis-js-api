/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Logger","../../../core/promiseUtils","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../../support/GraphicsCollection","../engine/BitmapContainer","./LayerView2D","./graphics/GraphicsView2D","./graphics/HighlightGraphicContainer","./support/ExportStrategy","../../layers/LayerView","../../layers/MapImageLayerView","../../layers/RefreshableLayerView","../../support/drapedUtils"],(function(e,t,i,r,a,s,o,n,h,p,c,u,d,l,g,y,m,f,w){"use strict";const v=i.getLogger("esri.views.2d.layers.MapImageLayerView2D");let _=function(t){function i(){var e;return(e=t.apply(this,arguments)||this)._highlightGraphics=new p.GraphicsCollection,e}e._inheritsLoose(i,t);var a=i.prototype;return a.update=function(e){this.strategy.update(e).catch((e=>{r.isAbortError(e)||v.error(e)}))},a.attach=function(){const{imageMaxWidth:e,imageMaxHeight:t,version:i}=this.layer,r=i>=10.3,a=i>=10;this._bitmapContainer=new c.BitmapContainer,this.container.addChild(this._bitmapContainer);const s=new d({view:this.view,graphics:this._highlightGraphics,requestUpdateCallback:()=>this.requestUpdate(),container:new l(this.view.featuresTilingScheme)});this.container.addChild(s.container),this.strategy=new g({container:this._bitmapContainer,fetchSource:this.fetchImage.bind(this),requestUpdate:this.requestUpdate.bind(this),imageMaxWidth:e,imageMaxHeight:t,imageRotationSupported:r,imageNormalizationSupported:a,hidpi:!0}),this.handles.add(this.watch("exportImageVersion",(()=>this.requestUpdate())),"exportImageVersion"),this.handles.add(this.watch("view.floors",(()=>this.requestUpdate())),"view.floors"),this.requestUpdate()},a.detach=function(){this.handles.remove("exportImageVersion"),this.handles.remove("view.floors"),this.strategy.destroy(),this.container.removeAllChildren(),this._bitmapContainer.removeAllChildren()},a.moveStart=function(){},a.viewChange=function(){},a.moveEnd=function(){this.requestUpdate()},a.highlight=function(e,t){return this._highlightGraphics.add(e),{remove:()=>{this._highlightGraphics.remove(e)}}},a.supportsSpatialReference=function(e){return this.layer.serviceSupportsSpatialReference(e)},a.createFetchPopupFeaturesQueryGeometry=function(e,t){return w.createQueryGeometry(e,t,this.view)},a.doRefresh=function(){var t=e._asyncToGenerator((function*(){this.requestUpdate()}));function i(){return t.apply(this,arguments)}return i}(),a.isUpdating=function(){return this.strategy.updating||this.updateRequested},a.fetchImage=function(e,t,i,r){return this.layer.fetchImage(e,t,i,{timeExtent:this.timeExtent,floors:this.view.floors,...r})},i}(m.MapImageLayerView(f.RefreshableLayerView(u.LayerView2DMixin(y))));t.__decorate([a.property()],_.prototype,"strategy",void 0),t.__decorate([a.property()],_.prototype,"updating",void 0),_=t.__decorate([h.subclass("esri.views.2d.layers.MapImageLayerView2D")],_);return _}));
