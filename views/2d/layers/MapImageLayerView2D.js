/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../Graphic","../../../core/Collection","../../../core/Logger","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../engine/BitmapContainer","./LayerView2D","./graphics/GraphicsView2D","./graphics/HighlightGraphicContainer","./support/ExportStrategy","../../layers/LayerView","../../layers/MapImageLayerView","../../layers/RefreshableLayerView","../../support/drapedUtils"],(function(e,t,i,r,a,s,o,n,h,p,c,l,u,g,d,y,m,f,w,v){"use strict";let _=function(t){function n(){return t.apply(this,arguments)||this}e._inheritsLoose(n,t);var h=n.prototype;return h.update=function(e){this.strategy.update(e).catch((e=>{s.isAbortError(e)||a.getLogger(this.declaredClass).error(e)})),e.stationary&&this.updateHighlightedFeatures(e.state.resolution),this._highlightView.processUpdate(e)},h.attach=function(){const{imageMaxWidth:e,imageMaxHeight:t,version:i}=this.layer,r=i>=10.3,a=i>=10;this._bitmapContainer=new l.BitmapContainer,this.container.addChild(this._bitmapContainer),this._highlightView=new g({view:this.view,graphics:this.highlightGraphics,requestUpdateCallback:()=>this.requestUpdate(),container:new d(this.view.featuresTilingScheme)}),this.container.addChild(this._highlightView.container),this.strategy=new y({container:this._bitmapContainer,fetchSource:this.fetchImageBitmap.bind(this),requestUpdate:this.requestUpdate.bind(this),imageMaxWidth:e,imageMaxHeight:t,imageRotationSupported:r,imageNormalizationSupported:a,hidpi:!0}),this.handles.add(o.watch((()=>this.exportImageVersion),(()=>this.requestUpdate())),"exportImageVersion"),this.handles.add(o.watch((()=>this.view?.floors),(()=>this.requestUpdate())),"view.floors"),this.requestUpdate()},h.detach=function(){this.handles.remove("exportImageVersion"),this.handles.remove("view.floors"),this.strategy.destroy(),this.container.removeAllChildren(),this._bitmapContainer.removeAllChildren(),this._highlightView.destroy()},h.moveStart=function(){},h.viewChange=function(){},h.moveEnd=function(){this.requestUpdate()},h.highlight=function(e){let t=null;if(e instanceof i?t=[e]:r.isCollection(e)&&e.length>0?t=e.toArray():Array.isArray(e)&&e.length>0&&(t=e),t=t?.filter(Boolean),!t||!t.length)return{remove:()=>{}};for(const i of t)"geometryType"in i.sourceLayer&&"point"===i.sourceLayer.geometryType&&(i.visible=!1);return this.highlightGraphics.addMany(t),{remove:()=>{this.highlightGraphics.removeMany(t)}}},h.supportsSpatialReference=function(e){return this.layer.serviceSupportsSpatialReference(e)},h.createFetchPopupFeaturesQueryGeometry=function(e,t){return v.createQueryGeometry(e,t,this.view)},h.doRefresh=function(){var t=e._asyncToGenerator((function*(){this.requestUpdate()}));function i(){return t.apply(this,arguments)}return i}(),h.isUpdating=function(){return this.strategy.updating||this.updateRequested},h.highlightGraphicUpdated=function(e,t){this._highlightView.graphicUpdateHandler({graphic:e,property:t})},h.fetchImage=function(e,t,i,r){return this.layer.fetchImage(e,t,i,{timeExtent:this.timeExtent,floors:this.view.floors,...r})},h.fetchImageBitmap=function(e,t,i,r){return this.layer.fetchImageBitmap(e,t,i,{timeExtent:this.timeExtent,floors:this.view.floors,...r})},n}(f(w(u.LayerView2DMixin(m))));t.__decorate([n.property()],_.prototype,"strategy",void 0),t.__decorate([n.property()],_.prototype,"updating",void 0),_=t.__decorate([c.subclass("esri.views.2d.layers.MapImageLayerView2D")],_);return _}));
