/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Logger","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/accessorSupport/decorators/subclass","../../../support/GraphicsCollection","../engine/BitmapContainer","./LayerView2D","./graphics/GraphicsView2D","./graphics/HighlightGraphicContainer","./support/ExportStrategy","../../layers/LayerView","../../layers/MapImageLayerView","../../layers/RefreshableLayerView","../../layers/support/MapServiceLayerViewHelper","../../support/drapedUtils"],(function(e,t,i,r,a,s,h,o,p,n,c,u,l,g,d,y,m,f,_,w){"use strict";let H=function(t){function s(){var e;return(e=t.apply(this,arguments)||this)._highlightGraphics=new n.GraphicsCollection,e._updateHash="",e}e._inheritsLoose(s,t);var h=s.prototype;return h.fetchPopupFeatures=function(e,t){return this._popupHighlightHelper.fetchPopupFeatures(e,t)},h.update=function(e){const t=`${this.exportImageVersion}/${e.state.id}/${e.pixelRatio}/${e.stationary}`;this._updateHash!==t&&(this._updateHash=t,this.strategy.update(e).catch((e=>{r.isAbortError(e)||i.getLogger(this.declaredClass).error(e)})),e.stationary&&this._popupHighlightHelper.updateHighlightedFeatures(e.state.resolution)),this._highlightView.processUpdate(e)},h.attach=function(){const{imageMaxWidth:e,imageMaxHeight:t,version:i}=this.layer,r=i>=10.3,s=i>=10;this._bitmapContainer=new c.BitmapContainer,this.container.addChild(this._bitmapContainer),this._highlightView=new l({view:this.view,graphics:this._highlightGraphics,requestUpdateCallback:()=>this.requestUpdate(),container:new g(this.view.featuresTilingScheme),defaultPointSymbolEnabled:!1}),this.container.addChild(this._highlightView.container),this._popupHighlightHelper=new _.MapServiceLayerViewHelper({createFetchPopupFeaturesQueryGeometry:(e,t)=>w.createQueryGeometry(e,t,this.view),highlightGraphics:this._highlightGraphics,highlightGraphicUpdated:(e,t)=>{this._highlightView.graphicUpdateHandler({graphic:e,property:t})},layerView:this,updatingHandles:this.updatingHandles}),this.strategy=new d({container:this._bitmapContainer,fetchSource:this.fetchImageBitmap.bind(this),requestUpdate:this.requestUpdate.bind(this),imageMaxWidth:e,imageMaxHeight:t,imageRotationSupported:r,imageNormalizationSupported:s,hidpi:!0}),this.addAttachHandles(a.watch((()=>this.exportImageVersion),(()=>this.requestUpdate()))),this.requestUpdate()},h.detach=function(){this.strategy.destroy(),this.container.removeAllChildren(),this._bitmapContainer.removeAllChildren(),this._highlightView.destroy(),this._popupHighlightHelper.destroy()},h.moveStart=function(){},h.viewChange=function(){},h.moveEnd=function(){this.requestUpdate()},h.supportsSpatialReference=function(e){return this.layer.serviceSupportsSpatialReference(e)},h.doRefresh=function(){var t=e._asyncToGenerator((function*(){this._updateHash="",this.requestUpdate()}));function i(){return t.apply(this,arguments)}return i}(),h.isUpdating=function(){return this.strategy.updating||this.updateRequested},h.fetchImage=function(e,t,i,r){return this.layer.fetchImage(e,t,i,{timeExtent:this.timeExtent,floors:this.floors,...r})},h.fetchImageBitmap=function(e,t,i,r){return this.layer.fetchImageBitmap(e,t,i,{timeExtent:this.timeExtent,floors:this.floors,...r})},h.highlight=function(e){return this._popupHighlightHelper.highlight(e)},s}(m(f(u.LayerView2DMixin(y))));t.__decorate([s.property()],H.prototype,"strategy",void 0),t.__decorate([s.property()],H.prototype,"updating",void 0),H=t.__decorate([p.subclass("esri.views.2d.layers.MapImageLayerView2D")],H);return H}));
