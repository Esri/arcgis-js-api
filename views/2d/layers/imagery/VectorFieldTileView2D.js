/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/accessorSupport/decorators/subclass","../../../../layers/support/rasterFunctions/vectorFieldUtils","../../engine/imagery/RasterVFTileContainer","./BaseImageryTileSubView2D"],(function(e,t,i,r,o,s,l,a,n,c,p){"use strict";let y=function(t){function o(){var e;return(e=t.apply(this,arguments)||this)._handle=null,e.type="rasterVF",e}e._inheritsLoose(o,t);var s=o.prototype;return s.canUseWebGLForProcessing=function(){return!1},s.fetchTile=function(){var t=e._asyncToGenerator((function*(e,t){t={...t,interpolation:"nearest",requestProjectedLocalDirections:!0};const i=yield this.layer.fetchTile(e.level,e.row,e.col,t);return"vector-magdir"===this.layer.rasterInfo.dataType&&i?.pixelBlock&&(i.pixelBlock=yield this.layer.convertVectorFieldData(i.pixelBlock,t)),i}));function i(e,i){return t.apply(this,arguments)}return i}(),s.updateTileSource=function(e,t){const r=t.symbolizerParams,{tileData:o}=e;o.key=e.key,o.width=this._tileInfoView.tileInfo.size[0],o.height=this._tileInfoView.tileInfo.size[1];const{symbolTileSize:s}=r,{source:l}=t;if(o.offset=this._getTileSymbolOffset(o.key,s),i.isSome(l)&&i.isSome(l.pixelBlock)){const e={extent:l.extent,pixelBlock:l.pixelBlock};o.rawPixelData=e,o.symbolizerParameters=r,o.source=this._sampleVectorFieldData(l.pixelBlock,r,o.offset)}else{const e=[Math.round((this._tileInfoView.tileInfo[0]-o.offset[0])/s),Math.round((this._tileInfoView.tileInfo[1]-o.offset[1])/s)],t=this.createEmptyTilePixelBlock(e);o.source=t,o.symbolizerParameters=r}return o.invalidateVAO(),Promise.resolve()},s.updateTileSymbolizerParameters=function(e,t){const r=t.local,{symbolTileSize:o}=r,{tileData:s}=e;s.offset=this._getTileSymbolOffset(s.key,o);const l=s.symbolizerParameters.symbolTileSize;s.symbolizerParameters=r;const a=s.rawPixelData?.pixelBlock;return i.isSome(a)&&l!==o&&(s.source=this._sampleVectorFieldData(a,s.symbolizerParameters,s.offset)),Promise.resolve()},s.attach=function(){t.prototype.attach.call(this),this.container=new c.RasterVFTileContainer(this._tileInfoView),this.container.isCustomTilingScheme=this._isCustomTilingScheme,this._updateSymbolType(this.layer.renderer),this._handle=r.watch((()=>this.layer.renderer),(e=>this._updateSymbolType(e)))},s.detach=function(){t.prototype.detach.call(this),this.container.removeAllChildren(),this._handle?.remove(),this._handle=null,this.container=null},s._getTileSymbolOffset=function(e,t){const i=e.col*this._tileInfoView.tileInfo.size[0]%t,r=e.row*this._tileInfoView.tileInfo.size[1]%t;return[i>t/2?t-i:-i,r>t/2?t-r:-r]},s._sampleVectorFieldData=function(e,t,i){const{symbolTileSize:r}=t;return n.sampleVectorField(e,"vector-uv",r,i)},s._updateSymbolType=function(e){"vector-field"===e.type&&(this.container.symbolTypes="wind-barb"===e.style?["scalar","triangle"]:"simple-scalar"===e.style?["scalar"]:["triangle"])},o}(p.BaseImageryTileSubView2D);t.__decorate([o.property()],y.prototype,"container",void 0),t.__decorate([o.property()],y.prototype,"layer",void 0),t.__decorate([o.property()],y.prototype,"type",void 0),y=t.__decorate([a.subclass("esri.views.2d.layers.imagery.VectorFieldTileView2D")],y);return y}));
