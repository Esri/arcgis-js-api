/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/maybe","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/accessorSupport/ensureType","../../../../core/Logger","../../../../core/accessorSupport/decorators/subclass","../../../../layers/support/rasterFunctions/vectorFieldUtils","../../engine/RasterVFTileContainer","./BaseImageryTileSubView2D"],(function(e,t,r,i,o,l,s,a,n,c,p){"use strict";let u=function(t){function i(){var e;return(e=t.apply(this,arguments)||this)._handle=null,e.container=null,e.layer=null,e.tileSize=null,e.type="rasterVF",e.useWebGLForProcessing=!0,e}e._inheritsLoose(i,t);var o=i.prototype;return o.canUseWebGLForProcessing=function(){return!1},o.fetchTile=function(){var t=e._asyncToGenerator((function*(e,t){const r=yield this.layer.fetchTile(e.level,e.row,e.col,t);return"vector-magdir"===this.layer.rasterInfo.dataType&&null!=r&&r.pixelBlock&&(r.pixelBlock=yield this.layer.convertVectorFieldData(r.pixelBlock,t)),r}));function r(e,r){return t.apply(this,arguments)}return r}(),o.updateTileSource=function(e,t){const i=t.symbolizerParams,{tileData:o}=e;o.key=e.key,o.width=this.tileSize[0],o.height=this.tileSize[1];const{symbolTileSize:l}=i,{source:s}=t;if(o.offset=this._getTileSymbolOffset(o.key,l),r.isSome(s)&&r.isSome(s.pixelBlock)){const e={extent:s.extent,pixelBlock:s.pixelBlock};o.rawPixelData=e,o.source=this._sampleVectorFieldData(s.pixelBlock,i,o.offset),o.symbolizerParameters=i}else{const e=[Math.round((this.tileSize[0]-o.offset[0])/l),Math.round((this.tileSize[1]-o.offset[1])/l)],t=this.createEmptyTilePixelBlock(e);o.source=t,o.symbolizerParameters=i}return o.invalidateVAO(),Promise.resolve(null)},o.updateTileSymbolizerParameters=function(e,t){var i;const o=t.local,{symbolTileSize:l}=o,{tileData:s}=e;s.offset=this._getTileSymbolOffset(s.key,l);const a=s.symbolizerParameters.symbolTileSize;return s.symbolizerParameters=o,r.isSome(null==(i=s.rawPixelData)?void 0:i.pixelBlock)&&a!==l&&(s.source=this._sampleVectorFieldData(s.rawPixelData.pixelBlock,s.symbolizerParameters,s.offset)),Promise.resolve(null)},o.install=function(e,t){this.container=new c.RasterVFTileContainer(t.tileInfoView),this.container.isCustomTilingScheme=t.isCustomTilingScheme,this._updateSymbolType(this.layer.renderer),this._handle=this.layer.watch("renderer",(e=>this._updateSymbolType(e))),e.addChild(this.container)},o.uninstall=function(){this.container.removeAllChildren(),this._handle.remove(),this._handle=null,this.container.remove()},o._getTileSymbolOffset=function(e,t){const r=e.col*this.tileSize[0]%t,i=e.row*this.tileSize[1]%t;return[r>t/2?t-r:-r,i>t/2?t-i:-i]},o._sampleVectorFieldData=function(e,t,r){const{symbolTileSize:i}=t;return n.sampleVectorField(e,"vector-uv",i,r)},o._updateSymbolType=function(e){"vector-field"===e.type&&(this.container.symbolTypes="wind-barb"===e.style?["scalar","triangle"]:"simple-scalar"===e.style?["scalar"]:["triangle"])},i}(p.BaseImageryTileSubView2D);return t.__decorate([i.property()],u.prototype,"container",void 0),t.__decorate([i.property()],u.prototype,"layer",void 0),t.__decorate([i.property()],u.prototype,"tileSize",void 0),t.__decorate([i.property()],u.prototype,"type",void 0),t.__decorate([i.property()],u.prototype,"useWebGLForProcessing",void 0),u=t.__decorate([a.subclass("esri.views.2d.layers.imagery.VectorFieldTileView2D")],u),u}));
