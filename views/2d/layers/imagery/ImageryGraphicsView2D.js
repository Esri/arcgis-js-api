/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/has","../../../../core/Logger","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/decorators/enumeration","../../../../core/accessorSupport/decorators/subclass","../../../../core/urlUtils","../../../../core/uuid","../../../../portal/support/resourceExtension","../../../../core/promiseUtils","../../../../core/Accessor","../../../../geometry/Extent","../../../../core/screenUtils","../../../../request","../../../../Graphic","../../../../layers/support/rasterFunctions/vectorFieldUtils","../../../../support/GraphicsCollection","../../../../layers/support/rasterFunctions/rasterProjectionHelper","../../engine/Container","../graphics/GraphicsView2D","../graphics/GraphicContainer"],(function(e,t,r,i,a,o,n,s,c,p,l,u,h,d,y,g,_,m,f,x,w,v,E){"use strict";const q=i.getLogger("esri.views.2d.layers.imagery.ImageryGraphicsView2D");let C=function(t){function r(){var e;return(e=t.apply(this,arguments)||this).attached=!1,e.container=new w.Container,e.updateRequested=!1,e._graphicsView=null,e._projectFullExtentPromise=null,e.type="Graphics",e._graphics=new f.default,e._updateGraphics=u.debounce((async(t,r)=>{if(!t.stationary)return;const i=t.state,a=new d({xmin:i.extent.xmin,ymin:i.extent.ymin,xmax:i.extent.xmax,ymax:i.extent.ymax,spatialReference:i.spatialReference}),o=t.state.size[0],n=t.state.size[1],s={};s.timeExtent=e.timeExtent,s.requestAsImageElement=!1,s.signal=r,null==e._projectFullExtentPromise&&(e._projectFullExtentPromise=e._getProjectedFullExtent(a.spatialReference));const c="vector-field"===e.layer.renderer.type?e.layer.renderer.symbolTileSize:50,p=await e._projectFullExtentPromise,l=m.snapImageToSymbolTile(a,o,n,c,p),h=await e.layer.fetchImage(l.extent,l.width,l.height,s),y=e.layer.renderer;if("vector-field"===y.type){e._pixelData={extent:l.extent,pixelBlock:h.pixelData.pixelBlock};const r=await y.getGraphicsFromPixelData(h.pixelData,"vector-uv"===e.layer.rasterInfo.dataType);e._graphicsView.update(t),await u.after(0).then((()=>{e._graphics.set("items",r)}))}})),e}e._inheritsLoose(r,t);var i=r.prototype;return i.destroy=function(){this.attached&&(this.detach(),this.attached=!1),this.updateRequested=!1},i.update=function(e){this._updateGraphics(e).catch((e=>{u.isAbortError(e)||q.error(e)}))},i.hitTest=function(e,t){const r=this.view.toMap(y.createScreenPoint(e,t));return Promise.resolve(new _({attributes:{},geometry:r,layer:this.layer}))},i.attach=function(){this._graphicsView=new v({view:this.view,graphics:this._graphics,requestUpdateCallback:()=>this.requestUpdate(),container:new E(this.view.featuresTilingScheme)}),this.attached=!0},i.detach=function(){this._graphics.destroy(),this._graphicsView.destroy(),this.container.removeChild(this._graphicsView.container),this._graphicsView=null},i.moveStart=function(){},i.viewChange=function(){},i.moveEnd=function(){},i.install=function(e){this.container.addChild(this._graphicsView.container),e.addChild(this.container)},i.uninstall=function(e){this.container.removeChild(this._graphicsView.container),e.removeChild(this.container)},i.isUpdating=function(){return this._graphicsView.updating||this.updateRequested},i.getPixelData=function(){return this.updating?null:this._pixelData},i.redraw=function(){},i.requestUpdate=function(){this.updateRequested||(this.updateRequested=!0,this.view.requestUpdate())},i._getProjectedFullExtent=async function(e){try{return await x.projectExtent(this.layer.fullExtent,e)}catch(t){try{const t=(await g(this.layer.url,{query:{option:"footprints",outSR:e.wkid||JSON.stringify(e.toJSON()),f:"json"}})).data.featureCollection.layers[0].layerDefinition.extent;return t?d.fromJSON(t):null}catch{return null}}},e._createClass(r,[{key:"updating",get:function(){return!this.attached||this.isUpdating()}}]),r}(h);return t.__decorate([o.property()],C.prototype,"attached",void 0),t.__decorate([o.property()],C.prototype,"container",void 0),t.__decorate([o.property()],C.prototype,"layer",void 0),t.__decorate([o.property()],C.prototype,"timeExtent",void 0),t.__decorate([o.property()],C.prototype,"view",void 0),t.__decorate([o.property()],C.prototype,"updateRequested",void 0),t.__decorate([o.property()],C.prototype,"updating",null),t.__decorate([n.enumeration({graphics:"Graphics"})],C.prototype,"type",void 0),C=t.__decorate([s.subclass("esri.views.2d.layers.imagery.ImageryGraphicsView2D")],C),C}));
