/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/has","../../../../core/Logger","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/decorators/enumeration","../../../../core/accessorSupport/decorators/subclass","../../../../core/urlUtils","../../../../core/uuid","../../../../portal/support/resourceExtension","../../../../core/promiseUtils","../../../../geometry/Extent","../../../../core/screenUtils","../../../../Graphic","../../../../support/GraphicsCollection","../../../layers/LayerView","../../engine/Container","../graphics/GraphicsView2D","../LayerView2D"],(function(e,t,i,r,a,n,o,s,c,p,h,l,u,d,y,g,x,m,_,w){"use strict";const f=r.getLogger("esri.views.2d.layers.imagery.ImageryGraphicsView2D");let v=function(t){function i(){var e;return(e=t.apply(this,arguments)||this).container=new m.Container,e._graphicsView=null,e.type="Graphics",e._graphics=new g.default,e._updateGraphics=l.debounce((async(t,i)=>{if(!t.stationary)return;const r=t.state,a=new u({xmin:r.extent.xmin,ymin:r.extent.ymin,xmax:r.extent.xmax,ymax:r.extent.ymax,spatialReference:r.spatialReference}),n=t.state.size[0],o=t.state.size[1],s={};s.timeExtent=e.timeExtent,s.requestAsImageElement=!1,s.signal=i;const c=e._getVectorFieldExportParams({extent:a,width:n,height:o}),p=await e.layer.fetchImage(c.extent,c.width,c.height,s),h=e.layer.renderer;if("vector-field"===h.type){e._pixelData={extent:c.extent,pixelBlock:p.pixelData.pixelBlock};const i=await h.getGraphicsFromPixelData(p.pixelData,"vector-uv"===e.layer.rasterInfo.dataType);e._graphicsView.update(t),await l.after(0).then((()=>{e._graphics.set("items",i)}))}})),e}e._inheritsLoose(i,t);var r=i.prototype;return r.update=function(e){this._updateGraphics(e).catch((e=>{l.isAbortError(e)||f.error(e)}))},r.hitTest=function(e,t){if(this.suspended)return l.resolve(null);const i=this.view.toMap(d.createScreenPoint(e,t));return l.resolve(new y({attributes:{},geometry:i,layer:this.layer}))},r.attach=function(){this._graphicsView=new _({view:this.view,graphics:this._graphics,requestUpdateCallback:()=>this.requestUpdate()})},r.detach=function(){this._graphics.destroy(),this._graphicsView.destroy(),this.container.removeChild(this._graphicsView.container),this._graphicsView=null},r.moveStart=function(){},r.viewChange=function(){},r.moveEnd=function(){},r.install=function(e){this.container.addChild(this._graphicsView.container),e.addChild(this.container)},r.uninstall=function(e){this.container.removeChild(this._graphicsView.container),e.removeChild(this.container)},r.isUpdating=function(){return this._graphicsView.updating||this.updateRequested},r.getPixelData=function(){return this.updating?null:this._pixelData},r.redraw=function(){},r._getVectorFieldExportParams=function(e){var t,i;let{extent:r,width:a,height:n}=e;const o=this.layer,s=null==(t=o.fullExtent)?void 0:t.xmin,c=null==(i=o.fullExtent)?void 0:i.ymax;let p;"vector-field"===o.renderer.type&&(p=o.renderer.symbolTileSize),p=Math.max(p||0,30),a=Math.ceil(a*(1/p)),n=Math.ceil(n*(1/p));const h=(r.xmax-r.xmin)/a,l=(r.ymax-r.ymin)/n;return r.xmin=s+Math.floor((r.xmin-s)/h)*h,r.xmax=s+Math.ceil((r.xmax-s)/h)*h,r.ymin=c+Math.floor((r.ymin-c)/l)*l,r.ymax=c+Math.ceil((r.ymax-c)/l)*l,{extent:r,width:a,height:n}},e._createClass(i,[{key:"updating",get:function(){var e;return null==(e=this._graphicsView)?void 0:e.updating}}]),i}(w.LayerView2DMixin(x));return t.__decorate([n.property()],v.prototype,"container",void 0),t.__decorate([n.property()],v.prototype,"layer",void 0),t.__decorate([n.property()],v.prototype,"timeExtent",void 0),t.__decorate([n.property({dependsOn:["_graphicsView.updating"]})],v.prototype,"updating",null),t.__decorate([n.property()],v.prototype,"_graphicsView",void 0),t.__decorate([o.enumeration({graphics:"Graphics"})],v.prototype,"type",void 0),v=t.__decorate([s.subclass("esri.views.2d.layers.imagery.ImageryGraphicsView2D")],v),v}));
