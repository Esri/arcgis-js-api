/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../Graphic","../../../../request","../../../../core/Accessor","../../../../core/Logger","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/screenUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/enumeration","../../../../core/accessorSupport/decorators/subclass","../../../../geometry/Extent","../../../../layers/support/rasterFunctions/rasterProjectionHelper","../../../../layers/support/rasterFunctions/vectorFieldUtils","../../../../support/GraphicsCollection","../../engine/Container","../graphics/GraphicContainer","../graphics/GraphicsView2D"],(function(e,t,r,i,a,s,n,o,c,p,l,u,h,d,y,m,_,g,x,f,v){"use strict";const w=s.getLogger("esri.views.2d.layers.imagery.ImageryGraphicsView2D");let V=function(t){function a(){var r;return(r=t.apply(this,arguments)||this).attached=!1,r.container=new x.Container,r.updateRequested=!1,r._graphicsView=null,r._projectFullExtentPromise=null,r._dataParameters={exportParametersVersion:0,extents:[],tileResolution:0,time:""},r.type="Graphics",r._graphics=new g.default,r._updateGraphics=o.debounce(function(){var t=e._asyncToGenerator((function*(e,t){if(!e.stationary)return;const i=e.state,a=new y({xmin:i.extent.xmin,ymin:i.extent.ymin,xmax:i.extent.xmax,ymax:i.extent.ymax,spatialReference:i.spatialReference}),[s,o]=e.state.size,c={};c.timeExtent=r.timeExtent,c.requestAsImageElement=!1,c.signal=t,null==r._projectFullExtentPromise&&(r._projectFullExtentPromise=r._getProjectedFullExtent(a.spatialReference));const p="vector-field"===r.layer.renderer.type?r.layer.renderer.symbolTileSize:50,l=yield r._projectFullExtentPromise,{extent:u,resolution:h,width:d,height:m}=_.snapImageToSymbolTile(a,s,o,p,l),g=yield r.layer.fetchImage(u,d,m,c),x=r.layer.renderer;if("vector-field"===x.type){const t=g.pixelData.pixelBlock,i=x.sizeVariables[0];!n.isSome(t)||i.minDataValue&&i.maxDataValue||(i.minDataValue=t.statistics[0].minValue,i.maxDataValue=t.statistics[0].maxValue),r._pixelData={extent:u,pixelBlock:t};const a=u.clone().normalize(),s={exportParametersVersion:r.layer.exportImageServiceParameters.version,extents:a,tileResolution:h,time:JSON.stringify(r.timeExtent||"")},o=r._canReuseVectorFieldData(s)?r._dataParameters.extents:[],c=yield x.getGraphicsFromPixelData(g.pixelData,"vector-uv"===r.layer.rasterInfo.dataType,o);if(o.length){const e=r._graphics.items.filter((e=>n.isSome(e.geometry)&&o.some((t=>t.intersects(e.geometry)))&&!a.some((t=>t.intersects(e.geometry)))));r._graphics.removeMany(e),r._graphics.addMany(c)}else r._graphics.set("items",c);r._graphicsView.update(e),r._dataParameters=s}}));return function(e,r){return t.apply(this,arguments)}}()),r}e._inheritsLoose(a,t);var s=a.prototype;return s.destroy=function(){this.attached&&(this.detach(),this.attached=!1),this.updateRequested=!1},s.update=function(e){this._updateGraphics(e).catch((e=>{o.isAbortError(e)||w.error(e)}))},s.hitTest=function(e,t){const i=this.view.toMap(c.createScreenPoint(e,t));return Promise.resolve(new r({attributes:{},geometry:i,layer:this.layer}))},s.attach=function(){this._graphicsView=new v({view:this.view,graphics:this._graphics,requestUpdateCallback:()=>this.requestUpdate(),container:new f(this.view.featuresTilingScheme)}),this.attached=!0},s.detach=function(){this._graphics.destroy(),this._graphicsView.destroy(),this.container.removeChild(this._graphicsView.container),this._graphicsView=null},s.install=function(e){this.container.addChild(this._graphicsView.container),e.addChild(this.container)},s.uninstall=function(e){this.container.removeChild(this._graphicsView.container),e.removeChild(this.container)},s.isUpdating=function(){return this._graphicsView.updating||this.updateRequested},s.getPixelData=function(){return this.updating?null:this._pixelData},s.redraw=function(){},s.requestUpdate=function(){this.updateRequested||(this.updateRequested=!0,this.view.requestUpdate())},s._getProjectedFullExtent=function(){var t=e._asyncToGenerator((function*(e){try{return yield m.projectExtent(this.layer.fullExtent,e)}catch(t){try{const t=(yield i(this.layer.url,{query:{option:"footprints",outSR:e.wkid||JSON.stringify(e.toJSON()),f:"json"}})).data.featureCollection.layers[0].layerDefinition.extent;return t?y.fromJSON(t):null}catch{return null}}}));function r(e){return t.apply(this,arguments)}return r}(),s._canReuseVectorFieldData=function(e){const t=this._dataParameters.exportParametersVersion===e.exportParametersVersion,r=this._dataParameters.time===e.time,i=Math.abs(this._dataParameters.tileResolution-e.tileResolution)/e.tileResolution<.01,a=this._dataParameters.extents.some((t=>e.extents.some((e=>t.intersects(e)))));return t&&r&&i&&a},e._createClass(a,[{key:"updating",get:function(){return!this.attached||this.isUpdating()}}]),a}(a);return t.__decorate([p.property()],V.prototype,"attached",void 0),t.__decorate([p.property()],V.prototype,"container",void 0),t.__decorate([p.property()],V.prototype,"layer",void 0),t.__decorate([p.property()],V.prototype,"timeExtent",void 0),t.__decorate([p.property()],V.prototype,"view",void 0),t.__decorate([p.property()],V.prototype,"updateRequested",void 0),t.__decorate([p.property()],V.prototype,"updating",null),t.__decorate([h.enumeration({graphics:"Graphics"})],V.prototype,"type",void 0),V=t.__decorate([d.subclass("esri.views.2d.layers.imagery.ImageryGraphicsView2D")],V),V}));
