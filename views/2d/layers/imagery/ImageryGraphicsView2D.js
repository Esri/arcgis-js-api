/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../Graphic","../../../../request","../../../../core/Accessor","../../../../core/Logger","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/screenUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/enumeration","../../../../core/accessorSupport/decorators/subclass","../../../../geometry/Extent","../../../../layers/support/rasterFunctions/rasterProjectionHelper","../../../../layers/support/rasterFunctions/vectorFieldUtils","../../../../support/GraphicsCollection","../../engine/Container","../graphics/GraphicContainer","../graphics/GraphicsView2D"],(function(e,t,r,i,a,n,o,s,c,p,l,u,h,d,y,m,g,_,f,x,v){"use strict";const w=n.getLogger("esri.views.2d.layers.imagery.ImageryGraphicsView2D");let S=function(t){function a(){var r;return(r=t.apply(this,arguments)||this).attached=!1,r.container=new f.Container,r.updateRequested=!1,r._graphicsView=null,r._projectFullExtentPromise=null,r._previousExtents=[],r._previousSymbolTileResolution=0,r._previousRendererSignature="",r.type="Graphics",r._graphics=new _.default,r._updateGraphics=s.debounce(function(){var t=e._asyncToGenerator((function*(e,t){if(!e.stationary)return;const i=e.state,a=new y({xmin:i.extent.xmin,ymin:i.extent.ymin,xmax:i.extent.xmax,ymax:i.extent.ymax,spatialReference:i.spatialReference}),[n,s]=e.state.size,c={};c.timeExtent=r.timeExtent,c.requestAsImageElement=!1,c.signal=t,null==r._projectFullExtentPromise&&(r._projectFullExtentPromise=r._getProjectedFullExtent(a.spatialReference));const p="vector-field"===r.layer.renderer.type?r.layer.renderer.symbolTileSize:50,l=yield r._projectFullExtentPromise,{extent:u,resolution:h,width:d,height:m}=g.snapImageToSymbolTile(a,n,s,p,l),_=yield r.layer.fetchImage(u,d,m,c),f=r.layer.renderer;if("vector-field"===f.type){const t=_.pixelData.pixelBlock,i=f.sizeVariables[0];i.minDataValue&&i.maxDataValue||(i.minDataValue=t.statistics[0].minValue,i.maxDataValue=t.statistics[0].maxValue),r._pixelData={extent:u,pixelBlock:_.pixelData.pixelBlock};const a=JSON.stringify(r.layer.renderer),n=r._previousRendererSignature===a,s=Math.abs(r._previousSymbolTileResolution-h)/h<.01,c=u.clone().normalize(),p=r._previousExtents.some((e=>c.some((t=>e.intersects(t))))),l=n&&s&&p?r._previousExtents:[],d=yield f.getGraphicsFromPixelData(_.pixelData,"vector-uv"===r.layer.rasterInfo.dataType,l);if(l.length){const e=r._graphics.items.filter((e=>o.isSome(e.geometry)&&l.some((t=>t.intersects(e.geometry)))&&!c.some((t=>t.intersects(e.geometry)))));r._graphics.removeMany(e),r._graphics.addMany(d)}else r._graphics.set("items",d);r._graphicsView.update(e),r._previousExtents=c,r._previousRendererSignature=a,r._previousSymbolTileResolution=h}}));return function(e,r){return t.apply(this,arguments)}}()),r}e._inheritsLoose(a,t);var n=a.prototype;return n.destroy=function(){this.attached&&(this.detach(),this.attached=!1),this.updateRequested=!1},n.update=function(e){this._updateGraphics(e).catch((e=>{s.isAbortError(e)||w.error(e)}))},n.hitTest=function(e,t){const i=this.view.toMap(c.createScreenPoint(e,t));return Promise.resolve(new r({attributes:{},geometry:i,layer:this.layer}))},n.attach=function(){this._graphicsView=new v({view:this.view,graphics:this._graphics,requestUpdateCallback:()=>this.requestUpdate(),container:new x(this.view.featuresTilingScheme)}),this.attached=!0},n.detach=function(){this._graphics.destroy(),this._graphicsView.destroy(),this.container.removeChild(this._graphicsView.container),this._graphicsView=null},n.moveStart=function(){},n.viewChange=function(){},n.moveEnd=function(){},n.install=function(e){this.container.addChild(this._graphicsView.container),e.addChild(this.container)},n.uninstall=function(e){this.container.removeChild(this._graphicsView.container),e.removeChild(this.container)},n.isUpdating=function(){return this._graphicsView.updating||this.updateRequested},n.getPixelData=function(){return this.updating?null:this._pixelData},n.redraw=function(){},n.requestUpdate=function(){this.updateRequested||(this.updateRequested=!0,this.view.requestUpdate())},n._getProjectedFullExtent=function(){var t=e._asyncToGenerator((function*(e){try{return yield m.projectExtent(this.layer.fullExtent,e)}catch(t){try{const t=(yield i(this.layer.url,{query:{option:"footprints",outSR:e.wkid||JSON.stringify(e.toJSON()),f:"json"}})).data.featureCollection.layers[0].layerDefinition.extent;return t?y.fromJSON(t):null}catch{return null}}}));function r(e){return t.apply(this,arguments)}return r}(),e._createClass(a,[{key:"updating",get:function(){return!this.attached||this.isUpdating()}}]),a}(a);return t.__decorate([p.property()],S.prototype,"attached",void 0),t.__decorate([p.property()],S.prototype,"container",void 0),t.__decorate([p.property()],S.prototype,"layer",void 0),t.__decorate([p.property()],S.prototype,"timeExtent",void 0),t.__decorate([p.property()],S.prototype,"view",void 0),t.__decorate([p.property()],S.prototype,"updateRequested",void 0),t.__decorate([p.property()],S.prototype,"updating",null),t.__decorate([h.enumeration({graphics:"Graphics"})],S.prototype,"type",void 0),S=t.__decorate([d.subclass("esri.views.2d.layers.imagery.ImageryGraphicsView2D")],S),S}));
