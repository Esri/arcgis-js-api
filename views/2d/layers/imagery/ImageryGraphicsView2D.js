/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../Graphic","../../../../request","../../../../core/Accessor","../../../../core/Logger","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/accessorSupport/decorators/property","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/enumeration","../../../../core/accessorSupport/decorators/subclass","../../../../geometry/Extent","../../../../layers/support/rasterFunctions/rasterProjectionHelper","../../../../layers/support/rasterFunctions/vectorFieldUtils","../../../../support/GraphicsCollection","../../engine/Container","../graphics/GraphicContainer","../graphics/GraphicsView2D"],(function(e,t,r,a,i,s,n,o,c,l,p,u,h,d,y,m,g,_,x,f,w){"use strict";const v=s.getLogger("esri.views.2d.layers.imagery.ImageryGraphicsView2D");let V=function(t){function i(){var r;return(r=t.apply(this,arguments)||this).attached=!1,r.container=new x.Container,r.updateRequested=!1,r._graphicsView=null,r._projectFullExtentPromise=null,r._dataParameters={exportParametersVersion:0,extents:[],tileResolution:0,time:"",isOceanStyle:!1,isOceanographic:!1},r.type="Graphics",r._graphics=new _.GraphicsCollection,r._updateGraphics=o.debounce(function(){var t=e._asyncToGenerator((function*(e,t){if(!e.stationary)return;const a=e.state,i=new y({xmin:a.extent.xmin,ymin:a.extent.ymin,xmax:a.extent.xmax,ymax:a.extent.ymax,spatialReference:a.spatialReference}),[s,o]=e.state.size,c={};c.timeExtent=r.timeExtent,c.requestAsImageElement=!1,c.signal=t,null==r._projectFullExtentPromise&&(r._projectFullExtentPromise=r._getProjectedFullExtent(i.spatialReference));const l="vector-field"===r.layer.renderer.type?r.layer.renderer.symbolTileSize:50,p=yield r._projectFullExtentPromise,{extent:u,resolution:h,width:d,height:m}=g.snapImageToSymbolTile(i,s,o,l,p),_=yield r.layer.fetchImage(u,d,m,c),x=r.layer.renderer;if("vector-field"===x.type){const t=_.pixelData.pixelBlock,a=x.sizeVariables[0];!n.isSome(t)||a.minDataValue&&a.maxDataValue||(a.minDataValue=t.statistics[0].minValue,a.maxDataValue=t.statistics[0].maxValue),r._pixelData={extent:u,pixelBlock:t};const i=u.clone().normalize(),s={exportParametersVersion:r.layer.exportImageServiceParameters.version,extents:i,tileResolution:h,time:JSON.stringify(r.timeExtent||""),isOceanStyle:"flow-to"===x.flowRepresentation,isOceanographic:"ocean-current-kn"===x.style||"ocean-current-m"===x.style},o=r._canReuseVectorFieldData(s)?r._dataParameters.extents:[],c=yield x.getGraphicsFromPixelData(_.pixelData,"vector-uv"===r.layer.rasterInfo.dataType,o);if(o.length){const e=r._graphics.items.filter((e=>n.isSome(e.geometry)&&o.some((t=>t.intersects(e.geometry)))&&!i.some((t=>t.intersects(e.geometry)))));r._graphics.removeMany(e),r._graphics.addMany(c)}else r._graphics.set("items",c);r._graphicsView.update(e),r._dataParameters=s}}));return function(e,r){return t.apply(this,arguments)}}()),r}e._inheritsLoose(i,t);var s=i.prototype;return s.destroy=function(){this.attached&&(this.detach(),this.attached=!1),this.updateRequested=!1},s.update=function(e){this._updateGraphics(e).catch((e=>{o.isAbortError(e)||v.error(e)}))},s.hitTest=function(e){return new r({attributes:{},geometry:e.clone(),layer:this.layer})},s.attach=function(){this._graphicsView=new w({view:this.view,graphics:this._graphics,requestUpdateCallback:()=>this.requestUpdate(),container:new f(this.view.featuresTilingScheme)}),this.attached=!0},s.detach=function(){this._graphics.destroy(),this._graphicsView.destroy(),this.container.removeChild(this._graphicsView.container),this._graphicsView=null},s.install=function(e){this.container.addChild(this._graphicsView.container),e.addChild(this.container)},s.uninstall=function(e){this.container.removeChild(this._graphicsView.container),e.removeChild(this.container)},s.isUpdating=function(){return this._graphicsView.updating||this.updateRequested},s.getPixelData=function(){return this.updating?null:this._pixelData},s.redraw=function(){},s.requestUpdate=function(){this.updateRequested||(this.updateRequested=!0,this.view.requestUpdate())},s._getProjectedFullExtent=function(){var t=e._asyncToGenerator((function*(e){try{return yield m.projectExtent(this.layer.fullExtent,e)}catch(t){try{const t=(yield a(this.layer.url,{query:{option:"footprints",outSR:e.wkid||JSON.stringify(e.toJSON()),f:"json"}})).data.featureCollection.layers[0].layerDefinition.extent;return t?y.fromJSON(t):null}catch{return null}}}));function r(e){return t.apply(this,arguments)}return r}(),s._canReuseVectorFieldData=function(e){const t=this._dataParameters.exportParametersVersion===e.exportParametersVersion,r=this._dataParameters.time===e.time,a=Math.abs(this._dataParameters.tileResolution-e.tileResolution)/e.tileResolution<.01,i=this._dataParameters.extents.some((t=>e.extents.some((e=>t.intersects(e))))),s=this._dataParameters.isOceanStyle===e.isOceanStyle,n=this._dataParameters.isOceanographic===e.isOceanographic;return t&&r&&a&&i&&s&&n},e._createClass(i,[{key:"updating",get:function(){return!this.attached||this.isUpdating()}}]),i}(i);t.__decorate([c.property()],V.prototype,"attached",void 0),t.__decorate([c.property()],V.prototype,"container",void 0),t.__decorate([c.property()],V.prototype,"layer",void 0),t.__decorate([c.property()],V.prototype,"timeExtent",void 0),t.__decorate([c.property()],V.prototype,"view",void 0),t.__decorate([c.property()],V.prototype,"updateRequested",void 0),t.__decorate([c.property()],V.prototype,"updating",null),t.__decorate([h.enumeration({graphics:"Graphics"})],V.prototype,"type",void 0),V=t.__decorate([d.subclass("esri.views.2d.layers.imagery.ImageryGraphicsView2D")],V);return V}));
