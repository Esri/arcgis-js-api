/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/maybe","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/accessorSupport/ensureType","../../../../core/Logger","../../../../core/accessorSupport/decorators/subclass","../../engine/RasterTileContainer","./BaseImageryTileSubView2D"],(function(e,r,t,o,i,n,s,a,l,c){"use strict";let u=function(r){function o(){var e;return(e=r.apply(this,arguments)||this).container=null,e.layer=null,e.tileSize=null,e.type="raster",e.useWebGLForProcessing=!0,e}e._inheritsLoose(o,r);var i=o.prototype;return i.canUseWebGLForProcessing=function(){return this.useWebGLForProcessing&&this.layer.symbolizer.canRenderInWebGL&&!("majority"===this.layer.interpolation&&this._canUseMajorityInterpolationOnDataSource())},i.fetchTile=function(e,r){return this.layer.fetchTile(e.level,e.row,e.col,r)},i.updateTileSource=function(){var r=e._asyncToGenerator((function*(e,r){const{bandIds:o}=this.layer,i=this._getLayerInterpolation(),n=this.canUseWebGLForProcessing(),{source:s,symbolizerParams:a,globalSymbolizerParams:l,suspended:c,coords:u,resolution:p}=r,{bitmap:d}=e;if([d.x,d.y]=u,d.resolution=p,s&&t.isSome(s)&&t.isSome(s.pixelBlock)){const e={extent:s.extent,pixelBlock:s.pixelBlock};if(d.rawPixelData=e,n)d.source=s.pixelBlock,d.isRendereredSource=!1;else{const r=yield this.layer.applyRenderer(e,"stretch"===(null==l?void 0:l.type)?l:null);d.source=r,d.isRendereredSource=!0}d.symbolizerParameters=n?a:null,n?d.transformGrid||(d.transformGrid=s.transformGrid):d.transformGrid=null}else{const e=this.createEmptyTilePixelBlock();d.source=e,d.symbolizerParameters=n?a:null,d.transformGrid=null}d.bandIds=n?o:null,d.width=this.tileSize[0],d.height=this.tileSize[1],d.interpolation=i,d.suspended=c,d.invalidateTexture()}));function o(e,t){return r.apply(this,arguments)}return o}(),i.updateTileSymbolizerParameters=function(){var r=e._asyncToGenerator((function*(e,r){const{local:o,global:i}=r,{bandIds:n}=this.layer,s=this._getLayerInterpolation(),a=this.canUseWebGLForProcessing(),{bitmap:l}=e,{rawPixelData:c}=l;!a&&t.isSome(c)?(l.source=yield this.layer.applyRenderer(c,"stretch"===(null==i?void 0:i.type)?i:null),l.isRendereredSource=!0):(l.isRendereredSource&&t.isSome(c)&&(l.source=c.pixelBlock),l.isRendereredSource=!1),l.symbolizerParameters=a?i||o:null,l.bandIds=a?n:null,l.interpolation=s,l.suspended=!1}));function o(e,t){return r.apply(this,arguments)}return o}(),i.install=function(e,r){this.container=new l.RasterTileContainer(r.tileInfoView),this.container.isCustomTilingScheme=r.isCustomTilingScheme,e.addChild(this.container)},i.uninstall=function(){this.container.removeAllChildren(),this.container.remove()},i._canUseMajorityInterpolationOnDataSource=function(){const{bandCount:e,attributeTable:r,colormap:t,pixelType:o}=this.layer.rasterInfo;return 1===e&&(null!=r||null!=t||"u8"===o||"s8"===o)},i._getLayerInterpolation=function(){const e=this.layer.renderer.type;if("raster-colormap"===e||"unique-value"===e||"class-breaks"===e)return"nearest";const{interpolation:r}=this.layer,{renderer:t}=this.layer;return"raster-stretch"===t.type&&null!=t.colorRamp?"bilinear"===r||"cubic"===r?"bilinear":"nearest":r},o}(c.BaseImageryTileSubView2D);return r.__decorate([o.property()],u.prototype,"container",void 0),r.__decorate([o.property()],u.prototype,"layer",void 0),r.__decorate([o.property()],u.prototype,"tileSize",void 0),r.__decorate([o.property()],u.prototype,"type",void 0),r.__decorate([o.property()],u.prototype,"useWebGLForProcessing",void 0),u=r.__decorate([a.subclass("esri.views.2d.layers.imagery.ImageryTileView2D")],u),u}));
