/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/maybe","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/accessorSupport/decorators/subclass","../../engine/imagery/RasterTileContainer","./BaseImageryTileSubView2D","../support/util"],(function(e,r,t,i,n,s,o,a,l,c){"use strict";let u=function(r){function i(){var e;return(e=r.apply(this,arguments)||this).type="raster",e}e._inheritsLoose(i,r);var n=i.prototype;return n.attach=function(){r.prototype.attach.call(this),this.container=new a.RasterTileContainer(this._tileInfoView),this.container.isCustomTilingScheme=this._isCustomTilingScheme,this.updateRasterFunctionParameters()},n.detach=function(){r.prototype.detach.call(this),this.container.removeAllChildren(),this.container=null},n.canUseWebGLForProcessing=function(){return this.useWebGLForProcessing&&this.layer.symbolizer.canRenderInWebGL&&!("majority"===this.layer.interpolation&&c.canUseMajorityInterpolationOnDataSource(this.layer))},n.fetchTile=function(e,r){return this.layer.fetchTile(e.level,e.row,e.col,r)},n.updateRasterFunctionParameters=function(){const{raster:e,type:r}=this.layer,{container:t}=this;if("Function"!==e.datasetFormat||"wcs"===r)return t.rasterFunctionChain=null,t.children.forEach((e=>{const{bitmap:r}=e;r&&(r.suspended=!0,r.processed=!1,r.projected&&(r.invalidateTexture(),r.rasterTexture=null))})),void(this._rasterFunctionState="na");const i=this._rasterFunctionState,{rasterFunction:n,primaryRasters:s}=e,o=n.supportsGPU&&(!s||s.rasters.length<=1),a=o?n.getFlatWebGLFunctionChain():null,{renderer:l}=this.layer,c=!o||!a?.functions.length||"raster-stretch"===l.type&&l.dynamicRangeAdjustment||!this.canUseWebGLForProcessing();t.rasterFunctionChain=c?null:a;const u=null==n?"na":t.rasterFunctionChain?"gpu":"cpu";t.children.forEach((e=>{const{bitmap:r}=e;r&&(r.suspended=i!==u,r.processed=!1,r.processedTexture=null)})),this._rasterFunctionState=u},n.updateTileSource=function(){var r=e._asyncToGenerator((function*(e,r){const i=this._getBandIds(),n=this._getLayerInterpolation(),s=this.canUseWebGLForProcessing(),{source:o,globalSymbolizerParams:a,suspended:l,coords:c,resolution:u}=r,p=this.layerView.hasTilingEffects?a:r.symbolizerParams,{bitmap:d}=e;if([d.x,d.y]=c,d.resolution=u,o&&t.isSome(o)&&t.isSome(o.pixelBlock)){const e={extent:o.extent,pixelBlock:o.pixelBlock};if(d.rawPixelData=e,s)d.source=o.pixelBlock,d.isRendereredSource=!1;else{const r=yield this.layer.applyRenderer(e,"stretch"===a?.type?a:void 0);d.source=r,d.isRendereredSource=!0}d.symbolizerParameters=s?p:null,s?d.transformGrid||(d.transformGrid=o.transformGrid):d.transformGrid=null}else{const e=this.createEmptyTilePixelBlock();d.source=e,d.symbolizerParameters=s?p:null,d.transformGrid=null}d.bandIds=s?i:null,d.width=this._tileInfoView.tileInfo.size[0],d.height=this._tileInfoView.tileInfo.size[1],d.interpolation=n,d.suspended=l,d.invalidateTexture()}));function i(e,t){return r.apply(this,arguments)}return i}(),n.updateTileSymbolizerParameters=function(){var r=e._asyncToGenerator((function*(e,r){const{local:i,global:n}=r,s=this._getBandIds(),o=this._getLayerInterpolation(),a=this.canUseWebGLForProcessing(),{bitmap:l}=e,{rawPixelData:c}=l;!a&&t.isSome(c)?(l.source=yield this.layer.applyRenderer(c,"stretch"===n?.type?n:void 0),l.isRendereredSource=!0):(l.isRendereredSource&&t.isSome(c)&&(l.source=c.pixelBlock),l.isRendereredSource=!1),l.symbolizerParameters=a?this.layerView.hasTilingEffects?n:i:null,l.bandIds=a?s:null,l.interpolation=o,l.suspended=!1}));function i(e,t){return r.apply(this,arguments)}return i}(),n._getLayerInterpolation=function(){const e=this.layer.renderer.type;if("raster-colormap"===e||"unique-value"===e||"class-breaks"===e)return"nearest";const{interpolation:r}=this.layer,{renderer:t}=this.layer;return"raster-stretch"===t.type&&null!=t.colorRamp?"bilinear"===r||"cubic"===r?"bilinear":"nearest":r},i}(l.BaseImageryTileSubView2D);r.__decorate([i.property()],u.prototype,"container",void 0),r.__decorate([i.property()],u.prototype,"layer",void 0),r.__decorate([i.property()],u.prototype,"type",void 0),u=r.__decorate([o.subclass("esri.views.2d.layers.imagery.ImageryTileView2D")],u);return u}));
