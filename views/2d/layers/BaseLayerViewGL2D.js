// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../core/accessorSupport/decorators","../../../core/libs/earcut/earcut","../../../geometry/support/aaBoundingRect","../../../geometry/support/coordsUtils","../../../layers/graphics/data/projectionSupport","../tiling","../engine/webgl/TurboLine","./LayerView2D","./graphics/graphicsUtils","./support/DisplayGL","./support/util","../../layers/LayerView","../../layers/RefreshableLayerView"],(function(e,t,r,i,n,o,s,a,c,u,l,p,f,h,d,y){"use strict";var v=new Set,g=[],x=[],_=function(e,t,r,i,n,s,a,c,u){void 0===c&&(c=[0,0]),void 0===u&&(u=o.create()),this.id=e,this.level=t,this.row=r,this.col=i,this.world=n,this.resolution=s,this.scale=a,this.coords=c,this.bounds=u},w=function(e){function t(t){var r=e.call(this,t)||this;return r._tileMap=new Map,r.container=new f.default(r),r.layer=null,r.tiles=[],r._renderTarget={framebufferObject:null,viewport:[0,0,0,0]},r}return r.__extends(t,e),Object.defineProperty(t.prototype,"_tileInfoView",{get:function(){var e=this.layer&&this.layer.tileInfo;return e?new c.TileInfoView(e):null},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"context",{get:function(){return this.view._stage.context.gl},enumerable:!1,configurable:!0}),t.prototype.attach=function(){},t.prototype.detach=function(){},t.prototype.requestRender=function(){this.container.requestRender()},t.prototype.tilesChanged=function(e,t){},t.prototype.doRefresh=function(){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){return[2]}))}))},t.prototype.isUpdating=function(){return!1},t.prototype.update=function(e){var t=this._tileInfoView,r=this.tiles;if(t){var i=t.getTileCoverage(e.state,0),n=i.spans,o=i.lodInfo,s=o.level;if(n.length)for(var a=0,c=n;a<c.length;a++)for(var u=c[a],l=u.row,p=u.colFrom,f=u.colTo,h=p;h<=f;h++){var d=o.normalizeCol(h),y=o.getWorldForColumn(h),w=s+"/"+l+"/"+d+"/"+y;if(!this._tileMap.has(w)){var m=new _(w,s,l,d,y,o.resolution,o.scale);o.getTileCoords(m.coords,m,!1),o.getTileBounds(m.bounds,m,!0),this._tileMap.set(w,m),r.push(m),g.push(m)}v.add(w)}}for(var T=r.length-1;T>=0;T--){m=r[T];v.has(m.id)||(r.splice(T,1),x.push(m),this._tileMap.delete(m.id))}(g.length||x.length)&&(this.tilesChanged(g,x),g.length=x.length=0),v.clear(),this.requestRender()},t.prototype.moveStart=function(){},t.prototype.viewChange=function(){this.requestUpdate()},t.prototype.moveEnd=function(){},t.prototype.bindRenderTarget=function(){this.context.bindFramebuffer(this.context.FRAMEBUFFER,this._renderTarget.framebufferObject),this.context.viewport(this._renderTarget.viewport[0],this._renderTarget.viewport[1],this._renderTarget.viewport[2],this._renderTarget.viewport[3])},t.prototype.getRenderTarget=function(){return this._renderTarget},t.prototype.tessellateExtent=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,i,n;return r.__generator(this,(function(r){switch(r.label){case 0:return t={vertices:[],indices:[]},[4,this._projectAndNormalizeGeometry(e)];case 1:return i=r.sent(),n=t.vertices.length,t.vertices.push({x:i.xmin,y:i.ymin,xOffset:0,yOffset:0,uTexcoord:0,vTexcoord:0,distance:0}),t.vertices.push({x:i.xmax,y:i.ymin,xOffset:0,yOffset:0,uTexcoord:1,vTexcoord:0,distance:0}),t.vertices.push({x:i.xmin,y:i.ymax,xOffset:0,yOffset:0,uTexcoord:0,vTexcoord:1,distance:0}),t.vertices.push({x:i.xmax,y:i.ymax,xOffset:0,yOffset:0,uTexcoord:1,vTexcoord:1,distance:0}),t.indices.push(n+0,n+1,n+2,n+1,n+3,n+2),[2,t]}}))}))},t.prototype.tessellatePoint=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var i;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,this._projectAndNormalizeGeometry(e)];case 1:return i=r.sent(),[2,this._tessellatePoints([i],t)]}}))}))},t.prototype.tessellateMultipoint=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var i,n;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,this._projectAndNormalizeGeometry(e)];case 1:return i=r.sent(),n=i.points.map((function(e){return{x:e[0],y:e[1],spatialReference:i.spatialReference}})),[2,this._tessellatePoints(n,t)]}}))}))},t.prototype._tessellatePoints=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var i,n,o,s,a;return r.__generator(this,(function(r){for(i={vertices:[],indices:[]},n=0,o=e;n<o.length;n++)s=o[n],a=i.vertices.length,i.vertices.push({x:s.x,y:s.y,xOffset:t.x,yOffset:t.y+t.height,uTexcoord:0,vTexcoord:0,distance:0}),i.vertices.push({x:s.x,y:s.y,xOffset:t.x+t.width,yOffset:t.y+t.height,uTexcoord:1,vTexcoord:0,distance:0}),i.vertices.push({x:s.x,y:s.y,xOffset:t.x,yOffset:t.y,uTexcoord:0,vTexcoord:1,distance:0}),i.vertices.push({x:s.x,y:s.y,xOffset:t.x+t.width,yOffset:t.y,uTexcoord:1,vTexcoord:1,distance:0}),i.indices.push(a+0,a+1,a+2,a+1,a+3,a+2);return[2,i]}))}))},t.prototype.tessellatePolyline=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var i,n,o,s,a,c,l,p,f,h,d,y;return r.__generator(this,(function(r){switch(r.label){case 0:return i={vertices:[],indices:[]},[4,this._projectAndNormalizeGeometry(e)];case 1:if(n=r.sent(),!(o=n.paths)||!o.length)return[2,i];for(a=new u.StandardTessellationCallbacks((function(e,r,n,o,a,c,u,l,p){var f=i.vertices.length;return i.vertices.push({x:e,y:-r,xOffset:a*t/2,yOffset:c*t/2,uTexcoord:p/s,vTexcoord:(l+1)/2,distance:p}),f}),(function(e,t,r){i.indices.push(e,t,r)})),c=0,l=o;c<l.length;c++){for(p=l[c],s=0,f=1;f<p.length;++f)h=p[f][0]-p[f-1][0],d=p[f][1]-p[f-1][1],s+=Math.sqrt(h*h+d*d);y=p.map((function(e){return{x:e[0],y:-e[1]}})),u.tessellate(y,m,a)}return[2,i]}}))}))},t.prototype.tessellatePolygon=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,i,n,o,a,c,u,l,p,f,d,y,v,g=this;return r.__generator(this,(function(r){switch(r.label){case 0:return t={vertices:[],indices:[]},[4,this._projectAndNormalizeGeometry(e)];case 1:if(i=r.sent(),!(n=i.rings)||!n.length)return[2,t];for(s.closeRings(i),o=0,a=i.rings;o<a.length;o++)for(c=a[o],u=0,l=c;u<l.length;u++)(p=l[u])[1]=-p[1];return f=1/0,d=1/0,y=-1/0,v=-1/0,h.analyzeRings(i.rings,(function(){}),(function(e,t,r){for(var i=e;i<t;i+=2)f=Math.min(f,r[i]),d=Math.min(d,r[i+1]),y=Math.max(y,r[i]),v=Math.max(v,r[i+1])})),h.analyzeRings(i.rings,(function(){}),(function(e,r,i,n){g._invokeEarcut(t,e,r,i,n,[f,d,y,v])})),[2,t]}}))}))},t.prototype._invokeEarcut=function(e,t,r,i,o,s){for(var a=i.slice(t,r),c=n.earcut(a,o,2),u=e.vertices.length,l=0;l<a.length;l+=2){var p=a[l],f=a[l+1];e.vertices.push({x:p,y:-f,xOffset:0,yOffset:0,uTexcoord:(p-s[0])/(s[2]-s[0]),vTexcoord:1-(f-s[1])/(s[3]-s[1]),distance:0})}for(l=0;l<c.length;++l)e.indices.push(u+c[l])},t.prototype._projectAndNormalizeGeometry=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,a.checkProjectionSupport(e.spatialReference,this.view.spatialReference)];case 1:return r.sent(),t=p.normalizeCentralMeridian(e),[2,a.project(t,e.spatialReference,this.view.spatialReference)]}}))}))},r.__decorate([i.property({dependsOn:["layer.loaded"]})],t.prototype,"_tileInfoView",null),r.__decorate([i.property()],t.prototype,"layer",void 0),r.__decorate([i.property({dependsOn:["view"]})],t.prototype,"context",null),t=r.__decorate([i.subclass("esri.views.2d.layers.BaseLayerViewGL2D")],t)}(y.RefreshableLayerView(l.LayerView2DMixin(d))),m={trackDistance:!0,wrapDistance:1e11,thin:!1,initialDistance:0,enableOuterBisectorSplit:!0,outerBisectorAutoSplitThreshold:1/3.8,enableInnerBisectorSplit:!0,innerBisectorAutoSplitThreshold:1/3.8};return w}));