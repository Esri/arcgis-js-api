/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/accessorSupport/decorators/subclass","../../../chunks/earcut","../../../geometry/support/aaBoundingRect","../../../geometry/support/coordsUtils","../../../geometry/support/normalizeUtilsSync","../../../geometry/support/spatialReferenceUtils","../../../layers/graphics/data/projectionSupport","../tiling/PagedTileQueue","../tiling/TileInfoView","../tiling/TileKey","../tiling/TileQueue","../tiling/TileStrategy","../engine/webgl/definitions","../engine/webgl/TurboLine","./LayerView2D","./support/DisplayGL","./support/util","../../layers/LayerView","../../layers/RefreshableLayerView"],(function(e,t,n,r,i,o,s,c,a,l,u,f,p,h,d,y,x,g,v,T,_,m,w,R){"use strict";const O=new Set,G=[],b=[];let M=function(e,t,n,r,i,o,s,a=[0,0],l=c.create()){this.id=e,this.level=t,this.row=n,this.col=r,this.world=i,this.resolution=o,this.scale=s,this.coords=a,this.bounds=l},L=function(t){function n(n){var r;return(r=t.call(this,n)||this)._tileMap=new Map,r.container=new _(e._assertThisInitialized(r)),r.layer=null,r.tiles=[],r._renderTarget={framebuffer:null,viewport:[0,0,0,0]},r}e._inheritsLoose(n,t);var r=n.prototype;return r.attach=function(){},r.detach=function(){},r.requestRender=function(){this.container.requestRender()},r.tilesChanged=function(e,t){},r.supportsSpatialReference=function(e){const t=this.layer?.tileInfo;return!t||u.equals(t.spatialReference,e)},r.doRefresh=function(){var t=e._asyncToGenerator((function*(){}));function n(){return t.apply(this,arguments)}return n}(),r.isUpdating=function(){return!1},r.update=function(e){const t=this._tileInfoView,n=this.tiles;if(t){const r=t.getTileCoverage(e.state,0),i=r?.spans,o=r?.lodInfo;if(i?.length&&o){const e=o.level;for(const{row:t,colFrom:r,colTo:s}of i)for(let i=r;i<=s;i++){const r=o.normalizeCol(i),s=o.getWorldForColumn(i),c=`${e}/${t}/${r}/${s}`;if(!this._tileMap.has(c)){const i=new M(c,e,t,r,s,o.resolution,o.scale);o.getTileCoords(i.coords,i,!1),o.getTileBounds(i.bounds,i,!0),this._tileMap.set(c,i),n.push(i),G.push(i)}O.add(c)}}}for(let r=n.length-1;r>=0;r--){const e=n[r];O.has(e.id)||(n.splice(r,1),b.push(e),this._tileMap.delete(e.id))}(G.length||b.length)&&(this.tilesChanged(G,b),G.length=b.length=0),O.clear(),this.requestRender()},r.moveStart=function(){},r.viewChange=function(){this.requestUpdate()},r.moveEnd=function(){},r.bindRenderTarget=function(){this.context.bindFramebuffer(this.context.FRAMEBUFFER,this._renderTarget.framebuffer),this.context.viewport(this._renderTarget.viewport[0],this._renderTarget.viewport[1],this._renderTarget.viewport[2],this._renderTarget.viewport[3])},r.getRenderTarget=function(){return this._renderTarget},r.tessellateExtent=function(){var t=e._asyncToGenerator((function*(e){const t={vertices:[],indices:[]},n=yield this._projectAndNormalizeGeometry(e),r=t.vertices.length;return t.vertices.push({x:n.xmin,y:n.ymin,xOffset:0,yOffset:0,uTexcoord:0,vTexcoord:0,distance:0}),t.vertices.push({x:n.xmax,y:n.ymin,xOffset:0,yOffset:0,uTexcoord:1,vTexcoord:0,distance:0}),t.vertices.push({x:n.xmin,y:n.ymax,xOffset:0,yOffset:0,uTexcoord:0,vTexcoord:1,distance:0}),t.vertices.push({x:n.xmax,y:n.ymax,xOffset:0,yOffset:0,uTexcoord:1,vTexcoord:1,distance:0}),t.indices.push(r+0,r+1,r+2,r+1,r+3,r+2),t}));function n(e){return t.apply(this,arguments)}return n}(),r.tessellatePoint=function(){var t=e._asyncToGenerator((function*(e,t){const n=yield this._projectAndNormalizeGeometry(e);return this._tessellatePoints([n],t)}));function n(e,n){return t.apply(this,arguments)}return n}(),r.tessellateMultipoint=function(){var t=e._asyncToGenerator((function*(e,t){const n=yield this._projectAndNormalizeGeometry(e),r=n.points.map((e=>({x:e[0],y:e[1],spatialReference:n.spatialReference})));return this._tessellatePoints(r,t)}));function n(e,n){return t.apply(this,arguments)}return n}(),r._tessellatePoints=function(){var t=e._asyncToGenerator((function*(e,t){const n={vertices:[],indices:[]};for(const r of e){const e=n.vertices.length;n.vertices.push({x:r.x,y:r.y,xOffset:t.x,yOffset:t.y+t.height,uTexcoord:0,vTexcoord:0,distance:0}),n.vertices.push({x:r.x,y:r.y,xOffset:t.x+t.width,yOffset:t.y+t.height,uTexcoord:1,vTexcoord:0,distance:0}),n.vertices.push({x:r.x,y:r.y,xOffset:t.x,yOffset:t.y,uTexcoord:0,vTexcoord:1,distance:0}),n.vertices.push({x:r.x,y:r.y,xOffset:t.x+t.width,yOffset:t.y,uTexcoord:1,vTexcoord:1,distance:0}),n.indices.push(e+0,e+1,e+2,e+1,e+3,e+2)}return n}));function n(e,n){return t.apply(this,arguments)}return n}(),r.tessellatePolyline=function(){var t=e._asyncToGenerator((function*(e,t){const n={vertices:[],indices:[]},r=(yield this._projectAndNormalizeGeometry(e)).paths;if(!r||!r.length)return n;let i;const o=new v.LineTessellation(((e,r,o,s,c,a,l,u,f,p,h)=>{const d=n.vertices.length;return n.vertices.push({x:e,y:-r,xOffset:l*t/2,yOffset:u*t/2,uTexcoord:h/i,vTexcoord:(p+1)/2,distance:h}),d}),((e,t,r)=>{n.indices.push(e,t,r)}),!0);for(const s of r){i=0;for(let t=1;t<s.length;++t){const e=s[t][0]-s[t-1][0],n=s[t][1]-s[t-1][1];i+=Math.sqrt(e*e+n*n)}const e=s.map((e=>({x:e[0],y:-e[1]})));o.tessellate(e,z)}return n}));function n(e,n){return t.apply(this,arguments)}return n}(),r.tessellatePolygon=function(){var t=e._asyncToGenerator((function*(e){const t={vertices:[],indices:[]},n=yield this._projectAndNormalizeGeometry(e),r=n.rings;if(!r||!r.length)return t;a.closeRings(n);for(const a of n.rings)for(const e of a)e[1]=-e[1];let i=1/0,o=1/0,s=-1/0,c=-1/0;return m.analyzeRings(n.rings,(()=>{}),((e,t,n)=>{for(let r=e;r<t;r+=2)i=Math.min(i,n[r]),o=Math.min(o,n[r+1]),s=Math.max(s,n[r]),c=Math.max(c,n[r+1])})),m.analyzeRings(n.rings,(()=>{}),((e,n,r,a)=>{this._invokeEarcut(t,e,n,r,a,[i,o,s,c])})),t}));function n(e){return t.apply(this,arguments)}return n}(),r._invokeEarcut=function(e,t,n,r,i,o){const c=r.slice(t,n),a=s.earcut(c,i,2),l=e.vertices.length;for(let s=0;s<c.length;s+=2){const t=c[s],n=c[s+1];e.vertices.push({x:t,y:-n,xOffset:0,yOffset:0,uTexcoord:(t-o[0])/(o[2]-o[0]),vTexcoord:1-(n-o[1])/(o[3]-o[1]),distance:0})}for(let s=0;s<a.length;++s)e.indices.push(l+a[s])},r._projectAndNormalizeGeometry=function(){var t=e._asyncToGenerator((function*(e){yield f.checkProjectionSupport(e.spatialReference,this.view.spatialReference);const t=l.normalizeCentralMeridianForDisplay(e);return f.project(t,e.spatialReference,this.view.spatialReference)}));function n(e){return t.apply(this,arguments)}return n}(),e._createClass(n,[{key:"_tileInfoView",get:function(){const e=this.layer&&this.layer.tileInfo;return e?new h(e):null}},{key:"context",get:function(){return this.view._stage.context.gl}}]),n}(R(T.LayerView2DMixin(w)));t.__decorate([n.property()],L.prototype,"_tileInfoView",null),t.__decorate([n.property()],L.prototype,"layer",void 0),t.__decorate([n.property()],L.prototype,"context",null),L=t.__decorate([o.subclass("esri.views.2d.layers.BaseLayerViewGL2D")],L);const z={pixelCoordRatio:1,wrapDistance:1e11,halfWidth:g.THIN_LINE_HALF_WIDTH_THRESHOLD+1,initialDistance:0,textured:!0,offset:0};return L}));
