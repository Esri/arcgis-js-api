/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../Graphic","../../../core/Logger","../../../core/maybe","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/accessorSupport/decorators/subclass","../../../layers/support/rasterDatasets/multidimensionalUtils","../engine/flow/FlowView2D","./LayerView2D","./imagery/ImageryTileView2D","./imagery/VectorFieldTileView2D","./support/util","../../layers/ImageryTileLayerView","../../layers/LayerView","../../layers/RefreshableLayerView"],(function(e,t,i,r,s,n,a,o,u,c,h,l,d,p,b,y,w,v,g,f){"use strict";let m=function(t){function o(){var e;return(e=t.apply(this,arguments)||this)._useWebGLForProcessing=!0,e._useProgressiveUpdate=!0,e.subview=null,e}e._inheritsLoose(o,t);var u=o.prototype;return u.update=function(e){this.subview?.update(e),this.notifyChange("updating")},u.isUpdating=function(){return!this.subview||this.subview.updating},u.attach=function(){this.layer.increaseRasterJobHandlerUsage(),this._updateSubview(),this.addAttachHandles([a.watch((()=>{const{layer:e}=this;return{bandIds:e.bandIds,renderer:e.renderer,interpolation:e.interpolation,multidimensionalDefinition:e.multidimensionalDefinition,rasterFunction:"imagery-tile"===e.type?e.rasterFunction:null}}),((e,t)=>{const i=e.interpolation!==t?.interpolation&&("majority"===e.interpolation||"majority"===t?.interpolation)&&w.canUseMajorityInterpolationOnDataSource(this.layer),s=e.renderer!==t?.renderer&&t?.renderer?.type!==e.renderer?.type;s&&this._updateSubview();const a=e.multidimensionalDefinition!==t?.multidimensionalDefinition,o=e.rasterFunction!==t?.rasterFunction,u=o&&!this._useWebGLForProcessing,c=a||i||s||u;this.subview.redrawOrRefetch({refetch:c,reprocess:o}).catch((e=>{n.isAbortError(e)||r.getLogger(this.declaredClass).error(e)})),this.notifyChange("updating")})),a.watch((()=>this.layer.blendMode??"normal"),(e=>{this.subview.container.blendMode=e}),a.syncAndInitial),a.watch((()=>this.layer.effect??null),(e=>{this.subview.container.effect=e}),a.syncAndInitial),a.watch((()=>this.layer.multidimensionalSubset??null),((e,t)=>{const{multidimensionalDefinition:i}=this.layer;s.isSome(i)&&l.hasExcludedVariableOrDimension(i,e)!==l.hasExcludedVariableOrDimension(i,t)&&(this.subview.redrawOrRefetch({refetch:!0}).catch((e=>{n.isAbortError(e)||r.getLogger(this.declaredClass).error(e)})),this.notifyChange("updating"))}),a.sync),a.watch((()=>this.timeExtent),(()=>{this.subview.timeExtent=this.timeExtent,this.subview.redrawOrRefetch({refetch:!0}).catch((e=>{n.isAbortError(e)||r.getLogger(this.declaredClass).error(e)}))}),a.initial)])},u.detach=function(){this.layer.decreaseRasterJobHandlerUsage(),this._detachSubview(this.subview),this.subview?.destroy(),this.subview=null},u.moveStart=function(){this.requestUpdate()},u.viewChange=function(){this.requestUpdate()},u.moveEnd=function(){this.subview.moveEnd()},u.hitTest=function(){var t=e._asyncToGenerator((function*(e,t){return[{type:"graphic",layer:this.layer,mapPoint:e,graphic:new i({attributes:{},geometry:e.clone()})}]}));function r(e,i){return t.apply(this,arguments)}return r}(),u.doRefresh=function(){return this.subview?this.subview.doRefresh():Promise.resolve()},u._updateSubview=function(){const e="vector-field"===this.layer.renderer.type?"rasterVF":"flow"===this.layer.renderer.type?"flow":"raster";if(this.subview){if(this.subview.type===e)return void this._attachSubview(this.subview);this._detachSubview(this.subview),this.subview?.destroy(),this.subview=null}const{layer:t}=this;let i;if(i="rasterVF"===e?new y({layer:t,layerView:this}):"flow"===e?new d({layer:t,layerView:this}):new b({layer:t,layerView:this}),"useWebGLForProcessing"in i&&(i.useWebGLForProcessing=this._useWebGLForProcessing),"useProgressiveUpdate"in i&&(i.useProgressiveUpdate=this._useProgressiveUpdate),"previousLOD"in i){const{subview:e}=this;i.previousLOD=e&&"previousLOD"in e?e.previousLOD:null}this._attachSubview(i),this.subview=i,this.requestUpdate()},u._attachSubview=function(e){e&&!e.attached&&(e.attach(),e.attached=!0,this.container.addChildAt(e.container,0),e.container.blendMode=this.layer.blendMode,e.container.effect=this.layer.effect)},u._detachSubview=function(e){e?.attached&&(this.container.removeChild(e.container),e.detach(),e.attached=!1)},e._createClass(o,[{key:"useWebGLForProcessing",get:function(){return this._useWebGLForProcessing},set:function(e){this._useWebGLForProcessing=e,this.subview&&"useWebGLForProcessing"in this.subview&&(this.subview.useWebGLForProcessing=e)}},{key:"useProgressiveUpdate",get:function(){return this._useWebGLForProcessing},set:function(e){this._useProgressiveUpdate=e,this.subview&&"useProgressiveUpdate"in this.subview&&(this.subview.useProgressiveUpdate=e)}}]),o}(v(f(p.LayerView2DMixin(g))));t.__decorate([o.property()],m.prototype,"subview",void 0),t.__decorate([o.property()],m.prototype,"useWebGLForProcessing",null),t.__decorate([o.property()],m.prototype,"useProgressiveUpdate",null),m=t.__decorate([h.subclass("esri.views.2d.layers.ImageryTileLayerView2D")],m);return m}));
