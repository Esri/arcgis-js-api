/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../Graphic","../../../core/Collection","../../../core/maybe","../../../core/watchUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/accessorSupport/ensureType","../../../core/Logger","../../../core/accessorSupport/decorators/subclass","./LayerView2D","./graphics/GraphicContainer","./graphics/GraphicsView2D","../../layers/LayerView"],(function(e,i,t,s,r,n,a,o,c,h,p,l,u,f,d){"use strict";const g="sublayers",y="layerView",w=Object.freeze({remove(){},pause(){},resume(){}});let V=function(i){function a(){return i.apply(this,arguments)||this}e._inheritsLoose(a,i);var o=a.prototype;return o.fetchPopupFeatures=function(){var i=e._asyncToGenerator((function*(e){return(yield Promise.all(Array.from(this.graphicsViews(),(i=>i.searchFeatures(e).then((e=>e.filter((e=>!!e.popupTemplate)))))))).flat()}));function t(e){return i.apply(this,arguments)}return t}(),o.graphicsViews=function*(){r.isSome(this._graphicsViewsFeatureCollectionMap)?yield*this._graphicsViewsFeatureCollectionMap.keys():r.isSome(this._graphicsViews)?yield*this._graphicsViews:yield*[]},o.hitTest=function(){var i=e._asyncToGenerator((function*(i,t){var s=this;if(this.suspended)return null;const n=Array.from(this.graphicsViews(),function(){var n=e._asyncToGenerator((function*(e){const n=yield e.hitTest(i,t);if(n){if(r.isSome(s._graphicsViewsFeatureCollectionMap)){const i=s._graphicsViewsFeatureCollectionMap.get(e);!n.popupTemplate&&i.popupTemplate&&(n.popupTemplate=i.popupTemplate)}return n}return null}));return function(e){return n.apply(this,arguments)}}());return(yield Promise.all(n)).filter((e=>!!e))[0]||null}));function t(e,t){return i.apply(this,arguments)}return t}(),o.highlight=function(e){let i;if("number"==typeof e?i=[e]:e instanceof t?i=[e.uid]:Array.isArray(e)&&e.length>0?i="number"==typeof e[0]?e:e.map((e=>e&&e.uid)):s.isCollection(e)&&(i=e.map((e=>e&&e.uid)).toArray()),i=i.filter((e=>null!=e)),!i.length)return w;for(const t of this.graphicsViews())t.addHighlight(i);return{remove:()=>{for(const e of this.graphicsViews())e.removeHighlight(i)}}},o.update=function(e){for(const i of this.graphicsViews())i.processUpdate(e)},o.attach=function(){const e=this.view,i=()=>this.requestUpdate(),t=this.layer.featureCollections;if(r.isSome(t)&&t.length){this._graphicsViewsFeatureCollectionMap=new Map;for(const s of t){const t=new u(this.view.featuresTilingScheme);t.fadeTransitionEnabled=!0;const r=new f({view:e,graphics:s.source,renderer:s.renderer,requestUpdateCallback:i,container:t});this._graphicsViewsFeatureCollectionMap.set(r,s),this.container.addChild(r.container),this.handles.add([n.init(s,"visible",(e=>r.container.visible=e)),n.init(r,"updating",(()=>this.notifyChange("updating")))],y)}}else r.isSome(this.layer.sublayers)&&this.handles.add(n.on(this.layer,"sublayers","change",(()=>this._createGraphicsViews()),(()=>this._createGraphicsViews()),(()=>this._destroyGraphicsViews())),g)},o.detach=function(){this._destroyGraphicsViews(),this.handles.remove(g)},o.moveStart=function(){},o.moveEnd=function(){},o.viewChange=function(){for(const e of this.graphicsViews())e.viewChange()},o.isUpdating=function(){for(const e of this.graphicsViews())if(e.updating)return!0;return!1},o._destroyGraphicsViews=function(){this.container.removeAllChildren(),this.handles.remove(y);for(const e of this.graphicsViews())e.destroy();this._graphicsViews=null,this._graphicsViewsFeatureCollectionMap=null},o._createGraphicsViews=function(){if(this._destroyGraphicsViews(),r.isNone(this.layer.sublayers))return;const e=[],i=this.view,t=()=>this.requestUpdate();for(const s of this.layer.sublayers){const r=new u(this.view.featuresTilingScheme);r.fadeTransitionEnabled=!0;const a=new f({view:i,graphics:s.graphics,requestUpdateCallback:t,container:r});this.handles.add([s.on("graphic-update",a.graphicUpdateHandler),n.init(s,"visible",(e=>a.container.visible=e)),n.init(a,"updating",(()=>this.notifyChange("updating")))],y),this.container.addChild(a.container),e.push(a)}this._graphicsViews=e},a}(l.LayerView2DMixin(d));return V=i.__decorate([p.subclass("esri.views.2d.layers.MapNotesLayerView2D")],V),V}));
