// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../core/has","../../../../core/screenUtils","../../../../core/unitUtils","../../../../core/libs/rbush/rbush","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/contains","../../../../geometry/support/extentUtils","../../../../geometry/support/jsonUtils","../../../../geometry/support/normalizeUtils","./GraphicStoreItem","./graphicsUtils"],(function(e,t,i,r,o,n,s,a,u,l,p,d,h,c){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var m={minX:0,minY:0,maxX:0,maxY:0},g=a.create(),y=[];function f(e,t,i,r,o){return m.minX=t,m.minY=i,m.maxX=r,m.maxY=o,e.search(m)}var _=function(){function e(e,t,i,o,a,u){this._graphics=o,this._onAdd=a,this._onRemove=u,this._index=s(9,r("csp-restrictions")?function(e){return{minX:e.bounds[0],minY:e.bounds[1],maxX:e.bounds[2],maxY:e.bounds[3]}}:[".bounds[0]",".bounds[1]",".bounds[2]",".bounds[3]"]),this._itemByGraphic=new Map,this._currentLevel=-1/0,this._tileInfoView=e,this._uidFieldName=i;var l=e.getClosestInfoForScale(t);l&&(this._currentLevel=l.level,this._resolution=this._tileInfoView.getTileResolution(l.level)),this._metersPerUnit=n.getMetersPerUnit(e.spatialReference)}return e.prototype.hitTest=function(e,t,i,r,n){e=d.normalizeMapX(e,this._tileInfoView.spatialReference);var s=.5*r*i;g[0]=e-s,g[1]=t-s,g[2]=e+s,g[3]=t+s;var h=.5*r*(i+50),m=f(this._index,e-h,t-h,e+h,t+h);if(!m||0===m.length)return[];for(var y,_={x:e,y:t},b=[],v=0,x=m;v<x.length;v++){var G=x[v];if(G.graphic.visible)switch(p.getJsonType(G.geometry)){case"esriGeometryPoint":if(!(R=G.symbol))continue;var B=G.geometry,I=B.x,P=B.y,z=r*this._metersPerUnit,T=void 0;switch(R.type){case"esriTS":T=c.getTextSymbolBounds(I,P,R,G.size,r,n);break;case"expanded-cim":T=c.getCIMMarkerBounds(I,P,R,r,z,n);break;case"esriSMS":case"esriPMS":T=c.getMarkerSymbolBounds(I,P,R,r,z,n)}u.polygonContainsPoint(T,_)&&b.push(G);break;case"esriGeometryPolyline":if(!(R=G.symbol)||!R.layers.length)continue;var w=R.layers[0];y=1.5*r*window.devicePixelRatio*o.pt2px(w.width),c.isPointOnPolyline(G.geometry,e,t,y)&&b.push(G);break;case"esriGeometryEnvelope":var M=G.geometry,U=a.fromValues(M.xmin,M.ymin,M.xmax,M.ymax);a.intersects(U,g)&&b.push(G);break;case"esriGeometryPolygon":if(u.polygonContainsPoint(G.geometry,_)){b.push(G);break}var k=l.getPolygonExtent(G.geometry);if(Math.abs(k.ymax-k.ymin)<5*r||Math.abs(k.xmax-k.xmin)<5*r){U=a.fromValues(k.xmin,k.ymin,k.xmax,k.ymax);a.intersects(U,g)&&b.push(G)}break;case"esriGeometryMultipoint":var R;if(!(R=G.symbol))continue;for(var S=G.geometry.points,V=(T=void 0,0);V<S.length;V++)if(T="esriTS"===R.type?c.getTextSymbolBounds(S[V][0],S[V][1],R,G.size,r,n):c.getMarkerSymbolBounds(S[V][0],S[V][1],R,r,r*this._metersPerUnit,n),u.polygonContainsPoint(T,_)){b.push(G);break}}}return b.sort((function(e,t){var i=c.graphicGeometryToNumber(e.graphic),r=c.graphicGeometryToNumber(t.graphic);return i===r?t.zorder-e.zorder:i-r})),b.map((function(e){return e.graphic}))},e.prototype.getGraphicsData=function(e,t,r){var o=f(this._index,t.bounds[0],t.bounds[1],t.bounds[2],t.bounds[3]);if(0===o.length||0===r.length)return[];o.sort((function(e,t){return e.zorder-t.zorder})),o[0].insertAfter=-1;for(var n=1;n<o.length;n++)o[n].insertAfter=o[n-1].graphic.uid;o.sort((function(e,t){return e.graphic.uid-t.graphic.uid})),r.sort((function(e,t){return e.uid-t.uid}));for(var s,a=0,u=0,l=[],p={originPosition:"upperLeft",scale:[t.resolution,t.resolution],translate:[t.bounds[0],t.bounds[3]]},d=0,c=r;d<c.length;d++){var m=c[d];for(u=-2;a<o.length;)if(s=o[a],a++,m.uid===s.graphic.uid){u=s.insertAfter;break}if(s.geometry&&-2!==u){var g=s.getGeometryQuantized(p),y=i.__assign({},s.graphic.attributes);y[this._uidFieldName]=m.uid,null==s.groupId&&(s.groupId=e.createTemplateGroup(s.symbol,null)),l.push({centroid:h.default.getCentroidQuantized(s,p),geometry:g,attributes:y,symbol:s.symbol,groupId:s.groupId,insertAfter:u})}}return l},e.prototype.getGraphicData=function(e,t,r){var o=this._itemByGraphic.get(r);if(!o)return null;var n=f(this._index,t.bounds[0],t.bounds[1],t.bounds[2],t.bounds[3]);n.sort((function(e,t){return e.zorder-t.zorder}));var s=n.indexOf(o),a=0===s||-1===s?-1:n[s-1].graphic.uid,u={originPosition:"upperLeft",scale:[t.resolution,t.resolution],translate:[t.bounds[0],t.bounds[3]]},l=o.getGeometryQuantized(u),p=i.__assign({},o.graphic.attributes);return p[this._uidFieldName]=r.uid,null==o.groupId&&(o.groupId=e.createTemplateGroup(o.symbol,null)),{centroid:h.default.getCentroidQuantized(o,u),geometry:l,attributes:p,symbol:o.symbol,groupId:o.groupId,insertAfter:a}},e.prototype.queryTileData=function(e,t){var i=50*t.resolution,r=a.pad(t.bounds,i,a.create()),o=f(this._index,r[0],r[1],r[2],r[3]),n=[];return this._createTileGraphics(n,e,o,{originPosition:"upperLeft",scale:[t.resolution,t.resolution],translate:[t.bounds[0],t.bounds[3]]}),n},e.prototype.has=function(e){return this._itemByGraphic.has(e)},e.prototype.getBounds=function(e){return this._itemByGraphic.has(e)?this._itemByGraphic.get(e).bounds:null},e.prototype.addOrModify=function(e,t,i){if(e){this.has(e)&&this.remove(e),this._onAdd(e);var r=h.default.acquire(e,t,i,this._resolution,this._resolution*this._metersPerUnit,this._tileInfoView.spatialReference);return this._itemByGraphic.set(e,r),i&&this._index.insert(r),r.bounds}},e.prototype.remove=function(e){if(this._itemByGraphic.has(e)){this._onRemove(e);var t=this._itemByGraphic.get(e);this._index.remove(t),this._itemByGraphic.delete(e)}},e.prototype.updateZ=function(){for(var e,t,i=this._graphics.items,r=0;r<i.length;r++)t=i[r],(e=this._itemByGraphic.get(t))&&(e.zorder=r)},e.prototype.update=function(e,t,i){var r=this._itemByGraphic.get(e);r.groupId=null;var o=a.clone(r.bounds);return r.size[0]=r.size[1]=0,this._index.remove(r),r.set(e,t,i,this._resolution,this._resolution*this._metersPerUnit,this._tileInfoView.spatialReference),i&&this._index.insert(r),{oldBounds:o,newBounds:r.bounds}},e.prototype.updateLevel=function(e){var t=this;if(this._currentLevel!==e){this._currentLevel=e;var i=this._tileInfoView.getTileResolution(e);this._resolution=i,this._index.clear(),y.length=0,this._itemByGraphic.forEach((function(e){e.updateBounds(t._resolution,t._resolution*t._metersPerUnit,t._tileInfoView.spatialReference),e.geometry&&y.push(e)})),this._index.load(y)}},e.prototype.clear=function(){this._itemByGraphic.clear(),this._index.clear()},e.prototype._createTileGraphics=function(e,t,r,o){var n,s,a,u,l=this._uidFieldName;r.sort((function(e,t){return e.zorder-t.zorder}));for(var p=0;p<r.length;p++){n=(a=r[p]).graphic,s=a.getGeometryQuantized(o),u=0===p?-1:r[p-1].graphic.uid;var d=i.__assign({},a.graphic.attributes);d[l]=n.uid,null==a.groupId&&(a.groupId=t.createTemplateGroup(a.symbol,null)),e.push({centroid:h.default.getCentroidQuantized(a,o),geometry:s,attributes:d,symbol:a.symbol,groupId:a.groupId,insertAfter:u})}},e}();t.default=_}));