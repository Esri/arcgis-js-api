/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../../core/has","../../../../geometry/support/contains","../../../../geometry/support/extentUtils","../../../../geometry/support/jsonUtils","../../../../core/screenUtils","../../../../core/unitUtils","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/normalizeUtils","../../../../chunks/rbush","./graphicsUtils","./GraphicStoreItem"],(function(e,t,i,r,s,o,n,u,a,c,l){"use strict";const h={minX:0,minY:0,maxX:0,maxY:0},d=n.create(),m=[];function p(e,t,i,r,s){return h.minX=t,h.minY=i,h.maxX=r,h.maxY=s,e.search(h)}return function(){function h(t,i,r,s,n,u){this._graphics=s,this._onAdd=n,this._onRemove=u,this._index=a.rbush(9,e("csp-restrictions")?e=>({minX:e.bounds[0],minY:e.bounds[1],maxX:e.bounds[2],maxY:e.bounds[3]}):[".bounds[0]",".bounds[1]",".bounds[2]",".bounds[3]"]),this._itemByGraphic=new Map,this._currentLevel=-1/0,this._tileInfoView=t,this._uidFieldName=r;const c=t.getClosestInfoForScale(i);c&&(this._currentLevel=c.level,this._resolution=this._tileInfoView.getTileResolution(c.level)),this._metersPerUnit=o.getMetersPerUnit(t.spatialReference)}var g=h.prototype;return g.hitTest=function(e,o,a,l,h){e=u.normalizeMapX(e,this._tileInfoView.spatialReference);const m=.5*l*a;d[0]=e-m,d[1]=o-m,d[2]=e+m,d[3]=o+m;const g=.5*l*(a+50),y=p(this._index,e-g,o-g,e+g,o+g);if(!y||0===y.length)return[];const f={x:e,y:o},_=[];let b;for(const u of y)if(u.graphic.visible)switch(r.getJsonType(u.geometry)){case"esriGeometryPoint":{const e=u.symbol;if(!e)continue;const i=u.geometry,{x:r,y:s}=i,o=l*this._metersPerUnit;let n;switch(e.type){case"esriTS":n=c.getTextSymbolBounds(r,s,e,u.size,l,h);break;case"expanded-cim":n=c.getCIMMarkerBounds(r,s,e,l,o,h);break;case"esriSMS":case"esriPMS":n=c.getMarkerSymbolBounds(r,s,e,l,o,h)}t.polygonContainsPoint(n,f)&&_.push(u)}break;case"esriGeometryPolyline":{const t=u.symbol;if(!t||!t.layers.length)continue;const i=t.layers[0];b=1.5*l*window.devicePixelRatio*s.pt2px(i.width),c.isPointOnPolyline(u.geometry,e,o,b)&&_.push(u)}break;case"esriGeometryEnvelope":{const e=u.geometry,t=n.fromValues(e.xmin,e.ymin,e.xmax,e.ymax);n.intersects(t,d)&&_.push(u);break}case"esriGeometryPolygon":{if(t.polygonContainsPoint(u.geometry,f)){_.push(u);break}const e=i.getPolygonExtent(u.geometry);if(Math.abs(e.ymax-e.ymin)<5*l||Math.abs(e.xmax-e.xmin)<5*l){const t=n.fromValues(e.xmin,e.ymin,e.xmax,e.ymax);n.intersects(t,d)&&_.push(u)}break}case"esriGeometryMultipoint":{const e=u.symbol;if(!e)continue;const i=u.geometry.points;let r;for(let s=0;s<i.length;s++)if(r="esriTS"===e.type?c.getTextSymbolBounds(i[s][0],i[s][1],e,u.size,l,h):c.getMarkerSymbolBounds(i[s][0],i[s][1],e,l,l*this._metersPerUnit,h),t.polygonContainsPoint(r,f)){_.push(u);break}break}}return _.sort(((e,t)=>{const i=c.graphicGeometryToNumber(e.graphic),r=c.graphicGeometryToNumber(t.graphic);return i===r?t.zorder-e.zorder:i-r})),_.map((e=>e.graphic))},g.getGraphicsData=function(e,t,i){const r=p(this._index,t.bounds[0],t.bounds[1],t.bounds[2],t.bounds[3]);if(0===r.length||0===i.length)return[];r.sort(((e,t)=>e.zorder-t.zorder)),r[0].insertAfter=-1;for(let e=1;e<r.length;e++)r[e].insertAfter=r[e-1].graphic.uid;r.sort(((e,t)=>e.graphic.uid-t.graphic.uid)),i.sort(((e,t)=>e.uid-t.uid));let s,o=0,n=0;const u=[],a={originPosition:"upperLeft",scale:[t.resolution,t.resolution],translate:[t.bounds[0],t.bounds[3]]};for(const t of i){for(n=-2;o<r.length;)if(s=r[o],o++,t.uid===s.graphic.uid){n=s.insertAfter;break}if(!s.geometry||-2===n)continue;const i=s.getGeometryQuantized(a),c={...s.graphic.attributes};c[this._uidFieldName]=t.uid,null==s.groupId&&(s.groupId=e.createTemplateGroup(s.symbol,null)),u.push({centroid:l.getCentroidQuantized(s,a),geometry:i,attributes:c,symbol:s.symbol,groupId:s.groupId,insertAfter:n,zorder:s.zorder})}return u.sort(((e,t)=>e.zorder-t.zorder)),u},g.queryTileData=function(e,t){const i=50*t.resolution,r=n.pad(t.bounds,i,n.create()),s=p(this._index,r[0],r[1],r[2],r[3]),o=[];return this._createTileGraphics(o,e,s,{originPosition:"upperLeft",scale:[t.resolution,t.resolution],translate:[t.bounds[0],t.bounds[3]]}),o},g.has=function(e){return this._itemByGraphic.has(e)},g.getBounds=function(e){return this._itemByGraphic.has(e)?this._itemByGraphic.get(e).bounds:null},g.addOrModify=function(e,t,i){if(!e)return;this.has(e)&&this.remove(e),this._onAdd(e);const r=l.acquire(e,t,i,this._resolution,this._resolution*this._metersPerUnit,this._tileInfoView.spatialReference);return this._itemByGraphic.set(e,r),i&&this._index.insert(r),r.bounds},g.remove=function(e){if(!this._itemByGraphic.has(e))return;this._onRemove(e);const t=this._itemByGraphic.get(e);this._index.remove(t),this._itemByGraphic.delete(e)},g.updateZ=function(){const e=this._graphics.items;let t,i;for(let r=0;r<e.length;r++)i=e[r],t=this._itemByGraphic.get(i),t&&(t.zorder=r)},g.update=function(e,t,i){const r=this._itemByGraphic.get(e);r.groupId=null;const s=n.clone(r.bounds);return r.size[0]=r.size[1]=0,this._index.remove(r),r.set(e,t,i,this._resolution,this._resolution*this._metersPerUnit,this._tileInfoView.spatialReference),i&&this._index.insert(r),{oldBounds:s,newBounds:r.bounds}},g.updateLevel=function(e){if(this._currentLevel===e)return;this._currentLevel=e;const t=this._tileInfoView.getTileResolution(e);this._resolution=t,this._index.clear(),m.length=0,this._itemByGraphic.forEach((e=>{e.updateBounds(this._resolution,this._resolution*this._metersPerUnit,this._tileInfoView.spatialReference),e.geometry&&m.push(e)})),this._index.load(m)},g.clear=function(){this._itemByGraphic.clear(),this._index.clear()},g._createTileGraphics=function(e,t,i,r){const s=this._uidFieldName;let o,n,u,a;i.sort(((e,t)=>e.zorder-t.zorder));for(let c=0;c<i.length;c++){u=i[c],o=u.graphic,n=u.getGeometryQuantized(r),a=0===c?-1:i[c-1].graphic.uid;const h={...u.graphic.attributes};h[s]=o.uid,null==u.groupId&&(u.groupId=t.createTemplateGroup(u.symbol,null)),e.push({centroid:l.getCentroidQuantized(u,r),geometry:n,attributes:h,symbol:u.symbol,groupId:u.groupId,insertAfter:a,zorder:u.zorder})}},h}()}));
