/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["../../../../core/screenUtils","../../../../core/unitUtils","../../../../chunks/rbush","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/contains","../../../../geometry/support/extentUtils","../../../../geometry/support/jsonUtils","../../../../geometry/support/normalizeUtils","../../../../geometry/support/normalizeUtilsCommon","../../../../geometry/support/spatialReferenceUtils","../../../../symbols/cim/utils","./GraphicStoreItem","./graphicsUtils"],(function(e,t,i,r,n,s,o,a,u,c,l,h,m){"use strict";const p={minX:0,minY:0,maxX:0,maxY:0},d=r.create(),g=1e-5;function f(e,t,i,r,n){return p.minX=t,p.minY=i,p.maxX=r,p.maxY=n,e.search(p)}function y(e){return{minX:e.bounds[0],minY:e.bounds[1],maxX:e.bounds[2],maxY:e.bounds[3]}}return function(){function p(e,r,n,s,o,a){this._graphics=s,this._onAdd=o,this._onRemove=a,this._index=i.rbush(9,y),this._itemByGraphic=new Map,this._currentLevel=-1/0,this._tileInfoView=e,this._uidFieldName=n;const u=e.getClosestInfoForScale(r);u&&(this._currentLevel=u.level,this._resolution=this._tileInfoView.getTileResolution(u.level));const l=e.spatialReference;this._metersPerUnit=c.isValid(l)?t.getMetersPerUnit(e.spatialReference):1}var _=p.prototype;return _.hitTest=function(t,i,u,c,h){t=a.normalizeMapX(t,this._tileInfoView.spatialReference);const p=.5*c*u;d[0]=t-p,d[1]=i-p,d[2]=t+p,d[3]=i+p;const g=.5*c*(u+m.PIXEL_BUFFER),y=f(this._index,t-g,i-g,t+g,i+g);if(!y||0===y.length)return[];const _={x:t,y:i},b=[];let x;for(const a of y)if(a.graphic.visible)switch(o.getJsonType(a.geometry)){case"esriGeometryPoint":{const e=a.symbol;if(!e)continue;const t=a.geometry,{x:i,y:r}=t,s=c*this._metersPerUnit;let o;switch(e.type){case"esriTS":o=m.getTextSymbolBounds(i,r,e,a.size,c,h);break;case"expanded-cim":o=m.getCIMMarkerBounds(i,r,e,c,s,h);break;case"esriSMS":case"esriPMS":o=m.getMarkerSymbolBounds(i,r,e,c,s,h)}n.polygonContainsPoint(o,_)&&b.push(a)}break;case"esriGeometryPolyline":{const r=a.symbol;let n=0;if("expanded-cim"===r.type){const e=r.layers;if(!e||0===e.length)continue;const t=e.findIndex((e=>"line"===e.type));if(-1===t)continue;const i=e[t];n=l.evaluateValueOrFunction(i.width,null,null)}else{const e=r.layers;if(!e||0===e.length)continue;n=e[0].width}x=1.5*c*window.devicePixelRatio*e.pt2px(n),m.isPointOnPolyline(a.geometry,t,i,x)&&b.push(a)}break;case"esriGeometryEnvelope":{const e=a.geometry,t=r.fromValues(e.xmin,e.ymin,e.xmax,e.ymax);r.intersects(t,d)&&b.push(a);break}case"esriGeometryPolygon":{if(n.polygonContainsPoint(a.geometry,_)){b.push(a);break}const e=s.getPolygonExtent(a.geometry);if(Math.abs(e.ymax-e.ymin)<5*c||Math.abs(e.xmax-e.xmin)<5*c){const t=r.fromValues(e.xmin,e.ymin,e.xmax,e.ymax);r.intersects(t,d)&&b.push(a)}break}case"esriGeometryMultipoint":{const e=a.symbol;if(!e)continue;const t=a.geometry.points;let i;for(let r=0;r<t.length;r++)if(i="esriTS"===e.type?m.getTextSymbolBounds(t[r][0],t[r][1],e,a.size,c,h):m.getMarkerSymbolBounds(t[r][0],t[r][1],e,c,c*this._metersPerUnit,h),n.polygonContainsPoint(i,_)){b.push(a);break}break}}return b.sort(((e,t)=>{const i=m.graphicGeometryToNumber(e.graphic),r=m.graphicGeometryToNumber(t.graphic);return i===r?t.zorder-e.zorder:i-r})),b.map((e=>e.graphic))},_.getGraphicsData=function(e,t,i){const r=this._searchForItems(t);if(0===r.length||0===i.length)return[];r.sort(((e,t)=>e.zorder-t.zorder)),r[0].insertAfter=-1;for(let c=1;c<r.length;c++)r[c].insertAfter=r[c-1].graphic.uid;r.sort(((e,t)=>e.graphic.uid-t.graphic.uid)),i.sort(((e,t)=>e.uid-t.uid));let n,s=0,o=0;const a=[],u={originPosition:"upperLeft",scale:[t.resolution,t.resolution],translate:[t.bounds[0],t.bounds[3]]};for(const c of i){for(o=-2;s<r.length;)if(n=r[s],s++,c.uid===n.graphic.uid){o=n.insertAfter;break}if(!n.geometry||-2===o)continue;const i=n.getGeometryQuantized(u,t.bounds,this._tileInfoView.spatialReference),l={...n.graphic.attributes};l[this._uidFieldName]=c.uid,null==n.groupId&&(n.groupId=e.createTemplateGroup(n.symbol,null)),a.push({centroid:h.getCentroidQuantized(n,u),geometry:i,attributes:l,symbol:n.symbol,groupId:n.groupId,insertAfter:o,zorder:n.zorder})}return a.sort(((e,t)=>e.zorder-t.zorder)),a},_.queryTileData=function(e,t){if(0===this._graphics.length)return[];const{bounds:i,resolution:r}=t,n=this._searchForItems(t),s=[];return 0===n.length||this._createTileGraphics(s,e,n,{originPosition:"upperLeft",scale:[r,r],translate:[i[0],i[3]]},t),s},_.has=function(e){return this._itemByGraphic.has(e)},_.getBounds=function(e){return this._itemByGraphic.has(e)?this._itemByGraphic.get(e).bounds:null},_.addOrModify=function(e,t,i){if(!e)return;this.has(e)&&this.remove(e),this._onAdd(e);const r=h.acquire(e,t,i,this._resolution,this._resolution*this._metersPerUnit,this._tileInfoView.spatialReference);return this._itemByGraphic.set(e,r),i&&this._index.insert(r),r.bounds},_.remove=function(e){if(!this._itemByGraphic.has(e))return;this._onRemove(e);const t=this._itemByGraphic.get(e);this._index.remove(t),this._itemByGraphic.delete(e)},_.updateZ=function(){const e=this._graphics.items;let t,i;for(let r=0;r<e.length;r++)i=e[r],t=this._itemByGraphic.get(i),t&&(t.zorder=r)},_.update=function(e,t,i){const n=this._itemByGraphic.get(e);n.groupId=null;const s=r.clone(n.bounds);return n.size[0]=n.size[1]=0,this._index.remove(n),n.set(e,t,i,this._resolution,this._resolution*this._metersPerUnit,this._tileInfoView.spatialReference),i&&this._index.insert(n),{oldBounds:s,newBounds:n.bounds}},_.updateLevel=function(e){if(this._currentLevel===e)return;this._currentLevel=e;const t=this._tileInfoView,i=t.getTileResolution(e);this._resolution=i,this._index.clear();const r=this._itemByGraphic,n=[];for(const[s,o]of r)o.updateBounds(this._resolution,this._resolution*this._metersPerUnit,t.spatialReference),o.geometry&&n.push(o);this._index.load(n)},_.clear=function(){this._itemByGraphic.clear(),this._index.clear()},_._createTileGraphics=function(e,t,i,r,n){const s=this._uidFieldName,o=this._tileInfoView.spatialReference,{bounds:a}=n;let u,c,l,m;i.sort(((e,t)=>e.zorder-t.zorder));for(let p=0;p<i.length;p++){l=i[p],u=l.graphic,c=l.getGeometryQuantized(r,a,o),m=0===p?-1:i[p-1].graphic.uid;const n={...l.graphic.attributes};n[s]=u.uid,null==l.groupId&&(l.groupId=t.createTemplateGroup(l.symbol,null)),e.push({centroid:h.getCentroidQuantized(l,r),geometry:c,attributes:n,symbol:l.symbol,groupId:l.groupId,insertAfter:m,zorder:l.zorder})}},_._searchForItems=function(e){const t=this._tileInfoView.spatialReference,i=e.bounds;if(t.isWrappable){const[n,s]=u.getSpatialReferenceMinMaxX(t),o=Math.abs(i[2]-s)<g,a=Math.abs(i[0]-n)<g;if((!o||!a)&&(o||a)){const t=e.resolution;let a;a=o?r.create([n,i[1],n+t*m.PIXEL_BUFFER,i[3]]):r.create([s-t*m.PIXEL_BUFFER,i[1],s,i[3]]);const u=f(this._index,i[0],i[1],i[2],i[3]),c=f(this._index,a[0],a[1],a[2],a[3]);return[...new Set([...u,...c])]}}return f(this._index,i[0],i[1],i[2],i[3])},p}()}));
