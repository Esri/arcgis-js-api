/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../../../../core/has","../../../../geometry/support/spatialReferenceUtils","../../../../geometry/support/contains","../../../../geometry/support/extentUtils","../../../../geometry/support/jsonUtils","../../../../core/screenUtils","../../../../core/unitUtils","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/normalizeUtilsCommon","../../../../geometry/support/normalizeUtils","./graphicsUtils","../../../../chunks/rbush","./GraphicStoreItem"],(function(e,t,i,r,s,o,n,a,u,c,l,h,m){"use strict";const p={minX:0,minY:0,maxX:0,maxY:0},d=a.create(),g=[],y=1e-5;function f(e,t,i,r,s){return p.minX=t,p.minY=i,p.maxX=r,p.maxY=s,e.search(p)}return function(){function p(i,r,s,o,a,u){this._graphics=o,this._onAdd=a,this._onRemove=u,this._index=h.rbush(9,e("csp-restrictions")?e=>({minX:e.bounds[0],minY:e.bounds[1],maxX:e.bounds[2],maxY:e.bounds[3]}):[".bounds[0]",".bounds[1]",".bounds[2]",".bounds[3]"]),this._itemByGraphic=new Map,this._currentLevel=-1/0,this._tileInfoView=i,this._uidFieldName=s;const c=i.getClosestInfoForScale(r);c&&(this._currentLevel=c.level,this._resolution=this._tileInfoView.getTileResolution(c.level));const l=i.spatialReference;this._metersPerUnit=t.isValid(l)?n.getMetersPerUnit(i.spatialReference):1}var _=p.prototype;return _.hitTest=function(e,t,n,u,h){e=c.normalizeMapX(e,this._tileInfoView.spatialReference);const m=.5*u*n;d[0]=e-m,d[1]=t-m,d[2]=e+m,d[3]=t+m;const p=.5*u*(n+l.PIXEL_BUFFER),g=f(this._index,e-p,t-p,e+p,t+p);if(!g||0===g.length)return[];const y={x:e,y:t},_=[];let b;for(const c of g)if(c.graphic.visible)switch(s.getJsonType(c.geometry)){case"esriGeometryPoint":{const e=c.symbol;if(!e)continue;const t=c.geometry,{x:r,y:s}=t,o=u*this._metersPerUnit;let n;switch(e.type){case"esriTS":n=l.getTextSymbolBounds(r,s,e,c.size,u,h);break;case"expanded-cim":n=l.getCIMMarkerBounds(r,s,e,u,o,h);break;case"esriSMS":case"esriPMS":n=l.getMarkerSymbolBounds(r,s,e,u,o,h)}i.polygonContainsPoint(n,y)&&_.push(c)}break;case"esriGeometryPolyline":{const i=c.symbol;if(!i||!i.layers.length)continue;const r=i.layers[0];b=1.5*u*window.devicePixelRatio*o.pt2px(r.width),l.isPointOnPolyline(c.geometry,e,t,b)&&_.push(c)}break;case"esriGeometryEnvelope":{const e=c.geometry,t=a.fromValues(e.xmin,e.ymin,e.xmax,e.ymax);a.intersects(t,d)&&_.push(c);break}case"esriGeometryPolygon":{if(i.polygonContainsPoint(c.geometry,y)){_.push(c);break}const e=r.getPolygonExtent(c.geometry);if(Math.abs(e.ymax-e.ymin)<5*u||Math.abs(e.xmax-e.xmin)<5*u){const t=a.fromValues(e.xmin,e.ymin,e.xmax,e.ymax);a.intersects(t,d)&&_.push(c)}break}case"esriGeometryMultipoint":{const e=c.symbol;if(!e)continue;const t=c.geometry.points;let r;for(let s=0;s<t.length;s++)if(r="esriTS"===e.type?l.getTextSymbolBounds(t[s][0],t[s][1],e,c.size,u,h):l.getMarkerSymbolBounds(t[s][0],t[s][1],e,u,u*this._metersPerUnit,h),i.polygonContainsPoint(r,y)){_.push(c);break}break}}return _.sort(((e,t)=>{const i=l.graphicGeometryToNumber(e.graphic),r=l.graphicGeometryToNumber(t.graphic);return i===r?t.zorder-e.zorder:i-r})),_.map((e=>e.graphic))},_.getGraphicsData=function(e,t,i){const r=this._searchForItems(t);if(0===r.length||0===i.length)return[];r.sort(((e,t)=>e.zorder-t.zorder)),r[0].insertAfter=-1;for(let c=1;c<r.length;c++)r[c].insertAfter=r[c-1].graphic.uid;r.sort(((e,t)=>e.graphic.uid-t.graphic.uid)),i.sort(((e,t)=>e.uid-t.uid));let s,o=0,n=0;const a=[],u={originPosition:"upperLeft",scale:[t.resolution,t.resolution],translate:[t.bounds[0],t.bounds[3]]};for(const c of i){for(n=-2;o<r.length;)if(s=r[o],o++,c.uid===s.graphic.uid){n=s.insertAfter;break}if(!s.geometry||-2===n)continue;const t=s.getGeometryQuantized(u),i={...s.graphic.attributes};i[this._uidFieldName]=c.uid,null==s.groupId&&(s.groupId=e.createTemplateGroup(s.symbol,null)),a.push({centroid:m.getCentroidQuantized(s,u),geometry:t,attributes:i,symbol:s.symbol,groupId:s.groupId,insertAfter:n,zorder:s.zorder})}return a.sort(((e,t)=>e.zorder-t.zorder)),a},_.queryTileData=function(e,t){const{bounds:i,resolution:r}=t,s=this._searchForItems(t),o=[];return this._createTileGraphics(o,e,s,{originPosition:"upperLeft",scale:[r,r],translate:[i[0],i[3]]}),o},_.has=function(e){return this._itemByGraphic.has(e)},_.getBounds=function(e){return this._itemByGraphic.has(e)?this._itemByGraphic.get(e).bounds:null},_.addOrModify=function(e,t,i){if(!e)return;this.has(e)&&this.remove(e),this._onAdd(e);const r=m.acquire(e,t,i,this._resolution,this._resolution*this._metersPerUnit,this._tileInfoView.spatialReference);return this._itemByGraphic.set(e,r),i&&this._index.insert(r),r.bounds},_.remove=function(e){if(!this._itemByGraphic.has(e))return;this._onRemove(e);const t=this._itemByGraphic.get(e);this._index.remove(t),this._itemByGraphic.delete(e)},_.updateZ=function(){const e=this._graphics.items;let t,i;for(let r=0;r<e.length;r++)i=e[r],t=this._itemByGraphic.get(i),t&&(t.zorder=r)},_.update=function(e,t,i){const r=this._itemByGraphic.get(e);r.groupId=null;const s=a.clone(r.bounds);return r.size[0]=r.size[1]=0,this._index.remove(r),r.set(e,t,i,this._resolution,this._resolution*this._metersPerUnit,this._tileInfoView.spatialReference),i&&this._index.insert(r),{oldBounds:s,newBounds:r.bounds}},_.updateLevel=function(e){if(this._currentLevel===e)return;this._currentLevel=e;const t=this._tileInfoView.getTileResolution(e);this._resolution=t,this._index.clear(),g.length=0,this._itemByGraphic.forEach((e=>{e.updateBounds(this._resolution,this._resolution*this._metersPerUnit,this._tileInfoView.spatialReference),e.geometry&&g.push(e)})),this._index.load(g)},_.clear=function(){this._itemByGraphic.clear(),this._index.clear()},_._createTileGraphics=function(e,t,i,r){const s=this._uidFieldName;let o,n,a,u;i.sort(((e,t)=>e.zorder-t.zorder));for(let c=0;c<i.length;c++){a=i[c],o=a.graphic,n=a.getGeometryQuantized(r),u=0===c?-1:i[c-1].graphic.uid;const l={...a.graphic.attributes};l[s]=o.uid,null==a.groupId&&(a.groupId=t.createTemplateGroup(a.symbol,null)),e.push({centroid:m.getCentroidQuantized(a,r),geometry:n,attributes:l,symbol:a.symbol,groupId:a.groupId,insertAfter:u,zorder:a.zorder})}},_._searchForItems=function(e){const t=this._tileInfoView.spatialReference,i=e.bounds;if(t.isWrappable){const[r,s]=u.getSpatialReferenceMinMaxX(t),o=Math.abs(i[2]-s)<y,n=Math.abs(i[0]-r)<y;if((!o||!n)&&(o||n)){const t=e.resolution;let n;n=o?a.create([r,i[1],r+t*l.PIXEL_BUFFER,i[3]]):a.create([s-t*l.PIXEL_BUFFER,i[1],s,i[3]]);const u=f(this._index,i[0],i[1],i[2],i[3]),c=f(this._index,n[0],n[1],n[2],n[3]);return[...new Set([...u,...c])]}}return f(this._index,i[0],i[1],i[2],i[3])},p}()}));
