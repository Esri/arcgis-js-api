/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["../../../../core/has","../../../../core/screenUtils","../../../../core/unitUtils","../../../../chunks/rbush","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/contains","../../../../geometry/support/extentUtils","../../../../geometry/support/jsonUtils","../../../../geometry/support/normalizeUtils","../../../../geometry/support/normalizeUtilsCommon","../../../../geometry/support/spatialReferenceUtils","../../../../symbols/cim/utils","./GraphicStoreItem","./graphicsUtils"],(function(e,t,i,r,s,n,o,a,u,c,l,h,d,m){"use strict";const p={minX:0,minY:0,maxX:0,maxY:0},g=s.create(),y=1e-5;function f(e,t,i,r,s){return p.minX=t,p.minY=i,p.maxX=r,p.maxY=s,e.search(p)}return function(){function p(t,s,n,o,a,u){this._graphics=o,this._onAdd=a,this._onRemove=u,this._index=r.rbush(9,e("csp-restrictions")?e=>({minX:e.bounds[0],minY:e.bounds[1],maxX:e.bounds[2],maxY:e.bounds[3]}):[".bounds[0]",".bounds[1]",".bounds[2]",".bounds[3]"]),this._itemByGraphic=new Map,this._currentLevel=-1/0,this._tileInfoView=t,this._uidFieldName=n;const c=t.getClosestInfoForScale(s);c&&(this._currentLevel=c.level,this._resolution=this._tileInfoView.getTileResolution(c.level));const h=t.spatialReference;this._metersPerUnit=l.isValid(h)?i.getMetersPerUnit(t.spatialReference):1}var _=p.prototype;return _.hitTest=function(e,i,r,c,l){e=u.normalizeMapX(e,this._tileInfoView.spatialReference);const d=.5*c*r;g[0]=e-d,g[1]=i-d,g[2]=e+d,g[3]=i+d;const p=.5*c*(r+m.PIXEL_BUFFER),y=f(this._index,e-p,i-p,e+p,i+p);if(!y||0===y.length)return[];const _={x:e,y:i},b=[];let x;for(const u of y)if(u.graphic.visible)switch(a.getJsonType(u.geometry)){case"esriGeometryPoint":{const e=u.symbol;if(!e)continue;const t=u.geometry,{x:i,y:r}=t,s=c*this._metersPerUnit;let o;switch(e.type){case"esriTS":o=m.getTextSymbolBounds(i,r,e,u.size,c,l);break;case"expanded-cim":o=m.getCIMMarkerBounds(i,r,e,c,s,l);break;case"esriSMS":case"esriPMS":o=m.getMarkerSymbolBounds(i,r,e,c,s,l)}n.polygonContainsPoint(o,_)&&b.push(u)}break;case"esriGeometryPolyline":{const r=u.symbol;let s=0;if("expanded-cim"===r.type){const e=r.layers;if(!e||0===e.length)continue;const t=e.findIndex((e=>"line"===e.type));if(-1===t)continue;const i=e[t];s=h.evaluateValueOrFunction(i.width,null,null)}else{const e=r.layers;if(!e||0===e.length)continue;s=e[0].width}x=1.5*c*window.devicePixelRatio*t.pt2px(s),m.isPointOnPolyline(u.geometry,e,i,x)&&b.push(u)}break;case"esriGeometryEnvelope":{const e=u.geometry,t=s.fromValues(e.xmin,e.ymin,e.xmax,e.ymax);s.intersects(t,g)&&b.push(u);break}case"esriGeometryPolygon":{if(n.polygonContainsPoint(u.geometry,_)){b.push(u);break}const e=o.getPolygonExtent(u.geometry);if(Math.abs(e.ymax-e.ymin)<5*c||Math.abs(e.xmax-e.xmin)<5*c){const t=s.fromValues(e.xmin,e.ymin,e.xmax,e.ymax);s.intersects(t,g)&&b.push(u)}break}case"esriGeometryMultipoint":{const e=u.symbol;if(!e)continue;const t=u.geometry.points;let i;for(let r=0;r<t.length;r++)if(i="esriTS"===e.type?m.getTextSymbolBounds(t[r][0],t[r][1],e,u.size,c,l):m.getMarkerSymbolBounds(t[r][0],t[r][1],e,c,c*this._metersPerUnit,l),n.polygonContainsPoint(i,_)){b.push(u);break}break}}return b.sort(((e,t)=>{const i=m.graphicGeometryToNumber(e.graphic),r=m.graphicGeometryToNumber(t.graphic);return i===r?t.zorder-e.zorder:i-r})),b.map((e=>e.graphic))},_.getGraphicsData=function(e,t,i){const r=this._searchForItems(t);if(0===r.length||0===i.length)return[];r.sort(((e,t)=>e.zorder-t.zorder)),r[0].insertAfter=-1;for(let c=1;c<r.length;c++)r[c].insertAfter=r[c-1].graphic.uid;r.sort(((e,t)=>e.graphic.uid-t.graphic.uid)),i.sort(((e,t)=>e.uid-t.uid));let s,n=0,o=0;const a=[],u={originPosition:"upperLeft",scale:[t.resolution,t.resolution],translate:[t.bounds[0],t.bounds[3]]};for(const c of i){for(o=-2;n<r.length;)if(s=r[n],n++,c.uid===s.graphic.uid){o=s.insertAfter;break}if(!s.geometry||-2===o)continue;const i=s.getGeometryQuantized(u,t.bounds),l={...s.graphic.attributes};l[this._uidFieldName]=c.uid,null==s.groupId&&(s.groupId=e.createTemplateGroup(s.symbol,null)),a.push({centroid:d.getCentroidQuantized(s,u),geometry:i,attributes:l,symbol:s.symbol,groupId:s.groupId,insertAfter:o,zorder:s.zorder})}return a.sort(((e,t)=>e.zorder-t.zorder)),a},_.queryTileData=function(e,t){const{bounds:i,resolution:r}=t,s=this._searchForItems(t),n=[];return 0===s.length||this._createTileGraphics(n,e,s,{originPosition:"upperLeft",scale:[r,r],translate:[i[0],i[3]]},t.bounds),n},_.has=function(e){return this._itemByGraphic.has(e)},_.getBounds=function(e){return this._itemByGraphic.has(e)?this._itemByGraphic.get(e).bounds:null},_.addOrModify=function(e,t,i){if(!e)return;this.has(e)&&this.remove(e),this._onAdd(e);const r=d.acquire(e,t,i,this._resolution,this._resolution*this._metersPerUnit,this._tileInfoView.spatialReference);return this._itemByGraphic.set(e,r),i&&this._index.insert(r),r.bounds},_.remove=function(e){if(!this._itemByGraphic.has(e))return;this._onRemove(e);const t=this._itemByGraphic.get(e);this._index.remove(t),this._itemByGraphic.delete(e)},_.updateZ=function(){const e=this._graphics.items;let t,i;for(let r=0;r<e.length;r++)i=e[r],t=this._itemByGraphic.get(i),t&&(t.zorder=r)},_.update=function(e,t,i){const r=this._itemByGraphic.get(e);r.groupId=null;const n=s.clone(r.bounds);return r.size[0]=r.size[1]=0,this._index.remove(r),r.set(e,t,i,this._resolution,this._resolution*this._metersPerUnit,this._tileInfoView.spatialReference),i&&this._index.insert(r),{oldBounds:n,newBounds:r.bounds}},_.updateLevel=function(e){if(this._currentLevel===e)return;this._currentLevel=e;const t=this._tileInfoView,i=t.getTileResolution(e);this._resolution=i,this._index.clear();const r=this._itemByGraphic,s=[];for(const[n,o]of r)o.updateBounds(this._resolution,this._resolution*this._metersPerUnit,t.spatialReference),o.geometry&&s.push(o);this._index.load(s)},_.clear=function(){this._itemByGraphic.clear(),this._index.clear()},_._createTileGraphics=function(e,t,i,r,s){const n=this._uidFieldName;let o,a,u,c;i.sort(((e,t)=>e.zorder-t.zorder));for(let l=0;l<i.length;l++){u=i[l],o=u.graphic,a=u.getGeometryQuantized(r,s),c=0===l?-1:i[l-1].graphic.uid;const h={...u.graphic.attributes};h[n]=o.uid,null==u.groupId&&(u.groupId=t.createTemplateGroup(u.symbol,null)),e.push({centroid:d.getCentroidQuantized(u,r),geometry:a,attributes:h,symbol:u.symbol,groupId:u.groupId,insertAfter:c,zorder:u.zorder})}},_._searchForItems=function(e){const t=this._tileInfoView.spatialReference,i=e.bounds;if(t.isWrappable){const[r,n]=c.getSpatialReferenceMinMaxX(t),o=Math.abs(i[2]-n)<y,a=Math.abs(i[0]-r)<y;if((!o||!a)&&(o||a)){const t=e.resolution;let a;a=o?s.create([r,i[1],r+t*m.PIXEL_BUFFER,i[3]]):s.create([n-t*m.PIXEL_BUFFER,i[1],n,i[3]]);const u=f(this._index,i[0],i[1],i[2],i[3]),c=f(this._index,a[0],a[1],a[2],a[3]);return[...new Set([...u,...c])]}}return f(this._index,i[0],i[1],i[2],i[3])},p}()}));
