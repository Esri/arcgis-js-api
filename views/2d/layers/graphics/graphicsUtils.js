/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../../../core/has","../../../../core/maybe","../../../../core/screenUtils","../../../../chunks/mat2d","../../../../chunks/mat2df32","../../../../chunks/vec2","../../../../chunks/vec2f32","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/boundsUtils","../../../../geometry/support/jsonUtils","../../../../geometry/support/normalizeUtils","../../../../geometry/support/normalizeUtilsCommon","../../../../geometry/support/spatialReferenceUtils","../../../../symbols/cim/CIMSymbolHelper","../../engine/webgl/alignmentUtils","../../engine/webgl/mesh/templates/shapingUtils","../../engine/webgl/util/BidiText"],(function(t,e,s,n,r,a,o,i,c,l,p,m,h,u,f,g,y,d){"use strict";const M=Math.PI/180,x=.04,b=a.create(),S=i.create(),w=512,I=50;function k(t,e){if(!e.isWrappable)return null;const[s,n]=h.getSpatialReferenceMinMaxX(e);return t[2]>n?[c.create([t[0],t[1],n,t[3]]),c.create([s,t[1],s+t[2]-n,t[3]])]:t[0]<s?[c.create([s,t[1],t[2],t[3]]),c.create([n-(s-t[0]),t[1],n,t[3]])]:null}function P(t,e,s,n,r,a,o){if(!n||!s.symbol)return t[0]=t[1]=t[2]=t[3]=0,e[0]=e[1]=e[2]=e[3]=0,t;const i=n;if(!p.isPoint(i)){l.getBoundsXY(t,i);let n=e[0];0===n&&(n=O(s),e[0]=n);const a=r*n/2;return t[0]-=a,t[1]-=a,t[2]+=a,t[3]+=a,t}{const n=i.x,c=i.y;"esriTS"===s.symbol.type&&0===e[2]&&0===e[3]&&W(e,s.symbol,s.mosaicItem),_(t,n,c,s.symbol,e,r,a,o)}return t}function T(t){return"text"===t||"esriTS"===t}function z(t){return"simple-marker"===t||"picture-marker"===t||"esriSMS"===t||"esriPMS"===t}function U(t){switch(s.unwrap(t.geometry).type){case"point":case"multipoint":return 0;case"polyline":return 1;case"polygon":case"extent":return 2}return 0}const v=i.create(),B=i.create(),C=i.create(),A=i.create(),E=i.create(),H=i.create(),X=i.create();function q(t,e,s,n){o.set(C,e,s);const r=t.paths;let a,i,c,l,p,m,h,u,f,g=1/0;for(let y=0;y<r.length;y++){const t=r[y];if(!(t.length<2))for(let r=1;r<t.length;r++)a=t[r-1][0],c=t[r-1][1],i=t[r][0],l=t[r][1],p=Math.min(a,i)-n,m=Math.min(c,l)-n,h=Math.max(a,i)+n,u=Math.max(c,l)+n,e<p||e>h||s<m||s>u||(o.set(v,a,c),o.set(B,i,l),o.subtract(A,B,v),o.subtract(E,v,C),o.scale(H,A,o.dot(A,E)/o.dot(A,A)),o.subtract(X,E,H),f=o.dot(X,X),g>f&&(g=f))}return Math.sqrt(g)<=n}function R(t,e,s,a,i,c){let l,p;const m=n.pt2px(s.xoffset),h=n.pt2px(s.yoffset),u=M*s.angle,f=M*c;switch(s.type){case"esriSMS":l=p=n.pt2px(s.size);break;case"esriPMS":l=n.pt2px(s.width),p=n.pt2px(s.height)}i<x&&(a=x*a/i);const g=r.identity(b);r.translate(g,g,o.set(S,t,e)),r.rotate(g,g,f-u),r.scale(g,g,o.set(S,a,-a)),r.translate(g,g,o.set(S,m,-h));const y=[0,0];o.transformMat2d(y,o.set(S,-.5*l,-.5*p),g);const d=[0,0];o.transformMat2d(d,o.set(S,-.5*l,.5*p),g);const w=[0,0];o.transformMat2d(w,o.set(S,.5*l,-.5*p),g);const I=[0,0];return o.transformMat2d(I,o.set(S,.5*l,.5*p),g),{rings:[[y,w,I,d,y]]}}function F(t,e,s,a,i,c){const l=f.CIMSymbolHelper.getEnvelope(s.data);if(!l)return null;i<x&&(a=x*a/i);const p=n.pt2px(l.width),m=n.pt2px(l.height),h=n.pt2px(l.x),u=n.pt2px(l.y),g=0*M,y=M*c,d=r.identity(b);r.translate(d,d,o.set(S,t,e)),r.rotate(d,d,y-g),r.scale(d,d,o.set(S,a,a));const w=[0,0];o.transformMat2d(w,o.set(S,h,u+m),d);const I=[0,0];o.transformMat2d(I,o.set(S,h,u),d);const k=[0,0];o.transformMat2d(k,o.set(S,h+p,u+m),d);const P=[0,0];return o.transformMat2d(P,o.set(S,h+p,u),d),{rings:[[w,k,P,I,w]]}}function L(t,e,s,a,i,c){const l=n.pt2px(s.xoffset),p=n.pt2px(s.yoffset),m=M*s.angle,h=M*c,u=r.identity(b);r.translate(u,u,o.set(S,t,e)),r.rotate(u,u,h),r.scale(u,u,o.set(S,i,-i));const f=a[0]+a[2]/2,g=a[1]+a[3]/2;r.translate(u,u,o.set(S,l,-p)),r.translate(u,u,o.set(S,f,g)),r.rotate(u,u,m),r.translate(u,u,o.set(S,-f,-g));const y=[0,0];o.transformMat2d(y,o.set(S,a[0],a[1]),u);const d=[0,0];o.transformMat2d(d,o.set(S,a[0],a[1]+a[3]),u);const x=[0,0];o.transformMat2d(x,o.set(S,a[0]+a[2],a[1]),u);const w=[0,0];return o.transformMat2d(w,o.set(S,a[0]+a[2],a[1]+a[3]),u),{rings:[[y,x,w,d,y]]}}function O(t){switch(t.symbol.type){case"esriSFS":case"esriPFS":{const e=t.symbol.outline;return e?e.width:0}case"esriSLS":return n.pt2px(t.symbol.width);case"esriSMS":{const e=t.symbol,s=n.pt2px(e.xoffset),r=n.pt2px(e.yoffset);return n.pt2px(e.size)+Math.sqrt(s*s+r*r)}case"esriPMS":{const e=t.symbol,s=n.pt2px(e.xoffset),r=n.pt2px(e.yoffset);return n.pt2px(Math.max(e.width,e.height))+Math.sqrt(s*s+r*r)}case"esriTS":{const e=[0,0,0,0];W(e,t.symbol,t.mosaicItem);const s=Math.max(Math.abs(e[0]),Math.abs(e[1]));return Math.max(e[2],e[3])+s}case"expanded-cim":{const e=f.CIMSymbolHelper.getEnvelope(t.symbol.data);return e.width!==-1/0&&e.height!==-1/0||(e.width=10,e.height=10,e.x=0,e.y=0),n.pt2px(Math.sqrt(e.width*e.width+e.height*e.height))}case"composite-symbol":{if(!t.symbol.layers.length)return 0;const e=t.symbol.layers.length-1;return O({symbol:t.symbol.layers[e],mosaicItem:null})}default:return 0}}function W(t,e,s){if(!s||0===s.glyphMosaicItems.length)return t;const r=d.bidiText(e.text)[1],a=s.glyphMosaicItems,o=y.shapeGlyphs(a,r,{scale:n.pt2px(e.font.size)/24,angle:e.angle,xOffset:e.xoffset,yOffset:e.yoffset,hAlign:g.getXAnchorDirection(e.horizontalAlignment||"center"),vAlign:g.getYAnchorDirection(e.verticalAlignment||"baseline"),maxLineWidth:Math.max(32,Math.min(e.lineWidth||512,512)),lineHeight:30*Math.max(.25,Math.min(e.lineHeight||1,4)),decoration:e.font.decoration||"none",isCIM:!1}).bounds;return t[0]=n.pt2px(o.x-o.halfWidth),t[1]=n.pt2px(o.y-o.halfHeight),t[2]=n.pt2px(o.width),t[3]=n.pt2px(o.height),t}function _(t,e,s,n,r,a,o,i){let c;switch(n.type){case"esriSMS":case"esriPMS":c=R(e,s,n,a,o,0);break;case"esriTS":c=L(e,s,n,r,a,0);break;case"cim":case"CIMSymbolReference":case"expanded-cim":c=F(e,s,n,a,o,0)}let l,p,h=0;for(let m=0;m<c.rings[0].length-1;m++)p=c.rings[0][m],l=(e-p[0])*(e-p[0])+(s-p[1])*(s-p[1]),h=Math.max(h,l);h=Math.sqrt(h);let f=m.normalizeMapX(e-h,i),g=m.normalizeMapX(e+h,i);if(f>g){const t=u.getInfo(i);if(t){const[e,s]=t.valid;f=e,g=s}}return t[0]=f,t[1]=s-h,t[2]=g,t[3]=s+h,t}t.PIXEL_BUFFER=I,t.TILE_SIZE=w,t.getBounds=P,t.getCIMMarkerBounds=F,t.getMarkerSymbolBounds=R,t.getTextSymbolBounds=L,t.getTextSymbolSize=W,t.graphicGeometryToNumber=U,t.intersectingInternationalDateline=k,t.isMarkerSymbol=z,t.isPointOnPolyline=q,t.isTextSymbol=T,Object.defineProperty(t,"__esModule",{value:!0})}));
