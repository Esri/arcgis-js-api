// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","../../../../core/has","../../../../core/maybe","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/mat2d","../../../../core/libs/gl-matrix-2/mat2df32","../../../../core/libs/gl-matrix-2/vec2","../../../../core/libs/gl-matrix-2/vec2f32","../../../../geometry/SpatialReference","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/boundsUtils","../../../../geometry/support/intersects","../../../../geometry/support/jsonUtils","../../../../geometry/support/normalizeUtils","../../../../geometry/support/spatialReferenceUtils","../../../../geometry/support/spatialReferenceUtils","../../../../symbols/cim/CIMSymbolHelper","../../engine/webgl/alignmentUtils","../../engine/webgl/mesh/templates/shapingUtils","../../engine/webgl/util/BidiText"],(function(e,t,r,a,n,i,s,m,o,c,l,u,x,f,v,p,h,y,d,g,M){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getTextSymbolSize=t.normalizeCentralMeridian=t.getTextSymbolBounds=t.getCIMMarkerBounds=t.getMarkerSymbolBounds=t.isPointOnPolyline=t.graphicGeometryToNumber=t.isMarkerSymbol=t.getBounds=void 0;var b=Math.PI/180,S=s.mat2df32.create(),I=o.vec2f32.create(),P=l.create();t.getBounds=function(e,t,a,n,i,s,m){if(!n||!a.symbol)return e[0]=e[1]=e[2]=e[3]=0,t[0]=t[1]=t[2]=t[3]=0,e;var o=n;if(!f.isPoint(o)){u.getBoundsXY(e,o);var c=t[0];0===c&&(c=function e(t){switch(t.symbol.type){case"esriSFS":case"esriPFS":var a=t.symbol.outline;return a?a.width:0;case"esriSLS":return t.symbol.width;case"esriSMS":return t.symbol.size;case"esriPMS":return Math.max(t.symbol.width,t.symbol.height);case"esriTS":var n=[0,0,0,0];O(n,t.symbol,t.mosaicItem);var i=Math.max(Math.abs(n[0]),Math.abs(n[1]));return Math.max(n[2],n[3])+i;case"expanded-cim":var s=y.CIMSymbolHelper.getEnvelope(t.symbol.data);return Math.sqrt(s.width*s.width+s.height*s.height);case"composite-symbol":if(!t.symbol.layers.length)return 0;var m=t.symbol.layers.length-1;return e({symbol:t.symbol.layers[m],mosaicItem:null});case"label":default:return r("esri-2d-debug")&&console.debug("Resource of type "+t.symbol.type+" not valid for graphics"),0}}(a),t[0]=c);var l=i*c/2;return e[0]-=l,e[1]-=l,e[2]+=l,e[3]+=l,e}var x=o.x,p=o.y;return"esriTS"===a.symbol.type&&0===t[2]&&0===t[3]&&O(t,a.symbol,a.mosaicItem),function(e,t,r,a,n,i,s,m){var o;switch(a.type){case"esriSMS":case"esriPMS":o=C(t,r,a,i,s,0);break;case"esriTS":o=L(t,r,a,n,i,0);break;case"cim":case"CIMSymbolReference":case"expanded-cim":o=A(t,r,a,i,s,0)}for(var c,l,u=0,x=0;x<o.rings[0].length-1;x++)l=o.rings[0][x],c=(t-l[0])*(t-l[0])+(r-l[1])*(r-l[1]),u=Math.max(u,c);u=Math.sqrt(u);var f=v.normalizeMapX(t-u,m),p=v.normalizeMapX(t+u,m);if(f>p){var y=h.getInfo(m);if(y){var d=y.valid,g=d[0],M=d[1];f=g,p=M}}e[0]=f,e[1]=r-u,e[2]=p,e[3]=r+u}(e,x,p,a.symbol,t,i,s,m),e},t.isMarkerSymbol=function(e){return"simple-marker"===e||"picture-marker"===e||"text"===e},t.graphicGeometryToNumber=function(e){switch(a.unwrap(e.geometry).type){case"point":case"multipoint":return 0;case"polyline":return 1;case"polygon":case"extent":return 2}return 0};var w=o.vec2f32.create(),B=o.vec2f32.create(),k=o.vec2f32.create(),z=o.vec2f32.create(),R=o.vec2f32.create(),T=o.vec2f32.create(),X=o.vec2f32.create();function C(e,t,r,a,s,o){var c,l,u=n.pt2px(r.xoffset),x=n.pt2px(r.yoffset),f=b*r.angle,v=b*o;switch(r.type){case"esriSMS":c=l=n.pt2px(r.size);break;case"esriPMS":c=n.pt2px(r.width),l=n.pt2px(r.height)}s<.04&&(a=.04*a/s);var p=i.mat2d.identity(S);i.mat2d.translate(p,p,m.vec2.set(I,e,t)),i.mat2d.rotate(p,p,v-f),i.mat2d.scale(p,p,m.vec2.set(I,a,-a)),i.mat2d.translate(p,p,m.vec2.set(I,u,-x));var h=[0,0];m.vec2.transformMat2d(h,m.vec2.set(I,-.5*c,-.5*l),p);var y=[0,0];m.vec2.transformMat2d(y,m.vec2.set(I,-.5*c,.5*l),p);var d=[0,0];m.vec2.transformMat2d(d,m.vec2.set(I,.5*c,-.5*l),p);var g=[0,0];return m.vec2.transformMat2d(g,m.vec2.set(I,.5*c,.5*l),p),{rings:[[h,d,g,y,h]]}}function A(e,t,r,a,s,o){var c=y.CIMSymbolHelper.getEnvelope(r.data);if(!c)return null;s<.04&&(a=.04*a/s);var l=n.pt2px(c.width),u=n.pt2px(c.height),x=n.pt2px(c.x),f=n.pt2px(c.y),v=0*b,p=b*o,h=i.mat2d.identity(S);i.mat2d.translate(h,h,m.vec2.set(I,e,t)),i.mat2d.rotate(h,h,p-v),i.mat2d.scale(h,h,m.vec2.set(I,a,a));var d=[0,0];m.vec2.transformMat2d(d,m.vec2.set(I,x,f+u),h);var g=[0,0];m.vec2.transformMat2d(g,m.vec2.set(I,x,f),h);var M=[0,0];m.vec2.transformMat2d(M,m.vec2.set(I,x+l,f+u),h);var P=[0,0];return m.vec2.transformMat2d(P,m.vec2.set(I,x+l,f),h),{rings:[[d,M,P,g,d]]}}function L(e,t,r,a,s,o){var c=n.pt2px(r.xoffset),l=n.pt2px(r.yoffset),u=b*r.angle,x=b*o,f=i.mat2d.identity(S);i.mat2d.translate(f,f,m.vec2.set(I,e,t)),i.mat2d.rotate(f,f,x),i.mat2d.scale(f,f,m.vec2.set(I,s,-s));var v=a[0]+a[2]/2,p=a[1]+a[3]/2;i.mat2d.translate(f,f,m.vec2.set(I,c,-l)),i.mat2d.translate(f,f,m.vec2.set(I,v,p)),i.mat2d.rotate(f,f,u),i.mat2d.translate(f,f,m.vec2.set(I,-v,-p));var h=[0,0];m.vec2.transformMat2d(h,m.vec2.set(I,a[0],a[1]),f);var y=[0,0];m.vec2.transformMat2d(y,m.vec2.set(I,a[0],a[1]+a[3]),f);var d=[0,0];m.vec2.transformMat2d(d,m.vec2.set(I,a[0]+a[2],a[1]),f);var g=[0,0];return m.vec2.transformMat2d(g,m.vec2.set(I,a[0]+a[2],a[1]+a[3]),f),{rings:[[h,d,g,y,h]]}}function O(e,t,r){if(!r||0===r.glyphMosaicItems.length)return e;var a=M.bidiText(t.text)[1],i=r.glyphMosaicItems,s=g.shapeGlyphs(i,a,{scale:n.pt2px(t.font.size)/24,angle:t.angle,xOffset:t.xoffset,yOffset:t.yoffset,hAlign:d.getXAnchorDirection(t.horizontalAlignment||"center"),vAlign:d.getYAnchorDirection(t.verticalAlignment||"baseline"),maxLineWidth:Math.max(32,Math.min(t.lineWidth||512,512)),lineHeight:30*Math.max(.25,Math.min(t.lineHeight||1,4)),decoration:t.font.decoration||"none",isCIM:!1}).bounds;return e[0]=s.x-s.halfWidth,e[1]=s.y-s.halfHeight,e[2]=s.width,e[3]=s.height,e}t.isPointOnPolyline=function(e,t,r,a){m.vec2.set(k,t,r);for(var n,i,s,o,c,l,u,x,f,v=e.paths,p=1/0,h=0;h<v.length;h++){var y=v[h];if(!(y.length<2))for(var d=1;d<y.length;d++)n=y[d-1][0],s=y[d-1][1],i=y[d][0],o=y[d][1],c=Math.min(n,i)-a,l=Math.min(s,o)-a,u=Math.max(n,i)+a,x=Math.max(s,o)+a,t<c||t>u||r<l||r>x||(m.vec2.set(w,n,s),m.vec2.set(B,i,o),m.vec2.subtract(z,B,w),m.vec2.subtract(R,w,k),m.vec2.scale(T,z,m.vec2.dot(z,R)/m.vec2.dot(z,z)),m.vec2.subtract(X,R,T),p>(f=m.vec2.dot(X,X))&&(p=f))}return Math.sqrt(p)<=a},t.getMarkerSymbolBounds=C,t.getCIMMarkerBounds=A,t.getTextSymbolBounds=L,t.normalizeCentralMeridian=function(e){var t,r,a,n,i,s,m,o,c,l=null;if(!e)return null;if("mesh"===e.type)return e.toJSON();if(t=e.spatialReference,!(r=p.getInfo(t)))return e.toJSON();a=t.isWebMercator,n=U[s=a?102100:4326].maxX,i=U[s].minX,m=U[s].plus180Line,o=U[s].minus180Line;var v=e.toJSON();if(f.isPoint(v))c=q(v,n,i);else if(f.isMultipoint(v))v.points=v.points.map((function(e){return q(e,n,i)})),c=v;else if(f.isExtent(v))c=function(e,t){if(!t)return e;var r=function(e,t){var r,a=[],n=e.ymin,i=e.ymax,s=e.xmax-e.xmin,m=e.xmin,o=e.xmax,c=t.valid,l=c[0],u=c[1],x=(r=H(e.xmin,t)).x,f=r.frameId,v=(r=H(e.xmax,t)).x,p=r.frameId,h=x===v&&s>0;if(s>2*u){var y={xmin:m<o?x:v,ymin:n,xmax:u,ymax:i},d={xmin:l,ymin:n,xmax:m<o?v:x,ymax:i},g={xmin:0,ymin:n,xmax:u,ymax:i},M={xmin:l,ymin:n,xmax:0,ymax:i},b=[],S=[];G(y,g)&&b.push(f),G(y,M)&&S.push(f),G(d,g)&&b.push(p),G(d,M)&&S.push(p);for(var I=f+1;I<p;I++)b.push(I),S.push(I);a.push({extent:y,frameIds:[f]},{extent:d,frameIds:[p]},{extent:g,frameIds:b},{extent:M,frameIds:S})}else x>v||h?a.push({extent:{xmin:x,ymin:n,xmax:u,ymax:i},frameIds:[f]},{extent:{xmin:l,ymin:n,xmax:v,ymax:i},frameIds:[p]}):a.push({extent:{xmin:x,ymin:n,xmax:v,ymax:i},frameIds:[f]});return a}(e,t).map((function(e){return e.extent}));if(r.length<2)return r[0]||e;if(r.length>2)return e.xmin=t.valid[0],e.xmax=t.valid[1],e;return{rings:r.map((function(e){return[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]}))}}(v,r);else if(f.isPolygon(v)||f.isPolyline(v)){var h=P;u.getBoundsXY(h,v);var y={xmin:h[0],ymin:h[1],xmax:h[2],ymax:h[3]},d=W(y.xmin,i)*(2*n),g=0===d?v:function(e,t){for(var r=function(e){if(f.isPolygon(e))return e.rings;return e.paths}(e),a=0,n=r;a<n.length;a++)for(var i=n[a],s=0,m=i;s<m.length;s++){m[s][0]+=t}return e}(v,d);y.xmin+=d,y.xmax+=d,x.extentIntersectsPolyline(y,m)&&y.xmax!==n?l=g:x.extentIntersectsPolyline(y,o)&&y.xmin!==i?l=g:c=g}else c=e.clone();return null!==l?(new E).cut(l,n):c},t.getTextSymbolSize=O;var U={102100:{maxX:20037508.342788905,minX:-20037508.342788905,plus180Line:{paths:[[[20037508.342788905,-20037508.342788905],[20037508.342788905,20037508.342788905]]],spatialReference:c.WebMercator},minus180Line:{paths:[[[-20037508.342788905,-20037508.342788905],[-20037508.342788905,20037508.342788905]]],spatialReference:c.WebMercator}},4326:{maxX:180,minX:-180,plus180Line:{paths:[[[180,-180],[180,180]]],spatialReference:c.WGS84},minus180Line:{paths:[[[-180,-180],[-180,180]]],spatialReference:c.WGS84}}};function W(e,t){return Math.ceil((e-t)/(2*t))}function H(e,t){var r,a=t.valid,n=a[0],i=a[1],s=2*i,m=0;return e>i?(e-=(r=Math.ceil(Math.abs(e-i)/s))*s,m=r):e<n&&(e+=(r=Math.ceil(Math.abs(e-n)/s))*s,m=-r),{x:e,frameId:m}}function G(e,t){var r=t.xmin,a=t.ymin,n=t.xmax,i=t.ymax;return N(e,r,a)&&N(e,r,i)&&N(e,n,i)&&N(e,n,a)}function N(e,t,r){return t>=e.xmin&&t<=e.xmax&&r>=e.ymin&&r<=e.ymax}function q(e,t,r){var a;if(Array.isArray(e)){if((a=e[0])>t){var n=W(a,t);e[0]=a+n*(-2*t)}else if(a<r){n=W(a,r);e[0]=a+n*(-2*r)}}else if((a=e.x)>t){n=W(a,t);e.x+=n*(-2*t)}else if(a<r){n=W(a,r);e.x+=n*(-2*r)}return e}var E=function(){function e(){}return e.prototype.cut=function(e,t){var r;if(e.rings)this.closed=!0,r=e.rings,this.minPts=4;else{if(!e.paths)return null;this.closed=!1,r=e.paths,this.minPts=2}for(var a=r.length,n=-2*t,i=0;i<a;i++){var s=r[i];if(s&&s.length>=this.minPts){for(var m=[],o=0,c=s;o<c.length;o++){var l=c[o];m.push([l[0]+n,l[1]])}r.push(m)}}return this.closed?e.rings=r:e.paths=r,e},e}()}));