/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../core/has","../../../../core/maybe","../../../../geometry/support/spatialReferenceUtils","../../../../geometry/SpatialReference","../../../../geometry/support/intersects","../../../../geometry/support/boundsUtils","../../../../geometry/support/jsonUtils","../../../../core/screenUtils","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/normalizeUtils","../../../../chunks/vec2","../../../../chunks/mat2d","../../../../chunks/mat2df32","../../../../chunks/vec2f32","../../engine/webgl/alignmentUtils","../../engine/webgl/mesh/templates/shapingUtils","../../engine/webgl/util/BidiText","../../../../symbols/cim/CIMSymbolHelper"],(function(t,e,n,s,i,r,a,o,c,m,l,x,u,p,f,h,y,g,d){"use strict";const M=Math.PI/180,b=.04,S=p.create(),I=f.create(),P=m.create();const w=f.create(),k=f.create(),v=f.create(),X=f.create(),z=f.create(),R=f.create(),A=f.create();function B(t,e,n,s,i,r){let a,o;const m=c.pt2px(n.xoffset),l=c.pt2px(n.yoffset),p=M*n.angle,f=M*r;switch(n.type){case"esriSMS":a=o=c.pt2px(n.size);break;case"esriPMS":a=c.pt2px(n.width),o=c.pt2px(n.height)}i<b&&(s=b*s/i);const h=u.identity(S);u.translate(h,h,x.set(I,t,e)),u.rotate(h,h,f-p),u.scale(h,h,x.set(I,s,-s)),u.translate(h,h,x.set(I,m,-l));const y=[0,0];x.transformMat2d(y,x.set(I,-.5*a,-.5*o),h);const g=[0,0];x.transformMat2d(g,x.set(I,-.5*a,.5*o),h);const d=[0,0];x.transformMat2d(d,x.set(I,.5*a,-.5*o),h);const P=[0,0];return x.transformMat2d(P,x.set(I,.5*a,.5*o),h),{rings:[[y,d,P,g,y]]}}function L(t,e,n,s,i,r){const a=d.CIMSymbolHelper.getEnvelope(n.data);if(!a)return null;i<b&&(s=b*s/i);const o=c.pt2px(a.width),m=c.pt2px(a.height),l=c.pt2px(a.x),p=c.pt2px(a.y),f=0*M,h=M*r,y=u.identity(S);u.translate(y,y,x.set(I,t,e)),u.rotate(y,y,h-f),u.scale(y,y,x.set(I,s,s));const g=[0,0];x.transformMat2d(g,x.set(I,l,p+m),y);const P=[0,0];x.transformMat2d(P,x.set(I,l,p),y);const w=[0,0];x.transformMat2d(w,x.set(I,l+o,p+m),y);const k=[0,0];return x.transformMat2d(k,x.set(I,l+o,p),y),{rings:[[g,w,k,P,g]]}}function T(t,e,n,s,i,r){const a=c.pt2px(n.xoffset),o=c.pt2px(n.yoffset),m=M*n.angle,l=M*r,p=u.identity(S);u.translate(p,p,x.set(I,t,e)),u.rotate(p,p,l),u.scale(p,p,x.set(I,i,-i));const f=s[0]+s[2]/2,h=s[1]+s[3]/2;u.translate(p,p,x.set(I,a,-o)),u.translate(p,p,x.set(I,f,h)),u.rotate(p,p,m),u.translate(p,p,x.set(I,-f,-h));const y=[0,0];x.transformMat2d(y,x.set(I,s[0],s[1]),p);const g=[0,0];x.transformMat2d(g,x.set(I,s[0],s[1]+s[3]),p);const d=[0,0];x.transformMat2d(d,x.set(I,s[0]+s[2],s[1]),p);const b=[0,0];return x.transformMat2d(b,x.set(I,s[0]+s[2],s[1]+s[3]),p),{rings:[[y,d,b,g,y]]}}function W(t){switch(t.symbol.type){case"esriSFS":case"esriPFS":{const e=t.symbol.outline;return e?e.width:0}case"esriSLS":return c.pt2px(t.symbol.width);case"esriSMS":return c.pt2px(t.symbol.size);case"esriPMS":return c.pt2px(Math.max(t.symbol.width,t.symbol.height));case"esriTS":{const e=[0,0,0,0];C(e,t.symbol,t.mosaicItem);const n=Math.max(Math.abs(e[0]),Math.abs(e[1]));return Math.max(e[2],e[3])+n}case"expanded-cim":{const e=d.CIMSymbolHelper.getEnvelope(t.symbol.data);return c.pt2px(Math.sqrt(e.width*e.width+e.height*e.height))}case"composite-symbol":{if(!t.symbol.layers.length)return 0;const e=t.symbol.layers.length-1;return W({symbol:t.symbol.layers[e],mosaicItem:null})}case"label":default:return 0}}function C(t,e,n){if(!n||0===n.glyphMosaicItems.length)return t;const s=g.bidiText(e.text)[1],i=n.glyphMosaicItems,r=y.shapeGlyphs(i,s,{scale:c.pt2px(e.font.size)/24,angle:e.angle,xOffset:e.xoffset,yOffset:e.yoffset,hAlign:h.getXAnchorDirection(e.horizontalAlignment||"center"),vAlign:h.getYAnchorDirection(e.verticalAlignment||"baseline"),maxLineWidth:Math.max(32,Math.min(e.lineWidth||512,512)),lineHeight:30*Math.max(.25,Math.min(e.lineHeight||1,4)),decoration:e.font.decoration||"none",isCIM:!1}).bounds;return t[0]=c.pt2px(r.x-r.halfWidth),t[1]=c.pt2px(r.y-r.halfHeight),t[2]=c.pt2px(r.width),t[3]=c.pt2px(r.height),t}const O={102100:{maxX:20037508.342788905,minX:-20037508.342788905,plus180Line:{paths:[[[20037508.342788905,-20037508.342788905],[20037508.342788905,20037508.342788905]]],spatialReference:i.WebMercator},minus180Line:{paths:[[[-20037508.342788905,-20037508.342788905],[-20037508.342788905,20037508.342788905]]],spatialReference:i.WebMercator}},4326:{maxX:180,minX:-180,plus180Line:{paths:[[[180,-180],[180,180]]],spatialReference:i.WGS84},minus180Line:{paths:[[[-180,-180],[-180,180]]],spatialReference:i.WGS84}}};function U(t,e){return Math.ceil((t-e)/(2*e))}function H(t,e){const[n,s]=e.valid,i=2*s;let r,a=0;return t>s?(r=Math.ceil(Math.abs(t-s)/i),t-=r*i,a=r):t<n&&(r=Math.ceil(Math.abs(t-n)/i),t+=r*i,a=-r),{x:t,frameId:a}}function G(t,e){const{xmin:n,ymin:s,xmax:i,ymax:r}=e;return N(t,n,s)&&N(t,n,r)&&N(t,i,r)&&N(t,i,s)}function N(t,e,n){return e>=t.xmin&&e<=t.xmax&&n>=t.ymin&&n<=t.ymax}function q(t,e,n){if(Array.isArray(t)){const s=t[0];if(s>e){const n=U(s,e);t[0]=s+n*(-2*e)}else if(s<n){const e=U(s,n);t[0]=s+e*(-2*n)}}else{const s=t.x;if(s>e){const n=U(s,e);t.x+=n*(-2*e)}else if(s<n){const e=U(s,n);t.x+=e*(-2*n)}}return t}let E=function(){function t(){}return t.prototype.cut=function(t,e){let n;if(t.rings)this.closed=!0,n=t.rings,this.minPts=4;else{if(!t.paths)return null;this.closed=!1,n=t.paths,this.minPts=2}const s=n.length,i=-2*e;for(let t=0;t<s;t++){const e=n[t];if(e&&e.length>=this.minPts){const t=[];for(const n of e)t.push([n[0]+i,n[1]]);n.push(t)}}return this.closed?t.rings=n:t.paths=n,t},t}();t.getBounds=function(t,e,n,i,r,c,m){if(!i||!n.symbol)return t[0]=t[1]=t[2]=t[3]=0,e[0]=e[1]=e[2]=e[3]=0,t;const x=i;if(!o.isPoint(x)){a.getBoundsXY(t,x);let s=e[0];0===s&&(s=W(n),e[0]=s);const i=r*s/2;return t[0]-=i,t[1]-=i,t[2]+=i,t[3]+=i,t}{const i=x.x,a=x.y;"esriTS"===n.symbol.type&&0===e[2]&&0===e[3]&&C(e,n.symbol,n.mosaicItem),function(t,e,n,i,r,a,o,c){let m;switch(i.type){case"esriSMS":case"esriPMS":m=B(e,n,i,a,o,0);break;case"esriTS":m=T(e,n,i,r,a,0);break;case"cim":case"CIMSymbolReference":case"expanded-cim":m=L(e,n,i,a,o,0)}let x,u,p=0;for(let t=0;t<m.rings[0].length-1;t++)u=m.rings[0][t],x=(e-u[0])*(e-u[0])+(n-u[1])*(n-u[1]),p=Math.max(p,x);p=Math.sqrt(p);let f=l.normalizeMapX(e-p,c),h=l.normalizeMapX(e+p,c);if(f>h){const t=s.getInfo(c);if(t){const[e,n]=t.valid;f=e,h=n}}t[0]=f,t[1]=n-p,t[2]=h,t[3]=n+p}(t,i,a,n.symbol,e,r,c,m)}return t},t.getCIMMarkerBounds=L,t.getMarkerSymbolBounds=B,t.getTextSymbolBounds=T,t.getTextSymbolSize=C,t.graphicGeometryToNumber=function(t){switch(n.unwrap(t.geometry).type){case"point":case"multipoint":return 0;case"polyline":return 1;case"polygon":case"extent":return 2}return 0},t.isMarkerSymbol=function(t){return"simple-marker"===t||"picture-marker"===t||"text"===t},t.isPointOnPolyline=function(t,e,n,s){x.set(v,e,n);const i=t.paths;let r,a,o,c,m,l,u,p,f,h=1/0;for(let t=0;t<i.length;t++){const y=i[t];if(!(y.length<2))for(let t=1;t<y.length;t++)r=y[t-1][0],o=y[t-1][1],a=y[t][0],c=y[t][1],m=Math.min(r,a)-s,l=Math.min(o,c)-s,u=Math.max(r,a)+s,p=Math.max(o,c)+s,e<m||e>u||n<l||n>p||(x.set(w,r,o),x.set(k,a,c),x.subtract(X,k,w),x.subtract(z,w,v),x.scale(R,X,x.dot(X,z)/x.dot(X,X)),x.subtract(A,z,R),f=x.dot(A,A),h>f&&(h=f))}return Math.sqrt(h)<=s},t.normalizeCentralMeridian=function(t){let e,n,i,c,m,l,x,u,p,f=null;if(!t)return null;if("mesh"===t.type)return t.toJSON();if(e=t.spatialReference,n=s.getInfo(e),!n)return t.toJSON();i=e.isWebMercator,l=i?102100:4326,c=O[l].maxX,m=O[l].minX,x=O[l].plus180Line,u=O[l].minus180Line;const h=t.toJSON();if(o.isPoint(h))p=q(h,c,m);else if(o.isMultipoint(h))h.points=h.points.map((t=>q(t,c,m))),p=h;else if(o.isExtent(h))p=function(t,e){if(!e)return t;const n=function(t,e){const n=[],{ymin:s,ymax:i}=t,r=t.xmax-t.xmin,a=t.xmin,o=t.xmax;let c;const[m,l]=e.valid;c=H(t.xmin,e);const x=c.x,u=c.frameId;c=H(t.xmax,e);const p=c.x,f=c.frameId,h=x===p&&r>0;if(r>2*l){const t={xmin:a<o?x:p,ymin:s,xmax:l,ymax:i},e={xmin:m,ymin:s,xmax:a<o?p:x,ymax:i},r={xmin:0,ymin:s,xmax:l,ymax:i},c={xmin:m,ymin:s,xmax:0,ymax:i},h=[],y=[];G(t,r)&&h.push(u),G(t,c)&&y.push(u),G(e,r)&&h.push(f),G(e,c)&&y.push(f);for(let t=u+1;t<f;t++)h.push(t),y.push(t);n.push({extent:t,frameIds:[u]},{extent:e,frameIds:[f]},{extent:r,frameIds:h},{extent:c,frameIds:y})}else x>p||h?n.push({extent:{xmin:x,ymin:s,xmax:l,ymax:i},frameIds:[u]},{extent:{xmin:m,ymin:s,xmax:p,ymax:i},frameIds:[f]}):n.push({extent:{xmin:x,ymin:s,xmax:p,ymax:i},frameIds:[u]});return n}(t,e).map((t=>t.extent));if(n.length<2)return n[0]||t;if(n.length>2)return t.xmin=e.valid[0],t.xmax=e.valid[1],t;return{rings:n.map((t=>[[t.xmin,t.ymin],[t.xmin,t.ymax],[t.xmax,t.ymax],[t.xmax,t.ymin],[t.xmin,t.ymin]]))}}(h,n);else if(o.isPolygon(h)||o.isPolyline(h)){const t=P;a.getBoundsXY(t,h);const e={xmin:t[0],ymin:t[1],xmax:t[2],ymax:t[3]},n=U(e.xmin,m)*(2*c),s=0===n?h:function(t,e){const n=function(t){if(o.isPolygon(t))return t.rings;return t.paths}(t);for(const t of n)for(const n of t)n[0]+=e;return t}(h,n);e.xmin+=n,e.xmax+=n,r.extentIntersectsPolyline(e,x)&&e.xmax!==c||r.extentIntersectsPolyline(e,u)&&e.xmin!==m?f=s:p=s}else p=t.clone();if(null!==f){return(new E).cut(f,c)}return p},Object.defineProperty(t,"__esModule",{value:!0})}));
