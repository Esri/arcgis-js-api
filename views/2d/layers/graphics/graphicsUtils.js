/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../core/has","../../../../core/maybe","../../../../geometry/support/spatialReferenceUtils","../../../../geometry/support/boundsUtils","../../../../geometry/support/jsonUtils","../../../../core/screenUtils","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/normalizeUtilsCommon","../../../../geometry/support/normalizeUtils","../../../../chunks/vec2","../../../../chunks/mat2d","../../../../chunks/mat2df32","../../../../chunks/vec2f32","../../engine/webgl/alignmentUtils","../../engine/webgl/mesh/templates/shapingUtils","../../engine/webgl/util/BidiText","../../../../symbols/cim/CIMSymbolHelper"],(function(t,e,s,n,r,a,o,i,c,l,m,p,h,u,f,g,y,d){"use strict";const M=Math.PI/180,x=.04,b=h.create(),S=u.create(),w=512,I=50;function k(t,e){if(!e.isWrappable)return null;const[s,n]=c.getSpatialReferenceMinMaxX(e);return t[2]>n?[i.create([t[0],t[1],n,t[3]]),i.create([s,t[1],s+t[2]-n,t[3]])]:t[0]<s?[i.create([s,t[1],t[2],t[3]]),i.create([n-(s-t[0]),t[1],n,t[3]])]:null}function P(t,e,s,n,o,i,c){if(!n||!s.symbol)return t[0]=t[1]=t[2]=t[3]=0,e[0]=e[1]=e[2]=e[3]=0,t;const l=n;if(!a.isPoint(l)){r.getBoundsXY(t,l);let n=e[0];0===n&&(n=W(s),e[0]=n);const a=o*n/2;return t[0]-=a,t[1]-=a,t[2]+=a,t[3]+=a,t}{const n=l.x,r=l.y;"esriTS"===s.symbol.type&&0===e[2]&&0===e[3]&&_(e,s.symbol,s.mosaicItem),q(t,n,r,s.symbol,e,o,i,c)}return t}function T(t){return"text"===t||"esriTS"===t}function z(t){return"simple-marker"===t||"picture-marker"===t||"esriSMS"===t||"esriPMS"===t}function U(t){switch(s.unwrap(t.geometry).type){case"point":case"multipoint":return 0;case"polyline":return 1;case"polygon":case"extent":return 2}return 0}const v=u.create(),B=u.create(),C=u.create(),A=u.create(),E=u.create(),H=u.create(),X=u.create();function R(t,e,s,n){m.set(C,e,s);const r=t.paths;let a,o,i,c,l,p,h,u,f,g=1/0;for(let y=0;y<r.length;y++){const t=r[y];if(!(t.length<2))for(let r=1;r<t.length;r++)a=t[r-1][0],i=t[r-1][1],o=t[r][0],c=t[r][1],l=Math.min(a,o)-n,p=Math.min(i,c)-n,h=Math.max(a,o)+n,u=Math.max(i,c)+n,e<l||e>h||s<p||s>u||(m.set(v,a,i),m.set(B,o,c),m.subtract(A,B,v),m.subtract(E,v,C),m.scale(H,A,m.dot(A,E)/m.dot(A,A)),m.subtract(X,E,H),f=m.dot(X,X),g>f&&(g=f))}return Math.sqrt(g)<=n}function F(t,e,s,n,r,a){let i,c;const l=o.pt2px(s.xoffset),h=o.pt2px(s.yoffset),u=M*s.angle,f=M*a;switch(s.type){case"esriSMS":i=c=o.pt2px(s.size);break;case"esriPMS":i=o.pt2px(s.width),c=o.pt2px(s.height)}r<x&&(n=x*n/r);const g=p.identity(b);p.translate(g,g,m.set(S,t,e)),p.rotate(g,g,f-u),p.scale(g,g,m.set(S,n,-n)),p.translate(g,g,m.set(S,l,-h));const y=[0,0];m.transformMat2d(y,m.set(S,-.5*i,-.5*c),g);const d=[0,0];m.transformMat2d(d,m.set(S,-.5*i,.5*c),g);const w=[0,0];m.transformMat2d(w,m.set(S,.5*i,-.5*c),g);const I=[0,0];return m.transformMat2d(I,m.set(S,.5*i,.5*c),g),{rings:[[y,w,I,d,y]]}}function L(t,e,s,n,r,a){const i=d.CIMSymbolHelper.getEnvelope(s.data);if(!i)return null;r<x&&(n=x*n/r);const c=o.pt2px(i.width),l=o.pt2px(i.height),h=o.pt2px(i.x),u=o.pt2px(i.y),f=0*M,g=M*a,y=p.identity(b);p.translate(y,y,m.set(S,t,e)),p.rotate(y,y,g-f),p.scale(y,y,m.set(S,n,n));const w=[0,0];m.transformMat2d(w,m.set(S,h,u+l),y);const I=[0,0];m.transformMat2d(I,m.set(S,h,u),y);const k=[0,0];m.transformMat2d(k,m.set(S,h+c,u+l),y);const P=[0,0];return m.transformMat2d(P,m.set(S,h+c,u),y),{rings:[[w,k,P,I,w]]}}function O(t,e,s,n,r,a){const i=o.pt2px(s.xoffset),c=o.pt2px(s.yoffset),l=M*s.angle,h=M*a,u=p.identity(b);p.translate(u,u,m.set(S,t,e)),p.rotate(u,u,h),p.scale(u,u,m.set(S,r,-r));const f=n[0]+n[2]/2,g=n[1]+n[3]/2;p.translate(u,u,m.set(S,i,-c)),p.translate(u,u,m.set(S,f,g)),p.rotate(u,u,l),p.translate(u,u,m.set(S,-f,-g));const y=[0,0];m.transformMat2d(y,m.set(S,n[0],n[1]),u);const d=[0,0];m.transformMat2d(d,m.set(S,n[0],n[1]+n[3]),u);const x=[0,0];m.transformMat2d(x,m.set(S,n[0]+n[2],n[1]),u);const w=[0,0];return m.transformMat2d(w,m.set(S,n[0]+n[2],n[1]+n[3]),u),{rings:[[y,x,w,d,y]]}}function W(t){switch(t.symbol.type){case"esriSFS":case"esriPFS":{const e=t.symbol.outline;return e?e.width:0}case"esriSLS":return o.pt2px(t.symbol.width);case"esriSMS":return o.pt2px(t.symbol.size);case"esriPMS":return o.pt2px(Math.max(t.symbol.width,t.symbol.height));case"esriTS":{const e=[0,0,0,0];_(e,t.symbol,t.mosaicItem);const s=Math.max(Math.abs(e[0]),Math.abs(e[1]));return Math.max(e[2],e[3])+s}case"expanded-cim":{const e=d.CIMSymbolHelper.getEnvelope(t.symbol.data);return e.width!==-1/0&&e.height!==-1/0||(e.width=10,e.height=10,e.x=0,e.y=0),o.pt2px(Math.sqrt(e.width*e.width+e.height*e.height))}case"composite-symbol":{if(!t.symbol.layers.length)return 0;const e=t.symbol.layers.length-1;return W({symbol:t.symbol.layers[e],mosaicItem:null})}case"label":default:return 0}}function _(t,e,s){if(!s||0===s.glyphMosaicItems.length)return t;const n=y.bidiText(e.text)[1],r=s.glyphMosaicItems,a=g.shapeGlyphs(r,n,{scale:o.pt2px(e.font.size)/24,angle:e.angle,xOffset:e.xoffset,yOffset:e.yoffset,hAlign:f.getXAnchorDirection(e.horizontalAlignment||"center"),vAlign:f.getYAnchorDirection(e.verticalAlignment||"baseline"),maxLineWidth:Math.max(32,Math.min(e.lineWidth||512,512)),lineHeight:30*Math.max(.25,Math.min(e.lineHeight||1,4)),decoration:e.font.decoration||"none",isCIM:!1}).bounds;return t[0]=o.pt2px(a.x-a.halfWidth),t[1]=o.pt2px(a.y-a.halfHeight),t[2]=o.pt2px(a.width),t[3]=o.pt2px(a.height),t}function q(t,e,s,r,a,o,i,c){let m;switch(r.type){case"esriSMS":case"esriPMS":m=F(e,s,r,o,i,0);break;case"esriTS":m=O(e,s,r,a,o,0);break;case"cim":case"CIMSymbolReference":case"expanded-cim":m=L(e,s,r,o,i,0)}let p,h,u=0;for(let n=0;n<m.rings[0].length-1;n++)h=m.rings[0][n],p=(e-h[0])*(e-h[0])+(s-h[1])*(s-h[1]),u=Math.max(u,p);u=Math.sqrt(u);let f=l.normalizeMapX(e-u,c),g=l.normalizeMapX(e+u,c);if(f>g){const t=n.getInfo(c);if(t){const[e,s]=t.valid;f=e,g=s}}return t[0]=f,t[1]=s-u,t[2]=g,t[3]=s+u,t}t.PIXEL_BUFFER=I,t.TILE_SIZE=w,t.getBounds=P,t.getCIMMarkerBounds=L,t.getMarkerSymbolBounds=F,t.getTextSymbolBounds=O,t.getTextSymbolSize=_,t.graphicGeometryToNumber=U,t.intersectingInternationalDateline=k,t.isMarkerSymbol=z,t.isPointOnPolyline=R,t.isTextSymbol=T,Object.defineProperty(t,"__esModule",{value:!0})}));
