// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../core/Accessor","../../../../core/HandleOwner","../../../../core/has","../../../../core/Identifiable","../../../../core/MapPool","../../../../core/MapUtils","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/promiseUtils","../../../../core/screenUtils","../../../../core/accessorSupport/decorators","../../../../geometry/Polygon","../../../../geometry/SpatialReference","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/coordsUtils","../../../../geometry/support/jsonUtils","../../../../geometry/support/spatialReferenceUtils","../../../../layers/graphics/data/projectionSupport","../../../../symbols/cim/cimSymbolUtils","../../../../symbols/support/defaults","../../engine/webgl/definitions","../../engine/webgl/TileData","../../engine/webgl/WGLTile","../../engine/webgl/mesh/factories/matcherUtils","../../engine/webgl/mesh/factories/WGLMeshFactory","../../engine/webgl/mesh/templates/WGLTemplateStore","../../engine/webgl/util/BidiText","../features/schemaUtils","../features/support/AttributeStore","../features/support/ComputedAttributeStorage","../features/support/GraphicsReader","../features/support/TileStore","./GraphicContainer","./GraphicProcessingQueue","./GraphicStore","./graphicsUtils","../../../layers/GraphicsView"],(function(e,t,i,r,a,s,o,n,h,d,p,c,l,u,g,_,f,y,v,m,S,b,w,G,T,U,I,M,P,O,C,A,R,x,F,D,k,q,H,z){"use strict";Object.defineProperty(t,"__esModule",{value:!0});function j(e,t,i){if(i.has(e))return i.get(e);var r={tile:t,addedOrModified:[],removed:[]};return i.set(e,r),r}var Q=function(e){function t(t){var i=e.call(this,t)||this;return i._storage=new R.ComputedAttributeStorage,i._displayIds=new Map,i._tiles=new Map,i._graphicStoreUpdate=!1,i._graphicsSet=new Set,i._matcher=p.resolve(null),i._tileUpdateSet=new Set,i._tilesToUpdate=new Map,i._graphicIdToAbortController=new Map,i._attached=!1,i._highlightIds=new Map,i._updatingGraphicsTimer=null,i._processing=!1,i._needsProcessing=!1,i._pendingUpdate={addOrModified:new Set,removed:new Set},i.lastUpdateId=-1,i.updateRequested=!1,i.graphicUpdateHandler=i.graphicUpdateHandler.bind(i),i.addOrUpdateGraphic=i.addOrUpdateGraphic.bind(i),i._processAnalyzedGraphics=i._processAnalyzedGraphics.bind(i),i._graphicsChangeHandler=i._graphicsChangeHandler.bind(i),i}return i.__extends(t,e),t.prototype._createMatcher=function(e,t){if(e){var i=C.createMatcherSchema({indexCount:0,fields:{}},"feature",e);this._matcher=I.createMatcher(i,t,null)}},t.prototype._createDisplayId=function(e){return this._displayIds.has(e)||this._displayIds.set(e,this._storage.createDisplayId()),this._displayIds.get(e)},t.prototype.initialize=function(){var e=this;this._tileStore=new F.default(this.view.featuresTilingScheme),this.container=new D.default(this.view.featuresTilingScheme),this._attributeStore=new A.default({type:"local",initialize:function(t){return p.resolve(e.container.attributeView.initialize(t))},update:function(t){return e.container.attributeView.requestUpdate(t)},render:function(){return e.container.requestRender()}});this._graphicStore=new q.default(this.view.featuresTilingScheme,this.view.state.scale,this.uid,this.graphics,(function(t){e._createDisplayId(t.uid),e._setFilterState(t.uid,t.visible)}),(function(t){var i=e._displayIds.get(t.uid);e._displayIds.delete(t.uid),e._storage.releaseDisplayId(i)})),this._graphicProcessingQueue=new k.default({process:this.addOrUpdateGraphic});var t=new P.WGLTemplateStore(this.container.getMaterialItems.bind(this.container),!0);this._createMatcher(this.renderer,t),this._meshFactory=new M.WGLMeshFactory(null,this.uid,t),this._templateStore=t,this.watch("renderer",(function(i){return e._createMatcher(i,t)})),this._tileStore.on("update",this._onTileUpdate.bind(this)),this.container.on("attach",(function(){e.graphics.items.length>0&&e._graphicsChangeHandler({target:e.graphics,added:e.graphics.items,removed:[],moved:[]}),e.handles.add(e.graphics.on("change",e._graphicsChangeHandler),"graphics"),e._attached=!0,e.notifyChange("updating")})),this.container.on("detach",(function(){e._graphicProcessingQueue&&e._graphicProcessingQueue.clear()}))},t.prototype.destroy=function(){this._updatingGraphicsTimer&&(clearTimeout(this._updatingGraphicsTimer),this._updatingGraphicsTimer=null,this.notifyChange("updating")),this.container.destroy(),this._set("graphics",null),this._graphicProcessingQueue&&(this._graphicProcessingQueue.destroy(),this._graphicProcessingQueue=null),this._graphicStore.clear(),this._tileStore.destroy(),this._attributeStore=null},Object.defineProperty(t.prototype,"updating",{get:function(){return!this._attached||null!==this._updatingGraphicsTimer||this._graphicProcessingQueue.updating||this._tileUpdateSet.size>0||this._tilesToUpdate.size>0},enumerable:!1,configurable:!0}),t.prototype.hitTest=function(e,t){if(!this.view||!this.view.position)return p.resolve();var i=this.view.toMap(l.createScreenPoint(e,t));return this.searchFeatures(i).then((function(e){return e&&e.length?e[0]:null}))},t.prototype.searchFeatures=function(e,t){var i=this;return void 0===t&&(t=2),p.create((function(r){r(i._graphicStore.hitTest(e.x,e.y,t,i.view.state.resolution,i.view.state.rotation))}))},t.prototype.update=function(e){var t=e.state,i=this.view.featuresTilingScheme.getClosestInfoForScale(t.scale).level;this._graphicStore.updateLevel(i),this._tileStore.setViewState(t),this._graphicStoreUpdate=!0,this.updateRequested=!1},t.prototype.viewChange=function(){this.requestUpdate()},t.prototype.requestUpdate=function(){this.updateRequested||(this.updateRequested=!0,this.requestUpdateCallback())},t.prototype.processUpdate=function(e){this.updateRequested&&(this.updateRequested=!1,this.update(e))},t.prototype.graphicUpdateHandler=function(e){var t=e.graphic,i=e.property,r=e.newValue,a=t;switch(i){case"attributes":break;case"geometry":case"symbol":this._graphicProcessingQueue.push(a,"update");break;case"visible":this._setFilterState(a.uid,r),this._attributeStore.sendUpdates()}},t.prototype.addHighlight=function(e){for(var t=0,i=e;t<i.length;t++){var r=i[t];if(this._highlightIds.has(r)){var a=this._highlightIds.get(r);this._highlightIds.set(r,a+1)}else this._highlightIds.set(r,1)}this._updateHighlight()},t.prototype.removeHighlight=function(e){for(var t=0,i=e;t<i.length;t++){var r=i[t];if(this._highlightIds.has(r)){var a=this._highlightIds.get(r)-1;0===a?this._highlightIds.delete(r):this._highlightIds.set(r,a)}}this._updateHighlight()},t.prototype._updateHighlight=function(){var e=this,t=h.keysOfMap(this._highlightIds),i=t.map((function(t){return e._displayIds.get(t)}));this._attributeStore.setHighlight(t,i)},t.prototype._getIntersectingTiles=function(e){var t=this._graphicStore.getBounds(e);return!t||0===f.width(t)||0===f.height(t)?[]:this._tileStore.boundsIntersections(t)},t.prototype._updateTile=function(e){var t=this,i=e.tile,r=this._getGraphicsData(this._templateStore,i,e.addedOrModified);return this._processGraphics(r).then((function(r){return t._patchTile(i.key,{type:"update",addOrUpdate:r,remove:e.removed,end:!0}),r}))},t.prototype._patchTile=function(e,t){if(this._tiles.has(e)){var i=this._tiles.get(e);this.container.onTileData(i,t),this.container.requestRender()}},t.prototype._graphicsChangeHandler=function(e){for(var t=0,i=e.added;t<i.length;t++){var r=i[t];this._pendingUpdate.addOrModified.add(r)}for(var a=0,s=e.moved;a<s.length;a++){r=s[a];this._pendingUpdate.addOrModified.add(r)}for(var o=0,n=e.removed;o<n.length;o++){r=n[o];this._pendingUpdate.addOrModified.has(r)?this._pendingUpdate.addOrModified.delete(r):this._pendingUpdate.removed.add(r)}this._processing?this._needsProcessing=!0:this._updateGraphics()},t.prototype._getFeaturesToUpdate=function(){for(var e=this,t={addOrModified:[],removed:[]},i=0,r=this.graphics.items;i<r.length;i++){var a=r[i];this._pendingUpdate.addOrModified.has(a)&&t.addOrModified.push(a)}return this._pendingUpdate.removed.forEach((function(i){e._graphicStore.has(i)&&t.removed.push(i)})),this._pendingUpdate.addOrModified.clear(),this._pendingUpdate.removed.clear(),t},t.prototype._updateGraphics=function(){return i.__awaiter(this,void 0,void 0,(function(){var e,t,r,a,o,n,h,d,c,l,u,g,_,f,y,v,m,S,b,w,G,T,U,I=this;return i.__generator(this,(function(i){switch(i.label){case 0:this._processing=!0,e=this._getFeaturesToUpdate(),t=e.addOrModified,r=e.removed,a=this._tilesToUpdate,i.label=1;case 1:for(i.trys.push([1,4,,5]),this._graphicStoreUpdate||(n=this.view.state,h=this.view.featuresTilingScheme.getClosestInfoForScale(n.scale).level,this._graphicStore.updateLevel(h),this._tileStore.setViewState(n)),d=[],c=new Array(t.length),m=0;m<t.length;m++)l=t[m],c[m]=l,this._graphicsSet.add(l),d.push(this.addGraphic(l));for(u=0,g=r;u<g.length;u++){for(_=g[u],this._abortProcessingGraphic(_.uid),S=this._getIntersectingTiles(_),f=0,y=S;f<y.length;f++)G=y[f],o=G.key.id,j(o,G,a).removed.push(this._displayIds.get(_.uid));this._graphicsSet.delete(_),this._graphicStore.remove(_)}return this._flipUpdatingGraphics(),[4,p.all(d)];case 2:for(i.sent(),v=void 0,m=0;m<c.length;m++)for(v=c[m],S=this._getIntersectingTiles(v),b=0,w=S;b<w.length;b++)G=w[b],o=G.key.id,j(o,G,a).addedOrModified.push(v);return this._graphicStore.updateZ(),T=[],a.forEach((function(e){return T.push(I._updateTile(e))})),[4,p.all(T)];case 3:return i.sent(),[3,5];case 4:return U=i.sent(),s("esri-2d-debug")&&console.debug("Encountered an error when updating graphics:",U),[3,5];case 5:return a.clear(),this.notifyChange("updating"),this._processing=!1,this._needsProcessing&&(this._needsProcessing=!1,this._updateGraphics()),[2]}}))}))},t.prototype._getArcadeInfo=function(e){var t=(e.attributes?Object.keys(e.attributes):[]).map((function(t){return{name:t,alias:t,type:"string"==typeof e.attributes[t]?"esriFieldTypeString":"esriFieldTypeDouble"}}));return d.isNone(e.geometry)?null:{geometryType:v.getJsonType(e.geometry),spatialReference:_.fromJSON(e.geometry.spatialReference),fields:t}},t.prototype._getSymbolForGraphic=function(e,t){return i.__awaiter(this,void 0,void 0,(function(){return i.__generator(this,(function(i){return d.isSome(e.symbol)?[2,e.symbol]:d.isSome(this.renderer)?[2,this.renderer.getSymbolAsync(e,{scale:this.view.scale,abortOptions:t})]:[2,this._getNullSymbol(e)]}))}))},t.prototype._getSymbolResources=function(e,t){return i.__awaiter(this,void 0,void 0,(function(){var r,a,s,o,n,h,d,c,l;return i.__generator(this,(function(i){switch(i.label){case 0:return this.container.stage?(r=this._getArcadeInfo(e),[4,this._getSymbolForGraphic(e,t)]):[2,p.resolve(null)];case 1:return a=i.sent(),s=C.createSymbolSchema(a),[4,b.expandSymbol(s,r,t)];case 2:if("esriTS"!==(o=i.sent()).type)return[3,4];for(n=[],h=O.bidiText(o.text)[0],d=0;d<h.length;d++)n.push(h.charCodeAt(d));return c={symbol:o,id:0,glyphIds:n},[4,this.container.getMaterialItems([c])];case 3:return l=i.sent()[0].mosaicItem,[2,{symbol:o,mosaicItem:l}];case 4:return[2,{symbol:o,mosaicItem:null}]}}))}))},t.prototype._projectAndNormalizeGeometry=function(e){return i.__awaiter(this,void 0,void 0,(function(){var t,r,a,s=this;return i.__generator(this,(function(i){return d.isNone(e.geometry)?[2,p.resolve(null)]:(t=e.geometry,v.isPolygon(t)?(r=t.rings,t.rings=r):v.isPolyline(t)?(a=t.paths,t.paths=a):v.isExtent(t)&&(t=g.fromExtent(t)),[2,S.checkProjectionSupport(t.spatialReference,this.view.spatialReference).then((function(){var e=H.normalizeCentralMeridian(t),i=S.project(e,t.spatialReference,s.view.spatialReference);return y.closeRingsAndFixWinding(i),i}))])}))}))},t.prototype._onTileUpdate=function(e){var t=m.getInfo(this.view.spatialReference);if(e.added&&e.added.length>0)for(var i=0,r=e.added;i<r.length;i++){var a=r[i];this._addNewTile(a,t)}if(e.removed&&e.removed.length>0)for(var s=0,o=e.removed;s<o.length;s++){var n=o[s];this._removeTile(n.key)}},t.prototype.addOrUpdateGraphic=function(e,t,i){return this._addOrUpdateGraphic(e,t,i)},t.prototype.addGraphic=function(e){var t=this;this._abortProcessingGraphic(e.uid);var i=c.createAbortController();this._graphicIdToAbortController.set(e.uid,i);var r={signal:i.signal};return this._addOrUpdateGraphic(e,"add",r).then((function(){t._graphicIdToAbortController.delete(e.uid)})).catch((function(i){if(t._graphicIdToAbortController.delete(e.uid),!p.isAbortError(i))throw i}))},t.prototype._addOrUpdateGraphic=function(e,t,i){var r=this,a=this._projectAndNormalizeGeometry(e),s=this._getSymbolResources(e,i);return p.all([a,s]).then((function(a){var s=a[0],o=a[1];return"add"===t?r._addProjectedGraphic(e,o,s):r._updateGraphic(e,o,s,i)}))},t.prototype._addProjectedGraphic=function(e,t,i){this._graphicsSet.has(e)&&this._graphicStore.addOrModify(e,t,i)},t.prototype._updateGraphic=function(e,t,i,r){var a=this;if(!this._graphicStore.has(e)||p.isAborted(r))return p.resolve();for(var s=this._graphicStore.update(e,t,i),o=s.oldBounds,h=s.newBounds,d=0===f.width(o)&&0===f.height(o),c=0===f.width(h)&&0===f.height(h),l=d?[]:this._tileStore.boundsIntersections(o),u=c?[]:this._tileStore.boundsIntersections(h),g=n.acquire(),_=0,y=l;_<y.length;_++){var v=y[_];g.set(v.key,{addOrUpdate:null,remove:[this._displayIds.get(e.uid)]})}for(var m=0,S=u;m<S.length;m++){v=S[m];var b=this._getGraphicData(this._templateStore,v,e);if(g.has(v.key)){var w=g.get(v.key);w.remove.length=0,w.addOrUpdate=b}else g.set(v.key,{addOrUpdate:b,remove:null})}var G=[];return g.forEach((function(e,t){var i=a._processGraphics(e.addOrUpdate,r).then((function(i){a._patchTile(t,{type:"update",addOrUpdate:i,remove:e.remove,end:!0})}));G.push(i)})),n.release(g),p.all(G).then((function(){}))},t.prototype._addTile=function(e,t){var i=f.create();this.view.featuresTilingScheme.getTileBounds(i,e);var r=new U.WGLTile(e,i,!0),a={type:"update",clear:!0,addOrUpdate:t,remove:[],end:!0};this._tiles.set(e,r),this.container.addChild(r),r.setData(a)},t.prototype._addNewTile=function(e,t){var i=this,r=this._graphicStore.queryTileData(this._templateStore,e);if(t)for(var a=Math.round((t.valid[1]-t.valid[0])/e.resolution),s=0,o=r;s<o.length;s++){var n=o[s];n.geometry&&v.isPoint(n.geometry)&&this._wrapPoints(n,a)}var h=e.key;this._tileUpdateSet.add(e.key),this.notifyChange("updating"),this._processGraphics(r).then((function(e){i._addTile(h,e),i._tileUpdateSet.delete(h),i.notifyChange("updating")})).catch((function(e){if(i._tileUpdateSet.delete(h),i.notifyChange("updating"),!p.isAbortError(e))throw e}))},t.prototype._removeTile=function(e){if(this._tiles.has(e)){var t=this._tiles.get(e);this.container.removeChild(t),t.destroy(),this._tiles.delete(e)}},t.prototype._setFilterState=function(e,t){var i=this._displayIds.get(e),r=this._attributeStore.getHighlightFlag(e);this._attributeStore.setData(i,0,0,r|(t?G.FILTER_FLAG_0:0))},t.prototype._getGraphicsData=function(e,t,i){var r=m.getInfo(this.view.spatialReference),a=this._graphicStore.getGraphicsData(e,t,i);if(r)for(var s=Math.round((r.valid[1]-r.valid[0])/t.resolution),o=0,n=a;o<n.length;o++){var h=n[o];h.geometry&&v.isPoint(h.geometry)&&this._wrapPoints(h,s)}return a.sort((function(e,t){return e.insertAfter-t.insertAfter})),a},t.prototype._getGraphicData=function(e,t,i){var r=this._graphicStore.getGraphicData(e,t,i),a=[r],s=m.getInfo(this.view.spatialReference);if(s){var o=Math.round((s.valid[1]-s.valid[0])/t.resolution);r.geometry&&v.isPoint(r.geometry)&&this._wrapPoints(r,o)}return a},t.prototype._wrapPoints=function(e,t){var i=e.geometry;512===t?i.x<20?e.geometry={points:[[i.x,i.y],[t,0]]}:i.x>492&&(e.geometry={points:[[i.x,i.y],[-t,0]]}):i.x<-20?e.geometry={points:[[i.x,i.y],[t,0]]}:i.x>532&&(e.geometry={points:[[i.x,i.y],[-t,0]]})},t.prototype._processGraphics=function(e,t){return i.__awaiter(this,void 0,void 0,(function(){var r,a,s,o,n;return i.__generator(this,(function(i){switch(i.label){case 0:return e&&e.length&&this._meshFactory?(r=x.GraphicsReader.from(e),a=this._meshFactory,o=(s=a).analyzeGraphics,n=[r],[4,this._matcher]):[2,null];case 1:return[4,o.apply(s,n.concat([i.sent(),null,null,t]))];case 2:return i.sent(),this._attributeStore.sendUpdates(),[2,this._processAnalyzedGraphics(r)]}}))}))},t.prototype._processAnalyzedGraphics=function(e){for(var t=this._meshFactory,i=t.createMeshData(e.getApproximateSize()),r=e.getCursor();r.next();){var a=r.readGraphic();a.insertAfter=-1===a.insertAfter?-1:this._displayIds.get(a.insertAfter),a.displayId=this._displayIds.get(a.attributes[this.uid]),t.writeGraphic(i,r)}var s={};return i.encode(s,[]),T.TileData.decode(s)},t.prototype._abortProcessingGraphic=function(e){this._graphicIdToAbortController.has(e)&&this._graphicIdToAbortController.get(e).abort()},t.prototype._getNullSymbol=function(e){var t=e.geometry;return v.isPolyline(t)?w.errorPolylineSymbol2D:v.isPolygon(t)||v.isExtent(t)?w.errorPolygonSymbol2D:w.errorPointSymbol2D},t.prototype._flipUpdatingGraphics=function(){var e=this;this._updatingGraphicsTimer&&clearTimeout(this._updatingGraphicsTimer),this._updatingGraphicsTimer=setTimeout((function(){e._updatingGraphicsTimer=null,e.notifyChange("updating")}),160),this.notifyChange("updating")},i.__decorate([u.property()],t.prototype,"_graphicProcessingQueue",void 0),i.__decorate([u.property({constructOnly:!0})],t.prototype,"requestUpdateCallback",void 0),i.__decorate([u.property({constructOnly:!0})],t.prototype,"graphics",void 0),i.__decorate([u.property({dependsOn:["_graphicProcessingQueue.updating"]})],t.prototype,"updating",null),i.__decorate([u.property()],t.prototype,"view",void 0),i.__decorate([u.property()],t.prototype,"updateRequested",void 0),t=i.__decorate([u.subclass("esri.views.2d.layers.support.GraphicsView2D")],t)}(z.GraphicsView(a.HandleOwnerMixin(o.IdentifiableMixin(r))));t.default=Q}));