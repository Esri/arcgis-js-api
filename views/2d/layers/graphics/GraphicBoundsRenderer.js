/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../chunks/mat3","../../../../chunks/mat3f32","../../../../chunks/vec2f32","../../../../chunks/vec3f32","../../../../geometry/support/normalizeUtils","../../engine/DisplayObject","../../engine/webgl/Utils","../../../webgl/BufferObject","../../../webgl/enums","../../../webgl/VertexArrayObject"],(function(e,t,r,i,n,a,s,o,l,u,c,f){"use strict";const _=Math.PI/180,h=4;let d=function(o){function l(e){var t;return(t=o.call(this)||this)._program=null,t._vao=null,t._vertexBuffer=null,t._indexBuffer=null,t._dvsMat3=i.create(),t._localOrigin={x:0,y:0},t._getBounds=e,t}e._inheritsLoose(l,o);var d=l.prototype;return d.destroy=function(){this._vao&&(this._vao.dispose(!0),this._vao=null,this._vertexBuffer=null,this._indexBuffer=null),this._program=t.disposeMaybe(this._program)},d.doRender=function(e){const{context:t}=e,r=this._getBounds();if(r.length<1)return;this._createShaderProgram(t),this._updateMatricesAndLocalOrigin(e),this._updateBufferData(t,r),t.setBlendingEnabled(!0),t.setDepthTestEnabled(!1),t.setStencilWriteMask(0),t.setStencilTestEnabled(!1),t.setBlendFunction(c.BlendFactor.ONE,c.BlendFactor.ONE_MINUS_SRC_ALPHA),t.setColorMask(!0,!0,!0,!0);const i=this._program;t.bindVAO(this._vao),t.useProgram(i),i.setUniformMatrix3fv("u_dvsMat3",this._dvsMat3),t.gl.lineWidth(1),t.drawElements(c.PrimitiveType.LINES,8*r.length,c.DataType.UNSIGNED_INT,0),t.bindVAO()},d._createTransforms=function(){return{dvs:i.create()}},d._createShaderProgram=function(e){if(this._program)return;const t="precision highp float;\n        uniform mat3 u_dvsMat3;\n\n        attribute vec2 a_position;\n\n        void main() {\n          mediump vec3 pos = u_dvsMat3 * vec3(a_position, 1.0);\n          gl_Position = vec4(pos.xy, 0.0, 1.0);\n        }",r="precision mediump float;\n      void main() {\n        gl_FragColor = vec4(0.75, 0.0, 0.0, 0.75);\n      }";this._program=e.programCache.acquire(t,r,p().attributes)},d._updateMatricesAndLocalOrigin=function(e){const{state:t}=e,{displayMat3:i,size:o,resolution:l,pixelRatio:u,rotation:c,viewpoint:f}=t,h=_*c,{x:d,y:p}=f.targetGeometry,g=s.normalizeMapX(d,t.spatialReference);this._localOrigin.x=g,this._localOrigin.y=p;const m=u*o[0],v=u*o[1],y=l*m,b=l*v,x=r.identity(this._dvsMat3);r.multiply(x,x,i),r.translate(x,x,n.fromValues(m/2,v/2)),r.scale(x,x,a.fromValues(o[0]/y,-v/b,1)),r.rotate(x,x,-h)},d._updateBufferData=function(e,t){const{x:r,y:i}=this._localOrigin,n=2*h*t.length,a=new Float32Array(n),s=new Uint32Array(8*t.length);let o=0,l=0;for(const u of t)u&&(a[2*o+0]=u[0]-r,a[2*o+1]=u[1]-i,a[2*o+2]=u[0]-r,a[2*o+3]=u[3]-i,a[2*o+4]=u[2]-r,a[2*o+5]=u[3]-i,a[2*o+6]=u[2]-r,a[2*o+7]=u[1]-i,s[l+0]=o+0,s[l+1]=o+3,s[l+2]=o+3,s[l+3]=o+2,s[l+4]=o+2,s[l+5]=o+1,s[l+6]=o+1,s[l+7]=o+0,o+=4,l+=8);if(this._vertexBuffer?this._vertexBuffer.setData(a.buffer):this._vertexBuffer=u.BufferObject.createVertex(e,c.Usage.DYNAMIC_DRAW,a.buffer),this._indexBuffer?this._indexBuffer.setData(s):this._indexBuffer=u.BufferObject.createIndex(e,c.Usage.DYNAMIC_DRAW,s),!this._vao){const t=p();this._vao=new f.VertexArrayObject(e,t.attributes,t.bufferLayouts,{geometry:this._vertexBuffer},this._indexBuffer)}},l}(o.DisplayObject);const p=()=>l.createProgramDescriptor("bounds",{geometry:[{location:0,name:"a_position",count:2,type:c.DataType.FLOAT}]});return d}));
