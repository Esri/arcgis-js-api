/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Collection","../../../core/CollectionFlattener","../../../core/maybe","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/accessorSupport/decorators/subclass","../../../rest/support/DirectionLine","../../../rest/support/DirectionPoint","../../../rest/support/PointBarrier","../../../rest/support/PolygonBarrier","../../../rest/support/PolylineBarrier","../../../rest/support/RouteInfo","../../../rest/support/Stop","./LayerView2D","./graphics/GraphicContainer","./graphics/GraphicsView2D","../../layers/LayerView"],(function(e,t,i,r,s,n,o,a,h,c,p,u,l,g,d,_,f,y,w,m,k){"use strict";const v=Object.freeze({remove(){},pause(){},resume(){}}),M=["route-info","direction-line","direction-point","polygon-barrier","polyline-barrier","point-barrier","stop"],V={graphic:null,property:null,oldValue:null,newValue:null};function G(e){return e instanceof p||e instanceof u||e instanceof l||e instanceof g||e instanceof d||e instanceof _||e instanceof f}function I(e){return i.isCollection(e)&&e.length&&G(e.getItemAt(0))}function F(e){return Array.isArray(e)&&e.length>0&&G(e[0])}let C=function(t){function o(){var e;return(e=t.apply(this,arguments)||this)._graphics=new i,e._highlightIds=new Map,e._networkFeatureMap=new Map,e._networkGraphicMap=new Map,e}e._inheritsLoose(o,t);var a=o.prototype;return a.initialize=function(){this.updatingHandles.addOnCollectionChange((()=>this._routeItems),(e=>this._routeItemsChanged(e)),n.initial)},a.destroy=function(){this._networkFeatureMap.clear(),this._networkGraphicMap.clear(),this._graphics.removeAll(),this._get("_routeItems")?.destroy()},a.attach=function(){this._createGraphicsView()},a.detach=function(){this._destroyGraphicsView()},a.fetchPopupFeatures=function(){var t=e._asyncToGenerator((function*(e){return this._graphicsView.hitTest(e).filter((e=>!!e.popupTemplate))}));function i(e){return t.apply(this,arguments)}return i}(),a.highlight=function(e){let t;t=G(e)?[this._getNetworkFeatureUid(e)]:F(e)?e.map((e=>this._getNetworkFeatureUid(e))):I(e)?e.map((e=>this._getNetworkFeatureUid(e))).toArray():[e.uid];const i=t.filter(s.isSome);return i.length?(this._addHighlight(i),{remove:()=>this._removeHighlight(i)}):v},a.hitTest=function(){var t=e._asyncToGenerator((function*(e,t){if(this.suspended)return null;const i=this._graphicsView.hitTest(e).filter(s.isSome).map((e=>this._networkGraphicMap.get(e)));if(!i.length)return null;const{layer:r}=this;return i.reverse().map((t=>({type:"route",layer:r,mapPoint:e,networkFeature:t})))}));function i(e,i){return t.apply(this,arguments)}return i}(),a.isUpdating=function(){return this._graphicsView.updating},a.moveStart=function(){},a.moveEnd=function(){},a.update=function(e){this._graphicsView.processUpdate(e)},a.viewChange=function(){this._graphicsView.viewChange()},a._addHighlight=function(e){for(const t of e)if(this._highlightIds.has(t)){const e=this._highlightIds.get(t);this._highlightIds.set(t,e+1)}else this._highlightIds.set(t,1);this._updateHighlight()},a._createGraphic=function(e){const t=e.toGraphic();return t.layer=this.layer,t.sourceLayer=this.layer,t},a._createGraphicsView=function(){const e=this.view,t=()=>this.requestUpdate(),i=new w(e.featuresTilingScheme);this._graphicsView=new m({container:i,graphics:this._graphics,requestUpdateCallback:t,view:e}),this.container.addChild(i),this._updateHighlight()},a._destroyGraphicsView=function(){this.container.removeChild(this._graphicsView.container),this._graphicsView.destroy()},a._getDrawOrder=function(e){const t=this._networkGraphicMap.get(e);return M.indexOf(t.type)},a._getNetworkFeatureUid=function(e){return this._networkFeatureMap.has(e)?this._networkFeatureMap.get(e).uid:null},a._removeHighlight=function(e){for(const t of e)if(this._highlightIds.has(t)){const e=this._highlightIds.get(t)-1;0===e?this._highlightIds.delete(t):this._highlightIds.set(t,e)}this._updateHighlight()},a._routeItemsChanged=function(e){if(e.removed.length){this._graphics.removeMany(e.removed.map((e=>{const t=this._networkFeatureMap.get(e);return this._networkFeatureMap.delete(e),this._networkGraphicMap.delete(t),t})));for(const t of e.removed)this.removeHandles(t)}if(e.added.length){this._graphics.addMany(e.added.map((e=>{const t=this._createGraphic(e);return s.isNone(t.symbol)?null:(this._networkFeatureMap.set(e,t),this._networkGraphicMap.set(t,e),t)})).filter(s.isSome));for(const t of e.added)this.addHandles([n.watch((()=>t.geometry),((e,i)=>{this._updateGraphic(t,"geometry",e,i)})),n.watch((()=>t.symbol),((e,i)=>{this._updateGraphic(t,"symbol",e,i)}))],t);this._graphics.sort(((e,t)=>this._getDrawOrder(e)-this._getDrawOrder(t)))}},a._updateGraphic=function(e,t,i,r){if(!this._networkFeatureMap.has(e)){const t=this._createGraphic(e);return this._networkFeatureMap.set(e,t),this._networkGraphicMap.set(t,e),void this._graphics.add(t)}const s=this._networkFeatureMap.get(e);s[t]=i,V.graphic=s,V.property=t,V.oldValue=r,V.newValue=i,this._graphicsView.graphicUpdateHandler(V)},a._updateHighlight=function(){const e=Array.from(this._highlightIds.keys());this._graphicsView.setHighlight(e)},e._createClass(o,[{key:"_routeItems",get:function(){return new r({getCollections:()=>s.isSome(this.layer)&&!this.destroyed?[s.isSome(this.layer.routeInfo)?new i([this.layer.routeInfo]):null,this.layer.directionLines,this.layer.directionPoints,this.layer.polygonBarriers,this.layer.polylineBarriers,this.layer.pointBarriers,this.layer.stops]:[]})}}]),o}(y.LayerView2DMixin(k));t.__decorate([o.property()],C.prototype,"_graphics",void 0),t.__decorate([o.property()],C.prototype,"_routeItems",null),C=t.__decorate([c.subclass("esri.views.2d.layers.RouteLayerView2D")],C);return C}));
