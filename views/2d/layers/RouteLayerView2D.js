/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../Graphic","../../../core/Collection","../../../core/maybe","../../../core/reactiveUtils","../../../core/Logger","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/set","../../../core/accessorSupport/decorators/subclass","./LayerView2D","./graphics/GraphicContainer","./graphics/GraphicsView2D","../../layers/LayerView"],(function(i,e,t,s,r,h,o,n,a,c,l,u,p,g,d,f){"use strict";const y=["routeInfo","directionLines","directionPoints","polygonBarriers","polylineBarriers","pointBarriers","stops"],_=Object.freeze({remove(){},pause(){},resume(){}});let w=function(e){function o(){var i;return(i=e.apply(this,arguments)||this)._graphicsViews=new Map,i._highlightIds=new Map,i}i._inheritsLoose(o,e);var n=o.prototype;return n.attach=function(){for(const i of y)this.handles.add(h.watch((()=>r.isSome(this.layer[i])?"routeInfo"===i?[r.unwrap(this.layer[i])]:r.unwrap(this.layer[i]).toArray():null),(e=>this._createGraphicsView(i,e)),h.initial),i)},n.detach=function(){this._destroyGraphicsViews()},n.highlight=function(i){let e;return"number"==typeof i?e=[i]:i instanceof t?e=[i.uid]:Array.isArray(i)&&i.length>0?e="number"==typeof i[0]?i:i.map((i=>i&&i.uid)):s.isCollection(i)&&(e=i.map((i=>i&&i.uid)).toArray()),e=e.filter((i=>null!=i)),e.length?(this._addHighlight(e),{remove:()=>this._removeHighlight(e)}):_},n.hitTest=function(){var e=i._asyncToGenerator((function*(i,e){if(this.suspended||!this._graphicsViews.size)return Promise.resolve(null);const t=Array.from(this._graphicsViews.values()).reverse().map((e=>e.hitTest(i))).flat().filter((i=>!!i));for(const s of t)s.layer=this.layer,s.sourceLayer=this.layer;return t}));function t(i,t){return e.apply(this,arguments)}return t}(),n.moveStart=function(){},n.moveEnd=function(){},n.update=function(i){for(const e of this._graphicsViews.values())e.processUpdate(i)},n.viewChange=function(){for(const i of this._graphicsViews.values())i.viewChange()},n.isUpdating=function(){for(const i of this._graphicsViews.values())if(i.updating)return!0;return!1},n._createGraphicsView=function(i,e){this._destroyGraphicsView(i);const o=this.view,n=()=>this.requestUpdate(),a=new s(r.isSome(e)?e.map((i=>{const{attributes:e,geometry:s,symbol:r,popupInfo:h}=i.toPortalJSON();return t.fromJSON({attributes:e,geometry:s,symbol:r,popupTemplate:h})})):[]),c=new g(o.featuresTilingScheme),l=new d({container:c,graphics:a,requestUpdateCallback:n,view:o});this._graphicsViews.set(i,l),this.container.addChildAt(c,y.indexOf(i)),this._updateHighlight(),this.handles.add([h.watch((()=>l.updating),(()=>this.notifyChange("updating")),h.initial)],`updating-${i}`)},n._destroyGraphicsView=function(i){if(!this._graphicsViews.has(i))return;const e=this._graphicsViews.get(i);this.container.removeChild(e.container),e.destroy(),this.handles.remove(`updating-${i}`),this._graphicsViews.delete(i)},n._destroyGraphicsViews=function(){this.container.removeAllChildren();for(const[i,e]of this._graphicsViews.entries())this.handles.remove(i),e.destroy();this._graphicsViews.clear()},n._addHighlight=function(i){for(const e of i)if(this._highlightIds.has(e)){const i=this._highlightIds.get(e);this._highlightIds.set(e,i+1)}else this._highlightIds.set(e,1);this._updateHighlight()},n._removeHighlight=function(i){for(const e of i)if(this._highlightIds.has(e)){const i=this._highlightIds.get(e)-1;0===i?this._highlightIds.delete(e):this._highlightIds.set(e,i)}this._updateHighlight()},n._updateHighlight=function(){const i=Array.from(this._highlightIds.keys());for(const e of this._graphicsViews.values())e.setHighlight(i)},o}(p.LayerView2DMixin(f));w=e.__decorate([u.subclass("esri.views.2d.layers.RouteLayerView2D")],w);return w}));
