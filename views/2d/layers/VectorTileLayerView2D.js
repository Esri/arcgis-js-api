// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../Graphic","../../../core/Error","../../../core/Handles","../../../core/Logger","../../../core/promiseUtils","../../../core/accessorSupport/decorators","../../../geometry/support/aaBoundingRect","../engine/vectorTiles/TileHandler","../engine/vectorTiles/TileManager","../engine/vectorTiles/VectorTile","../engine/vectorTiles/VectorTileContainer","./LayerView2D","../tiling/TileInfoViewPOT","../tiling/TileQueue","../../layers/LayerView"],(function(e,t,i,r,n,a,o,l,s,u,h,c,d,p,_,f,y,v){"use strict";var g=o.getLogger("esri.views.2d.layers.VectorTileLayerView2D");return function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._handles=new a,t._fetchQueue=null,t._parseQueue=null,t._isTileHandlerPromiseFulfilled=!1,t.fading=!1,t}return i.__extends(t,e),t.prototype.initialize=function(){var e=this,t=this.layer.tileInfo;(t&&t.spatialReference).equals(this.view.spatialReference)?(this._tileInfoView=new f(this.layer.tileInfo,this.layer.fullExtent),this._vectorTileContainer=new p.VectorTileContainer(this._tileInfoView),this._tileHandler=new h.TileHandler(this.layer,window.devicePixelRatio||1,null),this.container.addChild(this._vectorTileContainer),this.handles.add([this._vectorTileContainer.on("updating-change",(function(){return e.notifyChange("updating")})),this.watch("layer.currentStyleInfo",(function(){return e._start()})),this._vectorTileContainer.on("fade-start",(function(){e.fading=!0})),this._vectorTileContainer.on("fade-complete",(function(){e.fading=!1,e.requestUpdate()}))])):this.addResolvingPromise(l.reject(new n("layerview:spatial-reference-incompatible","The spatial reference of this layer does not meet the requirements of the view",{layer:this.layer})))},t.prototype.destroy=function(){var e,t;this._stop(),this.container.removeAllChildren(),null===(e=this._vectorTileContainer)||void 0===e||e.destroy(),this._vectorTileContainer=null,null===(t=this._tileHandler)||void 0===t||t.destroy(),this._tileHandler=null},t.prototype.hitTest=function(e,t){return i.__awaiter(this,void 0,void 0,(function(){var n,a,o,l,s;return i.__generator(this,(function(i){switch(i.label){case 0:return this.suspended||!this._tileHandlerPromise?[2,null]:[4,this._tileHandlerPromise];case 1:return i.sent(),[4,this._vectorTileContainer.hitTest(e,t)];case 2:return(n=i.sent())&&0!==n.length?(a=n[0]-1,o=this._tileHandler.getStyleRepository().layers,a>=o.length?[2,null]:(l=o[a],(s=new r({attributes:{layerId:a,layerName:l.id}})).layer=this.layer,s.sourceLayer=this.layer,[2,s])):[2,null]}}))}))},t.prototype.update=function(e){if(this._tileHandlerPromise&&this._isTileHandlerPromiseFulfilled){if(e.pixelRatio!==this._tileHandler.devicePixelRatio)return this._start(),void(this._tileHandler.devicePixelRatio=e.pixelRatio);this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.state=e.state,this._parseQueue.state=e.state,this._tileManager.update(e)||this.requestUpdate(),this._parseQueue.resume(),this._fetchQueue.resume()}},t.prototype.attach=function(){var e=this;this._start(),this._handles.add([this.layer.on("paint-change",(function(){e._vectorTileContainer.restartDeclutter(),e._vectorTileContainer.requestRender()})),this.layer.on("layout-change",(function(){e._vectorTileContainer.enterTileInvalidation(),e._issueStyleInvalidation(),e.notifyChange("updating"),e.requestUpdate()}))])},t.prototype.detach=function(){this._stop(),this._handles.removeAll()},t.prototype.moveStart=function(){this.requestUpdate()},t.prototype.viewChange=function(){this.requestUpdate()},t.prototype.moveEnd=function(){this.requestUpdate()},t.prototype.canResume=function(){var t=e.prototype.canResume.call(this),i=this.layer;if(t&&i.currentStyleInfo){var r=this.view.scale,n=i.currentStyleInfo;if(n&&n.layerDefinition){var a=n.layerDefinition;a.minScale&&a.minScale<r&&(t=!1),a.maxScale&&a.maxScale>r&&(t=!1)}}return t},t.prototype.isUpdating=function(){var e,t,i,r,n=this._vectorTileContainer.children;return!this._isTileHandlerPromiseFulfilled||null!==(t=null===(e=this._fetchQueue)||void 0===e?void 0:e.updating)&&void 0!==t&&t||null!==(r=null===(i=this._parseQueue)||void 0===i?void 0:i.updating)&&void 0!==r&&r||n.length>0&&n.filter((function(e){return e.invalidating})).length>0||this.fading},t.prototype.acquireTile=function(e){var t=this,i=this._createVectorTile(e);return this._tileHandlerPromise.then((function(){t.notifyChange("updating"),t.updateTile(i)})),i},t.prototype.updateTile=function(e){var t=this;e.key&&this._fetchQueue.push(e.key).then((function(i){return t._parseQueue.push({key:e.key,data:i})})).then((function(i){e.once("attach",(function(){return t.requestUpdate()})),i&&(e.setData(i.tileData),t.requestUpdate(),t.notifyChange("updating"))})).catch((function(e){t.notifyChange("updating"),l.isAbortError(e)||g.error(e)}))},t.prototype.releaseTile=function(e){var t=e.key.id;this._fetchQueue.abort(t),this._parseQueue.abort(t),this.requestUpdate()},t.prototype._start=function(){var e=this;if(this._stop(),this._tileManager=new c.TileManager({acquireTile:function(t){return e.acquireTile(t)},releaseTile:function(t){return e.releaseTile(t)},tileInfoView:this._tileInfoView},this._vectorTileContainer),this.layer.currentStyleInfo){var t=new AbortController,i=this._tileHandler.start({signal:t.signal}).then((function(){e._fetchQueue=new y({tileInfoView:e._tileInfoView,process:function(t,i){return e._getTileData(t,i)},concurrency:15}),e._parseQueue=new y({tileInfoView:e._tileInfoView,process:function(t,i){return e._parseTileData(t,i)},concurrency:8}),e.requestUpdate(),e._isTileHandlerPromiseFulfilled=!0}));this._tileHandler.spriteMosaic.then((function(t){e._vectorTileContainer.setStyleResources(t,e._tileHandler.glyphMosaic,e.layer.styleRepository),e.requestUpdate()})),this._tileHandlerAbortController=t,this._tileHandlerPromise=i}},t.prototype._stop=function(){if(this._tileHandlerAbortController&&this._vectorTileContainer){var e=this._tileHandlerAbortController;e&&e.abort(),this._tileHandlerPromise=null,this._isTileHandlerPromiseFulfilled=!1,this._fetchQueue&&(this._fetchQueue.destroy(),this._fetchQueue=null),this._parseQueue&&(this._parseQueue.destroy(),this._parseQueue=null),this._tileManager&&(this._tileManager.destroy(),this._tileManager=null),this._vectorTileContainer.removeAllChildren()}},t.prototype._getTileData=function(e,t){return i.__awaiter(this,void 0,void 0,(function(){var r;return i.__generator(this,(function(i){switch(i.label){case 0:return[4,this._tileHandler.fetchTileData(e,t)];case 1:return r=i.sent(),this.notifyChange("updating"),[2,r]}}))}))},t.prototype._parseTileData=function(e,t){return i.__awaiter(this,void 0,void 0,(function(){return i.__generator(this,(function(i){return[2,this._tileHandler.parseTileData(e,t)]}))}))},t.prototype._issueStyleInvalidation=function(){var e=this;this.notifyChange("updating"),this._tileHandlerAbortController.abort(),this._tileHandlerAbortController=l.createAbortController();var t=this._tileHandlerAbortController.signal;this._tileHandlerPromise=this._tileHandler.updateStyle().then((function(){t.aborted||e._tileHandler.spriteMosaic.then((function(i){t.aborted||(e._vectorTileContainer.setStyleResources(i,e._tileHandler.glyphMosaic,e.layer.styleRepository),e._updateTiles())}))}))},t.prototype._updateTiles=function(){this._tileManager.clearCache(),this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.clear(),this._parseQueue.clear();for(var e=0,t=this._vectorTileContainer.children;e<t.length;e++){var i=t[e];this.updateTile(i)}this._parseQueue.resume(),this._fetchQueue.resume(),this.notifyChange("updating"),this.requestUpdate()},t.prototype._createVectorTile=function(e){var t=this._tileInfoView.getTileBounds(u.create(),e);return new d.VectorTile(e,this.layer.styleRepository,t,[512,512])},i.__decorate([s.property()],t.prototype,"_fetchQueue",void 0),i.__decorate([s.property()],t.prototype,"_parseQueue",void 0),i.__decorate([s.property()],t.prototype,"_isTileHandlerPromiseFulfilled",void 0),i.__decorate([s.property({dependsOn:["view.scale","layer.currentStyleInfo"]})],t.prototype,"suspended",void 0),i.__decorate([s.property()],t.prototype,"fading",void 0),i.__decorate([s.property({dependsOn:["_isTileHandlerPromiseFulfilled","_parseQueue.updating","_parseQueue.updating","fading"]})],t.prototype,"updating",void 0),t=i.__decorate([s.subclass("esri.views.2d.layers.VectorTileLayerView2D")],t)}(_.LayerView2DMixin(v))}));