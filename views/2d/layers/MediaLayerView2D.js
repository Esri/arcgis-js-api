/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../geometry","../../../Graphic","../../../renderers/ClassBreaksRenderer","../../../renderers/DictionaryRenderer","../../../renderers/DotDensityRenderer","../../../renderers/HeatmapRenderer","../../../renderers/PieChartRenderer","../../../renderers/Renderer","../../../renderers/SimpleRenderer","../../../renderers/UniqueValueRenderer","../../../renderers/support/jsonUtils","../../../symbols","../../../core/Collection","../../../core/has","../../../core/Logger","../../../core/MapUtils","../../../core/maybe","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/accessorSupport/decorators/subclass","../../../geometry/support/aaBoundingRect","../../../geometry/support/contains","../../../geometry/support/intersectsBase","../../../layers/support/MediaElementView","../../../core/Error","../../../core/scheduling","../../../request","../../../chunks/index3","../../../core/urlUtils","../../../chunks/index4","../../../layers/effects/EffectView","../engine/DisplayObject","../engine/webgl/effects/highlight/HighlightGradient","../engine/webgl/BufferPool","../engine/webgl/enums","../engine/webgl/brushes/BrushBitmap","../../../chunks/vec4f32","../engine/webgl/Utils","../engine/webgl/shaders/BackgroundPrograms","../../webgl/enums","../../webgl/checkWebGLError","../../webgl/context-util","../../../chunks/builtins","../../../core/RandomLCG","../engine/webgl/materialKey/MaterialKey","../engine/webgl/techniques/Technique","../engine/webgl/techniques/dotDensity/TechniqueDotDensity","../engine/webgl/techniques/heatmap/TechniqueHeatmap","../engine/webgl/techniques/pieChart/TechniquePieChart","../../webgl/BufferObject","../../webgl/FramebufferObject","../../webgl/Texture","../../webgl/VertexArrayObject","../engine/webgl/brushes/WGLBrushHeatmap","../engine/webgl/DefaultVertexAttributeLayouts","../engine/webgl/shaders/TileInfoPrograms","../engine/webgl/brushes/WGLGeometryBrushMarker","../../../core/mathUtils","../engine/webgl/number","../engine/vectorTiles/style/StyleDefinition","../../../chunks/vec2f32","../engine/vectorTiles/enums","../engine/vectorTiles/shaders/sources/resolver","../engine/webgl/shaders/BitBlitPrograms","../engine/webgl/shaders/sources/resolver","../engine/webgl/TextureManager","../engine/webgl/shaders/StencilPrograms","../engine/webgl/effects/BlendEffect","../engine/webgl/shaders/HighlightPrograms","../engine/webgl/Profiler","../../webgl/renderState","../../3d/webgl-engine/core/shaderModules/interfaces","../../../core/floatRGBA","../../3d/webgl-engine/lib/OrderIndependentTransparency","../../../chunks/webgl-debug","../LabelManager","./graphics/GraphicsView2D","../engine/webgl/AttributeStoreView","../../../chunks/earcut","../../../layers/graphics/featureConversionUtils","../../../core/unitUtils","../../../renderers/support/lengthUtils","../../../chunks/vec3f32","../../../geometry/support/normalizeUtils","../navigation/MapViewNavigation","../../../core/asyncUtils","../engine/webgl/shaders/MagnifierPrograms","../tiling/PagedTileQueue","../tiling/TileInfoView","../tiling/TileKey","../tiling/TileQueue","../tiling/TileStrategy","../engine/webgl/Overlay","../engine/webgl/OverlayContainer","./LayerView2D","../../layers/LayerView","../../../geometry/Extent"],(function(e,t,r,n,i,s,o,l,a,c,u,h,d,g,f,p,m,y,w,b,_,v,T,E,R,S,C,G,U,V,q,x,k,B,P,M,D,L,j,H,A,O,Q,z,I,N,K,W,F,J,X,Y,Z,$,ee,te,re,ne,ie,se,oe,le,ae,ce,ue,he,de,ge,fe,pe,me,ye,we,be,_e,ve,Te,Ee,Re,Se,Ce,Ge,Ue,Ve,qe,xe,ke,Be,Pe,Me,De,Le,je,He,Ae,Oe,Qe,ze,Ie,Ne,Ke,We){"use strict";let Fe=function(t){function r(){var e;return(e=t.apply(this,arguments)||this)._overlayContainer=null,e._fetchQueue=null,e._tileStrategy=null,e._elementReferences=new Map,e._debugGraphicsView=null,e.layer=null,e.elements=new f,e}e._inheritsLoose(r,t);var n=r.prototype;return n.attach=function(){this.addAttachHandles([_.on((()=>this.layer.effectiveSource),"refresh",(()=>{for(const e of this._tileStrategy.tiles)this._updateTile(e);this.requestUpdate()})),_.on((()=>this.layer.effectiveSource),"change",(({element:e})=>this._elementUpdateHandler(e)))]),this._overlayContainer=new Ie,this.container.addChild(this._overlayContainer),this._fetchQueue=new Oe({tileInfoView:this.view.featuresTilingScheme,concurrency:10,process:(e,t)=>this._queryElements(e,t)}),this._tileStrategy=new Qe({cachePolicy:"purge",resampling:!0,acquireTile:e=>this._acquireTile(e),releaseTile:e=>this._releaseTile(e),tileInfoView:this.view.featuresTilingScheme}),this.requestUpdate()},n.detach=function(){this.elements.removeAll(),this._tileStrategy.destroy(),this._fetchQueue.destroy(),this._overlayContainer.removeAllChildren(),this.container.removeAllChildren(),this._elementReferences.clear(),this._debugGraphicsView?.destroy()},n.supportsSpatialReference=function(e){return!0},n.moveStart=function(){this.requestUpdate()},n.viewChange=function(){this.requestUpdate()},n.moveEnd=function(){this.requestUpdate()},n.update=function(e){this._tileStrategy.update(e),this._debugGraphicsView?.update(e)},n.hitTest=function(){var t=e._asyncToGenerator((function*(e,t){const r=[],n=e.normalize(),i=[n.x,n.y];for(const{projectedElement:{normalizedCoords:s,element:o}}of this._elementReferences.values())w.isSome(s)&&C.ringsContainsCoords(s.rings,i)&&r.push({type:"media",element:o,layer:this.layer,mapPoint:e});return r.reverse()}));function r(e,r){return t.apply(this,arguments)}return r}(),n.canResume=function(){return null!=this.layer.source&&t.prototype.canResume.call(this)},n.doRefresh=function(){var t=e._asyncToGenerator((function*(){this._fetchQueue.reset(),this._tileStrategy.tiles.forEach((e=>this._updateTile(e)))}));function r(){return t.apply(this,arguments)}return r}(),n._acquireTile=function(e){const t=new Ze(e.clone());return this._updateTile(t),t},n._updateTile=function(e){this.updatingHandles.addPromise(this._fetchQueue.push(e.key).then((t=>{const[r,n]=e.setElements(t);this._referenceElements(e,r),this._dereferenceElements(e,n),this.requestUpdate()}),(e=>{b.isAbortError(e)||m.getLogger(this.declaredClass).error(e)})))},n._releaseTile=function(e){this._fetchQueue.abort(e.key.id),e.elements&&this._dereferenceElements(e,e.elements),this.requestUpdate()},n._queryElements=function(){var t=e._asyncToGenerator((function*(e,t){const r=this.layer.effectiveSource;if(w.isNone(r))return[];this.view.featuresTilingScheme.getTileBounds(Je,e,!0);const n=new We({xmin:Je[0],ymin:Je[1],xmax:Je[2],ymax:Je[3],spatialReference:this.view.spatialReference});return r.queryElements(n,t)}));function r(e,r){return t.apply(this,arguments)}return r}(),n._referenceElements=function(e,t){const r=this.layer.source;if(!w.isNone(r))for(const n of t)this._referenceElement(e,n)},n._referenceElement=function(e,t){y.getOrCreateMapValue(this._elementReferences,t.uid,(()=>{const e=new U.MediaElementView({element:t,spatialReference:this.view.spatialReference}),r=new ze(e);this._overlayContainer.addChild(r),this.elements.add(t);let n=null;return{tiles:new Set,projectedElement:e,overlay:r,debugGraphic:n}})).tiles.add(e)},n._dereferenceElements=function(e,t){for(const r of t)this._dereferenceElement(e,r)},n._dereferenceElement=function(e,t){const r=this._elementReferences.get(t.uid);r.tiles.delete(e),r.tiles.size||(this._overlayContainer.removeChild(r.overlay),r.overlay.destroy(),r.projectedElement.destroy(),this._elementReferences.delete(t.uid),this.elements.remove(t),this._debugGraphicsView?.graphics.remove(r.debugGraphic))},n._elementUpdateHandler=function(e){let t=this._elementReferences.get(e.uid);if(t){const r=t.projectedElement.normalizedCoords;if(w.isNone(r))return this._overlayContainer.removeChild(t.overlay),t.overlay.destroy(),t.projectedElement.destroy(),this._elementReferences.delete(e.uid),this.elements.remove(e),void this._debugGraphicsView?.graphics.remove(t.debugGraphic);const n=[],i=[];for(const e of this._tileStrategy.tiles){const s=Ye(this.view.featuresTilingScheme,e,r);t.tiles.has(e)?s||i.push(e):s&&n.push(e)}for(const t of n)this._referenceElement(t,e);for(const t of i)this._dereferenceElement(t,e);return t=this._elementReferences.get(e.uid),void(t?.debugGraphic&&(t.debugGraphic.geometry=t.projectedElement.normalizedCoords,this._debugGraphicsView.graphicUpdateHandler({graphic:t.debugGraphic,property:"geometry"})))}const r=new U.MediaElementView({element:e,spatialReference:this.view.spatialReference}).normalizedCoords;if(w.isSome(r))for(const n of this._tileStrategy.tiles){Ye(this.view.featuresTilingScheme,n,r)&&this._referenceElement(n,e)}},r}(Ne.LayerView2DMixin(Ke));t.__decorate([v.property()],Fe.prototype,"_fetchQueue",void 0),t.__decorate([v.property()],Fe.prototype,"layer",void 0),t.__decorate([v.property({readOnly:!0})],Fe.prototype,"elements",void 0),Fe=t.__decorate([R.subclass("esri.views.2d.layers.MediaLayerView2D")],Fe);const Je=S.create(),Xe={xmin:0,ymin:0,xmax:0,ymax:0};function Ye(e,t,r){return e.getTileBounds(Je,t.key,!0),Xe.xmin=Je[0],Xe.ymin=Je[1],Xe.xmax=Je[2],Xe.ymax=Je[3],G.extentIntersectsPolygon(Xe,r)}let Ze=function(){function e(e){this.key=e,this.elements=null,this.isReady=!1,this.visible=!0}var t=e.prototype;return t.setElements=function(e){const t=[],r=new Set(this.elements);this.elements=e;for(const n of e)r.has(n)?r.delete(n):t.push(n);return this.isReady=!0,[t,Array.from(r)]},t.destroy=function(){},e}();return Fe}));
