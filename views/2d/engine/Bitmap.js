/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/maybe","../../../chunks/mat3","../../../chunks/mat3f32","../../../chunks/vec2f32","../../webgl/BufferObject","../../webgl/FramebufferObject","../../../core/has","../../webgl/checkWebGLError","../../webgl/enums","../../../chunks/builtins","../../webgl/renderState","../../webgl/Texture","../../webgl/VertexArrayObject","./DisplayObject","./ImageryBitmapSource"],(function(e,t,i,r,s,n,u,h,o,a,c,l,d,f,_,g,x){"use strict";function m(e){return e&&"render"in e}function p(e){return e&&!("render"in e)}function b(e){const t=document.createElement("canvas");return t.width=e.width,t.height=e.height,e.render(t.getContext("2d")),t}function v(e,t,i){const r={target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071};return t&&i&&(r.width=t,r.height=i),new f(e,r)}let y=function(e){function u(i=null,r,s=!0){var n;return(n=e.call(this)||this).requestRenderOnSourceChangedEnabled=s,n._textureInvalidated=!0,n.stencilRef=0,n.coordScale=[1,1],n._height=void 0,n.pixelRatio=1,n.resolution=0,n.rotation=0,n._source=null,n._width=void 0,n.x=0,n.y=0,n.blendFunction=r,n.source=i,n.requestRender=n.requestRender.bind(t._assertThisInitialized(n)),n}t._inheritsLoose(u,e);var h=u.prototype;return h.destroy=function(){this._texture&&(this._texture.dispose(),this._texture=null)},h.beforeRender=function(t){e.prototype.beforeRender.call(this,t),this.updateTexture(t.context)},h.invalidateTexture=function(){this._textureInvalidated||(this._textureInvalidated=!0,this.requestRenderOnSourceChangedEnabled&&this.requestRender())},h._createTransforms=function(){return{dvs:s.create()}},h.setTransform=function(e){const t=r.identity(this.transforms.dvs),[i,s]=e.toScreenNoRotation([0,0],[this.x,this.y]),u=this.resolution/this.pixelRatio/e.resolution,h=u*this.width,o=u*this.height,a=Math.PI*this.rotation/180;r.translate(t,t,n.fromValues(i,s)),r.translate(t,t,n.fromValues(h/2,o/2)),r.rotate(t,t,-a),r.translate(t,t,n.fromValues(-h/2,-o/2)),r.scaleByVec2(t,t,n.fromValues(h,o)),r.multiply(this.transforms.dvs,e.displayViewMat3,t)},h.setSamplingProfile=function(e){this._texture&&(e.mips&&!this._texture.descriptor.hasMipmap&&this._texture.generateMipmap(),this._texture.setSamplingMode(e.samplingMode))},h.bind=function(e,t){this._texture&&e.bindTexture(this._texture,t)},h.updateTexture=function(e){var t;if(!this.stage)return null==(t=this._texture)||t.dispose(),void(this._texture=null);if(!this._textureInvalidated)return;this._textureInvalidated=!1,this._texture||(this.source?this._texture=v(e,this.sourceWidth,this.sourceHeight):this._texture=v(e));const r=this.source;if(r){if(this._texture.resize(this.sourceWidth,this.sourceHeight),m(r))if(r instanceof x){const e=r.getRenderedRasterPixels();this._texture.setData(i.isSome(e)?e.renderedRasterPixels:null)}else this._texture.setData(b(r));else p(r)&&this._texture.setData(r);this.ready()}else this._texture.setData(null)},h.onAttach=function(){this.invalidateTexture()},h.onDetach=function(){this.invalidateTexture()},t._createClass(u,[{key:"isSourceScaled",get:function(){return this.width!==this.sourceWidth||this.height!==this.sourceHeight}},{key:"height",get:function(){return void 0!==this._height?this._height:this.sourceHeight},set:function(e){this._height=e}},{key:"source",get:function(){return this._source},set:function(e){this._source=e,this.invalidateTexture()}},{key:"sourceHeight",get:function(){return this._source instanceof HTMLImageElement?this._source.naturalHeight:this._source.height}},{key:"sourceWidth",get:function(){return this._source instanceof HTMLImageElement?this._source.naturalWidth:this._source.width}},{key:"width",get:function(){return void 0!==this._width?this._width:this.sourceWidth},set:function(e){this._width=e}}]),u}(g.DisplayObject);e.Bitmap=y,e.isImageSource=m,e.rasterize=b,Object.defineProperty(e,"__esModule",{value:!0})}));
