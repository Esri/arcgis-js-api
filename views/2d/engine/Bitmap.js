/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/maybe","../../../core/promiseUtils","../../../chunks/mat3","../../../chunks/mat3f32","../../../chunks/vec2f32","./DisplayObject","./ImageryBitmapSource","../../webgl/context-util","../../webgl/enums","../../webgl/Texture"],(function(t,e,i,r,s,n,o,u,a,h,l,c){"use strict";function d(t){return t&&"render"in t}function _(t){const e=document.createElement("canvas");return e.width=t.width,e.height=t.height,t.render(e.getContext("2d")),e}function p(t){return d(t)?t instanceof a?i.applySome(t.getRenderedRasterPixels(),(t=>t.renderedRasterPixels)):_(t):t}let f=function(t){function u(i=null,r){var s;return(s=t.call(this)||this).blendFunction="standard",s._sourceWidth=0,s._sourceHeight=0,s._textureInvalidated=!1,s.stencilRef=0,s.coordScale=[1,1],s._height=void 0,s.pixelRatio=1,s.resolution=0,s.rotation=0,s._source=null,s._width=void 0,s.x=0,s.y=0,s.immutable=r.immutable??!1,s.requestRenderOnSourceChangedEnabled=r.requestRenderOnSourceChangedEnabled??!0,s.source=i,s.requestRender=s.requestRender.bind(e._assertThisInitialized(s)),s}e._inheritsLoose(u,t);var a=u.prototype;return a.destroy=function(){this._texture&&(this._texture.dispose(),this._texture=null),i.isSome(this._uploadStatus)&&(this._uploadStatus.controller.abort(),this._uploadStatus=null)},a.beforeRender=function(e){t.prototype.beforeRender.call(this,e),this.updateTexture(e)},a.setSourceAsync=function(){var t=e._asyncToGenerator((function*(t,e){i.isSome(this._uploadStatus)&&this._uploadStatus.controller.abort();const s=new AbortController,n=r.createResolver();return r.onAbortOrThrow(e,(()=>s.abort())),r.onAbortOrThrow(s,(t=>n.reject(t))),this._uploadStatus={controller:s,resolver:n},this.source=t,n.promise}));function s(e,i){return t.apply(this,arguments)}return s}(),a.invalidateTexture=function(){this._textureInvalidated||(this._textureInvalidated=!0,this.requestRenderOnSourceChangedEnabled&&this.requestRender())},a.updateTransitionProperties=function(e,i){e>=64&&(this.fadeTransitionEnabled=!1,this.inFadeTransition=!1),t.prototype.updateTransitionProperties.call(this,e,i)},a.setTransform=function(t){const e=s.identity(this.transforms.dvs),[i,r]=t.toScreenNoRotation([0,0],[this.x,this.y]),n=this.resolution/this.pixelRatio/t.resolution,u=n*this.width,a=n*this.height,h=Math.PI*this.rotation/180;s.translate(e,e,o.fromValues(i,r)),s.translate(e,e,o.fromValues(u/2,a/2)),s.rotate(e,e,-h),s.translate(e,e,o.fromValues(-u/2,-a/2)),s.scaleByVec2(e,e,o.fromValues(u,a)),s.multiply(this.transforms.dvs,t.displayViewMat3,e)},a.setSamplingProfile=function(t){this._texture&&(t.mips&&!this._texture.descriptor.hasMipmap&&this._texture.generateMipmap(),this._texture.setSamplingMode(t.samplingMode))},a.bind=function(t,e){this._texture&&t.bindTexture(this._texture,e)},a.updateTexture=function(){var t=e._asyncToGenerator((function*({context:t,painter:e}){if(!this._textureInvalidated)return;if(this._textureInvalidated=!1,this._texture||(this._texture=this._createTexture(t)),!this.source)return void this._texture.setData(null);this._texture.resize(this._sourceWidth,this._sourceHeight);const s=p(this.source);try{if(i.isSome(this._uploadStatus)){const{controller:t,resolver:i}=this._uploadStatus,r={signal:t.signal},{width:n,height:o}=this,u=this._texture,a=e.textureUploadManager;yield a.enqueueTextureUpdate({data:s,texture:u,width:n,height:o},r),i.resolve(),this._uploadStatus=null}else this._texture.setData(s);this.ready()}catch(n){r.throwIfNotAbortError(n)}}));function s(e){return t.apply(this,arguments)}return s}(),a.onDetach=function(){this.destroy()},a._createTransforms=function(){return{dvs:n.create()}},a._createTexture=function(t){const e=this.immutable&&t.type===h.ContextType.WEBGL2;return new c.Texture(t,{target:l.TextureType.TEXTURE_2D,pixelFormat:l.PixelFormat.RGBA,internalFormat:e?l.SizedPixelFormat.RGBA8:l.PixelFormat.RGBA,dataType:l.PixelType.UNSIGNED_BYTE,wrapMode:l.TextureWrapMode.CLAMP_TO_EDGE,isImmutable:e,width:this._sourceWidth,height:this._sourceHeight})},e._createClass(u,[{key:"isSourceScaled",get:function(){return this.width!==this._sourceWidth||this.height!==this._sourceHeight}},{key:"height",get:function(){return void 0!==this._height?this._height:this._sourceHeight},set:function(t){this._height=t}},{key:"source",get:function(){return this._source},set:function(t){null==t&&null==this._source||(this._source=t,this._source instanceof HTMLImageElement?(this._sourceHeight=this._source.naturalHeight,this._sourceWidth=this._source.naturalWidth):(this._sourceHeight=this._source.height,this._sourceWidth=this._source.width),this.invalidateTexture())}},{key:"width",get:function(){return void 0!==this._width?this._width:this._sourceWidth},set:function(t){this._width=t}}]),u}(u.DisplayObject);t.Bitmap=f,t.isImageSource=d,t.rasterize=_,Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
