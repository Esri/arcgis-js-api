/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/Error","../../../core/events","../../../core/has","../../../core/maybe","../../../core/reactiveUtils","../../../core/scheduling","../../../chunks/mat3f32","../../../symbols/cim/CIMResourceManager","./Container","./webgl/BufferPool","./webgl/enums","./webgl/Painter","./webgl/Profiler","../support/Timeline","../../support/screenshotUtils","../../webgl/context-util","../../webgl/enums","../../webgl/FramebufferObject","../../webgl/RenderingContext","../../../core/imageUtils"],(function(e,t,r,i,n,s,a,o,h,d,l,u,c,p,f,g,_,m,b,y,w,R){"use strict";const T=2e3;let P=function(e){function P(a,h){var l;(l=e.call(this)||this)._trash=new Set,l._renderRemainingTime=0,l._lastFrameRenderTime=0,l.renderRequested=!1,l.stage=t._assertThisInitialized(l),l._stationary=!0;const{canvas:c=document.createElement("canvas"),alpha:_=!0,stencil:b=!0,contextOptions:y={}}=h;l._canvas=c;const R={alpha:_,antialias:!1,depth:!0,stencil:b},T=m.createContextOrErrorHTML("2d",c,R);return l.context=new w.RenderingContext(s.isSome(T)?T:null,y),l.resourceManager=new d,l.painter=new p(l.context,t._assertThisInitialized(l),l.resourceManager),n("esri-2d-profiler")&&(l._debugOutput=document.createElement("div"),l._debugOutput.setAttribute("style","margin: 24px 64px; position: absolute; color: red;"),a.appendChild(l._debugOutput)),l._renderParameters={drawPhase:0,state:l.state,pixelRatio:window.devicePixelRatio,stationary:!1,globalOpacity:1,blendMode:null,deltaTime:-1,time:0,inFadeTransition:!1,effects:null,context:l.context,painter:l.painter,timeline:h.timeline||new g.Timeline,renderingOptions:h.renderingOptions,requestRender:()=>l.requestRender(),allowDelayedRender:!1,requireFBO:!1,profiler:new f.Profiler(l.context,l._debugOutput),dataUploadCounter:0},l._taskHandle=o.addFrameTask({render:e=>l.renderFrame(e)}),l._taskHandle.pause(),l._lostWebGLContextHandle=i.on(c,"webglcontextlost",(()=>{l.emit("webgl-error",{error:new r("webgl-context-lost")})})),l._bufferPool=new u.BufferPool,c.setAttribute("style","width: 100%; height:100%; display:block;"),a.appendChild(c),l}t._inheritsLoose(P,e);var x=P.prototype;return x.destroy=function(){this.removeAllChildren(),this._emptyTrash(),this._taskHandle.remove(),this._taskHandle=null,this._lostWebGLContextHandle&&(this._lostWebGLContextHandle.remove(),this._lostWebGLContextHandle=null),this._canvas.parentNode&&this._canvas.parentNode.removeChild(this._canvas),this._debugOutput&&this._debugOutput.parentNode&&this._debugOutput.parentNode.removeChild(this._debugOutput),this._bufferPool.destroy(),this.highlightOptions=null,this.resourceManager.destroy(),this.painter.dispose(),this.context.dispose(),this._canvas=null},x.trashDisplayObject=function(e){this._trash.add(e),this.requestRender()},x.untrashDisplayObject=function(e){return this._trash.delete(e)},x.requestRender=function(){this._renderRemainingTime=T,this.renderRequested||(this.renderRequested=!0,this.emit("will-render"),this._taskHandle.resume())},x.renderFrame=function(e){const t=this._lastFrameRenderTime?e.time-this._lastFrameRenderTime:0;this._renderRemainingTime-=t,this._renderRemainingTime<=0&&this._taskHandle.pause(),this._lastFrameRenderTime=e.time,this.renderRequested=!1,this._renderParameters.state=this._state,this._renderParameters.stationary=this.stationary,this._renderParameters.pixelRatio=window.devicePixelRatio,this._renderParameters.globalOpacity=1,this._renderParameters.time=e.time,this._renderParameters.deltaTime=e.deltaTime,this._renderParameters.effects=null,this.processRender(this._renderParameters),this._emptyTrash(),this.emit("post-render")},x._createTransforms=function(){return{dvs:h.create()}},x.renderChildren=function(e){for(const t of this.children)t.beforeRender(e);this._renderChildren(this.children,e);for(const t of this.children)t.afterRender(e)},x._renderChildren=function(e,t){const r=this.context;this.painter.textureUploadManager.upload(),r.resetInfo(),t.profiler.recordStart("drawLayers"),t.dataUploadCounter=0,t.drawPhase=c.WGLDrawPhase.MAP,this.painter.beforeRenderLayers(r,this.background);for(const i of e)i.processRender(t);this.painter.prepareDisplay(t,this.background,this.state.padding),this.painter.renderLayers(r),t.drawPhase=c.WGLDrawPhase.HIGHLIGHT,this.painter.beforeRenderLayers(r);for(const i of e)i.processRender(t);this.painter.renderLayers(r);if(this._isLabelDrawPhaseRequired(e)){t.drawPhase=c.WGLDrawPhase.LABEL,this.painter.beforeRenderLayers(r);for(const r of e)r.processRender(t);this.painter.renderLayers(r)}if(n("esri-tiles-debug")){t.drawPhase=c.WGLDrawPhase.DEBUG,this.painter.beforeRenderLayers(r);for(const r of e)r.processRender(t);this.painter.renderLayers(r)}t.profiler.recordEnd("drawLayers"),r.logInfo()},x.doRender=function(t){const r=this.context,{state:i,pixelRatio:n}=t;this._resizeCanvas(t),r.setViewport(0,0,n*i.size[0],n*i.size[1]),r.setDepthWriteEnabled(!0),r.setStencilWriteMask(255),e.prototype.doRender.call(this,t)},x.takeScreenshot=function(){var e=t._asyncToGenerator((function*(e){const{framebufferWidth:t,framebufferHeight:r}={framebufferWidth:Math.round(this.state.size[0]*e.resolutionScale),framebufferHeight:Math.round(this.state.size[1]*e.resolutionScale)},i=1,n=this.context,s=this._state.clone();if(null!=e.rotation){const t=s.viewpoint;s.viewpoint.rotation=e.rotation,s.viewpoint=t}const a={...this._renderParameters,drawPhase:null,globalOpacity:1,stationary:!0,state:s,pixelRatio:i,time:performance.now(),deltaTime:0,blendMode:null,effects:null,inFadeTransition:!1},o=new y.FramebufferObject(n,{colorTarget:b.TargetType.TEXTURE,depthStencilTarget:b.DepthStencilTargetType.DEPTH_STENCIL_RENDER_BUFFER,width:t,height:r}),h=n.getBoundFramebufferObject(),d=n.getViewport();n.bindFramebuffer(o),n.setViewport(0,0,t,r),this._renderChildren(e.children,a);const l=this._readbackScreenshot(o,{...e.cropArea,y:r-(e.cropArea.y+e.cropArea.height)});n.bindFramebuffer(h),n.setViewport(d.x,d.y,d.width,d.height),this.requestRender();const u=yield l;let c;return 1===e.outputScale?c=u:(c=new ImageData(Math.round(u.width*e.outputScale),Math.round(u.height*e.outputScale)),_.resampleHermite(u,c,!0)),c}));function r(t){return e.apply(this,arguments)}return r}(),x._readbackScreenshot=function(){var e=t._asyncToGenerator((function*(e,t){const r=R.createEmptyImageData(t.width,t.height,document.createElement("canvas"));return yield e.readPixelsAsync(t.x,t.y,t.width,t.height,b.PixelFormat.RGBA,b.PixelType.UNSIGNED_BYTE,new Uint8Array(r.data.buffer)),r}));function r(t,r){return e.apply(this,arguments)}return r}(),x._resizeCanvas=function(e){const t=this._canvas,r=t.style,{state:{size:i},pixelRatio:n}=e,s=i[0],a=i[1],o=Math.round(s*n),h=Math.round(a*n);t.width===o&&t.height===h||(t.width=o,t.height=h),r.width=s+"px",r.height=a+"px"},x._emptyTrash=function(){for(;this._trash.size>0;){const e=Array.from(this._trash);this._trash.clear();for(const t of e)t.processDetach()}},x._isLabelDrawPhaseRequired=function(e){let t=!1;for(const r of e){if(!(r instanceof l.Container)){t=t||!1;break}if(r.hasLabels)return!0;t=t||this._isLabelDrawPhaseRequired(r.children)}return t},t._createClass(P,[{key:"background",get:function(){return this._background},set:function(e){this._background=e,this.requestRender()}},{key:"bufferPool",get:function(){return this._bufferPool}},{key:"highlightOptions",get:function(){return this._highlightOptions},set:function(e){this._highlightOptionsHandle&&(this._highlightOptionsHandle.remove(),this._highlightOptionsHandle=null),this._highlightOptions=e,this._highlightOptions&&(this._highlightOptionsHandle=a.watch((()=>this._highlightOptions?.version),(()=>{this.painter.setHighlightOptions(e),this.requestRender()}),a.initial))}},{key:"renderingOptions",get:function(){return this._renderingOptions},set:function(e){this._renderingOptions=e,this.requestRender()}},{key:"state",get:function(){return this._state},set:function(e){this._state=e,this.requestRender()}},{key:"stationary",get:function(){return this._stationary},set:function(e){this._stationary!==e&&(this._stationary=e,this.requestRender())}}]),P}(l.Container);e.EXTRA_RENDER_TIME=T,e.Stage=P,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
