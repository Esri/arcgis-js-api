/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import e from"../../../core/Error.js";import{on as t}from"../../../core/events.js";import r from"../../../core/has.js";import{isSome as s}from"../../../core/maybe.js";import{watch as i,initial as n}from"../../../core/reactiveUtils.js";import{addFrameTask as a}from"../../../core/scheduling.js";import{c as o}from"../../../chunks/mat3f32.js";import h from"../../../symbols/cim/CIMResourceManager.js";import{Container as d}from"./Container.js";import{WGLDrawPhase as l}from"./webgl/enums.js";import p from"./webgl/Painter.js";import{Profiler as c}from"./webgl/Profiler.js";import{Timeline as u}from"../support/Timeline.js";import{resampleHermite as m,createEmptyImageData as g}from"../../support/screenshotUtils.js";import{createContextOrErrorHTML as f}from"../../webgl/context-util.js";import{TargetType as _,DepthStencilTargetType as b,PixelFormat as w,PixelType as R}from"../../webgl/enums.js";import{FramebufferObject as y}from"../../webgl/FramebufferObject.js";import{RenderingContext as O}from"../../webgl/RenderingContext.js";const x=2e3;class v extends d{constructor(i,n){super(),this._trash=new Set,this._renderRemainingTime=0,this._lastFrameRenderTime=0,this.renderRequested=!1,this.stage=this,this._stationary=!0;const{canvas:o=document.createElement("canvas"),alpha:d=!0,stencil:l=!0,contextOptions:m={}}=n;this._canvas=o;const g=f("2d",o,{alpha:d,antialias:!1,depth:!0,stencil:l});this.context=new O(s(g)?g:null,m),this.resourceManager=new h,this.painter=new p(this.context,this,this.resourceManager),r("esri-2d-profiler")&&(this._debugOutput=document.createElement("div"),this._debugOutput.setAttribute("style","margin: 24px 64px; position: absolute; color: red;"),i.appendChild(this._debugOutput)),this._renderParameters={drawPhase:0,state:this.state,pixelRatio:window.devicePixelRatio,stationary:!1,globalOpacity:1,blendMode:null,deltaTime:-1,time:0,inFadeTransition:!1,effects:null,context:this.context,painter:this.painter,timeline:n.timeline||new u,renderingOptions:n.renderingOptions,requestRender:()=>this.requestRender(),requireFBO:!1,profiler:new c(this.context,this._debugOutput),dataUploadCounter:0},this._taskHandle=a({render:e=>this.renderFrame(e)}),this._taskHandle.pause(),this._lostWebGLContextHandle=t(o,"webglcontextlost",(()=>{this.emit("webgl-error",{error:new e("webgl-context-lost")})})),o.setAttribute("style","width: 100%; height:100%; display:block;"),i.appendChild(o)}destroy(){this.removeAllChildren(),this._emptyTrash(),this._taskHandle.remove(),this._taskHandle=null,this._lostWebGLContextHandle&&(this._lostWebGLContextHandle.remove(),this._lostWebGLContextHandle=null),this._canvas.parentNode&&this._canvas.parentNode.removeChild(this._canvas),this._debugOutput&&this._debugOutput.parentNode&&this._debugOutput.parentNode.removeChild(this._debugOutput),this.highlightOptions=null,this.resourceManager.destroy(),this.painter.dispose(),this.context.dispose(),this._canvas=null}get background(){return this._background}set background(e){this._background=e,this.requestRender()}get highlightOptions(){return this._highlightOptions}set highlightOptions(e){this._highlightOptionsHandle&&(this._highlightOptionsHandle.remove(),this._highlightOptionsHandle=null),this._highlightOptions=e,this._highlightOptions&&(this._highlightOptionsHandle=i((()=>this._highlightOptions?.version),(()=>{this.painter.setHighlightOptions(e),this.requestRender()}),n))}get renderingOptions(){return this._renderingOptions}set renderingOptions(e){this._renderingOptions=e,this.requestRender()}get state(){return this._state}set state(e){this._state=e,this.requestRender()}get stationary(){return this._stationary}set stationary(e){this._stationary!==e&&(this._stationary=e,this.requestRender())}trashDisplayObject(e){this._trash.add(e),this.requestRender()}untrashDisplayObject(e){return this._trash.delete(e)}requestRender(){this._renderRemainingTime=x,this.renderRequested||(this.renderRequested=!0,this.emit("will-render"),this._taskHandle.resume())}renderFrame(e){const t=this._lastFrameRenderTime?e.time-this._lastFrameRenderTime:0;this._renderRemainingTime-=t,this._renderRemainingTime<=0&&this._taskHandle.pause(),this._lastFrameRenderTime=e.time,this.renderRequested=!1,this._renderParameters.state=this._state,this._renderParameters.stationary=this.stationary,this._renderParameters.pixelRatio=window.devicePixelRatio,this._renderParameters.globalOpacity=1,this._renderParameters.time=e.time,this._renderParameters.deltaTime=e.deltaTime,this._renderParameters.effects=null,this.processRender(this._renderParameters),this._emptyTrash(),this.emit("post-render")}_createTransforms(){return{dvs:o()}}renderChildren(e){for(const t of this.children)t.beforeRender(e);this._renderChildren(this.children,e);for(const t of this.children)t.afterRender(e)}_renderChildren(e,t){const s=this.context;s.resetInfo(),t.profiler.recordStart("drawLayers"),t.dataUploadCounter=0,t.drawPhase=l.MAP,this.painter.beforeRenderLayers(s,this.background);for(const r of e)r.processRender(t);this.painter.prepareDisplay(t,this.background,this.state.padding),this.painter.renderLayers(s),t.drawPhase=l.HIGHLIGHT,this.painter.beforeRenderLayers(s);for(const r of e)r.processRender(t);this.painter.renderLayers(s);if(this._isLabelDrawPhaseRequired(e)){t.drawPhase=l.LABEL,this.painter.beforeRenderLayers(s);for(const r of e)r.processRender(t);this.painter.renderLayers(s)}if(r("esri-tiles-debug")){t.drawPhase=l.DEBUG,this.painter.beforeRenderLayers(s);for(const r of e)r.processRender(t);this.painter.renderLayers(s)}t.profiler.recordEnd("drawLayers"),s.logInfo()}doRender(e){const t=this.context,{state:r,pixelRatio:s}=e;this._resizeCanvas(e),t.setViewport(0,0,s*r.size[0],s*r.size[1]),t.setDepthWriteEnabled(!0),t.setStencilWriteMask(255),super.doRender(e)}async takeScreenshot(e){const{framebufferWidth:t,framebufferHeight:r}={framebufferWidth:Math.round(this.state.size[0]*e.resolutionScale),framebufferHeight:Math.round(this.state.size[1]*e.resolutionScale)},s=1,i=this.context,n=this._state.clone();if(null!=e.rotation){const t=n.viewpoint;n.viewpoint.rotation=e.rotation,n.viewpoint=t}const a={...this._renderParameters,drawPhase:null,globalOpacity:1,stationary:!0,state:n,pixelRatio:s,time:performance.now(),deltaTime:0,blendMode:null,effects:null,inFadeTransition:!1},o=new y(i,{colorTarget:_.TEXTURE,depthStencilTarget:b.DEPTH_STENCIL_RENDER_BUFFER,width:t,height:r}),h=i.getBoundFramebufferObject(),d=i.getViewport();i.bindFramebuffer(o),i.setViewport(0,0,t,r),this._renderChildren(e.children,a);const l=this._readbackScreenshot(o,{...e.cropArea,y:r-(e.cropArea.y+e.cropArea.height)});i.bindFramebuffer(h),i.setViewport(d.x,d.y,d.width,d.height),this.requestRender();const p=await l;let c;return 1===e.outputScale?c=p:(c=new ImageData(Math.round(p.width*e.outputScale),Math.round(p.height*e.outputScale)),m(p,c,!0)),c}async _readbackScreenshot(e,t){const r=g(t.width,t.height,document.createElement("canvas"));return await e.readPixelsAsync(t.x,t.y,t.width,t.height,w.RGBA,R.UNSIGNED_BYTE,new Uint8Array(r.data.buffer)),r}_resizeCanvas(e){const t=this._canvas,r=t.style,{state:{size:s},pixelRatio:i}=e,n=s[0],a=s[1],o=Math.round(n*i),h=Math.round(a*i);t.width===o&&t.height===h||(t.width=o,t.height=h),r.width=n+"px",r.height=a+"px"}_emptyTrash(){for(;this._trash.size>0;){const e=Array.from(this._trash);this._trash.clear();for(const t of e)t.processDetach()}}_isLabelDrawPhaseRequired(e){let t=!1;for(const r of e){if(!(r instanceof d)){t=t||!1;break}if(r.hasLabels)return!0;t=t||this._isLabelDrawPhaseRequired(r.children)}return t}}export{x as EXTRA_RENDER_TIME,v as Stage};
