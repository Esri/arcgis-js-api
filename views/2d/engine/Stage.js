/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/Error","../../../core/events","../../../core/has","../../../core/maybe","../../../core/scheduling","../../../core/watchUtils","../../../chunks/common","../../../chunks/mat2d","../../../chunks/mat2df64","../../../chunks/mat3f32","../../../chunks/vec2","../../../chunks/vec2f64","../../../symbols/cim/CIMResourceManager","./Container","./webgl/enums","./webgl/Painter","./webgl/Profiler","./webgl/shaders/StencilPrograms","../support/Timeline","../../support/screenshotUtils","../../webgl/BufferObject","../../webgl/context-util","../../webgl/enums","../../webgl/FramebufferObject","../../webgl/ProgramTemplate","../../webgl/RenderingContext","../../webgl/VertexArrayObject","../../webgl/VertexElementDescriptor"],(function(e,t,r,i,n,s,a,o,l,h,d,c,u,p,_,f,g,m,b,R,O,T,w,y,E,F,C,P,x,S){"use strict";const B=2e3;let D=function(e){function D(o,l){var h;(h=e.call(this)||this)._trash=new Set,h._clipData=new Float32Array(8),h._upperLeft=p.create(),h._upperRight=p.create(),h._lowerLeft=p.create(),h._lowerRight=p.create(),h._mat2=d.create(),h._clipRendererInitialized=!1,h._renderRemainingTime=0,h._lastFrameRenderTime=0,h.renderRequested=!1,h.stage=t._assertThisInitialized(h),h._stationary=!0;const{canvas:c=document.createElement("canvas"),alpha:u=!0,stencil:f=!0,contextOptions:g={}}=l;h._canvas=c;const R={alpha:u,antialias:!1,depth:!0,stencil:f},T=y.createContextOrErrorHTML("2d",c,R);return h.context=new P.RenderingContext(s.isSome(T)?T:null,g),h.resourceManager=new _,h.painter=new m(h.context,t._assertThisInitialized(h),h.resourceManager),n("esri-2d-profiler")&&(h._debugOutput=document.createElement("div"),h._debugOutput.setAttribute("style","margin: 24px 64px; position: absolute; color: red;"),o.appendChild(h._debugOutput)),h._renderParameters={drawPhase:0,state:h.state,pixelRatio:window.devicePixelRatio,stationary:!1,globalOpacity:1,blendMode:null,deltaTime:-1,time:0,inFadeTransition:!1,effects:null,context:h.context,painter:h.painter,timeline:l.timeline||new O.Timeline,renderingOptions:l.renderingOptions,requireFBO:!1,profiler:new b.Profiler(h.context,h._debugOutput),dataUploadCounter:0},h._taskHandle=a.addFrameTask({render:e=>h.renderFrame(e)}),h._taskHandle.pause(),h._lostWebGLContextHandle=i.on(c,"webglcontextlost",(()=>{h.emit("webgl-error",{error:new r("webgl-context-lost")})})),c.setAttribute("style","width: 100%; height:100%; display:block;"),o.appendChild(c),h}t._inheritsLoose(D,e);var L=D.prototype;return L.destroy=function(){this.removeAllChildren(),this._emptyTrash(),this._taskHandle.remove(),this._taskHandle=null,this._boundFBO=null,this._clipFBO&&(this._clipFBO.dispose(),this._clipFBO=null),this._clipVAO&&(this._clipVAO.dispose(),this._clipVAO=null,this._clipVBO=null),this._clipStencilProgram&&(this._clipStencilProgram.dispose(),this._clipStencilProgram=null),this._lostWebGLContextHandle&&(this._lostWebGLContextHandle.remove(),this._lostWebGLContextHandle=null),this._canvas.parentNode&&this._canvas.parentNode.removeChild(this._canvas),this._debugOutput&&this._debugOutput.parentNode&&this._debugOutput.parentNode.removeChild(this._debugOutput),this.highlightOptions=null,this.resourceManager.destroy(),this.painter.dispose(),this.context.dispose(),this._canvas=null},L.trashDisplayObject=function(e){this._trash.add(e),this.requestRender()},L.untrashDisplayObject=function(e){return this._trash.delete(e)},L.requestRender=function(){this._renderRemainingTime=B,this.renderRequested||(this.renderRequested=!0,this.emit("will-render"),this._taskHandle.resume())},L.renderFrame=function(e){const t=this._lastFrameRenderTime?e.time-this._lastFrameRenderTime:0;this._renderRemainingTime-=t,this._renderRemainingTime<=0&&this._taskHandle.pause(),this._lastFrameRenderTime=e.time,this.renderRequested=!1,this._renderParameters.state=this._state,this._renderParameters.stationary=this.stationary,this._renderParameters.pixelRatio=window.devicePixelRatio,this._renderParameters.globalOpacity=1,this._renderParameters.time=e.time,this._renderParameters.deltaTime=e.deltaTime,this._renderParameters.effects=null,this.processRender(this._renderParameters),this._emptyTrash(),this.emit("post-render")},L._createTransforms=function(){return{dvs:c.create()}},L.renderChildren=function(e){for(const t of this.children)t.beforeRender(e);this._renderChildren(this.children,e);for(const t of this.children)t.afterRender(e)},L._renderChildren=function(e,t){const r=this.context;t.profiler.recordStart("drawLayers"),t.dataUploadCounter=0,this._beforeRenderChildren(t),t.drawPhase=g.WGLDrawPhase.MAP,this.painter.beforeRenderLayers(r,this.background);for(const i of e)i.processRender(t);this.painter.renderLayers(r),t.drawPhase=g.WGLDrawPhase.HIGHLIGHT,this.painter.beforeRenderLayers(r);for(const i of e)i.processRender(t);this.painter.renderLayers(r);if(this._isLabelDrawPhaseRequired(e)){t.drawPhase=g.WGLDrawPhase.LABEL,this.painter.beforeRenderLayers(r);for(const r of e)r.processRender(t);this.painter.renderLayers(r)}if(n("esri-tiles-debug")){t.drawPhase=g.WGLDrawPhase.DEBUG,this.painter.beforeRenderLayers(r);for(const r of e)r.processRender(t);this.painter.renderLayers(r)}t.profiler.recordEnd("drawLayers"),this._afterRenderChildren()},L._beforeRenderChildren=function(e){const{context:t}=this,{state:r,pixelRatio:i}=e;t.setClearDepth(1),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT|t.gl.DEPTH_BUFFER_BIT);const{size:n,rotation:s}=r,a=Math.round(n[0]*i),o=Math.round(n[1]*i);this._boundFBO=t.getBoundFramebufferObject();if(!r.spatialReference.isWrappable)return void(this._clipFrame=!1);const d=l.toRadian(s),c=Math.abs(Math.cos(d)),p=Math.abs(Math.sin(d)),_=Math.round(a*c+o*p),f=Math.round(r.worldScreenWidth);if(_<=f)return void(this._clipFrame=!1);this._clipFBO&&this._clipFBO.width===a&&this._clipFBO.height===o||(this._clipFBO=new F.FramebufferObject(t,{colorTarget:E.TargetType.TEXTURE,depthStencilTarget:E.DepthStencilTargetType.DEPTH_STENCIL_RENDER_BUFFER,width:a,height:o}));const g=(this.state.padding.left-this.state.padding.right)/2,m=(this.state.padding.bottom-this.state.padding.top)/2,b=.5*a,R=.5*o,O=1/a,T=1/o,w=f*i*.5,y=.5*(a*p+o*c),C=this._upperLeft,P=this._upperRight,x=this._lowerLeft,S=this._lowerRight;u.set(C,-w,-y),u.set(P,w,-y),u.set(x,-w,y),u.set(S,w,y),h.fromTranslation(this._mat2,[b+g,R-m]),0!==s&&h.rotate(this._mat2,this._mat2,d),u.transformMat2d(C,C,this._mat2),u.transformMat2d(P,P,this._mat2),u.transformMat2d(x,x,this._mat2),u.transformMat2d(S,S,this._mat2);const B=this._clipData;B.set([2*x[0]*O-1,2*(o-x[1])*T-1,2*S[0]*O-1,2*(o-S[1])*T-1,2*C[0]*O-1,2*(o-C[1])*T-1,2*P[0]*O-1,2*(o-P[1])*T-1]),this._clipRendererInitialized||this._initializeClipRenderer(t),this._clipVBO.setData(B),this._boundFBO=t.getBoundFramebufferObject(),t.bindFramebuffer(this._clipFBO),t.setDepthWriteEnabled(!0),t.setStencilWriteMask(255),t.setClearColor(0,0,0,0),t.setClearDepth(1),t.setClearStencil(0),t.clear(t.gl.COLOR_BUFFER_BIT|t.gl.DEPTH_BUFFER_BIT|t.gl.STENCIL_BUFFER_BIT),t.setDepthWriteEnabled(!1),this._clipFrame=!0},L._afterRenderChildren=function(){const e=this.context;if(e.logIno(),this._clipFrame&&this._clipRendererInitialized){if(e.bindFramebuffer(this._boundFBO),this._boundFBO=null,e.bindVAO(this._clipVAO),e.useProgram(this._clipStencilProgram),e.setDepthWriteEnabled(!1),e.setDepthTestEnabled(!1),e.setStencilTestEnabled(!0),e.setBlendingEnabled(!1),e.setColorMask(!1,!1,!1,!1),e.setStencilOp(E.StencilOperation.KEEP,E.StencilOperation.KEEP,E.StencilOperation.REPLACE),e.setStencilWriteMask(255),e.setStencilFunction(E.CompareFunction.ALWAYS,1,255),e.drawElements(E.PrimitiveType.TRIANGLES,6,E.DataType.UNSIGNED_SHORT,0),e.bindVAO(),e.setColorMask(!0,!0,!0,!0),null!=this.background){const{r:t,g:r,b:i,a:n}=this.background.color;e.setClearColor(n*t/255,n*r/255,n*i/255,n)}else e.setClearColor(0,0,0,0);e.clear(e.gl.COLOR_BUFFER_BIT),e.setBlendingEnabled(!0),e.setStencilFunction(E.CompareFunction.EQUAL,1,255),this.painter.blitTexture(e,this._clipFBO.colorTexture,E.TextureSamplingMode.NEAREST,1),e.setStencilTestEnabled(!1)}},L.doRender=function(t){const r=this.context,{state:i,pixelRatio:n}=t;this._resizeCanvas(t),r.setViewport(0,0,n*i.size[0],n*i.size[1]),r.setDepthWriteEnabled(!0),r.setStencilWriteMask(255),e.prototype.doRender.call(this,t)},L.takeScreenshot=function(){var e=t._asyncToGenerator((function*(e){const{framebufferWidth:t,framebufferHeight:r}={framebufferWidth:Math.round(this._renderParameters.state.size[0]*e.resolutionScale),framebufferHeight:Math.round(this._renderParameters.state.size[1]*e.resolutionScale)},i=1,n=this.context,s=this._state.clone();if(null!=e.rotation){const t=s.viewpoint;s.viewpoint.rotation=e.rotation,s.viewpoint=t}const a={...this._renderParameters,drawPhase:null,globalOpacity:1,stationary:!0,state:s,pixelRatio:i,time:performance.now(),deltaTime:0,blendMode:null,effects:null,inFadeTransition:!1},o=new F.FramebufferObject(n,{colorTarget:E.TargetType.TEXTURE,depthStencilTarget:E.DepthStencilTargetType.DEPTH_STENCIL_RENDER_BUFFER,width:t,height:r}),l=n.getBoundFramebufferObject(),h=n.getViewport();n.bindFramebuffer(o),n.setViewport(0,0,t,r),this._renderChildren(e.children,a);const d=this._readbackScreenshot(o,{...e.cropArea,y:r-(e.cropArea.y+e.cropArea.height)});n.bindFramebuffer(l),n.setViewport(h.x,h.y,h.width,h.height),this.requestRender();const c=yield d;let u;1===e.outputScale?u=c:(u=new ImageData(Math.round(c.width*e.outputScale),Math.round(c.height*e.outputScale)),T.resampleHermite(c,u,!0));return T.encodeResult(u,{format:e.format,quality:e.quality,rotation:0,disableDecorations:!1},document.createElement("canvas"),{flipY:!0,premultipliedAlpha:!0})}));function r(t){return e.apply(this,arguments)}return r}(),L._readbackScreenshot=function(){var e=t._asyncToGenerator((function*(e,t){const r=T.createEmptyImageData(t.width,t.height,document.createElement("canvas"));return yield e.readPixelsAsync(t.x,t.y,t.width,t.height,E.PixelFormat.RGBA,E.PixelType.UNSIGNED_BYTE,new Uint8Array(r.data.buffer)),r}));function r(t,r){return e.apply(this,arguments)}return r}(),L._resizeCanvas=function(e){const t=this._canvas,r=t.style,{state:{size:i},pixelRatio:n}=e,s=i[0],a=i[1],o=Math.round(s*n),l=Math.round(a*n);t.width===o&&t.height===l||(t.width=o,t.height=l),r.width=s+"px",r.height=a+"px"},L._initializeClipRenderer=function(e){if(this._clipRendererInitialized)return!0;const t=C.createProgram(e,R.stencil);if(!t)return!1;const r=w.BufferObject.createVertex(e,E.Usage.STREAM_DRAW,this._clipData),i=new Uint16Array([0,1,2,2,1,3]),n=w.BufferObject.createIndex(e,E.Usage.STATIC_DRAW,i),s=R.stencil.attributes,a={geometry:[new S.VertexElementDescriptor("a_pos",2,E.DataType.FLOAT,0,8)]},o=new x.VertexArrayObject(e,s,a,{geometry:r},n);return this._clipStencilProgram=t,this._clipVBO=r,this._clipVAO=o,this._clipRendererInitialized=!0,!0},L._emptyTrash=function(){for(;this._trash.size>0;){const e=Array.from(this._trash);this._trash.clear();for(const t of e)t.processDetach()}},L._isLabelDrawPhaseRequired=function(e){let t=!1;for(const r of e){if(!(r instanceof f.Container)){t=t||!1;break}if(r.hasLabels)return!0;t=t||this._isLabelDrawPhaseRequired(r.children)}return t},t._createClass(D,[{key:"background",get:function(){return this._background},set:function(e){this._background=e,this.requestRender()}},{key:"highlightOptions",get:function(){return this._highlightOptions},set:function(e){this._highlightOptionsHandle&&(this._highlightOptionsHandle.remove(),this._highlightOptionsHandle=null),this._highlightOptions=e,this._highlightOptions&&(this._highlightOptionsHandle=o.init(this._highlightOptions,"version",(()=>{this.painter.setHighlightOptions(e),this.requestRender()})))}},{key:"renderingOptions",get:function(){return this._renderingOptions},set:function(e){this._renderingOptions=e,this.requestRender()}},{key:"state",get:function(){return this._state},set:function(e){this._state=e,this.requestRender()}},{key:"stationary",get:function(){return this._stationary},set:function(e){this._stationary!==e&&(this._stationary=e,this.requestRender())}}]),D}(f.Container);e.EXTRA_RENDER_TIME=B,e.Stage=D,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
