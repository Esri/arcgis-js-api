/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/has","../../../core/Error","../../../core/events","../../../core/scheduling","../../../core/mathUtils","../../../chunks/common","../../../core/watchUtils","../../../chunks/vec2f64","../../support/screenshotUtils","../../../chunks/vec2","../../webgl/context-util","../../../chunks/mat2d","../../../chunks/mat2df64","../support/Timeline","../../../chunks/builtins","../../webgl/BufferObject","../../webgl/VertexArrayObject","../../webgl/FramebufferObject","../../webgl/programUtils","../../webgl/RenderingContext","./webgl/enums","./Container","./webgl/Painter","./webgl/Profiler","./webgl/WebGLDriverTest","./webgl/shaders/StencilPrograms"],(function(e,t,i,r,s,n,a,o,h,l,d,c,p,u,_,f,g,m,b,w,R,O,y,C,x,v,P,F){"use strict";let E=function(e){function a(a,o){var h;(h=e.call(this)||this)._trash=new Set,h._clipData=new Float32Array(8),h._upperLeft=l.create(),h._upperRight=l.create(),h._lowerLeft=l.create(),h._lowerRight=l.create(),h._mat2=_.create(),h._clipRendererInitialized=!1,h._supersampleScreenshots=!0,h.renderRequested=!1,h.stage=t._assertThisInitialized(h),h._stationary=!0;const{canvas:d=document.createElement("canvas"),alpha:c=!0,stencil:u=!0,renderContext:g="webgl",supersampleScreenshots:m=!0,contextOptions:b={}}=o;h._canvas=d;const w={alpha:c,antialias:!1,depth:!0,stencil:u},R=p.createContextOrErrorHTML(d,w,g);return h.context=new O(R,b),h.painter=new x(h.context,t._assertThisInitialized(h)),i("esri-2d-profiler")&&(h._debugOutput=document.createElement("div"),h._debugOutput.setAttribute("style","margin: 24px 64px; position: absolute; color: red;"),a.appendChild(h._debugOutput)),h._renderParameters={drawPhase:0,state:h.state,pixelRatio:window.devicePixelRatio,stationary:!1,globalOpacity:1,blendMode:null,deltaTime:-1,time:0,inFadeTransition:!1,effects:null,context:h.context,painter:h.painter,timeline:o.timeline||new f.Timeline,renderingOptions:o.renderingOptions,driverTestResult:P.testWebGLDriver(h.context),profiler:new v.Profiler(h.context,h._debugOutput),dataUploadCounter:0},h._taskHandle=n.addFrameTask({render:e=>h.renderFrame(e)}),h._taskHandle.pause(),h._supersampleScreenshots=m,h._lostWebGLContextHandle=s.on(d,"webglcontextlost",(()=>{h.emit("webgl-error",{error:new r("webgl-context-lost")})})),d.setAttribute("style","width: 100%; height:100%; display:block;"),a.appendChild(d),h}t._inheritsLoose(a,e);var g=a.prototype;return g.destroy=function(){this.removeAllChildren(),this._emptyTrash(),this._taskHandle.remove(),this._taskHandle=null,this._boundFBO=null,this._clipFBO&&(this._clipFBO.dispose(),this._clipFBO=null),this._clipVAO&&(this._clipVAO.dispose(),this._clipVAO=null,this._clipVBO=null),this._clipStencilProgram&&(this._clipStencilProgram.dispose(),this._clipStencilProgram=null),this._lostWebGLContextHandle&&(this._lostWebGLContextHandle.remove(),this._lostWebGLContextHandle=null),this._canvas.parentNode&&this._canvas.parentNode.removeChild(this._canvas),this._debugOutput&&this._debugOutput.parentNode&&this._debugOutput.parentNode.removeChild(this._debugOutput),this.highlightOptions=null,this.painter.dispose(),this.context.dispose(),this._canvas=null},g.trashDisplayObject=function(e){this._trash.add(e),this.requestRender()},g.untrashDisplayObject=function(e){return this._trash.delete(e)},g.requestRender=function(){this._lastRenderRequestTime=performance.now(),this.renderRequested||(this.renderRequested=!0,this.emit("will-render"),this._taskHandle.resume())},g.renderFrame=function(e){e.time-this._lastRenderRequestTime>=2e3&&this._taskHandle.pause(),this.renderRequested=!1,this._renderParameters.state=this._state,this._renderParameters.stationary=this.stationary,this._renderParameters.pixelRatio=window.devicePixelRatio,this._renderParameters.globalOpacity=1,this._renderParameters.time=e.time,this._renderParameters.deltaTime=e.deltaTime,this._renderParameters.effects=null,this.processRender(this._renderParameters),this._emptyTrash(),this.emit("post-render")},g.renderChildren=function(e){for(const t of this.children)t.beforeRender(e);this._renderChildren(this.children,e);for(const t of this.children)t.afterRender(e)},g._renderChildren=function(e,t){const r=this.context;t.profiler.recordStart("drawLayers"),t.dataUploadCounter=0,this._beforeRenderChildren(t),t.drawPhase=y.WGLDrawPhase.MAP,this.painter.beforeRenderLayers(r,this.background);for(const i of e)i.processRender(t);this.painter.renderLayers(r),t.drawPhase=y.WGLDrawPhase.HIGHLIGHT,this.painter.beforeRenderLayers(r);for(const i of e)i.processRender(t);this.painter.renderLayers(r);if(this._isLabelDrawPhaseRequired(e)){t.drawPhase=y.WGLDrawPhase.LABEL,this.painter.beforeRenderLayers(r);for(const i of e)i.processRender(t);this.painter.renderLayers(r)}if(i("esri-tiles-debug")){t.drawPhase=y.WGLDrawPhase.DEBUG,this.painter.beforeRenderLayers(r);for(const i of e)i.processRender(t);this.painter.renderLayers(r)}t.profiler.recordEnd("drawLayers"),this._afterRenderChildren()},g._beforeRenderChildren=function(e){const{context:t}=this,{state:i,pixelRatio:r}=e;t.enforceState();const{size:s,rotation:n}=i,a=Math.round(s[0]*r),h=Math.round(s[1]*r);this._boundFBO=t.getBoundFramebufferObject();if(!(i.spatialReference&&(i.spatialReference._isWrappable?i.spatialReference._isWrappable():i.spatialReference.isWrappable)))return void(this._clipFrame=!1);const l=o.toRadian(n),d=Math.abs(Math.cos(l)),p=Math.abs(Math.sin(l)),_=Math.round(a*d+h*p),f=Math.round(i.worldScreenWidth);if(_<=f)return void(this._clipFrame=!1);this._clipFBO&&this._clipFBO.width===a&&this._clipFBO.height===h||(this._clipFBO=new w(t,{colorTarget:0,depthStencilTarget:3,width:a,height:h}));const g=(this.state.padding.left-this.state.padding.right)/2,m=(this.state.padding.bottom-this.state.padding.top)/2,b=.5*a,R=.5*h,O=1/a,y=1/h,C=f*r*.5,x=.5*(a*p+h*d),v=this._upperLeft,P=this._upperRight,F=this._lowerLeft,E=this._lowerRight;c.set(v,-C,-x),c.set(P,C,-x),c.set(F,-C,x),c.set(E,C,x),u.identity(this._mat2),u.translate(this._mat2,this._mat2,[b+g,R+m]),0!==n&&u.rotate(this._mat2,this._mat2,l),c.transformMat2d(v,v,this._mat2),c.transformMat2d(P,P,this._mat2),c.transformMat2d(F,F,this._mat2),c.transformMat2d(E,E,this._mat2);const S=this._clipData;S.set([2*F[0]*O-1,2*(h-F[1])*y-1,2*E[0]*O-1,2*(h-E[1])*y-1,2*v[0]*O-1,2*(h-v[1])*y-1,2*P[0]*O-1,2*(h-P[1])*y-1]),this._clipRendererInitialized||this._initializeClipRenderer(t),this._clipVBO.setData(S),this._boundFBO=t.getBoundFramebufferObject(),t.bindFramebuffer(this._clipFBO),t.setDepthWriteEnabled(!0),t.setStencilWriteMask(255),t.setClearColor(0,0,0,0),t.setClearDepth(1),t.setClearStencil(0),t.clear(t.gl.COLOR_BUFFER_BIT|t.gl.DEPTH_BUFFER_BIT|t.gl.STENCIL_BUFFER_BIT),t.setDepthWriteEnabled(!1),this._clipFrame=!0},g._afterRenderChildren=function(){const e=this.context;if(e.logIno(),this._clipFrame&&this._clipRendererInitialized){if(e.bindFramebuffer(this._boundFBO),this._boundFBO=null,e.bindVAO(this._clipVAO),e.bindProgram(this._clipStencilProgram),e.setDepthWriteEnabled(!1),e.setDepthTestEnabled(!1),e.setStencilTestEnabled(!0),e.setBlendingEnabled(!1),e.setColorMask(!1,!1,!1,!1),e.setStencilOp(7680,7680,7681),e.setStencilWriteMask(255),e.setStencilFunction(519,1,255),e.drawElements(4,6,5123,0),e.bindVAO(),e.setColorMask(!0,!0,!0,!0),null!=this.background){const{r:t,g:i,b:r,a:s}=this.background.color;e.setClearColor(s*t/255,s*i/255,s*r/255,s)}else e.setClearColor(0,0,0,0);e.clear(e.gl.COLOR_BUFFER_BIT),e.setBlendingEnabled(!0),e.setStencilFunction(514,1,255),this.painter.blitTexture(e,this._clipFBO.colorTexture,9728,1),e.setStencilTestEnabled(!1)}},g.doRender=function(t){const i=this.context,{state:r,pixelRatio:s}=t;this._resizeCanvas(t),this.context.enforceState(),i.setViewport(0,0,s*r.size[0],s*r.size[1]),i.setDepthWriteEnabled(!0),i.setStencilWriteMask(255),e.prototype.doRender.call(this,t)},g.takeScreenshot=async function(e,t){const i=d.screenshotSuperSampleSettings(e,this._supersampleScreenshots,this._state.padding),{framebufferWidth:r,framebufferHeight:s}=i,n=this.context,a=e.layers;let o=this.children;const h={...this._renderParameters,drawPhase:null,globalOpacity:1,stationary:!0,state:this._renderParameters.state.clone(),pixelRatio:i.pixelRatio,time:Date.now(),deltaTime:0,blendMode:null,effects:null,inFadeTransition:!1};if(null!=e.rotation){const t=h.state.viewpoint;t.rotation=e.rotation,h.state.viewpoint=t}a.length>0&&(o=[],a.forEach((e=>{const i=t.find((t=>t.layer.id===e.id));i&&"container"in i&&i.container&&o.push(i.container)})));const l=new w(n,{colorTarget:0,depthStencilTarget:3,width:r,height:s}),c=n.getBoundFramebufferObject(),p=n.getViewport();n.bindFramebuffer(l),n.setViewport(0,0,r,s),this._renderChildren(o,h);const u=this._readbackScreenshot(i);n.bindFramebuffer(c),n.setViewport(p.x,p.y,p.width,p.height),this.requestRender();const _=this._ensureScreenshotEncodeCanvas();return d.encodeResult(u,e,_,{flipY:!0,premultipliedAlpha:!0})},g._ensureScreenshotEncodeCanvas=function(){return this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas")),this._screenshotEncodeCanvas},g._readbackScreenshot=function(e){const{framebufferWidth:t,framebufferHeight:i,region:r,resample:s}=e,n=this.context.gl;if(s){const e=d.createEmptyImageData(t,i,this._ensureScreenshotEncodeCanvas());n.readPixels(0,0,t,i,6408,5121,new Uint8Array(e.data.buffer));const a=d.createEmptyImageData(r.width,r.height,this._ensureScreenshotEncodeCanvas());return d.resampleHermite(e,a,!0,s.region.x,i-(s.region.y+s.region.height),s.region.width,s.region.height)}{const e=d.createEmptyImageData(r.width,r.height,this._ensureScreenshotEncodeCanvas());return n.readPixels(r.x,i-(r.y+r.height),r.width,r.height,6408,5121,new Uint8Array(e.data.buffer)),e}},g._resizeCanvas=function(e){const t=this._canvas,i=t.style,{state:{size:r},pixelRatio:s}=e,n=r[0],a=r[1],o=Math.round(n*s),h=Math.round(a*s);t.width===o&&t.height===h||(t.width=o,t.height=h),i.width=n+"px",i.height=a+"px"},g._initializeClipRenderer=function(e){if(this._clipRendererInitialized)return!0;const t=F.stencil.attributes,i=R.createProgram(e,F.stencil);if(!i)return!1;const r=m.createVertex(e,35040,32),s=new Uint16Array([0,1,2,2,1,3]),n=m.createIndex(e,35044,s),a=new b(e,t,{geometry:[{name:"a_pos",count:2,type:5126,offset:0,stride:8,normalized:!1,divisor:0}]},{geometry:r},n);return this._clipStencilProgram=i,this._clipVBO=r,this._clipVAO=a,this._clipRendererInitialized=!0,!0},g._emptyTrash=function(){for(;this._trash.size>0;){const e=Array.from(this._trash);this._trash.clear();for(const t of e)t.processDetach()}},g._isLabelDrawPhaseRequired=function(e){let t=!1;for(const i of e){if(!(i instanceof C.Container)){t=t||!1;break}if(i.hasLabels)return!0;t=t||this._isLabelDrawPhaseRequired(i.children)}return t},t._createClass(a,[{key:"background",get:function(){return this._background},set:function(e){this._background=e,this.requestRender()}},{key:"highlightOptions",get:function(){return this._highlightOptions},set:function(e){this._highlightOptionsHandle&&(this._highlightOptionsHandle.remove(),this._highlightOptionsHandle=null),this._highlightOptions=e,this._highlightOptions&&(this._highlightOptionsHandle=h.init(this._highlightOptions,"version",(()=>{this.painter.setHighlightOptions(e),this.requestRender()})))}},{key:"renderingOptions",get:function(){return this._renderingOptions},set:function(e){this._renderingOptions=e,this.requestRender()}},{key:"state",get:function(){return this._state},set:function(e){this._state=e,this.requestRender()}},{key:"stationary",get:function(){return this._stationary},set:function(e){this._stationary!==e&&(this._stationary=e,this.requestRender())}}]),a}(C.Container);e.EXTRA_RENDER_TIME=2e3,e.Stage=E,Object.defineProperty(e,"__esModule",{value:!0})}));
