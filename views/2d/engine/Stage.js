// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../core/Error","../../../core/events","../../../core/has","../../../core/scheduling","../../../core/SetUtils","../../../core/watchUtils","../../../core/libs/gl-matrix-2/common","../../../core/libs/gl-matrix-2/mat2d","../../../core/libs/gl-matrix-2/mat2df64","../../../core/libs/gl-matrix-2/vec2","../../../core/libs/gl-matrix-2/vec2f64","../../webgl","./Container","./webgl/enums","./webgl/Painter","./webgl/Profiler","./webgl/WebGLDriverTest","./webgl/shaders/StencilPrograms","../support/Timeline","../../support/screenshotUtils"],(function(e,t,r,i,n,s,a,o,h,l,d,c,p,u,_,f,g,m,b,v,y,O,R){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Stage=t.EXTRA_RENDER_TIME=void 0,t.EXTRA_RENDER_TIME=2e3;var w=function(e){function w(t,r){var o=e.call(this)||this;o._trash=new Set,o._clipData=new Float32Array(8),o._upperLeft=u.vec2f64.create(),o._upperRight=u.vec2f64.create(),o._lowerLeft=u.vec2f64.create(),o._lowerRight=u.vec2f64.create(),o._mat2=c.mat2df64.create(),o._clipRendererInitialized=!1,o._supersampleScreenshots=!0,o.renderRequested=!1,o.stage=o,o._stationary=!0;var h=r.canvas,l=void 0===h?document.createElement("canvas"):h,d=r.alpha,p=void 0===d||d,f=r.stencil,g=void 0===f||f,y=r.renderContext,R=void 0===y?"webgl":y,w=r.supersampleScreenshots,x=void 0===w||w,C=r.contextOptions,E=void 0===C?{}:C;o._canvas=l;var P={alpha:p,antialias:!1,depth:!0,stencil:g},F=_.createContextOrErrorHTML(l,P,R);return o.context=new _.RenderingContext(F,E),o.painter=new m.default(o.context,o),s("esri-2d-profiler")&&(o._debugOutput=document.createElement("div"),o._debugOutput.setAttribute("style","margin: 24px 64px; position: absolute; color: red;"),t.appendChild(o._debugOutput)),o._renderParameters={drawPhase:0,state:o.state,pixelRatio:window.devicePixelRatio,stationary:!1,globalOpacity:1,blendMode:null,deltaTime:-1,time:0,inFadeTransition:!1,effects:null,context:o.context,painter:o.painter,timeline:r.timeline||new O.Timeline,renderingOptions:r.renderingOptions,driverTestResult:v.testWebGLDriver(o.context),profiler:new b.Profiler(o.context,o._debugOutput),dataUploadCounter:0},o._taskHandle=a.addFrameTask({render:function(e){return o.renderFrame(e)}}),o._taskHandle.pause(),o._supersampleScreenshots=x,o._lostWebGLContextHandle=n.on(l,"webglcontextlost",(function(){o.emit("webgl-error",{error:new i("webgl-context-lost")})})),l.setAttribute("style","width: 100%; height:100%; display:block;"),t.appendChild(l),o}return r.__extends(w,e),w.prototype.destroy=function(){this.removeAllChildren(),this._emptyTrash(),this._taskHandle.remove(),this._taskHandle=null,this._boundFBO=null,this._clipFBO&&(this._clipFBO.dispose(),this._clipFBO=null),this._clipVAO&&(this._clipVAO.dispose(),this._clipVAO=null,this._clipVBO=null),this._clipStencilProgram&&(this._clipStencilProgram.dispose(),this._clipStencilProgram=null),this._lostWebGLContextHandle&&(this._lostWebGLContextHandle.remove(),this._lostWebGLContextHandle=null),this._canvas.parentNode&&this._canvas.parentNode.removeChild(this._canvas),this._debugOutput&&this._debugOutput.parentNode&&this._debugOutput.parentNode.removeChild(this._debugOutput),this.highlightOptions=null,this.painter.dispose(),this.context.dispose(),this._canvas=null},Object.defineProperty(w.prototype,"background",{get:function(){return this._background},set:function(e){this._background=e,this.requestRender()},enumerable:!1,configurable:!0}),Object.defineProperty(w.prototype,"highlightOptions",{get:function(){return this._highlightOptions},set:function(e){var t=this;this._highlightOptionsHandle&&(this._highlightOptionsHandle.remove(),this._highlightOptionsHandle=null),this._highlightOptions=e,this._highlightOptions&&(this._highlightOptionsHandle=h.init(this._highlightOptions,"version",(function(){t.painter.setHighlightOptions(e),t.requestRender()})))},enumerable:!1,configurable:!0}),Object.defineProperty(w.prototype,"renderingOptions",{get:function(){return this._renderingOptions},set:function(e){this._renderingOptions=e,this.requestRender()},enumerable:!1,configurable:!0}),Object.defineProperty(w.prototype,"state",{get:function(){return this._state},set:function(e){this._state=e,this.requestRender()},enumerable:!1,configurable:!0}),Object.defineProperty(w.prototype,"stationary",{get:function(){return this._stationary},set:function(e){this._stationary!==e&&(this._stationary=e,this.requestRender())},enumerable:!1,configurable:!0}),w.prototype.trashDisplayObject=function(e){this._trash.add(e),this.requestRender()},w.prototype.untrashDisplayObject=function(e){return this._trash.delete(e)},w.prototype.requestRender=function(){this._lastRenderRequestTime=performance.now(),this.renderRequested||(this.renderRequested=!0,this.emit("will-render"),this._taskHandle.resume())},w.prototype.renderFrame=function(e){e.time-this._lastRenderRequestTime>=t.EXTRA_RENDER_TIME&&this._taskHandle.pause(),this.renderRequested=!1,this._renderParameters.state=this._state,this._renderParameters.stationary=this.stationary,this._renderParameters.pixelRatio=window.devicePixelRatio,this._renderParameters.globalOpacity=1,this._renderParameters.time=e.time,this._renderParameters.deltaTime=e.deltaTime,this._renderParameters.effects=null,this.processRender(this._renderParameters),this._emptyTrash(),this.emit("post-render")},w.prototype.renderChildren=function(e){this._renderChildren(this.children,e)},w.prototype._renderChildren=function(e,t){var r=this.context;t.profiler.recordStart("drawLayers"),t.dataUploadCounter=0,this._beforeRenderChildren(t),t.drawPhase=g.WGLDrawPhase.MAP,this.painter.beforeRenderLayers(r,this.background);for(var i=0,n=e;i<n.length;i++){n[i].processRender(t)}if(this.painter.renderLayers(r),this._isLabelDrawPhaseRequired(e)){t.drawPhase=g.WGLDrawPhase.LABEL,this.painter.beforeRenderLayers(r);for(var a=0,o=e;a<o.length;a++){o[a].processRender(t)}this.painter.renderLayers(r)}if(s("esri-tiles-debug")){t.drawPhase=g.WGLDrawPhase.DEBUG,this.painter.beforeRenderLayers(r);for(var h=0,l=e;h<l.length;h++){l[h].processRender(t)}this.painter.renderLayers(r)}t.profiler.recordEnd("drawLayers"),this._afterRenderChildren()},w.prototype._beforeRenderChildren=function(e){var t=this.context,r=e.state,i=e.pixelRatio;t.enforceState();var n=r.size,s=r.rotation,a=Math.round(n[0]*i),o=Math.round(n[1]*i);if(this._boundFBO=t.getBoundFramebufferObject(),r.spatialReference&&(r.spatialReference._isWrappable?r.spatialReference._isWrappable():r.spatialReference.isWrappable)){var h=l.common.toRadian(s),c=Math.abs(Math.cos(h)),u=Math.abs(Math.sin(h)),f=Math.round(a*c+o*u),g=Math.round(r.worldScreenWidth);if(f<=g)this._clipFrame=!1;else{this._clipFBO&&this._clipFBO.width===a&&this._clipFBO.height===o||(this._clipFBO=new _.FramebufferObject(t,{colorTarget:0,depthStencilTarget:3,width:a,height:o}));var m=(this.state.padding.left-this.state.padding.right)/2,b=(this.state.padding.bottom-this.state.padding.top)/2,v=.5*a,y=.5*o,O=1/a,R=1/o,w=g*i*.5,x=.5*(a*u+o*c),C=this._upperLeft,E=this._upperRight,P=this._lowerLeft,F=this._lowerRight;p.vec2.set(C,-w,-x),p.vec2.set(E,w,-x),p.vec2.set(P,-w,x),p.vec2.set(F,w,x),d.mat2d.identity(this._mat2),d.mat2d.translate(this._mat2,this._mat2,[v+m,y+b]),0!==s&&d.mat2d.rotate(this._mat2,this._mat2,h),p.vec2.transformMat2d(C,C,this._mat2),p.vec2.transformMat2d(E,E,this._mat2),p.vec2.transformMat2d(P,P,this._mat2),p.vec2.transformMat2d(F,F,this._mat2);var S=this._clipData;S.set([2*P[0]*O-1,2*(o-P[1])*R-1,2*F[0]*O-1,2*(o-F[1])*R-1,2*C[0]*O-1,2*(o-C[1])*R-1,2*E[0]*O-1,2*(o-E[1])*R-1]),this._clipRendererInitialized||this._initializeClipRenderer(t),this._clipVBO.setData(S),this._boundFBO=t.getBoundFramebufferObject(),t.bindFramebuffer(this._clipFBO),t.setDepthWriteEnabled(!0),t.setStencilWriteMask(255),t.setClearColor(0,0,0,0),t.setClearDepth(1),t.setClearStencil(0),t.clear(t.gl.COLOR_BUFFER_BIT|t.gl.DEPTH_BUFFER_BIT|t.gl.STENCIL_BUFFER_BIT),t.setDepthWriteEnabled(!1),this._clipFrame=!0}}else this._clipFrame=!1},w.prototype._afterRenderChildren=function(){var e=this.context;if(e.logIno(),this._clipFrame&&this._clipRendererInitialized){if(e.bindFramebuffer(this._boundFBO),this._boundFBO=null,e.bindVAO(this._clipVAO),e.bindProgram(this._clipStencilProgram),e.setDepthWriteEnabled(!1),e.setDepthTestEnabled(!1),e.setStencilTestEnabled(!0),e.setBlendingEnabled(!1),e.setColorMask(!1,!1,!1,!1),e.setStencilOp(7680,7680,7681),e.setStencilWriteMask(255),e.setStencilFunction(519,1,255),e.drawElements(4,6,5123,0),e.bindVAO(),e.setColorMask(!0,!0,!0,!0),null!=this.background){var t=this.background.color,r=t.r,i=t.g,n=t.b,s=t.a;e.setClearColor(s*r/255,s*i/255,s*n/255,s)}else e.setClearColor(0,0,0,0);e.clear(e.gl.COLOR_BUFFER_BIT),e.setBlendingEnabled(!0),e.setStencilFunction(514,1,255),this.painter.blitTexture(e,this._clipFBO.colorTexture,9728,1),e.setStencilTestEnabled(!1)}},w.prototype.doRender=function(t){var r=this.context,i=t.state,n=t.pixelRatio;this._resizeCanvas(t),this.context.enforceState(),r.setViewport(0,0,n*i.size[0],n*i.size[1]),r.setDepthWriteEnabled(!0),r.setStencilWriteMask(255),e.prototype.doRender.call(this,t)},w.prototype.takeScreenshot=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var i,n,s,a,o,h,l,d,c,p,u,f,g;return r.__generator(this,(function(m){return i=R.screenshotSuperSampleSettings(e,this._supersampleScreenshots,this._state.padding),n=i.framebufferWidth,s=i.framebufferHeight,a=this.context,o=e.layers,h=this.children,l=r.__assign(r.__assign({},this._renderParameters),{drawPhase:null,globalOpacity:1,stationary:!0,state:this._renderParameters.state.clone(),pixelRatio:i.pixelRatio,time:Date.now(),deltaTime:0,blendMode:null,effects:null,inFadeTransition:!1}),null!=e.rotation&&((d=l.state.viewpoint).rotation=e.rotation,l.state.viewpoint=d),o.length>0&&(h=[],o.forEach((function(e){var r=t.find((function(t){return t.layer.id===e.id}));r&&"container"in r&&r.container&&h.push(r.container)}))),c=new _.FramebufferObject(a,{colorTarget:0,depthStencilTarget:3,width:n,height:s}),p=a.getBoundFramebufferObject(),u=a.getViewport(),a.bindFramebuffer(c),a.setViewport(0,0,n,s),this._renderChildren(h,l),f=this._readbackScreenshot(i),a.bindFramebuffer(p),a.setViewport(u.x,u.y,u.width,u.height),this.requestRender(),g=this._ensureScreenshotEncodeCanvas(),[2,R.encodeResult(f,e,g,{flipY:!0,premultipliedAlpha:!0})]}))}))},w.prototype._ensureScreenshotEncodeCanvas=function(){return this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas")),this._screenshotEncodeCanvas},w.prototype._readbackScreenshot=function(e){var t=e.framebufferWidth,r=e.framebufferHeight,i=e.region,n=e.resample,s=this.context.gl;if(n){var a=R.createEmptyImageData(t,r,this._ensureScreenshotEncodeCanvas());s.readPixels(0,0,t,r,6408,5121,new Uint8Array(a.data.buffer));var o=R.createEmptyImageData(i.width,i.height,this._ensureScreenshotEncodeCanvas());return R.resampleHermite(a,o,!0,n.region.x,r-(n.region.y+n.region.height),n.region.width,n.region.height)}a=R.createEmptyImageData(i.width,i.height,this._ensureScreenshotEncodeCanvas());return s.readPixels(i.x,r-(i.y+i.height),i.width,i.height,6408,5121,new Uint8Array(a.data.buffer)),a},w.prototype._resizeCanvas=function(e){var t=this._canvas,r=t.style,i=e.state.size,n=e.pixelRatio,s=i[0],a=i[1],o=Math.round(s*n),h=Math.round(a*n);t.width===o&&t.height===h||(t.width=o,t.height=h),r.width=s+"px",r.height=a+"px"},w.prototype._initializeClipRenderer=function(e){if(this._clipRendererInitialized)return!0;var t=y.stencil.attributes,r=_.createProgram(e,y.stencil);if(!r)return!1;var i=_.BufferObject.createVertex(e,35040,32),n=new Uint16Array([0,1,2,2,1,3]),s=_.BufferObject.createIndex(e,35044,n),a=new _.VertexArrayObject(e,t,{geometry:[{name:"a_pos",count:2,type:5126,offset:0,stride:8,normalized:!1,divisor:0}]},{geometry:i},s);return this._clipStencilProgram=r,this._clipVBO=i,this._clipVAO=a,this._clipRendererInitialized=!0,!0},w.prototype._emptyTrash=function(){for(;this._trash.size>0;){var e=o.valuesOfSet(this._trash);this._trash.clear();for(var t=0,r=e;t<r.length;t++){r[t].processDetach()}}},w.prototype._isLabelDrawPhaseRequired=function(e){for(var t=!1,r=0,i=e;r<i.length;r++){var n=i[r];if(!(n instanceof f.Container)){t=t||!1;break}if(n.hasLabels)return!0;t=t||this._isLabelDrawPhaseRequired(n.children)}return t},w}(f.Container);t.Stage=w}));