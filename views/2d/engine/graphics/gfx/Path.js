// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/extendsHelper","dojo/_base/lang","dojox/gfx/_base","dojox/gfx/matrix","./Shape"],function(t,s,e,i,h,a,o){var r=function(t){function s(s){t.call(this),this.segments=[],this.tbbox=null,this.absolute=!0,this.last={},this.segmented=!1,this._validSegments={m:2,l:2,h:1,v:1,c:6,s:4,q:4,t:2,a:7,z:0},this._2PI=2*Math.PI,this.rawNode=s,this.shape=i.clone(h.defaultPath)}return e(s,t),s.prototype.setAbsoluteMode=function(t){return this._confirmSegmented(),this.absolute="string"==typeof t?"absolute"===t:t,this},s.prototype.getAbsoluteMode=function(){return this._confirmSegmented(),this.absolute},s.prototype.getBoundingBox=function(){return this._confirmSegmented(),this.bbox&&"l"in this.bbox?{x:this.bbox.l,y:this.bbox.t,width:this.bbox.r-this.bbox.l,height:this.bbox.b-this.bbox.t}:null},s.prototype._getRealBBox=function(){if(this._confirmSegmented(),this.tbbox)return this.tbbox;var t=this.bbox,s=this._getRealMatrix();this.bbox=null;for(var e=0,i=this.segments.length;i>e;++e)this._updateWithSegment(this.segments[e],s);var h=this.bbox;return this.bbox=t,this.tbbox=h?[{x:h.l,y:h.t},{x:h.r,y:h.t},{x:h.r,y:h.b},{x:h.l,y:h.b}]:null,this.tbbox},s.prototype.getLastPosition=function(){return this._confirmSegmented(),"x"in this.last?this.last:null},s.prototype._applyTransform=function(){return this.tbbox=null,t.prototype._applyTransform.call(this),this},s.prototype._updateBBox=function(t,s,e){if(e){var i=a.multiplyPoint(e,t,s);t=i.x,s=i.y}this.bbox&&"l"in this.bbox?(this.bbox.l>t&&(this.bbox.l=t),this.bbox.r<t&&(this.bbox.r=t),this.bbox.t>s&&(this.bbox.t=s),this.bbox.b<s&&(this.bbox.b=s)):this.bbox={l:t,b:s,r:t,t:s}},s.prototype._updateWithSegment=function(t,s){var e,i=t.args,a=i.length;switch(t.action){case"M":case"L":case"C":case"S":case"Q":case"T":for(e=0;a>e;e+=2)this._updateBBox(i[e],i[e+1],s);this.last.x=i[a-2],this.last.y=i[a-1],this.absolute=!0;break;case"H":for(e=0;a>e;++e)this._updateBBox(i[e],this.last.y,s);this.last.x=i[a-1],this.absolute=!0;break;case"V":for(e=0;a>e;++e)this._updateBBox(this.last.x,i[e],s);this.last.y=i[a-1],this.absolute=!0;break;case"m":var o=0;"x"in this.last||(this._updateBBox(this.last.x=i[0],this.last.y=i[1],s),o=2);for(e=o;a>e;e+=2)this._updateBBox(this.last.x+=i[e],this.last.y+=i[e+1],s);this.absolute=!1;break;case"l":case"t":for(e=0;a>e;e+=2)this._updateBBox(this.last.x+=i[e],this.last.y+=i[e+1],s);this.absolute=!1;break;case"h":for(e=0;a>e;++e)this._updateBBox(this.last.x+=i[e],this.last.y,s);this.absolute=!1;break;case"v":for(e=0;a>e;++e)this._updateBBox(this.last.x,this.last.y+=i[e],s);this.absolute=!1;break;case"c":for(e=0;a>e;e+=6)this._updateBBox(this.last.x+i[e],this.last.y+i[e+1],s),this._updateBBox(this.last.x+i[e+2],this.last.y+i[e+3],s),this._updateBBox(this.last.x+=i[e+4],this.last.y+=i[e+5],s);this.absolute=!1;break;case"s":case"q":for(e=0;a>e;e+=4)this._updateBBox(this.last.x+i[e],this.last.y+i[e+1],s),this._updateBBox(this.last.x+=i[e+2],this.last.y+=i[e+3],s);this.absolute=!1;break;case"A":for(e=0;a>e;e+=7)this._updateBBox(i[e+5],i[e+6],s);this.last.x=i[a-2],this.last.y=i[a-1],this.absolute=!0;break;case"a":for(e=0;a>e;e+=7)this._updateBBox(this.last.x+=i[e+5],this.last.y+=i[e+6],s);this.absolute=!1}var r=[t.action];for(e=0;a>e;++e)r.push(h.formatNumber(i[e],!0));if("string"==typeof this.shape.path)this.shape.path+=r.join("");else for(e=0,a=r.length;a>e;++e)this.shape.path.push(r[e]);"string"==typeof this.shape.path&&this.rawNode.setAttribute("d",this.shape.path)},s.prototype._pushSegment=function(t,s){this.tbbox=null;var e,i=this._validSegments[t.toLowerCase()];"number"==typeof i&&(i?s.length>=i&&(e={action:t,args:s.slice(0,s.length-s.length%i)},this.segments.push(e),this._updateWithSegment(e)):(e={action:t,args:[]},this.segments.push(e),this._updateWithSegment(e)))},s.prototype._collectArgs=function(t,s){for(var e=0;e<s.length;++e){var i=s[e];"boolean"==typeof i?t.push(i?1:0):"number"==typeof i?t.push(i):i instanceof Array?this._collectArgs(t,i):"x"in i&&"y"in i&&t.push(i.x,i.y)}},s.prototype._confirmSegmented=function(){if(!this.segmented){var t=this.shape.path;this.shape.path=[],this._setPath(t),this.shape.path=this.shape.path.join(""),this.segmented=!0}},s.prototype._setPath=function(t){var s=i.isArray(t)?t:t.match(h.pathSvgRegExp);if(this.segments=[],this.absolute=!0,this.bbox={},this.last={},s){for(var e="",a=[],o=s.length,r=0;o>r;++r){var n=s[r],l=parseFloat(n);isNaN(l)?(e&&this._pushSegment(e,a),a=[],e=n):a.push(l)}this._pushSegment(e,a)}},s.prototype.setShape=function(s){return t.prototype.setShape.call(this,"string"==typeof s?{path:s}:s),this.segmented=!1,this.segments=[],this.shape.path?this.rawNode.setAttribute("d",this.shape.path):this.rawNode.removeAttribute("d"),this},s.nodeType="path",s}(o["default"]);Object.defineProperty(s,"__esModule",{value:!0}),s["default"]=r});