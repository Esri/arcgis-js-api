/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../../core/promiseUtils","../../../../layers/support/TilemapCache","../../tiling/TileKey"],(function(e,t,i){"use strict";return function(){function l(e){if(e instanceof t.TilemapCache)this._tilemapCache=e;else{if(!e||!("index"in e))throw new Error("Invalid tilemap!");this._tilemap=e.index}}var r=l.prototype;return r.dataKey=function(t,l){if(this._tilemapCache){const{level:r,row:o,col:a}=t,n=new i(t);return this._tilemapCache.fetchAvailabilityUpsample(r,o,a,n,l).then((()=>(n.world=t.world,n))).catch((t=>{if(e.isAbortError(t))throw t;return null}))}return this._getIndexedDataKey(t)},r.forEach=function(e,t,i,l,r){this._callback=r,this._maxLevel=t+e,this._forEach(this._tilemap,t,i,l)},r._forEach=function(e,t,i,l){0!==e&&(this._callback(t,i,l),t!==this._maxLevel&&"object"==typeof e&&(this._forEach(e[0],t+1,2*i,2*l),this._forEach(e[1],t+1,2*i,2*l+1),this._forEach(e[2],t+1,2*i+1,2*l),this._forEach(e[3],t+1,2*i+1,2*l+1)))},r._getIndexedDataKey=function(t){const l=[t];if(t.level<0||t.row<0||t.col<0||t.row>>t.level>0||t.col>>t.level>0)return e.resolve(null);let r=t;for(;0!==r.level;)r=new i(r.level-1,r.row>>1,r.col>>1,r.world),l.push(r);let o,a,n=this._tilemap,c=l.pop();if(1===n)return e.resolve(c);for(;l.length;)if(o=l.pop(),a=(1&o.col)+((1&o.row)<<1),n){if(0===n[a]){c=null;break}if(1===n[a]){c=o;break}c=o,n=n[a]}return e.resolve(c)},l}()}));
