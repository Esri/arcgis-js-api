/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["../../../../core/promiseUtils","../../../../layers/support/TilemapCache","../../tiling/TileKey"],(function(e,t,i){"use strict";return function(){function r(e){if(e instanceof t.TilemapCache)this._tilemapCache=e;else{if(!e||!("index"in e))throw new Error("Invalid tilemap!");this._tilemap=e.index}}var l=r.prototype;return l.dataKey=function(t,r){if(this._tilemapCache){const{level:l,row:o,col:a}=t,n=new i(t);return this._tilemapCache.fetchAvailabilityUpsample(l,o,a,n,r).then((()=>(n.world=t.world,n))).catch((t=>{if(e.isAbortError(t))throw t;return null}))}return this._getIndexedDataKey(t)},l.forEach=function(e,t,i,r,l){this._callback=l,this._maxLevel=t+e,this._forEach(this._tilemap,t,i,r)},l._forEach=function(e,t,i,r){0!==e&&(this._callback(t,i,r),t!==this._maxLevel&&"object"==typeof e&&(this._forEach(e[0],t+1,2*i,2*r),this._forEach(e[1],t+1,2*i,2*r+1),this._forEach(e[2],t+1,2*i+1,2*r),this._forEach(e[3],t+1,2*i+1,2*r+1)))},l._getIndexedDataKey=function(e){const t=[e];if(e.level<0||e.row<0||e.col<0||e.row>>e.level>0||e.col>>e.level>0)return Promise.resolve(null);let r=e;for(;0!==r.level;)r=new i(r.level-1,r.row>>1,r.col>>1,r.world),t.push(r);let l,o,a=this._tilemap,n=t.pop();if(1===a)return Promise.resolve(n);for(;t.length;)if(l=t.pop(),o=(1&l.col)+((1&l.row)<<1),a){if(0===a[o]){n=null;break}if(1===a[o]){n=l;break}n=l,a=a[o]}return Promise.resolve(n)},r}()}));
