// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","../../../../../Color","../../../unitBezier","../GeometryUtils","./expression"],(function(e,t,r,n,a,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Step=t.Interpolate=void 0;var o=6/29,u=3*o*o,p=Math.PI/180,l=180/Math.PI;function s(e){return e>.008856451679035631?Math.pow(e,1/3):e/u+4/29}function h(e){return e>o?e*e*e:u*(e-4/29)}function c(e){return 255*(e<=.0031308?12.92*e:1.055*Math.pow(e,1/2.4)-.055)}function f(e){return(e/=255)<=.04045?e/12.92:Math.pow((e+.055)/1.055,2.4)}function v(e){var t=f(e.r),r=f(e.g),n=f(e.b),a=s((.4124564*t+.3575761*r+.1804375*n)/.95047),i=s((.2126729*t+.7151522*r+.072175*n)/1);return{l:116*i-16,a:500*(a-i),b:200*(i-s((.0193339*t+.119192*r+.9503041*n)/1.08883)),alpha:e.a}}function w(e){var t=(e.l+16)/116,n=isNaN(e.a)?t:t+e.a/500,a=isNaN(e.b)?t:t-e.b/200;return t=1*h(t),n=.95047*h(n),a=1.08883*h(a),new r([c(3.2404542*n-1.5371385*t-.4985314*a),c(-.969266*n+1.8760108*t+.041556*a),c(.0556434*n-.2040259*t+1.0572252*a),e.alpha])}function b(e){var t=v(e),r=t.l,n=t.a,a=t.b,i=Math.atan2(a,n)*l;return{h:i<0?i+360:i,c:Math.sqrt(n*n+a*a),l:r,alpha:e.a}}function g(e,t,r){var n=t-e;return e+r*(n>180||n<-180?n-360*Math.round(n/360):n)}var x=function(){function e(e,t,r,n){this.operator=e,this.input=t,this.stops=r,this.interpolation=n}return e.parse=function(t){if(t.length<5)throw new Error('"'+t[0]+'" expects at least 4 arguments.');var r=t[1];if(!Array.isArray(r)||0===r.length)throw new Error('"'+t[0]+'" expects an interpolation type expression.');switch(r[0]){case"linear":break;case"exponential":if("number"!=typeof r[1])throw new Error('"'+t[0]+'" expects a numeric base for exponential interpolation.');break;case"cubic-bezier":if(5!==r.length)throw new Error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.");for(var n=1;n<5;n++){var a=r[n];if("number"!=typeof a||a<0||a>1)throw new Error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.")}break;default:throw new Error('"'+t[0]+'" unknown interpolation type "'+r[0]+'".')}if(t.length%2!=1)throw new Error('"'+t[0]+'" expects an even number of arguments.');var o=i.createExpression(t[2]),u=[];for(n=3;n<t.length;n+=2){var p=t[n];if("number"!=typeof p)throw new Error('"'+t[0]+'" requires stop inputs as literal numbers.');if(u.length&&u[u.length-1][0]>=p)throw new Error('"'+t[0]+'" requires strictly ascending stop inputs.');u.push([p,i.createExpression(t[n+1])])}return new e(t[0],o,u,r)},e.prototype.evaluate=function(t,r){var n=this.stops;if(1===n.length)return n[0][1].evaluate(t,r);var i=this.input.evaluate(t,r);if(i<=n[0][0])return n[0][1].evaluate(t,r);if(i>=n[n.length-1][0])return n[n.length-1][1].evaluate(t,r);for(var o=0;++o<n.length&&!(i<n[o][0]););var u,l,s,h=n[o-1][0],c=n[o][0],f=e.interpolationRatio(this.interpolation,i,h,c),x=n[o-1][1].evaluate(t,r),m=n[o][1].evaluate(t,r);return"interpolate"===this.operator?Array.isArray(x)?x.map((function(e,t){return a.interpolate(e,m[t],f)})):a.interpolate(x,m,f):"interpolate-hcl"===this.operator?(u=function(e,t,r){return{h:g(e.h,t.h,r),c:a.interpolate(e.c,t.c,r),l:a.interpolate(e.l,t.l,r),alpha:a.interpolate(e.alpha,t.alpha,r)}}(b(x),b(m),f),l=u.h*p,s=u.c,w({l:u.l,a:Math.cos(l)*s,b:Math.sin(l)*s,alpha:u.alpha})):w(function(e,t,r){return{l:a.interpolate(e.l,t.l,r),a:a.interpolate(e.a,t.a,r),b:a.interpolate(e.b,t.b,r),alpha:a.interpolate(e.alpha,t.alpha,r)}}(v(x),v(m),f))},e.interpolationRatio=function(t,r,a,i){var o=0;if("exponential"===t[0])o=e.exponentialInterpolationRatio(r,t[1],a,i);else if("linear"===t[0])o=e.exponentialInterpolationRatio(r,1,a,i);else if("cubic-bezier"===t[0]){o=n.unitBezier(t[1],t[2],t[3],t[4])(e.exponentialInterpolationRatio(r,1,a,i),1e-5)}return o},e.exponentialInterpolationRatio=function(e,t,r,n){var a=n-r;if(0===a)return 0;var i=e-r;return 1===t?i/a:(Math.pow(t,i)-1)/(Math.pow(t,a)-1)},e}();t.Interpolate=x;var m=function(){function e(e,t){this.input=e,this.stops=t}return e.parse=function(t){if(t.length<5)throw new Error('"step" expects at least 4 arguments.');if(t.length%2!=1)throw new Error('"step" expects an even number of arguments.');var r=i.createExpression(t[1]),n=[];n.push([-1/0,i.createExpression(t[2])]);for(var a=3;a<t.length;a+=2){var o=t[a];if("number"!=typeof o)throw new Error('"step" requires stop inputs as literal numbers.');if(n.length&&n[n.length-1][0]>=o)throw new Error('"step" requires strictly ascending stop inputs.');n.push([o,i.createExpression(t[a+1])])}return new e(r,n)},e.prototype.evaluate=function(e,t){var r=this.stops;if(1===r.length)return r[0][1].evaluate(e,t);for(var n=this.input.evaluate(e,t),a=0;++a<r.length&&!(n<r[a][0]););return this.stops[a-1][1].evaluate(e,t)},e}();t.Step=m}));