// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","../../../../../Color","./expression"],(function(e,r,t,n){"use strict";function a(e,r){return{kind:"array",itemType:e,n:r}}Object.defineProperty(r,"__esModule",{value:!0}),r.TypeOf=r.Literal=r.Coerce=r.Assert=r.valueToString=r.typeToString=r.array=r.ErrorType=r.ValueType=r.ObjectType=r.ColorType=r.BooleanType=r.StringType=r.NumberType=r.NullType=void 0,r.NullType={kind:"null"},r.NumberType={kind:"number"},r.StringType={kind:"string"},r.BooleanType={kind:"boolean"},r.ColorType={kind:"color"},r.ObjectType={kind:"object"},r.ValueType={kind:"value"},r.ErrorType={kind:"error"},r.array=a;var o=[r.NullType,r.NumberType,r.StringType,r.BooleanType,r.ColorType,r.ObjectType,a(r.ValueType)];function i(e){if("array"===e.kind){var r=i(e.itemType);return"number"==typeof e.n?"array<"+r+", "+e.n+">":"value"===e.itemType.kind?"array":"array<"+r+">"}return e.kind}function u(e){if(null===e)return r.NullType;if("string"==typeof e)return r.StringType;if("boolean"==typeof e)return r.BooleanType;if("number"==typeof e)return r.NumberType;if(e instanceof t)return r.ColorType;if(Array.isArray(e)){for(var n=void 0,o=0,i=e;o<i.length;o++){var l=u(i[o]);if(n){if(n===l)continue;n=r.ValueType;break}n=l}return a(n||r.ValueType,e.length)}return r.ObjectType}function l(e,r){if("error"===e.kind)return null;if("array"===r.kind){if("array"===e.kind&&(0===e.n&&"value"===e.itemType.kind||!l(e.itemType,r.itemType))&&("number"!=typeof r.n||r.n===e.n))return null}else{if(r.kind===e.kind)return null;if("value"===r.kind)for(var t=0,n=o;t<n.length;t++){if(!l(n[t],e))return null}}return"Expected "+i(r)+" but found "+i(e)+" instead."}function p(e){var r=typeof e;return null===e?"":"string"===r||"number"===r||"boolean"===r?String(e):e instanceof t?e.toString():JSON.stringify(e)}r.typeToString=i,r.valueToString=p;var y=function(){function e(e,r){this.type=e,this.args=r}return e.parse=function(t){var o=t[0];if(t.length<2)throw new Error(o+" expects at least one argument.");var i,u=1;if("array"===o){if(t.length>2){switch(t[1]){case"string":i=r.StringType;break;case"number":i=r.NumberType;break;case"boolean":i=r.BooleanType;break;default:throw new Error('"array" type argument must be string, number or boolean')}u++}else i=r.ValueType;var l=void 0;if(t.length>3){if(null!==(l=t[2])&&("number"!=typeof l||l<0||l!==Math.floor(l)))throw new Error('"array" length argument must be a positive integer literal');u++}i=a(i,l)}else switch(o){case"string":i=r.StringType;break;case"number":i=r.NumberType;break;case"boolean":i=r.BooleanType;break;case"object":i=r.ObjectType}for(var p=[];u<t.length;u++){var y=n.createExpression(t[u]);p.push(y)}return new e(i,p)},e.prototype.evaluate=function(e,r){for(var t=0,n=this.args;t<n.length;t++){var a=n[t].evaluate(e,r);if(!l(u(a),this.type))return a}return null},e}();r.Assert=y;var s=function(){function e(e,r){this.type=e,this.args=r}return e.parse=function(r){var t=r[0];if("to-boolean"===t||"to-string"===t){if(2!==r.length)throw new Error(t+" expects one argument.")}else if(r.length<2)throw new Error(t+" expects at least one argument.");for(var a=e.types[t],o=[],i=1;i<r.length;i++){var u=n.createExpression(r[i]);o.push(u)}return new e(a,o)},e.prototype.evaluate=function(e,n){if(this.type===r.BooleanType)return Boolean(this.args[0].evaluate(e,n));if(this.type===r.StringType)return p(this.args[0].evaluate(e,n));if(this.type===r.NumberType){for(var a=0,o=this.args;a<o.length;a++){if(null===(y=o[a].evaluate(e,n)))return 0;var i=Number(y);if(!isNaN(i))return i}return null}if(this.type===r.ColorType){for(var u=0,l=this.args;u<l.length;u++){var y;if((y=l[u].evaluate(e,n))instanceof t)return y;if("string"==typeof y)return t.fromString(y);if(Array.isArray(y)&&(3===y.length||4===y.length))return t.fromArray(y)}return null}},e.types={"to-boolean":r.BooleanType,"to-color":r.ColorType,"to-number":r.NumberType,"to-string":r.StringType},e}();r.Coerce=s;var f=function(){function e(e){this.val=e}return e.parse=function(r){if(2!==r.length)throw new Error('"literal" expects 1 argument');return new e(r[1])},e.prototype.evaluate=function(e,r){return this.val},e}();r.Literal=f;var g=function(){function e(e){this.arg=e}return e.parse=function(r){if(2!==r.length)throw new Error('"typeof" expects 1 argument');return new e(n.createExpression(r[1]))},e.prototype.evaluate=function(e,r){return i(u(this.arg.evaluate(e,r)))},e}();r.TypeOf=g}));