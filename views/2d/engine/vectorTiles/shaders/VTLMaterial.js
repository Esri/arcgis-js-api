/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/maybe","../MemoryBuffer"],(function(t,e,n,o){"use strict";let s=function(){function t(t){this._locations=new Map,this._key=t}var s=t.prototype;return s.defines=function(){return[]},s.getStride=function(){return this._layoutInfo||this._buildAttributesInfo(),this._stride},s.getAttributeLocations=function(){return 0===this._locations.size&&this._buildAttributesInfo(),this._locations},s.getLayoutInfo=function(){return this._layoutInfo||this._buildAttributesInfo(),this._layoutInfo},s.getEncodingInfos=function(){return this._propertyEncodingInfo||this._buildAttributesInfo(),this._propertyEncodingInfo},s.getUniforms=function(){return this._uniforms||this._buildAttributesInfo(),this._uniforms},s.getShaderHeader=function(){return this._shaderHeader||this._buildAttributesInfo(),this._shaderHeader},s.getShaderMain=function(){return this._shaderMain||this._buildAttributesInfo(),this._shaderMain},s.setDataUniforms=function(t,e,n,o,s){const r=this.getUniforms();for(const i of r){const{name:r,type:a,getValue:c}=i,u=c(n,e,o,s);if(null!==u)switch(a){case"float":t.setUniform1f(r,u);break;case"vec2":t.setUniform2fv(r,u);break;case"vec4":t.setUniform4fv(r,u)}}},s.encodeAttributes=function(t,e,n,o){const s=this.attributesInfo(),r=this.getEncodingInfos(),i=[];let a=0,c=0;for(const f of Object.keys(r)){var u;const l=r[f],{type:d,precisionFactor:h,isLayout:y}=s[f],_=y?n.getLayoutProperty(f):n.getPaintProperty(f),p=null==(u=_.interpolator)?void 0:u.getInterpolationRange(e);let b=0;for(const n of l){const{offset:s,bufferElementsToAdd:r}=n;if(r>0){for(let t=0;t<r;t++)i.push(0);a+=c,c=n.bufferElementsToAdd}const u=null!=o?o:_.getValue(p?p[b]:e,t);switch(d){case 0:case 1:i[a]|=this._encodeByte(u*(h||1),8*s);break;case 2:case 3:i[a]|=this._encodeShort(u*(h||1),8*s);break;case 4:case 5:i[a]|=this._encodeByte(u*(h||1),8*s),i[a]|=this._encodeByte(u*(h||1),8*s+8);break;case 6:case 7:i[a]|=this._encodeShort(u*(h||1),8*s),i[a]|=this._encodeShort(u*(h||1),8*s+16);break;case 8:case 9:i[a]|=this._encodeByte(u*(h||1),8*s),i[a]|=this._encodeByte(u*(h||1),8*s+8),i[a]|=this._encodeByte(u*(h||1),8*s+16),i[a]|=this._encodeByte(u*(h||1),8*s+24);break;case 10:i[a]=this._encodeColor(u);break;case 11:case 12:this._encodePattern(a,i,u);break;default:throw new Error("Unsupported encoding type")}b++}}return i},s.getAtributeState=function(t){let e=0;const n=3+2*t;return e|=this._bit(n),e|=this._bit(n+1)<<1,e},s._buildAttributesInfo=function(){const e=[],n={},o={};let s=-1;const r=this.attributesInfo(),i=this.attributes();let a=-1;for(const l of i){a++;const i=this.getAtributeState(a);if(0===i||3===i)continue;const c=r[l],u=[];n[l]=u;const f=c.type;for(let n=0;n<i;n++){const{dataType:n,bytesPerElement:r,count:i,normalized:a}=t._encodingInfo[f],c=r*i;let l=o[n],d=0;if(!l||l.count+i>4)s++,l={dataIndex:s,count:0,offset:0},4!==i&&(o[n]=l),e.push({location:-1,name:"a_data_"+s,count:i,type:n,normalized:a}),d=Math.ceil(Math.max(c/4,1));else{const t=e[l.dataIndex];t.count+=i;d=Math.ceil(Math.max(t.count*r/4,1))-Math.ceil(Math.max(l.offset/4,1))}u.push({dataIndex:l.dataIndex,offset:l.offset,bufferElementsToAdd:d}),l.offset+=c,l.count+=i}}for(const t of e)switch(t.type){case 5120:case 5121:t.count=4;case 5122:case 5123:t.count+=t.count%2}this._buildVertexBufferLayout(e);let c=0;const u=this._layoutInfo.geometry;for(const t of u)this._locations.set(t.name,c++);const f=this._layoutInfo.opacity;if(f)for(const t of f)this._locations.set(t.name,c++);this._buildShaderInfo(e,n),this._propertyEncodingInfo=n},s._buildVertexBufferLayout=function(t){const e={},n=this.geometryInfo();let o=n[0].stride;if(0===t.length)e.geometry=n;else{const s=[];let i=o;for(const e of t)o+=r(e.type)*e.count;for(const t of n){const e={...t};e.stride=o,s.push(e)}for(const e of t)s.push({name:e.name,count:e.count,type:e.type,offset:i,stride:o,normalized:e.normalized||!1,divisor:0}),i+=r(e.type)*e.count;e.geometry=s}this.opacityInfo()&&(e.opacity=this.opacityInfo()),this._layoutInfo=e,this._stride=o},s._buildShaderInfo=function(e,o){let s="\n",r="\n";const a=[];for(const t of e)s+=`attribute ${this._getType(t.count)} ${t.name};\n`;const c=this.attributes(),u=this.attributesInfo();let f=-1;for(const l of c){f++;const{name:e,type:c,precisionFactor:d,isLayout:h}=u[l],y=d&&1!==d?" * "+1/d:"",{bytesPerElement:_,count:p}=t._encodingInfo[c],b=t=>`a_data_${t.dataIndex}${i(p,t.offset,_)}`;switch(this.getAtributeState(f)){case 0:{const t=this._getType(p),o=`u_${e}`;a.push({name:o,type:t,getValue:(t,e,o,s)=>{const r=h?t.getLayoutValue(l,e):t.getPaintValue(l,e);if(11===c){const o=t.getDashKey(r,t.getLayoutValue("line-cap",e)),i=s.getMosaicItemPosition(o,!1);if(n.isNone(i))return null;const{tl:a,br:c}=i;return[a[0],c[1],c[0],a[1]]}if(12===c){const t=s.getMosaicItemPosition(r,-1===l.indexOf("line-"));if(n.isNone(t))return null;const{tl:e,br:o}=t;return[e[0],o[1],o[0],e[1]]}if(10===c){const t=r[3];return[t*r[0],t*r[1],t*r[2],t]}return r}}),s+=`uniform ${t} ${o};\n`,r+=`${t} ${e} = ${o};\n`}break;case 1:{const t=b(o[l][0]);r+=`${this._getType(p)} ${e} = ${t}${y};\n`}break;case 2:{const t=`u_t_${e}`;a.push({name:t,type:"float",getValue:(t,e,n,o)=>(h?t.getLayoutProperty(l):t.getPaintProperty(l)).interpolator.interpolationUniformValue(n,e)}),s+=`uniform float ${t};\n`;const n=b(o[l][0]),i=b(o[l][1]);r+=`${this._getType(p)} ${e} = mix(${n}${y}, ${i}${y}, ${t});\n`}}}this._shaderHeader=s,this._shaderMain=r,this._uniforms=a},s._bit=function(t){return(this._key&1<<t)>>t},s._getType=function(t){switch(t){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4"}throw new Error("Invalid count")},s._encodeColor=function(t){const e=255*t[3];return o.i8888to32(t[0]*e,t[1]*e,t[2]*e,e)},s._encodePattern=function(t,e,n){if(!n||!n.rect)return;const o=2,s=n.rect,r=n.width,i=n.height;e[t]=this._encodeShort(s.x+o,0),e[t]|=this._encodeShort(s.y+o+i,16),e[t+1]=this._encodeShort(s.x+o+r,0),e[t+1]|=this._encodeShort(s.y+o,16)},s._encodeByte=function(t,e){return(255&t)<<e},s._encodeShort=function(t,e){return(65535&t)<<e},e._createClass(t,[{key:"key",get:function(){return this._key}},{key:"type",get:function(){return 7&this._key}}]),t}();s._encodingInfo={0:{dataType:5120,bytesPerElement:1,count:1,normalized:!1},1:{dataType:5121,bytesPerElement:1,count:1,normalized:!1},2:{dataType:5122,bytesPerElement:2,count:1,normalized:!1},3:{dataType:5123,bytesPerElement:2,count:1,normalized:!1},4:{dataType:5120,bytesPerElement:1,count:2,normalized:!1},5:{dataType:5121,bytesPerElement:1,count:2,normalized:!1},6:{dataType:5122,bytesPerElement:2,count:2,normalized:!1},7:{dataType:5123,bytesPerElement:2,count:2,normalized:!1},8:{dataType:5120,bytesPerElement:1,count:4,normalized:!1},9:{dataType:5121,bytesPerElement:1,count:4,normalized:!1},10:{dataType:5121,bytesPerElement:1,count:4,normalized:!0},11:{dataType:5123,bytesPerElement:2,count:4,normalized:!1},12:{dataType:5123,bytesPerElement:2,count:4,normalized:!1}};const r=t=>{switch(t){case 5126:case 5124:case 5125:return 4;case 5122:case 5123:return 2;case 5120:case 5121:return 1}},i=(t,e,n)=>{const o=e/n;if(1===t)switch(o){case 0:return".x";case 1:return".y";case 2:return".z";case 3:return".w"}else if(2===t)switch(o){case 0:return".xy";case 1:return".yz";case 2:return".zw"}else if(3===t)switch(o){case 0:return".xyz";case 1:return".yzw"}return""};t.VTLMaterial=s,Object.defineProperty(t,"__esModule",{value:!0})}));
