/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/maybe","../MemoryBuffer","./enums","../../../../webgl/enums","../../../../webgl/VertexElementDescriptor"],(function(t,e,n,o,i,s,a){"use strict";let r=function(){function t(t){this._locations=new Map,this._key=t}var r=t.prototype;return r.defines=function(){return[]},r.getStride=function(){return this._layoutInfo||this._buildAttributesInfo(),this._stride},r.getAttributeLocations=function(){return 0===this._locations.size&&this._buildAttributesInfo(),this._locations},r.getLayoutInfo=function(){return this._layoutInfo||this._buildAttributesInfo(),this._layoutInfo},r.getEncodingInfos=function(){return this._propertyEncodingInfo||this._buildAttributesInfo(),this._propertyEncodingInfo},r.getUniforms=function(){return this._uniforms||this._buildAttributesInfo(),this._uniforms},r.getShaderHeader=function(){return this._shaderHeader||this._buildAttributesInfo(),this._shaderHeader},r.getShaderMain=function(){return this._shaderMain||this._buildAttributesInfo(),this._shaderMain},r.setDataUniforms=function(t,e,n,o,i){const s=this.getUniforms();for(const a of s){const{name:s,type:r,getValue:c}=a,u=c(n,e,o,i);if(null!==u)switch(r){case"float":t.setUniform1f(s,u);break;case"vec2":t.setUniform2fv(s,u);break;case"vec4":t.setUniform4fv(s,u)}}},r.encodeAttributes=function(t,e,n,o){const s=this.attributesInfo(),a=this.getEncodingInfos(),r=[];let c=0,u=0;for(const d of Object.keys(a)){var y;const f=a[d],{type:l,precisionFactor:_,isLayout:p}=s[d],h=p?n.getLayoutProperty(d):n.getPaintProperty(d),T=null==(y=h.interpolator)?void 0:y.getInterpolationRange(e);let E=0;for(const n of f){const{offset:s,bufferElementsToAdd:a}=n;if(a>0){for(let t=0;t<a;t++)r.push(0);c+=u,u=n.bufferElementsToAdd}const y=null!=o?o:h.getValue(T?T[E]:e,t);switch(l){case i.EncodingType.R8_SIGNED:case i.EncodingType.R8_UNSIGNED:r[c]|=this._encodeByte(y*(_||1),8*s);break;case i.EncodingType.R16_SIGNED:case i.EncodingType.R16_UNSIGNED:r[c]|=this._encodeShort(y*(_||1),8*s);break;case i.EncodingType.R8G8_SIGNED:case i.EncodingType.R8G8_UNSIGNED:r[c]|=this._encodeByte(y*(_||1),8*s),r[c]|=this._encodeByte(y*(_||1),8*s+8);break;case i.EncodingType.R16G16_SIGNED:case i.EncodingType.R16G16_UNSIGNED:r[c]|=this._encodeShort(y*(_||1),8*s),r[c]|=this._encodeShort(y*(_||1),8*s+16);break;case i.EncodingType.R8G8B8A8_SIGNED:case i.EncodingType.R8G8B8A8_UNSIGNED:r[c]|=this._encodeByte(y*(_||1),8*s),r[c]|=this._encodeByte(y*(_||1),8*s+8),r[c]|=this._encodeByte(y*(_||1),8*s+16),r[c]|=this._encodeByte(y*(_||1),8*s+24);break;case i.EncodingType.R8G8B8A8_COLOR:r[c]=this._encodeColor(y);break;case i.EncodingType.R16G16B16A16_DASHARRAY:case i.EncodingType.R16G16B16A16_PATTERN:this._encodePattern(c,r,y);break;default:throw new Error("Unsupported encoding type")}E++}}return r},r.getAtributeState=function(t){let e=0;const n=3+2*t;return e|=this._bit(n),e|=this._bit(n+1)<<1,e},r._buildAttributesInfo=function(){const e=[],n={},o={};let a=-1;const r=this.attributesInfo(),c=this.attributes();let u=-1;for(const s of c){u++;const c=this.getAtributeState(u);if(c===i.AttributeStatus.UNIFORM||c===i.AttributeStatus.UNUSED)continue;const y=r[s],d=[];n[s]=d;const f=y.type;for(let n=0;n<c;n++){const{dataType:n,bytesPerElement:i,count:s,normalized:r}=t._encodingInfo[f],c=i*s;let u=o[n],y=0;if(!u||u.count+s>4)a++,u={dataIndex:a,count:0,offset:0},4!==s&&(o[n]=u),e.push({location:-1,name:"a_data_"+a,count:s,type:n,normalized:r}),y=Math.ceil(Math.max(c/4,1));else{const t=e[u.dataIndex];t.count+=s;y=Math.ceil(Math.max(t.count*i/4,1))-Math.ceil(Math.max(u.offset/4,1))}d.push({dataIndex:u.dataIndex,offset:u.offset,bufferElementsToAdd:y}),u.offset+=c,u.count+=s}}for(const t of e)switch(t.type){case s.DataType.BYTE:case s.DataType.UNSIGNED_BYTE:t.count=4;case s.DataType.SHORT:case s.DataType.UNSIGNED_SHORT:t.count+=t.count%2}this._buildVertexBufferLayout(e);let y=0;const d=this._layoutInfo.geometry;for(const t of d)this._locations.set(t.name,y++);const f=this._layoutInfo.opacity;if(f)for(const t of f)this._locations.set(t.name,y++);this._buildShaderInfo(e,n),this._propertyEncodingInfo=n},r._buildVertexBufferLayout=function(t){const e={},n=this.geometryInfo();let o=n[0].stride;if(0===t.length)e.geometry=n;else{const i=[];let s=o;for(const e of t)o+=c(e.type)*e.count;for(const t of n){const e={...t};e.stride=o,i.push(e)}for(const e of t)i.push(new a.VertexElementDescriptor(e.name,e.count,e.type,s,o)),s+=c(e.type)*e.count;e.geometry=i}this.opacityInfo()&&(e.opacity=this.opacityInfo()),this._layoutInfo=e,this._stride=o},r._buildShaderInfo=function(e,o){let s="\n",a="\n";const r=[];for(const t of e)s+=`attribute ${this._getType(t.count)} ${t.name};\n`;const c=this.attributes(),y=this.attributesInfo();let d=-1;for(const f of c){d++;const{name:e,type:c,precisionFactor:l,isLayout:_}=y[f],p=l&&1!==l?" * "+1/l:"",{bytesPerElement:h,count:T}=t._encodingInfo[c],E=t=>`a_data_${t.dataIndex}${u(T,t.offset,h)}`;switch(this.getAtributeState(d)){case i.AttributeStatus.UNIFORM:{const t=this._getType(T),o=`u_${e}`;r.push({name:o,type:t,getValue:(t,e,o,s)=>{const a=_?t.getLayoutValue(f,e):t.getPaintValue(f,e);if(c===i.EncodingType.R16G16B16A16_DASHARRAY){const o=t.getDashKey(a,t.getLayoutValue("line-cap",e)),i=s.getMosaicItemPosition(o,!1);if(n.isNone(i))return null;const{tl:r,br:c}=i;return[r[0],c[1],c[0],r[1]]}if(c===i.EncodingType.R16G16B16A16_PATTERN){const t=s.getMosaicItemPosition(a,-1===f.indexOf("line-"));if(n.isNone(t))return null;const{tl:e,br:o}=t;return[e[0],o[1],o[0],e[1]]}if(c===i.EncodingType.R8G8B8A8_COLOR){const t=a[3];return[t*a[0],t*a[1],t*a[2],t]}return a}}),s+=`uniform ${t} ${o};\n`,a+=`${t} ${e} = ${o};\n`}break;case i.AttributeStatus.DATA_DRIVEN:{const t=E(o[f][0]);a+=`${this._getType(T)} ${e} = ${t}${p};\n`}break;case i.AttributeStatus.INTERPOLATED_DATA_DRIVEN:{const t=`u_t_${e}`;r.push({name:t,type:"float",getValue:(t,e,n,o)=>(_?t.getLayoutProperty(f):t.getPaintProperty(f)).interpolator.interpolationUniformValue(n,e)}),s+=`uniform float ${t};\n`;const n=E(o[f][0]),i=E(o[f][1]);a+=`${this._getType(T)} ${e} = mix(${n}${p}, ${i}${p}, ${t});\n`}}}this._shaderHeader=s,this._shaderMain=a,this._uniforms=r},r._bit=function(t){return(this._key&1<<t)>>t},r._getType=function(t){switch(t){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4"}throw new Error("Invalid count")},r._encodeColor=function(t){const e=255*t[3];return o.i8888to32(t[0]*e,t[1]*e,t[2]*e,e)},r._encodePattern=function(t,e,n){if(!n||!n.rect)return;const o=2,i=n.rect,s=n.width,a=n.height;e[t]=this._encodeShort(i.x+o,0),e[t]|=this._encodeShort(i.y+o+a,16),e[t+1]=this._encodeShort(i.x+o+s,0),e[t+1]|=this._encodeShort(i.y+o,16)},r._encodeByte=function(t,e){return(255&t)<<e},r._encodeShort=function(t,e){return(65535&t)<<e},e._createClass(t,[{key:"key",get:function(){return this._key}},{key:"type",get:function(){return 7&this._key}}]),t}();r._encodingInfo={[i.EncodingType.R8_SIGNED]:{dataType:s.DataType.BYTE,bytesPerElement:1,count:1,normalized:!1},[i.EncodingType.R8_UNSIGNED]:{dataType:s.DataType.UNSIGNED_BYTE,bytesPerElement:1,count:1,normalized:!1},[i.EncodingType.R16_SIGNED]:{dataType:s.DataType.SHORT,bytesPerElement:2,count:1,normalized:!1},[i.EncodingType.R16_UNSIGNED]:{dataType:s.DataType.UNSIGNED_SHORT,bytesPerElement:2,count:1,normalized:!1},[i.EncodingType.R8G8_SIGNED]:{dataType:s.DataType.BYTE,bytesPerElement:1,count:2,normalized:!1},[i.EncodingType.R8G8_UNSIGNED]:{dataType:s.DataType.UNSIGNED_BYTE,bytesPerElement:1,count:2,normalized:!1},[i.EncodingType.R16G16_SIGNED]:{dataType:s.DataType.SHORT,bytesPerElement:2,count:2,normalized:!1},[i.EncodingType.R16G16_UNSIGNED]:{dataType:s.DataType.UNSIGNED_SHORT,bytesPerElement:2,count:2,normalized:!1},[i.EncodingType.R8G8B8A8_SIGNED]:{dataType:s.DataType.BYTE,bytesPerElement:1,count:4,normalized:!1},[i.EncodingType.R8G8B8A8_UNSIGNED]:{dataType:s.DataType.UNSIGNED_BYTE,bytesPerElement:1,count:4,normalized:!1},[i.EncodingType.R8G8B8A8_COLOR]:{dataType:s.DataType.UNSIGNED_BYTE,bytesPerElement:1,count:4,normalized:!0},[i.EncodingType.R16G16B16A16_DASHARRAY]:{dataType:s.DataType.UNSIGNED_SHORT,bytesPerElement:2,count:4,normalized:!1},[i.EncodingType.R16G16B16A16_PATTERN]:{dataType:s.DataType.UNSIGNED_SHORT,bytesPerElement:2,count:4,normalized:!1}};const c=t=>{switch(t){case s.DataType.FLOAT:case s.DataType.INT:case s.DataType.UNSIGNED_INT:return 4;case s.DataType.SHORT:case s.DataType.UNSIGNED_SHORT:return 2;case s.DataType.BYTE:case s.DataType.UNSIGNED_BYTE:return 1}},u=(t,e,n)=>{const o=e/n;if(1===t)switch(o){case 0:return".x";case 1:return".y";case 2:return".z";case 3:return".w"}else if(2===t)switch(o){case 0:return".xy";case 1:return".yz";case 2:return".zw"}else if(3===t)switch(o){case 0:return".xyz";case 1:return".yzw"}return""};t.VTLMaterial=r,Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
