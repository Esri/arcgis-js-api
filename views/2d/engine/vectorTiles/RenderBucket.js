/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/has","../../../../core/maybe","../../../../core/mathUtils","../../../../chunks/builtins","../../../webgl/BufferObject","../../../webgl/VertexArrayObject","../../../webgl/FramebufferObject","../../../webgl/RenderingContext","./decluttering/util"],(function(e,t,r,i,n,s,o,f,a,u,l){"use strict";let c=function(){function e(e){this.layerUIDs=[],this.isDestroyed=!1,this.data=e,this.memoryUsed=e.byteLength;let t=1;const r=new Uint32Array(e);this.layerUIDs=[];const i=r[t++];for(let e=0;e<i;e++)this.layerUIDs[e]=r[t++];this.bufferDataOffset=t}var r=e.prototype;return r.destroy=function(){this.isDestroyed||(this.doDestroy(),this.isDestroyed=!0)},r.prepareForRendering=function(e,t){i.isNone(this.data)||(this.doPrepareForRendering(e,t,this.data,this.bufferDataOffset),this.data=null)},t._createClass(e,[{key:"isPreparedForRendering",get:function(){return i.isNone(this.data)}},{key:"offset",get:function(){return this.bufferDataOffset}}]),e}(),d=function(e){function r(t){var r;(r=e.call(this,t)||this).type=2,r.lineIndexStart=0,r.lineIndexCount=0;let i=r.bufferDataOffset;const n=new Uint32Array(t);return r.lineIndexStart=n[i++],r.lineIndexCount=n[i++],r.isLineDataDriven=!!n[i++],r.bufferDataOffset=i,r}t._inheritsLoose(r,e);var n=r.prototype;return n.hasData=function(){return this.lineIndexCount>0},n.triangleCount=function(){return this.lineIndexCount/3},n.doDestroy=function(){i.isSome(this.lineVertexArrayObject)&&this.lineVertexArrayObject.dispose(),i.isSome(this.lineVertexBuffer)&&this.lineVertexBuffer.dispose(),i.isSome(this.lineIndexBuffer)&&this.lineIndexBuffer.dispose(),this.lineVertexArrayObject=null,this.lineVertexBuffer=null,this.lineIndexBuffer=null,this.memoryUsed=0},n.doPrepareForRendering=function(e,t,i,n){const s=new Uint32Array(i),a=new Int32Array(s.buffer),u=s[n++];this.lineVertexBuffer=o.createVertex(e,35044,new Int32Array(a.buffer,4*n,u)),n+=u;const l=s[n++];this.lineIndexBuffer=o.createIndex(e,35044,new Uint32Array(s.buffer,4*n,l)),n+=l,this.lineVertexArrayObject=new f(e,t.getProgramAttributes(3),this.isLineDataDriven?r.lineVertexAttributesDD:r.lineVertexAttributes,{geometry:this.lineVertexBuffer},this.lineIndexBuffer)},r}(c);d.lineVertexAttributes={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:12,normalized:!1,divisor:0},{name:"a_offsetAndNormal",count:4,type:5120,offset:4,stride:12,normalized:!1,divisor:0},{name:"a_accumulatedDistance",count:2,type:5123,offset:8,stride:12,normalized:!1,divisor:0}]},d.lineVertexAttributesDD={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:20,normalized:!1,divisor:0},{name:"a_offsetAndNormal",count:4,type:5120,offset:4,stride:20,normalized:!1,divisor:0},{name:"a_accumulatedDistance",count:2,type:5122,offset:8,stride:20,normalized:!1,divisor:0},{name:"a_color",count:4,type:5121,offset:12,stride:20,normalized:!0,divisor:0},{name:"a_width",count:1,type:5126,offset:16,stride:20,normalized:!1,divisor:0}]};let x=function(e){function r(t){var r;(r=e.call(this,t)||this).type=1,r.fillIndexStart=0,r.fillIndexCount=0,r.outlineIndexStart=0,r.outlineIndexCount=0;let i=r.bufferDataOffset;const n=new Uint32Array(t);return r.fillIndexStart=n[i++],r.fillIndexCount=n[i++],r.outlineIndexStart=n[i++],r.outlineIndexCount=n[i++],r.isFillDataDriven=!!n[i++],r.isOutlineDataDriven=!!n[i++],r.bufferDataOffset=i,r}t._inheritsLoose(r,e);var n=r.prototype;return n.hasData=function(){return this.fillIndexCount>0||this.outlineIndexCount>0},n.triangleCount=function(){return(this.fillIndexCount+this.outlineIndexCount)/3},n.doDestroy=function(){i.isSome(this.fillVertexArrayObject)&&this.fillVertexArrayObject.dispose(),i.isSome(this.fillVertexBuffer)&&this.fillVertexBuffer.dispose(),i.isSome(this.fillIndexBuffer)&&this.fillIndexBuffer.dispose(),this.fillVertexArrayObject=null,this.fillVertexBuffer=null,this.fillIndexBuffer=null,i.isSome(this.outlineVertexArrayObject)&&this.outlineVertexArrayObject.dispose(),i.isSome(this.outlineVertexBuffer)&&this.outlineVertexBuffer.dispose(),i.isSome(this.outlineIndexBuffer)&&this.outlineIndexBuffer.dispose(),this.outlineVertexArrayObject=null,this.outlineVertexBuffer=null,this.outlineIndexBuffer=null,this.memoryUsed=0},n.doPrepareForRendering=function(e,t,i,n){const s=new Uint32Array(i),a=new Int32Array(s.buffer),u=s[n++];this.fillVertexBuffer=o.createVertex(e,35044,new Int32Array(a.buffer,4*n,u)),n+=u;const l=s[n++];this.fillIndexBuffer=o.createIndex(e,35044,new Uint32Array(s.buffer,4*n,l)),n+=l;const c=s[n++];this.outlineVertexBuffer=o.createVertex(e,35044,new Int32Array(a.buffer,4*n,c)),n+=c;const d=s[n++];this.outlineIndexBuffer=o.createIndex(e,35044,new Uint32Array(s.buffer,4*n,d)),n+=d,this.fillVertexArrayObject=new f(e,t.getProgramAttributes(1),this.isFillDataDriven?r.fillVertexAttributesDD:r.fillVertexAttributes,{geometry:this.fillVertexBuffer},this.fillIndexBuffer),this.outlineVertexArrayObject=new f(e,t.getProgramAttributes(2),this.isOutlineDataDriven?r.outlineVertexAttributesDD:r.outlineVertexAttributes,{geometry:this.outlineVertexBuffer},this.outlineIndexBuffer)},r}(c);x.fillVertexAttributes={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:4,normalized:!1,divisor:0}]},x.fillVertexAttributesDD={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:8,normalized:!1,divisor:0},{name:"a_color",count:4,type:5121,offset:4,stride:8,normalized:!0,divisor:0}]},x.outlineVertexAttributes={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:8,normalized:!1,divisor:0},{name:"a_offset",count:2,type:5120,offset:4,stride:8,normalized:!1,divisor:0},{name:"a_xnormal",count:2,type:5120,offset:6,stride:8,normalized:!1,divisor:0}]},x.outlineVertexAttributesDD={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:12,normalized:!1,divisor:0},{name:"a_offset",count:2,type:5120,offset:4,stride:12,normalized:!1,divisor:0},{name:"a_xnormal",count:2,type:5120,offset:6,stride:12,normalized:!1,divisor:0},{name:"a_color",count:4,type:5121,offset:8,stride:12,normalized:!0,divisor:0}]};let h=function(e){function r(t,r){var i;(i=e.call(this,t)||this).type=3,i.iconPerPageElementsMap=new Map,i.glyphPerPageElementsMap=new Map,i.symbolInstances=[],i.isIconSDF=!1,i.opacityChanged=!1,i.lastOpacityUpdate=0,i.symbols=[];let n=i.bufferDataOffset;const s=new Uint32Array(t),o=new Int32Array(t),f=new Float32Array(t);i.isIconSDF=!!s[n++],i.isIconDataDriven=!!s[n++],i.isTextDataDriven=!!s[n++];const a=s[n++];for(let e=0;e<a;e++){const e=s[n++],t=s[n++],r=s[n++];i.iconPerPageElementsMap.set(e,[t,r])}const u=s[n++];for(let e=0;e<u;e++){const e=s[n++],t=s[n++],r=s[n++];i.glyphPerPageElementsMap.set(e,[t,r])}const c=s[n++],d=s[n++];return i.iconOpacity=new Int32Array(c),i.textOpacity=new Int32Array(d),n=l.deserializeSymbols(s,o,f,n,i.symbols,r),i.bufferDataOffset=n,i}t._inheritsLoose(r,e);var n=r.prototype;return n.hasData=function(){return this.iconPerPageElementsMap.size>0||this.glyphPerPageElementsMap.size>0},n.triangleCount=function(){let e=0;return this.iconPerPageElementsMap.forEach((t=>{e+=t[1]})),this.glyphPerPageElementsMap.forEach((t=>{e+=t[1]})),e/3},n.doDestroy=function(){i.isSome(this.iconVertexArrayObject)&&this.iconVertexArrayObject.dispose(),i.isSome(this.iconVertexBuffer)&&this.iconVertexBuffer.dispose(),i.isSome(this.iconOpacityBuffer)&&this.iconOpacityBuffer.dispose(),i.isSome(this.iconIndexBuffer)&&this.iconIndexBuffer.dispose(),this.iconVertexArrayObject=null,this.iconVertexBuffer=null,this.iconOpacityBuffer=null,this.iconIndexBuffer=null,i.isSome(this.textVertexArrayObject)&&this.textVertexArrayObject.dispose(),i.isSome(this.textVertexBuffer)&&this.textVertexBuffer.dispose(),i.isSome(this.textOpacityBuffer)&&this.textOpacityBuffer.dispose(),i.isSome(this.textIndexBuffer)&&this.textIndexBuffer.dispose(),this.textVertexArrayObject=null,this.textVertexBuffer=null,this.textOpacityBuffer=null,this.textIndexBuffer=null,this.memoryUsed=0},n.updateOpacityInfo=function(){if(!this.opacityChanged)return;this.opacityChanged=!1;const e=i.unwrap(this.iconOpacity),t=i.unwrap(this.iconOpacityBuffer);e.length>0&&e.byteLength===t.size&&t.setSubData(e);const r=i.unwrap(this.textOpacity),n=i.unwrap(this.textOpacityBuffer);r.length>0&&r.byteLength===n.size&&n.setSubData(r)},n.doPrepareForRendering=function(e,t,n,s){const a=new Uint32Array(n),u=new Int32Array(a.buffer),l=a[s++];this.iconVertexBuffer=o.createVertex(e,35044,new Int32Array(u.buffer,4*s,l)),s+=l;const c=a[s++];this.iconIndexBuffer=o.createIndex(e,35044,new Uint32Array(a.buffer,4*s,c)),s+=c;const d=a[s++];this.textVertexBuffer=o.createVertex(e,35044,new Int32Array(u.buffer,4*s,d)),s+=d;const x=a[s++];this.textIndexBuffer=o.createIndex(e,35044,new Uint32Array(a.buffer,4*s,x)),s+=x,this.iconOpacityBuffer=o.createVertex(e,35044,i.unwrap(this.iconOpacity).buffer),this.textOpacityBuffer=o.createVertex(e,35044,i.unwrap(this.textOpacity).buffer),this.iconVertexArrayObject=new f(e,t.getProgramAttributes(4),this.isIconDataDriven?r.vertexAttributesDD:r.vertexAttributes,{geometry:this.iconVertexBuffer,opacity:this.iconOpacityBuffer},this.iconIndexBuffer),this.textVertexArrayObject=new f(e,t.getProgramAttributes(6),this.isTextDataDriven?r.vertexAttributesDD:r.vertexAttributes,{geometry:this.textVertexBuffer,opacity:this.textOpacityBuffer},this.textIndexBuffer)},r}(c);h.vertexAttributes={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:16,normalized:!1,divisor:0},{name:"a_vertexOffset",count:2,type:5122,offset:4,stride:16,normalized:!1,divisor:0},{name:"a_texAngleRange",count:4,type:5121,offset:8,stride:16,normalized:!1,divisor:0},{name:"a_levelInfo",count:4,type:5121,offset:12,stride:16,normalized:!1,divisor:0}],opacity:[{name:"a_opacityInfo",count:1,type:5121,offset:0,stride:1,normalized:!1,divisor:0}]},h.vertexAttributesDD={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:24,normalized:!1,divisor:0},{name:"a_vertexOffset",count:2,type:5122,offset:4,stride:24,normalized:!1,divisor:0},{name:"a_texAngleRange",count:4,type:5121,offset:8,stride:24,normalized:!1,divisor:0},{name:"a_levelInfo",count:4,type:5121,offset:12,stride:24,normalized:!1,divisor:0},{name:"a_color",count:4,type:5121,offset:16,stride:24,normalized:!0,divisor:0},{name:"a_size",count:1,type:5126,offset:20,stride:24,normalized:!1,divisor:0}],opacity:[{name:"a_opacityInfo",count:1,type:5121,offset:0,stride:1,normalized:!1,divisor:0}]};let y=function(e){function r(t){var r;(r=e.call(this,t)||this).type=4,r.circleIndexStart=0,r.circleIndexCount=0;let i=r.bufferDataOffset;const n=new Uint32Array(t);return r.circleIndexStart=n[i++],r.circleIndexCount=n[i++],r.bufferDataOffset=i,r}t._inheritsLoose(r,e);var n=r.prototype;return n.hasData=function(){return this.circleIndexCount>0},n.triangleCount=function(){return this.circleIndexCount/3},n.doDestroy=function(){i.isSome(this.circleVertexArrayObject)&&this.circleVertexArrayObject.dispose(),i.isSome(this.circleVertexBuffer)&&this.circleVertexBuffer.dispose(),i.isSome(this.circleIndexBuffer)&&this.circleIndexBuffer.dispose(),this.circleVertexArrayObject=null,this.circleVertexBuffer=null,this.circleIndexBuffer=null,this.memoryUsed=0},n.doPrepareForRendering=function(e,t,i,n){const s=new Uint32Array(i),a=new Int32Array(s.buffer),u=s[n++];this.circleVertexBuffer=o.createVertex(e,35044,new Int32Array(a.buffer,4*n,u)),n+=u;const l=s[n++];this.circleIndexBuffer=o.createIndex(e,35044,new Uint32Array(s.buffer,4*n,l)),n+=l,this.circleVertexArrayObject=new f(e,t.getProgramAttributes(5),r.circleVertexAttributes,{geometry:this.circleVertexBuffer},this.circleIndexBuffer)},r}(c);y.circleVertexAttributes={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:16,normalized:!1,divisor:0},{name:"a_color",count:4,type:5121,offset:4,stride:16,normalized:!0,divisor:0},{name:"a_stroke_color",count:4,type:5121,offset:8,stride:16,normalized:!0,divisor:0},{name:"a_data",count:4,type:5121,offset:12,stride:16,normalized:!1,divisor:0}]},e.CircleRenderBucket=y,e.FillRenderBucket=x,e.LineRenderBucket=d,e.RenderBucketBase=c,e.SymbolRenderBucket=h,Object.defineProperty(e,"__esModule",{value:!0})}));
