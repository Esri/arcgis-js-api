/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/has","../../../../core/maybe","../../../../core/mathUtils","../../../../chunks/builtins","../../../webgl/BufferObject","../../../webgl/VertexArrayObject","../../../webgl/FramebufferObject","./decluttering/util"],(function(e,t,r,i,n,s,f,o,u,a){"use strict";let c=function(){function e(e,t){this.layerUIDs=[],this.isDestroyed=!1,this.data=e,this.memoryUsed=e.byteLength;let r=1;const i=new Uint32Array(e);this.layerUIDs=[];const n=i[r++];for(let s=0;s<n;s++)this.layerUIDs[s]=i[r++];this.bufferDataOffset=r,t&&(this.layer=t.getStyleLayerByUID(this.layerUIDs[0]))}var r=e.prototype;return r.destroy=function(){this.isDestroyed||(this.doDestroy(),this.isDestroyed=!0)},r.prepareForRendering=function(e){i.isNone(this.data)||(this.doPrepareForRendering(e,this.data,this.bufferDataOffset),this.data=null)},t._createClass(e,[{key:"isPreparedForRendering",get:function(){return i.isNone(this.data)}},{key:"offset",get:function(){return this.bufferDataOffset}}]),e}(),l=function(e){function r(t,r){var i;(i=e.call(this,t,r)||this).type=2,i.lineIndexStart=0,i.lineIndexCount=0;const n=new Uint32Array(t);let s=i.bufferDataOffset;return i.lineIndexStart=n[s++],i.lineIndexCount=n[s++],i.bufferDataOffset=s,i}t._inheritsLoose(r,e);var n=r.prototype;return n.hasData=function(){return this.lineIndexCount>0},n.triangleCount=function(){return this.lineIndexCount/3},n.doDestroy=function(){i.isSome(this.lineVertexArrayObject)&&this.lineVertexArrayObject.dispose(),i.isSome(this.lineVertexBuffer)&&this.lineVertexBuffer.dispose(),i.isSome(this.lineIndexBuffer)&&this.lineIndexBuffer.dispose(),this.lineVertexArrayObject=null,this.lineVertexBuffer=null,this.lineIndexBuffer=null,this.memoryUsed=0},n.doPrepareForRendering=function(e,t,r){const i=new Uint32Array(t),n=new Int32Array(i.buffer),s=i[r++];this.lineVertexBuffer=f.createVertex(e,35044,new Int32Array(n.buffer,4*r,s)),r+=s;const u=i[r++];this.lineIndexBuffer=f.createIndex(e,35044,new Uint32Array(i.buffer,4*r,u)),r+=u;const a=this.layer.lineMaterial;this.lineVertexArrayObject=new o(e,a.getAttributeLocations(),a.getLayoutInfo(),{geometry:this.lineVertexBuffer},this.lineIndexBuffer)},r}(c),h=function(e){function r(t,r){var i;(i=e.call(this,t,r)||this).type=1,i.fillIndexStart=0,i.fillIndexCount=0,i.outlineIndexStart=0,i.outlineIndexCount=0;const n=new Uint32Array(t);let s=i.bufferDataOffset;return i.fillIndexStart=n[s++],i.fillIndexCount=n[s++],i.outlineIndexStart=n[s++],i.outlineIndexCount=n[s++],i.bufferDataOffset=s,i}t._inheritsLoose(r,e);var n=r.prototype;return n.hasData=function(){return this.fillIndexCount>0||this.outlineIndexCount>0},n.triangleCount=function(){return(this.fillIndexCount+this.outlineIndexCount)/3},n.doDestroy=function(){i.isSome(this.fillVertexArrayObject)&&this.fillVertexArrayObject.dispose(),i.isSome(this.fillVertexBuffer)&&this.fillVertexBuffer.dispose(),i.isSome(this.fillIndexBuffer)&&this.fillIndexBuffer.dispose(),this.fillVertexArrayObject=null,this.fillVertexBuffer=null,this.fillIndexBuffer=null,i.isSome(this.outlineVertexArrayObject)&&this.outlineVertexArrayObject.dispose(),i.isSome(this.outlineVertexBuffer)&&this.outlineVertexBuffer.dispose(),i.isSome(this.outlineIndexBuffer)&&this.outlineIndexBuffer.dispose(),this.outlineVertexArrayObject=null,this.outlineVertexBuffer=null,this.outlineIndexBuffer=null,this.memoryUsed=0},n.doPrepareForRendering=function(e,t,r){const i=new Uint32Array(t),n=new Int32Array(i.buffer),s=i[r++];this.fillVertexBuffer=f.createVertex(e,35044,new Int32Array(n.buffer,4*r,s)),r+=s;const u=i[r++];this.fillIndexBuffer=f.createIndex(e,35044,new Uint32Array(i.buffer,4*r,u)),r+=u;const a=i[r++];this.outlineVertexBuffer=f.createVertex(e,35044,new Int32Array(n.buffer,4*r,a)),r+=a;const c=i[r++];this.outlineIndexBuffer=f.createIndex(e,35044,new Uint32Array(i.buffer,4*r,c)),r+=c;const l=this.layer,h=l.fillMaterial,x=l.outlineMaterial;this.fillVertexArrayObject=new o(e,h.getAttributeLocations(),h.getLayoutInfo(),{geometry:this.fillVertexBuffer},this.fillIndexBuffer),this.outlineVertexArrayObject=new o(e,x.getAttributeLocations(),x.getLayoutInfo(),{geometry:this.outlineVertexBuffer},this.outlineIndexBuffer)},r}(c),x=function(e){function r(t,r,i){var n;(n=e.call(this,t,r)||this).type=3,n.iconPerPageElementsMap=new Map,n.glyphPerPageElementsMap=new Map,n.symbolInstances=[],n.isIconSDF=!1,n.opacityChanged=!1,n.lastOpacityUpdate=0,n.symbols=[];const s=new Uint32Array(t),f=new Int32Array(t),o=new Float32Array(t);let u=n.bufferDataOffset;n.isIconSDF=!!s[u++];const c=s[u++];for(let e=0;e<c;e++){const e=s[u++],t=s[u++],r=s[u++];n.iconPerPageElementsMap.set(e,[t,r])}const l=s[u++];for(let e=0;e<l;e++){const e=s[u++],t=s[u++],r=s[u++];n.glyphPerPageElementsMap.set(e,[t,r])}const h=s[u++],x=s[u++];return n.iconOpacity=new Int32Array(h),n.textOpacity=new Int32Array(x),u=a.deserializeSymbols(s,f,o,u,n.symbols,i),n.bufferDataOffset=u,n}t._inheritsLoose(r,e);var n=r.prototype;return n.hasData=function(){return this.iconPerPageElementsMap.size>0||this.glyphPerPageElementsMap.size>0},n.triangleCount=function(){let e=0;for(const[t,r]of this.iconPerPageElementsMap)e+=r[1];for(const[t,r]of this.glyphPerPageElementsMap)e+=r[1];return e/3},n.doDestroy=function(){i.isSome(this.iconVertexArrayObject)&&this.iconVertexArrayObject.dispose(),i.isSome(this.iconVertexBuffer)&&this.iconVertexBuffer.dispose(),i.isSome(this.iconOpacityBuffer)&&this.iconOpacityBuffer.dispose(),i.isSome(this.iconIndexBuffer)&&this.iconIndexBuffer.dispose(),this.iconVertexArrayObject=null,this.iconVertexBuffer=null,this.iconOpacityBuffer=null,this.iconIndexBuffer=null,i.isSome(this.textVertexArrayObject)&&this.textVertexArrayObject.dispose(),i.isSome(this.textVertexBuffer)&&this.textVertexBuffer.dispose(),i.isSome(this.textOpacityBuffer)&&this.textOpacityBuffer.dispose(),i.isSome(this.textIndexBuffer)&&this.textIndexBuffer.dispose(),this.textVertexArrayObject=null,this.textVertexBuffer=null,this.textOpacityBuffer=null,this.textIndexBuffer=null,this.memoryUsed=0},n.updateOpacityInfo=function(){if(!this.opacityChanged)return;this.opacityChanged=!1;const e=i.unwrap(this.iconOpacity),t=i.unwrap(this.iconOpacityBuffer);e.length>0&&e.byteLength===t.size&&t.setSubData(e);const r=i.unwrap(this.textOpacity),n=i.unwrap(this.textOpacityBuffer);r.length>0&&r.byteLength===n.size&&n.setSubData(r)},n.doPrepareForRendering=function(e,t,r){const n=new Uint32Array(t),s=new Int32Array(n.buffer),u=n[r++];this.iconVertexBuffer=f.createVertex(e,35044,new Int32Array(s.buffer,4*r,u)),r+=u;const a=n[r++];this.iconIndexBuffer=f.createIndex(e,35044,new Uint32Array(n.buffer,4*r,a)),r+=a;const c=n[r++];this.textVertexBuffer=f.createVertex(e,35044,new Int32Array(s.buffer,4*r,c)),r+=c;const l=n[r++];this.textIndexBuffer=f.createIndex(e,35044,new Uint32Array(n.buffer,4*r,l)),r+=l,this.iconOpacityBuffer=f.createVertex(e,35044,i.unwrap(this.iconOpacity).buffer),this.textOpacityBuffer=f.createVertex(e,35044,i.unwrap(this.textOpacity).buffer);const h=this.layer,x=h.iconMaterial,y=h.textMaterial;this.iconVertexArrayObject=new o(e,x.getAttributeLocations(),x.getLayoutInfo(),{geometry:this.iconVertexBuffer,opacity:this.iconOpacityBuffer},this.iconIndexBuffer),this.textVertexArrayObject=new o(e,y.getAttributeLocations(),y.getLayoutInfo(),{geometry:this.textVertexBuffer,opacity:this.textOpacityBuffer},this.textIndexBuffer)},r}(c),y=function(e){function r(t,r){var i;(i=e.call(this,t,r)||this).type=4,i.circleIndexStart=0,i.circleIndexCount=0;const n=new Uint32Array(t);let s=i.bufferDataOffset;return i.circleIndexStart=n[s++],i.circleIndexCount=n[s++],i.bufferDataOffset=s,i}t._inheritsLoose(r,e);var n=r.prototype;return n.hasData=function(){return this.circleIndexCount>0},n.triangleCount=function(){return this.circleIndexCount/3},n.doDestroy=function(){i.isSome(this.circleVertexArrayObject)&&this.circleVertexArrayObject.dispose(),i.isSome(this.circleVertexBuffer)&&this.circleVertexBuffer.dispose(),i.isSome(this.circleIndexBuffer)&&this.circleIndexBuffer.dispose(),this.circleVertexArrayObject=null,this.circleVertexBuffer=null,this.circleIndexBuffer=null,this.memoryUsed=0},n.doPrepareForRendering=function(e,t,r){const i=new Uint32Array(t),n=new Int32Array(i.buffer),s=i[r++];this.circleVertexBuffer=f.createVertex(e,35044,new Int32Array(n.buffer,4*r,s)),r+=s;const u=i[r++];this.circleIndexBuffer=f.createIndex(e,35044,new Uint32Array(i.buffer,4*r,u)),r+=u;const a=this.layer.circleMaterial;this.circleVertexArrayObject=new o(e,a.getAttributeLocations(),a.getLayoutInfo(),{geometry:this.circleVertexBuffer},this.circleIndexBuffer)},r}(c);e.CircleRenderBucket=y,e.FillRenderBucket=h,e.LineRenderBucket=l,e.RenderBucketBase=c,e.SymbolRenderBucket=x,Object.defineProperty(e,"__esModule",{value:!0})}));
