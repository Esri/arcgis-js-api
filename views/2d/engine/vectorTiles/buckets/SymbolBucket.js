/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/BidiEngine","../../../../../core/maybe","../../../../../core/string","../../../../../geometry/support/TileClipper","../enums","../GeometryUtils","../Placement","../TextShaping","./BaseBucket","../style/StyleDefinition","../style/StyleLayer"],(function(e,t,n,i,o,s,a,r,l,h,c,x){"use strict";const y=10;function g(e,t){return e.iconMosaicItem&&t.iconMosaicItem?e.iconMosaicItem.page===t.iconMosaicItem.page?0:e.iconMosaicItem.page-t.iconMosaicItem.page:e.iconMosaicItem&&!t.iconMosaicItem?1:!e.iconMosaicItem&&t.iconMosaicItem?-1:0}let f=function(t){function h(e,n,i,o,a,r,l,h){var c;return(c=t.call(this,e,n,h.getSpriteItems())||this).type=s.BucketType.SYMBOL,c._markerMap=new Map,c._glyphMap=new Map,c._glyphBufferDataStorage=new Map,c._isIconSDF=!1,c._iconVertexBuffer=i,c._iconIndexBuffer=o,c._textVertexBuffer=a,c._textIndexBuffer=r,c._placementEngine=l,c._workerTileHandler=h,c}e._inheritsLoose(h,t);var f=h.prototype;return f.getResources=function(e,t,n){const o=this.layer,s=this.zoom;e&&e.setExtent(this.layerExtent);const a=o.getLayoutProperty("icon-image"),r=o.getLayoutProperty("text-field");let l=o.getLayoutProperty("text-transform"),x=o.getLayoutProperty("text-font");const y=[];let g,f,d,u;a&&!a.isDataDriven&&(g=a.getValue(s)),r&&!r.isDataDriven&&(f=r.getValue(s)),l&&l.isDataDriven||(d=o.getLayoutValue("text-transform",s),l=null),x&&x.isDataDriven||(u=o.getLayoutValue("text-font",s),x=null);for(const m of this._features){const p=m.getGeometry(e);if(!p||0===p.length)continue;let _,P;a&&(_=a.isDataDriven?a.getValue(s,m):this._replaceKeys(g,m.values),_&&t(_));let I=!1;if(r&&(P=r.isDataDriven?r.getValue(s,m):this._replaceKeys(f,m.values),P)){switch(P=P.replace(/\\n/g,"\n"),l&&(d=l.getValue(s,m)),d){case c.TextTransform.LOWERCASE:P=P.toLowerCase();break;case c.TextTransform.UPPERCASE:P=P.toUpperCase()}if(h._bidiEngine.hasBidiChar(P)){let e;e="rtl"===h._bidiEngine.checkContextual(P)?"IDNNN":"ICNNN",P=h._bidiEngine.bidiTransform(P,e,"VLYSN"),I=!0}const e=P.length;if(e>0){x&&(u=x.getValue(s,m));for(const t of u){let i=n[t];i||(i=n[t]=new Set);for(let t=0;t<e;t++){const e=P.charCodeAt(t);i.add(e)}}}}if(!_&&!P)continue;const b=o.getLayoutValue("symbol-sort-key",s,m),A={feature:m,sprite:_,label:P,rtl:I,geometry:p,hash:(P?i.numericHash(P):0)^(_?i.numericHash(_):0),priority:b,textFont:u};y.push(A)}this._symbolFeatures=y},f.processFeatures=function(e){e&&e.setExtent(this.layerExtent);const t=this.layer,i=this.zoom,s=t.getLayoutValue("symbol-placement",i),y=s!==c.SymbolPlacement.POINT,f=t.getLayoutValue("symbol-spacing",i)*r.TILE_PIXEL_RATIO,d=t.getLayoutProperty("icon-image"),u=t.getLayoutProperty("text-field"),m=d?new x.IconLayout(t,i,y):null,p=u?new x.TextLayout(t,i,y):null,_=this._workerTileHandler;let P;d&&(P=_.getSpriteItems()),this._iconIndexStart=3*this._iconIndexBuffer.index,this._textIndexStart=3*this._textIndexBuffer.index,this._iconIndexCount=0,this._textIndexCount=0,this._markerMap.clear(),this._glyphMap.clear();const I=[];let b=1;p&&p.size&&(b=p.size/l.SDF_GLYPH_SIZE);const A=p?p.maxAngle*a.C_DEG_TO_RAD:0,M=p?p.size*r.TILE_PIXEL_RATIO:0;for(const a of this._symbolFeatures){let e;m&&P&&a.sprite&&(e=P[a.sprite],e&&e.sdf&&(this._isIconSDF=!0));let t;!!e&&m.update(i,a.feature);let x=0;const g=a.label;if(g){n.assertIsSome(p),p.update(i,a.feature);const e=y&&p.rotationAlignment===c.RotationAlignment.MAP?p.keepUpright:p.writingMode&&p.writingMode.includes(c.TextWritingMode.VERTICAL);let o=.5;switch(p.anchor){case c.SymbolAnchor.TOP_LEFT:case c.SymbolAnchor.LEFT:case c.SymbolAnchor.BOTTOM_LEFT:o=0;break;case c.SymbolAnchor.TOP_RIGHT:case c.SymbolAnchor.RIGHT:case c.SymbolAnchor.BOTTOM_RIGHT:o=1}let s=.5;switch(p.anchor){case c.SymbolAnchor.TOP_LEFT:case c.SymbolAnchor.TOP:case c.SymbolAnchor.TOP_RIGHT:s=0;break;case c.SymbolAnchor.BOTTOM_LEFT:case c.SymbolAnchor.BOTTOM:case c.SymbolAnchor.BOTTOM_RIGHT:s=1}let h=.5;switch(p.justify){case c.TextJustification.AUTO:h=o;break;case c.TextJustification.LEFT:h=0;break;case c.TextJustification.RIGHT:h=1}const f=p.letterSpacing*l.SDF_GLYPH_SIZE,d=y?0:p.maxWidth*l.SDF_GLYPH_SIZE,u=p.lineHeight*l.SDF_GLYPH_SIZE,m=a.textFont.map((e=>_.getGlyphItems(e)));if(t=new l.TextShaping(m,d,u,f,o,s,h).getShaping(g,a.rtl,e),t&&t.length>0){let e=1e30,n=-1e30;for(const i of t)e=Math.min(e,i.x),n=Math.max(n,i.x);x=(n-e+2*l.SDF_GLYPH_SIZE)*b*r.TILE_PIXEL_RATIO}}for(let n of a.geometry){const i=[];if(s===c.SymbolPlacement.LINE){if(t?.length&&p?.size){const e=p.size*r.TILE_PIXEL_RATIO*(2+Math.min(2,4*Math.abs(p.offset[1])));n=h._smoothVertices(n,e)}h._pushAnchors(i,n,f,x)}else s===c.SymbolPlacement.LINE_CENTER?h._pushCenterAnchor(i,n):a.feature.type===o.GeometryType.Polygon?h._pushCentroid(i,n):i.push(new r.Anchor(n[0].x,n[0].y));for(const o of i){if(o.x<0||o.x>r.TILE_COORD_SIZE||o.y<0||o.y>r.TILE_COORD_SIZE)continue;if(y&&x>0&&p?.rotationAlignment===c.RotationAlignment.MAP&&!h._honorsTextMaxAngle(n,o,x,A,M))continue;const i={shaping:t,line:n,iconMosaicItem:e,anchor:o,symbolFeature:a,textColliders:[],iconColliders:[],textVertexRanges:[],iconVertexRanges:[]};I.push(i),this._processFeature(i,m,p)}}}I.sort(g),this._addPlacedGlyphs(),this._symbolInstances=I},f.serialize=function(){let e=11;e+=this.layerUIDs.length,e+=3*this.markerPageMap.size,e+=3*this.glyphsPageMap.size,e+=h._symbolsSerializationLength(this._symbolInstances),e+=this._iconVertexBuffer.array.length,e+=this._iconIndexBuffer.array.length,e+=this._textVertexBuffer.array.length,e+=this._textIndexBuffer.array.length;const t=new Uint32Array(e),n=new Int32Array(t.buffer),i=new Float32Array(t.buffer);let o=0;t[o++]=this.type,t[o++]=this.layerUIDs.length;for(let s=0;s<this.layerUIDs.length;s++)t[o++]=this.layerUIDs[s];t[o++]=this._isIconSDF?1:0,t[o++]=this.markerPageMap.size;for(const[s,[a,r]]of this.markerPageMap)t[o++]=s,t[o++]=a,t[o++]=r;t[o++]=this.glyphsPageMap.size;for(const[s,[a,r]]of this.glyphsPageMap)t[o++]=s,t[o++]=a,t[o++]=r;t[o++]=this._iconVertexBuffer.index/4,t[o++]=this._textVertexBuffer.index/4,o=h.serializeSymbols(t,n,i,o,this._symbolInstances),t[o++]=this._iconVertexBuffer.array.length;for(let s=0;s<this._iconVertexBuffer.array.length;s++)n[o++]=this._iconVertexBuffer.array[s];t[o++]=this._iconIndexBuffer.array.length;for(let s=0;s<this._iconIndexBuffer.array.length;s++)t[o++]=this._iconIndexBuffer.array[s];t[o++]=this._textVertexBuffer.array.length;for(let s=0;s<this._textVertexBuffer.array.length;s++)n[o++]=this._textVertexBuffer.array[s];t[o++]=this._textIndexBuffer.array.length;for(let s=0;s<this._textIndexBuffer.array.length;s++)t[o++]=this._textIndexBuffer.array[s];return t.buffer},h._symbolsSerializationLength=function(e){let t=0;t+=1;for(const n of e||[]){t+=4,t+=1;for(const e of n.textColliders)t+=y;for(const e of n.iconColliders)t+=y;t+=1,t+=2*n.textVertexRanges.length,t+=1,t+=2*n.iconVertexRanges.length}return t},h.serializeSymbols=function(e,t,n,i,o){o=o||[],t[i++]=o.length;for(const s of o){t[i++]=s.anchor.x,t[i++]=s.anchor.y,t[i++]=s.symbolFeature.hash,t[i++]=s.symbolFeature.priority,t[i++]=s.textColliders.length+s.iconColliders.length;for(const e of s.textColliders)t[i++]=e.xTile,t[i++]=e.yTile,t[i++]=e.dxPixels,t[i++]=e.dyPixels,t[i++]=e.hard?1:0,t[i++]=e.partIndex,n[i++]=e.minLod,n[i++]=e.maxLod,t[i++]=e.width,t[i++]=e.height;for(const e of s.iconColliders)t[i++]=e.xTile,t[i++]=e.yTile,t[i++]=e.dxPixels,t[i++]=e.dyPixels,t[i++]=e.hard?1:0,t[i++]=e.partIndex,n[i++]=e.minLod,n[i++]=e.maxLod,t[i++]=e.width,t[i++]=e.height;t[i++]=s.textVertexRanges.length;for(const[e,n]of s.textVertexRanges)t[i++]=e,t[i++]=n;t[i++]=s.iconVertexRanges.length;for(const[e,n]of s.iconVertexRanges)t[i++]=e,t[i++]=n}return i},f._replaceKeys=function(e,t){return e.replace(/{([^{}]+)}/g,((e,n)=>n in t?t[n]:""))},f._processFeature=function(e,t,n){const{line:i,iconMosaicItem:o,shaping:s,anchor:r}=e,l=this.zoom,h=this.layer,x=!!o;let y=!0;x&&(y=t?.optional||!o);const g=s&&s.length>0,f=!g||n?.optional;let d,u;if(x&&(d=this._placementEngine.getIconPlacement(r,o,t)),(d||y)&&(g&&(u=this._placementEngine.getTextPlacement(r,s,i,n)),u||f)){if(d&&u||(f||y?f||u?y||d||(u=null):d=null:(d=null,u=null)),u){const t=h.hasDataDrivenText?h.textMaterial.encodeAttributes(e.symbolFeature.feature,l,h):null;if(this._storePlacedGlyphs(e,u.shapes,l,n.rotationAlignment,t),u.textColliders){e.textColliders=u.textColliders;for(const e of u.textColliders){e.minLod=Math.max(l+a.log2(e.minLod),0),e.maxLod=Math.min(l+a.log2(e.maxLod),25);const t=e.angle;if(t){const n=Math.cos(t),i=Math.sin(t),o=e.dxPixels*n-e.dyPixels*i,s=e.dxPixels*i+e.dyPixels*n,a=(e.dxPixels+e.width)*n-e.dyPixels*i,r=(e.dxPixels+e.width)*i+e.dyPixels*n,l=e.dxPixels*n-(e.dyPixels+e.height)*i,h=e.dxPixels*i+(e.dyPixels+e.height)*n,c=(e.dxPixels+e.width)*n-(e.dyPixels+e.height)*i,x=(e.dxPixels+e.width)*i+(e.dyPixels+e.height)*n,y=Math.min(o,a,l,c),g=Math.max(o,a,l,c),f=Math.min(s,r,h,x),d=Math.max(s,r,h,x);e.dxPixels=y,e.dyPixels=f,e.width=g-y,e.height=d-f}}}}if(d){const n=h.hasDataDrivenIcon?h.iconMaterial.encodeAttributes(e.symbolFeature.feature,l,h):null;if(this._addPlacedIcons(e,d.shapes,l,o.page,t.rotationAlignment===c.RotationAlignment.VIEWPORT,n),d.iconColliders){e.iconColliders=d.iconColliders;for(const e of d.iconColliders){e.minLod=Math.max(l+a.log2(e.minLod),0),e.maxLod=Math.min(l+a.log2(e.maxLod),25);const t=e.angle;if(t){const n=Math.cos(t),i=Math.sin(t),o=e.dxPixels*n-e.dyPixels*i,s=e.dxPixels*i+e.dyPixels*n,a=(e.dxPixels+e.width)*n-e.dyPixels*i,r=(e.dxPixels+e.width)*i+e.dyPixels*n,l=e.dxPixels*n-(e.dyPixels+e.height)*i,h=e.dxPixels*i+(e.dyPixels+e.height)*n,c=(e.dxPixels+e.width)*n-(e.dyPixels+e.height)*i,x=(e.dxPixels+e.width)*i+(e.dyPixels+e.height)*n,y=Math.min(o,a,l,c),g=Math.max(o,a,l,c),f=Math.min(s,r,h,x),d=Math.max(s,r,h,x);e.dxPixels=y,e.dyPixels=f,e.width=g-y,e.height=d-f}}}}}},f._addPlacedIcons=function(e,t,n,i,o,s){const r=Math.max(n-1,0),l=this._iconVertexBuffer,h=this._iconIndexBuffer,c=this._markerMap;for(const x of t){const t=o?0:Math.max(n+a.log2(x.minzoom),r),y=o?25:Math.min(n+a.log2(x.maxzoom),25);if(y<=t)continue;const g=x.tl,f=x.tr,d=x.bl,u=x.br,m=x.mosaicRect,p=x.labelAngle,_=x.minAngle,P=x.maxAngle,I=x.anchor,b=l.index,A=m.x,M=m.y,T=A+m.width,L=M+m.height,S=l.index;l.add(I.x,I.y,g.x,g.y,A,M,p,_,P,t,y,s),l.add(I.x,I.y,f.x,f.y,T,M,p,_,P,t,y,s),l.add(I.x,I.y,d.x,d.y,A,L,p,_,P,t,y,s),l.add(I.x,I.y,u.x,u.y,T,L,p,_,P,t,y,s),e.iconVertexRanges.length>0&&e.iconVertexRanges[0][0]+e.iconVertexRanges[0][1]===S?e.iconVertexRanges[0][1]+=4:e.iconVertexRanges.push([S,4]),h.add(b+0,b+1,b+2),h.add(b+1,b+2,b+3),c.has(i)?c.get(i)[1]+=6:c.set(i,[this._iconIndexStart+this._iconIndexCount,6]),this._iconIndexCount+=6}},f._addPlacedGlyphs=function(){const e=this._textVertexBuffer,t=this._textIndexBuffer,n=this._glyphMap;for(const[i,o]of this._glyphBufferDataStorage)for(const s of o){const o=e.index,a=s.symbolInstance,r=s.ddAttributes,l=e.index;e.add(s.glyphAnchor[0],s.glyphAnchor[1],s.tl[0],s.tl[1],s.xmin,s.ymin,s.labelAngle,s.minAngle,s.maxAngle,s.minLod,s.maxLod,r),e.add(s.glyphAnchor[0],s.glyphAnchor[1],s.tr[0],s.tr[1],s.xmax,s.ymin,s.labelAngle,s.minAngle,s.maxAngle,s.minLod,s.maxLod,r),e.add(s.glyphAnchor[0],s.glyphAnchor[1],s.bl[0],s.bl[1],s.xmin,s.ymax,s.labelAngle,s.minAngle,s.maxAngle,s.minLod,s.maxLod,r),e.add(s.glyphAnchor[0],s.glyphAnchor[1],s.br[0],s.br[1],s.xmax,s.ymax,s.labelAngle,s.minAngle,s.maxAngle,s.minLod,s.maxLod,r),a.textVertexRanges.length>0&&a.textVertexRanges[0][0]+a.textVertexRanges[0][1]===l?a.textVertexRanges[0][1]+=4:a.textVertexRanges.push([l,4]),t.add(o+0,o+1,o+2),t.add(o+1,o+2,o+3),n.has(i)?n.get(i)[1]+=6:n.set(i,[this._textIndexStart+this._textIndexCount,6]),this._textIndexCount+=6}this._glyphBufferDataStorage.clear()},f._storePlacedGlyphs=function(e,t,n,i,o){const s=Math.max(n-1,0),r=i===c.RotationAlignment.VIEWPORT;let l,h,x,y,g,f,d,u,m,p,_;for(const c of t){if(l=r?0:Math.max(n+a.log2(c.minzoom),s),h=r?25:Math.min(n+a.log2(c.maxzoom),25),h<=l)continue;x=c.tl,y=c.tr,g=c.bl,f=c.br,d=c.labelAngle,u=c.minAngle,m=c.maxAngle,p=c.anchor,_=c.mosaicRect,this._glyphBufferDataStorage.has(c.page)||this._glyphBufferDataStorage.set(c.page,[]);this._glyphBufferDataStorage.get(c.page).push({glyphAnchor:[p.x,p.y],tl:[x.x,x.y],tr:[y.x,y.y],bl:[g.x,g.y],br:[f.x,f.y],xmin:_.x,ymin:_.y,xmax:_.x+_.width,ymax:_.y+_.height,labelAngle:d,minAngle:u,maxAngle:m,minLod:l,maxLod:h,placementLod:s,symbolInstance:e,ddAttributes:o})}},h._pushAnchors=function(e,t,n,i){n+=i;let s=0;const l=t.length-1;for(let a=0;a<l;a++)s+=o.Point.distance(t[a],t[a+1]);let h=i||n;if(h*=.5,s<=h)return;const c=h/s;let x=0,y=-(n=s/Math.max(Math.round(s/n),1))/2;const g=t.length-1;for(let o=0;o<g;o++){const i=t[o],s=t[o+1],l=s.x-i.x,h=s.y-i.y,g=Math.sqrt(l*l+h*h);let f;for(;y+n<x+g;){y+=n;const t=(y-x)/g,d=a.interpolate(i.x,s.x,t),u=a.interpolate(i.y,s.y,t);void 0===f&&(f=Math.atan2(h,l)),e.push(new r.Anchor(d,u,f,o,c))}x+=g}},h._pushCenterAnchor=function(e,t){let n=0;const i=t.length-1;for(let a=0;a<i;a++)n+=o.Point.distance(t[a],t[a+1]);const s=n/2;let l=0;const h=t.length-1;for(let o=0;o<h;o++){const n=t[o],i=t[o+1],h=i.x-n.x,c=i.y-n.y,x=Math.sqrt(h*h+c*c);if(s<l+x){const t=(s-l)/x,y=a.interpolate(n.x,i.x,t),g=a.interpolate(n.y,i.y,t),f=Math.atan2(c,h);return void e.push(new r.Anchor(y,g,f,o,0))}l+=x}},h._deviation=function(e,t,n){const i=(t.x-e.x)*(n.x-t.x)+(t.y-e.y)*(n.y-t.y),o=(t.x-e.x)*(n.y-t.y)-(t.y-e.y)*(n.x-t.x);return Math.atan2(o,i)},h._honorsTextMaxAngle=function(e,t,n,i,s){let a=0;const r=n/2;let l=new o.Point(t.x,t.y),h=t.segment+1;for(;a>-r;){if(--h,h<0)return!1;a-=o.Point.distance(e[h],l),l=e[h]}a+=o.Point.distance(e[h],e[h+1]);const c=[];let x=0;const y=e.length;for(;a<r;){const t=e[h];let n,r=h;do{if(++r,r===y)return!1;n=e[r]}while(n.isEqual(t));let l,g=r;do{if(++g,g===y)return!1;l=e[g]}while(l.isEqual(n));const f=this._deviation(t,n,l);for(c.push({deviation:f,distToAnchor:a}),x+=f;a-c[0].distToAnchor>s;)x-=c.shift().deviation;if(Math.abs(x)>i)return!1;a+=o.Point.distance(n,l),h=r}return!0},h._smoothVertices=function(e,t){if(t<=0)return e;let n=e.length;if(n<3)return e;const i=[];let s=0,a=0;i.push(0);for(let d=1;d<n;d++){const t=o.Point.distance(e[d],e[d-1]);t>0&&(s+=t,i.push(s),a++,a!==d&&(e[a]=e[d]))}if(n=a+1,n<3)return e;t=Math.min(t,.2*s);const r=e[0].x,l=e[0].y,h=e[n-1].x,c=e[n-1].y,x=o.Point.sub(e[0],e[1]);x.normalize(),e[0].x+=t*x.x,e[0].y+=t*x.y,x.assignSub(e[n-1],e[n-2]),x.normalize(),e[n-1].x+=t*x.x,e[n-1].y+=t*x.y,i[0]-=t,i[n-1]+=t;const y=[];y.push(new o.Point(r,l));const g=1e-6,f=.5*t;for(let d=1;d<n-1;d++){let s=0,a=0,r=0;for(let n=d-1;n>=0;n--){const o=f+i[n+1]-i[d];if(o<0)break;const l=i[n+1]-i[n],h=i[d]-i[n]<f?1:o/l;if(h<g)break;const c=h*h,x=h*o-.5*c*l,y=h*l/t,u=e[n+1],m=e[n].x-u.x,p=e[n].y-u.y;s+=y/x*(u.x*h*o+.5*c*(o*m-l*u.x)-c*h*l*m/3),a+=y/x*(u.y*h*o+.5*c*(o*p-l*u.y)-c*h*l*p/3),r+=y}for(let o=d+1;o<n;o++){const n=f-i[o-1]+i[d];if(n<0)break;const l=i[o]-i[o-1],h=i[o]-i[d]<f?1:n/l;if(h<g)break;const c=h*h,x=h*n-.5*c*l,y=h*l/t,u=e[o-1],m=e[o].x-u.x,p=e[o].y-u.y;s+=y/x*(u.x*h*n+.5*c*(n*m-l*u.x)-c*h*l*m/3),a+=y/x*(u.y*h*n+.5*c*(n*p-l*u.y)-c*h*l*p/3),r+=y}y.push(new o.Point(s/r,a/r))}return y.push(new o.Point(h,c)),e[0].x=r,e[0].y=l,e[n-1].x=h,e[n-1].y=c,y},h._pushCentroid=function(e,t){const n=0,i=0,o=4096,s=4096,a=t.length-1;let l=0,h=0,c=0,x=t[0].x,y=t[0].y;x>o&&(x=o),x<n&&(x=n),y>s&&(y=s),y<i&&(y=i);for(let r=1;r<a;r++){let e=t[r].x,a=t[r].y,g=t[r+1].x,f=t[r+1].y;e>o&&(e=o),e<n&&(e=n),a>s&&(a=s),a<i&&(a=i),g>o&&(g=o),g<n&&(g=n),f>s&&(f=s),f<i&&(f=i);const d=(e-x)*(f-y)-(g-x)*(a-y);l+=d*(x+e+g),h+=d*(y+a+f),c+=d}l/=3*c,h/=3*c,isNaN(l)||isNaN(h)||e.push(new r.Anchor(l,h))},e._createClass(h,[{key:"markerPageMap",get:function(){return this._markerMap}},{key:"glyphsPageMap",get:function(){return this._glyphMap}},{key:"symbolInstances",get:function(){return this._symbolInstances}}]),h}(h);return f._bidiEngine=new t,f}));
