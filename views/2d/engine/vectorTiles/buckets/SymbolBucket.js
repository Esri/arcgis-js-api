/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/BidiEngine","../../../../../core/string","../GeometryUtils","../Placement","../TextShaping","./BaseBucket","../style/StyleLayer","../../webgl/Geometry"],(function(e,t,n,i,o,s,a,r,l){"use strict";const h=10;function c(e,t){return e.iconMosaicItem&&t.iconMosaicItem?e.iconMosaicItem.page===t.iconMosaicItem.page?0:e.iconMosaicItem.page-t.iconMosaicItem.page:e.iconMosaicItem&&!t.iconMosaicItem?1:!e.iconMosaicItem&&t.iconMosaicItem?-1:0}let x=function(t){function a(e,n,i,o,s,a,r,l){var h;return(h=t.call(this,e,n,l.getSpriteItems())||this).type=3,h._markerMap=new Map,h._glyphMap=new Map,h._glyphBufferDataStorage=new Map,h._isIconSDF=!1,h._iconVertexBuffer=i,h._iconIndexBuffer=o,h._textVertexBuffer=s,h._textIndexBuffer=a,h._placementEngine=r,h._workerTileHandler=l,h}e._inheritsLoose(a,t);var x=a.prototype;return x.getResources=function(e,t,i){const o=this.layer,s=this.zoom;e&&e.setExtent(this.layerExtent);const r=o.getLayoutProperty("icon-image"),l=o.getLayoutProperty("text-field");let h=o.getLayoutProperty("text-transform"),c=o.getLayoutProperty("text-font");const x=[];let f,d,g,y;r&&!r.isDataDriven&&(f=r.getValue(s)),l&&!l.isDataDriven&&(d=l.getValue(s)),h&&h.isDataDriven||(g=o.getLayoutValue("text-transform",s),h=null),c&&c.isDataDriven||(y=o.getLayoutValue("text-font",s),c=null);for(const u of this._features){const m=u.getGeometry(e);if(!m||0===m.length)continue;let p,_;r&&(p=r.isDataDriven?r.getValue(s,u):this._replaceKeys(f,u.values),p&&t(p));let I=!1;if(l&&(_=l.isDataDriven?l.getValue(s,u):this._replaceKeys(d,u.values),_)){switch(_=_.replace(/\\n/g,"\n"),h&&(g=h.getValue(s,u)),g){case 2:_=_.toLowerCase();break;case 1:_=_.toUpperCase()}if(a._bidiEngine.hasBidiChar(_)){let e;e="rtl"===a._bidiEngine.checkContextual(_)?"IDNNN":"ICNNN",_=a._bidiEngine.bidiTransform(_,e,"VLYSN"),I=!0}const e=_.length;if(e>0){c&&(y=c.getValue(s,u));for(const t of y){let n=i[t];n||(n=i[t]=new Set);for(let t=0;t<e;t++){const e=_.charCodeAt(t);n.add(e)}}}}if(!p&&!_)continue;const P=o.getLayoutValue("symbol-sort-key",s,u),M={feature:u,sprite:p,label:_,rtl:I,geometry:m,hash:(_?n.numericHash(_):0)^(p?n.numericHash(p):0),priority:P,textFont:y};x.push(M)}this._symbolFeatures=x},x.processFeatures=function(e){e&&e.setExtent(this.layerExtent);const t=this.layer,n=this.zoom,l=t.getLayoutValue("symbol-placement",n),h=0!==l,x=t.getLayoutValue("symbol-spacing",n)*o.TILE_PIXEL_RATIO,f=t.getLayoutProperty("icon-image"),d=t.getLayoutProperty("text-field"),g=f?new r.IconLayout(t,n,h):null,y=d?new r.TextLayout(t,n,h):null,u=this._workerTileHandler;let m;f&&(m=u.getSpriteItems()),this._iconIndexStart=3*this._iconIndexBuffer.index,this._textIndexStart=3*this._textIndexBuffer.index,this._iconIndexCount=0,this._textIndexCount=0,this._markerMap.clear(),this._glyphMap.clear();const p=[];let _=1;y&&y.size&&(_=y.size/s.SDF_GLYPH_SIZE);const I=y?y.maxAngle*i.C_DEG_TO_RAD:0,P=y?y.size*o.TILE_PIXEL_RATIO:0;for(const i of this._symbolFeatures){let e;g&&m&&i.sprite&&(e=m[i.sprite],e&&e.sdf&&(this._isIconSDF=!0));let t;!!e&&g.update(n,i.feature);let r=0;const c=i.label;if(c){y.update(n,i.feature);const e=h?y.keepUpright:y.writingMode&&y.writingMode.indexOf(1)>=0;let a=.5;switch(y.anchor){case 5:case 1:case 7:a=0;break;case 6:case 2:case 8:a=1}let l=.5;switch(y.anchor){case 5:case 3:case 6:l=0;break;case 7:case 4:case 8:l=1}let x=.5;switch(y.justify){case 0:x=a;break;case 1:x=0;break;case 3:x=1}const f=y.letterSpacing*s.SDF_GLYPH_SIZE,d=h?0:y.maxWidth*s.SDF_GLYPH_SIZE,g=y.lineHeight*s.SDF_GLYPH_SIZE,m=i.textFont.map((e=>u.getGlyphItems(e)));if(t=new s.TextShaping(m,d,g,f,a,l,x).getShaping(c,i.rtl,e),t&&t.length>0){let e=1e30,n=-1e30;for(const i of t)e=Math.min(e,i.x),n=Math.max(n,i.x);r=(n-e+2*s.SDF_GLYPH_SIZE)*_*o.TILE_PIXEL_RATIO}}for(let n of i.geometry){const s=[];if(1===l){if(t&&t.length>0&&y&&y.size){const e=y.size*o.TILE_PIXEL_RATIO*(2+Math.min(2,4*Math.abs(y.offset[1])));n=a._smoothVertices(n,e)}a._pushAnchors(s,n,x,r)}else 2===l?a._pushCenterAnchor(s,n):3===i.feature.type?a._pushCentroid(s,n):s.push(new o.Anchor(n[0].x,n[0].y));for(const l of s){if(l.x<0||l.x>o.TILE_COORD_SIZE||l.y<0||l.y>o.TILE_COORD_SIZE)continue;if(h&&r>0&&0===y.rotationAlignment&&!a._honorsTextMaxAngle(n,l,r,I,P))continue;const s={shaping:t,line:n,iconMosaicItem:e,anchor:l,symbolFeature:i,textColliders:[],iconColliders:[],textVertexRanges:[],iconVertexRanges:[]};p.push(s),this._processFeature(s,g,y)}}}p.sort(c),this._addPlacedGlyphs(),this._symbolInstances=p},x.serialize=function(){let e=11;e+=this.layerUIDs.length,e+=3*this.markerPageMap.size,e+=3*this.glyphsPageMap.size,e+=a.symbolsSerializationLength(this._symbolInstances),e+=this._iconVertexBuffer.array.length,e+=this._iconIndexBuffer.array.length,e+=this._textVertexBuffer.array.length,e+=this._textIndexBuffer.array.length;const t=new Uint32Array(e),n=new Int32Array(t.buffer),i=new Float32Array(t.buffer);let o=0;t[o++]=this.type,t[o++]=this.layerUIDs.length;for(let s=0;s<this.layerUIDs.length;s++)t[o++]=this.layerUIDs[s];t[o++]=this._isIconSDF?1:0,t[o++]=this.markerPageMap.size;for(const[s,[a,r]]of this.markerPageMap)t[o++]=s,t[o++]=a,t[o++]=r;t[o++]=this.glyphsPageMap.size;for(const[s,[a,r]]of this.glyphsPageMap)t[o++]=s,t[o++]=a,t[o++]=r;t[o++]=this._iconVertexBuffer.index/4,t[o++]=this._textVertexBuffer.index/4,o=a.serializeSymbols(t,n,i,o,this._symbolInstances),t[o++]=this._iconVertexBuffer.array.length;for(let s=0;s<this._iconVertexBuffer.array.length;s++)n[o++]=this._iconVertexBuffer.array[s];t[o++]=this._iconIndexBuffer.array.length;for(let s=0;s<this._iconIndexBuffer.array.length;s++)t[o++]=this._iconIndexBuffer.array[s];t[o++]=this._textVertexBuffer.array.length;for(let s=0;s<this._textVertexBuffer.array.length;s++)n[o++]=this._textVertexBuffer.array[s];t[o++]=this._textIndexBuffer.array.length;for(let s=0;s<this._textIndexBuffer.array.length;s++)t[o++]=this._textIndexBuffer.array[s];return t.buffer},a.symbolsSerializationLength=function(e){let t=0;t+=1;for(const n of e||[]){t+=4,t+=1;for(const e of n.textColliders)t+=h;for(const e of n.iconColliders)t+=h;t+=1,t+=2*n.textVertexRanges.length,t+=1,t+=2*n.iconVertexRanges.length}return t},a.serializeSymbols=function(e,t,n,i,o){o=o||[],t[i++]=o.length;for(const s of o){t[i++]=s.anchor.x,t[i++]=s.anchor.y,t[i++]=s.symbolFeature.hash,t[i++]=s.symbolFeature.priority,t[i++]=s.textColliders.length+s.iconColliders.length;for(const e of s.textColliders)t[i++]=e.xTile,t[i++]=e.yTile,t[i++]=e.dxPixels,t[i++]=e.dyPixels,t[i++]=e.hard?1:0,t[i++]=e.partIndex,n[i++]=e.minLod,n[i++]=e.maxLod,t[i++]=e.width,t[i++]=e.height;for(const e of s.iconColliders)t[i++]=e.xTile,t[i++]=e.yTile,t[i++]=e.dxPixels,t[i++]=e.dyPixels,t[i++]=e.hard?1:0,t[i++]=e.partIndex,n[i++]=e.minLod,n[i++]=e.maxLod,t[i++]=e.width,t[i++]=e.height;t[i++]=s.textVertexRanges.length;for(const[e,n]of s.textVertexRanges)t[i++]=e,t[i++]=n;t[i++]=s.iconVertexRanges.length;for(const[e,n]of s.iconVertexRanges)t[i++]=e,t[i++]=n}return i},x._replaceKeys=function(e,t){return e.replace(/{([^{}]+)}/g,(function(e,n){return n in t?t[n]:""}))},x._processFeature=function(e,t,n){const{line:o,iconMosaicItem:s,shaping:a,anchor:r}=e,l=this.zoom,h=this.layer,c=!!s;let x=!0;c&&(x=t.optional||!s);const f=a&&a.length>0;let d,g,y=!0;if(f&&(y=n.optional),c&&(d=this._placementEngine.getIconPlacement(r,s,t)),(d||x)&&(f&&(g=this._placementEngine.getTextPlacement(r,a,o,n)),g||y)){if(d&&g||(y||x?y||g?x||d||(g=null):d=null:(d=null,g=null)),g){const t=h.hasDataDrivenText?h.textMaterial.encodeAttributes(e.symbolFeature.feature,l,h):null;if(this._storePlacedGlyphs(e,g.shapes,l,n.rotationAlignment,t),g.textColliders){e.textColliders=g.textColliders;for(const e of g.textColliders){e.minLod=Math.max(l+i.log2(e.minLod),0),e.maxLod=Math.min(l+i.log2(e.maxLod),25);const t=e.angle;if(t){const n=Math.cos(t),i=Math.sin(t),o=e.dxPixels*n-e.dyPixels*i,s=e.dxPixels*i+e.dyPixels*n,a=(e.dxPixels+e.width)*n-e.dyPixels*i,r=(e.dxPixels+e.width)*i+e.dyPixels*n,l=e.dxPixels*n-(e.dyPixels+e.height)*i,h=e.dxPixels*i+(e.dyPixels+e.height)*n,c=(e.dxPixels+e.width)*n-(e.dyPixels+e.height)*i,x=(e.dxPixels+e.width)*i+(e.dyPixels+e.height)*n,f=Math.min(o,a,l,c),d=Math.max(o,a,l,c),g=Math.min(s,r,h,x),y=Math.max(s,r,h,x);e.dxPixels=f,e.dyPixels=g,e.width=d-f,e.height=y-g}}}}if(d){const n=h.hasDataDrivenIcon?h.iconMaterial.encodeAttributes(e.symbolFeature.feature,l,h):null;if(this._addPlacedIcons(e,d.shapes,l,s.page,1===t.rotationAlignment,n),d.iconColliders){e.iconColliders=d.iconColliders;for(const e of d.iconColliders){e.minLod=Math.max(l+i.log2(e.minLod),0),e.maxLod=Math.min(l+i.log2(e.maxLod),25);const t=e.angle;if(t){const n=Math.cos(t),i=Math.sin(t),o=e.dxPixels*n-e.dyPixels*i,s=e.dxPixels*i+e.dyPixels*n,a=(e.dxPixels+e.width)*n-e.dyPixels*i,r=(e.dxPixels+e.width)*i+e.dyPixels*n,l=e.dxPixels*n-(e.dyPixels+e.height)*i,h=e.dxPixels*i+(e.dyPixels+e.height)*n,c=(e.dxPixels+e.width)*n-(e.dyPixels+e.height)*i,x=(e.dxPixels+e.width)*i+(e.dyPixels+e.height)*n,f=Math.min(o,a,l,c),d=Math.max(o,a,l,c),g=Math.min(s,r,h,x),y=Math.max(s,r,h,x);e.dxPixels=f,e.dyPixels=g,e.width=d-f,e.height=y-g}}}}}},x._addPlacedIcons=function(e,t,n,o,s,a){const r=Math.max(n-1,0),l=this._iconVertexBuffer,h=this._iconIndexBuffer,c=this._markerMap;for(const x of t){const t=s?0:Math.max(n+i.log2(x.minzoom),r),f=s?25:Math.min(n+i.log2(x.maxzoom),25);if(f<=t)continue;const d=x.tl,g=x.tr,y=x.bl,u=x.br,m=x.mosaicRect,p=x.labelAngle,_=x.minAngle,I=x.maxAngle,P=x.anchor,M=l.index,b=m.x,A=m.y,L=b+m.width,V=A+m.height,w=l.index;l.add(P.x,P.y,d.x,d.y,b,A,p,_,I,t,f,a),l.add(P.x,P.y,g.x,g.y,L,A,p,_,I,t,f,a),l.add(P.x,P.y,y.x,y.y,b,V,p,_,I,t,f,a),l.add(P.x,P.y,u.x,u.y,L,V,p,_,I,t,f,a),e.iconVertexRanges.length>0&&e.iconVertexRanges[0][0]+e.iconVertexRanges[0][1]===w?e.iconVertexRanges[0][1]+=4:e.iconVertexRanges.push([w,4]),h.add(M+0,M+1,M+2),h.add(M+1,M+2,M+3),c.has(o)?c.get(o)[1]+=6:c.set(o,[this._iconIndexStart+this._iconIndexCount,6]),this._iconIndexCount+=6}},x._addPlacedGlyphs=function(){const e=this._textVertexBuffer,t=this._textIndexBuffer,n=this._glyphMap;for(const[i,o]of this._glyphBufferDataStorage)for(const s of o){const o=e.index,a=s.symbolInstance,r=s.ddAttributes,l=e.index;e.add(s.glyphAnchor[0],s.glyphAnchor[1],s.tl[0],s.tl[1],s.xmin,s.ymin,s.labelAngle,s.minAngle,s.maxAngle,s.minLod,s.maxLod,r),e.add(s.glyphAnchor[0],s.glyphAnchor[1],s.tr[0],s.tr[1],s.xmax,s.ymin,s.labelAngle,s.minAngle,s.maxAngle,s.minLod,s.maxLod,r),e.add(s.glyphAnchor[0],s.glyphAnchor[1],s.bl[0],s.bl[1],s.xmin,s.ymax,s.labelAngle,s.minAngle,s.maxAngle,s.minLod,s.maxLod,r),e.add(s.glyphAnchor[0],s.glyphAnchor[1],s.br[0],s.br[1],s.xmax,s.ymax,s.labelAngle,s.minAngle,s.maxAngle,s.minLod,s.maxLod,r),a.textVertexRanges.length>0&&a.textVertexRanges[0][0]+a.textVertexRanges[0][1]===l?a.textVertexRanges[0][1]+=4:a.textVertexRanges.push([l,4]),t.add(o+0,o+1,o+2),t.add(o+1,o+2,o+3),n.has(i)?n.get(i)[1]+=6:n.set(i,[this._textIndexStart+this._textIndexCount,6]),this._textIndexCount+=6}this._glyphBufferDataStorage.clear()},x._storePlacedGlyphs=function(e,t,n,o,s){const a=Math.max(n-1,0),r=1===o;let l,h,c,x,f,d,g,y,u,m,p;for(const _ of t){if(l=r?0:Math.max(n+i.log2(_.minzoom),a),h=r?25:Math.min(n+i.log2(_.maxzoom),25),h<=l)continue;c=_.tl,x=_.tr,f=_.bl,d=_.br,g=_.labelAngle,y=_.minAngle,u=_.maxAngle,m=_.anchor,p=_.mosaicRect,this._glyphBufferDataStorage.has(_.page)||this._glyphBufferDataStorage.set(_.page,[]);this._glyphBufferDataStorage.get(_.page).push({glyphAnchor:[m.x,m.y],tl:[c.x,c.y],tr:[x.x,x.y],bl:[f.x,f.y],br:[d.x,d.y],xmin:p.x,ymin:p.y,xmax:p.x+p.width,ymax:p.y+p.height,labelAngle:g,minAngle:y,maxAngle:u,minLod:l,maxLod:h,placementLod:a,symbolInstance:e,ddAttributes:s})}},a._pushAnchors=function(e,t,n,s){n+=s;let a=0;const r=t.length-1;for(let i=0;i<r;i++)a+=l.Point.distance(t[i],t[i+1]);let h=s||n;if(h*=.5,a<=h)return;const c=h/a;let x=0,f=-(n=a/Math.max(Math.round(a/n),1))/2;const d=t.length-1;for(let l=0;l<d;l++){const s=t[l],a=t[l+1],r=a.x-s.x,h=a.y-s.y,d=Math.sqrt(r*r+h*h);let g;for(;f+n<x+d;){f+=n;const t=(f-x)/d,y=i.interpolate(s.x,a.x,t),u=i.interpolate(s.y,a.y,t);void 0===g&&(g=Math.atan2(h,r)),e.push(new o.Anchor(y,u,g,l,c))}x+=d}},a._pushCenterAnchor=function(e,t){let n=0;const s=t.length-1;for(let i=0;i<s;i++)n+=l.Point.distance(t[i],t[i+1]);const a=n/2;let r=0;const h=t.length-1;for(let l=0;l<h;l++){const n=t[l],s=t[l+1],h=s.x-n.x,c=s.y-n.y,x=Math.sqrt(h*h+c*c);if(a<r+x){const t=(a-r)/x,f=i.interpolate(n.x,s.x,t),d=i.interpolate(n.y,s.y,t),g=Math.atan2(c,h);return void e.push(new o.Anchor(f,d,g,l,0))}r+=x}},a._deviation=function(e,t,n){const i=(t.x-e.x)*(n.x-t.x)+(t.y-e.y)*(n.y-t.y),o=(t.x-e.x)*(n.y-t.y)-(t.y-e.y)*(n.x-t.x);return Math.atan2(o,i)},a._honorsTextMaxAngle=function(e,t,n,i,o){let s=0;const a=n/2;let r=new l.Point(t.x,t.y),h=t.segment+1;for(;s>-a;){if(--h,h<0)return!1;s-=l.Point.distance(e[h],r),r=e[h]}s+=l.Point.distance(e[h],e[h+1]);const c=[];let x=0;const f=e.length;for(;s<a;){const t=e[h];let n,a=h;do{if(++a,a===f)return!1;n=e[a]}while(n.isEqual(t));let r,d=a;do{if(++d,d===f)return!1;r=e[d]}while(r.isEqual(n));const g=this._deviation(t,n,r);for(c.push({deviation:g,distToAnchor:s}),x+=g;s-c[0].distToAnchor>o;)x-=c.shift().deviation;if(Math.abs(x)>i)return!1;s+=l.Point.distance(n,r),h=a}return!0},a._smoothVertices=function(e,t){if(t<=0)return e;let n=e.length;if(n<3)return e;const i=[];let o=0,s=0;i.push(0);for(let y=1;y<n;y++){const t=l.Point.distance(e[y],e[y-1]);t>0&&(o+=t,i.push(o),s++,s!==y&&(e[s]=e[y]))}if(n=s+1,n<3)return e;t=Math.min(t,.2*o);const a=e[0].x,r=e[0].y,h=e[n-1].x,c=e[n-1].y,x=l.Point.sub(e[0],e[1]);x.normalize(),e[0].x+=t*x.x,e[0].y+=t*x.y,x.assignSub(e[n-1],e[n-2]),x.normalize(),e[n-1].x+=t*x.x,e[n-1].y+=t*x.y,i[0]-=t,i[n-1]+=t;const f=[];f.push(new l.Point(a,r));const d=1e-6,g=.5*t;for(let y=1;y<n-1;y++){let o=0,s=0,a=0;for(let n=y-1;n>=0;n--){const r=g+i[n+1]-i[y];if(r<0)break;const l=i[n+1]-i[n],h=i[y]-i[n]<g?1:r/l;if(h<d)break;const c=h*h,x=h*r-.5*c*l,f=h*l/t,u=e[n+1],m=e[n].x-u.x,p=e[n].y-u.y;o+=f/x*(u.x*h*r+.5*c*(r*m-l*u.x)-c*h*l*m/3),s+=f/x*(u.y*h*r+.5*c*(r*p-l*u.y)-c*h*l*p/3),a+=f}for(let r=y+1;r<n;r++){const n=g-i[r-1]+i[y];if(n<0)break;const l=i[r]-i[r-1],h=i[r]-i[y]<g?1:n/l;if(h<d)break;const c=h*h,x=h*n-.5*c*l,f=h*l/t,u=e[r-1],m=e[r].x-u.x,p=e[r].y-u.y;o+=f/x*(u.x*h*n+.5*c*(n*m-l*u.x)-c*h*l*m/3),s+=f/x*(u.y*h*n+.5*c*(n*p-l*u.y)-c*h*l*p/3),a+=f}f.push(new l.Point(o/a,s/a))}return f.push(new l.Point(h,c)),e[0].x=a,e[0].y=r,e[n-1].x=h,e[n-1].y=c,f},a._pushCentroid=function(e,t){const n=0,i=0,s=4096,a=4096,r=t.length-1;let l=0,h=0,c=0,x=t[0].x,f=t[0].y;x>s&&(x=s),x<n&&(x=n),f>a&&(f=a),f<i&&(f=i);for(let o=1;o<r;o++){let e=t[o].x,r=t[o].y,d=t[o+1].x,g=t[o+1].y;e>s&&(e=s),e<n&&(e=n),r>a&&(r=a),r<i&&(r=i),d>s&&(d=s),d<n&&(d=n),g>a&&(g=a),g<i&&(g=i);const y=(e-x)*(g-f)-(d-x)*(r-f);l+=y*(x+e+d),h+=y*(f+r+g),c+=y}l/=3*c,h/=3*c,isNaN(l)||isNaN(h)||e.push(new o.Anchor(l,h))},e._createClass(a,[{key:"markerPageMap",get:function(){return this._markerMap}},{key:"glyphsPageMap",get:function(){return this._glyphMap}},{key:"symbolInstances",get:function(){return this._symbolInstances}}]),a}(a);return x._bidiEngine=new t,x}));
