/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/promiseUtils","../../../../geometry/support/aaBoundingRect","../../tiling/TileKey","../../tiling/TileCoverage","../webgl/TiledDisplayObject","../webgl/enums","../webgl/TileContainer","./decluttering/debugging","./decluttering/SymbolFader"],(function(e,t,s,i,r,o,n,l,a,d,c,h){"use strict";const u=1e-6;function y(e,t){if(e){const s=e.getLayoutProperty("visibility");if(!s||"none"!==s.getValue()&&(void 0===e.minzoom||e.minzoom<t+u)&&(void 0===e.maxzoom||e.maxzoom>=t-u))return!0}return!1}let f=function(e){function d(t){var s;return(s=e.call(this,t)||this)._backgroundTiles=[],s._pointToCallbacks=new Map,s._fading=!1,s}t._inheritsLoose(d,e);var f=d.prototype;return f.destroy=function(){this.children.forEach((e=>e.destroy())),this.removeAllChildren(),this._spriteMosaic&&(this._spriteMosaic.dispose(),this._spriteMosaic=null),this._glyphMosaic&&(this._glyphMosaic.dispose(),this._glyphMosaic=null),s.isSome(this._symbolFader)&&(this._symbolFader.clear(),this._symbolFader=null),this._styleRepository=null,this._backgroundTiles=[],this._pointToCallbacks.clear()},f.setStyleResources=function(e,t,i){if(this._spriteMosaic=e,this._glyphMosaic=t,this._styleRepository=i,s.isNone(this._symbolFader)){const e=new h.SymbolFader(this._styleRepository,this.children);e.on("fade-start",(()=>{this.emit("fade-start"),this._fading=!0,this.requestRender()})),e.on("fade-complete",(()=>{this.emit("fade-complete"),this._fading=!1,this.requestRender()})),this._symbolFader=e}s.unwrap(this._symbolFader).styleRepository=i},f.deleteStyleLayers=function(e){s.isSome(this._symbolFader)&&this._symbolFader.deleteStyleLayers(e)},f.hitTest=async function(e,t){const s=[e,t],r=i.createResolver();return this._pointToCallbacks.set(s,r),this.requestRender(),r.promise},f.enterTileInvalidation=function(){for(const e of this.children)e.invalidating=!0},f.createRenderParams=function(t){return{...e.prototype.createRenderParams.call(this,t),renderPass:null,styleLayer:null,styleLayerUID:-1,glyphMosaic:this._glyphMosaic,spriteMosaic:this._spriteMosaic,hasClipping:!!this._clippingInfos}},f.doRender=function(t){!this.visible||t.drawPhase!==a.WGLDrawPhase.MAP&&t.drawPhase!==a.WGLDrawPhase.DEBUG||void 0===this._spriteMosaic||e.prototype.doRender.call(this,t)},f.addChild=function(t){return e.prototype.addChild.call(this,t),s.isSome(this._symbolFader)?this._symbolFader.addTile(t):t.decluttered=!0,this.requestRender(),t},f.removeChild=function(t){return s.isSome(this._symbolFader)&&this._symbolFader.removeTile(t),this.requestRender(),e.prototype.removeChild.call(this,t)},f.renderChildren=function(t){if(t.drawPhase!==a.WGLDrawPhase.DEBUG){if(this._doRender(t),this._pointToCallbacks.size>0){const{context:e}=t,s=e.getBoundFramebufferObject();t.drawPhase=a.WGLDrawPhase.HITTEST;const i=t.painter.effects.hittest;i.bind(t),this._doRender(t),i.draw(t,this._pointToCallbacks),e.bindFramebuffer(s)}}else e.prototype.renderChildren.call(this,t)},f.removeAllChildren=function(){for(let e=0;e<this.children.length;e++){const t=this.children[e];s.isSome(this._symbolFader)&&this._symbolFader.removeTile(t),t.dispose()}e.prototype.removeAllChildren.call(this)},f.getStencilTarget=function(){return this.children.filter((e=>e.neededForCoverage&&e.hasData()))},f.restartDeclutter=function(){s.isSome(this._symbolFader)&&this._symbolFader.restartDeclutter()},f._doRender=function(t){const{context:i}=t,r=this._styleRepository;if(!r)return;const o=r.layers;let n=!0;t.drawPhase===a.WGLDrawPhase.HITTEST&&(n=!1),r.backgroundBucketIds.length>0&&(t.renderPass="background",this._renderBackgroundLayers(t,r.backgroundBucketIds)),e.prototype.renderChildren.call(this,t);const l=this.children.filter((e=>e.visible&&e.hasData()));if(l&&0!==l.length){for(const e of l)e.triangleCount=0;i.setStencilWriteMask(0),i.setColorMask(!0,!0,!0,!0),i.setStencilOp(7680,7680,7681),i.setStencilTestEnabled(!0),i.setBlendingEnabled(!1),i.setDepthTestEnabled(!0),i.setDepthWriteEnabled(!0),i.setDepthFunction(515),i.setClearDepth(1),i.clear(i.gl.DEPTH_BUFFER_BIT),t.renderPass="opaque";for(let e=o.length-1;e>=0;e--)this._renderStyleLayer(o[e],t,l);i.setDepthWriteEnabled(!1),i.setBlendingEnabled(n),i.setBlendFunctionSeparate(1,771,1,771),t.renderPass="translucent";for(let e=0;e<o.length;e++)this._renderStyleLayer(o[e],t,l);i.setDepthTestEnabled(!1),t.renderPass="symbol";for(let e=0;e<o.length;e++)this._renderStyleLayer(o[e],t,l);if(i.bindVAO(),i.setStencilTestEnabled(!0),i.setBlendingEnabled(!0),t.drawPhase===a.WGLDrawPhase.MAP){this._fade(t.displayLevel,t.state);const e=window.COLLISION_DEBUG_CTX;if(e&&s.isSome(this._symbolFader)&&(e.clearRect(0,0,e.canvas.width,e.canvas.height),!this._fading||window.COLLISION_XRAY))for(const t of this.children)if(t.symbols){const s=[];if(t.symbols.forEach((e=>{s.push(...e)})),window.COLLISION_SHOW_GRID){var d,h,u;const t=null==(d=this._symbolFader)||null==(h=d._symbolDeclutterer)||null==(u=h._collisionJob)?void 0:u._gridIndex;t&&c.drawGridIndex(e,t)}c.drawColliders(e,s)}}}},f._fade=function(e,t){s.isSome(this._symbolFader)&&(this._symbolFader.update(e,t)||this.requestRender())},f._renderStyleLayer=function(e,t,s){const{painter:i,renderPass:r}=t;if(void 0===e)return;const o=e.getLayoutProperty("visibility");if(o&&"none"===o.getValue())return;let n;switch(e.type){case 0:return;case 1:if("opaque"!==r&&"translucent"!==t.renderPass)return;n="vtlFill";break;case 2:if("translucent"!==r)return;n="vtlLine";break;case 4:if("symbol"!==r)return;n="vtlCircle";break;case 3:if("symbol"!==r)return;n="vtlSymbol"}if(s=3===e.type?s.filter((e=>e.decluttered)):s.filter((e=>e.neededForCoverage)),"vtlSymbol"!==n){const i=t.displayLevel;if(0===s.length||void 0!==e.minzoom&&e.minzoom>=i+u||void 0!==e.maxzoom&&e.maxzoom<i-u)return}const l=e.uid;t.styleLayerUID=l,t.styleLayer=e;for(const e of s)if(e.layerData.has(l)){i.renderObjects(t,s,n);break}},f._renderBackgroundLayers=function(e,t){const{context:i,displayLevel:d,painter:c,state:h}=e,u=this._styleRepository;let f=!1;for(const e of t)if(y(u.getLayerById(e),d)){f=!0;break}if(!f)return;const p=this._tileInfoView.getTileCoverage(e.state,0,"smallest"),{spans:_,lodInfo:m}=p,{level:b}=m,g=r.create(),T=[];if(this._renderPasses){const t=this._renderPasses[0];s.isSome(this._clippingInfos)&&(t.brushes[0].prepareState(e,this._clippingInfos[0]),t.brushes[0].drawMany(e,this._clippingInfos))}const v=this._backgroundTiles;let w,S=0;for(const{row:e,colFrom:t,colTo:s}of _)for(let i=t;i<=s;i++){if(S<v.length)w=v[S],w.key.set(b,e,m.normalizeCol(i),m.getWorldForColumn(i)),this._tileInfoView.getTileBounds(g,w.key,!1),w.bounds=g,w.coords[0]=g[0],w.coords[1]=g[3];else{const t=new o(b,e,m.normalizeCol(i),m.getWorldForColumn(i));w=new l.TiledDisplayObject(t,this._tileInfoView.getTileBounds(r.create(),t),[512,512],[4096,4096]),v.push(w)}w.setTransform(h,this._tileInfoView.getTileResolution(w.key)),T.push(w),S++}i.setStencilWriteMask(0),i.setColorMask(!0,!0,!0,!0),i.setStencilOp(7680,7680,7681),i.setStencilFunction(514,0,255);let C=!0;e.drawPhase===a.WGLDrawPhase.HITTEST&&(C=!1),i.setStencilTestEnabled(C);for(const s of t){const t=u.getLayerById(s);y(t,d)&&(e.styleLayerUID=t.uid,e.styleLayer=t,c.renderObjects(e,T,"vtlBackground"))}n.pool.release(p)},d}(d.default);e.VectorTileContainer=f,Object.defineProperty(e,"__esModule",{value:!0})}));
