/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/promiseUtils","../../../../geometry/support/aaBoundingRect","./decluttering/SymbolFader","../webgl/enums","../webgl/RenderableTile","../webgl/TileContainer","../../tiling/TileCoverage","../../tiling/TileKey"],(function(e,t,s,r,i,n,o,l,a,d,c){"use strict";const h=1e-6;function u(e,t){if(e){const s=e.getLayoutProperty("visibility");if(!s||1!==s.getValue()&&(void 0===e.minzoom||e.minzoom<t+h)&&(void 0===e.maxzoom||e.maxzoom>=t-h))return!0}return!1}let y=function(e){function a(t){var s;return(s=e.call(this,t)||this)._backgroundTiles=[],s._pointToCallbacks=new Map,s}t._inheritsLoose(a,e);var y=a.prototype;return y.destroy=function(){this.removeAllChildren(),this._spriteMosaic&&(this._spriteMosaic.dispose(),this._spriteMosaic=null),this._glyphMosaic&&(this._glyphMosaic.dispose(),this._glyphMosaic=null),s.isSome(this._symbolFader)&&(this._symbolFader.clear(),this._symbolFader=null),this._styleRepository=null,this._backgroundTiles=[],this._pointToCallbacks.clear()},y.setStyleResources=function(e,t,r){if(this._spriteMosaic=e,this._glyphMosaic=t,this._styleRepository=r,s.isNone(this._symbolFader)){const e=new n.SymbolFader(this._styleRepository,this.children);e.on("fade-start",(()=>{this.emit("fade-start"),this.requestRender()})),e.on("fade-complete",(()=>{this.emit("fade-complete"),this.requestRender()})),this._symbolFader=e}s.unwrap(this._symbolFader).styleRepository=r},y.deleteStyleLayers=function(e){s.isSome(this._symbolFader)&&this._symbolFader.deleteStyleLayers(e)},y.hitTest=function(){var e=t._asyncToGenerator((function*(e,t){const s=[e,t],i=r.createResolver();return this._pointToCallbacks.set(s,i),this.requestRender(),i.promise}));function s(t,s){return e.apply(this,arguments)}return s}(),y.enterTileInvalidation=function(){for(const e of this.children)e.invalidating=!0},y.createRenderParams=function(t){return{...e.prototype.createRenderParams.call(this,t),renderPass:null,styleLayer:null,styleLayerUID:-1,glyphMosaic:this._glyphMosaic,spriteMosaic:this._spriteMosaic,hasClipping:!!this._clippingInfos}},y.doRender=function(t){!this.visible||t.drawPhase!==o.WGLDrawPhase.MAP&&t.drawPhase!==o.WGLDrawPhase.DEBUG||void 0===this._spriteMosaic||e.prototype.doRender.call(this,t)},y.addChild=function(t){return e.prototype.addChild.call(this,t),s.isSome(this._symbolFader)?this._symbolFader.addTile(t):t.decluttered=!0,this.requestRender(),t},y.removeChild=function(t){return s.isSome(this._symbolFader)&&this._symbolFader.removeTile(t),this.requestRender(),e.prototype.removeChild.call(this,t)},y.renderChildren=function(t){if(t.drawPhase!==o.WGLDrawPhase.DEBUG){if(this._doRender(t),this._pointToCallbacks.size>0){const{context:e}=t,s=e.getBoundFramebufferObject();t.drawPhase=o.WGLDrawPhase.HITTEST;const r=t.painter.effects.hittest;r.bind(t),this._doRender(t),r.draw(t,this._pointToCallbacks),e.bindFramebuffer(s)}}else e.prototype.renderChildren.call(this,t)},y.removeAllChildren=function(){for(let e=0;e<this.children.length;e++){const t=this.children[e];s.isSome(this._symbolFader)&&this._symbolFader.removeTile(t),t.dispose()}e.prototype.removeAllChildren.call(this)},y.getStencilTarget=function(){return this.children.filter((e=>e.neededForCoverage&&e.hasData()))},y.restartDeclutter=function(){s.isSome(this._symbolFader)&&this._symbolFader.restartDeclutter()},y._doRender=function(t){const{context:s}=t,r=this._styleRepository;if(!r)return;const i=r.layers;let n=!0;t.drawPhase===o.WGLDrawPhase.HITTEST&&(n=!1),r.backgroundBucketIds.length>0&&(t.renderPass="background",this._renderBackgroundLayers(t,r.backgroundBucketIds)),e.prototype.renderChildren.call(this,t),t.drawPhase===o.WGLDrawPhase.MAP&&this._fade(t.displayLevel,t.state);const l=this.children.filter((e=>e.visible&&e.hasData()));if(l&&0!==l.length){for(const e of l)e.triangleCount=0;s.setStencilWriteMask(0),s.setColorMask(!0,!0,!0,!0),s.setStencilOp(7680,7680,7681),s.setStencilTestEnabled(!0),s.setBlendingEnabled(!1),s.setDepthTestEnabled(!0),s.setDepthWriteEnabled(!0),s.setDepthFunction(515),s.setClearDepth(1),s.clear(s.gl.DEPTH_BUFFER_BIT),t.renderPass="opaque";for(let e=i.length-1;e>=0;e--)this._renderStyleLayer(i[e],t,l);s.setDepthWriteEnabled(!1),s.setBlendingEnabled(n),s.setBlendFunctionSeparate(1,771,1,771),t.renderPass="translucent";for(let e=0;e<i.length;e++)this._renderStyleLayer(i[e],t,l);s.setDepthTestEnabled(!1),t.renderPass="symbol";for(let e=0;e<i.length;e++)this._renderStyleLayer(i[e],t,l);s.bindVAO(),s.setStencilTestEnabled(!0),s.setBlendingEnabled(!0)}},y._fade=function(e,t){s.isSome(this._symbolFader)&&(this._symbolFader.update(e,t)||this.requestRender())},y._renderStyleLayer=function(e,t,s){const{painter:r,renderPass:i}=t;if(void 0===e)return;const n=e.getLayoutProperty("visibility");if(n&&1===n.getValue())return;let o;switch(e.type){case 0:return;case 1:if("opaque"!==i&&"translucent"!==t.renderPass)return;o="vtlFill";break;case 2:if("translucent"!==i)return;o="vtlLine";break;case 4:if("symbol"!==i)return;o="vtlCircle";break;case 3:if("symbol"!==i)return;o="vtlSymbol"}if(s=3===e.type?s.filter((e=>e.decluttered)):s.filter((e=>e.neededForCoverage)),"vtlSymbol"!==o){const r=t.displayLevel;if(0===s.length||void 0!==e.minzoom&&e.minzoom>=r+h||void 0!==e.maxzoom&&e.maxzoom<r-h)return}const l=e.uid;t.styleLayerUID=l,t.styleLayer=e;for(const a of s)if(a.layerData.has(l)){r.renderObjects(t,s,o);break}},y._renderBackgroundLayers=function(e,t){const{context:r,displayLevel:n,painter:a,state:h}=e,y=this._styleRepository;let p=!1;for(const s of t)if(u(y.getLayerById(s),n)){p=!0;break}if(!p)return;const f=this._tileInfoView.getTileCoverage(e.state,0,"smallest"),{spans:m,lodInfo:b}=f,{level:_}=b,g=i.create(),T=[];if(this._renderPasses){const t=this._renderPasses[0];s.isSome(this._clippingInfos)&&(t.brushes[0].prepareState(e,this._clippingInfos[0]),t.brushes[0].drawMany(e,this._clippingInfos))}const v=this._backgroundTiles;let F,S=0;for(const{row:s,colFrom:o,colTo:d}of m)for(let e=o;e<=d;e++){if(S<v.length)F=v[S],F.key.set(_,s,b.normalizeCol(e),b.getWorldForColumn(e)),this._tileInfoView.getTileBounds(g,F.key,!1),F.x=g[0],F.y=g[3];else{const t=new c(_,s,b.normalizeCol(e),b.getWorldForColumn(e)),r=this._tileInfoView.getTileBounds(i.create(),t);F=new l.RenderableTile(t,r[0],r[3],512,512,4096,4096),v.push(F)}F.setTransform(h,this._tileInfoView.getTileResolution(F.key)),T.push(F),S++}r.setStencilWriteMask(0),r.setColorMask(!0,!0,!0,!0),r.setStencilOp(7680,7680,7681),r.setStencilFunction(514,0,255);let P=!0;e.drawPhase===o.WGLDrawPhase.HITTEST&&(P=!1),r.setStencilTestEnabled(P);for(const s of t){const t=y.getLayerById(s);u(t,n)&&(e.styleLayerUID=t.uid,e.styleLayer=t,a.renderObjects(e,T,"vtlBackground"))}d.pool.release(f)},a}(a.default);e.VectorTileContainer=y,Object.defineProperty(e,"__esModule",{value:!0})}));
