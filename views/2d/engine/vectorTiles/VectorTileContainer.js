// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../core/maybe","../../../../core/promiseUtils","../../../../geometry/support/aaBoundingRect","./decluttering/debugging","./decluttering/SymbolFader","../webgl/enums","../webgl/TileContainer","../webgl/TiledDisplayObject","../../tiling/TileCoverage","../../tiling/TileKey"],(function(e,t,r,i,s,o,n,a,l,d,h,c,p){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VectorTileContainer=void 0;function u(e,t){if(e){var r=e.getLayoutProperty("visibility");if(!r||"none"!==r.getValue()&&(void 0===e.minzoom||e.minzoom<t+1e-6)&&(void 0===e.maxzoom||e.maxzoom>=t-1e-6))return!0}return!1}var y=function(e){function t(t){var r=e.call(this,t)||this;return r._backgroundTiles=[],r._pointToCallbacks=new Map,r._fading=!1,r}return r.__extends(t,e),t.prototype.destroy=function(){this.removeAllChildren(),this.children.forEach((function(e){return e.destroy()})),this._spriteMosaic&&this._spriteMosaic.dispose(),this._glyphMosaic&&this._glyphMosaic.dispose()},t.prototype.setStyleResources=function(e,t,r){var s=this;if(this._spriteMosaic=e,this._glyphMosaic=t,this._styleRepository=r,i.isNone(this._symbolFader)){var o=new a.SymbolFader(this._styleRepository.layers);o.on("fade-start",(function(){s.emit("fade-start"),s._fading=!0,s.requestRender()})),o.on("fade-complete",(function(){s.emit("fade-complete"),s._fading=!1,s.requestRender()})),this._symbolFader=o}i.unwrap(this._symbolFader).layers=r.layers},t.prototype.hitTest=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var i,o;return r.__generator(this,(function(r){return i=[e,t],o=s.createResolver(),this._pointToCallbacks.set(i,o),this.requestRender(),[2,o.promise]}))}))},t.prototype.enterTileInvalidation=function(){for(var e=0,t=this.children;e<t.length;e++){t[e].invalidating=!0}},t.prototype.createRenderParams=function(t){return r.__assign(r.__assign({},e.prototype.createRenderParams.call(this,t)),{renderPass:null,styleLayer:null,styleLayerId:-1,glyphMosaic:this._glyphMosaic,spriteMosaic:this._spriteMosaic,hasClipping:!!this._clippingInfos})},t.prototype.doRender=function(t){!this.visible||t.drawPhase!==l.WGLDrawPhase.MAP&&t.drawPhase!==l.WGLDrawPhase.DEBUG||void 0===this._spriteMosaic||e.prototype.doRender.call(this,t)},t.prototype.addChild=function(t){return e.prototype.addChild.call(this,t),i.isSome(this._symbolFader)?this._symbolFader.addTile(t):t.decluttered=!0,this.requestRender(),t},t.prototype.removeChild=function(t){return i.isSome(this._symbolFader)&&this._symbolFader.removeTile(t),this.requestRender(),e.prototype.removeChild.call(this,t)},t.prototype.renderChildren=function(t){if(t.drawPhase!==l.WGLDrawPhase.DEBUG){if(this._doRender(t),this._pointToCallbacks.size>0){var r=t.context,i=r.getBoundFramebufferObject();t.drawPhase=l.WGLDrawPhase.HITTEST;var s=t.painter.effects.hittest;s.bind(t),this._doRender(t),s.draw(t,this._pointToCallbacks,6),r.bindFramebuffer(i)}}else e.prototype.renderChildren.call(this,t)},t.prototype.removeAllChildren=function(){for(var t=0;t<this.children.length;t++){var r=this.children[t];i.isSome(this._symbolFader)&&this._symbolFader.removeTile(r),r.dispose()}e.prototype.removeAllChildren.call(this)},t.prototype.getStencilTarget=function(){return this.children.filter((function(e){return e.neededForCoverage}))},t.prototype.restartDeclutter=function(){i.isSome(this._symbolFader)&&this._symbolFader.restartDeclutter()},t.prototype._doRender=function(t){var r,s,o,a=t.context,d=this._styleRepository,h=d.layers,c=!0;t.drawPhase===l.WGLDrawPhase.HITTEST&&(c=!1),d.backgroundBucketIds.length>0&&(t.renderPass="background",this._renderBackgroundLayers(t,d.backgroundBucketIds)),e.prototype.renderChildren.call(this,t);var p=this.children.filter((function(e){return e.visible}));if(p&&0!==p.length){for(var u=0,y=p;u<y.length;u++){y[u].triangleCount=0}a.setStencilWriteMask(0),a.setColorMask(!0,!0,!0,!0),a.setStencilOp(7680,7680,7681),a.setStencilTestEnabled(!0),a.setBlendingEnabled(!1),a.setDepthTestEnabled(!0),a.setDepthWriteEnabled(!0),a.setDepthFunction(515),a.setClearDepth(1),a.clear(a.gl.DEPTH_BUFFER_BIT),t.renderPass="opaque";for(var f=h.length-1;f>=0;f--)this._renderStyleLayer(f,t,p);a.setDepthWriteEnabled(!1),a.setBlendingEnabled(c),a.setBlendFunctionSeparate(1,771,1,771),t.renderPass="translucent";for(f=0;f<h.length;f++)this._renderStyleLayer(f,t,p);a.setDepthTestEnabled(!1),t.renderPass="symbol";for(f=0;f<h.length;f++)this._renderStyleLayer(f,t,p);if(a.bindVAO(),a.setStencilTestEnabled(!0),a.setBlendingEnabled(!0),t.drawPhase===l.WGLDrawPhase.MAP){this._fade(t.displayLevel,t.state);var _=window.COLLISION_DEBUG_CTX;if(_&&i.isSome(this._symbolFader)&&(_.clearRect(0,0,_.canvas.width,_.canvas.height),!this._fading||window.COLLISION_XRAY))for(var v=function(e){if(e.symbols){var t=[];if(e.symbols.forEach((function(e){t.push.apply(t,e)})),window.COLLISION_SHOW_GRID){var i=null===(o=null===(s=null===(r=g._symbolFader)||void 0===r?void 0:r._symbolDeclutterer)||void 0===s?void 0:s._collisionJob)||void 0===o?void 0:o._gridIndex;i&&n.drawGridIndex(_,i)}n.drawColliders(_,t)}},g=this,m=0,b=this.children;m<b.length;m++){v(b[m])}}}},t.prototype._fade=function(e,t){i.isSome(this._symbolFader)&&(this._symbolFader.update(e,t)||this.requestRender())},t.prototype._renderStyleLayer=function(e,t,r){var i=t.painter,s=t.renderPass,o=this._styleRepository.layers[e];if(void 0!==o){var n;switch(o.type){case 0:return;case 1:if("opaque"!==s&&"translucent"!==t.renderPass)return;n="vtlFill";break;case 2:if("translucent"!==s)return;n="vtlLine";break;case 4:if("symbol"!==s)return;n="vtlCircle";break;case 3:if("symbol"!==s)return;n="vtlSymbol"}if(r=3===o.type?r.filter((function(e){return e.decluttered})):r.filter((function(e){return e.neededForCoverage})),"vtlSymbol"!==n){var a=t.displayLevel;if(0===r.length||void 0!==o.minzoom&&o.minzoom>=a+1e-6||void 0!==o.maxzoom&&o.maxzoom<a-1e-6)return}t.styleLayerId=e,t.styleLayer=o;for(var l=0,d=r;l<d.length;l++){if(d[l].layerData[e]){i.renderObjects(t,r,n);break}}}},t.prototype._renderBackgroundLayers=function(e,t){for(var r=e.context,s=e.displayLevel,n=e.painter,a=e.state,d=this._styleRepository,y=!1,f=0,_=t;f<_.length;f++){var v=_[f];if(u(d.layers[v],s)){y=!0;break}}if(y){var g=this._tileInfoView.getTileCoverage(e.state,0,"smallest"),m=g.spans,b=g.lodInfo,T=b.level,w=o.create(),C=[];if(this._renderPasses){var S=this._renderPasses[0];i.isSome(this._clippingInfos)&&(S.brushes[0].prepareState(e,this._clippingInfos[0]),S.brushes[0].drawMany(e,this._clippingInfos))}for(var F,L=this._backgroundTiles,P=0,I=0,k=m;I<k.length;I++)for(var R=k[I],D=R.row,E=R.colFrom,M=R.colTo,B=E;B<=M;B++){if(P<L.length)(F=L[P]).key.set(T,D,b.normalizeCol(B),b.getWorldForColumn(B)),this._tileInfoView.getTileBounds(w,F.key,!1),F.bounds=w,F.coords[0]=w[0],F.coords[1]=w[3];else{var O=new p(T,D,b.normalizeCol(B),b.getWorldForColumn(B));F=new h.TiledDisplayObject(O,this._tileInfoView.getTileBounds(o.create(),O),[512,512],[4096,4096]),L.push(F)}F.setTransform(a,this._tileInfoView.getTileResolution(F.key)),C.push(F),P++}r.setStencilWriteMask(0),r.setColorMask(!0,!0,!0,!0),r.setStencilOp(7680,7680,7681),r.setStencilFunction(514,0,255);var W=!0;e.drawPhase===l.WGLDrawPhase.HITTEST&&(W=!1),r.setStencilTestEnabled(W);for(var G=0,x=t;G<x.length;G++){v=x[G];var z=d.layers[v];u(z,s)&&(e.styleLayerId=v,e.styleLayer=z,n.renderObjects(e,C,"vtlBackground"))}c.pool.release(g)}},t}(d.default);t.VectorTileContainer=y}));