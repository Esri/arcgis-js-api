/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/promiseUtils","../../../../geometry/support/aaBoundingRect","./decluttering/SymbolFader","./style/StyleDefinition","../webgl/enums","../webgl/RenderableTile","../webgl/TileContainer","../../tiling/TileCoverage","../../tiling/TileKey","../../../webgl/enums"],(function(e,t,s,i,r,n,o,l,a,d,c,h,y){"use strict";const p=1e-6;function u(e,t){if(e){const s=e.getLayoutProperty("visibility");if(!s||s.getValue()!==o.Visibility.NONE&&(void 0===e.minzoom||e.minzoom<t+p)&&(void 0===e.maxzoom||e.maxzoom>=t-p))return!0}return!1}let f=function(e){function d(t){var s;return(s=e.call(this,t)||this)._backgroundTiles=[],s._pointToCallbacks=new Map,s}t._inheritsLoose(d,e);var f=d.prototype;return f.destroy=function(){this.removeAllChildren(),this._spriteMosaic&&(this._spriteMosaic.dispose(),this._spriteMosaic=null),this._glyphMosaic&&(this._glyphMosaic.dispose(),this._glyphMosaic=null),s.isSome(this._symbolFader)&&(this._symbolFader.clear(),this._symbolFader=null),this._styleRepository=null,this._backgroundTiles=[],this._pointToCallbacks.clear()},f.setStyleResources=function(e,t,i){if(this._spriteMosaic=e,this._glyphMosaic=t,this._styleRepository=i,s.isNone(this._symbolFader)){const e=new n.SymbolFader(this._styleRepository,this.children);e.on("fade-start",(()=>{this.emit("fade-start"),this.requestRender()})),e.on("fade-complete",(()=>{this.emit("fade-complete"),this.requestRender()})),this._symbolFader=e}s.unwrap(this._symbolFader).styleRepository=i},f.setSpriteMosaic=function(e){this._spriteMosaic.dispose(),this._spriteMosaic=e},f.deleteStyleLayers=function(e){s.isSome(this._symbolFader)&&this._symbolFader.deleteStyleLayers(e)},f.hitTest=function(){var e=t._asyncToGenerator((function*(e){const t=i.createResolver();return this._pointToCallbacks.set(e,t),this.requestRender(),t.promise}));function s(t){return e.apply(this,arguments)}return s}(),f.enterTileInvalidation=function(){for(const e of this.children)e.invalidating=!0},f.createRenderParams=function(t){return{...e.prototype.createRenderParams.call(this,t),renderPass:null,styleLayer:null,styleLayerUID:-1,glyphMosaic:this._glyphMosaic,spriteMosaic:this._spriteMosaic,hasClipping:!!this._clippingInfos}},f.doRender=function(t){!this.visible||t.drawPhase!==l.WGLDrawPhase.MAP&&t.drawPhase!==l.WGLDrawPhase.DEBUG||void 0===this._spriteMosaic||e.prototype.doRender.call(this,t)},f.addChild=function(t){return e.prototype.addChild.call(this,t),s.isSome(this._symbolFader)?this._symbolFader.addTile(t):t.decluttered=!0,this.requestRender(),t},f.removeChild=function(t){return s.isSome(this._symbolFader)&&this._symbolFader.removeTile(t),this.requestRender(),e.prototype.removeChild.call(this,t)},f.renderChildren=function(t){const{drawPhase:s}=t;if(s!==l.WGLDrawPhase.DEBUG){if(this._doRender(t),this._pointToCallbacks.size>0){t.drawPhase=l.WGLDrawPhase.HITTEST;const e=t.painter.effects.hittestVTL;e.bind(t),this._doRender(t),e.draw(t,this._pointToCallbacks),e.unbind(t),t.drawPhase=s}}else e.prototype.renderChildren.call(this,t)},f.removeAllChildren=function(){for(let e=0;e<this.children.length;e++){const t=this.children[e];s.isSome(this._symbolFader)&&this._symbolFader.removeTile(t),t.dispose()}e.prototype.removeAllChildren.call(this)},f.getStencilTarget=function(){return this.children.filter((e=>e.neededForCoverage&&e.hasData()))},f.restartDeclutter=function(){s.isSome(this._symbolFader)&&this._symbolFader.restartDeclutter()},f._doRender=function(t){const{context:s}=t,i=this._styleRepository;if(!i)return;const r=i.layers;let n=!0;t.drawPhase===l.WGLDrawPhase.HITTEST&&(n=!1),i.backgroundBucketIds.length>0&&(t.renderPass="background",this._renderBackgroundLayers(t,i.backgroundBucketIds)),e.prototype.renderChildren.call(this,t),t.drawPhase===l.WGLDrawPhase.MAP&&this._fade(t.displayLevel,t.state);const o=this.children.filter((e=>e.visible&&e.hasData()));if(!o||0===o.length)return s.bindVAO(),s.setStencilTestEnabled(!0),void s.setBlendingEnabled(!0);for(const e of o)e.triangleCount=0;s.setStencilWriteMask(0),s.setColorMask(!0,!0,!0,!0),s.setStencilOp(y.StencilOperation.KEEP,y.StencilOperation.KEEP,y.StencilOperation.REPLACE),s.setStencilTestEnabled(!0),s.setBlendingEnabled(!1),s.setDepthTestEnabled(!0),s.setDepthWriteEnabled(!0),s.setDepthFunction(y.CompareFunction.LEQUAL),s.setClearDepth(1),s.clear(s.gl.DEPTH_BUFFER_BIT),t.renderPass="opaque";for(let e=r.length-1;e>=0;e--)this._renderStyleLayer(r[e],t,o);s.setDepthWriteEnabled(!1),s.setBlendingEnabled(n),s.setBlendFunctionSeparate(y.BlendFactor.ONE,y.BlendFactor.ONE_MINUS_SRC_ALPHA,y.BlendFactor.ONE,y.BlendFactor.ONE_MINUS_SRC_ALPHA),t.renderPass="translucent";for(let e=0;e<r.length;e++)this._renderStyleLayer(r[e],t,o);s.setDepthTestEnabled(!1),t.renderPass="symbol";for(let e=0;e<r.length;e++)this._renderStyleLayer(r[e],t,o);s.bindVAO(),s.setStencilTestEnabled(!0),s.setBlendingEnabled(!0)},f._fade=function(e,t){s.isSome(this._symbolFader)&&(this._symbolFader.update(e,t)||this.requestRender())},f._renderStyleLayer=function(e,t,s){const{painter:i,renderPass:r}=t;if(void 0===e)return;const n=e.getLayoutProperty("visibility");if(n&&n.getValue()===o.Visibility.NONE)return;let l;switch(e.type){case o.StyleLayerType.BACKGROUND:return;case o.StyleLayerType.FILL:if("opaque"!==r&&"translucent"!==t.renderPass)return;l="vtlFill";break;case o.StyleLayerType.LINE:if("translucent"!==r)return;l="vtlLine";break;case o.StyleLayerType.CIRCLE:if("symbol"!==r)return;l="vtlCircle";break;case o.StyleLayerType.SYMBOL:if("symbol"!==r)return;l="vtlSymbol"}if(s=e.type===o.StyleLayerType.SYMBOL?s.filter((e=>e.decluttered)):s.filter((e=>e.neededForCoverage)),"vtlSymbol"!==l){const i=t.displayLevel;if(0===s.length||void 0!==e.minzoom&&e.minzoom>=i+p||void 0!==e.maxzoom&&e.maxzoom<i-p)return}const a=e.uid;t.styleLayerUID=a,t.styleLayer=e;for(const o of s)if(o.layerData.has(a)){i.renderObjects(t,s,l);break}},f._renderBackgroundLayers=function(e,t){const{context:i,displayLevel:n,painter:d,state:p}=e,f=this._styleRepository;let m=!1;for(const s of t){if(f.getLayerById(s).type===o.StyleLayerType.BACKGROUND&&u(f.getLayerById(s),n)){m=!0;break}}if(!m)return;const _=this._tileInfoView.getTileCoverage(e.state,0,"smallest"),{spans:b,lodInfo:g}=_,{level:S}=g,T=r.create(),L=[];if(this._renderPasses){const t=this._renderPasses[0];s.isSome(this._clippingInfos)&&(t.brushes[0].prepareState(e,this._clippingInfos[0]),t.brushes[0].drawMany(e,this._clippingInfos))}const C=this._backgroundTiles;let E,P=0;for(const{row:s,colFrom:o,colTo:l}of b)for(let e=o;e<=l;e++){if(P<C.length)E=C[P],E.key.set(S,s,g.normalizeCol(e),g.getWorldForColumn(e)),this._tileInfoView.getTileBounds(T,E.key,!1),E.x=T[0],E.y=T[3];else{const t=new h(S,s,g.normalizeCol(e),g.getWorldForColumn(e)),i=this._tileInfoView.getTileBounds(r.create(),t);E=new a.RenderableTile(t,i[0],i[3],512,512,4096,4096),C.push(E)}E.setTransform(p,this._tileInfoView.getTileResolution(E.key)),L.push(E),P++}i.setStencilWriteMask(0),i.setColorMask(!0,!0,!0,!0),i.setStencilOp(y.StencilOperation.KEEP,y.StencilOperation.KEEP,y.StencilOperation.REPLACE),i.setStencilFunction(y.CompareFunction.EQUAL,0,255);let v=!0;e.drawPhase===l.WGLDrawPhase.HITTEST&&(v=!1),i.setStencilTestEnabled(v);for(const s of t){const t=f.getLayerById(s);t.type===o.StyleLayerType.BACKGROUND&&u(t,n)&&(e.styleLayerUID=t.uid,e.styleLayer=t,d.renderObjects(e,L,"vtlBackground"))}c.pool.release(_)},d}(d.default);e.VectorTileContainer=f,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
