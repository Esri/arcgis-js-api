// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../core/ArrayPool","../../../../core/libs/earcut/earcut","./BaseBucket","../webgl/Geometry"],(function(e,t,r,i,n,a,l){"use strict";return function(e){function t(t,r,i,n,a,l){var o=e.call(this,t,r)||this;if(o.type=1,t.hasDataDrivenFill!==i.isDataDriven())throw new Error("incompatible fill buffer");if(t.hasDataDrivenOutline!==a.isDataDriven())throw new Error("incompatible outline buffer");return o._fillVertexBuffer=i,o._fillIndexBuffer=n,o._outlineVertexBuffer=a,o._outlineIndexBuffer=l,o}return r.__extends(t,e),Object.defineProperty(t.prototype,"fillIndexStart",{get:function(){return this._fillIndexStart},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"fillIndexCount",{get:function(){return this._fillIndexCount},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"outlineIndexStart",{get:function(){return this._outlineIndexStart},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"outlineIndexCount",{get:function(){return this._outlineIndexCount},enumerable:!1,configurable:!0}),t.prototype.processFeatures=function(e){this._fillIndexStart=3*this._fillIndexBuffer.index,this._fillIndexCount=0,this._outlineIndexStart=3*this._outlineIndexBuffer.index,this._outlineIndexCount=0;var t=this.layer,r=this.zoom,i=t.hasDataDrivenFill,n=t.hasDataDrivenOutline;e&&e.setExtent(this.layerExtent);var a=t.getPaintValue("fill-pattern",r),l=t.getPaintValue("fill-antialias",r)&&void 0===a,o=[1,1,1,1],f=[1,1,1,1],u=1;if(t.outlineUsesFillColor){if(l&&!t.hasDataDrivenOpacity){var s=t.getPaintValue("fill-opacity",r),d=t.getPaintValue("fill-opacity",r+1);s<1&&d<1&&(l=!1)}if(l&&!t.hasDataDrivenColor){var h=t.getPaintValue("fill-color",r),x=t.getPaintValue("fill-color",r+1);h[3]<1&&x[3]<1&&(l=!1)}}for(var y=0,c=this._features;y<c.length;y++){var _=c[y];!a&&t.hasDataDrivenColor&&(o=t.getPaintValue("fill-color",r,_)),t.hasDataDrivenOpacity&&(u=t.getPaintValue("fill-opacity",r,_)),!a&&t.hasDataDrivenOutlineColor&&(f=t.getPaintValue("fill-outline-color",r,_));var v=void 0;i&&(v={color:o,opacity:u});var p=void 0;n&&(p={color:t.outlineUsesFillColor?o:f,opacity:u});var g=_.getGeometry(e);this._processFeature(g,l,t.outlineUsesFillColor,v,p)}},t.prototype.serialize=function(){var e=12;e+=this.layerIndices.length,e+=this._fillVertexBuffer.array.length,e+=this._fillIndexBuffer.array.length,e+=this._outlineVertexBuffer.array.length,e+=this._outlineIndexBuffer.array.length;var t=0,r=new Uint32Array(e),i=new Int32Array(r.buffer);r[t++]=this.type,r[t++]=this.layerIndices.length;for(var n=0;n<this.layerIndices.length;n++)r[t++]=this.layerIndices[n];r[t++]=this._fillIndexStart,r[t++]=this._fillIndexCount,r[t++]=this._outlineIndexStart,r[t++]=this._outlineIndexCount,r[t++]=this._fillVertexBuffer.isDataDriven()?1:0,r[t++]=this._outlineVertexBuffer.isDataDriven()?1:0,r[t++]=this._fillVertexBuffer.array.length;for(var a=0;a<this._fillVertexBuffer.array.length;a++)i[t++]=this._fillVertexBuffer.array[a];r[t++]=this._fillIndexBuffer.array.length;for(var l=0;l<this._fillIndexBuffer.array.length;l++)r[t++]=this._fillIndexBuffer.array[l];r[t++]=this._outlineVertexBuffer.array.length;for(var o=0;o<this._outlineVertexBuffer.array.length;o++)i[t++]=this._outlineVertexBuffer.array[o];r[t++]=this._outlineIndexBuffer.array.length;for(var f=0;f<this._outlineIndexBuffer.array.length;f++)r[t++]=this._outlineIndexBuffer.array[f];return r.buffer},t.prototype._processFeature=function(e,r,i,n,a){if(e){var l=e.length;if(r&&(!i||!a||a.color[3]*a.opacity==1))for(var o=0;o<l;o++)this._processOutline(e[o],a);var f;for(o=0;o<l;o++){var u=t._area(e[o]);u>128?(void 0!==f&&this._processFill(e,f,n),f=[o]):u<-128&&void 0!==f&&f.push(o)}void 0!==f&&this._processFill(e,f,n)}},t.prototype._processOutline=function(e,t){var r,i,n,a=this._outlineVertexBuffer,o=this._outlineIndexBuffer,f=o.index,u=new l.Point(0,0),s=new l.Point(0,0),d=new l.Point(0,0),h=-1,x=-1,y=-1,c=-1,_=-1,v=!1,p=e.length;if(!(p<2)){for(var g=e[0],I=e[p-1];p&&I.isEqual(g);)I=e[--p-1];if(!(p-0<2)){for(var B=0;B<p;++B){0===B?(r=e[p-1],i=e[0],n=e[1],u.assignSub(i,r),u.normalize(),u.rightPerpendicular()):(r=i,i=n,n=B!==p-1?e[B+1]:e[0],u.assign(s));var D=this._isClipEdge(r,i);-1===c&&(v=D),s.assignSub(n,i),s.normalize(),s.rightPerpendicular();var b=u.x*s.y-u.y*s.x;d.assignAdd(u,s),d.normalize();var V=-d.x*-u.x+-d.y*-u.y,P=Math.abs(0!==V?1/V:1);P>8&&(P=8),b>=0?(y=a.add(i.x,i.y,u.x,u.y,0,1,t),-1===c&&(c=y),h>=0&&x>=0&&y>=0&&!D&&o.add(h,x,y),x=a.add(i.x,i.y,P*-d.x,P*-d.y,0,-1,t),-1===_&&(_=x),h>=0&&x>=0&&y>=0&&!D&&o.add(h,x,y),h=x,x=y,y=a.add(i.x,i.y,d.x,d.y,0,1,t),h>=0&&x>=0&&y>=0&&!D&&o.add(h,x,y),x=a.add(i.x,i.y,s.x,s.y,0,1,t),h>=0&&x>=0&&y>=0&&!D&&o.add(h,x,y)):(y=a.add(i.x,i.y,P*d.x,P*d.y,0,1,t),-1===c&&(c=y),h>=0&&x>=0&&y>=0&&!D&&o.add(h,x,y),x=a.add(i.x,i.y,-u.x,-u.y,0,-1,t),-1===_&&(_=x),h>=0&&x>=0&&y>=0&&!D&&o.add(h,x,y),h=x,x=y,y=a.add(i.x,i.y,-d.x,-d.y,0,-1,t),h>=0&&x>=0&&y>=0&&!D&&o.add(h,x,y),(h=a.add(i.x,i.y,-s.x,-s.y,0,-1,t))>=0&&x>=0&&y>=0&&!D&&o.add(h,x,y))}h>=0&&x>=0&&c>=0&&!v&&o.add(h,x,c),h>=0&&c>=0&&_>=0&&!v&&o.add(h,_,c),this._outlineIndexCount+=3*(o.index-f)}}},t.prototype._processFill=function(e,t,r){var a;t.length>1&&(a=[]);for(var l=0,o=0,f=t;o<f.length;o++){var u=f[o];0!==l&&a.push(l),l+=e[u].length}for(var s=2*l,d=i.acquire(),h=0,x=t;h<x.length;h++)for(var y=e[u=x[h]],c=y.length,_=0;_<c;++_)d.push(y[_].x),d.push(y[_].y);var v=n.earcut(d,a,2),p=v.length;if(p>0){for(var g=this._fillVertexBuffer.index,I=0;I<s;)this._fillVertexBuffer.add(d[I++],d[I++],r);for(var B=0;B<p;)this._fillIndexBuffer.add(g+v[B++],g+v[B++],g+v[B++]);this._fillIndexCount+=p}i.release(d)},t.prototype._isClipEdge=function(e,t){return e.x===t.x?e.x<=-64||e.x>=4160:e.y===t.y&&(e.y<=-64||e.y>=4160)},t._area=function(e){for(var t=0,r=e.length-1,i=0;i<r;i++)t+=(e[i].x-e[i+1].x)*(e[i].y+e[i+1].y);return.5*(t+=(e[r].x-e[0].x)*(e[r].y+e[0].y))},t}(a)}));