// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/ArrayPool","../../../../core/libs/earcut/earcut","./Bucket","../webgl/Geometry"],(function(e,t,i,r,n,a,l){return function(e){function t(t,i,r,n,a,l){var o=e.call(this,t,i)||this;if(t.hasDataDrivenFill!==r.isDataDriven())throw new Error("incompatible fill buffer");if(t.hasDataDrivenOutline!==a.isDataDriven())throw new Error("incompatible outline buffer");return o._fillVertexBuffer=r,o._fillIndexBuffer=n,o._outlineVertexBuffer=a,o._outlineIndexBuffer=l,o}return i(t,e),Object.defineProperty(t.prototype,"fillIndexStart",{get:function(){return this._fillIndexStart},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"fillIndexCount",{get:function(){return this._fillIndexCount},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"outlineIndexStart",{get:function(){return this._outlineIndexStart},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"outlineIndexCount",{get:function(){return this._outlineIndexCount},enumerable:!0,configurable:!0}),t.prototype.assignBufferInfo=function(e){var t=e;t._fillIndexStart=this._fillIndexStart,t._fillIndexCount=this._fillIndexCount,e.layer.getPaintProperty("fill-outline-color")?(t._outlineIndexStart=this._outlineIndexStart,t._outlineIndexCount=this._outlineIndexCount):(t._outlineIndexStart=0,t._outlineIndexCount=0)},t.prototype.processFeatures=function(e){this._fillIndexStart=this._fillIndexBuffer.index,this._fillIndexCount=0,this._outlineIndexStart=this._outlineIndexBuffer.index,this._outlineIndexCount=0;var t=this.layer,i=this.zoom,r=t.hasDataDrivenFill,n=t.hasDataDrivenOutline;e&&e.setExtent(this.layerExtent);var a=t.getPaintValue("fill-pattern",i),l=t.getPaintValue("fill-antialias",i)&&void 0===a,o=[1,1,1,1],u=[1,1,1,1],f=1;if(t.outlineUsesFillColor){if(l&&!t.hasDataDrivenOpacity){var d=t.getPaintValue("fill-opacity",i),s=t.getPaintValue("fill-opacity",i+1);d<1&&s<1&&(l=!1)}if(l&&!t.hasDataDrivenColor){var x=t.getPaintValue("fill-color",i),h=t.getPaintValue("fill-color",i+1);x[3]<1&&h[3]<1&&(l=!1)}}for(var c=0,y=this._features;c<y.length;c++){var p=y[c];!a&&t.hasDataDrivenColor&&(o=t.getPaintValue("fill-color",i,p)),t.hasDataDrivenOpacity&&(f=t.getPaintValue("fill-opacity",i,p)),!a&&t.hasDataDrivenOutlineColor&&(u=t.getPaintValue("fill-outline-color",i,p));var v=void 0;r&&(v={color:o,opacity:f});var _=void 0;n&&(_={color:t.outlineUsesFillColor?o:u,opacity:f});var g=p.getGeometry(e);this._processFeature(g,l,t.outlineUsesFillColor,v,_)}},t.prototype._processFeature=function(e,i,r,n,a){if(e){var l=e.length;if(i&&(!r||!a||a.color[3]*a.opacity==1))for(var o=0;o<l;o++)this._processOutline(e[o],a);var u;for(o=0;o<l;o++){var f=t._area(e[o]);f>128?(void 0!==u&&this._processFill(e,u,n),u=[o]):f<-128&&void 0!==u&&u.push(o)}void 0!==u&&this._processFill(e,u,n)}},t.prototype._processOutline=function(e,t){var i,r,n,a=this._outlineVertexBuffer,o=this._outlineIndexBuffer,u=o.index,f=new l.Point(0,0),d=new l.Point(0,0),s=new l.Point(0,0),x=-1,h=-1,c=-1,y=-1,p=-1,v=!1,_=e.length;if(!(_<2)){for(var g=e[0],I=e[_-1];_&&I.isEqual(g);)I=e[--_-1];if(!(_-0<2)){for(var D=0;D<_;++D){0===D?(i=e[_-1],r=e[0],n=e[1],f.assignSub(r,i),f.normalize(),f.rightPerpendicular()):(i=r,r=n,n=D!==_-1?e[D+1]:e[0],f.assign(d));var b=this._isClipEdge(i,r);-1===y&&(v=b),d.assignSub(n,r),d.normalize(),d.rightPerpendicular();var C=f.x*d.y-f.y*d.x;s.assignAdd(f,d),s.normalize();var P=-s.x*-f.x+-s.y*-f.y,S=Math.abs(0!==P?1/P:1);S>8&&(S=8),C>=0?(c=a.add(r.x,r.y,f.x,f.y,0,1,t),-1===y&&(y=c),x>=0&&h>=0&&c>=0&&!b&&o.add(x,h,c),h=a.add(r.x,r.y,S*-s.x,S*-s.y,0,-1,t),-1===p&&(p=h),x>=0&&h>=0&&c>=0&&!b&&o.add(x,h,c),x=h,h=c,c=a.add(r.x,r.y,s.x,s.y,0,1,t),x>=0&&h>=0&&c>=0&&!b&&o.add(x,h,c),h=a.add(r.x,r.y,d.x,d.y,0,1,t),x>=0&&h>=0&&c>=0&&!b&&o.add(x,h,c)):(c=a.add(r.x,r.y,S*s.x,S*s.y,0,1,t),-1===y&&(y=c),x>=0&&h>=0&&c>=0&&!b&&o.add(x,h,c),h=a.add(r.x,r.y,-f.x,-f.y,0,-1,t),-1===p&&(p=h),x>=0&&h>=0&&c>=0&&!b&&o.add(x,h,c),x=h,h=c,c=a.add(r.x,r.y,-s.x,-s.y,0,-1,t),x>=0&&h>=0&&c>=0&&!b&&o.add(x,h,c),(x=a.add(r.x,r.y,-d.x,-d.y,0,-1,t))>=0&&h>=0&&c>=0&&!b&&o.add(x,h,c))}x>=0&&h>=0&&y>=0&&!v&&o.add(x,h,y),x>=0&&y>=0&&p>=0&&!v&&o.add(x,p,y),this._outlineIndexCount+=3*(o.index-u)}}},t.prototype._processFill=function(e,t,i){var a;t.length>1&&(a=[]);for(var l=0,o=0,u=t;o<u.length;o++){var f=u[o];0!==l&&a.push(l),l+=e[f].length}for(var d=2*l,s=r.acquire(),x=0,h=t;x<h.length;x++)for(var c=e[f=h[x]],y=c.length,p=0;p<y;++p)s.push(c[p].x),s.push(c[p].y);var v=n.earcut(s,a,2),_=v.length;if(_>0){for(var g=this._fillVertexBuffer.index,I=0;I<d;)this._fillVertexBuffer.add(s[I++],s[I++],i);for(var D=0;D<_;)this._fillIndexBuffer.add(g+v[D++],g+v[D++],g+v[D++]);this._fillIndexCount+=_}r.release(s)},t.prototype._isClipEdge=function(e,t){return e.x===t.x?e.x<=-64||e.x>=4160:e.y===t.y&&(e.y<=-64||e.y>=4160)},t._area=function(e){for(var t=0,i=e.length-1,r=0;r<i;r++)t+=(e[r].x-e[r+1].x)*(e[r].y+e[r+1].y);return.5*(t+=(e[i].x-e[0].x)*(e[i].y+e[0].y))},t}(a)}));