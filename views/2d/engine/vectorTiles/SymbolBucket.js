// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../core/BidiEngine","../../../../core/string","./BaseBucket","./GeometryUtils","./Placement","./TextShaping","./style/StyleLayer","../webgl/Geometry"],(function(e,t,a,i,r,n,o,s,l,h,x){"use strict";function c(e,t){return e.iconMosaicItem&&t.iconMosaicItem?e.iconMosaicItem.page===t.iconMosaicItem.page?0:e.iconMosaicItem.page-t.iconMosaicItem.page:e.iconMosaicItem&&!t.iconMosaicItem?1:!e.iconMosaicItem&&t.iconMosaicItem?-1:0}return function(e){function t(t,a,i,r,n,o,s,l){var h=e.call(this,t,a)||this;if(h.type=3,h._markerMap=new Map,h._glyphMap=new Map,h._glyphBufferDataStorage=new Map,h._isIconSDF=!1,t.hasDataDrivenIcon!==i.isDataDriven())throw new Error("incompatible icon buffer");if(t.hasDataDrivenText!==n.isDataDriven())throw new Error("incompatible text buffer");return h._iconVertexBuffer=i,h._iconIndexBuffer=r,h._textVertexBuffer=n,h._textIndexBuffer=o,h._placementEngine=s,h._workerTileHandler=l,h}return a.__extends(t,e),Object.defineProperty(t.prototype,"markerPageMap",{get:function(){return this._markerMap},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"glyphsPageMap",{get:function(){return this._glyphMap},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"symbolInstances",{get:function(){return this._symbolInstances},enumerable:!1,configurable:!0}),t.prototype.getResources=function(e,a,i){var n=this.layer,o=this.zoom,s=n.hasDataDrivenIcon,l=n.hasDataDrivenText;e&&e.setExtent(this.layerExtent);for(var h,x,c,g,d,y,f,u,m,p=n.getLayoutProperty("icon-image"),v=n.getLayoutProperty("text-field"),_=[],I=[1,1,1,1],P=1,b=1,M=[1,1,1,1],L=1,V=1,A=0,D=this._features;A<D.length;A++){var w=D[A],S=w.getGeometry(e);if(S&&0!==S.length){var z=void 0;p&&(z=n.getLayoutValue("icon-image",o,w),p.isDataDriven||(z=this._replaceKeys(z,w.values)),z&&(a.add(z),h=n.getLayoutValue("icon-rotate",o,w),x=n.getLayoutValue("icon-offset",o,w)));var B=void 0,E=!1;if(v&&((B=n.getLayoutValue("text-field",o,w))&&!v.isDataDriven&&(B=this._replaceKeys(B,w.values)),B)){switch(B=B.replace(/\\n/g,"\n"),n.getLayoutValue("text-transform",o,w)){case 2:B=B.toLowerCase();break;case 1:B=B.toUpperCase()}if(t._bidiEngine.hasBidiChar(B)){var C=void 0;C="rtl"===t._bidiEngine.checkContextual(B)?"IDNNN":"ICNNN",B=t._bidiEngine.bidiTransform(B,C,"VLYSN"),E=!0}var T=B.length;if(T>0){for(var R=0,k=m=n.getLayoutValue("text-font",o,w);R<k.length;R++){var F=k[R],O=i[F];O||(O=i[F]=new Set);for(var G=0;G<T;G++){var N=B.charCodeAt(G);O.add(N)}}c=n.getLayoutValue("text-rotate",o,w),g=n.getLayoutValue("text-anchor",o,w),d=n.getLayoutValue("text-offset",o,w),y=n.getLayoutValue("text-justify",o,w),f=n.getLayoutValue("text-letter-spacing",o,w),u=n.getLayoutValue("text-max-width",o,w)}}if(z||B){var H=n.getLayoutValue("icon-size",o,w),Z=n.getLayoutValue("text-size",o,w);n.hasDataDrivenIconColor&&(I=n.getPaintValue("icon-color",o,w)),n.hasDataDrivenIconOpacity&&(P=n.getPaintValue("icon-opacity",o,w)),n.hasDataDrivenIconSize&&(b=H),n.hasDataDrivenTextColor&&(M=n.getPaintValue("text-color",o,w)),n.hasDataDrivenTextOpacity&&(L=n.getPaintValue("text-opacity",o,w)),n.hasDataDrivenTextSize&&(V=Z);var j=n.getLayoutValue("symbol-sort-key",o,w),Y={sprite:z,label:B,rtl:E,type:w.type,geometry:S,hash:(B?r.numericHash(B):0)^(z?r.numericHash(z):0),priority:j,iconSize:H,iconRotate:h,ddIconValues:s?{color:I,opacity:P,size:b}:null,iconOffset:x,textSize:Z,textRotate:c,ddTextValues:l?{color:M,opacity:L,size:V}:null,textAnchor:g,textOffset:d,textJustify:y,textLetterSpacing:f,textMaxWidth:u,textFontArray:m};_.push(Y)}}}this._symbolFeatures=_},t.prototype.processFeatures=function(e){e&&e.setExtent(this.layerExtent);var a,i=this.layer,r=this.zoom,n=1===i.getLayoutValue("symbol-placement",r),x=i.getLayoutValue("symbol-spacing",r)*s.TILE_PIXEL_RATIO,g=i.getLayoutProperty("icon-image"),d=i.getLayoutProperty("text-field"),y=g?new h.IconLayout(i,r,n):null,f=d?new h.TextLayout(i,r,n):null,u=this._workerTileHandler;g&&(a=u.getSpriteItems()),this._iconIndexStart=3*this._iconIndexBuffer.index,this._textIndexStart=3*this._textIndexBuffer.index,this._iconIndexCount=0,this._textIndexCount=0,this._markerMap.clear(),this._glyphMap.clear();var m=[],p=1;f&&f.size&&(p=f.size/l.SDF_GLYPH_SIZE);for(var v=f?f.maxAngle*o.C_DEG_TO_RAD:0,_=f?f.size*s.TILE_PIXEL_RATIO:0,I=0,P=this._symbolFeatures;I<P.length;I++){var b=P[I],M=void 0;y&&a&&b.sprite&&(M=a[b.sprite])&&M.sdf&&(this._isIconSDF=!0),!!M&&(y.size=b.iconSize,y.rotate=b.iconRotate,y.offset=b.iconOffset);var L=void 0,V=0,A=b.label;if(A){f.size=b.textSize,f.rotate=b.textRotate,f.anchor=b.textAnchor,f.fontArray=b.textFontArray,f.justify=b.textJustify,f.letterSpacing=b.textLetterSpacing,f.maxWidth=b.textMaxWidth,f.offset=b.textOffset;var D=n?f.keepUpright:f.writingMode&&f.writingMode.indexOf(1)>=0,w=.5;switch(f.anchor){case 5:case 1:case 7:w=0;break;case 6:case 2:case 8:w=1}var S=.5;switch(f.anchor){case 5:case 3:case 6:S=0;break;case 7:case 4:case 8:S=1}var z=.5;switch(f.justify){case 0:z=w;break;case 1:z=0;break;case 3:z=1}var B,E=f.letterSpacing*l.SDF_GLYPH_SIZE,C=n?0:f.maxWidth*l.SDF_GLYPH_SIZE,T=f.lineHeight*l.SDF_GLYPH_SIZE;if(B=f.fontArray.map((function(e){return u.getGlyphItems(e)})),(L=new l.TextShaping(B,C,T,E,w,S,z).getShaping(A,b.rtl,D))&&L.length>0){for(var R=1e30,k=-1e30,F=0,O=L;F<O.length;F++){var G=O[F];R=Math.min(R,G.x),k=Math.max(k,G.x)}V=(k-R+2*l.SDF_GLYPH_SIZE)*p*s.TILE_PIXEL_RATIO}}for(var N=0,H=b.geometry;N<H.length;N++){var Z=H[N],j=void 0;if(n){if(L&&L.length>0&&f&&f.size){var Y=f.size*s.TILE_PIXEL_RATIO*(2+Math.min(2,4*Math.abs(f.offset[1])));Z=t._smoothVertices(Z,Y)}j=t._findAnchors(Z,x,V)}else j=3===b.type?t._findCentroid(Z):[new s.Anchor(Z[0].x,Z[0].y)];for(var q=0,U=j;q<U.length;q++){var W=U[q];if(!(W.x<0||W.x>s.TILE_COORD_SIZE||W.y<0||W.y>s.TILE_COORD_SIZE)&&(!(n&&V>0&&0===f.rotationAlignment)||t._honorsTextMaxAngle(Z,W,V,v,_))){var X={shaping:L,line:Z,iconMosaicItem:M,anchor:W,symbolFeature:b,textColliders:[],iconColliders:[],textVertexRanges:[],iconVertexRanges:[]};m.push(X),this._processFeature(X,y,f)}}}}m.sort(c),this._addPlacedGlyphs(),this._symbolInstances=m},t.prototype.serialize=function(){var e=13;e+=this.layerIndices.length,e+=3*this.markerPageMap.size,e+=3*this.glyphsPageMap.size,e+=t.symbolsSerializationLength(this._symbolInstances),e+=this._iconVertexBuffer.array.length,e+=this._iconIndexBuffer.array.length,e+=this._textVertexBuffer.array.length,e+=this._textIndexBuffer.array.length;var a=0,i=new Uint32Array(e),r=new Int32Array(i.buffer),n=new Float32Array(i.buffer);i[a++]=this.type,i[a++]=this.layerIndices.length;for(var o=0;o<this.layerIndices.length;o++)i[a++]=this.layerIndices[o];i[a++]=this._isIconSDF?1:0,i[a++]=this._iconVertexBuffer.isDataDriven()?1:0,i[a++]=this._textVertexBuffer.isDataDriven()?1:0,i[a++]=this.markerPageMap.size,this.markerPageMap.forEach((function(e,t){var r=e[0],n=e[1];i[a++]=t,i[a++]=r,i[a++]=n})),i[a++]=this.glyphsPageMap.size,this.glyphsPageMap.forEach((function(e,t){var r=e[0],n=e[1];i[a++]=t,i[a++]=r,i[a++]=n})),i[a++]=this._iconVertexBuffer.index/4,i[a++]=this._textVertexBuffer.index/4,a=t.serializeSymbols(i,r,n,a,this._symbolInstances),i[a++]=this._iconVertexBuffer.array.length;for(var s=0;s<this._iconVertexBuffer.array.length;s++)r[a++]=this._iconVertexBuffer.array[s];i[a++]=this._iconIndexBuffer.array.length;for(var l=0;l<this._iconIndexBuffer.array.length;l++)i[a++]=this._iconIndexBuffer.array[l];i[a++]=this._textVertexBuffer.array.length;for(var h=0;h<this._textVertexBuffer.array.length;h++)r[a++]=this._textVertexBuffer.array[h];i[a++]=this._textIndexBuffer.array.length;for(var x=0;x<this._textIndexBuffer.array.length;x++)i[a++]=this._textIndexBuffer.array[x];return i.buffer},t.symbolsSerializationLength=function(e){var t=0;t+=1;for(var a=0,i=e;a<i.length;a++){var r=i[a];t+=4,t+=1;for(var n=0,o=r.textColliders;n<o.length;n++){o[n];t+=10}for(var s=0,l=r.iconColliders;s<l.length;s++){l[s];t+=10}t+=1,t+=2*r.textVertexRanges.length,t+=1,t+=2*r.iconVertexRanges.length}return t},t.serializeSymbols=function(e,t,a,i,r){t[i++]=r.length;for(var n=0,o=r;n<o.length;n++){var s=o[n];t[i++]=s.anchor.x,t[i++]=s.anchor.y,t[i++]=s.symbolFeature.hash,t[i++]=s.symbolFeature.priority,t[i++]=s.textColliders.length+s.iconColliders.length;for(var l=0,h=s.textColliders;l<h.length;l++){var x=h[l];t[i++]=x.xTile,t[i++]=x.yTile,t[i++]=x.dxPixels,t[i++]=x.dyPixels,t[i++]=x.hard?1:0,t[i++]=x.partIndex,a[i++]=x.minLod,a[i++]=x.maxLod,t[i++]=x.width,t[i++]=x.height}for(var c=0,g=s.iconColliders;c<g.length;c++){x=g[c];t[i++]=x.xTile,t[i++]=x.yTile,t[i++]=x.dxPixels,t[i++]=x.dyPixels,t[i++]=x.hard?1:0,t[i++]=x.partIndex,a[i++]=x.minLod,a[i++]=x.maxLod,t[i++]=x.width,t[i++]=x.height}t[i++]=s.textVertexRanges.length;for(var d=0,y=s.textVertexRanges;d<y.length;d++){var f=y[d],u=f[0],m=f[1];t[i++]=u,t[i++]=m}t[i++]=s.iconVertexRanges.length;for(var p=0,v=s.iconVertexRanges;p<v.length;p++){var _=v[p];u=_[0],m=_[1];t[i++]=u,t[i++]=m}}return i},t.prototype._replaceKeys=function(e,t){return e.replace(/{([^{}]+)}/g,(function(e,a){return a in t?t[a]:""}))},t.prototype._processFeature=function(e,t,a){var i=e.line,r=e.iconMosaicItem,n=e.shaping,s=e.anchor,l=!!r,h=!0;l&&(h=t.optional||!r);var x,c,g=n&&n.length>0,d=!0;if((g&&(d=a.optional||!n||0===n.length),l&&(x=this._placementEngine.getIconPlacement(s,r,t)),x||h)&&(g&&(c=this._placementEngine.getTextPlacement(s,n,i,a)),c||d)){if(x&&c||(d||h?d||c?h||x||(c=null):x=null:(x=null,c=null)),c&&(this._storePlacedGlyphs(e,c.shapes,this.zoom,a.rotationAlignment),c.textColliders)){e.textColliders=c.textColliders;for(var y=0,f=c.textColliders;y<f.length;y++){if((B=f[y]).minLod=Math.max(this.zoom+o.log2(B.minLod),0),B.maxLod=Math.min(this.zoom+o.log2(B.maxLod),25),E=B.angle){var u=Math.cos(E),m=Math.sin(E),p=B.dxPixels*u-B.dyPixels*m,v=B.dxPixels*m+B.dyPixels*u,_=(B.dxPixels+B.width)*u-B.dyPixels*m,I=(B.dxPixels+B.width)*m+B.dyPixels*u,P=B.dxPixels*u-(B.dyPixels+B.height)*m,b=B.dxPixels*m+(B.dyPixels+B.height)*u,M=(B.dxPixels+B.width)*u-(B.dyPixels+B.height)*m,L=(B.dxPixels+B.width)*m+(B.dyPixels+B.height)*u,V=Math.min(p,_,P,M),A=Math.max(p,_,P,M),D=Math.min(v,I,b,L),w=Math.max(v,I,b,L);B.dxPixels=V,B.dyPixels=D,B.width=A-V,B.height=w-D}}}if(x&&(this._addPlacedIcons(e,x.shapes,this.zoom,r.page,1===t.rotationAlignment),x.iconColliders)){e.iconColliders=x.iconColliders;for(var S=0,z=x.iconColliders;S<z.length;S++){var B,E;if((B=z[S]).minLod=Math.max(this.zoom+o.log2(B.minLod),0),B.maxLod=Math.min(this.zoom+o.log2(B.maxLod),25),E=B.angle){u=Math.cos(E),m=Math.sin(E),p=B.dxPixels*u-B.dyPixels*m,v=B.dxPixels*m+B.dyPixels*u,_=(B.dxPixels+B.width)*u-B.dyPixels*m,I=(B.dxPixels+B.width)*m+B.dyPixels*u,P=B.dxPixels*u-(B.dyPixels+B.height)*m,b=B.dxPixels*m+(B.dyPixels+B.height)*u,M=(B.dxPixels+B.width)*u-(B.dyPixels+B.height)*m,L=(B.dxPixels+B.width)*m+(B.dyPixels+B.height)*u,V=Math.min(p,_,P,M),A=Math.max(p,_,P,M),D=Math.min(v,I,b,L),w=Math.max(v,I,b,L);B.dxPixels=V,B.dyPixels=D,B.width=A-V,B.height=w-D}}}}},t.prototype._addPlacedIcons=function(e,t,a,i,r){for(var n=e.symbolFeature.ddIconValues,s=Math.max(a-1,0),l=this._iconVertexBuffer,h=this._iconIndexBuffer,x=this._markerMap,c=0,g=t;c<g.length;c++){var d=g[c],y=r?0:Math.max(a+o.log2(d.minzoom),s),f=r?25:Math.min(a+o.log2(d.maxzoom),25);if(!(f<=y)){var u=d.tl,m=d.tr,p=d.bl,v=d.br,_=d.mosaicRect,I=d.labelAngle,P=d.minAngle,b=d.maxAngle,M=d.anchor,L=l.index,V=_.x,A=_.y,D=V+_.width,w=A+_.height,S=l.index;l.add(M.x,M.y,u.x,u.y,V,A,I,P,b,y,f,n),l.add(M.x,M.y,m.x,m.y,D,A,I,P,b,y,f,n),l.add(M.x,M.y,p.x,p.y,V,w,I,P,b,y,f,n),l.add(M.x,M.y,v.x,v.y,D,w,I,P,b,y,f,n),e.iconVertexRanges.length>0&&e.iconVertexRanges[0][0]+e.iconVertexRanges[0][1]===S?e.iconVertexRanges[0][1]+=4:e.iconVertexRanges.push([S,4]),h.add(L+0,L+1,L+2),h.add(L+1,L+2,L+3),x.has(i)?x.get(i)[1]+=6:x.set(i,[this._iconIndexStart+this._iconIndexCount,6]),this._iconIndexCount+=6}}},t.prototype._addPlacedGlyphs=function(){var e=this,t=this._textVertexBuffer,a=this._textIndexBuffer,i=this._glyphMap;this._glyphBufferDataStorage.forEach((function(r,n){for(var o=0,s=r;o<s.length;o++){var l=s[o],h=t.index,x=l.symbolInstance,c=x.symbolFeature.ddTextValues,g=t.index;t.add(l.glyphAnchor[0],l.glyphAnchor[1],l.tl[0],l.tl[1],l.xmin,l.ymin,l.labelAngle,l.minAngle,l.maxAngle,l.minLod,l.maxLod,c),t.add(l.glyphAnchor[0],l.glyphAnchor[1],l.tr[0],l.tr[1],l.xmax,l.ymin,l.labelAngle,l.minAngle,l.maxAngle,l.minLod,l.maxLod,c),t.add(l.glyphAnchor[0],l.glyphAnchor[1],l.bl[0],l.bl[1],l.xmin,l.ymax,l.labelAngle,l.minAngle,l.maxAngle,l.minLod,l.maxLod,c),t.add(l.glyphAnchor[0],l.glyphAnchor[1],l.br[0],l.br[1],l.xmax,l.ymax,l.labelAngle,l.minAngle,l.maxAngle,l.minLod,l.maxLod,c),x.textVertexRanges.length>0&&x.textVertexRanges[0][0]+x.textVertexRanges[0][1]===g?x.textVertexRanges[0][1]+=4:x.textVertexRanges.push([g,4]),a.add(h+0,h+1,h+2),a.add(h+1,h+2,h+3),i.has(n)?i.get(n)[1]+=6:i.set(n,[e._textIndexStart+e._textIndexCount,6]),e._textIndexCount+=6}})),this._glyphBufferDataStorage.clear()},t.prototype._storePlacedGlyphs=function(e,t,a,i){for(var r,n,s,l,h,x,c,g,d,y,f,u=Math.max(a-1,0),m=1===i,p=0,v=t;p<v.length;p++){var _=v[p];if(r=m?0:Math.max(a+o.log2(_.minzoom),u),!((n=m?25:Math.min(a+o.log2(_.maxzoom),25))<=r))s=_.tl,l=_.tr,h=_.bl,x=_.br,c=_.labelAngle,g=_.minAngle,d=_.maxAngle,y=_.anchor,f=_.mosaicRect,this._glyphBufferDataStorage.has(_.page)||this._glyphBufferDataStorage.set(_.page,[]),this._glyphBufferDataStorage.get(_.page).push({glyphAnchor:[y.x,y.y],tl:[s.x,s.y],tr:[l.x,l.y],bl:[h.x,h.y],br:[x.x,x.y],xmin:f.x,ymin:f.y,xmax:f.x+f.width,ymax:f.y+f.height,labelAngle:c,minAngle:g,maxAngle:d,minLod:r,maxLod:n,placementLod:u,symbolInstance:e})}},t._findAnchors=function(e,t,a){t+=a;for(var i=0,r=e.length-1,n=0;n<r;n++)i+=x.Point.distance(e[n],e[n+1]);var l=a||t;if(i<=(l*=.5))return[];var h=l/i,c=0,g=-(t=i/Math.max(Math.round(i/t),1))/2,d=[],y=e.length-1;for(n=0;n<y;n++){for(var f=e[n],u=e[n+1],m=u.x-f.x,p=u.y-f.y,v=Math.sqrt(m*m+p*p),_=void 0;g+t<c+v;){var I=((g+=t)-c)/v,P=o.interpolate(f.x,u.x,I),b=o.interpolate(f.y,u.y,I);void 0===_&&(_=Math.atan2(p,m)),d.push(new s.Anchor(P,b,_,n,h))}c+=v}return d},t._deviation=function(e,t,a){var i=(t.x-e.x)*(a.x-t.x)+(t.y-e.y)*(a.y-t.y),r=(t.x-e.x)*(a.y-t.y)-(t.y-e.y)*(a.x-t.x);return Math.atan2(r,i)},t._honorsTextMaxAngle=function(e,t,a,i,r){for(var n=0,o=a/2,s=new x.Point(t.x,t.y),l=t.segment+1;n>-o;){if(--l<0)return!1;n-=x.Point.distance(e[l],s),s=e[l]}n+=x.Point.distance(e[l],e[l+1]);for(var h=[],c=0,g=e.length;n<o;){var d=e[l],y=l,f=void 0;do{if(++y===g)return!1;f=e[y]}while(f.isEqual(d));var u=y,m=void 0;do{if(++u===g)return!1;m=e[u]}while(m.isEqual(f));var p=this._deviation(d,f,m);for(h.push({deviation:p,distToAnchor:n}),c+=p;n-h[0].distToAnchor>r;)c-=h.shift().deviation;if(Math.abs(c)>i)return!1;n+=x.Point.distance(f,m),l=y}return!0},t._smoothVertices=function(e,t){if(t<=0)return e;var a=e.length;if(a<3)return e;var i=[],r=0,n=0;i.push(0);for(var o=1;o<a;o++){(v=x.Point.distance(e[o],e[o-1]))>0&&(r+=v,i.push(r),++n!==o&&(e[n]=e[o]))}if((a=n+1)<3)return e;t=Math.min(t,.2*r);var s=e[0].x,l=e[0].y,h=e[a-1].x,c=e[a-1].y,g=x.Point.sub(e[0],e[1]);g.normalize(),e[0].x+=t*g.x,e[0].y+=t*g.y,g.assignSub(e[a-1],e[a-2]),g.normalize(),e[a-1].x+=t*g.x,e[a-1].y+=t*g.y,i[0]-=t,i[a-1]+=t;var d=[];d.push(new x.Point(s,l));var y=.5*t;for(o=1;o<a-1;o++){for(var f=0,u=0,m=0,p=o-1;p>=0;p--){if((L=y+i[p+1]-i[o])<0)break;var v=i[p+1]-i[p];if((V=i[o]-i[p]<y?1:L/v)<1e-6)break;var _=V*L-.5*(A=V*V)*v,I=V*v/t,P=e[p+1],b=e[p].x-P.x,M=e[p].y-P.y;f+=I/_*(P.x*V*L+.5*A*(L*b-v*P.x)-A*V*v*b/3),u+=I/_*(P.y*V*L+.5*A*(L*M-v*P.y)-A*V*v*M/3),m+=I}for(p=o+1;p<a;p++){var L;if((L=y-i[p-1]+i[o])<0)break;var V;v=i[p]-i[p-1];if((V=i[p]-i[o]<y?1:L/v)<1e-6)break;var A;_=V*L-.5*(A=V*V)*v,I=V*v/t,P=e[p-1],b=e[p].x-P.x,M=e[p].y-P.y;f+=I/_*(P.x*V*L+.5*A*(L*b-v*P.x)-A*V*v*b/3),u+=I/_*(P.y*V*L+.5*A*(L*M-v*P.y)-A*V*v*M/3),m+=I}d.push(new x.Point(f/m,u/m))}return d.push(new x.Point(h,c)),e[0].x=s,e[0].y=l,e[a-1].x=h,e[a-1].y=c,d},t._findCentroid=function(e){var t=e.length-1,a=0,i=0,r=0,n=e[0].x,o=e[0].y;n>4096&&(n=4096),n<0&&(n=0),o>4096&&(o=4096),o<0&&(o=0);for(var l=1;l<t;l++){var h=e[l].x,x=e[l].y,c=e[l+1].x,g=e[l+1].y;h>4096&&(h=4096),h<0&&(h=0),x>4096&&(x=4096),x<0&&(x=0),c>4096&&(c=4096),c<0&&(c=0),g>4096&&(g=4096),g<0&&(g=0);var d=(h-n)*(g-o)-(c-n)*(x-o);a+=d*(n+h+c),i+=d*(o+x+g),r+=d}return a/=3*r,i/=3*r,isNaN(a)||isNaN(i)?[]:[new s.Anchor(a,i)]},t._bidiEngine=new i.default,t}(n)}));