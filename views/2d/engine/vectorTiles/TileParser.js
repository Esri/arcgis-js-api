/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../../core/promiseUtils","../../../../core/pbf","../webgl/TileClipper","../../tiling/enums","./CircleBucket","./Feature","./FillBucket","./IndexMemoryBuffer","./LineBucket","./SourceLayerData","./SymbolBucket","./VertexMemoryBuffer"],(function(e,t,r,s,n,i,o,c,a,u,l,f){"use strict";return function(){function h(e,s,n,i,o){if(this._pbfTiles={},this._tileClippers={},this._client=n,this._tile=s,o){this._styleLayerUIDs=new Set;for(const e of o)this._styleLayerUIDs.add(e)}this._styleRepository=i,this._layers=this._styleRepository.layers;const[c,a,u]=s.tileKey.split("/").map(parseFloat);this._level=c;const l=Math.max(8,Math.round(1*this._level)-8);for(const s of Object.keys(e)){const n=e[s];this._pbfTiles[s]=new t(new Uint8Array(n.protobuff),new DataView(n.protobuff));if(n.refKey){const[e]=n.refKey.split("/").map(parseFloat),t=c-e;if(t>0){const e=(1<<t)-1,n=a&e,i=u&e;this._tileClippers[s]=new r.TileClipper(t,n,i,8,l)}}this._tileClippers[s]||(this._tileClippers[s]=new r.SimpleBuilder)}}var p=h.prototype;return p._canParseStyleLayer=function(e){return!this._styleLayerUIDs||this._styleLayerUIDs.has(e)},p.parse=async function(t){const r=this._initialize(t),{returnedBuckets:n}=r;this._processLayers(r),this._linkReferences(r),this._filterFeatures(r);const i=new Set,o={};for(const e of n)3===e.type&&e.getResources(e.tileClipper,i,o);if(this._tile.status===s.TileStatus.INVALID)return e.resolve([]);const c=this._fetchResources(i,o,t);return e.all(c).then((()=>this._processFeatures(r.returnedBuckets)))},p._initialize=function(e){return{signal:e&&e.signal,sourceNameToTileData:this._parseTileData(this._pbfTiles),layers:this._layers,zoom:this._level,sourceNameToTileClipper:this._tileClippers,sourceNameToUniqueSourceLayerBuckets:{},sourceNameToUniqueSourceLayers:{},returnedBuckets:[],layerIdToBucket:{},referencerUIDToReferencedId:new Map}},p._processLayers=function(e){const{sourceNameToTileData:t,layers:r,zoom:s,sourceNameToTileClipper:n,sourceNameToUniqueSourceLayerBuckets:i,sourceNameToUniqueSourceLayers:o,returnedBuckets:c,layerIdToBucket:a,referencerUIDToReferencedId:u}=e;for(let e=r.length-1;e>=0;e--){const l=r[e];if(!this._canParseStyleLayer(l.uid)||l.minzoom&&s<Math.floor(l.minzoom)||l.maxzoom&&s>=l.maxzoom||0===l.type)continue;if(!t[l.source]||!n[l.source])continue;const f=t[l.source],h=n[l.source],p=l.sourceLayer,y=f[p];if(y){let e=o[l.source];if(e||(e=o[l.source]=new Set),e.add(l.sourceLayer),l.refLayerId)u.set(l.uid,l.refLayerId);else{const e=this._createBucket(l);if(e){e.layerUIDs=[l.uid],e.layerExtent=y.extent,e.tileClipper=h;let t=i[l.source];t||(t=i[l.source]={});let r=t[p];r||(r=t[p]=[]),r.push(e),c.push(e),a[l.id.toLowerCase()]=e}}}}},p._linkReferences=function(e){const{layerIdToBucket:t,referencerUIDToReferencedId:r}=e;r.forEach(((e,r)=>{e=e.toLowerCase(),t[e]&&t[e].layerUIDs.push(r)}))},p._filterFeatures=function(t){const{signal:r,sourceNameToTileData:s,sourceNameToUniqueSourceLayerBuckets:n,sourceNameToUniqueSourceLayers:o}=t,c=10*this._level,a=10*(this._level+1),u=[],l=[];for(const e of Object.keys(o)){o[e].forEach((t=>{u.push(t),l.push(e)}))}for(let t=0;t<u.length;t++){const o=l[t],f=u[t];if(!s[o]||!n[o])continue;const h=s[o][f],p=n[o][f];if(!p||0===p.length)continue;if(e.isAborted(r))return;const y=h.getData();for(;y.nextTag(2);){const e=y.getMessage(),t=new i(e,h);e.release();const r=t.values;if(r){const e=r._minzoom;if(e&&e>=a)continue;const t=r._maxzoom;if(t&&t<=c)continue}for(const e of p)e.pushFeature(t)}}},p._fetchResources=function(e,t,r){const s=[],n=this._tile.getWorkerTileHandler();let i,o;e.size>0&&(i=n.fetchSprites(e,this._client,r),s.push(i));for(const e in t){const i=t[e];i.size>0&&(o=n.fetchGlyphs(this._tile.tileKey,e,i,this._client,r),s.push(o))}return s},p._processFeatures=function(e){const t=e.filter((e=>e.hasFeatures()));for(const e of t)e.processFeatures(e.tileClipper);return t},p._parseTileData=function(e){const t={};for(const r of Object.keys(e)){const s=e[r],n={};for(;s.next();)switch(s.tag()){case 3:{const e=s.getMessage(),t=new u(e);e.release(),n[t.name]=t;break}default:s.skip()}t[r]=n}return t},p._createBucket=function(e){switch(e.type){case 0:return null;case 1:return this._createFillBucket(e);case 2:return this._createLineBucket(e);case 4:return this._createCircleBucket(e);case 3:return this._createSymbolBucket(e)}},p._createFillBucket=function(e){return new o(e,this._level,new f.FillVertexBuffer(e.hasDataDrivenFill),new c.TriangleIndexBuffer,new f.OutlineVertexBuffer(e.hasDataDrivenOutline),new c.TriangleIndexBuffer)},p._createLineBucket=function(e){return new a(e,this._level,new f.LineVertexBuffer(e.hasDataDrivenLine),new c.TriangleIndexBuffer)},p._createCircleBucket=function(e){return new n(e,this._level,new f.CircleVertexBuffer,new c.TriangleIndexBuffer)},p._createSymbolBucket=function(e){const t=this._tile;return new l(e,this._level,new f.SymbolVertexBuffer(e.hasDataDrivenIcon),new c.TriangleIndexBuffer,new f.SymbolVertexBuffer(e.hasDataDrivenText),new c.TriangleIndexBuffer,t.placementEngine,t.getWorkerTileHandler())},h}()}));
