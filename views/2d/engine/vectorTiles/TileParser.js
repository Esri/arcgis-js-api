// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../core/pbf","../../../../core/promiseUtils","./CircleBucket","./Feature","./FillBucket","./IndexMemoryBuffer","./LineBucket","./SourceLayerData","./SymbolBucket","./VertexMemoryBuffer","../webgl/TileClipper","../../tiling/enums"],(function(e,t,r,i,n,l,s,a,u,o,c,f,h,p,y){"use strict";return function(){function e(e,t,r){this._pbfTiles={},this._tileClippers={},this._client=r,this._tile=t,this._layers=t.getLayers();var n=t.tileKey.split("/").map(parseFloat),l=n[0],s=n[1],a=n[2];this._level=l;for(var u=Math.max(8,Math.round(1*this._level)-8),o=0,c=Object.keys(e);o<c.length;o++){var f=c[o],h=e[f];if(this._pbfTiles[f]=new i(new Uint8Array(h.protobuff),new DataView(h.protobuff)),h.refKey){var y=l-h.refKey.split("/").map(parseFloat)[0];if(y>0){var _=(1<<y)-1,v=s&_,w=a&_;this._tileClippers[f]=new p.TileClipper(y,v,w,8,u)}}this._tileClippers[f]||(this._tileClippers[f]=new p.SimpleBuilder)}}return e.prototype.parse=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,i,l,a,u,o,c,f,h,p,_,v,w,g,B,m,d,x,k,b,T,C,D,I,L,F,S,V,z,M,O,E,K,j,A,H,U,W,q,G,N,R,J,P,Q,X,Y,Z,$;return r.__generator(this,(function(r){for(t=e&&e.signal,i=this._parseTileData(this._pbfTiles),l=this._layers,a=this._level,o=this._tileClippers,c={},f={},h=[],p={},_=new Map,v=l.length-1;v>=0;v--)(u=l[v]).minzoom&&a<Math.floor(u.minzoom)||u.maxzoom&&a>=u.maxzoom||u.layout&&u.layout.visibility&&"none"===u.layout.visibility||0!==u.type&&i[u.source]&&o[u.source]&&(z=i[u.source],w=o[u.source],g=u.sourceLayer,(M=z[g])&&((B=f[u.source])||(B=f[u.source]=new Set),B.add(u.sourceLayer),u.refLayerId?_.set(v,u.refLayerId):(J=this._createBucket(u))&&(J.layerIndices=[v],J.layerExtent=M.extent,J.tileClipper=w,(O=c[u.source])||(O=c[u.source]={}),(m=O[g])||(m=O[g]=[]),m.push(J),h.push(J),p[u.id.toLowerCase()]={layer:u,bucket:J})));for(_.forEach((function(e,t){e=e.toLowerCase(),p[e]&&p[e].bucket.layerIndices.push(t)})),d=10*this._level,x=10*(this._level+1),k=new Set,b={},T=[],C=[],D=function(e){f[e].forEach((function(t){T.push(t),C.push(e)}))},I=0,L=Object.keys(f);I<L.length;I++)S=L[I],D(S);for(F=0;F<T.length;F++)if(S=C[F],V=T[F],i[S]&&c[S]&&(z=i[S],M=z[V],O=c[S],(E=O[V])&&0!==E.length)){if(n.isAborted(t))return[2,void 0];for(K=M.getData();K.nextTag(2);){if(j=K.getMessage(),A=new s(j,M),j.release(),H=A.values){if((U=H._minzoom)&&U>=x)continue;if((W=H._maxzoom)&&W<=d)continue}for(q=0,G=E;q<G.length;q++)(J=G[q]).pushFeature(A)}}for(N=0,R=h;N<R.length;N++)3===(J=R[N]).type&&J.getResources(J.tileClipper,k,b);if(this._tile.status===y.TileStatus.INVALID)return[2,n.resolve([])];for(Z in P=[],Q=this._tile.getWorkerTileHandler(),k.size>0&&(X=Q.fetchSprites(k,this._client,e),P.push(X)),b)($=b[Z]).size>0&&(Y=Q.fetchGlyphs(this._tile.tileKey,Z,$,this._client,e),P.push(Y));return[2,n.all(P).then((function(){for(var e=h.filter((function(e){return e.hasFeatures()})),t=0,r=e;t<r.length;t++){var i=r[t];i.processFeatures(i.tileClipper)}return e.sort((function(e,t){return e.layerIndices[0]-t.layerIndices[0]})),e}))]}))}))},e.prototype._parseTileData=function(e){for(var t={},r=0,i=Object.keys(e);r<i.length;r++){for(var n=i[r],l=e[n],s={};l.next();)switch(l.tag()){case 3:var a=l.getMessage(),u=new c(a);a.release(),s[u.name]=u;break;default:l.skip()}t[n]=s}return t},e.prototype._createBucket=function(e){switch(e.type){case 0:return null;case 1:return this._createFillBucket(e);case 2:return this._createLineBucket(e);case 4:return this._createCircleBucket(e);case 3:return this._createSymbolBucket(e)}},e.prototype._createFillBucket=function(e){return new a(e,this._level,new h.FillVertexBuffer(e.hasDataDrivenFill),new u.TriangleIndexBuffer,new h.OutlineVertexBuffer(e.hasDataDrivenOutline),new u.TriangleIndexBuffer)},e.prototype._createLineBucket=function(e){return new o(e,this._level,new h.LineVertexBuffer(e.hasDataDrivenLine),new u.TriangleIndexBuffer)},e.prototype._createCircleBucket=function(e){return new l(e,this._level,new h.CircleVertexBuffer,new u.TriangleIndexBuffer)},e.prototype._createSymbolBucket=function(e){var t=this._tile;return new f(e,this._level,new h.SymbolVertexBuffer(e.hasDataDrivenIcon),new u.TriangleIndexBuffer,new h.SymbolVertexBuffer(e.hasDataDrivenText),new u.TriangleIndexBuffer,t.placementEngine,t.getWorkerTileHandler())},e}()}));