/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/mat3","../../../../chunks/mat3f32","./decluttering/config","./RenderBucket","../webgl/TiledDisplayObject"],(function(e,t,s,a,r,n,i){"use strict";let o=function(e){function i(t,s,r,n){var i;return(i=e.call(this,t,r,n,[4096,4096])||this)._referenced=0,i._hasSymbolBuckets=!1,i._memoryUsedByLayerData=0,i.layerData=new Map,i.layerCount=0,i.status="loading",i.allSymbolsFadingOut=!1,i.lastOpacityUpdate=0,i.symbols=new Map,i.isCoverage=!1,i.neededForCoverage=!1,i.decluttered=!1,i.invalidating=!1,i.parentTile=null,i.childrenTiles=new Set,i._processed=!1,i._referenced=1,i.styleRepository=s,i.id=t.id,i.transforms.tileUnitsToPixels=a.create(),i}t._inheritsLoose(i,e);var o=i.prototype;return o.setData=function(e){this.changeDataImpl(e),this.requestRender(),this.ready(),this.invalidating=!1,this._processed=!0},o.deleteLayerData=function(e){let t=!1;for(const s of e)if(this.layerData.has(s)){const e=this.layerData.get(s);this._memoryUsedByLayerData-=e.memoryUsed,3===e.type&&this.symbols.has(s)&&(this.symbols.delete(s),t=!0),e.destroy(),this.layerData.delete(s),this.layerCount--}t&&this.emit("symbols-changed"),this.requestRender()},o.processed=function(){return this._processed},o.hasData=function(){return this.layerCount>0},o.dispose=function(){i._destroyRenderBuckets(this.layerData),this.layerData=null,this.layerCount=0,this._memoryUsedByLayerData=0,this.destroy()},o.release=function(){return 0==--this._referenced&&(this.dispose(),this.stage=null,!0)},o.reference=function(){++this._referenced},o.getMemoryUsage=function(){return this._memoryUsedByLayerData/(this._referenced||1)},o.changeDataImpl=function(e){let t=!1;if(e){const s=this._createRenderBuckets(e);for(const[e,a]of s){if(this.layerData.has(e)){const t=this.layerData.get(e);this._memoryUsedByLayerData-=a.memoryUsed,t.destroy(),this.layerData.delete(e),this.layerCount--}3===a.type&&(this.symbols.set(e,a.symbols),t=!0),this._memoryUsedByLayerData+=a.memoryUsed,this.layerData.set(e,a),this.layerCount++}}this._hasSymbolBuckets=!1;for(const[e,t]of this.layerData)3===t.type&&(this._hasSymbolBuckets=!0);t&&this.emit("symbols-changed")},o.attachWithContext=function(e){this.stage={context:e,trashDisplayObject(e){e.processDetach()},untrashDisplayObject:()=>!1}},o.setTransform=function(t,a){e.prototype.setTransform.call(this,t,a);const r=a/(t.resolution*t.pixelRatio),n=this.size[0]/this.coordRange[0]*r,i=this.size[1]/this.coordRange[1]*r,o=[0,0];t.toScreen(o,this.coords);const c=this.transforms.tileUnitsToPixels;s.identity(c),s.translate(c,c,o),s.rotate(c,c,Math.PI*t.rotation/180),s.scale(c,c,[n,i,1])},i._destroyRenderBuckets=function(e){const t=new Set;e.forEach((e=>{t.has(e)||(e.destroy(),t.add(e))})),e.clear()},o._createRenderBuckets=function(e){const t=new Map,s=new Map;for(const a of e){const e=this._deserializeBucket(a,s);for(const s of e.layerUIDs)t.set(s,e)}return t},o._deserializeBucket=function(e,t){let s=t.get(e);if(s)return s;switch(new Uint32Array(e)[0]){case 1:s=new n.FillRenderBucket(e);break;case 2:s=new n.LineRenderBucket(e);break;case 3:s=new n.SymbolRenderBucket(e,this);break;case 4:s=new n.CircleRenderBucket(e)}return t.set(e,s),s},t._createClass(i,[{key:"hasSymbolBuckets",get:function(){return this._hasSymbolBuckets}},{key:"isFading",get:function(){return this._hasSymbolBuckets&&performance.now()-this.lastOpacityUpdate<r.FADE_DURATION}},{key:"isHoldingForFade",get:function(){return this._hasSymbolBuckets&&(!this.allSymbolsFadingOut||performance.now()-this.lastOpacityUpdate<r.FADE_DURATION)}},{key:"wasRequested",get:function(){return"errored"===this.status||"loaded"===this.status||"reloading"===this.status}},{key:"referenced",get:function(){return this._referenced}}]),i}(i.TiledDisplayObject);e.VectorTile=o,Object.defineProperty(e,"__esModule",{value:!0})}));
