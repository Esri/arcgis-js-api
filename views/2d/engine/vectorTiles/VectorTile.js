/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../chunks/mat3","../../../../chunks/mat3f32","./RenderBucket","./decluttering/config","../webgl/TiledDisplayObject"],(function(e,t,s,a,i,r,n,o){"use strict";let c=function(e){function o(t,s,a,i,r,n,o=null){var c;return(c=e.call(this,t,s,a,i,r,4096,4096)||this)._memCache=o,c.type="vector-tile",c._referenced=0,c._hasSymbolBuckets=!1,c._memoryUsedByLayerData=0,c.layerData=new Map,c.layerCount=0,c.status="loading",c.allSymbolsFadingOut=!1,c.lastOpacityUpdate=0,c.symbols=new Map,c.isCoverage=!1,c.neededForCoverage=!1,c.decluttered=!1,c.invalidating=!1,c.parentTile=null,c.childrenTiles=new Set,c._processed=!1,c._referenced=1,c.styleRepository=n,c.id=t.id,c}t._inheritsLoose(o,e);var c=o.prototype;return c.setData=function(e){this.changeDataImpl(e),this.requestRender(),this.ready(),this.invalidating=!1,this._processed=!0},c.deleteLayerData=function(e){let t=!1;for(const s of e)if(this.layerData.has(s)){const e=this.layerData.get(s);this._memoryUsedByLayerData-=e.memoryUsed,3===e.type&&this.symbols.has(s)&&(this.symbols.delete(s),t=!0),e.destroy(),this.layerData.delete(s),this.layerCount--}s.isSome(this._memCache)&&this._memCache.updateSize(this.key.id,this,this._memoryUsedByLayerData),t&&this.emit("symbols-changed"),this.requestRender()},c.processed=function(){return this._processed},c.hasData=function(){return this.layerCount>0},c.dispose=function(){"unloaded"!==this.status&&(l.delete(this),o._destroyRenderBuckets(this.layerData),this.layerData=null,this.layerCount=0,this._memoryUsedByLayerData=0,this.destroy(),this.status="unloaded")},c.release=function(){return 0==--this._referenced&&(this.dispose(),this.stage=null,!0)},c.retain=function(){++this._referenced},c.changeDataImpl=function(e){let t=!1;if(e){const a=this._createRenderBuckets(e);for(const[e,s]of a){if(this.layerData.has(e)){const t=this.layerData.get(e);this._memoryUsedByLayerData-=s.memoryUsed,t.destroy(),this.layerData.delete(e),this.layerCount--}3===s.type&&(this.symbols.set(e,s.symbols),t=!0),this._memoryUsedByLayerData+=s.memoryUsed,this.layerData.set(e,s),this.layerCount++}s.isSome(this._memCache)&&this._memCache.updateSize(this.key.id,this,this._memoryUsedByLayerData)}this._hasSymbolBuckets=!1;for(const[s,a]of this.layerData)3===a.type&&(this._hasSymbolBuckets=!0);t&&this.emit("symbols-changed")},c.attachWithContext=function(e){this.stage={context:e,trashDisplayObject(e){e.processDetach()},untrashDisplayObject:()=>!1}},c.setTransform=function(t,s){e.prototype.setTransform.call(this,t,s);const i=s/(t.resolution*t.pixelRatio),r=this.width/this.rangeX*i,n=this.height/this.rangeY*i,o=[0,0];t.toScreen(o,[this.x,this.y]);const c=this.transforms.tileUnitsToPixels;a.identity(c),a.translate(c,c,o),a.rotate(c,c,Math.PI*t.rotation/180),a.scale(c,c,[r,n,1])},c._createTransforms=function(){return{dvs:i.create(),tileMat3:i.create(),tileUnitsToPixels:i.create()}},o._destroyRenderBuckets=function(e){if(!e)return;const t=new Set;e.forEach((e=>{t.has(e)||(e.destroy(),t.add(e))})),e.clear()},c._createRenderBuckets=function(e){const t=new Map,s=new Map;for(const a of e){const e=this._deserializeBucket(a,s);for(const s of e.layerUIDs)t.set(s,e)}return t},c._deserializeBucket=function(e,t){let s=t.get(e);if(s)return s;switch(new Uint32Array(e)[0]){case 1:s=new r.FillRenderBucket(e,this.styleRepository);break;case 2:s=new r.LineRenderBucket(e,this.styleRepository);break;case 3:s=new r.SymbolRenderBucket(e,this.styleRepository,this);break;case 4:s=new r.CircleRenderBucket(e,this.styleRepository)}return t.set(e,s),s},t._createClass(o,[{key:"hasSymbolBuckets",get:function(){return this._hasSymbolBuckets}},{key:"isFading",get:function(){return this._hasSymbolBuckets&&performance.now()-this.lastOpacityUpdate<n.FADE_DURATION}},{key:"isHoldingForFade",get:function(){return this._hasSymbolBuckets&&(!this.allSymbolsFadingOut||performance.now()-this.lastOpacityUpdate<n.FADE_DURATION)}},{key:"wasRequested",get:function(){return"errored"===this.status||"loaded"===this.status||"reloading"===this.status}},{key:"referenced",get:function(){return this._referenced}},{key:"memoryUsage",get:function(){return(this._memoryUsedByLayerData+256)/(this._referenced||1)}}]),o}(o.TiledDisplayObject);const l=new Map;function h(){l.forEach(((e,t)=>{console.log(`\n${t.key}:`),e[0].forEach((e=>console.log(e))),console.log("========"),e[1].forEach((e=>console.log(e)))}))}e.VectorTile=c,e.printAllocations=h,Object.defineProperty(e,"__esModule",{value:!0})}));
