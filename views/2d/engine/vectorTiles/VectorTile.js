/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../chunks/mat3","../../../../chunks/mat3f32","./decluttering/config","./RenderBucket","../webgl/TiledDisplayObject"],(function(e,t,s,a,i,r,o,n){"use strict";let c=function(e){function n(t,s,a,r,o=null){var n;return(n=e.call(this,t,a,r,[4096,4096])||this)._memCache=o,n._referenced=0,n._hasSymbolBuckets=!1,n._memoryUsedByLayerData=0,n.layerData=new Map,n.layerCount=0,n.status="loading",n.allSymbolsFadingOut=!1,n.lastOpacityUpdate=0,n.symbols=new Map,n.isCoverage=!1,n.neededForCoverage=!1,n.decluttered=!1,n.invalidating=!1,n.parentTile=null,n.childrenTiles=new Set,n._processed=!1,n._referenced=1,n.styleRepository=s,n.id=t.id,n.transforms.tileUnitsToPixels=i.create(),n}t._inheritsLoose(n,e);var c=n.prototype;return c.setData=function(e){this.changeDataImpl(e),this.requestRender(),this.ready(),this.invalidating=!1,this._processed=!0},c.deleteLayerData=function(e){let t=!1;for(const s of e)if(this.layerData.has(s)){const e=this.layerData.get(s);this._memoryUsedByLayerData-=e.memoryUsed,3===e.type&&this.symbols.has(s)&&(this.symbols.delete(s),t=!0),e.destroy(),this.layerData.delete(s),this.layerCount--}s.isSome(this._memCache)&&this._memCache.updateSize(this.key.id,this,this._memoryUsedByLayerData),t&&this.emit("symbols-changed"),this.requestRender()},c.processed=function(){return this._processed},c.hasData=function(){return this.layerCount>0},c.dispose=function(){"unloaded"!==this.status&&(l.delete(this),n._destroyRenderBuckets(this.layerData),this.layerData=null,this.layerCount=0,this._memoryUsedByLayerData=0,this.destroy(),this.status="unloaded")},c.release=function(){return 0==--this._referenced&&(this.dispose(),this.stage=null,!0)},c.retain=function(){++this._referenced},c.getMemoryUsage=function(){return(this._memoryUsedByLayerData+256)/(this._referenced||1)},c.changeDataImpl=function(e){let t=!1;if(e){const a=this._createRenderBuckets(e);for(const[e,s]of a){if(this.layerData.has(e)){const t=this.layerData.get(e);this._memoryUsedByLayerData-=s.memoryUsed,t.destroy(),this.layerData.delete(e),this.layerCount--}3===s.type&&(this.symbols.set(e,s.symbols),t=!0),this._memoryUsedByLayerData+=s.memoryUsed,this.layerData.set(e,s),this.layerCount++}s.isSome(this._memCache)&&this._memCache.updateSize(this.key.id,this,this._memoryUsedByLayerData)}this._hasSymbolBuckets=!1;for(const[s,a]of this.layerData)3===a.type&&(this._hasSymbolBuckets=!0);t&&this.emit("symbols-changed")},c.attachWithContext=function(e){this.stage={context:e,trashDisplayObject(e){e.processDetach()},untrashDisplayObject:()=>!1}},c.setTransform=function(t,s){e.prototype.setTransform.call(this,t,s);const i=s/(t.resolution*t.pixelRatio),r=this.size[0]/this.coordRange[0]*i,o=this.size[1]/this.coordRange[1]*i,n=[0,0];t.toScreen(n,this.coords);const c=this.transforms.tileUnitsToPixels;a.identity(c),a.translate(c,c,n),a.rotate(c,c,Math.PI*t.rotation/180),a.scale(c,c,[r,o,1])},n._destroyRenderBuckets=function(e){if(!e)return;const t=new Set;e.forEach((e=>{t.has(e)||(e.destroy(),t.add(e))})),e.clear()},c._createRenderBuckets=function(e){const t=new Map,s=new Map;for(const a of e){const e=this._deserializeBucket(a,s);for(const s of e.layerUIDs)t.set(s,e)}return t},c._deserializeBucket=function(e,t){let s=t.get(e);if(s)return s;switch(new Uint32Array(e)[0]){case 1:s=new o.FillRenderBucket(e,this.styleRepository);break;case 2:s=new o.LineRenderBucket(e,this.styleRepository);break;case 3:s=new o.SymbolRenderBucket(e,this.styleRepository,this);break;case 4:s=new o.CircleRenderBucket(e,this.styleRepository)}return t.set(e,s),s},t._createClass(n,[{key:"hasSymbolBuckets",get:function(){return this._hasSymbolBuckets}},{key:"isFading",get:function(){return this._hasSymbolBuckets&&performance.now()-this.lastOpacityUpdate<r.FADE_DURATION}},{key:"isHoldingForFade",get:function(){return this._hasSymbolBuckets&&(!this.allSymbolsFadingOut||performance.now()-this.lastOpacityUpdate<r.FADE_DURATION)}},{key:"wasRequested",get:function(){return"errored"===this.status||"loaded"===this.status||"reloading"===this.status}},{key:"referenced",get:function(){return this._referenced}}]),n}(n.TiledDisplayObject);const l=new Map;function h(){l.forEach(((e,t)=>{console.log(`\n${t.key}:`),e[0].forEach((e=>console.log(e))),console.log("========"),e[1].forEach((e=>console.log(e)))}))}e.VectorTile=c,e.printAllocations=h,Object.defineProperty(e,"__esModule",{value:!0})}));
