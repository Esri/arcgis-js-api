/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../../core/has","../../../../core/promiseUtils","../../../../request","../../../../core/pbf"],(function(t,e,n,a){"use strict";let r=function(){function t(t){if(this._metrics=[],this._bitmaps=[],t)for(;t.next();)switch(t.tag()){case 1:{const e=t.getMessage();for(;e.next();)switch(e.tag()){case 3:{const t=e.getMessage();let n,a,r,s,i,c,o;for(;t.next();)switch(t.tag()){case 1:n=t.getUInt32();break;case 2:a=t.getBytes();break;case 3:r=t.getUInt32();break;case 4:s=t.getUInt32();break;case 5:i=t.getSInt32();break;case 6:c=t.getSInt32();break;case 7:o=t.getUInt32();break;default:t.skip()}t.release(),n&&(this._metrics[n]={width:r,height:s,left:i,top:c,advance:o},this._bitmaps[n]=a);break}default:e.skip()}e.release();break}default:t.skip()}}var e=t.prototype;return e.getMetrics=function(t){return this._metrics[t]},e.getBitmap=function(t){return this._bitmaps[t]},t}(),s=function(){function t(){this._ranges=[]}var e=t.prototype;return e.getRange=function(t){return this._ranges[t]},e.addRange=function(t,e){this._ranges[t]=e},t}();return function(){function t(t){this._glyphInfo={},this._baseURL=t}var i=t.prototype;return i.getRange=function(t,s){const i=this._getFontStack(t);if(i.getRange(s))return e.resolve();const c=256*s,o=c+255,g=this._baseURL.replace("{fontstack}",t).replace("{range}",c+"-"+o);return n(g,{responseType:"array-buffer"}).then((t=>{i.addRange(s,new r(new a(new Uint8Array(t.data),new DataView(t.data))))})).catch((()=>{i.addRange(s,new r)}))},i.getGlyph=function(t,e){const n=this._getFontStack(t);if(!n)return;const a=Math.floor(e/256);if(a>256)return;const r=n.getRange(a);return r?{metrics:r.getMetrics(e),bitmap:r.getBitmap(e)}:void 0},i._getFontStack=function(t){let e=this._glyphInfo[t];return e||(e=this._glyphInfo[t]=new s),e},t}()}));
