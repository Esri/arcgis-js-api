/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/maybe","./config"],(function(e,o,t,i){"use strict";function s(e,o){if(e.priority-o.priority)return e.priority-o.priority;const t=e.tile.key,i=o.tile.key;return t.world-i.world?t.world-i.world:t.level-i.level?t.level-i.level:t.row-i.row?t.row-i.row:t.col-i.col?t.col-i.col:e.xTile-o.xTile?e.xTile-o.xTile:e.yTile-o.yTile}let n=function(){function e(e,o,t,i,s,n){this._visibleTiles=e,this._symbolRepository=o,this._createCollisionJob=t,this._assignTileSymbolsOpacity=i,this._symbolLayerSorter=s,this._isLayerVisible=n,this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}var i=e.prototype;return i.setScreenSize=function(e,o){this._screenWidth===e&&this._screenHeight===o||this.restart(),this._screenWidth=e,this._screenHeight=o},i.restart=function(){this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0},i.continue=function(e){if(this._selectionJob||(this._selectionJob=this._createSelectionJob()),!this._selectionJobCompleted){const o=performance.now();if(!this._selectionJob.work(e))return!1;if(this._selectionJobCompleted=!0,0===(e=Math.max(0,e-(performance.now()-o))))return!1}if(this._collisionJob||(this._collisionJob=this._createCollisionJob(this._selectionJob.sortedSymbols,this._screenWidth,this._screenHeight)),!this._collisionJobCompleted){const o=performance.now();if(!this._collisionJob.work(e))return!1;if(this._collisionJobCompleted=!0,0===(e=Math.max(0,e-(performance.now()-o))))return!1}if(this._opacityJob||(this._opacityJob=this._createOpacityJob()),!this._opacityJobCompleted){const o=performance.now();if(!this._opacityJob.work(e))return!1;if(this._opacityJobCompleted=!0,0===(e=Math.max(0,e-(performance.now()-o))))return!1}return this._running=!1,!0},i._createSelectionJob=function(){const e=this._symbolRepository.uniqueSymbols,o=[];let t=0,i=0;const n=this._isLayerVisible;function r(r){let l;const c=performance.now();for(;i<e.length;i++,t=0){const s=e[i],a=s.styleLayerUID;if(!n(a)){o[i]||(o[i]={styleLayerUID:a,symbols:[]});continue}o[i]=o[i]||{styleLayerUID:a,symbols:[]};const h=o[i];for(;t<s.uniqueSymbols.length;t++){if(l=s.uniqueSymbols[t],t%100==99&&performance.now()-c>r)return!1;let e=null,o=!1,i=!1;for(const t of l.tileSymbols)if(t.selectedForRendering=!1,!i||!o){const s=t.tile;(!e||s.isCoverage||s.neededForCoverage&&!o)&&(e=t,(s.neededForCoverage||s.isCoverage)&&(i=!0),s.isCoverage&&(o=!0))}if(e.selectedForRendering=!0,i){h.symbols.push(e),l.show=!0;for(const e of l.parts)e.show=!0}else l.show=!1}}for(const e of o)e.symbols.sort(s);return!0}const l=this._symbolLayerSorter;return{work:r,get sortedSymbols(){return o.sort(l)}}},i._createOpacityJob=function(){const e=this._assignTileSymbolsOpacity,o=this._visibleTiles;let i=0;function s(o,t){const i=o.symbols;for(const[e,s]of i)r(s,t);e(o,t);for(const e of o.childrenTiles)s(e,t)}return{work(e){const n=performance.now();for(;i<o.length;i++){if(performance.now()-n>e)return!1;const r=o[i];if(t.isSome(r.parentTile))continue;s(r,performance.now())}return!0}}},o._createClass(e,[{key:"running",get:function(){return this._running}}]),e}();function r(e,o){for(const t of e){const e=t.unique;for(const t of e.parts){const s=t.targetOpacity>.5?1:-1;t.startOpacity+=s*((o-t.startTime)/i.FADE_DURATION),t.startOpacity=Math.min(Math.max(t.startOpacity,0),1),t.startTime=o,t.targetOpacity=e.show&&t.show?1:0}}}e.SymbolDeclutterer=n,Object.defineProperty(e,"__esModule",{value:!0})}));
