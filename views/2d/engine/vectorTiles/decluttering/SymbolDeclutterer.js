/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","./config"],(function(e,o,t){"use strict";function i(e,o){if(e.priority-o.priority)return e.priority-o.priority;const t=e.tile.key,i=o.tile.key;return t.world-i.world?t.world-i.world:t.level-i.level?t.level-i.level:t.row-i.row?t.row-i.row:t.col-i.col?t.col-i.col:e.xTile-o.xTile?e.xTile-o.xTile:e.yTile-o.yTile}let s=function(){function e(e,o,t,i,s,n){this._visibleTiles=e,this._symbolRepository=o,this._createCollisionJob=t,this._assignTileSymbolsOpacity=i,this._symbolLayerSorter=s,this._isLayerVisible=n,this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}var t=e.prototype;return t.setScreenSize=function(e,o){this._screenWidth===e&&this._screenHeight===o||this.restart(),this._screenWidth=e,this._screenHeight=o},t.restart=function(){this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0},t.continue=function(e){if(this._selectionJob||(this._selectionJob=this._createSelectionJob()),!this._selectionJobCompleted){const o=performance.now();if(!this._selectionJob.work(e))return!1;if(this._selectionJobCompleted=!0,0===(e=Math.max(0,e-(performance.now()-o))))return!1}if(this._collisionJob||(this._collisionJob=this._createCollisionJob(this._selectionJob.sortedSymbols,this._screenWidth,this._screenHeight)),!this._collisionJobCompleted){const o=performance.now();if(!this._collisionJob.work(e))return!1;if(this._collisionJobCompleted=!0,0===(e=Math.max(0,e-(performance.now()-o))))return!1}if(this._opacityJob||(this._opacityJob=this._createOpacityJob()),!this._opacityJobCompleted){const o=performance.now();if(!this._opacityJob.work(e))return!1;if(this._opacityJobCompleted=!0,0===(e=Math.max(0,e-(performance.now()-o))))return!1}return this._running=!1,!0},t._createSelectionJob=function(){const e=this._symbolRepository.uniqueSymbols,o=[];let t=0,s=0;const n=this._isLayerVisible;const r=this._symbolLayerSorter;return{work:function(r){let l;const c=performance.now();for(;s<e.length;s++,t=0){const i=e[s],a=i.styleLayerUID;if(!n(a)){o[s]||(o[s]={styleLayerUID:a,symbols:[]});continue}o[s]=o[s]||{styleLayerUID:a,symbols:[]};const h=o[s];for(;t<i.uniqueSymbols.length;t++){if(l=i.uniqueSymbols[t],t%100==99&&performance.now()-c>r)return!1;let e=null,o=!1,s=!1;for(const t of l.tileSymbols)if(t.selectedForRendering=!1,!s||!o){const i=t.tile;(!e||i.isCoverage||i.neededForCoverage&&!o)&&(e=t,(i.neededForCoverage||i.isCoverage)&&(s=!0),i.isCoverage&&(o=!0))}if(e.selectedForRendering=!0,s){h.symbols.push(e),l.show=!0;for(const e of l.parts)e.show=!0}else l.show=!1}}for(const e of o)e.symbols.sort(i);return!0},get sortedSymbols(){return o.sort(r)}}},t._createOpacityJob=function(){const e=this._assignTileSymbolsOpacity,o=this._visibleTiles;let t=0;function i(o,t){const s=o.symbols;for(const[e,o]of s)n(o,t);e(o,t);for(const e of o.childrenTiles)i(e,t)}return{work(e){const s=performance.now();for(;t<o.length;t++){if(performance.now()-s>e)return!1;const n=o[t];if(n.parentTile)continue;i(n,performance.now())}return!0}}},o._createClass(e,[{key:"running",get:function(){return this._running}}]),e}();function n(e,o){for(const i of e){const e=i.unique;for(const i of e.parts){const s=i.targetOpacity>.5?1:-1;i.startOpacity+=s*((o-i.startTime)/t.FADE_DURATION),i.startOpacity=Math.min(Math.max(i.startOpacity,0),1),i.startTime=o,i.targetOpacity=e.show&&i.show?1:0}}}e.SymbolDeclutterer=s,Object.defineProperty(e,"__esModule",{value:!0})}));
