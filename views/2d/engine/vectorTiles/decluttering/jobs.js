/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/mat3f32","./config","./util"],(function(e,t,n,o){"use strict";function r(e,t,n,o,r,i){const{iconRotationAlignment:s,textRotationAlignment:l,iconTranslate:c,iconTranslateAnchor:a,textTranslate:h,textTranslateAnchor:u}=o;let d=0;for(const o of e.colliders){const[e,y]=0===o.partIndex?c:h,x=0===o.partIndex?a:u,g=o.minLod<=i&&i<=o.maxLod;d+=g?0:1,o.enabled=g,o.xScreen=o.xTile*r[0]+o.yTile*r[3]+r[6],o.yScreen=o.xTile*r[1]+o.yTile*r[4]+r[7],0===x?(o.xScreen+=n*e-t*y,o.yScreen+=t*e+n*y):(o.xScreen+=e,o.yScreen+=y),1===(0===o.partIndex?s:l)?(o.dxScreen=o.dxPixels,o.dyScreen=o.dyPixels):(o.dxScreen=n*(o.dxPixels+o.width/2)-t*(o.dyPixels+o.height/2)-o.width/2,o.dyScreen=t*(o.dxPixels+o.width/2)+n*(o.dyPixels+o.height/2)-o.height/2)}e.colliders.length>0&&d===e.colliders.length&&(e.unique.show=!1)}let i=function(){function e(e,r,i,s,l,c){this._symbols=e,this._styleRepository=s,this._zoom=l,this._currentLayerCursor=0,this._currentSymbolCursor=0,this._styleProps=new Map,this._allNeededMatrices=new Map,this._gridIndex=new o.GridIndex(r,i,n.COLLISION_GRID_CELL_SIZE),this._si=Math.sin(Math.PI*c/180),this._co=Math.cos(Math.PI*c/180);for(const n of e)for(const e of n.symbols)this._allNeededMatrices.has(e.tile)||this._allNeededMatrices.set(e.tile,t.clone(e.tile.transforms.tileUnitsToPixels))}var i=e.prototype;return i.work=function(e){const t=this._gridIndex;function n(e){const n=e.xScreen+e.dxScreen,o=e.yScreen+e.dyScreen,r=n+e.width,i=o+e.height,[s,l,c,a]=t.getCellSpan(n,o,r,i);for(let e=l;e<=a;e++)for(let l=s;l<=c;l++){const s=t.cells[e][l];for(const e of s){const t=e.xScreen+e.dxScreen,s=e.yScreen+e.dyScreen,l=t+e.width,c=s+e.height;if(!(r<t||n>l||i<s||o>c))return!0}}return!1}const o=performance.now();for(;this._currentLayerCursor<this._symbols.length;this._currentLayerCursor++,this._currentSymbolCursor=0){const t=this._symbols[this._currentLayerCursor],i=this._getProperties(t.styleLayerUID);for(;this._currentSymbolCursor<t.symbols.length;this._currentSymbolCursor++){if(this._currentSymbolCursor%100==99&&performance.now()-o>e)return!1;const s=t.symbols[this._currentSymbolCursor];if(!s.unique.show)continue;r(s,this._si,this._co,i,this._allNeededMatrices.get(s.tile),this._zoom);const l=s.unique;if(!l.show)continue;const{iconAllowOverlap:c,iconIgnorePlacement:a,textAllowOverlap:h,textIgnorePlacement:u}=i;for(const e of s.colliders){if(!e.enabled)continue;const t=l.parts[e.partIndex];if(!t.show)continue;!(e.partIndex?h:c)&&n(e)&&(e.hard?l.show=!1:t.show=!1)}if(l.show)for(const e of s.colliders){if(!e.enabled)continue;if(e.partIndex?u:a)continue;if(!l.parts[e.partIndex].show)continue;const t=e.xScreen+e.dxScreen,n=e.yScreen+e.dyScreen,o=t+e.width,r=n+e.height,[i,s,c,h]=this._gridIndex.getCellSpan(t,n,o,r);for(let t=s;t<=h;t++)for(let n=i;n<=c;n++){this._gridIndex.cells[t][n].push(e)}}}}return!0},i._getProperties=function(e){const t=this._styleProps.get(e);if(t)return t;const n=this._zoom,o=this._styleRepository.getStyleLayerByUID(e),r=0!==o.getLayoutValue("symbol-placement",n);let i=o.getLayoutValue("icon-rotation-alignment",n);2===i&&(i=r?0:1);let s=o.getLayoutValue("text-rotation-alignment",n);2===s&&(s=r?0:1);const l=o.getPaintValue("icon-translate",n),c=o.getPaintValue("icon-translate-anchor",n),a=o.getPaintValue("text-translate",n),h=o.getPaintValue("text-translate-anchor",n),u={iconAllowOverlap:o.getLayoutValue("icon-allow-overlap",n),iconIgnorePlacement:o.getLayoutValue("icon-ignore-placement",n),textAllowOverlap:o.getLayoutValue("text-allow-overlap",n),textIgnorePlacement:o.getLayoutValue("text-ignore-placement",n),iconRotationAlignment:i,textRotationAlignment:s,iconTranslateAnchor:c,iconTranslate:l,textTranslateAnchor:h,textTranslate:a};return this._styleProps.set(e,u),u},e}();e.CollisionJob=i,Object.defineProperty(e,"__esModule",{value:!0})}));
