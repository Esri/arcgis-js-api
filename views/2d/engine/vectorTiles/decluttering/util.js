// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","../../../../../core/maybe","./core"],(function(t,e,r,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.writeOpacityToBuffers=e.deserializeSymbols=e.GridIndex=e.tileCoordChange=e.TileForest=e.TileGraph=e.TileNode=void 0;var o=function(t){this.tile=t,this.parent=null,this.children=new Set};e.TileNode=o;var n=function(){function t(){this.nodes=new Map,this.roots=new Set}return t.prototype.create=function(t){var e,r=this,i=new o(t),n=[];if(this.nodes.forEach((function(t){r._canConnectDirectly(i,t)&&n.push(t),!e&&r._canConnectDirectly(t,i)&&(e=t)})),e){for(var a=0,l=n;a<l.length;a++){var s=l[a];e.children.delete(s),i.children.add(s),s.parent=i}e.children.add(i),i.parent=e}else{this.roots.add(i);for(var h=0,c=n;h<c.length;h++){s=c[h];i.children.add(s),s.parent=i,this.roots.delete(s)}}return this.nodes.set(t.key.id,i),i},t.prototype.destroy=function(t){var e=this;r.isSome(t.parent)?(t.parent.children.delete(t),t.children.forEach((function(e){r.isSome(t.parent)&&t.parent.children.add(e)}))):this.roots.delete(t),t.children.forEach((function(r){r.parent=t.parent,t.parent||e.roots.add(r)})),this.nodes.delete(t.tile.key.id)},t.prototype.clear=function(){this.roots.clear(),this.nodes.clear()},t.prototype._canConnectDirectly=function(t,e){for(var r=e.tile.key,i=r.level,o=r.row,n=r.col,a=e.tile.key.world;i>0;){if(i--,o>>=1,n>>=1,t.tile.key.level===i&&t.tile.key.row===o&&t.tile.key.col===n&&t.tile.key.world===a)return!0;if(this.nodes.has(i+"/"+o+"/"+n+"/"+a))return!1}return!1},t}();e.TileGraph=n;var a=function(){function t(){this._tileGraph=new n,this._tileArray=null}return t.prototype.has=function(t){return this.hasKey(t.key.id)},t.prototype.getAll=function(){var t=this;return this._tileArray||(this._tileArray=[],this._tileGraph.nodes.forEach((function(e){t._tileArray.push(e.tile)}))),this._tileArray},t.prototype.getRoots=function(){var t=[];return this._tileGraph.roots.forEach((function(e){t.push(e.tile)})),t},t.prototype.getParent=function(t){var e=this._tileGraph.nodes.get(t.key.id);return r.isSome(e.parent)&&e.parent.tile},t.prototype.getChildren=function(t){var e=[];return this._tileGraph.nodes.get(t.key.id).children.forEach((function(t){e.push(t.tile)})),e},t.prototype.get=function(t){return this._tileGraph.nodes.get(t).tile},t.prototype.hasKey=function(t){return this._tileGraph.nodes.has(t)},t.prototype.removeKey=function(t){var e=this._tileGraph.nodes.get(t);this._tileGraph.destroy(e),this._tileArray=null},t.prototype.forEach=function(t){this._tileGraph.nodes.forEach((function(e,r){return t(e.tile,r)}))},t.prototype.add=function(t){this._tileGraph.create(t),this._tileArray=null},t.prototype.remove=function(t){var e=this._tileGraph.nodes.get(t.key.id);this._tileGraph.destroy(e),this._tileArray=null},t.prototype.clear=function(){this._tileGraph.clear(),this._tileArray=[]},t}();e.TileForest=a,e.tileCoordChange=function(t,e,r,i,o,n){var a=r-o;if(a>=0)return(e>>a)+(i-(n<<a))*(t>>a);var l=-a;return e-(n-(i<<l))*(t>>l)<<l};var l=function(){function t(t,e,r){this._rows=Math.ceil(e/r),this._columns=Math.ceil(t/r),this._cellSize=r,this.cells=new Array(this._rows);for(var i=0;i<this._rows;i++){this.cells[i]=new Array(this._columns);for(var o=0;o<this._columns;o++)this.cells[i][o]=[]}}return t.prototype.getCell=function(t,e){var r=Math.min(Math.max(Math.floor(e/this._cellSize),0),this._rows-1),i=Math.min(Math.max(Math.floor(t/this._cellSize),0),this._columns-1);return this.cells[r]&&this.cells[r][i]||null},t.prototype.getCellSpan=function(t,e,r,i){return[Math.min(Math.max(Math.floor(t/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(e/this._cellSize),0),this.rows-1),Math.min(Math.max(Math.floor(r/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(i/this._cellSize),0),this.rows-1)]},Object.defineProperty(t.prototype,"cellSize",{get:function(){return this._cellSize},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"columns",{get:function(){return this._columns},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rows",{get:function(){return this._rows},enumerable:!1,configurable:!0}),t}();e.GridIndex=l,e.deserializeSymbols=function(t,e,r,o,n){for(var a=e[o++],l=0;l<a;l++){var s=new i.VTLSymbol;s.xTile=e[o++],s.yTile=e[o++],s.hash=e[o++],s.priority=e[o++];for(var h=e[o++],c=0;c<h;c++){var u=e[o++],p=e[o++],d=e[o++],f=e[o++],y=!!e[o++],_=e[o++],v=r[o++],g=r[o++],m=e[o++],M=e[o++];s.colliders.push({xTile:u,yTile:p,dxPixels:d,dyPixels:f,hard:y,partIndex:_,width:m,height:M,minLod:v,maxLod:g})}for(var w=t[o++],x=0;x<w;x++)s.textVertexRanges.push([t[o++],t[o++]]);for(var S=t[o++],b=0;b<S;b++)s.iconVertexRanges.push([t[o++],t[o++]]);n.push(s)}return o},e.writeOpacityToBuffers=function(t,e,r){t.symbols.forEach((function(i,o){return function(t,e,r,i,o){var n=t.layerData[o];if(3!==n.type)return;for(var a=0,l=i;a<l.length;a++){var s=l[a],h=s.unique,c=void 0;if(s.selectedForRendering){var u=h.parts[0],p=u.startOpacity,d=u.targetOpacity;t.allSymbolsFadingOut=t.allSymbolsFadingOut&&0===d;var f=r?Math.floor(127*p)|d<<7:d?255:0;c=f<<24|f<<16|f<<8|f}else c=0;for(var y=0,_=s.iconVertexRanges;y<_.length;y++)for(var v=_[y],g=v[0],m=v[1],M=g;M<g+m;M+=4)n.iconOpacity[M/4]=c;if(s.selectedForRendering){var w=h.parts[1];p=w.startOpacity,d=w.targetOpacity;t.allSymbolsFadingOut=t.allSymbolsFadingOut&&0===d;f=r?Math.floor(127*p)|d<<7:d?255:0;c=f<<24|f<<16|f<<8|f}else c=0;for(var x=0,S=s.textVertexRanges;x<S.length;x++){var b=S[x],G=b[0],O=b[1];for(M=G;M<G+O;M+=4)n.textOpacity[M/4]=c}}n.lastOpacityUpdate=e,n.opacityChanged=!0}(t,e,r,i,o)}))}}));