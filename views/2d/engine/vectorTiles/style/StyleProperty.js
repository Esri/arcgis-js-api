/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../../../../../Color","../GeometryUtils","../expression/types","../expression/expression"],(function(t,e,i,r){"use strict";return function(){function n(t,e){let n;switch(this.isDataDriven=!1,this.interpolator=null,t.type){case"number":case"color":n=!0;break;case"array":n="number"===t.value;break;default:n=!1}if(null==e&&(e=t.default),Array.isArray(e)&&e.length>0&&r.ops[e[0]]){const n={number:i.NumberType,color:i.ColorType,string:i.StringType,boolean:i.BooleanType,enum:i.StringType};try{const a="array"===t.type?i.arrayType(n[t.value]||i.ValueType,t.length):n[t.type],l=r.createExpression(e,null,a);this.getValue=this._buildExpression(l,t),this.isDataDriven=!0,l instanceof r.Interpolate&&l.input instanceof r.Zoom&&(this.interpolator=l)}catch(l){console.log(l.message),this.getValue=this._buildSimple(t.default)}return}n&&"interval"===e.type&&(n=!1);const a=e&&e.stops&&e.stops.length>0;if(a)for(const i of e.stops)i[1]=this._validate(i[1],t);if(this.isDataDriven=!!e&&!!e.property,this.isDataDriven)if(void 0!==e.default&&(e.default=this._validate(e.default,t)),a)switch(e.type){case"identity":this.getValue=this._buildIdentity(e,t);break;case"categorical":this.getValue=this._buildCategorical(e,t);break;default:this.getValue=n?this._buildInterpolate(e,t):this._buildInterval(e,t)}else this.getValue=this._buildIdentity(e,t);else a?this.getValue=n?this._buildZoomInterpolate(e):this._buildZoomInterval(e):(e=this._validate(e,t),this.getValue=this._buildSimple(e))}var a=n.prototype;return a._validate=function(t,e){if("number"===e.type){if(t<e.minimum)return e.minimum;if(t>e.maximum)return e.maximum}else"color"===e.type?t=n._parseColor(t):"enum"===e.type?"string"==typeof t&&(t=e.values.indexOf(t)):"array"===e.type&&"enum"===e.value?t=t.map((i=>"string"==typeof t?e.values.indexOf(i):i)):"string"===e.type&&(t=i.valueToString(t));return t},a._buildSimple=function(t){return()=>t},a._buildExpression=function(t,e){return(i,r)=>{try{const n=t.evaluate(r,i);return void 0===n?e.default:this._validate(n,e)}catch(n){return console.log(n.message),e.default}}},a._buildIdentity=function(t,e){return(i,r)=>{let n;return r&&(n=r.values[t.property]),void 0!==n?this._validate(n,e):void 0!==t.default?t.default:e.default}},a._buildCategorical=function(t,e){return(i,r)=>{let n;return r&&(n=r.values[t.property]),n=this._categorical(n,t.stops),void 0!==n?n:void 0!==t.default?t.default:e.default}},a._buildInterval=function(t,e){return(i,r)=>{let n;return r&&(n=r.values[t.property]),"number"==typeof n?this._interval(n,t.stops):void 0!==t.default?t.default:e.default}},a._buildInterpolate=function(t,e){return(i,r)=>{let n;return r&&(n=r.values[t.property]),"number"==typeof n?this._interpolate(n,t.stops,t.base||1):void 0!==t.default?t.default:e.default}},a._buildZoomInterpolate=function(t){return e=>this._interpolate(e,t.stops,t.base||1)},a._buildZoomInterval=function(t){return e=>this._interval(e,t.stops)},a._categorical=function(t,e){const i=e.length;for(let r=0;r<i;r++)if(e[r][0]===t)return e[r][1]},a._interval=function(t,e){const i=e.length;let r=0;for(let n=0;n<i&&e[n][0]<=t;n++)r=n;return e[r][1]},a._interpolate=function(t,i,r){let n,a;const l=i.length;for(let e=0;e<l;e++){const r=i[e];if(!(r[0]<=t)){a=r;break}n=r}if(n&&a){const i=a[0]-n[0],l=t-n[0],o=1===r?l/i:(r**l-1)/(r**i-1);if(Array.isArray(n[1])){const t=n[1],i=a[1],r=[];for(let n=0;n<t.length;n++)r.push(e.interpolate(t[n],i[n],o));return r}return e.interpolate(n[1],a[1],o)}return n?n[1]:a?a[1]:void 0},n._isEmpty=function(t){for(const e in t)if(t.hasOwnProperty(e))return!1;return!0},n._parseColor=function(e){return Array.isArray(e)?e:("string"==typeof e&&(e=new t(e)),e instanceof t?this._isEmpty(e)?void 0:t.toUnitRGBA(e):e)},n}()}));
