/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["./StyleLayer"],(function(e){"use strict";return function(){function t(e){if(this._style=e,this.backgroundBucketIds=[],this._uidToLayer=new Map,this._layerByName={},this._runningId=0,e.layers||(e.layers=[]),this.version=parseFloat(e.version),this.layers=e.layers.map(((e,t,r)=>this._create(e,t,r))),this.layers){let e;for(let t=0;t<this.layers.length;t++)e=this.layers[t],this._layerByName[e.id]=e,this._uidToLayer.set(e.uid,e),0===e.type&&this.backgroundBucketIds.push(e.id)}this._identifyRefLayers()}var r=t.prototype;return r.isPainterDataDriven=function(e){const t=this._layerByName[e];return!!t&&t.isPainterDataDriven()},r.getStyleLayerId=function(e){return e>=this.layers.length?null:this.layers[e].id},r.getStyleLayerByUID=function(e){const t=this._uidToLayer.get(e);return null!=t?t:null},r.getStyleLayerIndex=function(e){const t=this._layerByName[e];return t?this.layers.indexOf(t):-1},r.setStyleLayer=function(e,r){if(!e||!e.id)return;const i=this._style;null!=r&&r>=this.layers.length&&(r=this.layers.length-1);let s,a=!0;const l=this._layerByName[e.id];if(l){const y=this.layers.indexOf(l);r||(r=y),r===y?(a=!1,s=t._recreateLayer(e,l),this.layers[r]=s,i.layers[r]=e):(this.layers.splice(y,1),i.layers.splice(y,1),s=this._create(e,r,this.layers),this.layers.splice(r,0,s),i.layers.splice(r,0,e))}else s=this._create(e,r,this.layers),!r||r>=this.layers.length?(this.layers.push(s),i.layers.push(e)):(this.layers.splice(r,0,s),i.layers.splice(r,0,e));this._layerByName[e.id]=s,this._uidToLayer.set(s.uid,s),a&&this._recomputeZValues(),this._identifyRefLayers()},r.getStyleLayer=function(e){const t=this._layerByName[e];return t?{type:t.typeName,id:t.id,source:t.source,"source-layer":t.sourceLayer,minzoom:t.minzoom,maxzoom:t.maxzoom,filter:t.filter,layout:t.layout,paint:t.paint}:null},r.deleteStyleLayer=function(e){const t=this._layerByName[e];if(t){delete this._layerByName[e],this._uidToLayer.delete(t.uid);const r=this.layers.indexOf(t);this.layers.splice(r,1),this._style.layers.splice(r,1),this._recomputeZValues(),this._identifyRefLayers()}},r.getLayerById=function(e){return this._layerByName[e]},r.getLayoutProperties=function(e){const t=this._layerByName[e];return t?t.layout:null},r.getPaintProperties=function(e){const t=this._layerByName[e];return t?t.paint:null},r.setPaintProperties=function(e,r){const i=this._layerByName[e];if(!i)return;const s={type:i.typeName,id:i.id,source:i.source,"source-layer":i.sourceLayer,minzoom:i.minzoom,maxzoom:i.maxzoom,filter:i.filter,layout:i.layout,paint:r},a=t._recreateLayer(s,i),l=this.layers.indexOf(i);this.layers[l]=a,this._style.layers[l].paint=r,this._layerByName[i.id]=a,this._uidToLayer.set(i.uid,a)},r.setLayoutProperties=function(e,r){const i=this._layerByName[e];if(!i)return;const s={type:i.typeName,id:i.id,source:i.source,"source-layer":i.sourceLayer,minzoom:i.minzoom,maxzoom:i.maxzoom,filter:i.filter,layout:r,paint:i.paint},a=t._recreateLayer(s,i),l=this.layers.indexOf(i);this.layers[l]=a,this._style.layers[l].layout=r,this._layerByName[i.id]=a,this._uidToLayer.set(i.uid,a)},r.setStyleLayerVisibility=function(e,r){const i=this._layerByName[e];if(!i)return;const s=i.layout||{};s.visibility=r;const a={type:i.typeName,id:i.id,source:i.source,"source-layer":i.sourceLayer,minzoom:i.minzoom,maxzoom:i.maxzoom,filter:i.filter,layout:s,paint:i.paint},l=t._recreateLayer(a,i),y=this.layers.indexOf(i);this.layers[y]=l,this._style.layers[y].layout=s,this._layerByName[i.id]=l,this._uidToLayer.set(i.uid,l)},r.getStyleLayerVisibility=function(e){var t;const r=this._layerByName[e];if(!r)return"none";const i=r.layout;return null!=(t=null==i?void 0:i.visibility)?t:"visible"},r._recomputeZValues=function(){const e=this.layers,t=1/(e.length+1);for(let r=0;r<e.length;r++)e[r].z=1-(1+r)*t},r._identifyRefLayers=function(){const e=[],t=[];let r=0;for(const a of this.layers){const l=a.layout;if(1===a.type){var i;const t=a;let s=a.source+"|"+a.sourceLayer;s+=null!=(i="|"+(null==l?void 0:l.visibility))?i:"",s+="|"+a.minzoom,s+="|"+a.maxzoom,s+="|"+JSON.stringify(a.filter),(t.hasDataDrivenFill||t.hasDataDrivenOutline)&&(s+="|"+r),e.push({key:s,layer:a})}else if(2===a.type){var s;const e=a;let i=a.source+"|"+a.sourceLayer;i+=null!=(s="|"+(null==l?void 0:l.visibility))?s:"",i+="|"+a.minzoom,i+="|"+a.maxzoom,i+="|"+JSON.stringify(a.filter),i+="|"+(void 0!==l?l["line-cap"]:""),i+="|"+(void 0!==l?l["line-join"]:""),e.hasDataDrivenLine&&(i+="|"+r),t.push({key:i,layer:a})}++r}this._assignRefLayers(e),this._assignRefLayers(t)},r._assignRefLayers=function(e){let t,r;e.sort(((e,t)=>e.key<t.key?-1:e.key>t.key?1:0));const i=e.length;for(let s=0;s<i;s++){const a=e[s];if(a.key===t)a.layer.refLayerId=r;else if(t=a.key,r=a.layer.id,1===a.layer.type){if(!a.layer.getPaintProperty("fill-outline-color"))for(let l=s+1;l<i;l++){const i=e[l];if(i.key!==t)break;if(i.layer.getPaintProperty("fill-outline-color")){e[s]=i,e[l]=a,r=i.layer.id;break}}}else if(2===a.layer.type){let l=a.layer;for(let y=s+1;y<i;y++){const i=e[y];if(i.key!==t)break;const n=i.layer;(l.canUseThinTessellation&&!n.canUseThinTessellation||!l.canUseThinTessellation&&(n.getPaintProperty("line-pattern")||n.getPaintProperty("line-dasharray")))&&(l=n,e[s]=i,e[y]=a,r=i.layer.id)}}}},r._create=function(t,r,i){const s=1-(1+r)*(1/(i.length+1)),a=this._runningId++;switch(t.type){case"background":return new e.BackgroundStyleLayer(0,t,s,a);case"fill":return new e.FillStyleLayer(1,t,s,a);case"line":return new e.LineStyleLayer(2,t,s,a);case"symbol":return new e.SymbolStyleLayer(3,t,s,a);case"raster":throw new Error("Unsupported vector tile raster layer");case"circle":return new e.CircleStyleLayer(4,t,s,a)}throw new Error("Unknown vector tile layer")},t._recreateLayer=function(t,r){switch(t.type){case"background":return new e.BackgroundStyleLayer(0,t,r.z,r.uid);case"fill":return new e.FillStyleLayer(1,t,r.z,r.uid);case"line":return new e.LineStyleLayer(2,t,r.z,r.uid);case"symbol":return new e.SymbolStyleLayer(3,t,r.z,r.uid);case"raster":throw new Error("Unsupported vector tile raster layer");case"circle":return new e.CircleStyleLayer(4,t,r.z,r.uid)}},t}()}));
