/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{C_DEG_TO_RAD as e,C_PI as t,C_INFINITY as i,radToByte as n,positiveMod as s,C_2PI as o}from"./GeometryUtils.js";import{SDF_GLYPH_SIZE as a,TextShaping as l,SDF_GLYPH_BASELINE as h}from"./TextShaping.js";import{DECLUTTER_TILES as r}from"./decluttering/config.js";import{RotationAlignment as c,SymbolAnchor as g}from"./style/StyleDefinition.js";import{Point as m}from"../webgl/Geometry.js";const x=4096,d=512,w=8,p=.5,y=2;class T{constructor(e,t,i=0,n=-1,s=p){this.x=e,this.y=t,this.angle=i,this.segment=n,this.minzoom=s}}class f{constructor(e,t,n,s,o,a=p,l=i){this.anchor=e,this.labelAngle=t,this.glyphAngle=n,this.page=s,this.alternateVerticalGlyph=o,this.minzoom=a,this.maxzoom=l}}class I{constructor(e,t,i,n,s,o,a,l,h,r,c,g){this.tl=e,this.tr=t,this.bl=i,this.br=n,this.mosaicRect=s,this.labelAngle=o,this.minAngle=a,this.maxAngle=l,this.anchor=h,this.minzoom=r,this.maxzoom=c,this.page=g}}class b{constructor(e){this.shapes=e}}class u{getIconPlacement(i,n,s){const o=new m(i.x,i.y),a=s.rotationAlignment===c.MAP,l=s.keepUpright;let h=s.rotate*e;a&&(h+=i.angle);const g=new b([]);return s.allowOverlap&&s.ignorePlacement||!r||(g.iconColliders=[]),this._addIconPlacement(g,o,n,s,h),a&&l&&this._addIconPlacement(g,o,n,s,h+t),g}_addIconPlacement(e,t,n,s,o){const a=n.pixelRatio,l=n.width/a,h=n.height/a,c=s.offset;let x=c[0],d=c[1];switch(s.anchor){case g.CENTER:x-=l/2,d-=h/2;break;case g.LEFT:d-=h/2;break;case g.RIGHT:x-=l,d-=h/2;break;case g.TOP:x-=l/2;break;case g.BOTTOM:x-=l/2,d-=h;break;case g.TOP_LEFT:break;case g.BOTTOM_LEFT:d-=h;break;case g.TOP_RIGHT:x-=l;break;case g.BOTTOM_RIGHT:x-=l,d-=h}const w=n.rect,y=2/a,T=x-y,f=d-y,b=T+w.width/a,u=f+w.height/a,P=new m(T,f),O=new m(b,u),_=new m(T,u),k=new m(b,f);if(0!==o){const e=Math.cos(o),t=Math.sin(o);P.rotate(e,t),O.rotate(e,t),_.rotate(e,t),k.rotate(e,t)}const M=new I(P,k,_,O,w,o,0,256,t,p,i,0);if(e.shapes.push(M),(!s.allowOverlap||!s.ignorePlacement)&&r){const n=s.size,a=s.padding,r={xTile:t.x,yTile:t.y,dxPixels:x*n-a,dyPixels:d*n-a,hard:!s.optional,partIndex:0,width:l*n+2*a,height:h*n+2*a,angle:o,minLod:p,maxLod:i};e.iconColliders.push(r)}}getTextPlacement(n,s,o,r){const x=new m(n.x,n.y),d=r.rotate*e,T=r.rotationAlignment===c.MAP,u=r.keepUpright,P=r.padding;let O=p;const _=!T?0:n.angle,k=n.segment>=0&&T,M=r.allowOverlap&&r.ignorePlacement?null:[],E=[],G=4,N=!k;let A=Number.POSITIVE_INFINITY,L=Number.NEGATIVE_INFINITY,z=A,F=L;const v=(k||T)&&u,R=r.size/a;let B=!1;for(const e of s)if(e.vertical){B=!0;break}let H,V=0,j=0;if(!k&&B){const e=l.getTextBox(s,r.lineHeight*a);switch(r.anchor){case g.LEFT:V=e.height/2,j=-e.width/2;break;case g.RIGHT:V=-e.height/2,j=e.width/2;break;case g.TOP:V=e.height/2,j=e.width/2;break;case g.BOTTOM:V=-e.height/2,j=-e.width/2;break;case g.TOP_LEFT:V=e.height;break;case g.BOTTOM_LEFT:j=-e.width;break;case g.TOP_RIGHT:j=e.width;break;case g.BOTTOM_RIGHT:V=-e.height}}V+=r.offset[0]*a,j+=r.offset[1]*a;for(const e of s){const s=e.glyphMosaicItem;if(!s||s.rect.isEmpty)continue;const a=s.rect,l=s.metrics,c=s.page;if(M&&N){if(void 0!==H&&H!==e.y){let e,t,s,o;B?(e=-F+V,t=A+j,s=F-z,o=L-A):(e=A+V,t=z+j,s=L-A,o=F-z);const a={xTile:n.x,yTile:n.y,dxPixels:e*R-P,dyPixels:t*R-P,hard:!r.optional,partIndex:1,width:s*R+2*P,height:o*R+2*P,angle:d,minLod:p,maxLod:i};M.push(a),A=Number.POSITIVE_INFINITY,L=Number.NEGATIVE_INFINITY,z=A,F=L}H=e.y}const g=[];if(k){const t=.5*s.metrics.width,i=(e.x+l.left-G+t)*R*w;if(O=this._placeGlyph(n,O,i,o,n.segment,1,e.vertical,c,g),u&&(O=this._placeGlyph(n,O,i,o,n.segment,-1,e.vertical,c,g)),O>=y)break}else g.push(new f(x,_,_,c,!1)),T&&u&&g.push(new f(x,_+t,_+t,c,!1));const b=e.x+l.left,C=e.y-h-l.top,S=b+l.width,Y=C+l.height;let q,U,D,J,K,Q,W,X;if(!k&&B)if(e.vertical){const e=(b+S)/2-l.height/2,t=(C+Y)/2+l.width/2;q=new m(-t-G+V,e-G+j),U=new m(q.x+a.width,q.y+a.height),D=new m(q.x,U.y),J=new m(U.x,q.y)}else q=new m(-C+G+V,b-G+j),U=new m(q.x-a.height,q.y+a.width),D=new m(U.x,q.y),J=new m(q.x,U.y);else q=new m(b-G+V,C-G+j),U=new m(q.x+a.width,q.y+a.height),D=new m(q.x,U.y),J=new m(U.x,q.y);for(const t of g){let i,s,o,h;if(t.alternateVerticalGlyph){if(!K){const e=(C+Y)/2+j;K=new m((b+S)/2+V-l.height/2-G,e+l.width/2+G),Q=new m(K.x+a.height,K.y-a.width),W=new m(Q.x,K.y),X=new m(K.x,Q.y)}i=K,s=W,o=X,h=Q}else i=q,s=D,o=J,h=U;const c=C,g=Y,x=t.glyphAngle+d;if(0!==x){const e=Math.cos(x),t=Math.sin(x);i=i.clone(),s=s.clone(),o=o.clone(),h=h.clone(),i.rotate(e,t),h.rotate(e,t),s.rotate(e,t),o.rotate(e,t)}let w=0,p=256;if(k&&B?e.vertical?t.alternateVerticalGlyph?(w=32,p=96):(w=224,p=32):(w=224,p=96):(w=192,p=64),E.push(new I(i,o,s,h,a,t.labelAngle,w,p,t.anchor,t.minzoom,t.maxzoom,t.page)),M&&(!v||this._legible(t.labelAngle)))if(N)b<A&&(A=b),c<z&&(z=c),S>L&&(L=S),g>F&&(F=g);else if(t.minzoom<y){const e={xTile:n.x,yTile:n.y,dxPixels:(b+V)*R-P,dyPixels:(c+V)*R-P,hard:!r.optional,partIndex:1,width:(S-b)*R+2*P,height:(g-c)*R+2*P,angle:x,minLod:t.minzoom,maxLod:t.maxzoom};M.push(e)}}}if(O>=y)return null;if(M&&N){let e,t,s,o;B?(e=-F+V,t=A+j,s=F-z,o=L-A):(e=A+V,t=z+j,s=L-A,o=F-z);const a={xTile:n.x,yTile:n.y,dxPixels:e*R-P,dyPixels:t*R-P,hard:!r.optional,partIndex:1,width:s*R+2*P,height:o*R+2*P,angle:d,minLod:p,maxLod:i};M.push(a)}const C=new b(E);return M&&M.length>0&&(C.textColliders=M),C}_legible(e){const t=n(e);return t<65||t>=193}_placeGlyph(e,n,a,l,h,r,c,g,x){let d=r;const w=d<0?s(e.angle+t,o):e.angle;let p=0;a<0&&(d*=-1,a*=-1,p=t),d>0&&++h;let y=new m(e.x,e.y),T=l[h],I=i;if(l.length<=h)return I;for(;;){const e=T.x-y.x,t=T.y-y.y,i=Math.sqrt(e*e+t*t),r=Math.max(a/i,n),m=e/i,b=t/i,u=s(Math.atan2(b,m)+p,o);if(x.push(new f(y,w,u,g,!1,r,I)),c&&x.push(new f(y,w,u,g,!0,r,I)),r<=n)return r;y=T.clone();do{if(h+=d,l.length<=h||h<0)return r;T=l[h]}while(y.isEqual(T));let P=T.x-y.x,O=T.y-y.y;const _=Math.sqrt(P*P+O*O);P*=i/_,O*=i/_,y.x-=P,y.y-=O,I=r}}}export{T as Anchor,I as PlacedSymbol,b as Placement,u as PlacementEngine,x as TILE_COORD_SIZE,w as TILE_PIXEL_RATIO,d as TILE_PIXEL_SIZE};
