/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","./GeometryUtils","./decluttering/config","../webgl/Geometry","./TextShaping"],(function(e,t,n,i,o){"use strict";const a=.5;let l=function(e,n,i,o,a,l=.5,s=t.C_INFINITY){this.anchor=e,this.labelAngle=n,this.glyphAngle=i,this.page=o,this.alternateVerticalGlyph=a,this.minzoom=l,this.maxzoom=s},s=function(e,t,n,i,o,a,l,s,h,c,r,g){this.tl=e,this.tr=t,this.bl=n,this.br=i,this.mosaicRect=o,this.labelAngle=a,this.minAngle=l,this.maxAngle=s,this.anchor=h,this.minzoom=c,this.maxzoom=r,this.page=g},h=function(e){this.shapes=e},c=function(){function e(){}var c=e.prototype;return c.getIconPlacement=function(e,o,a){const l=new i.Point(e.x,e.y),s=0===a.rotationAlignment,c=a.keepUpright;let r=a.rotate*t.C_DEG_TO_RAD;s&&(r+=e.angle);const g=new h([]);return a.allowOverlap&&a.ignorePlacement||!n.DECLUTTER_TILES||(g.iconColliders=[]),this._addIconPlacement(g,l,o,a,r),s&&c&&this._addIconPlacement(g,l,o,a,r+t.C_PI),g},c._addIconPlacement=function(e,o,l,h,c){const r=l.pixelRatio,g=l.width/r,d=l.height/r,I=h.offset;let x=I[0],m=I[1];switch(h.anchor){case 0:x-=g/2,m-=d/2;break;case 1:m-=d/2;break;case 2:x-=g,m-=d/2;break;case 3:x-=g/2;break;case 4:x-=g/2,m-=d;break;case 5:break;case 7:m-=d;break;case 6:x-=g;break;case 8:x-=g,m-=d}const P=l.rect,w=2/r,p=x-w,f=m-w,y=p+P.width/r,_=f+P.height/r,u=new i.Point(p,f),T=new i.Point(y,_),b=new i.Point(p,_),E=new i.Point(y,f);if(0!==c){const e=Math.cos(c),t=Math.sin(c);u.rotate(e,t),T.rotate(e,t),b.rotate(e,t),E.rotate(e,t)}const N=new s(u,E,b,T,P,c,0,256,o,a,t.C_INFINITY,0);if(e.shapes.push(N),(!h.allowOverlap||!h.ignorePlacement)&&n.DECLUTTER_TILES){const n=h.size,i=h.padding,l={xTile:o.x,yTile:o.y,dxPixels:x*n-i,dyPixels:m*n-i,hard:!h.optional,partIndex:0,width:g*n+2*i,height:d*n+2*i,angle:c,minLod:a,maxLod:t.C_INFINITY};e.iconColliders.push(l)}},c.getTextPlacement=function(e,n,c,r){const g=new i.Point(e.x,e.y),d=r.rotate*t.C_DEG_TO_RAD,I=0===r.rotationAlignment,x=r.keepUpright,m=r.padding;let P=a;const w=!I?0:e.angle,p=e.segment>=0&&I,f=r.allowOverlap&&r.ignorePlacement?null:[],y=[],_=!p;let u=Number.POSITIVE_INFINITY,T=Number.NEGATIVE_INFINITY,b=u,E=T;const N=(p||I)&&x,L=r.size/o.SDF_GLYPH_SIZE;let C=!1;for(const e of n)if(e.vertical){C=!0;break}let k,S=0,A=0;if(!p&&C){const e=o.TextShaping.getTextBox(n,r.lineHeight*o.SDF_GLYPH_SIZE);switch(r.anchor){case 1:S=e.height/2,A=-e.width/2;break;case 2:S=-e.height/2,A=e.width/2;break;case 3:S=e.height/2,A=e.width/2;break;case 4:S=-e.height/2,A=-e.width/2;break;case 5:S=e.height;break;case 7:A=-e.width;break;case 6:A=e.width;break;case 8:S=-e.height}}S+=r.offset[0]*o.SDF_GLYPH_SIZE,A+=r.offset[1]*o.SDF_GLYPH_SIZE;for(const h of n){const n=h.glyphMosaicItem;if(!n||n.rect.isEmpty)continue;const G=n.rect,F=n.metrics,Y=n.page;if(f&&_){if(void 0!==k&&k!==h.y){let n,i,o,l;C?(n=-E+S,i=u+A,o=E-b,l=T-u):(n=u+S,i=b+A,o=T-u,l=E-b);const s={xTile:e.x,yTile:e.y,dxPixels:n*L-m,dyPixels:i*L-m,hard:!r.optional,partIndex:1,width:o*L+2*m,height:l*L+2*m,angle:d,minLod:a,maxLod:t.C_INFINITY};f.push(s),u=Number.POSITIVE_INFINITY,T=Number.NEGATIVE_INFINITY,b=u,E=T}k=h.y}const v=[];if(p){const t=.5*n.metrics.width,i=(h.x+F.left-4+t)*L*8;if(P=this._placeGlyph(e,P,i,c,e.segment,1,h.vertical,Y,v),x&&(P=this._placeGlyph(e,P,i,c,e.segment,-1,h.vertical,Y,v)),P>=2)break}else v.push(new l(g,w,w,Y,!1)),I&&x&&v.push(new l(g,w+t.C_PI,w+t.C_PI,Y,!1));const z=h.x+F.left,D=h.y-o.SDF_GLYPH_BASELINE-F.top,M=z+F.width,O=D+F.height;let R,V,H,Z,U,q,B,X;if(!p&&C)if(h.vertical){const e=(z+M)/2-F.height/2,t=(D+O)/2+F.width/2;R=new i.Point(-t-4+S,e-4+A),V=new i.Point(R.x+G.width,R.y+G.height),H=new i.Point(R.x,V.y),Z=new i.Point(V.x,R.y)}else R=new i.Point(4-D+S,z-4+A),V=new i.Point(R.x-G.height,R.y+G.width),H=new i.Point(V.x,R.y),Z=new i.Point(R.x,V.y);else R=new i.Point(z-4+S,D-4+A),V=new i.Point(R.x+G.width,R.y+G.height),H=new i.Point(R.x,V.y),Z=new i.Point(V.x,R.y);for(const t of v){let n,o,a,l;if(t.alternateVerticalGlyph){if(!U){const e=(z+M)/2+S,t=(D+O)/2+A;U=new i.Point(e-F.height/2-4,t+F.width/2+4),q=new i.Point(U.x+G.height,U.y-G.width),B=new i.Point(q.x,U.y),X=new i.Point(U.x,q.y)}n=U,o=B,a=X,l=q}else n=R,o=H,a=Z,l=V;const c=D,g=O,I=t.glyphAngle+d;if(0!==I){const e=Math.cos(I),t=Math.sin(I);n=n.clone(),o=o.clone(),a=a.clone(),l=l.clone(),n.rotate(e,t),l.rotate(e,t),o.rotate(e,t),a.rotate(e,t)}let x=0,P=256;if(p&&C?h.vertical?t.alternateVerticalGlyph?(x=32,P=96):(x=224,P=32):(x=224,P=96):(x=192,P=64),y.push(new s(n,a,o,l,G,t.labelAngle,x,P,t.anchor,t.minzoom,t.maxzoom,t.page)),f&&(!N||this._legible(t.labelAngle)))if(_)z<u&&(u=z),c<b&&(b=c),M>T&&(T=M),g>E&&(E=g);else if(t.minzoom<2){const n={xTile:e.x,yTile:e.y,dxPixels:(z+S)*L-m,dyPixels:(c+S)*L-m,hard:!r.optional,partIndex:1,width:(M-z)*L+2*m,height:(g-c)*L+2*m,angle:I,minLod:t.minzoom,maxLod:t.maxzoom};f.push(n)}}}if(P>=2)return null;if(f&&_){let n,i,o,l;C?(n=-E+S,i=u+A,o=E-b,l=T-u):(n=u+S,i=b+A,o=T-u,l=E-b);const s={xTile:e.x,yTile:e.y,dxPixels:n*L-m,dyPixels:i*L-m,hard:!r.optional,partIndex:1,width:o*L+2*m,height:l*L+2*m,angle:d,minLod:a,maxLod:t.C_INFINITY};f.push(s)}const G=new h(y);return f&&f.length>0&&(G.textColliders=f),G},c._legible=function(e){const n=t.radToByte(e);return n<65||n>=193},c._placeGlyph=function(e,n,o,a,s,h,c,r,g){let d=h;const I=d<0?t.positiveMod(e.angle+t.C_PI,t.C_2PI):e.angle;let x=0;o<0&&(d*=-1,o*=-1,x=t.C_PI),d>0&&++s;let m=new i.Point(e.x,e.y),P=a[s],w=t.C_INFINITY;if(a.length<=s)return w;for(;;){const e=P.x-m.x,i=P.y-m.y,h=Math.sqrt(e*e+i*i),p=Math.max(o/h,n),f=e/h,y=i/h,_=t.positiveMod(Math.atan2(y,f)+x,t.C_2PI);if(g.push(new l(m,I,_,r,!1,p,w)),c&&g.push(new l(m,I,_,r,!0,p,w)),p<=n)return p;m=P.clone();do{if(s+=d,a.length<=s||s<0)return p;P=a[s]}while(m.isEqual(P));let u=P.x-m.x,T=P.y-m.y;const b=Math.sqrt(u*u+T*T);u*=h/b,T*=h/b,m.x-=u,m.y-=T,w=p}},e}();e.Anchor=function(e,t,n=0,i=-1,o=.5){this.x=e,this.y=t,this.angle=n,this.segment=i,this.minzoom=o},e.PlacedSymbol=s,e.Placement=h,e.PlacementEngine=c,e.TILE_COORD_SIZE=4096,e.TILE_PIXEL_RATIO=8,e.TILE_PIXEL_SIZE=512,Object.defineProperty(e,"__esModule",{value:!0})}));
