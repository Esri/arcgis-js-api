/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","./GeometryUtils","./TextShaping","./decluttering/config","../webgl/Geometry"],(function(e,t,n,i,o){"use strict";const a=4096,l=512,s=8,h=.5,c=2;let r=function(e,t,n=0,i=-1,o=h){this.x=e,this.y=t,this.angle=n,this.segment=i,this.minzoom=o},g=function(e,n,i,o,a,l=h,s=t.C_INFINITY){this.anchor=e,this.labelAngle=n,this.glyphAngle=i,this.page=o,this.alternateVerticalGlyph=a,this.minzoom=l,this.maxzoom=s},d=function(e,t,n,i,o,a,l,s,h,c,r,g){this.tl=e,this.tr=t,this.bl=n,this.br=i,this.mosaicRect=o,this.labelAngle=a,this.minAngle=l,this.maxAngle=s,this.anchor=h,this.minzoom=c,this.maxzoom=r,this.page=g},I=function(e){this.shapes=e},x=function(){function e(){}var a=e.prototype;return a.getIconPlacement=function(e,n,a){const l=new o.Point(e.x,e.y),s=0===a.rotationAlignment,h=a.keepUpright;let c=a.rotate*t.C_DEG_TO_RAD;s&&(c+=e.angle);const r=new I([]);return a.allowOverlap&&a.ignorePlacement||!i.DECLUTTER_TILES||(r.iconColliders=[]),this._addIconPlacement(r,l,n,a,c),s&&h&&this._addIconPlacement(r,l,n,a,c+t.C_PI),r},a._addIconPlacement=function(e,n,a,l,s){const c=a.pixelRatio,r=a.width/c,g=a.height/c,I=l.offset;let x=I[0],m=I[1];switch(l.anchor){case 0:x-=r/2,m-=g/2;break;case 1:m-=g/2;break;case 2:x-=r,m-=g/2;break;case 3:x-=r/2;break;case 4:x-=r/2,m-=g;break;case 5:break;case 7:m-=g;break;case 6:x-=r;break;case 8:x-=r,m-=g}const P=a.rect,w=2/c,p=x-w,f=m-w,y=p+P.width/c,_=f+P.height/c,u=new o.Point(p,f),T=new o.Point(y,_),b=new o.Point(p,_),E=new o.Point(y,f);if(0!==s){const e=Math.cos(s),t=Math.sin(s);u.rotate(e,t),T.rotate(e,t),b.rotate(e,t),E.rotate(e,t)}const N=new d(u,E,b,T,P,s,0,256,n,h,t.C_INFINITY,0);if(e.shapes.push(N),(!l.allowOverlap||!l.ignorePlacement)&&i.DECLUTTER_TILES){const i=l.size,o=l.padding,a={xTile:n.x,yTile:n.y,dxPixels:x*i-o,dyPixels:m*i-o,hard:!l.optional,partIndex:0,width:r*i+2*o,height:g*i+2*o,angle:s,minLod:h,maxLod:t.C_INFINITY};e.iconColliders.push(a)}},a.getTextPlacement=function(e,i,a,l){const r=new o.Point(e.x,e.y),x=l.rotate*t.C_DEG_TO_RAD,m=0===l.rotationAlignment,P=l.keepUpright,w=l.padding;let p=h;const f=!m?0:e.angle,y=e.segment>=0&&m,_=l.allowOverlap&&l.ignorePlacement?null:[],u=[],T=4,b=!y;let E=Number.POSITIVE_INFINITY,N=Number.NEGATIVE_INFINITY,L=E,C=N;const k=(y||m)&&P,S=l.size/n.SDF_GLYPH_SIZE;let A=!1;for(const t of i)if(t.vertical){A=!0;break}let G,F=0,Y=0;if(!y&&A){const e=n.TextShaping.getTextBox(i,l.lineHeight*n.SDF_GLYPH_SIZE);switch(l.anchor){case 1:F=e.height/2,Y=-e.width/2;break;case 2:F=-e.height/2,Y=e.width/2;break;case 3:F=e.height/2,Y=e.width/2;break;case 4:F=-e.height/2,Y=-e.width/2;break;case 5:F=e.height;break;case 7:Y=-e.width;break;case 6:Y=e.width;break;case 8:F=-e.height}}F+=l.offset[0]*n.SDF_GLYPH_SIZE,Y+=l.offset[1]*n.SDF_GLYPH_SIZE;for(const I of i){const i=I.glyphMosaicItem;if(!i||i.rect.isEmpty)continue;const v=i.rect,z=i.metrics,D=i.page;if(_&&b){if(void 0!==G&&G!==I.y){let n,i,o,a;A?(n=-C+F,i=E+Y,o=C-L,a=N-E):(n=E+F,i=L+Y,o=N-E,a=C-L);const s={xTile:e.x,yTile:e.y,dxPixels:n*S-w,dyPixels:i*S-w,hard:!l.optional,partIndex:1,width:o*S+2*w,height:a*S+2*w,angle:x,minLod:h,maxLod:t.C_INFINITY};_.push(s),E=Number.POSITIVE_INFINITY,N=Number.NEGATIVE_INFINITY,L=E,C=N}G=I.y}const M=[];if(y){const t=.5*i.metrics.width,n=(I.x+z.left-T+t)*S*s;if(p=this._placeGlyph(e,p,n,a,e.segment,1,I.vertical,D,M),P&&(p=this._placeGlyph(e,p,n,a,e.segment,-1,I.vertical,D,M)),p>=c)break}else M.push(new g(r,f,f,D,!1)),m&&P&&M.push(new g(r,f+t.C_PI,f+t.C_PI,D,!1));const O=I.x+z.left,R=I.y-n.SDF_GLYPH_BASELINE-z.top,V=O+z.width,H=R+z.height;let Z,U,q,B,X,j,J,K;if(!y&&A)if(I.vertical){const e=(O+V)/2-z.height/2,t=(R+H)/2+z.width/2;Z=new o.Point(-t-T+F,e-T+Y),U=new o.Point(Z.x+v.width,Z.y+v.height),q=new o.Point(Z.x,U.y),B=new o.Point(U.x,Z.y)}else Z=new o.Point(-R+T+F,O-T+Y),U=new o.Point(Z.x-v.height,Z.y+v.width),q=new o.Point(U.x,Z.y),B=new o.Point(Z.x,U.y);else Z=new o.Point(O-T+F,R-T+Y),U=new o.Point(Z.x+v.width,Z.y+v.height),q=new o.Point(Z.x,U.y),B=new o.Point(U.x,Z.y);for(const t of M){let n,i,a,s;if(t.alternateVerticalGlyph){if(!X){const e=(O+V)/2+F,t=(R+H)/2+Y;X=new o.Point(e-z.height/2-T,t+z.width/2+T),j=new o.Point(X.x+v.height,X.y-v.width),J=new o.Point(j.x,X.y),K=new o.Point(X.x,j.y)}n=X,i=J,a=K,s=j}else n=Z,i=q,a=B,s=U;const h=R,r=H,g=t.glyphAngle+x;if(0!==g){const e=Math.cos(g),t=Math.sin(g);n=n.clone(),i=i.clone(),a=a.clone(),s=s.clone(),n.rotate(e,t),s.rotate(e,t),i.rotate(e,t),a.rotate(e,t)}let m=0,P=256;if(y&&A?I.vertical?t.alternateVerticalGlyph?(m=32,P=96):(m=224,P=32):(m=224,P=96):(m=192,P=64),u.push(new d(n,a,i,s,v,t.labelAngle,m,P,t.anchor,t.minzoom,t.maxzoom,t.page)),_&&(!k||this._legible(t.labelAngle)))if(b)O<E&&(E=O),h<L&&(L=h),V>N&&(N=V),r>C&&(C=r);else if(t.minzoom<c){const n={xTile:e.x,yTile:e.y,dxPixels:(O+F)*S-w,dyPixels:(h+F)*S-w,hard:!l.optional,partIndex:1,width:(V-O)*S+2*w,height:(r-h)*S+2*w,angle:g,minLod:t.minzoom,maxLod:t.maxzoom};_.push(n)}}}if(p>=c)return null;if(_&&b){let n,i,o,a;A?(n=-C+F,i=E+Y,o=C-L,a=N-E):(n=E+F,i=L+Y,o=N-E,a=C-L);const s={xTile:e.x,yTile:e.y,dxPixels:n*S-w,dyPixels:i*S-w,hard:!l.optional,partIndex:1,width:o*S+2*w,height:a*S+2*w,angle:x,minLod:h,maxLod:t.C_INFINITY};_.push(s)}const v=new I(u);return _&&_.length>0&&(v.textColliders=_),v},a._legible=function(e){const n=t.radToByte(e);return n<65||n>=193},a._placeGlyph=function(e,n,i,a,l,s,h,c,r){let d=s;const I=d<0?t.positiveMod(e.angle+t.C_PI,t.C_2PI):e.angle;let x=0;i<0&&(d*=-1,i*=-1,x=t.C_PI),d>0&&++l;let m=new o.Point(e.x,e.y),P=a[l],w=t.C_INFINITY;if(a.length<=l)return w;for(;;){const e=P.x-m.x,o=P.y-m.y,s=Math.sqrt(e*e+o*o),p=Math.max(i/s,n),f=e/s,y=o/s,_=t.positiveMod(Math.atan2(y,f)+x,t.C_2PI);if(r.push(new g(m,I,_,c,!1,p,w)),h&&r.push(new g(m,I,_,c,!0,p,w)),p<=n)return p;m=P.clone();do{if(l+=d,a.length<=l||l<0)return p;P=a[l]}while(m.isEqual(P));let u=P.x-m.x,T=P.y-m.y;const b=Math.sqrt(u*u+T*T);u*=s/b,T*=s/b,m.x-=u,m.y-=T,w=p}},e}();e.Anchor=r,e.PlacedSymbol=d,e.Placement=I,e.PlacementEngine=x,e.TILE_COORD_SIZE=a,e.TILE_PIXEL_RATIO=s,e.TILE_PIXEL_SIZE=l,Object.defineProperty(e,"__esModule",{value:!0})}));
