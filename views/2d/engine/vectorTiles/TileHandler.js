/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../request","../../../../core/has","../../../../core/ItemCache","../../../../core/promiseUtils","../../../../core/workers/workers","./GlyphMosaic","./GlyphSource","./SpriteMosaic","./TileIndex","./decluttering/debugging","../../tiling/TileKey"],(function(e,t,r,i,s,o,n,a,l,c,u,h,p){"use strict";const y=new s(10),f=new Map;let _=function(){function e(e,t,r){this._vectorTileLayer=e,this._styleRepository=t,this.devicePixelRatio=r,this._spriteMosaic=null,this._glyphMosaic=null,this._connection=null}var s=e.prototype;return s.destroy=function(){this._connection&&(this._connection.close(),this._connection=null),this._styleRepository=null,this._vectorTileLayer=null,this._spriteMosaic&&(this._spriteMosaic=null),this._glyphMosaic&&(this._glyphMosaic=null)},s.start=function(){var e=t._asyncToGenerator((function*(e){const t=this._vectorTileLayer,r=t.sourceNameToSource,s=[];for(const i in r)s.push(this._fetchTileMap(r[i],e));this._spriteSourcePromise=this._vectorTileLayer.loadSpriteSource(this.devicePixelRatio,e),this._spriteSourcePromise.then((e=>{this._spriteMosaic=new c(1024,1024,250),this._spriteMosaic.setSpriteSource(e)}));const o=this._styleRepository,u=new l(o.glyphs);return this._glyphMosaic=new a(1024,1024,u),this._broadcastPromise=n.open("WorkerTileHandler",{client:this,schedule:e.schedule,signal:e.signal}).then((r=>(this._connection=r,Promise.all(this._connection.broadcast("setStyle",{style:t.currentStyleInfo.style,vectorTileLayerMaxBuffers:i("vectortilelayer-max-buffers")},e))))),Promise.all(s)}));function r(t){return e.apply(this,arguments)}return r}(),s.updateStyle=function(){var e=t._asyncToGenerator((function*(e){return yield this._broadcastPromise,this._broadcastPromise=new Promise(((t,r)=>{Promise.all(this._connection.broadcast("updateStyle",e)).then(t,r)})),this._broadcastPromise}));function r(t){return e.apply(this,arguments)}return r}(),s.setStyle=function(){var e=t._asyncToGenerator((function*(e,t){yield this._broadcastPromise,this._styleRepository=e;const r=this._vectorTileLayer.sourceNameToSource,s=[];for(const i in r)s.push(this._fetchTileMap(r[i],null));this._spriteSourcePromise=this._vectorTileLayer.loadSpriteSource(this.devicePixelRatio,null),this._spriteSourcePromise.then((e=>{this._spriteMosaic=new c(1024,1024,250),this._spriteMosaic.setSpriteSource(e)}));const o=new l(e.glyphs);return this._glyphMosaic=new a(1024,1024,o),this._broadcastPromise=new Promise(((e,r)=>{Promise.all(this._connection.broadcast("setStyle",{style:t,vectorTileLayerMaxBuffers:i("vectortilelayer-max-buffers")})).then(e,r)})),s.push(this._broadcastPromise),Promise.all(s)}));function r(t,r){return e.apply(this,arguments)}return r}(),s.fetchTileData=function(e,t){return this._getRefKeys(e,t).then((e=>{const r=this._vectorTileLayer.sourceNameToSource,i=[];for(const t in r)i.push(t);return this._getSourcesData(i,e,t)}))},s.parseTileData=function(e,t){const r=e&&e.data;if(!r)return Promise.resolve(null);const{sourceName2DataAndRefKey:i,transferList:s}=r;return 0===Object.keys(i).length?Promise.resolve(null):this._broadcastPromise.then((()=>this._connection.getAvailableClient().then((r=>r.invoke("createTileAndParse",{key:e.key.id,sourceName2DataAndRefKey:i,styleLayerUIDs:e.styleLayerUIDs},{...t,transferList:s}).then((e=>({tileData:e})))))))},s.getSprites=function(){var e=t._asyncToGenerator((function*(e){return yield this._spriteSourcePromise,this._spriteMosaic.getSpriteItems(e)}));function r(t){return e.apply(this,arguments)}return r}(),s.getGlyphs=function(e){return this._glyphMosaic.getGlyphItems(e.font,e.codePoints)},s.perfReport=function({key:e,milliseconds:t}){h.perfAdd(e,t,"ms")},s._getTilePayload=function(){var e=t._asyncToGenerator((function*(e,t,r){const i=p.pool.acquire(e.id),s=this._vectorTileLayer.sourceNameToSource[t].getSourceTileUrl(i.level,i.row,i.col);p.pool.release(i);try{return{protobuff:yield this.request(s,r),sourceName:t}}catch(n){if(o.isAbortError(n))throw n;return{protobuff:null,sourceName:t}}}));function r(t,r,i){return e.apply(this,arguments)}return r}(),s.request=function(e,t){return r(e,{responseType:"array-buffer",...t}).then((({data:e})=>e))},s._fetchTileMap=function(){var e=t._asyncToGenerator((function*(e,t){if(e.capabilities.operations.supportsTileMap&&e.tileIndex)return Promise.resolve();if(!e.tileMapURL)return;const i=y.get(e.tileMapURL);if(i)return void(e.tileIndex=i);let s;if(f.has(e.tileMapURL)){try{s=yield f.get(e.tileMapURL),e.tileIndex=new u(s.data)}catch(a){if(o.isAbortError(a))throw a}return}const n=r(e.tileMapURL,t);f.set(e.tileMapURL,n);try{s=yield n,f.delete(e.tileMapURL),y.put(e.tileMapURL,e.tileIndex),e.tileIndex=new u(s.data)}catch(a){if(f.delete(e.tileMapURL),o.isAbortError(a))throw a}}));function i(t,r){return e.apply(this,arguments)}return i}(),s._getRefKeys=function(e,t){const r=this._vectorTileLayer.sourceNameToSource,i=new Array;for(const s in r){const o=r[s].getRefKey(e,t);i.push(o)}return o.eachAlways(i)},s._getSourcesData=function(e,t,r){const i=[];for(let s=0;s<t.length;s++)if(null==t[s].value||null==e[s])i.push(null);else{const o=this._getTilePayload(t[s].value,e[s],r);i.push(o)}return o.eachAlways(i).then((e=>{const r={},i=[];for(let s=0;s<e.length;s++)if(e[s].value&&e[s].value&&e[s].value.protobuff&&e[s].value.protobuff.byteLength>0){const o=t[s].value.id;r[e[s].value.sourceName]={refKey:o,protobuff:e[s].value.protobuff},i.push(e[s].value.protobuff)}return{sourceName2DataAndRefKey:r,transferList:i}}))},t._createClass(e,[{key:"spriteMosaic",get:function(){return this._spriteSourcePromise.then((()=>this._spriteMosaic))}},{key:"glyphMosaic",get:function(){return this._glyphMosaic}}]),e}();e.TileHandler=_,Object.defineProperty(e,"__esModule",{value:!0})}));
