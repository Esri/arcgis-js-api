/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/promiseUtils","../../../../core/urlUtils","../../../../core/workers/workers","./GlyphMosaic","./GlyphSource","./SpriteMosaic","../../tiling/TileKey"],(function(e,t,r,s,o,i,n,a,l){"use strict";let c=function(){function e(e,t,r){this._layer=e,this._styleRepository=t,this.devicePixelRatio=r,this._spriteMosaic=null,this._glyphMosaic=null,this._connection=null}var c=e.prototype;return c.destroy=function(){this._connection?.close(),this._connection=null,this._styleRepository=null,this._layer=null,this._spriteMosaic=null,this._glyphMosaic=null},c.start=function(){var e=t._asyncToGenerator((function*(e){this._spriteSourcePromise=this._layer.loadSpriteSource(this.devicePixelRatio,e),this._spriteSourcePromise.then((e=>{this._spriteMosaic=new a(1024,1024,250),this._spriteMosaic.setSpriteSource(e)}));const t=this._layer.currentStyleInfo.glyphsUrl,l=new n(t?s.addQueryParameters(t,{...this._layer.customParameters,token:this._layer.apiKey}):null);this._glyphMosaic=new i(1024,1024,l),this._broadcastPromise=o.open("WorkerTileHandler",{client:this,schedule:e.schedule,signal:e.signal}).then((t=>{if(this._connection=t,this._layer&&!this._connection.closed){const s=t.broadcast("setStyle",this._layer.currentStyleInfo.style,e);Promise.all(s).catch((e=>r.throwIfNotAbortError(e)))}}))}));function l(t){return e.apply(this,arguments)}return l}(),c.updateStyle=function(){var e=t._asyncToGenerator((function*(e){return yield this._broadcastPromise,this._broadcastPromise=Promise.all(this._connection.broadcast("updateStyle",e)),this._broadcastPromise}));function r(t){return e.apply(this,arguments)}return r}(),c.setSpriteSource=function(e){const t=new a(1024,1024,250);return t.setSpriteSource(e),this._spriteMosaic=t,this._spriteSourcePromise=Promise.resolve(e),t},c.setStyle=function(){var e=t._asyncToGenerator((function*(e,t){yield this._broadcastPromise,this._styleRepository=e,this._spriteSourcePromise=this._layer.loadSpriteSource(this.devicePixelRatio,null),this._spriteSourcePromise.then((e=>{this._spriteMosaic=new a(1024,1024,250),this._spriteMosaic.setSpriteSource(e)}));const r=new n(this._layer.currentStyleInfo.glyphsUrl?s.addQueryParameters(this._layer.currentStyleInfo.glyphsUrl,{...this._layer.customParameters,token:this._layer.apiKey}):null);return this._glyphMosaic=new i(1024,1024,r),this._broadcastPromise=Promise.all(this._connection.broadcast("setStyle",t)),this._broadcastPromise}));function r(t,r){return e.apply(this,arguments)}return r}(),c.fetchTileData=function(e,t){return this._getRefKeys(e,t).then((e=>{const r=this._layer.sourceNameToSource,s=[];for(const t in r)s.push(t);return this._getSourcesData(s,e,t)}))},c.parseTileData=function(e,t){const r=e&&e.data;if(!r)return Promise.resolve(null);const{sourceName2DataAndRefKey:s,transferList:o}=r;return 0===Object.keys(s).length?Promise.resolve(null):this._broadcastPromise.then((()=>this._connection.invoke("createTileAndParse",{key:e.key.id,sourceName2DataAndRefKey:s,styleLayerUIDs:e.styleLayerUIDs},{...t,transferList:o})))},c.getSprites=function(){var e=t._asyncToGenerator((function*(e){return yield this._spriteSourcePromise,this._spriteMosaic.getSpriteItems(e)}));function r(t){return e.apply(this,arguments)}return r}(),c.getGlyphs=function(e){return this._glyphMosaic.getGlyphItems(e.font,e.codePoints)},c._getTilePayload=function(){var e=t._asyncToGenerator((function*(e,t,s){const o=l.pool.acquire(e.id),i=this._layer.sourceNameToSource[t],{level:n,row:a,col:c}=o;l.pool.release(o);try{return{protobuff:yield i.requestTile(n,a,c,s),sourceName:t}}catch(u){if(r.isAbortError(u))throw u;return{protobuff:null,sourceName:t}}}));function s(t,r,s){return e.apply(this,arguments)}return s}(),c._getRefKeys=function(e,t){const s=this._layer.sourceNameToSource,o=new Array;for(const r in s){const i=s[r].getRefKey(e,t);o.push(i)}return r.eachAlways(o)},c._getSourcesData=function(e,t,s){const o=[];for(let r=0;r<t.length;r++)if(null==t[r].value||null==e[r])o.push(null);else{const i=this._getTilePayload(t[r].value,e[r],s);o.push(i)}return r.eachAlways(o).then((e=>{const r={},s=[];for(let o=0;o<e.length;o++){const i=e[o].value;if(i&&(i.protobuff&&i.protobuff.byteLength>0)){const e=t[o].value.id;r[i.sourceName]={refKey:e,protobuff:i.protobuff},s.push(i.protobuff)}}return{sourceName2DataAndRefKey:r,transferList:s}}))},t._createClass(e,[{key:"spriteMosaic",get:function(){return this._spriteSourcePromise.then((()=>this._spriteMosaic))}},{key:"glyphMosaic",get:function(){return this._glyphMosaic}}]),e}();e.TileHandler=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
