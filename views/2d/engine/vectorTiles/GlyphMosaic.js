/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../../../../core/has","../../../../chunks/builtins","../../../webgl/checkWebGLError","../../../webgl/Texture","../../../webgl/FramebufferObject","../webgl/Rect","./RectangleBinPack"],(function(t,e,i,s,h,n,r){"use strict";return function(){function t(t,e,i){this.width=0,this.height=0,this._dirties=[],this._glyphData=[],this._currentPage=0,this._glyphIndex={},this._textures=[],this._rangePromises=new Map,this.width=t,this.height=e,this._glyphSource=i,this._binPack=new r(t-4,e-4),this._glyphData.push(new Uint8Array(t*e)),this._dirties.push(!0),this._textures.push(void 0)}var e=t.prototype;return e.getGlyphItems=function(t,e){const i=[],s=this._glyphSource,h=new Set,c=1/256;for(const n of e){const t=Math.floor(n*c);h.add(t)}const a=[];return h.forEach((e=>{if(e<=256){const i=t+e;if(this._rangePromises.has(i))a.push(this._rangePromises.get(i));else{const h=s.getRange(t,e).then((()=>{this._rangePromises.delete(i)}),(()=>{this._rangePromises.delete(i)}));this._rangePromises.set(i,h),a.push(h)}}})),Promise.all(a).then((()=>{let h=this._glyphIndex[t];h||(h={},this._glyphIndex[t]=h);for(const c of e){const e=h[c];if(e){i[c]={sdf:!0,rect:e.rect,metrics:e.metrics,page:e.page,code:c};continue}const a=s.getGlyph(t,c);if(!a||!a.metrics)continue;const o=a.metrics;let l;if(0===o.width)l=new n(0,0,0,0);else{const t=3,e=o.width+2*t,i=o.height+2*t;let s=e%4?4-e%4:4,h=i%4?4-i%4:4;1===s&&(s=5),1===h&&(h=5),l=this._binPack.allocate(e+s,i+h),l.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(void 0),this._binPack=new r(this.width-4,this.height-4),l=this._binPack.allocate(e+s,i+h));const n=this._glyphData[this._currentPage],c=a.bitmap;let g,_;if(c)for(let r=0;r<i;r++){g=e*r,_=this.width*(l.y+r+1)+l.x;for(let t=0;t<e;t++)n[_+t+1]=c[g+t]}}h[c]={rect:l,metrics:o,tileIDs:null,page:this._currentPage},i[c]={sdf:!0,rect:l,metrics:o,page:this._currentPage,code:c},this._dirties[this._currentPage]=!0}return i}))},e.removeGlyphs=function(t){for(const e in this._glyphIndex){const i=this._glyphIndex[e];if(!i)continue;let s;for(const e in i)if(s=i[e],s.tileIDs.delete(t),0===s.tileIDs.size){const t=this._glyphData[s.page],h=s.rect;let n,r;for(let e=0;e<h.height;e++)for(n=this.width*(h.y+e)+h.x,r=0;r<h.width;r++)t[n+r]=0;delete i[e],this._dirties[s.page]=!0}}},e.bind=function(t,e,i,h=0){this._textures[i]||(this._textures[i]=new s(t,{pixelFormat:6406,dataType:5121,width:this.width,height:this.height},new Uint8Array(this.width*this.height)));const n=this._textures[i];n.setSamplingMode(e),this._dirties[i]&&n.setData(this._glyphData[i]),t.bindTexture(n,h),this._dirties[i]=!1},e.dispose=function(){this._binPack=null;for(const t of this._textures)t&&t.dispose();this._textures.length=0},t}()}));
