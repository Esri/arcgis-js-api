/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../../../../core/promiseUtils","./style/StyleRepository","./WorkerTile"],(function(e,t,s){"use strict";return function(){function r(){this._spriteInfo={},this._glyphInfo={}}var o=r.prototype;return o.reset=function(){return this._spriteInfo={},this._glyphInfo={},Promise.resolve()},o.getLayers=function(){var e;return null==(e=this._styleRepository)?void 0:e.layers},o.createTileAndParse=async function(t,r){const{key:o}=t,n={};for(const e of Object.keys(t.sourceName2DataAndRefKey)){const s=t.sourceName2DataAndRefKey[e];n[e]=s.refKey}const i=new s(o,n,this,this._styleRepository);try{return await i.parse(t,this._vectorTileLayerMaxBuffers,r)}catch(a){if(i.setObsolete(),i.release(),!e.isAbortError(a))throw a;return null}},o.updateStyle=function(e){if(!e||0===e.length||!this._styleRepository)return;const t=this._styleRepository;for(const s of e){const e=s.type,r=s.data;switch(e){case 0:t.setPaintProperties(r.layerName,r.paint);break;case 1:t.setLayoutProperties(r.layerName,r.layout);break;case 3:t.deleteStyleLayer(r.layerName);break;case 2:t.setStyleLayer(r.layer,r.index)}}},o.setStyle=function(e){this._styleRepository=new t(e.style),this._spriteInfo={},this._glyphInfo={},this._vectorTileLayerMaxBuffers=e.vectorTileLayerMaxBuffers},o.fetchSprites=function(e,t,s){const r=[],o=this._spriteInfo;return e.forEach((e=>{void 0===o[e]&&r.push(e)})),0===r.length?Promise.resolve():t.invoke("getSprites",r,{signal:s&&s.signal}).then((e=>{for(const t in e){const s=e[t];o[t]=s}}))},o.getSpriteItems=function(){return this._spriteInfo},o.fetchGlyphs=function(e,t,s,r,o){const n=[];let i=this._glyphInfo[t];return i?s.forEach((e=>{i[e]||n.push(e)})):(i=this._glyphInfo[t]=[],s.forEach((e=>n.push(e)))),0===n.length?Promise.resolve():r.invoke("getGlyphs",{tileID:e,font:t,codePoints:n},o).then((e=>{for(let t=0;t<e.length;t++)e[t]&&(i[t]=e[t])}))},o.getGlyphItems=function(e){return this._glyphInfo[e]},r}()}));
