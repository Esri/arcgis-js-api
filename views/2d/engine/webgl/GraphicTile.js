/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","./DirtyMap","./DisplayRecordStore","./WGLBuffers","./WGLTile"],(function(t,e,i,s,a,l){"use strict";let d=function(t){function l(){var e;return(e=t.apply(this,arguments)||this)._data=null,e._displayList=null,e._lastCommitTime=0,e._hasData=!1,e._invalidated=!1,e._wglBuffers=null,e._dirtyMap=new i,e}e._inheritsLoose(l,t);var d=l.prototype;return d.destroy=function(){t.prototype.destroy.call(this),this.clear()},d.getGeometry=function(t){return this._wglBuffers&&this._wglBuffers.has(t)?this._wglBuffers.get(t):null},d.getDisplayList=function(){return this._displayList},d.patch=function(t){if(!0===t.clear)return this.clear(),void(this._hasData=!1);const e=t.addOrUpdate,a=t.remove;!this._data&&e&&e.tileDisplayData.displayObjects.length?(e.tileDisplayData.computeDisplayList(),this._dirtyMap=new i,this._dispRecStore=s.fromTileData(e,this._dirtyMap),this._data=e,this._dirtyMap.markAllDirty(),this._hasData=!0,t.end&&this.ready()):this._data&&(e&&e.tileDisplayData.displayObjects.length||a.length)?this._doPatchData(t):t.end&&this.ready(),t.end&&!this._data&&this.clear(),this.requestRender(),this.emit("change")},d.commit=function(t){t.time&&t.time===this._lastCommitTime||(this._lastCommitTime=t.time,this.visible&&this._data&&(this._wglBuffers||(this._wglBuffers=new a(t.context)),(this._dirtyMap.hasDirty()||this._invalidated)&&(this._invalidated=!1,this._wglBuffers.upload(this._data.tileBufferData,this._dirtyMap),this._displayList=this._data.tileDisplayData.displayList.clone(),this._displayObjects=this._data.tileDisplayData.displayObjects.slice(),this._dirtyMap.markAllClean())))},d.clear=function(){this._data=null,this._displayList=null,this._dispRecStore=null,this._wglBuffers&&(this._wglBuffers.dispose(),this._wglBuffers=null)},d._doPatchData=function(t){this._invalidated=!0,this._patchData(t)||(this._dirtyMap.markAllDirty(),this._data.reshuffle(),this._dispRecStore=s.fromTileData(this._data,this._dirtyMap)),this.requestRender()},d._patchData=function(t){let e=!0;const i=t.addOrUpdate&&t.addOrUpdate.tileDisplayData&&t.addOrUpdate.tileDisplayData.displayObjects||[],s=(t.remove||[]).slice();for(const l of i)null!=l.insertAfter&&s.push(l.id);let a;s.length>0&&(a=new Set(s));for(const l of s){const t=this._data.tileDisplayData.displayObjectRegistry.get(l);if(t){this._data.tileDisplayData.displayList.removeFromList(t.displayRecords);for(const e of t.displayRecords)this._dispRecStore.delete(e);this._data.tileDisplayData.displayObjectRegistry.delete(l)}}a&&a.size&&(this._data.tileDisplayData.displayObjects=this._data.tileDisplayData.displayObjects.filter((t=>!a.has(t.id))));for(const l of i){let i,s=this._data.tileDisplayData.displayObjectRegistry.get(l.id);if(s){const t=s.displayRecords;s.set(l),s.displayRecords=t;const e=s.displayRecords.length;for(let i=0;i<e;++i){const t=s.displayRecords[i],e=l.displayRecords[i];(i>=l.displayRecords.length||t.geometryType!==e.geometryType||t.symbolLevel!==e.symbolLevel||t.zOrder!==e.zOrder||t.materialKey!==e.materialKey)&&(this._dispRecStore.delete(s.displayRecords[i]),i<l.displayRecords.length&&(s.displayRecords[i]=void 0))}s.displayRecords.length=l.displayRecords.length}else{let t;s=l.copy(),s.displayRecords=[],this._data.tileDisplayData.displayObjectRegistry.set(l.id,s);const e=this._data.tileDisplayData.displayObjects;if(null!=s.insertAfter)if(i={},s.insertAfter>=0){const i=this._data.tileDisplayData.displayObjectRegistry.get(s.insertAfter);i?(t=e.indexOf(i)+1,t<e.length?e.splice(t,0,s):(e.push(s),t=e.length)):(e.push(s),t=e.length)}else e.unshift(s),t=0;else e.push(s),t=e.length;if(i){const s=l.displayRecords.length>0?1:0;let a=0;for(let l=t-1;l>=0&&a<s;--l)for(let t=e[l].displayRecords.length-1;t>=0&&a<s;--t){const s=e[l].displayRecords[t],d=this._data.tileDisplayData.displayList.getDPInfoType();i[d]||(i[d]=s,++a)}}}const a=l.displayRecords.length;for(let d=0;d<a;++d){const a=l.displayRecords[d];let r=s.displayRecords[d];r?(r.meshData=a.meshData,r.materialKey=a.materialKey):(r=a.copy(),r.vertexFrom=void 0,r.indexFrom=void 0,s.displayRecords[d]=r);const o=a.geometryType,p=this._data.tileDisplayData.displayList.getDPInfoType(),h=t.addOrUpdate.tileBufferData.geometries[o],n=h.vertexBuffer,y=h.indexBuffer;let c;i&&(c=i[p]?this._data.tileDisplayData.displayList.splitAfter(i[p]):-1),e=this._dispRecStore.setMeshData(r,a,n,y,c)&&e,i&&null!=r.indexFrom&&null!=r.indexFrom&&(i[p]=r)}}return e},e._createClass(l,[{key:"hasData",get:function(){return!!this._hasData}},{key:"displayObjects",get:function(){return this._displayObjects??[]}}]),l}(l.WGLTile);t.GraphicTile=d,Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
