/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../Color","../../../../core/maybe","../../../../core/screenUtils","../../../../core/unitUtils","../../../../renderers/support/lengthUtils","./definitions","./Utils","../../../webgl/capabilities"],(function(e,t,i,s,a,o,n,l,r,u){"use strict";function v(e,t){const i=t.length;if(e<t[0].value||1===i)return t[0].size;for(let s=1;s<i;s++)if(e<t[s].value){const i=(e-t[s-1].value)/(t[s].value-t[s-1].value);return t[s-1].size+i*(t[s].size-t[s-1].size)}return t[i-1].size}function d(e,t,i=0){if(s.isNone(t))return e[i+0]=0,e[i+1]=0,e[i+2]=0,void(e[i+3]=0);const{r:a,g:o,b:n,a:l}=t;e[i+0]=a*l/255,e[i+1]=o*l/255,e[i+2]=n*l/255,e[i+3]=l}let c=function(){function e(){this.symbolLevels=[],this.vvColorValues=new Float32Array(8),this.vvColors=new Float32Array(32),this.vvOpacityValues=new Float32Array(8),this.vvOpacities=new Float32Array(8),this.vvSizeMinMaxValue=new Float32Array(4),this.ddColors=new Float32Array(32),this.ddBackgroundColor=new Float32Array(4),this.ddActiveDots=new Float32Array(8),this._vvMaterialParameters={vvSizeEnabled:!1,vvColorEnabled:!1,vvRotationEnabled:!1,vvRotationType:"geographic",vvOpacityEnabled:!1}}var c=e.prototype;return c.getSizeVVFieldStops=function(e){const t=this._vvSizeFieldStops;switch(t.type){case"static":return t;case"level-dependent":return s.unwrapOr(t.levels[e],(()=>{let i=1/0,a=0;for(const s in t.levels){const t=parseFloat(s),o=Math.abs(e-t);o<i&&(i=o,a=t)}if(i===1/0)return{sizes:new Float32Array([0,0,0,0,0,0]),values:new Float32Array([0,0,0,0,0,0])};const o=2**((e-a)/2),n=s.unwrap(t.levels[a]),l=new Float32Array(n.values);return l[2]*=o,l[3]*=o,{sizes:s.unwrap(n.sizes),values:l}}))}},c.update=function(e){s.isSome(this._vvInfo)&&this._updateVisualVariables(this._vvInfo.vvRanges,e)},c.setInfo=function(e,t,i){if(this._updateEffects(i),this._vvInfo=t,"dot-density"===e.type)this._updateDotDensityInfo(e)},c.getVariation=function(){return{ddDotBlending:this.ddDotBlending,outsideLabelsVisible:this.outsideLabelsVisible,oesTextureFloat:u().supportsTextureFloat}},c.getVariationHash=function(){return(this.ddDotBlending?1:0)|(this.outsideLabelsVisible?1:0)<<1},c._updateEffects=function(e){s.isSome(e)?this.outsideLabelsVisible=e.excludedLabelsVisible:this.outsideLabelsVisible=!1},c._updateVisualVariables=function(e,t){const i=this._vvMaterialParameters;if(i.vvOpacityEnabled=!1,i.vvSizeEnabled=!1,i.vvColorEnabled=!1,i.vvRotationEnabled=!1,!e)return;const s=e.size;if(s){if(i.vvSizeEnabled=!0,s.minMaxValue){const e=s.minMaxValue;let i,o;if(r.isDefined(e.minSize)&&r.isDefined(e.maxSize))if(r.isNumber(e.minSize)&&r.isNumber(e.maxSize))i=a.pt2px(e.minSize),o=a.pt2px(e.maxSize);else{const s=t.scale;i=a.pt2px(v(s,e.minSize.stops)),o=a.pt2px(v(s,e.maxSize.stops))}this.vvSizeMinMaxValue.set([e.minDataValue,e.maxDataValue,i,o])}if(s.scaleStops&&(this.vvSizeScaleStopsValue=a.pt2px(v(t.scale,s.scaleStops.stops))),s.unitValue){const e=o.getMetersPerUnitForSR(t.spatialReference)/n.meterIn[s.unitValue.unit];this.vvSizeUnitValueToPixelsRatio=e/t.resolution}s.fieldStops&&(this._vvSizeFieldStops=s.fieldStops)}const l=e.color;l&&(i.vvColorEnabled=!0,this.vvColorValues.set(l.values),this.vvColors.set(l.colors));const u=e.opacity;u&&(i.vvOpacityEnabled=!0,this.vvOpacityValues.set(u.values),this.vvOpacities.set(u.opacities));const d=e.rotation;d&&(i.vvRotationEnabled=!0,i.vvRotationType=d.type)},c._updateDotDensityInfo=function(e){const t=e.attributes;this.ddDotValue=e.dotValue,this.ddDotScale=e.referenceScale,this.ddDotSize=e.dotSize,this.ddDotBlending=e.dotBlendingEnabled,this.ddSeed=e.seed;for(let s=0;s<l.DOT_DENSITY_MAX_FIELDS;s++){const e=s>=t.length?new i([0,0,0,0]):t[s].color;d(this.ddColors,e,4*s)}for(let i=0;i<8;i++)this.ddActiveDots[i]=i<e.attributes.length?1:0;d(this.ddBackgroundColor,e.backgroundColor)},t._createClass(e,[{key:"vvMaterialParameters",get:function(){return this._vvMaterialParameters}}]),e}();e.WGLRendererInfo=c,Object.defineProperty(e,"__esModule",{value:!0})}));
