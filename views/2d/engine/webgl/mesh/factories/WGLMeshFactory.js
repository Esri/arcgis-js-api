/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/has","../../../../../../core/maybe","../../../../../../core/promiseUtils","../../../../../../geometry/libtess","../../DisplayId","../templates/WGLLabelTemplate","../templates/WGLMarkerTemplate","../templates/WGLTemplateStore"],(function(e,t,i,r,s,o,n,l,a,u){"use strict";let c=function(){function e(e,t,i){this._loadPromise=o.loadLibtess(),this._geometryType=e,this._idField=t,this._templateStore=i}var i=e.prototype;return i.update=function(e,t){r.isSome(e.mesh.labels)&&(this._labelTemplates=this._createLabelTemplates(e.mesh.labels,t)),this._schema=e},i._createLabelTemplates=function(e,t){const i=new Map;if("simple"===e.type){for(const r of e.classes){const e=l.fromLabelClass(r,t);i.set(r.index,e)}return i}for(const r in e.classes){const s=e.classes[r];for(const e of s){const r=l.fromLabelClass(e,t);i.set(e.index,r)}}return i},i.analyze=function(){var e=t._asyncToGenerator((function*(e,t,i,o,l,a,c){if(s.isAborted(c))return;let f;"dictionary"===i?.type&&(f=yield i.analyze(this._idField,e.copy(),t,l,a,c));let p=0;for(;e.next();){let t=null;if(t=f?f[p++]:r.isSome(o)&&n.isAggregateId(e.getDisplayId())&&1!==e.readAttribute("cluster_count")?o.match(this._idField,e,this._geometryType,l,a):i.match(this._idField,e,this._geometryType,l,a),e.setGroupId(t),u.isDynamicId(t)){const i=this._templateStore.getDynamicTemplateGroup(t).templates;for(const t of i)t&&t.analyze&&t.analyze(this._templateStore,e,l,a)}}return yield this._loadPromise,this._templateStore.finalize(c)}));function i(t,i,r,s,o,n,l){return e.apply(this,arguments)}return i}(),i.analyzeGraphics=function(){var e=t._asyncToGenerator((function*(e,t,i,r,o,n){if(s.isAborted(n))return;const l=e.getCursor();for(i&&(yield i.analyze(this._idField,l.copy(),t,r,o,n));l.next();){let e=l.getGroupId();if(null!=e&&-1!==e||(e=i?.match(this._idField,l,l.geometryType,r,o),l.setGroupId(e)),u.isDynamicId(e)){const t=this._templateStore.getDynamicTemplateGroup(e).templates;for(const e of t)e&&e.analyze&&e.analyze(this._templateStore,l,r,o)}l.setGroupId(e)}return yield this._loadPromise,this._templateStore.finalize(n)}));function i(t,i,r,s,o,n){return e.apply(this,arguments)}return i}(),i.writeGraphic=function(e,t,i,r){const s=t.getGroupId(),o=t.getDisplayId(),n=this._templateStore.getTemplateGroup(s);if(e.featureStart(t.insertAfter,0),null!=o){if(u.isDynamicId(s))for(const e of n.templates)e&&e.bindFeature(t,null,null);if(n){for(const s of n.templates)s&&s.write(e,t,i,r);e.featureEnd()}}},i.writeCursor=function(e,t,i,s,o,n,l){const a=t.getGroupId(),c=t.getDisplayId(),f=this._templateStore.getTemplateGroup(a),p=f.templates,d=this._getSortKeyValue(t,f);if(e.featureStart(0,d),null!=c&&p){if(u.isDynamicId(a))for(const e of p)e.bindFeature(t,i,s);for(const i of p)i.write(e,t,o,l);if(r.isSome(n)&&e.hasRecords){const i=n&&this._findLabelRef(p);this._writeLabels(e,t,n,i,o,l)}e.featureEnd()}},i._getSortKeyValue=function(e,t){const i=this._schema.mesh.sortKey;if(r.isNone(i))return 0;let s=0;return s=!0===i.byRenderer&&null!=t.sortKey?t.sortKey:null!=i.fieldIndex?e.getComputedNumericAtIndex(i.fieldIndex):null!=i.field?e.readAttribute(i.field):e.readAttribute(this._idField),s*="asc"===i.order?1:-1,null==s||isNaN(s)?0:s},i._findLabelRef=function(e){for(const t of e)if(t instanceof a)return t;return null},i._writeLabels=function(e,t,i,s,o,n){for(const l of i)if(r.isSome(l)&&l){const{glyphs:i,rtl:r,index:a}=l,u=this._labelTemplates.get(a);if(!u)continue;u.setZoomLevel(o),u.bindReferenceTemplate(s),u.bindTextInfo(i,r),u.write(e,t,null,n)}},t._createClass(e,[{key:"templates",get:function(){return this._templateStore}}]),e}();e.WGLMeshFactory=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
