/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/has","../../../../../../core/maybe","../../../../../../core/promiseUtils","../../../../../../geometry/libtess","../templates/WGLLabelTemplate","../templates/WGLMarkerTemplate","../templates/WGLTemplateStore","../../../../layers/features/support/AttributeStore"],(function(e,t,i,r,s,o,n,l,a,c){"use strict";let f=function(){function e(e,t,i){this._loadPromise=o.loadLibtess(),this._geometryType=e,this._idField=t,this._templateStore=i}var i=e.prototype;return i.update=function(e,t){r.isSome(e.mesh.labels)&&(this._labelTemplates=this._createLabelTemplates(e.mesh.labels,t)),this._schema=e},i._createLabelTemplates=function(e,t){const i=new Map;if("simple"===e.type){for(const r of e.classes){const e=n.fromLabelClass(r,t);i.set(r.index,e)}return i}for(const r in e.classes){const s=e.classes[r];for(const e of s){const r=n.fromLabelClass(e,t);i.set(e.index,r)}}return i},i.analyze=function(){var e=t._asyncToGenerator((function*(e,t,i,o,n,l){if(s.isAborted(l))return;let f;"dictionary"===t.type&&(f=yield t.analyze(this._idField,e.copy(),o,n,l));let u=0;for(;e.next();){let s;if(s=f?f[u++]:r.isSome(i)&&c.isAggregateId(e.getDisplayId())&&1!==e.readAttribute("cluster_count")?i.match(this._idField,e,this._geometryType,o,n):t.match(this._idField,e,this._geometryType,o,n),e.setGroupId(s),a.isDynamicId(s)){const t=this._templateStore.getDynamicTemplateGroup(s);for(const i of t)i&&i.analyze&&i.analyze(this._templateStore,e,o,n)}}return yield this._loadPromise,this._templateStore.finalize(l)}));function i(t,i,r,s,o,n){return e.apply(this,arguments)}return i}(),i.analyzeGraphics=function(){var e=t._asyncToGenerator((function*(e,t,i,r,o){if(s.isAborted(o))return;const n=e.getCursor();for(t&&(yield t.analyze(this._idField,n.copy(),i,r,o));n.next();){let e=n.getGroupId();if(null!=e&&-1!==e||(e=t.match(this._idField,n,n.geometryType,i,r),n.setGroupId(e)),a.isDynamicId(e)){const t=this._templateStore.getDynamicTemplateGroup(e);for(const e of t)e&&e.analyze&&e.analyze(this._templateStore,n,i,r)}n.setGroupId(e)}return yield this._loadPromise,this._templateStore.finalize(o)}));function i(t,i,r,s,o){return e.apply(this,arguments)}return i}(),i.writeGraphic=function(e,t,i){const r=t.getGroupId(),s=t.getDisplayId(),o=this._templateStore.getTemplateGroup(r);if(e.featureStart(t.insertAfter,0),null!=s){if(a.isDynamicId(r))for(const e of o)e.bindFeature(t,null,null);if(o){for(const r of o)r&&r.write(e,t,i);e.featureEnd()}}},i.writeCursor=function(e,t,i,s,o,n){const l=t.getGroupId(),c=t.getDisplayId(),f=this._templateStore.getTemplateGroup(l),u=this._schema.mesh.sortKey;let d=0;if(r.isSome(u)&&(d=null!=u.fieldIndex?t.getComputedNumericAtIndex(u.fieldIndex):null!=u.field?t.readAttribute(u.field):t.readAttribute(this._idField),d*="asc"===u.order?1:-1),e.featureStart(0,null==d||isNaN(d)?0:d),null!=c&&f){if(a.isDynamicId(l))for(const e of f)e.bindFeature(t,i,s);for(const i of f)i.write(e,t,o);if(r.isSome(n)&&e.hasRecords){const i=n&&this._findLabelRef(f);this._writeLabels(e,t,n,i,o)}e.featureEnd()}},i._findLabelRef=function(e){for(const t of e)if(t instanceof l)return t;return null},i._writeLabels=function(e,t,i,s,o){for(const n of i)if(r.isSome(n)&&n){const{glyphs:i,rtl:r,index:l}=n,a=this._labelTemplates.get(l);a.setZoomLevel(o),a.bindReferenceTemplate(s),a.bindTextInfo(i,r),a.write(e,t,null)}},t._createClass(e,[{key:"templates",get:function(){return this._templateStore}}]),e}();e.WGLMeshFactory=f,Object.defineProperty(e,"__esModule",{value:!0})}));
