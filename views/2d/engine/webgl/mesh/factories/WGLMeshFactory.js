/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/has","../../../../../../core/maybe","../../../../../../core/promiseUtils","../templates/WGLLabelTemplate","../templates/WGLMarkerTemplate","../templates/WGLTemplateStore","../../../../layers/features/support/AttributeStore"],(function(e,t,r,i,o,s,n,a,l){"use strict";let c=function(){function e(e,t,r){this._geometryType=e,this._idField=t,this._templateStore=r}var r=e.prototype;return r.update=function(e,t){i.isSome(e.mesh.labels)&&(this._labelTemplates=this._createLabelTemplates(e.mesh.labels,t))},r._createLabelTemplates=function(e,t){const r=new Map;if("simple"===e.type){for(const i of e.classes){const e=s.fromLabelClass(i,t);r.set(i.index,e)}return r}for(const i in e.classes){const o=e.classes[i];for(const e of o){const i=s.fromLabelClass(e,t);r.set(e.index,i)}}return r},r.analyze=function(){var e=t._asyncToGenerator((function*(e,t,r,s,n,c){if(o.isAborted(c))return;let f;"dictionary"===t.type&&(f=yield t.analyze(this._idField,e.copy(),s,n,c));let p=0;for(;e.next();){let o;if(o=f?f[p++]:i.isSome(r)&&l.isAggregateId(e.getDisplayId())&&1!==e.readAttribute("cluster_count")?r.match(this._idField,e,this._geometryType,s,n):t.match(this._idField,e,this._geometryType,s,n),e.setGroupId(o),a.isDynamicId(o)){const t=this._templateStore.getDynamicTemplateGroup(o);for(const r of t)r&&r.analyze&&r.analyze(this._templateStore,e,s,n)}}return this._templateStore.finalize(c)}));function r(t,r,i,o,s,n){return e.apply(this,arguments)}return r}(),r.analyzeGraphics=function(){var e=t._asyncToGenerator((function*(e,t,r,i,s){if(o.isAborted(s))return;const n=e.getCursor();for(t&&(yield t.analyze(this._idField,n.copy(),r,i,s));n.next();){let e=n.getGroupId();if(null!=e&&-1!==e||(e=t.match(this._idField,n,n.geometryType,r,i),n.setGroupId(e)),a.isDynamicId(e)){const t=this._templateStore.getDynamicTemplateGroup(e);for(const e of t)e&&e.analyze&&e.analyze(this._templateStore,n,r,i)}n.setGroupId(e)}return this._templateStore.finalize(s)}));function r(t,r,i,o,s){return e.apply(this,arguments)}return r}(),r.writeGraphic=function(e,t,r){const i=t.getGroupId(),o=t.getDisplayId(),s=this._templateStore.getTemplateGroup(i);if(e.featureStart(t.insertAfter),null!=o){if(a.isDynamicId(i))for(const e of s)e.bindFeature(t,null,null);if(s){for(const i of s)i&&i.write(e,t,r);e.featureEnd()}}},r.writeCursor=function(e,t,r,o,s,n){const l=t.getGroupId(),c=t.getDisplayId(),f=this._templateStore.getTemplateGroup(l);if(t.getObjectId(),null!=c&&f){if(a.isDynamicId(l))for(const e of f)e.bindFeature(t,r,o);for(const r of f)r.write(e,t,s);if(i.isSome(n)&&e.hasRecords){const r=n&&this._findLabelRef(f);this._writeLabels(e,t,n,r,s)}}},r._findLabelRef=function(e){for(const t of e)if(t instanceof n)return t;return null},r._writeLabels=function(e,t,r,o,s){for(const n of r)if(i.isSome(n)&&n){const{glyphs:r,rtl:i,index:a}=n,l=this._labelTemplates.get(a);l.setZoomLevel(s),l.bindReferenceTemplate(o),l.bindTextInfo(r,i),l.write(e,t,null)}},t._createClass(e,[{key:"templates",get:function(){return this._templateStore}}]),e}();e.WGLMeshFactory=c,Object.defineProperty(e,"__esModule",{value:!0})}));
