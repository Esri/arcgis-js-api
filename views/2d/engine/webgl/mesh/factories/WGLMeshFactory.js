/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/has","../../../../../../core/maybe","../../../../../../core/promiseUtils","../../../../layers/features/support/AttributeStore","../templates/WGLLabelTemplate","../templates/WGLMarkerTemplate","../templates/WGLTemplateStore"],(function(e,t,i,r,o,s,a,l,n){"use strict";let p=function(){function e(e,t,i){this._geometryType=e,this._idField=t,this._templateStore=i}var i=e.prototype;return i.update=function(e,t){r.isSome(e.mesh.labels)&&this._setLabelTemplates(e.mesh.labels,t)},i._setLabelTemplates=function(e,t){this._labelTemplates=e.map((e=>a.fromLabelClass(e,t)))},i.analyze=async function(e,t,i,a,l,p){if(o.isAborted(p))return;let f;"dictionary"===t.type&&(f=await t.analyze(this._idField,e.copy(),a,l,p));let c=0;for(;e.next();){let o;if(o=f?f[c++]:r.isSome(i)&&s.isAggregateId(e.getDisplayId())&&1!==e.readAttribute("cluster_count")?i.match(this._idField,e,this._geometryType,a,l):t.match(this._idField,e,this._geometryType,a,l),e.setGroupId(o),n.isDynamicId(o)){const t=this._templateStore.getDynamicTemplateGroup(o);for(const i of t)i&&i.analyze&&i.analyze(this._templateStore,e,a,l)}}return this._templateStore.finalize(p)},i.analyzeGraphics=async function(e,t,i,r,s){if(o.isAborted(s))return;const a=e.getCursor();for(t&&await t.analyze(this._idField,a.copy(),i,r,s);a.next();){let e=a.getGroupId();if(null!=e&&-1!==e||(e=t.match(this._idField,a,a.geometryType,i,r),a.setGroupId(e)),n.isDynamicId(e)){const t=this._templateStore.getDynamicTemplateGroup(e);for(const e of t)e&&e.analyze&&e.analyze(this._templateStore,a,i,r)}a.setGroupId(e)}return this._templateStore.finalize(s)},i.writeGraphic=function(e,t){const i=t.getGroupId(),r=t.getDisplayId(),o=this._templateStore.getTemplateGroup(i);if(e.featureStart(t.insertAfter),null!=r){if(n.isDynamicId(i))for(const e of o)e.bindFeature(t,null,null);if(o){for(const i of o)i&&i.write(e,t);e.featureEnd()}}},i.writeCursor=function(e,t,i,o,s,a){const l=t.getGroupId(),p=t.getDisplayId(),f=this._templateStore.getTemplateGroup(l);if(t.getObjectId(),null!=p&&f){if(n.isDynamicId(l))for(const e of f)e.bindFeature(t,i,o);for(const i of f)i.write(e,t);if(r.isSome(a)&&e.hasRecords){const i=a&&this._findLabelRef(f);this._writeLabels(e,t,a,i,s)}}},i._findLabelRef=function(e){for(const t of e)if(t instanceof l)return t;return null},i._writeLabels=function(e,t,i,o,s){for(const a of i)if(r.isSome(a)&&a){const{glyphs:i,rtl:r,index:l}=a,n=this._labelTemplates[l];n.setZoomLevel(s),n.bindReferenceTemplate(o),n.bindTextInfo(i,r),n.write(e,t)}},t._createClass(e,[{key:"templates",get:function(){return this._templateStore}}]),e}();e.WGLMeshFactory=p,Object.defineProperty(e,"__esModule",{value:!0})}));
