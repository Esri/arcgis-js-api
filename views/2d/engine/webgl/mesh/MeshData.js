/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../WGLDisplayRecord","../util/serializationUtils","../collisions/Metric","../WGLDisplayObject","../util/Reader","../util/Writer"],(function(s,t,e,r,i,c,u,f){"use strict";let n=function(){function s(s,t){this.vertexVectorsMap=s,this._currentIndex=-1,this._currentRecordOffset=0,this._currentMetricOffset=0,this._currentMetrics=[];const e=4*(4*t.features+1),r=4*(8*t.records+1),i=4*(20*t.metrics+1);this._bufDisplayObjects=new f(Uint32Array,e+4),this._bufDisplayRecords=new f(Uint32Array,r+4),this._bufMetrics=new f(Uint32Array,i+4),this._bufDisplayObjects.push(0),this._bufDisplayRecords.push(0),this._bufMetrics.push(0)}var n=s.prototype;return n.get=function(s){return this.vertexVectorsMap[s]},n.currentDisplayRecordCount=function(){return this._bufDisplayRecords[this._currentRecordOffset]},n.writeDisplayObject=function(s,t){this._bufDisplayObjects.incr(0),this._currentIndex=this._bufDisplayObjects.push(s),this._bufDisplayObjects.push(t),this._bufDisplayObjects.push(0),this._bufDisplayObjects.push(0),this._currentRecordOffset=0,this._currentMetricOffset=0,this._currentMetrics=[]},n.hasDisplayRecords=function(){return!(0===this._currentRecordOffset)},n.endDisplayObject=function(){this.hasDisplayRecords()?this._currentMetrics&&(0===this._currentMetricOffset&&(this._bufDisplayObjects.setValue(this._currentIndex+3,this._bufMetrics.length),this._currentMetricOffset=this._bufMetrics.length),r.serializeList(this._bufMetrics,this._currentMetrics)):this._rollbackDisplayObject()},n.writeDisplayRecord=function(s,t,e,r,i,c,u=0,f=0){0===this._currentRecordOffset&&(this._currentRecordOffset=this._bufDisplayRecords.push(0),this._bufDisplayObjects.setValue(this._currentIndex+2,this._currentRecordOffset)),this._bufDisplayRecords.incr(this._currentRecordOffset),this._bufDisplayRecords.push(s),this._bufDisplayRecords.push(t),this._bufDisplayRecords.push(e),this._bufDisplayRecords.push(r),this._bufDisplayRecords.push(i),this._bufDisplayRecords.push(c),this._bufDisplayRecords.push(u),this._bufDisplayRecords.push(f)},n.writeMetrics=function(s){s&&this._currentMetrics.push(...s)},s.deserializeDisplayObjects=function(s){const{bufDisplayObjects:t,bufMetrics:f,bufRecords:n}=s,h=new u(t),a=new u(n),l=new u(f),p=[];let o=h.readInt32();for(a.readInt32(),l.readInt32();o--;){const s=h.readInt32(),t=h.readInt32(),u=h.readInt32(),f=h.readInt32(),n=new c(s);0!==t&&(n.insertAfter=t),0!==u&&(n.displayRecords=r.deserializeList(a,e,{id:s})),0!==f&&(n.metrics=r.deserializeList(l,i)),p.push(n)}return p},n.encode=function(s,t){const e={};for(let s=0;s<this.vertexVectorsMap.length;s++){const r=this.vertexVectorsMap[s];e[s]={},r.transfer(e[s],t)}s.bufDisplayObjects=this._bufDisplayObjects.buffer(),s.bufRecords=this._bufDisplayRecords.buffer(),s.bufMetrics=this._bufMetrics.buffer(),t.push(s.bufDisplayObjects),t.push(s.bufMetrics),t.push(s.bufRecords),s.vertexBuffersMap=e,this.destroy()},n.destroy=function(){this.vertexVectorsMap=null,this._bufDisplayObjects=null,this._bufDisplayRecords=null,this._bufMetrics=null},n._rollbackDisplayObject=function(){this._bufDisplayObjects.decr(0),this._bufDisplayObjects.seek(this._bufDisplayObjects.length-4),this._currentIndex=this._bufDisplayObjects.length},t._createClass(s,[{key:"vertexBuffersMap",get:function(){if(!this._vertexBuffersMap){this._vertexBuffersMap={};for(let s=0;s<this.vertexVectorsMap.length;s++)this._vertexBuffersMap[s]=this.vertexVectorsMap[s].intoBuffers();this.vertexVectorsMap=null}return this._vertexBuffersMap}}]),s}();s.MeshData=n,Object.defineProperty(s,"__esModule",{value:!0})}));
