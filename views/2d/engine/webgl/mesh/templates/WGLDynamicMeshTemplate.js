/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/Logger","../../../../../../core/promiseUtils","../../../../../../symbols/cim/cimAnalyzer","./WGLMeshTemplate"],(function(e,t,a,i,r){"use strict";const n=t.getLogger("esri.views.2d.engine.webgl.WGLDynamicMeshTemplate");return function(t){function r(e){var a;return(a=t.call(this)||this)._ongoingMaterialRequestMap=new Map,a._materialCache=new Map,a._dynamicPropertyMap=new Map,a._cimLayer=e,a}return e._inheritsLoose(r,t),r.prototype.analyze=function(e,t,r,s){const o=t.readLegacyFeature(),c=this._materialCache,l=this._cimLayer.materialHash;if(!l)return n.error("A Dynamic mesh template must have a material hash value or function!"),a.reject(null);const u="function"==typeof l?l(o,r,s):l;if(c.has(u)){const e=c.get(u);return a.resolve(e)}if(this._ongoingMaterialRequestMap.has(u))return this._ongoingMaterialRequestMap.get(u);const h=i.analyzeCIMResource(this._cimLayer.cim,this._cimLayer.materialOverrides);h.mosaicHash=u;const g=e.getMosaicItem(h).then((e=>(this._ongoingMaterialRequestMap.delete(u),c.set(u,e),e))).catch((e=>(this._ongoingMaterialRequestMap.delete(u),n.error(".analyze()",e.message),null)));return this._ongoingMaterialRequestMap.set(u,g),g},r}(r)}));
