/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/Logger","../../../../../../symbols/cim/cimAnalyzer","../../../../../../symbols/cim/utils","./WGLMeshTemplate"],(function(e,t,a,n,i){"use strict";const r=t.getLogger("esri.views.2d.engine.webgl.WGLDynamicMeshTemplate");return function(t){function i(e){var a;return(a=t.call(this)||this)._ongoingMaterialRequestMap=new Map,a._materialCache=new Map,a._dynamicPropertyMap=new Map,a._cimLayer=e,a}return e._inheritsLoose(i,t),i.prototype.analyze=function(e,t,i,l,s){if(s&&0===s.length)return null;const o=s&&s.length>0,u=t.readLegacyFeature(),c=t.getObjectId(),m=this._materialCache,h=this._cimLayer.materialHash;if(!h)return r.error("A Dynamic mesh template must have a material hash value or function!"),Promise.reject(null);const g="function"==typeof h?h(u,i,l,c):h,p=m.get(g);if(null!=p)return Promise.resolve(p);const y=this._ongoingMaterialRequestMap.get(g);if(y)return y;const M=this._cimLayer,d=a.analyzeCIMResource(M.cim,this._cimLayer.materialOverrides);d.mosaicHash=g;const{type:f,url:_}=M,b={cim:d,type:f,mosaicHash:g,url:_,size:null,dashTemplate:null,text:null,fontName:null,objectId:c,animatedSymbolProperties:null};switch(f){case"marker":b.size=n.evaluateValueOrFunction(M.size,u,i,l),b.animatedSymbolProperties=n.evaluateValueOrFunction(M.animatedSymbolProperties,u,i,l);break;case"line":b.dashTemplate=M.dashTemplate;break;case"text":b.text=n.evaluateValueOrFunction(M.text,u,i,l),b.fontName=n.evaluateValueOrFunction(M.fontName,u,i,l)}const v=e.getMosaicItem(b,s).then((e=>(o||(this._ongoingMaterialRequestMap.delete(g),m.set(g,e)),e))).catch((e=>(this._ongoingMaterialRequestMap.delete(g),r.error(".analyze()",e.message),null)));return o||this._ongoingMaterialRequestMap.set(g,v),v},i}(i)}));
