/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import e from"../../../../../../core/Logger.js";import{analyzeCIMResource as t}from"../../../../../../symbols/cim/cimAnalyzer.js";import{evaluateValueOrFunction as a}from"../../../../../../symbols/cim/utils.js";import s from"./WGLMeshTemplate.js";const i=e.getLogger("esri.views.2d.engine.webgl.WGLDynamicMeshTemplate");class r extends s{constructor(e){super(),this._ongoingMaterialRequestMap=new Map,this._materialCache=new Map,this._dynamicPropertyMap=new Map,this._cimLayer=e}analyze(e,s,r,n,o){if(o&&0===o.length)return null;const l=o&&o.length>0,m=s.readLegacyFeature(),c=s.getObjectId(),h=this._materialCache,u=this._cimLayer.materialHash;if(!u)return i.error("A Dynamic mesh template must have a material hash value or function!"),Promise.reject(null);const p="function"==typeof u?u(m,r,n,c):u;if(h.has(p)){const e=h.get(p);return Promise.resolve(e)}const g=this._ongoingMaterialRequestMap.get(p);if(g)return g;const y=this._cimLayer,M=t(y.cim,this._cimLayer.materialOverrides);M.mosaicHash=p;const{type:d,url:f}=y,_={cim:M,type:d,mosaicHash:p,url:f,size:null,dashTemplate:null,text:null,fontName:null,objectId:c,animatedSymbolProperties:null};switch(d){case"marker":_.size=a(y.size,m,r,n),_.animatedSymbolProperties=a(y.animatedSymbolProperties,m,r,n);break;case"line":_.dashTemplate=y.dashTemplate;break;case"text":_.text=a(y.text,m,r,n),_.fontName=a(y.fontName,m,r,n)}const b=e.getMosaicItem(_,o).then((e=>(l||(this._ongoingMaterialRequestMap.delete(p),h.set(p,e)),e))).catch((e=>(this._ongoingMaterialRequestMap.delete(p),i.error(".analyze()",e.message),null)));return l||this._ongoingMaterialRequestMap.set(p,b),b}}export{r as default};
