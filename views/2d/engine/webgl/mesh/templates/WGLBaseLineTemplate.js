// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../../../core/has","../../definitions","../../enums","../../number","../../TileClipper","../../TurboLine","../../materialKey/MaterialKey"],(function(t,e,i,r,n,s,o,l,a,h){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var u=n.TILE_SIZE+16,f=new l.TileClipper(0,0,0,1,16);f.setExtent(n.TILE_SIZE);var c=0,p=0;r("esri-tiles-performance")&&setInterval((function(){console.log("New (FL)","feat="+p,"secs="+c,"tris=0","tris/sec="+Math.round(0/c))}),1e4);var _=new Uint32Array(9),d=new Uint32Array(36),y=new Uint32Array(3),x=new Uint32Array(6),v=function(t){return function(e){var i=Math.ceil(1024*t._halfWidth),r=Math.ceil(1024*t._halfReferenceWidth);e.entry0=t.offset+t.vertexCount++;var n=o.i1616to32(e.distance,i),s=o.i8888to32(Math.round(31*e.prevNormal.x),Math.round(31*e.prevNormal.y),Math.round(0),Math.round(-31)),l=o.i8888to32(0,0,0,t._bitset);d[0]=o.i1616to32(8*e.currentVertex.x,8*e.currentVertex.y),d[1]=t.id,d[2]=t._fillColor,d[3]=s,d[4]=n,d[5]=t._tl,d[6]=t._br,d[7]=l,d[8]=o.i1616to32(r,0),e.entry2=t.offset+t.vertexCount++;n=o.i1616to32(e.distance,i),s=o.i8888to32(Math.round(31*-e.prevNormal.x),Math.round(31*-e.prevNormal.y),Math.round(0),Math.round(31)),l=o.i8888to32(0,0,0,t._bitset);d[9]=o.i1616to32(8*e.currentVertex.x,8*e.currentVertex.y),d[10]=t.id,d[11]=t._fillColor,d[12]=s,d[13]=n,d[14]=t._tl,d[15]=t._br,d[16]=l,d[17]=o.i1616to32(r,0),e.exit0=t.offset+t.vertexCount++;n=o.i1616to32(e.distance,i),s=o.i8888to32(Math.round(31*e.nextNormal.x),Math.round(31*e.nextNormal.y),Math.round(0),Math.round(-31)),l=o.i8888to32(0,0,0,t._bitset);d[18]=o.i1616to32(8*e.currentVertex.x,8*e.currentVertex.y),d[19]=t.id,d[20]=t._fillColor,d[21]=s,d[22]=n,d[23]=t._tl,d[24]=t._br,d[25]=l,d[26]=o.i1616to32(r,0),e.exit2=t.offset+t.vertexCount++;n=o.i1616to32(e.distance,i),s=o.i8888to32(Math.round(31*-e.nextNormal.x),Math.round(31*-e.nextNormal.y),Math.round(0),Math.round(31)),l=o.i8888to32(0,0,0,t._bitset);d[27]=o.i1616to32(8*e.currentVertex.x,8*e.currentVertex.y),d[28]=t.id,d[29]=t._fillColor,d[30]=s,d[31]=n,d[32]=t._tl,d[33]=t._br,d[34]=l,d[35]=o.i1616to32(r,0),t.geometryBuf.writeRegion(d)}},m=function(t){return function(e){x[0]=e.leftExit0,x[1]=e.rightEntry0,x[2]=e.leftExit2,x[3]=e.rightEntry0,x[4]=e.rightEntry2,x[5]=e.leftExit2,t.indexCount+=6,t.indexBuf.writeRegion(x)}},C=function(t){return function(e,i,r,n,s,l,a,h,u){var f=o.i1616to32(u,Math.ceil(1024*t._halfWidth)),c=o.i8888to32(Math.round(31*s),Math.round(31*l),Math.round(31*a),Math.round(31*h)),p=o.i8888to32(31*r,31*n,0,t._bitset);return _[0]=o.i1616to32(8*e,8*i),_[1]=t.id,_[2]=t._fillColor,_[3]=c,_[4]=f,_[5]=t._tl,_[6]=t._br,_[7]=p,_[8]=o.i1616to32(Math.ceil(1024*t._halfReferenceWidth),0),t.geometryBuf.writeRegion(_),t.offset+t.vertexCount++}},g=function(t){return function(e,i,r){y[0]=e,y[1]=i,y[2]=r,t.indexCount+=3,t.indexBuf.writeRegion(y)}};e.default=function(t){return function(t){function e(){for(var e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];var r=t.apply(this,e)||this;return r.tessellationProperties={_fillColor:null,_tl:null,_br:null,_halfWidth:null,_bitset:null,_halfReferenceWidth:null,id:null,indexBuf:null,indexCount:null,geometryBuf:null,vertexCount:null,offset:null},r._tessellationOptions={},r.geometryType=s.WGLGeometryType.LINE,r}return i.__extends(e,t),e.prototype.writeMeshWithGeometry=function(t,e,i,r,n,s){var o=e.indexVector,l=e.get("geometry"),a=e.getVector("geometry").vertexCount,h=o.length,u=null!=s?s:i.readLegacyGeometry();if(u){switch(r){case"esriGeometryPolyline":if(0===(f=this._clipLines(u.paths)).length)return;this._write(o,l,a,n,f);break;case"esriGeometryPolygon":var f;if(0===(f=this._clipLines(u.rings)).length)return;this._write(o,l,a,n,f)}var c=this.tessellationProperties.vertexCount,p=this.tessellationProperties.indexCount;t.writeDisplayRecord(this.geometryType,this._materialKey,a,c,h,p)}},e.prototype._clipLines=function(t){for(var e=[],i=!1,r=0;r<t.length;){var n=[],s=t[r];f.reset(2);var o=s[0],l=o[0],a=o[1];if(i)f.moveTo(l,a);else{if(l<-16||l>u||a<-16||a>u){i=!0;continue}n.push({x:l,y:a})}for(var h=!1,c=s.length,p=1;p<c;++p)if(l+=s[p][0],a+=s[p][1],i)f.lineTo(l,a);else{if(l<-16||l>u||a<-16||a>u){h=!0;break}n.push({x:l,y:a})}if(h)i=!0;else{if(i){var _=f.resultWithStarts();if(_)for(var d=0,y=_;d<y.length;d++){var x=y[d];e.push(x)}}else e.push({line:n,start:0});r++,i=!1}}return e},e.prototype._write=function(t,e,i,n,s){var o;r("esri-tiles-performance")&&(o=performance.now()),this.tessellationProperties.id=n,this.tessellationProperties.indexBuf=t,this.tessellationProperties.indexCount=0,this.tessellationProperties.geometryBuf=e,this.tessellationProperties.vertexCount=0,this.tessellationProperties.offset=i;for(var l=0,h=s;l<h.length;l++){var u=h[l],f=u.line;f.length<2||(this._tessellationOptions.initialDistance=u.start%65535,this._tessellationCallbacks instanceof a.StandardTessellationCallbacks&&(this._tessellationCallbacks.capType=this._capType,this._tessellationCallbacks.joinType=this._joinType),a.tessellate(f,this._tessellationOptions,this._tessellationCallbacks),a.cleanup(),r("esri-tiles-performance")&&p++)}r("esri-tiles-performance")&&(c+=(performance.now()-o)/1e3)},e.prototype._initializeTessellator=function(t){var e=h.LineMaterialKey.load(this._materialKey);if(this._tessellationOptions.trackDistance=this._isDashed||this._hasPattern,this._tessellationOptions.thin=!t&&this.tessellationProperties._halfWidth<n.THIN_LINE_THRESHOLD/2&&!(e.vvSizeFieldStops||e.vvSizeMinMaxValue||e.vvSizeScaleStops||e.vvSizeUnitValue),this._tessellationOptions.wrapDistance=65535,this._tessellationOptions.outerBisectorAutoSplitThreshold=1/3.8,this._tessellationOptions.enableOuterBisectorSplit=this._isDashed||this._hasPattern,this._tessellationOptions.innerBisectorAutoSplitThreshold=1/3.8,this._tessellationOptions.enableInnerBisectorSplit=this._isDashed||this._hasPattern,this._tessellationOptions.thin)this._tessellationCallbacks={vertex:v(this.tessellationProperties),bridge:m(this.tessellationProperties)};else{var i=new a.StandardTessellationCallbacks(C(this.tessellationProperties),g(this.tessellationProperties));i.miterLimitCosine=this._miterLimitCosine,i.textured=this._isDashed||this._hasPattern,i.joinOnUTurn=this._joinOnUTurn,this._tessellationCallbacks=i}},e}(t)}}));