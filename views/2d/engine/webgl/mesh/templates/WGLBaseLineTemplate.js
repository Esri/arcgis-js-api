/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/has","../../definitions","../../number","../../enums","../../materialKey/MaterialKey","../../TileClipper","../../TurboLine"],(function(t,e,i,s,n,o,r,l){"use strict";const a=-16,h=i.TILE_SIZE+16,u=31,c=1024,_=1/3.8,f=new r.TileClipper(0,0,0,1,16);f.setExtent(i.TILE_SIZE);const d=new Uint32Array(9),p=new Uint32Array(36),x=new Uint32Array(3),y=new Uint32Array(6),C=t=>e=>{const i=Math.ceil(c*t._halfWidth),n=Math.ceil(c*t._halfReferenceWidth);e.entry0=t.offset+t.vertexCount++;{const o=s.i1616to32(e.distance,i),r=s.i8888to32(Math.round(u*e.prevNormal.x),Math.round(u*e.prevNormal.y),Math.round(0),Math.round(-31)),l=s.i8888to32(0,0,0,t._bitset);p[0]=s.i1616to32(8*e.currentVertex.x,8*e.currentVertex.y),p[1]=t.id,p[2]=t._fillColor,p[3]=r,p[4]=o,p[5]=t._tl,p[6]=t._br,p[7]=l,p[8]=s.i1616to32(n,0)}e.entry2=t.offset+t.vertexCount++;{const o=s.i1616to32(e.distance,i),r=s.i8888to32(Math.round(u*-e.prevNormal.x),Math.round(u*-e.prevNormal.y),Math.round(0),Math.round(31)),l=s.i8888to32(0,0,0,t._bitset);p[9]=s.i1616to32(8*e.currentVertex.x,8*e.currentVertex.y),p[10]=t.id,p[11]=t._fillColor,p[12]=r,p[13]=o,p[14]=t._tl,p[15]=t._br,p[16]=l,p[17]=s.i1616to32(n,0)}e.exit0=t.offset+t.vertexCount++;{const o=s.i1616to32(e.distance,i),r=s.i8888to32(Math.round(u*e.nextNormal.x),Math.round(u*e.nextNormal.y),Math.round(0),Math.round(-31)),l=s.i8888to32(0,0,0,t._bitset);p[18]=s.i1616to32(8*e.currentVertex.x,8*e.currentVertex.y),p[19]=t.id,p[20]=t._fillColor,p[21]=r,p[22]=o,p[23]=t._tl,p[24]=t._br,p[25]=l,p[26]=s.i1616to32(n,0)}e.exit2=t.offset+t.vertexCount++;{const o=s.i1616to32(e.distance,i),r=s.i8888to32(Math.round(u*-e.nextNormal.x),Math.round(u*-e.nextNormal.y),Math.round(0),Math.round(31)),l=s.i8888to32(0,0,0,t._bitset);p[27]=s.i1616to32(8*e.currentVertex.x,8*e.currentVertex.y),p[28]=t.id,p[29]=t._fillColor,p[30]=r,p[31]=o,p[32]=t._tl,p[33]=t._br,p[34]=l,p[35]=s.i1616to32(n,0)}t.geometryBuf.writeRegion(p)},m=t=>e=>{y[0]=e.leftExit0,y[1]=e.rightEntry0,y[2]=e.leftExit2,y[3]=e.rightEntry0,y[4]=e.rightEntry2,y[5]=e.leftExit2,t.indexCount+=6,t.indexBuf.writeRegion(y)},b=t=>(e,i,n,o,r,l,a,h,_)=>{const f=s.i1616to32(_,Math.ceil(c*t._halfWidth)),p=s.i8888to32(Math.round(u*r),Math.round(u*l),Math.round(u*a),Math.round(u*h)),x=s.i8888to32(u*n,u*o,0,t._bitset);return d[0]=s.i1616to32(8*e,8*i),d[1]=t.id,d[2]=t._fillColor,d[3]=p,d[4]=f,d[5]=t._tl,d[6]=t._br,d[7]=x,d[8]=s.i1616to32(Math.ceil(c*t._halfReferenceWidth),0),t.geometryBuf.writeRegion(d),t.offset+t.vertexCount++},M=t=>(e,i,s)=>{x[0]=e,x[1]=i,x[2]=s,t.indexCount+=3,t.indexBuf.writeRegion(x)};return e=>function(e){function s(...t){var i;return(i=e.call(this,...t)||this).tessellationProperties={_fillColor:null,_tl:null,_br:null,_halfWidth:null,_bitset:null,_halfReferenceWidth:null,id:null,indexBuf:null,indexCount:null,geometryBuf:null,vertexCount:null,offset:null},i._tessellationOptions={},i.geometryType=n.WGLGeometryType.LINE,i}t._inheritsLoose(s,e);var r=s.prototype;return r.writeMeshWithGeometry=function(t,e,i,s,n,o){const r=e.indexVector,l=e.get("geometry"),a=e.getVector("geometry").vertexCount,h=r.length,u=null!=o?o:i.readLegacyGeometry();if(!u)return;switch(s){case"esriGeometryPolyline":{const t=this._clipLines(u.paths);if(0===t.length)return;this._write(r,l,a,n,t);break}case"esriGeometryPolygon":{const t=this._clipLines(u.rings);if(0===t.length)return;this._write(r,l,a,n,t);break}}const c=this.tessellationProperties.vertexCount,_=this.tessellationProperties.indexCount;t.writeDisplayRecord(this.geometryType,this._materialKey,a,c,h,_)},r._clipLines=function(t){const e=[];let i=!1,s=0;for(;s<t.length;){const n=[],o=t[s];f.reset(2);let[r,l]=o[0];if(i)f.moveTo(r,l);else{if(r<a||r>h||l<a||l>h){i=!0;continue}n.push({x:r,y:l})}let u=!1;const c=o.length;for(let t=1;t<c;++t)if(r+=o[t][0],l+=o[t][1],i)f.lineTo(r,l);else{if(r<a||r>h||l<a||l>h){u=!0;break}n.push({x:r,y:l})}if(u)i=!0;else{if(i){const t=f.resultWithStarts();if(t)for(const i of t)e.push(i)}else e.push({line:n,start:0});s++,i=!1}}return e},r._write=function(t,e,i,s,n){this.tessellationProperties.id=s,this.tessellationProperties.indexBuf=t,this.tessellationProperties.indexCount=0,this.tessellationProperties.geometryBuf=e,this.tessellationProperties.vertexCount=0,this.tessellationProperties.offset=i;for(const t of n){const e=t.line;e.length<2||(this._tessellationOptions.initialDistance=t.start%65535,this._tessellationCallbacks instanceof l.StandardTessellationCallbacks&&(this._tessellationCallbacks.capType=this._capType,this._tessellationCallbacks.joinType=this._joinType),l.tessellate(e,this._tessellationOptions,this._tessellationCallbacks),l.cleanup())}},r._initializeTessellator=function(t){const e=o.LineMaterialKey.load(this._materialKey);if(this._tessellationOptions.trackDistance=this._isDashed||this._hasPattern,this._tessellationOptions.thin=!t&&this.tessellationProperties._halfWidth<i.THIN_LINE_THRESHOLD/2&&!(e.vvSizeFieldStops||e.vvSizeMinMaxValue||e.vvSizeScaleStops||e.vvSizeUnitValue),this._tessellationOptions.wrapDistance=65535,this._tessellationOptions.outerBisectorAutoSplitThreshold=_,this._tessellationOptions.enableOuterBisectorSplit=this._isDashed||this._hasPattern,this._tessellationOptions.innerBisectorAutoSplitThreshold=_,this._tessellationOptions.enableInnerBisectorSplit=this._isDashed||this._hasPattern,this._tessellationOptions.thin)this._tessellationCallbacks={vertex:C(this.tessellationProperties),bridge:m(this.tessellationProperties)};else{const t=new l.StandardTessellationCallbacks(b(this.tessellationProperties),M(this.tessellationProperties));t.miterLimitCosine=this._miterLimitCosine,t.textured=this._isDashed||this._hasPattern,t.joinOnUTurn=this._joinOnUTurn,this._tessellationCallbacks=t}},s}(e)}));
