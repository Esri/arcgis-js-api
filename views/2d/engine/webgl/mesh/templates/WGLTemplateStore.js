/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/Error","../../../../../../core/Logger","../../../../../../core/promiseUtils","../../../../../../symbols/support/defaultsJSON","../../enums","../../materialKey/MaterialKey","./WGLDynamicFillTemplate","./WGLDynamicLineTemplate","./WGLDynamicMarkerTemplate","./WGLDynamicTextTemplate","./WGLFillTemplate","./WGLLineTemplate","./WGLMarkerTemplate","./WGLTextTemplate","../../util/Lock","../../util/Result","../../../../layers/features/textUtils","../../../../layers/support/cimSymbolUtils"],(function(e,t,r,i,n,o,s,a,c,l,u,m,h,p,f,y,_,T,M,I){"use strict";const d=i.getLogger("esri.views.2d.engine.webgl.mesh.templates.WGLTemplateStore"),S=new Array,g={isOutline:!1,isOutlinedFill:!1,placement:null,stride:{fill:"default"},vvFlags:0},k={...o.errorPointSymbolJSON,hash:JSON.stringify(o.errorPointSymbolJSON),materialKey:a.createMaterialKey(s.WGLGeometryType.MARKER,g)},G={...o.errorPolylineSymbolJSON,hash:JSON.stringify(o.errorPolylineSymbolJSON),materialKey:a.createMaterialKey(s.WGLGeometryType.LINE,g)},L={...o.errorPolygonSymbolJSON,hash:JSON.stringify(o.errorPolygonSymbolJSON),materialKey:a.createMaterialKey(s.WGLGeometryType.FILL,g)};function b(e,t){const r=e.length;return e.push(null),t.then((t=>e[r]=t)),e}function C(e){return!!(1&e)}function v(e){return"worker:port-closed"===e.name}let P=function(){function e(e,t){this._idCounter=1,this._templateIdCounter=1,this._idToTemplateGroup=new Map,this._symbolToTemplate=new Map,this._fetchQueue=[],this._idToResolver=new Map,this._cimTemplateCache=new Map,this._cimAnalyses=[],this._lock=new _.default,this._fetchResource=e,this._tileInfo=t}var i=e.prototype;return i.createTemplateGroup=function(e,t){this._initErrorTemplates();const r=e.hash;if(this._symbolToTemplate.has(r))return this._symbolToTemplate.get(r);const i=new Array;t&&this._createMeshTemplates(i,t,!0),this._createMeshTemplates(i,e,!1);const n=this._createGroupId("expanded-cim"===e.type&&w(e));return this._idToTemplateGroup.set(n,i),this._symbolToTemplate.set(r,n),n},i.getTemplateGroup=function(e){return this._idToTemplateGroup.has(e)?this._idToTemplateGroup.get(e):S},i.getDynamicTemplateGroup=function(e){return this._idToTemplateGroup.has(e)?(C(e)||d.error("mapview-template-store",`Id ${e} does not refer to a dynamic template`),this._idToTemplateGroup.get(e)):S},i.getMosaicItem=function(e,t){const r=this._createTemplateId(),i=new Promise((e=>this._idToResolver.set(r,e)));return this._fetchQueue.push({symbol:e,id:r,glyphIds:t}),i},i.finalize=function(e){return this._fetchQueue.length||this._lock.isHeld()?_.withLock(this._lock,this._fetchAllQueuedResources.bind(this),e):Promise.resolve()},i._initErrorTemplates=function(){this._errorTemplates||(this._errorTemplates={fill:this._createMeshTemplates([],L,!1),marker:this._createMeshTemplates([],k,!1),line:this._createMeshTemplates([],G,!1)})},i._fetchAllQueuedResources=function(e){if(!this._fetchQueue.length)return Promise.resolve();const t=this._fetchQueue,i=this._cimAnalyses;return this._fetchQueue=[],this._cimAnalyses=[],Promise.all(i).then((()=>this._fetchResource(t,e).then((e=>{for(const{id:t,mosaicItem:r}of e){this._idToResolver.get(t)(r),this._idToResolver.delete(t)}})))).catch((e=>{n.isAbortError(e)?this._fetchQueue=this._fetchQueue.concat(t):v(e)||d.error(new r("mapview-template-store","Unable to fetch requested texture resources",e))}))},i._createGroupId=function(e){return this._idCounter++<<1|(e?1:0)},i._createTemplateId=function(){return this._templateIdCounter++},i._createSMS=function(){var e=t._asyncToGenerator((function*(e){const{spriteMosaicItem:t}=yield this.getMosaicItem(e);return T.ok(t,d)?f.fromSimpleMarker(e,t):this._markerError}));function r(t){return e.apply(this,arguments)}return r}(),i._createPMS=function(){var e=t._asyncToGenerator((function*(e){const{spriteMosaicItem:t}=yield this.getMosaicItem(e);return T.ok(t,d)?f.fromPictureMarker(e,t):this._markerError}));function r(t){return e.apply(this,arguments)}return r}(),i._createSFS=function(){var e=t._asyncToGenerator((function*(e,t){const{spriteMosaicItem:r}=yield this.getMosaicItem(e);return T.ok(r,d)?h.fromSimpleFill(e,r,t):this._fillError}));function r(t,r){return e.apply(this,arguments)}return r}(),i._createPFS=function(){var e=t._asyncToGenerator((function*(e,t){const{spriteMosaicItem:r}=yield this.getMosaicItem(e);return T.ok(r,d)?h.fromPictureFill(e,r,t):this._fillError}));function r(t,r){return e.apply(this,arguments)}return r}(),i._createSLS=function(){var e=t._asyncToGenerator((function*(e,t){const{spriteMosaicItem:r}=yield this.getMosaicItem(e);return T.ok(r,d)?p.fromSimpleLine(e,r):this._lineError}));function r(t,r){return e.apply(this,arguments)}return r}(),i._createLMS=function(){var e=t._asyncToGenerator((function*(e){const{spriteMosaicItem:t}=yield this.getMosaicItem(e);return T.ok(t,d)?f.fromLineSymbolMarker(e,t):this._markerError}));function r(t){return e.apply(this,arguments)}return r}(),i._createTS=function(){var e=t._asyncToGenerator((function*(e){const{glyphMosaicItems:t}=yield this.getMosaicItem(e);return y.fromText(e,t)}));function r(t){return e.apply(this,arguments)}return r}(),i._createCIMText=function(){var e=t._asyncToGenerator((function*(e){const{glyphMosaicItems:t}=yield this.getMosaicItem(I.cimLayerToRasterizationInfo(e),M.codepoints(e.text));return T.ok(t,d)?y.fromCIMText(e,t,this._tileInfo):this._textError}));function r(t){return e.apply(this,arguments)}return r}(),i._createCIMFill=function(){var e=t._asyncToGenerator((function*(e){const{spriteMosaicItem:t}=yield this.getMosaicItem(I.cimLayerToRasterizationInfo(e));return T.ok(t,d)?h.fromCIMFill(e,t,this._tileInfo):this._fillError}));function r(t){return e.apply(this,arguments)}return r}(),i._createCIMLine=function(){var e=t._asyncToGenerator((function*(e){const{spriteMosaicItem:t}=yield this.getMosaicItem(I.cimLayerToRasterizationInfo(e));return T.ok(t,d)?p.fromCIMLine(e,t,this._tileInfo):this._lineError}));function r(t){return e.apply(this,arguments)}return r}(),i._createCIMMarker=function(){var e=t._asyncToGenerator((function*(e){const{spriteMosaicItem:t}=yield this.getMosaicItem(I.cimLayerToRasterizationInfo(e));return T.ok(t,d)?f.fromCIMMarker(e,t,this._tileInfo):this._markerError}));function r(t){return e.apply(this,arguments)}return r}(),i._createCIM=function(){var e=t._asyncToGenerator((function*(e){const t=e.templateHash;if(this._cimTemplateCache.has(t))return this._cimTemplateCache.get(t);let r;switch(e.type){case"marker":r=yield this._createCIMMarker(e);break;case"line":r=yield this._createCIMLine(e);break;case"fill":r=yield this._createCIMFill(e);break;case"text":r=yield this._createCIMText(e)}return this._cimTemplateCache.set(t,r),r}));function r(t){return e.apply(this,arguments)}return r}(),i._createDynamicCIM=function(){var e=t._asyncToGenerator((function*(e){const t=e.templateHash;if(this._cimTemplateCache.has(t))return this._cimTemplateCache.get(t);let r;switch(e.type){case"marker":r=u.fromCIMMarker(e,this._tileInfo);break;case"line":r=l.fromCIMLine(e,this._tileInfo);break;case"fill":r=c.fromCIMFill(e,this._tileInfo);break;case"text":r=m.fromCIMText(e,this._tileInfo)}return this._cimTemplateCache.set(t,r),r}));function r(t){return e.apply(this,arguments)}return r}(),i._createPrimitiveMeshTemplates=function(e,t,r){switch(t.type){case"esriSMS":return b(e,this._createSMS(t));case"esriPMS":return b(e,this._createPMS(t));case"esriSFS":return b(e,this._createSFS(t,r));case"line-marker":return b(e,this._createLMS(t));case"esriPFS":return b(e,this._createPFS(t,r));case"esriSLS":return b(e,this._createSLS(t,!1));case"esriTS":return b(e,this._createTS(t));default:return d.error("Unable to create mesh template for unknown symbol type {: $ }{symbol.type}"),e}},i._createMeshTemplates=function(e,t,r){if(-1!==t.type.indexOf("3d"))return d.error("3D symbols are not supported with MapView"),e;if("expanded-cim"===t.type){for(const r of t.layers)"function"==typeof r.materialHash?b(e,this._createDynamicCIM(r)):b(e,this._createCIM(r));return e}if("composite-symbol"===t.type){for(const i of t.layers)this._createPrimitiveMeshTemplates(e,i,r);return e}return"cim"===t.type||"label"===t.type||"web-style"===t.type?e:this._createPrimitiveMeshTemplates(e,t,r)},t._createClass(e,[{key:"_markerError",get:function(){return this._errorTemplates.marker[0]}},{key:"_fillError",get:function(){return this._errorTemplates.fill[0]}},{key:"_lineError",get:function(){return this._errorTemplates.line[0]}},{key:"_textError",get:function(){return this._errorTemplates.line[0]}}]),e}();const w=e=>{if(!e.layers)return!1;for(const t of e.layers)if("function"==typeof t.materialHash)return!0;return!1};e.WGLTemplateStore=P,e.errorPointSchema2D=k,e.errorPolygonSchema2D=L,e.errorPolylineSchema2D=G,e.isDynamicId=C,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
