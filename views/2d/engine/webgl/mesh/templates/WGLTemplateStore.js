// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../../../core/Error","../../../../../../core/Logger","../../../../../../core/promiseUtils","../../../../../../symbols/support/defaults","./WGLDynamicFillTemplate","./WGLDynamicLineTemplate","./WGLDynamicMarkerTemplate","./WGLDynamicTextTemplate","./WGLFillTemplate","./WGLLineTemplate","./WGLMarkerTemplate","./WGLTextTemplate","../../util/Lock","../../util/Result","../../../../layers/features/schemaUtils","../../../../layers/features/textUtils"],(function(e,t,r,i,a,o,s,n,c,u,l,h,m,p,_,f,d,y,T){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WGLTemplateStore=t.isDynamicId=void 0;var M=a.getLogger("esri.views.2d.engine.webgl.mesh.templates.WGLTemplateStore"),v=new Array;function g(e,t){var r=e.length;return e.push(null),t.then((function(t){return e[r]=t})),e}function b(e){return!!(1&e)}t.isDynamicId=b;var I=function(){function e(e,t){this._idCounter=1,this._templateIdCounter=1,this._idToTemplateGroup=new Map,this._symbolToTemplate=new Map,this._fetchQueue=[],this._idToResolver=new Map,this._cimTemplateCache=new Map,this._cimAnalyses=[],this._lock=new f.default,this._fetchResource=e,this._joinOnUTurn=t}return Object.defineProperty(e.prototype,"_markerError",{get:function(){return this._errorTemplates.marker[0]},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"_fillError",{get:function(){return this._errorTemplates.fill[0]},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"_lineError",{get:function(){return this._errorTemplates.line[0]},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"_textError",{get:function(){return this._errorTemplates.line[0]},enumerable:!1,configurable:!0}),e.prototype.createTemplateGroup=function(e,t){this._initErrorTemplates();var r=e.hash;if(this._symbolToTemplate.has(r))return this._symbolToTemplate.get(r);var i=new Array;t&&this._createMeshTemplates(i,t,!0),this._createMeshTemplates(i,e,!1);var a=this._createGroupId("expanded-cim"===e.type);return this._idToTemplateGroup.set(a,i),this._symbolToTemplate.set(r,a),a},e.prototype.getTemplateGroup=function(e){return this._idToTemplateGroup.has(e)?this._idToTemplateGroup.get(e):v},e.prototype.getDynamicTemplateGroup=function(e){return this._idToTemplateGroup.has(e)?(b(e)||M.error("mapview-template-store","Id "+e+" does not refer to a dynamic template"),this._idToTemplateGroup.get(e)):v},e.prototype.getMosaicItem=function(e,t){var r=this,i=this._createTemplateId(),a=o.create((function(e){return r._idToResolver.set(i,e)}));return this._fetchQueue.push({symbol:e,id:i,glyphIds:t}),a},e.prototype.finalize=function(e){return this._fetchQueue.length||this._lock.isHeld()?f.withLock(this._lock,this._fetchAllQueuedResources.bind(this),e):o.resolve()},e.prototype._initErrorTemplates=function(){this._errorTemplates||(this._errorTemplates={fill:this._createMeshTemplates([],y.createSymbolSchema(s.errorPolygonSymbol2D),!1),marker:this._createMeshTemplates([],y.createSymbolSchema(s.errorPointSymbol2D),!1),line:this._createMeshTemplates([],y.createSymbolSchema(s.errorPolylineSymbol2D),!1)})},e.prototype._fetchAllQueuedResources=function(e){var t=this;if(!this._fetchQueue.length)return o.resolve();var r=this._fetchQueue,a=this._cimAnalyses;return this._fetchQueue=[],this._cimAnalyses=[],o.all(a).then((function(){return t._fetchResource(r,e).then((function(e){for(var r=0,i=e;r<i.length;r++){var a=i[r],o=a.id,s=a.mosaicItem;t._idToResolver.get(o)(s),t._idToResolver.delete(o)}}))})).catch((function(e){o.isAbortError(e)?t._fetchQueue=t._fetchQueue.concat(r):function(e){return"worker:port-closed"===e.name}(e)||M.error(new i("mapview-template-store","Unable to fetch requested texture resources",e))}))},e.prototype._createGroupId=function(e){return this._idCounter++<<1|(e?1:0)},e.prototype._createTemplateId=function(){return this._templateIdCounter++},e.prototype._createSMS=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,this.getMosaicItem(e)];case 1:return t=r.sent().spriteMosaicItem,d.ok(t,M)?[2,p.default.fromSimpleMarker(e,t)]:[2,this._markerError]}}))}))},e.prototype._createPMS=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,this.getMosaicItem(e)];case 1:return t=r.sent().spriteMosaicItem,d.ok(t,M)?[2,p.default.fromPictureMarker(e,t)]:[2,this._markerError]}}))}))},e.prototype._createSFS=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var i;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,this.getMosaicItem(e)];case 1:return i=r.sent().spriteMosaicItem,d.ok(i,M)?[2,h.default.fromSimpleFill(e,i,t)]:[2,this._fillError]}}))}))},e.prototype._createPFS=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var i;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,this.getMosaicItem(e)];case 1:return i=r.sent().spriteMosaicItem,d.ok(i,M)?[2,h.default.fromPictureFill(e,i,t)]:[2,this._fillError]}}))}))},e.prototype._createSLS=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,this.getMosaicItem(e)];case 1:return t=r.sent().spriteMosaicItem,d.ok(t,M)?[2,m.default.fromSimpleLine(e,t,this._joinOnUTurn)]:[2,this._lineError]}}))}))},e.prototype._createLMS=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,this.getMosaicItem(e)];case 1:return t=r.sent().spriteMosaicItem,d.ok(t,M)?[2,p.default.fromLineSymbolMarker(e,t)]:[2,this._markerError]}}))}))},e.prototype._createTS=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,this.getMosaicItem(e)];case 1:return t=r.sent().glyphMosaicItems,[2,_.default.fromText(e,t)]}}))}))},e.prototype._createCIMText=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,this.getMosaicItem(e.cim,T.codepoints(e.text))];case 1:return t=r.sent().glyphMosaicItems,e.cim.mosaicHash=e.materialHash,d.ok(t,M)?[2,_.default.fromCIMText(e,t)]:[2,this._textError]}}))}))},e.prototype._createCIMFill=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(r){switch(r.label){case 0:return e.cim.mosaicHash=e.materialHash,[4,this.getMosaicItem(e.cim)];case 1:return t=r.sent().spriteMosaicItem,d.ok(t,M)?[2,h.default.fromCIMFill(e,t)]:[2,this._fillError]}}))}))},e.prototype._createCIMLine=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(r){switch(r.label){case 0:return e.cim.mosaicHash=e.materialHash,[4,this.getMosaicItem(e.cim)];case 1:return t=r.sent().spriteMosaicItem,d.ok(t,M)?[2,m.default.fromCIMLine(e,t,this._joinOnUTurn)]:[2,this._lineError]}}))}))},e.prototype._createCIMMarker=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(r){switch(r.label){case 0:return e.cim.mosaicHash=e.materialHash,[4,this.getMosaicItem(e.cim)];case 1:return t=r.sent().spriteMosaicItem,d.ok(t,M)?[2,p.default.fromCIMMarker(e,t)]:[2,this._markerError]}}))}))},e.prototype._createCIM=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,i,a=this;return r.__generator(this,(function(r){if(t=e.templateHash,this._cimTemplateCache.has(t))return[2,this._cimTemplateCache.get(t)];switch(e.type){case"marker":i=this._createCIMMarker(e);break;case"line":i=this._createCIMLine(e);break;case"fill":i=this._createCIMFill(e);break;case"text":i=this._createCIMText(e)}return i.then((function(e){return a._cimTemplateCache.set(t,e)})),[2,i]}))}))},e.prototype._createDynamicCIM=function(e){var t,r=e.templateHash;if(this._cimTemplateCache.has(r))return this._cimTemplateCache.get(r);switch(e.type){case"marker":t=u.default.fromCIMMarker(e);break;case"line":t=c.default.fromCIMLine(e);break;case"fill":t=n.default.fromCIMFill(e);break;case"text":t=l.default.fromCIMText(e)}return this._cimTemplateCache.set(r,t),t},e.prototype._createPrimitiveMeshTemplates=function(e,t,r){switch(t.type){case"esriSMS":return g(e,this._createSMS(t));case"esriPMS":return g(e,this._createPMS(t));case"esriSFS":return g(e,this._createSFS(t,r));case"line-marker":return g(e,this._createLMS(t));case"esriPFS":return g(e,this._createPFS(t,r));case"esriSLS":return g(e,this._createSLS(t,!1));case"esriTS":return g(e,this._createTS(t));default:return M.error("Unable to create mesh template for unknown symbol type {: $ }{symbol.type}"),e}},e.prototype._createMeshTemplates=function(e,t,r){if(-1!==t.type.indexOf("3d"))return M.error("3D symbols are not supported with MapView"),e;if("expanded-cim"===t.type){for(var i=0,a=t.layers;i<a.length;i++){"function"==typeof(n=a[i]).materialHash?e.push(this._createDynamicCIM(n)):g(e,this._createCIM(n))}return e}if("composite-symbol"===t.type){for(var o=0,s=t.layers;o<s.length;o++){var n=s[o];this._createPrimitiveMeshTemplates(e,n,r)}return e}return"cim"===t.type||"label"===t.type||"web-style"===t.type?e:this._createPrimitiveMeshTemplates(e,t,r)},e}();t.WGLTemplateStore=I}));