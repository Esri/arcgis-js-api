// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../../../core/Error","../../../../../../core/Logger","../../../../../../core/mathUtils","../../../../../../core/mathUtils","../../../../../../core/maybe","../../../../../../core/screenUtils","../../alignmentUtils","../../color","../../definitions","../../enums","../../number","../../collisions/Metric","../../materialKey/MaterialKey","./meshUtils","./segmentUtils","./WGLTextTemplate"],(function(e,t,i,r,n,o,a,s,l,h,c,u,f,m,p,d,g,_,y){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var v=n.getLogger("esri.views.2d.engine.webgl.WGLLabelTemplate");var x,b,M=(x=function(e){var t=0;if(0===e)return 1/0;for(;!(e%2);)t++,e/=2;return t},b=new Map,function(e){return b.has(e)||b.set(e,x(e)),b.get(e)}),w=function(e){return Math.floor(127*e+127)},L=function(e){return Math.floor(10*e)},P=function(e){return Math.round(e*(254/360))},S=function(e,t){return m.i1616to32(Math.round(8*e),Math.round(8*t))},A=function(e){function t(t,i,r,n){var a=e.call(this,t,r.font.size,r.haloSize||0,r.color&&c.premultiplyAlphaRGBAArray(r.color)||0,r.haloColor&&c.premultiplyAlphaRGBAArray(r.haloColor)||0,r.horizontalAlignment,r.verticalAlignment,g.isMapAligned(i.labelPlacement)?1:0,r.font.decoration,!1,r.angle||0,r.xoffset,r.yoffset,r.lineWidth,r.lineHeight,null,null)||this;a._outLineLabelAngle=0,a._refPlacementPadding=0,a._refPlacementDirX=0,a._refPlacementDirY=0,a._refOffsetX=0,a._refOffsetY=0,a.geometryType=f.WGLGeometryType.LABEL;var s=function(e,t){var i=!!e.minScale&&t.scaleToZoom(e.minScale)||0;return o.clamp(i,0,25.5)}(i,n),m=function(e,t){var i=!!e.maxScale&&t.scaleToZoom(e.maxScale)||255;return o.clamp(i,0,25.5)}(i,n),p=i.labelPlacement,_=h.getAlignmentFromPlacement(p),y=_[0],v=_[1];a._xAlignD=y,a._yAlignD=v,a._minZoom=s,a._maxZoom=m,a._refPlacementPadding=l.pt2px(r.haloSize)+u.TEXT_PLACEMENT_PADDING;var x=d.LabelMaterialKey.load(t);return x.sdf=!0,a._materialKey=x.data,a}return i.__extends(t,e),t.fromLabelClass=function(e,i){if("center-along"===e.labelPlacement){var r=e.symbol;r.xoffset=0,r.yoffset=0,r.angle=0,r.font.decoration="none"}return new t(e.materialKey,e,e.symbol,i)},Object.defineProperty(t.prototype,"_shapedBox",{get:function(){return s.unwrap(this._shapingInfo).bounds},enumerable:!1,configurable:!0}),t.prototype.bindReferenceTemplate=function(e){var t=h.getXDirection(this._xAlignD),i=h.getYDirection(this._yAlignD);if(this._refOffsetX=0,this._refOffsetY=0,s.isNone(e))this._refSymbolAndPlacementOffset=m.i8888to32(0,0,w(t),w(i));else{if("circle"===e.boundsType&&(t||i)){var r=Math.sqrt(t*t+i*i);t/=r,i/=r}var n=Math.max(e.height,e.width),o=4*this._refPlacementPadding;this._refSymbolAndPlacementOffset=m.i8888to32(o,n,w(t),w(i)),this._referenceSize=n,this._refPlacementDirX=t,this._refPlacementDirY=i,this._refOffsetX=e.xOffset,this._refOffsetY=e.yOffset}},t.prototype.writeMesh=function(e,t,i,n,o,a){if(!s.isNone(this._shapingInfo)){var l=new Array,h=this._shapingInfo,c="esriGeometryPolygon"===i.geometryType?i.readLegacyCentroid():i.readLegacyGeometry();if(c){switch(this.current={out:e,outVecs:t,outMetrics:l,inId:o,inShaping:h,zoomLevel:a},n){case"esriGeometryPolyline":this._placeLineLabels(c);break;case"esriGeometryPoint":case"esriGeometryPolygon":this._placePointLabels(c);break;default:u="mapview-labeling",void 0===(f="Geometry of type "+n+" is not supported")&&(f="mapview-labeling"),v.error(new r(f,u))}var u,f;e.writeMetrics(this.current.outMetrics)}}},t.prototype._isVisible=function(e,t){var i=L(this.current.zoomLevel);return L(e)<=i&&i<=L(t)},t.prototype._placePointLabels=function(e){var t=this.current,i=t.out,r=t.outVecs,n=t.outMetrics,o=t.inId;this._writeGlyphs(i,r,o,e,n)},t.prototype._placeLineLabels=function(e){for(var t=_.smoothPaths(e.paths,this.current.inShaping.bounds.width),i=this._placeSubdivGlyphs.bind(this),r=(this._shapedBox.width+128)/4,n=0,o=t;n<o.length;n++){var a=o[n];_.pathDivide(a,r,i)}},t.prototype._placeSubdivGlyphs=function(e,t,i,r){var n=M(t),o=this._shapedBox.width/4,s=Math.min(i,r-i),l=a.log2(s/(4+o/2)),h=0===t?l:Math.min(n,l),c=Math.max(this._minZoom,this.current.zoomLevel+2-h),u=this.current.zoomLevel-c,f=this._shapedBox.width/2*Math.pow(2,u);this.current.inShaping.isMultiline?0===t&&this._placeStraight(e,c):this._placeCurved(e,c,f)},t.prototype._placeStraight=function(e,t){var i=this.current,r=i.out,n=i.outVecs,o=i.outMetrics,a=i.inId;this._writeGlyphs(r,n,a,e,o,t)},t.prototype._placeCurved=function(e,t,i){var r={from:this.current.out.currentDisplayRecordCount(),count:-1},n=new p.default(this.current.inId,r,e.x,e.y,t),o=e.clone(),a=e.angle*(180/Math.PI)%360,s=(e.angle*(180/Math.PI)+180)%360;this._outLineLabelAngle=P(a),this._placeFirst(o,n,t,1),this._placeBack(e,o,n,t,i,1),this._placeForward(e,o,n,t,i,1),this._outLineLabelAngle=P(s),this._placeFirst(o,n,t,0),this._placeBack(e,o,n,t,i,0),this._placeForward(e,o,n,t,i,0),n.range.count=this.current.out.currentDisplayRecordCount()-n.range.from,n.bounds&&this.current.outMetrics.push(n)},t.prototype._placeBack=function(e,t,i,r,n,o){for(var a=e.clone(),s=e.backwardLength+0;a.prev()&&!(s>=n);)this._placeOnSegment(a,t,i,s,r,-1,o),s+=a.length+0},t.prototype._placeForward=function(e,t,i,r,n,o){for(var a=e.clone(),s=e.remainingLength+0;a.next()&&!(s>=n);)this._placeOnSegment(a,t,i,s,r,1,o),s+=a.length+0},t.prototype._placeFirst=function(e,t,i,r){for(var n=e,o=this.current.inShaping,s=o.glyphs,l=this.current.zoomLevel,h=this.current,c=h.out,u=h.outVecs,f=h.inId,m=S(n.x,n.y),p=0,d=s;p<d.length;p++){var g=d[p],_=g.x>o.bounds.x?r:1-r,y=_*e.remainingLength+(1-_)*e.backwardLength,v=Math.abs(g.x+g.width/2-o.bounds.x),x=Math.max(0,l+a.log2(v/(y+0))),b=Math.max(i,x);g.maxZoom=25,g.angle=e.angle+(1-r)*Math.PI,g.minZoom=b,this._writeGlyph(c,u,g,f,m),r&&this._isVisible(g.minZoom,g.maxZoom)&&t.add(g.bounds,0,0)}},t.prototype._placeOnSegment=function(e,t,i,r,n,o,s){for(var l=this.current.inShaping.glyphs,h=this.current,c=h.out,u=h.outVecs,f=h.inId,m=this.current.inShaping,p=this.current.zoomLevel,d=e.dx/e.length,g=e.dy/e.length,_={x:e.x+r*-o*d,y:e.y+r*-o*g},y=S(_.x,_.y),v=0,x=l;v<x.length;v++){var b=x[v],M=b.x>m.bounds.x?s:1-s;if(M&&1===o||!M&&-1===o){var w=Math.abs(b.x+b.width/2-m.bounds.x),L=Math.max(0,p+a.log2(w/r)-.1),P=Math.max(n,p+a.log2(w/(r+e.length+0)));0!==L&&(b.angle=e.angle+(1-s)*Math.PI,b.minZoom=P,b.maxZoom=L,this._writeGlyph(c,u,b,f,y),s&&this._isVisible(b.minZoom,b.maxZoom)&&i.add(b.bounds,e.x-t.x,e.y-t.y))}}},t.prototype._writeGlyphs=function(e,t,i,r,n,o){void 0===o&&(o=this._minZoom);var a=this._shapingInfo;if(!s.isNone(a)&&!(r.x<0||r.x>=512||r.y<0||r.y>=512)){for(var l=e.currentDisplayRecordCount(),h=S(r.x+this._refOffsetX,r.y-this._refOffsetY),c={from:l,count:-1},u=new p.default(i,c,r.x+this._refOffsetX,r.y-this._refOffsetY,o),f=0,m=a.glyphs;f<m.length;f++){var g=m[f];g.minZoom=o,g.maxZoom=this._maxZoom,this._writeGlyph(e,t,g,i,h)}u.range.count=e.currentDisplayRecordCount()-u.range.from,u.bounds=a.boundsT;var _=d.LabelMaterialKey.load(this._materialKey),y=this._refPlacementDirX,v=this._refPlacementDirY,x=_.vvSizeFieldStops||_.vvSizeMinMaxValue||_.vvSizeScaleStops||_.vvSizeUnitValue;u.setPlacementOffset(x,this._referenceSize,this._refPlacementPadding,y,v),n.push(u)}},t.prototype._writeGlyph=function(e,t,i,r,n){var o=d.MaterialKeyBase.load(this._materialKey);o.textureBinding=i.textureBinding;var a=t.indexVector.length,s=t.getVector("geometry").vertexCount,l=this._writeIndices(t),h=this._writeVertex(t,r,n,i);e.writeDisplayRecord(this.geometryType,o.data,s,h,a,l)},t.prototype._writeVertexCommon=function(e,t,i,r){var n=this._color,o=this._haloColor,a=m.i8888to32(0,0,this._size,this._haloSize),s=Math.max(r.minZoom,this._minZoom),l=Math.min(r.maxZoom,this._maxZoom),h=m.i8888to32(L(s),L(l),this._outLineLabelAngle,0);e.push(i),e.push(t),e.push(n),e.push(o),e.push(a),e.push(this._refSymbolAndPlacementOffset),e.push(h)},t}(y.default);t.default=A}));