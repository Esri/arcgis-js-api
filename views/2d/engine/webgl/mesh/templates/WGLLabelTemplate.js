// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../../../../core/tsSupport/extendsHelper","../../../../../../core/Error","../../../../../../core/Logger","../../../../../../core/mathUtils","../../../../../../core/mathUtils","../../../../../../core/libs/gl-matrix-2/mat2d","../../../../../../core/libs/gl-matrix-2/mat2df32","../../../../../../core/libs/gl-matrix-2/vec2","../../../../../../core/libs/gl-matrix-2/vec2f32","../../../vectorTiles/GeometryUtils","../../color","../../definitions","../../enums","../../number","../../TextShaping","../../collisions/Metric","../../materialKey/MaterialKey","./GlyphGroup","./util","./WGLTextTemplate"],function(e,t,r,o,a,x,M,m,i,_,s,d,b,A,T,P,n,I,E,pe,w,h){Object.defineProperty(t,"__esModule",{value:!0});var l=a.getLogger("esri.views.2d.engine.webgl.WGLLabelTemplate"),v=s.vec2f32.create(),g=i.mat2df32.create();var L={xOffset:0,yOffset:0,width:0,height:0},S=function(e,t){return void 0===t&&(t="mapview-labeling"),l.error(new o(t,e))};t.isMapAligned=function(e){switch(e){case"above-along":case"below-along":case"center-along":return 1;default:return 0}};var u=function(y){function o(e,t,r,o){var a=y.call(this,e,r.font.size,r.haloSize||0,r.font.size,r.color&&b.premultiplyAlphaRGBA(r.color)||0,r.haloColor&&b.premultiplyAlphaRGBA(r.haloColor)||0,r.horizontalAlignment,r.verticalAlignment,r.font.decoration,!1,r.angle||0,r.xoffset,r.yoffset,r.id)||this;a._refTemplate=L,a.geometryType=T.WGLGeometryType.LABEL;var i,s,n,h,l,u,p=t.symbol,f=(s=o,n=!!(i=t).minScale&&s.scaleToZoom(i.minScale)||0,x.clamp(n,0,25.5)),c=(l=o,u=!!(h=t).maxScale&&l.scaleToZoom(h.maxScale)||255,x.clamp(u,0,25.5)),m=function(e){switch(e){case"above-left":return[-1,-1];case"above-center":case"above-along":return[0,-1];case"above-right":return[1,-1];case"center-left":return[-1,0];case"center-center":case"center-along":return[0,0];case"center-right":return[1,0];case"below-left":return[-1,1];case"below-center":case"below-along":return[0,1];case"below-right":return[1,1];case"always-horizontal":return[0,0];default:return void S("Found invalid placement type "+e)}}(t.labelPlacement),_=m[0],d=m[1];a._justify=(-1*_+1)/2,a._xAlignD=_,a._yAlignD=d,a._xPlacementD=_,a._yPlacementD=d,a._minZoom=f,a._maxZoom=c;var v=E.LabelMaterialKey.load(E.createMaterialKey(a.geometryType,e,!1,t));v.sdf=!0,a._materialKey=v.data;var g=p.font.decoration.toLowerCase();return"underline"===g?a._decorationTop=6:"line-through"===g&&(a._decorationTop=-5),a}return r(o,y),o.fromLabelClass=function(e,t,r){return new o(e,t,t.symbol,r)},o.prototype.bindTextInfo=function(e,t,r){var o=this._computeShaping(e,this._justify).getShaping(t,r);isNaN(this._decorationTop)||n.TextShaping.addDecoration(o,this._decorationTop),this._shapedGlyphs=o,this._shapedBox=n.TextShaping.getBox(o)},o.prototype._computeShaping=function(e,t){return new n.TextShaping([e],A.TEXT_MAX_WIDTH,A.TEXT_LINE_HEIGHT,A.TEXT_SPACING,[0,0],.5,.5,t)},Object.defineProperty(o.prototype,"bounds",{get:function(){return this._bounds},enumerable:!0,configurable:!0}),o.prototype.bindReferenceTemplate=function(e){this._refTemplate=e||L},o.prototype._placeGlyphs=function(e,t,r,o){var a=this._size,i=this._haloSize,s=this._shapedBox,n=this._shapedGlyphs,h=this._computeGlyphTransform(s);if("esriGeometryPolyline"===e)for(var l=0;l<r.length;l++){T=r[l];for(var u=this._shapedBox.width*this._scale,p=function(e){return!(e%2)},f=T.order,c=f-(f-1)/2-1,m=c-(c-1)/2-1,_=m-(m-1)/2-1,d=-1===f?0:p(f)?o-.1:p(c)?o-1.1:p(m)?o-2.1:p(_)?o-3.1:0,v=Math.max(o+M.log2((u+48)/T.pathLen),Math.max(d,this._minZoom)),g=0,y=n;g<y.length;g++){S=y[g];T.place(S,e,t,h,this._materialKey,a,i,s,o,v,this._maxZoom)}}else for(var x=0,b=r;x<b.length;x++)for(var T=b[x],L=0,w=n;L<w.length;L++){var S=w[L];T.place(S,e,t,h,this._materialKey,a,i,s,o,this._minZoom,this._maxZoom)}},o.prototype.writeMesh=function(u,p,e,f,t,r,o){var c=this,a=this._computeAnchors(e,t),m=P.i8888to32(0,0,0,this._bitset);if(a.length&&this._shapedGlyphs.length){this._placeGlyphs(e,t,a,r);var _=E.LabelMaterialKey.load(this._materialKey);if("esriGeometryPolyline"!==e){var i=a[0],s=this._shapedBox,n=this._computeGlyphTransform(s),h=this._createBounds(this._shapedBox,n),l=i.glyphs.get(0),d=l[0],v=d.anchorX,g=d.anchorY,y=Math.floor(10*d.minZoom),x=Math.floor(10*d.maxZoom),b=u.length;l.forEach(function(e){e.minZoom=25.5,e.maxZoom=25.5});var T={from:b,count:u.length-b},L=new I.default(f,T,v,g,y),w=Math.floor(v/A.COLLISION_BUCKET_SIZE),S=Math.floor(g/A.COLLISION_BUCKET_SIZE);if(w>=A.COLLISION_TILE_BOX_SIZE||S>=A.COLLISION_TILE_BOX_SIZE||w<0||S<0)return;this._writeVertices(u,p,f,l,_,m,y,x);var M=Math.max(this._refTemplate.height,this._refTemplate.width);return _.vvSizeFieldStops||_.vvSizeMinMaxValue||_.vvSizeScaleStops||_.vvSizeUnitValue?L.setVV(M,this._xPlacementD,this._yPlacementD):(L.offsetX=(M/2+A.COLLISION_PLACEMENT_PADDING)*this._xPlacementD,L.offsetY=(M/2+A.COLLISION_PLACEMENT_PADDING)*this._yPlacementD),L.bounds=h,o.push(L),void i.clear()}for(var O=function(e){var s=a[e],n=s.x,h=s.y,t=u.length,l=new I.default(f,{from:t,count:-1},n,h,25.5);s.glyphs.forEach(function(e){for(var t=0,r=e;t<r.length;t++){var o=r[t];if(o.minZoom=Math.max(s.minZoom,o.minZoom),o.bounds){var a=o.anchorX-n,i=o.anchorY-h;o.bounds.center[0]+=a,o.bounds.center[1]+=i,l.add(o.bounds)}}l.bounds&&c._writeHalos(u,p,f,e,_,m)}),s.glyphs.forEach(function(e){l.bounds&&c._writeText(u,p,f,e,_,m)}),l.range.count=u.length-t,l.bounds&&o.push(l),s.clear()},G=0;G<a.length;G++)O(G);this._computedGlyphs=[]}},o.prototype._outsideTile=function(e,t){return e<0||512<=e||t<0||512<=t},o.prototype._smoothVertices=function(e,t){if(!(t<=0)){var r=e.length;if(!(r<3)){var o=[],a=0;o.push(0);for(var i=1;i<r;i++)a+=w.dist(e[i],e[i-1]),o.push(a);t=Math.min(t,.2*a);var s=[];s.push(e[0][0]),s.push(e[0][1]);var n=e[r-1][0],h=e[r-1][1],l=w.sub([0,0],e[0],e[1]);w.normalize(l),e[0][0]+=t*l[0],e[0][1]+=t*l[1],w.sub(l,e[r-1],e[r-2]),w.normalize(l),e[r-1][0]+=t*l[0],e[r-1][1]+=t*l[1];for(i=1;i<r;i++)o[i]+=t;o[r-1]+=t;var u=.5*t;for(i=1;i<r-1;i++){for(var p=0,f=0,c=0,m=i-1;0<=m&&!(o[m+1]<o[i]-u);m--){var _=u+o[m+1]-o[i],d=o[m+1]-o[m],v=o[i]-o[m]<u?1:_/d;if(Math.abs(v)<1e-6)break;var g=v*_-.5*(L=v*v)*d,y=v*d/t,x=e[m+1],b=e[m][0]-x[0],T=e[m][1]-x[1];p+=y/g*(x[0]*v*_+.5*L*(_*b-d*x[0])-L*v*d*b/3),f+=y/g*(x[1]*v*_+.5*L*(_*T-d*x[1])-L*v*d*T/3),c+=y}for(m=i+1;m<r&&!(o[m-1]>o[i]+u);m++){_=u-o[m-1]+o[i],d=o[m]-o[m-1],v=o[m]-o[i]<u?1:_/d;if(Math.abs(v)<1e-6)break;var L;g=v*_-.5*(L=v*v)*d,y=v*d/t,x=e[m-1],b=e[m][0]-x[0],T=e[m][1]-x[1];p+=y/g*(x[0]*v*_+.5*L*(_*b-d*x[0])-L*v*d*b/3),f+=y/g*(x[1]*v*_+.5*L*(_*T-d*x[1])-L*v*d*T/3),c+=y}s.push(p/c),s.push(f/c)}s.push(n),s.push(h);for(i=0,m=0;i<r;i++)e[i][0]=s[m++],e[i][1]=s[m++]}}},o.prototype._computeLineAnchors=function(e,t,r){for(var o=t.paths,a=this._scale*this._shapedBox.width,i=a/2+r,s=a/2+16,n=this._shapedBox.width*this._scale,h=0;h<o.length;h++){var l=o[h],u=[];u.push(l[0]);for(var p=1;p<l.length;p++){var f=u[p-1],c=f[0],m=f[1];c+=l[p][0],m+=l[p][1],u.push([c,m])}this._smoothVertices(u,n);var _=[];_.push(u[0]);for(var d=1;d<u.length;d++){var v=u[d-1],g=v[0],y=v[1],x=u[d],b=x[0],T=x[1],L=Math.round(b-g),w=Math.round(T-y);_.push([L,w])}l=o[h]=_;var S=this._getPathLength(l);if(!(S<2*s))for(var M=S/2,O=0,G=l[0][0],A=l[0][1],P=1;P<l.length;P++){L=l[P][0],w=l[P][1];var I=Math.sqrt(L*L+w*w);if(0<=(O+=I)-M){var E=O-M,D=I-E,Z=D/I,z=G+L*Z,C=A+w*Z;if(!this._outsideTile(z,C)){var B=new pe.default(z,C,Z,h,P,G,A,I,S,-1);e.push(B)}var N=-1,K=0;for(K=D-i;0<=K;K-=i){var U=K/I,X=G+L*U,R=A+w*U;if(N++,!this._outsideTile(X,R)){B=new pe.default(X,R,U,h,P,G,A,I,S,N);e.push(B)}}O=K+i;for(var V=I-E,F=G,q=A,H=P-1;0!==H;H--){var j=l[H][0],W=l[H][1],k=Math.sqrt(j*j+W*W);if(i<=O+k){for(var Y=i-O;Y<k;Y+=i){var J=Y/k,Q=F-j*J,$=q-W*J;if(N++,Y+V+s<M&&!this._outsideTile(Q,$)){B=new pe.default(Q,$,1-J,h,H,F-j,q-W,k,S,N);e.push(B)}}O=k-(Y-i)}else O+=k;V+=k,F-=j,q-=W}var ee=-1;for(K=D+i;K<=I;K+=i){var te=K/I,re=G+L*te,oe=A+w*te;if(ee++,!this._outsideTile(re,oe)){B=new pe.default(re,oe,te,h,P,G,A,I,S,ee);e.push(B)}}F=G+L,q=A+w,O=I-(K-i),V=E;for(H=P+1;H<l.length;H++){var ae=l[H][0],ie=l[H][1],se=Math.sqrt(ae*ae+ie*ie);if(i<=O+se){for(var ne=i-O;ne<se;ne+=i){var he=ne/se,le=F+ae*he,ue=q+ie*he;if(ee++,ne+V+s<M&&!this._outsideTile(le,ue)){B=new pe.default(le,ue,he,h,H,F,q,se,S,ee);e.push(B)}}O=se-(ne-i)}else O+=se;V+=se,F+=ae,q+=ie}break}G+=L,A+=w}}return e},o.prototype._computeAnchors=function(e,t){var r=[];switch(e){case"esriGeometryPoint":var o=t.geometry,a=o.x,i=o.y,s=new pe.default(a,i);return r.push(s),r;case"esriGeometryPolygon":if(t.centroid){var n=t.centroid;a=n.x,i=n.y,s=new pe.default(a,i);return r.push(s),r}return void S("Non-centroid polygon anchor placement not supported");case"esriGeometryPolyline":return this._computeLineAnchors(r,t.geometry,376);case"esriGeometryMultipoint":default:return S("Unable to handle geometryType: "+e),r}},o.prototype._getPathLength=function(e){for(var t=0,r=1;r<e.length;r++){var o=e[r][0],a=e[r][1];t+=Math.sqrt(o*o+a*a)}return t},o.prototype._computeGlyphTransform=function(e){var t=this._scale,r=this._angle*d.C_DEG_TO_RAD,o=e.x,a=e.y,i=e.width/2,s=e.height/2,n=o+i,h=a+s,l=this._xAlignD*(i*t),u=this._yAlignD*(s*t),p=l+(this._xOffset+this._refTemplate.xOffset)+n,f=u-(this._yOffset+this._refTemplate.yOffset)-h,c=m.mat2d.identity(g);return m.mat2d.translate(c,c,_.vec2.set(v,p,f)),m.mat2d.scale(c,c,_.vec2.set(v,t,t)),m.mat2d.rotate(c,c,r),c},o.prototype._writeVertex=function(e,t,r,o,a,i,s,n,h){var l=t.get("geometry"),u=Math.min(Math.floor(Math.max(this._refTemplate.width,this._refTemplate.height)),255),p=this._xPlacementD+1,f=this._yPlacementD+1,c=P.i8888to32(n,h,0,0);this._refSymbolAndPlacementOffset=P.i8888to32(i.angle,u,p,f),l.push(o),l.push(r),l.push(a),l.push(i.vertexOffsetUpperLeft),l.push(i.texFontSizeUpperLeft),l.push(this._refSymbolAndPlacementOffset),l.push(c),l.push(o),l.push(r),l.push(a),l.push(i.vertexOffsetUpperRight),l.push(i.texFontSizeUpperRight),l.push(this._refSymbolAndPlacementOffset),l.push(c),l.push(o),l.push(r),l.push(a),l.push(i.vertexOffsetLowerLeft),l.push(i.texFontSizeLowerLeft),l.push(this._refSymbolAndPlacementOffset),l.push(c),l.push(o),l.push(r),l.push(a),l.push(i.vertexOffsetLowerRight),l.push(i.texFontSizeLowerRight),l.push(this._refSymbolAndPlacementOffset),l.push(c),e.vertexCount+=4},o}(h.default);t.default=u});