/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/maybe","../../../../../../core/Logger","../../../../../../core/Error","../../../../../../core/mathUtils","../../../../../../core/screenUtils","../../definitions","../../alignmentUtils","../../number","../../enums","./meshUtils","../../materialKey/MaterialKey","../../color","./segmentUtils","./WGLTextTemplate"],(function(e,t,i,n,o,r,s,a,l,h,c,m,f,u,_){"use strict";const g=i.getLogger("esri.views.2d.engine.webgl.WGLLabelTemplate"),p=(e,t="mapview-labeling")=>g.error(new n(t,e)),d=1,y=128,x=0,b=16,L=4;function v(e,t){const i=!!e.minScale&&t.scaleToZoom(e.minScale)||0;return o.clamp(i,0,25.5)}function S(e,t){const i=!!e.maxScale&&t.scaleToZoom(e.maxScale)||255;return o.clamp(i,0,25.5)}function P(e){const t=new Map;return i=>(t.has(i)||t.set(i,e(i)),t.get(i))}const w=P((e=>{let t=0;if(0===e)return 1/0;for(;!(e%2);)t++,e/=2;return t})),M=e=>Math.floor(127*e+127),A=e=>Math.floor(10*e),Z=e=>Math.round(e*(254/360));return function(i){function n(e,t,n,o){var l;(l=i.call(this,e,n.font.size,n.haloSize||0,n.color&&f.premultiplyAlphaRGBAArray(n.color)||0,n.haloColor&&f.premultiplyAlphaRGBAArray(n.haloColor)||0,n.horizontalAlignment,n.verticalAlignment,c.isMapAligned(t.labelPlacement)?1:0,n.font.decoration,!1,n.angle||0,n.xoffset,n.yoffset,n.lineWidth,n.lineHeight,null,null)||this)._outLineLabelAngle=0,l._refPlacementPadding=0,l._refPlacementDirX=0,l._refPlacementDirY=0,l._refOffsetX=0,l._refOffsetY=0,l._zoomLevel=0,l.geometryType=h.WGLGeometryType.LABEL;const u=v(t,o),_=S(t,o),g=t.labelPlacement,[p,d]=a.getAlignmentFromPlacement(g);l._xAlignD=p,l._yAlignD=d,l._minZoom=u,l._maxZoom=_,l._refPlacementPadding=r.pt2px(n.haloSize)+s.TEXT_PLACEMENT_PADDING;const y=m.LabelMaterialKey.load(e);return y.sdf=!0,l._materialKey=y.data,l}e._inheritsLoose(n,i),n.fromLabelClass=function(e,t){if("center-along"===e.labelPlacement){const t=e.symbol;t.xoffset=0,t.yoffset=0,t.angle=0,t.font.decoration="none"}return new n(e.materialKey,e,e.symbol,t)};var _=n.prototype;return _.setZoomLevel=function(e){this._zoomLevel=e},_.bindReferenceTemplate=function(e){let i=a.getXDirection(this._xAlignD),n=a.getYDirection(this._yAlignD);if(this._refOffsetX=0,this._refOffsetY=0,t.isNone(e))return void(this._refSymbolAndPlacementOffset=l.i8888to32(0,0,M(i),M(n)));if("circle"===e.boundsType&&(i||n)){const e=Math.sqrt(i*i+n*n);i/=e,n/=e}const o=Math.max(e.height,e.width),r=this._refPlacementPadding*L;this._refSymbolAndPlacementOffset=l.i8888to32(r,o,M(i),M(n)),this._referenceSize=o,this._refPlacementDirX=i,this._refPlacementDirY=n,this._refOffsetX=e.xOffset,this._refOffsetY=e.yOffset},_._write=function(e,i){if(t.isNone(this._shapingInfo))return;const n=this._shapingInfo,o=i.getDisplayId(),r="esriGeometryPolygon"===i.geometryType?i.readLegacyCentroid():i.readLegacyGeometry();if(r)switch(this.current={out:e,inId:o,inShaping:n,zoomLevel:this._zoomLevel},i.geometryType){case"esriGeometryPolyline":this._placeLineLabels(r);break;case"esriGeometryPoint":case"esriGeometryPolygon":this._placePointLabels(r);break;default:p("mapview-labeling",`Geometry of type ${i.geometryType} is not supported`)}},_._isVisible=function(e,t){const i=A(this.current.zoomLevel);return A(e)<=i&&i<=A(t)},_._placePointLabels=function(e){const{out:t,inId:i,inShaping:n}=this.current;this._writeGlyphs(t,i,e,n)},_._placeLineLabels=function(e){const t=u.smoothPaths(e.paths,this.current.inShaping.bounds.width),i=this._placeSubdivGlyphs.bind(this),n=(this._shapedBox.width+y)/(1<<d);for(const o of t)u.pathDivide(o,n,i)},_._placeSubdivGlyphs=function(e,t,i,n){const r=w(t),s=this._shapedBox.width/(1<<d),a=b/(1<<d),l=Math.min(i,n-i),h=o.log2(l/(a+s/2)),c=0===t?h:Math.min(r,h),m=Math.max(this._minZoom,this.current.zoomLevel+d-c),f=this.current.zoomLevel-m,u=this._shapedBox.width/2*2**f;this.current.inShaping.isMultiline?0===t&&this._placeStraight(e,m):this._placeCurved(e,m,u)},_._placeStraight=function(e,t){const{out:i,inId:n,inShaping:o}=this.current;this._writeGlyphs(i,n,e,o,t)},_._placeCurved=function(e,t,i){const{out:n,inId:o}=this.current;n.metricStart(o,t,e.x,e.y,0,0,0,0);const r=e.clone(),s=e.angle*(180/Math.PI)%360,a=(e.angle*(180/Math.PI)+180)%360;this._outLineLabelAngle=Z(s),this._placeFirst(r,t,1),this._placeBack(e,r,t,i,1),this._placeForward(e,r,t,i,1),this._outLineLabelAngle=Z(a),this._placeFirst(r,t,0),this._placeBack(e,r,t,i,0),this._placeForward(e,r,t,i,0),n.metricEnd()},_._placeBack=function(e,t,i,n,o){const r=e.clone();let s=e.backwardLength+x;for(;r.prev()&&!(s>=n);)this._placeOnSegment(r,t,s,i,-1,o),s+=r.length+x},_._placeForward=function(e,t,i,n,o){const r=e.clone();let s=e.remainingLength+x;for(;r.next()&&!(s>=n);)this._placeOnSegment(r,t,s,i,1,o),s+=r.length+x},_._placeFirst=function(e,t,i){const n=e,r=this.current.inShaping,s=r.glyphs,a=this.current.zoomLevel,{out:l,inId:h}=this.current;for(const c of s){const s=c.x>r.bounds.x?i:1-i,m=s*e.remainingLength+(1-s)*e.backwardLength,f=Math.abs(c.x+c.width/2-r.bounds.x),u=Math.max(0,a+o.log2(f/(m+x))),_=Math.max(t,u);if(c.maxZoom=25,c.angle=e.angle+(1-i)*Math.PI,c.minZoom=_,!(n.x<0||n.x>=512||n.y<0||n.y>=512)&&(this._writeGlyph(l,h,n.x,n.y,c),i&&this._isVisible(c.minZoom,c.maxZoom))){const e=c.bounds;l.metricBoxWrite(e.center[0],e.center[1],e.width,e.height)}}},_._placeOnSegment=function(e,t,i,n,r,s){const a=this.current.inShaping.glyphs,{out:l,inId:h}=this.current,c=this.current.inShaping,m=this.current.zoomLevel,f=e.dx/e.length,u=e.dy/e.length,_={x:e.x+i*-r*f,y:e.y+i*-r*u};for(const g of a){const a=g.x>c.bounds.x?s:1-s;if(!(a&&1===r||!a&&-1===r))continue;const f=Math.abs(g.x+g.width/2-c.bounds.x),u=Math.max(0,m+o.log2(f/i)-.1),p=Math.max(n,m+o.log2(f/(i+e.length+x)));if(0!==u&&(g.angle=e.angle+(1-s)*Math.PI,g.minZoom=p,g.maxZoom=u,!(_.x<0||_.x>=512||_.y<0||_.y>=512)&&(this._writeGlyph(l,h,_.x,_.y,g),s&&this._isVisible(g.minZoom,g.maxZoom)))){const i=g.bounds,n=e.x-t.x,o=e.y-t.y;l.metricBoxWrite(i.center[0]+n,i.center[1]+o,i.width,i.height)}}},_._writeGlyphs=function(e,t,i,n,o=this._minZoom){if(i.x<0||i.x>=512||i.y<0||i.y>=512)return;const r=i.x+this._refOffsetX,s=i.y-this._refOffsetY;for(const m of n.glyphs)m.minZoom=o,m.maxZoom=this._maxZoom,this._writeGlyph(e,t,r,s,m);const a=m.LabelMaterialKey.load(this._materialKey),l=this._refPlacementDirX,h=this._refPlacementDirY,c=a.vvSizeFieldStops||a.vvSizeMinMaxValue||a.vvSizeScaleStops||a.vvSizeUnitValue,f=n.boundsT;e.metricStart(t,o,r,s,l,h,this._referenceSize,c?1:0),e.metricBoxWrite(f.center[0],f.center[1],f.width,f.height),e.metricEnd()},_._writeVertexCommon=function(e,t,i,n){const o=this._color,r=this._haloColor,s=l.i8888to32(0,0,this._size,this._haloSize),a=Math.max(n.minZoom,this._minZoom),h=Math.min(n.maxZoom,this._maxZoom),c=l.i8888to32(A(a),A(h),this._outLineLabelAngle,0);e.vertexWrite(i),e.vertexWrite(t),e.vertexWrite(o),e.vertexWrite(r),e.vertexWrite(s),e.vertexWrite(this._refSymbolAndPlacementOffset),e.vertexWrite(c)},e._createClass(n,[{key:"_shapedBox",get:function(){return t.unwrap(this._shapingInfo).bounds}}]),n}(_)}));
