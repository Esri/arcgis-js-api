/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/Error","../../../../../../core/Logger","../../../../../../core/mathUtils","../../../../../../core/maybe","../../../../../../core/screenUtils","../../alignmentUtils","../../color","../../definitions","../../enums","../../number","../../materialKey/MaterialKey","./meshUtils","./segmentUtils","./WGLTextTemplate"],(function(e,t,i,n,o,r,s,a,l,h,c,m,f,u,_){"use strict";const g=i.getLogger("esri.views.2d.engine.webgl.WGLLabelTemplate"),p=(e,i="mapview-labeling")=>g.error(new t(i,e)),d=1,y=128,x=0,b=16,L=4;function P(e,t){const i=!!e.minScale&&t.scaleToZoom(e.minScale)||0;return n.clamp(i,0,25.5)}function w(e,t){const i=!!e.maxScale&&t.scaleToZoom(e.maxScale)||255;return n.clamp(i,0,25.5)}function v(e){const t=new Map;return i=>(t.has(i)||t.set(i,e(i)),t.get(i))}const S=v((e=>{let t=0;if(0===e)return 1/0;for(;!(e%2);)t++,e/=2;return t})),M=e=>Math.floor(127*e+127),A=e=>Math.floor(10*e),Z=e=>Math.round(e*(254/360));return function(t){function i(e,i,n,o){var c;(c=t.call(this,e,n.font.size,n.haloSize||0,n.color&&a.premultiplyAlphaRGBAArray(n.color)||0,n.haloColor&&a.premultiplyAlphaRGBAArray(n.haloColor)||0,n.horizontalAlignment,n.verticalAlignment,f.isMapAligned(i.labelPlacement)?1:0,n.font.decoration,!1,n.angle||0,n.xoffset,n.yoffset,n.lineWidth,n.lineHeight,null,null,null,null,null)||this)._outLineLabelAngle=0,c._refPlacementPadding=0,c._refPlacementDirX=0,c._refPlacementDirY=0,c._refOffsetX=0,c._refOffsetY=0,c._zoomLevel=0,c.geometryType=h.WGLGeometryType.LABEL;const u=P(i,o),_=w(i,o),g=i.labelPlacement,[p,d]=s.getAlignmentFromPlacement(g);c._xAlignD=p,c._yAlignD=d,c._minZoom=u,c._maxZoom=_,c._refPlacementPadding=r.pt2px(n.haloSize)+l.TEXT_PLACEMENT_PADDING;const y=m.LabelMaterialKey.load(e);return y.sdf=!0,c._materialKey=y.data,c}e._inheritsLoose(i,t),i.fromLabelClass=function(e,t){if("esriServerLinePlacementCenterAlong"===e.labelPlacement){const t=e.symbol;t.xoffset=0,t.yoffset=0,t.angle=0,t.font.decoration="none"}return new i(e.materialKey,e,e.symbol,t)};var _=i.prototype;return _.setZoomLevel=function(e){this._zoomLevel=e},_.bindReferenceTemplate=function(e){let t=s.getXDirection(this._xAlignD),i=s.getYDirection(this._yAlignD);if(this._refOffsetX=0,this._refOffsetY=0,o.isNone(e))return void(this._refSymbolAndPlacementOffset=c.i8888to32(0,0,M(t),M(i)));if("circle"===e.boundsType&&(t||i)){const e=Math.sqrt(t*t+i*i);t/=e,i/=e}const n=Math.max(e.height,e.width),r=this._refPlacementPadding*L;this._refSymbolAndPlacementOffset=c.i8888to32(r,n,M(t),M(i)),this._referenceSize=n,this._refPlacementDirX=t,this._refPlacementDirY=i,this._refOffsetX=e.xOffset,this._refOffsetY=e.yOffset},_._write=function(e,t){if(o.isNone(this._shapingInfo))return;const i=this._shapingInfo,n=t.getDisplayId(),r="esriGeometryPolygon"===t.geometryType?t.readLegacyCentroid():t.readLegacyGeometry();if(r)switch(this.current={out:e,inId:n,inShaping:i,zoomLevel:this._zoomLevel},t.geometryType){case"esriGeometryPolyline":this._placeLineLabels(r);break;case"esriGeometryPoint":case"esriGeometryPolygon":this._placePointLabels(r);break;default:p("mapview-labeling",`Geometry of type ${t.geometryType} is not supported`)}},_._isVisible=function(e,t){const i=A(this.current.zoomLevel);return A(e)<=i&&i<=A(t)},_._placePointLabels=function(e){const{out:t,inId:i,inShaping:n}=this.current;this._writeGlyphs(t,i,e,n)},_._placeLineLabels=function(e){const t=u.smoothPaths(e.paths,this.current.inShaping.bounds.width),i=this._placeSubdivGlyphs.bind(this),n=(this._shapedBox.width+y)/(1<<d);for(const o of t)u.pathDivide(o,n,i)},_._placeSubdivGlyphs=function(e,t,i,o){const r=S(t),s=this._shapedBox.width/(1<<d),a=b/(1<<d),l=Math.min(i,o-i),h=n.log2(l/(a+s/2)),c=0===t?h:Math.min(r,h),m=Math.max(this._minZoom,this.current.zoomLevel+d-c),f=this.current.zoomLevel-m,u=this._shapedBox.width/2*2**f;this.current.inShaping.isMultiline?0===t&&this._placeStraight(e,m):this._placeCurved(e,m,u)},_._placeStraight=function(e,t){const{out:i,inId:n,inShaping:o}=this.current;this._writeGlyphs(i,n,e,o,t)},_._placeCurved=function(e,t,i){const{out:n,inId:o}=this.current;n.metricStart(o,t,e.x,e.y,0,0,0,0);const r=e.clone(),s=e.angle*(180/Math.PI)%360,a=(e.angle*(180/Math.PI)+180)%360;this._outLineLabelAngle=Z(s),this._placeFirst(r,t,1),this._placeBack(e,r,t,i,1),this._placeForward(e,r,t,i,1),this._outLineLabelAngle=Z(a),this._placeFirst(r,t,0),this._placeBack(e,r,t,i,0),this._placeForward(e,r,t,i,0),n.metricEnd()},_._placeBack=function(e,t,i,n,o){const r=e.clone();let s=e.backwardLength+x;for(;r.prev()&&!(s>=n);)this._placeOnSegment(r,t,s,i,-1,o),s+=r.length+x},_._placeForward=function(e,t,i,n,o){const r=e.clone();let s=e.remainingLength+x;for(;r.next()&&!(s>=n);)this._placeOnSegment(r,t,s,i,1,o),s+=r.length+x},_._placeFirst=function(e,t,i){const o=e,r=this.current.inShaping,s=r.glyphs,a=this.current.zoomLevel,{out:l,inId:h}=this.current;for(const c of s){const s=c.x>r.bounds.x?i:1-i,m=s*e.remainingLength+(1-s)*e.backwardLength,f=Math.abs(c.x+c.width/2-r.bounds.x),u=Math.max(0,a+n.log2(f/(m+x))),_=Math.max(t,u);if(c.maxZoom=25,c.angle=e.angle+(1-i)*Math.PI,c.minZoom=_,!(o.x<0||o.x>=512||o.y<0||o.y>=512)&&(this._writeGlyph(l,h,o.x,o.y,c),i&&this._isVisible(c.minZoom,c.maxZoom))){const e=c.bounds;l.metricBoxWrite(e.center[0],e.center[1],e.width,e.height)}}},_._placeOnSegment=function(e,t,i,o,r,s){const a=this.current.inShaping.glyphs,{out:l,inId:h}=this.current,c=this.current.inShaping,m=this.current.zoomLevel,f=e.dx/e.length,u=e.dy/e.length,_={x:e.x+i*-r*f,y:e.y+i*-r*u};for(const g of a){const a=g.x>c.bounds.x?s:1-s;if(!(a&&1===r||!a&&-1===r))continue;const f=Math.abs(g.x+g.width/2-c.bounds.x),u=Math.max(0,m+n.log2(f/i)-.1),p=Math.max(o,m+n.log2(f/(i+e.length+x)));if(0!==u&&(g.angle=e.angle+(1-s)*Math.PI,g.minZoom=p,g.maxZoom=u,!(_.x<0||_.x>=512||_.y<0||_.y>=512)&&(this._writeGlyph(l,h,_.x,_.y,g),s&&this._isVisible(g.minZoom,g.maxZoom)))){const i=g.bounds,n=e.x-t.x,o=e.y-t.y;l.metricBoxWrite(i.center[0]+n,i.center[1]+o,i.width,i.height)}}},_._writeGlyphs=function(e,t,i,n,o=this._minZoom){if(i.x<0||i.x>=512||i.y<0||i.y>=512)return;const r=i.x+this._refOffsetX,s=i.y-this._refOffsetY;for(const c of n.glyphs)c.minZoom=o,c.maxZoom=this._maxZoom,this._writeGlyph(e,t,r,s,c);const a=this._refPlacementDirX,l=this._refPlacementDirY,h=n.boundsT;e.metricStart(t,o,r,s,a,l,this._referenceSize,this._materialKey),e.metricBoxWrite(h.center[0],h.center[1],h.width,h.height),e.metricEnd()},_._writeVertexCommon=function(e,t,i,n){const o=this._color,r=this._haloColor,s=c.i8888to32(0,0,this._size,this._haloSize),a=Math.max(n.minZoom,this._minZoom),l=Math.min(n.maxZoom,this._maxZoom),h=c.i8888to32(A(a),A(l),this._outLineLabelAngle,0);e.vertexWrite(i),e.vertexWrite(t),e.vertexWrite(o),e.vertexWrite(r),e.vertexWrite(s),e.vertexWrite(this._refSymbolAndPlacementOffset),e.vertexWrite(h)},e._createClass(i,[{key:"_shapedBox",get:function(){return o.unwrap(this._shapingInfo).bounds}}]),i}(_)}));
