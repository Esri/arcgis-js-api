/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/Error","../../../../../../core/Logger","../../../../../../core/mathUtils","../../../../../../core/maybe","../../../../../../core/screenUtils","../../alignmentUtils","../../color","../../definitions","../../enums","../../number","../../materialKey/MaterialKey","./meshUtils","./segmentUtils","./WGLTextTemplate"],(function(e,t,i,n,o,r,a,l,s,h,c,m,f,u,_){"use strict";const g=i.getLogger("esri.views.2d.engine.webgl.WGLLabelTemplate"),p=(e,i="mapview-labeling")=>g.error(new t(i,e)),d=1,y=0,b=4;function x(e,t){const i=!!e.minScale&&t.scaleToZoom(e.minScale)||0;return n.clamp(i,0,25.5)}function L(e,t){const i=!!e.maxScale&&t.scaleToZoom(e.maxScale)||255;return n.clamp(i,0,25.5)}function P(e){const t=new Map;return i=>(t.has(i)||t.set(i,e(i)),t.get(i))}const v=P((e=>{let t=0;if(0===e)return 1/0;for(;!(e%2);)t++,e/=2;return t})),w=e=>Math.floor(127*e+127),S=e=>Math.floor(10*e),M=e=>Math.round(e*(254/360));return function(t){function i(e,i,n,o){var c,u,_,g;(g=t.call(this,e,n.font.size,n.haloSize||0,n.font.size,n.color&&l.premultiplyAlphaRGBAArray(n.color)||0,n.haloColor&&l.premultiplyAlphaRGBAArray(n.haloColor)||0,n.horizontalAlignment,n.verticalAlignment,f.isMapAligned(i.labelPlacement)?1:0,n.font.decoration,!1,n.angle||0,n.xoffset,n.yoffset,n.lineWidth,n.lineHeight,null,null,null,null,null)||this)._outLineLabelAngle=0,g._refPlacementPadding=0,g._refPlacementDirX=0,g._refPlacementDirY=0,g._refOffsetX=0,g._refOffsetY=0,g._zoomLevel=0,g.geometryType=h.WGLGeometryType.LABEL,g._allowOverrun=null!=(c=i.allowOverrun)&&c,g._repeatLabel=null==(u=i.repeatLabel)||u,g._labelPosition=null!=(_=i.labelPosition)?_:"curved";const p=x(i,o),d=L(i,o),y=i.labelPlacement,[b,P]=a.getAlignmentFromPlacement(y);g._xAlignD=b,g._yAlignD=P,g._minZoom=p,g._maxZoom=d,g._refPlacementPadding=r.pt2px(n.haloSize)+s.TEXT_PLACEMENT_PADDING,g._repeatLabelDistance=i.repeatLabelDistance?r.pt2px(i.repeatLabelDistance):128;const v=m.LabelMaterialKey.load(e);return v.sdf=!0,g._materialKey=v.data,g}e._inheritsLoose(i,t),i.fromLabelClass=function(e,t){if("esriServerLinePlacementCenterAlong"===e.labelPlacement){const t=e.symbol;t.xoffset=0,t.yoffset=0,t.angle=0,t.font.decoration="none"}return new i(e.materialKey,e,e.symbol,t)};var n=i.prototype;return n.setZoomLevel=function(e){this._zoomLevel=e},n.bindReferenceTemplate=function(e){let t=a.getXDirection(this._xAlignD),i=a.getYDirection(this._yAlignD);if(this._refOffsetX=0,this._refOffsetY=0,o.isNone(e))return void(this._refSymbolAndPlacementOffset=c.i8888to32(0,0,w(t),w(i)));if("circle"===e.boundsType&&(t||i)){const e=Math.sqrt(t*t+i*i);t/=e,i/=e}const n=Math.max(e.height,e.width),r=this._refPlacementPadding*b;this._refSymbolAndPlacementOffset=c.i8888to32(r,n,w(t),w(i)),this._referenceSize=n,this._refPlacementDirX=t,this._refPlacementDirY=i,this._refOffsetX=e.xOffset,this._refOffsetY=e.yOffset},n._write=function(e,t){if(o.isNone(this._shapingInfo))return;const i=this._shapingInfo,n=t.getDisplayId(),r="esriGeometryPolygon"===t.geometryType?t.readLegacyCentroid():t.readLegacyGeometry();if(r)switch(this.current={out:e,inId:n,inShaping:i,zoomLevel:this._zoomLevel},t.geometryType){case"esriGeometryPolyline":this._placeLineLabels(r);break;case"esriGeometryPoint":case"esriGeometryPolygon":this._placePointLabels(r);break;default:p("mapview-labeling",`Geometry of type ${t.geometryType} is not supported`)}},n._isVisible=function(e,t){const i=S(this.current.zoomLevel);return S(e)<=i&&i<=S(t)},n._placePointLabels=function(e){const{out:t,inId:i,inShaping:n}=this.current;this._writeGlyphs(t,i,e,n)},n._placeLineLabels=function(e){const t=u.smoothPaths(e.paths,this.current.inShaping.bounds.width),i=this._placeSubdivGlyphs.bind(this),n=(this._shapedBox.width+this._repeatLabelDistance)/(1<<d);for(const o of t)u.pathDivide(o,n,i,this._repeatLabel)},n._placeSubdivGlyphs=function(e,t,i,n){const o=v(t),r=this._shapedBox.width/(1<<d),a=Math.sqrt(this._repeatLabelDistance)/(1<<d),l=Math.min(i,n-i),s=Math.log2(l/(a+r/2)),h=0===t?s:Math.min(o,s),c=Math.max(this._minZoom,this.current.zoomLevel+d-h),m=this.current.zoomLevel-c,f=this._shapedBox.width/2*2**m;this.current.inShaping.isMultiline?0===t&&this._placeStraight(e,c):this._allowOverrun&&m<0?this._placeStraightAlong(e,this._minZoom):"parallel"===this._labelPosition?this._placeStraightAlong(e,c):"curved"===this._labelPosition&&this._placeCurved(e,c,f)},n._placeStraight=function(e,t){const{out:i,inId:n,inShaping:o}=this.current;this._writeGlyphs(i,n,e,o,t)},n._placeCurved=function(e,t,i){const{out:n,inId:o}=this.current;n.metricStart(o,t,e.x,e.y,0,0,0,0);const r=e.clone(),a=e.angle*(180/Math.PI)%360,l=(e.angle*(180/Math.PI)+180)%360;this._outLineLabelAngle=M(a),this._placeFirst(r,t,1),this._placeBack(e,r,t,i,1),this._placeForward(e,r,t,i,1),this._outLineLabelAngle=M(l),this._placeFirst(r,t,0),this._placeBack(e,r,t,i,0),this._placeForward(e,r,t,i,0),n.metricEnd()},n._placeStraightAlong=function(e,t){const{out:i,inId:n}=this.current;i.metricStart(n,t,e.x,e.y,0,0,0,0);const o=e.clone(),r=e.angle*(180/Math.PI)%360,a=(e.angle*(180/Math.PI)+180)%360;this._outLineLabelAngle=M(r),this._placeFirst(o,t,1,!0),this._outLineLabelAngle=M(a),this._placeFirst(o,t,0,!0),i.metricEnd()},n._placeBack=function(e,t,i,n,o){const r=e.clone();let a=e.backwardLength+y;for(;r.prev()&&!(a>=n);)this._placeOnSegment(r,t,a,i,-1,o),a+=r.length+y},n._placeForward=function(e,t,i,n,o){const r=e.clone();let a=e.remainingLength+y;for(;r.next()&&!(a>=n);)this._placeOnSegment(r,t,a,i,1,o),a+=r.length+y},n._placeFirst=function(e,t,i,n=!1){const o=e,r=this.current.inShaping,a=r.glyphs,l=this.current.zoomLevel,{out:s,inId:h}=this.current;for(const c of a){const a=c.x>r.bounds.x?i:1-i,m=a*e.remainingLength+(1-a)*e.backwardLength,f=Math.abs(c.x+c.width/2-r.bounds.x),u=Math.max(0,l+Math.log2(f/(m+y))),_=Math.max(t,n?0:u);if(c.maxZoom=25,c.angle=e.angle+(1-i)*Math.PI,c.minZoom=_,this._writeGlyph(s,h,o.x,o.y,c),i&&this._isVisible(c.minZoom,c.maxZoom)){const e=c.bounds;s.metricBoxWrite(e.center[0],e.center[1],e.width,e.height)}}},n._placeOnSegment=function(e,t,i,n,o,r){const a=this.current.inShaping.glyphs,{out:l,inId:s}=this.current,h=this.current.inShaping,c=this.current.zoomLevel,m=e.dx/e.length,f=e.dy/e.length,u={x:e.x+i*-o*m,y:e.y+i*-o*f};for(const _ of a){const a=_.x>h.bounds.x?r:1-r;if(!(a&&1===o||!a&&-1===o))continue;const m=Math.abs(_.x+_.width/2-h.bounds.x),f=Math.max(0,c+Math.log2(m/i)-.1),g=Math.max(n,c+Math.log2(m/(i+e.length+y)));if(0!==f&&(_.angle=e.angle+(1-r)*Math.PI,_.minZoom=g,_.maxZoom=f,this._writeGlyph(l,s,u.x,u.y,_),r&&this._isVisible(_.minZoom,_.maxZoom))){const i=_.bounds,n=e.x-t.x,o=e.y-t.y;l.metricBoxWrite(i.center[0]+n,i.center[1]+o,i.width,i.height)}}},n._writeGlyphs=function(e,t,i,n,o=this._minZoom){if(i.x<0||i.x>=512||i.y<0||i.y>=512)return;const r=i.x+this._refOffsetX,a=i.y-this._refOffsetY;for(const c of n.glyphs)c.minZoom=o,c.maxZoom=this._maxZoom,this._writeGlyph(e,t,r,a,c);const l=this._refPlacementDirX,s=this._refPlacementDirY,h=n.boundsT;e.metricStart(t,o,r,a,l,s,this._referenceSize,this._materialKey),e.metricBoxWrite(h.center[0],h.center[1],h.width,h.height),e.metricEnd()},n._writeVertexCommon=function(e,t,i,n){const o=this._color,r=this._haloColor,a=c.i8888to32(0,0,this._size,this._haloSize),l=Math.max(n.minZoom,this._minZoom),s=Math.min(n.maxZoom,this._maxZoom),h=c.i8888to32(S(l),S(s),this._outLineLabelAngle,0);e.vertexWrite(i),e.vertexWrite(t),e.vertexWrite(o),e.vertexWrite(r),e.vertexWrite(a),e.vertexWrite(this._refSymbolAndPlacementOffset),e.vertexWrite(h)},e._createClass(i,[{key:"_shapedBox",get:function(){return o.unwrap(this._shapingInfo).bounds}}]),i}(_)}));
