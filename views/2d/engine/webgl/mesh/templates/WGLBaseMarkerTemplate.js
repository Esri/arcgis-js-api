/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/maybe","../../../../../../core/screenUtils","../../../../../../chunks/mat2d","../../../../../../chunks/mat2df32","../../../../../../chunks/vec2","../../../../../../chunks/vec2f32","../../../../../../layers/graphics/featureConversionUtils","../../../../../../symbols/cim/placements/CIMMarkerPlacementHelper","../../enums","../../number"],(function(t,e,i,r,s,o,n,h,f,a,x){"use strict";const _=3.14159265359/180,l=8;return c=>function(c){function m(...t){var e;return(e=c.call(this,...t)||this).angle=0,e.xOffset=0,e.yOffset=0,e.width=0,e.height=0,e.boundsType="square",e._anchorX=0,e._anchorY=0,e._computedWidth=0,e._computedHeight=0,e._vertexBoundsScaleX=1,e._vertexBoundsScaleY=1,e._offsets={xUpperLeft:0,yUpperLeft:0,xUpperRight:0,yUpperRight:0,xBottomLeft:0,yBottomLeft:0,xBottomRight:0,yBottomRight:0},e.geometryType=a.WGLGeometryType.MARKER,e}t._inheritsLoose(m,c);var d=m.prototype;return d._write=function(t,e,i){const r=e.getDisplayId();t.recordStart(r,this._materialKey,this.geometryType,!1,!0),this._writeGeometry(t,e,r,i),t.recordEnd()},d._writeGeometry=function(t,i,r,s){if(e.isSome(this._markerPlacement))return this._writePlacedMarkers(t,i,s);const o=s?h.deltaDecodeGeometry(h.convertFromGeometry(s),2):"esriGeometryPolygon"===i.geometryType?i.readCentroid():i.readGeometryForDisplay();if(!e.isNone(o)){if(o.isPoint){const[e,i]=o.coords;if(!t.hasAggregates&&t.hasPixelBufferEnabled&&(e<-1||e>=513||i<-1||i>=513))return;return this._writeVertices(t,r,this._getPos(e,i),e,i)}o.forEachVertex(((e,i)=>this._writeVertices(t,r,this._getPos(e,i),e,i)))}},d._writePlacedMarkers=function(t,r,o){const h=null!=o?o:r.readLegacyGeometryForDisplay(),a=f.CIMMarkerPlacementHelper.getPlacement(h,e.unwrap(this._markerPlacement),i.pt2px(1));if(!a)return;const x=r.getDisplayId(),l=n.create(),c=s.create(),m=-128,d=640;let p=a.next();for(;null!=p;){const{tx:e,ty:i}=p;e>=m&&e<=d&&i>=m&&i<=d&&(this._applyTransformation(c,l,p.getAngle()/_),this._writeVertices(t,x,this._getPos(e,i),e,i)),p=a.next()}},d._writeVertices=function(t,e,i,r,s){const o=t.vertexCount();t.vertexBounds(r+this.xOffset,s-this.yOffset,this._computedWidth*this._vertexBoundsScaleX,this._computedHeight*this._vertexBoundsScaleY),t.vertexWrite(i),t.vertexWrite(this._offsetUpperLeft),t.vertexWrite(this._texUpperLeft),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(e),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexWrite(this._minMaxZoom),t.vertexEnd(),t.vertexWrite(i),t.vertexWrite(this._offsetUpperRight),t.vertexWrite(this._texUpperRight),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(e),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexWrite(this._minMaxZoom),t.vertexEnd(),t.vertexWrite(i),t.vertexWrite(this._offsetBottomLeft),t.vertexWrite(this._texBottomLeft),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(e),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexWrite(this._minMaxZoom),t.vertexEnd(),t.vertexWrite(i),t.vertexWrite(this._offsetBottomRight),t.vertexWrite(this._texBottomRight),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(e),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexWrite(this._minMaxZoom),t.vertexEnd(),t.indexWrite(o+0),t.indexWrite(o+1),t.indexWrite(o+2),t.indexWrite(o+1),t.indexWrite(o+3),t.indexWrite(o+2)},d._applyTransformation=function(t,e,i=0){r.identity(t),r.translate(t,t,n.fromValues(this.xOffset,-this.yOffset)),this.angle+i!==0&&r.rotate(t,t,_*(this.angle+i));const s=this._computedWidth,h=this._computedHeight,f=(this._anchorX-.5)*s,a=(this._anchorY-.5)*h;o.set(e,f,a),o.transformMat2d(e,e,t),this._offsetUpperLeft=x.i1616to32(16*e[0],16*e[1]),this._offsets.xUpperLeft=e[0],this._offsets.yUpperLeft=e[1],o.set(e,f+s,a),o.transformMat2d(e,e,t),this._offsetUpperRight=x.i1616to32(16*e[0],16*e[1]),this._offsets.xUpperRight=e[0],this._offsets.yUpperRight=e[1],o.set(e,f,a+h),o.transformMat2d(e,e,t),this._offsetBottomLeft=x.i1616to32(16*e[0],16*e[1]),this._offsets.xBottomLeft=e[0],this._offsets.yBottomLeft=e[1],o.set(e,f+s,a+h),o.transformMat2d(e,e,t),this._offsetBottomRight=x.i1616to32(16*e[0],16*e[1]),this._offsets.xBottomRight=e[0],this._offsets.yBottomRight=e[1]},d._getPos=function(t,e){return x.i1616to32(Math.round(l*t),Math.round(l*e))},m}(c)}));
