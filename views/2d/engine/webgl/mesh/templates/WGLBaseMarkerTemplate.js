/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/maybe","../../../../../../core/screenUtils","../../../../../../layers/graphics/featureConversionUtils","../../../../../../chunks/vec2","../../../../../../chunks/mat2d","../../../../../../chunks/mat2df32","../../../../../../chunks/vec2f32","../../number","../../enums","../../../../../../symbols/cim/placements/CIMMarkerPlacementHelper"],(function(t,e,i,r,s,o,n,h,f,a,_){"use strict";const l=3.14159265359/180,x=8;return c=>function(c){function d(...t){var e;return(e=c.call(this,...t)||this).angle=0,e.xOffset=0,e.yOffset=0,e.width=0,e.height=0,e.boundsType="square",e._anchorX=0,e._anchorY=0,e._computedWidth=0,e._computedHeight=0,e._vertexBoundsScaleX=1,e._vertexBoundsScaleY=1,e._offsets={xUpperLeft:0,yUpperLeft:0,xUpperRight:0,yUpperRight:0,xBottomLeft:0,yBottomLeft:0,xBottomRight:0,yBottomRight:0},e.geometryType=a.WGLGeometryType.MARKER,e}t._inheritsLoose(d,c);var u=d.prototype;return u._write=function(t,e,i){const r=e.getDisplayId();t.recordStart(r,this._materialKey,this.geometryType,!1,!0),this._writeGeometry(t,e,r,i),t.recordEnd()},u._writeGeometry=function(t,i,s,o){if(e.isSome(this._markerPlacement))return this._writePlacedMarkers(t,i,o);const n=o?r.deltaDecodeGeometry(r.convertFromGeometry(o),2):"esriGeometryPolygon"===i.geometryType?i.readCentroid():i.readUnquantizedGeometry();if(n){if(n.isPoint){const[e,i]=n.coords;if(!t.hasAggregates&&t.hasPixelBufferEnabled&&(e<-1||e>=513||i<-1||i>=513))return;return this._writeVertices(t,s,this._getPos(e,i),e,i)}n.forEachVertex(((e,i)=>this._writeVertices(t,s,this._getPos(e,i),e,i)))}},u._writePlacedMarkers=function(t,r,s){const o=null!=s?s:r.readLegacyGeometry(),f=_.CIMMarkerPlacementHelper.getPlacement(o,e.unwrap(this._markerPlacement),i.pt2px(1));if(!f)return;const a=r.getDisplayId(),x=h.create(),c=n.create(),d=-128,u=640;let m=f.next();for(;null!=m;){const{tx:e,ty:i}=m;e>=d&&e<=u&&i>=d&&i<=u&&(this._applyTransformation(c,x,m.getAngle()/l),this._writeVertices(t,a,this._getPos(e,i),e,i)),m=f.next()}},u._writeVertices=function(t,e,i,r,s){const o=t.vertexCount();t.vertexBounds(r+this.xOffset,s-this.yOffset,this._computedWidth*this._vertexBoundsScaleX,this._computedHeight*this._vertexBoundsScaleY),t.vertexWrite(i),t.vertexWrite(this._offsetUpperLeft),t.vertexWrite(this._texUpperLeft),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(e),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexEnd(),t.vertexWrite(i),t.vertexWrite(this._offsetUpperRight),t.vertexWrite(this._texUpperRight),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(e),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexEnd(),t.vertexWrite(i),t.vertexWrite(this._offsetBottomLeft),t.vertexWrite(this._texBottomLeft),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(e),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexEnd(),t.vertexWrite(i),t.vertexWrite(this._offsetBottomRight),t.vertexWrite(this._texBottomRight),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(e),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexEnd(),t.indexWrite(o+0),t.indexWrite(o+1),t.indexWrite(o+2),t.indexWrite(o+1),t.indexWrite(o+3),t.indexWrite(o+2)},u._applyTransformation=function(t,e,i=0){o.identity(t),o.translate(t,t,h.fromValues(this.xOffset,-this.yOffset)),this.angle+i!==0&&o.rotate(t,t,l*(this.angle+i));const r=this._computedWidth,n=this._computedHeight,a=(this._anchorX-.5)*r,_=(this._anchorY-.5)*n;s.set(e,a,_),s.transformMat2d(e,e,t),this._offsetUpperLeft=f.i1616to32(16*e[0],16*e[1]),this._offsets.xUpperLeft=e[0],this._offsets.yUpperLeft=e[1],s.set(e,a+r,_),s.transformMat2d(e,e,t),this._offsetUpperRight=f.i1616to32(16*e[0],16*e[1]),this._offsets.xUpperRight=e[0],this._offsets.yUpperRight=e[1],s.set(e,a,_+n),s.transformMat2d(e,e,t),this._offsetBottomLeft=f.i1616to32(16*e[0],16*e[1]),this._offsets.xBottomLeft=e[0],this._offsets.yBottomLeft=e[1],s.set(e,a+r,_+n),s.transformMat2d(e,e,t),this._offsetBottomRight=f.i1616to32(16*e[0],16*e[1]),this._offsets.xBottomRight=e[0],this._offsets.yBottomRight=e[1]},u._getPos=function(t,e){return f.i1616to32(Math.round(x*t),Math.round(x*e))},d}(c)}));
