/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/maybe","../../../../../../core/screenUtils","../../../../../../chunks/mat2d","../../../../../../chunks/mat2df32","../../../../../../chunks/vec2","../../../../../../chunks/vec2f32","../../../../../../layers/graphics/featureConversionUtils","../../../../../../symbols/cim/placements/CIMMarkerPlacementHelper","../../definitions","../../enums","../../number","../../materialKey/MaterialKey"],(function(t,e,i,r,s,o,n,h,f,a,x,_,l){"use strict";const c=3.14159265359/180,m=8;return v=>function(v){function d(...t){var e;return(e=v.call(this,...t)||this).angle=0,e.xOffset=0,e.yOffset=0,e.width=0,e.height=0,e.boundsType="square",e._anchorX=0,e._anchorY=0,e._computedWidth=0,e._computedHeight=0,e._allowBorrowing=!0,e._vertexBoundsScaleX=1,e._vertexBoundsScaleY=1,e._offsets={xUpperLeft:0,yUpperLeft:0,xUpperRight:0,yUpperRight:0,xBottomLeft:0,yBottomLeft:0,xBottomRight:0,yBottomRight:0},e.geometryType=x.WGLGeometryType.MARKER,e}t._inheritsLoose(d,v);var p=d.prototype;return p._write=function(t,e,i,r){const s=e.getDisplayId();t.recordStart(s,this._materialKey,this.geometryType,!0),this._writeGeometry(t,e,s,i,r),t.recordEnd()},p._writeGeometry=function(t,i,r,s,o){if(e.isSome(this._markerPlacement))return this._writePlacedMarkers(t,i,s,o);if(this._allowBorrowing=!0,!o&&"esriGeometryPoint"===i.geometryType){const e=i.getX(),s=i.getY();if(!t.hasAggregates&&t.hasPixelBufferEnabled&&(e<0||e>=513||s<0||s>=513))return;return this._writeVertices(t,r,this._getPos(e,s),e,s)}const n=o?h.deltaDecodeGeometry(h.convertFromGeometry(o),2):"esriGeometryPolygon"===i.geometryType?i.readCentroid():i.readGeometryForDisplay();if(!e.isNone(n)){if(n.isPoint){const[e,i]=n.coords;if(!t.hasAggregates&&t.hasPixelBufferEnabled&&(e<0||e>=512||i<0||i>=512))return;return this._writeVertices(t,r,this._getPos(e,i),e,i)}n.forEachVertex(((e,i)=>{const s=2*a.TILE_SIZE;e<-s||e>=s||i<-s||i>=s||this._writeVertices(t,r,this._getPos(e,i),e,i)}))}},p._writePlacedMarkers=function(t,r,o,h){const a=h??r.readLegacyGeometryForDisplay(),x=f.CIMMarkerPlacementHelper.getPlacement(a,e.unwrap(this._markerPlacement),i.pt2px(1),t.tileKey,o.geometryEngine);if(!x)return;this._allowBorrowing="esriGeometryPolygon"!==r.geometryType;const _=r.getDisplayId(),l=n.create(),m=s.create(),v=-128,d=640;let p=x.next();for(;null!=p;){const e=p.tx,i=-p.ty;e>=v&&e<=d&&i>=v&&i<=d&&(this._applyTransformation(m,l,-p.getAngle()/c),this._writeVertices(t,_,this._getPos(e,i),e,i)),p=x.next()}},p._writeVertices=function(t,e,i,r,s){const o=l.MarkerMaterialKey.load(this._materialKey);return o.symbologyType===x.WGLSymbologyType.HEATMAP?this._writeHeatmapVertices(t,e,i):this._writeMarkerVertices(t,e,o,i,r,s)},p._writeMarkerVertices=function(t,e,i,r,s,o){const n=i.vvRotation,h=t.vertexCount();let f=this._computedWidth*this._vertexBoundsScaleX,a=this._computedHeight*this._vertexBoundsScaleY;if(this.angle){const t=Math.max(f,a);f=t,a=t}if(n){const t=Math.max(this.xOffset,this.yOffset);f+=t,a+=t}this._allowBorrowing&&t.vertexBounds(s+this.xOffset,o-this.yOffset,f,a),t.vertexWrite(r),t.vertexWrite(this._offsetUpperLeft),t.vertexWrite(this._texUpperLeft),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(e),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexWrite(this._minMaxZoom),t.vertexEnd(),t.vertexWrite(r),t.vertexWrite(this._offsetUpperRight),t.vertexWrite(this._texUpperRight),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(e),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexWrite(this._minMaxZoom),t.vertexEnd(),t.vertexWrite(r),t.vertexWrite(this._offsetBottomLeft),t.vertexWrite(this._texBottomLeft),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(e),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexWrite(this._minMaxZoom),t.vertexEnd(),t.vertexWrite(r),t.vertexWrite(this._offsetBottomRight),t.vertexWrite(this._texBottomRight),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(e),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexWrite(this._minMaxZoom),t.vertexEnd(),this._writeIndices(t,h)},p._writeHeatmapVertices=function(t,e,i){const r=t.vertexCount();t.vertexWrite(i),t.vertexWrite(this._offsetUpperLeft),t.vertexWrite(e),t.vertexEnd(),t.vertexWrite(i),t.vertexWrite(this._offsetUpperRight),t.vertexWrite(e),t.vertexEnd(),t.vertexWrite(i),t.vertexWrite(this._offsetBottomLeft),t.vertexWrite(e),t.vertexEnd(),t.vertexWrite(i),t.vertexWrite(this._offsetBottomRight),t.vertexWrite(e),t.vertexEnd(),this._writeIndices(t,r)},p._writeIndices=function(t,e){t.indexWrite(e+0),t.indexWrite(e+1),t.indexWrite(e+2),t.indexWrite(e+1),t.indexWrite(e+3),t.indexWrite(e+2)},p._applyTransformation=function(t,e,i=0){r.fromTranslation(t,n.fromValues(this.xOffset,-this.yOffset)),null!=this.angle&&this.angle+i!==0&&r.rotate(t,t,c*(this.angle+i));const s=this._computedWidth,h=this._computedHeight,f=-(.5+this._anchorX)*s,a=-(.5-this._anchorY)*h;o.set(e,f,a),o.transformMat2d(e,e,t),this._offsetUpperLeft=_.i1616to32(16*e[0],16*e[1]),this._offsets.xUpperLeft=e[0],this._offsets.yUpperLeft=e[1],o.set(e,f+s,a),o.transformMat2d(e,e,t),this._offsetUpperRight=_.i1616to32(16*e[0],16*e[1]),this._offsets.xUpperRight=e[0],this._offsets.yUpperRight=e[1],o.set(e,f,a+h),o.transformMat2d(e,e,t),this._offsetBottomLeft=_.i1616to32(16*e[0],16*e[1]),this._offsets.xBottomLeft=e[0],this._offsets.yBottomLeft=e[1],o.set(e,f+s,a+h),o.transformMat2d(e,e,t),this._offsetBottomRight=_.i1616to32(16*e[0],16*e[1]),this._offsets.xBottomRight=e[0],this._offsets.yBottomRight=e[1]},p._getPos=function(t,e){return _.i1616to32(Math.round(m*t),Math.round(m*e))},d}(v)}));
