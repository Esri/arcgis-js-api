/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/maybe","../../../../../../core/screenUtils","../../../../../../layers/graphics/featureConversionUtils","../../../../../../chunks/vec2","../../../../../../chunks/mat2d","../../../../../../chunks/mat2df32","../../../../../../chunks/vec2f32","../../number","../../enums","../../../../../../symbols/cim/placements/CIMMarkerPlacementHelper"],(function(t,e,s,i,o,r,h,n,u,p,a){"use strict";const c=3.14159265359/180;return l=>function(l){function f(...t){var e;return(e=l.call(this,...t)||this).angle=0,e.xOffset=0,e.yOffset=0,e.width=0,e.height=0,e.boundsType="square",e._anchorX=0,e._anchorY=0,e._computedWidth=0,e._computedHeight=0,e.geometryType=p.WGLGeometryType.MARKER,e}t._inheritsLoose(f,l);var _=f.prototype;return _.writeMeshWithGeometry=function(t,s,o,r,h,n){const u=s.indexVector,p=s.get("geometry"),a=s.getVector("geometry"),c=a.vertexCount,l=c,f=u.length;if(e.isSome(this._markerPlacement)){const t=null!=n?n:o.readLegacyGeometry();this._writePlacedMarkers(p,u,c,h,t)}else{const t=n?i.deltaDecodeGeometry(i.convertFromGeometry(n),2):"esriGeometryPolygon"===r?o.readCentroid():o.readUnquantizedGeometry();if(!t)return;if(t.isPoint){const[e,s]=t.coords;this._writeVertices(p,h,this._getPos(e,s)),this._writeIndices(u,c)}else t.forEachVertex(((t,e)=>{const s=a.vertexCount;this._writeVertices(p,h,this._getPos(t,e)),this._writeIndices(u,s)}))}const _=s.getVector("geometry").vertexCount-l,m=u.length-f;t.writeDisplayRecord(this.geometryType,this._materialKey,l,_,f,m)},_._applyTransformation=function(t,e,s=0){r.identity(t),r.translate(t,t,n.fromValues(this.xOffset,-this.yOffset)),this.angle+s!==0&&r.rotate(t,t,c*(this.angle+s));const i=this._computedWidth,h=this._computedHeight,p=(this._anchorX-.5)*i,a=(this._anchorY-.5)*h;o.set(e,p,a),o.transformMat2d(e,e,t),this._offsetUpperLeft=u.i1616to32(16*e[0],16*e[1]),o.set(e,p+i,a),o.transformMat2d(e,e,t),this._offsetUpperRight=u.i1616to32(16*e[0],16*e[1]),o.set(e,p,a+h),o.transformMat2d(e,e,t),this._offsetBottomLeft=u.i1616to32(16*e[0],16*e[1]),o.set(e,p+i,a+h),o.transformMat2d(e,e,t),this._offsetBottomRight=u.i1616to32(16*e[0],16*e[1])},_._writePlacedMarkers=function(t,i,o,r,u){const p=a.CIMMarkerPlacementHelper.getPlacement(u,e.unwrap(this._markerPlacement),s.pt2px(1));if(!p)return;const l=n.create(),f=h.create();let _=0,m=p.next();for(;null!=m;)m.tx>=-128&&m.tx<=640&&m.ty>=-128&&m.ty<=640&&(this._applyTransformation(f,l,m.getAngle()/c),this._writeVertices(t,r,this._getPos(m.tx,m.ty)),this._writeIndices(i,o+_),_+=4),m=p.next()},_._getPos=function(t,e){return u.i1616to32(Math.round(8*t),Math.round(8*e))},_._writeVertices=function(t,e,s){t.push(s),t.push(this._offsetUpperLeft),t.push(this._texUpperLeft),t.push(this._bitestAndDistRatio),t.push(e),t.push(this._fillColor),t.push(this._outlineColor),t.push(this._sizeOutlineWidth),t.push(s),t.push(this._offsetUpperRight),t.push(this._texUpperRight),t.push(this._bitestAndDistRatio),t.push(e),t.push(this._fillColor),t.push(this._outlineColor),t.push(this._sizeOutlineWidth),t.push(s),t.push(this._offsetBottomLeft),t.push(this._texBottomLeft),t.push(this._bitestAndDistRatio),t.push(e),t.push(this._fillColor),t.push(this._outlineColor),t.push(this._sizeOutlineWidth),t.push(s),t.push(this._offsetBottomRight),t.push(this._texBottomRight),t.push(this._bitestAndDistRatio),t.push(e),t.push(this._fillColor),t.push(this._outlineColor),t.push(this._sizeOutlineWidth)},_._writeIndices=function(t,e){const s=e;t.push(s+0),t.push(s+1),t.push(s+2),t.push(s+1),t.push(s+3),t.push(s+2)},f}(l)}));
