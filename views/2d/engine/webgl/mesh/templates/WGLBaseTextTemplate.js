/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/maybe","../../../../../../core/screenUtils","../../../../../../layers/graphics/featureConversionUtils","../../definitions","../../number","./shapingUtils","../../enums","../../materialKey/MaterialKey","../../../../../../symbols/cim/placements/CIMMarkerPlacementHelper"],(function(e,t,i,r,n,o,s,h,a,l){"use strict";const c=8;return x=>function(x){function d(...e){var t;return(t=x.call(this,...e)||this)._isCIM=!1,t._vertexBoundsScale=1,t.geometryType=h.WGLGeometryType.TEXT,t._aux=o.i8888to32(0,0,t._referenceSize,t._bitset),t}e._inheritsLoose(d,x);var _=d.prototype;return _.bindTextInfo=function(e,i){e&&e.length?this._shapingInfo=t.andThen(e,(e=>s.shapeGlyphs(e,i,{scale:this._scale,angle:this._angle,xOffset:this._xOffset,yOffset:this._yOffset,hAlign:this._xAlignD,vAlign:this._yAlignD,maxLineWidth:Math.max(32,Math.min(this._lineWidth,512)),lineHeight:n.MAGIC_LABEL_LINE_HEIGHT*Math.max(.25,Math.min(this._lineHeight,4)),decoration:this._decoration,isCIM:this._isCIM}))):this._shapingInfo=null},_._write=function(e,t,i){const r=t.getDisplayId();this._writeGeometry(e,t,r,i)},_._writeGeometry=function(e,i,n,o){const s=this._shapingInfo;if(t.isNone(s))return;if(t.isSome(this._textPlacement)){const t=null!=o?o:i.readLegacyGeometry();return this._writePlacedText(e,n,t,s)}const h=o?r.deltaDecodeGeometry(r.convertFromGeometry(o),2):"esriGeometryPolygon"===i.geometryType?i.readCentroid():i.readUnquantizedGeometry();if(h){if(h.isPoint){const[t,i]=h.coords;return this._writeGlyphs(e,n,{x:t,y:i},s)}h.forEachVertex(((t,i)=>this._writeGlyphs(e,n,{x:t,y:i},s)))}},_._writePlacedText=function(e,r,n,o){const s=t.unwrap(this._textPlacement),h=l.CIMMarkerPlacementHelper.getPlacement(n,s,i.pt2px(1));if(!h)return;let a=h.next();for(;null!=a;){const t=a.getAngle();o.setRotation(t),this._writeGlyphs(e,r,{x:a.tx,y:a.ty},o),o.setRotation(-t),a=h.next()}},_._writeGlyphs=function(e,t,i,r){const n=a.MaterialKeyBase.load(this._materialKey),s=o.i1616to32(Math.round(c*i.x),Math.round(c*i.y));for(const o of r.glyphs){n.textureBinding=o.textureBinding,e.recordStart(t,n.data,this.geometryType,!1,!0);const i=o.bounds,r=this._vertexBoundsScale;e.vertexBounds(i.x*r,i.y*r,i.width*r,i.height*r),this._writeVertices(e,t,s,o),e.recordEnd()}},_._writeGlyph=function(e,t,i,r,n){const s=a.MaterialKeyBase.load(this._materialKey),h=o.i1616to32(Math.round(c*i),Math.round(c*r));s.textureBinding=n.textureBinding,e.recordStart(t,s.data,this.geometryType,!1,!0);const l=n.bounds,x=this._vertexBoundsScale;e.vertexBounds(l.x*x,l.y*x,l.width*x,l.height*x),this._writeVertices(e,t,h,n),e.recordEnd()},_._writeVertices=function(e,t,i,r){const n=e.vertexCount();this._writeVertexCommon(e,t,i,r),e.vertexWrite(r.offsets.upperLeft),e.vertexWrite(r.texcoords.upperLeft),e.vertexEnd(),this._writeVertexCommon(e,t,i,r),e.vertexWrite(r.offsets.upperRight),e.vertexWrite(r.texcoords.upperRight),e.vertexEnd(),this._writeVertexCommon(e,t,i,r),e.vertexWrite(r.offsets.lowerLeft),e.vertexWrite(r.texcoords.lowerLeft),e.vertexEnd(),this._writeVertexCommon(e,t,i,r),e.vertexWrite(r.offsets.lowerRight),e.vertexWrite(r.texcoords.lowerRight),e.vertexEnd(),e.indexWrite(n+0),e.indexWrite(n+1),e.indexWrite(n+2),e.indexWrite(n+1),e.indexWrite(n+3),e.indexWrite(n+2)},_._writeVertexCommon=function(e,t,i,r){const n=this._color,s=this._haloColor,h=o.i8888to32(0,0,this._referenceSize,this._bitset),a=o.i8888to32(0,0,this._size,this._haloSize);e.vertexWrite(i),e.vertexWrite(t),e.vertexWrite(n),e.vertexWrite(s),e.vertexWrite(a),e.vertexWrite(h)},d}(x)}));
