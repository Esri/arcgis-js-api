/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/maybe","../../../../../../core/screenUtils","../../../../../../layers/graphics/featureConversionUtils","../../../../../../symbols/cim/placements/CIMMarkerPlacementHelper","../../definitions","../../enums","../../number","../../materialKey/MaterialKey","./shapingUtils"],(function(e,t,i,r,n,o,s,h,a,l){"use strict";const x=8;return c=>function(c){function d(...e){var t;return(t=c.call(this,...e)||this)._isCIM=!1,t._vertexBoundsScale=1,t.geometryType=s.WGLGeometryType.TEXT,t._aux=h.i8888to32(0,0,t._referenceSize,t._bitset),t}e._inheritsLoose(d,c);var _=d.prototype;return _.bindTextInfo=function(e,i){e&&e.length?this._shapingInfo=t.andThen(e,(e=>l.shapeGlyphs(e,i,{scale:this._scale,angle:this._angle,xOffset:this._xOffset,yOffset:this._yOffset,hAlign:this._xAlignD,vAlign:this._yAlignD,maxLineWidth:Math.max(32,Math.min(this._lineWidth,512)),lineHeight:o.MAGIC_LABEL_LINE_HEIGHT*Math.max(.25,Math.min(this._lineHeight,4)),decoration:this._decoration,isCIM:this._isCIM}))):this._shapingInfo=null},_._write=function(e,t,i){const r=t.getDisplayId();this._writeGeometry(e,t,r,i)},_._writeGeometry=function(e,i,n,o){const s=this._shapingInfo;if(t.isNone(s))return;if(t.isSome(this._textPlacement)){const t=null!=o?o:i.readLegacyGeometryForDisplay();return this._writePlacedText(e,n,t,s)}const h=o?r.deltaDecodeGeometry(r.convertFromGeometry(o),2):"esriGeometryPolygon"===i.geometryType?i.readCentroid():i.readGeometryForDisplay();if(!t.isNone(h)){if(h.isPoint){const[t,i]=h.coords;return this._writeGlyphs(e,n,{x:t,y:i},s)}h.forEachVertex(((t,i)=>this._writeGlyphs(e,n,{x:t,y:i},s)))}},_._writePlacedText=function(e,r,o,s){const h=t.unwrap(this._textPlacement),a=n.CIMMarkerPlacementHelper.getPlacement(o,h,i.pt2px(1));if(!a)return;let l=a.next();for(;null!=l;){const t=l.getAngle();s.setRotation(t);const i=l.tx,n=l.ty;i<0||i>=512||n<0||n>=512?l=a.next():(this._writeGlyphs(e,r,{x:i,y:n},s),s.setRotation(-t),l=a.next())}},_._writeGlyphs=function(e,t,i,r){const n=a.MaterialKeyBase.load(this._materialKey),o=h.i1616to32(Math.round(x*i.x),Math.round(x*i.y)),s=this._vertexBoundsScale,l=r.bounds,c=2*Math.max(l.width,l.height);for(const h of r.glyphs)n.textureBinding=h.textureBinding,e.recordStart(t,n.data,this.geometryType,!1,!0),e.vertexBounds(i.x+l.x+this._xOffset,i.y+l.y+this._yOffset,c*s,c*s),this._writeVertices(e,t,o,h),e.recordEnd()},_._writeGlyph=function(e,t,i,r,n){const o=a.MaterialKeyBase.load(this._materialKey),s=h.i1616to32(Math.round(x*i),Math.round(x*r));o.textureBinding=n.textureBinding,e.recordStart(t,o.data,this.geometryType,!1,!0);const l=n.bounds,c=this._vertexBoundsScale;e.vertexBounds(i+l.x*c,r+l.y*c,l.width*c,l.height*c),this._writeVertices(e,t,s,n),e.recordEnd()},_._writeVertices=function(e,t,i,r){const n=e.vertexCount();this._writeVertexCommon(e,t,i,r),e.vertexWrite(r.offsets.upperLeft),e.vertexWrite(r.texcoords.upperLeft),e.vertexEnd(),this._writeVertexCommon(e,t,i,r),e.vertexWrite(r.offsets.upperRight),e.vertexWrite(r.texcoords.upperRight),e.vertexEnd(),this._writeVertexCommon(e,t,i,r),e.vertexWrite(r.offsets.lowerLeft),e.vertexWrite(r.texcoords.lowerLeft),e.vertexEnd(),this._writeVertexCommon(e,t,i,r),e.vertexWrite(r.offsets.lowerRight),e.vertexWrite(r.texcoords.lowerRight),e.vertexEnd(),e.indexWrite(n+0),e.indexWrite(n+1),e.indexWrite(n+2),e.indexWrite(n+1),e.indexWrite(n+3),e.indexWrite(n+2)},_._writeVertexCommon=function(e,t,i,r){const n=this._color,o=this._haloColor,s=h.i8888to32(0,0,this._referenceSize,this._bitset),a=h.i8888to32(0,0,this._size,this._haloSize);e.vertexWrite(i),e.vertexWrite(t),e.vertexWrite(n),e.vertexWrite(o),e.vertexWrite(a),e.vertexWrite(s),e.vertexWrite(this._minMaxZoom)},d}(c)}));
