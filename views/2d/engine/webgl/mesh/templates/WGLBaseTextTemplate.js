/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/maybe","../../../../../../core/screenUtils","../../../../../../layers/graphics/featureConversionUtils","../../../../../../symbols/cim/placements/CIMMarkerPlacementHelper","../../definitions","../../enums","../../number","../../materialKey/MaterialKey","./shapingUtils"],(function(e,t,i,r,o,n,s,h,a,d){"use strict";const x=8,c=h.i1616to32(4,4),l=h.i1616to32(4,2),u=h.i1616to32(4,6),_=[l,l,u,u],g=[l,u,l,u],f=[u,u,c,c],y=[c,c,u,u],m=[u,c,u,c],p=[c,u,c,u];return l=>function(l){function u(...e){var t;return(t=l.call(this,...e)||this)._isCIM=!1,t._vertexBoundsScale=1,t.geometryType=s.WGLGeometryType.TEXT,t._aux=h.i8888to32(0,0,t._referenceSize,t._bitset),t}e._inheritsLoose(u,l);var v=u.prototype;return v.bindTextInfo=function(e,i){e&&e.length?this._shapingInfo=t.applySome(e,(e=>d.shapeGlyphs(e,i,{scale:this._scale,angle:this._angle,xOffset:this._xOffset,yOffset:this._yOffset,hAlign:this._xAlignD,vAlign:this._yAlignD,maxLineWidth:Math.max(32,Math.min(this._lineWidth,512)),lineHeight:n.MAGIC_LABEL_LINE_HEIGHT*Math.max(.25,Math.min(this._lineHeight,4)),decoration:this._decoration,isCIM:this._isCIM,hasBackground:!!this._backgroundColor,borderLineSize:this._borderLineSize}))):this._shapingInfo=null},v._write=function(e,t,i,r){const o=t.getDisplayId();this._writeGeometry(e,t,o,i,r)},v._writeGeometry=function(e,i,o,n,s){const h=this._shapingInfo;if(t.isNone(h))return;if(t.isSome(this._textPlacement)){const t=s??i.readLegacyGeometryForDisplay();return this._writePlacedText(e,o,t,h,n)}const a=s?r.deltaDecodeGeometry(r.convertFromGeometry(s),2):"esriGeometryPolygon"===i.geometryType?i.readCentroid():i.readGeometryForDisplay();if(!t.isNone(a)){if(a.isPoint){const[t,i]=a.coords;if(!e.hasAggregates&&e.hasPixelBufferEnabled&&(t<0||t>=512||i<0||i>=512))return;return this._writeGlyphs(e,o,{x:t,y:i},h)}a.forEachVertex(((t,i)=>this._writeGlyphs(e,o,{x:t,y:i},h)))}},v._writePlacedText=function(e,r,n,s,h){const a=t.unwrap(this._textPlacement),d=o.CIMMarkerPlacementHelper.getPlacement(n,a,i.pt2px(1),e.tileKey,h.geometryEngine);if(!d)return;let x=d.next();for(;null!=x;){const t=-x.getAngle();s.setRotation(t);const i=x.tx,o=-x.ty;i<0||i>=512||o<0||o>=512?x=d.next():(this._writeGlyphs(e,r,{x:i,y:o},s),s.setRotation(-t),x=d.next())}},v._writeGlyphs=function(e,t,i,r){const o=a.MaterialKeyBase.load(this._materialKey),n=h.i1616to32(Math.round(x*i.x),Math.round(x*i.y)),s=this._vertexBoundsScale,{bounds:d,background:c,glyphs:l}=r;l.length>0&&(this._borderLineColor||this._backgroundColor)&&(o.textureBinding=l[0].textureBinding,e.recordStart(t,o.data,this.geometryType,!0),this._writeBackgroundGeometry(e,t,i,d,c),e.recordEnd());const u=2*Math.max(d.width,d.height);for(const h of r.glyphs)o.textureBinding=h.textureBinding,e.recordStart(t,o.data,this.geometryType,!0),e.vertexBounds(i.x+d.x+this._xOffset,i.y+d.y-this._yOffset,u*s,u*s),this._writeVertices(e,t,n,h),e.recordEnd()},v._writeGlyph=function(e,t,i,r,o){const n=a.MaterialKeyBase.load(this._materialKey),s=h.i1616to32(Math.round(x*i),Math.round(x*r));n.textureBinding=o.textureBinding,e.recordStart(t,n.data,this.geometryType,!0);const d=o.bounds,c=this._vertexBoundsScale;e.vertexBounds(i+d.x*c,r+d.y*c,d.width*c,d.height*c),this._writeVertices(e,t,s,o),e.recordEnd()},v._writeVertices=function(e,t,i,r){const o=e.vertexCount();this._writeVertexCommon(e,t,i,r),e.vertexWrite(r.offsets.upperLeft),e.vertexWrite(r.texcoords.upperLeft),e.vertexEnd(),this._writeVertexCommon(e,t,i,r),e.vertexWrite(r.offsets.upperRight),e.vertexWrite(r.texcoords.upperRight),e.vertexEnd(),this._writeVertexCommon(e,t,i,r),e.vertexWrite(r.offsets.lowerLeft),e.vertexWrite(r.texcoords.lowerLeft),e.vertexEnd(),this._writeVertexCommon(e,t,i,r),e.vertexWrite(r.offsets.lowerRight),e.vertexWrite(r.texcoords.lowerRight),e.vertexEnd(),e.indexWrite(o+0),e.indexWrite(o+1),e.indexWrite(o+2),e.indexWrite(o+1),e.indexWrite(o+3),e.indexWrite(o+2)},v._writeVertexCommon=function(e,t,i,r){const o=this._color,n=this._haloColor,s=h.i8888to32(0,0,this._referenceSize,this._bitset),a=h.i8888to32(0,0,this._size,this._haloSize);e.vertexWrite(i),e.vertexWrite(t),e.vertexWrite(o),e.vertexWrite(n),e.vertexWrite(a),e.vertexWrite(s),e.vertexWrite(this._minMaxZoom)},v._writeBackgroundVertex=function(e,t,i,r,o,n){const s=h.i8888to32(0,1,this._referenceSize,this._bitset),a=h.i8888to32(0,0,this._size,this._haloSize),d=h.i8888to32(0,0,0,0);e.vertexWrite(i),e.vertexWrite(t),e.vertexWrite(r),e.vertexWrite(d),e.vertexWrite(a),e.vertexWrite(s),e.vertexWrite(this._minMaxZoom),e.vertexWrite(o),e.vertexWrite(n),e.vertexEnd()},v._writeBackgroundQuad=function(e,t,i,r,o,n){const s=e.vertexCount();this._writeBackgroundVertex(e,t,i,r,o.upperLeft,n[0]),this._writeBackgroundVertex(e,t,i,r,o.upperRight,n[1]),this._writeBackgroundVertex(e,t,i,r,o.lowerLeft,n[2]),this._writeBackgroundVertex(e,t,i,r,o.lowerRight,n[3]),e.indexWrite(s+0),e.indexWrite(s+1),e.indexWrite(s+2),e.indexWrite(s+1),e.indexWrite(s+3),e.indexWrite(s+2)},v._writeBackgroundGeometry=function(e,t,i,r,o){const n=h.i1616to32(Math.round(x*i.x),Math.round(x*i.y)),{x:s,y:a,width:d,height:l}=r,u=2*Math.max(d,l);if(e.vertexBounds(i.x+s+this._xOffset,i.y+a-this._yOffset,u*this._vertexBoundsScale,u*this._vertexBoundsScale),this._backgroundColor){const i=[c,c,c,c];this._writeBackgroundQuad(e,t,n,this._backgroundColor,o.main,i)}if(this._borderLineColor||this._backgroundColor){const i=!!this._borderLineColor&&!!this._borderLineSize&&this._borderLineSize>0,[r,s,h,a,d]=i?[_,_,g,g,this._borderLineColor]:[f,y,m,p,this._backgroundColor];this._writeBackgroundQuad(e,t,n,d,o.top,r),this._writeBackgroundQuad(e,t,n,d,o.bot,s),this._writeBackgroundQuad(e,t,n,d,o.left,h),this._writeBackgroundQuad(e,t,n,d,o.right,a)}},u}(l)}));
