/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/screenUtils","../../../../../../chunks/mat2d","../../../../../../chunks/mat2df32","../../../../../../chunks/vec2","../../../../../../chunks/vec2f32","../../alignmentUtils","../../number","../../Rect","../../collisions/BoundingBox"],(function(t,e,n,i,s,o,r,h,a,c,f){"use strict";const u=26,d=4,l=u+d,g=u-6,m=3,_=8,y=Math.PI/180,p=8,x=1.5;let w=function(){function t(t,e,n,i){this._rotationT=s.create(),this._xBounds=0,this._yBounds=0,this.minZoom=0,this.maxZoom=255,this._bounds=null;const o=n.rect,r=new Float32Array(8);t*=i,e*=i;const h=n.code?o.width*i:n.metrics.width,a=n.code?o.height*i:n.metrics.height;this.width=h,this.height=a,r[0]=t,r[1]=e,r[2]=t+h,r[3]=e,r[4]=t,r[5]=e+a,r[6]=t+h,r[7]=e+a,this._data=r,this._setTextureCoords(o),this._scale=i,this._mosaic=n,this.x=t,this.y=e,this.maxOffset=Math.max(t+h,e+a)}var n=t.prototype;return n.setTransform=function(t){this._transform=t,this._offsets=null},n._setOffsets=function(t){this._offsets||(this._offsets={upperLeft:0,upperRight:0,lowerLeft:0,lowerRight:0});const e=this._offsets,n=new Float32Array(8),o=i.multiply(s.create(),this._rotationT,this._transform);s.transformMany(n,t,o),e.upperLeft=a.i1616to32(n[0]*_,n[1]*_),e.upperRight=a.i1616to32(n[2]*_,n[3]*_),e.lowerLeft=a.i1616to32(n[4]*_,n[5]*_),e.lowerRight=a.i1616to32(n[6]*_,n[7]*_)},n._setTextureCoords=function({x:t,y:e,width:n,height:i}){this._texcoords={upperLeft:a.i1616to32(t,e),upperRight:a.i1616to32(t+n,e),lowerLeft:a.i1616to32(t,e+i),lowerRight:a.i1616to32(t+n,e+i)}},e._createClass(t,[{key:"mosaic",get:function(){return this._mosaic}},{key:"angle",get:function(){return this._angle},set:function(t){this._angle=t,i.fromRotation(this._rotationT,-t),this._setOffsets(this._data)}},{key:"xTopLeft",get:function(){return this._data[0]}},{key:"yTopLeft",get:function(){return this._data[1]}},{key:"xBottomRight",get:function(){return this._data[6]}},{key:"yBottomRight",get:function(){return this._data[7]}},{key:"texcoords",get:function(){return this._texcoords}},{key:"textureBinding",get:function(){return this._mosaic.textureBinding}},{key:"offsets",get:function(){return this._offsets||this._setOffsets(this._data),this._offsets}},{key:"char",get:function(){return String.fromCharCode(this._mosaic.code)}},{key:"code",get:function(){return this._mosaic.code}},{key:"bounds",get:function(){if(!this._bounds){const{height:t,width:e}=this._mosaic.metrics,n=e*this._scale,o=Math.abs(t)*this._scale,r=new Float32Array(8);r[0]=this.x,r[1]=this.y,r[2]=this.x+n,r[3]=this.y,r[4]=this.x,r[5]=this.y+o,r[6]=this.x+n,r[7]=this.y+o;const h=i.multiply(s.create(),this._rotationT,this._transform);s.transformMany(r,r,h);let a=1/0,c=1/0,u=0,d=0;for(let i=0;i<4;i++){const t=r[2*i],e=r[2*i+1];a=Math.min(a,t),c=Math.min(c,e),u=Math.max(u,t),d=Math.max(d,e)}const l=u-a,g=d-c,m=a+l/2,_=c+g/2;this._bounds=new f(m,_,l,g)}return this._bounds}}]),t}();const M=(t,e)=>({code:0,page:0,sdf:!0,rect:new c(0,0,11,8),textureBinding:e,metrics:{advance:0,height:4,width:t,left:0,top:0}});function b(t,e){return t.forEach((t=>o.transformMat2d(t,t,e))),{upperLeft:a.i1616to32(_*t[0][0],_*t[0][1]),upperRight:a.i1616to32(_*t[1][0],_*t[1][1]),lowerLeft:a.i1616to32(_*t[2][0],_*t[2][1]),lowerRight:a.i1616to32(_*t[3][0],_*t[3][1])}}let k=function(){function t(t,e,n){this._rotation=0,this._decorate(t,e,n),this.glyphs=t,this.bounds=this._createBounds(t),this.isMultiline=e.length>1,this._hasRotation=0!==n.angle,this._transform=this._createGlyphTransform(this.bounds,n),this._borderLineSize=n.borderLineSize,(n.borderLineSize||n.hasBackground)&&([this.bounds,this.background]=this.shapeBackground(this._transform));for(const i of t)i.setTransform(this._transform)}var h=t.prototype;return h.setRotation=function(t){if(0===t&&0===this._rotation)return;this._rotation=t;const e=this._transform,n=i.fromRotation(s.create(),t);i.multiply(e,n,e);for(const i of this.glyphs)i.setTransform(this._transform)},h._decorate=function(t,e,n){if(!n.decoration||"none"===n.decoration||!t.length)return;const i=n.scale,s="underline"===n.decoration?l:g,o=t[0].textureBinding;for(const r of e){const e=r.startX*i,n=r.startY*i,h=(r.width+r.glyphWidthEnd)*i;t.push(new w(e,n+s*i,M(h,o),1))}},h.shapeBackground=function(t){const e=n.pt2px(this._borderLineSize||0),i=(x+e)/2,s=this._borderLineSize?i:0,{xmin:o,ymin:r,xmax:h,ymax:a,x:c,y:u,width:d,height:l}=this.bounds,g=[o-p,r-p],m=[h+p,r-p],_=[o-p,a+p],y=[h+p,a+p],w=b([[g[0]-i,g[1]-i],[m[0]+i,m[1]-i],[g[0]+s,g[1]+s],[m[0]-s,m[1]+s]],t),M=b([[_[0]+s,_[1]-s],[y[0]-s,y[1]-s],[_[0]-i,_[1]+i],[y[0]+i,y[1]+i]],t),k=b([[g[0]-i,g[1]-i],[g[0]+s,g[1]+s],[_[0]-i,_[1]+i],[_[0]+s,_[1]-s]],t),B=b([[m[0]-s,m[1]+s],[m[0]+i,m[1]-i],[y[0]-s,y[1]-s],[y[0]+i,y[1]+i]],t),L={main:b([g,m,_,y],t),top:w,bot:M,left:k,right:B};return[new f(c,u,d+2*i,l+2*i),L]},h._createBounds=function(t){let e=1/0,n=1/0,i=0,s=0;for(const h of t)e=Math.min(e,h.xTopLeft),n=Math.min(n,h.yTopLeft),i=Math.max(i,h.xBottomRight),s=Math.max(s,h.yBottomRight);const o=i-e,r=s-n;return new f(e+o/2,n+r/2,o,r)},h._createGlyphTransform=function(t,e){const n=y*e.angle,h=s.create(),a=r.create();return i.translate(h,h,o.set(a,e.xOffset,-e.yOffset)),e.isCIM?i.rotate(h,h,n):(i.translate(h,h,o.set(a,t.x,t.y)),i.rotate(h,h,n),i.translate(h,h,o.set(a,-t.x,-t.y))),h},e._createClass(t,[{key:"boundsT",get:function(){const t=this.bounds,e=o.set(r.create(),t.x,t.y);if(o.transformMat2d(e,e,this._transform),this._hasRotation){const n=Math.max(t.width,t.height);return new f(e[0],e[1],n,n)}return new f(e[0],e[1],t.width,t.height)}}]),t}(),B=function(t,e,n,i,s,o){this.glyphWidthEnd=0,this.startX=0,this.startY=0,this.start=Math.max(0,Math.min(e,n)),this.end=Math.max(0,Math.max(e,n)),this.end<t.length&&(this.glyphWidthEnd=t[this.end].metrics.width),this.width=i,this.yMin=s,this.yMax=o};const L=t=>10===t,R=t=>32===t;function T(t,e,n){const i=new Array,s=1/n.scale,o=n.maxLineWidth*s,r=e?t.length-1:0,h=e?-1:t.length,a=e?-1:1;let c=r,f=0,u=0,d=c,l=d,g=0,m=1/0,_=0;for(;c!==h;){const{code:e,metrics:n}=t[c],s=Math.abs(n.top);if(L(e)||R(e)||(m=Math.min(m,s),_=Math.max(_,s+n.height)),L(e))c!==r&&(i.push(new B(t,d,c-a,f,m,_)),m=1/0,_=0),f=0,d=c+a,l=c+a,u=0;else if(R(e))l=c+a,u=0,g=n.advance,f+=n.advance;else if(f>o){if(l!==d){const e=l-2*a;f-=g,i.push(new B(t,d,e,f-u,m,_)),m=1/0,_=0,d=l,f=u}else i.push(new B(t,d,c-a,f,m,_)),m=1/0,_=0,d=c,l=c,f=0;f+=n.advance,u+=n.advance}else f+=n.advance,u+=n.advance;c+=a}const y=new B(t,d,c-a,f,m,_);return y.start>=0&&y.end<t.length&&i.push(y),i}function v(t,e){let n=0;for(let o=0;o<t.length;o++){const{width:e}=t[o];n=Math.max(e,n)}const i="underline"===e.decoration?d:0,s=t[0].yMin;return{x:0,y:s,height:t[t.length-1].yMax+e.lineHeight*(t.length-1)+i-s,width:n}}function S(t,e,n){const i=n.scale,s=new Array,o=T(t,e,n),r=v(o,n),{vAlign:a,hAlign:c}=n,f=a===h.VAlign.Baseline?1:0,d=f?0:a-1,l=(1-f)*-r.y+d*(r.height/2)+(f?1:0)*-u;for(let h=0;h<o.length;h++){const{start:e,end:r,width:a}=o[h];let f=-1*(c+1)*(a/2)-m;const u=h*n.lineHeight+l-m;o[h].startX=f,o[h].startY=u;for(let n=e;n<=r;n++){const e=t[n];if(L(e.code))continue;const o=new w(f+e.metrics.left,u-e.metrics.top,e,i);f+=e.metrics.advance,s.push(o)}}return new k(s,o,n)}t.ShapedGlyph=w,t.ShapingInfo=k,t.shapeGlyphs=S,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
