// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","../../../../../../core/libs/gl-matrix-2/mat2d","../../../../../../core/libs/gl-matrix-2/mat2df32","../../../../../../core/libs/gl-matrix-2/vec2","../../../../../../core/libs/gl-matrix-2/vec2f32","../../alignmentUtils","../../number","../../Rect","../../collisions/BoundingBox"],(function(t,e,r,i,n,a,o,s,h,f){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.shapeGlyphs=e.ShapingInfo=e.ShapedGlyph=void 0;var c=Math.PI/180,u=function(){function t(t,e,r,n){this._rotationT=i.mat2df32.create(),this._xBounds=0,this._yBounds=0,this.minZoom=0,this.maxZoom=255;var a=r.rect,o=new Float32Array(8);t*=n,e*=n;var s=r.code?a.width*n:r.metrics.width,h=r.code?a.height*n:r.metrics.height;o[0]=t,o[1]=e,o[2]=t+s,o[3]=e,o[4]=t,o[5]=e+h,o[6]=t+s,o[7]=e+h,this._data=o,this._setTextureCoords(a),this._scale=n,this._mosaic=r,this.x=t,this.y=e}return Object.defineProperty(t.prototype,"width",{get:function(){return this._mosaic.metrics.width*this._scale},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"mosaic",{get:function(){return this._mosaic},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"angle",{get:function(){return this._angle},set:function(t){this._angle=t,r.mat2d.identity(this._rotationT),r.mat2d.rotate(this._rotationT,this._rotationT,-t),this._setOffsets(this._data)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"xTopLeft",{get:function(){return this._data[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"yTopLeft",{get:function(){return this._data[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"xBottomRight",{get:function(){return this._data[6]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"yBottomRight",{get:function(){return this._data[7]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"texcoords",{get:function(){return this._texcoords},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"textureBinding",{get:function(){return this._mosaic.textureBinding},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"offsets",{get:function(){return this._offsets||this._setOffsets(this._data),this._offsets},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"char",{get:function(){return String.fromCharCode(this._mosaic.code)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"code",{get:function(){return this._mosaic.code},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"bounds",{get:function(){var t=this._mosaic.metrics,e=t.height,n=t.width*this._scale,a=Math.abs(e)*this._scale,o=new Float32Array(8);o[0]=this.x,o[1]=this.y,o[2]=this.x+n,o[3]=this.y,o[4]=this.x,o[5]=this.y+a,o[6]=this.x+n,o[7]=this.y+a;var s=r.mat2d.multiply(i.mat2df32.create(),this._rotationT,this._T);i.mat2df32.transformMany(o,o,s);for(var h=1/0,c=1/0,u=0,d=0,l=0;l<4;l++){var p=o[2*l],m=o[2*l+1];h=Math.min(h,p),c=Math.min(c,m),u=Math.max(u,p),d=Math.max(d,m)}var g=u-h,y=d-c,_=h+g/2,b=c+y/2;return new f.default(_,b,g,y)},enumerable:!1,configurable:!0}),t.prototype.setTransform=function(t){this._T=t,this._offsets=null},t.prototype._setOffsets=function(t){this._offsets||(this._offsets={upperLeft:0,upperRight:0,lowerLeft:0,lowerRight:0});var e=this._offsets,n=new Float32Array(8),a=r.mat2d.multiply(i.mat2df32.create(),this._rotationT,this._T);i.mat2df32.transformMany(n,t,a),e.upperLeft=s.i1616to32(8*n[0],8*n[1]),e.upperRight=s.i1616to32(8*n[2],8*n[3]),e.lowerLeft=s.i1616to32(8*n[4],8*n[5]),e.lowerRight=s.i1616to32(8*n[6],8*n[7])},t.prototype._setTextureCoords=function(t){var e=t.x,r=t.y,i=t.width,n=t.height;this._texcoords={upperLeft:s.i1616to32(e,r),upperRight:s.i1616to32(e+i,r),lowerLeft:s.i1616to32(e,r+n),lowerRight:s.i1616to32(e+i,r+n)}},t}();e.ShapedGlyph=u;var d=function(t,e){return{code:0,page:0,sdf:!0,rect:new h.default(0,0,11,8),textureBinding:e,metrics:{advance:0,height:4,width:t,left:0,top:0}}},l=function(){function t(t,e,r){this._rotation=0,this._decorate(t,e,r),this.glyphs=t,this.bounds=this._createBounds(t),this.isMultiline=e.length>1,this._hasRotation=0!==r.angle,this._T=this._createGlyphTransform(this.bounds,r);for(var i=0,n=t;i<n.length;i++){n[i].setTransform(this._T)}}return t.prototype.setRotation=function(t){if(0!==t||0!==this._rotation){this._rotation=t;var e=this._T,n=r.mat2d.fromRotation(i.mat2df32.create(),t);r.mat2d.multiply(e,n,e);for(var a=0,o=this.glyphs;a<o.length;a++){o[a].setTransform(this._T)}}},t.prototype._decorate=function(t,e,r){if(r.decoration&&"none"!==r.decoration&&t.length)for(var i=r.scale,n="underline"===r.decoration?30:20,a=t[0].textureBinding,o=0,s=e;o<s.length;o++){var h=s[o],f=h.startX*i,c=h.startY*i,l=(h.width+h.glyphWidthEnd)*i;t.push(new u(f,c+n*i,d(l,a),1))}},Object.defineProperty(t.prototype,"boundsT",{get:function(){var t=this.bounds,e=n.vec2.set(a.vec2f32.create(),t.x,t.y);if(n.vec2.transformMat2d(e,e,this._T),this._hasRotation){var r=Math.max(t.width,t.height);return new f.default(e[0],e[1],r,r)}return new f.default(e[0],e[1],t.width,t.height)},enumerable:!1,configurable:!0}),t.prototype._createBounds=function(t){for(var e=1/0,r=1/0,i=0,n=0,a=0,o=t;a<o.length;a++){var s=o[a];e=Math.min(e,s.xTopLeft),r=Math.min(r,s.yTopLeft),i=Math.max(i,s.xTopLeft+s.width),n=Math.max(n,s.yBottomRight)}var h=i-e,c=n-r,u=e+h/2,d=r+c/2;return new f.default(u,d,h,c)},t.prototype._createGlyphTransform=function(t,e){var o=c*e.angle,s=i.mat2df32.create(),h=a.vec2f32.create();return r.mat2d.translate(s,s,n.vec2.set(h,e.xOffset,-e.yOffset)),e.isCIM?r.mat2d.rotate(s,s,o):(r.mat2d.translate(s,s,n.vec2.set(h,t.x,t.y)),r.mat2d.rotate(s,s,o),r.mat2d.translate(s,s,n.vec2.set(h,-t.x,-t.y))),s},t}();e.ShapingInfo=l;var p=function(t,e,r,i,n,a){this.glyphWidthEnd=0,this.startX=0,this.startY=0,this.start=Math.max(0,Math.min(e,r)),this.end=Math.max(0,Math.max(e,r)),this.end<t.length&&(this.glyphWidthEnd=t[this.end].metrics.width),this.width=i,this.yMin=n,this.yMax=a},m=function(t){return 10===t},g=function(t){return 32===t};e.shapeGlyphs=function(t,e,r){for(var i=r.scale,n=new Array,a=function(t,e,r){for(var i=new Array,n=1/r.scale,a=r.maxLineWidth*n,o=e?t.length-1:0,s=e?-1:t.length,h=e?-1:1,f=o,c=0,u=0,d=f,l=d,y=0,_=1/0,b=0;f!==s;){var v=t[f],x=v.code,w=v.metrics,M=Math.abs(w.top);if(m(x)||g(x)||(_=Math.min(_,M),b=Math.max(b,M+w.height)),m(x))f!==o&&(i.push(new p(t,d,f-h,c,_,b)),_=1/0,b=0),c=0,d=f+h,l=f+h,u=0;else if(g(x))l=f+h,u=0,y=w.advance,c+=w.advance;else if(c>a){if(l!==d){var T=l-2*h;c-=y,i.push(new p(t,d,T,c-u,_,b)),_=1/0,b=0,d=l,c=u}else i.push(new p(t,d,f-h,c,_,b)),_=1/0,b=0,d=f,l=f,c=0;c+=w.advance,u+=w.advance}else c+=w.advance,u+=w.advance;f+=h}var O=new p(t,d,f-h,c,_,b);return O.start>=0&&O.end<t.length&&i.push(O),i}(t,e,r),s=function(t,e){for(var r=0,i=0;i<t.length;i++){var n=t[i].width;r=Math.max(n,r)}var a="underline"===e.decoration?4:0,o=t[0].yMin;return{x:0,y:o,height:t[t.length-1].yMax+e.lineHeight*(t.length-1)+a-o,width:r}}(a,r),h=r.vAlign,f=r.hAlign,c=h===o.VAlign.Baseline?1:0,d=c?0:h-1,y=(1-c)*-s.y+d*(s.height/2)+-26*(c?1:0),_=0;_<a.length;_++){var b=a[_],v=b.start,x=b.end,w=-1*(f+1)*(b.width/2)-3,M=_*r.lineHeight+y-3;a[_].startX=w,a[_].startY=M;for(var T=v;T<=x;T++){var O=t[T];if(!m(O.code)){var P=new u(w+O.metrics.left,M-O.metrics.top,O,i);w+=O.metrics.advance,n.push(P)}}}return new l(n,a,r)}}));