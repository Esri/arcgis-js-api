/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../../../layers/graphics/OptimizedGeometry","../../../../../../core/libs/earcut/earcut","../../definitions","../../TileClipper","../bufcut","../Tesselator"],(function(t,e,o,n,r,s,l){"use strict";const c=1e-5,i=new l,u=new r.TileClipper(0,0,0,1,0),f=new r.TileClipper(0,0,0,1,0);function h(t,e,o){let n=0;for(let r=1;r<o;r++){const o=t[2*(e+r-1)],s=t[2*(e+r-1)+1];n+=(t[2*(e+r)]-o)*(t[2*(e+r)+1]+s)}return n}function a(t,e,o,n,r){let s=0;const l=2;for(let c=o;c<n;c+=3){const o=(t.getValue(c)-r)*l,n=(t.getValue(c+1)-r)*l,i=(t.getValue(c+2)-r)*l;s+=Math.abs((e[o]-e[i])*(e[n+1]-e[o+1])-(e[o]-e[n])*(e[i+1]-e[o+1]))}return s}function d(t,e){const{coords:o,lengths:n,hasIndeterminateRingOrder:r}=e,l=t.indexWriter(),i=t.vertexCount();if(r)return!1;const u=l.length;let f=0;for(let d=0;d<n.length;){let t=d,e=n[d],r=h(o,f,e);const g=[];for(;++t<n.length;){const s=n[t],l=h(o,f+e,s);if(!(l>0))break;r+=l,g.push(f+e),e+=s}const p=l.length;s.bufcut(l,o,f,f+e,g,2,i);const x=a(l,o,p,l.length,i),b=Math.abs(r);if(Math.abs((x-b)/Math.max(1e-7,b))>c)return l.seek(u),!1;d=t,f+=e}return!0}function g(t,e,n){const{coords:r,lengths:s,hasIndeterminateRingOrder:l}=e;if(l)return!1;let c=0;for(let i=0;i<s.length;){let l=i,u=s[i];const f=[];for(;++l<s.length;){const t=s[l];if(!(h(r,c+u,t)>0))break;f.push(c+u-c),u+=t}const a=c+u,d=e.coords.slice(2*c,2*a),g=o.earcut(d,f,2);for(const e of g)t.push(e+n+c);i=l,c+=u}return!0}function p(t,e){const o=[],n=[],r=t.indexWriter(),s=t.vertexCount(),{coords:l,lengths:c}=e;i.beginPolygon(o,n);let u=0;for(let f=0;f<c.length;f++){const t=e.lengths[f];i.beginContour();for(let e=0;e<t;e++){const t=[l[2*(u+e)],l[2*(u+e)+1],0];i.addVertex(t,t)}i.endContour(),u+=t}i.endPolygon();for(let i=0;i<n.length;i++)r.push(n[i]+s);return o}function x(t,e,o,n,r,s,l,c){const i=((t-r)*(s-c)-(e-c)*(r-l))/((t-o)*(s-c)-(e-n)*(r-l));if(i<0||i>1)return null;return{x:Math.round(t+i*(o-t)),y:Math.round(e+i*(n-e))}}function b(t,e,o){let n=0;for(let r=0;r<t.lengths.length;r++){const s=t.lengths[r];for(let r=0;r<s;r++){const s=t.coords[2*(r+n)],l=t.coords[2*(r+n)+1];if(s<e||s>o||l<e||l>o)return!0}n+=s}return!1}function T(t,o){if(!b(t,-128,n.TILE_SIZE+128))return t;u.setPixelMargin(o),u.reset(3);let r=0;for(let e=0;e<t.lengths.length;e++){const o=t.lengths[e];let n=t.coords[2*(0+r)],s=t.coords[2*(0+r)+1];u.moveTo(n,s);for(let e=1;e<o;e++)n=t.coords[2*(e+r)],s=t.coords[2*(e+r)+1],u.lineTo(n,s);u.close(),r+=o}const s=u.result(!1);if(!s)return null;const l=[],c=[];for(const e of s){let t=0;for(const o of e)c.push(o.x),c.push(o.y),t++;l.push(t)}return new e(l,c)}function y(t,e){f.setPixelMargin(e);const o=f,r=-e,s=n.TILE_SIZE+e;let l=[],c=!1,i=0;for(;i<t.length;){const e=[],n=t[i];o.reset(2);let[u,f]=n[0];if(c)o.moveTo(u,f);else{if(u<r||u>s||f<r||f>s){c=!0;continue}e.push({x:u,y:f})}let h=!1;const a=n.length;for(let t=1;t<a;++t)if(u+=n[t][0],f+=n[t][1],c)o.lineTo(u,f);else{if(u<r||u>s||f<r||f>s){h=!0;break}e.push({x:u,y:f})}if(h)c=!0;else{if(c){const t=o.resultWithStarts();if(t)for(const e of t)l.push(e)}else l.push({line:e,start:0});i++,c=!1}}return l=l.filter((t=>t.line.length>1)),0===l.length?null:l}function E(t,e,o=0){const n=-o,r=e+o;let s=0,l=0,c=0;for(let i=0;i<t.lengths.length;i++){const e=t.lengths[i],o=c+e;let u=0,f=null;for(;s!==o;){let e=t.coords[2*s],c=t.coords[2*s+++1],i=e<n||e>=r||c<n||c>=r;const h=i;for(;s!==o&&i===h;)i||(t.coords[2*l]=e,t.coords[2*l+++1]=c,u++),e=t.coords[2*s],c=t.coords[2*s+++1],i=e<n||e>=r||c<n||c>=r;if(s===o){i?f&&(t.coords[2*l]=f.x,t.coords[2*l+++1]=f.y,u++):(t.coords[2*l]=e,t.coords[2*l+++1]=c,u++);continue}const a=t.coords[2*(s-2)],d=t.coords[2*(s-2)+1],g=x(a,d,e,c,n,n,r,n)||x(a,d,e,c,r,n,r,r)||x(a,d,e,c,r,r,n,r)||x(a,d,e,c,n,n,n,r);g&&(t.coords[2*l]=g.x,t.coords[2*l+++1]=g.y,u++,f||(f=g)),i||(t.coords[2*l]=e,t.coords[2*l+++1]=c,u++)}t.lengths[i]=u,c+=e}}u.setExtent(n.TILE_SIZE),f.setExtent(n.TILE_SIZE),t.area=h,t.clip=E,t.clipLinesMarshall=y,t.clipMarshall=T,t.triangleArea=a,t.triangulate=d,t.triangulateEarcut=g,t.triangulateLibtess=p,Object.defineProperty(t,"__esModule",{value:!0})}));
