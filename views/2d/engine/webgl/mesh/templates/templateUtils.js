/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../../../../../core/maybe","../../../../../../chunks/earcut","../../../../../../geometry/libtess","../../../../../../layers/graphics/OptimizedGeometry","../../definitions","../../TileClipper","../bufcut"],(function(e,t,n,r,o,s,l,i){"use strict";const u=1e-5,c=new l.TileClipper(0,0,0,1,0),f=new l.TileClipper(0,0,0,1,0);function a(e,t,n){let r=0;for(let o=1;o<n;o++){const n=e[2*(t+o-1)],s=e[2*(t+o-1)+1];r+=(e[2*(t+o)]-n)*(e[2*(t+o)+1]+s)}return r}function h(e,t,n,r,o){let s=0;const l=2;for(let i=n;i<r;i+=3){const n=(e.getValue(i)-o)*l,r=(e.getValue(i+1)-o)*l,u=(e.getValue(i+2)-o)*l;s+=Math.abs((t[n]-t[u])*(t[r+1]-t[n+1])-(t[n]-t[r])*(t[u+1]-t[n+1]))}return s}function g(e,t){const{coords:n,lengths:r,hasIndeterminateRingOrder:o}=t,s=e.indexWriter(),l=e.vertexCount();if(o)return!1;const c=s.length;let f=0;for(let g=0;g<r.length;){let e=g,t=r[g],o=a(n,f,t);const p=[];for(;++e<r.length;){const s=r[e],l=a(n,f+t,s);if(!(l>0))break;o+=l,p.push(f+t),t+=s}const d=s.length;i.bufcut(s,n,f,f+t,p,2,l);const x=h(s,n,d,s.length,l),b=Math.abs(o);if(Math.abs((x-b)/Math.max(1e-7,b))>u)return s.seek(c),!1;g=e,f+=t}return!0}function p(e,t,r){const{coords:o,lengths:s,hasIndeterminateRingOrder:l}=t;if(l)return!1;let i=0;for(let u=0;u<s.length;){let l=u,c=s[u];const f=[];for(;++l<s.length;){const e=s[l];if(!(a(o,i+c,e)>0))break;f.push(i+c-i),c+=e}const h=i+c,g=t.coords.slice(2*i,2*h),p=n.earcut(g,f,2);for(const t of p)e.push(t+r+i);u=l,i+=c}return!0}function d(e,t){const n=e.indexWriter(),o=e.vertexCount(),{coords:s,lengths:l}=t,{buffer:i,vertexCount:u}=r.triangulate(s,l);n.ensureSize(u);for(let r=0;r<u;r++)n.push(r+o);return i}function x(e,t,n){let r=0;for(let o=0;o<e.lengths.length;o++){const s=e.lengths[o];for(let o=0;o<s;o++){const s=e.coords[2*(o+r)],l=e.coords[2*(o+r)+1];if(s<t||s>n||l<t||l>n)return!0}r+=s}return!1}function b(e,n){if(t.isNone(e))return null;if(!x(e,-128,s.TILE_SIZE+128))return e;c.setPixelMargin(n),c.reset(3);let r=0;for(let t=0;t<e.lengths.length;t++){const n=e.lengths[t];let o=e.coords[2*(0+r)],s=e.coords[2*(0+r)+1];c.moveTo(o,s);for(let t=1;t<n;t++)o=e.coords[2*(t+r)],s=e.coords[2*(t+r)+1],c.lineTo(o,s);c.close(),r+=n}const l=c.result(!1);if(!l)return null;const i=[],u=[];for(const t of l){let e=0;for(const n of t)u.push(n.x),u.push(n.y),e++;i.push(e)}return new o(i,u)}function E(e,t){f.setPixelMargin(t);const n=f,r=-t,o=s.TILE_SIZE+t;let l=[],i=!1,u=0;for(;u<e.length;){const t=[],s=e[u];if(!s)return null;n.reset(2);let[c,f]=s[0];if(i)n.moveTo(c,f);else{if(c<r||c>o||f<r||f>o){i=!0;continue}t.push({x:c,y:f})}let a=!1;const h=s.length;for(let e=1;e<h;++e)if(c+=s[e][0],f+=s[e][1],i)n.lineTo(c,f);else{if(c<r||c>o||f<r||f>o){a=!0;break}t.push({x:c,y:f})}if(a)i=!0;else{if(i){const e=n.resultWithStarts();if(e)for(const t of e)l.push(t)}else l.push({line:t,start:0});u++,i=!1}}return l=l.filter((e=>e.line.length>1)),0===l.length?null:l}c.setExtent(s.TILE_SIZE),f.setExtent(s.TILE_SIZE),e.area=a,e.clipLinesMarshall=E,e.clipMarshall=b,e.triangleArea=h,e.triangulate=g,e.triangulateEarcut=p,e.triangulateLibtess=d,Object.defineProperty(e,"__esModule",{value:!0})}));
