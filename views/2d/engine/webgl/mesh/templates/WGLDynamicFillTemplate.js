/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/screenUtils","../../color","../../definitions","../../GeometryUtils","../../number","../../materialKey/MaterialKey","./util","./WGLBaseFillTemplate","./WGLDynamicMeshTemplate","../../util/Result"],(function(t,e,i,n,s,o,l,a,r,c,h){"use strict";const f=128;return function(r){function c(t,c,h){var u,p;if((p=r.call(this,t)||this)._minMaxZoom=o.i1616to32(Math.round(c*n.MIN_MAX_ZOOM_PRECISION_FACTOR),Math.round(h*n.MIN_MAX_ZOOM_PRECISION_FACTOR)),a.isFunction(t.color)){const e=(e,n,s)=>{const o=t.color(e,n,s);return o&&i.premultiplyAlphaRGBA(o)||0};p._dynamicPropertyMap.set("fillColor",e)}else{const e=t.color;p.fillColor=e&&i.premultiplyAlphaRGBA(e)||0}let _=0;a.isFunction(t.height)||(_=t.height||0);const y="CIMMarkerPlacementInsidePolygon"===(null==(u=t.cim.placement)?void 0:u.type)&&t.cim.placement.shiftOddRows?2:1,m=(e,i,n)=>a.isFunction(t.height)?t.height(e,i,n)*y:_*y;p._dynamicPropertyMap.set("_height",m);let d=0;a.isFunction(t.offsetX)||(d=e.pt2px(t.offsetX||0)+f,d>255&&(d=255));const M=(i,n,s)=>{if(a.isFunction(t.offsetX)){let o=e.pt2px(t.offsetX(i,n,s))+f;return o>255&&(o=255),o}return d};p._dynamicPropertyMap.set("_offsetX",M);let g=1;a.isFunction(t.scaleX)||(g=t.scaleX||1);const F=(e,i,n)=>a.isFunction(t.scaleX)?t.scaleX(e,i,n):g;p._dynamicPropertyMap.set("_scaleX",F);let x=0;a.isFunction(t.offsetY)||(x=e.pt2px(-t.offsetY||0)+f,x>255&&(x=255));const I=(i,n,s)=>{if(a.isFunction(t.offsetY)){let o=e.pt2px(-t.offsetY(i,n,s))+f;return o>255&&(o=255),o}return x};p._dynamicPropertyMap.set("_offsetY",I);let P=0;a.isFunction(t.angle)||(P=s.radToByte(t.angle)||0);const X=(e,i,n)=>a.isFunction(t.angle)?s.radToByte(t.angle(e,i,n)):P;return p._dynamicPropertyMap.set("_angle",X),p._effects=t.effects,p._cimFillLayer=t,p._fillMaterialKey=l.FillMaterialKey.load(t.materialKey),p}return t._inheritsLoose(c,r),c.fromCIMFill=function(t,e){const[i,n]=a.getMinMaxZoom(t.scaleInfo,e);return new c(t,i,n)},c.prototype.bindFeature=function(t,i,s){const l=t.readLegacyFeature();this._dynamicPropertyMap.forEach(((t,e)=>{this[e]=t(l,i,s)}));const a=this._fillMaterialKey,r=this._materialCache,c=(0,this._cimFillLayer.materialHash)(l,i,s),f=r.get(c);let u=null;if(f&&h.ok(f.spriteMosaicItem)&&(u=f.spriteMosaicItem),u){const{rect:t,width:i,height:s}=u,l=t.x+n.SPRITE_PADDING,r=t.y+n.SPRITE_PADDING,c=l+i,h=r+s;let f=Math.round(e.pt2px(this._height));f>255?f=255:f<=0&&(f=h-r);let p=Math.round(e.pt2px(this._height/s*i||0));p>255?p=255:p<=0&&(p=c-l);const _=this._scaleX,y=1;this.tl=o.i1616to32(l,r),this.br=o.i1616to32(c,h),this.aux2=o.i8888to32(p,f,this._offsetX,this._offsetY),this.aux3=o.i8888to32(_,y,this._angle,0),a.sdf=u.sdf,a.pattern=!0,a.textureBinding=u.textureBinding}else this.tl=0,this.br=0,this.aux2=0,this.aux3=0,a.sdf=!1,a.pattern=!1,a.textureBinding=0;this._materialKey=a.data},c}(r(c))}));
