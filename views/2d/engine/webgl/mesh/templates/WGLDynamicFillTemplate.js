/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/maybe","../../../../../../core/screenUtils","../../color","../../definitions","../../GeometryUtils","../../number","../../materialKey/MaterialKey","./util","./WGLBaseFillTemplate","./WGLDynamicMeshTemplate","../../util/Result"],(function(t,e,i,s,o,n,a,l,r,c,_,h){"use strict";const p=128;return function(c){function _(t,l,_){var h;if((h=c.call(this,t)||this)._minMaxZoom=a.i1616to32(Math.round(l*o.MIN_MAX_ZOOM_PRECISION_FACTOR),Math.round(_*o.MIN_MAX_ZOOM_PRECISION_FACTOR)),r.isFunction(t.color)){const e=(e,i,o)=>{const n=t.color(e,i,o);return n&&s.premultiplyAlphaRGBA(n)||0};h._dynamicPropertyMap.set("fillColor",e)}else{const e=t.color;h.fillColor=e&&s.premultiplyAlphaRGBA(e)||0}const p="CIMMarkerPlacementInsidePolygon"===t.cim.placement?.type&&t.cim.placement.shiftOddRows?2:1,f=t.height;if(r.isFunction(f)){const t=(t,e,i)=>f(t,e,i)*p;h._dynamicPropertyMap.set("_height",t)}else h._height=(f||0)*p;const u=t.offsetX;if(r.isFunction(u)){const t=(t,e,s)=>i.pt2px(u(t,e,s));h._dynamicPropertyMap.set("_offsetX",t)}else h._offsetX=i.pt2px(u||0);const y=t.offsetY;if(r.isFunction(y)){const t=(t,e,s)=>i.pt2px(-y(t,e,s));h._dynamicPropertyMap.set("_offsetY",t)}else h._offsetY=i.pt2px(-y||0);const m=t.scaleX;r.isFunction(m)?h._dynamicPropertyMap.set("_scaleX",m):h._scaleX=m||1;const d=t.angle;if(r.isFunction(d)){const t=(t,e,i)=>n.degToByte(d(t,e,i));h._dynamicPropertyMap.set("_angle",t)}else h._angle=n.degToByte(d)||0;if(e.isSome(t.effects)){const e=t.effects;r.isFunction(e)?h._dynamicPropertyMap.set("_effects",e):h._effects=e}return h._cimFillLayer=t,h._bitset=(t.colorLocked?o.BITSET_GENERIC_LOCK_COLOR:0)|(t.applyRandomOffset?o.BITSET_FILL_RANDOM_PATTERN_OFFSET:0)|(t.sampleAlphaOnly?o.BITSET_GENERIC_CONSIDER_ALPHA_ONLY:0)|(t.hasUnresolvedReplacementColor?o.BITSET_FILL_HAS_UNRESOLVED_REPLACEMENT_COLOR:0),h._fillMaterialKey=t.materialKey,h}return t._inheritsLoose(_,c),_.fromCIMFill=function(t,e){const[i,s]=r.getMinMaxZoom(t.scaleInfo,e);return new _(t,i,s)},_.prototype.bindFeature=function(t,e,s){const n=t.readLegacyFeature();this._dynamicPropertyMap.forEach(((t,i)=>{this[i]=t(n,e,s)}));const r=l.FillMaterialKey.load(this._fillMaterialKey),c=this._materialCache,_=(0,this._cimFillLayer.materialHash)(n,e,s),f=c.get(_);let u=null;if(f&&h.ok(f.spriteMosaicItem)&&(u=f.spriteMosaicItem),u){const{rect:t,width:e,height:s}=u,n=t.x+o.SPRITE_PADDING,l=t.y+o.SPRITE_PADDING,c=n+e,_=l+s;let h=Math.round(i.pt2px(this._height));h<=0&&(h=_-l);let f=Math.round(i.pt2px(this._height/s*e||0));f<=0&&(f=c-n);const y=this._scaleX,m=1;this.tl=a.i1616to32(n,l),this.br=a.i1616to32(c,_),this.aux21=a.i1616to32(f,h),this.aux22=a.i1616to32(this._offsetX,this._offsetY),this.aux3=a.i8888to32(y*p,m*p,this._angle,0),r.sdf=u.sdf,r.pattern=!0,r.textureBinding=u.textureBinding}else this.tl=0,this.br=0,this.aux21=0,this.aux22=0,this.aux3=0,r.sdf=!1,r.pattern=!1,r.textureBinding=0;this._materialKey=r.data},_}(c(_))}));
