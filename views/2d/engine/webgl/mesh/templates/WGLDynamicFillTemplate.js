/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/mathUtils","../../../../../../core/screenUtils","../../color","../../definitions","../../GeometryUtils","../../number","../../materialKey/MaterialKey","./util","./WGLBaseFillTemplate","./WGLDynamicMeshTemplate","../../util/Result"],(function(t,e,i,o,s,n,l,r,a,c,h,f){"use strict";const u=128;return function(c){function h(t,e,h){var f,p;if((p=c.call(this,t)||this)._minMaxZoom=l.i1616to32(Math.round(e*s.MIN_MAX_ZOOM_PRECISION_FACTOR),Math.round(h*s.MIN_MAX_ZOOM_PRECISION_FACTOR)),a.isFunction(t.color)){const e=(e,i,s)=>{const n=t.color(e,i,s);return n&&o.premultiplyAlphaRGBA(n)||0};p._dynamicPropertyMap.set("fillColor",e)}else{const e=t.color;p.fillColor=e&&o.premultiplyAlphaRGBA(e)||0}let _=0;a.isFunction(t.height)||(_=t.height||0);const y="CIMMarkerPlacementInsidePolygon"===(null==(f=t.cim.placement)?void 0:f.type)&&t.cim.placement.shiftOddRows?2:1,m=(e,i,o)=>a.isFunction(t.height)?t.height(e,i,o)*y:_*y;p._dynamicPropertyMap.set("_height",m);let d=0;a.isFunction(t.offsetX)||(d=i.pt2px(t.offsetX||0)+u,d>255&&(d=255));const M=(e,o,s)=>{if(a.isFunction(t.offsetX)){let n=i.pt2px(t.offsetX(e,o,s))+u;return n>255&&(n=255),n}return d};p._dynamicPropertyMap.set("_offsetX",M);let g=1;a.isFunction(t.scaleX)||(g=t.scaleX||1);const x=(e,i,o)=>a.isFunction(t.scaleX)?t.scaleX(e,i,o):g;p._dynamicPropertyMap.set("_scaleX",x);let F=0;a.isFunction(t.offsetY)||(F=i.pt2px(-t.offsetY||0)+u,F>255&&(F=255));const P=(e,o,s)=>{if(a.isFunction(t.offsetY)){let n=i.pt2px(-t.offsetY(e,o,s))+u;return n>255&&(n=255),n}return F};p._dynamicPropertyMap.set("_offsetY",P);let I=0;a.isFunction(t.angle)||(I=n.radToByte(t.angle)||0);const X=(e,i,o)=>a.isFunction(t.angle)?n.radToByte(t.angle(e,i,o)):I;return p._dynamicPropertyMap.set("_angle",X),p._effects=t.effects,p._cimFillLayer=t,p._fillMaterialKey=r.FillMaterialKey.load(t.materialKey),p}return t._inheritsLoose(h,c),h.fromCIMFill=function(t,e){const[i,o]=a.getMinMaxZoom(t.scaleInfo,e);return new h(t,i,o)},h.prototype.bindFeature=function(t,o,n){const r=t.readLegacyFeature();this._dynamicPropertyMap.forEach(((t,e)=>{this[e]=t(r,o,n)}));const a=this._fillMaterialKey,c=this._materialCache,h=this._cimFillLayer;this.aux3=l.i8888to32(0,0,this._angle,h.colorLocked?1:0);const p=(0,h.materialHash)(r,o,n),_=c.get(p);let y=null;if(_&&f.ok(_.spriteMosaicItem)&&(y=_.spriteMosaicItem),y){const{rect:t,width:o,height:n}=y,r=t.x+s.SPRITE_PADDING,c=t.y+s.SPRITE_PADDING,h=r+o,f=c+n;let p=e.nextHighestPowerOfTwo(i.pt2px(this._height));p>255?p=255:p<=0&&(p=e.nextHighestPowerOfTwo(f-c));let _=e.nextHighestPowerOfTwo(i.pt2px(this._height/n*o||0));_>255?_=255:_<=0&&(_=e.nextHighestPowerOfTwo(h-r));const m=this._scaleX,d=1;this.tl=l.i1616to32(r,c),this.br=l.i1616to32(h,f),this.aux1=l.i8888to32(_,p,this._offsetX,this._offsetY),this.aux2=l.i1616to32(u*m,u*d),a.sdf=y.sdf,a.pattern=!0,a.textureBinding=y.textureBinding}else this.tl=0,this.br=0,this.aux1=0,this.aux2=0,a.sdf=!1,a.pattern=!1,a.textureBinding=0;this._materialKey=a.data},h}(c(h))}));
