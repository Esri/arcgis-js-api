/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/mathUtils","../../../../../../core/screenUtils","../../definitions","../../number","../../materialKey/MaterialKey","../../color","../../GeometryUtils","../../util/Result","./util","./WGLBaseFillTemplate","./WGLDynamicMeshTemplate"],(function(t,e,i,s,n,o,l,r,a,c,h,f){"use strict";const u=128;return function(h){function f(t){var e,s;if(s=h.call(this,t)||this,c.isFunction(t.color)){const e=(e,i,s)=>{const n=t.color(e,i,s);return n&&l.premultiplyAlphaRGBA(n)||0};s._dynamicPropertyMap.set("_fillColor",e)}else{const e=t.color;s.fillColor=e&&l.premultiplyAlphaRGBA(e)||0}let n=0;c.isFunction(t.height)||(n=t.height||0);const a="CIMMarkerPlacementInsidePolygon"===(null==(e=t.cim.placement)?void 0:e.type)&&t.cim.placement.shiftOddRows?2:1,f=(e,i,s)=>c.isFunction(t.height)?t.height(e,i,s)*a:n*a;s._dynamicPropertyMap.set("_height",f);let p=0;c.isFunction(t.offsetX)||(p=i.pt2px(t.offsetX||0)+u,p>255&&(p=255));const y=(e,s,n)=>{if(c.isFunction(t.offsetX)){let o=i.pt2px(t.offsetX(e,s,n))+u;return o>255&&(o=255),o}return p};s._dynamicPropertyMap.set("_offsetX",y);let m=1;c.isFunction(t.scaleX)||(m=t.scaleX||1);const _=(e,i,s)=>c.isFunction(t.scaleX)?t.scaleX(e,i,s):m;s._dynamicPropertyMap.set("_scaleX",_);let d=0;c.isFunction(t.offsetY)||(d=i.pt2px(-t.offsetY||0)+u,d>255&&(d=255));const g=(e,s,n)=>{if(c.isFunction(t.offsetY)){let o=i.pt2px(-t.offsetY(e,s,n))+u;return o>255&&(o=255),o}return d};s._dynamicPropertyMap.set("_offsetY",g);let x=0;c.isFunction(t.angle)||(x=r.radToByte(t.angle)||0);const F=(e,i,s)=>c.isFunction(t.angle)?r.radToByte(t.angle(e,i,s)):x;return s._dynamicPropertyMap.set("_angle",F),s._effects=t.effects,s._cimFillLayer=t,s._fillMaterialKey=o.FillMaterialKey.load(t.materialKey),s}return t._inheritsLoose(f,h),f.fromCIMFill=function(t){return new f(t)},f.prototype.bindFeature=function(t,o,l){const r=t.readLegacyFeature();this._dynamicPropertyMap.forEach(((t,e)=>{this[e]=t(r,o,l)}));const c=this._fillMaterialKey,h=this._materialCache,f=this._cimFillLayer;this.aux3=n.i8888to32(0,0,this._angle,f.colorLocked?1:0);const p=(0,f.materialHash)(r,o,l),y=h.get(p);let m=null;if(y&&a.ok(y.spriteMosaicItem)&&(m=y.spriteMosaicItem),m){const{rect:t,width:o,height:l}=m,r=t.x+s.SPRITE_PADDING,a=t.y+s.SPRITE_PADDING,h=r+o,f=a+l;let p=e.nextHighestPowerOfTwo(i.pt2px(this._height));p>255?p=255:p<=0&&(p=e.nextHighestPowerOfTwo(f-a));let y=e.nextHighestPowerOfTwo(i.pt2px(this._height/l*o||0));y>255?y=255:y<=0&&(y=e.nextHighestPowerOfTwo(h-r));const _=this._scaleX,d=1;this.tl=n.i1616to32(r,a),this.br=n.i1616to32(h,f),this.aux1=n.i8888to32(y,p,this._offsetX,this._offsetY),this.aux2=n.i1616to32(u*_,u*d),c.sdf=m.sdf,c.pattern=!0,c.textureBinding=m.textureBinding}else this.tl=0,this.br=0,this.aux1=0,this.aux2=0,c.sdf=!1,c.pattern=!1,c.textureBinding=0;this._materialKey=c.data},f}(h(f))}));
