/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/maybe","../../../../../../core/screenUtils","../../color","../../definitions","../../GeometryUtils","../../number","../../materialKey/MaterialKey","./util","./WGLBaseFillTemplate","./WGLDynamicMeshTemplate","../../util/Result"],(function(t,e,i,s,n,o,l,a,r,c,f,h){"use strict";const p=128;return function(c){function f(t,f,h){var _,u;if((u=c.call(this,t)||this)._minMaxZoom=l.i1616to32(Math.round(f*n.MIN_MAX_ZOOM_PRECISION_FACTOR),Math.round(h*n.MIN_MAX_ZOOM_PRECISION_FACTOR)),r.isFunction(t.color)){const e=(e,i,n)=>{const o=t.color(e,i,n);return o&&s.premultiplyAlphaRGBA(o)||0};u._dynamicPropertyMap.set("fillColor",e)}else{const e=t.color;u.fillColor=e&&s.premultiplyAlphaRGBA(e)||0}const y="CIMMarkerPlacementInsidePolygon"===(null==(_=t.cim.placement)?void 0:_.type)&&t.cim.placement.shiftOddRows?2:1,m=t.height;if(r.isFunction(m)){const t=(t,e,i)=>m(t,e,i)*y;u._dynamicPropertyMap.set("_height",t)}else u._height=(m||0)*y;const d=t.offsetX;if(r.isFunction(d)){const t=(t,e,s)=>{let n=i.pt2px(d(t,e,s))+p;return n>255?n=255:n<0&&(n=0),n};u._dynamicPropertyMap.set("_offsetX",t)}else{let t=i.pt2px(d||0)+p;t>255?t=255:t<0&&(t=0),u._offsetX=t}const M=t.offsetY;if(r.isFunction(M)){const t=(t,e,s)=>{let n=i.pt2px(-M(t,e,s))+p;return n>255?n=255:n<0&&(n=0),n};u._dynamicPropertyMap.set("_offsetY",t)}else{let t=i.pt2px(-M||0)+p;t>255?t=255:t<0&&(t=0),u._offsetY=t}const g=t.scaleX;r.isFunction(g)?u._dynamicPropertyMap.set("_scaleX",g):u._scaleX=g||1;const P=t.angle;if(r.isFunction(P)){const t=(t,e,i)=>o.radToByte(P(t,e,i));u._dynamicPropertyMap.set("_angle",t)}else u._angle=o.radToByte(P)||0;if(e.isSome(t.effects)){const e=t.effects;r.isFunction(e)?u._dynamicPropertyMap.set("_effects",e):u._effects=e}return u._cimFillLayer=t,u._fillMaterialKey=a.FillMaterialKey.load(t.materialKey),u}return t._inheritsLoose(f,c),f.fromCIMFill=function(t,e){const[i,s]=r.getMinMaxZoom(t.scaleInfo,e);return new f(t,i,s)},f.prototype.bindFeature=function(t,e,s){const o=t.readLegacyFeature();this._dynamicPropertyMap.forEach(((t,i)=>{this[i]=t(o,e,s)}));const a=this._fillMaterialKey,r=this._materialCache,c=(0,this._cimFillLayer.materialHash)(o,e,s),f=r.get(c);let p=null;if(f&&h.ok(f.spriteMosaicItem)&&(p=f.spriteMosaicItem),p){const{rect:t,width:e,height:s}=p,o=t.x+n.SPRITE_PADDING,r=t.y+n.SPRITE_PADDING,c=o+e,f=r+s;let h=Math.round(i.pt2px(this._height));h>255?h=255:h<=0&&(h=f-r);let _=Math.round(i.pt2px(this._height/s*e||0));_>255?_=255:_<=0&&(_=c-o);const u=this._scaleX,y=1;this.tl=l.i1616to32(o,r),this.br=l.i1616to32(c,f),this.aux2=l.i8888to32(_,h,this._offsetX,this._offsetY),this.aux3=l.i8888to32(u,y,this._angle,0),a.sdf=p.sdf,a.pattern=!0,a.textureBinding=p.textureBinding}else this.tl=0,this.br=0,this.aux2=0,this.aux3=0,a.sdf=!1,a.pattern=!1,a.textureBinding=0;this._materialKey=a.data},f}(c(f))}));
