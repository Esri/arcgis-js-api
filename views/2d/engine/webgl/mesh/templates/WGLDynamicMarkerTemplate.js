/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/Error","../../../../../../core/Logger","../../../../../../core/maybe","../../../../../../core/screenUtils","../../../../../../chunks/mat2df32","../../../../../../chunks/vec2f32","../../../../../../symbols/cim/enums","../../color","../../definitions","../../number","../../materialKey/MaterialKey","./util","./WGLBaseMarkerTemplate","./WGLDynamicMeshTemplate","../../util/Result"],(function(t,e,i,s,r,a,o,n,c,h,l,p,_,m,f,y){"use strict";const u=o.create(),M=a.create();return function(a){function o(t,e,i){var o;(o=a.call(this,t)||this)._cimMarkerLayer=t,o._minMaxZoom=l.i1616to32(Math.round(e*h.MIN_MAX_ZOOM_PRECISION_FACTOR),Math.round(i*h.MIN_MAX_ZOOM_PRECISION_FACTOR));const p=t.color;if(_.isFunction(p)){const t=(t,e,i)=>c.premultiplyAlphaRGBA(p(t,e,i));o._dynamicPropertyMap.set("_fillColor",t)}else o._fillColor=c.premultiplyAlphaRGBA(p);const m=t.outlineColor;if(_.isFunction(m)){const t=(t,e,i)=>c.premultiplyAlphaRGBA(m(t,e,i));o._dynamicPropertyMap.set("_outlineColor",t)}else o._outlineColor=c.premultiplyAlphaRGBA(m);const f=t.size;if(_.isFunction(f)){const t=(t,e,i)=>r.pt2px(f(t,e,i));o._dynamicPropertyMap.set("_size",t)}else o._size=r.pt2px(f)||0;const y=t.scaleX;_.isFunction(y)?o._dynamicPropertyMap.set("_scaleX",y):o._scaleX=y;const u=t.offsetX;if(_.isFunction(u)){const t=(t,e,i)=>r.pt2px(u(t,e,i));o._dynamicPropertyMap.set("xOffset",t)}else o.xOffset=r.pt2px(u)||0;const M=t.offsetY;if(_.isFunction(M)){const t=(t,e,i)=>r.pt2px(M(t,e,i));o._dynamicPropertyMap.set("yOffset",t)}else o.yOffset=r.pt2px(M)||0;const d=t.outlineWidth;if(_.isFunction(d)){const t=(t,e,i)=>r.pt2px(d(t,e,i));o._dynamicPropertyMap.set("_outlineWidth",t)}else o._outlineWidth=r.pt2px(d)||0;const g=t.rotation;if(_.isFunction(g)?o._dynamicPropertyMap.set("_angle",g):o._angle=g||0,s.isSome(t.effects)){const e=t.effects;_.isFunction(e)?o._dynamicPropertyMap.set("_effects",e):o._effects=e}if(s.isSome(t.markerPlacement)){const e=t.markerPlacement;_.isFunction(e)?o._dynamicPropertyMap.set("_markerPlacement",e):o._markerPlacement=e}return o._scaleFactor=s.unwrapOr(t.scaleFactor,1),o._bitSet=(t.alignment===n.Alignment.MAP?1:0)|(t.colorLocked?1:0)<<1|(t.scaleSymbolsProportionally?1:0)<<3,o._materialKey=t.materialKey,o}return t._inheritsLoose(o,a),o.fromCIMMarker=function(t,e){const[i,s]=_.getMinMaxZoom(t.scaleInfo,e);return new o(t,i,s)},o.prototype.bindFeature=function(t,s,a){const o=t.readLegacyFeature(),n=t.getObjectId();this._dynamicPropertyMap.forEach(((t,e)=>{this[e]=t(o,s,a)}));const c=this._cimMarkerLayer.materialHash,_="function"==typeof c?c(o,s,a,n):c,m=this._materialCache.get(_);if(!m||!y.ok(m.spriteMosaicItem)||!m.spriteMosaicItem)return void i.getLogger("esri.views.2d.engine.webgl.WGLDynamicMarkerTemplate").error(new e("mapview-cim","Encountered an error when binding feature"));const f=m.spriteMosaicItem,d=this._cimMarkerLayer.sizeRatio,g=f.width/f.height*this._scaleX,x=this._cimMarkerLayer.rotateClockwise?this._angle:-this._angle;let P=this._size,k=P*g;const O=this.xOffset,F=this.yOffset;this.xOffset*=this._scaleFactor,this.yOffset*=this._scaleFactor;const L=this._cimMarkerLayer.scaleSymbolsProportionally&&this._cimMarkerLayer.frameHeight?this._size/r.pt2px(this._cimMarkerLayer.frameHeight):1,A=this._outlineWidth*L,I=r.pt2px(this._cimMarkerLayer.referenceSize);let R=0,b=0;const w=this._cimMarkerLayer.anchorPoint;w&&(this._cimMarkerLayer.isAbsoluteAnchorPoint?this._size&&(R=r.pt2px(w.x)/(this._size*g),b=r.pt2px(w.y)/this._size):(R=w.x,b=w.y)),this._anchorX=R,this._anchorY=b,this._sizeOutlineWidth=l.i8888to32(Math.round(Math.min(Math.sqrt(128*k),255)),Math.round(Math.min(Math.sqrt(128*P),255)),Math.round(Math.min(Math.sqrt(128*A),255)),Math.round(Math.min(Math.sqrt(128*I),255))),this.angle=x;const C=Math.round(64*d);this._bitestAndDistRatio=l.i1616to32(this._bitSet,C);const z=f.rect.x+h.SPRITE_PADDING,S=f.rect.y+h.SPRITE_PADDING,B=z+f.width,G=S+f.height;this._texUpperLeft=l.i1616to32(z,S),this._texUpperRight=l.i1616to32(B,S),this._texBottomLeft=l.i1616to32(z,G),this._texBottomRight=l.i1616to32(B,G);const W=p.MarkerMaterialKey.load(this._materialKey);W.sdf=f.sdf,W.pattern=!0,W.textureBinding=f.textureBinding,this._materialKey=W.data,k*=d,P*=d,k*=this._scaleFactor,P*=this._scaleFactor,k*=f.rect.width/f.width,P*=f.rect.height/f.height,this._computedWidth=k,this._computedHeight=P,this._applyTransformation(M,u),this.xOffset=O,this.yOffset=F},o}(m(f))}));
