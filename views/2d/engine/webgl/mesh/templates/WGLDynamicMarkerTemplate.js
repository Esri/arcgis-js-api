/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/Error","../../../../../../core/Logger","../../../../../../core/maybe","../../../../../../core/screenUtils","../../../../../../chunks/mat2df32","../../../../../../chunks/vec2f32","../../color","../../definitions","../../number","../../materialKey/MaterialKey","./util","./WGLBaseMarkerTemplate","./WGLDynamicMeshTemplate","../../util/Result"],(function(t,e,i,r,s,o,a,n,c,h,l,_,p,f,m){"use strict";const u=a.create(),y=o.create(),M=i.getLogger("esri.views.2d.engine.webgl.WGLDynamicMarkerTemplate");return function(i){function o(t,e,o){var a;if((a=i.call(this,t)||this)._cimMarkerLayer=t,a._minMaxZoom=h.i1616to32(Math.round(e*c.MIN_MAX_ZOOM_PRECISION_FACTOR),Math.round(o*c.MIN_MAX_ZOOM_PRECISION_FACTOR)),_.isFunction(t.color)){const e=(e,i,r)=>n.premultiplyAlphaRGBA(t.color(e,i,r));a._dynamicPropertyMap.set("_fillColor",e)}else a._fillColor=n.premultiplyAlphaRGBA(t.color);if(_.isFunction(t.outlineColor)){const e=(e,i,r)=>n.premultiplyAlphaRGBA(t.outlineColor(e,i,r));a._dynamicPropertyMap.set("_outlineColor",e)}else a._outlineColor=n.premultiplyAlphaRGBA(t.outlineColor);if(_.isFunction(t.size)){const e=(e,i,r)=>s.pt2px(t.size(e,i,r));a._dynamicPropertyMap.set("_size",e)}else a._size=s.pt2px(t.size)||0;if(_.isFunction(t.scaleX)?a._dynamicPropertyMap.set("_scaleX",t.scaleX):a._scaleX=t.scaleX||1,_.isFunction(t.offsetX)){const e=(e,i,r)=>s.pt2px(t.offsetX(e,i,r));a._dynamicPropertyMap.set("xOffset",e)}else a.xOffset=s.pt2px(t.offsetX)||0;if(_.isFunction(t.offsetY)){const e=(e,i,r)=>s.pt2px(t.offsetY(e,i,r));a._dynamicPropertyMap.set("yOffset",e)}else a.yOffset=s.pt2px(t.offsetY)||0;if(_.isFunction(t.outlineWidth)){const e=(e,i,r)=>s.pt2px(t.outlineWidth(e,i,r));a._dynamicPropertyMap.set("_outlineWidth",e)}else a._outlineWidth=s.pt2px(t.outlineWidth)||0;return _.isFunction(t.rotation)?a._dynamicPropertyMap.set("_angle",t.rotation):a._angle=t.rotation||0,a._scaleFactor=r.unwrapOr(t.scaleFactor,1),a._markerPlacement=t.markerPlacement,a._effects=t.effects,a._bitSet=(1===t.alignment?1:0)|(t.colorLocked?1:0)<<1|(t.scaleSymbolsProportionally?1:0)<<3,a._materialKey=t.materialKey,a}return t._inheritsLoose(o,i),o.fromCIMMarker=function(t,e){const[i,r]=_.getMinMaxZoom(t.scaleInfo,e);return new o(t,i,r)},o.prototype.bindFeature=function(t,i,r){const o=t.readLegacyFeature();this._dynamicPropertyMap.forEach(((t,e)=>{this[e]=t(o,i,r)}));const a=this._cimMarkerLayer.materialHash,n="function"==typeof a?a(o,i,r):a,_=this._materialCache.get(n);if(!_||!m.ok(_.spriteMosaicItem)||!_.spriteMosaicItem)return void M.error(new e("mapview-cim","Encountered an error when binding feature"));const p=_.spriteMosaicItem,f=this._cimMarkerLayer.sizeRatio,d=p.width/p.height*this._scaleX,g=this._cimMarkerLayer.rotateClockwise?this._angle:-this._angle;let x=this._size,k=x*d;const P=this.xOffset,L=this.yOffset;this.xOffset*=this._scaleFactor,this.yOffset*=this._scaleFactor;const O=this._cimMarkerLayer.scaleSymbolsProportionally&&this._cimMarkerLayer.frameHeight?this._size/s.pt2px(this._cimMarkerLayer.frameHeight):1,F=this._outlineWidth*O,A=s.pt2px(this._cimMarkerLayer.referenceSize);let I=0,R=0;const w=this._cimMarkerLayer.anchorPoint;w&&(this._cimMarkerLayer.isAbsoluteAnchorPoint?this._size&&(I=-w.x/(this._size*d),R=w.y/this._size):(I=w.x,R=w.y)),this._sizeOutlineWidth=h.i8888to32(Math.round(Math.min(Math.sqrt(128*k),255)),Math.round(Math.min(Math.sqrt(128*x),255)),Math.round(Math.min(Math.sqrt(128*F),255)),Math.round(Math.min(Math.sqrt(128*A),255))),this.angle=g;const C=Math.round(64*f);this._bitestAndDistRatio=h.i1616to32(this._bitSet,C);const z=p.rect.x+c.SPRITE_PADDING,b=p.rect.y+c.SPRITE_PADDING,X=z+p.width,W=b+p.height;this._texUpperLeft=h.i1616to32(z,b),this._texUpperRight=h.i1616to32(X,b),this._texBottomLeft=h.i1616to32(z,W),this._texBottomRight=h.i1616to32(X,W);const B=l.MarkerMaterialKey.load(this._materialKey);B.sdf=p.sdf,B.pattern=!0,B.textureBinding=p.textureBinding,this._materialKey=B.data,this._anchorX=.5-(.5+I)*p.width/p.width,this._anchorY=.5-(.5+R)*p.height/p.height,k*=f,x*=f,k*=this._scaleFactor,x*=this._scaleFactor,k*=p.rect.width/p.width,x*=p.rect.height/p.height,this._computedWidth=k,this._computedHeight=x,this._applyTransformation(y,u),this.xOffset=P,this.yOffset=L},o}(p(f))}));
