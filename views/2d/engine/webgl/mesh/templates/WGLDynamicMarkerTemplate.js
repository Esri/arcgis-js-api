/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/maybe","../../../../../../core/Logger","../../../../../../core/Error","../../../../../../core/screenUtils","../../definitions","../../../../../../chunks/mat2df32","../../../../../../chunks/vec2f32","../../number","../../materialKey/MaterialKey","../../color","../../util/Result","./util","./WGLBaseMarkerTemplate","./WGLDynamicMeshTemplate"],(function(t,e,i,r,s,o,a,n,c,h,l,p,_,f,m){"use strict";const u=n.create(),y=a.create(),d=i.getLogger("esri.views.2d.engine.webgl.WGLDynamicMarkerTemplate");return function(i){function a(t){var r;if((r=i.call(this,t)||this)._cimMarkerLayer=t,_.isFunction(t.color)){const e=(e,i,r)=>l.premultiplyAlphaRGBA(t.color(e,i,r));r._dynamicPropertyMap.set("_fillColor",e)}else r._fillColor=l.premultiplyAlphaRGBA(t.color);if(_.isFunction(t.outlineColor)){const e=(e,i,r)=>l.premultiplyAlphaRGBA(t.outlineColor(e,i,r));r._dynamicPropertyMap.set("_outlineColor",e)}else r._outlineColor=l.premultiplyAlphaRGBA(t.outlineColor);if(_.isFunction(t.size)){const e=(e,i,r)=>s.pt2px(t.size(e,i,r));r._dynamicPropertyMap.set("_size",e)}else r._size=s.pt2px(t.size);if(_.isFunction(t.scaleX)?r._dynamicPropertyMap.set("_scaleX",t.scaleX):r._scaleX=t.scaleX,_.isFunction(t.offsetX)){const e=(e,i,r)=>s.pt2px(t.offsetX(e,i,r));r._dynamicPropertyMap.set("xOffset",e)}else r.xOffset=s.pt2px(t.offsetX);if(_.isFunction(t.offsetY)){const e=(e,i,r)=>s.pt2px(t.offsetY(e,i,r));r._dynamicPropertyMap.set("yOffset",e)}else r.yOffset=s.pt2px(t.offsetY);if(_.isFunction(t.outlineWidth)){const e=(e,i,r)=>s.pt2px(t.outlineWidth(e,i,r));r._dynamicPropertyMap.set("_outlineWidth",e)}else r._outlineWidth=s.pt2px(t.outlineWidth);return _.isFunction(t.rotation)?r._dynamicPropertyMap.set("_angle",t.rotation):r._angle=t.rotation,r._scaleFactor=e.unwrapOr(t.scaleFactor,1),r._markerPlacement=t.markerPlacement,r._effects=t.effects,r._bitSet=(1===t.alignment?1:0)|(t.colorLocked?1:0)<<1|(t.scaleSymbolsProportionally?1:0)<<3,r._materialKey=t.materialKey,r}return t._inheritsLoose(a,i),a.fromCIMMarker=function(t){return new a(t)},a.prototype.bindFeature=function(t,e,i){const a=t.readLegacyFeature();this._dynamicPropertyMap.forEach(((t,r)=>{this[r]=t(a,e,i)}));const n=this._cimMarkerLayer.materialHash,l="function"==typeof n?n(a,e,i):n,_=this._materialCache.get(l);if(!_||!p.ok(_.spriteMosaicItem)||!_.spriteMosaicItem)return void d.error(new r("mapview-cim","Encountered an error when binding feature"));const f=_.spriteMosaicItem,m=this._cimMarkerLayer.sizeRatio,M=f.width/f.height*this._scaleX,g=this._cimMarkerLayer.rotateClockwise?this._angle:-this._angle;let x=this._size,k=x*M;const L=this.xOffset,P=this.yOffset;this.xOffset*=this._scaleFactor,this.yOffset*=this._scaleFactor;const F=this._cimMarkerLayer.scaleSymbolsProportionally&&this._cimMarkerLayer.frameHeight?this._size/s.pt2px(this._cimMarkerLayer.frameHeight):1,w=this._outlineWidth*F,z=s.pt2px(this._cimMarkerLayer.referenceSize);let A=0,b=0;const O=this._cimMarkerLayer.anchorPoint;O&&(this._cimMarkerLayer.isAbsoluteAnchorPoint?this._size&&(A=-O.x/(this._size*M),b=O.y/this._size):(A=O.x,b=O.y)),this._sizeOutlineWidth=c.i8888to32(Math.round(Math.min(Math.sqrt(128*k),255)),Math.round(Math.min(Math.sqrt(128*x),255)),Math.round(Math.min(Math.sqrt(128*w),255)),Math.round(Math.min(Math.sqrt(128*z),255))),this.angle=g;const R=Math.round(64*m);this._bitestAndDistRatio=c.i1616to32(this._bitSet,R);const W=f.rect.x+o.SPRITE_PADDING,B=f.rect.y+o.SPRITE_PADDING,C=W+f.width,X=B+f.height;this._texUpperLeft=c.i1616to32(W,B),this._texUpperRight=c.i1616to32(C,B),this._texBottomLeft=c.i1616to32(W,X),this._texBottomRight=c.i1616to32(C,X);const G=h.MarkerMaterialKey.load(this._materialKey);G.sdf=f.sdf,G.pattern=!0,G.textureBinding=f.textureBinding,this._materialKey=G.data,this._anchorX=.5-(.5+A)*f.width/f.width,this._anchorY=.5-(.5+b)*f.height/f.height,k*=m,x*=m,k*=this._scaleFactor,x*=this._scaleFactor,k*=f.rect.width/f.width,x*=f.rect.height/f.height,this._computedWidth=k,this._computedHeight=x,this._applyTransformation(y,u),this.xOffset=L,this.yOffset=P},a}(f(m))}));
