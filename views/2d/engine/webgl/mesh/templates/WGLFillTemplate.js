// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../../../../core/tsSupport/extendsHelper","../../../../../../core/Logger","../../../../../../core/screenUtils","../../../../../../core/libs/earcut/earcut","../../color","../../definitions","../../enums","../../number","../../TileClipper","../../WGLDisplayRecord","../../materialKey/MaterialKey","../Tesselator","./WGLMeshTemplate"],function(e,t,r,i,_,d,m,y,f,T,g,P,v,c,o){Object.defineProperty(t,"__esModule",{value:!0});var p=i.getLogger("esri.views.2d.engine.webgl.mesh.templates.WGLFillTemplate"),M=[],I=[],C=128;var s=function(u){function w(e,t,r,i,o,s,n,a,l){var h=u.call(this)||this;h.fillColor=r,h.tl=i,h.br=o,h.aux1=s,h.aux2=n,h.aux3=a,h.isBFS=l,h.geometryType=f.WGLGeometryType.FILL,h.forceLibtess=!1;var p=v.FillMaterialKey.load(v.createMaterialKey(h.geometryType,e,!1));return t&&(p.sdf=t.sdf,p.pattern=!0,p.textureBinding=t.textureBinding),h._materialKey=p.data,h._tesselator=new c.default,h._tileClipper=new g.TileClipper(0,0,0,1,8),h._tileClipper.setExtent(y.TILE_SIZE),h}return r(w,u),w.fromCIMFill=function(e,t,r,i){void 0===i&&(i=!1);var o=t.color,s=o&&m.premultiplyAlphaRGBA(o)||0,n=T.i8888to32(0,0,0,t.colorLocked?1:0);if(!r)return new w(e,null,s,0,0,0,0,n,i);var a=r.rect,l=r.width,h=r.height,p=a.x+1,u=a.y+1,f=p+l,d=u+h,g=T.nextHighestPowerOfTwo(_.pt2px(t.height||0));255<g?g=255:g<=0&&(g=T.nextHighestPowerOfTwo(d-u));var v=T.nextHighestPowerOfTwo(_.pt2px(t.height/h*l||0));255<v?v=255:v<=0&&(v=T.nextHighestPowerOfTwo(f-p));var c=_.pt2px(t.offsetX||0)+C;255<c&&(c=255);var x=_.pt2px(-t.offsetY||0)+C;255<x&&(x=255);var y=t.scaleX||1;return new w(e,r,s,T.i1616to32(p,u),T.i1616to32(f,d),T.i8888to32(v,g,c,x),T.i1616to32(C*y,128),0,i)},w.fromSimpleFill=function(e,t,r,i){void 0===i&&(i=!1);var o=t.color,s=o&&"none"!==t.style&&m.premultiplyAlphaRGBA(o)||0,n=T.i8888to32(0,0,0,i?255:0);if(!r)return new w(e,null,s,0,0,0,0,n,i);var a=r.rect,l=r.width,h=r.height,p=a.x+1,u=a.y+1,f=a.x+1+l,d=a.y+1+h;return new w(e,r,s,T.i1616to32(p,u),T.i1616to32(f,d),T.i8888to32(T.nextHighestPowerOfTwo(f-p),T.nextHighestPowerOfTwo(d-u),0,0),T.i1616to32(C,C),n,i)},w.fromPictureFill=function(e,t,r,i){void 0===i&&(i=!1);var o=y.PICTURE_FILL_COLOR,s=r.rect,n=r.width,a=r.height,l=s.x+1,h=s.y+1,p=l+n,u=h+a,f=T.i1616to32(l,h),d=T.i1616to32(p,u),g=T.nextHighestPowerOfTwo(_.pt2px(t.width));255<g&&(g=255);var v=T.nextHighestPowerOfTwo(_.pt2px(t.height));255<v&&(v=255);var c=_.pt2px(t.xoffset)+C;255<c&&(c=255);var x=_.pt2px(-t.yoffset)+C;return 255<x&&(x=255),new w(e,r,o,f,d,T.i8888to32(g,v,c,x),T.i1616to32(C*t.xscale,C*t.yscale),T.i8888to32(0,0,0,i?255:0),i)},w.prototype.writeMesh=function(e,t,r,i,o){if(M.length=0,"esriGeometryPolygon"===r){var s=o.geometry,n=v.FillMaterialKey.load(this._materialKey),a=this._isClippingRequired(s),l=a?this._clip(s,!1):s.rings,h=n.dotDensity?function(e){for(var t=0,r=0;r<e.length;r++)for(var i=e[r],o=i[0],s=o[0],n=o[1],a=1;a<i.length;a++){var l=i[a],h=s+l[0],p=n+l[1];t-=(h-s)*(p+n)/2,s=h,n=p}return t}(s.rings):0;this.forceLibtess?this._writeMeshLibtess(e,t,i,l,a,n,h):this._writeMeshEarcut(e,t,i,l,a,n,h)||this._writeMeshLibtess(e,t,i,l,a,n,h)}else p.error("Unable to handle geometryType: "+r)},w.prototype._isClippingRequired=function(e){for(var t=y.TILE_SIZE+8,r=0,i=e.rings;r<i.length;r++){var o=i[r],s=o.length;if(!(s<3)){var n=o[0][0],a=o[0][1];if(n<-8||t<n||a<-8||t<a)return!0;for(var l=1;l<s;++l)if(n+=o[l][0],a+=o[l][1],n<-8||t<n||a<-8||t<a)return!0}}return!1},w.prototype._clip=function(e,t){var r,i;this._tileClipper.reset(3);for(var o=0,s=e.rings;o<s.length;o++){var n=s[o],a=n.length;if(!(a<3)){r=n[0][0],i=n[0][1],this._tileClipper.moveTo(r,i);for(var l=1;l<a;++l)r+=n[l][0],i+=n[l][1],this._tileClipper.lineTo(r,i);this._tileClipper.close()}}return this._tileClipper.result(t)},w.prototype._writeMeshLibtess=function(e,t,r,i,o,s,n){if(i&&i.length){var a=[],l=t.indexVector,h=t.getVector("geometry"),p=new P(r,this.geometryType,this._materialKey),u=h.vertexCount;p.vertexFrom=u,p.indexFrom=l.length,this._tesselator.beginPolygon(M,a);for(var f=0,d=i;f<d.length;f++){var g=d[f];if(!(g.length<3)){this._tesselator.beginContour();var v=void 0,c=void 0;c=o?(v=g[0].x,g[0].y):(v=g[0][0],g[0][1]);var x=[v,c,0];this._tesselator.addVertex(x,x);for(var y=1;y<g.length-1;y++){o?(v=g[y].x,c=g[y].y):(v+=g[y][0],c+=g[y][1]);var w=[v,c,0];this._tesselator.addVertex(w,w)}this._tesselator.endContour()}}this._tesselator.endPolygon(),this._writeVerticesLibTess(p,h,r,M,s,n),this._writeIndicesLibTess(p,l,u,a),0<p.indexCount&&e.push(p)}},w.prototype._writeMeshEarcut=function(e,t,r,i,o,s,n){if(i&&i.length){var a=t.indexVector,l=t.getVector("geometry"),h=new P(r,this.geometryType,this._materialKey),p=l.vertexCount,u=a.length,f=l.data.length;h.vertexFrom=p,h.indexFrom=a.length;for(var d=0,g=0,v=0,c=i;v<c.length;v++){var x=c[v],y=g,w=void 0,_=void 0;_=o?(w=x[0].x,x[0].y):(w=x[0][0],x[0][1]),M[g++]=w,M[g++]=_;for(var m=0,T=1;T<x.length;++T){var C=void 0,L=void 0;if(o){var b=w,F=_;C=(w=x[T].x)-b,L=(_=x[T].y)-F}else w+=C=x[T][0],_+=L=x[T][1];m-=C*(_+_-L),M[g++]=w,M[g++]=_}if(0<m){if(0<y-d){if(!this._write(h,a,l,r,M,I,d,y,s,n))return a.seek(u),l.data.seek(f),M.length=I.length=0,!1;d=y}I.length=0}else m<0&&0<y-d?I.push(.5*(y-d)):g=y}return 0<g-d&&!this._write(h,a,l,r,M,I,d,g,s,n)?(a.seek(u),l.data.seek(f),M.length=I.length=0,!1):(M.length=I.length=0,e.push(h),!0)}},w.prototype._write=function(e,t,r,i,o,s,n,a,l,h){var p=o.slice(n,a),u=d(p,s,2);if(d.deviation(p,s,2,u))return!1;if(u.length){var f=r.vertexCount;return this._writeVertices(e,r,i,p,l,h),this._writeIndices(e,t,f,u),!0}},w.prototype._writeVertices=function(e,t,r,i,o,s){for(var n=0;n<i.length;n+=2){var a=T.i1616to32(i[n],i[n+1]);t.data.push(a),t.data.push(r),o.dotDensity?t.data.writeF32(1/s):(t.data.push(this.fillColor),t.data.push(this.tl),t.data.push(this.br),t.data.push(this.aux1),t.data.push(this.aux2),t.data.push(this.aux3)),e.vertexCount++}},w.prototype._writeIndices=function(e,t,r,i){for(var o=r,s=0;s<i.length;s+=3)t.push(o+i[s]),t.push(o+i[s+1]),t.push(o+i[s+2]),e.indexCount+=3},w.prototype._writeVerticesLibTess=function(e,t,r,i,o,s){for(var n=0;n<i.length;n+=2){var a=T.i1616to32(i[n],i[n+1]);t.data.push(a),t.data.push(r),o.dotDensity?t.data.writeF32(1/s):(t.data.push(this.fillColor),t.data.push(this.tl),t.data.push(this.br),t.data.push(this.aux1),t.data.push(this.aux2),t.data.push(this.aux3)),e.vertexCount++}},w.prototype._writeIndicesLibTess=function(e,t,r,i){for(var o=r,s=0;s<i.length;s++)t.push(o+i[s]),e.indexCount++},w}(o.default);t.default=s});