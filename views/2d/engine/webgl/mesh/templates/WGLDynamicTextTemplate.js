/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/screenUtils","../../alignmentUtils","../../color","../../definitions","../../number","../../materialKey/MaterialKey","./util","./WGLBaseTextTemplate","./WGLDynamicMeshTemplate","../../../../layers/features/textUtils"],(function(t,e,i,n,o,a,s,r,l,c,_){"use strict";const h=5;function p(t,e,i,n){return"string"==typeof t.text?t.text:"function"==typeof t.text?t.text(e,i,n):""}let u=function(l){function c(t,i,c){var _;(_=l.call(this,t)||this)._horizontalAlignment="center",_._verticalAlignment="middle",_._textToGlyphs=new Map,_._minMaxZoom=a.i1616to32(Math.round(i*o.MIN_MAX_ZOOM_PRECISION_FACTOR),Math.round(c*o.MIN_MAX_ZOOM_PRECISION_FACTOR));const p=t.scaleFactor||1;if(_._cimTextLayer=t,r.isFunction(t.color)){const e=(e,i,o)=>n.premultiplyAlphaRGBA(t.color(e,i,o));_._dynamicPropertyMap.set("_color",e)}else _._color=n.premultiplyAlphaRGBA(t.color);if(r.isFunction(t.color)){const e=(e,i,o)=>n.premultiplyAlphaRGBA(t.outlineColor(e,i,o));_._dynamicPropertyMap.set("_haloColor",e)}else _._haloColor=n.premultiplyAlphaRGBA(t.outlineColor);let u;r.isFunction(t.size)||(u=Math.min(Math.round(e.pt2px(t.size*t.sizeRatio)),127));const f=(i,n,o)=>r.isFunction(t.size)?Math.min(Math.round(e.pt2px(t.size(i,n,o)*t.sizeRatio)),127):u;if(_._dynamicPropertyMap.set("_size",f),r.isFunction(t.outlineSize)){const i=(i,n,o)=>Math.min(Math.floor(h*e.pt2px(t.outlineSize(i,n,o)*t.sizeRatio)),127);_._dynamicPropertyMap.set("_haloSize",i)}else _._haloSize=Math.min(Math.floor(h*e.pt2px(t.outlineSize*t.sizeRatio)),127);let m;r.isFunction(t.offsetX)||(m=Math.round(e.pt2px(t.offsetX*t.sizeRatio)));const y=(i,n,o)=>r.isFunction(t.offsetX)?Math.round(e.pt2px(t.offsetX(i,n,o)*t.sizeRatio)):m;let M;_._dynamicPropertyMap.set("_xOffset",y),r.isFunction(t.offsetY)||(M=Math.round(e.pt2px(t.offsetY*t.sizeRatio)));const d=(i,n,o)=>r.isFunction(t.offsetY)?Math.round(e.pt2px(t.offsetY(i,n,o)*t.sizeRatio)):M;_._dynamicPropertyMap.set("_yOffset",d),r.isFunction(t.angle)?_._dynamicPropertyMap.set("_angle",t.angle):_._angle=t.angle,r.isFunction(t.horizontalAlignment)?_._dynamicPropertyMap.set("_horizontalAlignment",t.horizontalAlignment):_._horizontalAlignment=t.horizontalAlignment,r.isFunction(t.verticalAlignment)?_._dynamicPropertyMap.set("_verticalAlignment",t.verticalAlignment):_._verticalAlignment=t.verticalAlignment,_._scaleFactor=p,r.isFunction(t.text)?_._dynamicPropertyMap.set("_text",t.text):_._text=t.text;const x=Math.min(Math.round(e.pt2px(t.referenceSize*t.sizeRatio)),127);_._referenceSize=Math.round(Math.sqrt(256*x)),_._materialKey=t.materialKey;const g=s.TextMaterialKey.load(_._materialKey);return g.sdf=!0,_._bitset=(1===t.alignment?1:0)|(t.colorLocked?1:0)<<1,_._materialKey=g.data,_._decoration="none",_._lineHeight=1,_._lineWidth=512,_._textPlacement=t.markerPlacement,_._effects=t.effects,_._isCIM=!0,_}t._inheritsLoose(c,l),c.fromCIMText=function(t,e){const[i,n]=r.getMinMaxZoom(t.scaleInfo,e);return new c(t,i,n)};var u=c.prototype;return u.analyze=function(){var e=t._asyncToGenerator((function*(t,e,i,n){const o=e.readLegacyFeature(),a=p(this._cimTextLayer,o,i,n),s=yield l.prototype.analyze.call(this,t,e,i,n,_.codepoints(a));return s&&s.glyphMosaicItems&&this._textToGlyphs.set(a,s.glyphMosaicItems),s}));function i(t,i,n,o){return e.apply(this,arguments)}return i}(),u.bindFeature=function(t,e,n){const a=t.readLegacyFeature();if(this._dynamicPropertyMap.forEach(((t,i)=>{this[i]=t(a,e,n)})),!this._text||0===this._text.length)return void(this._shapingInfo=null);this._size*=this._scaleFactor,this._scale=this._size/o.GLYPH_SIZE,this._xOffset*=this._scaleFactor,this._yOffset*=this._scaleFactor,this._xAlignD=i.getXAnchorDirection(this._horizontalAlignment||"center"),this._yAlignD=i.getYAnchorDirection(this._verticalAlignment||"baseline");const s=this._textToGlyphs.get(this._text);this.bindTextInfo(s,!1)},c}(l(c));return u}));
