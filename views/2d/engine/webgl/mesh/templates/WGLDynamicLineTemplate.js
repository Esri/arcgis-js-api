/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/maybe","../../../../../../core/screenUtils","../../color","../../definitions","../../number","../../materialKey/MaterialKey","./util","./WGLBaseLineTemplate","./WGLDynamicMeshTemplate","../../util/Result"],(function(t,e,i,s,o,a,n,r,l,c,h){"use strict";return function(l){function c(t,n,c){var h;(h=l.call(this,t)||this)._minMaxZoom=a.i1616to32(Math.round(n*o.MIN_MAX_ZOOM_PRECISION_FACTOR),Math.round(c*o.MIN_MAX_ZOOM_PRECISION_FACTOR)),h._cimLineLayer=t;let _=0;r.isFunction(t.width)||(_=.5*i.pt2px(t.width));const p=(e,s,o)=>r.isFunction(t.width)?.5*i.pt2px(t.width(e,s,o)):_;h._dynamicPropertyMap.set("_halfWidth",p),r.isFunction(t.cap)?h._dynamicPropertyMap.set("_capType",t.cap):h._capType=t.cap,r.isFunction(t.join)?h._dynamicPropertyMap.set("_joinType",t.join):h._joinType=t.join;const m=t.color;if(r.isFunction(m)){const t=(t,e,i)=>s.premultiplyAlphaRGBA(m(t,e,i));h._dynamicPropertyMap.set("_fillColor",t)}else h._fillColor=m&&s.premultiplyAlphaRGBA(m)||0;const f=t.miterLimit;if(r.isFunction(f)){const t=(t,e,i)=>r.getLimitCosine(f(t,e,i));h._dynamicPropertyMap.set("_miterLimitCosine",t)}else h._miterLimitCosine=r.getLimitCosine(f);if(e.isSome(t.effects)){const e=t.effects;r.isFunction(e)?h._dynamicPropertyMap.set("_effects",e):h._effects=e}return h._scaleFactor=t.scaleFactor||1,h._isDashed=null!=t.dashTemplate,h.tessellationProperties._bitset=(t.colorLocked?1:0)|(t.scaleDash?1:0)<<1,h._materialKey=t.materialKey,h._initializeTessellator(!0),h}return t._inheritsLoose(c,l),c.fromCIMLine=function(t,e){const[i,s]=r.getMinMaxZoom(t.scaleInfo,e);return new c(t,i,s)},c.prototype.bindFeature=function(t,e,i){const s=t.readLegacyFeature();this._dynamicPropertyMap.forEach(((t,o)=>{this[o]=t(s,e,i)})),this._halfWidth*=this._scaleFactor;const r=this._materialCache,l=(0,this._cimLineLayer.materialHash)(s,e,i),c=r.get(l);let _=null;if(c&&h.ok(c.spriteMosaicItem)&&(_=c.spriteMosaicItem),_){this._hasPattern=!0;const{rect:t,width:e,height:i}=_,s=t.x+o.SPRITE_PADDING,n=t.y+o.SPRITE_PADDING,r=s+e,l=n+i;this.tessellationProperties._tl=a.i1616to32(s,n),this.tessellationProperties._br=a.i1616to32(r,l)}else this._hasPattern=!1,this.tessellationProperties._tl=0,this.tessellationProperties._br=0;this.tessellationProperties._fillColor=this._fillColor,this.tessellationProperties._halfWidth=this._halfWidth,this.tessellationProperties.offset=0,this.tessellationProperties._halfReferenceWidth=this.tessellationProperties._halfWidth;const p=n.LineMaterialKey.load(this._materialKey);_&&(p.sdf=_.sdf,p.pattern=!0,p.textureBinding=_.textureBinding),this._materialKey=p.data},c}(l(c))}));
