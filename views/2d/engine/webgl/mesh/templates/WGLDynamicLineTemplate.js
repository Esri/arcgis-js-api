/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/screenUtils","../../definitions","../../number","../../materialKey/MaterialKey","../../color","../../util/Result","./util","./WGLDynamicMeshTemplate","./WGLBaseLineTemplate"],(function(t,e,i,s,r,o,a,n,l,c){"use strict";return function(l){function c(t){var i;(i=l.call(this,t)||this)._cimLineLayer=t;let s=0;n.isFunction(t.width)||(s=.5*e.pt2px(t.width));const r=(i,r,o)=>n.isFunction(t.width)?.5*e.pt2px(t.width(i,r,o)):s;if(i._dynamicPropertyMap.set("_halfWidth",r),n.isFunction(t.cap)?i._dynamicPropertyMap.set("_capType",t.cap):i._capType=t.cap,n.isFunction(t.join)?i._dynamicPropertyMap.set("_joinType",t.join):i._joinType=t.join,n.isFunction(t.color)){const e=(e,i,s)=>{const r=t.color(e,i,s);return r&&o.premultiplyAlphaRGBA(r)||0};i._dynamicPropertyMap.set("_fillColor",e)}else{const e=t.color;i._fillColor=e&&o.premultiplyAlphaRGBA(e)||0}if(n.isFunction(t.miterLimit)){const e=(e,i,s)=>n.getLimitCosine(t.miterLimit(e,i,s));i._dynamicPropertyMap.set("_miterLimitCosine",e)}else i._miterLimitCosine=n.getLimitCosine(t.miterLimit);return i._scaleFactor=t.scaleFactor||1,i._isDashed=t.isDashed,i._effects=t.effects,i.tessellationProperties._bitset=t.colorLocked?1:0,i._materialKey=t.materialKey,i._initializeTessellator(!0),i}return t._inheritsLoose(c,l),c.fromCIMLine=function(t){return new c(t)},c.prototype.bindFeature=function(t,e,o){const n=t.readLegacyFeature();this._dynamicPropertyMap.forEach(((t,i)=>{this[i]=t(n,e,o)})),this._halfWidth*=this._scaleFactor;const l=this._materialCache,c=(0,this._cimLineLayer.materialHash)(n,e,o),h=l.get(c);let p=null;if(h&&a.ok(h.spriteMosaicItem)&&(p=h.spriteMosaicItem),p){this._hasPattern=!0;const{rect:t,width:e,height:r}=p,o=t.x+i.SPRITE_PADDING,a=t.y+i.SPRITE_PADDING,n=o+e,l=a+r;this.tessellationProperties._tl=s.i1616to32(o,a),this.tessellationProperties._br=s.i1616to32(n,l)}else this._hasPattern=!1,this.tessellationProperties._tl=0,this.tessellationProperties._br=0;this.tessellationProperties._fillColor=this._fillColor,this.tessellationProperties._halfWidth=this._halfWidth,this.tessellationProperties._halfReferenceWidth=this.tessellationProperties._halfWidth;const _=r.LineMaterialKey.load(this._materialKey);p&&(_.sdf=p.sdf,_.pattern=!0,_.textureBinding=p.textureBinding),this._materialKey=_.data},c}(c(l))}));
