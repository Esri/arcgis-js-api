/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","./definitions","./GeometryUtils","./Geometry"],(function(i,t,s,h,n){"use strict";let e=function(i,t,s){this.ratio=i,this.x=t,this.y=s},l=function(){function i(i,t,h,n=8,e=8){this.lines=[],this.starts=[],this.validateTessellation=!0,this.pixelRatio=n,this.pixelMargin=e,this.tileSize=s.TILE_SIZE*n,this.dz=i,this.yPos=t,this.xPos=h}var t=i.prototype;return t.setExtent=function(i){this.finalRatio=this.tileSize/i*(1<<this.dz);let t=this.pixelRatio*this.pixelMargin;t/=this.finalRatio;const s=i>>this.dz;t>s&&(t=s),this.margin=t,this.xmin=s*this.xPos-t,this.ymin=s*this.yPos-t,this.xmax=this.xmin+s+2*t,this.ymax=this.ymin+s+2*t},t.reset=function(i){this.type=i,this.lines=[],this.starts=[],this.line=null,this.start=0},t.moveTo=function(i,t){this._pushLine(),this._prevIsIn=this._isIn(i,t),this._moveTo(i,t,this._prevIsIn),this._prevPt=new n.Point(i,t),this._firstPt=new n.Point(i,t),this._dist=0},t.lineTo=function(i,t){const s=this._isIn(i,t),h=new n.Point(i,t),l=n.Point.distance(this._prevPt,h);let x,o,a,y,r,u,m,p;if(s)this._prevIsIn?this._lineTo(i,t,!0):(x=this._prevPt,o=h,a=this._intersect(o,x),this.start=this._dist+l*(1-this._r),this._lineTo(a.x,a.y,!0),this._lineTo(o.x,o.y,!0));else if(this._prevIsIn)o=this._prevPt,x=h,a=this._intersect(o,x),this._lineTo(a.x,a.y,!0),this._lineTo(x.x,x.y,!1);else{const i=this._prevPt,t=h;if(i.x<=this.xmin&&t.x<=this.xmin||i.x>=this.xmax&&t.x>=this.xmax||i.y<=this.ymin&&t.y<=this.ymin||i.y>=this.ymax&&t.y>=this.ymax)this._lineTo(t.x,t.y,!1);else{const s=[];if((i.x<this.xmin&&t.x>this.xmin||i.x>this.xmin&&t.x<this.xmin)&&(y=(this.xmin-i.x)/(t.x-i.x),p=i.y+y*(t.y-i.y),p<=this.ymin?u=!1:p>=this.ymax?u=!0:s.push(new e(y,this.xmin,p))),(i.x<this.xmax&&t.x>this.xmax||i.x>this.xmax&&t.x<this.xmax)&&(y=(this.xmax-i.x)/(t.x-i.x),p=i.y+y*(t.y-i.y),p<=this.ymin?u=!1:p>=this.ymax?u=!0:s.push(new e(y,this.xmax,p))),(i.y<this.ymin&&t.y>this.ymin||i.y>this.ymin&&t.y<this.ymin)&&(y=(this.ymin-i.y)/(t.y-i.y),m=i.x+y*(t.x-i.x),m<=this.xmin?r=!1:m>=this.xmax?r=!0:s.push(new e(y,m,this.ymin))),(i.y<this.ymax&&t.y>this.ymax||i.y>this.ymax&&t.y<this.ymax)&&(y=(this.ymax-i.y)/(t.y-i.y),m=i.x+y*(t.x-i.x),m<=this.xmin?r=!1:m>=this.xmax?r=!0:s.push(new e(y,m,this.ymax))),0===s.length)r?u?this._lineTo(this.xmax,this.ymax,!0):this._lineTo(this.xmax,this.ymin,!0):u?this._lineTo(this.xmin,this.ymax,!0):this._lineTo(this.xmin,this.ymin,!0);else if(s.length>1&&s[0].ratio>s[1].ratio)this.start=this._dist+l*s[1].ratio,this._lineTo(s[1].x,s[1].y,!0),this._lineTo(s[0].x,s[0].y,!0);else{this.start=this._dist+l*s[0].ratio;for(let i=0;i<s.length;i++)this._lineTo(s[i].x,s[i].y,!0)}this._lineTo(t.x,t.y,!1)}}this._dist+=l,this._prevIsIn=s,this._prevPt=h},t.close=function(){if(this.line.length>2){const i=this._firstPt,t=this._prevPt;i.x===t.x&&i.y===t.y||this.lineTo(i.x,i.y);const s=this.line;let h=s.length;for(;h>=4&&(s[0].x===s[1].x&&s[0].x===s[h-2].x||s[0].y===s[1].y&&s[0].y===s[h-2].y);)s.pop(),s[0].x=s[h-2].x,s[0].y=s[h-2].y,--h}},t.result=function(i=!0){return this._pushLine(),0===this.lines.length?null:(3===this.type&&i&&o.simplify(this.tileSize,this.margin*this.finalRatio,this.lines),this.lines)},t.resultWithStarts=function(){if(2!==this.type)throw new Error("Only valid for lines");this._pushLine();const i=this.lines,t=i.length;if(0===t)return null;const s=[];for(let h=0;h<t;h++)s.push({line:i[h],start:this.starts[h]||0});return s},t._isIn=function(i,t){return i>=this.xmin&&i<=this.xmax&&t>=this.ymin&&t<=this.ymax},t._intersect=function(i,t){let s,h,e;if(t.x>=this.xmin&&t.x<=this.xmax)h=t.y<=this.ymin?this.ymin:this.ymax,e=(h-i.y)/(t.y-i.y),s=i.x+e*(t.x-i.x);else if(t.y>=this.ymin&&t.y<=this.ymax)s=t.x<=this.xmin?this.xmin:this.xmax,e=(s-i.x)/(t.x-i.x),h=i.y+e*(t.y-i.y);else{h=t.y<=this.ymin?this.ymin:this.ymax,s=t.x<=this.xmin?this.xmin:this.xmax;const n=(s-i.x)/(t.x-i.x),l=(h-i.y)/(t.y-i.y);n<l?(e=n,h=i.y+n*(t.y-i.y)):(e=l,s=i.x+l*(t.x-i.x))}return this._r=e,new n.Point(s,h)},t._pushLine=function(){this.line&&(1===this.type?this.line.length>0&&(this.lines.push(this.line),this.starts.push(this.start)):2===this.type?this.line.length>1&&(this.lines.push(this.line),this.starts.push(this.start)):3===this.type&&this.line.length>3&&(this.lines.push(this.line),this.starts.push(this.start))),this.line=[],this.start=0},t._moveTo=function(i,t,s){3!==this.type?s&&(i=Math.round((i-(this.xmin+this.margin))*this.finalRatio),t=Math.round((t-(this.ymin+this.margin))*this.finalRatio),this.line.push(new n.Point(i,t))):(s||(i<this.xmin&&(i=this.xmin),i>this.xmax&&(i=this.xmax),t<this.ymin&&(t=this.ymin),t>this.ymax&&(t=this.ymax)),i=Math.round((i-(this.xmin+this.margin))*this.finalRatio),t=Math.round((t-(this.ymin+this.margin))*this.finalRatio),this.line.push(new n.Point(i,t)),this._is_h=!1,this._is_v=!1)},t._lineTo=function(i,t,s){let h,e;if(3!==this.type)if(s){if(i=Math.round((i-(this.xmin+this.margin))*this.finalRatio),t=Math.round((t-(this.ymin+this.margin))*this.finalRatio),this.line.length>0&&(h=this.line[this.line.length-1],h.equals(i,t)))return;this.line.push(new n.Point(i,t))}else this.line&&this.line.length>0&&this._pushLine();else if(s||(i<this.xmin&&(i=this.xmin),i>this.xmax&&(i=this.xmax),t<this.ymin&&(t=this.ymin),t>this.ymax&&(t=this.ymax)),i=Math.round((i-(this.xmin+this.margin))*this.finalRatio),t=Math.round((t-(this.ymin+this.margin))*this.finalRatio),this.line&&this.line.length>0){h=this.line[this.line.length-1];const s=h.x===i,l=h.y===t;if(s&&l)return;this._is_h&&s||this._is_v&&l?(h.x=i,h.y=t,e=this.line[this.line.length-2],e.x===i&&e.y===t?(this.line.pop(),this.line.length<=1?(this._is_h=!1,this._is_v=!1):(e=this.line[this.line.length-2],this._is_h=e.x===i,this._is_v=e.y===t)):(this._is_h=e.x===i,this._is_v=e.y===t)):(this.line.push(new n.Point(i,t)),this._is_h=s,this._is_v=l)}else this.line.push(new n.Point(i,t))},i}(),x=function(){function i(){}var s=i.prototype;return s.setExtent=function(i){this._ratio=4096===i?1:4096/i},s.reset=function(i){this.lines=[],this.line=null},s.moveTo=function(i,t){this.line&&this.lines.push(this.line),this.line=[];const s=this._ratio;this.line.push(new n.Point(i*s,t*s))},s.lineTo=function(i,t){const s=this._ratio;this.line.push(new n.Point(i*s,t*s))},s.close=function(){const i=this.line;i&&!i[0].isEqual(i[i.length-1])&&i.push(i[0])},s.result=function(){return this.line&&this.lines.push(this.line),0===this.lines.length?null:this.lines},t._createClass(i,[{key:"validateTessellation",get:function(){return this._ratio<1}}]),i}(),o=function(){function i(){}return i.simplify=function(t,s,h){if(!h)return;const n=-s,e=t+s,l=-s,x=t+s,o=[],a=[],y=h.length;for(let i=0;i<y;++i){const t=h[i];if(!t||t.length<2)continue;let s,y=t[0];const r=t.length;for(let h=1;h<r;++h)s=t[h],y.x===s.x&&(y.x<=n&&(y.y>s.y?(o.push(i),o.push(h),o.push(0),o.push(-1)):(a.push(i),a.push(h),a.push(0),a.push(-1))),y.x>=e&&(y.y<s.y?(o.push(i),o.push(h),o.push(1),o.push(-1)):(a.push(i),a.push(h),a.push(1),a.push(-1)))),y.y===s.y&&(y.y<=l&&(y.x<s.x?(o.push(i),o.push(h),o.push(2),o.push(-1)):(a.push(i),a.push(h),a.push(2),a.push(-1))),y.y>=x&&(y.x>s.x?(o.push(i),o.push(h),o.push(3),o.push(-1)):(a.push(i),a.push(h),a.push(3),a.push(-1)))),y=s}if(0===o.length||0===a.length)return;i.fillParent(h,a,o),i.fillParent(h,o,a);const r=[];i.calcDeltas(r,a,o),i.calcDeltas(r,o,a),i.addDeltas(r,h)},i.fillParent=function(i,t,s){const n=s.length,e=t.length;for(let l=0;l<e;l+=4){const e=t[l],x=t[l+1],o=t[l+2],a=i[e][x-1],y=i[e][x];let r=8092,u=-1;for(let t=0;t<n;t+=4){if(s[t+2]!==o)continue;const n=s[t],e=s[t+1],l=i[n][e-1],x=i[n][e];switch(o){case 0:case 1:if(h.between(a.y,l.y,x.y)&&h.between(y.y,l.y,x.y)){const i=Math.abs(x.y-l.y);i<r&&(r=i,u=t)}break;case 2:case 3:if(h.between(a.x,l.x,x.x)&&h.between(y.x,l.x,x.x)){const i=Math.abs(x.x-l.x);i<r&&(r=i,u=t)}}}t[l+3]=u}},i.calcDeltas=function(t,s,h){const n=s.length;for(let e=0;e<n;e+=4){const n=[],l=i.calcDelta(e,s,h,n);t.push(s[e]),t.push(s[e+1]),t.push(s[e+2]),t.push(l)}},i.calcDelta=function(t,s,h,n){const e=s[t+3];if(-1===e)return 0;const l=n.length;return l>1&&n[l-2]===e?0:(n.push(e),i.calcDelta(e,h,s,n)+1)},i.addDeltas=function(i,t){const s=i.length;let h=0;for(let t=0;t<s;t+=4){const s=i[t+3];s>h&&(h=s)}for(let n=0;n<s;n+=4){const s=t[i[n]],e=i[n+1],l=h-i[n+3];switch(i[n+2]){case 0:s[e-1].x-=l,s[e].x-=l,1===e&&(s[s.length-1].x-=l),e===s.length-1&&(s[0].x-=l);break;case 1:s[e-1].x+=l,s[e].x+=l,1===e&&(s[s.length-1].x+=l),e===s.length-1&&(s[0].x+=l);break;case 2:s[e-1].y-=l,s[e].y-=l,1===e&&(s[s.length-1].y-=l),e===s.length-1&&(s[0].y-=l);break;case 3:s[e-1].y+=l,s[e].y+=l,1===e&&(s[s.length-1].y+=l),e===s.length-1&&(s[0].y+=l)}}},i}();i.SimpleBuilder=x,i.TileClipper=l,Object.defineProperty(i,"__esModule",{value:!0})}));
