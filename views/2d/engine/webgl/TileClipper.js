/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","./definitions","./Geometry","./GeometryUtils"],(function(i,t,s,h,n){"use strict";let e=function(i,t,s){this.ratio=i,this.x=t,this.y=s},_=function(){function i(i,t,h,n=8,e=8){this._lines=[],this._starts=[],this.validateTessellation=!0,this._pixelRatio=n,this._pixelMargin=e,this._tileSize=s.TILE_SIZE*n,this._dz=i,this._yPos=t,this._xPos=h}var t=i.prototype;return t.setPixelMargin=function(i){i!==this._pixelMargin&&(this._pixelMargin=i,this.setExtent(this._extent))},t.setExtent=function(i){this._extent=i,this._finalRatio=this._tileSize/i*(1<<this._dz);let t=this._pixelRatio*this._pixelMargin;t/=this._finalRatio;const s=i>>this._dz;t>s&&(t=s),this._margin=t,this._xmin=s*this._xPos-t,this._ymin=s*this._yPos-t,this._xmax=this._xmin+s+2*t,this._ymax=this._ymin+s+2*t},t.reset=function(i){this._type=i,this._lines=[],this._starts=[],this._line=null,this._start=0},t.moveTo=function(i,t){this._pushLine(),this._prevIsIn=this._isIn(i,t),this._moveTo(i,t,this._prevIsIn),this._prevPt=new h.Point(i,t),this._firstPt=new h.Point(i,t),this._dist=0},t.lineTo=function(i,t){const s=this._isIn(i,t),n=new h.Point(i,t),_=h.Point.distance(this._prevPt,n);let l,o,x,y,a,r,u,m;if(s)this._prevIsIn?this._lineTo(i,t,!0):(l=this._prevPt,o=n,x=this._intersect(o,l),this._start=this._dist+_*(1-this._r),this._lineTo(x.x,x.y,!0),this._lineTo(o.x,o.y,!0));else if(this._prevIsIn)o=this._prevPt,l=n,x=this._intersect(o,l),this._lineTo(x.x,x.y,!0),this._lineTo(l.x,l.y,!1);else{const i=this._prevPt,t=n;if(i.x<=this._xmin&&t.x<=this._xmin||i.x>=this._xmax&&t.x>=this._xmax||i.y<=this._ymin&&t.y<=this._ymin||i.y>=this._ymax&&t.y>=this._ymax)this._lineTo(t.x,t.y,!1);else{const s=[];if((i.x<this._xmin&&t.x>this._xmin||i.x>this._xmin&&t.x<this._xmin)&&(y=(this._xmin-i.x)/(t.x-i.x),m=i.y+y*(t.y-i.y),m<=this._ymin?r=!1:m>=this._ymax?r=!0:s.push(new e(y,this._xmin,m))),(i.x<this._xmax&&t.x>this._xmax||i.x>this._xmax&&t.x<this._xmax)&&(y=(this._xmax-i.x)/(t.x-i.x),m=i.y+y*(t.y-i.y),m<=this._ymin?r=!1:m>=this._ymax?r=!0:s.push(new e(y,this._xmax,m))),(i.y<this._ymin&&t.y>this._ymin||i.y>this._ymin&&t.y<this._ymin)&&(y=(this._ymin-i.y)/(t.y-i.y),u=i.x+y*(t.x-i.x),u<=this._xmin?a=!1:u>=this._xmax?a=!0:s.push(new e(y,u,this._ymin))),(i.y<this._ymax&&t.y>this._ymax||i.y>this._ymax&&t.y<this._ymax)&&(y=(this._ymax-i.y)/(t.y-i.y),u=i.x+y*(t.x-i.x),u<=this._xmin?a=!1:u>=this._xmax?a=!0:s.push(new e(y,u,this._ymax))),0===s.length)a?r?this._lineTo(this._xmax,this._ymax,!0):this._lineTo(this._xmax,this._ymin,!0):r?this._lineTo(this._xmin,this._ymax,!0):this._lineTo(this._xmin,this._ymin,!0);else if(s.length>1&&s[0].ratio>s[1].ratio)this._start=this._dist+_*s[1].ratio,this._lineTo(s[1].x,s[1].y,!0),this._lineTo(s[0].x,s[0].y,!0);else{this._start=this._dist+_*s[0].ratio;for(let i=0;i<s.length;i++)this._lineTo(s[i].x,s[i].y,!0)}this._lineTo(t.x,t.y,!1)}}this._dist+=_,this._prevIsIn=s,this._prevPt=n},t.close=function(){if(this._line.length>2){const i=this._firstPt,t=this._prevPt;i.x===t.x&&i.y===t.y||this.lineTo(i.x,i.y);const s=this._line;let h=s.length;for(;h>=4&&(s[0].x===s[1].x&&s[0].x===s[h-2].x||s[0].y===s[1].y&&s[0].y===s[h-2].y);)s.pop(),s[0].x=s[h-2].x,s[0].y=s[h-2].y,--h}},t.result=function(i=!0){return this._pushLine(),0===this._lines.length?null:(this._type===h.GeometryType.Polygon&&i&&x.simplify(this._tileSize,this._margin*this._finalRatio,this._lines),this._lines)},t.resultWithStarts=function(){if(this._type!==h.GeometryType.LineString)throw new Error("Only valid for lines");this._pushLine();const i=this._lines,t=i.length;if(0===t)return null;const s=[];for(let h=0;h<t;h++)s.push({line:i[h],start:this._starts[h]||0});return s},t._isIn=function(i,t){return i>=this._xmin&&i<=this._xmax&&t>=this._ymin&&t<=this._ymax},t._intersect=function(i,t){let s,n,e;if(t.x>=this._xmin&&t.x<=this._xmax)n=t.y<=this._ymin?this._ymin:this._ymax,e=(n-i.y)/(t.y-i.y),s=i.x+e*(t.x-i.x);else if(t.y>=this._ymin&&t.y<=this._ymax)s=t.x<=this._xmin?this._xmin:this._xmax,e=(s-i.x)/(t.x-i.x),n=i.y+e*(t.y-i.y);else{n=t.y<=this._ymin?this._ymin:this._ymax,s=t.x<=this._xmin?this._xmin:this._xmax;const h=(s-i.x)/(t.x-i.x),_=(n-i.y)/(t.y-i.y);h<_?(e=h,n=i.y+h*(t.y-i.y)):(e=_,s=i.x+_*(t.x-i.x))}return this._r=e,new h.Point(s,n)},t._pushLine=function(){this._line&&(this._type===h.GeometryType.Point?this._line.length>0&&(this._lines.push(this._line),this._starts.push(this._start)):this._type===h.GeometryType.LineString?this._line.length>1&&(this._lines.push(this._line),this._starts.push(this._start)):this._type===h.GeometryType.Polygon&&this._line.length>3&&(this._lines.push(this._line),this._starts.push(this._start))),this._line=[],this._start=0},t._moveTo=function(i,t,s){this._type!==h.GeometryType.Polygon?s&&(i=Math.round((i-(this._xmin+this._margin))*this._finalRatio),t=Math.round((t-(this._ymin+this._margin))*this._finalRatio),this._line.push(new h.Point(i,t))):(s||(i<this._xmin&&(i=this._xmin),i>this._xmax&&(i=this._xmax),t<this._ymin&&(t=this._ymin),t>this._ymax&&(t=this._ymax)),i=Math.round((i-(this._xmin+this._margin))*this._finalRatio),t=Math.round((t-(this._ymin+this._margin))*this._finalRatio),this._line.push(new h.Point(i,t)),this._isH=!1,this._isV=!1)},t._lineTo=function(i,t,s){let n,e;if(this._type!==h.GeometryType.Polygon)if(s){if(i=Math.round((i-(this._xmin+this._margin))*this._finalRatio),t=Math.round((t-(this._ymin+this._margin))*this._finalRatio),this._line.length>0&&(n=this._line[this._line.length-1],n.equals(i,t)))return;this._line.push(new h.Point(i,t))}else this._line&&this._line.length>0&&this._pushLine();else if(s||(i<this._xmin&&(i=this._xmin),i>this._xmax&&(i=this._xmax),t<this._ymin&&(t=this._ymin),t>this._ymax&&(t=this._ymax)),i=Math.round((i-(this._xmin+this._margin))*this._finalRatio),t=Math.round((t-(this._ymin+this._margin))*this._finalRatio),this._line&&this._line.length>0){n=this._line[this._line.length-1];const s=n.x===i,_=n.y===t;if(s&&_)return;this._isH&&s||this._isV&&_?(n.x=i,n.y=t,e=this._line[this._line.length-2],e.x===i&&e.y===t?(this._line.pop(),this._line.length<=1?(this._isH=!1,this._isV=!1):(e=this._line[this._line.length-2],this._isH=e.x===i,this._isV=e.y===t)):(this._isH=e.x===i,this._isV=e.y===t)):(this._line.push(new h.Point(i,t)),this._isH=s,this._isV=_)}else this._line.push(new h.Point(i,t))},i}(),l=function(){function i(){}var s=i.prototype;return s.setExtent=function(i){this._ratio=4096===i?1:4096/i},s.reset=function(i){this._lines=[],this._line=null},s.moveTo=function(i,t){this._line&&this._lines.push(this._line),this._line=[];const s=this._ratio;this._line.push(new h.Point(i*s,t*s))},s.lineTo=function(i,t){const s=this._ratio;this._line.push(new h.Point(i*s,t*s))},s.close=function(){const i=this._line;i&&!i[0].isEqual(i[i.length-1])&&i.push(i[0])},s.result=function(){return this._line&&this._lines.push(this._line),0===this._lines.length?null:this._lines},t._createClass(i,[{key:"validateTessellation",get:function(){return this._ratio<1}}]),i}();var o;!function(i){i[i.sideLeft=0]="sideLeft",i[i.sideRight=1]="sideRight",i[i.sideTop=2]="sideTop",i[i.sideBottom=3]="sideBottom"}(o||(o={}));let x=function(){function i(){}return i.simplify=function(t,s,h){if(!h)return;const n=-s,e=t+s,_=-s,l=t+s,x=[],y=[],a=h.length;for(let i=0;i<a;++i){const t=h[i];if(!t||t.length<2)continue;let s,a=t[0];const r=t.length;for(let h=1;h<r;++h)s=t[h],a.x===s.x&&(a.x<=n&&(a.y>s.y?(x.push(i),x.push(h),x.push(o.sideLeft),x.push(-1)):(y.push(i),y.push(h),y.push(o.sideLeft),y.push(-1))),a.x>=e&&(a.y<s.y?(x.push(i),x.push(h),x.push(o.sideRight),x.push(-1)):(y.push(i),y.push(h),y.push(o.sideRight),y.push(-1)))),a.y===s.y&&(a.y<=_&&(a.x<s.x?(x.push(i),x.push(h),x.push(o.sideTop),x.push(-1)):(y.push(i),y.push(h),y.push(o.sideTop),y.push(-1))),a.y>=l&&(a.x>s.x?(x.push(i),x.push(h),x.push(o.sideBottom),x.push(-1)):(y.push(i),y.push(h),y.push(o.sideBottom),y.push(-1)))),a=s}if(0===x.length||0===y.length)return;i.fillParent(h,y,x),i.fillParent(h,x,y);const r=[];i.calcDeltas(r,y,x),i.calcDeltas(r,x,y),i.addDeltas(r,h)},i.fillParent=function(i,t,s){const h=s.length,e=t.length;for(let _=0;_<e;_+=4){const e=t[_],l=t[_+1],x=t[_+2],y=i[e][l-1],a=i[e][l];let r=8092,u=-1;for(let t=0;t<h;t+=4){if(s[t+2]!==x)continue;const h=s[t],e=s[t+1],_=i[h][e-1],l=i[h][e];switch(x){case o.sideLeft:case o.sideRight:if(n.between(y.y,_.y,l.y)&&n.between(a.y,_.y,l.y)){const i=Math.abs(l.y-_.y);i<r&&(r=i,u=t)}break;case o.sideTop:case o.sideBottom:if(n.between(y.x,_.x,l.x)&&n.between(a.x,_.x,l.x)){const i=Math.abs(l.x-_.x);i<r&&(r=i,u=t)}}}t[_+3]=u}},i.calcDeltas=function(t,s,h){const n=s.length;for(let e=0;e<n;e+=4){const n=[],_=i.calcDelta(e,s,h,n);t.push(s[e]),t.push(s[e+1]),t.push(s[e+2]),t.push(_)}},i.calcDelta=function(t,s,h,n){const e=s[t+3];if(-1===e)return 0;const _=n.length;return _>1&&n[_-2]===e?0:(n.push(e),i.calcDelta(e,h,s,n)+1)},i.addDeltas=function(i,t){const s=i.length;let h=0;for(let n=0;n<s;n+=4){const t=i[n+3];t>h&&(h=t)}for(let n=0;n<s;n+=4){const s=t[i[n]],e=i[n+1],_=h-i[n+3];switch(i[n+2]){case o.sideLeft:s[e-1].x-=_,s[e].x-=_,1===e&&(s[s.length-1].x-=_),e===s.length-1&&(s[0].x-=_);break;case o.sideRight:s[e-1].x+=_,s[e].x+=_,1===e&&(s[s.length-1].x+=_),e===s.length-1&&(s[0].x+=_);break;case o.sideTop:s[e-1].y-=_,s[e].y-=_,1===e&&(s[s.length-1].y-=_),e===s.length-1&&(s[0].y-=_);break;case o.sideBottom:s[e-1].y+=_,s[e].y+=_,1===e&&(s[s.length-1].y+=_),e===s.length-1&&(s[0].y+=_)}}},i}();i.SimpleBuilder=l,i.TileClipper=_,Object.defineProperties(i,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
