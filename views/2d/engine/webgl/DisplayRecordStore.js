/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../../core/has","./FreeList","./Utils"],(function(e,t,r){"use strict";const i=["FILL","LINE","MARKER","TEXT","LABEL"];function n(e){const t=e.getStrides(),r={};for(let n=0;n<t.length;n++)r[i[n]]=t[n];return r}const o=.5;return function(){function e(e,i,n,o){this._strides=e,this._displayList=i,this._freeListsAndStorage={},this._dirtyMap=null,this._dirtyMap=n;for(const s in e){this._freeListsAndStorage[s]={vtxFreeList:o?new t.FreeList(o):null,idxFreeList:o?new t.FreeList(o):null,vertexBuffers:{},indexBuffer:o?new Uint32Array(o):null};for(const t in e[s])this._freeListsAndStorage[s].vertexBuffers[t]={data:o?r.allocateTypedArrayBuffer(o,e[s][t]):null,stride:e[s][t]}}}e.fromTileData=function(o,s){const d=n(o),a=[0,0,0,0,0],u=[0,0,0,0,0];for(const e of o.tileDisplayData.displayObjects)for(const t of e.displayRecords)a[t.geometryType]=Math.max(a[t.geometryType],t.vertexFrom+t.vertexCount),u[t.geometryType]=Math.max(u[t.geometryType],t.indexFrom+t.indexCount);const x=new e(d,o.tileDisplayData.displayList,s,void 0),f=o.tileBufferData?.geometries??[];for(let e=0;e<f.length;++e){const n=a[e],o=u[e],s=f[e],d=i[e],c=x._storageFor(d),l=f[e].indexBuffer;c.indexBuffer=l,c.idxFreeList=new t.FreeList(l.length),c.idxFreeList.allocate(o);let v=0;for(const t in s.vertexBuffer){const i=f[e].vertexBuffer[t];c.vertexBuffers[t].data=i.data,c.vertexBuffers[t].stride=i.stride;const n=r.strideToPackingFactor(i.stride),o=i.data.length*n/i.stride;v||(v=o)}c.vtxFreeList=new t.FreeList(v),c.vtxFreeList.allocate(n)}return x};var s=e.prototype;return s.delete=function(e){const t=i[e.geometryType];this._freeVertices(t,e.vertexFrom,e.vertexCount),this._freeIndices(t,e.indexFrom,e.indexCount),this._displayList.removeFromList(e),e.vertexFrom=void 0,e.indexFrom=void 0},s.setMeshData=function(e,t,n,o,s){const d=i[e.geometryType];let a,u;e.meshData=null,void 0===e.vertexFrom?(u=t.vertexCount,a=this._allocateVertices(d,u)):t.vertexCount>e.vertexCount?(this._freeVertices(d,e.vertexFrom,e.vertexCount),u=t.vertexCount,a=this._allocateVertices(d,u)):t.vertexCount===e.vertexCount?(a=e.vertexFrom,u=e.vertexCount):(this._freeVertices(d,e.vertexFrom+t.vertexCount,e.vertexCount-t.vertexCount),a=e.vertexFrom,u=t.vertexCount);let x,f,c,l=!0;if(void 0===e.indexFrom?(x=s,c=t.indexCount,f=this._allocateIndices(d,c)):t.indexCount>e.indexCount?(x=this._displayList.removeFromList(e),this._freeIndices(d,e.indexFrom,e.indexCount),c=t.indexCount,f=this._allocateIndices(d,c)):t.indexCount===e.indexCount?(l=!1,f=e.indexFrom,c=e.indexCount):(x=this._displayList.removeFromList(e),this._freeIndices(d,e.indexFrom+t.indexCount,e.indexCount-t.indexCount),f=e.indexFrom,c=t.indexCount),-1!==a&&-1!==f){const i=this._storageFor(d);if(r.copyMeshData(a,f,i.vertexBuffers,i.indexBuffer,t,n,o),e.vertexFrom=a,e.indexFrom=f,e.vertexCount=t.vertexCount,e.indexCount=t.indexCount,this._dirtyMap){this._dirtyMap.markDirtyIndices(e.geometryType,e.indexFrom,e.indexCount);for(const t in n)this._dirtyMap.markDirtyVertices(e.geometryType,t,e.vertexFrom,e.vertexCount)}return l&&this._displayList.addToList(e,x),!0}return-1!==a&&this._freeVertices(d,a,u),-1!==f&&this._freeIndices(d,f,c),e.setMeshDataFromBuffers(t,n,o),e.vertexFrom=void 0,e.vertexCount=0,e.indexFrom=void 0,e.indexCount=0,!1},s.tryAddMeshData=function(e,t){const n=t.vertexBuffer,o=t.indexBuffer,s=i[e.geometryType],d=this._allocateVertices(s,e.vertexCount);if(-1===d)return this._freeVertices(s,d,e.vertexCount),!1;const a=this._allocateIndices(s,e.indexCount);if(-1===a)return this._freeVertices(s,d,e.vertexCount),this._freeIndices(s,a,e.indexCount),!1;const u=this._storageFor(s);if(r.copyMeshData(d,a,u.vertexBuffers,u.indexBuffer,e,n,o),e.vertexFrom=d,e.indexFrom=a,this._dirtyMap){this._dirtyMap.markDirtyIndices(e.geometryType,e.indexFrom,e.indexCount);for(const t in n)this._dirtyMap.markDirtyVertices(e.geometryType,t,d,e.vertexCount)}return this._displayList.addToList(e),!0},s._allocateVertices=function(e,t){const r=this._storageFor(e),i=r.vtxFreeList?.allocate(t);if(null==i||-1===i)return-1;const n=r.vtxFreeList?.fragmentation;return null==n||n>o?-1:i},s._freeVertices=function(e,t,r){this._storageFor(e).vtxFreeList?.free(t,r)},s._freeIndices=function(e,t,r){this._storageFor(e).idxFreeList?.free(t,r)},s._allocateIndices=function(e,t){const r=this._storageFor(e),i=r.idxFreeList?.allocate(t);if(null==i||-1===i)return-1;const n=r.idxFreeList?.fragmentation;return null==n||n>o?-1:i},s._storageFor=function(e){return this._freeListsAndStorage[e]},s._stridesFor=function(e,t){return this._strides[e][t]},e}()}));
