// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","../../../../core/has","./FreeList","./Utils"],(function(e,t,r,i,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=["FILL","LINE","MARKER","TEXT","LABEL"];var s=function(){function e(e,t,r,n){for(var s in this._strides=e,this._displayList=t,this._freeListsAndStorage={},this._dirtyMap=null,this._dirtyMap=r,e)for(var a in this._freeListsAndStorage[s]={vtxFreeList:n?new i.FreeList(n):null,idxFreeList:n?new i.FreeList(n):null,vertexBuffers:{},indexBuffer:n?new Uint32Array(n):null},e[s])this._freeListsAndStorage[s].vertexBuffers[a]={data:n?o.allocateTypedArrayBuffer(n,e[s][a]):null,stride:e[s][a]}}return e.fromTileData=function(t,r){for(var s=function(e){for(var t=e.getStrides(),r={},i=0;i<t.length;i++)r[n[i]]=t[i];return r}(t),a=[0,0,0,0,0],d=[0,0,0,0,0],u=0,f=t.tileDisplayData.displayObjects;u<f.length;u++)for(var x=0,v=f[u].displayRecords;x<v.length;x++){var l=v[x];a[l.geometryType]=Math.max(a[l.geometryType],l.vertexFrom+l.vertexCount),d[l.geometryType]=Math.max(d[l.geometryType],l.indexFrom+l.indexCount)}for(var c=new e(s,t.tileDisplayData.displayList,r,null),y=0;y<t.tileBufferData.geometries.length;++y){var h=a[y],F=d[y],m=t.tileBufferData.geometries[y],p=n[y],_=c._storageFor(p),C=t.tileBufferData.geometries[y].indexBuffer;_.indexBuffer=C,_.idxFreeList=new i.FreeList(C.length),_.idxFreeList.allocate(F);var g=void 0;for(var L in m.vertexBuffer){var B=t.tileBufferData.geometries[y].vertexBuffer[L];_.vertexBuffers[L].data=B.data,_.vertexBuffers[L].stride=B.stride;var D=o.strideToPackingFactor(B.stride),T=B.data.length*D/B.stride;g||(g=T)}_.vtxFreeList=new i.FreeList(g),_.vtxFreeList.allocate(h)}return c},e.prototype.delete=function(e){var t=n[e.geometryType];this._freeVertices(t,e.vertexFrom,e.vertexCount),this._freeIndices(t,e.indexFrom,e.indexCount),this._displayList.removeFromList(e),e.vertexFrom=void 0,e.indexFrom=void 0},e.prototype.setMeshData=function(e,t,r,i,s){var a=n[e.geometryType];e.meshData=null;var d=void 0,u=void 0;void 0===e.vertexFrom?(u=t.vertexCount,d=this._allocateVertices(a,u)):t.vertexCount>e.vertexCount?(this._freeVertices(a,e.vertexFrom,e.vertexCount),u=t.vertexCount,d=this._allocateVertices(a,u)):t.vertexCount===e.vertexCount?(d=e.vertexFrom,u=e.vertexCount):(this._freeVertices(a,e.vertexFrom+t.vertexCount,e.vertexCount-t.vertexCount),d=e.vertexFrom,u=t.vertexCount);var f=!0,x=void 0,v=void 0,l=void 0;if(void 0===e.indexFrom?(x=s,l=t.indexCount,v=this._allocateIndices(a,l)):t.indexCount>e.indexCount?(x=this._displayList.removeFromList(e),this._freeIndices(a,e.indexFrom,e.indexCount),l=t.indexCount,v=this._allocateIndices(a,l)):t.indexCount===e.indexCount?(f=!1,v=e.indexFrom,l=e.indexCount):(x=this._displayList.removeFromList(e),this._freeIndices(a,e.indexFrom+t.indexCount,e.indexCount-t.indexCount),v=e.indexFrom,l=t.indexCount),-1!==d&&-1!==v){var c=this._storageFor(a);if(o.copyMeshData(d,v,c.vertexBuffers,c.indexBuffer,t,r,i),e.vertexFrom=d,e.indexFrom=v,e.vertexCount=t.vertexCount,e.indexCount=t.indexCount,this._dirtyMap)for(var y in this._dirtyMap.markDirtyIndices(e.geometryType,e.indexFrom,e.indexCount),r)this._dirtyMap.markDirtyVertices(e.geometryType,y,e.vertexFrom,e.vertexCount);return f&&this._displayList.addToList(e,x),!0}return-1!==d&&this._freeVertices(a,d,u),-1!==v&&this._freeIndices(a,v,l),e.setMeshDataFromBuffers(t,r,i),e.vertexFrom=void 0,e.vertexCount=0,e.indexFrom=void 0,e.indexCount=0,!1},e.prototype.tryAddMeshData=function(e,t){var r=t.vertexBuffer,i=t.indexBuffer,s=n[e.geometryType],a=this._allocateVertices(s,e.vertexCount);if(-1===a)return this._freeVertices(s,a,e.vertexCount),!1;var d=this._allocateIndices(s,e.indexCount);if(-1===d)return this._freeVertices(s,a,e.vertexCount),this._freeIndices(s,d,e.indexCount),!1;var u=this._storageFor(s);if(o.copyMeshData(a,d,u.vertexBuffers,u.indexBuffer,e,r,i),e.vertexFrom=a,e.indexFrom=d,this._dirtyMap)for(var f in this._dirtyMap.markDirtyIndices(e.geometryType,e.indexFrom,e.indexCount),r)this._dirtyMap.markDirtyVertices(e.geometryType,f,a,e.vertexCount);return this._displayList.addToList(e),!0},e.prototype._allocateVertices=function(e,t){var r=this._storageFor(e),i=r.vtxFreeList.allocate(t);return-1===i?-1:r.vtxFreeList.fragmentation>.5?-1:i},e.prototype._freeVertices=function(e,t,i){var n=this._storageFor(e);if(n.vtxFreeList.free(t,i),r("esri-feature-tiles-debug"))for(var s in n.vertexBuffers)for(var a=n.vertexBuffers[s].data,d=this._stridesFor(e,s),u=o.strideToPackingFactor(d),f=t*d/u,x=i*d/u,v=f;v<f+x;++v)a[v]=0},e.prototype._freeIndices=function(e,t,i){var o=this._storageFor(e);if(o.idxFreeList.free(t,i),r("esri-feature-tiles-debug"))for(var n=o.indexBuffer,s=t;s<t+i;++s)n[s]=0},e.prototype._allocateIndices=function(e,t){var r=this._storageFor(e),i=r.idxFreeList.allocate(t);return-1===i?-1:r.idxFreeList.fragmentation>.5?-1:i},e.prototype._storageFor=function(e){return this._freeListsAndStorage[e]},e.prototype._stridesFor=function(e,t){return this._strides[e][t]},e}();t.default=s}));