/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/Logger","../../../../core/Error","../../../../layers/graphics/OptimizedGeometry","../../../../layers/graphics/featureConversionUtils","../../../../chunks/vec2f64","../../../../core/libs/earcut/earcut","../../../../chunks/vec2","../../../webgl/BufferObject","./number"],(function(e,t,r,n,o,i,c,s,a,f,h){"use strict";const u=r.getLogger("esri.views.2d.engine.webgl.Mesh2D"),y=(e,t,r,n)=>{let o=0;for(let n=1;n<r;n++){const r=e[2*(t+n-1)],i=e[2*(t+n-1)+1];o+=(e[2*(t+n)]-r)*(e[2*(t+n)+1]+i)}return n?o>0:o<0},m=({coords:e,lengths:t},r)=>{const n=[];for(let o=0,i=0;o<t.length;i+=t[o],o+=1){const c=i,a=[];for(;o<t.length-1&&y(e,i+t[o],t[o+1],r);o+=1,i+=t[o])a.push(i+t[o]-c);const f=e.slice(2*c,2*(i+t[o])),h=s.earcut(f,a,2);for(const e of h)n.push(e+c)}return n};return function(){function r(e,t,r,n=!1){this._cache={},this.vertices=e,this.indices=t,this.primitiveType=r,this.isMapSpace=n}r.fromRect=function({x:e,y:t,width:n,height:o}){const i=e,c=t,s=i+n,a=c+o;return r.fromScreenExtent({xmin:i,ymin:c,xmax:s,ymax:a})},r.fromPath=function(e){const t=i.convertFromNestedArray(new o,e.path,!1,!1),n=t.coords,c=new Uint32Array(m(t,!0)),s=new Uint32Array(n.length/2);for(let e=0;e<s.length;e++)s[e]=h.i1616to32(Math.floor(n[2*e]),Math.floor(n[2*e+1]));return new r({geometry:s},c,4)},r.fromGeometry=function(e,t){const o=t.geometry.type;switch(o){case"polygon":return r.fromPolygon(e,t.geometry);case"extent":return r.fromMapExtent(e,t.geometry);default:return u.error(new n("mapview-bad-type",`Unable to create a mesh from type ${o}`,t)),r.fromRect({x:0,y:0,width:1,height:1})}},r.fromPolygon=function(e,t){const n=i.convertFromPolygon(new o,t,!1,!1),s=n.coords,f=new Uint32Array(m(n,!1)),u=new Uint32Array(s.length/2),y=c.create(),l=c.create();for(let t=0;t<u.length;t++)a.set(y,s[2*t],s[2*t+1]),e.toScreen(l,y),u[t]=h.i1616to32(Math.floor(l[0]),Math.floor(l[1]));return new r({geometry:u},f,4,!0)},r.fromScreenExtent=function({xmin:e,xmax:t,ymin:n,ymax:o}){return new r({geometry:new Uint32Array([h.i1616to32(e,n),h.i1616to32(t,n),h.i1616to32(e,o),h.i1616to32(e,o),h.i1616to32(t,n),h.i1616to32(t,o)])},new Uint32Array([0,1,2,3,4,5]),4)},r.fromMapExtent=function(e,t){const[n,o]=e.toScreen([0,0],[t.xmin,t.ymin]),[i,c]=e.toScreen([0,0],[t.xmax,t.ymax]);return new r({geometry:new Uint32Array([h.i1616to32(n,o),h.i1616to32(i,o),h.i1616to32(n,c),h.i1616to32(n,c),h.i1616to32(i,o),h.i1616to32(i,c)])},new Uint32Array([0,1,2,3,4,5]),4)};var s=r.prototype;return s.destroy=function(){t.isSome(this._cache.indexBuffer)&&this._cache.indexBuffer.dispose();for(const e in this._cache.vertexBuffers)t.isSome(this._cache.vertexBuffers[e])&&this._cache.vertexBuffers[e].dispose()},s.getIndexBuffer=function(e,t=35044){return this._cache.indexBuffer||(this._cache.indexBuffer=f.createIndex(e,t,this.indices)),this._cache.indexBuffer},s.getVertexBuffers=function(e,t=35044){return this._cache.vertexBuffers||(this._cache.vertexBuffers=Object.keys(this.vertices).reduce(((r,n)=>({...r,[n]:f.createVertex(e,t,this.vertices[n])})),{})),this._cache.vertexBuffers},e._createClass(r,[{key:"elementType",get:function(){return(e=>{switch(e.BYTES_PER_ELEMENT){case 1:return 5121;case 2:return 5123;case 4:return 5125;default:throw new n("Cannot get DataType of array")}})(this.indices)}}]),r}()}));
