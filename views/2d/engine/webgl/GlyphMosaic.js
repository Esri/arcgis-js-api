/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../../core/has","../../../../core/promiseUtils","../../../../chunks/builtins","../../../webgl/Texture","../../../webgl/FramebufferObject","../../../webgl/RenderingContext","./Rect","./RectangleBinPack"],(function(t,e,i,h,s,n,r,a){"use strict";const c=t=>Math.floor(t/256);return function(){function i(t,e,i){this.width=0,this.height=0,this._dirties=[],this._glyphData=[],this._currentPage=0,this._glyphCache={},this._textures=[],this._rangePromises=new Map,this.width=t,this.height=e,this._glyphSource=i,this._binPack=new a(t-4,e-4),this._glyphData.push(new Uint8Array(t*e)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyph()}var s=i.prototype;return s.dispose=function(){this._binPack=null;for(const t of this._textures)t&&t.dispose();this._textures.length=0,this._glyphData.length=0},s._initDecorationGlyph=function(){const t=[117,149,181,207,207,181,149,117],e=[];for(let i=0;i<t.length;i++){const h=t[i];for(let t=0;t<11;t++)e.push(h)}const i={metrics:{width:5,height:2,left:0,top:0,advance:0},bitmap:new Uint8Array(e)};this._recordGlyph(i)},s.getGlyphItems=async function(t,e,i){const h=this._getGlyphCache(t);return await this._fetchRanges(t,e,i),e.map((e=>this._getMosaicItem(h,t,e)))},s.bind=function(t,e,i,h){const s=this._getTexture(t,i);s.setSamplingMode(e),this._dirties[i]&&(s.setData(this._glyphData[i]),this._dirties[i]=!1),t.bindTexture(s,h)},s._getGlyphCache=function(t){return this._glyphCache[t]||(this._glyphCache[t]={}),this._glyphCache[t]},s._getTexture=function(t,e){return this._textures[e]||(this._textures[e]=new h(t,{pixelFormat:6406,dataType:5121,width:this.width,height:this.height},new Uint8Array(this.width*this.height))),this._textures[e]},s._invalidate=function(){this._dirties[this._currentPage]=!0},s._fetchRanges=async function(t,i,h){const s=function(t){const e=new Set;for(const i of t)e.add(c(i));return e}(i),n=[];s.forEach((e=>{n.push(this._fetchRange(t,e,h))})),await e.all(n)},s._fetchRange=async function(t,i,h){if(i>256)return null;const s=t+i;return n=this._rangePromises,r=s,a=()=>this._glyphSource.getRange(t,i,h),n.has(r)||n.set(r,a().then((()=>{n.delete(r)})).catch((t=>{n.delete(r),e.throwIfNotAbortError(t)}))),n.get(r);var n,r,a},s._getMosaicItem=function(t,e,i){if(!t[i]){const h=this._glyphSource.getGlyph(e,i);if(!h||!h.metrics)return(t=>({rect:new r(0,0,0,0),page:0,metrics:{left:0,width:0,height:0,advance:0,top:0},code:t,sdf:!0}))(i);const s=this._recordGlyph(h),n=this._currentPage,a=h.metrics;t[i]={rect:s,page:n,metrics:a,code:i,sdf:!0},this._invalidate()}return t[i]},s._getMosaicItemsStable=function(t,e,i){const h=[],s=i.map((t=>t));return i.map((t=>t)).sort().map((i=>this._getMosaicItem(t,e,i))).forEach((t=>{const e=s.indexOf(t.code);h[e]=t,s[e]=null})),h},s._recordGlyph=function(e){const i=e.metrics;let h;if(0===i.width)h=new r(0,0,0,0);else{const s=3,n=i.width+2*s,r=i.height+2*s;h=this._binPack.allocate(n,r),h.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyph(),this._binPack=new a(this.width-4,this.height-4),h=this._binPack.allocate(n,r));const c=this._glyphData[this._currentPage],o=e.bitmap;let l,g;if(o)for(let t=0;t<r;t++){l=n*t,g=this.width*(h.y+t)+h.x;for(let t=0;t<n;t++)c[g+t]=o[l+t]}t("esri-glyph-debug")&&this._showDebugPage(c)}return h},s._showDebugPage=function(t){const e=document.createElement("canvas"),i=e.getContext("2d"),h=new ImageData(this.width,this.height),s=h.data;e.width=this.width,e.height=this.height,e.style.border="1px solid black";for(let e=0;e<t.length;++e)s[4*e+0]=t[e],s[4*e+1]=0,s[4*e+2]=0,s[4*e+3]=255;i.putImageData(h,0,0),document.body.appendChild(e)},i}()}));
