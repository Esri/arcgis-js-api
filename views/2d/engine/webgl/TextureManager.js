/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../config","../../../../request","../../../../core/BidiText","../../../../core/Error","../../../../core/fontUtils","../../../../core/Logger","../../../../core/mathUtils","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/screenUtils","../../../../chunks/vec2","../../../../chunks/vec2f32","../../../../symbols/cim/Rasterizer","./definitions","./enums","./GlyphMosaic","./GlyphSource","./SDFConverter","./SpriteMosaic","./Utils","./animatedFormats/AnimatableTextureResource","./animatedFormats/utils","./util/Result","./util/symbolUtils","../../../support/QueueProcessor","../../../webgl/enums"],(function(e,t,i,s,n,r,o,a,u,c,h,l,d,p,g,_,f,m,y,T,I,w,M,R,S,v,P){"use strict";const x=d.create(),z="arial-unicode-ms-regular",G=126,b=o.getLogger("esri.views.2d.engine.webgl.TextureManager");function A(e,t){const i=Math.round(h.pt2px(t)*window.devicePixelRatio),s=i>=128?2:4;return Math.min(e,i*s)}const E=(e,t,i)=>b.error(new n(e,t,i));let N=function(){function e(e,t,i){this.mosaicType=e,this.page=t,this.sdf=i}return e.fromMosaic=function(t,i){return new e(t,i.page,i.sdf)},e}(),U=function(){function o(s,r,o){var a;this._requestRender=s,this.resourceManager=r,this._allowNonPowerOfTwo=o,this._invalidFontsMap=new Map,this._sdfConverter=new y(G),this._bindingInfos=new Array,this._hashToBindingIndex=new Map,this._ongoingRasterizations=new Map,this._imageRequestQueue=new v.QueueProcessor({concurrency:10,process:(a=e._asyncToGenerator((function*(e,t){c.throwIfAborted(t);try{return yield i(e,{responseType:"image",signal:t})}catch(s){if(!c.isAbortError(s))throw new n("mapview-invalid-resource",`Could not fetch requested resource at ${e}`,s);throw s}})),function(e,t){return a.apply(this,arguments)})}),this._spriteMosaic=new T(2048,2048,500),this._glyphSource=new m(`${t.fontsUrl}/{fontstack}/{range}.pbf`),this._glyphMosaic=new f(1024,1024,this._glyphSource),this._rasterizer=new p(r)}var d=o.prototype;return d.dispose=function(){this._spriteMosaic.dispose(),this._glyphMosaic.dispose(),this._rasterizer.dispose(),this._sdfConverter.dispose(),this._spriteMosaic=null,this._glyphMosaic=null,this._sdfConverter=null,this._hashToBindingIndex.clear(),this._hashToBindingIndex=null,this._bindingInfos=null,this._ongoingRasterizations.clear(),this._ongoingRasterizations=null,this._imageRequestQueue.clear(),this._imageRequestQueue=null},d.rasterizeItem=function(){var t=e._asyncToGenerator((function*(e,t,i,s){if(u.isNone(e))return E("mapview-null-resource","Unable to rasterize null resource"),null;switch(e.type){case"text":case"esriTS":{const t=yield this._rasterizeText(e,i,s);return t.forEach((e=>this._setTextureBinding(_.MosaicType.GLYPH,e))),{glyphMosaicItems:t}}default:{if(I.is3D(e))return E("mapview-invalid-type",`MapView does not support symbol type: ${e.type}`,e),null;const i=yield this._rasterizeSpriteSymbol(e,t,s);return R.ok(i)&&i&&this._setTextureBinding(_.MosaicType.SPRITE,i),{spriteMosaicItem:i}}}}));function i(e,i,s,n){return t.apply(this,arguments)}return i}(),d.bindTextures=function(e,t,i,s=!1){if(0===i.textureBinding)return;const n=this._bindingInfos[i.textureBinding-1],r=n.page,o=s?P.TextureSamplingMode.LINEAR_MIPMAP_LINEAR:P.TextureSamplingMode.LINEAR;switch(n.mosaicType){case _.MosaicType.SPRITE:{const i=this.sprites.getWidth(r),s=this.sprites.getHeight(r),n=l.set(x,i,s);return this._spriteMosaic.bind(e,o,r,g.TEXTURE_BINDING_SPRITE_ATLAS),t.setUniform1i("u_texture",g.TEXTURE_BINDING_SPRITE_ATLAS),void t.setUniform2fv("u_mosaicSize",n)}case _.MosaicType.GLYPH:{const i=this.glyphs.width,s=this.glyphs.height,n=l.set(x,i,s);return this._glyphMosaic.bind(e,o,r,g.TEXTURE_BINDING_GLYPH_ATLAS),t.setUniform1i("u_texture",g.TEXTURE_BINDING_GLYPH_ATLAS),void t.setUniform2fv("u_mosaicSize",n)}default:b.error("mapview-texture-manager",`Cannot handle unknown type ${n.mosaicType}`)}},d._hashMosaic=function(e,t){return 1|e<<1|(t.sdf?1:0)<<2|t.page<<3},d._setTextureBinding=function(e,t){const i=this._hashMosaic(e,t);if(!this._hashToBindingIndex.has(i)){const s=N.fromMosaic(e,t),n=this._bindingInfos.length+1;this._hashToBindingIndex.set(i,n),this._bindingInfos.push(s)}t.textureBinding=this._hashToBindingIndex.get(i)},d._rasterizeText=function(){var t=e._asyncToGenerator((function*(e,t,i){let n,o;if("cim"in e){const t=e;n=t.fontName,o=t.text}else{const t=e;n=r.getFullyQualifiedFontName(t.font),o=t.text}const a=this._invalidFontsMap.has(n),u=t||I.charCodes(s.bidiText(o)[0]);try{return yield this._glyphMosaic.getGlyphItems(a?z:n,u,i)}catch(c){return E("mapview-invalid-resource",`Couldn't find font ${n}. Falling back to Arial Unicode MS Regular`),this._invalidFontsMap.set(n,!0),this._glyphMosaic.getGlyphItems(z,u,i)}}));function i(e,i,s){return t.apply(this,arguments)}return i}(),d._rasterizeSpriteSymbol=function(){var t=e._asyncToGenerator((function*(e,t,i){if(I.isSimple(e))return;const s=S.keyFromSymbol(e);if(this._spriteMosaic.has(s))return this._spriteMosaic.getSpriteItem(s);if(I.isSVGResource(e)||I.isImageResource(e)&&!I.isMarkerPlacementInsidePolygon(e))return this._handleAsyncResource(s,e,i);const r=g.PATTERN_FILL_RASTERIZATION_SCALE,o=this._rasterizer.rasterizeJSONResource(e,r);if(o){const{size:t,image:i,sdf:n,simplePattern:r,rasterizationScale:a}=o;return this._addItemToMosaic(s,t,{type:"static",data:i},I.shouldRepeat(e),n,r,a)}return new n("TextureManager","unrecognized or null rasterized image")}));function i(e,i,s){return t.apply(this,arguments)}return i}(),d._handleAsyncResource=function(){var t=e._asyncToGenerator((function*(e,t,i){if(this._ongoingRasterizations.has(e))return this._ongoingRasterizations.get(e);let s;s=I.isSVGResource(t)?this._handleSVG(t,e,i):this._handleImage(t,e,i),this._ongoingRasterizations.set(e,s);try{yield s,this._ongoingRasterizations.delete(e)}catch{this._ongoingRasterizations.delete(e)}return s}));function i(e,i,s){return t.apply(this,arguments)}return i}(),d._handleSVG=function(){var t=e._asyncToGenerator((function*(e,t,i){const s=[G,G],n=yield this._sdfConverter.draw(e.path,i);return this._addItemToMosaic(t,s,{type:"static",data:new Uint32Array(n.buffer)},!1,!0,!0)}));function i(e,i,s){return t.apply(this,arguments)}return i}(),d._handleGIFOrPNG=function(){var t=e._asyncToGenerator((function*(e,t,i){const s=I.getUrl(e);yield this.resourceManager.fetchResource(s,i);let r=this.resourceManager.getResource(s);if(u.isNone(r))return new n("mapview-invalid-resource",`Could not fetch requested resource at ${s}.`);let o=r.width,c=r.height;if(r instanceof HTMLImageElement){"esriPMS"===e.type&&(o=Math.round(A(r.width,I.getPMSResourceSize(e))),c=Math.round(r.height*(o/r.width)));const i="cim"in e?e.cim.colorSubstitutions:void 0,{size:s,sdf:n,image:a}=this._rasterizer.rasterizeImageResource(o,c,r,i);return this._addItemToMosaic(t,s,{type:"static",data:a},I.shouldRepeat(e),n,!1)}this._allowNonPowerOfTwo||(o=a.nextPowerOfTwo(r.width+2*g.SPRITE_PADDING)-2*g.SPRITE_PADDING,c=a.nextPowerOfTwo(r.height+2*g.SPRITE_PADDING)-2*g.SPRITE_PADDING),o===r.width&&c===r.height||(r=M.resize(r,o,c));const h=e.animatedSymbolProperties||{},l=e.objectId,d=new w.AnimatableTextureResource(r,this._requestRender,h,l);return this._addItemToMosaic(t,[d.width,d.height],{type:"animated",data:d},I.shouldRepeat(e),!1,!1)}));function i(e,i,s){return t.apply(this,arguments)}return i}(),d._handleImage=function(){var t=e._asyncToGenerator((function*(e,t,i){if(I.isGIF(e)||I.isPNG(e))return this._handleGIFOrPNG(e,t,i);const s=I.getUrl(e);try{let n;const r=this.resourceManager.getResource(s);if(u.isSome(r)&&r instanceof HTMLImageElement)n=r;else{const{data:e}=yield this._imageRequestQueue.push(s,{...i});n=e}if(I.isSVGImage(s))if("width"in e&&"height"in e)n.width=h.pt2px(e.width),n.height=h.pt2px(e.height);else if("cim"in e){const t=e.cim;n.width=h.pt2px(t.width??t.scaleX*t.size),n.height=h.pt2px(t.size)}if(!n.width||!n.height)return null;let o=n.width,a=n.height;"esriPMS"===e.type&&(o=Math.round(A(n.width,I.getPMSResourceSize(e))),a=Math.round(n.height*(o/n.width)));const c="cim"in e?e.cim.colorSubstitutions:void 0,{size:l,sdf:d,image:p}=this._rasterizer.rasterizeImageResource(o,a,n,c);return this._addItemToMosaic(t,l,{type:"static",data:p},I.shouldRepeat(e),d,!1)}catch(r){if(!c.isAbortError(r))return new n("mapview-invalid-resource",`Could not fetch requested resource at ${s}. ${r.message}`)}}));function i(e,i,s){return t.apply(this,arguments)}return i}(),d._addItemToMosaic=function(e,t,i,s,n,r,o){return this._spriteMosaic.addSpriteItem(e,t,i,s,n,r,o)},e._createClass(o,[{key:"sprites",get:function(){return this._spriteMosaic}},{key:"glyphs",get:function(){return this._glyphMosaic}}]),o}();return U}));
