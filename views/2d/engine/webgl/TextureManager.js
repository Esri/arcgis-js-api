// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../config","../../../../request","../../../../core/Error","../../../../core/Logger","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/vec2","../../../../core/libs/gl-matrix-2/vec2f32","../../../../symbols/cim/Rasterizer","./definitions","./enums","./fontUtils","./GlyphMosaic","./GlyphSource","./SDFConverter","./SpriteMosaic","./animatedFormats/apng","./animatedFormats/gif","./util/BidiText","./util/Result","./util/symbolUtils"],(function(e,t,r,i,s,n,a,o,u,c,l,d,h,p,f,g,_,m,y,v,w,b,S,M,T){"use strict";var I=d.vec2f32.create(),x=a.getLogger("esri.views.2d.engine.webgl.TextureManager");function G(e){switch(e.type){case"esriSMS":case"esriPMS":case"CIMPointSymbol":case"CIMVectorMarker":case"CIMPictureMarker":case"CIMCharacterMarker":return!1;default:return!0}}function z(e){return r.__awaiter(this,void 0,void 0,(function(){var t,i;return r.__generator(this,(function(r){switch(r.label){case 0:t=window.URL.createObjectURL(e),r.label=1;case 1:return r.trys.push([1,3,,4]),[4,s(t,{responseType:"image"})];case 2:return i=r.sent().data,window.URL.revokeObjectURL(t),[2,i];case 3:return r.sent(),window.URL.revokeObjectURL(t),[2,new n("mapview-invalid-resource","Could not fetch requested resource at "+t)];case 4:return[2]}}))}))}function C(e,t){return r.__awaiter(this,void 0,void 0,(function(){var i,a,o,c,l,d,h,p,f;return r.__generator(this,(function(g){switch(g.label){case 0:if(i=e.imageData?"data:"+e.contentType+";base64,"+e.imageData:e.url,";base64,",-1===i.indexOf(";base64,"))return[3,1];for(o=i.indexOf(";base64,")+";base64,".length,c=i.substring(o),l=atob(c),d=new Uint8Array(l.length),h=0;h<l.length;h++)d[h]=l.charCodeAt(h);return a=d.buffer,[3,4];case 1:return g.trys.push([1,3,,4]),[4,s(i,r.__assign({responseType:"array-buffer"},t))];case 2:return p=g.sent().data,a=p,[3,4];case 3:return f=g.sent(),u.isAbortError(f)?[3,4]:[2,new n("mapview-invalid-resource","Could not fetch requested resource at "+i)];case 4:return[2,a]}}))}))}var U=function(e,t,r){return x.error(new n(e,t,r))},L=function(){function e(e,t,r){this.mosaicType=e,this.page=t,this.sdf=r}return e.fromMosaic=function(t,r){return new e(t,r.page,r.sdf)},e}();return function(){function e(e){this._invalidFontsMap=new Map,this._sdfConverter=new y.default(126),this._bindingInfos=new Array,this._hashToBindingIndex=new Map,this._rasterizer=new h.default,this._spriteMosaic=new v(e,2048,2048,500),this._glyphSource=new m(i.fontsUrl+"/{fontstack}/{range}.pbf"),this._glyphMosaic=new _(1024,1024,this._glyphSource)}return e.prototype.dispose=function(){this._spriteMosaic.dispose(),this._glyphMosaic.dispose(),this._rasterizer.dispose(),this._sdfConverter.dispose(),this._spriteMosaic=null,this._glyphMosaic=null,this._rasterizer=null,this._sdfConverter=null,this._hashToBindingIndex.clear(),this._hashToBindingIndex=null,this._bindingInfos=null},Object.defineProperty(e.prototype,"sprites",{get:function(){return this._spriteMosaic},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"glyphs",{get:function(){return this._glyphMosaic},enumerable:!1,configurable:!0}),e.prototype.rasterizeItem=function(e,t,i,s){return r.__awaiter(this,void 0,void 0,(function(){var n,a,u=this;return r.__generator(this,(function(r){switch(r.label){case 0:if(o.isNone(e))return U("mapview-null-resource","Unable to rasterize null resource"),[2,null];switch(e.type){case"CIMTextSymbol":case"esriTS":return[3,1];case"esriSMS":case"esriPMS":case"esriSFS":case"esriPFS":case"esriSLS":return[3,3]}return[3,3];case 1:return[4,this._rasterizeText(e,i,s)];case 2:return(n=r.sent()).forEach((function(e){return u._setTextureBinding(f.MosaicType.GLYPH,e)})),[2,{glyphMosaicItems:n}];case 3:return(c=e).type&&-1!==c.type.toLowerCase().indexOf("3d")?(U("mapview-invalid-type","MapView does not support symbol type: "+e.type,e),[2,null]):[4,this._rasterizeSpriteSymbol(e,t,s)];case 4:return a=r.sent(),M.ok(a)&&a&&this._setTextureBinding(f.MosaicType.SPRITE,a),[2,{spriteMosaicItem:a}]}var c}))}))},e.prototype.bindTextures=function(e,t,r){if(0!==r.textureBinding){var i=this._bindingInfos[r.textureBinding-1],s=i.page;switch(i.mosaicType){case f.MosaicType.SPRITE:var n=this.sprites.getWidth(s),a=this.sprites.getHeight(s),o=l.vec2.set(I,n,a);return this._spriteMosaic.bind(e,9729,s,p.TEXTURE_BINDING_SPRITE_ATLAS),t.setUniform1i("u_texture",p.TEXTURE_BINDING_SPRITE_ATLAS),void t.setUniform2fv("u_mosaicSize",o);case f.MosaicType.GLYPH:n=this.glyphs.width,a=this.glyphs.height,o=l.vec2.set(I,n,a);return this._glyphMosaic.bind(e,9729,s,p.TEXTURE_BINDING_GLYPH_ATLAS),t.setUniform1i("u_texture",p.TEXTURE_BINDING_GLYPH_ATLAS),void t.setUniform2fv("u_mosaicSize",o);default:x.error("mapview-texture-manager","Cannot handle unknown type "+i.mosaicType)}}},e.prototype._hashMosaic=function(e,t){return 1|e<<1|(t.sdf?1:0)<<2|t.page<<3},e.prototype._setTextureBinding=function(e,t){var r=this._hashMosaic(e,t);if(!this._hashToBindingIndex.has(r)){var i=L.fromMosaic(e,t),s=this._bindingInfos.length+1;this._hashToBindingIndex.set(r,s),this._bindingInfos.push(i)}t.textureBinding=this._hashToBindingIndex.get(r)},e.prototype._rasterizeText=function(e,t,i){return r.__awaiter(this,void 0,void 0,(function(){var s,n,a;return r.__generator(this,(function(r){switch(r.label){case 0:s=g.getFullyQualifiedFontName(e.font),n=this._invalidFontsMap.has(s),a=t||function(e){for(var t=[],r=0;r<e.length;r++)t.push(e.charCodeAt(r));return t}(S.bidiText(e.text)[0]),r.label=1;case 1:return r.trys.push([1,3,,4]),[4,this._glyphMosaic.getGlyphItems(n?"arial-unicode-ms-regular":s,a,i)];case 2:return[2,r.sent()];case 3:return r.sent(),U("mapview-invalid-resource","Couldn't find font "+s+". Falling back to Arial Unicode MS Regular"),this._invalidFontsMap.set(s,!0),[2,this._glyphMosaic.getGlyphItems("arial-unicode-ms-regular",a,i)];case 4:return[2]}}))}))},e.prototype._rasterizeSpriteSymbol=function(e,t,i){return r.__awaiter(this,void 0,void 0,(function(){var s,a,o,u,c,l;return r.__generator(this,(function(r){return function(e){switch(e.type){case"CIMSolidStroke":case"CIMSolidFill":return!0;case"esriSFS":return"esriSFSSolid"===e.style||"esriSFSNull"===e.style;case"esriSLS":return"esriSLSSolid"===e.style||"esriSLSNull"===e.style;default:return!1}}(e)?[2,null]:(s=T.keyFromSymbol(e),this._spriteMosaic.has(s)?[2,this._spriteMosaic.getSpriteItem(s)]:function(e){return"esriSMS"===e.type&&e.path}(e)?[2,this._handleSVG(e,s,i)]:function(e){return e.url||e.imageData}(e)?[2,this._handleImage(e,s,i)]:(a=this._rasterizer.rasterizeJSONResource(e,t))?(o=a.size,u=a.image,c=a.sdf,l=a.simplePattern,[2,this._addItemToMosaic(s,o,{type:"static",data:u},G(e),c,l)]):[2,new n("TextureManager","unrecognized or null rasterized image")])}))}))},e.prototype._handleSVG=function(e,t,i){return r.__awaiter(this,void 0,void 0,(function(){var s,n;return r.__generator(this,(function(r){switch(r.label){case 0:return s=[126,126],[4,this._sdfConverter.draw(e.path,i)];case 1:return n=r.sent(),[2,this._addItemToMosaic(t,s,{type:"static",data:new Uint32Array(n.buffer)},!1,!0,!0)]}}))}))},e.prototype._handleGIFOrPNG=function(e,t,i){return r.__awaiter(this,void 0,void 0,(function(){var s,a,o,c,l,d,h,p,f,g;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,C(e,i)];case 1:if(s=r.sent(),!M.ok(s))return[3,10];if(a=b.isGIF(s),o=w.isPNG(s),!a&&!o)return[2,new n("mapview-invalid-resource","Image data is neither GIF nor PNG!")];c=void 0,r.label=2;case 2:return r.trys.push([2,7,,8]),a&&b.isAnimatedGIF(s)?[4,b.default.create(s,i)]:[3,4];case 3:return c=r.sent(),[3,6];case 4:return o&&w.isAnimatedPNG(s)?[4,w.default.create(s,i)]:[3,6];case 5:c=r.sent(),r.label=6;case 6:return[3,8];case 7:return l=r.sent(),u.isAbortError(l)?[3,8]:[2,new n("mapview-invalid-resource","Could not fetch requested resource!")];case 8:return c&&M.ok(c)?[2,this._addItemToMosaic(t,[c.width,c.height],{type:"animated",data:c},G(e),!1,!1)]:[4,z(new Blob([s],{type:a?"image/gif":"image/png"}))];case 9:if((d=r.sent())&&d instanceof HTMLImageElement)return h=this._rasterizer.rasterizeImageResource(d,e.colorSubstitutions),p=h.size,f=h.sdf,g=h.image,[2,this._addItemToMosaic(t,p,{type:"static",data:g},G(e),f,!1)];r.label=10;case 10:return[2,new n("mapview-invalid-resource","Could not handle resource!")]}}))}))},e.prototype._handleImage=function(e,t,i){return r.__awaiter(this,void 0,void 0,(function(){var a,o,l,d,h,p,f;return r.__generator(this,(function(g){switch(g.label){case 0:if(function(e){return e.url&&-1!==e.url.indexOf(".gif")||e.contentType&&"image/gif"===e.contentType||e.imageData&&-1!==e.imageData.indexOf("data:image/gif")}(e)||function(e){return e.url&&-1!==e.url.indexOf(".png")||e.contentType&&"image/png"===e.contentType||e.imageData&&-1!==e.imageData.indexOf("data:image/png")}(e))return[2,this._handleGIFOrPNG(e,t,i)];a=e.imageData?"data:"+e.contentType+";base64,"+e.imageData:e.url,g.label=1;case 1:return g.trys.push([1,3,,4]),[4,s(a,r.__assign({responseType:"image"},i))];case 2:return o=g.sent().data,-1!==a.indexOf("data:image/svg+xml")&&(o.width=c.pt2px(e.width),o.height=c.pt2px(e.height)),l=this._rasterizer.rasterizeImageResource(o,e.colorSubstitutions),d=l.size,h=l.sdf,p=l.image,[2,this._addItemToMosaic(t,d,{type:"static",data:p},G(e),h,!1)];case 3:return f=g.sent(),u.isAbortError(f)?[3,4]:[2,new n("mapview-invalid-resource","Could not fetch requested resource at "+a)];case 4:return[2,void 0]}}))}))},e.prototype._addItemToMosaic=function(e,t,r,i,s,n){return this._spriteMosaic.addSpriteItem(e,t,r,i,s,n)},e}()}));