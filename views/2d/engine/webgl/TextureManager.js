/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../config","../../../../request","../../../../core/Error","../../../../core/Logger","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/screenUtils","../../../../chunks/vec2","../../../../chunks/vec2f32","../../../../symbols/cim/Rasterizer","./definitions","./enums","./fontUtils","./GlyphMosaic","./GlyphSource","./SDFConverter","./SpriteMosaic","./animatedFormats/apng","./animatedFormats/gif","./util/BidiText","./util/Result","./util/symbolUtils","../../../support/QueueProcessor"],(function(e,t,i,n,r,s,a,o,u,c,h,l,d,p,g,f,y,_,m,w,T,M,S,I){"use strict";const v=c.create(),b="arial-unicode-ms-regular",x=126,R=r.getLogger("esri.views.2d.engine.webgl.TextureManager"),G=e=>"esriSMS"===e.type&&e.path,z=e=>e.url||e.imageData,C=e=>e.url&&-1!==e.url.indexOf(".gif")||e.contentType&&"image/gif"===e.contentType||e.imageData&&-1!==e.imageData.indexOf("data:image/gif"),A=e=>e.url&&-1!==e.url.indexOf(".png")||e.contentType&&"image/png"===e.contentType||e.imageData&&-1!==e.imageData.indexOf("data:image/png"),P=e=>e.type&&-1!==e.type.toLowerCase().indexOf("3d");function U(e){switch(e.type){case"CIMSolidStroke":case"CIMSolidFill":return!0;case"esriSFS":return"esriSFSSolid"===e.style||"esriSFSNull"===e.style;case"esriSLS":return"esriSLSSolid"===e.style||"esriSLSNull"===e.style;default:return!1}}const B=e=>-1!==e.indexOf("data:image/svg+xml");function F(e){switch(e.type){case"esriSMS":case"esriPMS":case"CIMPointSymbol":case"CIMVectorMarker":case"CIMPictureMarker":case"CIMCharacterMarker":return!1;default:return!0}}function L(e){const t="maxVVSize"in e&&e.maxVVSize;return t||e.width}function E(e){const t=[];for(let i=0;i<e.length;i++)t.push(e.charCodeAt(i));return t}function k(e,t){return N.apply(this,arguments)}function N(){return(N=e._asyncToGenerator((function*(e,t){const r=e.imageData?`data:${e.contentType};base64,${e.imageData}`:e.url;let s;const o=";base64,";if(-1!==r.indexOf(o)){const e=r.indexOf(o)+o.length,t=r.substring(e),i=atob(t),n=new Uint8Array(i.length);for(let r=0;r<i.length;r++)n[r]=i.charCodeAt(r);s=n.buffer}else try{const{data:e}=yield i(r,{responseType:"array-buffer",...t});s=e}catch(u){if(!a.isAbortError(u))return new n("mapview-invalid-resource",`Could not fetch requested resource at ${r}`)}return s}))).apply(this,arguments)}function D(e,t){const i=Math.round(o.pt2px(t)*window.devicePixelRatio),n=i>=128?2:4;return Math.min(e,i*n)}const O=(e,t,i)=>R.error(new n(e,t,i));let $=function(){function e(e,t,i){this.mosaicType=e,this.page=t,this.sdf=i}return e.fromMosaic=function(t,i){return new e(t,i.page,i.sdf)},e}(),q=function(){function r(r){var s;this._invalidFontsMap=new Map,this._sdfConverter=new y(x),this._bindingInfos=new Array,this._hashToBindingIndex=new Map,this._rasterizer=new h,this._ongoingRasterizations=new Map,this._imageRequestQueue=new I.QueueProcessor({concurrency:10,process:(s=e._asyncToGenerator((function*(e,t){a.throwIfAborted(t);try{return yield i(e,{responseType:"image",signal:t})}catch(r){if(!a.isAbortError(r))throw new n("mapview-invalid-resource",`Could not fetch requested resource at ${e}`,r);throw r}})),function(e,t){return s.apply(this,arguments)})}),this._spriteMosaic=new _(r,2048,2048,500),this._glyphSource=new f(`${t.fontsUrl}/{fontstack}/{range}.pbf`),this._glyphMosaic=new g(1024,1024,this._glyphSource)}var c=r.prototype;return c.dispose=function(){this._spriteMosaic.dispose(),this._glyphMosaic.dispose(),this._rasterizer.dispose(),this._sdfConverter.dispose(),this._spriteMosaic=null,this._glyphMosaic=null,this._rasterizer=null,this._sdfConverter=null,this._hashToBindingIndex.clear(),this._hashToBindingIndex=null,this._bindingInfos=null,this._ongoingRasterizations.clear(),this._ongoingRasterizations=null,this._imageRequestQueue.clear(),this._imageRequestQueue=null},c.rasterizeItem=function(){var t=e._asyncToGenerator((function*(e,t,i,n){if(s.isNone(e))return O("mapview-null-resource","Unable to rasterize null resource"),null;switch(e.type){case"CIMTextSymbol":case"esriTS":{const t=yield this._rasterizeText(e,i,n);return t.forEach((e=>this._setTextureBinding(d.MosaicType.GLYPH,e))),{glyphMosaicItems:t}}default:{if(P(e))return O("mapview-invalid-type",`MapView does not support symbol type: ${e.type}`,e),null;const i=yield this._rasterizeSpriteSymbol(e,t,n);return M.ok(i)&&i&&this._setTextureBinding(d.MosaicType.SPRITE,i),{spriteMosaicItem:i}}}}));function i(e,i,n,r){return t.apply(this,arguments)}return i}(),c.bindTextures=function(e,t,i,n=!1){if(0===i.textureBinding)return;const r=this._bindingInfos[i.textureBinding-1],s=r.page,a=n?9987:9729;switch(r.mosaicType){case d.MosaicType.SPRITE:{const i=this.sprites.getWidth(s),n=this.sprites.getHeight(s),r=u.set(v,i,n);return this._spriteMosaic.bind(e,a,s,l.TEXTURE_BINDING_SPRITE_ATLAS),t.setUniform1i("u_texture",l.TEXTURE_BINDING_SPRITE_ATLAS),void t.setUniform2fv("u_mosaicSize",r)}case d.MosaicType.GLYPH:{const i=this.glyphs.width,n=this.glyphs.height,r=u.set(v,i,n);return this._glyphMosaic.bind(e,a,s,l.TEXTURE_BINDING_GLYPH_ATLAS),t.setUniform1i("u_texture",l.TEXTURE_BINDING_GLYPH_ATLAS),void t.setUniform2fv("u_mosaicSize",r)}default:R.error("mapview-texture-manager",`Cannot handle unknown type ${r.mosaicType}`)}},c._hashMosaic=function(e,t){return 1|e<<1|(t.sdf?1:0)<<2|t.page<<3},c._setTextureBinding=function(e,t){const i=this._hashMosaic(e,t);if(!this._hashToBindingIndex.has(i)){const n=$.fromMosaic(e,t),r=this._bindingInfos.length+1;this._hashToBindingIndex.set(i,r),this._bindingInfos.push(n)}t.textureBinding=this._hashToBindingIndex.get(i)},c._rasterizeText=function(){var t=e._asyncToGenerator((function*(e,t,i){const n=p.getFullyQualifiedFontName(e.font),r=this._invalidFontsMap.has(n),s=t||E(T.bidiText(e.text)[0]);try{return yield this._glyphMosaic.getGlyphItems(r?b:n,s,i)}catch(a){return O("mapview-invalid-resource",`Couldn't find font ${n}. Falling back to Arial Unicode MS Regular`),this._invalidFontsMap.set(n,!0),this._glyphMosaic.getGlyphItems(b,s,i)}}));function i(e,i,n){return t.apply(this,arguments)}return i}(),c._rasterizeSpriteSymbol=function(){var t=e._asyncToGenerator((function*(e,t,i){if(U(e))return null;const r=S.keyFromSymbol(e);if(this._spriteMosaic.has(r))return this._spriteMosaic.getSpriteItem(r);if(G(e)||z(e))return this._handleAsyncResource(r,e,i);const s=1,a=this._rasterizer.rasterizeJSONResource(e,s);if(a){const{size:t,image:i,sdf:n,simplePattern:s}=a;return this._addItemToMosaic(r,t,{type:"static",data:i},F(e),n,s)}return new n("TextureManager","unrecognized or null rasterized image")}));function i(e,i,n){return t.apply(this,arguments)}return i}(),c._handleAsyncResource=function(){var t=e._asyncToGenerator((function*(e,t,i){if(this._ongoingRasterizations.has(e))return this._ongoingRasterizations.get(e);let n;n=G(t)?this._handleSVG(t,e,i):this._handleImage(t,e,i),this._ongoingRasterizations.set(e,n);try{yield n,this._ongoingRasterizations.delete(e)}catch{this._ongoingRasterizations.delete(e)}return n}));function i(e,i,n){return t.apply(this,arguments)}return i}(),c._handleSVG=function(){var t=e._asyncToGenerator((function*(e,t,i){const n=[x,x],r=yield this._sdfConverter.draw(e.path,i);return this._addItemToMosaic(t,n,{type:"static",data:new Uint32Array(r.buffer)},!1,!0,!0)}));function i(e,i,n){return t.apply(this,arguments)}return i}(),c._handleGIFOrPNG=function(){var t=e._asyncToGenerator((function*(e,t,i){const r=yield k(e,i);if(M.ok(r)){const o=w.isGIF(r),u=m.isPNG(r);if(!o&&!u)return new n("mapview-invalid-resource","Image data is neither GIF nor PNG!");let c;try{o&&w.isAnimatedGIF(r)?c=yield w.default.create(r,i):u&&m.isAnimatedPNG(r)&&(c=yield m.default.create(r,i))}catch(s){if(!a.isAbortError(s))return new n("mapview-invalid-resource","Could not fetch requested resource!")}if(c&&M.ok(c))return this._addItemToMosaic(t,[c.width,c.height],{type:"animated",data:c},F(e),!1,!1);const h=new Blob([r],{type:o?"image/gif":"image/png"}),l=yield this._imageFromBlob(h);if(l&&l instanceof HTMLImageElement){let i=l.width,n=l.height;"esriPMS"===e.type&&(i=Math.round(D(l.width,L(e))),n=Math.round(l.height*(i/l.width)));const{size:r,sdf:s,image:a}=this._rasterizer.rasterizeImageResource(i,n,l,e.colorSubstitutions);return this._addItemToMosaic(t,r,{type:"static",data:a},F(e),s,!1)}}return new n("mapview-invalid-resource","Could not handle resource!")}));function i(e,i,n){return t.apply(this,arguments)}return i}(),c._handleImage=function(){var t=e._asyncToGenerator((function*(e,t,i){if(C(e)||A(e))return this._handleGIFOrPNG(e,t,i);const r=e.imageData?`data:${e.contentType};base64,${e.imageData}`:e.url;try{const{data:n}=yield this._imageRequestQueue.push(r,{...i});B(r)&&(n.width=o.pt2px(e.width),n.height=o.pt2px(e.height));let s=n.width,a=n.height;"esriPMS"===e.type&&(s=Math.round(D(n.width,L(e))),a=Math.round(n.height*(s/n.width)));const{size:u,sdf:c,image:h}=this._rasterizer.rasterizeImageResource(s,a,n,e.colorSubstitutions);return this._addItemToMosaic(t,u,{type:"static",data:h},F(e),c,!1)}catch(s){if(!a.isAbortError(s))return new n("mapview-invalid-resource",`Could not fetch requested resource at ${r}. ${s.message}`)}}));function i(e,i,n){return t.apply(this,arguments)}return i}(),c._imageFromBlob=function(){var t=e._asyncToGenerator((function*(e){const t=window.URL.createObjectURL(e);try{const{data:e}=yield this._imageRequestQueue.push(t);return window.URL.revokeObjectURL(t),e}catch(i){if(window.URL.revokeObjectURL(t),!a.isAbortError(i))return new n("mapview-invalid-resource",`Could not fetch requested resource at ${t}`);throw i}}));function i(e){return t.apply(this,arguments)}return i}(),c._addItemToMosaic=function(e,t,i,n,r,s){return this._spriteMosaic.addSpriteItem(e,t,i,n,r,s)},e._createClass(r,[{key:"sprites",get:function(){return this._spriteMosaic}},{key:"glyphs",get:function(){return this._glyphMosaic}}]),r}();return q}));
