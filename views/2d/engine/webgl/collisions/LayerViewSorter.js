/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../../core/Logger","../../../../../core/Error"],(function(e,r,t){"use strict";const i=r.getLogger("esri.views.2d.engine.collisions.LayerViewSorter");function a(e){return"esri.views.2d.layers.FeatureLayerView2D"===e.declaredClass||"esri.views.2d.layers.StreamLayerView2D"===e.declaredClass}function s(e){if(!e.layer||!e.layer.renderer)return!1;switch(e.layer.renderer.type){case"class-breaks":case"simple":case"unique-value":case"dictionary":case"dot-density":return!0;default:return i.error(new t("mapview-labeling",`Renderer of type ${e.layer.renderer.type} does not currently support labeling`)),!1}}let n=function(){function e(e,r){this.registerLayer=e,this.unregisterLayer=r,this._layerViewState=new Map}var r=e.prototype;return r.findIndex=function(e){return e.view.allLayerViews.findIndex((r=>r.uid===e.uid))},r.update=function(e){const{added:r,removed:t}=e;for(const e of t)a(e)&&this._layerViewState.has(e)&&this._deleteState(e);for(const e of r)a(e)&&s(e)&&!this._layerViewState.has(e)&&this._createState(e);this._recomputeOrder()},r.destroy=function(){this._layerViewState.forEach((e=>e.handles.forEach((e=>e.remove()))))},r._createState=function(e){const r={priority:-1,handles:null};return r.handles=[e.layer.watch("visible",this._recomputeOrder.bind(this)),e.layer.watch("labelsVisible",this._recomputeOrder.bind(this)),e.layer.watch("labelingInfo",this._recomputeOrder.bind(this)),e.layer.watch("featureReduction",this._recomputeOrder.bind(this))],this._layerViewState.set(e,r),r},r._deleteState=function(e){if(!this._layerViewState.has(e))return;const r=this._layerViewState.get(e);r.handles.forEach((e=>e.remove())),-1!==r.priority&&this.unregisterLayer(e),this._layerViewState.delete(e)},r._recomputeOrder=function(){this._layerViewState.forEach(((e,r)=>{const t=r.view.map.allLayers.findIndex((e=>e.uid===r.layer.uid)),i=r.layer,a=i.featureReduction,s=a&&"cluster"===a.type&&a.labelsVisible&&a.labelingInfo&&a.labelingInfo.length,n=i.labelsVisible&&i.labelingInfo&&i.labelingInfo.length||s,l=i.visible&&n?4294967295-t:-1;l!==e.priority&&(e.priority=l,this.unregisterLayer(r),-1!==l&&this.registerLayer(r,l))}))},e}();e.LayerViewSorter=n,Object.defineProperty(e,"__esModule",{value:!0})}));
