/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../../core/Logger","../../../../../core/Error"],(function(e,r,t){"use strict";const i=4294967295,a=-1,s=r.getLogger("esri.views.2d.engine.collisions.LayerViewSorter");function n(e){return"esri.views.2d.layers.FeatureLayerView2D"===e.declaredClass||"esri.views.2d.layers.StreamLayerView2D"===e.declaredClass}function l(e){if(!e.layer||!e.layer.renderer)return!1;switch(e.layer.renderer.type){case"class-breaks":case"simple":case"unique-value":case"dictionary":case"dot-density":return!0;default:return s.error(new t("mapview-labeling",`Renderer of type ${e.layer.renderer.type} does not currently support labeling`)),!1}}let o=function(){function e(e,r){this.registerLayer=e,this.unregisterLayer=r,this._layerViewState=new Map}var r=e.prototype;return r.findIndex=function(e){return e.view.allLayerViews.findIndex((r=>r.uid===e.uid))},r.update=function(e){const{added:r,removed:t}=e;for(const i of t)n(i)&&this._layerViewState.has(i)&&this._deleteState(i);for(const i of r)n(i)&&l(i)&&!this._layerViewState.has(i)&&this._createState(i);this._recomputeOrder()},r.destroy=function(){this._layerViewState.forEach((e=>e.handles.forEach((e=>e.remove()))))},r._createState=function(e){const r={priority:-1,handles:null};return r.handles=[e.layer.watch("visible",this._recomputeOrder.bind(this)),e.layer.watch("labelsVisible",this._recomputeOrder.bind(this)),e.layer.watch("labelingInfo",this._recomputeOrder.bind(this)),e.layer.watch("featureReduction",this._recomputeOrder.bind(this))],this._layerViewState.set(e,r),r},r._deleteState=function(e){if(!this._layerViewState.has(e))return;const r=this._layerViewState.get(e);r.handles.forEach((e=>e.remove())),r.priority!==a&&this.unregisterLayer(e),this._layerViewState.delete(e)},r._recomputeOrder=function(){this._layerViewState.forEach(((e,r)=>{const t=r.view.map.allLayers.findIndex((e=>e.uid===r.layer.uid)),s=r.layer,n=s.featureReduction,l=n&&"cluster"===n.type&&n.labelsVisible&&n.labelingInfo&&n.labelingInfo.length,o=s.labelsVisible&&s.labelingInfo&&s.labelingInfo.length||l,d=s.visible&&o?i-t:a;d!==e.priority&&(e.priority=d,this.unregisterLayer(r),d!==a&&this.registerLayer(r,d))}))},e}();e.LayerViewSorter=o,Object.defineProperty(e,"__esModule",{value:!0})}));
