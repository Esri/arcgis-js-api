/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../../../core/maybe","../../../../../core/screenUtils","../definitions","./CollisionGrid","./visualVariableSimpleUtils"],(function(e,t,i,n,o,r){"use strict";const s=254,l=255,a=0;function c(e,i){const n=[];e.forEachTile((e=>n.push(e))),n.sort(((e,t)=>e.instanceId-t.instanceId)),n.forEach((e=>{t.isSome(e.labelMetrics)&&e.isReady&&i(e,e.labelMetrics.getCursor())}))}function u(e){return"feature"===e.layer.type||"csv"===e.layer.type||"geojson"===e.layer.type||"ogc-feature"===e.layer.type||"stream"===e.layer.type||"subtype-group"===e.layer.type||"wfs"===e.layer.type}function d(e){return t=>i.pt2px(r.getSizeForValueSimple(t,e))}function f(e){const t="visualVariables"in e&&e.visualVariables;if(!t)return null;for(const i of t)if("size"===i.type)return d(i);return null}function b(e){for(const t of e){const e=t.labelingInfo||[];if(!t.labelsVisible||!e.length)continue;if(e.some((e=>"none"===e.deconflictionStrategy)))return!0}return!1}function y(e,i){if(!u(i))return;const n="subtype-group"===i.layer.type?i.layer.sublayers.items:[i.layer],o=i.layer.geometryType,r=!b(n),s={};if("subtype-group"!==i.layer.type){if("heatmap"===i.layer.renderer.type)return;const e=f(i.layer.renderer);s[0]=e}const l=i.tileRenderer;t.isNone(l)||e.push({tileRenderer:l,vvEvaluators:s,deconflictionEnabled:r,geometryType:o})}let p=function(){function e(){}var i=e.prototype;return i.run=function(e,t,i){const n=[];for(const o of e)y(n,o);this._transformMetrics(n,t),this._runCollision(n,t,i)},i._runCollision=function(e,t,i){const[n,r]=t.state.size,s=new o.CollisionBitsetGrid(n,r);for(const{tileRenderer:o,deconflictionEnabled:l}of e){const e=o.featuresView.attributeView;if(!l)return void c(o,((t,i)=>{for(;i.nextId();)e.setLabelMinZoom(i.id,a)}));this._prepare(o),this._collideVisible(s,o,i),this._collideInvisible(s,o)}},i._isFiltered=function(e,t,i){const o=t.getFilterFlags(e),r=!i.hasFilter||!!(o&n.FILTER_FLAG_0),s=!i.effect||i.effect.excludedLabelsVisible||!!(o&n.EFFECT_FLAG_0);return!(r&&s)},i._prepare=function(e){const t=e.featuresView.attributeView,i=new Set;c(e,((n,o)=>{for(;o.nextId();){if(i.has(o.id))continue;if(i.add(o.id),this._isFiltered(o.id,t,e.layerView)){t.setLabelMinZoom(o.id,s);continue}t.getLabelMinZoom(o.id)!==a?t.setLabelMinZoom(o.id,l):t.setLabelMinZoom(o.id,a)}}))},i._collideVisible=function(e,t,i){const n=t.featuresView.attributeView,r=new Set;c(t,((t,l)=>{for(;l.nextId();)if(!r.has(l.id))if(t.key.level===i){if(0===n.getLabelMinZoom(l.id)){switch(e.insertMetrics(l)){case o.OUTSIDE_EXTENT:break;case o.HAS_COLLISION:n.setLabelMinZoom(l.id,s),r.add(l.id);break;case o.NONE:n.setLabelMinZoom(l.id,a),r.add(l.id)}}}else n.setLabelMinZoom(l.id,s)}))},i._collideInvisible=function(e,t){const i=t.featuresView.attributeView,n=new Set;c(t,((t,r)=>{for(;r.nextId();)if(!n.has(r.id)&&i.getLabelMinZoom(r.id)===l){switch(e.insertMetrics(r)){case o.OUTSIDE_EXTENT:break;case o.HAS_COLLISION:i.setLabelMinZoom(r.id,l),n.add(r.id);break;case o.NONE:i.setLabelMinZoom(r.id,a),n.add(r.id)}}}))},i._transformMetrics=function(e,i){for(const{tileRenderer:n,geometryType:o,vvEvaluators:r}of e)c(n,((e,s)=>{const l=n.featuresView.attributeView,a=e.transforms.labelMat2d;a[4]=Math.round(a[4]),a[5]=Math.round(a[5]);const c=a[4],u=a[5],d="polyline"===o;for(;s.next();){const e=s.boundsCount,n=s.anchorX,o=s.anchorY;let f=0,b=0;const y=r[0];if(t.isSome(y)){const e=y(l.getVVSize(s.id)),t=isNaN(e)||null==e||e===1/0?s.size:e;f=s.directionX*(t/2),b=s.directionY*(t/2)}for(let t=0;t<e;t++){let e=n,r=s.anchorY;if(d){let n=e+s.boundsCenterX(t)+f,o=r+s.boundsCenterY(t)+b;i.state.rotation?(n=a[0]*n+a[2]*o+a[4],o=a[1]*n+a[3]*o+a[5]):(n+=c,o+=u),s.setBoundsComputedAnchorX(t,Math.floor(n)),s.setBoundsComputedAnchorY(t,Math.floor(o))}else{i.state.rotation?(e=a[0]*n+a[2]*o+a[4],r=a[1]*n+a[3]*o+a[5]):(e+=c,r+=u);const l=e+s.boundsCenterX(t)+f,d=r+s.boundsCenterY(t)+b;s.setBoundsComputedAnchorX(t,l),s.setBoundsComputedAnchorY(t,d)}}}}))},e}();e.CollisionEngine=p,Object.defineProperty(e,"__esModule",{value:!0})}));
