/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../../core/maybe","../../../../../core/screenUtils","../definitions","./CollisionGrid","./visualVariableSimpleUtils"],(function(e,t,i,n,o,r){"use strict";const s=254,l=255,a=0;function u(e,i){const n=[];e.forEachTile((e=>n.push(e))),n.sort(((e,t)=>e.instanceId-t.instanceId)),n.forEach((e=>{t.isSome(e.labelMetrics)&&e.isReady&&i(e,e.labelMetrics.getCursor())}))}function c(e){return e.layer&&("feature"===e.layer.type||"csv"===e.layer.type||"geojson"===e.layer.type||"ogc-feature"===e.layer.type||"stream"===e.layer.type||"subtype-group"===e.layer.type||"wfs"===e.layer.type)}function d(e){return t=>i.pt2px(r.getSizeForValueSimple(t,e))}function f(e){const t="visualVariables"in e&&e.visualVariables;if(!t)return null;for(const i of t)if("size"===i.type)return d(i);return null}function b(e){for(const t of e){const e="featureReduction"in t&&t.featureReduction&&"labelingInfo"in t.featureReduction&&t.featureReduction,i=[...t.labelingInfo||[],...e?.labelingInfo||[]];if(!t.labelsVisible||!i.length)continue;if(i.some((e=>"none"===e.deconflictionStrategy)))return!0}return!1}function y(e,i){if(!c(i))return;const n="subtype-group"===i.layer.type?i.layer.sublayers.items:[i.layer],o=i.layer.geometryType,r=!b(n),s={};if("subtype-group"!==i.layer.type){if("heatmap"===i.tileRenderer?.type)return;const e=f(i.layer.renderer);s[0]=e}const l=i.tileRenderer;if(t.isNone(l))return;const a=i.layer.visible&&!i.suspended;e.push({tileRenderer:l,vvEvaluators:s,deconflictionEnabled:r,geometryType:o,visible:a})}let p=function(){function e(){}var i=e.prototype;return i.run=function(e,t,i){const n=[];for(let o=e.length-1;o>=0;o--){y(n,e[o])}this._transformMetrics(n),this._runCollision(n,t,i)},i._runCollision=function(e,t,i){const[n,r]=t.state.size,s=new o.CollisionBitsetGrid(n,r,t.pixelRatio);for(const{tileRenderer:o,deconflictionEnabled:c,visible:d}of e){const e=o.featuresView.attributeView;c?d?(this._prepare(o),this._collideVisible(s,o,i),this._collideInvisible(s,o)):u(o,((t,i)=>{for(;i.nextId();)e.setLabelMinZoom(i.id,l)})):u(o,((t,i)=>{for(;i.nextId();)e.setLabelMinZoom(i.id,a),d&&s.insertMetrics(i)}))}},i._isFiltered=function(e,i,o){const r=i.getFilterFlags(e),s=!o.hasFilter||!!(r&n.FILTER_FLAG_0),l=t.isNone(o.featureEffect)||o.featureEffect.excludedLabelsVisible||!!(r&n.EFFECT_FLAG_0);return!(s&&l)},i._prepare=function(e){const t=e.featuresView.attributeView,i=new Set;u(e,((n,o)=>{for(;o.nextId();){if(i.has(o.id))continue;if(i.add(o.id),this._isFiltered(o.id,t,e.layerView)){t.setLabelMinZoom(o.id,s);continue}t.getLabelMinZoom(o.id)!==a?t.setLabelMinZoom(o.id,l):t.setLabelMinZoom(o.id,a)}}))},i._collideVisible=function(e,t,i){const n=t.featuresView.attributeView,r=new Set;u(t,((t,l)=>{for(;l.nextId();)if(!r.has(l.id))if(t.key.level===i){if(0===n.getLabelMinZoom(l.id)){switch(e.insertMetrics(l)){case o.OUTSIDE_EXTENT:break;case o.HAS_COLLISION:n.setLabelMinZoom(l.id,s),r.add(l.id);break;case o.NONE:n.setLabelMinZoom(l.id,a),r.add(l.id)}}}else n.setLabelMinZoom(l.id,s)}))},i._collideInvisible=function(e,t){const i=t.featuresView.attributeView,n=new Set;u(t,((t,r)=>{for(;r.nextId();)if(!n.has(r.id)&&i.getLabelMinZoom(r.id)===l){switch(e.insertMetrics(r)){case o.OUTSIDE_EXTENT:break;case o.HAS_COLLISION:i.setLabelMinZoom(r.id,l),n.add(r.id);break;case o.NONE:i.setLabelMinZoom(r.id,a),n.add(r.id)}}}))},i._transformMetrics=function(e){for(const{tileRenderer:i,geometryType:n,vvEvaluators:o}of e)u(i,((e,r)=>{const s=i.featuresView.attributeView,l=e.transforms.labelMat2d;l[4]=Math.round(l[4]),l[5]=Math.round(l[5]);const a="polyline"===n;for(;r.next();){const e=r.boundsCount,i=r.anchorX,n=r.anchorY;let u=r.size;const c=o[0];if(t.isSome(c)){const e=c(s.getVVSize(r.id));u=isNaN(e)||null==e||e===1/0?u:e}const d=r.directionX*(u/2),f=r.directionY*(u/2);for(let t=0;t<e;t++){let e=i,o=r.anchorY;if(a){let i=e+r.boundsX(t)+d,n=o+r.boundsY(t)+f;i=l[0]*i+l[2]*n+l[4],n=l[1]*i+l[3]*n+l[5],r.setBoundsComputedAnchorX(t,Math.floor(i)),r.setBoundsComputedAnchorY(t,Math.floor(n))}else{e=l[0]*i+l[2]*n+l[4],o=l[1]*i+l[3]*n+l[5];const s=e+r.boundsX(t)+d,a=o+r.boundsY(t)+f;r.setBoundsComputedAnchorX(t,s),r.setBoundsComputedAnchorY(t,a)}}}}))},e}();e.CollisionEngine=p,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
