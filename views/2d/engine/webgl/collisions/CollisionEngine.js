/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/Logger","../../../../../core/Error","../../../../../core/mathUtils","../definitions","./CollisionBucket","./LayerCollisionInfo"],(function(e,i,t,n,o,s,r,l){"use strict";const c=s.TILE_SIZE/s.COLLISION_BUCKET_SIZE,a=c,f=t.getLogger("esri.views.2d.engine.webgl.collisions.CollisionEngine");let u=function(){function e(e){this._layers=new Map,this._collisionBuckets=new Map,this._didError=!1,this._tilingScheme=e}var t=e.prototype;return t.registerLayerView=function(e,i){if(this._layers.has(e))return;const t=l.default.create(e,i,this.collisionInfos,this._tilingScheme);this._layers.set(e,t),this._collisionBuckets.forEach((e=>e.onRegisterLayer(t.index)))},t.unregisterLayerView=function(e){if(!this._layers.has(e))return;const i=this._layers.get(e);l.default.delete(i.index,this.collisionInfos),this._layers.delete(e),this._collisionBuckets.forEach(((e,t)=>{const n=e.getTile(i.index);n&&(e.onUnregisterLayer(i.index),e.canDelete()&&this._collisionBuckets.delete(t),n.reference&&(n.reference.isDirty=!1))}))},t.addTile=function(e,i){const t=i.key.id;if(!this._layers.has(e))return;this._collisionBuckets.has(t)||this._collisionBuckets.set(t,new r(i.key,this._layers.size));const n=this._getIndex(e);this._collisionBuckets.get(t).getTile(n).reference=i},t.removeTile=function(e,i){if(!this._layers.has(e)||!this._collisionBuckets.has(i))return;const t=this._getIndex(e),n=this._collisionBuckets.get(i).getTile(t);n.dirty=!1,n.reference=null},t.run=function(e,i){const t=Array.from(this._collisionBuckets.values()).sort(((e,i)=>e.key.compareRowMajor(i.key)));let o=!0;const s=e.renderingOptions.labelCollisionsEnabled&&!this._didError,r=this.collisionInfos;try{for(const i of t){o=o||i.isDirty,i.computeNeighbors(this._collisionBuckets);for(let t=0;t<this._layers.size;t++){const n=l.default.find(t,r);i.reset(e,o,n)}}for(let e=0;e<this._layers.size;e++){const n=l.default.find(e,r);for(const e of t)this._run(s,e,n,i)}}catch(e){f.error(new n("mapview-labeling","Encountered an error during decluttering. Disabling collisions",e)),this._didError=!0}for(const e of t)e.ready()},t._run=function(e,i,t,n){const o=i.getReference(t.index);o&&o.hasData&&(o.key.level!==n?this._resetLabelsMinZoom(i,t):this._runVisibility(e,i,o,t,n))},t._resetLabelsMinZoom=function(e,i){if(!e||"polyline"===i.geometryType)return;const t=e.getReference(i.index);if(!t||!t.hasData)return;const n=i.layerView.tileRenderer.featuresView.attributeView,o=t.displayObjects;for(const e of o)n.setLabelMinZoom(e.id,255)},t._checkLabelsVisible=function(e,i){const t=!i.filter||!!(e&s.FILTER_FLAG_0),n=!i.effect||i.effect.excludedLabelsVisible||!!(e&s.EFFECT_FLAG_0);return t&&n},t._runVisibility=function(e,i,t,n,o){const s=n.layerView.tileRenderer.featuresView.attributeView,r=t.displayObjects.sort(((e,i)=>s.getLabelMinZoom(e.id)-s.getLabelMinZoom(i.id))),l=n.zoomRanges.some((e=>"none"===e.deconflictionStrategy));for(const t of r){if(!t.metrics.length)continue;let r="polyline"===n.geometryType?0:10*(o-1);const c=s.getFilterFlags(t.id),a=this._checkLabelsVisible(c,n.layerView);if(e&&!l)for(let e=0;e<t.metrics.length;e++){const s=t.metrics[e],l=a?-1!==s.minZoom?s.minZoom:this._computeLabelVisibility(t,s,n.index,i,s.baseZoom,o):255;r=Math.max(l,r)}r=Math.max(r,0),s.setLabelMinZoom(t.id,r);for(const e of t.metrics)e.minZoom=r}},t._computeLabelVisibility=function(e,i,t,n,o,s){let r=o;const{xBucket:l,yBucket:f,xOverflow:u,yOverflow:h}=i,_=l-u,d=l+u+1,g=f+h+1;for(let o=f-h;o<g;o++)for(let l=_;l<d;l++)if(!(l<-c||o<-a||l>c||o>a))for(let c=0;c<=t;c++){const a=this._getRelativeSubBucket(c,n,l,o);if(a)for(const n of a){if(c===t&&n.id===e.id)continue;const o=this._compareLabels(i,n,r,s);r=Math.max(o,r)}}return r},t._compareLabels=function(e,i,t,n){const s=10*(n+1);if(-1===i.minZoom||i.minZoom>s)return t;const r=e.findCollisionDelta(i),l=o.clamp(Math.ceil(10*(r+n)),0,255);return i.minZoom>=l?t:Math.max(t,l)},t._getNeighboringTile=function(e,i,t,n){const o=3*(1+n)+(1+t),s=i.neighbors[o];return s&&s.getTile(e)},t._getRelativeSubBucket=function(e,i,t,n){const s=o.sign(Math.floor(t/4)),r=o.sign(Math.floor(n/4)),l=this._getNeighboringTile(e,i,s,r);return l&&l.reference&&l.index&&l.reference.hasData?l.index[n-4*r][t-4*s]:null},t._getIndex=function(e){return this._layers.get(e).index},i._createClass(e,[{key:"collisionInfos",get:function(){return Array.from(this._layers.values())}}]),e}();e.CollisionEngine=u,Object.defineProperty(e,"__esModule",{value:!0})}));
