// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","../../../../../core/Error","../../../../../core/Logger","../../../../../core/MapUtils","../../../../../core/mathUtils","../definitions","./CollisionBucket","./LayerCollisionInfo"],(function(e,i,t,r,o,n,s,l,a){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.CollisionEngine=void 0;var c=s.TILE_SIZE/s.COLLISION_BUCKET_SIZE,f=c,u=r.getLogger("esri.views.2d.engine.webgl.collisions.CollisionEngine"),h=function(){function e(e){this._layers=new Map,this._collisionBuckets=new Map,this._didError=!1,this._tilingScheme=e}return Object.defineProperty(e.prototype,"collisionInfos",{get:function(){return o.valuesOfMap(this._layers)},enumerable:!1,configurable:!0}),e.prototype.registerLayerView=function(e,i){if(!this._layers.has(e)){var t=a.default.create(e,i,this.collisionInfos,this._tilingScheme);this._layers.set(e,t),this._collisionBuckets.forEach((function(e){return e.onRegisterLayer(t.index)}))}},e.prototype.unregisterLayerView=function(e){var i=this;if(this._layers.has(e)){var t=this._layers.get(e);a.default.delete(t.index,this.collisionInfos),this._layers.delete(e),this._collisionBuckets.forEach((function(e,r){var o=e.getTile(t.index);o&&(e.onUnregisterLayer(t.index),e.canDelete()&&i._collisionBuckets.delete(r),o.reference&&(o.reference.isDirty=!1))}))}},e.prototype.addTile=function(e,i){var t=i.key.id;if(this._layers.has(e)){this._collisionBuckets.has(t)||this._collisionBuckets.set(t,new l.default(i.key,this._layers.size));var r=this._getIndex(e);this._collisionBuckets.get(t).getTile(r).reference=i}},e.prototype.removeTile=function(e,i){if(this._layers.has(e)&&this._collisionBuckets.has(i)){var t=this._getIndex(e),r=this._collisionBuckets.get(i).getTile(t);r.dirty=!1,r.reference=null}},e.prototype.run=function(e,i){var r=o.valuesOfMap(this._collisionBuckets).sort((function(e,i){return e.key.compareRowMajor(i.key)})),n=!0,s=e.renderingOptions.labelCollisionsEnabled&&!this._didError,l=this.collisionInfos;try{for(var c=0,f=r;c<f.length;c++){var h=f[c];n=n||h.isDirty,h.computeNeighbors(this._collisionBuckets);for(var g=0;g<this._layers.size;g++){var y=a.default.find(g,l);h.reset(e,n,y)}}for(var d=0;d<this._layers.size;d++){y=a.default.find(d,l);for(var _=0,p=r;_<p.length;_++){h=p[_];this._run(s,h,y,i)}}}catch(e){u.error(new t("mapview-labeling","Encountered an error during decluttering. Disabling collisions",e)),this._didError=!0}for(var v=0,m=r;v<m.length;v++){(h=m[v]).ready()}},e.prototype._run=function(e,i,t,r){var o=i.getReference(t.index);o&&o.hasData&&(o.key.level!==r?this._resetLabelsMinZoom(i,t):this._runVisibility(e,i,o,t,r))},e.prototype._resetLabelsMinZoom=function(e,i){if(e&&"polyline"!==i.geometryType){var t=e.getReference(i.index);if(t&&t.hasData)for(var r=i.layerView.tileRenderer.featuresView.attributeView,o=0,n=t.displayObjects;o<n.length;o++){var s=n[o];r.setLabelMinZoom(s.id,255)}}},e.prototype._checkLabelsVisible=function(e,i){var t=!i.filter||!!(e&s.FILTER_FLAG_0),r=!i.effect||i.effect.excludedLabelsVisible||!!(e&s.EFFECT_FLAG_0);return t&&r},e.prototype._runVisibility=function(e,i,t,r,o){for(var n=r.layerView.tileRenderer.featuresView.attributeView,s=t.displayObjects.sort((function(e,i){return n.getLabelMinZoom(e.id)-n.getLabelMinZoom(i.id)})),l=r.zoomRanges.some((function(e){return"none"===e.deconflictionStrategy})),a=0,c=s;a<c.length;a++){var f=c[a];if(f.metrics.length){var u="polyline"===r.geometryType?0:10*(o-1),h=n.getFilterFlags(f.id),g=this._checkLabelsVisible(h,r.layerView);if(e&&!l)for(var y=0;y<f.metrics.length;y++){var d=f.metrics[y],_=g?-1!==d.minZoom?d.minZoom:this._computeLabelVisibility(f,d,r.index,i,d.baseZoom,o):255;u=Math.max(_,u)}u=Math.max(u,0),n.setLabelMinZoom(f.id,u);for(var p=0,v=f.metrics;p<v.length;p++){(d=v[p]).minZoom=u}}}},e.prototype._computeLabelVisibility=function(e,i,t,r,o,n){for(var s=o,l=i.xBucket,a=i.yBucket,u=i.xOverflow,h=i.yOverflow,g=l-u,y=l+u+1,d=a+h+1,_=a-h;_<d;_++)for(var p=g;p<y;p++)if(!(p<-c||_<-f||p>c||_>f))for(var v=0;v<=t;v++){var m=this._getRelativeSubBucket(v,r,p,_);if(m)for(var b=0,L=m;b<L.length;b++){var k=L[b];if(v!==t||k.id!==e.id){var x=this._compareLabels(i,k,s,n);s=Math.max(x,s)}}}return s},e.prototype._compareLabels=function(e,i,t,r){var o=10*(r+1);if(-1===i.minZoom||i.minZoom>o)return t;var s=e.findCollisionDelta(i),l=n.clamp(Math.ceil(10*(s+r)),0,255);return i.minZoom>=l?t:Math.max(t,l)},e.prototype._getNeighboringTile=function(e,i,t,r){var o=3*(1+r)+(1+t),n=i.neighbors[o];return n&&n.getTile(e)},e.prototype._getRelativeSubBucket=function(e,i,t,r){var o=n.sign(Math.floor(t/4)),s=n.sign(Math.floor(r/4)),l=this._getNeighboringTile(e,i,o,s);return l&&l.reference&&l.index&&l.reference.hasData?l.index[r-4*s][t-4*o]:null},e.prototype._getIndex=function(e){return this._layers.get(e).index},e}();i.CollisionEngine=h}));