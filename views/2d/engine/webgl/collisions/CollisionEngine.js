/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/maybe","../definitions","./CollisionGrid","./LayerCollisionInfo"],(function(e,t,i,o,n,s){"use strict";const r=254,a=255,l=0;function c(e,t){const o=[];e.forEachTile((e=>o.push(e))),o.sort(((e,t)=>e.instanceId-t.instanceId)),o.forEach((e=>{i.isSome(e.labelMetrics)&&e.isReady&&t(e,e.labelMetrics.getCursor())}))}let d=function(){function e(e){this._layers=new Map,this._tilingScheme=e}var i=e.prototype;return i.registerLayerView=function(e,t){if(this._layers.has(e))return;const i=s.default.create(e,t,this.collisionInfos,this._tilingScheme);this._layers.set(e,i)},i.unregisterLayerView=function(e){if(!this._layers.has(e))return;const t=this._layers.get(e);s.default.delete(t.index,this.collisionInfos),this._layers.delete(e)},i.run=function(e,t){this._transformMetrics(e),this._runCollision(e,t)},i._runCollision=function(e,t){const[i,o]=e.state.size,s=new n.CollisionBitsetGrid(i,o);this._forEachLayer(((e,i)=>{const o=e.zoomRanges.some((e=>"none"===e.deconflictionStrategy)),n=i.featuresView.attributeView;o?c(i,((e,t)=>{for(;t.nextId();)n.setLabelMinZoom(t.id,l)})):(this._prepare(i),this._collideVisible(s,i,t),this._collideInvisible(s,i))}))},i._isFiltered=function(e,t,i){const n=t.getFilterFlags(e),s=!i.hasFilter||!!(n&o.FILTER_FLAG_0),r=!i.effect||i.effect.excludedLabelsVisible||!!(n&o.EFFECT_FLAG_0);return!(s&&r)},i._prepare=function(e){const t=e.featuresView.attributeView,i=new Set;c(e,((o,n)=>{for(;n.nextId();){if(i.has(n.id))continue;if(i.add(n.id),this._isFiltered(n.id,t,e.layerView)){t.setLabelMinZoom(n.id,r);continue}t.getLabelMinZoom(n.id)!==l?t.setLabelMinZoom(n.id,a):t.setLabelMinZoom(n.id,l)}}))},i._collideVisible=function(e,t,i){const o=t.featuresView.attributeView,s=new Set;c(t,((t,a)=>{for(;a.nextId();)if(!s.has(a.id))if(t.key.level===i){if(0===o.getLabelMinZoom(a.id)){switch(e.insertMetrics(a)){case n.OUTSIDE_EXTENT:break;case n.HAS_COLLISION:o.setLabelMinZoom(a.id,r),s.add(a.id);break;case n.NONE:o.setLabelMinZoom(a.id,l),s.add(a.id)}}}else o.setLabelMinZoom(a.id,r)}))},i._collideInvisible=function(e,t){const i=t.featuresView.attributeView,o=new Set;c(t,((t,s)=>{for(;s.nextId();)if(!o.has(s.id)&&i.getLabelMinZoom(s.id)===a){switch(e.insertMetrics(s)){case n.OUTSIDE_EXTENT:break;case n.HAS_COLLISION:i.setLabelMinZoom(s.id,a),o.add(s.id);break;case n.NONE:i.setLabelMinZoom(s.id,l),o.add(s.id)}}}))},i._transformMetrics=function(e){this._forEachLayer(((t,i)=>{c(i,((o,n)=>{const s=i.featuresView.attributeView,r=o.transforms.labelMat2d;r[4]=Math.round(r[4]),r[5]=Math.round(r[5]);const a=r[4],l=r[5],c="polyline"===t.geometryType;for(;n.next();){const i=n.boundsCount,o=n.anchorX,d=n.anchorY;let u=0,f=0;if(t.hasVV()){const e=s.getVVSize(n.id),i=t.vvEval(e),o=isNaN(i)||null==i||i===1/0?n.size:i;u=n.directionX*(o/2),f=n.directionY*(o/2)}for(let t=0;t<i;t++){let i=o,s=n.anchorY;if(c){let o=i+n.boundsCenterX(t)+u,c=s+n.boundsCenterY(t)+f;e.state.rotation?(o=r[0]*o+r[2]*c+r[4],c=r[1]*o+r[3]*c+r[5]):(o+=a,c+=l),n.setBoundsComputedAnchorX(t,Math.floor(o)),n.setBoundsComputedAnchorY(t,Math.floor(c))}else{e.state.rotation?(i=r[0]*o+r[2]*d+r[4],s=r[1]*o+r[3]*d+r[5]):(i+=a,s+=l);const c=i+n.boundsCenterX(t)+u,h=s+n.boundsCenterY(t)+f;n.setBoundsComputedAnchorX(t,c),n.setBoundsComputedAnchorY(t,h)}}}}))}))},i._forEachLayer=function(e){const t=[];this._layers.forEach((e=>t.push(e))),t.sort(((e,t)=>e.order-t.order)),t.forEach((t=>{var i;const o=null==(i=t.layerView)?void 0:i.tileRenderer;o&&e(t,o)}))},t._createClass(e,[{key:"collisionInfos",get:function(){return Array.from(this._layers.values())}}]),e}();e.CollisionEngine=d,Object.defineProperty(e,"__esModule",{value:!0})}));
