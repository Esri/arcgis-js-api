/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../core/Error","../../../../core/events","../../../../core/Logger","../../../../core/mathUtils","../../../../core/maybe","../../../../core/perspectiveUtils","../../../../core/reactiveUtils","../../../../chunks/mat3f64","../../../../chunks/vec2","../../../../chunks/vec2f64","../DisplayObject","../../../webgl/BufferObject","../../../webgl/context-util","../../../webgl/enums","../../../webgl/Texture","../../../webgl/VertexArrayObject"],(function(e,t,r,i,n,s,o,a,c,l,u,h,p,d,m,f,w){"use strict";const y=c.create();return function(c){function h(e){var n;return(n=c.call(this)||this).elementView=e,n.isWrapAround=!1,n.perspectiveTransform=u.create(),n._vertices=new Float32Array(20),n._handles=[],n._handles.push(a.watch((()=>n.elementView.element.opacity),(e=>n.opacity=e),a.initial),a.watch((()=>[n.elementView.coords]),(()=>{n.requestRender()}),a.initial),a.when((()=>n.elementView.element.loaded),(()=>{const e=n.elementView.element;n.ready(),"video"===e.type&&s.isSome(e.content)&&n._handles.push(r.on(e.content,"play",(()=>n.requestRender())))}),a.initial)),e.element.load().catch((r=>{i.getLogger("esri.views.2d.layers.MediaLayerView2D").error(new t("element-load-error","Element cannot be displayed",{element:e,error:r}))})),n}e._inheritsLoose(h,c);var g=h.prototype;return g.destroy=function(){this._handles.forEach((e=>e.remove())),this.texture=s.disposeMaybe(this.texture)},g.beforeRender=function(e){const{context:t}=e,r=this.elementView.element.content;if(s.isSome(r)){const e=r instanceof HTMLImageElement,i=r instanceof HTMLVideoElement,s=e?r.naturalWidth:i?r.videoWidth:r.width,o=e?r.naturalHeight:i?r.videoHeight:r.height;this._updatePerspectiveTransform(s,o),this.texture?i&&!r.paused&&(this.texture.setData(r),this.requestRender(),(t.type===d.ContextType.WEBGL2||n.isPowerOfTwo(s)&&n.isPowerOfTwo(o))&&this.texture.generateMipmap()):(this.texture=new f.Texture(t,{pixelFormat:m.PixelFormat.RGBA,dataType:m.PixelType.UNSIGNED_BYTE,samplingMode:m.TextureSamplingMode.LINEAR,wrapMode:m.TextureWrapMode.CLAMP_TO_EDGE,width:s,height:o,preMultiplyAlpha:!0},r),(t.type===d.ContextType.WEBGL2||n.isPowerOfTwo(s)&&n.isPowerOfTwo(o))&&this.texture.generateMipmap(),i&&!r.paused&&this.requestRender())}c.prototype.beforeRender.call(this,e)},g._createTransforms=function(){return null},g.updateDrawCoords=function(e,t){const r=this.elementView.coords;if(s.isNone(r))return;const[i,n,o,a]=r.rings[0],c=this._vertices,{x:l,y:u}=e,h=0!==t;h?c.set([n[0]-l,n[1]-u,i[0]-l,i[1]-u,o[0]-l,o[1]-u,a[0]-l,a[1]-u,a[0]-l,a[1]-u,n[0]+t-l,n[1]-u,n[0]+t-l,n[1]-u,i[0]+t-l,i[1]-u,o[0]+t-l,o[1]-u,a[0]+t-l,a[1]-u]):c.set([n[0]-l,n[1]-u,i[0]-l,i[1]-u,o[0]-l,o[1]-u,a[0]-l,a[1]-u]),this.isWrapAround=h},g.getVAO=function(e,t,r){if(s.isNone(this.elementView.coords))return null;const i=this._vertices;if(this._vao)this._geometryVbo.setData(i);else{this._geometryVbo=p.BufferObject.createVertex(e,m.Usage.DYNAMIC_DRAW,i);const n=p.BufferObject.createVertex(e,m.Usage.STATIC_DRAW,new Uint16Array([0,0,0,1,1,0,1,1,1,1,0,0,0,0,0,1,1,0,1,1]));this._vao=new w.VertexArrayObject(e,r,t,{geometry:this._geometryVbo,tex:n})}return this._vao},g._updatePerspectiveTransform=function(e,t){const r=this._vertices;o.getProjectiveTransform(y,[0,0,e,0,0,t,e,t],[r[0],r[1],r[4],r[5],r[2],r[3],r[6],r[7]]),l.set(this.perspectiveTransform,y[6]/y[8]*e,y[7]/y[8]*t)},e._createClass(h,[{key:"dvsMat3",get:function(){return this.parent.dvsMat3}}]),h}(h.DisplayObject)}));
