/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["require","exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/Error","../../../../../core/Logger","../../../../../core/LRUCache","../../../../../support/arcadeOnDemand","../../../../../symbols/cim/cimSymbolUtils","../../../../../symbols/cim/utils","../../../arcade/callExpressionWithFeature","../../../layers/features/schemaUtils"],(function(e,t,n,r,i,l,o,a,s,u,c){"use strict";function f(e){return Object.freeze({__proto__:null,default:e})}const d=i.getLogger("esri/views/2d/engine/webgl/util/Matcher");function p(e,t,n){return h.apply(this,arguments)}function h(){return(h=n._asyncToGenerator((function*(e,t,n){switch(e.type){case"simple":return y.fromBasicRenderer(e,t,n);case"map":return b.fromUVRenderer(e,t,n);case"interval":return _.fromCBRenderer(e,t,n);case"dictionary":return x.fromDictionaryRenderer(e,t,n);case"subtype":return m.fromSubtypes(e,t,n)}}))).apply(this,arguments)}let y=function(){function e(){this.type="feature",this._defaultResult=null}e.fromBasicRenderer=function(){var t=n._asyncToGenerator((function*(t,n,r){const i=new e;if(t.symbol){const e=yield a.expandSymbol(t.symbol,r),l=n.createTemplateGroup(e,null);i.setDefault(l)}return i}));function r(e,n,r){return t.apply(this,arguments)}return r}();var t=e.prototype;return t.size=function(){return 1},t.getDefault=function(){return this._defaultResult},t.setDefault=function(e){this._defaultResult=e},t.match=function(e,t,n,r,i){return this.getDefault()},t.analyze=function(){var e=n._asyncToGenerator((function*(e,t,n,r,i){return null}));function t(t,n,r,i,l){return e.apply(this,arguments)}return t}(),e}(),m=function(e){function t(t,n){var r;return(r=e.call(this)||this)._subMatchers=t,r._subtypeField=n,r}return n._inheritsLoose(t,e),t.fromSubtypes=function(){var e=n._asyncToGenerator((function*(e,n,r){const i=new Map,l=[];for(const t in e.renderers){const o=parseInt(t,10),a=p(e.renderers[t],n,r).then((e=>i.set(o,e)));l.push(a)}return yield Promise.all(l),new t(i,e.subtypeField)}));function r(t,n,r){return e.apply(this,arguments)}return r}(),t.prototype.match=function(e,t,n,r,i){const l=t.readAttribute(this._subtypeField),o=this._subMatchers.get(l);return o?o.match(e,t,n,r,i):null},t}(y),_=function(e){function t(t,n,r,i){var l;return(l=e.call(this)||this).type="interval",l._intervals=[],l._isMaxInclusive=n,l._fieldIndex=i,l._field=t,l._normalizationInfo=r,l}n._inheritsLoose(t,e),t.fromCBRenderer=function(){var e=n._asyncToGenerator((function*(e,r,i){const{isMaxInclusive:l,normalizationField:o,normalizationTotal:s,normalizationType:u}=e,c=new t(e.field,l,{normalizationField:o,normalizationTotal:s,normalizationType:u},e.fieldIndex),f=yield a.expandSymbol(e.backgroundFillSymbol,i);yield Promise.all(e.intervals.map(function(){var e=n._asyncToGenerator((function*(e){const t=yield a.expandSymbol(e.symbol,i),n=yield r.createTemplateGroup(t,f),l={min:e.min,max:e.max};c.add(l,n)}));return function(t){return e.apply(this,arguments)}}()));const d=yield a.expandSymbol(e.defaultSymbol,i);if(d){const e=yield r.createTemplateGroup(d,f);c.setDefault(e)}return c}));function r(t,n,r){return e.apply(this,arguments)}return r}();var r=t.prototype;return r.add=function(e,t){this._intervals.push({interval:e,result:t}),this._intervals.sort(((e,t)=>e.interval.min-t.interval.min))},r.size=function(){return e.prototype.size.call(this)+this._intervals.length},r.match=function(e,t,n,r,i){if(null==this._fieldIndex&&!this._field)return this.getDefault();const l=null!=this._fieldIndex?t.getComputedNumericAtIndex(this._fieldIndex):this._getValueFromField(t);if(!l&&(null==l||isNaN(l)))return this.getDefault();for(let o=0;o<this._intervals.length;o++){const{interval:e,result:t}=this._intervals[o],n=l>=e.min,r=this._isMaxInclusive?l<=e.max:l<e.max;if(n&&r)return t}return this.getDefault()},r._needsNormalization=function(){const e=this._normalizationInfo;return e&&(e.normalizationField||e.normalizationTotal||e.normalizationType)},r._getValueFromField=function(e){const t=e.readAttribute(this._field);if(!this._needsNormalization()||null==t)return t;const{normalizationField:n,normalizationTotal:r,normalizationType:i}=this._normalizationInfo,l=!!n&&e.readAttribute(n);if(i)switch(i){case"esriNormalizeByField":return l?t/l:void 0;case"esriNormalizeByLog":return Math.log(t)*Math.LOG10E;case"esriNormalizeByPercentOfTotal":return t/r*100;default:return void d.error(`Found unknown normalization type: ${i}`)}else d.error("Normalization is required, but no type was set!")},t}(y),b=function(e){function t(t,n,r){var i;return(i=e.call(this)||this).type="map",i._nullResult=null,i._resultsMap=new Map,i._fieldsIndex=r,i._fields=t,i._seperator=n||"",i}n._inheritsLoose(t,e),t.fromUVRenderer=function(){var e=n._asyncToGenerator((function*(e,r,i){const l=e.fieldDelimiter,o=[e.field];e.field2&&o.push(e.field2),e.field3&&o.push(e.field3);const s=yield a.expandSymbol(e.backgroundFillSymbol,i),u=new t(o,l,e.fieldIndex);yield Promise.all(e.map.map(function(){var e=n._asyncToGenerator((function*(e){const t=yield a.expandSymbol(e.symbol,i),n=yield r.createTemplateGroup(t,s);"<Null>"===e.value?u.setNullResult(n):u.add(e.value,n)}));return function(t){return e.apply(this,arguments)}}()));const c=yield a.expandSymbol(e.defaultSymbol,i);if(c){const e=yield r.createTemplateGroup(c,s);u.setDefault(e)}return u}));function r(t,n,r){return e.apply(this,arguments)}return r}();var r=t.prototype;return r.setNullResult=function(e){this._nullResult=e},r.add=function(e,t){this._resultsMap.set(e.toString(),t)},r.size=function(){return e.prototype.size.call(this)+this._resultsMap.size},r.match=function(e,t,n,r,i){if(null==this._fieldsIndex&&!this._fields)return this.getDefault();const l=null!=this._fieldsIndex?t.getComputedStringAtIndex(this._fieldsIndex):this._getValueFromFields(t);if(null!==this._nullResult&&(null==l||""===l||"<Null>"===l))return this._nullResult;if(!l&&null==l)return this.getDefault();const o=l.toString();return this._resultsMap.has(o)?this._resultsMap.get(o):this.getDefault()},r._getValueFromFields=function(e){const t=[];for(const n of this._fields){const r=e.readAttribute(n);null==r||""===r?t.push("<Null>"):t.push(r)}return t.join(this._seperator)},t}(y);function v(e,t){return g.apply(this,arguments)}function g(){return(g=n._asyncToGenerator((function*(e,t){const n=e||1;if("number"==typeof n)return(e,t,r)=>n;const r=yield o.createRendererExpression(n,t.spatialReference,t.fields);return(e,n,i)=>u(r,e,{$view:i},t.geometryType,n)||1}))).apply(this,arguments)}let x=function(t){function i(e,n,r,i){var o;return(o=t.call(this)||this).type="dictionary",o._groupIdCache=new l(100),o._renderer=e,o._fieldMap=e.fieldMap,o._symbolFields=e.getSymbolFields(),o._templates=n,o._info=r,o._scaleFn=i,o}n._inheritsLoose(i,t),i.fromDictionaryRenderer=function(){var t=n._asyncToGenerator((function*(t,n,r){const l=(yield new Promise((function(t,n){e(["../../../../../renderers/DictionaryRenderer"],(function(e){t(f(e))}),n)}))).default.fromJSON(t.renderer);yield l.fetchResources({spatialReference:r.spatialReference,fields:r.fields});return new i(l,n,r,yield v(l.scaleExpression,r))}));function r(e,n,r){return t.apply(this,arguments)}return r}();var o=i.prototype;return o._analyzeFeature=function(){var e=n._asyncToGenerator((function*(e,t,n,i){const l=e.readLegacyFeature(),o=this._scaleFn(l,t,n),u=this._attributeHash(l)+"-"+o,f=this._groupIdCache.get(u);if(f)return f;const p={...n,spatialReference:this._info.spatialReference,abortOptions:i,fields:this._info.fields},h=yield this._renderer.getSymbolAsync(l,p),y=c.createSymbolSchema(h,this._renderer),m=a.expandSymbol(y,this._info,i).then((e=>{if("expanded-cim"!==e.type)return d.error(new r("mapview-bad-type",`Found unexpected type ${e.type} in dictionary response`)),null;e.hash+="-"+o;for(const t of e.layers)t.scaleFactor=o,t.templateHash+="-"+o,"text"===t.type&&"string"==typeof t.text&&t.text.indexOf("[")>-1&&(t.text=s.createLabelOverrideFunction(this._fieldMap,t.text,t.cim.textCase));return this._templates.createTemplateGroup(e,null)}));return this._groupIdCache.put(u,m,1),m}));function t(t,n,r,i){return e.apply(this,arguments)}return t}(),o.analyze=function(){var e=n._asyncToGenerator((function*(e,t,n,r,i){const l=t.getCursor(),o=[];for(;l.next();)o.push(this._analyzeFeature(l,n,r,i));return Promise.all(o)}));function t(t,n,r,i,l){return e.apply(this,arguments)}return t}(),o.match=function(e,t,n,r,i){return null},o._attributeHash=function(e){let t="";for(const n of this._symbolFields){const r=this._fieldMap[n];r&&(t+=e.attributes[r]+"-")}return t},i}(y);t.DictionaryMatcher=x,t.FeatureMatcher=y,t.IntervalMatcher=_,t.MapMatcher=b,t.SubtypeMatcher=m,t.createMatcher=p,Object.defineProperty(t,"__esModule",{value:!0})}));
