/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["require","exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/Logger","../../../../../core/Error","../../../../../support/arcadeOnDemand","../../../../../symbols/cim/utils","../../../../../core/LRUCache","../../../arcade/callExpressionWithFeature","../../../../../symbols/cim/cimSymbolUtils","../../../layers/features/schemaUtils"],(function(e,t,n,i,r,a,l,s,o,u,c){"use strict";function f(e){return Object.freeze({__proto__:null,default:e})}const d=i.getLogger("esri/views/2d/engine/webgl/util/Matcher");let p=function(){function e(){this.type="feature",this._defaultResult=null}e.fromBasicRenderer=async function(t,n,i){const r=new e;if(t.symbol){const e=await u.expandSymbol(t.symbol,i),a=n.createTemplateGroup(e,null);r.setDefault(a)}return r};var t=e.prototype;return t.size=function(){return 1},t.getDefault=function(){return this._defaultResult},t.setDefault=function(e){this._defaultResult=e},t.match=function(e,t,n,i,r){return this.getDefault()},t.analyze=async function(e,t,n,i,r){return null},e}(),h=function(e){function t(t,n,i,r){var a;return(a=e.call(this)||this).type="interval",a._intervals=[],a._isMaxInclusive=n,a._fieldIndex=r,a._field=t,a._normalizationInfo=i,a}n._inheritsLoose(t,e),t.fromCBRenderer=async function(e,n,i){const{isMaxInclusive:r,normalizationField:a,normalizationTotal:l,normalizationType:s}=e,o=new t(e.field,r,{normalizationField:a,normalizationTotal:l,normalizationType:s},e.fieldIndex),c=await u.expandSymbol(e.backgroundFillSymbol,i);await Promise.all(e.intervals.map((async e=>{const t=await u.expandSymbol(e.symbol,i),r=await n.createTemplateGroup(t,c),a={min:e.min,max:e.max};o.add(a,r)})));const f=await u.expandSymbol(e.defaultSymbol,i);if(f){const e=await n.createTemplateGroup(f,c);o.setDefault(e)}return o};var i=t.prototype;return i.add=function(e,t){this._intervals.push({interval:e,result:t}),this._intervals.sort(((e,t)=>e.interval.min-t.interval.min))},i.size=function(){return e.prototype.size.call(this)+this._intervals.length},i.match=function(e,t,n,i,r){if(null==this._fieldIndex&&!this._field)return this.getDefault();const a=null!=this._fieldIndex?t.getComputedNumericAtIndex(this._fieldIndex):this._getValueFromField(t);if(!a&&(null==a||isNaN(a)))return this.getDefault();for(let l=0;l<this._intervals.length;l++){const{interval:e,result:t}=this._intervals[l],n=a>=e.min,i=this._isMaxInclusive?a<=e.max:a<e.max;if(n&&i)return t}return this.getDefault()},i._needsNormalization=function(){const e=this._normalizationInfo;return e&&(e.normalizationField||e.normalizationTotal||e.normalizationType)},i._getValueFromField=function(e){const t=e.readAttribute(this._field);if(!this._needsNormalization()||null==t)return t;const{normalizationField:n,normalizationTotal:i,normalizationType:r}=this._normalizationInfo,a=!!n&&e.readAttribute(n);if(r)switch(r){case"esriNormalizeByField":return a?t/a:void 0;case"esriNormalizeByLog":return Math.log(t)*Math.LOG10E;case"esriNormalizeByPercentOfTotal":return t/i*100;default:return void d.error(`Found unknown normalization type: ${r}`)}else d.error("Normalization is required, but no type was set!")},t}(p),m=function(e){function t(t,n,i){var r;return(r=e.call(this)||this).type="map",r._nullResult=null,r._resultsMap=new Map,r._fieldsIndex=i,r._fields=t,r._seperator=n||"",r}n._inheritsLoose(t,e),t.fromUVRenderer=async function(e,n,i){const r=e.fieldDelimiter,a=[e.field];e.field2&&a.push(e.field2),e.field3&&a.push(e.field3);const l=await u.expandSymbol(e.backgroundFillSymbol,i),s=new t(a,r,e.fieldIndex);await Promise.all(e.map.map((async e=>{const t=await u.expandSymbol(e.symbol,i),r=await n.createTemplateGroup(t,l);"<Null>"===e.value?s.setNullResult(r):s.add(e.value,r)})));const o=await u.expandSymbol(e.defaultSymbol,i);if(o){const e=await n.createTemplateGroup(o,l);s.setDefault(e)}return s};var i=t.prototype;return i.setNullResult=function(e){this._nullResult=e},i.add=function(e,t){this._resultsMap.set(e.toString(),t)},i.size=function(){return e.prototype.size.call(this)+this._resultsMap.size},i.match=function(e,t,n,i,r){if(null==this._fieldsIndex&&!this._fields)return this.getDefault();const a=null!=this._fieldsIndex?t.getComputedStringAtIndex(this._fieldsIndex):this._getValueFromFields(t);if(null!==this._nullResult&&(null==a||""===a||"<Null>"===a))return this._nullResult;if(!a&&null==a)return this.getDefault();const l=a.toString();return this._resultsMap.has(l)?this._resultsMap.get(l):this.getDefault()},i._getValueFromFields=function(e){const t=[];for(const n of this._fields){const i=e.readAttribute(n);t.push(i)}return t.join(this._seperator)},t}(p);async function _(e,t){const n=e||1;if("number"==typeof n)return(e,t,i)=>n;const i=await a.createRendererExpression(n,t.spatialReference,t.fields);return(e,n,r)=>o(i,e,{$view:r},t.geometryType,n)||1}let y=function(t){function i(e,n,i,r){var a;return(a=t.call(this)||this).type="dictionary",a._groupIdCache=new s(100),a._renderer=e,a._fieldMap=e.fieldMap,a._symbolFields=e.getSymbolFields(),a._templates=n,a._info=i,a._scaleFn=r,a}n._inheritsLoose(i,t),i.fromDictionaryRenderer=async function(t,n,r){const a=(await new Promise((function(t,n){e(["../../../../../renderers/DictionaryRenderer"],(function(e){t(f(e))}),n)}))).default.fromJSON(t.renderer);await a.fetchResources({spatialReference:r.spatialReference,fields:r.fields});return new i(a,n,r,await _(a.scaleExpression,r))};var a=i.prototype;return a._analyzeFeature=async function(e,t,n,i){const a=e.readLegacyFeature(),s=this._scaleFn(a,t,n),o=this._attributeHash(a)+"-"+s,f=this._groupIdCache.get(o);if(f)return f;const p={...n,spatialReference:this._info.spatialReference,abortOptions:i,fields:this._info.fields},h=await this._renderer.getSymbolAsync(a,p),m=c.createSymbolSchema(h,this._renderer),_=u.expandSymbol(m,this._info,i).then((e=>{if("expanded-cim"!==e.type)return d.error(new r("mapview-bad-type",`Found unexpected type ${e.type} in dictionary response`)),null;e.hash+="-"+s;for(const t of e.layers)t.scaleFactor=s,t.templateHash+="-"+s,"text"===t.type&&"string"==typeof t.text&&t.text.indexOf("[")>-1&&(t.text=l.createLabelOverrideFunction(this._fieldMap,t.text,t.cim.textCase));return this._templates.createTemplateGroup(e,null)}));return this._groupIdCache.put(o,_,1),_},a.analyze=async function(e,t,n,i,r){const a=t.getCursor(),l=[];for(;a.next();)l.push(this._analyzeFeature(a,n,i,r));return Promise.all(l)},a.match=function(e,t,n,i,r){return null},a._attributeHash=function(e){let t="";for(const n of this._symbolFields){const i=this._fieldMap[n];i&&(t+=e.attributes[i]+"-")}return t},i}(p);t.DictionaryMatcher=y,t.FeatureMatcher=p,t.IntervalMatcher=h,t.MapMatcher=m,Object.defineProperty(t,"__esModule",{value:!0})}));
