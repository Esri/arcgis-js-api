/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["require","exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/Logger","../../../../../core/Error","../../../../../core/promiseUtils","../../../../../support/arcadeOnDemand","../../../../../symbols/cim/utils","../../../../../core/LRUCache","../../../arcade/callExpressionWithFeature","../../../../../symbols/cim/cimSymbolUtils","../../../layers/features/schemaUtils"],(function(e,t,n,i,r,a,l,s,o,u,c,f){"use strict";function d(e){return Object.freeze({__proto__:null,default:e})}const p=i.getLogger("esri/views/2d/engine/webgl/util/Matcher");let h=function(){function e(){this.type="feature",this._defaultResult=null}e.fromBasicRenderer=async function(t,n,i){const r=new e;if(t.symbol){const e=await c.expandSymbol(t.symbol,i),a=n.createTemplateGroup(e,null);r.setDefault(a)}return r};var t=e.prototype;return t.size=function(){return 1},t.getDefault=function(){return this._defaultResult},t.setDefault=function(e){this._defaultResult=e},t.match=function(e,t,n,i,r){return this.getDefault()},t.analyze=async function(e,t,n,i,r){return null},e}(),m=function(e){function t(t,n,i,r){var a;return(a=e.call(this)||this).type="interval",a._intervals=[],a._isMaxInclusive=n,a._fieldIndex=r,a._field=t,a._normalizationInfo=i,a}n._inheritsLoose(t,e),t.fromCBRenderer=async function(e,n,i){const{isMaxInclusive:r,normalizationField:l,normalizationTotal:s,normalizationType:o}=e,u=new t(e.field,r,{normalizationField:l,normalizationTotal:s,normalizationType:o},e.fieldIndex),f=await c.expandSymbol(e.backgroundFillSymbol,i);await a.all(e.intervals.map((async e=>{const t=await c.expandSymbol(e.symbol,i),r=await n.createTemplateGroup(t,f),a={min:e.min,max:e.max};u.add(a,r)})));const d=await c.expandSymbol(e.defaultSymbol,i);if(d){const e=await n.createTemplateGroup(d,f);u.setDefault(e)}return u};var i=t.prototype;return i.add=function(e,t){this._intervals.push({interval:e,result:t}),this._intervals.sort(((e,t)=>e.interval.min-t.interval.min))},i.size=function(){return e.prototype.size.call(this)+this._intervals.length},i.match=function(e,t,n,i,r){if(null==this._fieldIndex&&!this._field)return this.getDefault();const a=null!=this._fieldIndex?t.getComputedNumericAtIndex(this._fieldIndex):this._getValueFromField(t);if(!a&&(null==a||isNaN(a)))return this.getDefault();for(let e=0;e<this._intervals.length;e++){const{interval:t,result:n}=this._intervals[e],i=a>=t.min,r=this._isMaxInclusive?a<=t.max:a<t.max;if(i&&r)return n}return this.getDefault()},i._needsNormalization=function(){const e=this._normalizationInfo;return e&&(e.normalizationField||e.normalizationTotal||e.normalizationType)},i._getValueFromField=function(e){const t=e.readAttribute(this._field);if(!this._needsNormalization())return t;const{normalizationField:n,normalizationTotal:i,normalizationType:r}=this._normalizationInfo,a=!!n&&e.readAttribute(n);if(r)switch(r){case"esriNormalizeByField":return a?t/a:void 0;case"esriNormalizeByLog":return Math.log(t)*Math.LOG10E;case"esriNormalizeByPercentOfTotal":return t/i*100;default:return void p.error(`Found unknown normalization type: ${r}`)}else p.error("Normalization is required, but no type was set!")},t}(h),_=function(e){function t(t,n,i){var r;return(r=e.call(this)||this).type="map",r._nullResult=null,r._resultsMap=new Map,r._fieldsIndex=i,r._fields=t,r._seperator=n||"",r}n._inheritsLoose(t,e),t.fromUVRenderer=async function(e,n,i){const r=e.fieldDelimiter,l=[e.field];e.field2&&l.push(e.field2),e.field3&&l.push(e.field3);const s=await c.expandSymbol(e.backgroundFillSymbol,i),o=new t(l,r,e.fieldIndex);await a.all(e.map.map((async e=>{const t=await c.expandSymbol(e.symbol,i),r=await n.createTemplateGroup(t,s);"<Null>"===e.value?o.setNullResult(r):o.add(e.value,r)})));const u=await c.expandSymbol(e.defaultSymbol,i);if(u){const e=await n.createTemplateGroup(u,s);o.setDefault(e)}return o};var i=t.prototype;return i.setNullResult=function(e){this._nullResult=e},i.add=function(e,t){this._resultsMap.set(e.toString(),t)},i.size=function(){return e.prototype.size.call(this)+this._resultsMap.size},i.match=function(e,t,n,i,r){if(null==this._fieldsIndex&&!this._fields)return this.getDefault();const a=null!=this._fieldsIndex?t.getComputedStringAtIndex(this._fieldsIndex):this._getValueFromFields(t);if(null!==this._nullResult&&(null==a||""===a||"<Null>"===a))return this._nullResult;if(!a&&null==a)return this.getDefault();const l=a.toString();return this._resultsMap.has(l)?this._resultsMap.get(l):this.getDefault()},i._getValueFromFields=function(e){const t=[];for(const n of this._fields){const i=e.readAttribute(n);t.push(i)}return t.join(this._seperator)},t}(h);let y=function(t){function i(e,n,i,r){var a;return(a=t.call(this)||this).type="dictionary",a._groupIdCache=new o(100),a._renderer=e,a._fieldMap=e.fieldMap,a._symbolFields=e.getSymbolFields(),a._templates=n,a._info=i,a._scaleFn=r,a}n._inheritsLoose(i,t),i.fromDictionaryRenderer=async function(t,n,r){const a=(await new Promise((function(t,n){e(["../../../../../renderers/DictionaryRenderer"],(function(e){t(d(e))}),n)}))).default.fromJSON(t.renderer);await a.fetchResources({spatialReference:r.spatialReference,fields:r.fields});return new i(a,n,r,await async function(e,t){const n=e||1;if("number"==typeof n)return(e,t,i)=>n;const i=await l.createRendererExpression(n,t.spatialReference,t.fields);return(e,n,r)=>u(i,e,{$view:r},t.geometryType,n)||1}(a.scaleExpression,r))};var h=i.prototype;return h._analyzeFeature=async function(e,t,n,i){const a=e.readLegacyFeature(),l=this._scaleFn(a,t,n),o=this._attributeHash(a)+"-"+l,u=this._groupIdCache.get(o);if(u)return u;const d={...n,spatialReference:this._info.spatialReference,abortOptions:i,fields:this._info.fields},h=await this._renderer.getSymbolAsync(a,d),m=f.createSymbolSchema(h,this._renderer),_=c.expandSymbol(m,this._info,i).then((e=>{if("expanded-cim"!==e.type)return p.error(new r("mapview-bad-type",`Found unexpected type ${e.type} in dictionary response`)),null;e.hash+="-"+l;for(const t of e.layers)t.scaleFactor=l,t.templateHash+="-"+l,"text"===t.type&&"string"==typeof t.text&&t.text.indexOf("[")>-1&&(t.text=s.createLabelOverrideFunction(this._fieldMap,t.text,t.cim.textCase));return this._templates.createTemplateGroup(e,null)}));return this._groupIdCache.put(o,_,1),_},h.analyze=async function(e,t,n,i,r){const l=t.getCursor(),s=[];for(;l.next();)s.push(this._analyzeFeature(l,n,i,r));return a.all(s)},h.match=function(e,t,n,i,r){return null},h._attributeHash=function(e){let t="";for(const n of this._symbolFields){const i=this._fieldMap[n];i&&(t+=e.attributes[i]+"-")}return t},i}(h);t.DictionaryMatcher=y,t.FeatureMatcher=h,t.IntervalMatcher=m,t.MapMatcher=_,Object.defineProperty(t,"__esModule",{value:!0})}));
