/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["require","exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/Error","../../../../../core/Logger","../../../../../core/LRUCache","../../../../../core/maybe","../../../../../support/arcadeOnDemand","../../../arcade/callExpressionWithFeature","../../../layers/support/cimSymbolUtils"],(function(e,t,n,r,i,o,l,a,s,u){"use strict";const c=i.getLogger("esri/views/2d/engine/webgl/util/Matcher");function f(e,t,n,r){return p.apply(this,arguments)}function p(){return(p=n._asyncToGenerator((function*(e,t,n,r){switch(e.type){case"simple":case"heatmap":return h.fromBasicRenderer(e,t,n,r);case"map":return _.fromUVRenderer(e,t,n,r);case"interval":return m.fromCBRenderer(e,t,n,r);case"dictionary":return S.fromDictionaryRenderer(e,t,n,r);case"pie-chart":return y.fromPieChartRenderer(e,t,n,r);case"subtype":return y.fromSubtypes(e,t,n,r)}}))).apply(this,arguments)}let d,h=function(){function e(){this.type="feature",this._defaultResult=null}e.fromBasicRenderer=function(){var t=n._asyncToGenerator((function*(t,n,r,i){const o=new e;if(t.symbol){const e=yield u.expandSymbol(t.symbol,r,i),l=n.createTemplateGroup(e,null);o.setDefault(l)}return o}));function r(e,n,r,i){return t.apply(this,arguments)}return r}(),e.fromPieChartRenderer=function(){var t=n._asyncToGenerator((function*(t,n,r,i){const o=new e;if(t.markerSymbol){const e=yield u.expandSymbol(t.markerSymbol,r,i);let l;t.fillSymbol&&(l=yield u.expandSymbol(t.fillSymbol,r,i));const a=n.createTemplateGroup(e,l);o.setDefault(a)}return o}));function r(e,n,r,i){return t.apply(this,arguments)}return r}();var t=e.prototype;return t.size=function(){return 1},t.getDefault=function(){return this._defaultResult},t.setDefault=function(e){this._defaultResult=e},t.match=function(e,t,n,r,i){return this.getDefault()},t.analyze=function(){var e=n._asyncToGenerator((function*(e,t,n,r,i,o){return null}));function t(t,n,r,i,o,l){return e.apply(this,arguments)}return t}(),e}(),y=function(e){function t(t,n){var r;return(r=e.call(this)||this)._subMatchers=t,r._subtypeField=n,r}return n._inheritsLoose(t,e),t.fromSubtypes=function(){var e=n._asyncToGenerator((function*(e,n,r,i){const o=new Map,l=[];for(const t in e.renderers){const a=parseInt(t,10),s=f(e.renderers[t],n,r,i).then((e=>o.set(a,e)));l.push(s)}return yield Promise.all(l),new t(o,e.subtypeField)}));function r(t,n,r,i){return e.apply(this,arguments)}return r}(),t.prototype.match=function(e,t,n,r,i){const o=t.readAttribute(this._subtypeField),l=this._subMatchers.get(o);return l?l.match(e,t,n,r,i):null},t}(h),m=function(e){function t(t,n,r,i){var o;return(o=e.call(this)||this).type="interval",o._intervals=[],o._isMaxInclusive=n,o._fieldIndex=i,o._field=t,o._normalizationInfo=r,o}n._inheritsLoose(t,e),t.fromCBRenderer=function(){var e=n._asyncToGenerator((function*(e,r,i,o){const{isMaxInclusive:l,normalizationField:a,normalizationTotal:s,normalizationType:c}=e,f=new t(e.field,l,{normalizationField:a,normalizationTotal:s,normalizationType:c},e.fieldIndex),p=yield u.expandSymbol(e.backgroundFillSymbol,i,o);yield Promise.all(e.intervals.map(function(){var e=n._asyncToGenerator((function*(e){const t=yield u.expandSymbol(e.symbol,i,o),n=yield r.createTemplateGroup(t,p),l={min:e.min,max:e.max};f.add(l,n)}));return function(t){return e.apply(this,arguments)}}()));const d=yield u.expandSymbol(e.defaultSymbol,i,o);if(d){const e=yield r.createTemplateGroup(d,p);f.setDefault(e)}return f}));function r(t,n,r,i){return e.apply(this,arguments)}return r}();var r=t.prototype;return r.add=function(e,t){this._intervals.push({interval:e,result:t}),this._intervals.sort(((e,t)=>e.interval.min-t.interval.min))},r.size=function(){return e.prototype.size.call(this)+this._intervals.length},r.match=function(e,t,n,r,i){if(null==this._fieldIndex&&!this._field)return this.getDefault();const o=null!=this._fieldIndex?t.getComputedNumericAtIndex(this._fieldIndex):this._getValueFromField(t);if(null==o||isNaN(o)||o===1/0||o===-1/0)return this.getDefault();for(let l=0;l<this._intervals.length;l++){const{interval:e,result:t}=this._intervals[l],n=o>=e.min,r=this._isMaxInclusive?o<=e.max:o<e.max;if(n&&r)return t}return this.getDefault()},r._needsNormalization=function(){const e=this._normalizationInfo;return e&&(e.normalizationField||e.normalizationTotal||e.normalizationType)},r._getValueFromField=function(e){const t=e.readAttribute(this._field);if(!this._needsNormalization()||null==t)return t;const{normalizationField:n,normalizationTotal:r,normalizationType:i}=this._normalizationInfo,o=e.readAttribute(n)??1;if(i)switch(i){case"esriNormalizeByField":return o?t/o:void 0;case"esriNormalizeByLog":return Math.log(t)*Math.LOG10E;case"esriNormalizeByPercentOfTotal":return t/r*100;default:return void c.error(`Found unknown normalization type: ${i}`)}else c.error("Normalization is required, but no type was set!")},t}(h),_=function(e){function t(t,n,r){var i;return(i=e.call(this)||this).type="map",i._nullResult=null,i._resultsMap=new Map,i._fields=[],i._fieldsIndex=r,i._fields=t,i._seperator=n||"",i}n._inheritsLoose(t,e),t.fromUVRenderer=function(){var e=n._asyncToGenerator((function*(e,r,i,o){const l=e.fieldDelimiter,a=[e.field];e.field2&&a.push(e.field2),e.field3&&a.push(e.field3);const s=yield u.expandSymbol(e.backgroundFillSymbol,i,o),c=new t(a,l,e.fieldIndex);yield Promise.all(e.map.map(function(){var e=n._asyncToGenerator((function*(e,t){const n=yield u.expandSymbol(e.symbol,i,o),l=t+1,a=yield r.createTemplateGroup(n,s,l);"<Null>"===e.value?c.setNullResult(a):c.add(e.value,a)}));return function(t,n){return e.apply(this,arguments)}}()));const f=yield u.expandSymbol(e.defaultSymbol,i,o);if(f){const e=Number.MAX_SAFE_INTEGER,t=yield r.createTemplateGroup(f,s,e);c.setDefault(t)}return c}));function r(t,n,r,i){return e.apply(this,arguments)}return r}();var r=t.prototype;return r.setNullResult=function(e){this._nullResult=e},r.add=function(e,t){this._resultsMap.set(e.toString(),t)},r.size=function(){return e.prototype.size.call(this)+this._resultsMap.size},r.match=function(e,t,n,r,i){if(null==this._fieldsIndex&&!this._fields)return this.getDefault();const o=null!=this._fieldsIndex?t.getComputedStringAtIndex(this._fieldsIndex):this._getValueFromFields(t);if(null!==this._nullResult&&(null==o||""===o||"<Null>"===o))return this._nullResult;if(null==o)return this.getDefault();const l=o.toString();return this._resultsMap.has(l)?this._resultsMap.get(l):this.getDefault()},r._getValueFromFields=function(e){const t=[];for(const n of this._fields){const r=e.readAttribute(n);null==r||""===r?t.push("<Null>"):t.push(r)}return t.join(this._seperator)},t}(h);function b(e,t){return g.apply(this,arguments)}function g(){return(g=n._asyncToGenerator((function*(e,t){const n=e||1;if("number"==typeof n)return(e,t,r)=>n;const r=yield a.createRendererExpression(n,t.spatialReference,t.fields);return(e,n,i)=>s(r,e,{$view:i},t.geometryType,n)||1}))).apply(this,arguments)}function v(){return x.apply(this,arguments)}function x(){return(x=n._asyncToGenerator((function*(){return d||(d=new Promise(((t,n)=>e(["../../../layers/features/createSymbolSchema"],t,n)))),d}))).apply(this,arguments)}let S=function(t){function i(e,n,r,i,l,a){var s;return(s=t.call(this)||this).type="dictionary",s._groupIdCache=new o(100),s._loader=e,s._fieldMap=e.fieldMap,s._symbolFields=e.getSymbolFields(),s._templates=n,s._info=r,s._scaleFn=i,s._schemaUtilsModule=l,s._symbolOptions=a,s}n._inheritsLoose(i,t),i.fromDictionaryRenderer=function(){var t=n._asyncToGenerator((function*(t,n,r,o){const[{DictionaryLoader:l},a]=yield Promise.all([new Promise(((t,n)=>e(["../../../../../renderers/support/DictionaryLoader"],t,n))),v()]),s=new l(t.url,t.config,t.fieldMap);yield s.fetchResources({spatialReference:r.spatialReference,fields:r.fields});return new i(s,n,r,yield b(t.scaleExpression,r),a,t.symbolOptions)}));function r(e,n,r,i){return t.apply(this,arguments)}return r}();var a=i.prototype;return a._analyzeFeature=function(){var e=n._asyncToGenerator((function*(e,t,n,i,o){const l=e.readLegacyFeature(),a=this._scaleFn(l,n,i),s=this._attributeHash(l)+"-"+a,f=this._groupIdCache.get(s);if(f)return f;const p={...i,spatialReference:this._info.spatialReference,abortOptions:o,fields:this._info.fields},d=yield this._loader.getSymbolAsync(l,p),h=this._schemaUtilsModule.createSymbolSchema(d,this._symbolOptions),y=u.expandSymbol(h,this._info,t,o).then((e=>{if("expanded-cim"!==e?.type)return c.error(new r("mapview-bad-type",`Found unexpected type ${e?.type} in dictionary response`)),null;e.hash+="-"+a;for(const t of e.layers)t.scaleFactor=a,t.templateHash+="-"+a;return this._templates.createTemplateGroup(e,null)}));return this._groupIdCache.put(s,y,1),y}));function t(t,n,r,i,o){return e.apply(this,arguments)}return t}(),a.analyze=function(){var e=n._asyncToGenerator((function*(e,t,n,r,i,o){const a=t.getCursor(),s=[];for(;a.next();)s.push(this._analyzeFeature(a,n,r,i,o));return Promise.all(s).then((e=>e.filter(l.isSome)))}));function t(t,n,r,i,o,l){return e.apply(this,arguments)}return t}(),a.match=function(e,t,n,r,i){return null},a._attributeHash=function(e){let t="";for(const n of this._symbolFields){const r=this._fieldMap?.[n];r&&(t+=e.attributes[r]+"-")}return t},i}(h);t.DictionaryMatcher=S,t.FeatureMatcher=h,t.IntervalMatcher=m,t.MapMatcher=_,t.SubtypeMatcher=y,t.createMatcher=f,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
