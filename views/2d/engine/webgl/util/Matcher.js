// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../../core/Error","../../../../../core/Logger","../../../../../core/LRUCache","../../../../../core/promiseUtils","../../../../../support/arcadeOnDemand","../../../../../symbols/cim/cimSymbolUtils","../../../../../symbols/cim/utils","../../../arcade/callExpressionWithFeature","../../../layers/features/schemaUtils","@dojo/framework/shim/Promise"],(function(e,t,r,n,i,a,s,o,l,u,c,f){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DictionaryMatcher=t.MapMatcher=t.IntervalMatcher=t.FeatureMatcher=void 0;var d=i.getLogger("esri/views/2d/engine/webgl/util/Matcher"),h=function(){function e(){this.type="feature",this._defaultResult=null}return e.fromBasicRenderer=function(t,n,i){return r.__awaiter(this,void 0,void 0,(function(){var a,s,o;return r.__generator(this,(function(r){switch(r.label){case 0:return a=new e,t.symbol?[4,l.expandSymbol(t.symbol,i)]:[3,2];case 1:s=r.sent(),o=n.createTemplateGroup(s,null),a.setDefault(o),r.label=2;case 2:return[2,a]}}))}))},e.prototype.size=function(){return 1},e.prototype.getDefault=function(){return this._defaultResult},e.prototype.setDefault=function(e){this._defaultResult=e},e.prototype.match=function(e,t,r,n,i){return this.getDefault()},e.prototype.analyze=function(e,t,n,i,a){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){return[2,null]}))}))},e}();t.FeatureMatcher=h;var p=function(e){function t(t,r,n,i){var a=e.call(this)||this;return a.type="interval",a._intervals=[],a._isMaxInclusive=r,a._fieldIndex=i,a._field=t,a._normalizationInfo=n,a}return r.__extends(t,e),t.fromCBRenderer=function(e,n,i){return r.__awaiter(this,void 0,void 0,(function(){var a,o,u,c,f,d,h,p,_,m=this;return r.__generator(this,(function(y){switch(y.label){case 0:return a=e.isMaxInclusive,o=e.normalizationField,u=e.normalizationTotal,c=e.normalizationType,f=e.field,d=new t(f,a,{normalizationField:o,normalizationTotal:u,normalizationType:c},e.fieldIndex),[4,l.expandSymbol(e.backgroundFillSymbol,i)];case 1:return h=y.sent(),[4,s.all(e.intervals.map((function(e){return r.__awaiter(m,void 0,void 0,(function(){var t,a,s;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,l.expandSymbol(e.symbol,i)];case 1:return t=r.sent(),[4,n.createTemplateGroup(t,h)];case 2:return a=r.sent(),s={min:e.min,max:e.max},d.add(s,a),[2]}}))}))})))];case 2:return y.sent(),[4,l.expandSymbol(e.defaultSymbol,i)];case 3:return(p=y.sent())?[4,n.createTemplateGroup(p,h)]:[3,5];case 4:_=y.sent(),d.setDefault(_),y.label=5;case 5:return[2,d]}}))}))},t.prototype.add=function(e,t){this._intervals.push({interval:e,result:t}),this._intervals.sort((function(e,t){return e.interval.min-t.interval.min}))},t.prototype.size=function(){return e.prototype.size.call(this)+this._intervals.length},t.prototype.match=function(e,t,r,n,i){if(null==this._fieldIndex&&!this._field)return this.getDefault();var a=null!=this._fieldIndex?t.getComputedNumericAtIndex(this._fieldIndex):this._getValueFromField(t);if(!a&&(null==a||isNaN(a)))return this.getDefault();for(var s=0;s<this._intervals.length;s++){var o=this._intervals[s],l=o.interval,u=o.result,c=a>=l.min,f=this._isMaxInclusive?a<=l.max:a<l.max;if(c&&f)return u}return this.getDefault()},t.prototype._needsNormalization=function(){var e=this._normalizationInfo;return e&&(e.normalizationField||e.normalizationTotal||e.normalizationType)},t.prototype._getValueFromField=function(e){var t=e.readAttribute(this._field);if(!this._needsNormalization())return t;var r=this._normalizationInfo,n=r.normalizationField,i=r.normalizationTotal,a=r.normalizationType,s=!!n&&e.readAttribute(n);if(a)switch(a){case"esriNormalizeByField":return s?t/s:void 0;case"esriNormalizeByLog":return Math.log(t)*Math.LOG10E;case"esriNormalizeByPercentOfTotal":return t/i*100;default:return void d.error("Found unknown normalization type: "+a)}else d.error("Normalization is required, but no type was set!")},t}(h);t.IntervalMatcher=p;var _=function(e){function t(t,r,n){var i=e.call(this)||this;return i.type="map",i._nullResult=null,i._resultsMap=new Map,i._fieldsIndex=n,i._fields=t,i._seperator=r||"",i}return r.__extends(t,e),t.fromUVRenderer=function(e,n,i){return r.__awaiter(this,void 0,void 0,(function(){var a,o,u,c,f,d,h=this;return r.__generator(this,(function(p){switch(p.label){case 0:return a=e.fieldDelimiter,o=[e.field],e.field2&&o.push(e.field2),e.field3&&o.push(e.field3),[4,l.expandSymbol(e.backgroundFillSymbol,i)];case 1:return u=p.sent(),c=new t(o,a,e.fieldIndex),[4,s.all(e.map.map((function(e){return r.__awaiter(h,void 0,void 0,(function(){var t,a;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,l.expandSymbol(e.symbol,i)];case 1:return t=r.sent(),[4,n.createTemplateGroup(t,u)];case 2:return a=r.sent(),"<Null>"===e.value?c.setNullResult(a):c.add(e.value,a),[2]}}))}))})))];case 2:return p.sent(),[4,l.expandSymbol(e.defaultSymbol,i)];case 3:return(f=p.sent())?[4,n.createTemplateGroup(f,u)]:[3,5];case 4:d=p.sent(),c.setDefault(d),p.label=5;case 5:return[2,c]}}))}))},t.prototype.setNullResult=function(e){this._nullResult=e},t.prototype.add=function(e,t){this._resultsMap.set(e.toString(),t)},t.prototype.size=function(){return e.prototype.size.call(this)+this._resultsMap.size},t.prototype.match=function(e,t,r,n,i){if(null==this._fieldsIndex&&!this._fields)return this.getDefault();var a=null!=this._fieldsIndex?t.getComputedStringAtIndex(this._fieldsIndex):this._getValueFromFields(t);if(null!==this._nullResult&&(null==a||""===a||"<Null>"===a))return this._nullResult;if(!a&&null==a)return this.getDefault();var s=a.toString();return this._resultsMap.has(s)?this._resultsMap.get(s):this.getDefault()},t.prototype._getValueFromFields=function(e){for(var t=[],r=0,n=this._fields;r<n.length;r++){var i=n[r],a=e.readAttribute(i);t.push(a)}return t.join(this._seperator)},t}(h);function m(e,t){return r.__awaiter(this,void 0,void 0,(function(){var n,i;return r.__generator(this,(function(r){switch(r.label){case 0:return"number"==typeof(n=e||1)?[2,function(e,t,r){return n}]:[4,o.createRendererExpression(n,t.spatialReference,t.fields)];case 1:return i=r.sent(),[2,function(e,r,n){return c.default(i,e,{$view:n},t.geometryType,r)||1}]}}))}))}t.MapMatcher=_;var y=function(t){function i(e,r,n,i){var s=t.call(this)||this;return s.type="dictionary",s._groupIdCache=new a(100),s._renderer=e,s._fieldMap=e.fieldMap,s._symbolFields=e.getSymbolFields(),s._templates=r,s._info=n,s._scaleFn=i,s}return r.__extends(i,t),i.fromDictionaryRenderer=function(t,n,a){return r.__awaiter(this,void 0,void 0,(function(){var s,o,l;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,new Promise((function(t,r){e(["../../../../../renderers/DictionaryRenderer"],t,r)}))];case 1:return s=r.sent(),[4,(o=s.fromJSON(t.renderer)).fetchResources({spatialReference:a.spatialReference,fields:a.fields})];case 2:return r.sent(),[4,m(o.scaleExpression,a)];case 3:return l=r.sent(),[2,new i(o,n,a,l)]}}))}))},i.prototype._analyzeFeature=function(e,t,i,a){return r.__awaiter(this,void 0,void 0,(function(){var s,o,c,h,p,_,m,y,v=this;return r.__generator(this,(function(g){switch(g.label){case 0:return s=e.readLegacyFeature(),o=this._scaleFn(s,t,i),c=this._attributeHash(s)+"-"+o,(h=this._groupIdCache.get(c))?[2,h]:(p=r.__assign(r.__assign({},i),{spatialReference:this._info.spatialReference,abortOptions:a,fields:this._info.fields}),[4,this._renderer.getSymbolAsync(s,p)]);case 1:return _=g.sent(),m=f.createSymbolSchema(_,this._renderer),y=l.expandSymbol(m,this._info,a).then((function(e){if("expanded-cim"!==e.type)return d.error(new n("mapview-bad-type","Found unexpected type "+e.type+" in dictionary response")),null;e.hash+="-"+o;for(var t=0,r=e.layers;t<r.length;t++){var i=r[t];i.scaleFactor=o,i.templateHash+="-"+o,"text"===i.type&&"string"==typeof i.text&&i.text.indexOf("[")>-1&&(i.text=u.createLabelOverrideFunction(v._fieldMap,i.text,i.cim.textCase))}return v._templates.createTemplateGroup(e,null)})),this._groupIdCache.put(c,y,1),[2,y]}}))}))},i.prototype.analyze=function(e,t,n,i,a){return r.__awaiter(this,void 0,void 0,(function(){var e,o;return r.__generator(this,(function(r){for(e=t.getCursor(),o=[];e.next();)o.push(this._analyzeFeature(e,n,i,a));return[2,s.all(o)]}))}))},i.prototype.match=function(e,t,r,n,i){return null},i.prototype._attributeHash=function(e){for(var t="",r=0,n=this._symbolFields;r<n.length;r++){var i=n[r],a=this._fieldMap[i];a&&(t+=e.attributes[a]+"-")}return t},i}(h);t.DictionaryMatcher=y}));