/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["require","exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/Error","../../../../../core/Logger","../../../../../core/LRUCache","../../../../../support/arcadeOnDemand","../../../../../symbols/cim/utils","../../../arcade/callExpressionWithFeature","../../../layers/support/cimSymbolUtils"],(function(e,t,n,r,i,l,o,a,s,u){"use strict";const c=e=>Object.freeze({__proto__:null,default:e}),f=i.getLogger("esri/views/2d/engine/webgl/util/Matcher");function d(e,t,n,r){return p.apply(this,arguments)}function p(){return(p=n._asyncToGenerator((function*(e,t,n,r){switch(e.type){case"simple":return y.fromBasicRenderer(e,t,n,r);case"map":return b.fromUVRenderer(e,t,n,r);case"interval":return _.fromCBRenderer(e,t,n,r);case"dictionary":return F.fromDictionaryRenderer(e,t,n,r);case"subtype":return m.fromSubtypes(e,t,n,r)}}))).apply(this,arguments)}let h,y=function(){function e(){this.type="feature",this._defaultResult=null}e.fromBasicRenderer=function(){var t=n._asyncToGenerator((function*(t,n,r,i){const l=new e;if(t.symbol){const e=yield u.expandSymbol(t.symbol,r,i),o=n.createTemplateGroup(e,null);l.setDefault(o)}return l}));function r(e,n,r,i){return t.apply(this,arguments)}return r}();var t=e.prototype;return t.size=function(){return 1},t.getDefault=function(){return this._defaultResult},t.setDefault=function(e){this._defaultResult=e},t.match=function(e,t,n,r,i){return this.getDefault()},t.analyze=function(){var e=n._asyncToGenerator((function*(e,t,n,r,i,l){return null}));function t(t,n,r,i,l,o){return e.apply(this,arguments)}return t}(),e}(),m=function(e){function t(t,n){var r;return(r=e.call(this)||this)._subMatchers=t,r._subtypeField=n,r}return n._inheritsLoose(t,e),t.fromSubtypes=function(){var e=n._asyncToGenerator((function*(e,n,r,i){const l=new Map,o=[];for(const t in e.renderers){const a=parseInt(t,10),s=d(e.renderers[t],n,r,i).then((e=>l.set(a,e)));o.push(s)}return yield Promise.all(o),new t(l,e.subtypeField)}));function r(t,n,r,i){return e.apply(this,arguments)}return r}(),t.prototype.match=function(e,t,n,r,i){const l=t.readAttribute(this._subtypeField),o=this._subMatchers.get(l);return o?o.match(e,t,n,r,i):null},t}(y),_=function(e){function t(t,n,r,i){var l;return(l=e.call(this)||this).type="interval",l._intervals=[],l._isMaxInclusive=n,l._fieldIndex=i,l._field=t,l._normalizationInfo=r,l}n._inheritsLoose(t,e),t.fromCBRenderer=function(){var e=n._asyncToGenerator((function*(e,r,i,l){const{isMaxInclusive:o,normalizationField:a,normalizationTotal:s,normalizationType:c}=e,f=new t(e.field,o,{normalizationField:a,normalizationTotal:s,normalizationType:c},e.fieldIndex),d=yield u.expandSymbol(e.backgroundFillSymbol,i,l);yield Promise.all(e.intervals.map(function(){var e=n._asyncToGenerator((function*(e){const t=yield u.expandSymbol(e.symbol,i,l),n=yield r.createTemplateGroup(t,d),o={min:e.min,max:e.max};f.add(o,n)}));return function(t){return e.apply(this,arguments)}}()));const p=yield u.expandSymbol(e.defaultSymbol,i,l);if(p){const e=yield r.createTemplateGroup(p,d);f.setDefault(e)}return f}));function r(t,n,r,i){return e.apply(this,arguments)}return r}();var r=t.prototype;return r.add=function(e,t){this._intervals.push({interval:e,result:t}),this._intervals.sort(((e,t)=>e.interval.min-t.interval.min))},r.size=function(){return e.prototype.size.call(this)+this._intervals.length},r.match=function(e,t,n,r,i){if(null==this._fieldIndex&&!this._field)return this.getDefault();const l=null!=this._fieldIndex?t.getComputedNumericAtIndex(this._fieldIndex):this._getValueFromField(t);if(!l&&(null==l||isNaN(l)))return this.getDefault();for(let o=0;o<this._intervals.length;o++){const{interval:e,result:t}=this._intervals[o],n=l>=e.min,r=this._isMaxInclusive?l<=e.max:l<e.max;if(n&&r)return t}return this.getDefault()},r._needsNormalization=function(){const e=this._normalizationInfo;return e&&(e.normalizationField||e.normalizationTotal||e.normalizationType)},r._getValueFromField=function(e){const t=e.readAttribute(this._field);if(!this._needsNormalization()||null==t)return t;const{normalizationField:n,normalizationTotal:r,normalizationType:i}=this._normalizationInfo,l=!!n&&e.readAttribute(n);if(i)switch(i){case"esriNormalizeByField":return l?t/l:void 0;case"esriNormalizeByLog":return Math.log(t)*Math.LOG10E;case"esriNormalizeByPercentOfTotal":return t/r*100;default:return void f.error(`Found unknown normalization type: ${i}`)}else f.error("Normalization is required, but no type was set!")},t}(y),b=function(e){function t(t,n,r){var i;return(i=e.call(this)||this).type="map",i._nullResult=null,i._resultsMap=new Map,i._fieldsIndex=r,i._fields=t,i._seperator=n||"",i}n._inheritsLoose(t,e),t.fromUVRenderer=function(){var e=n._asyncToGenerator((function*(e,r,i,l){const o=e.fieldDelimiter,a=[e.field];e.field2&&a.push(e.field2),e.field3&&a.push(e.field3);const s=yield u.expandSymbol(e.backgroundFillSymbol,i,l),c=new t(a,o,e.fieldIndex);yield Promise.all(e.map.map(function(){var e=n._asyncToGenerator((function*(e){const t=yield u.expandSymbol(e.symbol,i,l),n=yield r.createTemplateGroup(t,s);"<Null>"===e.value?c.setNullResult(n):c.add(e.value,n)}));return function(t){return e.apply(this,arguments)}}()));const f=yield u.expandSymbol(e.defaultSymbol,i,l);if(f){const e=yield r.createTemplateGroup(f,s);c.setDefault(e)}return c}));function r(t,n,r,i){return e.apply(this,arguments)}return r}();var r=t.prototype;return r.setNullResult=function(e){this._nullResult=e},r.add=function(e,t){this._resultsMap.set(e.toString(),t)},r.size=function(){return e.prototype.size.call(this)+this._resultsMap.size},r.match=function(e,t,n,r,i){if(null==this._fieldsIndex&&!this._fields)return this.getDefault();const l=null!=this._fieldsIndex?t.getComputedStringAtIndex(this._fieldsIndex):this._getValueFromFields(t);if(null!==this._nullResult&&(null==l||""===l||"<Null>"===l))return this._nullResult;if(!l&&null==l)return this.getDefault();const o=l.toString();return this._resultsMap.has(o)?this._resultsMap.get(o):this.getDefault()},r._getValueFromFields=function(e){const t=[];for(const n of this._fields){const r=e.readAttribute(n);null==r||""===r?t.push("<Null>"):t.push(r)}return t.join(this._seperator)},t}(y);function v(e,t){return g.apply(this,arguments)}function g(){return(g=n._asyncToGenerator((function*(e,t){const n=e||1;if("number"==typeof n)return(e,t,r)=>n;const r=yield o.createRendererExpression(n,t.spatialReference,t.fields);return(e,n,i)=>s(r,e,{$view:i},t.geometryType,n)||1}))).apply(this,arguments)}function x(){return z.apply(this,arguments)}function z(){return(z=n._asyncToGenerator((function*(){return h||(h=new Promise(((t,n)=>e(["../../../layers/features/schemaUtils"],t,n)))),h}))).apply(this,arguments)}let F=function(t){function i(e,n,r,i,o){var a;return(a=t.call(this)||this).type="dictionary",a._groupIdCache=new l(100),a._renderer=e,a._fieldMap=e.fieldMap,a._symbolFields=e.getSymbolFields(),a._templates=n,a._info=r,a._scaleFn=i,a._schemaUtilsModule=o,a}n._inheritsLoose(i,t),i.fromDictionaryRenderer=function(){var t=n._asyncToGenerator((function*(t,n,r,l){const[{default:o},a]=yield Promise.all([new Promise(((t,n)=>e(["../../../../../renderers/DictionaryRenderer"],(e=>t(c(e))),n))),x()]),s=o.fromJSON(t.renderer);yield s.fetchResources({spatialReference:r.spatialReference,fields:r.fields});return new i(s,n,r,yield v(s.scaleExpression,r),a)}));function r(e,n,r,i){return t.apply(this,arguments)}return r}();var o=i.prototype;return o._analyzeFeature=function(){var e=n._asyncToGenerator((function*(e,t,n,i,l){const o=e.readLegacyFeature(),s=this._scaleFn(o,n,i),c=this._attributeHash(o)+"-"+s,d=this._groupIdCache.get(c);if(d)return d;const p={...i,spatialReference:this._info.spatialReference,abortOptions:l,fields:this._info.fields},h=yield this._renderer.getSymbolAsync(o,p),y=this._schemaUtilsModule.createSymbolSchema(h,this._renderer),m=u.expandSymbol(y,this._info,t,l).then((e=>{if("expanded-cim"!==e.type)return f.error(new r("mapview-bad-type",`Found unexpected type ${e.type} in dictionary response`)),null;e.hash+="-"+s;for(const t of e.layers)t.scaleFactor=s,t.templateHash+="-"+s,"text"===t.type&&"string"==typeof t.text&&t.text.indexOf("[")>-1&&(t.text=a.createLabelOverrideFunction(this._fieldMap,t.text,t.cim.textCase));return this._templates.createTemplateGroup(e,null)}));return this._groupIdCache.put(c,m,1),m}));function t(t,n,r,i,l){return e.apply(this,arguments)}return t}(),o.analyze=function(){var e=n._asyncToGenerator((function*(e,t,n,r,i,l){const o=t.getCursor(),a=[];for(;o.next();)a.push(this._analyzeFeature(o,n,r,i,l));return Promise.all(a)}));function t(t,n,r,i,l,o){return e.apply(this,arguments)}return t}(),o.match=function(e,t,n,r,i){return null},o._attributeHash=function(e){let t="";for(const n of this._symbolFields){const r=this._fieldMap[n];r&&(t+=e.attributes[r]+"-")}return t},i}(y);t.DictionaryMatcher=F,t.FeatureMatcher=y,t.IntervalMatcher=_,t.MapMatcher=b,t.SubtypeMatcher=m,t.createMatcher=d,Object.defineProperty(t,"__esModule",{value:!0})}));
