/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/has","../../../../core/maybe","../../../../core/CircularArray","../../../../chunks/vec2","./definitions","../../../../chunks/mat2d","../../../../chunks/mat2df32","../../../../chunks/vec2f32","./TiledDisplayObject","./enums","./DirtyMap","./DisplayRecordStore","./Fader","./WGLBuffers"],(function(t,e,s,i,a,l,r,d,n,o,h,c,p,y,u,f){"use strict";const _=new Set;let D=function(t){function s(e,s,i=!1){var l;return(l=t.call(this,e,s,[r.TILE_SIZE,r.TILE_SIZE])||this)._data=null,l._displayList=null,l._wglBuffers=null,l._deferPatches=!1,l._dirtyMap=new p,l._labelIndex=null,l._lastCommitTime=0,l._patchQueue=new a(100),l.fader=new u,l._dirty=!0,l._replaceBuffers=!1,l._uploadsLocked=!1,l._hasData=!1,l._invalidated=!1,l.transforms.labelMat2d=n.create(),l._ensureCorrectZOrder=i,l._deferPatches=!i,l}e._inheritsLoose(s,t);var h=s.prototype;return h.destroy=function(){t.prototype.destroy.call(this),this.clear()},h.getGeometry=function(t){return this._wglBuffers&&this._wglBuffers.has(t)?this._wglBuffers.get(t):null},h.getDisplayList=function(){return this._displayList},h.setTransform=function(e,s){t.prototype.setTransform.call(this,e,s);const i=this.transforms.labelMat2d,a=e.getScreenTransform(i,s),r=o.create();l.transformMat2d(r,this.coords,a),d.identity(i),d.translate(i,i,r),d.multiply(i,e.viewMat2d,i)},h.setData=function(t){const e=t.addOrUpdate,s=t.remove;t.clear&&(this.clear(),this._patchQueue.clear(),this._hasData=!1),"replace"===t.type&&(this._replaceBuffers=!0,this._patchQueue.clear(),this._data=null),!this._data&&e&&e.tileDisplayData.displayObjects.length?(e.tileDisplayData.computeDisplayList(this._ensureCorrectZOrder),this._dirtyMap=new p,this._dispRecStore=y.fromTileData(e,this._dirtyMap),this._data=e,this._dirtyMap.markAllDirty(),this._hasData=!0,t.end&&this.ready()):this._data&&(e&&e.tileDisplayData.displayObjects.length||s.length)?this._deferPatches?this._patchQueue.enqueue(t):this._doPatchData(t):t.end&&this.ready(),t.end&&!this._data&&this.clear(),this.requestRender(),this.emit("change")},h.lockUploads=function(){this._uploadsLocked=!0},h.unlockUploads=function(){this._uploadsLocked=!1,this.requestRender()},h.commitChanges=function(t){if(!t.time||t.time!==this._lastCommitTime){if(this._lastCommitTime=t.time,this.fader.step()||this.requestRender(),this._patchQueue.size){const t=this._patchQueue.dequeue();i.isSome(t)&&(t.end&&this.ready(),this._doPatchData(t),this.requestRender(),this._hasData=!0)}if(this._uploadsLocked)this.requestRender();else if(this.visible&&this._data){if(this._replaceBuffers)for(this._wglBuffers&&this._wglBuffers.dispose(),this._wglBuffers=null,this._replaceBuffers=!1;this._patchQueue.size;){const t=this._patchQueue.dequeue();i.isSome(t)&&(t.end&&this.ready(),this._doPatchData(t),this._hasData=!0)}this._wglBuffers||(this._wglBuffers=new f(t.context)),(this._dirtyMap.hasDirty()||this._invalidated)&&(this._invalidated=!1,this._wglBuffers.upload(this._data.tileBufferData,this._dirtyMap),this._displayList=this._data.tileDisplayData.displayList.clone(),this._displayObjects=this._data.tileDisplayData.displayObjects.slice(),this._rebuildLabelIndex(),this._dirtyMap.markAllClean())}}},h.clear=function(){this._data=null,this._displayList=null,this._dispRecStore=null,this._wglBuffers&&(this._wglBuffers.dispose(),this._wglBuffers=null)},h._doPatchData=function(t){try{if("new"===t.type){if(!t.addOrUpdate)return;this._invalidated=!0;const e=this._bulkAddFeatures(t);e&&(this._dirtyMap.markAllDirty(),this._data.reshuffleBulkAdd(t,e.objectIndex,e.recordIndex),this._dispRecStore=y.fromTileData(this._data,this._dirtyMap))}else this._invalidated=!0,this._patchData(t)||(this._dirtyMap.markAllDirty(),this._data.reshuffle(),this._dispRecStore=y.fromTileData(this._data,this._dirtyMap))}catch(t){}this.requestRender()},h._rebuildLabelIndex=function(){var t,e;if(!(null==(t=this._data)||null==(e=t.tileBufferData.geometries[c.WGLGeometryType.LABEL])||!e.indexBuffer.length)){this.isDirty=!0,this._labelIndex=this._initLabelIndex();for(const t of this.displayObjects)for(const e of t.metrics)this._insertIntoLabelIndex(e)}},h._insertIntoLabelIndex=function(t){if(t.xBucket<0||t.yBucket<0||t.yBucket>3||t.xBucket>3)return;this.labelIndex[t.yBucket][t.xBucket].push(t)},h._initLabelIndex=function(){const t=[];for(let e=0;e<r.TILE_SIZE/r.COLLISION_BUCKET_SIZE;e++){t.push([]);for(let s=0;s<r.TILE_SIZE/r.COLLISION_BUCKET_SIZE;s++)t[e].push([])}return t},h._bulkAddFeatures=function(t){const e=t.addOrUpdate.tileDisplayData.displayObjects,s=this._data.tileDisplayData.displayObjects,i=this._data.tileDisplayData.displayObjectRegistry;for(let a=0;a<e.length;a++){const l=e[a],r=i.get(l.id);for(let e=0;e<l.displayRecords.length;++e){const s=l.displayRecords[e];if(r){if(s.geometryType!==c.WGLGeometryType.FILL&&s.geometryType!==c.WGLGeometryType.LINE)continue;r.displayRecords.push(s)}const i=t.addOrUpdate.tileBufferData.geometries[s.geometryType];if(!this._dispRecStore.tryAddMeshData(s,i))return{objectIndex:a,recordIndex:e}}r||(i.set(l.id,l),s.push(l))}return null},h._patchData=function(t){let e=!0;const s=t.addOrUpdate&&t.addOrUpdate.tileDisplayData&&t.addOrUpdate.tileDisplayData.displayObjects||[],i=(t.remove||[]).slice();for(const t of s)null!=t.insertAfter&&i.push(t.id);for(const t of i){const e=this._data.tileDisplayData.displayObjectRegistry.get(t);if(e){this._data.tileDisplayData.displayList.removeFromList(e.displayRecords);for(const t of e.displayRecords)this._dispRecStore.delete(t);this._data.tileDisplayData.displayObjectRegistry.delete(t);const s=this._data.tileDisplayData.displayObjects.indexOf(e);this._data.tileDisplayData.displayObjects.splice(s,1)}}for(const i of s){let s,a=this._data.tileDisplayData.displayObjectRegistry.get(i.id);if(a){const t=a.displayRecords;a.set(i),a.displayRecords=t;const e=a.displayRecords.length;for(let t=0;t<e;++t){const e=a.displayRecords[t],s=i.displayRecords[t];(t>=i.displayRecords.length||e.geometryType!==s.geometryType||e.symbolLevel!==s.symbolLevel||e.zOrder!==s.zOrder||e.materialKey!==s.materialKey)&&(this._dispRecStore.delete(a.displayRecords[t]),t<i.displayRecords.length&&(a.displayRecords[t]=void 0))}a.displayRecords.length=i.displayRecords.length,a.metrics=i.metrics}else{let t;a=i.copy(),a.displayRecords=[],this._data.tileDisplayData.displayObjectRegistry.set(i.id,a);const e=this._data.tileDisplayData.displayObjects;if(null!=a.insertAfter)if(s={},a.insertAfter>=0){const s=this._data.tileDisplayData.displayObjectRegistry.get(a.insertAfter);s?(t=e.indexOf(s)+1,t<e.length?e.splice(t,0,a):(e.push(a),t=e.length)):(e.push(a),t=e.length)}else e.unshift(a),t=0;else e.push(a),t=e.length;if(s){let a;if(this._data.tileDisplayData.displayList.unified)a=i.displayRecords.length>0?1:0;else{_.clear();for(const t of i.displayRecords){const e=this._data.tileDisplayData.displayList.getDPInfoType(t.geometryType);_.add(e)}a=_.size}let l=0;for(let i=t-1;i>=0&&l<a;--i)for(let t=e[i].displayRecords.length-1;t>=0&&l<a;--t){const a=e[i].displayRecords[t],r=this._data.tileDisplayData.displayList.getDPInfoType(a.geometryType);s[r]||(s[r]=a,++l)}}}const l=i.displayRecords.length;for(let r=0;r<l;++r){const l=i.displayRecords[r];let d=a.displayRecords[r];d?(d.meshData=l.meshData,d.materialKey=l.materialKey):(d=l.copy(),d.vertexFrom=void 0,d.indexFrom=void 0,a.displayRecords[r]=d);const n=l.geometryType,o=this._data.tileDisplayData.displayList.getDPInfoType(n),h=t.addOrUpdate.tileBufferData.geometries[n],c=h.vertexBuffer,p=h.indexBuffer;let y;s&&(y=s[o]?this._data.tileDisplayData.displayList.splitAfter(s[o]):-1),e=this._dispRecStore.setMeshData(d,l,c,p,y)&&e,s&&null!=d.indexFrom&&null!=d.indexFrom&&(s[o]=d)}}return e},e._createClass(s,[{key:"displayObjects",get:function(){var t;return null!=(t=this._displayObjects)?t:[]}},{key:"isDirty",get:function(){return this._dirty},set:function(t){this._dirty=t,this.requestRender()}},{key:"hasData",get:function(){return!!this._hasData}},{key:"labelIndex",get:function(){return this._labelIndex}}]),s}(h.TiledDisplayObject);t.WGLTile=D,Object.defineProperty(t,"__esModule",{value:!0})}));
