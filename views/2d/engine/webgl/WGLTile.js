// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../core/CircularArray","../../../../core/has","../../../../core/maybe","../../../../core/libs/gl-matrix-2/mat2d","../../../../core/libs/gl-matrix-2/mat2df32","../../../../core/libs/gl-matrix-2/vec2","../../../../core/libs/gl-matrix-2/vec2f32","./definitions","./DirtyMap","./DisplayRecordStore","./enums","./Fader","./TiledDisplayObject","./WGLBuffers"],(function(e,t,a,i,s,r,l,d,o,p,n,h,y,c,u,f,_){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WGLTile=void 0;var D=new Set,g=function(e){function t(t,a,s){void 0===s&&(s=!1);var r=e.call(this,t,a,[n.TILE_SIZE,n.TILE_SIZE])||this;return r._data=null,r._displayList=null,r._wglBuffers=null,r._deferPatches=!1,r._dirtyMap=new h.default,r._labelIndex=null,r._lastCommitTime=0,r._patchQueue=new i.default(100),r.fader=new u.default,r._dirty=!0,r._replaceBuffers=!1,r._uploadsLocked=!1,r._hasData=!1,r._invalidated=!1,r.transforms.labelMat2d=d.mat2df32.create(),r._ensureCorrectZOrder=s,r._deferPatches=!s,r}return a.__extends(t,e),t.prototype.destroy=function(){e.prototype.destroy.call(this),this.clear()},Object.defineProperty(t.prototype,"displayObjects",{get:function(){var e;return null!==(e=this._displayObjects)&&void 0!==e?e:[]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isDirty",{get:function(){return this._dirty},set:function(e){this._dirty=e,this.requestRender()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"hasData",{get:function(){return!!this._hasData},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"labelIndex",{get:function(){return this._labelIndex},enumerable:!1,configurable:!0}),t.prototype.getGeometry=function(e){return this._wglBuffers&&this._wglBuffers.has(e)?this._wglBuffers.get(e):null},t.prototype.getDisplayList=function(){return this._displayList},t.prototype.setTransform=function(t,a){e.prototype.setTransform.call(this,t,a);var i=this.transforms.labelMat2d,s=t.getScreenTransform(i,a),r=p.vec2f32.create();o.vec2.transformMat2d(r,this.coords,s),l.mat2d.identity(i),l.mat2d.translate(i,i,r),l.mat2d.multiply(i,t.viewMat2d,i)},t.prototype.setData=function(e){var t=e.addOrUpdate,a=e.remove;e.clear&&(this.clear(),this._patchQueue.clear(),this._hasData=!1),"replace"===e.type&&(this._replaceBuffers=!0,this._patchQueue.clear(),this._data=null),!this._data&&t&&t.tileDisplayData.displayObjects.length?(t.tileDisplayData.computeDisplayList(this._ensureCorrectZOrder),this._dirtyMap=new h.default,this._dispRecStore=y.default.fromTileData(t,this._dirtyMap),this._data=t,this._dirtyMap.markAllDirty(),this._hasData=!0,e.end&&this.ready()):this._data&&(t&&t.tileDisplayData.displayObjects.length||a.length)?this._deferPatches?this._patchQueue.enqueue(e):this._doPatchData(e):e.end&&this.ready(),e.end&&!this._data&&this.clear(),this.requestRender(),this.emit("change")},t.prototype.lockUploads=function(){this._uploadsLocked=!0},t.prototype.unlockUploads=function(){this._uploadsLocked=!1,this.requestRender()},t.prototype.commitChanges=function(e){if(!e.time||e.time!==this._lastCommitTime){if(this._lastCommitTime=e.time,this.fader.step()||this.requestRender(),this._patchQueue.size){var t=this._patchQueue.dequeue();r.isSome(t)&&(t.end&&this.ready(),this._doPatchData(t),this.requestRender(),this._hasData=!0)}if(this._uploadsLocked)this.requestRender();else if(this.visible&&this._data){if(this._replaceBuffers)for(this._wglBuffers&&this._wglBuffers.dispose(),this._wglBuffers=null,this._replaceBuffers=!1;this._patchQueue.size;){t=this._patchQueue.dequeue();r.isSome(t)&&(t.end&&this.ready(),this._doPatchData(t),this._hasData=!0)}this._wglBuffers||(this._wglBuffers=new _.default(e.context)),(this._dirtyMap.hasDirty()||this._invalidated)&&(this._invalidated=!1,this._wglBuffers.upload(this._data.tileBufferData,this._dirtyMap),this._displayList=this._data.tileDisplayData.displayList.clone(),this._displayObjects=this._data.tileDisplayData.displayObjects.slice(),this._rebuildLabelIndex(),this._dirtyMap.markAllClean())}}},t.prototype.clear=function(){this._data=null,this._displayList=null,this._dispRecStore=null,this._wglBuffers&&(this._wglBuffers.dispose(),this._wglBuffers=null)},t.prototype._doPatchData=function(e){try{if("new"===e.type){if(!e.addOrUpdate)return;this._invalidated=!0;var t=this._bulkAddFeatures(e);t&&(this._dirtyMap.markAllDirty(),this._data.reshuffleV2(e,t.objectIndex,t.recordIndex),this._dispRecStore=y.default.fromTileData(this._data,this._dirtyMap))}else this._invalidated=!0,this._patchData(e)||(this._dirtyMap.markAllDirty(),this._data.reshuffle(),this._dispRecStore=y.default.fromTileData(this._data,this._dirtyMap))}catch(e){s("esri-2d-debug")&&console.debug("Encountered an error while patching:",e)}this.requestRender()},t.prototype._rebuildLabelIndex=function(){var e,t;if(!!(null===(t=null===(e=this._data)||void 0===e?void 0:e.tileBufferData.geometries[c.WGLGeometryType.LABEL])||void 0===t?void 0:t.indexBuffer.length)){this.isDirty=!0,this._labelIndex=this._initLabelIndex();for(var a=0,i=this.displayObjects;a<i.length;a++)for(var s=0,r=i[a].metrics;s<r.length;s++){var l=r[s];this._insertIntoLabelIndex(l)}}},t.prototype._insertIntoLabelIndex=function(e){e.xBucket<0||e.yBucket<0||e.yBucket>3||e.xBucket>3||this.labelIndex[e.yBucket][e.xBucket].push(e)},t.prototype._initLabelIndex=function(){for(var e=[],t=0;t<n.TILE_SIZE/n.COLLISION_BUCKET_SIZE;t++){e.push([]);for(var a=0;a<n.TILE_SIZE/n.COLLISION_BUCKET_SIZE;a++)e[t].push([])}return e},t.prototype._bulkAddFeatures=function(e){for(var t=e.addOrUpdate.tileDisplayData.displayObjects,a=this._data.tileDisplayData.displayObjects,i=0;i<t.length;i++){for(var s=t[i],r=0;r<s.displayRecords.length;++r){var l=s.displayRecords[r],d=e.addOrUpdate.tileBufferData.geometries[l.geometryType];if(!this._dispRecStore.tryAddMeshData(l,d))return{objectIndex:i,recordIndex:r}}if(this._data.tileDisplayData.hasRegistry)this._data.tileDisplayData.displayObjectRegistry.set(s.id,s);a.push(s)}return null},t.prototype._patchData=function(e){for(var t=!0,a=e.addOrUpdate&&e.addOrUpdate.tileDisplayData&&e.addOrUpdate.tileDisplayData.displayObjects||[],i=(e.remove||[]).slice(),s=0,r=a;s<r.length;s++){null!=(_=r[s]).insertAfter&&i.push(_.id)}for(var l=0,d=i;l<d.length;l++){var o=d[l];if(f=this._data.tileDisplayData.displayObjectRegistry.get(o)){this._data.tileDisplayData.displayList.removeFromList(f.displayRecords);for(var p=0,n=f.displayRecords;p<n.length;p++){var h=n[p];this._dispRecStore.delete(h)}this._data.tileDisplayData.displayObjectRegistry.delete(o);var y=this._data.tileDisplayData.displayObjects.indexOf(f);this._data.tileDisplayData.displayObjects.splice(y,1)}}for(var c=0,u=a;c<u.length;c++){var f,_=u[c],g=void 0;if(f=this._data.tileDisplayData.displayObjectRegistry.get(_.id)){var m=f.displayRecords;f.set(_),f.displayRecords=m;for(var v=f.displayRecords.length,b=0;b<v;++b){var R=f.displayRecords[b],O=_.displayRecords[b];(b>=_.displayRecords.length||R.geometryType!==O.geometryType||R.symbolLevel!==O.symbolLevel||R.zOrder!==O.zOrder||R.materialKey!==O.materialKey)&&(this._dispRecStore.delete(f.displayRecords[b]),b<_.displayRecords.length&&(f.displayRecords[b]=void 0))}f.displayRecords.length=_.displayRecords.length,f.metrics=_.metrics}else{(f=_.copy()).displayRecords=[],this._data.tileDisplayData.displayObjectRegistry.set(_.id,f);var L=void 0,x=this._data.tileDisplayData.displayObjects;if(null!=f.insertAfter)if(g={},f.insertAfter>=0){var B=this._data.tileDisplayData.displayObjectRegistry.get(f.insertAfter);B&&(L=x.indexOf(B)+1)<x.length?x.splice(L,0,f):(x.push(f),L=x.length)}else x.unshift(f),L=0;else x.push(f),L=x.length;if(g){var I=void 0;if(this._data.tileDisplayData.displayList.unified)I=_.displayRecords.length>0?1:0;else{D.clear();for(var T=0,j=_.displayRecords;T<j.length;T++){var w=j[T],S=this._data.tileDisplayData.displayList.getDPInfoType(w.geometryType);D.add(S)}I=D.size}var M=0;for(b=L-1;b>=0&&M<I;--b)for(var k=x[b].displayRecords.length-1;k>=0&&M<I;--k){var P=x[b].displayRecords[k];g[S=this._data.tileDisplayData.displayList.getDPInfoType(P.geometryType)]||(g[S]=P,++M)}}}var A=_.displayRecords.length;for(b=0;b<A;++b){O=_.displayRecords[b];(R=f.displayRecords[b])?(R.meshData=O.meshData,R.materialKey=O.materialKey):((R=O.copy()).vertexFrom=void 0,R.indexFrom=void 0,f.displayRecords[b]=R);var E=O.geometryType,C=(S=this._data.tileDisplayData.displayList.getDPInfoType(E),e.addOrUpdate.tileBufferData.geometries[E]),U=C.vertexBuffer,q=C.indexBuffer,F=void 0;g&&(F=g[S]?this._data.tileDisplayData.displayList.splitAfter(g[S]):-1),t=this._dispRecStore.setMeshData(R,O,U,q,F)&&t,g&&null!=R.indexFrom&&null!=R.indexFrom&&(g[S]=R)}}return t},t}(f.TiledDisplayObject);t.WGLTile=g}));