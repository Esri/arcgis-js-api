/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../core/Error","../../../../core/Logger","../../../../core/mathUtils","../../../../core/screenUtils","../../../../symbols/cim/enums","./color","./enums","./SymbolProperties","../../../webgl/enums","../../../webgl/Texture","../../../webgl/VertexElementDescriptor"],(function(e,t,r,n,a,o,i,s,c,u,l,y){"use strict";const T=r.getLogger("esri.views.2d.engine.webgl.Utils"),p="geometry",m="per_instance",E="per_instance_vv",_=[{name:p,strideInBytes:36}],f=[{name:p,strideInBytes:12}],d=[{name:p,strideInBytes:36}],g=[{name:p,strideInBytes:24}],S=[{name:p,strideInBytes:12}],I=[{name:p,strideInBytes:40}],L=[{name:p,strideInBytes:36}],D=[{name:p,strideInBytes:36}];function C(e){const t={};for(const r of e)t[r.name]=r.strideInBytes;return t}const h=C(_),G=C(f),P=C(d),A=C(g),R=C(S),w=C(I),M=C(L),N=C(D);function F(e,t){switch(e){case s.WGLGeometryType.MARKER:return t===s.WGLSymbologyType.HEATMAP?G:h;case s.WGLGeometryType.FILL:switch(t){case s.WGLSymbologyType.DOT_DENSITY:return R;case s.WGLSymbologyType.SIMPLE:case s.WGLSymbologyType.OUTLINE_FILL_SIMPLE:return A;default:return P}case s.WGLGeometryType.LINE:return w;case s.WGLGeometryType.TEXT:return M;case s.WGLGeometryType.LABEL:return N}}const x=[p],V=[p],B=[p],U=[p],O=[p];function v(e){switch(e){case s.WGLGeometryType.MARKER:return x;case s.WGLGeometryType.FILL:return V;case s.WGLGeometryType.LINE:return B;case s.WGLGeometryType.TEXT:return U;case s.WGLGeometryType.LABEL:return O}}function b(e){switch(e%4){case 0:case 2:return 4;case 1:case 3:return 1}}function W(e,t){switch(t%4){case 0:case 2:return new Uint32Array(Math.floor(e*t/4));case 1:case 3:return new Uint8Array(e*t)}}function z(e,t){switch(t%4){case 0:case 2:return new Uint32Array(e);case 1:case 3:return new Uint8Array(e)}}function X(e){return c.TextProperties.pool.acquire(e.color?i.copyAndPremultiply(e.color):[255,255,255,255],e.haloColor?i.copyAndPremultiply(e.haloColor):[255,255,255,255],a.pt2px(e.haloSize),a.pt2px(e.font.size),e.angle*Math.PI/180,e.xoffset/e.font.size,e.yoffset/e.font.size,"left"===e.horizontalAlignment?0:"right"===e.horizontalAlignment?1:.5,"top"===e.verticalAlignment?0:"bottom"===e.verticalAlignment?1:.5)}function k(e){return null!=e}function Y(e){return"number"==typeof e}function $(e){switch(e){case"butt":return o.CapType.BUTT;case"round":return o.CapType.ROUND;case"square":return o.CapType.SQUARE;default:return T.error(new t("mapview-invalid-type",`Cap type ${e} is not a valid option. Defaulting to round`)),o.CapType.ROUND}}function H(e){switch(e){case"miter":return o.JoinType.MITER;case"bevel":return o.JoinType.BEVEL;case"round":return o.JoinType.ROUND;default:return T.error(new t("mapview-invalid-type",`Join type ${e} is not a valid option. Defaulting to round`)),o.JoinType.ROUND}}function J(e){switch(e){case"opacity":return s.VVType.OPACITY;case"color":return s.VVType.COLOR;case"rotation":return s.VVType.ROTATION;case"size":return s.VVType.SIZE;default:return T.error(`Cannot interpret unknown vv: ${e}`),null}}function q(e){const{transform:t,hasZ:r,hasM:n}=e;return{transform:t,hasZ:r,hasM:n}}function K(e,t,r,n,a,o,i){for(const c in o){const t=o[c].stride,n=b(t),i=o[c].data,s=r[c].data,u=t*a.vertexCount/n,l=t*e/n,y=t*a.vertexFrom/n;for(let e=0;e<u;++e)s[e+l]=i[e+y]}const s=a.indexCount;for(let c=0;c<s;++c)n[c+t]=i[c+a.indexFrom]-a.vertexFrom+e}const Z={[p]:u.Usage.STATIC_DRAW};function j(e,t){const r=[];for(let n=0;n<5;++n){const a=v(n),o={};for(const e of a)o[e]={data:t(n,e)};r.push({data:e(n),buffers:o})}return r}function Q(e,t){let r,a;return n.isPowerOfTwo(t.width)&&n.isPowerOfTwo(t.height)?(r=!0,a=u.TextureSamplingMode.LINEAR_MIPMAP_LINEAR):(r=!1,a=u.TextureSamplingMode.LINEAR),new l.Texture(e,{target:u.TextureType.TEXTURE_2D,pixelFormat:u.PixelFormat.RGBA,internalFormat:u.PixelFormat.RGBA,dataType:u.PixelType.UNSIGNED_BYTE,hasMipmap:r,samplingMode:a,wrapMode:u.TextureWrapMode.CLAMP_TO_EDGE,flipped:!0},t)}function ee(e){return{vertexFrom:void 0,vertexTo:void 0,geometry:e}}function te(e){switch(e){case u.DataType.BYTE:case u.DataType.UNSIGNED_BYTE:return 1;case u.DataType.SHORT:case u.DataType.UNSIGNED_SHORT:return 2;case u.DataType.FLOAT:case u.DataType.INT:case u.DataType.UNSIGNED_INT:return 4}}function re(e){switch(e){case u.PixelType.UNSIGNED_BYTE:return 1;case u.PixelType.UNSIGNED_SHORT_4_4_4_4:return 2;case u.PixelType.FLOAT:return 4;default:return void T.error(new t("webgl-utils",`Unable to handle type ${e}`))}}function ne(e){switch(e){case u.PixelType.UNSIGNED_BYTE:return Uint8Array;case u.PixelType.UNSIGNED_SHORT_4_4_4_4:return Uint16Array;case u.PixelType.FLOAT:return Float32Array;default:return void T.error(new t("webgl-utils",`Unable to handle type ${e}`))}}function ae(e){const t={};for(const r in e){const n=e[r];let a=0;t[r]=n.map((e=>{const t=new y.VertexElementDescriptor(e.name,e.count,e.type,a,0,e.normalized||!1);return a+=e.count*te(e.type),t})),t[r].forEach((e=>e.stride=a))}return t}const oe=e=>{const t=new Map;for(const r in e)for(const n of e[r])t.set(n.name,n.location);return t},ie=e=>{const t={};for(const r in e){const n=e[r];t[r]=n.length?n[0].stride:0}return t},se=new Map,ce=(e,t)=>{if(!se.has(e)){const r=ae(t),n={strides:ie(r),bufferLayouts:r,attributes:oe(t)};se.set(e,n)}return se.get(e)};function ue(e){e(s.WGLGeometryType.FILL),e(s.WGLGeometryType.LINE),e(s.WGLGeometryType.MARKER),e(s.WGLGeometryType.TEXT),e(s.WGLGeometryType.LABEL)}const le=e=>"path"in e&&De(e.path),ye=e=>"url"in e&&e.url||"imageData"in e&&e.imageData,Te=e=>"imageData"in e&&e.imageData&&"contentType"in e&&e.contentType?`data:${e.contentType};base64,${e.imageData}`:"url"in e?e.url:null,pe=e=>e.startsWith("data:image/gif"),me=e=>"url"in e&&e.url&&(e.url.includes(".gif")||pe(e.url))||"contentType"in e&&"image/gif"===e.contentType||"imageData"in e&&pe(e.imageData),Ee=e=>e.startsWith("data:image/png"),_e=e=>"url"in e&&e.url&&(e.url.includes(".png")||Ee(e.url))||"contentType"in e&&"image/png"===e.contentType||"imageData"in e&&Ee(e.imageData),fe=e=>e.type&&e.type.toLowerCase().includes("3d");function de(e){switch(e.type){case"line":{const t=e;return"CIMSolidStroke"===t.cim.type&&!t.dashTemplate}case"fill":return"CIMSolidFill"===e.cim.type;case"esriSFS":return"esriSFSSolid"===e.style||"esriSFSNull"===e.style;case"esriSLS":return"esriSLSSolid"===e.style||"esriSLSNull"===e.style;default:return!1}}const ge=e=>e.includes("data:image/svg+xml");function Se(e){switch("cim"in e?e.cim.type:e.type){case"esriSMS":case"esriPMS":case"CIMPointSymbol":return!1;case"CIMVectorMarker":case"CIMCharacterMarker":case"CIMPictureMarker":return Ce(e);default:return!0}}function Ie(e){const t="maxVVSize"in e&&e.maxVVSize,r="width"in e&&e.width||"size"in e&&e.size||0;return t||r}function Le(e){const t=[];for(let r=0;r<e.length;r++)t.push(e.charCodeAt(r));return t}const De=e=>!!e&&(e=e.trim(),!!(/^[mzlhvcsqta]\s*[-+.0-9][^mlhvzcsqta]+/i.test(e)&&/[\dz]$/i.test(e)&&e.length>4)),Ce=e=>"fill"===e.type&&"CIMMarkerPlacementInsidePolygon"===e?.cim?.markerPlacement?.type;e.C_FILL_STRIDE_SPEC=P,e.C_FILL_STRIDE_SPEC_DD=R,e.C_FILL_STRIDE_SPEC_SIMPLE=A,e.C_FILL_VERTEX_DEF=d,e.C_FILL_VERTEX_DEF_DD=S,e.C_FILL_VERTEX_DEF_SIMPLE=g,e.C_HEATMAP_STRIDE_SPEC=G,e.C_HEATMAP_VERTEX_DEF=f,e.C_ICON_STRIDE_SPEC=h,e.C_ICON_VERTEX_DEF=_,e.C_LABEL_STRIDE_SPEC=N,e.C_LABEL_VERTEX_DEF=D,e.C_LINE_STRIDE_SPEC=w,e.C_LINE_VERTEX_DEF=I,e.C_TEXT_STRIDE_SPEC=M,e.C_TEXT_VERTEX_DEF=L,e.C_VBO_GEOMETRY=p,e.C_VBO_INFO=Z,e.C_VBO_PERINSTANCE=m,e.C_VBO_PERINSTANCE_VV=E,e.allocateTypedArrayBuffer=W,e.allocateTypedArrayBufferwithData=z,e.charCodes=Le,e.copyMeshData=K,e.createGeometryData=j,e.createProgramDescriptor=ce,e.createTextureFromTexelData=Q,e.forEachGeometryType=ue,e.geometryToMappedGeometry=ee,e.getBytes=te,e.getCapType=$,e.getJoinType=H,e.getNamedBuffers=v,e.getPMSResourceSize=Ie,e.getPixelArrayCtor=ne,e.getPixelBytes=re,e.getStrides=F,e.getTextProperties=X,e.getTransformParams=q,e.getUrl=Te,e.getVVType=J,e.is3D=fe,e.isDefined=k,e.isGIF=me,e.isGIFDataUri=pe,e.isImageResource=ye,e.isMarkerPlacementInsidePolygon=Ce,e.isNumber=Y,e.isPNG=_e,e.isPNGDataUri=Ee,e.isSVGImage=ge,e.isSVGResource=le,e.isSimple=de,e.isValidSVG=De,e.shouldRepeat=Se,e.strideToPackingFactor=b,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
