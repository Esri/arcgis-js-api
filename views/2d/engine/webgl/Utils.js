/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../core/Error","../../../../core/Logger","../../../../core/mathUtils","../../../../core/screenUtils","../../../../symbols/cim/enums","./color","./enums","./SymbolProperties","../../../webgl/enums","../../../webgl/Texture","../../../webgl/VertexElementDescriptor"],(function(e,t,r,n,a,i,o,s,c,u,l,p){"use strict";const y=r.getLogger("esri.views.2d.engine.webgl.Utils"),T="geometry",m="per_instance",E="per_instance_vv",f=[{name:T,strideInBytes:36}],d=[{name:T,strideInBytes:32}],_=[{name:T,strideInBytes:20}],g=[{name:T,strideInBytes:12}],S=[{name:T,strideInBytes:40}],L=[{name:T,strideInBytes:36}],I=[{name:T,strideInBytes:36}];function D(e){const t={};for(const r of e)t[r.name]=r.strideInBytes;return t}const C=D(f),h=D(d),G=D(_),R=D(g),w=D(S),N=D(L),P=D(I);function A(e,{fill:t}){switch(e){case s.WGLGeometryType.MARKER:return C;case s.WGLGeometryType.FILL:return"dot-density"===t?R:"simple"===t?G:h;case s.WGLGeometryType.LINE:return w;case s.WGLGeometryType.TEXT:return N;case s.WGLGeometryType.LABEL:return P}}const x=[T],M=[T],F=[T],V=[T],B=[T];function O(e){switch(e){case s.WGLGeometryType.MARKER:return x;case s.WGLGeometryType.FILL:return M;case s.WGLGeometryType.LINE:return F;case s.WGLGeometryType.TEXT:return V;case s.WGLGeometryType.LABEL:return B}}function v(e){switch(e%4){case 0:case 2:return 4;case 1:case 3:return 1}}function U(e,t){switch(t%4){case 0:case 2:return new Uint32Array(Math.floor(e*t/4));case 1:case 3:return new Uint8Array(e*t)}}function b(e,t){switch(t%4){case 0:case 2:return new Uint32Array(e);case 1:case 3:return new Uint8Array(e)}}function W(e){return c.TextProperties.pool.acquire(e.color?o.copyAndPremultiply(e.color):[255,255,255,255],e.haloColor?o.copyAndPremultiply(e.haloColor):[255,255,255,255],a.pt2px(e.haloSize),a.pt2px(e.font.size),e.angle*Math.PI/180,e.xoffset/e.font.size,e.yoffset/e.font.size,"left"===e.horizontalAlignment?0:"right"===e.horizontalAlignment?1:.5,"top"===e.verticalAlignment?0:"bottom"===e.verticalAlignment?1:.5)}function z(e){return null!=e}function X(e){return"number"==typeof e}function $(e){switch(e){case"butt":return i.CapType.BUTT;case"round":return i.CapType.ROUND;case"square":return i.CapType.SQUARE;default:return y.error(new t("mapview-invalid-type",`Cap type ${e} is not a valid option. Defaulting to round`)),i.CapType.ROUND}}function Y(e){switch(e){case"miter":return i.JoinType.MITER;case"bevel":return i.JoinType.BEVEL;case"round":return i.JoinType.ROUND;default:return y.error(new t("mapview-invalid-type",`Join type ${e} is not a valid option. Defaulting to round`)),i.JoinType.ROUND}}function k(e){switch(e){case"opacity":return s.VVType.OPACITY;case"color":return s.VVType.COLOR;case"rotation":return s.VVType.ROTATION;case"size":return s.VVType.SIZE;default:return y.error(`Cannot interpret unknown vv: ${e}`),null}}function J(e){const{transform:t,hasZ:r,hasM:n}=e;return{transform:t,hasZ:r,hasM:n}}function q(e,t,r,n,a,i,o){for(const c in i){const t=i[c].stride,n=v(t),o=i[c].data,s=r[c].data,u=t*a.vertexCount/n,l=t*e/n,p=t*a.vertexFrom/n;for(let e=0;e<u;++e)s[e+l]=o[e+p]}const s=a.indexCount;for(let c=0;c<s;++c)n[c+t]=o[c+a.indexFrom]-a.vertexFrom+e}const H={[T]:u.Usage.STATIC_DRAW};function K(e,t){const r=[];for(let n=0;n<5;++n){const a=O(n),i={};for(const e of a)i[e]={data:t(n,e)};r.push({data:e(n),buffers:i})}return r}function Z(e,t){let r,a;return n.isPowerOfTwo(t.width)&&n.isPowerOfTwo(t.height)?(r=!0,a=u.TextureSamplingMode.LINEAR_MIPMAP_LINEAR):(r=!1,a=u.TextureSamplingMode.LINEAR),new l.Texture(e,{target:u.TextureType.TEXTURE_2D,pixelFormat:u.PixelFormat.RGBA,internalFormat:u.PixelFormat.RGBA,dataType:u.PixelType.UNSIGNED_BYTE,hasMipmap:r,samplingMode:a,wrapMode:u.TextureWrapMode.CLAMP_TO_EDGE,flipped:!0},t)}function j(e){return{vertexFrom:void 0,vertexTo:void 0,geometry:e}}function Q(e){switch(e){case u.DataType.BYTE:case u.DataType.UNSIGNED_BYTE:return 1;case u.DataType.SHORT:case u.DataType.UNSIGNED_SHORT:return 2;case u.DataType.FLOAT:case u.DataType.INT:case u.DataType.UNSIGNED_INT:return 4}}function ee(e){switch(e){case u.PixelType.UNSIGNED_BYTE:return 1;case u.PixelType.UNSIGNED_SHORT_4_4_4_4:return 2;case u.PixelType.FLOAT:return 4;default:return void y.error(new t("webgl-utils",`Unable to handle type ${e}`))}}function te(e){switch(e){case u.PixelType.UNSIGNED_BYTE:return Uint8Array;case u.PixelType.UNSIGNED_SHORT_4_4_4_4:return Uint16Array;case u.PixelType.FLOAT:return Float32Array;default:return void y.error(new t("webgl-utils",`Unable to handle type ${e}`))}}function re(e){const t={};for(const r in e){const n=e[r];let a=0;t[r]=n.map((e=>{const t=new p.VertexElementDescriptor(e.name,e.count,e.type,a,0,e.normalized||!1);return a+=e.count*Q(e.type),t})),t[r].forEach((e=>e.stride=a))}return t}const ne=e=>{const t=new Map;for(const r in e)for(const n of e[r])t.set(n.name,n.location);return t},ae=e=>{const t={};for(const r in e){const n=e[r];t[r]=n.length?n[0].stride:0}return t},ie=new Map,oe=(e,t)=>{if(!ie.has(e)){const r=re(t),n={strides:ae(r),bufferLayouts:r,attributes:ne(t)};ie.set(e,n)}return ie.get(e)};function se(e){e(s.WGLGeometryType.FILL),e(s.WGLGeometryType.LINE),e(s.WGLGeometryType.MARKER),e(s.WGLGeometryType.TEXT),e(s.WGLGeometryType.LABEL)}const ce=e=>"path"in e&&ge(e.path),ue=e=>"url"in e&&e.url||"imageData"in e&&e.imageData,le=e=>"imageData"in e&&e.imageData&&"contentType"in e&&e.contentType?`data:${e.contentType};base64,${e.imageData}`:"url"in e?e.url:null,pe=e=>"url"in e&&e.url&&e.url.includes(".gif")||"contentType"in e&&"image/gif"===e.contentType||"imageData"in e&&e.imageData.includes("data:image/gif"),ye=e=>"url"in e&&e.url&&e.url.includes(".png")||"contentType"in e&&"image/png"===e.contentType||"imageData"in e&&e.imageData.includes("data:image/png"),Te=e=>e.type&&-1!==e.type.toLowerCase().indexOf("3d");function me(e){switch(e.type){case"line":{const t=e;return"CIMSolidStroke"===t.cim.type&&!t.dashTemplate}case"fill":return"CIMSolidFill"===e.cim.type;case"esriSFS":return"esriSFSSolid"===e.style||"esriSFSNull"===e.style;case"esriSLS":return"esriSLSSolid"===e.style||"esriSLSNull"===e.style;default:return!1}}const Ee=e=>e.includes("data:image/svg+xml");function fe(e){switch("cim"in e?e.cim.type:e.type){case"esriSMS":case"esriPMS":case"CIMPointSymbol":case"CIMVectorMarker":case"CIMPictureMarker":case"CIMCharacterMarker":return!1;default:return!0}}function de(e){const t="maxVVSize"in e&&e.maxVVSize,r="width"in e&&e.width||"size"in e&&e.size||0;return t||r}function _e(e){const t=[];for(let r=0;r<e.length;r++)t.push(e.charCodeAt(r));return t}const ge=e=>!!e&&(e=e.trim(),!!(/^[mzlhvcsqta]\s*[-+.0-9][^mlhvzcsqta]+/i.test(e)&&/[\dz]$/i.test(e)&&e.length>4));e.C_FILL_STRIDE_SPEC=h,e.C_FILL_STRIDE_SPEC_DD=R,e.C_FILL_STRIDE_SPEC_SIMPLE=G,e.C_FILL_VERTEX_DEF=d,e.C_FILL_VERTEX_DEF_DD=g,e.C_FILL_VERTEX_DEF_SIMPLE=_,e.C_ICON_STRIDE_SPEC=C,e.C_ICON_VERTEX_DEF=f,e.C_LABEL_STRIDE_SPEC=P,e.C_LABEL_VERTEX_DEF=I,e.C_LINE_STRIDE_SPEC=w,e.C_LINE_VERTEX_DEF=S,e.C_TEXT_STRIDE_SPEC=N,e.C_TEXT_VERTEX_DEF=L,e.C_VBO_GEOMETRY=T,e.C_VBO_INFO=H,e.C_VBO_PERINSTANCE=m,e.C_VBO_PERINSTANCE_VV=E,e.allocateTypedArrayBuffer=U,e.allocateTypedArrayBufferwithData=b,e.charCodes=_e,e.copyMeshData=q,e.createGeometryData=K,e.createProgramDescriptor=oe,e.createTextureFromTexelData=Z,e.forEachGeometryType=se,e.geometryToMappedGeometry=j,e.getBytes=Q,e.getCapType=$,e.getJoinType=Y,e.getNamedBuffers=O,e.getPMSResourceSize=de,e.getPixelArrayCtor=te,e.getPixelBytes=ee,e.getStrides=A,e.getTextProperties=W,e.getTransformParams=J,e.getUrl=le,e.getVVType=k,e.is3D=Te,e.isDefined=z,e.isGIF=pe,e.isImageResource=ue,e.isNumber=X,e.isPNG=ye,e.isSVGImage=Ee,e.isSVGResource=ce,e.isSimple=me,e.isValidSVG=ge,e.shouldRepeat=fe,e.strideToPackingFactor=v,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
