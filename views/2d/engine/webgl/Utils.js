/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../../core/Error","../../../../core/Logger","../../../../core/mathUtils","../../../../core/screenUtils","./color","./enums","./SymbolProperties","../../../webgl/Texture"],(function(e,t,r,n,i,o,a,s,c){"use strict";const u=r.getLogger("esri.views.2d.engine.webgl.Utils"),l="geometry",y="per_instance",p="per_instance_vv",d=[{name:l,strideInBytes:36,divisor:0}],m=[{name:l,strideInBytes:32,divisor:0}],f=[{name:l,strideInBytes:20,divisor:0}],T=[{name:l,strideInBytes:12,divisor:0}],g=[{name:l,strideInBytes:40,divisor:0}],E=[{name:l,strideInBytes:36,divisor:0}],_=[{name:l,strideInBytes:36,divisor:0}];function L(e){const t={};for(const r of e)t[r.name]=r.strideInBytes;return t}const h=L(d),S=L(m),C=L(f),I=L(T),w=L(g),G=L(E),v=L(_);function D(e,{fill:t}){switch(e){case a.WGLGeometryType.MARKER:return h;case a.WGLGeometryType.FILL:return"dot-density"===t?I:"simple"===t?C:S;case a.WGLGeometryType.LINE:return w;case a.WGLGeometryType.TEXT:return G;case a.WGLGeometryType.LABEL:return v}}const V=[l],F=[l],P=[l],M=[l],A=[l];function R(e){switch(e){case a.WGLGeometryType.MARKER:return V;case a.WGLGeometryType.FILL:return F;case a.WGLGeometryType.LINE:return P;case a.WGLGeometryType.TEXT:return M;case a.WGLGeometryType.LABEL:return A}}function x(e){switch(e%4){case 0:case 2:return 4;case 1:case 3:return 1}}function B(e,t){switch(t%4){case 0:case 2:return new Uint32Array(Math.floor(e*t/4));case 1:case 3:return new Uint8Array(e*t)}}function b(e,t){switch(t%4){case 0:case 2:return new Uint32Array(e);case 1:case 3:return new Uint8Array(e)}}function N(e){return s.TextProperties.pool.acquire(e.color?o.copyAndPremultiply(e.color):[255,255,255,255],e.haloColor?o.copyAndPremultiply(e.haloColor):[255,255,255,255],i.pt2px(e.haloSize),i.pt2px(e.font.size),e.angle*Math.PI/180,e.xoffset/e.font.size,e.yoffset/e.font.size,"left"===e.horizontalAlignment?0:"right"===e.horizontalAlignment?1:.5,"top"===e.verticalAlignment?0:"bottom"===e.verticalAlignment?1:.5)}function z(e){return null!=e}function O(e){return"number"==typeof e}function W(e){switch(e){case"butt":return 0;case"round":return 1;case"square":return 2;default:return u.error(new t("mapview-invalid-type",`Cap type ${e} is not a valid option. Defaulting to round`)),1}}function U(e){switch(e){case"miter":return 2;case"bevel":return 0;case"round":return 1;default:return u.error(new t("mapview-invalid-type",`Join type ${e} is not a valid option. Defaulting to round`)),1}}function X(e){switch(e){case"opacity":return a.VVType.OPACITY;case"color":return a.VVType.COLOR;case"rotation":return a.VVType.ROTATION;case"size":return a.VVType.SIZE;default:return u.error(`Cannot interpret unknown vv: ${e}`),null}}function $(e){const{transform:t,hasZ:r,hasM:n}=e;return{transform:t,hasZ:r,hasM:n}}function k(e,t,r,n,i,o,a){for(const c in o){const t=o[c].stride,n=x(t),a=o[c].data,s=r[c].data,u=t*i.vertexCount/n,l=t*e/n,y=t*i.vertexFrom/n;for(let e=0;e<u;++e)s[e+l]=a[e+y]}const s=i.indexCount;for(let c=0;c<s;++c)n[c+t]=a[c+i.indexFrom]-i.vertexFrom+e}const q={[l]:35044};function K(e,t){const r=[];for(let n=0;n<5;++n){const i=R(n),o={};for(const e of i)o[e]={data:t(n,e)};r.push({data:e(n),buffers:o})}return r}function Z(e,t){let r,i;return n.isPowerOfTwo(t.width)&&n.isPowerOfTwo(t.height)?(r=!0,i=9987):(r=!1,i=9729),new c(e,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,hasMipmap:r,samplingMode:i,wrapMode:33071,flipped:!0},t)}function J(e){return{vertexFrom:void 0,vertexTo:void 0,geometry:e}}function Y(e){switch(e){case 5120:case 5121:return 1;case 5122:case 5123:return 2;case 5126:case 5124:case 5125:return 4}}function j(e){switch(e){case 5121:return 1;case 32819:return 2;case 5126:return 4;default:return void u.error(new t("webgl-utils",`Unable to handle type ${e}`))}}function H(e){switch(e){case 5121:return Uint8Array;case 32819:return Uint16Array;case 5126:return Float32Array;default:return void u.error(new t("webgl-utils",`Unable to handle type ${e}`))}}function Q(e){const t={};for(const r in e){const n=e[r];let i=0;t[r]=n.map((e=>{const t={...e,normalized:e.normalized||!1,divisor:e.divisor||0,offset:i,stride:0};return i+=e.count*Y(e.type),t})),t[r].forEach((e=>e.stride=i))}return t}const ee=e=>{const t=new Map;for(const r in e)for(const n of e[r])t.set(n.name,n.location);return t},te=e=>{const t={};for(const r in e){const n=e[r];t[r]=n.length?n[0].stride:0}return t},re=new Map,ne=(e,t)=>{if(!re.has(e)){const r=Q(t),n={strides:te(r),bufferLayouts:r,attributes:ee(t)};re.set(e,n)}return re.get(e)};function ie(e){e(a.WGLGeometryType.FILL),e(a.WGLGeometryType.LINE),e(a.WGLGeometryType.MARKER),e(a.WGLGeometryType.TEXT),e(a.WGLGeometryType.LABEL)}const oe=e=>"path"in e&&Te(e.path),ae=e=>"url"in e&&e.url||"imageData"in e&&e.imageData,se=e=>"imageData"in e&&e.imageData&&"contentType"in e&&e.contentType?`data:${e.contentType};base64,${e.imageData}`:"url"in e?e.url:null,ce=e=>"url"in e&&e.url&&e.url.includes(".gif")||"contentType"in e&&"image/gif"===e.contentType||"imageData"in e&&e.imageData.includes("data:image/gif"),ue=e=>"url"in e&&e.url&&e.url.includes(".png")||"contentType"in e&&"image/png"===e.contentType||"imageData"in e&&e.imageData.includes("data:image/png"),le=e=>e.type&&-1!==e.type.toLowerCase().indexOf("3d");function ye(e){switch(e.type){case"line":{const t=e;return"CIMSolidStroke"===t.cim.type&&!t.dashTemplate}case"fill":return"CIMSolidFill"===e.cim.type;case"esriSFS":return"esriSFSSolid"===e.style||"esriSFSNull"===e.style;case"esriSLS":return"esriSLSSolid"===e.style||"esriSLSNull"===e.style;default:return!1}}const pe=e=>e.includes("data:image/svg+xml");function de(e){switch("cim"in e?e.cim.type:e.type){case"esriSMS":case"esriPMS":case"CIMPointSymbol":case"CIMVectorMarker":case"CIMPictureMarker":case"CIMCharacterMarker":return!1;default:return!0}}function me(e){const t="maxVVSize"in e&&e.maxVVSize,r="width"in e&&e.width||"size"in e&&e.size||0;return t||r}function fe(e){const t=[];for(let r=0;r<e.length;r++)t.push(e.charCodeAt(r));return t}const Te=e=>!!e&&(e=e.trim(),!!(/^[mzlhvcsqta]\s*[-+.0-9][^mlhvzcsqta]+/i.test(e)&&/[\dz]$/i.test(e)&&e.length>4));e.C_FILL_STRIDE_SPEC=S,e.C_FILL_STRIDE_SPEC_DD=I,e.C_FILL_STRIDE_SPEC_SIMPLE=C,e.C_FILL_VERTEX_DEF=m,e.C_FILL_VERTEX_DEF_DD=T,e.C_FILL_VERTEX_DEF_SIMPLE=f,e.C_ICON_STRIDE_SPEC=h,e.C_ICON_VERTEX_DEF=d,e.C_LABEL_STRIDE_SPEC=v,e.C_LABEL_VERTEX_DEF=_,e.C_LINE_STRIDE_SPEC=w,e.C_LINE_VERTEX_DEF=g,e.C_TEXT_STRIDE_SPEC=G,e.C_TEXT_VERTEX_DEF=E,e.C_VBO_GEOMETRY=l,e.C_VBO_INFO=q,e.C_VBO_PERINSTANCE=y,e.C_VBO_PERINSTANCE_VV=p,e.allocateTypedArrayBuffer=B,e.allocateTypedArrayBufferwithData=b,e.charCodes=fe,e.copyMeshData=k,e.createGeometryData=K,e.createProgramDescriptor=ne,e.createTextureFromTexelData=Z,e.forEachGeometryType=ie,e.geometryToMappedGeometry=J,e.getBytes=Y,e.getCapType=W,e.getJoinType=U,e.getNamedBuffers=R,e.getPMSResourceSize=me,e.getPixelArrayCtor=H,e.getPixelBytes=j,e.getStrides=D,e.getTextProperties=N,e.getTransformParams=$,e.getUrl=se,e.getVVType=X,e.is3D=le,e.isDefined=z,e.isGIF=ce,e.isImageResource=ae,e.isNumber=O,e.isPNG=ue,e.isSVGImage=pe,e.isSVGResource=oe,e.isSimple=ye,e.isValidSVG=Te,e.shouldRepeat=de,e.strideToPackingFactor=x,Object.defineProperty(e,"__esModule",{value:!0})}));
