/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/maybe","../../../../../chunks/vec2f32","../../vectorTiles/decluttering/config","../definitions","../enums","../GeometryUtils","../number","./WGLBrush"],(function(e,t,a,i,r,n,s,o,l,f){"use strict";const u=1/65536;let c=function(e){function f(){var t;return(t=e.apply(this,arguments)||this)._iconProgramOptions={id:!1,sdf:!1},t._sdfProgramOptions={id:!1},t._spritesTextureSize=i.create(),t}t._inheritsLoose(f,e);var c=f.prototype;return c.dispose=function(){},c.drawMany=function(e,t){const{drawPhase:a,styleLayerUID:i}=e,r=e.styleLayer;let n;a===s.WGLDrawPhase.HITTEST&&(n=l.u32to4Xu8(i+1)),this._drawIcons(e,r,t,n),this._drawText(e,r,t,n)},c._drawIcons=function(e,t,i,l){const{context:f,displayLevel:u,drawPhase:c,painter:p,spriteMosaic:_,state:y,styleLayerUID:g}=e,d=t.iconMaterial,m=p.vectorTilesMaterialManager;let h,T=!1;for(const a of i)if(a.layerData.has(g)&&(h=a.layerData.get(g),h.iconPerPageElementsMap.size>0)){T=!0;break}if(!T)return;const U=t.getPaintValue("icon-translate",u),P=t.getPaintValue("icon-translate-anchor",u);let M=t.getLayoutValue("icon-rotation-alignment",u);2===M&&(M=0===t.getLayoutValue("symbol-placement",u)?1:0);const E=0===M,v=t.getLayoutValue("icon-keep-upright",u)&&E,x=h.isIconSDF,D=c===s.WGLDrawPhase.HITTEST,V=this._iconProgramOptions;V.id=D,V.sdf=x;const I=m.getMaterialProgram(f,d,V);f.useProgram(I),I.setUniformMatrix3fv("u_displayViewMat3",0===M?y.displayViewMat3:y.displayMat3),I.setUniformMatrix3fv("u_displayMat3",1===P?y.displayMat3:y.displayViewMat3),I.setUniform2fv("u_iconTranslation",U),I.setUniform1f("u_depth",t.z),I.setUniform1f("u_mapRotation",o.degToByte(y.rotation)),I.setUniform1f("u_keepUpright",v?1:0),I.setUniform1f("u_level",10*u),I.setUniform1i("u_texture",n.VTL_TEXTURE_BINDING_UNIT_SPRITES),I.setUniform1f("u_fadeDuration",r.FADE_DURATION/1e3),D&&I.setUniform4fv("u_id",l);let S=-1;for(const r of i){if(!r.layerData.has(g))continue;if(r.key.level!==S&&(S=r.key.level,d.setDataUniforms(I,u,t,S,_)),h=r.layerData.get(g),0===h.iconPerPageElementsMap.size)continue;h.prepareForRendering(f),h.updateOpacityInfo();const i=h.iconVertexArrayObject;if(!a.isNone(i)){f.bindVAO(i),I.setUniformMatrix3fv("u_dvsMat3",r.transforms.dvs),I.setUniform1f("u_time",(performance.now()-h.lastOpacityUpdate)/1e3);for(const[t,a]of h.iconPerPageElementsMap)this._renderIconRange(e,I,a,t,r)}}},c._renderIconRange=function(e,t,a,i,r){const{context:s,spriteMosaic:o}=e;this._spritesTextureSize[0]=o.getWidth(i)/4,this._spritesTextureSize[1]=o.getHeight(i)/4,t.setUniform2fv("u_mosaicSize",this._spritesTextureSize),o.bind(s,9729,i,n.VTL_TEXTURE_BINDING_UNIT_SPRITES),s.setStencilTestEnabled(!0),s.setStencilFunction(516,255,255),s.setStencilWriteMask(0),s.drawElements(4,a[1],5125,Uint32Array.BYTES_PER_ELEMENT*a[0]),r.triangleCount+=a[1]/3},c._drawText=function(e,t,l,f){const{context:c,displayLevel:p,drawPhase:_,glyphMosaic:y,painter:g,pixelRatio:d,spriteMosaic:m,state:h,styleLayerUID:T}=e,U=t.textMaterial,P=g.vectorTilesMaterialManager;let M,E=!1;for(const a of l)if(a.layerData.has(T)&&(M=a.layerData.get(T),M.glyphPerPageElementsMap.size>0)){E=!0;break}if(!E)return;const v=t.getPaintProperty("text-opacity");if(v&&!v.isDataDriven&&0===v.getValue(p))return;const x=t.getPaintProperty("text-color"),D=!x||x.isDataDriven||x.getValue(p)[3]>0,V=t.getPaintProperty("text-halo-width"),I=t.getPaintProperty("text-halo-color"),S=(!V||V.isDataDriven||V.getValue(p)>0)&&(!I||I.isDataDriven||I.getValue(p)[3]>0);if(!D&&!S)return;const L=24/8;let w=t.getLayoutValue("text-rotation-alignment",p);2===w&&(w=0===t.getLayoutValue("symbol-placement",p)?1:0);const R=0===w,N=t.getLayoutValue("text-keep-upright",p)&&R,b=_===s.WGLDrawPhase.HITTEST,z=.8*L/d;this._glyphTextureSize||(this._glyphTextureSize=i.fromValues(y.width/4,y.height/4));const O=t.getPaintValue("text-translate",p),k=t.getPaintValue("text-translate-anchor",p),G=this._sdfProgramOptions;G.id=b;const B=P.getMaterialProgram(c,U,G);c.useProgram(B),B.setUniformMatrix3fv("u_displayViewMat3",0===w?h.displayViewMat3:h.displayMat3),B.setUniformMatrix3fv("u_displayMat3",1===k?h.displayMat3:h.displayViewMat3),B.setUniform2fv("u_textTranslation",O),B.setUniform1f("u_depth",t.z+u),B.setUniform2fv("u_mosaicSize",this._glyphTextureSize),B.setUniform1f("u_mapRotation",o.degToByte(h.rotation)),B.setUniform1f("u_keepUpright",N?1:0),B.setUniform1f("u_level",10*p),B.setUniform1i("u_texture",n.VTL_TEXTURE_BINDING_UNIT_GLYPHS),B.setUniform1f("u_antialiasingWidth",z),B.setUniform1f("u_fadeDuration",r.FADE_DURATION/1e3),b&&B.setUniform4fv("u_id",f);let A=-1;for(const i of l){if(!i.layerData.has(T))continue;if(i.key.level!==A&&(A=i.key.level,U.setDataUniforms(B,p,t,A,m)),M=i.layerData.get(T),0===M.glyphPerPageElementsMap.size)continue;M.prepareForRendering(c),M.updateOpacityInfo();const e=M.textVertexArrayObject;if(a.isNone(e))continue;c.bindVAO(e),B.setUniformMatrix3fv("u_dvsMat3",i.transforms.dvs),c.setStencilTestEnabled(!0),c.setStencilFunction(516,255,255),c.setStencilWriteMask(0);const r=(performance.now()-M.lastOpacityUpdate)/1e3;B.setUniform1f("u_time",r),M.glyphPerPageElementsMap.forEach(((e,t)=>{this._renderGlyphRange(c,e,t,y,B,S,D,i)}))}},c._renderGlyphRange=function(e,t,a,i,r,s,o,l){i.bind(e,9729,a,n.VTL_TEXTURE_BINDING_UNIT_GLYPHS),s&&(r.setUniform1f("u_halo",1),e.drawElements(4,t[1],5125,Uint32Array.BYTES_PER_ELEMENT*t[0]),l.triangleCount+=t[1]/3),o&&(r.setUniform1f("u_halo",0),e.drawElements(4,t[1],5125,Uint32Array.BYTES_PER_ELEMENT*t[0]),l.triangleCount+=t[1]/3)},f}(f);e.WGLBrushVTLSymbol=c,Object.defineProperty(e,"__esModule",{value:!0})}));
