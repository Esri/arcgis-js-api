/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/maybe","../definitions","../../../../../chunks/vec2f32","../../../../../chunks/vec4f32","../../vectorTiles/decluttering/config","../number","../enums","./WGLBrush","../GeometryUtils"],(function(e,t,i,a,o,r,n,s,l,f,u){"use strict";const c=[1,1,1,1];let _=function(e){function f(){var t;return(t=e.apply(this,arguments)||this)._iconProgramOptions={id:!1,dd:!1,sdf:!1},t._sdfProgramOptions={id:!1,dd:!1},t._spritesTextureSize=o.create(),t._haloColor=r.create(),t._sdfColor=r.create(),t._color=r.create(),t}t._inheritsLoose(f,e);var _=f.prototype;return _.dispose=function(){},_.drawMany=function(e,t){const{drawPhase:i,styleLayerUID:a}=e,o=e.styleLayer;let r;i===l.WGLDrawPhase.HITTEST&&(r=s.u32to4Xu8(a+1)),this._drawIcons(e,o,t,r),this._drawText(e,o,t,r)},_._drawIcons=function(e,t,o,r){const{context:s,displayLevel:f,drawPhase:_,painter:h,state:d,styleLayerUID:p}=e;let m,g=!1;for(const e of o)if(e.layerData.has(p)&&(m=e.layerData.get(p),m.iconPerPageElementsMap.size>0)){g=!0;break}if(!g)return;const y=t.hasDataDrivenIconSize?1:t.getLayoutValue("icon-size",f),U=t.hasDataDrivenIconColor?c:t.getPaintValue("icon-color",f),T=t.hasDataDrivenIconOpacity?1:t.getPaintValue("icon-opacity",f),P=t.getPaintValue("icon-translate",f),D=t.getPaintValue("icon-translate-anchor",f),E=h.getVectorTileProgramCache(),x=U[3]*T;this._color[0]=x*U[0],this._color[1]=x*U[1],this._color[2]=x*U[2],this._color[3]=x;let V=t.getLayoutValue("icon-rotation-alignment",f);2===V&&(V=0===t.getLayoutValue("symbol-placement",f)?1:0);const v=0===V,M=t.getLayoutValue("icon-keep-upright",f)&&v,I=m.isIconSDF,S=t.hasDataDrivenIcon,L=_===l.WGLDrawPhase.HITTEST,w=(L?1:0)<<2|(S?1:0)<<1|(I?1:0),z=this._iconProgramOptions;z.id=L,z.dd=S,z.sdf=I;const C=E.getProgram(4,w,z);if(s.bindProgram(C),I){const e=t.getPaintValue("icon-halo-color",f),i=t.getPaintValue("icon-halo-width",f);C.setUniform4f("u_outlineColor",e[0],e[1],e[2],e[3]),C.setUniform1f("u_outlineSize",i)}C.setUniformMatrix3fv("u_displayViewMat3",0===V?d.displayViewMat3:d.displayMat3),C.setUniformMatrix3fv("u_displayMat3",1===D?d.displayMat3:d.displayViewMat3),C.setUniform2fv("u_iconTranslation",P),C.setUniform1f("u_depth",t.z),C.setUniform1f("u_mapRotation",u.degToByte(d.rotation)),C.setUniform1f("u_keepUpright",M?1:0),C.setUniform1f("u_level",10*f),C.setUniform1i("u_texture",a.VTL_TEXTURE_BINDING_UNIT_SPRITES),C.setUniform1f("u_size",y),C.setUniform4fv("u_color",this._color),C.setUniform1f("u_opacity",1),C.setUniform1f("u_fadeDuration",n.FADE_DURATION/1e3),L&&C.setUniform4fv("u_id",r);for(const t of o){if(!t.layerData.has(p))continue;if(m=t.layerData.get(p),0===m.iconPerPageElementsMap.size)continue;m.prepareForRendering(s,E),m.updateOpacityInfo();const a=m.iconVertexArrayObject;if(!i.isNone(a)){s.bindVAO(a),C.setUniformMatrix3fv("u_dvsMat3",t.transforms.dvs),C.setUniform1f("u_time",(performance.now()-m.lastOpacityUpdate)/1e3);for(const[i,a]of m.iconPerPageElementsMap)this._renderIconRange(e,C,a,i,t)}}},_._renderIconRange=function(e,t,i,o,r){const{context:n,spriteMosaic:s}=e;this._spritesTextureSize[0]=s.getWidth(o)/4,this._spritesTextureSize[1]=s.getHeight(o)/4,t.setUniform2fv("u_mosaicSize",this._spritesTextureSize),s.bind(n,9729,o,a.VTL_TEXTURE_BINDING_UNIT_SPRITES),n.setStencilTestEnabled(!0),n.setStencilFunction(516,255,255),n.setStencilWriteMask(0),n.drawElements(4,i[1],5125,Uint32Array.BYTES_PER_ELEMENT*i[0]),r.triangleCount+=i[1]/3},_._drawText=function(e,t,r,s){const{context:f,displayLevel:_,drawPhase:h,glyphMosaic:d,painter:p,pixelRatio:m,state:g,styleLayerUID:y}=e;let U,T=!1;for(const e of r)if(e.layerData.has(y)&&(U=e.layerData.get(y),U.glyphPerPageElementsMap.size>0)){T=!0;break}if(!T)return;let P=t.getLayoutValue("text-rotation-alignment",_);2===P&&(P=0===t.getLayoutValue("symbol-placement",_)?1:0);const D=0===P,E=t.getLayoutValue("text-keep-upright",_)&&D,x=h===l.WGLDrawPhase.HITTEST,V=.8*3/m,v=t.hasDataDrivenTextSize?1:t.getLayoutValue("text-size",_),M=t.hasDataDrivenTextColor?c:t.getPaintValue("text-color",_),I=t.hasDataDrivenTextOpacity?1:t.getPaintValue("text-opacity",_),S=t.getPaintValue("text-halo-color",_),L=t.getPaintValue("text-halo-width",_),w=3*t.getPaintValue("text-halo-blur",_),z=3*L,C=p.getVectorTileProgramCache(),b=M[3]*I;this._sdfColor[0]=b*M[0],this._sdfColor[1]=b*M[1],this._sdfColor[2]=b*M[2],this._sdfColor[3]=b;const R=S[3]*I;this._haloColor[0]=R*S[0],this._haloColor[1]=R*S[1],this._haloColor[2]=R*S[2],this._haloColor[3]=R,this._glyphTextureSize||(this._glyphTextureSize=o.fromValues(d.width/4,d.height/4));const N=t.getPaintValue("text-translate",_),O=t.getPaintValue("text-translate-anchor",_),B=t.hasDataDrivenText,G=(x?1:0)<<1|(B?1:0),k=this._sdfProgramOptions;k.id=x,k.dd=B;const A=C.getProgram(6,G,k);f.bindProgram(A),A.setUniformMatrix3fv("u_displayViewMat3",0===P?g.displayViewMat3:g.displayMat3),A.setUniformMatrix3fv("u_displayMat3",1===O?g.displayMat3:g.displayViewMat3),A.setUniform2fv("u_textTranslation",N),A.setUniform1f("u_depth",t.z+152587890625e-16),A.setUniform2fv("u_mosaicSize",this._glyphTextureSize),A.setUniform1f("u_mapRotation",u.degToByte(g.rotation)),A.setUniform1f("u_keepUpright",E?1:0),A.setUniform1f("u_level",10*_),A.setUniform1i("u_texture",a.VTL_TEXTURE_BINDING_UNIT_GLYPHS),A.setUniform1f("u_size",v),A.setUniform1f("u_antialiasingWidth",V),A.setUniform1f("u_opacity",1),A.setUniform1f("u_fadeDuration",n.FADE_DURATION/1e3),x&&A.setUniform4fv("u_id",s);for(const e of r){if(!e.layerData.has(y))continue;if(U=e.layerData.get(y),0===U.glyphPerPageElementsMap.size)continue;U.prepareForRendering(f,C),U.updateOpacityInfo();const t=U.textVertexArrayObject;if(i.isNone(t))continue;f.bindVAO(t),A.setUniformMatrix3fv("u_dvsMat3",e.transforms.dvs),f.setStencilTestEnabled(!0),f.setStencilFunction(516,255,255),f.setStencilWriteMask(0);const a=(performance.now()-U.lastOpacityUpdate)/1e3;A.setUniform1f("u_time",a),U.glyphPerPageElementsMap.forEach(((t,i)=>{this._renderGlyphRange(f,t,i,d,A,S[3],L,w,z,e)}))}},_._renderGlyphRange=function(e,t,i,o,r,n,s,l,f,u){o.bind(e,9729,i,a.VTL_TEXTURE_BINDING_UNIT_GLYPHS),n>0&&s>0&&(r.setUniform4fv("u_color",this._haloColor),r.setUniform1f("u_halo",1),r.setUniform1f("u_edgeDistance",f),r.setUniform1f("u_edgeBlur",l),e.drawElements(4,t[1],5125,Uint32Array.BYTES_PER_ELEMENT*t[0]),u.triangleCount+=t[1]/3),this._sdfColor[3]>0&&(r.setUniform4fv("u_color",this._sdfColor),r.setUniform1f("u_halo",0),r.setUniform1f("u_edgeDistance",0),r.setUniform1f("u_edgeBlur",0),e.drawElements(4,t[1],5125,Uint32Array.BYTES_PER_ELEMENT*t[0]),u.triangleCount+=t[1]/3)},f}(f);e.WGLBrushVTLSymbol=_,Object.defineProperty(e,"__esModule",{value:!0})}));
