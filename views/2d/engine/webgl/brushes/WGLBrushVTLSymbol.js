/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{isSome as e,isNone as t}from"../../../../../core/maybe.js";import{c as i,f as a}from"../../../../../chunks/vec2f32.js";import{FADE_DURATION as r}from"../../vectorTiles/decluttering/config.js";import{RotationAlignment as s,SymbolPlacement as n,TranslateAnchor as o}from"../../vectorTiles/style/StyleDefinition.js";import{VTL_TEXTURE_BINDING_UNIT_SPRITES as l,VTL_TEXTURE_BINDING_UNIT_GLYPHS as f}from"../definitions.js";import{WGLDrawPhase as u}from"../enums.js";import{degToByte as m}from"../GeometryUtils.js";import{u32to4Xu8 as p}from"../number.js";import c from"./WGLBrush.js";import{TextureSamplingMode as d,CompareFunction as g,PrimitiveType as y,DataType as _}from"../../../../webgl/enums.js";const h=1/65536;class M extends c{constructor(){super(...arguments),this._iconProgramOptions={id:!1,sdf:!1},this._sdfProgramOptions={id:!1},this._spritesTextureSize=i()}dispose(){}drawMany(e,t){const{drawPhase:i,styleLayerUID:a}=e,r=e.styleLayer;let s;i===u.HITTEST&&(s=p(a+1)),this._drawIcons(e,r,t,s),this._drawText(e,r,t,s)}_drawIcons(i,a,f,p){const{context:c,displayLevel:d,drawPhase:g,painter:y,spriteMosaic:_,state:h,styleLayerUID:M,requestRender:P}=i,T=a.iconMaterial,U=y.vectorTilesMaterialManager;let E,x=!1;for(const e of f)if(e.layerData.has(M)&&(E=e.layerData.get(M),E.iconPerPageElementsMap.size>0)){x=!0;break}if(!x)return;const v=a.getPaintValue("icon-translate",d),I=a.getPaintValue("icon-translate-anchor",d);let S=a.getLayoutValue("icon-rotation-alignment",d);S===s.AUTO&&(S=a.getLayoutValue("symbol-placement",d)===n.POINT?s.VIEWPORT:s.MAP);const D=S===s.MAP,V=a.getLayoutValue("icon-keep-upright",d)&&D,R=E.isIconSDF,w=g===u.HITTEST,A=this._iconProgramOptions;A.id=w,A.sdf=R;const L=U.getMaterialProgram(c,T,A);if(e(P)&&!w&&!L.isCompiled)return void P();c.useProgram(L),L.setUniformMatrix3fv("u_displayViewMat3",S===s.MAP?h.displayViewMat3:h.displayMat3),L.setUniformMatrix3fv("u_displayMat3",I===o.VIEWPORT?h.displayMat3:h.displayViewMat3),L.setUniform2fv("u_iconTranslation",v),L.setUniform1f("u_depth",a.z),L.setUniform1f("u_mapRotation",m(h.rotation)),L.setUniform1f("u_keepUpright",V?1:0),L.setUniform1f("u_level",10*d),L.setUniform1i("u_texture",l),L.setUniform1f("u_fadeDuration",r/1e3),w&&L.setUniform4fv("u_id",p);let O=-1;for(const e of f){if(!e.layerData.has(M))continue;if(e.key.level!==O&&(O=e.key.level,T.setDataUniforms(L,d,a,O,_)),E=e.layerData.get(M),0===E.iconPerPageElementsMap.size)continue;E.prepareForRendering(c),E.updateOpacityInfo();const r=E.iconVertexArrayObject;if(!t(r)){c.bindVAO(r),L.setUniformMatrix3fv("u_dvsMat3",e.transforms.dvs),L.setUniform1f("u_time",(performance.now()-E.lastOpacityUpdate)/1e3);for(const[t,a]of E.iconPerPageElementsMap)this._renderIconRange(i,L,a,t,e)}}}_renderIconRange(e,t,i,a,r){const{context:s,spriteMosaic:n}=e;this._spritesTextureSize[0]=n.getWidth(a)/4,this._spritesTextureSize[1]=n.getHeight(a)/4,t.setUniform2fv("u_mosaicSize",this._spritesTextureSize),n.bind(s,d.LINEAR,a,l),s.setStencilTestEnabled(!0),s.setStencilFunction(g.GREATER,255,255),s.setStencilWriteMask(0),s.drawElements(y.TRIANGLES,i[1],_.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*i[0]),r.triangleCount+=i[1]/3}_drawText(i,l,p,c){const{context:d,displayLevel:y,drawPhase:_,glyphMosaic:M,painter:P,pixelRatio:T,spriteMosaic:U,state:E,styleLayerUID:x,requestRender:v}=i,I=l.textMaterial,S=P.vectorTilesMaterialManager;let D,V=!1;for(const e of p)if(e.layerData.has(x)&&(D=e.layerData.get(x),D.glyphPerPageElementsMap.size>0)){V=!0;break}if(!V)return;const R=l.getPaintProperty("text-opacity");if(R&&!R.isDataDriven&&0===R.getValue(y))return;const w=l.getPaintProperty("text-color"),A=!w||w.isDataDriven||w.getValue(y)[3]>0,L=l.getPaintProperty("text-halo-width"),O=l.getPaintProperty("text-halo-color"),N=(!L||L.isDataDriven||L.getValue(y)>0)&&(!O||O.isDataDriven||O.getValue(y)[3]>0);if(!A&&!N)return;const b=24/8;let z=l.getLayoutValue("text-rotation-alignment",y);z===s.AUTO&&(z=l.getLayoutValue("symbol-placement",y)===n.POINT?s.VIEWPORT:s.MAP);const k=z===s.MAP,j=l.getLayoutValue("text-keep-upright",y)&&k,G=_===u.HITTEST,W=.8*b/T;this._glyphTextureSize||(this._glyphTextureSize=a(M.width/4,M.height/4));const C=l.getPaintValue("text-translate",y),F=l.getPaintValue("text-translate-anchor",y),B=this._sdfProgramOptions;B.id=G;const H=S.getMaterialProgram(d,I,B);if(e(v)&&!G&&!H.isCompiled)return void v();d.useProgram(H),H.setUniformMatrix3fv("u_displayViewMat3",z===s.MAP?E.displayViewMat3:E.displayMat3),H.setUniformMatrix3fv("u_displayMat3",F===o.VIEWPORT?E.displayMat3:E.displayViewMat3),H.setUniform2fv("u_textTranslation",C),H.setUniform1f("u_depth",l.z+h),H.setUniform2fv("u_mosaicSize",this._glyphTextureSize),H.setUniform1f("u_mapRotation",m(E.rotation)),H.setUniform1f("u_keepUpright",j?1:0),H.setUniform1f("u_level",10*y),H.setUniform1i("u_texture",f),H.setUniform1f("u_antialiasingWidth",W),H.setUniform1f("u_fadeDuration",r/1e3),G&&H.setUniform4fv("u_id",c);let Y=-1;for(const e of p){if(!e.layerData.has(x))continue;if(e.key.level!==Y&&(Y=e.key.level,I.setDataUniforms(H,y,l,Y,U)),D=e.layerData.get(x),0===D.glyphPerPageElementsMap.size)continue;D.prepareForRendering(d),D.updateOpacityInfo();const i=D.textVertexArrayObject;if(t(i))continue;d.bindVAO(i),H.setUniformMatrix3fv("u_dvsMat3",e.transforms.dvs),d.setStencilTestEnabled(!0),d.setStencilFunction(g.GREATER,255,255),d.setStencilWriteMask(0);const a=(performance.now()-D.lastOpacityUpdate)/1e3;H.setUniform1f("u_time",a),D.glyphPerPageElementsMap.forEach(((t,i)=>{this._renderGlyphRange(d,t,i,M,H,N,A,e)}))}}_renderGlyphRange(e,t,i,a,r,s,n,o){a.bind(e,d.LINEAR,i,f),s&&(r.setUniform1f("u_halo",1),e.drawElements(y.TRIANGLES,t[1],_.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t[0]),o.triangleCount+=t[1]/3),n&&(r.setUniform1f("u_halo",0),e.drawElements(y.TRIANGLES,t[1],_.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t[0]),o.triangleCount+=t[1]/3)}}export{M as WGLBrushVTLSymbol};
