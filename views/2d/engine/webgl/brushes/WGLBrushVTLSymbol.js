/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/maybe","../../../../../chunks/vec2f32","../../vectorTiles/decluttering/config","../../vectorTiles/style/StyleDefinition","../definitions","../enums","../GeometryUtils","../number","./WGLBrush","../../../../webgl/enums"],(function(e,t,i,a,n,r,o,s,l,u,f,c){"use strict";const m=1/65536;let p=function(e){function f(){var t;return(t=e.apply(this,arguments)||this)._iconProgramOptions={id:!1,sdf:!1},t._sdfProgramOptions={id:!1},t._spritesTextureSize=a.create(),t}t._inheritsLoose(f,e);var p=f.prototype;return p.dispose=function(){},p.drawMany=function(e,t){const{drawPhase:i,styleLayerUID:a}=e,n=e.styleLayer;let r;i===s.WGLDrawPhase.HITTEST&&(r=u.u32to4Xu8(a+1)),this._drawIcons(e,n,t,r),this._drawText(e,n,t,r)},p._drawIcons=function(e,t,a,u){const{context:f,displayLevel:c,drawPhase:m,painter:p,spriteMosaic:g,state:y,styleLayerUID:d,requestRender:T,allowDelayedRender:_}=e,P=t.iconMaterial,h=p.vectorTilesMaterialManager;let E,U=!1;for(const i of a)if(i.layerData.has(d)&&(E=i.layerData.get(d),E.iconPerPageElementsMap.size>0)){U=!0;break}if(!U)return;const M=t.getPaintValue("icon-translate",c),R=t.getPaintValue("icon-translate-anchor",c);let I=t.getLayoutValue("icon-rotation-alignment",c);I===r.RotationAlignment.AUTO&&(I=t.getLayoutValue("symbol-placement",c)===r.SymbolPlacement.POINT?r.RotationAlignment.VIEWPORT:r.RotationAlignment.MAP);const D=I===r.RotationAlignment.MAP,S=t.getLayoutValue("icon-keep-upright",c)&&D,v=E.isIconSDF,A=m===s.WGLDrawPhase.HITTEST,x=this._iconProgramOptions;x.id=A,x.sdf=v;const N=h.getMaterialProgram(f,P,x);if(_&&i.isSome(T)&&!N.compiled)return void T();f.useProgram(N),N.setUniformMatrix3fv("u_displayViewMat3",I===r.RotationAlignment.MAP?y.displayViewMat3:y.displayMat3),N.setUniformMatrix3fv("u_displayMat3",R===r.TranslateAnchor.VIEWPORT?y.displayMat3:y.displayViewMat3),N.setUniform2fv("u_iconTranslation",M),N.setUniform1f("u_depth",t.z),N.setUniform1f("u_mapRotation",l.degToByte(y.rotation)),N.setUniform1f("u_keepUpright",S?1:0),N.setUniform1f("u_level",10*c),N.setUniform1i("u_texture",o.VTL_TEXTURE_BINDING_UNIT_SPRITES),N.setUniform1f("u_fadeDuration",n.FADE_DURATION/1e3),A&&N.setUniform4fv("u_id",u);let V=-1;for(const n of a){if(!n.layerData.has(d))continue;if(n.key.level!==V&&(V=n.key.level,P.setDataUniforms(N,c,t,V,g)),E=n.layerData.get(d),0===E.iconPerPageElementsMap.size)continue;E.prepareForRendering(f),E.updateOpacityInfo();const a=E.iconVertexArrayObject;if(!i.isNone(a)){f.bindVAO(a),N.setUniformMatrix3fv("u_dvsMat3",n.transforms.dvs),N.setUniform1f("u_time",(performance.now()-E.lastOpacityUpdate)/1e3);for(const[t,i]of E.iconPerPageElementsMap)this._renderIconRange(e,N,i,t,n)}}},p._renderIconRange=function(e,t,i,a,n){const{context:r,spriteMosaic:s}=e;this._spritesTextureSize[0]=s.getWidth(a)/4,this._spritesTextureSize[1]=s.getHeight(a)/4,t.setUniform2fv("u_mosaicSize",this._spritesTextureSize),s.bind(r,c.TextureSamplingMode.LINEAR,a,o.VTL_TEXTURE_BINDING_UNIT_SPRITES),r.setStencilTestEnabled(!0),r.setStencilFunction(c.CompareFunction.GREATER,255,255),r.setStencilWriteMask(0),r.drawElements(c.PrimitiveType.TRIANGLES,i[1],c.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*i[0]),n.triangleCount+=i[1]/3},p._drawText=function(e,t,u,f){const{context:p,displayLevel:g,drawPhase:y,glyphMosaic:d,painter:T,pixelRatio:_,spriteMosaic:P,state:h,styleLayerUID:E,requestRender:U,allowDelayedRender:M}=e,R=t.textMaterial,I=T.vectorTilesMaterialManager;let D,S=!1;for(const i of u)if(i.layerData.has(E)&&(D=i.layerData.get(E),D.glyphPerPageElementsMap.size>0)){S=!0;break}if(!S)return;const v=t.getPaintProperty("text-opacity");if(v&&!v.isDataDriven&&0===v.getValue(g))return;const A=t.getPaintProperty("text-color"),x=!A||A.isDataDriven||A.getValue(g)[3]>0,N=t.getPaintProperty("text-halo-width"),V=t.getPaintProperty("text-halo-color"),L=(!N||N.isDataDriven||N.getValue(g)>0)&&(!V||V.isDataDriven||V.getValue(g)[3]>0);if(!x&&!L)return;const w=24/8;let O=t.getLayoutValue("text-rotation-alignment",g);O===r.RotationAlignment.AUTO&&(O=t.getLayoutValue("symbol-placement",g)===r.SymbolPlacement.POINT?r.RotationAlignment.VIEWPORT:r.RotationAlignment.MAP);const G=O===r.RotationAlignment.MAP,b=t.getLayoutValue("text-keep-upright",g)&&G,z=y===s.WGLDrawPhase.HITTEST,k=.8*w/_;this._glyphTextureSize||(this._glyphTextureSize=a.fromValues(d.width/4,d.height/4));const W=t.getPaintValue("text-translate",g),B=t.getPaintValue("text-translate-anchor",g),F=this._sdfProgramOptions;F.id=z;const H=I.getMaterialProgram(p,R,F);if(M&&i.isSome(U)&&!H.compiled)return void U();p.useProgram(H),H.setUniformMatrix3fv("u_displayViewMat3",O===r.RotationAlignment.MAP?h.displayViewMat3:h.displayMat3),H.setUniformMatrix3fv("u_displayMat3",B===r.TranslateAnchor.VIEWPORT?h.displayMat3:h.displayViewMat3),H.setUniform2fv("u_textTranslation",W),H.setUniform1f("u_depth",t.z+m),H.setUniform2fv("u_mosaicSize",this._glyphTextureSize),H.setUniform1f("u_mapRotation",l.degToByte(h.rotation)),H.setUniform1f("u_keepUpright",b?1:0),H.setUniform1f("u_level",10*g),H.setUniform1i("u_texture",o.VTL_TEXTURE_BINDING_UNIT_GLYPHS),H.setUniform1f("u_antialiasingWidth",k),H.setUniform1f("u_fadeDuration",n.FADE_DURATION/1e3),z&&H.setUniform4fv("u_id",f);let C=-1;for(const a of u){if(!a.layerData.has(E))continue;if(a.key.level!==C&&(C=a.key.level,R.setDataUniforms(H,g,t,C,P)),D=a.layerData.get(E),0===D.glyphPerPageElementsMap.size)continue;D.prepareForRendering(p),D.updateOpacityInfo();const e=D.textVertexArrayObject;if(i.isNone(e))continue;p.bindVAO(e),H.setUniformMatrix3fv("u_dvsMat3",a.transforms.dvs),p.setStencilTestEnabled(!0),p.setStencilFunction(c.CompareFunction.GREATER,255,255),p.setStencilWriteMask(0);const n=(performance.now()-D.lastOpacityUpdate)/1e3;H.setUniform1f("u_time",n),D.glyphPerPageElementsMap.forEach(((e,t)=>{this._renderGlyphRange(p,e,t,d,H,L,x,a)}))}},p._renderGlyphRange=function(e,t,i,a,n,r,s,l){a.bind(e,c.TextureSamplingMode.LINEAR,i,o.VTL_TEXTURE_BINDING_UNIT_GLYPHS),r&&(n.setUniform1f("u_halo",1),e.drawElements(c.PrimitiveType.TRIANGLES,t[1],c.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t[0]),l.triangleCount+=t[1]/3),s&&(n.setUniform1f("u_halo",0),e.drawElements(c.PrimitiveType.TRIANGLES,t[1],c.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t[0]),l.triangleCount+=t[1]/3)},f}(f);e.WGLBrushVTLSymbol=p,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
