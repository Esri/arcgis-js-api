/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/maybe","../definitions","../../../../../chunks/vec2f32","../../vectorTiles/decluttering/config","../number","../enums","./WGLBrush","../GeometryUtils"],(function(e,t,a,i,n,r,o,s,l,f){"use strict";const u=1/65536;let c=function(e){function l(){var t;return(t=e.apply(this,arguments)||this)._iconProgramOptions={id:!1,sdf:!1},t._sdfProgramOptions={id:!1},t._spritesTextureSize=n.create(),t}t._inheritsLoose(l,e);var c=l.prototype;return c.dispose=function(){},c.drawMany=function(e,t){const{drawPhase:a,styleLayerUID:i}=e,n=e.styleLayer;let r;a===s.WGLDrawPhase.HITTEST&&(r=o.u32to4Xu8(i+1)),this._drawIcons(e,n,t,r),this._drawText(e,n,t,r)},c._drawIcons=function(e,t,n,o){const{context:l,displayLevel:u,drawPhase:c,painter:p,state:_,styleLayerUID:y}=e,d=t.iconMaterial,g=p.vectorTilesMaterialManager;let m,h=!1;for(const a of n)if(a.layerData.has(y)&&(m=a.layerData.get(y),m.iconPerPageElementsMap.size>0)){h=!0;break}if(!h)return;const T=t.getPaintValue("icon-translate",u),U=t.getPaintValue("icon-translate-anchor",u);let P=t.getLayoutValue("icon-rotation-alignment",u);2===P&&(P=0===t.getLayoutValue("symbol-placement",u)?1:0);const M=0===P,E=t.getLayoutValue("icon-keep-upright",u)&&M,v=m.isIconSDF,x=c===s.WGLDrawPhase.HITTEST,D=this._iconProgramOptions;D.id=x,D.sdf=v;const V=g.getMaterialProgram(l,d,D);l.bindProgram(V),V.setUniformMatrix3fv("u_displayViewMat3",0===P?_.displayViewMat3:_.displayMat3),V.setUniformMatrix3fv("u_displayMat3",1===U?_.displayMat3:_.displayViewMat3),V.setUniform2fv("u_iconTranslation",T),V.setUniform1f("u_depth",t.z),V.setUniform1f("u_mapRotation",f.degToByte(_.rotation)),V.setUniform1f("u_keepUpright",E?1:0),V.setUniform1f("u_level",10*u),V.setUniform1i("u_texture",i.VTL_TEXTURE_BINDING_UNIT_SPRITES),V.setUniform1f("u_fadeDuration",r.FADE_DURATION/1e3),x&&V.setUniform4fv("u_id",o);let I=-1;for(const i of n){if(!i.layerData.has(y))continue;if(i.key.level!==I&&(I=i.key.level,d.setDataUniforms(V,u,t,I)),m=i.layerData.get(y),0===m.iconPerPageElementsMap.size)continue;m.prepareForRendering(l),m.updateOpacityInfo();const n=m.iconVertexArrayObject;if(!a.isNone(n)){l.bindVAO(n),V.setUniformMatrix3fv("u_dvsMat3",i.transforms.dvs),V.setUniform1f("u_time",(performance.now()-m.lastOpacityUpdate)/1e3);for(const[t,a]of m.iconPerPageElementsMap)this._renderIconRange(e,V,a,t,i)}}},c._renderIconRange=function(e,t,a,n,r){const{context:o,spriteMosaic:s}=e;this._spritesTextureSize[0]=s.getWidth(n)/4,this._spritesTextureSize[1]=s.getHeight(n)/4,t.setUniform2fv("u_mosaicSize",this._spritesTextureSize),s.bind(o,9729,n,i.VTL_TEXTURE_BINDING_UNIT_SPRITES),o.setStencilTestEnabled(!0),o.setStencilFunction(516,255,255),o.setStencilWriteMask(0),o.drawElements(4,a[1],5125,Uint32Array.BYTES_PER_ELEMENT*a[0]),r.triangleCount+=a[1]/3},c._drawText=function(e,t,o,l){const{context:c,displayLevel:p,drawPhase:_,glyphMosaic:y,painter:d,pixelRatio:g,state:m,styleLayerUID:h}=e,T=t.textMaterial,U=d.vectorTilesMaterialManager;let P,M=!1;for(const a of o)if(a.layerData.has(h)&&(P=a.layerData.get(h),P.glyphPerPageElementsMap.size>0)){M=!0;break}if(!M)return;const E=t.getPaintProperty("text-opacity");if(E&&!E.isDataDriven&&0===E.getValue(p))return;const v=t.getPaintProperty("text-color"),x=!v||v.isDataDriven||v.getValue(p)[3]>0,D=t.getPaintProperty("text-halo-width"),V=t.getPaintProperty("text-halo-color"),I=(!D||D.isDataDriven||D.getValue(p)>0)&&(!V||V.isDataDriven||V.getValue(p)[3]>0);if(!x&&!I)return;const S=24/8;let L=t.getLayoutValue("text-rotation-alignment",p);2===L&&(L=0===t.getLayoutValue("symbol-placement",p)?1:0);const w=0===L,R=t.getLayoutValue("text-keep-upright",p)&&w,b=_===s.WGLDrawPhase.HITTEST,N=.8*S/g;this._glyphTextureSize||(this._glyphTextureSize=n.fromValues(y.width/4,y.height/4));const z=t.getPaintValue("text-translate",p),O=t.getPaintValue("text-translate-anchor",p),k=this._sdfProgramOptions;k.id=b;const G=U.getMaterialProgram(c,T,k);c.bindProgram(G),G.setUniformMatrix3fv("u_displayViewMat3",0===L?m.displayViewMat3:m.displayMat3),G.setUniformMatrix3fv("u_displayMat3",1===O?m.displayMat3:m.displayViewMat3),G.setUniform2fv("u_textTranslation",z),G.setUniform1f("u_depth",t.z+u),G.setUniform2fv("u_mosaicSize",this._glyphTextureSize),G.setUniform1f("u_mapRotation",f.degToByte(m.rotation)),G.setUniform1f("u_keepUpright",R?1:0),G.setUniform1f("u_level",10*p),G.setUniform1i("u_texture",i.VTL_TEXTURE_BINDING_UNIT_GLYPHS),G.setUniform1f("u_antialiasingWidth",N),G.setUniform1f("u_fadeDuration",r.FADE_DURATION/1e3),b&&G.setUniform4fv("u_id",l);let B=-1;for(const i of o){if(!i.layerData.has(h))continue;if(i.key.level!==B&&(B=i.key.level,T.setDataUniforms(G,p,t,B)),P=i.layerData.get(h),0===P.glyphPerPageElementsMap.size)continue;P.prepareForRendering(c),P.updateOpacityInfo();const e=P.textVertexArrayObject;if(a.isNone(e))continue;c.bindVAO(e),G.setUniformMatrix3fv("u_dvsMat3",i.transforms.dvs),c.setStencilTestEnabled(!0),c.setStencilFunction(516,255,255),c.setStencilWriteMask(0);const n=(performance.now()-P.lastOpacityUpdate)/1e3;G.setUniform1f("u_time",n),P.glyphPerPageElementsMap.forEach(((e,t)=>{this._renderGlyphRange(c,e,t,y,G,I,x,i)}))}},c._renderGlyphRange=function(e,t,a,n,r,o,s,l){n.bind(e,9729,a,i.VTL_TEXTURE_BINDING_UNIT_GLYPHS),o&&(r.setUniform1f("u_halo",1),e.drawElements(4,t[1],5125,Uint32Array.BYTES_PER_ELEMENT*t[0]),l.triangleCount+=t[1]/3),s&&(r.setUniform1f("u_halo",0),e.drawElements(4,t[1],5125,Uint32Array.BYTES_PER_ELEMENT*t[0]),l.triangleCount+=t[1]/3)},l}(l);e.WGLBrushVTLSymbol=c,Object.defineProperty(e,"__esModule",{value:!0})}));
