/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/maybe","../../../../../chunks/vec2f32","../../vectorTiles/decluttering/config","../../vectorTiles/style/StyleDefinition","../definitions","../enums","../GeometryUtils","../number","./WGLBrush","../../../../webgl/enums"],(function(e,t,i,a,n,r,o,s,l,u,f,c){"use strict";const p=1/65536;let m=function(e){function f(){var t;return(t=e.apply(this,arguments)||this)._iconProgramOptions={id:!1,sdf:!1},t._sdfProgramOptions={id:!1},t._spritesTextureSize=a.create(),t}t._inheritsLoose(f,e);var m=f.prototype;return m.dispose=function(){},m.drawMany=function(e,t){const{drawPhase:i,styleLayerUID:a}=e,n=e.styleLayer;let r;i===s.WGLDrawPhase.HITTEST&&(r=u.u32to4Xu8(a+1)),this._drawIcons(e,n,t,r),this._drawText(e,n,t,r)},m._drawIcons=function(e,t,a,u){const{context:f,displayLevel:c,drawPhase:p,painter:m,spriteMosaic:g,state:y,styleLayerUID:T}=e,_=t.iconMaterial,d=m.vectorTilesMaterialManager;let P,h=!1;for(const i of a)if(i.layerData.has(T)&&(P=i.layerData.get(T),P.iconPerPageElementsMap.size>0)){h=!0;break}if(!h)return;const E=t.getPaintValue("icon-translate",c),U=t.getPaintValue("icon-translate-anchor",c);let M=t.getLayoutValue("icon-rotation-alignment",c);M===r.RotationAlignment.AUTO&&(M=t.getLayoutValue("symbol-placement",c)===r.SymbolPlacement.POINT?r.RotationAlignment.VIEWPORT:r.RotationAlignment.MAP);const I=M===r.RotationAlignment.MAP,R=t.getLayoutValue("icon-keep-upright",c)&&I,D=P.isIconSDF,S=p===s.WGLDrawPhase.HITTEST,v=this._iconProgramOptions;v.id=S,v.sdf=D;const A=d.getMaterialProgram(f,_,v);f.useProgram(A),A.setUniformMatrix3fv("u_displayViewMat3",M===r.RotationAlignment.MAP?y.displayViewMat3:y.displayMat3),A.setUniformMatrix3fv("u_displayMat3",U===r.TranslateAnchor.VIEWPORT?y.displayMat3:y.displayViewMat3),A.setUniform2fv("u_iconTranslation",E),A.setUniform1f("u_depth",t.z),A.setUniform1f("u_mapRotation",l.degToByte(y.rotation)),A.setUniform1f("u_keepUpright",R?1:0),A.setUniform1f("u_level",10*c),A.setUniform1i("u_texture",o.VTL_TEXTURE_BINDING_UNIT_SPRITES),A.setUniform1f("u_fadeDuration",n.FADE_DURATION/1e3),S&&A.setUniform4fv("u_id",u);let x=-1;for(const n of a){if(!n.layerData.has(T))continue;if(n.key.level!==x&&(x=n.key.level,_.setDataUniforms(A,c,t,x,g)),P=n.layerData.get(T),0===P.iconPerPageElementsMap.size)continue;P.prepareForRendering(f),P.updateOpacityInfo();const a=P.iconVertexArrayObject;if(!i.isNone(a)){f.bindVAO(a),A.setUniformMatrix3fv("u_dvsMat3",n.transforms.dvs),A.setUniform1f("u_time",(performance.now()-P.lastOpacityUpdate)/1e3);for(const[t,i]of P.iconPerPageElementsMap)this._renderIconRange(e,A,i,t,n)}}},m._renderIconRange=function(e,t,i,a,n){const{context:r,spriteMosaic:s}=e;this._spritesTextureSize[0]=s.getWidth(a)/4,this._spritesTextureSize[1]=s.getHeight(a)/4,t.setUniform2fv("u_mosaicSize",this._spritesTextureSize),s.bind(r,c.TextureSamplingMode.LINEAR,a,o.VTL_TEXTURE_BINDING_UNIT_SPRITES),r.setStencilTestEnabled(!0),r.setStencilFunction(c.CompareFunction.GREATER,255,255),r.setStencilWriteMask(0),r.drawElements(c.PrimitiveType.TRIANGLES,i[1],c.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*i[0]),n.triangleCount+=i[1]/3},m._drawText=function(e,t,u,f){const{context:m,displayLevel:g,drawPhase:y,glyphMosaic:T,painter:_,pixelRatio:d,spriteMosaic:P,state:h,styleLayerUID:E}=e,U=t.textMaterial,M=_.vectorTilesMaterialManager;let I,R=!1;for(const i of u)if(i.layerData.has(E)&&(I=i.layerData.get(E),I.glyphPerPageElementsMap.size>0)){R=!0;break}if(!R)return;const D=t.getPaintProperty("text-opacity");if(D&&!D.isDataDriven&&0===D.getValue(g))return;const S=t.getPaintProperty("text-color"),v=!S||S.isDataDriven||S.getValue(g)[3]>0,A=t.getPaintProperty("text-halo-width"),x=t.getPaintProperty("text-halo-color"),N=(!A||A.isDataDriven||A.getValue(g)>0)&&(!x||x.isDataDriven||x.getValue(g)[3]>0);if(!v&&!N)return;const V=24/8;let L=t.getLayoutValue("text-rotation-alignment",g);L===r.RotationAlignment.AUTO&&(L=t.getLayoutValue("symbol-placement",g)===r.SymbolPlacement.POINT?r.RotationAlignment.VIEWPORT:r.RotationAlignment.MAP);const w=L===r.RotationAlignment.MAP,O=t.getLayoutValue("text-keep-upright",g)&&w,G=y===s.WGLDrawPhase.HITTEST,b=.8*V/d;this._glyphTextureSize||(this._glyphTextureSize=a.fromValues(T.width/4,T.height/4));const z=t.getPaintValue("text-translate",g),k=t.getPaintValue("text-translate-anchor",g),W=this._sdfProgramOptions;W.id=G;const B=M.getMaterialProgram(m,U,W);m.useProgram(B),B.setUniformMatrix3fv("u_displayViewMat3",L===r.RotationAlignment.MAP?h.displayViewMat3:h.displayMat3),B.setUniformMatrix3fv("u_displayMat3",k===r.TranslateAnchor.VIEWPORT?h.displayMat3:h.displayViewMat3),B.setUniform2fv("u_textTranslation",z),B.setUniform1f("u_depth",t.z+p),B.setUniform2fv("u_mosaicSize",this._glyphTextureSize),B.setUniform1f("u_mapRotation",l.degToByte(h.rotation)),B.setUniform1f("u_keepUpright",O?1:0),B.setUniform1f("u_level",10*g),B.setUniform1i("u_texture",o.VTL_TEXTURE_BINDING_UNIT_GLYPHS),B.setUniform1f("u_antialiasingWidth",b),B.setUniform1f("u_fadeDuration",n.FADE_DURATION/1e3),G&&B.setUniform4fv("u_id",f);let F=-1;for(const a of u){if(!a.layerData.has(E))continue;if(a.key.level!==F&&(F=a.key.level,U.setDataUniforms(B,g,t,F,P)),I=a.layerData.get(E),0===I.glyphPerPageElementsMap.size)continue;I.prepareForRendering(m),I.updateOpacityInfo();const e=I.textVertexArrayObject;if(i.isNone(e))continue;m.bindVAO(e),B.setUniformMatrix3fv("u_dvsMat3",a.transforms.dvs),m.setStencilTestEnabled(!0),m.setStencilFunction(c.CompareFunction.GREATER,255,255),m.setStencilWriteMask(0);const n=(performance.now()-I.lastOpacityUpdate)/1e3;B.setUniform1f("u_time",n),I.glyphPerPageElementsMap.forEach(((e,t)=>{this._renderGlyphRange(m,e,t,T,B,N,v,a)}))}},m._renderGlyphRange=function(e,t,i,a,n,r,s,l){a.bind(e,c.TextureSamplingMode.LINEAR,i,o.VTL_TEXTURE_BINDING_UNIT_GLYPHS),r&&(n.setUniform1f("u_halo",1),e.drawElements(c.PrimitiveType.TRIANGLES,t[1],c.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t[0]),l.triangleCount+=t[1]/3),s&&(n.setUniform1f("u_halo",0),e.drawElements(c.PrimitiveType.TRIANGLES,t[1],c.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t[0]),l.triangleCount+=t[1]/3)},f}(f);e.WGLBrushVTLSymbol=m,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
