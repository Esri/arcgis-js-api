// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../../core/maybe","../../../../../core/libs/gl-matrix-2/vec2f32","../../../../../core/libs/gl-matrix-2/vec4f32","../../vectorTiles/decluttering/config","../definitions","../enums","../GeometryUtils","../number","./WGLBrush"],(function(e,t,a,i,r,o,n,s,l,f,u,c){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WGLBrushVTLSymbol=void 0;var _=[1,1,1,1],d=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._iconProgramOptions={id:!1,dd:!1,sdf:!1},t._sdfProgramOptions={id:!1,dd:!1},t._spritesTextureSize=r.vec2f32.create(),t._haloColor=o.vec4f32.create(),t._sdfColor=o.vec4f32.create(),t._color=o.vec4f32.create(),t}return a.__extends(t,e),t.prototype.dispose=function(){},t.prototype.drawMany=function(e,t){var a,i=e.drawPhase,r=e.styleLayerId,o=e.styleLayer;i===l.WGLDrawPhase.HITTEST&&(a=u.u32to4Xu8(r+1)),this._drawIcons(e,o,t,a),this._drawText(e,o,t,a)},t.prototype._drawIcons=function(e,t,a,r){for(var o,u=this,c=e.context,d=e.displayLevel,h=e.drawPhase,p=e.painter,m=e.state,g=e.styleLayerId,y=!1,v=0,U=a;v<U.length;v++){if((A=U[v]).layerData[g]&&(o=A.layerData[g]).iconPerPageElementsMap.size>0){y=!0;break}}if(y){var T=t.hasDataDrivenIconSize?1:t.getLayoutValue("icon-size",d),P=t.hasDataDrivenIconColor?_:t.getPaintValue("icon-color",d),x=t.hasDataDrivenIconOpacity?1:t.getPaintValue("icon-opacity",d),E=t.getPaintValue("icon-translate",d),D=t.getPaintValue("icon-translate-anchor",d),V=p.getVectorTileProgramCach(),M=P[3]*x;this._color[0]=M*P[0],this._color[1]=M*P[1],this._color[2]=M*P[2],this._color[3]=M;var I=t.getLayoutValue("icon-rotation-alignment",d);2===I&&(I=1===t.getLayoutValue("symbol-placement",d)?0:1);var S=o.isIconSDF,L=t.hasDataDrivenIcon,w=h===l.WGLDrawPhase.HITTEST,b=(w?1:0)<<2|(L?1:0)<<1|(S?1:0),z=this._iconProgramOptions;z.id=w,z.dd=L,z.sdf=S;var C=V.getProgram(4,b,z);if(c.bindProgram(C),S){var R=t.getPaintValue("icon-halo-color",d),N=t.getPaintValue("icon-halo-width",d);C.setUniform4f("u_outlineColor",R[0],R[1],R[2],R[3]),C.setUniform1f("u_outlineSize",N)}C.setUniformMatrix3fv("u_displayViewMat3",0===I?m.displayViewMat3:m.displayMat3),C.setUniformMatrix3fv("u_displayMat3",1===D?m.displayMat3:m.displayViewMat3),C.setUniform2fv("u_iconTranslation",E),C.setUniform1f("u_depth",t.z),C.setUniform1f("u_mapRotation",f.degToByte(m.rotation)),C.setUniform1f("u_keepUpright",0),C.setUniform1f("u_level",10*d),C.setUniform1i("u_texture",s.VTL_TEXTURE_BINDING_UNIT_SPRITES),C.setUniform1f("u_size",T),C.setUniform4fv("u_color",this._color),C.setUniform1f("u_opacity",1),C.setUniform1f("u_fadeDuration",n.FADE_DURATION/1e3),w&&C.setUniform4fv("u_id",r);for(var O=function(t){if(!t.layerData[g])return"continue";if(0===(o=t.layerData[g]).iconPerPageElementsMap.size)return"continue";o.prepareForRendering(c,V),o.updateOpacityInfo();var a=o.iconVertexArrayObject;if(i.isNone(a))return"continue";c.bindVAO(a),C.setUniformMatrix3fv("u_dvsMat3",t.transforms.dvs),C.setUniform1f("u_time",(performance.now()-o.lastOpacityUpdate)/1e3),o.iconPerPageElementsMap.forEach((function(a,i){u._renderIconRange(e,C,a,i,t)}))},G=0,B=a;G<B.length;G++){var A;O(A=B[G])}}},t.prototype._renderIconRange=function(e,t,a,i,r){var o=e.context,n=e.spriteMosaic;this._spritesTextureSize[0]=n.getWidth(i)/4,this._spritesTextureSize[1]=n.getHeight(i)/4,t.setUniform2fv("u_mosaicSize",this._spritesTextureSize),n.bind(o,9729,i,s.VTL_TEXTURE_BINDING_UNIT_SPRITES),o.setStencilTestEnabled(!0),o.setStencilFunction(516,255,255),o.setStencilWriteMask(0),o.drawElements(4,a[1],5125,Uint32Array.BYTES_PER_ELEMENT*a[0]),r.triangleCount+=a[1]/3},t.prototype._drawText=function(e,t,a,o){for(var u,c=this,d=e.context,h=e.displayLevel,p=e.drawPhase,m=e.glyphMosaic,g=e.painter,y=e.pixelRatio,v=e.state,U=e.styleLayerId,T=!1,P=0,x=a;P<x.length;P++){if((q=x[P]).layerData[U]&&(u=q.layerData[U]).glyphPerPageElementsMap.size>0){T=!0;break}}if(T){var E=t.getLayoutValue("text-rotation-alignment",h);2===E&&(E=1===t.getLayoutValue("symbol-placement",h)?0:1);var D=0===E,V=t.getLayoutValue("text-keep-upright",h)&&D,M=p===l.WGLDrawPhase.HITTEST,I=.8*3/y,S=t.hasDataDrivenTextSize?1:t.getLayoutValue("text-size",h),L=t.hasDataDrivenTextColor?_:t.getPaintValue("text-color",h),w=t.hasDataDrivenTextOpacity?1:t.getPaintValue("text-opacity",h),b=t.getPaintValue("text-halo-color",h),z=t.getPaintValue("text-halo-width",h),C=3*t.getPaintValue("text-halo-blur",h),R=3*z,N=g.getVectorTileProgramCach(),O=L[3]*w;this._sdfColor[0]=O*L[0],this._sdfColor[1]=O*L[1],this._sdfColor[2]=O*L[2],this._sdfColor[3]=O;var G=b[3]*w;this._haloColor[0]=G*b[0],this._haloColor[1]=G*b[1],this._haloColor[2]=G*b[2],this._haloColor[3]=G,this._glyphTextureSize||(this._glyphTextureSize=r.vec2f32.fromValues(m.width/4,m.height/4));var B=t.getPaintValue("text-translate",h),A=t.getPaintValue("text-translate-anchor",h),W=t.hasDataDrivenText,k=(M?1:0)<<1|(W?1:0),F=this._sdfProgramOptions;F.id=M,F.dd=W;var H=N.getProgram(6,k,F);d.bindProgram(H),H.setUniformMatrix3fv("u_displayViewMat3",0===E?v.displayViewMat3:v.displayMat3),H.setUniformMatrix3fv("u_displayMat3",1===A?v.displayMat3:v.displayViewMat3),H.setUniform2fv("u_textTranslation",B),H.setUniform1f("u_depth",t.z+1/65536),H.setUniform2fv("u_mosaicSize",this._glyphTextureSize),H.setUniform1f("u_mapRotation",f.degToByte(v.rotation)),H.setUniform1f("u_keepUpright",V?1:0),H.setUniform1f("u_level",10*h),H.setUniform1i("u_texture",s.VTL_TEXTURE_BINDING_UNIT_GLYPHS),H.setUniform1f("u_size",S),H.setUniform1f("u_antialiasingWidth",I),H.setUniform1f("u_opacity",1),H.setUniform1f("u_fadeDuration",n.FADE_DURATION/1e3),M&&H.setUniform4fv("u_id",o);for(var X=function(e){if(!e.layerData[U])return"continue";if(0===(u=e.layerData[U]).glyphPerPageElementsMap.size)return"continue";u.prepareForRendering(d,N),u.updateOpacityInfo();var t=u.textVertexArrayObject;if(i.isNone(t))return"continue";d.bindVAO(t),H.setUniformMatrix3fv("u_dvsMat3",e.transforms.dvs),d.setStencilTestEnabled(!0),d.setStencilFunction(516,255,255),d.setStencilWriteMask(0);var a=(performance.now()-u.lastOpacityUpdate)/1e3;H.setUniform1f("u_time",a),u.glyphPerPageElementsMap.forEach((function(t,a){c._renderGlyphRange(d,t,a,m,H,b[3],z,C,R,e)}))},Y=0,j=a;Y<j.length;Y++){var q;X(q=j[Y])}}},t.prototype._renderGlyphRange=function(e,t,a,i,r,o,n,l,f,u){i.bind(e,9729,a,s.VTL_TEXTURE_BINDING_UNIT_GLYPHS),o>0&&n>0&&(r.setUniform4fv("u_color",this._haloColor),r.setUniform1f("u_halo",1),r.setUniform1f("u_edgeDistance",f),r.setUniform1f("u_edgeBlur",l),e.drawElements(4,t[1],5125,Uint32Array.BYTES_PER_ELEMENT*t[0]),u.triangleCount+=t[1]/3),this._sdfColor[3]>0&&(r.setUniform4fv("u_color",this._sdfColor),r.setUniform1f("u_halo",0),r.setUniform1f("u_edgeDistance",0),r.setUniform1f("u_edgeBlur",0),e.drawElements(4,t[1],5125,Uint32Array.BYTES_PER_ELEMENT*t[0]),u.triangleCount+=t[1]/3)},t}(c.default);t.WGLBrushVTLSymbol=d}));