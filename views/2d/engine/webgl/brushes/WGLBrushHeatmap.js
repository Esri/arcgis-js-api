/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/Logger","../../../../../core/maybe","../enums","../VertexStream","./WGLGeometryBrushMarker","../effects/Effect","../techniques/utils","../../../../webgl/context-util","../../../../webgl/enums","../../../../webgl/FramebufferObject","../../../../webgl/heatmapTextureUtils","../../../../webgl/Renderbuffer","../../../../webgl/Texture"],(function(e,t,r,i,a,u,s,n,o,c,l,h,f,d){"use strict";const p=t.getLogger("esri.views.2d.engine.webgl.brushes.WGLBrushHeatmap");function m(e){return"heatmap"===e.type}let _=function(t){function r(){var e;return(e=t.apply(this,arguments)||this).brushEffect=new T,e}e._inheritsLoose(r,t);var a=r.prototype;return a.supportsSymbology=function(e){return e===i.WGLSymbologyType.HEATMAP},a.dispose=function(){t.prototype.dispose.call(this),this.brushEffect.dispose(),this.brushEffect=null},a.prepareState=function(){},a.drawGeometry=function(e,r,i,a){const{defines:u}=this.brushEffect.loadQualityProfile(e.context);t.prototype.drawGeometry.call(this,e,r,i,a?[...a,...u]:u)},a._drawMarkers=function(e,t,r,i,a,u,s){const{context:o,rendererInfo:l,state:h}=e,{rendererSchema:f}=l;n.assertRendererSchema(f,"heatmap");const{referenceScale:d,radius:p,isFieldActive:m}=f,_=p*(0!==d?d/h.scale:1);r.setUniform1f("u_radius",_),s||(r.setUniform1f("u_isFieldActive",m),o.setStencilFunction(c.CompareFunction.GEQUAL,t.stencilRef,255)),o.drawElements(i,a,c.DataType.UNSIGNED_INT,u)},r}(u);const b={vsPath:"heatmap/heatmapResolve",fsPath:"heatmap/heatmapResolve",attributes:new Map([["a_position",0]])};let T=function(t){function i(){var e;return(e=t.apply(this,arguments)||this).name=e.constructor.name,e}e._inheritsLoose(i,t);var u=i.prototype;return u.createOptions=function({passOptions:e}){return e},u.dispose=function(){this._prevFBO=null,this._accumulateOutputTexture=r.disposeMaybe(this._accumulateOutputTexture),r.isSome(this._accumulateFramebuffer)&&this._accumulateFramebuffer.detachDepthStencilBuffer(),this._accumulateOutputStencilBuffer=r.disposeMaybe(this._accumulateOutputStencilBuffer),this._accumulateFramebuffer=r.disposeMaybe(this._accumulateFramebuffer),this._resolveGradientTexture=r.disposeMaybe(this._resolveGradientTexture),this._tileQuad=r.disposeMaybe(this._tileQuad)},u.bind=function(e){const{context:t,rendererInfo:i,passOptions:a}=e,{rendererSchema:u}=i;!(r.isSome(a)&&"hittest"===a.type)&&m(u)&&(this._prevFBO=t.getBoundFramebufferObject(),this._prevViewport=t.getViewport(),n.assertRendererSchema(u,"heatmap"),this._loadResources(e),this._updateResources(t,u),t.bindFramebuffer(this._accumulateFramebuffer),t.setViewport(0,0,this._accumulateFramebuffer.width,this._accumulateFramebuffer.height),t.setStencilTestEnabled(!0),t.setBlendingEnabled(!0),t.setBlendFunction(c.BlendFactor.ONE,c.BlendFactor.ONE),t.setClearColor(0,0,0,0),t.clear(c.ClearBufferBit.COLOR_BUFFER_BIT))},u.unbind=function(){this._prevFBO=null,this._prevViewport=null},u.draw=function(e){const{context:t,painter:i,rendererInfo:a,passOptions:u}=e,{rendererSchema:s}=a;if(r.isSome(u)&&"hittest"===u.type||!m(s))return;const{defines:n}=this.loadQualityProfile(t),o=i.materialManager.getProgram(b,n);t.useProgram(o),t.bindFramebuffer(this._prevFBO),t.setViewport(0,0,this._prevViewport.width,this._prevViewport.height),t.setBlendFunction(c.BlendFactor.ONE,c.BlendFactor.ONE_MINUS_SRC_ALPHA),t.setStencilTestEnabled(!1);const{radius:l,minDensity:h,densityRange:f}=s;t.bindTexture(this._accumulateOutputTexture,8),t.bindTexture(this._resolveGradientTexture,9),o.setUniform1i("u_texture",8),o.setUniform1i("u_gradient",9),o.setUniform2f("u_densityMinAndInvRange",h,1/f),o.setUniform1f("u_densityNormalization",3/(l*l*Math.PI)),this._tileQuad.draw()},u._loadResources=function({context:e,painter:t}){const{dataType:r,samplingMode:i,pixelFormat:u,internalFormat:s,shadingRate:n,requiresSharedStencilBuffer:o}=this.loadQualityProfile(e),{width:h,height:p}=this._prevViewport,m=h*n,_=p*n;this._accumulateOutputTexture??(this._accumulateOutputTexture=new d.Texture(e,{target:c.TextureType.TEXTURE_2D,pixelFormat:u,internalFormat:s,dataType:r,samplingMode:i,wrapMode:c.TextureWrapMode.CLAMP_TO_EDGE,width:m,height:_})),o||(this._accumulateOutputStencilBuffer??(this._accumulateOutputStencilBuffer=new f.Renderbuffer(e,{width:m,height:_,internalFormat:c.RenderbufferFormat.DEPTH_STENCIL}))),this._accumulateFramebuffer??(this._accumulateFramebuffer=new l.FramebufferObject(e,{},this._accumulateOutputTexture,o?t.getSharedStencilBuffer():this._accumulateOutputStencilBuffer)),this._resolveGradientTexture??(this._resolveGradientTexture=new d.Texture(e,{target:c.TextureType.TEXTURE_2D,pixelFormat:c.PixelFormat.RGBA,dataType:c.PixelType.UNSIGNED_BYTE,samplingMode:c.TextureSamplingMode.LINEAR,wrapMode:c.TextureWrapMode.CLAMP_TO_EDGE})),this._tileQuad??(this._tileQuad=new a(e,[0,0,1,0,0,1,1,1]))},u._updateResources=function(e,t){const{gradientHash:i,gradient:a}=t;this._prevGradientHash!==i&&(this._resolveGradientTexture.resize(a.length/4,1),this._resolveGradientTexture.setData(a),this._prevGradientHash=i);const{shadingRate:u,requiresSharedStencilBuffer:s}=this.loadQualityProfile(e),{width:n,height:o}=this._prevViewport,l=n*u,h=o*u,{width:f,height:d}=this._accumulateFramebuffer;if(f!==l||d!==h){const e=this._accumulateFramebuffer.depthStencilAttachment;if(s&&r.isSome(e)){const{width:t,height:r}=e.descriptor;t===l&&r===h||(p.errorOnce("Attempted to resize shared stencil buffer! Detaching instead."),this._accumulateFramebuffer.detachDepthStencilBuffer())}this._accumulateFramebuffer.resize(l,h)}s||e.blitFramebuffer(this._prevFBO,this._accumulateFramebuffer,0,0,this._prevFBO.width,this._prevFBO.height,0,0,this._accumulateFramebuffer.width,this._accumulateFramebuffer.height,c.ClearBufferBit.STENCIL_BUFFER_BIT,c.TextureSamplingMode.NEAREST)},u.loadQualityProfile=function(e){if(r.isNone(this._qualityProfile)){const t=h.loadHeatmapTextureConfiguration(e,p),r=e.type===o.ContextType.WEBGL1;this._qualityProfile={...t,requiresSharedStencilBuffer:r,shadingRate:r?1:.25,defines:t.dataType!==c.PixelType.FLOAT?["heatmapPrecisionHalfFloat"]:[]}}return this._qualityProfile},i}(s.Effect);return _}));
