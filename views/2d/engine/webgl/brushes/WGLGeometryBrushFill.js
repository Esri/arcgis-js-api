/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/has","../../../../../core/RandomLCG","../definitions","../../../../../chunks/builtins","../../../../webgl/checkWebGLError","../../../../webgl/Texture","../../../../webgl/FramebufferObject","../enums","../materialKey/MaterialKey","../Utils","./WGLGeometryBrush"],(function(e,t,o,i,r,n,s,a,u,l,d,c){"use strict";const _=e=>d.createProgramDescriptor(e.data,{geometry:[{location:0,name:"a_pos",count:2,type:5122},{location:1,name:"a_id",count:4,type:5121},...e.dotDensity?[]:[{location:2,name:"a_color",count:4,type:5121,normalized:!0},{location:3,name:"a_tlbr",count:4,type:5123},{location:4,name:"a_aux1",count:4,type:5121},{location:5,name:"a_aux2",count:2,type:5123},{location:6,name:"a_aux3",count:4,type:5121}],...e.dotDensity?[{location:2,name:"a_inverseArea",count:1,type:5126}]:[]]});return function(t){function r(){var e;return(e=t.apply(this,arguments)||this)._dotTextureSize=0,e._dotTextures=null,e._dotSamplers=new Int32Array([i.TEXTURE_BINDING_RENDERER_0,i.TEXTURE_BINDING_RENDERER_1]),e}e._inheritsLoose(r,t);var n=r.prototype;return n.dispose=function(){this._disposeTextures()},n.getGeometryType=function(){return u.WGLGeometryType.FILL},n.drawGeometry=function(e,t,o,r){const{context:n,painter:s,rendererInfo:a,requiredLevel:u}=e,d=l.FillMaterialKey.load(o.materialKey),{bufferLayouts:c,attributes:f}=_(d),m=s.materialManager.getMaterialProgram(e,d,"materials/fill",f,r);if(n.bindProgram(m),this._setSharedUniforms(m,e,t),d.textureBinding){s.textureManager.bindTextures(n,m,d);const o=1/2**(u-t.key.level)/e.pixelRatio;m.setUniform1f("u_zoomFactor",o)}if(d.vvColor&&(m.setUniform1fv("u_vvColorValues",a.vvColorValues),m.setUniform4fv("u_vvColors",a.vvColors)),d.vvOpacity&&(m.setUniform1fv("u_vvOpacityValues",a.vvOpacityValues),m.setUniform1fv("u_vvOpacities",a.vvOpacities)),d.dotDensity){const o=i.TILE_SIZE/a.ddDotSize,r=o*window.devicePixelRatio*o*window.devicePixelRatio,s=1/2**(u-t.key.level),l=1/s*(1/s),d=a.ddDotScale?e.state.scale/a.ddDotScale:1;m.setUniform1f("u_tileZoomFactor",s),m.setUniform1f("u_tileDotsOverArea",r/(i.TILE_SIZE*window.devicePixelRatio*i.TILE_SIZE*window.devicePixelRatio)),m.setUniformMatrix4fv("u_dotColors",a.ddColors),m.setUniform4fv("u_isActive",a.ddActiveDots),m.setUniform4fv("u_dotBackgroundColor",a.ddBackgroundColor),m.setUniform1f("u_dotValue",Math.max(1,a.ddDotValue*d*l)),this._bindDotDensityTextures(n,m,a,o)}o.draw(n,c,f)},n._disposeTextures=function(){if(this._dotTextures){for(let e=0;e<this._dotTextures.length;e++)this._dotTextures[e].dispose();this._dotTextures=null}},n._bindDotDensityTextures=function(e,t,o,i){const r=this._createDotDensityTextures(e,i,o.ddSeed);t.setUniform1iv("u_dotTextures",this._dotSamplers);for(let n=0;n<r.length;n++)e.bindTexture(r[n],this._dotSamplers[n])},n._createDotDensityTextures=function(e,t,i){if(this._dotTextureSize===t&&this._seed===i||(this._disposeTextures(),this._dotTextureSize=t,this._seed=i),null===this._dotTextures){const r=new o(i);this._dotTextures=[this._allocDotDensityTexture(e,t,r),this._allocDotDensityTexture(e,t,r)]}return this._dotTextures},n._allocDotDensityTexture=function(e,t,o){const i=new Float32Array(t*t*4);for(let r=0;r<i.length;r++)i[r]=o.getFloat();return new s(e,{wrapMode:10497,pixelFormat:6408,dataType:5126,samplingMode:9728,width:t,height:t},i)},r}(c)}));
