/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/has","../../../../../core/RandomLCG","../definitions","../../../../../chunks/builtins","../../../../webgl/Texture","../../../../webgl/FramebufferObject","../../../../webgl/RenderingContext","../enums","../materialKey/MaterialKey","../Utils","./WGLGeometryBrush"],(function(e,t,o,i,r,n,s,a,l,u,d,c){"use strict";return function(t){function r(){var e;return(e=t.apply(this,arguments)||this)._dotTextureSize=0,e._dotTextures=null,e._dotSamplers=new Int32Array([i.TEXTURE_BINDING_RENDERER_0,i.TEXTURE_BINDING_RENDERER_1]),e}e._inheritsLoose(r,t);var s=r.prototype;return s.dispose=function(){this._disposeTextures()},s.getGeometryType=function(){return l.WGLGeometryType.FILL},s.drawGeometry=function(e,t,o,r,n){const{context:s,painter:a,rendererInfo:l,requiredLevel:c}=e,{indexCount:_,indexFrom:f,materialKey:m}=o,x=u.FillMaterialKey.load(m),{bufferLayouts:v,attributes:y}=(e=>d.createProgramDescriptor(e.data,{geometry:[{location:0,name:"a_pos",count:2,type:5122},{location:1,name:"a_id",count:4,type:5121},...e.dotDensity?[]:[{location:2,name:"a_color",count:4,type:5121,normalized:!0},{location:3,name:"a_tlbr",count:4,type:5123},{location:4,name:"a_aux1",count:4,type:5121},{location:5,name:"a_aux2",count:2,type:5123},{location:6,name:"a_aux3",count:4,type:5121}],...e.dotDensity?[{location:2,name:"a_inverseArea",count:1,type:5126}]:[]]}))(x),p=a.materialManager.getMaterialProgram(e,x,"materials/fill",y,n),h=this._getVAO(s,v,y,r);if(s.bindProgram(p),s.bindVAO(h),this._setSharedUniforms(p,e,t),x.textureBinding){a.textureManager.bindTextures(s,p,x);const o=1/Math.pow(2,c-t.key.level)/e.pixelRatio;p.setUniform1f("u_zoomFactor",o)}if(x.vvColor&&(p.setUniform1fv("u_vvColorValues",l.vvColorValues),p.setUniform4fv("u_vvColors",l.vvColors)),x.vvOpacity&&(p.setUniform1fv("u_vvOpacityValues",l.vvOpacityValues),p.setUniform1fv("u_vvOpacities",l.vvOpacities)),x.dotDensity){const o=i.TILE_SIZE/l.ddDotSize,r=o*window.devicePixelRatio*o*window.devicePixelRatio,n=1/Math.pow(2,c-t.key.level),a=1/n*(1/n),u=l.ddDotScale?e.state.scale/l.ddDotScale:1;p.setUniform1f("u_tileZoomFactor",n),p.setUniform1f("u_tileDotsOverArea",r/(i.TILE_SIZE*window.devicePixelRatio*i.TILE_SIZE*window.devicePixelRatio)),p.setUniformMatrix4fv("u_dotColors",l.ddColors),p.setUniform4fv("u_isActive",l.ddActiveDots),p.setUniform4fv("u_dotBackgroundColor",l.ddBackgroundColor),p.setUniform1f("u_dotValue",Math.max(1,l.ddDotValue*u*a)),this._bindDotDensityTextures(s,p,l,o)}s.drawElements(4,_,5125,Uint32Array.BYTES_PER_ELEMENT*f),s.bindVAO(null)},s._disposeTextures=function(){if(this._dotTextures){for(let e=0;e<this._dotTextures.length;e++)this._dotTextures[e].dispose();this._dotTextures=null}},s._bindDotDensityTextures=function(e,t,o,i){const r=this._createDotDensityTextures(e,i,o.ddSeed);t.setUniform1iv("u_dotTextures",this._dotSamplers);for(let t=0;t<r.length;t++)e.bindTexture(r[t],this._dotSamplers[t])},s._createDotDensityTextures=function(e,t,i){if(this._dotTextureSize===t&&this._seed===i||(this._disposeTextures(),this._dotTextureSize=t,this._seed=i),null===this._dotTextures){const r=new o(i);this._dotTextures=[this._allocDotDensityTexture(e,t,r),this._allocDotDensityTexture(e,t,r)]}return this._dotTextures},s._allocDotDensityTexture=function(e,t,o){const i=new Float32Array(t*t*4);for(let e=0;e<i.length;e++)i[e]=o.getFloat();return new n(e,{wrapMode:10497,pixelFormat:6408,dataType:5126,samplingMode:9728,width:t,height:t},i)},r}(c)}));
