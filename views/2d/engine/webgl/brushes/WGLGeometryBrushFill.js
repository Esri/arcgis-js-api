/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/RandomLCG","../../../../webgl/BufferObject","../../../../webgl/FramebufferObject","../../../../../core/has","../../../../webgl/checkWebGLError","../../../../webgl/enums","../../../../../chunks/builtins","../../../../webgl/Texture","../../../../webgl/VertexArrayObject","../definitions","../enums","../Utils","./WGLGeometryBrush","../materialKey/MaterialKey"],(function(e,t,o,i,r,n,s,a,u,l,d,c,_,m,f){"use strict";const y=e=>{const t={geometry:[{location:0,name:"a_pos",count:2,type:5122},{location:1,name:"a_id",count:3,type:5121},{location:2,name:"a_bitset",count:1,type:5121}]};return e.dotDensity?(t.geometry.push({location:3,name:"a_inverseArea",count:1,type:5126}),_.createProgramDescriptor(e.data,t)):(t.geometry.push({location:3,name:"a_color",count:4,type:5121,normalized:!0}),e.simple||t.geometry.push({location:4,name:"a_aux1",count:4,type:5123}),t.geometry.push({location:5,name:"a_aux2",count:4,type:5121},{location:6,name:"a_aux3",count:4,type:5121}),e.simple||t.geometry.push({location:7,name:"a_zoomRange",count:2,type:5123}),_.createProgramDescriptor(e.data,t))};let h=function(o){function i(){var e;return(e=o.apply(this,arguments)||this)._dotTextureSize=0,e._dotTextures=null,e._dotSamplers=new Int32Array([d.TEXTURE_BINDING_RENDERER_0,d.TEXTURE_BINDING_RENDERER_1]),e}e._inheritsLoose(i,o);var r=i.prototype;return r.dispose=function(){this._disposeTextures()},r.getGeometryType=function(){return c.WGLGeometryType.FILL},r.drawGeometry=function(e,t,o,i){const{context:r,painter:n,rendererInfo:s,requiredLevel:a}=e,u=f.FillMaterialKey.load(o.materialKey),{bufferLayouts:l,attributes:c}=y(u),_=n.materialManager.getMaterialProgram(e,u,"materials/fill",c,i);if(r.useProgram(_),this._setSharedUniforms(_,e,t),_.setUniform2f("u_tileOffset",512*t.key.col,512*t.key.row),u.textureBinding){n.textureManager.bindTextures(r,_,u);const o=1/2**(a-t.key.level)/e.pixelRatio;_.setUniform1f("u_zoomFactor",o)}const m=1/e.pixelRatio;if(_.setUniform1f("u_blur",m),_.setUniform1f("u_antialiasing",m),this._setSizeVVUniforms(u,_,s,t),this._setColorAndOpacityVVUniforms(u,_,s),u.dotDensity){const o=d.TILE_SIZE/s.ddDotSize,i=o*window.devicePixelRatio*o*window.devicePixelRatio,n=1/2**(a-t.key.level),u=1/n*(1/n),l=s.ddDotScale?e.state.scale/s.ddDotScale:1;_.setUniform1f("u_tileZoomFactor",n),_.setUniform1f("u_tileDotsOverArea",i/(d.TILE_SIZE*window.devicePixelRatio*d.TILE_SIZE*window.devicePixelRatio)),_.setUniformMatrix4fv("u_dotColors",s.ddColors),_.setUniform4fv("u_isActive",s.ddActiveDots),_.setUniform4fv("u_dotBackgroundColor",s.ddBackgroundColor),_.setUniform1f("u_dotValue",Math.max(1,s.ddDotValue*l*u)),this._bindDotDensityTextures(r,_,s,o)}o.draw(r,l,c)},r._disposeTextures=function(){if(this._dotTextures){for(let e=0;e<this._dotTextures.length;e++)this._dotTextures[e].dispose();this._dotTextures=null}},r._bindDotDensityTextures=function(e,t,o,i){const r=this._createDotDensityTextures(e,i,o.ddSeed);t.setUniform1iv("u_dotTextures",this._dotSamplers);for(let n=0;n<r.length;n++)e.bindTexture(r[n],this._dotSamplers[n])},r._createDotDensityTextures=function(e,o,i){if(this._dotTextureSize===o&&this._seed===i||(this._disposeTextures(),this._dotTextureSize=o,this._seed=i),null===this._dotTextures){const r=new t(i);this._dotTextures=[this._allocDotDensityTexture(e,o,r),this._allocDotDensityTexture(e,o,r)]}return this._dotTextures},r._allocDotDensityTexture=function(e,t,o){const i=new Float32Array(t*t*4);for(let r=0;r<i.length;r++)i[r]=o.getFloat();return new u(e,{wrapMode:10497,pixelFormat:6408,dataType:5126,samplingMode:9728,width:t,height:t},i)},i}(m);return h}));
