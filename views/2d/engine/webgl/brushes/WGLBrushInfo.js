/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/vec4f32","../DefaultVertexAttributeLayouts","./WGLBrush","../shaders/BackgroundPrograms","../shaders/TileInfoPrograms","../../../../webgl/BufferObject","../../../../webgl/enums","../../../../webgl/ProgramTemplate","../../../../webgl/Texture","../../../../webgl/VertexArrayObject"],(function(e,t,r,i,n,o,s,a,l,u,c){"use strict";const _=300,f=32;let g=function(i){function g(){var e;return(e=i.apply(this,arguments)||this)._color=t.fromValues(1,0,0,1),e}e._inheritsLoose(g,i);var h=g.prototype;return h.dispose=function(){this._outlineProgram&&(this._outlineProgram.dispose(),this._outlineProgram=null),this._tileInfoProgram&&(this._tileInfoProgram.dispose(),this._tileInfoProgram=null),this._outlineVertexArrayObject&&(this._outlineVertexArrayObject.dispose(),this._outlineVertexArrayObject=null),this._tileInfoVertexArrayObject&&(this._tileInfoVertexArrayObject.dispose(),this._tileInfoVertexArrayObject=null),this._canvas=null},h.prepareState=function({context:e}){e.setBlendingEnabled(!0),e.setBlendFunctionSeparate(a.BlendFactor.ONE,a.BlendFactor.ONE_MINUS_SRC_ALPHA,a.BlendFactor.ONE,a.BlendFactor.ONE_MINUS_SRC_ALPHA),e.setColorMask(!0,!0,!0,!0),e.setStencilWriteMask(0),e.setStencilTestEnabled(!1)},h.draw=function(e,t){const{context:r}=e;if(!t.isReady)return;this._loadWGLResources(r),r.bindVAO(this._outlineVertexArrayObject),r.useProgram(this._outlineProgram),this._outlineProgram.setUniformMatrix3fv("u_dvsMat3",t.transforms.dvs),this._outlineProgram.setUniform2f("u_coord_range",t.rangeX,t.rangeY),this._outlineProgram.setUniform1f("u_depth",0),this._outlineProgram.setUniform4fv("u_color",this._color),r.drawArrays(a.PrimitiveType.LINE_STRIP,0,4);const i=this._getTexture(r,t);i?(r.bindVAO(this._tileInfoVertexArrayObject),r.useProgram(this._tileInfoProgram),r.bindTexture(i,0),this._tileInfoProgram.setUniformMatrix3fv("u_dvsMat3",t.transforms.dvs),this._tileInfoProgram.setUniform1f("u_depth",0),this._tileInfoProgram.setUniform2f("u_coord_ratio",t.rangeX/t.width,t.rangeY/t.height),this._tileInfoProgram.setUniform2f("u_delta",8,8),this._tileInfoProgram.setUniform2f("u_dimensions",i.descriptor.width,i.descriptor.height),r.drawArrays(a.PrimitiveType.TRIANGLE_STRIP,0,4),r.bindVAO()):r.bindVAO()},h._loadWGLResources=function(e){if(this._outlineProgram&&this._tileInfoProgram)return;const t=l.createProgram(e,n.background),i=l.createProgram(e,o.tileInfo),u=new Int8Array([0,0,1,0,1,1,0,1]),_=s.BufferObject.createVertex(e,a.Usage.STATIC_DRAW,u),f=new c.VertexArrayObject(e,n.background.attributes,r.Pos2b,{geometry:_}),g=new Int8Array([0,0,1,0,0,1,1,1]),h=s.BufferObject.createVertex(e,a.Usage.STATIC_DRAW,g),d=new c.VertexArrayObject(e,o.tileInfo.attributes,r.Pos2b,{geometry:h});this._outlineProgram=t,this._tileInfoProgram=i,this._outlineVertexArrayObject=f,this._tileInfoVertexArrayObject=d},h._getTexture=function(e,t){if(t.texture&&t.triangleCountReportedInDebug===t.triangleCount)return t.texture;t.triangleCountReportedInDebug=t.triangleCount,this._canvas||(this._canvas=document.createElement("canvas"),this._canvas.setAttribute("id","canvas2d"),this._canvas.setAttribute("width",`${_}`),this._canvas.setAttribute("height",`${f}`),this._canvas.setAttribute("style","display:none"));const r=t.triangleCount;let i=t.key.id;t.triangleCount>0&&(i+=`, ${r}`);const n=this._canvas,o=n.getContext("2d");return o.font="24px sans-serif",o.textAlign="left",o.textBaseline="top",o.clearRect(0,0,_,f),r>1e5?(o.fillStyle="red",o.fillRect(0,0,_,f),o.fillStyle="black"):(o.clearRect(0,0,_,f),o.fillStyle="blue"),o.fillText(i,0,0),t.texture=new u.Texture(e,{target:a.TextureType.TEXTURE_2D,pixelFormat:a.PixelFormat.RGBA,dataType:a.PixelType.UNSIGNED_BYTE,samplingMode:a.TextureSamplingMode.NEAREST,wrapMode:a.TextureWrapMode.CLAMP_TO_EDGE},n),t.texture},g}(i);return g}));
