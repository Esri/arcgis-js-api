/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["../../../../../../chunks/_rollupPluginBabelHelpers","../../../RasterBitmap","../../VertexStream","../WGLBrush","../../../../../webgl/rasterUtils"],(function(t,e,r,s,i){"use strict";let n=function(s){function n(){var t;return(t=s.apply(this,arguments)||this)._desc={lut:{vsPath:"raster/lut",fsPath:"raster/lut",attributes:new Map([["a_position",0],["a_texcoord",1]])},stretch:{vsPath:"raster/stretch",fsPath:"raster/stretch",attributes:new Map([["a_position",0],["a_texcoord",1]])},hillshade:{vsPath:"raster/hillshade",fsPath:"raster/hillshade",attributes:new Map([["a_position",0],["a_texcoord",1]])}},t._rendererUniformInfos=new Map,t}t._inheritsLoose(n,s);var o=n.prototype;return o.dispose=function(){this._quad&&this._quad.dispose()},o.prepareState=function({context:t},e){t.setBlendingEnabled(!0),t.setBlendFunctionSeparate(1,771,1,771),t.setColorMask(!0,!0,!0,!0),t.setStencilWriteMask(0),t.setStencilTestEnabled(!0),t.setStencilFunction(514,e.stencilRef,255)},o.draw=function(t,r){var s;if(!e.hasSource(r)||r.suspended)return;t.timeline.begin(this.name);const i=!(null!=(s=t.context.capabilities.textureFloat)&&s.textureFloatLinear);r.updateTexture(t);const n=this.getShaderVariations(r,i),o=t.painter.materialManager.getProgram(t,this._desc[r.symbolizerParameters.type],n);this.drawWithProgram(t.context,o,r),t.timeline.end(this.name)},o.drawWithProgram=function(t,e,s,n=1,o=[0,0],a=!1){this._quad||(this._quad=new r(t,[0,0,1,0,0,1,1,1]));const{symbolizerParameters:c,transformGrid:h,width:l,height:u,opacity:d}=s,f=c.type;t.useProgram(e);const p=this.getShaderVariations(s),m=this.getUniformInfos(f,t,e,p),{names:g,textures:_}=s.getTextures();i.setTextures(t,e,g,_);const b=i.getBasicGridUniforms(n,o),U=i.getCommonUniforms(h,[l,u],[s.source.width,s.source.height],d,a);if(i.setUniforms(e,m,{u_coordScale:s.coordScale,u_dvsMat3:s.transforms.dvs,...b,...U}),c.colormap){const{colormap:t,colormapOffset:r}=c,s=i.getColormapUniforms(t,r);i.setUniforms(e,m,s)}if("stretch"===c.type){const t=i.getStretchUniforms(c);i.setUniforms(e,m,t)}else if("hillshade"===c.type){const t=i.getShadedReliefUniforms(c);i.setUniforms(e,m,t)}this._quad.draw()},o.getUniformInfos=function(t,e,r,s){const n=s.length>0?t+"-"+s.join("-"):t;if(this._rendererUniformInfos.has(n))return this._rendererUniformInfos.get(n);const o=i.getUniformLocationInfos(e,r);return this._rendererUniformInfos.set(n,o),o},o.getShaderVariations=function(t,e=!1){const r=[],{interpolation:s}=t,{type:i,colormap:n}=t.symbolizerParameters;return"cubic"===s?r.push("bicubic"):"bilinear"===s&&"stretch"===i&&null!=n?(r.push("bilinear"),r.push("nnedge")):e&&"bilinear"===s&&r.push("bilinear"),t.isRendereredSource?r.push("noop"):n&&r.push("applyColormap"),t.transformGrid&&r.push("applyProjection"),r},n}(s);return n}));
