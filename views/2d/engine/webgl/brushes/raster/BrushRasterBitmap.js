/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["../../../../../../chunks/_rollupPluginBabelHelpers","../../VertexStream","../WGLBrush","../../../../../webgl/rasterUtils"],(function(t,e,r,s){"use strict";return function(r){function i(){var t;return(t=r.apply(this,arguments)||this)._desc={lut:{vsPath:"raster/lut",fsPath:"raster/lut",attributes:new Map([["a_position",0],["a_texcoord",1]])},stretch:{vsPath:"raster/stretch",fsPath:"raster/stretch",attributes:new Map([["a_position",0],["a_texcoord",1]])},hillshade:{vsPath:"raster/hillshade",fsPath:"raster/hillshade",attributes:new Map([["a_position",0],["a_texcoord",1]])}},t._rendererUniformInfos=new Map,t}t._inheritsLoose(i,r);var n=i.prototype;return n.dispose=function(){this._quad&&this._quad.dispose()},n.prepareState=function({context:t},e){t.setBlendingEnabled(!0),t.setBlendFunctionSeparate(1,771,1,771),t.setColorMask(!0,!0,!0,!0),t.setStencilWriteMask(0),t.setStencilTestEnabled(!0),t.setStencilFunction(514,e.stencilRef,255)},n.draw=function(t,e){var r;if(!e.source)return;if(e.suspended)return;t.timeline.begin(this.name);const s=!(null!=(r=t.context.capabilities.textureFloat)&&r.textureFloatLinear);e.updateTexture(t);const i=this.getShaderVariations(e,s),n=t.painter.materialManager.getProgram(t,this._desc[e.symbolizerParameters.type],i);this.drawWithProgram(t.context,n,e),t.timeline.end(this.name)},n.drawWithProgram=function(t,r,i,n=1,o=[0,0],a=!1){this._quad||(this._quad=new e(t,[0,0,1,0,0,1,1,1]));const{symbolizerParameters:c,transformGrid:h,width:u,height:l,opacity:d}=i,f=c.type;t.useProgram(r);const p=this.getShaderVariations(i),m=this.getUniformInfos(f,t,r,p),{names:g,textures:_}=i.getTextures();s.setTextures(t,r,g,_);const b=s.getBasicGridUniforms(n,o),U=s.getCommonUniforms(h,[u,l],[i.source.width,i.source.height],d,a);if(s.setUniforms(r,m,{u_coordScale:i.coordScale,u_dvsMat3:i.transforms.dvs,...b,...U}),c.colormap){const{colormap:t,colormapOffset:e}=c,i=s.getColormapUniforms(t,e);s.setUniforms(r,m,i)}if("stretch"===c.type){const t=s.getStretchUniforms(c);s.setUniforms(r,m,t)}else if("hillshade"===c.type){const t=s.getShadedReliefUniforms(c);s.setUniforms(r,m,t)}this._quad.draw()},n.getUniformInfos=function(t,e,r,i){const n=i.length>0?t+"-"+i.join("-"):t;if(this._rendererUniformInfos.has(n))return this._rendererUniformInfos.get(n);const o=s.getUniformLocationInfos(e,r);return this._rendererUniformInfos.set(n,o),o},n.getShaderVariations=function(t,e=!1){const r=[];return"cubic"===t.interpolation?r.push("bicubic"):e&&"bilinear"===t.interpolation&&r.push("bilinear"),t.isRendereredSource?r.push("noop"):t.symbolizerParameters.colormap&&r.push("applyColormap"),t.transformGrid&&r.push("applyProjection"),r},i}(r)}));
