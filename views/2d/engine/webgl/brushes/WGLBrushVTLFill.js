// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../../core/maybe","../../../../../core/libs/gl-matrix-2/mat3f32","../../../../../core/libs/gl-matrix-2/vec4f32","../definitions","../enums","../number","./WGLBrush"],(function(t,e,r,i,a,o,l,n,s,u){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.WGLBrushVTLFill=void 0;var f=[1,1,1,1],_=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._color=o.vec4f32.create(),e._outlineColor=o.vec4f32.create(),e._fillProgramOptions={id:!1,dd:!1,pattern:!1},e._outlineProgramOptions={id:!1,dd:!1},e._patternMatrix=a.mat3f32.create(),e}return r.__extends(e,t),e.prototype.dispose=function(){},e.prototype.drawMany=function(t,e){var r=t.displayLevel,i=t.drawPhase,a=t.renderPass,o=t.styleLayerId,l=t.styleLayer,u=l.getPaintValue("fill-pattern",r),_=l.hasDataDrivenColor?f:l.getPaintValue("fill-color",r),d=l.hasDataDrivenOpacity?1:l.getPaintValue("fill-opacity",r),v=d*_[3],h=void 0!==u||v<1||l.hasDataDrivenFill;if(!h||"opaque"!==a){var c;this._color[0]=v*_[0],this._color[1]=v*_[1],this._color[2]=v*_[2],this._color[3]=v,i===n.WGLDrawPhase.HITTEST&&(c=s.u32to4Xu8(o+1));var p=l.getPaintValue("fill-translate",r),m=l.getPaintValue("fill-translate-anchor",r);this._drawFill(t,o,l,e,p,m,u,h,c),this._drawOutline(t,o,l,e,p,m,u,c,d)}},e.prototype._drawFill=function(t,e,r,a,o,s,u,f,_){var d=t.context,v=t.displayLevel,h=t.drawPhase,c=t.pixelRatio,p=t.renderPass,m=t.spriteMosaic,g=t.state;if(f||"translucent"!==p){var P,y=void 0!==u,T=c>l.VTL_HIGH_RES_CUTOFF?2:1,x=r.hasDataDrivenFill,M=t.painter.getVectorTileProgramCach(),U=h===n.WGLDrawPhase.HITTEST,C=(U?1:0)<<2|(x?1:0)<<1|(y?1:0),D=this._fillProgramOptions;D.id=U,D.dd=x,D.pattern=y;var E=M.getProgram(1,C,D);if(d.bindProgram(E),y){if(!(P=m.getMosaicItemPosition(u,!0)))return void d.bindProgram();E.setUniform2f("u_pattern_tl",P.tl[0],P.tl[1]),E.setUniform2f("u_pattern_br",P.br[0],P.br[1]),E.setUniform1i("u_texture",l.VTL_TEXTURE_BINDING_UNIT_SPRITES),m.bind(d,9729,P.page,l.VTL_TEXTURE_BINDING_UNIT_SPRITES)}E.setUniformMatrix3fv("u_displayMat3",1===s?g.displayMat3:g.displayViewMat3),E.setUniform2fv("u_fillTranslation",o),E.setUniform1f("u_depth",r.z+1/65536),E.setUniform4fv("u_color",this._color),U&&E.setUniform4fv("u_id",_);for(var I=0,V=a;I<V.length;I++){var L=V[I];if(L.layerData[e]){var b=L.layerData[e];b.prepareForRendering(d,M);var w=b.fillVertexArrayObject;if(!i.isNone(w)){if(d.bindVAO(w),E.setUniformMatrix3fv("u_dvsMat3",L.transforms.dvs),y){var O=Math.max(Math.pow(2,Math.round(v)-L.key.level),1),R=L.coordRange[0]/(T*L.size[0]*O),S=1/(P.size[0]*R),F=1/(P.size[1]*R);this._patternMatrix[0]=S,this._patternMatrix[4]=F,E.setUniformMatrix3fv("u_pattern_matrix",this._patternMatrix)}d.setStencilFunction(514,L.stencilRef,255),d.drawElements(4,b.fillIndexCount,5125,Uint32Array.BYTES_PER_ELEMENT*b.fillIndexStart),L.triangleCount+=b.fillIndexCount/3}}}}},e.prototype._drawOutline=function(t,e,r,a,o,l,s,u,_){var d=t.context,v=t.displayLevel,h=t.drawPhase,c=t.renderPass,p=t.pixelRatio,m=t.state;if("opaque"!==c){var g=void 0!==s;if(r.getPaintValue("fill-antialias",v)&&!g||r.hasDataDrivenOutlineColor){var P=t.painter.getVectorTileProgramCach(),y=r.hasDataDrivenOutline;if(r.outlineUsesFillColor){if(1!==this._color[3])return;this._outlineColor[0]=this._color[0],this._outlineColor[1]=this._color[1],this._outlineColor[2]=this._color[2],this._outlineColor[3]=this._color[3]}else{var T=r.hasDataDrivenOutlineColor?f:r.getPaintValue("fill-outline-color",v),x=_*T[3];this._outlineColor[0]=x*T[0],this._outlineColor[1]=x*T[1],this._outlineColor[2]=x*T[2],this._outlineColor[3]=x}var M=.75/p,U=h===n.WGLDrawPhase.HITTEST,C=(U?1:0)<<1|(y?1:0),D=this._outlineProgramOptions;D.id=U,D.dd=y;var E=P.getProgram(2,C,D);d.bindProgram(E),E.setUniformMatrix3fv("u_displayMat3",1===l?m.displayMat3:m.displayViewMat3),E.setUniform2fv("u_fillTranslation",o),E.setUniform1f("u_depth",r.z+1/65536),E.setUniform1f("u_outline_width",M),E.setUniform4fv("u_color",this._outlineColor),U&&E.setUniform4fv("u_id",u);for(var I=0,V=a;I<V.length;I++){var L=V[I];if(L.layerData[e]){var b=L.layerData[e];b.prepareForRendering(d,P);var w=b.outlineVertexArrayObject;i.isNone(w)||(d.bindVAO(w),E.setUniformMatrix3fv("u_dvsMat3",L.transforms.dvs),d.setStencilFunction(514,L.stencilRef,255),d.drawElements(4,b.outlineIndexCount,5125,Uint32Array.BYTES_PER_ELEMENT*b.outlineIndexStart),L.triangleCount+=b.outlineIndexCount/3)}}}}},e}(u.default);e.WGLBrushVTLFill=_}));