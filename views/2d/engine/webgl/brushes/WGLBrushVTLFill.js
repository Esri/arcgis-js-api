/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/maybe","../definitions","../../../../../chunks/mat3f32","../number","../enums","./WGLBrush"],(function(t,e,i,a,n,r,l,o){"use strict";const s=1/65536;let f=function(t){function o(){var e;return(e=t.apply(this,arguments)||this)._fillProgramOptions={id:!1,pattern:!1},e._outlineProgramOptions={id:!1},e._patternMatrix=n.create(),e}e._inheritsLoose(o,t);var f=o.prototype;return f.dispose=function(){},f.drawMany=function(t,e){const{displayLevel:i,drawPhase:a,renderPass:n,styleLayerUID:o}=t,s=t.styleLayer,f=s.getPaintValue("fill-pattern",i),u=void 0!==f,d=!u&&s.getPaintValue("fill-antialias",i);let c=!0,p=1;if(!u){const t=s.getPaintProperty("fill-color"),e=s.getPaintProperty("fill-opacity");if(!(null!=t&&t.isDataDriven||null!=e&&e.isDataDriven)){const t=s.getPaintValue("fill-color",i);p=s.getPaintValue("fill-opacity",i)*t[3],p>=1&&(c=!1)}}if(c&&"opaque"===n)return;let _;a===l.WGLDrawPhase.HITTEST&&(_=r.u32to4Xu8(o+1));const m=s.getPaintValue("fill-translate",i),y=s.getPaintValue("fill-translate-anchor",i);(c||"translucent"!==n)&&this._drawFill(t,o,s,e,m,y,f,_);const M=!s.hasDataDrivenOutlineColor&&s.outlineUsesFillColor&&p<1;d&&"opaque"!==n&&!M&&this._drawOutline(t,o,s,e,m,y,_)},f._drawFill=function(t,e,n,r,o,f,u,d){const{context:c,displayLevel:p,state:_,drawPhase:m,painter:y,pixelRatio:M,spriteMosaic:P}=t,v=n.fillMaterial,g=y.vectorTilesMaterialManager,T=void 0!==u,h=M>a.VTL_HIGH_RES_CUTOFF?2:1;let U;const x=m===l.WGLDrawPhase.HITTEST,E=this._fillProgramOptions;E.id=x,E.pattern=T;const I=g.getMaterialProgram(c,v,E);if(c.bindProgram(I),T){if(U=P.getMosaicItemPosition(u,!0),!U)return void c.bindProgram();I.setUniform2f("u_pattern_tl",U.tl[0],U.tl[1]),I.setUniform2f("u_pattern_br",U.br[0],U.br[1]),I.setUniform1i("u_texture",a.VTL_TEXTURE_BINDING_UNIT_SPRITES),P.bind(c,9729,U.page,a.VTL_TEXTURE_BINDING_UNIT_SPRITES)}I.setUniformMatrix3fv("u_displayMat3",1===f?_.displayMat3:_.displayViewMat3),I.setUniform2fv("u_fillTranslation",o),I.setUniform1f("u_depth",n.z+s),x&&I.setUniform4fv("u_id",d);let D=-1;for(const a of r){if(!a.layerData.has(e))continue;a.key.level!==D&&(D=a.key.level,v.setDataUniforms(I,p,n,D));const t=a.layerData.get(e);t.prepareForRendering(c);const r=t.fillVertexArrayObject;if(!i.isNone(r)){if(c.bindVAO(r),I.setUniformMatrix3fv("u_dvsMat3",a.transforms.dvs),T){const t=Math.max(2**(Math.round(p)-a.key.level),1),e=a.coordRange[0]/(h*a.size[0]*t),i=1/(U.size[0]*e),n=1/(U.size[1]*e);this._patternMatrix[0]=i,this._patternMatrix[4]=n,I.setUniformMatrix3fv("u_pattern_matrix",this._patternMatrix)}c.setStencilFunction(514,a.stencilRef,255),c.drawElements(4,t.fillIndexCount,5125,Uint32Array.BYTES_PER_ELEMENT*t.fillIndexStart),a.triangleCount+=t.fillIndexCount/3}}},f._drawOutline=function(t,e,a,n,r,o,f){const{context:u,displayLevel:d,state:c,drawPhase:p,painter:_,pixelRatio:m}=t,y=a.outlineMaterial,M=_.vectorTilesMaterialManager,P=.75/m,v=p===l.WGLDrawPhase.HITTEST,g=this._outlineProgramOptions;g.id=v;const T=M.getMaterialProgram(u,y,g);u.bindProgram(T),T.setUniformMatrix3fv("u_displayMat3",1===o?c.displayMat3:c.displayViewMat3),T.setUniform2fv("u_fillTranslation",r),T.setUniform1f("u_depth",a.z+s),T.setUniform1f("u_outline_width",P),v&&T.setUniform4fv("u_id",f);let h=-1;for(const l of n){if(!l.layerData.has(e))continue;l.key.level!==h&&(h=l.key.level,y.setDataUniforms(T,d,a,h));const t=l.layerData.get(e);t.prepareForRendering(u);const n=t.outlineVertexArrayObject;i.isNone(n)||(u.bindVAO(n),T.setUniformMatrix3fv("u_dvsMat3",l.transforms.dvs),u.setStencilFunction(514,l.stencilRef,255),u.drawElements(4,t.outlineIndexCount,5125,Uint32Array.BYTES_PER_ELEMENT*t.outlineIndexStart),l.triangleCount+=t.outlineIndexCount/3)}},o}(o);t.WGLBrushVTLFill=f,Object.defineProperty(t,"__esModule",{value:!0})}));
