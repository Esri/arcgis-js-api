/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/maybe","../../vectorTiles/style/StyleDefinition","../definitions","../enums","../number","./WGLBrush","../../../../webgl/enums"],(function(e,t,i,n,a,r,o,l,s){"use strict";const u=1/65536;let f=function(e){function l(){var t;return(t=e.apply(this,arguments)||this)._fillProgramOptions={id:!1,pattern:!1},t._outlineProgramOptions={id:!1},t}t._inheritsLoose(l,e);var f=l.prototype;return f.dispose=function(){},f.drawMany=function(e,t){const{displayLevel:i,drawPhase:n,renderPass:a,spriteMosaic:l,styleLayerUID:s}=e;let u=!1;for(const r of t)if(r.layerData.has(s)){const e=r.layerData.get(s);if(e.fillIndexCount>0||e.outlineIndexCount>0){u=!0;break}}if(!u)return;const f=e.styleLayer,c=f.getPaintProperty("fill-pattern"),T=void 0!==c,d=T&&c.isDataDriven;let p;if(T&&!d){const e=c.getValue(i);p=l.getMosaicItemPosition(e,!0)}const _=!T&&f.getPaintValue("fill-antialias",i);let m=!0,y=1;if(!T){const e=f.getPaintProperty("fill-color"),t=f.getPaintProperty("fill-opacity");if(!(null!=e&&e.isDataDriven||null!=t&&t.isDataDriven)){const e=f.getPaintValue("fill-color",i);y=f.getPaintValue("fill-opacity",i)*e[3],y>=1&&(m=!1)}}if(m&&"opaque"===a)return;let E;n===r.WGLDrawPhase.HITTEST&&(E=o.u32to4Xu8(s+1));const I=f.getPaintValue("fill-translate",i),P=f.getPaintValue("fill-translate-anchor",i);(m||"translucent"!==a)&&this._drawFill(e,s,f,t,I,P,T,p,d,E);const g=!f.hasDataDrivenOutlineColor&&f.outlineUsesFillColor&&y<1;_&&"opaque"!==a&&!g&&this._drawOutline(e,s,f,t,I,P,E)},f._drawFill=function(e,t,o,l,f,c,T,d,p,_){if(T&&!p&&i.isNone(d))return;const{context:m,displayLevel:y,state:E,drawPhase:I,painter:P,pixelRatio:g,spriteMosaic:v}=e,S=o.fillMaterial,U=P.vectorTilesMaterialManager,M=g>a.VTL_HIGH_RES_CUTOFF?2:1,N=I===r.WGLDrawPhase.HITTEST,D=this._fillProgramOptions;D.id=N,D.pattern=T;const h=U.getMaterialProgram(m,S,D);if(m.useProgram(h),i.isSome(d)){const{page:e}=d,t=v.getPageSize(e);i.isSome(t)&&(v.bind(m,s.TextureSamplingMode.LINEAR,e,a.VTL_TEXTURE_BINDING_UNIT_SPRITES),h.setUniform2fv("u_mosaicSize",t),h.setUniform1i("u_texture",a.VTL_TEXTURE_BINDING_UNIT_SPRITES))}h.setUniformMatrix3fv("u_displayMat3",c===n.TranslateAnchor.VIEWPORT?E.displayMat3:E.displayViewMat3),h.setUniform2fv("u_fillTranslation",f),h.setUniform1f("u_depth",o.z+u),N&&h.setUniform4fv("u_id",_);let L=-1;for(const n of l){if(!n.layerData.has(t))continue;n.key.level!==L&&(L=n.key.level,S.setDataUniforms(h,y,o,L,v));const e=n.layerData.get(t);if(!e.fillIndexCount)continue;e.prepareForRendering(m);const r=e.fillVertexArrayObject;if(!i.isNone(r)){if(m.bindVAO(r),h.setUniformMatrix3fv("u_dvsMat3",n.transforms.dvs),m.setStencilFunction(s.CompareFunction.EQUAL,n.stencilRef,255),T){const e=Math.max(2**(Math.round(y)-n.key.level),1),t=n.rangeX/(M*n.width*e);h.setUniform1f("u_patternFactor",t)}if(p){const t=e.patternMap;if(!t)continue;for(const[e,n]of t){const t=v.getPageSize(e);i.isSome(t)&&(v.bind(m,s.TextureSamplingMode.LINEAR,e,a.VTL_TEXTURE_BINDING_UNIT_SPRITES),h.setUniform2fv("u_mosaicSize",t),h.setUniform1i("u_texture",a.VTL_TEXTURE_BINDING_UNIT_SPRITES),m.drawElements(s.PrimitiveType.TRIANGLES,n[1],s.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*n[0]))}}else m.drawElements(s.PrimitiveType.TRIANGLES,e.fillIndexCount,s.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*e.fillIndexStart);n.triangleCount+=e.fillIndexCount/3}}},f._drawOutline=function(e,t,a,o,l,f,c){const{context:T,displayLevel:d,state:p,drawPhase:_,painter:m,pixelRatio:y,spriteMosaic:E}=e,I=a.outlineMaterial,P=m.vectorTilesMaterialManager,g=.75/y,v=_===r.WGLDrawPhase.HITTEST,S=this._outlineProgramOptions;S.id=v;const U=P.getMaterialProgram(T,I,S);T.useProgram(U),U.setUniformMatrix3fv("u_displayMat3",f===n.TranslateAnchor.VIEWPORT?p.displayMat3:p.displayViewMat3),U.setUniform2fv("u_fillTranslation",l),U.setUniform1f("u_depth",a.z+u),U.setUniform1f("u_outline_width",g),v&&U.setUniform4fv("u_id",c);let M=-1;for(const n of o){if(!n.layerData.has(t))continue;n.key.level!==M&&(M=n.key.level,I.setDataUniforms(U,d,a,M,E));const e=n.layerData.get(t);if(e.prepareForRendering(T),!e.outlineIndexCount)continue;const r=e.outlineVertexArrayObject;i.isNone(r)||(T.bindVAO(r),U.setUniformMatrix3fv("u_dvsMat3",n.transforms.dvs),T.setStencilFunction(s.CompareFunction.EQUAL,n.stencilRef,255),T.drawElements(s.PrimitiveType.TRIANGLES,e.outlineIndexCount,s.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*e.outlineIndexStart),n.triangleCount+=e.outlineIndexCount/3)}},l}(l);e.WGLBrushVTLFill=f,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
