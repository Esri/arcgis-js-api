/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/maybe","../../../../../core/RandomLCG","../definitions","../enums","./WGLGeometryBrushFill","../techniques/utils","../../../../webgl/BufferObject","../../../../webgl/enums","../../../../webgl/FramebufferObject","../../../../webgl/Renderbuffer","../../../../webgl/Texture","../../../../webgl/VertexArrayObject"],(function(e,t,r,o,i,s,n,a,d,l,u,_,c){"use strict";let T=function(s){function T(){var e;return(e=s.apply(this,arguments)||this)._dotTextureSize=0,e._dotTextures=null,e._dotSamplers=new Int32Array([o.TEXTURE_BINDING_RENDERER_0,o.TEXTURE_BINDING_RENDERER_1]),e._dotVAO=null,e._dotDesc={vsPath:"dot/dot",fsPath:"dot/dot",attributes:new Map([["a_pos",0]])},e}e._inheritsLoose(T,s);var h=T.prototype;return h.dispose=function(){s.prototype.dispose.call(this),this._disposeTextures(),this._dotFBO=t.disposeMaybe(this._dotFBO),this._dotVAO=t.disposeMaybe(this._dotVAO)},h.getGeometryType=function(){return i.WGLGeometryType.FILL},h.supportsSymbology=function(e){return e===i.WGLSymbologyType.DOT_DENSITY},h._drawFills=function(e,r,o,i,n,a){const{passOptions:d}=e;if(t.isSome(d)&&"hittest"===d.type)s.prototype._drawFills.call(this,e,r,o,i,n,a);else{const t=this._drawDotLocations(e,r,o,n,a);this._drawDotDensity(e,r,t)}},h._drawDotDensity=function(e,r,o){const{context:i,painter:s,rendererInfo:a,requestRender:l,allowDelayedRender:u}=e,_=s.materialManager.getProgram(this._dotDesc);if(u&&t.isSome(l)&&!_.compiled)return void l();const{rendererSchema:c}=a;n.assertRendererSchema(c,"dot-density");const T=this._createDotDensityMesh(i,this._dotDesc.attributes,{geometry:[{name:"a_pos",count:2,type:d.DataType.SHORT,divisor:0,normalized:!1,offset:0,stride:4}]});i.setStencilTestEnabled(!0),i.useProgram(_),_.setUniform1f("u_tileZoomFactor",1),_.setUniform1i("u_texture",this._dotSamplers[0]),_.setUniform1f("u_dotSize",Math.max(c.dotSize,1)),_.setUniform1f("u_pixelRatio",window.devicePixelRatio),this._setSharedUniforms(_,e,r),i.bindTexture(o,this._dotSamplers[0]),i.bindVAO(T),i.drawArrays(d.PrimitiveType.POINTS,0,262144)},h._drawDotLocations=function(e,t,r,i,s){const{context:a,rendererInfo:l,requiredLevel:u}=e,_=a.getViewport(),{rendererSchema:c}=l;n.assertRendererSchema(c,"dot-density");const{dotScale:T,colors:h,activeDots:f,backgroundColor:m,dotValue:p}=c;a.setViewport(0,0,512,512);const y=a.getBoundFramebufferObject(),x=this._createFBO(a);a.bindFramebuffer(x),a.setClearColor(0,0,0,0),a.clear(a.gl.COLOR_BUFFER_BIT|a.gl.STENCIL_BUFFER_BIT),a.setStencilTestEnabled(!1);const D=1/2**(u-t.key.level),E=o.TILE_SIZE,w=E*window.devicePixelRatio*E*window.devicePixelRatio,S=1/D*(1/D),g=T?e.state.scale/T:1;return r.setUniform1f("u_tileZoomFactor",D),r.setUniform1f("u_tileDotsOverArea",w/(o.TILE_SIZE*window.devicePixelRatio*o.TILE_SIZE*window.devicePixelRatio)),r.setUniformMatrix4fv("u_dotColors",h),r.setUniform4fv("u_isActive",f),r.setUniform4fv("u_dotBackgroundColor",m),r.setUniform1f("u_dotValue",Math.max(1,p*g*S)),this._bindDotDensityTextures(a,r,l,E),a.drawElements(d.PrimitiveType.TRIANGLES,i,d.DataType.UNSIGNED_INT,s),a.setViewport(_.x,_.y,_.width,_.height),a.bindFramebuffer(y),x.colorTexture},h._createFBO=function(e){if(t.isNone(this._dotFBO)){const t=512,r=512,o={target:d.TextureType.TEXTURE_2D,pixelFormat:d.PixelFormat.RGBA,dataType:d.PixelType.UNSIGNED_BYTE,samplingMode:d.TextureSamplingMode.NEAREST,wrapMode:d.TextureWrapMode.CLAMP_TO_EDGE,width:t,height:r},i={colorTarget:d.TargetType.TEXTURE,depthStencilTarget:d.DepthStencilTargetType.DEPTH_STENCIL_RENDER_BUFFER},s=new u.Renderbuffer(e,{width:t,height:r,internalFormat:d.RenderbufferFormat.DEPTH_STENCIL});this._dotFBO=new l.FramebufferObject(e,i,o,s)}return this._dotFBO},h._disposeTextures=function(){if(this._dotTextures){for(let e=0;e<this._dotTextures.length;e++)this._dotTextures[e].dispose();this._dotTextures=null}},h._bindDotDensityTextures=function(e,t,r,o){const{rendererSchema:i}=r;n.assertRendererSchema(i,"dot-density");const s=this._createDotDensityTextures(e,o,i.seed);t.setUniform1iv("u_dotTextures",this._dotSamplers);for(let n=0;n<s.length;n++)e.bindTexture(s[n],this._dotSamplers[n])},h._createDotDensityMesh=function(e,r,o){if(t.isNone(this._dotVAO)){const t=2,i=new Int16Array(262144*t);for(let e=0;e<512;e++)for(let r=0;r<512;r++)i[t*(r+512*e)]=r,i[t*(r+512*e)+1]=e;const s=a.BufferObject.createVertex(e,d.Usage.STATIC_DRAW,i);this._dotVAO=new c.VertexArrayObject(e,r,o,{geometry:s},null)}return this._dotVAO},h._createDotDensityTextures=function(e,t,o){if(this._dotTextureSize===t&&this._seed===o||(this._disposeTextures(),this._dotTextureSize=t,this._seed=o),null===this._dotTextures){const i=new r(o);this._dotTextures=[this._allocDotDensityTexture(e,t,i),this._allocDotDensityTexture(e,t,i)]}return this._dotTextures},h._allocDotDensityTexture=function(e,t,r){const o=new Float32Array(t*t*4);for(let i=0;i<o.length;i++)o[i]=r.getFloat();return new _.Texture(e,{wrapMode:d.TextureWrapMode.REPEAT,pixelFormat:d.PixelFormat.RGBA,dataType:d.PixelType.FLOAT,samplingMode:d.TextureSamplingMode.NEAREST,width:t,height:t},o)},T}(s);return T}));
