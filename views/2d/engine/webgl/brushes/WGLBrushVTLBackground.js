/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/mathUtils","../../../../../core/maybe","../../../../../chunks/mat3f32","../../../../../chunks/vec4f32","../../../../webgl/BufferObject","../../../../webgl/FramebufferObject","../../../../../core/has","../../../../webgl/checkWebGLError","../../../../webgl/enums","../../../../../chunks/builtins","../../../../webgl/renderState","../../../../webgl/Texture","../../../../webgl/VertexArrayObject","../definitions","../enums","../number","./WGLBrush"],(function(t,e,r,o,i,a,n,s,c,u,l,f,_,h,d,g,m,p,b){"use strict";let v=function(t){function s(){var e;return(e=t.apply(this,arguments)||this)._color=a.fromValues(1,0,0,1),e._patternMatrix=i.create(),e._programOptions={id:!1,pattern:!1},e}e._inheritsLoose(s,t);var c=s.prototype;return c.dispose=function(){this._vao&&(this._vao.dispose(),this._vao=null)},c.drawMany=function(t,e){const{context:i,painter:a,styleLayerUID:n}=t;this._loadWGLResources(t);const s=t.displayLevel,c=t.styleLayer,u=c.backgroundMaterial,l=a.vectorTilesMaterialManager,f=c.getPaintValue("background-color",s),_=c.getPaintValue("background-opacity",s),h=c.getPaintValue("background-pattern",s),d=void 0!==h,b=f[3]*_,v=1|window.devicePixelRatio,w=t.spriteMosaic;let y,T;const x=v>g.VTL_HIGH_RES_CUTOFF?2:1,M=t.drawPhase===m.WGLDrawPhase.HITTEST,L=this._programOptions;L.id=M,L.pattern=d;const U=l.getMaterialProgram(i,u,L);if(i.bindVAO(this._vao),i.useProgram(U),d){const t=w.getMosaicItemPosition(h,!0);if(o.isSome(t)){const{tl:e,br:r,page:a}=t;y=r[0]-e[0],T=r[1]-e[1];const n=w.getPageSize(a);o.isSome(n)&&(w.bind(i,9729,a,g.VTL_TEXTURE_BINDING_UNIT_SPRITES),U.setUniform4f("u_tlbr",e[0],e[1],r[0],r[1]),U.setUniform2fv("u_mosaicSize",n),U.setUniform1i("u_texture",g.VTL_TEXTURE_BINDING_UNIT_SPRITES))}U.setUniform1f("u_opacity",_)}else this._color[0]=b*f[0],this._color[1]=b*f[1],this._color[2]=b*f[2],this._color[3]=b,U.setUniform4fv("u_color",this._color);if(U.setUniform1f("u_depth",c.z||0),M){const t=p.u32to4Xu8(n+1);U.setUniform4fv("u_id",t)}for(const o of e){if(U.setUniform1f("u_coord_range",o.rangeX),U.setUniformMatrix3fv("u_dvsMat3",o.transforms.dvs),d){const t=Math.max(2**(Math.round(s)-o.key.level),1),e=x*o.width*t,i=e/r.nextPowerOfTwo(y),a=e/r.nextPowerOfTwo(T);this._patternMatrix[0]=i,this._patternMatrix[4]=a,U.setUniformMatrix3fv("u_pattern_matrix",this._patternMatrix)}i.setStencilFunction(514,o.stencilRef,255),i.drawArrays(5,0,4)}},c._loadWGLResources=function(t){if(this._vao)return;const{context:e,styleLayer:r}=t,o=r.backgroundMaterial,i=new Int8Array([0,0,1,0,0,1,1,1]),a=n.createVertex(e,35044,i),s=new d(e,o.getAttributeLocations(),o.getLayoutInfo(),{geometry:a});this._vao=s},s}(b);t.WGLBrushVTLBackground=v,Object.defineProperty(t,"__esModule",{value:!0})}));
