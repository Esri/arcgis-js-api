/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/mathUtils","../../../../../core/maybe","../../../../../chunks/mat3f32","../../../../../chunks/vec4f32","../definitions","../enums","../number","./WGLBrush","../../../../webgl/BufferObject","../../../../webgl/enums","../../../../webgl/VertexArrayObject"],(function(e,t,r,o,i,a,n,s,c,u,l,f,_){"use strict";let d=function(e){function u(){var t;return(t=e.apply(this,arguments)||this)._color=a.fromValues(1,0,0,1),t._patternMatrix=i.create(),t._programOptions={id:!1,pattern:!1},t}t._inheritsLoose(u,e);var d=u.prototype;return d.dispose=function(){this._vao&&(this._vao.dispose(),this._vao=null)},d.drawMany=function(e,t){const{context:i,painter:a,styleLayerUID:u,requestRender:l,allowDelayedRender:_}=e;this._loadWGLResources(e);const d=e.displayLevel,m=e.styleLayer,p=m.backgroundMaterial,g=a.vectorTilesMaterialManager,h=m.getPaintValue("background-color",d),T=m.getPaintValue("background-opacity",d),y=m.getPaintValue("background-pattern",d),v=void 0!==y,b=h[3]*T,x=1|window.devicePixelRatio,L=e.spriteMosaic;let M,U;const I=x>n.VTL_HIGH_RES_CUTOFF?2:1,P=e.drawPhase===s.WGLDrawPhase.HITTEST,w=this._programOptions;w.id=P,w.pattern=v;const S=g.getMaterialProgram(i,p,w);if(_&&o.isSome(l)&&!S.compiled)l();else{if(i.bindVAO(this._vao),i.useProgram(S),v){const e=L.getMosaicItemPosition(y,!0);if(o.isSome(e)){const{tl:t,br:r,page:a}=e;M=r[0]-t[0],U=r[1]-t[1];const s=L.getPageSize(a);o.isSome(s)&&(L.bind(i,f.TextureSamplingMode.LINEAR,a,n.VTL_TEXTURE_BINDING_UNIT_SPRITES),S.setUniform4f("u_tlbr",t[0],t[1],r[0],r[1]),S.setUniform2fv("u_mosaicSize",s),S.setUniform1i("u_texture",n.VTL_TEXTURE_BINDING_UNIT_SPRITES))}S.setUniform1f("u_opacity",T)}else this._color[0]=b*h[0],this._color[1]=b*h[1],this._color[2]=b*h[2],this._color[3]=b,S.setUniform4fv("u_color",this._color);if(S.setUniform1f("u_depth",m.z||0),P){const e=c.u32to4Xu8(u+1);S.setUniform4fv("u_id",e)}for(const e of t){if(S.setUniform1f("u_coord_range",e.rangeX),S.setUniformMatrix3fv("u_dvsMat3",e.transforms.dvs),v){const t=Math.max(2**(Math.round(d)-e.key.level),1),o=I*e.width*t,i=o/r.nextPowerOfTwo(M),a=o/r.nextPowerOfTwo(U);this._patternMatrix[0]=i,this._patternMatrix[4]=a,S.setUniformMatrix3fv("u_pattern_matrix",this._patternMatrix)}i.setStencilFunction(f.CompareFunction.EQUAL,0,255),i.drawArrays(f.PrimitiveType.TRIANGLE_STRIP,0,4)}}},d._loadWGLResources=function(e){if(this._vao)return;const{context:t,styleLayer:r}=e,o=r.backgroundMaterial,i=new Int8Array([0,0,1,0,0,1,1,1]),a=l.BufferObject.createVertex(t,f.Usage.STATIC_DRAW,i),n=new _.VertexArrayObject(t,o.getAttributeLocations(),o.getLayoutInfo(),{geometry:a});this._vao=n},u}(u);e.WGLBrushVTLBackground=d,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
