/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/has","../../../../../core/mathUtils","../../../../../chunks/vec4f32","../definitions","../../../../../chunks/mat3f32","../../../../../chunks/builtins","../../../../webgl/BufferObject","../../../../webgl/VertexArrayObject","../../../../webgl/FramebufferObject","../number","../enums","./WGLBrush"],(function(t,e,r,o,i,a,n,s,c,u,l,_,f,d){"use strict";let h=function(t){function r(){var e;return(e=t.apply(this,arguments)||this)._color=i.fromValues(1,0,0,1),e._patternMatrix=n.create(),e._programOptions={id:!1,pattern:!1},e}e._inheritsLoose(r,t);var o=r.prototype;return o.dispose=function(){this._vao&&(this._vao.dispose(),this._vao=null)},o.drawMany=function(t,e){const{context:r,painter:o,styleLayerUID:i}=t;this._loadWGLResources(t);const n=t.displayLevel,s=t.styleLayer,c=s.backgroundMaterial,u=o.vectorTilesMaterialManager,l=s.getPaintValue("background-color",n),d=s.getPaintValue("background-opacity",n),h=s.getPaintValue("background-pattern",n),p=void 0!==h,g=l[3]*d,m=1|window.devicePixelRatio,b=t.spriteMosaic;let v;const y=m>a.VTL_HIGH_RES_CUTOFF?2:1,M=t.drawPhase===f.WGLDrawPhase.HITTEST,T=this._programOptions;T.id=M,T.pattern=p;const U=u.getMaterialProgram(r,c,T);if(r.bindVAO(this._vao),r.bindProgram(U),p){if(v=b.getMosaicItemPosition(h,!0),!v)return;U.setUniform1f("u_opacity",d),U.setUniform2f("u_pattern_tl",v.tl[0],v.tl[1]),U.setUniform2f("u_pattern_br",v.br[0],v.br[1]),U.setUniform1i("u_texture",a.VTL_TEXTURE_BINDING_UNIT_SPRITES),b.bind(r,9729,v.page,a.VTL_TEXTURE_BINDING_UNIT_SPRITES)}else this._color[0]=g*l[0],this._color[1]=g*l[1],this._color[2]=g*l[2],this._color[3]=g,U.setUniform4fv("u_color",this._color);if(U.setUniform1f("u_depth",s.z||0),M){const t=_.u32to4Xu8(i+1);U.setUniform4fv("u_id",t)}for(const a of e){if(U.setUniform1f("u_coord_range",a.coordRange[0]),U.setUniformMatrix3fv("u_dvsMat3",a.transforms.dvs),p){const t=Math.max(2**(Math.round(n)-a.key.level),1),e=y*a.size[0]*t,r=e/v.size[0],o=e/v.size[1];this._patternMatrix[0]=r,this._patternMatrix[4]=o,U.setUniformMatrix3fv("u_pattern_matrix",this._patternMatrix)}r.setStencilFunction(514,a.stencilRef,255),r.drawArrays(5,0,4)}},o._loadWGLResources=function(t){if(this._vao)return;const{context:e,styleLayer:r}=t,o=r.backgroundMaterial,i=new Int8Array([0,0,1,0,0,1,1,1]),a=c.createVertex(e,35044,i),n=new u(e,o.getAttributeLocations(),o.getLayoutInfo(),{geometry:a});this._vao=n},r}(d);t.WGLBrushVTLBackground=h,Object.defineProperty(t,"__esModule",{value:!0})}));
