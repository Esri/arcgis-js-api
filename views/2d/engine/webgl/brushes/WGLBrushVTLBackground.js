/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/mathUtils","../../../../../core/maybe","../../../../../chunks/mat3f32","../../../../../chunks/vec4f32","../../../../webgl/BufferObject","../../../../webgl/FramebufferObject","../../../../../core/has","../../../../webgl/enums","../../../../webgl/RenderingContext","../../../../../chunks/builtins","../../../../webgl/Texture","../../../../webgl/VertexArrayObject","../definitions","../enums","../number","./WGLBrush"],(function(t,e,r,o,i,n,a,s,c,u,l,f,_,d,g,h,m,p){"use strict";let b=function(t){function s(){var e;return(e=t.apply(this,arguments)||this)._color=n.fromValues(1,0,0,1),e._patternMatrix=i.create(),e._programOptions={id:!1,pattern:!1},e}e._inheritsLoose(s,t);var c=s.prototype;return c.dispose=function(){this._vao&&(this._vao.dispose(),this._vao=null)},c.drawMany=function(t,e){const{context:i,painter:n,styleLayerUID:a}=t;this._loadWGLResources(t);const s=t.displayLevel,c=t.styleLayer,u=c.backgroundMaterial,l=n.vectorTilesMaterialManager,f=c.getPaintValue("background-color",s),_=c.getPaintValue("background-opacity",s),d=c.getPaintValue("background-pattern",s),p=void 0!==d,b=f[3]*_,v=1|window.devicePixelRatio,y=t.spriteMosaic;let T,x;const w=v>g.VTL_HIGH_RES_CUTOFF?2:1,M=t.drawPhase===h.WGLDrawPhase.HITTEST,U=this._programOptions;U.id=M,U.pattern=p;const L=l.getMaterialProgram(i,u,U);if(i.bindVAO(this._vao),i.useProgram(L),p){const t=y.getMosaicItemPosition(d,!0);if(o.isSome(t)){const{tl:e,br:r,page:n}=t;T=r[0]-e[0],x=r[1]-e[1];const a=y.getPageSize(n);o.isSome(a)&&(y.bind(i,9729,n,g.VTL_TEXTURE_BINDING_UNIT_SPRITES),L.setUniform4f("u_tlbr",e[0],e[1],r[0],r[1]),L.setUniform2fv("u_mosaicSize",a),L.setUniform1i("u_texture",g.VTL_TEXTURE_BINDING_UNIT_SPRITES))}L.setUniform1f("u_opacity",_)}else this._color[0]=b*f[0],this._color[1]=b*f[1],this._color[2]=b*f[2],this._color[3]=b,L.setUniform4fv("u_color",this._color);if(L.setUniform1f("u_depth",c.z||0),M){const t=m.u32to4Xu8(a+1);L.setUniform4fv("u_id",t)}for(const o of e){if(L.setUniform1f("u_coord_range",o.coordRange[0]),L.setUniformMatrix3fv("u_dvsMat3",o.transforms.dvs),p){const t=Math.max(2**(Math.round(s)-o.key.level),1),e=w*o.size[0]*t,i=e/r.nextPowerOfTwo(T),n=e/r.nextPowerOfTwo(x);this._patternMatrix[0]=i,this._patternMatrix[4]=n,L.setUniformMatrix3fv("u_pattern_matrix",this._patternMatrix)}i.setStencilFunction(514,o.stencilRef,255),i.drawArrays(5,0,4)}},c._loadWGLResources=function(t){if(this._vao)return;const{context:e,styleLayer:r}=t,o=r.backgroundMaterial,i=new Int8Array([0,0,1,0,0,1,1,1]),n=a.createVertex(e,35044,i),s=new d(e,o.getAttributeLocations(),o.getLayoutInfo(),{geometry:n});this._vao=s},s}(p);t.WGLBrushVTLBackground=b,Object.defineProperty(t,"__esModule",{value:!0})}));
