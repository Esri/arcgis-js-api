/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/mathUtils","../../../../../core/maybe","../../../../../chunks/mat3f32","../../../../../chunks/vec4f32","../definitions","../enums","../number","./WGLBrush","../../../../webgl/BufferObject","../../../../webgl/enums","../../../../webgl/VertexArrayObject"],(function(t,e,r,o,i,a,n,s,c,u,l,_,f){"use strict";let d=function(t){function u(){var e;return(e=t.apply(this,arguments)||this)._color=a.fromValues(1,0,0,1),e._patternMatrix=i.create(),e._programOptions={id:!1,pattern:!1},e}e._inheritsLoose(u,t);var d=u.prototype;return d.dispose=function(){this._vao&&(this._vao.dispose(),this._vao=null)},d.drawMany=function(t,e){const{context:i,painter:a,styleLayerUID:u}=t;this._loadWGLResources(t);const l=t.displayLevel,f=t.styleLayer,d=f.backgroundMaterial,m=a.vectorTilesMaterialManager,g=f.getPaintValue("background-color",l),p=f.getPaintValue("background-opacity",l),h=f.getPaintValue("background-pattern",l),T=void 0!==h,v=g[3]*p,b=1|window.devicePixelRatio,y=t.spriteMosaic;let M,x;const L=b>n.VTL_HIGH_RES_CUTOFF?2:1,U=t.drawPhase===s.WGLDrawPhase.HITTEST,I=this._programOptions;I.id=U,I.pattern=T;const P=m.getMaterialProgram(i,d,I);if(i.bindVAO(this._vao),i.useProgram(P),T){const t=y.getMosaicItemPosition(h,!0);if(o.isSome(t)){const{tl:e,br:r,page:a}=t;M=r[0]-e[0],x=r[1]-e[1];const s=y.getPageSize(a);o.isSome(s)&&(y.bind(i,_.TextureSamplingMode.LINEAR,a,n.VTL_TEXTURE_BINDING_UNIT_SPRITES),P.setUniform4f("u_tlbr",e[0],e[1],r[0],r[1]),P.setUniform2fv("u_mosaicSize",s),P.setUniform1i("u_texture",n.VTL_TEXTURE_BINDING_UNIT_SPRITES))}P.setUniform1f("u_opacity",p)}else this._color[0]=v*g[0],this._color[1]=v*g[1],this._color[2]=v*g[2],this._color[3]=v,P.setUniform4fv("u_color",this._color);if(P.setUniform1f("u_depth",f.z||0),U){const t=c.u32to4Xu8(u+1);P.setUniform4fv("u_id",t)}for(const o of e){if(P.setUniform1f("u_coord_range",o.rangeX),P.setUniformMatrix3fv("u_dvsMat3",o.transforms.dvs),T){const t=Math.max(2**(Math.round(l)-o.key.level),1),e=L*o.width*t,i=e/r.nextPowerOfTwo(M),a=e/r.nextPowerOfTwo(x);this._patternMatrix[0]=i,this._patternMatrix[4]=a,P.setUniformMatrix3fv("u_pattern_matrix",this._patternMatrix)}i.setStencilFunction(_.CompareFunction.EQUAL,o.stencilRef,255),i.drawArrays(_.PrimitiveType.TRIANGLE_STRIP,0,4)}},d._loadWGLResources=function(t){if(this._vao)return;const{context:e,styleLayer:r}=t,o=r.backgroundMaterial,i=new Int8Array([0,0,1,0,0,1,1,1]),a=l.BufferObject.createVertex(e,_.Usage.STATIC_DRAW,i),n=new f.VertexArrayObject(e,o.getAttributeLocations(),o.getLayoutInfo(),{geometry:a});this._vao=n},u}(u);t.WGLBrushVTLBackground=d,Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
