/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/maybe","../definitions","../enums","../number","./WGLBrush"],(function(e,t,i,n,a,r,o){"use strict";let s=function(e){function o(){var t;return(t=e.apply(this,arguments)||this)._programOptions={id:!1,pattern:!1,sdf:!1},t}t._inheritsLoose(o,e);var s=o.prototype;return s.dispose=function(){},s.drawMany=function(e,t){const{context:o,displayLevel:s,state:l,drawPhase:u,painter:f,pixelRatio:c,spriteMosaic:_,styleLayerUID:d}=e;if(!t.some((e=>{var t,i;return null!=(t=null==(i=e.layerData.get(d))?void 0:i.lineIndexCount)&&t})))return;const p=e.styleLayer,m=p.lineMaterial,T=f.vectorTilesMaterialManager,y=p.getPaintValue("line-translate",s),g=p.getPaintValue("line-translate-anchor",s),E=p.getPaintProperty("line-pattern"),I=void 0!==E,U=I&&E.isDataDriven;let v,P;if(I&&!U){const e=E.getValue(s);v=_.getMosaicItemPosition(e)}let M=!1;if(!I){const e=p.getPaintProperty("line-dasharray");if(P=void 0!==e,M=P&&e.isDataDriven,P&&!M){const t=e.getValue(s),i=p.getDashKey(t,p.getLayoutValue("line-cap",s));v=_.getMosaicItemPosition(i)}}const S=1/c,L=u===a.WGLDrawPhase.HITTEST,D=this._programOptions;D.id=L,D.pattern=I,D.sdf=P;const N=T.getMaterialProgram(o,m,D);if(o.useProgram(N),N.setUniformMatrix3fv("u_displayViewMat3",l.displayViewMat3),N.setUniformMatrix3fv("u_displayMat3",1===g?l.displayMat3:l.displayViewMat3),N.setUniform2fv("u_lineTranslation",y),N.setUniform1f("u_depth",p.z),N.setUniform1f("u_antialiasing",S),L){const e=r.u32to4Xu8(d+1);N.setUniform4fv("u_id",e)}if(v&&i.isSome(v)){const{page:e}=v,t=_.getPageSize(e);i.isSome(t)&&(_.bind(o,9729,e,n.VTL_TEXTURE_BINDING_UNIT_SPRITES),N.setUniform2fv("u_mosaicSize",t),N.setUniform1i("u_texture",n.VTL_TEXTURE_BINDING_UNIT_SPRITES))}let V=-1;for(const a of t){if(!a.layerData.has(d))continue;a.key.level!==V&&(V=a.key.level,m.setDataUniforms(N,s,p,V,_));const e=2**(s-V)/c;N.setUniform1f("u_zoomFactor",e);const t=a.layerData.get(d);if(!t.lineIndexCount)continue;t.prepareForRendering(o);const r=t.lineVertexArrayObject;if(!i.isNone(r)){if(o.bindVAO(r),N.setUniformMatrix3fv("u_dvsMat3",a.transforms.dvs),o.setStencilFunction(514,a.stencilRef,255),U||M){const e=t.patternMap;if(!e)continue;for(const[t,a]of e){const e=_.getPageSize(t);i.isSome(e)&&(_.bind(o,9729,t,n.VTL_TEXTURE_BINDING_UNIT_SPRITES),N.setUniform2fv("u_mosaicSize",e),N.setUniform1i("u_texture",n.VTL_TEXTURE_BINDING_UNIT_SPRITES),o.drawElements(4,a[1],5125,Uint32Array.BYTES_PER_ELEMENT*a[0]))}}else o.drawElements(4,t.lineIndexCount,5125,Uint32Array.BYTES_PER_ELEMENT*t.lineIndexStart);a.triangleCount+=t.lineIndexCount/3}}},o}(o);e.WGLBrushVTLLine=s,Object.defineProperty(e,"__esModule",{value:!0})}));
