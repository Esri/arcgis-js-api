/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/maybe","../../vectorTiles/style/StyleDefinition","../definitions","../enums","../number","./WGLBrush","../../../../webgl/enums"],(function(e,t,i,n,a,r,o,s,l){"use strict";let u=function(e){function s(){var t;return(t=e.apply(this,arguments)||this)._programOptions={id:!1,pattern:!1,sdf:!1},t}t._inheritsLoose(s,e);var u=s.prototype;return u.dispose=function(){},u.drawMany=function(e,t){const{context:s,displayLevel:u,state:f,drawPhase:c,painter:T,pixelRatio:p,spriteMosaic:_,styleLayerUID:d}=e;if(!t.some((e=>{var t,i;return null!=(t=null==(i=e.layerData.get(d))?void 0:i.lineIndexCount)&&t})))return;const m=e.styleLayer,y=m.lineMaterial,I=T.vectorTilesMaterialManager,E=m.getPaintValue("line-translate",u),g=m.getPaintValue("line-translate-anchor",u),S=m.getPaintProperty("line-pattern"),U=void 0!==S,v=U&&S.isDataDriven;let N,P;if(U&&!v){const e=S.getValue(u);N=_.getMosaicItemPosition(e)}let M=!1;if(!U){const e=m.getPaintProperty("line-dasharray");if(P=void 0!==e,M=P&&e.isDataDriven,P&&!M){const t=e.getValue(u),i=m.getDashKey(t,m.getLayoutValue("line-cap",u));N=_.getMosaicItemPosition(i)}}const L=1/p,D=c===r.WGLDrawPhase.HITTEST,R=this._programOptions;R.id=D,R.pattern=U,R.sdf=P;const x=I.getMaterialProgram(s,y,R);if(s.useProgram(x),x.setUniformMatrix3fv("u_displayViewMat3",f.displayViewMat3),x.setUniformMatrix3fv("u_displayMat3",g===n.TranslateAnchor.VIEWPORT?f.displayMat3:f.displayViewMat3),x.setUniform2fv("u_lineTranslation",E),x.setUniform1f("u_depth",m.z),x.setUniform1f("u_antialiasing",L),D){const e=o.u32to4Xu8(d+1);x.setUniform4fv("u_id",e)}if(N&&i.isSome(N)){const{page:e}=N,t=_.getPageSize(e);i.isSome(t)&&(_.bind(s,l.TextureSamplingMode.LINEAR,e,a.VTL_TEXTURE_BINDING_UNIT_SPRITES),x.setUniform2fv("u_mosaicSize",t),x.setUniform1i("u_texture",a.VTL_TEXTURE_BINDING_UNIT_SPRITES))}let V=-1;for(const n of t){if(!n.layerData.has(d))continue;n.key.level!==V&&(V=n.key.level,y.setDataUniforms(x,u,m,V,_));const e=2**(u-V)/p;x.setUniform1f("u_zoomFactor",e);const t=n.layerData.get(d);if(!t.lineIndexCount)continue;t.prepareForRendering(s);const r=t.lineVertexArrayObject;if(!i.isNone(r)){if(s.bindVAO(r),x.setUniformMatrix3fv("u_dvsMat3",n.transforms.dvs),s.setStencilFunction(l.CompareFunction.EQUAL,n.stencilRef,255),v||M){const e=t.patternMap;if(!e)continue;for(const[t,n]of e){const e=_.getPageSize(t);i.isSome(e)&&(_.bind(s,l.TextureSamplingMode.LINEAR,t,a.VTL_TEXTURE_BINDING_UNIT_SPRITES),x.setUniform2fv("u_mosaicSize",e),x.setUniform1i("u_texture",a.VTL_TEXTURE_BINDING_UNIT_SPRITES),s.drawElements(l.PrimitiveType.TRIANGLES,n[1],l.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*n[0]))}}else s.drawElements(l.PrimitiveType.TRIANGLES,t.lineIndexCount,l.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t.lineIndexStart);n.triangleCount+=t.lineIndexCount/3}}},s}(s);e.WGLBrushVTLLine=u,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
