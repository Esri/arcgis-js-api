// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/assignHelper","../../../webgl","../../engine","../vectorTiles/shaders/ProgramCache","./BitBlitRenderer","./enums","./MaterialManager","./TextureManager","./effects/AnimationEffect","./effects/HighlightEffect","./effects/HittestEffect","./painter/RenderPass"],(function(e,t,r,s,i,h,n,a,o,l,u,f,b,c){Object.defineProperty(t,"__esModule",{value:!0});var p=function(){};t.PainterOptions=p;var d=function(){function e(e,t){this.context=e,this._blitRenderer=new n.BitBlitRenderer,this._brushCache=new Map,this._vtlProgramCache=null,this.brushNameToCtor={marker:i.brushes.Marker,line:i.brushes.Line,fill:i.brushes.Fill,text:i.brushes.Text,label:i.brushes.Label,clip:i.brushes.Clip,stencil:i.brushes.Stencil,bitmap:i.brushes.Bitmap,tileInfo:i.brushes.TileInfo,vtlBackground:i.brushes.VTLBackground,vtlFill:i.brushes.VTLFill,vtlLine:i.brushes.VTLLine,vtlCircle:i.brushes.VTLCircle,vtlSymbol:i.brushes.VTLSymbol},this.effects={highlight:new f.default,hittest:new b.HittestEffect,integrate:new u.AnimationEffect},this.materialManager=new o(e),this._vtlProgramCache=new h.default(e),this.textureManager=new l(t)}return e.prototype.getFbos=function(e,t){if(e!==this._lastWidth||t!==this._lastHeight){if(this._lastWidth=e,this._lastHeight=t,this._fbos)for(var r in this._fbos)this._fbos[r].dispose();var i={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,wrapMode:33071,width:e,height:t},h={colorTarget:0,depthStencilTarget:3},n=new s.Renderbuffer(this.context,{width:e,height:t,internalFormat:34041});this._fbos={output:new s.FramebufferObject(this.context,h,i,n),alpha:new s.FramebufferObject(this.context,h,i,n),effect0:new s.FramebufferObject(this.context,h,i,n)}}return this._fbos},e.prototype.beforeRenderLayers=function(e){var t=e.getViewport(),r=t.width,s=t.height,i=this.getFbos(r,s);this._prevFBO=e.getBoundFramebufferObject(),e.bindFramebuffer(i.output),e.setDepthWriteEnabled(!0),e.setClearColor(0,0,0,0),e.setClearDepth(1),e.clear(e.gl.COLOR_BUFFER_BIT|e.gl.DEPTH_BUFFER_BIT),e.setDepthWriteEnabled(!1)},e.prototype.beforeRenderLayer=function(e,t,r){1!==r?(e.bindFramebuffer(this._fbos.alpha),e.setColorMask(!0,!0,!0,!0),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT)):e.bindFramebuffer(this._fbos.output),e.setDepthWriteEnabled(!1),e.setDepthTestEnabled(!1),e.setStencilTestEnabled(!0),e.setClearStencil(t),e.setStencilWriteMask(255),e.clear(e.gl.STENCIL_BUFFER_BIT)},e.prototype.compositeLayer=function(e,t){1!==t&&(e.bindFramebuffer(this._fbos.output),e.setStencilTestEnabled(!1),e.setStencilWriteMask(0),e.setBlendingEnabled(!0),e.setBlendFunctionSeparate(1,771,1,771),e.setColorMask(!0,!0,!0,!0),this._blitRenderer.render(e,this._fbos.alpha.colorTexture,9728,t))},e.prototype.renderLayers=function(e){e.bindFramebuffer(this._prevFBO),this._fbos&&(e.setStencilTestEnabled(!1),e.setStencilWriteMask(0),e.setBlendingEnabled(!0),e.setBlendFunctionSeparate(1,771,1,771),e.setColorMask(!0,!0,!0,!0),this._blitRenderer.render(e,this._fbos.output.colorTexture,9728,1))},e.prototype.dispose=function(){if(this.materialManager.dispose(),this.textureManager.dispose(),this._blitRenderer&&(this._blitRenderer.dispose(),this._blitRenderer=null),this._vtlProgramCache&&(this._vtlProgramCache.dispose(),this._vtlProgramCache=null),this._brushCache&&(this._brushCache.forEach((function(e){return e.dispose()})),this._brushCache.clear(),this._brushCache=null),this._fbos)for(var e in this._fbos)this._fbos[e]&&this._fbos[e].dispose();if(this.effects)for(var t in this.effects)this.effects[t]&&this.effects[t].dispose();this._prevFBO=null},e.prototype.getGeometryBrush=function(e){var t,r=((t={})[a.WGLGeometryType.FILL]=i.brushes.Fill,t[a.WGLGeometryType.LINE]=i.brushes.Line,t[a.WGLGeometryType.MARKER]=i.brushes.Marker,t[a.WGLGeometryType.TEXT]=i.brushes.Text,t)[e],s=this._brushCache.get(r);return void 0===s&&(s=new r,this._brushCache.set(r,s)),this._brushCache.get(r)},e.prototype.renderObject=function(e,t,r,s){var i=this.brushNameToCtor[r];if(!i)return null;var h=this._brushCache.get(i);void 0===h&&(h=new i,this._brushCache.set(i,h)),h.prepareState(e,t,s),h.draw(e,t,s)},e.prototype.renderObjects=function(e,t,r,s){var i=this.brushNameToCtor[r];if(!i)return null;var h=this._brushCache.get(i);void 0===h&&(h=new i,this._brushCache.set(i,h)),h.drawMany(e,t,s)},e.prototype.getVectorTileProgramCach=function(){return this._vtlProgramCache},e.prototype.registerRenderPass=function(e){var t=this,r=e.brushes.map((function(e){return t._brushCache.has(e)||t._brushCache.set(e,new e),t._brushCache.get(e)}));return new c.default(r,e)},e.prototype.setHighlightOptions=function(e){this.effects.highlight.setHighlightOptions(e)},e}();t.default=d}));