// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","../../../../core/maybe","../../../webgl","../brushes","../vectorTiles/shaders/ProgramCache","./BitBlitRenderer","./enums","./MaterialManager","./TextureManager","./effects/AnimationEffect","./effects/BlendEffect","./effects/HighlightEffect","./effects/HittestEffect","./effects/post-processing/EffectManager","./painter/RenderPass"],(function(e,t,r,s,i,n,o,a,h,f,l,c,u,b,d,p){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PainterOptions=void 0;var g=function(){};t.PainterOptions=g;var _=function(){function e(e,t){this.context=e,this._blitRenderer=new o.BitBlitRenderer,this._brushCache=new Map,this._vtlProgramCache=null,this._blendEffect=new c.BlendEffect,this.effects={highlight:new u.default,hittest:new b.HittestEffect,integrate:new l.AnimationEffect},this.materialManager=new h(e),this._vtlProgramCache=new n.default(e),this.textureManager=new f(t),this._effectsManager=new d.EffectManager(t)}return e.prototype.getRenderTarget=function(){return this._renderTarget},e.prototype.setRenderTarget=function(e){this._renderTarget=e},e.prototype.getFbos=function(e,t){if(e!==this._lastWidth||t!==this._lastHeight){if(this._lastWidth=e,this._lastHeight=t,this._fbos){for(var r in this._fbos)this._fbos[r].resize(e,t);return this._fbos}var i={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,wrapMode:33071,width:e,height:t},n={colorTarget:0,depthStencilTarget:3},o=new s.Renderbuffer(this.context,{width:e,height:t,internalFormat:34041});this._stencilBuf=o,this._fbos={output:new s.FramebufferObject(this.context,n,i,o),blend:new s.FramebufferObject(this.context,n,i,o),effect0:new s.FramebufferObject(this.context,n,i,o)}}return this._fbos},e.prototype.getSharedStencilBuffer=function(){return this._stencilBuf},e.prototype.beforeRenderLayers=function(e,t){void 0===t&&(t=null);var s=e.getViewport(),i=s.width,n=s.height;this._prevFBO=e.getBoundFramebufferObject();var o=this.getFbos(i,n);if(e.bindFramebuffer(o.output),e.setDepthWriteEnabled(!0),r.isSome(t)){var a=t.color,h=a.r,f=a.g,l=a.b,c=a.a;e.setClearColor(c*h/255,c*f/255,c*l/255,c)}else e.setClearColor(0,0,0,0);e.setClearDepth(1),e.clear(e.gl.COLOR_BUFFER_BIT|e.gl.DEPTH_BUFFER_BIT),e.setDepthWriteEnabled(!1)},e.prototype.beforeRenderLayer=function(e,t,r){var s=e.context;if(m(e.blendMode,e.effects,r))s.bindFramebuffer(this._fbos.blend),s.setColorMask(!0,!0,!0,!0),s.setClearColor(0,0,0,0),s.clear(s.gl.COLOR_BUFFER_BIT);else{var i=this._getOutputFBO();s.bindFramebuffer(i)}s.setDepthWriteEnabled(!1),s.setDepthTestEnabled(!1),s.setStencilTestEnabled(!0),s.setClearStencil(t),s.setStencilWriteMask(255),s.clear(s.gl.STENCIL_BUFFER_BIT)},e.prototype.compositeLayer=function(e,t){var s=e.context,i=e.blendMode,n=e.effects;if(m(i,n,t)){r.isSome(n)&&n.length>0&&this._applyEffects(e,n);var o=this._getOutputFBO();s.bindFramebuffer(o),s.setStencilTestEnabled(!1),s.setStencilWriteMask(0),s.setBlendingEnabled(!0),s.setBlendFunctionSeparate(1,771,1,771),s.setColorMask(!0,!0,!0,!0);var a=r.isSome(i)?i:"normal";this._blendEffect.draw(e,this._fbos.blend.colorTexture,9728,a,t)}},e.prototype.renderLayers=function(e){if(e.bindFramebuffer(this._prevFBO),this._fbos){var t=this._getOutputFBO();e.setStencilTestEnabled(!1),e.setStencilWriteMask(0),this.blitTexture(e,t.colorTexture,9728)}},e.prototype.dispose=function(){if(this.materialManager.dispose(),this.textureManager.dispose(),this._blitRenderer&&(this._blitRenderer.dispose(),this._blitRenderer=null),this._vtlProgramCache&&(this._vtlProgramCache.dispose(),this._vtlProgramCache=null),this._brushCache&&(this._brushCache.forEach((function(e){return e.dispose()})),this._brushCache.clear(),this._brushCache=null),this._fbos)for(var e in this._fbos)this._fbos[e]&&this._fbos[e].dispose();if(this.effects)for(var t in this.effects)this.effects[t]&&this.effects[t].dispose();this._prevFBO=null},e.prototype.getGeometryBrush=function(e){var t,r=((t={})[a.WGLGeometryType.FILL]=i.brushes.fill,t[a.WGLGeometryType.LINE]=i.brushes.line,t[a.WGLGeometryType.MARKER]=i.brushes.marker,t[a.WGLGeometryType.TEXT]=i.brushes.text,t)[e],s=this._brushCache.get(r);return void 0===s&&(s=new r,this._brushCache.set(r,s)),this._brushCache.get(r)},e.prototype.renderObject=function(e,t,r,s){var n=i.brushes[r];if(!n)return null;var o=this._brushCache.get(n);void 0===o&&(o=new n,this._brushCache.set(n,o)),o.prepareState(e,t,s),o.draw(e,t,s)},e.prototype.renderObjects=function(e,t,r,s){var n=i.brushes[r];if(!n)return null;var o=this._brushCache.get(n);void 0===o&&(o=new n,this._brushCache.set(n,o)),o.drawMany(e,t,s)},e.prototype.getVectorTileProgramCach=function(){return this._vtlProgramCache},e.prototype.registerRenderPass=function(e){var t=this,r=e.brushes.map((function(e){return t._brushCache.has(e)||t._brushCache.set(e,new e),t._brushCache.get(e)}));return new p.default(r,e)},e.prototype.setHighlightOptions=function(e){this.effects.highlight.setHighlightOptions(e)},e.prototype.blitTexture=function(e,t,r,s){void 0===s&&(s=1),e.setBlendingEnabled(!0),e.setBlendFunctionSeparate(1,771,1,771),e.setColorMask(!0,!0,!0,!0),this._blitRenderer.render(e,t,r,s)},e.prototype._getOutputFBO=function(){return null!=this._renderTarget?this._renderTarget:this._fbos.output},e.prototype._applyEffects=function(e,t){for(var r=e.context,s=0,i=this._effectsManager.getPostProcessingEffects(t);s<i.length;s++){var n=i[s],o=n.postProcessingEffect,a=n.effect;r.bindFramebuffer(this._fbos.blend),o.draw(e,this._fbos.blend,a)}},e}();function m(e,t,s){return 1!==s||r.isSome(e)&&"normal"!==e||r.isSome(t)&&t.length>0}t.default=_}));