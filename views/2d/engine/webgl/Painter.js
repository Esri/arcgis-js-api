/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../brushes","../vectorTiles/shaders/VTLMaterialManager","./BitBlitRenderer","./enums","./MaterialManager","./TextureManager","./TextureUploadManager","./WorldExtentClipRenderer","./effects/AnimationEffect","./effects/BlendEffect","./effects/FeatureEffect","./effects/HighlightEffect","./effects/HittestEffect","./effects/HittestEffectVTL","./effects/post-processing/EffectManager","./painter/RenderPass","../../../webgl/context-util","../../../webgl/enums","../../../webgl/FramebufferObject","../../../webgl/Renderbuffer"],(function(e,t,r,s,n,i,o,a,l,h,f,c,u,d,b,_,p,E,g,T,F,M){"use strict";function C(e,t){switch(e){case i.WGLGeometryType.LINE:return r.brushes.line;case i.WGLGeometryType.TEXT:return r.brushes.text;case i.WGLGeometryType.LABEL:return r.brushes.label;case i.WGLGeometryType.FILL:return t===i.WGLSymbologyType.DOT_DENSITY?r.brushes.dotDensity:r.brushes.fill;case i.WGLGeometryType.MARKER:switch(t){case i.WGLSymbologyType.HEATMAP:return r.brushes.heatmap;case i.WGLSymbologyType.PIE_CHART:return r.brushes.pieChart;default:return r.brushes.marker}}}function B(e,r,s,n){return e!==i.WGLDrawPhase.HIGHLIGHT&&(1!==n||t.isSome(r)&&"normal"!==r||t.isSome(s)&&s.length>0)}return function(){function R(e,t,r){this.context=e,this._blitRenderer=new n.BitBlitRenderer,this._worldExtentClipRenderer=new h.WorldExtentClipRenderer,this._isClippedToWorldExtent=!1,this._brushCache=new Map,this._lastWidth=null,this._lastHeight=null,this._prevFBO=null,this._vtlMaterialManager=new s,this._blendEffect=new c.BlendEffect,this._stencilBuf=null,this._fbos=null,this._fboPool=[],this._renderTarget=null,this.effects={highlight:new d,hittest:new b.HittestEffect,hittestVTL:new _.HittestEffectVTL,integrate:new f.AnimationEffect,insideEffect:new u.FeatureEffect("inside"),outsideEffect:new u.FeatureEffect("outside")},this.materialManager=new o(e),this.textureManager=new a(t,r,e.type===g.ContextType.WEBGL2),this.textureUploadManager=new l.TextureUploadManager(e,t),this._effectsManager=new p.EffectManager}var m=R.prototype;return m.getRenderTarget=function(){return this._renderTarget},m.setRenderTarget=function(e){this._renderTarget=e},m.getFbos=function(e,t){if(e!==this._lastWidth||t!==this._lastHeight){if(this._lastWidth=e,this._lastHeight=t,this._fbos){for(const r in this._fbos)this._fbos[r].resize(e,t);return this._fbos}const r={target:T.TextureType.TEXTURE_2D,pixelFormat:T.PixelFormat.RGBA,dataType:T.PixelType.UNSIGNED_BYTE,samplingMode:T.TextureSamplingMode.NEAREST,wrapMode:T.TextureWrapMode.CLAMP_TO_EDGE,width:e,height:t},s={colorTarget:T.TargetType.TEXTURE,depthStencilTarget:T.DepthStencilTargetType.DEPTH_STENCIL_RENDER_BUFFER},n=new M.Renderbuffer(this.context,{width:e,height:t,internalFormat:T.RenderbufferFormat.DEPTH_STENCIL});this._stencilBuf=n,this._fbos={output:new F.FramebufferObject(this.context,s,r,n),blend:new F.FramebufferObject(this.context,s,r,n),effect0:new F.FramebufferObject(this.context,s,r,n)}}return this._fbos},m.acquireFbo=function(e,t){let r;r=this._fboPool.length>0?this._fboPool.pop():new F.FramebufferObject(this.context,{colorTarget:T.TargetType.TEXTURE,depthStencilTarget:T.DepthStencilTargetType.DEPTH_STENCIL_RENDER_BUFFER},{target:T.TextureType.TEXTURE_2D,pixelFormat:T.PixelFormat.RGBA,dataType:T.PixelType.UNSIGNED_BYTE,samplingMode:T.TextureSamplingMode.NEAREST,wrapMode:T.TextureWrapMode.CLAMP_TO_EDGE,width:e,height:t},this._stencilBuf);const s=r.descriptor;return s.width===e&&s.height===t||r.resize(e,t),r},m.releaseFbo=function(e){this._fboPool.push(e)},m.getSharedStencilBuffer=function(){return this._stencilBuf},m.beforeRenderLayers=function(e,r=null){const{width:s,height:n}=e.getViewport();this._prevFBO=e.getBoundFramebufferObject();const i=this.getFbos(s,n);if(e.bindFramebuffer(i?.output),e.setColorMask(!0,!0,!0,!0),t.isSome(r)){const{r:t,g:s,b:n,a:i}=r.color;e.setClearColor(i*t/255,i*s/255,i*n/255,i)}else e.setClearColor(0,0,0,0);e.setDepthWriteEnabled(!0),e.setClearDepth(1),e.clear(e.gl.COLOR_BUFFER_BIT|e.gl.DEPTH_BUFFER_BIT),e.setDepthWriteEnabled(!1)},m.beforeRenderLayer=function(e,t,r){const{context:s,blendMode:n,effects:i,requireFBO:o,drawPhase:a}=e;if(o||B(a,n,i,r))s.bindFramebuffer(this._fbos?.blend),s.setColorMask(!0,!0,!0,!0),s.setClearColor(0,0,0,0),s.setDepthWriteEnabled(!0),s.setClearDepth(1),s.clear(s.gl.COLOR_BUFFER_BIT|s.gl.DEPTH_BUFFER_BIT),s.setDepthWriteEnabled(!1);else{const e=this._getOutputFBO();s.bindFramebuffer(e)}s.setDepthWriteEnabled(!1),s.setDepthTestEnabled(!1),s.setStencilTestEnabled(!0),s.setClearStencil(t),s.setStencilWriteMask(255),s.clear(s.gl.STENCIL_BUFFER_BIT)},m.compositeLayer=function(e,r){const{context:s,blendMode:n,effects:o,requireFBO:a,drawPhase:l}=e;if(a||B(l,n,o,r)){t.isSome(o)&&o.length>0&&l===i.WGLDrawPhase.MAP&&this._applyEffects(e,o);const a=this._getOutputFBO();s.bindFramebuffer(a),s.setStencilTestEnabled(!1),s.setStencilWriteMask(0),s.setBlendingEnabled(!0),s.setBlendFunctionSeparate(T.BlendFactor.ONE,T.BlendFactor.ONE_MINUS_SRC_ALPHA,T.BlendFactor.ONE,T.BlendFactor.ONE_MINUS_SRC_ALPHA),s.setColorMask(!0,!0,!0,!0);const h=t.isNone(n)||l===i.WGLDrawPhase.HIGHLIGHT?"normal":n,f=this._fbos;f?.blend.colorTexture&&this._blendEffect.draw(e,f.blend.colorTexture,T.TextureSamplingMode.NEAREST,h,r)}},m.renderLayers=function(e){e.bindFramebuffer(this._prevFBO);const t=this._getOutputFBO();t&&(e.setDepthTestEnabled(!1),e.setStencilWriteMask(0),this._isClippedToWorldExtent?(e.setStencilTestEnabled(!0),e.setStencilFunction(T.CompareFunction.EQUAL,1,255)):e.setStencilTestEnabled(!1),this.blitTexture(e,t.colorTexture,T.TextureSamplingMode.NEAREST))},m.prepareDisplay=function(e,r,s){const{context:n}=e;if(n.bindFramebuffer(this._prevFBO),n.setColorMask(!0,!0,!0,!0),t.isSome(r)){const{r:e,g:t,b:s,a:i}=r.color;n.setClearColor(i*e/255,i*t/255,i*s/255,i)}else n.setClearColor(0,0,0,0);n.setStencilWriteMask(255),n.setClearStencil(0),n.clear(n.gl.COLOR_BUFFER_BIT|n.gl.STENCIL_BUFFER_BIT),this._isClippedToWorldExtent=this._worldExtentClipRenderer.render(e,s)},m.dispose=function(){if(this.materialManager.dispose(),this.textureManager.dispose(),this.textureUploadManager.destroy(),this._blitRenderer=t.disposeMaybe(this._blitRenderer),this._worldExtentClipRenderer=t.disposeMaybe(this._worldExtentClipRenderer),this._brushCache&&(this._brushCache.forEach((e=>e.dispose())),this._brushCache.clear(),this._brushCache=null),this._fbos)for(const e in this._fbos)this._fbos[e]&&this._fbos[e].dispose();for(const e of this._fboPool)e.dispose();if(this._fboPool.length=0,this.effects)for(const e in this.effects)this.effects[e]&&this.effects[e].dispose();this._effectsManager.dispose(),this._vtlMaterialManager=t.disposeMaybe(this._vtlMaterialManager),this._prevFBO=null},m.getBrush=function(e,t){const r=C(e,t);let s=this._brushCache.get(r);return void 0===s&&(s=new r,this._brushCache.set(r,s)),s},m.renderObject=function(e,t,s,n){const i=r.brushes[s];if(!i)return;let o=this._brushCache.get(i);void 0===o&&(o=new i,this._brushCache.set(i,o)),o.prepareState(e,n),o.draw(e,t,n)},m.renderObjects=function(e,t,s,n){const i=r.brushes[s];if(!i)return;let o=this._brushCache.get(i);void 0===o&&(o=new i,this._brushCache.set(i,o)),o.drawMany(e,t,n)},m.registerRenderPass=function(e){const t=e.brushes.map((e=>(this._brushCache.has(e)||this._brushCache.set(e,new e),this._brushCache.get(e))));return new E(t,e)},m.blitTexture=function(e,t,r,s=1){e.setBlendingEnabled(!0),e.setBlendFunctionSeparate(T.BlendFactor.ONE,T.BlendFactor.ONE_MINUS_SRC_ALPHA,T.BlendFactor.ONE,T.BlendFactor.ONE_MINUS_SRC_ALPHA),e.setColorMask(!0,!0,!0,!0),this._blitRenderer.render(e,t,r,s)},m.getPostProcessingEffects=function(e){return this._effectsManager.getPostProcessingEffects(e)},m._getOutputFBO=function(){return null!=this._renderTarget?this._renderTarget:this._fbos?.output??null},m._applyEffects=function(e,t){const r=this._fbos?.blend;if(!r)return;const{context:s}=e,n=this._effectsManager.getPostProcessingEffects(t);for(const{postProcessingEffect:i,effect:o}of n)s.bindFramebuffer(r),i.draw(e,r,o)},e._createClass(R,[{key:"vectorTilesMaterialManager",get:function(){return this._vtlMaterialManager}}]),R}()}));
