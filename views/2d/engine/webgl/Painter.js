// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","../../../../core/maybe","../../../webgl","../../engine","../vectorTiles/shaders/ProgramCache","./BitBlitRenderer","./enums","./MaterialManager","./TextureManager","./effects/AnimationEffect","./effects/BlendEffect","./effects/HighlightEffect","./effects/HittestEffect","./painter/RenderPass"],(function(e,t,r,s,i,n,o,h,a,l,u,f,c,b,d){Object.defineProperty(t,"__esModule",{value:!0});var p=function(){};t.PainterOptions=p;var g=function(){function e(e,t){this.context=e,this._blitRenderer=new o.BitBlitRenderer,this._brushCache=new Map,this._vtlProgramCache=null,this._blendEffect=new f.BlendEffect,this.brushNameToCtor={marker:i.brushes.Marker,line:i.brushes.Line,fill:i.brushes.Fill,text:i.brushes.Text,label:i.brushes.Label,clip:i.brushes.Clip,stencil:i.brushes.Stencil,bitmap:i.brushes.Bitmap,tileInfo:i.brushes.TileInfo,vtlBackground:i.brushes.VTLBackground,vtlFill:i.brushes.VTLFill,vtlLine:i.brushes.VTLLine,vtlCircle:i.brushes.VTLCircle,vtlSymbol:i.brushes.VTLSymbol},this.effects={highlight:new c.default,hittest:new b.HittestEffect,integrate:new u.AnimationEffect},this.materialManager=new a(e),this._vtlProgramCache=new n.default(e),this.textureManager=new l(t)}return e.prototype.getRenderTarget=function(){return this._renderTarget},e.prototype.setRenderTarget=function(e){this._renderTarget=e},e.prototype.getFbos=function(e,t){if(e!==this._lastWidth||t!==this._lastHeight){if(this._lastWidth=e,this._lastHeight=t,this._fbos){for(var r in this._fbos)this._fbos[r].resize(e,t);return this._fbos}var i={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,wrapMode:33071,width:e,height:t},n={colorTarget:0,depthStencilTarget:3},o=new s.Renderbuffer(this.context,{width:e,height:t,internalFormat:34041});this._stencilBuf=o,this._fbos={output:new s.FramebufferObject(this.context,n,i,o),blend:new s.FramebufferObject(this.context,n,i,o),effect0:new s.FramebufferObject(this.context,n,i,o)}}return this._fbos},e.prototype.getSharedStencilBuffer=function(){return this._stencilBuf},e.prototype.beforeRenderLayers=function(e,t){void 0===t&&(t=null);var s=e.getViewport(),i=s.width,n=s.height;this._prevFBO=e.getBoundFramebufferObject();var o=this.getFbos(i,n);if(e.bindFramebuffer(o.output),e.setDepthWriteEnabled(!0),r.isSome(t)){var h=t.color,a=h.r,l=h.g,u=h.b,f=h.a;e.setClearColor(f*a/255,f*l/255,f*u/255,f)}else e.setClearColor(0,0,0,0);e.setClearDepth(1),e.clear(e.gl.COLOR_BUFFER_BIT|e.gl.DEPTH_BUFFER_BIT),e.setDepthWriteEnabled(!1)},e.prototype.beforeRenderLayer=function(e,t,r){var s=e.context;if(_(e.blendMode,r))s.bindFramebuffer(this._fbos.blend),s.setColorMask(!0,!0,!0,!0),s.setClearColor(0,0,0,0),s.clear(s.gl.COLOR_BUFFER_BIT);else{var i=this._getOutputFBO();s.bindFramebuffer(i)}s.setDepthWriteEnabled(!1),s.setDepthTestEnabled(!1),s.setStencilTestEnabled(!0),s.setClearStencil(t),s.setStencilWriteMask(255),s.clear(s.gl.STENCIL_BUFFER_BIT)},e.prototype.compositeLayer=function(e,t){var s=e.context,i=e.blendMode;if(_(i,t)){var n=this._getOutputFBO();s.bindFramebuffer(n),s.setStencilTestEnabled(!1),s.setStencilWriteMask(0),s.setBlendingEnabled(!0),s.setBlendFunctionSeparate(1,771,1,771),s.setColorMask(!0,!0,!0,!0);var o=r.isSome(i)?i:"normal";this._blendEffect.draw(e,this._fbos.blend.colorTexture,9728,o,t)}},e.prototype.renderLayers=function(e){if(e.bindFramebuffer(this._prevFBO),this._fbos){var t=this._getOutputFBO();e.setStencilTestEnabled(!1),e.setStencilWriteMask(0),this.blitTexture(e,t.colorTexture,9728)}},e.prototype.dispose=function(){if(this.materialManager.dispose(),this.textureManager.dispose(),this._blitRenderer&&(this._blitRenderer.dispose(),this._blitRenderer=null),this._vtlProgramCache&&(this._vtlProgramCache.dispose(),this._vtlProgramCache=null),this._brushCache&&(this._brushCache.forEach((function(e){return e.dispose()})),this._brushCache.clear(),this._brushCache=null),this._fbos)for(var e in this._fbos)this._fbos[e]&&this._fbos[e].dispose();if(this.effects)for(var t in this.effects)this.effects[t]&&this.effects[t].dispose();this._prevFBO=null},e.prototype.getGeometryBrush=function(e){var t,r=((t={})[h.WGLGeometryType.FILL]=i.brushes.Fill,t[h.WGLGeometryType.LINE]=i.brushes.Line,t[h.WGLGeometryType.MARKER]=i.brushes.Marker,t[h.WGLGeometryType.TEXT]=i.brushes.Text,t)[e],s=this._brushCache.get(r);return void 0===s&&(s=new r,this._brushCache.set(r,s)),this._brushCache.get(r)},e.prototype.renderObject=function(e,t,r,s){var i=this.brushNameToCtor[r];if(!i)return null;var n=this._brushCache.get(i);void 0===n&&(n=new i,this._brushCache.set(i,n)),n.prepareState(e,t,s),n.draw(e,t,s)},e.prototype.renderObjects=function(e,t,r,s){var i=this.brushNameToCtor[r];if(!i)return null;var n=this._brushCache.get(i);void 0===n&&(n=new i,this._brushCache.set(i,n)),n.drawMany(e,t,s)},e.prototype.getVectorTileProgramCach=function(){return this._vtlProgramCache},e.prototype.registerRenderPass=function(e){var t=this,r=e.brushes.map((function(e){return t._brushCache.has(e)||t._brushCache.set(e,new e),t._brushCache.get(e)}));return new d.default(r,e)},e.prototype.setHighlightOptions=function(e){this.effects.highlight.setHighlightOptions(e)},e.prototype.blitTexture=function(e,t,r,s){void 0===s&&(s=1),e.setBlendingEnabled(!0),e.setBlendFunctionSeparate(1,771,1,771),e.setColorMask(!0,!0,!0,!0),this._blitRenderer.render(e,t,r,s)},e.prototype._getOutputFBO=function(){return null!=this._renderTarget?this._renderTarget:this._fbos.output},e}();function _(e,t){return 1!==t||r.isSome(e)&&"normal"!==e}t.default=g}));