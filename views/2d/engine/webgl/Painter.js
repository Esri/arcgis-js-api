/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../webgl/BufferObject","../../../webgl/FramebufferObject","../../../../core/has","../../../webgl/checkWebGLError","../../../webgl/enums","../../../../chunks/builtins","../../../webgl/Renderbuffer","../../../webgl/renderState","../../../webgl/Texture","../../../webgl/VertexArrayObject","../brushes","../vectorTiles/shaders/VTLMaterialManager","./BitBlitRenderer","./enums","./MaterialManager","./TextureManager","./effects/AnimationEffect","./effects/BlendEffect","./effects/FeatureEffect","./effects/HighlightEffect","./effects/HittestEffect","./effects/post-processing/EffectManager","./painter/RenderPass"],(function(e,t,s,r,n,i,a,h,f,o,c,l,u,b,d,g,_,p,E,M,w,F,B,T,m){"use strict";const C={[g.WGLGeometryType.FILL]:u.brushes.fill,[g.WGLGeometryType.LINE]:u.brushes.line,[g.WGLGeometryType.MARKER]:u.brushes.marker,[g.WGLGeometryType.TEXT]:u.brushes.text};function O(e,s,r){return 1!==r||t.isSome(e)&&"normal"!==e||t.isSome(s)&&s.length>0}return function(){function s(e,t){this.context=e,this._blitRenderer=new d.BitBlitRenderer,this._brushCache=new Map,this._vtlMaterialManager=new b,this._blendEffect=new M.BlendEffect,this.effects={highlight:new F,hittest:new B.HittestEffect,integrate:new E.AnimationEffect,insideEffect:new w.FeatureEffect("inside"),outsideEffect:new w.FeatureEffect("outside")},this.materialManager=new _(e),this.textureManager=new p(t),this._effectsManager=new T.EffectManager(t)}var n=s.prototype;return n.getRenderTarget=function(){return this._renderTarget},n.setRenderTarget=function(e){this._renderTarget=e},n.getFbos=function(e,t){if(e!==this._lastWidth||t!==this._lastHeight){if(this._lastWidth=e,this._lastHeight=t,this._fbos){for(const s in this._fbos)this._fbos[s].resize(e,t);return this._fbos}const s={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,wrapMode:33071,width:e,height:t},n={colorTarget:0,depthStencilTarget:3},i=new f(this.context,{width:e,height:t,internalFormat:34041});this._stencilBuf=i,this._fbos={output:new r(this.context,n,s,i),blend:new r(this.context,n,s,i),effect0:new r(this.context,n,s,i)}}return this._fbos},n.getSharedStencilBuffer=function(){return this._stencilBuf},n.beforeRenderLayers=function(e,s=null){const{width:r,height:n}=e.getViewport();this._prevFBO=e.getBoundFramebufferObject();const i=this.getFbos(r,n);if(e.bindFramebuffer(i.output),e.setColorMask(!0,!0,!0,!0),e.setDepthWriteEnabled(!0),t.isSome(s)){const{r:t,g:r,b:n,a:i}=s.color;e.setClearColor(i*t/255,i*r/255,i*n/255,i)}else e.setClearColor(0,0,0,0);e.setClearDepth(1),e.clear(e.gl.COLOR_BUFFER_BIT|e.gl.DEPTH_BUFFER_BIT),e.setDepthWriteEnabled(!1)},n.beforeRenderLayer=function(e,t,s){const{context:r,blendMode:n,effects:i,requireFBO:a}=e;if(a||O(n,i,s))r.bindFramebuffer(this._fbos.blend),r.setColorMask(!0,!0,!0,!0),r.setClearColor(0,0,0,0),r.setDepthWriteEnabled(!0),r.setClearDepth(1),r.clear(r.gl.COLOR_BUFFER_BIT|r.gl.DEPTH_BUFFER_BIT),r.setDepthWriteEnabled(!1);else{const e=this._getOutputFBO();r.bindFramebuffer(e)}r.setDepthWriteEnabled(!1),r.setDepthTestEnabled(!1),r.setStencilTestEnabled(!0),r.setClearStencil(t),r.setStencilWriteMask(255),r.clear(r.gl.STENCIL_BUFFER_BIT)},n.compositeLayer=function(e,s){const{context:r,blendMode:n,effects:i,requireFBO:a}=e;if(a||O(n,i,s)){t.isSome(i)&&i.length>0&&e.drawPhase===g.WGLDrawPhase.MAP&&this._applyEffects(e,i);const a=this._getOutputFBO();r.bindFramebuffer(a),r.setStencilTestEnabled(!1),r.setStencilWriteMask(0),r.setBlendingEnabled(!0),r.setBlendFunctionSeparate(1,771,1,771),r.setColorMask(!0,!0,!0,!0);const h=t.isSome(n)?n:"normal";this._blendEffect.draw(e,this._fbos.blend.colorTexture,9728,h,s)}},n.renderLayers=function(e){if(e.bindFramebuffer(this._prevFBO),!this._fbos)return;const t=this._getOutputFBO();e.setStencilTestEnabled(!1),e.setStencilWriteMask(0),this.blitTexture(e,t.colorTexture,9728)},n.dispose=function(){if(this.materialManager.dispose(),this.textureManager.dispose(),this._blitRenderer&&(this._blitRenderer.dispose(),this._blitRenderer=null),this._brushCache&&(this._brushCache.forEach((e=>e.dispose())),this._brushCache.clear(),this._brushCache=null),this._fbos)for(const e in this._fbos)this._fbos[e]&&this._fbos[e].dispose();if(this.effects)for(const e in this.effects)this.effects[e]&&this.effects[e].dispose();this._vtlMaterialManager&&(this._vtlMaterialManager.dispose(),this._vtlMaterialManager=null),this._prevFBO=null},n.getGeometryBrush=function(e){const t=C[e];let s=this._brushCache.get(t);return void 0===s&&(s=new t,this._brushCache.set(t,s)),this._brushCache.get(t)},n.renderObject=function(e,t,s,r){const n=u.brushes[s];if(!n)return null;let i=this._brushCache.get(n);void 0===i&&(i=new n,this._brushCache.set(n,i)),i.prepareState(e,t,r),i.draw(e,t,r)},n.renderObjects=function(e,t,s,r){const n=u.brushes[s];if(!n)return null;let i=this._brushCache.get(n);void 0===i&&(i=new n,this._brushCache.set(n,i)),i.drawMany(e,t,r)},n.registerRenderPass=function(e){const t=e.brushes.map((e=>(this._brushCache.has(e)||this._brushCache.set(e,new e),this._brushCache.get(e))));return new m(t,e)},n.setHighlightOptions=function(e){this.effects.highlight.setHighlightOptions(e)},n.blitTexture=function(e,t,s,r=1){e.setBlendingEnabled(!0),e.setBlendFunctionSeparate(1,771,1,771),e.setColorMask(!0,!0,!0,!0),this._blitRenderer.render(e,t,s,r)},n.getPostProcessingEffects=function(e){return this._effectsManager.getPostProcessingEffects(e)},n._getOutputFBO=function(){return null!=this._renderTarget?this._renderTarget:this._fbos.output},n._applyEffects=function(e,t){const{context:s}=e,r=this._effectsManager.getPostProcessingEffects(t);for(const{postProcessingEffect:n,effect:i}of r)s.bindFramebuffer(this._fbos.blend),n.draw(e,this._fbos.blend,i)},e._createClass(s,[{key:"vectorTilesMaterialManager",get:function(){return this._vtlMaterialManager}}]),s}()}));
