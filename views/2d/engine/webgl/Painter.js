/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../brushes","../vectorTiles/shaders/VTLMaterialManager","./BitBlitRenderer","./enums","./MaterialManager","./TextureManager","./effects/AnimationEffect","./effects/BlendEffect","./effects/FeatureEffect","./effects/HighlightEffect","./effects/HittestEffect","./effects/HittestEffectVTL","./effects/post-processing/EffectManager","./painter/RenderPass","../../../webgl/enums","../../../webgl/FramebufferObject","../../../webgl/Renderbuffer"],(function(e,t,s,r,i,n,a,o,f,h,c,l,u,d,b,_,g,E,T){"use strict";const p={[n.WGLGeometryType.FILL]:s.brushes.fill,[n.WGLGeometryType.LINE]:s.brushes.line,[n.WGLGeometryType.MARKER]:s.brushes.marker,[n.WGLGeometryType.TEXT]:s.brushes.text};function F(e,s,r,i){return e!==n.WGLDrawPhase.HIGHLIGHT&&(1!==i||t.isSome(s)&&"normal"!==s||t.isSome(r)&&r.length>0)}return function(){function M(e,t,s){this.context=e,this._blitRenderer=new i.BitBlitRenderer,this._brushCache=new Map,this._vtlMaterialManager=new r,this._blendEffect=new h.BlendEffect,this._fboPool=[],this.effects={highlight:new l,hittest:new u.HittestEffect,hittestVTL:new d.HittestEffectVTL,integrate:new f.AnimationEffect,insideEffect:new c.FeatureEffect("inside"),outsideEffect:new c.FeatureEffect("outside")},this.materialManager=new a(e),this.textureManager=new o(t,s),this._effectsManager=new b.EffectManager(t)}var B=M.prototype;return B.getRenderTarget=function(){return this._renderTarget},B.setRenderTarget=function(e){this._renderTarget=e},B.getFbos=function(e,t){if(e!==this._lastWidth||t!==this._lastHeight){if(this._lastWidth=e,this._lastHeight=t,this._fbos){for(const s in this._fbos)this._fbos[s].resize(e,t);return this._fbos}const s={target:g.TextureType.TEXTURE_2D,pixelFormat:g.PixelFormat.RGBA,dataType:g.PixelType.UNSIGNED_BYTE,samplingMode:g.TextureSamplingMode.NEAREST,wrapMode:g.TextureWrapMode.CLAMP_TO_EDGE,width:e,height:t},r={colorTarget:g.TargetType.TEXTURE,depthStencilTarget:g.DepthStencilTargetType.DEPTH_STENCIL_RENDER_BUFFER},i=new T.Renderbuffer(this.context,{width:e,height:t,internalFormat:g.RenderbufferFormat.DEPTH_STENCIL});this._stencilBuf=i,this._fbos={output:new E.FramebufferObject(this.context,r,s,i),blend:new E.FramebufferObject(this.context,r,s,i),effect0:new E.FramebufferObject(this.context,r,s,i)}}return this._fbos},B.acquireFbo=function(e,t){let s;s=this._fboPool.length>0?this._fboPool.pop():new E.FramebufferObject(this.context,{colorTarget:g.TargetType.TEXTURE,depthStencilTarget:g.DepthStencilTargetType.DEPTH_STENCIL_RENDER_BUFFER},{target:g.TextureType.TEXTURE_2D,pixelFormat:g.PixelFormat.RGBA,dataType:g.PixelType.UNSIGNED_BYTE,samplingMode:g.TextureSamplingMode.NEAREST,wrapMode:g.TextureWrapMode.CLAMP_TO_EDGE,width:e,height:t},this._stencilBuf);const r=s.descriptor;return r.width===e&&r.height===t||s.resize(e,t),s},B.releaseFbo=function(e){this._fboPool.push(e)},B.getSharedStencilBuffer=function(){return this._stencilBuf},B.beforeRenderLayers=function(e,s=null){const{width:r,height:i}=e.getViewport();this._prevFBO=e.getBoundFramebufferObject();const n=this.getFbos(r,i);if(e.bindFramebuffer(n.output),e.setColorMask(!0,!0,!0,!0),e.setDepthWriteEnabled(!0),t.isSome(s)){const{r:t,g:r,b:i,a:n}=s.color;e.setClearColor(n*t/255,n*r/255,n*i/255,n)}else e.setClearColor(0,0,0,0);e.setClearDepth(1),e.clear(e.gl.COLOR_BUFFER_BIT|e.gl.DEPTH_BUFFER_BIT),e.setDepthWriteEnabled(!1)},B.beforeRenderLayer=function(e,t,s){const{context:r,blendMode:i,effects:n,requireFBO:a,drawPhase:o}=e;if(a||F(o,i,n,s))r.bindFramebuffer(this._fbos.blend),r.setColorMask(!0,!0,!0,!0),r.setClearColor(0,0,0,0),r.setDepthWriteEnabled(!0),r.setClearDepth(1),r.clear(r.gl.COLOR_BUFFER_BIT|r.gl.DEPTH_BUFFER_BIT),r.setDepthWriteEnabled(!1);else{const e=this._getOutputFBO();r.bindFramebuffer(e)}r.setDepthWriteEnabled(!1),r.setDepthTestEnabled(!1),r.setStencilTestEnabled(!0),r.setClearStencil(t),r.setStencilWriteMask(255),r.clear(r.gl.STENCIL_BUFFER_BIT)},B.compositeLayer=function(e,s){const{context:r,blendMode:i,effects:a,requireFBO:o,drawPhase:f}=e;if(o||F(f,i,a,s)){t.isSome(a)&&a.length>0&&f===n.WGLDrawPhase.MAP&&this._applyEffects(e,a);const o=this._getOutputFBO();r.bindFramebuffer(o),r.setStencilTestEnabled(!1),r.setStencilWriteMask(0),r.setBlendingEnabled(!0),r.setBlendFunctionSeparate(g.BlendFactor.ONE,g.BlendFactor.ONE_MINUS_SRC_ALPHA,g.BlendFactor.ONE,g.BlendFactor.ONE_MINUS_SRC_ALPHA),r.setColorMask(!0,!0,!0,!0);const h=t.isNone(i)||f===n.WGLDrawPhase.HIGHLIGHT?"normal":i;this._blendEffect.draw(e,this._fbos.blend.colorTexture,g.TextureSamplingMode.NEAREST,h,s)}},B.renderLayers=function(e){if(e.bindFramebuffer(this._prevFBO),!this._fbos)return;const t=this._getOutputFBO();e.setStencilTestEnabled(!1),e.setStencilWriteMask(0),this.blitTexture(e,t.colorTexture,g.TextureSamplingMode.NEAREST)},B.dispose=function(){if(this.materialManager.dispose(),this.textureManager.dispose(),this._blitRenderer&&(this._blitRenderer.dispose(),this._blitRenderer=null),this._brushCache&&(this._brushCache.forEach((e=>e.dispose())),this._brushCache.clear(),this._brushCache=null),this._fbos)for(const e in this._fbos)this._fbos[e]&&this._fbos[e].dispose();for(const e of this._fboPool)e.dispose();if(this._fboPool.length=0,this.effects)for(const e in this.effects)this.effects[e]&&this.effects[e].dispose();this._effectsManager.dispose(),this._vtlMaterialManager&&(this._vtlMaterialManager.dispose(),this._vtlMaterialManager=null),this._prevFBO=null},B.getGeometryBrush=function(e){const t=p[e];let s=this._brushCache.get(t);return void 0===s&&(s=new t,this._brushCache.set(t,s)),this._brushCache.get(t)},B.renderObject=function(e,t,r,i){const n=s.brushes[r];if(!n)return null;let a=this._brushCache.get(n);void 0===a&&(a=new n,this._brushCache.set(n,a)),a.prepareState(e,t,i),a.draw(e,t,i)},B.renderObjects=function(e,t,r,i){const n=s.brushes[r];if(!n)return null;let a=this._brushCache.get(n);void 0===a&&(a=new n,this._brushCache.set(n,a)),a.drawMany(e,t,i)},B.registerRenderPass=function(e){const t=e.brushes.map((e=>(this._brushCache.has(e)||this._brushCache.set(e,new e),this._brushCache.get(e))));return new _(t,e)},B.setHighlightOptions=function(e){this.effects.highlight.setHighlightOptions(e)},B.blitTexture=function(e,t,s,r=1){e.setBlendingEnabled(!0),e.setBlendFunctionSeparate(g.BlendFactor.ONE,g.BlendFactor.ONE_MINUS_SRC_ALPHA,g.BlendFactor.ONE,g.BlendFactor.ONE_MINUS_SRC_ALPHA),e.setColorMask(!0,!0,!0,!0),this._blitRenderer.render(e,t,s,r)},B.getPostProcessingEffects=function(e){return this._effectsManager.getPostProcessingEffects(e)},B._getOutputFBO=function(){return null!=this._renderTarget?this._renderTarget:this._fbos.output},B._applyEffects=function(e,t){const{context:s}=e,r=this._effectsManager.getPostProcessingEffects(t);for(const{postProcessingEffect:i,effect:n}of r)s.bindFramebuffer(this._fbos.blend),i.draw(e,this._fbos.blend,n)},e._createClass(M,[{key:"vectorTilesMaterialManager",get:function(){return this._vtlMaterialManager}}]),M}()}));
