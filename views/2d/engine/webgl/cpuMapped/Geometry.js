/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../../../../core/maybe","../../../../webgl/BufferObject","../../../../webgl/FramebufferObject","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/has","../../../../webgl/checkWebGLError","../../../../webgl/enums","../../../../../chunks/builtins","../../../../webgl/renderState","../../../../webgl/Texture","../../../../webgl/VertexArrayObject","../FeatureDisplayList","./Buffer","./DisplayRecordReader"],(function(e,t,r,i,s,n,o,f,d,u,h,c,_,l,a){"use strict";let x=function(){function e(e,t){this._indicesInvalid=!1,this.geometryType=e}var r=e.prototype;return r.destroy=function(){this._vao&&(this._vao.dispose(),this._vao=null)},r.insert=function(e,r,i){if(!e.records.byteLength)return;const s=e.stride;if(this._vertexBuffer&&this._indexBuffer){const i=4*e.indices.byteLength,n=e.vertices.byteLength/s;this._indexBuffer.ensure(i),this._vertexBuffer.ensure(n);const{vertices:o,indices:f}=e,d=a.DisplayRecordReader.from(e.records),u=this._vertexBuffer.insert(o,0,o.byteLength/s,0),h=this._indexBuffer.insert(f,0,f.byteLength/4,u);if(d.forEach((e=>{e.indexFrom+=h,e.vertexFrom+=u})),t.unwrapOrThrow(this._records,"Expected records to be defined").link(d),r)this._indicesInvalid=!0;else if(this._displayList){const e=d.getCursor();for(;e.next();)this._displayList.addRecord(e)}}else{const t=4*e.indices.byteLength,i=e.vertices.byteLength/s,n=s/Uint32Array.BYTES_PER_ELEMENT;this._records=a.DisplayRecordReader.from(e.records),this._indexBuffer=new l.Buffer("index",t,1),this._vertexBuffer=new l.Buffer("vertex",i,n),this._indexBuffer.insert(e.indices,0,e.indices.byteLength/4,0),this._vertexBuffer.insert(e.vertices,0,e.vertices.byteLength/s,0),r&&(this._indicesInvalid=!0)}},r.remove=function(e){if(!t.isNone(this._records))for(const t of e){const e=this._records.getCursor();if(!e.lookup(t))continue;const r=e.indexFrom,i=e.vertexFrom;let s=e.indexCount,n=e.vertexCount;for(;e.next()&&e.id===t;)s+=e.indexCount,n+=e.vertexCount;this._indexBuffer.free(r,s),this._vertexBuffer.free(i,n,!0),this._records.delete(t)}},r.draw=function(e,r,i,s,n){if(!this._vertexBuffer||!this._indexBuffer||t.isNone(this._records))return;if((t.isNone(this._vertexBuffer.gpu)||t.isNone(this._indexBuffer.gpu))&&(this._vao&&(this._vao.dispose(),this._vao=null),this._vertexBuffer.gpu=null,this._indexBuffer.gpu=null),this._vertexBuffer.upload(e),this._indexBuffer.upload(e),!this._vao){const t=this._vertexBuffer.gpu,s=this._indexBuffer.gpu;if(!s||!t)return;this._vao=new c(e,i,r,{geometry:t},s)}const o=this._vao,f=s*Uint32Array.BYTES_PER_ELEMENT;e.bindVAO(o),e.drawElements(4,n,5125,f)},r.forEachCommand=function(e){if(!t.isNone(this._records)){if(this._sortIndices(this._records),!this._displayList){const e=this._cursorIndexOrder;this._displayList=_.FeatureDisplayList.from(this,this.geometryType,this._records.getCursor(),e)}this._displayList.forEach(e)}},r._sortIndices=function(e){if(!this._indicesInvalid)return;this._indicesInvalid=!1;let t=0;const r=e.getCursor(),i=this._indexBuffer.getBuffer(),s=[],n=[],o=[];for(;r.next();)n.push(r.index),o.push(r.sortKey),s.push(r.id);n.sort(((e,t)=>{const r=o[t],i=o[e];return i===r?s[t]-s[e]:r-i}));const f=e.getCursor();for(const d of n){if(!f.seekIndex(d))throw new Error("Expected to find index");const{indexFrom:e,indexCount:r}=f;f.indexFrom=t;for(let s=0;s<r;s++)this._indexBuffer.set(t++,i[e+s])}this._cursorIndexOrder=n,this._displayList=null},e}();e.Geometry=x,Object.defineProperty(e,"__esModule",{value:!0})}));
