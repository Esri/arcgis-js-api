/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/maybe","../../../../webgl/BufferObject","../../../../webgl/FramebufferObject","../../../../../core/has","../../../../webgl/checkWebGLError","../../../../webgl/enums","../../../../../chunks/builtins","../../../../webgl/renderState","../../../../webgl/Texture","../../../../webgl/VertexArrayObject","./FreeList"],(function(t,i,e,s,r,n,h,u,c,d,a,f,l){"use strict";const o=32767,p=o<<16|o;let y=function(){function t(t,i,e){const s=new Uint32Array(i*e);this.strideInt=e,this.bufferType=t,this.dirty={start:1/0,end:0},this.gpu=null,this._cpu=s,this.clear()}var r=t.prototype;return r.destroy=function(){e.andThen(this.gpu,(t=>t.dispose()))},r.clear=function(){this.dirty.start=1/0,this.dirty.end=0,this.freeList=new l.FreeList({start:0,end:this._cpu.length/this.strideInt}),this.fillPointer=0},r.ensure=function(t){if(this.maxAvailableSpace()>=t)return;const i=t*this.strideInt;if(i>this._cpu.length-this.fillPointer){e.isSome(this.gpu)&&(this.gpu=null);const t=Math.round(1.5*(this._cpu.length+i)),s=new Uint32Array(t),r=this._cpu.length/this.strideInt,n=t/this.strideInt;this.freeList.free(r,n-r),s.set(this._cpu),this._cpu=s}},r.set=function(t,i){this._cpu[t]!==i&&(this._cpu[t]=i,this.dirty.start=Math.min(t,this.dirty.start),this.dirty.end=Math.max(t,this.dirty.end))},r.getBuffer=function(){if(!this._cpu2||this._cpu2.length!==this._cpu.length){const t=this._cpu.slice();this._cpu2=t}return this._cpu2.set(this._cpu),this._cpu2},r.maxAvailableSpace=function(){return this.freeList.maxAvailableSpace()},r.insert=function(t,i,s,r){const n=s*this.strideInt,h=i*this.strideInt*Uint32Array.BYTES_PER_ELEMENT,u=new Uint32Array(t,h,n),c=e.unwrapOrThrow(this.freeList.firstFit(s),"First fit region must be defined")*this.strideInt,d=n,a=c/this.strideInt-i;if(0!==r)for(let e=0;e<u.length;e++)u[e]+=r;return this._cpu.set(u,c),this.dirty.start=Math.min(this.dirty.start,c),this.dirty.end=Math.max(this.dirty.end,c+d),this.fillPointer=Math.max(this.fillPointer,c+d),a},r.free=function(t,i,e){const s=t*this.strideInt,r=(t+i)*this.strideInt;if(!0===e)for(let n=t;n!==t+i;n++)this._cpu[n*this.strideInt]=p;this.dirty.start=Math.min(this.dirty.start,s),this.dirty.end=Math.max(this.dirty.end,r),this.freeList.free(t,i)},r.upload=function(t){if(this.dirty.end){if(e.isNone(this.gpu))return this.gpu=this._createBuffer(t),this.dirty.start=1/0,void(this.dirty.end=0);this.gpu.setSubData(this._cpu,this.dirty.start,this.dirty.start,this.dirty.end),this.dirty.start=1/0,this.dirty.end=0}},r._createBuffer=function(t){const i=35048;return"index"===this.bufferType?s.createIndex(t,i,this._cpu):s.createVertex(t,i,this._cpu)},i._createClass(t,[{key:"elementSize",get:function(){return this._cpu.length/this.strideInt}},{key:"bufferSize",get:function(){return this._cpu.length/this.strideInt}}]),t}();t.Buffer=y,Object.defineProperty(t,"__esModule",{value:!0})}));
