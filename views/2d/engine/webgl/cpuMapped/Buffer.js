/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/maybe","../../../../webgl/BufferObject","../../../../webgl/FramebufferObject","../../../../../core/has","../../../../webgl/checkWebGLError","../../../../webgl/enums","../../../../../chunks/builtins","../../../../webgl/Texture","../../../../webgl/VertexArrayObject","../BufferPool","./FreeList"],(function(t,i,e,r,s,n,h,u,a,c,d,f,l){"use strict";const o=1.25,p=32767,y=p<<16|p;let _=function(){function t(t,i,e){const r=f.TypedBuffer.create(i*e*Uint32Array.BYTES_PER_ELEMENT);this.strideInt=e,this.bufferType=t,this.dirty={start:1/0,end:0},this.gpu=null,this._cpu=r,this.clear()}var s=t.prototype;return s.destroy=function(){e.andThen(this.gpu,(t=>t.dispose())),e.andThen(this._cpu,(t=>t.destroy())),e.andThen(this._cpu2,(t=>t.destroy()))},s.clear=function(){this.dirty.start=1/0,this.dirty.end=0,this.freeList=new l.FreeList({start:0,end:this._cpu.length/this.strideInt}),this.fillPointer=0},s.ensure=function(t){if(this.maxAvailableSpace()>=t)return;if(t*this.strideInt>this._cpu.length-this.fillPointer){e.isSome(this.gpu)&&(this.gpu=null);const i=this._cpu.length/this.strideInt,r=Math.round((i+t)*o),s=r*this.strideInt;this._cpu.expand(s*Uint32Array.BYTES_PER_ELEMENT),this.freeList.free(i,r-i)}},s.set=function(t,i){this._cpu.array[t]!==i&&(this._cpu.array[t]=i,this.dirty.start=Math.min(t,this.dirty.start),this.dirty.end=Math.max(t,this.dirty.end))},s.getBuffer=function(){if(!this._cpu2){const t=this._cpu.slice();this._cpu2=t}return this._cpu2.length!==this._cpu.length&&this._cpu2.expand(this._cpu.length*this._cpu.array.BYTES_PER_ELEMENT),this._cpu2.set(this._cpu),this._cpu2},s.maxAvailableSpace=function(){return this.freeList.maxAvailableSpace()},s.insert=function(t,i,r,s){const n=r*this.strideInt,h=i*this.strideInt*Uint32Array.BYTES_PER_ELEMENT,u=new Uint32Array(t,h,n),a=e.unwrapOrThrow(this.freeList.firstFit(r),"First fit region must be defined")*this.strideInt,c=n,d=a/this.strideInt-i;if(0!==s)for(let e=0;e<u.length;e++)u[e]+=s;return this._cpu.array.set(u,a),this.dirty.start=Math.min(this.dirty.start,a),this.dirty.end=Math.max(this.dirty.end,a+c),this.fillPointer=Math.max(this.fillPointer,a+c),d},s.free=function(t,i,e){const r=t*this.strideInt,s=(t+i)*this.strideInt;if(!0===e)for(let n=t;n!==t+i;n++)this._cpu.array[n*this.strideInt]=y;this.dirty.start=Math.min(this.dirty.start,r),this.dirty.end=Math.max(this.dirty.end,s),this.freeList.free(t,i)},s.upload=function(t){if(this.dirty.end){if(e.isNone(this.gpu))return this.gpu=this._createBuffer(t),this.dirty.start=1/0,void(this.dirty.end=0);this.gpu.setSubDataFromView(this._cpu.array,this.dirty.start,this.dirty.start,this.dirty.end),this.dirty.start=1/0,this.dirty.end=0}},s._createBuffer=function(t){const i=35048;return"index"===this.bufferType?r.createIndex(t,i,this._cpu.array):r.createVertex(t,i,this._cpu.array)},i._createClass(t,[{key:"elementSize",get:function(){return this._cpu.length/this.strideInt}},{key:"bufferSize",get:function(){return this._cpu.length/this.strideInt}}]),t}();t.Buffer=_,Object.defineProperty(t,"__esModule",{value:!0})}));
