// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","./mesh/templates/util"],(function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ThinTessellationCallbacks=e.StandardTessellationCallbacks=e.splitVertex=e.cleanup=e.tessellate=e.TessellationState=void 0;var i,n=function(){this.closed=void 0,this.isFirstVertex=void 0,this.isLastVertex=void 0,this.isCap=void 0,this.currentVertex={x:void 0,y:void 0},this.inbound={x:void 0,y:void 0},this.outbound={x:void 0,y:void 0},this.prevNormal={x:void 0,y:void 0},this.nextNormal={x:void 0,y:void 0},this.bisector={x:void 0,y:void 0},this.leftInner={x:void 0,y:void 0},this.rightInner={x:void 0,y:void 0},this.leftOuter={x:void 0,y:void 0},this.rightOuter={x:void 0,y:void 0}};function x(){if(h.cosine<y.innerBisectorAutoSplitThreshold){h.splitInner=!0,h.gapInner=!0;var t=Math.max(y.innerBisectorAutoSplitThreshold,h.cosine),e=Math.sqrt(1-t*t)/t;h.leftInner.x=h.nextNormal.x+h.sign*e*h.outbound.x,h.leftInner.y=h.nextNormal.y+h.sign*e*h.outbound.y,h.rightInner.x=h.prevNormal.x-h.sign*e*h.inbound.x,h.rightInner.y=h.prevNormal.y-h.sign*e*h.inbound.y}else y.enableInnerBisectorSplit&&(h.splitInner=!0,h.gapInner=!1,h.leftInner.x=h.rightInner.x=h.bisector.x/h.cosine,h.leftInner.y=h.rightInner.y=h.bisector.y/h.cosine);if(h.cosine<y.outerBisectorAutoSplitThreshold){h.splitOuter=!0,h.gapOuter=!0;t=Math.max(y.outerBisectorAutoSplitThreshold,h.cosine),e=Math.sqrt(1-t*t)/t;h.leftOuter.x=h.prevNormal.x-h.sign*e*h.inbound.x,h.leftOuter.y=h.prevNormal.y-h.sign*e*h.inbound.y,h.rightOuter.x=h.nextNormal.x+h.sign*e*h.outbound.x,h.rightOuter.y=h.nextNormal.y+h.sign*e*h.outbound.y}else y.enableOuterBisectorSplit&&(h.splitOuter=!0,h.gapOuter=!1,h.leftOuter.x=h.rightOuter.x=h.bisector.x/h.cosine,h.leftOuter.y=h.rightOuter.y=h.bisector.y/h.cosine)}e.TessellationState=n,e.tessellate=function(t,e,r){y.trackDistance=null!=e.trackDistance&&e.trackDistance,y.wrapDistance=null!=e.wrapDistance?e.wrapDistance:65535,y.thin=null!=e.thin&&e.thin,y.initialDistance=null!=e.initialDistance?e.initialDistance:0,y.enableOuterBisectorSplit=null!=e.enableOuterBisectorSplit&&e.enableOuterBisectorSplit,y.outerBisectorAutoSplitThreshold=null!=e.outerBisectorAutoSplitThreshold?e.outerBisectorAutoSplitThreshold:0,y.enableInnerBisectorSplit=null!=e.enableOuterBisectorSplit&&e.enableOuterBisectorSplit,y.innerBisectorAutoSplitThreshold=null!=e.innerBisectorAutoSplitThreshold?e.innerBisectorAutoSplitThreshold:0,i=t,o=r,d=0,s=0,u=0,l=!1,c=null,a=null,h.currentVertex.x=null,h.currentVertex.y=null,h.distance=y.initialDistance;var n=i[0],x=i[i.length-1];h.canSplit=!1,h.closed=n.x===x.x&&n.y===x.y,i.length<2||2===i.length&&h.closed||(y.thin?y.trackDistance?function(){b(),V(),f(1);for(;s-u>y.wrapDistance||d<i.length;)b(),V(),f(2),o.bridge(h),h.leftExit0=h.rightExit0,h.leftExit2=h.rightExit2}():function(){for(;d<i.length;){if(d>0&&(h.inbound.x=h.outbound.x,h.inbound.y=h.outbound.y),d<i.length-1){h.outbound.x=i[d+1].x-i[d].x,h.outbound.y=i[d+1].y-i[d].y;var t=Math.sqrt(h.outbound.x*h.outbound.x+h.outbound.y*h.outbound.y);h.distance+=t,h.outbound.x/=t,h.outbound.y/=t}else h.outbound.x=h.inbound.x,h.outbound.y=h.inbound.y;0===d&&(h.inbound.x=h.outbound.x,h.inbound.y=h.outbound.y),h.currentVertex.x=i[d].x,h.currentVertex.y=i[d].y,h.prevNormal.x=-h.inbound.y,h.prevNormal.y=h.inbound.x,h.nextNormal.x=-h.outbound.y,h.nextNormal.y=h.outbound.x,0===d?(o.vertex(h),h.leftEntry0=h.entry0,h.leftEntry2=h.entry2,h.leftExit0=h.exit0,h.leftExit2=h.exit2):(o.vertex(h),h.rightEntry0=h.entry0,h.rightEntry2=h.entry2,h.rightExit0=h.exit0,h.rightExit2=h.exit2,o.bridge(h),h.leftExit0=h.rightExit0,h.leftExit2=h.rightExit2),++d}}():y.enableOuterBisectorSplit||y.outerBisectorAutoSplitThreshold>0||y.enableInnerBisectorSplit||y.innerBisectorAutoSplitThreshold>0?(h.canSplit=!0,function(){b(),g(),h.splitInner=h.gapInner=h.splitOuter=h.gapOuter=!1,p(1),h.closure0=h.leftEntry0,h.closure1=h.leftEntry1,h.closure2=h.leftEntry2;for(;s-u>y.wrapDistance||d<i.length-1||d<i.length&&(!h.closed||y.trackDistance);)b(),g(),h.splitInner=h.gapInner=h.splitOuter=h.gapOuter=!1,p(2),o.bridge(h),h.leftExit0=h.rightExit0,h.leftExit1=h.rightExit1,h.leftExit2=h.rightExit2;h.closed&&!y.trackDistance&&(h.rightEntry0=h.closure0,h.rightEntry1=h.closure1,h.rightEntry2=h.closure2,o.bridge(h),h.leftExit0=h.rightExit0,h.leftExit1=h.rightExit1,h.leftExit2=h.rightExit2)}()):function(){b(),g(),p(1),h.closure0=h.leftEntry0,h.closure1=h.leftEntry1,h.closure2=h.leftEntry2;for(;s-u>y.wrapDistance||d<i.length-1||d<i.length&&(!h.closed||y.trackDistance);)b(),g(),p(2),o.bridge(h),h.leftExit0=h.rightExit0,h.leftExit1=h.rightExit1,h.leftExit2=h.rightExit2;h.closed&&!y.trackDistance&&(h.rightEntry0=h.closure0,h.rightEntry1=h.closure1,h.rightEntry2=h.closure2,o.bridge(h),h.leftExit0=h.rightExit0,h.leftExit1=h.rightExit1,h.leftExit2=h.rightExit2)}())},e.cleanup=function(){i=null,o=null},e.splitVertex=x;var o,s,u,l,c,a,y={},d=void 0,h=new n;function b(){if(l)return h.distance=0,h.isCap=h.isFirstVertex=h.isLastVertex=!1,void(l=!1);if(0===s)if(h.isFirstVertex=0===d,a=i[d],0===d){if(s=0,h.closed){h.inbound.x=a.x-i[i.length-2].x,h.inbound.y=a.y-i[i.length-2].y;var t=Math.sqrt(h.inbound.x*h.inbound.x+h.inbound.y*h.inbound.y);h.inbound.x/=t,h.inbound.y/=t}}else h.inbound.x=a.x-c.x,h.inbound.y=a.y-c.y,s=Math.sqrt(h.inbound.x*h.inbound.x+h.inbound.y*h.inbound.y),h.inbound.x/=s,h.inbound.y/=s;if(h.distance+s-u<=y.wrapDistance){if(d<i.length-1){h.outbound.x=i[d+1].x-a.x,h.outbound.y=i[d+1].y-a.y;var e=Math.sqrt(h.outbound.x*h.outbound.x+h.outbound.y*h.outbound.y);h.outbound.x/=e,h.outbound.y/=e}else if(h.closed){h.outbound.x=i[1].x-a.x,h.outbound.y=i[1].y-a.y;e=Math.sqrt(h.outbound.x*h.outbound.x+h.outbound.y*h.outbound.y);h.outbound.x/=e,h.outbound.y/=e}else h.outbound.x=h.inbound.x,h.outbound.y=h.inbound.y;return 0!==d||h.closed||(h.inbound.x=h.outbound.x,h.inbound.y=h.outbound.y),++d,h.isLastVertex=d===i.length,h.isCap=!h.closed&&(h.isFirstVertex||h.isLastVertex),h.distance+=s-u,s=0,u=0,l=h.distance+s-u===y.wrapDistance,h.currentVertex.x=a.x,h.currentVertex.y=a.y,c=a,void(a=null)}h.outbound.x=h.inbound.x,h.outbound.y=h.inbound.y,u+=y.wrapDistance-h.distance,h.distance=y.wrapDistance,l=!0;var r=u/s;h.currentVertex.x=(1-r)*c.x+r*a.x,h.currentVertex.y=(1-r)*c.y+r*a.y}function V(){h.prevNormal.x=-h.inbound.y,h.prevNormal.y=h.inbound.x,h.nextNormal.x=-h.outbound.y,h.nextNormal.y=h.outbound.x}function g(){V(),h.bisector.x=h.prevNormal.x+h.nextNormal.x,h.bisector.y=h.prevNormal.y+h.nextNormal.y;var t=Math.sqrt(h.bisector.x*h.bisector.x+h.bisector.y*h.bisector.y);if(t<.001)return h.bisector.x=void 0,h.bisector.y=void 0,h.cosine=0,void(h.sign=void 0);h.bisector.x/=t,h.bisector.y/=t,h.cosine=h.bisector.x*h.nextNormal.x+h.bisector.y*h.nextNormal.y,h.sign=h.prevNormal.x*h.nextNormal.y-h.prevNormal.y*h.nextNormal.x>=0?1:-1}function p(t){o.vertex(h),1===t?(h.leftEntry0=h.entry0,h.leftEntry1=h.entry1,h.leftEntry2=h.entry2,h.leftExit0=h.exit0,h.leftExit1=h.exit1,h.leftExit2=h.exit2):2===t&&(h.rightEntry0=h.entry0,h.rightEntry1=h.entry1,h.rightEntry2=h.entry2,h.rightExit0=h.exit0,h.rightExit1=h.exit1,h.rightExit2=h.exit2)}function f(t){o.vertex(h),1===t?(h.leftEntry0=h.entry0,h.leftEntry2=h.entry2,h.leftExit0=h.exit0,h.leftExit2=h.exit2):2===t&&(h.rightEntry0=h.entry0,h.rightEntry2=h.entry2,h.rightExit0=h.exit0,h.rightExit2=h.exit2)}var v=function(){function t(t,e){this.writeVertex=t,this.writeTriangle=e,this.capType=0,this.joinType=2,this.miterLimitCosine=r.getLimitCosine(2),this.roundLimitCosine=Math.cos(23*Math.PI/180),this.almostParallelCosine=.97,this.radsPerSlice=.8,this.textured=!1,this.joinOnUTurn=!1}return t.prototype.vertex=function(t){var e=2===this.joinType?this.miterLimitCosine:this.roundLimitCosine,r=t.isCap&&0!==this.capType,i=!1;t.cosine>this.almostParallelCosine?(t.exit0=t.entry0=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,t.bisector.x/t.cosine,t.bisector.y/t.cosine,0,-1,t.distance),t.exit2=t.entry2=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,-t.bisector.x/t.cosine,-t.bisector.y/t.cosine,0,1,t.distance)):t.cosine<1-this.almostParallelCosine?(i=!t.isCap&&this.joinOnUTurn,t.entry0=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,t.prevNormal.x,t.prevNormal.y,0,-1,t.distance),t.entry2=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,-t.prevNormal.x,-t.prevNormal.y,0,1,t.distance),t.exit0=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,t.nextNormal.x,t.nextNormal.y,0,-1,t.distance),t.exit2=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,-t.nextNormal.x,-t.nextNormal.y,0,1,t.distance)):t.canSplit?(x(),t.sign>0?(t.splitInner?(t.exit0=this.writeVertex(t.currentVertex.x,t.currentVertex.y,t.outbound.x,t.outbound.y,t.leftInner.x,t.leftInner.y,0,-1,t.distance),t.entry0=this.writeVertex(t.currentVertex.x,t.currentVertex.y,t.inbound.x,t.inbound.y,t.rightInner.x,t.rightInner.y,0,-1,t.distance)):t.exit0=t.entry0=this.writeVertex(t.currentVertex.x,t.currentVertex.y,t.inbound.x,t.inbound.y,t.bisector.x/t.cosine,t.bisector.y/t.cosine,0,-1,t.distance),t.cosine<e?(i=!t.isCap,t.entry2=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,-t.prevNormal.x,-t.prevNormal.y,0,1,t.distance),t.exit2=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,-t.nextNormal.x,-t.nextNormal.y,0,1,t.distance)):t.splitOuter?(i=i||t.gapOuter,t.entry2=this.writeVertex(t.currentVertex.x,t.currentVertex.y,t.inbound.x,t.inbound.y,-t.leftOuter.x,-t.leftOuter.y,0,1,t.distance),t.exit2=this.writeVertex(t.currentVertex.x,t.currentVertex.y,t.outbound.x,t.outbound.y,-t.rightOuter.x,-t.rightOuter.y,0,1,t.distance)):t.entry2=t.exit2=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,-t.bisector.x/t.cosine,-t.bisector.y/t.cosine,0,1,t.distance)):(t.splitInner?(t.exit2=this.writeVertex(t.currentVertex.x,t.currentVertex.y,t.outbound.x,t.outbound.y,-t.leftInner.x,-t.leftInner.y,0,1,t.distance),t.entry2=this.writeVertex(t.currentVertex.x,t.currentVertex.y,t.inbound.x,t.inbound.y,-t.rightInner.x,-t.rightInner.y,0,1,t.distance)):t.exit2=t.entry2=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,-t.bisector.x/t.cosine,-t.bisector.y/t.cosine,0,1,t.distance),t.cosine<e?(i=!t.isCap,t.entry0=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,t.prevNormal.x,t.prevNormal.y,0,-1,t.distance),t.exit0=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,t.nextNormal.x,t.nextNormal.y,0,-1,t.distance)):t.splitOuter?(i=i||t.gapOuter,t.entry0=this.writeVertex(t.currentVertex.x,t.currentVertex.y,t.inbound.x,t.inbound.y,t.leftOuter.x,t.leftOuter.y,0,-1,t.distance),t.exit0=this.writeVertex(t.currentVertex.x,t.currentVertex.y,t.outbound.x,t.outbound.y,t.rightOuter.x,t.rightOuter.y,0,-1,t.distance)):t.exit0=t.entry0=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,t.bisector.x/t.cosine,t.bisector.y/t.cosine,0,-1,t.distance))):t.sign>0?(t.exit0=t.entry0=this.writeVertex(t.currentVertex.x,t.currentVertex.y,t.inbound.x,t.inbound.y,t.bisector.x/t.cosine,t.bisector.y/t.cosine,0,-1,t.distance),t.cosine<e?(i=!t.isCap,t.entry2=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,-t.prevNormal.x,-t.prevNormal.y,0,1,t.distance),t.exit2=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,-t.nextNormal.x,-t.nextNormal.y,0,1,t.distance)):t.entry2=t.exit2=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,-t.bisector.x/t.cosine,-t.bisector.y/t.cosine,0,1,t.distance)):(t.exit2=t.entry2=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,-t.bisector.x/t.cosine,-t.bisector.y/t.cosine,0,1,t.distance),t.cosine<e?(i=!t.isCap,t.entry0=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,t.prevNormal.x,t.prevNormal.y,0,-1,t.distance),t.exit0=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,t.nextNormal.x,t.nextNormal.y,0,-1,t.distance)):t.exit0=t.entry0=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,t.bisector.x/t.cosine,t.bisector.y/t.cosine,0,-1,t.distance));var n,o=t.canSplit&&(t.splitInner||t.splitOuter);if(n=t.entry1=t.exit1=o||i||r?this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,0,0,0,0,t.distance):null,i&&1!==this.joinType)this.writeTriangle(n,t.sign>0?t.exit2:t.entry0,t.sign>0?t.entry2:t.exit0);else if(r&&1===this.capType||i&&1===this.joinType){var s,u=void 0,l=void 0,c=void 0,a=void 0,y=void 0,d=void 0;if(t.isCap)d=(s=Math.PI)/(y=Math.ceil(s/this.radsPerSlice)),t.isFirstVertex?(u=t.prevNormal.x,l=t.prevNormal.y,c=t.entry0,a=t.entry2):t.isLastVertex&&(u=-t.nextNormal.x,l=-t.nextNormal.y,c=t.exit2,a=t.exit0);else d=(s=2*Math.acos(t.cosine))/(y=Math.ceil(s/this.radsPerSlice)),u=t.sign>0?-t.prevNormal.x:t.nextNormal.x,l=t.sign>0?-t.prevNormal.y:t.nextNormal.y,c=t.sign>0?t.entry2:t.exit0,a=t.sign>0?t.exit2:t.entry0;var h,b=Math.cos(d),V=Math.sin(d),g=V*u+b*l;u=b*u-V*l,l=g;for(var p=void 0,f=0;f<y;++f){if(h=p,f<y-1)if(t.isCap){var v=t.isFirstVertex?-1:1;p=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,u,l,v,0,t.distance)}else p=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,u,l,0,t.sign,t.distance);this.writeTriangle(0===f?c:h,n,f===y-1?a:p);var E=V*u+b*l;u=b*u-V*l,l=E}}else if(r&&2===this.capType){var m=t.isFirstVertex?1:-1,N=void 0,w=void 0;this.textured?(N=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,t.prevNormal.x-m*t.inbound.x,t.prevNormal.y-m*t.inbound.y,-m,-1,t.distance),w=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,-t.prevNormal.x-m*t.inbound.x,-t.prevNormal.y-m*t.inbound.y,-m,1,t.distance)):(N=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,t.prevNormal.x-m*t.inbound.x,t.prevNormal.y-m*t.inbound.y,0,-1,t.distance),w=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,-t.prevNormal.x-m*t.inbound.x,-t.prevNormal.y-m*t.inbound.y,0,1,t.distance)),m>0?(this.writeTriangle(n,t.entry2,w),this.writeTriangle(n,w,N),this.writeTriangle(n,N,t.entry0)):(this.writeTriangle(n,w,t.exit2),this.writeTriangle(n,N,w),this.writeTriangle(n,t.exit0,N))}},t.prototype.bridge=function(t){this.writeTriangle(t.leftExit0,t.rightEntry0,null!=t.leftExit1?t.leftExit1:t.leftExit2),this.writeTriangle(t.rightEntry0,null!=t.rightEntry1?t.rightEntry1:t.rightEntry2,null!=t.leftExit1?t.leftExit1:t.leftExit2),null!=t.leftExit1&&null!=t.rightEntry1?(this.writeTriangle(t.leftExit1,t.rightEntry1,t.leftExit2),this.writeTriangle(t.rightEntry1,t.rightEntry2,t.leftExit2)):null!=t.leftExit1?this.writeTriangle(t.leftExit1,t.rightEntry2,t.leftExit2):null!=t.rightEntry1&&this.writeTriangle(t.rightEntry1,t.rightEntry2,t.leftExit2)},t}();e.StandardTessellationCallbacks=v;var E=function(){function t(t,e){this.writeVertex=t,this.writeTriangle=e}return t.prototype.vertex=function(t){t.entry0=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,t.prevNormal.x,t.prevNormal.y,0,-1,t.distance),t.entry2=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,-t.prevNormal.x,-t.prevNormal.y,0,1,t.distance),t.exit0=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,t.nextNormal.x,t.nextNormal.y,0,-1,t.distance),t.exit2=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,-t.nextNormal.x,-t.nextNormal.y,0,1,t.distance)},t.prototype.bridge=function(t){this.writeTriangle(t.leftExit0,t.rightEntry0,t.leftExit2),this.writeTriangle(t.rightEntry0,t.rightEntry2,t.leftExit2)},t}();e.ThinTessellationCallbacks=E}));