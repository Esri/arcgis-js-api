// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../../symbols/cim/enums","./mesh/templates/util"],function(t,e,w,r){Object.defineProperty(e,"__esModule",{value:!0});var x,i=function(){this.closed=void 0,this.isFirstVertex=void 0,this.isLastVertex=void 0,this.isCap=void 0,this.currentVertex={x:void 0,y:void 0},this.inbound={x:void 0,y:void 0},this.outbound={x:void 0,y:void 0},this.prevNormal={x:void 0,y:void 0},this.nextNormal={x:void 0,y:void 0},this.bisector={x:void 0,y:void 0},this.leftInner={x:void 0,y:void 0},this.rightInner={x:void 0,y:void 0},this.leftOuter={x:void 0,y:void 0},this.rightOuter={x:void 0,y:void 0}};function T(){if(h.cosine<a.innerBisectorAutoSplitThreshold){h.splitInner=!0,h.gapInner=!0;var t=Math.max(a.innerBisectorAutoSplitThreshold,h.cosine),e=Math.sqrt(1-t*t)/t;h.leftInner.x=h.nextNormal.x+h.sign*e*h.outbound.x,h.leftInner.y=h.nextNormal.y+h.sign*e*h.outbound.y,h.rightInner.x=h.prevNormal.x-h.sign*e*h.inbound.x,h.rightInner.y=h.prevNormal.y-h.sign*e*h.inbound.y}else a.enableInnerBisectorSplit&&(h.splitInner=!0,h.gapInner=!1,h.leftInner.x=h.rightInner.x=h.bisector.x/h.cosine,h.leftInner.y=h.rightInner.y=h.bisector.y/h.cosine);if(h.cosine<a.outerBisectorAutoSplitThreshold){h.splitOuter=!0,h.gapOuter=!0;t=Math.max(a.outerBisectorAutoSplitThreshold,h.cosine),e=Math.sqrt(1-t*t)/t;h.leftOuter.x=h.prevNormal.x-h.sign*e*h.inbound.x,h.leftOuter.y=h.prevNormal.y-h.sign*e*h.inbound.y,h.rightOuter.x=h.nextNormal.x+h.sign*e*h.outbound.x,h.rightOuter.y=h.nextNormal.y+h.sign*e*h.outbound.y}else a.enableOuterBisectorSplit&&(h.splitOuter=!0,h.gapOuter=!1,h.leftOuter.x=h.rightOuter.x=h.bisector.x/h.cosine,h.leftOuter.y=h.rightOuter.y=h.bisector.y/h.cosine)}e.TessellationState=i,e.tessellate=function(t,e,r){a.trackDistance=null!=e.trackDistance&&e.trackDistance,a.wrapDistance=null!=e.wrapDistance?e.wrapDistance:65535,a.thin=null!=e.thin&&e.thin,a.initialDistance=null!=e.initialDistance?e.initialDistance:0,a.enableOuterBisectorSplit=null!=e.enableOuterBisectorSplit&&e.enableOuterBisectorSplit,a.outerBisectorAutoSplitThreshold=null!=e.outerBisectorAutoSplitThreshold?e.outerBisectorAutoSplitThreshold:0,a.enableInnerBisectorSplit=null!=e.enableOuterBisectorSplit&&e.enableOuterBisectorSplit,a.innerBisectorAutoSplitThreshold=null!=e.innerBisectorAutoSplitThreshold?e.innerBisectorAutoSplitThreshold:0,x=t,o=r,u=s=d=0,l=!1,y=c=null,h.currentVertex.x=null,h.currentVertex.y=null,h.distance=a.initialDistance;var i=x[0],n=x[x.length-1];h.canSplit=!1,h.closed=i.x===n.x&&i.y===n.y,x.length<2||2===x.length&&h.closed||(a.thin?a.trackDistance?function(){for(b(),p(),f(1);s-u>a.wrapDistance||d<x.length;)b(),p(),f(2),o.bridge(h),h.leftExit0=h.rightExit0,h.leftExit2=h.rightExit2}():function(){for(;d<x.length;){if(0<d&&(h.inbound.x=h.outbound.x,h.inbound.y=h.outbound.y),d<x.length-1){h.outbound.x=x[d+1].x-x[d].x,h.outbound.y=x[d+1].y-x[d].y;var t=Math.sqrt(h.outbound.x*h.outbound.x+h.outbound.y*h.outbound.y);h.distance+=t,h.outbound.x/=t,h.outbound.y/=t}else h.outbound.x=h.inbound.x,h.outbound.y=h.inbound.y;0===d&&(h.inbound.x=h.outbound.x,h.inbound.y=h.outbound.y),h.currentVertex.x=x[d].x,h.currentVertex.y=x[d].y,h.prevNormal.x=-h.inbound.y,h.prevNormal.y=h.inbound.x,h.nextNormal.x=-h.outbound.y,h.nextNormal.y=h.outbound.x,h.leftExit2=0===d?(o.vertex(h),h.leftEntry0=h.entry0,h.leftEntry2=h.entry2,h.leftExit0=h.exit0,h.exit2):(o.vertex(h),h.rightEntry0=h.entry0,h.rightEntry2=h.entry2,h.rightExit0=h.exit0,h.rightExit2=h.exit2,o.bridge(h),h.leftExit0=h.rightExit0,h.rightExit2),++d}}():a.enableOuterBisectorSplit||0<a.outerBisectorAutoSplitThreshold||a.enableInnerBisectorSplit||0<a.innerBisectorAutoSplitThreshold?(h.canSplit=!0,function(){for(b(),V(),h.splitInner=h.gapInner=h.splitOuter=h.gapOuter=!1,g(1),h.closure0=h.leftEntry0,h.closure1=h.leftEntry1,h.closure2=h.leftEntry2;s-u>a.wrapDistance||d<x.length-1||d<x.length&&(!h.closed||a.trackDistance);)b(),V(),h.splitInner=h.gapInner=h.splitOuter=h.gapOuter=!1,g(2),o.bridge(h),h.leftExit0=h.rightExit0,h.leftExit1=h.rightExit1,h.leftExit2=h.rightExit2;h.closed&&!a.trackDistance&&(h.rightEntry0=h.closure0,h.rightEntry1=h.closure1,h.rightEntry2=h.closure2,o.bridge(h),h.leftExit0=h.rightExit0,h.leftExit1=h.rightExit1,h.leftExit2=h.rightExit2)}()):function(){for(b(),V(),g(1),h.closure0=h.leftEntry0,h.closure1=h.leftEntry1,h.closure2=h.leftEntry2;s-u>a.wrapDistance||d<x.length-1||d<x.length&&(!h.closed||a.trackDistance);)b(),V(),g(2),o.bridge(h),h.leftExit0=h.rightExit0,h.leftExit1=h.rightExit1,h.leftExit2=h.rightExit2;h.closed&&!a.trackDistance&&(h.rightEntry0=h.closure0,h.rightEntry1=h.closure1,h.rightEntry2=h.closure2,o.bridge(h),h.leftExit0=h.rightExit0,h.leftExit1=h.rightExit1,h.leftExit2=h.rightExit2)}())},e.cleanup=function(){o=x=null},e.splitVertex=T;var o,s,u,l,c,y,a={},d=void 0,h=new i;function b(){if(l)return h.distance=0,h.isCap=h.isFirstVertex=h.isLastVertex=!1,void(l=!1);if(0===s)if(h.isFirstVertex=0===d,y=x[d],0===d){if(s=0,h.closed){h.inbound.x=y.x-x[x.length-2].x,h.inbound.y=y.y-x[x.length-2].y;var t=Math.sqrt(h.inbound.x*h.inbound.x+h.inbound.y*h.inbound.y);h.inbound.x/=t,h.inbound.y/=t}}else h.inbound.x=y.x-c.x,h.inbound.y=y.y-c.y,s=Math.sqrt(h.inbound.x*h.inbound.x+h.inbound.y*h.inbound.y),h.inbound.x/=s,h.inbound.y/=s;if(h.distance+s-u<=a.wrapDistance){if(d<x.length-1){h.outbound.x=x[d+1].x-y.x,h.outbound.y=x[d+1].y-y.y;var e=Math.sqrt(h.outbound.x*h.outbound.x+h.outbound.y*h.outbound.y);h.outbound.x/=e,h.outbound.y/=e}else if(h.closed){h.outbound.x=x[1].x-y.x,h.outbound.y=x[1].y-y.y;e=Math.sqrt(h.outbound.x*h.outbound.x+h.outbound.y*h.outbound.y);h.outbound.x/=e,h.outbound.y/=e}else h.outbound.x=h.inbound.x,h.outbound.y=h.inbound.y;return 0!==d||h.closed||(h.inbound.x=h.outbound.x,h.inbound.y=h.outbound.y),++d,h.isLastVertex=d===x.length,h.isCap=!h.closed&&(h.isFirstVertex||h.isLastVertex),h.distance+=s-u,u=s=0,l=h.distance+s-u===a.wrapDistance,h.currentVertex.x=y.x,h.currentVertex.y=y.y,c=y,void(y=null)}h.outbound.x=h.inbound.x,h.outbound.y=h.inbound.y,u+=a.wrapDistance-h.distance,h.distance=a.wrapDistance,l=!0;var r=u/s;h.currentVertex.x=(1-r)*c.x+r*y.x,h.currentVertex.y=(1-r)*c.y+r*y.y}function p(){h.prevNormal.x=-h.inbound.y,h.prevNormal.y=h.inbound.x,h.nextNormal.x=-h.outbound.y,h.nextNormal.y=h.outbound.x}function V(){p(),h.bisector.x=h.prevNormal.x+h.nextNormal.x,h.bisector.y=h.prevNormal.y+h.nextNormal.y;var t=Math.sqrt(h.bisector.x*h.bisector.x+h.bisector.y*h.bisector.y);if(t<.001)return h.bisector.x=void 0,h.bisector.y=void 0,h.cosine=0,void(h.sign=void 0);h.bisector.x/=t,h.bisector.y/=t,h.cosine=h.bisector.x*h.nextNormal.x+h.bisector.y*h.nextNormal.y,h.sign=0<=h.prevNormal.x*h.nextNormal.y-h.prevNormal.y*h.nextNormal.x?1:-1}function g(t){o.vertex(h),1===t?(h.leftEntry0=h.entry0,h.leftEntry1=h.entry1,h.leftEntry2=h.entry2,h.leftExit0=h.exit0,h.leftExit1=h.exit1,h.leftExit2=h.exit2):2===t&&(h.rightEntry0=h.entry0,h.rightEntry1=h.entry1,h.rightEntry2=h.entry2,h.rightExit0=h.exit0,h.rightExit1=h.exit1,h.rightExit2=h.exit2)}function f(t){o.vertex(h),1===t?(h.leftEntry0=h.entry0,h.leftEntry2=h.entry2,h.leftExit0=h.exit0,h.leftExit2=h.exit2):2===t&&(h.rightEntry0=h.entry0,h.rightEntry2=h.entry2,h.rightExit0=h.exit0,h.rightExit2=h.exit2)}var n=function(){function t(t,e){this.writeVertex=t,this.writeTriangle=e,this.capType=w.CapType.BUTT,this.joinType=w.JoinType.MITER,this.miterLimitCosine=r.getLimitCosine(2),this.roundLimitCosine=Math.cos(23*Math.PI/180),this.almostParallelCosine=.97,this.radsPerSlice=.8,this.textured=!1,this.joinOnUTurn=!1}return t.prototype.vertex=function(t){var e=this.joinType===w.JoinType.MITER?this.miterLimitCosine:this.roundLimitCosine,r=t.isCap&&this.capType!==w.CapType.BUTT,i=!1;t.cosine>this.almostParallelCosine?(t.exit0=t.entry0=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,t.bisector.x/t.cosine,t.bisector.y/t.cosine,0,-1,t.distance),t.exit2=t.entry2=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,-t.bisector.x/t.cosine,-t.bisector.y/t.cosine,0,1,t.distance)):t.cosine<1-this.almostParallelCosine?(i=!t.isCap&&this.joinOnUTurn,t.entry0=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,t.prevNormal.x,t.prevNormal.y,0,-1,t.distance),t.entry2=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,-t.prevNormal.x,-t.prevNormal.y,0,1,t.distance),t.exit0=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,t.nextNormal.x,t.nextNormal.y,0,-1,t.distance),t.exit2=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,-t.nextNormal.x,-t.nextNormal.y,0,1,t.distance)):t.canSplit?(T(),0<t.sign?(t.splitInner?(t.exit0=this.writeVertex(t.currentVertex.x,t.currentVertex.y,t.outbound.x,t.outbound.y,t.leftInner.x,t.leftInner.y,0,-1,t.distance),t.entry0=this.writeVertex(t.currentVertex.x,t.currentVertex.y,t.inbound.x,t.inbound.y,t.rightInner.x,t.rightInner.y,0,-1,t.distance)):t.exit0=t.entry0=this.writeVertex(t.currentVertex.x,t.currentVertex.y,t.inbound.x,t.inbound.y,t.bisector.x/t.cosine,t.bisector.y/t.cosine,0,-1,t.distance),t.cosine<e?(i=!t.isCap,t.entry2=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,-t.prevNormal.x,-t.prevNormal.y,0,1,t.distance),t.exit2=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,-t.nextNormal.x,-t.nextNormal.y,0,1,t.distance)):t.splitOuter?(i=i||t.gapOuter,t.entry2=this.writeVertex(t.currentVertex.x,t.currentVertex.y,t.inbound.x,t.inbound.y,-t.leftOuter.x,-t.leftOuter.y,0,1,t.distance),t.exit2=this.writeVertex(t.currentVertex.x,t.currentVertex.y,t.outbound.x,t.outbound.y,-t.rightOuter.x,-t.rightOuter.y,0,1,t.distance)):t.entry2=t.exit2=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,-t.bisector.x/t.cosine,-t.bisector.y/t.cosine,0,1,t.distance)):(t.splitInner?(t.exit2=this.writeVertex(t.currentVertex.x,t.currentVertex.y,t.outbound.x,t.outbound.y,-t.leftInner.x,-t.leftInner.y,0,1,t.distance),t.entry2=this.writeVertex(t.currentVertex.x,t.currentVertex.y,t.inbound.x,t.inbound.y,-t.rightInner.x,-t.rightInner.y,0,1,t.distance)):t.exit2=t.entry2=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,-t.bisector.x/t.cosine,-t.bisector.y/t.cosine,0,1,t.distance),t.cosine<e?(i=!t.isCap,t.entry0=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,t.prevNormal.x,t.prevNormal.y,0,-1,t.distance),t.exit0=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,t.nextNormal.x,t.nextNormal.y,0,-1,t.distance)):t.splitOuter?(i=i||t.gapOuter,t.entry0=this.writeVertex(t.currentVertex.x,t.currentVertex.y,t.inbound.x,t.inbound.y,t.leftOuter.x,t.leftOuter.y,0,-1,t.distance),t.exit0=this.writeVertex(t.currentVertex.x,t.currentVertex.y,t.outbound.x,t.outbound.y,t.rightOuter.x,t.rightOuter.y,0,-1,t.distance)):t.exit0=t.entry0=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,t.bisector.x/t.cosine,t.bisector.y/t.cosine,0,-1,t.distance))):0<t.sign?(t.exit0=t.entry0=this.writeVertex(t.currentVertex.x,t.currentVertex.y,t.inbound.x,t.inbound.y,t.bisector.x/t.cosine,t.bisector.y/t.cosine,0,-1,t.distance),t.cosine<e?(i=!t.isCap,t.entry2=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,-t.prevNormal.x,-t.prevNormal.y,0,1,t.distance),t.exit2=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,-t.nextNormal.x,-t.nextNormal.y,0,1,t.distance)):t.entry2=t.exit2=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,-t.bisector.x/t.cosine,-t.bisector.y/t.cosine,0,1,t.distance)):(t.exit2=t.entry2=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,-t.bisector.x/t.cosine,-t.bisector.y/t.cosine,0,1,t.distance),t.cosine<e?(i=!t.isCap,t.entry0=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,t.prevNormal.x,t.prevNormal.y,0,-1,t.distance),t.exit0=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,t.nextNormal.x,t.nextNormal.y,0,-1,t.distance)):t.exit0=t.entry0=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,t.bisector.x/t.cosine,t.bisector.y/t.cosine,0,-1,t.distance));var n,x=t.canSplit&&(t.splitInner||t.splitOuter);if(n=t.entry1=t.exit1=x||i||r?this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,0,0,0,0,t.distance):null,i&&this.joinType!==w.JoinType.ROUND)this.writeTriangle(n,0<t.sign?t.exit2:t.entry0,0<t.sign?t.entry2:t.exit0);else if(r&&this.capType===w.CapType.ROUND||i&&this.joinType===w.JoinType.ROUND){var o,s=void 0,u=void 0,l=void 0,c=void 0,y=void 0,a=void 0;if(t.isCap)a=(o=Math.PI)/(y=Math.ceil(o/this.radsPerSlice)),t.isFirstVertex?(s=t.prevNormal.x,u=t.prevNormal.y,l=t.entry0,c=t.entry2):t.isLastVertex&&(s=-t.nextNormal.x,u=-t.nextNormal.y,l=t.exit2,c=t.exit0);else a=(o=2*Math.acos(t.cosine))/(y=Math.ceil(o/this.radsPerSlice)),s=0<t.sign?-t.prevNormal.x:t.nextNormal.x,u=0<t.sign?-t.prevNormal.y:t.nextNormal.y,l=0<t.sign?t.entry2:t.exit0,c=0<t.sign?t.exit2:t.entry0;var d,h=Math.cos(a),b=Math.sin(a),p=b*s+h*u;s=h*s-b*u,u=p;for(var V=void 0,g=0;g<y;++g){if(d=V,g<y-1)if(t.isCap){var f=t.isFirstVertex?-1:1;V=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,s,u,f,0,t.distance)}else V=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,s,u,0,t.sign,t.distance);this.writeTriangle(0===g?l:d,n,g===y-1?c:V);var E=b*s+h*u;s=h*s-b*u,u=E}}else if(r&&this.capType===w.CapType.SQUARE){var v=t.isFirstVertex?1:-1,m=void 0,N=void 0;N=this.textured?(m=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,t.prevNormal.x-v*t.inbound.x,t.prevNormal.y-v*t.inbound.y,-v,-1,t.distance),this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,-t.prevNormal.x-v*t.inbound.x,-t.prevNormal.y-v*t.inbound.y,-v,1,t.distance)):(m=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,t.prevNormal.x-v*t.inbound.x,t.prevNormal.y-v*t.inbound.y,0,-1,t.distance),this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,-t.prevNormal.x-v*t.inbound.x,-t.prevNormal.y-v*t.inbound.y,0,1,t.distance)),0<v?(this.writeTriangle(n,t.entry2,N),this.writeTriangle(n,N,m),this.writeTriangle(n,m,t.entry0)):(this.writeTriangle(n,N,t.exit2),this.writeTriangle(n,m,N),this.writeTriangle(n,t.exit0,m))}},t.prototype.bridge=function(t){this.writeTriangle(t.leftExit0,t.rightEntry0,null!=t.leftExit1?t.leftExit1:t.leftExit2),this.writeTriangle(t.rightEntry0,null!=t.rightEntry1?t.rightEntry1:t.rightEntry2,null!=t.leftExit1?t.leftExit1:t.leftExit2),null!=t.leftExit1&&null!=t.rightEntry1?(this.writeTriangle(t.leftExit1,t.rightEntry1,t.leftExit2),this.writeTriangle(t.rightEntry1,t.rightEntry2,t.leftExit2)):null!=t.leftExit1?this.writeTriangle(t.leftExit1,t.rightEntry2,t.leftExit2):null!=t.rightEntry1&&this.writeTriangle(t.rightEntry1,t.rightEntry2,t.leftExit2)},t}();e.StandardTessellationCallbacks=n;var E=function(){function t(t,e){this.writeVertex=t,this.writeTriangle=e}return t.prototype.vertex=function(t){t.entry0=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,t.prevNormal.x,t.prevNormal.y,0,-1,t.distance),t.entry2=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,-t.prevNormal.x,-t.prevNormal.y,0,1,t.distance),t.exit0=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,t.nextNormal.x,t.nextNormal.y,0,-1,t.distance),t.exit2=this.writeVertex(t.currentVertex.x,t.currentVertex.y,0,0,-t.nextNormal.x,-t.nextNormal.y,0,1,t.distance)},t.prototype.bridge=function(t){this.writeTriangle(t.leftExit0,t.rightEntry0,t.leftExit2),this.writeTriangle(t.rightEntry0,t.rightEntry2,t.leftExit2)},t}();e.ThinTessellationCallbacks=E});