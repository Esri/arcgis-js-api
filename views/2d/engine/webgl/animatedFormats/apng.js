/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../../core/Error","../../../../../core/promiseUtils"],(function(t,e,r){"use strict";const a=new Uint32Array(256);for(let t=0;t<256;t++){let e=t;for(let t=0;t<8;t++)e=0!=(1&e)?3988292384^e>>>1:e>>>1;a[t]=e}const n=new e("Not a PNG"),i=new e("Not an animated PNG"),s=new Uint8Array([137,80,78,71,13,10,26,10]);function h(t){const e=t.constructor===Uint8Array?t:new Uint8Array(t);return!s.some(((t,r)=>t!==e[r]))}let u=function(){function t(){this.width=0,this.height=0,this.numPlays=0,this.playTime=0,this.frames=[],this.paused=!1,this.playing=!1,this.playSpeed=1,this.currentFrameNumber=0,this._lastUsedFrame=-1}t.create=async function(a,n){const i=new t;try{await i._load(a,n)}catch(t){if(!r.isAbortError(t))return new e("invalid-resource",`Could not load PNG: ${t.message}`)}return i};var a=t.prototype;return a.play=function(){this.playing||(this.paused=!1,this.playing=!0,this._play())},a.pause=function(){this.paused=!0,this.playing=!1,clearTimeout(this.timerID)},a.togglePlay=function(){this.paused||!this.playing?this.play():this.pause()},a.bindFrame=function(t,e,r){t.bindTexture(e,r);const a=this.frameChanged();if(!a)return!1;const n=this.currentFrame,i=n.frameData,s=e.descriptor;return(n.left||n.top||n.width!==s.width||n.height!==s.height)&&e.setData(null),e.updateData(0,n.left,n.top,n.width,n.height,i),this.updateUsedFrame(),a},a.frameChanged=function(){return this._lastUsedFrame!==this.currentFrameNumber},a.updateUsedFrame=function(){this._lastUsedFrame=this.currentFrameNumber},a._load=async function(t,a){try{const e=function(t,e){const r=new Uint8Array(e);if(s.some(((t,e)=>t!==r[e])))return n;let a=!1;if(l(r,(t=>!(a="acTL"===t))),!a)return i;const h=[],u=[];let c=null,p=null,g=0;if(l(r,((e,r,a,n)=>{const i=new DataView(r.buffer);switch(e){case"IHDR":c=r.subarray(a+8,a+8+n),t.width=i.getUint32(a+8),t.height=i.getUint32(a+12);break;case"acTL":t.numPlays=i.getUint32(a+8+4);break;case"fcTL":{p&&(t.frames.push(p),g++),p=new o,p.width=i.getUint32(a+8+4),p.height=i.getUint32(a+8+8),p.left=i.getUint32(a+8+12),p.top=i.getUint32(a+8+16);const e=i.getUint16(a+8+20);let r=i.getUint16(a+8+22);0===r&&(r=100),p.delay=1e3*e/r,p.delay<=10&&(p.delay=100),t.playTime+=p.delay,p.disposeOp=i.getUint8(a+8+24),p.blendOp=i.getUint8(a+8+25),p.dataParts=[],0===g&&2===p.disposeOp&&(p.disposeOp=1);break}case"fdAT":p&&p.dataParts.push(r.subarray(a+8+4,a+8+n));break;case"IDAT":p&&p.dataParts.push(r.subarray(a+8,a+8+n));break;case"IEND":u.push(d(r,a,12+n));break;default:h.push(d(r,a,12+n))}})),0===t.frames.length)return i;t.frameCount=t.frames.length;const y=new Blob(h),w=new Blob(u);return t.frames.forEach((t=>{let e=[];e.push(s),c.set(m(t.width),0),c.set(m(t.height),4),e.push(f("IHDR",c)),e.push(y),t.dataParts.forEach((t=>e.push(f("IDAT",t)))),e.push(w),t.data=new Blob(e,{type:"image/png"}),delete t.dataParts,e=null})),t}(this,t);if(e!==this)return e;this._resizeCanvas=document.createElement("canvas"),this._resizeCanvas.width=this.width,this._resizeCanvas.height=this.height,await r.all(this.frames.map((t=>t.createImage(this._resizeCanvas))))}catch(t){if(!r.isAbortError(t))return new e("invalid-resource","Could not parse PNG")}this.play()},a._play=function(){let t,e;if(0===this.playSpeed)return void this.pause();this.playSpeed<0?(this.currentFrameNumber-=1,this.currentFrameNumber<0&&(this.currentFrameNumber=this.frames.length-1),e=this.currentFrameNumber,e-=1,e<0&&(e=this.frames.length-1),t=1*-this.frames[e].delay/this.playSpeed):(this.currentFrameNumber+=1,this.currentFrameNumber%=this.frames.length,t=1*this.frames[this.currentFrameNumber].delay/this.playSpeed);const r=this.frames[this.currentFrameNumber];this.currentFrame={frameData:r.imageData,top:r.top,left:r.left,width:r.width,height:r.height},this.timerID=window.setTimeout((()=>this._play()),t)},t}(),o=function(){function t(){this.left=0,this.top=0,this.width=0,this.height=0,this.delay=0,this.disposeOp=0,this.blendOp=0,this.data=null,this.imageData=null}return t.prototype.createImage=async function(t){if(null===this.imageData)return r.create(((e,r)=>{const a=URL.createObjectURL(this.data),n=document.createElement("img");n.onload=()=>{URL.revokeObjectURL(a),this.imageData=function(t,e){e.width=t.width,e.height=t.height;const r=e.getContext("2d");r.drawImage(t,0,0,t.width,t.height);const a=r.getImageData(0,0,t.width,t.height),n=new Uint8Array(a.data);let i;for(let t=0;t<n.length;t+=4)i=n[t+3]/255,n[t]=n[t]*i,n[t+1]=n[t+1]*i,n[t+2]=n[t+2]*i;return new ImageData(new Uint8ClampedArray(n.buffer),t.width,t.height)}(n,t),e()},n.onerror=()=>{URL.revokeObjectURL(a),this.imageData=null,r(new Error("Image creation error"))},n.src=a}))},t}();function l(t,e){const r=new DataView(t.buffer);let a,n,i,s=8;do{n=r.getUint32(s),a=c(t,s+4,4),i=e(a,t,s,n),s+=12+n}while(!1!==i&&"IEND"!==a&&s<t.length)}function c(t,e,r){const a=Array.prototype.slice.call(t.subarray(e,e+r));return String.fromCharCode.apply(String,a)}function d(t,e,r){const a=new Uint8Array(r);return a.set(t.subarray(e,e+r)),a}function f(t,e){const r=t.length+e.length,n=new Uint8Array(r+8),i=new DataView(n.buffer);i.setUint32(0,e.length),n.set(function(t){const e=new Uint8Array(t.length);for(let r=0;r<t.length;r++)e[r]=t.charCodeAt(r);return e}(t),4),n.set(e,8);const s=function(t,e=0,r=t.length-e){let n=-1;for(let i=e,s=e+r;i<s;i++)n=n>>>8^a[255&(n^t[i])];return-1^n}(n,4,r);return i.setUint32(r+4,s),n}function m(t){return new Uint8Array([t>>>24&255,t>>>16&255,t>>>8&255,255&t])}t.default=u,t.getPNGSize=function(t){let e,r;return l(new Uint8Array(t),((t,a,n)=>{const i=new DataView(a.buffer);"IHDR"===t&&(e=i.getUint32(n+8),r=i.getUint32(n+12))})),[e,r]},t.isAnimatedPNG=function(t){const e=new Uint8Array(t);if(!h(e))return!1;let r=!1;return l(e,(t=>!(r="acTL"===t))),r},t.isPNG=h,Object.defineProperty(t,"__esModule",{value:!0})}));
