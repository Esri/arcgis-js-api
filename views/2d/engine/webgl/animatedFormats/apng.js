/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../../core/Error","../../../../../core/promiseUtils"],(function(t,e,r){"use strict";const n=new Uint32Array(256);for(let D=0;D<256;D++){let t=D;for(let e=0;e<8;e++)t=0!=(1&t)?3988292384^t>>>1:t>>>1;n[D]=t}function a(t,e=0,r=t.length-e){let a=-1;for(let i=e,s=e+r;i<s;i++)a=a>>>8^n[255&(a^t[i])];return-1^a}const i=new e("Not a PNG"),s=new e("Not an animated PNG"),h=new Uint8Array([137,80,78,71,13,10,26,10]);function u(t){const e=t.constructor===Uint8Array?t:new Uint8Array(t);return!h.some(((t,r)=>t!==e[r]))}function o(t){let e,r;return p(new Uint8Array(t),((t,n,a)=>{const i=new DataView(n.buffer);"IHDR"===t&&(e=i.getUint32(a+8),r=i.getUint32(a+12))})),[e,r]}function l(t){const e=new Uint8Array(t);if(!u(e))return!1;let r=!1;return p(e,(t=>!(r="acTL"===t))),r}let c=function(){function t(){this.width=0,this.height=0,this.numPlays=0,this.playTime=0,this.frames=[],this.paused=!1,this.playing=!1,this.playSpeed=1,this.currentFrameNumber=0,this._lastUsedFrame=-1}t.create=async function(n,a){const i=new t;try{await i._load(n,a)}catch(s){if(!r.isAbortError(s))return new e("invalid-resource",`Could not load PNG: ${s.message}`)}return i};var n=t.prototype;return n.play=function(){this.playing||(this.paused=!1,this.playing=!0,this._play())},n.pause=function(){this.paused=!0,this.playing=!1,clearTimeout(this.timerID)},n.togglePlay=function(){this.paused||!this.playing?this.play():this.pause()},n.bindFrame=function(t,e,r){t.bindTexture(e,r);const n=this.frameChanged();if(!n)return!1;const a=this.currentFrame,i=a.frameData,s=e.descriptor;return(a.left||a.top||a.width!==s.width||a.height!==s.height)&&e.setData(null),e.updateData(0,a.left,a.top,a.width,a.height,i),this.updateUsedFrame(),n},n.frameChanged=function(){return this._lastUsedFrame!==this.currentFrameNumber},n.updateUsedFrame=function(){this._lastUsedFrame=this.currentFrameNumber},n._load=async function(t,n){try{const e=m(this,t);if(e!==this)return e;this._resizeCanvas=document.createElement("canvas"),this._resizeCanvas.width=this.width,this._resizeCanvas.height=this.height,await Promise.all(this.frames.map((t=>t.createImage(this._resizeCanvas))))}catch(a){if(!r.isAbortError(a))return new e("invalid-resource","Could not parse PNG")}this.play()},n._play=function(){let t,e;if(0===this.playSpeed)return void this.pause();this.playSpeed<0?(this.currentFrameNumber-=1,this.currentFrameNumber<0&&(this.currentFrameNumber=this.frames.length-1),e=this.currentFrameNumber,e-=1,e<0&&(e=this.frames.length-1),t=1*-this.frames[e].delay/this.playSpeed):(this.currentFrameNumber+=1,this.currentFrameNumber%=this.frames.length,t=1*this.frames[this.currentFrameNumber].delay/this.playSpeed);const r=this.frames[this.currentFrameNumber];this.currentFrame={frameData:r.imageData,top:r.top,left:r.left,width:r.width,height:r.height},this.timerID=window.setTimeout((()=>this._play()),t)},t}(),d=function(){function t(){this.left=0,this.top=0,this.width=0,this.height=0,this.delay=0,this.disposeOp=0,this.blendOp=0,this.data=null,this.imageData=null}return t.prototype.createImage=async function(t){if(null===this.imageData)return new Promise(((e,r)=>{const n=URL.createObjectURL(this.data),a=document.createElement("img");a.onload=()=>{URL.revokeObjectURL(n),this.imageData=f(a,t),e()},a.onerror=()=>{URL.revokeObjectURL(n),this.imageData=null,r(new Error("Image creation error"))},a.src=n}))},t}();function f(t,e){e.width=t.width,e.height=t.height;const r=e.getContext("2d");r.drawImage(t,0,0,t.width,t.height);const n=r.getImageData(0,0,t.width,t.height),a=new Uint8Array(n.data);let i;for(let s=0;s<a.length;s+=4)i=a[s+3]/255,a[s]=a[s]*i,a[s+1]=a[s+1]*i,a[s+2]=a[s+2]*i;return new ImageData(new Uint8ClampedArray(a.buffer),t.width,t.height)}function m(t,e){const r=new Uint8Array(e);if(h.some(((t,e)=>t!==r[e])))return i;let n=!1;if(p(r,(t=>!(n="acTL"===t))),!n)return s;const a=[],u=[];let o=null,l=null,c=0;if(p(r,((e,r,n,i)=>{const s=new DataView(r.buffer);switch(e){case"IHDR":o=r.subarray(n+8,n+8+i),t.width=s.getUint32(n+8),t.height=s.getUint32(n+12);break;case"acTL":t.numPlays=s.getUint32(n+8+4);break;case"fcTL":{l&&(t.frames.push(l),c++),l=new d,l.width=s.getUint32(n+8+4),l.height=s.getUint32(n+8+8),l.left=s.getUint32(n+8+12),l.top=s.getUint32(n+8+16);const e=s.getUint16(n+8+20);let r=s.getUint16(n+8+22);0===r&&(r=100),l.delay=1e3*e/r,l.delay<=10&&(l.delay=100),t.playTime+=l.delay,l.disposeOp=s.getUint8(n+8+24),l.blendOp=s.getUint8(n+8+25),l.dataParts=[],0===c&&2===l.disposeOp&&(l.disposeOp=1);break}case"fdAT":l&&l.dataParts.push(r.subarray(n+8+4,n+8+i));break;case"IDAT":l&&l.dataParts.push(r.subarray(n+8,n+8+i));break;case"IEND":u.push(w(r,n,12+i));break;default:a.push(w(r,n,12+i))}})),0===t.frames.length)return s;t.frameCount=t.frames.length;const f=new Blob(a),m=new Blob(u);return t.frames.forEach((t=>{let e=[];e.push(h),o.set(b(t.width),0),o.set(b(t.height),4),e.push(U("IHDR",o)),e.push(f),t.dataParts.forEach((t=>e.push(U("IDAT",t)))),e.push(m),t.data=new Blob(e,{type:"image/png"}),delete t.dataParts,e=null})),t}function p(t,e){const r=new DataView(t.buffer);let n,a,i,s=8;do{a=r.getUint32(s),n=g(t,s+4,4),i=e(n,t,s,a),s+=12+a}while(!1!==i&&"IEND"!==n&&s<t.length)}function g(t,e,r){const n=Array.prototype.slice.call(t.subarray(e,e+r));return String.fromCharCode.apply(String,n)}function y(t){const e=new Uint8Array(t.length);for(let r=0;r<t.length;r++)e[r]=t.charCodeAt(r);return e}function w(t,e,r){const n=new Uint8Array(r);return n.set(t.subarray(e,e+r)),n}function U(t,e){const r=t.length+e.length,n=new Uint8Array(r+8),i=new DataView(n.buffer);i.setUint32(0,e.length),n.set(y(t),4),n.set(e,8);const s=a(n,4,r);return i.setUint32(r+4,s),n}function b(t){return new Uint8Array([t>>>24&255,t>>>16&255,t>>>8&255,255&t])}t.default=c,t.getPNGSize=o,t.isAnimatedPNG=l,t.isPNG=u,Object.defineProperty(t,"__esModule",{value:!0})}));
