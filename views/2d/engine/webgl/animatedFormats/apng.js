// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../../core/Error","../../../../../core/promiseUtils"],(function(t,e,r,a,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.isAnimatedPNG=e.getPNGSize=e.isPNG=void 0;for(var i=new Uint32Array(256),s=0;s<256;s++){for(var u=s,h=0;h<8;h++)u=0!=(1&u)?3988292384^u>>>1:u>>>1;i[s]=u}var o=new a("Not a PNG"),c=new a("Not an animated PNG"),l=new Uint8Array([137,80,78,71,13,10,26,10]);function f(t){var e=t.constructor===Uint8Array?t:new Uint8Array(t);return!l.some((function(t,r){return t!==e[r]}))}e.isPNG=f,e.getPNGSize=function(t){var e,r;return m(new Uint8Array(t),(function(t,a,n){var i=new DataView(a.buffer);"IHDR"===t&&(e=i.getUint32(n+8),r=i.getUint32(n+12))})),[e,r]},e.isAnimatedPNG=function(t){var e=new Uint8Array(t);if(!f(e))return!1;var r=!1;return m(e,(function(t){return!(r="acTL"===t)})),r};var d=function(){function t(){this.width=0,this.height=0,this.numPlays=0,this.playTime=0,this.frames=[],this.paused=!1,this.playing=!1,this.playSpeed=1,this.currentFrameNumber=0,this._lastUsedFrame=-1}return t.create=function(e,i){return r.__awaiter(this,void 0,void 0,(function(){var s,u;return r.__generator(this,(function(r){switch(r.label){case 0:s=new t,r.label=1;case 1:return r.trys.push([1,3,,4]),[4,s._load(e,i)];case 2:return r.sent(),[3,4];case 3:return u=r.sent(),n.isAbortError(u)?[3,4]:[2,new a("invalid-resource","Could not load PNG: "+u.message)];case 4:return[2,s]}}))}))},t.prototype.play=function(){this.playing||(this.paused=!1,this.playing=!0,this._play())},t.prototype.pause=function(){this.paused=!0,this.playing=!1,clearTimeout(this.timerID)},t.prototype.togglePlay=function(){this.paused||!this.playing?this.play():this.pause()},t.prototype.bindFrame=function(t,e,r){t.bindTexture(e,r);var a=this.frameChanged();if(!a)return!1;var n=this.currentFrame,i=n.frameData,s=e.descriptor;return(n.left||n.top||n.width!==s.width||n.height!==s.height)&&e.setData(null),e.updateData(0,n.left,n.top,n.width,n.height,i),this.updateUsedFrame(),a},t.prototype.frameChanged=function(){return this._lastUsedFrame!==this.currentFrameNumber},t.prototype.updateUsedFrame=function(){this._lastUsedFrame=this.currentFrameNumber},t.prototype._load=function(t,e){return r.__awaiter(this,void 0,void 0,(function(){var e,i,s=this;return r.__generator(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),(e=function(t,e){var r=new Uint8Array(e);if(l.some((function(t,e){return t!==r[e]})))return o;var a=!1;if(m(r,(function(t){return!(a="acTL"===t)})),!a)return c;var n=[],i=[],s=null,u=null,h=0;if(m(r,(function(e,r,a,o){var c=new DataView(r.buffer);switch(e){case"IHDR":s=r.subarray(a+8,a+8+o),t.width=c.getUint32(a+8),t.height=c.getUint32(a+12);break;case"acTL":t.numPlays=c.getUint32(a+8+4);break;case"fcTL":u&&(t.frames.push(u),h++),(u=new p).width=c.getUint32(a+8+4),u.height=c.getUint32(a+8+8),u.left=c.getUint32(a+8+12),u.top=c.getUint32(a+8+16);var l=c.getUint16(a+8+20),f=c.getUint16(a+8+22);0===f&&(f=100),u.delay=1e3*l/f,u.delay<=10&&(u.delay=100),t.playTime+=u.delay,u.disposeOp=c.getUint8(a+8+24),u.blendOp=c.getUint8(a+8+25),u.dataParts=[],0===h&&2===u.disposeOp&&(u.disposeOp=1);break;case"fdAT":u&&u.dataParts.push(r.subarray(a+8+4,a+8+o));break;case"IDAT":u&&u.dataParts.push(r.subarray(a+8,a+8+o));break;case"IEND":i.push(y(r,a,12+o));break;default:n.push(y(r,a,12+o))}})),0===t.frames.length)return c;t.frameCount=t.frames.length;var f=new Blob(n),d=new Blob(i);return t.frames.forEach((function(t){var e=[];e.push(l),s.set(v(t.width),0),s.set(v(t.height),4),e.push(w("IHDR",s)),e.push(f),t.dataParts.forEach((function(t){return e.push(w("IDAT",t))})),e.push(d),t.data=new Blob(e,{type:"image/png"}),delete t.dataParts,e=null})),t}(this,t))!==this?[2,e]:(this._resizeCanvas=document.createElement("canvas"),this._resizeCanvas.width=this.width,this._resizeCanvas.height=this.height,[4,n.all(this.frames.map((function(t){return t.createImage(s._resizeCanvas)})))]);case 1:return r.sent(),[3,3];case 2:return i=r.sent(),n.isAbortError(i)?[3,3]:[2,new a("invalid-resource","Could not parse PNG")];case 3:return this.play(),[2]}}))}))},t.prototype._play=function(){var t,e,r=this;if(0!==this.playSpeed){this.playSpeed<0?(this.currentFrameNumber-=1,this.currentFrameNumber<0&&(this.currentFrameNumber=this.frames.length-1),e=this.currentFrameNumber,(e-=1)<0&&(e=this.frames.length-1),t=1*-this.frames[e].delay/this.playSpeed):(this.currentFrameNumber+=1,this.currentFrameNumber%=this.frames.length,t=1*this.frames[this.currentFrameNumber].delay/this.playSpeed);var a=this.frames[this.currentFrameNumber];this.currentFrame={frameData:a.imageData,top:a.top,left:a.left,width:a.width,height:a.height},this.timerID=window.setTimeout((function(){return r._play()}),t)}else this.pause()},t}();e.default=d;var p=function(){function t(){this.left=0,this.top=0,this.width=0,this.height=0,this.delay=0,this.disposeOp=0,this.blendOp=0,this.data=null,this.imageData=null}return t.prototype.createImage=function(t){return r.__awaiter(this,void 0,void 0,(function(){var e=this;return r.__generator(this,(function(r){return null!==this.imageData?[2]:[2,n.create((function(r,a){var n=URL.createObjectURL(e.data),i=document.createElement("img");i.onload=function(){URL.revokeObjectURL(n),e.imageData=function(t,e){e.width=t.width,e.height=t.height;var r=e.getContext("2d");r.drawImage(t,0,0,t.width,t.height);for(var a,n=r.getImageData(0,0,t.width,t.height),i=new Uint8Array(n.data),s=0;s<i.length;s+=4)a=i[s+3]/255,i[s]=i[s]*a,i[s+1]=i[s+1]*a,i[s+2]=i[s+2]*a;return new ImageData(new Uint8ClampedArray(i.buffer),t.width,t.height)}(i,t),r()},i.onerror=function(){URL.revokeObjectURL(n),e.imageData=null,a(new Error("Image creation error"))},i.src=n}))]}))}))},t}();function m(t,e){var r,a,n,i=new DataView(t.buffer),s=8;do{a=i.getUint32(s),n=e(r=g(t,s+4,4),t,s,a),s+=12+a}while(!1!==n&&"IEND"!==r&&s<t.length)}function g(t,e,r){var a=Array.prototype.slice.call(t.subarray(e,e+r));return String.fromCharCode.apply(String,a)}function y(t,e,r){var a=new Uint8Array(r);return a.set(t.subarray(e,e+r)),a}function w(t,e){var r=t.length+e.length,a=new Uint8Array(r+8),n=new DataView(a.buffer);n.setUint32(0,e.length),a.set(function(t){for(var e=new Uint8Array(t.length),r=0;r<t.length;r++)e[r]=t.charCodeAt(r);return e}(t),4),a.set(e,8);var s=function(t,e,r){void 0===e&&(e=0),void 0===r&&(r=t.length-e);for(var a=-1,n=e,s=e+r;n<s;n++)a=a>>>8^i[255&(a^t[n])];return-1^a}(a,4,r);return n.setUint32(r+4,s),a}function v(t){return new Uint8Array([t>>>24&255,t>>>16&255,t>>>8&255,255&t])}}));