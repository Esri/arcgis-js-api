/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/Error","../../../../../core/promiseUtils"],(function(t,e,r,n){"use strict";const i=new Uint32Array(256);for(let N=0;N<256;N++){let t=N;for(let e=0;e<8;e++)t=0!=(1&t)?3988292384^t>>>1:t>>>1;i[N]=t}function a(t,e=0,r=t.length-e){let n=-1;for(let a=e,s=e+r;a<s;a++)n=n>>>8^i[255&(n^t[a])];return-1^n}const s=new r("Not a PNG"),h=new r("Not an animated PNG"),u=new Uint8Array([137,80,78,71,13,10,26,10]);function o(t){const e=t.constructor===Uint8Array?t:new Uint8Array(t);return!u.some(((t,r)=>t!==e[r]))}function l(t){let e,r;return g(new Uint8Array(t),((t,n,i)=>{const a=new DataView(n.buffer);"IHDR"===t&&(e=a.getUint32(i+8),r=a.getUint32(i+12))})),[e,r]}function c(t){const e=new Uint8Array(t);if(!o(e))return!1;let r=!1;return g(e,(t=>!(r="acTL"===t))),r}let d=function(){function t(){this.width=0,this.height=0,this.numPlays=0,this.playTime=0,this.frames=[],this.paused=!1,this.playing=!1,this.playSpeed=1,this.currentFrameNumber=0,this._lastUsedFrame=-1}t.create=function(){var i=e._asyncToGenerator((function*(e,i){const a=new t;try{yield a._load(e,i)}catch(s){if(!n.isAbortError(s))return new r("invalid-resource",`Could not load PNG: ${s.message}`)}return a}));function a(t,e){return i.apply(this,arguments)}return a}();var i=t.prototype;return i.play=function(){this.playing||(this.paused=!1,this.playing=!0,this._play())},i.pause=function(){this.paused=!0,this.playing=!1,clearTimeout(this.timerID)},i.togglePlay=function(){this.paused||!this.playing?this.play():this.pause()},i.bindFrame=function(t,e,r){t.bindTexture(e,r);const n=this.frameChanged();if(!n)return!1;const i=this.currentFrame,a=i.frameData,s=e.descriptor;return(i.left||i.top||i.width!==s.width||i.height!==s.height)&&e.setData(null),e.updateData(0,i.left,i.top,i.width,i.height,a),this.updateUsedFrame(),n},i.frameChanged=function(){return this._lastUsedFrame!==this.currentFrameNumber},i.updateUsedFrame=function(){this._lastUsedFrame=this.currentFrameNumber},i._load=function(){var t=e._asyncToGenerator((function*(t,e){try{const e=p(this,t);if(e!==this)return e;this._resizeCanvas=document.createElement("canvas"),this._resizeCanvas.width=this.width,this._resizeCanvas.height=this.height,yield Promise.all(this.frames.map((t=>t.createImage(this._resizeCanvas))))}catch(i){if(!n.isAbortError(i))return new r("invalid-resource","Could not parse PNG")}this.play()}));function i(e,r){return t.apply(this,arguments)}return i}(),i._play=function(){let t,e;if(0===this.playSpeed)return void this.pause();this.playSpeed<0?(this.currentFrameNumber-=1,this.currentFrameNumber<0&&(this.currentFrameNumber=this.frames.length-1),e=this.currentFrameNumber,e-=1,e<0&&(e=this.frames.length-1),t=1*-this.frames[e].delay/this.playSpeed):(this.currentFrameNumber+=1,this.currentFrameNumber%=this.frames.length,t=1*this.frames[this.currentFrameNumber].delay/this.playSpeed);const r=this.frames[this.currentFrameNumber];this.currentFrame={frameData:r.imageData,top:r.top,left:r.left,width:r.width,height:r.height},this.timerID=window.setTimeout((()=>this._play()),t)},t}(),f=function(){function t(){this.left=0,this.top=0,this.width=0,this.height=0,this.delay=0,this.disposeOp=0,this.blendOp=0,this.data=null,this.imageData=null}return t.prototype.createImage=function(){var t=e._asyncToGenerator((function*(t){if(null===this.imageData)return new Promise(((e,r)=>{const n=URL.createObjectURL(this.data),i=document.createElement("img");i.onload=()=>{URL.revokeObjectURL(n),this.imageData=m(i,t),e()},i.onerror=()=>{URL.revokeObjectURL(n),this.imageData=null,r(new Error("Image creation error"))},i.src=n}))}));function r(e){return t.apply(this,arguments)}return r}(),t}();function m(t,e){e.width=t.width,e.height=t.height;const r=e.getContext("2d");r.drawImage(t,0,0,t.width,t.height);const n=r.getImageData(0,0,t.width,t.height),i=new Uint8Array(n.data);let a;for(let s=0;s<i.length;s+=4)a=i[s+3]/255,i[s]=i[s]*a,i[s+1]=i[s+1]*a,i[s+2]=i[s+2]*a;return new ImageData(new Uint8ClampedArray(i.buffer),t.width,t.height)}function p(t,e){const r=new Uint8Array(e);if(u.some(((t,e)=>t!==r[e])))return s;let n=!1;if(g(r,(t=>!(n="acTL"===t))),!n)return h;const i=[],a=[];let o=null,l=null,c=0;if(g(r,((e,r,n,s)=>{const h=new DataView(r.buffer);switch(e){case"IHDR":o=r.subarray(n+8,n+8+s),t.width=h.getUint32(n+8),t.height=h.getUint32(n+12);break;case"acTL":t.numPlays=h.getUint32(n+8+4);break;case"fcTL":{l&&(t.frames.push(l),c++),l=new f,l.width=h.getUint32(n+8+4),l.height=h.getUint32(n+8+8),l.left=h.getUint32(n+8+12),l.top=h.getUint32(n+8+16);const e=h.getUint16(n+8+20);let r=h.getUint16(n+8+22);0===r&&(r=100),l.delay=1e3*e/r,l.delay<=10&&(l.delay=100),t.playTime+=l.delay,l.disposeOp=h.getUint8(n+8+24),l.blendOp=h.getUint8(n+8+25),l.dataParts=[],0===c&&2===l.disposeOp&&(l.disposeOp=1);break}case"fdAT":l&&l.dataParts.push(r.subarray(n+8+4,n+8+s));break;case"IDAT":l&&l.dataParts.push(r.subarray(n+8,n+8+s));break;case"IEND":a.push(b(r,n,12+s));break;default:i.push(b(r,n,12+s))}})),0===t.frames.length)return h;t.frameCount=t.frames.length;const d=new Blob(i),m=new Blob(a);return t.frames.forEach((t=>{let e=[];e.push(u),o.set(D(t.width),0),o.set(D(t.height),4),e.push(U("IHDR",o)),e.push(d),t.dataParts.forEach((t=>e.push(U("IDAT",t)))),e.push(m),t.data=new Blob(e,{type:"image/png"}),delete t.dataParts,e=null})),t}function g(t,e){const r=new DataView(t.buffer);let n,i,a,s=8;do{i=r.getUint32(s),n=y(t,s+4,4),a=e(n,t,s,i),s+=12+i}while(!1!==a&&"IEND"!==n&&s<t.length)}function y(t,e,r){const n=Array.prototype.slice.call(t.subarray(e,e+r));return String.fromCharCode.apply(String,n)}function w(t){const e=new Uint8Array(t.length);for(let r=0;r<t.length;r++)e[r]=t.charCodeAt(r);return e}function b(t,e,r){const n=new Uint8Array(r);return n.set(t.subarray(e,e+r)),n}function U(t,e){const r=t.length+e.length,n=new Uint8Array(r+8),i=new DataView(n.buffer);i.setUint32(0,e.length),n.set(w(t),4),n.set(e,8);const s=a(n,4,r);return i.setUint32(r+4,s),n}function D(t){return new Uint8Array([t>>>24&255,t>>>16&255,t>>>8&255,255&t])}t.default=d,t.getPNGSize=l,t.isAnimatedPNG=c,t.isPNG=o,Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
