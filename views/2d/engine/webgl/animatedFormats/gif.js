/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../../core/Error","../../../../../core/promiseUtils"],(function(t,e,i){"use strict";const s=249,a=254,r=255,n=1,o=44,h=59;function l(t){if(!t||0===t.byteLength)return!1;const e=t.constructor===Uint8Array?t:new Uint8Array(t);return 71===e[0]&&73===e[1]&&70===e[2]&&56===e[3]}let u=function(){function t(){this.paused=!1,this.playing=!1,this.waitTillDone=!0,this.loading=!1,this.firstFrameOnly=!1,this.frames=[],this.comment="",this.length=0,this.currentFrameNumber=0,this.frameCount=0,this.playSpeed=1,this.lastFrame=null,this.playOnLoad=!0,this.complete=!1,this.interlaceOffsets=[0,4,2,1],this.interlaceSteps=[8,8,4,2],this._lastUsedFrame=-1}t.create=async function(s,a){const r=new t;try{await r._load(s,a)}catch(t){if(!i.isAbortError(t))return new e("invalid-resource",`Could not load PNG: ${t.message}`)}return r};var l=t.prototype;return l.play=function(){this.playing||(this.paused=!1,this.playing=!0,this._play())},l.pause=function(){this.paused=!0,this.playing=!1,clearTimeout(this.timerID)},l.togglePlay=function(){this.paused||!this.playing?this.play():this.pause()},l.bindFrame=function(t,e,i){t.bindTexture(e,i);const s=this.frameChanged();if(s){const t=this.currentFrame,i=t.frameData;e.updateData(0,0,0,t.width,t.height,i),this.updateUsedFrame()}return s},l.seekFrame=function(t){clearTimeout(this.timerID),this.currentFrameNumber=t%this.frames.length,this.playing?this._play():this._setCurrentFrame(this.currentFrameNumber)},l.seek=function(t){clearTimeout(this.timerID),t<0&&(t=0),t*=1e3,t%=this.length;let e=0;for(;t>this.frames[e].time+this.frames[e].delay&&e<this.frames.length;)e+=1;this.currentFrameNumber=e,this.playing?this._play():this._setCurrentFrame(this.currentFrameNumber)},l.frameChanged=function(){return this._lastUsedFrame!==this.currentFrameNumber},l.updateUsedFrame=function(){this._lastUsedFrame=this.currentFrameNumber},l._load=async function(t,s){try{this.loading=!0,await this._parse(t,s),this.loading=!1,this.play()}catch(t){if(!i.isAbortError(t))return new e("invalid-resource","Could not parse gif!")}},l._parse=function(t,e){const s=new d(t);s.pos+=6,this.width=s.data[s.pos++]+(s.data[s.pos++]<<8),this.height=s.data[s.pos++]+(s.data[s.pos++]<<8);const a=s.data[s.pos++];return this.globalColourCount=1<<1+(7&a),s.pos++,s.pos++,128&a&&(this.globalColourTable=this._parseColourTable(this.globalColourCount,s)),i.create(((t,i)=>{setTimeout((()=>this._parseBlock(s,t,i,e)),0)}))},l._parseBlock=async function(t,e,s,a){if(a&&a.signal&&i.isAborted(a.signal))return void s(i.createAbortError());const r=t.data[t.pos++];if(r===o){if(this._parseImg(t),this.firstFrameOnly)return this._finishedLoading(),void e()}else{if(r===h)return this._finishedLoading(),void e();this._parseExt(t)}"function"==typeof this.onprogress&&this.onprogress({bytesRead:t.pos,totalBytes:t.data.length,frame:this.frames.length}),setTimeout((()=>this._parseBlock(t,e,s,a)),0)},l._parseColourTable=function(t,e){const i=[];for(let s=0;s<t;s++)i.push([e.data[e.pos++],e.data[e.pos++],e.data[e.pos++]]);return i},l._parseImg=function(t){const e=t=>{const e=this.pixelBufSize/t;this.interlacedBufSize!==this.pixelBufSize&&(this.deinterlaceBuf=new Uint8Array(this.pixelBufSize),this.interlacedBufSize=this.pixelBufSize);let i=0;for(let s=0;s<4;s++)for(let a=this.interlaceOffsets[s];a<e;a+=this.interlaceSteps[s])this.deinterlaceBuf.set(this.pixelBuf.subarray(i,i+t),a*t),i+=t},i={};this.frames.push(i),i.disposalMethod=this.disposalMethod,i.time=this.length,i.delay=10*this.delayTime,this.length+=i.delay,this.transparencyGiven?i.transparencyIndex=this.transparencyIndex:i.transparencyIndex=void 0,i.leftPos=t.data[t.pos++]+(t.data[t.pos++]<<8),i.topPos=t.data[t.pos++]+(t.data[t.pos++]<<8),i.width=t.data[t.pos++]+(t.data[t.pos++]<<8),i.height=t.data[t.pos++]+(t.data[t.pos++]<<8);const s=t.data[t.pos++];i.localColourTableFlag=!!(128&s),i.localColourTableFlag&&(i.localColourTable=this._parseColourTable(1<<1+(7&s),t)),this.pixelBufSize!==i.width*i.height&&(this.pixelBuf=new Uint8Array(i.width*i.height),this.pixelBufSize=i.width*i.height),this._lzwDecode(t.data[t.pos++],t.readSubBlocksB()),64&s?(i.interlaced=!0,e(i.width)):i.interlaced=!1,this._processFrame(i)},l._lzwDecode=function(t,e){let i,s,a,r,n,o,h,l,u,d,p;a=s=0;let c=[];for(r=1<<t,n=r+1,o=t+1,p=!1;!p;){for(l=h,h=0,i=0;i<o;i++)e[a>>3]&1<<(7&a)&&(h|=1<<i),a++;if(h===r){for(c=[],o=t+1,i=0;i<r;i++)c[i]=[i];c[r]=[],c[n]=null}else{if(h===n)return void(p=!0);for(h>=c.length?c.push(c[l].concat(c[l][0])):l!==r&&c.push(c[l].concat(c[h][0])),u=c[h],d=u.length,i=0;i<d;i++)this.pixelBuf[s++]=u[i];c.length===1<<o&&o<12&&o++}}},l._processFrame=function(t){t.image=document.createElement("canvas"),t.image.width=this.width,t.image.height=this.height,t.ctx=t.image.getContext("2d");const e=t.localColourTableFlag?t.localColourTable:this.globalColourTable;null===this.lastFrame&&(this.lastFrame=t);const i=2===this.lastFrame.disposalMethod||3===this.lastFrame.disposalMethod;i||t.ctx.drawImage(this.lastFrame.image,0,0,this.width,this.height);const s=t.ctx.getImageData(t.leftPos,t.topPos,t.width,t.height),a=t.transparencyIndex,r=s.data,n=t.interlaced?this.deinterlaceBuf:this.pixelBuf,o=n.length;let h,l,u=0;for(let t=0;t<o;t++)h=n[t],l=e[h],a!==h?(r[u++]=l[0],r[u++]=l[1],r[u++]=l[2],r[u++]=255):i?(r[u+3]=0,u+=4):u+=4;t.ctx.putImageData(s,t.leftPos,t.topPos),this.lastFrame=t},l._parseExt=function(t){const e=t.data[t.pos++];e===s?this._parseGCExt(t):e===a?this.comment+=t.readSubBlocks():e===r?this._parseAppExt(t):(e===n&&(t.pos+=13),t.readSubBlocks())},l._parseAppExt=function(t){t.pos+=1,"NETSCAPE"===t.getString(8)?t.pos+=8:(t.pos+=3,t.readSubBlocks())},l._parseGCExt=function(t){let e;t.pos++,e=t.data[t.pos++],this.disposalMethod=(28&e)>>2,this.transparencyGiven=!!(1&e),this.delayTime=t.data[t.pos++]+(t.data[t.pos++]<<8),this.transparencyIndex=t.data[t.pos++],t.pos++},l._finishedLoading=function(){this.loading=!1,this.frameCount=this.frames.length,this.lastFrame=null,this.complete=!0,this.disposalMethod=void 0,this.transparencyGiven=void 0,this.delayTime=void 0,this.transparencyIndex=void 0,this.waitTillDone=void 0,this.pixelBuf=void 0,this.deinterlaceBuf=void 0,this.pixelBufSize=void 0,this.deinterlaceBuf=void 0,this.currentFrameNumber=0,this.frames.length>0&&this._setCurrentFrame(0),this.playOnLoad&&this.play()},l._play=function(){let t,e;0!==this.playSpeed?(this.playSpeed<0?(this.currentFrameNumber-=1,this.currentFrameNumber<0&&(this.currentFrameNumber=this.frames.length-1),e=this.currentFrameNumber,e-=1,e<0&&(e=this.frames.length-1),t=1*-this.frames[e].delay/this.playSpeed):(this.currentFrameNumber+=1,this.currentFrameNumber%=this.frames.length,t=1*this.frames[this.currentFrameNumber].delay/this.playSpeed),this._setCurrentFrame(this.currentFrameNumber),this.timerID=window.setTimeout((()=>this._play()),t)):this.pause()},l._setCurrentFrame=function(t){const e=this.frames[t];this.currentFrame={frameData:e.image,top:0,left:0,width:this.width,height:this.height}},t}(),d=function(){function t(t){this.pos=0,this.data=new Uint8ClampedArray(t),this.len=this.data.length}var e=t.prototype;return e.getString=function(t){let e="";for(;t--;)e+=String.fromCharCode(this.data[this.pos++]);return e},e.readSubBlocks=function(){let t,e,i="";do{for(e=t=this.data[this.pos++];e--;)i+=String.fromCharCode(this.data[this.pos++])}while(0!==t&&this.pos<this.len);return i},e.readSubBlocksB=function(){let t,e;const i=[];do{for(e=t=this.data[this.pos++];e--;)i.push(this.data[this.pos++])}while(0!==t&&this.pos<this.len);return i},t}();t.default=u,t.getGIFSize=function(t){const e=new Uint8ClampedArray(t);let i=6;return[e[i++]+(e[i++]<<8),e[i++]+(e[i++]<<8)]},t.isAnimatedGIF=function(t){if(!t||0===t.byteLength)return!1;const e=new Uint8Array(t);if(!l(e))return!1;let i=0;for(let t=0,s=e.length-9;t<s&&(0!==e[t]||33!==e[t+1]||249!==e[t+2]||4!==e[t+3]||0!==e[t+8]||44!==e[t+9]&&33!==e[t+9]||(i++,!(i>1)));++t);return i>1},t.isGIF=l,Object.defineProperty(t,"__esModule",{value:!0})}));
