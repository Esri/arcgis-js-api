/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../../../core/arrayUtils","../../../../../core/maybe","../enums"],(function(e,t,r){"use strict";return function(){function s(e,t){this.brushes=e,this.name=t.name,this.drawPhase=t.drawPhase||r.WGLDrawPhase.MAP,this._targetFn=t.target,this.effects=t.effects||[],this.enableDefaultDraw=t.enableDefaultDraw??(()=>!0)}var n=s.prototype;return n.render=function(e){const{context:t,profiler:r}=e,s=this._targetFn(),n=this.drawPhase&e.drawPhase;if(r.recordPassStart(this.name),n){this.enableDefaultDraw()&&this._doRender(e,s),r.recordPassEnd();for(const r of this.effects){if(!r.enable())continue;const n=r.apply,i=r.args&&r.args(),a=t.getViewport(),o=t.getBoundFramebufferObject(),f=e.passOptions;this._bindEffect(e,n,i),this._doRender(e,s,n.defines),this._drawAndUnbindEffect(e,n,a,o,f,i)}}},n._doRender=function(e,r,s){if(t.isNone(r))return;const{profiler:n,context:i}=e;for(const a of this.brushes){if(n.recordBrushStart(a.name),t.isSome(a.brushEffect)){const t=i.getViewport(),n=i.getBoundFramebufferObject(),o=e.passOptions;this._bindEffect(e,a.brushEffect),this._drawWithBrush(a,e,r,s),this._drawAndUnbindEffect(e,a.brushEffect,t,n,o)}else this._drawWithBrush(a,e,r,s);n.recordBrushEnd()}},n._drawWithBrush=function(t,r,s,n){e.isArrayLike(s)?(t.prepareState(r,n),t.drawMany(r,s,n)):s.visible&&(t.prepareState(r,n),t.draw(r,s,n))},n._bindEffect=function(e,t,r){const{profiler:s}=e;s.recordPassStart(this.name+"."+t.name),t.bind(e,r);const n=t.createOptions(e,r);e.passOptions=n},n._drawAndUnbindEffect=function(e,t,r,s,n,i){const{profiler:a,context:o}=e;e.passOptions=n,a.recordBrushStart(t.name),t.draw(e,i),t.unbind(e,i),o.bindFramebuffer(s);const{x:f,y:d,width:c,height:h}=r;o.setViewport(f,d,c,h),a.recordBrushEnd(),a.recordPassEnd()},s}()}));
