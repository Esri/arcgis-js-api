/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../core/Error","../../../../core/maybe","./definitions","./GeometryUtils","./Rect","./RectangleBinPack","../../../webgl/enums","../../../webgl/Texture"],(function(t,e,i,s,a,r,n,o,h){"use strict";function c(t){return t&&"static"===t.type}function g(t,e,i){return c(e)?new h.Texture(t,{pixelFormat:o.PixelFormat.RGBA,dataType:o.PixelType.UNSIGNED_BYTE,width:i[0],height:i[1]},new Uint8Array(e.data.buffer)):new h.Texture(t,{pixelFormat:o.PixelFormat.RGBA,dataType:o.PixelType.UNSIGNED_BYTE,samplingMode:o.TextureSamplingMode.LINEAR,wrapMode:o.TextureWrapMode.CLAMP_TO_EDGE,width:i[0],height:i[1]},null)}return function(){function o(t,e,i,s=0){this._mosaicPages=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects=new Map,this._spriteCopyQueue=[],this.pixelRatio=1,(e<=0||i<=0)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!"),this._pageWidth=e,this._pageHeight=i,this._requestRender=t,s>0&&(this._maxItemSize=s),this.pixelRatio=window.devicePixelRatio||1,this._binPack=new n(this._pageWidth,this._pageHeight);const a=Math.floor(this._pageWidth),r=Math.floor(this._pageHeight);this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(a*r)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0})}var h=o.prototype;return h.getWidth=function(t){return t>=this._mosaicPages.length?-1:this._mosaicPages[t].size[0]},h.getHeight=function(t){return t>=this._mosaicPages.length?-1:this._mosaicPages[t].size[1]},h.getPageTexture=function(t){return t<this._mosaicPages.length?this._mosaicPages[t].texture:null},h.has=function(t){return this._mosaicRects.has(t)},h.getSpriteItem=function(t){return this._mosaicRects.get(t)},h.addSpriteItem=function(t,e,i,s,a,n){if(this._mosaicRects.has(t))return this._mosaicRects.get(t);let o,h,g;if(c(i))[o,h,g]=this._allocateImage(e[0],e[1]);else{o=new r(0,0,e[0],e[1]),h=this._mosaicPages.length;const t=void 0;this._mosaicPages.push({mosaicsData:i,size:e,dirty:!0,texture:t})}if(o.width<=0||o.height<=0)return null;const u={rect:o,width:e[0],height:e[1],sdf:a,simplePattern:n,pixelRatio:1,page:h};return this._mosaicRects.set(t,u),c(i)&&this._copy({rect:o,spriteSize:e,spriteData:i.data,page:h,pageSize:g,repeat:s,sdf:a}),u},h.hasItemsToProcess=function(){return 0!==this._spriteCopyQueue.length},h.processNextItem=function(){const t=this._spriteCopyQueue.pop();t&&this._copy(t)},h.getSpriteItems=function(t){const e={};for(const i of t)e[i]=this.getSpriteItem(i);return e},h.getMosaicItemPosition=function(t){const e=this.getSpriteItem(t),i=e&&e.rect;if(!i)return null;i.width=e.width,i.height=e.height;const a=e.width,r=e.height,n=s.SPRITE_PADDING,o=this._mosaicPages[e.page];return{size:[e.width,e.height],tl:[(i.x+n)/o[0],(i.y+n)/o[1]],br:[(i.x+n+a)/o[0],(i.y+n+r)/o[1]],page:e.page}},h.bind=function(t,e,s=0,a=0){const r=this._mosaicPages[s],n=r.mosaicsData;let o=r.texture;if(o||(o=g(t,n,r.size),r.texture=o),o.setSamplingMode(e),c(n))t.bindTexture(o,a),r.dirty&&(o.setData(new Uint8Array(n.data.buffer)),o.generateMipmap());else{const e=n.data,s=e.bindFrame(t,o,a);i.isSome(this._requestRender)&&s&&e.frameCount>0&&this._requestRender.requestRender(),e.bindFrame(t,o,a)}r.dirty=!1},o._copyBits=function(t,e,i,s,a,r,n,o,h,c,g){let u=s*e+i,p=o*r+n;if(g){p-=r;for(let n=-1;n<=c;n++,u=((n+c)%c+s)*e+i,p+=r)for(let e=-1;e<=h;e++)a[p+e]=t[u+(e+h)%h]}else for(let _=0;_<c;_++){for(let e=0;e<h;e++)a[p+e]=t[u+e];u+=e,p+=r}},h._copy=function(t){if(t.page>=this._mosaicPages.length)return;const i=this._mosaicPages[t.page],a=i.mosaicsData;if(!c(i.mosaicsData))throw new e("mapview-invalid-resource","unsuitable data type!");const r=t.spriteData,n=a.data;n&&r||console.error("Source or target images are uninitialized!"),o._copyBits(r,t.spriteSize[0],0,0,n,t.pageSize[0],t.rect.x+s.SPRITE_PADDING,t.rect.y+s.SPRITE_PADDING,t.spriteSize[0],t.spriteSize[1],t.repeat),i.dirty=!0},h._allocateImage=function(t,e){t+=2*s.SPRITE_PADDING,e+=2*s.SPRITE_PADDING;const i=Math.max(t,e);if(this._maxItemSize&&this._maxItemSize<i){const i=2**Math.ceil(a.log2(t)),s=2**Math.ceil(a.log2(e)),n=new r(0,0,t,e);return this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(i*s)},size:[i,s],dirty:!0,texture:void 0}),[n,this._mosaicPages.length-1,[i,s]]}const o=this._binPack.allocate(t,e);if(o.width<=0){const i=this._mosaicPages[this._currentPage];return!i.dirty&&c(i.mosaicsData)&&(i.mosaicsData.data=null),this._currentPage=this._mosaicPages.length,this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(this._pageWidth*this._pageHeight)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0}),this._binPack=new n(this._pageWidth,this._pageHeight),this._allocateImage(t,e)}return[o,this._currentPage,[this._pageWidth,this._pageHeight]]},h.dispose=function(){this._binPack=null;for(const t of this._mosaicPages){const e=t.texture;e&&e.dispose();const i=t.mosaicsData;if(!c(i)){i.data.pause()}}this._mosaicPages=null,this._mosaicRects.clear()},t._createClass(o,[{key:"itemCount",get:function(){return this._mosaicRects.size}}]),o}()}));
