// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","../../../../core/Error","../../../../core/has","../../../../core/maybe","../../../webgl","./definitions","./GeometryUtils","./Rect","./RectangleBinPack"],(function(t,e,i,a,s,r,o,h,n,p){"use strict";function c(t){return t&&"static"===t.type}return function(){function t(t,e,i,s){if(void 0===s&&(s=0),this._mosaicPages=[],this._maxItemSize=0,this._currentPage=0,this._fixSpriteLocationsTable=a("fix-sprite-locations"),this._testId=a("test-id"),this._pageWidth=0,this._pageHeight=0,this._mosaicRects=new Map,this._spriteCopyQueue=[],this.pixelRatio=1,(e<=0||i<=0)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!"),this._pageWidth=e,this._pageHeight=i,this._requestRender=t,s>0&&(this._maxItemSize=s),this.pixelRatio=window.devicePixelRatio||1,this._fixSpriteLocationsTable){var r=[];for(var o in this._fixSpriteLocationsTable[this._testId]){var h=this._fixSpriteLocationsTable[this._testId][o];r[h.page]=h.pageSize}for(var n=0,c=r;n<c.length;n++){var g=c[n];this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(g[0]*g[1])},size:[g[0],g[1]],dirty:!0,texture:void 0})}}this._binPack=new p(this._pageWidth,this._pageHeight);var u=Math.floor(this._pageWidth),_=Math.floor(this._pageHeight);this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(u*_)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0})}return t.prototype.getWidth=function(t){return t>=this._mosaicPages.length?-1:this._mosaicPages[t].size[0]},t.prototype.getHeight=function(t){return t>=this._mosaicPages.length?-1:this._mosaicPages[t].size[1]},t.prototype.getPageTexture=function(t){return t<this._mosaicPages.length?this._mosaicPages[t].texture:null},t.prototype.has=function(t){return this._mosaicRects.has(t)},Object.defineProperty(t.prototype,"itemCount",{get:function(){return this._mosaicRects.size},enumerable:!1,configurable:!0}),t.prototype.getSpriteItem=function(t){return this._mosaicRects.get(t)},t.prototype.addSpriteItem=function(t,e,i,a,s,r){var o,h,p,g;if(this._mosaicRects.has(t))return this._mosaicRects.get(t);if(c(i))if(this._fixSpriteLocationsTable&&this._fixSpriteLocationsTable[this._testId]&&this._fixSpriteLocationsTable[this._testId][t]){var u=this._fixSpriteLocationsTable[this._testId][t];h=u.rect,p=u.page,g=u.pageSize}else h=(o=this._allocateImage(e[0],e[1]))[0],p=o[1],g=o[2];else{h=new n.default(0,0,e[0],e[1]),p=this._mosaicPages.length;this._mosaicPages.push({mosaicsData:i,size:e,dirty:!0,texture:void 0})}if(h.width<=0||h.height<=0)return null;var _={rect:h,width:e[0],height:e[1],sdf:s,simplePattern:r,pixelRatio:1,page:p};return this._mosaicRects.set(t,_),c(i)&&this._copy({rect:h,spriteSize:e,spriteData:i.data,page:p,pageSize:g,repeat:a,sdf:s}),_},t.prototype.hasItemsToProcess=function(){return 0!==this._spriteCopyQueue.length},t.prototype.processNextItem=function(){var t=this._spriteCopyQueue.pop();t&&this._copy(t)},t.prototype.getSpriteItems=function(t){for(var e={},i=0,a=t;i<a.length;i++){var s=a[i];e[s]=this.getSpriteItem(s)}return e},t.prototype.getMosaicItemPosition=function(t){var e=this.getSpriteItem(t),i=e&&e.rect;if(!i)return null;i.width=e.width,i.height=e.height;var a=e.width,s=e.height,r=o.SPRITE_PADDING,h=this._mosaicPages[e.page];return{size:[e.width,e.height],tl:[(i.x+r)/h[0],(i.y+r)/h[1]],br:[(i.x+r+a)/h[0],(i.y+r+s)/h[1]],page:e.page}},t.prototype.bind=function(t,e,i,a){void 0===i&&(i=0),void 0===a&&(a=0);var o=this._mosaicPages[i],h=o.mosaicsData,n=o.texture;if(n||(n=function(t,e,i){if(c(e))return new r.Texture(t,{pixelFormat:6408,dataType:5121,width:i[0],height:i[1]},new Uint8Array(e.data.buffer));return new r.Texture(t,{pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:i[0],height:i[1]},null)}(t,h,o.size),o.texture=n),n.setSamplingMode(e),c(h))t.bindTexture(n,a),o.dirty&&(n.setData(new Uint8Array(h.data.buffer)),n.generateMipmap());else{var p=h.data,g=p.bindFrame(t,n,a);s.isSome(this._requestRender)&&g&&p.frameCount>0&&this._requestRender.requestRender(),p.bindFrame(t,n,a)}o.dirty=!1},t._copyBits=function(t,e,i,a,s,r,o,h,n,p,c){var g=a*e+i,u=h*r+o;if(c){u-=r;for(var _=-1;_<=p;g=((++_+p)%p+a)*e+i,u+=r)for(var d=-1;d<=n;d++)s[u+d]=t[g+(d+n)%n]}else for(_=0;_<p;_++){for(d=0;d<n;d++)s[u+d]=t[g+d];g+=e,u+=r}},t.prototype._copy=function(e){if(!(e.page>=this._mosaicPages.length)){var a=this._mosaicPages[e.page],s=a.mosaicsData;if(!c(a.mosaicsData))throw new i("mapview-invalid-resource","unsuitable data type!");var r=e.spriteData,h=s.data;h&&r||console.error("Source or target images are uninitialized!"),t._copyBits(r,e.spriteSize[0],0,0,h,e.pageSize[0],e.rect.x+o.SPRITE_PADDING,e.rect.y+o.SPRITE_PADDING,e.spriteSize[0],e.spriteSize[1],e.repeat),a.dirty=!0}},t.prototype._allocateImage=function(t,e){t+=2*o.SPRITE_PADDING,e+=2*o.SPRITE_PADDING;var i=Math.max(t,e);if(this._maxItemSize&&this._maxItemSize<i){var a=Math.pow(2,Math.ceil(h.log2(t))),s=Math.pow(2,Math.ceil(h.log2(e))),r=new n.default(0,0,t,e);return this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(a*s)},size:[a,s],dirty:!0,texture:void 0}),[r,this._mosaicPages.length-1,[a,s]]}var g=this._binPack.allocate(t,e);if(g.width<=0){var u=this._mosaicPages[this._currentPage];return!u.dirty&&c(u.mosaicsData)&&(u.mosaicsData=null),this._currentPage=this._mosaicPages.length,this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(this._pageWidth*this._pageHeight)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0}),this._binPack=new p(this._pageWidth,this._pageHeight),this._allocateImage(t,e)}return[g,this._currentPage,[this._pageWidth,this._pageHeight]]},t.prototype.dispose=function(){this._binPack=null;for(var t=0,e=this._mosaicPages;t<e.length;t++){var i=e[t],a=i.texture;a&&a.dispose();var s=i.mosaicsData;if(!c(s))s.data.pause()}this._mosaicPages=null,this._mosaicRects.clear()},t}()}));