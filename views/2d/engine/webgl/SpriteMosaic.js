/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../core/has","../../../../core/maybe","../../../../core/Error","./definitions","../../../../chunks/builtins","../../../webgl/Texture","../../../webgl/FramebufferObject","../../../webgl/RenderingContext","./Rect","./GeometryUtils","./RectangleBinPack"],(function(t,e,i,s,a,o,r,n,h,c,g,p){"use strict";function u(t){return t&&"static"===t.type}return function(){function o(t,i,s,a=0){if(this._mosaicPages=[],this._maxItemSize=0,this._currentPage=0,this._fixSpriteLocationsTable=e("fix-sprite-locations"),this._testId=e("test-id"),this._pageWidth=0,this._pageHeight=0,this._mosaicRects=new Map,this._spriteCopyQueue=[],this.pixelRatio=1,(i<=0||s<=0)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!"),this._pageWidth=i,this._pageHeight=s,this._requestRender=t,a>0&&(this._maxItemSize=a),this.pixelRatio=window.devicePixelRatio||1,this._fixSpriteLocationsTable){const t=[];for(const e in this._fixSpriteLocationsTable[this._testId]){const i=this._fixSpriteLocationsTable[this._testId][e];t[i.page]=i.pageSize}for(const e of t)this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(e[0]*e[1])},size:[e[0],e[1]],dirty:!0,texture:void 0})}this._binPack=new p(this._pageWidth,this._pageHeight);const o=Math.floor(this._pageWidth),r=Math.floor(this._pageHeight);this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(o*r)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0})}var n=o.prototype;return n.getWidth=function(t){return t>=this._mosaicPages.length?-1:this._mosaicPages[t].size[0]},n.getHeight=function(t){return t>=this._mosaicPages.length?-1:this._mosaicPages[t].size[1]},n.getPageTexture=function(t){return t<this._mosaicPages.length?this._mosaicPages[t].texture:null},n.has=function(t){return this._mosaicRects.has(t)},n.getSpriteItem=function(t){return this._mosaicRects.get(t)},n.addSpriteItem=function(t,e,i,s,a,o){if(this._mosaicRects.has(t))return this._mosaicRects.get(t);let r,n,h;if(u(i))if(this._fixSpriteLocationsTable&&this._fixSpriteLocationsTable[this._testId]&&this._fixSpriteLocationsTable[this._testId][t]){const e=this._fixSpriteLocationsTable[this._testId][t];r=e.rect,n=e.page,h=e.pageSize}else[r,n,h]=this._allocateImage(e[0],e[1]);else{r=new c(0,0,e[0],e[1]),n=this._mosaicPages.length;const t=void 0;this._mosaicPages.push({mosaicsData:i,size:e,dirty:!0,texture:t})}if(r.width<=0||r.height<=0)return null;const g={rect:r,width:e[0],height:e[1],sdf:a,simplePattern:o,pixelRatio:1,page:n};return this._mosaicRects.set(t,g),u(i)&&this._copy({rect:r,spriteSize:e,spriteData:i.data,page:n,pageSize:h,repeat:s,sdf:a}),g},n.hasItemsToProcess=function(){return 0!==this._spriteCopyQueue.length},n.processNextItem=function(){const t=this._spriteCopyQueue.pop();t&&this._copy(t)},n.getSpriteItems=function(t){const e={};for(const i of t)e[i]=this.getSpriteItem(i);return e},n.getMosaicItemPosition=function(t){const e=this.getSpriteItem(t),i=e&&e.rect;if(!i)return null;i.width=e.width,i.height=e.height;const s=e.width,o=e.height,r=a.SPRITE_PADDING,n=this._mosaicPages[e.page];return{size:[e.width,e.height],tl:[(i.x+r)/n[0],(i.y+r)/n[1]],br:[(i.x+r+s)/n[0],(i.y+r+o)/n[1]],page:e.page}},n.bind=function(t,e,s=0,a=0){const o=this._mosaicPages[s],n=o.mosaicsData;let h=o.texture;if(h||(h=function(t,e,i){if(u(e))return new r(t,{pixelFormat:6408,dataType:5121,width:i[0],height:i[1]},new Uint8Array(e.data.buffer));return new r(t,{pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:i[0],height:i[1]},null)}(t,n,o.size),o.texture=h),h.setSamplingMode(e),u(n))t.bindTexture(h,a),o.dirty&&(h.setData(new Uint8Array(n.data.buffer)),h.generateMipmap());else{const e=n.data,s=e.bindFrame(t,h,a);i.isSome(this._requestRender)&&s&&e.frameCount>0&&this._requestRender.requestRender(),e.bindFrame(t,h,a)}o.dirty=!1},o._copyBits=function(t,e,i,s,a,o,r,n,h,c,g){let p=s*e+i,u=n*o+r;if(g){u-=o;for(let r=-1;r<=c;r++,p=((r+c)%c+s)*e+i,u+=o)for(let e=-1;e<=h;e++)a[u+e]=t[p+(e+h)%h]}else for(let i=0;i<c;i++){for(let e=0;e<h;e++)a[u+e]=t[p+e];p+=e,u+=o}},n._copy=function(t){if(t.page>=this._mosaicPages.length)return;const e=this._mosaicPages[t.page],i=e.mosaicsData;if(!u(e.mosaicsData))throw new s("mapview-invalid-resource","unsuitable data type!");const r=t.spriteData,n=i.data;n&&r||console.error("Source or target images are uninitialized!"),o._copyBits(r,t.spriteSize[0],0,0,n,t.pageSize[0],t.rect.x+a.SPRITE_PADDING,t.rect.y+a.SPRITE_PADDING,t.spriteSize[0],t.spriteSize[1],t.repeat),e.dirty=!0},n._allocateImage=function(t,e){t+=2*a.SPRITE_PADDING,e+=2*a.SPRITE_PADDING;const i=Math.max(t,e);if(this._maxItemSize&&this._maxItemSize<i){const i=Math.pow(2,Math.ceil(g.log2(t))),s=Math.pow(2,Math.ceil(g.log2(e))),a=new c(0,0,t,e);return this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(i*s)},size:[i,s],dirty:!0,texture:void 0}),[a,this._mosaicPages.length-1,[i,s]]}const s=this._binPack.allocate(t,e);if(s.width<=0){const i=this._mosaicPages[this._currentPage];return!i.dirty&&u(i.mosaicsData)&&(i.mosaicsData.data=null),this._currentPage=this._mosaicPages.length,this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(this._pageWidth*this._pageHeight)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0}),this._binPack=new p(this._pageWidth,this._pageHeight),this._allocateImage(t,e)}return[s,this._currentPage,[this._pageWidth,this._pageHeight]]},n.dispose=function(){this._binPack=null;for(const t of this._mosaicPages){const e=t.texture;e&&e.dispose();const i=t.mosaicsData;if(!u(i)){i.data.pause()}}this._mosaicPages=null,this._mosaicRects.clear()},t._createClass(o,[{key:"itemCount",get:function(){return this._mosaicRects.size}}]),o}()}));
