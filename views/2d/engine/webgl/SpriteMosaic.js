/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../core/Error","../../../../core/maybe","../../../webgl/BufferObject","../../../webgl/FramebufferObject","../../../../core/has","../../../webgl/checkWebGLError","../../../webgl/enums","../../../../chunks/builtins","../../../webgl/Texture","../../../webgl/VertexArrayObject","./definitions","./GeometryUtils","./Rect","./RectangleBinPack"],(function(t,e,i,s,a,r,n,o,h,c,g,u,p,_,l){"use strict";function m(t){return t&&"static"===t.type}function d(t,e,i){return m(e)?new c(t,{pixelFormat:6408,dataType:5121,width:i[0],height:i[1]},new Uint8Array(e.data.buffer)):new c(t,{pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:i[0],height:i[1]},null)}return function(){function s(t,e,i,s=0){this._mosaicPages=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects=new Map,this._spriteCopyQueue=[],this.pixelRatio=1,(e<=0||i<=0)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!"),this._pageWidth=e,this._pageHeight=i,this._requestRender=t,s>0&&(this._maxItemSize=s),this.pixelRatio=window.devicePixelRatio||1,this._binPack=new l(this._pageWidth,this._pageHeight);const a=Math.floor(this._pageWidth),r=Math.floor(this._pageHeight);this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(a*r)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0})}var a=s.prototype;return a.getWidth=function(t){return t>=this._mosaicPages.length?-1:this._mosaicPages[t].size[0]},a.getHeight=function(t){return t>=this._mosaicPages.length?-1:this._mosaicPages[t].size[1]},a.getPageTexture=function(t){return t<this._mosaicPages.length?this._mosaicPages[t].texture:null},a.has=function(t){return this._mosaicRects.has(t)},a.getSpriteItem=function(t){return this._mosaicRects.get(t)},a.addSpriteItem=function(t,e,i,s,a,r){if(this._mosaicRects.has(t))return this._mosaicRects.get(t);let n,o,h;if(m(i))[n,o,h]=this._allocateImage(e[0],e[1]);else{n=new _(0,0,e[0],e[1]),o=this._mosaicPages.length;const t=void 0;this._mosaicPages.push({mosaicsData:i,size:e,dirty:!0,texture:t})}if(n.width<=0||n.height<=0)return null;const c={rect:n,width:e[0],height:e[1],sdf:a,simplePattern:r,pixelRatio:1,page:o};return this._mosaicRects.set(t,c),m(i)&&this._copy({rect:n,spriteSize:e,spriteData:i.data,page:o,pageSize:h,repeat:s,sdf:a}),c},a.hasItemsToProcess=function(){return 0!==this._spriteCopyQueue.length},a.processNextItem=function(){const t=this._spriteCopyQueue.pop();t&&this._copy(t)},a.getSpriteItems=function(t){const e={};for(const i of t)e[i]=this.getSpriteItem(i);return e},a.getMosaicItemPosition=function(t){const e=this.getSpriteItem(t),i=e&&e.rect;if(!i)return null;i.width=e.width,i.height=e.height;const s=e.width,a=e.height,r=u.SPRITE_PADDING,n=this._mosaicPages[e.page];return{size:[e.width,e.height],tl:[(i.x+r)/n[0],(i.y+r)/n[1]],br:[(i.x+r+s)/n[0],(i.y+r+a)/n[1]],page:e.page}},a.bind=function(t,e,s=0,a=0){const r=this._mosaicPages[s],n=r.mosaicsData;let o=r.texture;if(o||(o=d(t,n,r.size),r.texture=o),o.setSamplingMode(e),m(n))t.bindTexture(o,a),r.dirty&&(o.setData(new Uint8Array(n.data.buffer)),o.generateMipmap());else{const e=n.data,s=e.bindFrame(t,o,a);i.isSome(this._requestRender)&&s&&e.frameCount>0&&this._requestRender.requestRender(),e.bindFrame(t,o,a)}r.dirty=!1},s._copyBits=function(t,e,i,s,a,r,n,o,h,c,g){let u=s*e+i,p=o*r+n;if(g){p-=r;for(let n=-1;n<=c;n++,u=((n+c)%c+s)*e+i,p+=r)for(let e=-1;e<=h;e++)a[p+e]=t[u+(e+h)%h]}else for(let _=0;_<c;_++){for(let e=0;e<h;e++)a[p+e]=t[u+e];u+=e,p+=r}},a._copy=function(t){if(t.page>=this._mosaicPages.length)return;const i=this._mosaicPages[t.page],a=i.mosaicsData;if(!m(i.mosaicsData))throw new e("mapview-invalid-resource","unsuitable data type!");const r=t.spriteData,n=a.data;n&&r||console.error("Source or target images are uninitialized!"),s._copyBits(r,t.spriteSize[0],0,0,n,t.pageSize[0],t.rect.x+u.SPRITE_PADDING,t.rect.y+u.SPRITE_PADDING,t.spriteSize[0],t.spriteSize[1],t.repeat),i.dirty=!0},a._allocateImage=function(t,e){t+=2*u.SPRITE_PADDING,e+=2*u.SPRITE_PADDING;const i=Math.max(t,e);if(this._maxItemSize&&this._maxItemSize<i){const i=2**Math.ceil(p.log2(t)),s=2**Math.ceil(p.log2(e)),a=new _(0,0,t,e);return this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(i*s)},size:[i,s],dirty:!0,texture:void 0}),[a,this._mosaicPages.length-1,[i,s]]}const s=this._binPack.allocate(t,e);if(s.width<=0){const i=this._mosaicPages[this._currentPage];return!i.dirty&&m(i.mosaicsData)&&(i.mosaicsData.data=null),this._currentPage=this._mosaicPages.length,this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(this._pageWidth*this._pageHeight)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0}),this._binPack=new l(this._pageWidth,this._pageHeight),this._allocateImage(t,e)}return[s,this._currentPage,[this._pageWidth,this._pageHeight]]},a.dispose=function(){this._binPack=null;for(const t of this._mosaicPages){const e=t.texture;e&&e.dispose();const i=t.mosaicsData;if(!m(i)){i.data.pause()}}this._mosaicPages=null,this._mosaicRects.clear()},t._createClass(s,[{key:"itemCount",get:function(){return this._mosaicRects.size}}]),s}()}));
