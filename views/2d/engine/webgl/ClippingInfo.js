/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import t from"../../../../core/Error.js";import e from"../../../../core/Logger.js";import{isSome as r,isNone as s}from"../../../../core/maybe.js";import{watch as i}from"../../../../core/reactiveUtils.js";import{c as o}from"../../../../chunks/mat3f32.js";import{DisplayObject as h}from"../DisplayObject.js";import a from"./Mesh2D.js";import{VertexArrayObject as c}from"../../../webgl/VertexArrayObject.js";const n=e.getLogger("esri.views.2d.engine.webgl.ClippingInfo"),m=t=>parseFloat(t)/100;class p extends h{constructor(t,e){super(),this._clip=e,this._cache={},this.stage=t,this._handle=i((()=>e.version),(()=>this._invalidate())),this.ready()}static fromClipArea(t,e){return new p(t,e)}_destroyGL(){r(this._cache.mesh)&&(this._cache.mesh.destroy(),this._cache.mesh=null),r(this._cache.vao)&&(this._cache.vao.dispose(),this._cache.vao=null)}destroy(){this._destroyGL(),this._handle.remove()}getVAO(t,e,r,i){const[o,h]=e.size;if("geometry"!==this._clip.type&&this._lastWidth===o&&this._lastHeight===h||(this._lastWidth=o,this._lastHeight=h,this._destroyGL()),s(this._cache.vao)){const s=this._createMesh(e,this._clip),o=s.getIndexBuffer(t),h=s.getVertexBuffers(t);this._cache.mesh=s,this._cache.vao=new c(t,r,i,h,o)}return this._cache.vao}_createTransforms(){return{dvs:o()}}_invalidate(){this._destroyGL(),this.requestRender()}_createScreenRect(t,e){const[r,s]=t.size,i="string"==typeof e.left?m(e.left)*r:e.left,o="string"==typeof e.right?m(e.right)*r:e.right,h="string"==typeof e.top?m(e.top)*s:e.top,a="string"==typeof e.bottom?m(e.bottom)*s:e.bottom,c=i,n=h;return{x:c,y:n,width:Math.max(r-o-c,0),height:Math.max(s-a-n,0)}}_createMesh(e,r){switch(r.type){case"rect":return a.fromRect(this._createScreenRect(e,r));case"path":return a.fromPath(r);case"geometry":return a.fromGeometry(e,r);default:return n.error(new t("mapview-bad-type","Unable to create ClippingInfo mesh from clip of type: ${clip.type}")),a.fromRect({x:0,y:0,width:1,height:1})}}}export{p as default};
