/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../../../core/Error","../../../../../core/Logger","../../../../../core/maybe","../../../../webgl/BufferObject","../../../../webgl/FramebufferObject","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/has","../../../../webgl/enums","../../../../webgl/RenderingContext","../../../../../chunks/builtins","../../../../webgl/ProgramCache","../../../../webgl/Texture","../../../../webgl/VertexArrayObject","../enums","../VertexStream","../shaders/BlendPrograms"],(function(e,t,r,n,i,s,a,o,u,d,c,l,f,h,g,b,_){"use strict";const m=r.getLogger("esri.views.2d.engine.webgl.effects.blendEffects.BlendEffect");let p=function(){function e(){this._size=[0,0]}var r=e.prototype;return r.dispose=function(e){this._backBufferTexture&&(this._backBufferTexture.dispose(),this._backBufferTexture=null),this._programCache&&(this._programCache.dispose(),this._programCache=null),this._quad&&(this._quad.dispose(),this._quad=null)},r.draw=function(e,r,n,i,s){const{context:a,drawPhase:o}=e;if(this._setupShader(a),i&&"normal"!==i&&o!==g.WGLDrawPhase.LABEL)return void this._drawBlended(e,r,n,i,s);const u=this._programCache.getProgram(_.blend,"normal");if(!u)return void m.error(new t("mapview-BlendEffect",'Error creating shader program for blend mode "normal"'));a.useProgram(u),r.setSamplingMode(n),a.bindTexture(r,0),u.setUniform1i("u_layerTexture",0),u.setUniform1f("u_opacity",s),a.setBlendingEnabled(!0),a.setBlendFunction(1,771);const d=this._quad;d.draw(),d.unbind()},r._drawBlended=function(e,r,i,s,a){const{context:o,state:u,pixelRatio:d,inFadeTransition:c}=e,{size:l}=u,f=o.getBoundFramebufferObject();let h,g;if(n.isSome(f)){const e=f.descriptor;h=e.width,g=e.height}else h=Math.round(d*l[0]),g=Math.round(d*l[1]);this._createOrResizeTexture(e,h,g);const b=this._backBufferTexture;f.copyToTexture(0,0,h,g,0,0,b),o.setStencilTestEnabled(!1),o.setStencilWriteMask(0),o.setBlendingEnabled(!0),o.setDepthTestEnabled(!1),o.setDepthWriteEnabled(!1);const p=this._programCache.getProgram(_.blend,s);if(!p)return void m.error(new t("mapview-BlendEffect",`Error creating shader program for blend mode ${s}`));o.useProgram(p),b.setSamplingMode(i),o.bindTexture(b,0),p.setUniform1i("u_backbufferTexture",0),r.setSamplingMode(i),o.bindTexture(r,1),p.setUniform1i("u_layerTexture",1),p.setUniform1f("u_opacity",a),p.setUniform1f("u_inFadeOpacity",c?1:0),o.setBlendFunction(1,0);const x=this._quad;x.draw(),x.unbind(),o.setBlendFunction(1,771)},r._setupShader=function(e){this._programCache||(this._programCache=new l(e),this._quad||(this._quad=new b(e,[-1,-1,1,-1,-1,1,1,1])))},r._createOrResizeTexture=function(e,t,r){const{context:n}=e;null!==this._backBufferTexture&&t===this._size[0]&&r===this._size[1]||(this._backBufferTexture?this._backBufferTexture.resize(t,r):this._backBufferTexture=new f(n,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:t,height:r}),this._size[0]=t,this._size[1]=r)},e}();e.BlendEffect=p,Object.defineProperty(e,"__esModule",{value:!0})}));
