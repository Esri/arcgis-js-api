/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/maybe","../definitions","./Effect","../../../../webgl/enums"],(function(t,e,i,n,o,s){"use strict";let r=function(t){function o(){var e;return(e=t.apply(this,arguments)||this).name=e.constructor.name,e.defines=["hittest"],e}e._inheritsLoose(o,t);var r=o.prototype;return r.dispose=function(){i.isSome(this._fbo)&&this._fbo.dispose()},r.createOptions=function({pixelRatio:t},e,i=n.HITTEST_RADIUS){if(!e.length)return null;const o=e.shift(),s=o.x,r=o.y;return this._outstanding=o,{type:"hittest",distance:i*t,position:[s,r]}},r.bind=function(t){const{context:e,attributeView:o}=t;if(!o.size)return;const s=o.getBlock(n.ATTRIBUTE_DATA_GPGPU);if(i.isNone(s))return;const r=s.getFBO(e);e.setViewport(0,0,o.size,o.size),e.bindFramebuffer(r),e.setColorMask(!0,!0,!0,!0),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT|e.gl.DEPTH_BUFFER_BIT)},r.unbind=function(t){},r.draw=function(t){if(i.isNone(this._outstanding))return;const e=this._outstanding;this._outstanding=null,this._resolve(t,e.resolvers)},r._resolve=function(){var t=e._asyncToGenerator((function*(t,e){const{context:o,attributeView:r}=t,c=r.getBlock(n.ATTRIBUTE_DATA_GPGPU);if(i.isNone(c))return void e.forEach((t=>t.resolve([])));const u=c.getFBO(o),l=new Uint8Array(u.width*u.height*4);try{yield u.readPixelsAsync(0,0,u.width,u.height,s.PixelFormat.RGBA,s.PixelType.UNSIGNED_BYTE,l)}catch(d){return void e.forEach((t=>t.resolve([])))}const a=[];for(let i=0;i<l.length;i+=4){const t=l[i],e=l[i+3];t&&a.push({id:i/4,directHits:e})}a.sort(((t,e)=>e.directHits===t.directHits?e.id-t.id:e.directHits-t.directHits));const f=a.map((t=>t.id));e.forEach((t=>t.resolve(f)))}));function o(e,i){return t.apply(this,arguments)}return o}(),o}(o.Effect);t.HittestEffect=r,Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
