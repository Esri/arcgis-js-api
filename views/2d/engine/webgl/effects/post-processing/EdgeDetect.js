/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import e from"../../VertexStream.js";import{BlendFactor as t,TargetType as s,DepthStencilTargetType as i}from"../../../../../webgl/enums.js";import{FramebufferObject as r}from"../../../../../webgl/FramebufferObject.js";class o{constructor(){this._fbo=null,this._size=[0,0],this._programDesc={"frei-chen":{vsPath:"post-processing/pp",fsPath:"post-processing/edge-detect/frei-chen",attributes:new Map([["a_position",0]])},sobel:{vsPath:"post-processing/pp",fsPath:"post-processing/edge-detect/sobel",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){this._fbo&&(this._fbo.dispose(),this._fbo=null),this._quad&&(this._quad.dispose(),this._quad=null)}draw(s,i,r){this._createOrResizeResources(s);const{context:o,state:n,painter:a,pixelRatio:h}=s,{materialManager:p}=a,c=this._programDesc,{size:u}=n,d=[Math.round(h*u[0]),Math.round(h*u[1])],l=o.gl;this._quad||(this._quad=new e(o,[-1,-1,1,-1,-1,1,1,1]));const _="frei-chen",b=this._fbo,f=this._quad;f.bind();const g=p.getProgram(c[_]);o.useProgram(g),o.bindFramebuffer(b),o.setClearColor(0,0,0,0),o.clear(l.COLOR_BUFFER_BIT),o.bindTexture(i.colorTexture,4),g.setUniform1i("u_colorTexture",4),g.setUniform2fv("u_texSize",d),f.draw(),o.bindFramebuffer(i),o.setStencilWriteMask(0),o.setStencilTestEnabled(!1),o.setDepthWriteEnabled(!1),o.setDepthTestEnabled(!1),o.setBlendingEnabled(!0);const m=p.getProgram(c.blit);o.useProgram(m),o.bindTexture(b.colorTexture,6),m.setUniform1i("u_texture",6),o.setBlendFunction(t.ONE,t.ZERO),f.draw(),o.setBlendFunction(t.ONE,t.ONE_MINUS_SRC_ALPHA),f.unbind()}_createOrResizeResources(e){const{context:t,state:o,pixelRatio:n}=e,{size:a}=o,h=Math.round(n*a[0]),p=Math.round(n*a[1]);this._fbo&&this._size[0]===h&&this._size[1]===p||(this._size[0]=h,this._size[1]=p,this._fbo?this._fbo.resize(h,p):this._fbo=new r(t,{colorTarget:s.TEXTURE,depthStencilTarget:i.NONE,width:h,height:p}))}}export{o as EdgeDetect};
