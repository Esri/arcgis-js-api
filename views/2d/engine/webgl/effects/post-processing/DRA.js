/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../../../../core/Logger","../../../../../webgl/BufferObject","../../../../../webgl/FramebufferObject","../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/has","../../../../../webgl/checkWebGLError","../../../../../webgl/enums","../../../../../../chunks/builtins","../../../../../webgl/Texture","../../../../../webgl/VertexArrayObject","../../VertexStream"],(function(e,t,s,r,i,o,n,a,u,h,l,d){"use strict";const c=t.getLogger("esri.views.2d.engine.webgl.effects.post-processing.DRA"),p=2;let f=function(){function e(){this._fbos=null,this._colorAttachmentsPoints=[36064,36065],this._size=[0,0],this._programDesc={"min-max":{vsPath:"post-processing/pp",fsPath:"post-processing/dra/min-max",attributes:new Map([["a_position",0]])},dra:{vsPath:"post-processing/pp",fsPath:"post-processing/dra",attributes:new Map([["a_position",0]])}}}var t=e.prototype;return t.dispose=function(){this._disposeFBOs(),this._layerTexture&&(this._layerTexture.dispose(),this._layerTexture=null)},t.draw=function(e,t,s){this._createOrResizeResources(e);const{context:r,state:i,painter:o,pixelRatio:n}=e,{materialManager:a}=o,u=this._programDesc,{size:h}=i,l=this._fbos,p=[n*h[0],n*h[1]],f=r.capabilities.drawBuffers;if(!f)return void c.error("esri.DRA","WebGL Extension WEBGL_draw_buffers isn't supported!");this._quad||(this._quad=new d(r,[-1,-1,1,-1,-1,1,1,1]));const _=this._layerTexture;t.copyToTexture(0,0,p[0],p[1],0,0,_);const b=this._quad;b.bind();const g=a.getProgram(e,u["min-max"]);r.useProgram(g),r.setBlendingEnabled(!1);let m,x=t.colorTexture,w=t.colorTexture;const T=[p[0],p[1]],M=[0,0];for(let d=0;d<l.length;d++){const e=l[d],t=e.descriptor;M[0]=t.width,M[1]=t.height,r.bindFramebuffer(e),f.drawBuffers(this._colorAttachmentsPoints),r.setViewport(0,0,t.width,t.height),m=d,m>6&&(m=6),r.bindTexture(x,m),r.bindTexture(w,m+1),g.setUniform1i("u_minTexture",m),g.setUniform1i("u_maxTexture",m+1),g.setUniform2fv("u_srcResolution",T),g.setUniform2fv("u_dstResolution",M),b.draw(),x=e.getColorTexture(36064),w=e.getColorTexture(36065),T[0]=M[0],T[1]=M[1]}r.setViewport(0,0,p[0],p[1]),r.bindFramebuffer(t);const y=a.getProgram(e,u.dra);r.useProgram(y),r.bindTexture(x,5),r.bindTexture(w,6),r.bindTexture(_,7),y.setUniform1i("u_minColor",5),y.setUniform1i("u_maxColor",6),y.setUniform1i("u_texture",7),r.setStencilWriteMask(0),r.setStencilTestEnabled(!1),r.setDepthWriteEnabled(!1),r.setDepthTestEnabled(!1),b.draw(),r.setBlendingEnabled(!0),r.setBlendFunction(1,771),r.setStencilTestEnabled(!0),b.unbind()},t._createOrResizeResources=function(e){const{context:t,state:s,pixelRatio:i}=e,{size:o}=s;let n=Math.round(i*o[0]),a=Math.round(i*o[1]);if(this._size[0]!==n||this._size[1]!==a){for(this._size[0]=n,this._size[1]=a,this._disposeFBOs(),this._fbos=[];n>1||a>1;){n=Math.max(1,0|Math.floor((n+p-1)/p)),a=Math.max(1,0|Math.floor((a+p-1)/p));const e={pixelFormat:6408,internalFormat:6408,dataType:5121,samplingMode:9728,wrapMode:33071,flipped:!1,width:n,height:a},s=new r(t,{depthStencilTarget:0,width:n,height:a},[e,e]);this._fbos.push(s)}this._layerTexture?this._layerTexture.resize(Math.round(i*o[0]),Math.round(i*o[1])):this._layerTexture=new h(t,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:Math.round(i*o[0]),height:Math.round(i*o[1])})}},t._disposeFBOs=function(){if(this._fbos){for(const e of this._fbos)e.dispose();this._fbos.length=0,this._fbos=null}},e}();e.DRA=f,Object.defineProperty(e,"__esModule",{value:!0})}));
