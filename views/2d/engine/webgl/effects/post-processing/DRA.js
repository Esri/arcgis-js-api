/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../../../core/has","../../../../../../core/Logger","../../../../../../chunks/builtins","../../../../../webgl/checkWebGLError","../../../../../webgl/Texture","../../../../../webgl/FramebufferObject","../../VertexStream"],(function(e,t,s,i,r,o,n,a){"use strict";const h=s.getLogger("esri.views.2d.engine.webgl.effects.post-processing.DRA"),u=2;let d=function(){function e(){this._fbos=null,this._colorAttachmentsPoints=[36064,36065],this._size=[0,0],this._programDesc={"min-max":{vsPath:"post-processing/pp",fsPath:"post-processing/dra/min-max",attributes:{a_position:0}},dra:{vsPath:"post-processing/pp",fsPath:"post-processing/dra",attributes:{a_position:0}}}}var t=e.prototype;return t.dispose=function(){this._disposeFBOs(),this._layerTexture&&(this._layerTexture.dispose(),this._layerTexture=null)},t.draw=function(e,t,s){this._createOrResizeResources(e);const{context:i,state:r,painter:o,pixelRatio:n}=e,{materialManager:u}=o,d=this._programDesc,{size:l}=r,c=this._fbos,p=[n*l[0],n*l[1]],f=i.capabilities.drawBuffers;if(!f)return void h.error("esri.DRA","WebGL Extension WEBGL_draw_buffers isn't supported!");this._quad||(this._quad=new a(i,[-1,-1,1,-1,-1,1,1,1]));const _=this._layerTexture;t.copyToTexture(0,0,p[0],p[1],0,0,_);const b=this._quad;b.bind();const m=u.getProgram(e,d["min-max"]);i.bindProgram(m),i.setBlendingEnabled(!1);let g,x=t.colorTexture,T=t.colorTexture;const w=[p[0],p[1]],M=[0,0];for(let a=0;a<c.length;a++){const e=c[a],t=e.descriptor;M[0]=t.width,M[1]=t.height,i.bindFramebuffer(e),f.drawBuffers(this._colorAttachmentsPoints),i.setViewport(0,0,t.width,t.height),g=a,g>6&&(g=6),i.bindTexture(x,g),i.bindTexture(T,g+1),m.setUniform1i("u_minTexture",g),m.setUniform1i("u_maxTexture",g+1),m.setUniform2fv("u_srcResolution",w),m.setUniform2fv("u_dstResolution",M),b.draw(),x=e.getColorTexture(36064),T=e.getColorTexture(36065),w[0]=M[0],w[1]=M[1]}i.setViewport(0,0,p[0],p[1]),i.bindFramebuffer(t);const P=u.getProgram(e,d.dra);i.bindProgram(P),i.bindTexture(x,5),i.bindTexture(T,6),i.bindTexture(_,7),P.setUniform1i("u_minColor",5),P.setUniform1i("u_maxColor",6),P.setUniform1i("u_texture",7),i.setStencilWriteMask(0),i.setStencilTestEnabled(!1),i.setDepthWriteEnabled(!1),i.setDepthTestEnabled(!1),b.draw(),i.setBlendingEnabled(!0),i.setBlendFunction(1,771),i.setStencilTestEnabled(!0),b.unbind()},t._createOrResizeResources=function(e){const{context:t,state:s,pixelRatio:i}=e,{size:r}=s;let a=Math.round(i*r[0]),h=Math.round(i*r[1]);if(this._size[0]!==a||this._size[1]!==h){for(this._size[0]=a,this._size[1]=h,this._disposeFBOs(),this._fbos=[];a>1||h>1;){a=Math.max(1,0|Math.floor((a+u-1)/u)),h=Math.max(1,0|Math.floor((h+u-1)/u));const e={pixelFormat:6408,internalFormat:6408,dataType:5121,samplingMode:9728,wrapMode:33071,flipped:!1,width:a,height:h},s=new n(t,{depthStencilTarget:0,width:a,height:h},[{attachmentPoint:36064,texture:e},{attachmentPoint:36065,texture:e}]);this._fbos.push(s)}this._layerTexture?this._layerTexture.resize(Math.round(i*r[0]),Math.round(i*r[1])):this._layerTexture=new o(t,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:Math.round(i*r[0]),height:Math.round(i*r[1])})}},t._disposeFBOs=function(){if(this._fbos){for(const e of this._fbos)e.dispose();this._fbos.length=0,this._fbos=null}},e}();e.DRA=d,Object.defineProperty(e,"__esModule",{value:!0})}));
