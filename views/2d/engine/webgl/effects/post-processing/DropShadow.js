/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../../../core/maybe","../../../../../../core/screenUtils","../../VertexStream","../../../../../webgl/enums","../../../../../webgl/FramebufferObject","../../../../../webgl/Texture"],(function(e,t,r,i,o,s,a){"use strict";const n=[1,0],l=[0,1];let u=function(){function e(){this._layerFBOTexture=null,this._horizontalBlurFBO=null,this._verticalBlurFBO=null,this._size=[0,0],this._quad=null,this._programDesc={blur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/gaussianBlur",attributes:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/drop-shadow/composite",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}var u=e.prototype;return u.dispose=function(){this._layerFBOTexture=t.disposeMaybe(this._layerFBOTexture),this._horizontalBlurFBO=t.disposeMaybe(this._horizontalBlurFBO),this._verticalBlurFBO=t.disposeMaybe(this._verticalBlurFBO)},u.draw=function(e,t,s){const{context:a,state:u,painter:p}=e,{materialManager:h}=p,d=this._programDesc,T=t.width,c=t.height,_=[Math.round(T),Math.round(c)],{blurRadius:B,offsetX:m,offsetY:f,color:x}=s,g=[r.pt2px(m),r.pt2px(f)];this._createOrResizeResources(e,T,c,_);const F=this._horizontalBlurFBO,b=this._verticalBlurFBO;a.setStencilWriteMask(0),a.setStencilTestEnabled(!1),a.setDepthWriteEnabled(!1),a.setDepthTestEnabled(!1);const O=this._layerFBOTexture;t.copyToTexture(0,0,T,c,0,0,O),this._quad||(this._quad=new i(a,[-1,-1,1,-1,-1,1,1,1])),a.setViewport(0,0,_[0],_[1]);const E=this._quad;E.bind(),a.setBlendingEnabled(!1);const y=h.getProgram(d.blur,[{name:"radius",value:Math.ceil(B)}]);a.useProgram(y),a.bindFramebuffer(F),a.bindTexture(t.colorTexture,4),y.setUniform1i("u_colorTexture",4),y.setUniform2fv("u_texSize",_),y.setUniform2fv("u_direction",n),y.setUniform1f("u_sigma",B),E.draw(),a.bindFramebuffer(b),a.bindTexture(F?.colorTexture,5),y.setUniform1i("u_colorTexture",5),y.setUniform2fv("u_direction",l),E.draw(),a.bindFramebuffer(t),a.setViewport(0,0,T,c);const M=h.getProgram(d.composite);a.useProgram(M),a.bindTexture(b?.colorTexture,2),M.setUniform1i("u_blurTexture",2),a.bindTexture(O,3),M.setUniform1i("u_layerFBOTexture",3),M.setUniform4fv("u_shadowColor",[x[3]*(x[0]/255),x[3]*(x[1]/255),x[3]*(x[2]/255),x[3]]),M.setUniformMatrix3fv("u_displayViewMat3",u.displayMat3),M.setUniform2fv("u_shadowOffset",g),E.draw(),a.setBlendingEnabled(!0),a.setStencilTestEnabled(!0),a.setBlendFunction(o.BlendFactor.ONE,o.BlendFactor.ONE_MINUS_SRC_ALPHA),E.unbind()},u._createOrResizeResources=function(e,t,r,i){const{context:n}=e;this._horizontalBlurFBO&&this._size[0]===t&&this._size[1]===r||(this._size[0]=t,this._size[1]=r,this._horizontalBlurFBO?this._horizontalBlurFBO.resize(i[0],i[1]):this._horizontalBlurFBO=new s.FramebufferObject(n,{colorTarget:o.TargetType.TEXTURE,depthStencilTarget:o.DepthStencilTargetType.NONE,width:i[0],height:i[1]},{target:o.TextureType.TEXTURE_2D,pixelFormat:o.PixelFormat.RGBA,internalFormat:o.PixelFormat.RGBA,dataType:o.PixelType.UNSIGNED_BYTE,wrapMode:o.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:o.TextureSamplingMode.LINEAR,flipped:!1,width:i[0],height:i[1]}),this._verticalBlurFBO?this._verticalBlurFBO.resize(i[0],i[1]):this._verticalBlurFBO=new s.FramebufferObject(n,{colorTarget:o.TargetType.TEXTURE,depthStencilTarget:o.DepthStencilTargetType.NONE,width:i[0],height:i[1]},{target:o.TextureType.TEXTURE_2D,pixelFormat:o.PixelFormat.RGBA,internalFormat:o.PixelFormat.RGBA,dataType:o.PixelType.UNSIGNED_BYTE,wrapMode:o.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:o.TextureSamplingMode.LINEAR,flipped:!1,width:i[0],height:i[1]}),this._layerFBOTexture?this._layerFBOTexture.resize(t,r):this._layerFBOTexture=new a.Texture(n,{target:o.TextureType.TEXTURE_2D,pixelFormat:o.PixelFormat.RGBA,internalFormat:o.PixelFormat.RGBA,dataType:o.PixelType.UNSIGNED_BYTE,wrapMode:o.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:o.TextureSamplingMode.LINEAR,flipped:!1,width:t,height:r}))},e}();e.DropShadow=u,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
