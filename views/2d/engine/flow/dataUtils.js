/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../geometry","../../../../core/has","../../../../core/Logger","../../../../core/mathUtils","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/RandomLCG","../../../../geometry/support/spatialReferenceUtils","../../../../geometry/Extent"],(function(t,e,n,r,o,l,i,a,s,c,f){"use strict";const u=o.getLogger("esri.views.2d.engine.flow.dataUtils"),h=10;function d(t,e,n,r){return m.apply(this,arguments)}function m(){return(m=e._asyncToGenerator((function*(t,e,n,o){const l=performance.now(),i=p(e,n),s=performance.now(),c=w(e,i,n.width,n.height),f=performance.now(),d=x(c,!0),m=performance.now(),y="Streamlines"===t?M(d,h):A(d),g=performance.now();return r("esri-2d-profiler")&&(u.info("I.1","_createFlowFieldFromData (ms)",Math.round(s-l)),u.info("I.2","_getStreamlines (ms)",Math.round(f-s)),u.info("I.3","createAnimatedLinesData (ms)",Math.round(m-f)),u.info("I.4","create{Streamlines|Particles}Mesh (ms)",Math.round(g-m)),u.info("I.5","createFlowMesh (ms)",Math.round(g-l)),u.info("I.6","Mesh size (bytes)",y.vertexData.buffer.byteLength+y.indexData.buffer.byteLength)),yield Promise.resolve(),a.throwIfAborted(o),y}))).apply(this,arguments)}function p(t,e){const n=g(e.data,e.width,e.height,t.smoothing);if(t.interpolate){return(t,r)=>{const o=Math.floor(t),l=Math.floor(r);if(o<0||o>=e.width)return[0,0];if(l<0||l>=e.height)return[0,0];const i=t-o,a=r-l,s=o,c=l,f=o<e.width-1?o+1:o,u=l<e.height-1?l+1:l,h=n[2*(c*e.width+s)],d=n[2*(c*e.width+f)],m=n[2*(u*e.width+s)],p=n[2*(u*e.width+f)],y=n[2*(c*e.width+s)+1],w=n[2*(c*e.width+f)+1];return[(h*(1-a)+m*a)*(1-i)+(d*(1-a)+p*a)*i,(y*(1-a)+n[2*(u*e.width+s)+1]*a)*(1-i)+(w*(1-a)+n[2*(u*e.width+f)+1]*a)*i]}}return(t,r)=>{const o=Math.round(t),l=Math.round(r);return o<0||o>=e.width||l<0||l>=e.height?[0,0]:[n[2*(l*e.width+o)+0],n[2*(l*e.width+o)+1]]}}function y(t,e,n,r,o,l,i,a,s){const c=[];let f=n,u=r,h=0,[d,m]=e(f,u);d*=t.velocityScale,m*=t.velocityScale;const p=Math.sqrt(d*d+m*m);let y,w;c.push({x:f,y:u,t:h,speed:p});for(let g=0;g<t.verticesPerLine;g++){let[n,r]=e(f,u);n*=t.velocityScale,r*=t.velocityScale;const d=Math.sqrt(n*n+r*r);if(d<t.minSpeedThreshold)return c;const m=n/d,p=r/d;f+=m*t.segmentLength,u+=p*t.segmentLength;if(h+=t.segmentLength/d,Math.acos(m*y+p*w)>t.maxTurnAngle)return c;if(t.collisions){const t=Math.round(f*s),e=Math.round(u*s);if(t<0||t>i-1||e<0||e>a-1)return c;const n=l[e*i+t];if(-1!==n&&n!==o)return c;l[e*i+t]=o}c.push({x:f,y:u,t:h,speed:d}),y=m,w=p}return c}function w(t,e,n,r){const o=[],l=new s,i=1/Math.max(t.lineCollisionWidth,1),a=Math.round(n*i),c=Math.round(r*i),f=new Int32Array(a*c);for(let s=0;s<f.length;s++)f[s]=-1;const u=[];for(let s=0;s<r;s+=t.lineSpacing)for(let e=0;e<n;e+=t.lineSpacing)u.push({x:e,y:s,sort:l.getFloat()});u.sort(((t,e)=>t.sort-e.sort));for(const{x:s,y:h}of u)if(l.getFloat()<t.density){const n=y(t,e,s,h,o.length,f,a,c,i);if(n.length<2)continue;o.push(n)}return o}function g(t,e,n,r){if(0===r)return t;const o=Math.round(3*r),l=new Array(2*o+1);let i=0;for(let c=-o;c<=o;c++){const t=Math.exp(-c*c/(r*r));l[c+o]=t,i+=t}for(let c=-o;c<=o;c++)l[c+o]/=i;const a=new Float32Array(t.length);for(let c=0;c<n;c++)for(let n=0;n<e;n++){let r=0,i=0;for(let a=-o;a<=o;a++){if(n+a<0||n+a>=e)continue;const s=l[a+o];r+=s*t[2*(c*e+(n+a))+0],i+=s*t[2*(c*e+(n+a))+1]}a[2*(c*e+n)+0]=r,a[2*(c*e+n)+1]=i}const s=new Float32Array(t.length);for(let c=0;c<e;c++)for(let t=0;t<n;t++){let r=0,i=0;for(let s=-o;s<=o;s++){if(t+s<0||t+s>=n)continue;const f=l[s+o];r+=f*a[2*((t+s)*e+c)+0],i+=f*a[2*((t+s)*e+c)+1]}s[2*(t*e+c)+0]=r,s[2*(t*e+c)+1]=i}return s}function x(t,e){const n=new s,r=t.reduce(((t,e)=>t+e.length),0),o=new Float32Array(4*r),l=new Array(t.length);let i=0,a=0;for(const s of t){const t=i;for(const e of s)o[4*i+0]=e.x,o[4*i+1]=e.y,o[4*i+2]=e.t,o[4*i+3]=e.speed,i++;l[a++]={startVertex:t,numberOfVertices:s.length,totalTime:s[s.length-1].t,timeSeed:e?n.getFloat():0}}return{lineVertices:o,lineDescriptors:l}}function M(t,e){const n=9,{lineVertices:r,lineDescriptors:o}=t;let l=0,i=0;for(const d of o){l+=2*d.numberOfVertices;i+=6*(d.numberOfVertices-1)}const a=new Float32Array(l*n),s=new Uint32Array(i);let c=0,f=0;function u(){s[f++]=c-2,s[f++]=c,s[f++]=c-1,s[f++]=c,s[f++]=c+1,s[f++]=c-1}function h(t,e,r,o,l,i,s,f){const u=c*n;let h=0;a[u+h++]=t,a[u+h++]=e,a[u+h++]=1,a[u+h++]=r,a[u+h++]=i,a[u+h++]=s,a[u+h++]=o/2,a[u+h++]=l/2,a[u+h++]=f,c++,a[u+h++]=t,a[u+h++]=e,a[u+h++]=-1,a[u+h++]=r,a[u+h++]=i,a[u+h++]=s,a[u+h++]=-o/2,a[u+h++]=-l/2,a[u+h++]=f,c++}for(const d of o){const{totalTime:t,timeSeed:n}=d;let o=null,l=null,i=null,a=null,s=null,c=null;for(let f=0;f<d.numberOfVertices;f++){const m=r[4*(d.startVertex+f)+0],p=r[4*(d.startVertex+f)+1],y=r[4*(d.startVertex+f)+2],w=r[4*(d.startVertex+f)+3];let g=null,x=null,M=null,A=null;if(f>0){g=m-o,x=p-l;const r=Math.sqrt(g*g+x*x);if(g/=r,x/=r,f>1){let t=g+s,n=x+c;const r=Math.sqrt(t*t+n*n);t/=r,n/=r;const o=Math.min(1/(t*g+n*x),e);t*=o,n*=o,M=-n,A=t}else M=-x,A=g;null!==M&&null!==A&&(h(o,l,i,M,A,t,n,w),u())}o=m,l=p,i=y,s=g,c=x,a=w}h(o,l,i,-c,s,t,n,a)}return{vertexData:a,indexData:s}}function A(t){const e=16,n=1,r=2,{lineVertices:o,lineDescriptors:l}=t;let i=0,a=0;for(const P of l){const t=P.numberOfVertices-1;i+=4*t*2,a+=6*t*2}const s=new Float32Array(i*e),c=new Uint32Array(a);let f,u,h,d,m,p,y,w,g,x,M,A,I,b,V=0,F=0;function S(){c[F++]=V-8,c[F++]=V-7,c[F++]=V-6,c[F++]=V-7,c[F++]=V-5,c[F++]=V-6,c[F++]=V-4,c[F++]=V-3,c[F++]=V-2,c[F++]=V-3,c[F++]=V-1,c[F++]=V-2}function D(t,o,l,i,a,c,f,u,h,d,m,p,y,w){const g=V*e;let x=0;for(const e of[n,r])for(const n of[1,2,3,4])s[g+x++]=t,s[g+x++]=o,s[g+x++]=l,s[g+x++]=i,s[g+x++]=f,s[g+x++]=u,s[g+x++]=h,s[g+x++]=d,s[g+x++]=e,s[g+x++]=n,s[g+x++]=y,s[g+x++]=w,s[g+x++]=a/2,s[g+x++]=c/2,s[g+x++]=m/2,s[g+x++]=p/2,V++}function v(t,e){let n=g+M,r=x+A;const o=Math.sqrt(n*n+r*r);n/=o,r/=o;const l=g*n+x*r;n/=l,r/=l;let i=M+I,a=A+b;const s=Math.sqrt(i*i+a*a);i/=s,a/=s;const c=M*i+A*a;i/=c,a/=c,D(f,u,h,d,-r,n,m,p,y,w,-a,i,t,e),S()}function k(t,e,n,r,o,l){if(g=M,x=A,M=I,A=b,null==g&&null==x&&(g=M,x=A),null!=m&&null!=p){I=t-m,b=e-p;const n=Math.sqrt(I*I+b*b);I/=n,b/=n}null!=g&&null!=x&&v(o,l),f=m,u=p,h=y,d=w,m=t,p=e,y=n,w=r}function L(t,e){g=M,x=A,M=I,A=b,null==g&&null==x&&(g=M,x=A),null!=g&&null!=x&&v(t,e)}for(const P of l){f=null,u=null,h=null,d=null,m=null,p=null,y=null,w=null,g=null,x=null,M=null,A=null,I=null,b=null;const{totalTime:t,timeSeed:e}=P;for(let n=0;n<P.numberOfVertices;n++){k(o[4*(P.startVertex+n)+0],o[4*(P.startVertex+n)+1],o[4*(P.startVertex+n)+2],o[4*(P.startVertex+n)+3],t,e)}L(t,e)}return{vertexData:s,indexData:c}}function I(t,e){const n=e.pixels,{width:r,height:o}=e,i=new Float32Array(r*o*2),a=e.mask||new Uint8Array(r*o*2);if(e.mask||a.fill(255),"vector-uv"===t)for(let l=0;l<r*o;l++)i[2*l+0]=n[0][l],i[2*l+1]=-n[1][l];else if("vector-magdir"===t)for(let s=0;s<r*o;s++){const t=n[0][s],e=l.deg2rad(n[1][s]),r=Math.cos(e-Math.PI/2),o=Math.sin(e-Math.PI/2);i[2*s+0]=r*t,i[2*s+1]=o*t}return{data:i,mask:a,width:r,height:o}}function b(t,e,n,r,o,l){return V.apply(this,arguments)}function V(){return(V=e._asyncToGenerator((function*(t,e,n,o,l,i){const a=performance.now(),s=c.getInfo(e.spatialReference);if(!s){const s=yield F(t,e,n,o,l,i);return r("esri-2d-profiler")&&u.info("I.7","loadImagery, early exit (ms)",Math.round(performance.now()-a)),r("esri-2d-profiler")&&u.info("I.9","Number of parts",1),s}const[h,d]=s.valid,m=d-h,p=Math.ceil(e.width/m),y=e.width/p,w=Math.round(n/p);let g=e.xmin;const x=[],M=performance.now();for(let r=0;r<p;r++){const n=new f({xmin:g,xmax:g+y,ymin:e.ymin,ymax:e.ymax,spatialReference:e.spatialReference});x.push(F(t,n,w,o,l,i)),g+=y}const A=yield Promise.all(x);r("esri-2d-profiler")&&u.info("I.8","All calls to _fetchPart (ms)",Math.round(performance.now()-M)),r("esri-2d-profiler")&&u.info("I.9","Number of parts",A.length);const I={data:new Float32Array(n*o*2),mask:new Uint8Array(n*o),width:n,height:o};let b=0;for(const r of A){for(let t=0;t<r.height;t++)for(let e=0;e<r.width;e++)b+e>=n||(I.data[2*(t*n+b+e)+0]=r.data[2*(t*r.width+e)+0],I.data[2*(t*n+b+e)+1]=r.data[2*(t*r.width+e)+1],I.mask[t*n+b+e]=r.mask[t*r.width+e]);b+=r.width}return r("esri-2d-profiler")&&u.info("I.10","loadImagery, general exit (ms)",Math.round(performance.now()-a)),I}))).apply(this,arguments)}function F(t,e,n,r,o,l){return S.apply(this,arguments)}function S(){return(S=e._asyncToGenerator((function*(t,e,n,r,o,l){const a={requestProjectedLocalDirections:!0,signal:l};if(i.isSome(o)&&(a.timeExtent=o),"imagery"===t.type){yield t.load({signal:l});const o=t.rasterInfo.dataType,s=yield t.fetchImage(e,n,r,a);return!s||i.isNone(s.pixelData)||i.isNone(s.pixelData.pixelBlock)?{data:new Float32Array(n*r*2),mask:new Uint8Array(n*r),width:n,height:r}:I(o,s.pixelData.pixelBlock)}yield t.load({signal:l});const s=t.rasterInfo.dataType,c=yield t.fetchPixels(e,n,r,a);return!c||i.isNone(c.pixelBlock)?{data:new Float32Array(n*r*2),mask:new Uint8Array(n*r),width:n,height:r}:I(s,c.pixelBlock)}))).apply(this,arguments)}t.createAnimatedLinesData=x,t.createFlowMesh=d,t.createParticlesMesh=A,t.createStreamlinesMesh=M,t.loadImagery=b,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
