/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../chunks/mat3","../../../../chunks/mat3f32","../../../../chunks/vec2f32","../../../../layers/support/rasterFunctions/pixelUtils","../DisplayObject","../../../webgl/enums","../../../webgl/rasterUtils"],(function(e,t,r,s,i,o,n,u,a,l){"use strict";const h={bandCount:3,outMin:0,outMax:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:"none",type:"stretch"};let d=function(e){function u(t=null,r=null,s=null){var i;return(i=e.call(this)||this)._textureInvalidated=!0,i._colormapTextureInvalidated=!0,i._rasterTexture=null,i._rasterTextureBandIds=null,i._transformGridTexture=null,i._colormapTexture=null,i._colormap=null,i._supportsBilinearTexture=!0,i._processedTexture=null,i.functionTextures=[],i.projected=!1,i.stencilRef=0,i.coordScale=[1,1],i._processed=!1,i._symbolizerParameters=null,i.height=null,i.isRendereredSource=!1,i.pixelRatio=1,i.resolution=0,i.rotation=0,i._source=null,i.rawPixelData=null,i._suspended=!1,i._bandIds=null,i._interpolation=null,i._transformGrid=null,i.width=null,i.x=0,i.y=0,i.source=t,i.transformGrid=r,i.interpolation=s,i}t._inheritsLoose(u,e);var d=u.prototype;return d.destroy=function(){this._disposeTextures()},d.invalidateTexture=function(){this._textureInvalidated||(this._textureInvalidated=!0,this.requestRender())},d._createTransforms=function(){return{dvs:i.create()}},d.setTransform=function(e){const t=s.identity(this.transforms.dvs),[r,i]=e.toScreenNoRotation([0,0],[this.x,this.y]),n=this.resolution/this.pixelRatio/e.resolution,u=n*this.width,a=n*this.height,l=Math.PI*this.rotation/180;s.translate(t,t,o.fromValues(r,i)),s.translate(t,t,o.fromValues(u/2,a/2)),s.rotate(t,t,-l),s.translate(t,t,o.fromValues(-u/2,-a/2)),s.scaleByVec2(t,t,o.fromValues(u,a)),s.multiply(this.transforms.dvs,e.displayViewMat3,t)},d.getTextures=function({forProcessing:e=!1,useProcessedTexture:t=!1}={}){const r=t?this._processedTexture??this._rasterTexture:this._rasterTexture,s=[],i=[];return r?t?(i.push(r),s.push("u_image"),this._colormapTexture&&(i.push(this._colormapTexture),s.push("u_colormap")),{names:s,textures:i}):(this._transformGridTexture&&(i.push(this._transformGridTexture),s.push("u_transformGrid")),i.push(r),s.push("u_image"),this._colormapTexture&&!e&&(i.push(this._colormapTexture),s.push("u_colormap")),{names:s,textures:i}):{names:s,textures:i}},d.onAttach=function(){this.invalidateTexture()},d.onDetach=function(){this.invalidateTexture()},d.updateTexture=function({context:e}){if(!this.stage)return void this._disposeTextures();const t=this._isValidSource(this.source);t&&this._colormapTextureInvalidated&&(this._colormapTextureInvalidated=!1,this._updateColormapTexture(e)),this._textureInvalidated&&(this._textureInvalidated=!1,this._createOrDestroyRasterTexture(e),this._rasterTexture&&(t?this.transformGrid&&!this._transformGridTexture&&(this._transformGridTexture=l.createTransformTexture(e,this.transformGrid)):this._rasterTexture.setData(null)),this.suspended||(this.ready(),this.requestRender()))},d.updateProcessedTexture=function(){const{functionTextures:e}=this;0!==e.length&&(this.processedTexture=e.shift(),e.forEach((e=>e?.dispose())),e.length=0)},d._createOrDestroyRasterTexture=function(e){const t=r.isSome(this.source)?n.extractBands(this.source,this.bandIds):null;if(!this._isValidSource(t))return void(this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTextureBandIds=null,this._rasterTexture=null));const s=!this._isBandIdschanged(this.bandIds);if(this._rasterTexture){if(s)return;this._rasterTexture.dispose(),this._rasterTextureBandIds=null,this._rasterTexture=null}this._supportsBilinearTexture=!!e.capabilities.textureFloat?.textureFloatLinear;const i=this._getTextureSamplingMethod(this.interpolation),o=this.isRendereredSource||!e.capabilities.textureFloat?.textureFloat;this._rasterTexture=l.createRasterTexture(e,t,i,o),this.projected=!1,this._processed=!1,this._rasterTextureBandIds=this.bandIds?[...this.bandIds]:null},d._isBandIdschanged=function(e){const t=this._rasterTextureBandIds;return!(null==t&&null==e||t&&e&&t.join("")===e.join(""))},d._isValidSource=function(e){return r.isSome(e)&&e.pixels?.length>0},d._getTextureSamplingMethod=function(e){const{type:t,colormap:s}=this.symbolizerParameters,i="lut"===t||"stretch"===t&&r.isSome(s);return!this._supportsBilinearTexture||i||"bilinear"!==e&&"cubic"!==e?"nearest":"bilinear"},d._updateColormapTexture=function(e){const t=this._colormap,r=this.symbolizerParameters.colormap;return r?t?r.length!==t.length||r.some(((e,r)=>e!==t[r]))?(this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),this._colormapTexture=l.createColormapTexture(e,r),void(this._colormap=r)):void 0:(this._colormapTexture=l.createColormapTexture(e,r),void(this._colormap=r)):(this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),void(this._colormap=null))},d._disposeTextures=function(e=!1){this._transformGridTexture&&(this._transformGridTexture.dispose(),this._transformGridTexture=null),!e&&this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null,this._colormap=null,this._colormapTextureInvalidated=!0),!e&&this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTexture=null,this._rasterTextureBandIds=null),this._processedTexture&&(this._processedTexture.dispose(),this._processedTexture=null)},t._createClass(u,[{key:"processedTexture",get:function(){return this._processedTexture},set:function(e){this._processedTexture!==e&&(this._disposeTextures(!0),this._processedTexture=e)}},{key:"rasterTexture",get:function(){return this._rasterTexture},set:function(e){this._rasterTexture!==e&&(this._rasterTexture?.dispose(),this._rasterTexture=e)}},{key:"processed",get:function(){return this._processed},set:function(e){this._processed=e,e||(r.disposeMaybe(this.processedTexture),this.invalidateTexture())}},{key:"symbolizerParameters",get:function(){return this._symbolizerParameters||h},set:function(e){this._symbolizerParameters!==e&&(this._symbolizerParameters=e,this._colormapTextureInvalidated=!0,this.commonUniforms=null)}},{key:"source",get:function(){return this._source},set:function(e){this._source!==e&&(this._source=e,this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTexture=null,this._rasterTextureBandIds=null),this.projected=!1,this.invalidateTexture())}},{key:"suspended",get:function(){return this._suspended},set:function(e){this._suspended&&!e&&this.stage&&(this.ready(),this.requestRender()),this._suspended=e}},{key:"bandIds",get:function(){return this._bandIds},set:function(e){this._bandIds=e,this._isBandIdschanged(e)&&(this.projected=!1,this.invalidateTexture())}},{key:"interpolation",get:function(){return this._interpolation||"nearest"},set:function(e){this._interpolation=e,this._rasterTexture&&this._rasterTexture.setSamplingMode("bilinear"===this._getTextureSamplingMethod(e||"nearest")?a.TextureSamplingMode.LINEAR:a.TextureSamplingMode.NEAREST)}},{key:"transformGrid",get:function(){return this._transformGrid},set:function(e){this._transformGrid=e,this._transformGridTexture=r.disposeMaybe(this._transformGridTexture)}}]),u}(u.DisplayObject),c=function(e){function r(){return e.apply(this,arguments)||this}return t._inheritsLoose(r,e),t._createClass(r,[{key:"source",get:function(){return this._source}}]),r}(d);function _(e){return r.isSome(e.source)}e.RasterBitmap=d,e.RasterBitmapWithSource=c,e.hasSource=_,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
