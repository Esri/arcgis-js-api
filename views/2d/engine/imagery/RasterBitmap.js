/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../chunks/mat3","../../../../chunks/mat3f32","../../../../chunks/vec2f32","../../../../layers/support/rasterFunctions/pixelUtils","../DisplayObject","../../../webgl/enums","../../../webgl/rasterUtils"],(function(t,e,r,s,i,n,a,o,u,l){"use strict";const h={bandCount:3,outMin:0,outMax:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:"none",type:"stretch"};let d=function(t){function o(e=null,r=null,s=null){var i;return(i=t.call(this)||this)._textureInvalidated=!0,i._colormapTextureInvalidated=!0,i._supportsBilinearTexture=!0,i.stencilRef=0,i.coordScale=[1,1],i._symbolizerParameters=null,i.height=null,i.isRendereredSource=!1,i.pixelRatio=1,i.resolution=0,i.rotation=0,i._source=null,i.rawPixelData=null,i._suspended=!1,i._bandIds=null,i._interpolation=null,i._transformGrid=null,i.width=null,i.x=0,i.y=0,i.source=e,i.transformGrid=r,i.interpolation=s,i}e._inheritsLoose(o,t);var d=o.prototype;return d.destroy=function(){this.getTextures()?.textures.forEach((t=>t.dispose())),this._rasterTexture=null,this._transformGridTexture=null,this._colormapTexture=null},d.invalidateTexture=function(){this._textureInvalidated||(this._textureInvalidated=!0,this.requestRender())},d._createTransforms=function(){return{dvs:i.create()}},d.setTransform=function(t){const e=s.identity(this.transforms.dvs),[r,i]=t.toScreenNoRotation([0,0],[this.x,this.y]),a=this.resolution/this.pixelRatio/t.resolution,o=a*this.width,u=a*this.height,l=Math.PI*this.rotation/180;s.translate(e,e,n.fromValues(r,i)),s.translate(e,e,n.fromValues(o/2,u/2)),s.rotate(e,e,-l),s.translate(e,e,n.fromValues(-o/2,-u/2)),s.scaleByVec2(e,e,n.fromValues(o,u)),s.multiply(this.transforms.dvs,t.displayViewMat3,e)},d.getTextures=function(){if(!this._rasterTexture)return null;const t=[],e=[];return this._transformGridTexture&&(e.push(this._transformGridTexture),t.push("u_transformGrid")),this._rasterTexture&&(e.push(this._rasterTexture),t.push("u_image")),this._colormapTexture&&(e.push(this._colormapTexture),t.push("u_colormap")),{names:t,textures:e}},d.onAttach=function(){this.invalidateTexture()},d.onDetach=function(){this.invalidateTexture()},d.updateTexture=function({context:t}){if(!this.stage)return this._rasterTexture?.dispose(),this._transformGridTexture?.dispose(),this._colormapTexture?.dispose(),this._rasterTexture=null,this._rasterTextureBandIds=null,this._transformGridTexture=null,void(this._colormapTexture=null);const e=this._isValidSource(this.source);e&&this._colormapTextureInvalidated&&(this._colormapTextureInvalidated=!1,this._updateColormapTexture(t)),this._textureInvalidated&&(this._textureInvalidated=!1,this._createOrDestroyRasterTexture(t),this._rasterTexture&&(e?this.transformGrid&&!this._transformGridTexture&&(this._transformGridTexture=l.createTransformTexture(t,this.transformGrid)):this._rasterTexture.setData(null)),this.suspended||(this.ready(),this.requestRender()))},d._createOrDestroyRasterTexture=function(t){const e=r.isSome(this.source)?a.extractBands(this.source,this.bandIds):null;if(!this._isValidSource(e))return void(this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTextureBandIds=null,this._rasterTexture=null));const s=!this._isBandIdschanged(this.bandIds);if(this._rasterTexture){if(s)return;this._rasterTexture.dispose(),this._rasterTextureBandIds=null,this._rasterTexture=null}this._supportsBilinearTexture=t.capabilities.textureFloat?.textureFloatLinear;const i=this._getTextureSamplingMethod(this.interpolation),n=this.isRendereredSource||!t.capabilities.textureFloat?.textureFloat;this._rasterTexture=l.createRasterTexture(t,e,i,n),this._rasterTextureBandIds=this.bandIds?[...this.bandIds]:null},d._isBandIdschanged=function(t){const e=this._rasterTextureBandIds;return!(null==e&&null==t||e&&t&&e.join("")===t.join(""))},d._isValidSource=function(t){return r.isSome(t)&&t.pixels?.length>0},d._getTextureSamplingMethod=function(t){const{type:e,colormap:s}=this.symbolizerParameters,i="lut"===e||"stretch"===e&&r.isSome(s);return!this._supportsBilinearTexture||i||"bilinear"!==t&&"cubic"!==t?"nearest":"bilinear"},d._updateColormapTexture=function(t){const e=this._colormap,r=this.symbolizerParameters.colormap;return r?e?r.length!==e.length||r.some(((t,r)=>t!==e[r]))?(this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),this._colormapTexture=l.createColormapTexture(t,r),void(this._colormap=r)):void 0:(this._colormapTexture=l.createColormapTexture(t,r),void(this._colormap=r)):(this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),void(this._colormap=null))},e._createClass(o,[{key:"symbolizerParameters",get:function(){return this._symbolizerParameters||h},set:function(t){this._symbolizerParameters!==t&&(this._symbolizerParameters=t,this._colormapTextureInvalidated=!0)}},{key:"source",get:function(){return this._source},set:function(t){this._source!==t&&(this._source=t,this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTexture=null,this._rasterTextureBandIds=null),this.invalidateTexture())}},{key:"suspended",get:function(){return this._suspended},set:function(t){this._suspended&&!t&&this.stage&&(this.ready(),this.requestRender()),this._suspended=t}},{key:"bandIds",get:function(){return this._bandIds},set:function(t){this._bandIds=t,this._isBandIdschanged(t)&&this.invalidateTexture()}},{key:"interpolation",get:function(){return this._interpolation||"nearest"},set:function(t){this._interpolation=t,this._rasterTexture&&this._rasterTexture.setSamplingMode("bilinear"===this._getTextureSamplingMethod(t)?u.TextureSamplingMode.LINEAR:u.TextureSamplingMode.NEAREST)}},{key:"transformGrid",get:function(){return this._transformGrid},set:function(t){this._transformGrid=t,this._transformGridTexture&&(this._transformGridTexture.dispose(),this._transformGridTexture=null)}}]),o}(o.DisplayObject),c=function(t){function r(){return t.apply(this,arguments)||this}return e._inheritsLoose(r,t),e._createClass(r,[{key:"source",get:function(){return this._source}}]),r}(d);function _(t){return r.isSome(t.source)}t.RasterBitmap=d,t.RasterBitmapWithSource=c,t.hasSource=_,Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
