/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","./RasterBitmap","../webgl/VertexStream","../webgl/brushes/WGLBrush","../../../webgl/enums","../../../webgl/rasterUtils"],(function(e,t,r,s,n,i,o){"use strict";let a=function(n){function a(){var e;return(e=n.apply(this,arguments)||this)._desc={lut:{vsPath:"raster/lut",fsPath:"raster/lut",attributes:new Map([["a_position",0],["a_texcoord",1]])},stretch:{vsPath:"raster/stretch",fsPath:"raster/stretch",attributes:new Map([["a_position",0],["a_texcoord",1]])},hillshade:{vsPath:"raster/hillshade",fsPath:"raster/hillshade",attributes:new Map([["a_position",0],["a_texcoord",1]])}},e._rendererUniformInfos=new Map,e}e._inheritsLoose(a,n);var c=a.prototype;return c.dispose=function(){this._quad&&this._quad.dispose()},c.prepareState=function({context:e}){e.setBlendingEnabled(!0),e.setBlendFunctionSeparate(i.BlendFactor.ONE,i.BlendFactor.ONE_MINUS_SRC_ALPHA,i.BlendFactor.ONE,i.BlendFactor.ONE_MINUS_SRC_ALPHA),e.setColorMask(!0,!0,!0,!0),e.setStencilWriteMask(0),e.setStencilTestEnabled(!0)},c.draw=function(e,t){if(!r.hasSource(t)||t.suspended)return;const{timeline:s,context:n,painter:o}=e;s.begin(this.name),n.setStencilFunction(i.CompareFunction.EQUAL,t.stencilRef,255);const a=!n.capabilities.textureFloat?.textureFloatLinear;t.updateTexture(e);const c=this._getShaderVariations(t,a),l=o.materialManager.getProgram(this._desc[t.symbolizerParameters.type],c);this._drawWithProgram(e,l,t),s.end(this.name)},c._drawWithProgram=function({context:e,requestRender:r,allowDelayedRender:n},i,a,c=1,l=[0,0],u=!1){if(this._quad||(this._quad=new s(e,[0,0,1,0,0,1,1,1])),n&&t.isSome(r)&&!i.isCompiled)return void r();const{symbolizerParameters:h,transformGrid:d,width:p,height:f,opacity:m}=a,_=h.type;e.useProgram(i);const g=this._getShaderVariations(a),b=this._getUniformInfos(_,e,i,g),{names:S,textures:U}=a.getTextures();o.setTextures(e,i,S,U);const P=o.getBasicGridUniforms(c,l),w=o.getCommonUniforms(d,[p,f],[a.source.width,a.source.height],m,u);if(o.setUniforms(i,b,{u_coordScale:a.coordScale,u_dvsMat3:a.transforms.dvs,...P,...w}),h.colormap){const{colormap:e,colormapOffset:t}=h,r=o.getColormapUniforms(e,t);o.setUniforms(i,b,r)}if("stretch"===h.type){const e=o.getStretchUniforms(h);o.setUniforms(i,b,e)}else if("hillshade"===h.type){const e=o.getShadedReliefUniforms(h);o.setUniforms(i,b,e)}this._quad.draw()},c._getUniformInfos=function(e,t,r,s){const n=s.length>0?e+"-"+s.join("-"):e;if(this._rendererUniformInfos.has(n))return this._rendererUniformInfos.get(n);const i=o.getUniformLocationInfos(t,r);return this._rendererUniformInfos.set(n,i),i},c._getShaderVariations=function(e,t=!1){const r=[],{interpolation:s}=e,{type:n,colormap:i}=e.symbolizerParameters;return"cubic"===s?r.push("bicubic"):"bilinear"===s&&"stretch"===n&&null!=i?(r.push("bilinear"),r.push("nnedge")):t&&"bilinear"===s&&r.push("bilinear"),e.isRendereredSource?r.push("noop"):i&&r.push("applyColormap"),e.transformGrid&&(r.push("applyProjection"),1===e.transformGrid.spacing[0]&&r.push("lookupProjection")),r},a}(n);return a}));
