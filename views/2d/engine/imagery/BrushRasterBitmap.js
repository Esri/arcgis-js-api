/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","./RasterBitmap","./colorizer/rasterColorizer","./processor/rasterProcessor","../webgl/definitions","../webgl/VertexStream","../webgl/brushes/WGLBrush","../../../webgl/enums","../../../webgl/FramebufferObject","../../../webgl/rasterUtils"],(function(e,t,r,n,i,s,o,a,c,d,u){"use strict";let f=function(a){function f(){var e;return(e=a.apply(this,arguments)||this).name="raster",e._quad=null,e._rendererUniformInfos=new Map,e._fbo=null,e}e._inheritsLoose(f,a);var m=f.prototype;return m.dispose=function(){t.disposeMaybe(this._quad),t.disposeMaybe(this._fbo)},m.prepareState=function(e){const{context:t,renderPass:r}=e,n="raster"===r;t.setBlendingEnabled(!n),t.setBlendFunctionSeparate(c.BlendFactor.ONE,c.BlendFactor.ONE_MINUS_SRC_ALPHA,c.BlendFactor.ONE,c.BlendFactor.ONE_MINUS_SRC_ALPHA),t.setColorMask(!0,!0,!0,!0),t.setStencilWriteMask(0),t.setStencilTestEnabled(!n)},m.draw=function(e,t){if(!r.hasSource(t)||t.suspended)return;const{renderPass:n}=e;if("raster-bitmap"!==n)return"raster"===n?this._process(e,t):void this._drawBitmap(e,t,!0);this._drawBitmap(e,t)},m._process=function(e,r){const{rasterFunction:n}=e,s="Reproject"===n.name;if(!(s?!(r.rasterTexture&&r.projected):!r.processed))return;const{timeline:o,context:a}=e;o.begin(this.name);const d=a.getBoundFramebufferObject(),u=a.getViewport();s||(r.processedTexture=t.disposeMaybe(r.processedTexture)),a.setStencilFunction(c.CompareFunction.EQUAL,r.stencilRef,255),r.updateTexture(e),this._initQuad(a);const{isStandardRasterTileSize:f,fbo:m}=this._getRasterFBO(a,r.width,r.height);i.process(e,this._quad,m,r),f||m.dispose(),a.bindFramebuffer(d),a.setViewport(u.x,u.y,u.width,u.height),o.end(this.name)},m._drawBitmap=function(e,r,i=!1){const{timeline:s,context:a}=e;if(s.begin(this.name),a.setStencilFunction(c.CompareFunction.EQUAL,r.stencilRef,255),r.updateTexture(e),i&&!r.processedTexture){if(r.updateProcessedTexture(),!r.processedTexture)return void s.end(this.name);r.processed=!0}this._initBitmapCommonUniforms(r);const d=r.symbolizerParameters.type,u=n.getColorizer(d),{requestRender:f,allowDelayedRender:m}=e,{defines:h,program:l}=u.createProgram(e,r,i);if(m&&t.isSome(f)&&!l.compiled)return void f();a.useProgram(l);const p=this._getUniformInfos(d,a,l,h);this._quad||(this._quad=new o(a,[0,0,1,0,0,1,1,1])),u.bindTextureAndUniforms(e,l,r,p,i),this._quad.draw(),s.end(this.name)},m._initBitmapCommonUniforms=function(e){if(!e.commonUniforms){const t=u.getBasicGridUniforms(1,[0,0]),{transformGrid:r,width:n,height:i}=e,s=u.getCommonUniforms(r,[n,i],[e.source.width,e.source.height],1,!1);e.commonUniforms={...t,...s,u_coordScale:e.coordScale}}},m._getRasterFBO=function(e,t,r){const n=t===s.TILE_SIZE||r===s.TILE_SIZE;return n?(this._fbo||(this._fbo=this._createNewFBO(e,t,r)),{isStandardRasterTileSize:n,fbo:this._fbo}):{isStandardRasterTileSize:n,fbo:this._createNewFBO(e,t,r)}},m._createNewFBO=function(e,t,r){const n=i.createTexture(e,t,r);return new d.FramebufferObject(e,{colorTarget:c.TargetType.TEXTURE,depthStencilTarget:c.DepthStencilTargetType.NONE,width:t,height:r},n)},m._initQuad=function(e){this._quad||(this._quad=new o(e,[0,0,1,0,0,1,1,1]))},m._getUniformInfos=function(e,t,r,n){const i=n.length>0?e+"-"+n.join("-"):e;if(this._rendererUniformInfos.has(i))return this._rendererUniformInfos.get(i);const s=u.getUniformLocationInfos(t,r);return this._rendererUniformInfos.set(i,s),s},f}(a);return f}));
