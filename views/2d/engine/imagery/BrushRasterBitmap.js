/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","./RasterBitmap","../webgl/VertexStream","../webgl/brushes/WGLBrush","../../../webgl/enums","../../../webgl/rasterUtils"],(function(e,t,r,s,n,i){"use strict";let o=function(s){function o(){var e;return(e=s.apply(this,arguments)||this)._desc={lut:{vsPath:"raster/lut",fsPath:"raster/lut",attributes:new Map([["a_position",0],["a_texcoord",1]])},stretch:{vsPath:"raster/stretch",fsPath:"raster/stretch",attributes:new Map([["a_position",0],["a_texcoord",1]])},hillshade:{vsPath:"raster/hillshade",fsPath:"raster/hillshade",attributes:new Map([["a_position",0],["a_texcoord",1]])}},e._rendererUniformInfos=new Map,e}e._inheritsLoose(o,s);var a=o.prototype;return a.dispose=function(){this._quad&&this._quad.dispose()},a.prepareState=function({context:e},t){e.setBlendingEnabled(!0),e.setBlendFunctionSeparate(n.BlendFactor.ONE,n.BlendFactor.ONE_MINUS_SRC_ALPHA,n.BlendFactor.ONE,n.BlendFactor.ONE_MINUS_SRC_ALPHA),e.setColorMask(!0,!0,!0,!0),e.setStencilWriteMask(0),e.setStencilTestEnabled(!0),e.setStencilFunction(n.CompareFunction.EQUAL,t.stencilRef,255)},a.draw=function(e,r){var s;if(!t.hasSource(r)||r.suspended)return;e.timeline.begin(this.name);const n=!(null!=(s=e.context.capabilities.textureFloat)&&s.textureFloatLinear);r.updateTexture(e);const i=this._getShaderVariations(r,n),o=e.painter.materialManager.getProgram(e,this._desc[r.symbolizerParameters.type],i);this._drawWithProgram(e.context,o,r),e.timeline.end(this.name)},a._drawWithProgram=function(e,t,s,n=1,o=[0,0],a=!1){this._quad||(this._quad=new r(e,[0,0,1,0,0,1,1,1]));const{symbolizerParameters:c,transformGrid:l,width:u,height:h,opacity:d}=s,p=c.type;e.useProgram(t);const f=this._getShaderVariations(s),m=this._getUniformInfos(p,e,t,f),{names:_,textures:g}=s.getTextures();i.setTextures(e,t,_,g);const b=i.getBasicGridUniforms(n,o),U=i.getCommonUniforms(l,[u,h],[s.source.width,s.source.height],d,a);if(i.setUniforms(t,m,{u_coordScale:s.coordScale,u_dvsMat3:s.transforms.dvs,...b,...U}),c.colormap){const{colormap:e,colormapOffset:r}=c,s=i.getColormapUniforms(e,r);i.setUniforms(t,m,s)}if("stretch"===c.type){const e=i.getStretchUniforms(c);i.setUniforms(t,m,e)}else if("hillshade"===c.type){const e=i.getShadedReliefUniforms(c);i.setUniforms(t,m,e)}this._quad.draw()},a._getUniformInfos=function(e,t,r,s){const n=s.length>0?e+"-"+s.join("-"):e;if(this._rendererUniformInfos.has(n))return this._rendererUniformInfos.get(n);const o=i.getUniformLocationInfos(t,r);return this._rendererUniformInfos.set(n,o),o},a._getShaderVariations=function(e,t=!1){const r=[],{interpolation:s}=e,{type:n,colormap:i}=e.symbolizerParameters;return"cubic"===s?r.push("bicubic"):"bilinear"===s&&"stretch"===n&&null!=i?(r.push("bilinear"),r.push("nnedge")):t&&"bilinear"===s&&r.push("bilinear"),e.isRendereredSource?r.push("noop"):i&&r.push("applyColormap"),e.transformGrid&&(r.push("applyProjection"),1===e.transformGrid.spacing[0]&&r.push("lookupProjection")),r},o}(s);return o}));
