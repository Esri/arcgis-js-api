/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/maybe","../../../chunks/mat3","../../../layers/support/rasterFunctions/pixelUtils","../../../chunks/mat3f32","../../../chunks/vec2f32","./DisplayObject","../../webgl/rasterUtils"],(function(t,e,r,s,i,n,a,u,o){"use strict";const l={bandCount:3,outMin:0,outMax:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,type:"stretch"};let h=function(t){function u(e=null,r=null,s=null){var i;return(i=t.call(this)||this)._textureInvalidated=!0,i._memoryUsed=null,i._supportsBilinear=!0,i.stencilRef=0,i.coordScale=[1,1],i._symbolizerParameters=null,i.height=null,i.isRendereredSource=!1,i.pixelRatio=1,i.resolution=0,i.rotation=0,i._source=null,i.rawPixelData=null,i._suspended=!1,i._bandIds=null,i._interpolation=null,i._transformGrid=null,i.width=null,i.x=0,i.y=0,i.transforms={dvs:n.create()},i.source=e,i.transformGrid=r,i.interpolation=s,i}e._inheritsLoose(u,t);var h=u.prototype;return h.invalidateTexture=function(){this._textureInvalidated||(this._textureInvalidated=!0,this.requestRender())},h.setTransform=function(t){const e=s.identity(this.transforms.dvs),[r,i]=t.toScreenNoRotation([0,0],this.x,this.y),n=this.resolution/this.pixelRatio/t.resolution,u=n*this.width,o=n*this.height,l=Math.PI*this.rotation/180;s.translate(e,e,a.fromValues(r,i)),s.translate(e,e,a.fromValues(u/2,o/2)),s.rotate(e,e,-l),s.translate(e,e,a.fromValues(-u/2,-o/2)),s.scaleByVec2(e,e,a.fromValues(u,o)),s.multiply(this.transforms.dvs,t.displayViewMat3,e)},h.getTextures=function(){if(!this._rasterTexture)return null;const t=[],e=[];return this._transformGridTexture&&(e.push(this._transformGridTexture),t.push("u_transformGrid")),this._rasterTexture&&(e.push(this._rasterTexture),t.push("u_image")),this._colormapTexture&&(e.push(this._colormapTexture),t.push("u_colormap")),{names:t,textures:e}},h.getMemoryUsage=function(){if(r.isNone(this._memoryUsed)){const t=this.getTextures();if(null==t)return 0;this._memoryUsed=t.textures.map((t=>t.descriptor.width*t.descriptor.height*4)).reduce(((t,e)=>t+e))}return this._memoryUsed},h.onAttach=function(){this.invalidateTexture()},h.onDetach=function(){this.invalidateTexture()},h.updateTexture=function({context:t}){var e,r,s;if(!this.stage)return null==(e=this._rasterTexture)||e.dispose(),null==(r=this._transformGridTexture)||r.dispose(),null==(s=this._colormapTexture)||s.dispose(),this._rasterTexture=null,this._rasterTextureBandIds=null,this._transformGridTexture=null,void(this._colormapTexture=null);if(!this._textureInvalidated)return;this._textureInvalidated=!1;const i=this.source,n=i&&i.pixels&&i.pixels.length>0;this._createOrDestroyRasterTexture(t),this._rasterTexture&&(n?(this._updateColormapTexture(t),this.transformGrid&&!this._transformGridTexture&&(this._transformGridTexture=o.createTransformTexture(t,this.transformGrid))):this._rasterTexture.setData(null)),this.suspended||(this.ready(),this.requestRender())},h._createOrDestroyRasterTexture=function(t){var e,r;const s=this.source?i.extractBands(this.source,this.bandIds):null;if(!(s&&s.pixels&&s.pixels.length>0))return void(this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTextureBandIds=null,this._rasterTexture=null));const n=null==this._rasterTextureBandIds&&null==this.bandIds||this._rasterTextureBandIds&&this.bandIds&&this._rasterTextureBandIds.join("")===this.bandIds.join("");if(this._rasterTexture){if(n)return;this._rasterTexture.dispose(),this._rasterTextureBandIds=null,this._rasterTexture=null}const a=this.interpolation||"nearest",u=this.isRendereredSource||!(null!=(e=t.capabilities.textureFloat)&&e.textureFloat);this._rasterTexture=o.createRasterTexture(t,s,a,u),this._supportsBilinear=null==(r=t.capabilities.textureFloat)?void 0:r.textureFloatLinear,this._rasterTextureBandIds=this.bandIds},h._updateColormapTexture=function(t){const e=this._colormap,r=this.symbolizerParameters.colormap;return r?e?r.length!==e.length||r.some(((t,r)=>t!==e[r]))?(this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),this._colormapTexture=o.createColormapTexture(t,r),void(this._colormap=r)):void 0:(this._colormapTexture=o.createColormapTexture(t,r),void(this._colormap=r)):(this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),void(this._colormap=null))},e._createClass(u,[{key:"symbolizerParameters",get:function(){return this._symbolizerParameters||l},set:function(t){this._symbolizerParameters=t}},{key:"source",get:function(){return this._source},set:function(t){this._source=t,this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTexture=null,this._rasterTextureBandIds=null,this._memoryUsed=null)}},{key:"suspended",get:function(){return this._suspended},set:function(t){this._suspended&&!t&&this.stage&&(this.ready(),this.requestRender()),this._suspended=t}},{key:"bandIds",get:function(){return this._bandIds},set:function(t){this._bandIds=t,this.invalidateTexture()}},{key:"interpolation",get:function(){return this._interpolation},set:function(t){this._interpolation=t,this._rasterTexture&&this._rasterTexture.setSamplingMode(!this._supportsBilinear||"bilinear"!==t&&"cubic"!==t?9728:9729)}},{key:"transformGrid",get:function(){return this._transformGrid},set:function(t){this._transformGrid=t,this._transformGridTexture&&(this._transformGridTexture.dispose(),this._transformGridTexture=null,this._memoryUsed=null)}}]),u}(u.DisplayObject);t.RasterBitmap=h,Object.defineProperty(t,"__esModule",{value:!0})}));
