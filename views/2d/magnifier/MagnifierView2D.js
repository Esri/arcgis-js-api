/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../request","../../../core/asyncUtils","../../../core/Handles","../../../core/mathUtils","../../../core/maybe","../../../core/reactiveUtils","../../../core/urlUtils","../../../chunks/mat3f32","../engine/DisplayObject","../engine/webgl/DefaultVertexAttributeLayouts","../engine/webgl/enums","../engine/webgl/shaders/MagnifierPrograms","../../magnifier/resources","../../webgl/BufferObject","../../webgl/enums","../../webgl/Texture","../../webgl/VertexArrayObject"],(function(e,t,r,s,i,a,o,n,l,u,c,h,d,_,m,p,T,g){"use strict";let x=function(u){function x(){var e;return(e=u.call(this)||this)._handles=new s,e._resourcePixelRatio=1,e.visible=!1,e}e._inheritsLoose(x,u);var f=x.prototype;return f.destroy=function(){this._handles.destroy(),this._handles=null,this._disposeRenderResources(),this._resourcesTask&&(this._resourcesTask.abort(),this._resourcesTask=null)},f._createTransforms=function(){return{dvs:l.create()}},f.doRender=function(e){const t=e.context;if(!this._resourcesTask)return void this._reloadResources();if(e.drawPhase!==h.WGLDrawPhase.MAP||!this._canRender())return;this._updateResources(e);const r=this._magnifier;if(a.isNone(r.position))return;const s=e.pixelRatio,o=r.size*s,n=1/r.factor,l=Math.ceil(n*o);this._readbackTexture.resize(l,l);const{size:u}=e.state,c=s*u[0],d=s*u[1],_=.5*l,m=.5*l,T=i.clamp(s*r.position.x,_,c-_-1),g=i.clamp(d-s*r.position.y,m,d-m-1);t.setBlendingEnabled(!0);const x=T-_,f=g-m,y=this._readbackTexture;t.bindTexture(y,0),t.gl.copyTexImage2D(y.descriptor.target,0,y.descriptor.pixelFormat,x,f,l,l,0);const b=this.background?.color,R=b?[b.a*b.r/255,b.a*b.g/255,b.a*b.b/255,b.a]:[1,1,1,1],k=(T+r.offset.x*s)/c*2-1,v=(g-r.offset.y*s)/d*2-1,A=o/c*2,P=o/d*2,E=this._program;t.bindVAO(this._vertexArrayObject),t.bindTexture(this._overlayTexture,6),t.bindTexture(this._maskTexture,7),t.useProgram(E),E.setUniform4fv("u_background",R),E.setUniform1i("u_readbackTexture",0),E.setUniform1i("u_overlayTexture",6),E.setUniform1i("u_maskTexture",7),E.setUniform4f("u_drawPos",k,v,A,P),E.setUniform1i("u_maskEnabled",r.maskEnabled?1:0),E.setUniform1i("u_overlayEnabled",r.overlayEnabled?1:0),t.setStencilTestEnabled(!1),t.setColorMask(!0,!0,!0,!0),t.drawArrays(p.PrimitiveType.TRIANGLE_STRIP,0,4),t.bindVAO()},f._canRender=function(){return this.mask&&this.overlay&&null!=this._magnifier},f._reloadResources=function(){var s=this;this._resourcesTask&&this._resourcesTask.abort();const i=a.isSome(this._magnifier)?this._magnifier.maskUrl:null,o=a.isSome(this._magnifier)?this._magnifier.overlayUrl:null;this._resourcesTask=r.createTask(function(){var r=e._asyncToGenerator((function*(e){const r=a.isNone(i)||a.isNone(o)?_.loadMagnifierResources(e):null,n=a.isSome(i)?t(i,{responseType:"image",signal:e}).then((e=>e.data)):r.then((e=>e.mask)),l=a.isSome(o)?t(o,{responseType:"image",signal:e}).then((e=>e.data)):r.then((e=>e.overlay)),[u,c]=yield Promise.all([n,l]);s.mask=u,s.overlay=c,s._disposeRenderResources(),s.requestRender()}));return function(e){return r.apply(this,arguments)}}())},f._disposeRenderResources=function(){this._readbackTexture=a.disposeMaybe(this._readbackTexture),this._overlayTexture=a.disposeMaybe(this._overlayTexture),this._maskTexture=a.disposeMaybe(this._maskTexture),this._vertexArrayObject=a.disposeMaybe(this._vertexArrayObject),this._program=a.disposeMaybe(this._program)},f._updateResources=function(e){if(e.pixelRatio!==this._resourcePixelRatio&&this._disposeRenderResources(),this._readbackTexture)return;const t=e.context;this._resourcePixelRatio=e.pixelRatio;const r=Math.ceil(this._magnifier.size*e.pixelRatio);this._program=d.createMagnifierProgram(t);const s=new Uint16Array([0,1,0,0,1,1,1,0]),i=d.magnifierProgramTemplate.attributes;this._vertexArrayObject=new g.VertexArrayObject(t,i,c.Pos2us,{geometry:m.BufferObject.createVertex(t,p.Usage.STATIC_DRAW,s)}),this.overlay.width=r,this.overlay.height=r,this._overlayTexture=new T.Texture(t,{target:p.TextureType.TEXTURE_2D,pixelFormat:p.PixelFormat.RGBA,internalFormat:p.PixelFormat.RGBA,dataType:p.PixelType.UNSIGNED_BYTE,wrapMode:p.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:p.TextureSamplingMode.NEAREST,flipped:!0,preMultiplyAlpha:!n.isSVG(this.overlay.src)||!e.context.driverTest.svgAlwaysPremultipliesAlpha},this.overlay),this.mask.width=r,this.mask.height=r,this._maskTexture=new T.Texture(t,{target:p.TextureType.TEXTURE_2D,pixelFormat:p.PixelFormat.ALPHA,internalFormat:p.PixelFormat.ALPHA,dataType:p.PixelType.UNSIGNED_BYTE,wrapMode:p.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:p.TextureSamplingMode.NEAREST,flipped:!0},this.mask);const a=1/this._magnifier.factor;this._readbackTexture=new T.Texture(t,{target:p.TextureType.TEXTURE_2D,pixelFormat:p.PixelFormat.RGBA,internalFormat:p.PixelFormat.RGBA,dataType:p.PixelType.UNSIGNED_BYTE,wrapMode:p.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:p.TextureSamplingMode.LINEAR,flipped:!1,width:Math.ceil(a*r),height:Math.ceil(a*r)})},e._createClass(x,[{key:"background",get:function(){return this._background},set:function(e){this._background=e,this.requestRender()}},{key:"magnifier",get:function(){return this._magnifier},set:function(e){this._magnifier=e,this._handles.removeAll(),this._handles.add([o.watch((()=>e.version),(()=>{this.visible=e.visible&&a.isSome(e.position)&&e.size>0,this.requestRender()}),o.initial),o.watch((()=>[e.maskUrl,e.overlayUrl]),(()=>this._reloadResources())),o.watch((()=>e.size),(()=>{this._disposeRenderResources(),this.requestRender()}))])}}]),x}(u.DisplayObject);return x}));
