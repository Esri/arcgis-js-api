// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../assets","../../../core/promiseUtils","../../webgl","../engine/DisplayObject","../engine/webgl/enums","../engine/webgl/shaders/MagnifierPrograms"],(function(e,t,r,i,s,a,o,n,u){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var h=function(e){function t(){var t=e.call(this)||this;return t.visible=!1,t}return r.__extends(t,e),t.prototype.destroy=function(){this._readbackTexture&&(this._readbackTexture.dispose(),this._readbackTexture=null,this._maskTexture.dispose(),this._maskTexture=null,this._overlayTexture.dispose(),this._overlayTexture=null,this._vertexArrayObject.dispose(),this._vertexArrayObject=null,this._program.dispose(),this._program=null,this._resourcesPromise=null)},Object.defineProperty(t.prototype,"background",{get:function(){return this._background},set:function(e){this._background=e,this.requestRender()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"magnifier",{get:function(){return this._magnifier},set:function(e){var t=this;this._magnifier=e,this._handle&&this._handle.remove(),this._handle=e.watch("version",(function(){t.visible=e.visible,t.requestRender()})),this.visible=e.visible,this.requestRender()},enumerable:!1,configurable:!0}),t.prototype.doRender=function(e){var t,r=e.context;if(this._resourcesPromise){if(e.drawPhase===n.WGLDrawPhase.MAP&&this._canRender()){this._updateResources(r);var i=this._magnifier,s=1/i.factor,a=Math.ceil(s*this.overlay.width),o=Math.ceil(s*this.overlay.height),u=e.state.size,h=e.pixelRatio,l=h*u[0],d=h*u[1],c=i.position||{x:.5*u[0],y:.5*u[1]},p=h*c.x,f=d-h*c.y,m=.5*a,g=.5*o;m>p?p=m:p>=l-m&&(p=l-m-1),g>f?f=g:f>=d-g&&(f=d-g-1);var _=p-m,b=f-g,y=this._readbackTexture;r.bindTexture(y,0),r.gl.copyTexImage2D(y.descriptor.target,0,y.descriptor.pixelFormat,_,b,a,o,0);var v=null===(t=this.background)||void 0===t?void 0:t.color,x=v?[v.a*v.r/255,v.a*v.g/255,v.a*v.b/255,v.a]:[1,1,1,1],T=(p+i.offsetX)/l*2-1,w=(f-i.offsetY)/d*2-1,k=this.overlay.width/l*2,M=this.overlay.height/d*2,P=this._program;r.bindVAO(this._vertexArrayObject),r.bindTexture(this._overlayTexture,6),r.bindTexture(this._maskTexture,7),r.bindProgram(P),P.setUniform4fv("u_background",x),P.setUniform1i("u_readbackTexture",0),P.setUniform1i("u_overlyTexture",6),P.setUniform1i("u_maskTexture",7),P.setUniform2f("u_drawPos",T,w),P.setUniform1f("u_width",k),P.setUniform1f("u_height",M),r.setStencilTestEnabled(!1),r.drawArrays(5,0,4),r.bindVAO()}}else this._resourcesPromise=this._loadResources("esri/images/magnifier/mask.png","esri/images/magnifier/overlay.png")},t.prototype._canRender=function(){return this.mask&&this.overlay&&null!=this._magnifier},t.prototype._loadResources=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var a,o,n;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,s.all([i.fetchAsset(e,{responseType:"image"}),i.fetchAsset(t,{responseType:"image"})])];case 1:return a=r.sent(),o=a[0].data,n=a[1].data,this.mask=o,this.overlay=n,this.requestRender(),[2]}}))}))},t.prototype._updateResources=function(e){if(!this._readbackTexture){var t=1/this._magnifier.factor,r=Math.ceil(t*this.overlay.width),i=Math.ceil(t*this.overlay.height);this._program=u.createMagnifierProgram(e);var s=new Uint16Array([0,1,0,0,1,1,1,0]),o=u.magnifierProgramTemplate.attributes;this._vertexArrayObject=new a.VertexArrayObject(e,o,{geometry:[{name:"a_pos",count:2,type:5123,offset:0,stride:4,normalized:!1,divisor:0}]},{geometry:a.BufferObject.createVertex(e,35044,s)}),this._overlayTexture=new a.Texture(e,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0},this.overlay),this._maskTexture=new a.Texture(e,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0},this.mask),this._readbackTexture=new a.Texture(e,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:r,height:i})}},t}(o.DisplayObject);t.default=h}));