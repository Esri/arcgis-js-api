/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/Handles","../../../../../chunks/vec2","../../../../../chunks/vec2f64","../../../../../chunks/vec3","../../../../../chunks/vec3f64","../../../../../chunks/boundedPlane","../../../../../geometry/support/spatialReferenceUtils","./Manipulation","./utils","../../../../interactive/dragEventPipeline","../../../../interactive/GraphicManipulator","../../../../interactive/editGeometry/interfaces","../../../../interactive/editGeometry/operations/UpdateVertices","../../../../interactive/editGeometry/support/editPlaneUtils"],(function(e,t,a,i,n,r,s,o,c,l,u,h,p,d,_,v){"use strict";const g=10,f=1e-6,m=.3;function y(e){const t=r.length(e.basis1),a=r.length(e.basis2);return m*Math.min(t,a)}let b=function(e){function m(t){var i;return(i=e.call(this)||this)._handles=new a,i._planeStart=o.create(),i._displayPlaneStart=o.create(),i._originCache=s.create(),i._axisCache=n.create(),i._renderStartCache=s.create(),i._renderEndCache=s.create(),i._resizeOriginCache=s.create(),i._view=t.view,i._tool=t.tool,i._graphic=t.graphic,i._direction=t.direction,i._preserveAspectRatio=t.preserveAspectRatio,i._manipulator=i._createManipulator(),i._handles.add([i._manipulator.events.on("grab-changed",(e=>u.onGrabChangedHandle(e,i._manipulator)))]),i.forEachManipulator((e=>i._tool.manipulators.add(e))),i}t._inheritsLoose(m,e);var b=m.prototype;return b.destroy=function(){this._handles.destroy(),this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()})),this._tool=null,this._view=null,this._graphic=null,this._manipulator=null,this._direction=null,this._handles=null,this._planeStart=null,this._displayPlaneStart=null,this._originCache=null,this._axisCache=null,this._renderStartCache=null,this._renderEndCache=null,this._resizeOriginCache=null,this._preserveAspectRatio=null},b.forEachManipulator=function(e){e(this._manipulator,l.ManipulatorType.SCALE)},b.createDragPipeline=function(e,t){let a=null,n=null,s=null,l=0,u=null,p=null;const m=this._planeStart,b=this._displayPlaneStart,A=this._direction;return h.createManipulatorDragEventPipeline(this._manipulator,((C,S)=>{S.next((t=>{if("start"===t.action){C.cursor="grabbing";const t=e();a=t.plane,n=t.displayPlane,s=t.editGeometryOperations,l=g*this._view.resolution,o.copy(a,m),o.copy(n,b);const i=c.getInfo(s.data.spatialReference);u=i?i.valid[1]-i.valid[0]-3*g*this._view.resolution:null}return t})).next(h.screenToMap(this._view)).next((e=>{const t=r.copy(this._renderStartCache,[e.mapStart.x,e.mapStart.y,0]),a=r.copy(this._renderEndCache,[e.mapEnd.x,e.mapEnd.y,0]),i=r.copy(this._resizeOriginCache,b.origin);r.scaleAndAdd(i,i,b.basis1,-A[0]),r.scaleAndAdd(i,i,b.basis2,-A[1]),r.subtract(a,a,i),r.subtract(t,t,i);const s=0!==A[0]&&0!==A[1],o=y(b),c=y(n)/o,u=(e,i)=>{if(0===e)return 1;let n=r.length(i),o=.5*e*r.dot(i,a)/n;const u=o<0?-1:1;if(s){o+=(n-.5*e*r.dot(i,t)/n)*u*c}const h=n<1.5*l?1:f;return n=Math.max(n-l,f),u>0&&(o-=g*this._view.resolution),u*Math.max(u*(o/n),h)},h=u(A[0],b.basis1),p=u(A[1],b.basis2);return{...e,direction:A,factor1:h,factor2:p}})).next(this._preserveAspectRatio.createDragEventPipelineStep(),this._preserveAspectRatio.next).next((e=>{const n=r.copy(this._originCache,m.origin);r.scaleAndAdd(n,n,m.basis1,-A[0]),r.scaleAndAdd(n,n,m.basis2,-A[1]);const c=i.set(this._axisCache,m.basis1[0],m.basis1[1]);i.normalize(c,c);const l=[];for(const t of s.data.components)l.push(...t.vertices);const h="start"===e.action?d.AccumulationBehaviour.NEW_STEP:d.AccumulationBehaviour.ACCUMULATE_STEPS,g=s.scaleVertices(l,n,c,e.factor1,e.factor2,h,_.AccumulationType.REPLACE);return u&&u<s.data.geometry.extent.width&&p?s.updateVertices(l,p):(o.copy(m,a),v.apply(g,a),p=g.operation,t(e,g)),e})).next((e=>("end"===e.action&&(C.cursor="grab"),e)))}))},b._createManipulator=function(){return new p.GraphicManipulator({view:this._view,graphic:this._graphic,selectable:!0,cursor:"grab"})},m}(l.Manipulation);e.ScaleManipulation=b,e.calculateDiagonalResizeHandleScale=y,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
