/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/accessorSupport/decorators/subclass","./ControlPointsTransformTool","./TransformTool"],(function(o,t,e,r,a,n,s,i,d,c,l,h){"use strict";const T={redo:"r",undo:"z"};o.MediaTransformToolsWrapper=function(o){function e(t){var e;return(e=o.call(this,t)||this)._transformTool=null,e._controlPointsTransformTool=null,e._advancedModeTransformTool=null,e._activeTool=null,e._sharedUndoStack=[],e._sharedRedoStack=[],e._originalOpacity=null,e.activeHandle=0,e}t._inheritsLoose(e,o);var r=e.prototype;return r.initialize=function(){var o=this;const{view:e,mediaElement:r,preserveAspectRatio:s,snapRotation:i,advancedMode:d}=this;this._originalOpacity=r.opacity,this._transformTool=new h.TransformTool({target:r,view:e,preserveAspectRatio:s,snapRotation:i}),this._controlPointsTransformTool=new l.ControlPointsTransformTool({mediaElement:r,view:e}),this._advancedModeTransformTool=new l.ControlPointsTransformTool({mediaElement:d.mediaElement,view:d.view}),this._transformTool.setSharedUndoStack(this._sharedUndoStack),this._transformTool.setSharedRedoStack(this._sharedRedoStack),this._controlPointsTransformTool.setSharedUndoStack(this._sharedUndoStack),this._controlPointsTransformTool.setSharedRedoStack(this._sharedRedoStack),this._advancedModeTransformTool.setSharedUndoStack(this._sharedUndoStack),this._advancedModeTransformTool.setSharedRedoStack(this._sharedRedoStack);const c=a.unwrap(r.georeference),p=a.unwrap(d.mediaElement.georeference);d.view.tools.addMany([this._advancedModeTransformTool]),"controlPoints"in p&&"controlPoints"in c&&this.addHandles([d.view.on("key-down",(o=>{o.key===T.undo&&this.canUndo()&&(this.undo(),o.stopPropagation()),o.key===T.redo&&this.canRedo()&&(this.redo(),o.stopPropagation())})),d.view.on("focus",function(){var e=t._asyncToGenerator((function*(t){o._controlPointsTransformTool.removeHighlightActiveHandle(),o._advancedModeTransformTool.highlightActiveHandle()}));return function(o){return e.apply(this,arguments)}}()),n.watch((()=>p.controlPoints),(o=>{c.controlPoints=a.unwrap(o).map((({sourcePoint:o},t)=>({sourcePoint:o,mapPoint:a.unwrap(c.controlPoints)[t].mapPoint}))),this._activeTool?.refresh()})),n.watch((()=>this._controlPointsTransformTool.activeHandle),(o=>{this._advancedModeTransformTool.updateActiveHandle(o),this.activeHandle=o})),n.watch((()=>this._advancedModeTransformTool.activeHandle),(o=>{this._controlPointsTransformTool.updateActiveHandle(o),this.activeHandle=o}))]),this.addHandles([e.on("key-down",(o=>{o.key===T.undo&&this.canUndo()&&(this.undo(),o.stopPropagation()),o.key===T.redo&&this.canRedo()&&(this.redo(),o.stopPropagation())})),e.on("focus",function(){var e=t._asyncToGenerator((function*(t){o._advancedModeTransformTool.removeHighlightActiveHandle(),o._controlPointsTransformTool.highlightActiveHandle()}));return function(o){return e.apply(this,arguments)}}())]),e.tools.addMany([this._transformTool,this._controlPointsTransformTool]),e.activeTool=this._transformTool,this._activeTool=this._transformTool,e.focus()},r.destroy=function(){this._transformTool?.destroy(),this._controlPointsTransformTool?.destroy(),this._transformTool=null,this._controlPointsTransformTool=null,this._advancedModeTransformTool=null,this._activeTool=null,this._sharedUndoStack=null,this._sharedRedoStack=null},r.canUndo=function(){return this._sharedUndoStack.length>0},r.canRedo=function(){return this._sharedRedoStack.length>0},r.undo=function(){if(this._sharedUndoStack.length>0){const{tool:o,operation:t}=this._sharedUndoStack.pop();o!==this._activeTool&&o.refresh(),t.undo(),o.updateGraphics(),this._sharedRedoStack.push({tool:o,operation:t}),this._activeTool!==o&&this._activeTool?.refresh()}},r.redo=function(){if(this._sharedRedoStack.length>0){const{tool:o,operation:t}=this._sharedRedoStack.pop();o!==this._activeTool&&o.refresh(),t.apply(),o.updateGraphics(),this._sharedUndoStack.push({tool:o,operation:t}),this._activeTool!==o&&this._activeTool?.refresh()}},r.refresh=function(){this._activeTool.refresh()},r.reset=function(){this._activeTool.reset(),this._advancedModeTransformTool.reset()},r.enableAdvancedMode=function(){var o=t._asyncToGenerator((function*(){this.view.activeTool=this._controlPointsTransformTool,this._activeTool=this._controlPointsTransformTool,this._activeTool.refresh(),yield this.advancedMode.view.when(),this.advancedMode.view.activeTool=this._advancedModeTransformTool,this._originalOpacity=this._controlPointsTransformTool.mediaElement.opacity,this._controlPointsTransformTool.mediaElement.opacity=.25*this._originalOpacity}));function e(){return o.apply(this,arguments)}return e}(),r.disableAdvancedMode=function(){this.view.activeTool=this._transformTool,this._activeTool=this._transformTool,this._activeTool.refresh(),this.advancedMode.view.activeTool=null,this._controlPointsTransformTool.mediaElement.opacity=this._originalOpacity},e}(r),e.__decorate([s.property()],o.MediaTransformToolsWrapper.prototype,"activeHandle",void 0),e.__decorate([s.property({constructOnly:!0})],o.MediaTransformToolsWrapper.prototype,"advancedMode",void 0),e.__decorate([s.property()],o.MediaTransformToolsWrapper.prototype,"preserveAspectRatio",void 0),e.__decorate([s.property()],o.MediaTransformToolsWrapper.prototype,"snapRotation",void 0),e.__decorate([s.property({constructOnly:!0,nonNullable:!0})],o.MediaTransformToolsWrapper.prototype,"mediaElement",void 0),e.__decorate([s.property({constructOnly:!0})],o.MediaTransformToolsWrapper.prototype,"view",void 0),o.MediaTransformToolsWrapper=e.__decorate([c.subclass("esri.views.2d.interactive.editingTools.MediaTransformToolsWrapper")],o.MediaTransformToolsWrapper),o.KEYS=T,Object.defineProperty(o,Symbol.toStringTag,{value:"Module"})}));
