/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import t from"../../../../core/Handles.js";import{watch as i,initial as e}from"../../../../core/reactiveUtils.js";import{addFrameTask as a}from"../../../../core/scheduling.js";import{translateBy as s,scaleAndRotateBy as n}from"../../viewpointUtils.js";import{InputHandler as r}from"../../../input/InputHandler.js";import{resetTransformation as o,extractTransformation as h,isZeroTransformation as l}from"../../../navigation/gamepadAndKeyboardUtils.js";class d extends r{constructor(i){super(!0),this.view=i,this.frameTask=null,this.watchHandles=new t,this.currentDevice=null,this.transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0},this.handle=this.registerIncoming("gamepad",(t=>this._handleGamePadEvent(t))),this.handle.pause()}onInstall(t){super.onInstall(t),this.watchHandles.add([i((()=>this.view.navigation.gamepad?.enabled),(t=>{t?(this.handle.resume(),this.frameTask||(this.frameTask=a({update:t=>this._frameUpdate(t.deltaTime)}))):(this.handle.pause(),this.frameTask&&(this.frameTask.remove(),this.frameTask=null))}),e)])}onUninstall(){this.watchHandles.removeAll(),this.frameTask&&(this.frameTask.remove(),this.frameTask=null),super.onUninstall()}_handleGamePadEvent(t){const i=this.view.navigation.gamepad.device;i&&t.data.device!==i||this.currentDevice&&this.currentDevice!==t.data.device||("end"===t.data.action?(this.currentDevice=null,o(this.transformation)):(this.currentDevice=t.data.device,h(t.data,this.view.navigation.gamepad,this.transformation)))}_frameUpdate(t){const i=this.transformation;if(l(i))return;const e=this.view.viewpoint.clone(),a=this.view.navigation.gamepad.velocityFactor,r=c*a*t;s(e,e,[i.translation[0]*r,-i.translation[1]*r]);const o=1+i.translation[2]*v*t,h=this.view.constraints.rotationEnabled?-i.heading*m*t:0,d=this.view.size,p=[d[0]/2,d[1]];n(e,e,o,h,p,d);const f=this.view.constraints.constrain(e,this.view.viewpoint);this.view.viewpoint=f}}const m=.06,c=.7,v=6e-4;export{d as GamepadNavigation};
