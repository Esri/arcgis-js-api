/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/Accessor","../../core/asyncUtils","../../core/handleUtils","../../core/maybe","../../core/promiseUtils","../../core/quantityFormatUtils","../../core/reactiveUtils","../../core/screenUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/accessorSupport/decorators/subclass","../../chunks/vec2","../../chunks/vec2f64","../../chunks/vec3","../../geometry/support/coordsUtils","../../intl/messages","../../support/elevationInfoUtils","../../support/getDefaultUnitForView","../overlay/TextOverlayItem","../support/automaticLengthMeasurementUtils"],(function(e,t,s,o,n,r,i,a,l,c,d,p,h,u,g,b,_,y,f,m,v,x,L,S){"use strict";const U=3025,I={default:15,far:25};e.SegmentLabels=function(e){function s(t){var s;return(s=e.call(this,t)||this).context=null,s.stagedVertex=null,s.visible=!0,s.edgeDistance="default",s._messagesUnits=null,s._labelInfos=[],s._nextLabelIndex=0,s}t._inheritsLoose(s,e);var o=s.prototype;return o.initialize=function(){var e=this;const s=n.createTask(function(){var s=t._asyncToGenerator((function*(t){const s=yield m.fetchMessageBundle("esri/core/t9n/Units");a.throwIfAborted(t),e._messagesUnits=s}));return function(e){return s.apply(this,arguments)}}()),o=()=>i.applySome(this.context,(e=>e.editGeometryOperations));this.addHandles([c.watch((()=>[i.isSome(this.context)&&this.getCameraOrExtent(this.context),this.visible,this._edgeDistancePixels,this.stagedVertex,this._messagesUnits]),(()=>this._update())),...["vertex-add","vertex-update","vertex-remove"].map((e=>c.on(o,e,(()=>this._update())))),r.makeHandle((()=>s.abort()))])},o.destroy=function(){for(this._nextLabelIndex=0;this._labelInfos.length;)this._destroyLabel(this._labelInfos.pop())},o._update=function(){this._nextLabelIndex=0;const e=this.context;if(i.isNone(e))return void this._destroyUnusedLabels();const{components:t,geometry:s,coordinateHelper:o}=e.editGeometryOperations.data;if(!s)return void this._destroyUnusedLabels();const n=t.length;for(let r=0;r<n;++r){const a=[];if(t[r].iterateVertices((e=>{a.push(o.toXYZ(e.pos))})),0===r&&i.isSome(this.stagedVertex)&&a.push(o.toXYZ(this.stagedVertex)),a.length<2)continue;const l=a[0],c=a[a.length-1];"polygon"===s.type&&a.length>2&&!y.equals(l,c)&&a.push(l);const d=1===n&&!f.isClockwise(a,!1,!1);let p=w,h=P;this.toScreenPointArray(e,l,p);for(let t=1;t<a.length;++t){const s=a[t-1],o=a[t];this.toScreenPointArray(e,o,h),this._addLabel(e,s,p,o,h,d),[p,h]=[h,p]}}this._destroyUnusedLabels()},o._addLabel=function(e,t,s,o,n,r){const{label:a}=this._getOrCreateLabel(e);if(!this.visible||b.squaredDistance(s,n)<U)return void(a.visible=!1);const c=i.isSome(e.graphicState)?e.graphicState.isDraped?"on-the-ground":"absolute-height":v.getGeometryEffectiveElevationMode(e.editGeometryOperations.data.geometry,e.elevationInfo),{spatialReference:d}=e.editGeometryOperations.data,p=S.autoDirectDistanceByElevationMode(t,o,d,c),h=this._messagesUnits,u=x.getDefaultUnitForView(e.view);a.text=i.isSome(h)&&i.isSome(p)?l.formatLength(h,p,u):"",a.visible=!0;const g=n[0]-s[0],_=n[1]-s[1];r?b.set(D,-_,g):b.set(D,_,-g),b.normalize(D,D),b.scale(D,D,this._edgeDistancePixels),b.lerp(k,s,n,.5),b.add(k,k,D),a.position=[k[0],k[1]],Math.abs(D[0])>Math.abs(D[1])?a.anchor=D[0]>0?"left":"right":a.anchor=-D[1]<0?"top":"bottom"},o._getOrCreateLabel=function(e){if(this._labelInfos.length>this._nextLabelIndex)return this._labelInfos[this._nextLabelIndex++];const t=new L({fontSize:10,anchor:"center"});e.view.overlay?.items.add(t);const s={label:t};return this._labelInfos.push(s),this._nextLabelIndex=this._labelInfos.length,s},o._destroyUnusedLabels=function(){for(;this._labelInfos.length>this._nextLabelIndex;)this._destroyLabel(this._labelInfos.pop())},o._destroyLabel=function({label:e}){i.applySome(this.context,(t=>t.view.overlay?.items.remove(e))),e.destroy()},t._createClass(s,[{key:"updating",get:function(){return i.isNone(this._messagesUnits)}},{key:"test",get:function(){return{labelContents:this._labelInfos.slice(0,this._nextLabelIndex).map((e=>e.label.text))}}},{key:"_edgeDistancePixels",get:function(){return I[this.edgeDistance]}}]),s}(o),s.__decorate([p.property()],e.SegmentLabels.prototype,"context",void 0),s.__decorate([p.property()],e.SegmentLabels.prototype,"stagedVertex",void 0),s.__decorate([p.property()],e.SegmentLabels.prototype,"visible",void 0),s.__decorate([p.property()],e.SegmentLabels.prototype,"edgeDistance",void 0),s.__decorate([p.property()],e.SegmentLabels.prototype,"updating",null),s.__decorate([p.property()],e.SegmentLabels.prototype,"_messagesUnits",void 0),s.__decorate([p.property()],e.SegmentLabels.prototype,"_edgeDistancePixels",null),e.SegmentLabels=s.__decorate([g.subclass("esri.views.interactive")],e.SegmentLabels);const D=_.create(),k=_.create(),w=d.createScreenPointArray(),P=d.createScreenPointArray();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
