/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import t from"../../core/Accessor.js";import{makeHandle as s}from"../../core/handleUtils.js";import{isNone as o,isSome as i,applySome as r}from"../../core/maybe.js";import{createTask as a,throwIfAborted as n}from"../../core/promiseUtils.js";import{formatLength as l}from"../../core/quantityFormatUtils.js";import{watch as c,on as p}from"../../core/reactiveUtils.js";import{createScreenPointArray as h}from"../../core/screenUtils.js";import{getDefaultUnitForView as d}from"../../core/unitUtils.js";import{property as m}from"../../core/accessorSupport/decorators/property.js";import"../../core/arrayUtils.js";import"../../core/has.js";import"../../core/accessorSupport/ensureType.js";import{subclass as u}from"../../core/accessorSupport/decorators/subclass.js";import{s as b,a as f,i as g,f as _,l as x,b as y}from"../../chunks/vec2.js";import{a as v}from"../../chunks/vec2f64.js";import{z as j}from"../../chunks/vec3.js";import{isClockwise as I}from"../../geometry/support/coordsUtils.js";import{fetchMessageBundle as U}from"../../intl/messages.js";import{getGeometryEffectiveElevationMode as L}from"../../support/elevationInfoUtils.js";import D from"../overlay/TextOverlayItem.js";import{autoDirectDistanceByElevationMode as O}from"../support/automaticLengthMeasurementUtils.js";const S=3025,w={default:15,far:25};let P=class extends t{constructor(e){super(e),this.context=null,this.stagedVertex=null,this.visible=!0,this.edgeDistance="default",this._messagesUnits=null,this._labelInfos=[],this._nextLabelIndex=0}initialize(){const e=a((async e=>{const t=await U("esri/core/t9n/Units");n(e),this._messagesUnits=t})),t=()=>r(this.context,(e=>e.editGeometryOperations));this.own([c((()=>[i(this.context)&&this.getCameraOrExtent(this.context),this.visible,this._edgeDistancePixels,this.stagedVertex,this._messagesUnits]),(()=>this._update())),...["vertex-add","vertex-update","vertex-remove"].map((e=>p(t,e,(()=>this._update())))),s((()=>e.abort()))])}destroy(){for(this._nextLabelIndex=0;this._labelInfos.length;)this._destroyLabel(this._labelInfos.pop())}get updating(){return o(this._messagesUnits)}get test(){return{labelContents:this._labelInfos.slice(0,this._nextLabelIndex).map((e=>e.label.text))}}get _edgeDistancePixels(){return w[this.edgeDistance]}_update(){this._nextLabelIndex=0;const e=this.context;if(o(e))return void this._destroyUnusedLabels();const{components:t,geometry:s,coordinateHelper:r}=e.editGeometryOperations.data;if(!s)return void this._destroyUnusedLabels();const a=t.length;for(let o=0;o<a;++o){const n=[];if(t[o].iterateVertices((e=>{n.push(r.toXYZ(e.pos))})),0===o&&i(this.stagedVertex)&&n.push(r.toXYZ(this.stagedVertex)),n.length<2)continue;const l=n[0],c=n[n.length-1];"polygon"===s.type&&n.length>2&&!j(l,c)&&n.push(l);const p=1===a&&!I(n,!1,!1);let h=C,d=G;this.toScreenPointArray(e,l,h);for(let t=1;t<n.length;++t){const s=n[t-1],o=n[t];this.toScreenPointArray(e,o,d),this._addLabel(e,s,h,o,d,p),[h,d]=[d,h]}}this._destroyUnusedLabels()}_addLabel(e,t,s,o,r,a){const{label:n}=this._getOrCreateLabel(e);if(!this.visible||b(s,r)<S)return void(n.visible=!1);const c=i(e.graphicState)?e.graphicState.isDraped?"on-the-ground":"absolute-height":L(e.editGeometryOperations.data.geometry,e.elevationInfo),{spatialReference:p}=e.editGeometryOperations.data,h=O(t,o,p,c),m=this._messagesUnits,u=d(e.view);n.text=i(m)&&i(h)?l(m,h,u):"",n.visible=!0;const v=r[0]-s[0],j=r[1]-s[1];a?f(V,-j,v):f(V,j,-v),g(V,V),_(V,V,this._edgeDistancePixels),x(k,s,r,.5),y(k,k,V),n.position=[k[0],k[1]],Math.abs(V[0])>Math.abs(V[1])?n.anchor=V[0]>0?"left":"right":n.anchor=-V[1]<0?"top":"bottom"}_getOrCreateLabel(e){if(this._labelInfos.length>this._nextLabelIndex)return this._labelInfos[this._nextLabelIndex++];const t=new D({fontSize:10,anchor:"center"});e.view.overlay.items.add(t);const s={label:t};return this._labelInfos.push(s),this._nextLabelIndex=this._labelInfos.length,s}_destroyUnusedLabels(){for(;this._labelInfos.length>this._nextLabelIndex;)this._destroyLabel(this._labelInfos.pop())}_destroyLabel({label:e}){r(this.context,(t=>t.view.overlay.items.remove(e))),e.destroy()}};e([m()],P.prototype,"context",void 0),e([m()],P.prototype,"stagedVertex",void 0),e([m()],P.prototype,"visible",void 0),e([m()],P.prototype,"edgeDistance",void 0),e([m()],P.prototype,"updating",null),e([m()],P.prototype,"_messagesUnits",void 0),e([m()],P.prototype,"_edgeDistancePixels",null),P=e([u("esri.views.interactive")],P);const V=v(),k=v(),C=h(),G=h();export{P as SegmentLabels};
