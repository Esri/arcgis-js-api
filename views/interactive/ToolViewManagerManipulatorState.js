/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../core/iteratorUtils","../../core/MapUtils","../../core/mathUtils","../../core/maybe","../../core/screenUtils","./interactiveToolUtils","../support/screenUtils"],(function(e,t,o,i,n,r,a,s,p){"use strict";let l=function(){function e(){this._pointerLocations=new Map,this._hoveredManipulators=new Map,this._grabbedManipulators=new Map,this._draggedManipulators=new Map,this._stopDrag=!1,this._revertToNullActiveTool=!1,this._cursor=null}var l=e.prototype;return l.handleInputEvent=function(e,t){const o=()=>e.stopPropagation();switch(e.type){case"pointer-move":c(e.pointerType)&&this._pointerLocations.set(e.pointerId,{x:e.x,y:e.y,pointerType:e.pointerType});break;case"drag":this._grabbedManipulators.size>0&&(this._stopDrag=!0),this._stopDrag&&(o(),"end"===e.action&&(this._stopDrag=!1));break;case"pointer-down":{if(!u(e))break;const i=p.createScreenPointFromEvent(e),n=this._intersect(i,e.pointerType,t.forEachTool);if(r.isNone(n))break;const a=n.manipulator,s=n.tool;!(r.isSome(a)&&r.isSome(s)&&a.interactive)||a.grabbable&&a.grabbableForEvent(e)||!a.grabbing||a.dragging||this._ungrabManipulatorBeforeDragging(a,e,t),r.isSome(a)&&r.isSome(s)&&a.interactive&&a.grabbable&&a.grabbableForEvent(e)&&!a.grabbing&&(this._grabbedManipulators.set(e.pointerId,{manipulator:a,tool:s,start:i,pointerType:e.pointerType}),1===this._grabbedManipulators.size&&r.isNone(t.activeTool)&&(this._revertToNullActiveTool=!0,t.setActiveTool(n.tool)),a.grabbing=!0,a.events.emit("grab-changed",{action:"start",pointerType:e.pointerType,screenPoint:i}),o());break}case"pointer-up":this._draggedManipulators.has(e.pointerId)||this._handlePointerEnd(e,t);break;case"pointer-drag":{if(!u(e))break;const i=this._grabbedManipulators.get(e.pointerId),a=r.applySome(i,(({manipulator:e})=>e)),s=r.applySome(i,(({tool:e})=>e));if(r.isNone(a)||r.isNone(s))break;const l=p.createScreenPointFromEvent(e);l.x=n.clamp(l.x,0,t.view.width),l.y=n.clamp(l.y,0,t.view.height);const c=r.unwrap(i).start,h=this._draggedManipulators.get(e.pointerId);switch(e.action){case"start":case"update":"update"!==e.action&&1!==this._grabbedManipulators.size||(a.dragging=!0,h?a.events.emit("drag",{action:"update",start:c,screenPoint:l}):a.events.emit("drag",{action:"start",start:c,screenPoint:l,pointerType:e.pointerType}),this._draggedManipulators.set(e.pointerId,{tool:s,manipulator:a,start:c}));break;case"end":a.dragging=!1,h&&a.events.emit("drag",{action:"end",start:c,screenPoint:l}),this._draggedManipulators.delete(e.pointerId),this._handlePointerEnd(e,t)}o();break}case"immediate-click":{const i=p.createScreenPointFromEvent(e),n=this._intersect(i,e.pointerType,t.forEachTool);if(h(e)||t.forEachTool((e=>{if((!r.isSome(n)||n.tool!==e||e.automaticManipulatorSelection)&&e.manipulators){let t=!1;e.manipulators.forEach((({manipulator:e})=>{e.selected&&(e.selected=!1,t=!0)})),t&&e.onManipulatorSelectionChanged&&e.onManipulatorSelectionChanged()}})),r.isNone(n))break;const{manipulator:a,tool:s}=n;if(!a.interactive)break;a.selectable&&s.automaticManipulatorSelection&&(a.selected=!a.selected,s.onManipulatorSelectionChanged&&s.onManipulatorSelectionChanged());const l=e.native.shiftKey;a.events.emit("immediate-click",{screenPoint:i,button:e.button,pointerType:e.pointerType,shiftKey:l,stopPropagation:o});break}case"click":{const i=p.createScreenPointFromEvent(e),n=this._intersect(i,e.pointerType,t.forEachTool),a=r.isSome(n)?n.manipulator:null;if(r.isNone(a)||!a.interactive)break;const s=e.native.shiftKey;a.events.emit(e.type,{screenPoint:i,button:e.button,pointerType:e.pointerType,shiftKey:s}),o();break}case"double-click":{const i=p.createScreenPointFromEvent(e),n=this._intersect(i,e.pointerType,t.forEachTool),a=r.isSome(n)?n.manipulator:null;if(r.isNone(a)||!a.interactive)break;const s=e.native.shiftKey;a.events.emit("double-click",{screenPoint:i,button:e.button,pointerType:e.pointerType,shiftKey:s,stopPropagation:o});break}case"immediate-double-click":{const i=p.createScreenPointFromEvent(e),n=this._intersect(i,e.pointerType,t.forEachTool),a=r.isSome(n)?n.manipulator:null;if(r.isNone(a)||!a.interactive)break;const s=e.native.shiftKey;a.events.emit("immediate-double-click",{screenPoint:i,button:e.button,pointerType:e.pointerType,shiftKey:s,stopPropagation:o});break}}this._onFocusChange(t.forEachTool)},l._ungrabManipulatorBeforeDragging=function(e,t,o){e.grabbing=!1,e.events.emit("grab-changed",{action:"end",pointerType:t.pointerType,screenPoint:p.createScreenPointFromEvent(t)}),this._grabbedManipulators.forEach((({manipulator:t},o)=>{t===e&&this._grabbedManipulators.delete(o)})),this._afterManipulatorUngrab(o.setActiveTool)},l._handlePointerEnd=function(e,t){const o=r.applySome(this._grabbedManipulators.get(e.pointerId),(({manipulator:e})=>e));r.isNone(o)||o.grabbing&&(o.grabbing=!1,o.events.emit("grab-changed",{action:"end",pointerType:e.pointerType,screenPoint:p.createScreenPointFromEvent(e)}),this._grabbedManipulators.delete(e.pointerId),this._afterManipulatorUngrab(t.setActiveTool))},l._cursorFromMap=function(e){let t=null;return i.someMap(e,(({manipulator:e})=>!(r.isNone(e)||!e.interactive)&&(e.grabbing&&e.grabCursor?(t=e.grabCursor,!0):!!e.cursor&&(t=e.cursor,!0)))),t},l._onFocusChange=function(e){this._updateCursor(),this._updateFocusedManipulatorTools(e)},l._updateCursor=function(){this._grabbedManipulators.size>0?this._cursor=this._cursorFromMap(this._grabbedManipulators)||"grabbing":this._hoveredManipulators.size>0?this._cursor=this._cursorFromMap(this._hoveredManipulators)||"pointer":this._cursor=null},l._updateFocusedManipulatorTools=function(e){const t=new Set,i=new Set;this._grabbedManipulators.forEach((({tool:e})=>{t.add(e)})),this._hoveredManipulators.forEach((({tool:e})=>{i.add(e)})),e((e=>{e.hasGrabbedManipulators=t.has(e),e.hasHoveredManipulators=i.has(e);const n=this._grabbedManipulators.values(),a=o.find(n,(({tool:t})=>t===e));e.firstGrabbedManipulator=r.isSome(a)?a.manipulator:null}))},l.clearPointers=function(e,{forEachTool:t,setActiveTool:o},i=!0,n){const a=(t,o)=>t===e&&(r.isNone(n)||n===o);this._grabbedManipulators.forEach((({tool:e,manipulator:t,pointerType:o},i)=>{a(e,t)&&(this._grabbedManipulators.delete(i),t.grabbing=!1,t.events.emit("grab-changed",{action:"end",screenPoint:null,pointerType:o}))})),this._draggedManipulators.forEach((({tool:e,manipulator:t},o)=>{a(e,t)&&(this._draggedManipulators.delete(o),t.dragging=!1,t.events.emit("drag",{action:"cancel"}))})),i&&this._hoveredManipulators.forEach((({tool:e,manipulator:t},o)=>{a(e,t)&&(this._hoveredManipulators.delete(o),t.hovering=!1)})),this._afterManipulatorUngrab(o),this._onFocusChange(t)},l._intersect=function(e,t,o){let i=null;return o((o=>{if(null==o.manipulators||!s.areToolManipulatorsEditable(o))return!1;const n=o.manipulators.intersect(e,t);return!r.isNone(n)&&(i={tool:o,manipulator:n},!0)})),i},l.updateHoveredStateFromKnownPointers=function(e){this._pointerLocations.forEach(((t,o)=>{this._updateHoveredStateForPointerAtScreenPosition(a.createScreenPoint(t.x,t.y),o,t.pointerType,e)}))},l.handleHoverEvent=function(e,t){"pointer-up"!==e.type&&"immediate-click"!==e.type&&"pointer-move"!==e.type||!c(e.pointerType)||this._updateHoveredStateForPointerAtScreenPosition(p.createScreenPointFromEvent(e),e.pointerId,e.pointerType,t)},l._updateHoveredStateForPointerAtScreenPosition=function(e,t,o,i){let n=this._intersect(e,o,i);const a=r.applySome(this._hoveredManipulators.get(t),(({manipulator:e})=>e));r.isSome(n)&&!n.manipulator.interactive&&(n=null),r.isSome(n)&&a===n.manipulator||(r.isSome(a)&&(a.hovering=!1),r.isSome(n)?(n.manipulator.hovering=!0,this._hoveredManipulators.set(t,n)):this._hoveredManipulators.delete(t),this._onFocusChange(i))},l._afterManipulatorUngrab=function(e){0===this._grabbedManipulators.size&&this._revertToNullActiveTool&&(e(null),this._revertToNullActiveTool=!1)},t._createClass(e,[{key:"cursor",get:function(){return this._cursor}}]),e}();function c(e){return"mouse"===e}function u(e){return"mouse"!==e.pointerType||0===e.button}function h(e){return!!e.native.shiftKey}e.ToolViewManagerManipulatorState=l,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
