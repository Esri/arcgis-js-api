/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Evented","../../../core/HandleOwner","../../../core/lang","../../../core/maybe","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../../geometry/projection","../../../support/elevationInfoUtils","./SnappingDomain","./snappingFactory","./SnappingOptions","./snappingUtils","./candidates/IntersectionSnappingCandidate","../support/viewUtils"],(function(n,t,e,i,o,r,a,s,c,p,d,u,h,l,f,_,g,v,S,y){"use strict";var P;n.SnappingManager=function(n){function e(t){var e;return(e=n.call(this,t)||this).options=new g,e.snappingEnginesFactory=_.defaultSnappingEnginesFactory,e._engines=[],e._currentMainCandidate=null,e._currentOtherActiveCandidates=[],e._currentSnappedType=P.MAIN,e}t._inheritsLoose(e,n);var i=e.prototype;return i.initialize=function(){this.handles.add([c.watch((()=>{const{effectiveFeatureEnabled:n,effectiveSelfEnabled:t,touchSensitivityMultiplier:e,distance:i}=this.options;return{effectiveFeatureEnabled:n,effectiveSelfEnabled:t,touchSensitivityMultiplier:e,distance:i}}),(()=>{this.doneSnapping(),this.emit("changed")}),c.sync),c.watch((()=>this.options),(n=>{for(const t of this._engines)t.options=n}),c.sync),c.watch((()=>({viewReady:this.view.ready,viewSpatialReference:this.view.spatialReference,snappingEnginesFactory:this.snappingEnginesFactory})),(({viewReady:n,snappingEnginesFactory:t})=>this._recreateEngines(n,t)),c.syncAndInitial)])},i.destroy=function(){this._destroyEngines()},i._recreateEngines=function(n,t){if(this._destroyEngines(),!n)return;const{view:e,options:i}=this;this._engines=t(e,i)},i._destroyEngines=function(){for(const n of this._engines)n.destroy();this._engines=[]},i.snap=function(){var n=t._asyncToGenerator((function*(n){return E(n)?this._snapMultiPoint(n):this._snapSinglePoint(n)}));function e(t){return n.apply(this,arguments)}return e}(),i.update=function(n){const{point:t,context:e}=n;this._removeVisualization();const i=this._currentMainCandidate;if(a.isNone(i))return t;const o=this._selectUpdateInput(n);if(a.isNone(o))return t;const{coordinateHelper:{spatialReference:r}}=e,s=h.project(this._convertPointElevation(o,e),r);if(a.isNone(s))return t;const{view:c}=this,{coordinateHelper:p,elevationInfo:d,visualizer:u}=e,f=[],_=p.pointToVector(s),g=i.constraint.closestTo(_);if(!this._arePointsWithinScreenThreshold(_,g,e))return this._resetSnappingState(),t;i.targetPoint=g,f.push(...i.hints);for(const a of this._currentOtherActiveCandidates)a.targetPoint=g,f.push(...a.hints);a.isSome(u)&&this.handles.add(u.draw(f,{coordinateHelper:p,elevationInfo:T(e),view:c,selfSnappingZ:e.selfSnappingZ}),C);const v=p.vectorToDehydratedPoint(g);return this._convertPointElevation(v,e,l.absoluteHeightElevationInfo,d)},i.doneSnapping=function(){this._removeVisualization(),this._resetSnappingState()},i._selectUpdateInput=function({point:n,scenePoint:t}){switch(this._currentSnappedType){case P.MAIN:return n;case P.SCENE:return t}},i._resetSnappingState=function(){this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=P.MAIN},i._removeVisualization=function(){this.handles.remove(C)},i._snapSinglePoint=function(){var n=t._asyncToGenerator((function*({point:n,context:t,signal:e}){const{coordinateHelper:i}=t,{view:o}=this,r=this._convertPointElevation(n,t),a=i.pointToVector(r),s=yield this._fetchCandidates(a,f.SnappingDomain.ALL,t,e);return this._createSnapResult(a,P.MAIN,s,o,t,e)}));function e(t){return n.apply(this,arguments)}return e}(),i._snapMultiPoint=function(){var n=t._asyncToGenerator((function*({point:n,scenePoint:t,context:e,signal:i}){const{view:o}=this,{coordinateHelper:r}=e,{spatialReference:a}=r;yield h.initializeProjection(t.spatialReference,a);const s=h.project(this._convertPointElevation(t,e),a),c=r.pointToVector(s),p=yield this._fetchCandidates(c,f.SnappingDomain.FEATURE,e,i);if(p.length>0){const n=yield this._fetchCandidates(c,f.SnappingDomain.SELF,e,i);return this._createSnapResult(c,P.SCENE,[...p,...n],o,e,i)}const d=this._convertPointElevation(n,e),u=r.pointToVector(d),l=yield this._fetchCandidates(u,f.SnappingDomain.SELF,e,i);return this._createSnapResult(u,P.MAIN,l,o,e,i)}));function e(t){return n.apply(this,arguments)}return e}(),i._fetchCandidates=function(){var n=t._asyncToGenerator((function*(n,t,e,i){return(yield Promise.all(this._engines.map((o=>o.fetchCandidates(n,t,e,i))))).flat()}));function e(t,e,i,o){return n.apply(this,arguments)}return e}(),i._createSnapResult=function(n,t,e,i,o,r){return{get valid(){return!s.isAborted(r)},apply:()=>{const{elevationInfo:r,coordinateHelper:s}=o,{snappedPoint:c,hints:p}=this._processCandidates(n,t,e,o);return this._removeVisualization(),a.isSome(o.visualizer)&&this.handles.add(o.visualizer.draw(p,{coordinateHelper:s,elevationInfo:T(o),view:i,selfSnappingZ:o.selfSnappingZ}),C),this._convertPointElevation(c,o,l.absoluteHeightElevationInfo,r)}}},i._processCandidates=function(n,t,e,i){const{coordinateHelper:o}=i;if(e.length<1)return this.doneSnapping(),{snappedPoint:o.vectorToDehydratedPoint(n),hints:[]};this._currentSnappedType!==t&&this._resetSnappingState(),v.sortCandidatesInPlace(n,e,o);const r=this._currentMainCandidate;if(a.isSome(r)){const o=this._findOldConstraintInNewCandidates(r,e);if(o>=0){if(!(e[o]instanceof S.IntersectionSnappingCandidate))return this._intersectWithOtherCandidates(o,e,n,t,i);if(this._arePointsWithinScreenThreshold(n,r.targetPoint,i))return this._updateSnappingCandidate(r,t,e,i)}}return this._intersectWithOtherCandidates(0,e,n,t,i)},i._findOldConstraintInNewCandidates=function(n,t){return n instanceof S.IntersectionSnappingCandidate?this._findOldCandidateIndex(t,n.first)>=0&&this._findOldCandidateIndex(t,n.second)>=0?0:-1:this._findOldCandidateIndex(t,n)},i._intersectWithOtherCandidates=function(n,t,e,i,o){const{coordinateHelper:r}=o,a=t[n],s=[];for(let c=0;c<t.length;++c){if(c===n)continue;const i=t[c];for(const n of a.constraint.intersect(i.constraint)){const t=r.fromXYZ(n.closestTo(a.targetPoint),a.targetPoint[2]);s.push([new S.IntersectionSnappingCandidate(r,t,a,i,i.elevationInfo),this._squaredScreenDistance(e,t,r)])}}return s.length>0&&(s.sort(((n,t)=>n[1]-t[1])),s[0][1]<this._squaredPointProximityThreshold(o.pointer))?this._updateSnappingCandidate(s[0][0],i,t,o):this._updateSnappingCandidate(a,i,t,o)},i._updateSnappingCandidate=function(n,t,e,i){this.doneSnapping(),this._currentMainCandidate=n,this._currentSnappedType=t;const o=this._currentMainCandidate.targetPoint,r=[];r.push(...n.hints);for(const a of e){if(n instanceof S.IntersectionSnappingCandidate){if(a.constraint.equals(n.first.constraint)||a.constraint.equals(n.second.constraint))continue}else if(a.constraint.equals(n.constraint))continue;a.constraint.check(o)&&(a.targetPoint=o,this._currentOtherActiveCandidates.push(a),r.push(...a.hints))}return{snappedPoint:i.coordinateHelper.vectorToDehydratedPoint(o),hints:r}},i._squaredPointProximityThreshold=function(n){return"touch"===n?this._squaredTouchProximityThreshold:this._squaredMouseProximityTreshold},i._arePointsWithinScreenThreshold=function(n,t,e){return this._squaredScreenDistance(n,t,e.coordinateHelper)<this._squaredPointProximityThreshold(e.pointer)},i._squaredScreenDistance=function(n,t,e){return v.squaredScreenDistance(this._toScreen(n,e),this._toScreen(t,e))},i._toScreen=function(n,t){return y.anyMapPointToScreenPoint(n,t,l.absoluteHeightElevationInfo,this.view)},i._findOldCandidateIndex=function(n,t){let e=-1;for(let i=0;i<n.length;++i)if(t.constraint.equals(n[i].constraint)){e=i;break}return e},i._convertPointElevation=function(n,t,e=t.elevationInfo,i=l.absoluteHeightElevationInfo){const{view:o}=this;if(!(a.isSome(n)&&t.coordinateHelper.hasZ()&&a.isSome(o)&&"3d"===o.type))return n;const s=r.clone(n);return s.z=l.getConvertedElevation(o,s,e,i),s},t._createClass(e,[{key:"updating",get:function(){return this._engines.some((n=>n.updating))}},{key:"_squaredMouseProximityTreshold",get:function(){return this.options.distance*this.options.distance}},{key:"_squaredTouchProximityThreshold",get:function(){const{distance:n,touchSensitivityMultiplier:t}=this.options,e=n*t;return e*e}},{key:"test",get:function(){return{visualizationsActive:this.handles.has(C),engines:this._engines}}}]),e}(i.EventedMixin(o.HandleOwner)),e.__decorate([p.property({constructOnly:!0})],n.SnappingManager.prototype,"view",void 0),e.__decorate([p.property()],n.SnappingManager.prototype,"options",void 0),e.__decorate([p.property({readOnly:!0})],n.SnappingManager.prototype,"updating",null),e.__decorate([p.property()],n.SnappingManager.prototype,"snappingEnginesFactory",void 0),e.__decorate([p.property()],n.SnappingManager.prototype,"_engines",void 0),e.__decorate([p.property()],n.SnappingManager.prototype,"_squaredMouseProximityTreshold",null),e.__decorate([p.property()],n.SnappingManager.prototype,"_squaredTouchProximityThreshold",null),n.SnappingManager=e.__decorate([u.subclass("esri.views.interactive.snapping.SnappingManager")],n.SnappingManager),function(n){n[n.MAIN=0]="MAIN",n[n.SCENE=1]="SCENE"}(P||(P={}));const C="visualization-handle";function E(n){return a.isSome(n.scenePoint)}function T({coordinateHelper:n,elevationInfo:t}){return n.hasZ()?l.absoluteHeightElevationInfo:t}Object.defineProperties(n,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
