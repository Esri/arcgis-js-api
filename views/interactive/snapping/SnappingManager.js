/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/has","../../../core/maybe","../../../core/Logger","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass","../../../core/urlUtils","../../../core/uuid","../../../portal/support/resourceExtension","../../../core/promiseUtils","../../../core/accessorSupport/trackingUtils","../../../geometry/SpatialReference","../../../geometry/Point","../../../core/Evented","../../../core/watchUtils","../../../core/HandleOwner","../../../chunks/vec2","./snappingUtils","./SnappingOptions","./FeatureSnappingEngine","./SelfSnappingEngine","./candidates/IntersectionSnappingCandidate"],(function(e,t,n,i,a,o,r,s,d,c,p,u,h,l,f,g,v,y,S,C,P,w,_,M,m){"use strict";e.SnappingManager=function(e){function n(t){var n;return(n=e.call(this,t)||this).options=new w,n.engines=[],n._currentMainCandidate=null,n._currentOtherActiveCandidates=[],n.options=new w,n}t._inheritsLoose(n,e);var i=n.prototype;return i.initialize=function(){this.handles.add([l.reaction((()=>{const{effectiveFeatureEnabled:e,effectiveSelfEnabled:t,touchSensitivityMultiplier:n,distance:i}=this.options;return{effectiveFeatureEnabled:e,effectiveSelfEnabled:t,touchSensitivityMultiplier:n,distance:i}}),(()=>{this.doneSnapping(),this.emit("changed")})),this.watch("options",(e=>{for(const t of this.engines)t.options=e}),!0),y.init(this.view,"ready",(e=>this.onViewReady(e)),!0)])},i.destroy=function(){this.destroyEngines()},i.onViewReady=function(e){var t,n;(this.destroyEngines(),e)&&(this.engines=[new M.SelfSnappingEngine({view:this.view,options:this.options}),new _.FeatureSnappingEngine({view:this.view,spatialReference:null!=(t=null==(n=this.view)?void 0:n.spatialReference)?t:f.WGS84,options:this.options})])},i.destroyEngines=function(){for(const e of this.engines)e.destroy();this.engines.length=0},i.snap=async function(e,t,n){const i=t.coordinateHelper.fromPoint(e),o=await this.fetchCandidates(i,t,n);return{get valid(){return!h.isAborted(n)},apply:()=>{const{snappedPoint:e,hints:n}=this.processCandidates(i,o,t);return this.removeVisualization(),a.isSome(t.visualizer)&&this.handles.add(t.visualizer.draw(n,{coordinateHelper:t.coordinateHelper,elevationInfo:t.elevationInfo,view:this.view}),I),e}}},i.update=function(e,t){this.removeVisualization();let n=e;const i=[];if(a.isSome(this._currentMainCandidate)){const a=t.coordinateHelper,o=a.fromPoint(e),r=this._currentMainCandidate.constraint.closestTo(o);if(P.squareDistance(P.anyMapPointToScreenPoint(o,a,t.elevationInfo,this.view),P.anyMapPointToScreenPoint(r,a,t.elevationInfo,this.view))<this.squaredPointProximityThreshold(t.pointer)){n=a.createDehydratedPoint(r),this._currentMainCandidate.targetPoint=r,i.push(...this._currentMainCandidate.hints);for(const e of this._currentOtherActiveCandidates)e.targetPoint=r,i.push(...e.hints)}else this._currentMainCandidate=null,this._currentOtherActiveCandidates=[]}return a.isSome(t.visualizer)&&this.handles.add(t.visualizer.draw(i,{coordinateHelper:t.coordinateHelper,elevationInfo:t.elevationInfo,view:this.view}),I),n},i.doneSnapping=function(){this.removeVisualization(),this._currentMainCandidate=null,this._currentOtherActiveCandidates=[]},i.removeVisualization=function(){this.handles.remove(I)},i.fetchCandidates=async function(e,t,n){return(await Promise.all(this.engines.map((i=>i.fetchCandidates(e,t,n))))).flat()},i.processCandidates=function(e,t,n){if(t.length<1)return this.doneSnapping(),{snappedPoint:n.coordinateHelper.toPoint(e,new g),hints:[]};P.sortCandidatesInPlace(e,t);const i=this._currentMainCandidate;if(a.isSome(i)){const a=this.findOldConstraintInNewCandidates(i,t);if(a>=0){if(!(t[a]instanceof m.IntersectionSnappingCandidate))return this.intersectWithOtherCandidates(a,t,e,n);if(C.squaredDistance(e,i.targetPoint)<this.squaredPointProximityThreshold(n.pointer))return this.updateSnappingCandidate(i,t,n)}}return this.intersectWithOtherCandidates(0,t,e,n)},i.findOldConstraintInNewCandidates=function(e,t){return e instanceof m.IntersectionSnappingCandidate?this.findOldCandidateIndex(t,e.first)>=0&&this.findOldCandidateIndex(t,e.second)>=0?0:-1:this.findOldCandidateIndex(t,e)},i.intersectWithOtherCandidates=function(e,t,n,i){const a=t[e],o=[],r=i.coordinateHelper;for(let s=0;s<t.length;++s){if(s===e)continue;const d=t[s];for(const e of a.constraint.intersect(d.constraint)){const t=r.fromXYZ(e.intersection,a.targetPoint[2]);o.push([new m.IntersectionSnappingCandidate(r,t,a,d),P.squareDistance(P.anyMapPointToScreenPoint(n,i.coordinateHelper,i.elevationInfo,this.view),P.anyMapPointToScreenPoint(t,i.coordinateHelper,i.elevationInfo,this.view))])}}return o.length>0&&(o.sort(((e,t)=>e[1]-t[1])),o[0][1]<this.squaredPointProximityThreshold(i.pointer))?this.updateSnappingCandidate(o[0][0],t,i):this.updateSnappingCandidate(a,t,i)},i.updateSnappingCandidate=function(e,t,n){this.doneSnapping(),this._currentMainCandidate=e;const i=this._currentMainCandidate.targetPoint,a=[];a.push(...e.hints);for(const o of t){if(e instanceof m.IntersectionSnappingCandidate){if(o.constraint.objectEqual(e.first.constraint)||o.constraint.objectEqual(e.second.constraint))continue}else if(o.constraint.objectEqual(e.constraint))continue;o.constraint.check(i)&&(o.targetPoint=i,this._currentOtherActiveCandidates.push(o),a.push(...o.hints))}return{snappedPoint:n.coordinateHelper.createDehydratedPoint(i),hints:a}},i.squaredPointProximityThreshold=function(e){return"touch"===e?this.squaredTouchProximityThreshold:this.squaredMouseProximityTreshold},i.findOldCandidateIndex=function(e,t){let n=-1;for(let i=0;i<e.length;++i)if(t.constraint.objectEqual(e[i].constraint)){n=i;break}return n},t._createClass(n,[{key:"updating",get:function(){return this.engines.some((e=>e.updating))}},{key:"squaredMouseProximityTreshold",get:function(){return this.options.distance*this.options.distance}},{key:"squaredTouchProximityThreshold",get:function(){const{distance:e,touchSensitivityMultiplier:t}=this.options,n=e*t;return n*n}},{key:"test",get:function(){return{visualizationsActive:this.handles.has(I)}}}]),n}(v.EventedMixin(S.HandleOwner)),n.__decorate([s.property({constructOnly:!0})],e.SnappingManager.prototype,"view",void 0),n.__decorate([s.property()],e.SnappingManager.prototype,"options",void 0),n.__decorate([s.property({readOnly:!0})],e.SnappingManager.prototype,"updating",null),n.__decorate([s.property()],e.SnappingManager.prototype,"engines",void 0),n.__decorate([s.property()],e.SnappingManager.prototype,"squaredMouseProximityTreshold",null),n.__decorate([s.property()],e.SnappingManager.prototype,"squaredTouchProximityThreshold",null),e.SnappingManager=n.__decorate([d.subclass("esri.views.interactive.snapping.SnappingManager")],e.SnappingManager);const I="visualization-handle";Object.defineProperty(e,"__esModule",{value:!0})}));
