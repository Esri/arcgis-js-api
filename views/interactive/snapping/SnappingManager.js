/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Evented","../../../core/HandleOwner","../../../core/maybe","../../../core/promiseUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/accessorSupport/ensureType","../../../core/Logger","../../../core/accessorSupport/decorators/subclass","../../../core/accessorSupport/trackingUtils","../../../chunks/vec2","../../../geometry/SpatialReference","./FeatureSnappingEngine","./SelfSnappingEngine","./SnappingOptions","./snappingUtils","./candidates/IntersectionSnappingCandidate"],(function(e,n,t,i,a,o,r,s,d,c,p,u,h,l,f,g,v,y,S,C,P){"use strict";e.SnappingManager=function(e){function t(n){var t;return(t=e.call(this,n)||this).options=new S,t.engines=[],t._currentMainCandidate=null,t._currentOtherActiveCandidates=[],t}n._inheritsLoose(t,e);var i=t.prototype;return i.initialize=function(){this.handles.add([l.reaction((()=>{const{effectiveFeatureEnabled:e,effectiveSelfEnabled:n,touchSensitivityMultiplier:t,distance:i}=this.options;return{effectiveFeatureEnabled:e,effectiveSelfEnabled:n,touchSensitivityMultiplier:t,distance:i}}),(()=>{this.doneSnapping(),this.emit("changed")})),this.watch("options",(e=>{for(const n of this.engines)n.options=e}),!0),s.init(this.view,"ready",(e=>this.onViewReady(e)),!0)])},i.destroy=function(){this.destroyEngines()},i.onViewReady=function(e){var n,t;(this.destroyEngines(),e)&&(this.engines=[new y.SelfSnappingEngine({view:this.view,options:this.options}),new v.FeatureSnappingEngine({view:this.view,spatialReference:null!=(n=null==(t=this.view)?void 0:t.spatialReference)?n:g.WGS84,options:this.options})])},i.destroyEngines=function(){for(const e of this.engines)e.destroy();this.engines.length=0},i.snap=function(){var e=n._asyncToGenerator((function*(e,n,t){const i=n.coordinateHelper.fromPoint(e),a=yield this.fetchCandidates(i,n,t);return{get valid(){return!r.isAborted(t)},apply:()=>{const{snappedPoint:e,hints:t}=this.processCandidates(i,a,n);return this.removeVisualization(),o.isSome(n.visualizer)&&this.handles.add(n.visualizer.draw(t,{coordinateHelper:n.coordinateHelper,elevationInfo:n.elevationInfo,view:this.view}),_),e}}}));function t(n,t,i){return e.apply(this,arguments)}return t}(),i.update=function(e,n){this.removeVisualization();let t=e;const i=[];if(o.isSome(this._currentMainCandidate)){const a=n.coordinateHelper,o=a.fromPoint(e),r=this._currentMainCandidate.constraint.closestTo(o);if(C.squareDistance(C.anyMapPointToScreenPoint(o,a,n.elevationInfo,this.view),C.anyMapPointToScreenPoint(r,a,n.elevationInfo,this.view))<this.squaredPointProximityThreshold(n.pointer)){t=a.createDehydratedPoint(r),this._currentMainCandidate.targetPoint=r,i.push(...this._currentMainCandidate.hints);for(const e of this._currentOtherActiveCandidates)e.targetPoint=r,i.push(...e.hints)}else this._currentMainCandidate=null,this._currentOtherActiveCandidates=[]}return o.isSome(n.visualizer)&&this.handles.add(n.visualizer.draw(i,{coordinateHelper:n.coordinateHelper,elevationInfo:n.elevationInfo,view:this.view}),_),t},i.doneSnapping=function(){this.removeVisualization(),this._currentMainCandidate=null,this._currentOtherActiveCandidates=[]},i.removeVisualization=function(){this.handles.remove(_)},i.fetchCandidates=function(){var e=n._asyncToGenerator((function*(e,n,t){return(yield Promise.all(this.engines.map((i=>i.fetchCandidates(e,n,t))))).flat()}));function t(n,t,i){return e.apply(this,arguments)}return t}(),i.processCandidates=function(e,n,t){if(n.length<1)return this.doneSnapping(),{snappedPoint:t.coordinateHelper.createDehydratedPoint(e),hints:[]};C.sortCandidatesInPlace(e,n);const i=this._currentMainCandidate;if(o.isSome(i)){const a=this.findOldConstraintInNewCandidates(i,n);if(a>=0){if(!(n[a]instanceof P.IntersectionSnappingCandidate))return this.intersectWithOtherCandidates(a,n,e,t);if(f.squaredDistance(e,i.targetPoint)<this.squaredPointProximityThreshold(t.pointer))return this.updateSnappingCandidate(i,n,t)}}return this.intersectWithOtherCandidates(0,n,e,t)},i.findOldConstraintInNewCandidates=function(e,n){return e instanceof P.IntersectionSnappingCandidate?this.findOldCandidateIndex(n,e.first)>=0&&this.findOldCandidateIndex(n,e.second)>=0?0:-1:this.findOldCandidateIndex(n,e)},i.intersectWithOtherCandidates=function(e,n,t,i){const a=n[e],o=[],r=i.coordinateHelper;for(let s=0;s<n.length;++s){if(s===e)continue;const d=n[s];for(const e of a.constraint.intersect(d.constraint)){const n=r.fromXYZ(e.intersection,a.targetPoint[2]);o.push([new P.IntersectionSnappingCandidate(r,n,a,d),C.squareDistance(C.anyMapPointToScreenPoint(t,i.coordinateHelper,i.elevationInfo,this.view),C.anyMapPointToScreenPoint(n,i.coordinateHelper,i.elevationInfo,this.view))])}}return o.length>0&&(o.sort(((e,n)=>e[1]-n[1])),o[0][1]<this.squaredPointProximityThreshold(i.pointer))?this.updateSnappingCandidate(o[0][0],n,i):this.updateSnappingCandidate(a,n,i)},i.updateSnappingCandidate=function(e,n,t){this.doneSnapping(),this._currentMainCandidate=e;const i=this._currentMainCandidate.targetPoint,a=[];a.push(...e.hints);for(const o of n){if(e instanceof P.IntersectionSnappingCandidate){if(o.constraint.objectEqual(e.first.constraint)||o.constraint.objectEqual(e.second.constraint))continue}else if(o.constraint.objectEqual(e.constraint))continue;o.constraint.check(i)&&(o.targetPoint=i,this._currentOtherActiveCandidates.push(o),a.push(...o.hints))}return{snappedPoint:t.coordinateHelper.createDehydratedPoint(i),hints:a}},i.squaredPointProximityThreshold=function(e){return"touch"===e?this.squaredTouchProximityThreshold:this.squaredMouseProximityTreshold},i.findOldCandidateIndex=function(e,n){let t=-1;for(let i=0;i<e.length;++i)if(n.constraint.objectEqual(e[i].constraint)){t=i;break}return t},n._createClass(t,[{key:"updating",get:function(){return this.engines.some((e=>e.updating))}},{key:"squaredMouseProximityTreshold",get:function(){return this.options.distance*this.options.distance}},{key:"squaredTouchProximityThreshold",get:function(){const{distance:e,touchSensitivityMultiplier:n}=this.options,t=e*n;return t*t}},{key:"test",get:function(){return{visualizationsActive:this.handles.has(_),engines:this.engines}}}]),t}(i.EventedMixin(a.HandleOwner)),t.__decorate([d.property({constructOnly:!0})],e.SnappingManager.prototype,"view",void 0),t.__decorate([d.property()],e.SnappingManager.prototype,"options",void 0),t.__decorate([d.property({readOnly:!0})],e.SnappingManager.prototype,"updating",null),t.__decorate([d.property()],e.SnappingManager.prototype,"engines",void 0),t.__decorate([d.property()],e.SnappingManager.prototype,"squaredMouseProximityTreshold",null),t.__decorate([d.property()],e.SnappingManager.prototype,"squaredTouchProximityThreshold",null),e.SnappingManager=t.__decorate([h.subclass("esri.views.interactive.snapping.SnappingManager")],e.SnappingManager);const _="visualization-handle";Object.defineProperty(e,"__esModule",{value:!0})}));
