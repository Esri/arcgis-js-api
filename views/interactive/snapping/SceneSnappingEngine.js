/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import r from"../../../core/Accessor.js";import t from"../../../core/Collection.js";import{isSome as o}from"../../../core/maybe.js";import{property as s}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/arrayUtils.js";import"../../../core/has.js";import"../../../core/accessorSupport/ensureType.js";import{subclass as i}from"../../../core/accessorSupport/decorators/subclass.js";import{sv3d as p}from"../../../geometry/support/vectorStacks.js";import{SnappingTypes as n}from"../../../layers/graphics/data/QueryEngineResult.js";import a from"./FeatureSnappingLayerSource.js";import{sortCandidatesInPlace as c}from"./snappingUtils.js";import{SceneLayerSnappingSource as u}from"./featureSources/SceneLayerSnappingSource.js";import{anyMapPointToRender as l}from"../support/viewUtils.js";let m=class extends r{constructor(e){super(e),this.options=null,this._snappingSources=new t}initialize(){this.own([this.view.on("layerview-create",(({layerView:e})=>this._createSource(e))),this.view.on("layerview-destroy",(({layerView:e})=>this._removeSource(e)))]);for(const e of this.view.allLayerViews.items)this._createSource(e)}destroy(){this.options=null,this._snappingSources.drain((e=>e.destroy()))}get updating(){return this._snappingSources.some((e=>e.updating))}get _types(){return n.EDGE|n.VERTEX}async fetchCandidates(e,r,t){const{view:s,options:i}=this,{coordinateHelper:n,elevationInfo:a}=r,u=o(i)?i.distance:1,m=l(e,n,a,s,p.get()),y=u*s.state.camera.computeScreenPixelSizeAt(m),S=this._types,d=this._snappingSources.items.map((r=>r.fetchCandidates({point:e,coordinateHelper:n,distance:y,types:S},t))),h=(await Promise.all(d)).flat();return c(e,h),h}_createSource(e){if("scene-layer-3d"!==e.type)return;const r=new u({layerSource:new a({layer:e.layer}),view:this.view});this._snappingSources.push(r)}_removeSource(e){const r=this._snappingSources.findIndex((r=>r.layerSource.layer===e.layer));-1!==r&&this._snappingSources.removeAt(r).destroy()}};e([s({constructOnly:!0})],m.prototype,"view",void 0),e([s()],m.prototype,"updating",null),e([s()],m.prototype,"options",void 0),e([s()],m.prototype,"_snappingSources",void 0),m=e([i("esri.views.interactive.snapping.SceneSnappingEngine")],m);export{m as SceneSnappingEngine};
