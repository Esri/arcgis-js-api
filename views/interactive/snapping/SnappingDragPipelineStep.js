/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/maybe","../../../core/promiseUtils","../../../layers/graphics/dehydratedFeatureComparison","../dragEventPipeline","./SnappingContext","../../support/Scheduler"],(function(e,n,t,i,a,r,o,p){"use strict";let s=function(){function e(){this.next=new r.EventPipeline}return e.prototype.createSnapDragEventPipelineStep=function({predicate:e=(()=>!0),cancel:s,snappingManager:l,snappingContext:c,updatingHandles:d}){var u=this;if(t.isNone(l))return e=>e;let y=null,m=null;const x=()=>{y=t.abortMaybe(y),l.doneSnapping(),t.isSome(m)&&m.frameTask.remove(),m=null};return s.next((e=>(x(),e))),this.next=new r.EventPipeline,r=>{if(!e(r))return r;if(y=t.abortMaybe(y),"start"===r.action){const e="3d"===l.view.type?l.view.resourceController.scheduler.registerTask(p.TaskPriority.SNAPPING):p.ImmediateTask;m={context:new o.SnappingContext({editGeometryOperations:c.editGeometryOperations,elevationInfo:c.elevationInfo,pointer:c.pointer,vertexHandle:t.isSome(r.info)?r.info.handle:null,excludeFeature:c.excludeFeature,visualizer:c.visualizer}),originalPos:t.isSome(r.snapOrigin)?c.coordinateHelper.vectorToDehydratedPoint(r.snapOrigin):r.mapStart,frameTask:e}}if(t.isSome(m)){const e=m.context.coordinateHelper.vectorToDehydratedPoint(m.context.coordinateHelper.arrayToVector([m.originalPos.x,m.originalPos.y,m.originalPos.z]));e.x+=r.mapEnd.x-r.mapStart.x,e.y+=r.mapEnd.y-r.mapStart.y;const t=r.mapStart.x-m.originalPos.x,o=r.mapStart.y-m.originalPos.y,p={...r,action:"udpate"},s=m.context,c=l.update(e,m.context);if(r.mapEnd.x=c.x+t,r.mapEnd.y=c.y+o,"end"!==r.action){const r=m.frameTask;y=i.createTask(function(){var i=n._asyncToGenerator((function*(n){const i=yield r.schedule((()=>l.snap(e,s,n)),n);if(i.valid){const e=yield r.schedule((()=>i.apply()),n);a.pointEquals(e,c)||(p.mapEnd.x=e.x+t,p.mapEnd.y=e.y+o,u.next.execute(p))}}));return function(e){return i.apply(this,arguments)}}()),d.addPromise(y.promise)}}return"end"===r.action&&x(),r}},e}();e.SnappingPipeline=s,Object.defineProperty(e,"__esModule",{value:!0})}));
