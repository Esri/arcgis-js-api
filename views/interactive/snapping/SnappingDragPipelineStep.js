/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/maybe","../../../core/promiseUtils","../../../core/reactiveUtils","../../../layers/graphics/dehydratedFeatureComparison","../../../layers/graphics/hydratedFeatures","../dragEventPipeline","./SnappingContext","../../support/Scheduler"],(function(e,n,t,o,i,a,r,s,l,c){"use strict";function p({predicate:e=(()=>!0),snappingManager:n,snappingContext:a,updatingHandles:r,useZ:l=!0}){const c=new s.EventPipeline;if(t.isNone(n))return{snappingStep:[v,c],cancelSnapping:v};let p,x=null,h=null,b=null;const T=()=>{x=t.abortMaybe(x),n.doneSnapping(),t.isSome(h)&&h.frameTask.remove(),h=null,p=t.removeMaybe(p),b=null},Z=u(n,l,c);let k=null,E=null,N=null;return{snappingStep:[s=>{if(!e(s))return s;const{action:c}=s;if("start"===c){const{info:e}=s,o=d(n.view);if(h=f(a,s,o),h.context.selfSnappingZ=null,!l&&t.isSome(e)){const n=y(a.coordinateHelper,e.handle.component);t.isSome(n)&&(h.context.selfSnappingZ={value:n,elevationInfo:a.elevationInfo})}}if(t.isSome(h)){const{context:e,originalScenePos:a,originalPos:u}=h,{mapEnd:d,mapStart:f,scenePoints:y}=s,v=g(u,m(d,f)),T=m(f,u),z={...s,action:"update"},w=h.context,C=S(a,y),I=n.update({point:v,scenePoint:C,context:e});if(N=I,P(d,I,T,l),k=v,E=C,"end"!==c){const{frameTask:e}=h;t.isNone(x)&&(x=new AbortController),b=n=>{r.addPromise(o.ignoreAbortErrors(Z({frameTask:e,event:z,context:w,point:v,scenePoint:C,delta:T,getLastState:()=>({point:k,scenePoint:E,updatePoint:n.forceUpdate?null:N})},t.unwrap(x).signal)))},b({forceUpdate:!1}),t.isNone(p)&&(p=i.watch((()=>n.options.effectiveEnabled),(()=>b?.({forceUpdate:!0}))))}}return"end"===c&&T(),s},c],cancelSnapping:e=>(T(),e)}}function u(e,i,r){return o.debounce(function(){var o=n._asyncToGenerator((function*({frameTask:n,point:o,scenePoint:s,context:l,event:c,delta:p,getLastState:u},d){const f=yield n.schedule((()=>e.snap({point:o,scenePoint:s,context:l,signal:d})),d);if(f.valid){let s=yield n.schedule((()=>f.apply()),d);const g=u();t.isSome(g.point)&&o!==g.point&&(s=e.update({point:g.point,scenePoint:g.scenePoint,context:l})),!t.isNone(g.updatePoint)&&a.pointEquals(s,g.updatePoint)||(P(c.mapEnd,s,p,i),r.execute(c))}}));return function(e,n){return o.apply(this,arguments)}}())}function d(e){return"3d"===e.type?e.resourceController.scheduler.registerTask(c.TaskPriority.SNAPPING):c.ImmediateTask}function f(e,n,o){return{context:new l.SnappingContext({editGeometryOperations:e.editGeometryOperations,elevationInfo:e.elevationInfo,pointer:e.pointer,vertexHandle:t.isSome(n.info)?n.info.handle:null,excludeFeature:e.excludeFeature,visualizer:e.visualizer}),originalPos:t.isSome(n.snapOrigin)?e.coordinateHelper.vectorToDehydratedPoint(n.snapOrigin):n.mapStart,originalScenePos:t.isSome(n.scenePoints)?n.scenePoints.sceneStart:null,frameTask:o}}function g(e,[n,t,o]){const i=r.clonePoint(e);return i.x+=n,i.y+=t,i.hasZ&&(i.z+=o),i}function S(e,n){return t.isNone(e)||t.isNone(n)?null:g(e,m(n.sceneEnd,n.sceneStart))}function m(e,n){const t=e.hasZ&&n.hasZ?e.z-n.z:0;return[e.x-n.x,e.y-n.y,t]}function P(e,n,[t,o,i],a){e.x=n.x+t,e.y=n.y+o,a&&e.hasZ&&n.hasZ&&(e.z=n.z+i)}function y(e,n){if(!e.hasZ())return null;const o=n.vertices;let i=null;for(const a of o){const n=e.getZ(a.pos);if(t.isSome(i)&&t.isSome(n)&&Math.abs(n-i)>1e-6)return null;t.isNone(i)&&(i=n)}return i}function v(e){return e}e.createSnapDragEventPipelineStep=p,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
