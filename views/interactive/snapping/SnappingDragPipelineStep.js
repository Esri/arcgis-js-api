/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/maybe","../../../core/promiseUtils","../../../layers/graphics/dehydratedFeatureComparison","../dragEventPipeline","./SnappingContext","../../support/Scheduler"],(function(e,n,t,i,a,o,r,p){"use strict";let s=function(){function e(){this.next=new o.EventPipeline}return e.prototype.createSnapDragEventPipelineStep=function({predicate:e=(()=>!0),cancel:s,snappingManager:l,snappingContext:c,updatingHandles:d}){var u=this;if(t.isNone(l))return e=>e;let m=null,y=null;const x=()=>{m=t.abortMaybe(m),l.doneSnapping(),t.isSome(y)&&y.frameTask.remove(),y=null};return s.next((e=>(x(),e))),this.next=new o.EventPipeline,o=>{if(!e(o))return o;if(m=t.abortMaybe(m),"start"===o.action){const e="3d"===l.view.type?l.view.resourceController.scheduler.registerTask(p.TaskPriority.SNAPPING):p.ImmediateTask;y={context:new r.SnappingContext({editGeometryOperations:c.editGeometryOperations,elevationInfo:c.elevationInfo,pointer:c.pointer,vertexHandle:t.isSome(o.info)?o.info.handle:null,excludeFeature:c.excludeFeature,visualizer:c.visualizer}),originalPos:t.isSome(o.snapOrigin)?c.coordinateHelper.vectorToDehydratedPoint(o.snapOrigin):o.mapStart,frameTask:e}}if(t.isSome(y)){const e=y.context.coordinateHelper.vectorToDehydratedPoint(y.context.coordinateHelper.arrayToVector([y.originalPos.x,y.originalPos.y,y.originalPos.z]));e.x+=o.mapEnd.x-o.mapStart.x,e.y+=o.mapEnd.y-o.mapStart.y;const t=o.mapStart.x-y.originalPos.x,r=o.mapStart.y-y.originalPos.y,p={...o,action:"udpate"},s=y.context,c=l.update(e,y.context);if(o.mapEnd.x=c.x+t,o.mapEnd.y=c.y+r,"end"!==o.action){const o=y.frameTask;m=i.createTask(function(){var i=n._asyncToGenerator((function*(n){const i=yield o.schedule((()=>l.snap(e,s,n)),n);if(i.valid){const e=yield o.schedule((()=>i.apply()),n);a.pointEquals(e,c)||(p.mapEnd.x=e.x+t,p.mapEnd.y=e.y+r,u.next.execute(p))}}));return function(e){return i.apply(this,arguments)}}()),d.addPromise(m.promise)}}return"end"===o.action&&x(),o}},e}();e.SnappingPipeline=s,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
