/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/has","../../../../core/maybe","../../../../core/Logger","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/decorators/subclass","../../../../core/urlUtils","../../../../core/uuid","../../../../portal/support/resourceExtension","../../../../core/arrayUtils","../../../../core/promiseUtils","../../../../core/Accessor","../../../../geometry/Point","../../../../geometry/Polygon","../../../../geometry/support/typeUtils","../../../../geometry/projection","../../../../layers/graphics/OptimizedFeature","../../../../layers/graphics/featureConversionUtils","../../../../core/HandleOwner","../snappingUtils","../../../../geometry/support/normalizeUtilsSync","../../../../layers/graphics/data/FeatureStore","../../../../layers/graphics/data/QueryEngine","./queryEngineUtils"],(function(e,t,r,i,n,o,s,a,c,p,d,u,l,h,y,g,f,S,m,v,w,k,O,_,b,G,P){"use strict";e.GraphicsSnappingSource=function(e){function r(t){var r;return(r=e.call(this,t)||this).availability=1,r.sources={multipoint:null,point:null,polygon:null,polyline:null},r.loadedWkids=new Set,r.loadedWkts=new Set,r.pendingAdds=[],r}t._inheritsLoose(r,e);var i=r.prototype;return i.destroy=function(){const e=this.pendingAdds;this.pendingAdds.length=0;for(const t of e)t.task.abort();this.mapSources((e=>this.destroySource(e)))},i.initialize=function(){this.handles.add([this.layer.on("graphic-update",(e=>this.onGraphicUpdate(e))),this.updatingHandles.addOnCollectionChange(this.layer.graphics,(e=>this.onGraphicsChanged(e)))]),this.addMany(this.layer.graphics.toArray())},i.fetchCandidates=async function(e,t){const r=(await h.eachAlwaysValues(this.mapSources((r=>r.queryEngine.executeQueryForSnapping({point:e.coordinateHelper.toPoint(e.point,new g).toJSON(),distance:e.distance,types:e.types,query:n.isSome(e.filter)?e.filter.createQuery().toJSON():{where:"1=1"}},t).then((({candidates:e})=>e)))))).flat().map((t=>P.convertSnappingCandidate(t,e.coordinateHelper)));return O.sortCandidatesInPlace(e.point,r),{candidates:r}},i.refresh=function(){},i.onGraphicUpdate=function(e){switch(e.property){case"geometry":case"visible":this.remove(e.graphic),this.addMany([e.graphic])}},i.onGraphicsChanged=function(e){for(const t of e.removed)this.remove(t);this.addMany(e.added)},i.addMany=function(e){const t=[],r=new Map;for(const i of e)n.isNone(i.geometry)||(this.needsInitializeProjection(i.geometry.spatialReference)?(t.push(i.geometry.spatialReference),r.set(i.uid,i)):this.add(i));this.createPendingAdd(t,r)},i.createPendingAdd=function(e,t){if(!e.length)return;const r=h.createTask((async r=>{await m.initializeProjection(e.map((e=>({source:e,dest:this.spatialReference}))),{signal:r}),this.markLoadedSpatialReferences(e);for(const[,e]of t)this.add(e)}));this.updatingHandles.addPromise(r.promise);const i={task:r,graphics:t},n=()=>l.removeUnordered(this.pendingAdds,i);r.promise.then(n,n),this.pendingAdds.push(i)},i.markLoadedSpatialReferences=function(e){for(const t of e)null!=t.wkid&&this.loadedWkids.add(t.wkid),null!=t.wkt&&this.loadedWkts.add(t.wkt)},i.add=function(e){if(n.isNone(e.geometry)||!e.visible)return;let t=e.geometry;if("mesh"===t.type)return;"extent"===t.type&&(t=f.fromExtent(t));const r=this.ensureSource(t.type);if(n.isNone(r))return;const i=this.createOptimizedFeature(e.uid,t);n.isSome(i)&&r.featureStore.add(i)},i.needsInitializeProjection=function(e){return(null==e.wkid||!this.loadedWkids.has(e.wkid))&&((null==e.wkt||!this.loadedWkts.has(e.wkt))&&!m.canProjectWithoutEngine(e,this.spatialReference))},i.createOptimizedFeature=function(e,t){const r=m.project(_.normalizeCentralMeridianSync(t),this.spatialReference);return r?new v(w.convertFromGeometry(r,!1,!1),{[C]:e},null,e):null},i.ensureSource=function(e){const t=this.sources[e];if(n.isSome(t))return t;const r=this.createSource(e);return this.sources[e]=r,r},i.createSource=function(e){const t=S.featureGeometryTypeKebabDictionary.toJSON(e),r=new b({geometryType:t,hasZ:!1,hasM:!1});return{featureStore:r,queryEngine:new G.default({featureStore:r,fields:[{name:C,type:"esriFieldTypeOID",alias:C}],geometryType:t,hasM:!1,hasZ:!1,objectIdField:C,spatialReference:this.spatialReference,scheduler:n.isSome(this.view)&&"3d"===this.view.type?this.view.resourceController.scheduler:null}),type:e}},i.remove=function(e){this.mapSources((t=>this.removeFromSource(t,e)));for(const t of this.pendingAdds)t.graphics.delete(e.uid),0===t.graphics.size&&t.task.abort()},i.removeFromSource=function(e,t){const r=t.uid;e.featureStore.has(r)&&e.featureStore.removeById(t.uid)},i.destroySource=function(e){e.queryEngine.destroy(),this.sources[e.type]=null},i.mapSources=function(e){const{point:t,polygon:r,polyline:i,multipoint:o}=this.sources,s=[];return n.isSome(t)&&s.push(e(t)),n.isSome(r)&&s.push(e(r)),n.isSome(i)&&s.push(e(i)),n.isSome(o)&&s.push(e(o)),s},t._createClass(r,[{key:"updating",get:function(){return this.updatingHandles.updating}},{key:"layer",get:function(){return this.layerSource.layer}}]),r}(k.HandleOwnerMixin(y)),r.__decorate([a.property({constructOnly:!0})],e.GraphicsSnappingSource.prototype,"spatialReference",void 0),r.__decorate([a.property({constructOnly:!0})],e.GraphicsSnappingSource.prototype,"layerSource",void 0),r.__decorate([a.property({constructOnly:!0})],e.GraphicsSnappingSource.prototype,"view",void 0),r.__decorate([a.property({readOnly:!0})],e.GraphicsSnappingSource.prototype,"updating",null),r.__decorate([a.property({readOnly:!0})],e.GraphicsSnappingSource.prototype,"availability",void 0),e.GraphicsSnappingSource=r.__decorate([c.subclass("esri.views.interactive.snapping.featureSources.GraphicsSnappingSource")],e.GraphicsSnappingSource);const C="OBJECTID";Object.defineProperty(e,"__esModule",{value:!0})}));
