/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/arrayUtils","../../../../core/HandleOwner","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","../../../../geometry/Polygon","../../../../geometry/projection","../../../../geometry/support/normalizeUtilsSync","../../../../geometry/support/typeUtils","../../../../layers/graphics/featureConversionUtils","../../../../layers/graphics/OptimizedFeature","../../../../layers/graphics/data/FeatureStore","../../../../layers/graphics/data/QueryEngine","../snappingUtils","./queryEngineUtils"],(function(e,t,r,n,i,o,s,a,c,p,u,d,l,h,y,f,g,S,m,_,v,k){"use strict";e.GraphicsSnappingSource=function(e){function r(t){var r;return(r=e.call(this,t)||this).availability=1,r.sources={multipoint:null,point:null,polygon:null,polyline:null},r.loadedWkids=new Set,r.loadedWkts=new Set,r.pendingAdds=[],r}t._inheritsLoose(r,e);var n=r.prototype;return n.destroy=function(){const e=this.pendingAdds;this.pendingAdds.length=0;for(const t of e)t.task.abort();this._mapSources((e=>this._destroySource(e)))},n.initialize=function(){this.handles.add([this.layer.on("graphic-update",(e=>this._onGraphicUpdate(e))),this.updatingHandles.addOnCollectionChange((()=>this.layer.graphics),(e=>this._onGraphicsChanged(e)))]),this._addMany(this.layer.graphics.toArray())},n.fetchCandidates=function(){var e=t._asyncToGenerator((function*(e,t){const r=yield a.eachAlwaysValues(this._mapSources((r=>r.queryEngine.executeQueryForSnapping({point:e.coordinateHelper.vectorToPoint(e.point).toJSON(),distance:e.distance,types:e.types,query:s.isSome(e.filter)?e.filter.createQuery().toJSON():{where:"1=1"}},t).then((({candidates:e})=>e))))),n=r.flat().map((t=>k.convertSnappingCandidate(t,e.coordinateHelper)));return v.sortCandidatesInPlace(e.point,n),n}));function r(t,r){return e.apply(this,arguments)}return r}(),n.refresh=function(){},n._onGraphicUpdate=function(e){switch(e.property){case"geometry":case"visible":this._remove(e.graphic),this._addMany([e.graphic])}},n._onGraphicsChanged=function(e){for(const t of e.removed)this._remove(t);this._addMany(e.added)},n._addMany=function(e){const t=[],r=new Map;for(const n of e)s.isNone(n.geometry)||(this._needsInitializeProjection(n.geometry.spatialReference)?(t.push(n.geometry.spatialReference),r.set(n.uid,n)):this._add(n));this._createPendingAdd(t,r)},n._createPendingAdd=function(e,r){var n=this;if(!e.length)return;const o=a.createTask(function(){var i=t._asyncToGenerator((function*(t){yield h.initializeProjection(e.map((e=>({source:e,dest:n.spatialReference}))),{signal:t}),n._markLoadedSpatialReferences(e);for(const[,e]of r)n._add(e)}));return function(e){return i.apply(this,arguments)}}());this.updatingHandles.addPromise(o.promise);const s={task:o,graphics:r},c=()=>i.removeUnordered(this.pendingAdds,s);o.promise.then(c,c),this.pendingAdds.push(s)},n._markLoadedSpatialReferences=function(e){for(const t of e)null!=t.wkid&&this.loadedWkids.add(t.wkid),null!=t.wkt&&this.loadedWkts.add(t.wkt)},n._add=function(e){if(s.isNone(e.geometry)||!e.visible)return;let t=e.geometry;if("mesh"===t.type)return;"extent"===t.type&&(t=l.fromExtent(t));const r=this._ensureSource(t.type);if(s.isNone(r))return;const n=this._createOptimizedFeature(e.uid,t);s.isSome(n)&&r.featureStore.add(n)},n._needsInitializeProjection=function(e){return(null==e.wkid||!this.loadedWkids.has(e.wkid))&&((null==e.wkt||!this.loadedWkts.has(e.wkt))&&!h.canProjectWithoutEngine(e,this.spatialReference))},n._createOptimizedFeature=function(e,t){const r=h.project(y.normalizeCentralMeridianSync(t),this.spatialReference);return r?new S.OptimizedFeature(g.convertFromGeometry(r,!1,!1),{[w]:e},null,e):null},n._ensureSource=function(e){const t=this.sources[e];if(s.isSome(t))return t;const r=this._createSource(e);return this.sources[e]=r,r},n._createSource=function(e){const t=f.featureGeometryTypeKebabDictionary.toJSON(e),r=new m({geometryType:t,hasZ:!1,hasM:!1});return{featureStore:r,queryEngine:new _.default({featureStore:r,fields:[{name:w,type:"esriFieldTypeOID",alias:w}],geometryType:t,hasM:!1,hasZ:!1,objectIdField:w,spatialReference:this.spatialReference,scheduler:s.isSome(this.view)&&"3d"===this.view.type?this.view.resourceController.scheduler:null}),type:e}},n._remove=function(e){this._mapSources((t=>this._removeFromSource(t,e)));for(const t of this.pendingAdds)t.graphics.delete(e.uid),0===t.graphics.size&&t.task.abort()},n._removeFromSource=function(e,t){const r=t.uid;e.featureStore.has(r)&&e.featureStore.removeById(t.uid)},n._destroySource=function(e){e.queryEngine.destroy(),this.sources[e.type]=null},n._mapSources=function(e){const{point:t,polygon:r,polyline:n,multipoint:i}=this.sources,o=[];return s.isSome(t)&&o.push(e(t)),s.isSome(r)&&o.push(e(r)),s.isSome(n)&&o.push(e(n)),s.isSome(i)&&o.push(e(i)),o},t._createClass(r,[{key:"updating",get:function(){return this.updatingHandles.updating}},{key:"layer",get:function(){return this.layerSource.layer}}]),r}(o.HandleOwnerMixin(n)),r.__decorate([c.property({constructOnly:!0})],e.GraphicsSnappingSource.prototype,"spatialReference",void 0),r.__decorate([c.property({constructOnly:!0})],e.GraphicsSnappingSource.prototype,"layerSource",void 0),r.__decorate([c.property({constructOnly:!0})],e.GraphicsSnappingSource.prototype,"view",void 0),r.__decorate([c.property({readOnly:!0})],e.GraphicsSnappingSource.prototype,"updating",null),r.__decorate([c.property({readOnly:!0})],e.GraphicsSnappingSource.prototype,"availability",void 0),e.GraphicsSnappingSource=r.__decorate([d.subclass("esri.views.interactive.snapping.featureSources.GraphicsSnappingSource")],e.GraphicsSnappingSource);const w="OBJECTID";Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
