/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../core/maybe","../../../../../core/promiseUtils","../../../../../core/Logger","../../../../../core/accessorSupport/ensureType","../../../../../core/arrayUtils","../../../../../core/Error","../../../../../core/has","../../../../../core/accessorSupport/decorators/subclass","../../../../../chunks/vec3","../../../../../chunks/vec3f64","../../../../../geometry/support/lineSegment","../../../../../chunks/sphere","../../../../../layers/graphics/data/QueryEngineResult","../../../../3d/webgl-engine/lib/Octree","../../../../3d/webgl-engine/lib/edgeRendering/edgeProcessing","./sceneLayerSnappingUtils"],(function(e,t,n,o,i,s,r,c,d,a,u,p,h,g,l,f,_,m){"use strict";let b=function(){function t(){this._idToComponent=new Map,this._components=new f((e=>e.bounds)),this._edges=new f((e=>e.bounds)),this._tmpLineSegment=h.create(),this._tmpP1=p.create(),this._tmpP2=p.create(),this._tmpP3=p.create(),this.remoteClient=null}var i=t.prototype;return i.fetchCandidates=function(){var t=e._asyncToGenerator((function*(e,t){yield Promise.resolve(),o.throwIfAborted(t),yield this._ensureEdgeLocations(e,t);const n=[];return this._edges.forEachNeighbor((t=>(this._addCandidates(e,t,n),n.length<m.MAX_CANDIDATE_COUNT)),e.bounds),{result:{candidates:n}}}));function n(e,n){return t.apply(this,arguments)}return n}(),i._ensureEdgeLocations=function(){var t=e._asyncToGenerator((function*(e,t){const o=[];if(this._components.forEachNeighbor((e=>{if(n.isNone(e.info)){const{id:t,uid:n}=e;o.push({id:t,uid:n})}return!0}),e.bounds),!o.length)return;const i={components:o},s=yield this.remoteClient.invoke("fetchAllEdgeLocations",i,n.unwrapOr(t,{}));for(const n of s.components)this._setFetchEdgeLocations(n)}));function o(e,n){return t.apply(this,arguments)}return o}(),i.add=function(){var t=e._asyncToGenerator((function*(e){const t=new C(e.id,e.bounds);return this._idToComponent.set(t.id,t),this._components.add([t]),{result:{}}}));function n(e){return t.apply(this,arguments)}return n}(),i.remove=function(){var t=e._asyncToGenerator((function*(e){const t=this._idToComponent.get(e.id);if(t){const e=[];this._edges.forEachNeighbor((n=>(n.component===t&&e.push(n),!0)),t.bounds),this._edges.remove(e),this._components.remove([t]),this._idToComponent.delete(t.id)}return{result:{}}}));function n(e){return t.apply(this,arguments)}return n}(),i._setFetchEdgeLocations=function(e){const t=this._idToComponent.get(e.id);if(n.isNone(t)||e.uid!==t.uid)return;const o=_.extractComponentsEdgeLocationsLayout.createView(e.locations),i=new Array(o.count),s=p.create(),r=p.create();for(let n=0;n<o.count;n++){o.position0.getVec(n,s),o.position1.getVec(n,r);const c=m.boundsFromEdge(s,r,e.origin),d=new E(t,n,c);i[n]=d}this._edges.add(i);const{objectIds:c,origin:d}=e;t.info={locations:o,objectIds:c,origin:d}},i._addCandidates=function(e,t,n){const{locations:o,origin:i,objectIds:s}=t.component.info,r=o.position0.getVec(t.index,this._tmpP1),c=o.position1.getVec(t.index,this._tmpP2);u.add(r,r,i),u.add(c,c,i);const d=s[o.componentIndex.get(t.index)];this._addEdgeCandidate(e,d,r,c,n),this._addVertexCandidate(e,d,r,n),this._addVertexCandidate(e,d,c,n)},i._addEdgeCandidate=function(e,t,n,o,i){if(!(e.types&l.SnappingTypes.EDGE))return;const s=g.getCenter(e.bounds),r=h.fromPoints(n,o,this._tmpLineSegment),c=h.projectPoint(r,s,this._tmpP3);if(!g.containsPoint(e.bounds,c))return null;i.push({type:"edge",objectId:t,target:p.clone(c),distance:u.distance(s,c),start:p.clone(n),end:p.clone(o)})},i._addVertexCandidate=function(e,t,n,o){if(!(e.types&l.SnappingTypes.VERTEX))return;const i=g.getCenter(e.bounds);if(!g.containsPoint(e.bounds,n))return null;o.push({type:"vertex",objectId:t,target:p.clone(n),distance:u.distance(i,n)})},t}();b=t.__decorate([a.subclass("esri.views.interactive.snapping.featureSources.sceneLayerSource.SceneLayerSnappingSourceWorker")],b);const y=b;let C=function e(t,n){this.id=t,this.bounds=n,this.info=null,this.uid=++e.uid};C.uid=0;let E=function(e,t,n){this.component=e,this.index=t,this.bounds=n};return y}));
