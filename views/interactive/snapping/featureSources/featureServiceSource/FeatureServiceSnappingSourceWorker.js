/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../core/Evented","../../../../../core/Handles","../../../../../core/maybe","../../../../../core/promiseUtils","../../../../../core/reactiveUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/arrayUtils","../../../../../core/accessorSupport/ensureType","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/support/WatchUpdatingTracking","../../../../../geometry/SpatialReference","../../../../../layers/graphics/data/FeatureStore","../../../../../layers/graphics/data/QueryEngine","../../../../../layers/support/TileInfo","../../../../../layers/support/TimeInfo","../../../../../rest/support/Query","../../../../../symbols/support/ElevationInfo","../snappingCandidateElevationAlignment","../snappingCandidateElevationFilter","../symbologySnappingCandidates","./FeatureServiceTiledFetcher","./FeatureServiceTileStore"],(function(e,t,n,i,r,a,o,s,u,l,c,d,p,f,h,g,y,_,S,v,m,I,F,b){"use strict";let w=function(t){function n(){var n;return(n=t.apply(this,arguments)||this)._isInitializing=!0,n.remoteClient=null,n._whenSetup=a.createDeferred(),n._elevationAligner=v.getSnappingCandidateElevationAligner(),n._elevationFilter=m.getSnappingCandidateElevationFilter(),n._symbologyCandidatesFetcher=I.getSymbologySnappingCandidatesFetcher(),n._handles=new i,n._updatingHandles=new d.WatchUpdatingTracking,n._editsUpdatingHandles=new d.WatchUpdatingTracking,n._pendingApplyEdits=new Map,n._alignPointsInFeatures=function(){var t=e._asyncToGenerator((function*(e,t){const i={points:e},r=yield n.remoteClient.invoke("alignElevation",i,{signal:t});return a.throwIfAborted(t),r}));return function(e,n){return t.apply(this,arguments)}}(),n._getSymbologyCandidates=function(){var t=e._asyncToGenerator((function*(e,t){const i={candidates:e,spatialReference:n._spatialReference.toJSON()},r=yield n.remoteClient.invoke("getSymbologyCandidates",i,{signal:t});return a.throwIfAborted(t),r}));return function(e,n){return t.apply(this,arguments)}}(),n}e._inheritsLoose(n,t);var s=n.prototype;return s.destroy=function(){this._featureFetcher.destroy(),this._queryEngine.destroy(),this._featureStore.clear(),this._handles.destroy()},s.setup=function(){var t=e._asyncToGenerator((function*(e){const{geometryType:t,objectIdField:n,timeInfo:i,fields:a}=e.serviceInfo,{hasZ:s}=e,u=p.fromJSON(e.spatialReference);this._spatialReference=u,this._featureStore=new f({...e.serviceInfo,hasZ:s,hasM:!1}),this._queryEngine=new h.QueryEngine({spatialReference:e.spatialReference,featureStore:this._featureStore,geometryType:t,fields:a,hasZ:s,hasM:!1,objectIdField:n,timeInfo:i?y.fromJSON(i):null}),this._featureFetcher=new F.FeatureServiceTiledFetcher({store:new b.FeatureServiceTileStore({featureStore:this._featureStore}),url:e.serviceInfo.url,objectIdField:e.serviceInfo.objectIdField,globalIdField:e.serviceInfo.globalIdField,capabilities:e.serviceInfo.capabilities,spatialReference:u,sourceSpatialReference:p.fromJSON(e.serviceInfo.spatialReference)});const l="3d"===e.configuration.viewType;return this._elevationAligner=v.getSnappingCandidateElevationAligner(l,{elevationInfo:r.isSome(e.elevationInfo)?S.fromJSON(e.elevationInfo):null,alignPointsInFeatures:this._alignPointsInFeatures,spatialReference:u}),this._elevationFilter=m.getSnappingCandidateElevationFilter(l),this._handles.add([o.watch((()=>this._featureFetcher.availability),(e=>this.emit("notify-availability",{availability:e})),o.sync),o.watch((()=>this.updating),(()=>this._notifyUpdating()))]),this._whenSetup.resolve(),this._isInitializing=!1,this.configure(e.configuration)}));function n(e){return t.apply(this,arguments)}return n}(),s.configure=function(){var t=e._asyncToGenerator((function*(e){return yield this._updatingHandles.addPromise(this._whenSetup.promise),this._updateFeatureFetcherConfiguration(e),{result:{}}}));function n(e){return t.apply(this,arguments)}return n}(),s.fetchCandidates=function(){var t=e._asyncToGenerator((function*(e,t){yield this._whenSetup.promise,a.throwIfAborted(t);const n=E(e),i=r.isSome(t)?t.signal:null,o=yield this._queryEngine.executeQueryForSnapping(n,i);a.throwIfAborted(i);const s=yield this._elevationAligner.alignCandidates(o.candidates,i);a.throwIfAborted(i);const u=yield this._symbologyCandidatesFetcher.fetch(s,i);a.throwIfAborted(i);const l=0===u.length?s:s.concat(u);return{result:{candidates:this._elevationFilter.filter(n,l)}}}));function n(e,n){return t.apply(this,arguments)}return n}(),s.updateTiles=function(){var t=e._asyncToGenerator((function*(e,t){return yield this._updatingHandles.addPromise(this._whenSetup.promise),a.throwIfAborted(t),this._featureFetcher.tileSize=e.tileSize,this._featureFetcher.tilesOfInterest=e.tiles,this._featureFetcher.tileInfo=r.isSome(e.tileInfo)?g.fromJSON(e.tileInfo):null,T}));function n(e,n){return t.apply(this,arguments)}return n}(),s.refresh=function(){var t=e._asyncToGenerator((function*(e,t){return yield this._updatingHandles.addPromise(this._whenSetup.promise),a.throwIfAborted(t),this._featureFetcher.refresh(),T}));function n(e,n){return t.apply(this,arguments)}return n}(),s.whenNotUpdating=function(){var t=e._asyncToGenerator((function*(e,t){return yield this._updatingHandles.addPromise(this._whenSetup.promise),a.throwIfAborted(t),yield o.whenOnce((()=>!this.updatingExcludingEdits),t),a.throwIfAborted(t),T}));function n(e,n){return t.apply(this,arguments)}return n}(),s.getDebugInfo=function(){var t=e._asyncToGenerator((function*(e,t){return a.throwIfAborted(t),{result:this._featureFetcher.debugInfo}}));function n(e,n){return t.apply(this,arguments)}return n}(),s.beginApplyEdits=function(){var t=e._asyncToGenerator((function*(e,t){this._updatingHandles.addPromise(this._whenSetup.promise),a.throwIfAborted(t);const n=a.createDeferred();return this._pendingApplyEdits.set(e.id,n),this._featureFetcher.applyEdits(n.promise),this._editsUpdatingHandles.addPromise(n.promise),T}));function n(e,n){return t.apply(this,arguments)}return n}(),s.endApplyEdits=function(){var t=e._asyncToGenerator((function*(e,t){const n=this._pendingApplyEdits.get(e.id);return n&&n.resolve(e.edits),a.throwIfAborted(t),T}));function n(e,n){return t.apply(this,arguments)}return n}(),s.notifyElevationSourceChange=function(){var t=e._asyncToGenerator((function*(e,t){return this._elevationAligner.notifyElevationSourceChange(),T}));function n(e,n){return t.apply(this,arguments)}return n}(),s.notifySymbologyChange=function(){var t=e._asyncToGenerator((function*(e,t){return T}));function n(e,n){return t.apply(this,arguments)}return n}(),s.setSymbologySnappingSupported=function(){var t=e._asyncToGenerator((function*(e){return this._symbologyCandidatesFetcher=I.getSymbologySnappingCandidatesFetcher(e,this._getSymbologyCandidates),T}));function n(e){return t.apply(this,arguments)}return n}(),s._updateFeatureFetcherConfiguration=function(e){this._featureFetcher.filter=r.isSome(e.filter)?_.fromJSON(e.filter):null,this._featureFetcher.customParameters=e.customParameters},s._notifyUpdating=function(){this.emit("notify-updating",{updating:this.updating})},e._createClass(n,[{key:"updating",get:function(){return this.updatingExcludingEdits||this._editsUpdatingHandles.updating||this._featureFetcher.updating}},{key:"updatingExcludingEdits",get:function(){return this._featureFetcher.updatingExcludingEdits||this._isInitializing||this._updatingHandles.updating}}]),n}(n.EventedAccessor);t.__decorate([s.property({readOnly:!0})],w.prototype,"updating",null),t.__decorate([s.property({readOnly:!0})],w.prototype,"updatingExcludingEdits",null),t.__decorate([s.property()],w.prototype,"_isInitializing",void 0),w=t.__decorate([c.subclass("esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceSnappingSourceWorker")],w);function E(e){return{point:e.point,distance:e.distance,types:e.types,query:r.isSome(e.filter)?e.filter:{where:"1=1"}}}const T={result:{}};return w}));
