/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/has","../../../../core/maybe","../../../../core/Logger","../../../../core/accessorSupport/ensureType","../../../../core/handleUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/decorators/subclass","../../../../core/urlUtils","../../../../core/uuid","../../../../portal/support/resourceExtension","../../../../core/accessorSupport/trackingUtils","../../../../core/Accessor","../../../../geometry/Point","../../../../core/watchUtils","../../../support/debugFlags","../../../../core/HandleOwner","./queryEngineUtils","../../../2d/interactive/snapping/featureSources/featureServiceSource/FeatureServiceTiles2D","../../../3d/interactive/snapping/featureSources/featureServiceSource/FeatureServiceTiles3D","./WorkerTileTreeDebugger","./featureServiceSource/FeatureServiceSnappingSourceWorkerHandle","./featureServiceSource/FeatureServiceTilesSimple"],(function(e,r,t,i,a,n,s,o,c,l,u,p,d,S,h,y,g,v,f,w,_,k,H,F,b){"use strict";e.FeatureServiceSnappingSource=function(e){function t(r){return e.call(this,r)||this}r._inheritsLoose(t,e);var i=t.prototype;return i.initialize=function(){if(a.isSome(this.view))switch(this.view.type){case"2d":this.tilesOfInterest=new _.FeatureServiceTiles2D({view:this.view,layer:this.layer});break;case"3d":this.tilesOfInterest=new k.FeatureServiceTiles3D({view:this.view})}else this.tilesOfInterest=new b.FeatureServiceTilesSimple({layer:this.layer});if(this.workerHandle=new F.FeatureServiceSnappingSourceWorkerHandle({scheduler:a.isSome(this.view)&&"3d"===this.view.type?this.view.resourceController.scheduler:null}),this.handles.add([o.destroyHandle(this.workerHandle)]),this.workerHandle.setup({layer:this.layer,spatialReference:this.spatialReference,configuration:this.configuration},null),this.updatingHandles.add(this,"updateTilesParameters",(()=>this.workerHandle.updateTiles(this.updateTilesParameters,null)),2),this.handles.add([S.reaction((()=>this.configuration),(e=>this.workerHandle.configure(e,null)))]),a.isSome(this.view)){const e=this.view;this.handles.add(g.init(v,"FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES",(r=>{r&&!this.debug?(this.debug=new H.WorkerTileTreeDebugger({view:e,handle:this.workerHandle}),this.handles.add(o.destroyHandle(this.debug),"debug")):!r&&this.debug&&this.handles.remove("debug")})))}this.handles.add(this.layerSource.layer.on("apply-edits",(e=>{this.workerHandle.applyEdits(e,null)})))},i.refresh=function(){this.workerHandle.refresh(null)},i.fetchCandidates=async function(e,r){this.tilesOfInterest.pointOfInterest=e.coordinateHelper.toPoint(e.point,new y);const{candidates:t}=await this.workerHandle.fetchCandidates({...e,filter:null},r);return{candidates:t.map((r=>w.convertSnappingCandidate(r,e.coordinateHelper)))}},i.getDebugInfo=function(e){return this.workerHandle.getDebugInfo(e)},r._createClass(t,[{key:"updateTilesParameters",get:function(){return{tiles:this.tilesOfInterest.tiles,tileInfo:this.tilesOfInterest.tileInfo,tileSize:this.tilesOfInterest.tileSize}}},{key:"updating",get:function(){return this.workerHandle.updating||this.updatingHandles.updating}},{key:"configuration",get:function(){return{filter:this.layer.createQuery(),customParameters:this.layer.customParameters}}},{key:"availability",get:function(){return this.workerHandle.availability}},{key:"layer",get:function(){return this.layerSource.layer}}]),t}(f.HandleOwnerMixin(h)),t.__decorate([c.property({constructOnly:!0})],e.FeatureServiceSnappingSource.prototype,"spatialReference",void 0),t.__decorate([c.property({constructOnly:!0})],e.FeatureServiceSnappingSource.prototype,"layerSource",void 0),t.__decorate([c.property({constructOnly:!0})],e.FeatureServiceSnappingSource.prototype,"view",void 0),t.__decorate([c.property()],e.FeatureServiceSnappingSource.prototype,"tilesOfInterest",void 0),t.__decorate([c.property({readOnly:!0})],e.FeatureServiceSnappingSource.prototype,"updateTilesParameters",null),t.__decorate([c.property({readOnly:!0})],e.FeatureServiceSnappingSource.prototype,"updating",null),t.__decorate([c.property({readOnly:!0})],e.FeatureServiceSnappingSource.prototype,"configuration",null),t.__decorate([c.property({readOnly:!0})],e.FeatureServiceSnappingSource.prototype,"availability",null),e.FeatureServiceSnappingSource=t.__decorate([l.subclass("esri.views.interactive.snapping.featureSources.FeatureServiceSnappingSource")],e.FeatureServiceSnappingSource),Object.defineProperty(e,"__esModule",{value:!0})}));
