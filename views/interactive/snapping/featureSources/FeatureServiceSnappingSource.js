/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/HandleOwner","../../../../core/handleUtils","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/accessorSupport/decorators/subclass","../../../../core/accessorSupport/tracking/ObservableValue","../../../../support/elevationInfoUtils","../../../2d/interactive/snapping/featureSources/featureServiceSource/FeatureServiceTiles2D","../../../3d/interactive/snapping/featureSources/featureServiceSource/FeatureServiceTiles3D","./queryEngineUtils","./WorkerTileTreeDebugger","./featureServiceSource/FeatureServiceSnappingSourceWorkerHandle","./featureServiceSource/FeatureServiceTilesSimple","../../../support/debugFlags"],(function(e,r,t,n,i,o,a,s,l,u,c,p,d,S,y,g,h,v,_,f,b,w){"use strict";e.FeatureServiceSnappingSource=function(e){function t(r){var t;return(t=e.call(this,r)||this)._workerHandle=null,t._debug=null,t}r._inheritsLoose(t,e);var n=t.prototype;return n.initialize=function(){let e;const t=this.view;if(a.isSome(t))switch(t.type){case"2d":this._tilesOfInterest=new g.FeatureServiceTiles2D({view:t,layer:this._layer}),e=this._workerHandle=new f.FeatureServiceSnappingSourceWorkerHandle;break;case"3d":{const{resourceController:o}=t,u=this._layer,c=t.whenLayerView(u);this._tilesOfInterest=new h.FeatureServiceTiles3D({view:t}),e=this._workerHandle=new f.FeatureServiceSnappingSourceWorkerHandle({schedule:e=>o.immediate.schedule(e),hasZ:this._layer.hasZ&&(this._layer.returnZ??!0),elevationAlignPointsInFeatures:(i=r._asyncToGenerator((function*(e,r){const t=yield c;return s.throwIfAborted(r),t.elevationAlignPointsInFeatures(e,r)})),function(e,r){return i.apply(this,arguments)}),queryForSymbologySnapping:(n=r._asyncToGenerator((function*(e,r){const t=yield c;return s.throwIfAborted(r),t.queryForSymbologySnapping(e,r)})),function(e,r){return n.apply(this,arguments)})});const p=new S.ObservableValue(null);c.then((e=>p.set(e))),this.addHandles([t.elevationProvider.on("elevation-change",(({context:r})=>{const{elevationInfo:t}=u;y.elevationContextAffectsAlignment(r,t)&&s.ignoreAbortErrors(e.notifyElevationSourceChange())})),l.watch((()=>u.elevationInfo),(()=>s.ignoreAbortErrors(e.notifyElevationSourceChange())),l.initial),l.watch((()=>a.applySome(p.get(),(({processor:e})=>e?.renderer))),(()=>s.ignoreAbortErrors(e.notifySymbologyChange())),l.initial),l.watch((()=>a.mapOr(p.get(),!1,(e=>e.symbologySnappingSupported))),(r=>s.ignoreAbortErrors(e.setSymbologySnappingSupported(r))),l.initial),l.on((()=>a.toNullable(p.get())?.layer),["edits","apply-edits","graphic-update"],(()=>e.notifySymbologyChange()))]);break}}else this._tilesOfInterest=new b.FeatureServiceTilesSimple({layer:this._layer}),e=this._workerHandle=new f.FeatureServiceSnappingSourceWorkerHandle;var n,i;this.handles.add([o.destroyHandle(e)]),s.ignoreAbortErrors(e.setup({layer:this._layer,spatialReference:this.spatialReference,configuration:this.configuration},null)),this.updatingHandles.add((()=>this._updateTilesParameters),(()=>s.ignoreAbortErrors(e.updateTiles(this._updateTilesParameters,null))),l.initial),this.handles.add([l.watch((()=>this.configuration),(r=>s.ignoreAbortErrors(e.configure(r,null))),l.sync)]),a.isSome(t)&&this.handles.add(l.watch((()=>w.FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES),(r=>{r&&!this._debug?(this._debug=new _.WorkerTileTreeDebugger({view:t,handle:e}),this.handles.add(o.destroyHandle(this._debug),"debug")):!r&&this._debug&&this.handles.remove("debug")}),l.initial)),this.handles.add(this.layerSource.layer.on("apply-edits",(r=>{s.ignoreAbortErrors(e.applyEdits(r,null))})))},n.refresh=function(){this._workerHandle?.refresh(null)},n.fetchCandidates=function(){var e=r._asyncToGenerator((function*(e,r){const{coordinateHelper:t,point:n}=e;this._tilesOfInterest.pointOfInterest=t.arrayToPoint(n);const i=this._getGroundElevation;return(yield this._workerHandle.fetchCandidates({...e},r)).candidates.map((e=>v.convertSnappingCandidate(e,i)))}));function t(r,t){return e.apply(this,arguments)}return t}(),n.getDebugInfo=function(e){return this._workerHandle.getDebugInfo(e)},r._createClass(t,[{key:"_updateTilesParameters",get:function(){return{tiles:this._tilesOfInterest.tiles,tileInfo:this._tilesOfInterest.tileInfo,tileSize:this._tilesOfInterest.tileSize}}},{key:"updating",get:function(){return this._workerHandle?.updating||this.updatingHandles.updating}},{key:"configuration",get:function(){const{view:e}=this,r=a.isSome(e)?e.type:"2d";return{filter:this._layer.createQuery(),customParameters:this._layer.customParameters,viewType:r}}},{key:"availability",get:function(){return this._workerHandle?.availability??0}},{key:"_layer",get:function(){return this.layerSource.layer}},{key:"_getGroundElevation",get:function(){return v.makeGetGroundElevation(this.view)}}]),t}(i.HandleOwnerMixin(n)),t.__decorate([u.property({constructOnly:!0})],e.FeatureServiceSnappingSource.prototype,"spatialReference",void 0),t.__decorate([u.property({constructOnly:!0})],e.FeatureServiceSnappingSource.prototype,"layerSource",void 0),t.__decorate([u.property({constructOnly:!0})],e.FeatureServiceSnappingSource.prototype,"view",void 0),t.__decorate([u.property()],e.FeatureServiceSnappingSource.prototype,"_tilesOfInterest",void 0),t.__decorate([u.property({readOnly:!0})],e.FeatureServiceSnappingSource.prototype,"_updateTilesParameters",null),t.__decorate([u.property({readOnly:!0})],e.FeatureServiceSnappingSource.prototype,"updating",null),t.__decorate([u.property({readOnly:!0})],e.FeatureServiceSnappingSource.prototype,"configuration",null),t.__decorate([u.property({readOnly:!0})],e.FeatureServiceSnappingSource.prototype,"availability",null),t.__decorate([u.property()],e.FeatureServiceSnappingSource.prototype,"_getGroundElevation",null),e.FeatureServiceSnappingSource=t.__decorate([d.subclass("esri.views.interactive.snapping.featureSources.FeatureServiceSnappingSource")],e.FeatureServiceSnappingSource),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
