/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/HandleOwner","../../../../core/handleUtils","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/arrayUtils","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","../../../../core/accessorSupport/tracking/ObservableValue","../../../../support/elevationInfoUtils","../../../2d/interactive/snapping/featureSources/featureServiceSource/FeatureServiceTiles2D","../../../3d/interactive/snapping/featureSources/featureServiceSource/FeatureServiceTiles3D","./queryEngineUtils","./WorkerTileTreeDebugger","./featureServiceSource/FeatureServiceSnappingSourceWorkerHandle","./featureServiceSource/FeatureServiceTilesSimple","../../../support/debugFlags"],(function(e,r,t,n,i,a,o,s,l,u,c,p,d,S,h,y,g,_,v,f,w,k){"use strict";e.FeatureServiceSnappingSource=function(e){function t(r){return e.call(this,r)||this}r._inheritsLoose(t,e);var n=t.prototype;return n.initialize=function(){const e=this.view;if(o.isSome(e))switch(e.type){case"2d":this._tilesOfInterest=new y.FeatureServiceTiles2D({view:e,layer:this._layer}),this._workerHandle=new f.FeatureServiceSnappingSourceWorkerHandle;break;case"3d":{const{resourceController:i}=e,a=this._layer,u=e.whenLayerView(a);this._tilesOfInterest=new g.FeatureServiceTiles3D({view:e}),this._workerHandle=new f.FeatureServiceSnappingSourceWorkerHandle({schedule:e=>i.schedule(e),hasZ:this._layer.hasZ&&(this._layer.returnZ??!0),elevationAlignPointsInFeatures:(n=r._asyncToGenerator((function*(e,r){const t=yield u;return s.throwIfAborted(r),t.elevationAlignPointsInFeatures(e,r)})),function(e,r){return n.apply(this,arguments)}),queryForSymbologySnapping:(t=r._asyncToGenerator((function*(e,r){const t=yield u;return s.throwIfAborted(r),t.queryForSymbologySnapping(e,r)})),function(e,r){return t.apply(this,arguments)})});const c=new S.ObservableValue(null);u.then((e=>c.set(e))),this.addHandles([e.elevationProvider.on("elevation-change",(({context:e})=>{const{elevationInfo:r}=a;h.elevationContextAffectsAlignment(e,r)&&this._workerHandle?.notifyElevationSourceChange()})),l.watch((()=>a.elevationInfo),(()=>this._workerHandle?.notifyElevationSourceChange()),l.initial),l.watch((()=>o.applySome(c.get(),(({processor:e})=>e?.renderer))),(()=>this._workerHandle?.notifySymbologyChange()),l.initial),l.watch((()=>o.mapOr(c.get(),!1,(e=>e.symbologySnappingSupported))),(e=>this._workerHandle?.setSymbologySnappingSupported(e)),l.initial)]);break}}else this._tilesOfInterest=new w.FeatureServiceTilesSimple({layer:this._layer}),this._workerHandle=new f.FeatureServiceSnappingSourceWorkerHandle;var t,n;this.handles.add([a.destroyHandle(this._workerHandle)]),this._workerHandle.setup({layer:this._layer,spatialReference:this.spatialReference,configuration:this.configuration},null),this.updatingHandles.add((()=>this._updateTilesParameters),(()=>this._workerHandle.updateTiles(this._updateTilesParameters,null)),l.initial),this.handles.add([l.watch((()=>this.configuration),(e=>this._workerHandle.configure(e,null)),l.sync)]),o.isSome(e)&&this.handles.add(l.watch((()=>k.FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES),(r=>{r&&!this._debug?(this._debug=new v.WorkerTileTreeDebugger({view:e,handle:this._workerHandle}),this.handles.add(a.destroyHandle(this._debug),"debug")):!r&&this._debug&&this.handles.remove("debug")}),l.initial)),this.handles.add(this.layerSource.layer.on("apply-edits",(e=>{this._workerHandle.applyEdits(e,null)})))},n.refresh=function(){this._workerHandle.refresh(null)},n.fetchCandidates=function(){var e=r._asyncToGenerator((function*(e,r){const{coordinateHelper:t,elevationInfo:n,point:i}=e;this._tilesOfInterest.pointOfInterest=t.vectorToPoint(i);const a=t.hasZ()?h.absoluteHeightElevationInfo:n,o=this._getGroundElevation;return(yield this._workerHandle.fetchCandidates({...e},r)).candidates.map((e=>_.convertSnappingCandidate(e,t,a,o)))}));function t(r,t){return e.apply(this,arguments)}return t}(),n.getDebugInfo=function(e){return this._workerHandle.getDebugInfo(e)},r._createClass(t,[{key:"_updateTilesParameters",get:function(){return{tiles:this._tilesOfInterest.tiles,tileInfo:this._tilesOfInterest.tileInfo,tileSize:this._tilesOfInterest.tileSize}}},{key:"updating",get:function(){return this._workerHandle.updating||this.updatingHandles.updating}},{key:"configuration",get:function(){const{view:e}=this,r=o.isSome(e)?e.type:"2d";return{filter:this._layer.createQuery(),customParameters:this._layer.customParameters,viewType:r}}},{key:"availability",get:function(){return this._workerHandle.availability}},{key:"_layer",get:function(){return this.layerSource.layer}},{key:"_getGroundElevation",get:function(){return _.makeGetGroundElevation(this.view)}}]),t}(i.HandleOwnerMixin(n)),t.__decorate([u.property({constructOnly:!0})],e.FeatureServiceSnappingSource.prototype,"spatialReference",void 0),t.__decorate([u.property({constructOnly:!0})],e.FeatureServiceSnappingSource.prototype,"layerSource",void 0),t.__decorate([u.property({constructOnly:!0})],e.FeatureServiceSnappingSource.prototype,"view",void 0),t.__decorate([u.property()],e.FeatureServiceSnappingSource.prototype,"_tilesOfInterest",void 0),t.__decorate([u.property({readOnly:!0})],e.FeatureServiceSnappingSource.prototype,"_updateTilesParameters",null),t.__decorate([u.property({readOnly:!0})],e.FeatureServiceSnappingSource.prototype,"updating",null),t.__decorate([u.property({readOnly:!0})],e.FeatureServiceSnappingSource.prototype,"configuration",null),t.__decorate([u.property({readOnly:!0})],e.FeatureServiceSnappingSource.prototype,"availability",null),t.__decorate([u.property()],e.FeatureServiceSnappingSource.prototype,"_getGroundElevation",null),e.FeatureServiceSnappingSource=t.__decorate([d.subclass("esri.views.interactive.snapping.featureSources.FeatureServiceSnappingSource")],e.FeatureServiceSnappingSource),Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
