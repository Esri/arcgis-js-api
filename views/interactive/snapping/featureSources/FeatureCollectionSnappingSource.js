/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/arrayUtils","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","../../../../support/elevationInfoUtils","../snappingUtils","./queryEngineUtils","./snappingCandidateElevationAlignment","./snappingCandidateElevationFilter","./symbologySnappingCandidates"],(function(e,t,n,o,i,r,a,p,l,s,c,u,y,g,d,S,h){"use strict";e.FeatureCollectionSnappingSource=function(e){function n(t){var n;return(n=e.call(this,t)||this).view=null,n._layerView3D=null,n}t._inheritsLoose(n,e);var o=n.prototype;return o.initialize=function(){const{view:e}=this,{layer:t}=this.layerSource;i.isSome(e)&&"3d"===e.type&&"subtype-group"!==t.type&&(e.whenLayerView(t).then((e=>this._layerView3D=e)),this.addHandles([e.elevationProvider.on("elevation-change",(({context:e})=>{const{elevationInfo:n}=t;u.elevationContextAffectsAlignment(e,n)&&this._snappingElevationAligner.notifyElevationSourceChange()})),a.watch((()=>t.elevationInfo),(()=>this._snappingElevationAligner.notifyElevationSourceChange()),a.initial),a.watch((()=>i.isSome(this._layerView3D)?this._layerView3D.processor?.renderer:null),(()=>this._symbologySnappingFetcher.notifySymbologyChange()),a.initial)]))},o.refresh=function(){},o.fetchCandidates=function(){var e=t._asyncToGenerator((function*(e,t){const{layer:n}=this.layerSource,{coordinateHelper:o,elevationInfo:i}=e,a=n.source;if(!a.querySnapping)return[];const p=y.makeFilter(n),l=y.makeSnappingQuery(e,p),s=yield a.querySnapping(l,{signal:t});r.throwIfAborted(t);const c=yield this._snappingElevationAligner.alignCandidates(s.candidates,t);r.throwIfAborted(t);const d=yield this._symbologySnappingFetcher.fetch(c,t);r.throwIfAborted(t);const S=0===d.length?c:[...c,...d],h=this._snappingElevationFilter.filter(l,S),v=o.hasZ()?u.absoluteHeightElevationInfo:i,_=this._getGroundElevation;return h.map((e=>g.convertSnappingCandidate(e,o,v,_)))}));function n(t,n){return e.apply(this,arguments)}return n}(),t._createClass(n,[{key:"availability",get:function(){return 1}},{key:"updating",get:function(){return this.layerSource.updating}},{key:"_snappingElevationAligner",get:function(){const{view:e}=this,{layer:n}=this.layerSource,o=i.isSome(e)&&"3d"===e.type;if(!o||"subtype-group"===n.type)return d.getSnappingCandidateElevationAligner();const a=function(){var o=t._asyncToGenerator((function*(t,o){return(yield r.whenOrAbort(e.whenLayerView(n),o)).elevationAlignPointsInFeatures(t,o)}));return function(e,t){return o.apply(this,arguments)}}();return d.getSnappingCandidateElevationAligner(o,{elevationInfo:n.elevationInfo,alignPointsInFeatures:a,spatialReference:e.spatialReference})}},{key:"_snappingElevationFilter",get:function(){const{view:e}=this,t=i.isSome(e)&&"3d"===e.type&&"subtype-group"!==this.layerSource.layer.type;return S.getSnappingCandidateElevationFilter(t)}},{key:"_symbologySnappingFetcher",get:function(){const{view:e}=this,{layer:n}=this.layerSource;return i.isSome(e)&&"3d"===e.type&&"subtype-group"!==n.type?h.getSymbologySnappingCandidatesFetcher(this._symbologySnappingSupported,function(){var o=t._asyncToGenerator((function*(t,o){const i=yield e.whenLayerView(n);return r.throwIfAborted(o),i.queryForSymbologySnapping({candidates:t,spatialReference:e.spatialReference},o)}));return function(e,t){return o.apply(this,arguments)}}()):h.getSymbologySnappingCandidatesFetcher()}},{key:"_symbologySnappingSupported",get:function(){return i.isSome(this._layerView3D)&&this._layerView3D.symbologySnappingSupported}},{key:"_getGroundElevation",get:function(){return g.makeGetGroundElevation(this.view)}}]),n}(o),n.__decorate([p.property({constructOnly:!0})],e.FeatureCollectionSnappingSource.prototype,"layerSource",void 0),n.__decorate([p.property({constructOnly:!0})],e.FeatureCollectionSnappingSource.prototype,"view",void 0),n.__decorate([p.property()],e.FeatureCollectionSnappingSource.prototype,"_snappingElevationAligner",null),n.__decorate([p.property()],e.FeatureCollectionSnappingSource.prototype,"_snappingElevationFilter",null),n.__decorate([p.property()],e.FeatureCollectionSnappingSource.prototype,"_symbologySnappingFetcher",null),n.__decorate([p.property()],e.FeatureCollectionSnappingSource.prototype,"_layerView3D",void 0),n.__decorate([p.property()],e.FeatureCollectionSnappingSource.prototype,"_symbologySnappingSupported",null),n.__decorate([p.property()],e.FeatureCollectionSnappingSource.prototype,"_getGroundElevation",null),e.FeatureCollectionSnappingSource=n.__decorate([c.subclass("esri.views.interactive.snapping.featureSources.FeatureCollectionSnappingSource")],e.FeatureCollectionSnappingSource),Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
