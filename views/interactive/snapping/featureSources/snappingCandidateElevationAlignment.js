/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/has","../../../../core/LRUCache","../../../../core/MapUtils","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/unitUtils","../../../../symbols/support/unitConversionUtils"],(function(e,t,n,o,i,s,r,a,c){"use strict";function u(e=!1,t){if(e){const{elevationInfo:e,alignPointsInFeatures:n,spatialReference:o}=t;return new f(e,n,o)}return new l}let l=function(){function e(){}var n=e.prototype;return n.alignCandidates=function(){var e=t._asyncToGenerator((function*(e,t){return e}));function n(t,n){return e.apply(this,arguments)}return n}(),n.notifyElevationSourceChange=function(){},e}();const h=1024;let f=function(){function e(e,t,n){this._elevationInfo=e,this._alignPointsInFeatures=t,this.spatialReference=n,this._alignmentsCache=new o(h),this._cacheVersion=0,this._metersPerVerticalUnit=a.getMetersPerVerticalUnitForSR(n)}var n=e.prototype;return n.alignCandidates=function(){var e=t._asyncToGenerator((function*(e,t){const n=this._elevationInfo;return s.isSome(n)&&"absolute-height"===n.mode&&!n.featureExpressionInfo?(this._alignAbsoluteElevationCandidates(e,n),e):this._alignComputedElevationCandidates(e,t)}));function n(t,n){return e.apply(this,arguments)}return n}(),n.notifyElevationSourceChange=function(){this._alignmentsCache.clear(),this._cacheVersion++},n._alignAbsoluteElevationCandidates=function(e,t){const{offset:n,unit:o}=t;if(s.isNone(n))return;const i=o??"meters",r=n*(c.getMetersPerUnit(i)/this._metersPerVerticalUnit);for(const s of e)switch(s.type){case"edge":s.start.z+=r,s.end.z+=r;continue;case"vertex":s.target.z+=r;continue}},n._alignComputedElevationCandidates=function(){var e=t._asyncToGenerator((function*(e,t){const n=new Map;for(const r of e)i.getOrCreateMapValue(n,r.objectId,g).push(r);const[o,s,a]=this._prepareQuery(n),c=yield this._alignPointsInFeatures(o,t);r.throwIfAborted(t);if(a!==this._cacheVersion)return this._alignComputedElevationCandidates(e,t);this._applyCacheAndResponse(o,c,s);const{drapedObjectIds:u,failedObjectIds:l}=c,h=[];for(const i of e){const{objectId:e}=i;u.has(e)&&"edge"===i.type&&(i.draped=!0),l.has(e)||h.push(i)}return h}));function n(t,n){return e.apply(this,arguments)}return n}(),n._prepareQuery=function(e){const t=[],n=[];for(const[o,i]of e){const e=[];for(const t of i)this._addToQueriesOrCachedResult(o,t.target,e,n),"edge"===t.type&&(this._addToQueriesOrCachedResult(o,t.start,e,n),this._addToQueriesOrCachedResult(o,t.end,e,n));0!==e.length&&t.push({objectId:o,points:e})}return[t,n,this._cacheVersion]},n._addToQueriesOrCachedResult=function(e,t,n,o){const i=p(e,t),r=this._alignmentsCache.get(i);s.isSome(r)?o.push(new d(t,r)):n.push(t)},n._applyCacheAndResponse=function(e,{elevations:t,drapedObjectIds:n,failedObjectIds:o},i){for(const a of i)a.apply();let s=0;const r=this._alignmentsCache;for(const{objectId:a,points:c}of e){if(o.has(a)){s+=c.length;continue}const e=!n.has(a);for(const n of c){const o=p(a,n),i=t[s++];n.z=i,e&&r.put(o,i,1)}}},e}(),d=function(){function e(e,t){this.point=e,this.z=t}return e.prototype.apply=function(){this.point.z=this.z},e}();function p(e,{x:t,y:n,z:o}){return`${e}-${t}-${n}-${o??0}}`}function g(){return[]}e.getSnappingCandidateElevationAligner=u,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
