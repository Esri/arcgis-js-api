/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["require","exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/HandleOwner","../../../core/Handles","../../../core/MapUtils","../../../core/maybe","../../../core/promiseUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/accessorSupport/ensureType","../../../core/Logger","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec3f64","./SnappingConstraint","./snappingUtils","./candidates/EdgeSnappingCandidate","./candidates/FeatureSnappingCandidate","./candidates/RightAngleSnappingCandidate"],(function(e,t,n,r,i,o,a,s,u,c,l,p,d,g,h,f,S,y,m,v,w){"use strict";t.FeatureSnappingEngine=function(t){function r(e){var n;return(n=t.call(this,e)||this).sourceModules={featureService:{module:null,loader:null},featureCollection:{module:null,loader:null},graphics:{module:null,loader:null}},n}n._inheritsLoose(r,t);var i=r.prototype;return i.initialize=function(){var e;(this.updatingHandles.add(this,"snappingSources",(()=>{this.notifyChange("updating")}),1),s.isSome(this.view))&&this.handles.add([null==(e=this.view.refreshManager)?void 0:e.on("refresh",(e=>{"interval"===e.trigger&&this.refreshSourceOfLayer(e.layerView.layer)})),this.view.on("layerview-create",(e=>this.updateLayerView(e.layer,e.layerView))),this.view.on("layerview-destroy",(e=>this.updateLayerView(e.layer,null)))])},i.refreshSourceOfLayer=function(e){for(const[,{snappingSource:t}]of this.snappingSources)t.layerSource.layer===e&&t.refresh()},i.updateLayerView=function(e,t){for(const[,n]of this.snappingSources)n.snappingSource.layerSource.layer===e&&(n.layerView=t)},i.destroy=function(){this._set("options",null);for(const[,e]of this.snappingSources)e.destroy()},i.fetchCandidates=function(){var e=n._asyncToGenerator((function*(e,t,n){if(!this.options.effectiveFeatureEnabled)return[];const r=[],i=this.computeScreeenSizeDistanceParameters(e,t),o={distance:i,point:e,coordinateHelper:t.coordinateHelper,types:this.types,filter:null};for(const[,{snappingSource:u,layerView:c}]of this.snappingSources)!u.layerSource.enabled||s.isSome(c)&&c.suspended||r.push(u.fetchCandidates(o,n).then((e=>e.filter((e=>!this.candidateIsExcluded(u,e,t.excludeFeature))))));const a=(yield u.eachAlwaysValues(r)).flat();return this.addRightAngleCandidates(a,e,i,t),u.throwIfAborted(n),y.sortCandidatesInPlace(e,a),a}));function t(t,n,r){return e.apply(this,arguments)}return t}(),i.addRightAngleCandidates=function(e,t,n,r){var i,o,a,u,c,l,p,d;const g=s.isSome(r.vertexHandle)?null==(i=r.vertexHandle.right)||null==(o=i.right)?void 0:o.pos:s.isSome(r.geometry)&&"polygon"===r.geometry.type?null==(a=s.unwrap(null==(u=r.geometry.editGeometry.components[0])?void 0:u.getFirstVertex()))?void 0:a.pos:null,h=s.isSome(r.vertexHandle)?null==(c=r.vertexHandle.left)||null==(l=c.left)?void 0:l.pos:s.isSome(r.geometry)?null==(p=s.unwrap(null==(d=r.geometry.editGeometry.components[0])?void 0:d.getLastVertex()))?void 0:p.pos:null,f=e.length;for(let s=0;s<f;s++)this.addRightAngleCandidate(e[s],h,t,n,r,e),this.addRightAngleCandidate(e[s],g,t,n,r,e)},i.addRightAngleCandidate=function(e,t,n,r,i,o){if(s.isNone(t)||!(e instanceof m.EdgeSnappingCandidate))return;const a=e.constraint.closestTo(t),u=(a[0]-n[0])/r.x,c=(a[1]-n[1])/r.y;if(u*u+c*c<=1){const n=i.coordinateHelper;o.push(new w.RightAngleSnappingCandidate({coordinateHelper:n,targetPoint:a,otherVertex:t,otherVertexType:0,previousVertex:e.constraint.start,constraint:new S.RayConstraint(n,t,a),objectId:e.objectId}))}},i.computeScreeenSizeDistanceParameters=function(e,t){const n=this.options.distance*("touch"===t.pointer?this.options.touchSensitivityMultiplier:1);return s.isNone(this.view)?{x:n,y:n}:"2d"===this.view.type?{x:n*this.view.resolution,y:n*this.view.resolution}:this.computeScreeenSizeDistanceParameters3D(e,n,this.view,t)},i.computeScreeenSizeDistanceParameters3D=function(e,t,n,r){const{coordinateHelper:i,elevationInfo:o}=r,a=n.state.camera.computeScreenPixelSizeAt(y.anyMapPointToRender(e,i,o,n,F))*n.renderCoordsHelper.unitInMeters/n.mapCoordsHelper.unitInMeters,s=t*a;return{x:s/this.computeScreenMagnitudeOfMapOffset(e,a,0,n,r),y:s/this.computeScreenMagnitudeOfMapOffset(e,0,a,n,r)}},i.computeScreenMagnitudeOfMapOffset=function(e,t,n,r,{coordinateHelper:i,elevationInfo:o}){const a=i.clone(e);a[0]+=t,a[1]+=n;const s=y.anyMapPointToScreenPoint(e,i,o,r),u=y.anyMapPointToScreenPoint(a,i,o,r),c=u.x-s.x,l=u.y-s.y;return Math.sqrt(c*c+l*l)},i.candidateIsExcluded=function(e,t,n){if(s.isNone(n))return!1;const r=this.getCandidateObjectId(t);if(s.isNone(r))return!1;const i=e.layerSource.layer;return"graphics"===i.type?n.uid===r:n.sourceLayer===i&&(!(!n.attributes||!("objectIdField"in i))&&n.attributes[i.objectIdField]===r)},i.getCandidateObjectId=function(e){return e instanceof v.FeatureSnappingCandidate?e.objectId:null},i.createSourceInfo=function(e){const t=this.createFeatureSnappingSourceType(e);if(s.isNone(t))return null;if("loading"in t)return this.updatingHandles.addPromise(t.loading.then((()=>{this.destroyed||this.notifyChange("snappingSources")}))),null;const n=s.isSome(this.view)?this.view.allLayerViews.find((t=>t.layer===e.layer)):null;return new C(t.source,n)},i.createFeatureSnappingSourceType=function(e){switch(e.layer.type){case"feature":case"geojson":case"csv":case"wfs":return this.createFeatureSnappingSourceFeatureLayer(e);case"graphics":return this.createFeatureSnappingSourceGraphicsLayer(e)}return null},i.createFeatureSnappingSourceFeatureLayer=function(e){switch(e.layer.source.type){case"feature-layer":{const t=this.getSourceModule("featureService");return s.isSome(t.module)?{source:new t.module.FeatureServiceSnappingSource({spatialReference:this.spatialReference,view:this.view,layerSource:e})}:{loading:t.loader}}case"memory":case"csv":case"geojson":case"wfs":{if("mesh"===e.layer.geometryType)return null;const t=this.getSourceModule("featureCollection");return s.isSome(t.module)?{source:new t.module.FeatureCollectionSnappingSource({layerSource:e})}:{loading:t.loader}}}return null},i.createFeatureSnappingSourceGraphicsLayer=function(e){const t=this.getSourceModule("graphics");return s.isSome(t.module)?{source:new t.module.GraphicsSnappingSource({spatialReference:this.spatialReference,view:this.view,layerSource:e})}:{loading:t.loader}},i.getSourceModule=function(e){const t=this.sourceModules[e];if(s.isNone(t.loader)){const n=this.loadSourceModule(e).then((e=>{t.module=e}));return t.loader=n,{module:t.module,loader:n}}return{module:t.module,loader:t.loader}},i.loadSourceModule=function(t){switch(t){case"featureService":return this.updatingHandles.addPromise(new Promise((function(t,n){e(["./featureSources/FeatureServiceSnappingSource"],t,n)})));case"featureCollection":return this.updatingHandles.addPromise(new Promise((function(t,n){e(["./featureSources/FeatureCollectionSnappingSource"],t,n)})));case"graphics":return this.updatingHandles.addPromise(new Promise((function(t,n){e(["./featureSources/GraphicsSnappingSource"],t,n)})))}return null},n._createClass(r,[{key:"updating",get:function(){return a.someMap(this.snappingSources,(({snappingSource:e})=>e.updating))||this.updatingHandles.updating}},{key:"snappingSources",get:function(){var e;const t=this._get("snappingSources")||new Map,n=new Map;if(null!=(e=this.options)&&e.featureSources)for(const r of this.options.featureSources.items){const e=r.layer.uid,i=t.get(e);if(i){t.delete(e),n.set(e,i);continue}if(!r.layer.loaded){this.updatingHandles.addPromise(r.layer.load());continue}const o=this.createSourceInfo(r);s.isSome(o)&&n.set(e,o)}for(const[,r]of t)r.destroy();return n}},{key:"types",get:function(){return 3}}]),r}(i.HandleOwner),r.__decorate([l.property({constructOnly:!0})],t.FeatureSnappingEngine.prototype,"spatialReference",void 0),r.__decorate([l.property({constructOnly:!0})],t.FeatureSnappingEngine.prototype,"view",void 0),r.__decorate([l.property()],t.FeatureSnappingEngine.prototype,"options",void 0),r.__decorate([l.property({readOnly:!0})],t.FeatureSnappingEngine.prototype,"updating",null),r.__decorate([l.property({readOnly:!0})],t.FeatureSnappingEngine.prototype,"snappingSources",null),t.FeatureSnappingEngine=r.__decorate([h.subclass("esri.views.interactive.snapping.FeatureSnappingEngine")],t.FeatureSnappingEngine);let C=function(){function e(e,t){this.snappingSource=e,this.layerView=t,this.handles=new o;const n=this.snappingSource.layerSource.layer;if("refresh"in n){const t=n;this.handles.add(t.on("refresh",(()=>e.refresh())))}this.handles.add([c.init(e,"updating",(t=>e.layerSource.updating=t),!0),c.init(e,"availability",(t=>e.layerSource.availability=t),!0)])}return e.prototype.destroy=function(){this.snappingSource.destroy(),this.handles.destroy()},e}();const F=f.create();Object.defineProperty(t,"__esModule",{value:!0})}));
