/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["require","exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/HandleOwner","../../../core/Handles","../../../core/MapUtils","../../../core/maybe","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec2","../../../chunks/vec3","../../../chunks/vec3f64","../../../chunks/common","../../../layers/graphics/data/QueryEngineResult","../../../support/elevationInfoUtils","./SnappingConstraint","./SnappingDomain","./SnappingPoint","./snappingUtils","./candidates/DrapedEdgeSnappingCandidate","./candidates/EdgeSnappingCandidate","./candidates/FeatureSnappingCandidate","./candidates/RightAngleSnappingCandidate","../support/viewUtils"],(function(e,t,n,r,i,a,o,s,c,u,p,d,l,g,S,h,y,f,m,w,_,v,F,C,E,b,P,M,x){"use strict";t.FeatureSnappingEngine=function(t){function r(e){var n;return(n=t.call(this,e)||this).options=null,n._domain=v.SnappingDomain.FEATURE,n._sourceModules={featureService:{module:null,loader:null},featureCollection:{module:null,loader:null},graphics:{module:null,loader:null},notes:{module:null,loader:null},scene:{module:null,loader:null}},n}n._inheritsLoose(r,t);var i=r.prototype;return i.initialize=function(){this.updatingHandles.add((()=>this.snappingSources),(()=>this.notifyChange("updating")),u.sync),s.isSome(this.view)&&this.handles.add([this.view.on("layerview-create",(e=>this._updateLayerView(e.layer,e.layerView))),this.view.on("layerview-destroy",(e=>this._updateLayerView(e.layer,null)))])},i._updateLayerView=function(e,t){for(const[,n]of this.snappingSources)n.snappingSource.layerSource.layer===e&&(n.layerView=t)},i.destroy=function(){this._set("options",null);for(const[,e]of this.snappingSources)e.destroy()},i.fetchCandidates=function(){var e=n._asyncToGenerator((function*(e,t,n,r){if(!(t&this._domain)||s.isNone(this.options)||!this.options.effectiveFeatureEnabled)return[];const i=[],a=this._computeScreenSizeDistanceParameters(e,n),o={distance:a,mode:s.unwrap(this.view)?.type??"2d",point:e,coordinateHelper:n.coordinateHelper,types:this._types};for(const[,{snappingSource:c,layerView:p}]of this.snappingSources)!c.layerSource.enabled||s.isSome(p)&&p.suspended||i.push(c.fetchCandidates(o,r).then((e=>e.filter((e=>!this._candidateIsExcluded(c,e,n.excludeFeature))))));const u=(yield c.eachAlwaysValues(i)).flat();return this._addRightAngleCandidates(u,e,a,n),c.throwIfAborted(r),C.sortCandidatesInPlace(e,u),u}));function t(t,n,r,i){return e.apply(this,arguments)}return t}(),i._addRightAngleCandidates=function(e,t,n,r){const i=s.isSome(r.vertexHandle)?r.vertexHandle.rightEdge?.rightVertex?.pos:s.isSome(r.editGeometryOperations)&&"polygon"===r.editGeometryOperations.data.type?s.unwrap(r.editGeometryOperations.data.components[0]?.getFirstVertex())?.pos:null,a=s.isSome(r.vertexHandle)?r.vertexHandle.leftEdge?.leftVertex?.pos:s.isSome(r.editGeometryOperations)?s.unwrap(r.editGeometryOperations.data.components[0]?.getLastVertex())?.pos:null,{view:o}=this,c=F.anyMapPointToSnappingPoint(i,o,r),u=F.anyMapPointToSnappingPoint(a,o,r),p=e.length;for(let s=0;s<p;s++)this._addRightAngleCandidate(e[s],u,t,n,e),this._addRightAngleCandidate(e[s],c,t,n,e)},i._addRightAngleCandidate=function(e,t,n,r,i){if(s.isNone(t)||!I(e))return;const a=e.constraint.closestTo(t),o=(a[0]-n[0])/r.x,c=(a[1]-n[1])/r.y,{start:u,end:p}=e.constraint;if(o*o+c*c<=1){const n=new M.RightAngleSnappingCandidate({targetPoint:a,otherVertex:t,otherVertexType:M.OtherVertexType.NEXT,previousVertex:S.squaredDistance(a,u)>S.squaredDistance(a,p)?u:p,constraint:new _.VerticalHalfPlaneConstraint(t,a),objectId:e.objectId,isDraped:e.isDraped});i.push(n)}},i._computeScreenSizeDistanceParameters=function(e,t){let n=s.isSome(this.options)?this.options.distance*("touch"===t.pointer?this.options.touchSensitivityMultiplier:1):0;return s.isNone(this.view)?{x:n,y:n,z:n,distance:n}:"2d"===this.view.type?(n*=this.view.resolution,{x:n,y:n,z:n,distance:n}):this._computeScreenSizeDistanceParameters3D(e,n,this.view,t)},i._computeScreenSizeDistanceParameters3D=function(e,t,n,r){const{spatialReference:i}=r;n.renderCoordsHelper.toRenderCoords(e,i,V);const a=n.state.camera.computeScreenPixelSizeAt(V),o=a*n.renderCoordsHelper.unitInMeters/n.mapCoordsHelper.unitInMeters,s=t*o,c=x.vectorToScreenPoint(e,i,w.absoluteHeightElevationInfo,n),u=c?L(c,e,o,0,0,n,r):0,p=c?L(c,e,0,o,0,n,r):0,d=c?L(c,e,0,0,o,n,r):0;return{x:0===u?0:s/u,y:0===p?0:s/p,z:0===d?0:s/d,distance:a*t}},i._candidateIsExcluded=function(e,t,n){if(s.isNone(n))return!1;const r=this._getCandidateObjectId(t);if(s.isNone(r))return!1;const i=e.layerSource.layer;return"graphics"===i.type?n.uid===r:n.sourceLayer===i&&(!(!n.attributes||!("objectIdField"in i))&&n.attributes[i.objectIdField]===r)},i._getCandidateObjectId=function(e){return e instanceof P.FeatureSnappingCandidate?e.objectId:null},i._createSourceInfo=function(e){const t=this._createFeatureSnappingSourceType(e);if(s.isNone(t))return null;if("loading"in t)return this.updatingHandles.addPromise(t.loading.then((()=>{this.destroyed||this.notifyChange("snappingSources")}))),null;const n=s.isSome(this.view)?this.view.allLayerViews.find((t=>t.layer===e.layer)):null;return new H(t.source,n)},i._createFeatureSnappingSourceType=function(e){switch(e.layer.type){case"feature":case"geojson":case"csv":case"oriented-imagery":case"subtype-group":case"wfs":return this._createFeatureSnappingSourceFeatureLayer(e);case"graphics":return this._createFeatureSnappingSourceGraphicsLayer(e);case"map-notes":return this._createFeatureSnappingSourceMapNotesLayer(e);case"scene":case"building-scene":return this._createFeatureSnappingSourceSceneLayer(e)}return null},i._createFeatureSnappingSourceSceneLayer=function(e){const{view:t}=this;if(s.isNone(t)||"3d"!==t.type)return null;const n=this._getSourceModule("scene");return s.isSome(n.module)?{source:new n.module.SceneLayerSnappingSource({layerSource:e,view:t})}:{loading:n.loader}},i._createFeatureSnappingSourceFeatureLayer=function(e){switch(e.layer.source?.type){case"feature-layer":case"oriented-imagery":{const t=this._getSourceModule("featureService");return s.isSome(t.module)?{source:new t.module.FeatureServiceSnappingSource({spatialReference:this.spatialReference,view:this.view,layerSource:e})}:{loading:t.loader}}case"memory":case"csv":case"geojson":case"wfs":{if("mesh"===e.layer.geometryType)return null;const t=this._getSourceModule("featureCollection");return s.isSome(t.module)?{source:new t.module.FeatureCollectionSnappingSource({layerSource:e,view:this.view})}:{loading:t.loader}}}return null},i._createFeatureSnappingSourceGraphicsLayer=function(e){const t=this._getSourceModule("graphics");return s.isSome(t.module)?{source:new t.module.GraphicsSnappingSource({getGraphicsLayers:()=>[e.layer],spatialReference:this.spatialReference,view:this.view,layerSource:e})}:{loading:t.loader}},i._createFeatureSnappingSourceMapNotesLayer=function(e){const t=this._getSourceModule("notes");return s.isSome(t.module)?{source:new t.module.GraphicsSnappingSource({getGraphicsLayers:()=>s.isSome(e.layer.sublayers)?e.layer.sublayers.toArray():[],spatialReference:this.spatialReference,view:this.view,layerSource:e})}:{loading:t.loader}},i._getSourceModule=function(e){const t=this._sourceModules[e];if(s.isNone(t.loader)){const n=this._loadSourceModule(e).then((e=>{t.module=e}));return t.loader=n,{module:t.module,loader:n}}return{module:t.module,loader:t.loader}},i._loadSourceModule=function(t){const n=this.updatingHandles;switch(t){case"featureService":return n.addPromise(new Promise(((t,n)=>e(["./featureSources/FeatureServiceSnappingSource"],t,n))));case"featureCollection":return n.addPromise(new Promise(((t,n)=>e(["./featureSources/FeatureCollectionSnappingSource"],t,n))));case"graphics":case"notes":return n.addPromise(new Promise(((t,n)=>e(["./featureSources/GraphicsSnappingSource"],t,n))));case"scene":return n.addPromise(new Promise(((t,n)=>e(["./featureSources/SceneLayerSnappingSource"],t,n))))}},n._createClass(r,[{key:"updating",get:function(){return o.someMap(this.snappingSources,(({snappingSource:e})=>e.updating))||this.updatingHandles.updating}},{key:"snappingSources",get:function(){const e=this._get("snappingSources")||new Map,t=new Map;if(s.isSome(this.options)&&s.isSome(this.options.featureSources))for(const n of this.options.featureSources.items){const r=n.layer.uid,i=e.get(r);if(i){e.delete(r),t.set(r,i);continue}if(!n.layer.loaded){this.updatingHandles.addPromise(n.layer.load());continue}const a=this._createSourceInfo(n);s.isSome(a)&&t.set(r,a)}for(const[,n]of e)n.destroy();return t}},{key:"_types",get:function(){return m.SnappingTypes.EDGE|m.SnappingTypes.VERTEX}}]),r}(i.HandleOwner),r.__decorate([p.property({constructOnly:!0})],t.FeatureSnappingEngine.prototype,"spatialReference",void 0),r.__decorate([p.property({constructOnly:!0})],t.FeatureSnappingEngine.prototype,"view",void 0),r.__decorate([p.property()],t.FeatureSnappingEngine.prototype,"options",void 0),r.__decorate([p.property({readOnly:!0})],t.FeatureSnappingEngine.prototype,"updating",null),r.__decorate([p.property({readOnly:!0})],t.FeatureSnappingEngine.prototype,"snappingSources",null),t.FeatureSnappingEngine=r.__decorate([g.subclass("esri.views.interactive.snapping.FeatureSnappingEngine")],t.FeatureSnappingEngine);let H=function(){function e(e,t){this.snappingSource=e,this.layerView=t,this.handles=new a;const n=this.snappingSource.layerSource.layer;if("refresh"in n){const t=n;this.handles.add(t.on("refresh",(()=>e.refresh())))}this.handles.add([u.watch((()=>e.updating),(t=>e.layerSource.updating=t),u.syncAndInitial),u.watch((()=>e.availability),(t=>e.layerSource.availability=t),u.syncAndInitial)])}return e.prototype.destroy=function(){this.snappingSource.destroy(),this.handles.destroy()},e}();function I(e){return(e instanceof b.EdgeSnappingCandidate||e instanceof E.DrapedEdgeSnappingCandidate)&&!R(e)}function R({constraint:{start:e,end:t}}){const n=h.squaredDistance(e,t),r=S.squaredDistance(e,t);return n<f.getEpsilon()||r/n<T}function L(e,t,n,r,i,a,{spatialReference:o}){const s=h.copy(D,t);s[0]+=n,s[1]+=r,s[2]+=i;const c=x.vectorToScreenPoint(s,o,w.absoluteHeightElevationInfo,a);return c?C.screenDistance(c,e):1/0}const V=y.create(),D=y.create(),T=1e-4;Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
