/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/mathUtils","../../../../core/maybe","../../../../chunks/vec2","../../../../chunks/vec2f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/support/plane","../../../../geometry/support/vector","../../../support/geometry2dUtils"],(function(t,e,i,n,s,r,o,c,a,h,l){"use strict";let _=function(){function t(t,e,i,n=0,s=0){this.helper=t,this.planeType=e,this.edge=i,this.distance=n,this._plane=a.create(),this._offsetPlane=a.create(),this._minDistance=-1/0,this._maxDistance=1/0,0===s&&this._initialize()}var i=t.prototype;return i._initialize=function(){this._initializeNeighbors(),this._initializePlane(),this._initializeDistanceConstraints()},i._initializeNeighbors=function(){var t,e,i,n;const s=this._toXYZ(this.edge.leftVertex.pos),r=this._toXYZ(null==(t=this.edge.leftVertex.leftEdge)||null==(e=t.leftVertex)?void 0:e.pos),a=this._toXYZ(this.edge.rightVertex.pos),h=this._toXYZ(null==(i=this.edge.rightVertex.rightEdge)||null==(n=i.rightVertex)?void 0:n.pos);this._edgeDirection=o.direction(c.create(),s,a),this._left=this._computeNeighbor(s,r,this._edgeDirection),this._right=this._computeNeighbor(a,h,this._edgeDirection)},i._toXYZ=function(t){return n.isSome(t)?this.helper.toXYZ(t):null},i._computeNeighbor=function(t,e,i){if(n.isNone(e))return{start:t,end:e,direction:c.fromValues(-i[1],i[0],0),isOriginalDirection:!0};const s=o.direction(c.create(),t,e),r=!this._passesBisectingAngleThreshold(s,i);return{start:t,end:e,direction:r?this._bisectVectorsPerpendicular(i,s):s,isOriginalDirection:!r}},i._passesBisectingAngleThreshold=function(t,e){const i=Math.abs(h.angle(e,t));return i>=d&&i<=Math.PI-d},i._bisectVectorsPerpendicular=function(t,e){const i=o.dot(t,e)<0?t:o.negate(c.create(),t),n=Math.abs(o.dot(i,e));if(!(n<.001||n>.999))return this._bisectDirection(i,e);const s=o.cross(c.create(),i,[0,0,1]);return o.normalize(s,s)},i._bisectDirection=function(t,e){const i=o.add(c.create(),t,e);return o.normalize(i,i)},i._initializePlane=function(){const t=this._computeNormalDirection(this._left),e=this._computeNormalDirection(this._right);o.dot(t,e)<0&&o.negate(e,e),a.fromPositionAndNormal(this._left.start,this._bisectDirection(t,e),this._plane)},i._computeNormalDirection=function(t){const e=o.cross(c.create(),t.direction,this._edgeDirection);o.normalize(e,e);const i=o.cross(c.create(),this._edgeDirection,e);return 1===this.planeType&&(i[2]=0),o.normalize(i,i)},i._initializeDistanceConstraints=function(){n.isSome(this._left.end)&&!this.requiresSplitEdgeLeft&&this._updateDistanceConstraint(a.signedDistance(this._plane,this._left.end)),n.isSome(this._right.end)&&!this.requiresSplitEdgeRight&&this._updateDistanceConstraint(a.signedDistance(this._plane,this._right.end)),this._updateIntersectDistanceConstraint(this._plane)},i._updateDistanceConstraint=function(t){t<=0&&(this._minDistance=Math.max(this._minDistance,t)),t>=0&&(this._maxDistance=Math.min(this._maxDistance,t))},i._updateIntersectDistanceConstraint=function(t){const e=a.normal(t),i=this._edgeDirection,n=o.add(c.create(),this._left.start,this._left.direction),h=o.add(c.create(),this._right.start,this._right.direction),_=this._pointInBasis2D(r.create(),e,i,this._left.start),d=this._pointInBasis2D(r.create(),e,i,n),u=this._pointInBasis2D(r.create(),e,i,this._right.start),g=this._pointInBasis2D(r.create(),e,i,h),[p]=l.intersectLineAndRay({start:d,end:_,type:1},{start:g,end:u,type:1});if(!p)return;const f=s.subtract(r.create(),_,d);s.normalize(f,f);const m=s.subtract(r.create(),p,d),D=s.dot(f,m),y=o.add(c.create(),n,o.scale(c.create(),this._left.direction,-D)),x=a.signedDistance(t,y);this._updateDistanceConstraint(x)},i._pointInBasis2D=function(t,e,i,n){return t[0]=h.projectPointSignedLength(e,n),t[1]=h.projectPointSignedLength(i,n),t},i._offset=function(t,e){Number.isFinite(this._minDistance)&&(e=Math.max(this._minDistance,e)),Number.isFinite(this._maxDistance)&&(e=Math.min(this._maxDistance,e)),a.copy(this._plane,this._offsetPlane),this._offsetPlane[3]-=e;const i=(t,e,i)=>n.isSome(e)&&a.intersectLine(this._offsetPlane,t,o.add(c.create(),t,e),i),s=c.create();(t===this.edge.leftVertex?i(this._left.start,this._left.direction,s):i(this._right.start,this._right.direction,s))&&this.helper.copy(this.helper.fromXYZ(s,void 0,this.helper.getM(t.pos)),t.pos)},i.signedDistanceToPoint=function(t){return a.signedDistance(this.plane,this.helper.toXYZ(this.helper.pointToVector(t)))},i.apply=function(t){this._offset(t,this.distance)},i.undo=function(t){this._offset(t,0)},i.canAccumulate=function(e){return e instanceof t&&this.edge.leftVertex.index===e.edge.leftVertex.index&&this.edge.rightVertex.index===e.edge.rightVertex.index&&this.edge.component===e.edge.component&&this._maybeEqualsVec3(this._left.direction,e._left.direction)&&this._maybeEqualsVec3(this._right.direction,e._right.direction)&&o.equals(a.normal(this._plane),a.normal(e._plane))},i.accumulate=function(t,e){const i=this._plane[3]-e._plane[3]+e.distance;this._offset(t,i)},i.accumulateParams=function(t){const e=t.distance-t._plane[3];this.distance=e+this._plane[3]},i.clone=function(){const e=new t(this.helper,this.planeType,this.edge,this.distance,1);return a.copy(this._plane,e._plane),a.copy(this._offsetPlane,e._offsetPlane),e._maxDistance=this._maxDistance,e._minDistance=this._minDistance,e._left=this._cloneNeighbor(this._left),e._right=this._cloneNeighbor(this._right),e._edgeDirection=o.copy(c.create(),this._edgeDirection),e},i._maybeEqualsVec3=function(t,e){return n.isNone(t)&&n.isNone(e)||n.isSome(t)&&n.isSome(e)&&o.equals(t,e)},i._cloneNeighbor=function({start:t,end:e,direction:i,isOriginalDirection:s}){return{start:o.copy(c.create(),t),end:n.isSome(e)?o.copy(c.create(),e):null,direction:o.copy(c.create(),i),isOriginalDirection:s}},e._createClass(t,[{key:"plane",get:function(){return this._plane}},{key:"requiresSplitEdgeLeft",get:function(){return!this._left.isOriginalDirection}},{key:"requiresSplitEdgeRight",get:function(){return!this._right.isOriginalDirection}},{key:"edgeDirection",get:function(){return this._edgeDirection}}]),t}();const d=i.deg2rad(15);t.OffsetEdgeVertex=_,Object.defineProperty(t,"__esModule",{value:!0})}));
