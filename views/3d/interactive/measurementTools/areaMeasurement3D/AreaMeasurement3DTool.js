/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../core/Handles","../../../../../core/Logger","../../../../../core/maybe","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/accessorSupport/ensureType","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/accessorSupport/trackingUtils","../../../../../layers/graphics/hydratedFeatures","../../editingTools/dragEventPipeline3D","./AreaMeasurement3DModel","./AreaMeasurement3DView","../support/measurementUtils","../../../../interactive/dragEventPipeline","../../../../interactive/InteractiveToolBase","../../../../support/screenUtils"],(function(e,t,i,s,n,r,a,o,u,c,m,l,h,d,p,w,_,y){"use strict";const V=s.getLogger("esri.views.3d.interactive.measurementTools.areaMeasurement3D.AreaMeasurement3DTool");let g=function(t){function s(e){var s;return(s=t.call(this,e)||this)._handles=new i,s._tempPickRequest=new d.PickRequest,s.model=new h.AreaMeasurement3DModel({sceneView:e.view}),s.measurementView=new d({model:s.model,unit:e.unit,manipulators:s.manipulators}),s}e._inheritsLoose(s,t);var r=s.prototype;return r.initialize=function(){this.measurementView.when().then((()=>this._initialize()))},r._initialize=function(){this.destroyed?V.error("Calling _initialized() on destroyed AreaMeasurement3DTool."):(this._setupManipulators(),this.visible&&this.measurementView.show(),this._handles.add(c.reaction((()=>this.state),(e=>{"measured"===e?this.complete():this.finishToolCreation()}))),"measured"===this.state?this.complete():this.startToolCreation())},r.destroy=function(){this.attached&&this.detach(),this.measurementView.destroy(),this._set("measurementView",null),this.model.destroy(),this._set("model",null),this._handles=n.destroyMaybe(this._handles)},r.onActivate=function(){this.model.active=!0},r.onDeactivate=function(){this.model.active=!1},r.onShow=function(){this.created&&this.measurementView.show()},r.onHide=function(){this.created&&this.measurementView.hide()},r.onDetach=function(){switch(this.toolState){case"created":case"creating":this.measurementView.path&&this.measurementView.path.clear(),this.measurementView.cursorPoint=null,this.model.state="initial"}},r.onInputEvent=function(e){switch(e.type){case"immediate-double-click":this._handleImmediateDoubleClick(e);break;case"immediate-click":this._handleImmediateClick(e);break;case"pointer-move":this._handlePointerMove(e);break;case"drag":this._handleDrag(e);break;case"key-down":this._handleKeyDown(e)}},r._setupManipulators=function(){const e=e=>`manipulator-${e}`;let t=0;const i=e=>i=>("start"===i.action&&(t++,this.measurementView.lastDraggedVertex=n.unwrap(this.measurementView.manipulatorToVertex(e)),"measured"===this.model.state&&(this.model.state="editing")),i),s=()=>e=>"end"===e.action?(t--,0===t&&"editing"===this.model.state&&(this.model.state="measured"),null):e,r=(t,r)=>{this._handles.add([w.createManipulatorDragEventPipeline(r,((e,t,r)=>{const a=l.hideManipulatorWhileDragging(e),o=n.unwrap(this.measurementView.manipulatorToVertex(e));t.next(i(e)).next(a).next(s()).next(this.measurementView.screenToMap3D()).next((t=>{e.location=t.mapEnd,this.measurementView.path.setVertexPosition(o,m.clonePoint(t.mapEnd))}));const u=m.clonePoint(this.measurementView.path.getVertexPositionAsPoint(o));r.next(a).next((()=>{this.measurementView.path.setVertexPosition(o,u),e.location=u}))}))],e(t))},a=t=>{this._handles.remove(e(t))};this.manipulators.forEach((({id:e,manipulator:t})=>{r(e,t)})),this._handles.add([this.manipulators.on("after-add",(({item:{id:e,manipulator:t}})=>{r(e,t)})),this.manipulators.on("after-remove",(({item:{id:e}})=>{a(e)}))])},r._handleImmediateDoubleClick=function(e){p.isPrimaryPointerAction(e)&&("drawing"===this.model.state&&this.measurementView.finishMeasurement(),e.stopPropagation())},r._handleDrag=function(e){"editing"===this.model.state&&e.stopPropagation()},r._handleImmediateClick=function(e){if(!p.isPrimaryPointerAction(e))return;const t=y.createScreenPointFromEvent(e);if(this.model.active)switch(this.model.state){case"initial":if(this._addVertexAt(t))return this.measurementView.cursorPoint=null,this.model.state="drawing",void e.stopPropagation();break;case"drawing":{const i=this.measurementView.vertexHandleAt(t,e.pointerType);if(n.isNone(i)){if(this._addVertexAt(t))return this.measurementView.cursorPoint=null,void e.stopPropagation()}else 0===i.index&&(this.measurementView.finishMeasurement(),e.stopPropagation());break}}"mouse"===e.pointerType&&this._hoverAt(t)},r._handlePointerMove=function(e){if("mouse"===e.pointerType){const t=y.createScreenPointFromEvent(e);this._hoverAt(t)}},r._handleKeyDown=function(e){"Enter"===e.key&&"drawing"===this.model.state&&(this.measurementView.finishMeasurement(),e.stopPropagation())},r._hoverAt=function(e){if(this.measurementView.requiresCursorPoint){const t=this._pick(e);t.mapPoint&&(this.measurementView.cursorPoint=t.mapPoint)}else this.measurementView.cursorPoint=null},r._addVertexAt=function(e){const t=this._pick(e);return!!t.mapPoint&&(this.measurementView.path.add(t.mapPoint),!0)},r._pick=function(e){const t=this._tempPickRequest;return t.screenPoint=e,this.measurementView.pick(t)},e._createClass(s,[{key:"state",get:function(){var e,t;if(n.isNone(this.model))return"ready";switch(this.model.state){case"initial":return(null==(e=this.measurementView)||null==(t=e.path)?void 0:t.numVertices)>=1?"measuring":"ready";case"drawing":case"editing":return"measuring";case"measured":return"measured"}}},{key:"cursor",get:function(){return this.destroyed?(V.error("Can't query the cursor of a destroyed tool."),null):!this.model.active||"initial"!==this.model.state&&"drawing"!==this.model.state?null:"crosshair"}},{key:"unit",set:function(e){this._set("unit",e),"ready"===this.measurementView.state&&(this.measurementView.layerView.unit=e)}}]),s}(_.InteractiveToolBase);return t.__decorate([r.property({readOnly:!0})],g.prototype,"state",null),t.__decorate([r.property({readOnly:!0})],g.prototype,"cursor",null),t.__decorate([r.property()],g.prototype,"unit",null),t.__decorate([r.property({constructOnly:!0})],g.prototype,"model",void 0),t.__decorate([r.property({constructOnly:!0})],g.prototype,"measurementView",void 0),t.__decorate([r.property({constructOnly:!0})],g.prototype,"view",void 0),g=t.__decorate([u.subclass("esri.views.3d.interactive.measurementTools.areaMeasurement3D.AreaMeasurement3DTool")],g),g}));
