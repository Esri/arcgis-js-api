/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../core/Handles","../../../../../core/maybe","../../../../../core/reactiveUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/arrayUtils","../../../../../core/has","../../../../../core/accessorSupport/ensureType","../../../../../core/accessorSupport/decorators/subclass","../../../../../layers/graphics/hydratedFeatures","../../../analysis/support/measurementUtils","../../editingTools/dragEventPipeline3D","./AreaMeasurement3DView","../../../../interactive/dragEventPipeline","../../../../interactive/InteractiveToolBase","../../../../support/screenUtils"],(function(e,t,i,n,s,a,o,r,l,c,u,h,p,d,m,y,w){"use strict";let _=function(t){function a(e){var n;return(n=t.call(this,e)||this)._handles=new i,n._tempPickRequest=new d.PickRequest,n.polygonState="initial",n.analysisView=null,n}e._inheritsLoose(a,t);var o=a.prototype;return o.initialize=function(){this.measurementView=new d({view:this.view,analysis:this.analysis,analysisView:this.analysisView,toolState:this,manipulators:this.manipulators,visible:this.visible}),this._setupManipulators(),this.startToolCreation(),this._handles.add(s.watch((()=>this.state),(e=>{"measured"===e&&this.finishToolCreation()}),s.syncAndInitial))},o.destroy=function(){this.measurementView.destroy(),this._set("measurementView",null),this._handles=n.destroyMaybe(this._handles)},o.finishMeasurement=function(){const e=this.analysisView.path;e.numVertices<3?(e.clear(),this.polygonState="initial"):(e.close(),this.polygonState="measured"),this.analysisView.cursorPoint=null},o.onShow=function(){this.measurementView.show()},o.onHide=function(){this.measurementView.hide()},o.onInputEvent=function(e){switch(e.type){case"immediate-double-click":this._handleImmediateDoubleClick(e);break;case"immediate-click":this._handleImmediateClick(e);break;case"pointer-move":this._handlePointerMove(e);break;case"drag":this._handleDrag(e);break;case"key-down":this._handleKeyDown(e)}},o._setupManipulators=function(){const e=e=>`manipulator-${e}`,t=e=>e.events.on("grab-changed",(()=>{if(this.analysisView.validMeasurement){const e=this.manipulators.some((e=>e.manipulator.grabbing));this.polygonState=e?"editing":"measured"}})),i=(i,s)=>{this._handles.add([m.createManipulatorDragEventPipeline(s,((e,t,i)=>{const s=p.hideManipulatorWhileDragging(e),a=n.unwrap(this.measurementView.manipulatorToVertex(e));t.next(s).next(this.measurementView.screenToMap3D()).next((t=>{e.location=t.mapEnd,this.analysisView.path.setVertexPosition(a,u.clonePoint(t.mapEnd))}));const o=u.clonePoint(this.analysisView.path.getVertexPositionAsPoint(a));i.next(s).next((()=>{this.analysisView.path.setVertexPosition(a,o),e.location=o}))})),t(s)],e(i))},s=t=>{this._handles.remove(e(t))};this.manipulators.forEach((({id:e,manipulator:t})=>{i(e,t)})),this._handles.add([this.manipulators.on("after-add",(({item:{id:e,manipulator:t}})=>{i(e,t)})),this.manipulators.on("after-remove",(({item:{id:e}})=>{s(e)}))])},o._handleImmediateDoubleClick=function(e){h.isPrimaryPointerAction(e)&&("drawing"===this.polygonState&&this.finishMeasurement(),e.stopPropagation())},o._handleDrag=function(e){"editing"===this.polygonState&&e.stopPropagation()},o._handleImmediateClick=function(e){if(!h.isPrimaryPointerAction(e))return;const t=w.createScreenPointFromEvent(e);if(this.active)switch(this.polygonState){case"initial":if(this._addVertexAt(t))return this.measurementView.cursorPoint=null,this.polygonState="drawing",void e.stopPropagation();break;case"drawing":{const i=this.measurementView.vertexHandleAt(t,e.pointerType);if(n.isNone(i)){if(this._addVertexAt(t))return this.measurementView.cursorPoint=null,void e.stopPropagation()}else 0===i.index&&(this.finishMeasurement(),e.stopPropagation());break}}"mouse"===e.pointerType&&this._hoverAt(t)},o._handlePointerMove=function(e){if("mouse"===e.pointerType){const t=w.createScreenPointFromEvent(e);this._hoverAt(t)}},o._handleKeyDown=function(e){"Enter"===e.key&&"drawing"===this.polygonState&&(this.finishMeasurement(),e.stopPropagation())},o._hoverAt=function(e){if(this.measurementView.requiresCursorPoint){const t=this._pick(e);t.mapPoint&&(this.measurementView.cursorPoint=t.mapPoint)}else this.measurementView.cursorPoint=null},o._addVertexAt=function(e){const t=this._pick(e);return!!t.mapPoint&&(this.analysisView.path.add(t.mapPoint),!0)},o._pick=function(e){const t=this._tempPickRequest;return t.screenPoint=e,this.measurementView.pick(t)},e._createClass(a,[{key:"state",get:function(){return 0===this.analysisView.path.numVertices?"ready":this.analysisView.validMeasurement&&"editing"!==this.polygonState?"measured":"measuring"}},{key:"cursor",get:function(){return"ready"===this.state||"drawing"===this.polygonState?"crosshair":null}}]),a}(y.InteractiveToolBase);t.__decorate([a.property({readOnly:!0})],_.prototype,"state",null),t.__decorate([a.property()],_.prototype,"polygonState",void 0),t.__decorate([a.property({readOnly:!0})],_.prototype,"cursor",null),t.__decorate([a.property()],_.prototype,"measurementView",void 0),t.__decorate([a.property({constructOnly:!0})],_.prototype,"view",void 0),t.__decorate([a.property()],_.prototype,"analysis",void 0),t.__decorate([a.property({constructOnly:!0})],_.prototype,"analysisView",void 0),_=t.__decorate([c.subclass("esri.views.3d.interactive.measurementTools.areaMeasurement3D.AreaMeasurement3DTool")],_);return _}));
