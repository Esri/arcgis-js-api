// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/declareExtendsHelper","../../../../../core/tsSupport/decorateHelper","../../../../../core/Handles","../../../../../core/StackedObjectPool","../directLineMeasurement3D/LaserLineRenderer","../support/Label","../support/LabelSegment","../support/labelUtils","../support/PathSegmentInterpolator","../support/viewUtils","../../../lib/gl-matrix","../../../webgl-engine/lib/Geometry","../../../webgl-engine/lib/GeometryData","../../../webgl-engine/lib/GeometryUtil","../../../webgl-engine/lib/Layer","../../../webgl-engine/lib/Object3D","../../../webgl-engine/lib/Selector","../../../webgl-engine/materials/CheckerBoardMaterial","../../../webgl-engine/materials/ColorMaterial","../../../webgl-engine/materials/DefaultMaterial","../../../webgl-engine/materials/RibbonLineMaterial","../../../webgl-engine/parts/Model"],function(e,t,i,r,n,a,s,o,l,h,d,c,p,_,u,m,g,L,b,v,f,w,y,S){var C,M=new a(function(){return p.vec3d.create()});!function(e){e[e.Small=12]="Small",e[e.Large=16]="Large"}(C||(C={}));var P={laserLineGlowColor:[1,.5,0],laserLineGlowWidth:8,laserLineInnerColor:[1,1,1],laserLineInnerWidth:1,laserLineGlobalAlpha:.75,laserLineEnabled:!0,handleColor:[1,.5,0],handleOpacity:.5,handleRadius:5,handleRadiusHovered:10,handleRadiusMouse:10,handleRadiusTouch:25,pathLineColor:[1,.5,0,1],pathLineWidth:3,intersectingLineColor:[1,.2,0,1],perimeterLineColor:[1,.5,0,1],perimeterLineWidth:2,projectionLineColor:[1,.5,0,1],projectionLineWidth:2,projectionLineStippleSize:5,areaColor1:[1,.5,0,.5],areaColor2:[1,1,1,.5],fillColor:[1,.5,0,.5],lineSubdivisions:64,labelDistance:25},O=function(){function e(e,t){void 0===t&&(t={}),this._visible=!1,this._laserLineRenderer=null,this._pathSegmentObjects=[],this._perimeterSegmentObjects=[],this._vertexHandleObjects=[],this._projectionLineObjects=[],this._areaLabel=new o(C.Large),this._pathLengthLabel=new o(C.Small),this._cursorSegmentLengthLabel=new o(C.Small),this._perimeterLengthLabel=new o(C.Small),this._pathLabelSegments=[],this._perimeterLabelSegments=[],this._cursorSegmentLengthLabelSegment=new l,this._listenerHandles=null,this._origin=p.vec3d.create(),this._originTransform=p.mat4d.create(),this._tempStartPosition=p.vec3d.create(),this._tempEndPosition=p.vec3d.create(),this._tempHandlePosition=p.vec3d.create(),this._tempMat4=p.mat4d.create(),this._model=e,this._sceneView=e.sceneView,this._params=c.copyParameter(P,t),this._layer=new g("path-measurement-tool",{},"path-measurement-tool"),this._createMaterials(),this._createObjects(),this._selector=new b(this._sceneView.viewingMode)}return e.prototype.destroy=function(){this.hide()},Object.defineProperty(e.prototype,"requiresCursorPoint",{get:function(){return"initial"===this._model.state||"drawing"===this._model.state},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"visible",{get:function(){return this._visible},set:function(e){e?this.show():this.hide()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"testData",{get:function(){return{labels:{area:this._areaLabel,pathLength:this._pathLengthLabel,cursorSegmentLength:this._cursorSegmentLengthLabel,perimeterLength:this._perimeterLengthLabel},laserLineRenderer:this._laserLineRenderer}},enumerable:!0,configurable:!0}),e.prototype.show=function(){if(!this._visible){this._visible=!0;var e=this._sceneView._stage,t={glowColor:this._params.laserLineGlowColor,glowWidth:this._params.laserLineGlowWidth,innerColor:this._params.laserLineInnerColor,innerWidth:this._params.laserLineInnerWidth,globalAlpha:this._params.laserLineGlobalAlpha};this._laserLineRenderer=new s(this._sceneView.renderCoordsHelper,t),e.addRenderPlugin(this._laserLineRenderer.renderSlots,this._laserLineRenderer),this._addToStage(e),this._areaLabel.addToView(this._sceneView),this._pathLengthLabel.addToView(this._sceneView),this._cursorSegmentLengthLabel.addToView(this._sceneView),this._perimeterLengthLabel.addToView(this._sceneView),this._initializeListeners(),this._updateAll(this._model.viewData)}},e.prototype.hide=function(){if(this._visible){this._visible=!1;var e=this._sceneView._stage;e.removeRenderPlugin(this._laserLineRenderer),this._laserLineRenderer=null,this._destroyListeners(),this._updatePathLength(0),this._removeFromStage(e),this._areaLabel.removeFromView(this._sceneView),this._pathLengthLabel.removeFromView(this._sceneView),this._cursorSegmentLengthLabel.removeFromView(this._sceneView),this._perimeterLengthLabel.removeFromView(this._sceneView),this._sceneView.cursor=null}},e.prototype.vertexHandleAt=function(e,t){for(var i=e.toArray(),r="touch"===t?this._params.handleRadiusTouch:this._params.handleRadiusMouse,n=this._model.path,a=0;a<n.length;++a)if(c.pointToScreenPositionDistance(n.vertex(a),i,this._sceneView)<r)return a;return null},e.prototype.pick=function(t){for(var i=new Set,r=this._sceneView._stage,n=r.getViewContent(),a=this._sceneView._stage.getAll(S.ContentType.LAYER),s=0,o=n;s<o.length;s++){var l=o[s],h=a[l];h&&h!==this._layer&&h.isPickable&&i.add(h.id)}var d=this._sceneView.spatialReference,c=[t.screenPoint.x,this._sceneView.height-t.screenPoint.y],_=this._sceneView.sceneIntersectionHelper.pickSelectorInScreen(c,this._selector,i,!0),u=_.minResult,m=p.vec3d.create();if(this._sceneView.basemapTerrain.isSeeThrough()&&!u.getIntersectionPoint(m)&&(_=this._sceneView.sceneIntersectionHelper.pickSelectorInScreen(c,this._selector,null,!1),u=_.minResult),!u.getIntersectionPoint(m))return new e.PickResult;var g=this._sceneView.renderCoordsHelper.fromRenderCoords(m,d),L="TerrainRenderer"===u.intersector?"surface":"feature";return new e.PickResult(L,m,g)},e.prototype.overlappingHandles=function(e,t){return c.pointToPointScreenDistance(e,t,this._sceneView)<=this._params.handleRadius},e.prototype.overlapsAnyHandles=function(e,t){void 0===t&&(t=[]);for(var i=this._model.path,r=0;r<i.length;++r)if(!(t.indexOf(r)>=0)&&this.overlappingHandles(e,i.vertex(r)))return!0;return!1},e.prototype._createMaterials=function(){this._handleMaterial=new w({diffuse:this._params.handleColor,transparent:1!==this._params.handleOpacity,opacity:this._params.handleOpacity,castShadows:!1},"handle"),this._handleMaterial.renderOccluded=!0,this._pathLineMaterial=new y({width:this._params.pathLineWidth,color:this._params.pathLineColor,polygonOffset:!0},"path-line"),this._pathLineMaterial.renderOccluded=!0,this._intersectingPathLineMaterial=new y({width:this._params.pathLineWidth,color:this._params.intersectingLineColor,polygonOffset:!0},"intersecting-path-line"),this._intersectingPathLineMaterial.renderOccluded=!0,this._perimeterLineMaterial=new y({width:this._params.perimeterLineWidth,color:this._params.perimeterLineColor,polygonOffset:!0},"perimeter-line"),this._perimeterLineMaterial.renderOccluded=!0,this._intersectingPerimeterLineMaterial=new y({width:this._params.perimeterLineWidth,color:this._params.intersectingLineColor,polygonOffset:!0},"intersecting-perimeter-line"),this._intersectingPerimeterLineMaterial.renderOccluded=!0,this._projectionLineMaterial=new y({width:this._params.projectionLineWidth,color:this._params.projectionLineColor,polygonOffset:!0,stippleLength:0},"projection-line"),this._projectionLineMaterial.renderOccluded=!0,this._fillMaterial=new f({color:this._params.fillColor,transparent:1!==this._params.fillColor[3],polygonOffset:!1},"fill"),this._fillMaterial.renderOccluded=!0,this._checkerBoardMaterial=new v({color1:this._params.areaColor1,color2:this._params.areaColor2,transparent:!0,polygonOffset:!0},"checker-board"),this._checkerBoardMaterial.renderOccluded=!0},e.prototype._createObjects=function(){this._cursorHandleObject=new L,this._cursorSegmentObject=new L,this._areaObject=new L},e.prototype._addToStage=function(e){e.add(S.ContentType.LAYER,this._layer),e.add(S.ContentType.MATERIAL,this._handleMaterial),e.add(S.ContentType.MATERIAL,this._pathLineMaterial),e.add(S.ContentType.MATERIAL,this._intersectingPathLineMaterial),e.add(S.ContentType.MATERIAL,this._perimeterLineMaterial),e.add(S.ContentType.MATERIAL,this._intersectingPerimeterLineMaterial),e.add(S.ContentType.MATERIAL,this._projectionLineMaterial),e.add(S.ContentType.MATERIAL,this._fillMaterial),e.add(S.ContentType.MATERIAL,this._checkerBoardMaterial),e.addToViewContent([this._layer.id])},e.prototype._removeFromStage=function(e){e.removeFromViewContent([this._layer.id]),e.remove(S.ContentType.LAYER,this._layer.id),e.remove(S.ContentType.MATERIAL,this._handleMaterial.id),e.remove(S.ContentType.MATERIAL,this._pathLineMaterial.id),e.remove(S.ContentType.MATERIAL,this._intersectingPathLineMaterial.id),e.remove(S.ContentType.MATERIAL,this._perimeterLineMaterial.id),e.remove(S.ContentType.MATERIAL,this._intersectingPerimeterLineMaterial.id),e.remove(S.ContentType.MATERIAL,this._projectionLineMaterial.id),e.remove(S.ContentType.MATERIAL,this._fillMaterial.id),e.remove(S.ContentType.MATERIAL,this._checkerBoardMaterial.id)},e.prototype._updateMouseCursor=function(){"drawing"===this._model.state||"initial"===this._model.state?this._sceneView.cursor="crosshair":"editing"!==this._model.state&&"measured"!==this._model.state||(this._model.draggedVertices.length>0?this._sceneView.cursor="grabbing":null!=this._model.hoveredVertexHandle?this._sceneView.cursor="pointer":this._sceneView.cursor="crosshair")},e.prototype._syncViewData=function(e){var t=this,i=e.pathChanges;"full"===i.change?this._updateAll(e):"incremental"===i.change&&(i.updatedVertices.forEach(function(i){var r=(i-1+t._model.path.length)%t._model.path.length;t._updatePathSegment(e,i),t._updatePathSegment(e,r),t._updateVertexHandle(e,i),t._updateArea(e),t._updatePerimeterSegments(e),t._updateProjectionLines(e),t._updateLaserLine(),t._updateLabels(e)}),i.updatedVertices.has(this._model.path.length-1)&&this._updateCursorSegment(e));var r=i.change;return i.clear(),r},e.prototype._updateAfterSyncViewData=function(e){var t=this._model.viewData;!("full"===this._syncViewData(t))&&e&&e(t)},e.prototype._updateOrigin=function(e){c.midpoint(e.positionsRenderCoords,this._origin),p.mat4d.identity(this._originTransform),p.mat4d.translate(this._originTransform,this._origin)},e.prototype._updateAll=function(e){this._updateOrigin(e),this._updatePathLength(e.path.length),this._updatePathSegments(e),this._updatePerimeterSegments(e),this._updateHandles(e),this._updateMouseCursor(),this._updateArea(e),this._updateProjectionLines(e),this._updateLabels(e),this._updateLaserLine()},e.prototype._updateCameraDependent=function(e){this._updateHandles(e),this._updateProjectionLines(e),this._updateLabels(e)},e.prototype._updatePathLength=function(e){this._resizeObject3DArray(this._pathSegmentObjects,e),this._resizeObject3DArray(this._perimeterSegmentObjects,e),this._resizeObject3DArray(this._vertexHandleObjects,e),c.resizeArray(this._pathLabelSegments,e,function(){return new l}),c.resizeArray(this._perimeterLabelSegments,e,function(){return new l})},e.prototype._updatePathSegments=function(e){for(var t=0;t<this._pathSegmentObjects.length;++t)this._updatePathSegment(e,t);this._updateCursorSegment(e)},e.prototype._updatePathSegment=function(e,t){var i=e.path,r=this._pathSegmentObjects[t];e.validMeasurement||t<i.length-1?(this._updatePathSegmentObject(r,e.positionsRenderCoords[t],e.positionsRenderCoords[(t+1)%i.length],this._origin,this._originTransform,e.intersectingSegments.has(t),this._pathLabelSegments[t],e.validMeasurement?"center":"end"),this._addObject3D(r)):(r.removeAllGeometries(),this._removeObject3D(r))},e.prototype._updateCursorSegment=function(e){var t=this._sceneView.renderCoordsHelper,i=this._model.path,r=this._cursorSegmentObject;i.length>0&&"drawing"===this._model.state&&this._model.cursorPoint?(t.toRenderCoords(i.back,this._tempStartPosition),t.toRenderCoords(this._model.cursorPoint,this._tempEndPosition),this._updatePathSegmentObject(r,this._tempStartPosition,this._tempEndPosition,this._origin,this._originTransform,!1,this._cursorSegmentLengthLabelSegment,"end"),this._addObject3D(r)):(r.removeAllGeometries(),this._removeObject3D(r))},e.prototype._updatePathSegmentObject=function(e,t,i,r,n,a,s,o){this._createInterpolatedLineGeometry(e,a?this._intersectingPathLineMaterial:this._pathLineMaterial,"path-segment",t,i,r,n,this._model.measurementMode,s,o)},e.prototype._updatePerimeterSegments=function(e){for(var t=0;t<this._perimeterSegmentObjects.length;++t)this._updatePerimeterSegment(e,t)},e.prototype._updatePerimeterSegment=function(e,t){var i=e.path,r=this._perimeterSegmentObjects[t];e.validMeasurement&&"geodesic"!==this._model.measurementMode?(this._updatePerimeterSegmentObject(r,e.positionsFittedRenderCoords[t],e.positionsFittedRenderCoords[(t+1)%i.length],this._origin,this._originTransform,e.intersectingSegments.has(t),this._perimeterLabelSegments[t]),this._addObject3D(r)):(r.removeAllGeometries(),this._removeObject3D(r))},e.prototype._updatePerimeterSegmentObject=function(e,t,i,r,n,a,s){this._createInterpolatedLineGeometry(e,a?this._intersectingPerimeterLineMaterial:this._perimeterLineMaterial,"perimeter-segment",t,i,r,n,this._model.measurementMode,s)},e.prototype._updateHandles=function(e){for(var t=0;t<this._vertexHandleObjects.length;++t)this._updateVertexHandle(e,t);this._updateCursorHandle(e)},e.prototype._updateVertexHandle=function(e,t){var i=this._sceneView._stage,r=i.getCamera(),n=t,a=this._vertexHandleObjects[t];this._updateHandleObject(a,e.positionsRenderCoords[t],!0,this._model.hoveredVertexHandle===n,this._model.draggedVertices.includes(n),r),this._addObject3D(a)},e.prototype._updateCursorHandle=function(e){var t=this._cursorHandleObject;if("drawing"===this._model.state&&this._model.cursorPoint){var i=this._sceneView._stage,r=i.getCamera(),n=this._tempHandlePosition;this._sceneView.renderCoordsHelper.toRenderCoords(this._model.cursorPoint,n),this._updateHandleObject(t,n,!0,!1,!1,r),this._addObject3D(t)}else t.removeAllGeometries(),this._removeObject3D(t)},e.prototype._updateHandleObject=function(t,i,r,n,a,s){if(t.removeAllGeometries(),r&&!a){var o=n?this._params.handleRadiusHovered:this._params.handleRadius;c.scaleTranslateMatrix(o*s.computePixelSizeAt(i),i,this._tempMat4),t.addGeometry(e._handleGeometry,[this._handleMaterial],this._tempMat4)}},e.prototype._updateArea=function(e){switch(this._model.measurementMode){case"euclidean":this._updateAreaEuclidean(e);break;case"geodesic":this._updateAreaGeodesic(e)}},e.prototype._updateAreaEuclidean=function(e){var t=this,i=this._areaObject;if(e.validMeasurement&&0===e.intersectingSegments.size&&e.triangleIndices){var r=[],n=p.vec3d.create();e.positionsFittedRenderCoords.forEach(function(e){p.vec3d.subtract(e,t._origin,n),r.push(n[0],n[1],n[2])});var a=[];e.positionsProjected.forEach(function(e){a.push(e[0],e[1])});var s=new u({position:{size:3,data:r},uv0:{size:2,data:a}},{position:e.triangleIndices,uv0:e.triangleIndices}),o=new _(s,"area");i.removeAllGeometries(),i.addGeometry(o,[this._checkerBoardMaterial],this._originTransform),this._addObject3D(i),this._checkerBoardMaterial.setParameterValues({size:[e.checkerSize,e.checkerSize]})}else i.removeAllGeometries(),this._removeObject3D(i)},e.prototype._updateAreaGeodesic=function(e){var t=this._areaObject;t.removeAllGeometries(),this._removeObject3D(t)},e.prototype._updateProjectionLines=function(e){var t=e.path;this._resizeObject3DArray(this._projectionLineObjects,t.length);for(var i=0;i<t.length;++i)this._updateProjectionLine(e,i);for(var r=1/0,i=0;i<t.length;++i)r=Math.max(this._sceneView._stage.getCamera().computePixelSizeAt(e.positionsRenderCoords[i])),r=Math.max(this._sceneView._stage.getCamera().computePixelSizeAt(e.positionsFittedRenderCoords[i]));this._projectionLineMaterial.setParameterValues({stippleLength:this._params.projectionLineStippleSize*r})},e.prototype._updateProjectionLine=function(e,t){var i=this._projectionLineObjects[t];if(i.removeAllGeometries(),e.validMeasurement&&"euclidean"===this._model.measurementMode){var r=p.vec3d.create();p.vec3d.subtract(this._model.viewData.positionsRenderCoords[t],this._origin,r);var n=p.vec3d.create();p.vec3d.subtract(this._model.viewData.positionsFittedRenderCoords[t],this._origin,n);var a=new _(m.createPolylineGeometry([r,n]),"projected-line");i.addGeometry(a,[this._projectionLineMaterial],this._originTransform),this._addObject3D(i)}else this._removeObject3D(i)},e.prototype._updateLabels=function(e){var t=this,i=this._sceneView._stage.getCamera(),r=this._params.labelDistance,n=this._model,a="geodesic"===n.measurementMode,s="drawing"===n.state,o=function(e,i){return e.visible&&i.visible&&t._sceneView.overlay.overlaps(e.textItem,i.textItem)},l=this._areaLabel,d=h.positionLabelOnPoint(l,e.areaCentroid,i);l.text=n.areaLabel,l.visible=d&&e.validMeasurement&&0===e.intersectingSegments.size&&null!=n.areaLabel;var l=this._pathLengthLabel,c=this._pathLabelSegments[e.pathLengthLabelSegmentIndex],p=this._cursorSegmentLengthLabelSegment,d=h.positionLabelOnCorner(l,c,p,r,i);l.text=n.pathLengthLabel,l.visible=d&&s&&n.path.length>0;var l=this._cursorSegmentLengthLabel,_=this._cursorSegmentLengthLabelSegment,d=h.positionLabelOnSegment(l,_,r,"bottom",i);l.text=n.cursorSegmentLengthLabel,l.visible=d&&s&&n.cursorSegmentLength&&0!==n.cursorSegmentLength.value,o(this._cursorSegmentLengthLabel,this._pathLengthLabel)&&(this._cursorSegmentLengthLabel.visible=!1),o(this._pathLengthLabel,this._areaLabel)&&(this._pathLengthLabel.visible=!1);var l=this._perimeterLengthLabel;if(n.validMeasurement&&0===e.intersectingSegments.size)for(var u=0;u<e.path.length;++u){var m=(e.perimeterLengthLabelSegmentIndex+u)%e.path.length,_=a?this._pathLabelSegments[m]:this._perimeterLabelSegments[m],d=h.positionLabelOnSegment(l,_,r,"top",i);if(l.text=n.perimeterLengthLabel,l.visible=d,!o(l,this._areaLabel))break;l.visible=!1}else l.visible=!1},e.prototype._lastAddedDraggedVertex=function(){var e=this._model.draggedVertices;return e.length>0?e.items[e.length-1]:null},e.prototype._getFocusPoint=function(){var e=this._model,t=this._lastAddedDraggedVertex();switch(e.state){case"drawing":return e.cursorPoint?e.cursorPoint:e.path.vertex(null!=t?t:e.path.length-1);case"editing":return null!=t?e.path.vertex(t):null;default:return e.cursorPoint}},e.prototype._updateLaserLine=function(){var e=this._model,t=this._params.laserLineEnabled&&"measured"!==e.state;this._laserLineRenderer.focusSphereActive=!1,this._laserLineRenderer.segmentActive=!1;var i=this._getFocusPoint();if(t&&i){var r=this._tempHandlePosition;this._sceneView.renderCoordsHelper.toRenderCoords(i,r),this._laserLineRenderer.focusPosition=r,this._laserLineRenderer.focusPlaneActive=!0}else this._laserLineRenderer.focusPlaneActive=!1},e.prototype._addObject3D=function(e){e.parentLayer||(this._layer.addObject(e),this._sceneView._stage.add(S.ContentType.OBJECT,e))},e.prototype._removeObject3D=function(e){e.parentLayer&&(this._layer.removeObject(e),this._sceneView._stage.remove(S.ContentType.OBJECT,e.id))},e.prototype._resizeObject3DArray=function(e,t){var i=this;c.resizeArray(e,t,function(){return new L},function(e){i._removeObject3D(e)})},e.prototype._createInterpolatedLineGeometry=function(e,t,i,r,n,a,s,o,l,h){M.push();var d=this._sceneView.renderCoordsHelper,u=[],g=[],L=function(e,t){var i=M.allocate();p.vec3d.subtract(e,a,i),u.push(i),g.push(t)};if("euclidean"===o){var b=M.allocate();c.midpoint([r,n],b);var v=M.allocate();d.worldUpAtPosition(b,v),L(r,v),L(n,v),l&&l.update(r,n,h)}else{var f=this._getSegmentInterpolator(r,n),w=this._params.lineSubdivisions+1&-2,y=null,S=null,C=w/2-1,P=w/2;"start"===h?(C=0,P=1):"end"===h&&(C=w-2,P=w-1);for(var O=0;O<w;++O){var A=O/(w-1),j=M.allocate(),v=M.allocate();f.eval(A,j),d.worldUpAtPosition(j,v),O===C&&(y=j),O===P&&(S=j),L(j,v)}l&&l.update(y,S,h)}var V=new _(m.createPolylineGeometry(u,g),i);e.removeAllGeometries(),e.addGeometry(V,[t],s),M.pop()},e.prototype._getSegmentInterpolator=function(e,t){var i=this._sceneView.spatialReference,r=this._sceneView.renderCoordsHelper,n=r.spatialReference;return i.isWebMercator||i.isWGS84?new d.Spherical(e,t,n,n):new d.Linear(e,t)},e.prototype._initializeListeners=function(){var e=this;this._listenerHandles=new n,this._listenerHandles.add(this._model.watch("state",function(){e._updateMouseCursor(),e._updateLaserLine()})),this._listenerHandles.add(this._model.draggedVertices.on("change",function(){e._updateLaserLine()})),this._listenerHandles.add(this._model.watch("hoveredVertexHandle",function(){e._updateMouseCursor(),e._updateAfterSyncViewData(function(t){e._updateHandles(t)})})),this._listenerHandles.add(this._model.draggedVertices.on("change",function(){e._updateMouseCursor(),e._updateAfterSyncViewData(function(t){e._updateHandles(e._model.viewData)})})),this._listenerHandles.add(this._model.watch("cursorPoint",function(){e._updateAfterSyncViewData(function(t){e._updateCursorSegment(t),e._updateCursorHandle(t),"drawing"===e._model.state&&e._updateLabels(t),e._updateLaserLine()})})),this._listenerHandles.add(this._sceneView.state.watch("camera",function(){e._updateAfterSyncViewData(function(t){e._updateCameraDependent(e._model.viewData)})})),this._listenerHandles.add(this._model.watch(["unit","measurementMode"],function(){e._updateAll(e._model.viewData)})),this._listenerHandles.add(this._model.watch("viewData",function(t){e._syncViewData(t)}))},e.prototype._destroyListeners=function(){this._listenerHandles.destroy(),this._listenerHandles=null},e._handleGeometry=new _(m.createSphereGeometry(1,32,32),"handle"),e}();return function(e){var t=function(){function e(){}return e}();e.PickRequest=t;var i=function(){function e(e,t,i){void 0===e&&(e=null),void 0===t&&(t=null),void 0===i&&(i=null),this.type=e,this.scenePoint=t,this.mapPoint=i}return e}();e.PickResult=i}(O||(O={})),O});