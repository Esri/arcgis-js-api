/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../../../chunks/_rollupPluginBabelHelpers","../../../../../Color","../../../../../core/analysisThemeUtils","../../../../../core/Handles","../../../../../core/lang","../../../../../core/maybe","../../../../../core/reactiveUtils","../../../../../core/screenUtils","../../../../../chunks/vec3f64","../../manipulatorUtils","../support/PickRequest","../../visualElements/LaserlineVisualElement","../../../webgl-engine/lib/Intersector","../../../webgl-engine/lib/IntersectorInterfaces","../../../../interactive/ManipulatorCollection"],(function(t,e,i,s,a,n,l,r,o,h,u,c,d,_,p){"use strict";function y(t,e,i,s){for(;t.length<e;)t.push(i());if(s)for(;t.length>e;){s(t.pop())}else t.length=e}return function(){function g(t){this.vertexManipulators=[],this._destroyed=!1,this._isManipulatorsOwner=!0,this._visible=!0,this._laserLine=null,this._cursorManipulator=null,this._listenerHandles=null,this._tempHandlePosition=o.create(),this._defaultStyle={laserLineGlowColor:e.toUnitRGB(i.getAccentColor()),laserLineGlowWidth:8,laserLineGlowFalloff:8,laserLineInnerColor:e.toUnitRGB(i.getContrastColor()),laserLineInnerWidth:1,laserLineGlobalAlpha:.75,laserLineEnabled:!0,handleColor:e.toUnitRGB(i.getAccentColor()),handleOpacity:.5,handleRadius:5,handleRadiusHovered:10,handleRadiusMouse:10,handleRadiusTouch:25};const{analysisViewData:s,manipulators:n,toolState:l,view:r,visible:u}=t;this._analysisViewData=s,this._toolState=l,null!=n?(this._manipulators=n,this._isManipulatorsOwner=!1):this._manipulators=new p.ManipulatorCollection,this._view=r;const y=this._style={...this._defaultStyle,...a.clone(t.style)};this._intersector=d.newIntersector(r.state.viewingMode),this._intersector.options.store=_.StoreResults.MIN;const g=h.createSphereManipulator(r,y.handleColor,y.handleOpacity);g.available=!1,g.radius=y.handleRadius,g.interactive=!1,this._manipulators.add(g),this._cursorManipulator=g,this._laserLine=new c.LaserlineVisualElement({view:r,attached:!0,style:{glowColor:y.laserLineGlowColor,glowWidth:y.laserLineGlowWidth,glowFalloff:y.laserLineGlowFalloff,innerColor:y.laserLineInnerColor,innerWidth:y.laserLineInnerWidth,globalAlpha:y.laserLineGlobalAlpha}}),this._updateVisibility(u||!0)}var w=g.prototype;return w.destroy=function(){this._listenerHandles=n.destroyMaybe(this._listenerHandles),this._isManipulatorsOwner?this._manipulators=n.destroyMaybe(this._manipulators):this._manipulators=null,this._laserLine=n.destroyMaybe(this._laserLine),this._destroyed=!0},w.show=function(){this._setVisibility(!0)},w.hide=function(){this._setVisibility(!1)},w._setVisibility=function(t){this._destroyed||this._visible===t||this._updateVisibility(t)},w._updateVisibility=function(t){this._visible=t,this._laserLine.visible=t,t?(this._initializeListeners(),this._updateAll()):(this._destroyListeners(),this.vertexManipulators.forEach((t=>this._removeVertexManipulator(t))),this.vertexManipulators=[],this._view.cursor=null)},w.vertexHandleAt=function(t,e){const i=this._manipulators.intersect(t,e);return n.isSome(i)?i.metadata:null},w.pick=function(t){const e=this._view.spatialReference,i=r.screenPointObjectToArray(t.screenPoint);this._view.sceneIntersectionHelper.intersectToolIntersectorScreen(i,this._intersector);const s=this._intersector.results.min,a=o.create();if(!s.getIntersectionPoint(a))return null;const l=this._view.renderCoordsHelper.fromRenderCoords(a,e);return n.isNone(l)?null:new u.PickResult(a,l)},w._updateAll=function(){this._visible&&(this._updateVertexManipulators(),this._updateLaserLine())},w._createVertexManipulator=function(){const t=h.createSphereManipulator(this._view,this._style.handleColor,this._style.handleOpacity);return t.radius=this._style.handleRadius,this._manipulators.add(t),t},w._removeVertexManipulator=function(t){this._manipulators.remove(t)},w._updateVertexManipulators=function(){const{viewData:t}=this._analysisViewData,e=this._analysisViewData.path?this._analysisViewData.path.vertices:[],i=this.vertexManipulators;y(i,e.length,(()=>this._createVertexManipulator()),(t=>this._removeVertexManipulator(t))),i.forEach(((i,s)=>{i.metadata=e[s],i.renderLocation=t.positionsRenderCoords[s],i.cursor=0===s&&"drawing"===this._toolState.polygonState?"crosshair":null})),"drawing"===this._toolState.polygonState&&n.isSome(this._analysisViewData.cursorPoint)?(this._cursorManipulator.available=!0,this._cursorManipulator.location=this._analysisViewData.cursorPoint):this._cursorManipulator.available=!1},w._getFocusPoint=function(){const{lastDraggedVertex:t}=this._analysisViewData;switch(this._toolState.polygonState){case"drawing":return n.isSome(this._analysisViewData.cursorPoint)?this._analysisViewData.cursorPoint:n.isSome(t)?this._analysisViewData.path.getVertexPositionAsPoint(t):n.unwrap(this._analysisViewData.path.lastPoint);case"editing":return n.isSome(t)?this._analysisViewData.path.getVertexPositionAsPoint(t):null;default:return this._analysisViewData.cursorPoint}},w._updateLaserLine=function(){const t=this._style.laserLineEnabled&&"measured"!==this._toolState.polygonState&&this._toolState.active,e=this._getFocusPoint();if(t&&n.isSome(e)){const t=this._tempHandlePosition;this._view.renderCoordsHelper.toRenderCoords(e,t),this._laserLine.heightManifoldTarget=t}else this._laserLine.heightManifoldTarget=null},w._initializeListeners=function(){this._listenerHandles=new s,this._listenerHandles.add([l.watch((()=>this._toolState.polygonState),(()=>this._updateLaserLine())),l.watch((()=>this._analysisViewData.viewData),(()=>this._updateAll()),l.sync),l.watch((()=>({lastDraggedVertex:this._analysisViewData.lastDraggedVertex,cursorPoint:this._analysisViewData.cursorPoint})),(()=>this._updateLaserLine())),l.watch((()=>this._toolState.active),(()=>this._updateAll()))])},w._destroyListeners=function(){this._listenerHandles=n.destroyMaybe(this._listenerHandles)},t._createClass(g,[{key:"destroyed",get:function(){return this._destroyed}},{key:"visible",get:function(){return this._visible},set:function(t){t?this.show():this.hide()}},{key:"testData",get:function(){const t=this._laserLine.testData;return{laserLineRenderer:n.isSome(t)?{heightManifoldEnabled:t.heightManifoldEnabled,heightManifoldTarget:t.heightManifoldTarget,pointDistanceEnabled:t.pointDistanceEnabled,pointDistanceOrigin:t.pointDistanceOrigin,pointDistanceTarget:t.pointDistanceTarget,lineVerticalPlaneEnabled:t.lineVerticalPlaneEnabled}:{heightManifoldEnabled:!1,heightManifoldTarget:null,pointDistanceEnabled:!1,pointDistanceOrigin:null,pointDistanceTarget:null,lineVerticalPlaneEnabled:!1}}}}]),g}()}));
