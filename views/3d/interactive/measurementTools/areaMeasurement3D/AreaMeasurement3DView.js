/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["../../../../../chunks/_rollupPluginBabelHelpers","../../../../../Color","../../../../../core/analysisThemeUtils","../../../../../core/Handles","../../../../../core/lang","../../../../../core/maybe","../../../../../core/reactiveUtils","../../../../../core/screenUtils","../../../../../chunks/vec3f64","../../manipulatorUtils","../support/PickRequest","../../visualElements/LaserlineVisualElement","../../../webgl-engine/lib/GeometryUtil","../../../webgl-engine/lib/Intersector","../../../webgl-engine/lib/IntersectorInterfaces","../../../../interactive/ManipulatorCollection"],(function(e,t,i,s,a,n,l,r,o,h,u,c,d,_,p,y){"use strict";let g=function(){function a(e){this.vertexManipulators=[],this._analysisViewData=null,this._destroyed=!1,this._isManipulatorsOwner=!0,this._visible=!0,this._laserLine=null,this._cursorManipulator=null,this._listenerHandles=null,this._tempHandlePosition=o.create(),this._defaultStyle={laserLineGlowColor:t.toUnitRGB(i.getAccentColor()),laserLineGlowWidth:8,laserLineGlowFalloff:8,laserLineInnerColor:t.toUnitRGB(i.getContrastColor()),laserLineInnerWidth:1,laserLineGlobalAlpha:.75,laserLineEnabled:!0,handleColor:t.toUnitRGB(i.getAccentColor()),handleOpacity:.5,handleRadius:5,handleRadiusHovered:10,handleRadiusMouse:10,handleRadiusTouch:25};const{analysisViewData:s,manipulators:a,toolState:n,view:l,visible:r}=e;this._analysisViewData=s,this._toolState=n,null!=a?(this._manipulators=a,this._isManipulatorsOwner=!1):this._manipulators=new y.ManipulatorCollection,this._view=l;const u=this._style=w(this._defaultStyle,e.style);this._intersector=_.newIntersector(l.state.viewingMode),this._intersector.options.store=p.StoreResults.MIN;const d=h.createSphereManipulator(l,u.handleColor,u.handleOpacity);d.available=!1,d.radius=u.handleRadius,d.interactive=!1,this._manipulators.add(d),this._cursorManipulator=d,this._laserLine=new c.LaserlineVisualElement({view:l,attached:!0,style:{glowColor:u.laserLineGlowColor,glowWidth:u.laserLineGlowWidth,glowFalloff:u.laserLineGlowFalloff,innerColor:u.laserLineInnerColor,innerWidth:u.laserLineInnerWidth,globalAlpha:u.laserLineGlobalAlpha}}),this._updateVisibility(r||!0)}var d=a.prototype;return d.destroy=function(){this._listenerHandles=n.destroyMaybe(this._listenerHandles),this._isManipulatorsOwner?this._manipulators=n.destroyMaybe(this._manipulators):this._manipulators=null,this._laserLine=n.destroyMaybe(this._laserLine),this._destroyed=!0},d.show=function(){this._setVisibility(!0)},d.hide=function(){this._setVisibility(!1)},d._setVisibility=function(e){this._destroyed||this._visible===e||this._updateVisibility(e)},d._updateVisibility=function(e){this._visible=e,this._laserLine.visible=e,e?(this._initializeListeners(),this._updateAll()):(this._destroyListeners(),this.vertexManipulators.forEach((e=>this._removeVertexManipulator(e))),this.vertexManipulators=[],this._view.cursor=null)},d.vertexHandleAt=function(e,t){const i=this._manipulators.intersect(e,t);return n.isSome(i)?i.metadata:null},d.pick=function(e){const t=this._view.spatialReference,i=r.screenPointObjectToArray(e.screenPoint);this._view.sceneIntersectionHelper.intersectToolIntersectorScreen(i,this._intersector);const s=this._intersector.results.min,a=o.create();if(!s.getIntersectionPoint(a))return null;const l=this._view.renderCoordsHelper.fromRenderCoords(a,t);return n.isNone(l)?null:new u.PickResult(a,l)},d._updateAll=function(){this._visible&&(this._updateVertexManipulators(),this._updateLaserLine())},d._createVertexManipulator=function(){const e=h.createSphereManipulator(this._view,this._style.handleColor,this._style.handleOpacity);return e.radius=this._style.handleRadius,this._manipulators.add(e),e},d._removeVertexManipulator=function(e){this._manipulators.remove(e)},d._updateVertexManipulators=function(){const{viewData:e}=this._analysisViewData,t=this._analysisViewData.path?this._analysisViewData.path.vertices:[],i=this.vertexManipulators;f(i,t.length,(()=>this._createVertexManipulator()),(e=>this._removeVertexManipulator(e))),i.forEach(((i,s)=>{i.metadata=t[s],i.renderLocation=e.positionsRenderCoords[s],i.cursor=0===s&&"drawing"===this._toolState.polygonState?"crosshair":null})),"drawing"===this._toolState.polygonState&&n.isSome(this._analysisViewData.cursorPoint)?(this._cursorManipulator.available=!0,this._cursorManipulator.location=this._analysisViewData.cursorPoint):this._cursorManipulator.available=!1},d._getFocusPoint=function(){const{lastDraggedVertex:e}=this._analysisViewData;switch(this._toolState.polygonState){case"drawing":return n.isSome(this._analysisViewData.cursorPoint)?this._analysisViewData.cursorPoint:n.isSome(e)?this._analysisViewData.path.getVertexPositionAsPoint(e):n.unwrap(this._analysisViewData.path.lastPoint);case"editing":return n.isSome(e)?this._analysisViewData.path.getVertexPositionAsPoint(e):null;default:return this._analysisViewData.cursorPoint}},d._updateLaserLine=function(){const e=this._style.laserLineEnabled&&"measured"!==this._toolState.polygonState&&this._toolState.active,t=this._getFocusPoint();if(e&&n.isSome(t)){const e=this._tempHandlePosition;this._view.renderCoordsHelper.toRenderCoords(t,e),this._laserLine.heightManifoldTarget=e}else this._laserLine.heightManifoldTarget=null},d._initializeListeners=function(){this._listenerHandles=new s,this._listenerHandles.add([l.watch((()=>this._toolState.polygonState),(()=>this._updateLaserLine())),l.watch((()=>this._analysisViewData.viewData),(()=>this._updateAll()),l.sync),l.watch((()=>({lastDraggedVertex:this._analysisViewData.lastDraggedVertex,cursorPoint:this._analysisViewData.cursorPoint})),(()=>this._updateLaserLine())),l.watch((()=>this._toolState.active),(()=>this._updateAll()))])},d._destroyListeners=function(){this._listenerHandles=n.destroyMaybe(this._listenerHandles)},e._createClass(a,[{key:"destroyed",get:function(){return this._destroyed}},{key:"visible",get:function(){return this._visible},set:function(e){e?this.show():this.hide()}},{key:"testData",get:function(){const e=this._laserLine.testData;return{laserLineRenderer:n.isSome(e)?{heightManifoldEnabled:e.heightManifoldEnabled,heightManifoldTarget:e.heightManifoldTarget,pointDistanceEnabled:e.pointDistanceEnabled,pointDistanceOrigin:e.pointDistanceOrigin,pointDistanceTarget:e.pointDistanceTarget,lineVerticalPlaneEnabled:e.lineVerticalPlaneEnabled}:{heightManifoldEnabled:!1,heightManifoldTarget:null,pointDistanceEnabled:!1,pointDistanceOrigin:null,pointDistanceTarget:null,lineVerticalPlaneEnabled:!1}}}}]),a}();function w(e,t){return{...e,...a.clone(t)}}function f(e,t,i,s){for(;e.length<t;)e.push(i());if(s)for(;e.length>t;){s(e.pop())}else e.length=t}return g._handleGeometry=d.createSphereGeometry(1,32,32),g}));
