/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["../../../../../core/Handles","../../../../../core/maybe","../../../../../layers/graphics/hydratedFeatures","../../editingTools/dragEventPipeline3D","./AreaMeasurement3DView","../../../../interactive/dragEventPipeline","../../../../support/screenUtils"],(function(e,t,i,n,s,o,a){"use strict";function r(e){return"mouse"!==e.pointerType||0===e.button}return function(){function h(t,i,n){this._manipulators=n,this._handles=new e,this._tempPickRequest=new s.PickRequest,this.model=t,this.view=i,this._setupManipulators()}var d=h.prototype;return d.destroy=function(){this._handles.destroy(),this._handles=null},d.handleInputEvent=function(e){switch(e.type){case"immediate-double-click":this._handleImmediateDoubleClick(e);break;case"immediate-click":this._handleImmediateClick(e);break;case"pointer-move":this._handlePointerMove(e);break;case"drag":this._handleDrag(e);break;case"key-down":this._handleKeyDown(e)}},d._setupManipulators=function(){const e=e=>`manipulator-${e}`;let s=0;const a=e=>i=>("start"===i.action&&(s++,this.view.lastDraggedVertex=t.unwrap(this.view.manipulatorToVertex(e)),"measured"===this.model.state&&(this.model.state="editing")),i),r=()=>e=>"end"===e.action?(s--,0===s&&"editing"===this.model.state&&(this.model.state="measured"),null):e,h=(s,h)=>{this._handles.add([o.createManipulatorDragEventPipeline(h,((e,s,o)=>{const h=n.hideManipulatorWhileDragging(e),d=t.unwrap(this.view.manipulatorToVertex(e));s.next(a(e)).next(h).next(r()).next(this.view.screenToMap3D()).next((t=>{e.location=t.mapEnd,this.view.path.setVertexPosition(d,i.clonePoint(t.mapEnd))}));const l=i.clonePoint(this.view.path.getVertexPositionAsPoint(d));o.next(h).next((()=>{this.view.path.setVertexPosition(d,l),e.location=l}))}))],e(s))},d=t=>{this._handles.remove(e(t))};this._manipulators.forEach((({id:e,manipulator:t})=>{h(e,t)})),this._handles.add([this._manipulators.on("after-add",(({item:{id:e,manipulator:t}})=>{h(e,t)})),this._manipulators.on("after-remove",(({item:{id:e}})=>{d(e)}))])},d._handleImmediateDoubleClick=function(e){r(e)&&("drawing"===this.model.state&&this.view.finishMeasurement(),e.stopPropagation())},d._handleDrag=function(e){"editing"===this.model.state&&e.stopPropagation()},d._handleImmediateClick=function(e){if(!r(e))return;const i=a.createScreenPointFromEvent(e);if(this.model.active)switch(this.model.state){case"initial":if(this._addVertexAt(i))return this.view.cursorPoint=null,this.model.state="drawing",void e.stopPropagation();break;case"drawing":{const n=this.view.vertexHandleAt(i,e.pointerType);if(t.isNone(n)){if(this._addVertexAt(i))return this.view.cursorPoint=null,void e.stopPropagation()}else 0===n.index&&(this.view.finishMeasurement(),e.stopPropagation());break}}"mouse"===e.pointerType&&this._hoverAt(i)},d._handlePointerMove=function(e){if("mouse"===e.pointerType){const t=a.createScreenPointFromEvent(e);this._hoverAt(t)}},d._handleKeyDown=function(e){"Enter"===e.key&&"drawing"===this.model.state&&(this.view.finishMeasurement(),e.stopPropagation())},d._hoverAt=function(e){if(this.view.requiresCursorPoint){const t=this._pick(e);t.mapPoint&&(this.view.cursorPoint=t.mapPoint)}else this.view.cursorPoint=null},d._addVertexAt=function(e){const t=this._pick(e);return!!t.mapPoint&&(this.view.path.add(t.mapPoint),!0)},d._pick=function(e){const t=this._tempPickRequest;return t.screenPoint=e,this.view.pick(t)},h}()}));
