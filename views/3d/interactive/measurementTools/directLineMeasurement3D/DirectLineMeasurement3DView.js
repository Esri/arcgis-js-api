/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../core/Accessor","../../../../../core/Handles","../../../../../core/maybe","../../../../../core/reactiveUtils","../../../../../core/screenUtils","../../../../../core/watchUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/arrayUtils","../../../../../core/has","../../../../../core/accessorSupport/ensureType","../../../../../core/accessorSupport/decorators/subclass","../../../../../chunks/vec3f64","../../../../../geometry/support/lineSegment","../../manipulatorUtils","./PickResult","../support/viewUtils","../../visualElements/LaserlineVisualElement","../../../support/ElevationProvider","../../../webgl-engine/lib/Intersector"],(function(e,t,i,n,s,r,a,o,l,c,u,d,h,p,y,_,m,w,g,v,f,b){"use strict";const L={laserLineGlowColor:[1,.5,0],laserLineGlowWidth:8,laserLineGlowFalloff:8,laserLineInnerColor:[1,1,1],laserLineInnerWidth:.75,laserLineGlobalAlpha:.75,laserLineEnabled:!0,handleColor:[1,.5,0],handleOpacity:.5,handleRadius:5};var D;!function(e){e.Manipulators="manipulators",e.AnalysisViewDestroyed="analysis-view-destroyed",e.AnalysisView="analysis-view"}(D||(D={})),e.DirectLineMeasurement3DView=function(e){function i(t){var i;return(i=e.call(this,t)||this)._state="pending",i.analysisView=null,i.cursorPoint=null,i._visible=!1,i._laserLine=null,i._handles=new s,i._lastDraggedHandle=null,i}t._inheritsLoose(i,e);var n=i.prototype;return n.normalizeCtorArgs=function(e){return{...e,params:e.params?g.copyParameter(L,e.params):g.copyParameter(L,{})}},n.initialize=function(){this._intersector=b.newIntersector(this.view.state.viewingMode),this._intersector.options.store=0,this._promise=this._initialize()},n._initialize=function(){var e=t._asyncToGenerator((function*(){switch(this._state){case"pending":break;case"destroyed":return Promise.reject("DirectLineMeasurement3DView already destroyed")}const e=yield this.view.whenAnalysisView(this.analysis);return yield e.whenReady(),this._set("analysisView",e),this._laserLine=new v.LaserlineVisualElement({view:this.view,attached:!0}),this._visible&&this._updateVisibility(this._visible),this._connectToAnalysisView(),this._state="ready",e}));function i(){return e.apply(this,arguments)}return i}(),n.destroy=function(){switch(this._state){case"pending":return void(this._state="destroyed");case"ready":break;default:return}this.hide(),this._handles=r.destroyMaybe(this._handles),this._laserLine=r.destroyMaybe(this._laserLine),this._state="destroyed"},n.when=function(){return this._promise.then((()=>{}))},n.whenMessages=function(){var e=t._asyncToGenerator((function*(){const e=yield this._promise;yield l.whenNotOnce(e,"updating")}));function i(){return e.apply(this,arguments)}return i}(),n.createManipulators=function(){const e=()=>{const e=m.createSphereManipulator(this.view,this.params.handleColor,this.params.handleOpacity);return e.available=!1,e.radius=this.params.handleRadius,e},t=e(),i=e();r.isSome(this.analysis.startPoint)&&(t.location=this.analysis.startPoint,t.available=!0),r.isSome(this.analysis.endPoint)&&(i.location=this.analysis.endPoint,i.available=!0);const n=()=>{let e=this._lastDraggedHandle;t.grabbing&&!i.grabbing&&(e="start"),i.grabbing&&!t.grabbing&&(e="end"),t.grabbing||i.grabbing||(e=null),this._lastDraggedHandle=e},s=t.events.on("grab-changed",n),a=i.events.on("grab-changed",n);return this._handles.add([s,a],D.Manipulators),{start:t,end:i}},n.show=function(){switch(this._state){case"ready":this._visible||this._updateVisibility(!0);break;case"pending":this._visible=!0;break;default:return}},n.hide=function(){switch(this._state){case"ready":this._visible&&this._updateVisibility(!1);break;case"pending":this._visible=!1;break;default:return}},n.clearMeasurement=function(){this.toolState.lineState="initial",this._clearOverride("measurementSurfaceLocation")},n.finishMeasurement=function(){if(!this._isOverridden("measurementSurfaceLocation")){const e=this.measurementSurfaceLocation,t="camera-dependent"===e?this.view.state.camera.aboveGround?"above-the-surface":"below-the-surface":e;this._override("measurementSurfaceLocation",t)}this.toolState.lineState="measured"},n._connectToAnalysisView=function(){this._handles.remove(D.AnalysisView),this._handles.add([a.react((()=>r.applySome(this.analysisView,(e=>e.destroyed))),(e=>{e&&this._handles.remove(D.AnalysisView)}),a.initial),a.react((()=>["measured"===this.toolState.lineState,this.analysisView]),(([e,t])=>{r.isSome(t)&&!t.destroyed&&(t.allowVisualElementsOrientationChange=!e)}),a.initial),a.react((()=>this._laserLineParams),(e=>{const t=this._laserLine;t.heightManifoldTarget=e.heightManifoldTarget,t.pointDistanceLine=e.pointDistanceLine,t.lineVerticalPlaneSegment=e.lineVerticalPlaneSegment}),a.initial)],D.AnalysisView)},n._updateVisibility=function(e){this._visible=e,this.analysis.visible=e,e?this._laserLine.style={innerColor:this.params.laserLineInnerColor,innerWidth:this.params.laserLineInnerWidth,glowColor:this.params.laserLineGlowColor,glowWidth:this.params.laserLineGlowWidth,glowFalloff:this.params.laserLineGlowFalloff,globalAlpha:this.params.laserLineGlobalAlpha}:this.view.cursor=null,this._laserLine.visible=e},n.pick=function(e){const t=this.view.spatialReference,i=o.screenPointObjectToArray(e.screenPoint);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(i,this._intersector);const n=this._intersector.results.min,s=y.create();if(!n.getIntersectionPoint(s))return new w.PickResult;const a=this.view.renderCoordsHelper.fromRenderCoords(s,t);if(r.isNone(a))return new w.PickResult;const l=2===n.intersector?"ground":"feature";return new w.PickResult(l,s,a)},n.getElevation=function(e){return this.view.basemapTerrain.ready?r.unwrapOr(f.getElevationAtPoint(this.view.elevationProvider,e),0):0},n.overlappingHandles=function(e,t){return g.pointToPointScreenDistance(e,t,this.view)<=this.params.handleRadius},t._createClass(i,[{key:"requiresCursorPoint",get:function(){return"initial"===this.toolState.lineState&&this.toolState.active}},{key:"visible",get:function(){return this._visible},set:function(e){e?this.show():this.hide()}},{key:"viewMode",get:function(){const e=this.analysisView;return r.isSome(e)&&!e.destroyed?e.viewMode:0}},{key:"measurementMode",get:function(){const e=this.analysisView;return r.isSome(e)&&!e.destroyed?e.actualVisualizedMeasurement:"euclidean"}},{key:"testData",get:function(){const e=this._laserLine.testData,t=r.unwrap(this.analysisView).testData;return{labels:null==t?void 0:t.labels,stripeLength:null==t?void 0:t.stripeLength,laserLineRenderer:{heightManifoldEnabled:!!r.isSome(e)&&e.heightManifoldEnabled,heightManifoldTarget:r.isSome(e)?e.heightManifoldTarget:null,pointDistanceEnabled:!!r.isSome(e)&&e.pointDistanceEnabled,pointDistanceOrigin:r.isSome(e)?e.pointDistanceOrigin:null,pointDistanceTarget:r.isSome(e)?e.pointDistanceTarget:null,lineVerticalPlaneEnabled:!!r.isSome(e)&&e.lineVerticalPlaneEnabled}}}},{key:"directLabelText",get:function(){const e=this.analysisView;return r.isSome(e)&&!e.destroyed?e.directLabelText:null}},{key:"horizontalLabelText",get:function(){const e=this.analysisView;return r.isSome(e)&&!e.destroyed?e.horizontalLabelText:null}},{key:"verticalLabelText",get:function(){const e=this.analysisView;return r.isSome(e)&&!e.destroyed?e.verticalLabelText:null}},{key:"_cursorPosition",get:function(){const e=y.create();return r.applySome(this.cursorPoint,(t=>this.view.renderCoordsHelper.toRenderCoords(t,e))),e}},{key:"_startPosition",get:function(){const e=y.create();return r.applySome(this.analysis.startPoint,(t=>this.view.renderCoordsHelper.toRenderCoords(t,e))),e}},{key:"_endPosition",get:function(){const e=y.create();return r.applySome(this.analysis.endPoint,(t=>this.view.renderCoordsHelper.toRenderCoords(t,e))),e}},{key:"_laserLineParams",get:function(){const e=this._focusPosition,{active:t,lineState:i}=this.toolState,n=this.viewMode,s=this.analysisView,a=this.params.laserLineEnabled&&!!e&&"measured"!==i&&t;if(!a||!this.visible||r.isNone(s)||s.destroyed)return{heightManifoldTarget:null,pointDistanceLine:null,lineVerticalPlaneSegment:null};const o=s.actualVisualizedMeasurement,l=a&&2===n;return{heightManifoldTarget:"euclidean"===o?e:null,pointDistanceLine:"local"!==this.view.viewingMode&&a&&!!this.analysis.startPoint&&"geodesic"===o?this._pointDistanceLine:null,lineVerticalPlaneSegment:l?_.fromPoints(this._startPosition,this._endPosition):null}}},{key:"_focusPosition",get:function(){const{lineState:e}=this.toolState,t=this.analysisView,i=r.isSome(t)&&!t.destroyed&&1===t.measurementMode,n=1===this.viewMode&&i;switch(e){case"drawing":return n?this._startPosition:this.analysis.endPoint?this._endPosition:this._startPosition;case"editing":return n?"start"===this._lastDraggedHandle?this._endPosition:this._startPosition:"start"===this._lastDraggedHandle?this._startPosition:this._endPosition;default:return r.isSome(this.cursorPoint)?this._cursorPosition:null}}},{key:"_pointDistanceLine",get:function(){return{origin:"drawing"===this.toolState.lineState||"end"===this._lastDraggedHandle?this._startPosition:this._endPosition,target:this._focusPosition}}},{key:"measurementSurfaceLocation",get:function(){const e=this.toolState.startPointSurfaceLocation,t=this.toolState.endPointSurfaceLocation;return null==e||null==t||"above-the-surface"===e&&"below-the-surface"===t||"below-the-surface"===e&&"above-the-surface"===t||"on-the-surface"===e&&"on-the-surface"===t?"camera-dependent":"above-the-surface"===e||"above-the-surface"===t?"above-the-surface":"below-the-surface"}}]),i}(n),i.__decorate([c.property()],e.DirectLineMeasurement3DView.prototype,"view",void 0),i.__decorate([c.property()],e.DirectLineMeasurement3DView.prototype,"params",void 0),i.__decorate([c.property({readOnly:!0})],e.DirectLineMeasurement3DView.prototype,"analysisView",void 0),i.__decorate([c.property()],e.DirectLineMeasurement3DView.prototype,"analysis",void 0),i.__decorate([c.property()],e.DirectLineMeasurement3DView.prototype,"cursorPoint",void 0),i.__decorate([c.property()],e.DirectLineMeasurement3DView.prototype,"toolState",void 0),i.__decorate([c.property()],e.DirectLineMeasurement3DView.prototype,"requiresCursorPoint",null),i.__decorate([c.property()],e.DirectLineMeasurement3DView.prototype,"visible",null),i.__decorate([c.property()],e.DirectLineMeasurement3DView.prototype,"viewMode",null),i.__decorate([c.property()],e.DirectLineMeasurement3DView.prototype,"measurementMode",null),i.__decorate([c.property()],e.DirectLineMeasurement3DView.prototype,"testData",null),i.__decorate([c.property()],e.DirectLineMeasurement3DView.prototype,"directLabelText",null),i.__decorate([c.property()],e.DirectLineMeasurement3DView.prototype,"horizontalLabelText",null),i.__decorate([c.property()],e.DirectLineMeasurement3DView.prototype,"verticalLabelText",null),i.__decorate([c.property()],e.DirectLineMeasurement3DView.prototype,"_visible",void 0),i.__decorate([c.property()],e.DirectLineMeasurement3DView.prototype,"_laserLine",void 0),i.__decorate([c.property()],e.DirectLineMeasurement3DView.prototype,"_cursorPosition",null),i.__decorate([c.property()],e.DirectLineMeasurement3DView.prototype,"_startPosition",null),i.__decorate([c.property()],e.DirectLineMeasurement3DView.prototype,"_endPosition",null),i.__decorate([c.property()],e.DirectLineMeasurement3DView.prototype,"_lastDraggedHandle",void 0),i.__decorate([c.property()],e.DirectLineMeasurement3DView.prototype,"_laserLineParams",null),i.__decorate([c.property()],e.DirectLineMeasurement3DView.prototype,"_focusPosition",null),i.__decorate([c.property()],e.DirectLineMeasurement3DView.prototype,"_pointDistanceLine",null),i.__decorate([c.property()],e.DirectLineMeasurement3DView.prototype,"measurementSurfaceLocation",null),e.DirectLineMeasurement3DView=i.__decorate([p.subclass("esri.views.3d.interactive.measurementTools.directLineMeasurement3D.DirectLineMeasurement3DView")],e.DirectLineMeasurement3DView),Object.defineProperty(e,"__esModule",{value:!0})}));
