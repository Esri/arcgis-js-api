/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../core/Accessor","../../../../../core/Handles","../../../../../core/maybe","../../../../../core/reactiveUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/arrayUtils","../../../../../core/has","../../../../../core/accessorSupport/ensureType","../../../../../core/accessorSupport/decorators/subclass","../../../../../chunks/vec3f64","../../../../../geometry/support/lineSegment","../../../analysis/interfaces","../../../analysis/DirectLineMeasurement/interfaces","../../manipulatorUtils","../../visualElements/LaserlineVisualElement"],(function(e,i,t,n,s,a,r,o,l,c,d,h,u,p,y,_,g,m){"use strict";const w={laserLineGlowColor:[1,.5,0],laserLineGlowWidth:8,laserLineGlowFalloff:8,laserLineInnerColor:[1,1,1],laserLineInnerWidth:.75,laserLineGlobalAlpha:.75,handleColor:[1,.5,0],handleOpacity:.5,handleRadius:5};var D;!function(e){e.Manipulators="manipulators",e.AnalysisViewDestroyed="analysis-view-destroyed",e.AnalysisView="analysis-view"}(D||(D={})),e.DirectLineMeasurement3DView=function(e){function t(i){var t;return(t=e.call(this,i)||this).params=w,t.analysisView=null,t.cursorPoint=null,t._visible=!1,t._laserLine=null,t.laserLineEnabled=!0,t._handles=new s,t._lastDraggedHandle=null,t}i._inheritsLoose(t,e);var n=t.prototype;return n.initialize=function(){this._laserLine=new m.LaserlineVisualElement({view:this.view,attached:!0}),this._updateVisibility(this._visible),this._connectToAnalysisView()},n.destroy=function(){this._handles=a.destroyMaybe(this._handles),this._laserLine=a.destroyMaybe(this._laserLine)},n.whenMessages=function(){var e=i._asyncToGenerator((function*(){yield r.whenOnce((()=>!this.analysisView.updating))}));function t(){return e.apply(this,arguments)}return t}(),n.createManipulators=function(){const e=()=>{const e=g.createSphereManipulator(this.view,this.params.handleColor,this.params.handleOpacity);return e.available=!1,e.radius=this.params.handleRadius,e},i=e(),t=e();a.isSome(this.analysis.startPoint)&&(i.location=this.analysis.startPoint,i.available=!0),a.isSome(this.analysis.endPoint)&&(t.location=this.analysis.endPoint,t.available=!0);const n=()=>{let e=this._lastDraggedHandle;i.grabbing&&!t.grabbing&&(e="start"),t.grabbing&&!i.grabbing&&(e="end"),i.grabbing||t.grabbing||(e=null),this._lastDraggedHandle=e},s=i.events.on("grab-changed",n),r=t.events.on("grab-changed",n);return this._handles.add([s,r],D.Manipulators),{start:i,end:t}},n.show=function(){this.destroyed||this._visible||this._updateVisibility(!0)},n.hide=function(){!this.destroyed&&this._visible&&this._updateVisibility(!1)},n._connectToAnalysisView=function(){this._handles.remove(D.AnalysisView),this._handles.add([r.watch((()=>a.applySome(this.analysisView,(e=>e.destroyed))),(e=>{e&&this._handles.remove(D.AnalysisView)}),r.initial),r.watch((()=>["measured"===this.toolState.lineState,this.analysisView]),(([e,i])=>{a.isSome(i)&&!i.destroyed&&(i.allowVisualElementsOrientationChange=!e)}),r.initial),r.watch((()=>this._laserLineParams),(e=>{const i=this._laserLine;i.heightManifoldTarget=e.heightManifoldTarget,i.pointDistanceLine=e.pointDistanceLine,i.lineVerticalPlaneSegment=e.lineVerticalPlaneSegment}),r.initial)],D.AnalysisView)},n._updateVisibility=function(e){this.constructed&&(this._visible=e,this.analysis.visible=e,e?this._laserLine.style={innerColor:this.params.laserLineInnerColor,innerWidth:this.params.laserLineInnerWidth,glowColor:this.params.laserLineGlowColor,glowWidth:this.params.laserLineGlowWidth,glowFalloff:this.params.laserLineGlowFalloff,globalAlpha:this.params.laserLineGlobalAlpha}:this.view.cursor=null,this._laserLine.visible=e)},i._createClass(t,[{key:"visible",get:function(){return this._visible},set:function(e){e?this.show():this.hide()}},{key:"testData",get:function(){const e=this._laserLine.testData,i=this.analysisView.testData;return{labels:null==i?void 0:i.labels,stripeLength:null==i?void 0:i.stripeLength,laserLineRenderer:{heightManifoldEnabled:!!a.isSome(e)&&e.heightManifoldEnabled,heightManifoldTarget:a.isSome(e)?e.heightManifoldTarget:null,pointDistanceEnabled:!!a.isSome(e)&&e.pointDistanceEnabled,pointDistanceOrigin:a.isSome(e)?e.pointDistanceOrigin:null,pointDistanceTarget:a.isSome(e)?e.pointDistanceTarget:null,lineVerticalPlaneEnabled:!!a.isSome(e)&&e.lineVerticalPlaneEnabled}}}},{key:"_cursorPosition",get:function(){const e=u.create();return a.applySome(this.cursorPoint,(i=>this.view.renderCoordsHelper.toRenderCoords(i,e))),e}},{key:"_startPosition",get:function(){const e=u.create();return a.applySome(this.analysis.startPoint,(i=>this.view.renderCoordsHelper.toRenderCoords(i,e))),e}},{key:"_endPosition",get:function(){const e=u.create();return a.applySome(this.analysis.endPoint,(i=>this.view.renderCoordsHelper.toRenderCoords(i,e))),e}},{key:"_laserLineParams",get:function(){const e=this._focusPosition,{active:i,lineState:t}=this.toolState,n=this.analysisView,s=this.laserLineEnabled&&!!e&&"measured"!==t&&i;if(!s||!this.visible||a.isNone(n)||n.destroyed)return{heightManifoldTarget:null,pointDistanceLine:null,lineVerticalPlaneSegment:null};const r=n.actualVisualizedMeasurement,o="local"!==this.view.viewingMode&&s&&!!this.analysis.startPoint&&"geodesic"===r,l=s&&n.viewMode===_.ViewMode.Triangle;return{heightManifoldTarget:"euclidean"===r?e:null,pointDistanceLine:o?this._pointDistanceLine:null,lineVerticalPlaneSegment:l?p.fromPoints(this._startPosition,this._endPosition):null}}},{key:"_focusPosition",get:function(){const{lineState:e}=this.toolState,i=this.analysisView,t=a.isSome(i)&&!i.destroyed&&i.measurementMode===y.MeasurementMode.Euclidean&&i.viewMode===_.ViewMode.Direct;switch(e){case"drawing":return t?this._startPosition:this.analysis.endPoint?this._endPosition:this._startPosition;case"editing":return t?"start"===this._lastDraggedHandle?this._endPosition:this._startPosition:"start"===this._lastDraggedHandle?this._startPosition:this._endPosition;default:return a.isSome(this.cursorPoint)?this._cursorPosition:null}}},{key:"_pointDistanceLine",get:function(){return{origin:"drawing"===this.toolState.lineState||"end"===this._lastDraggedHandle?this._startPosition:this._endPosition,target:this._focusPosition}}}]),t}(n),t.__decorate([o.property()],e.DirectLineMeasurement3DView.prototype,"view",void 0),t.__decorate([o.property()],e.DirectLineMeasurement3DView.prototype,"params",void 0),t.__decorate([o.property()],e.DirectLineMeasurement3DView.prototype,"analysis",void 0),t.__decorate([o.property({constructOnly:!0})],e.DirectLineMeasurement3DView.prototype,"analysisView",void 0),t.__decorate([o.property()],e.DirectLineMeasurement3DView.prototype,"cursorPoint",void 0),t.__decorate([o.property()],e.DirectLineMeasurement3DView.prototype,"toolState",void 0),t.__decorate([o.property()],e.DirectLineMeasurement3DView.prototype,"visible",null),t.__decorate([o.property()],e.DirectLineMeasurement3DView.prototype,"testData",null),t.__decorate([o.property()],e.DirectLineMeasurement3DView.prototype,"_visible",void 0),t.__decorate([o.property()],e.DirectLineMeasurement3DView.prototype,"_laserLine",void 0),t.__decorate([o.property()],e.DirectLineMeasurement3DView.prototype,"laserLineEnabled",void 0),t.__decorate([o.property()],e.DirectLineMeasurement3DView.prototype,"_cursorPosition",null),t.__decorate([o.property()],e.DirectLineMeasurement3DView.prototype,"_startPosition",null),t.__decorate([o.property()],e.DirectLineMeasurement3DView.prototype,"_endPosition",null),t.__decorate([o.property()],e.DirectLineMeasurement3DView.prototype,"_lastDraggedHandle",void 0),t.__decorate([o.property()],e.DirectLineMeasurement3DView.prototype,"_laserLineParams",null),t.__decorate([o.property()],e.DirectLineMeasurement3DView.prototype,"_focusPosition",null),t.__decorate([o.property()],e.DirectLineMeasurement3DView.prototype,"_pointDistanceLine",null),e.DirectLineMeasurement3DView=t.__decorate([h.subclass("esri.views.3d.interactive.measurementTools.directLineMeasurement3D.DirectLineMeasurement3DView")],e.DirectLineMeasurement3DView),Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
