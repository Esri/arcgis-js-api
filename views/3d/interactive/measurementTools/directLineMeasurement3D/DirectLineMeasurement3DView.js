/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../core/Accessor","../../../../../core/Handles","../../../../../core/maybe","../../../../../core/screenUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/accessorSupport/ensureType","../../../../../core/Logger","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/accessorSupport/trackingUtils","../../../../../chunks/vec3f64","../../../../../geometry/support/lineSegment","../../../../../properties/defaultUnit","../../manipulatorUtils","./PickResult","../support/viewUtils","../../visualElements/LaserlineVisualElement","../../../support/ElevationProvider","../../../webgl-engine/lib/Intersector"],(function(e,t,i,s,n,r,a,o,l,d,c,u,h,p,_,y,m,w,g,v,b,L){"use strict";const f={laserLineGlowColor:[1,.5,0],laserLineGlowWidth:8,laserLineGlowFalloff:8,laserLineInnerColor:[1,1,1],laserLineInnerWidth:.75,laserLineGlobalAlpha:.75,laserLineEnabled:!0,handleColor:[1,.5,0],handleOpacity:.5,handleRadius:5};var P;!function(e){e.Manipulators="manipulators",e.AnalysisViewDestroyed="analysis-view-destroyed",e.AnalysisView="analysis-view"}(P||(P={})),e.DirectLineMeasurement3DView=function(e){function i(t){var i;return(i=e.call(this,t)||this)._state="pending",i._visible=!1,i._laserLine=null,i._handles=new n,i._cursorPosition=p.create(),i._startPosition=p.create(),i._endPosition=p.create(),i._lastDraggedHandle=null,i.analysisView=null,i._view=t.model.sceneView,i._intersector=new L.Intersector(i._view.state.viewingMode),i._intersector.options.store=0,i}t._inheritsLoose(i,e);var s=i.prototype;return s.normalizeCtorArgs=function(e){return{...e,params:e.params?g.copyParameter(f,e.params):g.copyParameter(f,{})}},s.initialize=function(){this._promise=this._initialize()},s._initialize=function(){var e=t._asyncToGenerator((function*(){switch(this._state){case"pending":break;case"destroyed":return Promise.reject("DirectLineMeasurement3DView already destroyed")}const e=this.model.layer,t=yield this._view.whenLayerView(e);return yield t.whenReady(),this._set("analysisView",t),this._laserLine=new v.LaserlineVisualElement({view:this._view,attached:!0}),this._visible&&this._updateVisibility(this._visible),this._connectToAnalysisView(),this._state="ready",t}));function i(){return e.apply(this,arguments)}return i}(),s.destroy=function(){switch(this._state){case"pending":return void(this._state="destroyed");case"ready":break;case"destroyed":default:return}this.hide(),this._handles=r.destroyMaybe(this._handles),this._laserLine=r.destroyMaybe(this._laserLine),this._state="destroyed"},s.when=function(){return this._promise.then((()=>{}))},s.whenMessages=function(){var e=t._asyncToGenerator((function*(){return this._promise.then((e=>e.whenMessages()))}));function i(){return e.apply(this,arguments)}return i}(),s.createManipulators=function(){const e=()=>{const e=m.createSphereManipulator(this._view,this.params.handleColor,this.params.handleOpacity);return e.available=!1,e.radius=this.params.handleRadius,e},t=e(),i=e();this.model.startPoint&&(t.location=r.unwrap(this.model.startPoint),t.available=!0),this.model.endPoint&&(i.location=r.unwrap(this.model.endPoint),i.available=!0);const s=()=>{let e=this._lastDraggedHandle;t.grabbing&&!i.grabbing&&(e="start"),i.grabbing&&!t.grabbing&&(e="end"),t.grabbing||i.grabbing||(e=null);const s=e!==this._lastDraggedHandle;this._lastDraggedHandle=e,s&&this.visible&&this._updateLaserLine()},n=t.events.on("grab-changed",s),a=i.events.on("grab-changed",s);return this._handles.add([n,a],P.Manipulators),{start:t,end:i}},s.show=function(){switch(this._state){case"ready":this._visible||this._updateVisibility(!0);break;case"pending":this._visible=!0;break;case"destroyed":default:return}},s.hide=function(){switch(this._state){case"ready":this._visible&&this._updateVisibility(!1);break;case"pending":this._visible=!1;break;case"destroyed":default:return}},s.finishMeasurement=function(){this.model.finishMeasurement()},s._connectToAnalysisView=function(){this._handles.remove(P.AnalysisView),this._handles.add([h.reactionInit((()=>r.applySome(this.analysisView,(e=>e.destroyed))),(e=>{e&&this._handles.remove(P.AnalysisView)})),h.reactionInit((()=>["measured"===this.model.state,this.analysisView]),(([e,t])=>{r.applySome(t,(t=>t.allowVisualElementsOrientationChange=!e))})),h.autorun((()=>this._updateLaserLine())),h.autorun((()=>this._updateCursorPosition())),h.autorun((()=>this._updateStartPosition())),h.autorun((()=>this._updateEndPosition())),h.reactionInit((()=>({unit:this.unit,layerView:this.analysisView})),(({unit:e,layerView:t})=>r.applySome(t,(t=>t.unit=e))))],P.AnalysisView)},s._updateVisibility=function(e){this._visible=e,e?(this.model.layer.visible=!0,this._laserLine.style={innerColor:this.params.laserLineInnerColor,innerWidth:this.params.laserLineInnerWidth,glowColor:this.params.laserLineGlowColor,glowWidth:this.params.laserLineGlowWidth,glowFalloff:this.params.laserLineGlowFalloff,globalAlpha:this.params.laserLineGlobalAlpha},this._laserLine.visible=!0,this._updateCursorPosition(),this._updateStartPosition(),this._updateEndPosition(),this._updateLaserLine()):(this.model.layer.visible=!1,this._laserLine.visible=!1,this._view.cursor=null)},s.pick=function(e){const t=this._view.spatialReference,i=a.screenPointObjectToArray(e.screenPoint);this._view.sceneIntersectionHelper.intersectToolIntersectorScreen(i,this._intersector);const s=this._intersector.results.min,n=p.create();if(!s.getIntersectionPoint(n))return new w.PickResult;const o=this._view.renderCoordsHelper.fromRenderCoords(n,t);if(r.isNone(o))return new w.PickResult;const l="TerrainRenderer"===s.intersector?"ground":"feature";return new w.PickResult(l,n,o)},s.getElevation=function(e){return this._view.basemapTerrain.ready?r.unwrapOr(b.getElevationAtPoint(this._view.elevationProvider,e),0):0},s.overlappingHandles=function(e,t){return g.pointToPointScreenDistance(e,t,this._view)<=this.params.handleRadius},s._updateCursorPosition=function(){this.model.cursorPoint&&this._view.renderCoordsHelper.toRenderCoords(this.model.cursorPoint,this._cursorPosition)},s._updateStartPosition=function(){r.isSome(this.model.startPoint)&&this._view.renderCoordsHelper.toRenderCoords(this.model.startPoint,this._startPosition)},s._updateEndPosition=function(){r.isSome(this.model.endPoint)&&this._view.renderCoordsHelper.toRenderCoords(this.model.endPoint,this._endPosition)},s._getFocusPosition=function(){const e=this.model,t=this.analysisView,i=r.isSome(t)&&!t.destroyed&&1===t.visualizedMeasurement,s=1===this.viewMode&&i;switch(e.state){case"drawing":return s?this._startPosition:e.endPoint?this._endPosition:this._startPosition;case"editing":return s?"start"===this._lastDraggedHandle?this._endPosition:this._startPosition:"start"===this._lastDraggedHandle?this._startPosition:this._endPosition;default:return e.cursorPoint?this._cursorPosition:null}},s._getFocusSpherePosition=function(){return"drawing"===this.model.state||"end"===this._lastDraggedHandle?this._startPosition:this._endPosition},s._updateLaserLine=function(){if(!this.visible)return;const{state:e,active:t,startPoint:i}=this.model,s=this._getFocusPosition(),n=this.viewMode,a=this.analysisView,o=this.params.laserLineEnabled&&!!s&&"measured"!==e&&t;if(o&&r.isSome(a)&&!a.destroyed){const e=1===a.actualVisualizedMeasurement;this._laserLine.heightManifoldTarget=e?s:null;const t=o&&!!i&&2===a.actualVisualizedMeasurement;this._laserLine.pointDistanceLine=t?{origin:this._getFocusSpherePosition(),target:s}:null;const r=o&&2===n;this._laserLine.lineVerticalPlaneSegment=r?_.fromPoints(this._startPosition,this._endPosition,D):null}else this._laserLine.heightManifoldTarget=null,this._laserLine.pointDistanceLine=null,this._laserLine.lineVerticalPlaneSegment=null},t._createClass(i,[{key:"requiresCursorPoint",get:function(){return"initial"===this.model.state&&this.model.active}},{key:"visible",get:function(){return this._visible},set:function(e){e?this.show():this.hide()}},{key:"viewMode",get:function(){const e=this.analysisView;return r.isSome(e)&&!e.destroyed?e.viewMode:0}},{key:"measurementMode",get:function(){const e=this.analysisView;return r.isSome(e)&&!e.destroyed?e.actualVisualizedMeasurement:1}},{key:"unit",get:function(){return r.unwrapOr(this._cachedUnit,this._defaultUnit)},set:function(e){this._cachedUnit=e}},{key:"testData",get:function(){const e=this._laserLine.testData,t=r.unwrap(this.analysisView).testData;return{labels:null==t?void 0:t.labels,stripeLength:null==t?void 0:t.stripeLength,laserLineRenderer:{heightManifoldEnabled:!!r.isSome(e)&&e.heightManifoldEnabled,heightManifoldTarget:r.isSome(e)?e.heightManifoldTarget:null,pointDistanceEnabled:!!r.isSome(e)&&e.pointDistanceEnabled,pointDistanceOrigin:r.isSome(e)?e.pointDistanceOrigin:null,pointDistanceTarget:r.isSome(e)?e.pointDistanceTarget:null,lineVerticalPlaneEnabled:!!r.isSome(e)&&e.lineVerticalPlaneEnabled}}}},{key:"directLabelText",get:function(){const e=this.analysisView;return r.isSome(e)&&!e.destroyed?e.directLabelText:null}},{key:"horizontalLabelText",get:function(){const e=this.analysisView;return r.isSome(e)&&!e.destroyed?e.horizontalLabelText:null}},{key:"verticalLabelText",get:function(){const e=this.analysisView;return r.isSome(e)&&!e.destroyed?e.verticalLabelText:null}}]),i}(s),i.__decorate([o.property()],e.DirectLineMeasurement3DView.prototype,"_view",void 0),i.__decorate([o.property()],e.DirectLineMeasurement3DView.prototype,"_visible",void 0),i.__decorate([o.property()],e.DirectLineMeasurement3DView.prototype,"_laserLine",void 0),i.__decorate([o.property()],e.DirectLineMeasurement3DView.prototype,"params",void 0),i.__decorate([o.property()],e.DirectLineMeasurement3DView.prototype,"model",void 0),i.__decorate([o.property({readOnly:!0})],e.DirectLineMeasurement3DView.prototype,"analysisView",void 0),i.__decorate([o.property()],e.DirectLineMeasurement3DView.prototype,"requiresCursorPoint",null),i.__decorate([o.property()],e.DirectLineMeasurement3DView.prototype,"visible",null),i.__decorate([o.property()],e.DirectLineMeasurement3DView.prototype,"viewMode",null),i.__decorate([o.property()],e.DirectLineMeasurement3DView.prototype,"measurementMode",null),i.__decorate([o.property()],e.DirectLineMeasurement3DView.prototype,"unit",null),i.__decorate([o.property()],e.DirectLineMeasurement3DView.prototype,"_cachedUnit",void 0),i.__decorate([o.property(y.defaultUnitPropertyMetadata)],e.DirectLineMeasurement3DView.prototype,"_defaultUnit",void 0),i.__decorate([o.property()],e.DirectLineMeasurement3DView.prototype,"testData",null),i.__decorate([o.property()],e.DirectLineMeasurement3DView.prototype,"directLabelText",null),i.__decorate([o.property()],e.DirectLineMeasurement3DView.prototype,"horizontalLabelText",null),i.__decorate([o.property()],e.DirectLineMeasurement3DView.prototype,"verticalLabelText",null),e.DirectLineMeasurement3DView=i.__decorate([u.subclass("esri.views.3d.interactive.measurementTools.directLineMeasurement3D.DirectLineMeasurement3DView")],e.DirectLineMeasurement3DView);const D=_.create();Object.defineProperty(e,"__esModule",{value:!0})}));
