/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../Color","../../../../../core/Accessor","../../../../../core/analysisThemeUtils","../../../../../core/Handles","../../../../../core/maybe","../../../../../core/reactiveUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/arrayUtils","../../../../../core/accessorSupport/ensureType","../../../../../core/accessorSupport/decorators/subclass","../../../../../chunks/vec3f64","../../../../../geometry/support/lineSegment","../../../analysis/interfaces","../../../analysis/DirectLineMeasurement/interfaces","../../manipulatorUtils","../../visualElements/LaserlineVisualElement"],(function(e,t,i,n,s,a,r,o,l,c,d,h,u,p,_,y,g,m,D){"use strict";var w;!function(e){e.Manipulators="manipulators",e.AnalysisViewDestroyed="analysis-view-destroyed",e.AnalysisView="analysis-view"}(w||(w={})),e.DirectLineMeasurement3DView=function(e){function i(t){var i;return(i=e.call(this,t)||this)._params={laserLineGlowColor:n.toUnitRGB(a.getAccentColor()),laserLineGlowWidth:8,laserLineGlowFalloff:8,laserLineInnerColor:n.toUnitRGB(a.getContrastColor()),laserLineInnerWidth:.75,laserLineGlobalAlpha:.75,handleColor:n.toUnitRGB(a.getAccentColor()),handleOpacity:.5,handleRadius:5},i.analysisViewData=null,i.cursorPoint=null,i._visible=!1,i._laserLine=null,i.laserLineEnabled=!0,i._handles=new r,i._lastDraggedHandle=null,i}t._inheritsLoose(i,e);var s=i.prototype;return s.initialize=function(){this._laserLine=new D.LaserlineVisualElement({view:this.view,attached:!0}),this._updateVisibility(this._visible),this._connectToAnalysisView()},s.destroy=function(){this._handles=o.destroyMaybe(this._handles),this._laserLine=o.destroyMaybe(this._laserLine)},s.createManipulators=function(){const e=()=>{const e=m.createSphereManipulator(this.view,this._params.handleColor,this._params.handleOpacity);return e.available=!1,e.radius=this._params.handleRadius,e},t=e(),i=e();o.isSome(this.analysis.startPoint)&&(t.location=this.analysis.startPoint,t.available=!0),o.isSome(this.analysis.endPoint)&&(i.location=this.analysis.endPoint,i.available=!0);const n=()=>{let e=this._lastDraggedHandle;t.grabbing&&!i.grabbing&&(e="start"),i.grabbing&&!t.grabbing&&(e="end"),t.grabbing||i.grabbing||(e=null),this._lastDraggedHandle=e},s=t.events.on("grab-changed",n),a=i.events.on("grab-changed",n);return this._handles.add([s,a],w.Manipulators),{start:t,end:i}},s.show=function(){this.destroyed||this._visible||this._updateVisibility(!0)},s.hide=function(){!this.destroyed&&this._visible&&this._updateVisibility(!1)},s._connectToAnalysisView=function(){this._handles.remove(w.AnalysisView),this._handles.add([l.watch((()=>o.applySome(this.analysisViewData,(e=>e.destroyed))),(e=>{e&&this._handles.remove(w.AnalysisView)}),l.initial),l.watch((()=>["measured"===this.toolState.lineState,this.analysisViewData]),(([e,t])=>{o.isSome(t)&&!t.destroyed&&(t.allowVisualElementsOrientationChange=!e)}),l.initial),l.watch((()=>this._laserLineParams),(e=>{const t=this._laserLine;t.heightManifoldTarget=e.heightManifoldTarget,t.pointDistanceLine=e.pointDistanceLine,t.lineVerticalPlaneSegment=e.lineVerticalPlaneSegment}),l.initial)],w.AnalysisView)},s._updateVisibility=function(e){this.initialized&&(this._visible=e,e?this._laserLine.style={innerColor:this._params.laserLineInnerColor,innerWidth:this._params.laserLineInnerWidth,glowColor:this._params.laserLineGlowColor,glowWidth:this._params.laserLineGlowWidth,glowFalloff:this._params.laserLineGlowFalloff,globalAlpha:this._params.laserLineGlobalAlpha}:this.view.cursor=null,this._laserLine.visible=e)},t._createClass(i,[{key:"visible",get:function(){return this._visible},set:function(e){e?this.show():this.hide()}},{key:"testData",get:function(){const e=this._laserLine.testData,t=this.analysisViewData.testData;return{labels:t?.labels,stripeLength:t?.stripeLength,laserLineRenderer:{heightManifoldEnabled:!!o.isSome(e)&&e.heightManifoldEnabled,heightManifoldTarget:o.isSome(e)?e.heightManifoldTarget:null,pointDistanceEnabled:!!o.isSome(e)&&e.pointDistanceEnabled,pointDistanceOrigin:o.isSome(e)?e.pointDistanceOrigin:null,pointDistanceTarget:o.isSome(e)?e.pointDistanceTarget:null,lineVerticalPlaneEnabled:!!o.isSome(e)&&e.lineVerticalPlaneEnabled}}}},{key:"_cursorPosition",get:function(){const e=p.create();return o.applySome(this.cursorPoint,(t=>this.view.renderCoordsHelper.toRenderCoords(t,e))),e}},{key:"_startPosition",get:function(){const e=p.create();return o.applySome(this.analysis.startPoint,(t=>this.view.renderCoordsHelper.toRenderCoords(t,e))),e}},{key:"_endPosition",get:function(){const e=p.create();return o.applySome(this.analysis.endPoint,(t=>this.view.renderCoordsHelper.toRenderCoords(t,e))),e}},{key:"_laserLineParams",get:function(){const e=this._focusPosition,{active:t,lineState:i}=this.toolState,n=this.analysisViewData,s=this.laserLineEnabled&&!!e&&"measured"!==i&&t;if(!s||!this.visible||o.isNone(n)||n.destroyed)return{heightManifoldTarget:null,pointDistanceLine:null,lineVerticalPlaneSegment:null};const a=n.actualVisualizedMeasurement,r="local"!==this.view.viewingMode&&s&&!!this.analysis.startPoint&&"geodesic"===a,l=s&&n.viewMode===g.ViewMode.Triangle;return{heightManifoldTarget:"euclidean"===a?e:null,pointDistanceLine:r?this._pointDistanceLine:null,lineVerticalPlaneSegment:l?_.fromPoints(this._startPosition,this._endPosition):null}}},{key:"_focusPosition",get:function(){const{lineState:e}=this.toolState,t=this.analysisViewData,i=o.isSome(t)&&!t.destroyed&&t.measurementMode===y.MeasurementMode.Euclidean&&t.viewMode===g.ViewMode.Direct;switch(e){case"drawing":return i?this._startPosition:this.analysis.endPoint?this._endPosition:this._startPosition;case"editing":return i?"start"===this._lastDraggedHandle?this._endPosition:this._startPosition:"start"===this._lastDraggedHandle?this._startPosition:this._endPosition;default:return o.isSome(this.cursorPoint)?this._cursorPosition:null}}},{key:"_pointDistanceLine",get:function(){return{origin:"drawing"===this.toolState.lineState||"end"===this._lastDraggedHandle?this._startPosition:this._endPosition,target:this._focusPosition}}}]),i}(s),i.__decorate([c.property({constructOnly:!0})],e.DirectLineMeasurement3DView.prototype,"view",void 0),i.__decorate([c.property()],e.DirectLineMeasurement3DView.prototype,"_params",void 0),i.__decorate([c.property({constructOnly:!0})],e.DirectLineMeasurement3DView.prototype,"analysis",void 0),i.__decorate([c.property({constructOnly:!0})],e.DirectLineMeasurement3DView.prototype,"analysisViewData",void 0),i.__decorate([c.property()],e.DirectLineMeasurement3DView.prototype,"cursorPoint",void 0),i.__decorate([c.property()],e.DirectLineMeasurement3DView.prototype,"toolState",void 0),i.__decorate([c.property()],e.DirectLineMeasurement3DView.prototype,"visible",null),i.__decorate([c.property()],e.DirectLineMeasurement3DView.prototype,"testData",null),i.__decorate([c.property()],e.DirectLineMeasurement3DView.prototype,"_visible",void 0),i.__decorate([c.property()],e.DirectLineMeasurement3DView.prototype,"_laserLine",void 0),i.__decorate([c.property({constructOnly:!0})],e.DirectLineMeasurement3DView.prototype,"laserLineEnabled",void 0),i.__decorate([c.property()],e.DirectLineMeasurement3DView.prototype,"_cursorPosition",null),i.__decorate([c.property()],e.DirectLineMeasurement3DView.prototype,"_startPosition",null),i.__decorate([c.property()],e.DirectLineMeasurement3DView.prototype,"_endPosition",null),i.__decorate([c.property()],e.DirectLineMeasurement3DView.prototype,"_lastDraggedHandle",void 0),i.__decorate([c.property()],e.DirectLineMeasurement3DView.prototype,"_laserLineParams",null),i.__decorate([c.property()],e.DirectLineMeasurement3DView.prototype,"_focusPosition",null),i.__decorate([c.property()],e.DirectLineMeasurement3DView.prototype,"_pointDistanceLine",null),e.DirectLineMeasurement3DView=i.__decorate([u.subclass("esri.views.3d.interactive.measurementTools.directLineMeasurement3D.DirectLineMeasurement3DView")],e.DirectLineMeasurement3DView),Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
