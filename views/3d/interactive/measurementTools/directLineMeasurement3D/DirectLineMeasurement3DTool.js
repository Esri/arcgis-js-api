/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../geometry","../../../../../core/Handles","../../../../../core/maybe","../../../../../core/reactiveUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/arrayUtils","../../../../../core/has","../../../../../core/accessorSupport/ensureType","../../../../../core/accessorSupport/decorators/subclass","../../../../../layers/graphics/hydratedFeatures","../../editingTools/dragEventPipeline3D","./DirectLineMeasurement3DView","./PickRequest","./PickResult","../support/measurementUtils","../../../../interactive/dragEventPipeline","../../../../interactive/InteractiveToolBase","../../../../support/screenUtils","../../../../../geometry/Point"],(function(t,e,i,n,s,a,r,o,c,l,u,h,d,p,m,y,P,_,v,w,f){"use strict";let g=function(e){function i(t){var i;return(i=e.call(this,t)||this)._handles=new n,i._cachedPickRequest=new m.PickRequest,i._cachedPickResult=new y.PickResult,i._isAnyPointerDown=!1,i.lineState="initial",i.startPointSurfaceLocation=null,i.endPointSurfaceLocation=null,i.startManipulator=null,i.endManipulator=null,i}t._inheritsLoose(i,e);var r=i.prototype;return r.initialize=function(){this.measurementView=new p.DirectLineMeasurement3DView({toolState:this,view:this.view,analysis:this.analysis,cursorPoint:this.cursorPoint}),this.measurementView.when().then((()=>this._initialize()))},r._initialize=function(){const{start:t,end:e}=this.measurementView.createManipulators(),i=(t,e,i)=>_.createManipulatorDragEventPipeline(t,((t,n,a)=>{const r=d.hideManipulatorWhileDragging(t);n.next(r).next(d.screenToMap3D(this.view)).next((t=>"start"!==t.action?t:null)).next((n=>{const s=h.clonePoint(n.mapEnd,new f);this.analysis[e]=s,t.location=s,this[i]=this._surfaceLocation(s,n.surfaceType)})),a.next(r).next(_.resetProperties(this.analysis,[e])).next(_.resetProperties(this,[i])).next((()=>{t.location=s.unwrap(this.analysis[e])}))}));this._handles.add([i(t,"startPoint","startPointSurfaceLocation"),i(e,"endPoint","endPointSurfaceLocation")]),[t,e].forEach((i=>{this._handles.add([i.events.on("grab-changed",(()=>{const i=t.grabbing||e.grabbing;i&&"measured"===this.lineState&&(this.lineState="editing"),i||(this.measurementView.finishMeasurement(),"editing"===this.lineState&&(this.lineState="measured"))}))])})),this.manipulators.add(t),this.manipulators.add(e),this.startManipulator=t,this.endManipulator=e,this._handles.add(a.react((()=>this.state),(t=>{"measured"===t?this.complete():this.finishToolCreation()}),a.sync)),"measured"===this.state?this.complete():this.startToolCreation()},r.destroy=function(){this.measurementView.destroy(),this._set("measurementView",null),this._handles=s.destroyMaybe(this._handles)},r.onDetach=function(){this.analysis.startPoint=null,this.analysis.endPoint=null,this.cursorPoint=null,this.measurementView.clearMeasurement()},r.onShow=function(){this.measurementView.show(),this.created&&this._updateManipulatorVisibility()},r.onHide=function(){this.created&&this.measurementView.hide()},r.onInputEvent=function(t){switch(t.type){case"immediate-click":this._handleImmediateClick(t);break;case"pointer-move":this._handlePointerMove(t);break;case"pointer-down":this._handlePointerDown();break;case"pointer-up":this._handlePointerUp()}this._updateManipulatorVisibility()},r._handlePointerMove=function(t){this._clearCachedPickRequest();const e=w.createScreenPointFromEvent(t);"mouse"===t.pointerType&&(this._hoverAt(e),"drawing"===this.lineState&&(this.endManipulator.events.emit("drag",{action:"update",start:e,screenPoint:e}),t.stopPropagation()))},r._handlePointerDown=function(){this._isAnyPointerDown=!0},r._handlePointerUp=function(){this._isAnyPointerDown=!1},r._handleImmediateClick=function(t){if(this._clearCachedPickRequest(),!P.isPrimaryPointerAction(t))return;const e=w.createScreenPointFromEvent(t),i=t.pointerType;let n=!1;if(this.active)switch(this.lineState){case"initial":this.startManipulator.events.emit("drag",{action:"start",pointerType:i,start:e,screenPoint:e}),this.startManipulator.events.emit("drag",{action:"end",start:e,screenPoint:e}),s.isSome(this.analysis.startPoint)&&(this.startManipulator.interactive=!1,this.endManipulator.interactive=!1,this.lineState="drawing",this.endManipulator.events.emit("drag",{action:"start",pointerType:i,start:e,screenPoint:e}),n=!0);break;case"drawing":this.endManipulator.events.emit("drag",{action:"update",start:e,screenPoint:e}),s.isSome(this.analysis.endPoint)&&(this.endManipulator.events.emit("drag",{action:"end",start:e,screenPoint:e}),this.startManipulator.interactive=!0,this.endManipulator.interactive=!0,this.measurementView.finishMeasurement(),n=!0)}n&&t.stopPropagation(),"mouse"===t.pointerType&&this._hoverAt(e)},r._hoverAt=function(t){const e=this._isAnyPointerDown&&"drawing"!==this.lineState&&"editing"!==this.lineState;if(this.measurementView.requiresCursorPoint&&!e){const e=this._pick(t);e.mapPoint&&(this.cursorPoint=e.mapPoint)}else this.cursorPoint=null},r._pick=function(t){const e=this._cachedPickRequest.screenPoint;return e&&e.x===t.x&&e.y===t.y||(this._cachedPickRequest.screenPoint=t,this._cachedPickResult=this.measurementView.pick(this._cachedPickRequest)),this._cachedPickResult},r._clearCachedPickRequest=function(){this._cachedPickRequest.screenPoint=null},r._surfaceLocation=function(t,e){return 0===e?"on-the-surface":t.z>=this.measurementView.getElevation(t)?"above-the-surface":"below-the-surface"},r._updateManipulatorVisibility=function(){this.startManipulator.available=s.isSome(this.analysis.startPoint),this.endManipulator.available=s.isSome(this.analysis.endPoint)},t._createClass(i,[{key:"state",get:function(){return this.analysis.startPoint?"measured"===this.lineState?"measured":"measuring":"ready"}},{key:"creating",get:function(){return"initial"===this.lineState||"drawing"===this.lineState}},{key:"cursor",get:function(){return!this.active||"drawing"!==this.lineState&&"initial"!==this.lineState?null:"crosshair"}},{key:"cursorPoint",set:function(t){this._set("cursorPoint",t),this.measurementView.cursorPoint=t}},{key:"validMeasurement",get:function(){return s.isSome(this.analysis.startPoint)&&s.isSome(this.analysis.endPoint)}}]),i}(v.InteractiveToolBase);e.__decorate([r.property({readOnly:!0})],g.prototype,"state",null),e.__decorate([r.property()],g.prototype,"lineState",void 0),e.__decorate([r.property({readOnly:!0})],g.prototype,"creating",null),e.__decorate([r.property({readOnly:!0})],g.prototype,"cursor",null),e.__decorate([r.property()],g.prototype,"cursorPoint",null),e.__decorate([r.property({constructOnly:!0})],g.prototype,"analysis",void 0),e.__decorate([r.property()],g.prototype,"measurementView",void 0),e.__decorate([r.property({constructOnly:!0})],g.prototype,"view",void 0),e.__decorate([r.property({readOnly:!0})],g.prototype,"validMeasurement",null),e.__decorate([r.property({value:null})],g.prototype,"startPointSurfaceLocation",void 0),e.__decorate([r.property({value:null})],g.prototype,"endPointSurfaceLocation",void 0),g=e.__decorate([u.subclass("esri.views.3d.interactive.measurementTools.directLineMeasurement3D.DirectLineMeasurement3DTool")],g);return g}));
