/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../geometry","../../../../../core/Handles","../../../../../core/maybe","../../../../../core/reactiveUtils","../../../../../core/screenUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/arrayUtils","../../../../../core/accessorSupport/ensureType","../../../../../core/accessorSupport/decorators/subclass","../../../../../chunks/vec3f64","../../../../../layers/graphics/hydratedFeatures","../../../analysis/support/measurementUtils","../../editingTools/dragEventPipeline3D","./DirectLineMeasurement3DView","../support/PickRequest","../../../support/ElevationProvider","../../../webgl-engine/lib/Intersector","../../../webgl-engine/lib/IntersectorInterfaces","../../../../interactive/AnalysisToolBase","../../../../interactive/dragEventPipeline","../../../../support/screenUtils","../../../../../geometry/Point"],(function(e,t,i,n,s,a,r,o,c,l,u,h,d,p,y,P,_,v,m,w,f,g,S,M){"use strict";let b=function(t){function i(e){var i;return(i=t.call(this,e)||this)._handles=new n,i._cachedPickRequest=null,i._isAnyPointerDown=!1,i.lineState="initial",i.analysisViewData=null,i.startPointSurfaceLocation=null,i.endPointSurfaceLocation=null,i.startManipulator=null,i.endManipulator=null,i}e._inheritsLoose(i,t);var o=i.prototype;return o.initialize=function(){const{view:e,analysis:t,analysisViewData:i,cursorPoint:n,visible:r}=this;this.measurementView=new P.DirectLineMeasurement3DView({toolState:this,view:e,analysis:t,analysisViewData:i,cursorPoint:n,visible:r}),this._intersector=m.newIntersector(this.view.state.viewingMode),this._intersector.options.store=w.StoreResults.MIN;const{start:o,end:c}=this.measurementView.createManipulators(),l=(e,t,i)=>g.createManipulatorDragEventPipeline(e,((e,n,a)=>{const r=y.hideManipulatorWhileDragging(e);n.next(r).next(y.screenToMap3D(this.view)).next((e=>"start"!==e.action?e:null)).next((n=>{const s=d.clonePoint(n.mapEnd,new M);this.analysis[t]=s,e.location=s,this[i]=this._surfaceLocation(s,n.surfaceType)})),a.next(r).next(g.resetProperties(this.analysis,[t])).next(g.resetProperties(this,[i])).next((()=>{e.location=s.unwrap(this.analysis[t])}))})),u=e=>e.events.on("grab-changed",(()=>{const e=o.grabbing||c.grabbing;this.lineState=e?"editing":"measured"}));this._handles.add([l(o,"startPoint","startPointSurfaceLocation"),l(c,"endPoint","endPointSurfaceLocation"),u(o),u(c)]),this.manipulators.add(o),this.manipulators.add(c),this.startManipulator=o,this.endManipulator=c,this._handles.add(a.watch((()=>this.state),(e=>{"measured"===e&&this.finishToolCreation()}),a.syncAndInitial))},o.destroy=function(){this.measurementView=s.destroyMaybe(this.measurementView),this._handles=s.destroyMaybe(this._handles)},o.onShow=function(){this.measurementView.show(),this._updateManipulatorAvailability()},o.onHide=function(){this.measurementView.hide()},o.onInputEvent=function(e){switch(e.type){case"immediate-click":this._handleImmediateClick(e);break;case"pointer-move":this._handlePointerMove(e);break;case"pointer-down":this._handlePointerDown();break;case"pointer-up":this._handlePointerUp()}this._updateManipulatorAvailability()},o._handlePointerMove=function(e){this._clearCachedPickRequest();const t=S.createScreenPointFromEvent(e);"mouse"===e.pointerType&&(this._hoverAt(t),"drawing"===this.lineState&&(this.endManipulator.events.emit("drag",{action:"update",start:t,screenPoint:t}),e.stopPropagation()))},o._handlePointerDown=function(){this._isAnyPointerDown=!0},o._handlePointerUp=function(){this._isAnyPointerDown=!1},o._handleImmediateClick=function(e){if(this._clearCachedPickRequest(),!p.isPrimaryPointerAction(e))return;const t=S.createScreenPointFromEvent(e),i=e.pointerType;let n=!1;if(this.active)switch(this.lineState){case"initial":this.startManipulator.events.emit("drag",{action:"start",pointerType:i,start:t,screenPoint:t}),this.startManipulator.events.emit("drag",{action:"end",start:t,screenPoint:t}),s.isSome(this.analysis.startPoint)&&(this.startManipulator.interactive=!1,this.endManipulator.interactive=!1,this.lineState="drawing",this.endManipulator.events.emit("drag",{action:"start",pointerType:i,start:t,screenPoint:t}),n=!0);break;case"drawing":this.endManipulator.events.emit("drag",{action:"update",start:t,screenPoint:t}),s.isSome(this.analysis.endPoint)&&(this.endManipulator.events.emit("drag",{action:"end",start:t,screenPoint:t}),this.startManipulator.interactive=!0,this.endManipulator.interactive=!0,this.lineState="measured",n=!0)}n&&e.stopPropagation(),"mouse"===e.pointerType&&this._hoverAt(t)},o._hoverAt=function(e){const t=this._isAnyPointerDown&&"drawing"!==this.lineState&&"editing"!==this.lineState;if((s.isNone(this.analysis.startPoint)||s.isNone(this.analysis.endPoint))&&this.active&&!t){const t=this._pick(e);s.isSome(t)&&(this.cursorPoint=t)}else this.cursorPoint=null},o._pick=function(e){if(s.isSome(this._cachedPickRequest)&&s.isSome(this._cachedPickRequest.result)){const t=this._cachedPickRequest.screenPoint;if(t.x===e.x&&t.y===e.y)return this._cachedPickRequest.result.mapPoint}else this._cachedPickRequest=new _.PickRequest(e);const t=r.screenPointObjectToArray(e);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(t,this._intersector);const i=this._intersector.results.min,n=k;if(!i.getIntersectionPoint(n))return null;const a=this.view.renderCoordsHelper.fromRenderCoords(n,this.view.spatialReference);return this._cachedPickRequest.result=new _.PickResult(n,a),a},o._clearCachedPickRequest=function(){this._cachedPickRequest=null},o._surfaceLocation=function(e,t){return t===y.SurfaceType.GROUND?"on-the-surface":e.z>=this._getElevation(e)?"above-the-surface":"below-the-surface"},o._updateManipulatorAvailability=function(){this.startManipulator.available=s.isSome(this.analysis.startPoint),this.endManipulator.available=s.isSome(this.analysis.endPoint)},o._getElevation=function(e){return this.view.basemapTerrain.ready?s.unwrapOr(v.getElevationAtPoint(this.view.elevationProvider,e),0):0},e._createClass(i,[{key:"state",get:function(){return s.isNone(this.analysis.startPoint)&&s.isNone(this.analysis.endPoint)?"ready":this.validMeasurement&&"editing"!==this.lineState&&"drawing"!==this.lineState?"measured":"measuring"}},{key:"cursor",get:function(){return"ready"===this.state||"drawing"===this.lineState?"crosshair":null}},{key:"cursorPoint",set:function(e){this._set("cursorPoint",e),this.measurementView.cursorPoint=e}},{key:"validMeasurement",get:function(){return s.isSome(this.analysis.startPoint)&&s.isSome(this.analysis.endPoint)}}]),i}(f.AnalysisToolBase);t.__decorate([o.property({readOnly:!0})],b.prototype,"state",null),t.__decorate([o.property()],b.prototype,"lineState",void 0),t.__decorate([o.property({readOnly:!0})],b.prototype,"cursor",null),t.__decorate([o.property()],b.prototype,"cursorPoint",null),t.__decorate([o.property({constructOnly:!0})],b.prototype,"analysis",void 0),t.__decorate([o.property({constructOnly:!0})],b.prototype,"analysisViewData",void 0),t.__decorate([o.property()],b.prototype,"measurementView",void 0),t.__decorate([o.property({constructOnly:!0})],b.prototype,"view",void 0),t.__decorate([o.property({readOnly:!0})],b.prototype,"validMeasurement",null),t.__decorate([o.property({value:null})],b.prototype,"startPointSurfaceLocation",void 0),t.__decorate([o.property({value:null})],b.prototype,"endPointSurfaceLocation",void 0),b=t.__decorate([u.subclass("esri.views.3d.interactive.measurementTools.directLineMeasurement3D.DirectLineMeasurement3DTool")],b);const k=h.create();return b}));
