/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/maybe","../../../core/promiseUtils","../../../layers/graphics/dehydratedFeatureComparison","../../interactive/dragEventPipeline","../../interactive/snapping/SnappingContext","../../support/Scheduler"],(function(e,n,t,a,i,r,o,p){"use strict";let s=function(){function e(){this.next=new r.EventPipeline}return e.prototype.createSnapDragEventPipelineStep=function({predicate:e=(()=>!0),cancel:s,snappingManager:l,snappingContext:c,updatingHandles:d}){var u=this;if(t.isNone(l))return e=>e;let m=null,y=null;const x=()=>{m=t.abortMaybe(m),l.doneSnapping(),t.isSome(y)&&y.frameTask.remove(),y=null};return s.next((e=>(x(),e))),this.next=new r.EventPipeline,r=>{if(!e(r))return r;if(m=t.abortMaybe(m),"start"===r.action){const e="3d"===l.view.type?l.view.resourceController.scheduler.registerTask(p.TaskPriority.SNAPPING):p.ImmediateTask;y={context:new o.SnappingContext({geometry:c.geometry,elevationInfo:c.elevationInfo,pointer:c.pointer,vertexHandle:t.isSome(r.info)?r.info.handle:null,excludeFeature:c.excludeFeature,visualizer:c.visualizer}),originalPos:t.isSome(r.snapOrigin)?c.coordinateHelper.createDehydratedPoint(r.snapOrigin):r.mapStart,frameTask:e}}if(t.isSome(y)){const e=y.context.coordinateHelper.createDehydratedPoint(y.context.coordinateHelper.fromArray([y.originalPos.x,y.originalPos.y,y.originalPos.z]));e.x+=r.mapEnd.x-r.mapStart.x,e.y+=r.mapEnd.y-r.mapStart.y;const t=r.mapStart.x-y.originalPos.x,o=r.mapStart.y-y.originalPos.y,p={...r,action:"udpate"},s=y.context,c=l.update(e,y.context);if(r.mapEnd.x=c.x+t,r.mapEnd.y=c.y+o,"end"!==r.action){const r=y.frameTask;m=a.createTask(function(){var a=n._asyncToGenerator((function*(n){const a=yield r.schedule((()=>l.snap(e,s,n)),n);if(a.valid){const e=yield r.schedule((()=>a.apply()),n);i.pointEquals(e,c)||(p.mapEnd.x=e.x+t,p.mapEnd.y=e.y+o,u.next.execute(p))}}));return function(e){return a.apply(this,arguments)}}()),d.addPromise(m.promise)}}return"end"===r.action&&x(),r}},e}();e.SnappingPipeline=s,Object.defineProperty(e,"__esModule",{value:!0})}));
