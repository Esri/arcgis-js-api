/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../core/maybe","../../../core/promiseUtils","../../support/Scheduler","../../../layers/graphics/dehydratedFeatureComparison","../../interactive/snapping/SnappingContext","../../interactive/dragEventPipeline"],(function(e,n,t,a,i,r,o){"use strict";let p=function(){function e(){this.next=new o.EventPipeline}return e.prototype.createSnapDragEventPipelineStep=function({predicate:e=(()=>!0),cancel:p,snappingManager:s,snappingContext:c}){if(n.isNone(s))return e=>e;let l=null,d=null;const u=()=>{l=n.abortMaybe(l),s.doneSnapping(),n.isSome(d)&&d.frameTask.remove(),d=null};return p.next((e=>(u(),e))),this.next=new o.EventPipeline,o=>{if(!e(o))return o;if(l=n.abortMaybe(l),"start"===o.action){const e="3d"===s.view.type?s.view.resourceController.scheduler.registerTask(a.Task.SNAPPING,(t=>n.unwrap(e).processQueue(t)),(()=>!1)):a.ImmediateTask;d={context:new r.SnappingContext({geometry:c.geometry,elevationInfo:c.elevationInfo,pointer:c.pointer,vertexHandle:n.isSome(o.info)?o.info.handle:null,excludeFeature:c.excludeFeature,visualizer:c.visualizer}),originalPos:n.isSome(o.snapOrigin)?c.coordinateHelper.createDehydratedPoint(o.snapOrigin):o.mapStart,frameTask:e}}if(n.isSome(d)){const e=d.context.coordinateHelper.createDehydratedPoint(d.context.coordinateHelper.fromArray([d.originalPos.x,d.originalPos.y,d.originalPos.z]));e.x+=o.mapEnd.x-o.mapStart.x,e.y+=o.mapEnd.y-o.mapStart.y;const n=o.mapStart.x-d.originalPos.x,a=o.mapStart.y-d.originalPos.y,r={...o,action:"udpate"},p=d.context,c=s.update(e,d.context);if(o.mapEnd.x=c.x+n,o.mapEnd.y=c.y+a,"end"!==o.action){const o=d.frameTask;l=t.createTask((async t=>{const l=await o.schedule((()=>s.snap(e,p,t)),t);if(l.valid){const e=await o.schedule((()=>l.apply()),t);i.pointEquals(e,c)||(r.mapEnd.x=e.x+n,r.mapEnd.y=e.y+a,this.next.execute(r))}}))}}return"end"===o.action&&u(),o}},e}();e.SnappingPipeline=p,Object.defineProperty(e,"__esModule",{value:!0})}));
