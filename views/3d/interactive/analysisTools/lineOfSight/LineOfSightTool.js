// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../../Color","../../../../../core/Collection","../../../../../core/Handles","../../../../../core/maybe","../../../../../core/screenUtils","../../../../../core/watchUtils","../../../../../core/accessorSupport/decorators","../../../../../core/libs/gl-matrix-2/mat4f64","../../../../../core/libs/gl-matrix-2/vec3","../../../../../core/libs/gl-matrix-2/vec3f64","../../../../../geometry/Point","../../../../../layers/graphics/dehydratedFeatures","./lineOfSightToolConfig","./lineOfSightToolUtils","../../../support/geometryUtils","../../../support/LaserLineRenderer","../../../support/stack","../../../terrain/tileUtils","../../../webgl-engine/lib/Intersector","../../../webgl-engine/lib/Layer","../../../webgl-engine/lib/Object3D","../../../../interactive/dragEventPipeline","../../../../interactive/InteractiveToolBase","../../../../support/Scheduler","../../../../../widgets/LineOfSight/LineOfSightTarget"],(function(e,t,i,r,n,o,a,s,l,c,u,d,p,h,_,v,g,f,y,m,b,O,T,L,C,I,S,w){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LineOfSightTool=t.LineOfSightTargetCollection=void 0,t.LineOfSightTargetCollection=n.ofType(w);var R=function(e){function u(i){var r=e.call(this,i)||this;return r.deferCreation=!0,r.observer=null,r.targets=new t.LineOfSightTargetCollection,r.configuration=null,r.updating=!1,r._handles=new o,r._manipulatorHandles=new o,r._observer=null,r._tracker=null,r._analyses=new n,r._screenPixelSize=0,r._grabbedManipulator=null,r._showTracker=!0,r}return i.__extends(u,e),u.prototype.initialize=function(){var e=this,t=l.init(this,"state",(function(t){switch(t){case"created":e.complete();break;default:e.create()}}),!0),i=this.configuration=new v.Configuration;this._intersector=new O.Intersector(this.view.state.mode),this._intersector.options.hud=!1,this._intersector.options.store=0,this._engineLayer=new T("line-of-sight-analysis",{isPickable:!1});var r=this.view._stage;r.addToViewContent([this._engineLayer.id]),r.add(0,this._engineLayer),this._createEngineResources(),this._observer={location:null,intersection:null,manipulator:this._addManipulator({size:i.observerManipulatorSize,color:i.observerManipulatorColor,visible:!1})},this._tracker=this._createLineOfSightAnalysis(new w({location:new h})),this._tracker.point.manipulator.available=!1,this._tracker.point.manipulator.interactive=!1;var n=this._handles;n.add([t,this.view.state.watch("camera",(function(){return e._onCameraChange()})),this.view.watch("map.ground.opacity",(function(t,i){return e._onGroundOpacityChange(t,i)})),l.init(this.view,"slicePlane",(function(){return e._onSlicePlaneChange()})),l.init(this,"observer",(function(t){return e._onObserverChange(t)}),!0),l.on(this,"targets","change",(function(t){return e._onTargetCollectionChange(t)}),(function(t){return e._onTargetsChange(t)}),null,!0),l.watch(this.configuration,["laserLineEnabled","laserLineGlowColor","laserLineGlowWidth","laserLineInnerColor","laserLineInnerWidth","laserLineGlobalAlpha","lineOfSightInnerWidth","lineOfSightOuterWidth","lineOfSightVisibleInnerColor","lineOfSightVisibleOuterColor","lineOfSightOccludedInnerColor","lineOfSightOccludedOuterColor","lineOfSightUndefinedInnerColor","lineOfSightUndefinedOuterColor","lineOfSightUndefinedStipplePattern","lineOfSightUndefinedStipplePatternOffColor"],(function(){return e._createEngineResources()})),l.watch(this.configuration,["observerManipulatorSize","observerManipulatorColor"],(function(){return e._recreateManipulator(e._observer)})),l.watch(this.configuration,["targetManipulatorSize","targetManipulatorVisibleColor","targetManipulatorOccludedColor","targetManipulatorUndefinedColor"],(function(){return e._analyses.forEach((function(t){return e._recreateManipulator(t.point)}))}))]);var o=this.view.pointsOfInterest;o&&n.add([o.contentGeometryUpdates.events.on("request-update",(function(){return e._onContentChange()})),this.view.elevationProvider.on("elevation-change",(function(){return e._onContentChange()}))]);var a=this.view.resourceController&&this.view.resourceController.scheduler;a&&(this._frameTask=a.registerTask(S.Task.LINE_OF_SIGHT_TOOL,(function(t){return e._updateAnalyses(t)}),(function(){return e.updating})),n.add(this._frameTask)),this.continue()},u.prototype.destroy=function(){var e=this;this.detach(),this._handles.destroy(),this._handles=null,this._manipulatorHandles.destroy(),this._manipulatorHandles=null,this.manipulators.remove(this._observer.manipulator),this._destroyLineOfSightAnalysis(this._tracker),this._analyses.forEach((function(t){e._destroyLineOfSightAnalysis(t)}));var t=this.view._stage;t.removeFromViewContent([this._engineLayer.id]),t.remove(0,this._engineLayer.id),this._removeEngineResources(),this._engineLayer=null,t.removeRenderPlugin(this._engineResources.laserLineRenderer),this._engineResources.laserLineRenderer=null,this._engineResources=null,this._intersector=null,this.observer=null,this._set("targets",null)},Object.defineProperty(u.prototype,"state",{get:function(){return this._showTracker?"creating":this.observer?"created":"ready"},enumerable:!1,configurable:!0}),Object.defineProperty(u.prototype,"cursor",{get:function(){return this.manipulators.some((function(e){return e.manipulator.focused}))?null:this._showTracker?"crosshair":null},enumerable:!1,configurable:!0}),Object.defineProperty(u.prototype,"isSupported",{get:function(){return"3d"===this.get("view.type")},enumerable:!1,configurable:!0}),u.prototype.continue=function(){this.view.activeTool=this,this._showTracker=!0,this._updateTrackerVisibility()},u.prototype.stop=function(){this._showTracker=!1,this._setDirty(S.Task.LINE_OF_SIGHT_TOOL_INTERACTIVE),this._updateTrackerVisibility()},u.prototype.onInputEvent=function(e){switch(e.type){case"immediate-double-click":this._doubleClickHandler(e);break;case"key-down":this._keyDownHandler(e);break;case"pointer-move":this._pointerMoveHandler(e)}},u.prototype.onInputEventAfter=function(e){switch(e.type){case"immediate-click":this._clickHandler(e)}},u.prototype._setDirty=function(e){this.updating?e===S.Task.LINE_OF_SIGHT_TOOL_INTERACTIVE&&this._frameTask&&(this._frameTask.task=e):(this._set("updating",!0),this._frameTask&&(this._frameTask.task=e))},u.prototype._updateTrackerVisibility=function(){this._tracker.shouldRender=this._showTracker&&!this.manipulators.some((function(e){return e.manipulator.focused})),this._updateLaserLineRenderer()},u.prototype._manipulatorFocusChanged=function(){this._updateTrackerVisibility(),this.notifyChange("cursor")},u.prototype._addManipulator=function(e){var t=this,i=g.createSphereManipulator(this.view,e);return this._manipulatorHandles.add([this._createManipulatorDragPipeline(i),i.events.on("focus-changed",(function(){return t._manipulatorFocusChanged()})),i.events.on("grab-changed",(function(e){return t._manipulatorGrabChanged(i,e)})),i.events.on("immediate-click",(function(e){return e.stopPropagation()}))],i),this.manipulators.add(i),i},u.prototype._removeManipulator=function(e){this.manipulators.remove(e),this._manipulatorHandles.remove(e)},u.prototype._recreateManipulator=function(e){var t=this.configuration,i=e.manipulator;this._removeManipulator(i);var r=e===this._observer?{size:t.observerManipulatorSize,color:t.observerManipulatorColor,visible:i.available}:{size:t.targetManipulatorSize,customColor1:t.targetManipulatorVisibleColor,customColor2:t.targetManipulatorOccludedColor,customColor3:t.targetManipulatorUndefinedColor};e.manipulator=this._addManipulator(r),e.manipulator.location=i.location,this._setDirty(S.Task.LINE_OF_SIGHT_TOOL_INTERACTIVE)},u.prototype._screenToIntersection=function(){var e=this;return function(t){var r=e._getScreenPointIntersection(t.screenEnd);return r?i.__assign(i.__assign({},t),{intersection:r}):null}},u.prototype._createManipulatorDragPipeline=function(e){var t=this;return C.createManipulatorDragEventPipeline(e,(function(i,r,n){r.next(t._screenToIntersection()).next(e===t._observer.manipulator?t._updateObserverDragStep():t._updateAnalysisDragStep(e)).next((function(){return t._updateLaserLineRenderer()})),n.next(e===t._observer.manipulator?t._cancelObserverDragStep():t._cancelAnalysisDragStep(e)).next((function(){return t._updateLaserLineRenderer()}))}))},u.prototype._updateObserverDragStep=function(){var e=this;return function(t){return e.observer=t.intersection.point,e._observer.intersection=t.intersection,t}},u.prototype._cancelObserverDragStep=function(){var e=this,t=this.observer.clone(),i=this._observer.intersection;return function(r){return e.observer=t,e._observer.intersection=i,r}},u.prototype._updateAnalysisDragStep=function(e){var t=this;return function(i){var r=t._analyses.find((function(t){return t.point.manipulator===e}));return r.target.location=i.intersection.point,r.point.intersection=i.intersection,i}},u.prototype._cancelAnalysisDragStep=function(e){var t=this._analyses.find((function(t){return t.point.manipulator===e})),i=t.target.location.clone(),r=t.point.intersection;return function(e){return t.target.location=i,t.point.intersection=r,e}},u.prototype._updateLaserLineRenderer=function(){var e=this._engineResources.laserLineRenderer;if(!this.configuration.laserLineEnabled)return e.heightManifoldEnabled=!1,void(e.lineVerticalPlaneEnabled=!1);var t=a.isSome(this._grabbedManipulator)?this._grabbedManipulator:this._tracker.shouldRender&&this.observer?this._tracker.point.manipulator:null;this.configuration.laserLineEnabled&&a.isSome(t)?(e.heightManifoldEnabled=!0,e.heightManifoldTarget=t.renderLocation,t!==this._observer.manipulator?(e.lineVerticalPlaneEnabled=!0,e.lineVerticalPlaneSegment=f.lineSegment.fromPoints(this._observer.manipulator.renderLocation,t.renderLocation,D)):e.lineVerticalPlaneEnabled=!1):(e.heightManifoldEnabled=!1,e.lineVerticalPlaneEnabled=!1)},u.prototype._createLaserLineRenderer=function(){var e=this.configuration;return new y.LaserLineRenderer(this.view.renderCoordsHelper,{glowColor:r.toUnitRGB(e.laserLineGlowColor),glowWidth:e.laserLineGlowWidth,innerColor:r.toUnitRGB(e.laserLineInnerColor),innerWidth:e.laserLineInnerWidth,globalAlpha:e.laserLineGlobalAlpha})},u.prototype._removeEngineResources=function(){var e=this.view._stage;e.remove(3,this._engineResources.visibleLineMaterialInner.id),e.remove(3,this._engineResources.visibleLineMaterialOuter.id),e.remove(3,this._engineResources.occludedLineMaterialInner.id),e.remove(3,this._engineResources.occludedLineMaterialOuter.id),e.remove(3,this._engineResources.undefinedLineMaterialInner.id),e.remove(3,this._engineResources.undefinedLineMaterialOuter.id)},u.prototype._createEngineResources=function(){var e=this.view._stage,t=this.configuration;this._engineResources&&(this._removeEngineResources(),e.removeRenderPlugin(this._engineResources.laserLineRenderer)),this._engineResources={laserLineRenderer:this._createLaserLineRenderer(),visibleLineMaterialInner:g.createPolylineMaterial(t.lineOfSightInnerWidth,t.lineOfSightVisibleInnerColor),visibleLineMaterialOuter:g.createPolylineMaterial(t.lineOfSightOuterWidth,t.lineOfSightVisibleOuterColor),occludedLineMaterialInner:g.createPolylineMaterial(t.lineOfSightInnerWidth,t.lineOfSightOccludedInnerColor),occludedLineMaterialOuter:g.createPolylineMaterial(t.lineOfSightOuterWidth,t.lineOfSightOccludedOuterColor),undefinedLineMaterialInner:g.createPolylineMaterial(t.lineOfSightInnerWidth,t.lineOfSightUndefinedInnerColor),undefinedLineMaterialOuter:g.createPolylineMaterial(t.lineOfSightOuterWidth,t.lineOfSightUndefinedOuterColor)},e.addRenderPlugin(this._engineResources.laserLineRenderer.renderSlots,this._engineResources.laserLineRenderer),e.add(3,this._engineResources.visibleLineMaterialInner),e.add(3,this._engineResources.visibleLineMaterialOuter),e.add(3,this._engineResources.occludedLineMaterialInner),e.add(3,this._engineResources.occludedLineMaterialOuter),e.add(3,this._engineResources.undefinedLineMaterialInner),e.add(3,this._engineResources.undefinedLineMaterialOuter),this._setDirty(S.Task.LINE_OF_SIGHT_TOOL_INTERACTIVE)},u.prototype._onObserverChange=function(e){if(a.isNone(e))return this._observer.manipulator.available=!1,void this.targets.removeAll();this._observer.location=e,this._observer.intersection=null,this._observer.manipulator.available=!0,this._observer.manipulator.location=e,this._tracker.point.manipulator.location=e,this._analyses.forEach((function(e){e.isDirty=!0,e.isValid=!1})),this._setDirty(S.Task.LINE_OF_SIGHT_TOOL_INTERACTIVE)},u.prototype._onTargetsChange=function(e){var t=this;this._analyses.forEach((function(e){t._destroyLineOfSightAnalysis(e)})),this._analyses.removeAll(),e.items&&this._onTargetCollectionChange({target:e,added:e.items,removed:[],moved:[]})},u.prototype._onTargetCollectionChange=function(e){var t=this;e.added.forEach((function(e){if(!t._analyses.some((function(t){return t.target===e}))){var i=t._createLineOfSightAnalysis(e);t._analyses.add(i)}t._setDirty(S.Task.LINE_OF_SIGHT_TOOL_INTERACTIVE)})),e.removed.forEach((function(e){var i=t._analyses.find((function(t){return t.point.location===e.location}));t._destroyLineOfSightAnalysis(i),t._analyses.remove(i)}))},u.prototype._onTargetLocationChange=function(e,t){e.isValid=!1,e.point.location=t,e.point.intersection=null,e.point.manipulator.location=t,e.isDirty=!0,this._setDirty(S.Task.LINE_OF_SIGHT_TOOL_INTERACTIVE)},u.prototype._onGroundOpacityChange=function(e,t){this._analyses.length&&(1!==e&&1!==t||e===t||(this._setDirty(S.Task.LINE_OF_SIGHT_TOOL),this._analyses.forEach((function(e){return e.isDirty=!0}))))},u.prototype._onContentChange=function(){this._analyses.forEach((function(e){e.isDirty=!0,e.shouldIntersect=!0})),this._setDirty(S.Task.LINE_OF_SIGHT_TOOL)},u.prototype._onCameraChange=function(){if(this._analyses.length){var e=!1;if(this.observer){this.view.renderCoordsHelper.toRenderCoords(this.observer,M);var t=this.view.state.camera.computeScreenPixelSizeAt(M);e=e||Math.abs((t-this._screenPixelSize)/this._screenPixelSize)>.1}this._analyses.some((function(e){return!e.isValid}))&&(e=!0),e&&(this._setDirty(S.Task.LINE_OF_SIGHT_TOOL),this._analyses.forEach((function(e){return e.isDirty=!0})))}},u.prototype._onSlicePlaneChange=function(){this._analyses.length&&(this._setDirty(S.Task.LINE_OF_SIGHT_TOOL_INTERACTIVE),this._analyses.forEach((function(e){return e.isDirty=!0})))},u.prototype._addPointFromClickEvent=function(e){var t=this._getScreenPointIntersection(e);if(t&&t.point)if(this.observer){var i=new w({location:t.point}),r=this._createLineOfSightAnalysis(i);this._analyses.add(r),r.point.intersection=t,this.targets.add(i)}else this.observer=t.point,this._observer.intersection=t},u.prototype._clickHandler=function(e){this._showTracker&&(this._addPointFromClickEvent({x:e.x,y:e.y}),e.stopPropagation())},u.prototype._doubleClickHandler=function(e){this._showTracker&&(this.stop(),e.stopPropagation())},u.prototype._keyDownHandler=function(e){this._showTracker&&"Escape"===e.key&&(this.stop(),e.stopPropagation())},u.prototype._pointerMoveHandler=function(e){if(this._showTracker){var t={x:e.x,y:e.y},i=this._getScreenPointIntersection(t);i&&(this._tracker.point.manipulator.location=i.point,this._tracker.isDirty=!0,this._updateLaserLineRenderer(),this._setDirty(S.Task.LINE_OF_SIGHT_TOOL_INTERACTIVE))}},u.prototype._getScreenPointIntersection=function(e){var t=s.screenPointObjectToArray(e,m.sv2d.get()),i=f.ray.fromScreen(this.view.state.camera,t,V);return this._getRayIntersection(i)},u.prototype._getRayIntersection=function(e){this.view.sceneIntersectionHelper.intersectToolIntersectorRay(e,this._intersector);var t=this._intersector.results.min;if(!t||!t.getIntersectionPoint(M))return null;var i=new h;this.view.renderCoordsHelper.fromRenderCoords(M,i,this.view.spatialReference);var r=p.vec3f64.create();d.vec3.copy(r,t.normal);var n=d.vec3.dot(r,e.direction)>0?-1:1;d.vec3.scale(r,r,n);var o=t.toGraphic(this.view);if(a.isSome(o)){var s=o.layer,l=o.sourceLayer,c=void 0;if(l)switch(l.type){case"scene":c=_.getObjectId(o,l.objectIdField);break;case"integrated-mesh":var u;c=(u=t.target).metadata.nodeIndex+"/"+u.metadata.componentIndex;break;default:c=o.uid}else c=o.uid;return{type:"Graphic",id:s.uid+"/"+c,ray:f.ray.copy(e),normal:r,point:i}}return"TerrainRenderer"===t.intersector?{type:"Terrain",id:(u=t.target).metadata.tile.lij.slice(),ray:f.ray.copy(e),normal:r,point:i}:null},u.prototype._createLineOfSightAnalysis=function(e){var t=this,i=this.configuration,r={isValid:!1,isDirty:!0,shouldRender:!0,shouldIntersect:!1,point:{location:e.location,manipulator:this._addManipulator({size:i.targetManipulatorSize,customColor1:i.targetManipulatorVisibleColor,customColor2:i.targetManipulatorOccludedColor,customColor3:i.targetManipulatorUndefinedColor}),intersection:null},isTargetVisible:!1,hasIntersection:!1,target:e,targetHandle:null,engine:{points:{observer:p.vec3f64.create(),target:p.vec3f64.create(),intersection:p.vec3f64.create(),intersectionObserver:p.vec3f64.create(),intersectionTarget:p.vec3f64.create()},visualization:new L}};return r.point.manipulator.location=e.location,r.targetHandle=l.init(e,"location",(function(e){return t._onTargetLocationChange(r,e)}),!0),this.manipulators.add(r.point.manipulator),this.view._stage.add(1,r.engine.visualization),this._engineLayer.addObject(r.engine.visualization),r},u.prototype._destroyLineOfSightAnalysis=function(e){e.targetHandle.remove(),this.manipulators.remove(e.point.manipulator),this.view._stage.remove(1,e.engine.visualization.id),this._engineLayer.removeObject(e.engine.visualization)},u.prototype._canComputeAnalysis=function(e){this.view.renderCoordsHelper.toRenderCoords(this.observer,M);var t=this.view.frustum.intersectsPoint(M);this.view.renderCoordsHelper.toRenderCoords(e.point.location,M);var i=this.view.frustum.intersectsPoint(M);return t&&i},u.prototype._manipulatorGrabChanged=function(e,t){switch(t.action){case"start":this._grabbedManipulator=e;break;case"end":this._grabbedManipulator===e&&(this._grabbedManipulator=null)}this._updateTrackerVisibility()},u.prototype._canUpdateFromIntersectionResult=function(e,t){if(!e||!t||e.type!==t.type)return!1;if("Terrain"===e.type){var i=e.id,r=t.id;return i[0]===r[0]&&i[1]===r[1]&&i[2]===r[2]||b.tilesAreRelated(i,r)}return("Graphic"===e.type||"I3S"===e.type)&&e.id===t.id},u.prototype._updateFromIntersectionResult=function(e){var t;if("Terrain"===e.type){this.view.renderCoordsHelper.toRenderCoords(e.point,E),this.view.renderCoordsHelper.worldUpAtPosition(E,G);var i=this.view.basemapTerrain.elevationBounds,r=this.view.renderCoordsHelper.getAltitude(E),n=i?Math.abs(i.max-i.min)/Math.abs(r):100,o=r>0?1:-1;d.vec3.normalize(G,G),d.vec3.scale(G,G,o*n),d.vec3.add(k,E,G),f.ray.fromPoints(k,E,V),t=this._getRayIntersection(V)}else t=this._getRayIntersection(e.ray);return this._canUpdateFromIntersectionResult(t,e)?t.point:null},u.prototype._updateAnalyses=function(e){var t=this;if(this.observer){if(this._analyses.some((function(e){return e.shouldIntersect}))){var i=this._observer.intersection,r=i&&this._updateFromIntersectionResult(i);r&&(this._observer.manipulator.location=r)}this._set("updating",this._updateAnalysis(this._tracker,"tracker")||this._analyses.items.some((function(i,r){return t._updateAnalysis(i,""+r,e)})))}else this._set("updating",!1)},u.prototype._updateAnalysis=function(e,t,i){if(!e.shouldRender)return e.engine.visualization.removeAllGeometries(),e.isDirty=!1,!1;if(!e.isDirty)return!1;if(e.shouldIntersect){var r=e.point.intersection,n=r&&this._updateFromIntersectionResult(r);n&&(e.point.manipulator.location=n),e.shouldIntersect=!1}this.view.renderCoordsHelper.toRenderCoords(e.point.manipulator.location,e.engine.points.target),this.view.renderCoordsHelper.toRenderCoords(this._observer.manipulator.location,e.engine.points.observer);var o="tracker"===t||this._canComputeAnalysis(e),a=e.engine,s=a.points.observer,l=a.points.target;this._screenPixelSize=this.view.state.camera.computeScreenPixelSizeAt(s),this._observer.intersection?d.vec3.copy(G,this._observer.intersection.normal):d.vec3.subtract(G,l,s);var c=this._screenPixelSize;d.vec3.normalize(G,G),d.vec3.scale(G,G,Math.min(c,1)),d.vec3.add(k,s,G),e.point.intersection?d.vec3.copy(G,e.point.intersection.normal):d.vec3.subtract(G,s,l);var u=this.view.state.camera.computeScreenPixelSizeAt(l);if(d.vec3.normalize(G,G),d.vec3.scale(G,G,Math.min(u,1)),d.vec3.add(E,l,G),o){var p=f.ray.fromPoints(k,E,V);if(this.view.sceneIntersectionHelper.intersectToolIntersectorRay(p,this._intersector),e.hasIntersection=!!this._intersector.results.min&&this._intersector.results.min.getIntersectionPoint(P),e.isTargetVisible=!0,e.hasIntersection){d.vec3.copy(a.points.intersection,P),d.vec3.copy(a.points.intersectionObserver,k),d.vec3.copy(a.points.intersectionTarget,E),this.view.renderCoordsHelper.fromRenderCoords(a.points.intersection,M,this.view.spatialReference);var _=1-d.vec3.dist(E,l)/d.vec3.dist(s,l);e.isTargetVisible=d.vec3.dist(s,a.points.intersection)>=_*d.vec3.dist(s,l)}e.isValid=!0;var v=new h(M,this.view.spatialReference);e.target.intersectedLocation=e.isTargetVisible?null:v,e.target.intersectedGraphic=e.isTargetVisible?null:this._intersector.results.min.toGraphic(this.view),e.target.visible=!!e.hasIntersection&&e.isTargetVisible}else if(e.isValid){d.vec3.copy(P,a.points.intersection);var y=d.vec3.dist(e.engine.points.intersectionObserver,a.points.intersection)/d.vec3.dist(e.engine.points.intersectionObserver,e.engine.points.intersectionTarget);d.vec3.sub(A,k,e.engine.points.intersectionObserver),d.vec3.scale(A,A,1-y),d.vec3.add(P,P,A),d.vec3.sub(A,E,e.engine.points.intersectionTarget),d.vec3.scale(A,A,y),d.vec3.add(P,P,A)}else e.hasIntersection=!1,e.target.intersectedLocation=null,e.target.intersectedGraphic=null,e.target.visible=void 0;return H[12]=a.points.observer[0],H[13]=a.points.observer[1],H[14]=a.points.observer[2],d.vec3.subtract(k,k,a.points.observer),d.vec3.subtract(E,E,a.points.observer),d.vec3.subtract(P,P,a.points.observer),e.engine.visualization.removeAllGeometries(),e.isValid?(e.point.manipulator.state=e.isTargetVisible?16:32,e.engine.visualization.addGeometry(g.createPolylineGeometry(k,e.isTargetVisible?E:P,t+"-visible-inner"),this._engineResources.visibleLineMaterialInner,H),e.isTargetVisible?e.engine.visualization.addGeometry(g.createPolylineGeometry(k,e.isTargetVisible?E:P,t+"-visible-outer"),this._engineResources.visibleLineMaterialOuter,H):(e.engine.visualization.addGeometry(g.createPolylineGeometry(P,E,t+"-occluded-inner"),this._engineResources.occludedLineMaterialInner,H),e.engine.visualization.addGeometry(g.createPolylineGeometry(k,E,t+"-occluded-outer"),this._engineResources.occludedLineMaterialOuter,H))):(e.point.manipulator.state=64,e.engine.visualization.addGeometry(g.createPolylineGeometry(k,E,t+"-observer-inner"),this._engineResources.undefinedLineMaterialInner,H),e.engine.visualization.addGeometry(g.createPolylineGeometry(k,E,t+"-observer-inner"),this._engineResources.undefinedLineMaterialOuter,H)),e.isDirty=!1,!!i&&(i.madeProgress(),i.done)},i.__decorate([c.property({constructOnly:!0})],u.prototype,"view",void 0),i.__decorate([c.property({dependsOn:["_showTracker","observer"],readOnly:!0})],u.prototype,"state",null),i.__decorate([c.property({readOnly:!0,dependsOn:["_showTracker"]})],u.prototype,"cursor",null),i.__decorate([c.property({dependsOn:["view.type"],readOnly:!0})],u.prototype,"isSupported",null),i.__decorate([c.property({type:h})],u.prototype,"observer",void 0),i.__decorate([c.property({type:t.LineOfSightTargetCollection,nonNullable:!0})],u.prototype,"targets",void 0),i.__decorate([c.property({type:v.Configuration})],u.prototype,"configuration",void 0),i.__decorate([c.property({readOnly:!0})],u.prototype,"updating",void 0),i.__decorate([c.property()],u.prototype,"_showTracker",void 0),u=i.__decorate([c.subclass("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightTool")],u)}(I.InteractiveToolBase);t.LineOfSightTool=R;var M=p.vec3f64.create(),k=p.vec3f64.create(),E=p.vec3f64.create(),P=p.vec3f64.create(),G=p.vec3f64.create(),V=f.ray.create(),A=p.vec3f64.create(),H=u.mat4f64.create(),D=f.lineSegment.create()}));