/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../Color","../../../../../core/Collection","../../../../../core/Handles","../../../../../core/handleUtils","../../../../../core/maybe","../../../../../core/promiseUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/accessorSupport/ensureType","../../../../../core/Logger","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/accessorSupport/trackingUtils","../../../../../chunks/vec3","../../../../../chunks/vec3f64","../../../../../geometry/Point","../../../../../geometry/support/lineSegment","./LineOfSightRayIntersector","./LineOfSightToolConfiguration","./lineOfSightToolUtils","../../graphics/LineOfSight/LineOfSightAnalysis","../../graphics/LineOfSight/LineOfSightController","../../graphics/LineOfSight/LineOfSightView","../../visualElements/LaserlineVisualElement","../../../../interactive/dragEventPipeline","../../../../interactive/InteractiveToolBase","../../../../support/Scheduler","../../../../../widgets/LineOfSight/LineOfSightTarget"],(function(e,t,i,n,o,r,a,s,l,c,h,u,_,p,d,g,y,f,m,v,T,O,S,b,L,C,M,I,k,w){"use strict";const E=o.ofType(w);e.LineOfSightTool=function(e){function i(t){var i;return(i=e.call(this,t)||this)._showTracker=!0,i._someManipulatorsFocused=!1,i._tasks=k.ImmediateTask,i._laserlineVisualElement=null,i._grabbedManipulator=null,i._handles=new r,i._manipulatorHandles=new r,i._analysisHandles=new r,i.lineOfSightView=new L.LineOfSightView({model:t.model,view:t.view}),i.lineOfSightController=new b.LineOfSightController({model:t.model,view:t.view}),i}t._inheritsLoose(i,e);var o=i.prototype;return o.initialize=function(){var e;const t=d.reactionInit((()=>this.state),(e=>{switch(e){case"created":this.complete();break;default:this.finishToolCreation()}}));this._intersector=new v.LineOfSightRayIntersector({view:this.view});const i=this._handles,n=null==(e=this.view.resourceController)?void 0:e.scheduler;n&&(this._tasks=n.registerTask(k.TaskPriority.LINE_OF_SIGHT_TOOL)),this._observerManipulator=this._createObserverManipulator(),i.add([t,d.reaction((()=>({...this.configuration.observer})),(()=>this._updateObserverManipulatorStyle())),this._createLineOfSightTracker(),d.reactionInit((()=>this.model.observer),(e=>this._onObserverChange(e))),d.reactionInit((()=>({...this.configuration.laserLine})),(()=>this._createVisualElements())),this._connectAnalyses()]),s.applySome(this.view.pointsOfInterest,(e=>i.add(this._connectObserverToContentChange(e)))),this.continue()},o.destroy=function(){this.detach(),this.manipulators.remove(this._observerManipulator),this.lineOfSightView.destroy(),this.lineOfSightController.destroy(),this._handles=s.destroyMaybe(this._handles),this._analysisHandles=s.destroyMaybe(this._analysisHandles),this._manipulatorHandles=s.destroyMaybe(this._manipulatorHandles),this._removeVisualElements(),this._intersector=null,this._set("model",null)},o.continue=function(){this.view.activeTool=this,this._showTracker=!0,this._manipulatorFocusChanged()},o.stop=function(){this._showTracker=!1,this._setPriority(k.TaskPriority.LINE_OF_SIGHT_TOOL_INTERACTIVE),this._manipulatorFocusChanged()},o.onInputEvent=function(e){switch(e.type){case"immediate-double-click":this._doubleClickHandler(e);break;case"key-down":this._keyDownHandler(e);break;case"pointer-move":this._pointerMoveHandler(e)}},o.onInputEventAfter=function(e){switch(e.type){case"immediate-click":this._clickHandler(e)}},o.onShow=function(){this.model.visible=!0},o.onHide=function(){this.model.visible=!1},o._setPriority=function(e){this._tasks.priority=e,this.lineOfSightController.priority=e},o._createLineOfSightTracker=function(){const e=new w({location:new f}),t=new S.LineOfSightAnalysis({target:e}),i=this._createTargetManipulator(t);i.available=!1,i.interactive=!1;const n=this.lineOfSightView.createLineOfSightVisualization(),o={analysis:t,interpolationInfo:{originalIntersection:y.create(),originalObserver:y.create(),originalTarget:y.create()}};let r=null;const l=d.reactionInit((()=>this._shouldRenderTracker),(e=>{r=s.removeMaybe(r),n.visibleLineVisualElement.attached=e,n.occludedLineVisualElement.attached=e,n.undefinedLineVisualElement.attached=e,e&&(r=a.handlesGroup([d.reaction((()=>({...this.configuration.target})),(()=>this._updateTargetManipularStyle(i))),d.reactionInit((()=>this._observerEngineLocation),(e=>this._onObserverEngineLocationChange(i,e))),d.reactionInit((()=>this.lineOfSightController.getLineOfSightComputationDependencies(t)),(()=>this.lineOfSightController.computeAnalysis(o,!0))),d.reactionInit((()=>this.lineOfSightView.getLineOfSightVisualizationDependencies(t)),(()=>this.lineOfSightView.updateLineOfSightVisualization(t,n))),d.reactionInit((()=>this._getLineOfSightManipulatorStateDependencies(t)),(()=>this._updateManipulatorState(i))),d.reaction((()=>({camera:this.view.state.camera,isDirty:this._isCameraDirty})),(({isDirty:e})=>this._onCameraChange(i,e))),d.reaction((()=>s.mapOr(this.view.map,1,(e=>e.ground.opacity))),((e,t)=>this._onGroundOpacityChange(i,e,t))),d.reactionInit((()=>this.view.slicePlane),(()=>this._onSlicePlaneChange(i))),d.reaction((()=>t.target.location),(e=>this._onTargetLocationChange(i,e)))]))}));return this._trackerManipulator=i,a.makeHandle((()=>{l.remove(),r=s.removeMaybe(r),this.lineOfSightView.destroyLineOfSightVisualization(n),this._removeManipulator(i)}))},o._removeManipulator=function(e){this.manipulators.remove(e),this._manipulatorHandles.remove(e),e.metadata=null},o._createManipulator=function(e,t,i){const n=O.createSphereManipulator(this.view,e);return n.metadata=i,this._manipulatorHandles.add([t(n),n.events.on("focus-changed",(()=>this._manipulatorFocusChanged())),n.events.on("grab-changed",(e=>this._manipulatorGrabChanged(n,e))),n.events.on("immediate-click",(e=>e.stopPropagation()))],n),this.manipulators.add(n),this._setPriority(k.TaskPriority.LINE_OF_SIGHT_TOOL_INTERACTIVE),n},o._createTargetManipulator=function(e,t,i){const n=this.configuration,o={size:n.target.size,customColor1:n.target.visibleColor,customColor2:n.target.occludedColor,customColor3:n.target.undefinedColor},r=this._createManipulator(o,(e=>this._createTargetManipulatorDragPipeline(e)),{analysis:e,intersection:i});return this._setTargetManipulatorLocation(r,t),r},o._createObserverManipulator=function(){const e=this.configuration,t={size:e.observer.size,color:e.observer.color,visible:!0};return this._createManipulator(t,(e=>this._createObserverManipulatorDragPipeline(e)),null)},o._updateTargetManipularStyle=function(e){const t=this.configuration.target,i={size:t.size,customColor1:t.visibleColor,customColor2:t.occludedColor,customColor3:t.undefinedColor};e.renderObjects=O.createSphereManipulatorRenderObjects(i)},o._updateObserverManipulatorStyle=function(){const e=this._observerManipulator,t=this.configuration.observer,i={size:t.size,color:t.color,visible:e.available};e.renderObjects=O.createSphereManipulatorRenderObjects(i)},o._manipulatorFocusChanged=function(){this._someManipulatorsFocused=this.manipulators.some((e=>e.manipulator.focused)),this._updateLaserLineRenderer()},o._screenToIntersection=function(){return e=>{const t=this._intersector.getScreenPointIntersection(e.screenEnd);return s.isNone(t)?null:{...e,intersection:t}}},o._createTargetManipulatorDragPipeline=function(e){return M.createManipulatorDragEventPipeline(e,((t,i,n)=>{i.next(this._screenToIntersection()).next(this._updateAnalysisDragStep(e)).next((()=>this._updateLaserLineRenderer())),n.next(this._cancelAnalysisDragStep(e)).next((()=>this._updateLaserLineRenderer()))}))},o._createObserverManipulatorDragPipeline=function(e){return M.createManipulatorDragEventPipeline(e,((e,t,i)=>{t.next(this._screenToIntersection()).next(this._updateObserverDragStep()).next((()=>this._updateLaserLineRenderer())),i.next(this._cancelObserverDragStep()).next((()=>this._updateLaserLineRenderer()))}))},o._updateObserverDragStep=function(){return e=>(this.model.observer=e.intersection.point,this._observerManipulator.metadata=e.intersection,e)},o._cancelObserverDragStep=function(){const e=s.isSome(this.model.observer)?this.model.observer.clone():null,t=this._observerManipulator.metadata;return i=>(this.model.observer=e,this._observerManipulator.metadata=t,i)},o._updateAnalysisDragStep=function(e){return t=>(e.metadata.analysis.target.location=t.intersection.point,e.metadata.intersection=t.intersection,t)},o._cancelAnalysisDragStep=function(e){const{metadata:t}=e,{analysis:i,intersection:n}=t,o=s.mapOr(i.target.location,null,(e=>e.clone())),r=n;return t=>(i.target.location=o,e.metadata.intersection=r,t)},o._manipulatorGrabChanged=function(e,t){switch(t.action){case"start":this._grabbedManipulator=e;break;case"end":this._grabbedManipulator===e&&(this._grabbedManipulator=null)}this._manipulatorFocusChanged()},o._updateManipulatorState=function(e){const t=e.metadata.analysis,{isValid:i,isTargetVisible:n}=t.computationResult;e.state=i?n?16:32:64},o._getLineOfSightManipulatorStateDependencies=function(e){const{isValid:t,isTargetVisible:i}=e.computationResult;return{isValid:t,isTargetVisible:i}},o._setTargetManipulatorLocation=function(e,t){s.isNone(t)||(e.location=t,this._onTargetManipulatorLocationChange(e))},o._updateLaserLineRenderer=function(){if(s.isNone(this._laserlineVisualElement))return;const e=this._laserlineVisualElement,t=s.isSome(this._grabbedManipulator)?this._grabbedManipulator:this._shouldRenderTracker&&this.model.observer?this._trackerManipulator:null;this.configuration.laserLine.enabled&&s.isSome(t)?(e.heightManifoldTarget=t.renderLocation,t!==this._observerManipulator?e.lineVerticalPlaneSegment=m.fromPoints(this._observerManipulator.renderLocation,t.renderLocation,V):e.lineVerticalPlaneSegment=null):(e.heightManifoldTarget=null,e.lineVerticalPlaneSegment=null)},o._createVisualElements=function(){const e=this.configuration.laserLine;this._removeVisualElements(),this._laserlineVisualElement=new C.LaserlineVisualElement({view:this.view,attached:!0,style:{glowColor:n.toUnitRGB(e.glowColor),glowWidth:e.glowWidth,innerColor:n.toUnitRGB(e.innerColor),innerWidth:e.innerWidth,globalAlpha:e.globalAlpha}}),this._setPriority(k.TaskPriority.LINE_OF_SIGHT_TOOL_INTERACTIVE)},o._removeVisualElements=function(){s.isSome(this._laserlineVisualElement)&&(this._laserlineVisualElement.destroy(),this._laserlineVisualElement=null)},o._onObserverChange=function(e){s.isNone(e)?this._observerManipulator.available=!1:(this._observerManipulator.metadata=null,this._observerManipulator.available=!0,this._observerManipulator.location=e,this._setTargetManipulatorLocation(this._trackerManipulator,e),this._setPriority(k.TaskPriority.LINE_OF_SIGHT_TOOL_INTERACTIVE))},o._onTargetLocationChange=function(e,t){e.metadata.intersection=null,this._setTargetManipulatorLocation(e,t),this._setPriority(k.TaskPriority.LINE_OF_SIGHT_TOOL_INTERACTIVE)},o._onGroundOpacityChange=function(e,t,i){1!==t&&1!==i||t===i||(this._onTargetManipulatorLocationChange(e),this._setPriority(k.TaskPriority.LINE_OF_SIGHT_TOOL_INTERACTIVE))},o._onCameraChange=function(e,t){const{analysis:i}=e.metadata;i.inputPoints.isValid&&!t||(this._onTargetManipulatorLocationChange(e),this._setPriority(k.TaskPriority.LINE_OF_SIGHT_TOOL_INTERACTIVE))},o._onSlicePlaneChange=function(e){this._onTargetManipulatorLocationChange(e),this._setPriority(k.TaskPriority.LINE_OF_SIGHT_TOOL_INTERACTIVE)},o._onObserverEngineLocationChange=function(e,t){const{analysis:i}=e.metadata,{inputPoints:n}=i,{observer:o}=n;g.copy(o,t),this._adjustInputPoints(n,this._observerManipulator.metadata,e.metadata.intersection),i.updateInputPoints()},o._onTargetManipulatorLocationChange=function(e){const t=this.view.renderCoordsHelper;if(s.isNone(t))return;const{metadata:i}=e,{analysis:n,intersection:o}=i,{inputPoints:r}=n,{target:a}=r;t.toRenderCoords(e.location,a),this._adjustInputPoints(r,this._observerManipulator.metadata,o),n.updateInputPoints()},o._onAnalysesCollectionChange=function(e){e.added.forEach((e=>this._connectAnalysis(e))),e.removed.forEach((e=>this._disconnectAnalysis(e)))},o._addPointFromClickEvent=function(e){const t=this._intersector.getScreenPointIntersection(e);if(!s.isNone(t)&&!s.isNone(t.point))if(this.model.observer){const e=new w({location:t.point}),i=new S.LineOfSightAnalysis({target:e});this._connectAnalysis(i,t),this._analyses.add(i),this.model.targets.add(e)}else this.model.observer=t.point,this._observerManipulator.metadata=t},o._clickHandler=function(e){this._showTracker&&(this._addPointFromClickEvent({x:e.x,y:e.y}),e.stopPropagation())},o._doubleClickHandler=function(e){this._showTracker&&(this.stop(),e.stopPropagation())},o._keyDownHandler=function(e){this._showTracker&&"Escape"===e.key&&(this.stop(),e.stopPropagation())},o._pointerMoveHandler=function(e){if(!this._showTracker)return;const t={x:e.x,y:e.y},i=this._intersector.getScreenPointIntersection(t);s.isSome(i)&&(this._setTargetManipulatorLocation(this._trackerManipulator,i.point),this._updateLaserLineRenderer(),this._setPriority(k.TaskPriority.LINE_OF_SIGHT_TOOL_INTERACTIVE))},o._refineObserverManipulatorPosition=function(){const e=this._observerManipulator,t=e.metadata;if(this._analyses.length<1||s.isNone(t))return;const i=this._intersector.updateFromIntersectionResult(t);if(s.isNone(i))return;e.location=i;const n=y.create();this.view.renderCoordsHelper.toRenderCoords(e.location,n),this._observerEngineLocation=n},o._refineTargetManipulatorPosition=function(e){const{intersection:t}=e.metadata;if(s.isNone(t))return;const i=this._intersector.updateFromIntersectionResult(t);this._setTargetManipulatorLocation(e,i)},o._adjustInputPoints=function(e,t,i){const n=P,{observer:o,target:r,observerAdjusted:a,targetAdjusted:l}=e;s.isSome(t)?g.copy(n,t.normal):g.subtract(n,r,o);const c=this._screenPixelSize;g.normalize(n,n),g.scale(n,n,Math.min(c,1)),g.add(a,o,n),s.isSome(i)?g.copy(n,i.normal):g.subtract(n,o,r);const h=this.view.state.camera.computeScreenPixelSizeAt(r);g.normalize(n,n),g.scale(n,n,Math.min(h,1)),g.add(l,r,n)},o._connectAnalyses=function(){let e=null;return a.handlesGroup([d.reactionInit((()=>this._analyses),(t=>{e=s.removeMaybe(e),e=t.on("change",(e=>this._onAnalysesCollectionChange(e))),this._onAnalysesCollectionChange({target:t,added:t.items,removed:[],moved:[]})})),a.makeHandle((()=>e=s.removeMaybe(e)))])},o._connectAnalysis=function(e,t){const i=this._analysisHandles;if(i.has(e))return;const{target:n}=e,o=this._createTargetManipulator(e,n.location,t),r=[d.reactionInit((()=>this._getLineOfSightManipulatorStateDependencies(e)),(()=>this._updateManipulatorState(o))),d.reactionInit((()=>this._observerEngineLocation),(e=>this._onObserverEngineLocationChange(o,e))),d.reaction((()=>({camera:this.view.state.camera,isDirty:this._isCameraDirty})),(({isDirty:e})=>this._onCameraChange(o,e))),d.reaction((()=>s.mapOr(this.view.map,1,(e=>e.ground.opacity))),((e,t)=>this._onGroundOpacityChange(o,e,t))),d.reactionInit((()=>this.view.slicePlane),(()=>this._onSlicePlaneChange(o))),d.reaction((()=>e.target.location),(e=>this._onTargetLocationChange(o,e))),d.reaction((()=>({...this.configuration.target})),(()=>this._updateTargetManipularStyle(o))),a.makeHandle((()=>{this._removeManipulator(o)}))];s.applySome(this.view.pointsOfInterest,(e=>r.push(this._connectTargetToContentChange(o,e)))),i.add(r,e),this._setPriority(k.TaskPriority.LINE_OF_SIGHT_TOOL_INTERACTIVE)},o._disconnectAnalysis=function(e){this._analysisHandles.remove(e)},o._connectObserverToContentChange=function(e){var i=this;let n=s.none;const o=()=>{n=s.abortMaybe(n),s.isNone(this._observerManipulator.metadata)||(n=l.createTask(function(){var e=t._asyncToGenerator((function*(e){i._setPriority(k.TaskPriority.LINE_OF_SIGHT_TOOL_INTERACTIVE),yield l.ignoreAbortErrors(i._tasks.schedule((()=>i._refineObserverManipulatorPosition()),e))}));return function(t){return e.apply(this,arguments)}}()))},r=e.contentGeometryUpdates.events.on("request-update",o),c=this.view.elevationProvider.on("elevation-change",o);return a.makeHandle((()=>{n=s.abortMaybe(n),r.remove(),c.remove()}))},o._connectTargetToContentChange=function(e,i){var n=this;let o=s.none;const r=()=>{o=s.abortMaybe(o),o=l.createTask(function(){var i=t._asyncToGenerator((function*(t){n._setPriority(k.TaskPriority.LINE_OF_SIGHT_TOOL_INTERACTIVE),yield l.ignoreAbortErrors(n._tasks.schedule((()=>{n._refineTargetManipulatorPosition(e),n._onTargetManipulatorLocationChange(e)}),t))}));return function(e){return i.apply(this,arguments)}}())},c=i.contentGeometryUpdates.events.on("request-update",r),h=this.view.elevationProvider.on("elevation-change",r);return a.makeHandle((()=>{o=s.abortMaybe(o),c.remove(),h.remove()}))},t._createClass(i,[{key:"state",get:function(){return this._showTracker?"creating":s.isSome(this.model.observer)?"created":"ready"}},{key:"cursor",get:function(){return this._someManipulatorsFocused?null:this._showTracker?"crosshair":null}},{key:"isSupported",get:function(){var e;return"3d"===(null==(e=this.view)?void 0:e.type)}},{key:"updating",get:function(){return s.mapOr(this._tasks,!1,(e=>e.updating))||s.mapOr(this.lineOfSightController,!1,(e=>e.updating))}},{key:"configuration",get:function(){return this._viewData.configuration},set:function(e){this._viewData.configuration=e}},{key:"_viewData",get:function(){return this.model.viewData}},{key:"_screenPixelSize",get:function(){return this.view.state.camera.computeScreenPixelSizeAt(this._observerEngineLocation)}},{key:"_analyses",get:function(){return this._viewData.analyses}},{key:"_observerEngineLocation",get:function(){return this._viewData.observerEngineLocation},set:function(e){this._viewData.observerEngineLocation=e}},{key:"_shouldRenderTracker",get:function(){return this._showTracker&&s.isSome(this.model.observer)&&!this._someManipulatorsFocused}},{key:"_isCameraDirty",get:function(){const e=this.model.observer,{view:t}=this,{renderCoordsHelper:i}=t;if(s.isNone(e)||s.isNone(i))return!1;const n=P;i.toRenderCoords(e,n);const o=t.state.camera.computeScreenPixelSizeAt(n);return Math.abs((o-this._screenPixelSize)/this._screenPixelSize)>.1}}]),i}(I.InteractiveToolBase),i.__decorate([c.property({constructOnly:!0})],e.LineOfSightTool.prototype,"view",void 0),i.__decorate([c.property({constructOnly:!0})],e.LineOfSightTool.prototype,"model",void 0),i.__decorate([c.property({constructOnly:!0})],e.LineOfSightTool.prototype,"lineOfSightView",void 0),i.__decorate([c.property({constructOnly:!0})],e.LineOfSightTool.prototype,"lineOfSightController",void 0),i.__decorate([c.property({readOnly:!0})],e.LineOfSightTool.prototype,"state",null),i.__decorate([c.property({readOnly:!0})],e.LineOfSightTool.prototype,"cursor",null),i.__decorate([c.property({readOnly:!0})],e.LineOfSightTool.prototype,"isSupported",null),i.__decorate([c.property({readOnly:!0})],e.LineOfSightTool.prototype,"updating",null),i.__decorate([c.property({type:T.LineOfSightToolConfiguration})],e.LineOfSightTool.prototype,"configuration",null),i.__decorate([c.property()],e.LineOfSightTool.prototype,"_viewData",null),i.__decorate([c.property()],e.LineOfSightTool.prototype,"_screenPixelSize",null),i.__decorate([c.property()],e.LineOfSightTool.prototype,"_showTracker",void 0),i.__decorate([c.property()],e.LineOfSightTool.prototype,"_analyses",null),i.__decorate([c.property()],e.LineOfSightTool.prototype,"_observerEngineLocation",null),i.__decorate([c.property()],e.LineOfSightTool.prototype,"_shouldRenderTracker",null),i.__decorate([c.property()],e.LineOfSightTool.prototype,"_someManipulatorsFocused",void 0),i.__decorate([c.property()],e.LineOfSightTool.prototype,"_isCameraDirty",null),i.__decorate([c.property()],e.LineOfSightTool.prototype,"_tasks",void 0),i.__decorate([c.property()],e.LineOfSightTool.prototype,"_laserlineVisualElement",void 0),i.__decorate([c.property()],e.LineOfSightTool.prototype,"_grabbedManipulator",void 0),e.LineOfSightTool=i.__decorate([p.subclass("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightTool")],e.LineOfSightTool);const P=y.create(),V=m.create();e.LineOfSightTargetCollection=E,Object.defineProperty(e,"__esModule",{value:!0})}));
