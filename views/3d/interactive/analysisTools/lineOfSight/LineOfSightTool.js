/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../Color","../../../../../analysis/LineOfSightAnalysisObserver","../../../../../analysis/LineOfSightAnalysisTarget","../../../../../core/Collection","../../../../../core/Handles","../../../../../core/handleUtils","../../../../../core/Logger","../../../../../core/maybe","../../../../../core/reactiveUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/arrayUtils","../../../../../core/has","../../../../../core/accessorSupport/ensureType","../../../../../core/accessorSupport/decorators/subclass","../../../../../geometry/support/lineSegment","../../../analysis/LineOfSight/LineOfSightRayIntersector","./LineOfSightToolConfiguration","./lineOfSightToolUtils","../../visualElements/LaserlineVisualElement","../../../../interactive/dragEventPipeline","../../../../interactive/InteractiveToolBase","../../../../interactive/interfaces"],(function(e,t,i,n,a,o,r,s,l,c,u,h,p,d,g,_,y,v,m,f,b,T,S,M,L){"use strict";var C;!function(e){e.Ready="ready",e.Creating="creating",e.Created="created"}(C||(C={}));const w=r.ofType(o),O=c.getLogger("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightTool");e.LineOfSightTool=function(e){function i(t){var i;return(i=e.call(this,t)||this).configuration=new f.LineOfSightToolConfiguration,i.analysisView=null,i._someManipulatorsFocused=!1,i._laserlineVisualElement=null,i._grabbedManipulator=null,i._analysisHandles=new s,i._handles=new s,i._manipulatorHandles=new s,i._targetTrackerManipulator=null,i}t._inheritsLoose(i,e);var r=i.prototype;return r.initialize=function(){this._intersector=new m.LineOfSightRayIntersector({view:this.view}),this.startToolCreation(),this._handles.add(h.watch((()=>this.state),(e=>{e===C.Created&&this.finishToolCreation()}),h.syncAndInitial)),this._observerManipulator=this._createObserverManipulator(),this._handles.add([h.watch((()=>({...this.configuration.observer})),(()=>this._updateObserverManipulatorStyle()),h.sync),h.watch((()=>this.analysisView.elevationAlignedObserver),(e=>this._onObserverLocationChange(e)),h.syncAndInitial),h.watch((()=>({...this.configuration.laserLine})),(()=>this._createVisualElements()),h.syncAndInitial),this._connectComputations()])},r.destroy=function(){this._handles=u.destroyMaybe(this._handles),this._manipulatorHandles=u.destroyMaybe(this._manipulatorHandles),this._analysisHandles=u.destroyMaybe(this._analysisHandles),this._observerManipulator=null,this._clearTargetTracker(),this._removeVisualElements(),this._intersector=null,this._set("analysis",null)},r.continue=function(){this.view.activeTool=this},r.stop=function(){this.view.activeTool=null},r.onInputEvent=function(e){switch(e.type){case"immediate-double-click":this._doubleClickHandler(e);break;case"key-down":this._keyDownHandler(e);break;case"pointer-move":this._pointerMoveHandler(e)}},r.onInputEventAfter=function(e){if("immediate-click"===e.type)this._clickHandler(e)},r.onShow=function(){this.analysis.visible=!0},r.onHide=function(){this.analysis.visible=!1},r.onActivate=function(){this._manipulatorFocusChanged()},r.onDeactivate=function(){this._clearTargetTracker(),this._manipulatorFocusChanged()},r._connectComputations=function(){let e=null;return l.handlesGroup([h.watch((()=>this.analysisView.computations),(t=>{e=u.removeMaybe(e),e=t.on("change",(e=>this._onComputationsCollectionChange(e))),t.forEach((e=>this._connectComputation(e)))}),h.syncAndInitial),l.makeHandle((()=>e=u.removeMaybe(e)))])},r._onComputationsCollectionChange=function(e){e.added.forEach((e=>this._connectComputation(e))),e.removed.forEach((e=>this._disconnectComputation(e)))},r._connectComputation=function(e){if(this.destroyed)return void O.warn("Attempting to connect an analysis to a destroyed LineOfSight tool. Ignoring.");const t=this._analysisHandles;if(t.has(e))return;const i=this._createTargetManipulator(e.target);u.isNone(this._targetTrackerManipulator)&&i.metadata.target===this.analysisView.cursorTarget&&(this._targetTrackerManipulator=i,this._targetTrackerManipulator.available=!1,this._targetTrackerManipulator.interactive=!1,this._updateLaserLineRenderer()),t.add([h.watch((()=>this._getLineOfSightManipulatorStateDependencies(e)),(()=>this._updateManipulatorState(i,e)),h.syncAndInitial),h.watch((()=>e.elevationAlignedTargetLocation),(e=>this._onTargetLocationChange(e,i)),h.syncAndInitial)],e)},r._disconnectComputation=function(e){if(this.destroyed)return void O.warn("Attempting to disconnect an analysis from a destroyed LineOfSight tool. Ignoring.");this._analysisHandles.remove(e);const t=this._getTargetManipulator(e.target);u.isSome(t)&&(this.manipulators.remove(t),this._manipulatorHandles.remove(t),u.isSome(this._targetTrackerManipulator)&&this._targetTrackerManipulator===t&&(this._targetTrackerManipulator=null))},r._createTargetTracker=function(e){this.analysisView.cursorTarget=new o({position:e.point,intersection:e})},r._clearTargetTracker=function(){u.isSome(this.analysisView.cursorTarget)&&(this.analysisView.cursorTarget=u.destroyMaybe(this.analysisView.cursorTarget))},r._createManipulator=function(e,t,i){const n=b.createSphereManipulator(this.view,e);return n.metadata=i,this._manipulatorHandles.add([t(n),n.events.on("focus-changed",(()=>this._manipulatorFocusChanged())),n.events.on("grab-changed",(e=>this._manipulatorGrabChanged(n,e))),n.events.on("immediate-click",(e=>e.stopPropagation()))],n),this.manipulators.add(n),n},r._createTargetManipulator=function(e){const t=this.configuration,i={size:t.target.size,customColor1:t.target.visibleColor,customColor2:t.target.occludedColor,customColor3:t.target.undefinedColor,visible:!0},n={target:e,type:"target"},a=this._createManipulator(i,(e=>this._createTargetManipulatorDragPipeline(e)),n);return u.isSome(e.position)?a.elevationAlignedLocation=e.position:a.available=!1,a},r._getTargetManipulator=function(e){let t=null;return this.manipulators.forEach((i=>{const n=i.manipulator;u.isNone(t)&&"target"===n.metadata.type&&n.metadata.target===e&&(t=n)})),t},r._createObserverManipulator=function(){const e=this.configuration,t={size:e.observer.size,color:e.observer.color,visible:!0};return this._createManipulator(t,(e=>this._createObserverManipulatorDragPipeline(e)),{type:"observer",intersection:null})},r._updateObserverManipulatorStyle=function(){const e=this._observerManipulator,t=this.configuration.observer,i={size:t.size,color:t.color,visible:e.available};e.renderObjects=b.createSphereManipulatorRenderObjects(i)},r._manipulatorFocusChanged=function(){this._someManipulatorsFocused=this.manipulators.some((e=>e.manipulator.focused)),this._updateLaserLineRenderer()},r._screenToIntersection=function(){return e=>{const t=this._intersector.getScreenPointIntersection(e.screenEnd);return u.isNone(t)?null:{...e,intersection:t}}},r._createTargetManipulatorDragPipeline=function(e){return S.createManipulatorDragEventPipeline(e,((t,i,n)=>{i.next(this._screenToIntersection()).next(this._updateTargetDragStep(e)).next((()=>this._updateLaserLineRenderer())),n.next(this._cancelTargetDragStep(e.metadata.target)).next((()=>this._updateLaserLineRenderer()))}))},r._createObserverManipulatorDragPipeline=function(e){return S.createManipulatorDragEventPipeline(e,((e,t,i)=>{t.next(this._screenToIntersection()).next(this._updateObserverDragStep()).next((()=>this._updateLaserLineRenderer())),i.next(this._cancelObserverDragStep()).next((()=>this._updateLaserLineRenderer()))}))},r._updateObserverDragStep=function(){return e=>(u.isSome(this.analysis.observer)?(this.analysis.observer.position=e.intersection.point,this.analysis.observer.intersection=e.intersection):this.analysis.observer=new a({position:e.intersection.point,intersection:e.intersection}),e)},r._cancelObserverDragStep=function(){const e=u.isSome(this.analysis.observer)&&u.isSome(this.analysis.observer.position)?this.analysis.observer.clone():null;return t=>(this.analysis.observer=e,t)},r._updateTargetDragStep=function(e){return t=>{const i=t.intersection.point;return e.metadata.target.position=i,e.metadata.target.intersection=t.intersection,u.isSome(i)&&(e.elevationAlignedLocation=i),t}},r._cancelTargetDragStep=function(e){const t=u.applySome(e.position,(e=>e.clone())),i=e.intersection;return n=>(e.position=t,e.intersection=i,n)},r._manipulatorGrabChanged=function(e,t){switch(t.action){case"start":this._grabbedManipulator=e;break;case"end":this._grabbedManipulator===e&&(this._grabbedManipulator=null)}this._manipulatorFocusChanged()},r._updateManipulatorState=function(e,t){const{isValid:i,isTargetVisible:n}=t.computationResult;e.state=i?n?L.ManipulatorStateCustomFlags.Custom1:L.ManipulatorStateCustomFlags.Custom2:L.ManipulatorStateCustomFlags.Custom3},r._getLineOfSightManipulatorStateDependencies=function(e){const{isValid:t,isTargetVisible:i}=e.computationResult;return{isValid:t,isTargetVisible:i}},r._updateLaserLineRenderer=function(){if(u.isNone(this._laserlineVisualElement))return;const e=this._laserlineVisualElement,t=u.isSome(this._grabbedManipulator)?this._grabbedManipulator:this._shouldRenderTracker&&u.isSome(this.analysis.observer)&&u.isSome(this.analysis.observer.position)?this._targetTrackerManipulator:null;this.configuration.laserLine.enabled&&u.isSome(t)?(e.visible=!0,e.heightManifoldTarget=t.renderLocation,t!==this._observerManipulator?e.lineVerticalPlaneSegment=v.fromPoints(this._observerManipulator.renderLocation,t.renderLocation,k):e.lineVerticalPlaneSegment=null):(e.visible=!1,e.heightManifoldTarget=null,e.lineVerticalPlaneSegment=null)},r._createVisualElements=function(){const e=this.configuration.laserLine;this._removeVisualElements(),this._laserlineVisualElement=new T.LaserlineVisualElement({view:this.view,attached:!0,style:{glowColor:n.toUnitRGB(e.glowColor),glowWidth:e.glowWidth,innerColor:n.toUnitRGB(e.innerColor),innerWidth:e.innerWidth,globalAlpha:e.globalAlpha}})},r._removeVisualElements=function(){u.isSome(this._laserlineVisualElement)&&(this._laserlineVisualElement.destroy(),this._laserlineVisualElement=null)},r._onObserverLocationChange=function(e){u.isNone(e)?this._observerManipulator.available=!1:(this._observerManipulator.metadata.intersection=null,this._observerManipulator.available=!0,this._observerManipulator.elevationAlignedLocation=e)},r._onTargetLocationChange=function(e,t){u.isSome(e)?(t.elevationAlignedLocation=e,t!==this._targetTrackerManipulator&&(t.available=!0)):t.available=!1},r._addPointFromClickEvent=function(e){const t=this._intersector.getScreenPointIntersection(e);u.isNone(t)||u.isNone(t.point)||(u.isSome(this.analysis.observer)&&u.isSome(this.analysis.observer.position)?(this._clearTargetTracker(),this.analysis.targets.add(new o({position:t.point,intersection:t}))):this.analysis.observer=new a({position:t.point,intersection:t}))},r._clickHandler=function(e){this.active&&(this._addPointFromClickEvent({x:e.x,y:e.y}),e.stopPropagation())},r._doubleClickHandler=function(e){this.active&&(this.stop(),e.stopPropagation())},r._keyDownHandler=function(e){this.active&&"Escape"===e.key&&(this.stop(),e.stopPropagation())},r._pointerMoveHandler=function(e){if(this._latestPointerMovePointerType=e.pointerType,this._updateLaserLineRenderer(),!this._showTracker||u.isNone(this.analysis.observer)||u.isNone(this.analysis.observer.position))return;const t={x:e.x,y:e.y},i=this._intersector.getScreenPointIntersection(t);u.isSome(i)&&u.isSome(i.point)&&(u.isSome(this.analysisView.cursorTarget)?(this.analysisView.cursorTarget.position=i.point,this.analysisView.cursorTarget.intersection=i):this._createTargetTracker(i),this._updateLaserLineRenderer())},t._createClass(i,[{key:"state",get:function(){return this.active?u.isSome(this._grabbedManipulator)?C.Created:C.Creating:u.isSome(this.analysis.observer)&&u.isSome(this.analysis.observer.position)?C.Created:C.Ready}},{key:"cursor",get:function(){return!this._someManipulatorsFocused&&this.active&&this._showTracker?"crosshair":null}},{key:"updating",get:function(){return!!u.isSome(this.analysisView)&&this.analysisView.updating}},{key:"_showTracker",get:function(){return this.active&&"mouse"===this._latestPointerMovePointerType}},{key:"_shouldRenderTracker",get:function(){return this._showTracker&&u.isSome(this.analysis.observer)&&u.isSome(this.analysis.observer.position)&&!this._someManipulatorsFocused}},{key:"testInfo",get:function(){return{laserLineVisualElement:this._laserlineVisualElement}}}]),i}(M.InteractiveToolBase),i.__decorate([p.property({constructOnly:!0})],e.LineOfSightTool.prototype,"view",void 0),i.__decorate([p.property({constructOnly:!0})],e.LineOfSightTool.prototype,"analysis",void 0),i.__decorate([p.property({readOnly:!0})],e.LineOfSightTool.prototype,"state",null),i.__decorate([p.property({readOnly:!0})],e.LineOfSightTool.prototype,"cursor",null),i.__decorate([p.property({readOnly:!0})],e.LineOfSightTool.prototype,"updating",null),i.__decorate([p.property({type:f.LineOfSightToolConfiguration})],e.LineOfSightTool.prototype,"configuration",void 0),i.__decorate([p.property({constructOnly:!0})],e.LineOfSightTool.prototype,"analysisView",void 0),i.__decorate([p.property({readOnly:!0})],e.LineOfSightTool.prototype,"_showTracker",null),i.__decorate([p.property()],e.LineOfSightTool.prototype,"_latestPointerMovePointerType",void 0),i.__decorate([p.property()],e.LineOfSightTool.prototype,"_shouldRenderTracker",null),i.__decorate([p.property()],e.LineOfSightTool.prototype,"_someManipulatorsFocused",void 0),i.__decorate([p.property()],e.LineOfSightTool.prototype,"_laserlineVisualElement",void 0),i.__decorate([p.property()],e.LineOfSightTool.prototype,"_grabbedManipulator",void 0),e.LineOfSightTool=i.__decorate([y.subclass("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightTool")],e.LineOfSightTool);const k=v.create();e.LineOfSightTargetCollection=w,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
