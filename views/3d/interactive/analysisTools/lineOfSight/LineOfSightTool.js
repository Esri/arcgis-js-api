/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../Color","../../../../../core/Collection","../../../../../core/Handles","../../../../../core/handleUtils","../../../../../core/Logger","../../../../../core/maybe","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/accessorSupport/ensureType","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/accessorSupport/trackingUtils","../../../../../geometry/support/lineSegment","../../../../../layers/LineOfSightTarget","./LineOfSightToolConfiguration","./lineOfSightToolUtils","../../visualElements/LaserlineVisualElement","../../../layers/analysis/LineOfSight/LineOfSightRayIntersector","../../../../interactive/dragEventPipeline","../../../../interactive/InteractiveToolBase"],(function(e,t,i,r,n,a,o,s,l,c,u,h,d,p,g,_,y,m,f,v,T,b){"use strict";const S=n.ofType(_.LineOfSightTarget),L=s.getLogger("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightTool");e.LineOfSightTool=function(e){function i(t){var i;return(i=e.call(this,t)||this).configuration=new y.LineOfSightToolConfiguration,i.layerView=null,i._creating=!1,i._showTracker=!0,i._someManipulatorsFocused=!1,i._laserlineVisualElement=null,i._grabbedManipulator=null,i._analysisHandles=new a,i._handles=new a,i._manipulatorHandles=new a,i._targetTrackerManipulator=null,i}t._inheritsLoose(i,e);var n=i.prototype;return n.initialize=function(){this._initialize()},n._initialize=function(){var e=t._asyncToGenerator((function*(){if(this.layerView=yield this.view.whenLayerView(this.model),this.destroyed)return;this._intersector=new v.LineOfSightRayIntersector({view:this.view});const e=p.reaction((()=>this.state),(e=>{if("created"===e)this.complete();else this.finishToolCreation()}));this._handles.add([e]),"created"===this.state?this.complete():this.finishToolCreation(),this._observerManipulator=this._createObserverManipulator(),this._handles.add([p.reaction((()=>({...this.configuration.observer})),(()=>this._updateObserverManipulatorStyle())),p.reactionInit((()=>this.layerView.layerViewData.elevationAlignedObserver),(e=>this._onObserverLocationChange(e))),p.reactionInit((()=>({...this.configuration.laserLine})),(()=>this._createVisualElements()))]),this._connectAnalyses(),this.continue()}));function i(){return e.apply(this,arguments)}return i}(),n.destroy=function(){"pending"!==this.toolState&&(this.attached&&this.detach(),this._handles=l.destroyMaybe(this._handles),this._manipulatorHandles=l.destroyMaybe(this._manipulatorHandles),this._analysisHandles=l.destroyMaybe(this._analysisHandles),this.manipulators.removeAll(),this._observerManipulator=null,this._clearTargetTracker(),this._removeVisualElements(),this._intersector=null,this._set("model",null))},n.continue=function(){this.view.activeTool=this,this._creating=!0,this._showTracker=!0,this._manipulatorFocusChanged()},n.stop=function(){this._creating=!1,this._showTracker=!1,this._clearTargetTracker(),this._manipulatorFocusChanged()},n.onInputEvent=function(e){switch(e.type){case"immediate-double-click":this._doubleClickHandler(e);break;case"key-down":this._keyDownHandler(e);break;case"pointer-move":this._pointerMoveHandler(e)}},n.onInputEventAfter=function(e){if("immediate-click"===e.type)this._clickHandler(e)},n.onShow=function(){this.model.visible=!0},n.onHide=function(){this.model.visible=!1},n._connectAnalyses=function(){let e=null;return o.handlesGroup([p.reactionInit((()=>this.layerView.layerViewData.analyses),(t=>{e=l.removeMaybe(e),e=t.on("change",(e=>this._onAnalysesCollectionChange(e))),t.forEach((e=>this._connectAnalysis(e)))})),o.makeHandle((()=>e=l.removeMaybe(e)))])},n._onAnalysesCollectionChange=function(e){e.added.forEach((e=>this._connectAnalysis(e))),e.removed.forEach((e=>this._disconnectAnalysis(e)))},n._connectAnalysis=function(e){if(this.destroyed)return void L.warn("Attempting to connect an analysis to a destroyed LineOfSight tool. Ignoring.");const t=this._analysisHandles;if(t.has(e))return;const i=this._createTargetManipulator(e.target);l.isNone(this._targetTrackerManipulator)&&i.metadata.target===this.layerView.layerViewData.cursorTarget&&(this._targetTrackerManipulator=i,this._targetTrackerManipulator.available=!1,this._targetTrackerManipulator.interactive=!1,this._updateLaserLineRenderer()),t.add([p.reactionInit((()=>this._getLineOfSightManipulatorStateDependencies(e)),(()=>this._updateManipulatorState(i,e))),p.reactionInit((()=>e.elevationAlignedTargetLocation),(e=>this._onTargetLocationChange(e,i)))],e)},n._disconnectAnalysis=function(e){if(this.destroyed)return void L.warn("Attempting to disconnect an analysis from a destroyed LineOfSight tool. Ignoring.");this._analysisHandles.remove(e);const t=this._getTargetManipulator(e.target);l.isSome(t)&&(this.manipulators.remove(t),this._manipulatorHandles.remove(t),l.isSome(this._targetTrackerManipulator)&&this._targetTrackerManipulator===t&&(this._targetTrackerManipulator=null))},n._createTargetTracker=function(e){this.layerView.layerViewData.cursorTarget=new _.LineOfSightTarget({location:e.point,intersection:e})},n._clearTargetTracker=function(){l.isSome(this.layerView.layerViewData.cursorTarget)&&(this.layerView.layerViewData.cursorTarget=l.destroyMaybe(this.layerView.layerViewData.cursorTarget))},n._createManipulator=function(e,t,i){const r=m.createSphereManipulator(this.view,e);return r.metadata=i,this._manipulatorHandles.add([t(r),r.events.on("focus-changed",(()=>this._manipulatorFocusChanged())),r.events.on("grab-changed",(e=>this._manipulatorGrabChanged(r,e))),r.events.on("immediate-click",(e=>e.stopPropagation()))],r),this.manipulators.add(r),r},n._createTargetManipulator=function(e){const t=this.configuration,i={size:t.target.size,customColor1:t.target.visibleColor,customColor2:t.target.occludedColor,customColor3:t.target.undefinedColor,visible:!0},r={target:e,type:"target"},n=this._createManipulator(i,(e=>this._createTargetManipulatorDragPipeline(e)),r);return l.isSome(e.location)?n.elevationAlignedLocation=e.location:n.available=!1,n},n._getTargetManipulator=function(e){let t=null;return this.manipulators.forEach((i=>{const r=i.manipulator;l.isNone(t)&&"target"===r.metadata.type&&r.metadata.target===e&&(t=r)})),t},n._createObserverManipulator=function(){const e=this.configuration,t={size:e.observer.size,color:e.observer.color,visible:!0};return this._createManipulator(t,(e=>this._createObserverManipulatorDragPipeline(e)),{type:"observer",intersection:null})},n._updateObserverManipulatorStyle=function(){const e=this._observerManipulator,t=this.configuration.observer,i={size:t.size,color:t.color,visible:e.available};e.renderObjects=m.createSphereManipulatorRenderObjects(i)},n._manipulatorFocusChanged=function(){this._someManipulatorsFocused=this.manipulators.some((e=>e.manipulator.focused)),this._updateLaserLineRenderer()},n._screenToIntersection=function(){return e=>{const t=this._intersector.getScreenPointIntersection(e.screenEnd);return l.isNone(t)?null:{...e,intersection:t}}},n._createTargetManipulatorDragPipeline=function(e){return T.createManipulatorDragEventPipeline(e,((t,i,r)=>{i.next(this._screenToIntersection()).next(this._updateTargetDragStep(e)).next((()=>this._updateLaserLineRenderer())),r.next(this._cancelTargetDragStep(e.metadata.target)).next((()=>this._updateLaserLineRenderer()))}))},n._createObserverManipulatorDragPipeline=function(e){return T.createManipulatorDragEventPipeline(e,((e,t,i)=>{t.next(this._screenToIntersection()).next(this._updateObserverDragStep()).next((()=>this._updateLaserLineRenderer())),i.next(this._cancelObserverDragStep()).next((()=>this._updateLaserLineRenderer()))}))},n._updateObserverDragStep=function(){return e=>(this.model.observer=e.intersection.point,this.model.intersection=e.intersection,e)},n._cancelObserverDragStep=function(){const e=l.isSome(this.model.observer)?this.model.observer.clone():null,t=this.model.intersection;return i=>(this.model.observer=e,this.model.intersection=t,i)},n._updateTargetDragStep=function(e){return t=>{const i=t.intersection.point;return e.metadata.target.location=i,e.metadata.target.intersection=t.intersection,l.isSome(i)&&(e.elevationAlignedLocation=i),t}},n._cancelTargetDragStep=function(e){const t=l.mapOr(e.location,null,(e=>e.clone())),i=e.intersection;return r=>(e.location=t,e.intersection=i,r)},n._manipulatorGrabChanged=function(e,t){switch(t.action){case"start":this._grabbedManipulator=e;break;case"end":this._grabbedManipulator===e&&(this._grabbedManipulator=null)}this._manipulatorFocusChanged()},n._updateManipulatorState=function(e,t){const{isValid:i,isTargetVisible:r}=t.computationResult;e.state=i?r?16:32:64},n._getLineOfSightManipulatorStateDependencies=function(e){const{isValid:t,isTargetVisible:i}=e.computationResult;return{isValid:t,isTargetVisible:i}},n._updateLaserLineRenderer=function(){if(l.isNone(this._laserlineVisualElement))return;const e=this._laserlineVisualElement,t=l.isSome(this._grabbedManipulator)?this._grabbedManipulator:this._shouldRenderTracker&&this.model.observer?this._targetTrackerManipulator:null;this.configuration.laserLine.enabled&&l.isSome(t)?(e.heightManifoldTarget=t.renderLocation,t!==this._observerManipulator?e.lineVerticalPlaneSegment=g.fromPoints(this._observerManipulator.renderLocation,t.renderLocation,w):e.lineVerticalPlaneSegment=null):(e.heightManifoldTarget=null,e.lineVerticalPlaneSegment=null)},n._createVisualElements=function(){const e=this.configuration.laserLine;this._removeVisualElements(),this._laserlineVisualElement=new f.LaserlineVisualElement({view:this.view,attached:!0,style:{glowColor:r.toUnitRGB(e.glowColor),glowWidth:e.glowWidth,innerColor:r.toUnitRGB(e.innerColor),innerWidth:e.innerWidth,globalAlpha:e.globalAlpha}})},n._removeVisualElements=function(){l.isSome(this._laserlineVisualElement)&&(this._laserlineVisualElement.destroy(),this._laserlineVisualElement=null)},n._onObserverLocationChange=function(e){l.isNone(e)?this._observerManipulator.available=!1:(this._observerManipulator.metadata.intersection=null,this._observerManipulator.available=!0,this._observerManipulator.elevationAlignedLocation=e)},n._onTargetLocationChange=function(e,t){l.isSome(e)?(t.elevationAlignedLocation=e,t!==this._targetTrackerManipulator&&(t.available=!0)):t.available=!1},n._addPointFromClickEvent=function(e){const t=this._intersector.getScreenPointIntersection(e);l.isNone(t)||l.isNone(t.point)||(this.model.observer?(this._clearTargetTracker(),this.model.targets.add(new _.LineOfSightTarget({location:t.point,intersection:t}))):(this.model.observer=t.point,this.model.intersection=t))},n._clickHandler=function(e){this._creating&&(this._addPointFromClickEvent({x:e.x,y:e.y}),e.stopPropagation())},n._doubleClickHandler=function(e){this._creating&&(this.stop(),e.stopPropagation())},n._keyDownHandler=function(e){this._creating&&"Escape"===e.key&&(this.stop(),e.stopPropagation())},n._pointerMoveHandler=function(e){if(this._showTracker="mouse"===e.pointerType&&this._creating,this._updateLaserLineRenderer(),!this._showTracker||l.isNone(this.model.observer))return;const t={x:e.x,y:e.y},i=this._intersector.getScreenPointIntersection(t);l.isSome(i)&&l.isSome(i.point)&&(l.isSome(this.layerView.layerViewData.cursorTarget)?(this.layerView.layerViewData.cursorTarget.location=i.point,this.layerView.layerViewData.cursorTarget.intersection=i):this._createTargetTracker(i),this._updateLaserLineRenderer())},t._createClass(i,[{key:"state",get:function(){return this._creating?"creating":l.isSome(this.model.observer)?"created":"ready"}},{key:"cursor",get:function(){return!this._someManipulatorsFocused&&this._creating&&this._showTracker?"crosshair":null}},{key:"updating",get:function(){return!!l.isSome(this.layerView)&&this.layerView.updating}},{key:"_shouldRenderTracker",get:function(){return this._showTracker&&l.isSome(this.model.observer)&&!this._someManipulatorsFocused}}]),i}(b.InteractiveToolBase),i.__decorate([c.property({constructOnly:!0})],e.LineOfSightTool.prototype,"view",void 0),i.__decorate([c.property({constructOnly:!0})],e.LineOfSightTool.prototype,"model",void 0),i.__decorate([c.property({readOnly:!0})],e.LineOfSightTool.prototype,"state",null),i.__decorate([c.property({readOnly:!0})],e.LineOfSightTool.prototype,"cursor",null),i.__decorate([c.property({readOnly:!0})],e.LineOfSightTool.prototype,"updating",null),i.__decorate([c.property({type:y.LineOfSightToolConfiguration})],e.LineOfSightTool.prototype,"configuration",void 0),i.__decorate([c.property()],e.LineOfSightTool.prototype,"layerView",void 0),i.__decorate([c.property()],e.LineOfSightTool.prototype,"_creating",void 0),i.__decorate([c.property()],e.LineOfSightTool.prototype,"_showTracker",void 0),i.__decorate([c.property()],e.LineOfSightTool.prototype,"_shouldRenderTracker",null),i.__decorate([c.property()],e.LineOfSightTool.prototype,"_someManipulatorsFocused",void 0),i.__decorate([c.property()],e.LineOfSightTool.prototype,"_laserlineVisualElement",void 0),i.__decorate([c.property()],e.LineOfSightTool.prototype,"_grabbedManipulator",void 0),e.LineOfSightTool=i.__decorate([d.subclass("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightTool")],e.LineOfSightTool);const w=g.create();e.LineOfSightTargetCollection=S,Object.defineProperty(e,"__esModule",{value:!0})}));
