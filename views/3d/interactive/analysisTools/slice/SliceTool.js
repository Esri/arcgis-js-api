// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../../core/clock","../../../../../core/Collection","../../../../../core/collectionUtils","../../../../../core/Handles","../../../../../core/Logger","../../../../../core/maybe","../../../../../core/scheduling","../../../../../core/screenUtils","../../../../../core/watchUtils","../../../../../core/accessorSupport/decorators","../../../../../core/libs/gl-matrix-2/mat4","../../../../../core/libs/gl-matrix-2/vec3","../../../../../core/libs/gl-matrix-2/vec3f64","../../../../../layers/Layer","../../../../../layers/buildingSublayers/BuildingComponentSublayer","../../manipulatorUtils","./sliceToolConfig","./sliceToolUtils","./sliceToolUtils","./images/heading-rotate-png","./images/tilt-rotate-png","../../editingTools/dragEventPipeline3D","../../../support/geometryUtils","../../../support/stack","../../../webgl-engine/lib/Intersector","../../../webgl-engine/lib/Texture","../../../../interactive/dragEventPipeline","../../../../interactive/InteractiveToolBase","../../../../interactive/interactiveToolUtils"],(function(e,t,i,a,r,n,o,s,l,p,u,c,d,h,_,v,y,f,g,P,M,m,b,w,T,S,R,O,E,x,L,C){"use strict";var D=s.getLogger("esri.views.3d.interactive.analysisTools.slice.SliceTool"),H=function(e){function t(t){var i=e.call(this,t)||this;return i.clock=a.default,i.deferCreation=!0,i.cursor=null,i.layersMode="none",i.shiftManipulator=null,i.rotateHeadingManipulator=null,i.rotateTiltManipulator=null,i.resizeManipulators=null,i.disableEngineLayers=!1,i._handles=new o,i._viewHandles=new o,i._frameTask=null,i._prevPointerMoveTimeout=null,i._previewOutlineManipulator=null,i._previewOutlineMaterial=null,i._outlineManipulator=null,i._gridManipulator=null,i._gridMaterial=null,i._startPlane=S.boundedPlane.create(),i._previewPlane=null,i._activeKeyModifiers={},i._lastCursorPosition=u.createScreenPoint(),i._baseOpacity=1,i._resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}],i._intersector=new O.Intersector(t.view.state.mode),i._intersector.options.store=0,i}return i.__extends(t,e),t.prototype.initialize=function(){var e=this;this.rotateHeadingTexture=new E(b.default,"slice-rotate-heading",{width:64,height:64,mipmap:!0,preMultiplyAlpha:!0}),this.rotateTiltTexture=new E(w.default,"slice-rotate-tilt",{width:64,height:64,mipmap:!0,preMultiplyAlpha:!0}),this.view._stage&&(this.view._stage.add(4,this.rotateHeadingTexture),this.view._stage.add(4,this.rotateTiltTexture));var t=c.init(this,"state",(function(t){"ready"!==t&&e.create(),"sliced"===t&&e.complete()}),!0);this._handles.add([t,this.view.state.watch("camera",(function(){return e._onCameraChange()})),this.excludedLayers.on("before-add",(function(t){var i=t.item;null!=i&&(i instanceof y||i instanceof f)?i instanceof y&&M.isAlwaysDrapedLayer(i)?(D.error("excludedLayers","Layer '"+i.title+", id:"+i.id+"' of type '"+i.type+"' can not be individually excluded from slicing. Use 'excludeGroundSurface' instead."),t.preventDefault()):e.excludedLayers.includes(i)&&t.preventDefault():(D.error("excludedLayers","Invalid layer type, layer must derive from Layer or BuildingComponentSublayer"),t.preventDefault())}))]);var i=function(t){e.updateManipulatorsInteractive(t),t.grabbing||(l.isSome(e.plane)&&S.boundedPlane.copy(e.plane,e._startPlane),e.inputState=null)};this.shiftManipulator=M.createShiftManipulator(this.view),this.manipulators.add(this.shiftManipulator),this.shiftManipulator.events.on("grab-changed",(function(t){e._onShiftGrab(t),i(e.shiftManipulator)})),this._handles.add(this._createShiftDragPipeline(this.shiftManipulator)),this.rotateHeadingManipulator=M.createRotateManipulator(this.view,this.rotateHeadingTexture),this.manipulators.add(this.rotateHeadingManipulator),this.rotateHeadingManipulator.events.on("grab-changed",(function(t){e._onRotateHeadingGrab(t),i(e.rotateHeadingManipulator)})),this._handles.add(this._createRotateHeadingDragPipeline(this.rotateHeadingManipulator)),this.rotateTiltManipulator=M.createRotateManipulator(this.view,this.rotateTiltTexture),this.manipulators.add(this.rotateTiltManipulator),this.rotateTiltManipulator.events.on("grab-changed",(function(t){e._onRotateTiltGrab(t),i(e.rotateTiltManipulator)})),this._handles.add(this._createRotateTiltDragPipeline(this.rotateTiltManipulator)),this.resizeManipulators=this._resizeHandles.map((function(t,a){var r=M.createResizeManipulator(e.view,t);return r.events.on("grab-changed",(function(t){e._onResizeGrab(t,a),i(r)})),e._handles.add(e._createResizeDragPipeline(r)),r})),this.manipulators.addMany(this.resizeManipulators);var a=M.createOutlineManipulator(this.view),r=a.manipulator,n=a.material;this._previewOutlineManipulator=r,this._previewOutlineMaterial=n,this.manipulators.add(this._previewOutlineManipulator,2),this._outlineManipulator=M.createOutlineManipulator(this.view).manipulator,this.manipulators.add(this._outlineManipulator,1);var o=M.createGridManipulator(this.view),s=o.manipulator,p=o.material;this._gridManipulator=s,this._gridMaterial=p,this.manipulators.add(this._gridManipulator,2)},t.prototype.destroy=function(){this.view._stage&&(this.view._stage.remove(4,this.rotateHeadingTexture.id),this.view._stage.remove(4,this.rotateTiltTexture.id)),this.detach(),this._handles.destroy(),this._handles=null,this._viewHandles.destroy(),this._viewHandles=null,this._removeFrameTask(),this._clearPointerMoveTimeout()},Object.defineProperty(t.prototype,"state",{get:function(){var e=!!this.plane,t=!!this.inputState;return e?e&&t?"slicing":e&&!t?"sliced":"ready":"ready"},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isSupported",{get:function(){return"3d"===this.get("view.type")},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"plane",{set:function(e){this.view?l.isSome(e)&&!this.tiltEnabled?this.internalSetPlane(M.forceHorizontalOrVertical(e,this.view.renderCoordsHelper,S.boundedPlane.create())):this.internalSetPlane(e):this._set("plane",e)},enumerable:!1,configurable:!0}),t.prototype.internalSetPlane=function(e){this._set("plane",e),this.planeChanged()},t.prototype.planeChanged=function(){this.view&&(this._updateLayerViews(),this.visible&&this.attached&&(this.view.slicePlane=this.plane,this._updateManipulators()))},Object.defineProperty(t.prototype,"excludedLayers",{get:function(){return this._get("excludedLayers")||new r},set:function(e){this._set("excludedLayers",n.referenceSetter(e,this._get("excludedLayers")))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"excludeGroundSurface",{set:function(e){this._set("excludeGroundSurface",e),this.view&&this._updateLayerViews()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"tiltEnabled",{set:function(e){e!==this._get("tiltEnabled")&&(this._set("tiltEnabled",e),this.view&&(this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),l.isSome(this.plane)&&!e&&(this.plane=S.boundedPlane.copy(this.plane)),this._updateManipulators()))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"inputState",{get:function(){return this._get("inputState")},set:function(e){this._set("inputState",e),this._updateMaterials()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"_isTargeting",{get:function(){return!this.inputState&&!this.plane&&this.active},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"_creatingPointerId",{get:function(){return this.inputState&&"shift"===this.inputState.type?this.inputState.creatingPointerId:null},enumerable:!1,configurable:!0}),t.prototype.enterExcludeLayerMode=function(){this.created&&(this._set("layersMode","exclude"),C.setActive(this,!0))},t.prototype.exitExcludeLayerMode=function(){this.created&&(this._set("layersMode","none"),C.setActive(this,!1))},t.prototype.deactivate=function(){this._updateMouseCursor(),this._set("layersMode","none"),this._updatePreviewPlane(null)},t.prototype.onDetach=function(){this.plane=null,this._set("layersMode","none")},t.prototype.onShow=function(){var e=this;this._updateMouseCursor(),this._updateLayerViews(),this._updateManipulators();var t=this.view;t.slicePlane=this.plane,0===this._viewHandles.size&&this._viewHandles.add([t.allLayerViews.on("change",(function(){return e._updateLayerViews()})),this.excludedLayers.on("change",(function(){return e._updateLayerViews()}))])},t.prototype.onHide=function(){this._updateMouseCursor(),this._updateLayerViews(),this.view.slicePlane=null,this._viewHandles.removeAll(),this._clearPointerMoveTimeout()},t.prototype.onInputEvent=function(e){switch(e.type){case"pointer-down":if(!I(e))return;this._onPointerDown(e)&&(e.stopPropagation(),this._updateMouseCursor());break;case"pointer-drag":if(!I(e))return;this._onPointerDrag(e)&&e.stopPropagation();break;case"pointer-move":this._onPointerMove(e),this._updateMouseCursor();break;case"pointer-up":this._onPointerUp(e)&&e.stopPropagation();break;case"click":if(!I(e))return;this._onClick(e)&&e.stopPropagation();break;case"drag":this.inputState&&e.stopPropagation();break;case"key-down":this._onKeyDown(e)&&e.stopPropagation();break;case"key-up":this._onKeyUp(e)&&e.stopPropagation()}},t.prototype._updateLayerViews=function(){var e=!(!this.plane||!this.visible),t=[],i=function(e){"layers"in e?e.layers.forEach(i):t.push(e)};this.excludedLayers.forEach(i),this.view.allLayerViews.forEach((function(i){"slicePlaneEnabled"in i&&(i.slicePlaneEnabled=e&&t.indexOf(i.layer)<0),"sublayerViews"in i&&i.sublayerViews.forEach((function(i){i.slicePlaneEnabled=e&&t.indexOf(i.sublayer)<0}))})),this.view.basemapTerrain.slicePlaneEnabled=e&&!this.excludeGroundSurface},t.prototype._onPointerDown=function(e){if("exclude"===this.layersMode)return!0;if(this._isTargeting){var t=u.createScreenPointFromEvent(e),i=S.boundedPlane.create();if(this._pickPlane(t,!1,this._activeKeyModifiers,i)){S.boundedPlane.copy(i,this._startPlane);var a=this._calculatePickRay(t);return this.inputState=k(a,e.pointerId,i.origin,i),this.internalSetPlane(i),!0}}return!1},t.prototype._onPointerDrag=function(e){if(e.pointerId===this._creatingPointerId){var t=u.createScreenPointFromEvent(e);return this.shiftManipulator.events.emit("drag",{action:"start",start:t,screenPoint:t}),!0}return!1},t.prototype._onPointerMove=function(e){this._lastCursorPosition.x=e.x,this._lastCursorPosition.y=e.y,this._resetPointerMoveTimeout(),"touch"!==e.pointerType&&this._updatePreviewPlane(u.createScreenPointFromEvent(e),this._activeKeyModifiers)},t.prototype._onCameraChange=function(){this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),this._updateManipulators()},t.prototype._onPointerUp=function(e){return!(e.pointerId!==this._creatingPointerId||!l.isSome(this.plane))&&(S.boundedPlane.copy(this.plane,this._startPlane),this.inputState=null,!0)},t.prototype._onClick=function(e){var t=this;return!("exclude"!==this.layersMode||!this.created)&&(this.view.hitTest(u.createScreenPointFromEvent(e)).then((function(e){if(e.results.length){var i=e.results[0],a=i&&i.graphic;if(a){var r=a.sourceLayer||a.layer;r&&t.excludedLayers.push(r)}}else e.ground.layer?t.excludedLayers.push(e.ground.layer):t.excludeGroundSurface=!0})),this._set("layersMode","none"),C.setActive(this,!1),!0)},t.prototype._onKeyDown=function(e){return(e.key===P.forceVerticalModifier||e.key===P.forceHorizontalModifier)&&(this._activeKeyModifiers[e.key]=!0,l.isSome(this._previewPlane)&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)},t.prototype._onKeyUp=function(e){return!(e.key!==P.forceVerticalModifier&&e.key!==P.forceHorizontalModifier||!this._activeKeyModifiers[e.key])&&(delete this._activeKeyModifiers[e.key],l.isSome(this._previewPlane)&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)},t.prototype._onShiftGrab=function(e){if("start"===e.action&&!l.isNone(this.plane)){var t=this._calculatePickRay(e.screenPoint);S.boundedPlane.copy(this.plane,this._startPlane),this.inputState=k(t,null,this.shiftManipulator.renderLocation,this.plane)}},t.prototype._createShiftDragPipeline=function(e){var t=this;return x.createManipulatorDragEventPipeline(e,(function(e,i){var a=t.inputState;a&&"shift"===a.type&&i.next(T.screenToRenderPlane(t.view,a.shiftPlane)).next(t._shiftDragAdjustSensitivity(a)).next(t._shiftDragUpdatePlane(a))}))},t.prototype._shiftDragAdjustSensitivity=function(e){var t=this;return function(i){if(l.isNone(t.plane))return null;var a=Math.min((1-Math.abs(_.vec3.dot(S.boundedPlane.normal(t.plane),i.ray.direction)/_.vec3.length(i.ray.direction)))/.001,1),r=-S.plane.signedDistance(t._startPlane.plane,i.renderEnd),n=-S.plane.signedDistance(t._startPlane.plane,e.startPoint);return e.depth=e.depth*(1-a)+r*a-n,i}},t.prototype._shiftDragUpdatePlane=function(e){var t=this;return function(){if(!l.isNone(t.plane)){var i=_.vec3.copy(R.sv3d.get(),t._startPlane.origin),a=_.vec3.copy(R.sv3d.get(),S.boundedPlane.normal(t._startPlane));_.vec3.scale(a,a,-e.depth),_.vec3.add(a,a,i),S.boundedPlane.fromValues(a,t.plane.basis1,t.plane.basis2,t.plane),t.planeChanged(),t.notifyChange("plane")}}},t.prototype._onRotateHeadingGrab=function(e){if("start"===e.action&&!l.isNone(this.plane)){var t=M.createRotatePlane(this.plane,this.view.renderCoordsHelper,1,S.plane.create()),i=this._calculatePickRay(e.screenPoint),a=v.vec3f64.create();S.plane.intersectRay(t,i,a)&&(S.boundedPlane.copy(this.plane,this._startPlane),this.inputState={type:"rotate",rotatePlane:t,startPoint:a})}},t.prototype._createRotateHeadingDragPipeline=function(e){var t=this;return x.createManipulatorDragEventPipeline(e,(function(e,i){var a=t.inputState;a&&"rotate"===a.type&&i.next(T.screenToRenderPlane(t.view,a.rotatePlane)).next(t._rotateDragRenderPlaneToRotate(a)).next(t._rotateDragUpdatePlaneFromRotate())}))},t.prototype._onRotateTiltGrab=function(e){if("start"===e.action&&!l.isNone(this.plane)){var t=M.createRotatePlane(this.plane,this.view.renderCoordsHelper,2,S.plane.create()),i=this._calculatePickRay(e.screenPoint),a=v.vec3f64.create();S.plane.intersectRay(t,i,a)&&(S.boundedPlane.copy(this.plane,this._startPlane),this.inputState={type:"rotate",rotatePlane:t,startPoint:a})}},t.prototype._createRotateTiltDragPipeline=function(e){var t=this;return x.createManipulatorDragEventPipeline(e,(function(e,i){var a=t.inputState;a&&"rotate"===a.type&&i.next(T.screenToRenderPlane(t.view,a.rotatePlane)).next(t._rotateDragRenderPlaneToRotate(a)).next(t._rotateDragUpdatePlaneFromRotate())}))},t.prototype._rotateDragRenderPlaneToRotate=function(e){var t=this;return function(a){if(l.isNone(t.plane))return null;var r=S.plane.normal(e.rotatePlane),n=g.calculateInputRotationTransform(t.inputState.startPoint,a.renderEnd,t.plane.origin,r);return i.__assign(i.__assign({},a),{rotateAxis:r,rotateAngle:n})}},t.prototype._rotateDragUpdatePlaneFromRotate=function(){var e=this;return function(t){if(!l.isNone(e.plane)){var i=h.mat4.identity(R.sm4d.get());h.mat4.rotate(i,i,t.rotateAngle,t.rotateAxis);var a=_.vec3.transformMat4(R.sv3d.get(),e._startPlane.basis1,i),r=_.vec3.transformMat4(R.sv3d.get(),e._startPlane.basis2,i);S.boundedPlane.fromValues(e.plane.origin,a,r,e.plane),e.planeChanged(),e.notifyChange("plane")}}},t.prototype._onResizeGrab=function(e,t){if("start"===e.action&&!l.isNone(this.plane)){var i=this._calculatePickRay(e.screenPoint),a=R.sv3d.get();S.plane.intersectRay(this.plane.plane,i,a)&&(S.boundedPlane.copy(this.plane,this._startPlane),this.inputState={type:"resize",activeHandleIdx:t,startPoint:v.vec3f64.clone(a)})}},t.prototype._createResizeDragPipeline=function(e){var t=this;return x.createManipulatorDragEventPipeline(e,(function(e,i){var a=t.inputState;a&&"resize"===a.type&&!l.isNone(t.plane)&&i.next(T.screenToRenderPlane(t.view,t.plane.plane)).next(t._resizeDragUpdatePlane(a))}))},t.prototype._resizeDragUpdatePlane=function(e){var t=this;return function(i){if(!l.isNone(t.plane)){var a=t._resizeHandles[e.activeHandleIdx];M.resizePlane(a,t.inputState.startPoint,i.renderEnd,t.view._stage.getCamera(),t._startPlane,t.plane),t.planeChanged(),t.notifyChange("plane")}}},t.prototype._updatePreviewPlane=function(e,t){var i=this;void 0===t&&(t={});var a=this._previewPlane;if(this._previewPlane=null,l.isNone(e))return this._removeFrameTask(),void this._updateManipulators();if(!this.plane&&this.active){var r=l.isSome(a)?a:S.boundedPlane.create();if(a=l.isSome(a)?S.boundedPlane.copy(a,N):null,this._pickPlane(e,!0,t,r)){var n=P.PREVIEW_FADE_DOT_THRESHOLD,o=!1;l.isSome(a)&&(o=_.vec3.dot(a.plane,r.plane)<n||_.vec3.dot(_.vec3.normalize(R.sv3d.get(),a.basis1),_.vec3.normalize(R.sv3d.get(),r.basis1))<n),o&&(this._baseOpacity=0),this._previewPlane=r}}l.isSome(this._previewPlane)&&l.isNone(this._frameTask)&&0===this._baseOpacity?this._frameTask=p.addFrameTask({update:function(e){var t=e.deltaTime;i._baseOpacity=Math.min(i._baseOpacity+t/(1e3*P.PREVIEW_FADE_DURATION_SECONDS),1),i._updateManipulators(),1===i._baseOpacity&&i._removeFrameTask()}}):l.isNone(this._previewPlane)&&l.isSome(this._frameTask)?this._removeFrameTask():l.isSome(this._previewPlane)&&this._updateManipulators()},t.prototype._removeFrameTask=function(){l.isSome(this._frameTask)&&(this._frameTask.remove(),this._frameTask=null)},t.prototype._calculatePickRay=function(e){var t=S.ray.create(),i=u.screenPointObjectToArray(e,z);return S.ray.fromScreen(this.view.state.camera,i,t),_.vec3.normalize(t.direction,t.direction),t},t.prototype._pickMinResult=function(e){var t=u.screenPointObjectToArray(e,R.sv2d.get());return this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(t,this._intersector),this._intersector.results.min},t.prototype._pickPlane=function(e,t,i,a){var r=this._pickMinResult(e),n=R.sv3d.get();if(!r.getIntersectionPoint(n))return!1;var o=r.getTransformedNormal(R.sv3d.get()),s=this.view._stage.getCamera();_.vec3.dot(o,s.viewForward)>0&&_.vec3.scale(o,o,-1);var l=M.calculatePlaneHalfSize(n,s),p=(t?1:-1)*l*P.INITIAL_DEPTH_OFFSET_FRAC,u=_.vec3.scale(R.sv3d.get(),o,p);_.vec3.add(u,u,n);var c=this.tiltEnabled?3:0,d=i[P.forceVerticalModifier]?2:i[P.forceHorizontalModifier]?1:c;return M.createPlane(u,o,l,l,s,d,this.view.renderCoordsHelper,a),!0},t.prototype._updateMouseCursor=function(){this._set("cursor",null),this._isTargeting||"exclude"===this.layersMode?this._set("cursor","crosshair"):l.isSome(this._creatingPointerId)&&this._set("cursor","grabbing")},t.prototype._clearPointerMoveTimeout=function(){this._prevPointerMoveTimeout&&(this._prevPointerMoveTimeout.remove(),this._prevPointerMoveTimeout=null)},t.prototype._resetPointerMoveTimeout=function(){var e=this;this._clearPointerMoveTimeout(),this.shiftManipulator.state|=m.DidPointerMoveRecentlyFlag,this.rotateHeadingManipulator.state|=m.DidPointerMoveRecentlyFlag,this.rotateTiltManipulator.state|=m.DidPointerMoveRecentlyFlag,this._prevPointerMoveTimeout=this.clock.setTimeout((function(){e.shiftManipulator.state&=~m.DidPointerMoveRecentlyFlag,e.rotateHeadingManipulator.state&=~m.DidPointerMoveRecentlyFlag,e.rotateTiltManipulator.state&=~m.DidPointerMoveRecentlyFlag}),P.POINTER_MOVE_TIMER_MS)},t.prototype._updateManipulators=function(){var e=this;if(!this.disableEngineLayers){var t=l.isSome(this.plane)?this.plane:l.isSome(this._previewPlane)?this._previewPlane:null,i=l.isSome(t)&&t===this.plane,a=l.isSome(t)&&t===this._previewPlane,r=l.isSome(t)?M.calculateBoundedPlaneTranslateRotate(t,R.sm4d.get()):null;if(this.shiftManipulator.available=i,this.rotateHeadingManipulator.available=i,this.rotateTiltManipulator.available=i&&this.tiltEnabled,this.resizeManipulators.forEach((function(e){e.available=i})),i&&(M.updateShiftRestartHandle(this.shiftManipulator,r,t,this.view._stage.getCamera()),M.updateRotateHeadingHandle(this.rotateHeadingManipulator,r,t,this.view.renderCoordsHelper),M.updateRotateTiltHandle(this.rotateTiltManipulator,r,t),this.resizeManipulators.forEach((function(i,a){M.updateResizeHandle(i,e._resizeHandles[a],r,t)}))),this._previewOutlineManipulator.available=a,this._outlineManipulator.available=i,this._gridManipulator.available=l.isSome(t),l.isSome(t)){var n=_.vec3.set(R.sv3d.get(),_.vec3.length(t.basis1),_.vec3.length(t.basis2),1),o=h.mat4.fromScaling(R.sm4d.get(),n),s=h.mat4.multiply(o,r,o);s[12]=0,s[13]=0,s[14]=0;var p=_.vec3.set(R.sv3d.get(),r[12],r[13],r[14]);this._previewOutlineManipulator.modelTransform=s,this._previewOutlineManipulator.renderLocation=p,this._outlineManipulator.modelTransform=s,this._outlineManipulator.renderLocation=p,this._gridManipulator.modelTransform=s,this._gridManipulator.renderLocation=p,this._updateMaterials()}}},t.prototype._updateMaterials=function(){var e=[P.PLANE_OUTLINE_COLOR[0],P.PLANE_OUTLINE_COLOR[1],P.PLANE_OUTLINE_COLOR[2],P.PLANE_OUTLINE_COLOR[3]*this._baseOpacity];this._previewOutlineMaterial.setParameterValues({color:e});var t=[P.PLANE_BACKGROUND_COLOR[0],P.PLANE_BACKGROUND_COLOR[1],P.PLANE_BACKGROUND_COLOR[2],P.PLANE_BACKGROUND_COLOR[3]*this._baseOpacity],i=this.inputState&&"resize"===this.inputState.type?P.GRID_COLOR:[0,0,0,0];this._gridMaterial.setParameterValues({backgroundColor:t,gridColor:i})},t.prototype.updateManipulatorsInteractive=function(e){if(!e.grabbing)return this.shiftManipulator.interactive=!0,this.rotateHeadingManipulator.interactive=!0,this.rotateTiltManipulator.interactive=!0,void this.resizeManipulators.forEach((function(e){e.interactive=!0}));this.shiftManipulator.interactive=this.shiftManipulator===e,this.rotateHeadingManipulator.interactive=this.rotateHeadingManipulator===e,this.rotateTiltManipulator.interactive=this.rotateTiltManipulator===e,this.resizeManipulators.forEach((function(t){t.interactive=t===e}))},i.__decorate([d.property()],t.prototype,"clock",void 0),i.__decorate([d.property({constructOnly:!0})],t.prototype,"view",void 0),i.__decorate([d.property({dependsOn:["plane","inputState"],readOnly:!0})],t.prototype,"state",null),i.__decorate([d.property({dependsOn:["view.type"],readOnly:!0})],t.prototype,"isSupported",null),i.__decorate([d.property({readOnly:!0})],t.prototype,"cursor",void 0),i.__decorate([d.property({value:null})],t.prototype,"plane",null),i.__decorate([d.property({readOnly:!0})],t.prototype,"layersMode",void 0),i.__decorate([d.property({cast:n.castForReferenceSetter})],t.prototype,"excludedLayers",null),i.__decorate([d.property({type:Boolean,value:!1})],t.prototype,"excludeGroundSurface",null),i.__decorate([d.property({type:Boolean,value:!1})],t.prototype,"tiltEnabled",null),i.__decorate([d.property({value:null})],t.prototype,"inputState",null),t=i.__decorate([d.subclass("esri.views.3d.interactive.analysisTools.slice.SliceTool")],t)}(L.InteractiveToolBase);function k(e,t,i,a){var r=M.createShiftPlane(i,S.boundedPlane.normal(a),e.direction,S.plane.create()),n=v.vec3f64.create();return S.plane.intersectRay(r,e,n)?{type:"shift",creatingPointerId:t,shiftPlane:r,depth:0,startPoint:n}:null}function I(e){return"mouse"!==e.pointerType||0===e.button}var N=S.boundedPlane.create(),z=u.createScreenPointArray();return H}));