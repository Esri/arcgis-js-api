/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../core/has","../../../../../core/maybe","../../../../../core/Logger","../../../../../core/accessorSupport/ensureType","../../../../../core/accessorSupport/decorators/property","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/urlUtils","../../../../../core/uuid","../../../../../portal/support/resourceExtension","../../../../../core/clock","../../../../../core/scheduling","../../../../../core/Collection","../../../../../core/screenUtils","../../../../../core/collectionUtils","../../../../../chunks/vec3f64","../../../../../chunks/vec3","../../../../../core/Handles","../../../../../layers/Layer","../../../../../core/watchUtils","../../../../../chunks/mat4","../../../../../layers/buildingSublayers/BuildingComponentSublayer","../../../../interactive/interactiveToolUtils","../../../../support/screenUtils","../../../support/stack","../../../support/geometryUtils","../../../webgl-engine/lib/Intersector","../../../webgl-engine/lib/Texture","../../../../interactive/dragEventPipeline","../../../../interactive/InteractiveToolBase","../../editingTools/dragEventPipeline3D","../../manipulatorUtils","./sliceToolConfig","../../../../../widgets/Slice/SlicePlane","./sliceToolUtils","./images/heading-rotate-png","./images/tilt-rotate-png"],(function(e,t,i,n,a,s,r,o,l,u,h,c,p,d,_,f,P,y,v,g,m,M,b,S,I,w,T,E,R,L,k,x,H,D,C,O,V,N){"use strict";const A=a.getLogger("esri.views.3d.interactive.analysisTools.slice.SliceTool");let z=function(t){function i(e){var i;return(i=t.call(this,e)||this).clock=c.default,i.deferCreation=!0,i.cursor=null,i._planeInfo=null,i.layersMode="none",i.shiftManipulator=null,i.rotateHeadingManipulator=null,i.rotateTiltManipulator=null,i.resizeManipulators=null,i.disableEngineLayers=!1,i._handles=new v,i._viewHandles=new v,i._frameTask=null,i._prevPointerMoveTimeout=null,i._outlineVisualElement=null,i._gridVisualElement=null,i._startPlane=T.boundedPlane.create(),i._previewPlane=null,i._activeKeyModifiers={},i._lastCursorPosition=_.createScreenPoint(),i._baseOpacity=1,i._resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}],i._intersector=new E.Intersector(e.view.state.mode),i._intersector.options.store=0,i}e._inheritsLoose(i,t);var a=i.prototype;return a.onAttach=function(){this._updateLayerViews(),this.visible&&(!this.tiltEnabled&&n.isSome(this._planeInfo)&&O.forceHorizontalOrVertical(this._planeInfo.plane,this.view.renderCoordsHelper,this._planeInfo.plane),this.view.slicePlane=n.isSome(this._planeInfo)?this._planeInfo.plane:null,this._updateManipulators())},a.initialize=function(){if(null==this.model)throw new Error("SliceTool requires valid model, but null was provided.");this.rotateHeadingTexture=new R.Texture(V,{width:64,height:64,mipmap:!0,preMultiplyAlpha:!0}),this.rotateTiltTexture=new R.Texture(N,{width:64,height:64,mipmap:!0,preMultiplyAlpha:!0}),this.view._stage&&(this.view._stage.add(this.rotateHeadingTexture),this.view._stage.add(this.rotateTiltTexture)),this.planeChanged();const e=m.init(this,"state",(e=>{"ready"!==e&&this.create(),"sliced"===e&&this.complete()}),!0);this._handles.add([e,this.view.state.watch("camera",(()=>this._onCameraChange())),this.excludedLayers.on("before-add",(e=>{const t=e.item;null!=t&&(t instanceof g||t instanceof b)?t instanceof g&&O.isAlwaysDrapedLayer(t)?(A.error("excludedLayers",`Layer '${t.title}, id:${t.id}' of type '${t.type}' can not be individually excluded from slicing. Use 'excludeGroundSurface' instead.`),e.preventDefault()):this.excludedLayers.includes(t)&&e.preventDefault():(A.error("excludedLayers","Invalid layer type, layer must derive from Layer or BuildingComponentSublayer"),e.preventDefault())}))]);const t=e=>{this.updateManipulatorsInteractive(e),e.grabbing||(n.isSome(this._planeInfo)&&T.boundedPlane.copy(this._planeInfo.plane,this._startPlane),this.inputState=null)};this.shiftManipulator=O.createShiftManipulator(this.view),this.manipulators.add(this.shiftManipulator),this.shiftManipulator.events.on("grab-changed",(e=>{this._onShiftGrab(e),t(this.shiftManipulator)})),this._handles.add(this._createShiftDragPipeline(this.shiftManipulator)),this.rotateHeadingManipulator=O.createRotateManipulator(this.view,this.rotateHeadingTexture),this.manipulators.add(this.rotateHeadingManipulator),this.rotateHeadingManipulator.events.on("grab-changed",(e=>{this._onRotateHeadingGrab(e),t(this.rotateHeadingManipulator)})),this._handles.add(this._createRotateHeadingDragPipeline(this.rotateHeadingManipulator)),this.rotateTiltManipulator=O.createRotateManipulator(this.view,this.rotateTiltTexture),this.manipulators.add(this.rotateTiltManipulator),this.rotateTiltManipulator.events.on("grab-changed",(e=>{this._onRotateTiltGrab(e),t(this.rotateTiltManipulator)})),this._handles.add(this._createRotateTiltDragPipeline(this.rotateTiltManipulator)),this.resizeManipulators=this._resizeHandles.map(((e,i)=>{const n=O.createResizeManipulator(this.view,e);return n.events.on("grab-changed",(e=>{this._onResizeGrab(e,i),t(n)})),this._handles.add(this._createResizeDragPipeline(n)),n})),this.manipulators.addMany(this.resizeManipulators),this._outlineVisualElement=O.createOutlineVisualElement(this.view),this._gridVisualElement=O.createGridVisualElement(this.view)},a.destroy=function(){this.view._stage&&(this.view._stage.remove(this.rotateHeadingTexture),this.view._stage.remove(this.rotateTiltTexture)),this.detach(),this._handles.destroy(),this._handles=null,this._viewHandles.destroy(),this._viewHandles=null,this._removeFrameTask(),this._clearPointerMoveTimeout(),this._outlineVisualElement.destroy(),this._outlineVisualElement=null,this._gridVisualElement.destroy(),this._gridVisualElement=null},a.planeChanged=function(){if(!this.view)return;const e=this.model.plane,t=this._planeInfo;if(n.isNone(t)&&n.isNone(e)||n.isSome(t)&&n.isSome(e)&&e.equals(t))return;let i=null;if(n.isSome(e)){const t=O.shapeToPlane(e,this.view.renderCoordsHelper,T.boundedPlane.create());n.isSome(t)&&(i={plane:t,heading:e.heading,tilt:e.tilt,position:e.position,width:e.width,height:e.height})}this._updateInternalSlicePlane(i)},a.enterExcludeLayerMode=function(){n.isNone(this._planeInfo)||(this._set("layersMode","exclude"),S.setActive(this,!0))},a.exitExcludeLayerMode=function(){n.isNone(this._planeInfo)||(this._set("layersMode","none"),S.setActive(this,!1))},a.deactivate=function(){this._updateMouseCursor(),this._set("layersMode","none"),this._updatePreviewPlane(null)},a.onDetach=function(){this._planeInfo=null,this._updateLayerViews(),this._set("layersMode","none")},a.onShow=function(){this._updateMouseCursor(),this._updateLayerViews(),this._updateManipulators(),this._updateVisualElementVisibility();const e=this.view;e.slicePlane=n.isSome(this._planeInfo)?this._planeInfo.plane:null,0===this._viewHandles.size&&this._viewHandles.add([e.allLayerViews.on("change",(()=>this._updateLayerViews())),this.excludedLayers.on("change",(()=>this._updateLayerViews()))])},a.onHide=function(){this._updateMouseCursor(),this._updateLayerViews(),this._updateVisualElementVisibility(),this.view.slicePlane=null,this._viewHandles.removeAll(),this._clearPointerMoveTimeout()},a.onInputEvent=function(e){switch(e.type){case"pointer-drag":if(!F(e))return;this._onPointerDrag(e)&&e.stopPropagation();break;case"pointer-move":this._onPointerMove(e),this._updateMouseCursor();break;case"pointer-up":this._onPointerUp(e)&&e.stopPropagation();break;case"immediate-click":if(!F(e))return;this._onClickPlacePlane(e)&&(e.stopPropagation(),this._updateMouseCursor());break;case"click":if(!F(e))return;this._onClickExcludeLayer(e)&&e.stopPropagation();break;case"drag":this.inputState&&e.stopPropagation();break;case"key-down":this._onKeyDown(e)&&e.stopPropagation();break;case"key-up":this._onKeyUp(e)&&e.stopPropagation()}},a.onEditableChange=function(){this._outlineVisualElement.width=this.editable?D.PLANE_OUTLINE_WIDTH:D.PLANE_PREVIEW_OUTLINE_WIDTH},a._updateLayerViews=function(){const e=n.isSome(this._planeInfo)&&this.visible,t=[],i=e=>{"layers"in e?e.layers.forEach(i):t.push(e)};this.excludedLayers.forEach(i),this.view.allLayerViews.forEach((i=>{"slicePlaneEnabled"in i&&(i.slicePlaneEnabled=e&&t.indexOf(i.layer)<0),"sublayerViews"in i&&i.sublayerViews.forEach((i=>{i.slicePlaneEnabled=e&&t.indexOf(i.sublayer)<0}))})),this.view.basemapTerrain.slicePlaneEnabled=e&&!this.excludeGroundSurface},a._onPointerDrag=function(e){if(e.pointerId===this._creatingPointerId){const t=I.createScreenPointFromEvent(e);return this.shiftManipulator.events.emit("drag",{action:"start",pointerType:e.pointerType,start:t,screenPoint:t}),!0}return!1},a._onPointerMove=function(e){this._lastCursorPosition.x=e.x,this._lastCursorPosition.y=e.y,this._resetPointerMoveTimeout(),"touch"!==e.pointerType&&this._updatePreviewPlane(I.createScreenPointFromEvent(e),this._activeKeyModifiers)},a._onCameraChange=function(){this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),this._updateManipulators()},a._onPointerUp=function(e){return!(e.pointerId!==this._creatingPointerId||!n.isSome(this._planeInfo))&&(T.boundedPlane.copy(this._planeInfo.plane,this._startPlane),this.inputState=null,!0)},a._onClickPlacePlane=function(e){if("exclude"===this.layersMode)return!1;if(this._isTargeting){const t=I.createScreenPointFromEvent(e),i=T.boundedPlane.create();if(this._pickPlane(t,!1,this._activeKeyModifiers,i)){T.boundedPlane.copy(i,this._startPlane);const n=this._calculatePickRay(t);return this.model.plane=O.planeToShape(i,this.view.renderCoordsHelper,this.view.spatialReference,new C),this.inputState=U(n,e.pointerId,i.origin,i),!0}}return!1},a._onClickExcludeLayer=function(e){return!("exclude"!==this.layersMode||!this.created)&&(this.view.hitTest(I.createScreenPointFromEvent(e)).then((e=>{if(e.results.length){const t=e.results[0],i=t&&t.graphic;if(i){const e=i.sourceLayer||i.layer;e&&this.excludedLayers.push(e)}}else e.ground.layer?this.excludedLayers.push(e.ground.layer):this.excludeGroundSurface=!0})),this._set("layersMode","none"),S.setActive(this,!1),!0)},a._onKeyDown=function(e){return(e.key===D.forceVerticalModifier||e.key===D.forceHorizontalModifier)&&(this._activeKeyModifiers[e.key]=!0,n.isSome(this._previewPlane)&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)},a._onKeyUp=function(e){return!(e.key!==D.forceVerticalModifier&&e.key!==D.forceHorizontalModifier||!this._activeKeyModifiers[e.key])&&(delete this._activeKeyModifiers[e.key],n.isSome(this._previewPlane)&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)},a._onShiftGrab=function(e){if("start"!==e.action||n.isNone(this._planeInfo))return;const t=this._calculatePickRay(e.screenPoint);T.boundedPlane.copy(this._planeInfo.plane,this._startPlane),this.inputState=U(t,null,this.shiftManipulator.renderLocation,this._planeInfo.plane)},a._createShiftDragPipeline=function(e){return L.createManipulatorDragEventPipeline(e,((e,t,i)=>{const a=this.inputState;if(!a||"shift"!==a.type)return;const s=n.isSome(this._planeInfo)?T.boundedPlane.copy(this._planeInfo.plane,T.boundedPlane.create()):null;t.next(x.screenToRenderPlane(this.view,a.shiftPlane)).next(this._shiftDragAdjustSensitivity(a)).next(this._shiftDragUpdatePlane(a)),i.next((()=>{n.isSome(s)&&this._updateSlicePlane(s)}))}))},a._shiftDragAdjustSensitivity=function(e){return t=>{if(n.isNone(this._planeInfo))return null;const i=.001,a=Math.min((1-Math.abs(y.dot(T.boundedPlane.normal(this._planeInfo.plane),t.ray.direction)/y.length(t.ray.direction)))/i,1),s=-T.plane.signedDistance(this._startPlane.plane,t.renderEnd),r=-T.plane.signedDistance(this._startPlane.plane,e.startPoint);return e.depth=e.depth*(1-a)+s*a-r,t}},a._shiftDragUpdatePlane=function(e){return()=>{if(n.isNone(this._planeInfo))return;const t=y.copy(w.sv3d.get(),this._startPlane.origin),i=y.copy(w.sv3d.get(),T.boundedPlane.normal(this._startPlane));y.scale(i,i,-e.depth),y.add(i,i,t),T.boundedPlane.fromValues(i,this._planeInfo.plane.basis1,this._planeInfo.plane.basis2,this._planeInfo.plane),this._updateSlicePlane(this._planeInfo.plane)}},a._onRotateHeadingGrab=function(e){if("start"!==e.action||n.isNone(this._planeInfo))return;const t=O.createRotatePlane(this._planeInfo.plane,this.view.renderCoordsHelper,1,T.plane.create()),i=this._calculatePickRay(e.screenPoint),a=P.create();T.plane.intersectRay(t,i,a)&&(T.boundedPlane.copy(this._planeInfo.plane,this._startPlane),this.inputState={type:"rotate",rotatePlane:t,startPoint:a})},a._createRotateHeadingDragPipeline=function(e){return L.createManipulatorDragEventPipeline(e,((e,t,i)=>{const a=this.inputState;if(!a||"rotate"!==a.type)return;const s=n.isSome(this._planeInfo)?T.boundedPlane.copy(this._planeInfo.plane,T.boundedPlane.create()):null;t.next(x.screenToRenderPlane(this.view,a.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(a)).next(this._rotateDragUpdatePlaneFromRotate()),i.next((()=>{n.isSome(s)&&this._updateSlicePlane(s)}))}))},a._onRotateTiltGrab=function(e){if("start"!==e.action||n.isNone(this._planeInfo))return;const t=O.createRotatePlane(this._planeInfo.plane,this.view.renderCoordsHelper,2,T.plane.create()),i=this._calculatePickRay(e.screenPoint),a=P.create();T.plane.intersectRay(t,i,a)&&(T.boundedPlane.copy(this._planeInfo.plane,this._startPlane),this.inputState={type:"rotate",rotatePlane:t,startPoint:a})},a._createRotateTiltDragPipeline=function(e){return L.createManipulatorDragEventPipeline(e,((e,t,i)=>{const a=this.inputState;if(!a||"rotate"!==a.type)return;const s=n.isSome(this._planeInfo)?T.boundedPlane.copy(this._planeInfo.plane,T.boundedPlane.create()):null;t.next(x.screenToRenderPlane(this.view,a.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(a)).next(this._rotateDragUpdatePlaneFromRotate()),i.next((()=>{n.isSome(s)&&this._updateSlicePlane(s)}))}))},a._rotateDragRenderPlaneToRotate=function(e){return t=>{if(n.isNone(this._planeInfo))return null;const i=T.plane.normal(e.rotatePlane),a=H.calculateInputRotationTransform(this.inputState.startPoint,t.renderEnd,this._planeInfo.plane.origin,i);return{...t,rotateAxis:i,rotateAngle:a}}},a._rotateDragUpdatePlaneFromRotate=function(){return e=>{if(n.isNone(this._planeInfo))return;const t=M.identity(w.sm4d.get());M.rotate(t,t,e.rotateAngle,e.rotateAxis);const i=y.transformMat4(w.sv3d.get(),this._startPlane.basis1,t),a=y.transformMat4(w.sv3d.get(),this._startPlane.basis2,t);T.boundedPlane.fromValues(this._planeInfo.plane.origin,i,a,this._planeInfo.plane),this._updateSlicePlane(this._planeInfo.plane)}},a._onResizeGrab=function(e,t){if("start"!==e.action||n.isNone(this._planeInfo))return;const i=this._calculatePickRay(e.screenPoint),a=w.sv3d.get();T.plane.intersectRay(this._planeInfo.plane.plane,i,a)&&(T.boundedPlane.copy(this._planeInfo.plane,this._startPlane),this.inputState={type:"resize",activeHandleIdx:t,startPoint:P.clone(a)})},a._createResizeDragPipeline=function(e){return L.createManipulatorDragEventPipeline(e,((e,t,i)=>{const a=this.inputState;if(!a||"resize"!==a.type||n.isNone(this._planeInfo))return;const s=T.boundedPlane.copy(this._planeInfo.plane,T.boundedPlane.create());t.next(x.screenToRenderPlane(this.view,this._planeInfo.plane.plane)).next(this._resizeDragUpdatePlane(a)),i.next((()=>{this._updateSlicePlane(s)}))}))},a._resizeDragUpdatePlane=function(e){return t=>{if(n.isNone(this._planeInfo))return;const i=this._resizeHandles[e.activeHandleIdx];O.resizePlane(i,this.inputState.startPoint,t.renderEnd,this.view._stage.camera,this._startPlane,this._planeInfo.plane),this._updateSlicePlane(this._planeInfo.plane)}},a._updateSlicePlane=function(e){const t=O.planeToShape(e,this.view.renderCoordsHelper,this.view.spatialReference,new C);let i=null;n.isSome(t)&&(i={plane:e,heading:t.heading,tilt:t.tilt,position:t.position,width:t.width,height:t.height}),this._updateInternalSlicePlane(i),this.model.plane=t},a._updateInternalSlicePlane=function(e){const t=n.isSome(this._planeInfo);this._planeInfo=e,!this.tiltEnabled&&n.isSome(this._planeInfo)&&O.forceHorizontalOrVertical(this._planeInfo.plane,this.view.renderCoordsHelper,this._planeInfo.plane),t!==n.isSome(this._planeInfo)&&this._updateLayerViews(),this.visible&&this.attached&&(this.view.slicePlane=n.isSome(this._planeInfo)?this._planeInfo.plane:null,this._updateManipulators())},a._updatePreviewPlane=function(e,t={}){let i=this._previewPlane;if(this._previewPlane=null,n.isNone(e))return this._removeFrameTask(),void this._updateManipulators();if(!this._planeInfo&&this.active){const a=n.isSome(i)?i:T.boundedPlane.create();if(i=n.isSome(i)?T.boundedPlane.copy(i,G):null,this._pickPlane(e,!0,t,a)){const e=D.PREVIEW_FADE_DOT_THRESHOLD;let t=!1;n.isSome(i)&&(t=y.dot(i.plane,a.plane)<e||y.dot(y.normalize(w.sv3d.get(),i.basis1),y.normalize(w.sv3d.get(),a.basis1))<e),t&&(this._baseOpacity=0),this._previewPlane=a}}n.isSome(this._previewPlane)&&n.isNone(this._frameTask)&&0===this._baseOpacity?this._frameTask=p.addFrameTask({update:({deltaTime:e})=>{this._baseOpacity=Math.min(this._baseOpacity+e/(1e3*D.PREVIEW_FADE_DURATION_SECONDS),1),this._updateManipulators(),1===this._baseOpacity&&this._removeFrameTask()}}):n.isNone(this._previewPlane)&&n.isSome(this._frameTask)?this._removeFrameTask():n.isSome(this._previewPlane)&&this._updateManipulators()},a._removeFrameTask=function(){n.isSome(this._frameTask)&&(this._frameTask.remove(),this._frameTask=null)},a._calculatePickRay=function(e){const t=T.ray.create(),i=_.screenPointObjectToArray(e,K);return T.ray.fromScreen(this.view.state.camera,i,t),y.normalize(t.direction,t.direction),t},a._pickMinResult=function(e){const t=_.screenPointObjectToArray(e,w.sv2d.get());return this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(t,this._intersector),this._intersector.results.min},a._pickPlane=function(e,t,i,n){const a=this._pickMinResult(e),s=w.sv3d.get();if(!a.getIntersectionPoint(s))return!1;const r=a.getTransformedNormal(w.sv3d.get()),o=this.view._stage.camera;y.dot(r,o.viewForward)>0&&y.scale(r,r,-1);const l=O.calculatePlaneHalfSize(s,o),u=(t?1:-1)*l*D.INITIAL_DEPTH_OFFSET_FRAC,h=y.scale(w.sv3d.get(),r,u);y.add(h,h,s);const c=this.tiltEnabled?3:0,p=i[D.forceVerticalModifier]?2:i[D.forceHorizontalModifier]?1:c;return O.createPlane(h,r,l,l,o,p,this.view.renderCoordsHelper,n),!0},a._updateMouseCursor=function(){this._set("cursor",null),this._isTargeting||"exclude"===this.layersMode?this._set("cursor","crosshair"):n.isSome(this._creatingPointerId)&&this._set("cursor","grabbing")},a._clearPointerMoveTimeout=function(){this._prevPointerMoveTimeout&&(this._prevPointerMoveTimeout.remove(),this._prevPointerMoveTimeout=null)},a._resetPointerMoveTimeout=function(){this._clearPointerMoveTimeout(),this.shiftManipulator.state|=O.DidPointerMoveRecentlyFlag,this.rotateHeadingManipulator.state|=O.DidPointerMoveRecentlyFlag,this.rotateTiltManipulator.state|=O.DidPointerMoveRecentlyFlag,this._prevPointerMoveTimeout=this.clock.setTimeout((()=>{this.shiftManipulator.state&=~O.DidPointerMoveRecentlyFlag,this.rotateHeadingManipulator.state&=~O.DidPointerMoveRecentlyFlag,this.rotateTiltManipulator.state&=~O.DidPointerMoveRecentlyFlag}),D.POINTER_MOVE_TIMER_MS)},a._updateManipulators=function(){if(this.disableEngineLayers)return;let e=null,t=!1,i=!1;n.isSome(this._planeInfo)?(e=this._planeInfo.plane,t=!0):n.isSome(this._previewPlane)&&(e=this._previewPlane,i=!0);const a=n.isSome(e)?O.calculateBoundedPlaneTranslateRotate(e,w.sm4d.get()):null;if(this.shiftManipulator.available=t,this.rotateHeadingManipulator.available=t,this.rotateTiltManipulator.available=t&&this.tiltEnabled,this.resizeManipulators.forEach((e=>e.available=t)),t&&(O.updateShiftRestartHandle(this.shiftManipulator,a,e,this.view._stage.camera),O.updateRotateHeadingHandle(this.rotateHeadingManipulator,a,e,this.view.renderCoordsHelper),O.updateRotateTiltHandle(this.rotateTiltManipulator,a,e),this.resizeManipulators.forEach(((t,i)=>O.updateResizeHandle(t,this._resizeHandles[i],a,e)))),this._outlineVisualElement.width=i?D.PLANE_PREVIEW_OUTLINE_WIDTH:D.PLANE_OUTLINE_WIDTH,n.isSome(e)){const t=y.set(w.sv3d.get(),y.length(e.basis1),y.length(e.basis2),1),i=M.fromScaling(w.sm4d.get(),t),n=M.multiply(i,a,i);this._outlineVisualElement.transform=n,this._gridVisualElement.transform=n,this._updateMaterials()}this._updateVisualElementVisibility()},a._updateVisualElementVisibility=function(){if(this.disableEngineLayers)return;let e=null;n.isSome(this._planeInfo)?e=this._planeInfo.plane:n.isSome(this._previewPlane)&&(e=this._previewPlane),this._outlineVisualElement.visible=this.visible,this._gridVisualElement.visible=n.isSome(e)&&this.visible},a._updateMaterials=function(){const e=[D.PLANE_OUTLINE_COLOR[0],D.PLANE_OUTLINE_COLOR[1],D.PLANE_OUTLINE_COLOR[2],D.PLANE_OUTLINE_COLOR[3]*this._baseOpacity];this._outlineVisualElement.color=e;const t=[D.PLANE_BACKGROUND_COLOR[0],D.PLANE_BACKGROUND_COLOR[1],D.PLANE_BACKGROUND_COLOR[2],D.PLANE_BACKGROUND_COLOR[3]*this._baseOpacity],i=this.inputState&&"resize"===this.inputState.type?D.GRID_COLOR:[0,0,0,0];this._gridVisualElement.backgroundColor=t,this._gridVisualElement.gridColor=i},a.updateManipulatorsInteractive=function(e){if(!e.grabbing)return this.shiftManipulator.interactive=!0,this.rotateHeadingManipulator.interactive=!0,this.rotateTiltManipulator.interactive=!0,void this.resizeManipulators.forEach((e=>{e.interactive=!0}));this.shiftManipulator.interactive=this.shiftManipulator===e,this.rotateHeadingManipulator.interactive=this.rotateHeadingManipulator===e,this.rotateTiltManipulator.interactive=this.rotateTiltManipulator===e,this.resizeManipulators.forEach((t=>{t.interactive=t===e}))},a.testData=function(){return{plane:n.isSome(this._planeInfo)?this._planeInfo.plane:null}},e._createClass(i,[{key:"state",get:function(){const e=!!this._planeInfo,t=!!this.inputState;return e?e&&t?"slicing":e&&!t?"sliced":"ready":"ready"}},{key:"isSupported",get:function(){return"3d"===this.get("view.type")}},{key:"model",set:function(e){if(null==e)throw new Error("SliceTool requires valid model, but null was provided.");this._handles.remove("model"),this._set("model",e),this._handles.add(this.model.watch("plane",(()=>this.planeChanged()),!0),"model")}},{key:"excludedLayers",get:function(){return this._get("excludedLayers")||new d},set:function(e){this._set("excludedLayers",f.referenceSetter(e,this._get("excludedLayers")))}},{key:"excludeGroundSurface",set:function(e){this._set("excludeGroundSurface",e),this.view&&this._updateLayerViews()}},{key:"tiltEnabled",set:function(e){e!==this._get("tiltEnabled")&&(this._set("tiltEnabled",e),this.view&&(this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),n.isSome(this._planeInfo)&&!e&&(this._planeInfo.plane=T.boundedPlane.copy(this._planeInfo.plane)),this._updateManipulators()))}},{key:"inputState",get:function(){return this._get("inputState")},set:function(e){this._set("inputState",e),this._updateMaterials()}},{key:"_isTargeting",get:function(){return!this.inputState&&!this._planeInfo&&this.active}},{key:"_creatingPointerId",get:function(){return this.inputState&&"shift"===this.inputState.type?this.inputState.creatingPointerId:null}}]),i}(k.InteractiveToolBase);function U(e,t,i,n){const a=O.createShiftPlane(i,T.boundedPlane.normal(n),e.direction,T.plane.create()),s=P.create();return T.plane.intersectRay(a,e,s)?{type:"shift",creatingPointerId:t,shiftPlane:a,depth:0,startPoint:s}:null}function F(e){return"mouse"!==e.pointerType||0===e.button}t.__decorate([r.property()],z.prototype,"clock",void 0),t.__decorate([r.property({constructOnly:!0})],z.prototype,"view",void 0),t.__decorate([r.property({readOnly:!0})],z.prototype,"state",null),t.__decorate([r.property({readOnly:!0})],z.prototype,"isSupported",null),t.__decorate([r.property({readOnly:!0})],z.prototype,"cursor",void 0),t.__decorate([r.property()],z.prototype,"model",null),t.__decorate([r.property()],z.prototype,"_planeInfo",void 0),t.__decorate([r.property({readOnly:!0})],z.prototype,"layersMode",void 0),t.__decorate([r.property({cast:f.castForReferenceSetter})],z.prototype,"excludedLayers",null),t.__decorate([r.property({type:Boolean,value:!1})],z.prototype,"excludeGroundSurface",null),t.__decorate([r.property({type:Boolean,value:!1})],z.prototype,"tiltEnabled",null),t.__decorate([r.property({value:null})],z.prototype,"inputState",null),z=t.__decorate([o.subclass("esri.views.3d.interactive.analysisTools.slice.SliceTool")],z);const G=T.boundedPlane.create(),K=_.createScreenPointArray();return z}));
