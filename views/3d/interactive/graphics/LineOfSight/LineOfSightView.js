/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../Color","../../../../../core/Accessor","../../../../../core/Handles","../../../../../core/handleUtils","../../../../../core/maybe","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/accessorSupport/ensureType","../../../../../core/Logger","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/accessorSupport/trackingUtils","../../../../../chunks/mat4f64","../../../../../chunks/vec3","../../../../../chunks/vec3f64","../../visualElements/LineVisualElement"],(function(e,i,t,n,o,s,r,a,l,c,u,d,h,f,y,m,g,_){"use strict";e.LineOfSightView=function(e){function t(i){var t;return(t=e.call(this,i)||this)._handle=null,t._analysisHandles=new s,t._lineOfSightVisualizations=[],t}i._inheritsLoose(t,e);var o=t.prototype;return o.initialize=function(){this._handle=this._connectAnalyses()},o.destroy=function(){this._handle=a.removeMaybe(this._handle),this._analysisHandles=a.destroyMaybe(this._analysisHandles)},o.createLineOfSightVisualization=function(){const e=this._configuration,i=this.view,t={visibleLineVisualElement:new _.LineVisualElement({view:i,attached:!0,width:e.outerWidth,color:n.toUnitRGBA(e.visibleOuterColor),innerWidth:e.innerWidth,innerColor:n.toUnitRGBA(e.visibleInnerColor)}),occludedLineVisualElement:new _.LineVisualElement({view:i,attached:!0,width:e.outerWidth,color:n.toUnitRGBA(e.occludedOuterColor),innerWidth:e.innerWidth,innerColor:n.toUnitRGBA(e.occludedInnerColor)}),undefinedLineVisualElement:new _.LineVisualElement({view:i,attached:!0,width:e.outerWidth,color:n.toUnitRGBA(e.undefinedOuterColor),innerWidth:e.innerWidth,innerColor:n.toUnitRGBA(e.undefinedInnerColor)})};return this._lineOfSightVisualizations.push(t),t},o.destroyLineOfSightVisualization=function(e){e.visibleLineVisualElement=a.destroyMaybe(e.visibleLineVisualElement),e.occludedLineVisualElement=a.destroyMaybe(e.occludedLineVisualElement),e.undefinedLineVisualElement=a.destroyMaybe(e.undefinedLineVisualElement),this._lineOfSightVisualizations.splice(this._lineOfSightVisualizations.indexOf(e),1)},o.updateLineOfSightVisualization=function(e,i){const t=this.model.visible,o=this._configuration,{computationResult:s,inputPoints:r}=e,{start:a,end:l,intersection:c,isValid:u,isTargetVisible:d}=s,{observer:h}=r,f=O;f[12]=h[0],f[13]=h[1],f[14]=h[2];const y=m.subtract(p,a,h),_=m.subtract(v,l,h),L=m.subtract(V,c,h),{visibleLineVisualElement:b,occludedLineVisualElement:S,undefinedLineVisualElement:w}=i;b.geometry=null,S.geometry=null,w.geometry=null,u?d?(b.geometry=[[g.fromArray(y),g.fromArray(_)]],b.transform=f,b.color=n.toUnitRGBA(o.visibleOuterColor)):(b.geometry=[[g.fromArray(y),g.fromArray(L)]],b.transform=f,b.color=n.toUnitRGBA(o.occludedOuterColor),S.geometry=[[g.fromArray(L),g.fromArray(_)]],S.transform=f):(w.geometry=[[g.fromArray(y),g.fromArray(_)]],w.transform=f),b.visible=t,S.visible=t,w.visible=t},o.getLineOfSightVisualizationDependencies=function(e){const{computationResult:i}=e,{occludedOuterColor:t,visibleOuterColor:n}=this._configuration;return{computationResult:i,occludedOuterColor:t,visibleOuterColor:n,visible:this.model.visible}},o.testData=function(){return{visualizations:this._lineOfSightVisualizations}},o._connectAnalysis=function(e){const i=this._analysisHandles;if(i.has(e))return;const t=this.createLineOfSightVisualization();i.add([f.reactionInit((()=>this.getLineOfSightVisualizationDependencies(e)),(()=>this.updateLineOfSightVisualization(e,t))),r.makeHandle((()=>this.destroyLineOfSightVisualization(t)))])},o._disconnectAnalysis=function(e){this._analysisHandles.remove(e)},o._connectAnalyses=function(){let e=null;return r.handlesGroup([f.reactionInit((()=>this._analyses),(i=>{e=a.removeMaybe(e),e=i.on("change",(e=>this._onAnalysesCollectionChange(e))),this._onAnalysesCollectionChange({target:i,added:i.items,removed:[],moved:[]})})),r.makeHandle((()=>e=a.removeMaybe(e)))])},o._onAnalysesCollectionChange=function(e){e.added.forEach((e=>this._connectAnalysis(e))),e.removed.forEach((e=>this._disconnectAnalysis(e)))},i._createClass(t,[{key:"_viewData",get:function(){return this.model.viewData}},{key:"_analyses",get:function(){return this._viewData.analyses}},{key:"_configuration",get:function(){return this._viewData.configuration.lineOfSight}}]),t}(o),t.__decorate([l.property({constructOnly:!0})],e.LineOfSightView.prototype,"model",void 0),t.__decorate([l.property({constructOnly:!0})],e.LineOfSightView.prototype,"view",void 0),t.__decorate([l.property()],e.LineOfSightView.prototype,"_viewData",null),t.__decorate([l.property()],e.LineOfSightView.prototype,"_analyses",null),t.__decorate([l.property()],e.LineOfSightView.prototype,"_configuration",null),e.LineOfSightView=t.__decorate([h.subclass("esri.views.3d.interactive.graphics.LineOfSight.LineOfSightView")],e.LineOfSightView);const p=g.create(),v=g.create(),V=g.create(),O=y.create();Object.defineProperty(e,"__esModule",{value:!0})}));
