/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../core/has","../../../../../core/maybe","../../../../../core/Logger","../../../../../core/accessorSupport/ensureType","../../../../../core/accessorSupport/decorators/property","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/urlUtils","../../../../../core/uuid","../../../../../portal/support/resourceExtension","../../../../../core/Accessor","../../../../../intl/locale","../../../../../core/mathUtils","../../../../../core/screenUtils","../../../../../intl/messages","../../../../../intl","../../../../../chunks/vec3f64","../../../../../chunks/vec3","../../../../../core/Handles","../../../../../core/watchUtils","../../../../../geometry/projectionEllipsoid","../../../../../core/unitUtils","../../../../../core/quantityFormatUtils","../../../../../chunks/vec2","../../../../../chunks/vec4f32","../../../webgl-engine/materials/lineStippleUtils","../../visualElements/RightAngleQuadVisualElement","../../measurementTools/support/viewUtils","../../visualElements/LabelVisualElement","../../visualElements/LineVisualElement","../../visualElements/support/Segment","../../visualElements/MeasurementArrowVisualElement"],(function(e,t,i,s,n,a,r,o,l,c,h,d,u,m,g,_,p,v,b,L,w,y,f,D,S,z,E,V,P,M,O,A,j,k){"use strict";function C(e,t){return n.isSome(e.measurement)&&e.measurement.horizontalDistance&&e.measurement.horizontalDistance.value>t}function R(e,t){if(!e.state)return!1;const i=e.state.camera,s=e.renderCoordsHelper,n=i.computeScreenPixelSizeAt(t);return s.getAltitude(t)/n>=10}function H(e,t,i,s,n){const a=F,r=W;n.projectToRenderScreen(i,a),n.projectToRenderScreen(t,r);const o={segment:"bottom",horizontal:"top",vertical:a[0]<r[0]?"left":"right"};{const s=I,a=Q;if(M.screenSpaceTangent(e,i,s,n),M.screenSpaceTangent(e,t,a,n),z.dot(s,a)>=x)o.segment=g.sign(s[1])===g.sign(a[1])?O.mirrorPosition(o.vertical):o.vertical;else{const e=N;M.screenSpaceTangent(i,t,e,n),z.dot(e,a)>=x&&(o.segment=g.sign(e[0])===g.sign(a[0])?O.mirrorPosition(o.horizontal):o.horizontal)}}if("below-segment"===s){const e=e=>"top"===e?"bottom":"top";o.segment=e(o.segment),o.horizontal=e(o.horizontal),o.vertical=e(o.vertical)}return o}function G(e,t){let i=null;if(n.isSome(t.measurement)){const e=t.measurement.directDistance;switch(t.settings.unit){case"metric":i=e&&e.toUnit("meters");break;case"imperial":i=e&&e.toUnit(D.preferredImperialLengthUnit(e.value,e.unit));break;case"degrees":case"degrees-minutes-seconds":{const e=t.measurement.geodesicAngle;i=e&&e.toUnit("degrees");break}default:i=e&&e.toUnit(t.settings.unit)}}if(i){let t=1;return t=g.nextHighestPowerOfTen(i.value/30),t*="degrees"===i.unit?f.getReferenceEllipsoid(e.spatialReference).metersPerDegree:D.convertUnit(1,i.unit,"meters"),t}return null}e.DirectLineMeasurement3DView=function(e){function i(t){var i;return(i=e.call(this,t)||this)._params={...U},i._handles=new w,i._segmentVisualElement=null,i._triangleVisualElement=null,i._rightAngleQuad=null,i._projectedGeodesicLine=null,i._geodesicStartHint=null,i._geodesicEndHint=null,i._segmentLabel=null,i._verticalLabel=null,i._horizontalLabel=null,i._segmentLabelDisplayedMeasurement="euclidean",i._startPosition=b.create(),i._endPosition=b.create(),i._cornerPosition=b.create(),i._startPositionAtSeaLevel=b.create(),i._endPositionAtSeaLevel=b.create(),i._viewMode="none",i._geometryDirty=!0,i.state="pending",i.messages=null,i._visualizedMeasurement="auto",i._actualVisualizedMeasurement="euclidean",i._visualElementOrientation="auto",i._triangleOrientationOverride=null,i._triangleCollapseRatioThreshold=.03,i._geodesicDistanceThreshold=1e5,i}t._inheritsLoose(i,e);var s=i.prototype;return s.initialize=function(){this._handles.add(y.whenOnce(this.view,"ready",(()=>this._initialize()),!0))},s._initialize=function(){switch(this.state){case"ready":throw new Error("invalid state");case"destroyed":return}this._segmentVisualElement=new k.MeasurementArrowVisualElement({attached:!0,view:this.view,geometry:null,renderOccluded:4}),this._triangleVisualElement=new A.LineVisualElement({attached:!0,view:this.view,width:this._params.triangleLineWidth,color:this._params.triangleColor,renderOccluded:4}),this._rightAngleQuad=new P.RightAngleQuadVisualElement({attached:!0,view:this.view,color:T,renderOccluded:4}),this._projectedGeodesicLine=new A.LineVisualElement({attached:!0,view:this.view,width:this._params.geodesicProjectionLineWidth,color:this._params.geodesicProjectionLineColor,polygonOffset:!0,stipplePattern:V.createStipplePatternSimple(this._params.guideStippleLengthPixels),stippleIntegerRepeats:!1,renderOccluded:4}),this._geodesicStartHint=new A.LineVisualElement({attached:!0,view:this.view,width:this._params.guideLineWidth,color:this._params.geodesicProjectionLineColor,polygonOffset:!0,stipplePattern:V.createStipplePatternSimple(this._params.guideStippleLengthPixels),stippleIntegerRepeats:!1,renderOccluded:4}),this._geodesicEndHint=new A.LineVisualElement({attached:!0,view:this.view,width:this._params.guideLineWidth,color:this._params.geodesicProjectionLineColor,polygonOffset:!0,stipplePattern:V.createStipplePatternSimple(this._params.guideStippleLengthPixels),stippleIntegerRepeats:!1,renderOccluded:4}),this._segmentLabel=new O.LabelVisualElement({attached:!0,view:this.view,fontSize:this._params.direcLabelFontSize}),this._verticalLabel=new O.LabelVisualElement({attached:!0,view:this.view,fontSize:this._params.verticalLabelFontSize}),this._horizontalLabel=new O.LabelVisualElement({attached:!0,view:this.view,fontSize:this._params.horizontalLabelFontSize}),this._handles.add([this.dataObject.watch("visible",(()=>this._update(!1)),!0),this.dataObject.watch("startPoint",(()=>this._update()),!0),this.dataObject.watch("endPoint",(()=>this._update()),!0),this.dataObject.watch("measurement",(()=>this._update()),!0),this.dataObject.watch("settings.unit",(()=>{this._updateLabels(),this._updateSegmentStripeLength()}),!0),this.view.state.watch("camera",(()=>this._update()),!0),m.onLocaleChange((async()=>this._updateMessageBundle()))]),this._set("state","ready"),this._updateMessageBundle(),this._update()},s.whenReady=async function(){return y.whenOnce(this,"ready").then((()=>{}))},s._update=function(e=!0){switch(this.state){case"destroyed":case"pending":return}const t=this.dataObject.visible;switch(this._geometryDirty=e,this._geometryDirty&&t&&(this._updateGeometryAndViewMode(),this._geometryDirty=!1),this._viewMode){case"none":this._segmentVisualElement.visible=!1,this._triangleVisualElement.visible=!1,this._rightAngleQuad.visible=!1,this._projectedGeodesicLine.visible=!1,this._geodesicStartHint.visible=!1,this._geodesicEndHint.visible=!1;break;case"segment":this._segmentVisualElement.visible=t,this._triangleVisualElement.visible=!1,this._rightAngleQuad.visible=!1,this._projectedGeodesicLine.visible=!1,this._geodesicStartHint.visible=!1,this._geodesicEndHint.visible=!1;break;case"segment-and-triangle":this._segmentVisualElement.visible=t,this._triangleVisualElement.visible=t,this._rightAngleQuad.visible=t,this._projectedGeodesicLine.visible=!1,this._geodesicStartHint.visible=!1,this._geodesicEndHint.visible=!1;break;case"segment-and-projection":this._segmentVisualElement.visible=t,this._projectedGeodesicLine.visible=!0,this._geodesicStartHint.visible=!0,this._geodesicEndHint.visible=!0}this._updateLabels()},s.destroy=function(){switch(this.state){case"destroyed":case"pending":return}this._handles.destroy(),this._segmentVisualElement.destroy(),this._segmentVisualElement=null,this._triangleVisualElement.destroy(),this._triangleVisualElement=null,this._rightAngleQuad.destroy(),this._rightAngleQuad=null,this._projectedGeodesicLine.destroy(),this._projectedGeodesicLine=null,this._geodesicStartHint.destroy(),this._geodesicStartHint=null,this._geodesicEndHint.destroy(),this._geodesicEndHint=null,this._segmentLabel.destroy(),this._segmentLabel=null,this._verticalLabel.destroy(),this._verticalLabel=null,this._horizontalLabel.destroy(),this._horizontalLabel=null,this.set("view",null),this._set("state","destroyed")},s._updateGeometryAndViewMode=function(){const e=this.view,t=e.renderCoordsHelper;if(n.isNone(this.dataObject.startPoint)||n.isNone(this.dataObject.endPoint)||this.dataObject.startPoint.equals(this.dataObject.endPoint))return this._viewMode="none",void(this._actualVisualizedMeasurement="auto"===this._visualizedMeasurement?"euclidean":this._visualizedMeasurement);t.toRenderCoords(this.dataObject.startPoint,this._startPosition),t.toRenderCoords(this.dataObject.endPoint,this._endPosition);const i=this._getActualVisualElementsOrientation(),s=this._updateActualVisualizedMeasurement();this._viewMode=this._computeViewMode(s);let a=this._startPosition,r=this._endPosition;const o="above-segment"===i?1:-1,l=o*(t.getAltitude(r)-t.getAltitude(a));l<0&&(a=this._endPosition,r=this._startPosition);const c="geodesic"===s?new j.GeodesicSegment(this._startPosition,this._endPosition,t.spatialReference):new j.EuclideanSegment(this._startPosition,this._endPosition);switch(this._segmentVisualElement.geometry=c,this._updateSegmentStripeLength(),this._segmentLabelDisplayedMeasurement=s,this._viewMode){case"segment":this._segmentLabel.anchor="above-segment"===i?"top":"bottom",this._segmentLabel.geometry={type:"segment",segment:c,sampleLocation:"center"};break;case"segment-and-triangle":{const s=this._cornerPosition;t.worldUpAtPosition(a,s),L.scale(s,s,o*Math.abs(l)),L.add(s,s,a),this._triangleVisualElement.geometry=[[[a[0],a[1],a[2]],[s[0],s[1],s[2]],[r[0],r[1],r[2]]]],this._rightAngleQuad.geometry={previous:a,center:s,next:r};const n=new j.EuclideanSegment(a,s),h=new j.EuclideanSegment(s,r),d=H(a,r,s,i,e.state.camera);this._segmentLabel.geometry={type:"segment",segment:c,sampleLocation:"center"},this._segmentLabel.anchor=d.segment,this._verticalLabel.geometry={type:"segment",segment:n,sampleLocation:"center"},this._verticalLabel.anchor=d.vertical,this._horizontalLabel.geometry={type:"segment",segment:h,sampleLocation:"center"},this._horizontalLabel.anchor=d.horizontal;break}case"segment-and-projection":{L.copy(this._startPositionAtSeaLevel,this._startPosition),L.copy(this._endPositionAtSeaLevel,this._endPosition),t.setAltitude(0,this._startPositionAtSeaLevel),t.setAltitude(0,this._endPositionAtSeaLevel);const e=new j.GeodesicSegment(this._startPositionAtSeaLevel,this._endPositionAtSeaLevel,t.spatialReference);this._projectedGeodesicLine.setGeometryFromSegment(e),this._geodesicStartHint.setGeometryFromSegment(new j.EuclideanSegment(this._startPositionAtSeaLevel,this._startPosition)),this._geodesicEndHint.setGeometryFromSegment(new j.EuclideanSegment(this._endPositionAtSeaLevel,this._endPosition)),this._segmentLabel.geometry={type:"segment",segment:e,sampleLocation:"center"},this._segmentLabel.anchor="above-segment"===i?"top":"bottom";break}}},s._updateLabels=function(){switch(this.state){case"pending":case"destroyed":return}const e=this.messages,t=this.dataObject.measurement;if(n.isNone(t)||!e)return this._segmentLabel.visible=!1,this._horizontalLabel.visible=!1,void(this._verticalLabel.visible=!1);const i={verticalDistance:"",horizontalDistance:"",euclideanDistance:"",geodesicDistance:""},s=t.directDistance,a=t.horizontalDistance,r=t.verticalDistance,o=t.geodesicDistance,l=t.geodesicAngle;switch(this.dataObject.settings.unit){case"metric":i.euclideanDistance=s&&S.formatMetricLength(e,s),i.horizontalDistance=a&&S.formatMetricLength(e,a),i.verticalDistance=r&&S.formatMetricVerticalLength(e,r),i.geodesicDistance=o&&S.formatMetricLength(e,o);break;case"imperial":i.euclideanDistance=s&&S.formatImperialLength(e,s),i.horizontalDistance=a&&S.formatImperialLength(e,a),i.verticalDistance=r&&S.formatImperialVerticalLength(e,r),i.geodesicDistance=o&&S.formatImperialLength(e,o);break;case"degrees":{const t=l&&S.formatDecimal(e,l,"degrees");i.euclideanDistance=t,i.horizontalDistance=t,i.geodesicDistance=t;break}case"degrees-minutes-seconds":i.horizontalDistance=l&&S.formatDMS(l);break;default:{const t=this.dataObject.settings.unit;i.euclideanDistance=s&&S.formatDecimal(e,s,t),i.horizontalDistance=a&&S.formatDecimal(e,a,t),i.verticalDistance=r&&S.formatDecimal(e,r,t),i.geodesicDistance=o&&S.formatDecimal(e,o,t);break}}this._segmentLabel.text="euclidean"===this._segmentLabelDisplayedMeasurement?i.euclideanDistance:i.geodesicDistance,this._horizontalLabel.text=i.horizontalDistance,this._verticalLabel.text=i.verticalDistance;const c=this.dataObject.visible;switch(this._viewMode){case"none":this._segmentLabel.visible=!1,this._horizontalLabel.visible=!1,this._verticalLabel.visible=!1;break;case"segment":this._segmentLabel.visible=c,this._horizontalLabel.visible=!1,this._verticalLabel.visible=!1;break;case"segment-and-triangle":this._segmentLabel.visible=c,this._horizontalLabel.visible=c,this._verticalLabel.visible=c;break;case"segment-and-projection":this._segmentLabel.visible=c,this._horizontalLabel.visible=!1,this._verticalLabel.visible=!1}this.notifyChange("segmentLabel"),this.notifyChange("horizontalLabel"),this.notifyChange("verticalLabel")},s._updateSegmentStripeLength=function(){const e=G(this.view,this.dataObject);n.isSome(e)?(this._segmentVisualElement.stripeLength=e,this._segmentVisualElement.stripesEnabled=!0):this._segmentVisualElement.stripesEnabled=!1},s._computeViewMode=function(e){const t=this.dataObject,i=t.measurement;if("geodesic"===e){if(!C(t,this.geodesicDistanceThreshold))return"segment";if(R(this.view,this._startPosition)||R(this.view,this._endPosition))return"segment-and-projection"}if(n.isNone(i))return"segment";return Math.min(i.verticalDistance.value/i.horizontalDistance.value,i.horizontalDistance.value/i.verticalDistance.value)<this.triangleCollapseRatioThreshold?"segment":"segment-and-triangle"},s._getActualVisualElementsOrientation=function(){return n.isSome(this._triangleOrientationOverride)?this._triangleOrientationOverride:"auto"===this.visualElementsOrientation?this.view.state.camera.aboveGround?"above-segment":"below-segment":this.visualElementsOrientation},s._updateActualVisualizedMeasurement=function(){if("auto"===this._visualizedMeasurement){this._actualVisualizedMeasurement="euclidean";const e=this.dataObject.settings.unit;"degrees"!==e&&"degrees-minutes-seconds"!==e||(this._actualVisualizedMeasurement="geodesic"),C(this.dataObject,this.geodesicDistanceThreshold)&&(this._actualVisualizedMeasurement="geodesic")}else this._actualVisualizedMeasurement=this._visualizedMeasurement;return this._actualVisualizedMeasurement},s._updateMessageBundle=function(){p.fetchMessageBundle("esri/core/t9n/Units").then((e=>{this.messages=e,this.view&&this._updateLabels()}))},t._createClass(i,[{key:"ready",get:function(){return"ready"===this.state}},{key:"viewMode",get:function(){return this._viewMode}},{key:"visualizedMeasurement",get:function(){return this._visualizedMeasurement},set:function(e){e!==this._visualizedMeasurement&&(this._visualizedMeasurement=e,this._update())}},{key:"actualVisualizedMeasurement",get:function(){return this._actualVisualizedMeasurement}},{key:"visualElementsOrientation",get:function(){return this._visualElementOrientation},set:function(e){e!==this._visualElementOrientation&&(this._visualElementOrientation=e,this._update())}},{key:"allowVisualElementsOrientationChange",get:function(){return n.isNone(this._triangleOrientationOverride)},set:function(e){n.isNone(this._triangleOrientationOverride)!==e&&(n.isNone(this._triangleOrientationOverride)?this._triangleOrientationOverride=this._getActualVisualElementsOrientation():(this._triangleOrientationOverride=null,this._update()))}},{key:"triangleCollapseRatioThreshold",get:function(){return this._triangleCollapseRatioThreshold},set:function(e){this._triangleCollapseRatioThreshold=e,this._update()}},{key:"geodesicDistanceThreshold",get:function(){return this._geodesicDistanceThreshold},set:function(e){this._geodesicDistanceThreshold=e,this._update()}},{key:"segmentLabel",get:function(){return this._segmentLabel}},{key:"horizontalLabel",get:function(){return this._horizontalLabel}},{key:"verticalLabel",get:function(){return this._verticalLabel}},{key:"testData",get:function(){let e=null;const t="geodesic"===this.actualVisualizedMeasurement;return e={direct:t?this.horizontalLabel:this.segmentLabel,horizontal:t?this.segmentLabel:this.horizontalLabel,vertical:this.verticalLabel},{labels:e,stripeLength:this._segmentVisualElement.stripeLength}}}]),i}(u),i.__decorate([o.property({readOnly:!0})],e.DirectLineMeasurement3DView.prototype,"state",void 0),i.__decorate([o.property()],e.DirectLineMeasurement3DView.prototype,"ready",null),i.__decorate([o.property()],e.DirectLineMeasurement3DView.prototype,"messages",void 0),i.__decorate([o.property()],e.DirectLineMeasurement3DView.prototype,"view",void 0),i.__decorate([o.property()],e.DirectLineMeasurement3DView.prototype,"dataObject",void 0),i.__decorate([o.property()],e.DirectLineMeasurement3DView.prototype,"viewMode",null),i.__decorate([o.property()],e.DirectLineMeasurement3DView.prototype,"segmentLabel",null),i.__decorate([o.property()],e.DirectLineMeasurement3DView.prototype,"horizontalLabel",null),i.__decorate([o.property()],e.DirectLineMeasurement3DView.prototype,"verticalLabel",null),e.DirectLineMeasurement3DView=i.__decorate([l.subclass("esri.views.3d.interactive.graphics.DirectLineMeasurement3D.DirectLineMeasurement3DView")],e.DirectLineMeasurement3DView);const T=E.fromValues(1,.5,0,.75),U={laserLineGlowColor:[1,.5,0],laserLineGlowWidth:8,laserLineGlowFalloff:8,laserLineInnerColor:[1,1,1],laserLineInnerWidth:.75,laserLineGlobalAlpha:.75,laserLineEnabled:!0,handleColor:[1,.5,0],handleOpacity:.5,handleRadius:5,triangleColor:T,triangleLineWidth:3,triangleCornerSize:32,triangleSubdivisions:128,arrowWidth:16,arrowOutlineColor:[1,.5,0,1],arrowOutlineWidth:.2,arrowStripeEvenColor:[1,1,1,1],arrowStripeOddColor:[1,.5,0,1],arrowStripeLength:16,arrowSubdivisions:128,geodesicProjectionLineWidth:2,geodesicProjectionLineColor:T,guideLineWidth:2,guideLineColor:T,guideStippleLengthPixels:6,labelDistance:25,direcLabelFontSize:16,horizontalLabelFontSize:12,verticalLabelFontSize:12},x=Math.cos(g.deg2rad(12)),F=_.createRenderScreenPointArray3(),W=_.createRenderScreenPointArray3(),I=_.createRenderScreenPointArray(),Q=_.createRenderScreenPointArray(),N=_.createRenderScreenPointArray();Object.defineProperty(e,"__esModule",{value:!0})}));
