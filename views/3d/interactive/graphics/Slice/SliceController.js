/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../core/Accessor","../../../../../core/Handles","../../../../../core/Logger","../../../../../core/maybe","../../../../../core/watchUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/accessorSupport/ensureType","../../../../../core/accessorSupport/decorators/subclass","../../../../../chunks/boundedPlane","../../../../../layers/Layer","../../../../../layers/buildingSublayers/BuildingComponentSublayer","../../analysisTools/slice/sliceToolUtils","../../../../../widgets/Slice/SlicePlane"],(function(e,i,t,a,l,r,n,s,o,c,d,h,u,y,p,w,v){"use strict";const _=r.getLogger("esri.views.3d.interactive.graphics.Slice.SliceController");e.SliceController=function(e){function t(i){var t;return(t=e.call(this,i)||this)._handles=new l,t._internalChange=!1,t._currentSlicePlane=null,t.state="pending",t}i._inheritsLoose(t,e);var a=t.prototype;return a.initialize=function(){this._handles.add(this.layerView.layerViewData.excludedLayers.on("before-add",(e=>{const i=e.item;null!=i&&(i instanceof y||i instanceof p)?i instanceof y&&w.isAlwaysDrapedLayer(i)?(_.error("excludedLayers",`Layer '${i.title}, id:${i.id}' of type '${i.type}' can not be individually excluded from slicing. Use 'excludeGroundSurface' instead.`),e.preventDefault()):this.layerView.layerViewData.excludedLayers.includes(i)&&e.preventDefault():(_.error("excludedLayers","Invalid layer type, layer must derive from Layer or BuildingComponentSublayer"),e.preventDefault())}))),this._handles.add(s.whenOnce(this.view,"ready",(()=>this._initialize()),!0))},a._initialize=function(){switch(this.state){case"pending":break;case"destroyed":return;case"ready":throw new Error("state error")}g(this.view,this),this._handles.add([this.layerView.layerViewData.watch("plane",(()=>{this._internalChange||this._updateSlicePlaneFromBoundedPlane(),this._updateLayerViews()}),!0),this.layerView.layerViewData.watch("excludeGroundSurface",(()=>this._updateLayerViews()),!0),this.layerView.layerViewData.excludedLayers.on("change",(()=>this._updateLayerViews())),this.layerView.watch(["active","visible"],(()=>{this._updateActiveController(),this._updateViewSlicePlane()}),!0),this.view.allLayerViews.on("change",(()=>this._updateLayerViews()))]),this._handles.add([this.analysis.watch("plane",(()=>{this._internalChange||(this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane())}),!0)],"analysis"),this._set("state","ready"),this._updateActiveController(),this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane()},a.destroy=function(){switch(this.state){case"destroyed":case"pending":return}this.layerView.active=!1,P(this.view,this),this._handles.destroy(),this.view.slicePlane=null,this.set("view",null),this._set("state","destroyed")},a.whenReady=function(){var e=i._asyncToGenerator((function*(){return yield s.whenOnce(this,"ready"),this}));function t(){return e.apply(this,arguments)}return t}(),a._updateBoundedPlaneFromSlicePlane=function(){const e=this.analysis.plane,i=this._currentSlicePlane;if(n.isNone(i)&&n.isNone(e)||n.isSome(i)&&n.isSome(e)&&e.equals(i))return;let t=null,a=null;n.isSome(e)&&(t=w.shapeToElevationAlignedPlane(e,this.view,u.create()),n.isSome(t)?a={heading:e.heading,tilt:e.tilt,position:e.position,width:e.width,height:e.height}:console.warn("Failed slice plane conversion.")),this._currentSlicePlane=a,n.isSome(t)&&!this.analysis.tiltEnabled&&w.forceHorizontalOrVertical(t,this.view.renderCoordsHelper,t),this._internalChange=!0,this.layerView.layerViewData.plane=t,this._internalChange=!1},a._updateSlicePlaneFromBoundedPlane=function(){const e=this.layerView.layerViewData.plane,i=w.planeToShape(e,this.view.renderCoordsHelper,this.view.spatialReference,new v);let t=null;n.isSome(i)&&(t={heading:i.heading,tilt:i.tilt,position:i.position,width:i.width,height:i.height}),this._currentSlicePlane=t,n.isSome(e)&&(this.analysis.tiltEnabled||w.forceHorizontalOrVertical(e,this.view.renderCoordsHelper,e)),this._internalChange=!0,this.analysis.plane=i,this._internalChange=!1,this._updateViewSlicePlane()},a._updateActiveController=function(){if(f)return;const e=C(this.view);if(this.layerView.active)n.isSome(e.activeController)&&e.activeController!==this?(f=!0,e.activeController.layerView.active=!1,f=!1):n.isSome(e.activeController)&&e.activeController,this._updateLayerViews(),e.activeController=this;else{if(n.isSome(e.activeController)&&e.activeController!==this)return;n.isSome(e.activeController)&&e.activeController===this&&(e.activeController=null,this._updateLayerViews())}},a._updateViewSlicePlane=function(){"ready"===this.state&&V(this.view)},a._updateLayerViews=function(){const e=n.isSome(this.layerView.layerViewData.plane)&&this.layerView.visible&&this.layerView.active,i=[],t=e=>{"layers"in e?e.layers.forEach(t):i.push(e)};this.layerView.layerViewData.excludedLayers.forEach(t),this.view.allLayerViews.forEach((t=>{"slicePlaneEnabled"in t&&(t.slicePlaneEnabled=e&&i.indexOf(t.layer)<0),"sublayerViews"in t&&t.sublayerViews.forEach((t=>{t.slicePlaneEnabled=e&&i.indexOf(t.sublayer)<0}))})),null!=this.view.basemapTerrain&&(this.view.basemapTerrain.slicePlaneEnabled=e&&!this.layerView.layerViewData.excludeGroundSurface)},i._createClass(t,[{key:"ready",get:function(){return"ready"===this.state}}]),t}(a),t.__decorate([o.property({readOnly:!0})],e.SliceController.prototype,"state",void 0),t.__decorate([o.property()],e.SliceController.prototype,"view",void 0),t.__decorate([o.property()],e.SliceController.prototype,"analysis",void 0),t.__decorate([o.property()],e.SliceController.prototype,"layerView",void 0),t.__decorate([o.property()],e.SliceController.prototype,"ready",null),e.SliceController=t.__decorate([h.subclass("esri.views.3d.interactive.graphics.Slice.SliceController")],e.SliceController);const S=new Map;let f=!1;function V(e){const i=C(e).activeController;n.isSome(i)&&n.isSome(i.layerView.layerViewData.plane)&&i.layerView.visible?e.slicePlane=i.layerView.layerViewData.plane:e.slicePlane=null}function g(e,i){S.has(e)||S.set(e,{all:[],activeController:null}),S.get(e).all.push(i)}function C(e){return S.get(e)}function P(e,i){if(!S.has(e))throw new Error("view expected in global slice register");const t=S.get(e),a=t.all.lastIndexOf(i);if(-1===a)throw new Error("controller expected in global slice register");t.all.splice(a,1),0===t.all.length&&S.delete(e)}Object.defineProperty(e,"__esModule",{value:!0})}));
