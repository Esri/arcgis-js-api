/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/colorUtils","../../../../../core/Evented","../../../../../core/mathUtils","../../../../../core/maybe","../../../../../chunks/mat4","../../../../../chunks/mat4f64","../../../../../chunks/vec3","../../../../../chunks/vec3f64","../../Manipulator3D","../../manipulatorUtils","../../RenderObject","../dragEventPipeline3D","../ManipulatorType","../settings","./config","./Manipulation","./moveUtils","../../../webgl-engine/lib/GeometryUtil","../../../webgl-engine/lib/Material","../../../../interactive/dragEventPipeline","../../../../interactive/interfaces"],(function(e,t,a,i,n,r,o,s,l,c,u,p,d,h,M,g,m,_,f,v,w,b,y){"use strict";let S=function(e){function _(t){var a;return(a=e.call(this)||this)._radius=m.DISC_RADIUS,a.events=new i,a._tool=t.tool,a._view=t.view,null!=t.radius&&(a._radius=t.radius),a._createManipulator(),a.forEachManipulator((e=>a._tool.manipulators.add(e))),a}t._inheritsLoose(_,e);var S=_.prototype;return S.destroy=function(){this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()}))},S.forEachManipulator=function(e){e(this._manipulator,M.ManipulatorType.TRANSLATE_Z)},S.createGraphicDragPipeline=function(e,t,a){const i=r.unwrap(t.graphic.geometry).spatialReference;return f.createGraphicMoveDragPipeline(t,a,(t=>this.createDragPipeline(((a,i,n,r,o)=>(({steps:i,cancel:n}=e(a,i,n,r,o)),t(a,i,n))),i)),this._view.state.viewingMode)},S.createDragPipeline=function(e,t){const a=this._view;return b.createManipulatorDragEventPipeline(this._manipulator,((i,n,r,o,s)=>{const l=n.next((e=>({...e,manipulatorType:M.ManipulatorType.TRANSLATE_Z}))).next(h.screenToZConstrained(a,i.renderLocation,t)).next(b.addScreenDelta());e(i,l,r,o,s)}))},S._updateManipulator=function(){const e=this._radius/m.DISC_RADIUS,t=g.settings.zManipulator.height*e,i=g.settings.zManipulator.coneHeight*e,n=g.settings.zManipulator.coneWidth*e,r=g.settings.zManipulator.width*e,l=[c.fromValues(0,0,0),c.fromValues(0,0,t)],u=[c.fromValues(0,0,0),c.fromValues(0,0,t+i)],h=e=>{const a=s.create();if(o.translate(a,a,[0,0,t]),o.rotateX(a,a,Math.PI/2),e){const t=1+2*e/n;o.scale(a,a,[t,t,t])}return a},M=h(0),_=(e,t)=>{const i=a.darken(g.settings.zManipulator.color,t);return[i.r/255,i.g/255,i.b/255,g.settings.zManipulator.color.a*e]},f=p.createManipulatorMaterial(_(1,.25),w.RenderOccludedFlag.Occlude),b=p.createManipulatorMaterial(_(1,0),w.RenderOccludedFlag.Occlude),S=p.createManipulatorMaterial(_(.7,0),g.settings.zManipulator.renderOccluded),O=p.createManipulatorMaterial(_(.85,0),g.settings.zManipulator.renderOccluded),R=v.createTubeGeometry(f,l,r/2,16,!1),D=v.createConeGeometry(f,i,n/2,16,!1);D.transformation=M,this._manipulator.renderObjects=[new d.RenderObject(D,y.ManipulatorStateFlags.Unfocused),new d.RenderObject(R,y.ManipulatorStateFlags.Unfocused),new d.RenderObject(D.instantiate({material:b}),y.ManipulatorStateFlags.Focused),new d.RenderObject(R.instantiate({material:b}),y.ManipulatorStateFlags.Focused),new d.RenderObject(D.instantiate({material:S}),y.ManipulatorStateFlags.Unfocused),new d.RenderObject(R.instantiate({material:S}),y.ManipulatorStateFlags.Unfocused),new d.RenderObject(D.instantiate({material:O}),y.ManipulatorStateFlags.Focused),new d.RenderObject(R.instantiate({material:O}),y.ManipulatorStateFlags.Focused)],this._manipulator.radius=r/2+2,this._manipulator.collisionType={type:"line",paths:[u]}},S._createManipulator=function(){const e=new u.Manipulator3D({view:this._view,autoScaleRenderObjects:!1,worldSized:!1,selectable:!1,cursor:"ns-resize",elevationInfo:this.elevationInfo,worldOriented:!0,collisionPriority:1.6});e.applyObjectTransform=e=>{const t=this._view.state.camera,a=O;this._view.renderCoordsHelper.toRenderCoords(this._manipulator.elevationAlignedLocation,a);const i=l.dist(t.eye,a),r=t.computeRenderPixelSizeAtDist(i),o=l.subtract(R,a,t.eye);l.normalize(o,o);const s=D;this._view.renderCoordsHelper.worldUpAtPosition(O,s);const c=Math.abs(l.dot(o,s)),u=l.cross(R,o,s),p=l.cross(R,u,s),d=n.clamp(c,.01,1),h=1-Math.sqrt(1-d*d)/d/t.fullWidth,M=this._radius/m.DISC_RADIUS,_=g.settings.zManipulator.width*M;l.scale(p,l.normalize(p,p),(1/h-1)*i+r*_),e[12]-=R[0],e[13]-=R[1],e[14]-=R[2]},this._manipulator=e,this._updateManipulator()},t._createClass(_,[{key:"radius",get:function(){return this._radius},set:function(e){e!==this._radius&&(this._radius=e,this._updateManipulator())}},{key:"test",get:function(){return{manipulator:this._manipulator}}}]),_}(_.Manipulation);const O=c.create(),R=c.create(),D=c.create();e.MoveZManipulation=S,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
