/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/colorUtils","../../../../../core/Evented","../../../../../core/Handles","../../../../../core/mathUtils","../../../../../core/maybe","../../../../../chunks/mat4","../../../../../chunks/mat4f64","../../../../../chunks/vec3","../../../../../chunks/vec3f64","../../Manipulator3D","../../manipulatorUtils","../dragEventPipeline3D","../ManipulatorType","../settings","./config","./Manipulation","./moveUtils","../../../webgl-engine/lib/GeometryUtil","../../../webgl-engine/lib/Material","../../../../interactive/dragEventPipeline","../../../../interactive/interfaces"],(function(e,t,a,r,i,n,o,s,l,u,c,p,d,M,h,m,g,_,f,v,y,S,w){"use strict";let b=function(e){function _(t){var a;return(a=e.call(this)||this)._handles=new i,a._radius=g.DISC_RADIUS,a.events=new r,a._tool=t.tool,a._view=t.view,null!=t.radius&&(a._radius=t.radius),a._createManipulator(),a.forEachManipulator((e=>a._tool.manipulators.add(e))),a}t._inheritsLoose(_,e);var b=_.prototype;return b.destroy=function(){this._handles.destroy(),this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()}))},b.forEachManipulator=function(e){e(this._manipulator,h.ManipulatorType.TRANSLATE_Z)},b.createGraphicDragPipeline=function(e,t,a){const r=o.unwrap(t.graphic.geometry).spatialReference;return f.createGraphicMoveDragPipeline(t,a,(t=>this.createDragPipeline(((a,r,i,n,o)=>t(a,e(a,r,i,n,o),i)),r)),this._view.state.viewingMode)},b.createDragPipeline=function(e,t){const a=this._view;return S.createManipulatorDragEventPipeline(this._manipulator,((r,i,n,o,s)=>{const l=i.next((e=>({...e,manipulatorType:h.ManipulatorType.TRANSLATE_Z}))).next(M.screenToZConstrained(a,r.renderLocation,t)).next(S.addScreenDelta());e(r,l,n,o,s)}))},b._updateManipulator=function(){const e=this._radius/g.DISC_RADIUS,t=m.settings.zManipulator.height*e,r=m.settings.zManipulator.coneHeight*e,i=m.settings.zManipulator.coneWidth*e,n=m.settings.zManipulator.width*e,o=[c.fromValues(0,0,0),c.fromValues(0,0,t)],u=v.createTubeGeometry(o,n/2,16,!1),p=v.createConeGeometry(r,i/2,16,!1),M=[c.fromValues(0,0,0),c.fromValues(0,0,t+r)],h=e=>{const a=l.create();if(s.translate(a,a,[0,0,t]),s.rotateX(a,a,Math.PI/2),e){const t=1+2*e/i;s.scale(a,a,[t,t,t])}return a},_=h(0),f=(e,t)=>{const r=a.darken(m.settings.zManipulator.color,t);return[r.r/255,r.g/255,r.b/255,m.settings.zManipulator.color.a*e]},S=d.createManipulatorMaterial(f(1,.25),y.RenderOccludedFlag.Occlude),b=d.createManipulatorMaterial(f(1,0),y.RenderOccludedFlag.Occlude),k=d.createManipulatorMaterial(f(.7,0),m.settings.zManipulator.renderOccluded),D=d.createManipulatorMaterial(f(.85,0),m.settings.zManipulator.renderOccluded);this._manipulator.renderObjects=[{geometry:p,transform:_,material:S,stateMask:w.ManipulatorStateFlags.Unfocused},{geometry:u,material:S,stateMask:w.ManipulatorStateFlags.Unfocused},{geometry:p,transform:_,material:b,stateMask:w.ManipulatorStateFlags.Focused},{geometry:u,material:b,stateMask:w.ManipulatorStateFlags.Focused},{geometry:p,transform:_,material:k,stateMask:w.ManipulatorStateFlags.Unfocused},{geometry:u,material:k,stateMask:w.ManipulatorStateFlags.Unfocused},{geometry:p,transform:_,material:D,stateMask:w.ManipulatorStateFlags.Focused},{geometry:u,material:D,stateMask:w.ManipulatorStateFlags.Focused}],this._manipulator.radius=n/2+2,this._manipulator.collisionType={type:"line",paths:[M]}},b._createManipulator=function(){const e=new p.Manipulator3D({view:this._view,autoScaleRenderObjects:!1,worldSized:!1,selectable:!1,cursor:"ns-resize",elevationInfo:this.elevationInfo,worldOriented:!0,collisionPriority:1.6});e.applyObjectTransform=e=>{const t=this._view.state.camera,a=k;this._view.renderCoordsHelper.toRenderCoords(this._manipulator.elevationAlignedLocation,a);const r=u.dist(t.eye,a),i=t.computeRenderPixelSizeAtDist(r),o=u.subtract(D,a,t.eye);u.normalize(o,o);const s=z;this._view.renderCoordsHelper.worldUpAtPosition(k,s);const l=Math.abs(u.dot(o,s)),c=u.cross(D,o,s),p=u.cross(D,c,s),d=n.clamp(l,.01,1),M=1-Math.sqrt(1-d*d)/d/t.fullWidth,h=this._radius/g.DISC_RADIUS,_=m.settings.zManipulator.width*h;u.scale(p,u.normalize(p,p),(1/M-1)*r+i*_),e[12]-=D[0],e[13]-=D[1],e[14]-=D[2]},this._manipulator=e,this._updateManipulator()},t._createClass(_,[{key:"radius",get:function(){return this._radius},set:function(e){e!==this._radius&&(this._radius=e,this._updateManipulator())}},{key:"test",get:function(){return{manipulator:this._manipulator}}}]),_}(_.Manipulation);const k=c.create(),D=c.create(),z=c.create();e.MoveZManipulation=b,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
