/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/maybe","../../../../../core/handleUtils","../../../../../core/Evented","../../../../../Color","../../../../../chunks/vec3f64","../../../../../chunks/vec3","../../../../../core/Handles","../../../../../chunks/mat4","../../../../../chunks/mat4f64","../../../../../support/elevationInfoUtils","../../../support/stack","../../../webgl-engine/lib/GeometryUtil","../../../webgl-engine/lib/Geometry","../../../webgl-engine/materials/ColorMaterial","../../../../interactive/dragEventPipeline","../dragEventPipeline3D","../../Manipulator3D","../settings","./config","./Manipulation","./moveUtils"],(function(t,a,e,r,n,i,o,s,l,u,p,c,d,h,f,_,g,m,M,v,w,y,A){"use strict";let I=function(t){function y(a){var e;return(e=t.call(this)||this)._handles=new l,e._arrowManipulatorInfos=new Array,e._opaqueMaterial=e.createMaterial(),e._transparentMaterial=e.createMaterial(.5),e._angle=0,e._scale=1,e._radius=w.DISC_RADIUS,e._updateAfterDrag=!1,e.events=new n,e._tool=a.tool,e._view=a.view,null!=a.radius&&(e._radius=a.radius),e._createManipulators(),e.forEachManipulator((t=>e._tool.manipulators.add(t))),e}a._inheritsLoose(y,t);var I=y.prototype;return I.destroy=function(){this.forEachManipulator((t=>{this._tool.manipulators.remove(t),t.destroy()})),this._handles.removeAll(),this._tool=null,this._view=null,this._arrowManipulatorInfos.length=0},I.forEachManipulator=function(t){this._arrowManipulatorInfos.map((({manipulator:a})=>t(a,1)))},I.createGraphicDragPipeline=function(t,a){const r=t.graphic,n=c.getGraphicEffectiveElevationInfo(r),i=e.unwrap(r.geometry).spatialReference;return A.createGraphicMoveDragPipeline(t,a,(t=>this.createDragPipeline(t,n,i)))},I.createDragPipeline=function(t,a,e){return r.handlesGroup(this._arrowManipulatorInfos.map((({manipulator:r},n)=>g.createManipulatorDragEventPipeline(r,((r,i,o,s,l)=>{const u=i.next((t=>({...t,manipulatorType:1}))).next(g.dragAtLocation(this._view,r.elevationAlignedLocation)).next(m.screenToMapXYAtLocation(this._view,r.elevationAlignedLocation,a,e)).next(g.constrainToMapAxis(r.location,this.angle+(n+1)*Math.PI*.5)).next(g.addScreenDelta());t(r,u,o,s,l)})))))},I._updateManipulators=function(){for(let t=0;t<this._arrowManipulatorInfos.length;t++)this._updateArrowManipulator(this._arrowManipulatorInfos[t],t);this._updateManipulatorTransform()},I._updateArrowManipulator=function({manipulator:t,transform:a},e){const r=this._radius/w.DISC_RADIUS,n=w.DISC_TRANSLATE_ARROW_SIZE*r,i=Math.sqrt(n*n*3/4),o=h.createExtrudedTriangle(i,n/2,n/2,w.DISC_HEIGHT);h.transformInPlace(o,u.fromTranslation(d.sm4d.get(),s.set(d.sv3d.get(),0,-i/3,0)));const l=new f(o,"move-xy-axis-arrow");t.renderObjects=[{geometry:l,material:this._opaqueMaterial,stateMask:2},{geometry:l,material:this._transparentMaterial,stateMask:1}],t.radius=i/3*2*1.2;const p=u.identity(d.sm4d.get());u.fromZRotation(p,e*Math.PI/2);const c=u.identity(d.sm4d.get());u.fromTranslation(c,s.set(d.sv3d.get(),0,w.DISC_TRANSLATE_ARROW_OFFSET*r,0)),u.multiply(a,p,c)},I._createManipulators=function(){for(let t=0;t<4;t++){const a=this._createArrowManipulator(t);this._arrowManipulatorInfos.push(a)}this._updateManipulatorTransform()},I._updateManipulatorTransform=function(){const t=this.angle,a=u.identity(d.sm4d.get());u.rotate(a,a,t,o.fromValues(0,0,1));const e=u.fromScaling(d.sm4d.get(),s.set(d.sv3d.get(),this.displayScale,this.displayScale,this.displayScale)),r=u.identity(d.sm4d.get());u.multiply(r,e,a);for(const t of this._arrowManipulatorInfos){const a=u.multiply(d.sm4d.get(),r,t.transform);t.manipulator.modelTransform=a}},I._createArrowManipulator=function(t){const a=new M.Manipulator3D({view:this._view,autoScaleRenderObjects:!1,worldOriented:!0,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:o.fromValues(0,0,1)}}),e={manipulator:a,transform:p.create()};return this._updateArrowManipulator(e,t),this._handles.add(a.events.on("drag",(t=>{this._updateAfterDrag&&"end"===t.action&&!this.dragging&&(this._updateManipulatorTransform(),this._updateAfterDrag=!1)}))),e},I.createMaterial=function(t=1){const a=i.toUnitRGBA(v.colors.main);return a[3]*=t,new _.ColorMaterial({color:a,transparent:1!==t,cullFace:2,renderOccluded:2},"graphic-transform")},a._createClass(y,[{key:"orthogonalAvailable",set:function(t){this._arrowManipulatorInfos[1].manipulator.available=t,this._arrowManipulatorInfos[3].manipulator.available=t}},{key:"angle",get:function(){return this._angle},set:function(t){this._angle=t,this.dragging?this._updateAfterDrag=!0:this._updateManipulatorTransform()}},{key:"displayScale",get:function(){return this._scale},set:function(t){this._scale=t,this._updateManipulatorTransform()}},{key:"radius",get:function(){return this._radius},set:function(t){this._radius!==t&&(this._radius=t,this._updateManipulators())}},{key:"test",get:function(){return{arrowManipulators:this._arrowManipulatorInfos.map((({manipulator:t})=>t))}}}]),y}(y.Manipulation);t.MoveXYAxisManipulation=I,Object.defineProperty(t,"__esModule",{value:!0})}));
