/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../core/handleUtils","../../../../core/mathUtils","../../../../core/maybe","../../../../core/reactiveUtils","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/projection","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../support/elevationInfoUtils","./GrabbingState","./ManipulatorState","./settings","../visualElements/ExtendedLineVisualElement","../visualElements/LaserlineVisualElement","../visualElements/PointVisualElement","../../layers/graphics/elevationAlignmentUtils","../../layers/graphics/ElevationContext","../../layers/graphics/GraphicState","../../webgl-engine/lib/Material"],(function(e,t,n,a,i,s,l,o,r,c,p,u,d,h,g,v,m,f,y,E,w){"use strict";function b(e){const{view:n,graphic:a}=e,i=new E.GraphicState({graphic:a}),s=[],l=V(e,i,s);return S(e,i,s,l),s.push(n.trackGraphicState(i)),{visualElement:l,remove(){t.handlesGroup(s).remove()}}}function S(e,l,c,m){const{view:E,graphic:b}=e,S=new g.ExtendedLineVisualElement({view:E,extensionType:h.settings.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:w.RenderOccludedFlag.OccludeAndTransparent});h.settings.visualElements.zVerticalLine.apply(S);const V=new v.LaserlineVisualElement({view:E,intersectsLineInfinite:!0,attached:!1});h.settings.visualElements.pointGraphics.shadowStyle.apply(V);const P=n.deg2rad(h.settings.visualElements.heightPlaneAngleCutoff),x=new v.LaserlineVisualElement({view:E,attached:!1,angleCutoff:P});h.settings.visualElements.heightPlane.apply(x);const L=p.getGraphicEffectiveElevationInfo(e.graphic),H=y.ElevationContext.fromElevationInfo(L),T="on-the-ground"===L.mode||!L.offset&&"absolute-height"!==L.mode,C=new d.ManipulatorState;let R=1,I=1;const U=()=>{C.update(e);const t=G(b),n=T&&(l.isDraped||a.isNone(t)||!t.hasZ);let i=!0;if(!n&&a.isSome(t)){const e=f.evaluateElevationAlignmentAtPoint(t,E.elevationProvider,H,E.renderCoordsHelper);s.set(M,t.x,t.y,e),o.projectVectorToVector(M,t.spatialReference,M,E.renderCoordsHelper.spatialReference),S.setStartEndFromWorldDownAtLocation(M),V.intersectsWorldUpAtLocation=M}else i=!1;const c=C.grabbingState&u.GrabbingState.Z?h.settings.visualElements.laserlineAlphaMultiplier:1;c!==R&&(R=c,h.settings.visualElements.heightPlane.apply(x,c));const p=r.empty(A);!n&&l.displaying&&m.calculateMapBounds(p)&&o.projectVectorToVector(r.getMin(p,M),E.spatialReference,M,E.renderCoordsHelper.spatialReference)?(x.heightManifoldTarget=M,x.attached=!0):x.attached=!1;const d=C.grabbingState&u.GrabbingState.XY?h.settings.visualElements.laserlineAlphaMultiplier:1;d!==I&&(I=d,h.settings.visualElements.pointGraphics.shadowStyle.apply(V,d));const g=i&&l.displaying&&!n;V.attached=g,S.attached=g};c.push(i.watch((()=>[l.displaying,l.isDraped]),U),l.on("changed",U)),e.forEachManipulator((e=>{c.push(e.events.on("grab-changed",U))})),c.push(t.destroyHandle(V)),c.push(t.destroyHandle(S)),c.push(t.destroyHandle(x)),U()}function V(e,n,a){const{view:i,graphic:s}=e,l=new m.PointVisualElement({view:i,geometry:G(s),elevationInfo:p.getGraphicEffectiveElevationInfo(s),attached:!1});return P(e,l,n,a),a.push(t.destroyHandle(l)),l}function G(e){const t=e.geometry;return a.isNone(t)?null:"point"===t.type?t:"mesh"===t.type?t.anchor.clone():null}function P(e,t,n,a){const s=()=>t.attached=n.displaying;x(e,t,n,a),h.settings.visualElements.pointGraphics.outline.apply(t),a.push(i.watch((()=>n.displaying),s,i.initial))}function x(e,n,i,s){const{view:l,graphic:o}=e;let r=null;const c=e=>{a.isSome(r)&&(r.remove(),r=null),i.isDraped&&a.isSome(e)&&(r=L(l,e,(()=>{n.geometry=e})))},p=()=>{const e=G(o);c(e),n.geometry=e};s.push(i.on("changed",p),t.refHandle((()=>r))),p()}function L(e,t,n){const a=e.elevationProvider.spatialReference;o.projectPointToVector(t,M,a);const i=M[0],s=M[1];return e.elevationProvider.on("elevation-change",(e=>{c.containsXY(e.extent,i,s)&&n()}))}const M=l.create(),A=r.create();e.createVisualElements=b,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
