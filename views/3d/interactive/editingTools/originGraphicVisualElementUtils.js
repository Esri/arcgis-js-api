/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../../core/handleUtils","../../../../core/mathUtils","../../../../core/maybe","../../../../core/watchUtils","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/projection","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../support/elevationInfoUtils","./ManipulatorState","./settings","../visualElements/ExtendedLineVisualElement","../visualElements/LaserlineVisualElement","../visualElements/PointVisualElement","../../layers/graphics/elevationAlignmentUtils","../../layers/graphics/ElevationContext","../../layers/graphics/GraphicState"],(function(e,t,n,i,a,s,o,l,r,c,p,u,d,h,g,v,m,f,y){"use strict";function E(e){const{view:n,graphic:i}=e,a=new y.GraphicState({graphic:i}),s=[],o=V(e,a,s);return w(e,a,s,o),s.push(n.trackGraphicState(a)),{visualElement:o,remove(){t.handlesGroup(s).remove()}}}function w(e,a,o,c){const{view:v,graphic:y}=e,E=new h.ExtendedLineVisualElement({view:v,extensionType:d.settings.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:4});d.settings.visualElements.zVerticalLine.apply(E);const w=new g.LaserlineVisualElement({view:v,intersectsLineInfinite:!0,attached:!1});d.settings.visualElements.pointGraphics.shadowStyle.apply(w);const V=n.deg2rad(d.settings.visualElements.heightPlaneAngleCutoff),P=new g.LaserlineVisualElement({view:v,attached:!1,angleCutoff:V});d.settings.visualElements.heightPlane.apply(P);const x=p.getGraphicEffectiveElevationInfo(e.graphic),L=f.ElevationContext.fromElevationInfo(x),M="on-the-ground"===x.mode||!x.offset&&"absolute-height"!==x.mode,A=new u.ManipulatorState;let H=1,C=1;const I=()=>{A.update(e);const t=S(y),n=M&&(a.isDraped||i.isNone(t)||!t.hasZ);let o=!0;if(!n&&i.isSome(t)){const e=m.evaluateElevationAlignmentAtPoint(t,v.elevationProvider,L,v.renderCoordsHelper);s.set(b,t.x,t.y,e),l.projectVectorToVector(b,t.spatialReference,b,v.renderCoordsHelper.spatialReference),E.setStartEndFromWorldDownAtLocation(b),w.intersectsWorldUpAtLocation=b}else o=!1;const p=2&A.grabbingState?d.settings.visualElements.laserlineAlphaMultiplier:1;p!==H&&(H=p,d.settings.visualElements.heightPlane.apply(P,p));const u=r.empty(G);!n&&a.displaying&&c.calculateMapBounds(u)&&l.projectVectorToVector(r.getMin(u,b),v.spatialReference,b,v.renderCoordsHelper.spatialReference)?(P.heightManifoldTarget=b,P.attached=!0):P.attached=!1;const h=4&A.grabbingState?d.settings.visualElements.laserlineAlphaMultiplier:1;h!==C&&(C=h,d.settings.visualElements.pointGraphics.shadowStyle.apply(w,h));const g=o&&a.displaying&&!n;w.attached=g,E.attached=g};o.push(a.watch(["displaying","isDraped"],I),a.on("changed",I)),e.forEachManipulator((e=>{o.push(e.events.on("grab-changed",I))})),o.push(t.destroyHandle(w)),o.push(t.destroyHandle(E)),o.push(t.destroyHandle(P)),I()}function V(e,n,i){const{view:a,graphic:s}=e,o=new v.PointVisualElement({view:a,geometry:S(s),elevationInfo:p.getGraphicEffectiveElevationInfo(s),attached:!1});return P(e,o,n,i),i.push(t.destroyHandle(o)),o}function S(e){const t=e.geometry;return i.isNone(t)?null:"point"===t.type?t:"mesh"===t.type?t.anchor.clone():null}function P(e,t,n,i){const s=()=>t.attached=n.displaying;x(e,t,n,i),d.settings.visualElements.pointGraphics.outline.apply(t),i.push(a.init(n,"displaying",s))}function x(e,n,a,s){const{view:o,graphic:l}=e;let r=null;const c=e=>{i.isSome(r)&&(r.remove(),r=null),a.isDraped&&i.isSome(e)&&(r=L(o,e,(()=>{n.geometry=e})))},p=()=>{const e=S(l);c(e),n.geometry=e};s.push(a.on("changed",p),t.refHandle((()=>r))),p()}function L(e,t,n){const i=e.elevationProvider.spatialReference;l.projectPointToVector(t,b,i);const a=b[0],s=b[1];return e.elevationProvider.on("elevation-change",(e=>{c.containsXY(e.extent,a,s)&&n()}))}const b=o.create(),G=r.create();e.createVisualElements=E,Object.defineProperty(e,"__esModule",{value:!0})}));
