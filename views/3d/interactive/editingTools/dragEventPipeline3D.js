/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../core/maybe","../../../../core/mathUtils","../../../../core/screenUtils","../../../../chunks/vec3f64","../../../../chunks/vec3","../../../../geometry/projection","../../../../support/elevationInfoUtils","../../support/stack","../../support/geometryUtils","../../webgl-engine/lib/intersectorUtils","../../webgl-engine/lib/Intersector","../../../interactive/dragEventPipeline"],(function(e,n,r,t,o,c,s,a,i,l,u,d,p){"use strict";function m(e,r){const c=o.create(),s=o.create();let a=!1;return o=>{if("start"===o.action){const s=t.screenPointObjectToArray(o.screenStart,t.castScreenPointArray(i.sv2d.get())),u=l.ray.fromScreen(e.state.camera,s,R);n.isSome(u)&&(a=l.plane.intersectRay(r,u,c))}if(!a)return null;const u=t.screenPointObjectToArray(o.screenEnd,t.castScreenPointArray(i.sv2d.get())),d=l.ray.fromScreen(e.state.camera,u,R);return n.isNone(d)?null:l.plane.intersectRay(r,d,s)?{...o,renderStart:c,renderEnd:s,plane:r,ray:d}:null}}function f(e,r,o,c=null,a=null){let i=null;return l=>{if("start"===l.action&&(i=e.sceneIntersectionHelper.intersectElevationFromScreen(t.createScreenPointArray(l.screenStart.x,l.screenStart.y),r,o,a),n.isSome(i)&&n.isSome(c)&&!s.projectPoint(i,i,c)))return null;if(n.isNone(i))return null;const u=e.sceneIntersectionHelper.intersectElevationFromScreen(t.createScreenPointArray(l.screenEnd.x,l.screenEnd.y),r,o,a);return n.isSome(u)?n.isSome(c)&&!s.projectPoint(u,u,c)?null:{...l,mapStart:i,mapEnd:u}:null}}function S(e,n,r,t=null,o=null){return f(e,r,a.getZForElevationMode(n,e,r),t,o)}function y(e,n,r,t=null,o=null){return S(e,r,a.getGraphicEffectiveElevationInfo(n),t,o)}function g(e,r,t,o){const c=r.toMap(e.screenStart,{include:[t]});return n.isSome(c)?y(r,t,c,o):null}function E(e,n){const r=I,t=x,o=l.plane.create();e.renderCoordsHelper.worldUpAtPosition(n,r);const s=c.cross(o,r,c.subtract(t,n,e.state.camera.eye));return c.cross(s,s,r),l.plane.fromPositionAndNormal(n,s,o)}function P(e,n,r){let t=null;const o=new p.EventPipeline;return o.next(m(e,E(e,n))).next(v(e,n)).next(b(e,r)).next((e=>{e.mapEnd.x=e.mapStart.x,e.mapEnd.y=e.mapStart.y,t=e})),e=>(t=null,o.execute(e),t)}function v(e,n){const t=o.create(),s=c.length(n);e.renderCoordsHelper.worldUpAtPosition(n,t);const a=o.create(),i=o.create(),u=o=>{if(c.subtract(o,o,n),l.vector.projectPoint(t,o,o),"global"===e.viewingMode){c.length(o)*r.sign(c.dot(t,o))<.001-s&&c.subtract(o,c.scale(o,t,.001),n)}return c.add(o,o,n),o};return e=>(e.renderStart=u(c.copy(a,e.renderStart)),e.renderEnd=u(c.copy(i,e.renderEnd)),e)}function b(e,r){const t=e.renderCoordsHelper;return e=>{const o=t.fromRenderCoords(e.renderStart,r),c=t.fromRenderCoords(e.renderEnd,r);return n.isSome(o)&&n.isSome(c)?{...e,mapStart:o,mapEnd:c}:null}}function T(e){let r=null;return t=>{switch(t.action){case"start":r=e.disableDisplay();break;case"end":case"cancel":n.isSome(r)&&(r.remove(),r=null)}return t}}function A(e,r=null){const c=new d.Intersector(e.state.mode);c.options.selectionMode=!0,c.options.store=0;const s=t.createScreenPointArray(),a={requiresGroundFeedback:!0,enableDraped:!0,exclude:new Set},i=o.create(),l=n.unwrapOr(r,e.spatialReference),p=n=>{e.map.ground&&e.map.ground.opacity<1?a.exclude.add(u.TERRAIN_ID):a.exclude.delete(u.TERRAIN_ID),e.sceneIntersectionHelper.intersectIntersectorScreen(t.screenPointObjectToArray(n,s),c,a);const r=c.results.min;let o;if(r.getIntersectionPoint(i))o="TerrainRenderer"===r.intersector?0:1;else{if(!c.results.ground.getIntersectionPoint(i))return null;o=0}return{location:e.renderCoordsHelper.fromRenderCoords(i,l),surfaceType:o}};let m;return e=>{if("start"===e.action){const r=p(e.screenStart);m=n.isSome(r)?r.location:null}if(n.isNone(m))return null;const r=p(e.screenEnd);return n.isSome(r)&&n.isSome(r.location)?{...e,mapStart:m,mapEnd:r.location,surfaceType:r.surfaceType}:null}}const I=o.create(),x=o.create(),R=l.ray.create();e.convertToMapCoordinates=b,e.hideManipulatorWhileDragging=T,e.projectToWorldUp=v,e.screenToMap3D=A,e.screenToMapXYAtLocation=S,e.screenToMapXYForGraphic=g,e.screenToMapXYForGraphicAtLocation=y,e.screenToRenderPlane=m,e.screenToZConstrained=P,Object.defineProperty(e,"__esModule",{value:!0})}));
