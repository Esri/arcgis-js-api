/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../../core/mathUtils","../../../../core/maybe","../../../../core/screenUtils","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/projection","../../../../geometry/support/plane","../../../../geometry/support/ray","../../../../geometry/support/vector","../../../../geometry/support/vectorStacks","../../../../support/elevationInfoUtils","../../support/geometryUtils/ray","../../webgl-engine/lib/Intersector","../../webgl-engine/lib/verticalOffsetUtils","../../../interactive/dragEventPipeline"],(function(e,r,n,t,o,c,s,a,i,l,u,d,p,m,f,S){"use strict";function y(e,r){return E(e,(()=>r))}function g(e){return E(e,(e=>e.plane))}function E(e,r){const o=c.create(),s=c.create();let i=!1;return c=>{const l=r(c);if("start"===c.action){const r=t.screenPointObjectToArray(c.screenStart,t.castScreenPointArray(u.sv2d.get())),s=p.fromScreen(e.state.camera,r,C);n.isSome(s)&&(i=a.intersectRay(l,s,o))}if(!i)return null;const d=t.screenPointObjectToArray(c.screenEnd,t.castScreenPointArray(u.sv2d.get())),m=p.fromScreen(e.state.camera,d,C);return n.isNone(m)?null:a.intersectRay(l,m,s)?{...c,renderStart:o,renderEnd:s,plane:l,ray:m}:null}}function v(e,r,o,c=null,a=null){let i=null;return l=>{if("start"===l.action&&(i=e.sceneIntersectionHelper.intersectElevationFromScreen(t.createScreenPointArray(l.screenStart.x,l.screenStart.y),r,o,a),n.isSome(i)&&n.isSome(c)&&!s.projectPoint(i,i,c)))return null;if(n.isNone(i))return null;const u=e.sceneIntersectionHelper.intersectElevationFromScreen(t.createScreenPointArray(l.screenEnd.x,l.screenEnd.y),r,o,a);return n.isSome(u)?n.isSome(c)&&!s.projectPoint(u,u,c)?null:{...l,mapStart:i,mapEnd:u}:null}}function P(e,r,n,t=null,o=null){return v(e,n,d.getZForElevationMode(r,e,n),t,o)}function T(e,r,n,t=null,o=null){return P(e,n,d.getGraphicEffectiveElevationInfo(r),t,o)}function b(e,r,t,o){const c=r.toMap(e.screenStart,{include:[t]});return n.isSome(c)?T(r,t,c,o):null}function A(e,r){const n=w,t=j,c=a.create();e.renderCoordsHelper.worldUpAtPosition(r,n);const s=o.cross(c,n,o.subtract(t,r,e.state.camera.eye));return o.cross(s,s,n),a.fromPositionAndNormal(r,s,c)}function I(e,r,n){let t=null;const o=new S.EventPipeline;return o.next(y(e,A(e,r))).next(x(e,r)).next(R(e,n)).next((e=>{e.mapEnd.x=e.mapStart.x,e.mapEnd.y=e.mapStart.y,t=e})),e=>(t=null,o.execute(e),t)}function x(e,n){const t=c.create(),s=o.length(n);e.renderCoordsHelper.worldUpAtPosition(n,t);const a=c.create(),i=c.create(),u=c=>{if(o.subtract(c,c,n),l.projectPoint(t,c,c),"global"===e.viewingMode){o.length(c)*r.sign(o.dot(t,c))<.001-s&&o.subtract(c,o.scale(c,t,.001),n)}return o.add(c,c,n),c};return e=>(e.renderStart=u(o.copy(a,e.renderStart)),e.renderEnd=u(o.copy(i,e.renderEnd)),e)}function R(e,r){const t=e.renderCoordsHelper;return e=>{const o=t.fromRenderCoords(e.renderStart,r),c=t.fromRenderCoords(e.renderEnd,r);return n.isSome(o)&&n.isSome(c)?{...e,mapStart:o,mapEnd:c}:null}}function h(e){let r=null;return t=>{switch(t.action){case"start":r=e.disableDisplay();break;case"end":case"cancel":n.isSome(r)&&(r.remove(),r=null)}return t}}function M(e,r=null){const o=new m.Intersector(e.state.viewingMode);o.options.selectionMode=!0,o.options.store=0,o.options.hud=!1;const s=t.createScreenPointArray(),a={requiresGroundFeedback:!0,enableDraped:!0,exclude:new Set},i=c.create(),l=n.unwrapOr(r,e.spatialReference),u=r=>{e.map.ground&&e.map.ground.opacity<1?a.exclude.add(f.TERRAIN_ID):a.exclude.delete(f.TERRAIN_ID),e.sceneIntersectionHelper.intersectIntersectorScreen(t.screenPointObjectToArray(r,s),o,a);const n=o.results.min;let c;if(n.getIntersectionPoint(i))c="TerrainRenderer"===n.intersector?0:1;else{if(!o.results.ground.getIntersectionPoint(i))return null;c=0}return{location:e.renderCoordsHelper.fromRenderCoords(i,l),surfaceType:c}};let d;return e=>{if("start"===e.action){const r=u(e.screenStart);d=n.isSome(r)?r.location:null}if(n.isNone(d))return null;const r=u(e.screenEnd);return n.isSome(r)&&n.isSome(r.location)?{...e,mapStart:d,mapEnd:r.location,surfaceType:r.surfaceType}:null}}const w=c.create(),j=c.create(),C=i.create();e.convertToMapCoordinates=R,e.hideManipulatorWhileDragging=h,e.projectToWorldUp=x,e.screenToMap3D=M,e.screenToMapXYAtLocation=P,e.screenToMapXYForGraphic=b,e.screenToMapXYForGraphicAtLocation=T,e.screenToRenderPlane=y,e.screenToRenderPlaneFromEvent=g,e.screenToZConstrained=I,Object.defineProperty(e,"__esModule",{value:!0})}));
