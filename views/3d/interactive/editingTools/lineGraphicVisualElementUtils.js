/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../../core/handleUtils","../../../../core/mathUtils","../../../../core/maybe","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../support/elevationInfoUtils","../Manipulator3D","./ManipulatorState","./settings","../visualElements/ExtendedLineVisualElement","../visualElements/LaserlineVisualElement","../visualElements/OutlineVisualElement","../../layers/graphics/GraphicState"],(function(e,t,n,a,i,l,s,o,r,c,d,u,h,p){"use strict";function g(e){const{view:n,graphic:a}=e,i=new p.GraphicState({graphic:a}),l=m(e,i),s=[l,v(e,l.visualElement,i),n.maskOccludee(a),n.trackGraphicState(i)];return{visualElement:l.visualElement,remove:()=>t.handlesGroup(s).remove()}}function m(e,n){const{view:a,graphic:i}=e,l=new h.OutlineVisualElement({view:a,geometry:f(i)?i.geometry:null,elevationInfo:s.getGraphicEffectiveElevationInfo(i),attached:!1});c.settings.visualElements.lineGraphics.shadowStyle.apply(l);const o=()=>{l.attached=n.displaying};c.settings.visualElements.lineGraphics.outline.apply(l);const r=[n.watch("displaying",o),n.watch("isDraped",(e=>l.isDraped=e)),n.on("changed",(()=>l.geometry=f(i)?i.geometry:null)),t.destroyHandle(l)];return o(),{visualElement:l,remove:()=>t.handlesGroup(r).remove()}}function v(e,a,i){const{graphic:l,view:o}=e,h=[],p=s.getGraphicEffectiveElevationInfo(l),g="on-the-ground"===p.mode||!p.offset&&"absolute-height"!==p.mode,m=new r.ManipulatorState,v=new d.ExtendedLineVisualElement({view:o,extensionType:c.settings.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:4});c.settings.visualElements.pointGraphics.shadowStyle.apply(v);const w=n.deg2rad(c.settings.visualElements.heightPlaneAngleCutoff),S=new u.LaserlineVisualElement({view:o,attached:!1,angleCutoff:w});c.settings.visualElements.heightPlane.apply(S);let G=1,b=1;const M=()=>{if(m.update(e),!i.displaying||g&&(i.isDraped||!f(l)||!l.geometry.hasZ))return a.laserlineEnabled=!1,v.attached=!1,void(S.attached=!1);a.laserlineEnabled=!0;{const e=4&m.grabbingState?c.settings.visualElements.laserlineAlphaMultiplier:1;e!==G&&(G=e,c.settings.visualElements.lineGraphics.shadowStyle.apply(a,e),c.settings.visualElements.pointGraphics.shadowStyle.apply(v,e))}{const e=2&m.grabbingState?c.settings.visualElements.laserlineAlphaMultiplier:1;e!==b&&(b=e,c.settings.visualElements.heightPlane.apply(S,e))}E(v,m),y(e,a,S,m)};c.settings.visualElements.zVerticalLine.apply(v),h.push(i.on("changed",M),i.watch("displaying",M),a.events.on("attachment-origin-changed",M),t.destroyHandle(v),t.destroyHandle(S));const V=[],L=()=>{t.handlesGroup(V).remove(),V.length=0,e.forEachManipulator((e=>V.push(e.events.on("grab-changed",M)))),e.forEachManipulator((e=>V.push(e.events.on("select-changed",M)))),M()};return L(),h.push(e.onManipulatorsChanged(L),t.refHandle((()=>t.handlesGroup(V)))),t.handlesGroup(h)}function E(e,t){const n=1===t.numSelected?t.firstSelected:t.numSelected>1&&a.isSome(t.firstGrabbedXY)?t.firstGrabbedXY:null;a.isSome(n)?(e.setStartEndFromWorldDownAtLocation(n.renderLocation),e.attached=!0):e.attached=!1}function y(e,t,n,l){if(l.numSelected>0){i.set(w,0,0,0);let t=0;e.forEachManipulator(((e,n)=>{1===n&&e.selected&&e instanceof o.Manipulator3D&&(i.add(w,w,e.renderLocation),t++)})),t>0?(n.heightManifoldTarget=i.scale(w,w,1/t),n.attached=!0):n.attached=!1}else{const i=t.attachmentOrigin;a.isSome(i)&&e.view.renderCoordsHelper.toRenderCoords(i,w)?(n.heightManifoldTarget=w,n.attached=!0):n.attached=!1}}function f(e){return a.isSome(e.geometry)&&("polygon"===e.geometry.type||"polyline"===e.geometry.type)}const w=l.create();e.createGeometryRepresentationVisualElement=m,e.createVisualElements=g,Object.defineProperty(e,"__esModule",{value:!0})}));
