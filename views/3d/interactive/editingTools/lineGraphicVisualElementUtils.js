/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../core/maybe","../../../../core/handleUtils","../../../../core/mathUtils","../../../../chunks/vec3f64","../../../../chunks/vec3","../../../../support/elevationInfoUtils","../visualElements/LaserlineVisualElement","../visualElements/ExtendedLineVisualElement","../Manipulator3D","./settings","../visualElements/OutlineVisualElement","../../layers/graphics/GraphicState","./ManipulatorState"],(function(e,t,n,a,i,l,s,o,r,c,d,u,h,p){"use strict";function g(e){const{view:t,graphic:a}=e,i=new h.GraphicState({graphic:a}),l=m(e,i),s=[l,v(e,l.visualElement,i),t.maskOccludee(a),t.trackGraphicState(i)];return{visualElement:l.visualElement,remove:()=>n.handlesGroup(s).remove()}}function m(e,t){const{view:a,graphic:i}=e,l=new u.OutlineVisualElement({view:a,geometry:f(i)?i.geometry:null,elevationInfo:s.getGraphicEffectiveElevationInfo(i),attached:!1});d.settings.visualElements.lineGraphics.shadowStyle.apply(l);const o=()=>{l.attached=t.displaying};d.settings.visualElements.lineGraphics.outline.apply(l);const r=[t.watch("displaying",o),t.watch("isDraped",(e=>l.isDraped=e)),t.on("changed",(()=>l.geometry=f(i)?i.geometry:null)),n.destroyHandle(l)];return o(),{visualElement:l,remove:()=>n.handlesGroup(r).remove()}}function v(e,t,i){const{graphic:l,view:c}=e,u=[],h=s.getGraphicEffectiveElevationInfo(l),g="on-the-ground"===h.mode||!h.offset&&"absolute-height"!==h.mode,m=new p.ManipulatorState,v=new r.ExtendedLineVisualElement({view:c,extensionType:d.settings.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:4});d.settings.visualElements.pointGraphics.shadowStyle.apply(v);const w=a.deg2rad(d.settings.visualElements.heightPlaneAngleCutoff),S=new o.LaserlineVisualElement({view:c,attached:!1,angleCutoff:w});d.settings.visualElements.heightPlane.apply(S);let G=1,b=1;const M=()=>{if(m.update(e),!i.displaying||g&&(i.isDraped||!f(l)||!l.geometry.hasZ))return t.laserlineEnabled=!1,v.attached=!1,void(S.attached=!1);t.laserlineEnabled=!0;{const e=4&m.grabbingState?d.settings.visualElements.laserlineAlphaMultiplier:1;e!==G&&(G=e,d.settings.visualElements.lineGraphics.shadowStyle.apply(t,e),d.settings.visualElements.pointGraphics.shadowStyle.apply(v,e))}{const e=2&m.grabbingState?d.settings.visualElements.laserlineAlphaMultiplier:1;e!==b&&(b=e,d.settings.visualElements.heightPlane.apply(S,e))}E(v,m),y(e,t,S,m)};d.settings.visualElements.zVerticalLine.apply(v),u.push(i.on("changed",M),i.watch("displaying",M),t.events.on("attachment-origin-changed",M),n.destroyHandle(v),n.destroyHandle(S));const V=[],L=()=>{n.handlesGroup(V).remove(),V.length=0,e.forEachManipulator((e=>V.push(e.events.on("grab-changed",M)))),e.forEachManipulator((e=>V.push(e.events.on("select-changed",M)))),M()};return L(),u.push(e.onManipulatorsChanged(L),n.refHandle((()=>n.handlesGroup(V)))),n.handlesGroup(u)}function E(e,n){const a=1===n.numSelected?n.firstSelected:n.numSelected>1&&t.isSome(n.firstGrabbedXY)?n.firstGrabbedXY:null;t.isSome(a)?(e.setStartEndFromWorldDownAtLocation(a.renderLocation),e.attached=!0):e.attached=!1}function y(e,n,a,i){if(i.numSelected>0){l.set(w,0,0,0);let t=0;e.forEachManipulator(((e,n)=>{1===n&&e.selected&&e instanceof c.Manipulator3D&&(l.add(w,w,e.renderLocation),t++)})),t>0?(a.heightManifoldTarget=l.scale(w,w,1/t),a.attached=!0):a.attached=!1}else{const i=n.attachmentOrigin;t.isSome(i)&&e.view.renderCoordsHelper.toRenderCoords(i,w)?(a.heightManifoldTarget=w,a.attached=!0):a.attached=!1}}function f(e){return t.isSome(e.geometry)&&("polygon"===e.geometry.type||"polyline"===e.geometry.type)}const w=i.create();e.createGeometryRepresentationVisualElement=m,e.createVisualElements=g,Object.defineProperty(e,"__esModule",{value:!0})}));
