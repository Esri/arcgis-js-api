/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../core/handleUtils","../../../../core/mathUtils","../../../../core/maybe","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../support/elevationInfoUtils","../Manipulator3D","./GrabbingState","./ManipulatorState","./ManipulatorType","./settings","../visualElements/ExtendedLineVisualElement","../visualElements/LaserlineVisualElement","../visualElements/OutlineVisualElement","../../layers/graphics/GraphicState","../../webgl-engine/lib/Material"],(function(e,t,n,a,i,l,s,r,o,c,d,u,p,h,g,m,v){"use strict";function E(e){const{view:n,graphic:a}=e,i=new m.GraphicState({graphic:a}),l=y(e,i),s=[l,f(e,l.visualElement,i),n.maskOccludee(a),n.trackGraphicState(i)];return{visualElement:l.visualElement,remove:()=>t.handlesGroup(s).remove()}}function y(e,n){const{view:a,graphic:i}=e,l=new g.OutlineVisualElement({view:a,geometry:w(i)?i.geometry:null,elevationInfo:s.getGraphicEffectiveElevationInfo(i),attached:!1});u.settings.visualElements.lineGraphics.shadowStyle.apply(l);const r=()=>{l.attached=n.displaying};u.settings.visualElements.lineGraphics.outline.apply(l);const o=[n.watch("displaying",r),n.watch("isDraped",(e=>l.isDraped=e)),n.on("changed",(()=>l.geometry=w(i)?i.geometry:null)),t.destroyHandle(l)];return r(),{visualElement:l,remove:()=>t.handlesGroup(o).remove()}}function f(e,a,i){const{graphic:l,view:r}=e,d=[],g=s.getGraphicEffectiveElevationInfo(l),m="on-the-ground"===g.mode||!g.offset&&"absolute-height"!==g.mode,E=new c.ManipulatorState,y=new p.ExtendedLineVisualElement({view:r,extensionType:u.settings.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:v.RenderOccludedFlag.OccludeAndTransparent});u.settings.visualElements.pointGraphics.shadowStyle.apply(y);const f=n.deg2rad(u.settings.visualElements.heightPlaneAngleCutoff),G=new h.LaserlineVisualElement({view:r,attached:!1,angleCutoff:f});u.settings.visualElements.heightPlane.apply(G);let M=1,L=1;const T=()=>{if(E.update(e),!i.displaying||m&&(i.isDraped||!w(l)||!l.geometry.hasZ))return a.laserlineEnabled=!1,y.attached=!1,void(G.attached=!1);a.laserlineEnabled=!0;{const e=E.grabbingState&o.GrabbingState.XY?u.settings.visualElements.laserlineAlphaMultiplier:1;e!==M&&(M=e,u.settings.visualElements.lineGraphics.shadowStyle.apply(a,e),u.settings.visualElements.pointGraphics.shadowStyle.apply(y,e))}{const e=E.grabbingState&o.GrabbingState.Z?u.settings.visualElements.laserlineAlphaMultiplier:1;e!==L&&(L=e,u.settings.visualElements.heightPlane.apply(G,e))}S(y,E),b(e,a,G,E)};u.settings.visualElements.zVerticalLine.apply(y),d.push(i.on("changed",T),i.watch("displaying",T),a.events.on("attachment-origin-changed",T),t.destroyHandle(y),t.destroyHandle(G));const V=[],O=()=>{t.handlesGroup(V).remove(),V.length=0,e.forEachManipulator((e=>V.push(e.events.on("grab-changed",T)))),e.forEachManipulator((e=>V.push(e.events.on("select-changed",T)))),T()};return O(),d.push(e.onManipulatorsChanged(O),t.refHandle((()=>t.handlesGroup(V)))),t.handlesGroup(d)}function S(e,t){const n=1===t.numSelected?t.firstSelected:t.numSelected>1&&a.isSome(t.firstGrabbedXY)?t.firstGrabbedXY:null;a.isSome(n)?(e.setStartEndFromWorldDownAtLocation(n.renderLocation),e.attached=!0):e.attached=!1}function b(e,t,n,l){if(l.numSelected>0){i.set(G,0,0,0);let t=0;e.forEachManipulator(((e,n)=>{n===d.ManipulatorType.TRANSLATE_XY&&e.selected&&e instanceof r.Manipulator3D&&(i.add(G,G,e.renderLocation),t++)})),t>0?(n.heightManifoldTarget=i.scale(G,G,1/t),n.attached=!0):n.attached=!1}else{const i=t.attachmentOrigin;a.isSome(i)&&e.view.renderCoordsHelper.toRenderCoords(i,G)?(n.heightManifoldTarget=G,n.attached=!0):n.attached=!1}}function w(e){return a.isSome(e.geometry)&&("polygon"===e.geometry.type||"polyline"===e.geometry.type)}const G=l.create();e.createGeometryRepresentationVisualElement=y,e.createVisualElements=E,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
