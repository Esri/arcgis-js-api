// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../../geometry","../../../../../core/Evented","../../../../../core/Handles","../../../../../core/maybe","../../../../../core/screenUtils","../../../../../core/accessorSupport/decorators","../coordinateHelper","./DrawManipulator","./drawSurfaces","../editGeometry/EditGeometryHelper","../../../../interactive/dragEventPipeline"],(function(e,t,r,n,o,i,a,s,p,c,d,l,u,m){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DrawOperation=void 0;var g=function(e){function t(t){var n=e.call(this)||this;n._manipulator=null,n._stagedVertex=null,n.drawingMode="hybrid",n.geometryType=null,n.elevationInfo=null,n.snappingEnabled=null,n._handles=new i,n._defaultZ=0,n._elevationDrawSurface=null,n._snappingDrawSurface=null,n._createOperationCompleted=!1,n.view=t.view,n.drawingMode=t.drawingMode,n.geometryType=t.geometryType,n.elevationInfo=t.elevationInfo,n.coordinateHelper=c.createCoordinateHelper(t.hasZ,t.hasM,n.view.spatialReference,n.view.viewingMode),n._defaultZ=t.defaultZ,n.snappingEnabled=t.snappingEnabled,n._snappingDrawSurface=a.unwrap(t.snappingDrawSurface),n._elevationDrawSurface=new l.ElevationDrawSurface(n.elevationInfo,n._defaultZ,n.view),n._editGeometry=new u.EditGeometryHelper(new u.EditGeometry(n.coordinateHelper),"segment"===n.geometryType?"polyline":n.geometryType),n._activeComponent=new u.Component(n._editGeometry.data),n._editGeometry.data.components.push(n._activeComponent),n._editGeometry.on(["vertex-add","vertex-update","vertex-remove"],(function(e){var t=e.vertices.map((function(e){return{componentIndex:0,vertexIndex:e.index,coordinates:n.coordinateHelper.toArray(e.pos)}})),o=t.map((function(e){return e.coordinates}));switch(e.type){case"vertex-add":n.emit(e.type,r.__assign(r.__assign({},e),{added:o,vertices:t}));break;case"vertex-update":n.emit(e.type,r.__assign(r.__assign({},e),{updated:o,vertices:t}));break;case"vertex-remove":n.emit(e.type,r.__assign(r.__assign({},e),{removed:o,vertices:t}))}})),n._manipulator=new d.DrawManipulator,t.manipulators.add(n._manipulator),n._manipulator.grabbable="point"!==n.geometryType;var o=m.createManipulatorDragEventPipeline(n._manipulator,(function(e,t,r,o){"click"!==n.drawingMode&&(n.isCompleted||(t.next(n._screenToMapDragEventStep()).next((function(e){return"start"===e.action&&(n.stagedVertex=e.mapStart,"segment"!==n.geometryType&&"hybrid"!==n.drawingMode||n.commitStagedVertex()),e})).next((function(e){switch(e.action){case"start":case"update":switch(n.drawingMode){case"freehand":case"hybrid":n.stagedVertex=e.mapEnd,"polygon"!==n.geometryType&&"polyline"!==n.geometryType||n.commitStagedVertex()}break;case"end":"freehand"!==n.drawingMode&&"segment"!==n.geometryType&&"point"!==n.geometryType||n.complete()}return e})),r.next((function(e){}))))})),s=n._manipulator.events.on("immediate-double-click",(function(e){n.complete(),e.stopPropagation()})),p=n._manipulator.events.on("immediate-click",(function(e){var t=n._activeComponent,r=n._closeOnClickVertexIndex(e.screenPoint);if(a.isSome(r))n.discardStagedVertex(),n.complete();else{var o=n._screenToMap(e.screenPoint);if(a.isSome(o))switch(n.drawingMode){case"freehand":break;case"click":case"hybrid":n.discardStagedVertex(),n._editGeometry.appendVertex(n.coordinateHelper.fromPoint(o)),("point"===n.geometryType||"segment"===n.geometryType&&2===t.vertices.length||"segment"===n.geometryType&&"hybrid"===n.drawingMode&&1===t.vertices.length)&&n.complete()}}e.stopPropagation()}));return n._handles.add([o,p,s]),n}return r.__extends(t,e),Object.defineProperty(t.prototype,"isCompleted",{get:function(){return this._createOperationCompleted},enumerable:!1,configurable:!0}),t.prototype.destroy=function(){this._handles.destroy(),this._handles=null},t.prototype.onInputEvent=function(e){if(!(this._manipulator.dragging||this._manipulator.grabbing&&"pointer-move"===e.type))switch(e.type){case"pointer-move":var t=s.createScreenPoint(e.x,e.y),r=this._closeOnClickVertexIndex(t);if(a.isSome(r)){this.discardStagedVertex();var n={componentIndex:0,vertexIndex:r,coordinates:this.coordinateHelper.toArray(this._activeComponent.vertices[r].pos)};this.emit("cursor-update",{updated:null,vertices:[n],operation:"apply",type:"vertex-update"})}else{var o=this._screenToMap(t);a.isSome(o)?(this.stagedVertex=o,this._manipulator.cursor="crosshair"):this._manipulator.cursor=null}e.stopPropagation()}},Object.defineProperty(t.prototype,"canRedo",{get:function(){return this._editGeometry.canRedo},enumerable:!1,configurable:!0}),t.prototype.redo=function(){this._editGeometry.redo()},Object.defineProperty(t.prototype,"canUndo",{get:function(){return this._editGeometry.canUndo},enumerable:!1,configurable:!0}),t.prototype.undo=function(){this._editGeometry.undo()},t.prototype.complete=function(e){void 0===e&&(e=!1),this.commitStagedVertex(),this._createOperationCompleted=!0,this.emit("complete",{vertices:this.vertices.map((function(e,t){return{componentIndex:0,vertexIndex:t,coordinates:e}})),aborted:e,type:"complete"})},t.prototype.cancel=function(){this.complete(!0)},Object.defineProperty(t.prototype,"interactive",{get:function(){return this._manipulator.interactive},set:function(e){this._manipulator.interactive=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"numVertices",{get:function(){return a.isSome(this._stagedVertex)?this._activeComponent.vertices.length+1:this._activeComponent.vertices.length},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"numCommittedVertices",{get:function(){return this._activeComponent.vertices.length},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"vertices",{get:function(){var e=this,t=this._activeComponent.vertices.map((function(t){return e.coordinateHelper.toArray(t.pos)}));return a.isSome(this._stagedVertex)&&t.push(this.coordinateHelper.pointToArray(this._stagedVertex)),t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"spatialReference",{get:function(){return this.view.spatialReference},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"hasStagedVertex",{get:function(){return a.isSome(this._stagedVertex)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"stagedVertex",{get:function(){return this._stagedVertex},set:function(e){if(a.isNone(e))this.discardStagedVertex();else{this._stagedVertex=e;var t={componentIndex:0,vertexIndex:this._activeComponent.vertices.length,coordinates:this.coordinateHelper.pointToArray(e)};this.emit("cursor-update",{updated:null,vertices:[t],operation:"apply",type:"vertex-update"})}},enumerable:!1,configurable:!0}),t.prototype.commitStagedVertex=function(){if(a.isSome(this._stagedVertex)){var e=this._stagedVertex;this._stagedVertex=null,this._editGeometry.appendVertex(this.coordinateHelper.fromPoint(e))}},t.prototype.discardStagedVertex=function(){this._stagedVertex=null},t.prototype._screenToMapDragEventStep=function(){var e=this,t=null;return function(n){if("start"===n.action&&(t=e._screenToMap(n.screenStart)),a.isNone(t))return null;var o=e._screenToMap(n.screenEnd);return a.isSome(o)?r.__assign(r.__assign({},n),{mapStart:t,mapEnd:o}):null}},t.prototype._screenToMap=function(e){return this._getDrawSurface().screenToMap(e)},t.prototype._mapToScreen=function(e){return this._getDrawSurface().mapToScreen(e)},t.prototype._getDrawSurface=function(){var e=null;if(this.coordinateHelper.hasZ){var t=this._defaultZ,r=!1;a.isSome(this.elevationInfo)&&"absolute-height"===this.elevationInfo.mode&&(r=!0),a.isSome(this.snappingEnabled)&&(r=this.snappingEnabled),a.isSome(this.elevationInfo)&&"on-the-ground"===this.elevationInfo.mode&&(r=!1);var n=this._activeComponent.vertices.length;("segment"===this.geometryType||"polygon"===this.geometryType)&&n>0&&(t=this.coordinateHelper.zFromArray(this._activeComponent.vertices[0].pos),r=!1),r?e=this._snappingDrawSurface:(this._elevationDrawSurface.defaultZ=t,e=this._elevationDrawSurface)}else this._elevationDrawSurface.defaultZ=null,e=this._elevationDrawSurface;return e},t.prototype._vertexWithinPointerDistance=function(e,t){var r,n,o,i,s,p=this._mapToScreen(e);return!!a.isSome(p)&&(n=t,o=25,i=(r=p).x-n.x,s=r.y-n.y,i*i+s*s<=o)},t.prototype._closeOnClickVertexIndex=function(e){var t=this._activeComponent;if("polygon"===this.geometryType&&t.vertices.length>2){if(this._vertexWithinPointerDistance(this.coordinateHelper.toPoint(t.vertices[0].pos,h),e))return 0;if(this._vertexWithinPointerDistance(this.coordinateHelper.toPoint(t.vertices[t.vertices.length-1].pos,h),e))return t.vertices.length-1}return null},t=r.__decorate([p.subclass("esri.views.3d.interactive.editingTools.draw3D.DrawOperation")],t)}(o);t.DrawOperation=g;var h=new n.Point({x:0,y:0,z:0})}));