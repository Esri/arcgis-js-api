/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../core/has","../../../../../core/maybe","../../../../../core/Logger","../../../../../core/accessorSupport/ensureType","../../../../../core/accessorSupport/decorators/property","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/urlUtils","../../../../../core/uuid","../../../../../portal/support/resourceExtension","../../../../../core/Evented","../../../../../Graphic","../../../../../core/watchUtils","../../../../../core/HandleOwner","../../../../../layers/GraphicsLayer","../../../../../support/elevationInfoUtils","./DrawOperation","./drawSurfaces","../../../../interactive/InteractiveToolBase","../../../../draw/support/surfaceCoordinateSystems","../settings","../../visualElements/OutlineVisualElement","../../visualElements/VerticesVisualElement","../../../layers/graphics/GraphicState","../../../../draw/support/createUtils"],(function(e,t,i,r,a,s,n,o,l,c,h,p,u,d,y,m,_,v,w,g,f,V,G,E,S,O,T){"use strict";function C(e){switch(e){case"point":case"polyline":case"polygon":return e;case"circle":case"rectangle":return"segment";default:return null}}e.DrawGraphicTool=function(e){function i(t){var i;return(i=e.call(this,t)||this).drawOperation=null,i._createGraphic=null,i._createGraphicState=null,i._outlineVisualElement=null,i._verticesVisualElement=null,i._stagedVerticesVisualElement=null,i.hasZ=!0,i.defaultZ=0,i.elevationInfo=null,i.snapToScene=!1,i.snappingManager=null,i.mode=null,i.geometryType=null,i.type="draw-3d",i}t._inheritsLoose(i,e);var r=i.prototype;return r.initialize=function(){const e=a.unwrapOr(this.elevationInfo,{mode:this.hasZ?"absolute-height":"on-the-ground",offset:0});this._internalGraphicsLayer=new _({elevationInfo:e,listMode:"hide",internal:!0}),this.view.map.layers.add(this._internalGraphicsLayer),this.drawOperation=new w.DrawOperation({view:this.view,manipulators:this.manipulators,geometryType:C(this.geometryType),drawingMode:this.mode,hasZ:this.hasZ,defaultZ:this.defaultZ,snapToSceneEnabled:this.snapToScene,snappingDrawSurface:new g.SceneDrawSurface(this.view,e,[this._internalGraphicsLayer]),elevationDrawSurface:new g.ElevationDrawSurface(e,this.defaultZ,this.view,this._internalGraphicsLayer),hasM:!1,elevationInfo:e,snappingManager:this.snappingManager}),this.drawOperation.on("vertex-add",(e=>this.onVertexAdd(e))),this.drawOperation.on("vertex-remove",(e=>this.onVertexRemove(e))),this.drawOperation.on("vertex-update",(e=>this.onVertexUpdate(e))),this.drawOperation.on("cursor-update",(e=>this.onCursorUpdate(e))),this.drawOperation.on("complete",(e=>this.onComplete(e)))},r.destroy=function(){this.drawOperation.destroy(),this.drawOperation=null,this._destroyAllVisualisations(),this.view.map.remove(this._internalGraphicsLayer),this._set("view",null)},r.onInputEvent=function(e){this.drawOperation.onInputEvent(e)},r._getCreateGeometry=function(e,t=!1){if(null==this.drawOperation)return null;const i=a.isSome(e)?e:this.drawOperation.hasStagedVertex?this.drawOperation.numVertices-1:null,r=this.drawOperation.vertices;if(0===r.length)return null;const s=this.drawOperation.spatialReference,n=r,o=n.slice(),l=[];a.isSome(i)&&(o.splice(i,1),l.push(n[i]));const c={regularVertices:null,stagedVertices:null,full:null,outline:null},h="3d"===this.view.type&&"global"===this.view.viewingMode;switch(this.geometryType){case"point":c.regularVertices=o,c.stagedVertices=l,c.full=this.drawOperation.coordinateHelper.createPointFromArray(r[0]);break;case"polyline":c.regularVertices=o,c.stagedVertices=l,n.length>0&&(c.full=T.createPolyline([n],s,h));break;case"polygon":c.regularVertices=o,c.stagedVertices=l,n.length>0&&(c.full=T.createPolygon([n],s,h,!0));break;case"circle":if(n.length>0){const e=V.createViewAlignedCoordinateSystem(this.view,r[0]);if(1===n.length&&t){const t=n[0],i=e.makeMapPoint(t[0]+D*this.view.resolution,t[1]);c.full=T.createCircle([t,i],e,!0)}else 2===n.length&&(c.full=this.forceUniformSize?T.createCircle(r,e,this.centered):T.createEllipse(r,e,this.centered))}break;case"rectangle":if(n.length>0){const e=V.createViewAlignedCoordinateSystem(this.view,r[0]);if(1===n.length&&t){const t=n[0],i=e.makeMapPoint(t[0]+D*this.view.resolution,t[1]);c.full=T.createSquare([t,i],e,!0)}else 2===n.length&&(c.full=this.forceUniformSize?T.createSquare(r,e,this.centered):T.createRectangle(r,e,this.centered))}break;default:return null}switch(this.geometryType){case"point":break;case"polyline":n.length>1&&(c.outline=T.createPolyline([n],s,h));break;case"polygon":n.length>1&&(c.outline=T.createPolygon([n],s,h));break;case"circle":case"rectangle":a.isSome(c.full)&&"polygon"===c.full.type&&(c.outline=T.createPolygon(c.full.rings,s,h))}return c},r._destroyAllVisualisations=function(){this._destroyCreateGraphic(),this._destroyOutlineVisualElement(),this._destroyVerticesVisualElement(),this._destroyStagedVerticesVisualElement()},r._destroyCreateGraphic=function(){a.isSome(this._createGraphic)&&(this._internalGraphicsLayer.remove(this._createGraphic),this._createGraphic.destroy(),this._createGraphic=null),this._createGraphicState=null,this.handles.remove(b)},r._destroyOutlineVisualElement=function(){a.isSome(this._outlineVisualElement)&&(this._outlineVisualElement.destroy(),this._outlineVisualElement=null)},r._destroyVerticesVisualElement=function(){a.isSome(this._verticesVisualElement)&&(this._verticesVisualElement.destroy(),this._verticesVisualElement=null)},r._destroyStagedVerticesVisualElement=function(){a.isSome(this._stagedVerticesVisualElement)&&(this._stagedVerticesVisualElement.destroy(),this._stagedVerticesVisualElement=null)},r._updateCreateGraphic=function(e=null){const t=this._getCreateGeometry(e);if(a.isNone(t))return void this._destroyAllVisualisations();const i=this._internalGraphicsLayer.elevationInfo;a.isSome(t.outline)?a.isNone(this._outlineVisualElement)?(this._outlineVisualElement=new E.OutlineVisualElement({view:this.view,geometry:t.outline,elevationInfo:a.unwrap(i),isDraped:a.isSome(this._createGraphicState)?this._createGraphicState.isDraped:"on-the-ground"===v.getEffectiveElevationMode(this.hasZ,i),attached:!1}),G.settings.visualElements.lineGraphics.outline.apply(this._outlineVisualElement),G.settings.visualElements.lineGraphics.shadowStyle.apply(this._outlineVisualElement),this._outlineVisualElement.attached=!0,this._outlineVisualElement.laserlineEnabled=!0):this._outlineVisualElement.geometry=t.outline:this._destroyOutlineVisualElement(),a.isSome(t.regularVertices)?a.isNone(this._verticesVisualElement)?(this._verticesVisualElement=new S.VerticesVisualElement({view:this.view,spatialReference:this.view.spatialReference,vertices:t.regularVertices,elevationInfo:a.unwrap(this._internalGraphicsLayer.elevationInfo),renderOccluded:G.settings.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._verticesVisualElement.attached=!0):this._verticesVisualElement.vertices=t.regularVertices:this._destroyVerticesVisualElement(),a.isSome(t.stagedVertices)?a.isNone(this._stagedVerticesVisualElement)?(this._stagedVerticesVisualElement=new S.VerticesVisualElement({view:this.view,spatialReference:this.view.spatialReference,vertices:t.stagedVertices,elevationInfo:a.unwrap(this._internalGraphicsLayer.elevationInfo),renderOccluded:G.settings.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._stagedVerticesVisualElement.color=G.settings.colorToVec4(G.settings.reshapeManipulators.selected.color),this._stagedVerticesVisualElement.attached=!0):this._stagedVerticesVisualElement.vertices=t.stagedVertices:this._destroyStagedVerticesVisualElement(),a.isSome(t.full)?a.isNone(this._createGraphic)?(this._createGraphic=new d({geometry:t.full,symbol:this.createGraphicSymbol}),this._internalGraphicsLayer.add(this._createGraphic),this.view.maskOccludee(this._createGraphic),this._createGraphicState=new O.GraphicState({graphic:this._createGraphic}),this.handles.add([this.view.trackGraphicState(this._createGraphicState),y.init(this._createGraphicState,"isDraped",(e=>{a.isSome(this._outlineVisualElement)&&(this._outlineVisualElement.isDraped=e)}))],b),this.notifyChange("createGraphic")):this._createGraphic.geometry=t.full:this._destroyCreateGraphic()},r.reset=function(){},r.redo=function(){this.drawOperation.redo()},r.undo=function(){this.drawOperation.undo()},r.completeCreateOperation=function(){this.drawOperation.complete()},r.activate=function(){},r.deactivate=function(){this.drawOperation.isCompleted||this.drawOperation.cancel()},r.getVertexCoords=function(){return this.drawOperation.vertices},r.onVertexAdd=function(e){this._updateCreateGraphic(),this.emit("vertex-add",e)},r.onVertexRemove=function(e){this._updateCreateGraphic(),this.emit("vertex-remove",e)},r.onVertexUpdate=function(e){this._updateCreateGraphic(),this.emit("vertex-update",e)},r.onCursorUpdate=function(e){this._updateCreateGraphic(1===e.vertices.length?e.vertices[0].vertexIndex:null),this.emit("cursor-update",e)},r.onComplete=function(e){this._updateCreateGraphic();let t=null;if(this.drawOperation.isCompleted){const e=this._getCreateGeometry(null,!0);a.isSome(e)&&(t=new d({geometry:e.full,symbol:this.createGraphicSymbol}))}this.emit("complete",{graphic:t,...e})},t._createClass(i,[{key:"createGraphic",get:function(){return this._createGraphic}},{key:"enabled",set:function(e){this.drawOperation.interactive=e,this._set("enabled",e)}},{key:"centered",set:function(e){this._set("centered",e),this._updateCreateGraphic()}},{key:"forceUniformSize",set:function(e){this._set("forceUniformSize",e),this._updateCreateGraphic()}},{key:"canRedo",get:function(){return this.drawOperation.canRedo}},{key:"canUndo",get:function(){return this.drawOperation.canUndo}}]),i}(m.HandleOwnerMixin(u.EventedMixin(f.InteractiveToolBase))),i.__decorate([o.property({constructOnly:!0,nonNullable:!0})],e.DrawGraphicTool.prototype,"view",void 0),i.__decorate([o.property()],e.DrawGraphicTool.prototype,"createGraphicSymbol",void 0),i.__decorate([o.property()],e.DrawGraphicTool.prototype,"createGraphic",null),i.__decorate([o.property({value:!0})],e.DrawGraphicTool.prototype,"enabled",null),i.__decorate([o.property({value:!0})],e.DrawGraphicTool.prototype,"centered",null),i.__decorate([o.property({value:!0})],e.DrawGraphicTool.prototype,"forceUniformSize",null),i.__decorate([o.property({constructOnly:!0})],e.DrawGraphicTool.prototype,"hasZ",void 0),i.__decorate([o.property({nonNullable:!0})],e.DrawGraphicTool.prototype,"defaultZ",void 0),i.__decorate([o.property({constructOnly:!0})],e.DrawGraphicTool.prototype,"elevationInfo",void 0),i.__decorate([o.property()],e.DrawGraphicTool.prototype,"snapToScene",void 0),i.__decorate([o.property()],e.DrawGraphicTool.prototype,"snappingManager",void 0),i.__decorate([o.property({constructOnly:!0})],e.DrawGraphicTool.prototype,"mode",void 0),i.__decorate([o.property({constructOnly:!0})],e.DrawGraphicTool.prototype,"geometryType",void 0),i.__decorate([o.property({readOnly:!0})],e.DrawGraphicTool.prototype,"type",void 0),e.DrawGraphicTool=i.__decorate([l.subclass("esri.views.3d.interactive.editingTools.draw3D.DrawTool")],e.DrawGraphicTool);const D=48,b="create-graphic";Object.defineProperty(e,"__esModule",{value:!0})}));
