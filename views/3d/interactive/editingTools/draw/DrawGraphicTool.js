// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../../Graphic","../../../../../core/compilerUtils","../../../../../core/Evented","../../../../../core/maybe","../../../../../core/accessorSupport/decorators","../../../../../layers/GraphicsLayer","../../../../../support/elevationInfoUtils","../settings","./DrawOperation","./drawSurfaces","../../visualElements/OutlineVisualElement","../../visualElements/VerticesVisualElement","../../../../draw/support/createUtils","../../../../interactive/InteractiveToolBase"],(function(e,t,i,r,a,n,o,s,l,c,p,u,h,d,y,m,f){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DrawGraphicTool=void 0;var v=function(e){function t(t){var i=e.call(this,t)||this;return i.drawOperation=null,i._createGraphic=null,i._outlineVisualElement=null,i._verticesVisualElement=null,i._stagedVerticesVisualElement=null,i.hasZ=!0,i.defaultZ=0,i.elevationInfo=null,i.snapToScene=!1,i.mode="hybrid",i.geometryType=null,i.type="draw-3d",i}return i.__extends(t,e),t.prototype.initialize=function(){var e=this,t=o.unwrapOr(this.elevationInfo,{mode:this.hasZ?"absolute-height":"on-the-ground",offset:0});this._internalGraphicsLayer=new l({elevationInfo:t}),this.view.map.layers.add(this._internalGraphicsLayer),this.drawOperation=new u.DrawOperation({view:this.view,manipulators:this.manipulators,geometryType:_(this.geometryType),drawingMode:this.mode,hasZ:this.hasZ,defaultZ:this.defaultZ,snappingEnabled:this.snapToScene,snappingDrawSurface:new h.SceneDrawSurface(this.view,t,[this._internalGraphicsLayer]),hasM:!1,elevationInfo:t}),this.drawOperation.on("vertex-add",(function(t){return e.onVertexAdd(t)})),this.drawOperation.on("vertex-remove",(function(t){return e.onVertexRemove(t)})),this.drawOperation.on("vertex-update",(function(t){return e.onVertexUpdate(t)})),this.drawOperation.on("cursor-update",(function(t){return e.onCursorUpdate(t)})),this.drawOperation.on("complete",(function(t){return e.onComplete(t)}))},t.prototype.destroy=function(){this.drawOperation.destroy(),this.drawOperation=null,this._destroyAllVisualisations(),this.view.map.remove(this._internalGraphicsLayer),this._set("view",null)},t.prototype.onInputEvent=function(e){this.drawOperation.onInputEvent(e)},t.prototype._getCreateGeometry=function(e,t){if(void 0===t&&(t=!1),null==this.drawOperation)return null;var i=o.isSome(e)?e:this.drawOperation.hasStagedVertex?this.drawOperation.numVertices-1:null,r=this.drawOperation.vertices;if(0===r.length)return null;var a=this.drawOperation.spatialReference,n=r,s=n.slice(),l=[];o.isSome(i)&&(s.splice(i,1),l.push(n[i]));var c={regularVertices:null,stagedVertices:null,full:null,outline:null},p="3d"===this.view.type&&"global"===this.view.viewingMode;switch(this.geometryType){case"point":c.regularVertices=s,c.stagedVertices=l,c.full=this.drawOperation.coordinateHelper.createPointFromArray(r[0]);break;case"polyline":c.regularVertices=s,c.stagedVertices=l,n.length>0&&(c.full=m.createPolyline([n],a,p));break;case"polygon":c.regularVertices=s,c.stagedVertices=l,n.length>0&&(c.full=m.createPolygon([n],a,p,!0));break;case"circle":if(n.length>0){var u=m.createViewAlignedCoordinateSystem(this.view,r[0]);if(1===n.length&&t){var h=n[0],d=u.makeMapPoint(h[0]+g*this.view.resolution,h[1]);c.full=m.createCircle([h,d],u,!0)}else 2===n.length&&(c.full=this.forceUniformSize?m.createCircle(r,u,this.centered):m.createEllipse(r,u,this.centered))}break;case"rectangle":if(n.length>0){u=m.createViewAlignedCoordinateSystem(this.view,r[0]);if(1===n.length&&t){h=n[0],d=u.makeMapPoint(h[0]+g*this.view.resolution,h[1]);c.full=m.createSquare([h,d],u,!0)}else 2===n.length&&(c.full=this.forceUniformSize?m.createSquare(r,u,this.centered):m.createRectangle(r,u,this.centered))}break;default:return null}switch(this.geometryType){case"point":break;case"polyline":n.length>1&&(c.outline=m.createPolyline([n],a,p));break;case"polygon":n.length>1&&(c.outline=m.createPolygon([n],a,p));break;case"circle":case"rectangle":o.isSome(c.full)&&"polygon"===c.full.type&&(c.outline=m.createPolygon(c.full.rings,a,p))}return c},t.prototype._destroyAllVisualisations=function(){this._destroyCreateGraphic(),this._destroyOutlineVisualElement(),this._destroyVerticesVisualElement(),this._destroyStagedVerticesVisualElement()},t.prototype._destroyCreateGraphic=function(){o.isSome(this._createGraphic)&&(this._internalGraphicsLayer.remove(this._createGraphic),this._createGraphic.destroy(),this._createGraphic=null)},t.prototype._destroyOutlineVisualElement=function(){o.isSome(this._outlineVisualElement)&&(this._outlineVisualElement.destroy(),this._outlineVisualElement=null)},t.prototype._destroyVerticesVisualElement=function(){o.isSome(this._verticesVisualElement)&&(this._verticesVisualElement.destroy(),this._verticesVisualElement=null)},t.prototype._destroyStagedVerticesVisualElement=function(){o.isSome(this._stagedVerticesVisualElement)&&(this._stagedVerticesVisualElement.destroy(),this._stagedVerticesVisualElement=null)},t.prototype._updateCreateGraphic=function(e){void 0===e&&(e=null);var t=this._getCreateGeometry(e);if(o.isNone(t))this._destroyAllVisualisations();else{var i=this._internalGraphicsLayer.elevationInfo,a="on-the-ground"===c.getEffectiveElevationMode(this.hasZ,i);o.isSome(t.outline)?o.isNone(this._outlineVisualElement)?(this._outlineVisualElement=new d.OutlineVisualElement({view:this.view,geometry:t.outline,elevationInfo:o.unwrap(i),isDraped:a,attached:!1}),p.settings.visualElements.lineGraphics.outline.apply(this._outlineVisualElement),p.settings.visualElements.lineGraphics.shadowStyle.apply(this._outlineVisualElement),this._outlineVisualElement.attached=!0,this._outlineVisualElement.laserlineEnabled=!0):this._outlineVisualElement.geometry=t.outline:this._destroyOutlineVisualElement(),o.isSome(t.regularVertices)?o.isNone(this._verticesVisualElement)?(this._verticesVisualElement=new y.VerticesVisualElement({view:this.view,spatialReference:this.view.spatialReference,vertices:t.regularVertices,elevationInfo:o.unwrap(this._internalGraphicsLayer.elevationInfo),attached:!1}),this._verticesVisualElement.attached=!0):this._verticesVisualElement.vertices=t.regularVertices:this._destroyVerticesVisualElement(),o.isSome(t.stagedVertices)?o.isNone(this._stagedVerticesVisualElement)?(this._stagedVerticesVisualElement=new y.VerticesVisualElement({view:this.view,spatialReference:this.view.spatialReference,vertices:t.stagedVertices,elevationInfo:o.unwrap(this._internalGraphicsLayer.elevationInfo),attached:!1}),this._stagedVerticesVisualElement.color=p.settings.colorToVec4(p.settings.reshapeManipulators.selected.color),this._stagedVerticesVisualElement.attached=!0):this._stagedVerticesVisualElement.vertices=t.stagedVertices:this._destroyStagedVerticesVisualElement(),o.isSome(t.full)?o.isNone(this._createGraphic)?(this._createGraphic=new r({geometry:t.full,symbol:this.createGraphicSymbol}),this._internalGraphicsLayer.add(this._createGraphic),this.view.maskOccludee(this._createGraphic),this.notifyChange("createGraphic")):this._createGraphic.geometry=t.full:this._destroyCreateGraphic()}},Object.defineProperty(t.prototype,"createGraphic",{get:function(){return this._createGraphic},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"enabled",{set:function(e){this.drawOperation.interactive=e,this._set("enabled",e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"centered",{set:function(e){this._set("centered",e),this._updateCreateGraphic()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"forceUniformSize",{set:function(e){this._set("forceUniformSize",e),this._updateCreateGraphic()},enumerable:!1,configurable:!0}),t.prototype.reset=function(){},Object.defineProperty(t.prototype,"canRedo",{get:function(){return this.drawOperation.canRedo},enumerable:!1,configurable:!0}),t.prototype.redo=function(){this.drawOperation.redo()},Object.defineProperty(t.prototype,"canUndo",{get:function(){return this.drawOperation.canUndo},enumerable:!1,configurable:!0}),t.prototype.undo=function(){this.drawOperation.undo()},t.prototype.completeCreateOperation=function(){this.drawOperation.complete()},t.prototype.activate=function(){},t.prototype.deactivate=function(){this.drawOperation.isCompleted||this.drawOperation.cancel()},t.prototype.getVertexCoords=function(){return this.drawOperation.vertices},t.prototype.onVertexAdd=function(e){this._updateCreateGraphic(),this.emit("vertex-add",e)},t.prototype.onVertexRemove=function(e){this._updateCreateGraphic(),this.emit("vertex-remove",e)},t.prototype.onVertexUpdate=function(e){this._updateCreateGraphic(),this.emit("vertex-update",e)},t.prototype.onCursorUpdate=function(e){this._updateCreateGraphic(1===e.vertices.length?e.vertices[0].vertexIndex:null),this.emit("cursor-update",e)},t.prototype.onComplete=function(e){this._updateCreateGraphic();var t=null;if(this.drawOperation.isCompleted){var a=this._getCreateGeometry(null,!0);o.isSome(a)&&(t=new r({geometry:a.full,symbol:this.createGraphicSymbol}))}this.emit("complete",i.__assign({graphic:t},e))},i.__decorate([s.property({constructOnly:!0,nonNullable:!0})],t.prototype,"view",void 0),i.__decorate([s.property()],t.prototype,"createGraphicSymbol",void 0),i.__decorate([s.property()],t.prototype,"createGraphic",null),i.__decorate([s.property({value:!0})],t.prototype,"enabled",null),i.__decorate([s.property({value:!0})],t.prototype,"centered",null),i.__decorate([s.property({value:!0})],t.prototype,"forceUniformSize",null),i.__decorate([s.property({constructOnly:!0})],t.prototype,"hasZ",void 0),i.__decorate([s.property({nonNullable:!0})],t.prototype,"defaultZ",void 0),i.__decorate([s.property({constructOnly:!0})],t.prototype,"elevationInfo",void 0),i.__decorate([s.property()],t.prototype,"snapToScene",void 0),i.__decorate([s.property({constructOnly:!0})],t.prototype,"mode",void 0),i.__decorate([s.property({constructOnly:!0})],t.prototype,"geometryType",void 0),i.__decorate([s.property({readOnly:!0})],t.prototype,"type",void 0),t=i.__decorate([s.subclass("esri.views.3d.interactive.editingTools.draw3D.DrawTool")],t)}(n.EventedMixin(f.InteractiveToolBase));function _(e){switch(e){case"point":case"polyline":case"polygon":return e;case"circle":case"rectangle":return"segment";default:return a.neverReached(e),null}}t.DrawGraphicTool=v;var g=48}));