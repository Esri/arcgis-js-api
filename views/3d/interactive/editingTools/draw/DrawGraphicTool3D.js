/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../core/handleUtils","../../../../../core/maybe","../../../../../core/reactiveUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/accessorSupport/ensureType","../../../../../core/arrayUtils","../../../../../core/accessorSupport/decorators/subclass","../../../../../chunks/vec3","../../../../../chunks/vec3f64","../../../../../support/elevationInfoUtils","../../../../../symbols/support/ElevationInfo","../../SegmentLabels3D","../../SnappingVisualizer3D","../settings","../../visualElements/ExtendedLineVisualElement","../../visualElements/OutlineVisualElement","../../visualElements/VerticesVisualElement","../../../layers/graphics/elevationAlignmentUtils","../../../layers/graphics/ElevationContext","../../../layers/graphics/GraphicState","../../../webgl-engine/lib/Material","../../../../draw/DrawGraphicTool","../../../../draw/DrawOperation","../../../../draw/drawSurfaces"],(function(e,t,i,a,n,s,l,r,o,c,u,h,p,d,v,m,E,V,f,w,y,_,g,D,S,G,T){"use strict";e.DrawGraphicTool3D=function(e){function i(t){var i;return(i=e.call(this,t)||this)._activeVertexVisualElement=null,i._createGraphicState=null,i._outlineVisualElement=null,i._verticesVisualElement=null,i._verticalLineVisualElement=null,i.geometryType=null,i.type="draw-3d",i}t._inheritsLoose(i,e);var l=i.prototype;return l.initialize=function(){const{mode:e,offset:t}=this.elevationInfo;this.internalGraphicsLayer.elevationInfo=new d({mode:e,offset:t})},l.normalizeCtorArgs=function(e){if(!e.elevationInfo){const t=e.hasZ??!0;return{...e,elevationInfo:p.getEffectiveElevationInfo(t)}}return e},l.initializeGraphic=function(e){const t=this._createGraphicState=new g.GraphicState({graphic:e});return a.handlesGroup([this.view.maskOccludee(e),this.view.trackGraphicState(t),s.watch((()=>({element:this._outlineVisualElement,isDraped:t.isDraped})),(({element:e,isDraped:t})=>{n.applySome(e,(e=>e.isDraped=t))}),s.initial)])},l.makeDrawOperation=function(){const{geometryType:e}=this,t="circle"!==e&&"rectangle"!==e;return new G.DrawOperation({view:this.view,manipulators:this.manipulators,geometryType:S.geometryTypeToDrawOperationGeometryType(e),drawingMode:this.mode,hasZ:this.hasZ,defaultZ:this.defaultZ,snapToSceneEnabled:this.snapToScene,drawSurface:new T.SceneDrawSurface(this.view,this.elevationInfo,[this.internalGraphicsLayer]),elevationDrawSurface:new T.ElevationDrawSurface(this.elevationInfo,this.defaultZ,this.view,this.internalGraphicsLayer),hasM:!1,elevationInfo:this.elevationInfo,snappingManager:this.snappingManager,snappingVisualizer:new m.SnappingVisualizer3D,segmentLabels:t?new v.SegmentLabels3D:null,labelOptions:this.labelOptions,tooltipOptions:this.tooltipOptions,isDraped:n.isSome(this._createGraphicState)?this._createGraphicState.isDraped:"on-the-ground"===p.getEffectiveElevationMode(this.hasZ,this.elevationInfo)})},l.onActiveVertexChanged=function(e){const{view:t}=this;return n.isSome(this._activeVertexVisualElement)?(this._activeVertexVisualElement.vertices=[e],this._updateVerticalLineVisualElement(e),null):(this._activeVertexVisualElement=new w.VerticesVisualElement({view:t,spatialReference:t.spatialReference,vertices:[e],elevationInfo:this.internalGraphicsLayer.elevationInfo,renderOccluded:E.settings.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._activeVertexVisualElement.color=E.settings.colorToVec4(E.settings.reshapeManipulators.selected.color),this._activeVertexVisualElement.attached=!0,this._verticalLineVisualElement=new V.ExtendedLineVisualElement({view:t,extensionType:E.settings.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:D.RenderOccludedFlag.OccludeAndTransparent}),E.settings.visualElements.zVerticalLine.apply(this._verticalLineVisualElement),a.makeHandle((()=>{this._activeVertexVisualElement=n.destroyMaybe(this._activeVertexVisualElement),this._verticalLineVisualElement=n.destroyMaybe(this._verticalLineVisualElement)})))},l._updateVerticalLineVisualElement=function(e){const t=this._verticalLineVisualElement;if(n.isNone(t))return;const{renderCoordsHelper:i,elevationProvider:a}=this.view;u.set(O,e[0],e[1],e[2]),L.setFromElevationInfo(this.elevationInfo),O[2]=y.evaluateElevationAlignmentAtPoint(O,a,L,i);i.toRenderCoords(O,this.view.spatialReference,O)?(t.setStartEndFromWorldDownAtLocation(O),t.attached=!0):t.attached=!1},l.onOutlineChanged=function(e){if(n.isSome(this._outlineVisualElement))return this._outlineVisualElement.geometry=e,null;const t=this.internalGraphicsLayer.elevationInfo;return this._outlineVisualElement=new f.OutlineVisualElement({view:this.view,geometry:e,elevationInfo:t,isDraped:n.isSome(this._createGraphicState)?this._createGraphicState.isDraped:"on-the-ground"===p.getEffectiveElevationMode(this.hasZ,t),attached:!1}),E.settings.visualElements.lineGraphics.outline.apply(this._outlineVisualElement),E.settings.visualElements.lineGraphics.shadowStyle.apply(this._outlineVisualElement),this._outlineVisualElement.attached=!0,this._outlineVisualElement.laserlineEnabled=!0,a.makeHandle((()=>{this._outlineVisualElement=n.destroyMaybe(this._outlineVisualElement)}))},l.onRegularVerticesChanged=function(e){return n.isSome(this._verticesVisualElement)?(this._verticesVisualElement.vertices=e,null):(this._verticesVisualElement=new w.VerticesVisualElement({view:this.view,spatialReference:this.view.spatialReference,vertices:e,elevationInfo:this.internalGraphicsLayer.elevationInfo,renderOccluded:E.settings.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._verticesVisualElement.attached=!0,a.makeHandle((()=>{this._verticesVisualElement=n.destroyMaybe(this._verticesVisualElement)})))},i}(S.DrawGraphicTool),i.__decorate([l.property({constructOnly:!0})],e.DrawGraphicTool3D.prototype,"elevationInfo",void 0),i.__decorate([l.property({constructOnly:!0})],e.DrawGraphicTool3D.prototype,"geometryType",void 0),i.__decorate([l.property()],e.DrawGraphicTool3D.prototype,"type",void 0),i.__decorate([l.property({constructOnly:!0})],e.DrawGraphicTool3D.prototype,"view",void 0),e.DrawGraphicTool3D=i.__decorate([c.subclass("esri.views.3d.interactive.editingTools.draw.DrawGraphicTool3D")],e.DrawGraphicTool3D);const L=new _.ElevationContext,O=h.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
