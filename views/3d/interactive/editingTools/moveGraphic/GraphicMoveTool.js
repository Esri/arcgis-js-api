/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../core/Collection","../../../../../core/Evented","../../../../../core/HandleOwner","../../../../../core/Handles","../../../../../core/handleUtils","../../../../../core/maybe","../../../../../core/accessorSupport/decorators/property","../../../../../core/arrayUtils","../../../../../core/has","../../../../../core/accessorSupport/ensureType","../../../../../core/accessorSupport/decorators/subclass","../../../../../layers/graphics/dehydratedFeatures","../../../../../support/elevationInfoUtils","../../manipulatorUtils","../../SnappingVisualizer3D","../manipulatorUtils","../visualElementUtils","../manipulations/config","../manipulations/MoveManipulation","../manipulations/moveUtils","../manipulations/MoveXYGraphicManipulation","./isSupportedGraphic","../../visualElements/OutlineVisualElement","../../../layers/graphics/GraphicState","../../../../interactive/dragEventPipeline","../../../../interactive/InteractiveToolBase","../../../../interactive/editGeometry/EditGeometryOperations","../../../../interactive/snapping/SnappingContext","../../../../interactive/snapping/SnappingDragPipelineStep"],(function(e,t,i,n,a,o,r,s,l,p,c,h,u,d,g,v,m,M,f,y,w,_,E,G,S,b,x,O,P,D,T,A){"use strict";let H=function(e){this.allGraphics=e,this.type="graphic-move-start"},k=function(e,t,i){this.dx=e,this.dy=t,this.allGraphics=i,this.type="graphic-move"},z=function(e){this.allGraphics=e,this.type="graphic-move-stop"};e.GraphicMoveTool=function(e){function i(t){var i;return(i=e.call(this,t)||this).graphics=new n,i.enableZ=!0,i.type="move-3d",i._toolHandles=new r,i.snappingPipeline=new A.SnappingPipeline,i}t._inheritsLoose(i,e);var a=i.prototype;return a.initialize=function(){this._toolHandles.add([this.graphics.on("change",(()=>this._refreshManipulators()))]),this._refreshManipulators(),this.complete()},a.destroy=function(){this._toolHandles.destroy(),this._toolHandles=null,this.graphics.removeAll(),this._set("view",null)},a.reset=function(){},a._refreshManipulators=function(){this.handles.removeAll(),this._moveManipulation&&this._moveManipulation.destroy(),this.manipulators.removeAll();const e=this.graphics.toArray().filter((e=>0===S.isSupportedGraphic(e))).map((e=>new I(e)));e.length&&(this.createManipulators(e),this.createVisualElements(e),this.handles.add(e.map((e=>this.view.trackGraphicState(e.state)))),this.updateMoveManipulation(e))},a.createManipulators=function(e){for(const t of e){const i=t.state;t.manipulationXY=new G.MoveXYGraphicManipulation({tool:this,view:this.view,graphicState:i}),t.manipulationXY.forEachManipulator((e=>this.handles.add(e.events.on("immediate-click",(e=>{this.emit("immediate-click",{...e,graphic:i.graphic}),e.stopPropagation()}))))),this.handles.add(t.manipulationXY.createDragPipeline(((t,i,n,a)=>this.buildDragEventPipeline(e,0,t,i,n,a))))}this.createMoveManipulation(e)},a.createMoveManipulation=function(e){const t=new _.MoveManipulation({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:1===e.length?_.MoveManipulation.radiusForSymbol(e[0].graphic.symbol):w.DISC_RADIUS});this._moveManipulation=t,t.elevationInfo={mode:"absolute-height",offset:0},t.forEachManipulator((e=>{this.handles.add(e.events.on("immediate-click",(i=>{t.zManipulation.hasManipulator(e)||1!==this.graphics.length||this.emit("immediate-click",{...i,graphic:this.graphics.getItemAt(0)}),i.stopPropagation()})))}));const i=()=>this.updateMoveManipulation(e);for(const a of e)this.handles.add([a.state.on("changed",i),a.state.watch("displaying",i)]);const n=e[e.length-1];this.handles.add(n.state.on("changed",(()=>this.updateMoveManipulationAngle(n)))),this.handles.add(t.createDragPipeline(((t,i,n,a,o)=>this.buildDragEventPipeline(e,t,i,n,a,o)),v.getGraphicEffectiveElevationInfo(n.graphic),l.unwrap(n.graphic.geometry).spatialReference,n.graphic)),this.updateMoveManipulationAngle(n)},a.createVisualElements=function(e){for(const t of e){const i=t.graphic,n=y.createVisualElements({view:this.view,graphic:i,forEachManipulator:e=>{t.manipulationXY.forEachManipulator(e),this._moveManipulation.forEachManipulator(e)},onManipulatorsChanged:()=>s.makeHandle()});l.isNone(n)||(t.geometryRepresentation=n.visualElement,t.geometryRepresentation instanceof b.OutlineVisualElement&&this.handles.add([t.geometryRepresentation.events.on("attachment-origin-changed",(()=>{t.state.isDraped||this.updateMoveManipulation(e)})),t.state.watch("isDraped",(()=>this.updateMoveManipulation(e)))]),this.handles.add(n))}},a.updateMoveManipulationAngle=function(e){this._moveManipulation.angleDeferred=()=>E.shapeOrientation(e.graphic.geometry)},a.updateMoveManipulation=function(e){const t=g.makeDehydratedPoint(0,0,0,this.view.spatialReference);let i=0,n=!1;const a=this._moveManipulation;for(const o of e){if(!o.state.displaying)continue;const e=o.state.graphic;this.enableZ&&f.canMoveZ(e)&&(n=!0);const a=o.geometryRepresentation instanceof b.OutlineVisualElement&&!o.state.isDraped?o.geometryRepresentation.attachmentOrigin:m.getGraphicAttachmentOrigin(this.view,e);l.isSome(a)&&(t.x+=a.x,t.y+=a.y,t.z+=a.z,i++)}i>0?(t.x/=i,t.y/=i,t.z/=i,a.location=t,a.xyManipulation.available=!0,a.xyAxisManipulation.available=!0,a.zManipulation.available=n):a.available=!1},a.buildDragEventPipeline=function(e,t,i,n,a,o){const r=[],s=[];let l=null,p=null;const c=()=>{for(const e of r)e.dragging=!1;r.length=0,s.length=0,l=null,p=null,this._moveManipulation.interactive=!0};if(1===e.length&&0===t){const t=e[0].graphic;n=this.buildSnappingPipelineSteps(t,v.getGraphicEffectiveElevationInfo(t),n,a,o)}const h=n.next((t=>{if("start"===t.action){r.length=0,s.length=0;for(const t of e)t.dragging||!t.manipulationXY.hasManipulator(i)&&t.manipulationXY.grabbing||(r.push(t),s.push(t.graphic),t.dragging=!0);if(0!==s.length&&(this._moveManipulation.interactive=!1,l=O.dragGraphicMany(s,this.view.state.viewingMode),p=O.resetGraphicMany(s),this.emit("graphic-move-start",new H(s)),this.destroyed))return null}return 0!==s.length?t:null})).next((e=>l(e))).next((e=>{switch(e.action){case"start":case"update":if(e.translationX||e.translationY||e.translationZ){const t=this.view.toScreen(e.mapStart),i=this.view.toScreen(e.mapEnd),n=i.x-t.x,a=i.y-t.y;if(this.emit("graphic-move",new k(n,a,s)),this.destroyed)return null}break;case"end":if(this.emit("graphic-move-stop",new z(s)),this.destroyed)return null;c()}}));return a.next((e=>p(e))).next((()=>{if(this.emit("graphic-move-stop",new z(s)),this.destroyed)return null;c()})),h},a.buildSnappingPipelineSteps=function(e,t,i,n,a){const o=e.geometry;if(l.isNone(o)||"point"!==o.type&&"mesh"!==o.type)return i;const r=("point"===o.type?o:o.anchor).clone(),s=new T.SnappingContext({elevationInfo:t,pointer:a,editGeometryOperations:D.EditGeometryOperations.fromGeometry(r,this.view.state.viewingMode),visualizer:new M.SnappingVisualizer3D,excludeFeature:e}),p=this.snappingManager;return i.next((t=>{r.z=v.getConvertedElevation(this.view,r,v.getGraphicEffectiveElevationInfo(e),{mode:"absolute-height",offset:0});return{...t,snapOrigin:s.coordinateHelper.pointToVector(r)}})).next(this.snappingPipeline.createSnapDragEventPipelineStep({snappingContext:s,snappingManager:p,cancel:n,updatingHandles:this.updatingHandles}),this.snappingPipeline.next)},t._createClass(i,[{key:"updating",get:function(){return this.updatingHandles.updating}}]),i}(o.HandleOwnerMixin(a.EventedMixin(P.InteractiveToolBase))),i.__decorate([p.property({constructOnly:!0,nonNullable:!0})],e.GraphicMoveTool.prototype,"view",void 0),i.__decorate([p.property({readOnly:!0})],e.GraphicMoveTool.prototype,"graphics",void 0),i.__decorate([p.property({constructOnly:!0,nonNullable:!0})],e.GraphicMoveTool.prototype,"enableZ",void 0),i.__decorate([p.property({constructOnly:!0})],e.GraphicMoveTool.prototype,"snappingManager",void 0),i.__decorate([p.property({readOnly:!0})],e.GraphicMoveTool.prototype,"type",void 0),i.__decorate([p.property({readOnly:!0})],e.GraphicMoveTool.prototype,"updating",null),e.GraphicMoveTool=i.__decorate([d.subclass("esri.views.3d.interactive.editingTools.graphicMove3D.GraphicMoveTool")],e.GraphicMoveTool);let I=function(){function e(e){this.state=null,this.geometryRepresentation=null,this.manipulationXY=null,this.dragging=!1,this.state=new x.GraphicState({graphic:e})}return t._createClass(e,[{key:"graphic",get:function(){return this.state.graphic}}]),e}();e.GraphicMoveEvent=k,e.GraphicMoveStartEvent=H,e.GraphicMoveStopEvent=z,Object.defineProperty(e,"__esModule",{value:!0})}));
