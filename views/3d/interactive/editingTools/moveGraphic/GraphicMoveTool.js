/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../core/Collection","../../../../../core/Evented","../../../../../core/HandleOwner","../../../../../core/Handles","../../../../../core/handleUtils","../../../../../core/maybe","../../../../../core/accessorSupport/decorators/property","../../../../../core/arrayUtils","../../../../../core/has","../../../../../core/accessorSupport/ensureType","../../../../../core/accessorSupport/decorators/subclass","../../../../../layers/graphics/dehydratedFeatures","../../../../../support/elevationInfoUtils","../../manipulatorUtils","../../SnappingVisualizer3D","../isSupportedGraphicUtils","../manipulatorUtils","../visualElementUtils","../manipulations/config","../manipulations/MoveManipulation","../manipulations/moveUtils","../manipulations/MoveXYGraphicManipulation","./isSupportedGraphic","../../visualElements/OutlineVisualElement","../../../layers/graphics/GraphicState","../../../../interactive/dragEventPipeline","../../../../interactive/InteractiveToolBase","../../../../interactive/editGeometry/EditGeometryOperations","../../../../interactive/snapping/SnappingContext","../../../../interactive/snapping/SnappingDragPipelineStep"],(function(e,t,i,a,n,o,r,s,l,p,c,h,u,d,g,v,m,M,y,f,_,w,S,G,E,b,x,P,T,O,D,A,H){"use strict";let k=function(e){this.allGraphics=e,this.type="graphic-move-start"},X=function(e,t,i){this.dx=e,this.dy=t,this.allGraphics=i,this.type="graphic-move"},Y=function(e){this.allGraphics=e,this.type="graphic-move-stop"};e.GraphicMoveTool=function(e){function i(t){var i;return(i=e.call(this,t)||this).graphics=new a,i.enableZ=!0,i.type="move-3d",i._toolHandles=new r,i.snappingPipeline=new H.SnappingPipeline,i}t._inheritsLoose(i,e);var n=i.prototype;return n.initialize=function(){this._toolHandles.add([this.graphics.on("change",(()=>this._refreshManipulators()))]),this._refreshManipulators(),this.finishToolCreation()},n.destroy=function(){this._toolHandles.destroy(),this._toolHandles=null,this.graphics.removeAll(),this._set("view",null)},n.reset=function(){},n._refreshManipulators=function(){this.handles.removeAll(),this._moveManipulation&&this._moveManipulation.destroy(),this.manipulators.removeAll();const e=this.graphics.toArray().filter((e=>b.isSupportedGraphic(e)===y.SupportedGraphicResult.SUPPORTED)).map((e=>new z(e)));e.length&&(this._createManipulators(e),this._createVisualElements(e),this.handles.add(e.map((e=>this.view.trackGraphicState(e.state)))),this._updateMoveManipulation(e))},n._createManipulators=function(e){for(const t of e){const i=t.state;t.manipulationXY=new E.MoveXYGraphicManipulation({tool:this,view:this.view,graphicState:i}),t.manipulationXY.forEachManipulator((e=>this.handles.add(e.events.on("immediate-click",(e=>{this.emit("immediate-click",{...e,graphic:i.graphic}),e.stopPropagation()}))))),this.handles.add(t.manipulationXY.createDragPipeline(((t,i,a,n)=>this._buildDragEventPipeline(e,S.ManipulationType.XY,t,i,a,n))))}this._createMoveManipulation(e)},n._createMoveManipulation=function(e){const t=new S.MoveManipulation({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:1===e.length?S.MoveManipulation.radiusForSymbol(e[0].graphic.symbol):w.DISC_RADIUS});this._moveManipulation=t,t.elevationInfo={mode:"absolute-height",offset:0},t.forEachManipulator((e=>{this.handles.add(e.events.on("immediate-click",(i=>{t.zManipulation.hasManipulator(e)||1!==this.graphics.length||this.emit("immediate-click",{...i,graphic:this.graphics.getItemAt(0)}),i.stopPropagation()})))}));const i=()=>this._updateMoveManipulation(e);for(const n of e)this.handles.add([n.state.on("changed",i),n.state.watch("displaying",i)]);const a=e[e.length-1];this.handles.add(a.state.on("changed",(()=>this._updateMoveManipulationAngle(a)))),this.handles.add(t.createDragPipeline(((t,i,a,n,o)=>this._buildDragEventPipeline(e,t,i,a,n,o)),v.getGraphicEffectiveElevationInfo(a.graphic),l.unwrap(a.graphic.geometry).spatialReference,a.graphic)),this._updateMoveManipulationAngle(a)},n._createVisualElements=function(e){for(const t of e){const i=t.graphic,a=_.createVisualElements({view:this.view,graphic:i,forEachManipulator:e=>{t.manipulationXY.forEachManipulator(e),this._moveManipulation.forEachManipulator(e)},onManipulatorsChanged:()=>s.makeHandle()});l.isNone(a)||(t.geometryRepresentation=a.visualElement,t.geometryRepresentation instanceof x.OutlineVisualElement&&this.handles.add([t.geometryRepresentation.events.on("attachment-origin-changed",(()=>{t.state.isDraped||this._updateMoveManipulation(e)})),t.state.watch("isDraped",(()=>this._updateMoveManipulation(e)))]),this.handles.add(a))}},n._updateMoveManipulationAngle=function(e){this._moveManipulation.angleDeferred=()=>G.shapeOrientation(e.graphic.geometry)},n._updateMoveManipulation=function(e){const t=g.makeDehydratedPoint(0,0,0,this.view.spatialReference);let i=0,a=!1;const n=this._moveManipulation;for(const o of e){if(!o.state.displaying)continue;const e=o.state.graphic;this.enableZ&&f.canMoveZ(e)&&(a=!0);const n=o.geometryRepresentation instanceof x.OutlineVisualElement&&!o.state.isDraped?o.geometryRepresentation.attachmentOrigin:m.getGraphicAttachmentOrigin(this.view,e);l.isSome(n)&&(t.x+=n.x,t.y+=n.y,t.z+=n.z,i++)}i>0?(t.x/=i,t.y/=i,t.z/=i,n.location=t,n.xyManipulation.available=!0,n.xyAxisManipulation.available=!0,n.zManipulation.available=a):n.available=!1},n._buildDragEventPipeline=function(e,t,i,a,n,o){const r=[],s=[];let l=null,p=null;const c=()=>{for(const e of r)e.dragging=!1;r.length=0,s.length=0,l=null,p=null,this._moveManipulation.interactive=!0};if(1===e.length&&t===S.ManipulationType.XY){const t=e[0].graphic;a=this._buildSnappingPipelineSteps(t,v.getGraphicEffectiveElevationInfo(t),a,n,o)}const h=a.next((t=>{if("start"===t.action){r.length=0,s.length=0;for(const t of e)t.dragging||!t.manipulationXY.hasManipulator(i)&&t.manipulationXY.grabbing||(r.push(t),s.push(t.graphic),t.dragging=!0);if(0!==s.length&&(this._moveManipulation.interactive=!1,l=T.dragGraphicMany(s,this.view.state.viewingMode),p=T.resetGraphicMany(s),this.emit("graphic-move-start",new k(s)),this.destroyed))return null}return 0!==s.length?t:null})).next((e=>l(e))).next((e=>{switch(e.action){case"start":case"update":if(e.translationX||e.translationY||e.translationZ){const t=this.view.toScreen(e.mapStart),i=this.view.toScreen(e.mapEnd),a=i.x-t.x,n=i.y-t.y;if(this.emit("graphic-move",new X(a,n,s)),this.destroyed)return null}break;case"end":if(this.emit("graphic-move-stop",new Y(s)),this.destroyed)return null;c()}}));return n.next((e=>p(e))).next((()=>{if(this.emit("graphic-move-stop",new Y(s)),this.destroyed)return null;c()})),h},n._buildSnappingPipelineSteps=function(e,t,i,a,n){const o=e.geometry;if(l.isNone(o)||"point"!==o.type&&"mesh"!==o.type)return i;const r=("point"===o.type?o:o.anchor).clone(),s=new A.SnappingContext({elevationInfo:t,pointer:n,editGeometryOperations:D.EditGeometryOperations.fromGeometry(r,this.view.state.viewingMode),visualizer:new M.SnappingVisualizer3D,excludeFeature:e}),p=this.snappingManager;return i.next((t=>{r.z=v.getConvertedElevation(this.view,r,v.getGraphicEffectiveElevationInfo(e),{mode:"absolute-height",offset:0});return{...t,snapOrigin:s.coordinateHelper.pointToVector(r)}})).next(this.snappingPipeline.createSnapDragEventPipelineStep({snappingContext:s,snappingManager:p,cancel:a,updatingHandles:this.updatingHandles}),this.snappingPipeline.next)},t._createClass(i,[{key:"updating",get:function(){return this.updatingHandles.updating}}]),i}(o.HandleOwnerMixin(n.EventedMixin(O.InteractiveToolBase))),i.__decorate([p.property({constructOnly:!0,nonNullable:!0})],e.GraphicMoveTool.prototype,"view",void 0),i.__decorate([p.property({readOnly:!0})],e.GraphicMoveTool.prototype,"graphics",void 0),i.__decorate([p.property({constructOnly:!0,nonNullable:!0})],e.GraphicMoveTool.prototype,"enableZ",void 0),i.__decorate([p.property({constructOnly:!0})],e.GraphicMoveTool.prototype,"snappingManager",void 0),i.__decorate([p.property({readOnly:!0})],e.GraphicMoveTool.prototype,"type",void 0),i.__decorate([p.property({readOnly:!0})],e.GraphicMoveTool.prototype,"updating",null),e.GraphicMoveTool=i.__decorate([d.subclass("esri.views.3d.interactive.editingTools.graphicMove3D.GraphicMoveTool")],e.GraphicMoveTool);let z=function(){function e(e){this.state=null,this.geometryRepresentation=null,this.manipulationXY=null,this.dragging=!1,this.state=new P.GraphicState({graphic:e})}return t._createClass(e,[{key:"graphic",get:function(){return this.state.graphic}}]),e}();e.GraphicMoveEvent=X,e.GraphicMoveStartEvent=k,e.GraphicMoveStopEvent=Y,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
