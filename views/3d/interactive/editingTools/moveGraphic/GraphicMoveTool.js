/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../core/has","../../../../../core/maybe","../../../../../core/Logger","../../../../../core/accessorSupport/ensureType","../../../../../core/handleUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/urlUtils","../../../../../core/uuid","../../../../../portal/support/resourceExtension","../../../../../core/Evented","../../../../../core/Collection","../../../../../core/Handles","../../../../../support/elevationInfoUtils","../../../../../layers/graphics/dehydratedFeatures","../../../../interactive/editGeometry/EditGeometry","../../../../interactive/editGeometry/EditGeometryHelper","../../../../interactive/snapping/SnappingContext","../../../../interactive/dragEventPipeline","../../SnappingDragPipelineStep","../../SnappingVisualizer3D","../../../../interactive/InteractiveToolBase","../../manipulatorUtils","./isSupportedGraphic","../manipulatorUtils","../../visualElements/OutlineVisualElement","../../../layers/graphics/GraphicState","../visualElementUtils","../manipulations/config","../manipulations/moveUtils","../manipulations/MoveManipulation","../manipulations/MoveXYGraphicManipulation"],(function(e,t,i,n,a,o,r,s,l,p,c,h,u,d,g,v,m,M,f,y,_,E,w,G,S,b,x,P,D,A,T,O,k,z,I){"use strict";let H=function(e){this.allGraphics=e,this.type="graphic-move-start"},X=function(e,t,i){this.dx=e,this.dy=t,this.allGraphics=i,this.type="graphic-move"},Y=function(e){this.allGraphics=e,this.type="graphic-move-stop"};e.GraphicMoveTool=function(e){function i(t){var i;return(i=e.call(this,t)||this).graphics=new g,i.enableZ=!0,i.type="move-3d",i._toolHandles=new v,i._handles=new v,i.snappingPipeline=new w.SnappingPipeline,i}t._inheritsLoose(i,e);var n=i.prototype;return n.initialize=function(){this._toolHandles.add([this.graphics.on("change",(()=>this._refreshManipulators()))]),this._refreshManipulators()},n.destroy=function(){this._handles.destroy(),this._handles=null,this._toolHandles.destroy(),this._toolHandles=null,this.graphics.removeAll(),this._set("view",null)},n.reset=function(){},n._refreshManipulators=function(){this._handles.removeAll(),this._moveManipulation&&this._moveManipulation.destroy(),this.manipulators.removeAll();const e=this.graphics.toArray().filter((e=>0===x.isSupportedGraphic(e))).map((e=>new R(e)));e.length&&(this.createManipulators(e),this.createVisualElements(e),this._handles.add(e.map((e=>this.view.trackGraphicState(e.state)))),this.updateMoveManipulation(e))},n.createManipulators=function(e){for(const t of e){const i=t.state;t.manipulationXY=new I.MoveXYGraphicManipulation({tool:this,view:this.view,graphicState:i}),t.manipulationXY.forEachManipulator((e=>this._handles.add(e.events.on("immediate-click",(e=>{this.emit("immediate-click",{...e,graphic:i.graphic}),e.stopPropagation()}))))),this._handles.add(t.manipulationXY.createDragPipeline(((t,i,n,a)=>this.buildDragEventPipeline(e,0,t,i,n,a))))}this.createMoveManipulation(e)},n.createMoveManipulation=function(e){const t=new z.MoveManipulation({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:1===e.length?z.MoveManipulation.radiusForSymbol(e[0].graphic.symbol):O.DISC_RADIUS});this._moveManipulation=t,t.elevationInfo={mode:"absolute-height",offset:0},t.forEachManipulator((e=>{this._handles.add(e.events.on("immediate-click",(i=>{t.zManipulation.hasManipulator(e)||1!==this.graphics.length||this.emit("immediate-click",{...i,graphic:this.graphics.getItemAt(0)}),i.stopPropagation()})))}));const i=()=>this.updateMoveManipulation(e);for(const a of e)this._handles.add([a.state.on("changed",i),a.state.watch("displaying",i)]);const n=e[e.length-1];this._handles.add(n.state.on("changed",(()=>this.updateMoveManipulationAngle(n)))),this._handles.add(t.createDragPipeline(((t,i,n,a,o)=>this.buildDragEventPipeline(e,t,i,n,a,o)),m.getGraphicEffectiveElevationInfo(n.graphic),a.unwrap(n.graphic.geometry).spatialReference,n.graphic)),this.updateMoveManipulationAngle(n)},n.createVisualElements=function(e){for(const t of e){const i=t.graphic,n=T.createVisualElements({view:this.view,graphic:i,forEachManipulator:e=>{t.manipulationXY.forEachManipulator(e),this._moveManipulation.forEachManipulator(e)},onManipulatorsChanged:()=>s.makeHandle()});t.geometryRepresentation=n.visualElement,t.geometryRepresentation instanceof D.OutlineVisualElement&&this._handles.add([t.geometryRepresentation.events.on("attachment-origin-changed",(()=>{t.state.isDraped||this.updateMoveManipulation(e)})),t.state.watch("isDraped",(()=>this.updateMoveManipulation(e)))]),this._handles.add(n)}},n.updateMoveManipulationAngle=function(e){this._moveManipulation.angleDeferred=()=>k.shapeOrientation(e.graphic.geometry)},n.updateMoveManipulation=function(e){const t=M.makeDehydratedPoint(0,0,0,this.view.spatialReference);let i=0,n=!1;const o=this._moveManipulation;for(const r of e){if(!r.state.displaying)continue;const e=r.state.graphic;this.enableZ&&P.canMoveZ(e)&&(n=!0);const o=r.geometryRepresentation instanceof D.OutlineVisualElement&&!r.state.isDraped?r.geometryRepresentation.attachmentOrigin:b.getGraphicAttachmentOrigin(this.view,e);a.isSome(o)&&(t.x+=o.x,t.y+=o.y,t.z+=o.z,i++)}i>0?(t.x/=i,t.y/=i,t.z/=i,o.location=t,o.xyManipulation.available=!0,o.xyAxisManipulation.available=!0,o.zManipulation.available=n):o.available=!1},n.buildDragEventPipeline=function(e,t,i,n,a,o){const r=[],s=[];let l=null,p=null;const c=()=>{for(const e of r)e.dragging=!1;r.length=0,s.length=0,l=null,p=null,this._moveManipulation.interactive=!0};if(1===e.length&&0===t){const t=e[0].graphic;n=this.buildSnappingPipelineSteps(t,m.getGraphicEffectiveElevationInfo(t),n,a,o)}const h=n.next((t=>{if("start"===t.action){r.length=0,s.length=0;for(const t of e)t.dragging||!t.manipulationXY.hasManipulator(i)&&t.manipulationXY.grabbing||(r.push(t),s.push(t.graphic),t.dragging=!0);if(0!==s.length&&(this._moveManipulation.interactive=!1,l=E.dragGraphicMany(s),p=E.resetGraphicMany(s),this.emit("graphic-move-start",new H(s)),this.destroyed))return null}return 0!==s.length?t:null})).next((e=>l(e))).next((e=>{switch(e.action){case"start":case"update":if(e.translationX||e.translationY||e.translationZ){const t=this.view.toScreen(e.mapStart),i=this.view.toScreen(e.mapEnd),n=i.x-t.x,a=i.y-t.y;if(this.emit("graphic-move",new X(n,a,s)),this.destroyed)return null}break;case"end":if(this.emit("graphic-move-stop",new Y(s)),this.destroyed)return null;c()}}));return a.next((e=>p(e))).next((()=>{if(this.emit("graphic-move-stop",new Y(s)),this.destroyed)return null;c()})),h},n.buildSnappingPipelineSteps=function(e,t,i,n,o){const r=e.geometry;if(a.isNone(r)||"point"!==r.type)return i;const s=new _.SnappingContext({elevationInfo:t,pointer:o,geometry:new y.EditGeometryHelper(f.EditGeometry.fromGeometry(r,this.view.viewingMode),"point"),visualizer:new G.SnappingVisualizer3D,excludeFeature:e}),l=this.snappingManager;return i.next((t=>{const i=r.clone();i.z=m.getConvertedElevation(this.view,i,m.getGraphicEffectiveElevationInfo(e),{mode:"absolute-height",offset:0});return{...t,snapOrigin:s.coordinateHelper.fromPoint(i)}})).next(this.snappingPipeline.createSnapDragEventPipelineStep({snappingContext:s,snappingManager:l,cancel:n}),this.snappingPipeline.next)},i}(d.EventedMixin(S.InteractiveToolBase)),i.__decorate([l.property({constructOnly:!0,nonNullable:!0})],e.GraphicMoveTool.prototype,"view",void 0),i.__decorate([l.property({readOnly:!0})],e.GraphicMoveTool.prototype,"graphics",void 0),i.__decorate([l.property({constructOnly:!0,nonNullable:!0})],e.GraphicMoveTool.prototype,"enableZ",void 0),i.__decorate([l.property({constructOnly:!0})],e.GraphicMoveTool.prototype,"snappingManager",void 0),i.__decorate([l.property({readOnly:!0})],e.GraphicMoveTool.prototype,"type",void 0),e.GraphicMoveTool=i.__decorate([p.subclass("esri.views.3d.interactive.editingTools.graphicMove3D.GraphicMoveTool")],e.GraphicMoveTool);let R=function(){function e(e){this.state=null,this.geometryRepresentation=null,this.manipulationXY=null,this.dragging=!1,this.state=new A.GraphicState({graphic:e})}return t._createClass(e,[{key:"graphic",get:function(){return this.state.graphic}}]),e}();e.GraphicMoveEvent=X,e.GraphicMoveStartEvent=H,e.GraphicMoveStopEvent=Y,Object.defineProperty(e,"__esModule",{value:!0})}));
