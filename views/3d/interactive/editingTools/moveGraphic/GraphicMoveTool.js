/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../core/has","../../../../../core/maybe","../../../../../core/Logger","../../../../../core/accessorSupport/ensureType","../../../../../core/handleUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/urlUtils","../../../../../core/uuid","../../../../../portal/support/resourceExtension","../../../../../core/Evented","../../../../../core/Collection","../../../../../core/Handles","../../../../../support/elevationInfoUtils","../../../../../layers/graphics/dehydratedFeatures","../../../../interactive/dragEventPipeline","../../../../interactive/InteractiveToolBase","../../manipulatorUtils","./isSupportedGraphic","../manipulatorUtils","../../visualElements/OutlineVisualElement","../../../layers/graphics/GraphicState","../visualElementUtils","../manipulations/config","../manipulations/moveUtils","../manipulations/MoveManipulation","../manipulations/MoveXYGraphicManipulation"],(function(e,t,i,a,n,o,s,r,l,p,h,c,u,d,v,g,m,M,f,y,_,w,b,E,G,x,S,A,D,T){"use strict";let k=function(e){this.allGraphics=e,this.type="graphic-move-start"},O=function(e,t,i){this.dx=e,this.dy=t,this.allGraphics=i,this.type="graphic-move"},P=function(e){this.allGraphics=e,this.type="graphic-move-stop"};e.GraphicMoveTool=function(e){function i(t){var i;return(i=e.call(this,t)||this).graphics=new v,i.enableZ=!0,i.type="move-3d",i._toolHandles=new g,i._handles=new g,i}t._inheritsLoose(i,e);var a=i.prototype;return a.initialize=function(){this._toolHandles.add([this.graphics.on("change",(()=>this._refreshManipulators()))]),this._refreshManipulators()},a.destroy=function(){this._handles.destroy(),this._handles=null,this._toolHandles.destroy(),this._toolHandles=null,this.graphics.removeAll(),this._set("view",null)},a.reset=function(){},a._refreshManipulators=function(){this._handles.removeAll(),this._moveManipulation&&this._moveManipulation.destroy(),this.manipulators.removeAll();const e=this.graphics.toArray().filter((e=>0===w.isSupportedGraphic(e))).map((e=>new X(e)));e.length&&(this.createManipulators(e),this.createVisualElements(e),this._handles.add(e.map((e=>this.view.trackGraphicState(e.state)))),this.updateMoveManipulation(e))},a.createManipulators=function(e){for(const t of e){const i=t.state;t.manipulationXY=new T.MoveXYGraphicManipulation({tool:this,view:this.view,graphicState:i}),t.manipulationXY.forEachManipulator((e=>this._handles.add(e.events.on("immediate-click",(e=>{this.emit("immediate-click",{...e,graphic:i.graphic}),e.stopPropagation()}))))),this._handles.add(t.manipulationXY.createDragPipeline(((t,i,a)=>this.buildDragEventPipeline(t,i,a,e))))}this.createMoveManipulation(e)},a.createMoveManipulation=function(e){const t=new D.MoveManipulation({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:1===e.length?D.MoveManipulation.radiusForSymbol(e[0].graphic.symbol):S.DISC_RADIUS});this._moveManipulation=t,t.elevationInfo={mode:"absolute-height",offset:0},t.forEachManipulator((e=>{this._handles.add(e.events.on("immediate-click",(i=>{t.zManipulation.hasManipulator(e)||1!==this.graphics.length||this.emit("immediate-click",{...i,graphic:this.graphics.getItemAt(0)}),i.stopPropagation()})))}));const i=()=>this.updateMoveManipulation(e);for(const t of e)this._handles.add([t.state.on("changed",i),t.state.watch("displaying",i)]);const a=e[e.length-1];this._handles.add(a.state.on("changed",(()=>this.updateMoveManipulationAngle(a)))),this._handles.add(t.createDragPipeline(((t,i,a)=>{this.buildDragEventPipeline(t,i,a,e)}),m.getGraphicEffectiveElevationInfo(a.graphic),n.unwrap(a.graphic.geometry).spatialReference)),this.updateMoveManipulationAngle(a)},a.createVisualElements=function(e){for(const t of e){const i=t.graphic,a=x.createVisualElements({view:this.view,graphic:i,forEachManipulator:e=>{t.manipulationXY.forEachManipulator(e),this._moveManipulation.forEachManipulator(e)},onManipulatorsChanged:()=>r.makeHandle()});t.geometryRepresentation=a.visualElement,t.geometryRepresentation instanceof E.OutlineVisualElement&&this._handles.add([t.geometryRepresentation.events.on("attachment-origin-changed",(()=>{t.state.isDraped||this.updateMoveManipulation(e)})),t.state.watch("isDraped",(()=>this.updateMoveManipulation(e)))]),this._handles.add(a)}},a.updateMoveManipulationAngle=function(e){this._moveManipulation.angleDeferred=()=>A.primaryShapeOrientation(e.graphic.geometry)},a.updateMoveManipulation=function(e){const t=M.makeDehydratedPoint(0,0,0,this.view.spatialReference);let i=0,a=!1;const o=this._moveManipulation;for(const o of e){if(!o.state.displaying)continue;const e=o.state.graphic;this.enableZ&&b.canMoveZ(e)&&(a=!0);const s=o.geometryRepresentation instanceof E.OutlineVisualElement&&!o.state.isDraped?o.geometryRepresentation.attachmentOrigin:_.getGraphicAttachmentOrigin(this.view,e);n.isSome(s)&&(t.x+=s.x,t.y+=s.y,t.z+=s.z,i++)}i>0?(t.x/=i,t.y/=i,t.z/=i,o.location=t,o.xyManipulation.available=!0,o.xyAxisManipulation.available=!0,o.zManipulation.available=a):o.available=!1},a.buildDragEventPipeline=function(e,t,i,a){const n=[],o=[];let s=null,r=null;const l=()=>{for(const e of n)e.dragging=!1;n.length=0,o.length=0,s=null,r=null,this._moveManipulation.interactive=!0};t.next((t=>{if("start"===t.action){n.length=0,o.length=0;for(const t of a)t.dragging||!t.manipulationXY.hasManipulator(e)&&t.manipulationXY.grabbing||(n.push(t),o.push(t.graphic),t.dragging=!0);if(0!==o.length&&(this._moveManipulation.interactive=!1,s=f.dragGraphicMany(o),r=f.resetGraphicMany(o),this.emit("graphic-move-start",new k(o)),this.destroyed))return null}return 0!==o.length?t:null})).next((e=>s(e))).next((e=>{switch(e.action){case"start":case"update":if(e.translationX||e.translationY||e.translationZ){const t=this.view.toScreen(e.mapStart),i=this.view.toScreen(e.mapEnd),a=i.x-t.x,n=i.y-t.y;if(this.emit("graphic-move",new O(a,n,o)),this.destroyed)return null}break;case"end":if(this.emit("graphic-move-stop",new P(o)),this.destroyed)return null;l()}})),i.next((e=>r(e))).next((()=>{if(this.emit("graphic-move-stop",new P(o)),this.destroyed)return null;l()}))},i}(d.EventedMixin(y.InteractiveToolBase)),i.__decorate([l.property({constructOnly:!0,nonNullable:!0})],e.GraphicMoveTool.prototype,"view",void 0),i.__decorate([l.property({readOnly:!0})],e.GraphicMoveTool.prototype,"graphics",void 0),i.__decorate([l.property({constructOnly:!0,nonNullable:!0})],e.GraphicMoveTool.prototype,"enableZ",void 0),i.__decorate([l.property({readOnly:!0})],e.GraphicMoveTool.prototype,"type",void 0),e.GraphicMoveTool=i.__decorate([p.subclass("esri.views.3d.interactive.editingTools.graphicMove3D.GraphicMoveTool")],e.GraphicMoveTool);let X=function(){function e(e){this.state=null,this.geometryRepresentation=null,this.manipulationXY=null,this.dragging=!1,this.state=new G.GraphicState({graphic:e})}return t._createClass(e,[{key:"graphic",get:function(){return this.state.graphic}}]),e}();e.GraphicMoveEvent=O,e.GraphicMoveStartEvent=k,e.GraphicMoveStopEvent=P,Object.defineProperty(e,"__esModule",{value:!0})}));
