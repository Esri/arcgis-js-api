/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../core/arrayUtils","../../../../../core/has","../../../../../core/Evented","../../../../../core/HandleOwner","../../../../../core/Handles","../../../../../core/handleUtils","../../../../../core/maybe","../../../../../core/quantityUtils","../../../../../core/reactiveUtils","../../../../../core/unitUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/accessorSupport/ensureType","../../../../../core/accessorSupport/decorators/subclass","../../../../../chunks/mat4f64","../../../../../chunks/vec3","../../../../../chunks/vec3f64","../../../../../geometry/Polyline","../../../../../geometry/support/plane","../../../../../geometry/support/vectorStacks","../../../../../layers/graphics/dehydratedFeatures","../../../../../support/elevationInfoUtils","../../../../../symbols/support/utils","../../Manipulator3D","../../manipulatorUtils","../../SegmentLabels3D","../../SnappingVisualizer3D","../dragEventPipeline3D","../ManipulatorType","../manipulatorUtils","../settings","../visualElementUtils","../manipulations/config","../manipulations/MoveManipulation","../manipulations/moveUtils","../manipulations/MoveXYGraphicManipulation","./edgeOffsetUtils","../../visualElements/OutlineVisualElement","../../../layers/graphics/GraphicState","../../../webgl-engine/lib/GeometryUtil","../../../../input/IViewEvents","../../../../interactive/dragEventPipeline","../../../../interactive/interfaces","../../../../interactive/editGeometry/EditGeometryOperations","../../../../interactive/editGeometry/interfaces","../../../../interactive/snapping/SnappingContext","../../../../interactive/snapping/SnappingDragPipelineStep","../../../../interactive/tooltip/ReshapeTooltipInfos","../../../../interactive/tooltip/Tooltip","../../../../interactive/tooltip/TranslateTooltipInfos","../../../../support/automaticAreaMeasurementUtils","../../../../support/automaticLengthMeasurementUtils","../../../../support/euclideanLengthMeasurementUtils","../../../../support/geodesicLengthMeasurementUtils"],(function(e,t,i,a,n,o,r,s,l,p,u,h,d,c,g,m,_,f,M,v,y,O,x,S,b,E,G,T,w,I,V,D,A,H,L,P,N,k,R,F,U,C,z,X,Z,Y,B,q,j,W,K,J,Q,$,ee,te){"use strict";function ie(e,t){return Math.atan2(t[1]-e[1],t[0]-e[0])+Math.PI/2}function ae(e,t,i,a,n){if(e){const e=n.toXYZ(n.pointToVector(i)),o=y.projectPoint(a,e,O.sv3d.get()),r=te.geodesicDistance(o,e,n.spatialReference);if(p.isSome(r))return u.createLength(r.value*Math.sign(t),r.unit)}return u.createLength(t*d.getMetersPerUnitForSR(i.spatialReference),"meters")}e.ReshapeOperation=function(e){function i(t){var i;return(i=e.call(this,t)||this)._vertexManipulatorMaterial=G.createManipulatorMaterial(A.settings.colorToVec4(A.settings.reshapeManipulators.vertex.color),A.settings.reshapeManipulators.vertex.renderOccluded),i._vertexManipulatorOutlineMaterial=G.createManipulatorOutlineMaterial(A.settings.colorToVec4(A.settings.reshapeManipulators.vertex.outlineColor),A.settings.reshapeManipulators.vertex.renderOccluded),i._vertexManipulatorHoverOutlineMaterial=G.createManipulatorOutlineMaterial(A.settings.colorToVec4(A.settings.reshapeManipulators.vertex.hoverOutlineColor),A.settings.reshapeManipulators.vertex.renderOccluded),i._edgeManipulatorMaterial=G.createManipulatorMaterial(A.settings.colorToVec4(A.settings.reshapeManipulators.edge.color),A.settings.reshapeManipulators.edge.renderOccluded),i._edgeManipulatorOutlineMaterial=G.createManipulatorOutlineMaterial(A.settings.colorToVec4(A.settings.reshapeManipulators.edge.outlineColor),A.settings.reshapeManipulators.edge.renderOccluded),i._edgeOffsetManipulatorMaterial=G.createManipulatorMaterial(A.settings.colorToVec4(A.settings.reshapeManipulators.edgeOffset.color),A.settings.reshapeManipulators.edgeOffset.renderOccluded,!1),i._edgeOffsetManipulatorHoverMaterial=G.createManipulatorMaterial(A.settings.colorToVec4(A.settings.reshapeManipulators.edgeOffset.hoverColor),A.settings.reshapeManipulators.edgeOffset.renderOccluded,!1),i._selectedManipulatorMaterial=G.createManipulatorMaterial(A.settings.colorToVec4(A.settings.reshapeManipulators.selected.color),A.settings.reshapeManipulators.selected.renderOccluded),i._selectedManipulatorOutlineMaterial=G.createManipulatorOutlineMaterial(A.settings.colorToVec4(A.settings.reshapeManipulators.selected.outlineColor),A.settings.reshapeManipulators.selected.renderOccluded),i._selectedManipulatorHoverOutlineMaterial=G.createManipulatorOutlineMaterial(A.settings.colorToVec4(A.settings.reshapeManipulators.selected.hoverOutlineColor),A.settings.reshapeManipulators.selected.renderOccluded),i._selectedIndex=0,i._vertexManipulatorGeometry=null,i._vertexManipulatorOutlineGeometry=null,i._edgeManipulatorGeometry=null,i._edgeManipulatorOutlineGeometry=null,i._edgeOffsetManipulatorGeometryInside=null,i._edgeOffsetManipulatorGeometryOutside=null,i._manipulatorHandles=new s,i._manipulatorInfos=[],i._editGeometryOperations=null,i._numGrabbing=0,i._numDragging=0,i._reshapeEventState=le.NONE,i._outlineVisualElement=null,i._segmentLabels=null,i.outputGeometry=null,i._snappingPipeline=new j.SnappingPipeline,i._snappingPipelineHandle=new j.SnappingPipeline,i._vertexLaserLineVisualElement=null,i}t._inheritsLoose(i,e);var n=i.prototype;return n.initialize=function(){const{graphic:e,view:t}=this,i=this._graphicState=new U.GraphicState({graphic:e});this._tooltip=new K.Tooltip({view:t}),this.addHandles([h.watch((()=>i.displaying),(e=>{for(const t of this._manipulatorInfos)t.manipulator.available=e})),h.watch((()=>({labels:this._segmentLabels,enabled:this._labelOptions.enabled,edgeOffsetEnabled:this.enableEdgeOffset})),(({labels:e,enabled:t,edgeOffsetEnabled:i})=>{p.isSome(e)&&(e.visible=t,e.edgeDistance=i?"far":"default")}),h.initial),h.when((()=>!this._tooltipOptions.enabled),(()=>this._tooltip.clear()),h.initial),this.view.trackGraphicState(i)])},n.destroy=function(){this._segmentLabels=p.destroyMaybe(this._segmentLabels),this._tooltip=p.destroyMaybe(this._tooltip),this._removeManipulators()},n.removeSelectedVertices=function(){const e=this._manipulatorInfos.filter((e=>e.manipulator.selected&&"vertex"===e.type));this._removeVertices(e)},n.onManipulatorSelectionChanged=function(){this.emit("manipulators-changed")},n._removeManipulators=function(){this._manipulatorHandles.removeAll(),this._moveManipulation=p.destroyMaybe(this._moveManipulation),this._graphicMoveManipulation=p.destroyMaybe(this._graphicMoveManipulation),this.manipulators.removeAll(),this._manipulatorInfos=[],this._numGrabbing=0,this._numDragging=0},n._createManipulators=function(){if(p.isNone(this._editGeometryOperations))return;const e=S.getGraphicEffectiveElevationInfo(this.graphic);for(const t of this._editGeometryOperations.data.components){for(const i of t.vertices)this._createVertexOrEdgeManipulator(i,e);for(const i of t.edges)this._createVertexOrEdgeManipulator(i,e)}this._createGraphicMoveManipulation(),this._createMoveManipulation(e),this._createVisualElements()},n.redo=function(){if(p.isNone(this._editGeometryOperations))return null;const e=this._editGeometryOperations.redo();return p.isSome(e)&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),e},n.undo=function(){if(p.isNone(this._editGeometryOperations))return null;this.emit("undo");const e=this._editGeometryOperations.undo();return p.isSome(e)&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),e},n._recreateManipulators=function(){this._removeManipulators(),this._tooltip.clear(),this._createManipulators()},n._recreateEditGeometryAndManipulators=function(e=this.inputGeometry){this._removeManipulators(),this._tooltip.clear(),p.isNone(e)||(p.destroyMaybe(this._editGeometryOperations),this._editGeometryOperations=Y.EditGeometryOperations.fromGeometry(e,this.view.state.viewingMode),this._createManipulators(),p.destroyMaybe(this._segmentLabels),this._segmentLabels=new T.SegmentLabels3D({context:{view:this.view,editGeometryOperations:this._editGeometryOperations,elevationInfo:S.getGraphicEffectiveElevationInfo(this.graphic),labelOptions:this._labelOptions,graphic:this.graphic,graphicState:this._graphicState},visible:this._labelOptions.enabled}))},n._perGraphicManipulatorDragAction=function(e,t){if("end"===t.action)return t;let i=0;const a=[],n=this._manipulatorInfos.some((e=>"vertex"===e.type&&e.manipulator.selected)),o=e===pe.SELECTED_OR_ALL&&n;for(const r of this._manipulatorInfos)"vertex"===r.type&&(r.manipulator.grabbing||o&&!r.manipulator.selected||a.push(r),i++);if(0===a.length)return t;this._moveVertices(a,t);if(a.length===i){if(this._updateEventState(le.MOVING),this.destroyed)return t;this.emit("move",{type:"move",dx:t.screenDeltaX,dy:t.screenDeltaY,mover:this.graphic})}else{if(this._updateEventState(le.RESHAPING),this.destroyed)return t;this.emit("reshape",{type:"reshape",mover:this.graphic})}return t},n._isMultiVertexSelection=function(){let e=0;for(const t of this._manipulatorInfos)"vertex"===t.type&&t.manipulator.selected&&e++;return e>1},n._perVertexManipulatorDragAction=function(e){if(this._updateEventState(le.RESHAPING),this.destroyed)return;const{mapDeltaX:t,mapDeltaY:i,mapDeltaZ:a}=e;if(!t&&!i&&!a)return;const n=[];for(const o of this._manipulatorInfos)"vertex"===o.type&&(o.manipulator.selected&&!o.manipulator.grabbing||o===e.info)&&n.push(o);this._moveVertices(n,e,B.AccumulationBehaviour.ACCUMULATE_STEPS),this.emit("reshape",{type:"reshape",mover:this.graphic})},n._updateEventState=function(e){if(e===this._reshapeEventState)return!1;switch(e){case le.NONE:if(0!==this._numGrabbing||0!==this._numDragging)return!1;switch(this._reshapeEventState){case le.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic});break;case le.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic})}break;case le.MOVING:switch(this._reshapeEventState){case le.NONE:this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic});break;case le.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic}),this.destroyed||this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic})}break;case le.RESHAPING:switch(this._reshapeEventState){case le.NONE:this.emit("reshape",{type:"reshape-start",mover:this.graphic});break;case le.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic}),this.destroyed||this.emit("reshape",{type:"reshape-start",mover:this.graphic})}}if(this.destroyed)return!1;const t=this._reshapeEventState!==e;return this._reshapeEventState=e,t},n._createGraphicMoveManipulation=function(){const{tool:e,view:t}=this,i=this._graphicState;if(this._graphicMoveManipulation=new k.MoveXYGraphicManipulation({tool:e,view:t,graphicState:i}),this.enableMoveGraphic){let e=null;this._manipulatorHandles.add(this._graphicMoveManipulation.createDragPipeline(((t,i,a)=>{i.next((e=>this._trackNumDragging(e))).next((t=>("start"===t.action&&(e=p.unwrap(this._editGeometryOperations).createUndoGroup()),t))).next((e=>this._perGraphicManipulatorDragAction(pe.ALL,e))).next((e=>(this._updateTranslateGraphicTooltip(P.ManipulationType.XY,e),e))).next((t=>{"end"===t.action&&(this._tooltip.clear(),e=p.removeMaybe(e))})),a.next((()=>this._onDragCancel(!0,(()=>e=p.removeMaybe(e)))))}))),this._graphicMoveManipulation.forEachManipulator((e=>this._manipulatorHandles.add(this._watchAndUpdateGrabState(e,!1))))}else this._graphicMoveManipulation.forEachManipulator((e=>{e.grabbable=!1,e.cursor=null}));this._graphicMoveManipulation.forEachManipulator((e=>this._manipulatorHandles.add(e.events.on("immediate-click",(e=>{this._manipulatorInfos.some((e=>e.manipulator.selected))?this._clearSelection():this.emit("immediate-click",{...e,graphic:this.graphic}),e.stopPropagation()})))))},n._createMoveManipulation=function(e){const{graphic:t,handles:i,tool:a,view:n}=this,o=this._graphicState;this._moveManipulation=new P.MoveManipulation({tool:a,view:n,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZShape&&D.canMoveZ(t),snapToScene:!1,radius:P.MoveManipulation.radiusForSymbol(t.symbol)}),this._moveManipulation.forEachManipulator((e=>i.add([e.events.on("immediate-click",(i=>{this._moveManipulation.zManipulation.hasManipulator(e)||this._manipulatorInfos.some((e=>e.manipulator.selected))||this.emit("immediate-click",{...i,graphic:t}),i.stopPropagation()})),this._watchAndUpdateGrabState(e,!1)])));const r=e=>t=>{i.add(t.events.on("focus-changed",(({action:t})=>{"focus"===t&&this._tooltipOptions.enabled?this._updateTranslateTooltip(e):this._tooltip.clear()})))};this._moveManipulation.xyManipulation.forEachManipulator(r(P.ManipulationType.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(r(P.ManipulationType.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(r(P.ManipulationType.Z)),this._moveManipulation.elevationInfo={mode:"absolute-height",offset:0};const s=p.unwrap(t.geometry).spatialReference;i.add([this._moveManipulation.createDragPipeline(((i,n,o,r,s)=>{r=r.next((e=>(this._onDragCancel(),e)));return o.next((e=>this._trackNumDragging(e))).next((e=>{const t=this._manipulatorInfos.filter((e=>"vertex"===e.type&&e.manipulator.selected));return e.manipulatorType===V.ManipulatorType.TRANSLATE_XY&&1===t.length?{...e,info:t[0],snapOrigin:t[0].handle.pos}:e})).next(X.sceneSnappingAtLocation(this.view,e,t)).next(this._snappingPipelineHandle.createSnapDragEventPipelineStep({predicate:e=>!!e.info,cancel:r,snappingManager:a.snappingManager,snappingContext:new q.SnappingContext({editGeometryOperations:p.unwrap(this._editGeometryOperations),elevationInfo:e,pointer:s,excludeFeature:t,visualizer:new w.SnappingVisualizer3D}),updatingHandles:this.updatingHandles,useZ:!1}),this._snappingPipelineHandle.next).next(X.addMapDelta()).next((e=>this._perGraphicManipulatorDragAction(pe.SELECTED_OR_ALL,e))).next((e=>(this._updateTranslateTooltip(i,e),e)))}),e,s,t),h.watch((()=>o.displaying),(()=>{this._updateMoveManipulationPosition()}),h.initial),o.on("changed",(()=>this._updateMoveManipulationPosition())),h.watch((()=>o.isDraped),(e=>{this._updateMoveManipulationPosition();const t="align-move-manipulation";e?i.add(this.view.elevationProvider.on("elevation-change",(()=>this._updateMoveManipulationPosition())),t):i.remove(t)}),h.initial)])},n._createVisualElements=function(){const{graphic:e,view:t}=this,i=H.createVisualElements({view:t,graphic:e,forEachManipulator:e=>{if(!this.destroyed){this._graphicMoveManipulation.forEachManipulator(e),this._moveManipulation.forEachManipulator(e);for(const t of this._manipulatorInfos)e(t.manipulator,V.ManipulatorType.TRANSLATE_XY)}},onManipulatorsChanged:e=>this.on("manipulators-changed",e)});p.isSome(i)&&(this._outlineVisualElement=i.visualElement instanceof F.OutlineVisualElement?i.visualElement:null),p.isSome(this._outlineVisualElement)&&this._manipulatorHandles.add(this._outlineVisualElement.events.on("attachment-origin-changed",(()=>{this._graphicState.isDraped||this._updateMoveManipulationPosition()}))),this._manipulatorHandles.add(i)},n._createEdgeOffsetManipulator=function(e,t=S.getGraphicEffectiveElevationInfo(this.graphic)){const i=A.settings.reshapeManipulators.edgeOffset,a=i.size/2,n=a+i.collisionPadding;if(p.isNone(this._edgeOffsetManipulatorGeometryInside)||p.isNone(this._edgeOffsetManipulatorGeometryOutside)){const e=a/n,t=e*Math.sqrt(3)/2;this._edgeOffsetManipulatorGeometryInside=C.createExtrudedTriangle(t,e/2,e/2,i.height,i.offset),this._edgeOffsetManipulatorGeometryOutside=C.createExtrudedTriangle(-t,e/2,e/2,i.height,-i.offset)}const o=[{geometry:this._edgeOffsetManipulatorGeometryInside,material:this._edgeOffsetManipulatorMaterial,stateMask:Z.ManipulatorStateFlags.Unfocused},{geometry:this._edgeOffsetManipulatorGeometryInside,material:this._edgeOffsetManipulatorHoverMaterial,stateMask:Z.ManipulatorStateFlags.Focused},{geometry:this._edgeOffsetManipulatorGeometryOutside,material:this._edgeOffsetManipulatorMaterial,stateMask:Z.ManipulatorStateFlags.Unfocused},{geometry:this._edgeOffsetManipulatorGeometryOutside,material:this._edgeOffsetManipulatorHoverMaterial,stateMask:Z.ManipulatorStateFlags.Focused}],r=new E.Manipulator3D({view:this.view,renderObjects:o,elevationInfo:"on-the-ground"!==t.mode||b.isVolumetricSymbol(this.graphic.symbol)?{mode:"absolute-height",offset:0}:t,worldOriented:!1,focusMultiplier:1,radius:n,available:!(!this.graphic.visible||!this.graphic.layer.visible),collisionType:{type:"disc",direction:M.fromValues(0,0,1)},collisionPriority:1,metadata:{deleting:!1}}),s=new E.Manipulator3D({view:this.view,renderObjects:[],worldSized:!0,worldOriented:!1,available:!(!this.graphic.visible||!this.graphic.layer.visible),collisionPriority:-10,cursor:this.enableMoveGraphic?"move":"default",metadata:{deleting:!1}}),u={manipulator:r,handle:e,locationUpdateHandle:null,type:"edge",selectedIndex:0,edgeManipulator:s,elevationInfo:t,visibilityHandle:null};this._autoHideEdgeOffsetManipulator(u,i.minSquaredEdgeLength),this._updateEdgeOffsetManipulator(u);const h=[];for(const l of[u.handle.leftVertex,u.handle.rightVertex]){const e=this._getManipulatorInfoFromHandle(l);p.isSome(e)&&h.push(e.manipulator.events.on("location-update",(()=>this._updateEdgeOffsetManipulator(u))))}u.locationUpdateHandle=l.handlesGroup(h),this._manipulatorHandles.add(u.locationUpdateHandle,r),this._manipulatorHandles.add([this._watchAndUpdateGrabState(r,!0),this._watchAndUpdateGrabState(s,!0)],r),this._manipulatorHandles.add(X.createManipulatorDragEventPipeline(r,this._createEdgeOffsetPipeline(u,t)),r),this._manipulatorHandles.add(X.createManipulatorDragEventPipeline(s,((e,i,a,n)=>{if("touch"===n){this._createEdgeOffsetPipeline(u,t)(e,i,a)}else if(this.enableMoveGraphic){const n=this.graphic,o=p.isSome(n.geometry)?n.geometry.spatialReference:null;i.next((e=>this._trackNumDragging(e))).next(X.dragAtLocation(this.view,e.elevationAlignedLocation)).next(I.screenToMapXYAtLocation(this.view,e.elevationAlignedLocation,t,o,n)).next(X.addScreenDelta()).next(X.addMapDelta()).next((e=>this._perGraphicManipulatorDragAction(pe.ALL,e))).next((e=>(this._updateTranslateGraphicTooltip(P.ManipulationType.XY,e),e))).next((e=>{"end"===e.action&&this._tooltip.clear()})),a.next((()=>this._onDragCancel(!e.metadata.deleting)))}})),r);const d=e=>{this._manipulatorInfos.some((e=>e.manipulator.selected))?this._clearSelection():this.emit("immediate-click",{...e,graphic:this.graphic}),e.stopPropagation()};return this._manipulatorHandles.add([r.events.on("immediate-click",d),s.events.on("immediate-click",d),r.events.on("focus-changed",(({action:e})=>{const t=this._tooltipOptions;if("focus"===e&&t.enabled){const e=this._tooltip.info=new W.ReshapeEdgeOffsetTooltipInfo({tooltipOptions:t});this._updateTooltipAreaOrTotalLength(e)}else this._tooltip.clear()}))],r),this._manipulatorInfos.push(u),this.manipulators.add(r),this.manipulators.add(s),this.emit("manipulators-changed"),u},n._autoHideEdgeOffsetManipulator=function(e,t){const i=e.manipulator,a=e.edgeManipulator,n=()=>{e.visibilityHandle=p.removeMaybe(e.visibilityHandle);const n=this._getManipulatorInfoFromHandle(e.handle.leftVertex),o=this._getManipulatorInfoFromHandle(e.handle.rightVertex),r=p.isSome(n)&&p.isSome(o)&&R.screenEdgeLengthSquared(n.manipulator.renderLocation,o.manipulator.renderLocation,this.view.state.camera)<t;(!i.focused&&!a.focused||r)&&(i.grabbable=!r,a.grabbable=!r,e.visibilityHandle=l.handlesGroup([i.disableDisplay(),{remove:()=>{i.grabbable=!0,a.grabbable=this.enableMoveGraphic}}]))};this._manipulatorHandles.add([i.events.on("focus-changed",n),a.events.on("focus-changed",n),{remove:()=>{p.removeMaybe(e.visibilityHandle),a.metadata.deleting=!0,this.manipulators.remove(a)}}],i),n()},n._updateEdgeOffsetManipulator=function(e){this._updateManipulatorPosition(e);const{coordinateHelper:t}=p.unwrap(this._editGeometryOperations).data,i=R.createEdgeOffsetIntersectionPlane(this.view,e.manipulator.elevationAlignedLocation,R.createEdgeOffsetOperation(t,e.handle,p.unwrap(e.manipulator.elevationInfo))),a=this._getManipulatorInfoFromHandle(e.handle.leftVertex),n=this._getManipulatorInfoFromHandle(e.handle.rightVertex);if(p.isNone(a)||p.isNone(n))return;const o=a.manipulator.renderLocation,r=n.manipulator.renderLocation,s=p.isSome(i)?R.edgeOffsetRotationMatrix(i,o,r):_.IDENTITY;e.manipulator.modelTransform=s,e.edgeManipulator.elevationAlignedLocation=e.manipulator.elevationAlignedLocation,e.edgeManipulator.modelTransform=s;const l=f.length(f.subtract(oe,o,r))/2;e.edgeManipulator.collisionType={type:"line",paths:[[[-l,0,0],[l,0,0]]]}},n._createEdgeOffsetPipeline=function(e,t){return(i,a,n)=>{this._clearSelection();const{step:o,cleanup:r}=this._initializeEdgeOffset(e,t);a.next((e=>this._trackNumDragging(e))).next(X.dragAtLocation(this.view,i.elevationAlignedLocation)).next(o).next(I.screenToRenderPlaneFromEvent(this.view)).next(I.convertToMapCoordinates(this.view,p.unwrap(this._editGeometryOperations).data.spatialReference)).next(X.addMapDelta()).next(this._applyComputeEdgeOffsetDistanceStep()).next(this._applyEdgeOffsetStep(e)).next(this._showEdgeOffsetTooltip()).next((e=>{"end"===e.action&&r()})),n.next((()=>{i.metadata.deleting||(r(),this._onDragCancel())}))}},n._initializeEdgeOffset=function(e,t){const i=p.unwrap(this._editGeometryOperations),a=R.createEdgeOffsetOperation(i.data.coordinateHelper,e.handle,t),n=i.createUndoGroup(),o=R.createEdgeOffsetIntersectionPlane(this.view,e.manipulator.elevationAlignedLocation,a);if(a.requiresSplitEdgeLeft){const t=this._getManipulatorInfoFromHandle(e.handle.leftVertex.leftEdge);p.isSome(t)&&this._splitEdgeManipulator(t,1)}if(a.requiresSplitEdgeRight){const t=this._getManipulatorInfoFromHandle(e.handle.rightVertex.rightEdge);p.isSome(t)&&this._splitEdgeManipulator(t,0)}const r=()=>new v({paths:[[e.handle.leftVertex.pos,e.handle.rightVertex.pos]],spatialReference:i.data.spatialReference}),s=new F.OutlineVisualElement({view:this.view,isDraped:this._graphicState.isDraped,geometry:r(),elevationInfo:e.elevationInfo,width:A.settings.visualElements.lineGraphics.outline.width,color:A.settings.colorToVec4(A.colors.main),attached:!0});let u;const d=()=>{this._cleanEdgeOffsetCollapsedEdges(e),u=p.removeMaybe(u)},c=this.on("undo",d);return u=l.handlesGroup([l.destroyHandle(s),h.watch((()=>this._graphicState.isDraped),(e=>s.isDraped=e)),this._graphicState.on("changed",(()=>s.geometry=r())),n,c]),{step:e=>p.isNone(a)||p.isNone(o)?(d(),null):{...e,operation:a,plane:o},cleanup:d}},n._applyEdgeOffsetStep=function(e){return t=>{if(this.destroyed||p.isNone(t.operation))return t;this._updateEventState(le.RESHAPING);const{mapDeltaX:i,mapDeltaY:a,mapDeltaZ:n}=t;return(i||a||n)&&(this._offsetEdge(e,t),this.emit("reshape",{type:"reshape",mover:this.graphic})),t}},n._applyComputeEdgeOffsetDistanceStep=function(){return e=>{const{operation:t,mapEnd:i}=e;return p.isNone(t)||p.isNone(i)?e:("start"===e.action&&t.selectArrowFromStartPoint(i),{...e,signedDistance:t.signedDistanceToPoint(i)})}},n._showEdgeOffsetTooltip=function(){return e=>{const{mapEnd:t,signedDistance:i,operation:a}=e,n=this._tooltip,o=this._tooltipOptions;if(!o.enabled||p.isNone(i))return n.clear(),e;let r=n.info;(p.isNone(r)||"reshape-edge-offset"!==r.type)&&(r=n.info=new W.ReshapeEdgeOffsetTooltipInfo({tooltipOptions:o}));const{coordinateHelper:s}=p.unwrap(this._editGeometryOperations).data;return r.distance="end"===e.action?u.zeroMeters:ae(this._graphicState.isDraped,i*a.selectedArrow,t,a.plane,s),this._updateTooltipAreaOrTotalLength(r),e}},n._cleanEdgeOffsetCollapsedEdges=function(e){const t=e.handle.leftVertex.leftEdge?.leftVertex,i=e.handle.leftVertex,a=e.handle.rightVertex.rightEdge?.rightVertex,n=e.handle.rightVertex,o=p.unwrap(this._editGeometryOperations).data.coordinateHelper,r=[];if(t&&o.distance(t.pos,i.pos)<re){const e=this._getManipulatorInfoFromHandle(i);p.isSome(e)&&r.push(e)}if(o.distance(i.pos,n.pos)<re||a&&o.distance(a.pos,n.pos)<re){const e=this._getManipulatorInfoFromHandle(n);p.isSome(e)&&r.push(e)}r.length&&this._removeVertices(r)},n._computeVertexManipulatorSizeAndOutline=function(e){const t=e.size/2,i=t+e.collisionPadding;return{size:t/i,outlineSize:(t+e.outlineSize)/i}},n._createVertexOrEdgeManipulator=function(e,t=S.getGraphicEffectiveElevationInfo(this.graphic)){if("edge"===e.type){if(this.enableEdgeOffset)return this._createEdgeOffsetManipulator(e,t);if(!this.enableMidpoints)return null}if(p.isNone(this._vertexManipulatorGeometry)||p.isNone(this._vertexManipulatorOutlineGeometry)){const{size:e,outlineSize:t}=this._computeVertexManipulatorSizeAndOutline(A.settings.reshapeManipulators.vertex);this._vertexManipulatorGeometry=C.createSphereGeometry(e,16,16),this._vertexManipulatorOutlineGeometry=C.createSphereGeometry(t,16,16)}if(p.isNone(this._edgeManipulatorGeometry)||p.isNone(this._edgeManipulatorOutlineGeometry)){const{size:e,outlineSize:t}=this._computeVertexManipulatorSizeAndOutline(A.settings.reshapeManipulators.edge);this._edgeManipulatorGeometry=C.createSphereGeometry(e,16,16),this._edgeManipulatorOutlineGeometry=C.createSphereGeometry(t,16,16)}const i=p.isSome(this.graphic.geometry)&&"point"===this.graphic.geometry.type?[]:[{geometry:this._vertexManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:se.Vertex|Z.ManipulatorStateFlags.Unselected},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorOutlineMaterial,stateMask:se.Vertex|Z.ManipulatorStateFlags.Unfocused|Z.ManipulatorStateFlags.Unselected},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:se.Vertex|Z.ManipulatorStateFlags.Focused|Z.ManipulatorStateFlags.Unselected},{geometry:this._vertexManipulatorGeometry,material:this._selectedManipulatorMaterial,stateMask:Z.ManipulatorStateFlags.Selected},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorOutlineMaterial,stateMask:Z.ManipulatorStateFlags.Selected|Z.ManipulatorStateFlags.Unfocused},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorHoverOutlineMaterial,stateMask:Z.ManipulatorStateFlags.Selected|Z.ManipulatorStateFlags.Focused}];this.enableMidpoints&&i.push({geometry:this._edgeManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:se.Edge|Z.ManipulatorStateFlags.Focused|Z.ManipulatorStateFlags.Unselected},{geometry:this._edgeManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:se.Edge|Z.ManipulatorStateFlags.Focused|Z.ManipulatorStateFlags.Unselected},{geometry:this._edgeManipulatorGeometry,material:this._edgeManipulatorMaterial,stateMask:se.Edge|Z.ManipulatorStateFlags.Unfocused|Z.ManipulatorStateFlags.Unselected},{geometry:this._edgeManipulatorOutlineGeometry,material:this._edgeManipulatorOutlineMaterial,stateMask:se.Edge|Z.ManipulatorStateFlags.Unfocused|Z.ManipulatorStateFlags.Unselected});const a=new E.Manipulator3D({view:this.view,renderObjects:i,elevationInfo:t,focusMultiplier:1,touchMultiplier:1,available:!(!this.graphic.visible||!this.graphic.layer.visible),metadata:{deleting:!1}});this._setTypeSpecificManipulatorSettings(a,e,t);const n="edge"===e.type?{manipulator:a,handle:e,locationUpdateHandle:null,type:"edge",selectedIndex:0}:{manipulator:a,handle:e,type:"vertex",selectedIndex:0};if(this._manipulatorInfos.push(n),this.manipulators.add(a),this._updateManipulatorPosition(n),"edge"===n.type){const e=[];for(const t of[n.handle.leftVertex,n.handle.rightVertex]){const i=this._getManipulatorInfoFromHandle(t);p.isSome(i)&&e.push(i.manipulator.events.on("location-update",(()=>this._updateManipulatorPosition(n))))}n.locationUpdateHandle=l.handlesGroup(e),this._manipulatorHandles.add(n.locationUpdateHandle,a)}this._manipulatorHandles.add(this._watchAndUpdateGrabState(a,!0),a);const o=X.createManipulatorDragEventPipeline(a,((e,i,a,o)=>{let r=null;a=a.next((t=>(this._onDragCancel(!e.metadata.deleting,(()=>r=p.removeMaybe(r))),t))),i.next((e=>this._trackNumDragging(e))).next((e=>{if("start"===e.action&&(r=p.unwrap(this._editGeometryOperations).createUndoGroup()),"edge"===n.type){const t=this._splitEdgeManipulator(n);return{...e,info:t,snapOrigin:t.handle.pos}}return{...e,info:n,snapOrigin:n.handle.pos}})).next(X.dragAtLocation(this.view,e.elevationAlignedLocation)).next(I.screenToMapXYForGraphicAtLocation(this.view,this.graphic,e.elevationAlignedLocation,e.location.spatialReference,this.graphic)).next(X.sceneSnappingAtLocation(this.view,t,this.graphic)).next(this._snappingPipeline.createSnapDragEventPipelineStep({predicate:()=>!this._isMultiVertexSelection(),cancel:a,snappingManager:this.tool.snappingManager,snappingContext:new q.SnappingContext({editGeometryOperations:p.unwrap(this._editGeometryOperations),elevationInfo:t,pointer:o,excludeFeature:this.graphic,visualizer:new w.SnappingVisualizer3D}),updatingHandles:this.updatingHandles,useZ:!1}),this._snappingPipeline.next).next(X.addMapDelta()).next((t=>{this._perVertexManipulatorDragAction(t),"end"===t.action&&(r=p.removeMaybe(r)),this._updateTranslateVertexTooltip(e,P.ManipulationType.XY,t)}))}));return this._manipulatorHandles.add([o,a.events.on("immediate-click",(e=>this._manipulatorClickCallback(e,n))),a.events.on("select-changed",(()=>{n.selectedIndex=++this._selectedIndex,this._updateMoveManipulationPosition()})),a.events.on("focus-changed",(({action:e})=>{"focus"===e&&"edge"!==n.type?this._updateTranslateVertexTooltip(a,P.ManipulationType.XY):this._tooltip.clear()}))],a),this.emit("manipulators-changed"),n},n._trackNumDragging=function(e){switch(e.action){case"start":this._numDragging++;break;case"end":this._numDragging--}return e},n._onDragCancel=function(e=!0,t){switch(this._numDragging--,e&&(this.undo(),this.outputGeometry=p.isSome(this._editGeometryOperations)?this._editGeometryOperations.data.geometry:null),p.isSome(this.tool.snappingManager)&&this.tool.snappingManager.doneSnapping(),this._tooltip.clear(),this._reshapeEventState){case le.NONE:break;case le.MOVING:this.emit("move",{type:"move",dx:0,dy:0,mover:this.graphic});break;case le.RESHAPING:this.emit("reshape",{type:"reshape",mover:this.graphic})}t&&t(),this.destroyed||this._updateEventState(le.NONE)},n._setTypeSpecificManipulatorSettings=function(e,t,i){switch(t.type){case"vertex":e.state=se.Vertex,e.selectable=!0,e.cursor="move",e.collisionPriority=2,e.radius=A.settings.reshapeManipulators.vertex.size/2+A.settings.reshapeManipulators.vertex.collisionPadding,e.elevationInfo=i,e.interactive=p.isSome(this.graphic.geometry)&&"point"!==this.graphic.geometry.type;break;case"edge":e.state=se.Edge,e.selectable=!1,e.cursor="copy",e.collisionPriority=-1,e.radius=A.settings.reshapeManipulators.edge.size/2+A.settings.reshapeManipulators.edge.collisionPadding,e.elevationInfo="on-the-ground"!==i.mode||b.isVolumetricSymbol(this.graphic.symbol)?{mode:"absolute-height",offset:0}:i}},n._watchAndUpdateGrabState=function(e,t){return e.events.on("grab-changed",(i=>this._onGrabStateChanged(e,t,i.action,i.pointerType)))},n._onGrabStateChanged=function(e,t,i,a="mouse"){if("start"===i)t&&this._updateSelection(e),this._numGrabbing++;else if(this._numGrabbing--,this._updateEventState(le.NONE),this.destroyed)return;this._moveManipulation.interactive=!this._numGrabbing,("touch"!==a||this.enableEdgeOffset)&&(this._manipulatorInfos.forEach((e=>{e.manipulator.interactive=e.manipulator.grabbing||!this._numGrabbing&&p.isSome(this.graphic.geometry)&&"point"!==this.graphic.geometry.type,"edgeManipulator"in e&&(e.edgeManipulator.interactive=e.edgeManipulator.grabbing||!this._numGrabbing)})),this._graphicMoveManipulation.forEachManipulator((e=>{e.interactive=e.grabbing||!this._numGrabbing})))},n._clearSelection=function(){for(const e of this._manipulatorInfos)e.manipulator.grabbing||(e.manipulator.selected=!1)},n._updateSelection=function(e){e.grabbing&&!e.selected&&e.selectable&&(this._clearSelection(),e.selected=!0,this.emit("manipulators-changed"))},n._removeManipulator=function(e){p.isNone(e)||(e.manipulator.metadata.deleting=!0,this.manipulators.remove(e.manipulator),this._manipulatorHandles.remove(e.manipulator),a.removeUnordered(this._manipulatorInfos,e),this.emit("manipulators-changed"))},n._getManipulatorInfoFromHandle=function(e){if(e)for(const t of this._manipulatorInfos)if(e===t.handle)return t;return null},n._updateManipulatorPosition=function(e){if(p.isNone(e))return;const t=p.unwrap(this._editGeometryOperations);if("vertex"===e.type)e.manipulator.location=t.data.coordinateHelper.vectorToDehydratedPoint(e.handle.pos,ne),e.manipulator.grabbing&&p.isSome(this._vertexLaserLineVisualElement)&&(this._vertexLaserLineVisualElement.visualElement.intersectsWorldUpAtLocation=e.manipulator.renderLocation);else if("edge"===e.type){const i=this._getManipulatorInfoFromHandle(e.handle.leftVertex),a=this._getManipulatorInfoFromHandle(e.handle.rightVertex);if(p.isNone(i)||p.isNone(a))return;const n=i.manipulator,o=a.manipulator;if(p.isSome(e.manipulator.elevationInfo)&&"on-the-ground"===e.manipulator.elevationInfo.mode){const i=n.location,a=o.location,r=.5,s=i.x+r*(a.x-i.x),l=i.y+r*(a.y-i.y),p=i.hasZ&&a.hasZ?0:void 0;e.manipulator.location=x.makeDehydratedPoint(s,l,p,t.data.spatialReference)}else f.lerp(oe,n.renderLocation,o.renderLocation,.5),e.manipulator.renderLocation=oe}},n._splitEdgeManipulator=function(e,t=.5){const i=p.unwrap(this._editGeometryOperations),a=p.unwrap(i.splitEdge(e.handle,t).createdVertex);e.locationUpdateHandle.remove(),e.locationUpdateHandle=void 0;const n=S.getGraphicEffectiveElevationInfo(this.graphic);let o;this.enableEdgeOffset?(this._removeManipulator(e),o=this._createVertexOrEdgeManipulator(a)):(o=e,o.handle=a,o.type="vertex",this._setTypeSpecificManipulatorSettings(e.manipulator,e.handle,n)),a.leftEdge&&this._createVertexOrEdgeManipulator(a.leftEdge),a.rightEdge&&this._createVertexOrEdgeManipulator(a.rightEdge),this.outputGeometry=i.data.geometry,this._updateManipulatorPosition(o),this.enableEdgeOffset||this._updateTranslateVertexTooltip(o.manipulator,P.ManipulationType.XY),this._updateSelection(e.manipulator);const r=this._updateEventState(le.RESHAPING),s=i.data.coordinateHelper.vectorToArray(o.handle.pos),l=i.data.components.indexOf(a.component);return this.emit("vertex-add",{type:"vertex-add",vertices:[{coordinates:s,componentIndex:l,vertexIndex:p.unwrap(a.index)}],added:s}),r&&this._updateEventState(le.NONE),o},n._updateMoveManipulationPosition=function(){const e=f.set(oe,0,0,0);let t=0,i=!1,a=null,n=null;for(const o of this._manipulatorInfos)"vertex"===o.type&&(o.manipulator.selected?(t++,f.add(e,e,o.manipulator.renderLocation),p.isNone(a)||o.selectedIndex>a.selectedIndex?(n=a,a=o):(p.isNone(n)||o.selectedIndex>n.selectedIndex)&&(n=o)):i=!0);if(0!==t){const e=this._graphicState.displaying;this._moveManipulation.xyManipulation.available=e,this._moveManipulation.xyAxisManipulation.available=e,this._moveManipulation.zManipulation.available=e&&this.enableZVertex&&D.canMoveZ(this.graphic),this._moveManipulation.xyAxisManipulation.orthogonalAvailable=e&&1!==t}else{const e=this._graphicState.displaying&&this.enableMoveGraphic;this._moveManipulation.xyManipulation.available=e,this._moveManipulation.xyAxisManipulation.available=e,this._moveManipulation.xyAxisManipulation.orthogonalAvailable=e,this._moveManipulation.zManipulation.available=e&&this.enableZShape&&D.canMoveZ(this.graphic)}if(0!==t){let e=0;if(p.isSome(a)){const t=a.handle.pos,i=p.isSome(n)?n.handle.pos:a.handle.leftEdge&&a.handle.leftEdge.leftVertex?a.handle.leftEdge.leftVertex.pos:null,o=p.isNone(n)&&a.handle.rightEdge&&a.handle.rightEdge.rightVertex?a.handle.rightEdge.rightVertex.pos:null;i&&o?this._moveManipulation.xyAxisManipulation.available=!1:i?e=ie(i,t):o&&(e=ie(t,o))}this._moveManipulation.angle=e,this._moveManipulation.radius=L.DISC_RADIUS_SMALL}else this._moveManipulation.angle=N.shapeOrientation(p.unwrap(this.graphic.geometry)),this._moveManipulation.radius=P.MoveManipulation.radiusForSymbol(this.graphic.symbol);0!==t&&i?(f.scale(e,e,1/t),ne.spatialReference=p.unwrap(this._editGeometryOperations).data.spatialReference,ne.hasZ=!0,this.view.renderCoordsHelper.fromRenderCoords(e,ne),this._moveManipulation.elevationAlignedLocation=ne):p.isSome(this._outlineVisualElement)&&!this._graphicState.isDraped&&p.isSome(this._outlineVisualElement.attachmentOrigin)?this._moveManipulation.elevationAlignedLocation=this._outlineVisualElement.attachmentOrigin:G.placeAtGraphic(this.view,this._moveManipulation,this.graphic)},n._removeVertices=function(e){const t=[],i=p.unwrap(this._editGeometryOperations);for(const a of e)if("vertex"===a.type&&i.canRemoveVertex()){t.push(a.handle),this._removeManipulator(a),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.leftEdge)),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.rightEdge));const e=p.unwrap(i.removeVertices([a.handle]).removedVertices[0].createdEdge);e&&this._createVertexOrEdgeManipulator(e)}if(t.length>0){const e=t.map((e=>{const t=i.data.components.indexOf(e.component);return{coordinates:i.data.coordinateHelper.vectorToArray(e.pos),componentIndex:t,vertexIndex:p.unwrap(e.index)}}));this.outputGeometry=i.data.geometry;const a=this._updateEventState(le.RESHAPING);if(this.destroyed)return;if(this.emit("vertex-remove",{type:"vertex-remove",removed:e.map((e=>e.coordinates)),vertices:e}),this.destroyed)return;if(a&&(this._updateEventState(le.NONE),this.destroyed))return;this._updateMoveManipulationPosition()}},n._moveVertices=function(e,t,i=("start"===t.action?B.AccumulationBehaviour.NEW_STEP:B.AccumulationBehaviour.ACCUMULATE_STEPS)){const a=p.unwrap(this._editGeometryOperations);a.moveVertices(e.map((e=>e.handle)),t.mapDeltaX,t.mapDeltaY,t.mapDeltaZ,i),this.outputGeometry=a.data.geometry;for(const n of e)this._updateManipulatorPosition(n)},n._offsetEdge=function(e,t){if(p.isNone(t.operation)||p.isNone(t.signedDistance))return;const i=p.unwrap(this._editGeometryOperations),a=t.operation.clone();a.distance=t.signedDistance,i.updateVertices([e.handle.leftVertex,e.handle.rightVertex],a),this.outputGeometry=i.data.geometry,this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(e.handle.leftVertex)),this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(e.handle.rightVertex))},n._manipulatorClickCallback=function(e,t){e.shiftKey||this._clearSelection(),"vertex"===t.type&&(t.manipulator.selected=!t.manipulator.selected,e.button===z.MouseButton.Right&&this._removeVertices([t])),"edge"===t.type&&e.button===z.MouseButton.Left&&this._splitEdgeManipulator(t),e.stopPropagation()},n._updateTranslateTooltip=function(e,t){const i=this._manipulatorInfos.filter((e=>"vertex"===e.type&&e.manipulator.selected));1===i.length?this._updateTranslateVertexTooltip(i[0].manipulator,e,t):this._updateTranslateGraphicTooltip(e,t)},n._updateTranslateGraphicTooltip=function(e,t){const i=this._tooltipOptions;if(!i.enabled)return;const a=this._graphicState.isDraped?"on-the-ground":"absolute-height";switch(e){case P.ManipulationType.XY:this._tooltip.info=new J.TranslateGraphicTooltipInfo({tooltipOptions:i}),this._updateTranslateTooltipDistance(this._tooltip.info,t,((e,t)=>$.autoHorizontalDistanceByElevationModeBetweenPoints(e,t,a)));break;case P.ManipulationType.XY_AXIS:this._tooltip.info=new J.TranslateGraphicXYTooltipInfo({tooltipOptions:i}),this._updateTranslateTooltipDistance(this._tooltip.info,t,((e,i)=>{const n=$.autoHorizontalDistanceByElevationModeBetweenPoints(e,i,a);return u.scale(n,N.axisConstrainedDragSign(t))}));break;case P.ManipulationType.Z:this._tooltip.info=new J.TranslateGraphicZTooltipInfo({tooltipOptions:i}),this._updateTranslateTooltipDistance(this._tooltip.info,t,ee.verticalSignedDistanceBetweenPoints)}},n._updateTranslateVertexTooltip=function(e,t,i){const a=this._tooltipOptions;if(!a.enabled)return;let n;const o=this._graphicState.isDraped?"on-the-ground":"absolute-height";switch(t){case P.ManipulationType.XY:n=new J.TranslateVertexTooltipInfo({tooltipOptions:a}),this._updateTranslateTooltipDistance(n,i,((e,t)=>$.autoHorizontalDistanceByElevationModeBetweenPoints(e,t,o))),this._updateTooltipAreaOrTotalLength(n);break;case P.ManipulationType.XY_AXIS:n=new J.TranslateVertexXYTooltipInfo({tooltipOptions:a}),this._updateTranslateTooltipDistance(n,i,((e,t)=>{const a=$.autoHorizontalDistanceByElevationModeBetweenPoints(e,t,o);return u.scale(a,N.axisConstrainedDragSign(i))})),this._updateTooltipAreaOrTotalLength(n);break;case P.ManipulationType.Z:n=new J.TranslateVertexZTooltipInfo({tooltipOptions:a}),this._updateTranslateTooltipDistance(n,i,ee.verticalSignedDistanceBetweenPoints)}const r=ee.elevationOfPoint(e.elevationAlignedLocation);p.isSome(r)&&(n.elevation={mode:"absolute-height",...r}),this._tooltip.info=n},n._updateTranslateTooltipDistance=function(e,t,i){if(p.isSome(t)&&"end"!==t.action){const{mapStart:a,mapEnd:n}=t,o=i(a,n);e.distance=p.isSome(o)?o:u.zeroMeters}},n._updateTooltipAreaOrTotalLength=function(e){const{geometry:t}=this.graphic;if(p.isNone(t))return;const i=this._graphicState.isDraped?"on-the-ground":"absolute-height";e.area="polygon"===t.type?Q.autoAreaByElevationMode(t,i):null,e.totalLength="polyline"===t.type?$.autoLengthByElevationMode(t,i):null},t._createClass(i,[{key:"inputGeometry",get:function(){return p.isSome(this._editGeometryOperations)?this._editGeometryOperations.data.geometry:null},set:function(e){this._recreateEditGeometryAndManipulators(e)}},{key:"updating",get:function(){return this.updatingHandles.updating}},{key:"manipulators",get:function(){return this.tool.manipulators}},{key:"view",get:function(){return this.tool.view}},{key:"graphic",get:function(){return this.tool.graphic}},{key:"enableZShape",get:function(){return this.tool.enableZShape}},{key:"enableZVertex",get:function(){return this.tool.enableZVertex}},{key:"enableMoveGraphic",get:function(){return this.tool.enableMoveGraphic}},{key:"enableMidpoints",get:function(){return this.tool.enableMidpoints}},{key:"enableEdgeOffset",get:function(){return this.tool.enableEdgeOffset}},{key:"_labelOptions",get:function(){return this.tool.labelOptions}},{key:"_tooltipOptions",get:function(){return this.tool.tooltipOptions}},{key:"canRedo",get:function(){return p.isSome(this._editGeometryOperations)&&this._editGeometryOperations.canRedo}},{key:"canUndo",get:function(){return p.isSome(this._editGeometryOperations)&&this._editGeometryOperations.canUndo}},{key:"test",get:function(){return{segmentLabels:this._segmentLabels,tooltip:this._tooltip}}}]),i}(o.EventedMixin(r.HandleOwner)),i.__decorate([c.property()],e.ReshapeOperation.prototype,"_segmentLabels",void 0),i.__decorate([c.property({constructOnly:!0})],e.ReshapeOperation.prototype,"tool",void 0),i.__decorate([c.property()],e.ReshapeOperation.prototype,"_tooltip",void 0),i.__decorate([c.property()],e.ReshapeOperation.prototype,"inputGeometry",null),i.__decorate([c.property()],e.ReshapeOperation.prototype,"outputGeometry",void 0),i.__decorate([c.property({readOnly:!0})],e.ReshapeOperation.prototype,"updating",null),i.__decorate([c.property()],e.ReshapeOperation.prototype,"manipulators",null),i.__decorate([c.property()],e.ReshapeOperation.prototype,"view",null),i.__decorate([c.property()],e.ReshapeOperation.prototype,"graphic",null),i.__decorate([c.property()],e.ReshapeOperation.prototype,"enableZShape",null),i.__decorate([c.property()],e.ReshapeOperation.prototype,"enableZVertex",null),i.__decorate([c.property()],e.ReshapeOperation.prototype,"enableMoveGraphic",null),i.__decorate([c.property()],e.ReshapeOperation.prototype,"enableMidpoints",null),i.__decorate([c.property()],e.ReshapeOperation.prototype,"enableEdgeOffset",null),i.__decorate([c.property()],e.ReshapeOperation.prototype,"_labelOptions",null),i.__decorate([c.property()],e.ReshapeOperation.prototype,"_tooltipOptions",null),e.ReshapeOperation=i.__decorate([m.subclass("esri.views.3d.interactive.editingTools.reshapeGraphic.ReshapeOperation")],e.ReshapeOperation);const ne=x.makeDehydratedPoint(0,0,null,null),oe=M.create(),re=1e-6;var se,le,pe;!function(e){e.Vertex=Z.ManipulatorStateCustomFlags.Custom1,e.Edge=Z.ManipulatorStateCustomFlags.Custom2}(se||(se={})),function(e){e[e.NONE=0]="NONE",e[e.MOVING=1]="MOVING",e[e.RESHAPING=2]="RESHAPING"}(le||(le={})),function(e){e[e.ALL=0]="ALL",e[e.SELECTED_OR_ALL=1]="SELECTED_OR_ALL"}(pe||(pe={})),Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
