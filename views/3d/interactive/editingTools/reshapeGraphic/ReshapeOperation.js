/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../core/has","../../../../../core/maybe","../../../../../core/Logger","../../../../../core/accessorSupport/ensureType","../../../../../core/handleUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/urlUtils","../../../../../core/uuid","../../../../../portal/support/resourceExtension","../../../../../core/Evented","../../../../../chunks/vec3","../../../../../core/Handles","../../../../../core/watchUtils","../../../../../support/elevationInfoUtils","../../../../../layers/graphics/dehydratedFeatures","../../../support/stack","../../../webgl-engine/lib/GeometryUtil","../../../webgl-engine/lib/Geometry","../editGeometry/EditGeometry","../editGeometry/EditGeometryHelper","../../../../interactive/dragEventPipeline","../../../../interactive/snapping/SnappingAlgorithm","../../../../interactive/snapping/SnappingEngine","../dragEventPipeline3D","../../Manipulator3D","../../manipulatorUtils","../manipulatorUtils","../settings","../../visualElements/OutlineVisualElement","../../../layers/graphics/GraphicState","../visualElementUtils","../manipulations/config","../manipulations/moveUtils","../manipulations/MoveManipulation","../manipulations/MoveXYGraphicManipulation"],(function(e,t,a,i,n,o,r,s,l,p,h,u,c,d,m,g,v,_,M,y,f,x,S,b,E,G,w,O,H,I,P,D,k,V,A,L,U,C,R){"use strict";function T(e,t){return Math.atan2(t[1]-e[1],t[0]-e[0])+Math.PI/2}function Z(e){return"vertex"===e.handle.type}function z(e){return"edge"===e.handle.type}e.ReshapeOperation=function(e){function a(t){var a;return(a=e.call(this,t)||this)._vertexManipulatorMaterial=I.createManipulatorMaterial(D.settings.colorToVec4(D.settings.reshapeManipulators.vertex.color),D.settings.reshapeManipulators.vertex.renderOccluded),a._vertexManipulatorOutlineMaterial=I.createManipulatorOutlineMaterial(D.settings.colorToVec4(D.settings.reshapeManipulators.vertex.outlineColor),D.settings.reshapeManipulators.vertex.renderOccluded),a._vertexManipulatorHoverOutlineMaterial=I.createManipulatorOutlineMaterial(D.settings.colorToVec4(D.settings.reshapeManipulators.vertex.hoverOutlineColor),D.settings.reshapeManipulators.vertex.renderOccluded),a._edgeManipulatorMaterial=I.createManipulatorMaterial(D.settings.colorToVec4(D.settings.reshapeManipulators.edge.color),D.settings.reshapeManipulators.edge.renderOccluded),a._edgeManipulatorOutlineMaterial=I.createManipulatorOutlineMaterial(D.settings.colorToVec4(D.settings.reshapeManipulators.edge.outlineColor),D.settings.reshapeManipulators.edge.renderOccluded),a._selectedManipulatorMaterial=I.createManipulatorMaterial(D.settings.colorToVec4(D.settings.reshapeManipulators.selected.color),D.settings.reshapeManipulators.selected.renderOccluded),a._selectedManipulatorOutlineMaterial=I.createManipulatorOutlineMaterial(D.settings.colorToVec4(D.settings.reshapeManipulators.selected.outlineColor),D.settings.reshapeManipulators.selected.renderOccluded),a._selectedManipulatorHoverOutlineMaterial=I.createManipulatorOutlineMaterial(D.settings.colorToVec4(D.settings.reshapeManipulators.selected.hoverOutlineColor),D.settings.reshapeManipulators.selected.renderOccluded),a._selectedIndex=0,a._vertexManipulatorGeometry=null,a._vertexManipulatorOutlineGeometry=null,a._edgeManipulatorGeometry=null,a._edgeManipulatorOutlineGeometry=null,a._handles=new g,a._manipulatorHandles=new g,a._manipulatorInfos=[],a._reshapeHelper=null,a._graphicMoveManipulation=null,a._moveManipulation=null,a._numGrabbing=0,a._numDragging=0,a._reshapeEventState=0,a._outlineVisualElement=null,a.tool=null,a.outputGeometry=null,a._vertexLaserLineVisualElement=null,a.snappingEngine=new w.SnappingEngine(t.tool.snappingOptions),a}t._inheritsLoose(a,e);var i=a.prototype;return i.initialize=function(){const e=new V.GraphicState({graphic:this.graphic});this._graphicState=e,this._handles.add([e.watch("displaying",(e=>{for(const t of this._manipulatorInfos)t.manipulator.available=e})),this.view.trackGraphicState(e)])},i.destroy=function(){this._clear(),this._handles.destroy(),this.snappingEngine.destroy()},i.removeSelectedVertices=function(){const e=this._manipulatorInfos.filter((e=>e.manipulator.selected&&"vertex"===e.handle.type));this._removeVertices(e)},i.manipulatorSelectionChanged=function(){this.emit("manipulators-changed")},i._clear=function(){this._moveManipulation=n.destroyMaybe(this._moveManipulation),this._graphicMoveManipulation=n.destroyMaybe(this._graphicMoveManipulation),this._manipulatorHandles.removeAll(),this.manipulators.removeAll(),this._manipulatorInfos=[],this._reshapeHelper=null,this._numGrabbing=0,this._numDragging=0},i._recreateManipulators=function(e=this.inputGeometry){if(this._clear(),n.isNone(e))return;this._reshapeHelper=new X(S.EditGeometry.fromGeometry(e,this.view.viewingMode),e.type);const t=_.getGraphicEffectiveElevationInfo(this.graphic);for(const e of this._reshapeHelper.data.components){for(const a of e.vertices)this._createPerVertexManipulator(a,t);for(const a of e.edges)this._createPerVertexManipulator(a,t)}this._createGraphicMoveManipulators(t)},i._perGraphicManipulatorDragAction=function(e,t){if("end"===t.action)return;const a=[],i=this._manipulatorInfos.some((e=>"vertex"===e.handle.type&&e.manipulator.selected)),o=1===e&&i,r=n.unwrap(this._reshapeHelper);for(const e of this._manipulatorInfos)"vertex"===e.handle.type&&(e.manipulator.grabbing||o&&!e.manipulator.selected||(n.unwrap(r).moveVertices([e.handle],t.mapDeltaX,t.mapDeltaY,t.mapDeltaZ),a.push(e.handle.pos),this._updateManipulatorPosition(e)));if(0===a.length)return;let s=0;for(const e of this._manipulatorInfos)"vertex"===e.handle.type&&s++;this.outputGeometry=r.geometry;if(a.length===s){if(this._updateEventState(1),this.destroyed)return;if(this.emit("move",{type:"move",dx:t.screenDeltaX,dy:t.screenDeltaY,mover:this.graphic}),this.destroyed)return}else{if(this._updateEventState(2),this.destroyed)return;if(this.emit("reshape",{type:"reshape",mover:this.graphic}),this.destroyed)return}},i.isMultiVertexSelection=function(){let e=0;for(const t of this._manipulatorInfos)Z(t)&&t.manipulator.selected&&e++;return e>1},i._perVertexManipulatorDragAction=function(e){if(this._updateEventState(2),this.destroyed)return;const t=e.mapDeltaX,a=e.mapDeltaY,i=e.mapDeltaZ;if(!t&&!a&&!i)return;const o=[];for(const t of this._manipulatorInfos)Z(t)&&(t.manipulator.selected&&!t.manipulator.grabbing||t===e.info)&&o.push(t);const r=n.unwrap(this._reshapeHelper);for(const e of o)r.moveVertices([e.handle],t,a,i);this.outputGeometry=r.geometry;for(const e of o)this._updateManipulatorPosition(e);this.emit("reshape",{type:"reshape",mover:this.graphic})},i._updateEventState=function(e){if(e===this._reshapeEventState)return!1;switch(e){case 0:if(0!==this._numGrabbing||0!==this._numDragging)return!1;switch(this._reshapeEventState){case 1:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic});break;case 2:this.emit("reshape",{type:"reshape-stop",mover:this.graphic})}break;case 1:switch(this._reshapeEventState){case 0:this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic});break;case 2:this.emit("reshape",{type:"reshape-stop",mover:this.graphic}),this.destroyed||this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic})}break;case 2:switch(this._reshapeEventState){case 0:this.emit("reshape",{type:"reshape-start",mover:this.graphic});break;case 1:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic}),this.destroyed||this.emit("reshape",{type:"reshape-start",mover:this.graphic})}}if(this.destroyed)return!1;const t=this._reshapeEventState!==e;return this._reshapeEventState=e,t},i._createGraphicMoveManipulators=function(e){this._graphicMoveManipulation=new R.MoveXYGraphicManipulation({tool:this.tool,view:this.view,graphicState:this._graphicState}),this.enableMoveGraphic?this._manipulatorHandles.add(this._graphicMoveManipulation.createDragPipeline(((e,t,a)=>{t.next((e=>this._trackNumDragging(e))).next((e=>{this._perGraphicManipulatorDragAction(0,e)})),a.next(this._cancelDragOperation())}))):this._graphicMoveManipulation.forEachManipulator((e=>{e.grabbable=!1,e.cursor=null})),this._graphicMoveManipulation.forEachManipulator((e=>this._manipulatorHandles.add([this._watchAndUpdateGrabState(e,!1),e.events.on("immediate-click",(e=>{this._manipulatorInfos.some((e=>e.manipulator.selected))?this._clearSelection():this.emit("immediate-click"),e.stopPropagation()}))]))),this._moveManipulation=new C.MoveManipulation({tool:this.tool,view:this.view,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZ&&P.canMoveZ(this.graphic),snapToScene:!1,radius:C.MoveManipulation.radiusForSymbol(this.graphic.symbol)}),this._moveManipulation.forEachManipulator((e=>{this._handles.add([this._watchAndUpdateGrabState(e,!1),e.events.on("immediate-click",(t=>{this._moveManipulation.zManipulation.hasManipulator(e)||this._manipulatorInfos.some((e=>e.manipulator.selected))||this.emit("immediate-click"),t.stopPropagation()}))])})),this._moveManipulation.elevationInfo={mode:"absolute-height",offset:0};const t=n.unwrap(this.graphic.geometry).spatialReference;let a=null;this._handles.add([this._moveManipulation.createDragPipeline(((t,i,o,r)=>{i.next((e=>this._trackNumDragging(e))).next((t=>{if("start"===t.action){const i=this._manipulatorInfos.filter((e=>Z(e)&&e.manipulator.selected));if(1===t.manipulatorType&&1===i.length){const t=i[0].handle;a=new G.SnappingContext(n.unwrap(this._reshapeHelper),this.view,e,r,t)}}return n.isSome(a)&&(t.mapEnd=this.snappingEngine.snap(t.mapEnd,a)),"end"===t.action&&(this.snappingEngine.doneSnapping(),a=null),t})).next(E.addMapDelta()).next((e=>{this._perGraphicManipulatorDragAction(1,e)})),o.next(this._cancelDragOperation())}),e,t),v.init(this._graphicState,"displaying",(()=>{this._updateMoveManipulationPosition()})),this._graphicState.on("changed",(()=>this._updateMoveManipulationPosition())),v.init(this._graphicState,"isDraped",(()=>{const e="align-move-manipulation";this._graphicState.isDraped?this._handles.add(this.view.elevationProvider.on("elevation-change",(()=>this._updateMoveManipulationPosition())),e):this._handles.remove(e)}))]),this._updateMoveManipulationPosition();const i=A.createVisualElements({view:this.view,graphic:this.graphic,forEachManipulator:e=>{if(!this.destroyed){n.isSome(this._graphicMoveManipulation)&&this._graphicMoveManipulation.forEachManipulator(e);for(const t of this._manipulatorInfos)e(t.manipulator,1);this._moveManipulation.forEachManipulator(e)}},onManipulatorsChanged:e=>this.on("manipulators-changed",e)});this._outlineVisualElement=i.visualElement instanceof k.OutlineVisualElement?i.visualElement:null,n.isSome(this._outlineVisualElement)&&this._manipulatorHandles.add([this._outlineVisualElement.events.on("attachment-origin-changed",(()=>{this._graphicState.isDraped||this._updateMoveManipulationPosition()})),this._graphicState.watch("isDraped",(()=>this._updateMoveManipulationPosition()))]),this._manipulatorHandles.add(i)},i._createPerVertexManipulator=function(e,t=_.getGraphicEffectiveElevationInfo(this.graphic)){if(n.isNone(this._vertexManipulatorGeometry)||n.isNone(this._vertexManipulatorOutlineGeometry)){const e=D.settings.reshapeManipulators.vertex,t=e.size/2,a=t+e.collisionPadding,i=t/a;this._vertexManipulatorGeometry=new x(f.createSphereGeometry(i,16,16),"reshape-manipulator");const n=(t+e.outlineSize)/a;this._vertexManipulatorOutlineGeometry=new x(f.createSphereGeometry(n,16,16),"reshape-manipulator-outline")}if(n.isNone(this._edgeManipulatorGeometry)||n.isNone(this._edgeManipulatorOutlineGeometry)){const e=D.settings.reshapeManipulators.edge,t=e.size/2,a=t+e.collisionPadding,i=t/a;this._edgeManipulatorGeometry=new x(f.createSphereGeometry(i,16,16),"reshape-manipulator");const n=(t+e.outlineSize)/a;this._edgeManipulatorOutlineGeometry=new x(f.createSphereGeometry(n,16,16),"reshape-manipulator-outline")}const a=new H.Manipulator3D({view:this.view,renderObjects:[{geometry:this._vertexManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:4|N.Vertex},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorOutlineMaterial,stateMask:5|N.Vertex},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:6|N.Vertex},{geometry:this._edgeManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:6|N.Edge},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:6|N.Edge},{geometry:this._edgeManipulatorGeometry,material:this._edgeManipulatorMaterial,stateMask:5|N.Edge},{geometry:this._edgeManipulatorOutlineGeometry,material:this._edgeManipulatorOutlineMaterial,stateMask:5|N.Edge},{geometry:this._vertexManipulatorGeometry,material:this._selectedManipulatorMaterial,stateMask:8},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorOutlineMaterial,stateMask:9},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorHoverOutlineMaterial,stateMask:10}],elevationInfo:t,focusMultiplier:1,touchMultiplier:1,available:!(!this.graphic.visible||!this.graphic.layer.visible)});this._setTypeSpecificManipulatorSettings(a,e,t);const i="edge"===e.type?{manipulator:a,handle:e,locationUpdateHandle:null,type:"edge",selectedIndex:0}:{manipulator:a,handle:e,type:"vertex",selectedIndex:0};if(this._manipulatorInfos.push(i),this.manipulators.add(a),this._updateManipulatorPosition(i),"edge"===i.type){const e=this._getManipulatorInfoFromHandle(i.handle.left).manipulator.events.on("location-update",(()=>this._updateManipulatorPosition(i))),t=this._getManipulatorInfoFromHandle(i.handle.right).manipulator.events.on("location-update",(()=>this._updateManipulatorPosition(i)));i.locationUpdateHandle=s.handlesGroup([e,t]),this._manipulatorHandles.add(i.locationUpdateHandle,a)}this._manipulatorHandles.add(this._watchAndUpdateGrabState(a,!0),a);const o=E.createManipulatorDragEventPipeline(a,((e,a,n,o)=>{a.next((e=>this._trackNumDragging(e))).next((e=>z(i)?{...e,info:this._splitEdgeManipulator(i)}:{...e,info:i})).next(E.dragAtLocation(this.view,e.elevationAlignedLocation)).next(O.screenToMapXYForGraphicAtLocation(this.view,this.graphic,e.elevationAlignedLocation,e.location.spatialReference)).next(this._snapDrag(t,o)).next(E.addMapDelta()).next((e=>{this._perVertexManipulatorDragAction(e)})),n.next(this._cancelDragOperation())}));return this._manipulatorHandles.add(o,a),this._manipulatorHandles.add([a.events.on("immediate-click",(e=>this._manipulatorClickCallback(e,i))),a.events.on("select-changed",(()=>{i.selectedIndex=++this._selectedIndex,this._updateMoveManipulationPosition()}))]),this.emit("manipulators-changed"),a},i._snapDrag=function(e,t){let a=null;const i=n.unwrap(this._reshapeHelper);return o=>{if("start"===o.action&&(this.isMultiVertexSelection()||(a={context:new G.SnappingContext(i,this.view,e,t,o.info.handle),originalPos:i.data.coordinateHelper.createDehydratedPoint(o.info.handle.pos)})),n.isSome(a)){const e={...a.originalPos};e.x+=o.mapEnd.x-o.mapStart.x,e.y+=o.mapEnd.y-o.mapStart.y;const t=this.snappingEngine.snap(e,a.context);o.mapEnd.x=t.x+(o.mapStart.x-a.originalPos.x),o.mapEnd.y=t.y+(o.mapStart.y-a.originalPos.y)}return"end"===o.action&&(this.snappingEngine.doneSnapping(),a=null),o}},i._trackNumDragging=function(e){switch(e.action){case"start":this._numDragging++;break;case"end":this._numDragging--}return e},i._cancelDragOperation=function(){const e=n.isSome(this._reshapeHelper)?this._reshapeHelper.geometry.clone():null;return()=>{switch(this._numDragging--,this.inputGeometry=e,this.outputGeometry=e,this.snappingEngine.doneSnapping(),this._reshapeEventState){case 0:break;case 1:this.emit("move",{type:"move",dx:0,dy:0,mover:this.graphic});break;case 2:this.emit("reshape",{type:"reshape",mover:this.graphic})}this.destroyed||this._updateEventState(0)}},i._setTypeSpecificManipulatorSettings=function(e,t,a){switch(t.type){case"vertex":e.state=N.Vertex,e.selectable=!0,e.cursor="move",e.collisionPriority=2,e.radius=D.settings.reshapeManipulators.vertex.size/2+D.settings.reshapeManipulators.vertex.collisionPadding,e.elevationInfo=a;break;case"edge":e.state=N.Edge,e.selectable=!1,e.cursor="copy",e.collisionPriority=-1,e.radius=D.settings.reshapeManipulators.edge.size/2+D.settings.reshapeManipulators.edge.collisionPadding,e.elevationInfo="on-the-ground"===a.mode?a:{mode:"absolute-height",offset:0}}},i._watchAndUpdateGrabState=function(e,t){return e.events.on("grab-changed",(a=>{if("start"===a.action)t&&this._updateSelection(e),this._numGrabbing++;else if(this._numGrabbing--,this._updateEventState(0),this.destroyed)return;this._moveManipulation.interactive=!this._numGrabbing}))},i._clearSelection=function(){for(const e of this._manipulatorInfos)e.manipulator.grabbing||(e.manipulator.selected=!1)},i._updateSelection=function(e){e.grabbing&&!e.selected&&e.selectable&&(this._clearSelection(),e.selected=!0,this.emit("manipulators-changed"))},i._removeManipulator=function(e){e&&(this._manipulatorHandles.remove(e.manipulator),this._manipulatorInfos.splice(this._manipulatorInfos.indexOf(e),1),this.manipulators.remove(e.manipulator),this.emit("manipulators-changed"))},i._getManipulatorInfoFromHandle=function(e){if(e)for(const t of this._manipulatorInfos)if(e===t.handle)return t;return null},i._updateManipulatorPosition=function(e){if(!e)return;const t=n.unwrap(this._reshapeHelper);if("vertex"===e.handle.type)e.manipulator.location=t.data.coordinateHelper.toPoint(e.handle.pos,F),e.manipulator.grabbing&&n.isSome(this._vertexLaserLineVisualElement)&&(this._vertexLaserLineVisualElement.visualElement.intersectsWorldUpAtLocation=e.manipulator.renderLocation);else if("edge"===e.handle.type){const a=this._getManipulatorInfoFromHandle(e.handle.left).manipulator,i=this._getManipulatorInfoFromHandle(e.handle.right).manipulator;if(n.isSome(e.manipulator.elevationInfo)&&"on-the-ground"===e.manipulator.elevationInfo.mode){const n=a.location,o=i.location,r=.5,s=n.x+r*(o.x-n.x),l=n.y+r*(o.y-n.y),p=n.hasZ&&o.hasZ?0:void 0;e.manipulator.location=M.makeDehydratedPoint(s,l,p,t.geometry.spatialReference)}else{const n=a.elevationAlignedLocation,o=i.elevationAlignedLocation,r=.5,s=n.x+r*(o.x-n.x),l=n.y+r*(o.y-n.y),p=n.hasZ&&o.hasZ?n.z+r*(o.z-n.z):void 0;e.manipulator.elevationAlignedLocation=M.makeDehydratedPoint(s,l,p,t.geometry.spatialReference)}}},i._splitEdgeManipulator=function(e){const t=n.unwrap(this._reshapeHelper),a=n.unwrap(t.splitEdge(e.handle,.5).createdVertex);e.locationUpdateHandle.remove(),e.locationUpdateHandle=void 0;const i=e;i.handle=a,i.type="vertex";const o=_.getGraphicEffectiveElevationInfo(this.graphic);this._setTypeSpecificManipulatorSettings(e.manipulator,e.handle,o),a.left&&this._createPerVertexManipulator(a.left),a.right&&this._createPerVertexManipulator(a.right),this.outputGeometry=t.geometry,this._updateManipulatorPosition(i),this._updateSelection(e.manipulator);const r=this._updateEventState(2),s=t.data.coordinateHelper.toArray(i.handle.pos),l=t.data.components.indexOf(a.component);return this.emit("vertex-add",{type:"vertex-add",vertices:[{coordinates:s,componentIndex:l,vertexIndex:n.unwrap(a.index)}],added:s}),r&&this._updateEventState(0),i},i._updateMoveManipulationPosition=function(){const e=y.sv3d.get();m.set(e,0,0,0);let t=0,a=!1,i=null,o=null;for(const r of this._manipulatorInfos)Z(r)&&(r.manipulator.selected?(t++,m.add(e,e,r.manipulator.renderLocation),n.isNone(i)||r.selectedIndex>i.selectedIndex?(o=i,i=r):(n.isNone(o)||r.selectedIndex>o.selectedIndex)&&(o=r)):a=!0);if(0!==t){const e=this._graphicState.displaying;this._moveManipulation.xyManipulation.available=e,this._moveManipulation.xyAxisManipulation.available=e,this._moveManipulation.zManipulation.available=e&&this.enableZ&&P.canMoveZ(this.graphic),this._moveManipulation.xyAxisManipulation.orthogonalAvailable=e&&1!==t}else{const e=this._graphicState.displaying&&this.enableMoveGraphic;this._moveManipulation.xyManipulation.available=e,this._moveManipulation.xyAxisManipulation.available=e,this._moveManipulation.xyAxisManipulation.orthogonalAvailable=e,this._moveManipulation.zManipulation.available=e&&this.enableZ&&P.canMoveZ(this.graphic)}if(0!==t){let e=0;if(n.isSome(i)){const t=i.handle.pos,a=n.isSome(o)?o.handle.pos:i.handle.left&&i.handle.left.left?i.handle.left.left.pos:null,r=!n.isSome(o)&&i.handle.right&&i.handle.right.right?i.handle.right.right.pos:null;a&&r?this._moveManipulation.xyAxisManipulation.available=!1:a?e=T(a,t):r&&(e=T(t,r))}this._moveManipulation.angle=e,this._moveManipulation.radius=L.DISC_RADIUS_SMALL}else this._moveManipulation.angleDeferred=()=>U.primaryShapeOrientation(n.unwrap(this.graphic.geometry)),this._moveManipulation.radius=C.MoveManipulation.radiusForSymbol(this.graphic.symbol);0!==t&&a?(m.scale(e,e,1/t),F.spatialReference=n.unwrap(this._reshapeHelper).geometry.spatialReference,F.hasZ=!0,this.view.renderCoordsHelper.fromRenderCoords(e,F),this._moveManipulation.elevationAlignedLocation=F):n.isSome(this._outlineVisualElement)&&!this._graphicState.isDraped&&n.isSome(this._outlineVisualElement.attachmentOrigin)?this._moveManipulation.elevationAlignedLocation=this._outlineVisualElement.attachmentOrigin:I.placeAtGraphic(this.view,this._moveManipulation,this.graphic)},i._removeVertices=function(e){const t=[],a=n.unwrap(this._reshapeHelper);for(const i of e)if("vertex"===i.handle.type&&a.canRemoveVertex()){t.push(i.handle),this._removeManipulator(i),this._removeManipulator(this._getManipulatorInfoFromHandle(i.handle.left)),this._removeManipulator(this._getManipulatorInfoFromHandle(i.handle.right));const e=n.unwrap(a.removeVertices([i.handle]).removedVertices[0].createdEdge);e&&this._createPerVertexManipulator(e)}if(t.length>0){const e=t.map((e=>{const t=a.data.components.indexOf(e.component);return{coordinates:a.data.coordinateHelper.toArray(e.pos),componentIndex:t,vertexIndex:n.unwrap(e.index)}}));this.outputGeometry=a.geometry;const i=this._updateEventState(2);if(this.destroyed)return;if(this.emit("vertex-remove",{type:"vertex-remove",removed:e.map((e=>e.coordinates)),vertices:e}),this.destroyed)return;if(i&&(this._updateEventState(0),this.destroyed))return;this._updateMoveManipulationPosition()}},i._manipulatorClickCallback=function(e,t){e.shiftKey||this._clearSelection(),"vertex"===t.handle.type&&(t.manipulator.selected=!t.manipulator.selected),"vertex"===t.handle.type&&2===e.button&&this._removeVertices([t]),z(t)&&0===e.button&&this._splitEdgeManipulator(t),e.stopPropagation()},t._createClass(a,[{key:"inputGeometry",get:function(){return n.isSome(this._reshapeHelper)?this._reshapeHelper.geometry:null},set:function(e){this._recreateManipulators(e)}},{key:"manipulators",get:function(){return this.tool.manipulators}},{key:"view",get:function(){return this.tool.view}},{key:"graphic",get:function(){return this.tool.graphic}},{key:"enableZ",get:function(){return this.tool.enableZ}},{key:"enableMoveGraphic",get:function(){return this.tool.enableMoveGraphic}}]),a}(d.EventedAccessor),a.__decorate([l.property({constructOnly:!0})],e.ReshapeOperation.prototype,"tool",void 0),a.__decorate([l.property()],e.ReshapeOperation.prototype,"inputGeometry",null),a.__decorate([l.property()],e.ReshapeOperation.prototype,"outputGeometry",void 0),e.ReshapeOperation=a.__decorate([p.subclass("esri.views.3d.interactive.editingTools.graphicReshape3D.ReshapeOperation")],e.ReshapeOperation);const F=M.makeDehydratedPoint(0,0,null,null);var N;!function(e){e.Vertex=16,e.Edge=32}(N||(N={}));let X=function(e){function a(t,a){var i;return(i=e.call(this,t,a)||this).type=a,i._geometry=null,i}return t._inheritsLoose(a,e),t._createClass(a,[{key:"geometry",get:function(){if(this._dirty){switch(this.type){case"polyline":this._geometry=this.data.toPolyline();break;case"polygon":this._geometry=this.data.toPolygon()}this._dirty=!1}return this._geometry}}]),a}(b.EditGeometryHelper);e.ReshapeGeometryHelper=X,Object.defineProperty(e,"__esModule",{value:!0})}));
