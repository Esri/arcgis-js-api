/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../core/has","../../../../../core/Evented","../../../../../core/HandleOwner","../../../../../core/Handles","../../../../../core/handleUtils","../../../../../core/maybe","../../../../../core/watchUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/arrayUtils","../../../../../core/accessorSupport/ensureType","../../../../../core/accessorSupport/decorators/subclass","../../../../../chunks/mat4f64","../../../../../chunks/vec3","../../../../../chunks/vec3f64","../../../../../geometry/Polyline","../../../../../layers/graphics/dehydratedFeatures","../../../../../support/elevationInfoUtils","../../../../../symbols/support/utils","../../Manipulator3D","../../manipulatorUtils","../../SnappingVisualizer3D","../dragEventPipeline3D","../ManipulatorType","../manipulatorUtils","../settings","../visualElementUtils","../manipulations/config","../manipulations/MoveManipulation","../manipulations/moveUtils","../manipulations/MoveXYGraphicManipulation","./edgeOffsetUtils","../../visualElements/OutlineVisualElement","../../../layers/graphics/GraphicState","../../../webgl-engine/lib/GeometryUtil","../../../../input/IViewEvents","../../../../interactive/dragEventPipeline","../../../../interactive/interfaces","../../../../interactive/editGeometry/EditGeometryOperations","../../../../interactive/editGeometry/interfaces","../../../../interactive/snapping/SnappingContext","../../../../interactive/snapping/SnappingDragPipelineStep"],(function(e,t,a,i,n,o,r,s,l,p,u,h,d,c,g,m,M,_,f,v,y,O,x,E,S,G,b,I,V,w,H,A,D,P,N,L,k,F,T,U,R,C,z,Z){"use strict";function Y(e,t){return Math.atan2(t[1]-e[1],t[0]-e[0])+Math.PI/2}function X(e){return"vertex"===e.handle.type}function B(e){return"edge"===e.handle.type}e.ReshapeOperation=function(e){function a(t){var a;return(a=e.call(this,t)||this)._vertexManipulatorMaterial=x.createManipulatorMaterial(I.settings.colorToVec4(I.settings.reshapeManipulators.vertex.color),I.settings.reshapeManipulators.vertex.renderOccluded),a._vertexManipulatorOutlineMaterial=x.createManipulatorOutlineMaterial(I.settings.colorToVec4(I.settings.reshapeManipulators.vertex.outlineColor),I.settings.reshapeManipulators.vertex.renderOccluded),a._vertexManipulatorHoverOutlineMaterial=x.createManipulatorOutlineMaterial(I.settings.colorToVec4(I.settings.reshapeManipulators.vertex.hoverOutlineColor),I.settings.reshapeManipulators.vertex.renderOccluded),a._edgeManipulatorMaterial=x.createManipulatorMaterial(I.settings.colorToVec4(I.settings.reshapeManipulators.edge.color),I.settings.reshapeManipulators.edge.renderOccluded),a._edgeManipulatorOutlineMaterial=x.createManipulatorOutlineMaterial(I.settings.colorToVec4(I.settings.reshapeManipulators.edge.outlineColor),I.settings.reshapeManipulators.edge.renderOccluded),a._edgeOffsetManipulatorMaterial=x.createManipulatorMaterial(I.settings.colorToVec4(I.settings.reshapeManipulators.edgeOffset.color),I.settings.reshapeManipulators.edgeOffset.renderOccluded,!1),a._edgeOffsetManipulatorHoverMaterial=x.createManipulatorMaterial(I.settings.colorToVec4(I.settings.reshapeManipulators.edgeOffset.hoverColor),I.settings.reshapeManipulators.edgeOffset.renderOccluded,!1),a._selectedManipulatorMaterial=x.createManipulatorMaterial(I.settings.colorToVec4(I.settings.reshapeManipulators.selected.color),I.settings.reshapeManipulators.selected.renderOccluded),a._selectedManipulatorOutlineMaterial=x.createManipulatorOutlineMaterial(I.settings.colorToVec4(I.settings.reshapeManipulators.selected.outlineColor),I.settings.reshapeManipulators.selected.renderOccluded),a._selectedManipulatorHoverOutlineMaterial=x.createManipulatorOutlineMaterial(I.settings.colorToVec4(I.settings.reshapeManipulators.selected.hoverOutlineColor),I.settings.reshapeManipulators.selected.renderOccluded),a._selectedIndex=0,a._vertexManipulatorGeometry=null,a._vertexManipulatorOutlineGeometry=null,a._edgeManipulatorGeometry=null,a._edgeManipulatorOutlineGeometry=null,a._edgeOffsetManipulatorGeometryInside=null,a._edgeOffsetManipulatorGeometryOutside=null,a._manipulatorHandles=new r,a._manipulatorInfos=[],a._editGeometryOperations=null,a._graphicMoveManipulation=null,a._moveManipulation=null,a._numGrabbing=0,a._numDragging=0,a._reshapeEventState=K.NONE,a._outlineVisualElement=null,a.tool=null,a.outputGeometry=null,a._snappingPipeline=new Z.SnappingPipeline,a._snappingPipelineHandle=new Z.SnappingPipeline,a._vertexLaserLineVisualElement=null,a}t._inheritsLoose(a,e);var i=a.prototype;return i.initialize=function(){const e=new L.GraphicState({graphic:this.graphic});this._graphicState=e,this.handles.add([e.watch("displaying",(e=>{for(const t of this._manipulatorInfos)t.manipulator.available=e})),this.view.trackGraphicState(e)])},i.destroy=function(){this._editGeometryOperations=l.destroyMaybe(this._editGeometryOperations),this._moveManipulation=l.destroyMaybe(this._moveManipulation),this._graphicMoveManipulation=l.destroyMaybe(this._graphicMoveManipulation),this._manipulatorHandles=l.destroyMaybe(this._manipulatorHandles),this.manipulators.removeAll(),this._manipulatorInfos=[],this._resetGrabbingDragging()},i.removeSelectedVertices=function(){const e=this._manipulatorInfos.filter((e=>e.manipulator.selected&&"vertex"===e.handle.type));this._removeVertices(e)},i.manipulatorSelectionChanged=function(){this.emit("manipulators-changed")},i._removeManipulators=function(){this._moveManipulation=l.destroyMaybe(this._moveManipulation),this._graphicMoveManipulation=l.destroyMaybe(this._graphicMoveManipulation),this._manipulatorHandles.removeAll(),this.manipulators.removeAll(),this._manipulatorInfos=[]},i._resetGrabbingDragging=function(){this._numGrabbing=0,this._numDragging=0},i._createManipulators=function(){if(l.isNone(this._editGeometryOperations))return;const e=v.getGraphicEffectiveElevationInfo(this.graphic);for(const t of this._editGeometryOperations.data.components){for(const a of t.vertices)this._createVertexOrEdgeManipulator(a,e);for(const a of t.edges)this._createVertexOrEdgeManipulator(a,e)}this._createGraphicMoveManipulators(e)},i.redo=function(){if(l.isNone(this._editGeometryOperations))return null;const e=this._editGeometryOperations.redo();return l.isSome(e)&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),e},i.undo=function(){if(l.isNone(this._editGeometryOperations))return null;this.emit("undo");const e=this._editGeometryOperations.undo();return l.isSome(e)&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),e},i._recreateManipulators=function(){this._removeManipulators(),this._resetGrabbingDragging(),this._createManipulators()},i._recreateEditGeometryAndManipulators=function(e=this.inputGeometry){this._removeManipulators(),this._resetGrabbingDragging(),l.isNone(e)||(l.destroyMaybe(this._editGeometryOperations),this._editGeometryOperations=R.EditGeometryOperations.fromGeometry(e,this.view.state.viewingMode),this._createManipulators())},i._perGraphicManipulatorDragAction=function(e,t){if("end"===t.action)return;let a=0;const i=[],n=this._manipulatorInfos.some((e=>"vertex"===e.handle.type&&e.manipulator.selected)),o=e===J.SELECTED_OR_ALL&&n;for(const r of this._manipulatorInfos)X(r)&&(r.manipulator.grabbing||o&&!r.manipulator.selected||i.push(r),a++);if(0===i.length)return;this._moveVertices(i,t);if(i.length===a){if(this._updateEventState(K.MOVING),this.destroyed)return;this.emit("move",{type:"move",dx:t.screenDeltaX,dy:t.screenDeltaY,mover:this.graphic})}else{if(this._updateEventState(K.RESHAPING),this.destroyed)return;this.emit("reshape",{type:"reshape",mover:this.graphic})}},i._isMultiVertexSelection=function(){let e=0;for(const t of this._manipulatorInfos)X(t)&&t.manipulator.selected&&e++;return e>1},i._perVertexManipulatorDragAction=function(e){if(this._updateEventState(K.RESHAPING),this.destroyed)return;const{mapDeltaX:t,mapDeltaY:a,mapDeltaZ:i}=e;if(!t&&!a&&!i)return;const n=[];for(const o of this._manipulatorInfos)X(o)&&(o.manipulator.selected&&!o.manipulator.grabbing||o===e.info)&&n.push(o);this._moveVertices(n,e,C.AccumulationBehaviour.ACCUMULATE_STEPS),this.emit("reshape",{type:"reshape",mover:this.graphic})},i._updateEventState=function(e){if(e===this._reshapeEventState)return!1;switch(e){case K.NONE:if(0!==this._numGrabbing||0!==this._numDragging)return!1;switch(this._reshapeEventState){case K.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic});break;case K.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic})}break;case K.MOVING:switch(this._reshapeEventState){case K.NONE:this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic});break;case K.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic}),this.destroyed||this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic})}break;case K.RESHAPING:switch(this._reshapeEventState){case K.NONE:this.emit("reshape",{type:"reshape-start",mover:this.graphic});break;case K.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic}),this.destroyed||this.emit("reshape",{type:"reshape-start",mover:this.graphic})}}if(this.destroyed)return!1;const t=this._reshapeEventState!==e;return this._reshapeEventState=e,t},i._createGraphicMoveManipulators=function(e){if(this._graphicMoveManipulation=new D.MoveXYGraphicManipulation({tool:this.tool,view:this.view,graphicState:this._graphicState}),this.enableMoveGraphic){let e=null;this._manipulatorHandles.add(this._graphicMoveManipulation.createDragPipeline(((t,a,i)=>{a.next((e=>this._trackNumDragging(e))).next((t=>("start"===t.action&&(e=l.unwrap(this._editGeometryOperations).createUndoGroup()),t))).next((t=>{this._perGraphicManipulatorDragAction(J.ALL,t),"end"===t.action&&(e=l.removeMaybe(e))})),i.next(this._cancelDragOperation((()=>e=l.removeMaybe(e))))})))}else this._graphicMoveManipulation.forEachManipulator((e=>{e.grabbable=!1,e.cursor=null}));this._graphicMoveManipulation.forEachManipulator((e=>this._manipulatorHandles.add([this._watchAndUpdateGrabState(e,!1),e.events.on("immediate-click",(e=>{this._manipulatorInfos.some((e=>e.manipulator.selected))?this._clearSelection():this.emit("immediate-click",{...e,graphic:this.graphic}),e.stopPropagation()}))]))),this._moveManipulation=new H.MoveManipulation({tool:this.tool,view:this.view,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZShape&&b.canMoveZ(this.graphic),snapToScene:!1,radius:H.MoveManipulation.radiusForSymbol(this.graphic.symbol)}),this._moveManipulation.forEachManipulator((e=>{this.handles.add([this._watchAndUpdateGrabState(e,!1),e.events.on("immediate-click",(t=>{this._moveManipulation.zManipulation.hasManipulator(e)||this._manipulatorInfos.some((e=>e.manipulator.selected))||this.emit("immediate-click",{...t,graphic:this.graphic}),t.stopPropagation()}))])})),this._moveManipulation.elevationInfo={mode:"absolute-height",offset:0};const t=l.unwrap(this.graphic.geometry).spatialReference;this.handles.add([this._moveManipulation.createDragPipeline(((t,a,i,n,o)=>{const r=i.next((e=>this._trackNumDragging(e))).next((e=>{const t=this._manipulatorInfos.filter((e=>X(e)&&e.manipulator.selected));return e.manipulatorType===G.ManipulatorType.TRANSLATE_XY&&1===t.length?{...e,info:t[0],snapOrigin:t[0].handle.pos}:{...e,info:null}})).next(this._snappingPipelineHandle.createSnapDragEventPipelineStep({predicate:e=>!!e.info,cancel:n,snappingManager:this.tool.snappingManager,snappingContext:new z.SnappingContext({editGeometryOperations:l.unwrap(this._editGeometryOperations),elevationInfo:e,pointer:o,excludeFeature:this.graphic,visualizer:new E.SnappingVisualizer3D}),updatingHandles:this.updatingHandles}),this._snappingPipelineHandle.next).next(T.addMapDelta()).next((e=>(this._perGraphicManipulatorDragAction(J.SELECTED_OR_ALL,e),e)));return n.next(this._cancelDragOperation()),r}),e,t,this.graphic),p.init(this._graphicState,"displaying",(()=>{this._updateMoveManipulationPosition()})),this._graphicState.on("changed",(()=>this._updateMoveManipulationPosition())),p.init(this._graphicState,"isDraped",(()=>{const e="align-move-manipulation";this._graphicState.isDraped?this.handles.add(this.view.elevationProvider.on("elevation-change",(()=>this._updateMoveManipulationPosition())),e):this.handles.remove(e)}))]),this._updateMoveManipulationPosition();const a=V.createVisualElements({view:this.view,graphic:this.graphic,forEachManipulator:e=>{if(!this.destroyed){l.isSome(this._graphicMoveManipulation)&&this._graphicMoveManipulation.forEachManipulator(e);for(const t of this._manipulatorInfos)e(t.manipulator,G.ManipulatorType.TRANSLATE_XY);this._moveManipulation.forEachManipulator(e)}},onManipulatorsChanged:e=>this.on("manipulators-changed",e)});l.isSome(a)&&(this._outlineVisualElement=a.visualElement instanceof N.OutlineVisualElement?a.visualElement:null),l.isSome(this._outlineVisualElement)&&this._manipulatorHandles.add([this._outlineVisualElement.events.on("attachment-origin-changed",(()=>{this._graphicState.isDraped||this._updateMoveManipulationPosition()})),this._graphicState.watch("isDraped",(()=>this._updateMoveManipulationPosition()))]),this._manipulatorHandles.add(a)},i._createEdgeOffsetManipulator=function(e,t=v.getGraphicEffectiveElevationInfo(this.graphic)){const a=I.settings.reshapeManipulators.edgeOffset,i=a.size/2,n=i+a.collisionPadding;if(l.isNone(this._edgeOffsetManipulatorGeometryInside)||l.isNone(this._edgeOffsetManipulatorGeometryOutside)){const e=i/n,t=e*Math.sqrt(3)/2;this._edgeOffsetManipulatorGeometryInside=k.createExtrudedTriangle(t,e/2,e/2,a.height,a.offset),this._edgeOffsetManipulatorGeometryOutside=k.createExtrudedTriangle(-t,e/2,e/2,a.height,-a.offset)}const o=[{geometry:this._edgeOffsetManipulatorGeometryInside,material:this._edgeOffsetManipulatorMaterial,stateMask:U.ManipulatorStateFlags.Unfocused},{geometry:this._edgeOffsetManipulatorGeometryInside,material:this._edgeOffsetManipulatorHoverMaterial,stateMask:U.ManipulatorStateFlags.Focused},{geometry:this._edgeOffsetManipulatorGeometryOutside,material:this._edgeOffsetManipulatorMaterial,stateMask:U.ManipulatorStateFlags.Unfocused},{geometry:this._edgeOffsetManipulatorGeometryOutside,material:this._edgeOffsetManipulatorHoverMaterial,stateMask:U.ManipulatorStateFlags.Focused}],r=new O.Manipulator3D({view:this.view,renderObjects:o,elevationInfo:"on-the-ground"!==t.mode||y.isVolumetricSymbol(this.graphic.symbol)?{mode:"absolute-height",offset:0}:t,worldOriented:!1,focusMultiplier:1,radius:n,available:!(!this.graphic.visible||!this.graphic.layer.visible),collisionType:{type:"disc",direction:M.fromValues(0,0,1)},collisionPriority:1}),p=new O.Manipulator3D({view:this.view,renderObjects:[],worldSized:!0,worldOriented:!1,available:!(!this.graphic.visible||!this.graphic.layer.visible),collisionPriority:-10,cursor:this.enableMoveGraphic?"move":"default"}),u={manipulator:r,handle:e,locationUpdateHandle:null,type:"edge",selectedIndex:0,edgeManipulator:p,elevationInfo:t,visibilityHandle:null};this._autoHideEdgeOffsetManipulator(u,a.minSquaredEdgeLength),this._updateEdgeOffsetManipulator(u);const h=this._getManipulatorInfoFromHandle(u.handle.leftVertex).manipulator.events.on("location-update",(()=>this._updateEdgeOffsetManipulator(u))),d=this._getManipulatorInfoFromHandle(u.handle.rightVertex).manipulator.events.on("location-update",(()=>this._updateEdgeOffsetManipulator(u)));u.locationUpdateHandle=s.handlesGroup([h,d]),this._manipulatorHandles.add(u.locationUpdateHandle,r),this._manipulatorHandles.add([this._watchAndUpdateGrabState(r,!0),this._watchAndUpdateGrabState(p,!0)],r),this._manipulatorHandles.add(T.createManipulatorDragEventPipeline(r,this._createEdgeOffsetPipeline(u,t)),r),this._manipulatorHandles.add(T.createManipulatorDragEventPipeline(p,((e,a,i,n)=>{if("touch"===n){this._createEdgeOffsetPipeline(u,t)(e,a,i)}else if(this.enableMoveGraphic){const n=this.graphic,o=l.isSome(n.geometry)?n.geometry.spatialReference:null;a.next((e=>this._trackNumDragging(e))).next(T.dragAtLocation(this.view,e.elevationAlignedLocation)).next(S.screenToMapXYAtLocation(this.view,e.elevationAlignedLocation,t,o,n)).next(T.addScreenDelta()).next(T.addMapDelta()).next((e=>this._perGraphicManipulatorDragAction(J.ALL,e))),i.next(this._cancelDragOperation())}})),r);const c=e=>{this._manipulatorInfos.some((e=>e.manipulator.selected))?this._clearSelection():this.emit("immediate-click",{...e,graphic:this.graphic}),e.stopPropagation()};return this._manipulatorHandles.add([r.events.on("immediate-click",c),p.events.on("immediate-click",c)],r),this._manipulatorInfos.push(u),this.manipulators.add(r),this.manipulators.add(p),this.emit("manipulators-changed"),u},i._autoHideEdgeOffsetManipulator=function(e,t){const a=e.manipulator,i=e.edgeManipulator,n=()=>{l.removeMaybe(e.visibilityHandle);const n=P.screenEdgeLengthSquared(this._getManipulatorInfoFromHandle(e.handle.leftVertex).manipulator.renderLocation,this._getManipulatorInfoFromHandle(e.handle.rightVertex).manipulator.renderLocation,this.view.state.camera)<t;(!a.focused&&!i.focused||n)&&(a.grabbable=!n,i.grabbable=!n,e.visibilityHandle=s.handlesGroup([a.disableDisplay(),{remove:()=>{a.grabbable=!0,i.grabbable=this.enableMoveGraphic}}]))};this._manipulatorHandles.add([a.events.on("focus-changed",n),i.events.on("focus-changed",n),{remove:()=>{l.removeMaybe(e.visibilityHandle),this.manipulators.remove(i)}}],a),n()},i._updateEdgeOffsetManipulator=function(e){this._updateManipulatorPosition(e);const t=l.unwrap(this._editGeometryOperations).data.coordinateHelper,a=P.createEdgeOffsetIntersectionPlane(this.view,e.manipulator.elevationAlignedLocation,P.createEdgeOffsetOperation(t,e.handle,l.unwrap(e.manipulator.elevationInfo))),i=this._getManipulatorInfoFromHandle(e.handle.leftVertex).manipulator.renderLocation,n=this._getManipulatorInfoFromHandle(e.handle.rightVertex).manipulator.renderLocation,o=l.isSome(a)?P.edgeOffsetRotationMatrix(a,i,n):g.IDENTITY;e.manipulator.modelTransform=o,e.edgeManipulator.elevationAlignedLocation=e.manipulator.elevationAlignedLocation,e.edgeManipulator.modelTransform=o;const r=m.length(m.subtract(j,i,n))/2;e.edgeManipulator.collisionType={type:"line",paths:[[[-r,0,0],[r,0,0]]]}},i._createEdgeOffsetPipeline=function(e,t){return(a,i,n)=>{this._clearSelection();const{step:o,cleanup:r}=this._initializeEdgeOffset(e,t);i.next((e=>this._trackNumDragging(e))).next(T.dragAtLocation(this.view,a.elevationAlignedLocation)).next(o).next(S.screenToRenderPlaneFromEvent(this.view)).next(S.convertToMapCoordinates(this.view,l.unwrap(this._editGeometryOperations).data.spatialReference)).next(T.addMapDelta()).next(this._applyEdgeOffsetStep(e)).next((e=>{"end"===e.action&&r()})),n.next((e=>(r(),e))).next(this._cancelDragOperation())}},i._initializeEdgeOffset=function(e,t){const a=l.unwrap(this._editGeometryOperations),i=P.createEdgeOffsetOperation(a.data.coordinateHelper,e.handle,t),n=a.createUndoGroup(),o=P.createEdgeOffsetIntersectionPlane(this.view,e.manipulator.elevationAlignedLocation,i);i.requiresSplitEdgeLeft&&this._splitEdgeManipulator(this._getManipulatorInfoFromHandle(e.handle.leftVertex.leftEdge),1),i.requiresSplitEdgeRight&&this._splitEdgeManipulator(this._getManipulatorInfoFromHandle(e.handle.rightVertex.rightEdge),0);const r=()=>new _({paths:[[e.handle.leftVertex.pos,e.handle.rightVertex.pos]],spatialReference:l.unwrap(this._editGeometryOperations).data.spatialReference}),p=new N.OutlineVisualElement({view:this.view,isDraped:this._graphicState.isDraped,geometry:r(),elevationInfo:e.elevationInfo,width:I.settings.visualElements.lineGraphics.outline.width,color:I.settings.colorToVec4(I.colors.main),attached:!0});let u;const h=()=>{this._cleanEdgeOffsetCollapsedEdges(e),u=l.removeMaybe(u)},d=this.on("undo",h);return u=s.handlesGroup([s.destroyHandle(p),this._graphicState.watch("isDraped",(e=>p.isDraped=e)),this._graphicState.on("changed",(()=>p.geometry=r())),n,d]),{step:e=>l.isNone(i)||l.isNone(o)?(h(),null):{...e,operation:i,plane:o},cleanup:h}},i._applyEdgeOffsetStep=function(e){return t=>{if(this.destroyed||l.isNone(t.operation))return t;this._updateEventState(K.RESHAPING);const{mapDeltaX:a,mapDeltaY:i,mapDeltaZ:n}=t;return(a||i||n)&&(this._offsetEdge(e,t),this.emit("reshape",{type:"reshape",mover:this.graphic})),t}},i._cleanEdgeOffsetCollapsedEdges=function(e){var t,a;const i=null==(t=e.handle.leftVertex.leftEdge)?void 0:t.leftVertex,n=e.handle.leftVertex,o=null==(a=e.handle.rightVertex.rightEdge)?void 0:a.rightVertex,r=e.handle.rightVertex,s=l.unwrap(this._editGeometryOperations).data.coordinateHelper,p=1e-6,u=[];i&&s.distance(i.pos,n.pos)<p&&u.push(this._getManipulatorInfoFromHandle(n)),(s.distance(n.pos,r.pos)<p||o&&s.distance(o.pos,r.pos)<p)&&u.push(this._getManipulatorInfoFromHandle(r)),u.length&&this._removeVertices(u)},i._computeVertexManipulatorSizeAndOutline=function(e){const t=e.size/2,a=t+e.collisionPadding;return{size:t/a,outlineSize:(t+e.outlineSize)/a}},i._createVertexOrEdgeManipulator=function(e,t=v.getGraphicEffectiveElevationInfo(this.graphic)){if("edge"===e.type){if(this.enableEdgeOffset)return this._createEdgeOffsetManipulator(e,t);if(!this.enableMidpoints)return null}if(l.isNone(this._vertexManipulatorGeometry)||l.isNone(this._vertexManipulatorOutlineGeometry)){const{size:e,outlineSize:t}=this._computeVertexManipulatorSizeAndOutline(I.settings.reshapeManipulators.vertex);this._vertexManipulatorGeometry=k.createSphereGeometry(e,16,16),this._vertexManipulatorOutlineGeometry=k.createSphereGeometry(t,16,16)}if(l.isNone(this._edgeManipulatorGeometry)||l.isNone(this._edgeManipulatorOutlineGeometry)){const{size:e,outlineSize:t}=this._computeVertexManipulatorSizeAndOutline(I.settings.reshapeManipulators.edge);this._edgeManipulatorGeometry=k.createSphereGeometry(e,16,16),this._edgeManipulatorOutlineGeometry=k.createSphereGeometry(t,16,16)}const a=l.isSome(this.graphic.geometry)&&"point"===this.graphic.geometry.type?[]:[{geometry:this._vertexManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:W.Vertex|U.ManipulatorStateFlags.Unselected},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorOutlineMaterial,stateMask:W.Vertex|U.ManipulatorStateFlags.Unfocused|U.ManipulatorStateFlags.Unselected},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:W.Vertex|U.ManipulatorStateFlags.Focused|U.ManipulatorStateFlags.Unselected},{geometry:this._vertexManipulatorGeometry,material:this._selectedManipulatorMaterial,stateMask:U.ManipulatorStateFlags.Selected},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorOutlineMaterial,stateMask:U.ManipulatorStateFlags.Selected|U.ManipulatorStateFlags.Unfocused},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorHoverOutlineMaterial,stateMask:U.ManipulatorStateFlags.Selected|U.ManipulatorStateFlags.Focused}];this.enableMidpoints&&a.push({geometry:this._edgeManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:W.Edge|U.ManipulatorStateFlags.Focused|U.ManipulatorStateFlags.Unselected},{geometry:this._edgeManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:W.Edge|U.ManipulatorStateFlags.Focused|U.ManipulatorStateFlags.Unselected},{geometry:this._edgeManipulatorGeometry,material:this._edgeManipulatorMaterial,stateMask:W.Edge|U.ManipulatorStateFlags.Unfocused|U.ManipulatorStateFlags.Unselected},{geometry:this._edgeManipulatorOutlineGeometry,material:this._edgeManipulatorOutlineMaterial,stateMask:W.Edge|U.ManipulatorStateFlags.Unfocused|U.ManipulatorStateFlags.Unselected});const i=new O.Manipulator3D({view:this.view,renderObjects:a,elevationInfo:t,focusMultiplier:1,touchMultiplier:1,available:!(!this.graphic.visible||!this.graphic.layer.visible)});this._setTypeSpecificManipulatorSettings(i,e,t);const n="edge"===e.type?{manipulator:i,handle:e,locationUpdateHandle:null,type:"edge",selectedIndex:0}:{manipulator:i,handle:e,type:"vertex",selectedIndex:0};if(this._manipulatorInfos.push(n),this.manipulators.add(i),this._updateManipulatorPosition(n),"edge"===n.type){const e=this._getManipulatorInfoFromHandle(n.handle.leftVertex).manipulator.events.on("location-update",(()=>this._updateManipulatorPosition(n))),t=this._getManipulatorInfoFromHandle(n.handle.rightVertex).manipulator.events.on("location-update",(()=>this._updateManipulatorPosition(n)));n.locationUpdateHandle=s.handlesGroup([e,t]),this._manipulatorHandles.add(n.locationUpdateHandle,i)}this._manipulatorHandles.add(this._watchAndUpdateGrabState(i,!0),i);const o=T.createManipulatorDragEventPipeline(i,((e,a,i,o)=>{let r=null;a.next((e=>this._trackNumDragging(e))).next((e=>{if("start"===e.action&&(r=l.unwrap(this._editGeometryOperations).createUndoGroup()),B(n)){const t=this._splitEdgeManipulator(n);return{...e,info:t,snapOrigin:t.handle.pos}}return{...e,info:n,snapOrigin:n.handle.pos}})).next(T.dragAtLocation(this.view,e.elevationAlignedLocation)).next(S.screenToMapXYForGraphicAtLocation(this.view,this.graphic,e.elevationAlignedLocation,e.location.spatialReference,this.graphic)).next(this._snappingPipeline.createSnapDragEventPipelineStep({predicate:()=>!this._isMultiVertexSelection(),cancel:i,snappingManager:this.tool.snappingManager,snappingContext:new z.SnappingContext({editGeometryOperations:l.unwrap(this._editGeometryOperations),elevationInfo:t,pointer:o,excludeFeature:this.graphic,visualizer:new E.SnappingVisualizer3D}),updatingHandles:this.updatingHandles}),this._snappingPipeline.next).next(T.addMapDelta()).next((e=>{this._perVertexManipulatorDragAction(e),"end"===e.action&&(r=l.removeMaybe(r))})),i.next(this._cancelDragOperation((()=>r=l.removeMaybe(r))))}));return this._manipulatorHandles.add(o,i),this._manipulatorHandles.add([i.events.on("immediate-click",(e=>this._manipulatorClickCallback(e,n))),i.events.on("select-changed",(()=>{n.selectedIndex=++this._selectedIndex,this._updateMoveManipulationPosition()}))],i),this.emit("manipulators-changed"),n},i._trackNumDragging=function(e){switch(e.action){case"start":this._numDragging++;break;case"end":this._numDragging--}return e},i._cancelDragOperation=function(e){return()=>{switch(this._numDragging--,this.undo(),this.outputGeometry=l.isSome(this._editGeometryOperations)?this._editGeometryOperations.data.geometry:null,l.isSome(this.tool.snappingManager)&&this.tool.snappingManager.doneSnapping(),this._reshapeEventState){case K.NONE:break;case K.MOVING:this.emit("move",{type:"move",dx:0,dy:0,mover:this.graphic});break;case K.RESHAPING:this.emit("reshape",{type:"reshape",mover:this.graphic})}e&&e(),this.destroyed||this._updateEventState(K.NONE)}},i._setTypeSpecificManipulatorSettings=function(e,t,a){switch(t.type){case"vertex":e.state=W.Vertex,e.selectable=!0,e.cursor="move",e.collisionPriority=2,e.radius=I.settings.reshapeManipulators.vertex.size/2+I.settings.reshapeManipulators.vertex.collisionPadding,e.elevationInfo=a,e.interactive=l.isSome(this.graphic.geometry)&&"point"!==this.graphic.geometry.type;break;case"edge":e.state=W.Edge,e.selectable=!1,e.cursor="copy",e.collisionPriority=-1,e.radius=I.settings.reshapeManipulators.edge.size/2+I.settings.reshapeManipulators.edge.collisionPadding,e.elevationInfo="on-the-ground"!==a.mode||y.isVolumetricSymbol(this.graphic.symbol)?{mode:"absolute-height",offset:0}:a}},i._watchAndUpdateGrabState=function(e,t){return e.events.on("grab-changed",(a=>{if("start"===a.action)t&&this._updateSelection(e),this._numGrabbing++;else if(this._numGrabbing--,this._updateEventState(K.NONE),this.destroyed)return;this._moveManipulation.interactive=!this._numGrabbing,("touch"!==a.pointerType||this.enableEdgeOffset)&&(this._manipulatorInfos.forEach((e=>{e.manipulator.interactive=!this._numGrabbing&&l.isSome(this.graphic.geometry)&&"point"!==this.graphic.geometry.type,"edgeManipulator"in e&&(e.edgeManipulator.interactive=!this._numGrabbing)})),l.unwrap(this._graphicMoveManipulation).forEachManipulator((e=>e.interactive=!this._numGrabbing)))}))},i._clearSelection=function(){for(const e of this._manipulatorInfos)e.manipulator.grabbing||(e.manipulator.selected=!1)},i._updateSelection=function(e){e.grabbing&&!e.selected&&e.selectable&&(this._clearSelection(),e.selected=!0,this.emit("manipulators-changed"))},i._removeManipulator=function(e){e&&(this._manipulatorHandles.remove(e.manipulator),this._manipulatorInfos.splice(this._manipulatorInfos.indexOf(e),1),this.manipulators.remove(e.manipulator),this.emit("manipulators-changed"))},i._getManipulatorInfoFromHandle=function(e){if(e)for(const t of this._manipulatorInfos)if(e===t.handle)return t;return null},i._updateManipulatorPosition=function(e){if(!e)return;const t=l.unwrap(this._editGeometryOperations);if("vertex"===e.handle.type)e.manipulator.location=t.data.coordinateHelper.vectorToDehydratedPoint(e.handle.pos,q),e.manipulator.grabbing&&l.isSome(this._vertexLaserLineVisualElement)&&(this._vertexLaserLineVisualElement.visualElement.intersectsWorldUpAtLocation=e.manipulator.renderLocation);else if("edge"===e.handle.type){const a=this._getManipulatorInfoFromHandle(e.handle.leftVertex).manipulator,i=this._getManipulatorInfoFromHandle(e.handle.rightVertex).manipulator;if(l.isSome(e.manipulator.elevationInfo)&&"on-the-ground"===e.manipulator.elevationInfo.mode){const n=a.location,o=i.location,r=.5,s=n.x+r*(o.x-n.x),l=n.y+r*(o.y-n.y),p=n.hasZ&&o.hasZ?0:void 0;e.manipulator.location=f.makeDehydratedPoint(s,l,p,t.data.spatialReference)}else m.lerp(j,a.renderLocation,i.renderLocation,.5),e.manipulator.renderLocation=j}},i._splitEdgeManipulator=function(e,t=.5){const a=l.unwrap(this._editGeometryOperations),i=l.unwrap(a.splitEdge(e.handle,t).createdVertex);e.locationUpdateHandle.remove(),e.locationUpdateHandle=void 0;const n=v.getGraphicEffectiveElevationInfo(this.graphic);let o;this.enableEdgeOffset?(this._removeManipulator(e),o=this._createVertexOrEdgeManipulator(i)):(o=e,o.handle=i,o.type="vertex",this._setTypeSpecificManipulatorSettings(e.manipulator,e.handle,n)),i.leftEdge&&this._createVertexOrEdgeManipulator(i.leftEdge),i.rightEdge&&this._createVertexOrEdgeManipulator(i.rightEdge),this.outputGeometry=a.data.geometry,this._updateManipulatorPosition(o),this._updateSelection(e.manipulator);const r=this._updateEventState(K.RESHAPING),s=a.data.coordinateHelper.vectorToArray(o.handle.pos),p=a.data.components.indexOf(i.component);return this.emit("vertex-add",{type:"vertex-add",vertices:[{coordinates:s,componentIndex:p,vertexIndex:l.unwrap(i.index)}],added:s}),r&&this._updateEventState(K.NONE),o},i._updateMoveManipulationPosition=function(){const e=m.set(j,0,0,0);let t=0,a=!1,i=null,n=null;for(const o of this._manipulatorInfos)X(o)&&(o.manipulator.selected?(t++,m.add(e,e,o.manipulator.renderLocation),l.isNone(i)||o.selectedIndex>i.selectedIndex?(n=i,i=o):(l.isNone(n)||o.selectedIndex>n.selectedIndex)&&(n=o)):a=!0);if(0!==t){const e=this._graphicState.displaying;this._moveManipulation.xyManipulation.available=e,this._moveManipulation.xyAxisManipulation.available=e,this._moveManipulation.zManipulation.available=e&&this.enableZVertex&&b.canMoveZ(this.graphic),this._moveManipulation.xyAxisManipulation.orthogonalAvailable=e&&1!==t}else{const e=this._graphicState.displaying&&this.enableMoveGraphic;this._moveManipulation.xyManipulation.available=e,this._moveManipulation.xyAxisManipulation.available=e,this._moveManipulation.xyAxisManipulation.orthogonalAvailable=e,this._moveManipulation.zManipulation.available=e&&this.enableZShape&&b.canMoveZ(this.graphic)}if(0!==t){let e=0;if(l.isSome(i)){const t=i.handle.pos,a=l.isSome(n)?n.handle.pos:i.handle.leftEdge&&i.handle.leftEdge.leftVertex?i.handle.leftEdge.leftVertex.pos:null,o=!l.isSome(n)&&i.handle.rightEdge&&i.handle.rightEdge.rightVertex?i.handle.rightEdge.rightVertex.pos:null;a&&o?this._moveManipulation.xyAxisManipulation.available=!1:a?e=Y(a,t):o&&(e=Y(t,o))}this._moveManipulation.angle=e,this._moveManipulation.radius=w.DISC_RADIUS_SMALL}else this._moveManipulation.angleDeferred=()=>A.shapeOrientation(l.unwrap(this.graphic.geometry)),this._moveManipulation.radius=H.MoveManipulation.radiusForSymbol(this.graphic.symbol);0!==t&&a?(m.scale(e,e,1/t),q.spatialReference=l.unwrap(this._editGeometryOperations).data.spatialReference,q.hasZ=!0,this.view.renderCoordsHelper.fromRenderCoords(e,q),this._moveManipulation.elevationAlignedLocation=q):l.isSome(this._outlineVisualElement)&&!this._graphicState.isDraped&&l.isSome(this._outlineVisualElement.attachmentOrigin)?this._moveManipulation.elevationAlignedLocation=this._outlineVisualElement.attachmentOrigin:x.placeAtGraphic(this.view,this._moveManipulation,this.graphic)},i._removeVertices=function(e){const t=[],a=l.unwrap(this._editGeometryOperations);for(const i of e)if("vertex"===i.handle.type&&a.canRemoveVertex()){t.push(i.handle),this._removeManipulator(i),this._removeManipulator(this._getManipulatorInfoFromHandle(i.handle.leftEdge)),this._removeManipulator(this._getManipulatorInfoFromHandle(i.handle.rightEdge));const e=l.unwrap(a.removeVertices([i.handle]).removedVertices[0].createdEdge);e&&this._createVertexOrEdgeManipulator(e)}if(t.length>0){const e=t.map((e=>{const t=a.data.components.indexOf(e.component);return{coordinates:a.data.coordinateHelper.vectorToArray(e.pos),componentIndex:t,vertexIndex:l.unwrap(e.index)}}));this.outputGeometry=a.data.geometry;const i=this._updateEventState(K.RESHAPING);if(this.destroyed)return;if(this.emit("vertex-remove",{type:"vertex-remove",removed:e.map((e=>e.coordinates)),vertices:e}),this.destroyed)return;if(i&&(this._updateEventState(K.NONE),this.destroyed))return;this._updateMoveManipulationPosition()}},i._moveVertices=function(e,t,a=("start"===t.action?C.AccumulationBehaviour.NEW_STEP:C.AccumulationBehaviour.ACCUMULATE_STEPS)){const i=l.unwrap(this._editGeometryOperations);i.moveVertices(e.map((e=>e.handle)),t.mapDeltaX,t.mapDeltaY,t.mapDeltaZ,a),this.outputGeometry=i.data.geometry;for(const n of e)this._updateManipulatorPosition(n)},i._offsetEdge=function(e,t){if(l.isNone(t.operation))return;const a=l.unwrap(this._editGeometryOperations),i=t.operation.clone();i.distance=t.operation.signedDistanceToPoint(t.mapEnd),a.updateVertices([e.handle.leftVertex,e.handle.rightVertex],i),this.outputGeometry=a.data.geometry,this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(e.handle.leftVertex)),this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(e.handle.rightVertex))},i._manipulatorClickCallback=function(e,t){e.shiftKey||this._clearSelection(),"vertex"===t.handle.type&&(t.manipulator.selected=!t.manipulator.selected),"vertex"===t.handle.type&&e.button===F.MouseButton.Right&&this._removeVertices([t]),B(t)&&e.button===F.MouseButton.Left&&this._splitEdgeManipulator(t),e.stopPropagation()},t._createClass(a,[{key:"inputGeometry",get:function(){return l.isSome(this._editGeometryOperations)?this._editGeometryOperations.data.geometry:null},set:function(e){this._recreateEditGeometryAndManipulators(e)}},{key:"updating",get:function(){return this.updatingHandles.updating}},{key:"manipulators",get:function(){return this.tool.manipulators}},{key:"view",get:function(){return this.tool.view}},{key:"graphic",get:function(){return this.tool.graphic}},{key:"enableZShape",get:function(){return this.tool.enableZShape}},{key:"enableZVertex",get:function(){return this.tool.enableZVertex}},{key:"enableMoveGraphic",get:function(){return this.tool.enableMoveGraphic}},{key:"enableMidpoints",get:function(){return this.tool.enableMidpoints}},{key:"enableEdgeOffset",get:function(){return this.tool.enableEdgeOffset}},{key:"canRedo",get:function(){return l.isSome(this._editGeometryOperations)&&this._editGeometryOperations.canRedo}},{key:"canUndo",get:function(){return l.isSome(this._editGeometryOperations)&&this._editGeometryOperations.canUndo}}]),a}(n.EventedMixin(o.HandleOwner)),a.__decorate([u.property({constructOnly:!0})],e.ReshapeOperation.prototype,"tool",void 0),a.__decorate([u.property()],e.ReshapeOperation.prototype,"inputGeometry",null),a.__decorate([u.property()],e.ReshapeOperation.prototype,"outputGeometry",void 0),a.__decorate([u.property({readOnly:!0})],e.ReshapeOperation.prototype,"updating",null),e.ReshapeOperation=a.__decorate([c.subclass("esri.views.3d.interactive.editingTools.reshapeGraphic.ReshapeOperation")],e.ReshapeOperation);const q=f.makeDehydratedPoint(0,0,null,null),j=M.create();var W,K,J;!function(e){e.Vertex=U.ManipulatorStateCustomFlags.Custom1,e.Edge=U.ManipulatorStateCustomFlags.Custom2}(W||(W={})),function(e){e[e.NONE=0]="NONE",e[e.MOVING=1]="MOVING",e[e.RESHAPING=2]="RESHAPING"}(K||(K={})),function(e){e[e.ALL=0]="ALL",e[e.SELECTED_OR_ALL=1]="SELECTED_OR_ALL"}(J||(J={})),Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
