/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../core/maybe","../../../../core/handleUtils","../../../../core/mathUtils","../../../../chunks/vec3f64","../../../../chunks/vec3","../../../../core/watchUtils","../../../../geometry/support/aaBoundingRect","../../../../geometry/projection","../../../../geometry/support/aaBoundingBox","../../../../support/elevationInfoUtils","../../layers/graphics/elevationAlignmentUtils","../../layers/graphics/ElevationContext","../visualElements/LaserlineVisualElement","../visualElements/ExtendedLineVisualElement","../visualElements/PointVisualElement","./settings","./ManipulatorState","../../layers/graphics/GraphicState"],(function(e,t,n,a,i,s,o,l,r,c,p,u,d,g,h,m,v,y,f){"use strict";function E(e){return t.isSome(e.geometry)&&"point"===e.geometry.type}const w=i.create(),V=c.create();e.createVisualElements=function(e){const{view:i,graphic:S}=e,P=new f.GraphicState({graphic:S}),x=[],L=function(e,a,i){const{view:s,graphic:c}=e,u=new m.PointVisualElement({view:s,geometry:E(c)?c.geometry:null,elevationInfo:p.getGraphicEffectiveElevationInfo(c),attached:!1});return function(e,a,i,s){const c=()=>a.attached=i.displaying;(function(e,a,i,s){const{view:o,graphic:c}=e;let p=null;const u=()=>{t.isSome(p)&&(p.remove(),p=null),i.isDraped&&E(c)&&(p=function(e,t,n){const a=e.elevationProvider.spatialReference;r.projectPointToVector(t,w,a);const i=w[0],s=w[1];return e.elevationProvider.on("elevation-change",(e=>{l.containsXY(e.extent,i,s)&&n()}))}(o,c.geometry,(()=>{a.geometry=c.geometry})))},d=()=>{u(),a.geometry=E(c)?c.geometry:null};s.push(i.on("changed",d),n.refHandle((()=>p))),d()})(e,a,i,s),v.settings.visualElements.pointGraphics.outline.apply(a),s.push(o.init(i,"displaying",c))}(e,u,a,i),i.push(n.destroyHandle(u)),u}(e,P,x);return function(e,t,i,o){const{view:l,graphic:m}=e,f=new h.ExtendedLineVisualElement({view:l,extensionType:v.settings.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:4});v.settings.visualElements.zVerticalLine.apply(f);const S=new g.LaserlineVisualElement({view:l,intersectsLineInfinite:!0,attached:!1});v.settings.visualElements.pointGraphics.shadowStyle.apply(S);const P=a.deg2rad(v.settings.visualElements.heightPlaneAngleCutoff),x=new g.LaserlineVisualElement({view:l,attached:!1,angleCutoff:P});v.settings.visualElements.heightPlane.apply(x);const L=p.getGraphicEffectiveElevationInfo(e.graphic),b=d.ElevationContext.fromElevationInfo(L),G="on-the-ground"===L.mode||!L.offset&&"absolute-height"!==L.mode,M=new y.ManipulatorState;let A=1,H=1;const C=()=>{M.update(e);const n=G&&(t.isDraped||!E(m)||!m.geometry.hasZ);let a=!0;if(!n&&E(m)){const e=m.geometry,t=u.evaluateElevationAlignmentAtPoint(m.geometry,l.elevationProvider,b,l.renderCoordsHelper);s.set(w,e.x,e.y,t),r.projectVectorToVector(w,e.spatialReference,w,l.renderCoordsHelper.spatialReference),f.setStartEndFromWorldDownAtLocation(w),S.intersectsWorldUpAtLocation=w}else a=!1;{const e=2&M.grabbingState?v.settings.visualElements.laserlineAlphaMultiplier:1;e!==A&&(A=e,v.settings.visualElements.heightPlane.apply(x,e))}{const e=c.empty(V);!n&&t.displaying&&o.calculateMapBounds(e)&&r.projectVectorToVector(c.getMin(e,w),l.spatialReference,w,l.renderCoordsHelper.spatialReference)?(x.heightManifoldTarget=w,x.attached=!0):x.attached=!1}{const e=4&M.grabbingState?v.settings.visualElements.laserlineAlphaMultiplier:1;e!==H&&(H=e,v.settings.visualElements.pointGraphics.shadowStyle.apply(S,e))}const i=a&&t.displaying&&!n;S.attached=i,f.attached=i};i.push(t.watch(["displaying","isDraped"],C),t.on("changed",C)),e.forEachManipulator((e=>{i.push(e.events.on("grab-changed",C))})),i.push(n.destroyHandle(S)),i.push(n.destroyHandle(f)),i.push(n.destroyHandle(x)),C()}(e,P,x,L),x.push(i.trackGraphicState(P)),{visualElement:L,remove(){n.handlesGroup(x).remove()}}},Object.defineProperty(e,"__esModule",{value:!0})}));
