/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../core/maybe","../../../../core/handleUtils","../../../../core/mathUtils","../../../../chunks/vec3f64","../../../../chunks/vec3","../../../../core/watchUtils","../../../../geometry/support/aaBoundingRect","../../../../geometry/projection","../../../../geometry/support/aaBoundingBox","../../../../support/elevationInfoUtils","../../layers/graphics/elevationAlignmentUtils","../../layers/graphics/ElevationContext","../visualElements/LaserlineVisualElement","../visualElements/ExtendedLineVisualElement","../visualElements/PointVisualElement","./settings","../../layers/graphics/GraphicState","./ManipulatorState"],(function(e,t,n,a,i,s,o,l,r,c,p,u,d,g,h,m,v,y,f){"use strict";function E(e){const{view:t,graphic:a}=e,i=new y.GraphicState({graphic:a}),s=[],o=V(e,i,s);return w(e,i,s,o),s.push(t.trackGraphicState(i)),{visualElement:o,remove(){n.handlesGroup(s).remove()}}}function w(e,t,i,o){const{view:l,graphic:m}=e,y=new h.ExtendedLineVisualElement({view:l,extensionType:v.settings.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:4});v.settings.visualElements.zVerticalLine.apply(y);const E=new g.LaserlineVisualElement({view:l,intersectsLineInfinite:!0,attached:!1});v.settings.visualElements.pointGraphics.shadowStyle.apply(E);const w=a.deg2rad(v.settings.visualElements.heightPlaneAngleCutoff),V=new g.LaserlineVisualElement({view:l,attached:!1,angleCutoff:w});v.settings.visualElements.heightPlane.apply(V);const S=p.getGraphicEffectiveElevationInfo(e.graphic),P=d.ElevationContext.fromElevationInfo(S),x="on-the-ground"===S.mode||!S.offset&&"absolute-height"!==S.mode,M=new f.ManipulatorState;let A=1,H=1;const C=()=>{M.update(e);const n=x&&(t.isDraped||!L(m)||!m.geometry.hasZ);let a=!0;if(!n&&L(m)){const e=m.geometry,t=u.evaluateElevationAlignmentAtPoint(m.geometry,l.elevationProvider,P,l.renderCoordsHelper);s.set(b,e.x,e.y,t),r.projectVectorToVector(b,e.spatialReference,b,l.renderCoordsHelper.spatialReference),y.setStartEndFromWorldDownAtLocation(b),E.intersectsWorldUpAtLocation=b}else a=!1;const i=2&M.grabbingState?v.settings.visualElements.laserlineAlphaMultiplier:1;i!==A&&(A=i,v.settings.visualElements.heightPlane.apply(V,i));const p=c.empty(G);!n&&t.displaying&&o.calculateMapBounds(p)&&r.projectVectorToVector(c.getMin(p,b),l.spatialReference,b,l.renderCoordsHelper.spatialReference)?(V.heightManifoldTarget=b,V.attached=!0):V.attached=!1;const d=4&M.grabbingState?v.settings.visualElements.laserlineAlphaMultiplier:1;d!==H&&(H=d,v.settings.visualElements.pointGraphics.shadowStyle.apply(E,d));const g=a&&t.displaying&&!n;E.attached=g,y.attached=g};i.push(t.watch(["displaying","isDraped"],C),t.on("changed",C)),e.forEachManipulator((e=>{i.push(e.events.on("grab-changed",C))})),i.push(n.destroyHandle(E)),i.push(n.destroyHandle(y)),i.push(n.destroyHandle(V)),C()}function V(e,t,a){const{view:i,graphic:s}=e,o=new m.PointVisualElement({view:i,geometry:L(s)?s.geometry:null,elevationInfo:p.getGraphicEffectiveElevationInfo(s),attached:!1});return S(e,o,t,a),a.push(n.destroyHandle(o)),o}function S(e,t,n,a){const i=()=>t.attached=n.displaying;P(e,t,n,a),v.settings.visualElements.pointGraphics.outline.apply(t),a.push(o.init(n,"displaying",i))}function P(e,a,i,s){const{view:o,graphic:l}=e;let r=null;const c=()=>{t.isSome(r)&&(r.remove(),r=null),i.isDraped&&L(l)&&(r=x(o,l.geometry,(()=>{a.geometry=l.geometry})))},p=()=>{c(),a.geometry=L(l)?l.geometry:null};s.push(i.on("changed",p),n.refHandle((()=>r))),p()}function x(e,t,n){const a=e.elevationProvider.spatialReference;r.projectPointToVector(t,b,a);const i=b[0],s=b[1];return e.elevationProvider.on("elevation-change",(e=>{l.containsXY(e.extent,i,s)&&n()}))}function L(e){return t.isSome(e.geometry)&&"point"===e.geometry.type}const b=i.create(),G=c.create();e.createVisualElements=E,Object.defineProperty(e,"__esModule",{value:!0})}));
