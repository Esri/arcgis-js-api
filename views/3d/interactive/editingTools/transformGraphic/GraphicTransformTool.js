/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../core/has","../../../../../core/maybe","../../../../../core/Logger","../../../../../core/accessorSupport/ensureType","../../../../../core/handleUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/urlUtils","../../../../../core/uuid","../../../../../portal/support/resourceExtension","../../../../../core/Evented","../../../../../chunks/common","../../../../../core/Handles","../../../../../support/elevationInfoUtils","../../../../interactive/editGeometry/EditGeometry","../../../../interactive/editGeometry/EditGeometryHelper","../../../../interactive/snapping/SnappingContext","../../SnappingDragPipelineStep","../../SnappingVisualizer3D","../../../../interactive/InteractiveToolBase","../../manipulatorUtils","../manipulatorUtils","../../../layers/graphics/GraphicState","../visualElementUtils","../manipulations/config","../manipulations/MoveManipulation","./GraphicScaleRotateTransform"],(function(e,t,a,i,o,n,r,s,l,c,p,h,u,d,g,v,m,y,f,M,S,b,T,G,w,_,R,E,A,x){"use strict";e.GraphicTransformTool=function(e){function a(t){var a;return(a=e.call(this,t)||this).enableZ=!0,a.enableRotation=!0,a.enableScaling=!0,a.type="transform-3d",a.handles=new v,a.scaleRotate=null,a.snappingPipeline=new S.SnappingPipeline,a}t._inheritsLoose(a,e);var i=a.prototype;return i.initialize=function(){this.graphicState=new _.GraphicState({graphic:this.graphic}),this.moveManipulation=new A.MoveManipulation({tool:this,view:this.view,snapToScene:this.snapToScene,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZ&&w.canMoveZ(this.graphic),radius:A.MoveManipulation.radiusForSymbol(this.graphic.symbol)}),this.moveManipulation.forEachManipulator((e=>this.handles.add(e.events.on("immediate-click",(e=>e.stopPropagation()))))),this.moveManipulation.elevationInfo=m.getGraphicEffectiveElevationInfo(this.graphic);const e=this.graphic.geometry;if(this.moveManipulation.createGraphicDragPipeline(((t,a,i,n,r)=>(o.isSome(e)&&"point"===e.type&&0===t&&(i=i.next(this.snappingPipeline.createSnapDragEventPipelineStep({snappingContext:new M.SnappingContext({elevationInfo:m.getGraphicEffectiveElevationInfo(this.graphic),pointer:r,geometry:new f.EditGeometryHelper(y.EditGeometry.fromGeometry(e,this.view.viewingMode),"point"),visualizer:new b.SnappingVisualizer3D,excludeFeature:this.graphic}),snappingManager:this.snappingManager,cancel:n}),this.snappingPipeline.next)),i)),this.graphicState,(e=>{const{action:t,graphic:a,dxScreen:i,dyScreen:o}=e,n={graphic:a,dxScreen:i,dyScreen:o};switch(t){case"start":this.emit("graphic-translate-start",n);break;case"update":this.emit("graphic-translate",n);break;case"end":this.emit("graphic-translate-stop",n)}})),this.moveManipulation.angle=this.symbolRotationAngle,this.enableScaling||this.enableRotation){const e=this.enableScaling&&this.enableRotation?null:this.enableScaling?"scale":"rotate";this.scaleRotate=new x.GraphicScaleRotateTransform({tool:this,mode:e}),this.handles.add(this.scaleRotate.events.on("scale-changed",(()=>this.onScaleChanged())))}this.handles.add([R.createVisualElements({view:this.view,graphic:this.graphic,forEachManipulator:e=>this.forEachManipulator(e),onManipulatorsChanged:()=>s.makeHandle()}),this.graphic.watch("symbol",(()=>this.updateMoveAngle())),this.graphicState.on("changed",(()=>this.onGeometryChanged())),this.hideManipulatorsForGraphicState(),this.view.watch("scale",(()=>this.updateMoveAngle()))]),this.handles.add(this.view.trackGraphicState(this.graphicState)),this.onGeometryChanged()},i.forEachManipulator=function(e){this.moveManipulation.forEachManipulator(e),o.isSome(this.scaleRotate)&&this.scaleRotate.forEachManipulator(e)},i.hideManipulatorsForGraphicState=function(){return this.graphicState.watch("displaying",(e=>{this.forEachManipulator((t=>t.available=e)),this.moveManipulation.zManipulation.available=e&&this.enableZ&&w.canMoveZ(this.graphic)}))},i.destroy=function(){this.handles.destroy(),this.moveManipulation.destroy(),this.scaleRotate=o.destroyMaybe(this.scaleRotate),this._set("view",null),this._set("graphic",null)},i.reset=function(){},i.onDetach=function(){o.isSome(this.scaleRotate)&&this.scaleRotate.cancelActiveAnimation()},i.onHide=function(){o.isSome(this.scaleRotate)&&this.scaleRotate.cancelActiveAnimation()},i.onScaleChanged=function(){if(o.isNone(this.scaleRotate))return;const e=this.scaleRotate.getScale();this.moveManipulation.displayScale=e},i.updateMoveAngle=function(){"local"===this.view.viewingMode||this.view.scale<E.ALIGN_ARROWS_SCALE_THRESHOLD?this.moveManipulation.angle=this.symbolRotationAngle:this.moveManipulation.angle=0},i.onGeometryChanged=function(){G.placeAtGraphic(this.view,this.moveManipulation,this.graphic)},t._createClass(a,[{key:"snapToScene",set:function(e){this.moveManipulation&&(this.moveManipulation.snapToScene=e),this._set("snapToScene",e)}},{key:"symbolRotationAngle",get:function(){const e=this.graphic.symbol;if(e){const t=e.symbolLayers.find((e=>"object"===e.type)),a=t&&t.heading||0;return g.toRadian(-a)}return 0}},{key:"test",get:function(){return{discManipulator:this.moveManipulation.xyManipulation.test.discManipulator,ringManipulator:o.isSome(this.scaleRotate)?this.scaleRotate.test.ringManipulator:null,arrowManipulators:this.moveManipulation.xyAxisManipulation.test.arrowManipulators}}}]),a}(d.EventedMixin(T.InteractiveToolBase)),a.__decorate([l.property({constructOnly:!0,nonNullable:!0})],e.GraphicTransformTool.prototype,"view",void 0),a.__decorate([l.property({constructOnly:!0,nonNullable:!0})],e.GraphicTransformTool.prototype,"graphic",void 0),a.__decorate([l.property({constructOnly:!0,nonNullable:!0})],e.GraphicTransformTool.prototype,"enableZ",void 0),a.__decorate([l.property()],e.GraphicTransformTool.prototype,"enableRotation",void 0),a.__decorate([l.property()],e.GraphicTransformTool.prototype,"enableScaling",void 0),a.__decorate([l.property({value:!1})],e.GraphicTransformTool.prototype,"snapToScene",null),a.__decorate([l.property({constructOnly:!0})],e.GraphicTransformTool.prototype,"snappingManager",void 0),a.__decorate([l.property({readOnly:!0})],e.GraphicTransformTool.prototype,"type",void 0),e.GraphicTransformTool=a.__decorate([c.subclass("esri.views.3d.interactive.editingTools.graphicTransform3D.GraphicTransformTool")],e.GraphicTransformTool),Object.defineProperty(e,"__esModule",{value:!0})}));
