/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{_ as t}from"../../../../../chunks/tslib.es6.js";import e from"../../../../../core/Evented.js";import{HandleOwnerMixin as i}from"../../../../../core/HandleOwner.js";import{makeHandle as a}from"../../../../../core/handleUtils.js";import{isNone as o,isSome as s,destroyMaybe as n}from"../../../../../core/maybe.js";import{watch as r,syncAndInitial as p}from"../../../../../core/reactiveUtils.js";import{property as l}from"../../../../../core/accessorSupport/decorators/property.js";import"../../../../../core/arrayUtils.js";import"../../../../../core/has.js";import"../../../../../core/accessorSupport/ensureType.js";import{subclass as c}from"../../../../../core/accessorSupport/decorators/subclass.js";import h from"../../../../../geometry/Point.js";import{getGraphicEffectiveElevationInfo as m}from"../../../../../support/elevationInfoUtils.js";import{ViewingMode as d}from"../../../../ViewingMode.js";import{Manipulator3D as u}from"../../Manipulator3D.js";import{placeAtGraphic as g}from"../../manipulatorUtils.js";import{SnappingVisualizer3D as v}from"../../SnappingVisualizer3D.js";import{ManipulatorType as _}from"../ManipulatorType.js";import{canMoveZ as f}from"../manipulatorUtils.js";import{createVisualElements as M}from"../visualElementUtils.js";import{ALIGN_ARROWS_SCALE_THRESHOLD as y}from"../manipulations/config.js";import{MoveManipulation as S,ManipulationType as R}from"../manipulations/MoveManipulation.js";import{GraphicScaleRotateTransform as w}from"./GraphicScaleRotateTransform.js";import{ScaleRotateMeshAdapter as b}from"./ScaleRotateMeshAdapter.js";import{ScaleRotateObjectSymbol3DAdapter as j}from"./ScaleRotateObjectSymbol3DAdapter.js";import{createGraphicGeometryUndoRecord as A}from"./undoRecords.js";import{GraphicState as O}from"../../../layers/graphics/GraphicState.js";import{InteractiveToolBase as T}from"../../../../interactive/InteractiveToolBase.js";import{EditGeometryOperations as x}from"../../../../interactive/editGeometry/EditGeometryOperations.js";import G from"../../../../interactive/sketch/SketchTooltipOptions.js";import{SnappingContext as E}from"../../../../interactive/snapping/SnappingContext.js";import{SnappingPipeline as z}from"../../../../interactive/snapping/SnappingDragPipelineStep.js";import{Tooltip as U}from"../../../../interactive/tooltip/Tooltip.js";import{TranslateZTooltipInfo as L,TranslateGraphicTooltipInfo as C}from"../../../../interactive/tooltip/TranslateTooltipInfos.js";import{autoHorizontalDistanceByElevationModeBetweenPoints as P}from"../../../../support/automaticLengthMeasurementUtils.js";import{verticalSignedDistanceBetweenPoints as Z}from"../../../../support/euclideanLengthMeasurementUtils.js";let k=class extends(i(e.EventedMixin(T))){constructor(t){super(t),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this.tooltipOptions=new G,this.type="transform-3d",this._scaleRotate=null,this._snappingPipeline=new z,this._tooltip=null}initialize(){const{graphic:t,view:e}=this;this.graphicState=new O({graphic:t}),this.own(r((()=>this.tooltipOptions.enabled),(t=>{this._tooltip=t?new U({view:e}):n(this._tooltip)}),p)),this._moveManipulation=new S({tool:this,view:e,snapToScene:this.snapToScene,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZ&&f(t),radius:S.radiusForSymbol(t.symbol)}),this._moveManipulation.forEachManipulator(((e,i)=>this.handles.add([e.events.on("immediate-click",(e=>{this.emit("immediate-click",{...e,graphic:t}),e.stopPropagation()})),e.events.on("focus-changed",(({action:t})=>{const{tooltipOptions:e,_tooltip:a}=this;if(!o(a)&&(a.clear(),"focus"===t)){const t=i===_.TRANSLATE_Z?L:C;a.info=new t({tooltipOptions:e})}}))]))),this._moveManipulation.elevationInfo=m(t);const i=t.geometry;if(this._moveManipulation.createGraphicDragPipeline(((a,n,r,p,l)=>(s(i)&&a===R.XY&&(r=r.next(this._snappingPipeline.createSnapDragEventPipelineStep({snappingContext:new E({elevationInfo:m(t),pointer:l,editGeometryOperations:x.fromGeometry(new h({spatialReference:i.spatialReference}),e.state.viewingMode),visualizer:new v,excludeFeature:t}),snappingManager:this.snappingManager,updatingHandles:this.updatingHandles,cancel:p}),this._snappingPipeline.next)),r=r.next((t=>{const{tooltipOptions:e,_tooltip:i}=this;if(o(i))return t;const{mapStart:n,mapEnd:r}=t;i.clear();const p=a===R.Z?L:C;if("end"===t.action)i.info=new p({tooltipOptions:e});else{const t=a===R.Z?Z(n,r):P(n,r,this.graphicState.isDraped?"on-the-ground":"absolute-height");s(t)&&(i.info=new p({tooltipOptions:e,distance:t}))}return t})))),this.graphicState,(t=>{const{action:e,graphic:i,dxScreen:a,dyScreen:o}=t,s={graphic:i,dxScreen:a,dyScreen:o};switch(e){case"start":this.emit("graphic-translate-start",s),this.emit("record-undo",{record:this._createGeometryUndoRecord()});break;case"update":this.emit("graphic-translate",s);break;case"end":this.emit("graphic-translate-stop",s)}})),this._moveManipulation.angle=s(this._scaleRotate)?this._scaleRotate.angle:0,this._scaleRotateAdapter=this._createScaleRotateAdapter(),this.handles.add(r((()=>this._scaleRotateAdapter.angle),(()=>this._updateMoveAngle()))),this.enableScaling||this.enableRotation){const t=this.enableScaling&&this.enableRotation?null:this.enableScaling?"scale":"rotate";this._scaleRotate=new w({tool:this,mode:t,adapter:this._scaleRotateAdapter,tooltipOptions:this.tooltipOptions}),this.handles.add(this._scaleRotate.events.on("scale-changed",(()=>this._onScaleChanged())))}this.handles.add([M({view:this.view,graphic:this.graphic,forEachManipulator:t=>this._forEachManipulator(t),onManipulatorsChanged:()=>a()}),this.graphicState.on("changed",(()=>this._onGeometryChanged())),this._hideManipulatorsForGraphicState(),r((()=>e.scale),(()=>this._updateMoveAngle()))]),this.handles.add(this.view.trackGraphicState(this.graphicState)),this._onGeometryChanged(),this._updateMoveAngle(),this._forEachManipulator((t=>{t instanceof u&&this.handles.add(t.events.on("grab-changed",(()=>this._updateManipulatorsInteractive())))})),this.finishToolCreation()}destroy(){this._tooltip=n(this._tooltip),this._moveManipulation.destroy(),this._scaleRotate=n(this._scaleRotate),this._scaleRotateAdapter=n(this._scaleRotateAdapter),this._set("view",null),this._set("graphic",null)}_updateManipulatorsInteractive(){o(this._scaleRotate)||(this._scaleRotate.interactive=!this._moveManipulation.grabbing,this._moveManipulation.interactive=!this._scaleRotate.grabbing)}_createScaleRotateAdapter(){return s(this.graphic.geometry)&&"mesh"===this.graphic.geometry.type?new b({graphic:this.graphic,geometry:this.graphic.geometry,viewingMode:this.view.state.viewingMode}):new j({graphic:this.graphic,sizeFilter:t=>this._enforceNonZeroSize(t),findLayerView:()=>this.view.allLayerViews.find((t=>t.layer===this.graphic.layer)),sizeAxis:s(this.tooltipOptions.visualVariables)&&s(this.tooltipOptions.visualVariables.size)?this.tooltipOptions.visualVariables.size.axis:null})}_forEachManipulator(t){this._moveManipulation.forEachManipulator(t),s(this._scaleRotate)&&this._scaleRotate.forEachManipulator(t)}_hideManipulatorsForGraphicState(){return r((()=>this.graphicState.displaying),(t=>{this._forEachManipulator((e=>e.available=t)),this._moveManipulation.zManipulation.available=t&&this.enableZ&&f(this.graphic)}))}_createGeometryUndoRecord(){return A(this.graphic)}set snapToScene(t){this._moveManipulation&&(this._moveManipulation.snapToScene=t),this._set("snapToScene",t)}get updating(){return this.updatingHandles.updating}set location(t){this._moveManipulation.location=t,s(this._scaleRotate)&&(this._scaleRotate.location=t)}set elevationAlignedLocation(t){this._moveManipulation.elevationAlignedLocation=t,s(this._scaleRotate)&&(this._scaleRotate.elevationAlignedLocation=t)}reset(){}onHide(){s(this._scaleRotate)&&this._scaleRotate.cancelActiveAnimation()}_onScaleChanged(){if(o(this._scaleRotate))return;const t=this._scaleRotate.getScale();this._moveManipulation.displayScale=t}_updateMoveAngle(){this.view.state.viewingMode===d.Local||this.view.scale<y?this._moveManipulation.angle=this._scaleRotateAdapter.angle:this._moveManipulation.angle=0}_onGeometryChanged(){g(this.view,this,this.graphic)}_enforceNonZeroSize(t){return t||this.view.state.camera.computeRenderPixelSizeAt(this._moveManipulation.renderLocation)}get test(){return{discManipulator:this._moveManipulation.xyManipulation.test.discManipulator,zManipulator:this._moveManipulation.zManipulation.test.manipulator,ringManipulator:s(this._scaleRotate)?this._scaleRotate.test.ringManipulator:null,arrowManipulators:this._moveManipulation.xyAxisManipulation.test.arrowManipulators,scaleRotateAdapter:this._scaleRotateAdapter,scaleRotateTransform:this._scaleRotate,tooltip:this._tooltip}}};t([l({constructOnly:!0,nonNullable:!0})],k.prototype,"view",void 0),t([l({constructOnly:!0,nonNullable:!0})],k.prototype,"graphic",void 0),t([l({constructOnly:!0,nonNullable:!0})],k.prototype,"enableZ",void 0),t([l()],k.prototype,"enableRotation",void 0),t([l()],k.prototype,"enableScaling",void 0),t([l({constructOnly:!0,type:G})],k.prototype,"tooltipOptions",void 0),t([l()],k.prototype,"graphicState",void 0),t([l({value:!1})],k.prototype,"snapToScene",null),t([l({constructOnly:!0})],k.prototype,"snappingManager",void 0),t([l({readOnly:!0})],k.prototype,"type",void 0),t([l({readOnly:!0})],k.prototype,"updating",null),k=t([c("esri.views.3d.interactive.editingTools.graphicTransform3D.GraphicTransformTool")],k);export{k as GraphicTransformTool};
