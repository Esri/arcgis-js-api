/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../core/Evented","../../../../../core/HandleOwner","../../../../../core/handleUtils","../../../../../core/maybe","../../../../../core/quantityUtils","../../../../../core/reactiveUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/accessorSupport/ensureType","../../../../../core/arrayUtils","../../../../../core/accessorSupport/decorators/subclass","../../../../../geometry/Point","../../../../../support/elevationInfoUtils","../../../../ViewingMode","../../Manipulator3D","../../manipulatorUtils","../../SnappingVisualizer3D","../manipulatorUtils","../visualElementUtils","../manipulations/config","../manipulations/MoveManipulation","../manipulations/moveUtils","./GraphicScaleRotateTransform","./ScaleRotateMeshAdapter","./ScaleRotateObjectSymbol3DAdapter","./undoRecords","../../../layers/graphics/GraphicState","../../../../interactive/dragEventPipeline","../../../../interactive/InteractiveToolBase","../../../../interactive/editGeometry/EditGeometryOperations","../../../../interactive/sketch/SketchTooltipOptions","../../../../interactive/snapping/SnappingContext","../../../../interactive/snapping/SnappingDragPipelineStep","../../../../interactive/tooltip/Tooltip","../../../../interactive/tooltip/TranslateTooltipInfos","../../../../support/automaticLengthMeasurementUtils","../../../../support/euclideanLengthMeasurementUtils"],(function(t,e,a,i,o,n,s,r,l,p,c,h,u,d,_,g,v,m,M,y,f,S,T,R,b,w,G,A,O,x,E,D,z,I,k,L,U,C,H){"use strict";t.GraphicTransformTool=function(t){function a(e){var a;return(a=t.call(this,e)||this).enableZ=!0,a.enableRotation=!0,a.enableScaling=!0,a.tooltipOptions=new z,a.type="transform-3d",a._scaleRotate=null,a._tooltip=null,a}e._inheritsLoose(a,t);var i=a.prototype;return i.initialize=function(){const{graphic:t,view:e}=this;this.graphicState=new O.GraphicState({graphic:t}),this.addHandles(l.watch((()=>this.tooltipOptions.enabled),(t=>{this._tooltip=t?new L.Tooltip({view:e}):s.destroyMaybe(this._tooltip)}),l.syncAndInitial)),this._moveManipulation=new T.MoveManipulation({tool:this,view:e,snapToScene:this.snapToScene,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZ&&y.canMoveZ(t),radius:T.MoveManipulation.radiusForSymbol(t.symbol)}),this._moveManipulation.forEachManipulator((e=>this.handles.add(e.events.on("immediate-click",(e=>{this.emit("immediate-click",{...e,graphic:t}),e.stopPropagation()})))));const a=t=>e=>{this.handles.add(e.events.on("focus-changed",(({action:e})=>{const a=this._tooltip;s.isNone(a)||("focus"===e?this._updateMoveTooltip(t):a.clear())})))};this._moveManipulation.xyManipulation.forEachManipulator(a(T.ManipulationType.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(a(T.ManipulationType.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(a(T.ManipulationType.Z));const i=_.getGraphicEffectiveElevationInfo(t);this._moveManipulation.elevationInfo=i;const o=t.geometry;if(this._moveManipulation.createGraphicDragPipeline(((a,n,r,l,p)=>{if(s.isSome(o)&&a===T.ManipulationType.XY){const{snappingStep:a,cancelSnapping:n}=k.createSnapDragEventPipelineStep({snappingContext:new I.SnappingContext({elevationInfo:i,pointer:p,editGeometryOperations:D.EditGeometryOperations.fromGeometry(new d({spatialReference:o.spatialReference}),e.state.viewingMode),visualizer:new M.SnappingVisualizer3D,excludeFeature:t}),snappingManager:this.snappingManager,updatingHandles:this.updatingHandles,useZ:!1});l=l.next(n),r=r.next(x.sceneSnappingAtProjectedLocation(this.view,i)).next(...a)}return{steps:r=r.next((t=>(this._updateMoveTooltip(a,t),t))),cancel:l}}),this.graphicState,(t=>{const{action:e,graphic:a,dxScreen:i,dyScreen:o}=t,n={graphic:a,dxScreen:i,dyScreen:o};switch(e){case"start":this.emit("graphic-translate-start",n),this.emit("record-undo",{record:this._createGeometryUndoRecord()});break;case"update":this.emit("graphic-translate",n);break;case"end":this.emit("graphic-translate-stop",n)}})),this._moveManipulation.angle=s.isSome(this._scaleRotate)?this._scaleRotate.angle:0,this._scaleRotateAdapter=this._createScaleRotateAdapter(),this.handles.add(l.watch((()=>this._scaleRotateAdapter.angle),(()=>this._updateMoveAngle()))),this.enableScaling||this.enableRotation){const t=this.enableScaling&&this.enableRotation?null:this.enableScaling?"scale":"rotate";this._scaleRotate=new b.GraphicScaleRotateTransform({tool:this,mode:t,adapter:this._scaleRotateAdapter,tooltipOptions:this.tooltipOptions}),this.handles.add(this._scaleRotate.events.on("scale-changed",(()=>this._onScaleChanged())))}this.handles.add([f.createVisualElements({view:this.view,graphic:this.graphic,forEachManipulator:t=>this._forEachManipulator(t),onManipulatorsChanged:()=>n.makeHandle()}),this.graphicState.on("changed",(()=>this._onGeometryChanged())),this._hideManipulatorsForGraphicState(),l.watch((()=>e.scale),(()=>this._updateMoveAngle()))]),this.handles.add(this.view.trackGraphicState(this.graphicState)),this._onGeometryChanged(),this._updateMoveAngle(),this._forEachManipulator((t=>{t instanceof v.Manipulator3D&&this.handles.add(t.events.on("grab-changed",(()=>this._updateManipulatorsInteractive())))})),this.finishToolCreation()},i.destroy=function(){this._tooltip=s.destroyMaybe(this._tooltip),this._moveManipulation.destroy(),this._scaleRotate=s.destroyMaybe(this._scaleRotate),this._scaleRotateAdapter=s.destroyMaybe(this._scaleRotateAdapter),this._set("view",null),this._set("graphic",null)},i._updateManipulatorsInteractive=function(){s.isNone(this._scaleRotate)||(this._scaleRotate.interactive=!this._moveManipulation.grabbing,this._moveManipulation.interactive=!this._scaleRotate.grabbing)},i._createScaleRotateAdapter=function(){return s.isSome(this.graphic.geometry)&&"mesh"===this.graphic.geometry.type?new w.ScaleRotateMeshAdapter({graphic:this.graphic,geometry:this.graphic.geometry,viewingMode:this.view.state.viewingMode}):new G.ScaleRotateObjectSymbol3DAdapter({graphic:this.graphic,sizeFilter:t=>this._enforceNonZeroSize(t),findLayerView:()=>this.view.allLayerViews.find((t=>t.layer===this.graphic.layer)),sizeAxis:s.isSome(this.tooltipOptions.visualVariables)&&s.isSome(this.tooltipOptions.visualVariables.size)?this.tooltipOptions.visualVariables.size.axis:null})},i._forEachManipulator=function(t){this._moveManipulation.forEachManipulator(t),s.isSome(this._scaleRotate)&&this._scaleRotate.forEachManipulator(t)},i._hideManipulatorsForGraphicState=function(){return l.watch((()=>this.graphicState.displaying),(t=>{this._forEachManipulator((e=>e.available=t)),this._moveManipulation.zManipulation.available=t&&this.enableZ&&y.canMoveZ(this.graphic)}))},i._createGeometryUndoRecord=function(){return A.createGraphicGeometryUndoRecord(this.graphic)},i.reset=function(){},i.onHide=function(){s.isSome(this._scaleRotate)&&this._scaleRotate.cancelActiveAnimation()},i._onScaleChanged=function(){if(s.isNone(this._scaleRotate))return;const t=this._scaleRotate.getScale();this._moveManipulation.displayScale=t},i._updateMoveAngle=function(){this.view.state.viewingMode===g.ViewingMode.Local||this.view.scale<S.ALIGN_ARROWS_SCALE_THRESHOLD?this._moveManipulation.angle=this._scaleRotateAdapter.angle:this._moveManipulation.angle=0},i._onGeometryChanged=function(){m.placeAtGraphic(this.view,this,this.graphic)},i._enforceNonZeroSize=function(t){return t||this.view.state.camera.computeRenderPixelSizeAt(this._moveManipulation.renderLocation)},i._updateMoveTooltip=function(t,e){const{tooltipOptions:a,_tooltip:i}=this;if(s.isNone(i))return;i.clear();const o=this.graphicState.isDraped?"on-the-ground":"absolute-height";switch(t){case T.ManipulationType.XY:i.info=new U.TranslateGraphicTooltipInfo({tooltipOptions:a}),this._updateMoveTooltipDistance(i.info,e,((t,e)=>C.autoHorizontalDistanceByElevationModeBetweenPoints(t,e,o)));break;case T.ManipulationType.XY_AXIS:i.info=new U.TranslateGraphicXYTooltipInfo({tooltipOptions:a}),this._updateMoveTooltipDistance(i.info,e,((t,a)=>{const i=C.autoHorizontalDistanceByElevationModeBetweenPoints(t,a,o);return r.scale(i,R.axisConstrainedDragSign(e))}));break;case T.ManipulationType.Z:i.info=new U.TranslateGraphicZTooltipInfo({tooltipOptions:a}),this._updateMoveTooltipDistance(i.info,e,H.verticalSignedDistanceBetweenPoints)}},i._updateMoveTooltipDistance=function(t,e,a){if(s.isSome(e)&&"end"!==e.action){const{mapStart:i,mapEnd:o}=e,n=a(i,o);t.distance=s.isSome(n)?n:r.zeroMeters}},e._createClass(a,[{key:"snapToScene",set:function(t){this._moveManipulation&&(this._moveManipulation.snapToScene=t),this._set("snapToScene",t)}},{key:"updating",get:function(){return this.updatingHandles.updating}},{key:"location",set:function(t){this._moveManipulation.location=t,s.isSome(this._scaleRotate)&&(this._scaleRotate.location=t)}},{key:"elevationAlignedLocation",set:function(t){this._moveManipulation.elevationAlignedLocation=t,s.isSome(this._scaleRotate)&&(this._scaleRotate.elevationAlignedLocation=t)}},{key:"test",get:function(){return{discManipulator:this._moveManipulation.xyManipulation.test.discManipulator,zManipulator:this._moveManipulation.zManipulation.test.manipulator,ringManipulator:s.isSome(this._scaleRotate)?this._scaleRotate.test.ringManipulator:null,arrowManipulators:this._moveManipulation.xyAxisManipulation.test.arrowManipulators,setRingIndicatorDelayMs:t=>s.isSome(this._scaleRotate)?this._scaleRotate.test.setRingIndicatorDelayMs(t):null,scaleRotateAdapter:this._scaleRotateAdapter,scaleRotateTransform:this._scaleRotate,tooltip:this._tooltip}}}]),a}(o.HandleOwnerMixin(i.EventedMixin(E.InteractiveToolBase))),a.__decorate([p.property({constructOnly:!0,nonNullable:!0})],t.GraphicTransformTool.prototype,"view",void 0),a.__decorate([p.property({constructOnly:!0,nonNullable:!0})],t.GraphicTransformTool.prototype,"graphic",void 0),a.__decorate([p.property({constructOnly:!0,nonNullable:!0})],t.GraphicTransformTool.prototype,"enableZ",void 0),a.__decorate([p.property()],t.GraphicTransformTool.prototype,"enableRotation",void 0),a.__decorate([p.property()],t.GraphicTransformTool.prototype,"enableScaling",void 0),a.__decorate([p.property({constructOnly:!0,type:z})],t.GraphicTransformTool.prototype,"tooltipOptions",void 0),a.__decorate([p.property()],t.GraphicTransformTool.prototype,"graphicState",void 0),a.__decorate([p.property({value:!1})],t.GraphicTransformTool.prototype,"snapToScene",null),a.__decorate([p.property({constructOnly:!0})],t.GraphicTransformTool.prototype,"snappingManager",void 0),a.__decorate([p.property({readOnly:!0})],t.GraphicTransformTool.prototype,"type",void 0),a.__decorate([p.property({readOnly:!0})],t.GraphicTransformTool.prototype,"updating",null),t.GraphicTransformTool=a.__decorate([u.subclass("esri.views.3d.interactive.editingTools.graphicTransform3D.GraphicTransformTool")],t.GraphicTransformTool),Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
