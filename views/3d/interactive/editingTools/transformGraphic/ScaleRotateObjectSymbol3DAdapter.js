/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{_ as t}from"../../../../../chunks/tslib.es6.js";import e from"../../../../../core/Accessor.js";import{HandleOwner as i}from"../../../../../core/HandleOwner.js";import{deg2rad as o,rad2deg as r}from"../../../../../core/mathUtils.js";import{isSome as n,isNone as s,unwrapOr as l}from"../../../../../core/maybe.js";import{when as a,sync as c}from"../../../../../core/reactiveUtils.js";import{property as h}from"../../../../../core/accessorSupport/decorators/property.js";import"../../../../../core/arrayUtils.js";import"../../../../../core/has.js";import"../../../../../core/accessorSupport/ensureType.js";import{subclass as p}from"../../../../../core/accessorSupport/decorators/subclass.js";let y=class extends i{constructor(t){super(t),this.sizeAxis=null,this.interactionState=null}initialize(){this.own(a((()=>n(this.interactionState)?this.interactionState.state:null),(t=>{this._updateSymbol(t)}),c))}get angle(){return n(this.interactionState)?this.interactionState.angle:n(this._orientationReferenceSymbolLayer)?g(this._orientationReferenceSymbolLayer.heading):0}get scale(){return n(this.interactionState)?this.interactionState.scale:1}get relativeAngle(){return this.angle-this.initialAngle}get initialAngle(){return n(this.interactionState)?this.interactionState.initialAngle:0}get size(){const t=this._sizeReferenceSymbolLayer;if(s(t))return null;const e=this.findLayerView(),i=this._graphicSymbol;if(s(e)||s(i)||"point-3d"!==i.type)return null;const o=e.getSymbolLayerSize(i,t);if("size"in o&&n(o.size))return o.size;const r=this.sizeAxis;return"width"in o&&n(o.width)&&(s(r)||"width"===r||"all"===r||"width-and-depth"===r)?o.width:"depth"in o&&n(t.depth)&&(s(r)||"depth"===r||"all"===r||"width-and-depth"===r)?o.depth:"height"in o&&n(t.height)&&(s(r)||"height"===r||"all"===r)?o.height:null}get _sizeReferenceSymbolLayer(){const t=this._graphicSymbol;return s(t)||0===t.symbolLayers.length?null:t.symbolLayers.find((t=>"object"===t.type))}get _orientationReferenceSymbolLayer(){const t=this._graphicSymbol;return s(t)||0===t.symbolLayers.length?null:t.symbolLayers.find((t=>"object"===t.type&&n(t.heading)))}get _graphicSymbol(){return n(this.graphic)&&n(this.graphic.symbol)&&"point-3d"===this.graphic.symbol.type?this.graphic.symbol:null}set _graphicSymbol(t){this.graphic.symbol=t}startInteraction(){const t=this._graphicSymbol,e=this.findLayerView();if(n(this.interactionState)||s(t)||s(e))return m;const i=t.symbolLayers.map((i=>"object"===i.type?e.getSymbolLayerSize(t,i):null)).toArray(),o=t.clone(),r=this.angle,l=new d({originalSymbol:o,angle:r,initialSizes:i});this.interactionState=l;const a=()=>this.interactionState=null;return{state:l,done:a,cancel:()=>{this._graphicSymbol=o,a()}}}createUndoRecord(){let t=this.graphic.symbol,e=null;return{undo:i=>{e=i.symbol,i.symbol=t},redo:i=>{t=i.symbol,i.symbol=e}}}_updateSymbol({scale:t,angle:e,originalSymbol:i,initialSizes:o}){const a=this._graphicSymbol;if(s(a)||"point-3d"!==a.type)return;const c=a.clone(),h=-r(e-this.initialAngle);let p=!1;this._forEachObjectSymbolLayerPair(i,c,((e,i,r)=>{const s=l(e.heading,0)+h;i.heading!==s&&(i.heading=s,p=!0);const a=o[r];if(n(a)&&"width"in a){a.width=this.sizeFilter(a.width),a.height=this.sizeFilter(a.height),a.depth=this.sizeFilter(a.depth);const e=a.width*t;i.width!==e&&(i.width=e,p=!0);const o=a.depth*t;i.depth!==o&&(i.depth=o,p=!0);const r=a.height*t;i.height!==r&&(i.height=r,p=!0)}})),p&&(this._graphicSymbol=c)}_forEachObjectSymbolLayerPair(t,e,i){t.symbolLayers.forEach(((t,o)=>{const r=e.symbolLayers.getItemAt(o);"object"===t.type&&"object"===r.type&&i(t,r,o)}))}};function g(t){return-o(t)}t([h()],y.prototype,"angle",null),t([h()],y.prototype,"scale",null),t([h()],y.prototype,"relativeAngle",null),t([h()],y.prototype,"initialAngle",null),t([h()],y.prototype,"size",null),t([h()],y.prototype,"sizeAxis",void 0),t([h({constructOnly:!0})],y.prototype,"graphic",void 0),t([h()],y.prototype,"interactionState",void 0),t([h({constructOnly:!0})],y.prototype,"findLayerView",void 0),t([h({constructOnly:!0})],y.prototype,"sizeFilter",void 0),t([h()],y.prototype,"_sizeReferenceSymbolLayer",null),t([h()],y.prototype,"_orientationReferenceSymbolLayer",null),t([h()],y.prototype,"_graphicSymbol",null),y=t([p("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateObjectSymbol3DAdapter")],y);const m={state:{angle:0,scale:0},done:()=>{},cancel:()=>{}};let d=class extends e{constructor(t){super(t),this.angle=0,this.initialAngle=0,this.scale=1,this.initialAngle=t.angle}get state(){const{originalSymbol:t,angle:e,initialAngle:i,scale:o,initialSizes:r}=this;return{originalSymbol:t,angle:e,initialAngle:i,scale:o,initialSizes:r}}};t([h()],d.prototype,"originalSymbol",void 0),t([h()],d.prototype,"angle",void 0),t([h()],d.prototype,"initialAngle",void 0),t([h()],d.prototype,"initialSizes",void 0),t([h()],d.prototype,"scale",void 0),t([h()],d.prototype,"state",null),d=t([p("InteractionState")],d);export{y as ScaleRotateObjectSymbol3DAdapter,g as headingToAngle};
