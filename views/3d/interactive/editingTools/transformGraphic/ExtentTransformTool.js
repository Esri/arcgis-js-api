/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../core/Evented","../../../../../core/Handles","../../../../../core/handleUtils","../../../../../core/mathUtils","../../../../../core/maybe","../../../../../core/screenUtils","../../../../../core/unitUtils","../../../../../core/watchUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/arrayUtils","../../../../../core/has","../../../../../core/accessorSupport/ensureType","../../../../../core/accessorSupport/decorators/subclass","../../../../../chunks/mat4","../../../../../chunks/vec2","../../../../../chunks/vec2f64","../../../../../chunks/vec3","../../../../../chunks/vec3f64","../../../../../geometry/support/aaBoundingRect","../../../../../chunks/boundedPlane","../../../../../geometry/support/plane","../../../../../geometry/support/ray","../../../../../geometry/support/vectorStacks","../../../../../support/elevationInfoUtils","../../Manipulator3D","../../manipulatorUtils","../../analysisTools/slice/sliceToolUtils","../../analysisTools/slice/images/Factory","../dragEventPipeline3D","../ManipulatorType","../manipulatorUtils","../visualElementUtils","../manipulations/MoveXYGraphicManipulation","./PreserveAspectRatio","../../visualElements/OutlineVisualElement","../../../layers/graphics/elevationAlignmentUtils","../../../layers/graphics/ElevationContext","../../../layers/graphics/GraphicState","../../../support/geometryUtils/ray","../../../../interactive/dragEventPipeline","../../../../interactive/InteractiveToolBase","../../../../interactive/editGeometry/EditGeometryOperations","../../../../interactive/editGeometry/interfaces","../../../../interactive/editGeometry/operations/UpdateVertices","../../../../interactive/editGeometry/support/editPlaneUtils"],(function(t,e,a,i,n,s,r,o,p,l,c,h,d,u,g,m,y,v,S,f,M,_,T,E,b,B,A,R,x,O,G,P,D,w,z,U,C,k,Z,H,N,L,V,I,X,Y,F,W){"use strict";t.ExtentTransformTool=function(t){function a(e){var a;return(a=t.call(this,e)||this).enableZ=!0,a.enableRotation=!0,a.enableScaling=!0,a._preserveAspectRatio=new C.PreserveAspectRatio,a.grabbing=!1,a.inputState=null,a.type="transform-3d",a.handles=new n,a.moveZManipulator=null,a.resizeManipulators=null,a.rotateManipulator=null,a.attachmentOrigin=null,a.outlineVisualElement=null,a.mapBounds=T.create(),a.mapBoundsStart=T.create(),a.displayBounds=T.create(),a.displayBoundsStart=T.create(),a.displayBoundsMarginStart=0,a.resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}],a}e._inheritsLoose(a,t);var i=a.prototype;return i.initialize=function(){this.graphicState=new N.GraphicState({graphic:this.graphic});const t=this.graphic.geometry;this.editGeometryOperations=X.EditGeometryOperations.fromGeometry(t,this.view.state.viewingMode),this.graphicMoveManipulation=new U.MoveXYGraphicManipulation({tool:this,view:this.view,graphicState:this.graphicState}),this.handles.add(this._createMoveXYGraphicDragPipeline()),this.moveZManipulator=O.createShiftManipulator(this.view,O.OffsetMode.CENTER_ON_CALLOUT),this.moveZManipulator.state|=O.IsShiftEdgeOnScreenFlag,this.handles.add(this.watch("enableZ",(()=>this._updateManipulatorAvailability(this.moveZManipulator,D.ManipulatorType.TRANSLATE_Z)))),this.handles.add(this._createMoveZDragPipeline()),this.manipulators.add(this.moveZManipulator),this.resizeManipulators=this.resizeHandles.map((t=>{const e=O.createResizeManipulator(this.view,t);return this.handles.add(this.watch("enableScaling",(()=>this._updateManipulatorAvailability(e,D.ManipulatorType.SCALE)))),e.events.on("grab-changed",(t=>this._onResizeGrab(t))),this.handles.add(this._createResizeDragPipeline(e,t)),e})),this.manipulators.addMany(this.resizeManipulators),this.rotateManipulatorTexture=G.getRotateHeadingTexture(this.view.toolViewManager.textures),this.rotateManipulator=O.createRotateManipulator(this.view,this.rotateManipulatorTexture.texture),this.handles.add(this.watch("enableRotation",(()=>this._updateManipulatorAvailability(this.rotateManipulator,D.ManipulatorType.ROTATE)))),this.rotateManipulator.events.on("grab-changed",(t=>{this._onRotateGrab(t)})),this.handles.add(this._createRotateDragPipeline(this.rotateManipulator)),this.manipulators.add(this.rotateManipulator),this._calculateMapBounds(),this._updateDisplayBounds();const e=z.createVisualElements({view:this.view,graphic:this.graphic,forEachManipulator:t=>this._forEachManipulator(t),onManipulatorsChanged:()=>s.makeHandle()});o.isSome(e)&&(this.outlineVisualElement=e.visualElement instanceof k.OutlineVisualElement?e.visualElement:null),o.isSome(this.outlineVisualElement)&&this.handles.add(this.outlineVisualElement.events.on("attachment-origin-changed",(()=>this._updateDisplayBounds()))),this.handles.add(e),this.handles.add([this.graphicState.on("changed",(()=>this._onGeometryChanged())),this.graphicState.watch("displaying",(()=>this._updateAllManipulatorAvailability())),c.init(this.graphicState,"isDraped",(()=>this._graphicDrapedChanged())),this.view.trackGraphicState(this.graphicState)]);const a=this.view.pointsOfInterest;a&&this.handles.add(a.centerOnSurfaceFrequent.watch("location",(()=>this._updateDisplayBounds())));const i=t=>{this.handles.add(t.events.on("grab-changed",(()=>{this.grabbing=t.grabbing,this._updateAllManipulatorAvailability()})))};this._forEachManipulator(i);const n=(t,e)=>{this.handles.add(t.events.on("immediate-click",(t=>{e===D.ManipulatorType.TRANSLATE_XY&&this.emit("immediate-click",{...t,graphic:this.graphic}),t.stopPropagation()})))};this._forEachManipulator(n),this._onGeometryChanged(),this._updateAllManipulatorAvailability(),this.finishToolCreation()},i._graphicDrapedChanged=function(){this.handles.remove(j),this._updateDisplayBounds(),this.graphicState.isDraped&&this.handles.add(this.view.elevationProvider.on("elevation-change",(t=>{o.isSome(this.attachmentOrigin)&&_.containsXY(t.extent,this.attachmentOrigin.x,this.attachmentOrigin.y)&&this._updateDisplayBounds()})),j)},i._updateAllManipulatorAvailability=function(){this._forEachManipulator(((t,e)=>this._updateManipulatorAvailability(t,e)))},i._updateManipulatorAvailability=function(t,e){const a=this.grabbing&&!t.grabbing;if(t.interactive=!a,t instanceof R.Manipulator3D){const i=this.graphicState.displaying,n=this.enableZ&&w.canMoveZ(this.graphic);switch(e){case D.ManipulatorType.ROTATE:t.available=i&&this.enableRotation;break;case D.ManipulatorType.SCALE:t.available=i&&(this.enableScaling||this.enableRotation||n),t.interactive=!a&&this.enableScaling,t.state=this.enableScaling?O.resizeNormal:O.resizeOutlineOnly;break;case D.ManipulatorType.TRANSLATE_Z:t.available=i&&n;break;default:t.available=i}}},i._forEachManipulator=function(t){this.graphicMoveManipulation.forEachManipulator(t),this.resizeManipulators.forEach((e=>t(e,D.ManipulatorType.SCALE))),t(this.rotateManipulator,D.ManipulatorType.ROTATE),t(this.moveZManipulator,D.ManipulatorType.TRANSLATE_Z)},i.destroy=function(){this.mapBounds=null,this.displayBounds=null,this.rotateManipulatorTexture.release(),this.handles.destroy(),this.graphicMoveManipulation.destroy(),this.editGeometryOperations.destroy(),this._set("view",null),this._set("graphic",null)},i.reset=function(){},i._onGeometryChanged=function(){this._updateDisplayBounds()},i._calculateMapBounds=function(){const t=this.graphic.geometry,e=this.editGeometryOperations.data,a=e.components[0].edges[0],i=v.subtract(B.sv2d.get(),a.leftVertex.pos,a.rightVertex.pos);v.normalize(i,i);const n=o.unwrapOr(x.getGraphicAttachmentOrigin(this.view,this.graphic),t.extent.center);let s=J*this.view.pixelSizeAt(n);const r=this.view.spatialReference;r!==t.spatialReference&&(s*=l.getMetersPerUnitForSR(r)/l.getMetersPerUnitForSR(t.spatialReference)),W.calculateOrientedBounds(i,e,s,this.mapBounds)},i._updateDisplayBounds=function(){const t=this.graphic.geometry;if(o.isNone(t))return;const e=o.isSome(this.outlineVisualElement)&&!this.graphicState.isDraped&&o.isSome(this.outlineVisualElement.attachmentOrigin)?this.outlineVisualElement.attachmentOrigin:x.getGraphicAttachmentOrigin(this.view,this.graphic);this.attachmentOrigin=o.unwrapOr(e,t.extent.center);const a=o.isSome(e)?e.z:Z.evaluateElevationAlignmentAtPoint(this.mapBounds.origin,this.view.elevationProvider,H.ElevationContext.fromElevationInfo(A.getGraphicEffectiveElevationInfo(this.graphic)),this.view.renderCoordsHelper),i=T.copy(this.mapBounds);i.origin[2]=a,W.mapPlaneToRenderPlane(i,this.view.renderCoordsHelper,t.spatialReference,this.displayBoundsMargin,this.displayBounds),this._updateManipulators()},i._createMoveXYGraphicDragPipeline=function(){return this.graphicMoveManipulation.createDragPipeline(((t,e,a)=>this._applyGraphicMoveSteps(e,a)))},i._createMoveZDragPipeline=function(){const t=this.view,e=this.editGeometryOperations.data.spatialReference;return V.createManipulatorDragEventPipeline(this.moveZManipulator,((a,i,n)=>{const s=M.clone(a.renderLocation),r=i.next(P.screenToZConstrained(t,s,e)).next(V.addScreenDelta());this._applyGraphicMoveSteps(r,n)}))},i._applyGraphicMoveSteps=function(t,e){const a=t.next((t=>("start"===t.action&&(this.inputState={type:"move"},T.copy(this.mapBounds,this.mapBoundsStart),this.emit("graphic-translate-start",{graphic:this.graphic,dxScreen:t.screenDeltaX,dyScreen:t.screenDeltaY})),t))).next(V.addMapDelta()).next(this._moveDragUpdateGeometry()).next((t=>{const e={graphic:this.graphic,dxScreen:t.screenDeltaX,dyScreen:t.screenDeltaY};switch(t.action){case"start":case"update":(t.mapEnd.x-t.mapStart.x||t.mapEnd.y-t.mapStart.y||t.mapEnd.z-t.mapStart.z)&&this.emit("graphic-translate",e);break;case"end":this.inputState=null,this.emit("graphic-translate-stop",e)}return t}));return e.next((()=>{o.isSome(this.inputState)&&this.emit("graphic-translate-stop",{graphic:this.graphic,dxScreen:0,dyScreen:0}),this._cancel()})),a},i._moveDragUpdateGeometry=function(){return t=>{if(o.isNone(this.inputState)||"move"!==this.inputState.type)return t;const e=[];for(const n of this.editGeometryOperations.data.components)e.push(...n.vertices);const a="start"===t.action?Y.AccumulationBehaviour.NEW_STEP:Y.AccumulationBehaviour.ACCUMULATE_STEPS,i=this.editGeometryOperations.moveVertices(e,t.mapDeltaX,t.mapDeltaY,t.mapDeltaZ,a);return W.apply(i,this.mapBounds),this.graphic.geometry=this.editGeometryOperations.data.geometry,t}},i._onResizeGrab=function(t){if("start"!==t.action)return;const e=this._calculatePickRay(t.screenPoint);E.intersectRay(this.displayBounds.plane,e,B.sv3d.get())&&(T.copy(this.displayBounds,this.displayBoundsStart),T.copy(this.mapBounds,this.mapBoundsStart),this.displayBoundsMarginStart=this.displayBoundsMargin,this.inputState={type:"resize"})},i._createResizeDragPipeline=function(t,e){return V.createManipulatorDragEventPipeline(t,((t,a,i)=>{o.isNone(this.inputState)||(a.next((t=>("start"===t.action&&this.emit("graphic-scale-start",{graphic:this.graphic,xScale:1,yScale:1}),t))).next(P.screenToRenderPlane(this.view,this.displayBoundsStart.plane)).next((t=>({...t,handle:e}))).next(this._resizeDragRenderPlaneToFactors()).next(this._preserveAspectRatio.createDragEventPipelineStep(),this._preserveAspectRatio.next).next(this._resizeDragUpdateGeometry()).next((t=>{const e={graphic:this.graphic,xScale:t.factor1,yScale:t.factor2};switch(t.action){case"start":case"update":this.emit("graphic-scale",e);break;case"end":this.inputState=null,this.emit("graphic-scale-stop",e)}return t})),i.next((()=>{o.isSome(this.inputState)&&this.emit("graphic-scale-stop",{graphic:this.graphic,xScale:1,yScale:1}),this._cancel()})))}))},i._resizeDragRenderPlaneToFactors=function(){return t=>{const e=this.displayBoundsStart,a=t.handle.direction,i=this.displayBoundsMargin,n=this.displayBoundsMarginStart,s=f.copy(B.sv3d.get(),e.origin);f.scaleAndAdd(s,s,e.basis1,-a[0]),f.scaleAndAdd(s,s,e.basis2,-a[1]);const r=f.subtract(B.sv3d.get(),t.renderEnd,s),o=f.subtract(B.sv3d.get(),t.renderStart,s),p=O.isDiagonalResizeHandle(t.handle),l=O.calculateDiagonalResizeHandleScale(e),c=O.calculateDiagonalResizeHandleScale(this.displayBounds)/l,h=(t,e)=>{if(0===t)return 1;let a=f.length(e),s=.5*t*f.dot(e,r)/a;const l=s<0?-1:1;if(p){s+=(a-.5*t*f.dot(e,o)/a)*l*c}const h=a<1.5*n?1:K;return a=Math.max(a-n,K),l>0&&(s-=i),l*Math.max(l*(s/a),h)};return{...t,factor1:h(a[0],e.basis1),factor2:h(a[1],e.basis2)}}},i._resizeDragUpdateGeometry=function(){return t=>{const e=f.copy(M.create(),this.mapBoundsStart.origin);f.scaleAndAdd(e,e,this.mapBoundsStart.basis1,-t.handle.direction[0]),f.scaleAndAdd(e,e,this.mapBoundsStart.basis2,-t.handle.direction[1]);const a=v.set(S.create(),this.mapBoundsStart.basis1[0],this.mapBoundsStart.basis1[1]);v.normalize(a,a);const i=[];for(const r of this.editGeometryOperations.data.components)i.push(...r.vertices);const n="start"===t.action?Y.AccumulationBehaviour.NEW_STEP:Y.AccumulationBehaviour.ACCUMULATE_STEPS,s=this.editGeometryOperations.scaleVertices(i,e,a,t.factor1,t.factor2,n,F.AccumulationType.REPLACE);return T.copy(this.mapBoundsStart,this.mapBounds),W.apply(s,this.mapBounds),this.graphic.geometry=this.editGeometryOperations.data.geometry,t}},i._onRotateGrab=function(t){if("start"!==t.action)return;const e=O.createRotatePlane(this.displayBounds,this.view.renderCoordsHelper,O.RotationAxis.HEADING,E.create()),a=this._calculatePickRay(t.screenPoint);E.intersectRay(e,a,B.sv3d.get())&&(T.copy(this.displayBounds,this.displayBoundsStart),T.copy(this.mapBounds,this.mapBoundsStart),this.inputState={type:"rotate",rotatePlane:e})},i._createRotateDragPipeline=function(t){return V.createManipulatorDragEventPipeline(t,((t,e,a)=>{const i=this.inputState;o.isNone(i)||(e.next((t=>("start"===t.action&&this.emit("graphic-rotate-start",{graphic:this.graphic,angle:0}),t))).next(P.screenToRenderPlane(this.view,i.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(i)).next(this._rotateDragUpdateGeometry()).next((t=>{const e={graphic:this.graphic,angle:r.rad2deg(t.rotateAngle)};switch(t.action){case"start":case"update":this.emit("graphic-rotate",e);break;case"end":this.inputState=null,this.emit("graphic-rotate-stop",e)}return t})),a.next((()=>{o.isSome(this.inputState)&&this.emit("graphic-rotate-stop",{graphic:this.graphic,angle:0}),this._cancel()})))}))},i._rotateDragRenderPlaneToRotate=function(t){return e=>{const a=E.normal(t.rotatePlane),i=x.calculateInputRotationTransform(e.renderStart,e.renderEnd,this.displayBounds.origin,a);return{...e,rotateAxis:a,rotateAngle:i}}},i._rotateDragUpdateGeometry=function(){return t=>{const e=f.copy(M.create(),this.mapBoundsStart.origin),a=[];for(const s of this.editGeometryOperations.data.components)a.push(...s.vertices);const i="start"===t.action?Y.AccumulationBehaviour.NEW_STEP:Y.AccumulationBehaviour.ACCUMULATE_STEPS,n=this.editGeometryOperations.rotateVertices(a,e,t.rotateAngle,i,F.AccumulationType.REPLACE);return T.copy(this.mapBoundsStart,this.mapBounds),W.apply(n,this.mapBounds),this.graphic.geometry=this.editGeometryOperations.data.geometry,t}},i._calculatePickRay=function(t){const e=b.create(),a=p.screenPointObjectToArray(t);return L.fromScreen(this.view.state.camera,a,e),f.normalize(e.direction,e.direction),e},i._updateManipulators=function(){if(!this.visible)return;const t=O.calculateBoundedPlaneTranslateRotate(this.displayBounds,B.sm4d.get());O.updateRotateHeadingHandle(this.rotateManipulator,t,this.displayBounds,this.view.renderCoordsHelper),this._updateZMoveHandle(this.moveZManipulator,t),this.resizeManipulators.forEach(((e,a)=>{O.updateResizeHandle(e,this.resizeHandles[a],t,this.displayBounds)}))},i._updateZMoveHandle=function(t,e){const a=this.displayBounds,i={basis:a.basis1,direction:-1,position:f.subtract(B.sv3d.get(),a.origin,a.basis1),edge:2},n=B.sm4d.get();y.rotateZ(n,e,i.edge*Math.PI/2),n[12]=0,n[13]=0,n[14]=0,t.modelTransform=n,t.renderLocation=i.position},i._cancel=function(){const t=this.editGeometryOperations.lastOperation;o.isNone(t)||(this.editGeometryOperations.undo(),this.graphic.geometry=this.editGeometryOperations.data.geometry,W.unapply(t,this.mapBounds),this._updateDisplayBounds(),this.inputState=null)},i.undo=function(){if(o.isSome(this.inputState))this.view.activeTool=null;else if(this.canUndo){const t=this.editGeometryOperations.undo();this.graphic.geometry=this.editGeometryOperations.data.geometry,W.unapply(o.unwrap(t),this.mapBounds),this._updateDisplayBounds()}},i.redo=function(){if(this.canRedo){const t=this.editGeometryOperations.redo();this.graphic.geometry=this.editGeometryOperations.data.geometry,W.apply(o.unwrap(t),this.mapBounds),this._updateDisplayBounds()}},e._createClass(a,[{key:"preserveAspectRatio",get:function(){return this._preserveAspectRatio.enabled},set:function(t){this._preserveAspectRatio.enabled=t,this._set("preserveAspectRatio",t)}},{key:"displayBoundsMargin",get:function(){const t=this.view.pointsOfInterest,e=t?t.centerOnSurfaceFrequent.location:this.editGeometryOperations.data.geometry.extent.center;return q*this.view.pixelSizeAt(e)}},{key:"canUndo",get:function(){return this.editGeometryOperations.canUndo}},{key:"canRedo",get:function(){return this.editGeometryOperations.canRedo}},{key:"test",get:function(){return{resizeManipulators:this.resizeManipulators,rotateManipulator:this.rotateManipulator,moveZManipulator:this.moveZManipulator}}}]),a}(i.EventedMixin(I.InteractiveToolBase)),a.__decorate([h.property({constructOnly:!0,nonNullable:!0})],t.ExtentTransformTool.prototype,"view",void 0),a.__decorate([h.property({constructOnly:!0,nonNullable:!0})],t.ExtentTransformTool.prototype,"graphic",void 0),a.__decorate([h.property({constructOnly:!0,nonNullable:!0})],t.ExtentTransformTool.prototype,"enableZ",void 0),a.__decorate([h.property()],t.ExtentTransformTool.prototype,"enableRotation",void 0),a.__decorate([h.property()],t.ExtentTransformTool.prototype,"enableScaling",void 0),a.__decorate([h.property()],t.ExtentTransformTool.prototype,"preserveAspectRatio",null),a.__decorate([h.property()],t.ExtentTransformTool.prototype,"grabbing",void 0),a.__decorate([h.property()],t.ExtentTransformTool.prototype,"inputState",void 0),a.__decorate([h.property({readOnly:!0})],t.ExtentTransformTool.prototype,"type",void 0),t.ExtentTransformTool=a.__decorate([m.subclass("esri.views.3d.interactive.editingTools.graphicTransform3D.ExtentTransformTool")],t.ExtentTransformTool);const j="draped-elevation-changes",q=10,J=80,K=1e-6;t.EPSILON=K,Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
