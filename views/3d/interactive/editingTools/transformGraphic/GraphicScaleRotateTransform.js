/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/Cyclical","../../../../../core/Evented","../../../../../core/Handles","../../../../../core/mathUtils","../../../../../core/maybe","../../../../../core/quantityUtils","../../../../../core/reactiveUtils","../../../../../core/scheduling","../../../../../core/screenUtils","../../../../../chunks/mat4","../../../../../chunks/mat4f64","../../../../../chunks/vec3","../../../../../chunks/vec3f64","../../../../../chunks/vec4f64","../../../../../geometry/support/plane","../../../../../geometry/support/ray","../../../../../geometry/support/vectorStacks","../../../../../support/elevationInfoUtils","../../Manipulator3D","../../manipulatorUtils","../dragEventPipeline3D","../ManipulatorType","../manipulations/config","../../../webgl-engine/lib/basicInterfaces","../../../webgl-engine/lib/GeometryUtil","../../../webgl-engine/lib/Material","../../../webgl-engine/materials/ColorMaterial","../../../../interactive/dragEventPipeline","../../../../interactive/interfaces","../../../../interactive/tooltip/Tooltip","../../../../interactive/tooltip/TransformTooltipInfos"],(function(t,e,a,i,o,n,s,r,l,c,u,h,d,p,g,_,m,S,T,I,R,D,f,A,E,M,O,C,v,N,y,b,F){"use strict";var k;!function(t){t.ScaleIn=y.ManipulatorStateCustomFlags.Custom2,t.ScaleOut=y.ManipulatorStateCustomFlags.Custom3,t.RotateLeft=y.ManipulatorStateCustomFlags.Custom4,t.RotateRight=y.ManipulatorStateCustomFlags.Custom5,t.Unlocked=y.ManipulatorStateCustomFlags.Custom7,t.DelayedFocused=y.ManipulatorStateCustomFlags.Custom8,t.TouchInput=y.ManipulatorStateCustomFlags.Custom12}(k||(k={}));let P=function(){function t({adapter:t,tooltipOptions:e,mode:a,tool:n}){this._mode=null,this._handles=new o,this._scaleRotateDragData=null,this._activeAnimation=null,this.events=new i,this.getFocused=()=>this._ringManipulator.focused,this.getScale=()=>s.isSome(this._scaleRotateDragData)&&"scale"===this._scaleRotateDragData.mode?this._adapter.scale:1,this.tool=n,this._mode=a,this._adapter=t,this._tooltipOptions=e,this._tooltip=new b.Tooltip({view:n.view}),this._createManipulator(),this._updateDragState(),this._updateManipulatorTransform(),this._handles.add(l.when((()=>!this._tooltipOptions.enabled),(()=>this._tooltip.clear()),l.initial))}var u=t.prototype;return u.destroy=function(){s.isSome(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=null),this._handles=s.destroyMaybe(this._handles),this.tool.manipulators.remove(this._ringManipulator),this._ringManipulator=null,this._tooltip=s.destroyMaybe(this._tooltip)},u.startAnimation=function(t){this.cancelActiveAnimation(),t.start();const e=c.addFrameTask({update:({deltaTime:e})=>{t.update(e)&&this.cancelActiveAnimation()}});this._activeAnimation={...t,frameTask:e}},u.cancelActiveAnimation=function(){s.isSome(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=s.destroyMaybe(this._activeAnimation))},u.forEachManipulator=function(t){t(this._ringManipulator,A.ManipulatorType.SCALE_ROTATE)},u._createManipulator=function(){const t=this._createRingManipulator();this._ringManipulator=t,this.tool.manipulators.add(t);const e=this.tool.graphicState.graphic,i=N.createManipulatorDragEventPipeline(t,((t,i,o)=>{this._scaleRotateDragData=null;const r=this._adapter.startInteraction(),l={mode:"none",origin:g.clone(t.renderLocation),initialAngle:this._adapter.angle,angle:0,angleDir:0,scaleDir:0};this._scaleRotateDragData=l,this._updateDragState();const c=T.sv3d.get();this.tool.view.renderCoordsHelper.worldUpAtPosition(t.renderLocation,c),i.next(f.screenToRenderPlane(this.tool.view,m.fromPositionAndNormal(t.renderLocation,c,m.create()))).next((t=>{const i=m.normal(t.plane),o=D.calculateInputRotationTransform(t.renderStart,t.renderEnd,l.origin,i),c=a.cyclicalPI.shortestSignedDiff(l.angle,o);l.angleDir=n.clamp(l.angleDir+c,-E.ROTATE_INDICATOR_DIRECTION_BUFFER,E.ROTATE_INDICATOR_DIRECTION_BUFFER),l.angle=o;const u=w(l,t),h=u-this._adapter.scale;if(l.scaleDir=n.clamp(l.scaleDir+h,-E.SCALE_INDICATOR_DIRECTION_BUFFER,E.SCALE_INDICATOR_DIRECTION_BUFFER),this._onScaleChanged(),"none"===l.mode){const a=this._mode||U(t,t.plane,l.origin,this.tool.view.state.camera);if(s.isSome(a)){switch(a){case"rotate":this.tool.emit("graphic-rotate-start",{graphic:e,angle:0}),this.tool.emit("record-undo",{record:this._adapter.createUndoRecord()});break;case"scale":this.tool.emit("graphic-scale-start",{graphic:e,xScale:1,yScale:1}),this.tool.emit("record-undo",{record:this._adapter.createUndoRecord()})}l.mode=a}}switch(l.mode){case"rotate":r.state.angle=l.initialAngle+o;break;case"scale":r.state.scale=u,this._onScaleChanged()}switch(this._updateDragState(),this._updateManipulatorTransform(),t.action){case"start":case"update":switch(l.mode){case"rotate":this.tool.emit("graphic-rotate",{graphic:e,angle:n.rad2deg(l.angle)});break;case"scale":this.tool.emit("graphic-scale",{graphic:e,xScale:u,yScale:u})}break;case"end":switch(l.mode){case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:e,angle:n.rad2deg(l.angle)});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:e,xScale:u,yScale:u})}}return"end"===t.action&&(this.startAnimation(H(this,(()=>this._onScaleChanged()))),this._scaleRotateDragData=null,this._updateDragState(),r.done()),t})).next(this._updateTooltipPipelineStep(l)),o.next((()=>{if(r.cancel(),s.isSome(this._scaleRotateDragData)){switch(this._scaleRotateDragData.mode){case"none":break;case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:e,angle:0});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:e,xScale:1,yScale:1})}this.startAnimation(H(this,(()=>this._onScaleChanged()))),this._scaleRotateDragData=null,this._updateDragState()}this._updateFocusTooltip()}))}));this._handles.add([i,t.events.on("focus-changed",(t=>{"focus"===t.action?this.startAnimation(x(this,(()=>this._updateDelayedFocusedState()))):this._updateDelayedFocusedState()})),t.events.on("immediate-click",(t=>{t.stopPropagation()})),l.watch((()=>this.tool.graphicState?.displaying),(t=>this._ringManipulator.available=t),l.initial)])},u._updateTooltipPipelineStep=function(t){return e=>{const a=this._tooltipOptions;if(!a.enabled)return e;if("end"===e.action)return this._updateFocusTooltip(),e;const i=this._tooltip,o=this._tooltipOptions.visualVariables,n=s.isSome(o)?o.size:null,l=s.isSome(o)?o.rotation:null;switch(t.mode){case"scale":i.info=new F.TransformScaleTooltipInfo({tooltipOptions:a,scale:{value:this._adapter.scale},size:r.createLength(s.unwrapOr(this._adapter.size,-1),"meters"),sizeUnit:s.isSome(n)?n.unit:null,sizePrecision:s.isSome(n)?z(n.valueType):null});break;case"rotate":{const t=s.isSome(l)?z(l.valueType):null,e=s.isSome(l)?l.rotationType:"geographic";i.info=new F.TransformRotateTooltipInfo({tooltipOptions:a,rotation:r.createAngle(s.unwrapOr(-this._adapter.relativeAngle,0),"radians","geographic"),rotationPrecision:t,orientation:r.createAngle(-this._adapter.angle,"radians","geographic"),orientationPrecision:t,rotationType:e})}}return e}},u._updateFocusTooltip=function(){if(!this._tooltipOptions.enabled)return;if(this.getFocused()){const t=this._tooltipOptions.visualVariables,e=s.isSome(t)?t.rotation:null,a=s.isSome(t)?t.size:null;this._tooltip.info=new F.TransformAbsoluteTooltipInfo({tooltipOptions:this._tooltipOptions,orientation:r.createAngle(-this._adapter.angle,"radians","geographic"),orientationEnabled:null==this._mode||"rotate"===this._mode,orientationPrecision:s.isSome(e)?z(e.valueType):null,rotationType:s.isSome(e)?e.rotationType:"geographic",size:r.createLength(s.unwrapOr(this._adapter.size,-1),"meters"),sizeUnit:s.isSome(a)?a.unit:null,sizeEnabled:null==this._mode||"scale"===this._mode,sizePrecision:s.isSome(a)?z(a.valueType):null})}else this._tooltip.clear()},u._onScaleChanged=function(){this.events.emit("scale-changed"),this._updateManipulatorTransform()},u._updateDelayedFocusedState=function(){this._ringManipulator.updateStateEnabled(k.DelayedFocused,this.getFocused()),this._updateFocusTooltip()},u._updateDragState=function(){if(this._ringManipulator.updateStateEnabled(k.Unlocked,!(s.isSome(this._scaleRotateDragData)&&"none"!==this._scaleRotateDragData.mode)),s.isSome(this._scaleRotateDragData))switch(this._scaleRotateDragData.mode){case"rotate":this._ringManipulator.updateStateEnabled(k.ScaleIn|k.ScaleOut,!1),this._ringManipulator.updateStateEnabled(k.RotateLeft,this._scaleRotateDragData.angleDir<0),this._ringManipulator.updateStateEnabled(k.RotateRight,this._scaleRotateDragData.angleDir>=0);break;case"scale":this._ringManipulator.updateStateEnabled(k.RotateLeft|k.RotateRight,!1),this._ringManipulator.updateStateEnabled(k.ScaleIn,this._scaleRotateDragData.scaleDir<0),this._ringManipulator.updateStateEnabled(k.ScaleOut,this._scaleRotateDragData.scaleDir>=0)}else this._ringManipulator.updateStateEnabled(k.ScaleIn|k.ScaleOut|k.RotateLeft|k.RotateRight,!1)},u._updateManipulatorTransform=function(){const t=h.fromRotation(T.sm4d.get(),this._adapter.angle,g.fromValues(0,0,1));if(s.isNone(t))return;const e=this.getScale(),a=h.fromScaling(T.sm4d.get(),p.set(T.sv3d.get(),e,e,e));this._ringManipulator.modelTransform=h.multiply(T.sm4d.get(),a,t)},u._createRingManipulator=function(){const t=(t,e,a)=>{const i=[],o=Math.ceil(E.GEOMETRY_SEGMENTS*(e-t)/(2*Math.PI));for(let n=0;n<o+1;n++){const s=t+n*(e-t)/o;i.push(g.fromValues(a*Math.cos(s),a*Math.sin(s),0))}return i},e=e=>t(0,2*Math.PI,e),a=t=>[[-t/2,0],[t/2,0],[t/2,E.RING_HEIGHT/2],[-t/2,E.RING_HEIGHT/2]],i=(t,e)=>O.createPathExtrusionGeometry(a(e),t,[],[],!1),o=e(E.RING_RADIUS),n=i(o,E.RING_THICKNESS),s={left:[],right:[]},r=[];for(let g=0;g<2;g++){const e=g*Math.PI-Math.PI/4,a=Math.PI/2-E.ROTATE_INDICATOR_ARC_LENGTH,o=e+a,n=e+Math.PI/2-a,l=t(o,n,E.INNER_INDICATOR_RADIUS),c=i(l,E.INDICATOR_THICKNESS);r.push(l),r.push(t(o,n,E.OUTER_INDICATOR_RADIUS-E.RING_THICKNESS/2)),s.left.push(c),s.right.push(c);for(let t=0;t<2;t++){const e=0===t,a=d.create();if(e){h.scale(a,a,[1,-1,1]),h.rotate(a,a,-o,[0,0,1]);const t=Math.round(E.ROTATE_INDICATOR_ARROW_PLACEMENT_PERCENTAGE*(l.length-1));a[12]=l[t][0],a[13]=l[t][1],a[14]=l[t][2]}else{h.rotate(a,a,n,[0,0,1]);const t=Math.round((1-E.ROTATE_INDICATOR_ARROW_PLACEMENT_PERCENTAGE)*(l.length-1));a[12]=l[t][0],a[13]=l[t][1],a[14]=l[t][2]}const i=O.createExtrudedTriangle(E.ROTATE_INDICATOR_ARROW_TIP_LENGTH,0,E.ROTATE_INDICATOR_ARROW_TIP_RADIUS,E.RING_HEIGHT);O.transformInPlace(i,a),(e?s.left:s.right).push(i)}}const l=[];for(let h=0;h<2;h++){const e=h*Math.PI-Math.PI/4,a=Math.PI/2-E.SCALE_INDICATOR_ARC_LENGTH,o=e+a,n=e+Math.PI/2-a,s=t(o,n,E.OUTER_INDICATOR_RADIUS);l.push(i(s,E.INDICATOR_THICKNESS))}const c=e(E.RING_RADIUS+E.SCALE_INDICATOR_OFFSET1),u=e(E.RING_RADIUS+E.SCALE_INDICATOR_OFFSET2),p=i(c,E.INDICATOR_THICKNESS),_=i(u,E.INDICATOR_THICKNESS),m=e(E.RING_RADIUS-E.SCALE_INDICATOR_OFFSET1),S=e(E.RING_RADIUS-E.SCALE_INDICATOR_OFFSET2),T=i(m,E.INDICATOR_THICKNESS),D=i(S,E.INDICATOR_THICKNESS),f=this._createMaterial(),A=this._createMaterial(.66),M=this._createMaterial(.5),C=this._createMaterial(.33);let v=[{geometry:n,material:f,stateMask:k.DelayedFocused},{geometry:n,material:M,stateMask:y.ManipulatorStateFlags.None}];this._mode&&"scale"!==this._mode||(v=v.concat([{geometry:l,material:f,stateMask:k.DelayedFocused|k.Unlocked},{geometry:p,material:A,stateMask:k.DelayedFocused|k.ScaleIn},{geometry:_,material:C,stateMask:k.DelayedFocused|k.ScaleIn},{geometry:T,material:A,stateMask:k.DelayedFocused|k.ScaleOut},{geometry:D,material:C,stateMask:k.DelayedFocused|k.ScaleOut}])),this._mode&&"rotate"!==this._mode||(v=v.concat([{geometry:s.right,material:f,stateMask:k.DelayedFocused|k.Unlocked},{geometry:s.left,material:f,stateMask:k.DelayedFocused|k.RotateLeft},{geometry:s.right,material:f,stateMask:k.DelayedFocused|k.RotateRight}]));const N=[o,...r];return new R.Manipulator3D({view:this.tool.view,renderObjects:v,autoScaleRenderObjects:!1,worldOriented:!0,radius:E.RING_THICKNESS,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:I.getGraphicEffectiveElevationInfo(this.tool.graphicState.graphic),collisionType:{type:"ribbon",paths:N,direction:g.fromValues(0,0,1)}})},u._createMaterial=function(t=1){const e=_.fromArray([...E.HANDLE_COLOR,t]);return new v.ColorMaterial({color:e,transparent:1!==t,cullFace:M.CullFaceOptions.Back,renderOccluded:C.RenderOccludedFlag.Transparent})},e._createClass(t,[{key:"angle",get:function(){return this._adapter.angle}},{key:"scale",get:function(){return this._adapter.scale}},{key:"location",set:function(t){this._ringManipulator.location=t}},{key:"elevationAlignedLocation",set:function(t){this._ringManipulator.elevationAlignedLocation=t}},{key:"grabbing",get:function(){return this._ringManipulator.grabbing}},{key:"interactive",set:function(t){this._ringManipulator.interactive=t}},{key:"test",get:function(){return{ringManipulator:this._ringManipulator,tooltip:this._tooltip}}}]),t}();function w(t,e){const a=p.subtract(T.sv3d.get(),e.renderStart,t.origin),i=p.subtract(T.sv3d.get(),e.renderEnd,t.origin),o=p.length(a),n=p.length(i);return 0===o?0:n/o}function U(t,e,a,i){const{renderStart:o,renderEnd:n}=t,s=L(o,i,T.sv3d.get()),r=L(n,i,T.sv3d.get());if(p.squaredDistance(s,r)<E.DRAG_THRESHOLD_PX*E.DRAG_THRESHOLD_PX)return null;const l=p.subtract(T.sv3d.get(),o,a),c=p.cross(T.sv3d.get(),l,m.normal(e)),u=o,h=p.add(T.sv3d.get(),u,c),d=L(a,i,T.sv3d.get()),g=s,_=L(h,i,T.sv3d.get()),I=p.subtract(T.sv3d.get(),_,g),R=p.subtract(T.sv3d.get(),s,d),D=S.wrap(g,I),f=S.wrap(d,R);return S.distance2(D,r)<S.distance2(f,r)?"rotate":"scale"}function L(t,e,a){return e.projectToScreen(t,K),p.set(a,K[0],K[1],0)}var G;function H(t,e){let a=null,i=1;const o=()=>i;return{start:()=>{i=t.getScale(),a=t.getScale,t.getScale=o,e()},update:t=>(i+=((i+1)/2-i)*Math.min(t*E.RING_RESET_ANIMATION_SPEED_FACTOR,1),e(),Math.abs(i-1)<.01?G.STOP:G.CONTINUE),destroy:()=>{t.getScale=a,e()}}}function x(t,e){let a=0,i=null;const o=()=>!1;return{start:()=>{i=t.getFocused,t.getFocused=o,a=0,e()},update:t=>(a+=t,!i()||a>E.RING_INDICATOR_DELAY_MS?G.STOP:G.CONTINUE),destroy:()=>{t.getFocused=i,e()}}}function z(t){switch(t){case"integer":case"long":return 0;default:return null}}!function(t){t[t.CONTINUE=0]="CONTINUE",t[t.STOP=1]="STOP"}(G||(G={}));const K=u.createScreenPointArray();t.GraphicScaleRotateTransform=P,Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
