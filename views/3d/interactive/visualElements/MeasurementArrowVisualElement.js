/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../Color","../../../../core/analysisThemeUtils","../../../../core/Handles","../../../../core/mathUtils","../../../../core/maybe","../../../../core/reactiveUtils","../../../../chunks/mat4f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../chunks/vec4f64","../../../../geometry/support/vectorStacks","./Object3DVisualElement","../../webgl-engine/lib/GeometryUtil","../../webgl-engine/lib/Material","../../webgl-engine/materials/MeasurementArrowMaterial"],(function(e,t,r,i,o,a,s,n,c,l,h,d,p,u,_,y,w){"use strict";let g=function(e){function d(t){var o;return(o=e.call(this,t)||this)._parameters={arrowWidth:16,arrowOutlineColor:r.toUnitRGBA(i.getAccentColor()),arrowStripeEvenColor:r.toUnitRGBA(i.getContrastColor()),arrowStripeOddColor:r.toUnitRGBA(i.getAccentColor()),arrowSubdivisions:128},o._origin=h.create(),o._originTransform=c.create(),o._arrowCenter=h.create(),o._renderOccluded=y.RenderOccludedFlag.OccludeAndTransparent,o._geometry=null,o._stripeLength=1,o._stripesEnabled=!0,o._opacity=1,o.applyProps(t),o}t._inheritsLoose(d,e);var u=d.prototype;return u.createExternalResources=function(){const{arrowStripeEvenColor:e,arrowStripeOddColor:t,arrowOutlineColor:r}=this._parameters,i=this._stripesEnabled?e:t;this._arrowMaterial=new w.MeasurementArrowMaterial({outlineColor:r,stripeEvenColor:i,stripeOddColor:t,renderOccluded:this.renderOccluded,polygonOffset:!0}),this._handles=new o,this._handles.add(n.watch((()=>this.view.state.camera),(()=>{this._viewChanged()})))},u.destroyExternalResources=function(){this._arrowMaterial=null,this._handles=s.destroyMaybe(this._handles)},u.forEachExternalMaterial=function(e){e(this._arrowMaterial)},u.createGeometries=function(e){if(s.isNone(this._geometry)||s.isNone(this._geometry.startRenderSpace)||s.isNone(this._geometry.endRenderSpace))return;const t=this._createArrowGeometry(this._geometry.startRenderSpace,this._geometry.endRenderSpace,this._origin,this._geometry);t.transformation=this._originTransform,e.addGeometry(t),this._viewChanged()},u._createArrowGeometry=function(e,t,r,i){const o=this.view.renderCoordsHelper,a=[],s=[],n=(e,t)=>{const i=p.sv3d.get();l.subtract(i,e,r),a.push(i),s.push(t)};if("euclidean"===i.type){i.eval(.5,this._arrowCenter);const r=p.sv3d.get();o.worldUpAtPosition(this._arrowCenter,r),n(e,r),n(t,r)}else{i.eval(.5,this._arrowCenter);const e=this._parameters.arrowSubdivisions+1&-2;for(let t=0;t<e;++t){const r=t/(e-1),a=p.sv3d.get(),s=p.sv3d.get();i.eval(r,a),o.worldUpAtPosition(a,s),n(a,s)}}return _.createPolylineGeometry(this._arrowMaterial,a,s)},u._geometryChanged=function(){this.recreateGeometry()},u._viewChanged=function(){if(this.view.ready&&this.attached&&s.isSome(this._geometry)){const e=this.view.state.camera.computeScreenPixelSizeAt(this._arrowCenter);this._arrowMaterial.setParameters({width:this._parameters.arrowWidth*e})}},u._updateArrowOpacity=function(){const e=this.opacity,{arrowStripeEvenColor:t,arrowStripeOddColor:r,arrowOutlineColor:i}=this._parameters,o=a.applyOpacity(m,this._stripesEnabled?t:r,e),s=a.applyOpacity(f,i,e),n=a.applyOpacity(C,r,e);this._arrowMaterial.setParameters({stripeEvenColor:o,outlineColor:s,stripeOddColor:n})},t._createClass(d,[{key:"renderOccluded",get:function(){return this._renderOccluded},set:function(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._arrowMaterial&&this._arrowMaterial.setParameters({renderOccluded:e}))}},{key:"geometry",get:function(){return this._geometry},set:function(e){this._geometry=e,this._geometryChanged()}},{key:"stripeLength",get:function(){return this._stripeLength},set:function(e){this._stripeLength=e,this.attached&&this._arrowMaterial.setParameters({stripeLength:this._stripeLength})}},{key:"stripesEnabled",get:function(){return this._stripesEnabled},set:function(e){if(this._stripesEnabled=e,this.attached){const e=this.opacity,{arrowStripeEvenColor:t,arrowStripeOddColor:r}=this._parameters,i=a.applyOpacity(m,this._stripesEnabled?t:r,e);this._arrowMaterial.setParameters({stripeEvenColor:i})}}},{key:"opacity",get:function(){return this._opacity},set:function(e){e!==this._opacity&&(this._opacity=e,this._updateArrowOpacity())}}]),d}(u.Object3DVisualElement);const m=d.create(),f=d.create(),C=d.create();e.MeasurementArrowVisualElement=g,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
