/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import e from"../../../../core/Handles.js";import{applyOpacity as r}from"../../../../core/mathUtils.js";import{isNone as t,isSome as s}from"../../../../core/maybe.js";import{watch as i}from"../../../../core/reactiveUtils.js";import{c as o}from"../../../../chunks/mat4f64.js";import{b as a}from"../../../../chunks/vec3.js";import{c as n}from"../../../../chunks/vec3f64.js";import{c as h}from"../../../../chunks/vec4f64.js";import{sv3d as l}from"../../../../geometry/support/vectorStacks.js";import{Object3DVisualElement as d}from"./Object3DVisualElement.js";import c from"../../webgl-engine/lib/GeometryUtil.js";import{RenderOccludedFlag as p}from"../../webgl-engine/lib/Material.js";import{MeasurementArrowMaterial as m}from"../../webgl-engine/materials/MeasurementArrowMaterial.js";class _ extends d{constructor(e){super(e),this._parameters=w,this._handles=null,this._origin=n(),this._originTransform=o(),this._arrowCenter=n(),this._renderOccluded=p.OccludeAndTransparent,this._geometry=null,this._stripeLength=1,this._stripesEnabled=!0,this._opacity=1,this.applyProps(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._arrowMaterial&&this._arrowMaterial.setParameters({renderOccluded:e}))}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this._geometryChanged()}get stripeLength(){return this._stripeLength}set stripeLength(e){this._stripeLength=e,this.attached&&this._arrowMaterial.setParameters({stripeLength:this._stripeLength})}get stripesEnabled(){return this._stripesEnabled}set stripesEnabled(e){if(this._stripesEnabled=e,this.attached){const e=this.opacity,{arrowStripeEvenColor:t,arrowStripeOddColor:s}=this._parameters,i=r(g,this._stripesEnabled?t:s,e);this._arrowMaterial.setParameters({stripeEvenColor:i})}}get opacity(){return this._opacity}set opacity(e){e!==this._opacity&&(this._opacity=e,this._updateArrowOpacity())}createExternalResources(){const{arrowStripeEvenColor:r,arrowStripeOddColor:t,arrowOutlineColor:s}=this._parameters,o=this._stripesEnabled?r:t;this._arrowMaterial=new m({outlineColor:s,stripeEvenColor:o,stripeOddColor:t,renderOccluded:this.renderOccluded,polygonOffset:!0}),this._handles=new e,this._handles.add(i((()=>this.view.state.camera),(()=>{this._viewChanged()})))}destroyExternalResources(){this._arrowMaterial=null,this._handles.destroy(),this._handles=null}forEachExternalMaterial(e){e(this._arrowMaterial)}createGeometries(e){if(t(this._geometry)||t(this._geometry.startRenderSpace)||t(this._geometry.endRenderSpace))return;const r=this._createArrowGeometry(this._geometry.startRenderSpace,this._geometry.endRenderSpace,this._origin,this._geometry);e.addGeometry(r,this._arrowMaterial,this._originTransform),this._viewChanged()}_createArrowGeometry(e,r,t,s){const i=this.view.renderCoordsHelper,o=[],n=[],h=(e,r)=>{const s=l.get();a(s,e,t),o.push(s),n.push(r)};if("euclidean"===s.type){s.eval(.5,this._arrowCenter);const t=l.get();i.worldUpAtPosition(this._arrowCenter,t),h(e,t),h(r,t)}else{s.eval(.5,this._arrowCenter);const e=this._parameters.arrowSubdivisions+1&-2;for(let r=0;r<e;++r){const t=r/(e-1),o=l.get(),a=l.get();s.eval(t,o),i.worldUpAtPosition(o,a),h(o,a)}}return c.createPolylineGeometry(o,n)}_geometryChanged(){this.recreateGeometry()}_viewChanged(){if(this.view.ready&&this.attached&&s(this._geometry)){const e=this.view.state.camera.computeScreenPixelSizeAt(this._arrowCenter);this._arrowMaterial.setParameters({width:this._parameters.arrowWidth*e})}}_updateArrowOpacity(){const e=this.opacity,{arrowStripeEvenColor:t,arrowStripeOddColor:s,arrowOutlineColor:i}=this._parameters,o=r(g,this._stripesEnabled?t:s,e),a=r(u,i,e),n=r(y,s,e);this._arrowMaterial.setParameters({stripeEvenColor:o,outlineColor:a,stripeOddColor:n})}}const w={arrowWidth:16,arrowOutlineColor:[1,.5,0,1],arrowOutlineWidth:.2,arrowStripeEvenColor:[1,1,1,1],arrowStripeOddColor:[1,.5,0,1],arrowStripeLength:16,arrowSubdivisions:128},g=h(),u=h(),y=h();export{_ as MeasurementArrowVisualElement};
