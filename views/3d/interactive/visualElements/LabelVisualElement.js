/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/screenUtils","../../../../chunks/vec3f64","../../../../chunks/vec3","../../../../core/Handles","../../../../chunks/vec2","./VisualElement","../measurementTools/support/viewUtils","../../../overlay/LineOverlayItem","../../../overlay/TextOverlayItem"],(function(e,t,i,n,s,r,o,a,c,h,l,u){"use strict";let _=function(e){function n(t){var i;return(i=e.call(this,t.view)||this)._handles=new o,i._textItem=null,i._calloutItem=null,i._showCallout=!0,i._showText=!0,i._geometry=null,i._text=null,i._fontSize=14,i._distance=25,i._anchor="right",i.applyProps(t),i}t._inheritsLoose(n,e);var s=n.prototype;return s.overlaps=function(e){return this.textItem.visible&&e.textItem.visible&&this.view.overlay.overlaps(this._textItem,e.textItem)},s._updateLabelPosition=function(){if(this.attached){if(this._showText=!1,this._showCallout=!1,i.isSome(this.geometry)&&this.view._stage)switch(this.geometry.type){case"point":this._computeLabelPositionFromPoint(this.geometry,S)&&(this._textItem.position=[S[0],S[1]],this._textItem.anchor="center",this._showText=!0);break;case"corner":this._computeLabelPositionFromCorner(this.geometry,this._distance,S,P)&&(this._showCallout=this._updatePosition(S,P),this._showText=!0);break;case"segment":this._computeLabelPositionFromSegment(this.geometry,this._distance,this._anchor,S,P)&&(this._showText=!0,this._showCallout=this._updatePosition(S,P))}this.updateVisibility(this.visible)}},s._computeLabelPositionFromPoint=function(e,t){this.view.renderCoordsHelper.toRenderCoords(e,g);const i=this.view._stage.camera;return i.projectToRenderScreen(g,w),!(w[2]<0||w[2]>1)&&(i.renderToScreen(w,t),!0)},s._computeLabelPositionFromCorner=function(e,t,i,n){if(!e)return!1;const s=this.view._stage.camera;return m(e.left,1,s,b),a.negate(b,b),m(e.right,0,s,v),a.add(x,b,v),a.negate(x,x),a.normalize(x,x),s.projectToRenderScreen(e.left.endRenderSpace,w),!(w[2]<0||w[2]>1)&&(s.renderToScreen(w,i),a.scale(x,x,t*s.pixelRatio),a.add(x,x,w),s.renderToScreen(x,n),!0)},s._computeLabelPositionFromSegment=function(e,t,i,n,s){if(!e)return!1;const r=e.segment,o=this.view._stage.camera;h.screenSpaceTangent(r.startRenderSpace,r.endRenderSpace,b,o),a.set(x,-b[1],b[0]);let c=!1;switch(i){case"top":c=x[1]<0;break;case"bottom":c=x[1]>0;break;case"left":c=x[0]>0;break;case"right":c=x[0]<0}if(c&&a.negate(x,x),0===a.length(x))switch(i){case"top":x[1]=1;break;case"bottom":x[1]=-1;break;case"left":x[0]=-1;break;case"right":x[0]=1}return r.eval(L[e.sampleLocation],g),o.projectToRenderScreen(g,w),!(w[2]<0||w[2]>1)&&(o.renderToScreen(w,n),a.scale(x,x,t*o.pixelRatio),a.add(x,x,w),o.renderToScreen(x,s),!0)},s._updatePosition=function(e,t){if(t){const i=t[0]-e[0],n=t[1]-e[1];return this._textItem.position=[t[0],t[1]],this._textItem.anchor=Math.abs(i)>Math.abs(n)?i>0?"left":"right":n>0?"top":"bottom",this._calloutItem.startPosition=[e[0],e[1]],this._calloutItem.endPosition=[t[0],t[1]],!0}return this._textItem.position=[e[0],e[1]],this._textItem.anchor="center",!1},s.createResources=function(){this._textItem=new u({visible:!0}),this._textItem.text=i.unwrap(this._text),this._textItem.fontSize=this._fontSize,this._calloutItem=new l({visible:!0,width:2}),this._updateLabelPosition(),this.view.overlay.items.addMany([this._textItem,this._calloutItem]),this._handles.add(this.view.state.watch("camera",(()=>{this._updateLabelPosition()})))},s.destroyResources=function(){this.view.overlay&&!this.view.overlay.destroyed&&this.view.overlay.items.removeMany([this._textItem,this._calloutItem]),this._handles.removeAll()},s.updateVisibility=function(e){this._textItem.visible=this._showText&&e,this._calloutItem.visible=this._showCallout&&e},t._createClass(n,[{key:"geometry",get:function(){return this._geometry},set:function(e){this._geometry=e,this._updateLabelPosition()}},{key:"textItem",get:function(){return this._textItem}},{key:"text",get:function(){return this._text},set:function(e){this._text=e,this.attached&&(this._textItem.text=this._text)}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize=e,this.attached&&(this._textItem.fontSize=this._fontSize)}},{key:"distance",get:function(){return this._distance},set:function(e){this._distance!==e&&(this._distance=e,this._updateLabelPosition())}},{key:"anchor",get:function(){return this._anchor},set:function(e){this._anchor!==e&&(this._anchor=e,this._updateLabelPosition())}}]),n}(c.VisualElement);function m(e,t,i,n){e.eval(t,p,y),r.add(f,p,y),i.projectToRenderScreen(p,I),i.projectToRenderScreen(f,R),a.subtract(n,k,T),a.normalize(n,n)}function d(e){switch(e){case"top":return"bottom";case"right":return"left";case"bottom":return"top";case"left":return"right"}}const p=s.create(),f=s.create(),y=s.create(),b=n.createRenderScreenPointArray(),v=n.createRenderScreenPointArray(),x=n.createRenderScreenPointArray(),g=s.create(),w=n.createRenderScreenPointArray3(),S=n.createScreenPointArray(),P=n.createScreenPointArray(),I=n.createRenderScreenPointArray3(),T=I,R=n.createRenderScreenPointArray3(),k=R,L={start:0,center:.5,end:1};e.LabelVisualElement=_,e.mirrorPosition=d,e.screenSpaceTangent=m,Object.defineProperty(e,"__esModule",{value:!0})}));
