/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/Handles","../../../../core/maybe","../../../../core/screenUtils","../../../../chunks/vec2","../../../../chunks/vec3","../../../../chunks/vec3f64","../measurementTools/support/viewUtils","./VisualElement","../../../overlay/LineOverlayItem","../../../overlay/TextOverlayItem"],(function(e,t,i,s,n,o,r,a,c,h,l,u){"use strict";let _=function(e){function n(t){var s;return(s=e.call(this,t.view)||this)._handles=new i,s._textItem=null,s._calloutItem=null,s._showCallout=!0,s._showText=!0,s._geometry=null,s._text=null,s._fontSize=14,s._distance=25,s._anchor="right",s.applyProps(t),s}t._inheritsLoose(n,e);var r=n.prototype;return r.overlaps=function(e){return!!this.attached&&(this.textItem.visible&&e.textItem.visible&&this.view.overlay.overlaps(this._textItem,e.textItem))},r._updateLabelPosition=function(){if(this.attached){if(this._showText=!1,this._showCallout=!1,s.isSome(this.geometry)&&this.view._stage)switch(this.geometry.type){case"point":if(this._computeLabelPositionFromPoint(this.geometry.point,w)){if(this.geometry.callout){const e=this.view.state.camera,t=this.geometry.callout.distance;o.add(S,S,[0,this.geometry.callout.offset]),e.renderToScreen(S,w),o.set(x,0,1),o.scale(x,x,t*e.pixelRatio),o.add(x,x,S),e.renderToScreen(x,P),this._showCallout=this._updatePosition(w,P)}else this._textItem.position=[w[0],w[1]],this._textItem.anchor="center";this._showText=!0}break;case"corner":this._computeLabelPositionFromCorner(this.geometry,this._distance,w,P)&&(this._showCallout=this._updatePosition(w,P),this._showText=!0);break;case"segment":this._computeLabelPositionFromSegment(this.geometry,this._distance,this._anchor,w,P)&&(this._showText=!0,this._showCallout=this._updatePosition(w,P))}this.updateVisibility(this.visible)}},r._computeLabelPositionFromPoint=function(e,t){const i=this.view.state.camera;return i.projectToRenderScreen(e,S),!(S[2]<0||S[2]>1)&&(i.renderToScreen(S,t),!0)},r._computeLabelPositionFromCorner=function(e,t,i,s){if(!e)return!1;const n=this.view.state.camera;return m(e.left,1,n,b),o.negate(b,b),m(e.right,0,n,v),o.add(x,b,v),o.negate(x,x),o.normalize(x,x),n.projectToRenderScreen(e.left.endRenderSpace,S),!(S[2]<0||S[2]>1)&&(n.renderToScreen(S,i),o.scale(x,x,t*n.pixelRatio),o.add(x,x,S),n.renderToScreen(x,s),!0)},r._computeLabelPositionFromSegment=function(e,t,i,s,n){if(!e)return!1;const r=e.segment,a=this.view.state.camera;c.screenSpaceTangent(r.startRenderSpace,r.endRenderSpace,b,a),o.set(x,-b[1],b[0]);let h=!1;switch(i){case"top":h=x[1]<0;break;case"bottom":h=x[1]>0;break;case"left":h=x[0]>0;break;case"right":h=x[0]<0}if(h&&o.negate(x,x),0===o.length(x))switch(i){case"top":x[1]=1;break;case"bottom":x[1]=-1;break;case"left":x[0]=-1;break;case"right":x[0]=1}return r.eval(L[e.sampleLocation],g),a.projectToRenderScreen(g,S),!(S[2]<0||S[2]>1)&&(a.renderToScreen(S,s),o.scale(x,x,t*a.pixelRatio),o.add(x,x,S),a.renderToScreen(x,n),!0)},r._updatePosition=function(e,t){if(t){const i=t[0]-e[0],s=t[1]-e[1];return this._textItem.position=[t[0],t[1]],this._textItem.anchor=Math.abs(i)>Math.abs(s)?i>0?"left":"right":s>0?"top":"bottom",this._calloutItem.startPosition=[e[0],e[1]],this._calloutItem.endPosition=[t[0],t[1]],!0}return this._textItem.position=[e[0],e[1]],this._textItem.anchor="center",!1},r.createResources=function(){this._textItem=new u({visible:!0}),this._textItem.text=s.unwrap(this._text),this._textItem.fontSize=this._fontSize,this._calloutItem=new l({visible:!0,width:2}),this._updateLabelPosition(),this.view.overlay.items.addMany([this._textItem,this._calloutItem]),this._handles.add(this.view.state.watch("camera",(()=>this._updateLabelPosition())))},r.destroyResources=function(){this.view.overlay&&!this.view.overlay.destroyed&&this.view.overlay.items.removeMany([this._textItem,this._calloutItem]),this._handles.removeAll()},r.updateVisibility=function(e){this._textItem.visible=this._showText&&e,this._calloutItem.visible=this._showCallout&&e},t._createClass(n,[{key:"geometry",get:function(){return this._geometry},set:function(e){this._geometry=e,this._updateLabelPosition()}},{key:"textItem",get:function(){return this._textItem}},{key:"text",get:function(){return this._text},set:function(e){this._text=e,this.attached&&(this._textItem.text=this._text)}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize=e,this.attached&&(this._textItem.fontSize=this._fontSize)}},{key:"distance",get:function(){return this._distance},set:function(e){this._distance!==e&&(this._distance=e,this._updateLabelPosition())}},{key:"anchor",get:function(){return this._anchor},set:function(e){this._anchor!==e&&(this._anchor=e,this._updateLabelPosition())}}]),n}(h.VisualElement);function m(e,t,i,s){e.eval(t,p,y),r.add(f,p,y),i.projectToRenderScreen(p,I),i.projectToRenderScreen(f,R),o.subtract(s,k,T),o.normalize(s,s)}function d(e){switch(e){case"top":return"bottom";case"right":return"left";case"bottom":return"top";case"left":return"right"}}const p=a.create(),f=a.create(),y=a.create(),b=n.createRenderScreenPointArray(),v=n.createRenderScreenPointArray(),x=n.createRenderScreenPointArray(),g=a.create(),S=n.createRenderScreenPointArray3(),w=n.createScreenPointArray(),P=n.createScreenPointArray(),I=n.createRenderScreenPointArray3(),T=I,R=n.createRenderScreenPointArray3(),k=R,L={start:0,center:.5,end:1};e.LabelVisualElement=_,e.mirrorPosition=d,e.screenSpaceTangent=m,Object.defineProperty(e,"__esModule",{value:!0})}));
