/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/screenUtils","../../../../chunks/vec3f64","../../../../core/Handles","../../../../chunks/vec2","./VisualElement","../../../overlay/LineOverlayItem","../../../overlay/TextOverlayItem","../measurementTools/support/viewUtils"],(function(t,e,i,s,o,n,r,a,h,c,l){"use strict";let _=function(t){function s(e){var i;return(i=t.call(this,e.view)||this)._handles=new n,i._textItem=null,i._calloutItem=null,i._showCallout=!0,i._showText=!0,i._geometry=null,i._text=null,i._fontSize=14,i._distance=25,i._anchor="right",i.applyProps(e),i}e._inheritsLoose(s,t);var o=s.prototype;return o._updateLabelPosition=function(){if(this.attached&&i.isSome(this.geometry)&&this.view._stage)switch(this.geometry.type){case"point":this._computeLabelPositionFromPoint(this.geometry,p)?(this._textItem.position=[p[0],p[1]],this._textItem.anchor="center",this._showText=!0):this._showText=!1,this._showCallout=!1;break;case"euclidean":case"geodesic":if(this._computeLabelPositionFromSegment(this.geometry,this._distance,this._anchor,p,y)){const t=y[0]-p[0],e=y[1]-p[1];this._textItem.position=[y[0],y[1]],this._textItem.anchor=Math.abs(t)>Math.abs(e)?t>0?"left":"right":e>0?"top":"bottom",this._textItem.visible=this.visible,this._calloutItem.startPosition=[p[0],p[1]],this._calloutItem.endPosition=[y[0],y[1]],this._showText=!0,this._showCallout=!0}else this._showText=!1,this._showCallout=!1}this.updateVisibility(this.visible)},o._computeLabelPositionFromPoint=function(t,e){this.view.renderCoordsHelper.toRenderCoords(t,d);const i=this.view._stage.getCamera();return i.projectToRenderScreen(d,f),!(f[2]<0||f[2]>1)&&(i.renderToScreen(f,e),!0)},o._computeLabelPositionFromSegment=function(t,e,i,s,o){if(!t)return!1;const n=this.view._stage.getCamera();l.screenSpaceTangent(t.startRenderSpace,t.endRenderSpace,u,n),r.set(m,-u[1],u[0]);let a=!1;switch(i){case"top":a=m[1]<0;break;case"bottom":a=m[1]>0;break;case"left":a=m[0]>0;break;case"right":a=m[0]<0}if(a&&r.negate(m,m),0===r.length(m))switch(i){case"top":m[1]=1;break;case"bottom":m[1]=-1;break;case"left":m[0]=-1;break;case"right":m[0]=1}return t.eval(.5,d),n.projectToRenderScreen(d,f),!(f[2]<0||f[2]>1)&&(n.renderToScreen(f,s),r.scale(m,m,e*n.pixelRatio),r.add(m,m,f),n.renderToScreen(m,o),!0)},o.createResources=function(){this._textItem=new c({visible:!0}),this._textItem.text=i.unwrap(this._text),this._textItem.fontSize=this._fontSize,this._calloutItem=new h({visible:!0,width:2}),this._updateLabelPosition(),this.view.overlay.items.addMany([this._textItem,this._calloutItem]),this._handles.add(this.view.state.watch("camera",(()=>{this._updateLabelPosition()})))},o.destroyResources=function(){this.view.overlay&&!this.view.overlay.destroyed&&this.view.overlay.items.removeMany([this._textItem,this._calloutItem]),this._handles.removeAll()},o.updateVisibility=function(t){this._textItem.visible=this._showText&&t,this._calloutItem.visible=this._showCallout&&t},e._createClass(s,[{key:"geometry",get:function(){return this._geometry},set:function(t){this._geometry=t,this._updateLabelPosition()}},{key:"textItem",get:function(){return this._textItem}},{key:"text",get:function(){return this._text},set:function(t){this._text=t,this.attached&&(this._textItem.text=this._text)}},{key:"fontSize",get:function(){return this._fontSize},set:function(t){this._fontSize=t,this.attached&&(this._textItem.fontSize=this._fontSize)}},{key:"distance",get:function(){return this._distance},set:function(t){this._distance!==t&&(this._distance=t,this._updateLabelPosition())}},{key:"anchor",get:function(){return this._anchor},set:function(t){this._anchor!==t&&(this._anchor=t,this._updateLabelPosition())}}]),s}(a.VisualElement);const u=s.createRenderScreenPointArray(),m=s.createRenderScreenPointArray(),d=o.create(),f=s.createRenderScreenPointArray3(),p=s.createScreenPointArray(),y=s.createScreenPointArray();t.LabelVisualElement=_,Object.defineProperty(t,"__esModule",{value:!0})}));
