/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/screenUtils","../../../../chunks/vec2","../../../../chunks/vec2f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../chunks/vec4","../../../../chunks/vec4f32","../../../../layers/graphics/dehydratedFeatures","./EngineVisualElement","../../terrain/OverlayRenderer","../../webgl-engine/lib/GeometryUtil","../../webgl-engine/lib/Material","../../webgl-engine/lib/RenderGeometry","../../webgl-engine/lib/VertexAttribute","../../webgl-engine/materials/RibbonLineMaterial"],(function(e,t,r,i,n,a,o,s,c,u,d,l,h,_,m,p,f,y,b){"use strict";let g=function(e){function o(t){var r;return(r=e.call(this,t)||this)._location=c.create(),r._direction=c.fromValues(1,0,0),r._width=1,r._offset=1,r._length=18,r._color=d.fromValues(1,0,1,1),r._renderOccluded=p.RenderOccludedFlag.OccludeAndTransparent,r.applyProps(t),r}t._inheritsLoose(o,e);var l=o.prototype;return l.createObject3DResourceFactory=function(e){return{view:e,createResources:e=>this._createObject3DResources(e),destroyResources:e=>this._destroyObject3DResources(e),recreateGeometry:(e,t)=>this._recreateObject3DGeometry(e,t),cameraChanged:()=>this._updateGeometry()}},l.createDrapedResourceFactory=function(e){return{view:e,createResources:()=>this._createDrapedResources(),destroyResources:e=>this._destroyDrapedResources(e),recreateGeometry:e=>this._recreateDrapedGeometry(e)}},l.setDirectionFromPoints=function(e,t){s.normalize(this._direction,s.subtract(this._direction,t,e)),this._updateGeometry()},l._createObject3DResources=function(e){const t=new b.RibbonLineMaterial(this.materialParameters),r=new Array;return this._createObject3DGeometry(t,e,r),{material:t,geometries:r,forEach:e=>{e(t),r.forEach(e)}}},l._destroyObject3DResources=function(e){e.geometries.length=0,e.material.dispose()},l._recreateObject3DGeometry=function(e,t){e.geometries.length=0,this._createObject3DGeometry(e.material,t,e.geometries)},l._createObject3DGeometry=function(e,t,r){const[i,n]=this._createGeometries(e);t.addGeometry(i),t.addGeometry(n),r.push(i),r.push(n),this._updateVerticesObject3D(t)},l._createDrapedResources=function(){const e=new b.RibbonLineMaterial(this.materialParameters),t=i.watch((()=>this.view.state.contentPixelRatio),(()=>{this.drapedResources.recreateGeometry()}));return{material:e,geometries:this._createDrapedGeometry(e),pixelRatioHandle:t}},l._destroyDrapedResources=function(e){e.pixelRatioHandle.remove(),e.geometries=[],e.material.dispose()},l._recreateDrapedGeometry=function(e){e.geometries=this._createDrapedGeometry(e.material)},l._createDrapedGeometry=function(e){const t=this._createGeometries(e);this._updateVerticesDraped(t);const r=t.map((e=>new f.RenderGeometry(e,{boundingInfo:e.boundingInfo})));for(const i of r)i.computeBoundingSphere(i.transformation,i.boundingSphere);return r},l._createGeometries=function(e){return[m.createPolylineGeometry(e,[c.create(),c.create()]),m.createPolylineGeometry(e,[c.create(),c.create()])]},l._updateMaterial=function(){const{materialParameters:e}=this;r.toNullable(this.object3dResources.resources)?.material.setParameters(e),r.toNullable(this.drapedResources.resources)?.material.setParameters(e)},l._updateGeometry=function(){if(this.isDraped)this.drapedResources.recreateGeometry();else{const e=r.toNullable(this.object3dResources.object);e&&this._updateVerticesObject3D(e)}},l._updateVerticesObject3D=function(e){const t=this.view.state.camera;t.projectToScreen(this.location,w),s.add(D,this.location,this.direction),t.projectToScreen(D,P),a.normalize(P,a.subtract(P,P,w)),this._updateVertexAttributesObject3D(t,e,0,w,P,1),this._updateVertexAttributesObject3D(t,e,1,w,P,-1)},l._updateVertexAttributesObject3D=function(e,t,r,i,a,o){const s=t.geometries[r],c=s.getMutableAttribute(y.VertexAttribute.POSITION)?.data;if(!c)return;const{start:u,end:d}=this._computeStartEnd(a,i,o,this.offset,this.width,this.length);e.unprojectFromScreen(n.castScreenPointArray(u),D),c[0]=D[0],c[1]=D[1],c[2]=D[2],e.unprojectFromScreen(n.castScreenPointArray(d),D),c[3]=D[0],c[4]=D[1],c[5]=D[2],t.geometryVertexAttrsUpdated(s)},l._updateVerticesDraped=function(e){const{view:{basemapTerrain:{overlayManager:t},state:{contentPixelRatio:i}}}=this,{location:n,width:a,length:o,offset:s}=this,c=j;c.spatialReference=r.unwrap(t.renderer.spatialReference),c.x=n[0],c.y=n[1];const u=t.overlayPixelSizeInMapUnits(c)*i,d=a*u,l=o*u,h=s*u;this._updateVertexAttributesDraped(e[0],d,l,h,-1),this._updateVertexAttributesDraped(e[1],d,l,h,1)},l._updateVertexAttributesDraped=function(e,t,r,i,n){const a=e.getMutableAttribute(y.VertexAttribute.POSITION)?.data;if(!a)return;const{location:o,direction:s}=this,{start:c,end:u}=this._computeStartEnd(s,o,n,i,t,r);a[0]=c[0],a[1]=c[1],a[2]=_.DRAPED_Z,a[3]=u[0],a[4]=u[1],a[5]=_.DRAPED_Z,e.invalidateBoundingInfo()},l._computeStartEnd=function(e,t,r,i,n,o){const s=a.scale(R,a.set(R,e[1]*r,e[0]*-r),i+n/2),c=a.add(G,a.add(G,a.add(G,t,a.scale(G,e,o/2)),s),s);return{start:c,end:a.add(O,c,a.scale(O,e,-o))}},t._createClass(o,[{key:"location",get:function(){return this._location},set:function(e){s.exactEquals(this._location,e)||(s.copy(this._location,e),this._updateGeometry())}},{key:"direction",get:function(){return this._direction},set:function(e){s.exactEquals(this._direction,e)||(s.copy(this._direction,e),this._updateGeometry())}},{key:"width",get:function(){return this._width},set:function(e){e!==this._width&&(this._width=e,this._updateMaterial())}},{key:"offset",get:function(){return this._offset},set:function(e){e!==this._offset&&(this._offset=e,this._updateGeometry())}},{key:"length",get:function(){return this._length},set:function(e){e!==this._length&&(this._length=e,this._updateGeometry())}},{key:"color",get:function(){return this._color},set:function(e){u.exactEquals(e,this._color)||(u.copy(this._color,e),this._updateMaterial())}},{key:"renderOccluded",get:function(){return this._renderOccluded},set:function(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}},{key:"materialParameters",get:function(){return{width:this._width,color:this._color,renderOccluded:this._renderOccluded}}}]),o}(h.EngineVisualElement);const D=c.create(),R=o.create(),G=o.create(),O=o.create(),w=n.createScreenPointArray(),P=n.createScreenPointArray(),j=l.makeDehydratedPoint(0,0,void 0,null);e.ParallelLineVisualElement=g,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
