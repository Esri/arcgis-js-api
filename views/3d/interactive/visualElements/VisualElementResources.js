/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{isSome as e,isNone as s}from"../../../../core/maybe.js";import{watch as r,initial as t}from"../../../../core/reactiveUtils.js";import{UpdatePolicy as o}from"../../webgl-engine/lib/basicInterfaces.js";import{ContentObjectType as i}from"../../webgl-engine/lib/ContentObjectType.js";import{Object3D as c}from"../../webgl-engine/lib/Object3D.js";import{Texture as a}from"../../webgl-engine/lib/Texture.js";import{WebGLLayer as h}from"../../webgl-engine/lib/WebGLLayer.js";class u{constructor(e){this.resourceFactory=e,this._resources=null,this._visible=!0,this._attached=!1}destroy(){this._destroyResources()}get object(){return e(this._resources)?this._resources.object:null}get resources(){return e(this._resources)?this._resources.external:null}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this._syncVisible())}get attached(){return this._attached}set attached(e){e!==this._attached&&(this._attached=e,this._createOrDestroyResources())}recreate(){this.attached&&this._createResources()}recreateGeometry(){if(!this.resourceFactory.recreateGeometry)return void this.recreate();const e=this.resourceFactory.view._stage;if(s(this._resources)||!e)return;const r=this._resources.object;this._resources.external.forEach((s=>{s.type===i.Geometry&&e.remove(s)})),r.removeAllGeometries();const t=this.resourceFactory.recreateGeometry(this._resources.external,r,this._resources.layer);e.addMany(t)}_createOrDestroyResources(){this._attached?this._resources||this._createResources():this._destroyResources()}_createResources(){this._destroyResources();const e=this.resourceFactory,s=e.view,i=s._stage;if(!i)return;const u=new h({isPickable:!1,updatePolicy:o.SYNC});i.add(u);const n=new c({castShadow:!1}),l=e.createResources(n,u);l.forEach((e=>{i.add(e),e instanceof a&&i.loadImmediate(e)})),i.add(n),u.add(n);const _=e.cameraChanged?r((()=>s.state.camera),(s=>e.cameraChanged(s)),t):null;this._resources={layer:u,object:n,external:l,cameraHandle:_},this._syncVisible()}_destroyResources(){if(s(this._resources))return;const e=this.resourceFactory.view._stage;e?.remove(this._resources.object),e?.remove(this._resources.layer),this._resources.external.forEach((s=>{e?.remove(s),"dispose"in s&&s.dispose()})),this._resources.object.dispose(),this._resources.cameraHandle&&this._resources.cameraHandle.remove(),this._resources=null}_syncVisible(){s(this._resources)||this._resources.object.setVisible(this._visible)}}export{u as VisualElementResources};
