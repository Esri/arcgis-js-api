/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/Evented","../../../../chunks/vec3f64","../../../../chunks/vec3","../../../../geometry/projection","../../../../chunks/vec4","../../../../geometry/support/aaBoundingBox","../../../../layers/graphics/dehydratedFeatures","../../webgl-engine/lib/geometryDataUtils","../../layers/graphics/ElevationContext","../../webgl-engine/lib/Geometry","../../webgl-engine/shaders/RibbonLineTechnique","../../webgl-engine/materials/RibbonLineMaterial","../../webgl-engine/lib/RenderGeometry","../../layers/graphics/lineUtils","../../../../chunks/vec4f32","./LaserlineVisualElement","./VisualElementResources","./DrapedVisualElementResources"],(function(e,t,i,r,s,n,a,o,l,c,h,u,d,f,p,m,g,_,y,R,v){"use strict";let b=function(){function e(e){this.view=null,this._attachmentOrigin=c.makeDehydratedPoint(0,0,0,null),this._attachmentOriginDirty=!0,this.events=new r,this._isDraped=!1,this._geometry=null,this._width=1,this._color=_.fromValues(1,0,1,1),this._innerWidth=0,this._innerColor=_.fromValues(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._falloff=0,this._elevationInfo=null,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=8,this.resources=new R.VisualElementResources({view:e.view,createResources:e=>this.createResources(e),recreateGeometry:(e,t)=>(e.geometries.length=0,this.recreateGeometry(t,e.material,e.geometries),e.geometries)}),this._attachmentOrigin.spatialReference=e.view.spatialReference,this.drapedResources=new v.DrapedVisualElementResources({view:e.view,createResources:()=>this.createDrapedResources(),recreateGeometry:e=>{e.geometries=this.createRenderGeometriesDraped(e.material),this.attachmentOriginChanged()}});let t=!0;this._laserline=new y.LaserlineVisualElement({view:e.view});for(const i in e)i in this?"attached"===i?t=e[i]:this[i]=e[i]:console.error("Cannot set unknown property",i);this.attached=t}var s=e.prototype;return s.destroy=function(){this.resources.destroy(),this.drapedResources.destroy(),this._laserline.destroy()},s.updateAttached=function(e){this.resources.attached=!this.isDraped&&e,this.drapedResources.attached=this.isDraped&&e,this._laserline.attached=this.laserlineAttached,this.attached&&this.attachmentOriginChanged()},s.updateMaterial=function(){i.isSome(this.resources.resources)&&this.resources.resources.material.setParameterValues(this.materialParameters),i.isSome(this.drapedResources.resources)&&this.drapedResources.resources.material.setParameterValues(this.materialParameters)},s.recreateGeometry=function(e,t,i){const r=this.createRenderGeometries();for(const s of r)e.addGeometry(s,t),i.push(s);this.attachmentOriginChanged()},s.attachmentOriginChanged=function(){this._attachmentOriginDirty=!0,this.events.emit("attachment-origin-changed")},s.createResources=function(e){const t=new p.RibbonLineMaterial(this.materialParameters,"lineVisualElement"),i=[];return this.recreateGeometry(e,t,i),{material:t,geometries:i,forEach:e=>{e(t),i.forEach(e)}}},s.createDrapedResources=function(){const e=new p.RibbonLineMaterial(this.materialParameters,"lineVisualElement");return{material:e,geometries:this.createRenderGeometriesDraped(e)}},s.createRenderGeometriesDraped=function(e){const t=this.geometry;if(i.isNone(t))return[];const r=g.geometryToRenderInfoDraped(t,this.view.basemapTerrain.spatialReference),s=[];for(const{position:t}of r.lines){const i={attributeData:{position:t},removeDuplicateStartEnd:this.isClosed?1:0},r=new m(g.createGeometryData(i));r.material=e;const a=l.empty(O);l.expandWithBuffer(a,t),n.set(r.center,.5*(a[0]+a[3]),.5*(a[1]+a[4]),0),r.bsRadius=.5*Math.sqrt((a[3]-a[0])*(a[3]-a[0])+(a[4]-a[1])*(a[4]-a[1])),s.push(r)}return s},s.calculateMapBounds=function(e){if(i.isNone(this.resources.resources))return!1;const t=this.view.renderCoordsHelper;for(const i of this.resources.resources.geometries){const r=i.data.getAttribute("position"),s=r.data,n=new Float64Array(s.length);a.projectBuffer(r.data,t.spatialReference,0,n,this.view.spatialReference,0,s.length/3),l.expandWithBuffer(e,n)}return!0},s.createRenderGeometries=function(){const e=this.geometry;if(i.isNone(e))return[];const t=g.geometryToRenderInfo(e,this.view.elevationProvider,this.view.renderCoordsHelper,u.ElevationContext.fromElevationInfo(this.elevationInfo)),r=[],s=[];for(const{position:e,mapPosition:i}of t.lines){const t={attributeData:{position:e,mapPosition:i},removeDuplicateStartEnd:this.isClosed?1:0},n=g.createGeometryData(t);r.push(new d(n,"geometryOutlineVisualElement")),s.push(e)}return this._laserline.pathVerticalPlane=s,r},t._createClass(e,[{key:"isDraped",get:function(){return this._isDraped},set:function(e){e!==this._isDraped&&(this._isDraped=e,this.updateAttached(this.attached),this._laserline.attached=this.laserlineAttached)}},{key:"laserlineAttached",get:function(){return this.attached&&this.visible&&i.isSome(this._laserlineStyle)&&!this.isDraped&&this.laserlineEnabled}},{key:"visible",get:function(){return this.resources.visible},set:function(e){this.resources.visible=e,this.drapedResources.visible=e,this._laserline.attached=this.laserlineAttached}},{key:"attached",get:function(){return this.resources.attached||this.drapedResources.attached},set:function(e){this.updateAttached(e)}},{key:"geometry",get:function(){return this._geometry},set:function(e){this._geometry=e,this.resources.recreateGeometry(),this.drapedResources.recreateGeometry()}},{key:"width",get:function(){return this._width},set:function(e){e!==this._width&&(this._width=e,this.updateMaterial())}},{key:"color",get:function(){return this._color},set:function(e){o.exactEquals(e,this._color)||(o.copy(this._color,e),this.updateMaterial())}},{key:"innerWidth",get:function(){return this._innerWidth},set:function(e){e!==this._innerWidth&&(this._innerWidth=e,this.updateMaterial())}},{key:"innerColor",get:function(){return this._innerColor},set:function(e){o.exactEquals(e,this._innerColor)||(o.copy(this._innerColor,e),this.updateMaterial())}},{key:"stipplePattern",get:function(){return this._stipplePattern},set:function(e){const t=i.isSome(e)!==i.isSome(this._stipplePattern);this._stipplePattern=e,t?this.resources.recreate():this.updateMaterial()}},{key:"stippleOffColor",get:function(){return this._stippleOffColor},set:function(e){e&&this._stippleOffColor&&o.exactEquals(e,this._stippleOffColor)||(this._stippleOffColor=e?_.clone(e):null,this.updateMaterial())}},{key:"falloff",get:function(){return this._falloff},set:function(e){e!==this._falloff&&(this._falloff=e,this.updateMaterial())}},{key:"elevationInfo",get:function(){return this._elevationInfo},set:function(e){this._elevationInfo=e,this.resources.recreateGeometry()}},{key:"laserlineStyle",get:function(){return this._laserlineStyle},set:function(e){this._laserlineStyle=e,this._laserline.attached=this.laserlineAttached,i.isSome(e)&&(this._laserline.style=e)}},{key:"laserlineEnabled",get:function(){return this._laserlineEnabled},set:function(e){this._laserlineEnabled!==e&&(this._laserlineEnabled=e,this._laserline.attached=this.laserlineAttached)}},{key:"renderOccluded",get:function(){return this._renderOccluded},set:function(e){e!==this._renderOccluded&&(this._renderOccluded=e,this.updateMaterial())}},{key:"attachmentOrigin",get:function(){if(!this._attachmentOriginDirty)return this._attachmentOrigin;const e=i.isSome(this.resources.resources)?this.resources.resources.geometries:null;if(!e||0===e.length)return null;n.set(C,0,0,0);const t=f.RibbonVertexAttributeConstants.POSITION;let r=0;for(const s of e){const e=s.getAttribute(t),a=s.getIndices(t),o=i.unwrap(this.resources.resources).material.isClosed(e.data,a);h.computeAttachmentOriginLines(e,a,o,w)&&(n.add(C,C,w),r++)}return 0===r?null:(n.scale(C,C,1/r),this.view.renderCoordsHelper.fromRenderCoords(C,this._attachmentOrigin),this._attachmentOriginDirty=!1,this._attachmentOrigin)}},{key:"isClosed",get:function(){return i.isSome(this.geometry)&&"polygon"===this.geometry.type}},{key:"materialParameters",get:function(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,isClosed:this.isClosed,falloff:this._falloff,innerColor:this._innerColor,innerWidth:this._innerWidth,join:"round",stippleIntegerRepeats:!0,polygonOffset:!0,renderOccluded:this.normalizedRenderOccluded}}},{key:"normalizedRenderOccluded",get:function(){return this.isDraped&&8===this._renderOccluded?4:this._renderOccluded}}]),e}();const O=l.create(),w=s.create(),C=s.create();e.OutlineVisualElement=b,Object.defineProperty(e,"__esModule",{value:!0})}));
