// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","../../../../core/mathUtils","../../../../core/maybe","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../core/libs/gl-matrix-2/vec4","../../../../core/libs/gl-matrix-2/vec4f64","../../../../geometry/support/aaBoundingBox","./VisualElementResources","../../layers/graphics/elevationAlignmentUtils","../../layers/graphics/ElevationContext","../../layers/graphics/sdfPrimitives","../../support/projectionUtils","../../support/stack","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryUtil","../../webgl-engine/lib/Texture","../../webgl-engine/lib/Util","../../webgl-engine/materials/HUDMaterial"],(function(e,t,r,i,o,n,s,a,u,c,l,p,h,f,m,d,y,g,v,b){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PointVisualElement=void 0;var _=function(){function e(e){var t=this;this.view=null,this._geometry=null,this._size=3,this._color=a.vec4f64.fromValues(1,0,1,1),this._primitive="square",this._outlineSize=1,this._outlineColor=a.vec4f64.fromValues(1,1,1,1),this._elevationInfo=null,this.resources=new c.VisualElementResources({view:e.view,createResources:function(e){return t.createResources(e)},recreateGeometry:function(e,r){return e.geometry=t.recreateGeometry(r,e.material),i.isSome(e.geometry)?[e.geometry]:[]}});var r=!0;for(var o in e)o in this?"attached"===o?r=e[o]:this[o]=e[o]:console.error("Cannot set unknown property",o);this.attached=r}return e.prototype.destroy=function(){this.resources.destroy()},Object.defineProperty(e.prototype,"hidden",{get:function(){return this.resources.hidden},set:function(e){this.resources.hidden=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"attached",{get:function(){return this.resources.attached},set:function(e){this.resources.attached=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"geometry",{get:function(){return this._geometry},set:function(e){this._geometry=e,this.resources.recreateGeometry()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"size",{get:function(){return this._size},set:function(e){if(e!==this._size){var t=this.preferredTextureSize;this._size=e,t<this.preferredTextureSize?i.isSome(this.resources)&&this.resources.recreate():this.updateSizeAttribute()}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"color",{get:function(){return this._color},set:function(e){s.vec4.exactEquals(e,this._color)||(s.vec4.copy(this._color,e),this.updateMaterial())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"primitive",{get:function(){return this._primitive},set:function(e){this._primitive!==e&&(this._primitive=e,i.isSome(this.resources)&&this.resources.recreate())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"outlineSize",{get:function(){return this._outlineSize},set:function(e){e!==this._outlineSize&&(this._outlineSize=e,this.updateMaterial())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"outlineColor",{get:function(){return this._outlineColor},set:function(e){s.vec4.exactEquals(e,this._outlineColor)||(s.vec4.copy(this._outlineColor,e),this.updateMaterial())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"elevationInfo",{get:function(){return this._elevationInfo},set:function(e){this._elevationInfo=e,this.resources&&this.resources.recreateGeometry()},enumerable:!1,configurable:!0}),e.prototype.updateMaterial=function(){var e=this.resources.resources;i.isNone(e)||e.material.setParameterValues(this.materialParameters(e.texture.id))},e.prototype.updateSizeAttribute=function(){var e=this.resources.resources,t=this.resources.object;if(!i.isNone(e)&&!i.isNone(t)){var r=e.geometry;if(!i.isNone(r)){var o=r.data.getVertexAttr()[v.VertexAttrConstants.SIZE].data,n=this.geometrySize;o[0]=n,o[1]=n,t.geometryVertexAttrsUpdated(0)}}},e.prototype.materialParameters=function(e){return{color:this._color,textureIsSignedDistanceField:!0,distanceFieldBoundingBox:S,occlusionTest:!1,outlineColor:this._outlineColor,outlineSize:this._outlineSize,textureId:e,polygonOffset:!1,shaderPolygonOffset:0,drawInSecondSlot:!0,depthEnabled:!1}},Object.defineProperty(e.prototype,"geometrySize",{get:function(){return this._size/x},enumerable:!1,configurable:!0}),e.prototype.recreateGeometry=function(e,t){var r=this.createRenderGeometry();return i.isSome(r)&&e.addGeometry(r,t),r},e.prototype.createResources=function(e){var t=this.createTexture(),r=new b.default(this.materialParameters(t.id),"pointVisualElement");r.renderOccluded=8;var o=this.recreateGeometry(e,r);return{material:r,texture:t,geometry:o,forEach:function(e){e(t),e(r),i.isSome(this.geometry)&&e(this.geometry)}}},Object.defineProperty(e.prototype,"preferredTextureSize",{get:function(){return r.clamp(r.nextHighestPowerOfTwo(2*this.geometrySize),16,128)},enumerable:!1,configurable:!0}),e.prototype.createTexture=function(){var e=this.preferredTextureSize;return new g(h.createType(this._primitive,e,e*x),"pointVisualElement",{mipmap:!1,wrap:{s:33071,t:33071},width:e,height:e,components:4,noUnpackFlip:!0})},e.prototype.calculateMapBounds=function(e){if(i.isNone(this.resources.resources)||i.isNone(this.resources.resources.geometry))return!1;var t=this.resources.resources.geometry.data.getAttribute("position");return f.vectorToVector(t.data,this.view.renderCoordsHelper.spatialReference,P,this.view.spatialReference),u.expandWithBuffer(e,P),!0},e.prototype.createRenderGeometry=function(){var e=this.geometry;if(i.isNone(e))return null;var t=this.view.renderCoordsHelper,r=l.evaluateElevationAlignmentAtPoint(e,this.view.elevationProvider,p.ElevationContext.fromElevationInfo(this.elevationInfo),t),n=o.vec3.set(m.sv3d.get(),e.x,e.y,r),s=m.sv3d.get();f.vectorToVector(n,e.spatialReference,s,t.spatialReference);var a=this.geometrySize,u=y.createPointGeometry(null,s,null,[a,a],[0,0,0,1]);return new d(u)},e}();t.PointVisualElement=_;var x=.5,S=[x/2,x/2,1-x/2,1-x/2],P=n.vec3f64.create()}));