/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/mathUtils","../../../../chunks/vec3f64","../../../../chunks/vec3","../../../../geometry/projection","../../../../chunks/vec4f64","../../../../chunks/vec4","../../../../geometry/support/aaBoundingBox","../../support/stack","../../webgl-engine/lib/Util","../../webgl-engine/lib/GeometryUtil","../../webgl-engine/materials/HUDMaterial","../../layers/graphics/elevationAlignmentUtils","../../layers/graphics/ElevationContext","../../webgl-engine/lib/Geometry","../../layers/graphics/sdfPrimitives","../../webgl-engine/lib/Texture","./VisualElementResources"],(function(e,t,i,r,s,o,n,a,u,c,l,h,p,m,f,g,d,y,_,v){"use strict";let S=function(){function e(e){this.view=null,this._geometry=null,this._size=3,this._color=a.fromValues(1,0,1,1),this._pixelSnappingEnabled=!0,this._primitive="square",this._outlineSize=1,this._outlineColor=a.fromValues(1,1,1,1),this._elevationInfo=null,this.resources=new v.VisualElementResources({view:e.view,createResources:e=>this.createResources(e),recreateGeometry:(e,t)=>(e.geometry=this.recreateGeometry(t,e.material),i.isSome(e.geometry)?[e.geometry]:[])});let t=!0;for(const i in e)i in this?"attached"===i?t=e[i]:this[i]=e[i]:console.error("Cannot set unknown property",i);this.attached=t}var s=e.prototype;return s.destroy=function(){this.resources.destroy()},s.updateMaterial=function(){const e=this.resources.resources;i.isNone(e)||e.material.setParameterValues(this.materialParameters(e.texture.id))},s.updateSizeAttribute=function(){const e=this.resources.resources,t=this.resources.object;if(i.isNone(e)||i.isNone(t))return;const r=e.geometry;if(i.isNone(r))return;const s=r.data.getVertexAttr()[h.VertexAttrConstants.SIZE].data,o=this.geometrySize;s[0]=o,s[1]=o,t.geometryVertexAttrsUpdated(0)},s.materialParameters=function(e){return{color:this._color,textureIsSignedDistanceField:!0,distanceFieldBoundingBox:b,occlusionTest:!1,outlineColor:this._outlineColor,outlineSize:this._outlineSize,textureId:e,polygonOffset:!1,shaderPolygonOffset:0,drawInSecondSlot:!0,depthEnabled:!1,pixelSnappingEnabled:this.pixelSnappingEnabled}},s.recreateGeometry=function(e,t){const r=this.createRenderGeometry();return i.isSome(r)&&e.addGeometry(r,t),r},s.createResources=function(e){const t=this.createTexture(),r=new m.HUDMaterial(this.materialParameters(t.id),"pointVisualElement"),s=this.recreateGeometry(e,r);return{material:r,texture:t,geometry:s,forEach(e){e(t),e(r),i.isSome(this.geometry)&&e(this.geometry)}}},s.createTexture=function(){const e=this.preferredTextureSize;return new _(y.createType(this._primitive,e,e*x),"pointVisualElement",{mipmap:!1,wrap:{s:33071,t:33071},width:e,height:e,components:4,noUnpackFlip:!0})},s.calculateMapBounds=function(e){if(i.isNone(this.resources.resources)||i.isNone(this.resources.resources.geometry))return!1;const t=this.resources.resources.geometry.data.getAttribute("position");return n.projectVectorToVector(t.data,this.view.renderCoordsHelper.spatialReference,z,this.view.spatialReference),c.expandWithBuffer(e,z),!0},s.createRenderGeometry=function(){const e=this.geometry;if(i.isNone(e))return null;const t=this.view.renderCoordsHelper,r=f.evaluateElevationAlignmentAtPoint(e,this.view.elevationProvider,g.ElevationContext.fromElevationInfo(this.elevationInfo),t),s=o.set(l.sv3d.get(),e.x,e.y,r),a=l.sv3d.get();n.projectVectorToVector(s,e.spatialReference,a,t.spatialReference);const u=this.geometrySize,c=p.createPointGeometry(null,a,null,[u,u],[0,0,0,1]);return new d(c)},t._createClass(e,[{key:"visible",get:function(){return this.resources.visible},set:function(e){this.resources.visible=e}},{key:"attached",get:function(){return this.resources.attached},set:function(e){this.resources.attached=e}},{key:"geometry",get:function(){return this._geometry},set:function(e){this._geometry=e,this.resources.recreateGeometry()}},{key:"size",get:function(){return this._size},set:function(e){if(e!==this._size){const t=this.preferredTextureSize;this._size=e,t<this.preferredTextureSize?i.isSome(this.resources)&&this.resources.recreate():this.updateSizeAttribute()}}},{key:"color",get:function(){return this._color},set:function(e){u.exactEquals(e,this._color)||(u.copy(this._color,e),this.updateMaterial())}},{key:"pixelSnappingEnabled",get:function(){return this._pixelSnappingEnabled},set:function(e){this._pixelSnappingEnabled!==e&&(this._pixelSnappingEnabled=e,this.updateMaterial())}},{key:"primitive",get:function(){return this._primitive},set:function(e){this._primitive!==e&&(this._primitive=e,i.isSome(this.resources)&&this.resources.recreate())}},{key:"outlineSize",get:function(){return this._outlineSize},set:function(e){e!==this._outlineSize&&(this._outlineSize=e,this.updateMaterial())}},{key:"outlineColor",get:function(){return this._outlineColor},set:function(e){u.exactEquals(e,this._outlineColor)||(u.copy(this._outlineColor,e),this.updateMaterial())}},{key:"elevationInfo",get:function(){return this._elevationInfo},set:function(e){this._elevationInfo=e,this.resources&&this.resources.recreateGeometry()}},{key:"geometrySize",get:function(){return this._size/x}},{key:"preferredTextureSize",get:function(){return r.clamp(r.nextHighestPowerOfTwo(2*this.geometrySize),16,128)}}]),e}();const x=.5,b=[x/2,x/2,1-x/2,1-x/2],z=s.create();e.PointVisualElement=S,Object.defineProperty(e,"__esModule",{value:!0})}));
