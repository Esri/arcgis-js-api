/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/has","../../../../core/maybe","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../chunks/vec4","../../../../chunks/vec4f32","../../../../geometry/support/clipRay","../../../../geometry/support/frustum","../../../../geometry/support/lineSegment","../../../../geometry/support/ray","./EngineVisualElement","./LaserlineVisualElement","../../terrain/OverlayRenderer","../../webgl-engine/lib/GeometryUtil","../../webgl-engine/lib/Material","../../webgl-engine/lib/RenderGeometry","../../webgl-engine/lib/VertexAttribute","../../webgl-engine/materials/RibbonLineMaterial"],(function(e,t,i,n,r,s,o,a,l,c,u,d,h,_,p,f,y,m,g,b){"use strict";let E=function(i){function h(t){var n;return(n=i.call(this,t)||this)._ray=d.create(),n._isWorldDown=!1,n._start=s.create(),n._end=s.fromValues(1,0,0),n._width=1,n._color=a.fromValues(1,0,1,1),n._polygonOffset=!1,n._writeDepthEnabled=!0,n._innerWidth=0,n._innerColor=a.fromValues(1,1,1,1),n._stipplePattern=null,n._stippleOffColor=null,n._stipplePreferContinuous=!0,n._falloff=0,n._extensionType=e.ExtensionType.LINE,n._laserlineStyle=null,n._laserlineEnabled=!1,n._renderOccluded=y.RenderOccludedFlag.OccludeAndTransparent,n._fadedExtensions=P,n._laserline=new _.LaserlineVisualElement({view:n.view}),n.applyProps(t),n}t._inheritsLoose(h,i);var E=h.prototype;return E.destroy=function(){this._laserline.destroy(),i.prototype.destroy.call(this)},E.createObject3DResourceFactory=function(e){return{view:e,createResources:e=>this._createObject3DResources(e),destroyResources:e=>this._destroyExternalResources(e),recreateGeometry:(e,t)=>this._recreateObject3DGeometry(e,t),cameraChanged:()=>this._updateGeometry()}},E.createDrapedResourceFactory=function(e){return{view:e,createResources:()=>this._createDrapedResources(),destroyResources:e=>this._destroyExternalResources(e),recreateGeometry:e=>this._recreateDrapedGeometry(e)}},E.updateVisibility=function(e){i.prototype.updateVisibility.call(this,e),this._laserline.visible=e},E.onAttachedChange=function(){this._laserline.attached=this._laserlineAttached},E.setStartEndFromWorldDownAtLocation=function(e){this._isWorldDown=!0,r.copy(this._start,e),this.view.renderCoordsHelper.worldUpAtPosition(e,this._end),r.subtract(this._end,e,this._end),d.fromPoints(this._start,this._end,this._ray),this._updateGeometry()},E._updateMaterial=function(){const{materialParameters:e}=this;n.toNullable(this.object3dResources.resources)?.material.setParameters(e),n.toNullable(this.drapedResources.resources)?.material.setParameters(e)},E._createObject3DResources=function(e){const t=new b.RibbonLineMaterial(this.materialParameters),i=new Array;return this._createObject3DGeometry(t,e,i),{material:t,geometries:i,forEach:e=>{e(t),i.forEach(e)}}},E._destroyExternalResources=function(e){e.geometries=[],e.material.dispose()},E._recreateObject3DGeometry=function(e,t){e.geometries.length=0,this._createObject3DGeometry(e.material,t,e.geometries)},E._createObject3DGeometry=function(e,t,i){const n=this._createGeometry(e);i.push(n),t.addGeometry(n),this._updateVerticesObject3D(t)},E._createDrapedResources=function(){const e=new b.RibbonLineMaterial(this.materialParameters);return{material:e,geometries:[this._createDrapedGeometry(e)]}},E._recreateDrapedGeometry=function(e){e.geometries=[this._createDrapedGeometry(e.material)]},E._createDrapedGeometry=function(e){const t=this._createGeometry(e);this._updateVerticesDraped(t);const i=new m.RenderGeometry(t,{boundingInfo:t.boundingInfo});return i.computeBoundingSphere(i.transformation,i.boundingSphere),i},E._createGeometry=function(t){const i=this.extensionType===e.ExtensionType.FADED,n=i?[s.create(),s.create(),s.create(),s.create()]:[s.create(),s.create()],r=i?[1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0]:null;return f.createPolylineGeometry(t,n,null,r)},E._updateGeometry=function(){if(this.isDraped)this.drapedResources.recreateGeometry();else{const e=n.toNullable(this.object3dResources.object);e&&this._updateVerticesObject3D(e)}},E._updateVerticesObject3D=function(e){const t=this._lineSegment;this._updateVertexAttributesObject3D(e,t),this._laserline.intersectsLine=t},E._updateVerticesDraped=function(e){this._updateVertexAttributesDraped(e,this._lineSegment)},E._updateLineSegmentFinite=function(e){return u.fromPoints(this._start,this._end,e)},E._updateLineSegmentInfinite=function(t,i){const s=this.view.state.camera;switch(l.fromRay(this._ray,D),t){case e.ExtensionType.LINE:D.c0=-Number.MAX_VALUE;break;case e.ExtensionType.RAY:case e.ExtensionType.GROUND_RAY:{const t=this._ray.origin,i=n.unwrapOr(this.view.elevationProvider.getElevation(t[0],t[1],t[2],this.view.renderCoordsHelper.spatialReference,"ground"),0),s=this.view.renderCoordsHelper.getAltitude(t);this._isWorldDown&&s<i&&r.negate(D.ray.direction,D.ray.direction),this._extensionType===e.ExtensionType.GROUND_RAY&&null!=i&&(D.c1=Math.abs(s-i));break}}if(!c.intersectClipRay(s.frustum,D))return this._updateLineSegmentFinite(i);const o=l.getStart(D,O),a=l.getEnd(D,x);return u.fromPoints(o,a,i)},E._updateVertexAttributesObject3D=function(e,t){const i=e.geometries[0].getMutableAttribute(g.VertexAttribute.POSITION)?.data;if(!i)return;let n=0;for(const r of this._lineVertices(t))i[n++]=r[0],i[n++]=r[1],i[n++]=r[2];e.geometryVertexAttrsUpdated(e.geometries[0])},E._updateVertexAttributesDraped=function(e,t){const i=e.getMutableAttribute(g.VertexAttribute.POSITION)?.data;if(!i)return;let n=0;for(const r of this._lineVertices(t))i[n++]=r[0],i[n++]=r[1],i[n++]=p.DRAPED_Z;e.invalidateBoundingInfo()},E._lineVertices=function*(t){this.extensionType===e.ExtensionType.FADED?(yield u.pointAt(t,-this.fadedExtensions.start,O),yield u.pointAt(t,0,O),yield u.pointAt(t,1,O),yield u.pointAt(t,1+this.fadedExtensions.end,O)):(yield u.pointAt(t,0,O),yield u.pointAt(t,1,O))},t._createClass(h,[{key:"start",get:function(){return this._start},set:function(e){this._isWorldDown=!1,r.exactEquals(this._start,e)||(r.copy(this._start,e),d.fromPoints(this._start,this._end,this._ray),this._updateGeometry())}},{key:"end",get:function(){return this._end},set:function(e){this._isWorldDown=!1,r.exactEquals(this._end,e)||(r.copy(this._end,e),d.fromPoints(this._start,this._end,this._ray),this._updateGeometry())}},{key:"width",get:function(){return this._width},set:function(e){e!==this._width&&(this._width=e,this._updateMaterial())}},{key:"color",get:function(){return this._color},set:function(e){o.exactEquals(e,this._color)||(o.copy(this._color,e),this._updateMaterial())}},{key:"polygonOffset",get:function(){return this._polygonOffset},set:function(e){e!==this._polygonOffset&&(this._polygonOffset=e,this._updateMaterial())}},{key:"writeDepthEnabled",get:function(){return this._writeDepthEnabled},set:function(e){this._writeDepthEnabled!==e&&(this._writeDepthEnabled=e,this._updateMaterial())}},{key:"innerWidth",get:function(){return this._innerWidth},set:function(e){e!==this._innerWidth&&(this._innerWidth=e,this._updateMaterial())}},{key:"innerColor",get:function(){return this._innerColor},set:function(e){o.exactEquals(e,this._innerColor)||(o.copy(this._innerColor,e),this._updateMaterial())}},{key:"stipplePattern",get:function(){return this._stipplePattern},set:function(e){const t=n.isSome(e)!==n.isSome(this._stipplePattern);this._stipplePattern=e,t?this.recreate():this._updateMaterial()}},{key:"stippleOffColor",get:function(){return this._stippleOffColor},set:function(e){(n.isNone(e)||n.isNone(this._stippleOffColor)||!o.exactEquals(e,this._stippleOffColor))&&(this._stippleOffColor=n.isSome(e)?a.clone(e):null,this._updateMaterial())}},{key:"stipplePreferContinuous",get:function(){return this._stipplePreferContinuous},set:function(e){e!==this._stipplePreferContinuous&&(this._stipplePreferContinuous=e,this._updateMaterial())}},{key:"falloff",get:function(){return this._falloff},set:function(e){e!==this._falloff&&(this._falloff=e,this._updateMaterial())}},{key:"extensionType",get:function(){return this._extensionType},set:function(e){e!==this._extensionType&&(this._extensionType=e,this.recreateGeometry())}},{key:"_laserlineAttached",get:function(){return this._laserlineEnabled&&n.isSome(this._laserlineStyle)&&this.attached&&!this.isDraped}},{key:"laserlineStyle",get:function(){return this._laserlineStyle},set:function(e){this._laserlineStyle=e,this._laserline.attached=this._laserlineAttached,n.isSome(e)&&(this._laserline.style=e)}},{key:"laserlineEnabled",get:function(){return this._laserlineEnabled},set:function(e){this._laserlineEnabled!==e&&(this._laserlineEnabled=e,this._laserline.attached=this._laserlineAttached)}},{key:"renderOccluded",get:function(){return this._renderOccluded},set:function(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}},{key:"_normalizedRenderOccluded",get:function(){return this.isDraped&&this._renderOccluded===y.RenderOccludedFlag.OccludeAndTransparentStencil?y.RenderOccludedFlag.OccludeAndTransparent:this._renderOccluded}},{key:"fadedExtensions",get:function(){return this._fadedExtensions},set:function(e){this._fadedExtensions=n.unwrapOr(e,P),this.recreateGeometry()}},{key:"materialParameters",get:function(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,stipplePreferContinuous:this._stipplePreferContinuous,innerWidth:this._innerWidth,innerColor:this._innerColor,falloff:this._falloff,hasPolygonOffset:this._polygonOffset,renderOccluded:this._normalizedRenderOccluded,writeDepth:this._writeDepthEnabled}}},{key:"_lineSegment",get:function(){return this._extensionType===e.ExtensionType.FADED?this._updateLineSegmentFinite(R):this._updateLineSegmentInfinite(this._extensionType,R)}}]),h}(h.EngineVisualElement);const D=l.create(),O=s.create(),x=s.create(),R=u.create();var w;e.ExtensionType=void 0,(w=e.ExtensionType||(e.ExtensionType={}))[w.LINE=0]="LINE",w[w.RAY=1]="RAY",w[w.GROUND_RAY=2]="GROUND_RAY",w[w.FADED=3]="FADED";const A=1/3,P={start:A,end:A};e.ExtendedLineVisualElement=E,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
