/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import r from"../../../../core/Accessor.js";import{IdentifiableMixin as s}from"../../../../core/Identifiable.js";import{isSome as t,isNone as o}from"../../../../core/maybe.js";import{property as i}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/arrayUtils.js";import"../../../../core/has.js";import"../../../../core/accessorSupport/ensureType.js";import{subclass as c}from"../../../../core/accessorSupport/decorators/subclass.js";import{DrapeSourceType as a}from"../../layers/interfaces.js";import{UpdatePolicy as u}from"../../webgl-engine/lib/basicInterfaces.js";import{ModelDirty as d}from"../../webgl-engine/lib/ModelDirtyTypes.js";class h{constructor(e){this.resourceFactory=e,this._resources=null,this._visible=!0,this._attached=!1}destroy(){this._destroyResources()}get resources(){return t(this._resources)?this._resources.external:null}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this._syncGeometriesToRenderer())}get attached(){return this._attached}set attached(e){e!==this._attached&&(this._attached=e,this._createOrDestroyResources())}recreate(){this.attached&&this._createResources()}recreateGeometry(){this.resourceFactory.recreateGeometry?o(this._resources)||(this._ensureRenderGeometriesRemoved(),this.resourceFactory.recreateGeometry(this._resources.external),this._syncGeometriesToRenderer()):this.recreate()}_createOrDestroyResources(){this._attached?o(this._resources)&&this._createResources():this._destroyResources()}_createResources(){this._destroyResources();const e=this.resourceFactory.createResources(),r=new n({view:this.resourceFactory.view}),s=this.resourceFactory.view.basemapTerrain?.overlayManager;this._resources={layerView:new n({view:this.resourceFactory.view}),external:e,geometriesAdded:!1},s&&(this._resources.drapeSourceRenderer=s.registerGeometryDrapeSource(r)),this._syncGeometriesToRenderer()}_destroyResources(){if(o(this._resources))return;this._ensureRenderGeometriesRemoved();const e=this.resourceFactory.view.basemapTerrain?.overlayManager;e&&e.unregisterDrapeSource(this._resources.layerView),this._resources=null}_syncGeometriesToRenderer(){this._visible?this._ensureRenderGeometriesAdded():this._ensureRenderGeometriesRemoved()}_ensureRenderGeometriesRemoved(){if(o(this._resources)||o(this._resources.drapeSourceRenderer))return;if(!this._resources.geometriesAdded)return;this._resources.drapeSourceRenderer.removeGeometries(this._resources.external.geometries,d.Geometry.UPDATE),this._resources.geometriesAdded=!1}_ensureRenderGeometriesAdded(){if(o(this._resources)||o(this._resources.drapeSourceRenderer))return;if(this._resources.geometriesAdded)return;this._resources.drapeSourceRenderer.addGeometries(this._resources.external.geometries,d.Geometry.UPDATE),this._resources.geometriesAdded=!0}}let n=class extends(s(r)){constructor(e){super(e),this.drapeSourceType=a.Features,this.updatePolicy=u.SYNC}};e([i({constructOnly:!0})],n.prototype,"view",void 0),e([i({readOnly:!0})],n.prototype,"drapeSourceType",void 0),n=e([c("DrapedVisualElementLayerView")],n);export{h as DrapedVisualElementResources};
