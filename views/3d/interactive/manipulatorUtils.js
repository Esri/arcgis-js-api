/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../core/maybe","../../../chunks/mat4","../../../chunks/vec3","../../../chunks/vec3f64","../../../chunks/vec4f64","../../../geometry/support/vectorStacks","../../../layers/graphics/hydratedFeatures","./Manipulator3D","./RenderObject","../layers/graphics/graphicUtils","../webgl-engine/lib/Attribute","../webgl-engine/lib/basicInterfaces","../webgl-engine/lib/Geometry","../webgl-engine/lib/GeometryUtil","../webgl-engine/lib/Material","../webgl-engine/lib/VertexAttribute","../webgl-engine/materials/ColorMaterial","../webgl-engine/materials/ImageMaterial","../webgl-engine/materials/NativeLineMaterial","../webgl-engine/materials/RibbonLineMaterial","../webgl-engine/materials/ShadedColorMaterial","../../interactive/interfaces"],(function(e,t,a,r,n,l,i,c,o,u,s,d,g,p,m,b,O,M,f,w,h,S,y){"use strict";function F(e,t=b.RenderOccludedFlag.OccludeAndTransparent,a=!0){const r=l.fromValues(e[0],e[1],e[2],e.length>3?e[3]:1),n=e[3]<1;return a?new S.ShadedColorMaterial({color:r,transparent:n,writeDepth:!0,cullFace:g.CullFaceOptions.Back,renderOccluded:t}):new M.ColorMaterial({color:r,transparent:n,writeDepth:!0,cullFace:g.CullFaceOptions.Back,renderOccluded:t})}function R(e,t=b.RenderOccludedFlag.OccludeAndTransparent){const a=l.fromValues(e[0],e[1],e[2],4===e.length?e[3]:1);return new M.ColorMaterial({color:a,transparent:!0,writeDepth:!0,cullFace:g.CullFaceOptions.Front,renderOccluded:t})}const v=Object.freeze({calloutLength:40,calloutWidth:1,discRadius:27,focusMultiplier:1.1,calloutColor:n.fromValues(1,.5,0)});function A(e,t){const a=new o.Manipulator3D({view:e,autoScaleRenderObjects:!1,collisionPriority:1,metadata:t.metadata});return j(a,t),a}function j(e,t){const a=t.material??new f.ImageMaterial({transparent:!0,writeDepth:!1,textureId:t.texture?.id,renderOccluded:b.RenderOccludedFlag.Opaque}),r=t.focusMultiplier??v.focusMultiplier,n=t.calloutLength??v.calloutLength,i=v.discRadius*(t.discScale??1),c=i*r,o=(e,t)=>{const a=[0,1,2,2,3,0];return new p.Geometry(t,[[O.VertexAttribute.POSITION,new d.Attribute([n-e,-e,0,n+e,-e,0,n+e,e,0,n-e,e,0],3,!0)],[O.VertexAttribute.UV0,new d.Attribute([0,0,1,0,1,1,0,1],2,!0)]],[[O.VertexAttribute.POSITION,a],[O.VertexAttribute.UV0,a]])},s=v.calloutColor,g=t.calloutWidth??v.calloutWidth,M=new(g>1?h.RibbonLineMaterial:w.NativeLineMaterial)({width:g,color:l.fromValues(s[0],s[1],s[2],t.calloutOpacity??1),renderOccluded:b.RenderOccludedFlag.OccludeAndTransparent}),S=m.createPolylineGeometry(M,[[0,0,0],[n-i,0,0]]),F=m.createPolylineGeometry(M,[[0,0,0],[n-c,0,0]]),R=t.customStateMask??y.ManipulatorStateCustomFlags.None;e.collisionType={type:"disc",direction:[0,0,1],offset:[n,0,0]},e.focusMultiplier=r,e.metadata=t.metadata,e.radius=i,e.renderObjects=[new u.RenderObject(o(i,a),y.ManipulatorStateFlags.Unfocused|R),new u.RenderObject(S,y.ManipulatorStateFlags.Unfocused|R),new u.RenderObject(o(c,a),y.ManipulatorStateFlags.Focused|R),new u.RenderObject(F,y.ManipulatorStateFlags.Focused|R)]}function C(e,t,a=1,r=y.ManipulatorStateCustomFlags.None){const n=F(l.fromValues(t[0],t[1],t[2],null!=a?a:1)),i=[new u.RenderObject(m.createSphereGeometry(n,1,32,32),r)];return new o.Manipulator3D({view:e,renderObjects:i})}const V=Object.freeze({autoScaleRenderObjects:!1,worldSized:!0});function G(e,t,n,l){const c=r.subtract(i.sv3d.get(),e,n),o=I(c,r.cross(i.sv3d.get(),l,c),n,i.sm4d.get());a.invert(o,o);const u=r.transformMat4(i.sv3d.get(),t,o);return Math.atan2(u[1],u[0])}function I(e,t,a,n){const l=r.normalize(i.sv3d.get(),e),c=r.normalize(i.sv3d.get(),t),o=r.cross(i.sv3d.get(),l,c);return n[0]=l[0],n[1]=l[1],n[2]=l[2],n[3]=0,n[4]=c[0],n[5]=c[1],n[6]=c[2],n[7]=0,n[8]=o[0],n[9]=o[1],n[10]=o[2],n[11]=0,n[12]=a[0],n[13]=a[1],n[14]=a[2],n[15]=1,n}function T(e,a){const r=e.getViewForGraphic(a);return t.isSome(r)&&"computeAttachmentOrigin"in r?r.computeAttachmentOrigin(a,e.spatialReference):null}function k(e,a,r){const n=T(e,r);t.isSome(n)?a.elevationAlignedLocation=n:x(a,r.geometry)}function x(e,a){if(t.isNone(a))return;const r="mesh"===a.type?a.anchor:s.computeCentroid(a);t.isNone(r)||(e.location=c.hydrateGeometry(r))}e.calculateInputRotationTransform=G,e.calculateTranslateRotateFromBases=I,e.createManipulatorMaterial=F,e.createManipulatorOutlineMaterial=R,e.createRotateManipulator=A,e.createSphereManipulator=C,e.getGraphicAttachmentOrigin=T,e.placeAtGraphic=k,e.updateRotateManipulator=j,e.worldScaledManipulatorSettings=V,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
