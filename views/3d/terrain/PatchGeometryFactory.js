/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../core/maybe","../../../core/mathUtils","../../../chunks/vec3f64","../../../chunks/vec3","../../../chunks/vec4f64","../../../chunks/vec4","../../../geometry/support/aaBoundingBox","./TerrainConst","../support/buffer/InterleavedLayout","../webgl-engine/lib/Util","../webgl-engine/materials/internal/MaterialUtil","./ElevationData","../support/buffer/BufferPool"],(function(e,t,n,r,o,s,i,c,u,a,f,l,m,g){"use strict";const h=a.newLayout().vec3f(f.VertexAttrConstants.POSITION).vec2f(f.VertexAttrConstants.UV0),p=new g.BufferPool((e=>h.createBuffer(e)),(e=>e.count));let y=function(e,t,n){this.values=e,this.numSurfaceIndices=t,this.numSkirtIndices=n};const I=new Map;function d(e,t,n,r){const o=(2&n)>0,s=t+(r?1024:0)+(o?2048:0);let i=I.get(s);i||(i=function(e,t,n){const r=e-1,o=e-1,s=e*e,i=2*r+2*o;let c=r*o*2*3,u=6*i,a=6*(2*r+o-1);n&&(c*=2,u*=2,a*=2);const f=s+i>65536?new Uint32Array(c+u):new Uint16Array(c+u);let l,m,g,h,p=0,I=0,d=c,E=0;for(let e=0;e<=o;e++){t&&(E=0===e?a:e===o?-a:0),d+=E;for(let t=0;t<=r;t++){const i=A(t,e,r,o);if(i>-1){const c=w(t,e,r,o);0!==c&&(l=p,m=s+i,g=s+(0===t&&1===e?0:i+1),h=p+c,n?(f[d+0]=l,f[d+1]=m,f[d+2]=m,f[d+3]=g,f[d+4]=g,f[d+5]=l,f[d+6]=g,f[d+7]=h,f[d+8]=h,f[d+9]=l,f[d+10]=l,f[d+11]=g,d+=12):(f[d+0]=l,f[d+1]=m,f[d+2]=g,f[d+3]=g,f[d+4]=h,f[d+5]=l,d+=6))}++p,t<r&&e<o&&(l=e*(r+1)+t,m=l+1,g=m+(r+1),h=g-1,n?(f[I+0]=l,f[I+1]=m,f[I+2]=m,f[I+3]=g,f[I+4]=g,f[I+5]=l,f[I+6]=g,f[I+7]=h,f[I+8]=h,f[I+9]=l,f[I+10]=l,f[I+11]=g,I+=12):(f[I+0]=l,f[I+1]=m,f[I+2]=g,f[I+3]=g,f[I+4]=h,f[I+5]=l,I+=6))}d-=E}return new y(f,c,u)}(t,o,r),I.set(s,i)),e.indices=i.values,e.numSurfaceIndices=i.numSurfaceIndices,e.numSkirtIndices=i.numSkirtIndices,e.numWithoutSkirtIndices=e.numSurfaceIndices+(n?6*(t-1)*(r?2:1):0)}function E(e,t,n,r){e<r[0]&&(r[0]=e),e>r[3]&&(r[3]=e),t<r[1]&&(r[1]=t),t>r[4]&&(r[4]=t),n<r[2]&&(r[2]=n),n>r[5]&&(r[5]=n)}function S(e,t){const n=t>e?1:0;return 2+4*n+(1-2*n)*(e+t)}function A(e,t,n,r){return 0===t?e:e===n?n+t:t===r?n+r+(n-e):0===e&&t>0?2*n+r+(r-t):-1}function w(e,t,n,r){return 0===t&&e!==n?1:e===n&&t!==r?n+1:t===r&&0!==e?-1:0===e&&0!==t?-(n+1):0}const T=2**-52;const P=new Array(u.MAX_PATCH_TESSELATION+1),R=new Array(u.MAX_PATCH_TESSELATION+1),V=new Array(u.MAX_PATCH_TESSELATION+1),v=new Array(u.MAX_PATCH_TESSELATION+1),M=r.create(),x=r.create();e.PatchGeometry=function(){this.indices=null,this.vertexAttributes=null,this.boundingBox=c.empty(),this.numSurfaceIndices=0,this.numSkirtIndices=0,this.numWithoutSkirtIndices=0,this.numVertsPerRow=0,this.skirtLength=0,this.uvOffsetAndScale=s.create()},e.clearCaches=function(){p.clear(),I.clear()},e.createPlanarGlobePatch=function(e,t,n,r){const o=t[0],s=t[1],a=t[2]-o,f=t[3]-s,l=e.clippingArea,g=l?Math.max(0,(l[0]-t[0])/a):0,h=l?Math.max(0,(l[1]-t[1])/f):0,y=l?Math.min(1,(l[2]-t[0])/a):1,I=l?Math.min(1,(l[3]-t[1])/f):1,w=y>g?1/(y-g):1,T=I>h?1/(I-h):1,P=-g*w,R=-h*T,V=.1*a,v=e.numVertsPerRow-1,M=e.numVertsPerRow-1,x=e.numVertsPerRow*e.numVertsPerRow,_=2*v+2*M,b=p.acquire(x+_),k=b.position.typedBuffer,O=b.uv0.typedBuffer,B=r.geometryInfo.boundingBox;c.empty(B);let D=0;for(let t=0;t<=M;t++){const r=t/M;let i=R+r*T,c=s+r*f;l&&(c<l[1]?(c=l[1],i=0):c>l[3]&&(c=l[3],i=1));for(let r=0;r<=v;r++){const s=r/v;let f=P+s*w,g=o+s*a;l&&(g<l[0]?(g=l[0],f=0):g>l[2]&&(g=l[2],f=1));const h=e.samplerData&&m.ElevationData.sample(g,c,e.samplerData)||0,p=g-n[0],y=c-n[1],I=h-n[2];E(p,y,I,B);const d=u.GEOMETRY_VERTEX_STRIDE*D;k[d+0]=p,k[d+1]=y,k[d+2]=I,O[d+0]=f,O[d+1]=i;const T=A(r,t,v,v);if(T>-1){const e=u.GEOMETRY_VERTEX_STRIDE*(x+T);k[e+0]=p,k[e+1]=y,k[e+2]=I,O[e+0]=S(f,i),O[e+1]=V}++D}}r.geometryInfo.numVertsPerRow=e.numVertsPerRow,r.geometryInfo.vertexAttributes=b,r.geometryInfo.skirtLength=V,i.set(r.geometryInfo.uvOffsetAndScale,g,h,y-g,I-h),d(r.geometryInfo,e.numVertsPerRow,0,e.wireframe)},e.createSphericalGlobePatch=function(e,t,r,o,s,a,f,l){const g=s[0],h=s[1],y=s[2],I=s[3],w=.1*f.radius*(I-h),T=e.numVertsPerRow-1,M=e.numVertsPerRow-1,x=e.numVertsPerRow*e.numVertsPerRow,_=2*T+2*M,b=p.acquire(x+_),k=b.position.typedBuffer,O=b.uv0.typedBuffer,B=o.geometryInfo.boundingBox;c.empty(B);const D=t[2]-t[0],L=t[3]-t[1],C=y-g,G=r[0],X=r[1],N=r[2];for(let e=0;e<=T;e++){const n=e/T,r=g+n*C;P[e]=Math.sin(r),R[e]=Math.cos(r),V[e]=n,v[e]=t[0]+n*D}const U=a&&!!(1&l),H=a&&!!(2&l);let Y=0;for(let r=0;r<=M;r++){let o=r/M;const s=n.lerp(h,I,o),i=Math.cos(s),c=Math.sin(s);let l;a?(l=f.halfSemiMajorAxis*Math.log((1+c)/(1-c)),o=(l-t[1])/L):l=180*s/Math.PI;for(let t=0;t<=T;t++){const n=V[t],s=P[t],a=R[t];let g=f.radius;e.samplerData&&(g+=m.ElevationData.sample(v[t],l,e.samplerData)||0);const h=a*i*g-G,p=s*i*g-X,y=c*g-N;E(h,p,y,B);const I=u.GEOMETRY_VERTEX_STRIDE*Y;k[I+0]=h,k[I+1]=p,k[I+2]=y,O[I+0]=n,O[I+1]=o;const d=A(t,r,T,M);if(d>-1){const e=u.GEOMETRY_VERTEX_STRIDE*(x+d),t=U&&0===r?-1:H&&r===M?1:0,s=0===t?h:-G,i=0===t?p:-X,c=0===t?y:f.radius*t-N;k[e+0]=s,k[e+1]=i,k[e+2]=c,O[e+0]=0===t?S(n,o):n,O[e+1]=0===t?w:o,0!==t&&E(s,i,c,B)}++Y}}o.geometryInfo.numVertsPerRow=e.numVertsPerRow,o.geometryInfo.vertexAttributes=b,o.geometryInfo.skirtLength=w,i.set(o.geometryInfo.uvOffsetAndScale,0,0,1,1),d(o.geometryInfo,e.numVertsPerRow,a?l:0,e.wireframe)},e.intersectSkirts=function(e,n,r,s,i,c,u,a,f){const m=c.position,g=c.uv0,h=e[0],p=e[1],y=e[2],I=n[0]-h,d=n[1]-p,E=n[2]-y;s*=3;for(let e=r*=3;e<s;e+=3){const n=i[e],r=i[e+1],s=i[e+2];let c=m.get(n,0),S=m.get(n,1),A=m.get(n,2),w=m.get(r,0),P=m.get(r,1),R=m.get(r,2),V=m.get(s,0),v=m.get(s,1),_=m.get(s,2);const b=g.get(n,0),k=g.get(r,0),O=g.get(s,0);b>=2&&(o.set(M,c,S,A),u(M),c+=M[0],S+=M[1],A+=M[2]),k>=2&&(o.set(M,w,P,R),u(M),w+=M[0],P+=M[1],R+=M[2]),O>=2&&(o.set(M,V,v,_),u(M),V+=M[0],v+=M[1],_+=M[2]),t.isSome(a)&&([c,S,A]=a.applyToVertex(c,S,A),[w,P,R]=a.applyToVertex(w,P,R),[V,v,_]=a.applyToVertex(V,v,_));const B=w-c,D=P-S,L=R-A,C=V-c,G=v-S,X=_-A,N=d*X-G*E,U=E*C-X*I,H=I*G-C*d,Y=B*N+D*U+L*H,j=h-c,q=p-S,W=y-A,z=q*L-D*W,F=W*B-L*j,J=j*D-B*q;if(Y>T){const e=j*N+q*U+W*H;if(e<0||e>Y)continue;const t=I*z+d*F+E*J;if(t<0||e+t>Y)continue}else{if(!(Y<-T))continue;{const e=j*N+q*U+W*H;if(e>0||e<Y)continue;const t=I*z+d*F+E*J;if(t>0||e+t<Y)continue}}const K=(C*z+G*F+X*J)/Y;if(K>=0){f(K,l.computeNormal(B,D,L,C,G,X,x))}}},e.releaseGeometry=function(e){p.release(e.vertexAttributes),e.vertexAttributes=null,e.indices=null},Object.defineProperty(e,"__esModule",{value:!0})}));
