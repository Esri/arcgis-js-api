/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../core/mathUtils","../../../core/maybe","../../../chunks/vec3f64","../../../chunks/vec4","../../../chunks/vec4f64","../../../geometry/support/aaBoundingBox","../../../geometry/support/buffer/BufferPool","../support/buffer/InterleavedLayout","./ElevationData","./TerrainConst","../webgl-engine/materials/internal/MaterialUtil"],(function(e,t,n,o,r,s,i,c,a,u,f,l){"use strict";const m=a.newLayout().vec3f("position").vec2f("uv0"),g=new c.BufferPool((e=>m.createBuffer(e)),(e=>e.count));let p=function(){this.indices=null,this.vertexAttributes=null,this.boundingBox=i.empty(),this.numSurfaceIndices=0,this.numSkirtIndices=0,this.numWithoutSkirtIndices=0,this.numVertsPerRow=0,this.skirtLength=0,this.uvOffsetAndScale=s.create()},h=function(e,t,n){this.values=e,this.numSurfaceIndices=t,this.numSkirtIndices=n};function y(){g.clear(),w.clear()}function S(e){g.release(e.vertexAttributes),e.vertexAttributes=null,e.indices=null}const I=65536;function E(e,n,o,s,c,a,l,m){const p=c[0],h=c[1],y=c[2],S=c[3],I=.1*l.radius*(S-h),E=e.numVertsPerRow-1,d=e.numVertsPerRow-1,w=e.numVertsPerRow*e.numVertsPerRow,A=2*E+2*d,R=g.acquire(w+A),V=R.position.typedBuffer,b=R.uv0.typedBuffer,x=s.geometryInfo.boundingBox;i.empty(x);const B=n[2]-n[0],L=n[3]-n[1],G=y-p,N=o[0],X=o[1],q=o[2];for(let t=0;t<=E;t++){const e=t/E,o=p+e*G;_[t]=Math.sin(o),k[t]=Math.cos(o),D[t]=e,O[t]=n[0]+e*B}const C=a&&!!(1&m),U=a&&!!(2&m);let H=0;for(let r=0;r<=d;r++){let o=r/d;const s=t.lerp(h,S,o),i=Math.cos(s),c=Math.sin(s);let m;a?(m=l.halfSemiMajorAxis*Math.log((1+c)/(1-c)),o=(m-n[1])/L):m=180*s/Math.PI;for(let t=0;t<=E;t++){const n=D[t],s=_[t],a=k[t];let g=l.radius;e.samplerData&&(g+=u.ElevationData.sample(O[t],m,e.samplerData)||0);const p=a*i*g-N,h=s*i*g-X,y=c*g-q;M(p,h,y,x);const S=f.GEOMETRY_VERTEX_STRIDE*H;V[S+0]=p,V[S+1]=h,V[S+2]=y,b[S+0]=n,b[S+1]=o;const T=v(t,r,E,d);if(T>-1){const e=f.GEOMETRY_VERTEX_STRIDE*(w+T),t=C&&0===r?-1:U&&r===d?1:0,s=0===t?p:-N,i=0===t?h:-X,c=0===t?y:l.radius*t-q;V[e+0]=s,V[e+1]=i,V[e+2]=c,b[e+0]=0===t?P(n,o):n,b[e+1]=0===t?I:o,0!==t&&M(s,i,c,x)}++H}}s.geometryInfo.numVertsPerRow=e.numVertsPerRow,s.geometryInfo.vertexAttributes=R,s.geometryInfo.skirtLength=I,r.set(s.geometryInfo.uvOffsetAndScale,0,0,1,1),T(s.geometryInfo,e.numVertsPerRow,a?m:0,e.wireframe),s.intersectionData=null,s.skirtIntersectionData=null}function d(e,t,o,s,c){const a=t[0],l=t[1],m=t[2]-a,p=t[3]-l,h=e.clippingArea,y=n.isSome(h)?Math.max(0,(h[0]-t[0])/m):0,S=n.isSome(h)?Math.max(0,(h[1]-t[1])/p):0,I=n.isSome(h)?Math.min(1,(h[2]-t[0])/m):1,E=n.isSome(h)?Math.min(1,(h[3]-t[1])/p):1,d=I>y?1/(I-y):1,w=E>S?1/(E-S):1,A=-y*d,R=-S*w,V=m*s*.1,b=e.numVertsPerRow-1,x=e.numVertsPerRow-1,_=e.numVertsPerRow*e.numVertsPerRow,k=2*b+2*x,D=g.acquire(_+k),O=D.position.typedBuffer,B=D.uv0.typedBuffer,L=c.geometryInfo.boundingBox;i.empty(L);let G=0;for(let r=0;r<=x;r++){const t=r/x;let i=R+t*w,c=l+t*p;n.isSome(h)&&(c<h[1]?(c=h[1],i=0):c>h[3]&&(c=h[3],i=1));for(let l=0;l<=b;l++){const t=l/b;let g=A+t*d,p=a+t*m;n.isSome(h)&&(p<h[0]?(p=h[0],g=0):p>h[2]&&(p=h[2],g=1));const y=e.samplerData&&u.ElevationData.sample(p,c,e.samplerData)||0,S=p*s-o[0],I=c*s-o[1],E=y-o[2];M(S,I,E,L);const w=f.GEOMETRY_VERTEX_STRIDE*G;O[w+0]=S,O[w+1]=I,O[w+2]=E,B[w+0]=g,B[w+1]=i;const T=v(l,r,b,b);if(T>-1){const e=f.GEOMETRY_VERTEX_STRIDE*(_+T);O[e+0]=S,O[e+1]=I,O[e+2]=E,B[e+0]=P(g,i),B[e+1]=V}++G}}c.geometryInfo.numVertsPerRow=e.numVertsPerRow,c.geometryInfo.vertexAttributes=D,c.geometryInfo.skirtLength=V,r.set(c.geometryInfo.uvOffsetAndScale,y,S,I-y,E-S),T(c.geometryInfo,e.numVertsPerRow,0,e.wireframe),c.intersectionData=null,c.skirtIntersectionData=null}const w=new Map;function T(e,t,n,o){const r=(2&n)>0,s=t+(o?1024:0)+(r?2048:0);let i=w.get(s);i||(i=A(t,r,o),w.set(s,i)),e.indices=i.values,e.numSurfaceIndices=i.numSurfaceIndices,e.numSkirtIndices=i.numSkirtIndices,e.numWithoutSkirtIndices=e.numSurfaceIndices+(n?6*(t-1)*(o?2:1):0)}function A(e,t,n){const o=e-1,r=e-1,s=e*e,i=2*o+2*r;let c=o*r*2*3,a=6*i,u=6*(2*o+r-1);n&&(c*=2,a*=2,u*=2);const f=s+i>I?new Uint32Array(c+a):new Uint16Array(c+a);let l,m,g,p,y=0,S=0,E=c,d=0;for(let h=0;h<=r;h++){t&&(d=0===h?u:h===r?-u:0),E+=d;for(let e=0;e<=o;e++){const t=v(e,h,o,r);if(t>-1){const i=R(e,h,o,r);0!==i&&(l=y,m=s+t,g=s+(0===e&&1===h?0:t+1),p=y+i,n?(f[E+0]=l,f[E+1]=m,f[E+2]=m,f[E+3]=g,f[E+4]=g,f[E+5]=l,f[E+6]=g,f[E+7]=p,f[E+8]=p,f[E+9]=l,f[E+10]=l,f[E+11]=g,E+=12):(f[E+0]=l,f[E+1]=m,f[E+2]=g,f[E+3]=g,f[E+4]=p,f[E+5]=l,E+=6))}++y,e<o&&h<r&&(l=h*(o+1)+e,m=l+1,g=m+(o+1),p=g-1,n?(f[S+0]=l,f[S+1]=m,f[S+2]=m,f[S+3]=g,f[S+4]=g,f[S+5]=l,f[S+6]=g,f[S+7]=p,f[S+8]=p,f[S+9]=l,f[S+10]=l,f[S+11]=g,S+=12):(f[S+0]=l,f[S+1]=m,f[S+2]=g,f[S+3]=g,f[S+4]=p,f[S+5]=l,S+=6))}E-=d}return new h(f,c,a)}function M(e,t,n,o){e<o[0]&&(o[0]=e),e>o[3]&&(o[3]=e),t<o[1]&&(o[1]=t),t>o[4]&&(o[4]=t),n<o[2]&&(o[2]=n),n>o[5]&&(o[5]=n)}function P(e,t){const n=t>e?1:0;return 2+4*n+(1-2*n)*(e+t)}function v(e,t,n,o){return 0===t?e:e===n?n+t:t===o?n+o+(n-e):0===e&&t>0?2*n+o+(o-t):-1}function R(e,t,n,o){return 0===t&&e!==n?1:e===n&&t!==o?n+1:t===o&&0!==e?-1:0===e&&0!==t?-(n+1):0}function V(e,t,o,r,s,i,c,a,u,f){const m=i.position,g=i.uv0,p=e[0],h=e[1],y=e[2],S=t[0]-p,I=t[1]-h,E=t[2]-y;r*=3;for(let d=o*=3;d<r;d+=3){const e=s[d],t=s[d+1],o=s[d+2];let r=m.get(e,0),i=m.get(e,1),w=m.get(e,2),T=m.get(t,0),A=m.get(t,1),M=m.get(t,2),P=m.get(o,0),v=m.get(o,1),R=m.get(o,2);if(g.get(e,0)>=2){const e=r+a[0],t=i+a[1],n=w+a[2],o=c/Math.sqrt(e*e+t*t+n*n);r+=e*o,i+=t*o,w+=n*o}if(g.get(t,0)>=2){const e=T+a[0],t=A+a[1],n=M+a[2],o=c/Math.sqrt(e*e+t*t+n*n);T+=e*o,A+=t*o,M+=n*o}if(g.get(o,0)>=2){const e=P+a[0],t=v+a[1],n=R+a[2],o=c/Math.sqrt(e*e+t*t+n*n);P+=e*o,v+=t*o,R+=n*o}n.isSome(u)&&([r,i,w]=u.applyToVertex(r,i,w),[T,A,M]=u.applyToVertex(T,A,M),[P,v,R]=u.applyToVertex(P,v,R));const V=T-r,b=A-i,x=M-w,_=P-r,k=v-i,D=R-w,O=I*D-k*E,L=E*_-D*S,G=S*k-_*I,N=V*O+b*L+x*G;if(Math.abs(N)<=Number.EPSILON)continue;const X=p-r,q=h-i,C=y-w,U=X*O+q*L+C*G;if(N>0){if(U<0||U>N)continue}else if(U>0||U<N)continue;const H=q*x-b*C,Y=C*V-x*X,j=X*b-V*q,W=S*H+I*Y+E*j;if(N>0){if(W<0||U+W>N)continue}else if(W>0||U+W<N)continue;const F=(_*H+k*Y+D*j)/N;if(F>=0){f(F,l.computeNormal(V,b,x,_,k,D,B))}}}function b(e,t,n,o,r,s){const i=o.position,c=o.uv0,a=new Map,u=3*t,f=3*n-u,l=new Uint32Array(f);let m=0;for(let p=0;p<f;++p){const t=e[p+u];if(a.has(t))l[p]=a.get(t);else{const e=m++;a.set(t,e),l[p]=e}}const g=new Float64Array(3*m);return a.forEach(((e,t)=>{let n=i.get(t,0),o=i.get(t,1),a=i.get(t,2);if(c.get(t,0)>=2){const e=n+s[0],t=o+s[1],i=a+s[2],c=r/Math.sqrt(e*e+t*t+i*i);n+=e*c,o+=t*c,a+=i*c}g[3*e+0]=n,g[3*e+1]=o,g[3*e+2]=a})),{vertices:g,indices:l}}function x(e,t,o,r,s,i,c,a,u){const f=i.position,m=i.uv0,g=e[0],p=e[1],h=e[2],y=t[0]-g,S=t[1]-p,I=t[2]-h;r*=3;for(let E=o*=3;E<r;E+=3){const e=s[E],t=s[E+1],o=s[E+2];let r=f.get(e,0),i=f.get(e,1),d=f.get(e,2),w=f.get(t,0),T=f.get(t,1),A=f.get(t,2),M=f.get(o,0),P=f.get(o,1),v=f.get(o,2);m.get(e,0)>=2&&(d+=c);m.get(t,0)>=2&&(A+=c);m.get(o,0)>=2&&(v+=c),n.isSome(a)&&([r,i,d]=a.applyToVertex(r,i,d),[w,T,A]=a.applyToVertex(w,T,A),[M,P,v]=a.applyToVertex(M,P,v));const R=w-r,V=T-i,b=A-d,x=M-r,_=P-i,k=v-d,D=S*k-_*I,O=I*x-k*y,L=y*_-x*S,G=R*D+V*O+b*L;if(Math.abs(G)<=Number.EPSILON)continue;const N=g-r,X=p-i,q=h-d,C=N*D+X*O+q*L;if(G>0){if(C<0||C>G)continue}else if(C>0||C<G)continue;const U=X*b-V*q,H=q*R-b*N,Y=N*V-R*X,j=y*U+S*H+I*Y;if(G>0){if(j<0||C+j>G)continue}else if(j>0||C+j<G)continue;const W=(x*U+_*H+k*Y)/G;if(W>=0){u(W,l.computeNormal(R,V,b,x,_,k,B))}}}const _=new Array(f.MAX_PATCH_TESSELATION+1),k=new Array(f.MAX_PATCH_TESSELATION+1),D=new Array(f.MAX_PATCH_TESSELATION+1),O=new Array(f.MAX_PATCH_TESSELATION+1),B=o.create();e.PatchGeometry=p,e.clearCaches=y,e.createPlanarGlobePatch=d,e.createSphericalGlobePatch=E,e.getGlobalSkirtGeometry=b,e.intersectSkirtsGlobal=V,e.intersectSkirtsLocal=x,e.releaseGeometry=S,Object.defineProperty(e,"__esModule",{value:!0})}));
