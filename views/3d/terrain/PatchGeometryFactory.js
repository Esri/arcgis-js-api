/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../../core/mathUtils","../../../core/maybe","../../../chunks/vec3f64","../../../chunks/vec4","../../../chunks/vec4f64","../../../geometry/support/aaBoundingBox","../../../geometry/support/buffer/BufferPool","../support/buffer/InterleavedLayout","./ElevationData","./TerrainConst","../webgl-engine/materials/internal/MaterialUtil"],(function(e,t,n,o,r,s,i,c,u,a,f,l){"use strict";const m=u.newLayout().vec3f("position").vec2f("uv0"),g=new c.BufferPool((e=>m.createBuffer(e)),(e=>e.count));let p=function(){this.indices=null,this.vertexAttributes=null,this.boundingBox=i.empty(),this.numSurfaceIndices=0,this.numSkirtIndices=0,this.numWithoutSkirtIndices=0,this.numVertsPerRow=0,this.skirtLength=0,this.uvOffsetAndScale=s.create()},h=function(e,t,n){this.values=e,this.numSurfaceIndices=t,this.numSkirtIndices=n};function S(){g.clear(),T.clear()}function y(e){g.release(e.vertexAttributes),e.vertexAttributes=null,e.indices=null}const I=65536;function E(e,n,o,s,c,u,l,m){const p=c[0],h=c[1],S=c[2],y=c[3],I=.1*l.radius*(y-h),E=e.numVertsPerRow-1,d=e.numVertsPerRow-1,T=e.numVertsPerRow*e.numVertsPerRow,w=2*E+2*d,v=g.acquire(T+w),V=v.position.typedBuffer,b=v.uv0.typedBuffer,B=s.geometryInfo.boundingBox;i.empty(B);const D=n[2]-n[0],L=n[3]-n[1],N=S-p,G=o[0],X=o[1],C=o[2];for(let t=0;t<=E;t++){const e=t/E,o=p+e*N;x[t]=Math.sin(o),_[t]=Math.cos(o),k[t]=e,O[t]=n[0]+e*D}const q=u&&!!(1&m),H=u&&!!(2&m);let U=0;for(let r=0;r<=d;r++){let o=r/d;const s=t.lerp(h,y,o),i=Math.cos(s),c=Math.sin(s);let m;u?(m=l.halfSemiMajorAxis*Math.log((1+c)/(1-c)),o=(m-n[1])/L):m=180*s/Math.PI;for(let t=0;t<=E;t++){const n=k[t],s=x[t],u=_[t];let g=l.radius;e.samplerData&&(g+=a.ElevationData.sample(O[t],m,e.samplerData)||0);const p=u*i*g-G,h=s*i*g-X,S=c*g-C;A(p,h,S,B);const y=f.GEOMETRY_VERTEX_STRIDE*U;V[y+0]=p,V[y+1]=h,V[y+2]=S,b[y+0]=n,b[y+1]=o;const P=R(t,r,E,d);if(P>-1){const e=f.GEOMETRY_VERTEX_STRIDE*(T+P),t=q&&0===r?-1:H&&r===d?1:0,s=0===t?p:-G,i=0===t?h:-X,c=0===t?S:l.radius*t-C;V[e+0]=s,V[e+1]=i,V[e+2]=c,b[e+0]=0===t?M(n,o):n,b[e+1]=0===t?I:o,0!==t&&A(s,i,c,B)}++U}}s.geometryInfo.numVertsPerRow=e.numVertsPerRow,s.geometryInfo.vertexAttributes=v,s.geometryInfo.skirtLength=I,r.set(s.geometryInfo.uvOffsetAndScale,0,0,1,1),P(s.geometryInfo,e.numVertsPerRow,u?m:0,e.wireframe),s.intersectionData=null}function d(e,t,o,s,c){const u=t[0],l=t[1],m=t[2]-u,p=t[3]-l,h=e.clippingArea,S=n.isSome(h)?Math.max(0,(h[0]-t[0])/m):0,y=n.isSome(h)?Math.max(0,(h[1]-t[1])/p):0,I=n.isSome(h)?Math.min(1,(h[2]-t[0])/m):1,E=n.isSome(h)?Math.min(1,(h[3]-t[1])/p):1,d=I>S?1/(I-S):1,T=E>y?1/(E-y):1,w=-S*d,v=-y*T,V=.1*m,b=e.numVertsPerRow-1,x=e.numVertsPerRow-1,_=e.numVertsPerRow*e.numVertsPerRow,k=2*b+2*x,O=g.acquire(_+k),B=O.position.typedBuffer,D=O.uv0.typedBuffer,L=c.geometryInfo.boundingBox;i.empty(L);let N=0;for(let r=0;r<=x;r++){const t=r/x;let i=v+t*T,c=l+t*p;n.isSome(h)&&(c<h[1]?(c=h[1],i=0):c>h[3]&&(c=h[3],i=1));for(let l=0;l<=b;l++){const t=l/b;let g=w+t*d,p=u+t*m;n.isSome(h)&&(p<h[0]?(p=h[0],g=0):p>h[2]&&(p=h[2],g=1));const S=e.samplerData&&a.ElevationData.sample(p,c,e.samplerData)||0,y=p*s-o[0],I=c*s-o[1],E=S-o[2];A(y,I,E,L);const T=f.GEOMETRY_VERTEX_STRIDE*N;B[T+0]=y,B[T+1]=I,B[T+2]=E,D[T+0]=g,D[T+1]=i;const P=R(l,r,b,b);if(P>-1){const e=f.GEOMETRY_VERTEX_STRIDE*(_+P);B[e+0]=y,B[e+1]=I,B[e+2]=E,D[e+0]=M(g,i),D[e+1]=V}++N}}c.geometryInfo.numVertsPerRow=e.numVertsPerRow,c.geometryInfo.vertexAttributes=O,c.geometryInfo.skirtLength=V,r.set(c.geometryInfo.uvOffsetAndScale,S,y,I-S,E-y),P(c.geometryInfo,e.numVertsPerRow,0,e.wireframe)}const T=new Map;function P(e,t,n,o){const r=(2&n)>0,s=t+(o?1024:0)+(r?2048:0);let i=T.get(s);i||(i=w(t,r,o),T.set(s,i)),e.indices=i.values,e.numSurfaceIndices=i.numSurfaceIndices,e.numSkirtIndices=i.numSkirtIndices,e.numWithoutSkirtIndices=e.numSurfaceIndices+(n?6*(t-1)*(o?2:1):0)}function w(e,t,n){const o=e-1,r=e-1,s=e*e,i=2*o+2*r;let c=o*r*2*3,u=6*i,a=6*(2*o+r-1);n&&(c*=2,u*=2,a*=2);const f=s+i>I?new Uint32Array(c+u):new Uint16Array(c+u);let l,m,g,p,S=0,y=0,E=c,d=0;for(let h=0;h<=r;h++){t&&(d=0===h?a:h===r?-a:0),E+=d;for(let e=0;e<=o;e++){const t=R(e,h,o,r);if(t>-1){const i=v(e,h,o,r);0!==i&&(l=S,m=s+t,g=s+(0===e&&1===h?0:t+1),p=S+i,n?(f[E+0]=l,f[E+1]=m,f[E+2]=m,f[E+3]=g,f[E+4]=g,f[E+5]=l,f[E+6]=g,f[E+7]=p,f[E+8]=p,f[E+9]=l,f[E+10]=l,f[E+11]=g,E+=12):(f[E+0]=l,f[E+1]=m,f[E+2]=g,f[E+3]=g,f[E+4]=p,f[E+5]=l,E+=6))}++S,e<o&&h<r&&(l=h*(o+1)+e,m=l+1,g=m+(o+1),p=g-1,n?(f[y+0]=l,f[y+1]=m,f[y+2]=m,f[y+3]=g,f[y+4]=g,f[y+5]=l,f[y+6]=g,f[y+7]=p,f[y+8]=p,f[y+9]=l,f[y+10]=l,f[y+11]=g,y+=12):(f[y+0]=l,f[y+1]=m,f[y+2]=g,f[y+3]=g,f[y+4]=p,f[y+5]=l,y+=6))}E-=d}return new h(f,c,u)}function A(e,t,n,o){e<o[0]&&(o[0]=e),e>o[3]&&(o[3]=e),t<o[1]&&(o[1]=t),t>o[4]&&(o[4]=t),n<o[2]&&(o[2]=n),n>o[5]&&(o[5]=n)}function M(e,t){const n=t>e?1:0;return 2+4*n+(1-2*n)*(e+t)}function R(e,t,n,o){return 0===t?e:e===n?n+t:t===o?n+o+(n-e):0===e&&t>0?2*n+o+(o-t):-1}function v(e,t,n,o){return 0===t&&e!==n?1:e===n&&t!==o?n+1:t===o&&0!==e?-1:0===e&&0!==t?-(n+1):0}function V(e,t,o,r,s,i,c,u,a,f){const m=i.position,g=i.uv0,p=e[0],h=e[1],S=e[2],y=t[0]-p,I=t[1]-h,E=t[2]-S;r*=3;for(let d=o*=3;d<r;d+=3){const e=s[d],t=s[d+1],o=s[d+2];let r=m.get(e,0),i=m.get(e,1),T=m.get(e,2),P=m.get(t,0),w=m.get(t,1),A=m.get(t,2),M=m.get(o,0),R=m.get(o,1),v=m.get(o,2);if(g.get(e,0)>=2){const e=r+u[0],t=i+u[1],n=T+u[2],o=c/Math.sqrt(e*e+t*t+n*n);r+=e*o,i+=t*o,T+=n*o}if(g.get(t,0)>=2){const e=P+u[0],t=w+u[1],n=A+u[2],o=c/Math.sqrt(e*e+t*t+n*n);P+=e*o,w+=t*o,A+=n*o}if(g.get(o,0)>=2){const e=M+u[0],t=R+u[1],n=v+u[2],o=c/Math.sqrt(e*e+t*t+n*n);M+=e*o,R+=t*o,v+=n*o}n.isSome(a)&&([r,i,T]=a.applyToVertex(r,i,T),[P,w,A]=a.applyToVertex(P,w,A),[M,R,v]=a.applyToVertex(M,R,v));const V=P-r,b=w-i,x=A-T,_=M-r,k=R-i,O=v-T,D=I*O-k*E,L=E*_-O*y,N=y*k-_*I,G=V*D+b*L+x*N;if(Math.abs(G)<=Number.EPSILON)continue;const X=p-r,C=h-i,q=S-T,H=X*D+C*L+q*N;if(G>0){if(H<0||H>G)continue}else if(H>0||H<G)continue;const U=C*x-b*q,Y=q*V-x*X,j=X*b-V*C,W=y*U+I*Y+E*j;if(G>0){if(W<0||H+W>G)continue}else if(W>0||H+W<G)continue;const z=(_*U+k*Y+O*j)/G;if(z>=0){f(z,l.computeNormal(V,b,x,_,k,O,B))}}}function b(e,t,o,r,s,i,c,u,a){const f=i.position,m=i.uv0,g=e[0],p=e[1],h=e[2],S=t[0]-g,y=t[1]-p,I=t[2]-h;r*=3;for(let E=o*=3;E<r;E+=3){const e=s[E],t=s[E+1],o=s[E+2];let r=f.get(e,0),i=f.get(e,1),d=f.get(e,2),T=f.get(t,0),P=f.get(t,1),w=f.get(t,2),A=f.get(o,0),M=f.get(o,1),R=f.get(o,2);m.get(e,0)>=2&&(d+=c);m.get(t,0)>=2&&(w+=c);m.get(o,0)>=2&&(R+=c),n.isSome(u)&&([r,i,d]=u.applyToVertex(r,i,d),[T,P,w]=u.applyToVertex(T,P,w),[A,M,R]=u.applyToVertex(A,M,R));const v=T-r,V=P-i,b=w-d,x=A-r,_=M-i,k=R-d,O=y*k-_*I,D=I*x-k*S,L=S*_-x*y,N=v*O+V*D+b*L;if(Math.abs(N)<=Number.EPSILON)continue;const G=g-r,X=p-i,C=h-d,q=G*O+X*D+C*L;if(N>0){if(q<0||q>N)continue}else if(q>0||q<N)continue;const H=X*b-V*C,U=C*v-b*G,Y=G*V-v*X,j=S*H+y*U+I*Y;if(N>0){if(j<0||q+j>N)continue}else if(j>0||q+j<N)continue;const W=(x*H+_*U+k*Y)/N;if(W>=0){a(W,l.computeNormal(v,V,b,x,_,k,B))}}}const x=new Array(f.MAX_PATCH_TESSELATION+1),_=new Array(f.MAX_PATCH_TESSELATION+1),k=new Array(f.MAX_PATCH_TESSELATION+1),O=new Array(f.MAX_PATCH_TESSELATION+1),B=o.create();e.PatchGeometry=p,e.clearCaches=S,e.createPlanarGlobePatch=d,e.createSphericalGlobePatch=E,e.intersectSkirtsGlobal=V,e.intersectSkirtsLocal=b,e.releaseGeometry=y,Object.defineProperty(e,"__esModule",{value:!0})}));
