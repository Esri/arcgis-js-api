// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../core/mathUtils","../../../core/maybe","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../../../core/libs/gl-matrix-2/vec4","../../../geometry/support/aaBoundingBox","../support/earthUtils","../support/buffer/BufferPool","../support/buffer/InterleavedLayout","./ElevationData","./TerrainConst","../webgl-engine/lib/Util","../webgl-engine/materials/internal/MaterialUtil"],(function(e,r,t,a,n,o,i,u,s,f,c,v,m,l,g){Object.defineProperty(r,"__esModule",{value:!0});var p=c.newLayout().vec3f(l.VertexAttrConstants.POSITION).vec2f(l.VertexAttrConstants.UV0),y=new f.BufferPool((function(e){return p.createBuffer(e)}),(function(e){return e.count}));r.clearCaches=function(){y.clear(),E.clear()},r.releaseGeometry=function(e){y.release(e.vertexAttributes),e.vertexAttributes=null,e.indices=null};r.createSphericalGlobePatch=function(e,r,a,n,o,f,c){var l=o[0],g=o[1],p=o[2],E=o[3],w=.1*s.earthRadius*(E-g),A=e.numVertsPerRow-1,M=e.numVertsPerRow-1,b=e.numVertsPerRow*e.numVertsPerRow,x=2*A+2*M,_=y.acquire(b+x),O=_.position.typedBuffer,B=_.uv0.typedBuffer,D=n.geometryInfo.boundingBox;u.empty(D);for(var C=r[2]-r[0],L=r[3]-r[1],X=p-l,k=a[0],G=a[1],U=a[2],N=0;N<=A;N++){var H=l+(Z=N/A)*X;P[N]=Math.sin(H),S[N]=Math.cos(H),h[N]=Z,V[N]=r[0]+Z*C}for(var Y=f&&!!(1&c),q=f&&!!(2&c),j=0,W=0;W<=M;W++){var z=W/M,F=t.lerp(g,E,z),J=Math.cos(F),K=Math.sin(F),Q=void 0;f?z=((Q=s.halfEarthRadius*Math.log((1+K)/(1-K)))-r[1])/L:Q=180*F/Math.PI;for(N=0;N<=A;N++){var Z=h[N],$=P[N],ee=S[N],re=s.earthRadius;e.samplerData&&(re+=v.ElevationData.sample(V[N],Q,e.samplerData)||0);var te=ee*J*re-k,ae=$*J*re-G,ne=K*re-U;R(te,ae,ne,D);var oe=m.GEOMETRY_VERTEX_STRIDE*j;O[oe+0]=te,O[oe+1]=ae,O[oe+2]=ne,B[oe+0]=Z,B[oe+1]=z;var ie=d(N,W,A,M);if(ie>-1){var ue=m.GEOMETRY_VERTEX_STRIDE*(b+ie),se=Y&&0===W?-1:q&&W===M?1:0,fe=0===se?te:-k,ce=0===se?ae:-G,ve=0===se?ne:s.earthRadius*se-U;O[ue+0]=fe,O[ue+1]=ce,O[ue+2]=ve,B[ue+0]=0===se?T(Z,z):Z,B[ue+1]=0===se?w:z,0!==se&&R(fe,ce,ve,D)}++j}}n.geometryInfo.numVertsPerRow=e.numVertsPerRow,n.geometryInfo.vertexAttributes=_,n.geometryInfo.skirtLength=w,i.vec4.set(n.geometryInfo.uvOffsetAndScale,0,0,1,1),I(n.geometryInfo,e.numVertsPerRow,f?c:0,e.wireframe)},r.createPlanarGlobePatch=function(e,r,t,a){var n=r[0],o=r[1],s=r[2]-n,f=r[3]-o,c=e.clippingArea,l=c?Math.max(0,(c[0]-r[0])/s):0,g=c?Math.max(0,(c[1]-r[1])/f):0,p=c?Math.min(1,(c[2]-r[0])/s):1,E=c?Math.min(1,(c[3]-r[1])/f):1,w=p>l?1/(p-l):1,A=E>g?1/(E-g):1,P=-l*w,S=-g*A,h=.1*s,V=e.numVertsPerRow-1,M=e.numVertsPerRow-1,b=e.numVertsPerRow*e.numVertsPerRow,x=2*V+2*M,_=y.acquire(b+x),O=_.position.typedBuffer,B=_.uv0.typedBuffer,D=a.geometryInfo.boundingBox;u.empty(D);for(var C=0,L=0;L<=M;L++){var X=L/M,k=S+X*A,G=o+X*f;c&&(G<c[1]?(G=c[1],k=0):G>c[3]&&(G=c[3],k=1));for(var U=0;U<=V;U++){var N=U/V,H=P+N*w,Y=n+N*s;c&&(Y<c[0]?(Y=c[0],H=0):Y>c[2]&&(Y=c[2],H=1));var q=e.samplerData&&v.ElevationData.sample(Y,G,e.samplerData)||0,j=Y-t[0],W=G-t[1],z=q-t[2];R(j,W,z,D);var F=m.GEOMETRY_VERTEX_STRIDE*C;O[F+0]=j,O[F+1]=W,O[F+2]=z,B[F+0]=H,B[F+1]=k;var J=d(U,L,V,V);if(J>-1){var K=m.GEOMETRY_VERTEX_STRIDE*(b+J);O[K+0]=j,O[K+1]=W,O[K+2]=z,B[K+0]=T(H,k),B[K+1]=h}++C}}a.geometryInfo.numVertsPerRow=e.numVertsPerRow,a.geometryInfo.vertexAttributes=_,a.geometryInfo.skirtLength=h,i.vec4.set(a.geometryInfo.uvOffsetAndScale,l,g,p-l,E-g),I(a.geometryInfo,e.numVertsPerRow,0,e.wireframe)};var E=new Map;function I(e,r,t,a){var n=(2&t)>0,o=r+(a?1024:0)+(n?2048:0),i=E.get(o);i||(i=function(e,r,t){var a=e-1,n=e-1,o=e*e,i=2*a+2*n,u=a*n*2*3,s=6*i,f=6*(2*a+n-1);t&&(u*=2,s*=2,f*=2);for(var c,v,m,l,g=o+i>65536?new Uint32Array(u+s):new Uint16Array(u+s),p=0,y=0,E=u,I=0,R=0;R<=n;R++){r&&(I=0===R?f:R===n?-f:0),E+=I;for(var T=0;T<=a;T++){var A=d(T,R,a,n);if(A>-1){var P=w(T,R,a,n);0!==P&&(c=p,v=o+A,m=o+(0===T&&1===R?0:A+1),l=p+P,t?(g[E+0]=c,g[E+1]=v,g[E+2]=v,g[E+3]=m,g[E+4]=m,g[E+5]=c,g[E+6]=m,g[E+7]=l,g[E+8]=l,g[E+9]=c,g[E+10]=c,g[E+11]=m,E+=12):(g[E+0]=c,g[E+1]=v,g[E+2]=m,g[E+3]=m,g[E+4]=l,g[E+5]=c,E+=6))}++p,T<a&&R<n&&(l=(m=(v=(c=R*(a+1)+T)+1)+(a+1))-1,t?(g[y+0]=c,g[y+1]=v,g[y+2]=v,g[y+3]=m,g[y+4]=m,g[y+5]=c,g[y+6]=m,g[y+7]=l,g[y+8]=l,g[y+9]=c,g[y+10]=c,g[y+11]=m,y+=12):(g[y+0]=c,g[y+1]=v,g[y+2]=m,g[y+3]=m,g[y+4]=l,g[y+5]=c,y+=6))}E-=I}return{values:g,numSurfaceIndices:u,numSkirtIndices:s}}(r,n,a),E.set(o,i)),e.indices=i.values,e.numSurfaceIndices=i.numSurfaceIndices,e.numSkirtIndices=i.numSkirtIndices,e.numWithoutSkirtIndices=e.numSurfaceIndices+(t?6*(r-1)*(a?2:1):0)}function R(e,r,t,a){e<a[0]&&(a[0]=e),e>a[3]&&(a[3]=e),r<a[1]&&(a[1]=r),r>a[4]&&(a[4]=r),t<a[2]&&(a[2]=t),t>a[5]&&(a[5]=t)}function T(e,r){var t=r>e?1:0;return 2+4*t+(1-2*t)*(e+r)}function d(e,r,t,a){return 0===r?e:e===t?t+r:r===a?t+a+(t-e):0===e&&r>0?2*t+a+(a-r):-1}function w(e,r,t,a){return 0===r&&e!==t?1:e===t&&r!==a?t+1:r===a&&0!==e?-1:0===e&&0!==r?-(t+1):0}var A=Math.pow(2,-52);r.intersectSkirts=function(e,r,t,o,i,u,s,f,c){var v,m,l,p=u.position,y=u.uv0,E=e[0],I=e[1],R=e[2],T=r[0]-E,d=r[1]-I,w=r[2]-R;o*=3;for(var P=t*=3;P<o;P+=3){var S=i[P],h=i[P+1],V=i[P+2],x=p.get(S,0),_=p.get(S,1),O=p.get(S,2),B=p.get(h,0),D=p.get(h,1),C=p.get(h,2),L=p.get(V,0),X=p.get(V,1),k=p.get(V,2),G=y.get(S,0),U=y.get(h,0),N=y.get(V,0);G>=2&&(n.vec3.set(M,x,_,O),s(M),x+=M[0],_+=M[1],O+=M[2]),U>=2&&(n.vec3.set(M,B,D,C),s(M),B+=M[0],D+=M[1],C+=M[2]),N>=2&&(n.vec3.set(M,L,X,k),s(M),L+=M[0],X+=M[1],k+=M[2]),a.isSome(f)&&(x=(v=f.applyToVertex(x,_,O))[0],_=v[1],O=v[2],B=(m=f.applyToVertex(B,D,C))[0],D=m[1],C=m[2],L=(l=f.applyToVertex(L,X,k))[0],X=l[1],k=l[2]);var H=B-x,Y=D-_,q=C-O,j=L-x,W=X-_,z=k-O,F=d*z-W*w,J=w*j-z*T,K=T*W-j*d,Q=H*F+Y*J+q*K,Z=E-x,$=I-_,ee=R-O,re=$*q-Y*ee,te=ee*H-q*Z,ae=Z*Y-H*$;if(Q>A){if((ne=Z*F+$*J+ee*K)<0||ne>Q)continue;if((oe=T*re+d*te+w*ae)<0||ne+oe>Q)continue}else{if(!(Q<-A))continue;var ne,oe;if((ne=Z*F+$*J+ee*K)>0||ne<Q)continue;if((oe=T*re+d*te+w*ae)>0||ne+oe<Q)continue}var ie=(j*re+W*te+z*ae)/Q;if(ie>=0)c(ie,g.computeNormal(H,Y,q,j,W,z,b))}};var P=new Array(m.MAX_PATCH_TESSELATION+1),S=new Array(m.MAX_PATCH_TESSELATION+1),h=new Array(m.MAX_PATCH_TESSELATION+1),V=new Array(m.MAX_PATCH_TESSELATION+1),M=o.vec3f64.create(),b=o.vec3f64.create()}));