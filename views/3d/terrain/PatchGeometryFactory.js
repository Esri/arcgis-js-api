/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../core/maybe","../../../core/mathUtils","../../../chunks/vec3f64","../../../chunks/vec3","../../../chunks/vec4f64","../../../chunks/vec4","../../../geometry/support/aaBoundingBox","./TerrainConst","../support/buffer/InterleavedLayout","../webgl-engine/materials/internal/MaterialUtil","./ElevationData","../support/buffer/BufferPool"],(function(e,t,n,o,r,s,i,c,u,a,f,l,m){"use strict";const h=a.newLayout().vec3f("position").vec2f("uv0"),g=new m.BufferPool((e=>h.createBuffer(e)),(e=>e.count));let p=function(){this.indices=null,this.vertexAttributes=null,this.boundingBox=c.empty(),this.numSurfaceIndices=0,this.numSkirtIndices=0,this.numWithoutSkirtIndices=0,this.numVertsPerRow=0,this.skirtLength=0,this.uvOffsetAndScale=s.create()},S=function(e,t,n){this.values=e,this.numSurfaceIndices=t,this.numSkirtIndices=n};function y(){g.clear(),A.clear()}function I(e){g.release(e.vertexAttributes),e.vertexAttributes=null,e.indices=null}const d=65536;function E(e,t,o,r,s,a,f,m){const h=s[0],p=s[1],S=s[2],y=s[3],I=.1*f.radius*(y-p),d=e.numVertsPerRow-1,E=e.numVertsPerRow-1,w=e.numVertsPerRow*e.numVertsPerRow,A=2*d+2*E,T=g.acquire(w+A),V=T.position.typedBuffer,_=T.uv0.typedBuffer,B=r.geometryInfo.boundingBox;c.empty(B);const D=t[2]-t[0],L=t[3]-t[1],G=S-h,X=o[0],N=o[1],C=o[2];for(let n=0;n<=d;n++){const e=n/d,o=h+e*G;b[n]=Math.sin(o),x[n]=Math.cos(o),k[n]=e,O[n]=t[0]+e*D}const H=a&&!!(1&m),U=a&&!!(2&m);let Y=0;for(let i=0;i<=E;i++){let o=i/E;const r=n.lerp(p,y,o),s=Math.cos(r),c=Math.sin(r);let m;a?(m=f.halfSemiMajorAxis*Math.log((1+c)/(1-c)),o=(m-t[1])/L):m=180*r/Math.PI;for(let t=0;t<=d;t++){const n=k[t],r=b[t],a=x[t];let h=f.radius;e.samplerData&&(h+=l.ElevationData.sample(O[t],m,e.samplerData)||0);const g=a*s*h-X,p=r*s*h-N,S=c*h-C;R(g,p,S,B);const y=u.GEOMETRY_VERTEX_STRIDE*Y;V[y+0]=g,V[y+1]=p,V[y+2]=S,_[y+0]=n,_[y+1]=o;const A=M(t,i,d,E);if(A>-1){const e=u.GEOMETRY_VERTEX_STRIDE*(w+A),t=H&&0===i?-1:U&&i===E?1:0,r=0===t?g:-X,s=0===t?p:-N,c=0===t?S:f.radius*t-C;V[e+0]=r,V[e+1]=s,V[e+2]=c,_[e+0]=0===t?v(n,o):n,_[e+1]=0===t?I:o,0!==t&&R(r,s,c,B)}++Y}}r.geometryInfo.numVertsPerRow=e.numVertsPerRow,r.geometryInfo.vertexAttributes=T,r.geometryInfo.skirtLength=I,i.set(r.geometryInfo.uvOffsetAndScale,0,0,1,1),P(r.geometryInfo,e.numVertsPerRow,a?m:0,e.wireframe)}function w(e,n,o,r){const s=n[0],a=n[1],f=n[2]-s,m=n[3]-a,h=e.clippingArea,p=t.isSome(h)?Math.max(0,(h[0]-n[0])/f):0,S=t.isSome(h)?Math.max(0,(h[1]-n[1])/m):0,y=t.isSome(h)?Math.min(1,(h[2]-n[0])/f):1,I=t.isSome(h)?Math.min(1,(h[3]-n[1])/m):1,d=y>p?1/(y-p):1,E=I>S?1/(I-S):1,w=-p*d,A=-S*E,T=.1*f,V=e.numVertsPerRow-1,_=e.numVertsPerRow-1,b=e.numVertsPerRow*e.numVertsPerRow,x=2*V+2*_,k=g.acquire(b+x),O=k.position.typedBuffer,B=k.uv0.typedBuffer,D=r.geometryInfo.boundingBox;c.empty(D);let L=0;for(let i=0;i<=_;i++){const n=i/_;let r=A+n*E,c=a+n*m;t.isSome(h)&&(c<h[1]?(c=h[1],r=0):c>h[3]&&(c=h[3],r=1));for(let a=0;a<=V;a++){const n=a/V;let m=w+n*d,g=s+n*f;t.isSome(h)&&(g<h[0]?(g=h[0],m=0):g>h[2]&&(g=h[2],m=1));const p=e.samplerData&&l.ElevationData.sample(g,c,e.samplerData)||0,S=g-o[0],y=c-o[1],I=p-o[2];R(S,y,I,D);const E=u.GEOMETRY_VERTEX_STRIDE*L;O[E+0]=S,O[E+1]=y,O[E+2]=I,B[E+0]=m,B[E+1]=r;const A=M(a,i,V,V);if(A>-1){const e=u.GEOMETRY_VERTEX_STRIDE*(b+A);O[e+0]=S,O[e+1]=y,O[e+2]=I,B[e+0]=v(m,r),B[e+1]=T}++L}}r.geometryInfo.numVertsPerRow=e.numVertsPerRow,r.geometryInfo.vertexAttributes=k,r.geometryInfo.skirtLength=T,i.set(r.geometryInfo.uvOffsetAndScale,p,S,y-p,I-S),P(r.geometryInfo,e.numVertsPerRow,0,e.wireframe)}const A=new Map;function P(e,t,n,o){const r=(2&n)>0,s=t+(o?1024:0)+(r?2048:0);let i=A.get(s);i||(i=T(t,r,o),A.set(s,i)),e.indices=i.values,e.numSurfaceIndices=i.numSurfaceIndices,e.numSkirtIndices=i.numSkirtIndices,e.numWithoutSkirtIndices=e.numSurfaceIndices+(n?6*(t-1)*(o?2:1):0)}function T(e,t,n){const o=e-1,r=e-1,s=e*e,i=2*o+2*r;let c=o*r*2*3,u=6*i,a=6*(2*o+r-1);n&&(c*=2,u*=2,a*=2);const f=s+i>d?new Uint32Array(c+u):new Uint16Array(c+u);let l,m,h,g,p=0,y=0,I=c,E=0;for(let S=0;S<=r;S++){t&&(E=0===S?a:S===r?-a:0),I+=E;for(let e=0;e<=o;e++){const t=M(e,S,o,r);if(t>-1){const i=V(e,S,o,r);0!==i&&(l=p,m=s+t,h=s+(0===e&&1===S?0:t+1),g=p+i,n?(f[I+0]=l,f[I+1]=m,f[I+2]=m,f[I+3]=h,f[I+4]=h,f[I+5]=l,f[I+6]=h,f[I+7]=g,f[I+8]=g,f[I+9]=l,f[I+10]=l,f[I+11]=h,I+=12):(f[I+0]=l,f[I+1]=m,f[I+2]=h,f[I+3]=h,f[I+4]=g,f[I+5]=l,I+=6))}++p,e<o&&S<r&&(l=S*(o+1)+e,m=l+1,h=m+(o+1),g=h-1,n?(f[y+0]=l,f[y+1]=m,f[y+2]=m,f[y+3]=h,f[y+4]=h,f[y+5]=l,f[y+6]=h,f[y+7]=g,f[y+8]=g,f[y+9]=l,f[y+10]=l,f[y+11]=h,y+=12):(f[y+0]=l,f[y+1]=m,f[y+2]=h,f[y+3]=h,f[y+4]=g,f[y+5]=l,y+=6))}I-=E}return new S(f,c,u)}function R(e,t,n,o){e<o[0]&&(o[0]=e),e>o[3]&&(o[3]=e),t<o[1]&&(o[1]=t),t>o[4]&&(o[4]=t),n<o[2]&&(o[2]=n),n>o[5]&&(o[5]=n)}function v(e,t){const n=t>e?1:0;return 2+4*n+(1-2*n)*(e+t)}function M(e,t,n,o){return 0===t?e:e===n?n+t:t===o?n+o+(n-e):0===e&&t>0?2*n+o+(o-t):-1}function V(e,t,n,o){return 0===t&&e!==n?1:e===n&&t!==o?n+1:t===o&&0!==e?-1:0===e&&0!==t?-(n+1):0}function _(e,n,o,s,i,c,u,a,l){const m=c.position,h=c.uv0,g=e[0],p=e[1],S=e[2],y=n[0]-g,I=n[1]-p,d=n[2]-S;s*=3;for(let E=o*=3;E<s;E+=3){const e=i[E],n=i[E+1],o=i[E+2];let s=m.get(e,0),c=m.get(e,1),w=m.get(e,2),A=m.get(n,0),P=m.get(n,1),T=m.get(n,2),R=m.get(o,0),v=m.get(o,1),M=m.get(o,2);h.get(e,0)>=2&&(r.set(B,s,c,w),u(B),s+=B[0],c+=B[1],w+=B[2]);h.get(n,0)>=2&&(r.set(B,A,P,T),u(B),A+=B[0],P+=B[1],T+=B[2]);h.get(o,0)>=2&&(r.set(B,R,v,M),u(B),R+=B[0],v+=B[1],M+=B[2]),t.isSome(a)&&([s,c,w]=a.applyToVertex(s,c,w),[A,P,T]=a.applyToVertex(A,P,T),[R,v,M]=a.applyToVertex(R,v,M));const V=A-s,_=P-c,b=T-w,x=R-s,k=v-c,O=M-w,L=I*O-k*d,G=d*x-O*y,X=y*k-x*I,N=V*L+_*G+b*X;if(Math.abs(N)<=Number.EPSILON)continue;const C=g-s,H=p-c,U=S-w,Y=C*L+H*G+U*X;if(N>0){if(Y<0||Y>N)continue}else if(Y>0||Y<N)continue;const j=H*b-_*U,q=U*V-b*C,W=C*_-V*H,z=y*j+I*q+d*W;if(N>0){if(z<0||Y+z>N)continue}else if(z>0||Y+z<N)continue;const F=(x*j+k*q+O*W)/N;if(F>=0){l(F,f.computeNormal(V,_,b,x,k,O,D))}}}const b=new Array(u.MAX_PATCH_TESSELATION+1),x=new Array(u.MAX_PATCH_TESSELATION+1),k=new Array(u.MAX_PATCH_TESSELATION+1),O=new Array(u.MAX_PATCH_TESSELATION+1),B=o.create(),D=o.create();e.PatchGeometry=p,e.clearCaches=y,e.createPlanarGlobePatch=w,e.createSphericalGlobePatch=E,e.intersectSkirts=_,e.releaseGeometry=I,Object.defineProperty(e,"__esModule",{value:!0})}));
