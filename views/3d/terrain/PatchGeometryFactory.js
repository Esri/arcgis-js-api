// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","../../../core/mathUtils","../../../core/maybe","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../../../core/libs/gl-matrix-2/vec4","../../../core/libs/gl-matrix-2/vec4f64","../../../geometry/support/aaBoundingBox","../../../geometry/support/geodesicConstants","../support/buffer/BufferPool","../support/buffer/InterleavedLayout","./ElevationData","./TerrainConst","../webgl-engine/lib/Util","../webgl-engine/materials/internal/MaterialUtil"],(function(e,t,r,n,a,i,o,s,u,c,f,v,m,l,g,h){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.intersectSkirts=t.createPlanarGlobePatch=t.createSphericalGlobePatch=t.releaseGeometry=t.clearCaches=t.PatchGeometry=void 0;var p=v.newLayout().vec3f(g.VertexAttrConstants.POSITION).vec2f(g.VertexAttrConstants.UV0),y=new f.BufferPool((function(e){return p.createBuffer(e)}),(function(e){return e.count})),d=function(){this.indices=null,this.vertexAttributes=null,this.boundingBox=u.empty(),this.numSurfaceIndices=0,this.numSkirtIndices=0,this.numWithoutSkirtIndices=0,this.numVertsPerRow=0,this.skirtLength=0,this.uvOffsetAndScale=s.vec4f64.create()};t.PatchGeometry=d;var I=function(e,t,r){this.values=e,this.numSurfaceIndices=t,this.numSkirtIndices=r};t.clearCaches=function(){y.clear(),E.clear()},t.releaseGeometry=function(e){y.release(e.vertexAttributes),e.vertexAttributes=null,e.indices=null};t.createSphericalGlobePatch=function(e,t,n,a,i,s,f){var v=i[0],g=i[1],h=i[2],p=i[3],d=.1*c.earthRadius*(p-g),I=e.numVertsPerRow-1,E=e.numVertsPerRow-1,A=e.numVertsPerRow*e.numVertsPerRow,T=2*I+2*E,_=y.acquire(A+T),O=_.position.typedBuffer,B=_.uv0.typedBuffer,G=a.geometryInfo.boundingBox;u.empty(G);for(var k=t[2]-t[0],D=t[3]-t[1],C=h-v,L=n[0],X=n[1],N=n[2],U=0;U<=I;U++){var H=v+(Z=U/I)*C;V[U]=Math.sin(H),b[U]=Math.cos(H),M[U]=Z,x[U]=t[0]+Z*k}for(var Y=s&&!!(1&f),q=s&&!!(2&f),W=0,j=0;j<=E;j++){var z=j/E,F=r.lerp(g,p,z),J=Math.cos(F),K=Math.sin(F),Q=void 0;s?z=((Q=c.halfEarthRadius*Math.log((1+K)/(1-K)))-t[1])/D:Q=180*F/Math.PI;for(U=0;U<=I;U++){var Z=M[U],$=V[U],ee=b[U],te=c.earthRadius;e.samplerData&&(te+=m.ElevationData.sample(x[U],Q,e.samplerData)||0);var re=ee*J*te-L,ne=$*J*te-X,ae=K*te-N;S(re,ne,ae,G);var ie=l.GEOMETRY_VERTEX_STRIDE*W;O[ie+0]=re,O[ie+1]=ne,O[ie+2]=ae,B[ie+0]=Z,B[ie+1]=z;var oe=w(U,j,I,E);if(oe>-1){var se=l.GEOMETRY_VERTEX_STRIDE*(A+oe),ue=Y&&0===j?-1:q&&j===E?1:0,ce=0===ue?re:-L,fe=0===ue?ne:-X,ve=0===ue?ae:c.earthRadius*ue-N;O[se+0]=ce,O[se+1]=fe,O[se+2]=ve,B[se+0]=0===ue?R(Z,z):Z,B[se+1]=0===ue?d:z,0!==ue&&S(ce,fe,ve,G)}++W}}a.geometryInfo.numVertsPerRow=e.numVertsPerRow,a.geometryInfo.vertexAttributes=_,a.geometryInfo.skirtLength=d,o.vec4.set(a.geometryInfo.uvOffsetAndScale,0,0,1,1),P(a.geometryInfo,e.numVertsPerRow,s?f:0,e.wireframe)},t.createPlanarGlobePatch=function(e,t,r,n){var a=t[0],i=t[1],s=t[2]-a,c=t[3]-i,f=e.clippingArea,v=f?Math.max(0,(f[0]-t[0])/s):0,g=f?Math.max(0,(f[1]-t[1])/c):0,h=f?Math.min(1,(f[2]-t[0])/s):1,p=f?Math.min(1,(f[3]-t[1])/c):1,d=h>v?1/(h-v):1,I=p>g?1/(p-g):1,E=-v*d,A=-g*I,T=.1*s,V=e.numVertsPerRow-1,b=e.numVertsPerRow-1,M=e.numVertsPerRow*e.numVertsPerRow,x=2*V+2*b,_=y.acquire(M+x),O=_.position.typedBuffer,B=_.uv0.typedBuffer,G=n.geometryInfo.boundingBox;u.empty(G);for(var k=0,D=0;D<=b;D++){var C=D/b,L=A+C*I,X=i+C*c;f&&(X<f[1]?(X=f[1],L=0):X>f[3]&&(X=f[3],L=1));for(var N=0;N<=V;N++){var U=N/V,H=E+U*d,Y=a+U*s;f&&(Y<f[0]?(Y=f[0],H=0):Y>f[2]&&(Y=f[2],H=1));var q=e.samplerData&&m.ElevationData.sample(Y,X,e.samplerData)||0,W=Y-r[0],j=X-r[1],z=q-r[2];S(W,j,z,G);var F=l.GEOMETRY_VERTEX_STRIDE*k;O[F+0]=W,O[F+1]=j,O[F+2]=z,B[F+0]=H,B[F+1]=L;var J=w(N,D,V,V);if(J>-1){var K=l.GEOMETRY_VERTEX_STRIDE*(M+J);O[K+0]=W,O[K+1]=j,O[K+2]=z,B[K+0]=R(H,L),B[K+1]=T}++k}}n.geometryInfo.numVertsPerRow=e.numVertsPerRow,n.geometryInfo.vertexAttributes=_,n.geometryInfo.skirtLength=T,o.vec4.set(n.geometryInfo.uvOffsetAndScale,v,g,h-v,p-g),P(n.geometryInfo,e.numVertsPerRow,0,e.wireframe)};var E=new Map;function P(e,t,r,n){var a=(2&r)>0,i=t+(n?1024:0)+(a?2048:0),o=E.get(i);o||(o=function(e,t,r){var n=e-1,a=e-1,i=e*e,o=2*n+2*a,s=n*a*2*3,u=6*o,c=6*(2*n+a-1);r&&(s*=2,u*=2,c*=2);for(var f,v,m,l,g=i+o>65536?new Uint32Array(s+u):new Uint16Array(s+u),h=0,p=0,y=s,d=0,E=0;E<=a;E++){t&&(d=0===E?c:E===a?-c:0),y+=d;for(var P=0;P<=n;P++){var S=w(P,E,n,a);if(S>-1){var R=A(P,E,n,a);0!==R&&(f=h,v=i+S,m=i+(0===P&&1===E?0:S+1),l=h+R,r?(g[y+0]=f,g[y+1]=v,g[y+2]=v,g[y+3]=m,g[y+4]=m,g[y+5]=f,g[y+6]=m,g[y+7]=l,g[y+8]=l,g[y+9]=f,g[y+10]=f,g[y+11]=m,y+=12):(g[y+0]=f,g[y+1]=v,g[y+2]=m,g[y+3]=m,g[y+4]=l,g[y+5]=f,y+=6))}++h,P<n&&E<a&&(l=(m=(v=(f=E*(n+1)+P)+1)+(n+1))-1,r?(g[p+0]=f,g[p+1]=v,g[p+2]=v,g[p+3]=m,g[p+4]=m,g[p+5]=f,g[p+6]=m,g[p+7]=l,g[p+8]=l,g[p+9]=f,g[p+10]=f,g[p+11]=m,p+=12):(g[p+0]=f,g[p+1]=v,g[p+2]=m,g[p+3]=m,g[p+4]=l,g[p+5]=f,p+=6))}y-=d}return new I(g,s,u)}(t,a,n),E.set(i,o)),e.indices=o.values,e.numSurfaceIndices=o.numSurfaceIndices,e.numSkirtIndices=o.numSkirtIndices,e.numWithoutSkirtIndices=e.numSurfaceIndices+(r?6*(t-1)*(n?2:1):0)}function S(e,t,r,n){e<n[0]&&(n[0]=e),e>n[3]&&(n[3]=e),t<n[1]&&(n[1]=t),t>n[4]&&(n[4]=t),r<n[2]&&(n[2]=r),r>n[5]&&(n[5]=r)}function R(e,t){var r=t>e?1:0;return 2+4*r+(1-2*r)*(e+t)}function w(e,t,r,n){return 0===t?e:e===r?r+t:t===n?r+n+(r-e):0===e&&t>0?2*r+n+(n-t):-1}function A(e,t,r,n){return 0===t&&e!==r?1:e===r&&t!==n?r+1:t===n&&0!==e?-1:0===e&&0!==t?-(r+1):0}var T=Math.pow(2,-52);t.intersectSkirts=function(e,t,r,i,o,s,u,c,f){var v,m,l,g=s.position,p=s.uv0,y=e[0],d=e[1],I=e[2],E=t[0]-y,P=t[1]-d,S=t[2]-I;i*=3;for(var R=r*=3;R<i;R+=3){var w=o[R],A=o[R+1],V=o[R+2],b=g.get(w,0),M=g.get(w,1),x=g.get(w,2),B=g.get(A,0),G=g.get(A,1),k=g.get(A,2),D=g.get(V,0),C=g.get(V,1),L=g.get(V,2),X=p.get(w,0),N=p.get(A,0),U=p.get(V,0);X>=2&&(a.vec3.set(_,b,M,x),u(_),b+=_[0],M+=_[1],x+=_[2]),N>=2&&(a.vec3.set(_,B,G,k),u(_),B+=_[0],G+=_[1],k+=_[2]),U>=2&&(a.vec3.set(_,D,C,L),u(_),D+=_[0],C+=_[1],L+=_[2]),n.isSome(c)&&(b=(v=c.applyToVertex(b,M,x))[0],M=v[1],x=v[2],B=(m=c.applyToVertex(B,G,k))[0],G=m[1],k=m[2],D=(l=c.applyToVertex(D,C,L))[0],C=l[1],L=l[2]);var H=B-b,Y=G-M,q=k-x,W=D-b,j=C-M,z=L-x,F=P*z-j*S,J=S*W-z*E,K=E*j-W*P,Q=H*F+Y*J+q*K,Z=y-b,$=d-M,ee=I-x,te=$*q-Y*ee,re=ee*H-q*Z,ne=Z*Y-H*$;if(Q>T){if((ae=Z*F+$*J+ee*K)<0||ae>Q)continue;if((ie=E*te+P*re+S*ne)<0||ae+ie>Q)continue}else{if(!(Q<-T))continue;var ae,ie;if((ae=Z*F+$*J+ee*K)>0||ae<Q)continue;if((ie=E*te+P*re+S*ne)>0||ae+ie<Q)continue}var oe=(W*te+j*re+z*ne)/Q;if(oe>=0)f(oe,h.computeNormal(H,Y,q,W,j,z,O))}};var V=new Array(l.MAX_PATCH_TESSELATION+1),b=new Array(l.MAX_PATCH_TESSELATION+1),M=new Array(l.MAX_PATCH_TESSELATION+1),x=new Array(l.MAX_PATCH_TESSELATION+1),_=i.vec3f64.create(),O=i.vec3f64.create()}));