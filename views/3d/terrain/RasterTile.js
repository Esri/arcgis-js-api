// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","../../../core/maybe","../../webgl/rasterUtils"],(function(t,e,r,s){Object.defineProperty(e,"__esModule",{value:!0});var i={bandCount:3,outMin:0,outMax:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,type:"stretch"},o=function(){function t(t,e,r,s){void 0===r&&(r=null),void 0===s&&(s=null),this._memoryUsed=null,this._source=null,this._symbolizerParameters=null,this._bandIds=null,this._interpolation=null,this._dirty=!1,this._transformGrid=null,this.symbolizerRenderer=null,this.rawPixelData=null,this.lij=null,this.scale=1,this.offset=[0,0],this.opacity=1,this.lij=t,this.source=e,this.width=r||e.width,this.height=s||e.height}return Object.defineProperty(t.prototype,"source",{get:function(){return this._source},set:function(t){this._source=t,this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTexture=null,this._memoryUsed=null)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"symbolizerParameters",{get:function(){return this._symbolizerParameters||i},set:function(t){this._symbolizerParameters=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"bandIds",{get:function(){return this._bandIds},set:function(t){var e=this;r.isSome(t)&&t.length>0?this._bandIds&&t.every((function(t,r){return!!e._bandIds[r]&&t===e._bandIds[r]}))||(this._bandIds=t,this._dirty=!0):this._bandIds=null},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"interpolation",{get:function(){return this._interpolation},set:function(t){this._interpolation=t,this._rasterTexture&&this._rasterTexture.setSamplingMode("bilinear"===t?9729:9728)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"transformGrid",{get:function(){return this._transformGrid},set:function(t){this._transformGrid=t,this._transformGridTexture&&(this._transformGridTexture.dispose(),this._transformGridTexture=null,this._memoryUsed=null)},enumerable:!0,configurable:!0}),t.prototype.bind=function(t){return!!(this.source&&this.source.pixels&&this.source.pixels.length>0)&&(this._rasterTexture&&!this._dirty||this._updateRasterTexture(t,this.bandIds),this._rasterTexture&&(this._updateColormapTexture(t),this.transformGrid&&!this._transformGridTexture&&(this._transformGridTexture=s.createTransformTexture(t,this.transformGrid))),!0)},t.prototype.getUniforms=function(){var t=s.getBasicGridUniforms(this.scale,this.offset),e=this,r=e.symbolizerParameters,i=e.transformGrid,o=e.width,n=e.height,u=e.opacity;return{basic:t,common:s.getCommonUniforms(i,[o,n],[this.source.width,this.source.height],u),colormap:r.colormap?s.getColormapUniforms(r.colormap,r.colormapOffset):null,stretch:"stretch"===this.symbolizerParameters.type?s.getStretchUniforms(this.symbolizerParameters):null,hillshade:"hillshade"===this.symbolizerParameters.type?s.getShadedReliefUniforms(this.symbolizerParameters):null}},t.prototype.getTextures=function(){if(!this._rasterTexture)return null;var t=[],e=[];return this._transformGridTexture&&(e.push(this._transformGridTexture),t.push("u_transformGrid")),this._rasterTexture&&(e.push(this._rasterTexture),t.push("u_image")),this._colormapTexture&&(e.push(this._colormapTexture),t.push("u_colormap")),{names:t,textures:e}},t.prototype.getMemoryUsage=function(){if(r.isNone(this._memoryUsed)){var t=this.getTextures();if(null==t)return 0;this._memoryUsed=t.textures.map((function(t){return t.descriptor.width*t.descriptor.height*4})).reduce((function(t,e){return t+e}))}return this._memoryUsed},t.prototype.release=function(){return this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTexture=null),this._transformGridTexture&&(this._transformGridTexture.dispose(),this._transformGridTexture=null),this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),this.source=null,this.transformGrid=null,this.rawPixelData=null,!0},t.prototype._updateRasterTexture=function(t,e){var i=this.source?this.source.extractBands(e):null;if(i&&i.pixels&&i.pixels.length>0){var o=r.isNone(e)&&r.isNone(this.bandIds)||r.isSome(e)&&r.isSome(this.bandIds)&&e.join("")===this.bandIds.join("");if(this._rasterTexture){if(o)return;this._rasterTexture.dispose(),this._rasterTexture=null}this._rasterTexture=s.createRasterTexture(t,i,this.interpolation||"nearest")}else this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTexture=null)},t.prototype._updateColormapTexture=function(t){var e=this._colormap,r=this.symbolizerParameters.colormap;return r?e?r.length!==e.length||r.some((function(t,r){return t!==e[r]}))?(this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),this._colormapTexture=s.createColormapTexture(t,r),void(this._colormap=r)):void 0:(this._colormapTexture=s.createColormapTexture(t,r),void(this._colormap=r)):(this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),void(this._colormap=null))},t}();e.default=o}));