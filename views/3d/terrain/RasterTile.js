/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/maybe","../../webgl/enums","../../webgl/rasterUtils"],(function(e,t,r,s,i){"use strict";const o={bandCount:3,outMin:0,outMax:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:"none",type:"stretch"};let n=function(){function e(e,t,r=null,s=null){this.type="raster-tile",this._memoryUsed=null,this._source=null,this._symbolizerParameters=null,this._bandIds=null,this._interpolation=null,this._dirty=!1,this._transformGrid=null,this.isRendereredSource=!1,this.symbolizerRenderer=null,this.rawPixelData=null,this.lij=null,this.scale=1,this.offset=[0,0],this.opacity=1,this.lij=e,this.source=t,this.width=r||t.width,this.height=s||t.height}var n=e.prototype;return n.bind=function(e){return!!(this.source&&this.source.pixels&&this.source.pixels.length>0)&&(this._rasterTexture&&!this._dirty||this._updateRasterTexture(e,this.bandIds),this._rasterTexture&&(this._updateColormapTexture(e),this.transformGrid&&!this._transformGridTexture&&(this._transformGridTexture=i.createTransformTexture(e,this.transformGrid))),!0)},n.getUniforms=function(){const e=i.getBasicGridUniforms(this.scale,this.offset),{symbolizerParameters:t,transformGrid:r,width:s,height:o,opacity:n}=this;return{basic:e,common:i.getCommonUniforms(r,[s,o],[this.source.width,this.source.height],n),colormap:t.colormap?i.getColormapUniforms(t.colormap,t.colormapOffset):null,stretch:"stretch"===this.symbolizerParameters.type?i.getStretchUniforms(this.symbolizerParameters):null,hillshade:"hillshade"===this.symbolizerParameters.type?i.getShadedReliefUniforms(this.symbolizerParameters):null}},n.getTextures=function(){const e=new Array,t=[];return this._rasterTexture&&(t.push(this._rasterTexture),e.push("u_image"),this._transformGridTexture&&(t.push(this._transformGridTexture),e.push("u_transformGrid")),this._colormapTexture&&(t.push(this._colormapTexture),e.push("u_colormap"))),{names:e,textures:t}},n.release=function(){return this._rasterTexture=r.disposeMaybe(this._rasterTexture),this._transformGridTexture=r.disposeMaybe(this._transformGridTexture),this._colormapTexture=r.disposeMaybe(this._colormapTexture),this.source=null,this.transformGrid=null,this.rawPixelData=null,!0},n._updateRasterTexture=function(e,t){const s=this.source?this.source.extractBands(t):null;if(!(s&&s.pixels&&s.pixels.length>0))return void(this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTexture=null));const o=r.isNone(t)&&r.isNone(this.bandIds)||r.isSome(t)&&r.isSome(this.bandIds)&&t.join("")===this.bandIds.join("");if(this._rasterTexture){if(o)return;this._rasterTexture.dispose(),this._rasterTexture=null}const n=this._getRasterTextureInterpolation(this.interpolation);this._rasterTexture=i.createRasterTexture(e,s,n,this.isRendereredSource||this.hasStretchTypeNone())},n.hasStretchTypeNone=function(){return"stretchType"in this.symbolizerParameters&&"none"===this.symbolizerParameters.stretchType&&!this.symbolizerParameters.useGamma&&"u8"===this.source.pixelType},n._getRasterTextureInterpolation=function(e){return"lut"===this.symbolizerParameters.type||"nearest"===e||"majority"===e?"nearest":"bilinear"},n._updateColormapTexture=function(e){const t=this._colormap,r=this.symbolizerParameters.colormap;return r?t?r.length!==t.length||r.some(((e,r)=>e!==t[r]))?(this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),this._colormapTexture=i.createColormapTexture(e,r),void(this._colormap=r)):void 0:(this._colormapTexture=i.createColormapTexture(e,r),void(this._colormap=r)):(this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),void(this._colormap=null))},t._createClass(e,[{key:"source",get:function(){return this._source},set:function(e){this._source=e,this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTexture=null,this._memoryUsed=null)}},{key:"symbolizerParameters",get:function(){return this.isRendereredSource?{...o,maxCutOff:[1,1,1],factor:[1,1,1]}:this._symbolizerParameters||o},set:function(e){this._symbolizerParameters=e}},{key:"bandIds",get:function(){return this._bandIds},set:function(e){if(r.isSome(e)&&e.length>0){this._bandIds&&e.every(((e,t)=>!!this._bandIds[t]&&e===this._bandIds[t]))||(this._bandIds=e,this._dirty=!0)}else this._bandIds=null}},{key:"interpolation",get:function(){return this._interpolation||"nearest"},set:function(e){if(this._interpolation=e,this._rasterTexture){const t=this._getRasterTextureInterpolation(e);this._rasterTexture.setSamplingMode("bilinear"===t?s.TextureSamplingMode.LINEAR:s.TextureSamplingMode.NEAREST)}}},{key:"transformGrid",get:function(){return this._transformGrid},set:function(e){this._transformGrid=e,this._transformGridTexture&&(this._transformGridTexture.dispose(),this._transformGridTexture=null,this._memoryUsed=null)}},{key:"memoryUsage",get:function(){if(r.isNone(this._memoryUsed)){const e=this.getTextures();if(null==e)return 0;this._memoryUsed=e.textures.map((e=>e.descriptor.width*e.descriptor.height*4)).reduce(((e,t)=>e+t),0)}return this._memoryUsed}}]),e}();e.RasterTile=n,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
