/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/mathUtils","../../../chunks/vec3","../../../chunks/vec3f64","../../../geometry/projection","../../../geometry/projectionEllipsoid","../../../geometry/support/frustum","../../../geometry/support/plane","./PatchGeometryFactory","./Tile"],(function(e,t,i,s,n,r,o,a,l,h,c){"use strict";let d=function(e){function l(t,i,s){var r;(r=e.call(this)||this).obb=new Array(8),r.isWebMercator=!1;for(let e=0;e<8;e++)r.obb[e]=n.create();return void 0!==t&&r.init(t,i,s),r}t._inheritsLoose(l,e);var c=l.prototype;return c.init=function(t,o,a){e.prototype.init.call(this,t,o,a),this.isWebMercator=a.tilingScheme.spatialReference.isWebMercator;const l=this.ellipsoid.radius,h=this.extentInRadians[0],c=this.extentInRadians[1],d=this.extentInRadians[2],u=this.extentInRadians[3],p=t[0],f=i.lerp(c,u,.5),_=i.lerp(h,d,.5),b=0===p?0:Math.min(Math.abs(c),Math.abs(u));this._edgeLen=(d-h)*Math.cos(b)*l,this._edgeLen2=this._edgeLen*this._edgeLen,this._curvatureHeight=l-Math.sqrt(l*l-this._edgeLen2/4),r.lonLatToSphericalPCPF(this.centerAtSeaLevel,_,f,this.ellipsoid.radius,0);const P=n.fromArray(this.centerAtSeaLevel);s.normalize(P,P),this.up=P,this._updateOBB(),this.updateRadiusAndCenter()},c.updateRadiusAndCenter=function(){if(0===this.lij[0])s.set(this._center[1],0,0,0),s.set(this._center[0],0,0,0),s.set(this._center[2],0,0,0),this.ellipsoid||(this.ellipsoid=o.getReferenceEllipsoid(this.surface.spatialReference)),this._center[1][3]=this.ellipsoid.radius+this.elevationBounds[1];else{this._updateCenter();const e=Math.max(s.squaredDistance(this._center[1],this.obb[0]),s.squaredDistance(this._center[1],this.obb[1]));this._center[1][3]=Math.sqrt(e)}},c._isVisible=function(e){if(!a.intersectsSphere(e,this._center[1]))return!1;if(this.lij[0]<10)return!0;const t=this.obb;for(let i=0;i<6;i++){const s=4===i,n=e[i];s&&(p[0]=n[0],p[1]=n[1],p[2]=n[2],p[3]=n[3]-this.surface.view.state.camera.near);const r=s?p:n;let o;for(o=0;o<8;o++){const e=t[o];if(r[0]*e[0]+r[1]*e[1]+r[2]*e[2]+r[3]<0)break}if(8===o)return!1}return!0},c.computeElevationBounds=function(){e.prototype.computeElevationBounds.call(this),this._updateOBB()},c.createGeometry=function(e,t){const i=this._isPole(this.lij[1],this.lij[0]);h.createSphericalGlobePatch(e,this.extent,t,this.renderData,this.extentInRadians,this.isWebMercator,this.ellipsoid,i),this.setMemoryDirty()},c._updateOBB=function(){const e=this.extentInRadians,t=this.obb;for(let i=0;i<2;i++){const s=this.elevationBounds[i];let n=4*i;r.lonLatToSphericalPCPF(t[n++],e[0],e[1],this.ellipsoid.radius,s),r.lonLatToSphericalPCPF(t[n++],e[0],e[3],this.ellipsoid.radius,s),r.lonLatToSphericalPCPF(t[n++],e[2],e[3],this.ellipsoid.radius,s),r.lonLatToSphericalPCPF(t[n++],e[2],e[1],this.ellipsoid.radius,s)}if(this.isWebMercator){const e=this._isPole(this.lij[1],this.lij[0]);2===e?(s.set(t[1],0,0,this.ellipsoid.radius),s.set(t[2],0,0,this.ellipsoid.radius),s.set(t[5],0,0,this.ellipsoid.radius),s.set(t[6],0,0,this.ellipsoid.radius)):1===e&&(s.set(t[0],0,0,-this.ellipsoid.radius),s.set(t[3],0,0,-this.ellipsoid.radius),s.set(t[4],0,0,-this.ellipsoid.radius),s.set(t[7],0,0,-this.ellipsoid.radius))}},c._isPole=function(e,t){let i=0;return e===(1<<t)-1&&(i+=1),0===e&&(i+=2),i},c.intersectsRay=function(e,t,i,s,n){const r=this._center[1],o=r[3]+i+.2*this.ellipsoid.radius*Math.abs(n*(this.extentInRadians[3]-this.extentInRadians[1])),a=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],l=r[0]-e[0],h=r[1]-e[1],c=r[2]-e[2],d=(l*t[0]+h*t[1]+c*t[2])/a,u=t[0]*d-l,p=t[1]*d-h,f=t[2]*d-c;return u*u+p*p+f*f<o*o},c.getDefaultVerticesPerRowOnLevel=function(){return this.level<u.length?u[this.level]+1:2},l}(c.Tile);const u=[128,64,32,16,16,8,8,4],p=l.create();e.SphericalPatch=d,Object.defineProperty(e,"__esModule",{value:!0})}));
