/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/Error","../../../core/mathUtils","../../../core/maybe","../../../core/unitUtils","../../../geometry/Extent","../../../geometry/projection","../../../geometry/SpatialReference","../../../geometry/support/aaBoundingRect","../../../geometry/support/spatialReferenceUtils","../../../geometry/support/webMercatorUtils","../../../layers/support/TileInfo"],(function(e,t,i,n,s,o,l,r,a,c,u,h,f){"use strict";const g=12;let p=function(){function e(t){const i=e.checkUnsupported(t);if(s.isSome(i))throw i;const n=s.unwrap(t);this.spatialReference=n.spatialReference,this._isWebMercator=this.spatialReference.isWebMercator,this._isGCS=r.canProjectToWGS84ComparableLonLat(this.spatialReference)||u.isMars(this.spatialReference)||u.isMoon(this.spatialReference),this.origin=[n.origin.x,n.origin.y],this.pixelSize=n.size[0],this.dpi=n.dpi;const o=n.lods.reduce((function(e,t,i){return t.level<e.min&&(e.min=t.level,e.minIndex=i),e.max=Math.max(e.max,t.level),e}),{min:1/0,minIndex:0,max:-1/0}),l=n.lods[o.minIndex],a=2**l.level;let c=l.resolution*a,h=l.scale*a;this.levels=new Array(o.max+1);for(let e=0;e<this.levels.length;e++)this.levels[e]={resolution:c,scale:h,tileSize:[c*n.size[0],c*n.size[1]]},c/=2,h/=2}var a=e.prototype;return a.clone=function(){return new e(this.toTileInfo())},a.toTileInfo=function(){return new f({dpi:this.dpi,origin:{x:this.origin[0],y:this.origin[1],spatialReference:this.spatialReference},size:[this.pixelSize,this.pixelSize],spatialReference:this.spatialReference,lods:this.levels.map(((e,t)=>({level:t,scale:e.scale,resolution:e.resolution})))})},a.getExtent=function(e,t,i,n){const s=this.levels[e],o=s.tileSize[0],l=s.tileSize[1];n[0]=this.origin[0]+i*o,n[2]=n[0]+o,n[3]=this.origin[1]-t*l,n[1]=n[3]-l},a.convertExtentToRadians=function(e,t){this._isWebMercator?(t[0]=h.x2lon(e[0]),t[1]=h.y2lat(e[1]),t[2]=h.x2lon(e[2]),t[3]=h.y2lat(e[3])):this._isGCS&&(t[0]=n.deg2rad(e[0]),t[1]=n.deg2rad(e[1]),t[2]=n.deg2rad(e[2]),t[3]=n.deg2rad(e[3]))},a.getExtentGeometry=function(e,t,i,n=new l){return this.getExtent(e,t,i,x),n.spatialReference=this.spatialReference,n.xmin=x[0],n.ymin=x[1],n.xmax=x[2],n.ymax=x[3],n.zmin=void 0,n.zmax=void 0,n},a.ensureMaxLod=function(e){if(null==e)return!1;let t=!1;for(;this.levels.length<=e;){const e=this.levels[this.levels.length-1],i=e.resolution/2;this.levels.push({resolution:i,scale:e.scale/2,tileSize:[i*this.pixelSize,i*this.pixelSize]}),t=!0}return t},a.capMaxLod=function(e){this.levels.length>e+1&&(this.levels.length=e+1)},a.getMaxLod=function(){return this.levels.length-1},a.scaleAtLevel=function(e){return this.levels[0].scale/2**e},a.levelAtScale=function(e){const t=this.levels[0].scale;return e>=t?0:Math.log(t/e)*Math.LOG2E},a.resolutionAtLevel=function(e){return this.levels[0].resolution/2**e},a.compatibleWith=function(t){if(!(t instanceof e)){if(e.checkUnsupported(t))return!1;t=new e(t)}if(!t.spatialReference.equals(this.spatialReference))return!1;if(t.pixelSize!==this.pixelSize)return!1;const i=Math.min(this.levels.length,t.levels.length)-1,s=this.levels[i].resolution;let o=.5*s;if(!n.floatEqualAbsolute(t.origin[0],this.origin[0],o)||!n.floatEqualAbsolute(t.origin[1],this.origin[1],o))return!1;return o=.5*s/2**i/this.pixelSize*g,n.floatEqualAbsolute(s,t.levels[i].resolution,o)},a.rootTilesInExtent=function(t,i=null,n=1/0){const o=new Array,l=this.levels[0].tileSize;if(s.isNone(t)||0===l[0]||0===l[1])return o;e.computeRowColExtent(t,l,this.origin,x);let r=x[1],a=x[3],c=x[0],u=x[2];const h=u-c,f=a-r;if(h*f>n){const e=Math.floor(Math.sqrt(n));f>e&&(r=r+Math.floor(.5*f)-Math.floor(.5*e),a=r+e),h>e&&(c=c+Math.floor(.5*h)-Math.floor(.5*e),u=c+e)}for(let e=r;e<a;e++)for(let t=c;t<u;t++)o.push([0,e,t]);return s.isSome(i)&&(i[0]=this.origin[0]+c*l[0],i[1]=this.origin[1]-a*l[1],i[2]=this.origin[0]+u*l[0],i[3]=this.origin[1]-r*l[1]),o},e.computeRowColExtent=function(e,t,i,n){const s=.001*(e[2]-e[0]+(e[3]-e[1]));n[0]=Math.max(0,Math.floor((e[0]+s-i[0])/t[0])),n[2]=Math.max(0,Math.ceil((e[2]-s-i[0])/t[0])),n[1]=Math.max(0,Math.floor((i[1]-e[3]+s)/t[1])),n[3]=Math.max(0,Math.ceil((i[1]-e[1]-s)/t[1]))},e.isPowerOfTwo=function(e){const t=e.lods,i=t[0].resolution*2**t[0].level;return!t.some((function(e){return!n.floatEqualRelative(e.resolution,i/2**e.level)}))},e.hasGapInLevels=function(e){const t=e.lods.map((function(e){return e.level}));t.sort((function(e,t){return e-t}));for(let i=1;i<t.length;i++)if(t[i]!==t[0]+i)return!0;return!1},e.tileSizeSupported=function(e){const t=e.size[1];return t===e.size[0]&&0==(t&t-1)&&t>=128&&t<=512},e.hasOriginPerLODs=function(e){const t=e.origin;return e.lods.some((e=>null!=e.origin&&(e.origin[0]!==t.x||e.origin[1]!==t.y)))},e.getMissingTileInfoError=function(){return new i("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")},e.checkUnsupported=function(t){return s.isNone(t)?m():t.lods.length<1?new i("tilingscheme:generic","Tiling scheme must have at least one level"):e.isPowerOfTwo(t)?e.hasGapInLevels(t)?new i("tilingscheme:gaps","Tiling scheme levels must not have gaps between min and max level"):e.tileSizeSupported(t)?e.hasOriginPerLODs(t)?new i("tilingscheme:multiple-origin","Tiling scheme levels must not have their own origin"):null:new i("tilingscheme:tile-size","Tiles must be square and size must be one of [128, 256, 512]"):new i("tilingscheme:power-of-two","Tiling scheme must be power of two")},e.fromExtent=function(t,i){const n=t[2]-t[0],s=t[3]-t[1],l=o.getMetersPerUnitForSR(i),r=1.2*Math.max(n,s),a=256,c=96,u=.0254,h=new e(new f({size:[a,a],origin:{x:t[0]-.5*(r-n),y:t[3]+.5*(r-s)},lods:[{level:0,resolution:r/a,scale:1/(a/c*u/(r*l))}],spatialReference:i}));return h.ensureMaxLod(20),h},e.makeWebMercatorAuxiliarySphere=function(t){const i=new e(e.WebMercatorAuxiliarySphereTileInfo);return i.ensureMaxLod(t),i},e.makeGCSWithTileSize=function(t,i=256,n=16){const s=256/i,o=new e(new f({size:[i,i],origin:{x:-180,y:90,spatialReference:t},spatialReference:t,lods:[{level:0,resolution:.703125*s,scale:295497598.570834*s}]}));return o.ensureMaxLod(n),o},t._createClass(e,[{key:"test",get:function(){return{isWebMercator:this._isWebMercator,isGCS:this._isGCS}}}]),e}();function m(){return new i("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}p.WebMercatorAuxiliarySphereTileInfo=new f({size:[256,256],origin:{x:-20037508.342787,y:20037508.342787,spatialReference:a.WebMercator},spatialReference:a.WebMercator,lods:[{level:0,resolution:156543.03392800014,scale:591657527.591555}]}),p.WebMercatorAuxiliarySphere=p.makeWebMercatorAuxiliarySphere(19);const x=c.create();e.default=p,e.getMissingTileInfoError=m,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
