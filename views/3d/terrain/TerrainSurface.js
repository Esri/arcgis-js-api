/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["require","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../Color","../../../core/Accessor","../../../core/arrayUtils","../../../core/CollectionFlattener","../../../core/Evented","../../../core/Handles","../../../core/Logger","../../../core/mathUtils","../../../core/maybe","../../../core/ObjectPool","../../../core/PooledArray","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators/aliasOf","../../../core/has","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass","../../../chunks/mat4","../../../chunks/mat4f64","../../../chunks/vec3","../../../chunks/vec3f64","../../../chunks/vec4f64","../../../geometry/projection","../../../geometry/projectionEllipsoid","../../../geometry/support/aaBoundingRect","../../../geometry/support/frustum","../../../layers/mixins/RefreshableLayer","../../../layers/support/ElevationQueryTileCache","../../../layers/support/layerUtils","../../../layers/support/LercDecoder","../../2d/engine/vectorTiles/VectorTile","../layers/ElevationLayerView3D","../support/cameraUtils","../support/debugFlags","../support/extentUtils","../support/index","../support/updatingProperties","./ElevationBounds","./ElevationData","./ExtentHelper","./interfaces","./LayerClass","./OverlayManager","./PlanarPatch","./RenderOrder","./SphericalPatch","./TerrainConst","./TerrainRenderer","./TerrainSurfacePerformanceInfo","./terrainUtils","./Tile","./TilePerLayerInfo","./TileUpdate","./tileUtils","./TilingSchemeLogic","./UpsampleInfo","../webgl-engine/lib/basicInterfaces","../../support/Scheduler","../../support/WatchUpdatingTracking"],(function(e,t,i,r,s,a,n,l,o,d,h,u,c,p,_,y,g,T,f,m,v,w,L,S,E,U,x,C,R,P,D,A,M,b,k,O,I,V,q,N,B,j,F,H,G,W,X,Y,Q,z,K,$,Z,J,ee,te,ie,re,se,ae,ne,le,oe,de){"use strict";const he=d.getLogger("esri.views.3d.terrain.TerrainSurface"),ue=.25;let ce=function(i){function r(e){var t;return(t=i.call(this,e)||this)._elevationBounds=new F.ElevationBounds,t._iteratorPool=new c(se.IteratorPreorder,(e=>e.remove=()=>t._iteratorPool.release(e))),t._postorderIterator=new se.IteratorPostorder,t._hasPendingUpdates=!1,t._pendingUpdates=0,t._asyncWorkItems=0,t._allTilesDirty=!0,t._allTilesSorted=!0,t._visible=!1,t._usedMemory=Te,t._performanceInfo=new J,t._viewChanged=!1,t._inFrameTask=!1,t._viewChangeUpdateDirty=!1,t._eyePosRenderSR=U.create(),t._eyePosSurfaceSR=U.create(),t._splitLimits=new te.SplitLimits,t._snapLevel=1/0,t._frustum=D.create(),t._viewProjectionMatrix=S.create(),t._layerViews=[new Array,new Array],t._layerIndexByUid=[new Map,new Map],t._basemapLayerViewHandles=new Map,t._handles=new o,t._watchUpdatingTracking=new de.WatchUpdatingTracking,t._frameTask=oe.ImmediateTask,t._allTiles=new p,t._upsampleInfoPool=new c(ne.UpsampleInfo),t._rootTilesExtent=P.create(),t._maxNumUpdating=1,t.maxTextureScale=1.2,t.backgroundImage=$.DEFAULT_TILE_BACKGROUND,t.backgroundColor=null,t._layerViewsDirty=!1,t}t._inheritsLoose(r,i);var s=r.prototype;return s.initialize=function(){this._lercDecoder=k.acquireDecoder(this.view.resourceController),this._tilePool=this.view.state.isLocal?new c(Q.PlanarPatch):new c(K.SphericalPatch);const t=this.view.resourceController.memoryController;this._upsampleMapCache=t.newCache("esri.views.3d.terrain.upsample",(e=>e.unloadMapData())),this._elevationQueryCache=new M.ElevationQueryTileCache(t.newCache("elevation-query")),this._set("overlayManager",new Y.OverlayManager({surface:this})),this._handles.add([this.watch("overlayManager.hasHighlights",(e=>this._renderer.setNeedsHighlight(e))),this.watch("overlayManager.rendersOccluded",(e=>this._renderer.setRenderOccludedOverlay(e)))],"overlayManager"),this._renderer=new Z({overlayRenderer:this.overlayManager.renderer,ellipsoidRadius:R.getReferenceEllipsoid(this.view.spatialReference).radius,stage:this.view._stage,allTiles:this._allTiles}),this._handles.add([g.init(this,"baseOpacity",(e=>{this._handleLayerViewChanges(),this._updateBaseOpacity(e)}),!0),g.init(this,"_background",(()=>{this._handleLayerViewChanges(),this._renderer.setTileBackground(this._background)}),!0),this.view.watch("pointsOfInterest",(e=>{this._renderer.pointsOfInterest=e,this._watchUpdatingTracking.removeAll(),e&&this._watchUpdatingTracking.add((()=>e.focus.renderLocation),(()=>()=>this._allTilesSorted=!1))})),g.init(q,"TERRAIN_TILE_TREE_SHOW_TILES",(t=>{t&&!this._treeDebugger?new Promise(((t,i)=>e(["../layers/support/TerrainTileTree3DDebugger"],t,i))).then((({TerrainTileTree3DDebugger:e})=>{!this._treeDebugger&&q.TERRAIN_TILE_TREE_SHOW_TILES&&(this._treeDebugger=new e({view:this.view}))})):t||(this._treeDebugger=u.destroyMaybe(this._treeDebugger))}))]),this._extentHelper=G.create(this.viewingMode,{layers:this.view.map.allLayers,layerViews:this.view.allLayerViews,viewSpatialReference:this.view.spatialReference});const i=this.view.defaultsFromMap?new n({getCollections:()=>{var e,t,i;return null==(e=this.view)||null==(t=e.defaultsFromMap)||null==(i=t.mapCollections)?void 0:i.map((({layers:e})=>e))},getChildrenFunction:e=>e&&"layers"in e?e.layers:null}):this.view.map.allLayers,r=new ae.TilingSchemeLogic({layers:i,extentHelper:this._extentHelper,viewingMode:this.viewingMode,viewSpatialReference:this.view.spatialReference});this._set("tilingSchemeLogic",r),this._updateTilingScheme(),this._elevationDataRequester=this.view.resourceController.createStreamDataRequester(B.ClientType.ELEVATION),this._mapDataRequester=this.view.resourceController.createStreamDataRequester(B.ClientType.BASEMAP);const s=this.view.resourceController.scheduler;this._frameTask=s.registerTask(oe.TaskPriority.TERRAIN_SURFACE,this),this.view.resourceController.memoryController.events.on("quality-changed",(()=>this._viewChangeUpdate())),this._handles.add([g.init(this._extentHelper,"stencilEnabledExtents",(e=>this._renderer.setStencilEnabledLayerExtents(e))),this.tilingSchemeLogic.watch("tilingScheme",(()=>this._updateTilingScheme()),!0),g.init(this,"extent",(()=>this._updateRootTiles())),this.view.on("resize",(()=>this._viewChangeUpdate())),this.view.watch("state.camera",(()=>this._viewChangeUpdate()),!0),this.view.watch("state.contentCamera",(()=>this.view.state.fixedContentCamera&&this._viewChangeUpdate()),!0),this.view.watch("qualitySettings.tiledSurface.lodBias",(()=>this._viewChangeUpdate())),g.init(this.view,"qualitySettings.tiledSurface.textureFadeDuration",(e=>this._renderer.textureFadingEnabled=e>0)),this.view.watch("lodSnapping",(()=>this._viewChangeUpdate())),y.watch((()=>this._userClippingExtent),(()=>this._updateClippingExtent()),y.sync)]),this._handles.add(this.view.allLayerViews.on("after-changes",(()=>this._layerViewsDirty=!0))),this._layerViewsDirty=!0,this._handleLayerViewChanges()},s.destroy=function(){this._frameTask.remove(),this._handles.destroy(),this._watchUpdatingTracking.destroy(),this._lercDecoder=u.releaseMaybe(this._lercDecoder),this._removeAllTiles(),this._upsampleMapCache=u.destroyMaybe(this._upsampleMapCache),this._elevationQueryCache=u.destroyMaybe(this._elevationQueryCache),this._set("tilingSchemeLogic",u.destroyMaybe(this.tilingSchemeLogic)),this._extentHelper=u.destroyMaybe(this._extentHelper),this._basemapLayerViewHandles.forEach(((e,t)=>this._unregisterTiledLayerView(t))),this._elevationDataRequester=null,this._mapDataRequester=null,this._set("overlayManager",u.destroyMaybe(this.overlayManager)),this._tilePool=u.destroyMaybe(this._tilePool),te.Tile.prune(),this._treeDebugger&&(this._treeDebugger.destroy(),this._treeDebugger=null),this._renderer=u.destroyMaybe(this._renderer),this._iteratorPool=u.destroyMaybe(this._iteratorPool),this._set("view",null),this._upsampleInfoPool=u.destroyMaybe(this._upsampleInfoPool),O.printAllocations(),ie.printAllocations()},s.intersect=function(e,t,i,r){this._renderer.intersect(e,t,i,r)},s.getElevation=function(e,t,i,r){const s=this.getTileWithElevation(e,t,i,r,fe);return u.isNone(s)?null:H.sampleElevation(fe[0],fe[1],s.renderData.geometryState.samplerData)},s.getTileWithElevation=function(e,t,i,r,s=fe){var a;const n=this.rootTiles;if(u.isNone(n)||!n.length)return null;if(0===n[0].layerInfo[X.LayerClass.ELEVATION].length)return null;if(s[0]=e,s[1]=t,s[2]=i,!C.projectVectorToVector(s,r,s,null==(a=this.tilingScheme)?void 0:a.spatialReference))return he.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;for(let l of n){if(!l.containsPoint(s))continue;for(;l&&!l.rendered&&!l.isLeaf;){let e=0;s[0]>.5*(l.extent[0]+l.extent[2])&&(e+=1),s[1]<.5*(l.extent[1]+l.extent[3])&&(e+=2),l=l.children[e]}const e=l.renderData;return(e?e.geometryState.samplerData:null)?l:null}return null},s.getScale=function(e){if(this.tilingScheme){if(!C.projectPointToVector(e,fe,this.spatialReference))return he.error("TerrainSurface.getScale(): could not project given point to tiling scheme coordinate system"),null;const t=this.rootTiles;if(u.isSome(t))for(let e of t)if(e.containsPoint(fe)){for(;null!=e.children[0];){let t=0;fe[0]>e.children[0].extent[2]&&(t+=1),fe[1]<e.children[0].extent[1]&&(t+=2),e=e.children[t]}return this._getLodBiasCorrectedScale(e.level)}}return 1e100},s.getSphereScale=function(e,t){if(!this.tilingScheme)return null;if(!C.projectPointToVector(e,fe,this.spatialReference))return he.error("TerrainSurface.getSphereScale(): could not project given point to tiling scheme coordinate system"),null;fe[3]=t;let i=null;const r=e=>{if(e&&P.intersectsSphere(e.extent,fe))if(null!=e.children[0])for(const t of e.children)r(t);else{const t=this._getLodBiasCorrectedScale(e.level);i=null==i?t:Math.min(i,t)}},s=this.rootTiles;if(u.isSome(s))for(const a of s)r(a);return i},s.queryVisibleScaleRange=function(e,t,i,r){const s=t?this.tilingScheme.levelAtScale(t):0,a=i?this.tilingScheme.levelAtScale(i):1/0,n=this.lodBias;this._renderer.queryVisibleLevelRange(e,s+n,a+n,r)},s._updateBaseOpacity=function(e){const t=this._renderer.opaque;this._renderer.opaque=e>=1,this._renderer.isTransparent=this._allTransparentSurfaceLayers();const i=t===this._renderer.opaque?W.TextureUpdate.UNFADED:W.TextureUpdate.IMMEDIATE;var r,s;i===W.TextureUpdate.IMMEDIATE&&(null==(r=this.view)||null==(s=r._stage)||s.renderView.setRenderParameters({opaqueTerrain:this.opaque}));this._updateTileTextures(i)},s._updateTilingScheme=function(){const e=this.tilingSchemeLogic.tilingScheme;e!==this.tilingScheme&&(ee.weakAssert(!!e,"tiling scheme cannot be reset to undefined"),this.tilingScheme&&this._removeAllTiles(),this._set("tilingScheme",e),this._updateClippingExtent(),e&&(this._updateTiledLayers(),this._renderer.setTileSize(e.pixelSize),this.overlayManager.setSpatialReference(e.spatialReference),this._updateRootTiles()))},s._acquireTile=function(e,t,i,r){const s=this._tilePool.acquire();return ve[0]=e,ve[1]=t,ve[2]=i,s.init(ve,r,this),s},s._updateRootTiles=function(){const{extent:e,tilingScheme:t}=this;if(!t)return;const i=me;let r=t.rootTilesInExtent(e,i,5*$.MAX_ROOT_TILES);if(u.isSome(this.rootTiles)){if(r.length>$.MAX_ROOT_TILES)return void he.warn($.TOO_MANY_ROOT_TILES_AFTER_CHANGE_ERROR);const e=this.rootTiles.map((e=>e.lij)),t=a.difference(e,r,_e);if(t.removed.length>0||t.added.length>0){const e=this.rootTiles.filter((e=>!(t.removed.findIndex((t=>_e(t,e.lij)))>-1)||(this._purgeTile(e),!1)));t.added.forEach((t=>e.push(this._newRootTile(t)))),this._setRootTiles(e)}}else r.length>$.MAX_ROOT_TILES&&(he.warn($.TOO_MANY_ROOT_TILES_FOR_LAYER_ERROR),r=t.rootTilesInExtent(e,i,$.MAX_ROOT_TILES)),this._setRootTiles(r.map((e=>this._newRootTile(e))));P.equals(i,this._rootTilesExtent)||(this._rootTilesExtent=P.create(i)),this.visible=!0,this._viewChangeUpdate(),this.overlayManager.setPlacementDirty(),this.notifyChange("ready")},s._newRootTile=function(e){const t=this._acquireTile(0,e[1],e[2],null);return t.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping)===re.TileUpdate.SPLIT&&t.setPendingUpdate(re.TileUpdate.SPLIT),this._loadTile(t),t},s._setRootTiles=function(e){if(this._set("rootTiles",e),this._allTiles.clear(),u.isSome(e)){const t=this._iteratorPool.acquire();for(t.reset(e);!t.done;)this._allTiles.push(t.next());t.remove()}this._renderer.setRootTiles(this.rootTiles),this._updateTilesVisibility(e)},s._runViewChangeUpdateIfDirty=function(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())},s._viewChangeUpdate=function(){this.view&&!this.suspended&&this.tilingScheme&&this._visible&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateSkirts(),this._updateTilesVisibility(this.rootTiles)))},s._updateClippingStatus=function(e){e.updateClippingStatus(this.extent)&&e.resetPendingUpdate(re.TileUpdate.GEOMETRY)&&this._updateTileGeometry(e)},s._updateTilesVisibility=function(e){if(u.isNone(e))return;const t=se.hasLoadableSiblings(e);let i=t?this._elevationBounds.min:1/0,r=t?this._elevationBounds.max:-1/0;const s=this.view.state.fixedContentCamera,a=this.extent,n=this._viewProjectionMatrix;this.setTileTreeDirty();const l=this._iteratorPool.acquire();for(l.reset(e);!l.done;){const e=l.next();e.updateClippingStatus(a)&&e.resetPendingUpdate(re.TileUpdate.GEOMETRY)&&this._updateTileGeometry(e),e.setPendingUpdate(re.TileUpdate.RENDERDATA);const t=e.computeVisibility();s||t?(e.updateScreenDepth(n),e.renderData&&(i=Math.min(e.elevationBounds[0],i),r=Math.max(e.elevationBounds[1],r))):l.skipSubtree()}l.remove(),this._viewChanged=!0,this._allTilesDirty=!0,isFinite(i)&&isFinite(r)&&(this._elevationBounds.min===i&&this._elevationBounds.max===r||(this._elevationBounds.min=i,this._elevationBounds.max=r,this.emit("elevation-bounds-change",null)))},s._updateViewDependentParameters=function(){const e=this.view.state.camera,t=this.view.state.contentCamera,i=Math.tan(.5*t.fovX),r=Math.tan(.5*t.fovY),s=this.tilingScheme.pixelSize,a=2**-this.lodBias*e.pixelRatio;this._splitLimits.aboveGround=e.aboveGround,this._splitLimits.fovX=i,this._splitLimits.fovY=r,this._splitLimits.relativeWidthLimit=s/e.width*this.maxTextureScale*a,this._splitLimits.relativeHeightLimit=s/e.height*this.maxTextureScale*a,this._splitLimits.maxLod=this.tilingScheme.getMaxLod(),this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias,this.view.state.fixedContentCamera?(u.isNone(this._splitLimits.frustum)&&(this._splitLimits.frustum=D.create()),D.copy(this._splitLimits.frustum,t.frustum)):this._splitLimits.frustum=null,D.copy(this._frustum,e.frustum),L.multiply(this._viewProjectionMatrix,t.projectionMatrix,t.viewMatrix),E.copy(this._eyePosRenderSR,t.eye),C.projectVectorToVector(e.eye,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)},s._updateSkirts=function(){const e=this.view.state.camera,t=this.view.state.constraints.collision.enabled?0:1.11*e.near;this.skirtScale=ee.computeSkirtScale(this,this._eyePosSurfaceSR,t)},s._updateRenderData=function(e){e.rendered&&!e.shouldLoad&&(ye(e)?this._loadChildren(e):ge(e)&&this._loadParent(e))},s._updateTileGeometry=function(e){e.updateVisibility(),this._renderer.updateTileGeometry(e),this._elevationUpdate(e),this._usedMemory=Te},s._updateTileTexture=function(e,t){const i=e.resetPendingUpdate(re.TileUpdate.TEXTURE_FADING)?re.TileUpdate.TEXTURE_FADING:!!e.resetPendingUpdate(re.TileUpdate.TEXTURE_NOFADING)&&re.TileUpdate.TEXTURE_NOFADING;i&&(this._renderer.updateTileTexture(e,i),this._usedMemory=Te,t.madeProgress())},s._elevationUpdate=function(e){Le.spatialReference=this.spatialReference,Le.tile=e,Le.extent=e.extent,this.emit("elevation-change",Le),P.containsPoint(e.extent,this._eyePosSurfaceSR)&&this._updateSkirts()},s.runTask=function(e){this._handleLayerViewChanges(e),this._frameTask.processQueue(e),this._inFrameTask=!0,this._pendingUpdates=0,this._hasPendingUpdates=!1,this._updateTileStatus(e),this._sortTiles(e);const t=!this.view.state.fixedContentCamera;this._mergeAndSplit(e,t),e.run((()=>this._updateElevation(e))),e.run((()=>this._updateTextures(e))),t||this._mergeAndSplit(e,!0),this._inFrameTask=!1,this._runViewChangeUpdateIfDirty(),e.done&&this.requestUpdate(),this.notifyChange("updatingProgressValue")},s._updateTileStatus=function(e){if(!this._viewChanged||!this.rootTiles||e.done)return;this._viewChanged=!1;const t=this._iteratorPool.acquire();for(t.reset(this.rootTiles);!t.done;){const e=t.next();if(e.loadable){const i=e.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping);if(i===re.TileUpdate.SPLIT){e.resetPendingUpdate(re.TileUpdate.MERGE),e.isLeaf&&(e.setPendingUpdate(re.TileUpdate.SPLIT),t.skipSubtree());continue}e.resetPendingUpdate(re.TileUpdate.SPLIT)&&e.updateAgentSuspension(),i===re.TileUpdate.VSPLITMERGE&&e.updateAgents(X.LayerClass.ELEVATION)}if(t.skipSubtree(),!e.isLeaf){e.setPendingUpdate(re.TileUpdate.MERGE),e.resetPendingUpdate(re.TileUpdate.SPLIT);const t=this._iteratorPool.acquire();t.resetOne(e);for(let e=t.next();!t.done;e=t.next())this._updateClippingStatus(e),e.updateVisibility(),e.loadable&&e.updateScreenDepth(this._viewProjectionMatrix);t.remove()}}t.remove(),this.requestUpdate(),e.madeProgress()},s._sortTiles=function(e){e.done||this._allTilesSorted||(se.sortTilesByPOI(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,this._treeDebugger&&this._treeDebugger.update(),e.madeProgress())},s._mergeAndSplit=function(e,t){if(this.suspended||e.done||!this._allTilesDirty)return;this._allTilesDirty=!1,this.requestUpdate();let i=0;for(;!e.done;){let r=!1;i=0;const s=!this._allTiles.some((s=>{if(i+=s.usedMemory,s.resetPendingUpdate(re.TileUpdate.MERGE)){if(!t)return s.setPendingUpdate(re.TileUpdate.MERGE),e.done;this._mergeTile(s),r=!0,e.madeProgress()}else s.resetPendingUpdate(re.TileUpdate.SPLIT)&&(this._splitTile(s),r=!0,e.madeProgress());return!e.done&&s.resetPendingUpdate(re.TileUpdate.RENDERDATA)&&(this._updateRenderData(s),e.madeProgress()),e.done}));if(r&&(this._allTilesSorted=!1,this._allTilesDirty=!0),s){if(this._usedMemory=i,!r)break;this._updateTilesVisibility(this.rootTiles)}else this._allTilesDirty=!0}0===i&&(this._allTilesDirty=!0),this._sortTiles(e)},s._updateElevation=function(e){return this._allTiles.some((t=>(t.resetPendingUpdate(re.TileUpdate.GEOMETRY)&&(this._updateTileGeometry(t),this._updateTileTexture(t,e),e.madeProgress()),e.done))),e.hasProgressed},s._updateTextures=function(e){return this._allTiles.some((t=>(this._updateTileTexture(t,e),e.done))),e.hasProgressed},s._updateClippingExtent=function(){this.spatialReference&&(this.updateTileOverlayParams(le.RenderRequestType.UPDATE),this.overlayManager.setPlacementDirty(),this._updateRootTiles())},s._getLodBiasCorrectedScale=function(e){const t=this.tilingScheme.levels,i=h.clamp(e-this.lodBias,0,t.length-1),r=i-Math.floor(i);return t[Math.floor(i)].scale*(1-r)+t[Math.ceil(i)].scale*r},s._removeAllTiles=function(){u.isSome(this.rootTiles)&&(this.rootTiles.forEach((e=>this._purgeTile(e))),this._setRootTiles(null),this.notifyChange("ready")),this._allTiles.clear(),this.visible=!1},s._purgeChildTiles=function(e){if(e.isLeaf)return!1;let t=this._purgeTile(e.children[0]);return t=this._purgeTile(e.children[1])||t,t=this._purgeTile(e.children[2])||t,t=this._purgeTile(e.children[3])||t,e.unsetChildren(),t},s._purgeTile=function(e){const t=this._purgeChildTiles(e)||e.rendered;return this._allTiles.removeUnordered(e),e.unload(this._renderer),this._tilePool.release(e),t},s._splitTile=function(e){ee.weakAssert(e.isLeaf,"tile that is already split should not be split again!");const t=e.level+1,i=2*e.lij[1],r=2*e.lij[2];e.setChildren(this._createTile(t,i,r,e),this._createTile(t,i,r+1,e),this._createTile(t,i+1,r,e),this._createTile(t,i+1,r+1,e)),e.setPendingUpdate(re.TileUpdate.RENDERDATA),e.updateAgentSuspension(),this._allTiles.pushArray(e.children),this._allTilesDirty=!0,this._emitTileScaleChange(e,t),++this._performanceInfo.numSplit},s._emitTileScaleChange=function(e,t=e.level){Se.spatialReference=this.spatialReference,Se.extent=e.extent,Se.scale=this._getLodBiasCorrectedScale(t),this.emit("scale-change",Se)},s._createTile=function(e,t,i,r){ee.weakAssert(!!r,"_createTile sanity check");const s=this._acquireTile(e,t,i,r);return s.updateClippingStatus(this.extent),s.loadable&&(s.updateScreenDepth(this._viewProjectionMatrix),s.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping)===re.TileUpdate.SPLIT&&s.setPendingUpdate(re.TileUpdate.SPLIT)),s},s._mergeTile=function(e){ee.weakAssert(!e.hasPendingUpdate(re.TileUpdate.SPLIT),"_mergeTile sanity check"),this._purgeChildTiles(e)&&(ee.weakAssert(!e.renderData,"_mergeTile sanity check"),this._loadTile(e)),this._allTilesDirty=!0,++this._performanceInfo.numMerged,this._emitTileScaleChange(e)},s._loadChildren=function(e){ee.weakAssert(e.rendered,"parent should be rendered"),e.unload(this._renderer),this._loadTile(e.children[0]),this._loadTile(e.children[1]),this._loadTile(e.children[2]),this._loadTile(e.children[3])},s._loadParent=function(e){const t=e.parent;this._unloadChildren(t),this._loadTile(t)},s._unloadChildren=function(e){e.isLeaf||(this._unloadChildren(e.children[0]),e.children[0].unload(this._renderer),this._unloadChildren(e.children[1]),e.children[1].unload(this._renderer),this._unloadChildren(e.children[2]),e.children[2].unload(this._renderer),this._unloadChildren(e.children[3]),e.children[3].unload(this._renderer))},s._loadTile=function(e){e.load(this._renderer),e.setPendingUpdate(re.TileUpdate.RENDERDATA),this.requestUpdate(),this._allTilesDirty=!0,this.overlayManager&&this.overlayManager.hasOverlays&&this.overlayManager.setTileParameters(e),this._elevationUpdate(e)},s._elevationDataArrived=function(e,t,i){const r=new H.ElevationData(e.lij,e.extent,i);e.dataArrived(t,X.LayerClass.ELEVATION,r);const s=[e],a=e.level,n=this._iteratorPool.acquire();for(n.reset(s);!n.done;){const e=n.next();e.findElevationBoundsForLayer(t,a),e.computeElevationBounds()}n.remove(),this._updateTilesVisibility(s)},s._handleLayerViewChanges=function(e=oe.noBudget){if(!this._layerViewsDirty)return;this._layerViewsDirty=!1;let t=!1;const i=new Set;let r=-1;for(const s of this.view.allLayerViews.items)if(i.add(s.uid),ee.isSurfaceLayerView(s))if(this._basemapLayerViewHandles.has(s.uid)){const e=this._layerClassFromLayerView(s),i=this._layerIndexByUid[e].get(s.uid);i<r&&(t=!0),r=i}else this._registerTiledLayerView(s),s.layer.loaded&&(t=!0);this._basemapLayerViewHandles.forEach(((e,r)=>{i.has(r)||(this._unregisterTiledLayerView(r),t=!0)})),t&&this._updateTiledLayers(),this._renderer.isTransparent=this._allTransparentSurfaceLayers(),e.madeProgress()},s._allTransparentSurfaceLayers=function(){var e,t;let i=0===(null==(e=this.view.map)||null==(t=e.ground)?void 0:t.opacity);for(const r of this.view.allLayerViews.items)if(ee.isSurfaceLayerView(r)&&!ee.isElevationLayerView(r)&&!b.isBaseLayer(r.layer)&&0!==r.fullOpacity)return i=!1,i;return i},s._layerClassFromLayerView=function(e){return ee.isElevationLayerView(e)?X.LayerClass.ELEVATION:X.LayerClass.MAP},s._registerTiledLayerView=function(e){const t=[],i=this._layerClassFromLayerView(e);t.push(e.watch("suspended",(()=>this._updateTiledLayers()))),t.push(e.watch("fullOpacity",(()=>this._updateTileTextures(W.TextureUpdate.UNFADED)))),t.push(e.layer.watch("effectiveScaleRange",(()=>this._restartAllAgents(i)))),e.on("data-changed",(()=>{const t=this._layerIndexByUid[i].get(e.uid);null!=t&&this._invalidateLayerData(t,i)})),this._basemapLayerViewHandles.set(e.uid,t)},s._unregisterTiledLayerView=function(e){const t=this._basemapLayerViewHandles.get(e);if(t){for(let e=0;e<t.length;e++)t[e].remove();this._basemapLayerViewHandles.delete(e)}},s._updateTiledLayers=function(){if(!this.tilingScheme||this.view.suspended)return;const e=this.view.allLayerViews,t=[[],[]];let i=null;const r=P.empty();e.forEach((e=>{const s=e.layer;if(!s||e.suspended||!ee.isSurfaceLayerView(e))return;const a=e.fullExtent;if(!a)return void he.warn("Terrain: Map or elevation layer does not have fullExtent: "+s.id);P.expand(r,a,r);const n=this._layerClassFromLayerView(e);if(n===X.LayerClass.MAP){const t=e.displayLevelRange;t.maxLevel!==1/0&&(null===i||t.maxLevel>i)&&(i=t.maxLevel)}t[n].push(e)}));for(const s of X.LayerClasses){const e=this._layerViews[s],i=t[s];i.reverse();const r=i.length;let a=e.length!==r;const n=new Array(r),l=new Array(e.length);this._layerIndexByUid[s].clear();for(let t=0;t<r;t++){const r=i[t].uid;this._layerIndexByUid[s].set(r,t);const o=e.indexOf(i[t]);n[t]=o,t!==o&&(a=!0),o>-1&&(l[o]=t)}if(a){const e=this._postorderIterator;for(e.reset(this.rootTiles);!e.done;)e.next().modifyLayers(l,n,s);this._layerViews[s]=i,this._restartAllAgents(s),this._updateTilesVisibility(this.rootTiles)}}this.tilingScheme.ensureMaxLod(i)&&this._viewChangeUpdate()},s._restartAllAgents=function(e){const t=this._postorderIterator;for(t.reset(this.rootTiles);!t.done;){const i=t.next();i.restartAgents(e),e===X.LayerClass.ELEVATION&&i.computeElevationBounds()}},s.layerViewByIndex=function(e,t){return this._layerViews[t][e]},s.numLayers=function(e){return this._layerViews[e].length},s._updateTileTextures=function(e){this._allTiles.forAll((t=>{t.updateAgents(X.LayerClass.MAP),e===W.TextureUpdate.IMMEDIATE?this.renderer.updateTileTexture(t,re.TileUpdate.TEXTURE_NOFADING):t.updateRenderData(X.LayerClass.MAP,e)})),this._renderer.isTransparent=this._allTransparentSurfaceLayers()},s._invalidateLayerData=function(e,t){this._allTiles.forAll((i=>i.removeLayerAgent(e,t))),this._allTiles.forAll((i=>i.invalidateLayerData(e,t)))},s.setTileTreeDirty=function(){this._allTilesDirty=!0},s.requestRender=function(e=le.RenderRequestType.UPDATE){this.renderer.setNeedsRender(e)},s.requestUpdate=function(){1==++this._pendingUpdates&&(this._hasPendingUpdates=!0)},s.requestTileData=function(e,t,i,r){const s=this.layerViewByIndex(t,i),a=s.layer;return!a.tilemapCache||ee.isVectorTileLayerView(s)?this._requestTileData(e,i,s,r):(++this._asyncWorkItems,a.tilemapCache.fetchAvailability(e.lij[0],e.lij[1],e.lij[2],{...r,timeout:6e3}).then((()=>--this._asyncWorkItems)).catch((t=>{throw--this._asyncWorkItems,_.isAbortError(t)||this._dataMissing(e,i,s,{notInTilemap:!0}),t})).then((()=>this._frameTask.schedule((()=>this._requestTileData(e,i,s,r)),r.signal))))},s._requestTileData=function(e,t,i,r){return t===X.LayerClass.ELEVATION?this._requestElevationTileData(e,i,r):this._requestMapTileData(e,i,r)},s._requestElevationTileData=function(e,t,i){if(!ee.isElevationLayerView(t))return void ee.weakAssert(!1,"_requestElevationTileData can only be called for elevation layer views");const r=r=>{if(--this._asyncWorkItems,_.isAborted(i))return;const s=this._layerIndexByUid[X.LayerClass.ELEVATION].get(t.uid);null!=s?(this._usedMemory=Te,this.requestUpdate(),this._elevationDataArrived(e,s,r)):he.warn("TerrainSurface: received data from unknown layer %d %s",X.LayerClass.ELEVATION,e.lij.toString())},s=i=>{--this._asyncWorkItems,_.isAbortError(i)||(this._dataMissing(e,X.LayerClass.ELEVATION,t,i),this.requestUpdate())};if(++this._asyncWorkItems,ee.useFetchTileForLayer(t.layer))return t.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],{noDataValue:$.ELEVATION_NODATA_VALUE,signal:i.signal}).then((e=>{if(_.isAborted(i))return he.warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),void s(_.createAbortError());this._frameTask.schedule((()=>r(e)),i.signal,s)}),s);const a=t.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);return this._elevationDataRequester.request(a,"binary",i).then((e=>this._lercDecoder.decode(e,{noDataValue:$.ELEVATION_NODATA_VALUE},i.signal))).then((e=>{r({values:e.pixelData,width:e.width,height:e.height,noDataValue:e.noDataValue,minValue:e.minValue,maxValue:e.maxValue})}),s)},s._requestMapTileData=function(e,t,i){if(t instanceof I)return Promise.reject();++this._asyncWorkItems;const r=(r,s)=>{--this._asyncWorkItems,ee.releaseTileData(s),_.isAborted(i)||(this._dataMissing(e,X.LayerClass.MAP,t,r),this.requestUpdate())},s=e=>t=>r(t,e),a=r=>this._frameTask.schedule((()=>{--this._asyncWorkItems,this.requestUpdate(),_.isAborted(i)?ee.releaseTileData(r):this._mapTileDataArrived(e,t,r)}),i.signal,s(r)).catch(s(r)),n=(e,t=null)=>this._frameTask.schedule((()=>r(e,t)));if(ee.isVectorTileLayerView(t)){const r=t.schemaHelper.getLevelRowColumn(e.lij);return t.fetchTile(r[0],r[1],r[2],i).then(a,n)}if(ee.isImageryTileLayerView(t))return t.fetchTile(e.lij[0],e.lij[1],e.lij[2],i).then(a,n);if(ee.isTileLayerView(t)&&ee.useFetchTileForLayer(t.layer))return t.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],i).then((e=>{if(_.isAborted(i))return he.warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),void n(_.createAbortError());a(e)}),n);let l=t.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);A.isRefreshableLayer(t.layer)&&t.layer.refreshTimestamp&&(l+=`${l.includes("?")?"&":"?"}_ts=${t.layer.refreshTimestamp}`);const o=t.hasMixedImageFormats?"image+type":"image";return this._mapDataRequester.request(l,o,i).then(a,n)},s._mapTileDataArrived=function(e,t,i){const r=this._layerIndexByUid[X.LayerClass.MAP].get(t.uid);null!=r?e.dataArrived(r,X.LayerClass.MAP,i):(ee.releaseTileData(i),he.warn("TerrainSurface: received data from unknown layer"))},s._dataMissing=function(e,t,i,r){const s=this._layerIndexByUid[t].get(i.uid);null!=s?e.dataMissing(s,t,r):he.warn("TerrainSurface: received data from unknown layer")},s.updateTileOverlayParams=function(e){this.rootTiles&&this.overlayManager&&(this._allTiles.forAll((e=>{e.renderData&&this.overlayManager.setTileParameters(e)})),this._renderer.setNeedsRender(e))},s.getUsedMemory=function(){return this.tilingScheme?(this._usedMemory===Te&&(this._usedMemory=0,this._allTiles.forAll((e=>this._usedMemory+=e.usedMemory))),this._usedMemory):0},s.getUsedMemoryForLayerView=function(e){let t=0;const i=this._layerClassFromLayerView(e),r=this._layerIndexByUid[i].get(e.uid);return this._allTiles.forAll((e=>t+=e.getUsedMemoryForLayer(i,r))),t},s.getTile=function(e){if(u.isNone(e)||u.isNone(this.rootTiles))return null;const t=e.split("/").map((e=>+e));if(0===t[0])return this.rootTiles.find((e=>e.lij[1]===t[1]&&e.lij[2]===t[2]));const i=2**t[0],r=Math.floor(t[1]/i),s=Math.floor(t[2]/i);let a;if(this.rootTiles.some((e=>e.lij[1]===r&&e.lij[2]===s&&(a=e,!0))),a){let e=1<<t[0]-1;for(;a.lij[0]<t[0];){let i=t[1]&e?2:0;if((t[2]&e)>0&&i++,!a.children[i])return null;a=a.children[i],e>>=1}return ee.weakAssert(a.lij[0]===t[0]&&a.lij[1]===t[1]&&a.lij[2]===t[2],"not the right tile?"),a}return null},t._createClass(r,[{key:"renderer",get:function(){return this._renderer}},{key:"frustum",get:function(){return this._frustum}},{key:"snapLevel",get:function(){var e,t;const i=null==(e=this.view.pointsOfInterest)||null==(t=e.contentCameraOnSurface)?void 0:t.scale;if(i){const e=this.view.state.contentCamera;let t=V.directionToHeadingTilt(this.view,e.eye,e.viewForward,e.up).tilt;t>90&&(t=180-t);const r=2*(t/90)**2,s=V.scaleToZoom(this.view,i)-r;Math.abs(this._snapLevel-s)>ue&&(Math.round(s)!==Math.round(this._snapLevel)&&(this._viewChanged=!0),this._snapLevel=s)}return Math.round(this._snapLevel)}},{key:"lodSnapping",get:function(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences?W.LODSnapping.ON:W.LODSnapping.OFF}},{key:"upsampleInfoPool",get:function(){return this._upsampleInfoPool}},{key:"upsampleMapCache",get:function(){return this._upsampleMapCache}},{key:"elevationQueryCache",get:function(){return this._elevationQueryCache}},{key:"mapTileRequester",get:function(){return this._mapDataRequester}},{key:"_userClippingExtent",get:function(){const{spatialReference:e}=this,{clippingArea:t}=this.view;if(u.isNone(t)||u.isNone(e))return null;const i=P.create(),r=N.toBoundingRect(t,i,e)?i:null,s=this._get("extent");return P.equals(r,s)?s:r}},{key:"extent",get:function(){const e=P.intersection(this.groundExtent,this._userClippingExtent,P.create()),t=this._get("extent");return P.equals(e,t)?t:e}},{key:"groundExtent",get:function(){return u.isSome(this._tilingSchemeExtent)?this._tilingSchemeExtent:this._rootTilesExtent}},{key:"_tilingSchemeExtent",get:function(){var e;return null==(e=this.tilingSchemeLogic)?void 0:e.extent}},{key:"updating",get:function(){return this._hasPendingUpdates||(this._maxNumUpdating=1),!!((this._watchUpdatingTracking.updating||this._hasPendingUpdates||this._viewChanged||this._allTilesDirty||this._asyncWorkItems>0||!this._allTilesSorted||this._renderer.updating||this._layerViewsDirty)&&this.ready&&!this.suspended||this.overlayManager.updating||this._frameTask.updating)}},{key:"updatingProgressValue",get:function(){return this._maxNumUpdating=Math.max(this._pendingUpdates,this._maxNumUpdating),1-this._pendingUpdates/this._maxNumUpdating}},{key:"viewingMode",get:function(){return this.view.state.viewingMode}},{key:"ready",get:function(){return u.isSome(this.rootTiles)}},{key:"renderOrder",set:function(e){this._renderer.renderOrder=e,this._set("renderOrder",e)}},{key:"skirtScale",get:function(){return this._renderer.skirtScale},set:function(e){this._renderer.skirtScale=e}},{key:"spatialReference",get:function(){var e,t;return null!=(e=null==(t=this.tilingScheme)?void 0:t.spatialReference)?e:null}},{key:"_background",get:function(){return null!=this.backgroundColor?this.backgroundColor:this.backgroundImage}},{key:"slicePlaneEnabled",set:function(e){var t,i;this._renderer.slicePlaneEnabled=e,this._set("slicePlaneEnabled",e),null==(t=this.view)||null==(i=t._stage)||i.renderView.setRenderParameters({opaqueTerrain:this.opaque})}},{key:"velvetOverground",set:function(e){e!==this.velvetOverground&&(this._renderer.velvetOverground=e),this._set("velvetOverground",e)}},{key:"visible",set:function(e){e!==this._visible&&(this._visible=e,this._renderer.setVisibility(e),this.suspended=!e)}},{key:"opaque",get:function(){return this._renderer.opaque}},{key:"suspended",set:function(e){this._set("suspended",e),this._viewChangeUpdate()}},{key:"elevationBounds",get:function(){return this._elevationBounds}},{key:"running",get:function(){return this.updating&&this.ready&&!this.suspended}},{key:"lodBias",get:function(){const e=this.view.resourceController.memoryController.memoryFactor;return this.view.qualitySettings.tiledSurface.lodBias-(1-e)*$.MAX_MEMORY_LOD_BIAS}},{key:"performanceInfo",get:function(){const e=this._performanceInfo;return e.numNodes=this._allTiles.length,e.numLeaves=e.numVisible=e.numRendered=e.numLoadedPerLevel.length=e.numRenderedPerLevel.length=0,this._allTiles.forAll((t=>{t.isLeaf&&e.numLeaves++;const i=t.level;t.renderData&&(e.numLoadedPerLevel[i]=(e.numLoadedPerLevel[i]||0)+1),t.visible&&(e.numVisible++,t.rendered&&(e.numRenderedPerLevel[i]=(e.numRenderedPerLevel[i]||0)+1,e.numRendered++))})),e}},{key:"test",get:function(){const e=this;return{renderer:e._renderer,lercDecoder:e._lercDecoder,forceReload:()=>{u.isSome(e.rootTiles)&&(e._mergeTile(e.rootTiles[0]),e._viewChangeUpdate())},getTiles:()=>e._allTiles.toArray(),getRenderedTiles(){we.clear(),e._allTiles.forAll((e=>{e.visible&&e.rendered&&we.push(e)}));const t=we.toArray();return se.sortTiles(e.renderOrder,t),t},lockTilingScheme(t,i){e._extentHelper.defaultTiledLayersExtent=i,e.tilingSchemeLogic.test.lockTilingScheme(t)}}}}]),r}(l.EventedMixin(s));i.__decorate([v.property()],ce.prototype,"_renderer",void 0),i.__decorate([v.property()],ce.prototype,"_hasPendingUpdates",void 0),i.__decorate([v.property()],ce.prototype,"_asyncWorkItems",void 0),i.__decorate([v.property()],ce.prototype,"_allTilesDirty",void 0),i.__decorate([v.property()],ce.prototype,"_allTilesSorted",void 0),i.__decorate([v.property()],ce.prototype,"_viewChanged",void 0),i.__decorate([v.property({readOnly:!0})],ce.prototype,"_watchUpdatingTracking",void 0),i.__decorate([v.property()],ce.prototype,"_frameTask",void 0),i.__decorate([v.property({readOnly:!0})],ce.prototype,"snapLevel",null),i.__decorate([v.property({readOnly:!0})],ce.prototype,"lodSnapping",null),i.__decorate([v.property({constructOnly:!0})],ce.prototype,"view",void 0),i.__decorate([v.property()],ce.prototype,"_userClippingExtent",null),i.__decorate([v.property()],ce.prototype,"_rootTilesExtent",void 0),i.__decorate([v.property({readOnly:!0})],ce.prototype,"extent",null),i.__decorate([v.property({readOnly:!0})],ce.prototype,"groundExtent",null),i.__decorate([v.property({readOnly:!0})],ce.prototype,"_tilingSchemeExtent",null),i.__decorate([v.property({readOnly:!0})],ce.prototype,"updating",null),i.__decorate([v.property(j.updatingProgress)],ce.prototype,"updatingProgress",void 0),i.__decorate([v.property({readOnly:!0})],ce.prototype,"updatingProgressValue",null),i.__decorate([v.property()],ce.prototype,"_maxNumUpdating",void 0),i.__decorate([v.property({aliasOf:"view.map.ground.opacity"})],ce.prototype,"baseOpacity",void 0),i.__decorate([v.property({readOnly:!0})],ce.prototype,"overlayManager",void 0),i.__decorate([v.property({readOnly:!0})],ce.prototype,"viewingMode",null),i.__decorate([v.property()],ce.prototype,"maxTextureScale",void 0),i.__decorate([v.property({readOnly:!0})],ce.prototype,"ready",null),i.__decorate([v.property({value:z.RenderOrder.FRONT_TO_BACK})],ce.prototype,"renderOrder",null),i.__decorate([v.property({readOnly:!0})],ce.prototype,"rootTiles",void 0),i.__decorate([v.property({readOnly:!0})],ce.prototype,"spatialReference",null),i.__decorate([v.property()],ce.prototype,"backgroundImage",void 0),i.__decorate([v.property({type:r,aliasOf:"view.map.ground.surfaceColor"})],ce.prototype,"backgroundColor",void 0),i.__decorate([v.property()],ce.prototype,"_background",null),i.__decorate([v.property({value:!1})],ce.prototype,"slicePlaneEnabled",null),i.__decorate([v.property({readOnly:!0})],ce.prototype,"tilingScheme",void 0),i.__decorate([v.property({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeLocked"})],ce.prototype,"tilingSchemeLocked",void 0),i.__decorate([v.property({readOnly:!0})],ce.prototype,"tilingSchemeLogic",void 0),i.__decorate([v.property({value:!0})],ce.prototype,"velvetOverground",null),i.__decorate([T.aliasOf("_renderer.wireframe")],ce.prototype,"wireframe",void 0),i.__decorate([v.property({value:!1})],ce.prototype,"suspended",null),i.__decorate([v.property({readOnly:!0,aliasOf:"view.qualitySettings.tiledSurface.textureFadeDuration"})],ce.prototype,"textureFadeDuration",void 0),i.__decorate([v.property()],ce.prototype,"_layerViewsDirty",void 0),i.__decorate([T.aliasOf("_renderer.renderPatchBorders")],ce.prototype,"renderPatchBorders",void 0),i.__decorate([T.aliasOf("_renderer.renderingDisabled")],ce.prototype,"renderingDisabled",void 0),ce=i.__decorate([w.subclass("esri.views.3d.terrain.TerrainSurface")],ce);const pe=ce;function _e(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function ye(e){return!e.isLeaf&&(e.children[0].shouldLoad||e.children[1].shouldLoad||e.children[2].shouldLoad||e.children[3].shouldLoad||ye(e.children[0])||ye(e.children[1])||ye(e.children[2])||ye(e.children[3]))}function ge(e){return e.isLeaf&&e.parent&&e.parent.shouldLoad}const Te=-1,fe=x.create(),me=P.create(),ve=[0,0,0],we=new p,Le={spatialReference:null,tile:null,extent:null,context:"ground"},Se={spatialReference:null,extent:null,scale:0};return pe}));
