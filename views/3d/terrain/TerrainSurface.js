/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["require","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/has","../../../core/maybe","../../../core/Logger","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/aliasOf","../../../core/accessorSupport/decorators/subclass","../../../core/urlUtils","../../../core/uuid","../../../portal/support/resourceExtension","../../../core/ObjectPool","../../../core/arrayUtils","../../../core/PooledArray","../../../core/promiseUtils","../../../core/Accessor","../../../geometry/support/spatialReferenceUtils","../../../core/Evented","../../../core/mathUtils","../../../Color","../../../chunks/vec3f64","../../../chunks/vec3","../../../core/Handles","../../../core/CollectionFlattener","../../../core/watchUtils","../../../geometry/projectionEllipsoid","../../../chunks/mat4","../../../geometry/support/aaBoundingRect","../../../geometry/projection","../../support/Scheduler","../../../chunks/mat4f64","../../../chunks/vec4f64","../../../layers/support/LercDecoder","../../../layers/support/layerUtils","./TerrainConst","../../../chunks/mat3f32","../support/geometryUtils","../support/debugFlags","../support/extentUtils","./terrainUtils","../../2d/engine/vectorTiles/decluttering/jobsUtil","../layers/ElevationLayerView3D","./ElevationBounds","./ElevationData","./OverlayManager","./tileUtils","./Tile","./PlanarPatch","./SphericalPatch","./SurfaceExtentHelper","./SurfaceTilingSchemeLogic","./TerrainRenderer","./TerrainSurfacePerformanceInfo","./UpsampleInfo"],(function(e,t,i,r,s,n,a,l,o,d,h,c,u,p,_,y,g,f,v,m,T,w,S,L,x,b,R,P,D,E,O,C,V,k,M,A,I,U,B,q,j,F,H,N,W,G,X,Y,z,$,K,J,Q,Z,ee,te){"use strict";const ie=n.getLogger("esri.views.3d.terrain.TerrainSurface");let re=function(i){function r(e){var t;return(t=i.call(this,e)||this)._clippingExtent=null,t._dataExtent=null,t._elevationBounds=new W.ElevationBounds,t._rootExtent=E.create(),t._iteratorPool=new p(Y.IteratorPreorder),t._postorderIterator=new Y.IteratorPostorder,t.pendingUpdates=!1,t._asyncWorkItems=0,t._allTilesDirty=!0,t._allTilesSorted=!0,t._visible=!1,t._usedMemory=le,t._performanceInfo=new ee,t._viewChanged=!1,t._inFrameTask=!1,t._viewChangeUpdateDirty=!1,t._overlayOpacity=1,t._eyePosRenderSR=S.create(),t._eyePosSurfaceSR=S.create(),t._splitLimits=new z.SplitLimits,t._snapLevel=1/0,t._frustum=B.frustum.create(),t._viewProjectionMatrix=V.create(),t._layerViews=[new Array,new Array],t._layerIndexByLayerViewId=[new Map,new Map],t._basemapLayerViewHandles=new Map,t._handles=new x,t._allTiles=new y,t._upsampleInfoPool=new p(te.UpsampleInfo),t._visibleLevels=new y({deallocator:null}),t._getElevationData={spatialReference:null,rootTiles:null},t.maxTextureScale=1.2,t.rootTiles=null,t.backgroundImage=I.DEFAULT_TILE_BACKGROUND,t.backgroundColor=null,t._layerViewsDirty=!1,t}t._inheritsLoose(r,i);var n=r.prototype;return n.initialize=function(){this._stage=this.view._stage,this._lercDecoder=M.acquireDecoder(this.view.resourceController.scheduler),this._tilePool="planar"===this.manifold?new p($.PlanarPatch):new p(K.SphericalPatch),this._upsampleMapCache=this.view.resourceController.memoryController.getMemCache("esri.views.3d.terrain.upsample",(e=>e.unloadMapData())),this._set("overlayManager",new X.OverlayManager({surface:this})),this._handles.add([this.watch("overlayManager.hasHighlights",(e=>this._renderer.setNeedsHighlight(e))),this.watch("overlayManager.rendersOccluded",(e=>this._renderer.setRenderOccludedOverlay(e)))],"overlayManager"),this._renderer=new Z({manifold:this.manifold,overlayRenderer:this.overlayManager.renderer,ellipsoidRadius:P.getReferenceEllipsoid(this.view.spatialReference).radius}),this._renderer.install(this.view._stage),this._handles.add([R.init(this,"baseOpacity",(e=>{this._handleLayerViewChanges(),this._updateBaseOpacity(e)}),!0),R.init(this,"_background",(()=>{this._handleLayerViewChanges(),this._renderer.setTileBackground(this._background)}),!0),this.view.watch("pointsOfInterest",(e=>{this._renderer.pointsOfInterest=e,this._handles.remove("poi"),e&&this._handles.add(e.focus.watch("renderLocation",(()=>this._allTilesSorted=!1)),"poi")})),R.whenTrue(q,"TERRAIN_DEBUG_POPUP",(()=>{new Promise((function(t,i){e(["./support/TerrainDebugPopupOpener"],t,i)})).then((e=>{const t=new e.TerrainDebugPopupOpener({surface:this});R.whenFalseOnce(q,"TERRAIN_DEBUG_POPUP",(()=>t.destroy()))}))}))]);const t={layers:this.view.map.allLayers,layerViews:this.view.allLayerViews,spatialReference:this.view.spatialReference};this.extentHelper="spherical"===this.manifold?new J.SurfaceExtentHelperGlobal(t):new J.SurfaceExtentHelperLocal(t),this._handles.add(R.init(this.extentHelper,"stencilEnabledExtents",(e=>this._renderer.setStencilEnabledLayerExtents(e))),"extentHelper");const i=this.view.defaultsFromMap?new b({root:this.view.map,rootCollectionNames:this.view.defaultsFromMap.mapCollectionPaths,getChildrenFunction:e=>e.layers}):this.view.map.allLayers,r=new Q({layers:i,extentHelper:this.extentHelper,manifold:this.manifold,viewSpatialReference:this.view.spatialReference});this._set("tilingSchemeLogic",r),this._handles.add([this.tilingSchemeLogic.watch("tilingScheme",(()=>this._updateTilingSchemeAndExtent()),!0),this.tilingSchemeLogic.watch("extent",(()=>this._updateTilingSchemeAndExtent()),!0)],"tilingSchemeLogic"),this._updateTilingSchemeAndExtent(),this._elevationDataRequester=this.view.resourceController.createStreamDataRequester(0),this._mapDataRequester=this.view.resourceController.createStreamDataRequester(1);const s=this.view.resourceController.scheduler;this._frameTask=s.registerTask(C.Task.TERRAIN_SURFACE,(e=>this._update(e)),(()=>this.updating)),this.view.resourceController.memoryController.events.on("quality-changed",(()=>this._viewChangeUpdate())),this._handles.add([this.view.on("resize",(()=>this._viewChangeUpdate())),this.view.watch("state.camera",(()=>this._viewChangeUpdate()),!0),this.view.watch("qualitySettings.tiledSurface.lodBias",(()=>this._viewChangeUpdate())),R.init(this.view,"qualitySettings.tiledSurface.textureFadeDuration",(e=>this._renderer.textureFadingEnabled=e>0)),this.view.watch("lodSnapping",(()=>this._viewChangeUpdate())),this.view.watch("clippingArea",(()=>this._clippingChanged()))]),this._handles.add(this.view.allLayerViews.on("after-changes",(()=>this._layerViewsDirty=!0))),this._layerViewsDirty=!0,this._handleLayerViewChanges(),this._updateClippingExtent(),this.notifyChange("extent")},n.destroy=function(){this._frameTask.remove(),this._handles.destroy(),M.releaseDecoder(this._lercDecoder),this._lercDecoder=null,this._removeAllTiles(),this._upsampleMapCache=s.destroyMaybe(this._upsampleMapCache),this._set("tilingSchemeLogic",s.destroyMaybe(this.tilingSchemeLogic)),this.extentHelper=s.destroyMaybe(this.extentHelper),this._basemapLayerViewHandles.forEach(((e,t)=>this._unregisterTiledLayerView(t))),this._elevationDataRequester=null,this._mapDataRequester=null,this._set("overlayManager",s.destroyMaybe(this.overlayManager)),this._tilePool=s.destroyMaybe(this._tilePool),z.pruneAgents(),this._renderer.uninstall(this._stage),this._renderer=s.destroyMaybe(this._renderer),this._iteratorPool=s.destroyMaybe(this._iteratorPool),this._set("view",null),this._stage=null,this._upsampleInfoPool=s.destroyMaybe(this._upsampleInfoPool)},n.isOpaque=function(){return this._renderer.opaque},n.intersect=function(e,t,i,r){this._renderer.intersect(e,t,i,r)},n.getElevation=function(e,t,i,r){const s=this._getElevationData.rootTiles;if(!s||!s.length)return null;if(0===s[0].layerInfo[0].length)return null;const n=oe;if(n[0]=e,n[1]=t,n[2]=i,!O.projectVectorToVector(n,r,n,this._getElevationData.spatialReference))return ie.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;for(let e of s){if(!e.containsPoint(n))continue;for(;e&&!e.rendered&&!e.isLeaf;){let t=0;n[0]>.5*(e.extent[0]+e.extent[2])&&(t+=1),n[1]<.5*(e.extent[1]+e.extent[3])&&(t+=2),e=e.children[t]}const t=e.renderData,i=t&&t.geometryState?t.geometryState.samplerData:null;return i?G.ElevationData.sample(n[0],n[1],i):null}return null},n.getScale=function(e){if(this.tilingScheme){if(!O.projectPointToVector(e,oe,this.spatialReference))return ie.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;const t=this.rootTiles;if(t)for(let e of t)if(e.containsPoint(oe)){for(;null!=e.children[0];){let t=0;oe[0]>e.children[0].extent[2]&&(t+=1),oe[1]<e.children[0].extent[1]&&(t+=2),e=e.children[t]}return this._getLodBiasCorrectedScale(e.level)}}return 1e100},n.queryVisibleScaleRange=function(e,t,i,r){const s=t?this.tilingScheme.levelAtScale(t):0,n=i?this.tilingScheme.levelAtScale(i):1/0,a=this.lodBias;this._renderer.queryVisibleLevelRange(e,s+a,n+a,r)},n._updateBaseOpacity=function(e){const t=this._renderer.opaque;this._renderer.opaque=e>=1,this._renderer.isTransparent=this.allTransparentSurfaceLayers();const i=t!==this._renderer.opaque;this._updateTileTextures(i)},n._updateTilingSchemeAndExtent=function(){const e=this.tilingSchemeLogic.extent,t=e&&!E.equals(e,this._dataExtent);t&&(this._dataExtent?E.set(this._dataExtent,e):this._dataExtent=E.create(e));const i=this.tilingSchemeLogic.tilingScheme,r=i!==this.tilingScheme;r&&(F.weakAssert(!!i,"tiling scheme cannot be reset to undefined"),this.tilingScheme&&this._removeAllTiles(),this._set("tilingScheme",i),this._updateClippingExtent(),i&&(this._updateTiledLayers(),this._renderer.setTileSize(i.pixelSize),this.overlayManager.setSpatialReference(i.spatialReference,"spherical"===this.manifold))),(t||r)&&this._updateRootTiles()},n._acquireTile=function(e,t,i,r){const s=this._tilePool.acquire();return he[0]=e,he[1]=t,he[2]=i,s.init(he,r,this),s},n._updateRootTiles=function(){const e=this._clippingExtent||this._dataExtent,t=this.tilingScheme;if(!e||!t)return;const i=de;let r=t.rootTilesInExtent(e,i,5*I.MAX_ROOT_TILES);const s=e=>{const t=this._acquireTile(0,e[1],e[2],null);return 2===t.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping)&&t.setPendingUpdate(2),this._loadTile(t),t};if(this.rootTiles){if(r.length>I.MAX_ROOT_TILES)return void ie.warn(I.TOO_MANY_ROOT_TILES_AFTER_CHANGE_ERROR);const e=this.rootTiles.map((e=>e.lij)),t=_.difference(e,r,ne);if(t.removed.length>0||t.added.length>0){const e=this.rootTiles.filter((e=>!(t.removed.findIndex(ne.bind(null,e.lij))>-1)||(this._purgeTile(e),!1)));t.added.forEach((t=>e.push(s(t)))),this._setRootTiles(e)}}else r.length>I.MAX_ROOT_TILES&&(ie.warn(I.TOO_MANY_ROOT_TILES_FOR_LAYER_ERROR),r=t.rootTilesInExtent(e,i,I.MAX_ROOT_TILES)),this._setRootTiles(r.map((e=>s(e))));E.equals(i,this._rootExtent)||(this._rootExtent=E.create(i),this._hasFixedExtent()||this.notifyChange("extent")),this.visible=!0,this._viewChangeUpdate(),this.overlayManager.setOverlayPlacementDirty(),this.notifyChange("ready")},n._setRootTiles=function(e){if(this._set("rootTiles",e),this._allTiles.clear(),e){const t=this._iteratorPool.acquire();for(t.reset(e);!t.done;)this._allTiles.push(t.next());this._iteratorPool.release(t)}this._getElevationData.rootTiles=e,this._renderer.setRootTiles(this.rootTiles),this._updateTileVisibility(e)},n._runViewChangeUpdateIfDirty=function(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())},n._viewChangeUpdate=function(){this._stage&&!this.suspended&&this.tilingScheme&&this._visible&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateSkirts(),this.updateOverlayOpacity(),this._updateTileVisibility(this.rootTiles)))},n._updateClippingStatus=function(e){e.updateClippingStatus(this._clippingExtent)&&e.resetPendingUpdate(32)&&this._updateTileGeometry(e)},n._updateTileVisibility=function(e){if(!e)return;const t=this._iteratorPool.acquire();let i,r;for(t.reset(e),Y.hasVisibleSiblings(e)?(i=this._elevationBounds.min,r=this._elevationBounds.max):(i=1/0,r=-1/0);!t.done;){const e=t.next();this._updateClippingStatus(e),e.updateVisibility(),e.setPendingUpdate(16),e.visible?(e.updateScreenDepth(this._viewProjectionMatrix),e.renderData&&(i=Math.min(e.elevationBounds[0],i),r=Math.max(e.elevationBounds[1],r))):t.skipSubtree()}this._iteratorPool.release(t),this._viewChanged=!0,this._allTilesDirty=!0,isFinite(i)&&isFinite(r)&&(this._elevationBounds.min===i&&this._elevationBounds.max===r||(this._elevationBounds.min=i,this._elevationBounds.max=r,this.emit("elevation-bounds-change",null)))},n._updateViewDependentParameters=function(){const e=this.view.state.camera,t=Math.tan(.5*e.fovX),i=Math.tan(.5*e.fovY),r=this.tilingScheme.pixelSize,s=Math.pow(2,-this.lodBias)*e.pixelRatio;this._splitLimits.aboveGround=e.aboveGround,this._splitLimits.fovX=t,this._splitLimits.fovY=i,this._splitLimits.relativeWidthLimit=r/e.width*this.maxTextureScale*s,this._splitLimits.relativeHeightLimit=r/e.height*this.maxTextureScale*s,this._splitLimits.maxLod=this.tilingScheme.getMaxLod(),this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias,B.frustum.copy(e.frustum,this._frustum),D.multiply(this._viewProjectionMatrix,e.projectionMatrix,e.viewMatrix),L.copy(this._eyePosRenderSR,e.eye),O.projectVectorToVector(this._eyePosRenderSR,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)},n._updateSnapLevel=function(){if(0===this.lodSnapping)return!1;const e=this._computeSnapLevel();if(Math.abs(this._snapLevel-e)<.25)return!1;const t=this.snapLevel;return this._snapLevel=e,t!==this.snapLevel},n._computeSnapLevel=function(){if(this._visibleLevels.length<=0)return this._snapLevel;const e=Math.abs(this.view.camera.tilt-90)/90*.4+.3,t=this._visibleLevels,i=Math.round(t.length*e);if(i>=t.length)return this._snapLevel;t.sort(((e,t)=>e-t));let r=0;for(let e=i;e<t.length;++e)r+=t.getItemAt(e);const s=t.getItemAt(Math.round(.95*t.length)-1),n=r/(t.length-i);return T.clamp(n,s-1,this._splitLimits.maxLod)},n._updateSkirts=function(){const e=this.view.state.camera,t=this.view.state.constraints.collision.enabled?0:1.11*e.near;this.skirtScale=F.computeSkirtScale(this,this._eyePosSurfaceSR,t)},n._updateRenderData=function(e){e.rendered&&!e.shouldRender&&(ae(e)?this._loadChildren(e):function(e){return e.isLeaf&&e.parent&&e.parent.shouldRender}(e)&&this._loadParent(e))},n._updateTileGeometry=function(e){e.updateVisibility(),this._renderer.updateTileGeometry(e),this._elevationUpdate(e),this._usedMemory=le},n._elevationUpdate=function(e){ue.spatialReference=this.spatialReference,ue.tile=e,ue.extent=e.extent,this.emit("elevation-change",ue),E.containsPoint(e.extent,this._eyePosSurfaceSR)&&this._updateSkirts()},n._update=function(e){this._handleLayerViewChanges(e),this._inFrameTask=!0,this.pendingUpdates=!1,this._updateTileStatus(e),this._sortTiles(e),this._mergeAndSplit(e),e.run((()=>this._updateElevation(e))),e.run((()=>this._updateTextures(e))),this._inFrameTask=!1,this._runViewChangeUpdateIfDirty(),e.done&&(this.pendingUpdates=!0)},n._updateTileStatus=function(e){if(!this._viewChanged||!this.rootTiles||e.done)return;this._viewChanged=!1;const t=this._iteratorPool.acquire();for(t.reset(this.rootTiles);!t.done;){const e=t.next();if(e.visible){const i=e.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping);if(2===i){e.resetPendingUpdate(8),e.isLeaf&&(e.setPendingUpdate(2),t.skipSubtree());continue}e.resetPendingUpdate(2)&&e.updateAgentSuspension(),4===i&&e.updateAgents(0)}if(t.skipSubtree(),!e.isLeaf){e.setPendingUpdate(8),e.resetPendingUpdate(2);const t=this._iteratorPool.acquire();t.resetOne(e);for(let e=t.next();!t.done;e=t.next())this._updateClippingStatus(e),e.updateVisibility(),e.visible&&e.updateScreenDepth(this._viewProjectionMatrix);this._iteratorPool.release(t)}}this._iteratorPool.release(t),this.pendingUpdates=!0,e.madeProgress()},n._sortTiles=function(e){e.done||this._allTilesSorted||(Y.sortTilesByPOI(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,e.madeProgress())},n._mergeAndSplit=function(e){if(this.suspended||!this._allTilesDirty||e.done)return;this._allTilesDirty=!1,this.pendingUpdates=!0;const t=this._eyePosRenderSR;let i=0;const r=1===this.lodSnapping?e=>{const i=e.shouldSplit(this._splitLimits,t,0);e.visible&&(2!==i&&e.parent&&2===e.parent.shouldSplit(this._splitLimits,t,0)?1===i?this._visibleLevels.fill(e.level+1,4):this._visibleLevels.push(e.level):e.isLeaf&&2===i&&this._visibleLevels.fill(e.level+1,3))}:()=>{};for(;!e.done;){let t=!1;i=0,this._visibleLevels.clear();const s=!this._allTiles.some((s=>(i+=s.usedMemory,r(s),s.resetPendingUpdate(8)?(this._mergeTile(s),t=!0,e.madeProgress()):s.resetPendingUpdate(2)&&(this._splitTile(s),t=!0,e.madeProgress()),s.resetPendingUpdate(16)&&(this._updateRenderData(s),e.madeProgress()),e.done)));if(t&&(this._allTilesSorted=!1,this._allTilesDirty=!0),s){if(this._usedMemory=i,!t){if(!this._updateSnapLevel())break;this._updateTileVisibility(this.rootTiles)}}else this._allTilesDirty=!0}0===i&&(this._allTilesDirty=!0),this._visibleLevels.clear(),this._sortTiles(e)},n._updateElevation=function(e){return this._allTiles.some((t=>(t.resetPendingUpdate(32)&&(this._updateTileGeometry(t),e.madeProgress()),e.done))),e.hasProgressed},n._updateTextures=function(e){return this._allTiles.some((t=>(t.resetPendingUpdate(64)&&(this._renderer.updateTileTexture(t),this._usedMemory=le,e.madeProgress()),e.done))),e.hasProgressed},n._updateClippingExtent=function(){if(!this.spatialReference)return!1;const e=E.create();let t=null;return j.toBoundingRect(this.view.clippingArea,e,this.spatialReference)&&(t=e),!E.equals(t,this._clippingExtent)&&(this._clippingExtent=t,this._renderer.clippingExtent=t,this.notifyChange("extent"),this.updateTileOverlayParams(),this.overlayManager.setOverlayPlacementDirty(),!0)},n._clippingChanged=function(){this._updateClippingExtent()&&this._updateRootTiles()},n._getLodBiasCorrectedScale=function(e){const t=this.tilingScheme.levels,i=T.clamp(e-this.lodBias,0,t.length-1),r=i-Math.floor(i);return t[Math.floor(i)].scale*(1-r)+t[Math.ceil(i)].scale*r},n._removeAllTiles=function(){this.rootTiles&&(this.rootTiles.forEach((e=>this._purgeTile(e))),this._setRootTiles(null),this.notifyChange("ready")),this._allTiles.clear(),this.visible=!1},n._purgeChildTiles=function(e){if(e.isLeaf)return!1;let t=this._purgeTile(e.children[0]);return t=this._purgeTile(e.children[1])||t,t=this._purgeTile(e.children[2])||t,t=this._purgeTile(e.children[3])||t,e.unsetChildren(),t},n._purgeTile=function(e){const t=this._purgeChildTiles(e)||e.rendered;return this._allTiles.removeUnordered(e),e.unload(this._renderer),this._tilePool.release(e),t},n._splitTile=function(e){F.weakAssert(e.isLeaf,"tile that is already split should not be split again!");const t=e.level+1,i=2*e.lij[1],r=2*e.lij[2];e.setChildren(this._createTile(t,i,r,e),this._createTile(t,i,r+1,e),this._createTile(t,i+1,r,e),this._createTile(t,i+1,r+1,e)),e.setPendingUpdate(16),e.updateAgentSuspension(),this._allTiles.pushArray(e.children),this._allTilesDirty=!0,this._emitTileScaleChange(e,t),++this._performanceInfo.numSplit},n._emitTileScaleChange=function(e,t=e.level){pe.spatialReference=this.spatialReference,pe.extent=e.extent,pe.scale=this._getLodBiasCorrectedScale(t),this.emit("scale-change",pe)},n._createTile=function(e,t,i,r){F.weakAssert(!!r,"_createTile sanity check");const s=this._acquireTile(e,t,i,r);return s.updateClippingStatus(this._clippingExtent),s.visible&&(s.updateScreenDepth(this._viewProjectionMatrix),2===s.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping)&&s.setPendingUpdate(2)),s},n._mergeTile=function(e){F.weakAssert(!e.hasPendingUpdate(2),"_mergeTile sanity check"),this._purgeChildTiles(e)&&(F.weakAssert(!e.renderData,"_mergeTile sanity check"),this._loadTile(e)),this._allTilesDirty=!0,++this._performanceInfo.numMerged,this._emitTileScaleChange(e)},n._loadChildren=function(e){F.weakAssert(e.rendered,"parent should be rendered"),e.unload(this._renderer),this._loadTile(e.children[0]),this._loadTile(e.children[1]),this._loadTile(e.children[2]),this._loadTile(e.children[3])},n._loadParent=function(e){const t=e.parent;this._unloadChildren(t),this._loadTile(t)},n._unloadChildren=function(e){e.isLeaf||(this._unloadChildren(e.children[0]),e.children[0].unload(this._renderer),this._unloadChildren(e.children[1]),e.children[1].unload(this._renderer),this._unloadChildren(e.children[2]),e.children[2].unload(this._renderer),this._unloadChildren(e.children[3]),e.children[3].unload(this._renderer))},n._loadTile=function(e){e.load(this._renderer),e.setPendingUpdate(16),this.pendingUpdates=!0,this.overlayManager&&this.overlayManager.hasOverlays&&this.overlayManager.setTileParameters(e),this._elevationUpdate(e)},n._elevationDataArrived=function(e,t,i){const r=new G.ElevationData(e.lij,e.extent,i);e.dataArrived(t,0,r);const s=[e],n=e.level,a=this._iteratorPool.acquire();for(a.reset(s);!a.done;){const e=a.next();e.findElevationBoundsForLayer(t,n),e.computeElevationBounds()}this._iteratorPool.release(a),this._updateTileVisibility(s)},n._handleLayerViewChanges=function(e=C.noBudget){if(!this._layerViewsDirty)return;this._layerViewsDirty=!1;let t=!1;const i=new Set;let r=-1;for(const e of this.view.allLayerViews.items)if(i.add(e.uid),F.isSurfaceLayerView(e))if(this._basemapLayerViewHandles.has(e.uid)){const i=this.layerClassFromLayerView(e),s=this._layerIndexByLayerViewId[i].get(e.uid);s<r&&(t=!0),r=s}else this._registerTiledLayerView(e),e.layer.loaded&&(t=!0);this._basemapLayerViewHandles.forEach(((e,r)=>{i.has(r)||(this._unregisterTiledLayerView(r),t=!0)})),t&&this._updateTiledLayers(),this._renderer.isTransparent=this.allTransparentSurfaceLayers(),e.madeProgress()},n.allTransparentSurfaceLayers=function(){let e=0===this.view.map.ground.opacity;for(const t of this.view.allLayerViews.items)if(F.isSurfaceLayerView(t)&&!F.isElevationLayerView(t)&&!A.isBaseLayer(t.layer)&&0!==t.fullOpacity)return e=!1,e;return e},n.layerClassFromLayerView=function(e){return F.isElevationLayerView(e)?0:1},n._registerTiledLayerView=function(e){const t=[],i=this.layerClassFromLayerView(e);t.push(e.watch("suspended",(()=>this._updateTiledLayers()))),t.push(e.watch("fullOpacity",(()=>this._updateTileTextures(!1)))),t.push(e.layer.watch("scaleRangeId",(()=>this._restartAllAgents(i)))),e.on("data-changed",(()=>{const t=this._layerIndexByLayerViewId[i].get(e.uid);null!=t&&this._invalidateLayerData(t,i)})),this._basemapLayerViewHandles.set(e.uid,t)},n._unregisterTiledLayerView=function(e){const t=this._basemapLayerViewHandles.get(e);if(t){for(let e=0;e<t.length;e++)t[e].remove();this._basemapLayerViewHandles.delete(e)}},n._updateTiledLayers=function(){if(!this.tilingScheme||this.view.suspended)return;const e=this.view.allLayerViews,t=[[],[]];let i=null;const r=E.empty();e.forEach((e=>{const s=e.layer;if(!s||e.suspended||!F.isSurfaceLayerView(e))return;const n=e.fullExtent;if(!n)return void ie.warn("Terrain: Map or elevation layer does not have fullExtent: "+s.id);if(!this.tilingScheme.compatibleWith(e.tileInfo))return void ie.warn("Terrain: tiling scheme of layer "+s.id+" is incompatible with other tiled layers, will not be drawn");E.expand(r,n);const a=this.layerClassFromLayerView(e);if(1===a){const t=e.displayLevelRange;t.maxLevel!==1/0&&(null===i||t.maxLevel>i)&&(i=t.maxLevel)}t[a].push(e)}));for(let e=0;e<2;e++){const i=this._layerViews[e],r=t[e];r.reverse();const s=r.length;let n=i.length!==s;const a=new Array(s),l=new Array(i.length);this._layerIndexByLayerViewId[e].clear();for(let t=0;t<s;t++){const s=r[t].uid;this._layerIndexByLayerViewId[e].set(s,t);const o=i.indexOf(r[t]);a[t]=o,t!==o&&(n=!0),o>-1&&(l[o]=t)}if(n){const t=this._postorderIterator;for(t.reset(this.rootTiles);!t.done;)t.next().modifyLayers(l,a,e);this._layerViews[e]=r,this._restartAllAgents(e),this._updateTileVisibility(this.rootTiles)}}this.tilingScheme.ensureMaxLod(i)&&this._viewChangeUpdate()},n._restartAllAgents=function(e){const t=this._postorderIterator;for(t.reset(this.rootTiles);!t.done;){const i=t.next();i.restartAgents(e),0===e&&i.computeElevationBounds()}},n._hasFixedExtent=function(){return!!this._clippingExtent},n.layerViewByIndex=function(e,t){return this._layerViews[t][e]},n.numLayers=function(e){return this._layerViews[e].length},n._updateTileTextures=function(e){this._allTiles.forAll((t=>{t.updateAgents(1),e?this.renderer.updateTileTexture(t):t.updateRenderData(1)})),this._renderer.isTransparent=this.allTransparentSurfaceLayers()},n._invalidateLayerData=function(e,t){this._allTiles.forAll((i=>i.removeLayerAgent(e,t))),this._allTiles.forAll((i=>i.invalidateLayerData(e,t)))},n.setTileTreeDirty=function(){this._allTilesDirty=!0},n.requestRender=function(e=1){this.renderer.setNeedsRender(e)},n.requestTileData=function(e,t,i,r){const s=this.layerViewByIndex(t,i),n=s.layer;return!n.tilemapCache||F.isVectorTileLayerView(s)?this._requestTileData(e,i,s,r):(++this._asyncWorkItems,n.tilemapCache.fetchAvailability(e.lij[0],e.lij[1],e.lij[2],{...r,timeout:6e3}).then((()=>--this._asyncWorkItems)).catch((t=>{throw--this._asyncWorkItems,g.isAbortError(t)||this._dataMissing(e,i,s,{notInTilemap:!0}),t})).then((()=>this._frameTask.schedule((()=>this._requestTileData(e,i,s,r)),r.signal))))},n._requestTileData=function(e,t,i,r){return 0===t?this._requestElevationTileData(e,i,r):this._requestMapTileData(e,i,r)},n._requestElevationTileData=function(e,t,i){if(!F.isElevationLayerView(t))return void F.weakAssert(!1,"_requestElevationTileData can only be called for elevation layer views");const r=r=>{if(--this._asyncWorkItems,g.isAborted(i))return;const s=this._layerIndexByLayerViewId[0].get(t.uid);null!=s?(this._usedMemory=le,this.pendingUpdates=!0,this._elevationDataArrived(e,s,r)):ie.warn("TerrainSurface: received data from unknown layer %d %s",0,e.lij.toString())},s=i=>{--this._asyncWorkItems,g.isAbortError(i)||(this._dataMissing(e,0,t,i),this.pendingUpdates=!0)};if(++this._asyncWorkItems,F.useFetchTileForLayer(t.layer))return t.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],{noDataValue:I.ELEVATION_NODATA_VALUE,signal:i.signal}).then((e=>{if(g.isAborted(i))return ie.warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),void s(g.createAbortError());r(e)}),s);const n=t.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);return this._elevationDataRequester.request(n,"binary",i).then((e=>this._lercDecoder.decode(e,{noDataValue:I.ELEVATION_NODATA_VALUE},i.signal))).then((e=>{r({values:e.pixelData,width:e.width,height:e.height,noDataValue:e.noDataValue,minValue:e.minValue,maxValue:e.maxValue})}),s)},n._requestMapTileData=function(e,t,i){if(t instanceof N)return g.reject();++this._asyncWorkItems;const r=r=>this._frameTask.schedule((()=>{--this._asyncWorkItems,this.pendingUpdates=!0,g.isAborted(i)?F.releaseTileData(r):this._dataArrived(e,1,t,r)}),i.signal).catch(s),s=r=>this._frameTask.schedule((()=>{--this._asyncWorkItems,g.isAborted(i)||(this._dataMissing(e,1,t,r),this.pendingUpdates=!0)}));if(F.isVectorTileLayerView(t)){const n=t.schemaHelper.getLevelRowColumn(e.lij);return t.tileHandler.getVectorTile(n[0],n[1],n[2],i).then((e=>{e.neededForCoverage=!0,e.transforms.tileUnitsToPixels=U.fromValues(1/8,0,0,0,1/8,0,0,0,1),H.declutterSingleTile(e,t.layer.styleRepository),r(e)}),s)}if(F.isImageryTileLayerView(t))return t.fetchTile(e.lij[0],e.lij[1],e.lij[2],i).then(r,s);if(F.useFetchTileForLayer(t.layer)&&F.isTileLayerView(t))return t.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],i).then((e=>{if(g.isAborted(i))return ie.warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),void s(g.createAbortError());r(e)}),s);let n=t.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);(function(e){return null!=e.refreshInterval})(t)&&t.refreshTimestamp&&(n+=`${n.indexOf("?")>-1?"&":"?"}_ts=${t.refreshTimestamp}`);const a=t.hasMixedImageFormats?"image+type":"image";return this._mapDataRequester.request(n,a,i).then(r,s)},n._dataArrived=function(e,t,i,r){const s=this._layerIndexByLayerViewId[t].get(i.uid);null!=s?e.dataArrived(s,t,r):ie.warn("TerrainSurface: received data from unknown layer")},n._dataMissing=function(e,t,i,r){const s=this._layerIndexByLayerViewId[t].get(i.uid);null!=s?e.dataMissing(s,t,r):ie.warn("TerrainSurface: received data from unknown layer")},n.updateTileOverlayParams=function(){this.rootTiles&&this.overlayManager&&(this._allTiles.forAll((e=>{e.renderData&&this.overlayManager.setTileParameters(e)})),this._renderer.setNeedsRender())},n.updateOverlayOpacity=function(){if(!this.overlayManager)return;const e=this._eyePosSurfaceSR[2],t=this.overlayManager.computeOpacity(e);t!==this._overlayOpacity&&(this._overlayOpacity=t,this._renderer.overlayOpacity=t,this._renderer.setNeedsRender())},n.getUsedMemory=function(){return this.tilingScheme?(this._usedMemory===le&&(this._usedMemory=0,this._allTiles.forAll((e=>this._usedMemory+=e.usedMemory))),this._usedMemory):0},n.getUsedMemoryForLayerView=function(e){let t=0;const i=this.layerClassFromLayerView(e),r=this._layerIndexByLayerViewId[i].get(e.uid);return this._allTiles.forAll((e=>t+=e.getUsedMemoryForLayer(i,r))),t},n.getTile=function(e){const t=e.split("/").map((e=>+e));if(0===t[0])return this.rootTiles.find((e=>e.lij[1]===t[1]&&e.lij[2]===t[2]));const i=Math.pow(2,t[0]),r=Math.floor(t[1]/i),s=Math.floor(t[2]/i);let n;if(this.rootTiles.some((e=>e.lij[1]===r&&e.lij[2]===s&&(n=e,!0))),n){let e=1<<t[0]-1;for(;n.lij[0]<t[0];){let i=t[1]&e?2:0;if((t[2]&e)>0&&i++,!n.children[i])return null;n=n.children[i],e>>=1}return F.weakAssert(n.lij[0]===t[0]&&n.lij[1]===t[1]&&n.lij[2]===t[2],"not the right tile?"),n}return null},n.getRenderedTiles=function(){return ce.clear(),this._allTiles.forAll((e=>{e.visible&&e.rendered&&ce.push(e)})),Y.sortTiles(this.renderOrder,ce),ce.toArray()},t._createClass(r,[{key:"renderer",get:function(){return this._renderer}},{key:"frustum",get:function(){return this._frustum}},{key:"snapLevel",get:function(){return Math.round(this._snapLevel)}},{key:"upsampleInfoPool",get:function(){return this._upsampleInfoPool}},{key:"upsampleMapCache",get:function(){return this._upsampleMapCache}},{key:"extent",get:function(){return this._clippingExtent||this._rootExtent}},{key:"updating",get:function(){return!(!(this.pendingUpdates||this._viewChanged||this._allTilesDirty||this._asyncWorkItems>0||!this._allTilesSorted||this._renderer.updating||this.overlayManager.updating||this._layerViewsDirty||this._frameTask.updating)||!this.ready||this.suspended)}},{key:"ready",get:function(){return!!this.rootTiles}},{key:"renderOrder",set:function(e){this._renderer.renderOrder=e,this._set("renderOrder",e)}},{key:"skirtScale",set:function(e){this._renderer.skirtScale=e},get:function(){return this._renderer.skirtScale}},{key:"spatialReference",get:function(){const e=this.tilingScheme&&this.tilingScheme.spatialReference||null;return this._getElevationData.spatialReference=e,e}},{key:"_background",get:function(){return null!=this.backgroundColor?this.backgroundColor:this.backgroundImage}},{key:"slicePlaneEnabled",set:function(e){this._renderer.slicePlane=e,this._set("slicePlaneEnabled",e)}},{key:"velvetOverground",set:function(e){e!==this.velvetOverground&&(this._renderer.velvetOverground=e),this._set("velvetOverground",e)}},{key:"visible",set:function(e){e!==this._visible&&(this._visible=e,this._renderer.setVisibility(e),this.suspended=!e)}},{key:"suspended",set:function(e){this._set("suspended",e),this._viewChangeUpdate()}},{key:"lodSnapping",get:function(){return v.isEarth(this.spatialReference)&&this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences?1:0}},{key:"elevationBounds",get:function(){return this._elevationBounds}},{key:"lodBias",get:function(){const e=this.view.resourceController.memoryController.memoryFactor;return this.view.qualitySettings.tiledSurface.lodBias-(1-e)*I.MAX_MEMORY_LOD_BIAS}},{key:"performanceInfo",get:function(){const e=this._performanceInfo;return e.numNodes=this._allTiles.length,e.numLeaves=e.numVisible=e.numRendered=e.numLoadedPerLevel.length=e.numRenderedPerLevel.length=0,this._allTiles.forAll((t=>{t.isLeaf&&e.numLeaves++;const i=t.level;t.renderData&&(e.numLoadedPerLevel[i]=(e.numLoadedPerLevel[i]||0)+1),t.visible&&(e.numVisible++,t.rendered&&(e.numRenderedPerLevel[i]=(e.numRenderedPerLevel[i]||0)+1,e.numRendered++))})),e}},{key:"test",get:function(){const e=this;return{renderer:e._renderer,lercDecoder:e._lercDecoder,forceReload:()=>{e._mergeTile(e.rootTiles[0]),e._viewChangeUpdate()},getTiles:()=>e._allTiles.toArray()}}}]),r}(m.EventedMixin(f));i.__decorate([l.property()],re.prototype,"_renderer",void 0),i.__decorate([l.property()],re.prototype,"pendingUpdates",void 0),i.__decorate([l.property()],re.prototype,"_asyncWorkItems",void 0),i.__decorate([l.property()],re.prototype,"_allTilesDirty",void 0),i.__decorate([l.property()],re.prototype,"_allTilesSorted",void 0),i.__decorate([l.property()],re.prototype,"_viewChanged",void 0),i.__decorate([l.property()],re.prototype,"_frameTask",void 0),i.__decorate([l.property({constructOnly:!0})],re.prototype,"view",void 0),i.__decorate([o.aliasOf("_renderer.cullBackFaces")],re.prototype,"cullBackFaces",void 0),i.__decorate([l.property({readOnly:!0,dependsOn:[],autoTracked:!1})],re.prototype,"extent",null),i.__decorate([l.property({readOnly:!0,dependsOn:["ready","suspended","pendingUpdates","_asyncWorkItems","_allTilesDirty","_allTilesSorted","_renderer.updating","_layerViewsDirty","overlayManager.updating","_frameTask.updating"]})],re.prototype,"updating",null),i.__decorate([l.property({aliasOf:"view.map.ground.opacity"})],re.prototype,"baseOpacity",void 0),i.__decorate([l.property({readOnly:!0})],re.prototype,"overlayManager",void 0),i.__decorate([l.property({constructOnly:!0})],re.prototype,"manifold",void 0),i.__decorate([l.property()],re.prototype,"maxTextureScale",void 0),i.__decorate([l.property({readOnly:!0,autoTracked:!0})],re.prototype,"ready",null),i.__decorate([l.property({value:1})],re.prototype,"renderOrder",null),i.__decorate([l.property({readOnly:!0})],re.prototype,"rootTiles",void 0),i.__decorate([l.property({readOnly:!0,dependsOn:["tilingScheme.spatialReference"]})],re.prototype,"spatialReference",null),i.__decorate([l.property()],re.prototype,"backgroundImage",void 0),i.__decorate([l.property({type:w,aliasOf:"view.map.ground.surfaceColor"})],re.prototype,"backgroundColor",void 0),i.__decorate([l.property({dependsOn:["backgroundColor","backgroundImage"]})],re.prototype,"_background",null),i.__decorate([l.property({value:!1})],re.prototype,"slicePlaneEnabled",null),i.__decorate([l.property({readOnly:!0})],re.prototype,"tilingScheme",void 0),i.__decorate([l.property({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeLocked"})],re.prototype,"tilingSchemeLocked",void 0),i.__decorate([l.property({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeDone"})],re.prototype,"tilingSchemeDone",void 0),i.__decorate([l.property({readOnly:!0})],re.prototype,"tilingSchemeLogic",void 0),i.__decorate([l.property({value:!0})],re.prototype,"velvetOverground",null),i.__decorate([o.aliasOf("_renderer.wireframe")],re.prototype,"wireframe",void 0),i.__decorate([l.property({value:!1})],re.prototype,"suspended",null),i.__decorate([l.property({readOnly:!0,dependsOn:["view.qualitySettings.tiledSurface.reduceTileLevelDifferences"]})],re.prototype,"lodSnapping",null),i.__decorate([l.property({readOnly:!0,aliasOf:"view.qualitySettings.tiledSurface.textureFadeDuration"})],re.prototype,"textureFadeDuration",void 0),i.__decorate([l.property()],re.prototype,"_layerViewsDirty",void 0),i.__decorate([o.aliasOf("_renderer.renderPatchBorders")],re.prototype,"renderPatchBorders",void 0),i.__decorate([o.aliasOf("_renderer.renderingDisabled")],re.prototype,"renderingDisabled",void 0),re=i.__decorate([d.subclass("esri.views.3d.terrain.TerrainSurface")],re);var se=re;function ne(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function ae(e){return!e.isLeaf&&(e.children[0].shouldRender||e.children[1].shouldRender||e.children[2].shouldRender||e.children[3].shouldRender||ae(e.children[0])||ae(e.children[1])||ae(e.children[2])||ae(e.children[3]))}const le=-1,oe=k.create(),de=E.create(),he=[0,0,0],ce=new y,ue={spatialReference:null,tile:null,extent:null,context:"ground"},pe={spatialReference:null,extent:null,scale:0};return se}));
