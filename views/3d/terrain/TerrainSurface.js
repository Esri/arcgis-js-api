// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../Color","../../../core/Accessor","../../../core/arrayUtils","../../../core/CollectionFlattener","../../../core/Evented","../../../core/Handles","../../../core/Logger","../../../core/mathUtils","../../../core/ObjectPool","../../../core/PooledArray","../../../core/promiseUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators","../../../core/libs/gl-matrix-2/mat3f32","../../../core/libs/gl-matrix-2/mat4","../../../core/libs/gl-matrix-2/mat4f64","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../../../core/libs/gl-matrix-2/vec4f64","../../../geometry/support/aaBoundingRect","../../../layers/support/layerUtils","../../../layers/support/LercDecoder","../../2d/engine/vectorTiles/decluttering/jobsUtil","../layers/ElevationLayerView3D","../support/debugFlags","../support/extentUtils","../support/geometryUtils","../support/pointUtils","../support/projectionUtils","./ElevationBounds","./ElevationData","./OverlayManager","./PlanarPatch","./SphericalPatch","./SurfaceExtentHelper","./SurfaceTilingSchemeLogic","./TerrainConst","./TerrainRenderer","./terrainUtils","./Tile","./tileUtils","./UpsampleInfo","../../support/Scheduler","@dojo/framework/shim/Promise"],(function(e,t,r,i,n,a,s,o,l,d,u,p,h,c,_,y,f,g,v,m,T,w,S,L,b,x,P,O,E,R,D,C,V,M,U,A,I,j,k,B,q,F,H,N,W,G){"use strict";var X=d.getLogger("esri.views.3d.terrain.TerrainSurface"),Y=function(t){function n(e){var r=t.call(this,e)||this;return r._clippingExtent=null,r._dataExtent=null,r._elevationBounds=new V.ElevationBounds,r._rootExtent=S.create(),r._iteratorPool=new p(N.IteratorPreorder),r._postorderIterator=new N.IteratorPostorder,r.pendingUpdates=!1,r._asyncWorkItems=0,r._visible=!1,r._usedMemory=K,r._isUpdating=!1,r._viewChangeUpdateDirty=!1,r._overlayOpacity=1,r._eyePosRenderSR=T.vec3f64.create(),r._eyePosSurfaceSR=T.vec3f64.create(),r._splitLimits=new H.SplitLimits,r._snapLevel=1/0,r._frustum=R.frustum.create(),r._viewProjectionMatrix=v.mat4f64.create(),r._layerViews=[new Array,new Array],r._layerIndexByLayerViewId=[new Map,new Map],r._basemapLayerViewHandles=new Map,r._handles=new l,r._allTiles=new h,r._upsampleInfoPool=new p(W.UpsampleInfo),r._visibleLevels=new h({deallocator:null}),r._getElevationData={spatialReference:null,rootTiles:null},r.maxTextureScale=1.2,r.rootTiles=null,r.backgroundImage=B.DEFAULT_TILE_BACKGROUND,r.backgroundColor=null,r._layerViewsDirty=!1,r}return r.__extends(n,t),n.prototype.initialize=function(){var t=this;this._stage=this.view._stage,this._lercDecoder=b.acquireInstance(this.view.resourceController.scheduler),this._tilePool="planar"===this.manifold?new p(A.PlanarPatch):new p(I.SphericalPatch),this._upsampleMapCache=this.view.resourceController.memoryController.getMemCache("esri.views.3d.terrain.upsample",(function(e){return e.unloadMapData()})),this._set("overlayManager",new U.OverlayManager({terrainSurface:this,view:this.view})),this._handles.add([this.watch("overlayManager.hasHighlights",(function(e){return t._renderer.setNeedsHighlight(e)})),this.watch("overlayManager.rendersOccluded",(function(e){return t._renderer.setRenderOccludedOverlay(e)}))],"overlayManager"),this._renderer=new q({manifold:this.manifold,overlayRenderer:this.overlayManager.renderer}),this._renderer.install(this.view._stage),this._handles.add([_.init(this,"baseOpacity",(function(e){t._handleLayerViewChanges(),t._updateBaseOpacity(e)}),!0),_.init(this,"_background",(function(){t._handleLayerViewChanges(),t._renderer.setTileBackground(t._background)}),!0),this.view.watch("pointsOfInterest",(function(e){return t._renderer.pointsOfInterest=e})),_.whenTrue(O,"TERRAIN_DEBUG_POPUP",(function(){new Promise((function(t,r){e(["./support/TerrainDebugPopupOpener"],t,r)})).then((function(e){var r=new e.TerrainDebugPopupOpener({surface:t});_.whenFalseOnce(O,"TERRAIN_DEBUG_POPUP",(function(){return r.destroy()}))}))}))]);var r={layers:this.view.map.allLayers,layerViews:this.view.allLayerViews,spatialReference:this.view.spatialReference};this.extentHelper="spherical"===this.manifold?new j.SurfaceExtentHelperGlobal(r):new j.SurfaceExtentHelperLocal(r),this._handles.add(_.init(this.extentHelper,"stencilEnabledExtents",(function(e){return t._renderer.setStencilEnabledLayerExtents(e)})),"extentHelper");var i=this.view.defaultsFromMap?new s({root:this.view.map,rootCollectionNames:this.view.defaultsFromMap.mapCollectionPaths,getChildrenFunction:function(e){return e.layers}}):this.view.map.allLayers,n=new k({layers:i,extentHelper:this.extentHelper,manifold:this.manifold,viewSpatialReference:this.view.spatialReference});this._set("tilingSchemeLogic",n),this._handles.add([this.tilingSchemeLogic.watch("tilingScheme",(function(){return t._updateTilingSchemeAndExtent()}),!0),this.tilingSchemeLogic.watch("extent",(function(){return t._updateTilingSchemeAndExtent()}),!0)],"tilingSchemeLogic"),this._updateTilingSchemeAndExtent(),this._elevationDataRequester=this.view.resourceController.createStreamDataRequester(0),this._mapDataRequester=this.view.resourceController.createStreamDataRequester(1);var a=this.view.resourceController.scheduler;this._frameTask=a.registerTask(G.Task.TERRAIN_SURFACE,(function(e){return t._update(e)}),(function(){return t.updating})),this.view.resourceController.memoryController.events.on("quality-changed",(function(){return t._viewChangeUpdate()})),this._handles.add([this.view.on("resize",(function(){return t._viewChangeUpdate()})),this.view.watch("state.camera",(function(){return t._viewChangeUpdate()}),!0),this.view.watch("qualitySettings.tiledSurface.lodBias",(function(){return t._viewChangeUpdate()})),_.init(this.view,"qualitySettings.tiledSurface.textureFadeDuration",(function(e){return t._renderer.textureFadingEnabled=e>0})),this.view.watch("lodSnapping",(function(){return t._viewChangeUpdate()})),this.view.watch("clippingArea",(function(){return t._clippingChanged()}))]),this._handles.add(this.view.allLayerViews.on("after-changes",(function(){return t._layerViewsDirty=!0}))),this._layerViewsDirty=!0,this._handleLayerViewChanges(),this._updateClippingExtent(),this.notifyChange("extent")},n.prototype.destroy=function(){var e=this;this._frameTask.remove(),this._handles.destroy(),b.releaseInstance(this._lercDecoder),this._lercDecoder=null,this._removeAllTiles(),this._upsampleMapCache.destroy(),this._upsampleMapCache=null,this.tilingSchemeLogic.destroy(),this._set("tilingSchemeLogic",null),this.extentHelper.destroy(),this.extentHelper=null,this._basemapLayerViewHandles.forEach((function(t,r){return e._unregisterTiledLayerView(r)})),this._elevationDataRequester=null,this._mapDataRequester=null,this.overlayManager&&(this.overlayManager.destroy(),this._set("overlayManager",null)),this._tilePool.destroy(),this._tilePool=null,H.pruneAgents(),this._renderer.uninstall(this._stage),this._renderer.destroy(),this._renderer=null,this._iteratorPool.destroy(),this._iteratorPool=null,this._set("view",null),this._stage=null,this._upsampleInfoPool.destroy(),this._upsampleInfoPool=null},Object.defineProperty(n.prototype,"renderer",{get:function(){return this._renderer},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"frustum",{get:function(){return this._frustum},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"snapLevel",{get:function(){return Math.round(this._snapLevel)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"upsampleInfoPool",{get:function(){return this._upsampleInfoPool},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"upsampleMapCache",{get:function(){return this._upsampleMapCache},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"extent",{get:function(){return this._clippingExtent||this._rootExtent},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"updating",{get:function(){return!(!(this.pendingUpdates||this._asyncWorkItems>0||this._renderer.updating||this.overlayManager.updating||this._layerViewsDirty||this._frameTask.updating)||!this.ready||this.suspended)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"ready",{get:function(){return!!this.rootTiles},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"renderOrder",{set:function(e){this._renderer.renderOrder=e,this._set("renderOrder",e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"skirtScale",{get:function(){return this._renderer.skirtScale},set:function(e){this._renderer.skirtScale=e},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"spatialReference",{get:function(){var e=this.tilingScheme&&this.tilingScheme.spatialReference||null;return this._getElevationData.spatialReference=e,e},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"_background",{get:function(){return null!=this.backgroundColor?this.backgroundColor:this.backgroundImage},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"slicePlaneEnabled",{set:function(e){this._renderer.slicePlane=e,this._set("slicePlaneEnabled",e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"velvetOverground",{set:function(e){e!==this.velvetOverground&&(this._renderer.velvetOverground=e),this._set("velvetOverground",e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"visible",{set:function(e){e!==this._visible&&(this._visible=e,this._renderer.setVisibility(e),this.suspended=!e)},enumerable:!1,configurable:!0}),n.prototype.isOpaque=function(){return this._renderer.opaque},Object.defineProperty(n.prototype,"suspended",{set:function(e){this._set("suspended",e),this._viewChangeUpdate()},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"lodSnapping",{get:function(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences?0:1},enumerable:!1,configurable:!0}),n.prototype.intersect=function(e,t,r,i){this._renderer.intersect(e,t,r,i)},n.prototype.getElevation=function(e,t,r,i){var n=this._getElevationData.rootTiles;if(!n||!n.length)return null;if(0===n[0].layerInfo[0].length)return null;var a=J;if(a[0]=e,a[1]=t,a[2]=r,!C.vectorToVector(a,i,a,this._getElevationData.spatialReference))return X.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;for(var s=0,o=n;s<o.length;s++){var l=o[s];if(l.containsPoint(a)){for(;l&&!l.rendered&&!l.isLeaf;){var d=0;a[0]>.5*(l.extent[0]+l.extent[2])&&(d+=1),a[1]<.5*(l.extent[1]+l.extent[3])&&(d+=2),l=l.children[d]}var u=l.renderData,p=u&&u.geometryState?u.geometryState.samplerData:null;return p?M.ElevationData.sample(a[0],a[1],p):null}}return null},Object.defineProperty(n.prototype,"elevationBounds",{get:function(){return this._elevationBounds},enumerable:!1,configurable:!0}),n.prototype.getScale=function(e){if(this.tilingScheme){if(!D.pointToVector(e,J,this.spatialReference))return X.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;var t=this.rootTiles;if(t)for(var r=0,i=t;r<i.length;r++){var n=i[r];if(n.containsPoint(J)){for(;null!=n.children[0];){var a=0;J[0]>n.children[0].extent[2]&&(a+=1),J[1]<n.children[0].extent[1]&&(a+=2),n=n.children[a]}return this._getLodBiasCorrectedScale(n.level)}}}return 1e100},n.prototype.queryVisibleScaleRange=function(e,t,r,i){var n=t?this.tilingScheme.levelAtScale(t):0,a=r?this.tilingScheme.levelAtScale(r):1/0,s=this.lodBias;this._renderer.queryVisibleLevelRange(e,n+s,a+s,i)},n.prototype._updateBaseOpacity=function(e){var t=this._renderer.opaque;this._renderer.opaque=e>=1,this._renderer.isTransparent=this.allTransparentSurfaceLayers();var r=t!==this._renderer.opaque;this._updateTileTextures(r)},n.prototype._updateTilingSchemeAndExtent=function(){var e=this.tilingSchemeLogic.extent,t=e&&!S.equals(e,this._dataExtent);t&&(this._dataExtent?S.set(this._dataExtent,e):this._dataExtent=S.create(e));var r=this.tilingSchemeLogic.tilingScheme,i=r!==this.tilingScheme;i&&(F.weakAssert(!!r,"tiling scheme cannot be reset to undefined"),this.tilingScheme&&this._removeAllTiles(),this._set("tilingScheme",r),this._updateClippingExtent(),r&&(this._updateTiledLayers(),this._renderer.setTileSize(r.pixelSize),this.overlayManager.setSpatialReference(r.spatialReference,"spherical"===this.manifold))),(t||i)&&this._updateRootTiles()},n.prototype._acquireTile=function(e,t,r,i){var n=this._tilePool.acquire();return Z[0]=e,Z[1]=t,Z[2]=r,n.init(Z,i,this),n},n.prototype._updateRootTiles=function(){var e=this,t=this._clippingExtent||this._dataExtent,r=this.tilingScheme;if(t&&r){var i=Q,n=r.rootTilesInExtent(t,i,5*B.MAX_ROOT_TILES),s=function(t){var r=e._acquireTile(0,t[1],t[2],null);return 2===r.shouldSplit(e._splitLimits,e._eyePosRenderSR,e.lodSnapping)&&r.setPendingUpdate(2),e._loadTile(r),r};if(this.rootTiles){if(n.length>B.MAX_ROOT_TILES)return void X.warn(B.TOO_MANY_ROOT_TILES_AFTER_CHANGE_ERROR);var o=this.rootTiles.map((function(e){return e.lij})),l=a.difference(o,n,z);if(l.removed.length>0||l.added.length>0){var d=this.rootTiles.filter((function(t){return!(a.findIndex(l.removed,z.bind(null,t.lij))>-1)||(e._purgeTile(t),!1)}));l.added.forEach((function(e){return d.push(s(e))})),this._setRootTiles(d)}}else n.length>B.MAX_ROOT_TILES&&(X.warn(B.TOO_MANY_ROOT_TILES_FOR_LAYER_ERROR),n=r.rootTilesInExtent(t,i,B.MAX_ROOT_TILES)),this._setRootTiles(n.map((function(e){return s(e)})));S.equals(i,this._rootExtent)||(this._rootExtent=S.create(i),this._hasFixedExtent()||this.notifyChange("extent")),this.visible=!0,this._viewChangeUpdate(),this.overlayManager.setOverlayPlacementDirty(),this.notifyChange("ready")}},n.prototype._setRootTiles=function(e){if(this._set("rootTiles",e),this._allTiles.clear(),e){var t=this._iteratorPool.acquire();for(t.reset(e);!t.done;)this._allTiles.push(t.next());this._iteratorPool.release(t)}this._getElevationData.rootTiles=e,this._renderer.setRootTiles(this.rootTiles),this._updateTiles(e)},n.prototype._runViewChangeUpdateIfDirty=function(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())},n.prototype._viewChangeUpdate=function(){this._stage&&!this.suspended&&this.tilingScheme&&this._visible&&(this._isUpdating?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateSkirts(),this.updateOverlayOpacity(),this._updateTiles(this.rootTiles)))},n.prototype._updateClippingStatus=function(e){e.updateClippingStatus(this._clippingExtent)&&e.resetPendingUpdate(32)&&this._updateTileGeometry(e)},n.prototype._updateTiles=function(e){if(e){var t,r,i=this._iteratorPool.acquire();for(i.reset(e),N.hasVisibleSiblings(e)?(t=this._elevationBounds.min,r=this._elevationBounds.max):(t=1/0,r=-1/0);!i.done;){var n=i.next();if(this._updateClippingStatus(n),n.updateVisibility(),n.setPendingUpdate(16),n.visible){n.updateScreenDepth(this._viewProjectionMatrix),n.renderData&&(t=Math.min(n.elevationBounds[0],t),r=Math.max(n.elevationBounds[1],r));var a=n.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping);if(2===a){n.resetPendingUpdate(8),n.isLeaf&&(n.setPendingUpdate(2),i.skipSubtree());continue}n.resetPendingUpdate(2)&&n.updateAgentSuspension(),4===a&&n.updateAgents(0)}if(i.skipSubtree(),!n.isLeaf){n.setPendingUpdate(8),n.resetPendingUpdate(2);var s=this._iteratorPool.acquire();s.resetOne(n);for(var o=s.next();!s.done;o=s.next())this._updateClippingStatus(o),o.updateVisibility(),o.visible&&o.updateScreenDepth(this._viewProjectionMatrix);this._iteratorPool.release(s)}}this._iteratorPool.release(i),this.pendingUpdates=!0,isFinite(t)&&isFinite(r)&&(this._elevationBounds.min===t&&this._elevationBounds.max===r||(this._elevationBounds.min=t,this._elevationBounds.max=r,this.emit("elevation-bounds-change",null)))}},n.prototype._updateViewDependentParameters=function(){var e=this.view.state.camera,t=Math.tan(.5*e.fovX),r=Math.tan(.5*e.fovY),i=this.tilingScheme.pixelSize,n=Math.pow(2,-this.lodBias)*e.pixelRatio;this._splitLimits.aboveGround=e.aboveGround,this._splitLimits.fovX=t,this._splitLimits.fovY=r,this._splitLimits.relativeWidthLimit=i/e.width*this.maxTextureScale*n,this._splitLimits.relativeHeightLimit=i/e.height*this.maxTextureScale*n,this._splitLimits.maxLod=this.tilingScheme.getMaxLod(),this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias,R.frustum.copy(e.frustum,this._frustum),g.mat4.multiply(this._viewProjectionMatrix,e.projectionMatrix,e.viewMatrix),m.vec3.copy(this._eyePosRenderSR,e.eye),C.vectorToVector(this._eyePosRenderSR,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)},n.prototype._updateSnapLevel=function(){if(1!==this.lodSnapping){var e=this._findSnapLevel();if(!(Math.abs(this._snapLevel-e)<.1)){var t=this.snapLevel;this._snapLevel=e,t!==this.snapLevel&&this._updateTiles(this.rootTiles)}}},n.prototype._findSnapLevel=function(){if(this._visibleLevels.length<=0)return this._snapLevel;var e=Math.abs(this.view.camera.tilt-90)/90*.4+.3,t=this._visibleLevels,r=Math.round(t.length*e);if(r>=t.length)return this._snapLevel;t.sort((function(e,t){return e-t}));for(var i=0,n=r;n<t.length;++n)i+=t.getItemAt(n);var a=t.getItemAt(Math.round(.95*t.length)-1),s=i/(t.length-r);return u.clamp(s,a-1,this._splitLimits.maxLod)},n.prototype._updateSkirts=function(){var e=this.view.state.camera,t=this.view.state.constraints.collision.enabled?0:1.11*e.near;F.autoUpdateSkirtsVisibility(this,this._eyePosSurfaceSR,this.spatialReference,t)},n.prototype._updateRenderData=function(e){e.rendered&&!e.shouldRender&&(!function e(t){if(t.isLeaf)return!1;return t.children[0].shouldRender||t.children[1].shouldRender||t.children[2].shouldRender||t.children[3].shouldRender||e(t.children[0])||e(t.children[1])||e(t.children[2])||e(t.children[3])}(e)?function(e){return e.isLeaf&&e.parent&&e.parent.shouldRender}(e)&&this._loadParent(e):this._loadChildren(e))},n.prototype._updateTileGeometry=function(e){e.updateVisibility(),this._renderer.updateTileGeometry(e),this._elevationUpdate(e),this._usedMemory=K},n.prototype._elevationUpdate=function(e){ee.spatialReference=this.spatialReference,ee.tile=e,ee.extent=e.extent,this.emit("elevation-change",ee),S.containsPoint(e.extent,this._eyePosSurfaceSR)&&this._updateSkirts()},n.prototype._update=function(e){var t=this;this._handleLayerViewChanges(),this._isUpdating=!0,this._mergeAndSplit(e),e.run((function(){return t._updateElevation(e)})),e.run((function(){return t._updateTextures(e)})),this._isUpdating=!1,this._runViewChangeUpdateIfDirty()},n.prototype._mergeAndSplit=function(e){var t=this;if(!this.suspended&&this.pendingUpdates){this.pendingUpdates=!1;for(var r=this._eyePosRenderSR,i=0,n=!1,a=0===this.lodSnapping?function(e){var i=e.shouldSplit(t._splitLimits,r,1);e.visible&&2!==i&&e.parent&&2===e.parent.shouldSplit(t._splitLimits,r,1)&&(1===i?t._visibleLevels.fill(e.level+1,4):t._visibleLevels.push(e.level))}:function(){};!e.done;){this._visibleLevels.clear();var s=!this._allTiles.some((function(r){return i+=r.usedMemory,a(r),r.resetPendingUpdate(8)?(t._mergeTile(r),n=!0,e.madeProgress()):r.resetPendingUpdate(2)&&(t._splitTile(r),n=!0,e.madeProgress()),r.resetPendingUpdate(16)&&(t._updateRenderData(r),e.madeProgress()),t.pendingUpdates=t.pendingUpdates||r.updating,e.done}));if(n&&(this.pendingUpdates=!0,n=!1,N.sortTiles(this._renderer.renderOrder,this._allTiles)),s){this._updateSnapLevel(),this._usedMemory=i;break}this.pendingUpdates=!0}this._visibleLevels.clear()}},n.prototype._updateElevation=function(e){var t=this;return this._allTiles.some((function(r){return r.resetPendingUpdate(32)&&(t._updateTileGeometry(r),e.madeProgress()),e.done})),e.hasProgressed},n.prototype._updateTextures=function(e){var t=this;return this._allTiles.some((function(r){return r.resetPendingUpdate(64)&&(t._renderer.updateTileTexture(r),t._usedMemory=K,e.madeProgress()),e.done})),e.hasProgressed},n.prototype._updateClippingExtent=function(){if(!this.spatialReference)return!1;var e=S.create(),t=null;return E.toBoundingRect(this.view.clippingArea,e,this.spatialReference)&&(t=e),!S.equals(t,this._clippingExtent)&&(this._clippingExtent=t,this._renderer.clippingExtent=t,this.notifyChange("extent"),this.updateTileOverlayParams(),this.overlayManager.setOverlayPlacementDirty(),!0)},n.prototype._clippingChanged=function(){this._updateClippingExtent()&&this._updateRootTiles()},Object.defineProperty(n.prototype,"lodBias",{get:function(){var e=this.view.resourceController.memoryController.memoryFactor;return this.view.qualitySettings.tiledSurface.lodBias-(1-e)*B.MAX_MEMORY_LOD_BIAS},enumerable:!1,configurable:!0}),n.prototype._getLodBiasCorrectedScale=function(e){var t=this.tilingScheme.levels,r=u.clamp(e-this.lodBias,0,t.length-1),i=r-Math.floor(r);return t[Math.floor(r)].scale*(1-i)+t[Math.ceil(r)].scale*i},n.prototype._removeAllTiles=function(){var e=this;this.rootTiles&&(this.rootTiles.forEach((function(t){return e._purgeTile(t)})),this._setRootTiles(null),this.notifyChange("ready")),this._allTiles.clear(),this.visible=!1},n.prototype._purgeChildTiles=function(e){if(e.isLeaf)return!1;var t=this._purgeTile(e.children[0]);return t=this._purgeTile(e.children[1])||t,t=this._purgeTile(e.children[2])||t,t=this._purgeTile(e.children[3])||t,e.unsetChildren(),t},n.prototype._purgeTile=function(e){var t=this._purgeChildTiles(e)||e.rendered;return this._allTiles.removeUnordered(e),e.unload(this._renderer),this._tilePool.release(e),t},n.prototype._splitTile=function(e){F.weakAssert(e.isLeaf,"tile that is already split should not be split again!");var t=e.level+1,r=2*e.lij[1],i=2*e.lij[2];return e.setChildren(this._createTile(t,r,i,e),this._createTile(t,r,i+1,e),this._createTile(t,r+1,i,e),this._createTile(t,r+1,i+1,e)),e.setPendingUpdate(16),e.updateAgentSuspension(),this._allTiles.pushArray(e.children),this.pendingUpdates=!0,this._emitTileScaleChange(e,t),e.children[0].hasPendingUpdate(2)||e.children[1].hasPendingUpdate(2)||e.children[2].hasPendingUpdate(2)||e.children[3].hasPendingUpdate(2)},n.prototype._emitTileScaleChange=function(e,t){void 0===t&&(t=e.level),te.spatialReference=this.spatialReference,te.extent=e.extent,te.scale=this._getLodBiasCorrectedScale(t),this.emit("scale-change",te)},n.prototype._createTile=function(e,t,r,i){F.weakAssert(!!i,"_createTile sanity check");var n=this._acquireTile(e,t,r,i);return n.updateClippingStatus(this._clippingExtent),n.visible&&(n.updateScreenDepth(this._viewProjectionMatrix),2===n.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping)&&n.setPendingUpdate(2)),n},n.prototype._mergeTile=function(e){F.weakAssert(!e.hasPendingUpdate(2),"_mergeTile sanity check"),this._purgeChildTiles(e)&&(F.weakAssert(!e.renderData,"_mergeTile sanity check"),this._loadTile(e)),this.pendingUpdates=!0,this._emitTileScaleChange(e)},n.prototype._loadChildren=function(e){F.weakAssert(e.rendered,"parent should be rendered"),e.unload(this._renderer),this._loadTile(e.children[0]),this._loadTile(e.children[1]),this._loadTile(e.children[2]),this._loadTile(e.children[3])},n.prototype._loadParent=function(e){var t=e.parent;this._unloadChildren(t),this._loadTile(t)},n.prototype._unloadChildren=function(e){e.isLeaf||(this._unloadChildren(e.children[0]),e.children[0].unload(this._renderer),this._unloadChildren(e.children[1]),e.children[1].unload(this._renderer),this._unloadChildren(e.children[2]),e.children[2].unload(this._renderer),this._unloadChildren(e.children[3]),e.children[3].unload(this._renderer))},n.prototype._loadTile=function(e){e.load(this._renderer),e.setPendingUpdate(16),this.overlayManager&&this.overlayManager.hasOverlays()&&this.overlayManager.setTileParameters(e,e.renderData,this._overlayOpacity),this._elevationUpdate(e)},n.prototype._elevationDataArrived=function(e,t,r){var i=new M.ElevationData(e.lij,e.extent,r);e.dataArrived(t,0,i);var n=[e],a=e.level,s=this._iteratorPool.acquire();for(s.reset(n);!s.done;){var o=s.next();o.findElevationBoundsForLayer(t,a),o.computeElevationBounds()}this._iteratorPool.release(s),this._updateTiles(n)},n.prototype._handleLayerViewChanges=function(){var e=this;if(this._layerViewsDirty){this._layerViewsDirty=!1;for(var t=!1,r=new Set,i=-1,n=0,a=this.view.allLayerViews.items;n<a.length;n++){var s=a[n];if(r.add(s.uid),F.isSurfaceLayerView(s))if(this._basemapLayerViewHandles.has(s.uid)){var o=this.layerClassFromLayerView(s),l=this._layerIndexByLayerViewId[o].get(s.uid);l<i&&(t=!0),i=l}else this._registerTiledLayerView(s),s.layer.loaded&&(t=!0)}this._basemapLayerViewHandles.forEach((function(i,n){r.has(n)||(e._unregisterTiledLayerView(n),t=!0)})),t&&this._updateTiledLayers(),this._renderer.isTransparent=this.allTransparentSurfaceLayers()}},n.prototype.allTransparentSurfaceLayers=function(){for(var e=0===this.view.map.ground.opacity,t=0,r=this.view.allLayerViews.items;t<r.length;t++){var i=r[t];if(F.isSurfaceLayerView(i)&&!F.isElevationLayerView(i)&&!L.isBaseLayer(i.layer)&&0!==i.fullOpacity)return e=!1}return e},n.prototype.layerClassFromLayerView=function(e){return F.isElevationLayerView(e)?0:1},n.prototype._registerTiledLayerView=function(e){var t=this,r=[],i=this.layerClassFromLayerView(e);r.push(e.watch("suspended",(function(){return t._updateTiledLayers()}))),r.push(e.watch("fullOpacity",(function(){return t._updateTileTextures(!1)}))),r.push(e.layer.watch("scaleRangeId",(function(){return t._restartAllAgents(i)}))),e.on("data-changed",(function(){var r=t._layerIndexByLayerViewId[i].get(e.uid);null!=r&&t._invalidateLayerData(r,i)})),this._basemapLayerViewHandles.set(e.uid,r)},n.prototype._unregisterTiledLayerView=function(e){var t=this._basemapLayerViewHandles.get(e);if(t){for(var r=0;r<t.length;r++)t[r].remove();this._basemapLayerViewHandles.delete(e)}},n.prototype._updateTiledLayers=function(){var e=this;if(this.tilingScheme&&!this.view.suspended){var t=this.view.allLayerViews,r=[[],[]],i=null,n=S.empty();t.forEach((function(t){var a=t.layer;if(a&&!t.suspended&&F.isSurfaceLayerView(t)){var s=t.fullExtent;if(s)if(e.tilingScheme.compatibleWith(t.tileInfo)){S.expand(n,s);var o=e.layerClassFromLayerView(t);if(1===o){var l=t.displayLevelRange;l.maxLevel!==1/0&&(null===i||l.maxLevel>i)&&(i=l.maxLevel)}r[o].push(t)}else X.warn("Terrain: tiling scheme of layer "+a.id+" is incompatible with other tiled layers, will not be drawn");else X.warn("Terrain: Map or elevation layer does not have fullExtent: "+a.id)}}));for(var a=0;a<2;a++){var s=this._layerViews[a],o=r[a];o.reverse();var l=o.length,d=s.length!==l,u=new Array(l),p=new Array(s.length);this._layerIndexByLayerViewId[a].clear();for(var h=0;h<l;h++){var c=o[h].uid;this._layerIndexByLayerViewId[a].set(c,h);var _=s.indexOf(o[h]);u[h]=_,h!==_&&(d=!0),_>-1&&(p[_]=h)}if(d){var y=this._postorderIterator;for(y.reset(this.rootTiles);!y.done;)y.next().modifyLayers(p,u,a);this._layerViews[a]=o,this._restartAllAgents(a),this._updateTiles(this.rootTiles)}}this.tilingScheme.ensureMaxLod(i)&&this._viewChangeUpdate()}},n.prototype._restartAllAgents=function(e){var t=this._postorderIterator;for(t.reset(this.rootTiles);!t.done;){var r=t.next();r.restartAgents(e),0===e&&r.computeElevationBounds()}},n.prototype._hasFixedExtent=function(){return!!this._clippingExtent},n.prototype.layerViewByIndex=function(e,t){return this._layerViews[t][e]},n.prototype.numLayers=function(e){return this._layerViews[e].length},n.prototype._updateTileTextures=function(e){var t=this;this._allTiles.forEachSimple((function(r){r.updateAgents(1),e?t.renderer.updateTileTexture(r):r.updateRenderData(1)})),this._renderer.isTransparent=this.allTransparentSurfaceLayers()},n.prototype._invalidateLayerData=function(e,t){this._allTiles.forEachSimple((function(r){return r.removeLayerAgent(e,t)})),this._allTiles.forEachSimple((function(r){return r.invalidateLayerData(e,t)}))},n.prototype.requestRender=function(e){void 0===e&&(e=1),this.renderer.setNeedsRender(e)},n.prototype.requestTileData=function(e,t,i,n){var a=this,s=this.layerViewByIndex(t,i),o=s.layer;return!o.tilemapCache||F.isVectorTileLayerView(s)?this._requestTileData(e,i,s,n):(++this._asyncWorkItems,o.tilemapCache.fetchAvailability(e.lij[0],e.lij[1],e.lij[2],r.__assign(r.__assign({},n),{timeout:6e3})).then((function(){return--a._asyncWorkItems})).catch((function(t){throw--a._asyncWorkItems,c.isAbortError(t)||a._dataMissing(e,i,s,{notInTilemap:!0}),t})).then((function(){return a._frameTask.schedule((function(){return a._requestTileData(e,i,s,n)}),n.signal)})))},n.prototype._requestTileData=function(e,t,r,i){return 0===t?this._requestElevationTileData(e,r,i):this._requestMapTileData(e,r,i)},n.prototype._requestElevationTileData=function(e,t,r){var i=this;if(F.isElevationLayerView(t)){var n=function(n){if(--i._asyncWorkItems,!c.isAborted(r)){var a=i._layerIndexByLayerViewId[0].get(t.uid);null!=a?(i._usedMemory=K,i.pendingUpdates=!0,i._elevationDataArrived(e,a,n)):X.warn("TerrainSurface: received data from unknown layer %d %s",0,e.lij.toString())}},a=function(r){--i._asyncWorkItems,c.isAbortError(r)||(i._dataMissing(e,0,t,r),i.pendingUpdates=!0)};if(++this._asyncWorkItems,F.useFetchTileForLayer(t.layer))return t.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],{noDataValue:B.ELEVATION_NODATA_VALUE,signal:r.signal}).then((function(e){if(c.isAborted(r))return X.warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),void a(c.createAbortError());n(e)}),a);var s=t.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);return this._elevationDataRequester.request(s,"binary",r).then((function(e){return i._lercDecoder.decode(e,{noDataValue:B.ELEVATION_NODATA_VALUE},r.signal)})).then((function(e){n({values:e.pixelData,width:e.width,height:e.height,noDataValue:e.noDataValue,minValue:e.minValue,maxValue:e.maxValue})}),a)}F.weakAssert(!1,"_requestElevationTileData can only be called for elevation layer views")},n.prototype._requestMapTileData=function(e,t,r){var i=this;if(t instanceof P)return c.reject();++this._asyncWorkItems;var n=function(n){return i._frameTask.schedule((function(){--i._asyncWorkItems,i.pendingUpdates=!0,c.isAborted(r)?F.releaseTileData(n):i._dataArrived(e,1,t,n)}),r.signal).catch(a)},a=function(n){return i._frameTask.schedule((function(){--i._asyncWorkItems,c.isAborted(r)||(i._dataMissing(e,1,t,n),i.pendingUpdates=!0)}))};if(F.isVectorTileLayerView(t)){var s=t.schemaHelper.getLevelRowColumn(e.lij);return t.tileHandler.getVectorTile(s[0],s[1],s[2],r).then((function(e){e.neededForCoverage=!0,e.transforms.tileUnitsToPixels=f.mat3f32.fromValues(1/8,0,0,0,1/8,0,0,0,1),x.declutterSingleTile(e),n(e)}),a)}if(F.isImageryTileLayerView(t))return t.fetchTile(e.lij[0],e.lij[1],e.lij[2],r).then(n,a);if(F.useFetchTileForLayer(t.layer)&&F.isTileLayerView(t))return t.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],r).then((function(e){if(c.isAborted(r))return X.warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),void a(c.createAbortError());n(e)}),a);var o=t.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);(function(e){return null!=e.refreshInterval})(t)&&t.refreshTimestamp&&(o+=(o.indexOf("?")>-1?"&":"?")+"_ts="+t.refreshTimestamp);var l=t.hasMixedImageFormats?"image+type":"image";return this._mapDataRequester.request(o,l,r).then(n,a)},n.prototype._dataArrived=function(e,t,r,i){var n=this._layerIndexByLayerViewId[t].get(r.uid);null!=n?e.dataArrived(n,t,i):X.warn("TerrainSurface: received data from unknown layer")},n.prototype._dataMissing=function(e,t,r,i){var n=this._layerIndexByLayerViewId[t].get(r.uid);null!=n?e.dataMissing(n,t,i):X.warn("TerrainSurface: received data from unknown layer")},n.prototype.updateTileOverlayParams=function(){var e=this;this.rootTiles&&(this._allTiles.forEachSimple((function(t){t.renderData&&e.overlayManager&&e.overlayManager.setTileParameters(t,t.renderData,e._overlayOpacity)})),this._renderer.setNeedsRender())},n.prototype.updateOverlayOpacity=function(){if(this.overlayManager){var e=this._eyePosSurfaceSR[2],t=this.overlayManager.updateOpacity(e);isNaN(t)||t===this._overlayOpacity||(this._allTiles.forEachSimple((function(e){return e.renderData&&(e.renderData.overlayOpacity=t)})),this._overlayOpacity=t,this._renderer.setNeedsRender())}},n.prototype.getStats=function(){var e={numNodes:this._allTiles.length,numLeaves:0,numVisible:0,numRendered:0,numRenderedPerLevel:new Array,numLoadedPerLevel:new Array};return this._allTiles.forEachSimple((function(t){t.isLeaf&&e.numLeaves++;var r=t.level;t.renderData&&(e.numLoadedPerLevel[r]=(e.numLoadedPerLevel[r]||0)+1),t.visible&&(e.numVisible++,t.rendered&&(e.numRenderedPerLevel[r]=(e.numRenderedPerLevel[r]||0)+1,e.numRendered++))})),e},n.prototype.getUsedMemory=function(){var e=this;return this.tilingScheme?(this._usedMemory===K&&(this._usedMemory=0,this._allTiles.forEachSimple((function(t){return e._usedMemory+=t.usedMemory}))),this._usedMemory):0},n.prototype.getUsedMemoryForLayerView=function(e){var t=0,r=this.layerClassFromLayerView(e),i=this._layerIndexByLayerViewId[r].get(e.uid);return this._allTiles.forEachSimple((function(e){return t+=e.getUsedMemoryForLayer(r,i)})),t},n.prototype.getTile=function(e){var t=e.split("/").map((function(e){return+e}));if(0===t[0])return a.find(this.rootTiles,(function(e){return e.lij[1]===t[1]&&e.lij[2]===t[2]}));var r,i=Math.pow(2,t[0]),n=Math.floor(t[1]/i),s=Math.floor(t[2]/i);if(this.rootTiles.some((function(e){return e.lij[1]===n&&e.lij[2]===s&&(r=e,!0)})),r){for(var o=1<<t[0]-1;r.lij[0]<t[0];){var l=t[1]&o?2:0;if((t[2]&o)>0&&l++,!r.children[l])return null;r=r.children[l],o>>=1}return F.weakAssert(r.lij[0]===t[0]&&r.lij[1]===t[1]&&r.lij[2]===t[2],"not the right tile?"),r}return null},n.prototype.getRenderedTiles=function(){return $.clear(),this._allTiles.forEachSimple((function(e){e.visible&&e.rendered&&$.push(e)})),N.sortTiles(this.renderOrder,$),$.toArray()},Object.defineProperty(n.prototype,"test",{get:function(){var e=this;return{renderer:this._renderer,lercDecoder:this._lercDecoder,mergeTile:function(t){return e._mergeTile(t)},updateTiles:function(t){return e._updateTiles(t)},getTiles:function(){return e._allTiles.toArray()}}},enumerable:!1,configurable:!0}),r.__decorate([y.property()],n.prototype,"_renderer",void 0),r.__decorate([y.property()],n.prototype,"pendingUpdates",void 0),r.__decorate([y.property()],n.prototype,"_asyncWorkItems",void 0),r.__decorate([y.property()],n.prototype,"_frameTask",void 0),r.__decorate([y.property({constructOnly:!0})],n.prototype,"view",void 0),r.__decorate([y.aliasOf("_renderer.cullBackFaces")],n.prototype,"cullBackFaces",void 0),r.__decorate([y.property({readOnly:!0})],n.prototype,"extent",null),r.__decorate([y.property({readOnly:!0,dependsOn:["ready","suspended","pendingUpdates","_asyncWorkItems","_renderer.updating","_layerViewsDirty","overlayManager.updating","_frameTask.updating"]})],n.prototype,"updating",null),r.__decorate([y.property({aliasOf:"view.map.ground.opacity"})],n.prototype,"baseOpacity",void 0),r.__decorate([y.property({readOnly:!0})],n.prototype,"overlayManager",void 0),r.__decorate([y.property({constructOnly:!0})],n.prototype,"manifold",void 0),r.__decorate([y.property()],n.prototype,"maxTextureScale",void 0),r.__decorate([y.property({readOnly:!0})],n.prototype,"ready",null),r.__decorate([y.property({value:1})],n.prototype,"renderOrder",null),r.__decorate([y.property({readOnly:!0})],n.prototype,"rootTiles",void 0),r.__decorate([y.property({readOnly:!0,dependsOn:["tilingScheme.spatialReference"]})],n.prototype,"spatialReference",null),r.__decorate([y.property()],n.prototype,"backgroundImage",void 0),r.__decorate([y.property({type:i,aliasOf:"view.map.ground.surfaceColor"})],n.prototype,"backgroundColor",void 0),r.__decorate([y.property({dependsOn:["backgroundColor","backgroundImage"]})],n.prototype,"_background",null),r.__decorate([y.property({value:!1})],n.prototype,"slicePlaneEnabled",null),r.__decorate([y.property({readOnly:!0})],n.prototype,"tilingScheme",void 0),r.__decorate([y.property({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeLocked"})],n.prototype,"tilingSchemeLocked",void 0),r.__decorate([y.property({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeDone"})],n.prototype,"tilingSchemeDone",void 0),r.__decorate([y.property({readOnly:!0})],n.prototype,"tilingSchemeLogic",void 0),r.__decorate([y.property({value:!0})],n.prototype,"velvetOverground",null),r.__decorate([y.aliasOf("_renderer.wireframe")],n.prototype,"wireframe",void 0),r.__decorate([y.property({value:!1})],n.prototype,"suspended",null),r.__decorate([y.property({readOnly:!0,dependsOn:["view.qualitySettings.tiledSurface.reduceTileLevelDifferences"]})],n.prototype,"lodSnapping",null),r.__decorate([y.property({readOnly:!0,aliasOf:"view.qualitySettings.tiledSurface.textureFadeDuration"})],n.prototype,"textureFadeDuration",void 0),r.__decorate([y.property()],n.prototype,"_layerViewsDirty",void 0),r.__decorate([y.aliasOf("_renderer.renderPatchBorders")],n.prototype,"renderPatchBorders",void 0),r.__decorate([y.aliasOf("_renderer.renderingDisabled")],n.prototype,"renderingDisabled",void 0),n=r.__decorate([y.subclass("esri.views.3d.terrain.TerrainSurface")],n)}(o.EventedMixin(n));function z(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}var K=-1,J=w.vec4f64.create(),Q=S.create(),Z=[0,0,0],$=new h,ee={spatialReference:null,tile:null,extent:null,context:"ground"},te={spatialReference:null,extent:null,scale:0};return Y}));