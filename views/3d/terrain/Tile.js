/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/mathUtils","../../../core/maybe","../../../core/ObjectPool","../../../chunks/vec2","../../../chunks/vec2f64","../../../chunks/vec3","../../../chunks/vec3f64","../../../geometry/projectionEllipsoid","../../../geometry/support/aaBoundingRect","../../../chunks/sphere","../../2d/engine/vectorTiles/VectorTile","../support/StreamDataLoader","./ElevationBounds","./ElevationTileAgent","./interfaces","./LayerClass","./MapTileAgent","./RasterTile","./TerrainConst","./terrainUtils","./TileAgent","./TilePerLayerInfo","./TileTexture","./TileUpdate","./tileUtils","../../webgl/Util"],(function(e,t,i,n,s,a,r,o,l,h,u,d,c,p,g,f,_,y,T,m,A,L,E,v,M,I,D,U){"use strict";const C=l.create(),N=l.create(),O=l.create(),P=.1;let S=function(){this.fovX=0,this.fovY=0,this.relativeWidthLimit=0,this.relativeHeightLimit=0,this.maxLod=0,this.angledSplitBias=0,this.aboveGround=!0},B=function(){function s(){this.lij=[0,0,0],this._children=[null,null,null,null],this._pendingUpdates=0,this._dirty=!0,this._previouslyRendered=!1,this.extent=u.create(),this._elevationBounds=r.create(),this.layerInfo=[[],[]],this.extentInRadians=u.create(),this.centerAtSeaLevel=l.create(),this._center=[l.create(),d.create(),l.create()],this.up=l.unitZ(),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._maxTesselation=0,this._usedMemory=V,this._mapTileMemory=0,this._mapDataRefCount=0,this._screenDepth=0,this.renderOrder=0,this._edgeLen=0,this._edgeLen2=0,this._curvatureHeight=0}s.prune=function(){R.prune(0),k.prune(0),v.TilePerLayerInfo.prune()};var f=s.prototype;return f.computeVisibility=function(){this._dirty=!1;const e=this._intersectsClippingArea&&this._isVisible(this.surface.frustum);return e!==this._visible&&(this._visible=e,this._surface.emit("tiles-visibility-changed"),this._surface.renderer.setNeedsRender(),this.updateAgentSuspension()),this._visible},f.init=function(t,i,n){this.lij[0]=t[0],this.lij[1]=t[1],this.lij[2]=t[2],this.ellipsoid=h.getReferenceEllipsoid(n.tilingScheme.spatialReference),n.tilingScheme.getExtent(t[0],t[1],t[2],this.extent),n.tilingScheme.convertExtentToRadians(this.extent,this.extentInRadians),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._clippingArea=null,this._mapDataRefCount=0,n.upsampleMapCache.pop(this.key),this._edgeLen=0,this._edgeLen2=0,this._center[e.CenterPosition.MIDDLE][3]=0,this.vlevel=t?t[0]:0,i&&i.elevationBounds?a.copy(this._elevationBounds,i.elevationBounds):a.set(this._elevationBounds,0,0),this._pendingUpdates=0,this.renderData=null,this._screenDepth=0,this._visible=!1,this._previouslyRendered=!1,this._parent=i,this.unsetChildren(),this._surface=n,this.updateVisibility();for(const e of y.LayerClasses){const t=n.numLayers(e),i=this.layerInfo[e];for(const e of i)e.release();i.length=t;for(let n=0;n<t;n++)i[n]=v.TilePerLayerInfo.acquire(this._surface.upsampleInfoPool),e===y.LayerClass.ELEVATION&&this.findElevationBoundsForLayer(n,-1)}this.computeElevationBounds(),this._maxTesselation=Math.min(n.tilingScheme.pixelSize,A.MAX_PATCH_TESSELATION)},f.release=function(){L.weakAssert(!this.renderData,"tile.renderData was not unloaded"),this._surface.upsampleMapCache.pop(this.key);for(const e of y.LayerClasses){for(const t of this.layerInfo[e])t.release();this.layerInfo[e].length=0}this._parent=null,this._surface=null,this._usedMemory=V},f.refMapData=function(){++this._mapDataRefCount,this.isCached||this._surface.upsampleMapCache.pop(this.key)},f.unrefMapData=function(){if(--this._mapDataRefCount,this.isCached){const e=this.cachedMemory;e>0&&(this._surface.upsampleMapCache.put(this.key,this,e),this.setMemoryDirty())}},f.setMemoryDirty=function(){this._usedMemory=V},f._updateMemoryUsed=function(){this._usedMemory=0,this._mapTileMemory=0;const e=this.cpuImageMemorySize;for(const{data:t}of this.layerInfo[y.LayerClass.MAP])t instanceof M?this._mapTileMemory+=U.getGpuMemoryUsage(t.texture):t instanceof HTMLImageElement||t instanceof p.ImageWithType?this._mapTileMemory+=e:t instanceof m.RasterTile&&(this._mapTileMemory+=t.memoryUsage);for(const t of this.layerInfo[y.LayerClass.ELEVATION])this._usedMemory+=t.data?e:0;this.renderData&&(this._usedMemory+=this.renderData.estimatedGeometryMemoryUsage,this._mapTileMemory+=U.getGpuMemoryUsage(this.renderData.textureDescriptor)),this.isCached&&this._surface.upsampleMapCache.updateSize(this.key,this,this.cachedMemory)},f.getUsedMemoryForLayer=function(e,t){const i=this.layerInfo[e][t];if(!i||!i.data)return 0;if(e!==y.LayerClass.MAP||this.isCached){if(e===y.LayerClass.ELEVATION)return this.cpuImageMemorySize}else{const e=i.data;if(e instanceof M)return U.getGpuMemoryUsage(e.texture);if(e instanceof HTMLImageElement||e instanceof p.ImageWithType)return this.cpuImageMemorySize;if(e instanceof c.VectorTile||e instanceof m.RasterTile)return e.memoryUsage}return 0},f.updateScreenDepth=function(t){const i=this._center[e.CenterPosition.MIDDLE],n=t,s=i[0],a=i[1],r=i[2],o=n[2]*s+n[6]*a+n[10]*r+n[14];this._screenDepth=o<0?0:o/(n[3]*s+n[7]*a+n[11]*r+n[15])},f.shouldSplit=function(t,i,s){if(n.isSome(t.frustum)&&(!this._intersectsClippingArea||!this._isVisible(t.frustum)))return I.TileUpdate.NONE;const a=this.level;o.subtract(C,this._center[e.CenterPosition.MIDDLE],i);let r=o.squaredLength(C),l=e.CenterPosition.MIDDLE;o.subtract(N,this._center[e.CenterPosition.TOP],i);const h=o.squaredLength(N);h<r&&(r=h,l=e.CenterPosition.TOP),o.subtract(N,this._center[e.CenterPosition.BOTTOM],i);const u=o.squaredLength(N);if(u<r&&(r=u,l=e.CenterPosition.BOTTOM),this._edgeLen2>r&&a<t.maxLod)return I.TileUpdate.SPLIT;const d=Math.sqrt(r),c=t.fovX*d*2,p=this._edgeLen/c,g=()=>{const e=a+Math.ceil(-Math.log2(t.relativeWidthLimit/p));return e!==this.vlevel?(this.vlevel=e,I.TileUpdate.VSPLITMERGE):I.TileUpdate.NONE_HIT_MAXLOD};if(s===_.LODSnapping.ON){if(1===this._surface.snapLevel-a)return a>=t.maxLod?g():I.TileUpdate.SPLIT}const f=o.dot(this.up,C),y=this._elevationBounds[1]-this._elevationBounds[0],T=y/this.edgeLen;if(t.aboveGround&&f>0&&T<.001){if(f/d-Math.sin(this._curvatureHeight/(this.edgeLen*Math.SQRT1_2)*Math.PI)-T>0)return I.TileUpdate.NONE}if(p<t.relativeWidthLimit)return this.vlevel!==this.level?(this.vlevel=this.level,I.TileUpdate.VSPLITMERGE):I.TileUpdate.NONE;if(a>=t.maxLod)return g();if(a>6){o.subtract(N,this._center[l],i),o.scale(O,this.up,f),o.subtract(O,O,N);const e=o.squaredLength(O);if(e>this.radius*this.radius){o.scale(O,O,this.radius/Math.sqrt(e)),o.add(O,O,this._center[l]),o.subtract(O,i,O);const n=Math.min(1,(Math.abs(o.dot(O,this.up))+.5*y+this._curvatureHeight)/o.length(O)),s=P/t.angledSplitBias,a=t.fovY*d*2;if(n*(this._edgeLen/a)<s*t.relativeHeightLimit)return I.TileUpdate.NONE}}return I.TileUpdate.SPLIT},f.setChildren=function(e,t,i,n){L.weakAssert(!!(e&&t&&i&&n),"Null child passed"),this._children[0]=e,this._children[1]=t,this._children[2]=i,this._children[3]=n},f.unsetChildren=function(){this._children[0]=null,this._children[1]=null,this._children[2]=null,this._children[3]=null},f.load=function(e){this.refMapData();for(const t of y.LayerClasses)this._createOrUpdateAgents(0,t);e.loadTile(this)},f.unload=function(e){e.unloadTile(this);for(const t of y.LayerClasses){const e=this.layerInfo[t];for(const t of e)t.loadingAgent&&t.loadingAgent!==E.TILE_AGENT_DONE&&(b(t.loadingAgent),t.loadingAgent=null),t.pendingUpdates=0}this.resetPendingUpdate(I.TileUpdate.GEOMETRY),this.resetPendingUpdate(I.TileUpdate.TEXTURE_NOFADING),this.resetPendingUpdate(I.TileUpdate.TEXTURE_FADING),this.unrefMapData()},f.unloadMapData=function(){const e=this.layerInfo[y.LayerClass.MAP];for(const t of e)t.loadingAgent&&t.loadingAgent!==E.TILE_AGENT_DONE&&(b(t.loadingAgent),t.loadingAgent=null),t.pendingUpdates=0;this.renderData&&this.renderData.releaseTexture(),this.setMemoryDirty()},f.updateClippingStatus=function(e){if(u.equals(e,this._clippingArea))return!1;const t=this._intersectsClippingArea,i=this._isWithinClippingArea;n.isSome(e)?(this._intersectsClippingArea=this.intersectsExtent(e),this._isWithinClippingArea=this._isWithinExtent(e)):(this._intersectsClippingArea=!0,this._isWithinClippingArea=!0),this._clippingArea=e,this.updateVisibility();const s=i&&this._isWithinClippingArea,a=!(i||t||this._isWithinClippingArea||this._intersectsClippingArea);return!this.renderData||s||a||this.setPendingUpdate(I.TileUpdate.GEOMETRY),!0},f.updateVisibility=function(){this._dirty=!0,this._surface.setTileTreeDirty()},f.getLayerInfo=function(e,t){return this.layerInfo[t][e]},f.hasLayerData=function(e,t){const i=this.layerInfo[t][e];return!(!i||!i.data||i.dataInvalidated)},f._isSuspended=function(e){return!!this.hasPendingUpdate(I.TileUpdate.SPLIT)||e!==y.LayerClass.ELEVATION&&!this.loadable},f.hasPendingUpdate=function(e){return(this._pendingUpdates&e)===e},f.setPendingUpdate=function(e){this._pendingUpdates|=e,e===I.TileUpdate.SPLIT||e===I.TileUpdate.MERGE?this._surface.setTileTreeDirty():this._surface.requestUpdate()},f.resetPendingUpdate=function(e){return!!this.hasPendingUpdate(e)&&(this._pendingUpdates&=~e,!0)},f.requestLayerData=function(e,t,i){const s=this.layerInfo[t][e];if(s.waitingAgents.has(i))return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),i.tile.lij.toString(),t,e),!0;if(s.waitingAgents.push(i),s.data&&!s.dataInvalidated)return console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),i.tile.lij.toString(),t,e),i.dataArrived(this),!0;if(s.requestPromise)return!0;n.abortMaybe(s.requestAbort),s.requestAbort=new AbortController;const a=this._surface.requestTileData(this,e,t,s.requestAbort);if(!a)return s.requestAbort=null,!1;const r=()=>{s.requestPromise===a&&(s.requestPromise=null,s.requestAbort=null)};return s.requestPromise=a,a.then(r,r),!0},f.hasLij=function(e){return this.lij[0]===e[0]&&this.lij[1]===e[1]&&this.lij[2]===e[2]},f.findByLij=function(e){if(this.hasLij(e))return this;if(this.isLeaf)return null;const t=this._children[0].findByLij(e)||this._children[1].findByLij(e)||this._children[2].findByLij(e)||this._children[3].findByLij(e);return t||null},f.distanceToSquared=function(t){return o.squaredLength(o.subtract(O,this._center[e.CenterPosition.MIDDLE],t))},f.containsPoint=function(e){const t=this.extent;return e[0]>=t[0]&&e[1]>=t[1]&&e[0]<=t[2]&&e[1]<=t[3]},f.unrequestLayerData=function(e,t,i){const n=this.layerInfo[t][e],s=n.waitingAgents,a=null!=s.removeUnordered(i);L.weakAssert(a,"agent has not requested this piece of map data"),s.length<1&&(n.abortRequest(),this._updateMemoryUsed())},f.dataArrived=function(e,t,i){const n=this.layerInfo[t][e];n.data=i,n.dataInvalidated=!1,n.waitingAgents.forAll((e=>e.dataArrived(this))),n.waitingAgents.clear(),this._updateMemoryUsed()},f.dataMissing=function(e,t,i){i.notInTilemap||console.error(`Tile ${this.lij.toString()} layer ${t}/${e} error ${i}`);const n=this.layerInfo[t][e];n.dataMissing=!0,n.waitingAgents.forAll((e=>e.dataMissing())),n.waitingAgents.clear(),this._updateMemoryUsed()},f.updateRenderData=function(e,t){switch(e){case y.LayerClass.MAP:return this._updateTexture(t);case y.LayerClass.ELEVATION:return this._updateGeometry()}},f._updateTexture=function(e){this.renderData&&(this.resetPendingUpdate(e===_.TextureUpdate.FADING?I.TileUpdate.TEXTURE_NOFADING:I.TileUpdate.TEXTURE_FADING),this.setPendingUpdate(e===_.TextureUpdate.FADING?I.TileUpdate.TEXTURE_FADING:I.TileUpdate.TEXTURE_NOFADING))},f._updateGeometry=function(){this.setPendingUpdate(I.TileUpdate.GEOMETRY);for(const e of this.layerInfo[y.LayerClass.ELEVATION])e.pendingUpdates|=I.TileUpdate.GEOMETRY},f.invalidateLayerData=function(e,t){this.layerInfo[t][e].invalidateSourceData(),this.restartAgents(t)},f.computeElevationBounds=function(){a.set(this._elevationBounds,Number.MAX_VALUE,-Number.MAX_VALUE);const e=this.layerInfo[y.LayerClass.ELEVATION];let t=!0;for(const i of e)n.isSome(i.elevationBounds)&&(this._elevationBounds[0]=Math.min(this._elevationBounds[0],i.elevationBounds.min),this._elevationBounds[1]=Math.max(this._elevationBounds[1],i.elevationBounds.max),i.elevationBounds.hasNoDataValues||(t=!1));t&&(this._elevationBounds[0]=Math.min(this._elevationBounds[0],0),this._elevationBounds[1]=Math.max(this._elevationBounds[1],0)),this.updateRadiusAndCenter(),this._surface.setTileTreeDirty()},f._updateCenter=function(){const t=.5*(this._elevationBounds[0]+this._elevationBounds[1]);o.scale(O,this.up,t),o.add(this._center[e.CenterPosition.MIDDLE],this.centerAtSeaLevel,O),o.scale(O,this.up,this._elevationBounds[0]),o.add(this._center[e.CenterPosition.TOP],this.centerAtSeaLevel,O),o.scale(O,this.up,this._elevationBounds[1]),o.add(this._center[e.CenterPosition.BOTTOM],this.centerAtSeaLevel,O)},f.findElevationBoundsForLayer=function(e,t){const i=this.layerInfo[y.LayerClass.ELEVATION][e];if(n.isSome(i.elevationBounds)&&i.elevationBounds.level>=t)return;const s=this._surface.layerViewByIndex(e,y.LayerClass.ELEVATION),a=L.getLayerWithExtentRange(s);if(!D.fallsWithinLayer(this,a,!1))return;const r=G;let o=!1;if(i.data){const e=i.data;r.min=e.bounds[0],r.max=e.bounds[1],r.hasNoDataValues=e.hasNoDataValues,r.level=this.lij[0],o=!0}else{let t,i,n=0;for(let s=this._parent;s&&(!i||n<A.getElevationDesiredResolutionLevel(this.level))&&(n=this.vlevel-s.level,t=i||t,i=s.layerInfo[y.LayerClass.ELEVATION][e].data,!(!i&&t&&n>=A.getElevationDesiredResolutionLevel(this.level)));s=s.parent);i=i||t,i&&(i.computeMinMaxValue(this.lij[0],this.lij[1],this.lij[2],r),r.min!==1/0&&(r.level=i.level,o=!0))}o&&(n.isNone(i.elevationBounds)&&(i.elevationBounds=new g.ElevationBounds),i.elevationBounds.copyFrom(r))},f.modifyLayers=function(e,t,i){const n=this.layerInfo[i];for(const r of n)r.loadingAgent&&r.loadingAgent!==E.TILE_AGENT_DONE&&(b(r.loadingAgent),r.loadingAgent=null),r.waitingAgents.clear();for(let r=0;r<n.length;++r)void 0===e[r]&&n[r].release();const s=new Array(...n),a=t.length;n.length=a;for(let r=0;r<a;r++){const e=t[r];n[r]=e>-1?s[e]:v.TilePerLayerInfo.acquire(this._surface.upsampleInfoPool)}this._updateMemoryUsed()},f.restartAgents=function(e){this.renderData&&(this._createOrUpdateAgents(0,e),this.updateRenderData(e,_.TextureUpdate.FADING))},f.updateAgents=function(e){if(this.renderData){const t=this.layerInfo[e];for(const e of t)e.loadingAgent===E.TILE_AGENT_DONE&&(e.loadingAgent=null);this._createOrUpdateAgents(0,e)}},f.updateAgentSuspension=function(){for(const e of y.LayerClasses){const t=this._isSuspended(e);for(const i of this.layerInfo[e])i.loadingAgent&&i.loadingAgent!==E.TILE_AGENT_DONE&&(i.loadingAgent.setSuspension(t),i.loadingAgent===E.TILE_AGENT_DONE&&this.updateRenderData(e,_.TextureUpdate.FADING))}},f.removeLayerAgent=function(e,t){const i=this.layerInfo[t][e];i.loadingAgent&&i.loadingAgent!==E.TILE_AGENT_DONE&&i.loadingAgent.dispose(),i.loadingAgent=null},f.agentDone=function(e,t){const i=this.layerInfo[t][e];i.loadingAgent=E.TILE_AGENT_DONE,i.data||i.upsampleInfo||this._createOrUpdateAgents(e+1,t)},f._createOrUpdateAgents=function(e,t){const i=this._isSuspended(t),n=this.layerInfo[t];for(let s=e;s<n.length;++s){const e=n[s];let a=!1;const r=this._surface.layerViewByIndex(s,t),o=L.getLayerWithExtentRange(r);if(e.loadingAgent?D.fallsWithinLayer(this,o,!1)?(e.loadingAgent!==E.TILE_AGENT_DONE&&e.loadingAgent.setSuspension(i),e.loadingAgent!==E.TILE_AGENT_DONE&&(a=e.loadingAgent.update())):e.dispose():D.fallsWithinLayer(this,o,!1)&&(e.loadingAgent=x(this,s,t,i),a=e.loadingAgent.startLoading(),a?e.loadingAgent===E.TILE_AGENT_DONE&&this.setPendingUpdate(I.TileUpdate.GEOMETRY):(b(e.loadingAgent),e.loadingAgent=E.TILE_AGENT_DONE)),e.loadingAgent===E.TILE_AGENT_DONE&&this.updateRenderData(t,_.TextureUpdate.FADING),a&&r.isOpaque)return}},f._isWithinExtent=function(e){const t=this.extent;return t[0]>=e[0]&&e[2]>=t[2]&&t[1]>=e[1]&&e[3]>=t[3]},f.intersectsExtent=function(e){const t=this.extent;return t[2]>=e[0]&&e[2]>=t[0]&&t[3]>=e[1]&&e[3]>=t[1]},f.getElevationBasedVerticesPerRow=function(e){const t=this.vlevel-this.level,n=Math.max(this.level-e,A.getElevationDesiredResolutionLevel(this.level)-t);return i.clamp(1+(this.maxTesselation>>n),2,this.maxTesselation+1)},t._createClass(s,[{key:"usedMemory",get:function(){return this._usedMemory===V&&this._updateMemoryUsed(),this._usedMemory+(this.isCached?0:this.mapTileMemory)}},{key:"cachedMemory",get:function(){return this.isCached?this.mapTileMemory:0}},{key:"mapTileMemory",get:function(){this._usedMemory===V&&this._updateMemoryUsed();let e=this._mapTileMemory;for(const{data:t}of this.layerInfo[y.LayerClass.MAP])t instanceof c.VectorTile&&(e+=t.memoryUsage);return e}},{key:"isCached",get:function(){return!this.shouldLoad&&this._mapDataRefCount<=0}},{key:"maxTesselation",get:function(){return this._maxTesselation}},{key:"isWithinClippingArea",get:function(){return this._isWithinClippingArea}},{key:"intersectsClippingArea",get:function(){return this._intersectsClippingArea}},{key:"clippingArea",get:function(){return this._clippingArea}},{key:"parent",get:function(){return this._parent}},{key:"children",get:function(){return this._children}},{key:"surface",get:function(){return this._surface}},{key:"elevationBounds",get:function(){return this._elevationBounds}},{key:"level",get:function(){return this.lij[0]}},{key:"key",get:function(){return`${this.lij[0]}/${this.lij[1]}/${this.lij[2]}`}},{key:"edgeLen",get:function(){return this._edgeLen}},{key:"radius",get:function(){return this._center[e.CenterPosition.MIDDLE][3]}},{key:"screenDepth",get:function(){return this._screenDepth}},{key:"visible",get:function(){return this._dirty&&this.computeVisibility(),this._visible}},{key:"loadable",get:function(){return this.visible||this._surface.view.state.fixedContentCamera}},{key:"rendered",get:function(){const e=!!this.renderData;return e!==this._previouslyRendered&&(this._surface.emit("tiles-visibility-changed"),this._previouslyRendered=e,this._surface.renderer.setNeedsRender()),e}},{key:"shouldLoad",get:function(){if(!this.loadable)return!1;if(this._surface.lodSnapping===_.LODSnapping.ON){const e=this.level-this._surface.snapLevel;if(0===e)return!0;if(1===e)return!1}return this.isLeaf}},{key:"cpuImageMemorySize",get:function(){const e=4,t=this._surface.tilingScheme.pixelSize;return t*t*e}},{key:"updating",get:function(){if(this.hasPendingUpdates)return!0;for(const e of y.LayerClasses){const t=this.layerInfo[e];for(const e of t)if(e.loadingAgent&&e.loadingAgent!==E.TILE_AGENT_DONE&&e.loadingAgent.updating)return!0}return!1}},{key:"hasPendingUpdates",get:function(){return 0!==this._pendingUpdates}},{key:"isLeaf",get:function(){return null==this._children[0]}},{key:"test",get:function(){return{cachedMemory:this.cachedMemory}}}]),s}();function x(e,t,i,n){const s=i===y.LayerClass.ELEVATION?k.acquire():R.acquire();return s.init(e,t,i,n),s}function b(e){e.dispose(),e instanceof f.ElevationTileAgent?k.release(e):e instanceof T.MapTileAgent&&R.release(e)}const R=new s(T.MapTileAgent),k=new s(f.ElevationTileAgent),G=new g.ElevationBounds,V=-1;var q;e.CenterPosition=void 0,(q=e.CenterPosition||(e.CenterPosition={}))[q.TOP=0]="TOP",q[q.MIDDLE=1]="MIDDLE",q[q.BOTTOM=2]="BOTTOM",e.SplitLimits=S,e.Tile=B,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
