// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","../../../core/arrayUtils","../../../core/mathUtils","../../../core/ObjectPool","../../../core/promiseUtils","../../../core/libs/gl-matrix-2/vec2","../../../core/libs/gl-matrix-2/vec2f64","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../../../core/libs/gl-matrix-2/vec4","../../../core/libs/gl-matrix-2/vec4f64","../../../geometry/support/aaBoundingRect","../../2d/engine/vectorTiles/VectorTile","../support/StreamDataLoader","./ElevationBounds","./ElevationTileAgent","./MapTileAgent","./RasterTile","./TerrainConst","./terrainUtils","./TileAgent","./TilePerLayerInfo","./TileTexture","./tileUtils","../../webgl/Util"],(function(e,t,i,n,r,a,s,o,l,u,h,d,p,c,g,f,y,v,_,m,A,b,L,E,I,T){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.pruneAgents=t.Tile=t.SplitLimits=void 0;var M=A.weakAssert,D=u.vec3f64.create(),O=u.vec3f64.create(),U=u.vec3f64.create(),j=d.vec4f64.create(),B=function(){this.fovX=0,this.fovY=0,this.relativeWidthLimit=0,this.relativeHeightLimit=0,this.maxLod=0,this.angledSplitBias=0,this.aboveGround=!0};t.SplitLimits=B;var P=function(){function e(e){this._numSubdivisionAtLevel=e,this.lij=[0,0,0],this._children=[null,null,null,null],this._dirty=!0,this._previouslyRendered=!1,this.extent=p.create(),this._elevationBounds=o.vec2f64.create(),this.layerInfo=new Array(2),this.extentInRadians=p.create(),this.centerAtSeaLevel=u.vec3f64.create(),this._center=[u.vec3f64.create(),u.vec3f64.create(),u.vec3f64.create()],this.up=u.vec3f64.unitZ(),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._clippingArea=null,this._maxTesselation=0,this._usedMemory=q,this._mapTileMemory=0,this._mapDataRefCount=0,this._screenDepth=0,this.renderOrder=0,this._edgeLen=0,this._edgeLen2=0,this._radius=0,this._curvatureHeight=0}return Object.defineProperty(e.prototype,"usedMemory",{get:function(){return this._usedMemory===q&&this._updateMemoryUsed(),this._usedMemory+(this.isCached?0:this.mapTileMemory)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"cachedMemory",{get:function(){return this.isCached?this.mapTileMemory:0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"mapTileMemory",{get:function(){this._usedMemory===q&&this._updateMemoryUsed();for(var e=this._mapTileMemory,t=0,i=this.layerInfo[1];t<i.length;t++){var n=i[t].data;n instanceof c.VectorTile&&(e+=n.getMemoryUsage())}return e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isCached",{get:function(){return!this.shouldRender&&this._mapDataRefCount<=0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"maxTesselation",{get:function(){return this._maxTesselation},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"numSubdivisionsAtLevel",{get:function(){return this._numSubdivisionAtLevel},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isWithinClippingArea",{get:function(){return this._isWithinClippingArea},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"intersectsClippingArea",{get:function(){return this._intersectsClippingArea},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"clippingArea",{get:function(){return this._clippingArea},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"parent",{get:function(){return this._parent},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"children",{get:function(){return this._children},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"surface",{get:function(){return this._surface},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"elevationBounds",{get:function(){return this._elevationBounds},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"level",{get:function(){return this.lij[0]},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"edgeLen",{get:function(){return this._edgeLen},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"radius",{get:function(){return this._radius},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"screenDepth",{get:function(){return this._screenDepth},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"visible",{get:function(){if(this._dirty){var e=this._isVisible();e!==this._visible&&(this._visible=e,this.updateAgentSuspension(),this.surface.emit("tiles-visibility-changed"),this.surface.renderer.setNeedsRender()),this._dirty=!1}return this._visible},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"rendered",{get:function(){var e=!!this.renderData;return e!==this._previouslyRendered&&(this.surface.emit("tiles-visibility-changed"),this._previouslyRendered=e,this.surface.renderer.setNeedsRender()),e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"shouldRender",{get:function(){if(!this.visible)return!1;if(0===this.surface.lodSnapping){var e=this.level-this._surface.snapLevel;if(0===e)return!0;if(1===e)return!1}return this.isLeaf},enumerable:!1,configurable:!0}),e.prototype.init=function(e,t,i){this.lij[0]=e[0],this.lij[1]=e[1],this.lij[2]=e[2],i.tilingScheme.getExtent(e[0],e[1],e[2],this.extent),i.tilingScheme.convertExtentToRadians(this.extent,this.extentInRadians),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._clippingArea=null,this._mapDataRefCount=0,i.upsampleMapCache.pop(I.tile2str(this)),this._edgeLen=0,this._edgeLen2=0,this._radius=0,this.vlevel=e?e[0]:0,t&&t._elevationBounds?s.vec2.copy(this._elevationBounds,t.elevationBounds):s.vec2.set(this._elevationBounds,0,0),this._pendingUpdates=0,this.renderData=null,this._screenDepth=0,this._visible=!1,this._previouslyRendered=!1,this._parent=t,this.unsetChildren(),this._surface=i,this.updateVisibility();for(var n=0;n<2;n++){var r=i.numLayers(n),a=this.layerInfo[n];this.layerInfo[n]?a.length=r:(a=new Array(r),this.layerInfo[n]=a);for(var o=0;o<r;o++)a[o]=L.TilePerLayerInfo.makeEmptyLayerInfo(n,this._surface.upsampleInfoPool,a[o]),0===n&&this.findElevationBoundsForLayer(o,-1)}this.computeElevationBounds(),this._maxTesselation=Math.min(i.tilingScheme.pixelSize,m.MAX_PATCH_TESSELATION)},e.prototype.release=function(){M(!this.renderData,"tile.renderData was not unloaded"),this._surface.upsampleMapCache.pop(I.tile2str(this));for(var e=0;e<2;e++)for(var t=0,i=this.layerInfo[e];t<i.length;t++){i[t].dispose()}this._parent=null,this._surface=null,this._usedMemory=q},e.prototype.refMapData=function(){++this._mapDataRefCount,this.isCached||this._surface.upsampleMapCache.pop(I.tile2str(this))},e.prototype.unrefMapData=function(){if(--this._mapDataRefCount,this.isCached){var e=this.cachedMemory;e>0&&(this._surface.upsampleMapCache.put(I.tile2str(this),this,e),this.setMemoryDirty())}},e.prototype.setMemoryDirty=function(){this._usedMemory=q},Object.defineProperty(e.prototype,"cpuImageMemorySize",{get:function(){var e=this._surface.tilingScheme.pixelSize;return e*e*4},enumerable:!1,configurable:!0}),e.prototype._updateMemoryUsed=function(){this._usedMemory=0,this._mapTileMemory=0;for(var e=this.cpuImageMemorySize,t=0,i=this.layerInfo[1];t<i.length;t++){var n=(s=i[t]).data;n instanceof E.TileTexture?this._mapTileMemory+=T.getGpuMemoryUsage(n.texture):n instanceof HTMLImageElement||n instanceof g.ImageWithType?this._mapTileMemory+=e:n instanceof _.default&&(this._mapTileMemory+=n.getMemoryUsage())}for(var r=0,a=this.layerInfo[0];r<a.length;r++){var s=a[r];this._usedMemory+=s.data?e:0}if(this.renderData){this._usedMemory+=this.renderData.estimatedGeometryMemoryUsage;var o=this.renderData.textureDescriptor;o&&(this._mapTileMemory+=T.getGpuMemoryUsage(o))}this.isCached&&this._surface.upsampleMapCache.updateSize(I.tile2str(this),this,this.cachedMemory)},e.prototype.getUsedMemoryForLayer=function(e,t){var i=this.layerInfo[e][t];if(!i||!i.data)return 0;if(1!==e||this.isCached){if(0===e)return this.cpuImageMemorySize}else{var n=i.data;if(n instanceof E.TileTexture)return T.getGpuMemoryUsage(n.texture);if(n instanceof HTMLImageElement||n instanceof g.ImageWithType)return this.cpuImageMemorySize;if(n instanceof c.VectorTile||n instanceof _.default)return n.getMemoryUsage()}return 0},e.prototype.updateScreenDepth=function(e){l.vec3.copy(j,this._center[0]),j[3]=1,h.vec4.transformMat4(j,j,e),this._screenDepth=j[2]<0?0:j[2]/j[3]},e.prototype.shouldSplit=function(e,t,i){var r=this,a=this.level;l.vec3.subtract(D,this._center[0],t);var s=l.vec3.squaredLength(D),o=0;l.vec3.subtract(O,this._center[1],t);var u=l.vec3.squaredLength(O);u<s&&(s=u,o=1),l.vec3.subtract(O,this._center[2],t);var h=l.vec3.squaredLength(O);if(h<s&&(s=h,o=2),this._edgeLen2>s&&a<e.maxLod)return 2;var d=function(){var t=a+Math.ceil(-n.log2(e.relativeWidthLimit/v));return t!==r.vlevel?(r.vlevel=t,4):1};if(0===i&&1===this._surface.snapLevel-a)return a>=e.maxLod?d():2;var p=Math.sqrt(s),c=l.vec3.dot(this.up,D),g=this._elevationBounds[1]-this._elevationBounds[0],f=g/this.edgeLen;if(e.aboveGround&&c>0&&f<.001&&c/p-Math.sin(this._curvatureHeight/(this.edgeLen*Math.SQRT1_2)*Math.PI)-f>0)return 0;var y=e.fovX*p*2,v=this._edgeLen/y;if(v<e.relativeWidthLimit)return this.vlevel!==this.level?(this.vlevel=this.level,4):0;if(a>=e.maxLod)return d();if(a>6){l.vec3.subtract(O,this._center[o],t),l.vec3.scale(U,this.up,c),l.vec3.subtract(U,U,O);var _=l.vec3.squaredLength(U);if(_>this._radius*this._radius){l.vec3.scale(U,U,this._radius/Math.sqrt(_)),l.vec3.add(U,U,this._center[o]),l.vec3.subtract(U,t,U);var m=Math.min(1,(Math.abs(l.vec3.dot(U,this.up))+.5*g+this._curvatureHeight)/l.vec3.length(U)),A=.1/e.angledSplitBias,b=e.fovY*p*2;if(m*(this._edgeLen/b)<A*e.relativeHeightLimit)return 0}}return 2},e.prototype.setChildren=function(e,t,i,n){M(!!(e&&t&&i&&n),"Null child passed"),this._children[0]=e,this._children[1]=t,this._children[2]=i,this._children[3]=n},e.prototype.unsetChildren=function(){this._children[0]=null,this._children[1]=null,this._children[2]=null,this._children[3]=null},e.prototype.load=function(e){this.refMapData();for(var t=0;t<2;t++){this.layerInfo[t]&&this._createOrUpdateAgents(0,t)}e.loadTile(this)},e.prototype.unload=function(e){e.unloadTile(this);for(var t=0;t<2;t++)for(var i=0,n=this.layerInfo[t];i<n.length;i++){var r=n[i];r.loadingAgent&&r.loadingAgent!==b.TILE_AGENT_DONE&&(x(r.loadingAgent),r.loadingAgent=null),r.pendingUpdates=0}this.resetPendingUpdate(32),this.resetPendingUpdate(64),this.unrefMapData()},e.prototype.unloadMapData=function(){for(var e=0,t=this.layerInfo[1];e<t.length;e++){var i=t[e];i.loadingAgent&&i.loadingAgent!==b.TILE_AGENT_DONE&&(x(i.loadingAgent),i.loadingAgent=null),i.pendingUpdates=0}this.renderData&&this.renderData.releaseTexture(),this.setMemoryDirty()},e.prototype.updateClippingStatus=function(e){if(p.equals(e,this._clippingArea))return!1;var t=this._intersectsClippingArea,i=this._isWithinClippingArea;e?(this._intersectsClippingArea=this.intersectsExtent(e),this._isWithinClippingArea=this.isWithinExtent(e)):(this._intersectsClippingArea=!0,this._isWithinClippingArea=!0),this._clippingArea=e,this.updateVisibility();var n=i&&this._isWithinClippingArea,r=!(i||t||this._isWithinClippingArea||this._intersectsClippingArea);return!this.renderData||n||r||this.setPendingUpdate(32),!0},e.prototype.updateVisibility=function(){this._dirty=!0,this._surface.pendingUpdates=!0},e.prototype.getLayerInfo=function(e,t){return this.layerInfo[t][e]},e.prototype.hasLayerData=function(e,t){var i=this.layerInfo[t][e];return!(!i||!i.data||i.dataInvalidated)},Object.defineProperty(e.prototype,"updating",{get:function(){if(this.hasPendingUpdates)return!0;for(var e=0;e<2;e++)for(var t=0,i=this.layerInfo[e];t<i.length;t++){var n=i[t];if(n.loadingAgent&&n.loadingAgent!==b.TILE_AGENT_DONE&&n.loadingAgent.updating)return!0}return!1},enumerable:!1,configurable:!0}),e.prototype.isSuspended=function(e){return!!this.hasPendingUpdate(2)||0!==e&&!this.visible},Object.defineProperty(e.prototype,"hasPendingUpdates",{get:function(){return 0!==this._pendingUpdates},enumerable:!1,configurable:!0}),e.prototype.hasPendingUpdate=function(e){return(this._pendingUpdates&e)===e},e.prototype.setPendingUpdate=function(e){this._pendingUpdates|=e,this._surface.pendingUpdates=!0},e.prototype.resetPendingUpdate=function(e){return!!this.hasPendingUpdate(e)&&(this._pendingUpdates&=~e,!0)},e.prototype.requestLayerData=function(e,t,i){m.TILE_LOADING_DEBUGLOG&&console.log("tile %s layer %d/%d requested by tile %s",this.lij.toString(),t,e,i.tile.lij.toString());var n=this.layerInfo[t][e];if(n.waitingAgents.indexOf(i)>-1)return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),i.tile.lij.toString(),t,e),!0;if(n.waitingAgents.push(i),n.data&&!n.dataInvalidated)return console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),i.tile.lij.toString(),t,e),i.dataArrived(this),!0;if(n.requestPromise)return!0;n.requestAbort=a.createAbortController();var r=this._surface.requestTileData(this,e,t,n.requestAbort);if(!r)return n.requestAbort=null,!1;var s=function(){n.requestPromise===r&&(n.requestPromise=null,n.requestAbort=null)};return n.requestPromise=r,r.then(s,s),!!n.requestPromise},Object.defineProperty(e.prototype,"isLeaf",{get:function(){return null==this._children[0]},enumerable:!1,configurable:!0}),e.prototype.hasLij=function(e){return this.lij[0]===e[0]&&this.lij[1]===e[1]&&this.lij[2]===e[2]},e.prototype.findByLij=function(e){if(this.hasLij(e))return this;if(this.isLeaf)return null;var t=this._children[0].findByLij(e)||this._children[1].findByLij(e)||this._children[2].findByLij(e)||this._children[3].findByLij(e);return t||null},e.prototype.distanceToSquared=function(e){return l.vec3.squaredLength(l.vec3.subtract(U,this._center[0],e))},e.prototype.containsPoint=function(e){var t=this.extent;return e[0]>=t[0]&&e[1]>=t[1]&&e[0]<=t[2]&&e[1]<=t[3]},e.prototype.unrequestLayerData=function(e,t,n){m.TILE_LOADING_DEBUGLOG&&console.log("tile %s layer %d/%d canceled by tile %s",this.lij.toString(),t,e,n.tile.lij.toString());var r=this.layerInfo[t][e],a=r.waitingAgents,s=null!=i.removeUnordered(a,n);M(s,"agent has not requested this piece of map data"),a.length<1&&(r.abortRequest(),m.TILE_LOADING_DEBUGLOG&&console.log("tile %s layer %d/%d request/loading canceled",this.lij.toString(),t,e),this._updateMemoryUsed())},e.prototype.dataArrived=function(e,t,i){var n=this.layerInfo[t][e];n.data=i,n.dataInvalidated=!1;for(var r=0;r<n.waitingAgents.length;r++)n.waitingAgents[r].dataArrived(this);n.waitingAgents.length=0,this._updateMemoryUsed()},e.prototype.dataMissing=function(e,t,i){i.notInTilemap||console.error("Tile "+this.lij.toString()+" layer "+t+"/"+e+" error "+i);var n=this.layerInfo[t][e];n.dataMissing=!0;for(var r=0;r<n.waitingAgents.length;r++)n.waitingAgents[r].dataMissing();n.waitingAgents.length=0,this._updateMemoryUsed()},e.prototype.updateRenderData=function(e){switch(e){case 1:return this.updateTexture();case 0:return this.updateGeometry()}},e.prototype.updateTexture=function(){this.renderData&&this.setPendingUpdate(64)},e.prototype.updateGeometry=function(){this.setPendingUpdate(32);for(var e=0,t=this.layerInfo[0];e<t.length;e++){t[e].pendingUpdates|=32}},e.prototype.invalidateLayerData=function(e,t){this.layerInfo[t][e].invalidateSourceData(),this.restartAgents(t)},e.prototype.computeElevationBounds=function(){s.vec2.set(this._elevationBounds,Number.MAX_VALUE,-Number.MAX_VALUE);for(var e=!0,t=0,i=this.layerInfo[0];t<i.length;t++){var n=i[t];n.elevationBounds&&(this._elevationBounds[0]=Math.min(this._elevationBounds[0],n.elevationBounds.min),this._elevationBounds[1]=Math.max(this._elevationBounds[1],n.elevationBounds.max),n.elevationBounds.hasNoDataValues||(e=!1))}e&&(this._elevationBounds[0]=Math.min(this._elevationBounds[0],0),this._elevationBounds[1]=Math.max(this._elevationBounds[1],0)),this.updateRadiusAndCenter()},e.prototype._updateCenter=function(){var e=.5*(this._elevationBounds[0]+this._elevationBounds[1]);l.vec3.scale(U,this.up,e),l.vec3.add(this._center[0],this.centerAtSeaLevel,U),l.vec3.scale(U,this.up,this._elevationBounds[0]),l.vec3.add(this._center[1],this.centerAtSeaLevel,U),l.vec3.scale(U,this.up,this._elevationBounds[1]),l.vec3.add(this._center[2],this.centerAtSeaLevel,U)},e.prototype.findElevationBoundsForLayer=function(e,t){var i=this.layerInfo[0][e];if(!i.elevationBounds||i.elevationBounds.level<t){var n=this._surface.layerViewByIndex(e,0),r=A.getLayerWithExtentRange(n);if(I.fallsWithinLayer(this,r,!1)){var a=C,s=!1;if(i.data){var o=i.data;a.min=o.bounds[0],a.max=o.bounds[1],a.hasNoDataValues=o.hasNoDataValues,a.level=this.lij[0],s=!0}else{for(var l=0,u=void 0,h=(o=void 0,this._parent);h&&(!o||l<m.ELEVATION_DESIRED_RESOLUTION_LEVEL)&&(l=this.vlevel-h.level,u=o||u,!(!(o=h.layerInfo[0][e].data)&&u&&l>=m.ELEVATION_DESIRED_RESOLUTION_LEVEL));h=h._parent);(o=o||u)&&(o.computeMinMaxValue(this.lij[0],this.lij[1],this.lij[2],a),a.min!==1/0&&(a.level=o.level,s=!0))}s&&(i.elevationBounds||(i.elevationBounds=new f.ElevationBounds),i.elevationBounds.copyFrom(a))}}},e.prototype.modifyLayers=function(e,t,i){for(var n=this.layerInfo[i],r=0,a=n;r<a.length;r++){var s=a[r];s.loadingAgent&&s.loadingAgent!==b.TILE_AGENT_DONE&&(x(s.loadingAgent),s.loadingAgent=null),s.waitingAgents.length=0}if(1===i)for(var o=0;o<n.length;++o)void 0===e[o]&&n[o].dispose();var l=t.length,u=new Array(l);for(o=0;o<l;o++){var h=t[o];u[o]=h>-1?n[h]:L.TilePerLayerInfo.makeEmptyLayerInfo(i,this._surface.upsampleInfoPool)}this.layerInfo[i]=u,this._updateMemoryUsed()},e.prototype.restartAgents=function(e){this.renderData&&(this._createOrUpdateAgents(0,e),this.updateRenderData(e))},e.prototype.updateAgents=function(e){if(this.renderData){for(var t=this.layerInfo[e],i=0;i<t.length;i++){var n=t[i];n.loadingAgent===b.TILE_AGENT_DONE&&(n.loadingAgent=null)}this._createOrUpdateAgents(0,e)}},e.prototype.updateAgentSuspension=function(){for(var e=0;e<2;e++)for(var t=this.isSuspended(e),i=0,n=this.layerInfo[e];i<n.length;i++){var r=n[i];r.loadingAgent&&r.loadingAgent!==b.TILE_AGENT_DONE&&(r.loadingAgent.setSuspension(t),r.loadingAgent===b.TILE_AGENT_DONE&&this.updateRenderData(e))}},e.prototype.removeLayerAgent=function(e,t){var i=this.layerInfo[t][e];i.loadingAgent&&i.loadingAgent!==b.TILE_AGENT_DONE&&i.loadingAgent.dispose(),i.loadingAgent=null},e.prototype.agentDone=function(e,t){var i=this.layerInfo[t][e];i.loadingAgent=b.TILE_AGENT_DONE,i.data||i.upsampleInfo||this._createOrUpdateAgents(e+1,t)},e.prototype._createOrUpdateAgents=function(e,t){for(var i=this.isSuspended(t),n=this.layerInfo[t],r=e;r<n.length;++r){var a=n[r],s=!1,o=this._surface.layerViewByIndex(r,t),l=A.getLayerWithExtentRange(o);if(a.loadingAgent?I.fallsWithinLayer(this,l,!1)?(a.loadingAgent!==b.TILE_AGENT_DONE&&(m.TILE_LOADING_DEBUGLOG&&console.log(I.tile2str(this),"update suspended",i),a.loadingAgent.setSuspension(i)),a.loadingAgent!==b.TILE_AGENT_DONE&&(s=a.loadingAgent.update(),m.TILE_LOADING_DEBUGLOG&&console.log(I.tile2str(this),"update"))):a.dispose():I.fallsWithinLayer(this,l,!1)&&(a.loadingAgent=S(this,r,t,i),s=a.loadingAgent.startLoading(),m.TILE_LOADING_DEBUGLOG&&console.log(I.tile2str(this),"start"),s?a.loadingAgent===b.TILE_AGENT_DONE&&(m.TILE_LOADING_DEBUGLOG&&console.log(I.tile2str(this),"done"),this.setPendingUpdate(32)):(x(a.loadingAgent),a.loadingAgent=b.TILE_AGENT_DONE,m.TILE_LOADING_DEBUGLOG&&console.log(I.tile2str(this),"done"))),a.loadingAgent===b.TILE_AGENT_DONE&&this.updateRenderData(t),s&&o.isOpaque)return}},e.prototype.isWithinExtent=function(e){var t=this.extent;return t[0]>=e[0]&&e[2]>=t[2]&&t[1]>=e[1]&&e[3]>=t[3]},e.prototype.intersectsExtent=function(e){var t=this.extent;return t[2]>=e[0]&&e[2]>=t[0]&&t[3]>=e[1]&&e[3]>=t[1]},Object.defineProperty(e.prototype,"test",{get:function(){return{cachedMemory:this.cachedMemory}},enumerable:!1,configurable:!0}),e}();function S(e,t,i,n){var r=0===i?G.acquire():N.acquire();return r.init(e,t,i,n),r}function x(e){e.dispose(),e instanceof y.default?G.release(e):e instanceof v.default&&N.release(e)}t.Tile=P,t.pruneAgents=function(){N.prune(0),G.prune(0)};var N=new r(v.default),G=new r(y.default),C=new f.ElevationBounds,q=-1}));