/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/mathUtils","../../../core/maybe","../../../core/ObjectPool","../../../chunks/vec2","../../../chunks/vec2f64","../../../chunks/vec3","../../../chunks/vec3f64","../../../chunks/common","../../../geometry/ellipsoidUtils","../../../geometry/support/aaBoundingRect","../../../chunks/sphere","../../../layers/support/layerUtils","../../2d/engine/vectorTiles/VectorTile","../support/StreamDataLoader","./ElevationBounds","./ElevationTileAgent","./interfaces","./LayerClass","./MapTileAgent","./RasterTile","./TerrainConst","./terrainUtils","./TileAgent","./TilePerLayerInfo","./TileTexture","./TileUpdate","./tileUtils","../../webgl/Util"],(function(e,t,i,n,s,r,a,o,l,h,u,d,c,f,g,p,y,_,T,E,m,A,I,L,v,N,M,D,x,C){"use strict";const b=l.create(),S=l.create(),U=l.create(),O=.1;let P=function(){function s(){this.lij=[0,0,0],this._children=[null,null,null,null],this._pendingUpdates=0,this.renderData=null,this._dirty=!0,this._previouslyRendered=!1,this.extent=d.create(),this._elevationBounds=a.create(),this.layerInfo=[[],[]],this.extentInRadians=d.create(),this.centerAtSeaLevel=l.create(),this._center=[l.create(),c.create(),l.create()],this.up=l.unitZ(),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._maxTesselation=0,this._usedMemory=null,this._mapTileMemoryInternal=0,this._mapDataRefCount=0,this.screenDepth=0,this.renderOrder=0,this._edgeLen=0,this._edgeLen2=0,this._curvatureHeight=0,this.extentMidX=0,this.extentMidY=0,this.distanceToPOI=-1,this._lastPOI=l.create()}s.prune=function(){B.prune(0),V.prune(0),N.TilePerLayerInfo.prune()};var _=s.prototype;return _.computeVisibility=function(){this._dirty=!1;const e=this.parent?.frustumVisibility??T.TileFrustumVisibility.INTERSECTS;this._frustumVisibility=e===T.TileFrustumVisibility.INSIDE?T.TileFrustumVisibility.INSIDE:e===T.TileFrustumVisibility.OUTSIDE?T.TileFrustumVisibility.OUTSIDE:this._calculateFrustumVisibilityStatus(this.surface.frustum);const t=this._frustumVisibility!==T.TileFrustumVisibility.OUTSIDE&&this._intersectsClippingArea;t!==this._visible&&(this._visible=t,this._surface.emit("tiles-visibility-changed"),this._surface.renderer.setDirty(),this.updateAgentSuspension())},_.init=function(t,i,n){this.lij[0]=t[0],this.lij[1]=t[1],this.lij[2]=t[2],this.ellipsoid=u.getReferenceEllipsoid(n.tilingScheme.spatialReference),n.tilingScheme.getExtent(t[0],t[1],t[2],this.extent),n.tilingScheme.convertExtentToRadians(this.extent,this.extentInRadians),this.extentMidX=.5*(this.extent[0]+this.extent[2]),this.extentMidY=.5*(this.extent[1]+this.extent[3]),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._clippingArea=null,this._mapDataRefCount=0,n.upsampleMapCache.pop(this.key),this._edgeLen=0,this._edgeLen2=0,this._center[e.CenterPosition.MIDDLE][3]=0,this.vlevel=t?t[0]:0,i&&i.elevationBounds?r.copy(this._elevationBounds,i.elevationBounds):r.set(this._elevationBounds,0,0),this._pendingUpdates=0,this.renderData=null,this.screenDepth=0,this._visible=!1,this._previouslyRendered=!1,this._parent=i,this.unsetChildren(),this._surface=n,this.updateVisibility();for(const e of E.LayerClasses){const t=n.numLayers(e),i=this.layerInfo[e];for(const e of i)e.release();i.length=t;for(let n=0;n<t;n++)i[n]=N.TilePerLayerInfo.acquire(this._surface.upsampleInfoPool),e===E.LayerClass.ELEVATION&&this.findElevationBoundsForLayer(n,-1)}this.computeElevationBounds(),this._maxTesselation=Math.min(n.tilingScheme.pixelSize,I.MAX_PATCH_TESSELATION)},_.release=function(){L.weakAssert(!this.renderData,"tile.renderData was not unloaded"),this._surface.upsampleMapCache.pop(this.key);for(const e of E.LayerClasses){for(const t of this.layerInfo[e])t.release();this.layerInfo[e].length=0}this._parent=null;for(let e=0;e<4;++e)this._children[e]=null;this._surface=null,this.setMemoryDirty()},_.refMapData=function(){++this._mapDataRefCount,this._isCached||this._surface.upsampleMapCache.pop(this.key)},_.unrefMapData=function(){if(--this._mapDataRefCount,this._isCached){this.setMemoryDirty();const e=this._cachedMemory;e>0&&this._surface.upsampleMapCache.put(this.key,this,e)}},_.setMemoryDirty=function(){this._usedMemory=null},_._ensureUsedMemory=function(){if(n.isSome(this._usedMemory))return this._usedMemory;this._usedMemory=0,this._mapTileMemoryInternal=0;let e=0;for(const{data:i}of this.layerInfo[E.LayerClass.MAP])i instanceof g.VectorTile?e+=this._getTerrainDataMemory(i):this._mapTileMemoryInternal+=this._getTerrainDataMemory(i);const t=this._cpuImageMemorySize;for(const i of this.layerInfo[E.LayerClass.ELEVATION])this._usedMemory+=i.data?t:0;return this.renderData&&(this._usedMemory+=this.renderData.estimatedGeometryMemoryUsage,this._mapTileMemoryInternal+=C.getGpuMemoryUsage(this.renderData.textureDescriptor)),this._isCached&&this._surface.upsampleMapCache.updateSize(this.key,this,this._mapTileMemoryInternal+e),this._usedMemory},_.getUsedMemoryForLayer=function(e,t){const i=this.layerInfo[e][t];return i?.data?e===E.LayerClass.MAP?this._isCached?0:this._getTerrainDataMemory(i.data):e===E.LayerClass.ELEVATION?this._cpuImageMemorySize:0:0},_._getTerrainDataMemory=function(e){return e instanceof M?C.getGpuMemoryUsage(e.texture):e instanceof HTMLImageElement||e instanceof p.ImageWithType?this._cpuImageMemorySize:e instanceof g.VectorTile||e instanceof A.RasterTile?e.memoryUsage:0},_.updateScreenDepth=function(t){const i=this._center[e.CenterPosition.MIDDLE],n=t,s=i[0],r=i[1],a=i[2],o=n[2]*s+n[6]*r+n[10]*a+n[14];this.screenDepth=o<0?0:o/(n[3]*s+n[7]*r+n[11]*a+n[15])},_.shouldSplit=function(t,i,s){if(!this.visible)return D.TileUpdate.NONE;if(n.isSome(t.frustum)&&(!this._intersectsClippingArea||this._calculateFrustumVisibilityStatus(t.frustum)===T.TileFrustumVisibility.OUTSIDE))return D.TileUpdate.NONE;const r=this.level;o.subtract(b,this._center[e.CenterPosition.MIDDLE],i);let a=o.squaredLength(b),l=e.CenterPosition.MIDDLE;o.subtract(S,this._center[e.CenterPosition.TOP],i);const h=o.squaredLength(S);h<a&&(a=h,l=e.CenterPosition.TOP),o.subtract(S,this._center[e.CenterPosition.BOTTOM],i);const u=o.squaredLength(S);if(u<a&&(a=u,l=e.CenterPosition.BOTTOM),this._edgeLen2>a&&r<t.maxLod)return D.TileUpdate.SPLIT;const d=Math.sqrt(a),c=t.fovX*d*2,f=this._edgeLen/c,g=()=>{const e=r+Math.ceil(-Math.log2(t.relativeWidthLimit/f));return e!==this.vlevel?(this.vlevel=e,D.TileUpdate.VSPLITMERGE):D.TileUpdate.NONE_HIT_MAXLOD};if(n.isSome(s)){if(1===s-r)return r>=t.maxLod?g():D.TileUpdate.SPLIT}const p=o.dot(this.up,b),y=this._elevationBounds[1]-this._elevationBounds[0],_=y/this.edgeLen;if(t.aboveGround&&p>0&&_<.001){if(p/d-Math.sin(this._curvatureHeight/(this.edgeLen*Math.SQRT1_2)*Math.PI)-_>0)return D.TileUpdate.NONE}if(f<t.relativeWidthLimit)return this.vlevel!==this.level?(this.vlevel=this.level,D.TileUpdate.VSPLITMERGE):D.TileUpdate.NONE;if(r>=t.maxLod)return g();if(r>6){o.subtract(S,this._center[l],i),o.scale(U,this.up,p),o.subtract(U,U,S);const e=o.squaredLength(U);if(e>this.radius*this.radius){o.scale(U,U,this.radius/Math.sqrt(e)),o.add(U,U,this._center[l]),o.subtract(U,i,U);const n=Math.min(1,(Math.abs(o.dot(U,this.up))+.5*y+this._curvatureHeight)/o.length(U)),s=O/t.angledSplitBias,r=t.fovY*d*2;if(n*(this._edgeLen/r)<s*t.relativeHeightLimit)return D.TileUpdate.NONE}}return D.TileUpdate.SPLIT},_.setChildren=function(e,t,i,n){L.weakAssert(!!(e&&t&&i&&n),"Null child passed"),this._children[0]=e,this._children[1]=t,this._children[2]=i,this._children[3]=n},_.unsetChildren=function(){this._children[0]=null,this._children[1]=null,this._children[2]=null,this._children[3]=null},_.load=function(){this.refMapData();for(const e of E.LayerClasses)this._createOrUpdateAgents(0,e);this.surface.renderer.loadTile(this)},_.unload=function(e){e.unloadTile(this);for(const t of E.LayerClasses){const e=this.layerInfo[t];for(const t of e)t.loadingAgent&&t.loadingAgent!==v.TILE_AGENT_DONE&&(k(t.loadingAgent),t.loadingAgent=null),t.pendingUpdates=0}this.resetPendingUpdate(D.TileUpdate.GEOMETRY),this.resetPendingUpdate(D.TileUpdate.TEXTURE_NOFADING),this.resetPendingUpdate(D.TileUpdate.TEXTURE_FADING),this.unrefMapData()},_.unloadMapData=function(){const e=this.layerInfo[E.LayerClass.MAP];for(const t of e)t.loadingAgent&&t.loadingAgent!==v.TILE_AGENT_DONE&&(k(t.loadingAgent),t.loadingAgent=null),t.pendingUpdates=0;this.renderData&&this.renderData.releaseTexture(),this.setMemoryDirty()},_.updateClippingStatus=function(e){if(d.equals(e,this._clippingArea))return!1;const t=this._intersectsClippingArea,i=this._isWithinClippingArea;n.isSome(e)?(this._intersectsClippingArea=this.intersectsExtent(e),this._isWithinClippingArea=this._isWithinExtent(e)):(this._intersectsClippingArea=!0,this._isWithinClippingArea=!0),this._clippingArea=e,this.updateVisibility();const s=i&&this._isWithinClippingArea,r=!(i||t||this._isWithinClippingArea||this._intersectsClippingArea);return!this.renderData||s||r||this.setPendingUpdate(D.TileUpdate.GEOMETRY),!0},_.updateVisibility=function(){this._dirty=!0,this._surface.setTileTreeDirty()},_.getLayerInfo=function(e,t){return this.layerInfo[t][e]},_.hasLayerData=function(e,t){const i=this.layerInfo[t][e];return!(!i||!i.data||i.dataInvalidated)},_._isSuspended=function(e){return!!this.hasPendingUpdate(D.TileUpdate.SPLIT)||e!==E.LayerClass.ELEVATION&&!this.loadable},_.hasPendingUpdate=function(e){return(this._pendingUpdates&e)===e},_.setPendingUpdate=function(e){this._pendingUpdates|=e,e===D.TileUpdate.SPLIT||e===D.TileUpdate.MERGE?this._surface.setTileTreeDirty():this._surface.requestUpdate()},_.resetPendingUpdate=function(e){return!!this.hasPendingUpdate(e)&&(this._pendingUpdates&=~e,!0)},_.requestLayerData=function(e,t,i){const s=this.layerInfo[t][e];if(s.waitingAgents.has(i))return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),i.tile.lij.toString(),t,e),!0;if(s.waitingAgents.push(i),s.data&&!s.dataInvalidated)return console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),i.tile.lij.toString(),t,e),i.dataArrived(this),!0;if(s.requestPromise)return!0;n.abortMaybe(s.requestAbort),s.requestAbort=new AbortController;const r=this._surface.requestTileData(this,e,t,s.requestAbort);if(!r)return s.requestAbort=null,!1;const a=()=>{s.requestPromise===r&&(s.requestPromise=null,s.requestAbort=null)};return s.requestPromise=r,r.then(a,a),!0},_.hasLij=function(e){return this.lij[0]===e[0]&&this.lij[1]===e[1]&&this.lij[2]===e[2]},_.findByLij=function(e){if(this.hasLij(e))return this;const t=this._children;if(!t[0])return null;return t[0].findByLij(e)||t[1].findByLij(e)||t[2].findByLij(e)||t[3].findByLij(e)},_.distanceToSquared=function(t){return o.squaredLength(o.subtract(U,this._center[e.CenterPosition.MIDDLE],t))},_.containsPoint=function(e){const t=this.extent;return e[0]>=t[0]&&e[1]>=t[1]&&e[0]<=t[2]&&e[1]<=t[3]},_.containsPointXY=function(e,t){const i=this.extent;return e>=i[0]&&t>=i[1]&&e<=i[2]&&t<=i[3]},_.unrequestLayerData=function(e,t,i){const n=this.layerInfo[t][e],s=n.waitingAgents,r=null!=s.removeUnordered(i);L.weakAssert(r,"agent has not requested this piece of map data"),s.length<1&&(n.abortRequest(),this.setMemoryDirty())},_.dataArrived=function(e,t,i){const n=this.layerInfo[t][e];n.data=i,n.dataInvalidated=!1,n.waitingAgents.forAll((e=>e.dataArrived(this))),n.waitingAgents.clear(),this.setMemoryDirty()},_.dataMissing=function(e,t,i){i.notInTilemap||console.error(`Tile ${this.lij.toString()} layer ${t}/${e} error ${i}`);const n=this.layerInfo[t][e];n.dataMissing=!0,n.waitingAgents.forAll((e=>e.dataMissing())),n.waitingAgents.clear(),this.setMemoryDirty()},_.updateRenderData=function(e,t){switch(e){case E.LayerClass.MAP:return this._updateTexture(t);case E.LayerClass.ELEVATION:return this._updateGeometry()}},_._updateTexture=function(e){this.renderData&&(this.resetPendingUpdate(e===T.TextureUpdate.FADING?D.TileUpdate.TEXTURE_NOFADING:D.TileUpdate.TEXTURE_FADING),this.setPendingUpdate(e===T.TextureUpdate.FADING?D.TileUpdate.TEXTURE_FADING:D.TileUpdate.TEXTURE_NOFADING))},_._updateGeometry=function(){this.setPendingUpdate(D.TileUpdate.GEOMETRY);for(const e of this.layerInfo[E.LayerClass.ELEVATION])e.pendingUpdates|=D.TileUpdate.GEOMETRY},_.invalidateLayerData=function(e,t){this.layerInfo[t][e].invalidateSourceData(),this.restartAgents(t)},_.computeElevationBounds=function(){const e=this._elevationBounds,t=e[0],i=e[1];r.set(e,1/0,-1/0);const s=this.layerInfo[E.LayerClass.ELEVATION];let a=!0;for(const r of s)n.isSome(r.elevationBounds)&&(e[0]=Math.min(e[0],r.elevationBounds.min),e[1]=Math.max(e[1],r.elevationBounds.max),r.elevationBounds.hasNoDataValues||(a=!1));a&&(e[0]=Math.min(e[0],0),e[1]=Math.max(e[1],0)),t===e[0]&&i===e[1]||(this.updateRadiusAndCenter(),this._surface.setTileTreeDirty())},_._updateCenter=function(){const t=this._elevationBounds,i=.5*(t[0]+t[1]),n=this._center;o.scale(U,this.up,i),o.add(n[e.CenterPosition.MIDDLE],this.centerAtSeaLevel,U),o.scale(U,this.up,t[0]),o.add(n[e.CenterPosition.TOP],this.centerAtSeaLevel,U),o.scale(U,this.up,t[1]),o.add(n[e.CenterPosition.BOTTOM],this.centerAtSeaLevel,U)},_.findElevationBoundsForLayer=function(e,t){const i=this.layerInfo[E.LayerClass.ELEVATION][e],s=I.getElevationDesiredResolutionLevel(this.level),r=Math.max(this.vlevel-s,0),a=i.elevationBounds;if(n.isSome(a)&&a.level>=t&&a.level<=r)return;const o=this._surface.layerViewByIndex(e,E.LayerClass.ELEVATION),l=L.getLayerWithExtentRange(o);if(!x.fallsWithinLayer(this,l,!1))return;const h=G;let u=!1;const d=i.data;if(d&&d.level<=r){const e=i.data;h.min=e.samplerData.data.minValue,h.max=e.samplerData.data.maxValue,h.hasNoDataValues=e.samplerData.data.hasNoDataValues,h.level=this.level,u=!0}else{let t,i,n=0;for(let a=this._parent;a&&(!i||n<s)&&(n=this.vlevel-a.level,t=i||t,i=a.layerInfo[E.LayerClass.ELEVATION][e].data,!(!i&&t&&a.level<=r));a=a.parent);i=i||t,i&&(i.computeMinMaxValue(this.lij[0],this.lij[1],this.lij[2],h),h.min!==1/0&&(h.level=i.level,u=!0))}u&&(n.isNone(i.elevationBounds)&&(i.elevationBounds=new y.ElevationBounds),i.elevationBounds.copyFrom(h))},_.modifyLayers=function(e,t,i){const n=this.layerInfo[i];for(const a of n)a.loadingAgent&&a.loadingAgent!==v.TILE_AGENT_DONE&&(k(a.loadingAgent),a.loadingAgent=null),a.waitingAgents.clear();for(let a=0;a<n.length;++a)void 0===e[a]&&n[a].release();const s=new Array(...n),r=t.length;n.length=r;for(let a=0;a<r;a++){const e=t[a];n[a]=e>-1?s[e]:N.TilePerLayerInfo.acquire(this._surface.upsampleInfoPool)}this.setMemoryDirty()},_.restartAgents=function(e){this.renderData&&(this._createOrUpdateAgents(0,e),this.updateRenderData(e,T.TextureUpdate.FADING))},_.updateAgents=function(e){if(this.renderData){const t=this.layerInfo[e];for(const e of t)e.loadingAgent===v.TILE_AGENT_DONE&&(e.loadingAgent=null);this._createOrUpdateAgents(0,e)}},_.updateAgentSuspension=function(){for(const e of E.LayerClasses){const t=this._isSuspended(e);for(const i of this.layerInfo[e])i.loadingAgent&&i.loadingAgent!==v.TILE_AGENT_DONE&&(i.loadingAgent.setSuspension(t),i.loadingAgent===v.TILE_AGENT_DONE&&this.updateRenderData(e,T.TextureUpdate.FADING))}},_.removeLayerAgent=function(e,t){const i=this.layerInfo[t][e];i.loadingAgent&&i.loadingAgent!==v.TILE_AGENT_DONE&&i.loadingAgent.dispose(),i.loadingAgent=null},_.agentDone=function(e,t){const i=this.layerInfo[t][e];i.loadingAgent=v.TILE_AGENT_DONE,!i.data&&n.isNone(i.upsampleInfo)&&this._createOrUpdateAgents(e+1,t)},_._hasBlendableAncestor=function(e){return"normal"!==e.blendMode||f.isGroupLayer(e.parent)&&this._hasBlendableAncestor(e.parent)},_._hasBlendModes=function(e,t,i){for(let n=e;n<t;++n){const e=this._surface.layerViewByIndex(n,i);if(L.isBlendableLayerView(e)&&"normal"!==e?.layer?.blendMode||f.isGroupLayer(e?.layer?.parent)&&this._hasBlendableAncestor(e?.layer?.parent))return!0}return!1},_._createOrUpdateAgents=function(e,t){const i=this.layerInfo[t];if(0===i.length)return;const n=this._isSuspended(t);for(let s=e;s<i.length;++s){const r=i[s];let a=!1;const o=this._surface.layerViewByIndex(s,t),l=L.getLayerWithExtentRange(o);if(r.loadingAgent?x.fallsWithinLayer(this,l,!1)?(r.loadingAgent!==v.TILE_AGENT_DONE&&r.loadingAgent.setSuspension(n),r.loadingAgent!==v.TILE_AGENT_DONE&&(a=r.loadingAgent.update())):r.dispose():x.fallsWithinLayer(this,l,!1)&&(r.loadingAgent=R(this,s,t,n),a=r.loadingAgent.startLoading(),a?r.loadingAgent===v.TILE_AGENT_DONE&&this.setPendingUpdate(D.TileUpdate.GEOMETRY):(k(r.loadingAgent),r.loadingAgent=v.TILE_AGENT_DONE)),r.loadingAgent===v.TILE_AGENT_DONE&&this.updateRenderData(t,T.TextureUpdate.FADING),!this._hasBlendModes(e,i.length,t)&&a&&o.isOpaque)return}},_._isWithinExtent=function(e){const t=this.extent;return t[0]>=e[0]&&e[2]>=t[2]&&t[1]>=e[1]&&e[3]>=t[3]},_.intersectsExtent=function(e){const t=this.extent;return t[2]>=e[0]&&e[2]>=t[0]&&t[3]>=e[1]&&e[3]>=t[1]},_.getElevationVerticesPerSide=function(e){const t=this.vlevel-this.level,n=Math.max(this.level-e,I.getElevationDesiredResolutionLevel(this.level)-t),s=i.clamp(1+(this.maxTesselation>>n),2,this.maxTesselation+1),r=this.getDefaultVerticesPerSide();return Math.max(s,r)},_._findLIJ=function(e,t){if(!e)return null;const i=this.surface.rootTiles;if(n.isSome(i))for(const n of i)if(j(n,e)){let i=n,s=e[0]-i.level-1;for(;s>=0&&!i.isLeaf&&!t(i);){const t=e[1]>>s&1,n=e[2]>>s&1;i=i.children[2*t+n],s--}return t(i)?i:null}return null},_.findNeighborTile=function(e,t){const i=this.lij,n=this.getNeighborLIJ(i,e);return n?W(i,n)?t(this)?this:null:this._findLIJ(n,t):null},_.findCorner=function(e,t){const i=e===T.NeighborIndex.NORTH_EAST?1:e===T.NeighborIndex.NORTH_WEST?0:e===T.NeighborIndex.SOUTH_WEST?2:3;let n=this;for(;n.children[0]&&(!t||!t(n));)n=n.children[i];return n},_.findNeighborCornerTileExact=function(e,t){return this.findNeighborTile(e,(e=>t(e)||e.level===this.level))?.findCorner(L.oppositeCorner(e),t)||null},_.forAllSubtreeOnSide=function(e,t){const i=e===T.NeighborIndex.NORTH?[0,1]:e===T.NeighborIndex.NORTH_EAST?[1]:e===T.NeighborIndex.EAST?[1,3]:e===T.NeighborIndex.SOUTH_EAST?[3]:e===T.NeighborIndex.SOUTH?[2,3]:e===T.NeighborIndex.SOUTH_WEST?[2]:e===T.NeighborIndex.WEST?[0,2]:[0],n=e=>{const s=e.children;!t(e)&&s[0]&&i.forEach((e=>n(s[e])))};n(this)},_.forallNeighbors=function(e){L.neighborCornerIndices.forEach((t=>this.findNeighborCornerTileExact(t,e))),L.neighborEdgeIndices.forEach((t=>this.findNeighborTile(t,(t=>t.level===this.level||e(t)))?.forAllSubtreeOnSide(L.oppositeEdge(t),e)))},_.getNeighborEdgeStartVertexIndex=function(e,t){if(!t)return 0;const i=this.level-t.level;if(L.internalAssert(!L.ENABLE_TERRAIN_INTERNAL_CHECKS||i>=0),0===i)return 0;const n=2**i,s=1==(1&e),r=s?0:1,a=t.lij[r+1]*n,o=this.lij[r+1],l=o-a,h=s?n-1-l:l;return L.ENABLE_TERRAIN_INTERNAL_CHECKS&&(L.internalAssert(a<=o&&o<a+n),L.internalAssert(0<=h&&h<n)),h},_.forEachLoadedNeighbor=function(e){const t=this.level,i=e=>e.level===t||e.isLoaded;L.neighborEdgeIndices.forEach((t=>{const n=this.findNeighborTile(t,i);null!=n&&n!==this&&n.forAllSubtreeOnSide(L.oppositeEdge(t),(i=>!!i.isLoaded&&(e(i,t),!0)))})),L.neighborCornerIndices.forEach((t=>{const n=this.findNeighborTile(t,i)?.findCorner(L.oppositeCorner(t),(e=>e.isLoaded));L.internalAssert(!n||F(this,n,t)),n?.isLoaded&&e(n,t)}))},_.getNeighborLIJ=function(e,t){const i=L.isNorth(t)?-1:L.isSouth(t)?1:0,n=L.isWest(t)?-1:L.isEast(t)?1:0,s=[e[0],e[1]+i,e[2]+n];return s[1]<0?null:this.surface.isGlobal?this.wrapLIJ(s):s[2]<0?null:s},_.wrapLIJ=function(e){return!e||e[1]<0||e[1]>=2**e[0]?null:this.surface.wrapEastWest(e)},_.checkGeometryWaterproofness=function(){L.ENABLE_WATERPROOFNESS_TESTS&&(L.internalAssert(this.isLoaded),this.renderData?.checkGeometryWaterproofness())},_.shouldHaveNeighbor=function(e){const t=this.extent,i=this.surface.rootTilesExtent,n=.25*(t[2]-t[0]);if(L.isNorth(e)&&t[3]+n>=i[3])return!1;if(L.isSouth(e)&&t[1]-n<=i[1])return!1;const s=this.surface.isGlobal;return!(!s&&L.isWest(e)&&t[0]-n<=i[0])&&!(!s&&L.isEast(e)&&t[2]+n>=i[2])},_.updateDistanceToPOI=function(t){const i=this._lastPOI;if(this.distanceToPOI>=0&&i[0]===t[0]&&i[1]===t[1]&&i[2]===t[2])return;o.copy(this._lastPOI,t);const n=this._center[e.CenterPosition.MIDDLE],s=t[0]-n[0],r=t[1]-n[1],a=t[2]-n[2];this.distanceToPOI=s*s+r*r+a*a},t._createClass(s,[{key:"_isCached",get:function(){return!this.shouldLoad&&this._mapDataRefCount<=0}},{key:"maxTesselation",get:function(){return this._maxTesselation}},{key:"isWithinClippingArea",get:function(){return this._isWithinClippingArea}},{key:"intersectsClippingArea",get:function(){return this._intersectsClippingArea}},{key:"clippingArea",get:function(){return this._clippingArea}},{key:"parent",get:function(){return this._parent}},{key:"children",get:function(){return this._children}},{key:"surface",get:function(){return this._surface}},{key:"elevationBounds",get:function(){return this._elevationBounds}},{key:"level",get:function(){return this.lij[0]}},{key:"key",get:function(){return`${this.lij[0]}/${this.lij[1]}/${this.lij[2]}`}},{key:"edgeLen",get:function(){return this._edgeLen}},{key:"radius",get:function(){return this._center[e.CenterPosition.MIDDLE][3]}},{key:"visible",get:function(){return this._dirty&&this.computeVisibility(),this._visible}},{key:"frustumVisibility",get:function(){return this._dirty&&this.computeVisibility(),this._frustumVisibility}},{key:"loadable",get:function(){return this.visible||this._surface.view.state.fixedContentCamera}},{key:"rendered",get:function(){const e=!!this.renderData;return e!==this._previouslyRendered&&(this._surface.emit("tiles-visibility-changed"),this._previouslyRendered=e,this._surface.renderer.setDirty()),e}},{key:"shouldLoad",get:function(){const e=this._surface.snapLevel;if(n.isSome(e)){const t=this.level-e;if(0===t)return!0;if(1===t)return!1}return this.isLeaf}},{key:"usedMemory",get:function(){return this._ensureUsedMemory()+(this._isCached?0:this._mapTileMemoryInternal)}},{key:"_cachedMemory",get:function(){return this._isCached?this._mapTileMemory:0}},{key:"_mapTileMemory",get:function(){return this._ensureUsedMemory(),this.layerInfo[E.LayerClass.MAP].reduce(((e,t)=>e+(t instanceof g.VectorTile?t.memoryUsage:0)),this._mapTileMemoryInternal)}},{key:"_cpuImageMemorySize",get:function(){const e=4,t=this._surface.tilingScheme.pixelSize;return t*t*e}},{key:"isLoaded",get:function(){return this.renderData?.hasGeometry??!1}},{key:"updating",get:function(){if(this.hasPendingUpdates)return!0;for(const e of E.LayerClasses){const t=this.layerInfo[e];for(const e of t)if(e.loadingAgent&&e.loadingAgent!==v.TILE_AGENT_DONE&&e.loadingAgent.updating)return!0}return!1}},{key:"hasPendingUpdates",get:function(){return 0!==this._pendingUpdates}},{key:"isLeaf",get:function(){return null==this._children[0]}},{key:"test",get:function(){return{cachedMemory:this._cachedMemory}}},{key:"westNeighborWestExtent",get:function(){return this.extent[0]*(this.isWestEnd?-1:1)}},{key:"eastNeighborEastExtent",get:function(){return this.extent[2]*(this.isEastEnd?-1:1)}},{key:"isEastEnd",get:function(){return this.lij[2]===this.surface.lijEastEnd(this.level)-1}},{key:"isWestEnd",get:function(){return 0===this.lij[2]}},{key:"isNorthEnd",get:function(){return 0===this.lij[1]}},{key:"isSouthEnd",get:function(){return this.extent[1]+h.getEpsilon()>=this.surface.extent[1]}}]),s}();function R(e,t,i,n){const s=i===E.LayerClass.ELEVATION?V.acquire():B.acquire();return s.init(e,t,i,n),s}function k(e){e.dispose(),e instanceof _.ElevationTileAgent?V.release(e):e instanceof m.MapTileAgent&&B.release(e)}const B=new s(m.MapTileAgent),V=new s(_.ElevationTileAgent),G=new y.ElevationBounds;var q;function j(e,t){const i=e.level,n=t[0];if(i>n)return!1;const s=n-i,r=Math.floor(t[1]/2**s),a=Math.floor(t[2]/2**s);return r===e.lij[1]&&a===e.lij[2]}function W(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function w(e,t,i){if(n.isNone(e)||n.isNone(t))return!1;if(0===e.level&&0===t.level){if(e.isEastEnd&&t.isWestEnd&&i===T.NeighborIndex.EAST)return!0;if(e.isWestEnd&&t.isEastEnd&&i===T.NeighborIndex.WEST)return!0}const s=Math.max(1e-6*(e.extent[2]-e.extent[0]),1);switch(i){case T.NeighborIndex.NORTH:return L.almostEquals(e.extent[3],t.extent[1],s);case T.NeighborIndex.SOUTH:return L.almostEquals(e.extent[1],t.extent[3],s);case T.NeighborIndex.EAST:return L.almostEquals(e.extent[2],t.extent[0],s)||L.almostEquals(e.extent[2],-t.extent[0],s);case T.NeighborIndex.WEST:return L.almostEquals(e.extent[0],t.extent[2],s)||L.almostEquals(e.extent[0],-t.extent[2],s)}}function F(e,t,i){return!n.isNone(e)&&!n.isNone(t)&&t!==e&&(e.level>=t.level?H(e,t,i):H(t,e,L.oppositeCorner(i)))}function H(e,t,i){L.internalAssert(e.level>=t.level);const n=L.isWestCorner(i),s=L.isNorthCorner(i),r=e.extent,a=t.extent,o=[n?r[0]:r[2],s?r[3]:r[1]],l=[n?a[2]:a[0],s?a[1]:a[3]],h=1e-5*(r[2]-r[0]),u=L.almostEquals(o[0],l[0],h)||e.surface.isGlobal&&L.almostEquals(o[0],-l[0],h),d=L.almostEquals(o[1],l[1],h);if(u&&d)return!0;if(e.level===t.level)return L.internalAssert(!1),!1;if(!u&&!d)return L.internalAssert(!1),!1;const c=u?X(a[1],a[3],r[1],r[3],h):X(a[0],a[2],r[0],r[2],h);return L.internalAssert(c),c}function X(e,t,i,n,s=h.getEpsilon()){return e-s<=i&&i<=n&&n<=t+s}e.CenterPosition=void 0,(q=e.CenterPosition||(e.CenterPosition={}))[q.TOP=0]="TOP",q[q.MIDDLE=1]="MIDDLE",q[q.BOTTOM=2]="BOTTOM",e.Tile=P,e.isCornerNeighbor=F,e.isEdgeNeighbor=w,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
