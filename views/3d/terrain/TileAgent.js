/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/maybe","./TerrainConst","./terrainUtils","./tileUtils"],(function(e,t,i,s,l,n){"use strict";let a=function(){function e(){}var a=e.prototype;return a.init=function(e,t,i,s){this.tile=e,this._layerIdx=t,this._layerClass=i,this._suspended=s,this._tileLayerInfo=e.getLayerInfo(t,i),this._tileRequested=null;const l=this._findAncestorWithData();this._setUpsampleTile(l)},a.startLoading=function(){return this._requestNext()},a.dispose=function(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null),this.tile=null,this._tileLayerInfo=null},a.setSuspension=function(e){e!==this._suspended&&(this._suspended=e,e?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())},a.update=function(){const e=this._findAncestorWithData();return this._setUpsampleTile(e),this._requestNext()},a.dataArrived=function(e){this._setUpsampleTile(e),this._tileRequested=null,e===this.tile?this.tile.updateRenderData(this._layerClass):this._requestNext()},a.dataMissing=function(){this._tileRequested=null,this._tileLayerInfo.data=null,this._requestNext()},a._agentDone=function(){this.tile.agentDone(this._layerIdx,this._layerClass),this.dispose()},a._requestNext=function(){if(this._suspended)return!0;const e=this._findNextDownload();if(this._tileRequested){if(e===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null}return i.isSome(e)?e.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=e):this._agentDone(),!!this._tileRequested},a._findNextDownload=function(){const e=this._layerIdx,t=this._layerClass,a=this.tile.surface.layerViewByIndex(e,t),r=l.getLayerWithExtentRange(a),{minLevel:u,maxLevel:h}=a.dataLevelRange,o=this._desiredMinLevelDelta,d=this._progressiveLevelModulo+o,_=this._scaleRangeEnabled?n.fallsWithinLayer:()=>!0;let f=this.tile;const y=f.level;let c;const p=this._tileLayerInfo.upsampleInfo,L=p?p.tile.level:-1,I=i.get(r,"tilemapCache");for(;f&&_(f,r,!1)&&f.level>=u;){const l=f.level,n=y-l,a=f.layerInfo[t][e];if(a.data&&n>=o){l>L&&this._setUpsampleTile(f),a.dataInvalidated&&(c=f);break}if((i.isNone(I)||"unavailable"!==I.getAvailability(f.lij[0],f.lij[1],f.lij[2]))&&l<=h&&!a.data&&!a.dataMissing&&((i.isNone(c)||f.level===u||l%s.PROGRESSIVE_LOADING_MODULO==0||y-c.level<o)&&(c=f),n>=d))break;f=f.parent}return i.isSome(c)&&y-c.level<o&&this._tileLayerInfo.upsampleInfo&&(c=null),c},a._findAncestorWithData=function(){const e=this.tile.vlevel,t=this._desiredMinLevelDelta;let i;for(let s=this.tile;s;s=s.parent)if(s.hasLayerData(this._layerIdx,this._layerClass)){if(e-s.level>=t)return s;i=s}return i},a._setUpsampleTile=function(e){this._tileLayerInfo.setUpsampleInfo(this.tile,e),this.tile.updateRenderData(this._layerClass)},t._createClass(e,[{key:"updating",get:function(){return!!this._tileRequested}},{key:"test",get:function(){return{findNextDownload:()=>this._findNextDownload(),tileLayerInfo:this._tileLayerInfo}}}]),e}(),r=function(e){function i(){return e.apply(this,arguments)||this}return t._inheritsLoose(i,e),i.prototype.dispose=function(){},t._createClass(i,[{key:"_desiredMinLevelDelta",get:function(){throw u}},{key:"_progressiveLevelModulo",get:function(){throw u}}]),i}(a);const u=new Error("Abstract method called on TileAgent"),h=new r;e.TILE_AGENT_DONE=h,e.TileAgent=a,Object.defineProperty(e,"__esModule",{value:!0})}));
