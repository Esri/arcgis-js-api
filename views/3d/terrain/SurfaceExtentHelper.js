/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/has","../../../core/Logger","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass","../../../core/urlUtils","../../../core/uuid","../../../portal/support/resourceExtension","../../../core/Accessor","../../../geometry/support/webMercatorUtils","../../../core/Handles","../../../core/watchUtils","../../../geometry/support/aaBoundingRect","../../../layers/support/layerUtils","./TerrainConst","./terrainUtils"],(function(e,t,r,n,a,s,i,l,o,c,p,u,d,f,y,h,E,_,x){"use strict";function g(e,t){return"spherical"===e?new L(t):new S(t)}e.SurfaceExtentHelper=function(e){function r(t){var r;return(r=e.call(this,t)||this)._handles=new f,r}t._inheritsLoose(r,e);var n=r.prototype;return n.initialize=function(){this._handles.add([this.layerViews.on("change",(()=>this.notifyChange("stencilEnabledExtents")))])},n.destroy=function(){this._handles.destroy(),this._handles=null},n._computeStencilEnabledExtents=function(){const e=[];return this.layerViews.forEach((t=>{const r=t.layer;if("IntegratedMeshLayer"===r.operationalLayerType&&null!=this.spatialReference){const t=R(r.fullExtent,this.spatialReference);null!=t&&e.push(h.fromExtent(t))}})),e},t._createClass(r,[{key:"layerViewsExtent",get:function(){return this._computeLayerViewsExtent()}},{key:"tiledLayersExtent",get:function(){return this._computeTiledLayersExtent()}},{key:"stencilEnabledExtents",get:function(){return this._computeStencilEnabledExtents()}},{key:"spatialReference",set:function(e){this.tilingScheme||this._set("spatialReference",e)}},{key:"tilingScheme",set:function(e){this._set("tilingScheme",e),this._set("spatialReference",e.spatialReference)}}]),r}(u),r.__decorate([i.property({readOnly:!0,dependsOn:[]})],e.SurfaceExtentHelper.prototype,"layerViewsExtent",null),r.__decorate([i.property({readOnly:!0,dependsOn:["spatialReference","tilingScheme"]})],e.SurfaceExtentHelper.prototype,"tiledLayersExtent",null),r.__decorate([i.property({readOnly:!0,dependsOn:["spatialReference"]})],e.SurfaceExtentHelper.prototype,"stencilEnabledExtents",null),r.__decorate([i.property()],e.SurfaceExtentHelper.prototype,"spatialReference",null),r.__decorate([i.property()],e.SurfaceExtentHelper.prototype,"tilingScheme",null),r.__decorate([i.property()],e.SurfaceExtentHelper.prototype,"defaultTiledLayersExtent",void 0),r.__decorate([i.property({constructOnly:!0})],e.SurfaceExtentHelper.prototype,"layers",void 0),r.__decorate([i.property({constructOnly:!0})],e.SurfaceExtentHelper.prototype,"layerViews",void 0),e.SurfaceExtentHelper=r.__decorate([l.subclass("esri.views.3d.terrain.SurfaceExtentHelperBase")],e.SurfaceExtentHelper);let L=function(e){function r(){return e.apply(this,arguments)||this}t._inheritsLoose(r,e);var n=r.prototype;return n._computeLayerViewsExtent=function(){return this._getGlobalExtent()},n._computeTiledLayersExtent=function(){return this._getGlobalExtent()},n._getGlobalExtent=function(){return this.spatialReference.isWebMercator?_.WEBMERCATOR_WORLD_EXTENT:_.GEOGRAPHIC_WORLD_EXTENT},r}(e.SurfaceExtentHelper);r.__decorate([i.property({dependsOn:["spatialReference"]})],L.prototype,"layerViewsExtent",void 0),L=r.__decorate([l.subclass("esri.views.3d.terrain.SurfaceExtentHelperGlobal")],L);let S=function(e){function r(){return e.apply(this,arguments)||this}t._inheritsLoose(r,e);var n=r.prototype;return n.initialize=function(){this._handles.add([this.layers.on("change",(e=>this._handleLayersChanged(e))),this.layerViews.on("change",(()=>this.notifyChange("layerViewsExtent")))])},n._handleLayersChanged=function(e){for(const t of e.removed)this._handles.remove(t.uid);for(const t of e.added)this._handles.add(y.init(t,"loaded",(()=>this.notifyChange("tiledLayersExtent"))),t.uid)},n._computeLayerViewsExtent=function(){const e=h.empty(),t=this.spatialReference;this.layerViews.forEach((r=>{const n=r.layer;if(r.isResolved()&&("graphics"!==n.type||!n.internal)){const n=R("fullExtentInLocalViewSpatialReference"in r&&r.fullExtentInLocalViewSpatialReference||r.layer.fullExtent,t);n&&h.expand(e,n)}}));const r=h.allFinite(e)?e:null,n=this._get("layerViewsExtent");return h.equals(r,n)?n:r},n._computeTiledLayersExtent=function(){const e=this.tilingScheme;if(!e)return null;const t=this.spatialReference,r=h.empty();this.layers.forEach((function(n){if(n.loaded&&E.isTiledLayer(n)){const{tileInfo:a,fullExtent:s}=x.getTiledLayerInfo(n,t,2);(a&&x.isProjectableRasterLayer(n)&&s||a&&e.compatibleWith(a)&&s&&s.spatialReference.equals(t))&&h.expand(r,s)}})),this.defaultTiledLayersExtent&&h.expand(r,this.defaultTiledLayersExtent);const n=h.allFinite(r)?r:null,a=this._get("tiledLayersExtent");return h.equals(n,a)?a:n},r}(e.SurfaceExtentHelper);function R(e,t){return e&&!e.spatialReference.equals(t)&&(e=d.canProject(e.spatialReference,t)?d.project(e,t):null),e}S=r.__decorate([l.subclass("esri.views.3d.terrain.SurfaceExtentHelperLocal")],S),e.create=g,Object.defineProperty(e,"__esModule",{value:!0})}));
