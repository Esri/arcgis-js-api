/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/mathUtils","../../../core/maybe","../../../chunks/vec2","../../../chunks/vec2f64","../../../layers/support/layerUtils","../support/StreamDataLoader","./BlendLayersTechnique","./interfaces","./LayerClass","./terrainUtils","./TextureFader","./TextureReference","./TileCompositor","./TileTexture","./TileUpdate","../webgl-engine/core/shaderLibrary/output/BlendOptions","../webgl-engine/core/shaderLibrary/terrain/TileBackground.glsl","../webgl-engine/lib/glUtil3D","../../webgl/context-util","../../webgl/enums","../../webgl/Texture"],(function(e,t,r,s,a,i,o,n,u,c,l,p,d,h,y,T,_,f,m,x,g,b,k){"use strict";let I=function(e,t,r,s){this.start=e,this.end=t,this.blendMode=r,this.opacity=s},L=function(){function e(e,t,r){this._rctx=e,this.tileSize=t,this._techniqueRepository=r,this._passParameters=new u.BlendLayersPassParameters,this._backgroundTexture=null,this._backgroundColor=null,this._backgroundDirty=!1,this._blackTex=null,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._composition=new y.TileCompositor(this._rctx,this._techniqueRepository),this._blackTex=new T(x.createColorTexture(this._rctx,[0,0,0,1])),this._ensureBackgroundTexture(this.tileSize)}var r=e.prototype;return r.dispose=function(){this._composition=s.disposeMaybe(this._composition),this._backgroundTexture=s.releaseMaybe(this._backgroundTexture),this._blackTex=s.releaseMaybe(this._blackTex)},r.updateTileTexture=function(e,t){if(!e.renderData)return;const r=e.surface,a=r.baseOpacity;let i=0,n=0,u=this.tileSize,c=!1;const d=r.view.state.contentPixelRatio;let h=!1;C.clear(),S.length=0;const y=e.layerInfo[l.LayerClass.MAP];let T=y.length,f=0;for(;f<y.length;f++){const t=r.layerViewByIndex(f,l.LayerClass.MAP),m=t.layer.opacity;O[f]=m;const x=t.fullOpacity;if(B[f]=x,o.isBaseLayer(t.layer)&&T>=y.length&&(T=f),p.isBlendableLayerView(t)){E[f]=t.layer.blendMode;let e="normal"!==t.layer.blendMode;if(o.isGroupLayer(t.layer.parent)){const r=M(t.layer.parent);s.isSome(r)&&""!==r&&(e=R(t.layer.parent)||e)}e&&(h=e,c=!1)}if(0===m&&!h){y[f].pendingUpdates&=~(_.TileUpdate.TEXTURE_NOFADING&_.TileUpdate.TEXTURE_FADING);continue}++n;const g=P(e,f);if(g){if(y[f].pendingUpdates&=~(_.TileUpdate.TEXTURE_NOFADING&_.TileUpdate.TEXTURE_FADING),o.isGroupLayer(t.layer.parent)){const e=M(t.layer.parent);s.isSome(e)&&""!==e&&A(t.layer.parent,f)}p.isVectorTileLayerView(t)?u=Math.max(u,this.tileSize*d):1===a&&1===x&&(t.isOpaque||this._dataToTexture(g)&&g.sourceLayerInfo.data.descriptor.isOpaque)&&(c=!0),++i}}this._rctx.type===g.ContextType.WEBGL1&&(u=w(u));const m=u/this.tileSize,x=f-1;this._ensureBackgroundTexture(this.tileSize),0!==i?1===i&&!h&&this._useLayerTexture(e,x,T,B[x])||this._composeMapLayers(e,t,x,T,O,E,u,m,!c||h,C,h):this._useBackgroundTexture(e,n)},r._ensureBackgroundTexture=function(e){s.isNone(this._backgroundTexture)&&(this._backgroundTexture=this._buildTexture(e),this._backgroundDirty=!0),this._backgroundDirty&&(this._composition.bind(e),this._passParameters.offset=i.ZEROS,this._passParameters.scale=1,this._passParameters.opacity=1,s.isSome(this.backgroundColor)&&(this._passParameters.backgroundColor=this.backgroundColor),this._composition.drawBackground(this._passParameters,s.isSome(this.backgroundColor)),this._composition.copyFBOToTexture(this._backgroundTexture),this._composition.unbind(),this._backgroundDirty=!1)},r._useBackgroundTexture=function(e,t){let r=d.ActivationTime.Immediate;(e.surface.view.layerViewManager.updating||t>0)&&(r=d.ActivationTime.Delayed);const a=e.renderData;this._backgroundTexture&&s.isNone(a.textureReference)&&(r=d.ActivationTime.Immediate),a.setTextureReference(s.isSome(this._backgroundTexture)?new h.TextureReference(this._backgroundTexture,c.TextureUpdate.FADING,U,e.surface.baseOpacity,0,1):null,r)},r._useLayerTexture=function(e,t,r,s){const a=t<r,i=a?1:e.surface.baseOpacity,o=a?e.surface.baseOpacity:1,n=P(e,t);return!!this._dataToTexture(n)&&(e.renderData.setTextureReference(new h.TextureReference(n.sourceLayerInfo.data,c.TextureUpdate.FADING,n,i,o,s)),!0)},r._composeMapLayers=function(e,t,r,s,a,o,n,u,c,l,d){this._composition.ensureBuffer(n);const y=e.surface.baseOpacity;let T=!1,_=b.TextureSamplingMode.LINEAR_MIPMAP_LINEAR,x=!1,g=0;for(let h=r;h>=0;h--){const t=P(e,h);if(!t)continue;if(0===a[h]&&!d)continue;const r=h<s&&y<1&&!T;this._passParameters.baseOpacity=r?y:1;const k=this._passParameters.baseOpacity<1?m.BaseOpacityMode.Required:m.BaseOpacityMode.NotRequired;r&&(T=!0);let I=!1;l.forEach((e=>{e.start===h&&(S.push(e),this._composition.openGroup(n),I=!0)}));const L=0===g,w=I?m.BlendLayersOutput.GroupBackgroundComposite:c&&L?this.backgroundIsGrid?m.BlendLayersOutput.GridComposite:m.BlendLayersOutput.ColorComposite:m.BlendLayersOutput.Composite,M=f.blendModeFromString[o[h]];for(p.isVectorTileRenderInfo(t)?(this._passParameters.opacity=a[h],x=this._composition.drawVectorData(this._passParameters,w,n,M,k,t,u,this.tileSize,x)):p.isImageryTileRenderInfo(t)?(this._passParameters.opacity=a[h],this._composition.drawImageryTileData(this._passParameters,w,n,M,k,t),this._hasNearestInterpolation(t)&&(_=b.TextureSamplingMode.NEAREST)):this._dataToTexture(t)&&(this._passParameters.texture=t.sourceLayerInfo.data.texture,this._passParameters.offset=t.offset,this._passParameters.scale=t.scale,this._passParameters.opacity=a[h],this._composition.drawRasterData(this._passParameters,w,n,M,k));S.length>0&&S[S.length-1].end===h;){const e=S.pop();this._passParameters.opacity=e.opacity,this._passParameters.offset=i.ZEROS,this._passParameters.scale=1;const t=c&&L?this.backgroundIsGrid?m.BlendLayersOutput.GridComposite:m.BlendLayersOutput.ColorComposite:m.BlendLayersOutput.Composite;this._composition.drawGroup(this._passParameters,t,n,f.blendModeFromString[e.blendMode],k)}g++}const k=e.renderData,I=k.ensureTexture(n,(()=>this._buildTexture(n,_)));this._composition.copyFBOToTexture(I),this._composition.unbind(),k.setTextureReference(new h.TextureReference(I,t,U,T?1:y,0,1))},r._hasNearestInterpolation=function(e){const t=e.sourceLayerInfo.data;return!!t.source&&"nearest"===t.interpolation},r._dataToTexture=function(e){if(p.isRasterTileRenderInfo(e)){const t=e.sourceLayerInfo;t.data=this._buildTexture(t.data),e.tile.setMemoryDirty()}return p.isTextureTileRenderInfo(e)},r.setBackground=function(e){this._backgroundColor!==e&&(this._backgroundColor=e,this._backgroundDirty=!0)},r._buildTexture=function(e,t=b.TextureSamplingMode.LINEAR_MIPMAP_LINEAR){if(s.isNone(e))return null;const r={target:b.TextureType.TEXTURE_2D,pixelFormat:b.PixelFormat.RGBA,dataType:b.PixelType.UNSIGNED_BYTE,wrapMode:b.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:t,maxAnisotropy:this._maxAnisotropy,preMultiplyAlpha:!0,flipped:!0,hasMipmap:!0},a=this._rctx;let i;if("number"==typeof e)r.width=r.height=e,i=new T(new k.Texture(a,r));else if(e instanceof n.ImageWithType)r.isOpaque=e.isOpaque,i=new T(new k.Texture(a,r,e.image)),e.release();else try{r.width=e.width,r.height=e.height,i=new T(new k.Texture(a,r,e))}catch(u){i=new T(x.createEmptyTexture(a)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}const o=a.bindTexture(i.texture,k.Texture.TEXTURE_UNIT_FOR_UPDATES);return i.generateMipmap(),a.bindTexture(o,k.Texture.TEXTURE_UNIT_FOR_UPDATES),i},t._createClass(e,[{key:"backgroundIsGrid",get:function(){return s.isNone(this._backgroundColor)}},{key:"backgroundColor",get:function(){return this._backgroundColor}},{key:"test",get:function(){return{backgroundTexture:this._backgroundTexture}}}]),e}();function w(e){const t=r.nextHighestPowerOfTwo(e),s=t*t,a=e*e;if(s===a)return e;const i=t/2;return s-a<a-i*i?t:i}function P(e,t){D.layerIndex=t;const r=e.layerInfo[l.LayerClass.MAP][t];if(s.isSome(r.data))return a.set(D.offset,0,0),D.tile=e,D.scale=1,D.sourceLod=e.lij,D.sourceLayerInfo=r,D;const i=r.upsampleInfo;if(s.isSome(i)){const e=i.tile.layerInfo[l.LayerClass.MAP][t];return D.tile=i.tile,a.copy(D.offset,i.offset),D.scale=i.scale,D.sourceLod=i.tile.lij,D.sourceLayerInfo=e,D}return null}function M(e){return e.get("uid")}function R(e){let t="normal"!==e.blendMode;return o.isGroupLayer(e.parent)&&(t=R(e.parent)||t),t}function A(e,t){o.isGroupLayer(e.parent)&&A(e.parent,t);const r=M(e);if(s.isSome(r)&&""!==r){const s=C.get(r);s?s.start=t:C.set(r,new I(t,t,e.blendMode,e.opacity))}}const O=new Array,B=new Array,E=new Array,C=new Map,S=new Array,D={tile:null,sourceLayerInfo:null,sourceLod:null,offset:[0,0],scale:1,layerIndex:0},U={offset:[0,0],scale:1};e.GroupInfo=I,e.TileRenderer=L,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
