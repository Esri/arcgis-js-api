/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../core/has","../../../core/maybe","../../../core/mathUtils","../../../chunks/vec2f64","../../../chunks/vec2","../../../layers/support/layerUtils","../../../chunks/builtins","../../webgl/Texture","../../webgl/Util","../webgl-engine/lib/DefaultVertexBufferLayouts","../webgl-engine/lib/glUtil3D","../../webgl/FramebufferObject","../../webgl/RenderingContext","../support/StreamDataLoader","../../webgl/rasterUtils","./TileTexture","./terrainUtils","../../2d/engine/vectorTiles/tileRendererHelper3D","./BlendLayersTechnique","./RasterColorizerTechnique","./support/FBOPool"],(function(e,t,r,i,s,a,o,n,l,u,c,h,d,f,_,p,T,x,y,b,g,m){"use strict";let w=function(){function t(e,t,r){this._rctx=e,this.tileSize=t,this._backgroundTexture=null,this._blackTex=null,this._vectorTileHelper=new y.VectorTileRendererHelper3D;this._rctx.capabilities.textureFilterAnisotropic&&(this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy),this._vaoQuad=h.createQuadVAO(this._rctx,c.Pos2Tex);const i=new b.BlendLayersTechniqueConfiguration;i.mode=2,this._blendLayersTechnique=r.acquireAndReleaseExisting(b.BlendLayersTechnique,i,this._blendLayersTechnique),i.mode=1,this._applyOpacityTechnique=r.acquireAndReleaseExisting(b.BlendLayersTechnique,i,this._applyOpacityTechnique),this._techniqueRep=r,this._blackTex=new T(h.createColorTexture(this._rctx,[0,0,0,1])),this._fboPool=new m.FBOPool(this._rctx)}var a=t.prototype;return a.dispose=function(){this._fboPool&&(this._fboPool.clear(),this._fboPool=null),this._vaoQuad&&(this._vaoQuad.dispose(),this._vaoQuad=null),r.isSome(this._backgroundTexture)&&(this._backgroundTexture.release(),this._backgroundTexture=null),this._blackTex&&(this._blackTex.release(),this._blackTex=null),this._blendLayersTechnique&&(this._blendLayersTechnique.dispose(),this._blendLayersTechnique=null),this._applyOpacityTechnique&&(this._applyOpacityTechnique.dispose(),this._applyOpacityTechnique=null),this._rasterColorizerTechnique&&(this._rasterColorizerTechnique.dispose(),this._rasterColorizerTechnique=null),this._vectorTileHelper&&(this._vectorTileHelper.dispose(),this._vectorTileHelper=null)},a.updateTileTexture=function(e){const t=e.layerInfo[1];for(const e of t)e.pendingUpdates&=-65;if(!e.renderData)return;const s=e.surface,a=s.baseOpacity;let n=0,l=0,u=this.tileSize,c=!1;const h=s.view.pixelRatio;let d=t.length,f=0;for(;f<t.length&&!c;f++){const i=s.layerViewByIndex(f,1),_=i.fullOpacity;if(L[f]=_,o.isBaseLayer(i.layer)&&d>=t.length&&(d=f),0===_)continue;++l;const p=q(e,f,C);p&&(x.isVectorTileLayerView(i)?u=Math.max(u,this.tileSize*h):1===a&&1===_&&(i.isOpaque||this._dataToTexture(p)&&r.isSome(p.sourceLayerInfo.data)&&p.sourceLayerInfo.data.descriptor.isOpaque)&&(c=!0),++n)}this._cleanupFBOPool(h,t.length),u=function(e){const t=i.nextHighestPowerOfTwo(e),r=t*t,s=e*e;if(r===s)return e;const a=t/2;return r-s<s-a*a?t:a}(u);const _=u/this.tileSize,p=f-1;if(0===n){let t=0;(e.surface.view.layerViewManager.updating||l>0)&&(t=5e3),this._backgroundTexture&&r.isNone(e.renderData.textureReference)&&(t=0),this._useBackgroundTexture(e,t)}else 1===n&&c?this._useLayerTexture(e,p):this._composeMapLayers(e,p,d,c,L,u,_)},a.setBackground=function(e){r.isSome(this._backgroundTexture)&&this._backgroundTexture.release(),e instanceof HTMLImageElement?this._backgroundTexture=this._buildTexture(e):this._backgroundTexture=new T(h.createColorTexture(this._rctx,e))},a._buildTexture=function(e){if(r.isNone(e))return null;const t={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9987,maxAnisotropy:this._maxAnisotropy,flipped:!0,hasMipmap:!0},i=this._rctx;let s;if("number"==typeof e)t.width=t.height=e,s=new T(new l(i,t));else if(e instanceof _.ImageWithType)t.isOpaque=e.isOpaque,s=new T(new l(i,t,e.image)),e.release();else try{s=new T(new l(i,t,e))}catch(e){s=new T(h.createEmptyTexture(i)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}return i.bindTexture(s.texture,0),s.generateMipmap(),s},a._drawQuad=function(e){this._rctx.bindVAO(this._vaoQuad),e.assertCompatibleVertexAttributeLocations(this._vaoQuad),this._rctx.drawArrays(5,0,u.vertexCount(this._vaoQuad,"geometry"))},a._drawRasterData=function(e,t,i,s,a=1){if(r.isNone(t))return;const o=this._rctx,n=e.program;o.setPipelineState(e.pipeline),o.bindProgram(n),o.bindTexture(t,0),n.setUniform1i("tex",0),n.setUniform1f("scale",i),n.setUniform2f("offset",s[0],s[1]),n.setUniform1f("opacity",a),this._drawQuad(n)},a._drawImageryTileData=function(e,t=1){const i=e.sourceLayerInfo.data;if(r.isNone(i)||!i.source)return;e.tile.surface.layerViewByIndex(e.layerIndex,1).ensureSymbolizerParameters(i);const s=this._getRasterColorizerTechnique(i.symbolizerParameters.type,!!i.symbolizerParameters.colormap),a=this._rctx,o=s.program;if(a.setPipelineState(s.pipeline),a.bindProgram(o),!i.bind(a))return;i.opacity=t,i.scale=e.scale,i.offset=e.offset;const{names:n,textures:l}=i.getTextures();p.setTextures(a,o,n,l);const u=i.getUniforms();s.bindPass(a,u),this._drawQuad(o),a.bindVAO()},a._getRasterColorizerTechnique=function(e,t){const r=["stretch","lut","hillshade"].indexOf(e);return this._rasterColorizerConfig||(this._rasterColorizerConfig=new g.RasterColorizerTechniqueConfiguration,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),this._rctx.gl.getExtension("OES_texture_float")),this._rasterColorizerConfig.colorizerType=r,this._rasterColorizerConfig.applyColormap=t,this._rasterColorizerTechnique=this._techniqueRep.acquireAndReleaseExisting(g.RasterColorizerTechnique,this._rasterColorizerConfig,this._rasterColorizerTechnique),this._rasterColorizerTechnique},a._drawVectorData=function(e,t,i,s,a,o,n){const l=t.sourceLayerInfo.data;if(r.isNone(l))return n;const u=this._rctx,c=t.tile.surface.layerViewByIndex(t.layerIndex,1);let h;u.setPipelineState(e.pipeline);const d=s<1;return d?(h=this._fboPool.acquire(a),u.bindFramebuffer(h),u.setClearColor(1,1,1,0),u.clearSafe(16640)):n&&u.clearSafe(256),this._vectorTileHelper.render(u,t.sourceLod,l,c.painter,c.layer.styleRepository,c.schemaHelper,Math.round(1/t.scale),t.offset,this.tileSize,i),!d||(u.bindFramebuffer(o),this._drawRasterData(e,h.colorTexture,1,[0,0],s),this._fboPool.release(h),n)},a._useBackgroundTexture=function(e,t){e.renderData.opacity=e.surface.baseOpacity,e.renderData.setTextureReference(this._backgroundTexture,0,0,1,t)},a._useLayerTexture=function(e,t){e.renderData.opacity=e.surface.baseOpacity;const r=q(e,t,C);if(this._dataToTexture(r)){const t=r.offset;e.renderData.setTextureReference(r.sourceLayerInfo.data,t[0],t[1],r.scale)}},a._composeMapLayers=function(e,t,i,a,o,n,l){const u=e.renderData.ensureTexture(n,(()=>this._buildTexture(n)));if(r.isNone(u))return;const c=this._rctx,h=this._fboPool.acquire(n);c.bindFramebuffer(h),c.setViewport(0,0,n,n),c.setClearColor(0,0,0,0),c.setClearDepth(1),c.clearSafe(16640);let d=!1;!a&&r.isSome(this._backgroundTexture)&&this._drawRasterData(this._blendLayersTechnique,this._backgroundTexture.texture,1,s.ZEROS);const f=e.surface.baseOpacity;let _=!1;for(let a=t;a>=0;a--){const t=q(e,a,C);t&&(a<i&&f<1&&!_&&(this._drawRasterData(this._applyOpacityTechnique,this._blackTex.texture,1,s.ZEROS,f),_=!0),0!==o[a]&&(x.isVectorTileRenderInfo(t)?d=this._drawVectorData(this._blendLayersTechnique,t,l,o[a],n,h,d):x.isImageryTileRenderInfo(t)?this._drawImageryTileData(t,o[a]):this._dataToTexture(t)&&r.isSome(t.sourceLayerInfo.data)&&this._drawRasterData(this._blendLayersTechnique,t.sourceLayerInfo.data.texture,t.scale,t.offset,o[a])))}c.bindTexture(u.texture,0);const p=u.descriptor;c.gl.copyTexImage2D(c.gl.TEXTURE_2D,0,p.pixelFormat,0,0,p.width,p.height,0),u.generateMipmap(),c.bindFramebuffer(null),this._fboPool.release(h),e.renderData.opacity=_?1:f,e.renderData.setTextureReference(u,0,0,1)},a._dataToTexture=function(e){return x.isRasterTileRenderInfo(e)&&this._rasterDataToTexture(e),x.isTextureTileRenderInfo(e)},a._rasterDataToTexture=function(e){const t=e.sourceLayerInfo;t.data=this._buildTexture(t.data),e.tile.setMemoryDirty()},a._cleanupFBOPool=function(e,t){e===this._lastPixelRatio&&t===this._lastNumLayers||(this._fboPool.clear(),this._lastPixelRatio=e,this._lastNumLayers=t)},e._createClass(t,[{key:"test",get:function(){return{backgroundTexture:this._backgroundTexture}}}]),t}();function q(e,t,r){r.layerIndex=t;const i=e.layerInfo[1][t];if(i.data)return a.set(r.offset,0,0),r.tile=e,r.scale=1,r.sourceLod=e.lij,r.sourceLayerInfo=i,r;const s=i.upsampleInfo;if(s){const e=s.tile.layerInfo[1][t];return r.tile=s.tile,a.copy(r.offset,s.offset),r.scale=s.scale,r.sourceLod=s.tile.lij,r.sourceLayerInfo=e,r}return null}const L=new Array,C={tile:null,sourceLayerInfo:null,sourceLod:null,offset:[0,0],scale:1,layerIndex:0};return w}));
