/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/mathUtils","../../../core/maybe","../../../chunks/vec2","../../../chunks/vec2f64","../../../layers/support/layerUtils","../support/StreamDataLoader","./BlendLayersTechnique","./interfaces","./LayerClass","./terrainUtils","./TextureFader","./TextureReference","./TileCompositor","./TileTexture","./TileUpdate","../webgl-engine/core/shaderLibrary/output/BlendOptions","../webgl-engine/core/shaderLibrary/terrain/TileBackground.glsl","../webgl-engine/lib/glUtil3D","../../webgl/enums","../../webgl/Texture"],(function(e,t,r,s,a,i,o,n,u,c,l,p,d,h,T,y,_,f,m,x,g,b){"use strict";let k=function(e,t,r,s){this.start=e,this.end=t,this.blendMode=r,this.opacity=s},I=function(){function e(e,t,r){this._rctx=e,this.tileSize=t,this._techniqueRepository=r,this._passParameters=new u.BlendLayersPassParameters,this._backgroundTexture=null,this._backgroundColor=null,this._backgroundDirty=!1,this._blackTex=null,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._composition=new T.TileCompositor(this._rctx,this._techniqueRepository),this._blackTex=new y(x.createColorTexture(this._rctx,[0,0,0,1])),this._ensureBackgroundTexture(this.tileSize)}var r=e.prototype;return r.dispose=function(){this._composition=s.disposeMaybe(this._composition),this._backgroundTexture=s.releaseMaybe(this._backgroundTexture),this._blackTex=s.releaseMaybe(this._blackTex)},r.updateTileTexture=function(e,t){if(!e.renderData)return;const r=e.surface,a=r.baseOpacity;let i=0,n=0,u=this.tileSize,c=!1;const d=r.view.state.pixelRatio;let h=!1;D.clear(),E.length=0;const T=e.layerInfo[l.LayerClass.MAP];let y=T.length,f=0;for(;f<T.length;f++){const t=r.layerViewByIndex(f,l.LayerClass.MAP),m=t.layer.opacity;O[f]=m;const x=t.fullOpacity;if(A[f]=x,o.isBaseLayer(t.layer)&&y>=T.length&&(y=f),p.isBlendableLayerView(t)){B[f]=t.layer.blendMode;let e="normal"!==t.layer.blendMode;if(p.isGroupLayer(t.layer.parent)){const r=M(t.layer.parent);s.isSome(r)&&""!==r&&(e=P(t.layer.parent)||e)}e&&(h=e,c=!1)}if(0===m&&!h){T[f].pendingUpdates&=~(_.TileUpdate.TEXTURE_NOFADING&_.TileUpdate.TEXTURE_FADING);continue}++n;const g=w(e,f);if(g){if(T[f].pendingUpdates&=~(_.TileUpdate.TEXTURE_NOFADING&_.TileUpdate.TEXTURE_FADING),p.isGroupLayer(t.layer.parent)){const e=M(t.layer.parent);s.isSome(e)&&""!==e&&R(t.layer.parent,f)}p.isVectorTileLayerView(t)?u=Math.max(u,this.tileSize*d):1===a&&1===x&&(t.isOpaque||this._dataToTexture(g)&&g.sourceLayerInfo.data.descriptor.isOpaque)&&(c=!0),++i}}u=L(u);const m=u/this.tileSize,x=f-1;this._ensureBackgroundTexture(this.tileSize),0!==i?1===i&&!h&&this._useLayerTexture(e,x,y,A[x])||this._composeMapLayers(e,t,x,y,O,B,u,m,!c||h,D,h):this._useBackgroundTexture(e,n)},r._ensureBackgroundTexture=function(e){s.isNone(this._backgroundTexture)&&(this._backgroundTexture=this._buildTexture(e),this._backgroundDirty=!0),this._backgroundDirty&&(this._composition.bind(e),this._passParameters.offset=i.ZEROS,this._passParameters.scale=1,this._passParameters.opacity=1,s.isSome(this.backgroundColor)&&(this._passParameters.backgroundColor=this.backgroundColor),this._composition.drawBackground(this._passParameters,s.isSome(this.backgroundColor)),this._composition.copyFBOToTexture(this._backgroundTexture),this._composition.unbind(),this._backgroundDirty=!1)},r._useBackgroundTexture=function(e,t){let r=d.ActivationTime.Immediate;(e.surface.view.layerViewManager.updating||t>0)&&(r=d.ActivationTime.Delayed),this._backgroundTexture&&s.isNone(e.renderData.textureReference)&&(r=d.ActivationTime.Immediate),e.renderData.setTextureReference(s.isSome(this._backgroundTexture)?new h.TextureReference(this._backgroundTexture,c.TextureUpdate.FADING,S,e.surface.baseOpacity,0,1):null,r)},r._useLayerTexture=function(e,t,r,s){const a=t<r,i=a?1:e.surface.baseOpacity,o=a?e.surface.baseOpacity:1,n=w(e,t);return!!this._dataToTexture(n)&&(e.renderData.setTextureReference(new h.TextureReference(n.sourceLayerInfo.data,c.TextureUpdate.FADING,n,i,o,s)),!0)},r._composeMapLayers=function(e,t,r,s,a,o,n,u,c,l,d){this._composition.ensureBuffer(n);const T=e.surface.baseOpacity;let y=!1,_=g.TextureSamplingMode.LINEAR_MIPMAP_LINEAR,x=!1,b=0;for(let h=r;h>=0;h--){const t=w(e,h);if(!t)continue;if(0===a[h]&&!d)continue;const r=h<s&&T<1&&!y;this._passParameters.baseOpacity=r?T:1;const k=this._passParameters.baseOpacity<1?m.BaseOpacityMode.Required:m.BaseOpacityMode.NotRequired;r&&(y=!0);let I=!1;l.forEach((e=>{e.start===h&&(E.push(e),this._composition.openGroup(n),I=!0)}));const L=0===b,M=I?m.BlendLayersOutput.GroupBackgroundComposite:c&&L?this.backgroundIsGrid?m.BlendLayersOutput.GridComposite:m.BlendLayersOutput.ColorComposite:m.BlendLayersOutput.Composite,P=f.blendModeFromString[o[h]];for(p.isVectorTileRenderInfo(t)?(this._passParameters.opacity=a[h],x=this._composition.drawVectorData(this._passParameters,M,n,P,k,t,u,this.tileSize,x)):p.isImageryTileRenderInfo(t)?(this._passParameters.opacity=a[h],this._composition.drawImageryTileData(this._passParameters,M,n,P,k,t),this._hasNearestInterpolation(t)&&(_=g.TextureSamplingMode.NEAREST)):this._dataToTexture(t)&&(this._passParameters.texture=t.sourceLayerInfo.data.texture,this._passParameters.offset=t.offset,this._passParameters.scale=t.scale,this._passParameters.opacity=a[h],this._composition.drawRasterData(this._passParameters,M,n,P,k));E.length>0&&E[E.length-1].end===h;){const e=E.pop();this._passParameters.opacity=e.opacity,this._passParameters.offset=i.ZEROS,this._passParameters.scale=1;const t=c&&L?this.backgroundIsGrid?m.BlendLayersOutput.GridComposite:m.BlendLayersOutput.ColorComposite:m.BlendLayersOutput.Composite;this._composition.drawGroup(this._passParameters,t,n,f.blendModeFromString[e.blendMode],k)}b++}const k=e.renderData.ensureTexture(n,(()=>this._buildTexture(n,_)));this._composition.copyFBOToTexture(k),this._composition.unbind(),e.renderData.setTextureReference(new h.TextureReference(k,t,S,y?1:T,0,1))},r._hasNearestInterpolation=function(e){const t=e.sourceLayerInfo.data;return!!t.source&&"nearest"===t.interpolation},r._dataToTexture=function(e){if(p.isRasterTileRenderInfo(e)){const t=e.sourceLayerInfo;t.data=this._buildTexture(t.data),e.tile.setMemoryDirty()}return p.isTextureTileRenderInfo(e)},r.setBackground=function(e){this._backgroundColor!==e&&(this._backgroundColor=e,this._backgroundDirty=!0)},r._buildTexture=function(e,t=g.TextureSamplingMode.LINEAR_MIPMAP_LINEAR){if(s.isNone(e))return null;const r={target:g.TextureType.TEXTURE_2D,pixelFormat:g.PixelFormat.RGBA,dataType:g.PixelType.UNSIGNED_BYTE,wrapMode:g.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:t,maxAnisotropy:this._maxAnisotropy,flipped:!0,hasMipmap:!0},a=this._rctx;let i;if("number"==typeof e)r.width=r.height=e,i=new y(new b.Texture(a,r));else if(e instanceof n.ImageWithType)r.isOpaque=e.isOpaque,i=new y(new b.Texture(a,r,e.image)),e.release();else try{r.width=e.width,r.height=e.height,i=new y(new b.Texture(a,r,e))}catch(u){i=new y(x.createEmptyTexture(a)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}const o=a.bindTexture(i.texture,b.Texture.TEXTURE_UNIT_FOR_UPDATES);return i.generateMipmap(),a.bindTexture(o,b.Texture.TEXTURE_UNIT_FOR_UPDATES),i},t._createClass(e,[{key:"backgroundIsGrid",get:function(){return s.isNone(this._backgroundColor)}},{key:"backgroundColor",get:function(){return this._backgroundColor}},{key:"test",get:function(){return{backgroundTexture:this._backgroundTexture}}}]),e}();function L(e){const t=r.nextHighestPowerOfTwo(e),s=t*t,a=e*e;if(s===a)return e;const i=t/2;return s-a<a-i*i?t:i}function w(e,t){C.layerIndex=t;const r=e.layerInfo[l.LayerClass.MAP][t];if(s.isSome(r.data))return a.set(C.offset,0,0),C.tile=e,C.scale=1,C.sourceLod=e.lij,C.sourceLayerInfo=r,C;const i=r.upsampleInfo;if(s.isSome(i)){const e=i.tile.layerInfo[l.LayerClass.MAP][t];return C.tile=i.tile,a.copy(C.offset,i.offset),C.scale=i.scale,C.sourceLod=i.tile.lij,C.sourceLayerInfo=e,C}return null}function M(e){return e.get("uid")}function P(e){let t="normal"!==e.blendMode;return p.isGroupLayer(e.parent)&&(t=P(e.parent)||t),t}function R(e,t){p.isGroupLayer(e.parent)&&R(e.parent,t);const r=M(e);s.isSome(r)&&""!==r&&(D.has(r)?D.get(r).start=t:D.set(r,new k(t,t,e.blendMode,e.opacity)))}const O=new Array,A=new Array,B=new Array,D=new Map,E=new Array,C={tile:null,sourceLayerInfo:null,sourceLod:null,offset:[0,0],scale:1,layerIndex:0},S={offset:[0,0],scale:1};e.GroupInfo=k,e.TileRenderer=I,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
