// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../lib/glMatrix","../../webgl/FramebufferObject","../../webgl/VertexArrayObject","../../webgl/Texture","../../webgl/BufferObject","../../webgl/Util","../webgl-engine/lib/DefaultVertexAttributeLocations","../webgl-engine/lib/DefaultVertexBufferLayouts","../../vectorTiles/VectorTileDisplayObject","../../vectorTiles/tileRendererHelper3D","./TerrainConst"],function(e,t,r,i,a,s,n,o,l,d,h,p,u){var c=r.vec2d,f=new Array(20),x=[0,0],g=function(){function e(e,t,r,i,s){this._gridTex=null,this.tileSize=256,this._context=e,this.tileSize=t,this._resourceCounter=i,this._setNeedsRender=s;var o=e.extensions.textureFilterAnisotropic;o&&(this._maxAnisotropy=Math.min(8,e.parameters.maxMaxAnisotropy));var h=new Float32Array(20);h[0]=-1,h[1]=-1,h[2]=0,h[3]=0,h[4]=0,h[5]=1,h[6]=-1,h[7]=0,h[8]=1,h[9]=0,h[10]=-1,h[11]=1,h[12]=0,h[13]=0,h[14]=1,h[15]=1,h[16]=1,h[17]=0,h[18]=1,h[19]=1,this._vaoQuad=new a(e,l.Default3D,{geometry:d.Pos3Tex},{geometry:n.createVertex(e,35044,h)}),this._blendLayersProgram=r.get("blendLayers")}return e.prototype.dispose=function(){this._fbo&&(this._fbo.dispose(),this._fbo=null),this._vaoQuad&&(this._vaoQuad.dispose(),this._vaoQuad=null),this._gridTex&&(this._gridTex.dispose(),this._gridTex=null),this._blendLayersProgram&&(this._blendLayersProgram.dispose(),this._blendLayersProgram=null),this._context&&(this._context=null)},e.prototype.updateTileTexture=function(e){for(var t=u.LayerClass.MAP,r=e.layerInfo[t],i=0;i<r.length;i++)r[i].pendingUpdates&=~u.TileUpdateTypes.UPDATE_TEXTURE;if(e.renderData){var a,s,n,o,l=e.renderData,d=0,h=!0;for(o=0;o<r.length;o++){a=r[o];var p=e.parentSurface.layerViewByIndex(o,t),x=p.fullOpacity;if(f[o]=x,(a.data||a.upsampleFromTile)&&(d++,!p.isTransparent)){h=!1;break}}o===r.length&&o--,0===d&&this._gridTex?(l.textureReference=this._gridTex,c.set2(0,0,l.texOffset),l.texScale=1):1!==d||h?(this._composeMapLayers(e,r,o,h,f),l.textureReference=null,c.set2(0,0,l.texOffset),l.texScale=1):(a=r[o],a.data?(s=a,c.set2(0,0,l.texOffset),l.texScale=1):(n=a.upsampleFromTile,s=n.tile.layerInfo[t][o],c.set(n.offset,l.texOffset),l.texScale=n.scale),s&&(s.data instanceof HTMLImageElement&&(s.data=this._buildTexture(s.data)),l.textureReference=s.data)),this._setNeedsRender()}},e.prototype.setGridImage=function(e){this._gridTex=this._buildTexture(e)},e.prototype._buildTexture=function(e){var t,r={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,maxAnisotropy:this._maxAnisotropy,flipped:!0,hasMipmap:!0},i=this._context;if(e)try{t=new s(i,r,e)}catch(a){r.width=r.height=this.tileSize,t=new s(i,r),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}else r.width=r.height=this.tileSize,t=new s(i,r);return i.bindTexture(t),t.generateMipmap(),t},e.prototype._drawVectorData=function(e,t,r,i,a,s,n,o,l){void 0===l&&(l=1),p(this._context,r,e,t.renderer,t.schemeHelper,r[0],i,a,0,s,n,o,l)},e.prototype._drawRasterData=function(e,t,r,i){void 0===i&&(i=1);var a=this._context,s=this._blendLayersProgram,n=this._vaoQuad;a.bindProgram(s),a.bindVAO(n),o.assertCompatibleVertexAttributeLocations(n,s),a.bindTexture(e,0),s.setUniform1i("tex",0),s.setUniform1f("scale",t),s.setUniform2f("offset",r[0],r[1]),s.setUniform1f("opacity",i),a.drawArrays(5,0,o.vertexCount(n,"geometry"))},e.prototype._composeMapLayers=function(e,t,r,a,s){var n=u.LayerClass.MAP,o=this._context;e.renderData.texture||(e.renderData.texture=this._buildTexture());var l=e.renderData.texture,d=this._fbo;d&&d.width===l.descriptor.width&&d.height===l.descriptor.height||(d=i.create(o,{colorTarget:0,depthStencilTarget:1,width:l.descriptor.width,height:l.descriptor.height}),this._fbo=d);var p=o.gl;o.bindFramebuffer(d),o.setViewport(0,0,this.tileSize,this.tileSize),o.setClearColor(0,0,0,0),o.setClearDepth(1),o.clear(p.COLOR_BUFFER_BIT|p.DEPTH_BUFFER_BIT),o.setDepthTestEnabled(!1),o.setBlendFunctionSeparate(1,771,1,771),o.setBlendEquation(32774),o.setBlendingEnabled(!0);var c,f,g,_;a&&this._gridTex&&this._drawRasterData(this._gridTex,1,x);for(var m=r;m>=0;m--){var T=null;if(c=t[m],c.data)T=c,f=x,g=1;else if(c.upsampleFromTile){var b=c.upsampleFromTile;T=b.tile.layerInfo[n][m],_=b.tile.lij[0],f=b.offset,g=b.scale}if(T)if((T.data instanceof HTMLImageElement||T.data instanceof HTMLCanvasElement)&&(T.data=this._buildTexture(T.data)),T.data instanceof h){var y=e.parentSurface.layerViewByIndex(m,n);this._drawVectorData(T.data,y,e.lij,l.descriptor.width,l.descriptor.height,g,f,_,s[m])}else this._drawRasterData(T.data,g,f,s[m])}o.bindTexture(l),p.copyTexImage2D(o.gl.TEXTURE_2D,0,l.descriptor.pixelFormat,0,0,l.descriptor.width,l.descriptor.height,0),l.generateMipmap(),o.bindFramebuffer(null),o.setBlendFunctionSeparate(770,771,1,771),o.setBlendingEnabled(!1),this._resourceCounter.incrementNumTileTexturesComposited()},e}();return g});