/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/mathUtils","../../../core/maybe","../../../chunks/vec2","../../../chunks/vec2f64","../../../chunks/vec4f64","../../../layers/support/layerUtils","../../webgl/BufferObject","../../webgl/FramebufferObject","../../../core/has","../../webgl/enums","../../webgl/RenderingContext","../../../chunks/builtins","../../webgl/Texture","../../webgl/VertexArrayObject","../../2d/engine/vectorTiles/VectorTileRendererHelper3D","../support/StreamDataLoader","./BlendLayersTechnique","./RasterColorizerTechnique","./terrainUtils","./TileTexture","./support/FBOPool","../webgl-engine/lib/DefaultVertexBufferLayouts","../webgl-engine/lib/glUtil3D","../../webgl/Util"],(function(e,t,r,a,i,s,o,n,u,c,l,d,h,f,_,p,T,y,b,x,g,m,w,I,D,k){"use strict";let R=function(){function e(e,t,r){this._rctx=e,this.tileSize=t,this._backgroundIsGrid=!1,this._backgroundTexture=null,this._backgroundColor=null,this._blackTex=null,this._vectorTileHelper=new T.VectorTileRendererHelper3D,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._vaoQuad=D.createQuadVAO(this._rctx,I.Pos2Tex);const a=new b.BlendLayersTechniqueConfiguration;a.mode=2,this._blendLayersTechnique=r.acquire(b.BlendLayersTechnique,a),a.mode=1,this._applyOpacityTechnique=r.acquire(b.BlendLayersTechnique,a),this._techniqueRep=r,this._blackTex=new m(D.createColorTexture(this._rctx,[0,0,0,1])),this._fboPool=new w.FBOPool(this._rctx)}var r=e.prototype;return r.dispose=function(){this._fboPool&&(this._fboPool.clear(),this._fboPool=null),this._vaoQuad=a.disposeMaybe(this._vaoQuad),this._backgroundTexture=a.releaseMaybe(this._backgroundTexture),this._blackTex=a.releaseMaybe(this._blackTex),this._blendLayersTechnique=a.disposeMaybe(this._blendLayersTechnique),this._applyOpacityTechnique=a.disposeMaybe(this._applyOpacityTechnique),this._vectorTileHelper=a.disposeMaybe(this._vectorTileHelper)},r.updateTileTexture=function(e){const t=e.layerInfo[1];for(const a of t)a.pendingUpdates&=-65;if(!e.renderData)return;const r=e.surface,i=r.baseOpacity;let s=0,o=0,u=this.tileSize,c=!1;const l=r.view.pixelRatio;let d=t.length,h=0;for(;h<t.length&&!c;h++){const f=r.layerViewByIndex(h,1),_=f.fullOpacity;if(C[h]=_,n.isBaseLayer(f.layer)&&d>=t.length&&(d=h),0===_)continue;++o;const p=L(e,h,q);p&&(g.isVectorTileLayerView(f)?u=Math.max(u,this.tileSize*l):1===i&&1===_&&(f.isOpaque||this._dataToTexture(p)&&a.isSome(p.sourceLayerInfo.data)&&p.sourceLayerInfo.data.descriptor.isOpaque)&&(c=!0),++s)}this._cleanupFBOPool(l,t.length),u=O(u);const f=u/this.tileSize,_=h-1;if(0===s){let t=0;return(e.surface.view.layerViewManager.updating||o>0)&&(t=5e3),this._backgroundTexture&&a.isNone(e.renderData.textureReference)&&(t=0),void this._useBackgroundTexture(e,t)}1===s&&(c||this._backgroundIsGrid||a.isSome(this._backgroundColor))&&this._useLayerTexture(e,_,d,C[_])||this._composeMapLayers(e,_,d,c,C,u,f)},r.setBackground=function(e,t){a.releaseMaybe(this._backgroundTexture),this._backgroundIsGrid=t,e instanceof HTMLImageElement?(this._backgroundTexture=this._buildTexture(e),this._backgroundColor=null):(this._backgroundTexture=new m(D.createColorTexture(this._rctx,e)),this._backgroundColor=o.fromValues(e[0]||0,e[1]||0,e[2]||0,e[3]||0))},r._buildTexture=function(e,t=9987){if(a.isNone(e))return null;const r={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:t,maxAnisotropy:this._maxAnisotropy,flipped:!0,hasMipmap:!0},i=this._rctx;let s;if("number"==typeof e)r.width=r.height=e,s=new m(new _(i,r));else if(e instanceof y.ImageWithType)r.isOpaque=e.isOpaque,s=new m(new _(i,r,e.image)),e.release();else try{s=new m(new _(i,r,e))}catch(n){s=new m(D.createEmptyTexture(i)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}const o=i.bindTexture(s.texture,_.TEXTURE_UNIT_FOR_UPDATES);return s.generateMipmap(),i.bindTexture(o,_.TEXTURE_UNIT_FOR_UPDATES),s},r._drawQuad=function(e){this._rctx.bindVAO(this._vaoQuad),e.assertCompatibleVertexAttributeLocations(this._vaoQuad),this._rctx.drawArrays(5,0,k.vertexCount(this._vaoQuad,"geometry"))},r._drawRasterData=function(e,t,r,i,s=1){if(a.isNone(t))return;const o=this._rctx,n=e.program;o.setPipelineState(e.pipeline),o.useProgram(n),n.bindTexture(t,"tex"),n.setUniform1f("scale",r),n.setUniform2f("offset",i[0],i[1]),n.setUniform1f("opacity",s),this._drawQuad(n)},r.hasNearestInterpolation=function(e){const t=e.sourceLayerInfo.data;return!(a.isNone(t)||!t.source)&&"nearest"===t.interpolation},r._drawImageryTileData=function(e,t=1){const r=e.sourceLayerInfo.data;if(a.isNone(r)||!r.source)return;e.tile.surface.layerViewByIndex(e.layerIndex,1).ensureSymbolizerParameters(r);const i=this._getRasterColorizerTechnique(r.symbolizerParameters.type,!!r.symbolizerParameters.colormap),s=this._rctx,o=i.program;if(s.setPipelineState(i.pipeline),s.useProgram(o),!r.bind(s))return;r.opacity=t,r.scale=e.scale,r.offset=e.offset;const{names:n,textures:u}=r.getTextures();n.forEach(((e,t)=>o.bindTexture(u[t],e))),i.bindPass(r.getUniforms()),this._drawQuad(o),s.bindVAO()},r._getRasterColorizerTechnique=function(e,t){const r=["stretch","lut","hillshade"].indexOf(e);return this._rasterColorizerConfig||(this._rasterColorizerConfig=new x.RasterColorizerTechniqueConfiguration,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),this._rctx.gl.getExtension("OES_texture_float")),this._rasterColorizerConfig.colorizerType=r,this._rasterColorizerConfig.applyColormap=t,this._rasterColorizerTechnique=this._techniqueRep.releaseAndAcquire(x.RasterColorizerTechnique,this._rasterColorizerConfig,this._rasterColorizerTechnique),this._rasterColorizerTechnique},r._drawVectorData=function(e,t,r,i,s,o,n){const u=t.sourceLayerInfo.data;if(a.isNone(u))return n;const c=this._rctx,l=t.tile.surface.layerViewByIndex(t.layerIndex,1);let d;return c.setPipelineState(e.pipeline),i<1?(d=this._fboPool.acquire(s),c.bindFramebuffer(d),c.setClearColor(1,1,1,0),c.clearSafe(16640)):n&&c.clearSafe(256),this._vectorTileHelper.render(c,t.sourceLod,u,l.painter,l.layer.styleRepository,l.schemaHelper,Math.round(1/t.scale),t.offset,this.tileSize,r),!a.isSome(d)||(c.bindFramebuffer(o),this._drawRasterData(e,d.colorTexture,1,[0,0],i),this._fboPool.release(d),n)},r._useBackgroundTexture=function(e,t){e.renderData.opacity=e.surface.baseOpacity,e.renderData.compositeBackgroundInShader=!1,e.renderData.layerOpacity=1,e.renderData.baseOpacity=1,e.renderData.setTextureReference(this._backgroundTexture,0,0,1,t)},r._useLayerTexture=function(e,t,r,a){const i=t<r;e.renderData.opacity=i?1:e.surface.baseOpacity,e.renderData.compositeBackgroundInShader=!0,e.renderData.layerOpacity=a,e.renderData.baseOpacity=i?e.surface.baseOpacity:1;const s=L(e,t,q);if(this._dataToTexture(s)){const t=s.offset;return e.renderData.setTextureReference(s.sourceLayerInfo.data,t[0],t[1],s.scale),!0}return!1},r._composeMapLayers=function(e,t,r,i,o,n,u){const c=this._rctx,l=this._fboPool.acquire(n);c.bindFramebuffer(l),c.setViewport(0,0,n,n),c.setClearColor(0,0,0,0),c.setClearDepth(1),c.clearSafe(16640);let d=!1;!i&&a.isSome(this._backgroundTexture)&&this._drawRasterData(this._blendLayersTechnique,this._backgroundTexture.texture,1,s.ZEROS);const h=e.surface.baseOpacity;let f=!1,p=9987;for(let _=t;_>=0;_--){const t=L(e,_,q);t&&(_<r&&h<1&&!f&&(this._drawRasterData(this._applyOpacityTechnique,this._blackTex.texture,1,s.ZEROS,h),f=!0),0!==o[_]&&(g.isVectorTileRenderInfo(t)?d=this._drawVectorData(this._blendLayersTechnique,t,u,o[_],n,l,d):g.isImageryTileRenderInfo(t)?(this._drawImageryTileData(t,o[_]),this.hasNearestInterpolation(t)&&(p=9728)):this._dataToTexture(t)&&a.isSome(t.sourceLayerInfo.data)&&this._drawRasterData(this._blendLayersTechnique,t.sourceLayerInfo.data.texture,t.scale,t.offset,o[_])))}const T=e.renderData.ensureTexture(n,(()=>this._buildTexture(n,p))),y=c.bindTexture(T.texture,_.TEXTURE_UNIT_FOR_UPDATES),b=T.descriptor;c.gl.copyTexImage2D(c.gl.TEXTURE_2D,0,b.pixelFormat,0,0,b.width,b.height,0),T.generateMipmap(),c.bindTexture(y,_.TEXTURE_UNIT_FOR_UPDATES),c.bindFramebuffer(null),this._fboPool.release(l),e.renderData.opacity=f?1:h,e.renderData.compositeBackgroundInShader=!1,e.renderData.layerOpacity=1,e.renderData.baseOpacity=1,e.renderData.setTextureReference(T,0,0,1)},r._dataToTexture=function(e){return g.isRasterTileRenderInfo(e)&&this._rasterDataToTexture(e),g.isTextureTileRenderInfo(e)},r._rasterDataToTexture=function(e){const t=e.sourceLayerInfo;t.data=this._buildTexture(t.data),e.tile.setMemoryDirty()},r._cleanupFBOPool=function(e,t){e===this._lastPixelRatio&&t===this._lastNumLayers||(this._fboPool.clear(),this._lastPixelRatio=e,this._lastNumLayers=t)},t._createClass(e,[{key:"backgroundIsGrid",get:function(){return this._backgroundIsGrid}},{key:"backgroundColor",get:function(){return this._backgroundColor}},{key:"test",get:function(){return{backgroundTexture:this._backgroundTexture}}}]),e}();function O(e){const t=r.nextHighestPowerOfTwo(e),a=t*t,i=e*e;if(a===i)return e;const s=t/2;return a-i<i-s*s?t:s}function L(e,t,r){r.layerIndex=t;const a=e.layerInfo[1][t];if(a.data)return i.set(r.offset,0,0),r.tile=e,r.scale=1,r.sourceLod=e.lij,r.sourceLayerInfo=a,r;const s=a.upsampleInfo;if(s){const e=s.tile.layerInfo[1][t];return r.tile=s.tile,i.copy(r.offset,s.offset),r.scale=s.scale,r.sourceLod=s.tile.lij,r.sourceLayerInfo=e,r}return null}const C=new Array,q={tile:null,sourceLayerInfo:null,sourceLod:null,offset:[0,0],scale:1,layerIndex:0};e.TileRenderer=R,Object.defineProperty(e,"__esModule",{value:!0})}));
