/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/mathUtils","../../../core/maybe","../../../chunks/vec2","../../../chunks/vec2f64","../../../chunks/vec3f64","../../../chunks/vec4f64","../../../layers/support/layerUtils","../../2d/engine/imagery/enums","../../2d/engine/vectorTiles/VectorTileRendererHelper3D","../support/StreamDataLoader","./BlendLayersTechnique","./interfaces","./LayerClass","../../../core/arrayUtils","../../../geometry/support/aaBoundingBox","../support/buffer/glUtil","./PatchGeometryFactory","./TextureFader","../../../core/HeapSort","../webgl-engine/lib/DefaultVertexAttributeLocations","../../webgl/BufferObject","../../webgl/VertexArrayObject","./RasterColorizerTechnique","./terrainUtils","./TextureReference","./TileTexture","./TileUpdate","./support/FBOPool","../webgl-engine/core/shaderLibrary/output/BlendOptions","../webgl-engine/lib/DefaultVertexBufferLayouts","../webgl-engine/lib/glUtil3D","../../webgl/enums","../../webgl/Texture","../../webgl/Util"],(function(e,t,r,i,a,s,o,n,u,l,c,h,T,d,f,_,y,p,x,b,g,m,R,I,L,C,w,B,E,P,q,O,A,D,k,M){"use strict";let U=function(){function e(e,t,r){this._rctx=e,this.tileSize=t,this._techniqueRepository=r,this._backgroundIsGrid=!1,this._backgroundTexture=null,this._backgroundColor=null,this._blackTex=null,this._vectorTileHelper=new c.VectorTileRendererHelper3D,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._vaoQuad=A.createQuadVAO(this._rctx,O.Pos2Tex),this._blackTex=new B(A.createColorTexture(this._rctx,[0,0,0,1])),this._fboPool=new P.FBOPool(this._rctx)}var r=e.prototype;return r.dispose=function(){this._fboPool&&(this._fboPool.clear(),this._fboPool=null),this._vaoQuad=i.disposeMaybe(this._vaoQuad),this._backgroundTexture=i.releaseMaybe(this._backgroundTexture),this._blackTex=i.releaseMaybe(this._blackTex),this._blendLayersTechnique=i.releaseMaybe(this._blendLayersTechnique),this._applyOpacityTechnique=i.releaseMaybe(this._applyOpacityTechnique),this._vectorTileHelper=i.disposeMaybe(this._vectorTileHelper)},r.updateTileTexture=function(e,t){const r=e.layerInfo[f.LayerClass.MAP];for(const i of r)i.pendingUpdates&=~(E.TileUpdate.TEXTURE_NOFADING&E.TileUpdate.TEXTURE_FADING);if(!e.renderData)return;const a=e.surface,s=a.baseOpacity;let o=0,n=0,l=this.tileSize,c=!1;const h=a.view.pixelRatio;let T=r.length,d=0;for(;d<r.length&&!c;d++){const t=a.layerViewByIndex(d,f.LayerClass.MAP),i=t.fullOpacity;if(N[d]=i,u.isBaseLayer(t.layer)&&T>=r.length&&(T=d),0===i)continue;++n;const _=F(e,d,v);_&&(C.isVectorTileLayerView(t)?l=Math.max(l,this.tileSize*h):1===s&&1===i&&(t.isOpaque||this._dataToTexture(_)&&_.sourceLayerInfo.data.descriptor.isOpaque)&&(c=!0),++o)}this._cleanupFBOPool(h,r.length),l=S(l);const _=l/this.tileSize,y=d-1;0!==o?1===o&&(c||this._backgroundIsGrid||i.isSome(this._backgroundColor))&&this._useLayerTexture(e,y,T,N[y])||this._composeMapLayers(e,t,y,T,c,N,l,_):this._useBackgroundTexture(e,n)},r._useBackgroundTexture=function(e,t){let r=b.ActivationTime.Immediate;(e.surface.view.layerViewManager.updating||t>0)&&(r=b.ActivationTime.Delayed),this._backgroundTexture&&i.isNone(e.renderData.textureReference)&&(r=b.ActivationTime.Immediate),e.renderData.setTextureReference(i.isSome(this._backgroundTexture)?new w.TextureReference(this._backgroundTexture,d.TextureUpdate.FADING,z,e.surface.baseOpacity,1,1,!1):null,r)},r._useLayerTexture=function(e,t,r,i){const a=t<r,s=a?1:e.surface.baseOpacity,o=a?e.surface.baseOpacity:1,n=F(e,t,v);return!!this._dataToTexture(n)&&(e.renderData.setTextureReference(new w.TextureReference(n.sourceLayerInfo.data,d.TextureUpdate.FADING,n,s,i,o,!0)),!0)},r._composeMapLayers=function(e,t,r,a,o,n,u,l){const c=this._rctx,h=this._fboPool.acquire(u);c.bindFramebuffer(h),c.setViewport(0,0,u,u),c.setClearColor(0,0,0,0),c.setClearDepth(1),c.clearSafe(D.ClearBufferBit.COLOR_BUFFER_BIT|D.ClearBufferBit.DEPTH_BUFFER_BIT);let T=!1;!o&&i.isSome(this._backgroundTexture)&&this._drawRasterData(this.blendLayersTechnique,this._backgroundTexture.texture,1,s.ZEROS);const d=e.surface.baseOpacity;let f=!1,_=D.TextureSamplingMode.LINEAR_MIPMAP_LINEAR;for(let i=r;i>=0;i--){const t=F(e,i,v);t&&(i<a&&d<1&&!f&&(this._drawRasterData(this.applyOpacityTechnique,this._blackTex.texture,1,s.ZEROS,d),f=!0),0!==n[i]&&(C.isVectorTileRenderInfo(t)?T=this._drawVectorData(this.blendLayersTechnique,t,l,n[i],u,h,T):C.isImageryTileRenderInfo(t)?(this._drawImageryTileData(t,n[i]),this._hasNearestInterpolation(t)&&(_=D.TextureSamplingMode.NEAREST)):this._dataToTexture(t)&&this._drawRasterData(this.blendLayersTechnique,t.sourceLayerInfo.data.texture,t.scale,t.offset,n[i])))}const y=e.renderData.ensureTexture(u,(()=>this._buildTexture(u,_))),p=c.bindTexture(y.texture,k.Texture.TEXTURE_UNIT_FOR_UPDATES),x=y.descriptor;c.gl.copyTexImage2D(c.gl.TEXTURE_2D,0,x.pixelFormat,0,0,x.width,x.height,0),y.generateMipmap(),c.bindTexture(p,k.Texture.TEXTURE_UNIT_FOR_UPDATES),c.bindFramebuffer(null),this._fboPool.release(h);const b=f?1:d;e.renderData.setTextureReference(new w.TextureReference(y,t,z,b,1,1,!1))},r._drawQuad=function(e){this._rctx.bindVAO(this._vaoQuad),e.assertCompatibleVertexAttributeLocations(this._vaoQuad),this._rctx.drawArrays(D.PrimitiveType.TRIANGLE_STRIP,0,M.vertexCount(this._vaoQuad,"geometry"))},r._drawRasterData=function(e,t,r,a,s=1){if(i.isNone(t))return;const o=this._rctx.useTechnique(e);o.bindTexture(t,"tex"),o.setUniform1f("scale",r),o.setUniform2f("offset",a[0],a[1]),o.setUniform1f("opacity",s),this._drawQuad(o)},r._hasNearestInterpolation=function(e){const t=e.sourceLayerInfo.data;return!!t.source&&"nearest"===t.interpolation},r._drawImageryTileData=function(e,t=1){const r=e.sourceLayerInfo.data;if(!r.source)return;e.tile.surface.layerViewByIndex(e.layerIndex,f.LayerClass.MAP).ensureSymbolizerParameters(r);const i=this._getRasterColorizerTechnique(r),a=this._rctx,s=a.useTechnique(i);if(!r.bind(a))return;r.opacity=t,r.scale=e.scale,r.offset=e.offset;const{names:o,textures:n}=r.getTextures();o.forEach(((e,t)=>s.bindTexture(n[t],e))),i.bindPass(r.getUniforms()),this._drawQuad(s),a.bindVAO()},r._getRasterColorizerTechnique=function(e){const t=e.symbolizerParameters,r=["stretch","lut","hillshade"].indexOf(t.type);return i.isNone(this._rasterColorizerConfig)&&(this._rasterColorizerConfig=new L.RasterColorizerTechniqueConfiguration,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),this._rctx.gl.getExtension("OES_texture_float")),this._rasterColorizerConfig.colorizerType=r,this._rasterColorizerConfig.applyColormap=!!t.colormap,this._rasterColorizerConfig.stretchType=e.hasStretchTypeNone()?l.RasterColorizerStretchType.Noop:l.RasterColorizerStretchType.PerBand,this._rasterColorizerTechnique=this._techniqueRepository.releaseAndAcquire(L.RasterColorizerTechnique,this._rasterColorizerConfig,this._rasterColorizerTechnique),this._rasterColorizerTechnique},r._drawVectorData=function(e,t,r,a,s,o,n){const u=this._rctx,l=t.sourceLayerInfo.data,c=t.tile.surface.layerViewByIndex(t.layerIndex,f.LayerClass.MAP);let h;return e.bindPipelineState(u),a<1?(h=this._fboPool.acquire(s),u.bindFramebuffer(h),u.setClearColor(1,1,1,0),u.clearSafe(D.ClearBufferBit.COLOR_BUFFER_BIT|D.ClearBufferBit.DEPTH_BUFFER_BIT)):n&&u.clearSafe(D.ClearBufferBit.DEPTH_BUFFER_BIT),this._vectorTileHelper.render(u,t.sourceLod,l,c.painter,c.layer.styleRepository,c.schemaHelper,Math.round(1/t.scale),t.offset,this.tileSize,r),!i.isSome(h)||(u.bindFramebuffer(o),this._drawRasterData(e,h.colorTexture,1,[0,0],a),this._fboPool.release(h),n)},r._dataToTexture=function(e){return C.isRasterTileRenderInfo(e)&&this._rasterDataToTexture(e),C.isTextureTileRenderInfo(e)},r._rasterDataToTexture=function(e){const t=e.sourceLayerInfo;t.data=this._buildTexture(t.data),e.tile.setMemoryDirty()},r.setBackground=function(e,t){i.releaseMaybe(this._backgroundTexture),this._backgroundIsGrid=t,e instanceof HTMLImageElement?(this._backgroundTexture=this._buildTexture(e),this._backgroundColor=null):(this._backgroundTexture=new B(A.createColorTexture(this._rctx,n.fromValues(e[0]||0,e[1]||0,e[2]||0,1))),this._backgroundColor=o.fromValues(e[0]||0,e[1]||0,e[2]||0))},r._buildTexture=function(e,t=D.TextureSamplingMode.LINEAR_MIPMAP_LINEAR){if(i.isNone(e))return null;const r={target:D.TextureType.TEXTURE_2D,pixelFormat:D.PixelFormat.RGBA,dataType:D.PixelType.UNSIGNED_BYTE,wrapMode:D.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:t,maxAnisotropy:this._maxAnisotropy,flipped:!0,hasMipmap:!0},a=this._rctx;let s;if("number"==typeof e)r.width=r.height=e,s=new B(new k.Texture(a,r));else if(e instanceof h.ImageWithType)r.isOpaque=e.isOpaque,s=new B(new k.Texture(a,r,e.image)),e.release();else try{s=new B(new k.Texture(a,r,e))}catch(n){s=new B(A.createEmptyTexture(a)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}const o=a.bindTexture(s.texture,k.Texture.TEXTURE_UNIT_FOR_UPDATES);return s.generateMipmap(),a.bindTexture(o,k.Texture.TEXTURE_UNIT_FOR_UPDATES),s},r._cleanupFBOPool=function(e,t){e===this._lastPixelRatio&&t===this._lastNumLayers||(this._fboPool.clear(),this._lastPixelRatio=e,this._lastNumLayers=t)},t._createClass(e,[{key:"blendLayersTechnique",get:function(){if(i.isNone(this._blendLayersTechnique)){const e=new T.BlendLayersTechniqueConfiguration;e.mode=q.BlendMode.OneMinusSourceAlpha,this._blendLayersTechnique=this._techniqueRepository.acquire(T.BlendLayersTechnique,e)}return this._blendLayersTechnique}},{key:"applyOpacityTechnique",get:function(){if(i.isNone(this._applyOpacityTechnique)){const e=new T.BlendLayersTechniqueConfiguration;e.mode=q.BlendMode.SourceAlpha,this._applyOpacityTechnique=this._techniqueRepository.acquire(T.BlendLayersTechnique,e)}return this._applyOpacityTechnique}},{key:"backgroundIsGrid",get:function(){return this._backgroundIsGrid}},{key:"backgroundColor",get:function(){return this._backgroundColor}},{key:"test",get:function(){return{backgroundTexture:this._backgroundTexture}}}]),e}();function S(e){const t=r.nextHighestPowerOfTwo(e),i=t*t,a=e*e;if(i===a)return e;const s=t/2;return i-a<a-s*s?t:s}function F(e,t,r){r.layerIndex=t;const i=e.layerInfo[f.LayerClass.MAP][t];if(i.data)return a.set(r.offset,0,0),r.tile=e,r.scale=1,r.sourceLod=e.lij,r.sourceLayerInfo=i,r;const s=i.upsampleInfo;if(s){const e=s.tile.layerInfo[f.LayerClass.MAP][t];return r.tile=s.tile,a.copy(r.offset,s.offset),r.scale=s.scale,r.sourceLod=s.tile.lij,r.sourceLayerInfo=e,r}return null}const N=new Array,v={tile:null,sourceLayerInfo:null,sourceLod:null,offset:[0,0],scale:1,layerIndex:0},z={offset:[0,0],scale:1};e.TileRenderer=U,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
