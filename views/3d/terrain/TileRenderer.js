// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","../../../core/mathUtils","../../../core/maybe","../../../core/libs/gl-matrix-2/vec2","../../../core/libs/gl-matrix-2/vec2f64","../../../layers/support/layerUtils","../../webgl","../../2d/engine/vectorTiles/tileRendererHelper3D","../support/StreamDataLoader","./BlendLayersTechnique","./RasterColorizerTechnique","./terrainUtils","./terrainUtils","./TileTexture","./support/FBOPool","../webgl-engine/lib/DefaultVertexBufferLayouts","../webgl-engine/lib/glUtil3D","../../webgl/rasterUtils","../../webgl/Util"],(function(e,t,r,i,a,s,o,n,l,u,c,h,p,d,f,_,T,x,y,b){var g=function(){function e(e,t,r){this._rctx=e,this.tileSize=t,this._backgroundTexture=null,this._blackTex=null,this._vectorTileHelper=new l.VectorTileRendererHelper3D,this._rctx.capabilities.textureFilterAnisotropic&&(this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy),this._vaoQuad=x.createQuadVAO(this._rctx,T.Pos2Tex);var i=new c.BlendLayersTechniqueConfiguration;i.mode=2,this._blendLayersTechnique=r.acquireAndReleaseExisting(c.BlendLayersTechnique,i,this._blendLayersTechnique),i.mode=1,this._applyOpacityTechnique=r.acquireAndReleaseExisting(c.BlendLayersTechnique,i,this._applyOpacityTechnique),this._techniqueRep=r,this._blackTex=new f.TileTexture(x.createColorTexture(this._rctx,[0,0,0,1])),this._fboPool=new _.FBOPool(this._rctx)}return e.prototype.dispose=function(){this._fboPool&&(this._fboPool.clear(),this._fboPool=null),this._vaoQuad&&(this._vaoQuad.dispose(),this._vaoQuad=null),i.isSome(this._backgroundTexture)&&(this._backgroundTexture.release(),this._backgroundTexture=null),this._blackTex&&(this._blackTex.release(),this._blackTex=null),this._blendLayersTechnique&&(this._blendLayersTechnique.dispose(),this._blendLayersTechnique=null),this._applyOpacityTechnique&&(this._applyOpacityTechnique.dispose(),this._applyOpacityTechnique=null),this._rasterColorizerTechnique&&(this._rasterColorizerTechnique.dispose(),this._rasterColorizerTechnique=null),this._vectorTileHelper&&(this._vectorTileHelper.dispose(),this._vectorTileHelper=null)},e.prototype.updateTileTexture=function(e){for(var t=e.layerInfo[1],a=0,s=t;a<s.length;a++){s[a].pendingUpdates&=-65}if(e.renderData){for(var n=e.surface,l=n.baseOpacity,u=0,c=0,h=this.tileSize,d=!1,f=n.view.pixelRatio,_=t.length,T=0;T<t.length&&!d;T++){var x=n.layerViewByIndex(T,1),y=x.fullOpacity;if(v[T]=y,o.isBaseLayer(x.layer)&&_>=t.length&&(_=T),0!==y){++c;var b=m(e,T,w);b&&(p.isVectorTileLayerView(x)?h=Math.max(h,this.tileSize*f):1===l&&1===y&&(x.isOpaque||this._dataToTexture(b)&&i.isSome(b.sourceLayerInfo.data)&&b.sourceLayerInfo.data.descriptor.isOpaque)&&(d=!0),++u)}}this._cleanupFBOPool(f,t.length);var g=(h=function(e){var t=r.nextHighestPowerOfTwo(e),i=t*t,a=e*e;if(i===a)return e;var s=t/2;return i-a<a-s*s?t:s}(h))/this.tileSize,q=T-1;if(0===u){var L=0;(e.surface.view.layerViewManager.updating||c>0)&&(L=5e3),this._backgroundTexture&&i.isNone(e.renderData.textureReference)&&(L=0),this._useBackgroundTexture(e,L)}else 1===u&&d?this._useLayerTexture(e,q):this._composeMapLayers(e,q,_,d,v,h,g)}},e.prototype.setBackground=function(e){i.isSome(this._backgroundTexture)&&this._backgroundTexture.release(),e instanceof HTMLImageElement?this._backgroundTexture=this._buildTexture(e):this._backgroundTexture=new f.TileTexture(x.createColorTexture(this._rctx,e))},e.prototype._buildTexture=function(e){if(i.isNone(e))return null;var t,r={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9987,maxAnisotropy:this._maxAnisotropy,flipped:!0,hasMipmap:!0},a=this._rctx;if("number"==typeof e)r.width=r.height=e,t=new f.TileTexture(new n.Texture(a,r));else if(e instanceof u.ImageWithType)r.isOpaque=e.isOpaque,t=new f.TileTexture(new n.Texture(a,r,e.image)),e.release();else try{t=new f.TileTexture(new n.Texture(a,r,e))}catch(e){t=new f.TileTexture(x.createEmptyTexture(a)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}return a.bindTexture(t.texture),t.generateMipmap(),t},e.prototype._drawQuad=function(e){this._rctx.bindVAO(this._vaoQuad),e.assertCompatibleVertexAttributeLocations(this._vaoQuad),this._rctx.drawArrays(5,0,b.vertexCount(this._vaoQuad,"geometry"))},e.prototype._drawRasterData=function(e,t,r,a,s){if(void 0===s&&(s=1),!i.isNone(t)){var o=this._rctx,n=e.program;o.setPipelineState(e.pipeline),o.bindProgram(n),o.bindTexture(t,0),n.setUniform1i("tex",0),n.setUniform1f("scale",r),n.setUniform2f("offset",a[0],a[1]),n.setUniform1f("opacity",s),this._drawQuad(n)}},e.prototype._drawImageryTileData=function(e,t){void 0===t&&(t=1);var r=e.sourceLayerInfo.data;if(!i.isNone(r)&&r.source){e.tile.surface.layerViewByIndex(e.layerIndex,1).ensureSymbolizerParameters(r);var a=this._getRasterColorizerTechnique(r.symbolizerParameters.type,!!r.symbolizerParameters.colormap),s=this._rctx,o=a.program;if(s.setPipelineState(a.pipeline),s.bindProgram(o),r.bind(s)){r.opacity=t,r.scale=e.scale,r.offset=e.offset;var n=r.getTextures(),l=n.names,u=n.textures;y.setTextures(s,o,l,u);var c=r.getUniforms();a.bindPass(s,c),this._drawQuad(o),s.bindVAO()}}},e.prototype._getRasterColorizerTechnique=function(e,t){var r=["stretch","lut","hillshade"].indexOf(e);return this._rasterColorizerConfig||(this._rasterColorizerConfig=new h.RasterColorizerTechniqueConfiguration,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),this._rctx.gl.getExtension("OES_texture_float")),this._rasterColorizerConfig.colorizerType=r,this._rasterColorizerConfig.applyColormap=t,this._rasterColorizerTechnique=this._techniqueRep.acquireAndReleaseExisting(h.RasterColorizerTechnique,this._rasterColorizerConfig,this._rasterColorizerTechnique),this._rasterColorizerTechnique},e.prototype._drawVectorData=function(e,t,r,a,s,o,n){var l=t.sourceLayerInfo.data;if(i.isNone(l))return n;var u,c=this._rctx,h=t.tile.surface.layerViewByIndex(t.layerIndex,1);c.setPipelineState(e.pipeline);var p=a<1;return p?(u=this._fboPool.acquire(s),c.bindFramebuffer(u),c.setClearColor(1,1,1,0),c.clearSafe(16640)):n&&c.clearSafe(256),this._vectorTileHelper.render(c,t.sourceLod,l,h.painter,h.layer.styleRepository,h.schemaHelper,Math.round(1/t.scale),t.offset,this.tileSize,r),!p||(c.bindFramebuffer(o),this._drawRasterData(e,u.colorTexture,1,[0,0],a),this._fboPool.release(u),n)},e.prototype._useBackgroundTexture=function(e,t){e.renderData.opacity=e.surface.baseOpacity,e.renderData.setTextureReference(this._backgroundTexture,0,0,1,t)},e.prototype._useLayerTexture=function(e,t){e.renderData.opacity=e.surface.baseOpacity;var r=m(e,t,w);if(this._dataToTexture(r)){var i=r.offset;e.renderData.setTextureReference(r.sourceLayerInfo.data,i[0],i[1],r.scale)}},e.prototype._composeMapLayers=function(e,t,r,a,o,n,l){var u=this,c=e.renderData.ensureTexture(n,(function(){return u._buildTexture(n)}));if(!i.isNone(c)){var h=this._rctx,d=this._fboPool.acquire(n);h.bindFramebuffer(d),h.setViewport(0,0,n,n),h.setClearColor(0,0,0,0),h.setClearDepth(1),h.clearSafe(16640);var f=!1;!a&&i.isSome(this._backgroundTexture)&&this._drawRasterData(this._blendLayersTechnique,this._backgroundTexture.texture,1,s.vec2f64.ZEROS);for(var _=e.surface.baseOpacity,T=!1,x=t;x>=0;x--){var y=m(e,x,w);y&&(x<r&&_<1&&!T&&(this._drawRasterData(this._applyOpacityTechnique,this._blackTex.texture,1,s.vec2f64.ZEROS,_),T=!0),0!==o[x]&&(p.isVectorTileRenderInfo(y)?f=this._drawVectorData(this._blendLayersTechnique,y,l,o[x],n,d,f):p.isImageryTileRenderInfo(y)?this._drawImageryTileData(y,o[x]):this._dataToTexture(y)&&i.isSome(y.sourceLayerInfo.data)&&this._drawRasterData(this._blendLayersTechnique,y.sourceLayerInfo.data.texture,y.scale,y.offset,o[x])))}h.bindTexture(c.texture);var b=c.descriptor;h.gl.copyTexImage2D(h.gl.TEXTURE_2D,0,b.pixelFormat,0,0,b.width,b.height,0),c.generateMipmap(),h.bindFramebuffer(null),this._fboPool.release(d),e.renderData.opacity=T?1:_,e.renderData.setTextureReference(c,0,0,1)}},e.prototype._dataToTexture=function(e){return d.isRasterTileRenderInfo(e)&&this._rasterDataToTexture(e),p.isTextureTileRenderInfo(e)},e.prototype._rasterDataToTexture=function(e){var t=e.sourceLayerInfo;t.data=this._buildTexture(t.data),e.tile.setMemoryDirty()},e.prototype._cleanupFBOPool=function(e,t){e===this._lastPixelRatio&&t===this._lastNumLayers||(this._fboPool.clear(),this._lastPixelRatio=e,this._lastNumLayers=t)},e}();function m(e,t,r){r.layerIndex=t;var i=e.layerInfo[1][t];if(i.data)return a.vec2.set(r.offset,0,0),r.tile=e,r.scale=1,r.sourceLod=e.lij,r.sourceLayerInfo=i,r;var s=i.upsampleInfo;if(s){var o=s.tile.layerInfo[1][t];return r.tile=s.tile,a.vec2.copy(r.offset,s.offset),r.scale=s.scale,r.sourceLod=s.tile.lij,r.sourceLayerInfo=o,r}return null}var v=new Array,w={tile:null,sourceLayerInfo:null,sourceLod:null,offset:[0,0],scale:1,layerIndex:0};return g}));