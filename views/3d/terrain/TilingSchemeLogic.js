/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/Handles","../../../core/maybe","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../../geometry/projection","../../../geometry/support/aaBoundingRect","../../../geometry/support/spatialReferenceUtils","../../../layers/support/layerUtils","../../ViewingMode","./terrainUtils","./TilingScheme"],(function(e,t,i,o,s,n,r,l,c,a,h,d,p,u,g,y,S,_){"use strict";function m(e,t,i){return n.isSome(S.getTiledLayerInfo(e,t,i))}e.TilingSchemeLogic=function(e){function i(t){var i;return(i=e.call(this,t)||this)._handles=new s,i}t._inheritsLoose(i,e);var o=i.prototype;return o.initialize=function(){this._handles.add(this.layers.on("change",(()=>this._update()))),this._handles.add(this.extentHelper.watch("layerViewsExtent",(()=>this._setAdHocTilingScheme()))),this._update(),this.tilingSchemeLocked||this._setAdHocTilingScheme()},o.destroy=function(){this._handles=n.destroyMaybe(this._handles),this._waitTask=null},o._update=function(){if(this._waitTask=null,this.tilingSchemeLocked)return;let e;if(this.layers.some((t=>!(!g.isTiledLayer(t)||t.isRejected())&&(!(t.isFulfilled()&&!m(t,this.viewSpatialReference,this.viewingMode))&&(e=t,!S.isVectorTileLayer(t)&&!S.isProjectableRasterLayer(t))))),e)if(e.isResolved()){const t=e,i=S.getTiledLayerInfo(t,this.viewSpatialReference,this.viewingMode);if(n.isSome(i)){const e=new _.default(i.tileInfo);this._lockTilingScheme(e)}}else this._updateWhen(e)},o._updateWhen=function(e){const t=e.when().catch((()=>{})).then((()=>{t!==this._waitTask||this.destroyed||this._update()}));this._waitTask=t},o._lockTilingScheme=function(e){if(this.viewingMode===y.ViewingMode.Global){const t=e.levels.length-1;e.spatialReference.isWebMercator?e=_.default.makeWebMercatorAuxiliarySphere(t):d.canProjectToWGS84ComparableLonLat(e.spatialReference)&&(e=_.default.makeGCSWithTileSize(e.spatialReference,e.pixelSize,t))}this.tilingSchemeLocked=!0,this.tilingScheme=e,this.extentHelper.tilingScheme=this.tilingScheme,this._updateTiledLayerExtent(),this._handles.removeAll(),this._handles.add(this.extentHelper.watch("tiledLayersExtent",(()=>this._updateTiledLayerExtent())))},o._updateTiledLayerExtent=function(){this._set("extent",this.extentHelper.tiledLayersExtent)},o._setAdHocTilingScheme=function(){if(this.viewingMode===y.ViewingMode.Global){const e=this.extentHelper.viewSpatialReference,t=d.canProjectToWGS84ComparableLonLat(e)||u.isMars(e)||u.isMoon(e);e.isWebMercator?this.tilingScheme=_.default.WebMercatorAuxiliarySphere:t&&(this.tilingScheme=_.default.makeGCSWithTileSize(e,256)),this._set("extent",this.extentHelper.layerViewsExtent)}else{const e=this.extentHelper.layerViewsExtent;n.isSome(e)&&!p.equals(e,this.extent)&&(this.tilingScheme=_.default.fromExtent(e,this.extentHelper.viewSpatialReference),this._set("extent",e))}},t._createClass(i,[{key:"test",get:function(){return{lockTilingScheme:e=>this._lockTilingScheme(e),done:!this._waitTask}}}]),i}(o),i.__decorate([r.property()],e.TilingSchemeLogic.prototype,"tilingScheme",void 0),i.__decorate([r.property({readOnly:!0})],e.TilingSchemeLogic.prototype,"extent",void 0),i.__decorate([r.property({value:!1})],e.TilingSchemeLogic.prototype,"tilingSchemeLocked",void 0),i.__decorate([r.property({constructOnly:!0})],e.TilingSchemeLogic.prototype,"viewSpatialReference",void 0),i.__decorate([r.property({constructOnly:!0})],e.TilingSchemeLogic.prototype,"layers",void 0),i.__decorate([r.property({constructOnly:!0})],e.TilingSchemeLogic.prototype,"extentHelper",void 0),i.__decorate([r.property({constructOnly:!0})],e.TilingSchemeLogic.prototype,"viewingMode",void 0),e.TilingSchemeLogic=i.__decorate([h.subclass("esri.views.3d.terrain.TilingSchemeLogic")],e.TilingSchemeLogic),Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
