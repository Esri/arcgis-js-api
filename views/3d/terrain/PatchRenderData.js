/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/arrayUtils","../../../core/maybe","../../../geometry/support/aaBoundingBox","../support/buffer/glUtil","./PatchGeometryFactory","./TextureFader","./TileOverlayData","./tileUtils","../webgl-engine/lib/DefaultVertexAttributeLocations","../../webgl/BufferObject","../../webgl/VertexArrayObject"],(function(e,t,r,i,n,s,a,l,o,u,c,h,m){"use strict";let f=function(){function e(){this.geometryInfo=new a.PatchGeometry,this.intersectionData=null,this.skirtIntersectionData=null,this._textureRef=new l((()=>this.tile.surface.textureFadeDuration)),this.overlay=new o}var f=e.prototype;return f.init=function(e){this.tile=e,this.clear();const t=this.geometryInfo;t.indices=null,t.vertexAttributes=null,n.empty(t.boundingBox),t.numSurfaceIndices=0,t.numSkirtIndices=0,t.numWithoutSkirtIndices=0,t.numVertsPerRow=0,this.intersectionData=null,this.skirtIntersectionData=null,this.geometryState={numVertsPerRow:0,samplerData:null,clippingArea:null,wireframe:!1},this.localOrigin=null,this.overlay.clear()},f.clear=function(){this.releaseGeometry(),this.releaseTexture(),this._textureRef.clear()},f.updateGeometry=function(e,t){return!!this._updateGeometryState(t)&&(this._releaseGeometry(),this._createGeometry(e),!0)},f.releaseGeometry=function(){return!!this._releaseGeometry()&&(this.geometryState={numVertsPerRow:0,samplerData:null,clippingArea:null,wireframe:!1},!0)},f.ensureTexture=function(e,t){return i.isSome(this._texture)&&this._texture.descriptor.width!==e&&this.releaseTexture(),i.isNone(this._texture)&&(this._texture=t(),this.tile.setMemoryDirty()),this._texture},f.releaseTexture=function(){i.isSome(this._texture)&&(this._texture.release(),this._texture=null,this.tile.setMemoryDirty())},f._updateGeometryState=function(e){const t=this._getElevationInfo(),i=t.samplerData?this.tile.getElevationBasedVerticesPerRow(t.maxTileLevel):this.tile.getDefaultVerticesPerRowOnLevel();let n=this.tile.clippingArea;this.tile.intersectsClippingArea&&!this.tile.isWithinClippingArea||(n=null);const s=this.geometryState;let a=!1;return s.numVertsPerRow!==i&&(s.numVertsPerRow=i,a=!0),t.changed&&(s.samplerData=t.samplerData,a=!0),r.equals(s.clippingArea,n)||(s.clippingArea=n,a=!0),s.wireframe!==e&&(s.wireframe=e,a=!0),a},f._createGeometry=function(e){this.tile.createGeometry(this.geometryState,this.localOrigin);const t=this.geometryInfo.vertexAttributes,r=this.geometryInfo.indices,i=e.gl;this._vao=new m(e,c.Default3D,{geometry:s.glLayout(t.layout)},{geometry:h.createVertex(e,i.STATIC_DRAW,t.buffer)},h.createIndex(e,i.STATIC_DRAW,r))},f._releaseGeometry=function(){return!!this._vao&&(this._vao.dispose(),this._vao=null,a.releaseGeometry(this.geometryInfo),!0)},f.setTextureReference=function(e,t=0){i.isSome(e)&&e.texture!==this._texture&&this.releaseTexture(),this._textureRef.push(e,t)},f._getElevationInfo=function(){const e=this.geometryState.samplerData,t=this.tile.layerInfo[0],r=t.length;let i=new Array(r),n=0,s=0,a=!1;for(let l=0;l<r;l++){const r=t[l];if(r.upsampleInfo){const t=r.upsampleInfo.tile,o=t.layerInfo[0][l].data,u=o&&o.samplerData;e&&e[n]===u||(a=!0),i[n++]=u,s=Math.max(s,t.lij[0])}else if(r.data){const t=this.tile.surface.layerViewByIndex(l,0);if(u.fallsWithinLayer(this.tile,t.layer,!1)){const t=r.data;e&&e[n]===t.samplerData||(a=!0),i[n++]=t.samplerData,s=this.tile.level}}}return e&&e.length!==n&&(a=!0),n>0?i.length=n:i=null,{changed:a,samplerData:i,maxTileLevel:s}},t._createClass(e,[{key:"vao",get:function(){return this._vao}},{key:"textureReference",get:function(){return this._textureRef.current}},{key:"nextTextureReference",get:function(){return this._textureRef.next}},{key:"textureFadeFactor",get:function(){return this._textureRef.fadeFactor}},{key:"textureIsFading",get:function(){return this._textureRef.isFading}},{key:"estimatedGeometryMemoryUsage",get:function(){const e=i.mapOr(this.intersectionData,0,(e=>e.estimatedMemoryUsage))+i.mapOr(this.skirtIntersectionData,0,(e=>e.estimatedMemoryUsage+e.vertexPositionBuffer.byteLength));return this.geometryInfo.indices.byteLength+this.geometryInfo.vertexAttributes.byteLength+e}},{key:"textureDescriptor",get:function(){return i.isSome(this._texture)?this._texture.descriptor:null}},{key:"test",get:function(){return{hasTexture:null!=this._texture}}}]),e}();e.PatchRenderData=f,Object.defineProperty(e,"__esModule",{value:!0})}));
