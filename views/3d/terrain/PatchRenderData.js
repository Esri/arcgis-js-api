/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/maybe","../../../core/arrayUtils","../../../core/mathUtils","../../../geometry/support/aaBoundingBox","./TerrainConst","../webgl-engine/lib/DefaultVertexAttributeLocations","../support/buffer/glUtil","../../webgl/BufferObject","../../webgl/VertexArrayObject","./PatchGeometryFactory","./tileUtils","./TextureFader","./TileOverlayData"],(function(e,t,r,i,n,s,a,l,o,u,h,c,m,f,y){"use strict";let g=function(){function e(){this.geometryInfo=new c.PatchGeometry,this._textureRef=new f.default((()=>this.tile.surface.textureFadeDuration)),this.overlay=new y}var g=e.prototype;return g.init=function(e){this.tile=e,this.clear();const t=this.geometryInfo;t.indices=null,t.vertexAttributes=null,s.empty(t.boundingBox),t.numSurfaceIndices=0,t.numSkirtIndices=0,t.numWithoutSkirtIndices=0,t.numVertsPerRow=0,this.geometryState={numVertsPerRow:0,samplerData:null,clippingArea:null,wireframe:!1},this.opacity=1,this.localOrigin=null,this.overlay.clear()},g.clear=function(){this.releaseGeometry(),this.releaseTexture(),this._textureRef.clear()},g.updateGeometry=function(e,t){return!!this._updateGeometryState(t)&&(this._releaseGeometry(),this._createGeometry(e),!0)},g.releaseGeometry=function(){return!!this._releaseGeometry()&&(this.geometryState={numVertsPerRow:0,samplerData:null,clippingArea:null,wireframe:!1},!0)},g.ensureTexture=function(e,t){return r.isSome(this._texture)&&this._texture.descriptor.width!==e&&this.releaseTexture(),this._texture||(this._texture=t(),this.tile.setMemoryDirty()),this._texture},g.releaseTexture=function(){r.isSome(this._texture)&&(this._texture.release(),this._texture=null,this.tile.setMemoryDirty())},g._updateGeometryState=function(e){const t=this._getElevationInfo(),r=this.tile.level;let s=r<8?this.tile.numSubdivisionsAtLevel[r]+1:2;if(t.samplerData){const e=this.tile.vlevel-r,i=Math.max(r-t.maxTileLevel,a.ELEVATION_DESIRED_RESOLUTION_LEVEL-e),l=this.tile.maxTesselation;s=n.clamp(1+(l>>i),2,l+1)}let l=this.tile.clippingArea;this.tile.intersectsClippingArea&&!this.tile.isWithinClippingArea||(l=null);const o=this.geometryState;let u=!1;return o.numVertsPerRow!==s&&(o.numVertsPerRow=s,u=!0),t.changed&&(o.samplerData=t.samplerData,u=!0),i.equals(o.clippingArea,l)||(o.clippingArea=l,u=!0),o.wireframe!==e&&(o.wireframe=e,u=!0),u},g._createGeometry=function(e){this.tile.createGeometry(this.geometryState,this.localOrigin);const t=this.geometryInfo.vertexAttributes,r=this.geometryInfo.indices,i=e.gl;this._vao=new h(e,l.Default3D,{geometry:o.glLayout(t.layout)},{geometry:u.createVertex(e,i.STATIC_DRAW,t.buffer)},u.createIndex(e,i.STATIC_DRAW,r))},g._releaseGeometry=function(){return!!this._vao&&(this._vao.dispose(),this._vao=null,c.releaseGeometry(this.geometryInfo),!0)},g.setTextureReference=function(e,t,r,i,n=0){e!==this._texture&&this.releaseTexture(),this._textureRef.push(e,t,r,i,n)},g._getElevationInfo=function(){const e=this.geometryState.samplerData,t=this.tile.layerInfo[0],r=t.length;let i=new Array(r),n=0,s=0,a=!1;for(let l=0;l<r;l++){const r=t[l];if(r.upsampleInfo){const t=r.upsampleInfo.tile,o=t.layerInfo[0][l].data,u=o&&o.samplerData;e&&e[n]===u||(a=!0),i[n++]=u,s=Math.max(s,t.lij[0])}else if(r.data){const t=this.tile.surface.layerViewByIndex(l,0);if(m.fallsWithinLayer(this.tile,t.layer,!1)){const t=r.data;e&&e[n]===t.samplerData||(a=!0),i[n++]=t.samplerData,s=this.tile.lij[0]}}}return e&&e.length!==n&&(a=!0),n>0?i.length=n:i=null,{changed:a,samplerData:i,maxTileLevel:s}},t._createClass(e,[{key:"vao",get:function(){return this._vao}},{key:"textureReference",get:function(){return this._textureRef.current}},{key:"nextTextureReference",get:function(){return this._textureRef.next}},{key:"textureFadeFactor",get:function(){return this._textureRef.fadeFactor}},{key:"textureIsFading",get:function(){return this._textureRef.isFading}},{key:"estimatedGeometryMemoryUsage",get:function(){return this.geometryInfo.indices.byteLength+this.geometryInfo.vertexAttributes.byteLength}},{key:"textureDescriptor",get:function(){return r.isSome(this._texture)?this._texture.descriptor:null}},{key:"test",get:function(){return{hasTexture:null!=this._texture}}}]),e}();e.PatchRenderData=g,Object.defineProperty(e,"__esModule",{value:!0})}));
