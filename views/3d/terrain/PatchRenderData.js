// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","../../../core/arrayUtils","../../../core/mathUtils","../../../core/maybe","../../../core/libs/gl-matrix-2/vec2","../../../core/libs/gl-matrix-2/vec2f64","../../../geometry/support/aaBoundingBox","../support/buffer/glUtil","./PatchGeometryFactory","./PatchGeometryFactory","./TerrainConst","./TextureFader","./tileUtils","../webgl-engine/lib/DefaultVertexAttributeLocations","../../webgl/BufferObject","../../webgl/VertexArrayObject"],(function(e,t,r,i,a,o,n,l,s,u,c,f,h,p,y,m,g){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PatchRenderData=void 0;var x=function(){function e(){var e=this;this.overlayTexOffset=n.vec2f64.create(),this.geometryInfo=new c.PatchGeometry,this._textureRef=new h.default((function(){return e.tile.surface.textureFadeDuration}))}return e.prototype.init=function(e){this.tile=e,this.clear();var t=this.geometryInfo;if(t.indices=null,t.vertexAttributes=null,l.empty(t.boundingBox),t.numSurfaceIndices=0,t.numSkirtIndices=0,t.numWithoutSkirtIndices=0,t.numVertsPerRow=0,this.geometryState={numVertsPerRow:0,samplerData:null,clippingArea:null,wireframe:!1},this.opacity=1,this.overlays)for(var r=0,i=this.overlays;r<i.length;r++){var a=i[r];a.overlay=null,o.vec2.set(a.texScale,1,1),o.vec2.set(a.texOffset,0,0)}else{this.overlays=[null,null];for(var n=0;n<2;n++)this.overlays[n]={overlay:null,texScale:[1,1],texOffset:[0,0]}}this.overlayOpacity=1,this.localOrigin=null},e.prototype.clear=function(){this.releaseGeometry(),this.releaseTexture(),this._textureRef.clear()},e.prototype.updateGeometry=function(e,t){return!!this._updateGeometryState(t)&&(this._releaseGeometry(),this._createGeometry(e),!0)},e.prototype.releaseGeometry=function(){return!!this._releaseGeometry()&&(this.geometryState={numVertsPerRow:0,samplerData:null,clippingArea:null,wireframe:!1},!0)},e.prototype.ensureTexture=function(e,t){return a.isSome(this._texture)&&this._texture.descriptor.width!==e&&this.releaseTexture(),this._texture||(this._texture=t(),this.tile.setMemoryDirty()),this._texture},e.prototype.releaseTexture=function(){a.isSome(this._texture)&&(this._texture.release(),this._texture=null,this.tile.setMemoryDirty())},e.prototype._updateGeometryState=function(e){var t=this._getElevationInfo(),a=this.tile.level,o=a<8?this.tile.numSubdivisionsAtLevel[a]+1:2;if(t.samplerData){var n=this.tile.vlevel-a,l=Math.max(a-t.maxTileLevel,f.ELEVATION_DESIRED_RESOLUTION_LEVEL-n),s=this.tile.maxTesselation;o=i.clamp(1+(s>>l),2,s+1)}var u=this.tile.clippingArea;this.tile.intersectsClippingArea&&!this.tile.isWithinClippingArea||(u=null);var c=this.geometryState,h=!1;return c.numVertsPerRow!==o&&(c.numVertsPerRow=o,h=!0),t.changed&&(c.samplerData=t.samplerData,h=!0),r.equals(c.clippingArea,u)||(c.clippingArea=u,h=!0),c.wireframe!==e&&(c.wireframe=e,h=!0),h},e.prototype._createGeometry=function(e){this.tile.createGeometry(this.geometryState,this.localOrigin);var t=this.geometryInfo.vertexAttributes,r=this.geometryInfo.indices,i=e.gl;this._vao=new g(e,y.Default3D,{geometry:s.glLayout(t.layout)},{geometry:m.createVertex(e,i.STATIC_DRAW,t.buffer)},m.createIndex(e,i.STATIC_DRAW,r))},e.prototype._releaseGeometry=function(){return!!this._vao&&(this._vao.dispose(),this._vao=null,u.releaseGeometry(this.geometryInfo),!0)},Object.defineProperty(e.prototype,"vao",{get:function(){return this._vao},enumerable:!1,configurable:!0}),e.prototype.setTextureReference=function(e,t,r,i,a){void 0===a&&(a=0),e!==this._texture&&this.releaseTexture(),this._textureRef.push(e,t,r,i,a)},Object.defineProperty(e.prototype,"textureReference",{get:function(){return this._textureRef.current},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"nextTextureReference",{get:function(){return this._textureRef.next},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"textureFadeFactor",{get:function(){return this._textureRef.fadeFactor},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"textureIsFading",{get:function(){return this._textureRef.isFading},enumerable:!1,configurable:!0}),e.prototype._getElevationInfo=function(){for(var e=this.geometryState.samplerData,t=this.tile.layerInfo[0],r=t.length,i=new Array(r),a=0,o=0,n=!1,l=0;l<r;l++){var s=t[l];if(s.upsampleInfo){var u=s.upsampleInfo.tile,c=(h=u.layerInfo[0][l].data)&&h.samplerData;e&&e[a]===c||(n=!0),i[a++]=c,o=Math.max(o,u.lij[0])}else if(s.data){var f=this.tile.surface.layerViewByIndex(l,0);if(p.fallsWithinLayer(this.tile,f.layer,!1)){var h=s.data;e&&e[a]===h.samplerData||(n=!0),i[a++]=h.samplerData,o=this.tile.lij[0]}}}return e&&e.length!==a&&(n=!0),a>0?i.length=a:i=null,{changed:n,samplerData:i,maxTileLevel:o}},Object.defineProperty(e.prototype,"estimatedGeometryMemoryUsage",{get:function(){return this.geometryInfo.indices.byteLength+this.geometryInfo.vertexAttributes.byteLength},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"textureDescriptor",{get:function(){return a.isSome(this._texture)?this._texture.descriptor:null},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"test",{get:function(){return{hasTexture:null!=this._texture}},enumerable:!1,configurable:!0}),e}();t.PatchRenderData=x}));