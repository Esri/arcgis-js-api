// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../core/arrayUtils","../../../core/mathUtils","../../../core/libs/gl-matrix-2/vec2","../../../core/libs/gl-matrix-2/vec2f64","../../../core/libs/gl-matrix-2/vec4","../../../core/libs/gl-matrix-2/vec4f64","../../../geometry/support/aaBoundingBox","../support/buffer/glUtil","./PatchGeometryFactory","./TerrainConst","./tileUtils","../webgl-engine/lib/DefaultVertexAttributeLocations","../../webgl/BufferObject","../../webgl/VertexArrayObject"],function(e,t,r,i,a,l,n,s,o,u,c,h,m,f,p,y){Object.defineProperty(t,"__esModule",{value:!0});var g=function(){function e(){this.overlayTexOffset=l.vec2f64.create(),this.texOffsetAndScale=s.vec4f64.create(),this.geometryInfo={indices:null,vertexAttributes:null,boundingBox:o.empty(),numSurfaceIndices:0,numSkirtIndices:0,numWithoutSkirtIndices:0,numVertsPerRow:0,skirtLength:0,uvOffsetAndScale:s.vec4f64.create()}}return e.prototype.init=function(e){this.tile=e;var t=this.geometryInfo;if(t.indices=null,t.vertexAttributes=null,o.empty(t.boundingBox),t.numSurfaceIndices=0,t.numSkirtIndices=0,t.numWithoutSkirtIndices=0,t.numVertsPerRow=0,this.geometryState={numVertsPerRow:0,samplerData:null,clippingArea:null,wireframe:!1},this._vao=null,this._texture=null,this.textureReference=null,n.vec4.set(this.texOffsetAndScale,0,0,1,1),this.opacity=1,this.overlays)for(var r=0,i=this.overlays;r<i.length;r++){var l=i[r];l.renderTargetId=null,l.highlightRenderTargetId=null,l.waterMaskRenderTargetId=null,a.vec2.set(l.texScale,1,1),a.vec2.set(l.texOffset,0,0)}else{this.overlays=[null,null];for(var s=0;s<2;s++)this.overlays[s]={renderTargetId:null,highlightRenderTargetId:null,waterMaskRenderTargetId:null,texScale:[1,1],texOffset:[0,0]}}this.overlayOpacity=1,this.localOrigin=null},e.prototype.updateGeometry=function(e,t){return!!this._updateGeometryState(t)&&(this._releaseGeometry(),this._createGeometry(e,t),!0)},e.prototype.releaseGeometry=function(){return!!this._releaseGeometry()&&(this.geometryState={numVertsPerRow:0,samplerData:null,clippingArea:null,wireframe:!1},!0)},e.prototype.ensureTexture=function(e,t){return this._texture&&this._texture.descriptor.width!==t&&this.releaseTexture(),this._texture||(this._texture=e(t),this.tile.updateMemoryUsed()),this._texture},e.prototype.releaseTexture=function(){this._texture&&(this._texture.dispose(),this._texture=null),this.textureReference=null},e.prototype._updateGeometryState=function(e){var t=this._getElevationInfo(),a=this.tile.lij[0],l=a<8?this.tile.numSubdivisionsAtLevel[a]+1:2;if(t.samplerData){var n=this.tile.vlevel-a,s=Math.max(a-t.maxTileLevel,h.ELEVATION_DESIRED_RESOLUTION_LEVEL-n),o=this.tile.maxTesselation;l=i.clamp(1+(o>>s),2,o+1)}var u=this.tile.clippingArea;this.tile.intersectsClippingArea&&!this.tile.isWithinClippingArea||(u=null);var c=this.geometryState,m=!1;return c.numVertsPerRow!==l&&(c.numVertsPerRow=l,m=!0),t.changed&&(c.samplerData=t.samplerData,m=!0),r.equals(c.clippingArea,u)||(c.clippingArea=u,m=!0),c.wireframe!==e&&(c.wireframe=e,m=!0),m},e.prototype._createGeometry=function(e,t){this.tile.createGeometry(this.geometryState,this.localOrigin,t);var r=this.geometryInfo.vertexAttributes,i=this.geometryInfo.indices,a=e.gl;this._vao=new y(e,f.Default3D,{geometry:u.glLayout(r.layout)},{geometry:p.createVertex(e,a.STATIC_DRAW,r.buffer)},p.createIndex(e,a.STATIC_DRAW,i))},e.prototype._releaseGeometry=function(){return!!this._vao&&(this._vao.dispose(),this._vao=null,c.releaseGeometry(this.geometryInfo),!0)},Object.defineProperty(e.prototype,"vao",{get:function(){return this._vao},enumerable:!0,configurable:!0}),e.prototype._getElevationInfo=function(){for(var e=this.geometryState.samplerData,t=this.tile.layerInfo[h.LayerClass.ELEVATION],r=t.length,i=new Array(r),a=0,l=0,n=!1,s=0;s<r;s++){var o=t[s];if(o.upsampleFromTile){var u=o.upsampleFromTile.tile,c=u.layerInfo[h.LayerClass.ELEVATION][s].data,f=c.samplerData;e&&e[a]===f||(n=!0),i[a++]=f,l=Math.max(l,u.lij[0])}else if(o.data){var p=this.tile.surface.layerViewByIndex(s,h.LayerClass.ELEVATION);if(m.fallsWithinLayer(this.tile,p.layer,!1)){var c=o.data;e&&e[a]===c.samplerData||(n=!0),i[a++]=c.samplerData,l=this.tile.lij[0]}}}return e&&e.length!==a&&(n=!0),a>0?i.length=a:i=null,{changed:n,samplerData:i,maxTileLevel:l}},Object.defineProperty(e.prototype,"estimatedGeometryMemoryUsage",{get:function(){return this.geometryInfo.indices.byteLength+this.geometryInfo.vertexAttributes.byteLength},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"textureDescriptor",{get:function(){return this._texture?this._texture.descriptor:null},enumerable:!0,configurable:!0}),e}();t.PatchRenderData=g});