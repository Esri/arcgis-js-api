/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/Evented","../../../core/Handles","../../../core/Logger","../../../core/MapUtils","../../../core/maybe","../../../core/PooledArray","../../../core/SetUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../../chunks/mat4","../../../chunks/vec2f64","../../../chunks/vec3f64","../../../chunks/mat4f64","../support/debugFlags","./Overlay","./OverlayFramebufferObject","./OverlayRenderTarget","../webgl-engine/core/shaderTechnique/ShaderTechniqueRepository","../webgl-engine/lib/AutoDisposable","../webgl-engine/lib/Camera","../webgl-engine/lib/GLMaterialRepository","../webgl-engine/lib/glUtil3D","../webgl-engine/lib/GridLocalOriginFactory","../webgl-engine/lib/Intersector","../webgl-engine/lib/RenderContext","../webgl-engine/lib/SortedRenderGeometryRenderer","../webgl-engine/lib/TextureTechnique","../webgl-engine/lighting/Lightsources","../webgl-engine/lighting/SceneLighting","../webgl-engine/materials/StippleTextureRepository","../../support/Scheduler","../../webgl/Texture","../../webgl/Util"],(function(e,r,t,i,s,n,a,o,d,l,h,u,c,y,p,g,_,m,f,R,T,v,b,w,x,O,S,L,P,C,D,M,G,V,E,k,A,q,F,U,W){"use strict";const H=a.getLogger("esri.views.3d.webgl-engine.lib.OverlayRenderer");e.OverlayRenderer=function(e){function t(r){var t;return(t=e.call(this,r)||this)._overlays=null,t._overlayRenderTarget=null,t._hasHighlights=!1,t._rendersOccluded=!1,t._hasWater=!1,t._lighting=new A.SceneLighting,t._handles=new n,t._frameTask=F.ImmediateTask,t._layerRenderers=new Map,t._sortedLayerRenderersDirty=!1,t._sortedLayerRenderers=new l,t._geometries=new Map,t.worldToPCSRatio=1,t.events=new s,t.longitudeCyclical=null,t}r._inheritsLoose(t,e);var i=t.prototype;return i.initialize=function(){const e=this.view._stage.renderView;this._rctx=e.renderingContext,this._renderContext=new G.OverlayRenderContext(this._rctx);const r=e.waterTextureRepository;this._stippleTextureRepository=new q.StippleTextureRepository(e.renderingContext),this._shaderTechniqueRepository=new O.ShaderTechniqueRepository({rctx:this._rctx,viewingMode:2,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:r}),this._handles.add([u.init(r,"loadingState",(()=>this.events.emit("content-changed"))),u.init(this,"spatialReference",(e=>this._localOrigins=new D.GridLocalOriginFactory(e)))]),this._materialRepository=new P.GLMaterialRepository(e.textureRepository,this._shaderTechniqueRepository,(e=>{(e.renderOccluded&X)>0!==this._rendersOccluded&&this.updateRendersOccluded(),this.events.emit("content-changed"),this.notifyChange("updating")}),(()=>this.events.emit("content-changed"))),this._lighting.groundLightingFactor=1,this._lighting.globalFactor=0,this._lighting.set([new k.AmbientLight(R.fromValues(1,1,1))]),this._bindParameters={slot:20,highlightDepthTexture:C.createEmptyDepthTexture(this._rctx),camera:I,inverseViewport:f.create(),origin:null,screenToWorldRatio:null,screenToPCSRatio:null,shadowMappingEnabled:!1,slicePlane:null,ssaoEnabled:!1,hasOccludees:!1,linearDepthTexture:null,lastFrameColorTexture:null,reprojectionMatrix:T.IDENTITY,ssrEnabled:!1,lighting:this._lighting,transparencyPassType:3,terrainLinearDepthTexture:null,geometryLinearDepthTexture:null,multipassTerrainEnabled:!1,cullAboveGround:!1,multipassGeometryEnabled:!1,highlightColorTexture:null},this._frameTask=this.view.resourceController.scheduler.registerTask(F.TaskPriority.STAGE,this),this._handles.add(this._frameTask)},i.dispose=function(){this._handles.destroy(),this._layerRenderers.forEach((e=>e.dispose())),this._layerRenderers.clear(),this._debugTextureTechnique=d.releaseMaybe(this._debugTextureTechnique),this._debugPatternTexture=d.disposeMaybe(this._debugPatternTexture),this._bindParameters.highlightDepthTexture=d.disposeMaybe(this._bindParameters.highlightDepthTexture),this._shaderTechniqueRepository=d.disposeMaybe(this._shaderTechniqueRepository),this._temporaryFBO=d.disposeMaybe(this._temporaryFBO),this._quadVAO=d.disposeMaybe(this._quadVAO),this.disposeOverlays()},i.collectUnusedRenderTargetMemory=function(e){let r=!1;if(d.isSome(this._overlayRenderTarget))for(const t of this._overlayRenderTarget.renderTargets){const i=this.overlays[0].validTargets[t.type]||!this.overlays[1].validTargets[t.type];r=this._overlayRenderTarget.validateUsageForTarget(i,t,e)||r}return r},i.ensureDrapeTargets=function(e){d.isSome(this._overlays)&&this._overlays.forEach((r=>{r.hasTargetWithoutRasterImage=h.someSet(e,(e=>1===e.drapeTargetType))}))},i.ensureDrapeSources=function(e){d.isSome(this._overlays)&&this._overlays.forEach((r=>{r.hasDrapedFeatureSource=o.someMap(e,((e,r)=>1===r.drapeSourceType)),r.hasDrapedRasterSource=o.someMap(e,((e,r)=>0===r.drapeSourceType))}))},i.ensureOverlays=function(e,r){d.isNone(this._overlays)&&(this._overlayRenderTarget=new x.OverlayRenderTarget(this._rctx),this._overlays=[new b.Overlay(0,this._overlayRenderTarget),new b.Overlay(1,this._overlayRenderTarget)]),this.ensureDrapeTargets(e),this.ensureDrapeSources(r)},i.disposeOverlays=function(){this._overlays=null,this._overlayRenderTarget=d.disposeMaybe(this._overlayRenderTarget),this.events.emit("textures-disposed")},i.runTask=function(e,r=(()=>!0)){this._frameTask.processQueue(e),e.done||this._processLayers(e,r)},i._processLayers=function(e,r){let t=!1;for(const[i,s]of this._layerRenderers){if(e.done)break;(i.destroyed||r(i))&&(s.commitChanges()&&(t=!0,e.madeProgress()),s.isEmpty&&(t=!0,this._sortedLayerRenderersDirty=!0,this._layerRenderers.delete(i),this._handles.remove(i)))}this.updateSortedLayerRenderers(),t&&(d.isSome(this._overlays)&&0===this._layerRenderers.size&&this.disposeOverlays(),this.notifyChange("updating"),this.events.emit("content-changed"),this.updateHasHighlights(),this.updateRendersOccluded(),this.updateHasWater())},i.processSyncLayers=function(){this._processLayers(F.noBudget,(e=>1===e.updatePolicy))},i.addGeometries=function(e,r,t){for(const i of e)d.isNone(i.origin)&&(i.origin=this._localOrigins.getOrigin(i.boundingSphere)),this._geometries.set(i.id,i);this.ensureLayerRenderer(r).add(e),2===t&&this.notifyGraphicGeometryChanged(e,r)},i.removeGeometries=function(e,r,t){for(const s of e)this._geometries.delete(d.unwrap(s.id));const i=this._layerRenderers.get(r);i&&(i.remove(e),2===t&&this.notifyGraphicGeometryChanged(e,r))},i.updateGeometries=function(e,r,t){const i=this._layerRenderers.get(r);if(i)switch(i.modify(e,t),t){case 4:case 2:return this.notifyGraphicGeometryChanged(e,r);case 1:return this.notifyGraphicVisibilityChanged(e,r)}else H.warn("Attempted to update geometry for nonexistent layer")},i.notifyGraphicGeometryChanged=function(e,r){if(d.isNone(r.notifyGraphicGeometryChanged))return;let t;for(const i of e){const e=i.graphicUid;d.isSome(e)&&e!==t&&(r.notifyGraphicGeometryChanged(e),t=e)}},i.notifyGraphicVisibilityChanged=function(e,r){if(d.isNone(r.notifyGraphicVisibilityChanged))return;let t;for(const i of e){const e=i.graphicUid;d.isSome(e)&&e!==t&&(r.notifyGraphicVisibilityChanged(e),t=e)}},i.updateHighlights=function(e,r){const t=this._layerRenderers.get(r);t?t.modify(e,8):H.warn("Attempted to update highlights for nonexistent layer")},i.isEmpty=function(){return 0===this._geometries.size&&!v.OVERLAY_DRAW_DEBUG_TEXTURE},i.updateLogic=function(e){let r=!1;return this._layerRenderers.forEach((t=>r=t.updateLogic(e)||r)),r},i.updateLayerOrder=function(){this._sortedLayerRenderersDirty=!0},i.drawTarget=function(e,r,t){const i=e.canvasGeometries;if(0===i.numViews)return!1;this._screenToWorldRatio=t*e.mapUnitsPerPixel;const s=r.renderPass;if(this.isEmpty()||5===s&&!this.hasHighlights||3===s&&!this.hasWater||!e.hasSomeSizedView())return!1;const n=r.fbo;if(!n.isValid())return!1;const a=2*e.resolution,o=e.resolution;n.resize(a,o);const l=this._rctx;I.pixelRatio=e.pixelRatio*t,this._renderContext.pass=s,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToPCSRatio=this._screenToWorldRatio*this.worldToPCSRatio,this._bindParameters.slot=3===s?21:20,e.applyViewport(this._rctx),n.bind(l),0===e.index&&(l.setClearColor(0,0,0,0),l.clearSafe(16384));const h=1===r.type?2:4===r.type?1:0;if(1===h&&(this._renderContext.renderOccludedMask=X),v.OVERLAY_DRAW_DEBUG_TEXTURE&&1!==h)for(let d=0;d<i.numViews;d++)this.setViewParameters(i.extents[d],e,I),this.drawDebugTexture(e.resolution,z[e.index]);return this._layerRenderers.size>0&&this._sortedLayerRenderers.forAll((({layerView:r,renderer:t})=>{if(2===h&&d.isSome(r)&&0===r.drapeSourceType)return;const u=d.isSome(r)&&d.isSome(r.fullOpacity)&&r.fullOpacity<1&&0===s;u&&(this.bindTemporaryFramebuffer(this._rctx,a,o),l.clearSafe(16384));for(let s=0;s<i.numViews;s++)this.setViewParameters(i.extents[s],e,I),t.render(this._renderContext,this._bindParameters);u&&d.isSome(this._temporaryFBO)&&(n.bind(l),this.view._stage.renderView.compositingHelper.composite(this._temporaryFBO.getTexture(),2,d.unwrap(d.unwrap(r).fullOpacity),3,e.index))})),l.bindFramebuffer(null),n.generateMipMap(),this._renderContext.resetRenderOccludedMask(),!0},i.bindTemporaryFramebuffer=function(e,r,t){d.isNone(this._temporaryFBO)&&(this._temporaryFBO=new w.OverlayFramebufferObject(e,!1)),this._temporaryFBO.resize(r,t),this._temporaryFBO.bind(e)},i.reloadShaders=function(){var e=r._asyncToGenerator((function*(){yield this._shaderTechniqueRepository.reloadAll()}));function t(){return e.apply(this,arguments)}return t}(),i.intersect=function(e,r,t,i){let s=0;this._geometries.forEach((n=>{if(i&&!i(n))return;this._intersectRenderGeometry(n,t,r,0,e,s);const a=this.longitudeCyclical;a&&(n.boundingSphere[0]-n.boundingSphere[3]<a.min&&this._intersectRenderGeometry(n,t,r,a.range,e,s),n.boundingSphere[0]+n.boundingSphere[3]>a.max&&this._intersectRenderGeometry(n,t,r,-a.range,e,s)),s++}))},i._intersectRenderGeometry=function(e,r,t,i,s,n){if(!e.instanceParameters.visible)return;let a=0;d.isSome(e.transformation)&&(i+=e.transformation[12],a=e.transformation[13]),j[0]=t[0]-i,j[1]=t[1]-a,j[2]=1,Y[0]=t[0]-i,Y[1]=t[1]-a,Y[2]=0,e.screenToWorldRatio=this._screenToWorldRatio,e.material.intersect(e,null,e.getShaderTransformation(),s,j,Y,((t,i,a)=>{N(r,a,e.material.renderPriority,n,s,e.layerUid,e.graphicUid)}),e.calculateShaderTransformation,r)},i.ensureLayerRenderer=function(e){let r=this._layerRenderers.get(e);return r||(r=new V.SortedRenderGeometryRenderer({rctx:this._rctx,materialRepository:this._materialRepository}),this._layerRenderers.set(e,r),this._sortedLayerRenderersDirty=!0,"fullOpacity"in e&&this._handles.add(e.watch("fullOpacity",(()=>this.events.emit("content-changed"))),e),this._handles.add(u.init(r,"updating",(()=>this.notifyChange("updating"))),e)),r},i.updateSortedLayerRenderers=function(){if(!this._sortedLayerRenderersDirty)return;if(this._sortedLayerRenderersDirty=!1,this._sortedLayerRenderers.clear(),0===this._layerRenderers.size)return;const e=new Set(this._layerRenderers.values());this.view.allLayerViews.forEach((r=>{const t=r,i=this._layerRenderers.get(t);i&&(this._sortedLayerRenderers.push(new B(t,i)),e.delete(i))})),e.forEach((e=>this._sortedLayerRenderers.push(new B(null,e))))},i.setViewParameters=function(e,r,t){t.viewport[0]=t.viewport[1]=0,t.viewport[2]=t.viewport[3]=r.resolution,m.ortho(t.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],t.near,t.far),m.identity(t.viewMatrix),m.translate(t.viewMatrix,t.viewMatrix,[-e[0],-e[1],0]),this._renderContext.camera=t,this._bindParameters.camera=t,this._bindParameters.inverseViewport[0]=1/t.fullViewport[2],this._bindParameters.inverseViewport[1]=1/t.fullViewport[3]},i.updateHasWater=function(){const e=o.someMap(this._layerRenderers,(e=>e.hasWater));e!==this._hasWater&&(this._hasWater=e,this.events.emit("has-water",e))},i.updateHasHighlights=function(){const e=o.someMap(this._layerRenderers,(e=>e.hasHighlights));e!==this._hasHighlights&&(this._hasHighlights=e,this.events.emit("has-highlights",e))},i.updateRendersOccluded=function(){const e=o.someMap(this._layerRenderers,(e=>e.rendersOccluded));e!==this._rendersOccluded&&(this._rendersOccluded=e,this.events.emit("renders-occluded",e))},i.drawDebugTexture=function(e,r){const t=this._rctx;this.ensureDebugPatternResources(e,e);const i=this._debugTextureTechnique.program;t.useProgram(i),this._debugTextureTechnique.bindPipelineState(t),i.setUniform4f("color",r[0],r[1],r[2],1),i.bindTexture(this._debugPatternTexture,"tex"),t.bindVAO(this._quadVAO),t.drawArrays(5,0,W.vertexCount(this._quadVAO,"geometry"))},i.ensureDebugPatternResources=function(e,r){if(this._debugPatternTexture)return;const t=new Uint8Array(e*r*4);let i=0;for(let n=0;n<r;n++)for(let s=0;s<e;s++){const a=Math.floor(s/10),o=Math.floor(n/10);a<2||o<2||10*a>e-20||10*o>r-20?(t[i++]=255,t[i++]=255,t[i++]=255,t[i++]=255):(t[i++]=255,t[i++]=255,t[i++]=255,t[i++]=1&a&&1&o?1&s^1&n?0:255:1&a^1&o?0:128)}this._debugPatternTexture=new U(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:e,height:r},t);const s=new E.TextureTechniqueConfiguration;s.hasAlpha=!0,this._debugTextureTechnique=this._shaderTechniqueRepository.acquire(E.TextureTechnique,s),this._quadVAO=C.createQuadVAO(this._rctx)},r._createClass(t,[{key:"updating",get:function(){return this._sortedLayerRenderersDirty||this._frameTask.updating||o.someMap(this._layerRenderers,(e=>e.updating))}},{key:"hasOverlays",get:function(){return d.isSome(this._overlays)&&d.isSome(this._overlayRenderTarget)}},{key:"gpuMemoryUsage",get:function(){return d.isSome(this._overlayRenderTarget)?this._overlayRenderTarget.gpuMemoryUsage:0}},{key:"overlays",get:function(){return d.unwrapOr(this._overlays,[])}},{key:"running",get:function(){return this.updating}},{key:"hasHighlights",get:function(){return this._hasHighlights}},{key:"hasWater",get:function(){return this._hasWater}},{key:"rendersOccluded",get:function(){return this._rendersOccluded}},{key:"test",get:function(){return{layerRenderers:this._layerRenderers}}}]),t}(S.AutoDisposableMixin(i)),t.__decorate([c.property()],e.OverlayRenderer.prototype,"_frameTask",void 0),t.__decorate([c.property()],e.OverlayRenderer.prototype,"_sortedLayerRenderersDirty",void 0),t.__decorate([S.autoDispose()],e.OverlayRenderer.prototype,"_shaderTechniqueRepository",void 0),t.__decorate([S.autoDispose()],e.OverlayRenderer.prototype,"_stippleTextureRepository",void 0),t.__decorate([c.property({constructOnly:!0})],e.OverlayRenderer.prototype,"view",void 0),t.__decorate([c.property()],e.OverlayRenderer.prototype,"worldToPCSRatio",void 0),t.__decorate([c.property()],e.OverlayRenderer.prototype,"spatialReference",void 0),t.__decorate([c.property({type:Boolean,readOnly:!0})],e.OverlayRenderer.prototype,"updating",null),e.OverlayRenderer=t.__decorate([_.subclass("esri.views.3d.terrain.OverlayRenderer")],e.OverlayRenderer);let B=function(e,r){this.layerView=e,this.renderer=r};const z=[[1,.5,.5],[.5,.5,1]];function N(e,r,t,i,s,n,a){const o={layerUid:n,graphicUid:a,triangleNr:r},d=r=>{r.set(3,o,e.dist,e.normal,e.transformation,t,i)};if((null==s.results.min.drapedLayerOrder||t>=s.results.min.drapedLayerOrder)&&(null==s.results.min.dist||s.results.ground.dist<=s.results.min.dist)&&d(s.results.min),0!==s.options.store&&(null==s.results.max.drapedLayerOrder||t<s.results.max.drapedLayerOrder)&&(null==s.results.max.dist||s.results.ground.dist>s.results.max.dist)&&d(s.results.max),2===s.options.store){const e=M.newIntersectorResult(s.ray);d(e),s.results.all.push(e)}}const I=new L;I.near=1,I.far=1e4,I.relativeElevation=null;const j=R.create(),Y=R.create(),Q=-2,X=4;e.DRAPED_Z=Q,e.overlayRenderOccludedFlag=X,Object.defineProperty(e,"__esModule",{value:!0})}));
