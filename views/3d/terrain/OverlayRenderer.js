/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/Evented","../../../core/Handles","../../../core/MapUtils","../../../core/maybe","../../../core/PooledArray","../../../core/reactiveUtils","../../../core/SetUtils","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../../chunks/mat4","../../../chunks/vec3","../../../chunks/vec3f64","../../ViewingMode","../layers/interfaces","../support/debugFlags","./interfaces","./Overlay","./OverlayFramebufferObject","./OverlayRenderTarget","../webgl-engine/core/shaderLibrary/ShaderOutput","../../../chunks/TextureOnly.glsl","../webgl-engine/core/shaderTechnique/ShaderTechniqueRepository","../webgl-engine/lib/AutoDisposable","../webgl-engine/lib/basicInterfaces","../webgl-engine/lib/Camera","../webgl-engine/lib/GLMaterialRepository","../webgl-engine/lib/glUtil3D","../webgl-engine/lib/GridLocalOriginFactory","../webgl-engine/lib/Material","../webgl-engine/lib/RenderContext","../webgl-engine/lib/RenderSlot","../webgl-engine/lib/ShadowMap","../webgl-engine/lib/SortedRenderGeometryRenderer","../webgl-engine/lib/SSAOHelper","../webgl-engine/lib/TextureTechnique","../webgl-engine/lib/TextureTechniqueConfiguration","../webgl-engine/lib/TransparencyPassType","../webgl-engine/lighting/Lightsources","../webgl-engine/materials/StippleTextureRepository","../../support/Scheduler","../../webgl/enums","../../webgl/Texture","../../webgl/Util"],(function(e,r,t,s,i,n,a,o,d,c,h,l,u,p,_,y,g,R,T,m,f,O,v,w,b,S,x,D,P,E,A,M,C,F,k,q,I,V,B,U,L,N,W,H,G,z,j,Y,X){"use strict";var Q;e.OverlayRenderer=function(t){function s(e){var r;return(r=t.call(this,e)||this)._overlays=null,r._overlayRenderTarget=null,r._hasHighlights=!1,r._rendersOccluded=!1,r._hasWater=!1,r._handles=new n,r._renderers=new Map,r._sortedDrapeSourceRenderersDirty=!1,r._sortedRenderers=new d,r._passParameters=new x.TextureOnlyPassParameters,r._rctx=null,r._materialRepository=null,r._screenToWorldRatio=1,r._localOriginFactory=null,r.worldToPCSRatio=1,r.events=new i,r.longitudeCyclical=null,r}r._inheritsLoose(s,t);var l=s.prototype;return l.initialize=function(){const e=this.view._stage.renderView;this._rctx=e.renderingContext;const r=e.waterTextureRepository;this._stippleTextureRepository=new G.StippleTextureRepository(e.renderingContext),this._shaderTechniqueRepository=new D.ShaderTechniqueRepository({rctx:this._rctx,viewingMode:T.ViewingMode.Local,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:r}),this._renderContext=new q.OverlayRenderContext(this._rctx,new V.ShadowMap(this._rctx,this.view.state.viewingMode),new U.SSAOHelper(this._shaderTechniqueRepository,this._rctx,(()=>{}))),this._handles.add([c.watch((()=>r.updating),(()=>this.events.emit("content-changed")),c.syncAndInitial),c.watch((()=>this.spatialReference),(e=>this._localOriginFactory=new F.GridLocalOriginFactory(e)),c.syncAndInitial),c.on((()=>this.view.allLayerViews),"after-changes",(()=>this._sortedDrapeSourceRenderersDirty=!0))]),this._materialRepository=new M.GLMaterialRepository(e.textureRepository,this._shaderTechniqueRepository,(e=>{(e.renderOccluded&ee)>0!==this._rendersOccluded&&this._updateRendersOccluded(),this.events.emit("content-changed"),this.notifyChange("updating")}),(()=>this.events.emit("content-changed"))),this._bindParameters.slot=I.RenderSlot.DRAPED_MATERIAL,this._bindParameters.highlightDepthTexture=C.createEmptyDepthTexture(this._rctx),this._bindParameters.camera=K,this._bindParameters.transparencyPassType=W.TransparencyPassType.NONE,this._bindParameters.newLighting.noonFactor=0,this._bindParameters.newLighting.globalFactor=0,this._bindParameters.newLighting.set([new H.AmbientLight(R.fromValues(1,1,1))]),this._handles.add(this.view.resourceController.scheduler.registerTask(z.TaskPriority.STAGE,this))},l.dispose=function(){this._handles.destroy(),this._renderers.forEach((e=>e.destroy())),this._renderers.clear(),this._debugTextureTechnique=o.releaseMaybe(this._debugTextureTechnique),this._passParameters.texture=o.disposeMaybe(this._passParameters.texture),this._bindParameters.highlightDepthTexture=o.disposeMaybe(this._bindParameters.highlightDepthTexture),this._shaderTechniqueRepository=o.disposeMaybe(this._shaderTechniqueRepository),this._temporaryFBO=o.disposeMaybe(this._temporaryFBO),this._quadVAO=o.disposeMaybe(this._quadVAO),this.disposeOverlays()},l.createGeometryDrapeSourceRenderer=function(e){return this.createDrapeSourceRenderer(e,B.SortedRenderGeometryRenderer)},l.createDrapeSourceRenderer=function(e,r,t){const s=this._renderers.get(e);o.isSome(s)&&s.destroy();const i=new r({...t,rendererContext:this,drapeSource:e});return this._renderers.set(e,i),this._sortedDrapeSourceRenderersDirty=!0,"fullOpacity"in e&&this._handles.add(c.watch((()=>e.fullOpacity),(()=>this.events.emit("content-changed"))),e),i},l.removeDrapeSourceRenderer=function(e){if(o.isNone(e))return;const r=this._renderers.get(e);o.isNone(r)||(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(e),this._handles.remove(e),r.destroy())},l.collectUnusedRenderTargetMemory=function(e){let r=!1;if(o.isSome(this._overlayRenderTarget))for(const t of this._overlayRenderTarget.renderTargets){const s=this.overlays[0].validTargets[t.type]||!this.overlays[1].validTargets[t.type];r=this._overlayRenderTarget.validateUsageForTarget(s,t,e)||r}return r},l.ensureDrapeTargets=function(e){o.isSome(this._overlays)&&this._overlays.forEach((r=>r.hasTargetWithoutRasterImage=h.someSet(e,(e=>e.drapeTargetType===m.DrapeTargetType.WithoutRasterImage))))},l.ensureDrapeSources=function(e){o.isSome(this._overlays)&&this._overlays.forEach((r=>{r.hasDrapedFeatureSource=h.someSet(e,(e=>e.drapeSourceType===m.DrapeSourceType.Features)),r.hasDrapedRasterSource=h.someSet(e,(e=>e.drapeSourceType===m.DrapeSourceType.RasterImage))}))},l.ensureOverlays=function(e,r){o.isNone(this._overlays)&&(this._overlayRenderTarget=new b.OverlayRenderTarget(this._rctx),this._overlays=[new v.Overlay(O.OverlayIndex.INNER,this._overlayRenderTarget),new v.Overlay(O.OverlayIndex.OUTER,this._overlayRenderTarget)]),this.ensureDrapeTargets(e),this.ensureDrapeSources(r)},l.disposeOverlays=function(){this._overlays=null,this._overlayRenderTarget=o.disposeMaybe(this._overlayRenderTarget),this.events.emit("textures-disposed")},l.runTask=function(e){this._processDrapeSources(e,(()=>!0))},l._processDrapeSources=function(e,r){let t=!1;for(const[s,i]of this._renderers){if(e.done)break;(s.destroyed||r(s))&&(i.commitChanges()&&(t=!0,e.madeProgress()))}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,t=!0,this._updateSortedDrapeSourceRenderers()),t&&(o.isSome(this._overlays)&&0===this._renderers.size&&this.disposeOverlays(),this.notifyChange("updating"),this.events.emit("content-changed"),this._updateHasHighlights(),this._updateRendersOccluded(),this._updateHasWater())},l.processSyncDrapeSources=function(){this._processDrapeSources(z.noBudget,(e=>e.updatePolicy===E.UpdatePolicy.SYNC))},l.isEmpty=function(){if(f.OVERLAY_DRAW_DEBUG_TEXTURE)return!1;for(const e of this._renderers.values())if(!e.isEmpty)return!1;return!0},l.updateAnimation=function(e){let r=!1;return this._renderers.forEach((t=>r=t.updateAnimation(e)||r)),r},l.updateDrapeSourceOrder=function(){this._sortedDrapeSourceRenderersDirty=!0},l.drawTarget=function(r,t,s){const i=r.canvasGeometries;if(0===i.numViews)return!1;this._screenToWorldRatio=s*r.mapUnitsPerPixel;const n=t.output;if(this.isEmpty()||n===S.ShaderOutput.Highlight&&!this.hasHighlights||n===S.ShaderOutput.Normal&&!this.hasWater||!r.hasSomeSizedView())return!1;const a=t.fbo;if(!a.isValid())return!1;const d=2*r.resolution,c=r.resolution;a.resize(d,c);const h=this._rctx;K.pixelRatio=r.pixelRatio*s,this._renderContext.output=n,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToPCSRatio=this._screenToWorldRatio*this.worldToPCSRatio,this._bindParameters.slot=n===S.ShaderOutput.Normal?I.RenderSlot.DRAPED_WATER:I.RenderSlot.DRAPED_MATERIAL,r.applyViewport(this._rctx),a.bind(h),r.index===O.OverlayIndex.INNER&&(h.setClearColor(0,0,0,0),h.clearSafe(j.ClearBufferBit.COLOR_BUFFER_BIT));const l=t.type===O.RenderTargetType.ColorNoRasterImage?e.DrawPassOption.ExcludeRasterImage:t.type===O.RenderTargetType.Occluded?e.DrawPassOption.OccludedOnly:e.DrawPassOption.Normal;if(l===e.DrawPassOption.OccludedOnly&&(this._renderContext.renderOccludedMask=ee),f.OVERLAY_DRAW_DEBUG_TEXTURE&&l!==e.DrawPassOption.OccludedOnly)for(let e=0;e<i.numViews;e++)this._setViewParameters(i.extents[e],r,K),this._drawDebugTexture(r.resolution,J[r.index]);return this._renderers.size>0&&this._sortedRenderers.forAll((({drapeSource:t,renderer:s})=>{if(l===e.DrawPassOption.ExcludeRasterImage&&t.drapeSourceType===m.DrapeSourceType.RasterImage)return;const{fullOpacity:u}=t,p=o.isSome(u)&&u<1&&n===S.ShaderOutput.Color;p&&(this.bindTemporaryFramebuffer(this._rctx,d,c),h.clearSafe(j.ClearBufferBit.COLOR_BUFFER_BIT));for(let e=0;e<i.numViews;e++)this._setViewParameters(i.extents[e],r,K),s.render(this._renderContext,this._bindParameters);p&&o.isSome(this._temporaryFBO)&&(a.bind(h),this.view._stage.renderView.compositingHelper.compositeOverlay(this._renderContext.bindParameters,this._temporaryFBO.getTexture(),u,r.index))})),h.bindFramebuffer(null),a.generateMipMap(),this._renderContext.resetRenderOccludedMask(),!0},l.bindTemporaryFramebuffer=function(e,r,t){o.isNone(this._temporaryFBO)&&(this._temporaryFBO=new w.OverlayFramebufferObject(e,!1)),this._temporaryFBO.resize(r,t),this._temporaryFBO.bind(e)},l.reloadShaders=function(){var e=r._asyncToGenerator((function*(){yield this._shaderTechniqueRepository.reloadAll()}));function t(){return e.apply(this,arguments)}return t}(),l.notifyContentChanged=function(){this.events.emit("content-changed")},l.intersect=function(e,r,t,s){let i=0;for(const n of this._renderers.values())i=n.intersect?.(e,r,t,s,i)??i},l._updateSortedDrapeSourceRenderers=function(){if(this._sortedRenderers.clear(),0===this._renderers.size)return;const e=this.view.map.allLayers;this._renderers.forEach(((r,t)=>{const s=e.indexOf(t.layer);this._sortedRenderers.push(new Z(t,r,s<0?1/0:s))})),this._sortedRenderers.sort(((e,r)=>e.index-r.index))},l._setViewParameters=function(e,r,t){t.viewport[0]=t.viewport[1]=0,t.viewport[2]=t.viewport[3]=r.resolution,y.ortho(t.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],t.near,t.far),y.fromTranslation(t.viewMatrix,[-e[0],-e[1],0]),this._bindParameters.camera=t},l._updateHasWater=function(){const e=a.someMap(this._renderers,(e=>e.hasWater));e!==this._hasWater&&(this._hasWater=e,this.events.emit("has-water",e))},l._updateHasHighlights=function(){const e=a.someMap(this._renderers,(e=>e.hasHighlights));e!==this._hasHighlights&&(this._hasHighlights=e,this.events.emit("has-highlights",e))},l._updateRendersOccluded=function(){const e=a.someMap(this._renderers,(e=>e.rendersOccluded));e!==this._rendersOccluded&&(this._rendersOccluded=e,this.events.emit("renders-occluded",e))},l._drawDebugTexture=function(e,r){this._ensureDebugPatternResources(e,e,r);const t=this._rctx;t.bindTechnique(this._debugTextureTechnique,this._passParameters,null),t.bindVAO(this._quadVAO),t.drawArrays(j.PrimitiveType.TRIANGLE_STRIP,0,X.vertexCount(this._quadVAO,"geometry"))},l._ensureDebugPatternResources=function(e,r,t){if(g.set(this._passParameters.color,t[0],t[1],t[2]),this._passParameters.texture)return;const s=new Uint8Array(e*r*4);let i=0;for(let a=0;a<r;a++)for(let t=0;t<e;t++){const n=Math.floor(t/10),o=Math.floor(a/10);n<2||o<2||10*n>e-20||10*o>r-20?(s[i++]=255,s[i++]=255,s[i++]=255,s[i++]=255):(s[i++]=255,s[i++]=255,s[i++]=255,s[i++]=1&n&&1&o?1&t^1&a?0:255:1&n^1&o?0:128)}this._passParameters.texture=new Y.Texture(this._rctx,{target:j.TextureType.TEXTURE_2D,pixelFormat:j.PixelFormat.RGBA,dataType:j.PixelType.UNSIGNED_BYTE,samplingMode:j.TextureSamplingMode.NEAREST,width:e,height:r},s);const n=new N.TextureTechniqueConfiguration;n.hasAlpha=!0,this._debugTextureTechnique=this._shaderTechniqueRepository.acquire(L.TextureTechnique,n),this._quadVAO=C.createQuadVAO(this._rctx)},r._createClass(s,[{key:"_bindParameters",get:function(){return this._renderContext.bindParameters}},{key:"rctx",get:function(){return this._rctx}},{key:"materialRepository",get:function(){return this._materialRepository}},{key:"screenToWorldRatio",get:function(){return this._screenToWorldRatio}},{key:"localOriginFactory",get:function(){return this._localOriginFactory}},{key:"updating",get:function(){return this._sortedDrapeSourceRenderersDirty||a.someMap(this._renderers,(e=>e.updating))}},{key:"hasOverlays",get:function(){return o.isSome(this._overlays)&&o.isSome(this._overlayRenderTarget)}},{key:"gpuMemoryUsage",get:function(){return o.isSome(this._overlayRenderTarget)?this._overlayRenderTarget.gpuMemoryUsage:0}},{key:"overlays",get:function(){return o.unwrapOr(this._overlays,[])}},{key:"running",get:function(){return this.updating}},{key:"hasHighlights",get:function(){return this._hasHighlights}},{key:"hasWater",get:function(){return this._hasWater}},{key:"rendersOccluded",get:function(){return this._rendersOccluded}},{key:"test",get:function(){return{drapeSourceRenderers:this._renderers,getDrapeSourceRenderer:e=>this._renderers.get(e)}}}]),s}(P.AutoDisposableMixin(s)),t.__decorate([l.property()],e.OverlayRenderer.prototype,"_sortedDrapeSourceRenderersDirty",void 0),t.__decorate([P.autoDispose()],e.OverlayRenderer.prototype,"_shaderTechniqueRepository",void 0),t.__decorate([P.autoDispose()],e.OverlayRenderer.prototype,"_stippleTextureRepository",void 0),t.__decorate([l.property({constructOnly:!0})],e.OverlayRenderer.prototype,"view",void 0),t.__decorate([l.property()],e.OverlayRenderer.prototype,"worldToPCSRatio",void 0),t.__decorate([l.property()],e.OverlayRenderer.prototype,"spatialReference",void 0),t.__decorate([l.property({type:Boolean,readOnly:!0})],e.OverlayRenderer.prototype,"updating",null),e.OverlayRenderer=t.__decorate([_.subclass("esri.views.3d.terrain.OverlayRenderer")],e.OverlayRenderer),e.DrawPassOption=void 0,(Q=e.DrawPassOption||(e.DrawPassOption={}))[Q.Normal=0]="Normal",Q[Q.OccludedOnly=1]="OccludedOnly",Q[Q.ExcludeRasterImage=2]="ExcludeRasterImage";let Z=function(e,r,t){this.drapeSource=e,this.renderer=r,this.index=t};const J=[[1,.5,.5],[.5,.5,1]],K=new A.Camera;K.near=1,K.far=1e4,K.relativeElevation=null;const $=-2,ee=k.RenderOccludedFlag.OccludeAndTransparent;e.DRAPED_Z=$,e.overlayRenderOccludedFlag=ee,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
