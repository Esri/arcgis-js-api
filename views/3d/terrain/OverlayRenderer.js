/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/Evented","../../../core/Handles","../../../core/Logger","../../../core/MapUtils","../../../core/maybe","../../../core/PooledArray","../../../core/SetUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../../chunks/mat4","../../../chunks/vec2f64","../../../chunks/vec3f64","../../../chunks/mat4f64","../../ViewingMode","../layers/interfaces","../support/debugFlags","./interfaces","./Overlay","./OverlayFramebufferObject","./OverlayRenderTarget","../webgl-engine/core/shaderTechnique/ShaderTechniqueRepository","../webgl-engine/lib/AutoDisposable","../webgl-engine/lib/basicInterfaces","../webgl-engine/lib/Camera","../webgl-engine/lib/DrapedHeatmapRenderer","../webgl-engine/lib/GLMaterialRepository","../webgl-engine/lib/glUtil3D","../webgl-engine/lib/GridLocalOriginFactory","../webgl-engine/lib/Intersector","../webgl-engine/lib/IntersectorInterfaces","../webgl-engine/lib/Material","../webgl-engine/lib/ModelDirtyTypes","../webgl-engine/lib/RenderContext","../webgl-engine/lib/RenderPass","../webgl-engine/lib/RenderSlot","../webgl-engine/lib/SortedRenderGeometryRenderer","../webgl-engine/lib/TextureTechnique","../webgl-engine/lighting/Lightsources","../webgl-engine/lighting/SceneLighting","../webgl-engine/materials/StippleTextureRepository","../../../chunks/Compositing.glsl","../webgl-engine/shaders/CompositingTechnique","../../support/Scheduler","../../webgl/enums","../../webgl/Texture","../../webgl/Util"],(function(e,r,t,i,s,n,a,o,d,l,h,c,u,y,p,g,_,m,R,T,f,b,v,O,w,x,S,D,P,L,E,A,M,C,G,I,V,F,U,k,N,H,q,B,W,z,Y,j,X,Q,Z,J,K,$){"use strict";const ee=a.getLogger("esri.views.3d.webgl-engine.lib.OverlayRenderer");var re;e.OverlayRenderer=function(t){function i(e){var r;return(r=t.call(this,e)||this)._overlays=null,r._overlayRenderTarget=null,r._hasHighlights=!1,r._rendersOccluded=!1,r._hasWater=!1,r._lighting=new Y.SceneLighting,r._handles=new n,r._frameTask=Z.ImmediateTask,r._layerRenderers=new Map,r._sortedLayerRenderersDirty=!1,r._sortedLayerRenderers=new l,r._geometries=new Map,r.worldToPCSRatio=1,r.events=new s,r.longitudeCyclical=null,r}r._inheritsLoose(i,t);var a=i.prototype;return a.initialize=function(){const e=this.view._stage.renderView;this._rctx=e.renderingContext,this._renderContext=new N.OverlayRenderContext(this._rctx);const r=e.waterTextureRepository;this._stippleTextureRepository=new j.StippleTextureRepository(e.renderingContext),this._shaderTechniqueRepository=new P.ShaderTechniqueRepository({rctx:this._rctx,viewingMode:b.ViewingMode.Local,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:r}),this._handles.add([c.init(r,"loadingState",(()=>this.events.emit("content-changed"))),c.init(this,"spatialReference",(e=>this._localOrigins=new I.GridLocalOriginFactory(e)))]),this._materialRepository=new C.GLMaterialRepository(e.textureRepository,this._shaderTechniqueRepository,(e=>{(e.renderOccluded&le)>0!==this._rendersOccluded&&this._updateRendersOccluded(),this.events.emit("content-changed"),this.notifyChange("updating")}),(()=>this.events.emit("content-changed"))),this._lighting.groundLightingFactor=1,this._lighting.globalFactor=0,this._lighting.set([new z.AmbientLight(T.fromValues(1,1,1))]),this._bindParameters={slot:q.RenderSlot.DRAPED_MATERIAL,highlightDepthTexture:G.createEmptyDepthTexture(this._rctx),camera:ne,inverseViewport:R.create(),origin:null,screenToWorldRatio:null,screenToPCSRatio:null,shadowMappingEnabled:!1,slicePlane:null,ssaoEnabled:!1,hasOccludees:!1,linearDepthTexture:null,lastFrameColorTexture:null,reprojectionMatrix:f.IDENTITY,ssrEnabled:!1,lighting:this._lighting,transparencyPassType:E.TransparencyPassType.NONE,terrainLinearDepthTexture:null,geometryLinearDepthTexture:null,multipassTerrainEnabled:!1,cullAboveGround:!1,multipassGeometryEnabled:!1,highlightColorTexture:null,cloudsCompositionParams:null,hasFillLights:!0},this._frameTask=this.view.resourceController.scheduler.registerTask(Z.TaskPriority.STAGE,this),this._handles.add(this._frameTask)},a.dispose=function(){this._handles.destroy(),this._layerRenderers.forEach((e=>e.destroy())),this._layerRenderers.clear(),this._debugTextureTechnique=d.releaseMaybe(this._debugTextureTechnique),this._debugPatternTexture=d.disposeMaybe(this._debugPatternTexture),this._bindParameters.highlightDepthTexture=d.disposeMaybe(this._bindParameters.highlightDepthTexture),this._shaderTechniqueRepository=d.disposeMaybe(this._shaderTechniqueRepository),this._temporaryFBO=d.disposeMaybe(this._temporaryFBO),this._quadVAO=d.disposeMaybe(this._quadVAO),this.disposeOverlays()},a.collectUnusedRenderTargetMemory=function(e){let r=!1;if(d.isSome(this._overlayRenderTarget))for(const t of this._overlayRenderTarget.renderTargets){const i=this.overlays[0].validTargets[t.type]||!this.overlays[1].validTargets[t.type];r=this._overlayRenderTarget.validateUsageForTarget(i,t,e)||r}return r},a.ensureDrapeTargets=function(e){d.isSome(this._overlays)&&this._overlays.forEach((r=>{r.hasTargetWithoutRasterImage=h.someSet(e,(e=>e.drapeTargetType===v.DrapeTargetType.WithoutRasterImage))}))},a.ensureDrapeSources=function(e){d.isSome(this._overlays)&&this._overlays.forEach((r=>{r.hasDrapedFeatureSource=o.someMap(e,((e,r)=>r.drapeSourceType===v.DrapeSourceType.Features)),r.hasDrapedRasterSource=o.someMap(e,((e,r)=>r.drapeSourceType===v.DrapeSourceType.RasterImage))}))},a.ensureOverlays=function(e,r){d.isNone(this._overlays)&&(this._overlayRenderTarget=new D.OverlayRenderTarget(this._rctx),this._overlays=[new x.Overlay(w.OverlayIndex.INNER,this._overlayRenderTarget),new x.Overlay(w.OverlayIndex.OUTER,this._overlayRenderTarget)]),this.ensureDrapeTargets(e),this.ensureDrapeSources(r)},a.disposeOverlays=function(){this._overlays=null,this._overlayRenderTarget=d.disposeMaybe(this._overlayRenderTarget),this.events.emit("textures-disposed")},a.runTask=function(e,r=(()=>!0)){this._frameTask.processQueue(e),e.done||this._processLayers(e,r)},a._processLayers=function(e,r){let t=!1;for(const[i,s]of this._layerRenderers){if(e.done)break;(i.destroyed||r(i))&&(s.commitChanges()&&(t=!0,e.madeProgress()),s.isEmpty&&(t=!0,this._sortedLayerRenderersDirty=!0,this._layerRenderers.delete(i),this._handles.remove(i),s.destroy()))}this._updateSortedLayerRenderers(),t&&(d.isSome(this._overlays)&&0===this._layerRenderers.size&&this.disposeOverlays(),this.notifyChange("updating"),this.events.emit("content-changed"),this._updateHasHighlights(),this._updateRendersOccluded(),this._updateHasWater())},a.processSyncLayers=function(){this._processLayers(Z.noBudget,(e=>e.updatePolicy===E.UpdatePolicy.SYNC))},a.addGeometries=function(e,r,t,i=!1){for(const s of e)d.isNone(s.origin)&&(s.origin=this._localOrigins.getOrigin(s.boundingSphere)),this._geometries.set(s.id,s);this._ensureLayerRenderer(r,i).add(e),t===k.ModelDirty.Geometry.UPDATE&&this._notifyGraphicGeometryChanged(e,r)},a.removeGeometries=function(e,r,t){for(const s of e)this._geometries.delete(d.unwrap(s.id));const i=this._layerRenderers.get(r);i&&(i.remove(e),t===k.ModelDirty.Geometry.UPDATE&&this._notifyGraphicGeometryChanged(e,r))},a.updateGeometries=function(e,r,t){const i=this._layerRenderers.get(r);if(i)switch(i.modify(e,t),t){case k.ModelDirty.State.TRANSFORMATION:case k.ModelDirty.State.VERTEXATTRS:return this._notifyGraphicGeometryChanged(e,r);case k.ModelDirty.State.VISIBILITIES:return this._notifyGraphicVisibilityChanged(e,r)}else ee.warn("Attempted to update geometry for nonexistent layer")},a._notifyGraphicGeometryChanged=function(e,r){if(d.isNone(r.notifyGraphicGeometryChanged))return;let t;for(const i of e){const e=i.graphicUid;d.isSome(e)&&e!==t&&(r.notifyGraphicGeometryChanged(e),t=e)}},a._notifyGraphicVisibilityChanged=function(e,r){if(d.isNone(r.notifyGraphicVisibilityChanged))return;let t;for(const i of e){const e=i.graphicUid;d.isSome(e)&&e!==t&&(r.notifyGraphicVisibilityChanged(e),t=e)}},a.updateHighlights=function(e,r){const t=this._layerRenderers.get(r);t?t.modify(e,k.ModelDirty.State.HIGHLIGHTS):ee.warn("Attempted to update highlights for nonexistent layer")},a.isEmpty=function(){return 0===this._geometries.size&&!O.OVERLAY_DRAW_DEBUG_TEXTURE},a.updateAnimation=function(e){let r=!1;return this._layerRenderers.forEach((t=>r=t.updateAnimation(e)||r)),r},a.updateLayerOrder=function(){this._sortedLayerRenderersDirty=!0},a.drawTarget=function(r,t,i){const s=r.canvasGeometries;if(0===s.numViews)return!1;this._screenToWorldRatio=i*r.mapUnitsPerPixel;const n=t.renderPass;if(this.isEmpty()||n===H.RenderPass.MATERIAL_HIGHLIGHT&&!this.hasHighlights||n===H.RenderPass.MATERIAL_NORMAL&&!this.hasWater||!r.hasSomeSizedView())return!1;const a=t.fbo;if(!a.isValid())return!1;const o=2*r.resolution,l=r.resolution;a.resize(o,l);const h=this._rctx;ne.pixelRatio=r.pixelRatio*i,this._renderContext.pass=n,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToPCSRatio=this._screenToWorldRatio*this.worldToPCSRatio,this._bindParameters.slot=n===H.RenderPass.MATERIAL_NORMAL?q.RenderSlot.DRAPED_WATER:q.RenderSlot.DRAPED_MATERIAL,r.applyViewport(this._rctx),a.bind(h),r.index===w.OverlayIndex.INNER&&(h.setClearColor(0,0,0,0),h.clearSafe(J.ClearBufferBit.COLOR_BUFFER_BIT));const c=t.type===w.RenderTargetType.ColorNoRasterImage?e.DrawPassOption.ExcludeRasterImage:t.type===w.RenderTargetType.Occluded?e.DrawPassOption.OccludedOnly:e.DrawPassOption.Normal;if(c===e.DrawPassOption.OccludedOnly&&(this._renderContext.renderOccludedMask=le),O.OVERLAY_DRAW_DEBUG_TEXTURE&&c!==e.DrawPassOption.OccludedOnly)for(let e=0;e<s.numViews;e++)this._setViewParameters(s.extents[e],r,ne),this._drawDebugTexture(r.resolution,ie[r.index]);return this._layerRenderers.size>0&&this._sortedLayerRenderers.forAll((({overlayLayer:t,renderer:i})=>{if(c===e.DrawPassOption.ExcludeRasterImage&&t.drapeSourceType===v.DrapeSourceType.RasterImage)return;const{fullOpacity:u}=t,y=d.isSome(u)&&u<1&&n===H.RenderPass.MATERIAL;y&&(this.bindTemporaryFramebuffer(this._rctx,o,l),h.clearSafe(J.ClearBufferBit.COLOR_BUFFER_BIT));for(let e=0;e<s.numViews;e++)this._setViewParameters(s.extents[e],r,ne),i.render(this._renderContext,this._bindParameters);y&&d.isSome(this._temporaryFBO)&&(a.bind(h),this.view._stage.renderView.compositingHelper.composite(this._temporaryFBO.getTexture(),Q.AlphaMode.PremultipliedAlpha,u,X.CompositingFunction.OverlayWithTransparency,r.index))})),h.bindFramebuffer(null),a.generateMipMap(),this._renderContext.resetRenderOccludedMask(),!0},a.bindTemporaryFramebuffer=function(e,r,t){d.isNone(this._temporaryFBO)&&(this._temporaryFBO=new S.OverlayFramebufferObject(e,!1)),this._temporaryFBO.resize(r,t),this._temporaryFBO.bind(e)},a.reloadShaders=function(){var e=r._asyncToGenerator((function*(){yield this._shaderTechniqueRepository.reloadAll()}));function t(){return e.apply(this,arguments)}return t}(),a.intersect=function(e,r,t,i){let s=0;this._geometries.forEach((n=>{if(i&&!i(n))return;this._intersectRenderGeometry(n,t,r,0,e,s);const a=this.longitudeCyclical;a&&(n.boundingSphere[0]-n.boundingSphere[3]<a.min&&this._intersectRenderGeometry(n,t,r,a.range,e,s),n.boundingSphere[0]+n.boundingSphere[3]>a.max&&this._intersectRenderGeometry(n,t,r,-a.range,e,s)),s++}))},a._intersectRenderGeometry=function(e,r,t,i,s,n){if(!e.instanceParameters.visible)return;let a=0;d.isSome(e.transformation)&&(i+=e.transformation[12],a=e.transformation[13]),ae[0]=t[0]-i,ae[1]=t[1]-a,ae[2]=1,oe[0]=t[0]-i,oe[1]=t[1]-a,oe[2]=0,e.screenToWorldRatio=this._screenToWorldRatio,e.material.intersect(e,null,e.getShaderTransformation(),s,ae,oe,((t,i,a)=>{se(r,a,e.material.renderPriority,n,s,e.layerUid,e.graphicUid)}),e.calculateShaderTransformation,r)},a._ensureLayerRenderer=function(e,r){let t=this._layerRenderers.get(e);return t&&r===t instanceof M.DrapedHeatmapRenderer||(t=r?new M.DrapedHeatmapRenderer({rctx:this._rctx,materialRepository:this._materialRepository}):new B.SortedRenderGeometryRenderer({rctx:this._rctx,materialRepository:this._materialRepository}),this._layerRenderers.set(e,t),this._sortedLayerRenderersDirty=!0,"fullOpacity"in e&&this._handles.add(e.watch("fullOpacity",(()=>this.events.emit("content-changed"))),e),this._handles.add(c.init(t,"updating",(()=>this.notifyChange("updating"))),e)),t},a._updateSortedLayerRenderers=function(){if(!this._sortedLayerRenderersDirty)return;if(this._sortedLayerRenderersDirty=!1,this._sortedLayerRenderers.clear(),0===this._layerRenderers.size)return;const e=this.view.map.allLayers;this._layerRenderers.forEach(((r,t)=>{const i=e.indexOf(t.layer);this._sortedLayerRenderers.push(new te(t,r,i<0?1/0:i))})),this._sortedLayerRenderers.sort(((e,r)=>e.index-r.index))},a._setViewParameters=function(e,r,t){t.viewport[0]=t.viewport[1]=0,t.viewport[2]=t.viewport[3]=r.resolution,m.ortho(t.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],t.near,t.far),m.fromTranslation(t.viewMatrix,[-e[0],-e[1],0]),this._renderContext.camera=t,this._bindParameters.camera=t,this._bindParameters.inverseViewport[0]=1/t.fullViewport[2],this._bindParameters.inverseViewport[1]=1/t.fullViewport[3]},a._updateHasWater=function(){const e=o.someMap(this._layerRenderers,(e=>e.hasWater));e!==this._hasWater&&(this._hasWater=e,this.events.emit("has-water",e))},a._updateHasHighlights=function(){const e=o.someMap(this._layerRenderers,(e=>e.hasHighlights));e!==this._hasHighlights&&(this._hasHighlights=e,this.events.emit("has-highlights",e))},a._updateRendersOccluded=function(){const e=o.someMap(this._layerRenderers,(e=>e.rendersOccluded));e!==this._rendersOccluded&&(this._rendersOccluded=e,this.events.emit("renders-occluded",e))},a._drawDebugTexture=function(e,r){this._ensureDebugPatternResources(e,e);const t=this._rctx,i=t.useTechnique(this._debugTextureTechnique);i.setUniform4f("uColor",r[0],r[1],r[2],1),i.bindTexture(this._debugPatternTexture,"tex"),t.bindVAO(this._quadVAO),t.drawArrays(J.PrimitiveType.TRIANGLE_STRIP,0,$.vertexCount(this._quadVAO,"geometry"))},a._ensureDebugPatternResources=function(e,r){if(this._debugPatternTexture)return;const t=new Uint8Array(e*r*4);let i=0;for(let n=0;n<r;n++)for(let s=0;s<e;s++){const a=Math.floor(s/10),o=Math.floor(n/10);a<2||o<2||10*a>e-20||10*o>r-20?(t[i++]=255,t[i++]=255,t[i++]=255,t[i++]=255):(t[i++]=255,t[i++]=255,t[i++]=255,t[i++]=1&a&&1&o?1&s^1&n?0:255:1&a^1&o?0:128)}this._debugPatternTexture=new K.Texture(this._rctx,{target:J.TextureType.TEXTURE_2D,pixelFormat:J.PixelFormat.RGBA,dataType:J.PixelType.UNSIGNED_BYTE,samplingMode:J.TextureSamplingMode.NEAREST,width:e,height:r},t);const s=new W.TextureTechniqueConfiguration;s.hasAlpha=!0,this._debugTextureTechnique=this._shaderTechniqueRepository.acquire(W.TextureTechnique,s),this._quadVAO=G.createQuadVAO(this._rctx)},r._createClass(i,[{key:"updating",get:function(){return this._sortedLayerRenderersDirty||this._frameTask.updating||o.someMap(this._layerRenderers,(e=>e.updating))}},{key:"hasOverlays",get:function(){return d.isSome(this._overlays)&&d.isSome(this._overlayRenderTarget)}},{key:"gpuMemoryUsage",get:function(){return d.isSome(this._overlayRenderTarget)?this._overlayRenderTarget.gpuMemoryUsage:0}},{key:"overlays",get:function(){return d.unwrapOr(this._overlays,[])}},{key:"running",get:function(){return this.updating}},{key:"hasHighlights",get:function(){return this._hasHighlights}},{key:"hasWater",get:function(){return this._hasWater}},{key:"rendersOccluded",get:function(){return this._rendersOccluded}},{key:"test",get:function(){return{layerRenderers:this._layerRenderers}}}]),i}(L.AutoDisposableMixin(i)),t.__decorate([u.property()],e.OverlayRenderer.prototype,"_frameTask",void 0),t.__decorate([u.property()],e.OverlayRenderer.prototype,"_sortedLayerRenderersDirty",void 0),t.__decorate([L.autoDispose()],e.OverlayRenderer.prototype,"_shaderTechniqueRepository",void 0),t.__decorate([L.autoDispose()],e.OverlayRenderer.prototype,"_stippleTextureRepository",void 0),t.__decorate([u.property({constructOnly:!0})],e.OverlayRenderer.prototype,"view",void 0),t.__decorate([u.property()],e.OverlayRenderer.prototype,"worldToPCSRatio",void 0),t.__decorate([u.property()],e.OverlayRenderer.prototype,"spatialReference",void 0),t.__decorate([u.property({type:Boolean,readOnly:!0})],e.OverlayRenderer.prototype,"updating",null),e.OverlayRenderer=t.__decorate([_.subclass("esri.views.3d.terrain.OverlayRenderer")],e.OverlayRenderer),e.DrawPassOption=void 0,(re=e.DrawPassOption||(e.DrawPassOption={}))[re.Normal=0]="Normal",re[re.OccludedOnly=1]="OccludedOnly",re[re.ExcludeRasterImage=2]="ExcludeRasterImage";let te=function(e,r,t){this.overlayLayer=e,this.renderer=r,this.index=t};const ie=[[1,.5,.5],[.5,.5,1]];function se(e,r,t,i,s,n,a){const o={layerUid:n,graphicUid:a,triangleNr:r},d=r=>{r.set(F.IntersectorType.OVERLAY,o,e.dist,e.normal,e.transformation,t,i)};if((null==s.results.min.drapedLayerOrder||t>=s.results.min.drapedLayerOrder)&&(null==s.results.min.dist||s.results.ground.dist<=s.results.min.dist)&&d(s.results.min),s.options.store!==F.StoreResults.MIN&&(null==s.results.max.drapedLayerOrder||t<s.results.max.drapedLayerOrder)&&(null==s.results.max.dist||s.results.ground.dist>s.results.max.dist)&&d(s.results.max),s.options.store===F.StoreResults.ALL){const e=V.newIntersectorResult(s.ray);d(e),s.results.all.push(e)}}const ne=new A.default;ne.near=1,ne.far=1e4,ne.relativeElevation=null;const ae=T.create(),oe=T.create(),de=-2,le=U.RenderOccludedFlag.OccludeAndTransparent;e.DRAPED_Z=de,e.overlayRenderOccludedFlag=le,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
