/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/has","../../../core/maybe","../../../core/Logger","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass","../../../core/urlUtils","../../../core/uuid","../../../portal/support/resourceExtension","../../../core/PooledArray","../../../core/Accessor","../../../core/uid","../../../chunks/vec3f64","../../../core/Handles","../../../core/watchUtils","../../../chunks/mat4","../../support/Scheduler","../../../core/MapUtils","../../../chunks/vec2f64","../../webgl/Texture","../../webgl/Util","../webgl-engine/lib/glUtil3D","../webgl-engine/lighting/Lightsources","../webgl-engine/lib/intersectorUtils","../webgl-engine/lib/Camera","../support/debugFlags","../webgl-engine/lib/AutoDisposable","./OverlayRenderTarget","./Overlay","../webgl-engine/core/shaderTechnique/CommonUniformStore","../webgl-engine/core/shaderTechnique/ShaderTechniqueRepository","../webgl-engine/lib/GLMaterialRep","../webgl-engine/lib/GridLocalOriginFactory","../webgl-engine/lib/RenderContext","../webgl-engine/lib/SortedRenderGeometryRenderer","../webgl-engine/lib/TextureTechnique","../webgl-engine/lighting/SceneLighting","../webgl-engine/materials/lineStippleUtils"],(function(e,t,r,i,s,n,o,a,l,d,h,u,c,g,p,y,_,m,f,R,w,b,x,T,v,O,C,S,L,V,G,M,D,U,A,E,P,q,H,W,k){"use strict";const F=n.getLogger("esri.views.3d.webgl-engine.lib.OverlayRenderer");e.OverlayRenderer=function(e){function r(t){var r;return(r=e.call(this,t)||this)._overlays=null,r._hasHighlights=!1,r._rendersOccluded=!1,r._hasWater=!1,r._lighting=new W.SceneLighting,r._localOrigins=new E,r._handles=new _,r._layerRenderers=new Map,r._sortedLayerRenderersDirty=!1,r._sortedLayerRenderers=new c,r._geometries=new Map,r.globalUnitScale=1,r.longitudeCyclical=null,r}t._inheritsLoose(r,e);var i=r.prototype;return i.initialize=function(){this._rctx=this.renderView.renderingContext,this._renderContext=new P(this._rctx,null,null,null,null,null),this._stippleTextureRepository=new k.StippleTextureRepository,this.waterTextureRepository=this.renderView.waterTextureRepository,this._shaderTechniqueRepository=new U.ShaderTechniqueRepository({rctx:this._rctx,viewingMode:2,commonUniformStore:new D.CommonUniformStore,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:this.waterTextureRepository}),m.init(this.waterTextureRepository,"loadingState",(()=>this.emitContentChanged())),this._materialRepository=new A(this.renderView.textureRepository,this._shaderTechniqueRepository),this._materialRepository.onMaterialChanged=e=>{(e.renderOccluded&X)>0!==this._rendersOccluded&&this.updateRendersOccluded(),this.emitContentChanged(),this.notifyChange("updating")},this._compositingHelper=this.renderView.compositingHelper,this._lighting.set({lights:[new O.AmbientLight(y.fromValues(1,1,1))],groundLightingFactor:1,globalFactor:0}),this._bindParameters={slot:null,highlightDepthTexture:v.createEmptyDepthTexture(this._rctx),camera:B,inverseViewport:b.create(),origin:null,screenToWorldRatio:null,screenToWorldRatioGlobalWM:null,shadowMappingEnabled:!1,slicePlane:null,ssaoEnabled:!1,hasOccludees:!1,linearDepthTexture:null,linearDepthTextureUnit:0,lastFrameColorTexture:null,lastFrameColorTextureUnit:0,reprojectionMat:null,ssrEnabled:!1,lighting:this._lighting,transparencyPassType:3,terrainLinearDepthTexture:null,geometryLinearDepthTexture:null,multipassTerrainEnabled:!1,cullAboveGround:!0,multipassGeometryEnabled:!1},this._handles.add(this.scheduler.registerTask(R.Task.STAGE,(()=>this.commitChanges()),(()=>this.updating)))},i.dispose=function(){this._handles.destroy(),this._layerRenderers.forEach((e=>e.dispose())),this._layerRenderers.clear(),this._bindParameters.highlightDepthTexture=s.disposeMaybe(this._bindParameters.highlightDepthTexture),this._shaderTechniqueRepository=s.disposeMaybe(this._shaderTechniqueRepository),this._temporaryRenderTarget=s.disposeMaybe(this._temporaryRenderTarget),this._debugPatternTexture=s.disposeMaybe(this._debugPatternTexture),this._quadVAO=s.disposeMaybe(this._quadVAO)},i.forEachOverlay=function(e){s.isSome(this._overlays)&&(e(this._overlays[0],0),e(this._overlays[1],1))},i.ensureOverlays=function(){if(s.isNone(this._overlays)){const e=this.renderView.renderingContext;this._overlays=[new M.Overlay(e),new M.Overlay(e)]}},i.disposeOverlays=function(){s.isSome(this._overlays)&&(this._overlays.forEach((e=>e.dispose())),this._overlays=null)},i.commitChanges=function(){let e=!1;this._layerRenderers.forEach(((t,r)=>{t.commitChanges()&&(e=!0),t.isEmpty&&(this._layerRenderers.delete(r),this._sortedLayerRenderersDirty=!0,this._handles.remove(r))})),this._sortedLayerRenderersDirty&&(this.updateSortedLayerRenderers(),e=!0),e&&(this.notifyChange("updating"),this.emitContentChanged(),this.updateHasHighlights(),this.updateRendersOccluded(),this.updateHasWater())},i.addGeometries=function(e,t,r){for(const i of e)null==i.origin&&(i.origin=this._localOrigins.getOrigin(i.boundingSphere)),s.isNone(i.id)&&(i.id=p.generateUID()),this._geometries.set(i.id,i);this.ensureLayerRenderer(t).add(e),2===r&&this.notifyGraphicGeometryChanged(e,t)},i.removeGeometries=function(e,t,r){for(const n of e)this._geometries.delete(s.unwrap(n.id));const i=this._layerRenderers.get(t);i&&(i.remove(e),2===r&&this.notifyGraphicGeometryChanged(e,t))},i.updateGeometries=function(e,t,r){const i=this._layerRenderers.get(t);if(i)switch(i.modify(e,r),r){case 4:case 2:return this.notifyGraphicGeometryChanged(e,t);case 1:return this.notifyGraphicVisibilityChanged(e,t)}else F.warn("Attempted to update geometry for nonexistent layer")},i.notifyGraphicGeometryChanged=function(e,t){if(s.isNone(t.notifyGraphicGeometryChanged))return;let r;for(const i of e){const e=i.graphicUid;e!==r&&(t.notifyGraphicGeometryChanged(e),r=e)}},i.notifyGraphicVisibilityChanged=function(e,t){if(s.isNone(t.notifyGraphicVisibilityChanged))return;let r;for(const i of e){const e=i.graphicUid;e!==r&&(t.notifyGraphicVisibilityChanged(e),r=e)}},i.updateHighlights=function(e,t){const r=this._layerRenderers.get(t);r?r.modify(e,8):F.warn("Attempted to update highlights for nonexistent layer")},i.isEmpty=function(){return 0===this._geometries.size&&!L.OVERLAY_DRAW_DEBUG_TEXTURE},i.updateLogic=function(e){let t=!1;return this._layerRenderers.forEach((r=>{r.updateLogic(e)&&(t=!0)})),t},i.updateLayerOrder=function(){this._sortedLayerRenderersDirty=!0},i.drawPass=function(e,t,r,i=0){if(0===r.numViews)return!1;if(this._screenToWorldRatio=r.pixelRatio*Math.abs(r.views[0].extent[2]-r.views[0].extent[0])/Math.abs(r.views[0].viewport[2]-r.views[0].viewport[0]),this.isEmpty()||5===e&&!this.hasHighlights||3===e&&!this.hasWater)return!1;if(!this.hasNonZeroSizedView(r))return!1;const n=r.width,o=r.height;if(!t.isValid())return!1;t.resize(n,o);const a=this._rctx;if(B.pixelRatio=r.pixelRatio||1,this._renderContext.pass=e,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToWorldRatioGlobalWM=this._screenToWorldRatio*this.globalUnitScale,t.bind(a),a.setClearColor(0,0,0,0),a.clearSafe(16384),1===i&&(this._renderContext.renderOccludedMask=X),L.OVERLAY_DRAW_DEBUG_TEXTURE&&1!==i)for(let s=0;s<r.numViews;s++)this.setViewParameters(r.views[s],B),this.drawDebugTexture(n,o,N[r.index%N.length]);return this._layerRenderers.size>0&&this._sortedLayerRenderers.forAll((({layerView:l,renderer:d})=>{if(2===i&&s.isSome(l)&&0===l.drapeSourceType)return;const h=s.isSome(l)&&s.isSome(l.fullOpacity)&&l.fullOpacity<1&&0===e;h&&(this.bindTemporaryFramebuffer(this._rctx,n,o),a.clearSafe(16384));for(let e=0;e<r.numViews;e++)this.setViewParameters(r.views[e],B),d.draw(this._renderContext,this._bindParameters);h&&s.isSome(this._temporaryRenderTarget)&&(t.bind(a),this._compositingHelper.composite(this._temporaryRenderTarget.getTexture(),2,s.unwrap(s.unwrap(l).fullOpacity)))})),a.bindFramebuffer(null),t.generateMipMap(),this._renderContext.resetRenderOccludedMask(),!0},i.bindTemporaryFramebuffer=function(e,t,r){s.isNone(this._temporaryRenderTarget)&&(this._temporaryRenderTarget=new G.OverlayRenderTarget(e,!1)),this._temporaryRenderTarget.resize(t,r),this._temporaryRenderTarget.bind(e)},i.reloadShaders=async function(){await this._shaderTechniqueRepository.hotReload()},i.intersect=function(e,t,r){let i=0;this._geometries.forEach((s=>{if(r&&!r(s))return;this.intersectRenderGeometry(s,t,0,e,i);const n=this.longitudeCyclical;n&&(s.boundingSphere[0]-s.boundingSphere[3]<n.min&&this.intersectRenderGeometry(s,t,n.range,e,i),s.boundingSphere[0]+s.boundingSphere[3]>n.max&&this.intersectRenderGeometry(s,t,-n.range,e,i)),i++}))},i.intersectRenderGeometry=function(e,t,r,i,n){if(!e.instanceParameters.visible)return;let o=0;s.isSome(e.transformation)&&(r+=e.transformation[12],o=e.transformation[13]),I[0]=t[0]-r,I[1]=t[1]-o,I[2]=1,j[0]=t[0]-r,j[1]=t[1]-o,j[2]=0,e.screenToWorldRatio=this._screenToWorldRatio,e.material.intersect(e,null,e.getShaderTransformation(),i,I,j,((t,r,s)=>{this.addIntersectionResult(s,e.material.renderPriority,n,i,e.layerUid,e.graphicUid)}),e.calculateShaderTransformation,!0)},i.addIntersectionResult=function(e,t,r,i,s,n){const o={type:"external",metadata:{layerUid:s,graphicUid:n}},a=s=>{s.set(o,null,i.results.ground.dist,i.results.ground.normal,i.results.ground.transformation,t,null,null,e,r),s.intersector="OverlayRenderer"};if((null==i.results.min.drapedLayerOrder||t>=i.results.min.drapedLayerOrder)&&(null==i.results.min.dist||i.results.ground.dist<=i.results.min.dist)&&a(i.results.min),0!==i.options.store&&(null==i.results.max.drapedLayerOrder||t<i.results.max.drapedLayerOrder)&&(null==i.results.max.dist||i.results.ground.dist>i.results.max.dist)&&a(i.results.max),2===i.options.store){const e=new C.IntersectorResult(i.ray);a(e),i.results.all.push(e)}},i.stopAnimationsAtTime=function(e){this._sortedLayerRenderers.forAll((t=>t.renderer.stopAnimationsAtTime(e)))},i.ensureLayerRenderer=function(e){let t=this._layerRenderers.get(e);return t||(t=new q.SortedRenderGeometryRenderer({rctx:this._rctx,materialRepository:this._materialRepository}),this._layerRenderers.set(e,t),this._sortedLayerRenderersDirty=!0,"fullOpacity"in e&&this._handles.add(e.watch("fullOpacity",(()=>this.emitContentChanged())),e),this._handles.add(m.init(t,"updating",(()=>this.notifyChange("updating"))),e)),t},i.updateSortedLayerRenderers=function(){if(!this._sortedLayerRenderersDirty)return;if(this._sortedLayerRenderersDirty=!1,this._sortedLayerRenderers.clear(),0===this._layerRenderers.size)return;const[{view:{allLayerViews:e}}]=this._layerRenderers.keys(),t=new Set(this._layerRenderers.values());e.forEach((e=>{const r=e,i=this._layerRenderers.get(r);i&&(this._sortedLayerRenderers.push(new z(r,i)),t.delete(i))})),t.forEach((e=>{this._sortedLayerRenderers.push(new z(null,e))}))},i.setViewParameters=function(e,t){t.viewport=e.viewport;const r=e.extent;f.ortho(t.projectionMatrix,0,r[2]-r[0],0,r[3]-r[1],t.near,t.far),f.identity(t.viewMatrix),f.translate(t.viewMatrix,t.viewMatrix,[-e.extent[0],-e.extent[1],0]),t.setGLViewport(this._rctx),this._renderContext.camera=t,this._bindParameters.camera=t,this._bindParameters.inverseViewport[0]=1/t.fullViewport[2],this._bindParameters.inverseViewport[1]=1/t.fullViewport[3]},i.hasNonZeroSizedView=function(e){for(let t=0;t<e.numViews;t++){const r=e.views[t];if(r.extent[0]!==r.extent[2]&&r.extent[1]!==r.extent[3])return!0}return!1},i.emitContentChanged=function(){this.onContentChanged&&this.onContentChanged()},i.updateHasWater=function(){const e=w.someMap(this._layerRenderers,(e=>e.hasWater));e!==this._hasWater&&(this._hasWater=e)},i.updateHasHighlights=function(){const e=w.someMap(this._layerRenderers,(e=>e.hasHighlights));e!==this._hasHighlights&&(this._hasHighlights=e,this.onHasHighlightsChanged&&this.onHasHighlightsChanged(this._hasHighlights))},i.updateRendersOccluded=function(){const e=w.someMap(this._layerRenderers,(e=>e.rendersOccluded));e!==this._rendersOccluded&&(this._rendersOccluded=e,this.onRendersOccludedChanged&&this.onRendersOccludedChanged(this.rendersOccluded))},i.drawDebugTexture=function(e,t,r){const i=this._rctx;this.ensureDebugPatternResources(e,t);const s=this._debugTextureTechnique.program;i.bindProgram(s),i.setPipelineState(this._debugTextureTechnique.pipeline),s.setUniform4f("color",r[0],r[1],r[2],1),s.setUniform1i("tex",0),i.bindTexture(this._debugPatternTexture,0),i.bindVAO(this._quadVAO),i.drawArrays(5,0,T.vertexCount(this._quadVAO,"geometry"))},i.ensureDebugPatternResources=function(e,t){if(this._debugPatternTexture)return;const r=new Uint8Array(e*t*4);let i=0;for(let n=0;n<t;n++)for(let s=0;s<e;s++){const o=Math.floor(s/10),a=Math.floor(n/10);o<2||a<2||10*o>e-20||10*a>t-20?(r[i++]=255,r[i++]=255,r[i++]=255,r[i++]=255):(r[i++]=255,r[i++]=255,r[i++]=255,r[i++]=1&o&&1&a?1&s^1&n?0:255:1&o^1&a?0:128)}this._debugPatternTexture=new x(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:e,height:t},r);const s=new H.TextureTechniqueConfiguration;s.hasAlpha=!0,this._debugTextureTechnique=this._shaderTechniqueRepository.acquireAndReleaseExisting(H.TextureTechnique,s,this._debugTextureTechnique),this._quadVAO=v.createQuadVAO(this._rctx)},t._createClass(r,[{key:"updating",get:function(){return this._sortedLayerRenderersDirty||w.someMap(this._layerRenderers,(e=>e.updating))||this.waterTextureRepository.updating}},{key:"hasOverlays",get:function(){return s.isSome(this._overlays)}},{key:"gpuMemoryUsage",get:function(){return s.isSome(this._overlays)?this._overlays[0].getGpuMemoryUsage()+this._overlays[1].getGpuMemoryUsage():0}},{key:"overlays",get:function(){return this._overlays}},{key:"hasHighlights",get:function(){return this._hasHighlights}},{key:"hasWater",get:function(){return this._hasWater}},{key:"rendersOccluded",get:function(){return this._rendersOccluded}},{key:"test",get:function(){return{layerRenderers:this._layerRenderers}}}]),r}(V.AutoDisposableMixin(g)),r.__decorate([V.autoDispose()],e.OverlayRenderer.prototype,"_shaderTechniqueRepository",void 0),r.__decorate([V.autoDispose()],e.OverlayRenderer.prototype,"_stippleTextureRepository",void 0),r.__decorate([a.property(),V.autoDispose()],e.OverlayRenderer.prototype,"waterTextureRepository",void 0),r.__decorate([a.property({constructOnly:!0})],e.OverlayRenderer.prototype,"renderView",void 0),r.__decorate([a.property({constructOnly:!0})],e.OverlayRenderer.prototype,"scheduler",void 0),r.__decorate([a.property()],e.OverlayRenderer.prototype,"globalUnitScale",void 0),r.__decorate([a.property({type:Boolean,readOnly:!0})],e.OverlayRenderer.prototype,"updating",null),e.OverlayRenderer=r.__decorate([l.subclass("esri.views.3d.terrain.OverlayRenderer")],e.OverlayRenderer);let z=function(e,t){this.layerView=e,this.renderer=t};const N=[[1,.5,.5],[.5,.5,1],[.5,1,.5]],B=new S;B.near=1,B.far=1e4,B.relativeElevation=null;const I=y.create(),j=y.create(),Z=-2,X=4;e.DRAPED_Z=Z,e.overlayRenderOccludedFlag=X,Object.defineProperty(e,"__esModule",{value:!0})}));
