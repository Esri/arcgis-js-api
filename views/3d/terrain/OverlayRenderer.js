/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/Evented","../../../core/Handles","../../../core/Logger","../../../core/MapUtils","../../../core/maybe","../../../core/PooledArray","../../../core/SetUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../../chunks/mat4","../../../chunks/vec2f64","../../../chunks/vec3f64","../support/debugFlags","./Overlay","./OverlayFramebufferObject","./OverlayRenderTarget","../webgl-engine/core/shaderTechnique/ShaderTechniqueRepository","../webgl-engine/lib/AutoDisposable","../webgl-engine/lib/Camera","../webgl-engine/lib/GLMaterialRep","../webgl-engine/lib/glUtil3D","../webgl-engine/lib/GridLocalOriginFactory","../webgl-engine/lib/intersectorUtils","../webgl-engine/lib/RenderContext","../webgl-engine/lib/SortedRenderGeometryRenderer","../webgl-engine/lib/TextureTechnique","../webgl-engine/lighting/Lightsources","../webgl-engine/lighting/SceneLighting","../webgl-engine/materials/StippleTextureRepository","../../support/Scheduler","../../webgl/Texture","../../webgl/Util"],(function(e,r,t,i,s,n,a,o,d,l,h,u,c,y,p,g,_,m,f,R,T,v,b,w,x,O,S,C,L,P,M,D,G,V,E,A,q,F,U){"use strict";const k=a.getLogger("esri.views.3d.webgl-engine.lib.OverlayRenderer");e.OverlayRenderer=function(e){function t(r){var t;return(t=e.call(this,r)||this)._overlays=null,t._overlayRenderTarget=null,t._hasHighlights=!1,t._rendersOccluded=!1,t._hasWater=!1,t._lighting=new E.SceneLighting,t._handles=new n,t._layerRenderers=new Map,t._sortedLayerRenderersDirty=!1,t._sortedLayerRenderers=new l,t._geometries=new Map,t.worldToPCSRatio=1,t.events=new s,t.longitudeCyclical=null,t}r._inheritsLoose(t,e);var i=t.prototype;return i.initialize=function(){const e=this.view._stage.renderView;this._rctx=e.renderingContext,this._renderContext=new M.OverlayRenderContext(this._rctx);const r=e.waterTextureRepository;this._stippleTextureRepository=new A.StippleTextureRepository(e.renderingContext),this._shaderTechniqueRepository=new w.ShaderTechniqueRepository({rctx:this._rctx,viewingMode:2,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:r}),this._handles.add([u.init(r,"loadingState",(()=>this.events.emit("content-changed"))),u.init(this,"spatialReference",(e=>this._localOrigins=new L.GridLocalOriginFactory(e)))]),this._materialRepository=new S(e.textureRepository,this._shaderTechniqueRepository),this._materialRepository.onMaterialChanged=e=>{(e.renderOccluded&I)>0!==this._rendersOccluded&&this.updateRendersOccluded(),this.events.emit("content-changed"),this.notifyChange("updating")},this._lighting.groundLightingFactor=1,this._lighting.globalFactor=0,this._lighting.set([new V.AmbientLight(f.fromValues(1,1,1))]),this._bindParameters={slot:23,highlightDepthTexture:C.createEmptyDepthTexture(this._rctx),camera:B,inverseViewport:m.create(),origin:null,screenToWorldRatio:null,screenToPCSRatio:null,shadowMappingEnabled:!1,slicePlane:null,ssaoEnabled:!1,hasOccludees:!1,linearDepthTexture:null,lastFrameColorTexture:null,reprojectionMat:null,ssrEnabled:!1,lighting:this._lighting,transparencyPassType:3,terrainLinearDepthTexture:null,geometryLinearDepthTexture:null,multipassTerrainEnabled:!1,cullAboveGround:!1,multipassGeometryEnabled:!1,highlightColorTexture:null},this._handles.add(this.view.resourceController.scheduler.registerTask(q.TaskPriority.STAGE,this))},i.dispose=function(){this._handles.destroy(),this._layerRenderers.forEach((e=>e.dispose())),this._layerRenderers.clear(),this._debugTextureTechnique=d.releaseMaybe(this._debugTextureTechnique),this._debugPatternTexture=d.disposeMaybe(this._debugPatternTexture),this._bindParameters.highlightDepthTexture=d.disposeMaybe(this._bindParameters.highlightDepthTexture),this._shaderTechniqueRepository=d.disposeMaybe(this._shaderTechniqueRepository),this._temporaryFBO=d.disposeMaybe(this._temporaryFBO),this._quadVAO=d.disposeMaybe(this._quadVAO),this.disposeOverlays()},i.collectUnusedRenderTargetMemory=function(e){let r=!1;if(d.isSome(this._overlayRenderTarget))for(const t of this._overlayRenderTarget.renderTargets){const i=this.overlays[0].validTargets[t.type]||!this.overlays[1].validTargets[t.type];r=this._overlayRenderTarget.validateUsageForTarget(i,t,e)||r}return r},i.ensureDrapeTargets=function(e){d.isSome(this._overlays)&&this._overlays.forEach((r=>{r.hasTargetWithoutRasterImage=h.someSet(e,(e=>1===e.drapeTargetType))}))},i.ensureDrapeSources=function(e){d.isSome(this._overlays)&&this._overlays.forEach((r=>{r.hasDrapedFeatureSource=o.someMap(e,((e,r)=>1===r.drapeSourceType)),r.hasDrapedRasterSource=o.someMap(e,((e,r)=>0===r.drapeSourceType))}))},i.ensureOverlays=function(e,r){d.isNone(this._overlays)&&(this._overlayRenderTarget=new b.OverlayRenderTarget(this._rctx),this._overlays=[new T.Overlay(0,this._overlayRenderTarget),new T.Overlay(1,this._overlayRenderTarget)]),this.ensureDrapeTargets(e),this.ensureDrapeSources(r)},i.disposeOverlays=function(){this._overlays=null,this._overlayRenderTarget=d.disposeMaybe(this._overlayRenderTarget),this.events.emit("textures-disposed")},i.runTask=function(e,r=(()=>!0)){let t=!1;for(const[i,s]of this._layerRenderers){if(e.done)break;r(i)&&(s.commitChanges()&&(t=!0,e.madeProgress()),s.isEmpty&&(this._sortedLayerRenderersDirty=!0,this._layerRenderers.delete(i),this._handles.remove(i)))}this._sortedLayerRenderersDirty&&(this.updateSortedLayerRenderers(),t=!0),t&&(d.isSome(this._overlays)&&0===this._layerRenderers.size&&this.disposeOverlays(),this.notifyChange("updating"),this.events.emit("content-changed"),this.updateHasHighlights(),this.updateRendersOccluded(),this.updateHasWater())},i.processSyncLayers=function(){this.runTask(q.noBudget,(e=>1===e.updatePolicy))},i.addGeometries=function(e,r,t){for(const i of e)d.isNone(i.origin)&&(i.origin=this._localOrigins.getOrigin(i.boundingSphere)),this._geometries.set(i.id,i);this.ensureLayerRenderer(r).add(e),2===t&&this.notifyGraphicGeometryChanged(e,r)},i.removeGeometries=function(e,r,t){for(const s of e)this._geometries.delete(d.unwrap(s.id));const i=this._layerRenderers.get(r);i&&(i.remove(e),2===t&&this.notifyGraphicGeometryChanged(e,r))},i.updateGeometries=function(e,r,t){const i=this._layerRenderers.get(r);if(i)switch(i.modify(e,t),t){case 4:case 2:return this.notifyGraphicGeometryChanged(e,r);case 1:return this.notifyGraphicVisibilityChanged(e,r)}else k.warn("Attempted to update geometry for nonexistent layer")},i.notifyGraphicGeometryChanged=function(e,r){if(d.isNone(r.notifyGraphicGeometryChanged))return;let t;for(const i of e){const e=i.graphicUid;d.isSome(e)&&e!==t&&(r.notifyGraphicGeometryChanged(e),t=e)}},i.notifyGraphicVisibilityChanged=function(e,r){if(d.isNone(r.notifyGraphicVisibilityChanged))return;let t;for(const i of e){const e=i.graphicUid;d.isSome(e)&&e!==t&&(r.notifyGraphicVisibilityChanged(e),t=e)}},i.updateHighlights=function(e,r){const t=this._layerRenderers.get(r);t?t.modify(e,8):k.warn("Attempted to update highlights for nonexistent layer")},i.isEmpty=function(){return 0===this._geometries.size&&!R.OVERLAY_DRAW_DEBUG_TEXTURE},i.updateLogic=function(e){let r=!1;return this._layerRenderers.forEach((t=>r=t.updateLogic(e)||r)),r},i.updateLayerOrder=function(){this._sortedLayerRenderersDirty=!0},i.drawTarget=function(e,r,t){const i=e.canvasGeometries;if(0===i.numViews)return!1;const s=e.pixelRatio*t;this._screenToWorldRatio=s*Math.abs(i.extents[0][2]-i.extents[0][0])/e.resolution;const n=r.renderPass;if(this.isEmpty()||5===n&&!this.hasHighlights||3===n&&!this.hasWater)return!1;if(!e.hasSomeSizedView())return!1;const a=r.fbo,o=2*e.resolution,l=e.resolution,h=1===r.type?2:4===r.type?1:0;if(!a.isValid())return!1;a.resize(o,l);const u=this._rctx;if(B.pixelRatio=s||1,this._renderContext.pass=n,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToPCSRatio=this._screenToWorldRatio*this.worldToPCSRatio,this._bindParameters.slot=3===n?24:23,e.applyViewport(this._rctx),a.bind(u),0===e.index&&(u.setClearColor(0,0,0,0),u.clearSafe(16384)),1===h&&(this._renderContext.renderOccludedMask=I),R.OVERLAY_DRAW_DEBUG_TEXTURE&&1!==h)for(let d=0;d<i.numViews;d++)this.setViewParameters(i.extents[d],e,B),this.drawDebugTexture(e.resolution,H[e.index]);return this._layerRenderers.size>0&&this._sortedLayerRenderers.forAll((({layerView:r,renderer:t})=>{if(2===h&&d.isSome(r)&&0===r.drapeSourceType)return;const s=d.isSome(r)&&d.isSome(r.fullOpacity)&&r.fullOpacity<1&&0===n;s&&(this.bindTemporaryFramebuffer(this._rctx,o,l),u.clearSafe(16384));for(let n=0;n<i.numViews;n++)this.setViewParameters(i.extents[n],e,B),t.render(this._renderContext,this._bindParameters);s&&d.isSome(this._temporaryFBO)&&(a.bind(u),this.view._stage.renderView.compositingHelper.composite(this._temporaryFBO.getTexture(),2,d.unwrap(d.unwrap(r).fullOpacity),3,e.index))})),u.bindFramebuffer(null),a.generateMipMap(),this._renderContext.resetRenderOccludedMask(),!0},i.bindTemporaryFramebuffer=function(e,r,t){d.isNone(this._temporaryFBO)&&(this._temporaryFBO=new v.OverlayFramebufferObject(e,!1)),this._temporaryFBO.resize(r,t),this._temporaryFBO.bind(e)},i.reloadShaders=function(){var e=r._asyncToGenerator((function*(){yield this._shaderTechniqueRepository.hotReload()}));function t(){return e.apply(this,arguments)}return t}(),i.intersect=function(e,r,t){let i=0;this._geometries.forEach((s=>{if(t&&!t(s))return;this.intersectRenderGeometry(s,r,0,e,i);const n=this.longitudeCyclical;n&&(s.boundingSphere[0]-s.boundingSphere[3]<n.min&&this.intersectRenderGeometry(s,r,n.range,e,i),s.boundingSphere[0]+s.boundingSphere[3]>n.max&&this.intersectRenderGeometry(s,r,-n.range,e,i)),i++}))},i.intersectRenderGeometry=function(e,r,t,i,s){if(!e.instanceParameters.visible)return;let n=0;d.isSome(e.transformation)&&(t+=e.transformation[12],n=e.transformation[13]),z[0]=r[0]-t,z[1]=r[1]-n,z[2]=1,j[0]=r[0]-t,j[1]=r[1]-n,j[2]=0,e.screenToWorldRatio=this._screenToWorldRatio,e.material.intersect(e,null,e.getShaderTransformation(),i,z,j,((r,t,n)=>{this.addIntersectionResult(n,e.material.renderPriority,s,i,e.layerUid,e.graphicUid)}),e.calculateShaderTransformation,!0)},i.addIntersectionResult=function(e,r,t,i,s,n){const a={type:"external",metadata:{layerUid:s,graphicUid:n}},o=s=>{s.set(a,null,i.results.ground.dist,i.results.ground.normal,i.results.ground.transformation,r,null,null,e,t),s.intersector="OverlayRenderer"};if((null==i.results.min.drapedLayerOrder||r>=i.results.min.drapedLayerOrder)&&(null==i.results.min.dist||i.results.ground.dist<=i.results.min.dist)&&o(i.results.min),0!==i.options.store&&(null==i.results.max.drapedLayerOrder||r<i.results.max.drapedLayerOrder)&&(null==i.results.max.dist||i.results.ground.dist>i.results.max.dist)&&o(i.results.max),2===i.options.store){const e=new P.IntersectorResult(i.ray);o(e),i.results.all.push(e)}},i.ensureLayerRenderer=function(e){let r=this._layerRenderers.get(e);return r||(r=new D.SortedRenderGeometryRenderer({rctx:this._rctx,materialRepository:this._materialRepository}),this._layerRenderers.set(e,r),this._sortedLayerRenderersDirty=!0,"fullOpacity"in e&&this._handles.add(e.watch("fullOpacity",(()=>this.events.emit("content-changed"))),e),this._handles.add(u.init(r,"updating",(()=>this.notifyChange("updating"))),e)),r},i.updateSortedLayerRenderers=function(){if(!this._sortedLayerRenderersDirty)return;if(this._sortedLayerRenderersDirty=!1,this._sortedLayerRenderers.clear(),0===this._layerRenderers.size)return;const e=new Set(this._layerRenderers.values());this.view.allLayerViews.forEach((r=>{const t=r,i=this._layerRenderers.get(t);i&&(this._sortedLayerRenderers.push(new W(t,i)),e.delete(i))})),e.forEach((e=>this._sortedLayerRenderers.push(new W(null,e))))},i.setViewParameters=function(e,r,t){t.viewport[0]=t.viewport[1]=0,t.viewport[2]=t.viewport[3]=r.resolution,_.ortho(t.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],t.near,t.far),_.identity(t.viewMatrix),_.translate(t.viewMatrix,t.viewMatrix,[-e[0],-e[1],0]),this._renderContext.camera=t,this._bindParameters.camera=t,this._bindParameters.inverseViewport[0]=1/t.fullViewport[2],this._bindParameters.inverseViewport[1]=1/t.fullViewport[3]},i.updateHasWater=function(){const e=o.someMap(this._layerRenderers,(e=>e.hasWater));e!==this._hasWater&&(this._hasWater=e,this.events.emit("has-water",e))},i.updateHasHighlights=function(){const e=o.someMap(this._layerRenderers,(e=>e.hasHighlights));e!==this._hasHighlights&&(this._hasHighlights=e,this.events.emit("has-highlights",e))},i.updateRendersOccluded=function(){const e=o.someMap(this._layerRenderers,(e=>e.rendersOccluded));e!==this._rendersOccluded&&(this._rendersOccluded=e,this.events.emit("renders-occluded",e))},i.drawDebugTexture=function(e,r){const t=this._rctx;this.ensureDebugPatternResources(e,e);const i=this._debugTextureTechnique.program;t.useProgram(i),t.setPipelineState(this._debugTextureTechnique.pipeline),i.setUniform4f("color",r[0],r[1],r[2],1),i.bindTexture(this._debugPatternTexture,"tex"),t.bindVAO(this._quadVAO),t.drawArrays(5,0,U.vertexCount(this._quadVAO,"geometry"))},i.ensureDebugPatternResources=function(e,r){if(this._debugPatternTexture)return;const t=new Uint8Array(e*r*4);let i=0;for(let n=0;n<r;n++)for(let s=0;s<e;s++){const a=Math.floor(s/10),o=Math.floor(n/10);a<2||o<2||10*a>e-20||10*o>r-20?(t[i++]=255,t[i++]=255,t[i++]=255,t[i++]=255):(t[i++]=255,t[i++]=255,t[i++]=255,t[i++]=1&a&&1&o?1&s^1&n?0:255:1&a^1&o?0:128)}this._debugPatternTexture=new F(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:e,height:r},t);const s=new G.TextureTechniqueConfiguration;s.hasAlpha=!0,this._debugTextureTechnique=this._shaderTechniqueRepository.acquire(G.TextureTechnique,s),this._quadVAO=C.createQuadVAO(this._rctx)},r._createClass(t,[{key:"updating",get:function(){return this._sortedLayerRenderersDirty||o.someMap(this._layerRenderers,(e=>e.updating))}},{key:"hasOverlays",get:function(){return d.isSome(this._overlays)&&d.isSome(this._overlayRenderTarget)}},{key:"gpuMemoryUsage",get:function(){return d.isSome(this._overlayRenderTarget)?this._overlayRenderTarget.gpuMemoryUsage:0}},{key:"overlays",get:function(){return d.unwrapOr(this._overlays,[])}},{key:"running",get:function(){return this.updating}},{key:"hasHighlights",get:function(){return this._hasHighlights}},{key:"hasWater",get:function(){return this._hasWater}},{key:"rendersOccluded",get:function(){return this._rendersOccluded}},{key:"test",get:function(){return{layerRenderers:this._layerRenderers}}}]),t}(x.AutoDisposableMixin(i)),t.__decorate([x.autoDispose()],e.OverlayRenderer.prototype,"_shaderTechniqueRepository",void 0),t.__decorate([x.autoDispose()],e.OverlayRenderer.prototype,"_stippleTextureRepository",void 0),t.__decorate([c.property({constructOnly:!0})],e.OverlayRenderer.prototype,"view",void 0),t.__decorate([c.property()],e.OverlayRenderer.prototype,"worldToPCSRatio",void 0),t.__decorate([c.property()],e.OverlayRenderer.prototype,"spatialReference",void 0),t.__decorate([c.property({type:Boolean,readOnly:!0})],e.OverlayRenderer.prototype,"updating",null),e.OverlayRenderer=t.__decorate([g.subclass("esri.views.3d.terrain.OverlayRenderer")],e.OverlayRenderer);let W=function(e,r){this.layerView=e,this.renderer=r};const H=[[1,.5,.5],[.5,.5,1]],B=new O;B.near=1,B.far=1e4,B.relativeElevation=null;const z=f.create(),j=f.create(),N=-2,I=4;e.DRAPED_Z=N,e.overlayRenderOccludedFlag=I,Object.defineProperty(e,"__esModule",{value:!0})}));
