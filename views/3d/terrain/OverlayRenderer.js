// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../core/Accessor","../../../core/Handles","../../../core/Logger","../../../core/MapUtils","../../../core/maybe","../../../core/maybe","../../../core/PooledArray","../../../core/SetUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators","../../../core/libs/gl-matrix-2/mat4","../../../core/libs/gl-matrix-2/vec2f64","../../../core/libs/gl-matrix-2/vec3f64","../support/debugFlags","./OverlayRenderTarget","../webgl-engine/core/shaderTechnique/CommonUniformStore","../webgl-engine/core/shaderTechnique/ShaderTechniqueRepository","../webgl-engine/lib/AutoDisposable","../webgl-engine/lib/Camera","../webgl-engine/lib/GLMaterialRep","../webgl-engine/lib/glUtil3D","../webgl-engine/lib/GridLocalOriginFactory","../webgl-engine/lib/intersectorUtils","../webgl-engine/lib/RenderContext","../webgl-engine/lib/renderStats","../webgl-engine/lib/SortedRenderGeometryRenderer","../webgl-engine/lib/TextureTechnique","../webgl-engine/lighting/Lightsources","../webgl-engine/lighting/SceneLighting","../webgl-engine/materials/lineStippleUtils","../../webgl/Texture","../../webgl/Util"],(function(e,t,r,i,n,s,a,o,d,l,u,h,p,c,g,y,_,m,f,R,b,w,v,x,T,O,C,S,P,L,D,V,U,M,q){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.overlayRenderOccludedFlag=t.DRAPED_Z=t.OverlayRenderer=void 0;var A=s.getLogger("esri.views.3d.webgl-engine.lib.OverlayRenderer"),E=function(e){function i(){var t=null!==e&&e.apply(this,arguments)||this;return t._hasHighlights=!1,t._rendersOccluded=!1,t._hasWater=!1,t._lighting=new V.SceneLighting,t._localOrigins=new T,t._handles=new n,t._layerRenderers=new Map,t._sortedLayerRenderersDirty=!1,t._sortedLayerRenderers=new l,t._stats=new S.RenderStatsAggregator,t._geometries=new Map,t._uniqueIdx=0,t.globalUnitScale=1,t.longitudeCyclical=null,t}return r.__extends(i,e),i.prototype.initialize=function(){var e=this;this._rctx=this.renderView.renderingContext,this._renderContext=new C(this._rctx,null,null,null,null,null),this._stippleTextureRepository=new U.StippleTextureRepository,this.waterTextureRepository=this.renderView.waterTextureRepository,this._shaderTechniqueRepository=new R.ShaderTechniqueRepository({rctx:this._rctx,viewingMode:2,commonUniformStore:new f.CommonUniformStore,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:this.waterTextureRepository}),h.init(this.waterTextureRepository,"loadingState",(function(){return e.emitContentChanged()})),this._materialRepository=new v(this.renderView.textureRepository,this._shaderTechniqueRepository),this._materialRepository.onMaterialChanged=function(r){(r.renderOccluded&t.overlayRenderOccludedFlag)>0!==e._rendersOccluded&&e.updateRendersOccluded(),e.emitContentChanged(),e.notifyChange("updating")},this._compositingHelper=this.renderView.compositingHelper,this._lighting.set({lights:[new D.AmbientLight(y.vec3f64.fromValues(1,1,1))],groundLightingFactor:1,globalFactor:0}),this._bindParameters={slot:null,highlightDepthTexture:x.createEmptyDepthTexture(this._rctx),camera:W,inverseViewport:g.vec2f64.create(),origin:null,screenToWorldRatio:null,screenToWorldRatioGlobalWM:null,shadowMappingEnabled:!1,slicePlane:null,ssaoEnabled:!1,hasOccludees:!1,linearDepthTexture:null,linearDepthTextureID:0,lastFrameColorTexture:null,lastFrameColorTextureID:0,reprojectionMat:null,ssrEnabled:!1,lighting:this._lighting}},i.prototype.dispose=function(){this._handles.destroy(),this._layerRenderers.forEach((function(e){return e.dispose()})),this._layerRenderers.clear(),this._bindParameters.highlightDepthTexture.dispose(),this._bindParameters.highlightDepthTexture=null,this._shaderTechniqueRepository.dispose(),this._shaderTechniqueRepository=null},Object.defineProperty(i.prototype,"updating",{get:function(){return this._sortedLayerRenderersDirty||a.someMap(this._layerRenderers,(function(e){return e.updating}))||this.waterTextureRepository.updating},enumerable:!1,configurable:!0}),i.prototype.commitChanges=function(){var e=this,t=!1;this._layerRenderers.forEach((function(r,i){r.commitChanges()&&(t=!0),r.isEmpty&&(e._layerRenderers.delete(i),e._sortedLayerRenderersDirty=!0,e._handles.remove(i))})),this._sortedLayerRenderersDirty&&(this.updateSortedLayerRenderers(),t=!0),t&&(this.notifyChange("updating"),this.emitContentChanged(),this.updateHasHighlights(),this.updateRendersOccluded(),this.updateHasWater())},i.prototype.addGeometries=function(e,t,r){for(var i=0,n=e;i<n.length;i++){var s=n[i];null==s.origin&&(s.origin=this._localOrigins.getOrigin(s.center)),s.uniqueName||(s.uniqueName="ov:"+this._uniqueIdx++),this._geometries.set(s.uniqueName,s)}this.ensureLayerRenderer(t).add(e),2===r&&this.notifyGraphicUpdate(e,t,2)},i.prototype.removeGeometries=function(e,t,r){for(var i=0,n=e;i<n.length;i++){var s=n[i];this._geometries.delete(s.uniqueName)}var a=this._layerRenderers.get(t);a&&(a.remove(e),2===r&&this.notifyGraphicUpdate(e,t,2))},i.prototype.updateGeometries=function(e,t,r){var i=this._layerRenderers.get(t);i?(i.modify(e,r),this.notifyUpdateGeometries(e,t,r)):A.warn("Attempted to update geometry for nonexistent layer")},i.prototype.notifyUpdateGeometries=function(e,t,r){var i=4===r||2===r?2:1===r?1:0;this.notifyGraphicUpdate(e,t,i)},i.prototype.notifyGraphicUpdate=function(e,t,r){if(0!==r)for(var i=-1,n=0,s=e;n<s.length;n++){var a=s[n].data.graphicUid;a!==i&&(t.notifyGraphicUpdate(a,r),i=a)}},i.prototype.updateHighlights=function(e,t){var r=this._layerRenderers.get(t);r?r.modify(e,8):A.warn("Attempted to update highlights for nonexistent layer")},i.prototype.isEmpty=function(){return 0===this._geometries.size&&!_.OVERLAY_DRAW_DEBUG_TEXTURE},Object.defineProperty(i.prototype,"hasHighlights",{get:function(){return this._hasHighlights},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"hasWater",{get:function(){return this._hasWater},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"rendersOccluded",{get:function(){return this._rendersOccluded},enumerable:!1,configurable:!0}),i.prototype.updateLogic=function(e){var t=!1;return this._layerRenderers.forEach((function(r){r.updateLogic(e)&&(t=!0)})),t},i.prototype.updateLayerOrder=function(){this._sortedLayerRenderersDirty=!0},i.prototype.drawPass=function(e,r,i,n){var s=this;if(void 0===n&&(n=0),0===i.numViews)return!1;if(this._screenToWorldRatio=i.pixelRatio*Math.abs(i.views[0].extent[2]-i.views[0].extent[0])/Math.abs(i.views[0].viewport[2]-i.views[0].viewport[0]),this.isEmpty()||4===e&&!this.hasHighlights||2===e&&!this.hasWater)return!1;if(!this.hasNonZeroSizedView(i))return!1;var a=i.width,o=i.height;if(!r.isValid())return!1;r.resize(a,o);var l=this._rctx;if(W.pixelRatio=i.pixelRatio||1,this._renderContext.pass=e,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToWorldRatioGlobalWM=this._screenToWorldRatio*this.globalUnitScale,r.bind(l),l.setClearColor(0,0,0,0),l.clearSafe(16384),1===n&&(this._renderContext.renderOccludedMask=t.overlayRenderOccludedFlag),_.OVERLAY_DRAW_DEBUG_TEXTURE&&1!==n)for(var u=0;u<i.numViews;u++)this.setViewParameters(i.views[u],W),this.drawDebugTexture(a,o,H[i.index%H.length]);return this._layerRenderers.size>0&&this._sortedLayerRenderers.forEachSimple((function(t){var u=t.layerView,h=t.renderer;if(2!==n||!d.isSome(u)||0!==u.drapeSourceType){var p=d.isSome(u)&&d.isSome(u.fullOpacity)&&u.fullOpacity<1&&0===e;p&&(s.bindTemporaryFramebuffer(s._rctx,a,o),l.clearSafe(16384));for(var c=0;c<i.numViews;c++)s.setViewParameters(i.views[c],W),h.draw(s._renderContext,s._bindParameters,s._stats);p&&d.isSome(s._temporaryRenderTarget)&&(r.bind(l),s._compositingHelper.composite(s._temporaryRenderTarget.getTexture(),2,d.unwrap(d.unwrap(u).fullOpacity)))}})),l.bindFramebuffer(null),r.generateMipMap(),this._renderContext.resetRenderOccludedMask(),!0},i.prototype.bindTemporaryFramebuffer=function(e,t,r){o.isNone(this._temporaryRenderTarget)&&(this._temporaryRenderTarget=new m.OverlayRenderTarget(e,"temp",0,!1)),this._temporaryRenderTarget.resize(t,r),this._temporaryRenderTarget.bind(e)},i.prototype.getStats=function(){return this._stats.getAggregatedStats()},i.prototype.hotReloadShaders=function(){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){switch(e.label){case 0:return[4,this._shaderTechniqueRepository.hotReload()];case 1:return e.sent(),[2]}}))}))},i.prototype.intersect=function(e,t,r){var i=this,n=0;this._geometries.forEach((function(s){if(!r||r(s)){i.intersectRenderGeometry(s,t,0,e,n);var a=i.longitudeCyclical;a&&(s.center[0]-s.bsRadius<a.min&&i.intersectRenderGeometry(s,t,a.range,e,n),s.center[0]+s.bsRadius>a.max&&i.intersectRenderGeometry(s,t,-a.range,e,n)),n++}}))},i.prototype.intersectRenderGeometry=function(e,t,r,i,n){var s=this,a=0;d.isSome(e.transformation)&&(r+=e.transformation[12],a=e.transformation[13]),F[0]=t[0]-r,F[1]=t[1]-a,F[2]=1,j[0]=t[0]-r,j[1]=t[1]-a,j[2]=0,e.screenToWorldRatio=this._screenToWorldRatio,e.material.intersect(e,null,e.getShaderTransformation(),i,F,j,(function(t,r,a){s.addIntersectionResult(a,e.material.renderPriority,n,i,e.data.layerUid,e.data.graphicUid)}),e.calculateShaderTransformation,!0)},i.prototype.addIntersectionResult=function(e,t,r,i,n,s){var a={type:"external",metadata:{layerUid:n,graphicUid:s}},o=function(n){n.set(a,null,i.results.ground.dist,i.results.ground.normal,i.results.ground.transformation,t,null,null,e,r),n.intersector="OverlayRenderer"};if((null==i.results.min.drapedLayerOrder||t>=i.results.min.drapedLayerOrder)&&(null==i.results.min.dist||i.results.ground.dist<=i.results.min.dist)&&o(i.results.min),0!==i.options.store&&(null==i.results.max.drapedLayerOrder||t<i.results.max.drapedLayerOrder)&&(null==i.results.max.dist||i.results.ground.dist>i.results.max.dist)&&o(i.results.max),2===i.options.store){var d=new O.IntersectorResult(i.ray);o(d),i.results.all.push(d)}},i.prototype.stopAnimationsAtTime=function(e){this._sortedLayerRenderers.forEachSimple((function(t){return t.renderer.stopAnimationsAtTime(e)}))},i.prototype.ensureLayerRenderer=function(e){var t=this,r=this._layerRenderers.get(e);return r||(r=new P.SortedRenderGeometryRenderer({rctx:this._rctx,materialRepository:this._materialRepository}),this._layerRenderers.set(e,r),this._sortedLayerRenderersDirty=!0,this._handles.add([e.watch("fullOpacity",(function(){return t.emitContentChanged()})),h.init(r,"updating",(function(){return t.notifyChange("updating")}))],e)),r},i.prototype.updateSortedLayerRenderers=function(){var e=this;if(this._sortedLayerRenderersDirty&&(this._sortedLayerRenderersDirty=!1,this._sortedLayerRenderers.clear(),0!==this._layerRenderers.size)){var t=a.firstKeyOfMap(this._layerRenderers).view.allLayerViews,r=u.SetFromValues(a.valuesOfMap(this._layerRenderers));t.forEach((function(t){var i=t,n=e._layerRenderers.get(i);n&&(e._sortedLayerRenderers.push(new G(i,n)),r.delete(n))})),r.forEach((function(t){e._sortedLayerRenderers.push(new G(null,t))}))}},i.prototype.setViewParameters=function(e,t){t.viewport=e.viewport;var r=e.extent;c.mat4.ortho(t.projectionMatrix,0,r[2]-r[0],0,r[3]-r[1],t.near,t.far),c.mat4.identity(t.viewMatrix),c.mat4.translate(t.viewMatrix,t.viewMatrix,[-e.extent[0],-e.extent[1],0]),t.setGLViewport(this._rctx),this._renderContext.camera=t,this._bindParameters.camera=t,this._bindParameters.inverseViewport[0]=1/t.fullViewport[2],this._bindParameters.inverseViewport[1]=1/t.fullViewport[3]},i.prototype.hasNonZeroSizedView=function(e){for(var t=0;t<e.numViews;t++){var r=e.views[t];if(r.extent[0]!==r.extent[2]&&r.extent[1]!==r.extent[3])return!0}return!1},i.prototype.emitContentChanged=function(){this.onContentChanged&&this.onContentChanged()},i.prototype.updateHasWater=function(){var e=a.someMap(this._layerRenderers,(function(e){return e.hasWater}));e!==this._hasWater&&(this._hasWater=e)},i.prototype.updateHasHighlights=function(){var e=a.someMap(this._layerRenderers,(function(e){return e.hasHighlights}));e!==this._hasHighlights&&(this._hasHighlights=e,this.onHasHighlightsChanged&&this.onHasHighlightsChanged(this._hasHighlights))},i.prototype.updateRendersOccluded=function(){var e=a.someMap(this._layerRenderers,(function(e){return e.rendersOccluded}));e!==this._rendersOccluded&&(this._rendersOccluded=e,this.onRendersOccludedChanged&&this.onRendersOccludedChanged(this.rendersOccluded))},i.prototype.drawDebugTexture=function(e,t,r){var i=this._rctx;this.ensureDebugPatternResources(e,t);var n=this._debugPatternProgram;i.bindProgram(n),i.setPipelineState(this._debugPatternPipelineState),n.setUniform4f("color",r[0],r[1],r[2],1),n.setUniform1i("tex",0),i.bindTexture(this._debugPatternTexture,0),i.bindVAO(this._quadVAO),i.drawArrays(5,0,q.vertexCount(this._quadVAO,"geometry"))},i.prototype.ensureDebugPatternResources=function(e,t){if(!this._debugPatternTexture){for(var r=new Uint8Array(e*t*4),i=0,n=0;n<t;n++)for(var s=0;s<e;s++){var a=Math.floor(s/10),o=Math.floor(n/10);a<2||o<2||10*a>e-20||10*o>t-20?(r[i++]=255,r[i++]=255,r[i++]=255,r[i++]=255):(r[i++]=255,r[i++]=255,r[i++]=255,r[i++]=1&a&&1&o?1&s^1&n?0:255:1&a^1&o?0:128)}this._debugPatternTexture=new M(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:e,height:t},r);var d=new L.TextureTechniqueConfiguration;d.hasAlpha=!0,this._debugTextureTechnique=this._shaderTechniqueRepository.acquireAndReleaseExisting(L.TextureTechnique,d,this._debugTextureTechnique),this._debugPatternProgram=this._debugTextureTechnique.program,this._debugPatternPipelineState=this._debugTextureTechnique.pipeline,this._quadVAO=x.createQuadVAO(this._rctx)}},Object.defineProperty(i.prototype,"test",{get:function(){return{layerRenderers:this._layerRenderers}},enumerable:!1,configurable:!0}),r.__decorate([b.autoDispose()],i.prototype,"_shaderTechniqueRepository",void 0),r.__decorate([b.autoDispose()],i.prototype,"_stippleTextureRepository",void 0),r.__decorate([p.property(),b.autoDispose()],i.prototype,"waterTextureRepository",void 0),r.__decorate([p.property()],i.prototype,"renderView",void 0),r.__decorate([p.property()],i.prototype,"globalUnitScale",void 0),r.__decorate([p.property({type:Boolean,readOnly:!0,dependsOn:["waterTextureRepository.updating"]})],i.prototype,"updating",null),i=r.__decorate([p.subclass("esri.views.3d.terrain.OverlayRenderer")],i)}(b.AutoDisposableMixin(i));t.OverlayRenderer=E;var G=function(e,t){this.layerView=e,this.renderer=t},H=[[1,.5,.5],[.5,.5,1],[.5,1,.5]],W=new w.default;W.near=1,W.far=1e4,W.relativeElevation=null;var F=y.vec3f64.create(),j=y.vec3f64.create();t.DRAPED_Z=-2,t.overlayRenderOccludedFlag=4}));