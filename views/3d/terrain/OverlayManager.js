/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/Handles","../../../core/has","../../../core/mathUtils","../../../core/maybe","../../../core/scheduling","../../../core/time","../../../core/unitUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/Logger","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec2","../../../chunks/vec3","../../../chunks/vec3f64","../../../chunks/vec4","../../../chunks/vec4f64","../../../geometry/projection","../../../geometry/projectionEllipsoid","../../../geometry/support/aaBoundingRect","../../../geometry/support/ray","../../../chunks/sphere","../../../geometry/support/vector","../../../geometry/support/webMercatorUtils","../state/utils/viewUtils","../support/animationUtils","../support/debugFlags","../support/debugUtils","../support/mathUtils","./Overlay","./OverlayRenderer","../webgl-engine/lib/Intersector","../webgl-engine/lib/localOrigin","../webgl-engine/parts/requireUtils","../../support/Scheduler"],(function(e,t,r,i,s,a,n,o,c,l,h,d,u,p,y,_,g,f,v,O,m,T,w,D,S,R,M,x,C,I,E,b,P,A,U,V,k,L){"use strict";const H=3.5,F=10,G=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]];let q;function B(e,t){const r=1e-5,i=I.TESTS_DISABLE_UPDATE_THRESHOLDS?0:r*Math.max(e[2]-e[0],e[3]-e[1],t[2]-t[0],t[3]-t[1]);for(let s=0;s<4;s++)if(Math.abs(t[s]-e[s])>i)return!0;return!1}e.OverlayManager=function(e){function r(t){var r;return(r=e.call(this,t)||this)._handles=new s,r._spatialReference=null,r._renderSR=null,r._overlaySREqualsRenderSR=!0,r._drapeSources=new Map,r._drapeTargets=new Set,r._renderedAltitude=0,r._displayOpacity=0,r._displayOpacityTime=-1,r._placementDirty=!1,r._drawTexturesDirty=!1,r._drawTexturesAnimateDirty=!1,r._layerViewsDirty=!0,r._hasUnusedRenderTargets=!1,r._longitudeCyclical=null,r._latestOriginId=0,r._maxResolution=a("esri-mobile")?2048:4096,r._animationTimeLast=0,r}t._inheritsLoose(r,e);var i=r.prototype;return i.initialize=function(){const e=this.view,t=e.state.isGlobal&&o.isSome(this._spatialReference)?h.getMetersPerUnitForSR(this._spatialReference):1;this.renderer=new A.OverlayRenderer({view:e,globalUnitScale:t,spatialReference:this._spatialReference}),this.renderer.onHasHighlightsChanged=()=>{this._setDrawTexturesDirty(),this.notifyChange("hasHighlights")},this.renderer.onRendersOccludedChanged=()=>{this._setDrawTexturesDirty(),this.notifyChange("rendersOccluded")},this.renderer.onContentChanged=()=>this._setDrawTexturesDirty(),this.renderer.onHasWaterChanged=t=>{var r;return null==(r=e._stage)?void 0:r.renderView.setRenderParameters({hasOverlayWater:t})},this.groundIntersector=new U.Intersector(this.view.state.viewingMode),this.groundIntersector.options.backfacesTerrain=!0,this.groundIntersector.options.invisibleTerrain=!0,this.groundIntersector.options.hud=!1,this._handles.add([e.watch(["pointsOfInterest.renderPointOfView","pointsOfInterest.centerOnSurfaceFrequent.location","pixelRatio"],(()=>this.setOverlayPlacementDirty())),this.surface.on("elevation-change",(()=>this.setOverlayPlacementDirty())),e.allLayerViews.on("after-changes",(()=>this._layerViewsDirty=!0)),e.on("resize",(()=>this.setOverlayPlacementDirty())),c.addFrameTask({preRender:e=>{this.renderer.processSyncLayers(),this._updateLayerViews(),this.renderer.hasOverlays&&(this._dispatchRendererUpdate(e),this._drawOverlayTextures(this.renderer.overlays)),this._hasUnusedRenderTargets&&this._collectUnusedRenderTargetMemory()}}),e.resourceController.scheduler.registerTask(L.TaskPriority.OVERLAY_MANAGER,this),e._stage.renderView.events.on("force-camera-for-screenshot",(e=>{this._updateOverlays(e),this.renderer.hasOverlays&&this._drawOverlayTextures(this.renderer.overlays)}))]),this._updateLayerViews()},i.destroy=function(){this._drapeSources.forEach(((e,t)=>this.unregisterDrapeSource(t))),this._drapeTargets.forEach((e=>this._unregisterDrapeTarget(e))),this.renderer.dispose(),this._handles&&(this._handles.destroy(),this._handles=null),o.isSome(q)&&(q.remove(),q=null)},i.setSpatialReference=function(e){this._spatialReference=e,this.renderer.spatialReference=e,this._longitudeCyclical=null;const t=this.view.renderSpatialReference;o.isSome(e)&&o.isSome(t)?(this._renderSR=t,this._overlaySREqualsRenderSR=e.equals(this._renderSR),this._isSpherical&&(this._longitudeCyclical=e.isWebMercator?new b.Cyclical(-20037508.342787,20037508.342787):new b.Cyclical(-180,180),this.renderer.longitudeCyclical=this._longitudeCyclical),this.renderer&&(this.renderer.globalUnitScale=this._isSpherical&&o.isSome(this._spatialReference)?h.getMetersPerUnitForSR(this._spatialReference):1)):this.renderer.disposeOverlays()},i.getGpuMemoryUsage=function(){return this.renderer.gpuMemoryUsage},i._updateLayerViews=function(){if(!this._layerViewsDirty)return;const e=new Set;for(const t of this.view.allLayerViews.items)e.add(t.uid),"drapeSourceType"in t&&!this._drapeSources.has(t)&&this._registerDrapeSource(t,0),"drapeTargetType"in t&&!this._drapeTargets.has(t)&&this._registerDrapeTarget(t);this._drapeSources.forEach(((t,r)=>{0!==t||e.has(r.uid)||this.unregisterDrapeSource(r)})),this._drapeTargets.forEach((t=>{e.has(t.uid)||this._unregisterDrapeTarget(t)})),this.renderer.updateLayerOrder(),this._setDrawTexturesDirty(),this._layerViewsDirty=!1},i.registerDrapeSource=function(e){this._registerDrapeSource(e,1)},i._registerDrapeSource=function(e,t){this._drapeSources.set(e,t),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources),this.renderer.overlays.forEach((t=>{this._updateDrapeSource(e,t)})),this._setOverlayContentDirty(),this.notifyChange("running")},i._updateDrapeSource=function(e,t){o.isSome(e.setDrapingExtent)&&o.isSome(this._spatialReference)&&e.setDrapingExtent(t,this._spatialReference)},i.unregisterDrapeSource=function(e){this._drapeSources.has(e)&&(this._drapeSources.delete(e),this.renderer.ensureDrapeSources(this._drapeSources),this._setOverlayContentDirty(),this.notifyChange("running"))},i._registerDrapeTarget=function(e){this._drapeTargets.add(e),this._updateDrapeTarget(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources)},i._updateDrapeTarget=function(e){this.renderer.overlays.forEach((t=>e.setDrapingTextures(t)))},i._unregisterDrapeTarget=function(e){this._drapeTargets.delete(e),this.renderer.ensureDrapeTargets(this._drapeTargets)},i._setOverlayContentDirty=function(){this.setOverlayPlacementDirty(),this._setDrawTexturesDirty()},i.setOverlayPlacementDirty=function(){this._placementDirty=!0},i.runTask=function(){this._updateOverlays(this.view.state.camera)},i._updateOverlays=function(e){if(!this._spatialReference)return;this._updateLayerViews();const t=P.computeOverlayResolution(e.fullWidth,e.fullHeight,this._maxResolution);this._computeOverlayExtents(e,t,j);const r=w.width(j.inner)/w.width(j.outer);this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);const i=this._updateOverlay(0,j.inner,t,1),s=this._updateOverlay(1,j.outer,t,r);(i||s)&&(this.surface.updateTileOverlayParams(),this._setDrawTexturesDirty()),this._placementDirty=!1,this.surface.updateOverlayOpacity()},i._updateOverlay=function(e,t,r,i){if(0===this.renderer.overlays.length)return!1;const s=this.renderer.overlays[e];if(!B(t,s.extent)&&r===s.resolution&&s.pixelRatio===i)return!1;w.set(s.extent,t),s.resolution=r,s.pixelRatio=i;const a=w.center(s.extent);return s.renderLocalOrigin=V.fromValues(a[0],a[1],0,"OV_"+this._latestOriginId++),this._drapeSources.forEach(((e,t)=>this._updateDrapeSource(t,s))),!0},i.computeOpacity=function(e){if(!this.renderer.hasOverlays)return this._displayOpacity=0,this._displayOpacityTime=-1,1;if(e*H<this._renderedAltitude){const t=(e-this._renderedAltitude/F)/(this._renderedAltitude/H-this._renderedAltitude/F);this._displayOpacity=Math.sqrt(n.clamp(t,0,1)),this._displayOpacityTime=performance.now()}else if(1!==this._displayOpacity){const e=performance.now();this._displayOpacityTime=this._displayOpacityTime>0?this._displayOpacityTime:e;const t=e-this._displayOpacityTime,r=this.surface.textureFadeDuration;if(t<r)return this._displayOpacity+(1-this._displayOpacity)*(t/r);this._displayOpacity=1,this._displayOpacityTime=-1}return this._displayOpacity},i.setTileParameters=function(e){const t=e.renderData.overlay;if(this.renderer.overlays.length>0){const r=this.renderer.overlays[0],i=this.renderer.overlays[1],s=w.intersection(e.extent,e.surface.extent,N);this._rectInsideRect(s,r.extent)||this._rectanglesOverlap(s,r.extent)||this._rectanglesOverlap(s,i.extent)?(this._setTileOverlayData(s,0,t),this._setTileOverlayData(s,1,t)):(this._clearTileOverlayData(0,t),this._clearTileOverlayData(1,t))}else this._clearTileOverlayData(0,t),this._clearTileOverlayData(1,t)},i.overlayPixelSizeInMapUnits=function(e){if(0===this.renderer.overlays.length)return 0;const t=this.renderer.overlays[0],r=this.renderer.overlays[1],i=this._pointIsInExtent(e,t.extent)?t:r;return(i.extent[2]-i.extent[0])/i.resolution},i._setTileOverlayData=function(e,t,r){if(0===this.renderer.overlays.length)return;const i=this.renderer.overlays[t].extent;r.setScale(t,(e[2]-e[0])/(i[2]-i[0]),(e[3]-e[1])/(i[3]-i[1]));let s=e[0];if(this._longitudeCyclical){s=this._longitudeCyclical.minimalMonotonic(i[0],s);const t=this._longitudeCyclical.minimalMonotonic(i[0],e[2]);s>t&&(s=t-(e[2]-e[0]))}r.setOffset(t,(s-i[0])/(i[2]-i[0]),(e[1]-i[1])/(i[3]-i[1]))},i._clearTileOverlayData=function(e,t){t.setScale(e,-1,-1),t.setOffset(e,-1,-1)},i.reloadShaders=function(){var e=t._asyncToGenerator((function*(){k.removeLoadedShaderModules(),yield this.renderer.reloadShaders(),this.runTask()}));function r(){return e.apply(this,arguments)}return r}(),i.stopAnimationsAtTime=function(e){this.renderer.stopAnimationsAtTime(e),this._drawTexturesAnimateDirty=!0},i._dispatchRendererUpdate=function(e){const t=l.Milliseconds(e.time-this._animationTimeLast);if(t<C.DESIRED_DRAPED_ANIMATION_MS)return;this._animationTimeLast=e.time;this.renderer.updateLogic({dt:t,camera:this.view.state.camera})&&(this._drawTexturesAnimateDirty=!0)},i._setDrawTexturesDirty=function(){this.renderer.hasOverlays?this._drawTexturesDirty=!0:this.setOverlayPlacementDirty()},i._intersectGroundFromView=function(e,t,r,i){const s=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(e,X,t,r);if(o.isNone(s))return!1;const a=s.origin,n=g.add(z,s.origin,s.direction);return this.groundIntersector.reset(a,n),this.groundIntersector.intersect([],null,e),this.view.basemapTerrain.intersect(this.groundIntersector,null,a,n),this.groundIntersector.results.min.getIntersectionPoint(i)},i._findHorizonBasedPointOfInterest=function(e,t){let r=.5;const i=.55,s=this.view.renderCoordsHelper.getAltitude(e.eye),a=this.view.pointsOfInterest.centerOnSurfaceFrequent,o=1e-5,c=n.clamp(a.estimatedSurfaceAltitude,e.aboveGround?-1/0:s+o,e.aboveGround?s-o:1/0),l=e.aboveGround;if("global"===this.view.viewingMode){const t=z;S.closestPointOnSilhouette(S.fromRadius(T.getReferenceEllipsoid(this.view.spatialReference).radius+c),D.wrap(e.eye,e.viewForward),t),g.subtract(t,t,e.eye);const s=b.cyclicalPI.normalize(R.angleAroundAxis(e.viewForward,t,e.viewRight))/e.fovY+.5,a=s<=0||s>=1?.5:i;r=l?a*s:s+a*(1-s)}else{const t=.5*Math.PI-Math.acos(-e.viewForward[2]),s=Math.tan(t),a=O.fromValues(0,s,1,0),o=v.transformMat4(a,a,e.projectionMatrix)[1],c=n.clamp(.5+.5*o,0,1);r=1===c||0===c?.5:l?c*i:1-(1-c)*i}return!!this._intersectGroundFromView(e,.5,r,t)&&g.sqrDist(t,e.eye)<a.distance*a.distance},i._computeOverlayExtents=function(e,t,r){const i=this.surface.extent,s=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,a=f.create();this._findHorizonBasedPointOfInterest(e,a)||g.copy(a,s),this._renderedAltitude=this.view.renderCoordsHelper.getAltitude(e.eye);const c=g.distance(e.eye,a),l=x.viewAngle(this.view.renderCoordsHelper,s,e.eye),h=Math.PI/2-Math.abs(l-Math.PI/2);I.OVERLAY_SHOW_CENTER?(o.isNone(q)&&(q=new E.GraphicsHandle(this.view.graphics,"red")),q.showPoint(a,this._renderSR)):o.isSome(q)&&q.remove(),this._overlaySREqualsRenderSR||m.projectVectorToVector(a,this._renderSR,a,this._spatialReference);let d=t*e.perRenderPixelRatio*c/2,u=!1,p=1/0;this._isSpherical&&o.isSome(this._spatialReference)&&(this._spatialReference.isWebMercator?(d/=Math.cos(M.y2lat(a[1])),p=this.surface.extent[3]):(u=!0,d/=T.getReferenceEllipsoid(this._spatialReference).metersPerDegree,p=90),d>=p&&(d=p,a[1]=0,this._spatialReference.isWebMercator&&(a[0]=0)));let y=1;u&&(y=1/Math.max(.2,Math.cos(Math.abs(n.deg2rad(a[1])))),d*y>180&&(y=180/d));const O=Math.log(2)/12;d=Math.exp(Math.round(Math.log(d)/O)*O);const D=d*y,S=32,R=.5*t/(S*D),C=.5*t/(S*d);a[0]=Math.round(a[0]*R)/R,a[1]=Math.round(a[1]*C)/C;const b=r.inner;b[0]=a[0]-D,b[1]=a[1]-d,b[2]=a[0]+D,b[3]=a[1]+d,this._isSpherical&&this._shiftExtentToFitBounds(b,1/0,p);const P=r.outer;if(w.set(P,b),6*D>i[2]-i[0])w.set(P,i);else if(h<=.25*Math.PI)P[0]-=D,P[1]-=d,P[2]+=D,P[3]+=d;else{m.projectVectorToVector(e.eye,this._renderSR,z,this._spatialReference),_.subtract(W,a,z);let t=-Math.atan2(W[1],W[0])+.125*Math.PI;t<0&&(t+=2*Math.PI);const r=Math.floor(t/(.25*Math.PI));v.scale(W,G[r],2*d),W[0]*=y,W[2]*=y,v.add(P,P,W)}if(this._isSpherical&&(P[0]=this._longitudeCyclical.clamp(P[0]),P[2]=this._longitudeCyclical.clamp(P[2]),P[1]=Math.max(P[1],-p),P[3]=Math.min(P[3],p)),!this._isSpherical&&i){const e=w.intersection(b,i,N),t=w.intersection(P,i,Y);w.contains(e,t)&&(P[2]=P[0],P[3]=P[1])}},i._drawOverlayTextures=function(e){if(0===e.length||!this._drawTexturesDirty&&!this._drawTexturesAnimateDirty)return;const t=this._drawOverlay(e[0]),r=this._drawOverlay(e[1]);0!==t&&0!==r||this.surface.updateTileOverlayParams(),this._collectUnusedRenderTargetMemory(),this._drapeTargets.forEach((e=>this._updateDrapeTarget(e))),this._drawTexturesAnimateDirty=!1,this._drawTexturesDirty?(this._drawTexturesDirty=!1,this.surface.requestRender(),this.surface.requestUpdate()):this.surface.requestRender(0)},i._drawOverlay=function(e){return this._longitudeCyclical?e.setupGeometryViewsCyclical(this._longitudeCyclical):e.setupGeometryViewsDirect(),e.draw(this.renderer,this.view.state.camera.pixelRatio)},i._collectUnusedRenderTargetMemory=function(){if(this._hasUnusedRenderTargets=!1,this.renderer.hasOverlays){const e=performance.now();this._hasUnusedRenderTargets=this.renderer.collectUnusedRenderTargetMemory(e)}},i._rectanglesOverlap=function(e,t){return this._longitudeCyclical?(this._longitudeCyclical.contains(t[0],t[2],e[0])||this._longitudeCyclical.contains(t[0],t[2],e[2])||this._longitudeCyclical.contains(e[0],e[2],t[0]))&&!(e[1]>t[3]||e[3]<t[1]):w.intersects(e,t)},i._rectInsideRect=function(e,t){return this._longitudeCyclical?this._longitudeCyclical.contains(t[0],t[2],e[0])&&this._longitudeCyclical.contains(t[0],t[2],e[2])&&e[1]>t[1]&&e[3]<t[3]:w.contains(t,e)},i._pointIsInExtent=function(e,t){if(this._longitudeCyclical)return this._longitudeCyclical.contains(t[0],t[2],e.x)&&e.y>=t[1]&&e.y<=t[3];const r=e.x,i=e.y;return r>t[0]&&r<t[2]&&i>t[1]&&i<t[3]},i._shiftExtentToFitBounds=function(e,t,r){let i=0,s=0;e[0]<-t?i=e[0]+t:e[2]>t&&(i=t-e[2]),e[1]<-r?s=e[1]+r:e[3]>r&&(s=r-e[3]),w.offset(e,i,s)},t._createClass(r,[{key:"running",get:function(){return(this._placementDirty||this._layerViewsDirty)&&(this._drapeSources.size>0||this.view.graphics.length>0||I.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._spatialReference&&!this.suspended&&this.surface.ready}},{key:"_isSpherical",get:function(){return this.view.state.isGlobal}},{key:"view",get:function(){return this.surface.view}},{key:"updating",get:function(){return this.running||this.renderer.updating}},{key:"hasHighlights",get:function(){return this.renderer.hasHighlights}},{key:"rendersOccluded",get:function(){return this.renderer.rendersOccluded}},{key:"hasOverlays",get:function(){return this.renderer.hasOverlays}},{key:"test",get:function(){return{renderer:this.renderer,update:()=>this.runTask()}}}]),r}(i),r.__decorate([d.property()],e.OverlayManager.prototype,"_spatialReference",void 0),r.__decorate([d.property({readOnly:!0})],e.OverlayManager.prototype,"running",null),r.__decorate([d.property()],e.OverlayManager.prototype,"_placementDirty",void 0),r.__decorate([d.property()],e.OverlayManager.prototype,"_layerViewsDirty",void 0),r.__decorate([d.property()],e.OverlayManager.prototype,"renderer",void 0),r.__decorate([d.property({constructOnly:!0})],e.OverlayManager.prototype,"surface",void 0),r.__decorate([d.property({readOnly:!0,aliasOf:"surface.suspended"})],e.OverlayManager.prototype,"suspended",void 0),r.__decorate([d.property({readOnly:!0})],e.OverlayManager.prototype,"updating",null),r.__decorate([d.property({type:Boolean})],e.OverlayManager.prototype,"hasHighlights",null),r.__decorate([d.property({type:Boolean})],e.OverlayManager.prototype,"rendersOccluded",null),e.OverlayManager=r.__decorate([y.subclass("esri.views.3d.terrain.OverlayManager")],e.OverlayManager);const W=O.create(),z=f.create(),j={inner:w.create(),outer:w.create()},N=w.create(),Y=w.create(),X=D.create();Object.defineProperty(e,"__esModule",{value:!0})}));
