// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../core/Accessor","../../../core/Handles","../../../core/has","../../../core/mathUtils","../../../core/mathUtils","../../../core/maybe","../../../core/scheduling","../../../core/unitUtils","../../../core/accessorSupport/decorators","../../../core/libs/gl-matrix-2/vec2","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../../../core/libs/gl-matrix-2/vec4","../../../core/libs/gl-matrix-2/vec4f64","../../../geometry/support/aaBoundingRect","../../../geometry/support/geodesicConstants","../../../layers/support/timeUtils","../state/utils/viewUtils","../support/animationUtils","../support/debugFlags","../support/debugUtils","../support/geometryUtils","../support/mathUtils","../support/projectionUtils","./Overlay","./OverlayRenderer","../webgl-engine/lib/Intersector","../webgl-engine/lib/localOrigin","../webgl-engine/parts/requireUtils","../../support/Scheduler"],(function(e,t,r,i,a,s,n,o,l,c,u,d,h,p,y,_,v,g,f,m,w,T,S,x,O,D,R,M,C,b,I,E,U){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OverlayManager=void 0;var V,P=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]],A=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._handles=new a,t._overlaySR=null,t._renderSR=null,t._overlaySREqualsRenderSR=!0,t._drapeSources=new Map,t._drapeTargets=new Set,t._overlays=null,t._drapeSourceTypes=[0,0],t._drapeTargetTypes=[0,0],t._renderedAltitude=0,t._placementDirty=!1,t._drawTexturesDirty=!1,t._drawTexturesAnimateDirty=!1,t._layerViewsDirty=!0,t._hasUnusedRenderTargets=!1,t._isSpherical=!1,t._longitudeCyclical=null,t._latestOriginId=0,t._maxResolution=s("esri-mobile")?2048:4096,t._animationTimeLast=0,t._forceAnimation=!1,t}return r.__extends(t,e),Object.defineProperty(t.prototype,"updating",{get:function(){return this.needsUpdate()||this.renderer.updating},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"hasHighlights",{get:function(){return this.renderer.hasHighlights},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rendersOccluded",{get:function(){return this.renderer.rendersOccluded},enumerable:!1,configurable:!0}),t.prototype.initialize=function(){var e=this;this._stage=this.view._stage,this.renderer=new C.OverlayRenderer({renderView:this._stage.renderView,globalUnitScale:this.view.state.isGlobal?u.getMetersPerUnitForSR(this._overlaySR):1}),this._drapeTargetTypes[0]++,this.renderer.onHasHighlightsChanged=function(){e.setDrawTexturesDirty(),e.notifyChange("hasHighlights")},this.renderer.onRendersOccludedChanged=function(){e.setDrawTexturesDirty(),e.notifyChange("rendersOccluded")},this.renderer.onContentChanged=function(){e.setDrawTexturesDirty()},this.groundIntersector=new b.Intersector(this.view.state.mode),this.groundIntersector.options.backfacesTerrain=!0,this.groundIntersector.options.invisibleTerrain=!0,this.groundIntersector.options.hud=!1,this._handles.add([this.view.watch(["pointsOfInterest.renderPointOfView","pointsOfInterest.centerOnSurfaceFrequent.location","pixelRatio"],(function(){return e.setOverlayPlacementDirty()})),this.terrainSurface.on("elevation-change",(function(){return e.setOverlayPlacementDirty()})),this.view.allLayerViews.on("after-changes",(function(){return e._layerViewsDirty=!0})),this.view.on("resize",(function(){return e.setOverlayPlacementDirty()})),c.addFrameTask({preRender:function(t){e.renderer.commitChanges(),e._updateLayerViews(),e.hasOverlays()&&(e._dispatchRendererUpdate(t),e._drawOverlayTextures()),e._hasUnusedRenderTargets&&e._collectUnusedRenderTargetMemory()}}),this.view.resourceController.scheduler.registerTask(U.Task.OVERLAY_MANAGER,(function(){return e.updateOverlays()}),(function(){return e.needsUpdate()})),this.view._stage.renderView.events.on("force-camera-for-screenshot",(function(t){e.updateOverlays(t),e._drawOverlayTextures()}))]),this._updateLayerViews()},t.prototype.destroy=function(){var e=this;this._drapeSources.forEach((function(t,r){return e._unregisterDrapeSource(r)})),this._drapeTargets.forEach((function(t,r){return e._unregisterDrapeTarget(r)})),this._drapeTargetTypes[0]--,this._disposeOverlays(),this.renderer.dispose(),this._handles&&(this._handles.destroy(),this._handles=null),l.isSome(V)&&(V.remove(),V=null)},t.prototype.hasOverlays=function(){return!!this._overlays},t.prototype.setSpatialReference=function(e,t){this._overlaySR=e,this._longitudeCyclical=null,e?(this._renderSR=this.view.renderSpatialReference,this._overlaySREqualsRenderSR=this._overlaySR.equals(this._renderSR),this._isSpherical=t,t&&(this._longitudeCyclical=e.isWebMercator?new D.Cyclical(-20037508.342787,20037508.342787):new D.Cyclical(-180,180),this.renderer.longitudeCyclical=this._longitudeCyclical),this.renderer&&(this.renderer.globalUnitScale=t?u.getMetersPerUnitForSR(this._overlaySR):1)):this._disposeOverlays(),this.notifyChange("updating")},t.prototype.getGpuMemoryUsage=function(){return this._overlays[0].getGpuMemoryUsage()+this._overlays[1].getGpuMemoryUsage()},t.prototype._updateLayerViews=function(){var e=this;if(this._layerViewsDirty){for(var t=new Set,r=0,i=this.view.allLayerViews.items;r<i.length;r++){var a=i[r];t.add(a.uid),"drapeSourceType"in a&&!this._drapeSources.has(a)&&this._registerDrapeSource(a),"drapeTargetType"in a&&!this._drapeTargets.has(a)&&this._registerDrapeTarget(a)}this._drapeSources.forEach((function(r,i){t.has(i.uid)||e._unregisterDrapeSource(i)})),this._drapeTargets.forEach((function(r){t.has(r.uid)||e._unregisterDrapeTarget(r)})),this.renderer.updateLayerOrder(),this.setDrawTexturesDirty(),this._layerViewsDirty=!1}},t.prototype._registerDrapeSource=function(e){var t=this,r=e.on("draped-data-change",(function(){return t.setOverlayContentDirty()}));this._drapeSourceTypes[e.drapeSourceType]++,this._drapeSources.set(e,[r]),this._overlays&&e.setDrapingExtent&&this._overlays.forEach((function(r,i){return t._updateDrapeSource(e,i,r)})),this.setOverlayContentDirty()},t.prototype._updateDrapeSource=function(e,t,r){e.setDrapingExtent&&e.setDrapingExtent(t,r.extent,this._overlaySR,r.resolution,r.renderLocalOrigin,r.pixelRatio)},t.prototype._unregisterDrapeSource=function(e){if(this._drapeSources.has(e)){var t=this._drapeSources.get(e);t&&t.forEach((function(e){return e.remove()})),this._drapeSourceTypes[e.drapeSourceType]--,this._drapeSources.delete(e),this.setOverlayContentDirty()}},t.prototype._registerDrapeTarget=function(e){this._drapeTargets.add(e),this._updateDrapeTarget(e),this._drapeTargetTypes[e.drapeTargetType]++},t.prototype._updateDrapeTarget=function(e){var t=this;this._overlays&&this._overlays.forEach((function(r,i){var a=r.renderTargets,s=t.needsColorWithoutRasterImage()?a.colorWithoutRasterImage:t.hasDrapedFeatures()?a.color:null,n=a.highlight,o=a.water;e.setDrapingTextures(i,r.extent,s&&s.valid?s.fbo.getTexture():null,n.valid?n.fbo.getTexture():null,o.valid?o.fbo.getTexture():null)}))},t.prototype._unregisterDrapeTarget=function(e){this._drapeTargets.delete(e),this._drapeTargetTypes[e.drapeTargetType]--},t.prototype.setOverlayContentDirty=function(){this.setOverlayPlacementDirty(),this.setDrawTexturesDirty()},t.prototype.setOverlayPlacementDirty=function(){this._placementDirty=!0,this.notifyChange("updating")},t.prototype.updateOverlays=function(e){if(void 0===e&&(e=this.view.state.camera),this._overlaySR){this._updateLayerViews();var t,r,i,a=(t=e.fullWidth,r=e.fullHeight,i=Math.max(t,r)+256,n.nextHighestPowerOfTwo(i)),s=Math.min(a,this._maxResolution);this._computeOverlayExtents(e,a,G);var o=g.width(G.inner)/g.width(G.outer);this._overlays||(this._overlays=[new M.Overlay(this._stage.renderView.renderingContext,0),new M.Overlay(this._stage.renderView.renderingContext,1)]);var l=this._updateOverlay(0,G.inner,s,1),c=this._updateOverlay(1,G.outer,s,o);(l||c)&&(this.terrainSurface.updateTileOverlayParams(),this.setDrawTexturesDirty()),this._placementDirty=!1,this.terrainSurface.updateOverlayOpacity(),this.notifyChange("updating")}},t.prototype._updateOverlay=function(e,t,r,i){var a=this,s=this._overlays[e];if(!function(e,t){for(var r=S.TESTS_DISABLE_UPDATE_THRESHOLDS?0:1e-5*Math.max(e[2]-e[0],e[3]-e[1],t[2]-t[0],t[3]-t[1]),i=0;i<4;i++)if(Math.abs(t[i]-e[i])>r)return!0;return!1}(t,s.extent)&&r===s.resolution&&s.pixelRatio===i)return!1;g.set(s.extent,t),s.resolution=r,s.pixelRatio=i;var n=g.center(s.extent);return s.renderLocalOrigin=I.fromValues(n[0],n[1],0,"OV_"+this._latestOriginId++),this._drapeSources.forEach((function(t,r){return a._updateDrapeSource(r,e,s)})),!0},t.prototype.needsUpdate=function(){return(this._placementDirty||this._layerViewsDirty)&&(this._drapeSources.size>0||this.view.graphics.length>0||S.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._overlaySR&&!this._get("suspended")&&this.terrainSurface.ready},t.prototype.updateOpacity=function(e){return this._overlays?this._getAltitudeBasedOpacity(e,this._renderedAltitude):1},t.prototype._getAltitudeBasedOpacity=function(e,t){if(3.5*e<t){var r=(e-t/10)/(t/3.5-t/10);return Math.sqrt(n.clamp(r,0,1))}return 1},t.prototype.setTileParameters=function(e,t,r){if(this._overlays){var i=this._overlays[0],a=this._overlays[1],s=g.intersection(e.extent,e.surface.extent,q);this._rectInsideRect(s,i.extent)?(this._setTileOverlayData(s,i,t.overlays[0]),t.overlays[1].overlay=null):this._rectanglesOverlap(s,i.extent)?(this._setTileOverlayData(s,i,t.overlays[0]),this._setTileOverlayData(s,a,t.overlays[1])):this._rectanglesOverlap(s,a.extent)?(this._setTileOverlayData(s,a,t.overlays[0]),t.overlays[1].overlay=null):(t.overlays[0].overlay=null,t.overlays[1].overlay=null)}else t.overlays[0].overlay=null,t.overlays[1].overlay=null;t.overlayOpacity=void 0!==r?r:1},t.prototype.overlayPixelSizeInMapUnits=function(e){if(!this._overlays)return 0;var t=this._overlays[0],r=this._overlays[1],i=this._pointIsInExtent(e,t.extent)?t:r;return(i.extent[2]-i.extent[0])/i.resolution},t.prototype._setTileOverlayData=function(e,t,r){var i=t.extent;r.texScale[0]=(e[2]-e[0])/(i[2]-i[0]),r.texScale[1]=(e[3]-e[1])/(i[3]-i[1]);var a=e[0];if(this._longitudeCyclical){a=this._longitudeCyclical.minimalMonotonic(i[0],a);var s=this._longitudeCyclical.minimalMonotonic(i[0],e[2]);a>s&&(a=s-(e[2]-e[0]))}r.texOffset[0]=(a-i[0])/(i[2]-i[0]),r.texOffset[1]=(e[1]-i[1])/(i[3]-i[1]),r.overlay=t},t.prototype._disposeOverlays=function(){this._overlays&&(this._overlays.forEach((function(e){return e.dispose()})),this._overlays=null)},t.prototype.hotReloadShaders=function(){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){switch(e.label){case 0:return E.removeLoadedShaderModules(),[4,this.renderer.hotReloadShaders()];case 1:return e.sent(),this.updateOverlays(),this.needsUpdate(),[2]}}))}))},t.prototype.stopAnimationsAtTime=function(e){this.renderer.stopAnimationsAtTime(e),this._forceAnimation=!0},t.prototype._dispatchRendererUpdate=function(e){var t=m.Milliseconds(e.time-this._animationTimeLast);t<T.DESIRED_DRAPED_ANIMATION_MS&&!this._forceAnimation||(this._animationTimeLast=e.time,this.renderer.updateLogic({dt:t,camera:this._stage.getCamera()})&&(this._drawTexturesAnimateDirty=!0))},t.prototype.setDrawTexturesDirty=function(){this._overlays?this._drawTexturesDirty=!0:this.setOverlayPlacementDirty()},t.prototype._intersectGroundFromView=function(e,t,r,i){var a=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(e,W,t,r),s=a.origin,n=p.vec3.add(F,a.origin,a.direction);return this.groundIntersector.reset(s,n),this.groundIntersector.intersect([],null,e),this.view.basemapTerrain.intersect(this.groundIntersector,null,s,n),this.groundIntersector.results.min.getIntersectionPoint(i)},t.prototype._findHorizonBasedPointOfInterest=function(e,t,r){var i=.5,a=this.view.renderCoordsHelper.getAltitude(t),s=this.view.renderCoordsHelper.getAltitude(e.eye),o=s>a;if("global"===this.view.viewingMode){var l=y.vec3f64.clone(e.eye);p.vec3.normalize(l,l),p.vec3.negate(l,l);var c=n.asinClamped((f.earthRadius+a)/(f.earthRadius+a+Math.abs(s-a))),u=n.acosClamped(Math.abs(p.vec3.dot(e.viewForward,l))),d=c-(u-.5*e.fovY),h=n.clamp(d/e.fovY,0,1),g=-c-(u-.5*e.fovY),m=n.clamp(g/e.fovY,0,1);i=1===h&&0===m?.5:m+.55*(h-m),o||(i=1-i)}else{var w=.5*Math.PI-Math.acos(-e.viewForward[2]),T=Math.tan(w),S=v.vec4f64.fromValues(0,T,1,0),x=_.vec4.transformMat4(S,S,e.projectionMatrix)[1],O=n.clamp(.5+.5*x,0,1);i=1===O||0===O?.5:o?.55*O:1-.55*(1-O)}return!!this._intersectGroundFromView(e,.5,i,r)&&p.vec3.sqrDist(r,e.eye)<p.vec3.sqrDist(t,e.eye)},t.prototype._computeOverlayExtents=function(e,t,r){var i=this.terrainSurface.extent,a=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,s=y.vec3f64.create();this._findHorizonBasedPointOfInterest(e,a,s)||p.vec3.copy(s,a),this._renderedAltitude=this.view.renderCoordsHelper.getAltitude(e.eye);var n=p.vec3.distance(e.eye,s),c=w.viewAngle(this.view.renderCoordsHelper,a,e.eye),u=Math.PI/2-Math.abs(c-Math.PI/2);S.OVERLAY_SHOW_CENTER?(l.isNone(V)&&(V=new x.GraphicsHandle(this.view.graphics,"red")),V.showPoint(s,this._renderSR)):l.isSome(V)&&V.remove(),this._overlaySREqualsRenderSR||R.vectorToVector(s,this._renderSR,s,this._overlaySR);var d=t*e.perRenderPixelRatio*n/2,v=!1,m=1/0;this._isSpherical&&(this._overlaySR.isWebMercator?(d/=Math.cos(R.webMercator.y2lat(s[1])),m=this.terrainSurface.extent[3]):(v=!0,d/=f.metersPerDegree,m=90),d>=m&&(d=m,s[1]=0,this._overlaySR.isWebMercator&&(s[0]=0)));var T=1;v&&d*(T=1/Math.max(.2,Math.cos(Math.abs(o.deg2rad(s[1])))))>180&&(T=180/d);var O=Math.log(2)/12,D=(d=Math.exp(Math.round(Math.log(d)/O)*O))*T,M=.5*t/(32*D),C=.5*t/(32*d);s[0]=Math.round(s[0]*M)/M,s[1]=Math.round(s[1]*C)/C;var b=r.inner;b[0]=s[0]-D,b[1]=s[1]-d,b[2]=s[0]+D,b[3]=s[1]+d,this._isSpherical&&this._shiftExtentToFitBounds(b,1/0,m);var I=r.outer;if(g.set(I,b),6*D>i[2]-i[0])g.set(I,i);else if(u<=.25*Math.PI)I[0]-=D,I[1]-=d,I[2]+=D,I[3]+=d;else{R.vectorToVector(e.eye,this._renderSR,F,this._overlaySR),h.vec2.subtract(L,s,F);var E=-Math.atan2(L[1],L[0])+.125*Math.PI;E<0&&(E+=2*Math.PI);var U=Math.floor(E/(.25*Math.PI));_.vec4.scale(L,P[U],2*d),L[0]*=T,L[2]*=T,_.vec4.add(I,I,L)}if(this._isSpherical&&(I[0]=this._longitudeCyclical.clamp(I[0]),I[2]=this._longitudeCyclical.clamp(I[2]),I[1]=Math.max(I[1],-m),I[3]=Math.min(I[3],m)),!this._isSpherical&&i){var A=g.intersection(b,i,q),H=g.intersection(I,i,B);g.contains(A,H)&&(I[2]=I[0],I[3]=I[1])}},t.prototype._drawOverlayTextures=function(){var e=this;if(this._drawTexturesDirty||this._drawTexturesAnimateDirty){var t=this._drawOverlay(0),r=this._drawOverlay(1);0!==t&&0!==r||this.terrainSurface.updateTileOverlayParams(),this._collectUnusedRenderTargetMemory(),this._drapeTargets.forEach((function(t){return e._updateDrapeTarget(t)})),this._drawTexturesDirty?(this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1,this.terrainSurface.requestRender(),this.terrainSurface.pendingUpdates=!0):(this._drawTexturesAnimateDirty=!1,this.terrainSurface.requestRender(0))}},t.prototype._setupGeometryViewsCyclical=function(e,t,r){this._setupGeometryViewsDirect(e,t,r);var i=.001*this._longitudeCyclical.range;if(t[0]-i<=this._longitudeCyclical.min){var a=e.views[e.numViews++];_.vec4.set(a.viewport,0,0,r,r),g.offset(t,this._longitudeCyclical.range,0,a.extent)}if(t[2]+i>=this._longitudeCyclical.max){a=e.views[e.numViews++];_.vec4.set(a.viewport,0,0,r,r),g.offset(t,-this._longitudeCyclical.range,0,a.extent)}},t.prototype._setupGeometryViewsDirect=function(e,t,r){e.numViews=1;var i=e.views[0];g.set(i.extent,t),_.vec4.set(i.viewport,0,0,r,r)},t.prototype._drawOverlay=function(e){var t=this._overlays[e],r=t.computeRenderTargetValidityBitfield(),i=t.extent,a=t.resolution,s=t.pixelRatio;return this._longitudeCyclical?this._setupGeometryViewsCyclical(H,i,a):this._setupGeometryViewsDirect(H,i,a),H.width=a,H.height=a,H.pixelRatio=s*this.view.state.camera.pixelRatio,H.index=e,t.drawRenderTargets(this.renderer,H,this.needsColorWithoutRasterImage()),r^t.computeRenderTargetValidityBitfield()?0:1},t.prototype.needsColorWithoutRasterImage=function(){return this._drapeSourceTypes[0]>0&&this._drapeSourceTypes[1]>0&&this._drapeTargetTypes[1]>0},t.prototype.hasDrapedFeatures=function(){return this._drapeSourceTypes[1]>0},t.prototype._collectUnusedRenderTargetMemory=function(){var e=performance.now();this._hasUnusedRenderTargets=!1;for(var t=0,r=this._overlays;t<r.length;t++){var i=r[t];this._hasUnusedRenderTargets=i.collectUnusedMemory(e)||this._hasUnusedRenderTargets}},t.prototype._rectanglesOverlap=function(e,t){return this._longitudeCyclical?(this._longitudeCyclical.contains(t[0],t[2],e[0])||this._longitudeCyclical.contains(t[0],t[2],e[2])||this._longitudeCyclical.contains(e[0],e[2],t[0]))&&!(e[1]>t[3]||e[3]<t[1]):g.intersects(e,t)},t.prototype._rectInsideRect=function(e,t){return this._longitudeCyclical?this._longitudeCyclical.contains(t[0],t[2],e[0])&&this._longitudeCyclical.contains(t[0],t[2],e[2])&&e[1]>t[1]&&e[3]<t[3]:g.contains(t,e)},t.prototype._pointIsInExtent=function(e,t){if(this._longitudeCyclical)return this._longitudeCyclical.contains(t[0],t[2],e.x)&&e.y>=t[1]&&e.y<=t[3];var r=e.x,i=e.y;return r>t[0]&&r<t[2]&&i>t[1]&&i<t[3]},t.prototype._shiftExtentToFitBounds=function(e,t,r){var i=0,a=0;e[0]<-t?i=e[0]+t:e[2]>t&&(i=t-e[2]),e[1]<-r?a=e[1]+r:e[3]>r&&(a=r-e[3]),g.offset(e,i,a)},Object.defineProperty(t.prototype,"test",{get:function(){return{overlays:this._overlays,renderer:this.renderer}},enumerable:!1,configurable:!0}),r.__decorate([d.property()],t.prototype,"renderer",void 0),r.__decorate([d.property()],t.prototype,"view",void 0),r.__decorate([d.property()],t.prototype,"terrainSurface",void 0),r.__decorate([d.property({readOnly:!0,aliasOf:"terrainSurface.suspended"})],t.prototype,"suspended",void 0),r.__decorate([d.property({readOnly:!0,dependsOn:["terrainSurface.ready","suspended","renderer.updating"]})],t.prototype,"updating",null),r.__decorate([d.property({type:Boolean})],t.prototype,"hasHighlights",null),r.__decorate([d.property({type:Boolean})],t.prototype,"rendersOccluded",null),t=r.__decorate([d.subclass("esri.views.3d.terrain.OverlayManager")],t)}(i);t.OverlayManager=A;var H={width:0,height:0,pixelRatio:0,views:[{viewport:g.create(),extent:g.create()},{viewport:g.create(),extent:g.create()},{viewport:g.create(),extent:g.create()}],numViews:0,index:0},L=v.vec4f64.create(),F=y.vec3f64.create(),G={inner:g.create(),outer:g.create()},q=g.create(),B=g.create(),W=O.ray.create()}));