/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/has","../../../core/maybe","../../../core/Logger","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass","../../../core/urlUtils","../../../core/uuid","../../../portal/support/resourceExtension","../../../core/scheduling","../../../core/Accessor","../../../geometry/support/webMercatorUtils","../../../core/mathUtils","../../../chunks/vec3f64","../../../chunks/vec3","../support/mathUtils","../../../core/Handles","../../../layers/support/timeUtils","../../../geometry/projectionEllipsoid","../../../core/unitUtils","../../../geometry/support/aaBoundingRect","../../../geometry/projection","../../support/Scheduler","../../../chunks/vec4f64","../../../chunks/vec2","../../../chunks/vec4","../support/geometryUtils","../webgl-engine/lib/Intersector","../state/utils/viewUtils","../support/debugFlags","../webgl-engine/lib/localOrigin","./OverlayRenderer","../support/debugUtils","../support/animationUtils","../webgl-engine/parts/requireUtils"],(function(e,t,r,i,s,a,n,o,l,c,h,d,u,p,y,_,g,v,f,w,m,T,O,S,D,R,x,M,C,I,E,U,V,b,A,P,L,H){"use strict";const k=3.5,F=10,G=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]];let q;function B(e,t){const r=Math.max(e,t)+256;return _.nextHighestPowerOfTwo(r)}function W(e,t){const r=1e-5,i=V.TESTS_DISABLE_UPDATE_THRESHOLDS?0:r*Math.max(e[2]-e[0],e[3]-e[1],t[2]-t[0],t[3]-t[1]);for(let s=0;s<4;s++)if(Math.abs(t[s]-e[s])>i)return!0;return!1}e.OverlayManager=function(e){function r(t){var r;return(r=e.call(this,t)||this)._handles=new w,r._overlaySR=null,r._renderSR=null,r._overlaySREqualsRenderSR=!0,r._drapeSources=new Map,r._drapeTargets=new Set,r._drapeSourceTypes=[0,0],r._drapeTargetTypes=[0,0],r._renderedAltitude=0,r._placementDirty=!1,r._drawTexturesDirty=!1,r._drawTexturesAnimateDirty=!1,r._layerViewsDirty=!0,r._hasUnusedRenderTargets=!1,r._isSpherical=!1,r._longitudeCyclical=null,r._latestOriginId=0,r._maxResolution=i("esri-mobile")?2048:4096,r._animationTimeLast=0,r}t._inheritsLoose(r,e);var a=r.prototype;return a.initialize=function(){const e=this.view._stage.renderView,t=this.view.state.isGlobal&&s.isSome(this._overlaySR)?O.getMetersPerUnitForSR(this._overlaySR):1,r=this.view.resourceController.scheduler;this.renderer=new A.OverlayRenderer({renderView:e,globalUnitScale:t,scheduler:r}),this._drapeTargetTypes[0]++,this.renderer.onHasHighlightsChanged=()=>{this._setDrawTexturesDirty(),this.notifyChange("hasHighlights")},this.renderer.onRendersOccludedChanged=()=>{this._setDrawTexturesDirty(),this.notifyChange("rendersOccluded")},this.renderer.onContentChanged=()=>{this._setDrawTexturesDirty()},this.groundIntersector=new E.Intersector(this.view.state.mode),this.groundIntersector.options.backfacesTerrain=!0,this.groundIntersector.options.invisibleTerrain=!0,this.groundIntersector.options.hud=!1,this._handles.add([this.view.watch(["pointsOfInterest.renderPointOfView","pointsOfInterest.centerOnSurfaceFrequent.location","pixelRatio"],(()=>this.setOverlayPlacementDirty())),this.surface.on("elevation-change",(()=>this.setOverlayPlacementDirty())),this.view.allLayerViews.on("after-changes",(()=>this._layerViewsDirty=!0)),this.view.on("resize",(()=>this.setOverlayPlacementDirty())),u.addFrameTask({preRender:e=>{this.renderer.commitChanges(),this._updateLayerViews(),this.renderer.hasOverlays&&(this._dispatchRendererUpdate(e),this._drawOverlayTextures(this.renderer.overlays)),this._hasUnusedRenderTargets&&this._collectUnusedRenderTargetMemory()}}),r.registerTask(R.Task.OVERLAY_MANAGER,(()=>this._updateOverlays()),(()=>this._needsUpdate)),this.view._stage.renderView.events.on("force-camera-for-screenshot",(e=>{this._updateOverlays(e),this.renderer.hasOverlays&&this._drawOverlayTextures(this.renderer.overlays)}))]),this._updateLayerViews()},a.destroy=function(){this._drapeSources.forEach(((e,t)=>this.unregisterDrapeSource(t))),this._drapeTargets.forEach((e=>this._unregisterDrapeTarget(e))),this._drapeTargetTypes[0]--,this._disposeOverlays(),this.renderer.dispose(),this._handles&&(this._handles.destroy(),this._handles=null),s.isSome(q)&&(q.remove(),q=null)},a.setSpatialReference=function(e,t){this._overlaySR=e,this._longitudeCyclical=null;const r=this.view.renderSpatialReference;s.isSome(e)&&s.isSome(r)?(this._renderSR=r,this._overlaySREqualsRenderSR=e.equals(this._renderSR),this._isSpherical=t,t&&(this._longitudeCyclical=e.isWebMercator?new f.Cyclical(-20037508.342787,20037508.342787):new f.Cyclical(-180,180),this.renderer.longitudeCyclical=this._longitudeCyclical),this.renderer&&(this.renderer.globalUnitScale=t&&s.isSome(this._overlaySR)?O.getMetersPerUnitForSR(this._overlaySR):1)):this._disposeOverlays()},a.getGpuMemoryUsage=function(){return this.renderer.gpuMemoryUsage},a._updateLayerViews=function(){if(!this._layerViewsDirty)return;const e=new Set;for(const t of this.view.allLayerViews.items)e.add(t.uid),"drapeSourceType"in t&&!this._drapeSources.has(t)&&this._registerDrapeSource(t,0),"drapeTargetType"in t&&!this._drapeTargets.has(t)&&this._registerDrapeTarget(t);this._drapeSources.forEach(((t,r)=>{0!==t||e.has(r.uid)||this.unregisterDrapeSource(r)})),this._drapeTargets.forEach((t=>{e.has(t.uid)||this._unregisterDrapeTarget(t)})),this.renderer.updateLayerOrder(),this._setDrawTexturesDirty(),this._layerViewsDirty=!1},a.registerDrapeSource=function(e){this._registerDrapeSource(e,1)},a._registerDrapeSource=function(e,t){this._drapeSourceTypes[e.drapeSourceType]++,this._drapeSources.set(e,t),this.renderer.forEachOverlay(((t,r)=>this._updateDrapeSource(e,r,t))),this._setOverlayContentDirty(),this.notifyChange("_needsUpdate")},a._updateDrapeSource=function(e,t,r){s.isSome(e.setDrapingExtent)&&s.isSome(this._overlaySR)&&e.setDrapingExtent(t,r.extent,this._overlaySR,r.resolution,r.renderLocalOrigin,r.pixelRatio)},a.unregisterDrapeSource=function(e){this._drapeSources.has(e)&&(this._drapeSourceTypes[e.drapeSourceType]--,this._drapeSources.delete(e),this._setOverlayContentDirty(),this.notifyChange("_needsUpdate"))},a._registerDrapeTarget=function(e){this._drapeTargets.add(e),this._updateDrapeTarget(e),this._drapeTargetTypes[e.drapeTargetType]++},a._updateDrapeTarget=function(e){this.renderer.forEachOverlay(((t,r)=>{const i=t.renderTargets,s=this.needsColorWithoutRasterImage()?i.colorWithoutRasterImage:this.hasDrapedFeatures()?i.color:null,a=i.highlight,n=i.water;e.setDrapingTextures(r,t.extent,s&&s.valid?s.fbo.getTexture():null,a.valid?a.fbo.getTexture():null,n.valid?n.fbo.getTexture():null)}))},a._unregisterDrapeTarget=function(e){this._drapeTargets.delete(e),this._drapeTargetTypes[e.drapeTargetType]--},a._setOverlayContentDirty=function(){this.setOverlayPlacementDirty(),this._setDrawTexturesDirty()},a.setOverlayPlacementDirty=function(){this._placementDirty=!0},a._updateOverlays=function(e=this.view.state.camera){if(!this._overlaySR)return;this._updateLayerViews();const t=B(e.fullWidth,e.fullHeight),r=Math.min(t,this._maxResolution);this._computeOverlayExtents(e,t,Y);const i=S.width(Y.inner)/S.width(Y.outer);this.renderer.ensureOverlays();const s=this._updateOverlay(0,Y.inner,r,1),a=this._updateOverlay(1,Y.outer,r,i);(s||a)&&(this.surface.updateTileOverlayParams(),this._setDrawTexturesDirty()),this._placementDirty=!1,this.surface.updateOverlayOpacity()},a._updateOverlay=function(e,t,r,i){if(s.isNone(this.renderer.overlays))return!1;const a=this.renderer.overlays[e];if(!W(t,a.extent)&&r===a.resolution&&a.pixelRatio===i)return!1;S.set(a.extent,t),a.resolution=r,a.pixelRatio=i;const n=S.center(a.extent);return a.renderLocalOrigin=b.fromValues(n[0],n[1],0,"OV_"+this._latestOriginId++),this._drapeSources.forEach(((t,r)=>this._updateDrapeSource(r,e,a))),!0},a.computeOpacity=function(e){if(!this.renderer.hasOverlays)return 1;if(e*k<this._renderedAltitude){const t=(e-this._renderedAltitude/F)/(this._renderedAltitude/k-this._renderedAltitude/F);return Math.sqrt(_.clamp(t,0,1))}return 1},a.setTileParameters=function(e){const t=e.renderData.overlay;if(s.isSome(this.renderer.overlays)){const r=this.renderer.overlays[0],i=this.renderer.overlays[1],s=S.intersection(e.extent,e.surface.extent,X);this._rectInsideRect(s,r.extent)?(this._setTileOverlayData(s,0,t),this._clearTileOverlayData(1,t)):this._rectanglesOverlap(s,r.extent)?(this._setTileOverlayData(s,0,t),this._setTileOverlayData(s,1,t)):this._rectanglesOverlap(s,i.extent)?(this._clearTileOverlayData(0,t),this._setTileOverlayData(s,1,t)):(this._clearTileOverlayData(0,t),this._clearTileOverlayData(1,t))}else this._clearTileOverlayData(0,t),this._clearTileOverlayData(1,t)},a.overlayPixelSizeInMapUnits=function(e){if(s.isNone(this.renderer.overlays))return 0;const t=this.renderer.overlays[0],r=this.renderer.overlays[1],i=this._pointIsInExtent(e,t.extent)?t:r;return(i.extent[2]-i.extent[0])/i.resolution},a._setTileOverlayData=function(e,t,r){if(s.isNone(this.renderer.overlays))return;const i=this.renderer.overlays[t].extent;r.setScale(t,(e[2]-e[0])/(i[2]-i[0]),(e[3]-e[1])/(i[3]-i[1]));let a=e[0];if(this._longitudeCyclical){a=this._longitudeCyclical.minimalMonotonic(i[0],a);const t=this._longitudeCyclical.minimalMonotonic(i[0],e[2]);a>t&&(a=t-(e[2]-e[0]))}r.setOffset(t,(a-i[0])/(i[2]-i[0]),(e[1]-i[1])/(i[3]-i[1]))},a._clearTileOverlayData=function(e,t){t.setScale(e,-1,-1),t.setOffset(e,-1,-1)},a._disposeOverlays=function(){this.renderer.disposeOverlays()},a.reloadShaders=async function(){H.removeLoadedShaderModules(),await this.renderer.reloadShaders(),this._updateOverlays()},a.stopAnimationsAtTime=function(e){this.renderer.stopAnimationsAtTime(e),this._drawTexturesAnimateDirty=!0},a._dispatchRendererUpdate=function(e){const t=m.Milliseconds(e.time-this._animationTimeLast);if(t<L.DESIRED_DRAPED_ANIMATION_MS)return;this._animationTimeLast=e.time;this.renderer.updateLogic({dt:t,camera:this.view._stage.camera})&&(this._drawTexturesAnimateDirty=!0)},a._setDrawTexturesDirty=function(){this.renderer.hasOverlays?this._drawTexturesDirty=!0:this.setOverlayPlacementDirty()},a._intersectGroundFromView=function(e,t,r,i){const a=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(e,K,t,r);if(s.isNone(a))return!1;const n=a.origin,o=v.add(j,a.origin,a.direction);return this.groundIntersector.reset(n,o),this.groundIntersector.intersect([],null,e),this.view.basemapTerrain.intersect(this.groundIntersector,null,n,o),this.groundIntersector.results.min.getIntersectionPoint(i)},a._findHorizonBasedPointOfInterest=function(e,t){let r=.5;const i=.55,s=this.view.renderCoordsHelper.getAltitude(e.eye),a=this.view.pointsOfInterest.centerOnSurfaceFrequent,n=1e-5,o=_.clamp(a.estimatedSurfaceAltitude,e.aboveGround?-1/0:s+n,e.aboveGround?s-n:1/0),l=e.aboveGround;if("global"===this.view.viewingMode){const t=j;I.sphere.closestPointOnSilhouette(I.sphere.fromRadius(T.getReferenceEllipsoid(this.view.spatialReference).radius+o),I.ray.wrap(e.eye,e.viewForward),t),v.subtract(t,t,e.eye);const s=f.cyclicalPI.normalize(I.vector.angleAroundAxis(e.viewForward,t,e.viewRight))/e.fovY+.5,a=s<=0||s>=1?.5:i;r=l?a*s:s+a*(1-s)}else{const t=.5*Math.PI-Math.acos(-e.viewForward[2]),s=Math.tan(t),a=x.fromValues(0,s,1,0),n=C.transformMat4(a,a,e.projectionMatrix)[1],o=_.clamp(.5+.5*n,0,1);r=1===o||0===o?.5:l?o*i:1-(1-o)*i}return!!this._intersectGroundFromView(e,.5,r,t)&&v.sqrDist(t,e.eye)<a.distance*a.distance},a._computeOverlayExtents=function(e,t,r){const i=this.surface.extent,a=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,n=g.create();this._findHorizonBasedPointOfInterest(e,n)||v.copy(n,a),this._renderedAltitude=this.view.renderCoordsHelper.getAltitude(e.eye);const o=v.distance(e.eye,n),l=U.viewAngle(this.view.renderCoordsHelper,a,e.eye),c=Math.PI/2-Math.abs(l-Math.PI/2);V.OVERLAY_SHOW_CENTER?(s.isNone(q)&&(q=new P.GraphicsHandle(this.view.graphics,"red")),q.showPoint(n,this._renderSR)):s.isSome(q)&&q.remove(),this._overlaySREqualsRenderSR||D.projectVectorToVector(n,this._renderSR,n,this._overlaySR);let h=t*e.perRenderPixelRatio*o/2,d=!1,u=1/0;this._isSpherical&&s.isSome(this._overlaySR)&&(this._overlaySR.isWebMercator?(h/=Math.cos(y.y2lat(n[1])),u=this.surface.extent[3]):(d=!0,h/=T.getReferenceEllipsoid(this._overlaySR).metersPerDegree,u=90),h>=u&&(h=u,n[1]=0,this._overlaySR.isWebMercator&&(n[0]=0)));let p=1;d&&(p=1/Math.max(.2,Math.cos(Math.abs(_.deg2rad(n[1])))),h*p>180&&(p=180/h));const f=Math.log(2)/12;h=Math.exp(Math.round(Math.log(h)/f)*f);const w=h*p,m=32,O=.5*t/(m*w),R=.5*t/(m*h);n[0]=Math.round(n[0]*O)/O,n[1]=Math.round(n[1]*R)/R;const x=r.inner;x[0]=n[0]-w,x[1]=n[1]-h,x[2]=n[0]+w,x[3]=n[1]+h,this._isSpherical&&this._shiftExtentToFitBounds(x,1/0,u);const I=r.outer;if(S.set(I,x),6*w>i[2]-i[0])S.set(I,i);else if(c<=.25*Math.PI)I[0]-=w,I[1]-=h,I[2]+=w,I[3]+=h;else{D.projectVectorToVector(e.eye,this._renderSR,j,this._overlaySR),M.subtract(z,n,j);let t=-Math.atan2(z[1],z[0])+.125*Math.PI;t<0&&(t+=2*Math.PI);const r=Math.floor(t/(.25*Math.PI));C.scale(z,G[r],2*h),z[0]*=p,z[2]*=p,C.add(I,I,z)}if(this._isSpherical&&(I[0]=this._longitudeCyclical.clamp(I[0]),I[2]=this._longitudeCyclical.clamp(I[2]),I[1]=Math.max(I[1],-u),I[3]=Math.min(I[3],u)),!this._isSpherical&&i){const e=S.intersection(x,i,X),t=S.intersection(I,i,J);S.contains(e,t)&&(I[2]=I[0],I[3]=I[1])}},a._drawOverlayTextures=function(e){if(s.isNone(e)||!this._drawTexturesDirty&&!this._drawTexturesAnimateDirty)return;const t=this._drawOverlay(e,0),r=this._drawOverlay(e,1);0!==t&&0!==r||this.surface.updateTileOverlayParams(),this._collectUnusedRenderTargetMemory(),this._drapeTargets.forEach((e=>this._updateDrapeTarget(e))),this._drawTexturesAnimateDirty=!1,this._drawTexturesDirty?(this._drawTexturesDirty=!1,this.surface.requestRender(),this.surface.pendingUpdates=!0):this.surface.requestRender(0)},a._setupGeometryViewsCyclical=function(e,t,r){this._setupGeometryViewsDirect(e,t,r);const i=.001*this._longitudeCyclical.range;if(t[0]-i<=this._longitudeCyclical.min){const i=e.views[e.numViews++];C.set(i.viewport,0,0,r,r),S.offset(t,this._longitudeCyclical.range,0,i.extent)}if(t[2]+i>=this._longitudeCyclical.max){const i=e.views[e.numViews++];C.set(i.viewport,0,0,r,r),S.offset(t,-this._longitudeCyclical.range,0,i.extent)}},a._setupGeometryViewsDirect=function(e,t,r){e.numViews=1;const i=e.views[0];S.set(i.extent,t),C.set(i.viewport,0,0,r,r)},a._drawOverlay=function(e,t){const r=e[t],i=r.computeRenderTargetValidityBitfield(),{extent:s,resolution:a,pixelRatio:n}=r;this._longitudeCyclical?this._setupGeometryViewsCyclical(N,s,a):this._setupGeometryViewsDirect(N,s,a),N.width=a,N.height=a,N.pixelRatio=n*this.view.state.camera.pixelRatio,N.index=t,r.drawRenderTargets(this.renderer,N,this.needsColorWithoutRasterImage());return i^r.computeRenderTargetValidityBitfield()?0:1},a.needsColorWithoutRasterImage=function(){return this._drapeSourceTypes[0]>0&&this._drapeSourceTypes[1]>0&&this._drapeTargetTypes[1]>0},a.hasDrapedFeatures=function(){return this._drapeSourceTypes[1]>0},a._collectUnusedRenderTargetMemory=function(){if(this._hasUnusedRenderTargets=!1,this.renderer.hasOverlays){const e=performance.now();this.renderer.forEachOverlay((t=>this._hasUnusedRenderTargets=t.collectUnusedMemory(e)||this._hasUnusedRenderTargets))}},a._rectanglesOverlap=function(e,t){return this._longitudeCyclical?(this._longitudeCyclical.contains(t[0],t[2],e[0])||this._longitudeCyclical.contains(t[0],t[2],e[2])||this._longitudeCyclical.contains(e[0],e[2],t[0]))&&!(e[1]>t[3]||e[3]<t[1]):S.intersects(e,t)},a._rectInsideRect=function(e,t){return this._longitudeCyclical?this._longitudeCyclical.contains(t[0],t[2],e[0])&&this._longitudeCyclical.contains(t[0],t[2],e[2])&&e[1]>t[1]&&e[3]<t[3]:S.contains(t,e)},a._pointIsInExtent=function(e,t){if(this._longitudeCyclical)return this._longitudeCyclical.contains(t[0],t[2],e.x)&&e.y>=t[1]&&e.y<=t[3];const r=e.x,i=e.y;return r>t[0]&&r<t[2]&&i>t[1]&&i<t[3]},a._shiftExtentToFitBounds=function(e,t,r){let i=0,s=0;e[0]<-t?i=e[0]+t:e[2]>t&&(i=t-e[2]),e[1]<-r?s=e[1]+r:e[3]>r&&(s=r-e[3]),S.offset(e,i,s)},t._createClass(r,[{key:"_needsUpdate",get:function(){return(this._placementDirty||this._layerViewsDirty)&&(this._drapeSources.size>0||this.view.graphics.length>0||V.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._overlaySR&&!this.suspended&&this.surface.ready}},{key:"view",get:function(){return this.surface.view}},{key:"updating",get:function(){return this._needsUpdate||this.renderer.updating}},{key:"hasHighlights",get:function(){return this.renderer.hasHighlights}},{key:"rendersOccluded",get:function(){return this.renderer.rendersOccluded}},{key:"hasOverlays",get:function(){return this.renderer.hasOverlays}},{key:"test",get:function(){return{renderer:this.renderer,update:()=>this._updateOverlays()}}}]),r}(p),r.__decorate([o.property()],e.OverlayManager.prototype,"_overlaySR",void 0),r.__decorate([o.property({readOnly:!0})],e.OverlayManager.prototype,"_needsUpdate",null),r.__decorate([o.property()],e.OverlayManager.prototype,"_placementDirty",void 0),r.__decorate([o.property()],e.OverlayManager.prototype,"_layerViewsDirty",void 0),r.__decorate([o.property()],e.OverlayManager.prototype,"renderer",void 0),r.__decorate([o.property({constructOnly:!0})],e.OverlayManager.prototype,"surface",void 0),r.__decorate([o.property({readOnly:!0,aliasOf:"surface.suspended"})],e.OverlayManager.prototype,"suspended",void 0),r.__decorate([o.property({readOnly:!0})],e.OverlayManager.prototype,"updating",null),r.__decorate([o.property({type:Boolean})],e.OverlayManager.prototype,"hasHighlights",null),r.__decorate([o.property({type:Boolean})],e.OverlayManager.prototype,"rendersOccluded",null),e.OverlayManager=r.__decorate([l.subclass("esri.views.3d.terrain.OverlayManager")],e.OverlayManager);const N={width:0,height:0,pixelRatio:0,views:[{viewport:S.create(),extent:S.create()},{viewport:S.create(),extent:S.create()},{viewport:S.create(),extent:S.create()}],numViews:0,index:0},z=x.create(),j=g.create(),Y={inner:S.create(),outer:S.create()},X=S.create(),J=S.create(),K=I.ray.create();Object.defineProperty(e,"__esModule",{value:!0})}));
