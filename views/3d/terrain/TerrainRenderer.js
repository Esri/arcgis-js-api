// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../Color","../../../core/Accessor","../../../core/maybe","../../../core/ObjectPool","../../../core/PooledArray","../../../core/accessorSupport/decorators","../../../core/libs/gl-matrix-2/mat4","../../../core/libs/gl-matrix-2/mat4f64","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../../../core/libs/gl-matrix-2/vec4","../../../core/libs/gl-matrix-2/vec4f64","../../../geometry/support/aaBoundingBox","../support/imageUtils","../support/buffer/BufferView","./OverlayRenderer","./PatchGeometryFactory","./PatchRenderData","./TileRenderer","./tileUtils","../webgl-engine/core/shaderLibrary/Slice.glsl","../webgl-engine/core/shaderLibrary/shading/ScreenSpaceReflections.glsl","../webgl-engine/core/shaderLibrary/util/View.glsl","../webgl-engine/lib/glUtil3D","../webgl-engine/lib/intersectorUtils","../webgl-engine/lib/screenSizePerspectiveUtils","../webgl-engine/lib/tracer","../webgl-engine/materials/internal/MaterialUtil","../webgl-engine/shaders/TerrainTechnique"],(function(e,t,r,i,n,s,a,o,l,c,d,u,h,p,f,g,v,b,y,T,m,x,R,_,S,O,P,q,D,w,k,E){"use strict";var C=g.create(),U=f.vec4f64.create(),I=f.vec4f64.create(),N=f.vec4f64.create(),B=function(){this.extent=f.vec4f64.create(),this.minLevel=0,this.maxLevel=0,this.callback=null},A=function(e){function t(t){var r=e.call(this,t)||this;return r.type="Terrain",r.isGround=!0,r.tileSize=256,r.rctx=null,r._isTransparent=!1,r.renderDataPool=new a(m.PatchRenderData),r.patchGroups=new o({allocator:function(e){return e||{root:null,origin:null,patches:new o}},deallocator:function(e){return e.root=null,e.origin=null,e.patches.clear(),e}}),r.patchGroupsDirty=!0,r.patchGroupsMap=new Map,r.tileIterator=new R.IteratorPreorder,r.highestVisibleLODTile=null,r.visible=!0,r._opaque=!0,r._skirtScale=1,r._velvetOverground=!0,r.castShadows=!0,r._ssrEnabled=!1,r.emptyTex=null,r.tileRenderer=null,r.tileBackgroundInitialized=!1,r.tileBackgroundUpdating=!1,r.stencilEnabledLayerExtents=[],r.numTrianglesRendered=0,r.numTilesRendered=0,r.numTilesCulled=0,r.numOriginsRendered=0,r.clippingExtent=null,r.needsHighlight=!1,r.renderOccludedFlags=1,r.visibleScaleRangeQueries=new o({initialSize:10}),r.visibleScaleRangeQueriesInvPtr=0,r.visibleScaleRangeQueryQueue=new o({initialSize:30}),r.visibleScaleRangeQueryPool=new a(B),r}return r.__extends(t,e),t.prototype.destroy=function(){T.clearCaches()},t.prototype.install=function(e){e.addRenderPlugin([2,7,9],this)},t.prototype.uninstall=function(e){e.removeRenderPlugin(this)},Object.defineProperty(t.prototype,"updating",{get:function(){return!this.tileBackgroundInitialized||this.tileBackgroundUpdating},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"canRender",{get:function(){return this.visible&&!!this.rootTiles&&this.tileBackgroundInitialized&&!this.renderingDisabled},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"renderingDisabled",{set:function(e){this._set("renderingDisabled",!!e),this.setNeedsRender()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"opaque",{get:function(){return this._opaque&&!this.shaderTechniqueConfig.slicePlaneEnabled},set:function(e){this._opaque!==e&&(this._opaque=e,this.setNeedsRender())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"needsLinearDepth",{get:function(){return this.overlayRenderer.hasWater},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isTransparent",{get:function(){return this._isTransparent},set:function(e){this._isTransparent!==e&&(this._isTransparent=e,this.setNeedsRender())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"skirtScale",{get:function(){return this._skirtScale},set:function(e){e!==this._skirtScale&&(this._skirtScale=e,this.setNeedsRender())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"renderPatchBorders",{get:function(){return!!this.shaderTechniqueConfig.tileBorders},set:function(e){this.shaderTechniqueConfig.tileBorders!==e&&(this.shaderTechniqueConfig.tileBorders=e,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"cullBackFaces",{get:function(){return this.shaderTechniqueConfig.backfaceCullingEnabled},set:function(e){this.shaderTechniqueConfig.backfaceCullingEnabled!==e&&(this.shaderTechniqueConfig.backfaceCullingEnabled=e,this.notifyChange("cullBackFaces"),this.setNeedsRender())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"renderOrder",{set:function(e){this._set("renderOrder",e),this.setNeedsRender()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"velvetOverground",{set:function(e){this._velvetOverground!==e&&(this._velvetOverground=e,this.setNeedsRender())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"intersectionHandlerId",{get:function(){return q.TERRAIN_ID},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"slicePlane",{get:function(){return this.shaderTechniqueConfig.slicePlaneEnabled},set:function(e){this.shaderTechniqueConfig.slicePlaneEnabled!==e&&(this.shaderTechniqueConfig.slicePlaneEnabled=e,this.setNeedsRender())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"textureFadingEnabled",{set:function(e){this.shaderTechniqueConfig.textureFadingEnabled!==e&&(this.shaderTechniqueConfig.textureFadingEnabled=e,this.setNeedsRender())},enumerable:!1,configurable:!0}),t.prototype.setDebugScreenSizePerspective=function(e){this.shaderTechniqueConfig.screenSizePerspective!==e&&(this.shaderTechniqueConfig.screenSizePerspective=e,this.setNeedsRender())},t.prototype.setRootTiles=function(e){this.rootTiles=e,this.setNeedsRender()},t.prototype.setNeedsHighlight=function(e){this.needsHighlight=e,this.setNeedsRender()},t.prototype.setRenderOccludedOverlay=function(e){this.renderOccludedFlags=e?y.overlayRenderOccludedFlag:1,this.setNeedsRender()},t.prototype.setStencilEnabledLayerExtents=function(e){this.stencilEnabledLayerExtents=e,this.setNeedsRender()},t.prototype.setTileSize=function(e){this.tileSize=e,this.tileRenderer&&(this.tileRenderer.tileSize=e),this.setNeedsRender()},t.prototype.loadTile=function(e){e.renderData||(e.renderData=this.renderDataPool.acquire(),e.renderData.init(e),e.renderData.localOrigin=this._getLocalOriginOfTile(e)),this.updateTileGeometry(e),this.updateTileTexture(e)},t.prototype.queryVisibleLevelRange=function(e,t,r,i){var n=this.visibleScaleRangeQueryPool.acquire();p.vec4.copy(n.extent,e),n.minLevel=t||-Number.MAX_VALUE,n.maxLevel=null!=r?r:Number.MAX_VALUE,n.callback=i,this.visibleScaleRangeQueryQueue.push(n),this.setNeedsRender()},t.prototype.updateTileTexture=function(e){this.tileRenderer&&this.tileBackgroundInitialized&&(this.tileRenderer.updateTileTexture(e),this.setNeedsRender(),e.resetPendingUpdate(64))},t.prototype.updateTileGeometry=function(e){for(var t=0,r=e.layerInfo[0];t<r.length;t++){r[t].pendingUpdates&=-33}e.resetPendingUpdate(32),e.renderData.updateGeometry(this.rctx,this.wireframe)&&this.setNeedsRender()},t.prototype.unloadTile=function(e){e.renderData&&(this.releaseTileGeometry(e.renderData),e.renderData.clear(),e.renderData=null,e.setMemoryDirty(),this.setNeedsRender())},t.prototype._getLocalOriginOfTile=function(e){var t=Math.max(0,7*Math.floor((e.lij[0]-3)/7));if("spherical"===this.manifold&&0===t)return h.vec3f64.ZEROS;for(;e.parent&&e.lij[0]>t;)e=e.parent;return e.centerAtSeaLevel},t.prototype.setVisibility=function(e){this.visible=e,this.setNeedsRender()},t.prototype.getStats=function(){return{numTilesRendered:this.numTilesRendered,numTilesCulled:this.numTilesCulled,numTrianglesRendered:this.numTrianglesRendered,numOriginsRendered:this.numOriginsRendered}},Object.defineProperty(t.prototype,"wireframe",{set:function(e){var t=this;this._get("wireframe")!==e&&(this._set("wireframe",e),this.rootTiles&&(R.traverseTilesPreorder(this.rootTiles,(function(r){r.renderData&&r.renderData.updateGeometry(t.rctx,e)})),this.setNeedsRender()))},enumerable:!1,configurable:!0}),t.prototype.setNeedsRender=function(e){void 0===e&&(e=1),this.patchGroupsDirty=!0,this.initContext.requestRender(e)},t.prototype.setTileBackground=function(e){this.tileBackground=e,this._updateTileBackground()},t.prototype.initializeRenderContext=function(e){this.initContext=e,this.rctx=e.rctx,this.shaderTechniques=e.shaderTechniqueRep,this.shaderTechniqueConfig=new E.TerrainTechniqueConfiguration,this.tileRenderer=new x(this.rctx,this.tileSize,this.shaderTechniques),this.tileBackground&&this._updateTileBackground(),this.emptyTex=P.createEmptyTexture(this.rctx)},t.prototype.uninitializeRenderContext=function(){null!=this.emptyTex&&(this.emptyTex.dispose(),this.emptyTex=null),this.tileRenderer&&(this.tileRenderer.dispose(),this.tileRenderer=null)},t.prototype.intersect=function(e,t,r,i){if(this.rootTiles&&(!e.options.selectOpaqueTerrainOnly||!e.options.selectionMode||this._opaque)){var n=G,a=Q;u.vec3.subtract(n,i,r),u.vec3.set(a,1/n[0],1/n[1],1/n[2]);var o=e.results.min,l=e.results.max,c=e.results.ground,h=0===e.options.store,p=!!e.results.ground.target,f=null,v=this.clippingExtent,y=this.tileIterator;y.reset(this.rootTiles);for(var m=q.getVerticalOffsetTerrain(e.verticalOffset),x=function(){var x=y.next();if(null===x.renderData||p&&_._useStencilForTile(x))return"continue";if(e.options.invisibleTerrain){if(!x.visible&&v&&!x.intersectsExtent(v))return"continue"}else if(!x.visible)return"continue";var S=x.renderData.geometryInfo,O=x.renderData.localOrigin,P=-_._skirtScale*S.skirtLength;if(g.set(C,S.boundingBox),s.isSome(m)&&(m.localOrigin=O,m.applyToAabb(C)),0!==P){var D=x.up;g.expandWithOffset(C,P*D[0],P*D[1],P*D[2])}var w=C;u.vec3.subtract(z,r,O);var E=h&&null!=o.dist?o.dist:1/0;if(!k.intersectAabbInvDirBefore(w,z,a,e.tolerance,E))return"continue";var U=function(e,t,r,i){e.set(void 0,R.tile2str(t),r,i,d.mat4f64.IDENTITY,void 0),e.intersector=V,e.target={type:"external",metadata:{tile:t}}},I=function(a,d){if(a>=0&&(e.options.backfacesTerrain||u.vec3.dot(d,n)<0)&&(e.options.invisibleTerrain||!e.options.selectionMode||null==t||t(r,i,a))){if((null==c.dist||a<c.dist)&&U(c,x,a,d),e.options.isFiltered)return;2===e.options.store&&(s.isNone(f)?(f=new q.IntersectorResult(e.ray),U(f,x,a,d),e.results.all.push(f)):a<f.dist&&U(f,x,a,d)),(null==o.dist||a<o.dist)&&U(o,x,a,d),0!==e.options.store&&(null==l.dist||a>l.dist)&&U(l,x,a,d)}},N=j;u.vec3.subtract(N,i,O);var B=S.indices,A=S.vertexAttributes,F={data:A.getField("position",b.BufferViewVec3f).typedBuffer,size:3,offsetIdx:0,strideIdx:A.stride/4},M=S.numWithoutSkirtIndices/3;if(k.intersectTriangles(z,N,0,M,B,F,null,m,I),0!==P){var L="spherical"===_.manifold?function(e){return u.vec3.scale(e,e,P/u.vec3.length(e))}:function(e){return u.vec3.set(e,0,0,P)},G=B.length/3;T.intersectSkirts(z,N,M,G,B,A,L,m,I)}},_=this;!y.done;)x()}},t.prototype.render=function(e){if(9===e.slot){if(0==(e.renderOccludedMask&y.overlayRenderOccludedFlag))return!1}else{var t=this.opaque?2:7;if(e.slot!==t)return!1}w.trace("# BEGIN RENDER TERRAIN");var r=e.pass,i=1===e.scenelightingData.globalFactor,n=this._updatePatchGroups();switch(r){case 0:var s=e.shadowMap&&e.shadowMap.enabled;this.shaderTechniqueConfig.receiveShadows!==s&&(this.shaderTechniqueConfig.receiveShadows=s);var a=this.overlayRenderer.isEmpty()?0:this.overlayRenderer.hasWater?2:1;this.shaderTechniqueConfig.overlayMode!==a&&(this.shaderTechniqueConfig.overlayMode=a);var o=9===e.slot?"occluded":"colorAndWater";this._renderMaterialPass(e,0,n,o);break;case 3:this.castShadows&&i&&this._renderAuxiliaryPass(e,3,n,"none");break;case 1:this.isTransparent&&this.overlayRenderer.isEmpty()||this._renderAuxiliaryPass(e,1,n,"none");break;case 2:this._renderAuxiliaryPass(e,2,n,"none");break;case 4:this.needsHighlight&&(this._renderAuxiliaryPass(e,4,n,"highlight"),e.rctx.clearSafe(256))}return w.trace("# END RENDER TERRAIN"),0!==this.visibleScaleRangeQueryQueue.length&&this.setNeedsRender(),!0},t.prototype._renderMaterialPass=function(e,t,r,i){var n=this,s=e.rctx,a=e.camera;this._ssrEnabled=e.ssrParams.ssrEnabled,this._setTerrainTechnique(t,"occluded"===i);var o=this.shaderTechnique.program;e.rctx.bindProgram(o),s.bindProgram(o),"colorAndWater"===i&&e.ssrParams&&(e.ssrParams.lastFrameColorTextureID=9,e.ssrParams.linearDepthTextureID=8,S.ScreenSpaceReflections.bindUniforms(o,s,e.ssrParams)),e.shadowMap&&e.shadowMap.bind(o,7),e.ssaoHelper&&e.ssaoHelper.setUniforms(o,6),o.setUniform1i("tex",0),o.setUniform1i("texNext",1),this._bindOverlayUniforms(o),o.setUniformMatrix4fv("viewNormal",a.viewInverseTransposeMatrix),O.View.bindProjectionMatrix(o,a.projectionMatrix),e.scenelightingData.setUniforms(o,!0);var l=a.viewMatrix;u.vec3.set(L,l[12],l[13],l[14]),u.vec3.normalize(L,L),o.setUniform3fv("viewDirection",L),this.numTilesRendered=0,this.numTilesCulled=0,this.numTrianglesRendered=0,this.numOriginsRendered=0,this._prepareScaleRangeQueries(),this.opaque?this._renderPatchGroups(e,o,r,i):e.offscreenRenderingHelper.renderToTargets((function(){return n._renderPatchGroups(e,o,r,i)}),e.offscreenRenderingHelper.tmpColor,e.offscreenRenderingHelper.mainDepth,[0,0,0,0]),this._processScaleRangeQueries()},t.prototype._renderAuxiliaryPass=function(e,t,r,i){this._setTerrainTechnique(t,"occluded"===i);var n=this.shaderTechnique.program;if(e.rctx.bindProgram(n),4===e.pass){var s=e.offscreenRenderingHelper;e.rctx.bindTexture(s.depthTexture,6),n.setUniform1i("depthTex",6),n.setUniform4f("highlightViewportPixelSz",0,0,1/s.width,1/s.height)}else n.setUniformMatrix4fv("viewNormal",e.camera.viewInverseTransposeMatrix),1!==e.pass&&3!==e.pass||n.setUniform2fv("nearFar",e.camera.nearFar);this._renderPatchGroupsAuxiliary(e,n,r,i)},t.prototype._updateTileBackground=function(){var e=this;if(this.tileRenderer){this.tileBackgroundUpdating=!0;var t=function(){e.tileBackgroundInitialized=!0,e.tileBackgroundUpdating=!1,e.rootTiles&&R.traverseTilesPreorder(e.rootTiles,(function(t){e.tileRenderer.updateTileTexture(t),e.setNeedsRender()})),e.setNeedsRender()};if("string"==typeof this.tileBackground){var r=this.tileBackground;v.requestImage(r).then((function(i){r===e.tileBackground&&e.tileRenderer&&(e.tileRenderer.setBackground(i),t())}))}else{var n=this.tileBackground?i.toUnitRGBA(this.tileBackground):[0,0,0,0];this.tileRenderer.setBackground(n),t()}}},t.prototype._updatePatchGroups=function(){var e=this,t=this.patchGroups;if(!this.patchGroupsDirty)return t;if(this.highestVisibleLODTile=null,this._renderCollectOrigins(t),0!==this.renderOrder){for(var r=0;r<t.length;r++)R.sortTiles(this.renderOrder,t.data[r].patches);t.sort((function(t,r){return function(e,t,r){if(0===e.patches.length)return-r;if(0===t.patches.length)return r;return R.compareTiles(e.patches.data[0],t.patches.data[0],r)}(t,r,e.renderOrder)}))}return this.patchGroupsDirty=!1,t},t.prototype._renderCollectOrigins=function(e){var t=this.rootTiles,r="spherical"===this.manifold;e.clear();for(var i=0,n=t;i<n.length;i++){var s=n[i],a=e.pushNew();a.root=s,a.origin=r?h.vec3f64.ZEROS:s.centerAtSeaLevel,a.patches.clear(),this._renderCollectOriginsForRoot(e,a)}e.filterInPlace((function(e){return e.patches.length>0}))},t.prototype._renderCollectOriginsForRoot=function(e,t){var r=this.tileIterator;r.resetOne(t.root);var i=this.patchGroupsMap;for(i.clear(),i.set(t.origin,t);!r.done;){var n=r.next(),s=n.renderData;if(!s||n.visible){var a;if(n.lij[0]%7==0)(a=e.pushNew()).root=n,a.origin=n.centerAtSeaLevel,i.set(n.centerAtSeaLevel,a),a.patches.clear();if(n.rendered){if(s)(a=i.get(s.localOrigin))&&a.patches.push(n),(!this.highestVisibleLODTile||n.vlevel>this.highestVisibleLODTile.vlevel)&&(this.highestVisibleLODTile=n),r.skipSubtree()}else this.numTilesCulled++}else this.numTilesCulled++,r.skipSubtree()}},t.prototype._scaleQueriesForTile=function(e){for(var t=e.extent,r=e.lij[0],i=0;i<this.visibleScaleRangeQueriesInvPtr;){var n=this.visibleScaleRangeQueries.data[i],s=n.extent;r>=n.minLevel&&r<=n.maxLevel&&s[0]<=t[2]&&s[2]>=t[0]&&s[1]<=t[3]&&s[3]>=t[1]?(this.visibleScaleRangeQueries.swapElements(i,this.visibleScaleRangeQueriesInvPtr-1),this.visibleScaleRangeQueriesInvPtr--):i++}},t.prototype._useStencilForTile=function(e){for(var t=0,r=this.stencilEnabledLayerExtents;t<r.length;t++){var i=r[t];if(e.intersectsExtent(i))return!0}return!1},t.prototype._renderPatchGroupsAuxiliary=function(e,t,r,i){this.shaderTechnique.bindPipelineState(e.rctx);var n=this.stencilEnabledLayerExtents.length>0;t.setUniformMatrix4fv("proj",e.camera.projectionMatrix),t.setUniform1f("skirtScale",this._skirtScale),"none"!==i&&this._bindOverlayUniforms(t);for(var s=0;s<r.length;s++){var a=r.data[s];this._bindViewForPatchGroup(t,a,e.camera.eye,e.camera.viewMatrix);for(var o=0;o<a.patches.length;o++)this._renderPatch(e.rctx,t,a.patches.data[o],4,n,i)}e.rctx.bindVAO(null)},t.prototype._renderPatchGroups=function(e,t,r,i){var n=e.rctx,a=e.camera,o=a.viewMatrix;if(this.shaderTechnique.bindPipelineState(n),this.shaderTechniqueConfig.screenSizePerspective&&this.pointsOfInterest){var l=D.getSettings("spherical"===this.manifold?1:2),c=this.pointsOfInterest.centerOnSurfaceFrequent.distance;l.update({distance:c,fovY:a.fovY}),k.bindScreenSizePerspective(l,t,"screenSizePerspective")}var d=this.stencilEnabledLayerExtents.length>0,u="occluded"===i;u&&(n.bindTexture(this.emptyTex,0),t.setUniform1f("blend",1),t.setUniform4fv("texOffsetAndScale",f.vec4f64.ZEROS));var h=u?0:this._skirtScale;t.setUniform1f("skirtScale",h);for(var p=this.wireframe?1:4,g=0;g<r.length;g++){var v=r.data[g],b=v.patches;if(0!==b.length){this._bindViewForPatchGroup(t,v,a.eye,o);var y=e.sliceHelper&&e.sliceHelper.plane;_.Slice.bindUniforms(t,this.shaderTechnique.configuration,y,v.origin),e.shadowMap&&e.shadowMap.bindView(t,v.origin),this.numOriginsRendered++;for(var T=0;T<b.length;T++){var m=b.data[T],x=m.renderData.textureReference;if(!s.isNone(x)){if(w.trace("# RENDER TILE "+R.tile2str(m)+", screenDepth:"+m.screenDepth),!u){this._scaleQueriesForTile(m),F(m.renderData.geometryInfo.uvOffsetAndScale,x.offsetAndScale,N),t.setUniform4fv("texOffsetAndScale",N),n.bindTexture(x.texture.texture,0);var S=m.renderData.textureFadeFactor,O=S<1?m.renderData.nextTextureReference:null;this.shaderTechniqueConfig.textureFadingEnabled&&s.isSome(O)?(F(m.renderData.geometryInfo.uvOffsetAndScale,O.offsetAndScale,N),t.setUniform1f("textureFadeFactor",S),t.setUniform4fv("nextTexOffsetAndScale",N),n.bindTexture(O.texture.texture,1)):(t.setUniform1f("textureFadeFactor",1),n.bindTexture(this.emptyTex,1)),m.renderData.textureIsFading&&this.setNeedsRender(),t.setUniform1f("opacity",m.renderData.opacity)}var P=this._renderPatch(n,t,m,p,d,i);m.renderOrder=this.numTilesRendered,this.numTilesRendered++,this.numTrianglesRendered+=P/3}}}}n.bindVAO(null)},t.prototype._renderPatch=function(e,t,r,i,n,s){"none"!==s&&(this._bindOverlayTextures(t,r.renderData.overlays,s),t.setUniform1f("overlayOpacity",r.renderData.overlayOpacity)),n&&(this._useStencilForTile(r)?this.stencilShaderTechnique.bindPipelineState(e):this.shaderTechnique.bindPipelineState(e));var a=0===this._skirtScale?r.renderData.geometryInfo.numWithoutSkirtIndices:r.renderData.vao.indexBuffer.size;return e.bindVAO(r.renderData.vao),t.assertCompatibleVertexAttributeLocations(r.renderData.vao),e.drawElements(i,a,r.renderData.vao.indexBuffer.indexType,0),a},t.prototype._bindViewForPatchGroup=function(e,t,r,i){e.setUniform3fv("origin",t.origin),c.mat4.translate(M,i,t.origin),e.setUniformMatrix4fv("view",M),e.setUniform3f("camPos",r[0]-t.origin[0],r[1]-t.origin[1],r[2]-t.origin[2])},t.prototype._bindOverlayUniforms=function(e){e.setUniform1i("ovInnerColorTex",2),e.setUniform1i("ovOuterColorTex",3),e.setUniform1i("ovInnerWaterTex",4),e.setUniform1i("ovOuterWaterTex",5)},t.prototype._bindOverlayTextures=function(e,t,r){for(var i=0;i<2;i++){var n=2*i,s=t[i];if(s.overlay){var a="colorAndWater"===r?s.overlay.renderTargets.color:"highlight"===r?s.overlay.renderTargets.highlight:s.overlay.renderTargets.occluded,o="colorAndWater"===r?s.overlay.renderTargets.water:null;U[n]=s.texOffset[0],U[n+1]=s.texOffset[1],I[n]=s.texScale[0],I[n+1]=s.texScale[1];var l=a.fbo.getTexture();if(this.rctx.bindTexture(l,2+i),o){var c=o.fbo.getTexture();this.rctx.bindTexture(c,4+i)}else this.rctx.bindTexture(this.emptyTex,4+i)}else U[n]=0,U[n+1]=0,I[n]=0,I[n+1]=0,this.rctx.bindTexture(this.emptyTex,2+i),this.rctx.bindTexture(this.emptyTex,4+i)}e.setUniform4fv("overlayTexOffset",U),e.setUniform4fv("overlayTexScale",I)},t.prototype._setTerrainTechnique=function(e,t){if(this.shaderTechniqueConfig.output=e,0===e){var r="spherical"===this.manifold;this.shaderTechniqueConfig.atmosphere=r&&this._velvetOverground,this.shaderTechniqueConfig.ssrEnabled=this._ssrEnabled}this.shaderTechniqueConfig.renderOccluded=t,this.shaderTechniqueConfig.stencilEnabled=!1,this.shaderTechnique=this.shaderTechniques.acquireAndReleaseExisting(E.TerrainTechnique,this.shaderTechniqueConfig,this.shaderTechnique),this.shaderTechniqueConfig.stencilEnabled=!0,this.stencilShaderTechnique=this.shaderTechniques.acquireAndReleaseExisting(E.TerrainTechnique,this.shaderTechniqueConfig,this.stencilShaderTechnique)},t.prototype.releaseTileGeometry=function(e){e.releaseGeometry()&&this.setNeedsRender(),this.renderDataPool.release(e)},t.prototype._prepareScaleRangeQueries=function(){for(var e=this.visibleScaleRangeQueries,t=this.visibleScaleRangeQueryQueue;e.length<e.data.length&&t.length>0;){var r=t.pop();e.push(r)}this.visibleScaleRangeQueriesInvPtr=e.length},t.prototype._processScaleRangeQueries=function(){for(var e=this.visibleScaleRangeQueries,t=this.visibleScaleRangeQueryPool,r=0;r<e.length;r++){var i=e.data[r];t.release(i),i.callback(r>=this.visibleScaleRangeQueriesInvPtr),i.callback=null}e.clear()},Object.defineProperty(t.prototype,"test",{get:function(){return{tileRenderer:this.tileRenderer}},enumerable:!1,configurable:!0}),r.__decorate([l.property()],t.prototype,"tileBackgroundInitialized",void 0),r.__decorate([l.property()],t.prototype,"tileBackgroundUpdating",void 0),r.__decorate([l.property({constructOnly:!0})],t.prototype,"manifold",void 0),r.__decorate([l.property({constructOnly:!0})],t.prototype,"overlayRenderer",void 0),r.__decorate([l.property({readOnly:!0,dependsOn:["tileBackgroundInitialized","tileBackgroundUpdating"]})],t.prototype,"updating",null),r.__decorate([l.property({value:!1})],t.prototype,"renderingDisabled",null),r.__decorate([l.property()],t.prototype,"renderPatchBorders",null),r.__decorate([l.property()],t.prototype,"cullBackFaces",null),r.__decorate([l.property({value:1})],t.prototype,"renderOrder",null),r.__decorate([l.property()],t.prototype,"wireframe",null),t=r.__decorate([l.subclass("esri.views.3d.terrain.TerrainRenderer")],t)}(n);function F(e,t,r){var i=e[0]*t[2]+t[0],n=e[1]*t[3]+t[1],s=e[2]*t[2],a=e[3]*t[3];p.vec4.set(r,i,n,s,a)}var M=d.mat4f64.create(),L=h.vec3f64.create(),G=h.vec3f64.create(),Q=h.vec3f64.create(),z=h.vec3f64.create(),j=h.vec3f64.create(),V="TerrainRenderer";return A}));