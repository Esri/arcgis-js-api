/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import t from"../../../Color.js";import i from"../../../core/Accessor.js";import{isSome as r,disposeMaybe as s,isNone as n}from"../../../core/maybe.js";import a from"../../../core/ObjectPool.js";import{property as o}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/arrayUtils.js";import"../../../core/has.js";import"../../../core/accessorSupport/ensureType.js";import{subclass as l}from"../../../core/accessorSupport/decorators/subclass.js";import{I as d}from"../../../chunks/mat4f64.js";import{b as h,s as c,e as u}from"../../../chunks/vec3.js";import{Z as p,f,c as g}from"../../../chunks/vec3f64.js";import{Z as m,c as _}from"../../../chunks/vec4f64.js";import{create as T,set as b}from"../../../geometry/support/aaBoundingBox.js";import{BufferViewVec3f as R}from"../../../geometry/support/buffer/BufferView.js";import{ViewingMode as y}from"../../ViewingMode.js";import{TextureUpdate as A}from"./interfaces.js";import{LayerClass as O}from"./LayerClass.js";import{OverlaySource as v}from"./Overlay.js";import{overlayRenderOccludedFlag as x}from"./OverlayRenderer.js";import{clearCaches as P}from"./PatchGeometry.js";import{PatchRenderData as C}from"./PatchRenderData.js";import{RenderOrder as E}from"./RenderOrder.js";import{ScaleRangeQueries as D}from"./ScaleRangeQueries.js";import"./terrainUtils.js";import{TileRenderer as q}from"./TileRenderer.js";import{TileUpdate as S}from"./TileUpdate.js";import{IteratorPreorder as N,sortTiles as I,compareTiles as w}from"./tileUtils.js";import{componentMinimalSizeForIntersectionData as L,ComponentIntersectionData as G}from"../webgl-engine/collections/Component/ComponentIntersectionData.js";import{ShaderOutput as j}from"../webgl-engine/core/shaderLibrary/ShaderOutputOptions.js";import{OverlayMode as F}from"../webgl-engine/core/shaderLibrary/terrain/Overlay.glsl.js";import{T as M}from"../../../chunks/Terrain.glsl.js";import{TileBlendInput as U}from"../webgl-engine/core/shaderLibrary/terrain/TileBlendInput.js";import{RenderRequestType as k}from"../webgl-engine/lib/basicInterfaces.js";import{createEmptyTexture as H}from"../webgl-engine/lib/glUtil3D.js";import{newIntersectorResult as B}from"../webgl-engine/lib/Intersector.js";import{IntersectorType as V,StoreResults as z}from"../webgl-engine/lib/IntersectorInterfaces.js";import{RenderOccludedFlag as Q}from"../webgl-engine/lib/Material.js";import{RenderPass as W}from"../webgl-engine/lib/RenderPass.js";import{RenderSlot as Y}from"../webgl-engine/lib/RenderSlot.js";import{getSettings as X}from"../webgl-engine/lib/screenSizePerspectiveUtils.js";import{VertexAttribute as Z}from"../webgl-engine/lib/VertexAttribute.js";import{TERRAIN_ID as K,getVerticalOffsetTerrain as J}from"../webgl-engine/lib/verticalOffsetUtils.js";import{DrawParameters as $}from"../webgl-engine/materials/DrawParameters.js";import{intersectAabbInvDirBefore as ee,intersectTriangles as te}from"../webgl-engine/materials/internal/MaterialUtil.js";import{TerrainTechnique as ie}from"../webgl-engine/shaders/TerrainTechnique.js";import{TerrainTechniqueConfiguration as re}from"../webgl-engine/shaders/TerrainTechniqueConfiguration.js";import{ClearBufferBit as se,PrimitiveType as ne}from"../../webgl/enums.js";const ae=7,oe=10,le=T(),de=_();let he=class extends i{constructor(e){super(e),this.type=V.TERRAIN,this.isGround=!0,this.tileSize=256,this._techniqueConfiguration=new re,this._passParameters=new M,this.rctx=null,this._isTransparent=!1,this._scaleRangeQueries=new D,this.renderDataPool=new a(C),this._patchGroups=new Map,this.patchGroupsDirty=!0,this.tileIterator=new N,this.highestVisibleLODTile=null,this.visible=!0,this._opaque=!0,this._velvetOverground=!0,this._castShadows=!0,this.emptyTex=null,this.tileRenderer=null,this.stencilEnabledLayerExtents=[],this.numTilesRendered=0,this.numTilesCulled=0,this.numOriginsRendered=0,this.needsHighlight=!1,this.renderOccludedFlags=Q.Occlude}get isGlobal(){return this.stage.viewingMode===y.Global}get shadingEnabled(){return this._techniqueConfiguration?.shading}initialize(){const e=[Y.OPAQUE_TERRAIN,Y.TRANSPARENT_TERRAIN,Y.OCCLUDED_TERRAIN];this.stage.addRenderPlugin(e,this)}destroy(){this.stage.removeRenderPlugin(this),P()}get canRender(){return this.visible&&!!this._rootTiles&&!this.renderingDisabled}set renderingDisabled(e){this._set("renderingDisabled",!!e),this.setNeedsRender()}set opaque(e){this._opaque!==e&&(this._opaque=e,this.setNeedsRender())}get opaque(){return this._opaque&&!this._techniqueConfiguration.hasSlicePlane}get needsLinearDepth(){return this.overlayRenderer.hasWater}set isTransparent(e){this._isTransparent!==e&&(this._isTransparent=e,this.setNeedsRender())}get isTransparent(){return this._isTransparent}get renderPatchBorders(){return!!this._techniqueConfiguration.tileBorders}set renderPatchBorders(e){this._techniqueConfiguration.tileBorders!==e&&(this._techniqueConfiguration.tileBorders=e,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))}get cullBackFaces(){return this._techniqueConfiguration.backfaceCullingEnabled}set cullBackFaces(e){this._techniqueConfiguration.backfaceCullingEnabled!==e&&(this._techniqueConfiguration.backfaceCullingEnabled=e,this.notifyChange("cullBackFaces"),this.setNeedsRender())}set renderOrder(e){this._set("renderOrder",e),this.setNeedsRender()}set velvetOverground(e){this._velvetOverground!==e&&(this._velvetOverground=e,this.setNeedsRender())}get layerUid(){return K}get slicePlaneEnabled(){return this._techniqueConfiguration.hasSlicePlane}set slicePlaneEnabled(e){this._techniqueConfiguration.hasSlicePlane!==e&&(this._techniqueConfiguration.hasSlicePlane=e,this.setNeedsRender())}set textureFadingEnabled(e){this._techniqueConfiguration.textureFadingEnabled!==e&&(this._techniqueConfiguration.textureFadingEnabled=e,this.setNeedsRender())}setDebugScreenSizePerspective(e){this._techniqueConfiguration.screenSizePerspective!==e&&(this._techniqueConfiguration.screenSizePerspective=e,this.setNeedsRender())}toggleShading(){this._techniqueConfiguration.shading=!this._techniqueConfiguration.shading,this.setNeedsRender()}setRootTiles(e){this._rootTiles=e,this.setNeedsRender()}setNeedsHighlight(e){this.needsHighlight=e,this.setNeedsRender()}setRenderOccludedOverlay(e){this.renderOccludedFlags=e?x:Q.Occlude,this.setNeedsRender()}setStencilEnabledLayerExtents(e){this.stencilEnabledLayerExtents=e,this.setNeedsRender()}setTileSize(e){this.tileSize=e,r(this.tileRenderer)&&(this.tileRenderer.tileSize=e),this.setNeedsRender()}_prepareTileForLoading(e){e.renderData||(e.renderData=this.renderDataPool.acquire(),e.renderData.init(e),e.renderData.localOrigin=this._getLocalOriginOfTile(e))}loadTile(e){this._prepareTileForLoading(e),this.updateTileGeometry(e),this.updateTileTexture(e,S.TEXTURE_FADING)}queryVisibleLevelRange(e,t,i,r){this._scaleRangeQueries.queryVisibleLevelRange(e,t,i,r),this.setNeedsRender()}updateTileTexture(e,t){r(this.tileRenderer)&&(this.tileRenderer.updateTileTexture(e,t===S.TEXTURE_FADING?A.FADING:A.UNFADED),this.setNeedsRender(),e.resetPendingUpdate(t))}updateTileGeometryState(e){this._prepareTileForLoading(e),e.renderData.updateGeometryStateAndPrepareForGeometryGeneration(this.wireframe)}updateTileGeometry(e){for(const t of e.layerInfo[O.ELEVATION])t.pendingUpdates&=~S.GEOMETRY;e.resetPendingUpdate(S.GEOMETRY);e.renderData.updateGeometryIfChanged(this.rctx,this.wireframe)&&this.setNeedsRender()}unloadTile(e){const t=e.renderData;t&&(t.releaseGeometry(),this.renderDataPool.release(t),t.clear(),e.renderData=null,e.setMemoryDirty(),this.setNeedsRender())}_getLocalOriginOfTile(e){const t=oe-ae,i=Math.max(0,Math.floor((e.level-t)/ae)*ae);if(this.isGlobal&&0===i)return p;for(;e.parent&&e.level>i;)e=e.parent;return e.centerAtSeaLevel}setVisibility(e){this.visible=e,this.setNeedsRender()}getStats(){return{numTilesRendered:this.numTilesRendered,numTilesCulled:this.numTilesCulled,numOriginsRendered:this.numOriginsRendered}}set wireframe(e){this._get("wireframe")!==e&&(this._set("wireframe",e),this.allTiles.forAll((e=>{e.isLoaded&&(this.updateTileGeometry(e),e.updateNeighborsAfterGeometryChange())})),this.setNeedsRender())}setNeedsRender(e=k.UPDATE){this.patchGroupsDirty=!0,this._context.requestRender(e)}initializeRenderContext(e){this._context=e,this.rctx=e.renderContext.rctx,this._techniqueRepository=e.shaderTechniqueRepository,this.tileRenderer=new q(this.rctx,this.tileSize,this._techniqueRepository),this.updateTileBackground(),this.emptyTex=H(this.rctx)}uninitializeRenderContext(){this.emptyTex=s(this.emptyTex),this.tileRenderer=s(this.tileRenderer)}intersect(e,t,i,s){if(!this._rootTiles||e.options.selectOpaqueTerrainOnly&&e.options.selectionMode&&!this._opaque)return;const a=pe,o=fe;h(a,s,i),c(o,1/a[0],1/a[1],1/a[2]);const l=e.results.min,p=e.results.max,f=e.results.ground,g=e.options.store===z.MIN,m=!!e.results.ground.target,_=J(e.verticalOffset),T=e.tolerance;let y,A=g&&r(l.dist)?l.dist:1/0;const O=c=>{const m=c.renderData;if(!m?.vao)return;const O=m.geometryInfo;b(le,O.boundingBox);const v=m.localOrigin;r(_)&&(_.localOrigin=v,_.applyToAabb(le));const x=le;if(ge[0]=i[0]-v[0],ge[1]=i[1]-v[1],ge[2]=i[2]-v[2],!ee(x,ge,o,T,A))return;const P=(e,t,i)=>{e.set(this.type,c,t,i,d),A=g&&r(l.dist)?l.dist:1/0},C=(o,d)=>{if(r(d)&&o>=0&&(e.options.backfacesTerrain||u(d,a)<0)&&(e.options.invisibleTerrain||!e.options.selectionMode||null==t||t(i,s,o))){if((null==f.dist||o<f.dist)&&P(f,o,d),e.options.isFiltered)return;e.options.store===z.ALL&&(n(y)?(y=B(e.ray),P(y,o,d),e.results.all.push(y)):o<y.dist&&P(y,o,d)),(null==l.dist||o<l.dist)&&P(l,o,d),e.options.store!==z.MIN&&(null==p.dist||o>p.dist)&&P(p,o,d)}},E=me;h(E,s,v);const D=O.indices,q=O.vertexAttributes,S={data:q.getField(Z.POSITION,R).typedBuffer,size:3,stride:q.stride/4},N=O.indexCount/3;if(n(_)&&N>L){const e=c.renderData;n(e.intersectionData)&&(e.intersectionData=new G(D,0,N,S)),e.intersectionData.intersectRay({r0:ge,r1:E},C)}else te(ge,E,0,N,D,S,null,_,C)},v=this._rootTiles;if(r(v)){(()=>{const t=this.tileIterator;t.reset(v);const s=e.options.invisibleTerrain;for(;!t.done;){const e=t.next();!(e.visible||s&&e.intersectsClippingArea)||!r(_)&&!e.intersectsRay(i,a,T,A)||m&&this._useStencilForTile(e)?t.skipSubtree():O(e)}})()}}prepareTechnique(e){if(e.bindParameters.slot===Y.OCCLUDED_TERRAIN){if(0==(e.renderOccludedMask&x))return null}else{const t=this.opaque?Y.OPAQUE_TERRAIN:Y.TRANSPARENT_TERRAIN;if(e.bindParameters.slot!==t)return null}switch(e.pass){case W.MATERIAL:{this._techniqueConfiguration.hasScreenSpaceReflections=e.bindParameters.ssr.enabled,this._techniqueConfiguration.hasCloudsReflections=r(e.bindParameters.clouds.data),this._techniqueConfiguration.receiveShadows=e.bindParameters.shadowMap.ready,this._techniqueConfiguration.receiveAmbientOcclusion=e.bindParameters.ssaoHelper.ready,this._techniqueConfiguration.overlayMode=this.overlayRenderer.isEmpty()?F.Disabled:this.overlayRenderer.hasWater?F.EnabledWithWater:F.Enabled;const t=e.bindParameters.slot===Y.OCCLUDED_TERRAIN?v.Occluded:v.ColorAndWater;return this._updateTechnique(j.Color,t===v.Occluded)}case W.MATERIAL_DEPTH_SHADOWMAP_ALL:case W.MATERIAL_DEPTH_SHADOWMAP_DEFAULT:return this._castShadows&&1===e.bindParameters.lighting.globalFactor?(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(j.Shadow,!1)):null;case W.MATERIAL_DEPTH:return this.isTransparent&&this.overlayRenderer.isEmpty()?null:(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(j.Depth,!1));case W.MATERIAL_NORMAL:return this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(j.Normal,!1);case W.MATERIAL_HIGHLIGHT:return this.needsHighlight?(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(j.Highlight,!1)):null}return null}render(e,t){const i=e.pass,r=1===e.bindParameters.lighting.globalFactor;switch(this._updatePatchGroups(),t.useStencil=!1,i){case W.MATERIAL:{const i=e.bindParameters.slot===Y.OCCLUDED_TERRAIN?v.Occluded:v.ColorAndWater;this._renderMaterialPass(e,t,i);break}case W.MATERIAL_DEPTH_SHADOWMAP_ALL:case W.MATERIAL_DEPTH_SHADOWMAP_DEFAULT:this._castShadows&&r&&this._renderAuxiliaryPass(e,t,v.None);break;case W.MATERIAL_DEPTH:this.isTransparent&&this.overlayRenderer.isEmpty()||this._renderAuxiliaryPass(e,t,v.None);break;case W.MATERIAL_NORMAL:this._renderAuxiliaryPass(e,t,v.None);break;case W.MATERIAL_HIGHLIGHT:this.needsHighlight&&(this._renderAuxiliaryPass(e,t,v.Highlight),e.rctx.clearSafe(se.DEPTH_BUFFER_BIT))}this._scaleRangeQueries.hasPendingQueries()&&this.setNeedsRender()}_renderMaterialPass(e,t,i){const{rctx:r}=e;this._passParameters.overlaySource=i,r.bindTechnique(t,this._passParameters,e.bindParameters),this.numTilesRendered=0,this.numTilesCulled=0,this.numOriginsRendered=0,this._scaleRangeQueries.prepareQueries(),this.opaque?this._renderPatchGroups(e,t,i):e.offscreenRenderingHelper.renderToTargets((()=>this._renderPatchGroups(e,t,i)),e.offscreenRenderingHelper.tmpColor,e.offscreenRenderingHelper.mainDepth,[0,0,0,0]),this._scaleRangeQueries.processQueries()}_renderAuxiliaryPass(e,t,i){const r=e.rctx;this._passParameters.overlaySource=i,r.bindTechnique(t,this._passParameters,e.bindParameters),this._renderPatchGroupsAuxiliary(e,t,i)}updateTileBackground(e=null){if(n(this.tileRenderer))return;const i=this.tileRenderer;let s=null;if(r(e)){const i=t.toUnitRGBA(e);s=f(i[0]||0,i[1]||0,i[2]||0)}i.setBackground(s),this.allTiles.forAll((e=>i.updateTileTexture(e,A.FADING))),this._techniqueConfiguration.tileBlendInput=i.backgroundIsGrid?U.GridComposite:r(i.backgroundColor)?U.ColorComposite:U.LayerOnly,this.setNeedsRender()}_updatePatchGroups(){if(this.patchGroupsDirty){if(this.highestVisibleLODTile=null,this._rebuildPatchGroups(),this.renderOrder!==E.NONE){const e=Array.from(this._patchGroups.values());e.forEach((e=>I(this.renderOrder,e))),e.sort(((e,t)=>w(e[0],t[0],this.renderOrder))),this._patchGroups=new Map(e.map((e=>[e[0].renderData.localOrigin,e])))}this.patchGroupsDirty=!1}}_rebuildPatchGroups(){const e=this._rootTiles;if(!n(e)){e[0]?.surface.checkAllTileWaterproofness(),this._patchGroups.clear();for(const t of e)this._rebuildPatchGroupsForRootTile(t)}}_rebuildPatchGroupsForRootTile(e){const t=this.tileIterator;for(t.resetOne(e);!t.done;){const e=t.next(),i=e.renderData;if(!i||e.visible)if(e.rendered){if(i){const r=this._patchGroups.get(i.localOrigin)||new Array;this._patchGroups.set(i.localOrigin,r),r.push(e),(!this.highestVisibleLODTile||e.vlevel>this.highestVisibleLODTile.vlevel)&&(this.highestVisibleLODTile=e),t.skipSubtree()}}else this.numTilesCulled++;else this.numTilesCulled++,t.skipSubtree()}}_useStencilForTile(e){for(const t of this.stencilEnabledLayerExtents)if(e.intersectsExtent(t))return!0;return!1}_renderPatchGroupsAuxiliary(e,t,i){const r=this.stencilEnabledLayerExtents.length>0;this._patchGroups.forEach((s=>{const n=s[0].renderData.localOrigin;t.program.bindDraw(new $(n),e.bindParameters);for(let a=0;a<s.length;a++)this._renderPatch(e,t,s[a],ne.TRIANGLES,r,i)})),e.rctx.bindVAO(null)}_renderPatchGroups(e,t,i){const s=e.rctx,a=e.bindParameters.camera,o=t.program;if(this._techniqueConfiguration.screenSizePerspective&&this.pointsOfInterest){const e=X(this.stage.viewingMode,this.ellipsoidRadius),t=this.pointsOfInterest.centerOnSurfaceFrequent.distance;e.update({distance:t,fovY:a.fovY})}const l=this.stencilEnabledLayerExtents.length>0,d=i===v.Occluded;d&&(o.bindTexture("tex",this.emptyTex),o.setUniform1f("blend",1),o.setUniform4fv("texOffsetAndScale",m));const h=r(this.tileRenderer)&&r(this.tileRenderer.backgroundColor)?this.tileRenderer.backgroundColor:p;this._techniqueConfiguration.tileBlendInput===U.ColorComposite&&o.setUniform3fv("backgroundColor",h);const c=this.wireframe?ne.LINES:ne.TRIANGLES;this._techniqueConfiguration.textureFadingEnabled&&o.bindTexture("texNext",this.emptyTex),this._patchGroups.forEach((s=>{const a=s[0].renderData.localOrigin;t.program.bindDraw(new $(a),e.bindParameters),this.numOriginsRendered++;for(let h=0;h<s.length;h++){const a=s[h],u=a.renderData.textureReference;if(!n(u)){if(!d){this._scaleRangeQueries.scaleQueriesForTile(a),ue(a.renderData.geometryInfo.uvOffsetAndScale,u.offsetAndScale,de),o.setUniform4fv("texOffsetAndScale",de),o.bindTexture("tex",u.texture.texture);const e=a.renderData.textureFadeFactor,t=e<1?a.renderData.nextTextureReference:null;this._techniqueConfiguration.textureFadingEnabled&&r(t)&&e<1?(ue(a.renderData.geometryInfo.uvOffsetAndScale,t.offsetAndScale,de),o.setUniform1f("fadeFactor",e),o.setUniform4fv("nextTexOffsetAndScale",de),o.setUniform3fv("nextTexOpacities",t.opacities),o.bindTexture("texNext",t.texture.texture)):o.setUniform1f("fadeFactor",1),a.renderData.textureIsFading&&this.setNeedsRender(),o.setUniform3fv("textureOpacities",u.opacities)}this._renderPatch(e,t,a,c,l,i),a.renderOrder=this.numTilesRendered,this.numTilesRendered++}}})),s.bindVAO(null)}_renderPatch(e,t,i,r,s,a){const o=i.renderData,l=o.vao,d=l.indexBuffer;if(n(d))return;const h=t.program;a!==v.None&&this._bindOverlayPatchData(h,o.overlay),s&&(t.useStencil=this._useStencilForTile(i),t.bindPipelineState(e.rctx,e.bindParameters.slot));const c=o.geometryInfo.indexCount;e.rctx.bindVAO(l),h.assertCompatibleVertexAttributeLocations(l),e.rctx.drawElements(r,c,d.indexType,0)}_bindOverlayPatchData(e,t){e.setUniform4fv("overlayTexOffset",t.offsets),e.setUniform4fv("overlayTexScale",t.scales)}_updateTechnique(e,t){return this._techniqueConfiguration.output=e,e===j.Color&&(this._techniqueConfiguration.atmosphere=this.isGlobal&&this._velvetOverground),this._techniqueConfiguration.renderOccluded=t,this._techniqueConfiguration.stencilEnabled=!1,this._shaderTechnique=this._techniqueRepository.releaseAndAcquire(ie,this._techniqueConfiguration,this._shaderTechnique),this._shaderTechnique}get test(){return{tileRenderer:this.tileRenderer}}};e([o({constructOnly:!0})],he.prototype,"overlayRenderer",void 0),e([o({constructOnly:!0})],he.prototype,"stage",void 0),e([o({readOnly:!0})],he.prototype,"isGlobal",null),e([o({constructOnly:!0})],he.prototype,"allTiles",void 0),e([o({constructOnly:!0})],he.prototype,"ellipsoidRadius",void 0),e([o({value:!1})],he.prototype,"renderingDisabled",null),e([o()],he.prototype,"renderPatchBorders",null),e([o()],he.prototype,"cullBackFaces",null),e([o({value:E.FRONT_TO_BACK})],he.prototype,"renderOrder",null),e([o()],he.prototype,"wireframe",null),he=e([l("esri.views.3d.terrain.TerrainRenderer")],he);const ce=he;function ue(e,t,i){i[0]=e[0]*t[2]+t[0],i[1]=e[1]*t[3]+t[1],i[2]=e[2]*t[2],i[3]=e[3]*t[3]}const pe=g(),fe=g(),ge=g(),me=g();export{ce as default};
