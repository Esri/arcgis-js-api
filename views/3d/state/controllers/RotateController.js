/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/has","../../../../core/mathUtils","../../../../core/screenUtils","../../../../core/accessorSupport/decorators/property","../../../../core/arrayUtils","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec2","../../../../chunks/vec2f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/projectionEllipsoid","../../camera/constraintUtils","../Constraints","./InteractiveController","../utils/navigationUtils"],(function(t,i,e,o,r,s,a,n,c,p,h,l,m,u,v,d,P,C,f,y,w){"use strict";const R=7,g=90;t.RotateController=function(t){function e(i){var e;return(e=t.call(this,i)||this).view=null,e.pivot=0,e.lastPoint=u.create(),e.tmpWorldUp=d.create(),e.tmpViewDir=d.create(),e.tmpRotCurPoint=u.create(),e.tmpTransf=l.create(),e.tmpAxis=d.create(),e.tmpPivotPoint=d.create(),e.pivotPos=d.create(),e.constraintOptions={selection:15,interactionType:2,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:0},e}i._inheritsLoose(e,t);var a=e.prototype;return a.initialize=function(){this.rotScale=0===this.pivot?3:1.5},a.begin=function(t){if(this.active){switch(this.pivot){case 1:v.copy(this.pivotPos,this.startCamera.eye),this.constraintOptions.interactionType=3,this.constraintOptions.tiltMode=1,this.constraintOptions.selection=0;break;case 0:this.intersectionHelper.intersectRayFreePointFallback(this.startCamera.ray,this.pivotPos)||v.copy(this.pivotPos,this.startCamera.center),o("disable-feature:context-navigation")||this.constrainPivotPoint(t),this.startCamera.center=this.pivotPos,this.constraintOptions.interactionType=2,this.constraintOptions.tiltMode=0,this.constraintOptions.selection=11}this.constraintOptions.interactionStartCamera=this.startCamera,w.normalizeCoordinate(this.startCamera,t,this.lastPoint)}},a.constrainPivotPoint=function(t){const i=this.startCamera,e=d.create();v.subtract(e,this.pivotPos,i.eye);let o=v.length(e);this.view.camera.position.hasZ&&(o=Math.min(o,R*Math.abs(this.view.camera.position.z)));const r=P.getReferenceEllipsoid(this.view.spatialReference),a=s.createScreenPointArray(i.width/i.pixelRatio*.5,i.height/i.pixelRatio*.5),n=w.decideNavigationMode(this.startCamera,a,!0,r);let c=this.view._stage.renderView.getMinimalDepthForArea(this.view.getVoxelWasmPerSceneView(),i.fullWidth/i.pixelRatio*.5,i.fullHeight/i.pixelRatio*.5,i,2.5*g,g),p=this.view._stage.renderView.getMinimalDepthForArea(this.view.getVoxelWasmPerSceneView(),t[0],t[1],i,g);void 0===c&&void 0===p||(c=void 0===c?p:c,p=void 0===p||n===w.NavigationMode.Horizontal?c:p,o=c>p?p:c),v.normalize(e,e),v.copy(this.pivotPos,v.add(this.tmpPivotPoint,i.eye,v.scale(this.tmpPivotPoint,e,o)))},a.update=function(t){if(this.active){switch(this.pivot){case 1:this.currentCamera.center=this.applyRotation(this.currentCamera,t,this.currentCamera.center,this.pivotPos);break;case 0:this.currentCamera.center=this.pivotPos,this.currentCamera.eye=this.applyRotation(this.currentCamera,t,this.currentCamera.eye,this.pivotPos)}C.applyAll(this.view,this.currentCamera,this.constraintOptions)}},a.end=function(){this.active&&this.finishController()},a.applyRotation=function(t,i,e,o){this.view.renderCoordsHelper.worldUpAtPosition(o,this.tmpWorldUp),w.normalizeCoordinate(t,i,this.tmpRotCurPoint);let s=(this.lastPoint[1]-this.tmpRotCurPoint[1])*this.rotScale,a=(this.tmpRotCurPoint[0]-this.lastPoint[0])*this.rotScale;v.subtract(this.tmpViewDir,e,o);const n=v.length(this.tmpViewDir),c=r.acosClamped(v.dot(this.tmpViewDir,this.tmpWorldUp)/n);if(1===this.pivot){s*=-.5;const t=.5*Math.PI-c,i=.5*Math.PI*.99;s=t-Math.max(-i,Math.min(i,t+s))}return s=r.clamp(s+c,f.TiltDefault.min,f.TiltDefault.max)-c,h.identity(this.tmpTransf),v.cross(this.tmpAxis,t.up,this.tmpViewDir),0===this.pivot&&(a=-a),h.rotate(this.tmpTransf,this.tmpTransf,a,this.tmpWorldUp),h.rotate(this.tmpTransf,this.tmpTransf,s,this.tmpAxis),v.transformMat4(this.tmpViewDir,this.tmpViewDir,this.tmpTransf),t.up=v.transformMat4(M,t.up,this.tmpTransf),v.add(M,o,this.tmpViewDir),m.copy(this.lastPoint,this.tmpRotCurPoint),M},i._createClass(e,[{key:"intersectionHelper",get:function(){return this.view.sceneIntersectionHelper}}]),e}(y.InteractiveController),e.__decorate([a.property({constructOnly:!0})],t.RotateController.prototype,"view",void 0),e.__decorate([a.property()],t.RotateController.prototype,"pivot",void 0),t.RotateController=e.__decorate([p.subclass("esri.views.3d.state.controllers.RotateController")],t.RotateController);const M=d.create();Object.defineProperty(t,"__esModule",{value:!0})}));
