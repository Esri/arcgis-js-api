/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/mathUtils","../../../../core/maybe","../../../../core/screenUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec2","../../../../chunks/vec2f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/ellipsoidUtils","../../camera/constraintUtils","../../camera/constraintUtils/ConstraintTypes","../../camera/constraintUtils/InteractionType","../../camera/constraintUtils/TiltMode","../Constraints","./InteractiveController","../utils/navigationUtils"],(function(t,i,e,o,r,s,n,a,c,p,h,l,_,m,v,P,u,C,E,T,d,R,y,f){"use strict";var M;t.PivotPoint=void 0,(M=t.PivotPoint||(t.PivotPoint={}))[M.CENTER=0]="CENTER",M[M.EYE=1]="EYE",t.RotateController=function(e){function n(i){var o;return(o=e.call(this,i)||this).pivot=t.PivotPoint.CENTER,o._rotScale=0,o._lastPoint=m.create(),o._tmpWorldUp=P.create(),o._tmpViewDir=P.create(),o._tmpRotCurPoint=m.create(),o._tmpTransf=l.create(),o._tmpAxis=P.create(),o._tmpPivotPoint=P.create(),o._pivotPos=P.create(),o._constraintOptions={selection:E.ConstraintTypes.ALL,interactionType:T.InteractionType.TUMBLE,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:d.TiltMode.TUMBLE},o}i._inheritsLoose(n,e);var a=n.prototype;return a.initialize=function(){this._rotScale=this.pivot===t.PivotPoint.CENTER?3:1.5},a.begin=function(i){if(this.active){switch(this.pivot){case t.PivotPoint.EYE:v.copy(this._pivotPos,this.startCamera.eye),this._constraintOptions.interactionType=T.InteractionType.LOOK_AROUND,this._constraintOptions.tiltMode=d.TiltMode.LOOK_AROUND,this._constraintOptions.selection=E.ConstraintTypes.NONE;break;case t.PivotPoint.CENTER:{const t=this._intersectionHelper.intersectRayFreePointFallback(this.startCamera.ray,this._pivotPos,0===this.view.map.ground.opacity?f.contentIntersectorOptions:{});t||v.copy(this._pivotPos,this.startCamera.center),this._constrainPivotPoint(i,t),this.startCamera.center=this._pivotPos,this._constraintOptions.interactionType=T.InteractionType.TUMBLE,this._constraintOptions.tiltMode=d.TiltMode.TUMBLE,this._constraintOptions.selection=E.ConstraintTypes.ALL&~E.ConstraintTypes.DISTANCE;break}}this._constraintOptions.interactionStartCamera=this.startCamera,f.normalizeCoordinate(this.startCamera,i,this._lastPoint)}},a._constrainPivotPoint=function(t,i){const e=this.startCamera,o=P.create();v.subtract(o,this._pivotPos,e.eye);const n=v.length(o),a=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(e.eye,O);let c=Math.max(Math.min(f.ROTATE_PIVOT_DISTANCE_MODIFIER,1/Math.abs(v.dot(O,e.viewForward)))*a,f.ROTATE_PIVOT_MIN_DISTANCE_MODIFIER);i&&(c=Math.min(n,c));const p=u.getReferenceEllipsoid(this.view.spatialReference),h=s.createScreenPointArray(e.width/e.pixelRatio*.5,e.height/e.pixelRatio*.5),l=f.decideNavigationMode(this.startCamera,h,p);let _=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,e.fullWidth/e.pixelRatio*.5,e.fullHeight/e.pixelRatio*.5,e,2.5*f.ROTATE_SCREEN_PIXEL_AREA,f.ROTATE_SCREEN_PIXEL_AREA),m=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,t[0],t[1],e,f.ROTATE_SCREEN_PIXEL_AREA);(r.isSome(_)||r.isSome(m))&&(_=r.unwrapOr(_,m),m=r.isNone(m)||l===f.NavigationMode.Horizontal?_:m,c=_>m?m:_,c=i?Math.min(c,n):c),v.normalize(o,o),v.copy(this._pivotPos,v.add(this._tmpPivotPoint,e.eye,v.scale(this._tmpPivotPoint,o,c)))},a.update=function(i){if(this.active){switch(this.pivot){case t.PivotPoint.EYE:this.currentCamera.center=this._applyRotation(this.currentCamera,i,this.currentCamera.center,this._pivotPos);break;case t.PivotPoint.CENTER:this.currentCamera.center=this._pivotPos,this.currentCamera.eye=this._applyRotation(this.currentCamera,i,this.currentCamera.eye,this._pivotPos)}C.applyAll(this.view,this.currentCamera,this._constraintOptions),this.commitCamera()}},a.end=function(){this.active&&this.finishController()},a._applyRotation=function(i,e,r,s){this.view.renderCoordsHelper.worldUpAtPosition(s,this._tmpWorldUp),f.normalizeCoordinate(i,e,this._tmpRotCurPoint);let n=(this._lastPoint[1]-this._tmpRotCurPoint[1])*this._rotScale,a=(this._tmpRotCurPoint[0]-this._lastPoint[0])*this._rotScale;v.subtract(this._tmpViewDir,r,s);const c=v.length(this._tmpViewDir),p=o.acosClamped(v.dot(this._tmpViewDir,this._tmpWorldUp)/c);if(this.pivot===t.PivotPoint.EYE){n*=-.5;const t=.5*Math.PI-p,i=.5*Math.PI*.99;n=t-Math.max(-i,Math.min(i,t+n))}return n=o.clamp(n+p,R.TiltDefault.min,R.TiltDefault.max)-p,v.cross(this._tmpAxis,i.up,this._tmpViewDir),this.pivot===t.PivotPoint.CENTER&&(a=-a),h.fromRotation(this._tmpTransf,a,this._tmpWorldUp),h.rotate(this._tmpTransf,this._tmpTransf,n,this._tmpAxis),v.transformMat4(this._tmpViewDir,this._tmpViewDir,this._tmpTransf),i.up=v.transformMat4(w,i.up,this._tmpTransf),v.add(w,s,this._tmpViewDir),_.copy(this._lastPoint,this._tmpRotCurPoint),w},i._createClass(n,[{key:"_intersectionHelper",get:function(){return this.view.sceneIntersectionHelper}}]),n}(y.InteractiveController),e.__decorate([n.property()],t.RotateController.prototype,"pivot",void 0),t.RotateController=e.__decorate([p.subclass("esri.views.3d.state.controllers.RotateController")],t.RotateController);const w=P.create(),O=P.create();Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
