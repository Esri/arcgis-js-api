/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/mathUtils","../../../../core/screenUtils","../../../../core/accessorSupport/decorators/property","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec2","../../../../chunks/vec2f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/projectionEllipsoid","../../camera/constraintUtils","../../camera/constraintUtils/common","../Constraints","./InteractiveController","../utils/navigationUtils"],(function(t,i,e,o,r,s,n,a,c,p,h,l,m,v,u,P,d,C,y,T,f,E){"use strict";var R;t.PivotPoint=void 0,(R=t.PivotPoint||(t.PivotPoint={}))[R.CENTER=0]="CENTER",R[R.EYE=1]="EYE";const w=7,M=90;t.RotateController=function(e){function s(i){var o;return(o=e.call(this,i)||this).view=null,o.pivot=t.PivotPoint.CENTER,o.lastPoint=v.create(),o.tmpWorldUp=P.create(),o.tmpViewDir=P.create(),o.tmpRotCurPoint=v.create(),o.tmpTransf=l.create(),o.tmpAxis=P.create(),o.tmpPivotPoint=P.create(),o.pivotPos=P.create(),o.constraintOptions={selection:y.ConstraintTypes.ALL,interactionType:y.InteractionType.TUMBLE,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:y.TiltMode.TUMBLE},o}i._inheritsLoose(s,e);var n=s.prototype;return n.initialize=function(){this.rotScale=this.pivot===t.PivotPoint.CENTER?3:1.5},n.begin=function(i){if(this.active){switch(this.pivot){case t.PivotPoint.EYE:u.copy(this.pivotPos,this.startCamera.eye),this.constraintOptions.interactionType=y.InteractionType.LOOK_AROUND,this.constraintOptions.tiltMode=y.TiltMode.LOOK_AROUND,this.constraintOptions.selection=y.ConstraintTypes.NONE;break;case t.PivotPoint.CENTER:this.intersectionHelper.intersectRayFreePointFallback(this.startCamera.ray,this.pivotPos)||u.copy(this.pivotPos,this.startCamera.center),this._constrainPivotPoint(i),this.startCamera.center=this.pivotPos,this.constraintOptions.interactionType=y.InteractionType.TUMBLE,this.constraintOptions.tiltMode=y.TiltMode.TUMBLE,this.constraintOptions.selection=y.ConstraintTypes.ALL&~y.ConstraintTypes.DISTANCE}this.constraintOptions.interactionStartCamera=this.startCamera,E.normalizeCoordinate(this.startCamera,i,this.lastPoint)}},n._constrainPivotPoint=function(t){const i=this.startCamera,e=P.create();u.subtract(e,this.pivotPos,i.eye);let o=u.length(e);this.view.camera.position.hasZ&&(o=Math.min(o,w*Math.abs(this.view.camera.position.z)));const s=d.getReferenceEllipsoid(this.view.spatialReference),n=r.createScreenPointArray(i.width/i.pixelRatio*.5,i.height/i.pixelRatio*.5),a=E.decideNavigationMode(this.startCamera,n,!0,s);let c=this.view._stage.renderView.getMinimalDepthForArea(this.view.getVoxelWasmPerSceneView(),i.fullWidth/i.pixelRatio*.5,i.fullHeight/i.pixelRatio*.5,i,2.5*M,M),p=this.view._stage.renderView.getMinimalDepthForArea(this.view.getVoxelWasmPerSceneView(),t[0],t[1],i,M);void 0===c&&void 0===p||(c=void 0===c?p:c,p=void 0===p||a===E.NavigationMode.Horizontal?c:p,o=c>p?p:c),u.normalize(e,e),u.copy(this.pivotPos,u.add(this.tmpPivotPoint,i.eye,u.scale(this.tmpPivotPoint,e,o)))},n.update=function(i){if(this.active){switch(this.pivot){case t.PivotPoint.EYE:this.currentCamera.center=this._applyRotation(this.currentCamera,i,this.currentCamera.center,this.pivotPos);break;case t.PivotPoint.CENTER:this.currentCamera.center=this.pivotPos,this.currentCamera.eye=this._applyRotation(this.currentCamera,i,this.currentCamera.eye,this.pivotPos)}C.applyAll(this.view,this.currentCamera,this.constraintOptions)}},n.end=function(){this.active&&this.finishController()},n._applyRotation=function(i,e,r,s){this.view.renderCoordsHelper.worldUpAtPosition(s,this.tmpWorldUp),E.normalizeCoordinate(i,e,this.tmpRotCurPoint);let n=(this.lastPoint[1]-this.tmpRotCurPoint[1])*this.rotScale,a=(this.tmpRotCurPoint[0]-this.lastPoint[0])*this.rotScale;u.subtract(this.tmpViewDir,r,s);const c=u.length(this.tmpViewDir),p=o.acosClamped(u.dot(this.tmpViewDir,this.tmpWorldUp)/c);if(this.pivot===t.PivotPoint.EYE){n*=-.5;const t=.5*Math.PI-p,i=.5*Math.PI*.99;n=t-Math.max(-i,Math.min(i,t+n))}return n=o.clamp(n+p,T.TiltDefault.min,T.TiltDefault.max)-p,u.cross(this.tmpAxis,i.up,this.tmpViewDir),this.pivot===t.PivotPoint.CENTER&&(a=-a),h.fromRotation(this.tmpTransf,a,this.tmpWorldUp),h.rotate(this.tmpTransf,this.tmpTransf,n,this.tmpAxis),u.transformMat4(this.tmpViewDir,this.tmpViewDir,this.tmpTransf),i.up=u.transformMat4(g,i.up,this.tmpTransf),u.add(g,s,this.tmpViewDir),m.copy(this.lastPoint,this.tmpRotCurPoint),g},i._createClass(s,[{key:"intersectionHelper",get:function(){return this.view.sceneIntersectionHelper}}]),s}(f.InteractiveController),e.__decorate([s.property({constructOnly:!0})],t.RotateController.prototype,"view",void 0),e.__decorate([s.property()],t.RotateController.prototype,"pivot",void 0),t.RotateController=e.__decorate([p.subclass("esri.views.3d.state.controllers.RotateController")],t.RotateController);const g=P.create();Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
