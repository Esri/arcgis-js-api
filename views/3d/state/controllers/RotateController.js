/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/mathUtils","../../../../core/maybe","../../../../core/screenUtils","../../../../core/accessorSupport/decorators/property","../../../../core/arrayUtils","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec2","../../../../chunks/vec2f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/projectionEllipsoid","../../camera/constraintUtils","../../camera/constraintUtils/ConstraintTypes","../../camera/constraintUtils/InteractionType","../../camera/constraintUtils/TiltMode","../Constraints","./InteractiveController","../utils/navigationUtils"],(function(t,i,e,o,s,r,n,a,c,p,h,l,m,_,v,u,P,C,d,y,T,f,E,R){"use strict";var M;t.PivotPoint=void 0,(M=t.PivotPoint||(t.PivotPoint={}))[M.CENTER=0]="CENTER",M[M.EYE=1]="EYE";const w=7,U=90;t.RotateController=function(e){function n(i){var o;return(o=e.call(this,i)||this).pivot=t.PivotPoint.CENTER,o._lastPoint=_.create(),o._tmpWorldUp=u.create(),o._tmpViewDir=u.create(),o._tmpRotCurPoint=_.create(),o._tmpTransf=l.create(),o._tmpAxis=u.create(),o._tmpPivotPoint=u.create(),o._pivotPos=u.create(),o._constraintOptions={selection:d.ConstraintTypes.ALL,interactionType:y.InteractionType.TUMBLE,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:T.TiltMode.TUMBLE},o}i._inheritsLoose(n,e);var a=n.prototype;return a.initialize=function(){this._rotScale=this.pivot===t.PivotPoint.CENTER?3:1.5},a.begin=function(i){if(this.active){switch(this.pivot){case t.PivotPoint.EYE:v.copy(this._pivotPos,this.startCamera.eye),this._constraintOptions.interactionType=y.InteractionType.LOOK_AROUND,this._constraintOptions.tiltMode=T.TiltMode.LOOK_AROUND,this._constraintOptions.selection=d.ConstraintTypes.NONE;break;case t.PivotPoint.CENTER:{const t=this._intersectionHelper.intersectRayFreePointFallback(this.startCamera.ray,this._pivotPos);t||v.copy(this._pivotPos,this.startCamera.center),this._constrainPivotPoint(i,t),this.startCamera.center=this._pivotPos,this._constraintOptions.interactionType=y.InteractionType.TUMBLE,this._constraintOptions.tiltMode=T.TiltMode.TUMBLE,this._constraintOptions.selection=d.ConstraintTypes.ALL&~d.ConstraintTypes.DISTANCE;break}}this._constraintOptions.interactionStartCamera=this.startCamera,R.normalizeCoordinate(this.startCamera,i,this._lastPoint)}},a._constrainPivotPoint=function(t,i){const e=this.startCamera,o=u.create();v.subtract(o,this._pivotPos,e.eye);const n=v.length(o);let a=Math.min(n,w*Math.abs(this.view.camera.position.z));const c=P.getReferenceEllipsoid(this.view.spatialReference),p=r.createScreenPointArray(e.width/e.pixelRatio*.5,e.height/e.pixelRatio*.5),h=R.decideNavigationMode(this.startCamera,p,!0,c);let l=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,e.fullWidth/e.pixelRatio*.5,e.fullHeight/e.pixelRatio*.5,e,2.5*U,U),m=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,t[0],t[1],e,U);(s.isSome(l)||s.isSome(m))&&(l=s.unwrapOr(l,m),m=s.isNone(m)||h===R.NavigationMode.Horizontal?l:m,a=l>m?m:l,a=i?Math.min(a,n):a),v.normalize(o,o),v.copy(this._pivotPos,v.add(this._tmpPivotPoint,e.eye,v.scale(this._tmpPivotPoint,o,a)))},a.update=function(i){if(this.active){switch(this.pivot){case t.PivotPoint.EYE:this.currentCamera.center=this._applyRotation(this.currentCamera,i,this.currentCamera.center,this._pivotPos);break;case t.PivotPoint.CENTER:this.currentCamera.center=this._pivotPos,this.currentCamera.eye=this._applyRotation(this.currentCamera,i,this.currentCamera.eye,this._pivotPos)}C.applyAll(this.view,this.currentCamera,this._constraintOptions),this.commitCamera()}},a.end=function(){this.active&&this.finishController()},a._applyRotation=function(i,e,s,r){this.view.renderCoordsHelper.worldUpAtPosition(r,this._tmpWorldUp),R.normalizeCoordinate(i,e,this._tmpRotCurPoint);let n=(this._lastPoint[1]-this._tmpRotCurPoint[1])*this._rotScale,a=(this._tmpRotCurPoint[0]-this._lastPoint[0])*this._rotScale;v.subtract(this._tmpViewDir,s,r);const c=v.length(this._tmpViewDir),p=o.acosClamped(v.dot(this._tmpViewDir,this._tmpWorldUp)/c);if(this.pivot===t.PivotPoint.EYE){n*=-.5;const t=.5*Math.PI-p,i=.5*Math.PI*.99;n=t-Math.max(-i,Math.min(i,t+n))}return n=o.clamp(n+p,f.TiltDefault.min,f.TiltDefault.max)-p,v.cross(this._tmpAxis,i.up,this._tmpViewDir),this.pivot===t.PivotPoint.CENTER&&(a=-a),h.fromRotation(this._tmpTransf,a,this._tmpWorldUp),h.rotate(this._tmpTransf,this._tmpTransf,n,this._tmpAxis),v.transformMat4(this._tmpViewDir,this._tmpViewDir,this._tmpTransf),i.up=v.transformMat4(g,i.up,this._tmpTransf),v.add(g,r,this._tmpViewDir),m.copy(this._lastPoint,this._tmpRotCurPoint),g},i._createClass(n,[{key:"_intersectionHelper",get:function(){return this.view.sceneIntersectionHelper}}]),n}(E.InteractiveController),e.__decorate([n.property()],t.RotateController.prototype,"pivot",void 0),t.RotateController=e.__decorate([p.subclass("esri.views.3d.state.controllers.RotateController")],t.RotateController);const g=u.create();Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
