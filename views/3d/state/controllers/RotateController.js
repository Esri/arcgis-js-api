/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/has","../../../../core/Logger","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/decorators/subclass","../../../../core/urlUtils","../../../../core/uuid","../../../../portal/support/resourceExtension","../../../../core/mathUtils","../../../../core/screenUtils","../../../../chunks/vec3f64","../../../../chunks/vec3","../../../../geometry/projectionEllipsoid","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec2f64","../../../../chunks/vec2","../Constraints","../../camera/constraintUtils","../utils/navigationUtils","./InteractiveController"],(function(t,i,e,o,r,s,n,a,c,p,h,l,m,u,v,d,f,P,C,y,g,w,b,R){"use strict";t.RotateController=function(t){function e(i){var e;return(e=t.call(this,i)||this).view=null,e.pivot="center",e.lastPoint=C.create(),e.tmpWorldUp=u.create(),e.tmpViewDir=u.create(),e.tmpRotCurPoint=C.create(),e.tmpTransf=P.create(),e.tmpAxis=u.create(),e.tmpPivotPoint=u.create(),e.pivotPos=u.create(),e.constraintOptions={selection:15,interactionType:2,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:0},e}i._inheritsLoose(e,t);var r=e.prototype;return r.initialize=function(){this.rotScale="center"===this.pivot?3:1.5},r.begin=function(t){if(this.active){switch(this.pivot){case"eye":v.copy(this.pivotPos,this.beginCamera.eye),this.constraintOptions.interactionType=3,this.constraintOptions.tiltMode=1,this.constraintOptions.selection=0;break;case"center":this.intersectionHelper.intersectRayFreePointFallback(this.beginCamera.ray,this.pivotPos)||v.copy(this.pivotPos,this.beginCamera.center),o("disable-feature:context-navigation")||this.constrainPivotPoint(t),this.beginCamera.center=this.pivotPos,this.constraintOptions.interactionType=2,this.constraintOptions.tiltMode=0,this.constraintOptions.selection=11}this.constraintOptions.interactionStartCamera=this.beginCamera,b.normalizeCoordinate(this.beginCamera,t,this.lastPoint)}},r.constrainPivotPoint=function(t){const i=this.beginCamera,e=u.create();let o;v.subtract(e,this.pivotPos,i.eye),this.view.camera.position.hasZ&&(o=Math.abs(this.view.camera.position.z));let r=v.length(e);this.view.camera.position.hasZ&&r>7*o&&(r=7*o);const s=d.getReferenceEllipsoid(this.view.spatialReference),n=m.createScreenPointArray(i.width/i.pixelRatio*.5,i.height/i.pixelRatio*.5),a=b.decideNavigationMode(this.beginCamera,n,!0,s);let c=this.view._stage.renderView.getMinimalDepthForArea(i.fullWidth/i.pixelRatio*.5,i.fullHeight/i.pixelRatio*.5,i,90,2.5),p=this.view._stage.renderView.getMinimalDepthForArea(t[0],t[1],i,90);void 0===c&&void 0===p||(c=void 0===c?p:c,p=void 0===p||a===b.NavigationMode.Horizontal?c:p,r=c>p?p:c),v.normalize(e,e),v.copy(this.pivotPos,v.add(this.tmpPivotPoint,i.eye,v.scale(this.tmpPivotPoint,e,r)))},r.update=function(t){if(!this.active)return;let i;switch(this.pivot){case"eye":i=this.currentCamera.center;break;case"center":this.currentCamera.center=this.pivotPos,i=this.currentCamera.eye}this.applyRotation(this.currentCamera,t,i,this.pivotPos),w.applyAll(this.view,this.currentCamera,this.constraintOptions)},r.end=function(){this.active&&this.finishController()},r.applyRotation=function(t,i,e,o){this.view.renderCoordsHelper.worldUpAtPosition(o,this.tmpWorldUp),b.normalizeCoordinate(t,i,this.tmpRotCurPoint);let r=(this.lastPoint[1]-this.tmpRotCurPoint[1])*this.rotScale,s=(this.tmpRotCurPoint[0]-this.lastPoint[0])*this.rotScale;v.subtract(this.tmpViewDir,e,o);const n=v.length(this.tmpViewDir),a=l.acosClamped(v.dot(this.tmpViewDir,this.tmpWorldUp)/n);if("eye"===this.pivot){r*=-.5;const t=.5*Math.PI-a,i=.5*Math.PI*.99;r=t-Math.max(-i,Math.min(i,t+r))}r=l.clamp(r+a,g.TiltDefault.min,g.TiltDefault.max)-a,f.identity(this.tmpTransf),v.cross(this.tmpAxis,t.up,this.tmpViewDir),"center"===this.pivot&&(s=-s),f.rotate(this.tmpTransf,this.tmpTransf,s,this.tmpWorldUp),f.rotate(this.tmpTransf,this.tmpTransf,r,this.tmpAxis),v.transformMat4(this.tmpViewDir,this.tmpViewDir,this.tmpTransf),v.add(e,o,this.tmpViewDir),v.transformMat4(t.up,t.up,this.tmpTransf),y.copy(this.lastPoint,this.tmpRotCurPoint),t.markViewDirty()},i._createClass(e,[{key:"intersectionHelper",get:function(){return this.view.sceneIntersectionHelper}}]),e}(R.InteractiveController),e.__decorate([n.property({constructOnly:!0})],t.RotateController.prototype,"view",void 0),e.__decorate([n.property()],t.RotateController.prototype,"pivot",void 0),t.RotateController=e.__decorate([a.subclass("esri.views.3d.state.controllers.RotateController")],t.RotateController),Object.defineProperty(t,"__esModule",{value:!0})}));
