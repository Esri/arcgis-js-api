/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/has","../../../../core/compilerUtils","../../../../core/maybe","../../../../core/Logger","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/decorators/subclass","../../../../core/urlUtils","../../../../core/uuid","../../../../portal/support/resourceExtension","../../../../core/mathUtils","../../../../chunks/vec3f64","../../../../chunks/vec3","../../support/mathUtils","../../../../geometry/projectionEllipsoid","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../navigation/gamepadAndKeyboardUtils","../Constraints","../../support/stack","../../support/geometryUtils","../utils/viewUtils","../../camera/constraintUtils","../../webgl-engine/lib/Camera","../utils/navigationUtils","./InteractiveController","../../support/cameraUtilsInternal","../../support/cameraUtils"],(function(t,e,a,i,o,n,r,s,c,l,d,p,m,h,u,f,v,y,g,C,w,b,T,S,O,x,M,D,z,A,G){"use strict";t.GamepadKeyboardController=function(t){function a(e){var a;return(a=t.call(this,e)||this).transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0},a.keysButtonState=[0,0,0,0,0,0,0,0,0,0,0,0],a.tmpCamera=new M,a.constraintOptions={selection:15,interactionType:0,interactionStartCamera:new M,interactionFactor:0,interactionDirection:null,tiltMode:1},a}e._inheritsLoose(a,t);var i=a.prototype;return i.handleEventGamepad=function(t){const e=w.extractTransformation(t,this.view.navigation.gamepad,this.transformation);("end"===t.action||w.isZeroTransformation(e))&&this.finishController()},i.activateDirection=function(t){this.keysButtonState[t]=1,w.extractTransformationKeyboard(this.keysButtonState,this.transformation)},i.deactivateDirection=function(t){this.keysButtonState[t]=0;const e=w.extractTransformationKeyboard(this.keysButtonState,this.transformation);w.isZeroTransformation(e)&&this.finishController()},i.onControllerStart=function(e){this.filteredSurfaceElevation=this.view.pointsOfInterest.cameraOnSurface.location.z,this.headingStart=this.view.camera.heading,t.prototype.onControllerStart.call(this,e)},i.updateFilteredSurfaceElevation=function(t){const e=this.view.pointsOfInterest.cameraOnSurface.location.z;this.filteredSurfaceElevation+=1*(e-this.filteredSurfaceElevation)*t},i.stepController=function(e,a){this.updateStartHeading(),this.updateFilteredSurfaceElevation(e),this.currentCamera.copyViewFrom(a),this.updateCameraCenter(),this.constraintOptions.interactionStartCamera.copyFrom(this.currentCamera),this.calculateControlTransformation(e,this.currentCamera,_),this.applyDisabledMovementTypes(_),this.applyPan(_.pan),this.applyRotate(_.rotate),this.applyZoom(_.zoom),this.applyAscend(_.ascend),this.constraintOptions.interactionType=0,this.constraintOptions.selection=8,x.applyAll(this.view,this.currentCamera,this.constraintOptions),t.prototype.stepController.call(this,e,a)},i.updateStartHeading=function(){0!==this.transformation.heading&&(this.headingStart=this.view.camera.heading)},i.applyRotate=function(t){if(!t.enabled)return;const e=this.currentCamera,{center:a,up:i,eye:o}=e;f.subtract(a,a,o),f.transformMat4(a,a,t.matrix),f.add(a,a,o),f.transformMat4(i,i,t.matrix),e.markViewDirty(),this.constraintOptions.interactionType=3,this.constraintOptions.selection=7,x.applyAll(this.view,e,this.constraintOptions)},i.applyPan=function(t,e=this.currentCamera){if(!t.enabled)return;const{center:a,eye:i,up:o}=e;f.transformMat4(i,i,t.matrix),f.transformMat4(a,a,t.matrix);this.view.state.isGlobal&&f.transformMat4(o,o,t.matrix),e.markViewDirty(),this.constraintOptions.interactionType=4,this.constraintOptions.selection=15,x.applyAll(this.view,e,this.constraintOptions)},i.applyZoom=function(t){if(!t)return;const{eye:e,viewForward:a}=this.currentCamera;f.add(e,e,f.scale(T.sv3d.get(),a,t)),this.currentCamera.markViewDirty(),f.copy(K,a),f.negate(K,K),this.constraintOptions.interactionDirection=K,this.constraintOptions.interactionType=1,this.constraintOptions.selection=7,x.applyAll(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null},i.applyAscend=function(t){if(!t)return;const{center:e,eye:a}=this.currentCamera,i=this.view.renderCoordsHelper.worldUpAtPosition(a,T.sv3d.get());this.constraintOptions.interactionDirection=f.copy(K,i);if(this.view.state.isGlobal){const i=f.length(a),o=(i+t)/i;f.scale(a,a,o),f.scale(e,e,o)}else{const o=f.scale(T.sv3d.get(),i,t);f.add(a,a,o),f.add(e,e,o)}this.currentCamera.markViewDirty(),this.updateCameraCenter(),this.constraintOptions.interactionType=5,this.constraintOptions.selection=8,x.applyAll(this.view,this.currentCamera,this.constraintOptions)&&this.updateCameraCenter(),this.constraintOptions.selection=7,x.applyAll(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null},i.calculateControlTransformation=function(t,e,a){!function(t){t.zoom=0,t.ascend=0,t.pan.enabled=!1,g.identity(t.pan.matrix),t.rotate.enabled=!1,g.identity(t.rotate.matrix)}(a);const i=this.computeVelocities(t);this.view.state.isLocal?this.calculateControlTransformationLocal(i,e,a):this.calculateControlTransformationGlobal(i,e,a)},i.updateCameraCenter=function(){const{ray:t,center:e}=this.currentCamera,a=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude;this.view.renderCoordsHelper.intersectManifoldClosestSilhouette(t,a,e),this.currentCamera.markViewDirty()},i.calculateControlTransformationLocal=function(t,e,a){const{viewRight:i,viewForward:n}=e,r=this.transformation,s=this.view.navigation.gamepad,c=f.set(T.sv3d.get(),n[0],n[1],0);f.normalize(c,c);const l=r.translation[0]*t.pan;if(0!==l){const t=f.scale(T.sv3d.get(),i,l);g.translate(a.pan.matrix,a.pan.matrix,t),a.pan.enabled=!0}switch(s.mode){case"pan":{const e=-r.translation[1]*t.pan;if(0!==e){const t=f.scale(T.sv3d.get(),c,e);g.translate(a.pan.matrix,a.pan.matrix,t),a.pan.enabled=!0}a.zoom=r.zoom*t.zoom;break}case"zoom":a.zoom=(-r.translation[1]+r.zoom)*t.zoom;break;default:o.neverReached(s.mode)}const d=r.translation[2]*t.ascend;a.ascend=d;const p=-r.heading*t.rotate;0!==p&&(g.rotate(a.rotate.matrix,a.rotate.matrix,p,this.view.renderCoordsHelper.worldUpAtPosition(e.eye,T.sv3d.get())),a.rotate.enabled=!0);const m=r.tilt*t.rotate,u=O.viewAngle(this.view.renderCoordsHelper,e.center,e.eye),v=h.clamp(u+m,b.TiltDefault.min,b.TiltDefault.max)-u;v&&(g.rotate(a.rotate.matrix,a.rotate.matrix,v,i),a.rotate.enabled=!0)},i.calculateControlTransformationGlobal=function(t,e,a){const{eye:i,viewRight:o}=e,n=this.transformation,r=this.view.navigation.gamepad,s=f.cross(T.sv3d.get(),o,i);f.normalize(s,s),f.negate(s,s),D.panMotionToRotationMatrix(this.beginCamera,e,n,t,this.view.camera.heading,this.headingStart,this.view.camera.tilt,a,r),this.tmpCamera.copyFrom(this.currentCamera),this.applyPan(_.pan,this.tmpCamera);const c=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,l=n.translation[2]*t.ascend;a.ascend=l;const d=-n.heading*t.rotate;0!==d&&(g.rotate(a.rotate.matrix,a.rotate.matrix,d,this.tmpCamera.eye),a.rotate.enabled=!0);const p=n.tilt*t.rotate,m=this.clampTiltDeltaGlobalToValidRange(p,e.ray,c);0!==m&&(g.rotate(a.rotate.matrix,a.rotate.matrix,m,this.tmpCamera.viewRight),a.rotate.enabled=!0),a.zoom=n.zoom*t.zoom},i.clampTiltDeltaGlobalToValidRange=function(t,e,a){const i=y.getReferenceEllipsoid(this.view.spatialReference),o=D.onSurfaceTiltToEyeTiltGlobal(b.TiltDefault.min,e.origin,a,i);let n=0,r=0;const s=T.sv3d.get();if(this.view.renderCoordsHelper.intersectManifold(e,a,s)){const t=O.viewAngle(this.view.renderCoordsHelper,s,e.origin);n=D.onSurfaceTiltToEyeTiltGlobal(t,e.origin,a,i),r=D.onSurfaceTiltToEyeTiltGlobal(b.TiltDefault.max,e.origin,a,i)}else{S.sphere.closestPointOnSilhouette(S.sphere.wrap(a+i.radius),e,s);const t=h.acosClamped(-f.dot(e.direction,f.normalize(s,s)));n=D.offSurfaceTiltToEyeTiltGlobal(t,e.origin,a,i),r=D.offSurfaceTiltToEyeTiltGlobal(b.TiltDefault.max,e.origin,a,i)}return h.clamp(n+t,o,r)-n},i.getPointAbsoluteSurfaceElevation=function(t,e,a){const{renderCoordsHelper:i}=this.view,o=i.getAltitude(t),n=e+Math.abs(o-e);return f.copy(a,t),i.setAltitude(n,a),n},i.clampedDistanceToSurface=function(t,e){const{renderCoordsHelper:a}=this.view,{camera:i}=this.view.state,{direction:o}=G.headingTiltToDirectionUp(this.view,e,0,k,P),n=a.intersectManifoldClosestSilhouette(S.ray.wrap(e,o),t,T.sv3d.get()),r=f.distance(e,n),s=a.intersectManifoldClosestSilhouette(S.ray.wrap(e,v.directionFromTo(T.sv3d.get(),e,i.center)),t,T.sv3d.get()),c=f.distance(e,s);return Math.min(r,c)},i.computeHeadingRotateRadius=function(t){const{renderCoordsHelper:e,state:a}=this.view,{camera:i,isGlobal:o}=a,n=e.intersectManifoldClosestSilhouette(i.ray,this.filteredSurfaceElevation,T.sv3d.get());if(o){const e=f.subtract(T.sv3d.get(),t,n),a=f.length(e);f.scale(e,e,1/a);const i=f.normalize(T.sv3d.get(),t),o=h.acosClamped(f.dot(i,e));return a*Math.sin(Math.min(R,o))}{const a=f.copy(T.sv3d.get(),t);return e.setAltitude(this.filteredSurfaceElevation,a),f.distance(n,a)}},i.minimumAscendVelocity=function(){return this.view.state.constraints.collision.enabled?0:H},i.computeVelocities=function(t){const e=this.filteredSurfaceElevation,a=e+y.getReferenceEllipsoid(this.view.spatialReference).radius,{camera:i,isGlobal:o}=this.view.state,n=T.sv3d.get(),r=this.getPointAbsoluteSurfaceElevation(i.eye,e,n),s=this.clampedDistanceToSurface(e,n),c=i.width/2,l=U*i.width,d=U*i.width,p=s*Math.tan(.5*i.fovX)/c,m=p/a,u=p/this.computeHeadingRotateRadius(n),f=r-e;return{pan:(o?m:p)*l*t,ascend:Math.max(this.minimumAscendVelocity()*t,Math.pow(2,l*t/c)*f-f),zoom:Math.pow(2,l*t/c)*s-s,rotate:h.clamp(u*d,F,V)*t}},i.applyDisabledMovementTypes=function(t){!n.isSome(this.disableMovements)||void 0!==this.disableMovements.mode&&this.view.state.mode!==this.disableMovements.mode||(t.zoom=this.disableMovements.zoom?0:t.zoom,t.ascend=this.disableMovements.ascend?0:t.ascend,t.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&g.identity(t.pan.matrix),t.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&g.identity(t.rotate.matrix))},a.activatesFor=function(t,e){const a=w.extractTransformation(e,t.navigation.gamepad,E);return!("end"===e.action||w.isZeroTransformation(a))},a}(z.InteractiveController),a.__decorate([c.property({constructOnly:!0})],t.GamepadKeyboardController.prototype,"view",void 0),a.__decorate([c.property({constructOnly:!0})],t.GamepadKeyboardController.prototype,"gamepadDevice",void 0),a.__decorate([c.property({constructOnly:!0})],t.GamepadKeyboardController.prototype,"disableMovements",void 0),t.GamepadKeyboardController=a.__decorate([l.subclass("esri.views.3d.state.controllers.GamepadKeyboardController")],t.GamepadKeyboardController);const E={translation:[0,0,0],heading:0,tilt:0,zoom:0},k=80,R=h.deg2rad(k),U=.75,H=5,F=h.deg2rad(30),V=h.deg2rad(80),_={zoom:0,ascend:0,pan:{enabled:!1,matrix:C.create()},rotate:{enabled:!1,matrix:C.create()}},K=u.create(),P=A.createDirectionUp();Object.defineProperty(t,"__esModule",{value:!0})}));
