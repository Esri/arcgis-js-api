// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../core/compilerUtils","../../../../core/mathUtils","../../../../core/maybe","../../../../core/accessorSupport/decorators","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../geometry/support/geodesicConstants","../../camera/constraintUtils","../Constraints","./InteractiveController","../utils/navigationUtils","../utils/navigationUtils","../utils/viewUtils","../../support/cameraUtils","../../support/cameraUtilsInternal","../../support/geometryUtils","../../support/mathUtils","../../support/stack","../../webgl-engine/lib/Camera","../../../navigation/gamepadAndKeyboardUtils"],(function(t,e,a,i,r,o,n,s,c,l,p,d,m,v,h,u,f,y,g,C,w,b,T,S,x){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.GamepadKeyboardController=void 0;var O=function(t){function e(e){var a=t.call(this,e)||this;return a.transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0},a.keysButtonState=[0,0,0,0,0,0,0,0,0,0,0,0],a.tmpCamera=new S.default,a.constraintOptions={selection:15,interactionType:0,interactionStartCamera:new S.default,interactionFactor:0,interactionDirection:null,tiltMode:1},a}return a.__extends(e,t),e.prototype.handleEventGamepad=function(t){var e=x.extractTransformation(t,this.view.navigation.gamepad,this.transformation);("end"===t.action||x.isZeroTransformation(e))&&this.finishController()},e.prototype.activateDirection=function(t){this.keysButtonState[t]=1,x.extractTransformationKeyboard(this.keysButtonState,this.transformation)},e.prototype.deactivateDirection=function(t){this.keysButtonState[t]=0;var e=x.extractTransformationKeyboard(this.keysButtonState,this.transformation);x.isZeroTransformation(e)&&this.finishController()},e.prototype.onControllerStart=function(e){this.filteredSurfaceElevation=this.view.pointsOfInterest.cameraOnSurface.location.z,this.headingStart=this.view.camera.heading,t.prototype.onControllerStart.call(this,e)},e.prototype.updateFilteredSurfaceElevation=function(t){var e=this.view.pointsOfInterest.cameraOnSurface.location.z;this.filteredSurfaceElevation+=1*(e-this.filteredSurfaceElevation)*t},e.prototype.stepController=function(e,a){this.updateStartHeading(),this.updateFilteredSurfaceElevation(e),this.currentCamera.copyViewFrom(a),this.updateCameraCenter(),this.constraintOptions.interactionStartCamera.copyFrom(this.currentCamera),this.calculateControlTransformation(e,this.currentCamera,U),this.applyDisabledMovementTypes(U),this.applyPan(U.pan),this.applyRotate(U.rotate),this.applyZoom(U.zoom),this.applyAscend(U.ascend),this.constraintOptions.interactionType=0,this.constraintOptions.selection=8,m.applyAll(this.view,this.currentCamera,this.constraintOptions),t.prototype.stepController.call(this,e,a)},e.prototype.updateStartHeading=function(){0!==this.transformation.heading&&(this.headingStart=this.view.camera.heading)},e.prototype.applyRotate=function(t){if(t.enabled){var e=this.currentCamera,a=e.center,i=e.up,r=e.eye;l.vec3.subtract(a,a,r),l.vec3.transformMat4(a,a,t.matrix),l.vec3.add(a,a,r),l.vec3.transformMat4(i,i,t.matrix),e.markViewDirty(),this.constraintOptions.interactionType=3,this.constraintOptions.selection=7,m.applyAll(this.view,e,this.constraintOptions)}},e.prototype.applyPan=function(t,e){if(void 0===e&&(e=this.currentCamera),t.enabled){var a=e.center,i=e.eye,r=e.up;l.vec3.transformMat4(i,i,t.matrix),l.vec3.transformMat4(a,a,t.matrix),this.view.state.isGlobal&&l.vec3.transformMat4(r,r,t.matrix),e.markViewDirty(),this.constraintOptions.interactionType=4,this.constraintOptions.selection=15,m.applyAll(this.view,e,this.constraintOptions)}},e.prototype.applyZoom=function(t){if(t){var e=this.currentCamera,a=e.eye,i=e.viewForward;l.vec3.add(a,a,l.vec3.scale(T.sv3d.get(),i,t)),this.currentCamera.markViewDirty(),l.vec3.copy(k,i),l.vec3.negate(k,k),this.constraintOptions.interactionDirection=k,this.constraintOptions.interactionType=1,this.constraintOptions.selection=7,m.applyAll(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null}},e.prototype.applyAscend=function(t){if(t){var e=this.currentCamera,a=e.center,i=e.eye,r=this.view.renderCoordsHelper.worldUpAtPosition(i,T.sv3d.get());if(this.constraintOptions.interactionDirection=l.vec3.copy(k,r),this.view.state.isGlobal){var o=l.vec3.length(i),n=(o+t)/o;l.vec3.scale(i,i,n),l.vec3.scale(a,a,n)}else{var s=l.vec3.scale(T.sv3d.get(),r,t);l.vec3.add(i,i,s),l.vec3.add(a,a,s)}this.currentCamera.markViewDirty(),this.updateCameraCenter(),this.constraintOptions.interactionType=5,this.constraintOptions.selection=8,m.applyAll(this.view,this.currentCamera,this.constraintOptions)&&this.updateCameraCenter(),this.constraintOptions.selection=7,m.applyAll(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null}},e.prototype.calculateControlTransformation=function(t,e,a){!function(t){t.zoom=0,t.ascend=0,t.pan.enabled=!1,s.mat4.identity(t.pan.matrix),t.rotate.enabled=!1,s.mat4.identity(t.rotate.matrix)}(a);var i=this.computeVelocities(t);this.view.state.isLocal?this.calculateControlTransformationLocal(i,e,a):this.calculateControlTransformationGlobal(i,e,a)},e.prototype.updateCameraCenter=function(){var t=this.currentCamera,e=t.ray,a=t.center,i=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude;this.view.renderCoordsHelper.intersectManifoldClosestSilhouette(e,i,a),this.currentCamera.markViewDirty()},e.prototype.calculateControlTransformationLocal=function(t,e,a){var o=e.viewRight,n=e.viewForward,c=this.transformation,p=this.view.navigation.gamepad,d=l.vec3.set(T.sv3d.get(),n[0],n[1],0);l.vec3.normalize(d,d);var m=c.translation[0]*t.pan;if(0!==m){var h=l.vec3.scale(T.sv3d.get(),o,m);s.mat4.translate(a.pan.matrix,a.pan.matrix,h),a.pan.enabled=!0}switch(p.mode){case"pan":var u=-c.translation[1]*t.pan;if(0!==u){var f=l.vec3.scale(T.sv3d.get(),d,u);s.mat4.translate(a.pan.matrix,a.pan.matrix,f),a.pan.enabled=!0}a.zoom=c.zoom*t.zoom;break;case"zoom":a.zoom=(-c.translation[1]+c.zoom)*t.zoom;break;default:i.neverReached(p.mode)}var g=c.translation[2]*t.ascend;a.ascend=g;var C=-c.heading*t.rotate;0!==C&&(s.mat4.rotate(a.rotate.matrix,a.rotate.matrix,C,this.view.renderCoordsHelper.worldUpAtPosition(e.eye,T.sv3d.get())),a.rotate.enabled=!0);var w=c.tilt*t.rotate,b=y.viewAngle(this.view.renderCoordsHelper,e.center,e.eye),S=r.clamp(b+w,v.TiltDefault.min,v.TiltDefault.max)-b;S&&(s.mat4.rotate(a.rotate.matrix,a.rotate.matrix,S,o),a.rotate.enabled=!0)},e.prototype.calculateControlTransformationGlobal=function(t,e,a){var i=e.eye,r=e.viewRight,o=this.transformation,n=this.view.navigation.gamepad,c=l.vec3.cross(T.sv3d.get(),r,i);l.vec3.normalize(c,c),l.vec3.negate(c,c),u.panMotionToRotationMatrix(this.beginCamera,e,o,t,this.view.camera.heading,this.headingStart,this.view.camera.tilt,a,n),this.tmpCamera.copyFrom(this.currentCamera),this.applyPan(U.pan,this.tmpCamera);var p=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,d=o.translation[2]*t.ascend;a.ascend=d;var m=-o.heading*t.rotate;0!==m&&(s.mat4.rotate(a.rotate.matrix,a.rotate.matrix,m,this.tmpCamera.eye),a.rotate.enabled=!0);var v=o.tilt*t.rotate,h=this.clampTiltDeltaGlobalToValidRange(v,e.ray,p);0!==h&&(s.mat4.rotate(a.rotate.matrix,a.rotate.matrix,h,this.tmpCamera.viewRight),a.rotate.enabled=!0),a.zoom=o.zoom*t.zoom},e.prototype.clampTiltDeltaGlobalToValidRange=function(t,e,a){var i=f.onSurfaceTiltToEyeTiltGlobal(v.TiltDefault.min,e.origin,a),o=0,n=0,s=T.sv3d.get();if(this.view.renderCoordsHelper.intersectManifold(e,a,s)){var c=y.viewAngle(this.view.renderCoordsHelper,s,e.origin);o=f.onSurfaceTiltToEyeTiltGlobal(c,e.origin,a),n=f.onSurfaceTiltToEyeTiltGlobal(v.TiltDefault.max,e.origin,a)}else{w.sphere.closestPointOnSilhouette(w.sphere.wrap(a+d.earthRadius),e,s);c=r.acosClamped(-l.vec3.dot(e.direction,l.vec3.normalize(s,s)));o=f.offSurfaceTiltToEyeTiltGlobal(c,e.origin,a),n=f.offSurfaceTiltToEyeTiltGlobal(v.TiltDefault.max,e.origin,a)}return r.clamp(o+t,i,n)-o},e.prototype.getPointAbsoluteSurfaceElevation=function(t,e,a){var i=this.view.renderCoordsHelper,r=i.getAltitude(t),o=e+Math.abs(r-e);return l.vec3.copy(a,t),i.setAltitude(o,a),o},e.prototype.clampedDistanceToSurface=function(t,e){var a=this.view.renderCoordsHelper,i=this.view.state.camera,r=g.headingTiltToDirectionUp(this.view,e,0,D,H).direction,o=a.intersectManifoldClosestSilhouette(w.ray.wrap(e,r),t,T.sv3d.get()),n=l.vec3.distance(e,o),s=a.intersectManifoldClosestSilhouette(w.ray.wrap(e,b.directionFromTo(T.sv3d.get(),e,i.center)),t,T.sv3d.get()),c=l.vec3.distance(e,s);return Math.min(n,c)},e.prototype.computeHeadingRotateRadius=function(t){var e=this.view,a=e.renderCoordsHelper,i=e.state,o=i.camera,n=i.isGlobal,s=a.intersectManifoldClosestSilhouette(o.ray,this.filteredSurfaceElevation,T.sv3d.get());if(n){var c=l.vec3.subtract(T.sv3d.get(),t,s),p=l.vec3.length(c);l.vec3.scale(c,c,1/p);var d=l.vec3.normalize(T.sv3d.get(),t),m=r.acosClamped(l.vec3.dot(d,c));return p*Math.sin(Math.min(z,m))}var v=l.vec3.copy(T.sv3d.get(),t);return a.setAltitude(this.filteredSurfaceElevation,v),l.vec3.distance(s,v)},e.prototype.minimumAscendVelocity=function(){return this.view.state.constraints.collision.enabled?0:G},e.prototype.computeVelocities=function(t){var e=this.filteredSurfaceElevation,a=e+d.earthRadius,i=this.view.state,o=i.camera,n=i.isGlobal,s=T.sv3d.get(),c=this.getPointAbsoluteSurfaceElevation(o.eye,e,s),l=this.clampedDistanceToSurface(e,s),p=o.width/2,m=A*o.width,v=A*o.width,h=l*Math.tan(.5*o.fovX)/p,u=h/a,f=h/this.computeHeadingRotateRadius(s),y=c-e;return{pan:(n?u:h)*m*t,ascend:Math.max(this.minimumAscendVelocity()*t,Math.pow(2,m*t/p)*y-y),zoom:Math.pow(2,m*t/p)*l-l,rotate:r.clamp(f*v,E,R)*t}},e.prototype.applyDisabledMovementTypes=function(t){!o.isSome(this.disableMovements)||void 0!==this.disableMovements.mode&&this.view.state.mode!==this.disableMovements.mode||(t.zoom=this.disableMovements.zoom?0:t.zoom,t.ascend=this.disableMovements.ascend?0:t.ascend,t.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&s.mat4.identity(t.pan.matrix),t.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&s.mat4.identity(t.rotate.matrix))},e.activatesFor=function(t,e){var a=x.extractTransformation(e,t.navigation.gamepad,M);return!("end"===e.action||x.isZeroTransformation(a))},a.__decorate([n.property({constructOnly:!0})],e.prototype,"view",void 0),a.__decorate([n.property({constructOnly:!0})],e.prototype,"gamepadDevice",void 0),a.__decorate([n.property({constructOnly:!0})],e.prototype,"disableMovements",void 0),e=a.__decorate([n.subclass("esri.views.3d.state.controllers.GamepadKeyboardController")],e)}(h.InteractiveController);e.GamepadKeyboardController=O;var M={translation:[0,0,0],heading:0,tilt:0,zoom:0},D=80,z=r.deg2rad(D),A=.75,G=5,E=r.deg2rad(30),R=r.deg2rad(80),U={zoom:0,ascend:0,pan:{enabled:!1,matrix:c.mat4f64.create()},rotate:{enabled:!1,matrix:c.mat4f64.create()}},k=p.vec3f64.create(),H=C.createDirectionUp()}));