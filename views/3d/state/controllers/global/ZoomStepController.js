/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../core/has","../../../../../core/Logger","../../../../../core/accessorSupport/ensureType","../../../../../core/accessorSupport/decorators/property","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/urlUtils","../../../../../core/uuid","../../../../../portal/support/resourceExtension","../../../../../chunks/vec3f64","../../../../../chunks/vec3","../../../../../geometry/projectionEllipsoid","../../../support/geometryUtils","../../../webgl-engine/lib/Intersector","../../../camera/constraintUtils/surfaceCollision","../../../../animation/easing","../../../camera/constraintUtils","../../../webgl-engine/lib/Camera","../PointToPointAnimationController","../../utils/navigationUtils"],(function(t,e,i,r,o,a,n,s,c,h,p,l,m,u,d,y,g,C,w,f,v,D){"use strict";t.ZoomStepController=function(t){function i(){var e;return(e=t.apply(this,arguments)||this).zoomLocation=l.create(),e.tmpCamera=new f,e.tmpViewDir=l.create(),e.tmpRayDir={origin:l.create(),direction:l.create()},e.targetOnSphere=l.create(),e.tmpCenter=l.create(),e.constraintOptions={selection:7,interactionType:1,interactionFactor:null,interactionStartCamera:new f,interactionDirection:null,tiltMode:0},e.sphere=d.sphere.create(),e}e._inheritsLoose(i,t);var o=i.prototype;return o.initialize=function(){this.intersector=new y.Intersector(this.view.state.mode)},o.zoomStep=function(t,e){if(!this.active)return;const i=this.view.state,{interactionStartCamera:r}=this.constraintOptions;this.animation.finished?r.copyFrom(i.camera):this.animation.cameraAt(1,r);let o=!1,a=!1;this.intersectionHelper.intersectScreen(e,this.zoomLocation)&&(o=t>0,a=!0),this.tmpCamera.copyFrom(i.camera),o?this.intersectionHelper.intersectRay(this.tmpCamera.ray,this.intersector,this.tmpCenter)&&(this.tmpCamera.center=this.tmpCenter):this.intersectionHelper.intersectRay(this.tmpCamera.ray,this.intersector,this.zoomLocation)?this.tmpCamera.center=this.zoomLocation:m.copy(this.zoomLocation,this.tmpCamera.center),this.updateCamera(this.tmpCamera,t,this.zoomLocation,e,a),this.begin(this.tmpCamera)},o.animationSettings=function(){return{apex:null,duration:.6,easing:C.outExpo}},o.updateCamera=function(t,e,i,o,a){const n=u.getReferenceEllipsoid(this.view.spatialReference);if(D.decideNavigationMode(t,o,a,n)===D.NavigationMode.Horizontal||r("disable-feature:context-navigation")){let r=Math.pow(.6,e);this.sphere.radius=m.length(i),m.subtract(this.tmpViewDir,t.center,t.eye);const a=m.length(this.tmpViewDir);let n=a*r;if(r<=1&&n<4&&(n=4,r=n/a),Math.abs(a-n)<1e-6)return;const s=m.length(t.center);if(this.sphere.radius!==s){const e=this.sphere.radius+r*(s-this.sphere.radius);m.scale(t.center,t.center,e/s)}m.scale(this.tmpViewDir,this.tmpViewDir,-r),m.add(t.eye,t.center,this.tmpViewDir),w.applyAll(this.view,t,this.constraintOptions),m.squaredDistance(i,t.center)>1e-12&&d.sphere.intersectScreen(this.sphere,t,o,this.targetOnSphere)&&D.panToPosition(this.sphere,t,i,this.targetOnSphere,this.view.camera.heading,this.view.camera.tilt,!0)}else{let r=Math.pow(.6,Math.abs(e));const a=e>0?1:-1;let n;d.ray.fromScreenAtEye(t,o,this.tmpRayDir),m.normalize(this.tmpRayDir.direction,this.tmpRayDir.direction),this.view.camera.position.hasZ&&(n=Math.abs(this.view.camera.position.z));let s=Math.max(12*n,20);const c=this.view._stage.renderView.getMinimalDepthForArea(o[0],o[1],this.view._stage.getCamera(),60);s=s>c?c:s,m.scale(this.tmpRayDir.direction,this.tmpRayDir.direction,s),m.add(i,this.tmpRayDir.origin,this.tmpRayDir.direction);let h=s*r;if(e>0&&h<4&&(h=4,r=h/s),Math.abs(s-h)<1e-6)return;m.scale(this.tmpRayDir.direction,this.tmpRayDir.direction,a*(1-r)),m.add(t.eye,t.eye,this.tmpRayDir.direction),m.add(t.center,t.center,this.tmpRayDir.direction)}g.applySurfaceCollisionConstraint(this.view,t)},i}(v.PointToPointAnimationController),t.ZoomStepController=i.__decorate([s.subclass("esri.views.3d.state.controllers.global.ZoomStepController")],t.ZoomStepController),Object.defineProperty(t,"__esModule",{value:!0})}));
