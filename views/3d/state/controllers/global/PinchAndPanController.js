/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../core/Cyclical","../../../../../core/mathUtils","../../../../../core/maybe","../../../../../core/screenUtils","../../../../../core/Logger","../../../../../core/accessorSupport/ensureType","../../../../../core/arrayUtils","../../../../../core/Error","../../../../../core/has","../../../../../core/accessorSupport/decorators/subclass","../../../../../chunks/vec2","../../../../../chunks/vec3","../../../../../chunks/vec3f64","../../../../../geometry/projectionEllipsoid","../../../../../geometry/support/axisAngle","../../../../../geometry/support/plane","../../../../../chunks/sphere","../../../camera/constraintUtils","../../../camera/constraintUtils/ConstraintTypes","../../../camera/constraintUtils/InteractionType","../../../camera/constraintUtils/TiltMode","../../../input/util","../InteractiveController","../momentum/PanPlanarMomentumController","../momentum/PanSphericalMomentumController","../momentum/RotationMomentumController","../momentum/ZoomPlanarMomentumController","../momentum/ZoomSphericalMomentumController","../../utils/navigationUtils","../../../webgl-engine/lib/Camera","../../../../navigation/PanPlanarMomentumEstimator","../../../../navigation/PanSphericalMomentumEstimator","../../../../navigation/RotationMomentumEstimator","../../../../navigation/ZoomMomentumEstimator"],(function(t,e,i,n,a,o,r,s,c,h,m,l,p,_,u,P,d,g,S,M,v,C,y,b,A,w,E,T,O,f,k,R,x,z,F,I,D){"use strict";t.PinchAndPanController=function(t){function i(){var e;return(e=t.apply(this,arguments)||this)._smoothRotation=new A.ExponentialFalloff(.05),e._rotationAxis=P.create(),e._panningPlane=S.create(),e._smoothScaling=new A.ExponentialFalloff(.05),e._zoomCenterScreen=r.createScreenPointArray(),e._zoomMomentumEstimator=new D.ZoomMomentumEstimator,e._rotationMomentumEstimator=new I.RotationMomentumEstimator,e._panSphericalMomentumEstimator=new F.PanSphericalMomentumEstimator,e._panPlanarMomentumEstimator=new z.PanPlanarMomentumEstimator,e._adjustedSphere=M.create(),e._tmp3d=P.create(),e._tmpScreenPointArray=r.createScreenPointArray(),e._beginScreenPoint=r.createScreenPointArray(),e._beginScenePoint=P.create(),e._screenPickPoint=r.createScreenPointArray(),e._mode=R.NavigationMode.Horizontal,e._tmpInteractionDirection=P.create(),e._constraintOptions={selection:C.ConstraintTypes.ALL,interactionType:y.InteractionType.NONE,interactionFactor:0,interactionStartCamera:new x.Camera,interactionDirection:null,tiltMode:b.TiltMode.TUMBLE},e}e._inheritsLoose(i,t);var s=i.prototype;return s.begin=function(t){if(!this.active)return;const e=this.view.navigation.momentumEnabled;this._zoomMomentumEstimator.enabled=e,this._rotationMomentumEstimator.enabled=e,this._panPlanarMomentumEstimator.enabled=e,this._panSphericalMomentumEstimator.enabled=e,this._beginHeading=-n.cyclicalPI.normalize(a.deg2rad(this.view.camera.heading)),this._beginRadius=t.radius,this._pointerCount=t.pointers.size,this._beginAngle=t.angle,this._smoothRotation.reset(),r.screenPointObjectToArray(t.center,this._screenPickPoint),_.copy(this._beginScreenPoint,this._screenPickPoint);const i=d.getReferenceEllipsoid(this.view.spatialReference),s=R.pickPointAndInitSphere(this._intersectionHelper,this.startCamera,this._screenPickPoint,i,R.SpherePickPointFallback.Silhouette);o.isNone(s.scenePickPoint)||(this._scenePickPoint=s.scenePickPoint,this._sphere=s.sphere,u.copy(this._beginScenePoint,this._scenePickPoint),this._mode=R.decideNavigationMode(this.startCamera,this._screenPickPoint,s.hasGeometryIntersection,i),this._mode===R.NavigationMode.Vertical&&this._preparePlanarPanMode(t),this._constraintOptions.interactionStartCamera.copyFrom(this.startCamera))},s.update=function(t){if(!this.active)return;this.currentCamera.copyFrom(this.startCamera);const e=t.pointers.size>1;this._mode===R.NavigationMode.Horizontal?(e&&this._zoomSpherical(t),this._panningSpherical(t),e&&this._rotateSpherical(t)):(e&&this._zoomPlanar(t),this._panningPlanar(t),e&&this._rotatePlanar(t)),this.commitCamera()},s.end=function(t){t.pointers.size===this._pointerCount&&this.update(t),this.finishController();const e=this._zoomMomentumEstimator.evaluateMomentum();if(e)return this._mode===R.NavigationMode.Horizontal?new k.ZoomSphericalMomentumController({view:this.view,momentum:e,screenCenter:this._zoomCenterScreen,sceneCenter:this._beginScenePoint,radius:this._sphere[3]}):new f.ZoomPlanarMomentumController({view:this.view,momentum:e,zoomCenter:this._beginScenePoint});const i=this._rotationMomentumEstimator.evaluateMomentum();if(i)return new O.RotationMomentumController({view:this.view,momentum:i,center:this._sphere,axis:this._rotationAxis});if(this._mode===R.NavigationMode.Horizontal){const t=this._panSphericalMomentumEstimator.evaluateMomentum();if(t)return new T.PanSphericalMomentumController({view:this.view,momentum:t})}else{const t=this._panPlanarMomentumEstimator.evaluateMomentum();if(t)return new E.PanPlanarMomentumController({view:this.view,momentum:t})}return null},s._preparePlanarPanMode=function(t){const e=u.negate(this._tmp3d,this.startCamera.viewForward);S.fromPositionAndNormal(this._scenePickPoint,e,this._panningPlane);const i=r.createScreenPointArray(this._screenPickPoint[0],0),n=P.create(),a=u.length(this.startCamera.eye);this._adjustedSphere[3]=a<this._sphere[3]?a-100:this._sphere[3],R.sphereOrPlanePointFromScreenPoint(this._adjustedSphere,this.startCamera,i,n);const s=r.createRenderScreenPointArray3();this.startCamera.projectToRenderScreen(n,s);const c=.9*s[1];this._screenPickPoint[1]=Math.min(this._screenPickPoint[1],c);const h=this._intersectionHelper.intersectScreen(this._screenPickPoint,this._scenePickPoint);h&&S.fromPositionAndNormal(this._scenePickPoint,S.normal(this._panningPlane),this._panningPlane);const m=P.create(),l=P.create(),p=P.create(),_=80,d=5,g=50;u.subtract(m,this._scenePickPoint,this.currentCamera.eye);const M=u.length(m);u.normalize(m,m);const v=d*Math.max(Math.abs(this.view.camera.position.z),g),C=this.view._stage.renderView.getMinimalDepthForArea(null,this._screenPickPoint[0],this._screenPickPoint[1],this.view.state.camera,_);let y=o.isSome(C)?Math.min(C,v):v;y=h?Math.min(y,M):y,u.copy(p,u.add(l,this.currentCamera.eye,u.scale(l,m,y))),this._panningPlane[3]=-u.dot(this._panningPlane,p),this.startCamera.center=u.add(l,this.startCamera.eye,u.scale(l,this.startCamera.viewForward,y));const b=r.screenPointObjectToArray(t.center,this._tmpScreenPointArray);R.intersectPlaneFromScreenPointAtEye(this._panningPlane,this.startCamera,b,this._beginScenePoint)},s._zoomSpherical=function(t){const e=this._beginRadius/t.radius,i=.001875*Math.min(Math.max(t.radius,40),120);this._smoothScaling.gain=i,this._smoothScaling.update(e),R.applyZoomOnSphere(this._sphere,this.currentCamera,this._smoothScaling.value),r.screenPointObjectToArray(t.center,this._zoomCenterScreen),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*t.timestamp),this._constraintOptions.interactionType=y.InteractionType.ZOOM,this._constraintOptions.interactionFactor=v.pixelDistanceToInteractionFactor(t.radius-this._beginRadius),v.applyAll(this.view,this.currentCamera,this._constraintOptions)},s._panningSpherical=function(t){const e=r.screenPointObjectToArray(t.center,this._tmpScreenPointArray);R.sphereOrPlanePointFromScreenPoint(this._sphere,this.currentCamera,e,this._tmp3d),R.preserveHeadingThreshold(this._beginScenePoint,u.dot(this.currentCamera.up,this._beginScenePoint),this._sphere[3],this._beginHeading,this.view.camera.tilt,this.startCamera)?(R.applyPanSphericalPreserveHeading(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this._beginHeading,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumPreserveHeading(e,this._tmp3d,.001*t.timestamp,this.startCamera,this._sphere,this._beginHeading,this.view.camera.tilt)):(R.applyPanSphericalDirectRotation(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumDirectRotation(e,this._tmp3d,.001*t.timestamp,this.startCamera,this._sphere[3],this.view.camera.tilt)),this._constraintOptions.interactionType=y.InteractionType.PAN,this._constraintOptions.interactionFactor=v.pixelDistanceToInteractionFactor(_.distance(this._screenPickPoint,e)),v.applyAll(this.view,this.currentCamera,this._constraintOptions)},s._rotateSpherical=function(t){u.normalize(this._rotationAxis,this._scenePickPoint),this.currentCamera.aboveGround||u.negate(this._rotationAxis,this._rotationAxis);const e=this._smoothRotation.value,i=e+R.normalizeRotationDelta(t.angle-e),n=.00125*Math.min(Math.max(t.radius,40),120);this._smoothRotation.gain=n,this._smoothRotation.update(i);const a=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(a,.001*t.timestamp),R.applyRotation(this.currentCamera,this._sphere,g.wrapAxisAngle(this._rotationAxis,a)),this._constraintOptions.interactionType=y.InteractionType.TUMBLE,this._constraintOptions.interactionFactor=v.pixelDistanceToInteractionFactor(t.radius*i),v.applyAll(this.view,this.currentCamera,this._constraintOptions)},s._panningPlanar=function(t){const e=r.screenPointObjectToArray(t.center,this._tmpScreenPointArray);R.intersectPlaneFromScreenPointAtEye(this._panningPlane,this.currentCamera,e,this._tmp3d)&&(R.applyPanPlanar(this.currentCamera,this._beginScenePoint,this._tmp3d),this._panPlanarMomentumEstimator.add(e,this._tmp3d,.001*t.timestamp),this._constraintOptions.interactionType=y.InteractionType.PAN,this._constraintOptions.interactionFactor=v.pixelDistanceToInteractionFactor(_.distance(this._beginScreenPoint,e)),this._constraintOptions.interactionDirection=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,this._tmpInteractionDirection),v.applyAll(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null)},s._zoomPlanar=function(t){const e=this._beginRadius/t.radius,i=.001875*Math.min(Math.max(t.radius,40),120);this._smoothScaling.gain=i,this._smoothScaling.update(e),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*t.timestamp),R.applyZoomToPoint(this.currentCamera,this._beginScenePoint,this._smoothScaling.value,this.view.state.constraints.minimumPoiDistance),this._constraintOptions.interactionType=y.InteractionType.ZOOM,this._constraintOptions.interactionFactor=v.pixelDistanceToInteractionFactor(t.radius-this._beginRadius),v.applyAll(this.view,this.currentCamera,this._constraintOptions)},s._rotatePlanar=function(t){u.copy(this._rotationAxis,this._beginScenePoint),this.currentCamera.aboveGround||u.negate(this._rotationAxis,this._rotationAxis);const e=this._smoothRotation.value;let i=t.angle-e;i=R.normalizeRotationDelta(i);const n=e+i,a=.00125*Math.min(Math.max(t.radius,40),120);this._smoothRotation.gain=a,this._smoothRotation.update(n);const o=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(o,.001*t.timestamp),R.applyRotation(this.currentCamera,this._sphere,g.wrapAxisAngle(this._rotationAxis,o)),this._constraintOptions.interactionType=y.InteractionType.TUMBLE,this._constraintOptions.interactionFactor=v.pixelDistanceToInteractionFactor(t.radius*o),v.applyAll(this.view,this.currentCamera,this._constraintOptions)},e._createClass(i,[{key:"_intersectionHelper",get:function(){return this.view.sceneIntersectionHelper}}]),i}(w.InteractiveController),t.PinchAndPanController=i.__decorate([p.subclass("esri.views.3d.state.controllers.global.PinchAndPanController")],t.PinchAndPanController),Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
