// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","../../../../core/maybe","../../../../core/PooledArray","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../support/geometryUtils","../../support/stack","../../webgl-engine/lib/Intersector","../../webgl-engine/lib/intersectorUtils"],(function(e,t,r,i,n,s,o,a,c,l,d){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SceneIntersectionHelper=void 0;var u,v=function(){function e(e,t,r){this.viewingMode=e,this.layerProvider=t,this.view=r,this.externalIntersectionHandlers=new i,this.tolerance=l.Intersector.DEFAULT_TOLERANCE,this.tmpRay=a.ray.create(),this.validateHUDIntersector=new l.Intersector(this.viewingMode),this.validateHUDIntersector.options.hud=!1}return e.prototype.intersectScreen=function(e,t){return this.intersectRay(this.getPickRay(e,this.tmpRay),h(this.viewingMode),t)},e.prototype.intersectScreenFreePointFallback=function(e,t){return this.intersectRayFreePointFallback(this.getPickRay(e,this.tmpRay),t)},e.prototype.intersectRayFreePointFallback=function(e,t){return this.intersectRay(e,h(this.viewingMode),t)||this.intersectRayFreePointLocal(e,t)},e.prototype.intersectRay=function(e,t,r,i){return t.options.selectionMode=!1,t.options.store=0,this.computeIntersection(e,t,i),!!t.results.min&&t.results.min.getIntersectionPoint(r)},e.prototype.getCenterRayWithSubpixelOffset=function(e,t,r,i){return void 0===r&&(r=.5),void 0===i&&(i=.5),e.getRenderCenter(m,r,i),m[0]+=.0466,m[1]-=.0123,a.ray.fromRenderAtEye(e,m,t)},e.prototype.intersectIntersectorScreen=function(e,t,r){this.computeIntersection(this.getPickRay(e,this.tmpRay),t,r)},e.prototype.intersectToolIntersectorScreen=function(e,t,r){var i=this.getPickRay(e,this.tmpRay);this.intersectToolIntersectorRay(i,t,r)},e.prototype.intersectToolIntersectorRay=function(e,t,r){t.options.selectionMode=!0,this.computeIntersection(e,t,r);var i=t.results.min;!!this.view.basemapTerrain&&this.view.basemapTerrain.isOpaque()||i.hasIntersectionPoint&&"TerrainRenderer"!==i.intersector||(t.options.selectionMode=!1,this.computeIntersection(e,t,r))},e.prototype.setTolerance=function(e){void 0===e&&(e=l.Intersector.DEFAULT_TOLERANCE),this.tolerance=e},e.prototype.addIntersectionHandler=function(e){this.externalIntersectionHandlers.push(e),this.externalIntersectionHandlers.sort((function(e,t){return"Terrain"===e.type?1:"Terrain"===t.type?-1:0}))},e.prototype.removeIntersectionHandler=function(e){this.externalIntersectionHandlers.removeUnordered(e),this.externalIntersectionHandlers.sort((function(e,t){return"Terrain"===e.type?1:"Terrain"===t.type?-1:0}))},e.prototype.getPickRay=function(e,t){void 0===t&&(t=a.ray.create());var r=this.view.state.camera;return a.ray.fromScreen(r,e,t)},e.prototype.intersectRayFreePointLocal=function(e,t){if(2!==this.viewingMode)return!1;var r=this.view.dataExtent,i={x:r.xmax-r.xmin,y:r.ymax-r.ymin,z:8*Math.max(r.xmax-r.xmin,r.ymax-r.ymin)},n=Math.max(i.x,i.y,i.z);if(0===n)return s.vec3.add(t,e.origin,s.vec3.normalize(c.sv3d.get(),e.direction)),!0;var o=this.view.state.camera,a=Math.max(0,r.xmin-o.eye[0],o.eye[0]-r.xmax),l=Math.max(0,r.ymin-o.eye[1],o.eye[1]-r.ymax),d=Math.sqrt(a*a+l*l),u=Math.abs(o.relativeElevation)+Number.MIN_VALUE,v=Math.pow(Math.max(0,Math.log(n/u)),2),p=n/Math.max(1,v);p=Math.max(p,Math.min(d,n));var h=s.vec3.scale(c.sv3d.get(),e.direction,p/s.vec3.length(e.direction));return s.vec3.add(t,e.origin,h),!0},e.prototype.intersectElevationFromScreen=function(e,t,r){return void 0===r&&(r=0),this.intersectElevation(this.getPickRay(e,this.tmpRay),t,r)},e.prototype.intersectElevation=function(e,t,i){void 0===i&&(i=0);var o=r.isSome(t)?t.mode:"absolute-height",a=r.isSome(t)?r.unwrapOr(t.offset,0):0,u="on-the-ground"!==o?a+i:0,v=u/this.view.renderCoordsHelper.unitInMeters;if("absolute-height"===o){if(this.view.renderCoordsHelper.intersectManifold(e,u,f)){var p=this.view.computeMapPointFromVec3d(f);return p.z-=a,p}return null}var h=this.view.state.camera,m=n.castRenderScreenPointArray3(c.sv3d.get());h.projectPoint(e.origin,m);var g=this.prepareFilters(null,y),P=this.view.slicePlane,I=r.isSome(P)?d.sliceFilterPredicate(P):null,R=new l.Intersector(this.viewingMode);R.options.store=0,R.options.verticalOffset=v;var x=e.origin,w=s.vec3.add(c.sv3d.get(),x,e.direction);switch(R.reset(x,w),R.point=m,R.camera=h,R.filterPredicate=null,o){case"relative-to-scene":R.intersect(g.layers,m,h,this.tolerance,null,(function(e){return e.metadata&&e.metadata.isElevationSource})),this.externalIntersectionHandlers.forEachSimple((function(e){if("I3S"===e.type||"Terrain"===e.type){var t=e.slicePlane?I:null;e.intersect(R,t,R.rayBeginPoint,R.rayEndPoint,m)}}));break;case"on-the-ground":case"relative-to-ground":this.externalIntersectionHandlers.forEachSimple((function(e){if(e.isGround){var t=e.slicePlane?I:null;e.intersect(R,t,R.rayBeginPoint,R.rayEndPoint,m)}}))}if(R.results.min.getIntersectionPoint(f)){var b=this.view.computeMapPointFromVec3d(f);return b.z=i,b}return null},e.prototype.computeIntersection=function(e,t,i){var o=this,a=this.view.state.camera,l=n.castRenderScreenPointArray3(c.sv3d.get());a.projectPoint(e.origin,l);var u=this.prepareFilters(i,y);t.options.selectOpaqueTerrainOnly=!i||!("include"in i||"exclude"in i);var v=e.origin,p=s.vec3.add(c.sv3d.get(),e.origin,e.direction);t.reset(v,p),t.intersect(u.layers,l,a,this.tolerance);var h=this.view.slicePlane,f=r.isSome(h)?d.sliceFilterPredicate(h):null;t.intersect(u.sliceableLayers,l,a,this.tolerance,f);var m=i&&(i.requiresGroundFeedback||i.enableDraped);this.externalIntersectionHandlers.forEachSimple((function(e){if(t.options.isFiltered=!u.filterLayerUid(e.intersectionHandlerId),e.isGround&&m||!t.options.isFiltered){var r=e.slicePlane?f:null;e.intersect(t,r,v,p,l)}}));var g=c.sv3d.get();if(i&&i.enableDraped&&t.results.ground.getIntersectionPoint(g)){var P=this.view.basemapTerrain.overlayManager.renderer,I=this.view.renderCoordsHelper.spatialReference,R=c.sv3d.get();this.view.renderCoordsHelper.fromRenderCoords(g,R,this.view.spatialReference),R[2]=this.view.elevationProvider.getElevation(g[0],g[1],g[2],I,"ground")||0,P.intersect(t,R,u.filterRenderGeometry)}t.sortResults();var x=t.results.hud;if(x.hasIntersectionPoint){var w=n.castRenderScreenPointArray3(c.sv3d.get()),b=c.sv3d.get(),M=c.sv3d.get();this.unprojectHUDResultRay(x.center,w,b,M);var H=s.vec3.distance(x.center,b)/s.vec3.distance(b,M)*.99;this.validateHUDIntersector.reset(b,M),this.validateHUDIntersector.intersect(u.layers,w,a,this.tolerance),this.validateHUDIntersector.intersect(u.sliceableLayers,w,a,this.tolerance,f),this.externalIntersectionHandlers.forEachSimple((function(e){if(u.filterLayerUid(e.intersectionHandlerId)){var t=e.slicePlane?f:null;e.intersect(o.validateHUDIntersector,t,b,M,w)}}));var S=this.validateHUDIntersector.results.min;(null==S.dist||H<=S.dist)&&(t.results.min.copyFrom(x),t.results.all.splice(0,0,x))}},e.prototype.prepareFilters=function(e,t){var r=[],i=[];return this.layerProvider.forEachLayer((function(e){e.isPickable&&(e.isSliceable?i:r).push(e)})),t.include=e&&e.include,t.exclude=e&&e.exclude,t.layers.length=0,t.sliceableLayers.length=0,p(r,t.filterLayer,t.layers),p(i,t.filterLayer,t.sliceableLayers),t},e.prototype.unprojectHUDResultRay=function(e,t,r,i){var s=this.view.state.camera;s.projectPoint(e,t);var o=n.castRenderScreenPointArray3(c.sv3d.get());o[0]=t[0],o[1]=t[1],o[2]=0,s.unprojectPoint(o,r),o[2]=1,s.unprojectPoint(o,i)},e}();function p(e,t,r){for(var i=0,n=e;i<n.length;i++){var s=n[i];t&&!t(s)||r.push(s)}return r}function h(e){return u||(u=new l.Intersector(e)),u.viewingMode=e,u}t.SceneIntersectionHelper=v;var y={include:null,exclude:null,layers:[],sliceableLayers:[],filterLayer:function(e){return y.filterLayerUid(e.apiLayerUid)},filterLayerUid:function(e){var t=y.include,i=y.exclude;return r.isNone(e)?null==t&&null==i:(null==t||t.has(e))&&(null==i||!i.has(e))},filterRenderGeometry:function(e){return y.filterLayerUid(e.data.layerUid)}},f=o.vec3f64.create(),m=n.createRenderScreenPointArray()}));