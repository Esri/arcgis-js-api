/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/Evented","../../../core/maybe","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../../core/accessorSupport/watch","../../../chunks/vec3f64","../../../geometry/projectionEllipsoid","../../ViewAnimation","../../ViewingMode","./Constraints","./controllers/AnimationController","./controllers/CameraController","../support/PropertiesPool","../webgl-engine/lib/Camera"],(function(e,t,r,o,a,n,i,s,l,c,p,d,u,m,h,_,g,y,f,C){"use strict";let w=function(t){function r(){var r;return(r=t.apply(this,arguments)||this)._propertiesPool=new f.PropertiesPool({camera:C.default},e._assertThisInitialized(r)),r._lastSeenCameraProjectionValues=new C.default,r.events=new o,r.viewingMode=h.ViewingMode.Global,r._cameraChanged=!1,r.updateQueue=new Array,r.processingUpdates=!1,r}e._inheritsLoose(r,t);var n=r.prototype;return n.init=function(e,t){this._set("viewingMode",e),this._set("spatialReference",t),this._set("constraints",new _.default({mode:this.viewingMode}))},n.exit=function(){this.cameraController=null,this._propertiesPool.destroy(),this._propertiesPool=new f.PropertiesPool({camera:C.default},this)},n.createInitialCamera=function(){if(this.viewingMode===h.ViewingMode.Global){const e=u.getReferenceEllipsoid(this.spatialReference).radius;this.camera=new C.default(d.fromValues(4*e,0,0),d.fromValues(e,0,0),d.fromValues(0,0,1))}else this.camera=new C.default(d.fromValues(0,0,100),d.fromValues(0,0,0),d.fromValues(0,1,0))},n.switchCameraController=function(e){return this.cameraController=e,e.state!==y.State.Rejected},n.stopActiveCameraController=function(){return!(this.cameraController&&!this.cameraController.stopController())},n.updateCamera=function(e){this.updateQueue.push(e),this._processUpdateQueue()},n._processUpdateQueue=function(){if(0===this.updateQueue.length||this.processingUpdates)return;this.processingUpdates=!0;const e=this.updateQueue.shift();P.copyFrom(this._get("camera")),e(P),this.camera=P,this.processingUpdates=!1,this._processUpdateQueue()},n._cameraProjectionChanged=function(e,t){return e.fov!==t.fov||(e.fullViewport[0]!==t.fullViewport[0]||e.fullViewport[1]!==t.fullViewport[1]||e.fullViewport[2]!==t.fullViewport[2]||e.fullViewport[3]!==t.fullViewport[3]||(e.padding[C.PaddingSide.TOP]!==t.padding[C.PaddingSide.TOP]||e.padding[C.PaddingSide.RIGHT]!==t.padding[C.PaddingSide.RIGHT]||e.padding[C.PaddingSide.BOTTOM]!==t.padding[C.PaddingSide.BOTTOM]||e.padding[C.PaddingSide.LEFT]!==t.padding[C.PaddingSide.LEFT]))},e._createClass(r,[{key:"animation",get:function(){return this.cameraController instanceof g.AnimationController&&a.isSome(this.cameraController.viewAnimation)?this.cameraController.viewAnimation:null}},{key:"camera",get:function(){return this._get("camera")},set:function(e){e!==P&&P.copyFrom(e),P.computeUp(this.viewingMode),S.camera=P,this.events.emit("before-camera-change",S);const t=this._get("camera");if(this._cameraProjectionChanged(this._lastSeenCameraProjectionValues,P)&&(this._lastSeenCameraProjectionValues.copyFrom(P),V.camera=this._lastSeenCameraProjectionValues,this.events.emit("camera-projection-changed",V)),(!t||!t.equals(P))&&(this._set("camera",this._propertiesPool.get("camera").copyFrom(P)),this._cameraChanged=!t||!t.almostEquals(P),this._cameraChanged)){const e=p.afterDispatch((()=>{this._cameraChanged=!1,e.remove()}))}}},{key:"contentCamera",get:function(){return a.isSome(this._contentCamera)?this._contentCamera:this.camera},set:function(e){this._contentCamera=a.isSome(e)?e.clone():null}},{key:"fixedContentCamera",get:function(){return!!a.isSome(this._contentCamera)}},{key:"isGlobal",get:function(){return this.viewingMode===h.ViewingMode.Global}},{key:"isLocal",get:function(){return this.viewingMode===h.ViewingMode.Local}},{key:"navigating",get:function(){return!(!this.cameraController||!this.cameraController.isInteractive)}},{key:"stationary",get:function(){return!this._cameraChanged&&!this.navigating}},{key:"cameraController",get:function(){return this._get("cameraController")},set:function(e){this.stopActiveCameraController()?(e&&(e.watch("state",(t=>{t!==y.State.Finished&&t!==y.State.Stopped||(this._set("cameraController",null),this.updateCamera((t=>e.onControllerEnd(t))))}),!0),e.onControllerStart(this.camera)),this._set("cameraController",e)):e&&(e.state=y.State.Rejected)}}]),r}(r);t.__decorate([n.property({readOnly:!0,type:m})],w.prototype,"animation",null),t.__decorate([n.property({type:C.default})],w.prototype,"camera",null),t.__decorate([n.property({})],w.prototype,"_contentCamera",void 0),t.__decorate([n.property({type:C.default})],w.prototype,"contentCamera",null),t.__decorate([n.property({readOnly:!0})],w.prototype,"fixedContentCamera",null),t.__decorate([n.property({readOnly:!0})],w.prototype,"constraints",void 0),t.__decorate([n.property({readOnly:!0})],w.prototype,"events",void 0),t.__decorate([n.property({readOnly:!0})],w.prototype,"isGlobal",null),t.__decorate([n.property({readOnly:!0})],w.prototype,"isLocal",null),t.__decorate([n.property({readOnly:!0})],w.prototype,"viewingMode",void 0),t.__decorate([n.property({readOnly:!0})],w.prototype,"spatialReference",void 0),t.__decorate([n.property({readOnly:!0})],w.prototype,"navigating",null),t.__decorate([n.property({readOnly:!0})],w.prototype,"stationary",null),t.__decorate([n.property()],w.prototype,"_cameraChanged",void 0),t.__decorate([n.property()],w.prototype,"cameraController",null),w=t.__decorate([c.subclass("esri.views.3d.state.ViewState")],w);const v=w,P=new C.default,S={camera:null},V={camera:null};return v}));
