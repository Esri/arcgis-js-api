/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/has","../../../core/maybe","../../../core/Logger","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass","../../../core/urlUtils","../../../core/uuid","../../../portal/support/resourceExtension","../../../core/accessorSupport/watch","../../../core/Accessor","../../../core/Evented","../../../chunks/vec3f64","../../../geometry/projectionEllipsoid","../../ViewAnimation","./Constraints","../webgl-engine/lib/Camera","./controllers/CameraController","./controllers/AnimationController","../support/PropertiesPool"],(function(e,t,r,o,a,n,s,i,l,c,p,u,d,m,h,y,_,g,f,C,v,w){"use strict";let V=function(t){function r(){var r;return(r=t.call(this)||this)._propertiesPool=new w.PropertiesPool({camera:f},e._assertThisInitialized(r)),r._lastSeenCameraProjectionValues=new f,r.events=new m,r.mode=1,r._cameraChanged=!1,r.updateQueue=new Array,r.processingUpdates=!1,r}e._inheritsLoose(r,t);var a=r.prototype;return a.exit=function(){this.cameraController=null,this._propertiesPool.destroy(),this._propertiesPool=new w.PropertiesPool({camera:f},this)},a.init=function(e,t){this._set("mode",e),this._set("spatialReference",t),this.camera=function(e,t){if(1===e){const e=y.getReferenceEllipsoid(t).radius;return new f(h.fromValues(4*e,0,0),h.fromValues(e,0,0),h.fromValues(0,0,1))}return new f(h.fromValues(0,0,100),h.fromValues(0,0,0),h.fromValues(0,1,0))}(this.mode,t),this._set("constraints",new g.default({mode:this.mode}))},a.switchCameraController=function(e){return this.cameraController=e,e.state!==C.State.Rejected},a.stopActiveCameraController=function(){return!(this.cameraController&&!this.cameraController.stopController())},a.updateCamera=function(e){this.updateQueue.push(e),this.processUpdateQueue()},a.processUpdateQueue=function(){if(0===this.updateQueue.length||this.processingUpdates)return;this.processingUpdates=!0;const e=this.updateQueue.shift();S.copyFrom(this._get("camera")),e(S),this.camera=S,this.processingUpdates=!1,this.processUpdateQueue()},a.cameraProjectionChanged=function(e,t){return e.fov!==t.fov||(e.fullViewport[0]!==t.fullViewport[0]||e.fullViewport[1]!==t.fullViewport[1]||e.fullViewport[2]!==t.fullViewport[2]||e.fullViewport[3]!==t.fullViewport[3]||(e.padding[0]!==t.padding[0]||e.padding[1]!==t.padding[1]||e.padding[2]!==t.padding[2]||e.padding[3]!==t.padding[3]))},e._createClass(r,[{key:"animation",get:function(){return this.cameraController instanceof v.AnimationController&&o.isSome(this.cameraController.viewAnimation)?this.cameraController.viewAnimation:null}},{key:"camera",get:function(){return this._get("camera")},set:function(e){e!==S&&S.copyFrom(e),S.markViewDirty(),S.computeUp(this.mode),O.camera=S,this.events.emit("before-camera-change",O);const t=this._get("camera");if(this.cameraProjectionChanged(this._lastSeenCameraProjectionValues,S)&&(this._lastSeenCameraProjectionValues.copyFrom(S),k.camera=this._lastSeenCameraProjectionValues,this.events.emit("camera-projection-changed",k)),(!t||!t.equals(S))&&(this._set("camera",this._propertiesPool.get("camera").copyFrom(S)),this._cameraChanged=!t||!t.almostEquals(S),this._cameraChanged)){const e=u.afterDispatch((()=>{this._cameraChanged=!1,e.remove()}))}}},{key:"isGlobal",get:function(){return!this.isLocal}},{key:"isLocal",get:function(){return 2===this.mode}},{key:"navigating",get:function(){return!(!this.cameraController||!this.cameraController.isInteractive)}},{key:"stationary",get:function(){return!this._cameraChanged&&!this.navigating}},{key:"cameraController",get:function(){return this._get("cameraController")},set:function(e){this.stopActiveCameraController()?(e&&(e.watch("state",(t=>{t!==C.State.Finished&&t!==C.State.Stopped||(this._set("cameraController",null),this.updateCamera((t=>e.onControllerEnd(t))))}),!0),e.onControllerStart(this.camera)),this._set("cameraController",e)):e&&(e.state=C.State.Rejected)}}]),r}(d);t.__decorate([s.property({readOnly:!0,type:_,dependsOn:["cameraController"]})],V.prototype,"animation",null),t.__decorate([s.property({type:f})],V.prototype,"camera",null),t.__decorate([s.property({readOnly:!0})],V.prototype,"constraints",void 0),t.__decorate([s.property({readOnly:!0})],V.prototype,"events",void 0),t.__decorate([s.property({readOnly:!0,dependsOn:["isLocal"]})],V.prototype,"isGlobal",null),t.__decorate([s.property({readOnly:!0,dependsOn:["mode"]})],V.prototype,"isLocal",null),t.__decorate([s.property({readOnly:!0})],V.prototype,"mode",void 0),t.__decorate([s.property({constructOnly:!0})],V.prototype,"spatialReference",void 0),t.__decorate([s.property({readOnly:!0,dependsOn:["cameraController"]})],V.prototype,"navigating",null),t.__decorate([s.property({readOnly:!0,dependsOn:["navigating","_cameraChanged"]})],V.prototype,"stationary",null),t.__decorate([s.property()],V.prototype,"_cameraChanged",void 0),t.__decorate([s.property()],V.prototype,"cameraController",null),V=t.__decorate([i.subclass("esri.views.3d.state.ViewState")],V);var P=V;const S=new f;const O={camera:null},k={camera:null};return P}));
