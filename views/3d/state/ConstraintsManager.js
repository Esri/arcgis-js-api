// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../core/Accessor","../../../core/Handles","../../../core/mathUtils","../../../core/maybe","../../../core/watchUtils","../../../core/accessorSupport/decorators","../camera/constraintUtils","../camera/intersectionUtils","./NearFarHeuristic","./SurfaceCollisionConstraint"],(function(t,a,e,i,n,s,r,o,c,u,l,p,d){"use strict";Object.defineProperty(a,"__esModule",{value:!0}),a.ConstraintsManager=void 0;var h=function(t){function a(a){var e=t.call(this,a)||this;return e._handles=new n,e.nearFarHeuristic=p.createNearFarHeuristic(a.view.state.mode,a.view.basemapTerrain,a.view.renderCoordsHelper.spatialReference),e}return e.__extends(a,t),a.prototype.initialize=function(){var t=this;this._handles.add([this.view.watch(["constraints.clipDistance.near","constraints.clipDistance.far"],(function(){return t._clipDistanceNearFarChanged()})),this.view.watch("constraints.clipDistance.mode",(function(){return t._updateNearFar()})),this.view.state.events.on("before-camera-change",(function(a){return t._updateCameraNearFar(a.camera)})),this.view.watch("dataExtent",(function(){return t._updateNearFar()}),!0),this.view.watch(["constraints.altitude.min","constraints.altitude.max"],(function(){return t._updateAltitude()}),!0),this.view.watch("constraints.tilt.max",(function(){return t._updateTiltMax()}),!0),this.view.watch("constraints.tilt.mode",(function(){return t._updateTilt()}),!0),this.view.watch("state.camera",(function(){return t._updateTiltAutoMax()}),!0),this.view.watch(["map.ground.navigationConstraint.type","constraints.collision.enabled"],(function(){return t._updateCollision()}),!0)]),this.view.state.isLocal&&this._handles.add(o.init(this.view,"dataExtent",(function(a){return t._updateLocalSurfaceDistance(a)}))),this._updateNearFar(),2!==this.view.state.mode&&this._updateAltitude(),this._updateTilt(),this._updateCollision(),this._set("surfaceCollisionConstraint",new d.default({view:this.view}))},a.prototype.destroy=function(){this._handles=r.destroyMaybe(this._handles),this.surfaceCollisionConstraint&&(this.surfaceCollisionConstraint.destroy(),this._set("surfaceCollisionConstraint",null))},a.prototype._clipDistanceNearFarChanged=function(){var t=this,a=this.view.constraints&&this.view.constraints.clipDistance;a&&"auto"!==a.mode&&this.view.state.updateCamera((function(e){return t._updateCameraNearFarManual(e,a),!0}))},a.prototype._updateNearFar=function(){var t=this;this.view.state.updateCamera((function(a){return t._updateCameraNearFar(a),!0}))},a.prototype._updateCameraNearFar=function(t){var a=this.view.constraints&&this.view.constraints.clipDistance;"manual"===(a?a.mode:"auto")?this._updateCameraNearFarManual(t,a):this._updateCameraNearFarAuto(t,a)},a.prototype._updateCameraNearFarAuto=function(t,a){this.nearFarHeuristic.compute(t.eye,t.center,this.view.dataExtent,l.surfaceElevationBelowEye(this.view,t),t),a&&a.autoUpdate(t.near,t.far)},a.prototype._updateCameraNearFarManual=function(t,a){a&&(t.near=a.near,t.far=a.far)},a.prototype._updateCollision=function(){var t=this.view.map&&this.view.map.ground&&this.view.map.ground.navigationConstraint,a=this.view.constraints&&this.view.constraints.collision.enabled,e=t?"stay-above"===t.type:a,i=this.view.state.constraints.collision;if(e!==i.enabled){i.enabled=e,e&&this._reapplyConstraints(8);var n=this.view.constraints&&this.view.constraints.tilt;n&&"auto"!==n.mode||this._updateTiltAuto()}},a.prototype._updateAltitude=function(){var t=this.view.constraints&&this.view.constraints.altitude;t&&2!==this.view.state.mode?this.view.state.constraints.altitude={min:t.min,max:t.max}:this.view.state.constraints.altitude=null,this._reapplyConstraints()},a.prototype._updateTiltMax=function(){var t=this.view.constraints&&this.view.constraints.tilt;t&&"auto"!==t.mode&&(this._updateTiltManual(t),this._reapplyConstraints())},a.prototype._updateTilt=function(){var t=this.view.constraints&&this.view.constraints.tilt;"manual"===(t?t.mode:"auto")?this._updateTiltManual(t):this._updateTiltAuto(),this._reapplyConstraints()},a.prototype._updateTiltManual=function(t){var a=this.view.state.constraints;a.tilt=a.createConstantMaxTilt(s.deg2rad(t.max))},a.prototype._updateTiltAuto=function(){var t=this.view.state.constraints;t.tilt=t.createDefaultTilt(),this._updateTiltAutoMax()},a.prototype._updateTiltAutoMax=function(){var t=this.view.constraints&&this.view.constraints.tilt;if(t&&"auto"===t.mode){var a=this.view.state.constraints;if(a.tilt){var e=a.tilt(this.view.state.camera.distance).max;t.autoUpdate(s.rad2deg(e))}}},a.prototype._updateLocalSurfaceDistance=function(t){var a=Math.max(t.width,t.height);if(!(a<=0)){t.hasZ&&(a=Math.max(a,t.zmax-t.zmin));var e=this.view.state,i=3*a/Math.atan(e.camera.fov/2);i!==e.constraints.distance&&(e.constraints.distance=i)}},a.prototype._reapplyConstraints=function(t){var a=this;void 0===t&&(t=15),this.view.state.updateCamera((function(e){return u.applyAll(a.view,e,{selection:t,interactionType:0,interactionFactor:null,interactionStartCamera:null,interactionDirection:null,tiltMode:0})}))},e.__decorate([c.property({constructOnly:!0})],a.prototype,"view",void 0),e.__decorate([c.property({readOnly:!0})],a.prototype,"surfaceCollisionConstraint",void 0),a=e.__decorate([c.subclass("esri.views.3d.state.ConstraintsManager")],a)}(i);a.ConstraintsManager=h,a.default=h}));