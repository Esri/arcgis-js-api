/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/has","../../../core/maybe","../../../core/Logger","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass","../../../core/urlUtils","../../../core/uuid","../../../portal/support/resourceExtension","../../../core/Accessor","../../../core/mathUtils","../../../core/Handles","../../../core/watchUtils","../camera/intersectionUtils","../camera/constraintUtils","./NearFarHeuristic","./SurfaceCollisionConstraint"],(function(t,a,e,i,s,n,r,o,c,l,u,h,d,p,v,w,_,m,C,f){"use strict";t.ConstraintsManager=function(t){function e(a){var e;return(e=t.call(this,a)||this)._handles=new v,e.nearFarHeuristic=C.createNearFarHeuristic(a.view.state.mode,a.view.basemapTerrain,a.view.renderCoordsHelper.spatialReference),e}a._inheritsLoose(e,t);var i=e.prototype;return i.initialize=function(){this._handles.add([this.view.watch(["constraints.clipDistance.near","constraints.clipDistance.far"],(()=>this._clipDistanceNearFarChanged())),this.view.watch("constraints.clipDistance.mode",(()=>this._updateNearFar())),this.view.state.events.on("before-camera-change",(t=>this._updateCameraNearFar(t.camera))),this.view.watch("dataExtent",(()=>this._updateNearFar()),!0),this.view.watch(["constraints.altitude.min","constraints.altitude.max"],(()=>this._updateAltitude()),!0),this.view.watch("constraints.tilt.max",(()=>this._updateTiltMax()),!0),this.view.watch("constraints.tilt.mode",(()=>this._updateTilt()),!0),this.view.watch("state.camera",(()=>this._updateTiltAutoMax()),!0),this.view.watch(["map.ground.navigationConstraint.type","constraints.collision.enabled"],(()=>this._updateCollision()),!0)]),this.view.state.isLocal&&this._handles.add(w.init(this.view,"dataExtent",(t=>this._updateLocalSurfaceDistance(t)))),this._updateNearFar(),2!==this.view.state.mode&&this._updateAltitude(),this._updateTilt(),this._updateCollision(),this._set("surfaceCollisionConstraint",new f.default({view:this.view}))},i.destroy=function(){this._handles=s.destroyMaybe(this._handles),this.surfaceCollisionConstraint&&(this.surfaceCollisionConstraint.destroy(),this._set("surfaceCollisionConstraint",null))},i._clipDistanceNearFarChanged=function(){const t=this.view.constraints&&this.view.constraints.clipDistance;t&&"auto"!==t.mode&&this.view.state.updateCamera((a=>(this._updateCameraNearFarManual(a,t),!0)))},i._updateNearFar=function(){this.view.state.updateCamera((t=>(this._updateCameraNearFar(t),!0)))},i._updateCameraNearFar=function(t){const a=this.view.constraints&&this.view.constraints.clipDistance;"manual"===(a?a.mode:"auto")?this._updateCameraNearFarManual(t,a):this._updateCameraNearFarAuto(t,a)},i._updateCameraNearFarAuto=function(t,a){this.nearFarHeuristic.compute(t.eye,t.center,this.view.dataExtent,_.surfaceElevationBelowRenderLocation(this.view,t.eye),t),a&&a.autoUpdate(t.near,t.far)},i._updateCameraNearFarManual=function(t,a){a&&(t.near=a.near,t.far=a.far)},i._updateCollision=function(){var t,a,e;const i=null==(t=this.view.map)||null==(a=t.ground)||null==(e=a.navigationConstraint)?void 0:e.type,s=!i||"stay-above"===i,n=this.view.state.constraints.collision;if(s!==n.enabled){n.enabled=s,s&&this._reapplyConstraints(8);const t=this.view.constraints&&this.view.constraints.tilt;t&&"auto"!==t.mode||this._updateTiltAuto()}},i._updateAltitude=function(){const t=this.view.constraints&&this.view.constraints.altitude;t&&2!==this.view.state.mode?this.view.state.constraints.altitude={min:t.min,max:t.max}:this.view.state.constraints.altitude=null,this._reapplyConstraints()},i._updateTiltMax=function(){const t=this.view.constraints&&this.view.constraints.tilt;t&&"auto"!==t.mode&&(this._updateTiltManual(t),this._reapplyConstraints())},i._updateTilt=function(){const t=this.view.constraints&&this.view.constraints.tilt;"manual"===(t?t.mode:"auto")?this._updateTiltManual(t):this._updateTiltAuto(),this._reapplyConstraints()},i._updateTiltManual=function(t){const a=this.view.state.constraints;a.tilt=a.createConstantMaxTilt(p.deg2rad(t.max))},i._updateTiltAuto=function(){const t=this.view.state.constraints;t.tilt=t.createDefaultTilt(),this._updateTiltAutoMax()},i._updateTiltAutoMax=function(){const t=this.view.constraints&&this.view.constraints.tilt;if(!t||"auto"!==t.mode)return;const a=this.view.state.constraints;if(a.tilt){const e=a.tilt(this.view.state.camera.distance).max;t.autoUpdate(p.rad2deg(e))}},i._updateLocalSurfaceDistance=function(t){let a=Math.max(t.width,t.height);if(a<=0)return;t.hasZ&&(a=Math.max(a,t.zmax-t.zmin));const e=this.view.state,i=3*a/Math.atan(e.camera.fov/2);i!==e.constraints.distance&&(e.constraints.distance=i)},i._reapplyConstraints=function(t=15){this.view.state.updateCamera((a=>m.applyAll(this.view,a,{selection:t,interactionType:0,interactionFactor:null,interactionStartCamera:null,interactionDirection:null,tiltMode:0})))},e}(d),e.__decorate([o.property({constructOnly:!0})],t.ConstraintsManager.prototype,"view",void 0),e.__decorate([o.property({readOnly:!0})],t.ConstraintsManager.prototype,"surfaceCollisionConstraint",void 0),t.ConstraintsManager=e.__decorate([c.subclass("esri.views.3d.state.ConstraintsManager")],t.ConstraintsManager);var y=t.ConstraintsManager;t.default=y,Object.defineProperty(t,"__esModule",{value:!0})}));
