// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../Camera","../../../Viewpoint","../../../core/Accessor","../../../core/Handles","../../../core/Logger","../../../core/maybe","../../../core/scheduling","../../../core/screenUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators","../../../core/libs/gl-matrix-2/vec4","../../../core/libs/gl-matrix-2/vec4f64","../../../geometry/Extent","../../../geometry/Point","../../../geometry/support/webMercatorUtils","../camera/constraintUtils","../camera/intersectionUtils","./ConstraintsManager","./Frustum","./GoToOperation","./controllers/SurfaceCollisionCorrectionController","../support/cameraUtils","../support/PropertiesPool","../support/viewpointUtils","../webgl-engine/lib/Camera"],(function(e,t,r,i,a,n,o,s,p,c,l,d,h,u,v,m,y,f,w,g,C,O,b,_,x,P,T,S){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ViewStateManager=void 0;var I=s.getLogger("esri.views.3d.state.ViewStateManager"),R=function(e){function t(t){var r=e.call(this,t)||this;return r.propertiesPool=new P.default({frustum:O.default},r),r.handles=new o,r.cameraSetByUser=!1,r.internalSetOrder=[],r.gotoOperation=null,r.ready=!1,r.updateDevicePixelRatio=null,r}return r.__extends(t,e),Object.defineProperty(t.prototype,"camera",{get:function(){if(!this.ready)return this._get("camera");var e=x.internalToExternal(this.view,this.view.state.camera),t=this._get("camera");return e&&t&&e.equals(t)?t:e},set:function(e){this.updatePropertyBeforeReady("camera",e)||this.setStateCamera(x.externalToInternal(this.view,e),{applyConstraints:!1})||I.error("#camera=","Invalid camera",e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"center",{get:function(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")},set:function(e){this.updatePropertyBeforeReady("center",e)||(e?this.isCompatible(e)?this.setStateCamera(this.centerToCamera(e),{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.update():I.error("#center=","Invalid center",e):I.error("#center=","Center has an incompatible spatial reference (center: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e):I.error("#center=","Center may not be null or undefined"))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"extent",{get:function(){return this.ready?x.toExtent(this.view,this.view.state.camera,this.view.pointsOfInterest.centerOnContent.renderLocation):this._get("extent")},set:function(e){this.updatePropertyBeforeReady("extent",e)||(e?this.isCompatible(e)?this.setStateCamera(this.extentToCamera(e),{applyConstraints:!0})||I.error("#extent=","Invalid extent",e):I.error("#extent=","Extent has an incompatible spatial reference (extent: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e):I.error("#extent=","Extent may not be null or undefined"))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"frustum",{get:function(){var e=this.propertiesPool.get("frustum");return e.renderCoordsHelper=this.view.renderCoordsHelper,e.update(this.view.state.camera),e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"hasInitialView",{get:function(){return!!this.view.get("map.initialViewProperties.viewpoint")},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"scale",{get:function(){if(!this.ready)return this._get("scale");var e=this.view.pointsOfInterest.centerOnContent;return x.distanceToScale(this.view,e.distance,e.location.latitude)},set:function(e){this.updatePropertyBeforeReady("scale",e)||this.setStateCamera(this.scaleToCamera(e),{applyConstraints:!0})||I.error("#scale=","Invalid scale",e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"padding",{get:function(){if(!this.ready)return this._get("padding");var e=this.view.state.camera,t=e.padding,r=e.pixelRatio,i=this._get("padding"),a=Math.round(t[0]/r),n=Math.round(t[1]/r),o=Math.round(t[2]/r),s=Math.round(t[3]/r);return null!=i&&i.top===a&&i.right===n&&i.bottom===o&&i.left===s?i:{top:a,right:n,bottom:o,left:s}},set:function(e){this.updatePropertyBeforeReady("padding",e)||(this.paddingToArray(e,this.view.state.camera.pixelRatio,j),this.view.state.updateCamera((function(e){return e.padding=j})))},enumerable:!1,configurable:!0}),t.prototype.paddingToArray=function(e,t,r){e?u.vec4.set(r,e.top||0,e.right||0,e.bottom||0,e.left||0):u.vec4.set(r,0,0,0,0);for(var i=0;i<4;i++)r[i]=Math.round(r[i]*t)},Object.defineProperty(t.prototype,"screenCenter",{get:function(){var e=this.padding;return l.createScreenPoint((this.view.width-(e.left+e.right))/2+e.left,(this.view.height-(e.top+e.bottom))/2+e.top)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"viewpoint",{get:function(){return this.ready?T.fromCamera(this.view,this.camera):this._get("viewpoint")},set:function(e){if(!this.updatePropertyBeforeReady("viewpoint",e))if(e)if(this.isCompatible(e))this.setStateCamera(this.viewpointToCamera(e),{applyConstraints:!e.camera})||I.error("#viewpoint=","Invalid viewpoint",e);else{var t=e.camera?e.camera.position:e.targetGeometry,r=t&&t.spatialReference;I.error("#viewpoint=","Viewpoint has an incompatible spatial reference (viewpoint: "+(r?r.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e)}else I.error("#viewpoint=","Viewpoint may not be null or undefined")},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"zoom",{get:function(){return this.ready?x.scaleToZoom(this.view,this.scale):this._get("zoom")},set:function(e){this.updatePropertyBeforeReady("zoom",e)||this.setStateCamera(this.zoomToCamera(e),{applyConstraints:!0})||I.error("#zoom=","Invalid zoom",e)},enumerable:!1,configurable:!0}),t.prototype.initialize=function(){var e=this;this.handles.add([this.view.state.watch("camera",(function(t){return e.cameraChangedSync(t)}),!0),d.on(this.view,"state.events","before-camera-change",(function(t){return e.updateElevation(t.camera)}))]),d.once(this.view.state,"camera",(function(t){return e.updateElevation(t)}),!0),this.handles.add(c.addFrameTask({prepare:function(){return e.prepareFrame()}})),this.handles.add(this.view.state.watch("cameraController",(function(){e.cameraSetByUser=!0,e.handles.remove(z)}))),this.handles.add(d.on(this.view,"state.events","camera-projection-changed",(function(){return e.notifyChange("scale")})))},t.prototype.destroy=function(){this.deinit(),this.handles&&(this.handles.destroy(),this.handles=null),this.propertiesPool&&(this.propertiesPool.destroy(),this.propertiesPool=null)},t.prototype.init=function(){var e=this;this.constraintsManager=new C.default({view:this.view}),this.prepareFrame();var t=this.getInitialProperties();this.cameraSetByUser=!1,this._set("ready",!0);for(var r=0,i=t;r<i.length;r++){var a=i[r];this.set(a.name,a.value)}if(!this.cameraSetByUser){var n=this.view.get("map.initialViewProperties.viewpoint")||this.view.initialExtent;n&&this.isCompatible(n)?this.setInitialView(n):2===this.view.state.mode&&this.handles.add(d.whenOnce(this.view.basemapTerrain,"ready",(function(){e.handles.remove(z),e.setInitialView(e.view.groundExtent)})),z)}},t.prototype.deinit=function(){this.cancelGoToOperation(),this.ready&&(this._override("padding",this.padding),this._set("ready",!1),this._clearOverride("hasInitialView"),this.internalSetOrder.length=0,this.cameraSetByUser=!1,this.handles.remove(z),this.constraintsManager&&(this.constraintsManager.destroy(),this.constraintsManager=null))},t.prototype.goTo=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var i;return r.__generator(this,(function(a){return i=r.__assign({animate:!0},t),this.gotoOperation=p.isSome(this.gotoOperation)?this.gotoOperation.goTo(e,i):new b.GoToOperation(e,i,this.view),[2,this.gotoOperation]}))}))},t.prototype.debugSetCameraOnContent=function(){this.setStateCamera(g.cameraOnContentAlongViewDirection(this.view),{applyConstraints:!1})},t.prototype.step=function(e){var t=this.view.state,r=t&&this.view.state.cameraController;r&&(t.updateCamera((function(t){r.stepController(e,t)})),r.steppingFinished&&r.finishController())},t.prototype.cancelGoToOperation=function(){p.isSome(this.gotoOperation)&&(this.gotoOperation.abort(),this.gotoOperation=null)},t.prototype.getInitialProperties=function(){for(var e=new Set,t=[],r=0,i=M;r<i.length;r++){var a=i[r],n=a.propertyName,o=a.overrides,s=e.has(n),p=this._isOverridden(n);!s&&p&&t.push({name:n,value:this._get(n)}),this._clearOverride(n),(s||p)&&o.forEach((function(t){return e.add(t)}))}return t},t.prototype.setInitialView=function(e){if(e&&!this.cameraSetByUser)if(e instanceof i)this.setStateCamera(x.externalToInternal(this.view,e),{applyConstraints:!1});else if(e instanceof a){if(e.targetGeometry instanceof m){var t=x.fromExtent(this.view,e.targetGeometry,0,.5,0);return void this.setStateCamera(x.externalToInternal(this.view,t),{applyConstraints:!0})}var r={applyConstraints:!e.camera},n=this.viewpointToCamera(e);this.setStateCamera(n,r)}else{var o=x.fromExtent(this.view,e,0,.5,0);this.setStateCamera(x.externalToInternal(this.view,o),{applyConstraints:!0})}},t.prototype.updatePropertyBeforeReady=function(e,t){if(!this.ready){this._override(e,t);var r=this.internalSetOrder.indexOf(e);return-1!==r&&(this.internalSetOrder=this.internalSetOrder.splice(r,1)),t&&(this.internalSetOrder.push(e),-1!==B.indexOf(e)&&this._override("hasInitialView",!0)),!0}return!1},t.prototype.isCompatible=function(e){return!!e&&(e instanceof a?e.camera?this.isCompatible(e.camera):this.isCompatible(e.targetGeometry):e instanceof i?this.isCompatible(e.position):e.spatialReference&&f.canProject(e.spatialReference,this.view.spatialReference))},t.prototype.getPreservingHeadingTilt=function(e){return void 0===e&&(e=V),this.cameraSetByUser?(e.heading=this.camera.heading,e.tilt=this.camera.tilt):(e.heading=0,e.tilt=.5),e},t.prototype.centerPointAtDistanceToCamera=function(e,t,r){void 0===r&&(r=U);var i=this.getPreservingHeadingTilt(),a=i.heading,n=i.tilt,o=x.getObserverForPointAtDistance(this.view,a,n,e,t,1);return o?(r.copyFrom(this.view.state.camera),r.eye=o.eye,r.center=o.center,r.up=o.up,r):null},t.prototype.centerToCamera=function(e){var t=this.view.pointsOfInterest.centerOnContent;t.update();var r=t.distance;return this.centerPointAtDistanceToCamera(e,r)},t.prototype.extentToCamera=function(e){var t=this.getPreservingHeadingTilt(),r=t.heading,i=t.tilt,a=x.fromExtent(this.view,e,r,i,1,E);return x.externalToInternal(this.view,a)},t.prototype.scaleToCamera=function(e){if(null==e)return null;var t=this.view.pointsOfInterest.centerOnContent;t.update();var r=t.renderLocation,i=t.location.latitude,a=x.scaleToDistance(this.view,e,i);return this.centerPointAtDistanceToCamera(r,a)},t.prototype.zoomToCamera=function(e){return this.scaleToCamera(x.zoomToScale(this.view,e))},t.prototype.viewpointToCamera=function(e){var t=T.toCamera(this.view,e);return t?x.externalToInternal(this.view,t):null},t.prototype.setStateCamera=function(e,t){var r=this;return!(!e||!this.view.state.stopActiveCameraController())&&(this.cameraSetByUser=!0,t.doNotCancelGoToOperation||this.cancelGoToOperation(),this.view.state.updateCamera((function(i){t.positionAndOrientationOnly?(i.eye=e.eye,i.center=e.center,i.up=e.up):i.copyFrom(e),t.applyConstraints&&w.applyAll(r.view,i)})),t.applyConstraints||(this.view.state.cameraController=new _.SurfaceCollisionCorrectionController({view:this.view,desiredCamera:e})),!0)},t.prototype.prepareFrame=function(){var e=this.view,t=e.container,r=e.canvas;if(t&&r){p.isSome(this.updateDevicePixelRatio)&&this.updateDevicePixelRatio();var i=this.view.pixelRatio,a=Math.round(t.clientWidth*i),n=Math.round(t.clientHeight*i);if(0!==a&&0!==n&&(r.width===a&&r.height===n||(r.width=a,r.height=n),this.view.state)){var o=this.view.state.camera;o.fullWidth===a&&o.fullHeight===n&&o.pixelRatio===i||(U.copyFrom(o),U.pixelRatio!==i&&(this.paddingToArray(this.padding,i,j),U.padding=j),U.fullWidth=a,U.fullHeight=n,U.pixelRatio=i,this.view.state.camera=U)}}},t.prototype.updateElevation=function(e){var t=this.view.basemapTerrain&&this.view.basemapTerrain.spatialReference,r=this.view.renderCoordsHelper.getAltitude(e.eye),i=t?g.surfaceElevationBelowEye(this.view,e):0;e.relativeElevation=r-i},t.prototype.cameraChangedSync=function(e){e&&this.view._stage&&this.view._stage.setCamera(e)},r.__decorate([h.property({type:i,dependsOn:["view.state.camera","ready"]})],t.prototype,"camera",null),r.__decorate([h.property({type:y,dependsOn:["view.pointsOfInterest.centerOnContent.location","ready"]})],t.prototype,"center",null),r.__decorate([h.property({type:m,dependsOn:["view.state.camera","ready","view.pointsOfInterest.centerOnContent.location"]})],t.prototype,"extent",null),r.__decorate([h.property({readOnly:!0,dependsOn:["view.state.camera","ready"]})],t.prototype,"frustum",null),r.__decorate([h.property({readOnly:!0,dependsOn:["view.map.initialViewProperties?.viewpoint"]})],t.prototype,"hasInitialView",null),r.__decorate([h.property({readOnly:!0,type:Boolean})],t.prototype,"ready",void 0),r.__decorate([h.property({dependsOn:["view.pointsOfInterest.centerOnContent.distance","ready"],type:Number})],t.prototype,"scale",null),r.__decorate([h.property({dependsOn:["view.state.camera","ready"]})],t.prototype,"padding",null),r.__decorate([h.property({readOnly:!0,dependsOn:["view.width","view.height","padding"]})],t.prototype,"screenCenter",null),r.__decorate([h.property({constructOnly:!0})],t.prototype,"view",void 0),r.__decorate([h.property({type:a,dependsOn:["camera","ready"]})],t.prototype,"viewpoint",null),r.__decorate([h.property({type:Number,dependsOn:["scale"]})],t.prototype,"zoom",null),r.__decorate([h.property({constructOnly:!0})],t.prototype,"updateDevicePixelRatio",void 0),t=r.__decorate([h.subclass("esri.views.3d.state.ViewStateManager")],t)}(n);t.ViewStateManager=R;var B=["camera","viewpoint","extent","scale","center","zoom"],M=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"center",overrides:[]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],V={heading:0,tilt:0},E=new i,U=new S.default,j=v.vec4f64.create(),z="pending-initial-view";t.default=R}));