/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../Camera","../../../Viewpoint","../../../core/Accessor","../../../core/Handles","../../../core/Logger","../../../core/maybe","../../../core/scheduling","../../../core/screenUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec3","../../../chunks/vec3f64","../../../chunks/vec4","../../../chunks/vec4f64","../../../geometry/Extent","../../../geometry/Point","../../../geometry/support/webMercatorUtils","../../ViewingMode","../camera/constraintUtils","../camera/intersectionUtils","./ConstraintsManager","./Frustum","./GoToOperation","./controllers/SurfaceCollisionCorrectionController","../support/cameraUtils","../support/PropertiesPool","../support/viewpointUtils","../webgl-engine/lib/Camera"],(function(e,t,i,r,n,a,o,s,c,l,p,h,d,u,m,v,y,w,f,C,g,_,T,O,S,x,P,R,b,I,k,M,E,B){"use strict";const U=o.getLogger("esri.views.3d.state.ViewStateManager");let z=function(t){function n(i){var r;return(r=t.call(this,i)||this).propertiesPool=new M.PropertiesPool({frustum:R.Frustum},e._assertThisInitialized(r)),r.handles=new a,r.cameraSetByUser=!1,r.gotoOperation=null,r.ready=!1,r.updateDevicePixelRatio=null,r.test={contentCameraResetState:new Map},r}e._inheritsLoose(n,t);var o=n.prototype;return o.installContentCameraReset=function(e){if(this.handles.remove("contentCameraReset"),this.test.contentCameraResetState.clear(),!this.view.state.fixedContentCamera)return!1;const t=this.zoom,i=this.view.state.camera.distance**2,r=w.fromArray(this.view.state.camera.center),n=e.sticky?this.contentCamera.clone():null;return this.handles.add([this.watch("contentCamera",(()=>{e.sticky||(this.handles.remove("contentCameraReset"),this.test.contentCameraResetState.clear())})),this.watch("zoom",(e=>{this.test.contentCameraResetState.set("view.zoom",Math.abs(e-t)/2),Math.abs(e-t)>2?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=n)})),this.view.state.watch("camera",(e=>{const t=y.squaredDistance(r,e.center);this.test.contentCameraResetState.set("camera.center",t/i),t>i?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=n)}))],"contentCameraReset"),!0},o._paddingToArray=function(e,t,i){e?f.set(i,e.top||0,e.right||0,e.bottom||0,e.left||0):f.set(i,0,0,0,0);for(let r=0;r<4;r++)i[r]=Math.round(i[r]*t)},o.initialize=function(){this.handles.add([p.on(this.view,"state.events","before-camera-change",(e=>this._updateElevation(e.camera)))]),p.once(this.view.state,"camera",(e=>this._updateElevation(e)),!0),this.handles.add(c.addFrameTask({prepare:()=>this._prepareFrame()})),this.handles.add(this.view.state.watch("cameraController",(()=>{this.cameraSetByUser=!0,this.handles.remove(L)}))),this.handles.add(p.on(this.view,"state.events","camera-projection-changed",(()=>this.notifyChange("scale"))))},o.destroy=function(){this.deinit(),this.handles&&(this.handles.destroy(),this.handles=null),this.propertiesPool&&(this.propertiesPool.destroy(),this.propertiesPool=null)},o.init=function(){this.constraintsManager=new P.default({view:this.view}),this._prepareFrame();const e=this._getInitialProperties();this.cameraSetByUser=!1,this._set("ready",!0);for(const t of e)this.set(t.name,t.value);if(!this.cameraSetByUser){const e=this.view.get("map.initialViewProperties.viewpoint")||this.view.initialExtent;e&&this.isCompatible(e)?this._setInitialView(e):this.view.state.viewingMode===O.ViewingMode.Local&&this.handles.add(p.whenOnce(this.view.basemapTerrain,"ready",(()=>{this.handles.remove(L),this._setInitialView(this.view.dataExtent)})),L)}},o.deinit=function(){this._cancelGoToOperation(),this.ready&&(this._override("padding",this.padding),this._set("ready",!1),this._clearOverride("hasInitialView"),this.cameraSetByUser=!1,this.handles.remove(L),this.constraintsManager&&(this.constraintsManager.destroy(),this.constraintsManager=null))},o.goTo=function(){var t=e._asyncToGenerator((function*(e,t){const i={animate:!0,...t};return s.isSome(this.gotoOperation)&&this.gotoOperation.abort(i.animate),this.gotoOperation=new b.GoToOperation(e,i,this.view),this.view.resourceController.scheduler.stopFrame(),this.gotoOperation}));function i(e,i){return t.apply(this,arguments)}return i}(),o.debugSetCameraOnContent=function(){this.setStateCamera(x.cameraOnContentAlongViewDirection(this.view),{applyConstraints:!1})},o.step=function(e){const t=this.view.state,i=t&&this.view.state.cameraController;i&&(t.updateCamera((t=>{i.stepController(e,t)})),i.steppingFinished&&i.finishController())},o._cancelGoToOperation=function(){s.isSome(this.gotoOperation)&&(this.gotoOperation.abort(),this.gotoOperation=null)},o._getInitialProperties=function(){const e=new Set,t=[];for(const{propertyName:i,overrides:r}of N){const n=e.has(i),a=this._isOverridden(i);!n&&a&&t.push({name:i,value:this._get(i)}),this._clearOverride(i),(n||a)&&r.forEach((t=>e.add(t)))}return t},o._setInitialView=function(e){if(s.isNone(e)||this.cameraSetByUser)return;if(e instanceof i)return void this.setStateCamera(k.externalToInternal(this.view,e),{applyConstraints:!1});if(e instanceof r){if(e.targetGeometry instanceof g){const t=k.fromExtent(this.view,e.targetGeometry,0,.5,k.OrientationMode.LOCKED);return void(s.isSome(t)&&this.setStateCamera(k.externalToInternal(this.view,t),{applyConstraints:!0}))}const t={applyConstraints:!e.camera},i=this._viewpointToCamera(e);return void this.setStateCamera(i,t)}const t=k.fromExtent(this.view,e,0,.5,k.OrientationMode.LOCKED);s.isSome(t)&&this.setStateCamera(k.externalToInternal(this.view,t),{applyConstraints:!0})},o._updatePropertyBeforeReady=function(e,t){return!this.ready&&(this._override(e,t),t&&-1!==A.indexOf(e)&&this._override("hasInitialView",!0),!0)},o.isCompatible=function(e){return!s.isNone(e)&&(e instanceof r?e.camera?this.isCompatible(e.camera):this.isCompatible(e.targetGeometry):e instanceof i?this.isCompatible(e.position):e.spatialReference&&T.canProject(e.spatialReference,this.view.spatialReference))},o._getPreservingHeadingTilt=function(e=D){return this.cameraSetByUser?(e.heading=this.camera.heading,e.tilt=this.camera.tilt):(e.heading=0,e.tilt=.5),e},o._centerPointAtDistanceToCamera=function(e,t,i=G){const{heading:r,tilt:n}=this._getPreservingHeadingTilt(),a=k.getObserverForPointAtDistance(this.view,r,n,e,t,k.OrientationMode.ADJUST);return s.isNone(a)?null:(i.copyFrom(this.view.state.camera),i.eye=a.eye,i.center=a.center,i.up=a.up,i)},o._centerToCamera=function(e){const t=this.view.pointsOfInterest.centerOnContent;t.runTask();const i=t.distance;return this._centerPointAtDistanceToCamera(e,i)},o._extentToCamera=function(e){const{heading:t,tilt:i}=this._getPreservingHeadingTilt(),r=k.fromExtent(this.view,e,t,i,k.OrientationMode.ADJUST,F);return s.isSome(r)?k.externalToInternal(this.view,r):null},o._scaleToCamera=function(e){if(null==e)return null;const t=this.view.pointsOfInterest.centerOnContent;t.runTask();const i=t.renderLocation,r=t.location.latitude,n=k.scaleToDistance(this.view,e,r);return this._centerPointAtDistanceToCamera(i,n)},o._zoomToCamera=function(e){return this._scaleToCamera(k.zoomToScale(this.view,e))},o._viewpointToCamera=function(e){return k.externalToInternal(this.view,E.toCamera(this.view,e))},o.setStateCamera=function(e,t){return!(s.isNone(e)||!this.view.state.stopActiveCameraController())&&(this.cameraSetByUser=!0,t.doNotCancelGoToOperation||this._cancelGoToOperation(),this.view.state.updateCamera((i=>{t.positionAndOrientationOnly?(i.eye=e.eye,i.center=e.center,i.up=e.up):i.copyFrom(e),t.applyConstraints&&S.applyAll(this.view,i)})),t.applyConstraints||(this.view.state.cameraController=new I.SurfaceCollisionCorrectionController({view:this.view,desiredCamera:e})),!0)},o._prepareFrame=function(){const{container:e,canvas:t}=this.view;if(!e||!t)return;s.isSome(this.updateDevicePixelRatio)&&this.updateDevicePixelRatio();const i=this.view.pixelRatio,r=Math.round(e.clientWidth*i),n=Math.round(e.clientHeight*i);if(0!==r&&0!==n&&(t.width===r&&t.height===n||(t.width=r,t.height=n),this.view.state)){const e=this.view.state.camera;e.fullWidth===r&&e.fullHeight===n&&e.pixelRatio===i||(G.copyFrom(e),G.pixelRatio!==i&&(this._paddingToArray(this.padding,i,H),G.padding=H),G.fullWidth=r,G.fullHeight=n,G.pixelRatio=i,this.view.state.camera=G)}},o._updateElevation=function(e){const t=this.view.basemapTerrain&&this.view.basemapTerrain.spatialReference,i=this.view.renderCoordsHelper.getAltitude(e.eye),r=t?x.surfaceElevationBelowRenderLocation(this.view,e.eye):0;e.relativeElevation=i-r},e._createClass(n,[{key:"camera",get:function(){const e=this._get("camera");if(!this.ready)return e;const t=k.internalToExternal(this.view,this.view.state.camera);return t&&e&&t.equals(e)?e:t},set:function(e){this._updatePropertyBeforeReady("camera",e)||(this.view.elevationProvider.enableElevationCache(!0),this.setStateCamera(k.externalToInternal(this.view,e),{applyConstraints:!1})||U.error("#camera=","Invalid camera",e),this.view.elevationProvider.enableElevationCache(!1))}},{key:"contentCamera",get:function(){const e=this._get("contentCamera");if(!this.ready)return e;const t=k.internalToExternal(this.view,this.view.state.contentCamera);return t&&e&&t.equals(e)?e:t},set:function(e){if(this._updatePropertyBeforeReady("contentCamera",e))return;const t=k.externalToInternal(this.view,e);s.isNone(t)?this.view.state.contentCamera=null:(this._updateElevation(t),this.view.state.contentCamera=t)}},{key:"center",get:function(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")},set:function(e){this._updatePropertyBeforeReady("center",e)||(e?this.isCompatible(e)?this.setStateCamera(this._centerToCamera(e),{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.runTask():U.error("#center=","Invalid center",e):U.error("#center=","Center has an incompatible spatial reference (center: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e):U.error("#center=","Center may not be null or undefined"))}},{key:"extent",get:function(){if(!this.ready)return this._get("extent");const e=this.view,t=k.toExtent(e,e.state.camera,e.pointsOfInterest.centerOnContent.renderLocation);return s.isSome(t)?t:this._get("extent")},set:function(e){this._updatePropertyBeforeReady("extent",e)||(e?this.isCompatible(e)?this.setStateCamera(this._extentToCamera(e),{applyConstraints:!0})||U.error("#extent=","Invalid extent",e):U.error("#extent=","Extent has an incompatible spatial reference (extent: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e):U.error("#extent=","Extent may not be null or undefined"))}},{key:"frustum",get:function(){const e=this.propertiesPool.get("frustum");return e.renderCoordsHelper=this.view.renderCoordsHelper,e.update(this.view.state.camera),e}},{key:"hasInitialView",get:function(){return!!this.view.get("map.initialViewProperties.viewpoint")}},{key:"scale",get:function(){if(this.ready){const e=this.view.pointsOfInterest.centerOnContent;return k.distanceToScale(this.view,e.distance,e.location.latitude)}return this._get("scale")},set:function(e){this._updatePropertyBeforeReady("scale",e)||this.setStateCamera(this._scaleToCamera(e),{applyConstraints:!0})||U.error("#scale=","Invalid scale",e)}},{key:"padding",get:function(){if(!this.ready)return this._get("padding");const e=this.view.state.camera,t=e.padding,i=e.pixelRatio,r=this._get("padding"),n=Math.round(t[B.PaddingSide.TOP]/i),a=Math.round(t[B.PaddingSide.RIGHT]/i),o=Math.round(t[B.PaddingSide.BOTTOM]/i),s=Math.round(t[B.PaddingSide.LEFT]/i);return null!=r&&r.top===n&&r.right===a&&r.bottom===o&&r.left===s?r:{top:n,right:a,bottom:o,left:s}},set:function(e){this._updatePropertyBeforeReady("padding",e)||(this._paddingToArray(e,this.view.state.camera.pixelRatio,H),this.view.state.updateCamera((e=>e.padding=H)))}},{key:"screenCenter",get:function(){const e=this.padding;return l.createScreenPoint((this.view.width-(e.left+e.right))/2+e.left,(this.view.height-(e.top+e.bottom))/2+e.top)}},{key:"viewpoint",get:function(){return this.ready?E.fromCamera(this.view,this.camera):this._get("viewpoint")},set:function(e){if(!this._updatePropertyBeforeReady("viewpoint",e))if(e)if(this.isCompatible(e))this.setStateCamera(this._viewpointToCamera(e),{applyConstraints:!e.camera})||U.error("#viewpoint=","Invalid viewpoint",e);else{const t=s.isSome(e.camera)?e.camera.position:e.targetGeometry,i=s.isSome(t)&&t.spatialReference;U.error("#viewpoint=","Viewpoint has an incompatible spatial reference (viewpoint: "+(i?i.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e)}else U.error("#viewpoint=","Viewpoint may not be null or undefined")}},{key:"zoom",get:function(){return this.ready?k.scaleToZoom(this.view,this.scale):this._get("zoom")},set:function(e){this._updatePropertyBeforeReady("zoom",e)||this.setStateCamera(this._zoomToCamera(e),{applyConstraints:!0})||U.error("#zoom=","Invalid zoom",e)}}]),n}(n);t.__decorate([h.property({type:i,dependsOn:["view.state.camera","ready"]})],z.prototype,"camera",null),t.__decorate([h.property({type:i,dependsOn:["view.state.contentCamera","ready"]})],z.prototype,"contentCamera",null),t.__decorate([h.property({type:_})],z.prototype,"center",null),t.__decorate([h.property({type:g})],z.prototype,"extent",null),t.__decorate([h.property({readOnly:!0})],z.prototype,"frustum",null),t.__decorate([h.property({readOnly:!0})],z.prototype,"hasInitialView",null),t.__decorate([h.property({readOnly:!0,type:Boolean})],z.prototype,"ready",void 0),t.__decorate([h.property({type:Number})],z.prototype,"scale",null),t.__decorate([h.property()],z.prototype,"padding",null),t.__decorate([h.property({readOnly:!0})],z.prototype,"screenCenter",null),t.__decorate([h.property({constructOnly:!0})],z.prototype,"view",void 0),t.__decorate([h.property({type:r})],z.prototype,"viewpoint",null),t.__decorate([h.property({type:Number})],z.prototype,"zoom",null),t.__decorate([h.property({constructOnly:!0})],z.prototype,"updateDevicePixelRatio",void 0),z=t.__decorate([v.subclass("esri.views.3d.state.ViewStateManager")],z);const V=z,A=["camera","viewpoint","extent","scale","center","zoom"],N=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"center",overrides:[]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],D={heading:0,tilt:0},F=new i,G=new B.default,H=C.create(),L="pending-initial-view";return V}));
