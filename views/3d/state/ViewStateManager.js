/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../Camera","../../../Viewpoint","../../../core/Accessor","../../../core/Handles","../../../core/Logger","../../../core/maybe","../../../core/scheduling","../../../core/screenUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec3","../../../chunks/vec3f64","../../../chunks/vec4","../../../chunks/vec4f64","../../../geometry/Extent","../../../geometry/Point","../../../geometry/support/webMercatorUtils","../camera/constraintUtils","../camera/intersectionUtils","./ConstraintsManager","./Frustum","./GoToOperation","./controllers/SurfaceCollisionCorrectionController","../support/cameraUtils","../support/PropertiesPool","../support/viewpointUtils","../webgl-engine/lib/Camera"],(function(e,t,i,r,n,a,o,s,c,p,l,h,d,u,m,v,y,w,f,C,g,_,T,x,S,O,R,b,P,k,I,B){"use strict";const M=o.getLogger("esri.views.3d.state.ViewStateManager");let E=function(t){function n(i){var r;return(r=t.call(this,i)||this).propertiesPool=new k.PropertiesPool({frustum:O.Frustum},e._assertThisInitialized(r)),r.handles=new a,r.cameraSetByUser=!1,r.gotoOperation=null,r.ready=!1,r.updateDevicePixelRatio=null,r.test={contentCameraResetState:new Map},r}e._inheritsLoose(n,t);var o=n.prototype;return o.installContentCameraReset=function(e){if(this.handles.remove("contentCameraReset"),this.test.contentCameraResetState.clear(),!this.view.state.fixedContentCamera)return!1;const t=this.zoom,i=this.view.state.camera.distance**2,r=y.fromArray(this.view.state.camera.center),n=e.sticky?this.contentCamera.clone():null;return this.handles.add([this.watch("contentCamera",(()=>{e.sticky||(this.handles.remove("contentCameraReset"),this.test.contentCameraResetState.clear())})),this.watch("zoom",(e=>{this.test.contentCameraResetState.set("view.zoom",Math.abs(e-t)/2),Math.abs(e-t)>2?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=n)})),this.view.state.watch("camera",(e=>{const t=v.squaredDistance(r,e.center);this.test.contentCameraResetState.set("camera.center",t/i),t>i?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=n)}))],"contentCameraReset"),!0},o.paddingToArray=function(e,t,i){e?w.set(i,e.top||0,e.right||0,e.bottom||0,e.left||0):w.set(i,0,0,0,0);for(let r=0;r<4;r++)i[r]=Math.round(i[r]*t)},o.initialize=function(){this.handles.add([l.on(this.view,"state.events","before-camera-change",(e=>this.updateElevation(e.camera)))]),l.once(this.view.state,"camera",(e=>this.updateElevation(e)),!0),this.handles.add(c.addFrameTask({prepare:()=>this.prepareFrame()})),this.handles.add(this.view.state.watch("cameraController",(()=>{this.cameraSetByUser=!0,this.handles.remove(G)}))),this.handles.add(l.on(this.view,"state.events","camera-projection-changed",(()=>this.notifyChange("scale"))))},o.destroy=function(){this.deinit(),this.handles&&(this.handles.destroy(),this.handles=null),this.propertiesPool&&(this.propertiesPool.destroy(),this.propertiesPool=null)},o.init=function(){this.constraintsManager=new S.default({view:this.view}),this.prepareFrame();const e=this.getInitialProperties();this.cameraSetByUser=!1,this._set("ready",!0);for(const t of e)this.set(t.name,t.value);if(!this.cameraSetByUser){const e=this.view.get("map.initialViewProperties.viewpoint")||this.view.initialExtent;e&&this.isCompatible(e)?this.setInitialView(e):2===this.view.state.viewingMode&&this.handles.add(l.whenOnce(this.view.basemapTerrain,"ready",(()=>{this.handles.remove(G),this.setInitialView(this.view.groundExtent)})),G)}},o.deinit=function(){this.cancelGoToOperation(),this.ready&&(this._override("padding",this.padding),this._set("ready",!1),this._clearOverride("hasInitialView"),this.cameraSetByUser=!1,this.handles.remove(G),this.constraintsManager&&(this.constraintsManager.destroy(),this.constraintsManager=null))},o.goTo=function(){var t=e._asyncToGenerator((function*(e,t){const i={animate:!0,...t};return s.isSome(this.gotoOperation)&&this.gotoOperation.abort(i.animate),this.gotoOperation=new R.GoToOperation(e,i,this.view),this.view.resourceController.scheduler.stopFrame(),this.gotoOperation}));function i(e,i){return t.apply(this,arguments)}return i}(),o.debugSetCameraOnContent=function(){this.setStateCamera(x.cameraOnContentAlongViewDirection(this.view),{applyConstraints:!1})},o.step=function(e){const t=this.view.state,i=t&&this.view.state.cameraController;i&&(t.updateCamera((t=>{i.stepController(e,t)})),i.steppingFinished&&i.finishController())},o.cancelGoToOperation=function(){s.isSome(this.gotoOperation)&&(this.gotoOperation.abort(),this.gotoOperation=null)},o.getInitialProperties=function(){const e=new Set,t=[];for(const{propertyName:i,overrides:r}of U){const n=e.has(i),a=this._isOverridden(i);!n&&a&&t.push({name:i,value:this._get(i)}),this._clearOverride(i),(n||a)&&r.forEach((t=>e.add(t)))}return t},o.setInitialView=function(e){if(!e||this.cameraSetByUser)return;if(e instanceof i)return void this.setStateCamera(P.externalToInternal(this.view,e),{applyConstraints:!1});if(e instanceof r){if(e.targetGeometry instanceof C){const t=P.fromExtent(this.view,e.targetGeometry,0,.5,0);return void(s.isSome(t)&&this.setStateCamera(P.externalToInternal(this.view,t),{applyConstraints:!0}))}const t={applyConstraints:!e.camera},i=this.viewpointToCamera(e);return void this.setStateCamera(i,t)}const t=P.fromExtent(this.view,e,0,.5,0);s.isSome(t)&&this.setStateCamera(P.externalToInternal(this.view,t),{applyConstraints:!0})},o.updatePropertyBeforeReady=function(e,t){return!this.ready&&(this._override(e,t),t&&-1!==N.indexOf(e)&&this._override("hasInitialView",!0),!0)},o.isCompatible=function(e){return!s.isNone(e)&&(e instanceof r?e.camera?this.isCompatible(e.camera):this.isCompatible(e.targetGeometry):e instanceof i?this.isCompatible(e.position):e.spatialReference&&_.canProject(e.spatialReference,this.view.spatialReference))},o.getPreservingHeadingTilt=function(e=V){return this.cameraSetByUser?(e.heading=this.camera.heading,e.tilt=this.camera.tilt):(e.heading=0,e.tilt=.5),e},o.centerPointAtDistanceToCamera=function(e,t,i=F){const{heading:r,tilt:n}=this.getPreservingHeadingTilt(),a=P.getObserverForPointAtDistance(this.view,r,n,e,t,1);return s.isNone(a)?null:(i.copyFrom(this.view.state.camera),i.eye=a.eye,i.center=a.center,i.up=a.up,i)},o.centerToCamera=function(e){const t=this.view.pointsOfInterest.centerOnContent;t.runTask();const i=t.distance;return this.centerPointAtDistanceToCamera(e,i)},o.extentToCamera=function(e){const{heading:t,tilt:i}=this.getPreservingHeadingTilt(),r=P.fromExtent(this.view,e,t,i,1,A);return s.isSome(r)?P.externalToInternal(this.view,r):null},o.scaleToCamera=function(e){if(null==e)return null;const t=this.view.pointsOfInterest.centerOnContent;t.runTask();const i=t.renderLocation,r=t.location.latitude,n=P.scaleToDistance(this.view,e,r);return this.centerPointAtDistanceToCamera(i,n)},o.zoomToCamera=function(e){return this.scaleToCamera(P.zoomToScale(this.view,e))},o.viewpointToCamera=function(e){return P.externalToInternal(this.view,I.toCamera(this.view,e))},o.setStateCamera=function(e,t){return!(s.isNone(e)||!this.view.state.stopActiveCameraController())&&(this.cameraSetByUser=!0,t.doNotCancelGoToOperation||this.cancelGoToOperation(),this.view.state.updateCamera((i=>{t.positionAndOrientationOnly?(i.eye=e.eye,i.center=e.center,i.up=e.up):i.copyFrom(e),t.applyConstraints&&T.applyAll(this.view,i)})),t.applyConstraints||(this.view.state.cameraController=new b.SurfaceCollisionCorrectionController({view:this.view,desiredCamera:e})),!0)},o.prepareFrame=function(){const{container:e,canvas:t}=this.view;if(!e||!t)return;s.isSome(this.updateDevicePixelRatio)&&this.updateDevicePixelRatio();const i=this.view.pixelRatio,r=Math.round(e.clientWidth*i),n=Math.round(e.clientHeight*i);if(0!==r&&0!==n&&(t.width===r&&t.height===n||(t.width=r,t.height=n),this.view.state)){const e=this.view.state.camera;e.fullWidth===r&&e.fullHeight===n&&e.pixelRatio===i||(F.copyFrom(e),F.pixelRatio!==i&&(this.paddingToArray(this.padding,i,D),F.padding=D),F.fullWidth=r,F.fullHeight=n,F.pixelRatio=i,this.view.state.camera=F)}},o.updateElevation=function(e){const t=this.view.basemapTerrain&&this.view.basemapTerrain.spatialReference,i=this.view.renderCoordsHelper.getAltitude(e.eye),r=t?x.surfaceElevationBelowRenderLocation(this.view,e.eye):0;e.relativeElevation=i-r},e._createClass(n,[{key:"camera",get:function(){const e=this._get("camera");if(!this.ready)return e;const t=P.internalToExternal(this.view,this.view.state.camera);return t&&e&&t.equals(e)?e:t},set:function(e){this.updatePropertyBeforeReady("camera",e)||this.setStateCamera(P.externalToInternal(this.view,e),{applyConstraints:!1})||M.error("#camera=","Invalid camera",e)}},{key:"contentCamera",get:function(){const e=this._get("contentCamera");if(!this.ready)return e;const t=P.internalToExternal(this.view,this.view.state.contentCamera);return t&&e&&t.equals(e)?e:t},set:function(e){if(this.updatePropertyBeforeReady("contentCamera",e))return;const t=P.externalToInternal(this.view,e);s.isNone(t)?this.view.state.contentCamera=null:(this.updateElevation(t),this.view.state.contentCamera=t)}},{key:"center",get:function(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")},set:function(e){this.updatePropertyBeforeReady("center",e)||(e?this.isCompatible(e)?this.setStateCamera(this.centerToCamera(e),{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.runTask():M.error("#center=","Invalid center",e):M.error("#center=","Center has an incompatible spatial reference (center: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e):M.error("#center=","Center may not be null or undefined"))}},{key:"extent",get:function(){if(!this.ready)return this._get("extent");const e=this.view,t=P.toExtent(e,e.state.camera,e.pointsOfInterest.centerOnContent.renderLocation);return s.isSome(t)?t:this._get("extent")},set:function(e){this.updatePropertyBeforeReady("extent",e)||(e?this.isCompatible(e)?this.setStateCamera(this.extentToCamera(e),{applyConstraints:!0})||M.error("#extent=","Invalid extent",e):M.error("#extent=","Extent has an incompatible spatial reference (extent: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e):M.error("#extent=","Extent may not be null or undefined"))}},{key:"frustum",get:function(){const e=this.propertiesPool.get("frustum");return e.renderCoordsHelper=this.view.renderCoordsHelper,e.update(this.view.state.camera),e}},{key:"hasInitialView",get:function(){return!!this.view.get("map.initialViewProperties.viewpoint")}},{key:"scale",get:function(){if(this.ready){const e=this.view.pointsOfInterest.centerOnContent;return P.distanceToScale(this.view,e.distance,e.location.latitude)}return this._get("scale")},set:function(e){this.updatePropertyBeforeReady("scale",e)||this.setStateCamera(this.scaleToCamera(e),{applyConstraints:!0})||M.error("#scale=","Invalid scale",e)}},{key:"padding",get:function(){if(!this.ready)return this._get("padding");const e=this.view.state.camera,t=e.padding,i=e.pixelRatio,r=this._get("padding"),n=Math.round(t[0]/i),a=Math.round(t[1]/i),o=Math.round(t[2]/i),s=Math.round(t[3]/i);return null!=r&&r.top===n&&r.right===a&&r.bottom===o&&r.left===s?r:{top:n,right:a,bottom:o,left:s}},set:function(e){this.updatePropertyBeforeReady("padding",e)||(this.paddingToArray(e,this.view.state.camera.pixelRatio,D),this.view.state.updateCamera((e=>e.padding=D)))}},{key:"screenCenter",get:function(){const e=this.padding;return p.createScreenPoint((this.view.width-(e.left+e.right))/2+e.left,(this.view.height-(e.top+e.bottom))/2+e.top)}},{key:"viewpoint",get:function(){return this.ready?I.fromCamera(this.view,this.camera):this._get("viewpoint")},set:function(e){if(!this.updatePropertyBeforeReady("viewpoint",e))if(e)if(this.isCompatible(e))this.setStateCamera(this.viewpointToCamera(e),{applyConstraints:!e.camera})||M.error("#viewpoint=","Invalid viewpoint",e);else{const t=s.isSome(e.camera)?e.camera.position:e.targetGeometry,i=s.isSome(t)&&t.spatialReference;M.error("#viewpoint=","Viewpoint has an incompatible spatial reference (viewpoint: "+(i?i.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e)}else M.error("#viewpoint=","Viewpoint may not be null or undefined")}},{key:"zoom",get:function(){return this.ready?P.scaleToZoom(this.view,this.scale):this._get("zoom")},set:function(e){this.updatePropertyBeforeReady("zoom",e)||this.setStateCamera(this.zoomToCamera(e),{applyConstraints:!0})||M.error("#zoom=","Invalid zoom",e)}}]),n}(n);t.__decorate([h.property({type:i,dependsOn:["view.state.camera","ready"]})],E.prototype,"camera",null),t.__decorate([h.property({type:i,dependsOn:["view.state.contentCamera","ready"]})],E.prototype,"contentCamera",null),t.__decorate([h.property({type:g})],E.prototype,"center",null),t.__decorate([h.property({type:C})],E.prototype,"extent",null),t.__decorate([h.property({readOnly:!0})],E.prototype,"frustum",null),t.__decorate([h.property({readOnly:!0})],E.prototype,"hasInitialView",null),t.__decorate([h.property({readOnly:!0,type:Boolean})],E.prototype,"ready",void 0),t.__decorate([h.property({type:Number})],E.prototype,"scale",null),t.__decorate([h.property()],E.prototype,"padding",null),t.__decorate([h.property({readOnly:!0})],E.prototype,"screenCenter",null),t.__decorate([h.property({constructOnly:!0})],E.prototype,"view",void 0),t.__decorate([h.property({type:r})],E.prototype,"viewpoint",null),t.__decorate([h.property({type:Number})],E.prototype,"zoom",null),t.__decorate([h.property({constructOnly:!0})],E.prototype,"updateDevicePixelRatio",void 0),E=t.__decorate([m.subclass("esri.views.3d.state.ViewStateManager")],E);var z=E;const N=["camera","viewpoint","extent","scale","center","zoom"],U=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"center",overrides:[]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],V={heading:0,tilt:0},A=new i,F=new B,D=f.create(),G="pending-initial-view";return z}));
