/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../Camera","../../../Viewpoint","../../../core/Accessor","../../../core/Handles","../../../core/Logger","../../../core/maybe","../../../core/reactiveUtils","../../../core/scheduling","../../../core/screenUtils","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec3","../../../chunks/vec3f64","../../../chunks/vec4","../../../chunks/vec4f64","../../../geometry/Extent","../../../geometry/Point","../../../geometry/support/webMercatorUtils","../../ViewingMode","../camera/constraintUtils","../camera/intersectionUtils","./ConstraintsManager","./Frustum","./GoToOperation","./controllers/SurfaceCollisionCorrectionController","../support/cameraUtils","../support/PropertiesPool","../support/viewpointUtils","../webgl-engine/lib/Camera","../../support/RenderState"],(function(e,t,i,a,r,n,o,s,c,l,h,d,p,m,u,v,w,g,_,y,f,C,S,x,R,T,P,O,M,b,I,V,k,E,N){"use strict";e.ViewStateManager=function(e){function i(i){var a;return(a=e.call(this,i)||this)._propertiesPool=new V.PropertiesPool({frustum:O.Frustum},t._assertThisInitialized(a)),a._handles=new o,a._cameraSetByUser=!1,a._gotoOperation=null,a.ready=!1,a._windowDevicePixelRatio=1,a._devicePixelRatioOverride=null,a._maximumPixelRatioOverride=null,a._cameraChangeTime=0,a.test={contentCameraResetState:new Map,setDevicePixelRatio:e=>a._devicePixelRatioOverride=e,setMaximumPixelRatio:e=>a._maximumPixelRatioOverride=e,renderState:null},a}t._inheritsLoose(i,e);var n=i.prototype;return n.installContentCameraReset=function(e){if(this._handles.remove("contentCameraReset"),this.test.contentCameraResetState.clear(),!this.view.state.fixedContentCamera)return!1;const t=this.zoom,i=this.view.state.camera.distance**2,a=g.fromArray(this.view.state.camera.center),r=e.sticky?this.contentCamera.clone():null;return this._handles.add([l.watch((()=>this.contentCamera),(()=>{e.sticky||(this._handles.remove("contentCameraReset"),this.test.contentCameraResetState.clear())})),l.watch((()=>this.zoom),(e=>{this.test.contentCameraResetState.set("view.zoom",Math.abs(e-t)/2),Math.abs(e-t)>2?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=r)})),l.watch((()=>this.view.state.camera),(e=>{const t=w.squaredDistance(a,e.center);this.test.contentCameraResetState.set("camera.center",t/i),t>i?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=r)}))],"contentCameraReset"),!0},n._paddingToArray=function(e,t,i){e?_.set(i,e.top||0,e.right||0,e.bottom||0,e.left||0):_.set(i,0,0,0,0);for(let a=0;a<4;a++)i[a]=Math.round(i[a]*t)},n.initialize=function(){this._cameraChangeTime=performance.now(),this._handles.add([l.on((()=>this.view.state.events),"before-camera-change",(e=>this._updateElevation(e.camera))),l.watch((()=>this.view.state?.camera),((e,t)=>this._cameraChangedHandler(e,t)),l.sync)]),l.when((()=>this.view.state?.camera),(e=>this._updateElevation(e)),{once:!0,sync:!0}),this._handles.add([h.addFrameTask({prepare:()=>this._prepareFrame()}),l.watch((()=>this.view.state.cameraController),(()=>{this._cameraSetByUser=!0,this._handles.remove(G)})),l.on((()=>this.view.state.events),"camera-projection-changed",(()=>this.notifyChange("scale")))])},n.destroy=function(){this.exit(),this._handles&&(this._handles.destroy(),this._handles=null),this._propertiesPool&&(this._propertiesPool.destroy(),this._propertiesPool=null)},n.init=function(){this.constraintsManager=new P.ConstraintsManager({view:this.view}),this._prepareFrame();const e=this._getInitialProperties();this._cameraSetByUser=!1,this._set("ready",!0);for(const t of e)this.set(t.name,t.value);if(!this._cameraSetByUser){const e=this.view.get("map.initialViewProperties.viewpoint")||this.view.initialExtent;e&&this.isCompatible(e)?this._setInitialView(e):this.view.state.viewingMode===x.ViewingMode.Local&&this._handles.add(l.when((()=>this.view.basemapTerrain.ready),(()=>{this._handles.remove(G),this._setInitialView(this.view.dataExtent)}),{once:!0,initial:!0}),G)}},n.exit=function(){this._cancelGoToOperation(),this.ready&&(this._override("padding",this.padding),this._set("ready",!1),this._clearOverride("hasInitialView"),this._cameraSetByUser=!1,this._handles.remove(G),this.constraintsManager&&(this.constraintsManager.destroy(),this.constraintsManager=null))},n.goTo=function(){var e=t._asyncToGenerator((function*(e,t){const i={animate:!0,...t};return c.isSome(this._gotoOperation)&&this._gotoOperation.abort(i.animate),this._gotoOperation=new M.GoToOperation(e,i,this.view),this.view.resourceController.scheduler.stopFrame(),this._gotoOperation}));function i(t,i){return e.apply(this,arguments)}return i}(),n.debugSetCameraOnContent=function(){this.setStateCamera(T.cameraOnContentAlongViewDirection(this.view),{applyConstraints:!1})},n.step=function(e){const t=this.view.state,i=t?.cameraController;i&&(t.updateCamera((t=>i.stepController(e,t))),i.steppingFinished&&i.finishController())},n._cancelGoToOperation=function(){c.isSome(this._gotoOperation)&&(this._gotoOperation.abort(),this._gotoOperation=null)},n._getInitialProperties=function(){const e=new Set,t=[];for(const{propertyName:i,overrides:a}of L){const r=e.has(i),n=this._isOverridden(i);!r&&n&&t.push({name:i,value:this._get(i)}),this._clearOverride(i),(r||n)&&a.forEach((t=>e.add(t)))}return t},n._setInitialView=function(e){if(c.isNone(e)||this._cameraSetByUser)return;if(e instanceof a)return void this.setStateCamera(I.externalToInternal(this.view,e),{applyConstraints:!1});if(e instanceof r){if(e.targetGeometry instanceof f){const t=I.fromExtent(this.view,e.targetGeometry,0,.5,I.OrientationMode.LOCKED);return void(c.isSome(t)&&this.setStateCamera(I.externalToInternal(this.view,t),{applyConstraints:!0}))}const t={applyConstraints:!e.camera},i=this._viewpointToCamera(e);return void this.setStateCamera(i,t)}const t=I.fromExtent(this.view,e,0,.5,I.OrientationMode.LOCKED);c.isSome(t)&&this.setStateCamera(I.externalToInternal(this.view,t),{applyConstraints:!0})},n._updatePropertyBeforeReady=function(e,t){return!this.ready&&(this._override(e,t),t&&A.includes(e)&&this._override("hasInitialView",!0),!0)},n.isCompatible=function(e){return!c.isNone(e)&&(e instanceof r?e.camera?this.isCompatible(e.camera):this.isCompatible(e.targetGeometry):e instanceof a?this.isCompatible(e.position):e.spatialReference&&S.canProject(e.spatialReference,this.view.spatialReference))},n._getPreservingHeadingTilt=function(e=B){return this._cameraSetByUser?(e.heading=this.camera.heading,e.tilt=this.camera.tilt):(e.heading=0,e.tilt=.5),e},n._centerPointAtDistanceToCamera=function(e,t,i=z){const{heading:a,tilt:r}=this._getPreservingHeadingTilt(),n=I.getObserverForPointAtDistance(this.view,a,r,e,t,I.OrientationMode.ADJUST);return c.isNone(n)?null:(i.copyFrom(this.view.state.camera),i.eye=n.eye,i.center=n.center,i.up=n.up,i)},n._centerToCamera=function(e){const t=this.view.pointsOfInterest.centerOnContent;t.runTask();const i=t.distance;return this._centerPointAtDistanceToCamera(e,i)},n._extentToCamera=function(e){const{heading:t,tilt:i}=this._getPreservingHeadingTilt(),a=I.fromExtent(this.view,e,t,i,I.OrientationMode.ADJUST,U);return c.isSome(a)?I.externalToInternal(this.view,a):null},n._scaleToCamera=function(e){if(null==e)return null;const t=this.view.pointsOfInterest.centerOnContent;t.runTask();const i=t.renderLocation,a=t.location.latitude,r=I.scaleToDistance(this.view,e,a);return this._centerPointAtDistanceToCamera(i,r)},n._zoomToCamera=function(e){return this._scaleToCamera(I.zoomToScale(this.view,e))},n._viewpointToCamera=function(e){return I.externalToInternal(this.view,k.toCamera(this.view,e))},n.setStateCamera=function(e,t){return!(c.isNone(e)||!this.view.state.stopActiveCameraController())&&(this._cameraSetByUser=!0,t.doNotCancelGoToOperation||this._cancelGoToOperation(),this.view.state.updateCamera((i=>{t.positionAndOrientationOnly?(i.eye=e.eye,i.center=e.center,i.up=e.up):i.copyFrom(e),t.applyConstraints&&R.applyAll(this.view,i)})),t.applyConstraints||(this.view.state.cameraController=new b.SurfaceCollisionCorrectionController({view:this.view,desiredCamera:e})),!0)},n._prepareFrame=function(){const{surface:e,canvas:t}=this.view;if(!e||!t)return;this._windowDevicePixelRatio=window.devicePixelRatio;const i=this._devicePixelRatio,a=Math.round(e.clientWidth*i),r=Math.round(e.clientHeight*i);if(0!==a&&0!==r&&(t.width===a&&t.height===r||(t.width=a,t.height=r),this.view.state)){const e=this.view.state.camera;e.fullWidth===a&&e.fullHeight===r&&e.pixelRatio===i||(z.copyFrom(e),z.pixelRatio!==i&&(this._paddingToArray(this.padding,i,D),z.padding=D),z.fullWidth=a,z.fullHeight=r,z.pixelRatio=i,this.view.state.camera=z),this._updateRenderState()}},n._updateElevation=function(e){const t=this.view.basemapTerrain&&this.view.basemapTerrain.spatialReference,i=this.view.renderCoordsHelper?.getAltitude(e.eye)??0,a=t?T.surfaceElevationBelowRenderLocation(this.view,e.eye):0;e.relativeElevation=i-a},n._updateRenderState=function(){c.isSome(this.test.renderState)?this.view.state.mode=this.test.renderState:this.view.animation?this.view.state.mode=N.RenderState.ANIMATING:this.view.interacting?this.view.state.mode=N.RenderState.INTERACTING:(this.view.state.mode===N.RenderState.ANIMATING&&(this._cameraChangeTime=0),performance.now()-this._cameraChangeTime<=H?this.view.state.mode=N.RenderState.INTERACTING:this.view.state.mode=N.RenderState.IDLE)},n._cameraChangedHandler=function(e,t){e&&t&&e.almostEquals(t)||(this._cameraChangeTime=performance.now(),this._updateRenderState())},t._createClass(i,[{key:"camera",get:function(){const e=this._get("camera");if(!this.ready)return e;const t=I.internalToExternal(this.view,this.view.state.camera,U);return t&&e&&t.equals(e)?e:t.clone()},set:function(e){this._updatePropertyBeforeReady("camera",e)||(this.view.elevationProvider.enableElevationCache(!0),this.setStateCamera(I.externalToInternal(this.view,e),{applyConstraints:!1})||s.getLogger(this.declaredClass).error("#camera=","Invalid camera",e),this.view.elevationProvider.enableElevationCache(!1))}},{key:"contentCamera",get:function(){const e=this._get("contentCamera");if(!this.ready)return e;const t=I.internalToExternal(this.view,this.view.state.contentCamera,U);return t&&e&&t.equals(e)?e:t.clone()},set:function(e){if(this._updatePropertyBeforeReady("contentCamera",e))return;const t=I.externalToInternal(this.view,e);c.isNone(t)?this.view.state.contentCamera=null:(this._updateElevation(t),this.view.state.contentCamera=t)}},{key:"center",get:function(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")},set:function(e){this._updatePropertyBeforeReady("center",e)||(e?this.isCompatible(e)?this.setStateCamera(this._centerToCamera(e),{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.runTask():s.getLogger(this.declaredClass).error("#center=","Invalid center",e):s.getLogger(this.declaredClass).error("#center=","Center has an incompatible spatial reference (center: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e):s.getLogger(this.declaredClass).error("#center=","Center may not be null or undefined"))}},{key:"extent",get:function(){if(!this.ready)return this._get("extent");const e=this.view,t=I.toExtent(e,e.state.camera,e.pointsOfInterest.centerOnContent.renderLocation);return c.isSome(t)?t:this._get("extent")},set:function(e){this._updatePropertyBeforeReady("extent",e)||(e?this.isCompatible(e)?this.setStateCamera(this._extentToCamera(e),{applyConstraints:!0})||s.getLogger(this.declaredClass).error("#extent=","Invalid extent",e):s.getLogger(this.declaredClass).error("#extent=","Extent has an incompatible spatial reference (extent: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e):s.getLogger(this.declaredClass).error("#extent=","Extent may not be null or undefined"))}},{key:"frustum",get:function(){const e=this._propertiesPool.get("frustum");return e.renderCoordsHelper=this.view.renderCoordsHelper,e.update(this.view.state.camera),e}},{key:"hasInitialView",get:function(){return!!this.view.get("map.initialViewProperties.viewpoint")}},{key:"scale",get:function(){if(this.ready){const e=this.view.pointsOfInterest.centerOnContent;return I.distanceToScale(this.view,e.distance,e.location.latitude)}return this._get("scale")},set:function(e){this._updatePropertyBeforeReady("scale",e)||this.setStateCamera(this._scaleToCamera(e),{applyConstraints:!0})||s.getLogger(this.declaredClass).error("#scale=","Invalid scale",e)}},{key:"padding",get:function(){if(!this.ready)return this._get("padding");const e=this.view.state.camera,t=e.padding,i=e.pixelRatio,a=this._get("padding"),r=Math.round(t[E.PaddingSide.TOP]/i),n=Math.round(t[E.PaddingSide.RIGHT]/i),o=Math.round(t[E.PaddingSide.BOTTOM]/i),s=Math.round(t[E.PaddingSide.LEFT]/i);return null!=a&&a.top===r&&a.right===n&&a.bottom===o&&a.left===s?a:{top:r,right:n,bottom:o,left:s}},set:function(e){this._updatePropertyBeforeReady("padding",e)||(this._paddingToArray(e,this.view.state.camera.pixelRatio,D),this.view.state.updateCamera((e=>e.padding=D)))}},{key:"screenCenter",get:function(){const e=this.padding;return d.createScreenPoint((this.view.width-(e.left+e.right))/2+e.left,(this.view.height-(e.top+e.bottom))/2+e.top)}},{key:"viewpoint",get:function(){return this.ready?k.fromCamera(this.view,this.camera):this._get("viewpoint")},set:function(e){if(!this._updatePropertyBeforeReady("viewpoint",e))if(e)if(this.isCompatible(e))this.setStateCamera(this._viewpointToCamera(e),{applyConstraints:!e.camera})||s.getLogger(this.declaredClass).error("#viewpoint=","Invalid viewpoint",e);else{const t=c.isSome(e.camera)?e.camera.position:e.targetGeometry,i=c.isSome(t)&&t.spatialReference;s.getLogger(this.declaredClass).error("#viewpoint=","Viewpoint has an incompatible spatial reference (viewpoint: "+(i?i.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e)}else s.getLogger(this.declaredClass).error("#viewpoint=","Viewpoint may not be null or undefined")}},{key:"zoom",get:function(){return this.ready?I.scaleToZoom(this.view,this.scale):this._get("zoom")},set:function(e){this._updatePropertyBeforeReady("zoom",e)||this.setStateCamera(this._zoomToCamera(e),{applyConstraints:!0})||s.getLogger(this.declaredClass).error("#zoom=","Invalid zoom",e)}},{key:"maximumPixelRatio",get:function(){if(c.isSome(this._maximumPixelRatioOverride))return this._maximumPixelRatioOverride;let e=1/0;const{maximumPixelRatio:t,maximumRenderResolution:i}=this.view.qualitySettings;if(null!=t&&(e=Math.min(e,t)),null!=i){const t=i/Math.max(this.view.width,this.view.height);e=Math.min(e,t)}return e}},{key:"_devicePixelRatio",get:function(){return c.isNone(this._devicePixelRatioOverride)?Math.min(this._windowDevicePixelRatio,this.maximumPixelRatio):this._devicePixelRatioOverride}}]),i}(n),i.__decorate([p.property({type:a,dependsOn:["view.state.camera","ready"]})],e.ViewStateManager.prototype,"camera",null),i.__decorate([p.property({type:a,dependsOn:["view.state.contentCamera","ready"]})],e.ViewStateManager.prototype,"contentCamera",null),i.__decorate([p.property({type:C})],e.ViewStateManager.prototype,"center",null),i.__decorate([p.property({type:f})],e.ViewStateManager.prototype,"extent",null),i.__decorate([p.property({readOnly:!0})],e.ViewStateManager.prototype,"frustum",null),i.__decorate([p.property({readOnly:!0})],e.ViewStateManager.prototype,"hasInitialView",null),i.__decorate([p.property({readOnly:!0,type:Boolean})],e.ViewStateManager.prototype,"ready",void 0),i.__decorate([p.property({type:Number})],e.ViewStateManager.prototype,"scale",null),i.__decorate([p.property()],e.ViewStateManager.prototype,"padding",null),i.__decorate([p.property({readOnly:!0})],e.ViewStateManager.prototype,"screenCenter",null),i.__decorate([p.property({constructOnly:!0})],e.ViewStateManager.prototype,"view",void 0),i.__decorate([p.property({type:r})],e.ViewStateManager.prototype,"viewpoint",null),i.__decorate([p.property({type:Number})],e.ViewStateManager.prototype,"zoom",null),i.__decorate([p.property()],e.ViewStateManager.prototype,"maximumPixelRatio",null),i.__decorate([p.property()],e.ViewStateManager.prototype,"_devicePixelRatio",null),i.__decorate([p.property()],e.ViewStateManager.prototype,"_windowDevicePixelRatio",void 0),i.__decorate([p.property()],e.ViewStateManager.prototype,"_devicePixelRatioOverride",void 0),i.__decorate([p.property()],e.ViewStateManager.prototype,"_maximumPixelRatioOverride",void 0),e.ViewStateManager=i.__decorate([v.subclass("esri.views.3d.state.ViewStateManager")],e.ViewStateManager);const A=["camera","viewpoint","extent","scale","center","zoom"],L=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"center",overrides:[]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],B={heading:0,tilt:0},U=new a,z=new E.Camera,D=y.create(),G="pending-initial-view",H=300,F=100;e.INTERACTING_TIMEOUT=F,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
