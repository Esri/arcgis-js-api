// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/assignHelper","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","../../../Camera","../../../Viewpoint","../../../core/Accessor","../../../core/Error","../../../core/Handles","../../../core/Logger","../../../core/maybe","../../../core/promiseUtils","../../../core/scheduling","../../../core/screenUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators","../../../core/libs/gl-matrix-2/vec4","../../../core/libs/gl-matrix-2/vec4f64","../../../geometry/Extent","../../../geometry/Point","../../../geometry/support/webMercatorUtils","../camera/constraintUtils","../camera/intersectionUtils","./ConstraintsManager","./Frustum","./controllers/PointToPointAnimationController","./controllers/SurfaceCollisionCorrectionController","../support/cameraUtils","../support/PropertiesPool","../support/viewpointUtils","../webgl-engine/lib/Camera","../../animation/easing"],(function(e,t,i,r,n,a,o,s,l,c,p,d,h,u,m,v,f,w,y,g,C,b,T,O,S,P,x,A,I,R,G,_,E,B,F){Object.defineProperty(t,"__esModule",{value:!0});var V=h.getLogger("esri.views.3d.state.ViewStateManager"),M=function(e){function t(t){var i=e.call(this,t)||this;return i.propertiesPool=new _.default({frustum:A.default},i),i.handles=new d,i.cameraSetByUser=!1,i.internalSetOrder=[],i.immediateGoToController=null,i.animatedGoToController=null,i.ready=!1,i.updateDevicePixelRatio=null,i}return r(t,e),Object.defineProperty(t.prototype,"camera",{get:function(){if(!this.ready)return this._get("camera");var e=G.internalToExternal(this.view,this.view.state.camera),t=this._get("camera");return e&&t&&e.equals(t)?t:e},set:function(e){this.updatePropertyBeforeReady("camera",e)||this.setStateCamera(G.externalToInternal(this.view,e),{applyConstraints:!1})||V.error("#camera=","Invalid camera",e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"center",{get:function(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")},set:function(e){this.updatePropertyBeforeReady("center",e)||(e?this.isCompatible(e)?this.setStateCamera(this.centerToCamera(e),{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.update():V.error("#center=","Invalid center",e):V.error("#center=","Center has an incompatible spatial reference (center: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e):V.error("#center=","Center may not be null or undefined"))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"extent",{get:function(){return this.ready?G.toExtent(this.view,this.view.state.camera,this.view.pointsOfInterest.centerOnContent.renderLocation):this._get("extent")},set:function(e){this.updatePropertyBeforeReady("extent",e)||(e?this.isCompatible(e)?this.setStateCamera(this.extentToCamera(e),{applyConstraints:!0})||V.error("#extent=","Invalid extent",e):V.error("#extent=","Extent has an incompatible spatial reference (extent: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e):V.error("#extent=","Extent may not be null or undefined"))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"frustum",{get:function(){var e=this.propertiesPool.get("frustum");return e.renderCoordsHelper=this.view.renderCoordsHelper,e.update(this.view.state.camera),e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hasInitialView",{get:function(){return!!this.view.get("map.initialViewProperties.viewpoint")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"scale",{get:function(){if(!this.ready)return this._get("scale");var e=this.view.pointsOfInterest.centerOnContent;return G.distanceToScale(this.view,e.distance,e.location.latitude)},set:function(e){this.updatePropertyBeforeReady("scale",e)||this.setStateCamera(this.scaleToCamera(e),{applyConstraints:!0})||V.error("#scale=","Invalid scale",e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"padding",{get:function(){if(!this.ready)return this._get("padding");var e=this.view.state.camera,t=e.padding,i=e.pixelRatio,r=this._get("padding"),n=Math.round(t[0]/i),a=Math.round(t[1]/i),o=Math.round(t[2]/i),s=Math.round(t[3]/i);return null!=r&&r.top===n&&r.right===a&&r.bottom===o&&r.left===s?r:{top:n,right:a,bottom:o,left:s}},set:function(e){this.updatePropertyBeforeReady("padding",e)||(this.paddingToArray(e,this.view.state.camera.pixelRatio,N),this.view.state.updateCamera((function(e){return e.padding=N})))},enumerable:!0,configurable:!0}),t.prototype.paddingToArray=function(e,t,i){e?g.vec4.set(i,e.top||0,e.right||0,e.bottom||0,e.left||0):g.vec4.set(i,0,0,0,0);for(var r=0;r<4;r++)i[r]=Math.round(i[r]*t)},Object.defineProperty(t.prototype,"screenCenter",{get:function(){var e=this.padding;return f.createScreenPoint((this.view.width-(e.left+e.right))/2+e.left,(this.view.height-(e.top+e.bottom))/2+e.top)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"viewpoint",{get:function(){return this.ready?E.fromCamera(this.view,this.camera):this._get("viewpoint")},set:function(e){if(!this.updatePropertyBeforeReady("viewpoint",e))if(e)if(this.isCompatible(e))this.setStateCamera(this.viewpointToCamera(e),{applyConstraints:!e.camera})||V.error("#viewpoint=","Invalid viewpoint",e);else{var t=e.camera?e.camera.position:e.targetGeometry,i=t&&t.spatialReference;V.error("#viewpoint=","Viewpoint has an incompatible spatial reference (viewpoint: "+(i?i.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e)}else V.error("#viewpoint=","Viewpoint may not be null or undefined")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"zoom",{get:function(){return this.ready?G.scaleToZoom(this.view,this.scale):this._get("zoom")},set:function(e){this.updatePropertyBeforeReady("zoom",e)||this.setStateCamera(this.zoomToCamera(e),{applyConstraints:!0})||V.error("#zoom=","Invalid zoom",e)},enumerable:!0,configurable:!0}),t.prototype.initialize=function(){var e=this;this.handles.add([this.view.watch("state.camera",(function(t){return e.cameraChangedSync(t)}),!0),w.on(this.view,"state.events","before-camera-change",(function(t){return e.updateElevation(t.camera)}))]),w.once(this.view,"state.camera",(function(t){return e.updateElevation(t)}),!0),this.handles.add(v.addFrameTask({prepare:function(){return e.prepareFrame()}})),this.handles.add(this.view.watch("state.cameraController",(function(){e.cameraSetByUser=!0,e.handles.remove(k),e.cancelImmediateGoTo()}))),this.handles.add(w.on(this.view,"state.events","camera-projection-changed",(function(){return e.notifyChange("scale")})))},t.prototype.destroy=function(){this.deinit(),this.handles&&(this.handles.destroy(),this.handles=null),this.propertiesPool&&(this.propertiesPool.destroy(),this.propertiesPool=null)},t.prototype.init=function(){var e=this;this.constraintsManager=new x.default({view:this.view}),this.prepareFrame();var t=this.getInitialProperties();this.cameraSetByUser=!1,this._set("ready",!0);for(var i=0,r=t;i<r.length;i++){var n=r[i];this.set(n.name,n.value)}if(!this.cameraSetByUser){var a=this.view.get("map.initialViewProperties.viewpoint")||this.view.initialExtent;a&&this.isCompatible(a)?this.setInitialView(a):"local"===this.view.state.mode&&this.handles.add(w.whenOnce(this.view.basemapTerrain,"ready",(function(){e.handles.remove(k),e.setInitialView(e.view.groundExtent)})),k)}},t.prototype.deinit=function(){this.ready&&(this._override("padding",this.padding),this.cancelImmediateGoTo(),this.cancelAnimatedGoTo(),this._set("ready",!1),this._clearOverride("hasInitialView"),this.internalSetOrder.length=0,this.cameraSetByUser=!1,this.handles.remove(k),this.constraintsManager&&(this.constraintsManager.destroy(),this.constraintsManager=null))},t.prototype.goTo=function(e,t){return o(this,void 0,void 0,(function(){var r;return a(this,(function(n){return(r=i({animate:!0},t)).animate?[2,this.goToAnimated(e,r)]:[2,this.goToImmediate(e,r)]}))}))},t.prototype.debugSetCameraOnContent=function(){this.setStateCamera(P.cameraOnContentAlongViewDirection(this.view),{applyConstraints:!1})},t.prototype.step=function(e){var t=this.view.state,i=t&&this.view.state.cameraController;i&&(t.updateCamera((function(t){i.stepController(e,t)})),i.steppingFinished&&i.finishController())},t.prototype.cancelImmediateGoTo=function(){var e=this.immediateGoToController;u.isSome(e)&&(this.immediateGoToController=null,e.abort())},t.prototype.cancelAnimatedGoTo=function(){var e=this.animatedGoToController;u.isSome(e)&&(this.animatedGoToController=null,e.abort())},t.prototype.getInitialProperties=function(){for(var e=new Set,t=[],i=0,r=H;i<r.length;i++){var n=r[i],a=n.propertyName,o=n.overrides,s=e.has(a),l=this._isOverridden(a);!s&&l&&t.push({name:a,value:this._get(a)}),this._clearOverride(a),(s||l)&&o.forEach((function(t){return e.add(t)}))}return t},t.prototype.setInitialView=function(e){if(e&&!this.cameraSetByUser)if(e instanceof s)this.setStateCamera(G.externalToInternal(this.view,e),{applyConstraints:!1});else if(e instanceof l){if(e.targetGeometry instanceof b){var t=G.fromExtent(this.view,e.targetGeometry,0,.5,0);return void this.setStateCamera(G.externalToInternal(this.view,t),{applyConstraints:!0})}var i={applyConstraints:!e.camera},r=this.viewpointToCamera(e);this.setStateCamera(r,i)}else{var n=G.fromExtent(this.view,e,0,.5,0);this.setStateCamera(G.externalToInternal(this.view,n),{applyConstraints:!0})}},t.prototype.updatePropertyBeforeReady=function(e,t){if(!this.ready){this._override(e,t);var i=this.internalSetOrder.indexOf(e);return-1!==i&&(this.internalSetOrder=this.internalSetOrder.splice(i,1)),t&&(this.internalSetOrder.push(e),-1!==U.indexOf(e)&&this._override("hasInitialView",!0)),!0}return!1},t.prototype.isCompatible=function(e){return!!e&&(e instanceof l?e.camera?this.isCompatible(e.camera):this.isCompatible(e.targetGeometry):e instanceof s?this.isCompatible(e.position):e.spatialReference&&O.canProject(e.spatialReference,this.view.spatialReference))},t.prototype.getPreservingHeadingTilt=function(e){return void 0===e&&(e=j),this.cameraSetByUser?(e.heading=this.camera.heading,e.tilt=this.camera.tilt):(e.heading=0,e.tilt=.5),e},t.prototype.centerPointAtDistanceToCamera=function(e,t,i){void 0===i&&(i=D);var r=this.getPreservingHeadingTilt(),n=r.heading,a=r.tilt,o=G.getObserverForPointAtDistance(this.view,n,a,e,t,1);return o?(i.copyFrom(this.view.state.camera),i.eye=o.eye,i.center=o.center,i.up=o.up,i):null},t.prototype.centerToCamera=function(e){var t=this.view.pointsOfInterest.centerOnContent;t.update();var i=t.distance;return this.centerPointAtDistanceToCamera(e,i)},t.prototype.extentToCamera=function(e){var t=this.getPreservingHeadingTilt(),i=t.heading,r=t.tilt,n=G.fromExtent(this.view,e,i,r,1,z);return G.externalToInternal(this.view,n)},t.prototype.scaleToCamera=function(e){if(null==e)return null;var t=this.view.pointsOfInterest.centerOnContent;t.update();var i=t.renderLocation,r=t.location.latitude,n=G.scaleToDistance(this.view,e,r);return this.centerPointAtDistanceToCamera(i,n)},t.prototype.zoomToCamera=function(e){return this.scaleToCamera(G.zoomToScale(this.view,e))},t.prototype.viewpointToCamera=function(e){var t=E.toCamera(this.view,e);return t?G.externalToInternal(this.view,t):null},t.prototype.setStateCamera=function(e,t){var i=this;return!!e&&(!!this.view.state.stopActiveCameraController()&&(this.cameraSetByUser=!0,this.cancelImmediateGoTo(),this.view.state.updateCamera((function(r){t.positionAndOrientationOnly?(r.eye=e.eye,r.center=e.center,r.up=e.up):r.copyFrom(e),t.applyConstraints&&S.applyAll(i.view,r)})),t.applyConstraints||(this.view.state.cameraController=new R.SurfaceCollisionCorrectionController({view:this.view,desiredCamera:e})),!0))},t.prototype.prepareFrame=function(){var e=this.view,t=e.container,i=e.canvas;if(t&&i){u.isSome(this.updateDevicePixelRatio)&&this.updateDevicePixelRatio();var r=this.view.pixelRatio,n=Math.round(t.clientWidth*r),a=Math.round(t.clientHeight*r);if(0!==n&&0!==a&&(i.width===n&&i.height===a||(i.width=n,i.height=a),this.view.state)){var o=this.view.state.camera;o.fullWidth===n&&o.fullHeight===a&&o.pixelRatio===r||(D.copyFrom(o),D.pixelRatio!==r&&(this.paddingToArray(this.padding,r,N),D.padding=N),D.fullWidth=n,D.fullHeight=a,D.pixelRatio=r,this.view.state.camera=D)}}},t.prototype.updateElevation=function(e){var t=this.view.basemapTerrain&&this.view.basemapTerrain.spatialReference,i=this.view.renderCoordsHelper.getAltitude(e.eye),r=t?P.surfaceElevationBelowEye(this.view,e):0;e.relativeElevation=i-r},t.prototype.cameraChangedSync=function(e){e&&this.view._stage&&this.view._stage.setCamera(e)},t.prototype.createGoToCamera=function(e,t){return o(this,void 0,void 0,(function(){var i,r,n,o,c,d,h,u;return a(this,(function(a){switch(a.label){case 0:return[4,w.whenOnce(this,"ready",t.signal,!0)];case 1:return a.sent(),m.throwIfAborted(t),[4,E.create(this.view,e,t.signal)];case 2:if(i=a.sent(),r=!!(e instanceof l&&e.camera||e instanceof s),n=i.camera,!this.isCompatible(n))throw o=n.position,c=o&&o.spatialReference,d=c?c.wkid:"none",h=this.view.spatialReference.wkid,new p("goto:incompatible-spatialreference","Resulting camera has an incompatible spatial reference (camera: "+d+", view: "+h+")",{camera:n});if(!(u=G.externalToInternal(this.view,n)))throw new p("goto:invalid-camera","Resulting camera is invalid");return[2,{viewpoint:i,camera:u,isFullySpecified:r}]}}))}))},t.prototype.cancellableGoTo=function(e,t){var i,r=this,n=function(){r.view.state.cameraController===e&&e.active&&e.asyncResult===i&&e.stopController()};return m.create((function(r,a){i={resolve:r,reject:a},e.asyncResult=i,m.onAbort(t,n)}),n)},t.prototype.goToImmediate=function(e,t){return o(this,void 0,void 0,(function(){var r,n,o,s=this;return a(this,(function(a){return this.cancelAnimatedGoTo(),this.cancelImmediateGoTo(),r=m.createAbortController(),m.onAbort(t,(function(){return r.abort()})),n=this.createGoToCamera(e,i({},t,{signal:r.signal})),o=function(){s.immediateGoToController===r&&(s.immediateGoToController=null)},this.immediateGoToController=r,[2,n.then((function(e){o(),s.setStateCamera(e.camera,{applyConstraints:!e.isFullySpecified,positionAndOrientationOnly:!0})})).catch((function(e){throw o(),!m.isAbortError(e)&&e instanceof p&&e.message&&V.error("#goTo()","Failed to create camera from target, "+e.message[0].toLowerCase()+e.message.slice(1)),e}))]}))}))},t.prototype.goToAnimatedBeforeReady=function(e,t){return o(this,void 0,void 0,(function(){var r;return a(this,(function(n){switch(n.label){case 0:return this.cancelAnimatedGoTo(),r=m.createAbortController(),m.onAbort(t,(function(){return r.abort()})),this.animatedGoToController=r,t=i({},t,{signal:r.signal}),[4,w.whenOnce(this.view,"ready",r.signal)];case 1:return n.sent(),this.animatedGoToController=null,[2,this.goToAnimated(e,t)]}}))}))},t.prototype.goToAnimated=function(e,t){return o(this,void 0,void 0,(function(){var i,r,n,s,l,c,d=this;return a(this,(function(h){return this.cancelAnimatedGoTo(),this.ready?((i=this.view.state.cameraController)instanceof I.PointToPointAnimationController&&(i.updateStateFromViewAnimation(),i.active&&(r=i)),null==r&&(r=new I.PointToPointAnimationController(this.view.state,this.view.sceneIntersectionHelper,"animation")),n=r.viewAnimation,u.isNone(n)?(V.warn("Unreachable code in ViewStateManager"),[2]):(s=this.createGoToCamera(e,t),n.update(s.then((function(e){return e.viewpoint}))),r===i||this.view.state.switchCameraController(r)?(l=n.target,c=function(){return d.view.state.cameraController===r&&u.isSome(r.viewAnimation)&&r.viewAnimation.target===l&&r.active},s.then((function(e){var i=e.viewpoint,s=e.camera,p=e.isFullySpecified;return o(d,void 0,void 0,(function(){var e,o,d=this;return a(this,(function(a){switch(a.label){case 0:return c()?(u.isSome(r.viewAnimation)&&(r.viewAnimation.update(i),l=r.viewAnimation.target),p?(e=new R.SurfaceCollisionCorrectionController({view:this.view,desiredCamera:s}),S.applySurfaceCollisionConstraint(this.view,s,1)):S.applyAll(this.view,s),r.begin(s,this.internalAnimateOptions(t)),o=function(){var t=d.view.state.cameraController;e&&(t&&t.active?t instanceof I.PointToPointAnimationController&&u.isSome(t.viewAnimation)&&t.viewAnimation.target===l&&(d.view.state.cameraController=e):u.isSome(r.viewAnimation)&&r.viewAnimation.target===l&&"finished"===r.state&&(d.view.state.cameraController=e))},[4,n.when(o,o)]):[2];case 1:return a.sent(),[2]}}))}))})).catch((function(e){if(!m.isAbortError(e)&&e instanceof p&&e.message&&V.error("#goTo()","Failed to create camera from target, "+e.message[0].toLowerCase()+e.message.slice(1)),c())throw d.view.state.cameraController.stopController(),e})),[2,this.cancellableGoTo(r,t)]):(n.stop(),V.error("#goTo()","Cannot start an animation while interacting"),[2,m.reject(new p("view:goto-cannot-interrupt","Cannot start an animation while interacting"))]))):[2,this.goToAnimatedBeforeReady(e,t)]}))}))},t.prototype.internalAnimateOptions=function(e){var t={};return e&&(null!=e.speedFactor&&(t.speedFactor=e.speedFactor),null!=e.duration&&(t.duration=e.duration/1e3),null!=e.maxDuration&&(t.maxDuration=e.maxDuration/1e3),null!=e.easing&&("string"==typeof e.easing?t.easing=F.named[e.easing]:t.easing=e.easing)),t},n([y.property({type:s,dependsOn:["view.state.camera","ready"]})],t.prototype,"camera",null),n([y.property({type:T,dependsOn:["view.pointsOfInterest.centerOnContent.location","ready"]})],t.prototype,"center",null),n([y.property({type:b,dependsOn:["view.state.camera","ready","view.pointsOfInterest.centerOnContent.location"]})],t.prototype,"extent",null),n([y.property({readOnly:!0,dependsOn:["view.state.camera","ready"]})],t.prototype,"frustum",null),n([y.property({readOnly:!0,dependsOn:["view.map.initialViewProperties?.viewpoint"]})],t.prototype,"hasInitialView",null),n([y.property({readOnly:!0,type:Boolean})],t.prototype,"ready",void 0),n([y.property({dependsOn:["view.pointsOfInterest.centerOnContent.distance","ready"],type:Number})],t.prototype,"scale",null),n([y.property({dependsOn:["view.state.camera","ready"]})],t.prototype,"padding",null),n([y.property({readOnly:!0,dependsOn:["view.width","view.height","padding"]})],t.prototype,"screenCenter",null),n([y.property({constructOnly:!0})],t.prototype,"view",void 0),n([y.property({type:l,dependsOn:["camera","ready"]})],t.prototype,"viewpoint",null),n([y.property({type:Number,dependsOn:["scale"]})],t.prototype,"zoom",null),n([y.property({constructOnly:!0})],t.prototype,"updateDevicePixelRatio",void 0),t=n([y.subclass("esri.views.3d.state.ViewStateManager")],t)}(y.declared(c));t.ViewStateManager=M;var U=["camera","viewpoint","extent","scale","center","zoom"],H=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"center",overrides:[]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],j={heading:0,tilt:0},z=new s,D=new B.default,N=C.vec4f64.create(),k="pending-initial-view";t.default=M}));