/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../../core/mathUtils","../../../../core/maybe","../../../../core/screenUtils","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec2","../../../../chunks/vec2f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/support/axisAngle","../../../../geometry/support/coordinateSystem","../../../../geometry/support/plane","../../../../chunks/sphere","../../../../geometry/support/vector","../../../../geometry/support/vectorStacks","../../support/mathUtils","../../support/geometryUtils/ray","../../support/geometryUtils/sphere","../../webgl-engine/lib/Camera"],(function(e,t,n,a,r,o,c,i,s,l,d,u,m,p,h,g,y,f,M,P){"use strict";const v=30,b=[1,3e8],A=70;function z(e,t,n){return n[0]=t[0]/(e.fullWidth/e.pixelRatio),n[1]=t[1]/(e.fullHeight/e.pixelRatio),n}function S(e,t,n){const a=g.sv3d.get(),r=g.sv3d.get(),o=g.sv3d.get();s.copy(r,e),s.copy(o,t);const c=s.dot(r,n),i=s.dot(o,n);s.scale(a,n,c),s.subtract(r,r,a),s.normalize(r,r),s.scale(a,n,i),s.subtract(o,o,a),s.normalize(o,o);const l=s.dot(r,o);s.cross(a,n,r);const d=s.dot(o,a);return Math.atan2(d,l)}function x(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e}function I(e,t,n){const a=g.sm4d.get();r.identity(a),r.rotate(a,a,n[3],d.axis(n)),s.subtract(Ae,e.eye,t),s.transformMat4(Ae,Ae,a),e.eye=s.add(Ae,Ae,t),s.subtract(Ae,e.center,t),s.transformMat4(Ae,Ae,a),e.center=s.add(Ae,Ae,t),e.up=s.transformMat4(Ae,e.up,a)}function T(e,t,n,a){return m.intersectRay(e,f.fromScreen(t,n,Te),a)}function E(e,t,n,a){return m.intersectRay(e,f.fromScreenAtEye(t,n,Te),a)}function N(e,t,n,a){const r=g.sv3d.get();let o=1-n;s.subtract(r,t,e.eye);const c=s.length(r);let i=c*(1-o);o>=0&&i<a&&(i=a,o=-(i-c)/c),Math.abs(c-i)<1e-6||(s.scale(r,r,o),e.eye=s.add(Ae,e.eye,r),e.center=s.lerp(Ae,e.center,t,o))}function R(e,t,n){t.getScreenCenter(k),M.intersectScreen(e,t,k,Ae)&&(t.center=Ae);const a=t.distance,r=a*n;if(Math.abs(a-r)<1e-6)return;const o=s.scale(g.sv3d.get(),t.viewForward,r);t.eye=s.subtract(Ae,t.center,o)}const k=a.createScreenPointArray();function C(e,t,n){F(t,n),s.normalize(n,n),s.scale(n,n,e)}function F(e,t){s.set(t,0,0,0);for(const n of e)s.add(t,t,n);s.scale(t,t,1/e.length)}function D(e,t,n,a){return Math.sin(e/s.length(t))*(n+a.radius)}function O(e,t,n,a){return D(Math.PI/2,t,n,a)+(e-Math.PI/2)}var w;e.NavigationMode=void 0,(w=e.NavigationMode||(e.NavigationMode={}))[w.Vertical=0]="Vertical",w[w.Horizontal=1]="Horizontal";const H={Elevation:3e4,Angle:t.deg2rad(6)},V={Pole:.95,Angle:t.deg2rad(18),Tilt:45},q=t.deg2rad(80);function _(e,t,n,a,r){const o=l.create(),c=p.create();let i=!0,d=!0;return e.intersectScreen(n,o)?c[3]=s.length(o):(d=!1,t.aboveGround?c[3]=Math.max(s.length(t.center),.9*r.radius):c[3]=s.length(t.eye)-t.relativeElevation,a?W(c,t,n,o):i=M.intersectScreen(c,t,n,o)),{sphere:c,scenePickPoint:i?o:null,hasGeometryIntersection:d}}function G(t,n,a,r){if(s.length(t.eye)-r.radius>H.Elevation)return e.NavigationMode.Horizontal;if(!a)return e.NavigationMode.Vertical;f.fromScreenAtEye(t,n,Ee);return-Math.sign(t.relativeElevation)*(.5*Math.PI+h.angle(t.eye,Ee.direction))<H.Angle?e.NavigationMode.Vertical:e.NavigationMode.Horizontal}function U(e,t,n){s.subtract(L,n,t),e.eye=s.subtract(Ae,e.eye,L),e.center=s.subtract(Ae,e.center,L)}const L=l.create();function W(e,t,a,r){const o=f.fromScreenAtEye(t,a,Te);return!n.isNone(o)&&(p.closestPointOnSilhouette(e,o,Z),p.intersectRay(e,o,r)?!(s.squaredDistance(Z,o.origin)<s.squaredDistance(r,o.origin))||(s.copy(r,Z),!1):(s.subtract(j,t.eye,t.center),s.normalize(j,j),m.fromNormalAndOffset(j,-s.dot(s.normalize(j,j),Z),X),m.intersectRay(X,o,r),!1))}const Z=l.create(),j=l.create(),X=m.create();function B(e,n,a,r,o,c){let i;if(s.cross(xe,e,n),s.subtract(ze,e,n),s.length(e)<=o||!r.aboveGround){s.cross(a,ze,r.eye);const l=s.dot(e,n)/(s.length(e)*s.length(n)),d=Math.cos(t.clamp(y.cyclicalPI.normalize(t.deg2rad(c)),0,q));i=-t.acosClamped(l)-Math.max(0,s.length(n)-o)/(d*o)}else s.subtract(J,r.eye,r.center),s.cross(a,ze,J),i=-s.length(ze)/o;return s.normalize(a,a),s.scale(a,a,s.length(xe)),i}const J=l.create();function K(e,n,a,r){let o,c;const i=Math.cos(t.clamp(y.cyclicalPI.normalize(t.deg2rad(r)),0,q));return o=n>a?-(n-a)/(i*a):n<-a?Math.PI-(n+a)/(i*a):t.acosClamped(n/a),c=e>a?-(e-a)/(i*a):e<-a?Math.PI-(e+a)/(i*a):t.acosClamped(e/a),(c-o)*a}function Q(e,t,n,a,r,o,i,l,d,u){const m=K(e[2],t[2],i[3],d),p=u?K(e[0],t[0],i[3],180):t[0]-e[0],h=Math.sin(l)*p-Math.cos(l)*m,g=Math.cos(l)*p+Math.sin(l)*m;s.normalize(Ae,r);const y=u?h/Math.sqrt(Math.abs(i[3]**2-s.dot(n,Ae)**2)):h/i[3],f=g/Math.sqrt(Math.abs(i[3]**2-s.dot(n,a)**2));c.set(o,y,f)}function Y(e,t,n,a,r,o,c,i,l,d){s.cross(xe,e,t),u.coordinateSystemFromOneAxisAndNormalVector(o.up,o.eye,ue,me,pe),u.coordinateSystemFromOneAxisAndNormalVector([0,0,1],o.eye,se,le,de),s.copy(n,le),s.copy(a,se),s.normalize(n,n),s.scale(n,n,s.length(xe)),u.vectorCoordinates(e,s.normalize(me,me),s.normalize(pe,pe),s.normalize(ue,ue),he),u.vectorCoordinates(t,me,pe,ue,ge),Q(he,ge,e,se,le,r,c,i,l,d)}function $(e,t,n,a,o,c,i){r.identity(Me),r.identity(Pe),r.identity(ve),r.rotate(Me,Me,o,a),r.rotate(Pe,Pe,i,c),r.multiply(ve,Me,Pe),s.subtract(t,e,n),s.transformMat4(t,t,ve),s.add(t,t,n)}function ee(e,t,n,a,o,c){r.identity(Me),r.identity(Pe),r.identity(ve),r.rotate(Me,Me,a,n),r.rotate(Pe,Pe,c,o),r.multiply(ve,Me,Pe),s.subtract(Ae,e.eye,t),s.transformMat4(Ae,Ae,ve),e.eye=s.add(Ae,Ae,t),s.subtract(Ae,e.center,t),s.transformMat4(Ae,Ae,ve),e.center=s.add(Ae,Ae,t),s.subtract(Ae,e.up,t),s.transformMat4(Ae,Ae,ve),e.up=s.add(Ae,Ae,t)}function te(e,t,n,a,r,o,c=V.Pole,i=V.Angle){const s=Math.abs(a)>Math.PI-i||Math.abs(a)<i,l=Math.abs(e[2])<n*c||Math.abs(t)>n;return!!(s&&l&&o.aboveGround&&r<V.Tilt)}function ne(e,t,n,a,r,o){if(o)d.fromPoints(n,a,fe),I(t,e,fe);else{const o=B(n,a,Ie,t,e[3],r);I(t,e,d.wrapAxisAngle(Ie,o))}}function ae(e,t,n,a,r,o,c){const i=c?20:1,l=1e-12;let d,u;s.copy(be,a),Se.copyFrom(t);for(let m=0;m<i&&s.squaredDistance(n,be)>l&&(d=s.squaredDistance(n,be),Y(n,be,le,se,ye,Se,e,r,o,c),ee(Se,e,se,ye[1],le,ye[0]),$(be,be,e,se,ye[1],le,ye[0]),u=s.squaredDistance(n,be),u<d||0===m);m++)t.copyFrom(Se)}function re(e,n,a,r,o,c,i){te(a,s.dot(n.up,a),e[3],-y.cyclicalPI.normalize(t.deg2rad(o)),c,n,V.Pole,V.Angle)?ae(e,n,a,r,-y.cyclicalPI.normalize(t.deg2rad(o)),c,i):ne(e,n,a,r,c,i)}function oe(e,t,n,a,o,c){const{eye:i}=e;u.coordinateSystemFromOneAxisAndNormalVector([0,0,1],i,se,le,de);const l=t.translation[0]*n.pan,d="zoom"===o.mode?0:t.translation[1]*n.pan,m=Math.max(Math.sqrt(Math.abs(1-s.dot(e.center,se)**2/s.length(e.center)**2)),.5),p=(Math.sin(c)*d+Math.cos(c)*l)/m,h=-Math.cos(c)*d+Math.sin(c)*l;switch(r.rotate(a.pan.matrix,a.pan.matrix,p,se),a.pan.enabled=!0,o.mode){case"pan":r.rotate(a.pan.matrix,a.pan.matrix,h,le),a.pan.enabled=!0;break;case"zoom":a.zoom=-t.translation[1]*n.zoom}}function ce(e,t,n,a,o){const{eye:c,viewRight:i}=e,l=s.cross(g.sv3d.get(),i,c),d=t.translation[0]*n.pan;switch(0!==d&&(r.rotate(a.pan.matrix,a.pan.matrix,-d,l),a.pan.enabled=!0),o.mode){case"pan":{const e=t.translation[1]*n.pan;0!==e&&(r.rotate(a.pan.matrix,a.pan.matrix,e,i),a.pan.enabled=!0);break}case"zoom":a.zoom=-t.translation[1]*n.zoom}}function ie(e,n,a,r,o,c,i,l,d){te(e.center,s.dot(e.up,e.center),s.length(e.center),-y.cyclicalPI.normalize(t.deg2rad(c)),i,n)?oe(n,a,r,l,d,-y.cyclicalPI.normalize(t.deg2rad(o))):ce(n,a,r,l,d)}const se=l.create(),le=l.create(),de=l.create(),ue=l.create(),me=l.create(),pe=l.create(),he=l.create(),ge=l.create(),ye=i.create(),fe=d.create(),Me=o.create(),Pe=o.create(),ve=o.create(),be=l.create(),Ae=l.create(),ze=l.create(),Se=new P,xe=l.create(),Ie=l.create(),Te={origin:l.create(),direction:l.create()},Ee={origin:l.create(),direction:l.create()};e.DISTANCE_CLAMP_VALUES=b,e.PIVOT_DISTANCE_MODIFIER=v,e.PreservingHeadingThreshold=V,e.SCREEN_PIXEL_AREA=A,e.TiltThresholdPanningSpeed=q,e.VerticalPanTresholds=H,e.applyPanPlanar=U,e.applyPanSphericalDirectRotation=ne,e.applyPanSphericalPreserveHeading=ae,e.applyRotation=I,e.applyRotationWithTwoAxes=ee,e.applyZoomOnSphere=R,e.applyZoomToPoint=N,e.centroid=F,e.centroidOnSphere=C,e.decideNavigationMode=G,e.intersectPlaneFromScreenPoint=T,e.intersectPlaneFromScreenPointAtEye=E,e.lengthFromPoints=K,e.normalizeCoordinate=z,e.normalizeRotationDelta=x,e.offSurfaceTiltToEyeTiltGlobal=O,e.onSurfaceTiltToEyeTiltGlobal=D,e.panMotionToRotationMatrix=ie,e.panToPosition=re,e.pickPointAndInitSphere=_,e.preserveHeadingThreshold=te,e.rotatePointAroundTwoAxes=$,e.rotationAngleAndAxisDirectRotation=B,e.rotationAnglesAndAxesHeadingPreserving=Y,e.rotationAnglesHeadingPreserving=Q,e.rotationFromPointsAroundAxis=S,e.sphereOrPlanePointFromScreenPoint=W,Object.defineProperty(e,"__esModule",{value:!0})}));
