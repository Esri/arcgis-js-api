// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","../../../../core/mathUtils","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec2","../../../../core/libs/gl-matrix-2/vec2f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../geometry/support/geodesicConstants","../../support/geometryUtils","../../support/mathUtils","../../support/stack","../../support/geometryUtils/coordinateSystem","../../webgl-engine/lib/Camera"],(function(e,t,a,r,n,c,o,i,s,l,v,d,h,p,m,u){"use strict";function g(e,t,a){var r=p.sm4d.get();n.mat4.identity(r),n.mat4.rotate(r,r,a[3],d.axisAngle.axis(a)),s.vec3.subtract(e.eye,e.eye,t),s.vec3.transformMat4(e.eye,e.eye,r),s.vec3.add(e.eye,e.eye,t),s.vec3.subtract(e.center,e.center,t),s.vec3.transformMat4(e.center,e.center,r),s.vec3.add(e.center,e.center,t),s.vec3.transformMat4(e.up,e.up,r),e.markViewDirty()}Object.defineProperty(t,"__esModule",{value:!0}),t.panMotionToRotationMatrix=t.panToPosition=t.applyPanSphericalPreserveHeading=t.applyPanSphericalDirectRotation=t.preserveHeadingThreshold=t.applyRotationWithTwoAxes=t.rotatePointAroundTwoAxes=t.rotationAnglesAndAxesHeadingPreserving=t.rotationAnglesHeadingPreserving=t.lengthFromPoints=t.rotationAngleAndAxisDirectRotation=t.sphereOrPlanePointFromScreenPoint=t.applyPanPlanar=t.decidePanMode=t.pickPointAndInitSphere=t.TiltThresholdPanningSpeed=t.PreservingHeadingThreshold=t.VerticalPanTresholds=t.PanMode=t.offSurfaceTiltToEyeTiltGlobal=t.onSurfaceTiltToEyeTiltGlobal=t.centroid=t.centroidOnSphere=t.applyZoomOnSphere=t.applyZoomToPoint=t.intersectPlaneFromScreenPoint=t.applyRotation=t.normalizeRotationDelta=t.rotationFromPointsAroundAxis=t.normalizeCoordinate=t.Earth=void 0,t.Earth=d.sphere.fromValues(v.earthRadius,l.vec3f64.create()),t.normalizeCoordinate=function(e,t,a){return a[0]=t[0]/(e.fullWidth/e.pixelRatio),a[1]=t[1]/(e.fullHeight/e.pixelRatio),a},t.rotationFromPointsAroundAxis=function(e,t,a){var r=p.sv3d.get(),n=p.sv3d.get(),c=p.sv3d.get();s.vec3.copy(n,e),s.vec3.copy(c,t);var o=s.vec3.dot(n,a),i=s.vec3.dot(c,a);s.vec3.scale(r,a,o),s.vec3.subtract(n,n,r),s.vec3.normalize(n,n),s.vec3.scale(r,a,i),s.vec3.subtract(c,c,r),s.vec3.normalize(c,c);var l=s.vec3.dot(n,c);s.vec3.cross(r,a,n);var v=s.vec3.dot(c,r);return Math.atan2(v,l)},t.normalizeRotationDelta=function(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e},t.applyRotation=g,t.intersectPlaneFromScreenPoint=function(e,t,a,r){return d.plane.intersectRay(e,d.ray.fromScreen(t,a,ae),r)},t.applyZoomToPoint=function(e,t,a,r){var n=p.sv3d.get(),c=1-a;s.vec3.subtract(n,t,e.eye);var o=s.vec3.length(n),i=o*(1-c);c>=0&&i<r&&(c=-((i=r)-o)/o),Math.abs(o-i)<1e-6||(s.vec3.scale(n,n,c),s.vec3.add(e.eye,e.eye,n),s.vec3.lerp(e.center,e.center,t,c))},t.applyZoomOnSphere=function(e,t,a){t.getScreenCenter(y),d.sphere.intersectScreen(e,t,y,t.center),t.markViewDirty();var r=t.distance,n=r*a;if(!(Math.abs(r-n)<1e-6)){var c=s.vec3.scale(p.sv3d.get(),t.viewForward,n);s.vec3.subtract(t.eye,t.center,c),t.markViewDirty()}};var f,y=r.createScreenPointArray();function P(e,t){s.vec3.set(t,0,0,0);for(var a=0,r=e;a<r.length;a++){var n=r[a];s.vec3.add(t,t,n)}s.vec3.scale(t,t,1/e.length)}function M(e,t,a){return Math.sin(e/s.vec3.length(t))*(a+v.earthRadius)}t.centroidOnSphere=function(e,t,a){P(t,a),s.vec3.normalize(a,a),s.vec3.scale(a,a,e)},t.centroid=P,t.onSurfaceTiltToEyeTiltGlobal=M,t.offSurfaceTiltToEyeTiltGlobal=function(e,t,a){return M(Math.PI/2,t,a)+(e-Math.PI/2)},function(e){e[e.Vertical=0]="Vertical",e[e.Horizontal=1]="Horizontal"}(f=t.PanMode||(t.PanMode={})),t.VerticalPanTresholds={Elevation:3e4,Angle:a.deg2rad(8)},t.PreservingHeadingThreshold={Pole:.95,Angle:a.deg2rad(18),Tilt:45},t.TiltThresholdPanningSpeed=a.deg2rad(80),t.pickPointAndInitSphere=function(e,a,r,n){var c=l.vec3f64.create(),o=d.sphere.create(),i=!0;return e.intersectScreen(r,c)?o.radius=s.vec3.length(c):(a.aboveGround?o.radius=Math.max(s.vec3.length(a.center),.9*t.Earth.radius):o.radius=s.vec3.length(a.eye)-a.relativeElevation,n?T(o,a,r,c):i=d.sphere.intersectScreen(o,a,r,c)),{sphere:o,scenePickPoint:i?c:null}},t.decidePanMode=function(e,r,n){var c=s.vec3.length(e.eye),o=c-t.Earth.radius;if(Math.abs(o)>t.VerticalPanTresholds.Elevation)return f.Horizontal;var i=r.radius>c;return e.aboveGround===i?f.Vertical:(s.vec3.subtract(b,e.eye,n),s.vec3.normalize(b,b),Math.abs(.5*Math.PI-a.acosClamped(s.vec3.dot(n,b)/s.vec3.length(n)))<t.VerticalPanTresholds.Angle?f.Vertical:f.Horizontal)};var b=l.vec3f64.create();t.applyPanPlanar=function(e,t,a){s.vec3.subtract(A,a,t),s.vec3.subtract(e.eye,e.eye,A),s.vec3.subtract(e.center,e.center,A),e.markViewDirty()};var A=l.vec3f64.create();function T(e,t,a,r){var n=d.ray.fromScreenAtEye(t,a,ae);return d.sphere.closestPointOnSilhouette(e,n,x),d.sphere.intersectRay(e,n,r)?!(s.vec3.squaredDistance(x,n.origin)<s.vec3.squaredDistance(r,n.origin))||(s.vec3.copy(r,x),!1):(s.vec3.subtract(S,t.eye,t.center),s.vec3.normalize(S,S),d.plane.fromNormalAndOffset(S,-s.vec3.dot(s.vec3.normalize(S,S),x),z),d.plane.intersectRay(z,n,r),!1)}t.sphereOrPlanePointFromScreenPoint=T;var x=l.vec3f64.create(),S=l.vec3f64.create(),z=d.plane.create();function w(e,r,n,c,o,i){var l;if(s.vec3.cross(ee,e,r),s.vec3.subtract(Y,e,r),s.vec3.length(e)<=o||!c.aboveGround){s.vec3.cross(n,Y,c.eye);var v=s.vec3.dot(e,r)/(s.vec3.length(e)*s.vec3.length(r)),d=Math.cos(a.clamp(h.cyclicalPI.normalize(a.deg2rad(i)),0,t.TiltThresholdPanningSpeed));l=-a.acosClamped(v)-Math.max(0,s.vec3.length(r)-o)/(d*o)}else s.vec3.subtract(H,c.eye,c.center),s.vec3.cross(n,Y,H),l=-s.vec3.length(Y)/o;return s.vec3.normalize(n,n),s.vec3.scale(n,n,s.vec3.length(ee)),l}t.rotationAngleAndAxisDirectRotation=w;var H=l.vec3f64.create();function R(e,r,n,c){var o,i=Math.cos(a.clamp(h.cyclicalPI.normalize(a.deg2rad(c)),0,t.TiltThresholdPanningSpeed));return o=r>n?-(r-n)/(i*n):r<-n?Math.PI-(r+n)/(i*n):a.acosClamped(r/n),((e>n?-(e-n)/(i*n):e<-n?Math.PI-(e+n)/(i*n):a.acosClamped(e/n))-o)*n}function I(e,t,a,r,n,c,i,l,v,d){var h=R(e[2],t[2],i.radius,v),p=d?R(e[0],t[0],i.radius,180):t[0]-e[0],m=Math.sin(l)*p-Math.cos(l)*h,u=Math.cos(l)*p+Math.sin(l)*h;s.vec3.normalize(X,n);var g=d?m/Math.sqrt(Math.abs(Math.pow(i.radius,2)-Math.pow(s.vec3.dot(a,X),2))):m/i.radius,f=u/Math.sqrt(Math.abs(Math.pow(i.radius,2)-Math.pow(s.vec3.dot(a,r),2)));o.vec2.set(c,g,f)}function V(e,t,a,r,n,c,o,i,l,v){s.vec3.cross(ee,e,t),m.coordinateSystemFromOneAxisAndNormalVector(c.up,c.eye,U,N,Z),m.coordinateSystemFromOneAxisAndNormalVector([0,0,1],c.eye,C,q,G),s.vec3.copy(a,q),s.vec3.copy(r,C),s.vec3.normalize(a,a),s.vec3.scale(a,a,s.vec3.length(ee)),m.vectorCoordinates(e,s.vec3.normalize(N,N),s.vec3.normalize(Z,Z),s.vec3.normalize(U,U),W),m.vectorCoordinates(t,N,Z,U,_),I(W,_,e,C,q,n,o,i,l,v)}function D(e,t,a,r,c,o,i){n.mat4.identity(J),n.mat4.identity(K),n.mat4.identity(L),n.mat4.rotate(J,J,c,r),n.mat4.rotate(K,K,i,o),n.mat4.multiply(L,J,K),s.vec3.subtract(t,e,a),s.vec3.transformMat4(t,t,L),s.vec3.add(t,t,a)}function F(e,t,a,r,c,o){n.mat4.identity(J),n.mat4.identity(K),n.mat4.identity(L),n.mat4.rotate(J,J,r,a),n.mat4.rotate(K,K,o,c),n.mat4.multiply(L,J,K),s.vec3.subtract(e.eye,e.eye,t),s.vec3.transformMat4(e.eye,e.eye,L),s.vec3.add(e.eye,e.eye,t),s.vec3.subtract(e.center,e.center,t),s.vec3.transformMat4(e.center,e.center,L),s.vec3.add(e.center,e.center,t),s.vec3.subtract(e.up,e.up,t),s.vec3.transformMat4(e.up,e.up,L),s.vec3.add(e.up,e.up,t),e.markViewDirty()}function E(e,a,r,n,c,o,i,s){void 0===i&&(i=t.PreservingHeadingThreshold.Pole),void 0===s&&(s=t.PreservingHeadingThreshold.Angle);var l=Math.abs(n)>Math.PI-s||Math.abs(n)<s,v=Math.abs(e[2])<r*i||Math.abs(a)>r;return!!(l&&v&&o.aboveGround&&c<t.PreservingHeadingThreshold.Tilt)}function O(e,t,a,r,n,c){if(c)d.axisAngle.fromPoints(a,r,B),g(t,e.center,B);else{var o=w(a,r,te,t,e.radius,n);g(t,e.center,d.axisAngle.wrapAxisAngle(te,o))}}function k(e,t,a,r,n,c,o){var i,l=o?20:1;s.vec3.copy(Q,r),$.copyFrom(t);for(var v=0;v<l&&s.vec3.squaredDistance(a,Q)>1e-12&&(i=s.vec3.squaredDistance(a,Q),V(a,Q,q,C,j,$,e,n,c,o),F($,e.center,C,j[1],q,j[0]),D(Q,Q,e.center,C,j[1],q,j[0]),s.vec3.squaredDistance(a,Q)<i||0===v);v++)t.copyFrom($)}t.lengthFromPoints=R,t.rotationAnglesHeadingPreserving=I,t.rotationAnglesAndAxesHeadingPreserving=V,t.rotatePointAroundTwoAxes=D,t.applyRotationWithTwoAxes=F,t.preserveHeadingThreshold=E,t.applyPanSphericalDirectRotation=O,t.applyPanSphericalPreserveHeading=k,t.panToPosition=function(e,r,n,c,o,i,l){E(n,s.vec3.dot(r.up,n),e.radius,-h.cyclicalPI.normalize(a.deg2rad(o)),i,r,t.PreservingHeadingThreshold.Pole,t.PreservingHeadingThreshold.Angle)?k(e,r,n,c,-h.cyclicalPI.normalize(a.deg2rad(o)),i,l):O(e,r,n,c,i,l)},t.panMotionToRotationMatrix=function(e,t,r,c,o,i,l,v,d){E(e.center,s.vec3.dot(e.up,e.center),s.vec3.length(e.center),-h.cyclicalPI.normalize(a.deg2rad(i)),l,t)?function(e,t,a,r,c,o){var i=e.eye;m.coordinateSystemFromOneAxisAndNormalVector([0,0,1],i,C,q,G);var l=t.translation[0]*a.pan,v=t.translation[1]*a.pan,d=Math.max(Math.sqrt(Math.abs(1-Math.pow(s.vec3.dot(e.center,C),2)/Math.pow(s.vec3.length(e.center),2))),.5),h=(Math.sin(o)*v+Math.cos(o)*l)/d,p=-Math.cos(o)*v+Math.sin(o)*l;switch(n.mat4.rotate(r.pan.matrix,r.pan.matrix,h,C),r.pan.enabled=!0,c.mode){case"pan":n.mat4.rotate(r.pan.matrix,r.pan.matrix,p,q),r.pan.enabled=!0;break;case"zoom":r.zoom=-t.translation[1]*a.zoom}}(t,r,c,v,d,-h.cyclicalPI.normalize(a.deg2rad(o))):function(e,t,a,r,c){var o=e.eye,i=e.viewRight,l=s.vec3.cross(p.sv3d.get(),i,o),v=t.translation[0]*a.pan;switch(0!==v&&(n.mat4.rotate(r.pan.matrix,r.pan.matrix,-v,l),r.pan.enabled=!0),c.mode){case"pan":var d=t.translation[1]*a.pan;0!==d&&(n.mat4.rotate(r.pan.matrix,r.pan.matrix,d,i),r.pan.enabled=!0);break;case"zoom":r.zoom=-t.translation[1]*a.zoom}}(t,r,c,v,d)};var C=l.vec3f64.create(),q=l.vec3f64.create(),G=l.vec3f64.create(),U=l.vec3f64.create(),N=l.vec3f64.create(),Z=l.vec3f64.create(),W=l.vec3f64.create(),_=l.vec3f64.create(),j=i.vec2f64.create(),B=d.axisAngle.create(),J=c.mat4f64.create(),K=c.mat4f64.create(),L=c.mat4f64.create(),Q=l.vec3f64.create(),X=l.vec3f64.create(),Y=l.vec3f64.create(),$=new u.default,ee=l.vec3f64.create(),te=l.vec3f64.create(),ae={origin:l.vec3f64.create(),direction:l.vec3f64.create()}}));