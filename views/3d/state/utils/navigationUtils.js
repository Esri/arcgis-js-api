/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../core/Cyclical","../../../../core/mathUtils","../../../../core/maybe","../../../../core/screenUtils","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec2","../../../../chunks/vec2f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/support/axisAngle","../../../../geometry/support/coordinateSystem","../../../../geometry/support/plane","../../../../chunks/sphere","../../../../geometry/support/vector","../../../../geometry/support/vectorStacks","../../support/geometryUtils/ray","../../support/geometryUtils/sphere","../../webgl-engine/lib/Camera"],(function(e,t,n,a,o,r,c,i,s,l,d,u,m,h,p,g,f,y,P,M){"use strict";var b;e.SpherePickPointFallback=void 0,(b=e.SpherePickPointFallback||(e.SpherePickPointFallback={}))[b.Ellipsoid=0]="Ellipsoid",b[b.Silhouette=1]="Silhouette";const v=30,S=[1,3e8],A=70;function z(e,t,n){return n[0]=t[0]/(e.fullWidth/e.pixelRatio),n[1]=t[1]/(e.fullHeight/e.pixelRatio),n}function x(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e}function I(e,t,n){const o=r.fromRotation(f.sm4d.get(),n[3],u.axis(n));a.isNone(o)||r.exactEquals(o,c.IDENTITY)||(l.subtract(ve,e.eye,t),l.transformMat4(ve,ve,o),e.eye=l.add(ve,ve,t),l.subtract(ve,e.center,t),l.transformMat4(ve,ve,o),e.center=l.add(ve,ve,t),e.up=l.transformMat4(ve,e.up,o))}function T(e,t,n,a){return h.intersectRay(e,y.fromScreen(t,n,Ie),a)}function E(e,t,n,a){return h.intersectRay(e,y.fromScreenAtEye(t,n,Ie),a)}function k(e,t,n,a){const o=f.sv3d.get();let r=1-n;l.subtract(o,t,e.eye);const c=l.length(o);let i=c*(1-r);r>=0&&i<a&&(i=a,r=-(i-c)/c),Math.abs(c-i)<1e-6||(l.scale(o,o,r),e.eye=l.add(ve,e.eye,o),e.center=l.lerp(ve,e.center,t,r))}function R(e,t,n){t.getScreenCenter(N),P.intersectScreen(e,t,N,ve)&&(t.center=ve);const a=t.distance,o=a*n;if(Math.abs(a-o)<1e-6)return;const r=l.scale(f.sv3d.get(),t.viewForward,o);t.eye=l.subtract(ve,t.center,r)}const N=o.createScreenPointArray();function F(e,t){l.set(t,0,0,0);for(const n of e)l.add(t,t,n);l.scale(t,t,1/e.length)}function C(e,t,n,a){return Math.sin(e/l.length(t))*(n+a.radius)}function D(e,t,n,a){return C(Math.PI/2,t,n,a)+(e-Math.PI/2)}var w;e.NavigationMode=void 0,(w=e.NavigationMode||(e.NavigationMode={}))[w.Vertical=0]="Vertical",w[w.Horizontal=1]="Horizontal";const H={Elevation:3e4,Angle:n.deg2rad(6)},O={Pole:.95,Angle:n.deg2rad(18),Tilt:45},V=n.deg2rad(80);function q(t,n,a,o,r,c){const i=d.create(),s=p.create();let u=!0,m=!0;return t.intersectScreen(a,i,c)?s[3]=l.length(i):(m=!1,n.aboveGround&&r!==e.SpherePickPointFallback.Ellipsoid?s[3]=Math.max(l.length(n.center),.9*o.radius):s[3]=l.length(n.eye)-n.relativeElevation,r===e.SpherePickPointFallback.Silhouette?L(s,n,a,i):u=P.intersectScreen(s,n,a,i)),{sphere:s,scenePickPoint:u?i:null,hasGeometryIntersection:m}}function _(t,n,a,o){if(l.length(t.eye)-o.radius>H.Elevation)return e.NavigationMode.Horizontal;if(!a)return e.NavigationMode.Vertical;y.fromScreenAtEye(t,n,Te);return-Math.sign(t.relativeElevation)*(.5*Math.PI+g.angle(t.eye,Te.direction))<H.Angle?e.NavigationMode.Vertical:e.NavigationMode.Horizontal}function G(e,t,n){l.subtract(U,n,t),e.eye=l.subtract(ve,e.eye,U),e.center=l.subtract(ve,e.center,U)}const U=d.create();function L(e,t,n,o){const r=y.fromScreenAtEye(t,n,Ie);return!a.isNone(r)&&(p.closestPointOnSilhouette(e,r,W),p.intersectRay(e,r,o)?!(l.squaredDistance(W,r.origin)<l.squaredDistance(o,r.origin))||(l.copy(o,W),!1):(l.subtract(Z,t.eye,t.center),l.normalize(Z,Z),h.fromNormalAndOffset(Z,-l.dot(l.normalize(Z,Z),W),j),h.intersectRay(j,r,o),!1))}const W=d.create(),Z=d.create(),j=h.create();function X(e,a,o,r,c,i){let s=0;if(l.cross(ze,e,a),l.subtract(Se,e,a),l.length(e)<=c||!r.aboveGround){l.cross(o,Se,r.eye);const u=l.dot(e,a)/(l.length(e)*l.length(a));if(u<.9999)s=n.acosClamped(u);else{const t=l.length(l.cross(d.create(),e,a))/(l.length(e)*l.length(a));s=n.asinClamped(t)}const m=Math.cos(n.clamp(t.cyclicalPI.normalize(n.deg2rad(i)),0,V));s=-s-Math.max(0,l.length(a)-c)/(m*c)}else l.subtract(Y,r.eye,r.center),l.cross(o,Se,Y),s=-l.length(Se)/c;return l.normalize(o,o),l.scale(o,o,l.length(ze)),s}const Y=d.create();function B(e,a,o,r){let c,i;const s=Math.cos(n.clamp(t.cyclicalPI.normalize(n.deg2rad(r)),0,V));return c=a>o?-(a-o)/(s*o):a<-o?Math.PI-(a+o)/(s*o):n.acosClamped(a/o),i=e>o?-(e-o)/(s*o):e<-o?Math.PI-(e+o)/(s*o):n.acosClamped(e/o),(i-c)*o}function J(e,t,n,a,o,r,c,s,d,u){const m=B(e[2],t[2],r[3],s),h=d?B(e[0],t[0],r[3],180):t[0]-e[0],p=Math.sin(c)*h-Math.cos(c)*m,g=Math.cos(c)*h+Math.sin(c)*m;l.normalize(ve,o);const f=d?p/Math.sqrt(Math.abs(r[3]**2-l.dot(n,ve)**2)):p/r[3],y=g/Math.sqrt(Math.abs(r[3]**2-l.dot(n,a)**2));i.set(u,f,y)}function K(e,t,n,a,o,r,c,i,s,d){l.cross(ze,e,t),m.coordinateSystemFromOneAxisAndNormalVector(r.up,r.eye,de,ue,me),m.coordinateSystemFromOneAxisAndNormalVector([0,0,1],r.eye,ie,se,le),l.copy(n,se),l.copy(a,ie),l.normalize(n,n),l.scale(n,n,l.length(ze)),m.vectorCoordinates(e,l.normalize(ue,ue),l.normalize(me,me),l.normalize(de,de),he),m.vectorCoordinates(t,ue,me,de,pe),J(he,pe,e,ie,se,c,i,s,d,o)}function Q(e,t,n,a,o,c,i){r.fromRotation(ye,o,a),r.fromRotation(Pe,i,c),r.multiply(Me,ye,Pe),l.subtract(t,e,n),l.transformMat4(t,t,Me),l.add(t,t,n)}function $(e,t,n,a,o,c){r.fromRotation(ye,a,n),r.fromRotation(Pe,c,o),r.multiply(Me,ye,Pe),l.subtract(ve,e.eye,t),l.transformMat4(ve,ve,Me),e.eye=l.add(ve,ve,t),l.subtract(ve,e.center,t),l.transformMat4(ve,ve,Me),e.center=l.add(ve,ve,t),l.subtract(ve,e.up,t),l.transformMat4(ve,ve,Me),e.up=l.add(ve,ve,t)}function ee(e,t,n,a,o,r){return(Math.abs(a)>Math.PI-O.Angle||Math.abs(a)<O.Angle)&&(Math.abs(e[2])<n*O.Pole||Math.abs(t)>n)&&r.aboveGround&&o<O.Tilt}function te(e,t,n,a,o,r){if(r)u.fromPoints(n,a,fe),I(t,e,fe);else{const r=X(n,a,xe,t,e[3],o);I(t,e,u.wrapAxisAngle(xe,r))}}function ne(e,t,n,a,o,r,c){const i=c?20:1,s=1e-12;let d,u;l.copy(be,a),Ae.copyFrom(t);for(let m=0;m<i&&l.squaredDistance(n,be)>s&&(d=l.squaredDistance(n,be),K(n,be,se,ie,ge,Ae,e,o,r,c),$(Ae,e,ie,ge[1],se,ge[0]),Q(be,be,e,ie,ge[1],se,ge[0]),u=l.squaredDistance(n,be),u<d||0===m);m++)t.copyFrom(Ae)}function ae(e,a,o,r,c,i,s){ee(o,l.dot(a.up,o),e[3],-t.cyclicalPI.normalize(n.deg2rad(c)),i,a)?ne(e,a,o,r,-t.cyclicalPI.normalize(n.deg2rad(c)),i,s):te(e,a,o,r,i,s)}function oe(e,t,n,a,o,c){const{eye:i}=e;m.coordinateSystemFromOneAxisAndNormalVector([0,0,1],i,ie,se,le);const s=t.translation[0]*n.pan,d="zoom"===o.mode?0:t.translation[1]*n.pan,u=Math.max(Math.sqrt(Math.abs(1-l.dot(e.center,ie)**2/l.length(e.center)**2)),.5),h=(Math.sin(c)*d+Math.cos(c)*s)/u,p=-Math.cos(c)*d+Math.sin(c)*s;switch(r.rotate(a.pan.matrix,a.pan.matrix,h,ie),a.pan.enabled=!0,o.mode){case"pan":r.rotate(a.pan.matrix,a.pan.matrix,p,se),a.pan.enabled=!0;break;case"zoom":a.zoom=-t.translation[1]*n.zoom}}function re(e,t,n,a,o){const{eye:c,viewRight:i}=e,s=l.cross(f.sv3d.get(),i,c),d=t.translation[0]*n.pan;switch(0!==d&&(r.rotate(a.pan.matrix,a.pan.matrix,-d,s),a.pan.enabled=!0),o.mode){case"pan":{const e=t.translation[1]*n.pan;0!==e&&(r.rotate(a.pan.matrix,a.pan.matrix,e,i),a.pan.enabled=!0);break}case"zoom":a.zoom=-t.translation[1]*n.zoom}}function ce(e,a,o,r,c,i,s,d,u){ee(e.center,l.dot(e.up,e.center),l.length(e.center),-t.cyclicalPI.normalize(n.deg2rad(i)),s,a)?oe(a,o,r,d,u,-t.cyclicalPI.normalize(n.deg2rad(c))):re(a,o,r,d,u)}const ie=d.create(),se=d.create(),le=d.create(),de=d.create(),ue=d.create(),me=d.create(),he=d.create(),pe=d.create(),ge=s.create(),fe=u.create(),ye=c.create(),Pe=c.create(),Me=c.create(),be=d.create(),ve=d.create(),Se=d.create(),Ae=new M.Camera,ze=d.create(),xe=d.create(),Ie={origin:d.create(),direction:d.create()},Te={origin:d.create(),direction:d.create()};e.DISTANCE_CLAMP_VALUES=S,e.PIVOT_DISTANCE_MODIFIER=v,e.PreservingHeadingThreshold=O,e.SCREEN_PIXEL_AREA=A,e.TiltThresholdPanningSpeed=V,e.VerticalPanTresholds=H,e.applyPanPlanar=G,e.applyPanSphericalDirectRotation=te,e.applyPanSphericalPreserveHeading=ne,e.applyRotation=I,e.applyRotationWithTwoAxes=$,e.applyZoomOnSphere=R,e.applyZoomToPoint=k,e.centroid=F,e.decideNavigationMode=_,e.intersectPlaneFromScreenPoint=T,e.intersectPlaneFromScreenPointAtEye=E,e.lengthFromPoints=B,e.normalizeCoordinate=z,e.normalizeRotationDelta=x,e.offSurfaceTiltToEyeTiltGlobal=D,e.onSurfaceTiltToEyeTiltGlobal=C,e.panMotionToRotationMatrix=ce,e.panToPosition=ae,e.pickPointAndInitSphere=q,e.preserveHeadingThreshold=ee,e.rotatePointAroundTwoAxes=Q,e.rotationAngleAndAxisDirectRotation=X,e.rotationAnglesAndAxesHeadingPreserving=K,e.rotationAnglesHeadingPreserving=J,e.sphereOrPlanePointFromScreenPoint=L,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
