/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../core/maybe","../../../../core/mathUtils","../../../../core/screenUtils","../../../../chunks/vec3f64","../../../../chunks/vec3","../../support/mathUtils","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec2f64","../../../../chunks/vec2","../../support/stack","../../../../chunks/vector","../../support/geometryUtils","../../webgl-engine/lib/Camera","../../support/geometryUtils/coordinateSystem"],(function(e,t,a,n,r,o,i,c,s,l,d,u,p,h,m,y){"use strict";function g(e,t,a){const n=u.sm4d.get();c.identity(n),c.rotate(n,n,a[3],h.axisAngle.axis(a)),o.subtract(e.eye,e.eye,t),o.transformMat4(e.eye,e.eye,n),o.add(e.eye,e.eye,t),o.subtract(e.center,e.center,t),o.transformMat4(e.center,e.center,n),o.add(e.center,e.center,t),o.transformMat4(e.up,e.up,n),e.markViewDirty()}const f=n.createScreenPointArray();function M(e,t){o.set(t,0,0,0);for(const a of e)o.add(t,t,a);o.scale(t,t,1/e.length)}function P(e,t,a,n){return Math.sin(e/o.length(t))*(a+n.radius)}var b;(b=e.NavigationMode||(e.NavigationMode={}))[b.Vertical=0]="Vertical",b[b.Horizontal=1]="Horizontal";const v={Elevation:3e4,Angle:a.deg2rad(6)},A={Pole:.95,Angle:a.deg2rad(18),Tilt:45},x=a.deg2rad(80);const z=r.create();function S(e,a,n,r){const i=h.ray.fromScreenAtEye(a,n,re);return!t.isNone(i)&&(h.sphere.closestPointOnSilhouette(e,i,w),h.sphere.intersectRay(e,i,r)?!(o.squaredDistance(w,i.origin)<o.squaredDistance(r,i.origin))||(o.copy(r,w),!1):(o.subtract(I,a.eye,a.center),o.normalize(I,I),h.plane.fromNormalAndOffset(I,-o.dot(o.normalize(I,I),w),T),h.plane.intersectRay(T,i,r),!1))}const w=r.create(),I=r.create(),T=h.plane.create();function k(e,t,n,r,c,s){let l;if(o.cross(ae,e,t),o.subtract(ee,e,t),o.length(e)<=c||!r.aboveGround){o.cross(n,ee,r.eye);const d=o.dot(e,t)/(o.length(e)*o.length(t)),u=Math.cos(a.clamp(i.cyclicalPI.normalize(a.deg2rad(s)),0,x));l=-a.acosClamped(d)-Math.max(0,o.length(t)-c)/(u*c)}else o.subtract(D,r.eye,r.center),o.cross(n,ee,D),l=-o.length(ee)/c;return o.normalize(n,n),o.scale(n,n,o.length(ae)),l}const D=r.create();function V(e,t,n,r){let o,c;const s=Math.cos(a.clamp(i.cyclicalPI.normalize(a.deg2rad(r)),0,x));return o=t>n?-(t-n)/(s*n):t<-n?Math.PI-(t+n)/(s*n):a.acosClamped(t/n),c=e>n?-(e-n)/(s*n):e<-n?Math.PI-(e+n)/(s*n):a.acosClamped(e/n),(c-o)*n}function N(e,t,a,n,r,i,c,s,l,u){const p=V(e[2],t[2],c.radius,l),h=u?V(e[0],t[0],c.radius,180):t[0]-e[0],m=Math.sin(s)*h-Math.cos(s)*p,y=Math.cos(s)*h+Math.sin(s)*p;o.normalize($,r);const g=u?m/Math.sqrt(Math.abs(Math.pow(c.radius,2)-Math.pow(o.dot(a,$),2))):m/c.radius,f=y/Math.sqrt(Math.abs(Math.pow(c.radius,2)-Math.pow(o.dot(a,n),2)));d.set(i,g,f)}function R(e,t,a,n,r,i,c,s,l,d){o.cross(ae,e,t),y.coordinateSystemFromOneAxisAndNormalVector(i.up,i.eye,W,Z,_),y.coordinateSystemFromOneAxisAndNormalVector([0,0,1],i.eye,E,G,U),o.copy(a,G),o.copy(n,E),o.normalize(a,a),o.scale(a,a,o.length(ae)),y.vectorCoordinates(e,o.normalize(Z,Z),o.normalize(_,_),o.normalize(W,W),j),y.vectorCoordinates(t,Z,_,W,B),N(j,B,e,E,G,r,c,s,l,d)}function F(e,t,a,n,r,i,s){c.identity(L),c.identity(Q),c.identity(X),c.rotate(L,L,r,n),c.rotate(Q,Q,s,i),c.multiply(X,L,Q),o.subtract(t,e,a),o.transformMat4(t,t,X),o.add(t,t,a)}function H(e,t,a,n,r,i){c.identity(L),c.identity(Q),c.identity(X),c.rotate(L,L,n,a),c.rotate(Q,Q,i,r),c.multiply(X,L,Q),o.subtract(e.eye,e.eye,t),o.transformMat4(e.eye,e.eye,X),o.add(e.eye,e.eye,t),o.subtract(e.center,e.center,t),o.transformMat4(e.center,e.center,X),o.add(e.center,e.center,t),o.subtract(e.up,e.up,t),o.transformMat4(e.up,e.up,X),o.add(e.up,e.up,t),e.markViewDirty()}function O(e,t,a,n,r,o,i=A.Pole,c=A.Angle){const s=Math.abs(n)>Math.PI-c||Math.abs(n)<c,l=Math.abs(e[2])<a*i||Math.abs(t)>a;return!!(s&&l&&o.aboveGround&&r<A.Tilt)}function q(e,t,a,n,r,o){if(o)h.axisAngle.fromPoints(a,n,K),g(t,e.center,K);else{const o=k(a,n,ne,t,e.radius,r);g(t,e.center,h.axisAngle.wrapAxisAngle(ne,o))}}function C(e,t,a,n,r,i,c){const s=c?20:1;let l,d;o.copy(Y,n),te.copyFrom(t);for(let n=0;n<s&&o.squaredDistance(a,Y)>1e-12&&(l=o.squaredDistance(a,Y),R(a,Y,G,E,J,te,e,r,i,c),H(te,e.center,E,J[1],G,J[0]),F(Y,Y,e.center,E,J[1],G,J[0]),d=o.squaredDistance(a,Y),d<l||0===n);n++)t.copyFrom(te)}const E=r.create(),G=r.create(),U=r.create(),W=r.create(),Z=r.create(),_=r.create(),j=r.create(),B=r.create(),J=l.create(),K=h.axisAngle.create(),L=s.create(),Q=s.create(),X=s.create(),Y=r.create(),$=r.create(),ee=r.create(),te=new m,ae=r.create(),ne=r.create(),re={origin:r.create(),direction:r.create()},oe={origin:r.create(),direction:r.create()};e.PreservingHeadingThreshold=A,e.TiltThresholdPanningSpeed=x,e.VerticalPanTresholds=v,e.applyPanPlanar=function(e,t,a){o.subtract(z,a,t),o.subtract(e.eye,e.eye,z),o.subtract(e.center,e.center,z),e.markViewDirty()},e.applyPanSphericalDirectRotation=q,e.applyPanSphericalPreserveHeading=C,e.applyRotation=g,e.applyRotationWithTwoAxes=H,e.applyZoomOnSphere=function(e,t,a){t.getScreenCenter(f),h.sphere.intersectScreen(e,t,f,t.center),t.markViewDirty();const n=t.distance,r=n*a;if(Math.abs(n-r)<1e-6)return;const i=o.scale(u.sv3d.get(),t.viewForward,r);o.subtract(t.eye,t.center,i),t.markViewDirty()},e.applyZoomToPoint=function(e,t,a,n){const r=u.sv3d.get();let i=1-a;o.subtract(r,t,e.eye);const c=o.length(r);let s=c*(1-i);i>=0&&s<n&&(s=n,i=-(s-c)/c),Math.abs(c-s)<1e-6||(o.scale(r,r,i),o.add(e.eye,e.eye,r),o.lerp(e.center,e.center,t,i))},e.centroid=M,e.centroidOnSphere=function(e,t,a){M(t,a),o.normalize(a,a),o.scale(a,a,e)},e.decideNavigationMode=function(t,n,r,i){return o.length(t.eye)-i.radius>v.Elevation?e.NavigationMode.Horizontal:r?(h.ray.fromScreenAtEye(t,n,oe),-a.sign(t.relativeElevation)*(.5*Math.PI+p.angle(t.eye,oe.direction))<v.Angle?e.NavigationMode.Vertical:e.NavigationMode.Horizontal):e.NavigationMode.Vertical},e.intersectPlaneFromScreenPoint=function(e,t,a,n){return h.plane.intersectRay(e,h.ray.fromScreen(t,a,re),n)},e.lengthFromPoints=V,e.normalizeCoordinate=function(e,t,a){return a[0]=t[0]/(e.fullWidth/e.pixelRatio),a[1]=t[1]/(e.fullHeight/e.pixelRatio),a},e.normalizeRotationDelta=function(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e},e.offSurfaceTiltToEyeTiltGlobal=function(e,t,a,n){return P(Math.PI/2,t,a,n)+(e-Math.PI/2)},e.onSurfaceTiltToEyeTiltGlobal=P,e.panMotionToRotationMatrix=function(e,t,n,r,s,l,d,p,h){O(e.center,o.dot(e.up,e.center),o.length(e.center),-i.cyclicalPI.normalize(a.deg2rad(l)),d,t)?function(e,t,a,n,r,i){const{eye:s}=e;y.coordinateSystemFromOneAxisAndNormalVector([0,0,1],s,E,G,U);const l=t.translation[0]*a.pan,d=t.translation[1]*a.pan,u=Math.max(Math.sqrt(Math.abs(1-Math.pow(o.dot(e.center,E),2)/Math.pow(o.length(e.center),2))),.5),p=(Math.sin(i)*d+Math.cos(i)*l)/u,h=-Math.cos(i)*d+Math.sin(i)*l;switch(c.rotate(n.pan.matrix,n.pan.matrix,p,E),n.pan.enabled=!0,r.mode){case"pan":c.rotate(n.pan.matrix,n.pan.matrix,h,G),n.pan.enabled=!0;break;case"zoom":n.zoom=-t.translation[1]*a.zoom}}(t,n,r,p,h,-i.cyclicalPI.normalize(a.deg2rad(s))):function(e,t,a,n,r){const{eye:i,viewRight:s}=e,l=o.cross(u.sv3d.get(),s,i),d=t.translation[0]*a.pan;switch(0!==d&&(c.rotate(n.pan.matrix,n.pan.matrix,-d,l),n.pan.enabled=!0),r.mode){case"pan":{const e=t.translation[1]*a.pan;0!==e&&(c.rotate(n.pan.matrix,n.pan.matrix,e,s),n.pan.enabled=!0);break}case"zoom":n.zoom=-t.translation[1]*a.zoom}}(t,n,r,p,h)},e.panToPosition=function(e,t,n,r,c,s,l){O(n,o.dot(t.up,n),e.radius,-i.cyclicalPI.normalize(a.deg2rad(c)),s,t,A.Pole,A.Angle)?C(e,t,n,r,-i.cyclicalPI.normalize(a.deg2rad(c)),s,l):q(e,t,n,r,s,l)},e.pickPointAndInitSphere=function(e,t,a,n,i){const c=r.create(),s=h.sphere.create();let l=!0,d=!0;return e.intersectScreen(a,c)?s.radius=o.length(c):(d=!1,t.aboveGround?s.radius=Math.max(o.length(t.center),.9*i.radius):s.radius=o.length(t.eye)-t.relativeElevation,n?S(s,t,a,c):l=h.sphere.intersectScreen(s,t,a,c)),{sphere:s,scenePickPoint:l?c:null,hasGeometryIntersection:d}},e.preserveHeadingThreshold=O,e.rotatePointAroundTwoAxes=F,e.rotationAngleAndAxisDirectRotation=k,e.rotationAnglesAndAxesHeadingPreserving=R,e.rotationAnglesHeadingPreserving=N,e.rotationFromPointsAroundAxis=function(e,t,a){const n=u.sv3d.get(),r=u.sv3d.get(),i=u.sv3d.get();o.copy(r,e),o.copy(i,t);const c=o.dot(r,a),s=o.dot(i,a);o.scale(n,a,c),o.subtract(r,r,n),o.normalize(r,r),o.scale(n,a,s),o.subtract(i,i,n),o.normalize(i,i);const l=o.dot(r,i);o.cross(n,a,r);const d=o.dot(i,n);return Math.atan2(d,l)},e.sphereOrPlanePointFromScreenPoint=S,Object.defineProperty(e,"__esModule",{value:!0})}));
