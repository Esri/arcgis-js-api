/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../core/mathUtils","../../../../core/maybe","../../../../core/screenUtils","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec2","../../../../chunks/vec2f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/support/axisAngle","../../../../geometry/support/coordinateSystem","../../../../geometry/support/plane","../../../../chunks/sphere","../../../../geometry/support/vector","../../../../geometry/support/vectorStacks","../../support/mathUtils","../../support/geometryUtils/ray","../../support/geometryUtils/sphere","../../webgl-engine/lib/Camera"],(function(e,t,n,a,o,r,c,i,s,l,d,u,m,p,h,g,f,y,M,P){"use strict";const v=30,b=[1,3e8],A=70;function S(e,t,n){return n[0]=t[0]/(e.fullWidth/e.pixelRatio),n[1]=t[1]/(e.fullHeight/e.pixelRatio),n}function z(e,t,n){const a=g.sv3d.get(),o=g.sv3d.get(),r=g.sv3d.get();s.copy(o,e),s.copy(r,t);const c=s.dot(o,n),i=s.dot(r,n);s.scale(a,n,c),s.subtract(o,o,a),s.normalize(o,o),s.scale(a,n,i),s.subtract(r,r,a),s.normalize(r,r);const l=s.dot(o,r);s.cross(a,n,o);const d=s.dot(r,a);return Math.atan2(d,l)}function x(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e}function I(e,t,n){const a=o.fromRotation(g.sm4d.get(),n[3],d.axis(n));s.subtract(Ae,e.eye,t),s.transformMat4(Ae,Ae,a),e.eye=s.add(Ae,Ae,t),s.subtract(Ae,e.center,t),s.transformMat4(Ae,Ae,a),e.center=s.add(Ae,Ae,t),e.up=s.transformMat4(Ae,e.up,a)}function T(e,t,n,a){return m.intersectRay(e,y.fromScreen(t,n,Te),a)}function R(e,t,n,a){return m.intersectRay(e,y.fromScreenAtEye(t,n,Te),a)}function E(e,t,n,a){const o=g.sv3d.get();let r=1-n;s.subtract(o,t,e.eye);const c=s.length(o);let i=c*(1-r);r>=0&&i<a&&(i=a,r=-(i-c)/c),Math.abs(c-i)<1e-6||(s.scale(o,o,r),e.eye=s.add(Ae,e.eye,o),e.center=s.lerp(Ae,e.center,t,r))}function N(e,t,n){t.getScreenCenter(k),M.intersectScreen(e,t,k,Ae)&&(t.center=Ae);const a=t.distance,o=a*n;if(Math.abs(a-o)<1e-6)return;const r=s.scale(g.sv3d.get(),t.viewForward,o);t.eye=s.subtract(Ae,t.center,r)}const k=a.createScreenPointArray();function C(e,t,n){F(t,n),s.normalize(n,n),s.scale(n,n,e)}function F(e,t){s.set(t,0,0,0);for(const n of e)s.add(t,t,n);s.scale(t,t,1/e.length)}function D(e,t,n,a){return Math.sin(e/s.length(t))*(n+a.radius)}function O(e,t,n,a){return D(Math.PI/2,t,n,a)+(e-Math.PI/2)}var w;e.NavigationMode=void 0,(w=e.NavigationMode||(e.NavigationMode={}))[w.Vertical=0]="Vertical",w[w.Horizontal=1]="Horizontal";const H={Elevation:3e4,Angle:t.deg2rad(6)},V={Pole:.95,Angle:t.deg2rad(18),Tilt:45},q=t.deg2rad(80);function _(e,t,n,a,o){const r=l.create(),c=p.create();let i=!0,d=!0;return e.intersectScreen(n,r)?c[3]=s.length(r):(d=!1,t.aboveGround?c[3]=Math.max(s.length(t.center),.9*o.radius):c[3]=s.length(t.eye)-t.relativeElevation,a?W(c,t,n,r):i=M.intersectScreen(c,t,n,r)),{sphere:c,scenePickPoint:i?r:null,hasGeometryIntersection:d}}function G(t,n,a,o){if(s.length(t.eye)-o.radius>H.Elevation)return e.NavigationMode.Horizontal;if(!a)return e.NavigationMode.Vertical;y.fromScreenAtEye(t,n,Re);return-Math.sign(t.relativeElevation)*(.5*Math.PI+h.angle(t.eye,Re.direction))<H.Angle?e.NavigationMode.Vertical:e.NavigationMode.Horizontal}function U(e,t,n){s.subtract(L,n,t),e.eye=s.subtract(Ae,e.eye,L),e.center=s.subtract(Ae,e.center,L)}const L=l.create();function W(e,t,a,o){const r=y.fromScreenAtEye(t,a,Te);return!n.isNone(r)&&(p.closestPointOnSilhouette(e,r,Z),p.intersectRay(e,r,o)?!(s.squaredDistance(Z,r.origin)<s.squaredDistance(o,r.origin))||(s.copy(o,Z),!1):(s.subtract(j,t.eye,t.center),s.normalize(j,j),m.fromNormalAndOffset(j,-s.dot(s.normalize(j,j),Z),X),m.intersectRay(X,r,o),!1))}const Z=l.create(),j=l.create(),X=m.create();function B(e,n,a,o,r,c){let i;if(s.cross(xe,e,n),s.subtract(Se,e,n),s.length(e)<=r||!o.aboveGround){s.cross(a,Se,o.eye);const l=s.dot(e,n)/(s.length(e)*s.length(n)),d=Math.cos(t.clamp(f.cyclicalPI.normalize(t.deg2rad(c)),0,q));i=-t.acosClamped(l)-Math.max(0,s.length(n)-r)/(d*r)}else s.subtract(J,o.eye,o.center),s.cross(a,Se,J),i=-s.length(Se)/r;return s.normalize(a,a),s.scale(a,a,s.length(xe)),i}const J=l.create();function K(e,n,a,o){let r,c;const i=Math.cos(t.clamp(f.cyclicalPI.normalize(t.deg2rad(o)),0,q));return r=n>a?-(n-a)/(i*a):n<-a?Math.PI-(n+a)/(i*a):t.acosClamped(n/a),c=e>a?-(e-a)/(i*a):e<-a?Math.PI-(e+a)/(i*a):t.acosClamped(e/a),(c-r)*a}function Q(e,t,n,a,o,r,i,l,d,u){const m=K(e[2],t[2],i[3],d),p=u?K(e[0],t[0],i[3],180):t[0]-e[0],h=Math.sin(l)*p-Math.cos(l)*m,g=Math.cos(l)*p+Math.sin(l)*m;s.normalize(Ae,o);const f=u?h/Math.sqrt(Math.abs(i[3]**2-s.dot(n,Ae)**2)):h/i[3],y=g/Math.sqrt(Math.abs(i[3]**2-s.dot(n,a)**2));c.set(r,f,y)}function Y(e,t,n,a,o,r,c,i,l,d){s.cross(xe,e,t),u.coordinateSystemFromOneAxisAndNormalVector(r.up,r.eye,ue,me,pe),u.coordinateSystemFromOneAxisAndNormalVector([0,0,1],r.eye,se,le,de),s.copy(n,le),s.copy(a,se),s.normalize(n,n),s.scale(n,n,s.length(xe)),u.vectorCoordinates(e,s.normalize(me,me),s.normalize(pe,pe),s.normalize(ue,ue),he),u.vectorCoordinates(t,me,pe,ue,ge),Q(he,ge,e,se,le,o,c,i,l,d)}function $(e,t,n,a,r,c,i){o.fromRotation(Me,r,a),o.fromRotation(Pe,i,c),o.multiply(ve,Me,Pe),s.subtract(t,e,n),s.transformMat4(t,t,ve),s.add(t,t,n)}function ee(e,t,n,a,r,c){o.fromRotation(Me,a,n),o.fromRotation(Pe,c,r),o.multiply(ve,Me,Pe),s.subtract(Ae,e.eye,t),s.transformMat4(Ae,Ae,ve),e.eye=s.add(Ae,Ae,t),s.subtract(Ae,e.center,t),s.transformMat4(Ae,Ae,ve),e.center=s.add(Ae,Ae,t),s.subtract(Ae,e.up,t),s.transformMat4(Ae,Ae,ve),e.up=s.add(Ae,Ae,t)}function te(e,t,n,a,o,r,c=V.Pole,i=V.Angle){const s=Math.abs(a)>Math.PI-i||Math.abs(a)<i,l=Math.abs(e[2])<n*c||Math.abs(t)>n;return!!(s&&l&&r.aboveGround&&o<V.Tilt)}function ne(e,t,n,a,o,r){if(r)d.fromPoints(n,a,ye),I(t,e,ye);else{const r=B(n,a,Ie,t,e[3],o);I(t,e,d.wrapAxisAngle(Ie,r))}}function ae(e,t,n,a,o,r,c){const i=c?20:1,l=1e-12;let d,u;s.copy(be,a),ze.copyFrom(t);for(let m=0;m<i&&s.squaredDistance(n,be)>l&&(d=s.squaredDistance(n,be),Y(n,be,le,se,fe,ze,e,o,r,c),ee(ze,e,se,fe[1],le,fe[0]),$(be,be,e,se,fe[1],le,fe[0]),u=s.squaredDistance(n,be),u<d||0===m);m++)t.copyFrom(ze)}function oe(e,n,a,o,r,c,i){te(a,s.dot(n.up,a),e[3],-f.cyclicalPI.normalize(t.deg2rad(r)),c,n,V.Pole,V.Angle)?ae(e,n,a,o,-f.cyclicalPI.normalize(t.deg2rad(r)),c,i):ne(e,n,a,o,c,i)}function re(e,t,n,a,r,c){const{eye:i}=e;u.coordinateSystemFromOneAxisAndNormalVector([0,0,1],i,se,le,de);const l=t.translation[0]*n.pan,d="zoom"===r.mode?0:t.translation[1]*n.pan,m=Math.max(Math.sqrt(Math.abs(1-s.dot(e.center,se)**2/s.length(e.center)**2)),.5),p=(Math.sin(c)*d+Math.cos(c)*l)/m,h=-Math.cos(c)*d+Math.sin(c)*l;switch(o.rotate(a.pan.matrix,a.pan.matrix,p,se),a.pan.enabled=!0,r.mode){case"pan":o.rotate(a.pan.matrix,a.pan.matrix,h,le),a.pan.enabled=!0;break;case"zoom":a.zoom=-t.translation[1]*n.zoom}}function ce(e,t,n,a,r){const{eye:c,viewRight:i}=e,l=s.cross(g.sv3d.get(),i,c),d=t.translation[0]*n.pan;switch(0!==d&&(o.rotate(a.pan.matrix,a.pan.matrix,-d,l),a.pan.enabled=!0),r.mode){case"pan":{const e=t.translation[1]*n.pan;0!==e&&(o.rotate(a.pan.matrix,a.pan.matrix,e,i),a.pan.enabled=!0);break}case"zoom":a.zoom=-t.translation[1]*n.zoom}}function ie(e,n,a,o,r,c,i,l,d){te(e.center,s.dot(e.up,e.center),s.length(e.center),-f.cyclicalPI.normalize(t.deg2rad(c)),i,n)?re(n,a,o,l,d,-f.cyclicalPI.normalize(t.deg2rad(r))):ce(n,a,o,l,d)}const se=l.create(),le=l.create(),de=l.create(),ue=l.create(),me=l.create(),pe=l.create(),he=l.create(),ge=l.create(),fe=i.create(),ye=d.create(),Me=r.create(),Pe=r.create(),ve=r.create(),be=l.create(),Ae=l.create(),Se=l.create(),ze=new P.default,xe=l.create(),Ie=l.create(),Te={origin:l.create(),direction:l.create()},Re={origin:l.create(),direction:l.create()};e.DISTANCE_CLAMP_VALUES=b,e.PIVOT_DISTANCE_MODIFIER=v,e.PreservingHeadingThreshold=V,e.SCREEN_PIXEL_AREA=A,e.TiltThresholdPanningSpeed=q,e.VerticalPanTresholds=H,e.applyPanPlanar=U,e.applyPanSphericalDirectRotation=ne,e.applyPanSphericalPreserveHeading=ae,e.applyRotation=I,e.applyRotationWithTwoAxes=ee,e.applyZoomOnSphere=N,e.applyZoomToPoint=E,e.centroid=F,e.centroidOnSphere=C,e.decideNavigationMode=G,e.intersectPlaneFromScreenPoint=T,e.intersectPlaneFromScreenPointAtEye=R,e.lengthFromPoints=K,e.normalizeCoordinate=S,e.normalizeRotationDelta=x,e.offSurfaceTiltToEyeTiltGlobal=O,e.onSurfaceTiltToEyeTiltGlobal=D,e.panMotionToRotationMatrix=ie,e.panToPosition=oe,e.pickPointAndInitSphere=_,e.preserveHeadingThreshold=te,e.rotatePointAroundTwoAxes=$,e.rotationAngleAndAxisDirectRotation=B,e.rotationAnglesAndAxesHeadingPreserving=Y,e.rotationAnglesHeadingPreserving=Q,e.rotationFromPointsAroundAxis=z,e.sphereOrPlanePointFromScreenPoint=W,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
