/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../core/maybe","../../../../core/mathUtils","../../../../core/screenUtils","../../../../chunks/vec3f64","../../../../chunks/vec3","../../support/mathUtils","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec2f64","../../../../chunks/vec2","../../support/stack","../../../../chunks/vector","../../support/geometryUtils","../../webgl-engine/lib/Camera","../../support/geometryUtils/coordinateSystem"],(function(e,t,n,a,r,o,c,i,s,l,d,u,m,p,h,y){"use strict";function g(e,t,n){return n[0]=t[0]/(e.fullWidth/e.pixelRatio),n[1]=t[1]/(e.fullHeight/e.pixelRatio),n}function f(e,t,n){const a=u.sv3d.get(),r=u.sv3d.get(),c=u.sv3d.get();o.copy(r,e),o.copy(c,t);const i=o.dot(r,n),s=o.dot(c,n);o.scale(a,n,i),o.subtract(r,r,a),o.normalize(r,r),o.scale(a,n,s),o.subtract(c,c,a),o.normalize(c,c);const l=o.dot(r,c);o.cross(a,n,r);const d=o.dot(c,a);return Math.atan2(d,l)}function M(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e}function P(e,t,n){const a=u.sm4d.get();i.identity(a),i.rotate(a,a,n[3],p.axisAngle.axis(n)),o.subtract(e.eye,e.eye,t),o.transformMat4(e.eye,e.eye,a),o.add(e.eye,e.eye,t),o.subtract(e.center,e.center,t),o.transformMat4(e.center,e.center,a),o.add(e.center,e.center,t),o.transformMat4(e.up,e.up,a),e.markViewDirty()}function b(e,t,n,a){return p.plane.intersectRay(e,p.ray.fromScreen(t,n,Pe),a)}function v(e,t,n,a){const r=u.sv3d.get();let c=1-n;o.subtract(r,t,e.eye);const i=o.length(r);let s=i*(1-c);c>=0&&s<a&&(s=a,c=-(s-i)/i),Math.abs(i-s)<1e-6||(o.scale(r,r,c),o.add(e.eye,e.eye,r),o.lerp(e.center,e.center,t,c))}function A(e,t,n){t.getScreenCenter(z),p.sphere.intersectScreen(e,t,z,t.center),t.markViewDirty();const a=t.distance,r=a*n;if(Math.abs(a-r)<1e-6)return;const c=o.scale(u.sv3d.get(),t.viewForward,r);o.subtract(t.eye,t.center,c),t.markViewDirty()}const z=a.createScreenPointArray();function x(e,t,n){S(t,n),o.normalize(n,n),o.scale(n,n,e)}function S(e,t){o.set(t,0,0,0);for(const n of e)o.add(t,t,n);o.scale(t,t,1/e.length)}function I(e,t,n,a){return Math.sin(e/o.length(t))*(n+a.radius)}function T(e,t,n,a){return I(Math.PI/2,t,n,a)+(e-Math.PI/2)}var k;(k=e.NavigationMode||(e.NavigationMode={}))[k.Vertical=0]="Vertical",k[k.Horizontal=1]="Horizontal";const w={Elevation:3e4,Angle:n.deg2rad(6)},D={Pole:.95,Angle:n.deg2rad(18),Tilt:45},V=n.deg2rad(80);function N(e,t,n,a,c){const i=r.create(),s=p.sphere.create();let l=!0,d=!0;return e.intersectScreen(n,i)?s[3]=o.length(i):(d=!1,t.aboveGround?s[3]=Math.max(o.length(t.center),.9*c.radius):s[3]=o.length(t.eye)-t.relativeElevation,a?O(s,t,n,i):l=p.sphere.intersectScreen(s,t,n,i)),{sphere:s,scenePickPoint:l?i:null,hasGeometryIntersection:d}}function R(t,a,r,c){if(o.length(t.eye)-c.radius>w.Elevation)return e.NavigationMode.Horizontal;if(!r)return e.NavigationMode.Vertical;p.ray.fromScreenAtEye(t,a,be);return-n.sign(t.relativeElevation)*(.5*Math.PI+m.angle(t.eye,be.direction))<w.Angle?e.NavigationMode.Vertical:e.NavigationMode.Horizontal}function F(e,t,n){o.subtract(H,n,t),o.subtract(e.eye,e.eye,H),o.subtract(e.center,e.center,H),e.markViewDirty()}const H=r.create();function O(e,n,a,r){const c=p.ray.fromScreenAtEye(n,a,Pe);return!t.isNone(c)&&(p.sphere.closestPointOnSilhouette(e,c,q),p.sphere.intersectRay(e,c,r)?!(o.squaredDistance(q,c.origin)<o.squaredDistance(r,c.origin))||(o.copy(r,q),!1):(o.subtract(C,n.eye,n.center),o.normalize(C,C),p.plane.fromNormalAndOffset(C,-o.dot(o.normalize(C,C),q),E),p.plane.intersectRay(E,c,r),!1))}const q=r.create(),C=r.create(),E=p.plane.create();function G(e,t,a,r,i,s){let l;if(o.cross(fe,e,t),o.subtract(ye,e,t),o.length(e)<=i||!r.aboveGround){o.cross(a,ye,r.eye);const d=o.dot(e,t)/(o.length(e)*o.length(t)),u=Math.cos(n.clamp(c.cyclicalPI.normalize(n.deg2rad(s)),0,V));l=-n.acosClamped(d)-Math.max(0,o.length(t)-i)/(u*i)}else o.subtract(U,r.eye,r.center),o.cross(a,ye,U),l=-o.length(ye)/i;return o.normalize(a,a),o.scale(a,a,o.length(fe)),l}const U=r.create();function W(e,t,a,r){let o,i;const s=Math.cos(n.clamp(c.cyclicalPI.normalize(n.deg2rad(r)),0,V));return o=t>a?-(t-a)/(s*a):t<-a?Math.PI-(t+a)/(s*a):n.acosClamped(t/a),i=e>a?-(e-a)/(s*a):e<-a?Math.PI-(e+a)/(s*a):n.acosClamped(e/a),(i-o)*a}function Z(e,t,n,a,r,c,i,s,l,u){const m=W(e[2],t[2],i[3],l),p=u?W(e[0],t[0],i[3],180):t[0]-e[0],h=Math.sin(s)*p-Math.cos(s)*m,y=Math.cos(s)*p+Math.sin(s)*m;o.normalize(he,r);const g=u?h/Math.sqrt(Math.abs(i[3]**2-o.dot(n,he)**2)):h/i[3],f=y/Math.sqrt(Math.abs(i[3]**2-o.dot(n,a)**2));d.set(c,g,f)}function _(e,t,n,a,r,c,i,s,l,d){o.cross(fe,e,t),y.coordinateSystemFromOneAxisAndNormalVector(c.up,c.eye,ae,re,oe),y.coordinateSystemFromOneAxisAndNormalVector([0,0,1],c.eye,ee,te,ne),o.copy(n,te),o.copy(a,ee),o.normalize(n,n),o.scale(n,n,o.length(fe)),y.vectorCoordinates(e,o.normalize(re,re),o.normalize(oe,oe),o.normalize(ae,ae),ce),y.vectorCoordinates(t,re,oe,ae,ie),Z(ce,ie,e,ee,te,r,i,s,l,d)}function j(e,t,n,a,r,c,s){i.identity(de),i.identity(ue),i.identity(me),i.rotate(de,de,r,a),i.rotate(ue,ue,s,c),i.multiply(me,de,ue),o.subtract(t,e,n),o.transformMat4(t,t,me),o.add(t,t,n)}function B(e,t,n,a,r,c){i.identity(de),i.identity(ue),i.identity(me),i.rotate(de,de,a,n),i.rotate(ue,ue,c,r),i.multiply(me,de,ue),o.subtract(e.eye,e.eye,t),o.transformMat4(e.eye,e.eye,me),o.add(e.eye,e.eye,t),o.subtract(e.center,e.center,t),o.transformMat4(e.center,e.center,me),o.add(e.center,e.center,t),o.subtract(e.up,e.up,t),o.transformMat4(e.up,e.up,me),o.add(e.up,e.up,t),e.markViewDirty()}function J(e,t,n,a,r,o,c=D.Pole,i=D.Angle){const s=Math.abs(a)>Math.PI-i||Math.abs(a)<i,l=Math.abs(e[2])<n*c||Math.abs(t)>n;return!!(s&&l&&o.aboveGround&&r<D.Tilt)}function K(e,t,n,a,r,o){if(o)p.axisAngle.fromPoints(n,a,le),P(t,e,le);else{const o=G(n,a,Me,t,e[3],r);P(t,e,p.axisAngle.wrapAxisAngle(Me,o))}}function L(e,t,n,a,r,c,i){const s=i?20:1,l=1e-12;let d,u;o.copy(pe,a),ge.copyFrom(t);for(let m=0;m<s&&o.squaredDistance(n,pe)>l&&(d=o.squaredDistance(n,pe),_(n,pe,te,ee,se,ge,e,r,c,i),B(ge,e,ee,se[1],te,se[0]),j(pe,pe,e,ee,se[1],te,se[0]),u=o.squaredDistance(n,pe),u<d||0===m);m++)t.copyFrom(ge)}function Q(e,t,a,r,i,s,l){J(a,o.dot(t.up,a),e[3],-c.cyclicalPI.normalize(n.deg2rad(i)),s,t,D.Pole,D.Angle)?L(e,t,a,r,-c.cyclicalPI.normalize(n.deg2rad(i)),s,l):K(e,t,a,r,s,l)}function X(e,t,n,a,r,c){const{eye:s}=e;y.coordinateSystemFromOneAxisAndNormalVector([0,0,1],s,ee,te,ne);const l=t.translation[0]*n.pan,d="zoom"===r.mode?0:t.translation[1]*n.pan,u=Math.max(Math.sqrt(Math.abs(1-o.dot(e.center,ee)**2/o.length(e.center)**2)),.5),m=(Math.sin(c)*d+Math.cos(c)*l)/u,p=-Math.cos(c)*d+Math.sin(c)*l;switch(i.rotate(a.pan.matrix,a.pan.matrix,m,ee),a.pan.enabled=!0,r.mode){case"pan":i.rotate(a.pan.matrix,a.pan.matrix,p,te),a.pan.enabled=!0;break;case"zoom":a.zoom=-t.translation[1]*n.zoom}}function Y(e,t,n,a,r){const{eye:c,viewRight:s}=e,l=o.cross(u.sv3d.get(),s,c),d=t.translation[0]*n.pan;switch(0!==d&&(i.rotate(a.pan.matrix,a.pan.matrix,-d,l),a.pan.enabled=!0),r.mode){case"pan":{const e=t.translation[1]*n.pan;0!==e&&(i.rotate(a.pan.matrix,a.pan.matrix,e,s),a.pan.enabled=!0);break}case"zoom":a.zoom=-t.translation[1]*n.zoom}}function $(e,t,a,r,i,s,l,d,u){J(e.center,o.dot(e.up,e.center),o.length(e.center),-c.cyclicalPI.normalize(n.deg2rad(s)),l,t)?X(t,a,r,d,u,-c.cyclicalPI.normalize(n.deg2rad(i))):Y(t,a,r,d,u)}const ee=r.create(),te=r.create(),ne=r.create(),ae=r.create(),re=r.create(),oe=r.create(),ce=r.create(),ie=r.create(),se=l.create(),le=p.axisAngle.create(),de=s.create(),ue=s.create(),me=s.create(),pe=r.create(),he=r.create(),ye=r.create(),ge=new h,fe=r.create(),Me=r.create(),Pe={origin:r.create(),direction:r.create()},be={origin:r.create(),direction:r.create()};e.PreservingHeadingThreshold=D,e.TiltThresholdPanningSpeed=V,e.VerticalPanTresholds=w,e.applyPanPlanar=F,e.applyPanSphericalDirectRotation=K,e.applyPanSphericalPreserveHeading=L,e.applyRotation=P,e.applyRotationWithTwoAxes=B,e.applyZoomOnSphere=A,e.applyZoomToPoint=v,e.centroid=S,e.centroidOnSphere=x,e.decideNavigationMode=R,e.intersectPlaneFromScreenPoint=b,e.lengthFromPoints=W,e.normalizeCoordinate=g,e.normalizeRotationDelta=M,e.offSurfaceTiltToEyeTiltGlobal=T,e.onSurfaceTiltToEyeTiltGlobal=I,e.panMotionToRotationMatrix=$,e.panToPosition=Q,e.pickPointAndInitSphere=N,e.preserveHeadingThreshold=J,e.rotatePointAroundTwoAxes=j,e.rotationAngleAndAxisDirectRotation=G,e.rotationAnglesAndAxesHeadingPreserving=_,e.rotationAnglesHeadingPreserving=Z,e.rotationFromPointsAroundAxis=f,e.sphereOrPlanePointFromScreenPoint=O,Object.defineProperty(e,"__esModule",{value:!0})}));
