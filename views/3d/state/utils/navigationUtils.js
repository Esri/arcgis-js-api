/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../core/Cyclical","../../../../core/mathUtils","../../../../core/maybe","../../../../core/screenUtils","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec2","../../../../chunks/vec2f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/support/axisAngle","../../../../geometry/support/coordinateSystem","../../../../geometry/support/plane","../../../../chunks/sphere","../../../../geometry/support/vector","../../../../geometry/support/vectorStacks","../../support/geometryUtils/ray","../../support/geometryUtils/sphere","../../webgl-engine/lib/Camera","../../webgl-engine/lib/verticalOffsetUtils"],(function(e,t,n,a,o,r,c,i,s,l,d,u,m,h,p,g,f,M,y,P,I){"use strict";var A;e.SpherePickPointFallback=void 0,(A=e.SpherePickPointFallback||(e.SpherePickPointFallback={}))[A.Ellipsoid=0]="Ellipsoid",A[A.Silhouette=1]="Silhouette";const S=30,b=[1,3e8],E=80,T=8,v=200,R=1508e5,N=5,O=50,_=5,x=10,z=90,D={exclude:new Set([I.TERRAIN_ID])};function k(e,t,n){return n[0]=t[0]/(e.fullWidth/e.pixelRatio),n[1]=t[1]/(e.fullHeight/e.pixelRatio),n}function C(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e}function F(e,t,n){const o=r.fromRotation(f.sm4d.get(),n[3],u.axis(n));a.isNone(o)||r.exactEquals(o,c.IDENTITY)||(l.subtract(xe,e.eye,t),l.transformMat4(xe,xe,o),e.eye=l.add(xe,xe,t),l.subtract(xe,e.center,t),l.transformMat4(xe,xe,o),e.center=l.add(xe,xe,t),e.up=l.transformMat4(xe,e.up,o))}function w(e,t,n,a){return h.intersectRay(e,M.fromScreen(t,n,Fe),a)}function H(e,t,n,a){return h.intersectRay(e,M.fromScreenAtEye(t,n,Fe),a)}function V(e,t,n,a){const o=f.sv3d.get();let r=1-n;l.subtract(o,t,e.eye);const c=l.length(o);let i=c*(1-r);r>=0&&i<a&&(i=a,r=-(i-c)/c),Math.abs(c-i)<1e-6||(l.scale(o,o,r),e.eye=l.add(xe,e.eye,o),e.center=l.lerp(xe,e.center,t,r))}function q(e,t,n){t.getScreenCenter(G),y.intersectScreen(e,t,G,xe)&&(t.center=xe);const a=t.distance,o=a*n;if(Math.abs(a-o)<1e-6)return;const r=l.scale(f.sv3d.get(),t.viewForward,o);t.eye=l.subtract(xe,t.center,r)}const G=o.createScreenPointArray();function U(e,t){l.set(t,0,0,0);for(const n of e)l.add(t,t,n);l.scale(t,t,1/e.length)}function L(e,t,n,a){return Math.sin(e/l.length(t))*(n+a.radius)}function Z(e,t,n,a){return L(Math.PI/2,t,n,a)+(e-Math.PI/2)}var X;e.NavigationMode=void 0,(X=e.NavigationMode||(e.NavigationMode={}))[X.Vertical=0]="Vertical",X[X.Horizontal=1]="Horizontal";const W={Elevation:3e4,Angle:n.deg2rad(16)},j={Pole:.95,Angle:n.deg2rad(18),Tilt:45},Y=n.deg2rad(80);function B(t,n,a,o,r,c){const i=d.create(),s=p.create();let u=!0,m=!0;return t.intersectScreen(a,i,c)?s[3]=l.length(i):(m=!1,n.aboveGround&&r!==e.SpherePickPointFallback.Ellipsoid?s[3]=Math.max(l.length(n.center),.9*o.radius):s[3]=l.length(n.eye)-n.relativeElevation,r===e.SpherePickPointFallback.Silhouette?$(s,n,a,i):u=y.intersectScreen(s,n,a,i)),{sphere:s,scenePickPoint:u?i:null,hasGeometryIntersection:m}}function J(t,n,a){if(l.length(t.eye)-a.radius>W.Elevation)return e.NavigationMode.Horizontal;M.fromScreenAtEye(t,n,we);return-Math.sign(t.relativeElevation)*(.5*Math.PI+g.angle(t.eye,we.direction))<W.Angle?e.NavigationMode.Vertical:e.NavigationMode.Horizontal}function K(e,t,n){l.subtract(Q,n,t),e.eye=l.subtract(xe,e.eye,Q),e.center=l.subtract(xe,e.center,Q)}const Q=d.create();function $(e,t,n,o){const r=M.fromScreenAtEye(t,n,Fe);return!a.isNone(r)&&(p.closestPointOnSilhouette(e,r,ee),p.intersectRay(e,r,o)?!(l.squaredDistance(ee,r.origin)<l.squaredDistance(o,r.origin))||(l.copy(o,ee),!1):(l.subtract(te,t.eye,t.center),l.normalize(te,te),h.fromNormalAndOffset(te,-l.dot(l.normalize(te,te),ee),ne),h.intersectRay(ne,r,o),!1))}const ee=d.create(),te=d.create(),ne=h.create();function ae(e,a,o,r,c,i){let s=0;if(l.cross(ke,e,a),l.subtract(ze,e,a),l.length(e)<=c||!r.aboveGround){l.cross(o,ze,r.eye);const u=l.dot(e,a)/(l.length(e)*l.length(a));if(u<.9999)s=n.acosClamped(u);else{const t=l.length(l.cross(d.create(),e,a))/(l.length(e)*l.length(a));s=n.asinClamped(t)}const m=Math.cos(n.clamp(t.cyclicalPI.normalize(n.deg2rad(i)),0,Y));s=-s-Math.max(0,l.length(a)-c)/(m*c)}else l.subtract(oe,r.eye,r.center),l.cross(o,ze,oe),s=-l.length(ze)/c;return l.normalize(o,o),l.scale(o,o,l.length(ke)),s}const oe=d.create();function re(e,a,o,r){let c,i;const s=Math.cos(n.clamp(t.cyclicalPI.normalize(n.deg2rad(r)),0,Y));return c=a>o?-(a-o)/(s*o):a<-o?Math.PI-(a+o)/(s*o):n.acosClamped(a/o),i=e>o?-(e-o)/(s*o):e<-o?Math.PI-(e+o)/(s*o):n.acosClamped(e/o),(i-c)*o}function ce(e,t,n,a,o,r,c,s,d,u){const m=re(e[2],t[2],r[3],s),h=d?re(e[0],t[0],r[3],180):t[0]-e[0],p=Math.sin(c)*h-Math.cos(c)*m,g=Math.cos(c)*h+Math.sin(c)*m;l.normalize(xe,o);const f=d?p/Math.sqrt(Math.abs(r[3]**2-l.dot(n,xe)**2)):p/r[3],M=g/Math.sqrt(Math.abs(r[3]**2-l.dot(n,a)**2));i.set(u,f,M)}function ie(e,t,n,a,o,r,c,i,s,d){l.cross(ke,e,t),m.coordinateSystemFromOneAxisAndNormalVector(r.up,r.eye,Ie,Ae,Se),m.coordinateSystemFromOneAxisAndNormalVector([0,0,1],r.eye,Me,ye,Pe),l.copy(n,ye),l.copy(a,Me),l.normalize(n,n),l.scale(n,n,l.length(ke)),m.vectorCoordinates(e,l.normalize(Ae,Ae),l.normalize(Se,Se),l.normalize(Ie,Ie),be),m.vectorCoordinates(t,Ae,Se,Ie,Ee),ce(be,Ee,e,Me,ye,c,i,s,d,o)}function se(e,t,n,a,o,c,i){r.fromRotation(Re,o,a),r.fromRotation(Ne,i,c),r.multiply(Oe,Re,Ne),l.subtract(t,e,n),l.transformMat4(t,t,Oe),l.add(t,t,n)}function le(e,t,n,a,o,c){r.fromRotation(Re,a,n),r.fromRotation(Ne,c,o),r.multiply(Oe,Re,Ne),l.subtract(xe,e.eye,t),l.transformMat4(xe,xe,Oe),e.eye=l.add(xe,xe,t),l.subtract(xe,e.center,t),l.transformMat4(xe,xe,Oe),e.center=l.add(xe,xe,t),l.subtract(xe,e.up,t),l.transformMat4(xe,xe,Oe),e.up=l.add(xe,xe,t)}function de(e,t,n,a,o,r){return(Math.abs(a)>Math.PI-j.Angle||Math.abs(a)<j.Angle)&&(Math.abs(e[2])<n*j.Pole||Math.abs(t)>n)&&r.aboveGround&&o<j.Tilt}function ue(e,t,n,a,o,r){if(r)u.fromPoints(n,a,ve),F(t,e,ve);else{const r=ae(n,a,Ce,t,e[3],o);F(t,e,u.wrapAxisAngle(Ce,r))}}function me(e,t,n,a,o,r,c){const i=c?20:1,s=1e-12;let d,u;l.copy(_e,a),De.copyFrom(t);for(let m=0;m<i&&l.squaredDistance(n,_e)>s&&(d=l.squaredDistance(n,_e),ie(n,_e,ye,Me,Te,De,e,o,r,c),le(De,e,Me,Te[1],ye,Te[0]),se(_e,_e,e,Me,Te[1],ye,Te[0]),u=l.squaredDistance(n,_e),u<d||0===m);m++)t.copyFrom(De)}function he(e,a,o,r,c,i,s){de(o,l.dot(a.up,o),e[3],-t.cyclicalPI.normalize(n.deg2rad(c)),i,a)?me(e,a,o,r,-t.cyclicalPI.normalize(n.deg2rad(c)),i,s):ue(e,a,o,r,i,s)}function pe(e,t,n,a,o,c){const{eye:i}=e;m.coordinateSystemFromOneAxisAndNormalVector([0,0,1],i,Me,ye,Pe);const s=t.translation[0]*n.pan,d="zoom"===o.mode?0:t.translation[1]*n.pan,u=Math.max(Math.sqrt(Math.abs(1-l.dot(e.center,Me)**2/l.length(e.center)**2)),.5),h=(Math.sin(c)*d+Math.cos(c)*s)/u,p=-Math.cos(c)*d+Math.sin(c)*s;switch(r.rotate(a.pan.matrix,a.pan.matrix,h,Me),a.pan.enabled=!0,o.mode){case"pan":r.rotate(a.pan.matrix,a.pan.matrix,p,ye),a.pan.enabled=!0;break;case"zoom":a.zoom=-t.translation[1]*n.zoom}}function ge(e,t,n,a,o){const{eye:c,viewRight:i}=e,s=l.cross(f.sv3d.get(),i,c),d=t.translation[0]*n.pan;switch(0!==d&&(r.rotate(a.pan.matrix,a.pan.matrix,-d,s),a.pan.enabled=!0),o.mode){case"pan":{const e=t.translation[1]*n.pan;0!==e&&(r.rotate(a.pan.matrix,a.pan.matrix,e,i),a.pan.enabled=!0);break}case"zoom":a.zoom=-t.translation[1]*n.zoom}}function fe(e,a,o,r,c,i,s,d,u){de(e.center,l.dot(e.up,e.center),l.length(e.center),-t.cyclicalPI.normalize(n.deg2rad(i)),s,a)?pe(a,o,r,d,u,-t.cyclicalPI.normalize(n.deg2rad(c))):ge(a,o,r,d,u)}const Me=d.create(),ye=d.create(),Pe=d.create(),Ie=d.create(),Ae=d.create(),Se=d.create(),be=d.create(),Ee=d.create(),Te=s.create(),ve=u.create(),Re=c.create(),Ne=c.create(),Oe=c.create(),_e=d.create(),xe=d.create(),ze=d.create(),De=new P.Camera,ke=d.create(),Ce=d.create(),Fe={origin:d.create(),direction:d.create()},we={origin:d.create(),direction:d.create()};e.DISTANCE_CLAMP_VALUES=b,e.MIN_HEIGHT_LIMIT=O,e.PAN_DISTANCE_MODIFIER=N,e.PIVOT_DISTANCE_MODIFIER=S,e.PreservingHeadingThreshold=j,e.ROTATE_PIVOT_DISTANCE_MODIFIER=_,e.ROTATE_PIVOT_MIN_DISTANCE_MODIFIER=x,e.ROTATE_SCREEN_PIXEL_AREA=z,e.SCREEN_PIXEL_AREA=E,e.TiltThresholdPanningSpeed=Y,e.VerticalPanTresholds=W,e.ZOOM_DISTANCE_MODIFIER=T,e.ZOOM_MAX_DISTANCE_MODIFIER=R,e.ZOOM_MIN_DISTANCE_MODIFIER=v,e.applyPanPlanar=K,e.applyPanSphericalDirectRotation=ue,e.applyPanSphericalPreserveHeading=me,e.applyRotation=F,e.applyRotationWithTwoAxes=le,e.applyZoomOnSphere=q,e.applyZoomToPoint=V,e.centroid=U,e.contentIntersectorOptions=D,e.decideNavigationMode=J,e.intersectPlaneFromScreenPoint=w,e.intersectPlaneFromScreenPointAtEye=H,e.lengthFromPoints=re,e.normalizeCoordinate=k,e.normalizeRotationDelta=C,e.offSurfaceTiltToEyeTiltGlobal=Z,e.onSurfaceTiltToEyeTiltGlobal=L,e.panMotionToRotationMatrix=fe,e.panToPosition=he,e.pickPointAndInitSphere=B,e.preserveHeadingThreshold=de,e.rotatePointAroundTwoAxes=se,e.rotationAngleAndAxisDirectRotation=ae,e.rotationAnglesAndAxesHeadingPreserving=ie,e.rotationAnglesHeadingPreserving=ce,e.sphereOrPlanePointFromScreenPoint=$,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
