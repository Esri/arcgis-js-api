/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../../core/mathUtils","../../../../core/maybe","../../../../core/screenUtils","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec2","../../../../chunks/vec2f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/support/axisAngle","../../../../geometry/support/coordinateSystem","../../../../geometry/support/plane","../../../../chunks/sphere","../../../../geometry/support/vector","../../../../geometry/support/vectorStacks","../../support/mathUtils","../../support/geometryUtils/ray","../../support/geometryUtils/sphere","../../webgl-engine/lib/Camera"],(function(e,t,n,a,o,r,c,i,s,l,d,u,m,p,h,g,y,f,M,P){"use strict";function v(e,t,n){return n[0]=t[0]/(e.fullWidth/e.pixelRatio),n[1]=t[1]/(e.fullHeight/e.pixelRatio),n}function b(e,t,n){const a=g.sv3d.get(),o=g.sv3d.get(),r=g.sv3d.get();s.copy(o,e),s.copy(r,t);const c=s.dot(o,n),i=s.dot(r,n);s.scale(a,n,c),s.subtract(o,o,a),s.normalize(o,o),s.scale(a,n,i),s.subtract(r,r,a),s.normalize(r,r);const l=s.dot(o,r);s.cross(a,n,o);const d=s.dot(r,a);return Math.atan2(d,l)}function A(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e}function z(e,t,n){const a=g.sm4d.get();o.identity(a),o.rotate(a,a,n[3],d.axis(n)),s.subtract(Me,e.eye,t),s.transformMat4(Me,Me,a),e.eye=s.add(Me,Me,t),s.subtract(Me,e.center,t),s.transformMat4(Me,Me,a),e.center=s.add(Me,Me,t),e.up=s.transformMat4(Me,e.up,a)}function x(e,t,n,a){return m.intersectRay(e,f.fromScreen(t,n,ze),a)}function S(e,t,n,a){const o=g.sv3d.get();let r=1-n;s.subtract(o,t,e.eye);const c=s.length(o);let i=c*(1-r);r>=0&&i<a&&(i=a,r=-(i-c)/c),Math.abs(c-i)<1e-6||(s.scale(o,o,r),e.eye=s.add(Me,e.eye,o),e.center=s.lerp(Me,e.center,t,r))}function I(e,t,n){t.getScreenCenter(T),M.intersectScreen(e,t,T,Me)&&(t.center=Me);const a=t.distance,o=a*n;if(Math.abs(a-o)<1e-6)return;const r=s.scale(g.sv3d.get(),t.viewForward,o);t.eye=s.subtract(Me,t.center,r)}const T=a.createScreenPointArray();function N(e,t,n){k(t,n),s.normalize(n,n),s.scale(n,n,e)}function k(e,t){s.set(t,0,0,0);for(const n of e)s.add(t,t,n);s.scale(t,t,1/e.length)}function R(e,t,n,a){return Math.sin(e/s.length(t))*(n+a.radius)}function w(e,t,n,a){return R(Math.PI/2,t,n,a)+(e-Math.PI/2)}var F;e.NavigationMode=void 0,(F=e.NavigationMode||(e.NavigationMode={}))[F.Vertical=0]="Vertical",F[F.Horizontal=1]="Horizontal";const H={Elevation:3e4,Angle:t.deg2rad(6)},O={Pole:.95,Angle:t.deg2rad(18),Tilt:45},q=t.deg2rad(80);function C(e,t,n,a,o){const r=l.create(),c=p.create();let i=!0,d=!0;return e.intersectScreen(n,r)?c[3]=s.length(r):(d=!1,t.aboveGround?c[3]=Math.max(s.length(t.center),.9*o.radius):c[3]=s.length(t.eye)-t.relativeElevation,a?G(c,t,n,r):i=M.intersectScreen(c,t,n,r)),{sphere:c,scenePickPoint:i?r:null,hasGeometryIntersection:d}}function D(n,a,o,r){if(s.length(n.eye)-r.radius>H.Elevation)return e.NavigationMode.Horizontal;if(!o)return e.NavigationMode.Vertical;f.fromScreenAtEye(n,a,xe);return-t.sign(n.relativeElevation)*(.5*Math.PI+h.angle(n.eye,xe.direction))<H.Angle?e.NavigationMode.Vertical:e.NavigationMode.Horizontal}function E(e,t,n){s.subtract(V,n,t),e.eye=s.subtract(Me,e.eye,V),e.center=s.subtract(Me,e.center,V)}const V=l.create();function G(e,t,a,o){const r=f.fromScreenAtEye(t,a,ze);return!n.isNone(r)&&(p.closestPointOnSilhouette(e,r,U),p.intersectRay(e,r,o)?!(s.squaredDistance(U,r.origin)<s.squaredDistance(o,r.origin))||(s.copy(o,U),!1):(s.subtract(W,t.eye,t.center),s.normalize(W,W),m.fromNormalAndOffset(W,-s.dot(s.normalize(W,W),U),Z),m.intersectRay(Z,r,o),!1))}const U=l.create(),W=l.create(),Z=m.create();function _(e,n,a,o,r,c){let i;if(s.cross(be,e,n),s.subtract(Pe,e,n),s.length(e)<=r||!o.aboveGround){s.cross(a,Pe,o.eye);const l=s.dot(e,n)/(s.length(e)*s.length(n)),d=Math.cos(t.clamp(y.cyclicalPI.normalize(t.deg2rad(c)),0,q));i=-t.acosClamped(l)-Math.max(0,s.length(n)-r)/(d*r)}else s.subtract(j,o.eye,o.center),s.cross(a,Pe,j),i=-s.length(Pe)/r;return s.normalize(a,a),s.scale(a,a,s.length(be)),i}const j=l.create();function B(e,n,a,o){let r,c;const i=Math.cos(t.clamp(y.cyclicalPI.normalize(t.deg2rad(o)),0,q));return r=n>a?-(n-a)/(i*a):n<-a?Math.PI-(n+a)/(i*a):t.acosClamped(n/a),c=e>a?-(e-a)/(i*a):e<-a?Math.PI-(e+a)/(i*a):t.acosClamped(e/a),(c-r)*a}function J(e,t,n,a,o,r,i,l,d,u){const m=B(e[2],t[2],i[3],d),p=u?B(e[0],t[0],i[3],180):t[0]-e[0],h=Math.sin(l)*p-Math.cos(l)*m,g=Math.cos(l)*p+Math.sin(l)*m;s.normalize(Me,o);const y=u?h/Math.sqrt(Math.abs(i[3]**2-s.dot(n,Me)**2)):h/i[3],f=g/Math.sqrt(Math.abs(i[3]**2-s.dot(n,a)**2));c.set(r,y,f)}function K(e,t,n,a,o,r,c,i,l,d){s.cross(be,e,t),u.coordinateSystemFromOneAxisAndNormalVector(r.up,r.eye,ie,se,le),u.coordinateSystemFromOneAxisAndNormalVector([0,0,1],r.eye,oe,re,ce),s.copy(n,re),s.copy(a,oe),s.normalize(n,n),s.scale(n,n,s.length(be)),u.vectorCoordinates(e,s.normalize(se,se),s.normalize(le,le),s.normalize(ie,ie),de),u.vectorCoordinates(t,se,le,ie,ue),J(de,ue,e,oe,re,o,c,i,l,d)}function L(e,t,n,a,r,c,i){o.identity(he),o.identity(ge),o.identity(ye),o.rotate(he,he,r,a),o.rotate(ge,ge,i,c),o.multiply(ye,he,ge),s.subtract(t,e,n),s.transformMat4(t,t,ye),s.add(t,t,n)}function Q(e,t,n,a,r,c){o.identity(he),o.identity(ge),o.identity(ye),o.rotate(he,he,a,n),o.rotate(ge,ge,c,r),o.multiply(ye,he,ge),s.subtract(Me,e.eye,t),s.transformMat4(Me,Me,ye),e.eye=s.add(Me,Me,t),s.subtract(Me,e.center,t),s.transformMat4(Me,Me,ye),e.center=s.add(Me,Me,t),s.subtract(Me,e.up,t),s.transformMat4(Me,Me,ye),e.up=s.add(Me,Me,t)}function X(e,t,n,a,o,r,c=O.Pole,i=O.Angle){const s=Math.abs(a)>Math.PI-i||Math.abs(a)<i,l=Math.abs(e[2])<n*c||Math.abs(t)>n;return!!(s&&l&&r.aboveGround&&o<O.Tilt)}function Y(e,t,n,a,o,r){if(r)d.fromPoints(n,a,pe),z(t,e,pe);else{const r=_(n,a,Ae,t,e[3],o);z(t,e,d.wrapAxisAngle(Ae,r))}}function $(e,t,n,a,o,r,c){const i=c?20:1,l=1e-12;let d,u;s.copy(fe,a),ve.copyFrom(t);for(let m=0;m<i&&s.squaredDistance(n,fe)>l&&(d=s.squaredDistance(n,fe),K(n,fe,re,oe,me,ve,e,o,r,c),Q(ve,e,oe,me[1],re,me[0]),L(fe,fe,e,oe,me[1],re,me[0]),u=s.squaredDistance(n,fe),u<d||0===m);m++)t.copyFrom(ve)}function ee(e,n,a,o,r,c,i){X(a,s.dot(n.up,a),e[3],-y.cyclicalPI.normalize(t.deg2rad(r)),c,n,O.Pole,O.Angle)?$(e,n,a,o,-y.cyclicalPI.normalize(t.deg2rad(r)),c,i):Y(e,n,a,o,c,i)}function te(e,t,n,a,r,c){const{eye:i}=e;u.coordinateSystemFromOneAxisAndNormalVector([0,0,1],i,oe,re,ce);const l=t.translation[0]*n.pan,d="zoom"===r.mode?0:t.translation[1]*n.pan,m=Math.max(Math.sqrt(Math.abs(1-s.dot(e.center,oe)**2/s.length(e.center)**2)),.5),p=(Math.sin(c)*d+Math.cos(c)*l)/m,h=-Math.cos(c)*d+Math.sin(c)*l;switch(o.rotate(a.pan.matrix,a.pan.matrix,p,oe),a.pan.enabled=!0,r.mode){case"pan":o.rotate(a.pan.matrix,a.pan.matrix,h,re),a.pan.enabled=!0;break;case"zoom":a.zoom=-t.translation[1]*n.zoom}}function ne(e,t,n,a,r){const{eye:c,viewRight:i}=e,l=s.cross(g.sv3d.get(),i,c),d=t.translation[0]*n.pan;switch(0!==d&&(o.rotate(a.pan.matrix,a.pan.matrix,-d,l),a.pan.enabled=!0),r.mode){case"pan":{const e=t.translation[1]*n.pan;0!==e&&(o.rotate(a.pan.matrix,a.pan.matrix,e,i),a.pan.enabled=!0);break}case"zoom":a.zoom=-t.translation[1]*n.zoom}}function ae(e,n,a,o,r,c,i,l,d){X(e.center,s.dot(e.up,e.center),s.length(e.center),-y.cyclicalPI.normalize(t.deg2rad(c)),i,n)?te(n,a,o,l,d,-y.cyclicalPI.normalize(t.deg2rad(r))):ne(n,a,o,l,d)}const oe=l.create(),re=l.create(),ce=l.create(),ie=l.create(),se=l.create(),le=l.create(),de=l.create(),ue=l.create(),me=i.create(),pe=d.create(),he=r.create(),ge=r.create(),ye=r.create(),fe=l.create(),Me=l.create(),Pe=l.create(),ve=new P,be=l.create(),Ae=l.create(),ze={origin:l.create(),direction:l.create()},xe={origin:l.create(),direction:l.create()};e.PreservingHeadingThreshold=O,e.TiltThresholdPanningSpeed=q,e.VerticalPanTresholds=H,e.applyPanPlanar=E,e.applyPanSphericalDirectRotation=Y,e.applyPanSphericalPreserveHeading=$,e.applyRotation=z,e.applyRotationWithTwoAxes=Q,e.applyZoomOnSphere=I,e.applyZoomToPoint=S,e.centroid=k,e.centroidOnSphere=N,e.decideNavigationMode=D,e.intersectPlaneFromScreenPoint=x,e.lengthFromPoints=B,e.normalizeCoordinate=v,e.normalizeRotationDelta=A,e.offSurfaceTiltToEyeTiltGlobal=w,e.onSurfaceTiltToEyeTiltGlobal=R,e.panMotionToRotationMatrix=ae,e.panToPosition=ee,e.pickPointAndInitSphere=C,e.preserveHeadingThreshold=X,e.rotatePointAroundTwoAxes=L,e.rotationAngleAndAxisDirectRotation=_,e.rotationAnglesAndAxesHeadingPreserving=K,e.rotationAnglesHeadingPreserving=J,e.rotationFromPointsAroundAxis=b,e.sphereOrPlanePointFromScreenPoint=G,Object.defineProperty(e,"__esModule",{value:!0})}));
