/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/maybe","../../../core/time","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec3","../../../chunks/vec3f32","../../../chunks/vec3f64","../../../geometry/projectionEllipsoid","../../../chunks/Precipitation.glsl","./PrecipitationTechnique","../support/buffer/glUtil","../support/buffer/InterleavedLayout","../webgl-engine/core/shaderLibrary/util/View.glsl","../webgl-engine/lib/AnimationTimer","../webgl-engine/lib/VertexAttribute","../../support/WatchUpdatingTracking","../../webgl/BufferObject","../../webgl/enums","../../webgl/Util","../../webgl/VertexArrayObject"],(function(e,t,i,r,n,o,s,a,c,h,u,p,_,l,d,f,y,m,g,T,w,b,P,v,A,q,I){"use strict";e.Precipitation=function(e){function i(t){var i;return(i=e.call(this,t)||this)._numParticles=25e4,i._rainSpeed=.1,i._snowSpeed=.01,i._opacity=1,i._width=500,i._offset=l.create(),i._tile=l.create(),i._particleColor=_.create(),i._particleColorAtNight=_.create(),i._nightMultiplier=.7,i._cameraDirection=_.create(),i._renderParameters={camera:null,time:0,radius:1},i._animation=new w.AnimationTimer,i._updatingTracking=new P.WatchUpdatingTracking,i._renderParameters.time=0,i._renderParameters.radius=d.getReferenceEllipsoid(t.view.spatialReference).radius,i._shaderTechniqueRepository=t.context.shaderTechniqueRepository,i}t._inheritsLoose(i,e);var r=i.prototype;return r.destroy=function(){this._updatingTracking.destroy(),this._numParticles=0,this._snowTechnique=n.releaseMaybe(this._snowTechnique),this._rainTechnique=n.releaseMaybe(this._rainTechnique),this._vao=n.disposeMaybe(this._vao),this._instanceIdBuffer=n.disposeMaybe(this._instanceIdBuffer)},r.update=function(e){return this._animation.advance(e)},r.render=function(e,t,i){const{rctx:r,camera:s}=e;this._ensureResources(r);const a=i===f.PrecipitationType.RAIN?this.rainTechnique:this.snowTechnique;if(n.isNone(a)||n.isNone(this._vao)||n.isNone(this._instanceIdBuffer))return;if(n.isSome(e.cloudsCompositionParams)&&(this._opacity=1-e.cloudsCompositionParams.fadeInOutHeight.factor),this._opacity<=0)return;const c=r.useTechnique(a);this._renderParameters.camera=s,this._renderParameters.time=(i===f.PrecipitationType.RAIN?this._rainSpeed:this._snowSpeed)*o.secondsFromMilliseconds(this._animation.time),this._update(c,s,i,e),r.bindVAO(this._vao);const h=y.PrecipitationTechnique.attributeLocation;c.assertCompatibleVertexAttributeLocations(this._vao),q.bindVertexBufferLayout(r,h,this._instanceIdBuffer,C,0),r.capabilities.instancing.drawArraysInstanced(A.PrimitiveType.TRIANGLES,0,3,this._numParticles*t),q.unbindVertexBufferLayout(r,h,this._instanceIdBuffer,C)},r._update=function(e,t,i,r){const n=t.eye;this._tile[0]=Math.floor((n[0]+.5*this._width)/this._width),this._tile[1]=Math.floor((n[1]+.5*this._width)/this._width),this._tile[2]=Math.floor((n[2]+.5*this._width)/this._width),this._offset[0]=n[0]-this._tile[0]*this._width,this._offset[1]=n[1]-this._tile[1]*this._width,this._offset[2]=n[2]-this._tile[2]*this._width,e.setUniform1f("width",this._width),e.setUniform3fv("offset",this._offset),e.setUniformMatrix4fv("view",t.viewMatrix),e.setUniform3fv("cameraPosition",n),T.bindProjectionMatrix(e,t.projectionMatrix),e.setUniform1f("time",this._renderParameters.time),i===f.PrecipitationType.RAIN?p.set(this._particleColor,.85,.85,.85):p.set(this._particleColor,1,1,1),p.scale(this._particleColorAtNight,this._particleColor,this._nightMultiplier),p.normalize(this._cameraDirection,n);const o=Math.max(0,p.dot(this._cameraDirection,r.scenelightingData.lightingMainDirection));p.lerp(this._particleColor,this._particleColorAtNight,this._particleColor,o),e.setUniform3fv("particleColor",this._particleColor),e.setUniform1f("opacity",this._opacity)},r._ensureResources=function(e){n.isSome(this._vao)||(this._vao=this._createVertexArrayObject(e),n.isSome(this._instanceIdBuffer)||(this._instanceIdBuffer=this._createInstanceIndices(e)))},r._createInstanceIndices=function(e){const t=[];for(let i=0;i<this._numParticles;i++)t.push(i);return v.BufferObject.createVertex(e,A.Usage.STATIC_DRAW,new Float32Array(t))},r._createVertexArrayObject=function(e){const t=new Float32Array([-1,0,1,1,0,-1,1,0,1]);return new I.VertexArrayObject(e,y.PrecipitationTechnique.attributeLocation,{geometry:m.glLayout(x)},{geometry:v.BufferObject.createVertex(e,A.Usage.STATIC_DRAW,t)})},t._createClass(i,[{key:"updating",get:function(){return this._updatingTracking.updating}},{key:"rainTechnique",get:function(){if(n.isNone(this._rainTechnique)){const e=new y.PrecipitationTechniqueConfiguration;e.type=f.PrecipitationType.RAIN,this._rainTechnique=this._shaderTechniqueRepository.acquire(y.PrecipitationTechnique,e)}return this._rainTechnique}},{key:"snowTechnique",get:function(){if(n.isNone(this._snowTechnique)){const e=new y.PrecipitationTechniqueConfiguration;e.type=f.PrecipitationType.SNOW,this._snowTechnique=this._shaderTechniqueRepository.acquire(y.PrecipitationTechnique,e)}return this._snowTechnique}}]),i}(r),i.__decorate([s.property({constructOnly:!0})],e.Precipitation.prototype,"context",void 0),i.__decorate([s.property({constructOnly:!0})],e.Precipitation.prototype,"view",void 0),i.__decorate([s.property({readOnly:!0})],e.Precipitation.prototype,"updating",null),i.__decorate([s.property()],e.Precipitation.prototype,"_updatingTracking",void 0),e.Precipitation=i.__decorate([u.subclass("esri.views.3d.environment.Precipitation")],e.Precipitation);const x=g.newLayout().vec3f(b.VertexAttribute.POSITION),C=m.glLayout(g.newLayout().f32(b.VertexAttribute.INSTANCEFEATUREATTRIBUTE),1);Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
