/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/mathUtils","../../../core/maybe","../../../core/time","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../../core/support/WatchUpdatingTracking","../../../geometry/projectionEllipsoid","./PrecipitationTechnique","./PrecipitationTechniqueConfiguration","../support/buffer/glUtil","../support/buffer/InterleavedLayout","../webgl-engine/lib/AnimationTimer","../webgl-engine/lib/VertexArrayObject","../webgl-engine/lib/VertexAttribute","../../webgl/BufferObject","../../webgl/enums","../../webgl/Util"],(function(e,t,i,r,n,a,s,o,c,u,p,h,d,_,l,f,y,T,b,g,m,P,w){"use strict";e.Precipitation=function(e){function i(t){var i;return(i=e.call(this,t)||this)._numParticles=25e4,i._rainSpeed=.1,i._snowSpeed=.01,i._passParameters=new _.PrecipitationPassParameters,i._animation=new T.AnimationTimer,i._updatingTracking=new h.WatchUpdatingTracking,i._passParameters.time=0,i._passParameters.radius=d.getReferenceEllipsoid(t.view.spatialReference).radius,i._shaderTechniqueRepository=t.context.shaderTechniqueRepository,i}t._inheritsLoose(i,e);var r=i.prototype;return r.destroy=function(){this._updatingTracking.destroy(),this._numParticles=0,this._snowTechniqueCached=a.releaseMaybe(this._snowTechniqueCached),this._rainTechniqueCached=a.releaseMaybe(this._rainTechniqueCached),this._vao=a.disposeMaybe(this._vao),this._instanceIdBuffer=a.disposeMaybe(this._instanceIdBuffer)},r.update=function(e){return this._animation.advance(e)},r.render=function(e,t,i){const r="rainy"===i?this._rainTechnique:this._snowTechnique;if(!r.compiled)return void this.context.requestRender();const o=e.rctx;if(this._ensureResources(o),a.isNone(r)||a.isNone(this._vao)||a.isNone(this._instanceIdBuffer))return;if(a.isSome(e.bindParameters.cloudsFade.data)&&(this._passParameters.opacity=1-e.bindParameters.cloudsFade.fadeInOutHeight.factor),this._passParameters.opacity<=0)return;const c=.35;t=t<.5?n.lerp(0,c,2*t):n.lerp(c,1,2*(t-.5)),this._passParameters.time=("rainy"===i?this._rainSpeed:this._snowSpeed)*s.secondsFromMilliseconds(this._animation.time)%1e5;const u=o.bindTechnique(r,this._passParameters,e.bindParameters);o.bindVAO(this._vao),u.assertCompatibleVertexAttributeLocations(this._vao),w.bindVertexBufferLayout(o,_.attributeLocations,this._instanceIdBuffer,v,0),o.capabilities.instancing.drawArraysInstanced(P.PrimitiveType.TRIANGLES,0,3,this._numParticles*t),w.unbindVertexBufferLayout(o,_.attributeLocations,this._instanceIdBuffer,v)},r._ensureResources=function(e){a.isNone(this._vao)&&(this._vao=this._createVertexArrayObject(e)),a.isNone(this._instanceIdBuffer)&&(this._instanceIdBuffer=this._createInstanceIndices(e))},r._createInstanceIndices=function(e){const t=[];for(let i=0;i<this._numParticles;i++)t.push(i);return m.BufferObject.createVertex(e,P.Usage.STATIC_DRAW,new Float32Array(t))},r._createVertexArrayObject=function(e){const t=new Float32Array([-1,0,1,1,0,-1,1,0,1]);return new b.VertexArrayObject(e,_.attributeLocations,{geometry:f.glLayout(q)},{geometry:m.BufferObject.createVertex(e,P.Usage.STATIC_DRAW,t)})},t._createClass(i,[{key:"updating",get:function(){return this._updatingTracking.updating}},{key:"_rainTechnique",get:function(){if(a.isNone(this._rainTechniqueCached)){const e=new l.PrecipitationTechniqueConfiguration;e.type=l.PrecipitationType.Rain,this._rainTechniqueCached=this._shaderTechniqueRepository.acquire(_.PrecipitationTechnique,e)}return this._rainTechniqueCached}},{key:"_snowTechnique",get:function(){if(a.isNone(this._snowTechniqueCached)){const e=new l.PrecipitationTechniqueConfiguration;e.type=l.PrecipitationType.Snow,this._snowTechniqueCached=this._shaderTechniqueRepository.acquire(_.PrecipitationTechnique,e)}return this._snowTechniqueCached}}]),i}(r),i.__decorate([o.property({constructOnly:!0})],e.Precipitation.prototype,"context",void 0),i.__decorate([o.property({constructOnly:!0})],e.Precipitation.prototype,"view",void 0),i.__decorate([o.property({readOnly:!0})],e.Precipitation.prototype,"updating",null),i.__decorate([o.property()],e.Precipitation.prototype,"_updatingTracking",void 0),e.Precipitation=i.__decorate([p.subclass("esri.views.3d.environment.Precipitation")],e.Precipitation);const q=y.newLayout().vec3f(g.VertexAttribute.POSITION),v=f.glLayout(y.newLayout().f32(g.VertexAttribute.INSTANCEFEATUREATTRIBUTE),1);Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
