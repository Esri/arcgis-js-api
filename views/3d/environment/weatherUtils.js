/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../core/mathUtils","../../../chunks/mat4","../../../chunks/vec3","../../../chunks/vec3f64","../../../chunks/mat4f64","../../../geometry/support/axisAngleDegrees","../../../geometry/support/Ellipsoid","./CloudsCompositionParameters","./CloudsData","./weather","../../support/RenderState"],(function(e,a,t,n,s,r,d,o,g,i,c,I){"use strict";function u(e,t,s){const r=e.parallax.anchorPointClouds;e.fadeIn.stage===g.FadeInStages.FINISHED&&(e.fadeIn.factor=0,n.copy(r,C),e.fadeIn.stage=g.FadeInStages.CHANGE_ANCHOR,e.crossFade.enabled=!1,e.fadeInOut.stage=g.FadeInOutStages.FINISHED),e.fadeIn.stage===g.FadeInStages.CHANGE_ANCHOR&&e.isCameraPositionFinal&&(i.ensureClouds(e.data)&&e.renderingStage!==i.CloudsRenderingStages.RENDERING||e.renderingStage===i.CloudsRenderingStages.FADING_TEXTURE_CHANNELS)&&(n.copy(r,C),e.fadeIn.stage=g.FadeInStages.FADE_IN,e.startTime=t,e.renderingStage===i.CloudsRenderingStages.FADING_TEXTURE_CHANNELS&&(e.renderingStage=i.CloudsRenderingStages.SWITCH_CHANNELS)),e.fadeIn.factor<1&&e.fadeIn.stage===g.FadeInStages.FADE_IN?e.fadeIn.factor=s?a.clamp((t-e.startTime)/(T*s),0,1):1:e.fadeIn.factor>=1&&e.fadeIn.stage===g.FadeInStages.FADE_IN&&(e.fadeIn.stage=g.FadeInStages.FINISHED,e.fadeIn.factor=1)}function S(e,t,s){const{fadeInOut:r,crossFade:d}=e;r.stage===g.FadeInOutStages.FINISHED&&(e.startTime=t,r.factor=1,r.stage=g.FadeInOutStages.FADE_OUT),r.factor>0&&r.stage===g.FadeInOutStages.FADE_OUT?r.factor=s?1-a.clamp((t-e.startTime)/(m*s),0,1):0:(r.factor<=0&&r.stage===g.FadeInOutStages.FADE_OUT&&(r.factor=0,n.copy(e.parallax.anchorPointClouds,C)),r.factor<=0&&r.stage===g.FadeInOutStages.FADE_OUT&&e.isCameraPositionFinal&&(r.factor=0,r.stage=g.FadeInOutStages.SWITCH,e.crossFade.enabled=!1,d.factor=1),r.stage===g.FadeInOutStages.SWITCH&&(i.ensureClouds(e.data)&&e.renderingStage!==i.CloudsRenderingStages.RENDERING||e.renderingStage===i.CloudsRenderingStages.FADING_TEXTURE_CHANNELS)&&(e.startTime=t,r.factor=0,r.stage=g.FadeInOutStages.FADE_IN,n.copy(e.parallax.anchorPointClouds,C),e.crossFade.enabled=!1,d.factor=1,e.renderingStage===i.CloudsRenderingStages.FADING_TEXTURE_CHANNELS&&(e.renderingStage=i.CloudsRenderingStages.SWITCH_CHANNELS)),r.factor<1&&r.stage===g.FadeInOutStages.FADE_IN?r.factor=s?a.clamp((t-e.startTime)/(T*s),0,1):1:r.factor>=1&&r.stage===g.FadeInOutStages.FADE_IN&&(r.stage=g.FadeInOutStages.FINISHED,r.factor=1))}function l(e,t,s,r){const{crossFade:d}=e,o=e.parallax.anchorPointClouds;e.crossFade.enabled&&!r||(n.copy(e.parallaxNew.anchorPointClouds,C),e.startTime=t,d.factor=0,e.crossFade.enabled=!0),d.factor<1&&e.crossFade.enabled?d.factor=s?a.clamp((t-e.startTime)/(D*s),0,1):1:d.factor>=1&&e.crossFade.enabled&&(e.crossFade.enabled=!1,d.factor=1,n.copy(o,e.parallaxNew.anchorPointClouds),e.renderingStage===i.CloudsRenderingStages.FADING_TEXTURE_CHANNELS&&(e.renderingStage=i.CloudsRenderingStages.SWITCH_CHANNELS))}function F(e,t,n,s){const r=e.fadeInOutHeight,d=r.stage===g.FadeHeightStages.FINISHED?n:e.startTimeHeightFade;if(0!==s){const e=(n-d)/(A*s);r.factor+=t?-e:e}else r.factor=t?0:1;e.startTimeHeightFade=n,r.factor=a.clamp(r.factor,0,1),r.stage=g.FadeHeightStages.HEIGHT_FADE}function f(e,a,s,f,h){e.renderingStage===i.CloudsRenderingStages.FINISHED_RENDERING&&(e.renderingStage=i.CloudsRenderingStages.FADING_TEXTURE_CHANNELS);const T=n.length(a.eye);e.fadeInOutHeight.factor<0&&(e.fadeInOutHeight.factor=T-o.earth.radius>c.weatherHeightLimit?1:0),e.isCameraPositionFinal=n.equals(e.cameraPositionLastFrame,a.eye),n.normalize(C,a.eye),n.scale(C,C,o.earth.radius);const m=e.parallax;0===m.anchorPointClouds[0]&&0===m.anchorPointClouds[1]&&0===m.anchorPointClouds[2]&&n.copy(m.anchorPointClouds,C);const D=n.length(n.subtract(H,m.anchorPointClouds,C));let A=!0;if(D>e.fadeIn.distanceThresholdFactor*m.cloudsHeight||e.fadeIn.stage!==g.FadeInStages.FINISHED)u(e,f,h);else if(D>e.fadeInOut.distanceThresholdFactor*m.cloudsHeight||e.fadeInOut.stage!==g.FadeInOutStages.FINISHED)S(e,f,h);else if(D>e.crossFade.distanceThresholdFactor*m.cloudsHeight||e.crossFade.enabled||e.renderingStage===i.CloudsRenderingStages.FADING_TEXTURE_CHANNELS){l(e,f,h,(s!==I.RenderState.IDLE||!i.ensureClouds(e.data))&&e.renderingStage!==i.CloudsRenderingStages.FADING_TEXTURE_CHANNELS)}else A=!1;const R=T-o.earth.radius;if((R>1.7*c.weatherHeightLimit||R<-c.weatherHeightLimit)&&e.fadeInOutHeight.factor<1?e.fadeInOutHeight.factor=1:(R>c.weatherHeightLimit||R<-.35*c.weatherHeightLimit)&&e.fadeInOutHeight.factor<1?F(e,!1,f,h):R<c.weatherHeightLimit&&R>-.35*c.weatherHeightLimit&&e.fadeInOutHeight.factor>0?F(e,!0,f,h):e.fadeInOutHeight.stage=g.FadeHeightStages.FINISHED,e.renderingStage===i.CloudsRenderingStages.SWITCH_CHANNELS&&(e.readChannels=1-e.readChannels,e.renderingStage=i.CloudsRenderingStages.FINISHED),m.radiusCurvatureCorrectionFactor=.84*Math.sqrt(Math.max(T*T-o.earth.radius*o.earth.radius,0))/T,d.fromPoints(N,m.anchorPointClouds,E),t.rotate(m.transform,r.IDENTITY,E[3],d.axis(E)),A){const{parallaxNew:a}=e;d.fromPoints(N,a.anchorPointClouds,E),t.rotate(a.transform,r.IDENTITY,E[3],d.axis(E))}n.copy(e.cameraPositionLastFrame,a.eye)}function h(e){return e.crossFade.enabled||e.fadeInOut.stage!==g.FadeInOutStages.FINISHED||e.fadeIn.stage!==g.FadeInStages.FINISHED||e.fadeInOutHeight.stage!==g.FadeHeightStages.FINISHED||e.renderingStage!==i.CloudsRenderingStages.FINISHED}const N=s.fromValues(0,0,1),E=d.create(),C=s.create(),H=s.create(),T=1,m=.5,D=1.3,A=1;e.updateWeatherFading=f,e.weatherFadingNeedsRender=h,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
