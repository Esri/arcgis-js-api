/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../Color","../../../core/Evented","../../../core/Handles","../../../core/maybe","../../../core/promiseUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec3","../../../chunks/vec3f64","../../../chunks/vec4f64","../../../geometry/projection","../../../geometry/support/spatialReferenceUtils","./EnvironmentRenderer","../support/earthUtils","../support/sunUtils","../webgl-engine/lighting/Lightsources","../../../webscene/background/ColorBackground"],(function(e,t,r,n,i,o,s,a,c,d,h,l,p,_,u,f,m,g,P,v,b,w,y,C){"use strict";e.SceneViewEnvironmentManager=function(e){function r(){var t;return(t=e.call(this)||this)._referencePointUpdateDelay=200,t._referencePointUpdateInterval=3e3,t._referencePointUpdateDistThreshold=1e6,t._referencePosUpdateQuery=null,t._referencePosMapCoordsRequested=null,t._viewHandles=new o,t._preserveAbsoluteDateTime=!1,t._trackingEnabled=!1,t._referencePosResetPreserveAbsoluteTime=!1,t._referencePosUpdateTimer=null,t._referencePosMapCoords=null,t._mainLight=new y.MainLight,t._ambientLight=new y.AmbientLight,t._moonLight=new y.FillLight,t.disableQueries=!1,t._disableWeather=!1,t._renderer=null,t._referencePosWGS84Comparable=null,t._resetReferencePosition(),t}t._inheritsLoose(r,e);var i=r.prototype;return i.destroy=function(){this.disconnectView(),this._viewHandles.destroy()},i.connectView=function(e){this._renderer||(this._renderer=new v.EnvironmentRenderer({view:e}),this._viewHandles.add([e.watch("environment.lighting.date",(e=>this._lightingDateHandler(e)),!0),e.watch("stationary",(()=>this._interactingStationaryHandler())),e.watch(["environment.lighting.directShadowsEnabled","environment.lighting.ambientOcclusionEnabled","environment.lighting.waterReflectionEnabled","environment.background.color"],(()=>this._updateRenderParamsHandler()),!0),e.watch("spatialReference",(()=>this._resetReferencePosition(!0)),!0),e.watch("environment.weather.type",(()=>this._updateLightParams()),!0),this.watch("weatherEnabled",(()=>this._updateLightParams()),!0),c.init(e,"viewingMode",(()=>this._resetReferencePosition(!0)),!0),c.init(e,"environment.lighting.cameraTrackingEnabled",(e=>this._updateCameraTracking(e)),!0),c.init(e,"state.camera",(()=>this._cameraHandler()),!0),this.watch("disableQueries",(()=>this._cameraHandler()))]),this._updateRenderParamsHandler(),this._updateLightParams(),this._cameraHandler(),this.notifyChange("updating"))},i.disconnectView=function(){this._viewHandles.removeAll(),this._resetReferencePosition(),this._renderer=s.destroyMaybe(this._renderer)},i._updateCameraTracking=function(e){if(this._trackingEnabled=e,e)this._cameraHandler();else{const e=this._view.environment.lighting;e&&(e.positionTimezoneInfo.autoUpdated=!1)}},i._lightingDateHandler=function(e){if(!e)return;const t=this._view.environment.lighting;if(!t.positionTimezoneInfo.autoUpdated){this._preserveAbsoluteDateTime=!0;const r=this._view.spatialReference;if(!g.canProjectToWGS84ComparableLonLat(r)){const e=this._view.camera.position;if(!this._referencePosMapCoords||!this._referencePosMapCoords.equals(e))return void this._requestReferencePositionUpdate(e)}if(this._preupdateTracking(e),s.isSome(this._referencePosWGS84Comparable)){const e=b.positionToTimezoneInfo(this._referencePosWGS84Comparable,R);s.isSome(e)&&(t.autoUpdate(null,e),this._trackingEnabled&&(t.positionTimezoneInfo.autoUpdated=!0))}}this._updateLightParams(e)},i._preupdateTracking=function(e){!this._trackingEnabled&&this._view.environment.lighting.cameraTrackingEnabled&&this._cameraHandler(e)},i._cameraHandler=function(e=null){const t=this._view;if(!t.ready)return;const r=t.stateManager.camera;r&&(this._cameraHandlerClientSide(r,e)||this._cameraHandlerServerSide(r))},i._cameraHandlerClientSide=function(e,t){const r=P.isEarth(this._view.spatialReference);if(r&&!g.canProjectToWGS84ComparableLonLat(this._view.spatialReference))return!1;const n=e.position;return s.isNone(this._referencePosWGS84Comparable)&&(this._referencePosWGS84Comparable=f.create()),r?g.projectPointToWGS84ComparableLonLat(n,this._referencePosWGS84Comparable):u.set(this._referencePosWGS84Comparable,n.longitude,n.latitude,n.z),this.notifyChange("referencePositionWGS84Comparable"),this._autoUpdateTimezone(this._referencePosWGS84Comparable,t)||this._updateLightParams(t),!0},i._cameraHandlerServerSide=function(e){const t=e.position;(!this._referencePosMapCoords||this._referencePosMapCoordsRequested||this._exceedsReferencePosDistThreshold(t))&&this._requestReferencePositionUpdate(t,!0),this._view.mapCoordsHelper&&this._referencePosWGS84Comparable&&(this._referencePosWGS84Comparable[2]=t.z*this._view.mapCoordsHelper.unitInMeters,this._referencePosChanged())},i._interactingStationaryHandler=function(){this._view.stationary&&this._executePendingReferencePositionUpdate()},i._updateLightParams=function(e){const t=this._view,r=t.environment.lighting,n=e||r.date,i=t._stage,o=this._referencePosWGS84Comparable,a=s.isSome(o)?U:S;if(s.isSome(o)){const e=this.weatherEnabled?t.environment.weather.type:"disabled";w.computeColorAndIntensity(n,o,t.state.viewingMode,U,e)}const c=this._mainLight,d=a.direct;u.scale(c.intensity,d.color,d.intensity*Math.PI),u.copy(c.direction,d.directionToLightSource);const h=this._ambientLight;u.scale(h.intensity,a.ambient.color,a.ambient.intensity);const l=this._moonLight;u.lerp(l.intensity,M,E,a.globalFactor);const p=(1-.5*a.globalFactor)*(1-.4*a.noonFactor*(1-a.globalFactor));u.scale(l.intensity,l.intensity,p),u.copy(l.direction,d.directionToLightSource),i.renderView.updateLightSources([c,h,l],1-a.noonFactor,a.globalFactor),this._updateRenderParamsHandler()},i._autoUpdateTimezone=function(e,t=null){if(!this._view.environment.lighting.cameraTrackingEnabled||s.isNone(e))return!1;const r=T;r.setTime((t||this._view.environment.lighting.date).getTime());const n=b.positionToTimezoneInfo(e,R);if(s.isNone(n))return!1;let i=this._view.environment.lighting.positionTimezoneInfo;if(i.autoUpdated){if(i.hours===n.hours&&i.minutes===n.minutes&&i.seconds===n.seconds)return!1}else i=n;const o=r.getUTCHours()-(n.hours-i.hours),a=r.getUTCMinutes()-(n.minutes-i.minutes),c=r.getUTCSeconds()-(n.seconds-i.seconds);return r.setUTCHours(o),r.setUTCMinutes(a),r.setUTCSeconds(c),!t&&this._view.environment.lighting.autoUpdate(r,n)},i._updateRenderParamsHandler=function(){const e=this._view._stage;if(!e)return;const t=s.mapOr(this._referencePosWGS84Comparable,!0,(e=>w.computeShadowsEnabled(e[2],this._view.state.viewingMode))),r=this._view.environment.background,i=r instanceof C?{type:"color",color:m.fromArray(n.toUnitRGBA(r.color))}:{type:"color",color:m.fromValues(0,0,0,1)};e.renderView.setRenderParameters({shadowMap:this._view.environment.lighting.directShadowsEnabled&&t,ssao:this._view.environment.lighting.ambientOcclusionEnabled,waterReflectionEnabled:this._view.environment.lighting.waterReflectionEnabled,background:i})},i._resetReferencePosition=function(e=!1){this._cancelReferencePosUpdates(),this._referencePosMapCoords=null,this._referencePosMapCoordsRequested=null,this._referencePosResetPreserveAbsoluteTime=null,this._referencePosWGS84Comparable=null,this.notifyChange("updating"),e&&this._cameraHandler()},i._requestReferencePositionUpdate=function(e,t=!1){if(!this.disableQueries&&(this._referencePosMapCoordsRequested?this._referencePosMapCoordsRequested.copy(e):this._referencePosMapCoordsRequested=e.clone(),this._referencePosResetPreserveAbsoluteTime=!!t,!this._referencePosUpdateQuery&&!this._referencePosUpdateTimer&&this._view.stationary)){const e=this._referencePosUpdateQuery=a.after(this._referencePointUpdateDelay).then((()=>{if(this._referencePosUpdateQuery===e){const t=()=>this._referencePosUpdateQuery!==e;return this._doReferencePositionUpdateQuery(t)}})).catch((e=>{"mapcoordshelper:missing-geometry-service"===e.name&&(this.disableQueries=!0)})).then((()=>{this._referencePosUpdateQuery===e&&(this._referencePosUpdateQuery=null,this._referencePosUpdateTimer||this._executePendingReferencePositionUpdate(),this.notifyChange("updating"))})),t=this._referencePosUpdateTimer=a.after(this._referencePointUpdateInterval).then((()=>{this._referencePosUpdateTimer===t&&(this._referencePosUpdateTimer=null,this._referencePosUpdateQuery||this._executePendingReferencePositionUpdate())}));this.notifyChange("updating")}},i._doReferencePositionUpdateQuery=function(){var e=t._asyncToGenerator((function*(e){this._referencePosResetPreserveAbsoluteTime&&(this._preserveAbsoluteDateTime=!1),this._referencePosMapCoords?this._referencePosMapCoords.copy(this._referencePosMapCoordsRequested):this._referencePosMapCoords=this._referencePosMapCoordsRequested.clone(),this._referencePosResetPreserveAbsoluteTime=null,this._referencePosMapCoordsRequested=null;const t=yield this._view.mapCoordsHelper.toGeographic(this._referencePosMapCoords);if(!e()&&!isNaN(t[0])&&!isNaN(t[1])){const e=this._referencePosMapCoords.z*this._view.mapCoordsHelper.unitInMeters;this._referencePosWGS84Comparable?(this._referencePosWGS84Comparable[0]=t[0],this._referencePosWGS84Comparable[1]=t[1],this._referencePosWGS84Comparable[2]=e):this._referencePosWGS84Comparable=[t[0],t[1],e],this._referencePosChanged()}}));function r(t){return e.apply(this,arguments)}return r}(),i._executePendingReferencePositionUpdate=function(){const e=this._referencePosMapCoordsRequested;e&&this._requestReferencePositionUpdate(e,this._referencePosResetPreserveAbsoluteTime)},i._referencePosChanged=function(){this._preserveAbsoluteDateTime?this._updateLightParams():this._autoUpdateTimezone(this._referencePosWGS84Comparable)||this._updateLightParams(),this.notifyChange("referencePositionWGS84Comparable")},i._exceedsReferencePosDistThreshold=function(e){if(this._referencePosMapCoords){let t=this._referencePosMapCoords.distance(e);return this._view.mapCoordsHelper&&(t*=this._view.mapCoordsHelper.unitInMeters),t>this._referencePointUpdateDistThreshold}return!0},i._cancelReferencePosUpdates=function(){const e=!!this._referencePosUpdateQuery;return this._referencePosUpdateQuery=null,this._referencePosUpdateTimer=null,e},t._createClass(r,[{key:"_view",get:function(){var e;return null==(e=this._renderer)?void 0:e.view}},{key:"updating",get:function(){var e;return!!(!this.disableQueries&&(this._referencePosUpdateQuery||this._referencePosMapCoordsRequested)||null!=(e=this._renderer)&&e.updating)}},{key:"weatherEnabled",get:function(){var e,t,r;return(null==(e=this._view)?void 0:e.environment.atmosphereEnabled)&&!this._disableWeather&&1===(null==(t=this._view)||null==(r=t.state)?void 0:r.viewingMode)&&P.isEarth(this._view.spatialReference)}},{key:"referencePositionWGS84Comparable",get:function(){return this._referencePosWGS84Comparable}},{key:"test",get:function(){const e=this;return{get renderer(){return e._renderer},set referencePointUpdateInterval(t){e._referencePointUpdateInterval=t},set referencePointUpdateDistThreshold(t){e._referencePointUpdateDistThreshold=t},set referencePosUpdateTimer(t){e._referencePosUpdateTimer=t},set referencePointUpdateDelay(t){e._referencePointUpdateDelay=t},set disableWeather(t){e._disableWeather=t}}}}]),r}(i.EventedAccessor),r.__decorate([d.property({type:Boolean,readOnly:!0})],e.SceneViewEnvironmentManager.prototype,"updating",null),r.__decorate([d.property()],e.SceneViewEnvironmentManager.prototype,"disableQueries",void 0),r.__decorate([d.property()],e.SceneViewEnvironmentManager.prototype,"_disableWeather",void 0),r.__decorate([d.property()],e.SceneViewEnvironmentManager.prototype,"weatherEnabled",null),r.__decorate([d.property()],e.SceneViewEnvironmentManager.prototype,"referencePositionWGS84Comparable",null),r.__decorate([d.property()],e.SceneViewEnvironmentManager.prototype,"_renderer",void 0),r.__decorate([d.property()],e.SceneViewEnvironmentManager.prototype,"_referencePosWGS84Comparable",void 0),e.SceneViewEnvironmentManager=r.__decorate([_.subclass("esri.views.3d.environment.SceneViewEnvironmentManager")],e.SceneViewEnvironmentManager);const U=new w.ColorAndIntensity,S=new w.ColorAndIntensity,T=new Date,R={hours:0,minutes:0,seconds:0},M=f.fromValues(.22,.22,.33),E=f.fromValues(.22,.22,.22);Object.defineProperty(e,"__esModule",{value:!0})}));
