/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/has","../../../core/maybe","../../../core/Logger","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass","../../../core/urlUtils","../../../core/uuid","../../../portal/support/resourceExtension","../../../core/promiseUtils","../../../geometry/support/spatialReferenceUtils","../../../core/Evented","../../../Color","../../../chunks/vec3f64","../../../chunks/vec3","../../../core/Handles","../../../core/watchUtils","../../../geometry/projection","../../../webscene/background/ColorBackground","../../../chunks/vec4f64","./EnvironmentRenderer","../support/earthUtils","../support/sunUtils","../webgl-engine/lighting/Lightsources"],(function(e,t,n,r,i,s,o,a,c,d,h,l,u,_,p,f,m,g,P,v,b,w,C,U,y,T,R){"use strict";const S=m.fromValues(.5773502691896258,-.5773502691896258,.5773502691896258);e.SceneViewEnvironmentManager=function(e){function n(...t){var n;return(n=e.call(this,...t)||this)._referencePointUpdateDelay=200,n._referencePointUpdateInterval=3e3,n._referencePointUpdateDistThreshold=1e6,n._referencePosUpdateQuery=null,n._referencePosMapCoordsRequested=null,n._viewHandles=new P,n._preserveAbsoluteDateTime=!1,n._trackingEnabled=!1,n._referencePosResetPreserveAbsoluteTime=!1,n.referencePosUpdateTimer=null,n._referencePosWGS84Comparable=null,n._referencePosMapCoords=null,n._mainLight=new R.MainLight,n._ambientLight=new R.AmbientLight,n._moonLight=new R.FillLight,n._renderer=null,n._resetReferencePosition(),n}t._inheritsLoose(n,e);var r=n.prototype;return r.destroy=function(){this.disconnectView(),this._viewHandles.destroy()},r.connectView=function(e){this._renderer||(this._view=e,this._renderer=new U({view:e}),this._viewHandles.add([e.watch("environment.lighting.date",(e=>this._lightingDateHandler(e)),!0),e.watch("stationary",(()=>this._interactingStationaryHandler())),e.watch(["environment.lighting.directShadowsEnabled","environment.lighting.ambientOcclusionEnabled","environment.lighting.waterReflectionEnabled","environment.background.color"],(()=>this._updateRenderParamsHandler()),!0),e.watch("spatialReference",(()=>this._resetReferencePosition(!0)),!0),v.init(e,"viewingMode",(()=>this._resetReferencePosition(!0)),!0),v.init(e,"environment.lighting.cameraTrackingEnabled",(e=>this._updateCameraTracking(e)),!0),v.init(e,"state.camera",(()=>this._cameraHandler(null)),!0),this.watch("disableQueries",(()=>this._cameraHandler(null)))]),this._updateRenderParamsHandler(),this._updateLightParams(),this._cameraHandler(),this.notifyChange("updating"))},r.disconnectView=function(){this._renderer&&(this._viewHandles.removeAll(),this._resetReferencePosition(),this._renderer.destroy(),this._renderer=null,this._view=null)},r._updateCameraTracking=function(e){if(this._trackingEnabled=e,e)this._cameraHandler();else{const e=this._view.environment.lighting;e&&(e.positionTimezoneInfo.autoUpdated=!1)}},r._lightingDateHandler=function(e){if(!e)return;const t=this._view.environment.lighting;if(!t.positionTimezoneInfo.autoUpdated){this._preserveAbsoluteDateTime=!0;const n=this._view.spatialReference;if(!b.canProjectToWGS84ComparableLonLat(n)){const e=this._view.camera.position;if(!this._referencePosMapCoords||!this._referencePosMapCoords.equals(e))return void this._requestReferencePositionUpdate(e)}if(this._preupdateTracking(e),this._referencePosWGS84Comparable){const e=y.positionToTimezone(this._referencePosWGS84Comparable,H);i.isSome(e)&&(t.autoUpdate(null,e),this._trackingEnabled&&(t.positionTimezoneInfo.autoUpdated=!0))}}this._updateLightParams(e)},r._preupdateTracking=function(e){!this._trackingEnabled&&this._view.environment.lighting.cameraTrackingEnabled&&this._cameraHandler(e)},r._cameraHandler=function(e=null){if(!this._view.ready)return;const t=this._view.camera;t&&(this._cameraHandlerClientSide(t,e)||this._cameraHandlerServerSide(t))},r._cameraHandlerClientSide=function(e,t){const n=_.isEarth(this._view.spatialReference);if(n&&!b.canProjectToWGS84ComparableLonLat(this._view.spatialReference))return!1;const r=e.position;return this._referencePosWGS84Comparable||(this._referencePosWGS84Comparable=m.create()),n?b.projectPointToWGS84ComparableLonLat(r,this._referencePosWGS84Comparable):g.set(this._referencePosWGS84Comparable,r.longitude,r.latitude,r.z),this._autoUpdateTimezone(this._referencePosWGS84Comparable,t)||this._updateLightParams(t),!0},r._cameraHandlerServerSide=function(e){const t=e.position;(!this._referencePosMapCoords||this._referencePosMapCoordsRequested||this._exceedsReferencePosDistThreshold(t))&&this._requestReferencePositionUpdate(t,!0),this._view.mapCoordsHelper&&this._referencePosWGS84Comparable&&(this._referencePosWGS84Comparable[2]=t.z*this._view.mapCoordsHelper.unitInMeters,this._referencePosChanged())},r._interactingStationaryHandler=function(){this._view.stationary&&this._executePendingReferencePositionUpdate()},r._updateLightParams=function(e){const t=this._view.environment.lighting;e=e||t.date;const n=this._view._stage;let r;this._referencePosWGS84Comparable?(r=T.computeColorAndIntensity(e,this._referencePosWGS84Comparable),T.computeDirection(e,this._referencePosWGS84Comparable,this._view.viewingMode,r.diffuse.direction)):r={diffuse:{color:[1,1,1],intensity:.55,direction:S},ambient:{color:[1,1,1],intensity:.55},noonFactor:.5,globalFactor:0},g.scale(this._mainLight.intensity,r.diffuse.color,r.diffuse.intensity*Math.PI),g.negate(this._mainLight.direction,r.diffuse.direction),g.scale(this._ambientLight.intensity,r.ambient.color,r.ambient.intensity),g.lerp(this._moonLight.intensity,L,E,r.globalFactor);const i=(1-.5*r.globalFactor)*(1-.4*r.noonFactor*(1-r.globalFactor));g.scale(this._moonLight.intensity,this._moonLight.intensity,i),g.copy(this._moonLight.direction,r.diffuse.direction),n.setLighting({lights:[this._mainLight,this._ambientLight,this._moonLight],globalFactor:r.globalFactor,groundLightingFactor:1-r.noonFactor}),this._updateRenderParamsHandler()},r._autoUpdateTimezone=function(e,t=null){if(!this._view.environment.lighting.cameraTrackingEnabled)return!1;const n=M;n.setTime((t||this._view.environment.lighting.date).getTime());const r=y.positionToTimezone(e,H);if(i.isNone(r))return!1;let s=this._view.environment.lighting.positionTimezoneInfo;if(s.autoUpdated){if(s.hours===r.hours&&s.minutes===r.minutes&&s.seconds===r.seconds)return!1}else s=r;const o=n.getUTCHours()-(r.hours-s.hours),a=n.getUTCMinutes()-(r.minutes-s.minutes),c=n.getUTCSeconds()-(r.seconds-s.seconds);return n.setUTCHours(o),n.setUTCMinutes(a),n.setUTCSeconds(c),!t&&this._view.environment.lighting.autoUpdate(n,r)},r._updateRenderParamsHandler=function(){const e=this._view._stage;if(!e)return;const t=!this._referencePosWGS84Comparable||T.computeShadowsEnabled(this._referencePosWGS84Comparable,this._view.viewingMode),n=this._view.environment.background,r=n instanceof w?{type:"color",color:C.fromArray(f.toUnitRGBA(n.color))}:{type:"color",color:C.fromValues(0,0,0,1)};e.renderView.setRenderParameters({shadowMap:this._view.environment.lighting.directShadowsEnabled&&t,ssao:this._view.environment.lighting.ambientOcclusionEnabled,waterReflectionEnabled:this._view.environment.lighting.waterReflectionEnabled,background:r})},r._resetReferencePosition=function(e=!1){const t=this._cancelReferencePosUpdates();this._referencePosMapCoords=null,this._referencePosMapCoordsRequested=null,this._referencePosResetPreserveAbsoluteTime=null,this._referencePosWGS84Comparable=null,this.notifyChange("updating"),t&&e&&this._cameraHandler(null)},r._requestReferencePositionUpdate=function(e,t=!1){if(!this.disableQueries&&(this._referencePosMapCoordsRequested?this._referencePosMapCoordsRequested.copy(e):this._referencePosMapCoordsRequested=e.clone(),this._referencePosResetPreserveAbsoluteTime=!!t,!this._referencePosUpdateQuery&&!this.referencePosUpdateTimer&&this._view.stationary)){const e=this._referencePosUpdateQuery=u.after(this._referencePointUpdateDelay).then((()=>{if(this._referencePosUpdateQuery===e){const t=()=>this._referencePosUpdateQuery!==e;return this._doReferencePositionUpdateQuery(t)}})).catch((e=>{"mapcoordshelper:missing-geometry-service"===e.name&&(this.disableQueries=!0)})).then((()=>{this._referencePosUpdateQuery===e&&(this._referencePosUpdateQuery=null,this.referencePosUpdateTimer||this._executePendingReferencePositionUpdate(),this.notifyChange("updating"))})),t=this.referencePosUpdateTimer=u.after(this._referencePointUpdateInterval).then((()=>{this.referencePosUpdateTimer===t&&(this.referencePosUpdateTimer=null,this._referencePosUpdateQuery||this._executePendingReferencePositionUpdate())}));this.notifyChange("updating")}},r._doReferencePositionUpdateQuery=async function(e){this._referencePosResetPreserveAbsoluteTime&&(this._preserveAbsoluteDateTime=!1),this._referencePosMapCoords?this._referencePosMapCoords.copy(this._referencePosMapCoordsRequested):this._referencePosMapCoords=this._referencePosMapCoordsRequested.clone(),this._referencePosResetPreserveAbsoluteTime=null,this._referencePosMapCoordsRequested=null;const t=await this._view.mapCoordsHelper.toGeographic(this._referencePosMapCoords);if(!e()&&!isNaN(t[0])&&!isNaN(t[1])){const e=this._referencePosMapCoords.z*this._view.mapCoordsHelper.unitInMeters;this._referencePosWGS84Comparable?(this._referencePosWGS84Comparable[0]=t[0],this._referencePosWGS84Comparable[1]=t[1],this._referencePosWGS84Comparable[2]=e):this._referencePosWGS84Comparable=[t[0],t[1],e],this._referencePosChanged()}},r._executePendingReferencePositionUpdate=function(){const e=this._referencePosMapCoordsRequested;e&&this._requestReferencePositionUpdate(e,this._referencePosResetPreserveAbsoluteTime)},r._referencePosChanged=function(){this._preserveAbsoluteDateTime?this._updateLightParams():this._autoUpdateTimezone(this._referencePosWGS84Comparable)||this._updateLightParams()},r._exceedsReferencePosDistThreshold=function(e){if(this._referencePosMapCoords){let t=this._referencePosMapCoords.distance(e);return this._view.mapCoordsHelper&&(t*=this._view.mapCoordsHelper.unitInMeters),t>this._referencePointUpdateDistThreshold}return!0},r._cancelReferencePosUpdates=function(){const e=!!this._referencePosUpdateQuery;return this._referencePosUpdateQuery=null,this.referencePosUpdateTimer=null,e},t._createClass(n,[{key:"updating",get:function(){return!!(!this.disableQueries&&(this._referencePosUpdateQuery||this._referencePosMapCoordsRequested)||this._renderer&&this._renderer.updating)}},{key:"test",get:function(){const e=this;return{renderer:this._renderer,set referencePointUpdateInterval(t){e._referencePointUpdateInterval=t},set referencePointUpdateDistThreshold(t){e._referencePointUpdateDistThreshold=t},set referencePosUpdateTimer(t){e.referencePosUpdateTimer=t},set referencePointUpdateDelay(t){e._referencePointUpdateDelay=t}}}}]),n}(p.EventedAccessor),e.SceneViewEnvironmentManager.FIXED_LIGHT_DIRECTION=S,n.__decorate([a.property({type:Boolean,dependsOn:["disableQueries","_renderer.updating"],readOnly:!0})],e.SceneViewEnvironmentManager.prototype,"updating",null),n.__decorate([a.property()],e.SceneViewEnvironmentManager.prototype,"disableQueries",void 0),n.__decorate([a.property()],e.SceneViewEnvironmentManager.prototype,"_renderer",void 0),e.SceneViewEnvironmentManager=n.__decorate([c.subclass("esri.views.3d.environment.SceneViewEnvironmentManager")],e.SceneViewEnvironmentManager);const M=new Date,H={hours:0,minutes:0,seconds:0},L=m.fromValues(.22,.22,.33),E=m.fromValues(.22,.22,.22);var G=e.SceneViewEnvironmentManager;e.default=G,Object.defineProperty(e,"__esModule",{value:!0})}));
