/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/maybe","../../../chunks/mat3","../../../chunks/mat3f64","../../../chunks/mat4","../../../chunks/mat4f64","../../../chunks/vec3f32","../../../geometry/projectionEllipsoid","./CloudsTechnique","./NoiseTextureAtlas","../webgl-engine/lib/glUtil3D","../../webgl/FramebufferObject"],(function(e,t,i,s,r,o,n,a,h,u,l,c,f){"use strict";let d=function(){function e(e,t){this._cubeMapSize=2048,this._viewMat3=r.create(),this._eye=a.zeros(),this._faceRenderFlags=[],this.viewDirections=[a.fromValues(1,0,0),a.fromValues(-1,0,0),a.fromValues(0,1,0),a.fromValues(0,-1,0),a.fromValues(0,0,1)],this.upDirections=[a.fromValues(0,1,0),a.fromValues(0,1,0),a.fromValues(0,0,-1),a.fromValues(0,0,1),a.fromValues(0,1,0)],this._cloudRadius=0,this._viewMatrix=n.create(),this.coverage=.4,this.density=.5,this.cloudSize=.5,this.detailSize=.5,this.smoothness=.7,this.absorption=0,this.cloudHeight=1,this._noiseTextureAtlas=new l.NoiseTextureAtlas(e,t),this._noiseTextureAtlas.render(128,e);const i={target:34067,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,hasMipmap:!1,width:this._cubeMapSize,height:this._cubeMapSize};this._frameBufferCube=new f(e,{colorTarget:2,width:this._cubeMapSize,height:this._cubeMapSize},i),this._vao=c.createQuadVAO(e),this._technique=new u.CloudsTechnique({rctx:e,viewingMode:t.state.viewingMode},null);const s=h.getReferenceEllipsoid(t.spatialReference);this._cloudRadius=.5*s.radius,this.resetRenderFlags()}var d=e.prototype;return d.destroy=function(){this._technique=i.releaseMaybe(this._technique),this._frameBufferCube=i.disposeMaybe(this._frameBufferCube),this._vao=i.disposeMaybe(this._vao),this._noiseTextureAtlas=i.destroyMaybe(this._noiseTextureAtlas)},d.resetRenderFlags=function(){for(let e=0;e<5;e++)this._faceRenderFlags[e]=!0},d._allRendered=function(){for(let e=0;e<5;e++)if(!0===this._faceRenderFlags[e])return!1;return!0},d.remap=function(e,t,i,s,r){return s+(e-t)*(r-s)/(i-t)},d.render=function(e){if(i.isNone(this._vao)||this._allRendered())return!1;this.resetRenderFlags(),e.setViewport(0,0,this._cubeMapSize,this._cubeMapSize),e.bindFramebuffer(this._frameBufferCube,!1,34069);const t=this._technique.program;e.useProgram(t),t.bindTexture(this._noiseTextureAtlas.textureAtlas,"cloudShapeTexture"),t.setUniform1f("cloudRadius",this._cloudRadius),t.setUniform1f("halfCubeMapSize",.5*this._cubeMapSize),t.setUniform1f("power",this._power),t.setUniform1f("sigmaE",this._sigmaE),t.setUniform1f("density",this._density),t.setUniform1f("cloudSize",this._cloudSize),t.setUniform1f("detailSize",this._detailSize),t.setUniform1f("smoothness",this._smoothness),t.setUniform1f("cloudHeight",this._cloudHeight),t.setUniform1f("coverage",this._coverage),e.bindVAO(this._vao),t.assertCompatibleVertexAttributeLocations(this._vao),this._technique.bindPipelineState(e);for(let i=0;i<5;i++)if(this._faceRenderFlags[i]){const r=this.viewDirections[i],n=this.upDirections[i];o.targetTo(this._viewMatrix,this._eye,r,n),s.fromMat4(this._viewMat3,this._viewMatrix),t.setUniformMatrix3fv("viewMatrix",this._viewMat3);const a=34069+i;this._frameBufferCube.framebufferTexture2D(this._frameBufferCube.colorAttachment.glName,e.gl,36064,a),e.gl.drawArrays(e.gl.TRIANGLE_STRIP,0,4),e.gl.flush(),this._faceRenderFlags[i]=!1}return!0},t._createClass(e,[{key:"coverage",get:function(){return this._coverage},set:function(e){this._coverage=e,this.resetRenderFlags()}},{key:"density",get:function(){return this._density},set:function(e){this._density=this.remap(e,0,1,0,.3),this.resetRenderFlags()}},{key:"cloudSize",get:function(){return this._cloudSize},set:function(e){this._cloudSize=this.remap(Math.max(.01,1-e),0,1,0,.02),this.resetRenderFlags()}},{key:"detailSize",get:function(){return this._detailSize},set:function(e){this._detailSize=this.remap(Math.max(.01,1-e),0,1,0,.2),this.resetRenderFlags()}},{key:"smoothness",get:function(){return this._smoothness},set:function(e){this._smoothness=this.remap(1-e,0,1,0,.5),this.resetRenderFlags()}},{key:"absorption",get:function(){return this._power},set:function(e){this._sigmaE=1+e,this._power=this.remap(e,0,1,35,70),this.resetRenderFlags()}},{key:"cloudHeight",get:function(){return this._cloudHeight},set:function(e){this._cloudHeight=this.remap(e,0,1,0,1500),this.resetRenderFlags()}},{key:"test",get:function(){return{power:this._power,density:this._density,cloudHeight:this._cloudHeight,cloudSize:this._cloudSize,detailSize:this._detailSize,smoothness:this._smoothness}}}]),e}();e.CloudsGenerator=d,Object.defineProperty(e,"__esModule",{value:!0})}));
