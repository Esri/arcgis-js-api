/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/has","../../../core/mathUtils","../../../core/maybe","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../../chunks/mat3","../../../chunks/mat3f64","../../../chunks/mat4","../../../chunks/mat4f64","../../../chunks/vec3f32","../../../geometry/projectionEllipsoid","./CloudsTechnique","./NoiseTextureAtlas","../webgl-engine/lib/glUtil3D","../../support/Scheduler","../../webgl/FramebufferObject"],(function(e,t,i,s,r,o,n,a,h,u,c,d,l,f,p,_,m,g,y,b,v,S){"use strict";e.CloudsGenerator=function(e){function i(t){var i;(i=e.call(this,t)||this)._frameTask=null,i._techniques=[],i._techniqueConfiguration=new g.CloudsTechniqueConfiguration,i._cubeMapSize=r("esri-mobile")?1024:2048,i._viewMat3=l.create(),i._eye=_.zeros(),i._didRenderFaces=!1,i._raymarchingStepType=0,i._cloudRadius=0,i._viewMatrix=p.create();const s=C.sunny;return i.coverage=o.lerp(s.coverage[1],s.coverage[0],.5),i.density=o.lerp(s.density[1],s.density[0],.5),i.absorption=o.lerp(s.absorption[1],s.absorption[0],.5),i.cloudSize=o.lerp(s.cloudSize[1],s.cloudSize[0],.5),i.detailSize=o.lerp(s.detailSize[1],s.detailSize[0],.5),i.smoothness=o.lerp(s.smoothness[1],s.smoothness[0],.5),i.cloudHeight=o.lerp(s.cloudHeight[1],s.cloudHeight[0],.5),i.raymarchingStepType=s.raymarchingStepType,i}t._inheritsLoose(i,e);var s=i.prototype;return s._getTechnique=function(e){const t=this._techniques[e];return t||(this._techniqueConfiguration.steps=e,this._techniques[e]=new g.CloudsTechnique({rctx:this.rctx,viewingMode:this.view.state.viewingMode},this._techniqueConfiguration),this._techniques[e])},s.initialize=function(){this._vao=b.createQuadVAO(this.rctx);const e=m.getReferenceEllipsoid(this.view.spatialReference);this._cloudRadius=.5*e.radius,this.resetRenderFlags(),this._frameTask=this.view.resourceController.scheduler.registerTask(v.TaskPriority.CLOUDS_GENERATOR,this)},s.destroy=function(){this._frameTask=n.removeMaybe(this._frameTask),this._techniques.forEach((e=>n.releaseMaybe(e))),this._techniques=null,this._frameBufferCube=n.disposeMaybe(this._frameBufferCube),this._vao=n.disposeMaybe(this._vao),this._noiseTexture=n.destroyMaybe(this._noiseTexture)},s._ensureNoiseTexture=function(){return n.isNone(this._noiseTexture)&&(this._noiseTexture=new y.NoiseTextureAtlas(this.rctx,this.view),this._noiseTexture.render(this.rctx)),this._noiseTexture},s.resetRenderFlags=function(){this._didRenderFaces=!1},s.remap=function(e,t,i,s,r){return s+(e-t)*(r-s)/(i-t)},s.runTask=function(e){if(0===this.coverage||n.isNone(this._vao))return void(this._didRenderFaces=!0);const t=this._ensureNoiseTexture().textureAtlas;if(n.isNone(t))return void(this._didRenderFaces=!0);const i=this.rctx.getViewport();this.rctx.setViewport(0,0,this._cubeMapSize,this._cubeMapSize),this.rctx.bindFramebuffer(this.frameBufferCube,!1,34069);const s=this._getTechnique(this._raymarchingStepType),r=s.program;this.rctx.useProgram(r),r.bindTexture(t,"cloudShapeTexture"),r.setUniform1f("cloudRadius",this._cloudRadius),r.setUniform1f("halfCubeMapSize",.5*this._cubeMapSize),r.setUniform1f("power",this._power),r.setUniform1f("sigmaE",this._sigmaE),r.setUniform1f("density",this._density),r.setUniform1f("cloudSize",this._cloudSize),r.setUniform1f("detailSize",this._detailSize),r.setUniform1f("smoothness",this._smoothness),r.setUniform1f("cloudHeight",this._cloudHeight),r.setUniform1f("coverage",this._coverage),this.rctx.bindVAO(this._vao),r.assertCompatibleVertexAttributeLocations(this._vao),s.bindPipelineState(this.rctx);for(let o=0;o<5;o++){const e=x[o],t=T[o];f.targetTo(this._viewMatrix,this._eye,e,t),d.fromMat4(this._viewMat3,this._viewMatrix),r.setUniformMatrix3fv("viewMatrix",this._viewMat3);const i=34069+o;this.frameBufferCube.framebufferTexture2D(this.frameBufferCube.colorAttachment.glName,this.rctx.gl,36064,i),this.rctx.gl.drawArrays(this.rctx.gl.TRIANGLE_STRIP,0,4),this.rctx.gl.flush()}this.rctx.setViewport(i.x,i.y,i.width,i.height),this.requestRender(),this._didRenderFaces=!0,e.madeProgress()},t._createClass(i,[{key:"coverage",get:function(){return this._coverage},set:function(e){this._coverage=e,this.resetRenderFlags()}},{key:"density",set:function(e){this._density=this.remap(e,0,1,0,.3),this.resetRenderFlags()}},{key:"cloudSize",set:function(e){this._cloudSize=this.remap(Math.max(.01,1-e),0,1,0,.02),this.resetRenderFlags()}},{key:"detailSize",set:function(e){this._detailSize=this.remap(Math.max(.01,1-e),0,1,0,.2),this.resetRenderFlags()}},{key:"smoothness",set:function(e){this._smoothness=this.remap(1-e,0,1,0,.5),this.resetRenderFlags()}},{key:"absorption",get:function(){return this._sigmaE-1},set:function(e){this._sigmaE=1+e,this._power=this.remap(e,0,1,35,120),this.resetRenderFlags()}},{key:"cloudHeight",get:function(){return this._cloudHeight},set:function(e){this._cloudHeight=this.remap(e,0,1,0,1500),this.resetRenderFlags()}},{key:"raymarchingStepType",set:function(e){this._raymarchingStepType=e,this.resetRenderFlags()}},{key:"frameBufferCube",get:function(){if(n.isNone(this._frameBufferCube)){const e={target:34067,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,hasMipmap:!1,width:this._cubeMapSize,height:this._cubeMapSize};this._frameBufferCube=new S(this.rctx,{colorTarget:2,width:this._cubeMapSize,height:this._cubeMapSize},e)}return this._frameBufferCube}},{key:"cubeMap",get:function(){return this._frameBufferCube}},{key:"running",get:function(){return!this._didRenderFaces}},{key:"test",get:function(){return{coverage:this._coverage,density:this.remap(this._density,0,.3,0,1),absorption:this._sigmaE-1,cloudSize:1-this.remap(this._cloudSize,0,.02,0,1),detailSize:1-this.remap(this._detailSize,0,.2,0,1),smoothness:1-this.remap(this._smoothness,0,.5,0,1),cloudHeight:this.remap(this._cloudHeight,0,1500,0,1)}}}]),i}(s),i.__decorate([a.property({constructOnly:!0})],e.CloudsGenerator.prototype,"rctx",void 0),i.__decorate([a.property({constructOnly:!0})],e.CloudsGenerator.prototype,"view",void 0),i.__decorate([a.property({constructOnly:!0})],e.CloudsGenerator.prototype,"requestRender",void 0),i.__decorate([a.property()],e.CloudsGenerator.prototype,"_frameTask",void 0),i.__decorate([a.property()],e.CloudsGenerator.prototype,"_didRenderFaces",void 0),i.__decorate([a.property({readOnly:!0})],e.CloudsGenerator.prototype,"running",null),e.CloudsGenerator=i.__decorate([c.subclass("esri.views.3d.environment.CloudsGenerator")],e.CloudsGenerator);const x=[_.fromValues(1,0,0),_.fromValues(-1,0,0),_.fromValues(0,1,0),_.fromValues(0,-1,0),_.fromValues(0,0,1)],T=[_.fromValues(0,1,0),_.fromValues(0,1,0),_.fromValues(0,0,-1),_.fromValues(0,0,1),_.fromValues(0,1,0)];let w=function(e,t,i,s,r,o,n,a,h=.5){this.coverage=e,this.density=t,this.absorption=i,this.cloudSize=s,this.detailSize=r,this.smoothness=o,this.cloudHeight=n,this.raymarchingStepType=a,this.median=h};const C={sunny:new w([.1,.7],[.02,.02],[0,0],[.86,.86],[.8,.8],[.5,.5],[.05,.05],0),cloudy:new w([.24,.7],[.135,.2],[0,0],[.5,.5],[.65,.7],[.3,.3],[1,1],2),rainy:new w([.5,.9],[.2,.5],[.3,.6],[.4,.4],[.7,.7],[.5,.5],[1,1],2),foggy:new w([.8,.8],[.5,.5],[0,0],[.85,.85],[.75,.75],[.8,.8],[.3,.3],1)};e.cloudPresets=C,Object.defineProperty(e,"__esModule",{value:!0})}));
