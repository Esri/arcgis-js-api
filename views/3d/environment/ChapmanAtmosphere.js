/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../../core/Handles","../../../core/maybe","../../../core/watchUtils","../../../chunks/mat4","../../../chunks/mat4f64","../../../chunks/vec2","../../../chunks/vec2f64","../../../chunks/vec3","../../../chunks/vec3f64","../../../chunks/vec4f64","../../../geometry/support/Ellipsoid","./atmosphereUtils","./ChapmanAtmosphereTechnique","../webgl-engine/lib/DefaultVertexBufferLayouts","../webgl-engine/lib/glUtil3D"],(function(e,t,i,s,a,r,n,h,o,u,_,d,c,l,m,p){"use strict";let f=function(){function e(e){this._view=e,this.canRender=!0,this._skyslot=15,this._hazeSlot=16,this._cameraPosition=u.create(),this._projectionInverse=r.create(),this._viewInverse=r.create(),this._heightParameters=_.create(),this._betasRayleigh=u.create(),this._betasCombined=u.create(),this._scaleHeight=0,this._radii=h.create(),this._nearFar=h.create(),this._cameraHeight=0,this._cameraHeightSq=0,this._cAtmosphere=0,this._innerFadeDistance=0,this._altitudeFade=0,this._lowerElevationBoundRadius=0,this._lowerBoundEarthRadius=d.earth.radius,this._simplified=!1,this._skyStrength=1,this._hazeStrength=3,this._mieStrength=1,this._skyHazeMultiplier=1,this._skyHazePow=0,this._sunSize=1,this._sunSpread=1,this._updateRadius(d.earth.radius)}var f=e.prototype;return f.destroy=function(){this._atmosphereTechnique=i.releaseMaybe(this._atmosphereTechnique),this._atmosphereHazeTechnique=i.releaseMaybe(this._atmosphereHazeTechnique),this._vao=i.disposeMaybe(this._vao),this._handles=i.destroyMaybe(this._handles)},f.when=function(){return Promise.resolve()},f.setSimplified=function(e){this._simplified=e},f.initializeRenderContext=function(e){const a=e.renderContext.rctx;this._handles=new t,i.isSome(this._view.basemapTerrain.rootTiles)&&this._updateElevation({spatialReference:this._view.basemapTerrain.spatialReference,tile:this._view.basemapTerrain.rootTiles[0],extent:this._view.basemapTerrain.rootTiles[0].extent,context:"ground"}),this._handles.add(s.on(this._view,"basemapTerrain","elevation-change",(e=>this._updateElevation(e)),(()=>this._updateElevation()))),this._handles.add(s.on(this._view,"basemapTerrain","elevation-bounds-change",(()=>this._updateVisibleElevationBounds())));const r=new l.ChapmanAtmosphereTechniqueConfiguration;r.haze=!1,r.simplified=this._simplified,this._atmosphereTechnique=e.shaderTechniqueRep.acquire(l.ChapmanAtmosphereTechnique,r),r.haze=!0,this._atmosphereHazeTechnique=e.shaderTechniqueRep.acquire(l.ChapmanAtmosphereTechnique,r),this._vao=p.createQuadVAO(a,m.Pos2Tex),this._scaleHeight=c.rayLeighScaleHeight*c.atmosphereHeight,o.set(this._betasRayleigh,c.betaRayleigh[0],c.betaRayleigh[1],c.betaRayleigh[2]),o.set(this._betasCombined,c.betaRayleigh[0]+c.betaOzone[0],c.betaRayleigh[1]+c.betaOzone[1],c.betaRayleigh[2]+c.betaOzone[2])},f.uninitializeRenderContext=function(){this.destroy()},f.render=function(e){if(e.slot!==this._hazeSlot&&e.slot!==this._skyslot||0!==e.pass)return!1;this._update(e.camera);const t=e.rctx,i=e.offscreenRenderingHelper,s=e.slot===this._skyslot?this._atmosphereTechnique:this._atmosphereHazeTechnique,a=e.slot===this._skyslot?i.depthTexture:i.linearDepthTexture;return t.useProgram(s.program),s.bindPipelineState(t),i.renderDepthDetached((()=>{s.program.bindTexture(a,"depthTex"),this._renderCommon(s.program,e)})),!0},f._renderCommon=function(e,t){if(i.isNone(this._vao))return!1;const s=t.rctx;return t.scenelightingData.setLightDirectionUniform(e),e.setUniform4fv("heightParameters",this._heightParameters),e.setUniform3fv("cameraPosition",this._cameraPosition),e.setUniformMatrix4fv("projectionInverse",this._projectionInverse),e.setUniformMatrix4fv("viewInverse",this._viewInverse),e.setUniform2fv("nearFar",this._nearFar),e.setUniform2fv("radii",this._radii),e.setUniform1f("scaleHeight",this._scaleHeight),this._simplified||e.setUniform1f("betaMie",c.betaMie),e.setUniform3fv("betaRayleigh",this._betasRayleigh),e.setUniform3fv("betaCombined",this._betasCombined),e.setUniform1f("innerFadeDistance",this._innerFadeDistance),e.setUniform1f("altitudeFade",this._altitudeFade),e.setUniform1f("skyStrength",this._skyStrength),e.setUniform1f("hazeStrength",this._hazeStrength),e.setUniform1f("mieStrength",this._mieStrength),e.setUniform1f("skyHazeMultiplier",this._skyHazeMultiplier),e.setUniform1f("skyHazePow",this._skyHazePow),e.setUniform1f("sunSize",this._sunSize),e.setUniform1f("sunSpread",this._sunSpread),s.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),s.drawArrays(5,0,4),!0},f._adjustRadiusForTesselation=function(e){return e*Math.cos(Math.PI/16/16)},f._updateElevation=function(e){const t=e?e.tile:i.unwrapOr(this._view.basemapTerrain.rootTiles,[null])[0];if(i.isNone(t)||0!==t.lij[0])return;const s=this._adjustRadiusForTesselation(d.earth.radius+t.elevationBounds[0]);s!==this._lowerElevationBoundRadius&&(this._lowerElevationBoundRadius=s,this._lowerBoundEarthRadius=-1,this._updateVisibleElevationBounds())},f._updateVisibleElevationBounds=function(){const e=this._adjustRadiusForTesselation(d.earth.radius+this._view.basemapTerrain.elevationBounds.min);(this._lowerBoundEarthRadius<0||e<this._lowerBoundEarthRadius)&&this._updateRadius(e)},f._updateRadius=function(e){this._lowerBoundEarthRadius=e,n.set(this._radii,e,e+c.atmosphereHeight),this._innerFadeDistance=2*Math.sqrt((2*e-c.innerAtmosphereDepth)*c.innerAtmosphereDepth)},f._update=function(e){if(i.isNone(e))return;this._cameraHeight=o.length(e.eye),this._cameraHeightSq=this._cameraHeight*this._cameraHeight,this._cAtmosphere=this._cameraHeightSq-this._radii[1]*this._radii[1];const t=Math.min(1,Math.max(0,(this._cameraHeight-this._radii[0])/c.atmosphereHeight));this._heightParameters=_.fromValues(this._cameraHeight,this._cameraHeightSq,this._cAtmosphere,t),o.copy(this._cameraPosition,e.eye),a.invert(this._projectionInverse,e.projectionMatrix),a.invert(this._viewInverse,e.viewMatrix),n.set(this._nearFar,e.near,e.far),this._altitudeFade=c.computeInnerAltitudeFade(this._cameraHeight-this._lowerBoundEarthRadius)},e.isSupported=function(e){return e.renderContext.rctx.capabilities.depthTexture},e}();e.ChapmanAtmosphere=f,Object.defineProperty(e,"__esModule",{value:!0})}));
