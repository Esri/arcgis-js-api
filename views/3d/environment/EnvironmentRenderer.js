/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/has","../../../core/Handles","../../../core/mathUtils","../../../core/maybe","../../../core/reactiveUtils","../../../core/time","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec3","../../../chunks/vec3f64","../../../geometry/projectionEllipsoid","../../../geometry/support/spatialReferenceUtils","./AtmosphereType","./ChapmanAtmosphere","./CloudsComposition","./CloudsCompositionParameters","./CloudsData","./CloudsGenerator","./CloudsPresets","./Fog","./PanoramicAtmosphere","./Precipitation","./SimpleAtmosphere","./SimpleHaze","./Stars","./weather","./weatherUtils","../webgl-engine/core/shaderLibrary/ShaderOutput","../webgl-engine/lib/RenderSlot","../webgl-engine/lib/Update"],(function(e,t,r,s,i,n,a,o,h,d,p,c,l,m,_,u,g,y,w,f,v,P,b,R,S,E,A,N,T,C,z,W,x,F,M,O){"use strict";var k;const I=[M.RenderSlot.POSTPROCESSING_ENVIRONMENT_OPAQUE,M.RenderSlot.POSTPROCESSING_ENVIRONMENT_TRANSPARENT];e.EnvironmentRenderer=k=function(e){function r(t){var r;return(r=e.call(this,t)||this)._handles=new n,r._context=null,r._atmosphere=null,r._oldWeatherParameters=new H,r._newWeatherParameters=new H,r._fadedWeatherParameters=new H,r._weatherParameters=r._newWeatherParameters,r}t._inheritsLoose(r,e);var s=r.prototype;return s.initialize=function(){this.view._stage.addRenderPlugin(I,this)},s.destroy=function(){null!=this.view?._stage&&this.view._stage.removeRenderPlugin(this),this._handles=o.destroyMaybe(this._handles),this._set("view",null)},s.updateAnimation=function(e){return!!o.isSome(this._precipitation)&&this._precipitation.update(e)},s.initializeRenderContext=function(e=null){this._context=e;const t=()=>this._setNeedsRender();this._handles.add([h.when((()=>this.view?.basemapTerrain),(()=>this._updateBasemapTerrain()),h.syncAndInitial),h.watch((()=>({viewingMode:this.view.viewingMode,atmosphereEnabled:this.view.environment.atmosphereEnabled,atmosphereQuality:this.view.environment.atmosphere.quality})),(()=>this._updateAtmosphere()),h.syncAndInitial),h.watch((()=>this._stars),t),h.watch((()=>this._precipitation),t),h.watch((()=>this._clouds),(()=>this._updateWeather()),h.initial),h.watch((()=>this._fog),(()=>this._updateFogHaze()),h.initial),h.watch((()=>this._simpleHaze),(()=>this._updateFogHaze()),h.initial),h.watch((()=>this._weatherUpdateParameters),(()=>{this._updateWeather(),this._updateFogHaze()}),h.syncAndInitial)])},s.uninitializeRenderContext=function(){this._context=null,this._atmosphere=o.destroyMaybe(this._atmosphere),this._set("_stars",o.destroyMaybe(this._stars)),this._set("_precipitation",o.destroyMaybe(this._precipitation)),this._set("_clouds",o.destroyMaybe(this._clouds)),this._set("_cloudsComposition",o.destroyMaybe(this._cloudsComposition)),this._set("_fog",o.destroyMaybe(this._fog)),this._set("_simpleHaze",o.destroyMaybe(this._simpleHaze))},s.prepareRender=function(e){e.bindParameters.cloudsFade.data=b.isReadyCloudsData(this._clouds)?this._clouds:null,"local"!==this.view.viewingMode&&(x.updateWeatherFading(e.bindParameters.cloudsFade,e.bindParameters.camera,this.view.state.mode,k.test.time||e.time,this.view.qualitySettings.weatherFadeDuration),this._updateWeatherFading(e.bindParameters),e.bindParameters.cloudsFade.renderingStage===b.CloudsRenderingStages.FINISHED&&o.isSome(this._clouds)&&0===this._clouds.coverage&&!1===this._clouds.running&&this._clouds.destroyFrameBufferCube())},s.render=function(e){if(e.output===F.ShaderOutput.Color)switch(e.bindParameters.slot){case M.RenderSlot.POSTPROCESSING_ENVIRONMENT_OPAQUE:o.isSome(this._stars)&&this._stars.render(e),o.isSome(this._atmosphere)&&(this._atmosphere.render(e),o.isSome(this._cloudsComposition)&&o.isSome(e.bindParameters.cloudsFade.data)&&(this.weatherVisible&&o.isSome(this._clouds)&&this._clouds.updateWeatherTile(),this._cloudsComposition.render(e)),x.weatherfadingNeedsRender(e.bindParameters.cloudsFade)&&o.isSome(this._context)&&this._context.requestRender());break;case M.RenderSlot.POSTPROCESSING_ENVIRONMENT_TRANSPARENT:if(o.isSome(this._atmosphere)&&(this._atmosphere.renderHaze(e,this._weatherParameters.haze.amount),this._weatherParameters.haze.amount>0&&this._selectAtmosphereType()!==w.AtmosphereType.Realistic&&o.isSome(this._simpleHaze)&&this._simpleHaze.render(e,this._weatherParameters.haze),this._weatherParameters.fog.amount>0&&o.isSome(this._fog)&&this._fog.render(e,this._weatherParameters.fog),o.isSome(this._precipitation))){const t=this.view.environment.weather;"rainy"!==t.type&&"snowy"!==t.type||this._precipitation.render(e,t.precipitation,t.type)}}},s.updateLightSources=function(e,t,r,s){if(o.isSome(this._context)){const i=this._context.renderContext;i.bindParameters.oldLighting.copyFrom(i.bindParameters.lighting),i.bindParameters.newLighting.noonFactor=t,i.bindParameters.newLighting.globalFactor=r,i.bindParameters.newLighting.set(e);s===O.Update.Faded||i.bindParameters.weatherFading?i.bindParameters.fadeLighting(0):i.bindParameters.fadeLighting(1),this._context.requestRender()}},s._updateWeatherFading=function(e){if(!e.weatherFading)return;const t=e.cloudsFade;return t.fadeIn.stage===P.FadeInStages.FADE_IN?(e.fadeLighting(t.fadeIn.factor),void this._fadeWeather(t.fadeIn.factor)):t.fadeInOut.stage===P.FadeInOutStages.FADE_IN?(e.fadeLighting(t.fadeInOut.factor),void this._fadeWeather(t.fadeInOut.factor)):t.crossFade.enabled?(e.fadeLighting(t.crossFade.factor),void this._fadeWeather(t.crossFade.factor)):(e.fadeLighting(0),void this._fadeWeather(0))},s._fadeWeather=function(e){const{_newWeatherParameters:t,_oldWeatherParameters:r}=this;e>=1?this._weatherParameters=t:(this._fadedWeatherParameters.lerp(r,t,e),this._weatherParameters=this._fadedWeatherParameters)},s._updateWeather=function(){const e=this._weatherUpdateParameters;o.isNone(e)||o.isNone(this._clouds)||(this._clouds.applyPreset(S.cloudPresets[e.type],e.weatherAdjustment),this._setNeedsRender())},s._setNeedsRender=function(){o.isSome(this._context)&&this._context.requestRender()},s._updateFogHaze=function(){const e=this._weatherUpdateParameters;if(o.isNone(this._fog)||o.isNone(this._simpleHaze)||o.isNone(e)||o.isNone(this._context))return;const t=this._context.renderContext.bindParameters;switch(this._oldWeatherParameters.copyFrom(this._weatherParameters),e.type){case"foggy":this._newWeatherParameters.fog.strength=a.lerp(3e-5,.005,e.weatherAdjustment**3),_.copy(this._newWeatherParameters.fog.color,U),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.haze.strength=0,this._newWeatherParameters.haze.amount=this._selectAtmosphereType()===w.AtmosphereType.Realistic?1:0,this._setNeedsRender();break;case"rainy":this._newWeatherParameters.fog.strength=a.lerp(4e-6,2e-4,e.effect**3),_.copy(this._newWeatherParameters.fog.color,L),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.haze.strength=0,this._newWeatherParameters.haze.amount=0,this._setNeedsRender();break;case"snowy":this._newWeatherParameters.fog.strength=a.lerp(4e-6,2e-4,e.effect**3),_.copy(this._newWeatherParameters.fog.color,U),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.haze.strength=0,this._newWeatherParameters.haze.amount=this._selectAtmosphereType()===w.AtmosphereType.Realistic?1:0,this._setNeedsRender();break;default:this._newWeatherParameters.fog.strength=0,this._newWeatherParameters.fog.amount=0,this._newWeatherParameters.haze.strength=4e-6,this._newWeatherParameters.haze.amount=1,this._setNeedsRender()}t.weatherFading?this._fadeWeather(0):this._fadeWeather(1)},s._updateAtmosphere=function(){const e=this._selectAtmosphereType();if(this.atmosphereType===e)return;const t=this._getAtmosphereClass();if(!t)return o.isSome(this._atmosphere)&&(this._atmosphere.destroy(),this._atmosphere=null,this._setNeedsRender()),void this._updateBasemapTerrain();o.isSome(this._context)&&(o.destroyMaybe(this._atmosphere),this._atmosphere=new t(this.view),this._atmosphere.initializeRenderContext(this._context),this._setNeedsRender(),this._updateBasemapTerrain())},s._getAtmosphereClass=function(){switch(this._selectAtmosphereType()){case w.AtmosphereType.None:return null;case w.AtmosphereType.Realistic:return f.ChapmanAtmosphere;case w.AtmosphereType.Panoramic:return A.PanoramicAtmosphere;case w.AtmosphereType.Simple:return T;default:return}},s._selectAtmosphereType=function(){const e=this.view.get("environment.atmosphereEnabled"),t=this.view.get("environment.atmosphere.quality"),r=this.view.viewingMode;return!e||null==t||y.isMoon(this.view.spatialReference)?w.AtmosphereType.None:"local"===r?w.AtmosphereType.Panoramic:"high"===t&&o.isSome(this._context)&&f.ChapmanAtmosphere.isSupported(this._context)&&y.isEarth(this.view.spatialReference)?w.AtmosphereType.Realistic:w.AtmosphereType.Simple},s._updateBasemapTerrain=function(){this.view.basemapTerrain&&(this.view.basemapTerrain.velvetOverground=o.isSome(this._atmosphere)&&this.atmosphereType===w.AtmosphereType.Simple)},t._createClass(r,[{key:"atmosphereType",get:function(){return o.isSome(this._atmosphere)?this._atmosphere.type:w.AtmosphereType.None}},{key:"canRender",get:function(){return!!this.view.basemapTerrain?.renderer.canRender||"global"!==this.view.viewingMode}},{key:"needsLinearDepth",get:function(){return o.isSome(this._atmosphere)&&this._atmosphere.type===w.AtmosphereType.Realistic}},{key:"updating",get:function(){return o.isSome(this._stars)&&this._stars.updating||o.isSome(this._clouds)&&this._clouds.running}},{key:"weatherVisible",get:function(){return _.length(this.view.state.camera.eye)-g.getReferenceEllipsoid(this.view.spatialReference).radius<=W.weatherHeightLimit}},{key:"_stars",get:function(){const e=this.view,t=e.environment?.starsEnabled??!1,r=this._get("_stars");return!t||o.isNone(this._context)?(o.destroyMaybe(r),null):o.isSome(r)?r:new z.Stars({view:e,requestRender:()=>this._setNeedsRender()})}},{key:"_precipitation",get:function(){const e=this._get("_precipitation");if(!this._precipitationEnabled||o.isNone(this._context))return o.destroyMaybe(e),null;const t=this.view,r=this._context;return o.isSome(e)&&e.context===r?e:(o.destroyMaybe(e),new N.Precipitation({context:r,view:t}))}},{key:"_clouds",get:function(){const e=this._get("_clouds");if(!this.weatherEnabled||o.isNone(this._context))return o.destroyMaybe(e),null;if(o.isSome(e))return e;const t=this.view,r=this._context;return o.destroyMaybe(e),new R.CloudsGenerator({context:r,view:t,requestRender:()=>this._setNeedsRender()})}},{key:"_cloudsComposition",get:function(){const e=this._get("_cloudsComposition");if(!this.weatherEnabled||o.isNone(this._context))return o.destroyMaybe(e),null;const t=this.view.state.viewingMode,r=this._context.renderContext.rctx,s=g.getReferenceEllipsoid(this.view.spatialReference).radius;return o.isSome(e)&&e.viewingMode===t&&e.planetRadius===s?e:(o.destroyMaybe(e),new v.CloudsComposition({rctx:r,viewingMode:t,planetRadius:s,requestRender:()=>this._setNeedsRender()}))}},{key:"_fog",get:function(){const e=this._get("_fog");if(!this.weatherEnabled||o.isNone(this._context))return o.destroyMaybe(e),null;if(o.isSome(e))return e;const t=this.view,r=this._context;return new E.Fog({context:r,view:t})}},{key:"_simpleHaze",get:function(){const e=this._get("_simpleHaze");if(!this.weatherEnabled||o.isNone(this._context))return o.destroyMaybe(e),null;if(o.isSome(e))return e;const t=this.view,r=this._context;return new C.SimpleHaze({context:r,view:t})}},{key:"weatherEnabled",get:function(){return!!this.view?.environmentManager?.weatherEnabled}},{key:"_precipitationEnabled",get:function(){return this.weatherEnabled&&("rainy"===this.view.environment.weather.type||"snowy"===this.view.environment.weather.type)}},{key:"_weatherUpdateParameters",get:function(){const e=this.weatherEnabled?this.view.environment.weather:null;return o.isNone(e)?null:"rainy"===e.type||"snowy"===e.type?{type:e.type,weatherAdjustment:e.cloudCover,effect:e.precipitation}:{type:e.type,weatherAdjustment:"foggy"===e.type?e.fogStrength:e.cloudCover}}},{key:"test",get:function(){return{atmosphere:this._atmosphere,clouds:this._clouds,selectAtmosphereType:()=>this._selectAtmosphereType(),stubGetAtmosphereClass:e=>{q=k.prototype._getAtmosphereClass,k.prototype._getAtmosphereClass=e},restoreGetAtmosphereClass:()=>{k.prototype._getAtmosphereClass=q}}}}]),r}(s),e.EnvironmentRenderer.test={time:d.Milliseconds(0)},r.__decorate([p.property({constructOnly:!0})],e.EnvironmentRenderer.prototype,"view",void 0),r.__decorate([p.property({type:Boolean,readOnly:!0})],e.EnvironmentRenderer.prototype,"updating",null),r.__decorate([p.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"weatherVisible",null),r.__decorate([p.property()],e.EnvironmentRenderer.prototype,"_context",void 0),r.__decorate([p.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"_stars",null),r.__decorate([p.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"_precipitation",null),r.__decorate([p.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"_clouds",null),r.__decorate([p.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"_cloudsComposition",null),r.__decorate([p.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"_fog",null),r.__decorate([p.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"_simpleHaze",null),r.__decorate([p.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"weatherEnabled",null),r.__decorate([p.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"_precipitationEnabled",null),r.__decorate([p.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"_weatherUpdateParameters",null),e.EnvironmentRenderer=k=r.__decorate([m.subclass("esri.views.3d.environment.EnvironmentRenderer")],e.EnvironmentRenderer);let H=function(){function e(){this.fog=new E.FogParameters,this.haze=new C.HazeParameters}var t=e.prototype;return t.copyFrom=function(e){this.fog.amount=e.fog.amount,this.haze.amount=e.haze.amount,this.fog.strength=e.fog.strength,this.haze.strength=e.haze.strength,_.copy(this.fog.color,e.fog.color)},t.lerp=function(e,t,r){this.fog.amount=a.lerp(e.fog.amount,t.fog.amount,r),this.haze.amount=a.lerp(e.haze.amount,t.haze.amount,r),this.fog.strength=a.lerp(e.fog.strength,t.fog.strength,r),this.haze.strength=a.lerp(e.haze.strength,t.haze.strength,r),_.lerp(this.fog.color,e.fog.color,t.fog.color,r)},e}();const L=u.fromValues(.5,.5,.5),U=u.fromValues(1.5,1.5,1.5);let q;e.WeatherParameters=H,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
