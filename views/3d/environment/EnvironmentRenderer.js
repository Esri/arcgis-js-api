/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/has","../../../core/Handles","../../../core/lang","../../../core/mathUtils","../../../core/maybe","../../../core/reactiveUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec3","../../../geometry/projectionEllipsoid","../../../geometry/support/spatialReferenceUtils","./ChapmanAtmosphere","./CloudsComposition","./CloudsGenerator","./Fog","./PanoramicAtmosphere","./SimpleAtmosphere","./Stars"],(function(e,t,s,r,i,n,o,a,h,p,d,l,c,_,u,m,y,g,v,w,f,R,A,b){"use strict";const C=[12,13];e.EnvironmentRenderer=function(e){function s(t){var s;return(s=e.call(this,t)||this)._handles=new n,s._context=null,s._pendingAtmosphere=null,s._atmosphere=null,s._stars=null,s._clouds=null,s._cloudComposition=null,s._fog=null,s}t._inheritsLoose(s,e);var r=s.prototype;return r.initialize=function(){this.view._stage.addRenderPlugin(C,this)},r.destroy=function(){this._pendingAtmosphere=h.destroyMaybe(this._pendingAtmosphere),this.uninitializeRenderContext(),this._handles=h.destroyMaybe(this._handles),this.view&&null!=this.view._stage&&(this.view._stage.removeRenderPlugin(this),this._set("view",null))},r.initializeRenderContext=function(e=null){this._context=e,this._handles.add([d.when(this.view,"basemapTerrain",(()=>this._updateBasemapTerrain()),!0),p.react((()=>({viewingMode:this.view.viewingMode,atmosphereEnabled:this.view.environment.atmosphereEnabled,atmosphereQuality:this.view.environment.atmosphere.quality})),(()=>this._updateAtmosphere()),p.syncAndInitial),p.react((()=>this._starsCreationParameters),(e=>this._createOrDestroyStars(e)),{sync:!0,initial:!0,equals:o.equalsShallow}),p.react((()=>this._cloudsCreationParameters),(e=>this._createOrDestroyClouds(e)),{sync:!0,initial:!0,equals:o.equalsShallow}),p.react((()=>this._fogCreationParameters),(e=>this._createOrDestroyFog(e)),{sync:!0,initial:!0,equals:o.equalsShallow}),p.react((()=>this._weatherUpdateParameters),(e=>{this._updateWeather(e),this._updateFog(e)}),p.syncAndInitial)])},r.uninitializeRenderContext=function(){this._stars=h.destroyMaybe(this._stars),this._atmosphere=h.destroyMaybe(this._atmosphere),this._clouds=h.destroyMaybe(this._clouds),this._cloudComposition=h.destroyMaybe(this._cloudComposition),this._fog=h.destroyMaybe(this._fog)},r.render=function(e){if(0!==e.pass)return!1;let t=!1;switch(e.slot){case 12:h.isSome(this._stars)&&this._stars.render(e)&&(t=!0),h.isSome(this._atmosphere)&&this._atmosphere.canRender&&(this._atmosphere.render(e)&&(t=!0),h.isSome(this._clouds)&&h.isSome(this._clouds.cubeMap)&&!this._clouds.running&&h.isSome(this._cloudComposition)&&("sunny"!==this.view.environment.weather.type||0!==this.view.environment.weather.cloudCover)&&(this._cloudComposition.render(e,this._clouds.cubeMap,h.isSome(this.view.animation),this._clouds.coverage,this._clouds.absorption)&&(t=!0),this._cloudComposition.isFading()&&this._setNeedsRender()));break;case 13:if(h.isSome(this._atmosphere)&&this._atmosphere.canRender){const s=this.weatherEnabled?this.view.environment.weather.type:"disabled";this._atmosphere.renderHaze(e,"rainy"===s)&&(t=!0),h.isSome(this._fog)&&("foggy"!==s&&"realistic"===this._selectAtmosphereType()||this._fog.render(e,"foggy"===s,"rainy"===s)&&(t=!0))}break;default:return!1}return t},r._createOrDestroyClouds=function(e){this._clouds=h.destroyMaybe(this._clouds),this._cloudComposition=h.destroyMaybe(this._cloudComposition),h.applySome(e,(({view:e,viewingMode:t,rctx:s,radius:r})=>{this._clouds=new w.CloudsGenerator({rctx:s,view:e,requestRender:()=>this._setNeedsRender()}),this._cloudComposition=new v.CloudsComposition(s,t,r,u.length(e.state.camera.eye)-r)})),this._setNeedsRender()},r._updateWeather=function(e){if(h.isNone(e)||h.isNone(this._clouds))return;const t=w.cloudPresets[e.type].median;for(const s in w.cloudPresets[e.type])if("raymarchingStepType"===s)this._clouds[s]=w.cloudPresets[e.type][s];else if("median"!==s){const r=w.cloudPresets[e.type][s],i=a.lerp(r[0],r[1],t);this._clouds[s]=e.presetAdjustment<.5?a.lerp(r[0],i,2*e.presetAdjustment):a.lerp(i,r[1],2*(e.presetAdjustment-.5))}},r._setNeedsRender=function(){h.isSome(this._context)&&this._context.requestRender()},r._createOrDestroyStars=function({view:e,starsEnabled:t}){t&&h.isNone(this._stars)?(this._stars=new b.Stars({view:e,requestRender:()=>this._setNeedsRender()}),this._setNeedsRender()):!t&&h.isSome(this._stars)&&(this._stars.destroy(),this._stars=null,this._setNeedsRender())},r._updateFog=function(e){h.isNone(this._fog)||h.isNone(e)||("foggy"===e.type?this._fog.strength=a.lerp(3e-5,.005,e.presetAdjustment**3):this._fog.strength=4e-6)},r._createOrDestroyFog=function(e){this.weatherEnabled&&h.isNone(this._fog)?(h.applySome(e,(({view:e,context:t})=>{this._fog=new f.Fog(t,e)})),this._updateFog(this._weatherUpdateParameters),this._setNeedsRender()):h.isSome(this._fog)&&(this._fog.destroy(),this._fog=null,this._setNeedsRender())},r._updateAtmosphere=function(){const e=this._selectAtmosphereType();if(this.atmosphereType===e)return;h.isSome(this._pendingAtmosphere)&&(this._pendingAtmosphere!==this._atmosphere&&this._pendingAtmosphere.destroy(),this._pendingAtmosphere=null);const t=this._getAtmosphereClass();if(!t)return h.isSome(this._atmosphere)&&(this._atmosphere.destroy(),this._atmosphere=null,this._setNeedsRender()),void this._updateBasemapTerrain();const s=new t(this.view);h.isSome(this._context)&&s.initializeRenderContext(this._context),h.isNone(this._atmosphere)&&(this._atmosphere=s,this._setNeedsRender()),this._pendingAtmosphere=s,s.when().then((()=>{h.isSome(this._atmosphere)&&this._pendingAtmosphere&&this._pendingAtmosphere!==this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=this._pendingAtmosphere),this._pendingAtmosphere=null,this._setNeedsRender(),this._updateBasemapTerrain()})).catch((()=>{this._pendingAtmosphere===s&&(this._pendingAtmosphere=null)}))},r._getAtmosphereClass=function(){switch(this._selectAtmosphereType()){case"none":return null;case"realistic":return g.ChapmanAtmosphere;case"panoramic":return R.PanoramicAtmosphere;case"simple":return A;default:return}},r._selectAtmosphereType=function(){const e=this.view.get("environment.atmosphereEnabled"),t=this.view.get("environment.atmosphere.quality"),s=this.view.viewingMode;return!e||null==t||y.isMoon(this.view.spatialReference)?"none":"local"===s?"panoramic":"high"===t&&h.isSome(this._context)&&g.ChapmanAtmosphere.isSupported(this._context)&&y.isEarth(this.view.spatialReference)?"realistic":"simple"},r._updateBasemapTerrain=function(){this.view.basemapTerrain&&(this.view.basemapTerrain.velvetOverground=h.isSome(this._atmosphere)&&"simple"===this.atmosphereType)},t._createClass(s,[{key:"atmosphereType",get:function(){return h.isSome(this._pendingAtmosphere)?this._pendingAtmosphere.type:h.isSome(this._atmosphere)?this._atmosphere.type:"none"}},{key:"canRender",get:function(){var e;return!(null==(e=this.view.basemapTerrain)||!e.renderer.canRender)||"global"!==this.view.viewingMode}},{key:"needsLinearDepth",get:function(){return"realistic"===this._selectAtmosphereType()}},{key:"updating",get:function(){return h.isSome(this._pendingAtmosphere)||h.isSome(this._stars)&&this._stars.updating||h.isSome(this._clouds)&&this._clouds.running}},{key:"weatherEnabled",get:function(){var e;return!(null==(e=this.view.environmentManager)||!e.weatherEnabled)}},{key:"_cloudsCreationParameters",get:function(){return this.weatherEnabled?{view:this.view,viewingMode:this.view.state.viewingMode,rctx:h.isSome(this._context)?this._context.renderContext.rctx:null,radius:m.getReferenceEllipsoid(this.view.spatialReference).radius}:null}},{key:"_weatherUpdateParameters",get:function(){const e=this.weatherEnabled?this.view.environment.weather:null;return h.isNone(e)?null:{type:e.type,presetAdjustment:"foggy"===e.type?e.fogStrength:e.cloudCover}}},{key:"_starsCreationParameters",get:function(){var e,t,s;return{view:this.view,starsEnabled:null!=(e=null==(t=this.view)||null==(s=t.environment)?void 0:s.starsEnabled)&&e}}},{key:"_fogCreationParameters",get:function(){return!this.weatherEnabled||h.isNone(this._context)?null:{view:this.view,context:this._context}}},{key:"test",get:function(){return{atmosphere:this._atmosphere,clouds:this._clouds,selectAtmosphereType:()=>this._selectAtmosphereType()}}}]),s}(r),s.__decorate([l.property({constructOnly:!0})],e.EnvironmentRenderer.prototype,"view",void 0),s.__decorate([l.property({type:Boolean,readOnly:!0})],e.EnvironmentRenderer.prototype,"updating",null),s.__decorate([l.property()],e.EnvironmentRenderer.prototype,"_pendingAtmosphere",void 0),s.__decorate([l.property()],e.EnvironmentRenderer.prototype,"_stars",void 0),s.__decorate([l.property()],e.EnvironmentRenderer.prototype,"_clouds",void 0),s.__decorate([l.property()],e.EnvironmentRenderer.prototype,"_cloudComposition",void 0),s.__decorate([l.property()],e.EnvironmentRenderer.prototype,"_fog",void 0),s.__decorate([l.property()],e.EnvironmentRenderer.prototype,"weatherEnabled",null),s.__decorate([l.property()],e.EnvironmentRenderer.prototype,"_cloudsCreationParameters",null),s.__decorate([l.property()],e.EnvironmentRenderer.prototype,"_weatherUpdateParameters",null),s.__decorate([l.property()],e.EnvironmentRenderer.prototype,"_starsCreationParameters",null),s.__decorate([l.property()],e.EnvironmentRenderer.prototype,"_fogCreationParameters",null),e.EnvironmentRenderer=s.__decorate([_.subclass("esri.views.3d.environment.EnvironmentRenderer")],e.EnvironmentRenderer),Object.defineProperty(e,"__esModule",{value:!0})}));
