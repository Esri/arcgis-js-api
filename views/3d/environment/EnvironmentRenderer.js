/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/has","../../../core/Handles","../../../core/maybe","../../../core/watchUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/Logger","../../../core/accessorSupport/decorators/subclass","../../../geometry/support/spatialReferenceUtils","./PanoramicAtmosphere","./RealisticAtmosphere","./SimpleAtmosphere","./Stars"],(function(e,t,s,i,r,n,o,h,a,p,_,d,l,m,c,u){"use strict";const v=[14,15];let y=function(t){function s(){var e;return(e=t.apply(this,arguments)||this)._handles=new r,e._context=null,e._pendingAtmosphere=null,e._atmosphere=null,e._stars=null,e}e._inheritsLoose(s,t);var i=s.prototype;return i.initialize=function(){this.view._stage.addRenderPlugin(v,this)},i.destroy=function(){this._pendingAtmosphere=n.destroyMaybe(this._pendingAtmosphere),this._atmosphere=n.destroyMaybe(this._atmosphere),this._stars=n.destroyMaybe(this._stars),this._handles=n.destroyMaybe(this._handles),this.view&&null!=this.view._stage&&(this.view._stage.removeRenderPlugin(this),this._set("view",null))},i.initializeRenderContext=function(e){this._context=e,this.setup()},i.setup=function(){this._handles.add(o.when(this.view,"basemapTerrain",(()=>this._updateBasemapTerrain()),!0)),this._handles.add([o.init(this.view,["viewingMode","environment.atmosphereEnabled","environment.atmosphere.quality"],(()=>this._updateAtmosphere()),!0),o.init(this.view,"environment.starsEnabled",(()=>this._updateStars()),!0)])},i.uninitializeRenderContext=function(){n.isSome(this._stars)&&(this._stars.uninitializeRenderContext(),this._stars.destroy(),this._stars=null),n.isSome(this._atmosphere)&&(this._atmosphere.uninitializeRenderContext(),this._atmosphere.destroy(),this._atmosphere=null)},i.render=function(e){let t=!0;return n.isSome(this._stars)&&this._stars.canRender&&(t=this._stars.render(e)&&t),n.isSome(this._atmosphere)&&this._atmosphere.canRender&&(t=this._atmosphere.render(e)&&t),t},i._setNeedsRender=function(){this._context&&this._context.requestRender()},i._updateStars=function(){var e,t,s;const i=null!=(e=null==(t=this.view)||null==(s=t.environment)?void 0:s.starsEnabled)&&e;i&&n.isNone(this._stars)?(this._stars=new u.Stars({view:this.view}),this._stars.initializeRenderContext(this._context),this._setNeedsRender()):!i&&n.isSome(this._stars)&&(this._stars.destroy(),this._stars=null,this._setNeedsRender())},i._updateAtmosphere=function(){const e=this._getAtmosphereType();if(this.atmosphereType===e)return;this.atmosphereType=e,n.isSome(this._pendingAtmosphere)&&(this._pendingAtmosphere!==this._atmosphere&&this._pendingAtmosphere.destroy(),this._pendingAtmosphere=null);const t=this._getAtmosphereClass();if(!t)return n.isSome(this._atmosphere)&&(this._atmosphere.destroy(),this._atmosphere=null,this._setNeedsRender()),void this._updateBasemapTerrain();const s=new t(this.view);s.initializeRenderContext(this._context),n.isNone(this._atmosphere)&&(this._atmosphere=s,this._setNeedsRender()),this._pendingAtmosphere=s,s.when().then((()=>{n.isSome(this._atmosphere)&&this._pendingAtmosphere!==this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=this._pendingAtmosphere),this._pendingAtmosphere=null,this._setNeedsRender(),this._updateBasemapTerrain()})).catch((()=>{this._pendingAtmosphere===s&&(this._pendingAtmosphere=null)}))},i._getAtmosphereClass=function(){const e=this._getAtmosphereType();if(this.atmosphereClassFromType)return this.atmosphereClassFromType(e);switch(e){case"none":return null;case"realistic":return m.RealisticAtmosphere;case"panoramic":return l;case"simple":return c;default:return}},i._getAtmosphereType=function(){const e=this.view.get("environment.atmosphereEnabled"),t=this.view.get("environment.atmosphere.quality"),s=this.view.viewingMode;return!e||null==t||d.isMoon(this.view.spatialReference)?"none":"local"===s?"panoramic":"high"===t&&m.RealisticAtmosphere.isSupported(this._context)&&!d.isMars(this.view.spatialReference)?"realistic":"simple"},i._updateBasemapTerrain=function(){const e=this.view.basemapTerrain;e&&(e.velvetOverground=null!=this._atmosphere&&"simple"===this.atmosphereType)},e._createClass(s,[{key:"canRender",get:function(){return!(!this.view.basemapTerrain||!this.view.basemapTerrain.renderer.canRender)||"global"!==this.view.viewingMode}},{key:"updating",get:function(){return n.isSome(this._pendingAtmosphere)||n.isSome(this._stars)&&this._stars.updating}},{key:"test",get:function(){return{atmosphere:this._atmosphere}}}]),s}(s);return t.__decorate([h.property({constructOnly:!0})],y.prototype,"view",void 0),t.__decorate([h.property({constructOnly:!0})],y.prototype,"atmosphereClassFromType",void 0),t.__decorate([h.property()],y.prototype,"updating",null),t.__decorate([h.property()],y.prototype,"_pendingAtmosphere",void 0),t.__decorate([h.property()],y.prototype,"_stars",void 0),y=t.__decorate([_.subclass("esri.views.3d.environment.EnvironmentRenderer")],y),y}));
