/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/has","../../../core/mathUtils","../../../core/maybe","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec3","../../../chunks/vec3f64","../../../geometry/ellipsoidUtils","../../../geometry/support/spatialReferenceUtils","../../ViewingMode","./AtmosphereType","./ChapmanAtmosphere","./CloudsComposition","./CloudsCompositionParameters","./CloudsData","./CloudsGenerator","./CloudsPresets","./Fog","./PanoramicAtmosphere","./Precipitation","./SimpleAtmosphere","./SimpleHaze","./Stars","./weather","./weatherUtils","../webgl-engine/core/shaderLibrary/ShaderOutput","../webgl-engine/lib/RenderFeature","../webgl-engine/lib/RenderSlot","../webgl-engine/lib/Update"],(function(e,t,r,s,i,n,a,o,h,d,p,c,m,l,_,u,y,g,w,f,v,P,b,R,S,A,E,N,T,C,W,x,z,F,M,O){"use strict";var k;const I=[M.RenderSlot.POSTPROCESSING_ENVIRONMENT_OPAQUE,M.RenderSlot.POSTPROCESSING_ENVIRONMENT_TRANSPARENT];e.EnvironmentRenderer=k=function(e){function r(t){var r;return(r=e.call(this,t)||this)._context=null,r._atmosphere=null,r._hqAtmosphere=null,r._oldWeatherParameters=new H,r._newWeatherParameters=new H,r._fadedWeatherParameters=new H,r._weatherParameters=r._newWeatherParameters,r}t._inheritsLoose(r,e);var s=r.prototype;return s.initialize=function(){this.view._stage.addRenderPlugin(I,this)},s.destroy=function(){this.removeHandles(),null!=this.view?._stage&&this.view._stage.removeRenderPlugin(this),this._set("view",null)},s.updateAnimation=function(e){return!!a.isSome(this._precipitation)&&this._precipitation.update(e)},s.initializeRenderContext=function(e=null){this._context=e;const t=()=>this._setNeedsRender();this.addHandles([o.when((()=>this.view?.basemapTerrain),(()=>this._updateBasemapTerrain()),o.syncAndInitial),o.watch((()=>({viewingMode:this.view.state.viewingMode,enabled:this.view.environment.atmosphereEnabled,quality:this.view.environment.atmosphere.quality})),(e=>this._updateAtmosphere(e)),o.syncAndInitial),o.watch((()=>this._stars),t),o.watch((()=>this._precipitation),t),o.watch((()=>this._clouds),(()=>this._updateWeather()),o.initial),o.watch((()=>this._fog),(()=>this._updateFogHaze()),o.initial),o.watch((()=>this._simpleHaze),(()=>this._updateFogHaze()),o.initial),o.watch((()=>this.view.state.mode),(()=>{this._setNeedsRender()}),o.sync),o.watch((()=>this._atmosphereType),(()=>this._updateBasemapTerrain()),o.syncAndInitial),o.watch((()=>this._weatherUpdateParameters),(()=>{this._updateWeather(),this._updateFogHaze()}),o.syncAndInitial)])},s.uninitializeRenderContext=function(){this._context=null,this._atmosphere=a.destroyMaybe(this._atmosphere),this._hqAtmosphere=a.destroyMaybe(this._hqAtmosphere),this._set("_stars",a.destroyMaybe(this._stars)),this._set("_precipitation",a.destroyMaybe(this._precipitation)),this._set("_clouds",a.destroyMaybe(this._clouds)),this._set("_cloudsComposition",a.destroyMaybe(this._cloudsComposition)),this._set("_fog",a.destroyMaybe(this._fog)),this._set("_simpleHaze",a.destroyMaybe(this._simpleHaze))},s.prepareRender=function(e){e.bindParameters.cloudsFade.data=P.isReadyCloudsData(this._clouds)?this._clouds:null,"local"!==this.view.viewingMode&&(x.updateWeatherFading(e.bindParameters.cloudsFade,e.bindParameters.camera,this.view.state.mode,e.time,this.view.qualitySettings.fadeDuration),this._updateWeatherFading(e.bindParameters),e.bindParameters.cloudsFade.renderingStage===P.CloudsRenderingStages.FINISHED&&a.isSome(this._clouds)&&0===this._clouds.coverage&&!1===this._clouds.running&&(this._clouds.destroyFrameBufferCube(),e.bindParameters.cloudsFade.data=null))},s.render=function(e){if(e.output===z.ShaderOutput.Color)switch(e.bindParameters.slot){case M.RenderSlot.POSTPROCESSING_ENVIRONMENT_OPAQUE:a.isSome(this._stars)&&this._stars.render(e),a.isSome(this.atmosphere)&&(this.atmosphere.render(e),a.isSome(this._cloudsComposition)&&a.isSome(e.bindParameters.cloudsFade.data)&&(this.weatherVisible&&a.isSome(this._clouds)&&this._clouds.updateWeatherTile(),this._cloudsComposition.render(e)),x.weatherFadingNeedsRender(e.bindParameters.cloudsFade)&&a.isSome(this._context)&&this._context.requestRender());break;case M.RenderSlot.POSTPROCESSING_ENVIRONMENT_TRANSPARENT:if(a.isSome(this.atmosphere)&&(this.atmosphere.renderHaze(e,this._weatherParameters.haze.amount),this._weatherParameters.haze.amount>0&&this._atmosphereType!==g.AtmosphereType.Realistic&&a.isSome(this._simpleHaze)&&this._simpleHaze.render(e,this._weatherParameters.haze),this._weatherParameters.fog.amount>0&&a.isSome(this._fog)&&this._fog.render(e,this._weatherParameters.fog),a.isSome(this._precipitation))){const t=this.view.environment.weather;"rainy"!==t.type&&"snowy"!==t.type||this._precipitation.render(e,t.precipitation,t.type)}}},s.updateLightSources=function(e,t,r,s){if(a.isSome(this._context)){const i=this._context.renderContext;i.bindParameters.oldLighting.copyFrom(i.bindParameters.lighting),i.bindParameters.newLighting.noonFactor=t,i.bindParameters.newLighting.globalFactor=r,i.bindParameters.newLighting.set(e);s===O.Update.Faded||i.bindParameters.weatherFading?i.bindParameters.fadeLighting(0):i.bindParameters.fadeLighting(1),this._context.requestRender()}},s._updateWeatherFading=function(e){if(!e.weatherFading)return;const t=e.cloudsFade;return t.fadeIn.stage===v.FadeInStages.FADE_IN?(e.fadeLighting(t.fadeIn.factor),void this._fadeWeather(t.fadeIn.factor)):t.fadeInOut.stage===v.FadeInOutStages.FADE_IN?(e.fadeLighting(t.fadeInOut.factor),void this._fadeWeather(t.fadeInOut.factor)):t.crossFade.enabled?(e.fadeLighting(t.crossFade.factor),void this._fadeWeather(t.crossFade.factor)):(e.fadeLighting(0),void this._fadeWeather(0))},s._fadeWeather=function(e){const{_newWeatherParameters:t,_oldWeatherParameters:r}=this;e>=1?this._weatherParameters=t:(this._fadedWeatherParameters.lerp(r,t,e),this._weatherParameters=this._fadedWeatherParameters)},s._updateWeather=function(){const e=this._weatherUpdateParameters;a.isNone(e)||a.isNone(this._clouds)||(this._clouds.applyPreset(R.cloudPresets[e.type],e.weatherAdjustment),this._setNeedsRender())},s._setNeedsRender=function(){a.isSome(this._context)&&this._context.requestRender()},s._updateFogHaze=function(){const e=this._weatherUpdateParameters;if(a.isNone(this._fog)||a.isNone(this._simpleHaze)||a.isNone(e)||a.isNone(this._context))return;const t=this._context.renderContext.bindParameters;switch(this._oldWeatherParameters.copyFrom(this._weatherParameters),e.type){case"foggy":this._newWeatherParameters.fog.strength=n.lerp(3e-5,.005,e.weatherAdjustment**3),m.copy(this._newWeatherParameters.fog.color,L),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.haze.strength=0,this._newWeatherParameters.haze.amount=this._atmosphereType===g.AtmosphereType.Realistic?1:0,this._setNeedsRender();break;case"rainy":this._newWeatherParameters.fog.strength=n.lerp(4e-6,2e-4,(e.effect??0)**3),m.copy(this._newWeatherParameters.fog.color,q),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.haze.strength=0,this._newWeatherParameters.haze.amount=0,this._setNeedsRender();break;case"snowy":this._newWeatherParameters.fog.strength=n.lerp(4e-6,2e-4,(e.effect??0)**3),m.copy(this._newWeatherParameters.fog.color,L),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.haze.strength=0,this._newWeatherParameters.haze.amount=this._atmosphereType===g.AtmosphereType.Realistic?1:0,this._setNeedsRender();break;default:this._newWeatherParameters.fog.strength=0,this._newWeatherParameters.fog.amount=0,this._newWeatherParameters.haze.strength=4e-6,this._newWeatherParameters.haze.amount=1,this._setNeedsRender()}t.weatherFading?this._fadeWeather(0):this._fadeWeather(1)},s._updateAtmosphere=function(e){const t=this._selectAtmosphereType(e);if(a.isSome(this._atmosphere)?this._atmosphere.type===t:t===g.AtmosphereType.None)return;this._atmosphere=a.destroyMaybe(this._atmosphere),this._hqAtmosphere=a.destroyMaybe(this._hqAtmosphere);const r=this._getAtmosphereClass(t);r&&a.isSome(this._context)&&(this._atmosphere=new r(this.view,this._context),t===g.AtmosphereType.Simple&&(this._hqAtmosphere=new w.ChapmanAtmosphere(this.view,this._context))),this._setNeedsRender(),this._updateBasemapTerrain()},s._getAtmosphereClass=function(e){switch(e){case g.AtmosphereType.Realistic:return w.ChapmanAtmosphere;case g.AtmosphereType.Panoramic:return A.PanoramicAtmosphere;case g.AtmosphereType.Simple:return N;default:case g.AtmosphereType.None:return null}},s._selectAtmosphereType=function(e){const{enabled:t,quality:r,viewingMode:s}=e;return!t||u.isMoon(this.view.spatialReference)?g.AtmosphereType.None:s===y.ViewingMode.Local?g.AtmosphereType.Panoramic:a.isSome(this._context)&&"high"===r&&w.ChapmanAtmosphere.isSupported(this._context)&&u.isEarth(this.view.spatialReference)?g.AtmosphereType.Realistic:g.AtmosphereType.Simple},s._updateBasemapTerrain=function(){this.view.basemapTerrain&&(this.view.basemapTerrain.velvetOverground=this._atmosphereType===g.AtmosphereType.Simple)},t._createClass(r,[{key:"atmosphere",get:function(){return a.isSome(this._hqAtmosphere)&&this.view._stage.renderer.isFeatureEnabled(F.RenderFeature.RealisticAtmosphere)?this._hqAtmosphere:this._atmosphere}},{key:"_atmosphereType",get:function(){return a.isSome(this.atmosphere)?this.atmosphere.type:g.AtmosphereType.None}},{key:"canRender",get:function(){return!!this.view.basemapTerrain?.renderer.canRender||"global"!==this.view.viewingMode}},{key:"needsLinearDepth",get:function(){return this._atmosphereType===g.AtmosphereType.Realistic}},{key:"updating",get:function(){return a.isSome(this._stars)&&this._stars.updating||a.isSome(this._clouds)&&this._clouds.running}},{key:"weatherVisible",get:function(){return m.length(this.view.state.camera.eye)-_.getReferenceEllipsoid(this.view.spatialReference).radius<=W.weatherHeightLimit}},{key:"_stars",get:function(){const e=this.view,t=e.environment?.starsEnabled??!1,r=this._get("_stars");return!t||a.isNone(this._context)?(a.destroyMaybe(r),null):a.isSome(r)?r:new C.Stars({view:e,requestRender:()=>this._setNeedsRender()})}},{key:"_precipitation",get:function(){const e=this._get("_precipitation");if(!this._precipitationEnabled||a.isNone(this._context))return a.destroyMaybe(e),null;const t=this.view,r=this._context;return a.isSome(e)&&e.context===r?e:(a.destroyMaybe(e),new E.Precipitation({context:r,view:t}))}},{key:"_clouds",get:function(){const e=this._get("_clouds");if(!this.weatherEnabled||a.isNone(this._context))return a.destroyMaybe(e),null;if(a.isSome(e))return e;const t=this.view,r=this._context;return a.destroyMaybe(e),new b.CloudsGenerator({context:r,view:t,requestRender:()=>this._setNeedsRender()})}},{key:"_cloudsComposition",get:function(){const e=this._get("_cloudsComposition");if(!this.weatherEnabled||a.isNone(this._context))return a.destroyMaybe(e),null;const t=this.view.state.viewingMode,r=this._context.renderContext.rctx,s=_.getReferenceEllipsoid(this.view.spatialReference).radius;return a.isSome(e)&&e.viewingMode===t&&e.planetRadius===s?e:(a.destroyMaybe(e),new f.CloudsComposition({rctx:r,viewingMode:t,planetRadius:s,requestRender:()=>this._setNeedsRender()}))}},{key:"_fog",get:function(){const e=this._get("_fog");if(!this.weatherEnabled||a.isNone(this._context))return a.destroyMaybe(e),null;if(a.isSome(e))return e;const t=this.view,r=this._context;return new S.Fog({context:r,view:t})}},{key:"_simpleHaze",get:function(){const e=this._get("_simpleHaze");if(!this.weatherEnabled||a.isNone(this._context))return a.destroyMaybe(e),null;if(a.isSome(e))return e;const t=this.view,r=this._context;return new T.SimpleHaze({context:r,view:t})}},{key:"weatherEnabled",get:function(){return!!this.view?.environmentManager?.weatherEnabled}},{key:"_precipitationEnabled",get:function(){return this.weatherEnabled&&("rainy"===this.view.environment.weather.type||"snowy"===this.view.environment.weather.type)}},{key:"_weatherUpdateParameters",get:function(){const e=this.weatherEnabled?this.view.environment.weather:null;return a.isNone(e)?null:"rainy"===e.type||"snowy"===e.type?{type:e.type,weatherAdjustment:e.cloudCover,effect:e.precipitation}:{type:e.type,weatherAdjustment:"foggy"===e.type?e.fogStrength:e.cloudCover}}},{key:"test",get:function(){return{atmosphere:this._atmosphere,clouds:this._clouds,selectAtmosphereType:()=>this._selectAtmosphereType({viewingMode:this.view.state.viewingMode,enabled:this.view.environment.atmosphereEnabled,quality:this.view.environment.atmosphere.quality}),stubGetAtmosphereClass:e=>{U=k.prototype._getAtmosphereClass,k.prototype._getAtmosphereClass=e},restoreGetAtmosphereClass:()=>{k.prototype._getAtmosphereClass=U}}}}]),r}(s),r.__decorate([h.property({constructOnly:!0})],e.EnvironmentRenderer.prototype,"view",void 0),r.__decorate([h.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"atmosphere",null),r.__decorate([h.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"_atmosphereType",null),r.__decorate([h.property({type:Boolean,readOnly:!0})],e.EnvironmentRenderer.prototype,"updating",null),r.__decorate([h.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"weatherVisible",null),r.__decorate([h.property()],e.EnvironmentRenderer.prototype,"_context",void 0),r.__decorate([h.property()],e.EnvironmentRenderer.prototype,"_atmosphere",void 0),r.__decorate([h.property()],e.EnvironmentRenderer.prototype,"_hqAtmosphere",void 0),r.__decorate([h.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"_stars",null),r.__decorate([h.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"_precipitation",null),r.__decorate([h.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"_clouds",null),r.__decorate([h.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"_cloudsComposition",null),r.__decorate([h.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"_fog",null),r.__decorate([h.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"_simpleHaze",null),r.__decorate([h.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"weatherEnabled",null),r.__decorate([h.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"_precipitationEnabled",null),r.__decorate([h.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"_weatherUpdateParameters",null),e.EnvironmentRenderer=k=r.__decorate([c.subclass("esri.views.3d.environment.EnvironmentRenderer")],e.EnvironmentRenderer);let H=function(){function e(){this.fog=new S.FogParameters,this.haze=new T.HazeParameters}var t=e.prototype;return t.copyFrom=function(e){this.fog.amount=e.fog.amount,this.haze.amount=e.haze.amount,this.fog.strength=e.fog.strength,this.haze.strength=e.haze.strength,m.copy(this.fog.color,e.fog.color)},t.lerp=function(e,t,r){this.fog.amount=n.lerp(e.fog.amount,t.fog.amount,r),this.haze.amount=n.lerp(e.haze.amount,t.haze.amount,r),this.fog.strength=n.lerp(e.fog.strength,t.fog.strength,r),this.haze.strength=n.lerp(e.haze.strength,t.haze.strength,r),m.lerp(this.fog.color,e.fog.color,t.fog.color,r)},e}();const q=l.fromValues(.5,.5,.5),L=l.fromValues(1.5,1.5,1.5);let U;e.WeatherParameters=H,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
