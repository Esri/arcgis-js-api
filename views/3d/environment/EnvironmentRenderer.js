/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/has","../../../core/maybe","../../../core/Logger","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass","../../../core/urlUtils","../../../core/uuid","../../../portal/support/resourceExtension","../../../core/Accessor","../../../geometry/support/spatialReferenceUtils","../../../core/Handles","../../../core/watchUtils","./PanoramicAtmosphere","./RealisticAtmosphere","./SimpleAtmosphere","./Stars"],(function(e,t,s,i,r,n,o,h,a,p,d,_,l,m,u,c,y,v,g){"use strict";const w=[14,15];let A=function(t){function s(){var e;return(e=t.apply(this,arguments)||this)._handles=new m,e._initContext=null,e._pendingAtmosphere=null,e._atmosphere=null,e._stars=null,e}e._inheritsLoose(s,t);var r=s.prototype;return r.initialize=function(){this.view._stage.addRenderPlugin(w,this)},r.destroy=function(){this._pendingAtmosphere=i.destroyMaybe(this._pendingAtmosphere),this._atmosphere=i.destroyMaybe(this._atmosphere),this._stars=i.destroyMaybe(this._stars),this._handles=i.destroyMaybe(this._handles),this.view&&(this.view._stage.removeRenderPlugin(this),this._set("view",null))},r.initializeRenderContext=function(e){this._initContext=e,this._techniqueRepository=this._initContext.shaderTechniqueRep,this.setup()},r.setup=function(){this._handles.add(u.when(this.view,"basemapTerrain",(()=>this._updateBasemapTerrain()),!0)),this._handles.add([u.init(this.view,["viewingMode","environment.atmosphereEnabled","environment.atmosphere.quality"],(()=>this._updateAtmosphere()),!0),u.init(this.view,"environment.starsEnabled",(()=>this._updateStars()),!0)])},r.uninitializeRenderContext=function(){i.isSome(this._stars)&&(this._stars.uninitializeRenderContext(),this._stars.destroy(),this._stars=null),i.isSome(this._atmosphere)&&(this._atmosphere.uninitializeRenderContext(),this._atmosphere.destroy(),this._atmosphere=null)},r.render=function(e){let t=!0;return i.isSome(this._stars)&&this._stars.canRender&&(t=this._stars.render(e)&&t),i.isSome(this._atmosphere)&&this._atmosphere.canRender&&(t=this._atmosphere.render(e)&&t),t},r._setNeedsRender=function(){this._initContext&&this._initContext.requestRender()},r._updateStars=function(){var e,t,s;const r=null!=(e=null==(t=this.view)||null==(s=t.environment)?void 0:s.starsEnabled)&&e;r&&i.isNone(this._stars)?(this._stars=new g.Stars({view:this.view}),this._stars.initializeRenderContext(this._initContext),this._setNeedsRender()):!r&&i.isSome(this._stars)&&(this._stars.destroy(),this._stars=null,this._setNeedsRender())},r._updateAtmosphere=function(){const e=this._getAtmosphereType();if(this.atmosphereType===e)return;this.atmosphereType=e,i.isSome(this._pendingAtmosphere)&&(this._pendingAtmosphere!==this._atmosphere&&this._pendingAtmosphere.destroy(),this._pendingAtmosphere=null);const t=this._getAtmosphereClass();if(!t)return i.isSome(this._atmosphere)&&(this._atmosphere.destroy(),this._atmosphere=null,this._setNeedsRender()),void this._updateBasemapTerrain();const s=new t(this.view,this._techniqueRepository);s.initializeRenderContext(this._initContext),i.isNone(this._atmosphere)&&(this._atmosphere=s,this._setNeedsRender()),this._pendingAtmosphere=s,s.when().then((()=>{i.isSome(this._atmosphere)&&this._pendingAtmosphere!==this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=this._pendingAtmosphere),this._pendingAtmosphere=null,this._setNeedsRender(),this._updateBasemapTerrain()})).catch((()=>{this._pendingAtmosphere===s&&(this._pendingAtmosphere=null)}))},r._getAtmosphereClass=function(){const e=this._getAtmosphereType();if(this.atmosphereClassFromType)return this.atmosphereClassFromType(e);switch(e){case"none":return null;case"realistic":return y.RealisticAtmosphere;case"panoramic":return c;case"simple":return v;default:return}},r._getAtmosphereType=function(){const e=this.view.get("environment.atmosphereEnabled"),t=this.view.get("environment.atmosphere.quality"),s=this.view.viewingMode;return!e||null==t||l.isMoon(this.view.spatialReference)?"none":"local"===s?"panoramic":"high"===t&&y.RealisticAtmosphere.isSupported(this._initContext)&&!l.isMars(this.view.spatialReference)?"realistic":"simple"},r._updateBasemapTerrain=function(){const e=this.view.basemapTerrain;e&&(e.velvetOverground=null!=this._atmosphere&&"simple"===this.atmosphereType)},e._createClass(s,[{key:"canRender",get:function(){return!(!this.view.basemapTerrain||!this.view.basemapTerrain.renderer.canRender)||"global"!==this.view.viewingMode}},{key:"updating",get:function(){return i.isSome(this._pendingAtmosphere)||i.isSome(this._stars)&&this._stars.updating}},{key:"test",get:function(){return{atmosphere:this._atmosphere}}}]),s}(_);return t.__decorate([o.property({constructOnly:!0})],A.prototype,"view",void 0),t.__decorate([o.property({constructOnly:!0})],A.prototype,"atmosphereClassFromType",void 0),t.__decorate([o.property({dependsOn:["_pendingAtmosphere","_stars.updating"]})],A.prototype,"updating",null),t.__decorate([o.property()],A.prototype,"_pendingAtmosphere",void 0),t.__decorate([o.property()],A.prototype,"_stars",void 0),A=t.__decorate([h.subclass("esri.views.3d.environment.EnvironmentRenderer")],A),A}));
