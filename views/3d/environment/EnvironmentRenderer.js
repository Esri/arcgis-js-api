/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/has","../../../core/Handles","../../../core/mathUtils","../../../core/maybe","../../../core/reactiveUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec3","../../../geometry/projectionEllipsoid","../../../geometry/support/spatialReferenceUtils","../../../support/featureFlags","./ChapmanAtmosphere","./CloudsComposition","./CloudsData","./CloudsGenerator","./CloudsPresets","./Fog","./PanoramicAtmosphere","./Precipitation","../../../chunks/Precipitation.glsl","./SimpleAtmosphere","./Stars","./weather","../webgl-engine/lib/RenderPass","../webgl-engine/lib/RenderSlot"],(function(e,t,i,s,n,r,o,a,h,p,d,l,c,_,u,m,y,g,v,w,f,R,b,E,A,S,N,C,T,P,M,x){"use strict";var O;const k=[x.RenderSlot.POSTPROCESSING_ENVIRONMENT_OPAQUE,x.RenderSlot.POSTPROCESSING_ENVIRONMENT_TRANSPARENT];let I;e.EnvironmentRenderer=O=function(e){function i(t){var i;return(i=e.call(this,t)||this)._handles=new r,i._context=null,i._pendingAtmosphere=null,i._atmosphere=null,i._precipitationEnabled=g.enablePrecipitation(),i}t._inheritsLoose(i,e);var s=i.prototype;return s.initialize=function(){this.view._stage.addRenderPlugin(k,this)},s.destroy=function(){var e;this._pendingAtmosphere=a.destroyMaybe(this._pendingAtmosphere),null!=(null==(e=this.view)?void 0:e._stage)&&this.view._stage.removeRenderPlugin(this),this._handles=a.destroyMaybe(this._handles),this._set("view",null)},s.updateAnimation=function(e){return!!a.isSome(this._precipitation)&&this._precipitation.update(e)},s.initializeRenderContext=function(e=null){this._context=e,this._handles.add([p.when(this.view,"basemapTerrain",(()=>this._updateBasemapTerrain()),!0),h.watch((()=>({viewingMode:this.view.viewingMode,atmosphereEnabled:this.view.environment.atmosphereEnabled,atmosphereQuality:this.view.environment.atmosphere.quality})),(()=>this._updateAtmosphere()),h.syncAndInitial),h.watch((()=>this._stars),(()=>this._setNeedsRender())),h.watch((()=>this._clouds),(()=>this._updateWeather(this._weatherUpdateParameters)),h.initial),h.watch((()=>this._precipitation),(()=>this._setNeedsRender())),h.watch((()=>this._fog),(()=>this._updateFog(this._weatherUpdateParameters)),h.initial),h.watch((()=>this._weatherUpdateParameters),(e=>{this._updateWeather(e),this._updateFog(e)}),h.syncAndInitial)])},s.uninitializeRenderContext=function(){this._context=null,this._atmosphere=a.destroyMaybe(this._atmosphere),this._set("_stars",a.destroyMaybe(this._stars)),this._set("_precipitation",a.destroyMaybe(this._precipitation)),this._set("_clouds",a.destroyMaybe(this._clouds)),this._set("_cloudComposition",a.destroyMaybe(this._cloudComposition)),this._set("_fog",a.destroyMaybe(this._fog))},s.render=function(e){if(e.pass===M.RenderPass.MATERIAL)switch(e.slot){case x.RenderSlot.POSTPROCESSING_ENVIRONMENT_OPAQUE:a.isSome(this._stars)&&this._stars.render(e),a.isSome(this._atmosphere)&&this._atmosphere.canRender&&(this._atmosphere.render(e),f.isReadyCloudsData(this._clouds)&&a.isSome(this._cloudComposition)&&(this._cloudComposition.render(e,this._clouds,a.isSome(this.view.animation)),this._cloudComposition.isFading&&this._setNeedsRender()));break;case x.RenderSlot.POSTPROCESSING_ENVIRONMENT_TRANSPARENT:if(a.isSome(this._atmosphere)&&this._atmosphere.canRender){const t=this.weatherEnabled?this.view.environment.weather.type:"disabled";if(this._atmosphere.renderHaze(e,"rainy"===t),a.isSome(this._fog)){const i="foggy"===t||"rainy"===t||"snowy"===t;(i||"realistic"!==this._selectAtmosphereType())&&this._fog.render(e,i,"rainy"===t)}"rainy"!==this.view.environment.weather.type&&"snowy"!==this.view.environment.weather.type||!a.isSome(this._precipitation)||this._precipitation.render(e,this.view.environment.weather.precipitation,"rainy"===this.view.environment.weather.type?N.PrecipitationType.RAIN:N.PrecipitationType.SNOW)}}},s._updateWeather=function(e){a.isNone(e)||a.isNone(this._clouds)||(this._clouds.applyPreset(b.cloudPresets[e.type],e.weatherAdjustment),this._setNeedsRender())},s._setNeedsRender=function(){a.isSome(this._context)&&this._context.requestRender()},s._updateFog=function(e){if(!a.isNone(this._fog)&&!a.isNone(e))switch(e.type){case"foggy":this._fog.strength=o.lerp(3e-5,.005,e.weatherAdjustment**3),this._setNeedsRender();break;case"rainy":case"snowy":this._fog.strength=o.lerp(4e-6,8e-5,e.effect**3),this._setNeedsRender();break;default:this._fog.strength=4e-6,this._setNeedsRender()}},s._updateAtmosphere=function(){const e=this._selectAtmosphereType();if(this.atmosphereType===e)return;a.isSome(this._pendingAtmosphere)&&(this._pendingAtmosphere!==this._atmosphere&&this._pendingAtmosphere.destroy(),this._pendingAtmosphere=null);const t=this._getAtmosphereClass();if(!t)return a.isSome(this._atmosphere)&&(this._atmosphere.destroy(),this._atmosphere=null,this._setNeedsRender()),void this._updateBasemapTerrain();const i=new t(this.view);a.isSome(this._context)&&i.initializeRenderContext(this._context),a.isNone(this._atmosphere)&&(this._atmosphere=i,this._setNeedsRender()),this._pendingAtmosphere=i,i.when().then((()=>{a.isSome(this._atmosphere)&&this._pendingAtmosphere&&this._pendingAtmosphere!==this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=this._pendingAtmosphere),this._pendingAtmosphere=null,this._setNeedsRender(),this._updateBasemapTerrain()})).catch((()=>{this._pendingAtmosphere===i&&(this._pendingAtmosphere=null)}))},s._getAtmosphereClass=function(){switch(this._selectAtmosphereType()){case"none":return null;case"realistic":return v.ChapmanAtmosphere;case"panoramic":return A.PanoramicAtmosphere;case"simple":return C;default:return}},s._selectAtmosphereType=function(){const e=this.view.get("environment.atmosphereEnabled"),t=this.view.get("environment.atmosphere.quality"),i=this.view.viewingMode;return!e||null==t||y.isMoon(this.view.spatialReference)?"none":"local"===i?"panoramic":"high"===t&&a.isSome(this._context)&&v.ChapmanAtmosphere.isSupported(this._context)&&y.isEarth(this.view.spatialReference)?"realistic":"simple"},s._updateBasemapTerrain=function(){this.view.basemapTerrain&&(this.view.basemapTerrain.velvetOverground=a.isSome(this._atmosphere)&&"simple"===this.atmosphereType)},t._createClass(i,[{key:"atmosphereType",get:function(){return a.isSome(this._pendingAtmosphere)?this._pendingAtmosphere.type:a.isSome(this._atmosphere)?this._atmosphere.type:"none"}},{key:"canRender",get:function(){var e;return!(null==(e=this.view.basemapTerrain)||!e.renderer.canRender)||"global"!==this.view.viewingMode}},{key:"needsLinearDepth",get:function(){return"realistic"===this._selectAtmosphereType()}},{key:"updating",get:function(){return a.isSome(this._pendingAtmosphere)||a.isSome(this._stars)&&this._stars.updating||a.isSome(this._clouds)&&this._clouds.running}},{key:"weatherVisible",get:function(){return u.length(this.view.state.camera.eye)-m.getReferenceEllipsoid(this.view.spatialReference).radius<=P.weatherHeightLimit}},{key:"_stars",get:function(){var e,t;const i=this.view,s=null!=(e=null==(t=i.environment)?void 0:t.starsEnabled)&&e,n=this._get("_stars");return!s||a.isNone(this._context)?(a.destroyMaybe(n),null):a.isSome(n)?n:new T.Stars({view:i,requestRender:()=>this._setNeedsRender()})}},{key:"_precipitation",get:function(){const e=this._get("_precipitation");if(!this._precipitationEnabled||a.isNone(this._context))return a.destroyMaybe(e),null;const t=this.view,i=this._context;return a.isSome(e)&&e.context===i?e:(a.destroyMaybe(e),new S.Precipitation({context:i,view:t}))}},{key:"_clouds",get:function(){const e=this._get("_clouds");if(!this.weatherEnabled||a.isNone(this._context))return a.destroyMaybe(e),null;if(a.isSome(e))return e;const t=this.view,i=this._context.renderContext.rctx;return a.destroyMaybe(e),new R.CloudsGenerator({rctx:i,view:t,requestRender:()=>this._setNeedsRender()})}},{key:"_cloudComposition",get:function(){const e=this._get("_cloudComposition");if(!this.weatherEnabled||a.isNone(this._context))return a.destroyMaybe(e),null;const t=this.view.state.viewingMode,i=this._context.renderContext.rctx,s=m.getReferenceEllipsoid(this.view.spatialReference).radius;return a.isSome(e)&&e.viewingMode===t&&e.radius===s?e:(a.destroyMaybe(e),new w.CloudsComposition({rctx:i,viewingMode:t,radius:s}))}},{key:"_fog",get:function(){const e=this._get("_fog");if(!this.weatherEnabled||a.isNone(this._context))return a.destroyMaybe(e),null;if(a.isSome(e))return e;const t=this.view,i=this._context;return a.destroyMaybe(e),new E.Fog({context:i,view:t})}},{key:"weatherEnabled",get:function(){var e,t;return!(null==(e=this.view)||null==(t=e.environmentManager)||!t.weatherEnabled)}},{key:"precipitationEnabled",get:function(){return this._precipitationEnabled},set:function(e){this._precipitationEnabled=e}},{key:"_weatherUpdateParameters",get:function(){const e=this.weatherEnabled?this.view.environment.weather:null;return a.isNone(e)?null:"rainy"===e.type||"snowy"===e.type?{type:e.type,weatherAdjustment:e.cloudCover,effect:e.precipitation}:{type:e.type,weatherAdjustment:"foggy"===e.type?e.fogStrength:e.cloudCover}}},{key:"test",get:function(){return{atmosphere:this._atmosphere,clouds:this._clouds,selectAtmosphereType:()=>this._selectAtmosphereType(),stubGetAtmosphereClass:e=>{I=O.prototype._getAtmosphereClass,O.prototype._getAtmosphereClass=e},restoreGetAtmosphereClass:()=>{O.prototype._getAtmosphereClass=I},precipitationEnabled:e=>{this.precipitationEnabled=e}}}}]),i}(s),i.__decorate([d.property({constructOnly:!0})],e.EnvironmentRenderer.prototype,"view",void 0),i.__decorate([d.property({type:Boolean,readOnly:!0})],e.EnvironmentRenderer.prototype,"updating",null),i.__decorate([d.property()],e.EnvironmentRenderer.prototype,"weatherVisible",null),i.__decorate([d.property()],e.EnvironmentRenderer.prototype,"_context",void 0),i.__decorate([d.property()],e.EnvironmentRenderer.prototype,"_pendingAtmosphere",void 0),i.__decorate([d.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"_stars",null),i.__decorate([d.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"_precipitation",null),i.__decorate([d.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"_clouds",null),i.__decorate([d.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"_cloudComposition",null),i.__decorate([d.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"_fog",null),i.__decorate([d.property()],e.EnvironmentRenderer.prototype,"weatherEnabled",null),i.__decorate([d.property()],e.EnvironmentRenderer.prototype,"_precipitationEnabled",void 0),i.__decorate([d.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"_weatherUpdateParameters",null),e.EnvironmentRenderer=O=i.__decorate([_.subclass("esri.views.3d.environment.EnvironmentRenderer")],e.EnvironmentRenderer),Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
