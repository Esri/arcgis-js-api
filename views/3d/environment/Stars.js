/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../assets","../../../core/Accessor","../../../core/Error","../../../core/Logger","../../../core/maybe","../../../core/promiseUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../../chunks/mat4","../../../chunks/mat4f64","./StarsTechnique","../support/buffer/glUtil","../support/buffer/InterleavedLayout","../webgl-engine/lib/DefaultVertexAttributeLocations","../../support/WatchUpdatingTracking","../../webgl/BufferObject","../../webgl/VertexArrayObject"],(function(t,e,r,s,i,n,a,o,c,u,f,d,h,l,_,p,g,b,y,m,v,k){"use strict";const w=a.getLogger("esri.views.3d.environment.Stars");t.Stars=function(t){function r(e){var r;return(r=t.call(this,e)||this).slot=14,r._loadDataTask=null,r._numPoints=0,r._modelMatrix=_.create(),r._updatingTracking=new m.WatchUpdatingTracking,r._requestRender=()=>{},r}e._inheritsLoose(r,t);var i=r.prototype;return i.initialize=function(){this._loadDataTask=this._createLoadDataTask()},i.destroy=function(){this._loadDataTask=o.abortMaybe(this._loadDataTask),this._updatingTracking.destroy(),this._numPoints=0,this._technique=o.disposeMaybe(this._technique),this._vao=o.disposeMaybe(this._vao),this._requestRender=null},i.initializeRenderContext=function(t){this._requestRender=t.requestRender},i.uninitializeRenderContext=function(){this.destroy()},i.render=function(t){if(t.slot!==this.slot||0!==t.pass)return!1;if(this._ensureResources(t),o.isNone(this._technique)||o.isNone(this._vao))return!0;const e=t.rctx,r=this._technique.program;return e.useProgram(r),this._technique.bindPass({camera:t.camera,modelMatrix:this._modelMatrix}),this._technique.bindPipelineState(e),e.bindVAO(this._vao),r.assertCompatibleVertexAttributeLocations(this._vao),e.drawArrays(0,0,this._numPoints),!0},i._ensureResources=function(t){if(o.isSome(this._technique)||o.isNone(q))return;const e=t.rctx;this._technique=new p.StarsTechnique({rctx:e,viewingMode:this.view.state.viewingMode},null),this._numPoints=q.byteLength/x;const r=new Float32Array(q,0,2*this._numPoints),s=new Uint8Array(q,2*this._numPoints*4,this._numPoints);this._vao=this._createVertexArrayObject(t.rctx,r,s,this._numPoints),this._updatingTracking.add(this.view,"environment.lighting.date",(t=>this._update(t)),2)},i._computeDayDuration=function(t){const e=t,r=new Date(t.getFullYear(),0,1,11,58,56);return(+e-+r)/(+new Date(t.getFullYear()+1,0,1,11,58,55)-+r)},i._update=function(t){if(!t)return;const e=(t.getHours()/12+t.getMinutes()/60*(2/24)+t.getSeconds()/60*(2/1440)-.9972222)%2,r=2*this._computeDayDuration(t),s=this._modelMatrix;l.copy(s,D),l.rotateZ(s,s,-r*Math.PI),l.multiply(s,S,s),l.rotateZ(s,s,-e*Math.PI),this._requestRender()},i._hexToRGB=function(t){return[parseInt(t.substring(0,2),16),parseInt(t.substring(2,4),16),parseInt(t.substring(4,6),16)]},i._unpackUint8Attributes=function(t){return t>=192?[2.9,t-192]:t>=160?[2.5,t-160]:t>=128?[2,t-128]:t>=96?[1.5,t-96]:t>=64?[1,t-64]:t>=32?[.7,t-32]:[.4,t]},i._createVertexArrayObject=function(t,e,r,s){const i=M.createBuffer(s),n=i.position,a=i.color,o=i.size;for(let c=0;c<s;c++){const t=e[2*c+0],s=e[2*c+1];n.set(c,0,-Math.cos(t)*Math.sin(s)),n.set(c,1,-Math.sin(t)*Math.sin(s)),n.set(c,2,-Math.cos(s));const i=this._unpackUint8Attributes(r[c]),u=this._hexToRGB(T[i[1]]);a.set(c,0,255*u[0]),a.set(c,1,255*u[1]),a.set(c,2,255*u[2]),a.set(c,3,255),o.set(c,i[0])}return new k(t,y.Default3D,{geometry:g.glLayout(M)},{geometry:v.createVertex(t,35044,i.buffer)})},i._createLoadDataTask=function(){var t=this;if(o.isSome(q))return null;const r=c.createTask(function(){var r=e._asyncToGenerator((function*(e){const{data:r}=yield s.fetchAsset("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:e});t._verifyStarData(r),q=r}));return function(t){return r.apply(this,arguments)}}());return r.promise.catch((t=>{c.isAbortError(t)||w.error(t)})).then((()=>{this.destroyed||(this._requestRender(),this.notifyChange("updating"))})),r},i._verifyStarData=function(t){if(!t)throw new n("stars:no-data-received","Failed to create stars because star catalogue is missing");const e=t.byteLength/x;if(e%1!=0||e>5e4||e<5e3)throw new n("stars:invalid-data","Failed to create stars because star catalogue data is invalid")},e._createClass(r,[{key:"updating",get:function(){return this._updatingTracking.updating||this.loading}},{key:"loading",get:function(){return o.isSome(this._loadDataTask)&&!this._loadDataTask.finished}},{key:"canRender",get:function(){return!this.loading}}]),r}(i),r.__decorate([u.property({constructOnly:!0})],t.Stars.prototype,"view",void 0),r.__decorate([u.property({readOnly:!0})],t.Stars.prototype,"updating",null),r.__decorate([u.property()],t.Stars.prototype,"_loadDataTask",void 0),r.__decorate([u.property()],t.Stars.prototype,"_updatingTracking",void 0),t.Stars=r.__decorate([h.subclass("esri.views.3d.environment.Stars")],t.Stars);const T=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],S=_.fromValues(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),D=_.fromValues(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),x=9,M=b.newLayout().vec3f("position").vec4u8("color").f32("size");let q=null;Object.defineProperty(t,"__esModule",{value:!0})}));
