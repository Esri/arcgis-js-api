/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/has","../../../core/maybe","../../../core/Logger","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass","../../../core/Error","../../../core/urlUtils","../../../core/uuid","../../../portal/support/resourceExtension","../../../core/promiseUtils","../../../core/Accessor","../../../assets","../../../chunks/mat4","../../support/WatchUpdatingTracking","../../../chunks/mat4f64","../webgl-engine/lib/DefaultVertexAttributeLocations","../support/buffer/glUtil","../support/buffer/InterleavedLayout","../../webgl/BufferObject","../../webgl/VertexArrayObject","./StarsTechnique"],(function(e,t,r,s,a,n,i,o,c,u,f,d,l,p,h,_,g,b,y,m,v,k,w,T,S){"use strict";const D=n.getLogger("esri.views.3d.environment.Stars");e.Stars=function(e){function r(t){var r;return(r=e.call(this,t)||this).slot=14,r._loadDataTask=null,r._resources=null,r._modelMatrix=y.create(),r._updatingTracking=new b.WatchUpdatingTracking,r._requestRender=()=>{},r}t._inheritsLoose(r,e);var s=r.prototype;return s.initialize=function(){this._loadDataTask=this._createLoadDataTask()},s.destroy=function(){a.isSome(this._loadDataTask)&&(this._loadDataTask.abort(),this._loadDataTask=null),this._updatingTracking.destroy(),a.isSome(this._resources)&&(this._resources.vao.dispose(),this._resources.technique.dispose(),this._resources=null),this._requestRender=null},s.initializeRenderContext=function(e){this._requestRender=e.requestRender},s.uninitializeRenderContext=function(){this.destroy()},s.render=function(e){if(e.slot!==this.slot||0!==e.pass)return!1;if(this._ensureResources(e),a.isNone(this._resources))return!0;const{technique:t,vao:r,num:s}=this._resources,n=e.rctx,i=t.program;return n.bindProgram(i),t.bindPass(n,{camera:e.camera,modelMatrix:this._modelMatrix}),t.bindPipelineState(n),n.bindVAO(r),i.assertCompatibleVertexAttributeLocations(r),n.drawArrays(0,0,s),!0},s._ensureResources=function(e){if(a.isSome(this._resources)||a.isNone(q))return;const t=e.rctx,r=new S.StarsTechnique({rctx:t,viewingMode:this.view.state.mode},null),s=q.byteLength/R,n=new Float32Array(q,0,2*s),i=new Uint8Array(q,2*s*4,s),o=this._createVertexArrayObject(e.rctx,n,i,s);this._resources={vao:o,technique:r,num:s},this._updatingTracking.add(this.view,"environment.lighting.date",(e=>this._update(e)),2)},s._computeDayDuration=function(e){const t=e,r=new Date(e.getFullYear(),0,1,11,58,56);return(+t-+r)/(+new Date(e.getFullYear()+1,0,1,11,58,55)-+r)},s._update=function(e){if(!e)return;const t=(e.getHours()/12+e.getMinutes()/60*(2/24)+e.getSeconds()/60*(2/1440)-.9972222)%2,r=2*this._computeDayDuration(e),s=this._modelMatrix;g.copy(s,M),g.rotateZ(s,s,-r*Math.PI),g.multiply(s,A,s),g.rotateZ(s,s,-t*Math.PI),this._requestRender()},s._hexToRGB=function(e){return[parseInt(e.substring(0,2),16),parseInt(e.substring(2,4),16),parseInt(e.substring(4,6),16)]},s._unpackUint8Attributes=function(e){return e>=192?[2.9,e-192]:e>=160?[2.5,e-160]:e>=128?[2,e-128]:e>=96?[1.5,e-96]:e>=64?[1,e-64]:e>=32?[.7,e-32]:[.4,e]},s._createVertexArrayObject=function(e,t,r,s){const a=L.createBuffer(s),n=a.position,i=a.color,o=a.size;for(let e=0;e<s;e++){const s=t[2*e+0],a=t[2*e+1];n.set(e,0,-Math.cos(s)*Math.sin(a)),n.set(e,1,-Math.sin(s)*Math.sin(a)),n.set(e,2,-Math.cos(a));const c=this._unpackUint8Attributes(r[e]),u=this._hexToRGB(x[c[1]]);i.set(e,0,255*u[0]),i.set(e,1,255*u[1]),i.set(e,2,255*u[2]),i.set(e,3,255),o.set(e,c[0])}return new T(e,m.Default3D,{geometry:v.glLayout(L)},{geometry:w.createVertex(e,35044,a.buffer)})},s._createLoadDataTask=function(){if(a.isSome(q))return null;const e=p.createTask((async e=>{const{data:t}=await _.fetchAsset("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:e});this._verifyStarData(t),q=t}));return e.promise.catch((e=>{p.isAbortError(e)||D.error(e)})).then((()=>{this.destroyed||(this._requestRender(),this.notifyChange("updating"))})),e},s._verifyStarData=function(e){if(!e)throw new u("stars:no-data-received","Failed to create stars because star catalogue is missing");const t=e.byteLength/R;if(t%1!=0||t>5e4||t<5e3)throw new u("stars:invalid-data","Failed to create stars because star catalogue data is invalid")},t._createClass(r,[{key:"updating",get:function(){return this._updatingTracking.updating||this.loading}},{key:"loading",get:function(){return a.isSome(this._loadDataTask)&&!this._loadDataTask.finished}},{key:"canRender",get:function(){return!this.loading}}]),r}(h),r.__decorate([o.property({constructOnly:!0})],e.Stars.prototype,"view",void 0),r.__decorate([o.property({readOnly:!0,dependsOn:["_updatingTracking.updating"]})],e.Stars.prototype,"updating",null),r.__decorate([o.property()],e.Stars.prototype,"_loadDataTask",void 0),r.__decorate([o.property()],e.Stars.prototype,"_updatingTracking",void 0),e.Stars=r.__decorate([c.subclass("esri.views.3d.environment.Stars")],e.Stars);const x=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],A=y.fromValues(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),M=y.fromValues(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),R=9,L=k.newLayout().vec3f("position").vec4u8("color").f32("size");let q=null;Object.defineProperty(e,"__esModule",{value:!0})}));
