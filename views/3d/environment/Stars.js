/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../assets","../../../core/Accessor","../../../core/Error","../../../core/Logger","../../../core/maybe","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../../chunks/mat4","../../../chunks/mat4f64","./StarsTechnique","../support/buffer/glUtil","../support/buffer/InterleavedLayout","../webgl-engine/lib/DefaultVertexAttributeLocations","../webgl-engine/lib/VertexAttribute","../../support/WatchUpdatingTracking","../../webgl/BufferObject","../../webgl/enums","../../webgl/VertexArrayObject"],(function(e,t,r,a,s,i,n,o,c,u,f,d,h,l,p,_,g,b,y,m,v,T,w,S,k,A){"use strict";const D=n.getLogger("esri.views.3d.environment.Stars");e.Stars=function(e){function r(t){var r;return(r=e.call(this,t)||this)._loadDataTask=null,r._numPoints=0,r._renderParameter={camera:null,modelMatrix:g.create()},r._updatingTracking=new w.WatchUpdatingTracking,r}t._inheritsLoose(r,e);var s=r.prototype;return s.initialize=function(){this._loadDataTask=this._createLoadDataTask()},s.destroy=function(){this._loadDataTask=o.abortMaybe(this._loadDataTask),this._updatingTracking.destroy(),this._numPoints=0,this._technique=o.releaseMaybe(this._technique),this._vao=o.disposeMaybe(this._vao)},s.render=function(e){const{rctx:t,camera:r}=e;if(this._ensureResources(t),o.isNone(this._technique)||o.isNone(this._vao))return;const a=t.useTechnique(this._technique);this._renderParameter.camera=r,this._technique.bindPass(this._renderParameter),t.bindVAO(this._vao),a.assertCompatibleVertexAttributeLocations(this._vao),t.drawArrays(k.PrimitiveType.POINTS,0,this._numPoints)},s._ensureResources=function(e){if(o.isSome(this._technique)||o.isNone(q))return;this._technique=new b.StarsTechnique({rctx:e,viewingMode:this.view.state.viewingMode}),this._numPoints=q.byteLength/O;const t=new Float32Array(q,0,2*this._numPoints),r=new Uint8Array(q,2*this._numPoints*4,this._numPoints);this._vao=this._createVertexArrayObject(e,t,r,this._numPoints),this._updatingTracking.add((()=>{var e;return null==(e=this.view)?void 0:e.environment.lighting.date}),(e=>this._update(e)),u.initial)},s._computeDayDuration=function(e){const t=e,r=new Date(e.getFullYear(),0,1,11,58,56);return(+t-+r)/(+new Date(e.getFullYear()+1,0,1,11,58,55)-+r)},s._update=function(e){if(!e)return;const t=(e.getHours()/12+e.getMinutes()/60*(2/24)+e.getSeconds()/60*(2/1440)-.9972222)%2,r=2*this._computeDayDuration(e),a=this._renderParameter.modelMatrix;_.copy(a,M),_.rotateZ(a,a,-r*Math.PI),_.multiply(a,x,a),_.rotateZ(a,a,-t*Math.PI),this.requestRender()},s._hexToRGB=function(e){return[parseInt(e.substring(0,2),16),parseInt(e.substring(2,4),16),parseInt(e.substring(4,6),16)]},s._unpackUint8Attributes=function(e){return e>=192?[2.9,e-192]:e>=160?[2.5,e-160]:e>=128?[2,e-128]:e>=96?[1.5,e-96]:e>=64?[1,e-64]:e>=32?[.7,e-32]:[.4,e]},s._createVertexArrayObject=function(e,t,r,a){const s=V.createBuffer(a),i=s.position,n=s.color,o=s.size;for(let c=0;c<a;c++){const e=t[2*c+0],a=t[2*c+1];i.set(c,0,-Math.cos(e)*Math.sin(a)),i.set(c,1,-Math.sin(e)*Math.sin(a)),i.set(c,2,-Math.cos(a));const s=this._unpackUint8Attributes(r[c]),u=this._hexToRGB(P[s[1]]);n.set(c,0,255*u[0]),n.set(c,1,255*u[1]),n.set(c,2,255*u[2]),n.set(c,3,255),o.set(c,s[0])}return new A.VertexArrayObject(e,v.Default3D,{geometry:y.glLayout(V)},{geometry:S.BufferObject.createVertex(e,k.Usage.STATIC_DRAW,s.buffer)})},s._createLoadDataTask=function(){var e=this;if(o.isSome(q))return null;const r=c.createTask(function(){var r=t._asyncToGenerator((function*(t){const{data:r}=yield a.fetchAsset("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:t});e._verifyStarData(r),q=r}));return function(e){return r.apply(this,arguments)}}());return r.promise.catch((e=>{c.isAbortError(e)||D.error(e)})).then((()=>{this.destroyed||(this.requestRender(),this.notifyChange("updating"))})),r},s._verifyStarData=function(e){if(!e)throw new i("stars:no-data-received","Failed to create stars because star catalogue is missing");const t=e.byteLength/O;if(t%1!=0||t>5e4||t<5e3)throw new i("stars:invalid-data","Failed to create stars because star catalogue data is invalid")},t._createClass(r,[{key:"updating",get:function(){return this._updatingTracking.updating||this.loading}},{key:"loading",get:function(){return o.isSome(this._loadDataTask)&&!this._loadDataTask.finished}}]),r}(s),r.__decorate([f.property({constructOnly:!0})],e.Stars.prototype,"view",void 0),r.__decorate([f.property({constructOnly:!0})],e.Stars.prototype,"requestRender",void 0),r.__decorate([f.property({readOnly:!0})],e.Stars.prototype,"updating",null),r.__decorate([f.property()],e.Stars.prototype,"_loadDataTask",void 0),r.__decorate([f.property()],e.Stars.prototype,"_updatingTracking",void 0),e.Stars=r.__decorate([p.subclass("esri.views.3d.environment.Stars")],e.Stars);const P=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],x=g.fromValues(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),M=g.fromValues(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),O=9,V=m.newLayout().vec3f(T.VertexAttribute.POSITION).vec4u8(T.VertexAttribute.COLOR).f32(T.VertexAttribute.SIZE);let q=null;Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
