/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../core/Logger","../../../core/promiseUtils","../../../chunks/mat4","../../../chunks/mat4f64","../../../support/requestImageUtils","../webgl-engine/lib/DefaultVertexAttributeLocations","./SimpleAtmosphereTechnique","./resources/SimpleAtmosphereTexture","../support/buffer/glUtil","../support/buffer/InterleavedLayout","../webgl-engine/core/shaderLibrary/util/View.glsl","../webgl-engine/lib/Util","../webgl-engine/lib/GeometryUtil","../../webgl/BufferObject","../../webgl/Texture","../../webgl/Util","../../webgl/VertexArrayObject"],(function(e,t,r,i,o,n,s,a,l,u,h,c,p,g,m,f,d,_){"use strict";const y=t.getLogger("esri.views.3d.environment.PanoramicAtmosphere");let b=function(){function t(e,t){this.slot=14,this._readyResolver=r.createResolver(),this._readyController=r.createAbortController(),this.view=e,this._techniqueRepository=t,this._atmosphereTechniqueConfig=new a.SimpleAtmosphereTechniqueConfiguration}var o=t.prototype;return o.destroy=function(){this._readyResolver.reject(),this._texture&&(this._texture.dispose(),this._texture=null),this._readyController&&(this._readyController.abort(),this._readyController=null)},o.when=function(){return this._readyResolver.promise},o.initializeRenderContext=function(e){const t=e.rctx;this._atmosphereTechniqueConfig.geometry=1,this._atmosphereTechnique=this._techniqueRepository.acquireAndReleaseExisting(a.SimpleAtmosphereTechnique,this._atmosphereTechniqueConfig,this._atmosphereTechnique),this._vao=this._createVertexArrayObject(t),this._vaoCount=d.vertexCount(this._vao,"geometry"),n.requestImage(l,{signal:this._readyController.signal}).then((t=>{this._texture=new f(e.rctx,{pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0},t),e.requestRender(),this._readyController=null,this._readyResolver.resolve()})).catch((e=>{r.isAbortError(e)||y.error("Unable to initialize atmosphere: image request failed",e),this._readyResolver.reject()}))},o.uninitializeRenderContext=function(){this.destroy()},o.render=function(e){if(e.slot!==this.slot||0!==e.pass)return!1;const t=e.rctx,r=this._atmosphereTechnique.program;var o,n;return t.bindProgram(r),this._atmosphereTechnique.bindPipelineState(t),t.bindTexture(this._texture,0),r.setUniform1i("tex",0),c.View.bindProjectionMatrix(r,e.camera.projectionMatrix),o=x,n=e.camera.viewMatrix,i.copy(o,n),o[12]=0,o[13]=0,o[14]=0,o[15]=1,r.setUniformMatrix4fv("view",x),r.setUniform4f("color",1,1,1,1),e.scenelightingData.setLightDirectionUniform(r),t.bindVAO(this._vao),r.assertCompatibleVertexAttributeLocations(this._vao),t.drawArrays(4,0,this._vaoCount),!0},o._createVertexArrayObject=function(e){const t=g.createPolySphereGeometry(1,2,!1),r=t.indices[p.VertexAttrConstants.POSITION];for(let e=0;e<r.length;e+=3){const t=r[e];r[e]=r[e+2],r[e+2]=t}const i=t.vertexAttributes[p.VertexAttrConstants.POSITION].data,o=v.createBuffer(r.length),n=o.position;for(let e=0;e<r.length;++e){const t=3*r[e];n.set(e,0,i[t]),n.set(e,1,i[t+1]),n.set(e,2,i[t+2])}return new _(e,s.Default3D,{geometry:u.glLayout(v)},{geometry:m.createVertex(e,35044,o.buffer)})},e._createClass(t,[{key:"canRender",get:function(){return null!=this._texture}}]),t}();const x=o.create(),v=h.newLayout().vec3f("position");return b}));
