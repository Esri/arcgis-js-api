/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/mathUtils","../../../core/maybe","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec3","../../../chunks/vec3f64","../../../geometry/projectionEllipsoid","./atmosphereUtils","../../../chunks/FogHaze.glsl","./FogTechnique","./weather","../webgl-engine/lib/DefaultVertexBufferLayouts","../webgl-engine/lib/glUtil3D","../../webgl/enums"],(function(e,t,s,r,o,i,a,n,c,h,u,p,g,d,l,_,m,f,y,b){"use strict";const T=.95,F=1;e.Fog=function(e){function s(t){var s;(s=e.call(this,t)||this)._passParameters=new l.FogHazePassParameters;const r=t.context.renderContext.rctx;s._vao=y.createQuadVAO(r,f.Pos2Tex);const o=g.getReferenceEllipsoid(t.view.spatialReference);return s._planetRadius=o.radius,s._atmosphereRadius=o.radius+d.atmosphereHeight,s}t._inheritsLoose(s,e);var r=s.prototype;return r.destroy=function(){this._thickFogTechniqueCached=i.releaseMaybe(this._thickFogTechniqueCached),this._vao=i.disposeMaybe(this._vao)},r.render=function(e,t){if(this._update(e,t),this._passParameters.fogAmount<=0)return;const s=this._thickFogTechnique;if(!s.compiled)return void this.context.requestRender();const r=e.offscreenRenderingHelper;r.renderDepthDetached((()=>{this._passParameters.depthTexture=r.depthTexture;const t=e.rctx.bindTechnique(s,this._passParameters,e.bindParameters);this._renderFog(t,e)}))},r._renderFog=function(e,t){if(i.isNone(this._vao))return;const s=t.rctx;s.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),s.drawArrays(b.PrimitiveType.TRIANGLE_STRIP,0,4)},r._update=function(e,t){const s=e.bindParameters.camera;u.normalize(v,s.eye);const r=Math.max(0,u.dot(v,e.bindParameters.lighting.mainLight.direction)),i=t.color,a=.1;u.scale(q,i,a),u.lerp(this._passParameters.fogColor,q,i,r);const n=u.length(s.eye),c=n*n;this._passParameters.atmosphereC=c-this._atmosphereRadius*this._atmosphereRadius,this._passParameters.fogAmount=(1-o.smoothstep(T*m.weatherHeightLimit,F*m.weatherHeightLimit,Math.abs(n-this._planetRadius)))*t.amount,this._passParameters.fogStrength=t.strength},s.isSupported=function(e){return e.capabilities.depthTexture},t._createClass(s,[{key:"_shaderTechniqueRepository",get:function(){return this.context.shaderTechniqueRepository}},{key:"strength",get:function(){return this._passParameters.fogStrength},set:function(e){this._passParameters.fogStrength=e}},{key:"_thickFogTechnique",get:function(){if(i.isNone(this._thickFogTechniqueCached)){const e=new _.FogHazeTechniqueConfiguration;e.haze=!1,this._thickFogTechniqueCached=this._shaderTechniqueRepository.acquire(_.FogTechnique,e)}return this._thickFogTechniqueCached}}]),s}(r),s.__decorate([a.property({constructOnly:!0})],e.Fog.prototype,"context",void 0),s.__decorate([a.property({constructOnly:!0})],e.Fog.prototype,"view",void 0),e.Fog=s.__decorate([h.subclass("esri.views.3d.environment.Fog")],e.Fog);let P=function(){this.color=p.create(),this.strength=0,this.amount=0};const v=p.create(),q=p.create();e.FogParameters=P,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
