/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/mathUtils","../../../core/maybe","../../../chunks/mat4","../../../chunks/mat4f64","../../../chunks/vec2","../../../chunks/vec2f64","../../../chunks/vec3","../../../geometry/projectionEllipsoid","./atmosphereUtils","./FogTechnique","../webgl-engine/lib/DefaultVertexBufferLayouts","../webgl-engine/lib/glUtil3D"],(function(e,t,i,n,s,r,o,h,a,c,u,g,f,_){"use strict";let p=function(){function e(e,t){this._projectionInverse=r.create(),this._viewInverse=r.create(),this._nearFar=h.create(),this._darkenHaze=!1,this._hazeMultiplier=1,this._strength=4e-6;const i=e.renderContext.rctx;this._vao=_.createQuadVAO(i,f.Pos2Tex),this._shaderTechniqueRepository=e.shaderTechniqueRep;const n=c.getReferenceEllipsoid(t.spatialReference);this._planetRadius=n.radius,this._atmosphereRadius=n.radius+u.atmosphereHeight}var p=e.prototype;return p.destroy=function(){this._distanceFogTechnique=n.releaseMaybe(this._distanceFogTechnique),this._foggyWeatherTechnique=n.releaseMaybe(this._foggyWeatherTechnique),this._vao=n.disposeMaybe(this._vao)},p.when=function(){return Promise.resolve()},p.render=function(e,t,i){if(this._darkenHaze=i,this._update(e.camera,t),this._fogAmount<=0)return!1;const n=e.rctx,s=e.offscreenRenderingHelper,r=t?this.foggyWeatherTechnique:this.distanceFogTechnique;return n.useProgram(r.program),r.bindPipelineState(n),s.renderDepthDetached((()=>{r.program.bindTexture(s.depthTexture,"depthTex"),this._renderFog(r.program,e)})),!0},p._renderFog=function(e,t){if(n.isNone(this._vao))return!1;const i=t.rctx;return t.scenelightingData.setLightDirectionUniform(e),e.setUniform3fv("cameraPosition",t.camera.eye),e.setUniformMatrix4fv("projectionInverse",this._projectionInverse),e.setUniformMatrix4fv("viewInverse",this._viewInverse),e.setUniform2fv("nearFar",this._nearFar),e.setUniform1f("atmosphereC",this._atmosphereC),e.setUniform1f("strength",this._strength),e.setUniform1f("fogAmount",this._hazeMultiplier*this._fogAmount),i.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),i.drawArrays(5,0,4),!0},p._update=function(e,t){if(n.isNone(e))return;s.invert(this._projectionInverse,e.projectionMatrix),s.invert(this._viewInverse,e.viewMatrix),o.set(this._nearFar,e.near,e.far);const r=a.length(e.eye),h=r*r;this._atmosphereC=h-this._atmosphereRadius*this._atmosphereRadius,this._fogAmount=t?1-i.smoothstep(3e3,6e3,Math.abs(r-this._planetRadius)):1-i.smoothstep(7e3,1e4,Math.abs(r-this._planetRadius)),this._hazeMultiplier=this._darkenHaze?i.lerp(.4,1,i.smoothstep(9500,10500,r-this._planetRadius)):1},e.isSupported=function(e){return e.capabilities.depthTexture},t._createClass(e,[{key:"strength",get:function(){return this._strength},set:function(e){this._strength=e}},{key:"foggyWeatherTechnique",get:function(){if(n.isNone(this._foggyWeatherTechnique)){const e=new g.FogTechniqueConfiguration;e.haze=!1,this._foggyWeatherTechnique=this._shaderTechniqueRepository.acquire(g.FogTechnique,e)}return this._foggyWeatherTechnique}},{key:"distanceFogTechnique",get:function(){if(n.isNone(this._distanceFogTechnique)){const e=new g.FogTechniqueConfiguration;e.haze=!0,this._distanceFogTechnique=this._shaderTechniqueRepository.acquire(g.FogTechnique,e)}return this._distanceFogTechnique}}]),e}();e.Fog=p,Object.defineProperty(e,"__esModule",{value:!0})}));
