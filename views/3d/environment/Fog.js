/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/mathUtils","../../../core/maybe","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../../chunks/mat4","../../../chunks/mat4f64","../../../chunks/vec2","../../../chunks/vec2f64","../../../chunks/vec3","../../../chunks/vec3f32","../../../geometry/projectionEllipsoid","./atmosphereUtils","./FogTechnique","./weather","../webgl-engine/lib/DefaultVertexBufferLayouts","../webgl-engine/lib/glUtil3D","../../webgl/enums"],(function(e,t,i,r,o,s,n,a,h,c,u,g,_,f,p,l,d,m,v,F,y,T,q,b){"use strict";e.Fog=function(e){function i(t){var i;(i=e.call(this,t)||this)._projectionInverse=_.create(),i._viewInverse=_.create(),i._nearFar=p.create(),i._fogColor=d.create(),i._fogColorAtNight=d.create(),i._cameraDirection=d.create(),i._foggyFadeStart=.3,i._foggyFadeEnd=.6,i._hazeFadeStart=.7,i._hazeFadeEnd=1,i._strength=4e-6;const r=t.context.renderContext.rctx;i._vao=q.createQuadVAO(r,T.Pos2Tex);const o=m.getReferenceEllipsoid(t.view.spatialReference);return i._planetRadius=o.radius,i._atmosphereRadius=o.radius+v.atmosphereHeight,i}t._inheritsLoose(i,e);var r=i.prototype;return r.destroy=function(){this._hazeFogTechnique=s.releaseMaybe(this._hazeFogTechnique),this._thickFogTechnique=s.releaseMaybe(this._thickFogTechnique),this._vao=s.disposeMaybe(this._vao)},r.when=function(){return Promise.resolve()},r.render=function(e,t,i){if(0===this.view.basemapTerrain.baseOpacity&&!t)return;if(this._update(e,t,i),this._fogAmount<=0)return;const r=e.offscreenRenderingHelper,o=t?this.thickFogTechnique:this.hazeFogTechnique,s=e.rctx.useTechnique(o);r.renderDepthDetached((()=>{s.bindTexture(r.depthTexture,"depthTex"),this._renderFog(o.program,e)}))},r._renderFog=function(e,t){if(s.isNone(this._vao))return!1;const i=t.rctx;return e.setUniform3fv("cameraPosition",t.camera.eye),e.setUniformMatrix4fv("inverseProjectionMatrix",this._projectionInverse),e.setUniformMatrix4fv("inverseViewMatrix",this._viewInverse),e.setUniform2fv("nearFar",this._nearFar),e.setUniform1f("atmosphereC",this._atmosphereC),e.setUniform1f("fogStrength",this._strength),e.setUniform1f("fogAmount",this._fogAmount),e.setUniform3fv("fogColor",this._fogColor),i.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),i.drawArrays(b.PrimitiveType.TRIANGLE_STRIP,0,4),!0},r._update=function(e,t,i){if(s.isNone(e.camera))return;const r=t?.1:0;i?l.set(this._fogColor,.5,.5,.5):t?l.set(this._fogColor,1.5,1.5,1.5):l.set(this._fogColor,.24,.44,.8),l.scale(this._fogColorAtNight,this._fogColor,r),l.normalize(this._cameraDirection,e.camera.eye);const n=Math.max(0,l.dot(this._cameraDirection,e.scenelightingData.lightingMainDirection));l.lerp(this._fogColor,this._fogColorAtNight,this._fogColor,n),g.invert(this._projectionInverse,e.camera.projectionMatrix),g.invert(this._viewInverse,e.camera.viewMatrix),f.set(this._nearFar,e.camera.near,e.camera.far);const a=l.length(e.camera.eye),h=a*a;this._atmosphereC=h-this._atmosphereRadius*this._atmosphereRadius,this._fogAmount=t?1-o.smoothstep(this._foggyFadeStart*y.weatherHeightLimit,this._foggyFadeEnd*y.weatherHeightLimit,Math.abs(a-this._planetRadius)):1-o.smoothstep(this._hazeFadeStart*y.weatherHeightLimit,this._hazeFadeEnd*y.weatherHeightLimit,Math.abs(a-this._planetRadius))},i.isSupported=function(e){return e.capabilities.depthTexture},t._createClass(i,[{key:"_shaderTechniqueRepository",get:function(){return this.context.shaderTechniqueRepository}},{key:"strength",get:function(){return this._strength},set:function(e){this._strength=e}},{key:"thickFogTechnique",get:function(){if(s.isNone(this._thickFogTechnique)){const e=new F.FogTechniqueConfiguration;e.haze=!1,this._thickFogTechnique=this._shaderTechniqueRepository.acquire(F.FogTechnique,e)}return this._thickFogTechnique}},{key:"hazeFogTechnique",get:function(){if(s.isNone(this._hazeFogTechnique)){const e=new F.FogTechniqueConfiguration;e.haze=!0,this._hazeFogTechnique=this._shaderTechniqueRepository.acquire(F.FogTechnique,e)}return this._hazeFogTechnique}}]),i}(r),i.__decorate([n.property({constructOnly:!0})],e.Fog.prototype,"context",void 0),i.__decorate([n.property({constructOnly:!0})],e.Fog.prototype,"view",void 0),e.Fog=i.__decorate([u.subclass("esri.views.3d.environment.Fog")],e.Fog),Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
