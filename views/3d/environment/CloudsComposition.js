/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/mathUtils","../../../core/maybe","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../../chunks/mat4","../../../chunks/mat4f64","../../../chunks/vec3","../../../chunks/vec3f64","../../../geometry/support/axisAngle","./CloudsCompositionTechnique","./weather","../webgl-engine/lib/glUtil3D","../../webgl/enums"],(function(a,t,e,r,s,i,o,n,c,h,m,p,d,_,u,l,f,I,F,g){"use strict";var H,C,O,x;function E(a,t,e){a.bindTexture(e.clouds.cubeMap.colorTexture,"cubeMap"),a.setUniform1f("cloudsHeight",e.parallax.cloudsHeight),a.setUniformMatrix4fv("rotationMatrixClouds",e.parallax.transform),a.setUniformMatrix4fv("rotationMatrixCloudsCrossFade",e.parallaxNew.transform),a.setUniform3fv("anchorPosition",e.parallax.anchorPointClouds),a.setUniform3fv("anchorPositionCrossFade",e.parallaxNew.anchorPointClouds),e.fadeInOut.stage!==C.FINISHED?a.setUniform1f("totalFadeInOut",e.fadeInOutHeight.factor+Math.max(s.clamp(e.fadeInOut.factor,0,1))):a.setUniform1f("totalFadeInOut",e.fadeInOutHeight.factor+Math.max(s.clamp(e.fadeIn.factor,0,1))),a.setUniform1f("radiusCurvatureCorrectionFactor",e.parallax.radiusCurvatureCorrectionFactor),a.setUniform1i("crossFade",e.crossFade.stage),a.setUniform1f("crossFadeAnchorFactor",s.clamp(e.crossFade.factor,0,1)),a.setUniform1f("radius",e.parallax.radius),a.setUniform3fv("cameraPosition",t.eye)}a.CloudsComposition=function(a){function e(t){var e;return(e=a.call(this,t)||this)._inverseProjectionMatrix=d.create(),e._inverseViewMatrix=d.create(),e._technique=new f.CloudsCompositionTechnique(t),e._vao=F.createQuadVAO(t.rctx),e._setDefaultParallax(t.radius),e}t._inheritsLoose(e,a);var r=e.prototype;return r.destroy=function(){this._technique=i.releaseMaybe(this._technique),this._vao=i.disposeMaybe(this._vao)},r.render=function(a,t,e){this._parameters.clouds=t;const r=a.camera;if(i.isNone(this._vao)||i.isNone(r))return;const s=a.rctx,o=s.useTechnique(this._technique);a.scenelightingData.setLightDirectionUniform(o),a.scenelightingData.setUniforms(o,!1,!1),p.invert(this._inverseProjectionMatrix,r.projectionMatrix),p.invert(this._inverseViewMatrix,r.viewMatrix),o.setUniformMatrix4fv("inverseProjectionMatrix",this._inverseProjectionMatrix),o.setUniformMatrix4fv("inverseViewMatrix",this._inverseViewMatrix),o.setUniform2f("cloudVariables",this._parameters.clouds.coverage,this._parameters.clouds.absorption),this._setParallaxParams(r.eye,e),a.cloudsCompositionParams=this._parameters,E(o,r,this._parameters),s.bindVAO(this._vao),o.assertCompatibleVertexAttributeLocations(this._vao),s.drawArrays(g.PrimitiveType.TRIANGLE_STRIP,0,4)},r._setDefaultParallax=function(a){this._parameters={parallax:{anchorPointClouds:u.create(),radius:a,cloudsHeight:1e5,radiusCurvatureCorrectionFactor:0,transform:d.create()},parallaxNew:{anchorPointClouds:u.create(),radius:a,cloudsHeight:1e5,radiusCurvatureCorrectionFactor:0,transform:d.create()},crossFade:{stage:O.FINISHED,factor:0,distanceThresholdFactor:.3},fadeInOut:{stage:C.FINISHED,factor:0,distanceThresholdFactor:.6},fadeIn:{stage:H.FINISHED,factor:0,distanceThresholdFactor:2},fadeInOutHeight:{stage:x.FINISHED,factor:-1},cameraPositionLastFrame:u.create(),startTime:0,startTimeHeightFade:0,clouds:null}},r._isCameraPositionFinal=function(a){return _.equals(this._parameters.cameraPositionLastFrame,a)},r._setFadeInStage=function(a){const t=this._isCameraPositionFinal(a);this._parameters.fadeIn.stage===H.FINISHED&&(this._parameters.fadeIn.factor=1,_.copy(this._parameters.parallax.anchorPointClouds,S),this._parameters.fadeIn.stage=H.CHANGE_ANCHOR,this._parameters.crossFade.stage=O.FINISHED,this._parameters.fadeInOut.stage=C.FINISHED),this._parameters.fadeIn.stage===H.CHANGE_ANCHOR&&t&&(_.copy(this._parameters.parallax.anchorPointClouds,S),this._parameters.fadeIn.stage=H.FADE_IN,this._parameters.startTime=performance.now()),this._parameters.fadeIn.factor>0&&this._parameters.fadeIn.stage===H.FADE_IN&&(this._parameters.fadeIn.factor=1-(performance.now()-this._parameters.startTime)/500),this._parameters.fadeIn.factor<=0&&this._parameters.fadeIn.stage===H.FADE_IN&&(this._parameters.fadeIn.stage=H.FINISHED,this._parameters.fadeIn.factor=0)},r._setCrossFadingStage=function(){this._parameters.crossFade.stage===O.FINISHED&&(_.copy(this._parameters.parallaxNew.anchorPointClouds,S),this._parameters.startTime=performance.now(),this._parameters.crossFade.factor=0,this._parameters.crossFade.stage=O.CROSS_FADE),this._parameters.crossFade.factor<1&&this._parameters.crossFade.stage===O.CROSS_FADE&&(this._parameters.crossFade.factor=(performance.now()-this._parameters.startTime)/500),this._parameters.crossFade.factor>=1&&this._parameters.crossFade.stage===O.CROSS_FADE&&(this._parameters.crossFade.stage=O.FINISHED,this._parameters.crossFade.factor=1,_.copy(this._parameters.parallax.anchorPointClouds,this._parameters.parallaxNew.anchorPointClouds))},r._setFadeInOutStage=function(a){this._parameters.fadeInOut.stage===C.FINISHED&&(this._parameters.startTime=performance.now(),this._parameters.fadeInOut.factor=0,this._parameters.fadeInOut.stage=C.FADE_OUT),this._parameters.fadeInOut.factor<1&&this._parameters.fadeInOut.stage===C.FADE_OUT&&(this._parameters.fadeInOut.factor=(performance.now()-this._parameters.startTime)/250),this._parameters.fadeInOut.factor>=1&&this._parameters.fadeInOut.stage===C.FADE_OUT&&(this._parameters.fadeInOut.factor=1,_.copy(this._parameters.parallax.anchorPointClouds,S)),this._parameters.fadeInOut.factor>=1&&this._parameters.fadeInOut.stage===C.FADE_OUT&&this._isCameraPositionFinal(a)&&(this._parameters.startTime=performance.now(),this._parameters.fadeInOut.factor=1,this._parameters.fadeInOut.stage=C.FADE_IN,this._parameters.crossFade.stage=O.FINISHED,this._parameters.crossFade.factor=0),this._parameters.fadeInOut.factor>0&&this._parameters.fadeInOut.stage===C.FADE_IN&&(this._parameters.fadeInOut.factor=1-(performance.now()-this._parameters.startTime)/500),this._parameters.fadeInOut.factor<=0&&this._parameters.fadeInOut.stage===C.FADE_IN&&(this._parameters.fadeInOut.stage=C.FINISHED,this._parameters.fadeInOut.factor=0)},r._setFadeInOutHeight=function(a){const t=performance.now();this._parameters.startTimeHeightFade=this._parameters.fadeInOutHeight.stage===x.FINISHED?t:this._parameters.startTimeHeightFade,a?this._parameters.fadeInOutHeight.factor+=(t-this._parameters.startTimeHeightFade)/500:this._parameters.fadeInOutHeight.factor-=(t-this._parameters.startTimeHeightFade)/500,this._parameters.startTimeHeightFade=t,this._parameters.fadeInOutHeight.factor=s.clamp(this._parameters.fadeInOutHeight.factor,0,1),this._parameters.fadeInOutHeight.stage=x.HEIGHT_FADE},r._setParallaxParams=function(a,t){this._parameters.fadeInOutHeight.factor<0&&(this._parameters.fadeInOutHeight.factor=_.length(a)-this._parameters.parallax.radius>I.weatherHeightLimit?1:0),_.normalize(S,a),_.scale(S,S,this._parameters.parallax.radius),0===this._parameters.parallax.anchorPointClouds[0]&&0===this._parameters.parallax.anchorPointClouds[1]&&0===this._parameters.parallax.anchorPointClouds[2]&&_.copy(this._parameters.parallax.anchorPointClouds,S);const e=_.length(_.subtract(v,this._parameters.parallax.anchorPointClouds,S));let r=!0;e>this._parameters.fadeIn.distanceThresholdFactor*this._parameters.parallax.cloudsHeight||this._parameters.fadeIn.stage!==H.FINISHED?this._setFadeInStage(a):e>this._parameters.fadeInOut.distanceThresholdFactor*this._parameters.parallax.cloudsHeight||this._parameters.fadeInOut.stage!==C.FINISHED?this._setFadeInOutStage(a):e>this._parameters.crossFade.distanceThresholdFactor*this._parameters.parallax.cloudsHeight&&!t||this._parameters.crossFade.stage!==O.FINISHED?this._setCrossFadingStage():r=!1;const s=_.length(a),i=s-this._parameters.parallax.radius;(i>1.7*I.weatherHeightLimit||i<-I.weatherHeightLimit)&&this._parameters.fadeInOutHeight.factor<1?this._parameters.fadeInOutHeight.factor=1:(i>I.weatherHeightLimit||i<-.35*I.weatherHeightLimit)&&this._parameters.fadeInOutHeight.factor<1?this._setFadeInOutHeight(!0):i<I.weatherHeightLimit&&i>-.35*I.weatherHeightLimit&&this._parameters.fadeInOutHeight.factor>0?this._setFadeInOutHeight(!1):this._parameters.fadeInOutHeight.stage=x.FINISHED,this._parameters.parallax.radiusCurvatureCorrectionFactor=.84*Math.sqrt(Math.max(s*s-this._parameters.parallax.radius*this._parameters.parallax.radius,0))/s,l.fromPoints(D,this._parameters.parallax.anchorPointClouds,N),this._parameters.parallax.transform=d.create(),p.rotate(this._parameters.parallax.transform,this._parameters.parallax.transform,N[3],l.axis(N)),r&&(l.fromPoints(D,this._parameters.parallaxNew.anchorPointClouds,N),this._parameters.parallaxNew.transform=d.create(),p.rotate(this._parameters.parallaxNew.transform,this._parameters.parallaxNew.transform,N[3],l.axis(N))),_.copy(this._parameters.cameraPositionLastFrame,a)},t._createClass(e,[{key:"isFading",get:function(){return this._parameters.crossFade.stage!==O.FINISHED||this._parameters.fadeInOut.stage!==C.FINISHED||this._parameters.fadeIn.stage!==H.FINISHED||this._parameters.fadeInOutHeight.stage!==x.FINISHED}}]),e}(r),e.__decorate([o.property({constructOnly:!0})],a.CloudsComposition.prototype,"rctx",void 0),e.__decorate([o.property({constructOnly:!0})],a.CloudsComposition.prototype,"viewingMode",void 0),e.__decorate([o.property({constructOnly:!0})],a.CloudsComposition.prototype,"radius",void 0),a.CloudsComposition=e.__decorate([m.subclass("esri.views.3d.environment.CloudsComposition")],a.CloudsComposition),function(a){a[a.FINISHED=0]="FINISHED",a[a.CHANGE_ANCHOR=1]="CHANGE_ANCHOR",a[a.FADE_IN=2]="FADE_IN"}(H||(H={})),function(a){a[a.FINISHED=0]="FINISHED",a[a.FADE_OUT=1]="FADE_OUT",a[a.FADE_IN=2]="FADE_IN"}(C||(C={})),function(a){a[a.FINISHED=0]="FINISHED",a[a.CROSS_FADE=1]="CROSS_FADE"}(O||(O={})),function(a){a[a.FINISHED=0]="FINISHED",a[a.HEIGHT_FADE=1]="HEIGHT_FADE"}(x||(x={}));const D=u.fromValues(0,0,1),N=l.create(),S=u.create(),v=u.create();a.bindCloudsComposition=E,Object.defineProperties(a,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
