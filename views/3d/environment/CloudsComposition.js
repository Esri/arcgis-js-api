/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../../core/mathUtils","../../../core/maybe","../../../chunks/mat4","../../../chunks/mat4f64","../../../chunks/vec3","../../../chunks/vec3f64","../../../geometry/support/axisAngle","./CloudsCompositionTechnique","../webgl-engine/lib/glUtil3D"],(function(a,t,s,r,e,i,o,n,c,d){"use strict";var h,m,l;!function(a){a[a.FINISHED=0]="FINISHED",a[a.CHANGE_ANCHOR=1]="CHANGE_ANCHOR",a[a.FADE_IN=2]="FADE_IN"}(h||(h={})),function(a){a[a.FINISHED=0]="FINISHED",a[a.FADE_OUT=1]="FADE_OUT",a[a.FADE_IN=2]="FADE_IN"}(m||(m={})),function(a){a[a.FINISHED=0]="FINISHED",a[a.CROSS_FADE=1]="CROSS_FADE"}(l||(l={}));let _=function(){function a(a,t,s){this._viewingMode=t,this._inverseProjectionMatrix=e.create(),this._inverseViewMatrix=e.create(),this._cameraPositionLastFrame=o.create(),this._cloudCompositionTechnique=new c.CloudsCompositionTechnique({rctx:a,viewingMode:this._viewingMode},null),this._vao=d.createQuadVAO(a),this._setDefaultParallax(s)}var _=a.prototype;return _.destroy=function(){this._cloudCompositionTechnique=s.releaseMaybe(this._cloudCompositionTechnique),this._vao=s.disposeMaybe(this._vao)},_.render=function(a,t){const e=a.camera;if(s.isNone(this._vao)||s.isNone(e))return!1;const i=a.rctx,o=this._cloudCompositionTechnique.program;return i.useProgram(o),this._cloudCompositionTechnique.bindPipelineState(i),a.scenelightingData.setLightDirectionUniform(o),a.scenelightingData.setUniforms(o),r.invert(this._inverseProjectionMatrix,e.projectionMatrix),r.invert(this._inverseViewMatrix,e.viewMatrix),o.setUniformMatrix4fv("inverseProjectionMatrix",this._inverseProjectionMatrix),o.setUniformMatrix4fv("inverseViewMatrix",this._inverseViewMatrix),o.bindTexture(t.colorTexture,"cubeMap"),this._setParallaxParams(e.eye),this._bindParallaxParams(o,a.camera),i.bindVAO(this._vao),o.assertCompatibleVertexAttributeLocations(this._vao),i.drawArrays(5,0,4),!0},_.isFading=function(){return this._crossFadeParams.crossFadeStage!==l.FINISHED||this._fadeInOutParams.fadeInOutStage!==m.FINISHED||this._fadeInParams.fadeInStage!==h.FINISHED},_._setDefaultParallax=function(a){this._parallaxParams={anchorPointClouds:o.create(),radius:a,cloudsFadeOutHeightFactor:0,cloudsHeight:1e5,radiusCurvatureCorrectionFactor:0,transform:e.create()},this._parallaxParamsNew={anchorPointClouds:o.create(),radius:a,cloudsFadeOutHeightFactor:0,cloudsHeight:1e5,radiusCurvatureCorrectionFactor:0,transform:e.create()},this._crossFadeParams={crossFadeStage:l.FINISHED,crossFadeFactor:0,distanceThresholdFactor:.3},this._fadeInOutParams={fadeInOutStage:m.FINISHED,fadeInOutFactor:0,distanceThresholdFactor:.6},this._fadeInParams={fadeInStage:h.FINISHED,fadeInFactor:0,distanceThresholdFactor:2}},_._isCameraPossitionFinal=function(a){return i.equals(this._cameraPositionLastFrame,a)},_._setFadeInStage=function(a){const t=this._isCameraPossitionFinal(a);this._fadeInParams.fadeInStage===h.FINISHED&&(this._fadeInParams.fadeInFactor=1,i.copy(this._parallaxParams.anchorPointClouds,I),this._fadeInParams.fadeInStage=h.CHANGE_ANCHOR,this._crossFadeParams.crossFadeStage=l.FINISHED,this._fadeInOutParams.fadeInOutStage=m.FINISHED),this._fadeInParams.fadeInStage===h.CHANGE_ANCHOR&&t&&(i.copy(this._parallaxParams.anchorPointClouds,I),this._fadeInParams.fadeInStage=h.FADE_IN,this._startTime=performance.now()),this._fadeInParams.fadeInFactor>0&&this._fadeInParams.fadeInStage===h.FADE_IN&&(this._fadeInParams.fadeInFactor=1-(performance.now()-this._startTime)/500),this._fadeInParams.fadeInFactor<=0&&this._fadeInParams.fadeInStage===h.FADE_IN&&(this._fadeInParams.fadeInStage=h.FINISHED,this._fadeInParams.fadeInFactor=0)},_._setCrossFadingStage=function(){this._crossFadeParams.crossFadeStage===l.FINISHED&&(i.copy(this._parallaxParamsNew.anchorPointClouds,I),this._startTime=performance.now(),this._crossFadeParams.crossFadeFactor=0,this._crossFadeParams.crossFadeStage=l.CROSS_FADE),this._crossFadeParams.crossFadeFactor<1&&this._crossFadeParams.crossFadeStage===l.CROSS_FADE&&(this._crossFadeParams.crossFadeFactor=(performance.now()-this._startTime)/500),this._crossFadeParams.crossFadeFactor>=1&&this._crossFadeParams.crossFadeStage===l.CROSS_FADE&&(this._crossFadeParams.crossFadeStage=l.FINISHED,this._crossFadeParams.crossFadeFactor=1,i.copy(this._parallaxParams.anchorPointClouds,this._parallaxParamsNew.anchorPointClouds))},_._setFadeInOutStage=function(a){const t=this._isCameraPossitionFinal(a);this._fadeInOutParams.fadeInOutStage===m.FINISHED&&(this._startTime=performance.now(),this._fadeInOutParams.fadeInOutFactor=0,this._fadeInOutParams.fadeInOutStage=m.FADE_OUT),this._fadeInOutParams.fadeInOutFactor<1&&this._fadeInOutParams.fadeInOutStage===m.FADE_OUT&&(this._fadeInOutParams.fadeInOutFactor=(performance.now()-this._startTime)/250),this._fadeInOutParams.fadeInOutFactor>=1&&this._fadeInOutParams.fadeInOutStage===m.FADE_OUT&&(this._fadeInOutParams.fadeInOutFactor=1,i.copy(this._parallaxParams.anchorPointClouds,I)),this._fadeInOutParams.fadeInOutFactor>=1&&this._fadeInOutParams.fadeInOutStage===m.FADE_OUT&&t&&(this._startTime=performance.now(),this._fadeInOutParams.fadeInOutFactor=1,this._fadeInOutParams.fadeInOutStage=m.FADE_IN,this._crossFadeParams.crossFadeStage=l.FINISHED,this._crossFadeParams.crossFadeFactor=0),this._fadeInOutParams.fadeInOutFactor>0&&this._fadeInOutParams.fadeInOutStage===m.FADE_IN&&(this._fadeInOutParams.fadeInOutFactor=1-(performance.now()-this._startTime)/500),this._fadeInOutParams.fadeInOutFactor<=0&&this._fadeInOutParams.fadeInOutStage===m.FADE_IN&&(this._fadeInOutParams.fadeInOutStage=m.FINISHED,this._fadeInOutParams.fadeInOutFactor=0)},_._setParallaxParams=function(a){i.normalize(I,a),i.scale(I,I,this._parallaxParams.radius),0===this._parallaxParams.anchorPointClouds[0]&&0===this._parallaxParams.anchorPointClouds[1]&&0===this._parallaxParams.anchorPointClouds[2]&&i.copy(this._parallaxParams.anchorPointClouds,I);const s=i.length(i.subtract(F,this._parallaxParams.anchorPointClouds,I));let o=!0;s>this._fadeInParams.distanceThresholdFactor*this._parallaxParams.cloudsHeight||this._fadeInParams.fadeInStage!==h.FINISHED?this._setFadeInStage(a):s>this._fadeInOutParams.distanceThresholdFactor*this._parallaxParams.cloudsHeight||this._fadeInOutParams.fadeInOutStage!==m.FINISHED?this._setFadeInOutStage(a):s>this._crossFadeParams.distanceThresholdFactor*this._parallaxParams.cloudsHeight||this._crossFadeParams.crossFadeStage!==l.FINISHED?this._setCrossFadingStage():o=!1;const c=i.length(a),d=c-this._parallaxParams.radius,_=.05*this._parallaxParams.cloudsHeight,P=.1*this._parallaxParams.cloudsHeight,O=1/(_-P),p=-P/(_-P);this._parallaxParams.cloudsFadeOutHeightFactor=1-t.clamp(d*O+p,0,1),this._parallaxParams.radiusCurvatureCorrectionFactor=.84*Math.sqrt(Math.max(c*c-this._parallaxParams.radius*this._parallaxParams.radius,0))/c,n.fromPoints(u,this._parallaxParams.anchorPointClouds,f),this._parallaxParams.transform=e.create(),r.rotate(this._parallaxParams.transform,this._parallaxParams.transform,f[3],n.axis(f)),o&&(n.fromPoints(u,this._parallaxParamsNew.anchorPointClouds,f),this._parallaxParamsNew.transform=e.create(),r.rotate(this._parallaxParamsNew.transform,this._parallaxParamsNew.transform,f[3],n.axis(f))),i.copy(this._cameraPositionLastFrame,a)},_._bindParallaxParams=function(a,s){a.setUniform1f("cloudsHeight",this._parallaxParams.cloudsHeight),a.setUniformMatrix4fv("rotationMatrixClouds",this._parallaxParams.transform),a.setUniformMatrix4fv("rotationMatrixCloudsCrossFade",this._parallaxParamsNew.transform),a.setUniform3fv("anchorPosition",this._parallaxParams.anchorPointClouds),a.setUniform3fv("anchorPositionCrossFade",this._parallaxParamsNew.anchorPointClouds),this._fadeInOutParams.fadeInOutStage!==m.FINISHED?a.setUniform1f("totalFadeInOut",this._parallaxParams.cloudsFadeOutHeightFactor+Math.max(t.clamp(this._fadeInOutParams.fadeInOutFactor,0,1))):a.setUniform1f("totalFadeInOut",this._parallaxParams.cloudsFadeOutHeightFactor+Math.max(t.clamp(this._fadeInParams.fadeInFactor,0,1))),a.setUniform1f("radiusCurvatureCorrectionFactor",this._parallaxParams.radiusCurvatureCorrectionFactor),a.setUniform1i("crossFade",this._crossFadeParams.crossFadeStage),a.setUniform1f("crossFadeAnchorFactor",t.clamp(this._crossFadeParams.crossFadeFactor,0,1)),a.setUniform1f("radius",this._parallaxParams.radius),a.setUniform3fv("cameraPosition",s.eye)},a}();const u=o.fromValues(0,0,1),f=n.create(),I=o.create(),F=o.create();a.CloudsComposition=_,Object.defineProperty(a,"__esModule",{value:!0})}));
