/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{_ as t}from"../../../chunks/tslib.es6.js";import a from"../../../core/Accessor.js";import{clamp as e}from"../../../core/mathUtils.js";import{releaseMaybe as s,disposeMaybe as o,isNone as r}from"../../../core/maybe.js";import{property as n}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/arrayUtils.js";import"../../../core/has.js";import"../../../core/accessorSupport/ensureType.js";import{subclass as c}from"../../../core/accessorSupport/decorators/subclass.js";import{e as i}from"../../../chunks/mat4.js";import{c as d}from"../../../chunks/mat4f64.js";import{c as f,z as u,l as m,n as l,g as h,b as I}from"../../../chunks/vec3.js";import{f as p,c as g}from"../../../chunks/vec3f64.js";import{create as F,fromPoints as H,axis as _}from"../../../geometry/support/axisAngle.js";import{FadeInOutStages as C,FadeInStages as O,FadeHeightStages as E}from"./CloudsCompositionParameters.js";import{CloudsCompositionTechnique as N}from"./CloudsCompositionTechnique.js";import{ensureClouds as b}from"./CloudsData.js";import{weatherHeightLimit as D}from"./weather.js";import{NoParameters as T}from"../webgl-engine/core/shaderModules/interfaces.js";import{createQuadVAO as P}from"../webgl-engine/lib/glUtil3D.js";import{PrimitiveType as S}from"../../webgl/enums.js";let j=class extends a{constructor(t){super(t),this._technique=new N(t),this._vao=P(t.rctx)}destroy(){this._technique=s(this._technique),this._vao=o(this._vao)}render(t,a){const e=t.bindParameters.clouds;if(r(this._vao)||r(e.data))return;if(!this._technique.compiled)return void this.requestRender();this._setParallaxParameters(e,t.bindParameters.camera.eye,a);const s=t.rctx.bindTechnique(this._technique,L,t.bindParameters);t.rctx.bindVAO(this._vao),s.assertCompatibleVertexAttributeLocations(this._vao),t.rctx.drawArrays(S.TRIANGLE_STRIP,0,4),k(e)&&this.requestRender()}_setFadeInStage(t,a){const e=performance.now(),s=t.parallax.anchorPointClouds;t.fadeIn.stage===O.FINISHED&&(t.fadeIn.factor=1,f(s,v),t.fadeIn.stage=O.CHANGE_ANCHOR,t.crossFade.enabled=!1,t.fadeInOut.stage=C.FINISHED);const o=G(t,a);t.fadeIn.stage===O.CHANGE_ANCHOR&&o&&b(t.data)&&(f(s,v),t.fadeIn.stage=O.FADE_IN,t.startTime=e),t.fadeIn.factor>0&&t.fadeIn.stage===O.FADE_IN&&(t.fadeIn.factor=1-(e-t.startTime)/y),t.fadeIn.factor<=0&&t.fadeIn.stage===O.FADE_IN&&(t.fadeIn.stage=O.FINISHED,t.fadeIn.factor=0)}_setCrossFadingStage(t){const a=performance.now(),{crossFade:e}=t,s=t.parallax.anchorPointClouds;t.crossFade.enabled||(f(t.parallaxNew.anchorPointClouds,v),t.startTime=a,e.factor=0,t.crossFade.enabled=!0),e.factor<1&&t.crossFade.enabled&&(e.factor=(a-t.startTime)/q),e.factor>=1&&t.crossFade.enabled&&(t.crossFade.enabled=!1,e.factor=1,f(s,t.parallaxNew.anchorPointClouds))}_setFadeInOutStage(t,a){const e=performance.now(),{fadeInOut:s,crossFade:o}=t;s.stage===C.FINISHED&&(t.startTime=e,s.factor=0,s.stage=C.FADE_OUT),s.factor<1&&s.stage===C.FADE_OUT&&(s.factor=(e-t.startTime)/R),s.factor>=1&&s.stage===C.FADE_OUT&&(s.factor=1,f(t.parallax.anchorPointClouds,v)),s.factor>=1&&s.stage===C.FADE_OUT&&G(t,a)&&(s.factor=1,s.stage=C.SWITCH,t.crossFade.enabled=!1,o.factor=1),b(t.data)&&s.stage===C.SWITCH&&(t.startTime=e,s.factor=1,s.stage=C.FADE_IN,f(t.parallax.anchorPointClouds,v),t.crossFade.enabled=!1,o.factor=1),s.factor>0&&s.stage===C.FADE_IN&&(s.factor=1-(e-t.startTime)/y),s.factor<=0&&s.stage===C.FADE_IN&&(s.stage=C.FINISHED,s.factor=0)}_setFadeInOutHeight(t,a){const s=performance.now(),o=t.fadeInOutHeight,r=(s-(o.stage===E.FINISHED?s:t.startTimeHeightFade))/U;o.factor+=a?-r:r,t.startTimeHeightFade=s,o.factor=e(o.factor,0,1),o.stage=E.HEIGHT_FADE}_setParallaxParameters(t,a,e){const{parallax:s}=t;t.fadeInOutHeight.factor<0&&(t.fadeInOutHeight.factor=m(a)-this.planetRadius>D?1:0),l(v,a),h(v,v,this.planetRadius),0===s.anchorPointClouds[0]&&0===s.anchorPointClouds[1]&&0===s.anchorPointClouds[2]&&f(s.anchorPointClouds,v);const o=m(I(w,s.anchorPointClouds,v));let r=!0;o>t.fadeIn.distanceThresholdFactor*s.cloudsHeight||t.fadeIn.stage!==O.FINISHED?this._setFadeInStage(t,a):o>t.fadeInOut.distanceThresholdFactor*s.cloudsHeight||t.fadeInOut.stage!==C.FINISHED?this._setFadeInOutStage(t,a):o>t.crossFade.distanceThresholdFactor*s.cloudsHeight&&!e||t.crossFade.enabled?this._setCrossFadingStage(t):r=!1;const n=m(a),c=n-this.planetRadius;if((c>1.7*D||c<-D)&&t.fadeInOutHeight.factor<1?t.fadeInOutHeight.factor=1:(c>D||c<-.35*D)&&t.fadeInOutHeight.factor<1?this._setFadeInOutHeight(t,!1):c<D&&c>-.35*D&&t.fadeInOutHeight.factor>0?this._setFadeInOutHeight(t,!0):t.fadeInOutHeight.stage=E.FINISHED,s.radiusCurvatureCorrectionFactor=.84*Math.sqrt(Math.max(n*n-this.planetRadius*this.planetRadius,0))/n,H(A,s.anchorPointClouds,x),s.transform=d(),i(s.transform,s.transform,x[3],_(x)),r){const{parallaxNew:a}=t;H(A,a.anchorPointClouds,x),a.transform=d(),i(a.transform,a.transform,x[3],_(x))}f(t.cameraPositionLastFrame,a)}};t([n({constructOnly:!0})],j.prototype,"rctx",void 0),t([n({constructOnly:!0})],j.prototype,"viewingMode",void 0),t([n({constructOnly:!0})],j.prototype,"planetRadius",void 0),t([n({constructOnly:!0})],j.prototype,"requestRender",void 0),j=t([c("esri.views.3d.environment.CloudsComposition")],j);const A=p(0,0,1),x=F(),v=g(),w=g(),y=500,R=250,q=500,U=500;function k(t){return t.crossFade.enabled||t.fadeInOut.stage!==C.FINISHED||t.fadeIn.stage!==O.FINISHED||t.fadeInOutHeight.stage!==E.FINISHED}function G(t,a){return u(t.cameraPositionLastFrame,a)}const L=new T;export{j as CloudsComposition};
