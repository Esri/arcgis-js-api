/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../core/Logger","../../../core/mathUtils","../../../core/promiseUtils","../../../core/watchUtils","../../../chunks/mat4","../../../chunks/mat4f64","../../../chunks/vec2","../../../chunks/vec2f64","../../../chunks/vec3","../../../chunks/vec3f64","../../../geometry/projectionEllipsoid","../../../geometry/support/spatialReferenceUtils","../../../support/requestImageUtils","./atmosphereUtils","./SimpleAtmosphereTechnique","./resources/MarsAtmosphereTexture","./resources/SimpleAtmosphereTexture","../support/mathUtils","../support/buffer/glUtil","../support/buffer/InterleavedLayout","../webgl-engine/lib/DefaultVertexAttributeLocations","../webgl-engine/lib/glUtil3D","../webgl-engine/lib/Util","../../webgl/BufferObject","../../webgl/Texture","../../webgl/Util","../../webgl/VertexArrayObject"],(function(e,t,r,i,s,a,n,o,h,l,c,u,d,p,m,f,_,g,x,C,R,V,v,y,b,A,D,U){"use strict";const w=t.getLogger("esri.views.3d.environment.SimpleAtmosphere"),q=128,F=-m.INNER_ATMOSPHERE_DEPTH,S=0,M=50,T=()=>1-511/512,j=x.makePiecewiseLinearFunction([[50,.1015625],[500,.21875],[5e3,1-250/512],[5e4,.4140625]]);let k=function(){function t(e){this.view=e,this.slot=14,this._renderData={texV:h.create(),silCircleCenter:c.create(),silCircleV1:c.create(),silCircleV2:c.create(),altitudeFade:0,innerScale:0,undergroundFadeAlpha:0},this._fadeVaoCount=0,this._readyResolver=i.createResolver(),this._readyController=i.createAbortController(),this.texV1=1,this.isOnMars=d.isMars(e.spatialReference);const t=u.getReferenceEllipsoid(e.spatialReference);this.planetRadius=t.radius,this.outerRimWidth=t.outerAtmosphereRimWidth,this.innerRimFactor=(this.planetRadius+F)/this.planetRadius,this.middleRimFactor=(this.planetRadius+S)/this.planetRadius,this.outerRimFactor=(this.planetRadius+this.outerRimWidth)/this.planetRadius,this.texV0=S/this.outerRimWidth,this.texVScale=this.texV1-this.texV0}var n=t.prototype;return n.when=function(){return this._readyResolver.promise},n.initializeRenderContext=function(e){const t=e.renderContext.rctx;this._cameraChangeHandle=s.init(this.view,"state.camera",(()=>e.requestRender()),!0);const r=new f.SimpleAtmosphereTechniqueConfiguration;r.geometry=0,this._atmosphereConeTechnique=e.shaderTechniqueRep.acquire(f.SimpleAtmosphereTechnique,r),r.geometry=2,this._atmosphereUndergroundTechnique=e.shaderTechniqueRep.acquire(f.SimpleAtmosphereTechnique,r),this._vao=this._createRibbon(t),this._vaoCount=D.vertexCount(this._vao,"geometry"),this._fadeVao=v.createQuadVAO(t),this._fadeVaoCount=D.vertexCount(this._fadeVao,"geometry"),p.requestImage(this.isOnMars?_:g,{signal:this._readyController.signal}).then((r=>{this._texture=new A(t,{pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0},r),e.requestRender(),this._readyController=null,this._readyResolver.resolve()})).catch((e=>{i.isAbortError(e)||w.error("Unable to initialize simple atmosphere: image request failed",e),this._readyResolver.reject()}))},n.uninitializeRenderContext=function(){this.destroy()},n.destroy=function(){this._readyResolver.reject(),this._cameraChangeHandle&&(this._cameraChangeHandle.remove(),this._cameraChangeHandle=null),this._texture&&(this._texture.dispose(),this._texture=null),this._fadeVao&&(this._fadeVao.dispose(),this._fadeVao=null),this._vao&&(this._vao.dispose(),this._vao=null),this._readyController&&(this._readyController.abort(),this._readyController=null)},n.render=function(e){if(e.slot!==this.slot||0!==e.pass)return!1;this._update(e.camera);const t=e.rctx;if(this._atmosphereConeTechnique.bindPipelineState(t),this._renderData.undergroundFadeAlpha<1){const r=this._atmosphereConeTechnique.program;t.useProgram(r),r.setUniformMatrix4fv("proj",e.camera.projectionMatrix),r.setUniformMatrix4fv("view",e.camera.viewMatrix),r.setUniform3fv("silCircleCenter",this._renderData.silCircleCenter),r.setUniform3fv("silCircleV1",this._renderData.silCircleV1),r.setUniform3fv("silCircleV2",this._renderData.silCircleV2),r.setUniform2fv("texV",this._renderData.texV),r.bindTexture(this._texture,"tex"),e.scenelightingData.setLightDirectionUniform(r),r.setUniform1f("altitudeFade",this._renderData.altitudeFade),r.setUniform1f("innerScale",this._renderData.innerScale),t.bindVAO(this._vao),t.drawArrays(4,0,this._vaoCount)}if(this._renderData.undergroundFadeAlpha>0){const r=this._atmosphereUndergroundTechnique.program;t.useProgram(r),r.setUniform1f("undergroundFadeAlpha",this._renderData.undergroundFadeAlpha),e.scenelightingData.setLightDirectionUniform(r),r.setUniform3fv("cameraPosition",e.camera.eye),t.bindVAO(this._fadeVao),t.drawArrays(5,0,this._fadeVaoCount)}return!0},n._update=function(e){const t=c.create(),i=this.planetRadius,s=l.length(e.eye),a=s-i;if(a<0){const e=Math.min(-a/5e3,1);this._renderData.undergroundFadeAlpha=e}else this._renderData.undergroundFadeAlpha=0;const n=Math.max(M,a),h=i+F;this._renderData.innerScale=H(i+n,i,h)-1,this._renderData.altitudeFade=m.computeInnerAltitudeFade(a),l.scale(t,e.eye,(i+M)/s),L(t,e.center,e.up,i,this._renderData);const u=this._computeScreenRimWidth(e,t,e.up,this._renderData),d=T(),p=j(a);let f=this.texV0+d*this.texVScale,_=this.texV0+u*p*this.texVScale;if(a>M){L(e.eye,e.center,e.up,i,this._renderData);const t=this._computeScreenRimWidth(e,e.eye,e.up,this._renderData),s=r.clamp((t-1.5)/(u-1.5),0,1);f=this.texV0+s*d*this.texVScale,_=this.texV0+r.lerp(this.texV1,u*p,s)*this.texVScale}o.set(this._renderData.texV,f,_)},n._createRibbon=function(e){const t=new Float32Array(3+3*q*3),r=new Uint32Array(3*q*5);t[0]=0,t[1]=0,t[2]=-1;for(let a=0;a<q;a++){const e=9*a+3;t[e+0]=a,t[e+1]=this.innerRimFactor,t[e+2]=-1,t[e+3]=a,t[e+4]=this.middleRimFactor,t[e+5]=0,t[e+6]=a,t[e+7]=this.outerRimFactor,t[e+8]=1;const i=3*a+1,s=a===q-1?1:i+3,n=15*a;r[n+0]=i,r[n+1]=i+1,r[n+2]=s+1,r[n+3]=s+1,r[n+4]=s,r[n+5]=i,r[n+6]=i+1,r[n+7]=i+2,r[n+8]=s+2,r[n+9]=s+2,r[n+10]=s+1,r[n+11]=i+1,r[n+12]=i,r[n+13]=s,r[n+14]=0}const i=W.createBuffer(r.length),s=i.position;for(let a=0;a<r.length;++a){const e=3*r[a];s.set(a,0,t[e]),s.set(a,1,t[e+1]),s.set(a,2,t[e+2])}return new U(e,V.Default3D,{geometry:C.glLayout(W)},{geometry:b.createVertex(e,35044,i.buffer)})},n._computeScreenRimWidth=function(e,t,r,i){return l.add(P,i.silCircleCenter,i.silCircleV2),l.scale(E,P,this.outerRimFactor),a.lookAt(O,t,P,r),y.project(P,O,e.projectionMatrix,e.viewport),y.project(E,O,e.projectionMatrix,e.viewport),l.distance(P,E)/e.height},e._createClass(t,[{key:"canRender",get:function(){return null!=this._texture}}]),t}();function L(e,t,r,i,s){const a=l.length(e),n=i*Math.sqrt(a*a-i*i)/a,o=Math.sqrt(i*i-n*n),h=s.silCircleV1,c=s.silCircleV2;return l.scale(s.silCircleCenter,e,o/a),l.cross(h,e,t),l.squaredLength(h)<1&&l.cross(h,e,r),l.scale(h,h,n/l.length(h)),l.cross(c,h,e),l.scale(c,c,n/l.length(c)),n}const O=n.create(),P=c.create(),E=c.create();function H(e,t,r){return e*e/(Math.sqrt(e*e-t*t)*Math.sqrt(e*e-r*r)+t*r)}const W=R.newLayout().vec3f("position");return k}));
