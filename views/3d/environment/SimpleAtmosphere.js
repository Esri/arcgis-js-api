/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../core/mathUtils","../../../core/maybe","../../../core/reactiveUtils","../../../chunks/mat4","../../../chunks/mat4f64","../../../chunks/vec2","../../../chunks/vec3","../../../chunks/vec3f64","../../../geometry/projectionEllipsoid","../../../geometry/support/spatialReferenceUtils","./AtmosphereType","./atmosphereUtils","../../../chunks/SimpleAtmosphere.glsl","./SimpleAtmosphereTechnique","./SimpleAtmosphereTechniqueConfiguration","./resources/MarsAtmosphereTexture","./resources/SimpleAtmosphereTexture","../support/mathUtils","../support/buffer/glUtil","../support/buffer/InterleavedLayout","../webgl-engine/lib/DefaultVertexAttributeLocations","../webgl-engine/lib/glUtil3D","../webgl-engine/lib/Util","../webgl-engine/lib/VertexArrayObject","../webgl-engine/lib/VertexAttribute","../../webgl/BufferObject","../../webgl/enums","../../webgl/Texture","../../webgl/Util"],(function(e,t,s,i,r,a,n,o,h,c,u,p,l,m,d,_,g,f,y,x,T,A,b,R,P,V,q,S,v,w){"use strict";const C=128,M=-l.innerAtmosphereDepth,F=0,U=50,O=()=>1-511/512,k=y.makePiecewiseLinearFunction([[50,.1015625],[500,.21875],[5e3,1-250/512],[5e4,.4140625]]);let I=function(){function a(e){this.view=e,this.type=p.AtmosphereType.Simple,this._passParameters=new m.SimpleAtmospherePassParameters,this._fadeVaoCount=0,this._texV1=1,this._isOnMars=u.isMars(e.spatialReference);const t=c.getReferenceEllipsoid(e.spatialReference);this._planetRadius=t.radius,this._outerRimWidth=t.outerAtmosphereRimWidth,this._innerRimFactor=(this._planetRadius+M)/this._planetRadius,this._middleRimFactor=(this._planetRadius+F)/this._planetRadius,this._outerRimFactor=(this._planetRadius+this._outerRimWidth)/this._planetRadius,this._texV0=F/this._outerRimWidth,this._texVScale=this._texV1-this._texV0}var y=a.prototype;return y.destroy=function(){this._cameraChangeHandle=s.removeMaybe(this._cameraChangeHandle),this._passParameters.texture=s.disposeMaybe(this._passParameters.texture),this._fadeVao=s.disposeMaybe(this._fadeVao),this._vao=s.disposeMaybe(this._vao)},y.initializeRenderContext=function(){var t=e._asyncToGenerator((function*(e){this._shaderTechniqueRepository=e.shaderTechniqueRepository;const t=e.renderContext.rctx;this._cameraChangeHandle=i.watch((()=>this.view.state?.camera),(()=>e.requestRender()),i.syncAndInitial),this._vao=this._createRibbon(t),this._vaoCount=w.vertexCount(this._vao,"geometry"),this._fadeVao=b.createQuadVAO(t),this._fadeVaoCount=w.vertexCount(this._fadeVao,"geometry");const s=this._isOnMars?g.marsAtmosphereTextureSimple:f.earthAtmosphereTextureSimple;this._passParameters.texture=new v.Texture(t,{pixelFormat:S.PixelFormat.RGBA,dataType:S.PixelType.UNSIGNED_BYTE,wrapMode:S.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:S.TextureSamplingMode.LINEAR,flipped:!0,width:1,height:512},s),e.requestRender()}));function s(e){return t.apply(this,arguments)}return s}(),y.render=function(e){if(s.isNone(this._vao)||s.isNone(this._passParameters.texture))return;const t=e.bindParameters.camera;this._update(t);const i=e.rctx;this._passParameters.undergroundFadeAlpha<1&&(i.bindTechnique(this._coneTechnique,this._passParameters,e.bindParameters),i.bindVAO(this._vao),i.drawArrays(S.PrimitiveType.TRIANGLES,0,this._vaoCount)),this._passParameters.undergroundFadeAlpha>0&&(i.bindTechnique(this._undergroundTechnique,this._passParameters,e.bindParameters),i.bindVAO(this._fadeVao),i.drawArrays(S.PrimitiveType.TRIANGLE_STRIP,0,this._fadeVaoCount))},y.renderHaze=function(){},y._update=function(e){const s=h.create(),i=this._planetRadius,r=o.length(e.eye),a=r-i;if(a<0){const e=Math.min(-a/5e3,1);this._passParameters.undergroundFadeAlpha=e}else this._passParameters.undergroundFadeAlpha=0;const c=Math.max(U,a),u=i+M;this._passParameters.innerScale=W(i+c,i,u)-1,this._passParameters.altitudeFade=l.computeInnerAltitudeFade(a),o.scale(s,e.eye,(i+U)/r),L(s,e.center,e.up,i,this._passParameters.silhouette);const p=this._computeScreenRimWidth(e,s,e.up,this._passParameters.silhouette),m=O(),d=k(a);let _=this._texV0+m*this._texVScale,g=this._texV0+p*d*this._texVScale;if(a>U){L(e.eye,e.center,e.up,i,this._passParameters.silhouette);const s=this._computeScreenRimWidth(e,e.eye,e.up,this._passParameters.silhouette),r=t.clamp((s-1.5)/(p-1.5),0,1);_=this._texV0+r*m*this._texVScale,g=this._texV0+t.lerp(this._texV1,p*d,r)*this._texVScale}n.set(this._passParameters.texV,_,g)},y._createRibbon=function(e){const t=new Float32Array(3+3*C*3),s=new Uint32Array(3*C*5);t[0]=0,t[1]=0,t[2]=-1;for(let a=0;a<C;a++){const e=9*a+3;t[e+0]=a,t[e+1]=this._innerRimFactor,t[e+2]=-1,t[e+3]=a,t[e+4]=this._middleRimFactor,t[e+5]=0,t[e+6]=a,t[e+7]=this._outerRimFactor,t[e+8]=1;const i=3*a+1,r=a===C-1?1:i+3,n=15*a;s[n+0]=i,s[n+1]=i+1,s[n+2]=r+1,s[n+3]=r+1,s[n+4]=r,s[n+5]=i,s[n+6]=i+1,s[n+7]=i+2,s[n+8]=r+2,s[n+9]=r+2,s[n+10]=r+1,s[n+11]=i+1,s[n+12]=i,s[n+13]=r,s[n+14]=0}const i=D.createBuffer(s.length),r=i.position;for(let a=0;a<s.length;++a){const e=3*s[a];r.set(a,0,t[e]),r.set(a,1,t[e+1]),r.set(a,2,t[e+2])}return new P.VertexArrayObject(e,A.Default3D,{geometry:x.glLayout(D)},{geometry:q.BufferObject.createVertex(e,S.Usage.STATIC_DRAW,i.buffer)})},y._computeScreenRimWidth=function(e,t,s,i){return o.add(j,i.center,i.v2),o.scale(E,j,this._outerRimFactor),r.lookAt(N,t,j,s),R.project(j,N,e.projectionMatrix,e.viewport),R.project(E,N,e.projectionMatrix,e.viewport),o.distance(j,E)/e.height},e._createClass(a,[{key:"_coneTechnique",get:function(){if(s.isNone(this._coneTechniqueCached)){const e=new _.SimpleAtmosphereTechniqueConfiguration;e.geometry=_.SimpleAtmosphereGeometry.Cone,this._coneTechniqueCached=this._shaderTechniqueRepository.acquire(d.SimpleAtmosphereTechnique,e)}return this._coneTechniqueCached}},{key:"_undergroundTechnique",get:function(){if(s.isNone(this._undergroundTechniqueCached)){const e=new _.SimpleAtmosphereTechniqueConfiguration;e.geometry=_.SimpleAtmosphereGeometry.Underground,this._undergroundTechniqueCached=this._shaderTechniqueRepository.acquire(d.SimpleAtmosphereTechnique,e)}return this._undergroundTechniqueCached}}]),a}();function L(e,t,s,i,r){const a=o.length(e),n=i*Math.sqrt(a*a-i*i)/a,h=Math.sqrt(i*i-n*n),c=r.v1,u=r.v2;return o.scale(r.center,e,h/a),o.cross(c,e,t),o.squaredLength(c)<1&&o.cross(c,e,s),o.scale(c,c,n/o.length(c)),o.cross(u,c,e),o.scale(u,u,n/o.length(u)),n}const N=a.create(),j=h.create(),E=h.create();function W(e,t,s){return e*e/(Math.sqrt(e*e-t*t)*Math.sqrt(e*e-s*s)+t*s)}const D=T.newLayout().vec3f(V.VertexAttribute.POSITION);return I}));
