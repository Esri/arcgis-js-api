/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/has","../../../core/maybe","../../../core/Logger","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass","../../../core/urlUtils","../../../core/uuid","../../../portal/support/resourceExtension","../../../core/Accessor","../../../chunks/vec3f64","../../../chunks/vec3","./lighting/Lightsources","./lib/GeometryRecord","./lib/AutoDisposable","./parts/Model","./parts/RenderView"],(function(e,t,n,i,r,o,s,c,d,a,l,g,h,u,p,m,y,f,w,_){"use strict";var S;function v(e){return"function"==typeof e.addParentStage&&"function"==typeof e.removeParentStage}e.Stage=S=function(e){function n(t){var n;return(n=e.call(this,t)||this).model=new w.Model,n._viewContent=[],n._mainLightDirection=u.fromValues(0,1,0),n}t._inheritsLoose(n,e);var i=n.prototype;return i.initialize=function(){this._set("renderView",new _.RenderView(this)),this.setLighting({lights:[new m.MainLight(u.fromValues(.7,.7,.7)),new m.AmbientLight(u.fromValues(.3,.3,.3))],groundLightingFactor:.5,globalFactor:.5})},i.destroy=function(){y.pool.prune(0),this.dispose()},i.setLighting=function(e){p.set(this._mainLightDirection,0,0,0);for(const t of e.lights)if(t instanceof m.MainLight){p.negate(this._mainLightDirection,t.direction);break}this._lighting=e,this.renderView.setNeedsRender()},i.stopAnimationsAtTime=function(e){this.getAll(3).forEach((t=>{r.applySome(t.animation,(t=>t.stopAtTime(e)))})),this.renderView.setNeedsRender()},i.add=function(e,t){this.model.add(e,t),v(t)&&t.addParentStage(this),this.renderView.setNeedsRender()},i.remove=function(e,t){this.renderView.setNeedsRender();const n=this.model.remove(e,t);return v(n)&&n.removeParentStage(this),n},i.notifyDirty=function(e,t,n){this.destroyed||(this.model.notifyDirty(e,t,n),this.renderView.setNeedsRender())},i.processDirty=function(){const e=this.model.getDirtySet();if(!e.hasDirtyGeometryRecords())return;S.DebugSettings.logDirtySet&&console.log("Dirty set: "+this.model.getDirtySet().formatDebugInfo());const t=e.commitLayers(this._viewContent);t[0].length+t[1].length+t[2].length>0&&this.renderView.modify(t[0],t[1],t[2]),S.DebugSettings.logDirtySet&&(console.log("RGs add: "+t[0].map((e=>e.uniqueName))),console.log("RGs remove: "+t[1].map((e=>e.uniqueName)))),e.commit(),this.renderView.setNeedsRender()},i.processDirtyLayer=function(e){const t=this.model.getDirtySet().commitLayers([e]);t[0].length+t[1].length+t[2].length>0&&this.renderView.modify(t[0],t[1],t[2]),this.renderView.setNeedsRender()},i.getContent=function(e,t){return this.model.get(e,t)},i.getAll=function(e){return this.model.getAll(e)},i.getCount=function(e){return this.model.getAll(e).size},i.getCamera=function(){return this.renderView.getCamera()},i.setCamera=function(e){this.renderView.setCamera(e)},i.getLayers=function(){return this.model.getAll(0)},i.getViewContent=function(){return this._viewContent.slice(0)},i.addToViewContent=function(e){const t=[];for(let n=0;n<e.length;n++)-1===this._viewContent.indexOf(e[n])&&t.push(e[n]);if(e.length>0){this.processDirty();const e=this.model.getDirtySet().getResidentRenderGeometriesFilteredByLayers(t);this.renderView.modify(e,[],[]),this._viewContent.push.apply(this._viewContent,t)}},i.removeFromViewContent=function(e){this.processDirty();const t=this.model.getDirtySet(),n=this._viewContent,i=[];for(let t=0;t<e.length;t++){const r=n.indexOf(e[t]);r>-1&&(n[r]=n[n.length-1],n.pop(),i.push(e[t]))}const r=t.getResidentRenderGeometriesFilteredByLayers(i);this.renderView.modify([],r,[])},i.addRenderPlugin=function(e,t){"intersect"in t&&this.sceneIntersectionHelper.addIntersectionHandler(t),this.renderView.renderPlugins.add(e,t)},i.removeRenderPlugin=function(e){"intersect"in e&&this.sceneIntersectionHelper.removeIntersectionHandler(e),this.renderView.renderPlugins.remove(e)},t._createClass(n,[{key:"dirty",get:function(){return this.model.getDirtySet().hasDirtyGeometryRecords()}},{key:"mainLightDirection",get:function(){return this._mainLightDirection}},{key:"lighting",get:function(){return this._lighting}},{key:"performanceInfo",get:function(){return{renderView:this.renderView.performanceInfo,model:this.model.getStats()}}}]),n}(f.AutoDisposableMixin(h)),e.Stage.DebugSettings={endFrameContentValidation:!1,logDirtySet:!1},n.__decorate([c.property({constructOnly:!0})],e.Stage.prototype,"scheduler",void 0),n.__decorate([c.property({constructOnly:!0})],e.Stage.prototype,"options",void 0),n.__decorate([c.property({constructOnly:!0})],e.Stage.prototype,"sceneIntersectionHelper",void 0),n.__decorate([c.property({constructOnly:!0})],e.Stage.prototype,"viewingMode",void 0),n.__decorate([c.property({constructOnly:!0})],e.Stage.prototype,"container",void 0),n.__decorate([f.autoDispose(),c.property()],e.Stage.prototype,"renderView",void 0),e.Stage=S=n.__decorate([d.subclass("esri.views.3d.webgl-engine.Stage")],e.Stage),Object.defineProperty(e,"__esModule",{value:!0})}));
