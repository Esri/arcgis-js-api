/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/Handles","../../../core/maybe","../../../core/PooledArray","../../../core/promiseUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/accessorSupport/ensureType","../../../core/Logger","../../../core/accessorSupport/decorators/subclass","../state/helpers/SceneIntersectionHelper","./lib/AutoDisposable","./lib/ChangeSet","./lib/GeometryRecord","./lib/WebGLLayer","./parts/Model","./parts/RenderView","../../support/Scheduler"],(function(e,t,r,o,n,i,s,d,a,c,l,y,h,p,u,_,g,m,S,f,v){"use strict";var w;e.Stage=w=function(e){function r(t){var r;return(r=e.call(this,t)||this)._handles=new n,r._model=new S.Model,r._layers=new s,r._changeSet=new _.ChangeSet,r._layerSyncSet=new Set,r}t._inheritsLoose(r,e);var o=r.prototype;return o.initialize=function(){this._set("renderView",new f.RenderView(this)),this._frameTask=this.resourceController.scheduler.registerTask(v.TaskPriority.STAGE,this),this._handles.add(this._frameTask)},o.destroy=function(){g.GeometryRecord.pool.prune(0),this._handles.destroy(),this.dispose()},o.add=function(e){this._model.add(e),m.isWebGLLayer(e)&&(e.attachStage(this),this._addLayer(e)),this.renderView.setNeedsRender()},o.remove=function(e){i.isNone(e)||(this.renderView.setNeedsRender(),this._model.remove(e),m.isWebGLLayer(e)&&(this._removeLayer(e),e.detachStage()))},o.addMany=function(e){i.isSome(e)&&(this._model.addMany(e),this.renderView.setNeedsRender())},o.removeMany=function(e){i.isSome(e)&&(this._model.removeMany(e),this.renderView.setNeedsRender())},o.forEachOfType=function(e,t){this._model.forEachOfType(e,t)},o.handleEvent=function(e,t){this.destroyed||(this._model.dirtySet[e](t),this.renderView.setNeedsRender())},o.runTask=function(e){this._frameTask.processQueue(e),e.done||this._commit()},o._commit=function(){const e=this._model.dirtySet;w.DebugSettings.logDirtySet&&console.log("Dirty set: "+e.formatDebugInfo()),e.commit(this._changeSet),w.DebugSettings.logDirtySet&&(console.log("RGs add: "+this._changeSet.adds.map((e=>e.id))),console.log("RGs remove: "+this._changeSet.removes.map((e=>e.id)))),this._layerSyncSet.clear(),this.renderView.modify(this._changeSet),this.renderView.setNeedsRender()},o.schedule=function(e,t){return this._frameTask.schedule(e,t)},o.syncLayer=function(e){this._layerSyncSet.add(e),this.renderView.setNeedsRender()},o.processSyncLayers=function(){const e=this._model.dirtySet;this._layers.forAll((t=>{(this._layerSyncSet.has(t.id)||1===t.updatePolicy)&&(e.commitLayer(t.id,this._changeSet),this._layerSyncSet.delete(t.id))}));for(const t of this._layerSyncSet)e.commitLayer(t,this._changeSet);this._layerSyncSet.clear(),this.renderView.modify(this._changeSet)},o.getObject=function(e){return this._model.getObject(e)},o._addLayer=function(e){this._layers.some((t=>t===e))||this._layers.push(e)},o._removeLayer=function(e){this._commit(),null!=this._layers.removeUnordered(e)&&(this._model.dirtySet.getResidentRenderGeometries(e.id,this._changeSet.removes),this.renderView.modify(this._changeSet))},o.addRenderPlugin=function(e,t,r){const o=this.renderView.renderPlugins.add(e,t,r),n=()=>{p.isIntersectionHandler(t)&&this.sceneIntersectionHelper.addIntersectionHandler(t)};if(d.isPromise(o))return o.then(n);n()},o.removeRenderPlugin=function(e){p.isIntersectionHandler(e)&&this.sceneIntersectionHelper.removeIntersectionHandler(e),this.renderView.renderPlugins.remove(e)},t._createClass(r,[{key:"viewingMode",get:function(){return this.state.viewingMode}},{key:"updating",get:function(){return this._model.dirtySet.dirty||this.renderView.updating}},{key:"running",get:function(){return this._model.dirtySet.dirty}},{key:"layers",get:function(){return this._layers}},{key:"performanceInfo",get:function(){return{renderView:this.renderView.performanceInfo,model:this._model.getStats()}}},{key:"test",get:function(){const e=this;return{getCount:t=>e._model.test.content.filter((e=>e.type===t)).length,stopAnimations:t=>e._model.test.content.filter((e=>3===e.type)).forEach((e=>i.applySome(e.animation,(e=>e.stopAtTime(t))))),model:e._model}}}]),r}(u.AutoDisposableMixin(o)),e.Stage.DebugSettings={endFrameContentValidation:!1,logDirtySet:!1},r.__decorate([a.property({constructOnly:!0})],e.Stage.prototype,"resourceController",void 0),r.__decorate([a.property({constructOnly:!0})],e.Stage.prototype,"options",void 0),r.__decorate([a.property({constructOnly:!0})],e.Stage.prototype,"state",void 0),r.__decorate([a.property({constructOnly:!0})],e.Stage.prototype,"sceneIntersectionHelper",void 0),r.__decorate([a.property({readOnly:!0})],e.Stage.prototype,"viewingMode",null),r.__decorate([a.property({constructOnly:!0})],e.Stage.prototype,"container",void 0),r.__decorate([a.property({constructOnly:!0})],e.Stage.prototype,"renderSR",void 0),r.__decorate([a.property({constructOnly:!0})],e.Stage.prototype,"_handles",void 0),r.__decorate([a.property({readOnly:!0})],e.Stage.prototype,"updating",null),r.__decorate([a.property({constructOnly:!0})],e.Stage.prototype,"_model",void 0),r.__decorate([u.autoDispose(),a.property()],e.Stage.prototype,"renderView",void 0),e.Stage=w=r.__decorate([h.subclass("esri.views.3d.webgl-engine.Stage")],e.Stage),Object.defineProperty(e,"__esModule",{value:!0})}));
