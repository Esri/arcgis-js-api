/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/has","../../../core/maybe","../../../core/Logger","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass","../../../core/urlUtils","../../../core/uuid","../../../portal/support/resourceExtension","../../../core/PooledArray","../../../core/Accessor","../../../chunks/vec3f64","../../../chunks/vec3","../../../core/Handles","../../support/Scheduler","./lighting/Lightsources","./lib/GeometryRecord","./lib/AutoDisposable","./lib/WebGLLayer","./lib/ChangeSet","./parts/Model","./parts/RenderView"],(function(e,t,r,i,n,o,s,d,a,c,h,l,y,g,u,p,_,m,S,f,w,v,L,V,b){"use strict";var D;e.Stage=D=function(e){function r(t){var r;return(r=e.call(this,t)||this)._handles=new _,r._model=new V.Model,r._layers=new y,r._mainLightDirection=u.fromValues(0,1,0),r._changeSet=new L.ChangeSet,r._layerSyncSet=new Set,r}t._inheritsLoose(r,e);var i=r.prototype;return i.initialize=function(){this._set("renderView",new b.RenderView(this)),this.setLighting({lights:[new S.MainLight(u.fromValues(.7,.7,.7)),new S.AmbientLight(u.fromValues(.3,.3,.3))],groundLightingFactor:.5,globalFactor:.5}),this._handles.add(this.scheduler.registerTask(m.Task.STAGE,(()=>this._processDirty()),(()=>this._model.dirtySet.dirty)))},i.destroy=function(){f.GeometryRecord.pool.prune(0),this._handles.destroy(),this.dispose()},i.setLighting=function(e){p.set(this._mainLightDirection,0,0,0);for(const t of e.lights)if(t instanceof S.MainLight){p.negate(this._mainLightDirection,t.direction);break}this._lighting=e,this.renderView.setNeedsRender()},i.add=function(e){this._model.add(e),v.isWebGLLayer(e)&&(e.attachStage(this),this._addLayer(e)),this.renderView.setNeedsRender()},i.remove=function(e){n.isNone(e)||(this.renderView.setNeedsRender(),this._model.remove(e),v.isWebGLLayer(e)&&(this._removeLayer(e),e.detachStage()))},i.addMany=function(e){n.isSome(e)&&(this._model.addMany(e),this.renderView.setNeedsRender())},i.removeMany=function(e){n.isSome(e)&&(this._model.removeMany(e),this.renderView.setNeedsRender())},i.forEachOfType=function(e,t){this._model.forEachOfType(e,t)},i.handleEvent=function(e,t){this.destroyed||(this._model.dirtySet[e](t),this.renderView.setNeedsRender())},i._processDirty=function(){const e=this._model.dirtySet;D.DebugSettings.logDirtySet&&console.log("Dirty set: "+e.formatDebugInfo()),e.commit(this._changeSet),D.DebugSettings.logDirtySet&&(console.log("RGs add: "+this._changeSet.adds.map((e=>e.id))),console.log("RGs remove: "+this._changeSet.removes.map((e=>e.id)))),this._layerSyncSet.clear(),this.renderView.modify(this._changeSet),this.renderView.setNeedsRender()},i.processDirtyLayer=function(e){this._layerSyncSet.add(e),this.renderView.setNeedsRender()},i.commitDirtyLayers=function(){if(0===this._layerSyncSet.size)return;const e=this._model.dirtySet;for(const t of this._layerSyncSet)e.commitLayer(t,this._changeSet);this._layerSyncSet.clear(),this.renderView.modify(this._changeSet),this.renderView.setNeedsRender()},i.getObject=function(e){return this._model.getObject(e)},i._addLayer=function(e){this._layers.some((t=>t===e))||this._layers.push(e)},i._removeLayer=function(e){this._processDirty(),null!=this._layers.removeUnordered(e)&&(this._model.dirtySet.getResidentRenderGeometries(e.id,this._changeSet.removes),this.renderView.modify(this._changeSet))},i.addRenderPlugin=function(e,t){"intersect"in t&&this.sceneIntersectionHelper.addIntersectionHandler(t),this.renderView.renderPlugins.add(e,t)},i.removeRenderPlugin=function(e){"intersect"in e&&this.sceneIntersectionHelper.removeIntersectionHandler(e),this.renderView.renderPlugins.remove(e)},t._createClass(r,[{key:"updating",get:function(){return this._model.dirtySet.dirty||this.renderView.updating}},{key:"mainLightDirection",get:function(){return this._mainLightDirection}},{key:"lighting",get:function(){return this._lighting}},{key:"camera",get:function(){return this.renderView.camera},set:function(e){this.renderView.camera=e}},{key:"layers",get:function(){return this._layers}},{key:"performanceInfo",get:function(){return{renderView:this.renderView.performanceInfo,model:this._model.getStats()}}},{key:"test",get:function(){const e=this;return{getCount:t=>e._model.test.content.filter((e=>e.type===t)).length,stopAnimations:t=>e._model.test.content.filter((e=>3===e.type)).forEach((e=>n.applySome(e.animation,(e=>e.stopAtTime(t))))),model:e._model}}}]),r}(w.AutoDisposableMixin(g)),e.Stage.DebugSettings={endFrameContentValidation:!1,logDirtySet:!1},r.__decorate([d.property({constructOnly:!0})],e.Stage.prototype,"scheduler",void 0),r.__decorate([d.property({constructOnly:!0})],e.Stage.prototype,"options",void 0),r.__decorate([d.property({constructOnly:!0})],e.Stage.prototype,"sceneIntersectionHelper",void 0),r.__decorate([d.property({constructOnly:!0})],e.Stage.prototype,"viewingMode",void 0),r.__decorate([d.property({constructOnly:!0})],e.Stage.prototype,"container",void 0),r.__decorate([d.property({constructOnly:!0})],e.Stage.prototype,"_handles",void 0),r.__decorate([d.property({readOnly:!0})],e.Stage.prototype,"updating",null),r.__decorate([d.property({constructOnly:!0})],e.Stage.prototype,"_model",void 0),r.__decorate([w.autoDispose(),d.property()],e.Stage.prototype,"renderView",void 0),e.Stage=D=r.__decorate([a.subclass("esri.views.3d.webgl-engine.Stage")],e.Stage),Object.defineProperty(e,"__esModule",{value:!0})}));
