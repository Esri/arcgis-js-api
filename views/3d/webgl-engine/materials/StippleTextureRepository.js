/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{packFloatRGBA as e}from"../../../../core/floatRGBA.js";import{disposeMaybe as t,isNone as r,isSome as i}from"../../../../core/maybe.js";import{PixelFormat as o,PixelType as a,TextureWrapMode as n}from"../../../webgl/enums.js";import{Texture as s}from"../../../webgl/Texture.js";class c{constructor(e){this._rctx=e,this.cache=new Map}dispose(){this.cache.forEach((e=>e.texture=t(e.texture))),this.cache.clear()}_acquire(e){if(r(e))return null;const t=this._patternId(e),i=this.cache.get(t);if(i)return i.refCount++,i.bind;const c=e.pixelRatio,{encodedData:h,sdfNormalizer:l,pixels:p,paddedPixels:d}=u(e.pattern,c),f=p/c,x={refCount:1,texture:null,bind:e=>(r(x.texture)&&(x.texture=new s(this._rctx,{width:d,height:1,internalFormat:o.RGBA,pixelFormat:o.RGBA,dataType:a.UNSIGNED_BYTE,wrapMode:n.CLAMP_TO_EDGE},h)),e.bindTexture("stipplePatternTexture",x.texture),{pixelSize:f,sdfNormalizer:l,pixels:p})};return this.cache.set(t,x),x.bind}release(e){if(r(e))return;const t=this._patternId(e),o=this.cache.get(t);o&&(o.refCount--,0===o.refCount&&(i(o.texture)&&o.texture.dispose(),this.cache.delete(t)))}swap(e,t){const r=this._acquire(t);return this.release(e),r}_patternId(e){return`${e.pattern.join(",")}-r${e.pixelRatio}`}}function u(t,r){const i=t.map((e=>Math.round(e*r))),o=1/r,a=Math.floor(i.reduce(((e,t)=>e+t))),n=i.reduce(((e,t)=>Math.max(e,t))),s=(Math.floor(.5*(n-1))+.5)*o,c=[];let u=1;for(const e of i){for(let t=0;t<e;t++){const r=u*(Math.min(t,e-1-t)+.5)*o/s*.5+.5;c.push(r)}u=-u}const h=Math.round(i[0]/2),l=[...c.slice(h),...c.slice(0,h)],p=a+2,d=new Uint8Array(4*p);let f=4;for(const x of l)e(x,d,f),f+=4;return d.copyWithin(0,f-4,f),d.copyWithin(f,4,8),{encodedData:d,sdfNormalizer:s,paddedPixels:p,pixels:a}}export{c as StippleTextureRepository};
