/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/has","../../../../core/Logger","../../../../core/mathUtils","../../../../core/maybe","../../../../core/screenUtils","../../../../chunks/vec2","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../chunks/vec4f64","../../../../geometry/support/frustum","../../../../geometry/support/lineSegment","../../../../geometry/support/plane","../../support/buffer/InterleavedLayout","../core/shaderLibrary/ShaderOutput","../lib/GLMaterial","../lib/Material","../lib/RenderSlot","../lib/Util","../lib/VertexAttribute","./VisualVariablePassParameters","../shaders/LineMarkerTechniqueConfiguration","../../../../chunks/RibbonLine.glsl","../shaders/RibbonLineTechnique","../shaders/RibbonLineTechniqueConfiguration"],(function(e,t,r,i,a,n,s,o,c,u,l,h,p,d,f,A,T,m,_,b,S,E,R,g,O,v){"use strict";var I;!function(e){e[e.LEFT_JOIN_START=-2]="LEFT_JOIN_START",e[e.LEFT_JOIN_END=-1]="LEFT_JOIN_END",e[e.LEFT_CAP_START=-4]="LEFT_CAP_START",e[e.LEFT_CAP_END=-5]="LEFT_CAP_END",e[e.RIGHT_JOIN_START=2]="RIGHT_JOIN_START",e[e.RIGHT_JOIN_END=1]="RIGHT_JOIN_END",e[e.RIGHT_CAP_START=4]="RIGHT_CAP_START",e[e.RIGHT_CAP_END=5]="RIGHT_CAP_END"}(I||(I={}));let P=function(e){function s(t){var r;return(r=e.call(this,t,new y)||this)._configuration=new v.RibbonLineTechniqueConfiguration,r._vertexAttributeLocations=O.vertexAttributeLocations,r._layout=r.createLayout(),r}t._inheritsLoose(s,e);var u=s.prototype;return u.isClosed=function(e,t){return D(this.parameters,e,t)},u.getConfiguration=function(e,t){this._configuration.output=e,this._configuration.draped=t.slot===_.RenderSlot.DRAPED_MATERIAL;const r=n.isSome(this.parameters.stipplePattern)&&e!==A.ShaderOutput.Highlight;return this._configuration.stippleEnabled=r,this._configuration.stippleOffColorEnabled=r&&n.isSome(this.parameters.stippleOffColor),this._configuration.stippleScaleWithLineWidth=r&&this.parameters.stippleScaleWithLineWidth,this._configuration.stipplePreferContinuous=r&&this.parameters.stipplePreferContinuous,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.roundJoins="round"===this.parameters.join,this._configuration.capType=this.parameters.cap,this._configuration.applyMarkerOffset=!!n.isSome(this.parameters.markerParameters)&&V(this.parameters.markerParameters),this._configuration.hasPolygonOffset=this.parameters.hasPolygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.vvColor=this.parameters.vvColorEnabled,this._configuration.vvOpacity=this.parameters.vvOpacityEnabled,this._configuration.vvSize=this.parameters.vvSizeEnabled,this._configuration.innerColorEnabled=this.parameters.innerWidth>0&&n.isSome(this.parameters.innerColor),this._configuration.falloffEnabled=this.parameters.falloff>0,this._configuration.occluder=this.parameters.renderOccluded===m.RenderOccludedFlag.OccludeAndTransparentStencil,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.hasMultipassTerrain=t.multipassTerrain.enabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration.wireframe=this.parameters.wireframe,this._configuration},u.intersectDraped=function(e,t,r,i,n,s){if(!r.options.selectionMode)return;const o=e.vertexAttributes.get(S.VertexAttribute.POSITION).data,c=e.vertexAttributes.get(S.VertexAttribute.SIZE);let u=this.parameters.width;if(this.parameters.vvSizeEnabled){const t=e.vertexAttributes.get(S.VertexAttribute.SIZEFEATUREATTRIBUTE).data[0];u*=a.clamp(this.parameters.vvSizeOffset[0]+t*this.parameters.vvSizeFactor[0],this.parameters.vvSizeMinSize[0],this.parameters.vvSizeMaxSize[0])}else c&&(u*=c.data[0]);const l=i[0],h=i[1],p=(u/2+4)*e.screenToWorldRatio;let d=Number.MAX_VALUE,f=0;for(let A=0;A<o.length-5;A+=3){const e=o[A],t=o[A+1],r=l-e,i=h-t,n=o[A+3]-e,s=o[A+4]-t,c=n*r+s*i,u=n*n+s*s,p=a.clamp(c/u,0,1),T=n*p-r,m=s*p-i,_=T*T+m*m;_<d&&(d=_,f=A/3)}d<p*p&&n(s.dist,s.normal,f,!1)},u.intersect=function(e,t,r,n,s,u){if(!r.options.selectionMode||!e.visible)return;if(!b.isTranslationMatrix(t))return void i.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial").error("intersection assumes a translation-only matrix");const l=e.vertexAttributes,f=l.get(S.VertexAttribute.POSITION).data;let A=this.parameters.width;if(this.parameters.vvSizeEnabled){const e=l.get(S.VertexAttribute.SIZEFEATUREATTRIBUTE).data[0];A*=a.clamp(this.parameters.vvSizeOffset[0]+e*this.parameters.vvSizeFactor[0],this.parameters.vvSizeMinSize[0],this.parameters.vvSizeMaxSize[0])}else l.has(S.VertexAttribute.SIZE)&&(A*=l.get(S.VertexAttribute.SIZE).data[0]);const T=r.camera,m=B;o.copy(m,r.point);const _=A*T.pixelRatio/2+4*T.pixelRatio;c.set(X[0],m[0]-_,m[1]+_,0),c.set(X[1],m[0]+_,m[1]+_,0),c.set(X[2],m[0]+_,m[1]-_,0),c.set(X[3],m[0]-_,m[1]-_,0);for(let i=0;i<4;i++)if(!T.unprojectFromRenderScreen(X[i],Y[i]))return;d.fromPoints(T.eye,Y[0],Y[1],Q),d.fromPoints(T.eye,Y[1],Y[2],K),d.fromPoints(T.eye,Y[2],Y[3],$),d.fromPoints(T.eye,Y[3],Y[0],ee);let E=Number.MAX_VALUE,R=0;const g=C(this.parameters,l,e.indices)?f.length-2:f.length-5;for(let i=0;i<g;i+=3){M[0]=f[i]+t[12],M[1]=f[i+1]+t[13],M[2]=f[i+2]+t[14];const e=(i+3)%f.length;if(U[0]=f[e]+t[12],U[1]=f[e+1]+t[13],U[2]=f[e+2]+t[14],d.signedDistance(Q,M)<0&&d.signedDistance(Q,U)<0||d.signedDistance(K,M)<0&&d.signedDistance(K,U)<0||d.signedDistance($,M)<0&&d.signedDistance($,U)<0||d.signedDistance(ee,M)<0&&d.signedDistance(ee,U)<0)continue;if(T.projectToRenderScreen(M,J),T.projectToRenderScreen(U,z),J[2]<0&&z[2]>0){c.subtract(F,M,U);const e=T.frustum,t=-d.signedDistance(e[h.PlaneIndex.NEAR],M)/c.dot(F,d.normal(e[h.PlaneIndex.NEAR]));c.scale(F,F,t),c.add(M,M,F),T.projectToRenderScreen(M,J)}else if(J[2]>0&&z[2]<0){c.subtract(F,U,M);const e=T.frustum,t=-d.signedDistance(e[h.PlaneIndex.NEAR],U)/c.dot(F,d.normal(e[h.PlaneIndex.NEAR]));c.scale(F,F,t),c.add(U,U,F),T.projectToRenderScreen(U,z)}else if(J[2]<0&&z[2]<0)continue;J[2]=0,z[2]=0;const r=p.distance2(p.fromPoints(J,z,k),m);r<E&&(E=r,c.copy(G,M),c.copy(H,U),R=i/3)}const O=r.rayBegin,v=r.rayEnd;if(E<_*_){let e=Number.MAX_VALUE;if(p.closestLineSegmentPoint(p.fromPoints(G,H,k),p.fromPoints(O,v,j),w)){c.subtract(w,w,O);const t=c.length(w);c.scale(w,w,1/t),e=t/c.distance(O,v)}u(e,w,R,!1)}},u.createLayout=function(){const e=f.newLayout().vec3f(S.VertexAttribute.POSITION).f32(S.VertexAttribute.SUBDIVISIONFACTOR).vec2f(S.VertexAttribute.UV0).vec3f(S.VertexAttribute.AUXPOS1).vec3f(S.VertexAttribute.AUXPOS2);return this.parameters.vvSizeEnabled?e.f32(S.VertexAttribute.SIZEFEATUREATTRIBUTE):e.f32(S.VertexAttribute.SIZE),this.parameters.vvColorEnabled?e.f32(S.VertexAttribute.COLORFEATUREATTRIBUTE):e.vec4f(S.VertexAttribute.COLOR),this.parameters.vvOpacityEnabled&&e.f32(S.VertexAttribute.OPACITYFEATUREATTRIBUTE),r("enable-feature:objectAndLayerId-rendering")&&e.vec4u8(S.VertexAttribute.OBJECTANDLAYERIDCOLOR),e},u.createBufferWriter=function(){return new x(this._layout,this.parameters)},u.requiresSlot=function(e,t){if(t===A.ShaderOutput.Color||t===A.ShaderOutput.Alpha||t===A.ShaderOutput.Highlight||t===A.ShaderOutput.Depth||t===A.ShaderOutput.ObjectAndLayerIdColor){if(e===_.RenderSlot.DRAPED_MATERIAL)return!0;if(this.parameters.renderOccluded===m.RenderOccludedFlag.OccludeAndTransparentStencil)return e===_.RenderSlot.OPAQUE_MATERIAL||e===_.RenderSlot.OCCLUDER_MATERIAL||e===_.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL;if(t===A.ShaderOutput.Color||t===A.ShaderOutput.Alpha){return e===(this.parameters.writeDepth?_.RenderSlot.TRANSPARENT_MATERIAL:_.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL)}return e===_.RenderSlot.OPAQUE_MATERIAL}return!1},u.createGLMaterial=function(e){return new L(e)},u.validateParameters=function(e){"miter"!==e.join&&(e.miterLimit=0),n.isSome(e.markerParameters)&&(e.markerScale=e.markerParameters.width/e.width)},s}(m.Material),L=function(e){function r(){var t;return(t=e.apply(this,arguments)||this)._stipplePattern=null,t}t._inheritsLoose(r,e);var i=r.prototype;return i.dispose=function(){e.prototype.dispose.call(this),this._stippleTextureRepository.release(this._stipplePattern),this._stipplePattern=null},i._updateOccludeeState=function(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})},i.beginSlot=function(e){this._output!==A.ShaderOutput.Color&&this._output!==A.ShaderOutput.Alpha||this._updateOccludeeState(e);const t=this._material.parameters.stipplePattern;return this._stipplePattern!==t&&(this._material.setParameters(this._stippleTextureRepository.swap(this._stipplePattern,t)),this._stipplePattern=t),this.ensureTechnique(O.RibbonLineTechnique,e)},r}(T),y=function(e){function r(){var t;return(t=e.apply(this,arguments)||this).width=0,t.color=l.ONES,t.join="miter",t.cap=v.CapType.BUTT,t.miterLimit=5,t.writeDepth=!0,t.hasPolygonOffset=!1,t.stippleTexture=null,t.stippleScaleWithLineWidth=!1,t.stipplePreferContinuous=!0,t.markerParameters=null,t.markerScale=1,t.hasSlicePlane=!1,t.vvFastUpdate=!1,t.isClosed=!1,t.falloff=0,t.innerWidth=0,t.hasOccludees=!1,t.wireframe=!1,t}return t._inheritsLoose(r,e),r}(E.VisualVariablePassParameters),x=function(){function e(e,t){this._parameters=t,this.numJoinSubdivisions=0,this.vertexBufferLayout=e;const r=t.stipplePattern?1:0;switch(this._parameters.join){case"miter":case"bevel":this.numJoinSubdivisions=r;break;case"round":this.numJoinSubdivisions=g.RIBBONLINE_NUM_ROUND_JOIN_SUBDIVISIONS+r}}var t=e.prototype;return t._isClosed=function(e){return C(this._parameters,e.vertexAttributes,e.indices)},t.allocate=function(e){return this.vertexBufferLayout.createBuffer(e)},t.elementCount=function(e){const t=2,r=e.indices.get(S.VertexAttribute.POSITION).length/2+1,i=this._isClosed(e);let a=i?2:2*t;return a+=((i?r:r-1)-(i?0:1))*(2*this.numJoinSubdivisions+4),a+=2,this._parameters.wireframe&&(a=2+4*(a-2)),a},t.write=function(e,t,i,a,s){const o=W,u=Z,l=q,h=i.vertexAttributes.get(S.VertexAttribute.POSITION).data,p=i.indices&&i.indices.get(S.VertexAttribute.POSITION),d=i.vertexAttributes.get(S.VertexAttribute.DISTANCETOSTART)?.data;p&&p.length!==2*(h.length/3-1)&&console.warn("RibbonLineMaterial does not support indices");let f=1,A=0;this._parameters.vvSizeEnabled?A=i.vertexAttributes.get(S.VertexAttribute.SIZEFEATUREATTRIBUTE).data[0]:i.vertexAttributes.has(S.VertexAttribute.SIZE)&&(f=i.vertexAttributes.get(S.VertexAttribute.SIZE).data[0]);let T=[1,1,1,1],m=0;this._parameters.vvColorEnabled?m=i.vertexAttributes.get(S.VertexAttribute.COLORFEATUREATTRIBUTE).data[0]:i.vertexAttributes.has(S.VertexAttribute.COLOR)&&(T=i.vertexAttributes.get(S.VertexAttribute.COLOR).data);const _=r("enable-feature:objectAndLayerId-rendering")?i.objectAndLayerIdColor:null;let b=0;this._parameters.vvOpacityEnabled&&(b=i.vertexAttributes.get(S.VertexAttribute.OPACITYFEATUREATTRIBUTE).data[0]);const E=h.length/3,R=new Float32Array(a.buffer),g=r("enable-feature:objectAndLayerId-rendering")?new Uint8Array(a.buffer):null,O=this.vertexBufferLayout.stride/4;let v=s*O;const P=v;let L=0;const y=d?(e,t,r)=>L=d[r]:(e,t,r)=>L+=c.distance(e,t),x=r("enable-feature:objectAndLayerId-rendering"),C=(e,t,r,i,a,s,o)=>{if(R[v++]=t[0],R[v++]=t[1],R[v++]=t[2],R[v++]=i,R[v++]=o,R[v++]=a,R[v++]=e[0],R[v++]=e[1],R[v++]=e[2],R[v++]=r[0],R[v++]=r[1],R[v++]=r[2],this._parameters.vvSizeEnabled?R[v++]=A:R[v++]=f,this._parameters.vvColorEnabled)R[v++]=m;else{const e=Math.min(4*s,T.length-4);R[v++]=T[e],R[v++]=T[e+1],R[v++]=T[e+2],R[v++]=T[e+3]}this._parameters.vvOpacityEnabled&&(R[v++]=b),x&&(n.isSome(_)&&(g[4*v]=_[0],g[4*v+1]=_[1],g[4*v+2]=_[2],g[4*v+3]=_[3]),v++)};v+=O,c.set(u,h[0],h[1],h[2]),e&&c.transformMat4(u,u,e);const D=this._isClosed(i);if(D){const t=h.length-3;c.set(o,h[t],h[t+1],h[t+2]),e&&c.transformMat4(o,o,e)}else c.set(l,h[3],h[4],h[5]),e&&c.transformMat4(l,l,e),C(u,u,l,1,I.LEFT_CAP_START,0,0),C(u,u,l,1,I.RIGHT_CAP_START,0,0),c.copy(o,u),c.copy(u,l);const V=D?0:1,M=D?E:E-1;for(let r=V;r<M;r++){const t=(r+1)%E*3;c.set(l,h[t],h[t+1],h[t+2]),e&&c.transformMat4(l,l,e),y(o,u,r),C(o,u,l,0,I.LEFT_JOIN_END,r,L),C(o,u,l,0,I.RIGHT_JOIN_END,r,L);const i=this.numJoinSubdivisions;for(let e=0;e<i;++e){const t=(e+1)/(i+1);C(o,u,l,t,I.LEFT_JOIN_END,r,L),C(o,u,l,t,I.RIGHT_JOIN_END,r,L)}C(o,u,l,1,I.LEFT_JOIN_START,r,L),C(o,u,l,1,I.RIGHT_JOIN_START,r,L),c.copy(o,u),c.copy(u,l)}D?(c.set(l,h[3],h[4],h[5]),e&&c.transformMat4(l,l,e),L=y(o,u,M),C(o,u,l,0,I.LEFT_JOIN_END,V,L),C(o,u,l,0,I.RIGHT_JOIN_END,V,L)):(L=y(o,u,M),C(o,u,u,0,I.LEFT_CAP_END,M,L),C(o,u,u,0,I.RIGHT_CAP_END,M,L)),N(R,P+O,R,P,O);v=N(R,v-O,R,v,O),this._parameters.wireframe&&this._addWireframeVertices(a,P,v,O)},t._addWireframeVertices=function(e,t,r,i){const a=new Float32Array(e.buffer,r*Float32Array.BYTES_PER_ELEMENT),n=new Float32Array(e.buffer,t*Float32Array.BYTES_PER_ELEMENT,r-t);let s=0;const o=e=>s=N(n,e,a,s,i);for(let c=0;c<n.length-1;c+=2*i)o(c),o(c+2*i),o(c+1*i),o(c+2*i),o(c+1*i),o(c+3*i)},e}();function N(e,t,r,i,a){for(let n=0;n<a;n++)r[i++]=e[t++];return i}function C(e,t,r){return D(e,t.get(S.VertexAttribute.POSITION).data,r?r.get(S.VertexAttribute.POSITION):null)}function D(e,t,r){return!!e.isClosed&&(r?r.length>2:t.length>6)}function V(e){return e.anchor===R.LineMarkerAnchor.Tip&&e.hideOnShortSegments&&"begin-end"===e.placement&&e.worldSpace}const M=u.create(),U=u.create(),F=u.create(),w=u.create(),B=u.create(),J=s.createRenderScreenPointArray3(),z=s.createRenderScreenPointArray3(),G=u.create(),H=u.create(),k=p.create(),j=p.create(),W=u.create(),Z=u.create(),q=u.create(),X=[s.createRenderScreenPointArray3(),s.createRenderScreenPointArray3(),s.createRenderScreenPointArray3(),s.createRenderScreenPointArray3()],Y=[u.create(),u.create(),u.create(),u.create()],Q=d.create(),K=d.create(),$=d.create(),ee=d.create();e.Parameters=y,e.RibbonLineMaterial=P,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
