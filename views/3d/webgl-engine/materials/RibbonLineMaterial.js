/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/has","../../../../core/Logger","../../../../core/mathUtils","../../../../core/maybe","../../../../core/screenUtils","../../../../chunks/vec2","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../chunks/vec4f64","../../../../geometry/support/frustum","../../../../geometry/support/lineSegment","../../../../geometry/support/plane","../../support/buffer/InterleavedLayout","../core/shaderLibrary/ShaderOutput","../lib/geometryDataUtils","../lib/GLMaterial","../lib/Material","../lib/RenderSlot","../lib/Util","../lib/VertexAttribute","./VisualVariablePassParameters","./renderers/utils","../shaders/LineMarkerTechniqueConfiguration","../../../../chunks/RibbonLine.glsl","../shaders/RibbonLineTechnique","../shaders/RibbonLineTechniqueConfiguration"],(function(e,t,r,i,n,a,s,o,c,u,l,h,p,d,f,A,m,T,_,b,S,E,R,g,O,v,I,P){"use strict";var L;!function(e){e[e.LEFT_JOIN_START=-2]="LEFT_JOIN_START",e[e.LEFT_JOIN_END=-1]="LEFT_JOIN_END",e[e.LEFT_CAP_START=-4]="LEFT_CAP_START",e[e.LEFT_CAP_END=-5]="LEFT_CAP_END",e[e.RIGHT_JOIN_START=2]="RIGHT_JOIN_START",e[e.RIGHT_JOIN_END=1]="RIGHT_JOIN_END",e[e.RIGHT_CAP_START=4]="RIGHT_CAP_START",e[e.RIGHT_CAP_END=5]="RIGHT_CAP_END"}(L||(L={}));let y=function(e){function s(t){var r;return(r=e.call(this,t,new N)||this)._configuration=new P.RibbonLineTechniqueConfiguration,r._vertexAttributeLocations=I.vertexAttributeLocations,r._layout=r.createLayout(),r}t._inheritsLoose(s,e);var u=s.prototype;return u.isClosed=function(e,t){return M(this.parameters,e,t)},u.getConfiguration=function(e,t){this._configuration.output=e,this._configuration.draped=t.slot===b.RenderSlot.DRAPED_MATERIAL;const r=a.isSome(this.parameters.stipplePattern)&&e!==A.ShaderOutput.Highlight;return this._configuration.stippleEnabled=r,this._configuration.stippleOffColorEnabled=r&&a.isSome(this.parameters.stippleOffColor),this._configuration.stippleScaleWithLineWidth=r&&this.parameters.stippleScaleWithLineWidth,this._configuration.stipplePreferContinuous=r&&this.parameters.stipplePreferContinuous,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.roundJoins="round"===this.parameters.join,this._configuration.capType=this.parameters.cap,this._configuration.applyMarkerOffset=!!a.isSome(this.parameters.markerParameters)&&U(this.parameters.markerParameters),this._configuration.hasPolygonOffset=this.parameters.hasPolygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.vvColor=this.parameters.vvColorEnabled,this._configuration.vvOpacity=this.parameters.vvOpacityEnabled,this._configuration.vvSize=this.parameters.vvSizeEnabled,this._configuration.innerColorEnabled=this.parameters.innerWidth>0&&a.isSome(this.parameters.innerColor),this._configuration.falloffEnabled=this.parameters.falloff>0,this._configuration.occluder=this.parameters.renderOccluded===_.RenderOccludedFlag.OccludeAndTransparentStencil,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.hasMultipassTerrain=t.multipassTerrain.enabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration.wireframe=this.parameters.wireframe,this._configuration},u.intersect=function(e,t,r,i,n,s,o,c,u){a.isSome(u)?this._intersectDrapedLineGeometry(e,i,u,s,o):this._intersectLineGeometry(e,t,r,i,o)},u._intersectDrapedLineGeometry=function(e,t,r,i,a){if(!t.options.selectionMode)return;const s=e.vertexAttributes.get(E.VertexAttribute.POSITION).data,o=e.vertexAttributes.get(E.VertexAttribute.SIZE);let c=this.parameters.width;if(this.parameters.vvSizeEnabled){const t=e.vertexAttributes.get(E.VertexAttribute.SIZEFEATUREATTRIBUTE).data[0];c*=n.clamp(this.parameters.vvSizeOffset[0]+t*this.parameters.vvSizeFactor[0],this.parameters.vvSizeMinSize[0],this.parameters.vvSizeMaxSize[0])}else o&&(c*=o.data[0]);const u=i[0],l=i[1],h=(c/2+4)*e.screenToWorldRatio;let p=Number.MAX_VALUE,d=0;for(let f=0;f<s.length-5;f+=3){const e=s[f],t=s[f+1],r=u-e,i=l-t,a=s[f+3]-e,o=s[f+4]-t,c=a*r+o*i,h=a*a+o*o,A=n.clamp(c/h,0,1),m=a*A-r,T=o*A-i,_=m*m+T*T;_<p&&(p=_,d=f/3)}p<h*h&&a(r.dist,r.normal,d,!1)},u._intersectLineGeometry=function(e,t,r,a,s){if(!a.options.selectionMode||g.isInstanceHidden(t))return;if(!S.isTranslationMatrix(r))return void i.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial").error("intersection assumes a translation-only matrix");const u=e.vertexAttributes,l=u.get(E.VertexAttribute.POSITION).data;let f=this.parameters.width;if(this.parameters.vvSizeEnabled){const e=u.get(E.VertexAttribute.SIZEFEATUREATTRIBUTE).data[0];f*=n.clamp(this.parameters.vvSizeOffset[0]+e*this.parameters.vvSizeFactor[0],this.parameters.vvSizeMinSize[0],this.parameters.vvSizeMaxSize[0])}else u.has(E.VertexAttribute.SIZE)&&(f*=u.get(E.VertexAttribute.SIZE).data[0]);const A=a.camera,m=G;o.copy(m,a.point);const T=f*A.pixelRatio/2+4*A.pixelRatio;c.set(Q[0],m[0]-T,m[1]+T,0),c.set(Q[1],m[0]+T,m[1]+T,0),c.set(Q[2],m[0]+T,m[1]-T,0),c.set(Q[3],m[0]-T,m[1]-T,0);for(let i=0;i<4;i++)if(!A.unprojectFromRenderScreen(Q[i],K[i]))return;d.fromPoints(A.eye,K[0],K[1],$),d.fromPoints(A.eye,K[1],K[2],ee),d.fromPoints(A.eye,K[2],K[3],te),d.fromPoints(A.eye,K[3],K[0],re);let _=Number.MAX_VALUE,b=0;const R=V(this.parameters,u,e.indices)?l.length-2:l.length-5;for(let i=0;i<R;i+=3){F[0]=l[i]+r[12],F[1]=l[i+1]+r[13],F[2]=l[i+2]+r[14];const e=(i+3)%l.length;if(w[0]=l[e]+r[12],w[1]=l[e+1]+r[13],w[2]=l[e+2]+r[14],d.signedDistance($,F)<0&&d.signedDistance($,w)<0||d.signedDistance(ee,F)<0&&d.signedDistance(ee,w)<0||d.signedDistance(te,F)<0&&d.signedDistance(te,w)<0||d.signedDistance(re,F)<0&&d.signedDistance(re,w)<0)continue;if(A.projectToRenderScreen(F,z),A.projectToRenderScreen(w,H),z[2]<0&&H[2]>0){c.subtract(J,F,w);const e=A.frustum,t=-d.signedDistance(e[h.PlaneIndex.NEAR],F)/c.dot(J,d.normal(e[h.PlaneIndex.NEAR]));c.scale(J,J,t),c.add(F,F,J),A.projectToRenderScreen(F,z)}else if(z[2]>0&&H[2]<0){c.subtract(J,w,F);const e=A.frustum,t=-d.signedDistance(e[h.PlaneIndex.NEAR],w)/c.dot(J,d.normal(e[h.PlaneIndex.NEAR]));c.scale(J,J,t),c.add(w,w,J),A.projectToRenderScreen(w,H)}else if(z[2]<0&&H[2]<0)continue;z[2]=0,H[2]=0;const t=p.distance2(p.fromPoints(z,H,W),m);t<_&&(_=t,c.copy(k,F),c.copy(j,w),b=i/3)}const O=a.rayBegin,v=a.rayEnd;if(_<T*T){let e=Number.MAX_VALUE;if(p.closestLineSegmentPoint(p.fromPoints(k,j,W),p.fromPoints(O,v,Z),B)){c.subtract(B,B,O);const t=c.length(B);c.scale(B,B,1/t),e=t/c.distance(O,v)}s(e,B,b,!1)}},u.computeAttachmentOrigin=function(e,t){const r=e.vertexAttributes;if(!r)return!1;const i=e.indices,n=r.get(E.VertexAttribute.POSITION);return m.computeAttachmentOriginLines(n,i?i.get(E.VertexAttribute.POSITION):null,i&&V(this.parameters,r,i),t)},u.createLayout=function(){const e=f.newLayout().vec3f(E.VertexAttribute.POSITION).f32(E.VertexAttribute.SUBDIVISIONFACTOR).vec2f(E.VertexAttribute.UV0).vec3f(E.VertexAttribute.AUXPOS1).vec3f(E.VertexAttribute.AUXPOS2);return this.parameters.vvSizeEnabled?e.f32(E.VertexAttribute.SIZEFEATUREATTRIBUTE):e.f32(E.VertexAttribute.SIZE),this.parameters.vvColorEnabled?e.f32(E.VertexAttribute.COLORFEATUREATTRIBUTE):e.vec4f(E.VertexAttribute.COLOR),this.parameters.vvOpacityEnabled&&e.f32(E.VertexAttribute.OPACITYFEATUREATTRIBUTE),r("enable-feature:objectAndLayerId-rendering")&&e.vec4u8(E.VertexAttribute.OBJECTANDLAYERIDCOLOR),e},u.createBufferWriter=function(){return new C(this._layout,this.parameters)},u.requiresSlot=function(e,t){if(t===A.ShaderOutput.Color||t===A.ShaderOutput.Alpha||t===A.ShaderOutput.Highlight||t===A.ShaderOutput.Depth||t===A.ShaderOutput.ObjectAndLayerIdColor){if(e===b.RenderSlot.DRAPED_MATERIAL)return!0;if(this.parameters.renderOccluded===_.RenderOccludedFlag.OccludeAndTransparentStencil)return e===b.RenderSlot.OPAQUE_MATERIAL||e===b.RenderSlot.OCCLUDER_MATERIAL||e===b.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL;if(t===A.ShaderOutput.Color||t===A.ShaderOutput.Alpha){return e===(this.parameters.writeDepth?b.RenderSlot.TRANSPARENT_MATERIAL:b.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL)}return e===b.RenderSlot.OPAQUE_MATERIAL}return!1},u.createGLMaterial=function(e){return new x(e)},u.validateParameters=function(e){"miter"!==e.join&&(e.miterLimit=0),a.isSome(e.markerParameters)&&(e.markerScale=e.markerParameters.width/e.width)},s}(_.Material),x=function(e){function r(){var t;return(t=e.apply(this,arguments)||this)._stipplePattern=null,t}t._inheritsLoose(r,e);var i=r.prototype;return i.dispose=function(){e.prototype.dispose.call(this),this._stippleTextureRepository.release(this._stipplePattern),this._stipplePattern=null},i._updateOccludeeState=function(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})},i.beginSlot=function(e){this._output!==A.ShaderOutput.Color&&this._output!==A.ShaderOutput.Alpha||this._updateOccludeeState(e);const t=this._material.parameters.stipplePattern;return this._stipplePattern!==t&&(this._material.setParameters(this._stippleTextureRepository.swap(this._stipplePattern,t)),this._stipplePattern=t),this.ensureTechnique(I.RibbonLineTechnique,e)},r}(T),N=function(e){function r(){var t;return(t=e.apply(this,arguments)||this).width=0,t.color=l.ONES,t.join="miter",t.cap=P.CapType.BUTT,t.miterLimit=5,t.writeDepth=!0,t.hasPolygonOffset=!1,t.stippleTexture=null,t.stippleScaleWithLineWidth=!1,t.stipplePreferContinuous=!0,t.markerParameters=null,t.markerScale=1,t.hasSlicePlane=!1,t.vvFastUpdate=!1,t.isClosed=!1,t.falloff=0,t.innerWidth=0,t.hasOccludees=!1,t.wireframe=!1,t}return t._inheritsLoose(r,e),r}(R.VisualVariablePassParameters),C=function(){function e(e,t){this._parameters=t,this.numJoinSubdivisions=0,this.vertexBufferLayout=e;const r=t.stipplePattern?1:0;switch(this._parameters.join){case"miter":case"bevel":this.numJoinSubdivisions=r;break;case"round":this.numJoinSubdivisions=v.NUM_ROUND_JOIN_SUBDIVISIONS+r}}var t=e.prototype;return t._isClosed=function(e){return V(this._parameters,e.vertexAttributes,e.indices)},t.allocate=function(e){return this.vertexBufferLayout.createBuffer(e)},t.elementCount=function(e){const t=2,r=e.indices.get(E.VertexAttribute.POSITION).length/2+1,i=this._isClosed(e);let n=i?2:2*t;return n+=((i?r:r-1)-(i?0:1))*(2*this.numJoinSubdivisions+4),n+=2,this._parameters.wireframe&&(n=2+4*(n-2)),n},t.write=function(e,t,i,n,s){const o=q,u=X,l=Y,h=i.vertexAttributes.get(E.VertexAttribute.POSITION).data,p=i.indices&&i.indices.get(E.VertexAttribute.POSITION),d=i.vertexAttributes.get(E.VertexAttribute.DISTANCETOSTART)?.data;p&&p.length!==2*(h.length/3-1)&&console.warn("RibbonLineMaterial does not support indices");let f=1,A=0;this._parameters.vvSizeEnabled?A=i.vertexAttributes.get(E.VertexAttribute.SIZEFEATUREATTRIBUTE).data[0]:i.vertexAttributes.has(E.VertexAttribute.SIZE)&&(f=i.vertexAttributes.get(E.VertexAttribute.SIZE).data[0]);let m=[1,1,1,1],T=0;this._parameters.vvColorEnabled?T=i.vertexAttributes.get(E.VertexAttribute.COLORFEATUREATTRIBUTE).data[0]:i.vertexAttributes.has(E.VertexAttribute.COLOR)&&(m=i.vertexAttributes.get(E.VertexAttribute.COLOR).data);let _=null;r("enable-feature:objectAndLayerId-rendering")&&(_=i.objectAndLayerIdColor);let b=0;this._parameters.vvOpacityEnabled&&(b=i.vertexAttributes.get(E.VertexAttribute.OPACITYFEATUREATTRIBUTE).data[0]);const S=h.length/3,R=new Float32Array(n.buffer),g=r("enable-feature:objectAndLayerId-rendering")?new Uint8Array(n.buffer):null,O=this.vertexBufferLayout.stride/4;let v=s*O;const I=v;let P=0;const y=d?(e,t,r)=>P=d[r]:(e,t,r)=>P+=c.distance(e,t),x=(e,t,i,n,s,o,c)=>{if(R[v++]=t[0],R[v++]=t[1],R[v++]=t[2],R[v++]=n,R[v++]=c,R[v++]=s,R[v++]=e[0],R[v++]=e[1],R[v++]=e[2],R[v++]=i[0],R[v++]=i[1],R[v++]=i[2],this._parameters.vvSizeEnabled?R[v++]=A:R[v++]=f,this._parameters.vvColorEnabled)R[v++]=T;else{const e=Math.min(4*o,m.length-4);R[v++]=m[e+0],R[v++]=m[e+1],R[v++]=m[e+2],R[v++]=m[e+3]}this._parameters.vvOpacityEnabled&&(R[v++]=b),r("enable-feature:objectAndLayerId-rendering")&&(a.isSome(_)&&(g[4*v+0]=_[0],g[4*v+1]=_[1],g[4*v+2]=_[2],g[4*v+3]=_[3]),v++)};v+=O,c.set(u,h[0],h[1],h[2]),e&&c.transformMat4(u,u,e);const N=this._isClosed(i);if(N){const t=h.length-3;c.set(o,h[t],h[t+1],h[t+2]),e&&c.transformMat4(o,o,e)}else c.set(l,h[3],h[4],h[5]),e&&c.transformMat4(l,l,e),x(u,u,l,1,L.LEFT_CAP_START,0,0),x(u,u,l,1,L.RIGHT_CAP_START,0,0),c.copy(o,u),c.copy(u,l);const C=N?0:1,V=N?S:S-1;for(let r=C;r<V;r++){const t=(r+1)%S*3;c.set(l,h[t+0],h[t+1],h[t+2]),e&&c.transformMat4(l,l,e),y(o,u,r),x(o,u,l,0,L.LEFT_JOIN_END,r,P),x(o,u,l,0,L.RIGHT_JOIN_END,r,P);const i=this.numJoinSubdivisions;for(let e=0;e<i;++e){const t=(e+1)/(i+1);x(o,u,l,t,L.LEFT_JOIN_END,r,P),x(o,u,l,t,L.RIGHT_JOIN_END,r,P)}x(o,u,l,1,L.LEFT_JOIN_START,r,P),x(o,u,l,1,L.RIGHT_JOIN_START,r,P),c.copy(o,u),c.copy(u,l)}N?(c.set(l,h[3],h[4],h[5]),e&&c.transformMat4(l,l,e),P=y(o,u,V),x(o,u,l,0,L.LEFT_JOIN_END,C,P),x(o,u,l,0,L.RIGHT_JOIN_END,C,P)):(P=y(o,u,V),x(o,u,u,0,L.LEFT_CAP_END,V,P),x(o,u,u,0,L.RIGHT_CAP_END,V,P)),D(R,I+O,R,I,O);v=D(R,v-O,R,v,O),this._parameters.wireframe&&this._addWireframeVertices(n,I,v,O)},t._addWireframeVertices=function(e,t,r,i){const n=new Float32Array(e.buffer,r*Float32Array.BYTES_PER_ELEMENT),a=new Float32Array(e.buffer,t*Float32Array.BYTES_PER_ELEMENT,r-t);let s=0;const o=e=>s=D(a,e,n,s,i);for(let c=0;c<a.length-1;c+=2*i)o(c),o(c+2*i),o(c+1*i),o(c+2*i),o(c+1*i),o(c+3*i)},e}();function D(e,t,r,i,n){for(let a=0;a<n;a++)r[i++]=e[t++];return i}function V(e,t,r){return M(e,t.get(E.VertexAttribute.POSITION).data,r?r.get(E.VertexAttribute.POSITION):null)}function M(e,t,r){return!!e.isClosed&&(r?r.length>2:t.length>6)}function U(e){return e.anchor===O.LineMarkerAnchor.Tip&&e.hideOnShortSegments&&"begin-end"===e.placement&&e.worldSpace}const F=u.create(),w=u.create(),J=u.create(),B=u.create(),G=u.create(),z=s.createRenderScreenPointArray3(),H=s.createRenderScreenPointArray3(),k=u.create(),j=u.create(),W=p.create(),Z=p.create(),q=u.create(),X=u.create(),Y=u.create(),Q=[s.createRenderScreenPointArray3(),s.createRenderScreenPointArray3(),s.createRenderScreenPointArray3(),s.createRenderScreenPointArray3()],K=[u.create(),u.create(),u.create(),u.create()],$=d.create(),ee=d.create(),te=d.create(),re=d.create();e.Parameters=N,e.RibbonLineMaterial=y,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
