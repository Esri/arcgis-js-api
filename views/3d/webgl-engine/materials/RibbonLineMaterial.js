// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../core/Logger","../../../../core/mathUtils","../../../../core/maybe","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/vec2","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../support/geometryUtils","../../support/buffer/InterleavedLayout","../lib/geometryDataUtils","../lib/GLMaterial","../lib/Material","../lib/Util","./VisualVariableMaterialParameters","./internal/MaterialUtil","./renderers/utils","../shaders/RibbonLineTechnique","../shaders/RibbonLineTechnique"],(function(e,t,i,n,r,a,s,o,c,u,p,l,h,b,v,f,d,m,g,A,C){"use strict";var S=n.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial"),R=function(e){function t(t,i){var n=e.call(this,i)||this;return n._vertexAttributeLocations=C.ribbonVertexAttributeLocations,n.techniqueConfig=new C.RibbonLineTechniqueConfiguration,n.params=m.copyParameters(t,x),n.validateParams(),n.params.transparent=n.params.color[3]<1||n.params.transparent,n.layout=n.createLayout(),n}return i.__extends(t,e),t.prototype.isClosed=function(e,t){return I(this.params,e,t)},t.prototype.dispose=function(){},t.prototype.setParameterValues=function(e){for(var t in e)if("cap"!==t){if("join"===t)if("round"===this.params[t]!==("round"===e[t])){S.error("join cannot be changed after creation");continue}if("stipplePattern"===t)if(!!this.params[t]!==!!e[t]){S.error("stippledness cannot be changed after creation");continue}this.params[t]=e[t]}else S.error("cap cannot be changed after creation");this.validateParams(),this.parametersChanged()},t.prototype.getParameters=function(){return this.params},t.prototype.getPassParameters=function(){return this.params},t.prototype.getTechniqueConfig=function(e){this.techniqueConfig.output=e;var t=a.isSome(this.params.stipplePattern);return this.techniqueConfig.stippleEnabled=t,this.techniqueConfig.stippleIntegerRepeatsEnabled=t&&this.params.stippleIntegerRepeats,this.techniqueConfig.stippleOffColorEnabled=t&&a.isSome(this.params.stippleOffColor),this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.sceneHasOcludees=this.params.sceneHasOcludees,this.techniqueConfig.roundJoins="round"===this.params.join,this.techniqueConfig.roundCaps="round"===this.params.cap,this.techniqueConfig.transparent=this.params.transparent,this.techniqueConfig.polygonOffset=this.params.polygonOffset,this.techniqueConfig.writeDepth=this.params.writeDepth,this.techniqueConfig.vvColor=this.params.vvColorEnabled,this.techniqueConfig.vvOpacity=this.params.vvOpacityEnabled,this.techniqueConfig.vvSize=this.params.vvSizeEnabled,this.techniqueConfig.innerColorEnabled=this.params.innerWidth>0&&a.isSome(this.params.innerColor),this.techniqueConfig.falloffEnabled=this.params.falloff>0,this.techniqueConfig.occluder=8===this.renderOccluded,this.techniqueConfig},t.prototype.intersect=function(e,t,i,n,r,a,s,o,c){c?this.intersectDrapedLineGeometry(e,n,a,s):this.intersectLineGeometry(e,t,i,n,this.params.width,s)},t.prototype.intersectDrapedLineGeometry=function(e,t,i,n){if(t.options.selectionMode){var a=e.getAttribute(C.RibbonVertexAttributeConstants.POSITION).data,s=e.getAttribute(C.RibbonVertexAttributeConstants.SIZE),o=this.params.width;if(this.params.vvSizeEnabled){var c=e.getAttribute(C.RibbonVertexAttributeConstants.SIZEFEATUREATTRIBUTE).data[0];o*=r.clamp(this.params.vvSizeOffset[0]+c*this.params.vvSizeFactor[0],this.params.vvSizeMinSize[0],this.params.vvSizeMaxSize[0])}else s&&(o*=s.data[0]);for(var u=i[0],p=i[1],l=(o/2+4)*e.screenToWorldRatio,h=Number.MAX_VALUE,b=0;b<a.length-5;b+=3){var v=a[b],f=a[b+1],d=u-v,m=p-f,g=a[b+3]-v,A=a[b+4]-f,S=g*d+A*m,R=g*g+A*A,y=r.clamp(S/R,0,1),x=g*y-d,P=A*y-m,O=x*x+P*P;O<h&&(h=O)}h<l*l&&n()}},t.prototype.intersectLineGeometry=function(e,t,i,n,a,s){if(n.options.selectionMode&&!g.isInstanceHidden(t))if(f.isTranslationMatrix(i)){var u=e.data,l=u.getVertexAttr(),h=l[C.RibbonVertexAttributeConstants.POSITION].data,b=a;if(this.params.vvSizeEnabled){var v=l[C.RibbonVertexAttributeConstants.SIZEFEATUREATTRIBUTE].data[0];b*=r.clamp(this.params.vvSizeOffset[0]+v*this.params.vvSizeFactor[0],this.params.vvSizeMinSize[0],this.params.vvSizeMaxSize[0])}else l[C.RibbonVertexAttributeConstants.SIZE]&&(b*=l[C.RibbonVertexAttributeConstants.SIZE].data[0]);var d=n.camera,m=D;o.vec2.copy(m,n.point);var A=b*d.pixelRatio/2+4*d.pixelRatio;c.vec3.set(H[0],m[0]-A,m[1]+A,0),c.vec3.set(H[1],m[0]+A,m[1]+A,0),c.vec3.set(H[2],m[0]+A,m[1]-A,0),c.vec3.set(H[3],m[0]-A,m[1]-A,0);for(var R=0;R<4;R++)d.unprojectPoint(H[R],J[R]);p.plane.fromPoints(d.eye,J[0],J[1],W),p.plane.fromPoints(d.eye,J[1],J[2],X),p.plane.fromPoints(d.eye,J[2],J[3],k),p.plane.fromPoints(d.eye,J[3],J[0],Y);var y=Number.MAX_VALUE,x=E(this.params,l,u.indices)?h.length-2:h.length-5;for(R=0;R<x;R+=3){q[0]=h[R]+i[12],q[1]=h[R+1]+i[13],q[2]=h[R+2]+i[14];var P=(R+3)%h.length;if(L[0]=h[P]+i[12],L[1]=h[P+1]+i[13],L[2]=h[P+2]+i[14],!(p.plane.signedDistance(W,q)<0&&p.plane.signedDistance(W,L)<0||p.plane.signedDistance(X,q)<0&&p.plane.signedDistance(X,L)<0||p.plane.signedDistance(k,q)<0&&p.plane.signedDistance(k,L)<0||p.plane.signedDistance(Y,q)<0&&p.plane.signedDistance(Y,L)<0)){if(d.projectPoint(q,z),d.projectPoint(L,B),z[2]<0&&B[2]>0){c.vec3.subtract(U,q,L);var O=d.frustum,I=-p.plane.signedDistance(O.planes[4],q)/c.vec3.dot(U,p.plane.normal(O.planes[4]));c.vec3.scale(U,U,I),c.vec3.add(q,q,U),d.projectPoint(q,z)}else if(z[2]>0&&B[2]<0){c.vec3.subtract(U,L,q);O=d.frustum,I=-p.plane.signedDistance(O.planes[4],L)/c.vec3.dot(U,p.plane.normal(O.planes[4]));c.vec3.scale(U,U,I),c.vec3.add(L,L,U),d.projectPoint(L,B)}else if(z[2]<0&&B[2]<0)continue;z[2]=0,B[2]=0;var T=p.lineSegment.distance2(p.lineSegment.fromPoints(z,B,F),m);T<y&&(y=T,c.vec3.copy(w,q),c.vec3.copy(N,L))}}var V=n.rayBeginPoint,j=n.rayEndPoint;if(y<A*A){var Z=Number.MAX_VALUE;if(p.lineSegment.closestLineSegmentPoint(p.lineSegment.fromPoints(w,N,F),p.lineSegment.fromPoints(V,j,_),M)){c.vec3.subtract(M,M,V);var G=c.vec3.length(M);c.vec3.scale(M,M,1/G),Z=G/c.vec3.distance(V,j)}s(Z,M)}}else S.error("intersection assumes a translation-only matrix")},t.prototype.computeAttachmentOrigin=function(e,t){var i=e.data,n="getVertexAttr"in i?i.getVertexAttr():"vertexAttr"in i?i.vertexAttr:null;if(!n)return null;var r=C.RibbonVertexAttributeConstants.POSITION,a="getVertexAttr"in i?i.indices:null,s=n[r];return h.computeAttachmentOriginLines(s,a?a[r]:null,a&&E(this.params,n,a),t)},t.prototype.createLayout=function(){var e=l.newLayout().vec3f(C.RibbonVertexAttributeConstants.POSITION).f32(C.RibbonVertexAttributeConstants.SUBDIVISIONFACTOR).vec2f(C.RibbonVertexAttributeConstants.UV0).vec3f(C.RibbonVertexAttributeConstants.AUXPOS1).vec3f(C.RibbonVertexAttributeConstants.AUXPOS2);return this.params.vvSizeEnabled?e.f32(C.RibbonVertexAttributeConstants.SIZEFEATUREATTRIBUTE):e.f32(C.RibbonVertexAttributeConstants.SIZE),this.params.vvColorEnabled?e.f32(C.RibbonVertexAttributeConstants.COLORFEATUREATTRIBUTE):e.vec4f(C.RibbonVertexAttributeConstants.COLOR),this.params.vvOpacityEnabled&&e.f32(C.RibbonVertexAttributeConstants.OPACITYFEATUREATTRIBUTE),e},t.prototype.createBufferWriter=function(){return new P(this.layout,this.params)},t.prototype.getGLMaterial=function(e){return 0===e.output||4===e.output?new y(e):void 0},t.prototype.validateParams=function(){"miter"!==this.params.join&&(this.params.miterLimit=0)},t}(v.Material),y=function(e){function t(t){var i=e.call(this,t)||this;return i.updateParameters(),i}return i.__extends(t,e),t.prototype.updateParameters=function(){this.technique=this.techniqueRep.acquireAndReleaseExisting(A.RibbonLineTechnique,this.material.getTechniqueConfig(this.output),this.technique)},t.prototype.beginSlot=function(e){return this.technique.configuration.occluder?3===e||10===e||11===e:0===this.output?(this.targetSlot=this.technique.configuration.writeDepth?5:8,e===this.targetSlot):3===e},t.prototype._updateOccludeeState=function(e){e.hasOccludees!==this.material.getParameters().sceneHasOcludees&&(this.material.setParameterValues({sceneHasOcludees:e.hasOccludees}),this.updateParameters())},t.prototype.ensureParameters=function(e){0===this.output&&this._updateOccludeeState(e)},t.prototype.bind=function(e,t){e.bindProgram(this.technique.program),this.technique.bindPass(e,this.material.getPassParameters(),t)},t.prototype.getPipelineState=function(e,t){return t?this.technique.occludeePipeline:this.technique.configuration.occluder?11===e?this.technique.occluderPipelineTransparent:10===e?this.technique.occluderPipelineOpaque:this.technique.occluderPipelineMaskWrite:this.technique.pipeline},t}(b.GLMaterial),x=i.__assign({width:0,color:[1,1,1,1],join:"miter",cap:"butt",miterLimit:5,writeDepth:!0,polygonOffset:!1,stipplePattern:null,stippleIntegerRepeats:!1,stippleOffColor:null,slicePlaneEnabled:!1,vvFastUpdate:!1,transparent:!1,isClosed:!1,falloff:0,innerWidth:0,innerColor:null,sceneHasOcludees:!1},d.Default),P=function(){function e(e,t){switch(this.params=t,this.numJoinSubdivisions=0,this.vertexBufferLayout=e,this.params.join){case"miter":case"bevel":this.numJoinSubdivisions=t.stipplePattern?1:0;break;case"round":this.numJoinSubdivisions=V}}return e.prototype.isClosed=function(e){return E(this.params,e.vertexAttr,e.indices)},e.prototype.numCapSubdivisions=function(e){if(this.isClosed(e))return 0;switch(this.params.cap){case"butt":return 0;case"square":return 1;case"round":return T}},e.prototype.allocate=function(e){return this.vertexBufferLayout.createBuffer(e)},e.prototype.elementCount=function(e){var t=2*this.numCapSubdivisions(e)+2,i=e.indices[C.RibbonVertexAttributeConstants.POSITION].length/2+1,n=this.isClosed(e),r=n?2:2*t,a=n?0:1,s=n?i:i-1;if(e.vertexAttr[C.RibbonVertexAttributeConstants.SUBDIVISIONS])for(var o=e.vertexAttr[C.RibbonVertexAttributeConstants.SUBDIVISIONS].data,c=a;c<s;++c){r+=4+2*o[c]}else r+=(s-a)*(2*this.numJoinSubdivisions+4);return r+=2},e.prototype.write=function(e,t,i,n){var r=this,a=j,s=Z,o=G,u=t.vertexAttr[C.RibbonVertexAttributeConstants.POSITION].data,p=t.indices&&t.indices[C.RibbonVertexAttributeConstants.POSITION],l=this.numCapSubdivisions(t);p&&p.length!==2*(u.length/3-1)&&console.warn("RibbonLineMaterial does not support indices");var h=null;t.vertexAttr[C.RibbonVertexAttributeConstants.SUBDIVISIONS]&&(h=t.vertexAttr[C.RibbonVertexAttributeConstants.SUBDIVISIONS].data);var b=1,v=0;this.params.vvSizeEnabled?v=t.vertexAttr[C.RibbonVertexAttributeConstants.SIZEFEATUREATTRIBUTE].data[0]:t.vertexAttr[C.RibbonVertexAttributeConstants.SIZE]&&(b=t.vertexAttr[C.RibbonVertexAttributeConstants.SIZE].data[0]);var f=[1,1,1,1],d=0;this.params.vvColorEnabled?d=t.vertexAttr[C.RibbonVertexAttributeConstants.COLORFEATUREATTRIBUTE].data[0]:t.vertexAttr[C.RibbonVertexAttributeConstants.COLOR]&&(f=t.vertexAttr[C.RibbonVertexAttributeConstants.COLOR].data);var m=0;this.params.vvOpacityEnabled&&(m=t.vertexAttr[C.RibbonVertexAttributeConstants.OPACITYFEATUREATTRIBUTE].data[0]);var g=u.length/3,A=e.transformation,S=new Float32Array(i.buffer),R=this.vertexBufferLayout.stride/4,y=n*R,x=y,P=function(e,t,i,n,a,s){S[y++]=t[0],S[y++]=t[1],S[y++]=t[2],S[y++]=n,S[y++]=a,S[y++]=s,S[y++]=e[0],S[y++]=e[1],S[y++]=e[2],S[y++]=i[0],S[y++]=i[1],S[y++]=i[2],r.params.vvSizeEnabled?S[y++]=v:S[y++]=b,r.params.vvColorEnabled?S[y++]=d:(S[y++]=f[0],S[y++]=f[1],S[y++]=f[2],S[y++]=f[3]),r.params.vvOpacityEnabled&&(S[y++]=m)};y+=R,c.vec3.set(s,u[0],u[1],u[2]),A&&c.vec3.transformMat4(s,s,A);var E=this.isClosed(t);if(E){var I=u.length-3;c.vec3.set(a,u[I],u[I+1],u[I+2]),A&&c.vec3.transformMat4(a,a,A)}else{c.vec3.copy(a,s),c.vec3.set(o,u[3],u[4],u[5]),A&&c.vec3.transformMat4(o,o,A);for(var T=0;T<l;++T){P(a,s,o,M=1-T/l,1,-4),P(a,s,o,M,1,4)}P(a,s,o,0,0,-4),P(a,s,o,0,0,4),c.vec3.copy(a,s),c.vec3.copy(s,o)}var V=E?g:g-1;for(T=E?0:1;T<V;T++){var q=(T+1)%g*3;c.vec3.set(o,u[q+0],u[q+1],u[q+2]),A&&c.vec3.transformMat4(o,o,A),P(a,s,o,0,1,-1),P(a,s,o,0,1,1);for(var L=h?h[T]:this.numJoinSubdivisions,U=0;U<L;++U){P(a,s,o,M=(U+1)/(L+1),1,-2),P(a,s,o,M,1,2)}P(a,s,o,1,0,-2),P(a,s,o,1,0,2),c.vec3.copy(a,s),c.vec3.copy(s,o)}if(E){y=O(S,x+R,S,y,2*R)}else{P(a,s,o,0,1,-5),P(a,s,o,0,1,5);for(T=0;T<l;++T){var M;P(a,s,o,M=(T+1)/l,1,-5),P(a,s,o,M,1,5)}}O(S,x+R,S,x,R),y=O(S,y-R,S,y,R)},e}();function O(e,t,i,n,r){for(var a=0;a<r;a++)i[n++]=e[t++];return n}function E(e,t,i){return I(e,t[C.RibbonVertexAttributeConstants.POSITION].data,i?i[C.RibbonVertexAttributeConstants.POSITION]:null)}function I(e,t,i){return!!e.isClosed&&(i?i.length>2:t.length>6)}var T=3,V=1,q=u.vec3f64.create(),L=u.vec3f64.create(),U=u.vec3f64.create(),M=u.vec3f64.create(),D=u.vec3f64.create(),z=s.createRenderScreenPointArray3(),B=s.createRenderScreenPointArray3(),w=u.vec3f64.create(),N=u.vec3f64.create(),F=p.lineSegment.create(),_=p.lineSegment.create(),j=u.vec3f64.create(),Z=u.vec3f64.create(),G=u.vec3f64.create(),H=[s.createRenderScreenPointArray3(),s.createRenderScreenPointArray3(),s.createRenderScreenPointArray3(),s.createRenderScreenPointArray3()],J=[u.vec3f64.create(),u.vec3f64.create(),u.vec3f64.create(),u.vec3f64.create()],W=p.plane.create(),X=p.plane.create(),k=p.plane.create(),Y=p.plane.create();return R}));