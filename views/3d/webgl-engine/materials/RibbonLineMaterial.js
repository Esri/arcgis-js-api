/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/Logger","../../../../core/mathUtils","../../../../core/screenUtils","../../../../chunks/vec3f64","../../../../chunks/vec3","../../../../chunks/vec2","../../support/buffer/InterleavedLayout","../../support/geometryUtils","../lib/Util","../lib/geometryDataUtils","./renderers/utils","../lib/GLMaterial","../lib/Material","./VisualVariableMaterialParameters","../shaders/RibbonLineTechnique"],(function(e,t,i,n,s,r,a,o,c,u,l,p,h,f,d,m,g,v){"use strict";const b=n.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial");let S=function(e){function n(t){var i;return(i=e.call(this,t,C)||this)._vertexAttributeLocations=v.ribbonVertexAttributeLocations,i.techniqueConfig=new v.RibbonLineTechniqueConfiguration,i.layout=i.createLayout(),i}t._inheritsLoose(n,e);var r=n.prototype;return r.isClosed=function(e,t){return x(this.params,e,t)},r.dispose=function(){},r.getPassParameters=function(){return this.params},r.getTechniqueConfig=function(e,t){this.techniqueConfig.output=e;const n=i.isSome(this.params.stipplePattern);return this.techniqueConfig.stippleEnabled=n,this.techniqueConfig.stippleIntegerRepeatsEnabled=n&&this.params.stippleIntegerRepeats,this.techniqueConfig.stippleOffColorEnabled=n&&i.isSome(this.params.stippleOffColor),this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.sceneHasOcludees=this.params.sceneHasOcludees,this.techniqueConfig.roundJoins="round"===this.params.join,this.techniqueConfig.roundCaps="round"===this.params.cap,this.techniqueConfig.transparent=this.params.transparent,this.techniqueConfig.polygonOffset=this.params.polygonOffset,this.techniqueConfig.writeDepth=this.params.writeDepth,this.techniqueConfig.vvColor=this.params.vvColorEnabled,this.techniqueConfig.vvOpacity=this.params.vvOpacityEnabled,this.techniqueConfig.vvSize=this.params.vvSizeEnabled,this.techniqueConfig.innerColorEnabled=this.params.innerWidth>0&&i.isSome(this.params.innerColor),this.techniqueConfig.falloffEnabled=this.params.falloff>0,this.techniqueConfig.occluder=8===this.params.renderOccluded,this.techniqueConfig.transparencyPassType=t?t.transparencyPassType:3,this.techniqueConfig.multipassTerrainEnabled=!!t&&t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=!t||t.cullAboveGround,this.techniqueConfig},r.intersect=function(e,t,i,n,s,r,a,o,c){c?this.intersectDrapedLineGeometry(e,n,r,a):this.intersectLineGeometry(e,t,i,n,this.params.width,a)},r.intersectDrapedLineGeometry=function(e,t,i,n){if(!t.options.selectionMode)return;const r=e.vertexAttributes.get("position").data,a=e.vertexAttributes.get("size");let o=this.params.width;if(this.params.vvSizeEnabled){const t=e.vertexAttributes.get("sizeFeatureAttribute").data[0];o*=s.clamp(this.params.vvSizeOffset[0]+t*this.params.vvSizeFactor[0],this.params.vvSizeMinSize[0],this.params.vvSizeMaxSize[0])}else a&&(o*=a.data[0]);const c=i[0],u=i[1],l=(o/2+4)*e.screenToWorldRatio;let p=Number.MAX_VALUE;for(let h=0;h<r.length-5;h+=3){const e=r[h],t=r[h+1],i=c-e,n=u-t,a=r[h+3]-e,o=r[h+4]-t,l=a*i+o*n,f=a*a+o*o,d=s.clamp(l/f,0,1),m=a*d-i,g=o*d-n,v=m*m+g*g;v<p&&(p=v)}p<l*l&&n()},r.intersectLineGeometry=function(e,t,i,n,r,a){if(!n.options.selectionMode||f.isInstanceHidden(t))return;if(!p.isTranslationMatrix(i))return void b.error("intersection assumes a translation-only matrix");const u=e.vertexAttributes,h=u.get("position").data;let d=r;if(this.params.vvSizeEnabled){const e=u.get("sizeFeatureAttribute").data[0];d*=s.clamp(this.params.vvSizeOffset[0]+e*this.params.vvSizeFactor[0],this.params.vvSizeMinSize[0],this.params.vvSizeMaxSize[0])}else u.has("size")&&(d*=u.get("size").data[0]);const m=n.camera,g=T;c.copy(g,n.point);const v=d*m.pixelRatio/2+4*m.pixelRatio;o.set(H[0],g[0]-v,g[1]+v,0),o.set(H[1],g[0]+v,g[1]+v,0),o.set(H[2],g[0]+v,g[1]-v,0),o.set(H[3],g[0]-v,g[1]-v,0);for(let s=0;s<4;s++)if(!m.unprojectFromRenderScreen(H[s],J[s]))return;l.plane.fromPoints(m.eye,J[0],J[1],k),l.plane.fromPoints(m.eye,J[1],J[2],I),l.plane.fromPoints(m.eye,J[2],J[3],W),l.plane.fromPoints(m.eye,J[3],J[0],N);let S=Number.MAX_VALUE;const y=q(this.params,u,e.indices)?h.length-2:h.length-5;for(let s=0;s<y;s+=3){E[0]=h[s]+i[12],E[1]=h[s+1]+i[13],E[2]=h[s+2]+i[14];const e=(s+3)%h.length;if(R[0]=h[e]+i[12],R[1]=h[e+1]+i[13],R[2]=h[e+2]+i[14],l.plane.signedDistance(k,E)<0&&l.plane.signedDistance(k,R)<0||l.plane.signedDistance(I,E)<0&&l.plane.signedDistance(I,R)<0||l.plane.signedDistance(W,E)<0&&l.plane.signedDistance(W,R)<0||l.plane.signedDistance(N,E)<0&&l.plane.signedDistance(N,R)<0)continue;if(m.projectToRenderScreen(E,D),m.projectToRenderScreen(R,w),D[2]<0&&w[2]>0){o.subtract(O,E,R);const e=m.frustum,t=-l.plane.signedDistance(e[4],E)/o.dot(O,l.plane.normal(e[4]));o.scale(O,O,t),o.add(E,E,O),m.projectToRenderScreen(E,D)}else if(D[2]>0&&w[2]<0){o.subtract(O,R,E);const e=m.frustum,t=-l.plane.signedDistance(e[4],R)/o.dot(O,l.plane.normal(e[4]));o.scale(O,O,t),o.add(R,R,O),m.projectToRenderScreen(R,w)}else if(D[2]<0&&w[2]<0)continue;D[2]=0,w[2]=0;const t=l.lineSegment.distance2(l.lineSegment.fromPoints(D,w,j),g);t<S&&(S=t,o.copy(F,E),o.copy(_,R))}const C=n.rayBeginPoint,A=n.rayEndPoint;if(S<v*v){let e=Number.MAX_VALUE;if(l.lineSegment.closestLineSegmentPoint(l.lineSegment.fromPoints(F,_,j),l.lineSegment.fromPoints(C,A,U),M)){o.subtract(M,M,C);const t=o.length(M);o.scale(M,M,1/t),e=t/o.distance(C,A)}a(e,M)}},r.computeAttachmentOrigin=function(e,t){const i=e.vertexAttributes;if(!i)return null;const n=e.indices,s=i.get("position");return h.computeAttachmentOriginLines(s,n?n.get("position"):null,n&&q(this.params,i,n),t)},r.createLayout=function(){const e=u.newLayout().vec3f("position").f32("subdivisionFactor").vec2f("uv0").vec3f("auxpos1").vec3f("auxpos2");return this.params.vvSizeEnabled?e.f32("sizeFeatureAttribute"):e.f32("size"),this.params.vvColorEnabled?e.f32("colorFeatureAttribute"):e.vec4f("color"),this.params.vvOpacityEnabled&&e.f32("opacityFeatureAttribute"),e},r.createBufferWriter=function(){return new A(this.layout,this.params)},r.getGLMaterial=function(e){return 0===e.output||7===e.output||4===e.output||1===e.output?new y(e):void 0},r.validateParameterValues=function(e){"miter"!==e.join&&(e.miterLimit=0),this.requiresTransparent(e)&&(e.transparent=!0)},r.requiresTransparent=function(e){return!!((e.color&&e.color[3])<1||e.innerWidth>0&&this.colorRequiresTransparent(e.innerColor)||e.stipplePattern&&this.colorRequiresTransparent(e.stippleOffColor)||e.falloff>0)},r.colorRequiresTransparent=function(e){return i.isSome(e)&&e[3]<1&&e[3]>0},n}(m.Material),y=function(e){function i(t){var i;return(i=e.call(this,t)||this).updateParameters(),i}t._inheritsLoose(i,e);var n=i.prototype;return n.updateParameters=function(e){this.technique=this.techniqueRep.acquireAndReleaseExisting(v.RibbonLineTechnique,this.material.getTechniqueConfig(this.output,e),this.technique)},n.beginSlot=function(e){return this.technique.configuration.occluder?3===e||10===e||11===e:0===this.output||7===this.output?(this.targetSlot=this.technique.configuration.writeDepth?5:8,e===this.targetSlot):3===e},n._updateOccludeeState=function(e){e.hasOccludees!==this.material.params.sceneHasOcludees&&this.material.setParameterValues({sceneHasOcludees:e.hasOccludees})},n.ensureParameters=function(e){0!==this.output&&7!==this.output||this._updateOccludeeState(e),this.updateParameters(e)},n.bind=function(e,t){e.bindProgram(this.technique.program),this.technique.bindPass(e,this.material.getPassParameters(),t)},n.getPipelineState=function(e,t){return this.technique.getPipelineState(e,t)},i}(d);const C={width:0,color:[1,1,1,1],join:"miter",cap:"butt",miterLimit:5,writeDepth:!0,polygonOffset:!1,stipplePattern:null,stippleIntegerRepeats:!1,stippleOffColor:null,slicePlaneEnabled:!1,vvFastUpdate:!1,transparent:!1,isClosed:!1,falloff:0,innerWidth:0,innerColor:null,sceneHasOcludees:!1,...m.materialParametersDefaults,...g.Default};let A=function(){function e(e,t){switch(this.params=t,this.numJoinSubdivisions=0,this.vertexBufferLayout=e,this.params.join){case"miter":case"bevel":this.numJoinSubdivisions=t.stipplePattern?1:0;break;case"round":this.numJoinSubdivisions=z}}var t=e.prototype;return t.isClosed=function(e){return q(this.params,e.vertexAttributes,e.indices)},t.numCapSubdivisions=function(e){if(this.isClosed(e))return 0;switch(this.params.cap){case"butt":return 0;case"square":return 1;case"round":return L}},t.allocate=function(e){return this.vertexBufferLayout.createBuffer(e)},t.elementCount=function(e){const t=2*this.numCapSubdivisions(e)+2,i=e.indices.get("position").length/2+1,n=this.isClosed(e);let s=n?2:2*t;const r=n?0:1,a=n?i:i-1;if(e.vertexAttributes.has("subdivisions")){const t=e.vertexAttributes.get("subdivisions").data;for(let e=r;e<a;++e){s+=4+2*t[e]}}else{s+=(a-r)*(2*this.numJoinSubdivisions+4)}return s+=2,s},t.write=function(e,t,i,n){const s=G,r=V,a=B,c=t.vertexAttributes.get("position").data,u=t.indices&&t.indices.get("position"),l=this.numCapSubdivisions(t);u&&u.length!==2*(c.length/3-1)&&console.warn("RibbonLineMaterial does not support indices");let p=null;t.vertexAttributes.has("subdivisions")&&(p=t.vertexAttributes.get("subdivisions").data);let h=1,f=0;this.params.vvSizeEnabled?f=t.vertexAttributes.get("sizeFeatureAttribute").data[0]:t.vertexAttributes.has("size")&&(h=t.vertexAttributes.get("size").data[0]);let d=[1,1,1,1],m=0;this.params.vvColorEnabled?m=t.vertexAttributes.get("colorFeatureAttribute").data[0]:t.vertexAttributes.has("color")&&(d=t.vertexAttributes.get("color").data);let g=0;this.params.vvOpacityEnabled&&(g=t.vertexAttributes.get("opacityFeatureAttribute").data[0]);const v=c.length/3,b=e.transformation,S=new Float32Array(i.buffer),y=this.vertexBufferLayout.stride/4;let C=n*y;const A=C,q=(e,t,i,n,s,r,a)=>{if(S[C++]=t[0],S[C++]=t[1],S[C++]=t[2],S[C++]=n,S[C++]=s,S[C++]=r,S[C++]=e[0],S[C++]=e[1],S[C++]=e[2],S[C++]=i[0],S[C++]=i[1],S[C++]=i[2],this.params.vvSizeEnabled?S[C++]=f:S[C++]=h,this.params.vvColorEnabled)S[C++]=m;else{const e=Math.min(4*a,d.length-4);S[C++]=d[e+0],S[C++]=d[e+1],S[C++]=d[e+2],S[C++]=d[e+3]}this.params.vvOpacityEnabled&&(S[C++]=g)};C+=y,o.set(r,c[0],c[1],c[2]),b&&o.transformMat4(r,r,b);const x=this.isClosed(t);if(x){const e=c.length-3;o.set(s,c[e],c[e+1],c[e+2]),b&&o.transformMat4(s,s,b)}else{o.copy(s,r),o.set(a,c[3],c[4],c[5]),b&&o.transformMat4(a,a,b);for(let e=0;e<l;++e){const t=1-e/l;q(s,r,a,t,1,-4,0),q(s,r,a,t,1,4,0)}q(s,r,a,0,0,-4,0),q(s,r,a,0,0,4,0),o.copy(s,r),o.copy(r,a)}const L=x?v:v-1;for(let P=x?0:1;P<L;P++){const e=(P+1)%v*3;o.set(a,c[e+0],c[e+1],c[e+2]),b&&o.transformMat4(a,a,b),q(s,r,a,0,1,-1,P),q(s,r,a,0,1,1,P);const t=p?p[P]:this.numJoinSubdivisions;for(let i=0;i<t;++i){const e=(i+1)/(t+1);q(s,r,a,e,1,-2,P),q(s,r,a,e,1,2,P)}q(s,r,a,1,0,-2,P),q(s,r,a,1,0,2,P),o.copy(s,r),o.copy(r,a)}if(x){C=P(S,A+y,S,C,2*y)}else{q(s,r,a,0,1,-5,L),q(s,r,a,0,1,5,L);for(let e=0;e<l;++e){const t=(e+1)/l;q(s,r,a,t,1,-5,L),q(s,r,a,t,1,5,L)}}P(S,A+y,S,A,y);C=P(S,C-y,S,C,y)},e}();function P(e,t,i,n,s){for(let r=0;r<s;r++)i[n++]=e[t++];return n}function q(e,t,i){return x(e,t.get("position").data,i?i.get("position"):null)}function x(e,t,i){return!!e.isClosed&&(i?i.length>2:t.length>6)}const L=3,z=1,E=a.create(),R=a.create(),O=a.create(),M=a.create(),T=a.create(),D=r.createRenderScreenPointArray3(),w=r.createRenderScreenPointArray3(),F=a.create(),_=a.create(),j=l.lineSegment.create(),U=l.lineSegment.create(),G=a.create(),V=a.create(),B=a.create(),H=[r.createRenderScreenPointArray3(),r.createRenderScreenPointArray3(),r.createRenderScreenPointArray3(),r.createRenderScreenPointArray3()],J=[a.create(),a.create(),a.create(),a.create()],k=l.plane.create(),I=l.plane.create(),W=l.plane.create(),N=l.plane.create();e.RibbonLineMaterial=S,Object.defineProperty(e,"__esModule",{value:!0})}));
