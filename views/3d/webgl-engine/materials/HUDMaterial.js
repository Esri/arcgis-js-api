// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.5/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","dojo/text!./HUDMaterial.xml","./internal/MaterialUtil","../lib/Util","../../../webgl/Util","./internal/MaterialBase","./internal/GLMaterialTextureBase","../lib/gl-matrix","../lib/RenderSlot","../lib/RenderPass","../lib/ShaderVariations","../lib/ComponentUtils","../../support/aaBoundingRect","../lib/screenSizePerspectiveUtils"],function(e,t,r,i,n,o,a,s,l,c,f,d,v,u,p,S){function m(e,t){return void 0===t&&(t=L),e.textureIsSignedDistanceField?h(e.anchorPos,e.distanceFieldBoundingBox,t):x.set(e.anchorPos,t),t}function g(e,t,r,i){return void 0===i&&(i=L),x.set(e.anchorPos,i),i[0]*=-t[0],i[1]*=-t[1],i[0]+=e.screenOffset[0]*r,i[1]+=e.screenOffset[1]*r,i}function h(e,t,r){r[0]=e[0]*(t[2]-t[0])+t[0],r[1]=e[1]*(t[3]-t[1])+t[1]}var x=c.vec2d,P=c.vec3d,A=c.mat3d,O=c.mat4d,z=76,C=z/4,y="hud-material-shader-variations",V="hud-material-highlight-shader-variations",b="hud-material-occlusion-test-pixel-shader-variations",I={"bottom-left":[0,0],bottom:[.5,0],"bottom-right":[1,0],left:[0,.5],center:[.5,.5],right:[1,.5],"top-left":[0,1],top:[.5,1],"top-right":[1,1]},E=[{name:"position",count:3,type:5126,offset:0,stride:z,normalized:!1},{name:"normal",count:3,type:5126,offset:12,stride:z,normalized:!1},{name:"uv0",count:2,type:5126,offset:24,stride:z,normalized:!1},{name:"color",count:4,type:5121,offset:32,stride:z,normalized:!1},{name:"size",count:2,type:5126,offset:36,stride:z,normalized:!1},{name:"auxpos1",count:4,type:5126,offset:44,stride:z,normalized:!1},{name:"auxpos2",count:4,type:5126,offset:60,stride:z,normalized:!1}],U={texCoordScale:[1,1],occlusionTest:!0,binaryHighlightOcclusion:!0,drawInSecondSlot:!1,color:[1,1,1,1],outlineColor:[1,1,1,1],outlineSize:0,textureIsSignedDistanceField:!1,distanceFieldBoundingBox:null,vvSizeEnabled:!1,vvSizeMinSize:[1,1,1],vvSizeMaxSize:[100,100,100],vvSizeOffset:[0,0,0],vvSizeFactor:[1,1,1],vvColorEnabled:!1,vvColorValues:[0,0,0,0,0,0,0,0],vvColorColors:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],screenOffset:[0,0],verticalOffset:null,screenSizePerspective:null,screenSizePerspectiveAlignment:null,anchorPos:I.center,shaderPolygonOffset:1e-5,polygonOffset:!1,textureId:null,centerOffsetUnits:"world",debugDrawBorder:!1},D=function(e){function t(t,r){var i=e.call(this,r)||this;return i._textureDirty=!1,i.params=n.copyParameters(t,U),"string"==typeof i.params.anchorPos&&(i.params.anchorPos=I[i.params.anchorPos]),i}return r(t,e),t.prototype.dispose=function(){},t.prototype.getParameterValues=function(){var e=this.params;return{color:e.color,texCoordScale:e.texCoordScale,polygonOffset:e.polygonOffset,anchorPos:e.anchorPos,screenOffset:e.screenOffset,verticalOffset:e.verticalOffset,screenSizePerspective:e.screenSizePerspective,screenSizePerspectiveAlignment:e.screenSizePerspectiveAlignment,shaderPolygonOffset:e.shaderPolygonOffset,textureIsSignedDistanceField:e.textureIsSignedDistanceField,outlineColor:e.outlineColor,outlineSize:e.outlineSize,distanceFieldBoundingBox:e.distanceFieldBoundingBox,vvSizeEnabled:e.vvSizeEnabled,vvSizeMinSize:e.vvSizeMinSize,vvSizeMaxSize:e.vvSizeMaxSize,vvSizeOffset:e.vvSizeOffset,vvSizeFactor:e.vvSizeFactor,vvColorEnabled:e.vvColorEnabled,vvColorValues:e.vvColorValues,vvColorColors:e.vvColorColors,textureId:e.textureId,occlusionTest:e.occlusionTest,binaryHighlightOcclusion:e.binaryHighlightOcclusion,centerOffsetUnits:e.centerOffsetUnits,debugDrawBorder:e.debugDrawBorder,drawInSecondSlot:e.drawInSecondSlot}},t.prototype.setParameterValues=function(e){for(var t in e)"textureId"===t&&o.assert(!!this.params.textureId,"Can only change texture of material that already has a texture"),this.params[t]=e[t];this.notifyDirty("matChanged")},t.prototype.getParams=function(){return this.params},t.prototype.getOutputAmount=function(e){return e*C*6},t.prototype.getInstanceBufferLayout=function(){},t.prototype.getVertexBufferLayout=function(){return E},t.prototype.fillInterleaved=function(e,t,r,i,s,l){for(var c=4*l,f=e.faces.indices[o.VertexAttrConstants.POSITION],d=e.vertexAttr[o.VertexAttrConstants.POSITION].data,v=l+a.findAttribute(E,o.VertexAttrConstants.POSITION).offset/4,u=0;u<f.length;++u){var p=3*f[u];n.fill(d,p,s,v,t,3),v+=C,n.fill(d,p,s,v,t,3),v+=C,n.fill(d,p,s,v,t,3),v+=C,n.fill(d,p,s,v,t,3),v+=C,n.fill(d,p,s,v,t,3),v+=C,n.fill(d,p,s,v,t,3),v+=C}for(var S=e.faces.indices[o.VertexAttrConstants.NORMAL],m=e.vertexAttr[o.VertexAttrConstants.NORMAL].data,g=l+a.findAttribute(E,o.VertexAttrConstants.NORMAL).offset/4,u=0;u<S.length;++u){var p=3*S[u];n.fill(m,p,s,g,r,3),g+=C,n.fill(m,p,s,g,r,3),g+=C,n.fill(m,p,s,g,r,3),g+=C,n.fill(m,p,s,g,r,3),g+=C,n.fill(m,p,s,g,r,3),g+=C,n.fill(m,p,s,g,r,3),g+=C}var h,x,P,A,O=e.vertexAttr[o.VertexAttrConstants.UV0].data;null==O||O.length<=3?(h=0,x=0,P=this.params.texCoordScale[0],A=this.params.texCoordScale[1]):(h=e.vertexAttr[o.VertexAttrConstants.UV0].data[0],x=e.vertexAttr[o.VertexAttrConstants.UV0].data[1],P=e.vertexAttr[o.VertexAttrConstants.UV0].data[2],A=e.vertexAttr[o.VertexAttrConstants.UV0].data[3]),P=Math.min(1.99999,P+1),A=Math.min(1.99999,A+1);for(var y=l+a.findAttribute(E,o.VertexAttrConstants.UV0).offset/4,u=0;u<f.length;++u)s[y]=h,s[y+1]=x,y+=C,s[y]=P,s[y+1]=x,y+=C,s[y]=P,s[y+1]=A,y+=C,s[y]=P,s[y+1]=A,y+=C,s[y]=h,s[y+1]=A,y+=C,s[y]=h,s[y+1]=x,y+=C;for(var V=e.faces.indices[o.VertexAttrConstants.COLOR],b=e.vertexAttr[o.VertexAttrConstants.COLOR].data,I=c+a.findAttribute(E,o.VertexAttrConstants.COLOR).offset,U=new Uint8Array(s.buffer),u=0;u<V.length;++u){var p=4*V[u];n.fill(b,p,U,I,null,4),I+=z,n.fill(b,p,U,I,null,4),I+=z,n.fill(b,p,U,I,null,4),I+=z,n.fill(b,p,U,I,null,4),I+=z,n.fill(b,p,U,I,null,4),I+=z,n.fill(b,p,U,I,null,4),I+=z}for(var D=e.faces.indices[o.VertexAttrConstants.SIZE],T=e.vertexAttr[o.VertexAttrConstants.SIZE].data,R=l+a.findAttribute(E,o.VertexAttrConstants.SIZE).offset/4,u=0;u<D.length;++u){var M=T[2*D[u]],F=T[2*D[u]+1];s[R]=M,s[R+1]=F,R+=C,s[R]=M,s[R+1]=F,R+=C,s[R]=M,s[R+1]=F,R+=C,s[R]=M,s[R+1]=F,R+=C,s[R]=M,s[R+1]=F,R+=C,s[R]=M,s[R+1]=F,R+=C}if(null!=e.faces.indices[o.VertexAttrConstants.AUXPOS1]&&null!=e.vertexAttr[o.VertexAttrConstants.AUXPOS1])for(var L=e.faces.indices[o.VertexAttrConstants.AUXPOS1],w=e.vertexAttr[o.VertexAttrConstants.AUXPOS1].data,B=l+a.findAttribute(E,"auxpos1").offset/4,u=0;u<L.length;++u){var p=4*L[u];n.fill(w,p,s,B,null,4),B+=C,n.fill(w,p,s,B,null,4),B+=C,n.fill(w,p,s,B,null,4),B+=C,n.fill(w,p,s,B,null,4),B+=C,n.fill(w,p,s,B,null,4),B+=C,n.fill(w,p,s,B,null,4),B+=C}if(null!=e.faces.indices[o.VertexAttrConstants.AUXPOS2]&&null!=e.vertexAttr[o.VertexAttrConstants.AUXPOS2])for(var _=e.faces.indices[o.VertexAttrConstants.AUXPOS2],N=e.vertexAttr[o.VertexAttrConstants.AUXPOS2].data,H=l+a.findAttribute(E,"auxpos2").offset/4,u=0;u<_.length;++u){var p=4*_[u];n.fill(N,p,s,H,null,4),H+=C,n.fill(N,p,s,H,null,4),H+=C,n.fill(N,p,s,H,null,4),H+=C,n.fill(N,p,s,H,null,4),H+=C,n.fill(N,p,s,H,null,4),H+=C,n.fill(N,p,s,H,null,4),H+=C}},t.prototype.intersect=function(e,t,r,i,n,a,s,l){if(i.isSelection&&i.enableHUDSelection&&!u.isAllHidden(t.componentVisibilities,e.data.componentOffsets)){var c=this.params,f=1,d=1;if(l){var v=l(j);f=v[0],d=v[5]}var p=e.getData().getVertexAttr()[o.VertexAttrConstants.POSITION],g=e.getData().getVertexAttr()[o.VertexAttrConstants.SIZE],h=e.getData().getVertexAttr()[o.VertexAttrConstants.NORMAL];o.assert(p.size>=3);for(var x=i.point,A=i.camera,z=m(c),C=0;C<p.data.length/p.size;C++){var y=C*p.size;P.set3(p.data[y],p.data[y+1],p.data[y+2],w),O.multiplyVec3(r,w,w);var V=C*g.size;Q[0]=g.data[V]*f,Q[1]=g.data[V+1]*d,O.multiplyVec3(A.viewMatrix,w);var b=C*h.size;if(P.set3(h.data[b],h.data[b+1],h.data[b+2],B),this.applyVerticalOffsetTransformation(w,B,r,A,F),A.applyProjection(w,_),_[0]>-1){var I=Math.floor(_[0]),E=Math.floor(_[1]);S.applyPrecomputedScaleFactorVec2(Q,F.factor,Q);var U=I-q-(z[0]>0?Q[0]*z[0]:0),D=U+Q[0]+2*q,T=E-q-(z[1]>0?Q[1]*z[1]:0),R=T+Q[1]+2*q;if(c.textureIsSignedDistanceField){var M=c.outlineSize/2,L=c.distanceFieldBoundingBox;U+=Q[0]*L[0],T+=Q[1]*L[1],D-=Q[0]*(1-L[2]),R-=Q[1]*(1-L[3]),U-=M,D+=M,T-=M,R+=M}if(x[0]>U&&x[0]<D&&x[1]>T&&x[1]<R){var N=i.p0,G=i.p1;O.multiplyVec3(O.inverse(A.viewMatrix,X),w,H),_[0]=x[0],_[1]=x[1],A.unprojectPoint(_,w);var Z=P.negate(i.getDirection(),P.create()),W=P.dist(N,w)/P.dist(N,G);s(W,Z,-1,1,!0,H)}}}}},t.prototype.normalAndViewAngle=function(e,t,r,i){return void 0===i&&(i=Z),A.multiplyVec3(O.toMat3(t,G),e,i.normal),O.multiplyVec3(r.viewInverseTransposeMatrix,i.normal),i.cosAngle=P.dot(N,W),i},t.prototype.updateScaleInfo=function(e,t,r){var i=this.params;i.screenSizePerspective?e.factor=S.precomputeScaleFactor(Z.cosAngle,r,i.screenSizePerspective,e.factor):(e.factor.scale=1,e.factor.factor=0,e.factor.minPixelSize=0,e.factor.paddingPixels=0),i.screenSizePerspectiveAlignment?(e.scaleAlignment=S.precomputeScale(Z.cosAngle,r,i.screenSizePerspectiveAlignment),e.minPixelSizeAlignment=i.screenSizePerspectiveAlignment.parameters.minPixelSize):(e.scaleAlignment=e.factor.scale,e.minPixelSizeAlignment=e.factor.minPixelSize)},t.prototype.applyVerticalOffsetTransformation=function(e,t,r,i,o,a){var s=this.params;if(!s.verticalOffset||!s.verticalOffset.screenLength){if(o&&(s.screenSizePerspective||s.screenSizePerspectiveAlignment)){var l=this.normalAndViewAngle(t,r,i),c=P.length(e);this.updateScaleInfo(o,l.cosAngle,c)}else o&&(o.factor.scale=1,o.scaleAlignment=1);return a?P.set(e,a):e}var f=this.normalAndViewAngle(t,r,i),d=P.length(e),v=s.screenSizePerspectiveAlignment||s.screenSizePerspective,u=n.verticalOffsetAtDistance(i,d,s.verticalOffset,f.cosAngle,v);return o&&this.updateScaleInfo(o,f.cosAngle,d),P.add(e,P.scale(f.normal,u),a)},t.prototype.getGLMaterials=function(){return{color:R,depthShadowMap:void 0,normal:void 0,depth:void 0,highlight:M}},t.prototype.getAllTextureIds=function(){return[this.params.textureId]},t.prototype.setTextureDirty=function(){this._textureDirty=!0},t.prototype.calculateRelativeScreenBounds=function(e,t,r){return void 0===r&&(r=p.create()),g(this.params,e,t,r),r[2]=r[0]+e[0],r[3]=r[1]+e[1],r},t.prototype.calculateAnchorPosForRendering=function(e){return m(this.params,e)},t.loadShaders=function(e,t,r,n){e._parse(i);var o=function(e){e.addDefine("OcclTest","OCCL_TEST"),e.addDefine("SDF","SIGNED_DISTANCE_FIELD"),e.addDefine("vvSize","VV_SIZE"),e.addDefine("vvColor","VV_COLOR"),e.addDefine("verticalOffset","VERTICAL_OFFSET"),e.addDefine("screenSizePerspective","SCREEN_SIZE_PERSPECTIVE"),e.addDefine("centerOffsetUnitsScreen","CENTER_OFFSET_UNITS_SCREEN")},a=new v("hud",["vertexShaderHUD","fragmentShaderHUD"],null,r,t,e,n);o(a),a.addDefine("debugDrawBorder","DEBUG_DRAW_BORDER"),r.addShaderVariations(y,a);var s=new v("hudHighlight",["vertexShaderHUD","fragmentShaderHUDHighlight"],null,r,t,e,n);o(s),s.addDefine("binaryHighlightOcclusion","BINARY_HIGHLIGHT_OCCLUSION"),r.addShaderVariations(V,s);var l=new v("hudOcclusionTestPixel",["vertexShaderOcclusionTestPixel","fragmentShaderSimple"],null,r,t,e,n);l.addDefine("verticalOffset","VERTICAL_OFFSET"),l.addDefine("screenSizePerspective","SCREEN_SIZE_PERSPECTIVE"),l.addDefine("centerOffsetUnitsScreen","CENTER_OFFSET_UNITS_SCREEN"),r.addShaderVariations(b,l)},t.shouldRenderVisibilityDuringRenderPass=function(e){return e===d.MATERIAL||d.MATERIAL_HIGHLIGHT},t}(s.MaterialBase),T=function(e){function t(t,r,i){var o=e.call(this,t,t.getParams(),r,i)||this;return o.programRep=r,o.params=n.copyParameters(t.getParams()),o.selectProgram(),o.selectSlot(),o}return r(t,e),t.prototype.selectSlot=function(){this.mainSlot=this.params.drawInSecondSlot?f.HUDMATERIAL2:f.HUDMATERIAL1},t.prototype.beginSlot=function(e){return e===this.mainSlot},t.prototype.getProgram=function(){return this.program},t.prototype.getAllPrograms=function(){return[this.program]},t.prototype.updateParameters=function(){var e=this.material.getParams(),t=this.params;t.color=e.color,t.texCoordScale=e.texCoordScale,t.polygonOffset=e.polygonOffset,t.anchorPos=e.anchorPos,t.screenOffset=e.screenOffset,t.verticalOffset=e.verticalOffset,t.screenSizePerspective=e.screenSizePerspective,t.screenSizePerspectiveAlignment=e.screenSizePerspectiveAlignment,t.shaderPolygonOffset=e.shaderPolygonOffset,t.textureIsSignedDistanceField=e.textureIsSignedDistanceField,t.outlineColor=e.outlineColor,t.outlineSize=e.outlineSize,t.vvSizeEnabled=e.vvSizeEnabled,t.vvSizeMinSize=e.vvSizeMinSize,t.vvSizeMaxSize=e.vvSizeMaxSize,t.vvSizeOffset=e.vvSizeOffset,t.vvSizeFactor=e.vvSizeFactor,t.vvColorEnabled=e.vvColorEnabled,t.vvColorValues=e.vvColorValues,t.vvColorColors=e.vvColorColors,this.updateTexture(e.textureId),this.selectProgram(),this.selectSlot()},t.prototype.bindRender=function(e,t){var r=this.params,i=this.getProgram();this.bindTexture(e,i),i.setUniform1i("hudVisibilityTexture",1),e.bindTexture(t.hudVisibilityTexture,1),e.setActiveTexture(0),i.setUniform4fv("overrideColor",r.color),i.setUniform1f("pixelRatio",t.pixelRatio),r.textureIsSignedDistanceField&&(i.setUniform4fv("outlineColor",r.outlineColor),i.setUniform1f("outlineSize",r.outlineSize)),r.vvSizeEnabled&&(i.setUniform3fv("vvSizeMinSize",r.vvSizeMinSize),i.setUniform3fv("vvSizeMaxSize",r.vvSizeMaxSize),i.setUniform3fv("vvSizeOffset",r.vvSizeOffset),i.setUniform3fv("vvSizeFactor",r.vvSizeFactor)),r.vvColorEnabled&&(i.setUniform1fv("vvColorValues",r.vvColorValues),i.setUniform4fv("vvColorColors",r.vvColorColors)),i.setUniform2fv("texScale",r.texCoordScale),i.setUniform2f("screenOffset",2*r.screenOffset[0],2*r.screenOffset[1]),i.setUniform2fv("anchorPos",m(r)),r.polygonOffset&&(e.setPolygonOffsetFillEnabled(!0),e.setPolygonOffset(0,-4)),e.setBlendingEnabled(!0),e.setBlendFunction(1,771)},t.prototype.bindProjection=function(e,t){this.material._textureDirty&&(this.renderTexture(e),this.material._textureDirty=!1);var r=t.cameraAboveGround?1:-1,i=this.getProgram(),o=this.params;e.bindProgram(i),i.setUniform1f("cameraGroundRelative",r),i.setUniform1f("polygonOffset",o.shaderPolygonOffset),i.setUniform4fv("viewport",t.viewport),n.bindVerticalOffset(o.verticalOffset,t,i),i.setUniformMatrix4fv("viewNormal",t.viewInvTransp),o.screenSizePerspective&&(n.bindScreenSizePerspective(o.screenSizePerspective,i,"screenSizePerspective"),n.bindScreenSizePerspective(o.screenSizePerspectiveAlignment||o.screenSizePerspective,i,"screenSizePerspectiveAlignment"))},t.prototype.releaseRender=function(e){e.setPolygonOffsetFillEnabled(!1),e.setBlendFunction(770,771),e.setBlendingEnabled(!1)},t.prototype.bindView=function(e,t){var r=t.origin,i=this.getProgram();n.bindView(r,t.view,i),n.bindCamPos(r,t.viewInvTransp,i)},t.prototype.bindInstance=function(e,t){var r=this.getProgram();r.setUniformMatrix4fv("model",t.transformation),r.setUniformMatrix4fv("modelNormal",t.transformationNormal)},t.prototype.getDrawMode=function(e){var t=e.gl;return t.TRIANGLES},t}(l.GLMaterialTextureBase),R=function(e){function t(t,r,i){var n=e.call(this,t,r,i)||this;return n.isOcclusionSlot=!1,n}return r(t,e),t.prototype.selectProgram=function(){var e=this.params;this.programOcclusionTestPixel=this.programRep.getShaderVariationsProgram(b,[!!e.verticalOffset,!!e.screenSizePerspective,"screen"===e.centerOffsetUnits]),this.program=this.programRep.getShaderVariationsProgram(y,[e.occlusionTest,e.textureIsSignedDistanceField,!!e.vvSizeEnabled,!!e.vvColorEnabled,!!e.verticalOffset,!!e.screenSizePerspective,"screen"===e.centerOffsetUnits,!!e.debugDrawBorder])},t.prototype.getDrawMode=function(e){var t=e.gl;return this.isOcclusionSlot?t.POINTS:t.TRIANGLES},t.prototype.release=function(e){var t=e.gl;e.setDepthFunction(t.LESS),this.isOcclusionSlot||this.releaseRender(e)},t.prototype.bind=function(e,t){var r=e.gl;this.bindProjection(e,t);var i=this.getProgram();e.setDepthFunction(r.LEQUAL),this.isOcclusionSlot?i.setUniform4f("color",1,1,1,1):(this.bindRender(e,t),this.bindTexture(e,i))},t.prototype.getProgram=function(){return this.isOcclusionSlot?this.programOcclusionTestPixel:this.program},t.prototype.getAllPrograms=function(){return[this.programOcclusionTestPixel,this.program]},t.prototype.beginSlot=function(e){return this.params.occlusionTest?(this.isOcclusionSlot=e===f.OCCLUSION_PIXELS,e===f.OCCLUSION_PIXELS||e===this.mainSlot):(this.isOcclusionSlot=!1,e===this.mainSlot)},t}(T),M=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r(t,e),t.prototype.selectProgram=function(){var e=this.params;this.program=this.programRep.getShaderVariationsProgram(V,[e.occlusionTest,e.textureIsSignedDistanceField,!!e.vvSizeEnabled,!!e.vvColorEnabled,!!e.verticalOffset,!!e.screenSizePerspective,"screen"===e.centerOffsetUnits,e.binaryHighlightOcclusion])},t.prototype.bind=function(e,t){this.bindProjection(e,t),this.bindRender(e,t)},t.prototype.release=function(e){this.releaseRender(e)},t}(T),F={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},scaleAlignment:0,minPixelSizeAlignment:0},L=[0,0],w=P.create(),B=P.create(),_=P.create(),N=P.create(),H=P.create(),G=A.create(),X=O.create(),Z={normal:N,cosAngle:0},j=O.create();O.identity(j);var q=1,Q=[0,0],W=[0,0,1];return D});