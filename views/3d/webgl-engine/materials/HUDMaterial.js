// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../core/mathUtils","../../../../core/maybe","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/mat3","../../../../core/libs/gl-matrix-2/mat3f64","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec2","../../../../core/libs/gl-matrix-2/vec2f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../core/libs/gl-matrix-2/types/mat4","../../../../geometry/support/aaBoundingRect","../../support/buffer/InterleavedLayout","../lib/geometryDataUtils","../lib/GLMaterialTexture","../lib/Material","../lib/screenSizePerspectiveUtils","../lib/Util","./internal/bufferWriterUtils","./internal/MaterialUtil","./renderers/utils","../shaders/HUDMaterial.glsl","../shaders/HUDMaterialTechnique"],(function(e,t,r,i,a,n,s,o,c,l,f,u,p,h,d,v,m,g,x,A,S,y,O,C,P,V,b){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var q=function(e){function t(t,r){var i=e.call(this,r)||this;return i.techniqueConfig=new b.HUDMaterialTechniqueConfiguration,i.params=C.copyParameters(t,J),i}return r.__extends(t,e),t.prototype.setParameterValues=function(e){for(var t in e)"textureId"===t&&y.assert(!!this.params.textureId,"Can only change texture of material that already has a texture"),this.params[t]=e[t];this.parametersChanged()},t.prototype.getParameters=function(){return this.params},t.prototype.getTechniqueConfig=function(e){return this.techniqueConfig.output=e,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.verticalOffset=!!this.params.verticalOffset,this.techniqueConfig.screenSizePerspective=!!this.params.screenSizePerspective,this.techniqueConfig.screenCenterOffsetUnitsEnabled="screen"===this.params.centerOffsetUnits?1:0,this.techniqueConfig.polygonOffsetEnabled=this.params.polygonOffset,this.techniqueConfig.occlusionTestEnabled=this.params.occlusionTest,this.techniqueConfig.sdf=this.params.textureIsSignedDistanceField,this.techniqueConfig.vvSize=!!this.params.vvSizeEnabled,this.techniqueConfig.vvColor=!!this.params.vvColorEnabled,0===e&&(this.techniqueConfig.debugDrawBorder=!!this.params.debugDrawBorder),4===e&&(this.techniqueConfig.binaryHighlightOcclusion=this.params.binaryHighlightOcclusion),this.techniqueConfig.depthEnabled=this.params.depthEnabled,this.techniqueConfig},t.prototype.intersect=function(e,t,r,i,a,n,s,o,c){c?this.intersectDrapedHudGeometry(e,n,s,o):this.intersectHudGeometry(e,t,r,i,s,o)},t.prototype.intersectDrapedHudGeometry=function(e,t,r,i){var a=e.getAttribute(y.VertexAttrConstants.POSITION),n=e.getAttribute(y.VertexAttrConstants.SIZE),s=this.params,o=V.calculateAnchorPosForRendering(s),c=1,l=1;if(i){var f=i(X);c=f[0],l=f[5]}c*=e.screenToWorldRatio,l*=e.screenToWorldRatio;for(var u=Z*e.screenToWorldRatio,p=0;p<a.data.length/a.size;p++){var h=p*a.size,d=a.data[h],v=a.data[h+1],m=p*n.size;j[0]=n.data[m]*c,j[1]=n.data[m+1]*l;var g=void 0;s.textureIsSignedDistanceField&&(g=s.outlineSize*e.screenToWorldRatio/2),M(t,d,v,j,u,g,s,o)&&r()}},t.prototype.intersectHudGeometry=function(e,t,r,i,a,n){if(i.options.selectionMode&&i.options.hud&&!P.isInstanceHidden(t)){var o,l,f,u,d,v,m,g,x,A,O,C,b,q=e.data,z=this.params,T=1,I=1;if(s.mat3.fromMat4(B,r),n){var U=n(X);T=U[0],I=U[5],l=(o=B)[0],f=o[1],u=o[2],d=o[3],v=o[4],m=o[5],g=o[6],x=o[7],A=o[8],O=1/Math.sqrt(l*l+f*f+u*u),C=1/Math.sqrt(d*d+v*v+m*m),b=1/Math.sqrt(g*g+x*x+A*A),o[0]=l*O,o[1]=f*O,o[2]=u*O,o[3]=d*C,o[4]=v*C,o[5]=m*C,o[6]=g*b,o[7]=x*b,o[8]=A*b}var E=q.getVertexAttr()[y.VertexAttrConstants.POSITION],H=q.getVertexAttr()[y.VertexAttrConstants.SIZE],Z=q.getVertexAttr()[y.VertexAttrConstants.NORMAL],k=q.getVertexAttr()[y.VertexAttrConstants.AUXPOS1];y.assert(E.size>=3);var J=i.point,K=i.camera,Q=V.calculateAnchorPosForRendering(z);T*=K.pixelRatio,I*=K.pixelRatio;for(var Y="screen"===this.params.centerOffsetUnits,$=0;$<E.data.length/E.size;$++){var ee=$*E.size;p.vec3.set(R,E.data[ee],E.data[ee+1],E.data[ee+2]),p.vec3.transformMat4(R,R,r);var te=$*H.size;j[0]=H.data[te]*T,j[1]=H.data[te+1]*I,p.vec3.transformMat4(R,R,K.viewMatrix);var re=$*k.size;if(p.vec3.set(L,k.data[re+0],k.data[re+1],k.data[re+2]),!Y&&(R[0]+=L[0],R[1]+=L[1],0!==L[2])){var ie=L[2];p.vec3.normalize(L,R),p.vec3.subtract(R,R,p.vec3.scale(L,L,ie))}var ae=$*Z.size;if(p.vec3.set(D,Z.data[ae],Z.data[ae+1],Z.data[ae+2]),this.normalAndViewAngle(D,B,K,G),this.applyVerticalOffsetTransformationView(R,G,K,w),K.applyProjection(R,_),_[0]>-1){var ne=Math.floor(_[0])+this.params.screenOffset[0],se=Math.floor(_[1])+this.params.screenOffset[1];Y&&(ne+=L[0],0!==L[1]&&(se+=S.applyScaleFactor(L[1],w.factorAlignment))),S.applyPrecomputedScaleFactor(j,w.factor,j);var oe=W*K.pixelRatio,ce=void 0;if(z.textureIsSignedDistanceField&&(ce=z.outlineSize*K.pixelRatio/2),M(J,ne,se,j,oe,ce,z,Q)){var le=i.ray;p.vec3.transformMat4(N,R,c.mat4.invert(F,K.viewMatrix)),_[0]=J[0],_[1]=J[1],K.unprojectPoint(_,R);var fe=h.vec3f64.create();p.vec3.copy(fe,le.direction);var ue=1/p.vec3.length(fe);p.vec3.scale(fe,fe,ue),a(p.vec3.distance(le.origin,R)*ue,fe,-1,1,!0,N)}}}}},t.prototype.computeAttachmentOrigin=function(e,t){var r=e.data,i="getVertexAttr"in r?r.getVertexAttr():"vertexAttr"in r?r.vertexAttr:null;if(!i)return null;var a=y.VertexAttrConstants.POSITION,n=i[a],s="getIndices"in r?r.getIndices(a):"indices"in r?r.indices[a]:null;return g.computeAttachmentOriginPoints(n,s,t)},t.prototype.createBufferWriter=function(){return new Q(this)},t.prototype.normalAndViewAngle=function(e,t,r,i){return d.isMat4(t)&&(t=s.mat3.fromMat4(H,t)),p.vec3.transformMat3(i.normal,e,t),p.vec3.transformMat4(i.normal,i.normal,r.viewInverseTransposeMatrix),i.cosAngle=p.vec3.dot(E,k),i},t.prototype.updateScaleInfo=function(e,t,r){var i=this.params;i.screenSizePerspective?S.precomputeScaleFactor(r,t,i.screenSizePerspective,e.factor):(e.factor.scale=1,e.factor.factor=0,e.factor.minPixelSize=0,e.factor.paddingPixels=0),i.screenSizePerspectiveAlignment?S.precomputeScaleFactor(r,t,i.screenSizePerspectiveAlignment,e.factorAlignment):(e.factorAlignment.factor=e.factor.factor,e.factorAlignment.scale=e.factor.scale,e.factorAlignment.minPixelSize=e.factor.minPixelSize,e.factorAlignment.paddingPixels=e.factor.paddingPixels)},t.prototype.applyShaderOffsetsView=function(e,t,r,i,a,n,s){var o=this.normalAndViewAngle(t,r,a,G);return this.applyVerticalGroundOffsetView(e,o,a,s),this.applyVerticalOffsetTransformationView(s,o,a,n),this.applyPolygonOffsetView(s,o,i[3],a,s),this.applyCenterOffsetView(s,i,s),s},t.prototype.applyShaderOffsetsNDC=function(e,t,r,i,n){return this.applyCenterOffsetNDC(e,t,r,i),a.isSome(n)&&p.vec3.copy(n,i),this.applyPolygonOffsetNDC(i,t,r,i),i},t.prototype.applyPolygonOffsetView=function(e,t,r,a,n){var s=a.aboveGround?1:-1,o=i.sign(r);0===o&&(o=s);var c=s*o;if(this.params.shaderPolygonOffset<=0)return p.vec3.copy(n,e);var l=i.clamp(Math.abs(t.cosAngle),.01,1),f=1-Math.sqrt(1-l*l)/l/a.viewport[2];return c>0?p.vec3.scale(n,e,f):p.vec3.scale(n,e,1/f),n},t.prototype.applyVerticalGroundOffsetView=function(e,t,r,i){var a=p.vec3.length(e),n=r.aboveGround?1:-1,s=.5*r.computeRenderPixelSizeAtDist(a),o=p.vec3.scale(R,t.normal,n*s);return p.vec3.add(i,e,o),i},t.prototype.applyVerticalOffsetTransformationView=function(e,t,r,i){var a=this.params;if(!a.verticalOffset||!a.verticalOffset.screenLength){if(a.screenSizePerspective||a.screenSizePerspectiveAlignment){var n=p.vec3.length(e);this.updateScaleInfo(i,n,t.cosAngle)}else i.factor.scale=1,i.factorAlignment.scale=1;return e}var s=p.vec3.length(e),o=a.screenSizePerspectiveAlignment||a.screenSizePerspective,c=C.verticalOffsetAtDistance(r,s,a.verticalOffset,t.cosAngle,o);return this.updateScaleInfo(i,s,t.cosAngle),p.vec3.scale(t.normal,t.normal,c),p.vec3.add(e,e,t.normal)},t.prototype.applyCenterOffsetView=function(e,t,r){var i="screen"!==this.params.centerOffsetUnits;return r!==e&&p.vec3.copy(r,e),i&&(r[0]+=t[0],r[1]+=t[1],t[2]&&(p.vec3.normalize(D,r),p.vec3.add(r,r,p.vec3.scale(D,D,t[2])))),r},t.prototype.applyCenterOffsetNDC=function(e,t,r,i){var a="screen"!==this.params.centerOffsetUnits;return i!==e&&p.vec3.copy(i,e),a||(i[0]+=t[0]/r.fullWidth*2,i[1]+=t[1]/r.fullHeight*2),i},t.prototype.applyPolygonOffsetNDC=function(e,t,r,a){var n=this.params.shaderPolygonOffset;if(e!==a&&p.vec3.copy(a,e),n){var s=r.aboveGround?1:-1,o=s*i.sign(t[3]);a[2]-=(o||s)*n}return a},t.prototype.getGLMaterial=function(e){return 0===e.output?new T(e):4===e.output?new I(e):void 0},t.prototype.calculateRelativeScreenBounds=function(e,t,r){return void 0===r&&(r=v.create()),function(e,t,r,i){void 0===i&&(i=U);f.vec2.copy(i,e.anchorPos),i[0]*=-t[0],i[1]*=-t[1],i[0]+=e.screenOffset[0]*r,i[1]+=e.screenOffset[1]*r}(this.params,e,t,r),r[2]=r[0]+e[0],r[3]=r[1]+e[1],r},t}(A.Material);t.default=q;var z=function(e){function t(t){var i=e.call(this,r.__assign(r.__assign({},t),t.material.getParameters()))||this;return i.updateParameters(),i}return r.__extends(t,e),t.prototype.beginSlot=function(e){return e===(this.params.drawInSecondSlot?19:18)},t.prototype.updateParameters=function(){this.params=C.copyParameters(this.material.getParameters()),this.updateTexture(this.params.textureId),this.selectProgram()},t.prototype.selectProgram=function(){this.technique=this.techniqueRep.acquireAndReleaseExisting(b.HUDMaterialTechnique,this.material.getTechniqueConfig(this.output),this.technique)},t.prototype.bind=function(e,t){e.bindProgram(this.technique.program),this.bindTexture(e,this.technique.program),this.bindTextureScale(e,this.technique.program),this.technique.bindPass(e,this.params,t)},t}(x),T=function(e){function t(t){var i=e.call(this,r.__assign(r.__assign({},t),{output:0}))||this;return i.isOcclusionSlot=!1,i}return r.__extends(t,e),t.prototype.beginSlot=function(e){var t=this.params.drawInSecondSlot?19:18;return this.params.occlusionTest?(this.isOcclusionSlot=12===e,12===e||e===t):(this.isOcclusionSlot=!1,e===t)},t.prototype.getTechnique=function(){return this.isOcclusionSlot?this.occlusionTechnique:this.technique},t.prototype.selectProgram=function(){this.technique=this.techniqueRep.acquireAndReleaseExisting(b.HUDMaterialTechnique,this.material.getTechniqueConfig(this.output),this.technique),this.occlusionTechnique=this.techniqueRep.acquireAndReleaseExisting(b.HUDMaterialTechnique,this.material.getTechniqueConfig(6),this.occlusionTechnique)},t.prototype.bind=function(e,t){var r=this.getTechnique();e.bindProgram(r.program),this.isOcclusionSlot||(this.bindTexture(e,r.program),this.bindTextureScale(e,r.program)),r.bindPass(e,this.params,t)},t}(z),I=function(e){function t(t){return e.call(this,r.__assign(r.__assign({},t),{output:4}))||this}return r.__extends(t,e),t}(z);function M(e,t,r,i,a,n,s,o){var c=t-a-(o[0]>0?i[0]*o[0]:0),l=c+i[0]+2*a,f=r-a-(o[1]>0?i[1]*o[1]:0),u=f+i[1]+2*a;if(s.textureIsSignedDistanceField){var p=s.distanceFieldBoundingBox;c+=i[0]*p[0],f+=i[1]*p[1],l-=i[0]*(1-p[2]),u-=i[1]*(1-p[3]),c-=n,l+=n,f-=n,u+=n}return e[0]>c&&e[0]<l&&e[1]>f&&e[1]<u}var w={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},factorAlignment:{scale:0,factor:0,minPixelSize:0,paddingPixels:0}},U=u.vec2f64.create(),R=h.vec3f64.create(),D=h.vec3f64.create(),_=n.createRenderScreenPointArray3(),E=h.vec3f64.create(),N=h.vec3f64.create(),B=o.mat3f64.create(),H=o.mat3f64.create(),F=l.mat4f64.create(),L=h.vec3f64.create(),G={normal:E,cosAngle:0},X=l.mat4f64.create(),W=1,Z=2,j=[0,0],k=h.vec3f64.fromValues(0,0,1),J={texCoordScale:[1,1],occlusionTest:!0,binaryHighlightOcclusion:!0,drawInSecondSlot:!1,color:[1,1,1,1],outlineColor:[1,1,1,1],outlineSize:0,textureIsSignedDistanceField:!1,distanceFieldBoundingBox:null,vvSizeEnabled:!1,vvSizeMinSize:[1,1,1],vvSizeMaxSize:[100,100,100],vvSizeOffset:[0,0,0],vvSizeFactor:[1,1,1],vvColorEnabled:!1,vvColorValues:[0,0,0,0,0,0,0,0],vvColorColors:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],screenOffset:[0,0],verticalOffset:null,screenSizePerspective:null,screenSizePerspectiveAlignment:null,slicePlaneEnabled:!1,anchorPos:u.vec2f64.fromValues(.5,.5),shaderPolygonOffset:1e-5,polygonOffset:!1,textureId:null,centerOffsetUnits:"world",depthEnabled:!0,debugDrawBorder:!1},K=m.newLayout().vec3f(y.VertexAttrConstants.POSITION).vec3f(y.VertexAttrConstants.NORMAL).vec2f(y.VertexAttrConstants.UV0).vec4u8(y.VertexAttrConstants.COLOR).vec2f(y.VertexAttrConstants.SIZE).vec4f(y.VertexAttrConstants.AUXPOS1).vec4f(y.VertexAttrConstants.AUXPOS2),Q=function(){function e(e){this.material=e,this.vertexBufferLayout=K}return e.prototype.allocate=function(e){return this.vertexBufferLayout.createBuffer(e)},e.prototype.elementCount=function(e){return 6*e.indices[y.VertexAttrConstants.POSITION].length},e.prototype.write=function(e,t,r,i){O.writePosition(t.indices[y.VertexAttrConstants.POSITION],t.vertexAttr[y.VertexAttrConstants.POSITION].data,e.transformation,r.position,i,6),O.writeNormal(t.indices[y.VertexAttrConstants.NORMAL],t.vertexAttr[y.VertexAttrConstants.NORMAL].data,e.invTranspTransformation,r.normal,i,6);var a=t.vertexAttr[y.VertexAttrConstants.UV0].data,n=void 0,s=void 0,o=void 0,c=void 0;if(null==a||a.length<4){var l=this.material.getParameters();n=0,s=0,o=l.texCoordScale[0],c=l.texCoordScale[1]}else n=a[0],s=a[1],o=a[2],c=a[3];o=Math.min(1.99999,o+1),c=Math.min(1.99999,c+1);for(var f=t.indices[y.VertexAttrConstants.POSITION].length,u=r.uv0,p=i,h=0;h<f;++h)u.set(p,0,n),u.set(p,1,s),p+=1,u.set(p,0,o),u.set(p,1,s),p+=1,u.set(p,0,o),u.set(p,1,c),p+=1,u.set(p,0,o),u.set(p,1,c),p+=1,u.set(p,0,n),u.set(p,1,c),p+=1,u.set(p,0,n),u.set(p,1,s),p+=1;O.writeColor(t.indices[y.VertexAttrConstants.COLOR],t.vertexAttr[y.VertexAttrConstants.COLOR].data,4,r.color,i,6);var d=t.indices[y.VertexAttrConstants.SIZE],v=t.vertexAttr[y.VertexAttrConstants.SIZE].data,m=d.length,g=r.size;for(p=i,h=0;h<m;++h)for(var x=v[2*d[h]],A=v[2*d[h]+1],S=0;S<6;++S)g.set(p,0,x),g.set(p,1,A),p+=1;t.indices[y.VertexAttrConstants.AUXPOS1]&&t.vertexAttr[y.VertexAttrConstants.AUXPOS1]&&O.writeBufferVec4(t.indices[y.VertexAttrConstants.AUXPOS1],t.vertexAttr[y.VertexAttrConstants.AUXPOS1].data,r.auxpos1,i,6),t.indices[y.VertexAttrConstants.AUXPOS2]&&t.vertexAttr[y.VertexAttrConstants.AUXPOS2]&&O.writeBufferVec4(t.indices[y.VertexAttrConstants.AUXPOS2],t.vertexAttr[y.VertexAttrConstants.AUXPOS2].data,r.auxpos2,i,6)},e}()}));