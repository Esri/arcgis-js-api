/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/vec3","../../../../chunks/vec3f64","../../support/buffer/InterleavedLayout","../core/shaderLibrary/ShaderOutputOptions","../lib/GLMaterials","../lib/GLMaterialTexture","../lib/Material","../lib/RenderSlot","../lib/VertexAttribute","./VisualVariableMaterialParameters","../shaders/LineMarkerTechnique"],(function(e,t,r,a,i,n,s,u,l,o,c,h,d){"use strict";let p=function(e){function r(t){var r;return(r=e.call(this,t,f)||this)._vertexAttributeLocations=d.markerVertexAttributeLocations,r.techniqueConfig=new d.LineMarkerTechniqueConfiguration,r.layout=r.createLayout(),r}t._inheritsLoose(r,e);var a=r.prototype;return a.dispose=function(){},a.getTechniqueConfig=function(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.draped=t.slot===o.RenderSlot.DRAPED_MATERIAL,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.sceneHasOcludees=this.parameters.sceneHasOcludees,this.techniqueConfig.transparent=this.parameters.transparent,this.techniqueConfig.writeDepth=this.parameters.writeDepth,this.techniqueConfig.vvColor=this.parameters.vvColorEnabled,this.techniqueConfig.vvOpacity=this.parameters.vvOpacityEnabled,this.techniqueConfig.vvSize=this.parameters.vvSizeEnabled,this.techniqueConfig.occluder=this.parameters.renderOccluded===l.RenderOccludedFlag.OccludeAndTransparentStencil,this.techniqueConfig.transparencyPassType=t.transparencyPassType,this.techniqueConfig.multipassTerrainEnabled=t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=t.cullAboveGround,this.techniqueConfig},a.intersect=function(){},a.createLayout=function(){const e=i.newLayout().vec3f(c.VertexAttribute.POSITION).vec2f(c.VertexAttribute.UV0).vec3f(c.VertexAttribute.AUXPOS1);return this.parameters.vvSizeEnabled?e.f32(c.VertexAttribute.SIZEFEATUREATTRIBUTE):e.f32(c.VertexAttribute.SIZE),this.parameters.vvColorEnabled?e.f32(c.VertexAttribute.COLORFEATUREATTRIBUTE):e.vec4f(c.VertexAttribute.COLOR),this.parameters.vvOpacityEnabled&&e.f32(c.VertexAttribute.OPACITYFEATUREATTRIBUTE),e},a.createBufferWriter=function(){return new E(this.layout,this.parameters)},a.requiresSlot=function(e,t){if(e===o.RenderSlot.DRAPED_MATERIAL)return!0;if(this.parameters.renderOccluded===l.RenderOccludedFlag.OccludeAndTransparentStencil)return e===o.RenderSlot.OPAQUE_MATERIAL||e===o.RenderSlot.OCCLUDER_MATERIAL||e===o.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL;const r=s.outputFromPass(t);if(r===n.ShaderOutput.Color||r===n.ShaderOutput.Alpha){return e===(this.parameters.writeDepth?o.RenderSlot.TRANSPARENT_MATERIAL:o.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL)}return e===o.RenderSlot.OPAQUE_MATERIAL},a.createGLMaterial=function(e){return e.output===n.ShaderOutput.Color||e.output===n.ShaderOutput.Alpha||e.output===n.ShaderOutput.Highlight||e.output===n.ShaderOutput.Depth?new A(e):null},a.validateParameters=function(e){e.color&&e.color[3]<1&&(e.transparent=!0)},r}(l.Material),A=function(e){function r(t){return e.call(this,{...t,...t.material.parameters})||this}t._inheritsLoose(r,e);var a=r.prototype;return a.updateParameters=function(e){return this.updateTexture(this._material.parameters.textureId),this.ensureTechnique(d.LineMarkerTechnique,e)},a._updateOccludeeState=function(e){e.hasOccludees!==this._material.parameters.sceneHasOcludees&&this._material.setParameters({sceneHasOcludees:e.hasOccludees})},a.beginSlot=function(e){return this._output!==n.ShaderOutput.Color&&this._output!==n.ShaderOutput.Alpha||this._updateOccludeeState(e),this.updateParameters(e)},a.bind=function(e,t){this.bindTextures(t.program),this.bindTextureScale(t.program),t.bindPass(this._material.parameters,e)},r}(u);const f={width:0,color:[1,1,1,1],placement:"end",textureId:null,writeDepth:!0,slicePlaneEnabled:!1,vvFastUpdate:!1,transparent:!1,sceneHasOcludees:!1,...l.DefaultMaterialParameters,...h.VisualVariableDefaultMaterialParameters};let E=function(){function e(e,t){this.vertexBufferLayout=e,this.parameters=t}var t=e.prototype;return t.allocate=function(e){return this.vertexBufferLayout.createBuffer(e)},t.elementCount=function(){return"begin-end"===this.parameters.placement?12:6},t.write=function(e,t,a,i){const n=t.vertexAttributes.get(c.VertexAttribute.POSITION).data,s=n.length/3;let u=1,l=0;this.parameters.vvSizeEnabled?l=t.vertexAttributes.get(c.VertexAttribute.SIZEFEATUREATTRIBUTE).data[0]:t.vertexAttributes.has(c.VertexAttribute.SIZE)&&(u=t.vertexAttributes.get(c.VertexAttribute.SIZE).data[0]);let o=[1,1,1,1],h=0;this.parameters.vvColorEnabled?h=t.vertexAttributes.get(c.VertexAttribute.COLORFEATUREATTRIBUTE).data[0]:t.vertexAttributes.has(c.VertexAttribute.COLOR)&&(o=t.vertexAttributes.get(c.VertexAttribute.COLOR).data);let d=0;this.parameters.vvOpacityEnabled&&(d=t.vertexAttributes.get(c.VertexAttribute.OPACITYFEATUREATTRIBUTE).data[0]);const p=e.transformation,A=new Float32Array(a.buffer);let f=i*(this.vertexBufferLayout.stride/4);const E=(e,t,r,a)=>{if(A[f++]=e[0],A[f++]=e[1],A[f++]=e[2],A[f++]=r[0],A[f++]=r[1],A[f++]=t[0],A[f++]=t[1],A[f++]=t[2],this.parameters.vvSizeEnabled?A[f++]=l:A[f++]=u,this.parameters.vvColorEnabled)A[f++]=h;else{const e=Math.min(4*a,o.length-4);A[f++]=o[e+0],A[f++]=o[e+1],A[f++]=o[e+2],A[f++]=o[e+3]}this.parameters.vvOpacityEnabled&&(A[f++]=d)};let T;!function(e){e[e.ASCENDING=1]="ASCENDING",e[e.DESCENDING=-1]="DESCENDING"}(T||(T={}));const m=(e,t)=>{const a=r.set(b,n[3*e],n[3*e+1],n[3*e+2]),i=v;let u=e+t;do{r.set(i,n[3*u],n[3*u+1],n[3*u+2]),u+=t}while(r.equals(a,i)&&u>=0&&u<s);p&&(r.transformMat4(a,a,p),r.transformMat4(i,i,p)),E(a,i,[-1,-1],e),E(a,i,[1,-1],e),E(a,i,[1,1],e),E(a,i,[-1,-1],e),E(a,i,[1,1],e),E(a,i,[-1,1],e)},O=this.parameters.placement;"begin"!==O&&"begin-end"!==O||m(0,T.ASCENDING),"end"!==O&&"begin-end"!==O||m(s-1,T.DESCENDING)},e}();const b=a.create(),v=a.create();e.LineMarkerMaterial=p,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
