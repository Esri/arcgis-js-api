/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{s as e,z as t,m as r}from"../../../../chunks/vec3.js";import{c as s}from"../../../../chunks/vec3f64.js";import{newLayout as a}from"../../support/buffer/InterleavedLayout.js";import{ShaderOutput as i}from"../core/shaderLibrary/ShaderOutputOptions.js";import{outputFromPass as n}from"../lib/GLMaterials.js";import{GLTextureMaterial as h}from"../lib/GLTextureMaterial.js";import{Material as o,RenderOccludedFlag as u}from"../lib/Material.js";import{RenderSlot as c}from"../lib/RenderSlot.js";import{VertexAttribute as l}from"../lib/VertexAttribute.js";import{VisualVariablePassParameters as p}from"./VisualVariablePassParameters.js";import{markerVertexAttributeLocations as d,LineMarkerTechnique as m}from"../shaders/LineMarkerTechnique.js";import{LineMarkerTechniqueConfiguration as E}from"../shaders/LineMarkerTechniqueConfiguration.js";import{CapType as A}from"../shaders/RibbonLineTechniqueConfiguration.js";class T extends o{constructor(e){super(e,new v),this._vertexAttributeLocations=d,this.techniqueConfig=new E,this.layout=this.createLayout()}dispose(){}getConfiguration(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.draped=t.slot===c.DRAPED_MATERIAL,this.techniqueConfig.hasCap=this.parameters.cap!==A.BUTT,this.techniqueConfig.hasSlicePlane=this.parameters.hasSlicePlane,this.techniqueConfig.hasOccludees=this.parameters.hasOccludees,this.techniqueConfig.writeDepth=this.parameters.writeDepth,this.techniqueConfig.vvColor=this.parameters.vvColorEnabled,this.techniqueConfig.vvOpacity=this.parameters.vvOpacityEnabled,this.techniqueConfig.vvSize=this.parameters.vvSizeEnabled,this.techniqueConfig.occluder=this.parameters.renderOccluded===u.OccludeAndTransparentStencil,this.techniqueConfig.transparencyPassType=t.transparencyPassType,this.techniqueConfig.hasMultipassTerrain=t.multipassTerrain.enabled,this.techniqueConfig.cullAboveGround=t.multipassTerrain.cullAboveGround,this.techniqueConfig}intersect(){}createLayout(){const e=a().vec3f(l.POSITION).vec2f(l.UV0).vec3f(l.AUXPOS1);return this.parameters.vvSizeEnabled?e.f32(l.SIZEFEATUREATTRIBUTE):e.f32(l.SIZE),this.parameters.vvColorEnabled?e.f32(l.COLORFEATUREATTRIBUTE):e.vec4f(l.COLOR),this.parameters.vvOpacityEnabled&&e.f32(l.OPACITYFEATUREATTRIBUTE),e}createBufferWriter(){return new C(this.layout,this.parameters)}requiresSlot(e,t){if(e===c.DRAPED_MATERIAL)return!0;if(this.parameters.renderOccluded===u.OccludeAndTransparentStencil)return e===c.OPAQUE_MATERIAL||e===c.OCCLUDER_MATERIAL||e===c.TRANSPARENT_OCCLUDER_MATERIAL;const r=n(t);if(r===i.Color||r===i.Alpha){return e===(this.parameters.writeDepth?c.TRANSPARENT_MATERIAL:c.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL)}return e===c.OPAQUE_MATERIAL}createGLMaterial(e){return e.output===i.Color||e.output===i.Alpha||e.output===i.Highlight||e.output===i.Depth?new f(e):null}}class f extends h{_updateParameters(e){return this.updateTexture(this._material.parameters.textureId),this._material.setParameters(this.textureBindParameters),this.ensureTechnique(m,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){return this._output!==i.Color&&this._output!==i.Alpha||this._updateOccludeeState(e),this._updateParameters(e)}}class v extends p{constructor(){super(...arguments),this.width=0,this.color=[1,1,1,1],this.placement="end",this.cap=A.BUTT,this.writeDepth=!0,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.hasOccludees=!1}}class C{constructor(e,t){this.vertexBufferLayout=e,this.parameters=t}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(){return"begin-end"===this.parameters.placement?12:6}write(s,a,i,n){const h=a.vertexAttributes.get(l.POSITION).data,o=h.length/3;let u=1,c=0;this.parameters.vvSizeEnabled?c=a.vertexAttributes.get(l.SIZEFEATUREATTRIBUTE).data[0]:a.vertexAttributes.has(l.SIZE)&&(u=a.vertexAttributes.get(l.SIZE).data[0]);let p=[1,1,1,1],d=0;this.parameters.vvColorEnabled?d=a.vertexAttributes.get(l.COLORFEATUREATTRIBUTE).data[0]:a.vertexAttributes.has(l.COLOR)&&(p=a.vertexAttributes.get(l.COLOR).data);let m=0;this.parameters.vvOpacityEnabled&&(m=a.vertexAttributes.get(l.OPACITYFEATUREATTRIBUTE).data[0]);const E=s.transformation,A=new Float32Array(i.buffer);let T=n*(this.vertexBufferLayout.stride/4);const f=(e,t,r,s)=>{if(A[T++]=e[0],A[T++]=e[1],A[T++]=e[2],A[T++]=r[0],A[T++]=r[1],A[T++]=t[0],A[T++]=t[1],A[T++]=t[2],this.parameters.vvSizeEnabled?A[T++]=c:A[T++]=u,this.parameters.vvColorEnabled)A[T++]=d;else{const e=Math.min(4*s,p.length-4);A[T++]=p[e+0],A[T++]=p[e+1],A[T++]=p[e+2],A[T++]=p[e+3]}this.parameters.vvOpacityEnabled&&(A[T++]=m)};let v;!function(e){e[e.ASCENDING=1]="ASCENDING",e[e.DESCENDING=-1]="DESCENDING"}(v||(v={}));const C=(s,a)=>{const i=e(b,h[3*s],h[3*s+1],h[3*s+2]),n=O;let u=s+a;do{e(n,h[3*u],h[3*u+1],h[3*u+2]),u+=a}while(t(i,n)&&u>=0&&u<o);E&&(r(i,i,E),r(n,n,E)),f(i,n,[-1,-1],s),f(i,n,[1,-1],s),f(i,n,[1,1],s),f(i,n,[-1,-1],s),f(i,n,[1,1],s),f(i,n,[-1,1],s)},R=this.parameters.placement;"begin"!==R&&"begin-end"!==R||C(0,v.ASCENDING),"end"!==R&&"begin-end"!==R||C(o-1,v.DESCENDING)}}const b=s(),O=s();export{T as LineMarkerMaterial,v as Parameters};
