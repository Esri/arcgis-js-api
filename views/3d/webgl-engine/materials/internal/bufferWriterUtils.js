// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","../../../support/buffer/BufferView","../../lib/Util"],(function(e,r,t,f){"use strict";function a(e,r,t,f,a){var i=t.typedBuffer,s=t.typedBufferStride,o=e.length;if(f*=s,null==a||1===a)for(var u=0;u<o;++u){var n=2*e[u];i[f]=r[n],i[f+1]=r[n+1],f+=s}else for(u=0;u<o;++u){n=2*e[u];for(var l=0;l<a;++l)i[f]=r[n],i[f+1]=r[n+1],f+=s}}function i(e,r,t,f,a){var i=t.typedBuffer,s=t.typedBufferStride,o=e.length;if(f*=s,null==a||1===a)for(var u=0;u<o;++u){var n=3*e[u];i[f]=r[n],i[f+1]=r[n+1],i[f+2]=r[n+2],f+=s}else for(u=0;u<o;++u){n=3*e[u];for(var l=0;l<a;++l)i[f]=r[n],i[f+1]=r[n+1],i[f+2]=r[n+2],f+=s}}function s(e,r,t,f,a){var i=t.typedBuffer,s=t.typedBufferStride,o=e.length;if(f*=s,null==a||1===a)for(var u=0;u<o;++u){var n=4*e[u];i[f]=r[n],i[f+1]=r[n+1],i[f+2]=r[n+2],i[f+3]=r[n+3],f+=s}else for(u=0;u<o;++u){n=4*e[u];for(var l=0;l<a;++l)i[f]=r[n],i[f+1]=r[n+1],i[f+2]=r[n+2],i[f+3]=r[n+3],f+=s}}function o(e,r,t,f,a,s){if(t){var o=t,u=f.typedBuffer,n=f.typedBufferStride,l=e.length;if(a*=n,null==s||1===s)for(var d=0;d<l;++d){var v=r[V=3*e[d]],B=r[V+1],c=r[V+2];u[a]=o[0]*v+o[4]*B+o[8]*c+o[12],u[a+1]=o[1]*v+o[5]*B+o[9]*c+o[13],u[a+2]=o[2]*v+o[6]*B+o[10]*c+o[14],a+=n}else for(d=0;d<l;++d){v=r[V=3*e[d]],B=r[V+1],c=r[V+2];for(var V,w=o[0]*v+o[4]*B+o[8]*c+o[12],p=o[1]*v+o[5]*B+o[9]*c+o[13],g=o[2]*v+o[6]*B+o[10]*c+o[14],y=0;y<s;++y)u[a]=w,u[a+1]=p,u[a+2]=g,a+=n}}else i(e,r,f,a,s)}function u(e,r,t,f,a,s){if(t){var o=t,u=f.typedBuffer,n=f.typedBufferStride,l=e.length,d=o[0],v=o[1],B=o[2],c=o[4],V=o[5],w=o[6],p=o[8],g=o[9],y=o[10],A=Math.abs(1-d*d+c*c+p*p)>1e-5||Math.abs(1-v*v+V*V+g*g)>1e-5||Math.abs(1-B*B+w*w+y*y)>1e-5;if(a*=n,null==s||1===s)for(var C=0;C<l;++C){var b=d*(x=r[O=3*e[C]])+c*(z=r[O+1])+p*(S=r[O+2]),h=v*x+V*z+g*S,M=B*x+w*z+y*S;if(A)if((N=b*b+h*h+M*M)<1-1e-6&&N>1e-6)b/=F=Math.sqrt(N),h/=F,M/=F;u[a+0]=b,u[a+1]=h,u[a+2]=M,a+=n}else for(C=0;C<l;++C){var O,x,z,S,N,F,k=d*(x=r[O=3*e[C]])+c*(z=r[O+1])+p*(S=r[O+2]),P=v*x+V*z+g*S,U=B*x+w*z+y*S;if(A)if((N=k*k+P*P+U*U)<1-1e-6&&N>1e-6)k/=F=Math.sqrt(N),P/=F,U/=F;for(var D=0;D<s;++D)u[a+0]=k,u[a+1]=P,u[a+2]=U,a+=n}}else i(e,r,f,a,s)}function n(e,r,t,f,a,i){var s=f.typedBuffer,o=f.typedBufferStride,u=e.length;if(a*=o,null==i||1===i){if(4===t)for(var n=0;n<u;++n){var l=4*e[n];s[a]=r[l],s[a+1]=r[l+1],s[a+2]=r[l+2],s[a+3]=r[l+3],a+=o}else if(3===t)for(n=0;n<u;++n){l=3*e[n];s[a]=r[l],s[a+1]=r[l+1],s[a+2]=r[l+2],s[a+3]=255,a+=o}}else if(4===t)for(n=0;n<u;++n){l=4*e[n];for(var d=0;d<i;++d)s[a]=r[l],s[a+1]=r[l+1],s[a+2]=r[l+2],s[a+3]=r[l+3],a+=o}else if(3===t)for(n=0;n<u;++n)for(l=3*e[n],d=0;d<i;++d)s[a]=r[l],s[a+1]=r[l+1],s[a+2]=r[l+2],s[a+3]=255,a+=o}Object.defineProperty(r,"__esModule",{value:!0}),r.writeDefaultAttributes=r.writeMultipliedColor=r.writeColor=r.writeNormal=r.writePosition=r.writeBufferMat4f=r.writeBufferMat3f=r.writeBufferVec4=r.writeBufferVec3=r.writeBufferVec2=void 0,r.writeBufferVec2=a,r.writeBufferVec3=i,r.writeBufferVec4=s,r.writeBufferMat3f=function(e,r,t,f){var a=t.typedBuffer,i=t.typedBufferStride,s=e.length;f*=i;for(var o=0;o<s;++o){for(var u=9*e[o],n=0;n<9;++n)a[f+n]=r[u+n];f+=i}},r.writeBufferMat4f=function(e,r,t,f){var a=t.typedBuffer,i=t.typedBufferStride,s=e.length;f*=i;for(var o=0;o<s;++o){for(var u=16*e[o],n=0;n<16;++n)a[f+n]=r[u+n];f+=i}},r.writePosition=o,r.writeNormal=u,r.writeColor=n,r.writeMultipliedColor=function(e,r,t,f,a,i,s){var o=a.typedBuffer,u=a.typedBufferStride,n=e.length;if(i*=u,null==s||1===s){if(4===t)for(var l=0;l<n;++l){var d=4*e[l];o[i]=r[d]*f[0],o[i+1]=r[d+1]*f[1],o[i+2]=r[d+2]*f[2],o[i+3]=r[d+3]*f[3],i+=u}else if(3===t){var v=255*f[3];for(l=0;l<n;++l){d=3*e[l];o[i]=r[d]*f[0],o[i+1]=r[d+1]*f[1],o[i+2]=r[d+2]*f[2],o[i+3]=v,i+=u}}}else if(4===t)for(l=0;l<n;++l){d=4*e[l];for(var B=0;B<s;++B)o[i]=r[d]*f[0],o[i+1]=r[d+1]*f[1],o[i+2]=r[d+2]*f[2],o[i+3]=r[d+3]*f[3],i+=u}else if(3===t)for(v=255*f[3],l=0;l<n;++l)for(d=3*e[l],B=0;B<s;++B)o[i]=r[d]*f[0],o[i+1]=r[d+1]*f[1],o[i+2]=r[d+2]*f[2],o[i+3]=v,i+=u},r.writeDefaultAttributes=function(e,r,i,l,d,v){for(var B=0,c=r.fieldNames;B<c.length;B++){var V=c[B],w=e.vertexAttr[V],p=e.indices[V];if(w&&p)switch(V){case f.VertexAttrConstants.POSITION:f.assert(3===w.size);var g=d.getField(V,t.BufferViewVec3f);g&&o(p,w.data,i,g,v);break;case f.VertexAttrConstants.NORMAL:f.assert(3===w.size);var y=d.getField(V,t.BufferViewVec3f);y&&u(p,w.data,l,y,v);break;case f.VertexAttrConstants.UV0:f.assert(2===w.size);var A=d.getField(V,t.BufferViewVec2f);A&&a(p,w.data,A,v);break;case f.VertexAttrConstants.UVMAPSPACE:f.assert(4===w.size);var C=d.getField(V,t.BufferViewVec4f);C&&s(p,w.data,C,v);break;case f.VertexAttrConstants.MEANVERTEXPOSITION:f.assert(3===w.size);var b=d.getField(V,t.BufferViewVec3f);b&&o(p,w.data,i,b,v);break;case f.VertexAttrConstants.BOUND1:case f.VertexAttrConstants.BOUND2:case f.VertexAttrConstants.BOUND3:f.assert(3===w.size);var h=d.getField(V,t.BufferViewVec3f);h&&o(p,w.data,i,h,v);break;case f.VertexAttrConstants.COLOR:f.assert(3===w.size||4===w.size);var M=d.getField(V,t.BufferViewVec4u8);M&&n(p,w.data,w.size,M,v);break;case f.VertexAttrConstants.SYMBOLCOLOR:f.assert(3===w.size||4===w.size);var O=d.getField(V,t.BufferViewVec4u8);O&&n(p,w.data,w.size,O,v);break;case f.VertexAttrConstants.TANGENT:f.assert(4===w.size);var x=d.getField(V,t.BufferViewVec4f);x&&s(p,w.data,x,v)}}}}));