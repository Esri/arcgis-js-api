/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../../core/maybe","../../../../../chunks/mat4","../../../../../geometry/support/buffer/BufferView","../../lib/Util","../../lib/VertexAttribute"],(function(e,t,r,f,o,i){"use strict";function s(e,t,r,f,o=1){const i=r.typedBuffer,s=r.typedBufferStride,n=e.length;if(f*=s,1===o)for(let c=0;c<n;++c)i[f]=t[e[c]],f+=s;else for(let c=0;c<n;++c){const r=t[e[c]];for(let e=0;e<o;e++)i[f]=r,f+=s}}function n(e,t,r,f){const o=r.typedBuffer,i=r.typedBufferStride,s=e.length;f*=i;for(let n=0;n<s;++n){const r=2*e[n];o[f]=t[r],o[f+1]=t[r+1],f+=i}}function c(e,t,r,f,o){const i=r.typedBuffer,s=r.typedBufferStride,n=e.length;if(f*=s,null==o||1===o)for(let c=0;c<n;++c){const r=3*e[c];i[f]=t[r],i[f+1]=t[r+1],i[f+2]=t[r+2],f+=s}else for(let c=0;c<n;++c){const r=3*e[c];for(let e=0;e<o;++e)i[f]=t[r],i[f+1]=t[r+1],i[f+2]=t[r+2],f+=s}}function u(e,t,r,f,o=1){const i=r.typedBuffer,s=r.typedBufferStride,n=e.length;if(f*=s,1===o)for(let c=0;c<n;++c){const r=4*e[c];i[f]=t[r],i[f+1]=t[r+1],i[f+2]=t[r+2],i[f+3]=t[r+3],f+=s}else for(let c=0;c<n;++c){const r=4*e[c];for(let e=0;e<o;++e)i[f]=t[r],i[f+1]=t[r+1],i[f+2]=t[r+2],i[f+3]=t[r+3],f+=s}}function l(e,t,r){const f=e.typedBuffer,o=e.typedBufferStride;t*=o;for(let i=0;i<r;++i)f[t]=0,f[t+1]=0,f[t+2]=0,f[t+3]=0,t+=o}function d(e,t,r,f){const o=r.typedBuffer,i=r.typedBufferStride,s=e.length;f*=i;for(let n=0;n<s;++n){const r=9*e[n];for(let e=0;e<9;++e)o[f+e]=t[r+e];f+=i}}function a(e,t,r,f){const o=r.typedBuffer,i=r.typedBufferStride,s=e.length;f*=i;for(let n=0;n<s;++n){const r=16*e[n];for(let e=0;e<16;++e)o[f+e]=t[r+e];f+=i}}function B(e,t,f,o,i,s=1){if(!f)return void c(e,t,o,i,s);const n=o.typedBuffer,u=o.typedBufferStride,l=e.length,d=f[0],a=f[1],B=f[2],b=f[4],y=f[5],V=f[6],w=f[8],p=f[9],A=f[10],g=f[12],h=f[13],O=f[14];i*=u;let N=0,S=0,x=0;const I=r.hasIdentityRotation(f)?e=>{N=t[e]+g,S=t[e+1]+h,x=t[e+2]+O}:e=>{const r=t[e],f=t[e+1],o=t[e+2];N=d*r+b*f+w*o+g,S=a*r+y*f+p*o+h,x=B*r+V*f+A*o+O};if(1===s)for(let r=0;r<l;++r)I(3*e[r]),n[i]=N,n[i+1]=S,n[i+2]=x,i+=u;else for(let r=0;r<l;++r){I(3*e[r]);for(let e=0;e<s;++e)n[i]=N,n[i+1]=S,n[i+2]=x,i+=u}}function b(e,t,f,o,i,s=1){if(!f)return void c(e,t,o,i,s);const n=f,u=o.typedBuffer,l=o.typedBufferStride,d=e.length,a=n[0],B=n[1],b=n[2],y=n[4],V=n[5],w=n[6],p=n[8],A=n[9],g=n[10],h=!r.isOrthoNormal(n),O=1e-6,N=1-O;i*=l;let S=0,x=0,I=0;const L=r.hasIdentityRotation(n)?e=>{S=t[e],x=t[e+1],I=t[e+2]}:e=>{const r=t[e],f=t[e+1],o=t[e+2];S=a*r+y*f+p*o,x=B*r+V*f+A*o,I=b*r+w*f+g*o};if(1===s)if(h)for(let r=0;r<d;++r){L(3*e[r]);const t=S*S+x*x+I*I;if(t<N&&t>O){const e=1/Math.sqrt(t);u[i]=S*e,u[i+1]=x*e,u[i+2]=I*e}else u[i]=S,u[i+1]=x,u[i+2]=I;i+=l}else for(let r=0;r<d;++r)L(3*e[r]),u[i]=S,u[i+1]=x,u[i+2]=I,i+=l;else for(let r=0;r<d;++r){if(L(3*e[r]),h){const e=S*S+x*x+I*I;if(e<N&&e>O){const t=1/Math.sqrt(e);S*=t,x*=t,I*=t}}for(let e=0;e<s;++e)u[i]=S,u[i+1]=x,u[i+2]=I,i+=l}}function y(e,t,f,o,i,s=1){if(!f)return void u(e,t,o,i,s);const n=f,c=o.typedBuffer,l=o.typedBufferStride,d=e.length,a=n[0],B=n[1],b=n[2],y=n[4],V=n[5],w=n[6],p=n[8],A=n[9],g=n[10],h=!r.isOrthoNormal(n),O=1e-6,N=1-O;if(i*=l,1===s)for(let r=0;r<d;++r){const f=4*e[r],o=t[f],s=t[f+1],n=t[f+2],u=t[f+3];let d=a*o+y*s+p*n,S=B*o+V*s+A*n,x=b*o+w*s+g*n;if(h){const e=d*d+S*S+x*x;if(e<N&&e>O){const t=1/Math.sqrt(e);d*=t,S*=t,x*=t}}c[i]=d,c[i+1]=S,c[i+2]=x,c[i+3]=u,i+=l}else for(let r=0;r<d;++r){const f=4*e[r],o=t[f],n=t[f+1],u=t[f+2],d=t[f+3];let S=a*o+y*n+p*u,x=B*o+V*n+A*u,I=b*o+w*n+g*u;if(h){const e=S*S+x*x+I*I;if(e<N&&e>O){const t=1/Math.sqrt(e);S*=t,x*=t,I*=t}}for(let e=0;e<s;++e)c[i]=S,c[i+1]=x,c[i+2]=I,c[i+3]=d,i+=l}}function V(e,t,r,f,o,i=1){const s=f.typedBuffer,n=f.typedBufferStride,c=e.length;if(o*=n,r!==t.length||4!==r)if(1!==i)if(4!==r)for(let u=0;u<c;++u){const r=3*e[u];for(let e=0;e<i;++e)s[o]=t[r],s[o+1]=t[r+1],s[o+2]=t[r+2],s[o+3]=255,o+=n}else for(let u=0;u<c;++u){const r=4*e[u];for(let e=0;e<i;++e)s[o]=t[r],s[o+1]=t[r+1],s[o+2]=t[r+2],s[o+3]=t[r+3],o+=n}else{if(4===r){for(let r=0;r<c;++r){const f=4*e[r];s[o]=t[f],s[o+1]=t[f+1],s[o+2]=t[f+2],s[o+3]=t[f+3],o+=n}return}for(let r=0;r<c;++r){const f=3*e[r];s[o]=t[f],s[o+1]=t[f+1],s[o+2]=t[f+2],s[o+3]=255,o+=n}}else{s[o]=t[0],s[o+1]=t[1],s[o+2]=t[2],s[o+3]=t[3];const e=new Uint32Array(f.typedBuffer.buffer,f.start),r=n/4,u=e[o/=4];o+=r;const l=c*i;for(let t=1;t<l;++t)e[o]=u,o+=r}}function w(e,t,r,f,o=1){const i=t.typedBuffer,s=t.typedBufferStride;if(f*=s,1===o)for(let n=0;n<r;++n)i[f]=e[0],i[f+1]=e[1],i[f+2]=e[2],i[f+3]=e[3],f+=s;else for(let n=0;n<r;++n)for(let t=0;t<o;++t)i[f]=e[0],i[f+1]=e[1],i[f+2]=e[2],i[f+3]=e[3],f+=s}function p(e,r,s,c,l,d){for(const a of r.fieldNames){const r=e.vertexAttributes.get(a),p=e.indices.get(a);if(r&&p)switch(a){case i.VertexAttribute.POSITION:{o.assert(3===r.size);const e=l.getField(a,f.BufferViewVec3f);o.assert(!!e,`No buffer view for ${a}`),e&&B(p,r.data,s,e,d);break}case i.VertexAttribute.NORMAL:{o.assert(3===r.size);const e=l.getField(a,f.BufferViewVec3f);o.assert(!!e,`No buffer view for ${a}`),e&&b(p,r.data,c,e,d);break}case i.VertexAttribute.UV0:{o.assert(2===r.size);const e=l.getField(a,f.BufferViewVec2f);o.assert(!!e,`No buffer view for ${a}`),e&&n(p,r.data,e,d);break}case i.VertexAttribute.COLOR:case i.VertexAttribute.SYMBOLCOLOR:{o.assert(3===r.size||4===r.size);const e=l.getField(a,f.BufferViewVec4u8);o.assert(!!e,`No buffer view for ${a}`),e&&V(p,r.data,r.size,e,d);break}case i.VertexAttribute.TANGENT:{o.assert(4===r.size);const e=l.getField(a,f.BufferViewVec4f);o.assert(!!e,`No buffer view for ${a}`),e&&y(p,r.data,c,e,d);break}case i.VertexAttribute.PROFILERIGHT:case i.VertexAttribute.PROFILEUP:case i.VertexAttribute.PROFILEVERTEXANDNORMAL:case i.VertexAttribute.FEATUREVALUE:{o.assert(4===r.size);const e=l.getField(a,f.BufferViewVec4f);o.assert(!!e,`No buffer view for ${a}`),e&&u(p,r.data,e,d)}}else if(a===i.VertexAttribute.OBJECTANDLAYERIDCOLOR&&t.isSome(e.objectAndLayerIdColor)){const t=e.indices.get(i.VertexAttribute.POSITION);if(o.assert(!!t,`No buffer view for ${a}`),t){const r=t.length,o=l.getField(a,f.BufferViewVec4u8);w(e.objectAndLayerIdColor,o,r,d)}}}}e.writeBufferFloat=s,e.writeBufferMat3f=d,e.writeBufferMat4f=a,e.writeBufferVec2=n,e.writeBufferVec3=c,e.writeBufferVec4=u,e.writeBufferVec4Zeros=l,e.writeColor=V,e.writeDefaultAttributes=p,e.writeNormal=b,e.writeObjectAndLayerIdColor=w,e.writePosition=B,e.writeTangent=y,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
