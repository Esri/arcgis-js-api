// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.5/esri/copyright.txt for details.

define(["require","exports","../../lib/IdGen","../../lib/gl-matrix","../../lib/ComponentUtils","../../lib/Util","../../parts/Model","../../lib/screenSizePerspectiveUtils","../../../../webgl/Util","../../../support/aaBoundingBox"],function(e,t,n,r,i,a,o,f,c,u){function s(e,t,n,r,i){var a=e[t],o=e[t+1],f=e[t+2];n[r]=i[0]*a+i[4]*o+i[8]*f+i[12],n[r+1]=i[1]*a+i[5]*o+i[9]*f+i[13],n[r+2]=i[2]*a+i[6]*o+i[10]*f+i[14]}function d(e,t,n,r,i,a){if(void 0===i||3!==a)for(var o=0;a>o;++o)n[r+o]=e[t+o];else s(e,t,n,r,i);return a}function l(e,t,n,r,i,a){for(var o=e.length,f=0;o>f;++f){var c=3*e[f],u=t[c],s=t[c+1],d=t[c+2];r[i]=n[0]*u+n[4]*s+n[8]*d+n[12],r[i+1]=n[1]*u+n[5]*s+n[9]*d+n[13],r[i+2]=n[2]*u+n[6]*s+n[10]*d+n[14],i+=a}}function v(e,t,n,r,i,a){for(var o=e.length,f=0;o>f;++f){for(var c=n*e[f],u=0;n>u;++u)r[i+u]=t[c+u];i+=a}}function g(e,t,n,r,i,a){r=new Uint8Array(r.buffer),i*=4,a*=4;var o=e.length;if(4===n)for(var f=0;o>f;++f){var c=4*e[f];r[i]=t[c],r[i+1]=t[c+1],r[i+2]=t[c+2],r[i+3]=t[c+3],i+=a}else if(3===n)for(var f=0;o>f;++f){var c=3*e[f];r[i]=t[c],r[i+1]=t[c+1],r[i+2]=t[c+2],r[i+3]=255,i+=a}}function m(e,t,n,r,i,a,o){i=new Uint8Array(i.buffer),a*=4,o*=4;var f=e.length;if(4===r)for(var c=0;f>c;++c){var u=4*e[c];i[a]=t[u]*n[0],i[a+1]=t[u+1]*n[1],i[a+2]=t[u+2]*n[2],i[a+3]=t[u+3]*n[3],a+=o}else if(3===r)for(var s=255*n[3],c=0;f>c;++c){var u=3*e[c];i[a]=t[u]*n[0],i[a+1]=t[u+1]*n[1],i[a+2]=t[u+2]*n[2],i[a+3]=s,a+=o}}function x(e,t,n,r,i,a){r=new Uint16Array(r.buffer),i*=2,a*=2;for(var o=e.length,f=0;o>f;++f){for(var c=n*e[f],u=0;n>u;++u)r[i+u]=t[c+u];i+=a}}function h(e,t,n,r,i,a,o,f){for(var u=c.getStride(i)/4,s=0;s<i.length;s++){var d=i[s],h=o+d.offset/4,p=d.name,M=e.vertexAttr[p];if(null!=M&&(null==f||null!=f[p]))switch(p){case"uv0":v(e.faces.indices[p],M.data,M.size,a,h,u);break;case"region":x(e.faces.indices[p],M.data,M.size,a,h,u);break;case"color":r&&r.color?m(e.faces.indices[p],M.data,r.color,M.size,a,h,u):g(e.faces.indices[p],M.data,M.size,a,h,u);break;case"symbolColor":g(e.faces.indices[p],M.data,M.size,a,h,u);break;default:var b=p===H.POSITION?t:p===H.NORMAL?n:void 0;void 0!==b&&3===M.size?l(e.faces.indices[p],M.data,b,a,h,u):v(e.faces.indices[p],M.data,M.size,a,h,u)}}}function p(e,t,n,r){for(var i=Math.floor(n/3),a=i-1;a>=0;a--){var o=t+3*a*r,f=t+3*a*2*r+5*r;d(e,o,e,f,null,r),f-=r,d(e,o+r,e,f,null,r),f-=r,d(e,o+r,e,f,null,r),f-=r,d(e,o+2*r,e,f,null,r),f-=r,d(e,o+2*r,e,f,null,r),f-=r,d(e,o,e,f,null,r)}}function M(e,t,n,r,o,f,c){a.assert("triangle"===e.data.primitiveType);var u=t.componentVisibilities,s=r.tolerance,d=e.getBoundingInfo(0);e.getComponentCount()>1?y(e,d,u,o,f,s,c):i.getVisibility(u,0)&&b(d,o,f,s,c)}function b(e,t,n,r,i){var a=I(t,n,F);if(u.setMin(K,e.getBBMin()),u.setMax(K,e.getBBMax()),P(K,t,a,r)){var o=e.getPrimitiveIndices(),f=e.getIndices(),c=e.getPosition(),s=o?o.length:f.length/3;if(s>1e4){var d=e.getChildren();if(void 0!==d){for(var l=0;8>l;++l)void 0!==d[l]&&b(d[l],t,n,r,i);return}}T(t,n,0,s,f,c,o,i)}}function y(e,t,n,r,a,o,f){var c=I(r,a,F);if(u.setMin(K,t.getBBMin()),u.setMax(K,t.getBBMax()),P(K,r,c,o))for(var s=e.getComponentCount(),d=e.data.faces[0],l=d.indices[d.positionKey],v=e.data.vertexAttributes[d.positionKey],g=e.data.componentOffsets,m=0;s>m;m++)if(i.getVisibility(n,m)){var x=e.getComponentAABB(m,K);if(P(x,r,c,o)){var h=g[m]/3,p=g[m+1]/3;T(r,a,h,p,l,v,void 0,f)}}}function T(e,t,n,r,i,a,o,f){for(var c=a.data,u=a.size,s=e[0],d=e[1],l=e[2],v=t[0],g=t[1],m=t[2],x=v-s,h=g-d,p=m-l,M=n;r>M;M++){var b=o?o[M]:M,y=u*i[3*b],T=u*i[3*b+1],I=u*i[3*b+2],P=c[y],C=c[y+1],U=c[y+2],A=c[T],z=c[T+1],S=c[T+2],w=c[I],V=c[I+1],_=c[I+2],B=A-P,G=z-C,W=S-U,O=w-P,D=V-C,N=_-U,R=h*N-D*p,k=p*O-N*x,E=x*D-O*h,q=B*R+G*k+W*E,Y=s-P,j=d-C,K=l-U,H=j*W-G*K,F=K*B-W*Y,X=Y*G-B*j;if(q>J){var Z=Y*R+j*k+K*E;if(0>Z||Z>q)continue;var $=x*H+h*F+p*X;if(0>$||Z+$>q)continue}else{if(!(-J>q))continue;var Z=Y*R+j*k+K*E;if(Z>0||q>Z)continue;var $=x*H+h*F+p*X;if($>0||q>Z+$)continue}var ee=(O*H+D*F+N*X)/q;if(ee>=0){var te=L(B,G,W,O,D,N,Q);f(ee,te,b)}}}function L(e,t,n,i,a,o,f){return r.vec3d.set3(e,t,n,X),r.vec3d.set3(i,a,o,Z),r.vec3d.normalize(r.vec3d.cross(X,Z,f))}function I(e,t,n){return r.vec3d.set3(1/(t[0]-e[0]),1/(t[1]-e[1]),1/(t[2]-e[2]),n)}function P(e,t,n,r){var i=(e[0]-r-t[0])*n[0],a=(e[3]+r-t[0])*n[0],o=Math.min(i,a),f=Math.max(i,a),c=(e[1]-r-t[1])*n[1],u=(e[4]+r-t[1])*n[1];if(o=Math.max(o,Math.min(c,u)),f=Math.min(f,Math.max(c,u)),o>f)return!1;var s=(e[2]-r-t[2])*n[2],d=(e[5]+r-t[2])*n[2];return o=Math.max(o,Math.min(s,d)),f=Math.min(f,Math.max(s,d)),f>=o}function C(e,t,n){return r.vec4d.set4(e[0]-t[0],e[1]-t[1],e[2]-t[2],1,n)}function U(e,t,n,i){return r.mat4d.translate(n,t,j),n=j,r.mat4d.multiplyVec4(n,e,i)}function A(e,t,n,i){return i[0]=e[0]+n[0],i[1]=e[1]+n[1],i[2]=e[2]+n[2],i[3]=e[3],r.mat4d.multiplyVec4(t,i)}function z(e,t){return r.vec4d.scale(e,1/Math.abs(e[3]),t)}function S(e,t,n,r,i){return f.scale(e,r,n,i)}function w(e,t,n,r,i){var o=n.screenLength||0;i&&(o=S(o,e,t,r,i));var f=o*Math.tan(.5*e.fovY)/(.5*e.fullHeight);return a.clamp(f*t,n.minWorldLength||0,null!=n.maxWorldLength?n.maxWorldLength:1/0)}function V(e,n){var r=!0,i=0,f=t.__Material_idGen.gen(n);e.getId=function(){return f};var c;e.getParentStage=function(){return c},e.addParentStage=function(e){a.assert(void 0===c,"Material can only be added to a single Stage"),c=e},e.removeParentStage=function(e){c=void 0},e.setVisible=function(t){r!==t&&(r=t,e.notifyDirty("matChanged"))},e.isVisible=function(){return r},e.notifyDirty=function(t){c&&c.notifyDirty(o.ContentType.MATERIAL,e,t)},e.setRenderPriority=function(e){i=e,this.notifyDirty("matChanged")},e.getRenderPriority=function(){return i}}function _(e,t,n,r){return void 0!==e?n.aquire(e,t,r):void 0}function B(e,t){void 0!==e&&t.release(e)}function G(e,t,n){r.mat4d.translate(t,e,$),n.setUniform3fv("localOrigin",e),n.setUniformMatrix4fv("view",$)}function W(e,t,n){n.setUniform3f("camPos",t[3]-e[0],t[7]-e[1],t[11]-e[2])}function O(e,t,n){if(e){var r=D(e,t.fovY,t.viewport[3]);n.setUniform4f("verticalOffset",r.screenLength,r.perDistance,r.minWorldLength,r.maxWorldLength)}}function D(e,t,n,r){return void 0===r&&(r=ee),r.screenLength=e.screenLength,r.perDistance=Math.tan(.5*t)/(.5*n),r.minWorldLength=e.minWorldLength,r.maxWorldLength=e.maxWorldLength,r}function N(e,t,n){if(void 0===n&&(n="screenSizePerspectiveAlignment"),e){var r=e.parameters,i=e.paddingPixelsOverride;t.setUniform4f(n,r.divisor,r.offset,r.minPixelSize,i)}}function R(e,n){var r=t.__GLMaterial_id++;e.getId=function(){return r},e.getMaterialId=function(){return n.getId()},e.isVisible=function(){return n.isVisible()},e.getRenderPriority=function(){return n.getRenderPriority()}}function k(e,t,n,r){var i=_(n.textureId,n.initTexture,t,r);e.updateTexture=function(e){n.textureId!==e&&(B(n.textureId,t),n.textureId=e,i=_(n.textureId,n.initTexture,t,r))},e.renderTexture=function(e){var r=t.getTexture(n.textureId);r&&r.dirty&&r.redraw&&r.redraw()},e.bindTexture=function(e,t){void 0!==i&&(t.setUniform1i("tex",0),e.bindTexture(i.getGLTexture()))},e.bindTextureSize=function(e,t){if(void 0!==i){var n=i.getGLTexture();t.setUniform2f("texSize",n.descriptor.width,n.descriptor.height)}},e.dispose=function(){B(n.textureId,t)}}function E(e,t,n,r){for(var i=r.length,a=new Array(i),o=0;i>o;o++)a[o]=_(n[r[o][0]],n[r[o][1]],t);e.updateTextures=function(e){for(var o=0;i>o;o++){var f=n[r[o][0]],c=e[r[o][0]];f!==c&&(B(f,t),n[r[o][0]]=c,a[o]=_(c,n[r[o][1]],t))}},e.bindTextures=function(e,t){for(var n=0;i>n;n++)void 0!==a[n]&&(t.setUniform1i(r[n][2],n),e.bindTexture(a[n].getGLTexture(),n));e.setActiveTexture(0)},e.bindOneTexture=function(e,t,n){t.setUniform1i(r[n][2],n),e.bindTexture(a[n].getGLTexture(),n),e.setActiveTexture(0)},e.disposeTextures=function(){for(var e=0;i>e;e++)B(n[r[e][0]],t)}}function q(e,t){var n=t?q(t):{};for(var r in e){var i=e[r];i&&i.forEach&&(i=Y(i)),null==i&&r in n||(n[r]=i)}return n}function Y(e){var t=[];return e.forEach(function(e){return t.push(e)}),t}Object.defineProperty(t,"__esModule",{value:!0});var j=r.mat4d.create(),K=u.create(),H=a.VertexAttrConstants;t.__Material_idGen=new n,t.__GLMaterial_id=0,t.IDENTITY=r.mat4d.identity(),t.fill=d,t.fillInterleaved=h,t.triangleVertexArrayToWireframeLines=p,t.intersectTriangleGeometry=M;var F=r.vec3d.create(),J=Math.pow(2,-52),Q=r.vec3d.create(),X=r.vec3d.create(),Z=r.vec3d.create();t.transformToWorld=C,t.transformToView=U,t.transformToProjection=A,t.transformToNDC=z,t.applyScreenSizePerspectiveScale=S,t.verticalOffsetAtDistance=w,t.basicMaterialConstructor=V,t.aquireIfNotUndefined=_,t.releaseIfNotUndefined=B;var $=r.mat4.create();t.bindView=G,t.bindCamPos=W,t.bindVerticalOffset=O,t.bindScreenSizePerspective=N,t.basicGLMaterialConstructor=R,t.singleTextureGLMaterialConstructor=k,t.multiTextureGLMaterialConstructor=E,t.copyParameters=q,t.colorMixModes={multiply:1,ignore:2,replace:3,tint:4};var ee={screenLength:0,perDistance:0,minWorldLength:0,maxWorldLength:0}});