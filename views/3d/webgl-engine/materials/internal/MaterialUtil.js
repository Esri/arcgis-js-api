/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../../core/mathUtils","../../../../../core/maybe","../../../../../chunks/vec3","../../../../../chunks/vec3f64","../../../../../geometry/support/aaBoundingBox","../../lib/basicInterfaces","../../lib/screenSizePerspectiveUtils","../../lib/Util","../../lib/VertexAttribute","../renderers/utils"],(function(e,t,n,i,r,o,s,c,a,l,u){"use strict";const f=o.create();function m(e,t,n,i,r,o,c){if(!u.isInstanceHidden(t))if(e.boundingInfo){a.assert(e.primitiveType===s.PrimitiveType.Triangle);const t=n.tolerance;p(e.boundingInfo,i,r,t,o,c)}else{const t=e.indices.get(l.VertexAttribute.POSITION),n=e.vertexAttributes.get(l.VertexAttribute.POSITION);h(i,r,0,t.length/3,t,n,void 0,o,c)}}const d=r.create();function p(e,t,i,r,s,c){if(n.isNone(e))return;const a=y(t,i,d);if(o.setMin(f,e.getBBMin()),o.setMax(f,e.getBBMax()),n.isSome(s)&&s.applyToAabb(f),I(f,t,a,r)){const{primitiveIndices:n,indices:o,position:a}=e,l=n?n.length:o.length/3;if(l>B){const n=e.getChildren();if(void 0!==n){for(let e=0;e<8;++e)void 0!==n[e]&&p(n[e],t,i,r,s,c);return}}h(t,i,0,l,o,a,n,s,c)}}const b=r.create();function h(e,t,i,r,o,s,c,a,l){if(c)return x(e,t,i,r,o,s,c,a,l);const u=s.data,f=s.stride||s.size,m=e[0],d=e[1],p=e[2],h=t[0]-m,g=t[1]-d,v=t[2]-p;for(let x=i,y=3*i;x<r;++x){let e=f*o[y++],t=u[e++],i=u[e++],r=u[e];e=f*o[y++];let s=u[e++],c=u[e++],I=u[e];e=f*o[y++];let T=u[e++],A=u[e++],S=u[e];n.isSome(a)&&([t,i,r]=a.applyToVertex(t,i,r,x),[s,c,I]=a.applyToVertex(s,c,I,x),[T,A,S]=a.applyToVertex(T,A,S,x));const P=s-t,V=c-i,O=I-r,N=T-t,L=A-i,B=S-r,z=g*B-L*v,E=v*N-B*h,D=h*L-N*g,U=P*z+V*E+O*D;if(Math.abs(U)<=Number.EPSILON)continue;const W=m-t,R=d-i,_=p-r,k=W*z+R*E+_*D;if(U>0){if(k<0||k>U)continue}else if(k>0||k<U)continue;const G=R*O-V*_,H=_*P-O*W,j=W*V-P*R,C=h*G+g*H+v*j;if(U>0){if(C<0||k+C>U)continue}else if(C>0||k+C<U)continue;const X=(N*G+L*H+B*j)/U;if(X>=0){l(X,M(P,V,O,N,L,B,b),x,!1)}}}function x(e,t,i,r,o,s,c,a,l){const u=s.data,f=s.stride||s.size,m=e[0],d=e[1],p=e[2],h=t[0]-m,x=t[1]-d,g=t[2]-p;for(let v=i;v<r;++v){const e=c[v];let t=3*e,i=f*o[t++],r=u[i++],s=u[i++],y=u[i];i=f*o[t++];let I=u[i++],T=u[i++],A=u[i];i=f*o[t];let S=u[i++],P=u[i++],V=u[i];n.isSome(a)&&([r,s,y]=a.applyToVertex(r,s,y,v),[I,T,A]=a.applyToVertex(I,T,A,v),[S,P,V]=a.applyToVertex(S,P,V,v));const O=I-r,N=T-s,L=A-y,B=S-r,z=P-s,E=V-y,D=x*E-z*g,U=g*B-E*h,W=h*z-B*x,R=O*D+N*U+L*W;if(Math.abs(R)<=Number.EPSILON)continue;const _=m-r,k=d-s,G=p-y,H=_*D+k*U+G*W;if(R>0){if(H<0||H>R)continue}else if(H>0||H<R)continue;const j=k*L-N*G,C=G*O-L*_,X=_*N-O*k,Y=h*j+x*C+g*X;if(R>0){if(Y<0||H+Y>R)continue}else if(Y>0||H+Y<R)continue;const Z=(B*j+z*C+E*X)/R;if(Z>=0){l(Z,M(O,N,L,B,z,E,b),e,!1)}}}const g=r.create(),v=r.create();function M(e,t,n,r,o,s,c){return i.set(g,e,t,n),i.set(v,r,o,s),i.cross(c,g,v),i.normalize(c,c),c}function y(e,t,n){return i.set(n,1/(t[0]-e[0]),1/(t[1]-e[1]),1/(t[2]-e[2]))}function I(e,t,n,i){return T(e,t,n,i,1/0)}function T(e,t,n,i,r){const o=(e[0]-i-t[0])*n[0],s=(e[3]+i-t[0])*n[0];let c=Math.min(o,s),a=Math.max(o,s);const l=(e[1]-i-t[1])*n[1],u=(e[4]+i-t[1])*n[1];if(a=Math.min(a,Math.max(l,u)),a<0)return!1;if(c=Math.max(c,Math.min(l,u)),c>a)return!1;const f=(e[2]-i-t[2])*n[2],m=(e[5]+i-t[2])*n[2];return a=Math.min(a,Math.max(f,m)),!(a<0)&&(c=Math.max(c,Math.min(f,m)),!(c>a)&&c<r)}function A(e,n,i,r,o){let s=(i.screenLength||0)*e.pixelRatio;o&&(s=c.scale(s,r,n,o));const a=s*Math.tan(.5*e.fovY)/(.5*e.fullHeight);return t.clamp(a*n,i.minWorldLength||0,null!=i.maxWorldLength?i.maxWorldLength:1/0)}function S(e,t,n){if(!e)return;const i=e.parameters,r=e.paddingPixelsOverride;t.setUniform4f(n,i.divisor,i.offset,i.minPixelSize,r)}function P(e,t){const n=t?P(t):{};for(const i in e){let t=e[i];t&&t.forEach&&(t=N(t)),null==t&&i in n||(n[i]=t)}return n}function V(e,t){let n=!1;for(const i in t){const r=t[i];void 0!==r&&(n=!0,Array.isArray(r)?e[i]=r.slice():e[i]=r)}return n}function O(e,n,i,r,o,s){if(!n.options.selectionMode)return;const c=e.vertexAttributes.get(l.VertexAttribute.POSITION).data,a=e.vertexAttributes.get(l.VertexAttribute.SIZE),u=a&&a.data[0],f=r[0],m=r[1],d=((u+o)/2+4)*e.screenToWorldRatio;let p=Number.MAX_VALUE,b=0;for(let l=0;l<c.length-5;l+=3){const e=c[l],n=c[l+1],i=f-e,r=m-n,o=c[l+3]-e,s=c[l+4]-n,a=o*i+s*r,u=o*o+s*s,d=t.clamp(a/u,0,1),h=o*d-i,x=s*d-r,g=h*h+x*x;g<p&&(p=g,b=l/3)}p<d*d&&s(i.dist,i.normal,b,!1)}function N(e){const t=[];return e.forEach((e=>t.push(e))),t}const L={multiply:1,ignore:2,replace:3,tint:4},B=1e3;e.bindScreenSizePerspective=S,e.colorMixModes=L,e.computeInvDir=y,e.computeNormal=M,e.copyParameters=P,e.intersectAabbInvDir=I,e.intersectAabbInvDirBefore=T,e.intersectDrapedRenderLineGeometry=O,e.intersectTriangleGeometry=m,e.intersectTriangles=h,e.updateParameters=V,e.verticalOffsetAtDistance=A,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
