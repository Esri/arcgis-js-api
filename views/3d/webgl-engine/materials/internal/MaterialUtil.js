// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","../../../../../core/mathUtils","../../../../../core/maybe","../../../../../core/libs/gl-matrix-2/vec3","../../../../../core/libs/gl-matrix-2/vec3f64","../../../../../geometry/support/aaBoundingBox","../../lib/screenSizePerspectiveUtils","../../lib/Util","../renderers/utils"],(function(e,r,t,i,n,a,o,c,s,v){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.colorMixModes=r.intersectDrapedRenderLineGeometry=r.updateParameters=r.copyParameters=r.bindScreenSizePerspective=r.verticalOffsetAtDistance=r.intersectAabbInvDirBefore=r.intersectAabbInvDir=r.computeInvDir=r.computeNormal=r.intersectTriangles=r.intersectTriangleGeometry=void 0;var f=o.create(),l=s.VertexAttrConstants;r.intersectTriangleGeometry=function(e,r,t,n,a,c,d){var m=v.isInstanceHidden(r),g=t.tolerance;if(!m)if(e.boundingInfo)s.assert("triangle"===e.data.primitiveType),function e(r,t,n,a,c,s){var v=b(t,n,u);o.setMin(f,r.getBBMin()),o.setMax(f,r.getBBMax()),i.isSome(c)&&c.applyToAabb(f);if(M(f,t,v,a)){var l=r.getPrimitiveIndices(),d=r.getIndices(),m=r.getPosition(),g=l?l.length:d.length/3;if(g>T){var x=r.getChildren();if(void 0!==x){for(var h=0;h<8;++h)void 0!==x[h]&&e(x[h],t,n,a,c,s);return}}p(t,n,0,g,d,m,l,c,s)}}(e.boundingInfo,n,a,g,c,d);else{var x=e.getIndices(l.POSITION),h=e.getAttribute(l.POSITION);p(n,a,0,x.length/3,x,h,void 0,c,d)}};var u=a.vec3f64.create();var d=Math.pow(2,-52),m=a.vec3f64.create();function p(e,r,t,n,a,o,c,s,v){var f,l,u;if(c)return function(e,r,t,n,a,o,c,s,v){for(var f,l,u,p=o.data,g=o.offsetIdx,x=o.strideIdx,b=e[0],M=e[1],I=e[2],y=r[0],T=r[1],A=r[2],P=y-b,S=T-M,D=A-I,O=t;O<n;++O){var B=c[O],V=3*B,L=g+x*a[V++],N=p[L++],z=p[L++],U=p[L];L=g+x*a[V++];var E=p[L++],G=p[L++],R=p[L];L=g+x*a[V];var W=p[L++],C=p[L++],_=p[L];i.isSome(s)&&(f=s.applyToVertex(N,z,U),N=f[0],z=f[1],U=f[2],l=s.applyToVertex(E,G,R),E=l[0],G=l[1],R=l[2],u=s.applyToVertex(W,C,_),W=u[0],C=u[1],_=u[2]);var H=E-N,j=G-z,q=R-U,w=W-N,X=C-z,Y=_-U,Z=S*Y-X*D,k=D*w-Y*P,F=P*X-w*S,J=H*Z+j*k+q*F;if(!(Math.abs(J)<=d)){var K=b-N,Q=M-z,$=I-U,ee=K*Z+Q*k+$*F;if(J>0){if(ee<0||ee>J)continue}else if(ee>0||ee<J)continue;var re=Q*q-j*$,te=$*H-q*K,ie=K*j-H*Q,ne=P*re+S*te+D*ie;if(J>0){if(ne<0||ee+ne>J)continue}else if(ne>0||ee+ne<J)continue;var ae=(w*re+X*te+Y*ie)/J;if(ae>=0){var oe=h(H,j,q,w,X,Y,m);v(ae,oe,B)}}}}(e,r,t,n,a,o,c,s,v);for(var p=o.data,g=o.offsetIdx,x=o.strideIdx,b=e[0],M=e[1],I=e[2],y=r[0]-b,T=r[1]-M,A=r[2]-I,P=t,S=3*t;P<n;++P){var D=g+x*a[S++],O=p[D++],B=p[D++],V=p[D];D=g+x*a[S++];var L=p[D++],N=p[D++],z=p[D];D=g+x*a[S++];var U=p[D++],E=p[D++],G=p[D];i.isSome(s)&&(O=(f=s.applyToVertex(O,B,V))[0],B=f[1],V=f[2],L=(l=s.applyToVertex(L,N,z))[0],N=l[1],z=l[2],U=(u=s.applyToVertex(U,E,G))[0],E=u[1],G=u[2]);var R=L-O,W=N-B,C=z-V,_=U-O,H=E-B,j=G-V,q=T*j-H*A,w=A*_-j*y,X=y*H-_*T,Y=R*q+W*w+C*X;if(!(Math.abs(Y)<=d)){var Z=b-O,k=M-B,F=I-V,J=Z*q+k*w+F*X;if(Y>0){if(J<0||J>Y)continue}else if(J>0||J<Y)continue;var K=k*C-W*F,Q=F*R-C*Z,$=Z*W-R*k,ee=y*K+T*Q+A*$;if(Y>0){if(ee<0||J+ee>Y)continue}else if(ee>0||J+ee<Y)continue;var re=(_*K+H*Q+j*$)/Y;if(re>=0)v(re,h(R,W,C,_,H,j,m),P)}}}r.intersectTriangles=p;var g=a.vec3f64.create(),x=a.vec3f64.create();function h(e,r,t,i,a,o,c){return n.vec3.set(g,e,r,t),n.vec3.set(x,i,a,o),n.vec3.cross(c,g,x),n.vec3.normalize(c,c),c}function b(e,r,t){return n.vec3.set(t,1/(r[0]-e[0]),1/(r[1]-e[1]),1/(r[2]-e[2]))}function M(e,r,t,i){return I(e,r,t,i,1/0)}function I(e,r,t,i,n){var a=(e[0]-i-r[0])*t[0],o=(e[3]+i-r[0])*t[0],c=Math.min(a,o),s=Math.max(a,o),v=(e[1]-i-r[1])*t[1],f=(e[4]+i-r[1])*t[1];if((s=Math.min(s,Math.max(v,f)))<0)return!1;if((c=Math.max(c,Math.min(v,f)))>s)return!1;var l=(e[2]-i-r[2])*t[2],u=(e[5]+i-r[2])*t[2];return!((s=Math.min(s,Math.max(l,u)))<0)&&(!((c=Math.max(c,Math.min(l,u)))>s)&&c<n)}function y(e){var r=[];return e.forEach((function(e){return r.push(e)})),r}r.computeNormal=h,r.computeInvDir=b,r.intersectAabbInvDir=M,r.intersectAabbInvDirBefore=I,r.verticalOffsetAtDistance=function(e,r,i,n,a){var o=(i.screenLength||0)*e.pixelRatio;a&&(o=c.scale(o,n,r,a));var s=o*Math.tan(.5*e.fovY)/(.5*e.fullHeight);return t.glClamp(s*r,i.minWorldLength||0,null!=i.maxWorldLength?i.maxWorldLength:1/0)},r.bindScreenSizePerspective=function(e,r,t){if(e){var i=e.parameters,n=e.paddingPixelsOverride;r.setUniform4f(t,i.divisor,i.offset,i.minPixelSize,n)}},r.copyParameters=function e(r,t){var i=t?e(t):{};for(var n in r){var a=r[n];a&&a.forEach&&(a=y(a)),null==a&&n in i||(i[n]=a)}return i},r.updateParameters=function(e,r){var t=!1;for(var i in r){var n=r[i];void 0!==n&&(t=!0,Array.isArray(n)?e[i]=n.slice():e[i]=n)}return t},r.intersectDrapedRenderLineGeometry=function(e,r,i,n,a){if(r.options.selectionMode){for(var o=e.getAttribute(l.POSITION).data,c=e.getAttribute(l.SIZE),s=c&&c.data[0],v=i[0],f=i[1],u=((s+n)/2+4)*e.screenToWorldRatio,d=Number.MAX_VALUE,m=0;m<o.length-5;m+=3){var p=o[m],g=o[m+1],x=v-p,h=f-g,b=o[m+3]-p,M=o[m+4]-g,I=b*x+M*h,y=b*b+M*M,T=t.clamp(I/y,0,1),A=b*T-x,P=M*T-h,S=A*A+P*P;S<d&&(d=S)}d<u*u&&a()}},r.colorMixModes={multiply:1,ignore:2,replace:3,tint:4};var T=1e3}));