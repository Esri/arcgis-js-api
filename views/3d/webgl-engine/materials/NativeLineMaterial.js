// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../core/Logger","../../../../core/maybe","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/vec2","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../support/geometryUtils","../../support/buffer/BufferView","../lib/geometryDataUtils","../lib/GLMaterial","../lib/Material","../lib/Util","./internal/bufferWriterUtils","./internal/DefaultBufferWriter","./internal/MaterialUtil","./renderers/utils","../shaders/NativeLineTechnique"],(function(e,t,r,n,i,a,s,o,c,l,u,p,f,h,m,d,v,g,P,y){"use strict";var x=n.getLogger("esri.views.3d.webgl-engine.materials.NativeLineMaterial"),A=function(e){function t(t,r){var n=e.call(this,r)||this;return n.techniqueConfig=new y.NativeLineTechniqueConfiguration,n.params=g.copyParameters(t,S),n}return r.__extends(t,e),t.prototype.setParameterValues=function(e){var t=this.params;for(var r in e)t[r]=e[r];this.parametersChanged()},t.prototype.getParameters=function(){return this.params},t.prototype.getTechniqueConfig=function(e){this.techniqueConfig.output=e,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.vertexColors=this.params.vertexColors,this.techniqueConfig.transparent=this.params.color[3]<1||this.params.width<1;var t=i.isSome(this.params.stipplePattern);return this.techniqueConfig.stippleEnabled=t,this.techniqueConfig.stippleOffColorEnabled=t&&i.isSome(this.params.stippleOffColor),this.techniqueConfig.stippleIntegerRepeatsEnabled=t&&this.params.stippleIntegerRepeats,this.techniqueConfig.sceneHasOcludees=this.params.sceneHasOcludees,this.techniqueConfig},t.prototype.getPassParameters=function(){return this.params},t.prototype.intersect=function(e,t,r,n,i,a,s,o,c){c?g.intersectDrapedRenderLineGeometry(e,n,a,1,s):this.intersectLineGeometry(e,t,r,n,s)},t.prototype.intersectLineGeometry=function(e,t,r,n,i){if(n.options.selectionMode&&!P.isInstanceHidden(t))if(m.isTranslationMatrix(r)){var a=e.data.getVertexAttr().position.data,c=n.camera,u=M;s.vec2.copy(u,n.point);o.vec3.set(N[0],u[0]-2,u[1]+2,0),o.vec3.set(N[1],u[0]+2,u[1]+2,0),o.vec3.set(N[2],u[0]+2,u[1]-2,0),o.vec3.set(N[3],u[0]-2,u[1]-2,0);for(var p=0;p<4;p++)c.unprojectPoint(N[p],E[p]);l.plane.fromPoints(c.eye,E[0],E[1],U),l.plane.fromPoints(c.eye,E[1],E[2],_),l.plane.fromPoints(c.eye,E[2],E[3],G),l.plane.fromPoints(c.eye,E[3],E[0],H);var f=Number.MAX_VALUE;for(p=0;p<a.length-5;p+=3)if(q[0]=a[p]+r[12],q[1]=a[p+1]+r[13],q[2]=a[p+2]+r[14],O[0]=a[p+3]+r[12],O[1]=a[p+4]+r[13],O[2]=a[p+5]+r[14],!(l.plane.signedDistance(U,q)<0&&l.plane.signedDistance(U,O)<0||l.plane.signedDistance(_,q)<0&&l.plane.signedDistance(_,O)<0||l.plane.signedDistance(G,q)<0&&l.plane.signedDistance(G,O)<0||l.plane.signedDistance(H,q)<0&&l.plane.signedDistance(H,O)<0)){if(c.projectPoint(q,D),c.projectPoint(O,w),D[2]<0&&w[2]>0){o.vec3.subtract(L,q,O);var h=c.frustum,d=-l.plane.signedDistance(h.planes[4],q)/o.vec3.dot(L,l.plane.normal(h.planes[4]));o.vec3.scale(L,L,d),o.vec3.add(q,q,L),c.projectPoint(q,D)}else if(D[2]>0&&w[2]<0){o.vec3.subtract(L,O,q);h=c.frustum,d=-l.plane.signedDistance(h.planes[4],O)/o.vec3.dot(L,l.plane.normal(h.planes[4]));o.vec3.scale(L,L,d),o.vec3.add(O,O,L),c.projectPoint(O,w)}else if(D[2]<0&&w[2]<0)continue;D[2]=0,w[2]=0;var v=l.lineSegment.distance2(l.lineSegment.fromPoints(D,w,R),u);v<f&&(f=v,o.vec3.copy(B,q),o.vec3.copy(I,O))}var g=n.rayBeginPoint,y=n.rayEndPoint;if(f<4){var A=Number.MAX_VALUE;if(l.lineSegment.closestLineSegmentPoint(l.lineSegment.fromPoints(B,I,R),l.lineSegment.fromPoints(g,y,T),V)){o.vec3.subtract(V,V,g);var C=o.vec3.length(V);o.vec3.scale(V,V,1/C),A=C/o.vec3.distance(g,y)}i(A,V)}}else x.error("intersection assumes a translation-only matrix")},t.prototype.computeAttachmentOrigin=function(e,t){var r=e.data,n="getVertexAttr"in r?r.getVertexAttr():"vertexAttr"in r?r.vertexAttr:null;if(!n)return null;var i=n[m.VertexAttrConstants.POSITION];return p.computeAttachmentOriginLines(i,null,!1,t)},t.prototype.createBufferWriter=function(){var e=this.params.vertexColors?v.PositionColorLayout:v.PositionLayout;return i.isNone(this.params.stipplePattern)?new v.DefaultBufferWriter(e):new b(e.clone().vec3f(m.VertexAttrConstants.AUXPOS1))},t.prototype.getGLMaterial=function(e){return 0===e.output||4===e.output?new C(e):void 0},t}(h.Material),C=function(e){function t(t){var r=e.call(this,t)||this;return r.updateParameters(),r}return r.__extends(t,e),t.prototype.updateParameters=function(){this.technique=this.techniqueRep.acquireAndReleaseExisting(y.NativeLineTechnique,this.material.getTechniqueConfig(this.output),this.technique)},t.prototype.beginSlot=function(e){return 3===e},t.prototype._updateOccludeeState=function(e){e.hasOccludees!==this.material.getParameters().sceneHasOcludees&&(this.material.setParameterValues({sceneHasOcludees:e.hasOccludees}),this.updateParameters())},t.prototype.ensureParameters=function(e){0===this.output&&this._updateOccludeeState(e)},t.prototype.bind=function(e,t){e.bindProgram(this.technique.program),this.technique.bindPass(e,this.material.getPassParameters(),t)},t.prototype.getPipelineState=function(e,t){return t?this.technique.opaqueOccludeeState:this.technique.pipeline},t}(f.GLMaterial),b=function(){function e(e){this.vertexBufferLayout=e}return e.prototype.allocate=function(e){return this.vertexBufferLayout.createBuffer(e)},e.prototype.elementCount=function(e){return e.indices[m.VertexAttrConstants.POSITION].length},e.prototype.write=function(e,t,r,n){d.writeDefaultAttributes(t,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,r,n),this.writeAuxpos1(e,t,r,n)},e.prototype.writeAuxpos1=function(e,t,r,n){var i=r.getField(m.VertexAttrConstants.AUXPOS1,u.BufferViewVec3f),a=t.indices[m.VertexAttrConstants.POSITION],s=t.vertexAttr[m.VertexAttrConstants.POSITION].data,o=e.transformation,c=i.typedBufferStride,l=i.typedBuffer;n*=c;for(var p=0;p<a.length;p+=2)for(var f=3*a[p],h=s[f],d=s[f+1],v=s[f+2],g=o[0]*h+o[4]*d+o[8]*v+o[12],P=o[1]*h+o[5]*d+o[9]*v+o[13],y=o[2]*h+o[6]*d+o[10]*v+o[14],x=0;x<2;++x)l[n]=g,l[n+1]=P,l[n+2]=y,n+=c},e}(),S={color:[1,1,1,1],vertexColors:!1,slicePlaneEnabled:!1,width:1,stipplePattern:null,stippleIntegerRepeats:!1,stippleOffColor:null,sceneHasOcludees:!1},q=c.vec3f64.create(),O=c.vec3f64.create(),L=c.vec3f64.create(),V=c.vec3f64.create(),D=a.createRenderScreenPointArray3(),w=a.createRenderScreenPointArray3(),B=c.vec3f64.create(),I=c.vec3f64.create(),R=l.lineSegment.create(),T=l.lineSegment.create(),M=c.vec3f64.create(),N=[a.createRenderScreenPointArray3(),a.createRenderScreenPointArray3(),a.createRenderScreenPointArray3(),a.createRenderScreenPointArray3()],E=[c.vec3f64.create(),c.vec3f64.create(),c.vec3f64.create(),c.vec3f64.create()],U=l.plane.create(),_=l.plane.create(),G=l.plane.create(),H=l.plane.create();return A}));