/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/Logger","../../../../core/maybe","../../../../core/screenUtils","../../../../chunks/vec2","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/support/lineSegment","../../../../geometry/support/plane","../../../../geometry/support/buffer/BufferView","../lib/geometryDataUtils","../lib/GLMaterial","../lib/Material","../lib/Util","./internal/bufferWriterUtils","./internal/DefaultBufferWriter","./internal/MaterialUtil","./renderers/utils","../shaders/NativeLineTechnique"],(function(e,t,r,n,i,s,o,a,c,u,l,f,p,d,h,m,g,y,P,v){"use strict";const b=r.getLogger("esri.views.3d.webgl-engine.materials.NativeLineMaterial");let C=function(e){function r(t){var r;return(r=e.call(this,t,S)||this)._techniqueConfig=new v.NativeLineTechniqueConfiguration,r}t._inheritsLoose(r,e);var i=r.prototype;return i.getTechniqueConfig=function(e,t){this._techniqueConfig.output=e,this._techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this._techniqueConfig.vertexColors=this.parameters.vertexColors,this._techniqueConfig.transparent=this.parameters.color[3]<1||this.parameters.width<1,this._techniqueConfig.draped=20===t.slot;const r=n.isSome(this.parameters.stipplePattern);return this._techniqueConfig.stippleEnabled=r,this._techniqueConfig.stippleOffColorEnabled=r&&n.isSome(this.parameters.stippleOffColor),this._techniqueConfig.sceneHasOcludees=this.parameters.sceneHasOcludees,this._techniqueConfig.stipplePreferContinuous=this.parameters.stipplePreferContinuous,this._techniqueConfig},i.getPassParameters=function(){return this.parameters},i.intersect=function(e,t,r,i,s,o,a,c,u){n.isSome(u)?y.intersectDrapedRenderLineGeometry(e,i,u,o,1,a):this.intersectLineGeometry(e,t,r,i,a)},i.intersectLineGeometry=function(e,t,r,n,i){if(!n.options.selectionMode||P.isInstanceHidden(t))return;if(!h.isTranslationMatrix(r))return void b.error("intersection assumes a translation-only matrix");const a=e.vertexAttributes.get("position").data,l=n.camera,f=U;s.copy(f,n.point);const p=2;o.set(V[0],f[0]-p,f[1]+p,0),o.set(V[1],f[0]+p,f[1]+p,0),o.set(V[2],f[0]+p,f[1]-p,0),o.set(V[3],f[0]-p,f[1]-p,0);for(let s=0;s<4;s++)if(!l.unprojectFromRenderScreen(V[s],E[s]))return;u.fromPoints(l.eye,E[0],E[1],N),u.fromPoints(l.eye,E[1],E[2],H),u.fromPoints(l.eye,E[2],E[3],j),u.fromPoints(l.eye,E[3],E[0],G);let d=Number.MAX_VALUE,m=0;for(let s=0;s<a.length-5;s+=3){if(A[0]=a[s]+r[12],A[1]=a[s+1]+r[13],A[2]=a[s+2]+r[14],x[0]=a[s+3]+r[12],x[1]=a[s+4]+r[13],x[2]=a[s+5]+r[14],u.signedDistance(N,A)<0&&u.signedDistance(N,x)<0||u.signedDistance(H,A)<0&&u.signedDistance(H,x)<0||u.signedDistance(j,A)<0&&u.signedDistance(j,x)<0||u.signedDistance(G,A)<0&&u.signedDistance(G,x)<0)continue;if(l.projectToRenderScreen(A,B),l.projectToRenderScreen(x,D),B[2]<0&&D[2]>0){o.subtract(q,A,x);const e=l.frustum,t=-u.signedDistance(e[4],A)/o.dot(q,u.normal(e[4]));o.scale(q,q,t),o.add(A,A,q),l.projectToRenderScreen(A,B)}else if(B[2]>0&&D[2]<0){o.subtract(q,x,A);const e=l.frustum,t=-u.signedDistance(e[4],x)/o.dot(q,u.normal(e[4]));o.scale(q,q,t),o.add(x,x,q),l.projectToRenderScreen(x,D)}else if(B[2]<0&&D[2]<0)continue;B[2]=0,D[2]=0;const e=c.distance2(c.fromPoints(B,D,T),f);e<d&&(d=e,o.copy(M,A),o.copy(O,x),m=s/3)}const g=n.rayBegin,y=n.rayEnd;if(d<p*p){let e=Number.MAX_VALUE;if(c.closestLineSegmentPoint(c.fromPoints(M,O,T),c.fromPoints(g,y,R),w)){o.subtract(w,w,g);const t=o.length(w);o.scale(w,w,1/t),e=t/o.distance(g,y)}i(e,w,m,!1)}},i.computeAttachmentOrigin=function(e,t){const r=e.vertexAttributes;if(!r)return!1;const n=r.get("position");return f.computeAttachmentOriginLines(n,null,!1,t)},i.requiresSlot=function(e){return 2===e||20===e},i.createGLMaterial=function(e){return 0===e.output||4===e.output?new _(e):null},i.createBufferWriter=function(){const e=this.parameters.vertexColors?g.PositionColorLayout:g.PositionLayout;return n.isNone(this.parameters.stipplePattern)?new g.DefaultBufferWriter(e):new L(e.clone().vec3f("auxpos1").vec2f("uv0"))},r}(d.Material),_=function(e){function r(){return e.apply(this,arguments)||this}t._inheritsLoose(r,e);var n=r.prototype;return n.updateParameters=function(e){return this.ensureTechnique(v.NativeLineTechnique,e)},n._updateOccludeeState=function(e){e.hasOccludees!==this._material.parameters.sceneHasOcludees&&this._material.setParameters({sceneHasOcludees:e.hasOccludees})},n.beginSlot=function(e){return 0===this._output&&this._updateOccludeeState(e),this.updateParameters(e)},n.bind=function(e,t){t.bindPass(this._material.getPassParameters(),e)},r}(p),L=function(){function e(e){this.vertexBufferLayout=e}var t=e.prototype;return t.allocate=function(e){return this.vertexBufferLayout.createBuffer(e)},t.elementCount=function(e){return e.indices.get("position").length},t.write=function(e,t,r,n){m.writeDefaultAttributes(t,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,r,n),this.writeAuxpos1(e,t,r,n),this.writeUV0(e,t,r,n)},t.writeAuxpos1=function(e,t,r,n){const i=r.getField("auxpos1",l.BufferViewVec3f),s=t.indices.get("position"),o=t.vertexAttributes.get("position").data,a=e.transformation,c=i.typedBufferStride,u=i.typedBuffer;n*=c;for(let l=0;l<s.length-1;l+=2)for(const e of[1,0]){const t=3*s[l+e],r=o[t],i=o[t+1],f=o[t+2],p=a[0]*r+a[4]*i+a[8]*f+a[12],d=a[1]*r+a[5]*i+a[9]*f+a[13],h=a[2]*r+a[6]*i+a[10]*f+a[14];u[n]=p,u[n+1]=d,u[n+2]=h,n+=c}},t.writeUV0=function(e,t,r,n){var i;const s=r.getField("uv0",l.BufferViewVec2f),a=t.indices.get("position"),c=t.vertexAttributes.get("position").data,u=null==(i=t.vertexAttributes.get("distanceToStart"))?void 0:i.data,f=e.transformation,p=s.typedBufferStride,d=s.typedBuffer;let h=0;d[n*=p]=0,d[n+1]=h,n+=p;const m=3*a[0],g=o.set(A,c[m],c[m+1],c[m+2]);f&&o.transformMat4(g,g,f);const y=x,P=a.length-1;let v=1;const b=u?(e,t,r)=>h=u[r]:(e,t,r)=>h+=o.distance(e,t);for(let l=1;l<P;l+=2){const e=3*a[l];o.set(y,c[e],c[e+1],c[e+2]),f&&o.transformMat4(y,y,f),b(g,y,v++);for(let t=0;t<2;++t)d[n]=1-t,d[n+1]=h,n+=p;o.copy(g,y)}const C=3*a[P];o.set(y,c[C],c[C+1],c[C+2]),f&&o.transformMat4(y,y,f),b(g,y,v),d[n]=1,d[n+1]=h},e}();const S={color:[1,1,1,1],vertexColors:!1,slicePlaneEnabled:!1,width:1,stipplePattern:null,stippleOffColor:null,stipplePreferContinuous:!0,sceneHasOcludees:!1,...d.materialParametersDefaults},A=a.create(),x=a.create(),q=a.create(),w=a.create(),B=i.createRenderScreenPointArray3(),D=i.createRenderScreenPointArray3(),M=a.create(),O=a.create(),T=c.create(),R=c.create(),U=a.create(),V=[i.createRenderScreenPointArray3(),i.createRenderScreenPointArray3(),i.createRenderScreenPointArray3(),i.createRenderScreenPointArray3()],E=[a.create(),a.create(),a.create(),a.create()],N=u.create(),H=u.create(),j=u.create(),G=u.create();e.NativeLineMaterial=C,Object.defineProperty(e,"__esModule",{value:!0})}));
