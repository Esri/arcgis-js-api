/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/Logger","../../../../core/maybe","../../../../core/screenUtils","../../../../chunks/vec2","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../chunks/vec4f64","../../../../geometry/support/frustum","../../../../geometry/support/lineSegment","../../../../geometry/support/plane","../../../../geometry/support/buffer/BufferView","../core/shaderLibrary/ShaderOutput","../lib/geometryDataUtils","../lib/GLMaterial","../lib/Material","../lib/RenderSlot","../lib/Util","../lib/VertexAttribute","./internal/bufferWriterUtils","./internal/DefaultBufferWriter","./internal/MaterialUtil","./renderers/utils","../shaders/NativeLineTechnique","../shaders/NativeLineTechniqueConfiguration"],(function(e,t,r,i,n,s,a,o,c,u,l,f,p,d,h,g,m,A,P,S,y,_,b,O,x,T){"use strict";var v;!function(e){e[e.START=0]="START",e[e.END=1]="END"}(v||(v={}));let R=function(e){function n(t){var r;return(r=e.call(this,t,new N)||this)._configuration=new T.NativeLineTechniqueConfiguration,r}t._inheritsLoose(n,e);var o=n.prototype;return o.getConfiguration=function(e,t){this._configuration.output=e,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.transparent=this.parameters.color[3]<1||this.parameters.width<1,this._configuration.draped=t.slot===A.RenderSlot.DRAPED_MATERIAL;const r=i.isSome(this.parameters.stipplePattern);return this._configuration.stippleEnabled=r,this._configuration.stippleOffColorEnabled=r&&i.isSome(this.parameters.stippleOffColor),this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.stipplePreferContinuous=this.parameters.stipplePreferContinuous,this._configuration},o.intersect=function(e,t,r,n,s,a,o,c,u){i.isSome(u)?b.intersectDrapedRenderLineGeometry(e,n,u,a,1,o):this._intersectLineGeometry(e,t,r,n,o)},o._intersectLineGeometry=function(e,t,i,n,o){if(!n.options.selectionMode||O.isInstanceHidden(t))return;if(!P.isTranslationMatrix(i))return void r.getLogger("esri.views.3d.webgl-engine.materials.NativeLineMaterial").error("intersection assumes a translation-only matrix");const c=e.vertexAttributes.get(S.VertexAttribute.POSITION).data,p=n.camera,d=k;s.copy(d,n.point);const h=2;a.set(G[0],d[0]-h,d[1]+h,0),a.set(G[1],d[0]+h,d[1]+h,0),a.set(G[2],d[0]+h,d[1]-h,0),a.set(G[3],d[0]-h,d[1]-h,0);for(let r=0;r<4;r++)if(!p.unprojectFromRenderScreen(G[r],W[r]))return;f.fromPoints(p.eye,W[0],W[1],X),f.fromPoints(p.eye,W[1],W[2],F),f.fromPoints(p.eye,W[2],W[3],H),f.fromPoints(p.eye,W[3],W[0],Q);let g=Number.MAX_VALUE,m=0;for(let r=0;r<c.length-5;r+=3){if(I[0]=c[r]+i[12],I[1]=c[r+1]+i[13],I[2]=c[r+2]+i[14],D[0]=c[r+3]+i[12],D[1]=c[r+4]+i[13],D[2]=c[r+5]+i[14],f.signedDistance(X,I)<0&&f.signedDistance(X,D)<0||f.signedDistance(F,I)<0&&f.signedDistance(F,D)<0||f.signedDistance(H,I)<0&&f.signedDistance(H,D)<0||f.signedDistance(Q,I)<0&&f.signedDistance(Q,D)<0)continue;if(p.projectToRenderScreen(I,w),p.projectToRenderScreen(D,C),w[2]<0&&C[2]>0){a.subtract(E,I,D);const e=p.frustum,t=-f.signedDistance(e[u.PlaneIndex.NEAR],I)/a.dot(E,f.normal(e[u.PlaneIndex.NEAR]));a.scale(E,E,t),a.add(I,I,E),p.projectToRenderScreen(I,w)}else if(w[2]>0&&C[2]<0){a.subtract(E,D,I);const e=p.frustum,t=-f.signedDistance(e[u.PlaneIndex.NEAR],D)/a.dot(E,f.normal(e[u.PlaneIndex.NEAR]));a.scale(E,E,t),a.add(D,D,E),p.projectToRenderScreen(D,C)}else if(w[2]<0&&C[2]<0)continue;w[2]=0,C[2]=0;const e=l.distance2(l.fromPoints(w,C,j),d);e<g&&(g=e,a.copy(B,I),a.copy(U,D),m=r/3)}const A=n.rayBegin,y=n.rayEnd;if(g<h*h){let e=Number.MAX_VALUE;if(l.closestLineSegmentPoint(l.fromPoints(B,U,j),l.fromPoints(A,y,q),M)){a.subtract(M,M,A);const t=a.length(M);a.scale(M,M,1/t),e=t/a.distance(A,y)}o(e,M,m,!1)}},o.computeAttachmentOrigin=function(e,t){const r=e.vertexAttributes;if(!r)return!1;const i=r.get(S.VertexAttribute.POSITION);return h.computeAttachmentOriginLines(i,null,!1,t)},o.requiresSlot=function(e,t){return!(t!==d.ShaderOutput.Color&&t!==d.ShaderOutput.Highlight&&t!==d.ShaderOutput.ObjectAndLayerIdColor||e!==A.RenderSlot.OPAQUE_MATERIAL&&e!==A.RenderSlot.DRAPED_MATERIAL)},o.createGLMaterial=function(e){return new L(e)},o.createBufferWriter=function(){const e=this.parameters.hasVertexColors?_.PositionColorLayout:_.PositionLayout;return i.isNone(this.parameters.stipplePattern)?new _.DefaultBufferWriter(e):new V(e.clone().vec3f(S.VertexAttribute.AUXPOS1).vec2f(S.VertexAttribute.UV0))},n}(m.Material),L=function(e){function r(){var t;return(t=e.apply(this,arguments)||this)._stipplePattern=null,t}t._inheritsLoose(r,e);var i=r.prototype;return i.dispose=function(){e.prototype.dispose.call(this),this._stippleTextureRepository.release(this._stipplePattern),this._stipplePattern=null},i._updateOccludeeState=function(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})},i.beginSlot=function(e){this._output===d.ShaderOutput.Color&&this._updateOccludeeState(e);const t=this._material.parameters.stipplePattern;return this._stipplePattern!==t&&(this._material.setParameters(this._stippleTextureRepository.swap(this._stipplePattern,t)),this._stipplePattern=t),this.ensureTechnique(x.NativeLineTechnique,e)},r}(g),V=function(){function e(e){this.vertexBufferLayout=e}var t=e.prototype;return t.allocate=function(e){return this.vertexBufferLayout.createBuffer(e)},t.elementCount=function(e){return e.indices.get(S.VertexAttribute.POSITION).length},t.write=function(e,t,r,i,n){y.writeDefaultAttributes(r,this.vertexBufferLayout,e,t,i,n),this._writeAuxpos1(e,r,i,n),this._writeUV0(e,r,i,n)},t._writeAuxpos1=function(e,t,r,i){const n=r.getField(S.VertexAttribute.AUXPOS1,p.BufferViewVec3f),s=t.indices.get(S.VertexAttribute.POSITION),a=t.vertexAttributes.get(S.VertexAttribute.POSITION).data,o=e,c=n.typedBufferStride,u=n.typedBuffer;i*=c;for(let l=0;l<s.length-1;l+=2)for(const e of[1,0]){const t=3*s[l+e],r=a[t],n=a[t+1],f=a[t+2],p=o[0]*r+o[4]*n+o[8]*f+o[12],d=o[1]*r+o[5]*n+o[9]*f+o[13],h=o[2]*r+o[6]*n+o[10]*f+o[14];u[i]=p,u[i+1]=d,u[i+2]=h,i+=c}},t._writeUV0=function(e,t,r,i){const n=r.getField(S.VertexAttribute.UV0,p.BufferViewVec2f),s=t.indices.get(S.VertexAttribute.POSITION),o=t.vertexAttributes.get(S.VertexAttribute.POSITION).data,c=t.vertexAttributes.get(S.VertexAttribute.DISTANCETOSTART)?.data,u=n.typedBufferStride,l=n.typedBuffer;let f=0;l[i*=u]=v.START,l[i+1]=f,i+=u;const d=3*s[0],h=a.set(I,o[d],o[d+1],o[d+2]);e&&a.transformMat4(h,h,e);const g=D,m=s.length-1;let A=1;const P=c?(e,t,r)=>f=c[r]:(e,t,r)=>f+=a.distance(e,t);for(let p=1;p<m;p+=2){const t=3*s[p];a.set(g,o[t],o[t+1],o[t+2]),e&&a.transformMat4(g,g,e),P(h,g,A++);for(let e=0;e<2;++e)l[i]=1-e,l[i+1]=f,i+=u;a.copy(h,g)}const y=3*s[m];a.set(g,o[y],o[y+1],o[y+2]),e&&a.transformMat4(g,g,e),P(h,g,A),l[i]=v.END,l[i+1]=f},e}(),N=function(e){function r(){var t;return(t=e.apply(this,arguments)||this).color=c.ONES,t.hasVertexColors=!1,t.hasSlicePlane=!1,t.width=1,t.stipplePreferContinuous=!0,t.hasOccludees=!1,t.stippleTexture=null,t}return t._inheritsLoose(r,e),r}(m.MaterialParameters);const I=o.create(),D=o.create(),E=o.create(),M=o.create(),w=n.createRenderScreenPointArray3(),C=n.createRenderScreenPointArray3(),B=o.create(),U=o.create(),j=l.create(),q=l.create(),k=o.create(),G=[n.createRenderScreenPointArray3(),n.createRenderScreenPointArray3(),n.createRenderScreenPointArray3(),n.createRenderScreenPointArray3()],W=[o.create(),o.create(),o.create(),o.create()],X=f.create(),F=f.create(),H=f.create(),Q=f.create();e.NativeLineMaterial=R,e.Parameters=N,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
