// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/Logger","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/vec2","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../support/geometryUtils","../../support/buffer/InterleavedLayout","../lib/ComponentUtils","../lib/GLMaterial","../lib/Material","../lib/Util","./internal/bufferWriters","./internal/MaterialUtil","./renderers/MergedRenderer","../shaders/NativeLinePrograms","../../../webgl/renderState"],function(e,t,r,n,i,a,o,s,c,p,l,f,u,m,g,d,v,h,P){var y=n.getLogger("esri.views.3d.webgl-engine.materials.NativeLineMaterial"),b=function(e){function t(t,r){var n=e.call(this,r)||this;return n.params=d.copyParameters(t,L),n}return r(t,e),t.prototype.setParameterValues=function(e){var t=this.params;for(var r in e)t[r]=e[r];this.notifyDirty("matChanged")},t.prototype.getParameters=function(){return this.params},t.prototype.getColor=function(){return this.params.color},t.prototype.intersect=function(e,t,r,n,i,a,o,s,c){c?this.intersectLineGeometry(e,t,r,n,i,a,o):d.intersectDrapedRenderLineGeometry(e,t,r,n,i,a,1,o)},t.prototype.intersectLineGeometry=function(e,t,r,n,i,s,p,f){if(n.enable.selectionMode&&!l.isAllHidden(t.componentVisibilities,e.componentOffsets)){if(!m.isTranslationMatrix(r))return void y.error("intersection assumes a translation-only matrix");var u=e.data.getVertexAttr().position.data,g=n.camera,d=T;a.vec2.copy(d,n.point);o.vec3.set(W[0],d[0]-2,d[1]+2,0),o.vec3.set(W[1],d[0]+2,d[1]+2,0),o.vec3.set(W[2],d[0]+2,d[1]-2,0),o.vec3.set(W[3],d[0]-2,d[1]-2,0);for(var v=0;v<4;v++)g.unprojectPoint(W[v],N[v]);c.plane.fromPoints(g.eye,N[0],N[1],j),c.plane.fromPoints(g.eye,N[1],N[2],G),c.plane.fromPoints(g.eye,N[2],N[3],H),c.plane.fromPoints(g.eye,N[3],N[0],k);for(var h=Number.MAX_VALUE,v=0;v<u.length-5;v+=3)if(A[0]=u[v]+r[12],A[1]=u[v+1]+r[13],A[2]=u[v+2]+r[14],D[0]=u[v+3]+r[12],D[1]=u[v+4]+r[13],D[2]=u[v+5]+r[14],!(c.plane.signedDistance(j,A)<0&&c.plane.signedDistance(j,D)<0||c.plane.signedDistance(G,A)<0&&c.plane.signedDistance(G,D)<0||c.plane.signedDistance(H,A)<0&&c.plane.signedDistance(H,D)<0||c.plane.signedDistance(k,A)<0&&c.plane.signedDistance(k,D)<0)){if(g.projectPoint(A,V),g.projectPoint(D,U),V[2]<0&&U[2]>0){o.vec3.subtract(M,A,D);var P=g.frustum,b=-c.plane.signedDistance(P.planes[4],A),S=b/o.vec3.dot(M,P.planes[4]);o.vec3.scale(M,M,S),o.vec3.add(A,A,M),g.projectPoint(A,V)}else if(V[2]>0&&U[2]<0){o.vec3.subtract(M,D,A);var P=g.frustum,b=-c.plane.signedDistance(P.planes[4],D),S=b/o.vec3.dot(M,P.planes[4]);o.vec3.scale(M,M,S),o.vec3.add(D,D,M),g.projectPoint(D,U)}else if(V[2]<0&&U[2]<0)continue;V[2]=0,U[2]=0;var x=c.lineSegment.distance2(c.lineSegment.fromPoints(V,U,B),d);x<h&&(h=x,o.vec3.copy(I,A),o.vec3.copy(O,D))}var L=n.rayBeginPoint,w=n.rayEndPoint;if(h<4){var C=Number.MAX_VALUE;if(c.lineSegment.closestLineSegmentPoint(c.lineSegment.fromPoints(I,O,B),c.lineSegment.fromPoints(L,w,E),R)){o.vec3.subtract(R,R,L);var X=o.vec3.length(R);o.vec3.scale(R,R,1/X),C=X/o.vec3.distance(L,w)}p(C,R)}}},t.prototype.createBufferWriter=function(){return new C(this.params)},t.prototype.createRenderer=function(e,t){return new v(e,t,this)},t.prototype.getGLMaterials=function(){return{color:S,depthShadowMap:void 0,normal:void 0,depth:void 0,highlight:x}},t}(u),S=function(e){function t(t,r,n){var i=e.call(this,t,r)||this;return i.updateParameters(),i}return r(t,e),t.prototype.updateParameters=function(){this.params=d.copyParameters(this.material.getParameters()),this.selectProgram()},t.prototype.selectProgram=function(){var e=this.params;this.program=this.programRep.getProgram(h.colorPass,{slice:e.slicePlaneEnabled,vertexColors:this.params.vertexColors}),this.pipelineState=P.makePipelineState({blending:e.color[3]<1&&P.separateBlendingParams(770,1,771,771),depthTest:{func:513},depthWrite:P.defaultDepthWriteParams,colorWrite:P.defaultColorWriteParams})},t.prototype.beginSlot=function(e){return 5===e},t.prototype.getProgram=function(){return this.program},t.prototype.bind=function(e,t){var r=this.program,n=this.params;e.bindProgram(r),e.setPipelineState(this.pipelineState),r.setUniform4fv("constantColor",n.color)},t.prototype.release=function(e){},t.prototype.bindView=function(e,t){var r=this.program,n=this.params;d.bindView(t.origin,t.view,r),n.slicePlaneEnabled&&d.bindSlicePlane(t.origin,t.slicePlane,r)},t.prototype.bindInstance=function(e,t){this.program.setUniformMatrix4fv("model",t.transformation)},t.prototype.getDrawMode=function(){return 1},t}(f),x=function(e){function t(t,r,n){var i=e.call(this,t,r)||this;return i.updateParameters(),i}return r(t,e),t.prototype.updateParameters=function(){this.params=d.copyParameters(this.material.getParameters()),this.selectProgram()},t.prototype.beginSlot=function(e){return 5===e},t.prototype.getProgram=function(){return this.program},t.prototype.selectProgram=function(){this.program=this.programRep.getProgram(h.highlightPass,{slice:this.params.slicePlaneEnabled,vertexColors:this.params.vertexColors}),this.pipelineState=P.makePipelineState({depthTest:{func:513},colorWrite:P.defaultColorWriteParams})},t.prototype.bind=function(e,t){e.bindProgram(this.program),e.setPipelineState(this.pipelineState),d.bindHighlightRendering(e,t,this.program)},t.prototype.release=function(e){},t.prototype.bindView=function(e,t){var r=this.program,n=this.params;d.bindView(t.origin,t.view,r),n.slicePlaneEnabled&&d.bindSlicePlane(t.origin,t.slicePlane,r)},t.prototype.bindInstance=function(e,t){this.program.setUniformMatrix4fv("model",t.transformation)},t.prototype.getDrawMode=function(){return 1},t}(f),L={color:[1,1,1,1],vertexColors:!1,slicePlaneEnabled:!1},w=p.newLayout().vec3f(m.VertexAttrConstants.POSITION),C=function(){function e(e){this.vertexBufferLayout=p.newLayout().vec3f(m.VertexAttrConstants.POSITION),e.vertexColors&&(this.vertexBufferLayout=w.vec4u8(m.VertexAttrConstants.COLOR))}return e.prototype.allocate=function(e){return this.vertexBufferLayout.createBuffer(e)},e.prototype.elementCount=function(e){return e.indices[m.VertexAttrConstants.POSITION].length},e.prototype.write=function(e,t,r,n){g.writeDefaultAttributes(t,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,r,n)},e}(),A=s.vec3f64.create(),D=s.vec3f64.create(),M=s.vec3f64.create(),R=s.vec3f64.create(),V=i.createRenderScreenPointArray3(),U=i.createRenderScreenPointArray3(),I=s.vec3f64.create(),O=s.vec3f64.create(),B=c.lineSegment.create(),E=c.lineSegment.create(),T=s.vec3f64.create(),W=[i.createRenderScreenPointArray3(),i.createRenderScreenPointArray3(),i.createRenderScreenPointArray3(),i.createRenderScreenPointArray3()],N=[s.vec3f64.create(),s.vec3f64.create(),s.vec3f64.create(),s.vec3f64.create()],j=c.plane.create(),G=c.plane.create(),H=c.plane.create(),k=c.plane.create();return b});