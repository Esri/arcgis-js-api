/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/Logger","../../../../core/maybe","../../../../core/screenUtils","../../../../chunks/vec2","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/support/lineSegment","../../../../geometry/support/plane","../../../../geometry/support/buffer/BufferView","../lib/geometryDataUtils","../lib/GLMaterial","../lib/Material","../lib/Util","./internal/bufferWriterUtils","./internal/DefaultBufferWriter","./internal/MaterialUtil","./renderers/utils","../shaders/NativeLineTechnique"],(function(e,t,n,i,r,s,a,o,c,u,l,f,p,h,d,m,g,P,y,v){"use strict";const b=n.getLogger("esri.views.3d.webgl-engine.materials.NativeLineMaterial");let L=function(e){function n(t){var n;return(n=e.call(this,t,S)||this).techniqueConfig=new v.NativeLineTechniqueConfiguration,n}t._inheritsLoose(n,e);var r=n.prototype;return r.getTechniqueConfig=function(e){this.techniqueConfig.output=e,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.vertexColors=this.params.vertexColors,this.techniqueConfig.transparent=this.params.color[3]<1||this.params.width<1;const t=i.isSome(this.params.stipplePattern);return this.techniqueConfig.stippleEnabled=t,this.techniqueConfig.stippleOffColorEnabled=t&&i.isSome(this.params.stippleOffColor),this.techniqueConfig.stippleIntegerRepeatsEnabled=t&&this.params.stippleIntegerRepeats,this.techniqueConfig.sceneHasOcludees=this.params.sceneHasOcludees,this.techniqueConfig},r.getPassParameters=function(){return this.params},r.intersect=function(e,t,n,i,r,s,a,o,c){c?P.intersectDrapedRenderLineGeometry(e,i,s,1,a):this.intersectLineGeometry(e,t,n,i,a)},r.intersectLineGeometry=function(e,t,n,i,r){if(!i.options.selectionMode||y.isInstanceHidden(t))return;if(!d.isTranslationMatrix(n))return void b.error("intersection assumes a translation-only matrix");const o=e.vertexAttributes.get("position").data,l=i.camera,f=E;s.copy(f,i.point);const p=2;a.set(N[0],f[0]-p,f[1]+p,0),a.set(N[1],f[0]+p,f[1]+p,0),a.set(N[2],f[0]+p,f[1]-p,0),a.set(N[3],f[0]-p,f[1]-p,0);for(let s=0;s<4;s++)if(!l.unprojectFromRenderScreen(N[s],H[s]))return;u.fromPoints(l.eye,H[0],H[1],U),u.fromPoints(l.eye,H[1],H[2],j),u.fromPoints(l.eye,H[2],H[3],V),u.fromPoints(l.eye,H[3],H[0],G);let h=Number.MAX_VALUE;for(let s=0;s<o.length-5;s+=3){if(A[0]=o[s]+n[12],A[1]=o[s+1]+n[13],A[2]=o[s+2]+n[14],_[0]=o[s+3]+n[12],_[1]=o[s+4]+n[13],_[2]=o[s+5]+n[14],u.signedDistance(U,A)<0&&u.signedDistance(U,_)<0||u.signedDistance(j,A)<0&&u.signedDistance(j,_)<0||u.signedDistance(V,A)<0&&u.signedDistance(V,_)<0||u.signedDistance(G,A)<0&&u.signedDistance(G,_)<0)continue;if(l.projectToRenderScreen(A,R),l.projectToRenderScreen(_,O),R[2]<0&&O[2]>0){a.subtract(x,A,_);const e=l.frustum,t=-u.signedDistance(e[4],A)/a.dot(x,u.normal(e[4]));a.scale(x,x,t),a.add(A,A,x),l.projectToRenderScreen(A,R)}else if(R[2]>0&&O[2]<0){a.subtract(x,_,A);const e=l.frustum,t=-u.signedDistance(e[4],_)/a.dot(x,u.normal(e[4]));a.scale(x,x,t),a.add(_,_,x),l.projectToRenderScreen(_,O)}else if(R[2]<0&&O[2]<0)continue;R[2]=0,O[2]=0;const e=c.distance2(c.fromPoints(R,O,M),f);e<h&&(h=e,a.copy(w,A),a.copy(B,_))}const m=i.rayBeginPoint,g=i.rayEndPoint;if(h<p*p){let e=Number.MAX_VALUE;if(c.closestLineSegmentPoint(c.fromPoints(w,B,M),c.fromPoints(m,g,T),D)){a.subtract(D,D,m);const t=a.length(D);a.scale(D,D,1/t),e=t/a.distance(m,g)}r(e,D)}},r.computeAttachmentOrigin=function(e,t){const n=e.vertexAttributes;if(!n)return!1;const i=n.get("position");return f.computeAttachmentOriginLines(i,null,!1,t)},r.createBufferWriter=function(){const e=this.params.vertexColors?g.PositionColorLayout:g.PositionLayout;return i.isNone(this.params.stipplePattern)?new g.DefaultBufferWriter(e):new q(e.clone().vec3f("auxpos1"))},r.getGLMaterial=function(e){return 0===e.output||4===e.output?new C(e):void 0},n}(h.Material),C=function(e){function n(t){var n;return(n=e.call(this,t)||this).updateParameters(),n}t._inheritsLoose(n,e);var i=n.prototype;return i.updateParameters=function(){this._technique=this._techniqueRep.releaseAndAcquire(v.NativeLineTechnique,this._material.getTechniqueConfig(this._output),this._technique)},i.beginSlot=function(e){return 3===e},i._updateOccludeeState=function(e){e.hasOccludees!==this._material.params.sceneHasOcludees&&(this._material.setParameterValues({sceneHasOcludees:e.hasOccludees}),this.updateParameters())},i.ensureParameters=function(e){0===this._output&&this._updateOccludeeState(e)},i.bind=function(e){this._technique.bindPass(this._material.getPassParameters(),e)},i.getPipelineState=function(e,t){return this._technique.getPipelineState(t)},n}(p),q=function(){function e(e){this.vertexBufferLayout=e}var t=e.prototype;return t.allocate=function(e){return this.vertexBufferLayout.createBuffer(e)},t.elementCount=function(e){return e.indices.get("position").length},t.write=function(e,t,n,i){m.writeDefaultAttributes(t,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,n,i),this.writeAuxpos1(e,t,n,i)},t.writeAuxpos1=function(e,t,n,i){const r=n.getField("auxpos1",l.BufferViewVec3f),s=t.indices.get("position"),a=t.vertexAttributes.get("position").data,o=e.transformation,c=r.typedBufferStride,u=r.typedBuffer;i*=c;for(let l=0;l<s.length;l+=2){const e=3*s[l],t=a[e],n=a[e+1],r=a[e+2],f=o[0]*t+o[4]*n+o[8]*r+o[12],p=o[1]*t+o[5]*n+o[9]*r+o[13],h=o[2]*t+o[6]*n+o[10]*r+o[14];for(let s=0;s<2;++s)u[i]=f,u[i+1]=p,u[i+2]=h,i+=c}},e}();const S={color:[1,1,1,1],vertexColors:!1,slicePlaneEnabled:!1,width:1,stipplePattern:null,stippleIntegerRepeats:!1,stippleOffColor:null,sceneHasOcludees:!1,...h.materialParametersDefaults},A=o.create(),_=o.create(),x=o.create(),D=o.create(),R=r.createRenderScreenPointArray3(),O=r.createRenderScreenPointArray3(),w=o.create(),B=o.create(),M=c.create(),T=c.create(),E=o.create(),N=[r.createRenderScreenPointArray3(),r.createRenderScreenPointArray3(),r.createRenderScreenPointArray3(),r.createRenderScreenPointArray3()],H=[o.create(),o.create(),o.create(),o.create()],U=u.create(),j=u.create(),V=u.create(),G=u.create();e.NativeLineMaterial=L,Object.defineProperty(e,"__esModule",{value:!0})}));
