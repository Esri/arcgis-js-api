/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/has","../../../../core/maybe","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../ViewingMode","../../support/buffer/InterleavedLayout","../core/shaderLibrary/ShaderOutput","../core/shaderLibrary/shading/Normals.glsl","../core/shaderLibrary/shading/PhysicallyBasedRenderingParameters.glsl","../lib/basicInterfaces","../lib/GLTextureMaterial","../lib/Material","../lib/OrderIndependentTransparency","../lib/RenderSlot","../lib/VertexAttribute","../lib/verticalOffsetUtils","./DefaultBufferWriter","./internal/MaterialUtil","../shaders/DefaultMaterialTechnique","../shaders/DefaultMaterialTechniqueConfiguration","../shaders/RealisticTreeTechnique"],(function(e,t,r,a,i,s,o,n,u,h,l,c,d,p,f,m,g,S,T,b,_,x,O){"use strict";let v=function(e){function r(t){var r;return(r=e.call(this,t,y)||this).supportsEdges=!0,r._configuration=new x.DefaultMaterialTechniqueConfiguration,r._vertexBufferLayout=A(r.parameters),r}t._inheritsLoose(r,e);var s=r.prototype;return s.isVisibleForOutput=function(e){return e!==u.ShaderOutput.Shadow&&e!==u.ShaderOutput.ShadowExcludeHighlight&&e!==u.ShaderOutput.ShadowHighlight||this.parameters.castShadows},s.isVisible=function(){const t=this.parameters;if(!e.prototype.isVisible.call(this)||0===t.layerOpacity)return!1;const{instanced:r,hasVertexColors:i,hasSymbolColors:s,vvColorEnabled:o}=t,n=a.isSome(r)&&r.includes("color"),u="replace"===t.colorMixMode,h=t.opacity>0,l=t.externalColor&&t.externalColor[3]>0;return i&&(n||o||s)?!!u||h:i?u?l:h:n||o||s?!!u||h:u?l:h},s.getConfiguration=function(e,t){return this._configuration.output=e,this._configuration.hasNormalTexture=!!this.parameters.normalTextureId,this._configuration.hasColorTexture=!!this.parameters.textureId,this._configuration.hasVertexTangents=this.parameters.hasVertexTangents,this._configuration.instanced=!!this.parameters.instanced,this._configuration.instancedDoublePrecision=this.parameters.instancedDoublePrecision,this._configuration.vvSize=this.parameters.vvSizeEnabled,this._configuration.hasVerticalOffset=a.isSome(this.parameters.verticalOffset),this._configuration.hasScreenSizePerspective=a.isSome(this.parameters.screenSizePerspective),this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasSliceHighlight=this.parameters.hasSliceHighlight,this._configuration.alphaDiscardMode=this.parameters.textureAlphaMode,this._configuration.normalType=this.parameters.normalType,this._configuration.transparent=this.parameters.transparent,this._configuration.writeDepth=this.parameters.writeDepth,a.isSome(this.parameters.customDepthTest)&&(this._configuration.customDepthTest=this.parameters.customDepthTest),this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.cullFace=this.parameters.hasSlicePlane?c.CullFaceOptions.None:this.parameters.cullFace,this._configuration.hasMultipassTerrain=t.multipassTerrain.enabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration.hasModelTransformation=a.isSome(this.parameters.modelTransformation),e!==u.ShaderOutput.Color&&e!==u.ShaderOutput.Alpha||(this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.hasSymbolColors=this.parameters.hasSymbolColors,this.parameters.treeRendering?this._configuration.doubleSidedMode=h.NormalsDoubleSidedMode.WindingOrder:this._configuration.doubleSidedMode=this.parameters.doubleSided&&"normal"===this.parameters.doubleSidedType?h.NormalsDoubleSidedMode.View:this.parameters.doubleSided&&"winding-order"===this.parameters.doubleSidedType?h.NormalsDoubleSidedMode.WindingOrder:h.NormalsDoubleSidedMode.None,this._configuration.instancedColor=a.isSome(this.parameters.instanced)&&this.parameters.instanced.includes("color"),this._configuration.receiveShadows=this.parameters.receiveShadows&&this.parameters.shadowMappingEnabled,this._configuration.receiveAmbientOcclusion=!!t.ssaoHelper.active&&this.parameters.receiveSSAO,this._configuration.vvColor=this.parameters.vvColorEnabled,this._configuration.textureAlphaPremultiplied=!!this.parameters.textureAlphaPremultiplied,this._configuration.pbrMode=this.parameters.usePBR?this.parameters.isSchematic?l.PBRMode.Schematic:l.PBRMode.Normal:l.PBRMode.Disabled,this._configuration.hasMetallicRoughnessTexture=!!this.parameters.metallicRoughnessTextureId,this._configuration.hasEmissionTexture=!!this.parameters.emissiveTextureId,this._configuration.hasOcclusionTexture=!!this.parameters.occlusionTextureId,this._configuration.offsetBackfaces=!(!this.parameters.transparent||!this.parameters.offsetTransparentBackfaces),this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.enableOffset=t.camera.relativeElevation<f.OITPolygonOffsetLimit,this._configuration.snowCover=this.hasSnowCover(t),this._configuration.hasColorTextureTransform=!!this.parameters.colorTextureTransformMatrix,this._configuration.hasNormalTextureTransform=!!this.parameters.normalTextureTransformMatrix,this._configuration.hasEmissionTextureTransform=!!this.parameters.emissiveTextureTransformMatrix,this._configuration.hasOcclusionTextureTransform=!!this.parameters.occlusionTextureTransformMatrix,this._configuration.hasMetallicRoughnessTextureTransform=!!this.parameters.metallicRoughnessTextureTransformMatrix),this._configuration},s.hasSnowCover=function(e){return a.isSome(e.weather)&&e.weatherVisible&&"snowy"===e.weather.type&&"enabled"===e.weather.snowCover},s.intersect=function(e,t,r,s,n,u){if(a.isSome(this.parameters.verticalOffset)){const e=r.camera;i.set(V,t[12],t[13],t[14]);let a=null;switch(r.viewingMode){case o.ViewingMode.Global:a=i.normalize(C,V);break;case o.ViewingMode.Local:a=i.copy(C,D)}let u=0;const h=i.subtract(I,V,e.eye),l=i.length(h),c=i.scale(h,h,1/l);let d=null;this.parameters.screenSizePerspective&&(d=i.dot(a,c)),u+=b.verticalOffsetAtDistance(e,l,this.parameters.verticalOffset,d??0,this.parameters.screenSizePerspective),i.scale(a,a,u),i.transformMat3(L,a,r.transform.inverseRotation),s=i.subtract(R,s,L),n=i.subtract(P,n,L)}b.intersectTriangleGeometry(e,r,s,n,S.getVerticalOffsetObject3D(r.verticalOffset),u)},s.requiresSlot=function(e,t){if(t===u.ShaderOutput.Color||t===u.ShaderOutput.Alpha||t===u.ShaderOutput.Depth||t===u.ShaderOutput.Normal||t===u.ShaderOutput.Shadow||t===u.ShaderOutput.ShadowHighlight||t===u.ShaderOutput.ShadowExcludeHighlight||t===u.ShaderOutput.Highlight||t===u.ShaderOutput.ObjectAndLayerIdColor){return e===(this.parameters.transparent?this.parameters.writeDepth?m.RenderSlot.TRANSPARENT_MATERIAL:m.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL:m.RenderSlot.OPAQUE_MATERIAL)||e===m.RenderSlot.DRAPED_MATERIAL}return!1},s.createGLMaterial=function(e){return new M(e)},s.createBufferWriter=function(){return new T.DefaultBufferWriter(this._vertexBufferLayout)},r}(p.Material),M=function(e){function r(t){return e.call(this,{...t,...t.material.parameters})||this}t._inheritsLoose(r,e);var a=r.prototype;return a._updateShadowState=function(e){e.shadowMap.enabled!==this._material.parameters.shadowMappingEnabled&&this._material.setParameters({shadowMappingEnabled:e.shadowMap.enabled})},a._updateOccludeeState=function(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})},a.beginSlot=function(e){this._output!==u.ShaderOutput.Color&&this._output!==u.ShaderOutput.Alpha||(this._updateShadowState(e),this._updateOccludeeState(e));const t=this._material.parameters;this.updateTexture(t.textureId);const r=e.camera.viewInverseTransposeMatrix;return i.set(t.origin,r[3],r[7],r[11]),this._material.setParameters(this.textureBindParameters),this.ensureTechnique(t.treeRendering?O.RealisticTreeTechnique:_.DefaultMaterialTechnique,e)},r}(d.GLTextureMaterial),w=function(e){function r(){var t;return(t=e.apply(this,arguments)||this).initTextureTransparent=!1,t.treeRendering=!1,t.hasVertexTangents=!1,t}return t._inheritsLoose(r,e),r}(_.DefaultMaterialPassParameters);const y=new w;function A(e){const t=n.newLayout().vec3f(g.VertexAttribute.POSITION).vec3f(g.VertexAttribute.NORMAL),a=e.textureId||e.normalTextureId||e.metallicRoughnessTextureId||e.emissiveTextureId||e.occlusionTextureId;return e.hasVertexTangents&&t.vec4f(g.VertexAttribute.TANGENT),a&&t.vec2f(g.VertexAttribute.UV0),e.hasVertexColors&&t.vec4u8(g.VertexAttribute.COLOR),e.hasSymbolColors&&t.vec4u8(g.VertexAttribute.SYMBOLCOLOR),r("enable-feature:objectAndLayerId-rendering")&&t.vec4u8(g.VertexAttribute.OBJECTANDLAYERIDCOLOR),t}const R=s.create(),P=s.create(),D=s.fromValues(0,0,1),C=s.create(),L=s.create(),V=s.create(),I=s.create();e.DefaultGLMaterial=M,e.DefaultMaterial=v,e.DefaultMaterialParameters=w,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
