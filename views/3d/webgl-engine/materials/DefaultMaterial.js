/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/vec3f64","../../../../chunks/vec3","../../../../chunks/mat3f64","../../support/buffer/InterleavedLayout","../lib/intersectorUtils","../lib/GLMaterialTexture","./internal/MaterialUtil","../lib/Material","./internal/bufferWriterUtils","../core/shaderLibrary/util/AlphaDiscard.glsl","../lib/OrderIndependentTransparency","../shaders/DefaultMaterialTechnique","../shaders/RealisticTreeTechnique"],(function(e,t,i,a,s,n,r,o,u,c,l,h,f,d,p){"use strict";let m=function(e){function i(t,a){var s;return(s=e.call(this,a,t,g)||this).supportsEdges=!0,s.techniqueConfig=new d.DefaultMaterialTechniqueConfiguration,s.vertexBufferLayout=i.getVertexBufferLayout(s.params),s.instanceBufferLayout=t.instanced?i.getInstanceBufferLayout(s.params):null,s}t._inheritsLoose(i,e);var s=i.prototype;return s.isVisibleInPass=function(e){return 4!==e||this.params.castShadows},s.isVisible=function(){const t=this.params;if(!e.prototype.isVisible.call(this)||0===t.layerOpacity)return!1;const i=t.instanced,a=t.vertexColors,s=t.symbolColors,n=!!i&&i.indexOf("color")>-1,r=t.vvColorEnabled,o="replace"===t.colorMixMode,u=t.opacity>0,c=t.externalColor&&t.externalColor[3]>0;return a&&(n||r||s)?!!o||u:a?o?c:u:n||r||s?!!o||u:o?c:u},s.getTechniqueConfig=function(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.hasNormalTexture=!!this.params.normalTextureId,this.techniqueConfig.hasColorTexture=!!this.params.textureId,this.techniqueConfig.vertexTangents=this.params.vertexTangents,this.techniqueConfig.instanced=!!this.params.instanced,this.techniqueConfig.instancedDoublePrecision=this.params.instancedDoublePrecision,this.techniqueConfig.vvSize=this.params.vvSizeEnabled,this.techniqueConfig.verticalOffset=null!==this.params.verticalOffset,this.techniqueConfig.screenSizePerspective=null!==this.params.screenSizePerspective,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.sliceHighlightDisabled=this.params.sliceHighlightDisabled,this.techniqueConfig.alphaDiscardMode=this.params.textureAlphaMode,this.techniqueConfig.normalsTypeDerivate="screenDerivative"===this.params.normals,this.techniqueConfig.transparent=this.params.transparent,this.techniqueConfig.writeDepth=this.params.writeDepth,this.techniqueConfig.sceneHasOcludees=this.params.sceneHasOcludees,this.techniqueConfig.cullFace=null!=this.params.cullFace?this.params.cullFace:0,0!==e&&7!==e||(this.techniqueConfig.vertexColors=this.params.vertexColors,this.techniqueConfig.symbolColors=this.params.symbolColors,this.params.treeRendering?this.techniqueConfig.doubleSidedMode=2:this.techniqueConfig.doubleSidedMode=this.params.doubleSided&&"normal"===this.params.doubleSidedType?1:this.params.doubleSided&&"winding-order"===this.params.doubleSidedType?2:0,this.techniqueConfig.instancedColor=!!this.params.instanced&&this.params.instanced.indexOf("color")>-1,this.techniqueConfig.receiveShadows=this.params.receiveShadows&&this.params.shadowMappingEnabled,this.techniqueConfig.receiveAmbientOcclusion=this.params.receiveSSAO,this.techniqueConfig.vvColor=this.params.vvColorEnabled,this.techniqueConfig.textureAlphaPremultiplied=!!this.params.textureAlphaPremultiplied,this.techniqueConfig.usePBR=this.params.usePBR,this.techniqueConfig.hasMetalnessAndRoughnessTexture=!!this.params.metallicRoughnessTextureId,this.techniqueConfig.hasEmissionTexture=!!this.params.emissiveTextureId,this.techniqueConfig.hasOcclusionTexture=!!this.params.occlusionTextureId,this.techniqueConfig.offsetBackfaces=!(!this.params.transparent||!this.params.offsetTransparentBackfaces),this.techniqueConfig.isSchematic=this.params.usePBR&&this.params.isSchematic,this.techniqueConfig.transparencyPassType=t?t.transparencyPassType:3,this.techniqueConfig.enableOffset=!t||t.camera.relativeElevation<f.OITPolygonOffsetLimit),this.techniqueConfig},s.intersect=function(e,t,i,s,n,o,c){if(null!==this.params.verticalOffset){const e=s.camera;a.set(S,i[12],i[13],i[14]);let t=null;switch(s.viewingMode){case 1:t=a.normalize(y,S);break;case 2:t=a.copy(y,q)}let r=0;if(null!==this.params.verticalOffset){const i=a.subtract(O,S,e.eye),s=a.length(i),n=a.scale(i,i,1/s);let o=null;this.params.screenSizePerspective&&(o=a.dot(t,n)),r+=u.verticalOffsetAtDistance(e,s,this.params.verticalOffset,o,this.params.screenSizePerspective)}a.scale(t,t,r),a.transformMat3(T,t,s.transform.inverseRotation),n=a.subtract(b,n,T),o=a.subtract(x,o,T)}u.intersectTriangleGeometry(e,t,s,n,o,r.getVerticalOffsetObject3D(s.verticalOffset),c)},s.getGLMaterial=function(e){if(0===e.output||7===e.output||1===e.output||2===e.output||3===e.output||4===e.output)return new v(e)},s.createBufferWriter=function(){return new C(this.vertexBufferLayout,this.instanceBufferLayout)},i.getVertexBufferLayout=function(e){const t=e.textureId||e.normalTextureId||e.metallicRoughnessTextureId||e.emissiveTextureId||e.occlusionTextureId,i=n.newLayout().vec3f("position").vec3f("normal");return e.vertexTangents&&i.vec4f("tangent"),t&&i.vec2f("uv0"),e.vertexColors&&i.vec4u8("color"),e.symbolColors&&i.vec4u8("symbolColor"),i},i.getInstanceBufferLayout=function(e){let t=n.newLayout();return t=e.instancedDoublePrecision?t.vec3f("modelOriginHi").vec3f("modelOriginLo").mat3f("model").mat3f("modelNormal"):t.mat4f("model").mat4f("modelNormal"),e.instanced&&e.instanced.indexOf("color")>-1&&(t=t.vec4f("instanceColor")),e.instanced&&e.instanced.indexOf("featureAttribute")>-1&&(t=t.vec4f("instanceFeatureAttribute")),t},i}(c.Material),v=function(e){function i(t){var i;const a=t.material;return(i=e.call(this,{...t,...a.params})||this).updateParameters(),i}t._inheritsLoose(i,e);var a=i.prototype;return a.updateParameters=function(e){const t=this.material.params;this.updateTexture(t.textureId),this.technique=t.treeRendering?this.techniqueRep.acquireAndReleaseExisting(p.RealisticTreeTechnique,this.material.getTechniqueConfig(this.output,e),this.technique):this.techniqueRep.acquireAndReleaseExisting(d.DefaultMaterialTechnique,this.material.getTechniqueConfig(this.output,e),this.technique)},a.selectPipelines=function(){},a._updateShadowState=function(e){e.shadowMappingEnabled!==this.material.params.shadowMappingEnabled&&this.material.setParameterValues({shadowMappingEnabled:e.shadowMappingEnabled})},a._updateOccludeeState=function(e){e.hasOccludees!==this.material.params.sceneHasOcludees&&this.material.setParameterValues({sceneHasOcludees:e.hasOccludees})},a.ensureParameters=function(e){0!==this.output&&7!==this.output||(this._updateShadowState(e),this._updateOccludeeState(e)),this.updateParameters(e)},a.bind=function(e,t){e.bindProgram(this.technique.program),this.technique.bindPass(e,this.material.params,t),this.bindTexture(e,this.technique.program)},a.beginSlot=function(e){return e===(this.material.params.transparent?this.material.params.writeDepth?5:8:3)},a.getPipelineState=function(e,t){return this.technique.getPipelineState(t)},i}(o);const g={textureId:void 0,initTextureTransparent:!1,isSchematic:!1,usePBR:!1,normalTextureId:void 0,vertexTangents:!1,occlusionTextureId:void 0,emissiveTextureId:void 0,metallicRoughnessTextureId:void 0,emissiveFactor:[0,0,0],mrrFactors:[0,1,.5],ambient:[.2,.2,.2],diffuse:[.8,.8,.8],externalColor:[1,1,1,1],colorMixMode:"multiply",opacity:1,layerOpacity:1,vertexColors:!1,symbolColors:!1,doubleSided:!1,doubleSidedType:"normal",cullFace:void 0,instanced:void 0,instancedDoublePrecision:!1,normals:"default",receiveSSAO:!0,receiveShadows:!0,castShadows:!0,shadowMappingEnabled:!1,verticalOffset:null,screenSizePerspective:null,slicePlaneEnabled:!1,sliceHighlightDisabled:!1,offsetTransparentBackfaces:!1,vvSizeEnabled:!1,vvSizeMinSize:[1,1,1],vvSizeMaxSize:[100,100,100],vvSizeOffset:[0,0,0],vvSizeFactor:[1,1,1],vvSizeValue:[1,1,1],vvColorEnabled:!1,vvColorValues:[0,0,0,0,0,0,0,0],vvColorColors:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],vvSymbolAnchor:[0,0,0],vvSymbolRotationMatrix:s.create(),transparent:!1,writeDepth:!0,textureAlphaMode:0,textureAlphaCutoff:h.defaultMaskAlphaCutoff,textureAlphaPremultiplied:!1,sceneHasOcludees:!1,...c.materialParametersDefaults};let C=function(){function e(e,t){this.vertexBufferLayout=e,this.instanceBufferLayout=t}var t=e.prototype;return t.allocate=function(e){return this.vertexBufferLayout.createBuffer(e)},t.elementCount=function(e){return e.indices.position.length},t.write=function(e,t,i,a){l.writeDefaultAttributes(t,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,i,a)},e}();const b=i.create(),x=i.create(),q=i.fromValues(0,0,1),y=i.create(),T=i.create(),S=i.create(),O=i.create();e.COLOR_GAMMA=2.1,e.DefaultMaterial=m,Object.defineProperty(e,"__esModule",{value:!0})}));
