/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/has","../../../../core/maybe","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../ViewingMode","../../support/buffer/InterleavedLayout","../core/shaderLibrary/ShaderOutput","../core/shaderLibrary/attributes/NormalAttribute.glsl","../core/shaderLibrary/shading/Normals.glsl","../core/shaderLibrary/shading/PhysicallyBasedRenderingParameters.glsl","../lib/basicInterfaces","../lib/GLTextureMaterial","../lib/Material","../lib/OrderIndependentTransparency","../lib/RenderSlot","../lib/VertexAttribute","../lib/verticalOffsetUtils","./internal/bufferWriterUtils","./internal/MaterialUtil","../shaders/DefaultMaterialTechnique","../shaders/DefaultMaterialTechniqueConfiguration","../shaders/RealisticTreeTechnique"],(function(e,t,r,a,i,s,n,o,u,c,l,h,d,f,p,m,g,S,T,b,O,x,_,v){"use strict";let A=function(e){function r(t){var r;return(r=e.call(this,t,L)||this).supportsEdges=!0,r._configuration=new _.DefaultMaterialTechniqueConfiguration,r._vertexBufferLayout=R(r.parameters),r._instanceBufferLayout=t.instanced?w(r.parameters):null,r}t._inheritsLoose(r,e);var s=r.prototype;return s.isVisibleForOutput=function(e){return e!==u.ShaderOutput.Shadow&&e!==u.ShaderOutput.ShadowExludeHighlight&&e!==u.ShaderOutput.ShadowHighlight||this.parameters.castShadows},s.isVisible=function(){const t=this.parameters;if(!e.prototype.isVisible.call(this)||0===t.layerOpacity)return!1;const{instanced:r,hasVertexColors:i,hasSymbolColors:s,vvColorEnabled:n}=t,o=a.isSome(r)&&r.includes("color"),u="replace"===t.colorMixMode,c=t.opacity>0,l=t.externalColor&&t.externalColor[3]>0;return i&&(o||n||s)?!!u||c:i?u?l:c:o||n||s?!!u||c:u?l:c},s.getConfiguration=function(e,t){return this._configuration.output=e,this._configuration.hasNormalTexture=!!this.parameters.normalTextureId,this._configuration.hasColorTexture=!!this.parameters.textureId,this._configuration.hasVertexTangents=this.parameters.hasVertexTangents,this._configuration.instanced=!!this.parameters.instanced,this._configuration.instancedDoublePrecision=this.parameters.instancedDoublePrecision,this._configuration.vvSize=this.parameters.vvSizeEnabled,this._configuration.hasVerticalOffset=a.isSome(this.parameters.verticalOffset),this._configuration.hasScreenSizePerspective=a.isSome(this.parameters.screenSizePerspective),this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasSliceHighlight=this.parameters.hasSliceHighlight,this._configuration.alphaDiscardMode=this.parameters.textureAlphaMode,this._configuration.normalType="screenDerivative"===this.parameters.normals?c.NormalAttributeType.ScreenDerivative:c.NormalAttributeType.Attribute,this._configuration.transparent=this.parameters.transparent,this._configuration.writeDepth=this.parameters.writeDepth,a.isSome(this.parameters.customDepthTest)&&(this._configuration.customDepthTest=this.parameters.customDepthTest),this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.cullFace=this.parameters.hasSlicePlane?d.CullFaceOptions.None:this.parameters.cullFace,this._configuration.hasMultipassTerrain=t.multipassTerrain.enabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration.hasModelTransformation=a.isSome(this.parameters.modelTransformation),e!==u.ShaderOutput.Color&&e!==u.ShaderOutput.Alpha||(this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.hasSymbolColors=this.parameters.hasSymbolColors,this.parameters.treeRendering?this._configuration.doubleSidedMode=l.NormalsDoubleSidedMode.WindingOrder:this._configuration.doubleSidedMode=this.parameters.doubleSided&&"normal"===this.parameters.doubleSidedType?l.NormalsDoubleSidedMode.View:this.parameters.doubleSided&&"winding-order"===this.parameters.doubleSidedType?l.NormalsDoubleSidedMode.WindingOrder:l.NormalsDoubleSidedMode.None,this._configuration.instancedColor=a.isSome(this.parameters.instanced)&&this.parameters.instanced.includes("color"),this._configuration.receiveShadows=this.parameters.receiveShadows&&this.parameters.shadowMappingEnabled,this._configuration.receiveAmbientOcclusion=!!t.ssaoHelper.ready&&this.parameters.receiveSSAO,this._configuration.vvColor=this.parameters.vvColorEnabled,this._configuration.textureAlphaPremultiplied=!!this.parameters.textureAlphaPremultiplied,this._configuration.pbrMode=this.parameters.usePBR?this.parameters.isSchematic?h.PBRMode.Schematic:h.PBRMode.Normal:h.PBRMode.Disabled,this._configuration.hasMetallicRoughnessTexture=!!this.parameters.metallicRoughnessTextureId,this._configuration.hasEmissionTexture=!!this.parameters.emissiveTextureId,this._configuration.hasOcclusionTexture=!!this.parameters.occlusionTextureId,this._configuration.offsetBackfaces=!(!this.parameters.transparent||!this.parameters.offsetTransparentBackfaces),this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.enableOffset=t.camera.relativeElevation<m.OITPolygonOffsetLimit,this._configuration.snowCover=this.hasSnowCover(t),this._configuration.hasColorTextureTransform=!!this.parameters.colorTextureTransformMatrix,this._configuration.hasNormalTextureTransform=!!this.parameters.normalTextureTransformMatrix,this._configuration.hasEmissionTextureTransform=!!this.parameters.emissiveTextureTransformMatrix,this._configuration.hasOcclusionTextureTransform=!!this.parameters.occlusionTextureTransformMatrix,this._configuration.hasMetallicRoughnessTextureTransform=!!this.parameters.metallicRoughnessTextureTransformMatrix),this._configuration},s.hasSnowCover=function(e){return a.isSome(e.weather)&&e.weatherVisible&&"snowy"===e.weather.type&&"enabled"===e.weather.snowCover},s.intersect=function(e,t,r,s,o,u,c){if(a.isSome(this.parameters.verticalOffset)){const e=s.camera;i.set(N,r[12],r[13],r[14]);let t=null;switch(s.viewingMode){case n.ViewingMode.Global:t=i.normalize(P,N);break;case n.ViewingMode.Local:t=i.copy(P,E)}let a=0;const c=i.subtract(B,N,e.eye),l=i.length(c),h=i.scale(c,c,1/l);let d=null;this.parameters.screenSizePerspective&&(d=i.dot(t,h)),a+=O.verticalOffsetAtDistance(e,l,this.parameters.verticalOffset,d,this.parameters.screenSizePerspective),i.scale(t,t,a),i.transformMat3(V,t,s.transform.inverseRotation),o=i.subtract(I,o,V),u=i.subtract(C,u,V)}O.intersectTriangleGeometry(e,t,s,o,u,T.getVerticalOffsetObject3D(s.verticalOffset),c)},s.requiresSlot=function(e,t){if(t===u.ShaderOutput.Color||t===u.ShaderOutput.Alpha||t===u.ShaderOutput.Depth||t===u.ShaderOutput.Normal||t===u.ShaderOutput.Shadow||t===u.ShaderOutput.ShadowHighlight||t===u.ShaderOutput.ShadowExludeHighlight||t===u.ShaderOutput.Highlight||t===u.ShaderOutput.ObjectAndLayerIdColor){return e===(this.parameters.transparent?this.parameters.writeDepth?g.RenderSlot.TRANSPARENT_MATERIAL:g.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL:g.RenderSlot.OPAQUE_MATERIAL)||e===g.RenderSlot.DRAPED_MATERIAL||t===u.ShaderOutput.ObjectAndLayerIdColor}return!1},s.createGLMaterial=function(e){return new M(e)},s.createBufferWriter=function(){return new D(this._vertexBufferLayout,this._instanceBufferLayout)},r}(p.Material),M=function(e){function r(t){return e.call(this,{...t,...t.material.parameters})||this}t._inheritsLoose(r,e);var a=r.prototype;return a._updateParameters=function(e){const t=this._material.parameters;this.updateTexture(t.textureId);const r=e.camera.viewInverseTransposeMatrix;return i.set(t.origin,r[3],r[7],r[11]),this._material.setParameters(this.textureBindParameters),this.ensureTechnique(t.treeRendering?v.RealisticTreeTechnique:x.DefaultMaterialTechnique,e)},a._updateShadowState=function(e){e.shadowMap.enabled!==this._material.parameters.shadowMappingEnabled&&this._material.setParameters({shadowMappingEnabled:e.shadowMap.enabled})},a._updateOccludeeState=function(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})},a.beginSlot=function(e){return this._output!==u.ShaderOutput.Color&&this._output!==u.ShaderOutput.Alpha||(this._updateShadowState(e),this._updateOccludeeState(e)),this._updateParameters(e)},r}(f.GLTextureMaterial),y=function(e){function r(){var t;return(t=e.apply(this,arguments)||this).initTextureTransparent=!1,t.treeRendering=!1,t.hasVertexTangents=!1,t}return t._inheritsLoose(r,e),r}(x.DefaultMaterialPassParameters);const L=new y;let D=function(){function e(e,t){this.vertexBufferLayout=e,this.instanceBufferLayout=t}var t=e.prototype;return t.allocate=function(e){return this.vertexBufferLayout.createBuffer(e)},t.elementCount=function(e){return e.indices.get(S.VertexAttribute.POSITION).length},t.write=function(e,t,r,a,i){b.writeDefaultAttributes(r,this.vertexBufferLayout,e,t,a,i)},e}();function R(e){const t=e.textureId||e.normalTextureId||e.metallicRoughnessTextureId||e.emissiveTextureId||e.occlusionTextureId,a=o.newLayout().vec3f(S.VertexAttribute.POSITION).vec3f(S.VertexAttribute.NORMAL);return e.hasVertexTangents&&a.vec4f(S.VertexAttribute.TANGENT),t&&a.vec2f(S.VertexAttribute.UV0),e.hasVertexColors&&a.vec4u8(S.VertexAttribute.COLOR),e.hasSymbolColors&&a.vec4u8(S.VertexAttribute.SYMBOLCOLOR),r("enable-feature:objectAndLayerId-rendering")&&a.vec4u8(S.VertexAttribute.OBJECTANDLAYERIDCOLOR),a}function w(e){let t=o.newLayout();return t=e.instancedDoublePrecision?t.vec3f(S.VertexAttribute.MODELORIGINHI).vec3f(S.VertexAttribute.MODELORIGINLO).mat3f(S.VertexAttribute.MODEL).mat3f(S.VertexAttribute.MODELNORMAL):t.mat4f(S.VertexAttribute.MODEL).mat4f(S.VertexAttribute.MODELNORMAL),a.isSome(e.instanced)&&e.instanced.includes("color")&&(t=t.vec4f(S.VertexAttribute.INSTANCECOLOR)),a.isSome(e.instanced)&&e.instanced.includes("featureAttribute")&&(t=t.vec4f(S.VertexAttribute.INSTANCEFEATUREATTRIBUTE)),a.isSome(e.instanced)&&e.instanced.includes("objectAndLayerIdColor")&&(t=t.vec4u8(S.VertexAttribute.OBJECTANDLAYERIDCOLOR_INSTANCED)),t}const I=s.create(),C=s.create(),E=s.fromValues(0,0,1),P=s.create(),V=s.create(),N=s.create(),B=s.create();e.DefaultGLMaterial=M,e.DefaultMaterial=A,e.DefaultMaterialParameters=y,e.getInstanceBufferLayout=w,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
