/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/mat3f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../support/buffer/InterleavedLayout","../core/shaderLibrary/util/AlphaDiscard.glsl","../lib/GLMaterialTexture","../lib/Material","../lib/OrderIndependentTransparency","../lib/verticalOffsetUtils","./internal/bufferWriterUtils","./internal/MaterialUtil","../shaders/DefaultMaterialTechnique","../shaders/RealisticTreeTechnique"],(function(e,t,i,r,a,s,n,o,l,u,c,h,f,d,p){"use strict";let m=function(e){function i(t){var i;return(i=e.call(this,t,g)||this).supportsEdges=!0,i.techniqueConfig=new d.DefaultMaterialTechniqueConfiguration,i.vertexBufferLayout=C(i.parameters),i.instanceBufferLayout=t.instanced?x(i.parameters):null,i}t._inheritsLoose(i,e);var a=i.prototype;return a.isVisibleInPass=function(e){return 4!==e&&6!==e&&7!==e||this.parameters.castShadows},a.isVisible=function(){const t=this.parameters;if(!e.prototype.isVisible.call(this)||0===t.layerOpacity)return!1;const i=t.instanced,r=t.vertexColors,a=t.symbolColors,s=!!i&&i.indexOf("color")>-1,n=t.vvColorEnabled,o="replace"===t.colorMixMode,l=t.opacity>0,u=t.externalColor&&t.externalColor[3]>0;return r&&(s||n||a)?!!o||l:r?o?u:l:s||n||a?!!o||l:o?u:l},a.getTechniqueConfig=function(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.hasNormalTexture=!!this.parameters.normalTextureId,this.techniqueConfig.hasColorTexture=!!this.parameters.textureId,this.techniqueConfig.vertexTangents=this.parameters.vertexTangents,this.techniqueConfig.instanced=!!this.parameters.instanced,this.techniqueConfig.instancedDoublePrecision=this.parameters.instancedDoublePrecision,this.techniqueConfig.vvSize=this.parameters.vvSizeEnabled,this.techniqueConfig.verticalOffset=null!==this.parameters.verticalOffset,this.techniqueConfig.screenSizePerspective=null!==this.parameters.screenSizePerspective,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.sliceHighlightDisabled=this.parameters.sliceHighlightDisabled,this.techniqueConfig.alphaDiscardMode=this.parameters.textureAlphaMode,this.techniqueConfig.normalsTypeDerivate="screenDerivative"===this.parameters.normals,this.techniqueConfig.transparent=this.parameters.transparent,this.techniqueConfig.writeDepth=this.parameters.writeDepth,this.techniqueConfig.sceneHasOcludees=this.parameters.sceneHasOcludees,this.techniqueConfig.cullFace=this.parameters.slicePlaneEnabled?0:this.parameters.cullFace,this.techniqueConfig.multipassTerrainEnabled=t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=t.cullAboveGround,0!==e&&7!==e||(this.techniqueConfig.vertexColors=this.parameters.vertexColors,this.techniqueConfig.symbolColors=this.parameters.symbolColors,this.parameters.treeRendering?this.techniqueConfig.doubleSidedMode=2:this.techniqueConfig.doubleSidedMode=this.parameters.doubleSided&&"normal"===this.parameters.doubleSidedType?1:this.parameters.doubleSided&&"winding-order"===this.parameters.doubleSidedType?2:0,this.techniqueConfig.instancedColor=!!this.parameters.instanced&&this.parameters.instanced.indexOf("color")>-1,this.techniqueConfig.receiveShadows=this.parameters.receiveShadows&&this.parameters.shadowMappingEnabled,this.techniqueConfig.receiveAmbientOcclusion=!!t.ssaoEnabled&&this.parameters.receiveSSAO,this.techniqueConfig.vvColor=this.parameters.vvColorEnabled,this.techniqueConfig.textureAlphaPremultiplied=!!this.parameters.textureAlphaPremultiplied,this.techniqueConfig.usePBR=this.parameters.usePBR,this.techniqueConfig.hasMetalnessAndRoughnessTexture=!!this.parameters.metallicRoughnessTextureId,this.techniqueConfig.hasEmissionTexture=!!this.parameters.emissiveTextureId,this.techniqueConfig.hasOcclusionTexture=!!this.parameters.occlusionTextureId,this.techniqueConfig.offsetBackfaces=!(!this.parameters.transparent||!this.parameters.offsetTransparentBackfaces),this.techniqueConfig.isSchematic=this.parameters.usePBR&&this.parameters.isSchematic,this.techniqueConfig.transparencyPassType=t.transparencyPassType,this.techniqueConfig.enableOffset=t.camera.relativeElevation<u.OITPolygonOffsetLimit),this.techniqueConfig},a.intersect=function(e,t,i,a,s,n,o){if(null!==this.parameters.verticalOffset){const e=a.camera;r.set(M,i[12],i[13],i[14]);let t=null;switch(a.viewingMode){case 1:t=r.normalize(S,M);break;case 2:t=r.copy(S,y)}let o=0;if(null!==this.parameters.verticalOffset){const i=r.subtract(P,M,e.eye),a=r.length(i),s=r.scale(i,i,1/a);let n=null;this.parameters.screenSizePerspective&&(n=r.dot(t,s)),o+=f.verticalOffsetAtDistance(e,a,this.parameters.verticalOffset,n,this.parameters.screenSizePerspective)}r.scale(t,t,o),r.transformMat3(O,t,a.transform.inverseRotation),s=r.subtract(T,s,O),n=r.subtract(q,n,O)}f.intersectTriangleGeometry(e,t,a,s,n,c.getVerticalOffsetObject3D(a.verticalOffset),o)},a.requiresSlot=function(e){return e===(this.parameters.transparent?this.parameters.writeDepth?4:7:2)||20===e},a.createGLMaterial=function(e){return 0===e.output||7===e.output||1===e.output||2===e.output||3===e.output||4===e.output?new v(e):null},a.createBufferWriter=function(){return new b(this.vertexBufferLayout,this.instanceBufferLayout)},i}(l.Material),v=function(e){function i(t){return e.call(this,{...t,...t.material.parameters})||this}t._inheritsLoose(i,e);var r=i.prototype;return r.updateParameters=function(e){const t=this._material.parameters;return this.updateTexture(t.textureId),this.ensureTechnique(t.treeRendering?p.RealisticTreeTechnique:d.DefaultMaterialTechnique,e)},r._updateShadowState=function(e){e.shadowMappingEnabled!==this._material.parameters.shadowMappingEnabled&&this._material.setParameters({shadowMappingEnabled:e.shadowMappingEnabled})},r._updateOccludeeState=function(e){e.hasOccludees!==this._material.parameters.sceneHasOcludees&&this._material.setParameters({sceneHasOcludees:e.hasOccludees})},r.beginSlot=function(e){return 0!==this._output&&7!==this._output||(this._updateShadowState(e),this._updateOccludeeState(e)),this.updateParameters(e)},r.bind=function(e,t){t.bindPass(this._material.parameters,e),this.bindTextures(t.program)},i}(o);const g={textureId:void 0,initTextureTransparent:!1,isSchematic:!1,usePBR:!1,normalTextureId:void 0,vertexTangents:!1,occlusionTextureId:void 0,emissiveTextureId:void 0,metallicRoughnessTextureId:void 0,emissiveFactor:[0,0,0],mrrFactors:[0,1,.5],ambient:[.2,.2,.2],diffuse:[.8,.8,.8],externalColor:[1,1,1,1],colorMixMode:"multiply",opacity:1,layerOpacity:1,vertexColors:!1,symbolColors:!1,doubleSided:!1,doubleSidedType:"normal",cullFace:2,instanced:void 0,instancedDoublePrecision:!1,normals:"default",receiveSSAO:!0,receiveShadows:!0,castShadows:!0,shadowMappingEnabled:!1,verticalOffset:null,screenSizePerspective:null,slicePlaneEnabled:!1,sliceHighlightDisabled:!1,offsetTransparentBackfaces:!1,vvSizeEnabled:!1,vvSizeMinSize:[1,1,1],vvSizeMaxSize:[100,100,100],vvSizeOffset:[0,0,0],vvSizeFactor:[1,1,1],vvSizeValue:[1,1,1],vvColorEnabled:!1,vvColorValues:[0,0,0,0,0,0,0,0],vvColorColors:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],vvSymbolAnchor:[0,0,0],vvSymbolRotationMatrix:i.create(),transparent:!1,writeDepth:!0,textureAlphaMode:0,textureAlphaCutoff:n.defaultMaskAlphaCutoff,textureAlphaPremultiplied:!1,sceneHasOcludees:!1,...l.materialParametersDefaults};let b=function(){function e(e,t){this.vertexBufferLayout=e,this.instanceBufferLayout=t}var t=e.prototype;return t.allocate=function(e){return this.vertexBufferLayout.createBuffer(e)},t.elementCount=function(e){return e.indices.get("position").length},t.write=function(e,t,i,r){h.writeDefaultAttributes(t,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,i,r)},e}();function C(e){const t=e.textureId||e.normalTextureId||e.metallicRoughnessTextureId||e.emissiveTextureId||e.occlusionTextureId,i=s.newLayout().vec3f("position").vec3f("normal");return e.vertexTangents&&i.vec4f("tangent"),t&&i.vec2f("uv0"),e.vertexColors&&i.vec4u8("color"),e.symbolColors&&i.vec4u8("symbolColor"),i}function x(e){let t=s.newLayout();return t=e.instancedDoublePrecision?t.vec3f("modelOriginHi").vec3f("modelOriginLo").mat3f("model").mat3f("modelNormal"):t.mat4f("model").mat4f("modelNormal"),e.instanced&&e.instanced.indexOf("color")>-1&&(t=t.vec4f("instanceColor")),e.instanced&&e.instanced.indexOf("featureAttribute")>-1&&(t=t.vec4f("instanceFeatureAttribute")),t}const T=a.create(),q=a.create(),y=a.fromValues(0,0,1),S=a.create(),O=a.create(),M=a.create(),P=a.create();e.DefaultMaterial=m,e.getInstanceBufferLayout=x,Object.defineProperty(e,"__esModule",{value:!0})}));
