/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../chunks/mat3f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../ViewingMode","../../support/buffer/InterleavedLayout","../core/shaderLibrary/ShaderOutputOptions","../core/shaderLibrary/shading/Normals.glsl","../core/shaderLibrary/util/AlphaDiscard.glsl","../lib/basicInterfaces","../lib/GLMaterialTexture","../lib/Material","../lib/OrderIndependentTransparency","../lib/RenderPass","../lib/RenderSlot","../lib/VertexAttribute","../lib/verticalOffsetUtils","./internal/bufferWriterUtils","./internal/MaterialUtil","../shaders/DefaultMaterialTechnique","../shaders/RealisticTreeTechnique"],(function(e,t,i,r,a,s,n,o,u,l,c,h,d,p,f,m,v,b,g,T,S,O,C){"use strict";let A=function(e){function r(t){var i;return(i=e.call(this,t,M)||this).supportsEdges=!0,i.techniqueConfig=new O.DefaultMaterialTechniqueConfiguration,i.vertexBufferLayout=E(i.parameters),i.instanceBufferLayout=t.instanced?L(i.parameters):null,i}t._inheritsLoose(r,e);var s=r.prototype;return s.isVisibleInPass=function(e){return e!==m.RenderPass.MATERIAL_DEPTH_SHADOWMAP_ALL&&e!==m.RenderPass.MATERIAL_DEPTH_SHADOWMAP_DEFAULT&&e!==m.RenderPass.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT||this.parameters.castShadows},s.isVisible=function(){const t=this.parameters;if(!e.prototype.isVisible.call(this)||0===t.layerOpacity)return!1;const i=t.instanced,r=t.vertexColors,a=t.symbolColors,s=!!i&&i.indexOf("color")>-1,n=t.vvColorEnabled,o="replace"===t.colorMixMode,u=t.opacity>0,l=t.externalColor&&t.externalColor[3]>0;return r&&(s||n||a)?!!o||u:r?o?l:u:s||n||a?!!o||u:o?l:u},s.getTechniqueConfig=function(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.hasNormalTexture=!!this.parameters.normalTextureId,this.techniqueConfig.hasColorTexture=!!this.parameters.textureId,this.techniqueConfig.vertexTangents=this.parameters.vertexTangents,this.techniqueConfig.instanced=!!this.parameters.instanced,this.techniqueConfig.instancedDoublePrecision=this.parameters.instancedDoublePrecision,this.techniqueConfig.vvSize=this.parameters.vvSizeEnabled,this.techniqueConfig.verticalOffset=null!==this.parameters.verticalOffset,this.techniqueConfig.screenSizePerspective=null!==this.parameters.screenSizePerspective,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.sliceHighlightDisabled=this.parameters.sliceHighlightDisabled,this.techniqueConfig.alphaDiscardMode=this.parameters.textureAlphaMode,this.techniqueConfig.normalsTypeDerivate="screenDerivative"===this.parameters.normals,this.techniqueConfig.transparent=this.parameters.transparent,this.techniqueConfig.writeDepth=this.parameters.writeDepth,i.isSome(this.parameters.customDepthTest)&&(this.techniqueConfig.customDepthTest=this.parameters.customDepthTest),this.techniqueConfig.sceneHasOcludees=this.parameters.sceneHasOcludees,this.techniqueConfig.cullFace=this.parameters.slicePlaneEnabled?h.CullFaceOptions.None:this.parameters.cullFace,this.techniqueConfig.multipassTerrainEnabled=t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=t.cullAboveGround,this.techniqueConfig.hasModelTransformation=i.isSome(this.parameters.modelTransformation),e!==u.ShaderOutput.Color&&e!==u.ShaderOutput.Alpha||(this.techniqueConfig.vertexColors=this.parameters.vertexColors,this.techniqueConfig.symbolColors=this.parameters.symbolColors,this.parameters.treeRendering?this.techniqueConfig.doubleSidedMode=l.NormalsDoubleSidedMode.WindingOrder:this.techniqueConfig.doubleSidedMode=this.parameters.doubleSided&&"normal"===this.parameters.doubleSidedType?l.NormalsDoubleSidedMode.View:this.parameters.doubleSided&&"winding-order"===this.parameters.doubleSidedType?l.NormalsDoubleSidedMode.WindingOrder:l.NormalsDoubleSidedMode.None,this.techniqueConfig.instancedColor=!!this.parameters.instanced&&this.parameters.instanced.indexOf("color")>-1,this.techniqueConfig.receiveShadows=this.parameters.receiveShadows&&this.parameters.shadowMappingEnabled,this.techniqueConfig.receiveAmbientOcclusion=!!t.ssaoEnabled&&this.parameters.receiveSSAO,this.techniqueConfig.vvColor=this.parameters.vvColorEnabled,this.techniqueConfig.textureAlphaPremultiplied=!!this.parameters.textureAlphaPremultiplied,this.techniqueConfig.usePBR=this.parameters.usePBR,this.techniqueConfig.hasMetalnessAndRoughnessTexture=!!this.parameters.metallicRoughnessTextureId,this.techniqueConfig.hasEmissionTexture=!!this.parameters.emissiveTextureId,this.techniqueConfig.hasOcclusionTexture=!!this.parameters.occlusionTextureId,this.techniqueConfig.offsetBackfaces=!(!this.parameters.transparent||!this.parameters.offsetTransparentBackfaces),this.techniqueConfig.isSchematic=this.parameters.usePBR&&this.parameters.isSchematic,this.techniqueConfig.transparencyPassType=t.transparencyPassType,this.techniqueConfig.enableOffset=t.camera.relativeElevation<f.OITPolygonOffsetLimit),this.techniqueConfig},s.intersect=function(e,t,i,r,s,o,u){if(null!==this.parameters.verticalOffset){const e=r.camera;a.set(_,i[12],i[13],i[14]);let t=null;switch(r.viewingMode){case n.ViewingMode.Global:t=a.normalize(R,_);break;case n.ViewingMode.Local:t=a.copy(R,y)}let u=0;if(null!==this.parameters.verticalOffset){const i=a.subtract(w,_,e.eye),r=a.length(i),s=a.scale(i,i,1/r);let n=null;this.parameters.screenSizePerspective&&(n=a.dot(t,s)),u+=S.verticalOffsetAtDistance(e,r,this.parameters.verticalOffset,n,this.parameters.screenSizePerspective)}a.scale(t,t,u),a.transformMat3(I,t,r.transform.inverseRotation),s=a.subtract(P,s,I),o=a.subtract(q,o,I)}S.intersectTriangleGeometry(e,t,r,s,o,g.getVerticalOffsetObject3D(r.verticalOffset),u)},s.requiresSlot=function(e){return e===(this.parameters.transparent?this.parameters.writeDepth?v.RenderSlot.TRANSPARENT_MATERIAL:v.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL:v.RenderSlot.OPAQUE_MATERIAL)||e===v.RenderSlot.DRAPED_MATERIAL},s.createGLMaterial=function(e){return e.output===u.ShaderOutput.Color||e.output===u.ShaderOutput.Alpha||e.output===u.ShaderOutput.Depth||e.output===u.ShaderOutput.Normal||e.output===u.ShaderOutput.Shadow||e.output===u.ShaderOutput.Highlight?new x(e):null},s.createBufferWriter=function(){return new D(this.vertexBufferLayout,this.instanceBufferLayout)},r}(p.Material),x=function(e){function i(t){return e.call(this,{...t,...t.material.parameters})||this}t._inheritsLoose(i,e);var r=i.prototype;return r.updateParameters=function(e){const t=this._material.parameters;return this.updateTexture(t.textureId),this.ensureTechnique(t.treeRendering?C.RealisticTreeTechnique:O.DefaultMaterialTechnique,e)},r._updateShadowState=function(e){e.shadowMappingEnabled!==this._material.parameters.shadowMappingEnabled&&this._material.setParameters({shadowMappingEnabled:e.shadowMappingEnabled})},r._updateOccludeeState=function(e){e.hasOccludees!==this._material.parameters.sceneHasOcludees&&this._material.setParameters({sceneHasOcludees:e.hasOccludees})},r.beginSlot=function(e){return this._output!==u.ShaderOutput.Color&&this._output!==u.ShaderOutput.Alpha||(this._updateShadowState(e),this._updateOccludeeState(e)),this.updateParameters(e)},r.bind=function(e,t){t.bindPass(this._material.parameters,e),this.bindTextures(t.program)},i}(d);const M={textureId:void 0,initTextureTransparent:!1,isSchematic:!1,usePBR:!1,normalTextureId:void 0,vertexTangents:!1,occlusionTextureId:void 0,emissiveTextureId:void 0,metallicRoughnessTextureId:void 0,emissiveFactor:[0,0,0],mrrFactors:[0,1,.5],ambient:[.2,.2,.2],diffuse:[.8,.8,.8],externalColor:[1,1,1,1],colorMixMode:"multiply",opacity:1,layerOpacity:1,vertexColors:!1,symbolColors:!1,doubleSided:!1,doubleSidedType:"normal",cullFace:h.CullFaceOptions.Back,instanced:void 0,instancedDoublePrecision:!1,normals:"default",receiveSSAO:!0,fillLightsEnabled:!0,receiveShadows:!0,castShadows:!0,shadowMappingEnabled:!1,verticalOffset:null,screenSizePerspective:null,slicePlaneEnabled:!1,sliceHighlightDisabled:!1,offsetTransparentBackfaces:!1,vvSizeEnabled:!1,vvSizeMinSize:[1,1,1],vvSizeMaxSize:[100,100,100],vvSizeOffset:[0,0,0],vvSizeFactor:[1,1,1],vvSizeValue:[1,1,1],vvColorEnabled:!1,vvColorValues:[0,0,0,0,0,0,0,0],vvColorColors:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],vvSymbolAnchor:[0,0,0],vvSymbolRotationMatrix:r.create(),modelTransformation:null,transparent:!1,writeDepth:!0,customDepthTest:h.DepthTestFunction.Less,textureAlphaMode:h.AlphaDiscardMode.Blend,textureAlphaCutoff:c.defaultMaskAlphaCutoff,textureAlphaPremultiplied:!1,sceneHasOcludees:!1,...p.DefaultMaterialParameters};let D=function(){function e(e,t){this.vertexBufferLayout=e,this.instanceBufferLayout=t}var t=e.prototype;return t.allocate=function(e){return this.vertexBufferLayout.createBuffer(e)},t.elementCount=function(e){return e.indices.get(b.VertexAttribute.POSITION).length},t.write=function(e,t,i,r){T.writeDefaultAttributes(t,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,i,r)},e}();function E(e){const t=e.textureId||e.normalTextureId||e.metallicRoughnessTextureId||e.emissiveTextureId||e.occlusionTextureId,i=o.newLayout().vec3f(b.VertexAttribute.POSITION).vec3f(b.VertexAttribute.NORMAL);return e.vertexTangents&&i.vec4f(b.VertexAttribute.TANGENT),t&&i.vec2f(b.VertexAttribute.UV0),e.vertexColors&&i.vec4u8(b.VertexAttribute.COLOR),e.symbolColors&&i.vec4u8(b.VertexAttribute.SYMBOLCOLOR),i}function L(e){let t=o.newLayout();return t=e.instancedDoublePrecision?t.vec3f(b.VertexAttribute.MODELORIGINHI).vec3f(b.VertexAttribute.MODELORIGINLO).mat3f(b.VertexAttribute.MODEL).mat3f(b.VertexAttribute.MODELNORMAL):t.mat4f(b.VertexAttribute.MODEL).mat4f(b.VertexAttribute.MODELNORMAL),e.instanced&&e.instanced.indexOf("color")>-1&&(t=t.vec4f(b.VertexAttribute.INSTANCECOLOR)),e.instanced&&e.instanced.indexOf("featureAttribute")>-1&&(t=t.vec4f(b.VertexAttribute.INSTANCEFEATUREATTRIBUTE)),t}const P=s.create(),q=s.create(),y=s.fromValues(0,0,1),R=s.create(),I=s.create(),_=s.create(),w=s.create();e.DefaultMaterial=A,e.getInstanceBufferLayout=L,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
