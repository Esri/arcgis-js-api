/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/maybe","../../../../../chunks/mat4","../../../../../core/MapUtils","../../../../../chunks/mat4f64","../../../support/buffer/glUtil","../../lib/Util","../../../../webgl/BufferObject","../../../../webgl/Util","../../../../webgl/VertexArrayObject","./utils","../../lib/ResizableFloat32Array","../WaterGLMaterial","./Instance","../../statistics/RendererPerformanceInfo"],(function(e,t,s,a,i,n,r,o,l,d,u,c,h,f,m){"use strict";let g=function(){function i(e,t,s){this.type="MergedRenderer",this._dataByOrigin=new Map,this._hasHighlights=!1,this._hasOccludees=!1,this._rctx=e,this._material=s,this._materialRep=t,this._glMaterials=u.acquireMaterials(this._material,this._materialRep),this._bufferWriter=s.createBufferWriter()}var g=i.prototype;return g.dispose=function(){u.releaseMaterials(this._material,this._materialRep),this._dataByOrigin&&(this._dataByOrigin.forEach((e=>{e.vao.dispose(!0),e.vao=null})),this._dataByOrigin.clear(),this._dataByOrigin=null),this._glMaterials&&(this._glMaterials.forEach((e=>{e&&e.dispose()})),this._glMaterials.clear(),this._glMaterials=null)},g.modify=function(e){this.updateGeometries(e.toUpdate),this.addAndRemoveGeometries(e.toAdd,e.toRemove),this.updateRenderCommands()},g.addAndRemoveGeometries=function(e,t){const s=this._bufferWriter,a=s.vertexBufferLayout,i=a.stride/4,n=this._dataByOrigin,o=function(e,t,s,a){const i=new Map,n=t.vertexBufferLayout.stride/4,r=(s,a)=>{const r=s.origin,o=e.get(r.id);let l=i.get(r.id);null==l&&(l={optimalCount:null==o?0:o.optimalCount,sparseCount:null==o?0:o.buffer.size,toAdd:[],toRemove:[],origin:r.vec3},i.set(r.id,l));const d=t.elementCount(s.data)*n;a?(l.optimalCount+=d,l.sparseCount+=d,l.toAdd.push(s)):(l.optimalCount-=d,l.toRemove.push(s))};for(const e of s)r(e,!0);for(const e of a)r(e,!1);return i}(n,s,e,t);o.forEach(((e,t)=>{o.delete(t);const s=e.optimalCount,l=e.sparseCount;let d=n.get(t);if(null==d)r.assert(s>0),d=this.createData(a,s,e.origin),n.set(t,d);else if(0===s)return d.vao.dispose(!0),d.vao=null,void n.delete(t);const u=s<e.sparseCount/2,c=u?s:l,h=p,f=d.buffer.size,m=d.buffer.array,g=d.buffer.resize(c,!1);u||g?this.removeAndRebuild(d,e.toRemove,i,m,h):e.toRemove.length>0?(this.removeByErasing(d,e.toRemove,i,h),e.toAdd.length>0&&(h.end=f)):(h.begin=f,h.end=f);const b=y;r.setMatrixTranslation3(b,-e.origin[0],-e.origin[1],-e.origin[2]),this.append(d,e.toAdd,i,b,h);const C=d.vao.vertexBuffers.geometry;if(C.byteSize!==d.buffer.array.buffer.byteLength)C.setData(d.buffer.array);else{const{begin:e,end:t}=h;if(e<t){const s=d.buffer.array,a=4,i=e*a,n=t*a;C.setSubData(s,i,i,n)}}d.drawCommandsDirty=!0}))},g.updateGeometries=function(e){const t=this._bufferWriter,s=t.vertexBufferLayout.stride/4;for(const a of e){const e=a.updateType,i=a.renderGeometry,n=this._dataByOrigin.get(i.origin.id),o=n&&n.instances.get(i.uniqueName);if(!o)return;if(1&e&&(o.isVisible=i.instanceParameters.visible),9&e){const e=i.instanceParameters.visible;o.hasHighlights=!!i.instanceParameters.highlights&&e}if(16&e&&(o.hasOccludees=!!i.instanceParameters.occludees),6&e){const e=n.buffer.array,a=n.vao;u.calculateTransformRelToOrigin(i,b,C),t.write({transformation:b,invTranspTransformation:C},i.data,t.vertexBufferLayout.createView(e.buffer),o.from),r.assert(o.from+t.elementCount(i.data)===o.to,"material VBO layout has changed"),a.vertexBuffers.geometry.setSubData(e,o.from*s*4,o.from*s*4,o.to*s*4)}n.drawCommandsDirty=!0}},g.updateRenderCommands=function(){this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach((e=>{e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,a.someMap(e.instances,(t=>(t.isVisible?(t.hasHighlights&&(this._hasHighlights=!0,e.hasHighlights=!0),t.hasOccludees&&(this._hasOccludees=!0,e.hasOccludees=!0)):e.hasHiddenInstances=!0,e.hasHiddenInstances&&e.hasHighlights&&e.hasOccludees)))}));this._dataByOrigin.forEach((e=>{e.drawCommandsDirty&&((e=>{if(e.drawCommandsDefault=null,e.drawCommandsHighlight=null,e.drawCommandsOccludees=null,e.stats={default:0,highlight:0,occludees:0},0===e.instances.size)return;if(!(e.hasOccludees||e.hasHighlights||e.hasHiddenInstances)){const t=4*e.buffer.size/l.getStride(e.vao.layout.geometry);return e.drawCommandsDefault=[{first:0,count:t}],void(e.stats={default:t,highlight:0,occludees:0})}const t=f.sortInstancesAccordingToRange([...e.instances.values()]);e.drawCommandsDefault=[],e.drawCommandsHighlight=[],e.drawCommandsOccludees=[];for(const s of t)s.isVisible&&(s.hasOccludees?f.addOrMerge(e.drawCommandsOccludees,s):f.addOrMerge(e.drawCommandsDefault,s),s.hasHighlights&&f.addOrMerge(e.drawCommandsHighlight,s));const s=e=>{let t=0;for(const s of e)t+=s.count;return t/3};e.stats={default:s(e.drawCommandsDefault),highlight:s(e.drawCommandsHighlight),occludees:s(e.drawCommandsOccludees)}})(e),e.drawCommandsDirty=!1)}))},g.updateLogic=function(e){return this._material.update(e)},g.render=function(e,s,a,i){const n=this._rctx,r=this._glMaterials.get(s.pass),o=5===s.pass;let l=e;if(3===s.pass&&null===l&&(l=22),!r||2!==r.ensureResources(n)||null!=l&&!r.beginSlot(l)||o&&!this._hasHighlights)return!1;r.ensureParameters(a);const d=r.getTechnique(),u=r.getPipelineState(l,!1);n.setPipelineState(u),r.bind(n,a);let c=!1;return this._dataByOrigin.forEach((e=>{if(t.isNone(e.drawCommandsDefault)&&t.isNone(e.drawCommandsHighlight)&&t.isNone(e.drawCommandsOccludees))return;if(o&&!e.hasHighlights)return;a.origin=e.origin,d.bindDraw(a),d.ensureAttributeLocations(e.vao),n.bindVAO(e.vao);const s=d.primitiveType;let h=o?e.drawCommandsHighlight:e.drawCommandsDefault;const f=o?e.stats.highlight:e.stats.default;if(t.isSome(h)&&(this.renderCommands(n,s,h),m.addToRenderStats(h.length,f,i),c=!0),!o&&(h=e.drawCommandsOccludees,t.isSome(h))){const t=r.getPipelineState(l,!0);n.setPipelineState(t),this.renderCommands(n,s,h),n.setPipelineState(u),m.addToRenderStats(h.length,e.stats.occludees,i),c=!0}})),c},g.renderCommands=function(e,t,s){for(let a=0;a<s.length;a++)e.drawArrays(t,s[a].first,s[a].count)},g.createData=function(e,t,s){return{instances:new Map,vao:new d(this._rctx,this._material.vertexAttributeLocations,{geometry:n.glLayout(e)},{geometry:o.createVertex(this._rctx,35044)}),buffer:new c.ResizableFloat32Array(t),optimalCount:0,origin:s,hasHiddenInstances:!1,hasHighlights:!1,hasOccludees:!1,drawCommandsDirty:!1,drawCommandsDefault:null,drawCommandsOccludees:null,drawCommandsHighlight:null,stats:{default:0,highlight:0,occludees:0}}},g.removeAndRebuild=function(e,t,s,a,i){for(const a of t){const t=a.uniqueName,i=e.instances.get(t);e.optimalCount-=(i.to-i.from)*s,e.instances.delete(t)}let n=0;const r=e.buffer.array;i.begin=0,i.end=0;let o=-1,l=-1,d=0;e.instances.forEach((e=>{const t=e.from*s,i=e.to*s,u=i-t;o!==l&&l!==t?(r.set(a.subarray(o,l),d),d+=l-o,o=t):-1===o&&(o=t),l=i,e.from=n/s,n+=u,e.to=n/s})),o!==l&&r.set(a.subarray(o,l),d),i.end=n},g.removeByErasing=function(e,t,s,a){a.begin=1/0,a.end=-1/0;let i=-1,n=-1;for(const r of t){const t=r.uniqueName,o=e.instances.get(t),l=o.from*s,d=o.to*s;i!==n&&n!==l?(e.buffer.erase(i,n),i=l):-1===i&&(i=l),n=d,e.instances.delete(t),e.optimalCount-=d-l,l<a.begin&&(a.begin=l),d>a.end&&(a.end=d)}i!==n&&e.buffer.erase(i,n)},g.append=function(e,a,i,n,o){const l=this._bufferWriter;for(const d of a){const a=t.isSome(d.transformation)?s.multiply(b,n,d.transformation):n;s.invert(C,a),s.transpose(C,C);const u=o.end;l.write({transformation:a,invTranspTransformation:C},d.data,l.vertexBufferLayout.createView(e.buffer.array.buffer),o.end/i);const c=l.elementCount(d.data)*i,h=u+c;r.assert(null==e.instances.get(d.uniqueName));const m=d.instanceParameters.visible,g=!!d.instanceParameters.highlights&&m,p=!!d.instanceParameters.occludees,y=new f.Instance(u/i,h/i,m,g,p);e.instances.set(d.uniqueName,y),e.optimalCount+=c,o.end+=c}},e._createClass(i,[{key:"isEmpty",get:function(){return 0===this._dataByOrigin.size}},{key:"hasHighlights",get:function(){return this._hasHighlights}},{key:"hasOccludees",get:function(){return this._hasOccludees}},{key:"hasWater",get:function(){return!this.isEmpty&&a.someMap(this._glMaterials,(e=>e instanceof h.WaterGLMaterial))}},{key:"rendersOccluded",get:function(){return!this.isEmpty&&1!==this._material.renderOccluded}},{key:"test",get:function(){return{material:this._material,glMaterials:this._glMaterials}}}]),i}();const p={begin:0,end:0},y=i.create(),b=i.create(),C=i.create();return g}));
