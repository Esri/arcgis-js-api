/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/MapUtils","../../../../../core/maybe","../../../../../core/PooledArray","../../../../../chunks/mat4","../../../../../chunks/mat4f64","../../../support/buffer/glUtil","../../core/shaderLibrary/ShaderOutput","../../lib/GLMaterials","../../lib/Material","../../lib/ModelDirtyTypes","../../lib/Util","../DrawParameters","../WaterMaterial","./Instance","./MergedGeometryBuffer","./MergedGeometryBufferPool","./utils"],(function(e,t,r,a,s,i,n,o,d,l,h,c,u,m,f,g,y,w,_){"use strict";let p=function(){function e(e,t,r){this._rctx=e,this._materialRepository=t,this._material=r,this.type="MergedRenderer",this._dataByOrigin=new Map,this._renderCommandData=new s,this._hasHighlights=!1,this._hasOccludees=!1,this._glMaterials=new l.GLMaterials(this._material,this._materialRepository),this._bufferWriter=r.createBufferWriter(),this._bufferPool=new w.MergedGeometryBufferPool(e,r.vertexAttributeLocations,o.glLayout(this._bufferWriter.vertexBufferLayout))}var n=e.prototype;return n.dispose=function(){this._glMaterials.destroy(),this._dataByOrigin.forEach((e=>e.geometry.dispose())),this._dataByOrigin.clear(),this._bufferPool.dispose()},n.modify=function(e){this._updateGeometries(e.updates),this._addAndRemoveGeometries(e.adds,e.removes),this._updateDrawCommands()},n._addAndRemoveGeometries=function(e,t){const r=this._bufferWriter,a=r.vertexBufferLayout.stride/4,s=this._dataByOrigin,i=O(e,t);i.forEach(((e,t)=>{i.delete(t);const n=e.add.reduce(((e,t)=>e+r.elementCount(t.data)),0);let o=s.get(t);if(null==o)u.assert(0===e.remove.length),o=new M(e.origin,new y.MergedGeometryBuffer(this._bufferPool,n*a)),s.set(t,o);else if(0===e.add.length&&o.instances.size===e.remove.length)return o.geometry.dispose(),void s.delete(t);let d=0;o.instances.forEach((e=>d+=e.to-e.from));const l=e.remove.reduce(((e,t)=>e+r.elementCount(t.data)),0),h=o.geometry.size,c=(d+n-l)*a,m=c>y.BLOCK_SIZE&&(c<h/2||h-c>1048576),f=H;if(m?this._removeAndRebuild(o,e.remove,a,c,f):e.remove.length>0&&this._remove(o,e.remove,a,f),e.add.length>0){const t=R;u.setMatrixTranslation3(t,-e.origin[0],-e.origin[1],-e.origin[2]),this._add(o,e.add,a,t,f)}const g=o.geometry.buffer.vao.vertexBuffers.geometry;B(f),f.forAll((({from:e,to:t})=>{if(e<t){const r=o.geometry.buffer.array;g.setSubData(r,e,e,t)}})),f.clear(),o.drawCommandsDirty=!0}))},n._updateGeometries=function(e){const t=this._bufferWriter,r=t.vertexBufferLayout.stride/4;for(const a of e){const e=a.renderGeometry,s=this._dataByOrigin.get(e.origin.id),i=s&&s.instances.get(e.id);if(!i)return;const n=a.updateType;if(n&c.DirtyState.VISIBILITIES&&(i.isVisible=e.instanceParameters.visible),n&(c.DirtyState.HIGHLIGHTS|c.DirtyState.VISIBILITIES)){const t=e.instanceParameters.visible;i.hasHighlights=!!e.instanceParameters.highlights&&t}if(n&c.DirtyState.OCCLUDEES&&(i.hasOccludees=!!e.instanceParameters.occludees),n&(c.DirtyState.VERTEXATTRS|c.DirtyState.TRANSFORMATION)){const{array:a,vao:n}=s.geometry.buffer;_.calculateTransformRelativeToOrigin(e,I,E),t.write(I,E,e.data,t.vertexBufferLayout.createView(a.buffer),i.from),u.assert(i.from+t.elementCount(e.data)===i.to,"material VBO layout has changed"),n.vertexBuffers.geometry.setSubData(a,i.from*r,i.from*r,i.to*r)}s.drawCommandsDirty=!0}},n._updateDrawCommands=function(){this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach((e=>{e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,r.someMap(e.instances,(t=>(t.isVisible?(t.hasHighlights&&(this._hasHighlights=!0,e.hasHighlights=!0),t.hasOccludees&&(this._hasOccludees=!0,e.hasOccludees=!0)):e.hasHiddenInstances=!0,e.hasHiddenInstances&&e.hasHighlights&&e.hasOccludees)))}));const e=e=>{if(e.drawCommandsDefault.clear(),e.drawCommandsHighlight.clear(),e.drawCommandsOccludees.clear(),e.drawCommandsShadowHighlightRest.clear(),0===e.instances.size)return;if(!v(e)){const t=e.drawCommandsDefault.pushNew();return t.first=1/0,t.count=0,e.instances.forEach((e=>{t.first=Math.min(t.first,e.from),t.count=Math.max(t.count,e.to)})),void(t.count-=t.first)}const t=g.sortInstancesByRange(e.instances);for(const r of t)r.isVisible&&(r.hasOccludees?g.addOrMerge(e.drawCommandsOccludees,r):g.addOrMerge(e.drawCommandsDefault,r),r.hasHighlights?g.addOrMerge(e.drawCommandsHighlight,r):g.addOrMerge(e.drawCommandsShadowHighlightRest,r))};this._dataByOrigin.forEach((t=>{t.drawCommandsDirty&&(e(t),t.drawCommandsDirty=!1)}))},n.updateAnimation=function(e){return this._material.update(e)},n.requiresSlot=function(e,t){return this._material.requiresSlot(e,t)},n.render=function(e,t){if(!this.requiresSlot(t.slot,e))return!1;const r=e===d.ShaderOutput.Highlight||e===d.ShaderOutput.ShadowHighlight;if(r&&!this._hasHighlights)return!1;const s=e===d.ShaderOutput.ShadowExludeHighlight,i=!(r||s);if(this._dataByOrigin.forEach((e=>{if(r&&!e.hasHighlights)return;const t=(r?e.drawCommandsHighlight:s&&v(e)?e.drawCommandsShadowHighlightRest:e.drawCommandsDefault)||null,a=i&&e.drawCommandsOccludees||null;(t?.length||a?.length)&&this._renderCommandData.push(new D(e.origin,e.geometry,t,a))})),0===this._renderCommandData.length)return!1;const n=this._rctx,o=this._glMaterials.load(n,t.slot,e);if(a.isNone(o))return this._renderCommandData.clear(),!1;const l=o.beginSlot(t),h=n.bindTechnique(l,this._material.parameters,t);return this._renderCommandData.forAll((e=>{h.bindDraw(e,t,this._material.parameters);const{geometry:r,renderCommands:s,occludeeCommands:i}=e;l.ensureAttributeLocations(r.buffer.vao),n.bindVAO(r.buffer.vao);const o=l.primitiveType;a.isSome(s)&&s.length>0&&(l.bindPipelineState(n,t.slot,!1),s.forAll((e=>n.drawArrays(o,e.first,e.count)))),a.isSome(i)&&i.length>0&&(l.bindPipelineState(n,t.slot,!0),i.forAll((e=>n.drawArrays(o,e.first,e.count))))})),this._renderCommandData.clear(),!0},n._removeAndRebuild=function(e,t,r,a,s){for(const l of t)e.instances.delete(l.id);const i=g.sortInstancesByRange(e.instances);e.instances.clear();const n=e.geometry.size,o=e.geometry.allocate(a);let d=0;for(const l of i){const t=l.from*r,a=l.to*r;o.copy(d,t,a),l.from=d/r,d+=a-t,l.to=d/r,e.instances.set(l.id,l)}s.push(new g.BufferRange(0,o.hasNewBuffer?e.geometry.buffer.array.length:n)),o.dispose(),e.geometry.erase(d,s.back().to),e.holes.clear()},n._remove=function(e,t,r,a){for(const s of t){const t=s.id,i=e.instances.get(t),n=i.from*r,o=i.to*r;e.geometry.erase(n,o),e.holes.push(new g.BufferRange(i.from,i.to)),e.instances.delete(t),a.push(new g.BufferRange(n,o))}B(e.holes)},n._add=function(e,t,r,s,n){if(0===t.length)return;const o=this._bufferWriter;let d=o.vertexBufferLayout.createView(e.geometry.buffer.array.buffer);const l=e.holes.length>0;let h=Number.MAX_SAFE_INTEGER,c=Number.MIN_SAFE_INTEGER;for(const m of t){const t=a.isSome(m.transformation)?i.multiply(I,s,m.transformation):s;i.invert(E,t);const f=i.transpose(E,E),y=o.elementCount(m.data),w=y*r;let _=S(e.holes,y);a.isNone(_)&&(_=e.geometry.size/r,e.geometry.grow(w),d=o.vertexBufferLayout.createView(e.geometry.buffer.array.buffer)),o.write(t,f,m.data,d,_);const p=m.instanceParameters.visible,b=!!m.instanceParameters.highlights&&p,O=!!m.instanceParameters.occludees,C=new g.Instance(m.id,_,_+y,p,b,O);u.assert(null==e.instances.get(m.id)),e.instances.set(m.id,C),l?n.push(new g.BufferRange(C.from*r,C.to*r)):(h=Math.min(C.from,h),c=Math.max(C.to,c))}l||n.push(new g.BufferRange(h*r,c*r))},t._createClass(e,[{key:"isEmpty",get:function(){return 0===this._dataByOrigin.size}},{key:"hasHighlights",get:function(){return this._hasHighlights}},{key:"hasOccludees",get:function(){return this._hasOccludees}},{key:"hasWater",get:function(){return!this.isEmpty&&this._material instanceof f.WaterMaterial}},{key:"rendersOccluded",get:function(){return!this.isEmpty&&this._material.renderOccluded!==h.RenderOccludedFlag.Occlude}},{key:"test",get:function(){return{material:this._material,glMaterials:this._glMaterials,dataByOrigin:this._dataByOrigin}}}]),e}(),b=function(e){this.origin=e,this.add=new Array,this.remove=new Array};function O(e,t){const r=new Map;for(const a of e)C(r,a,!0);for(const a of t)C(r,a,!1);return r}function C(e,t,r){const s=t.origin;if(a.isNone(s))return;let i=e.get(s.id);null==i&&(i=new b(s.vec3),e.set(s.id,i)),r?i.add.push(t):i.remove.push(t)}function v(e){return e.hasOccludees||e.hasHighlights||e.hasHiddenInstances}function S(e,t){let r;if(!e.some((e=>!(e.to-e.from<t)&&(r=e,!0))))return null;const a=r.from;return r.from+=t,r.from>=r.to&&e.removeUnordered(r),a}function B(e){const t=new Map;e.forAll((e=>t.set(e.from,e)));let r=!0;for(;r;)r=!1,e.forEach((a=>{const s=t.get(a.to);s&&(a.to=s.to,t.delete(s.from),e.removeUnordered(s),r=!0)}))}let M=function(e,t){this.origin=e,this.geometry=t,this.instances=new Map,this.holes=new s({deallocator:null}),this.hasHiddenInstances=!1,this.hasHighlights=!1,this.hasOccludees=!1,this.drawCommandsDirty=!1,this.drawCommandsDefault=new s({allocator:e=>e||new g.DrawCommand,deallocator:e=>e}),this.drawCommandsHighlight=new s({allocator:e=>e||new g.DrawCommand,deallocator:e=>e}),this.drawCommandsOccludees=new s({allocator:e=>e||new g.DrawCommand,deallocator:e=>e}),this.drawCommandsShadowHighlightRest=new s({allocator:e=>e||new g.DrawCommand,deallocator:e=>e})},D=function(e){function r(t,r,a,s){var i;return(i=e.call(this,t)||this).geometry=r,i.renderCommands=a,i.occludeeCommands=s,i}return t._inheritsLoose(r,e),r}(m.DrawParameters);const H=new s({deallocator:null}),R=n.create(),I=n.create(),E=n.create();e.MergedRenderer=p,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
