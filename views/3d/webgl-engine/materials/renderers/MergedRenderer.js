/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/MapUtils","../../../../../core/maybe","../../../../../core/PooledArray","../../../../../chunks/mat4","../../../../../chunks/mat4f64","../../../support/buffer/glUtil","../../lib/GLMaterials","../../lib/Material","../../lib/ModelDirtyTypes","../../lib/RenderPass","../../lib/Util","../WaterMaterial","./Instance","./MergedGeometryBuffer","./MergedGeometryBufferPool","./utils"],(function(e,t,r,s,i,n,a,o,d,l,f,u,h,c,m,g,_,y){"use strict";let b=function(){function e(e,t,r){this._rctx=e,this._materialRepository=t,this._material=r,this.type="MergedRenderer",this._dataByOrigin=new Map,this._renderCommandData=new i,this._hasHighlights=!1,this._hasOccludees=!1,this._glMaterials=new d.GLMaterials(this._material,this._materialRepository),this._bufferWriter=r.createBufferWriter(),this._bufferPool=new _.MergedGeometryBufferPool(e,r.vertexAttributeLocations,o.glLayout(this._bufferWriter.vertexBufferLayout))}var a=e.prototype;return a.dispose=function(){this._glMaterials.destroy(),this._dataByOrigin.forEach((e=>e.buffer.dispose())),this._dataByOrigin.clear(),this._bufferPool.dispose()},a.modify=function(e){this._updateGeometries(e.updates),this._addAndRemoveGeometries(e.adds,e.removes),this._updateRenderCommands()},a._addAndRemoveGeometries=function(e,t){const r=this._bufferWriter,s=r.vertexBufferLayout.stride/4,i=this._dataByOrigin,n=p(e,t);n.forEach(((e,t)=>{n.delete(t);const a=e.toAdd.reduce(((e,t)=>e+r.elementCount(t.data)),0);let o=i.get(t);if(null==o)h.assert(0===e.toRemove.length),o=new R(e.origin,new g.MergedGeometryBuffer(this._bufferPool,a*s)),i.set(t,o);else if(0===e.toAdd.length&&o.instances.size===e.toRemove.length)return o.buffer.dispose(),void i.delete(t);let d=0;o.instances.forEach((e=>d+=e.to-e.from));const l=e.toRemove.reduce(((e,t)=>e+r.elementCount(t.data)),0),f=o.buffer.size,u=(d+a-l)*s,c=A;if(u<f/2?this._removeAndRebuild(o,e.toRemove,s,u,c):e.toRemove.length>0&&this._remove(o,e.toRemove,s,c),e.toAdd.length>0){const t=B;h.setMatrixTranslation3(t,-e.origin[0],-e.origin[1],-e.origin[2]),this._add(o,e.toAdd,s,t,c)}const m=o.buffer.vao.vertexBuffers.geometry;C(c),c.forAll((({from:e,to:t})=>{if(e<t){const r=o.buffer.array,s=4,i=e*s,n=t*s;m.setSubData(r,i,i,n)}})),c.clear(),o.drawCommandsDirty=!0}))},a._updateGeometries=function(e){const t=this._bufferWriter,r=t.vertexBufferLayout.stride/4;for(const s of e){const e=s.renderGeometry,i=this._dataByOrigin.get(e.origin.id),n=i&&i.instances.get(e.id);if(!n)return;const a=s.updateType;if(a&f.ModelDirty.State.VISIBILITIES&&(n.isVisible=e.instanceParameters.visible),a&(f.ModelDirty.State.HIGHLIGHTS|f.ModelDirty.State.VISIBILITIES)){const t=e.instanceParameters.visible;n.hasHighlights=!!e.instanceParameters.highlights&&t}if(a&f.ModelDirty.State.OCCLUDEES&&(n.hasOccludees=!!e.instanceParameters.occludees),a&(f.ModelDirty.State.VERTEXATTRS|f.ModelDirty.State.TRANSFORMATION)){const{array:s,vao:a}=i.buffer;y.calculateTransformRelativeToOrigin(e,S,D),t.write({transformation:S,invTranspTransformation:D},e.data,t.vertexBufferLayout.createView(s.buffer),n.from),h.assert(n.from+t.elementCount(e.data)===n.to,"material VBO layout has changed"),a.vertexBuffers.geometry.setSubData(s,n.from*r*4,n.from*r*4,n.to*r*4)}i.drawCommandsDirty=!0}},a._updateRenderCommands=function(){this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach((e=>{e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,r.someMap(e.instances,(t=>(t.isVisible?(t.hasHighlights&&(this._hasHighlights=!0,e.hasHighlights=!0),t.hasOccludees&&(this._hasOccludees=!0,e.hasOccludees=!0)):e.hasHiddenInstances=!0,e.hasHiddenInstances&&e.hasHighlights&&e.hasOccludees)))}));const e=e=>{if(e.drawCommandsDefault=null,e.drawCommandsHighlight=null,e.drawCommandsOccludees=null,e.drawCommandsShadowHighlightRest=null,0===e.instances.size)return;if(!v(e)){const t=this._bufferWriter.vertexBufferLayout.stride,r=4*e.buffer.size/t;return void(e.drawCommandsDefault=[{first:0,count:r}])}const t=m.sortInstancesByRange(e.instances);e.drawCommandsDefault=[],e.drawCommandsHighlight=[],e.drawCommandsOccludees=[],e.drawCommandsShadowHighlightRest=[];for(const r of t)r.isVisible&&(r.hasOccludees?m.addOrMerge(e.drawCommandsOccludees,r):m.addOrMerge(e.drawCommandsDefault,r),r.hasHighlights?m.addOrMerge(e.drawCommandsHighlight,r):m.addOrMerge(e.drawCommandsShadowHighlightRest,r))};this._dataByOrigin.forEach((t=>{t.drawCommandsDirty&&(e(t),t.drawCommandsDirty=!1)}))},a.updateAnimation=function(e){return this._material.update(e)},a.requiresSlot=function(e,t){return null==e||this._material.requiresSlot(e,t)},a.render=function(e,t,r){if(!this.requiresSlot(e,t))return!1;const i=t===u.RenderPass.MATERIAL_HIGHLIGHT||t===u.RenderPass.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT;if(i&&!this._hasHighlights)return!1;const n=t===u.RenderPass.MATERIAL_DEPTH_SHADOWMAP_DEFAULT,a=!(i||n);if(this._dataByOrigin.forEach((e=>{if(i&&!e.hasHighlights)return;const t=(i?e.drawCommandsHighlight:n&&v(e)?e.drawCommandsShadowHighlightRest:e.drawCommandsDefault)||null,r=a&&e.drawCommandsOccludees||null;(s.isSome(t)||s.isSome(r))&&this._renderCommandData.push(new H(e.origin,e.buffer,t,r))})),0===this._renderCommandData.length)return!1;const o=this._rctx,d=this._glMaterials.load(o,t);if(s.isNone(d))return this._renderCommandData.clear(),!1;const l=d.beginSlot(r);return o.useTechnique(l,e,!1),d.bind(r,l),this._renderCommandData.forAll((({origin:t,buffer:i,renderCommands:n,occludeeCommands:a})=>{r.origin=t,l.bindDraw(r),l.ensureAttributeLocations(i.vao),o.bindVAO(i.vao);const d=l.primitiveType;s.isSome(n)&&this._renderCommands(o,d,n),s.isSome(a)&&(l.bindPipelineState(o,e,!0),this._renderCommands(o,d,a),l.bindPipelineState(o,e,!1))})),this._renderCommandData.clear(),!0},a._renderCommands=function(e,t,r){for(let s=0;s<r.length;s++)e.drawArrays(t,r[s].first,r[s].count)},a._removeAndRebuild=function(e,t,r,s,i){for(const l of t)e.instances.delete(l.id);const n=m.sortInstancesByRange(e.instances);e.instances.clear();const a=e.buffer.size,o=e.buffer.alloc(s);let d=0;for(const l of n){const t=l.from*r,s=l.to*r;o.copy(d,t,s),l.from=d/r,d+=s-t,l.to=d/r,e.instances.set(l.id,l)}i.push(new m.BufferRange(0,o.hasNewBuffer?e.buffer.array.length:a)),o.dispose(),e.buffer.erase(d,i.back().to),e.holes.clear()},a._remove=function(e,t,r,s){for(const i of t){const t=i.id,n=e.instances.get(t),a=n.from*r,o=n.to*r;e.buffer.erase(a,o),e.holes.push(new m.BufferRange(n.from,n.to)),e.instances.delete(t),s.push(new m.BufferRange(a,o))}C(e.holes)},a._add=function(e,t,r,i,a){if(0===t.length)return;const o=this._bufferWriter;let d=o.vertexBufferLayout.createView(e.buffer.array.buffer);const l=e.holes.length>0;let f=Number.MAX_SAFE_INTEGER,u=Number.MIN_SAFE_INTEGER;for(const c of t){const t=s.isSome(c.transformation)?n.multiply(S,i,c.transformation):i;n.invert(D,t);const g=n.transpose(D,D),_=o.elementCount(c.data),y=_*r;let b=O(e.holes,_);s.isNone(b)&&(b=e.buffer.size/r,e.buffer.grow(y),d=o.vertexBufferLayout.createView(e.buffer.array.buffer)),o.write({transformation:t,invTranspTransformation:g},c.data,d,b);const w=c.instanceParameters.visible,p=!!c.instanceParameters.highlights&&w,M=!!c.instanceParameters.occludees,v=new m.Instance(c.id,b,b+_,w,p,M);h.assert(null==e.instances.get(c.id)),e.instances.set(c.id,v),l?a.push(new m.BufferRange(v.from*r,v.to*r)):(f=Math.min(v.from,f),u=Math.max(v.to,u))}l||a.push(new m.BufferRange(f*r,u*r))},t._createClass(e,[{key:"isEmpty",get:function(){return 0===this._dataByOrigin.size}},{key:"hasHighlights",get:function(){return this._hasHighlights}},{key:"hasOccludees",get:function(){return this._hasOccludees}},{key:"hasWater",get:function(){return!this.isEmpty&&this._material instanceof c.WaterMaterial}},{key:"rendersOccluded",get:function(){return!this.isEmpty&&this._material.renderOccluded!==l.RenderOccludedFlag.Occlude}},{key:"test",get:function(){return{material:this._material,glMaterials:this._glMaterials,dataByOrigin:this._dataByOrigin}}}]),e}(),w=function(e){this.origin=e,this.toAdd=new Array,this.toRemove=new Array};function p(e,t){const r=new Map;for(const s of e)M(r,s,!0);for(const s of t)M(r,s,!1);return r}function M(e,t,r){const i=t.origin;if(s.isNone(i))return;let n=e.get(i.id);null==n&&(n=new w(i.vec3),e.set(i.id,n)),r?n.toAdd.push(t):n.toRemove.push(t)}function v(e){return e.hasOccludees||e.hasHighlights||e.hasHiddenInstances}function O(e,t){let r;if(!e.some((e=>!(e.to-e.from<t)&&(r=e,!0))))return null;const s=r.from;return r.from+=t,r.from>=r.to&&e.removeUnordered(r),s}function C(e){const t=new Map;e.forAll((e=>t.set(e.from,e)));let r=!0;for(;r;)r=!1,e.forEach((s=>{const i=t.get(s.to);i&&(s.to=i.to,t.delete(i.from),e.removeUnordered(i),r=!0)}))}let R=function(e,t){this.origin=e,this.buffer=t,this.instances=new Map,this.holes=new i({deallocator:null}),this.hasHiddenInstances=!1,this.hasHighlights=!1,this.hasOccludees=!1,this.drawCommandsDirty=!1},H=function(e,t,r,s){this.origin=e,this.buffer=t,this.renderCommands=r,this.occludeeCommands=s};const A=new i({deallocator:null}),B=a.create(),S=a.create(),D=a.create();e.MergedRenderer=b,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
