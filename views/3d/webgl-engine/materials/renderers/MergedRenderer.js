/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/maybe","../../../../../chunks/mat4","../../../../../core/MapUtils","../../../../../chunks/mat4f64","../../../support/buffer/glUtil","../../lib/Util","../../../../webgl/BufferObject","../../../../webgl/Util","../../../../webgl/VertexArrayObject","./utils","../../lib/ResizableFloat32Array","../WaterGLMaterial","./Instance","../../statistics/RendererPerformanceInfo"],(function(e,t,s,a,i,n,r,o,d,l,h,c,u,g,m){"use strict";let f=function(){function i(e,t,s){this.type="MergedRenderer",this._dataByOrigin=new Map,this._hasHighlights=!1,this._hasOccludees=!1,this._rctx=e,this._material=s,this._materialRep=t,this._glMaterials=h.acquireMaterials(this._material,this._materialRep),this._bufferWriter=s.createBufferWriter()}var f=i.prototype;return f.dispose=function(){h.releaseMaterials(this._material,this._materialRep),this._dataByOrigin&&(this._dataByOrigin.forEach((e=>{e.vao.dispose(!0),e.vao=null})),this._dataByOrigin.clear(),this._dataByOrigin=null),this._glMaterials&&(this._glMaterials.forEach((e=>{e&&e.dispose()})),this._glMaterials.clear(),this._glMaterials=null)},f.modify=function(e){this.updateGeometries(e.updates),this.addAndRemoveGeometries(e.adds,e.removes),this.updateRenderCommands()},f.addAndRemoveGeometries=function(e,t){const s=this._bufferWriter,a=s.vertexBufferLayout,i=a.stride/4,n=this._dataByOrigin,o=p(n,s,e,t);o.forEach(((e,t)=>{o.delete(t);const s=e.optimalCount,d=e.sparseCount;let l=n.get(t);if(null==l)r.assert(s>0),l=this.createData(a,s,e.origin),n.set(t,l);else if(0===s)return l.vao.dispose(!0),l.vao=null,void n.delete(t);const h=s<e.sparseCount/2,c=h?s:d,u=w,g=l.buffer.size,m=l.buffer.array,f=l.buffer.resize(c,!1);h||f?this.removeAndRebuild(l,e.toRemove,i,m,u):e.toRemove.length>0?(this.removeByErasing(l,e.toRemove,i,u),e.toAdd.length>0&&(u.end=g)):(u.begin=g,u.end=g);const p=b;r.setMatrixTranslation3(p,-e.origin[0],-e.origin[1],-e.origin[2]),this.append(l,e.toAdd,i,p,u);const y=l.vao.vertexBuffers.geometry;if(y.byteSize!==l.buffer.array.buffer.byteLength)y.setData(l.buffer.array);else{const{begin:e,end:t}=u;if(e<t){const s=l.buffer.array,a=4,i=e*a,n=t*a;y.setSubData(s,i,i,n)}}l.drawCommandsDirty=!0}))},f.updateGeometries=function(e){const t=this._bufferWriter,s=t.vertexBufferLayout.stride/4;for(const a of e){const e=a.updateType,i=a.renderGeometry,n=this._dataByOrigin.get(i.origin.id),o=n&&n.instances.get(i.id);if(!o)return;if(1&e&&(o.isVisible=i.instanceParameters.visible),9&e){const e=i.instanceParameters.visible;o.hasHighlights=!!i.instanceParameters.highlights&&e}if(16&e&&(o.hasOccludees=!!i.instanceParameters.occludees),6&e){const e=n.buffer.array,a=n.vao;h.calculateTransformRelToOrigin(i,C,_),t.write({transformation:C,invTranspTransformation:_},i.data,t.vertexBufferLayout.createView(e.buffer),o.from),r.assert(o.from+t.elementCount(i.data)===o.to,"material VBO layout has changed"),a.vertexBuffers.geometry.setSubData(e,o.from*s*4,o.from*s*4,o.to*s*4)}n.drawCommandsDirty=!0}},f.updateRenderCommands=function(){this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach((e=>{e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,a.someMap(e.instances,(t=>(t.isVisible?(t.hasHighlights&&(this._hasHighlights=!0,e.hasHighlights=!0),t.hasOccludees&&(this._hasOccludees=!0,e.hasOccludees=!0)):e.hasHiddenInstances=!0,e.hasHiddenInstances&&e.hasHighlights&&e.hasOccludees)))}));const e=e=>{if(e.drawCommandsDefault=null,e.drawCommandsHighlight=null,e.drawCommandsOccludees=null,e.drawCommandsShadowHighlightRest=null,e.stats={default:0,highlight:0,occludees:0,shadowHighlightRest:0},0===e.instances.size)return;if(!y(e)){const t=4*e.buffer.size/d.getStride(e.vao.layout.geometry);return e.drawCommandsDefault=[{first:0,count:t}],void(e.stats={default:t,highlight:0,occludees:0,shadowHighlightRest:0})}const t=g.sortInstancesAccordingToRange([...e.instances.values()]);e.drawCommandsDefault=[],e.drawCommandsHighlight=[],e.drawCommandsOccludees=[],e.drawCommandsShadowHighlightRest=[];for(const a of t)a.isVisible&&(a.hasOccludees?g.addOrMerge(e.drawCommandsOccludees,a):g.addOrMerge(e.drawCommandsDefault,a),a.hasHighlights?g.addOrMerge(e.drawCommandsHighlight,a):g.addOrMerge(e.drawCommandsShadowHighlightRest,a));const s=e=>{let t=0;for(const s of e)t+=s.count;return t/3};e.stats={default:s(e.drawCommandsDefault),highlight:s(e.drawCommandsHighlight),occludees:s(e.drawCommandsOccludees),shadowHighlightRest:s(e.drawCommandsShadowHighlightRest)}};this._dataByOrigin.forEach((t=>{t.drawCommandsDirty&&(e(t),t.drawCommandsDirty=!1)}))},f.updateLogic=function(e){return this._material.update(e)},f.render=function(e,s,a,i){const n=this._rctx,r=this._glMaterials.get(s.pass),o=5===s.pass||7===s.pass,d=6===s.pass,l=!(o||d);let h=e;if(3===s.pass&&null===h&&(h=22),!r||2!==r.ensureResources(n)||null!=h&&!r.beginSlot(h)||o&&!this._hasHighlights)return!1;r.ensureParameters(a);const c=r.getTechnique(),u=r.getPipelineState(h,!1);n.setPipelineState(u),r.bind(n,a);let g=!1;return this._dataByOrigin.forEach((e=>{if(t.isNone(e.drawCommandsDefault)&&t.isNone(e.drawCommandsHighlight)&&t.isNone(e.drawCommandsOccludees)&&t.isNone(e.drawCommandsShadowHighlightRest))return;if(o&&!e.hasHighlights)return;a.origin=e.origin,c.bindDraw(a),c.ensureAttributeLocations(e.vao),n.bindVAO(e.vao);const s=c.primitiveType;let f=o?e.drawCommandsHighlight:d&&y(e)?e.drawCommandsShadowHighlightRest:e.drawCommandsDefault;const p=o?e.stats.highlight:d&&y(e)?e.stats.shadowHighlightRest:e.stats.default;if(t.isSome(f)&&(this.renderCommands(n,s,f),m.addToRenderStats(f.length,p,i),g=!0),l&&(f=e.drawCommandsOccludees,t.isSome(f))){const t=r.getPipelineState(h,!0);n.setPipelineState(t),this.renderCommands(n,s,f),n.setPipelineState(u),m.addToRenderStats(f.length,e.stats.occludees,i),g=!0}})),g},f.renderCommands=function(e,t,s){for(let a=0;a<s.length;a++)e.drawArrays(t,s[a].first,s[a].count)},f.createData=function(e,t,s){return{instances:new Map,vao:new l(this._rctx,this._material.vertexAttributeLocations,{geometry:n.glLayout(e)},{geometry:o.createVertex(this._rctx,35044)}),buffer:new c.ResizableFloat32Array(t),optimalCount:0,origin:s,hasHiddenInstances:!1,hasHighlights:!1,hasOccludees:!1,drawCommandsDirty:!1,drawCommandsDefault:null,drawCommandsOccludees:null,drawCommandsHighlight:null,drawCommandsShadowHighlightRest:null,stats:{default:0,highlight:0,occludees:0,shadowHighlightRest:0}}},f.removeAndRebuild=function(e,t,s,a,i){for(const h of t){const t=h.id,a=e.instances.get(t);e.optimalCount-=(a.to-a.from)*s,e.instances.delete(t)}let n=0;const r=e.buffer.array;i.begin=0,i.end=0;let o=-1,d=-1,l=0;e.instances.forEach((e=>{const t=e.from*s,i=e.to*s,h=i-t;o!==d&&d!==t?(r.set(a.subarray(o,d),l),l+=d-o,o=t):-1===o&&(o=t),d=i,e.from=n/s,n+=h,e.to=n/s})),o!==d&&r.set(a.subarray(o,d),l),i.end=n},f.removeByErasing=function(e,t,s,a){a.begin=1/0,a.end=-1/0;let i=-1,n=-1;for(const r of t){const t=r.id,o=e.instances.get(t),d=o.from*s,l=o.to*s;i!==n&&n!==d?(e.buffer.erase(i,n),i=d):-1===i&&(i=d),n=l,e.instances.delete(t),e.optimalCount-=l-d,d<a.begin&&(a.begin=d),l>a.end&&(a.end=l)}i!==n&&e.buffer.erase(i,n)},f.append=function(e,a,i,n,o){const d=this._bufferWriter;for(const l of a){const a=t.isSome(l.transformation)?s.multiply(C,n,l.transformation):n;s.invert(_,a),s.transpose(_,_);const h=o.end;d.write({transformation:a,invTranspTransformation:_},l.data,d.vertexBufferLayout.createView(e.buffer.array.buffer),o.end/i);const c=d.elementCount(l.data)*i,u=h+c;r.assert(null==e.instances.get(l.id));const m=l.instanceParameters.visible,f=!!l.instanceParameters.highlights&&m,p=!!l.instanceParameters.occludees,y=new g.Instance(h/i,u/i,m,f,p);e.instances.set(l.id,y),e.optimalCount+=c,o.end+=c}},e._createClass(i,[{key:"isEmpty",get:function(){return 0===this._dataByOrigin.size}},{key:"hasHighlights",get:function(){return this._hasHighlights}},{key:"hasOccludees",get:function(){return this._hasOccludees}},{key:"hasWater",get:function(){return!this.isEmpty&&a.someMap(this._glMaterials,(e=>e instanceof u.WaterGLMaterial))}},{key:"rendersOccluded",get:function(){return!this.isEmpty&&1!==this._material.renderOccluded}},{key:"test",get:function(){return{material:this._material,glMaterials:this._glMaterials}}}]),i}();function p(e,t,s,a){const i=new Map,n=t.vertexBufferLayout.stride/4,r=(s,a)=>{const r=s.origin,o=e.get(r.id);let d=i.get(r.id);null==d&&(d={optimalCount:null==o?0:o.optimalCount,sparseCount:null==o?0:o.buffer.size,toAdd:[],toRemove:[],origin:r.vec3},i.set(r.id,d));const l=t.elementCount(s.data)*n;a?(d.optimalCount+=l,d.sparseCount+=l,d.toAdd.push(s)):(d.optimalCount-=l,d.toRemove.push(s))};for(const o of s)r(o,!0);for(const o of a)r(o,!1);return i}function y(e){return e.hasOccludees||e.hasHighlights||e.hasHiddenInstances}const w={begin:0,end:0},b=i.create(),C=i.create(),_=i.create();return f}));
