/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/MapUtils","../../../../../core/maybe","../../../../../core/PooledArray","../../../../../chunks/mat4","../../../../../chunks/mat4f64","../../../support/buffer/glUtil","../../lib/GLMaterials","../../lib/Util","../WaterMaterial","./Instance","./MergedGeometryBuffer","./MergedGeometryBufferPool","./utils"],(function(e,t,r,s,i,n,a,o,d,f,l,h,u,c,m){"use strict";let g=function(){function e(e,t,r){this._rctx=e,this._materialRepository=t,this._material=r,this.type="MergedRenderer",this._dataByOrigin=new Map,this._renderCommandData=new i,this._hasHighlights=!1,this._hasOccludees=!1,this._glMaterials=new d.GLMaterials(this._material,this._materialRepository),this._bufferWriter=r.createBufferWriter(),this._bufferPool=new c.MergedGeometryBufferPool(e,r.vertexAttributeLocations,o.glLayout(this._bufferWriter.vertexBufferLayout))}var a=e.prototype;return a.dispose=function(){this._glMaterials.destroy(),this._dataByOrigin.forEach((e=>e.buffer.dispose())),this._dataByOrigin.clear(),this._bufferPool.dispose()},a.modify=function(e){this.updateGeometries(e.updates),this.addAndRemoveGeometries(e.adds,e.removes),this.updateRenderCommands()},a.addAndRemoveGeometries=function(e,t){const r=this._bufferWriter,s=r.vertexBufferLayout.stride/4,i=this._dataByOrigin,n=b(e,t);n.forEach(((e,t)=>{n.delete(t);const a=e.toAdd.reduce(((e,t)=>e+r.elementCount(t.data)),0);let o=i.get(t);if(null==o)f.assert(0===e.toRemove.length),o=new C(e.origin,new u.MergedGeometryBuffer(this._bufferPool,a*s)),i.set(t,o);else if(0===e.toAdd.length&&o.instances.size===e.toRemove.length)return o.buffer.dispose(),void i.delete(t);let d=0;o.instances.forEach((e=>d+=e.to-e.from));const l=e.toRemove.reduce(((e,t)=>e+r.elementCount(t.data)),0),h=o.buffer.size,c=(d+a-l)*s,m=B;if(c<h/2?this.removeAndRebuild(o,e.toRemove,s,c,m):e.toRemove.length>0&&this.remove(o,e.toRemove,s,m),e.toAdd.length>0){const t=H;f.setMatrixTranslation3(t,-e.origin[0],-e.origin[1],-e.origin[2]),this.add(o,e.toAdd,s,t,m)}const g=o.buffer.vao.vertexBuffers.geometry;v(m),m.forAll((({from:e,to:t})=>{if(e<t){const r=o.buffer.array,s=4,i=e*s,n=t*s;g.setSubData(r,i,i,n)}})),m.clear(),o.drawCommandsDirty=!0}))},a.updateGeometries=function(e){const t=this._bufferWriter,r=t.vertexBufferLayout.stride/4;for(const s of e){const e=s.renderGeometry,i=this._dataByOrigin.get(e.origin.id),n=i&&i.instances.get(e.id);if(!n)return;const a=s.updateType;if(1&a&&(n.isVisible=e.instanceParameters.visible),9&a){const t=e.instanceParameters.visible;n.hasHighlights=!!e.instanceParameters.highlights&&t}if(16&a&&(n.hasOccludees=!!e.instanceParameters.occludees),6&a){const{array:s,vao:a}=i.buffer;m.calculateTransformRelativeToOrigin(e,R,M),t.write({transformation:R,invTranspTransformation:M},e.data,t.vertexBufferLayout.createView(s.buffer),n.from),f.assert(n.from+t.elementCount(e.data)===n.to,"material VBO layout has changed"),a.vertexBuffers.geometry.setSubData(s,n.from*r*4,n.from*r*4,n.to*r*4)}i.drawCommandsDirty=!0}},a.updateRenderCommands=function(){this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach((e=>{e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,r.someMap(e.instances,(t=>(t.isVisible?(t.hasHighlights&&(this._hasHighlights=!0,e.hasHighlights=!0),t.hasOccludees&&(this._hasOccludees=!0,e.hasOccludees=!0)):e.hasHiddenInstances=!0,e.hasHiddenInstances&&e.hasHighlights&&e.hasOccludees)))}));const e=e=>{if(e.drawCommandsDefault=null,e.drawCommandsHighlight=null,e.drawCommandsOccludees=null,e.drawCommandsShadowHighlightRest=null,0===e.instances.size)return;if(!p(e)){const t=this._bufferWriter.vertexBufferLayout.stride,r=4*e.buffer.size/t;return void(e.drawCommandsDefault=[{first:0,count:r}])}const t=h.sortInstancesByRange(e.instances);e.drawCommandsDefault=[],e.drawCommandsHighlight=[],e.drawCommandsOccludees=[],e.drawCommandsShadowHighlightRest=[];for(const r of t)r.isVisible&&(r.hasOccludees?h.addOrMerge(e.drawCommandsOccludees,r):h.addOrMerge(e.drawCommandsDefault,r),r.hasHighlights?h.addOrMerge(e.drawCommandsHighlight,r):h.addOrMerge(e.drawCommandsShadowHighlightRest,r))};this._dataByOrigin.forEach((t=>{t.drawCommandsDirty&&(e(t),t.drawCommandsDirty=!1)}))},a.updateLogic=function(e){return this._material.update(e)},a.render=function(e,t,r){if(null!=e&&!this._material.requiresSlot(e,t))return!1;const i=5===t||7===t;if(i&&!this._hasHighlights)return!1;const n=6===t,a=!(i||n);if(this._dataByOrigin.forEach((e=>{if(i&&!e.hasHighlights)return;const t=(i?e.drawCommandsHighlight:n&&p(e)?e.drawCommandsShadowHighlightRest:e.drawCommandsDefault)||null,r=a&&e.drawCommandsOccludees||null;(s.isSome(t)||s.isSome(r))&&this._renderCommandData.push(new O(e.origin,e.buffer,t,r))})),0===this._renderCommandData.length)return!1;const o=this._rctx,d=this._glMaterials.load(o,t);if(s.isNone(d))return this._renderCommandData.clear(),!1;const f=d.beginSlot(r);return f.bindPipelineState(o,e,!1),o.useProgram(f.program),d.bind(r,f),this._renderCommandData.forAll((({origin:t,buffer:i,renderCommands:n,occludeeCommands:a})=>{r.origin=t,f.bindDraw(r),f.ensureAttributeLocations(i.vao),o.bindVAO(i.vao);const d=f.primitiveType;s.isSome(n)&&this.renderCommands(o,d,n),s.isSome(a)&&(f.bindPipelineState(o,e,!0),this.renderCommands(o,d,a),f.bindPipelineState(o,e,!1))})),this._renderCommandData.clear(),!0},a.renderCommands=function(e,t,r){for(let s=0;s<r.length;s++)e.drawArrays(t,r[s].first,r[s].count)},a.removeAndRebuild=function(e,t,r,s,i){for(const f of t)e.instances.delete(f.id);const n=h.sortInstancesByRange(e.instances);e.instances.clear();const a=e.buffer.size,o=e.buffer.alloc(s);let d=0;for(const f of n){const t=f.from*r,s=f.to*r;o.copy(d,t,s),f.from=d/r,d+=s-t,f.to=d/r,e.instances.set(f.id,f)}i.push(new h.BufferRange(0,o.hasNewBuffer?e.buffer.array.length:a)),o.dispose(),e.buffer.erase(d,i.back().to),e.holes.clear()},a.remove=function(e,t,r,s){for(const i of t){const t=i.id,n=e.instances.get(t),a=n.from*r,o=n.to*r;e.buffer.erase(a,o),e.holes.push(new h.BufferRange(n.from,n.to)),e.instances.delete(t),s.push(new h.BufferRange(a,o))}v(e.holes)},a.add=function(e,t,r,i,a){const o=this._bufferWriter;let d=o.vertexBufferLayout.createView(e.buffer.array.buffer);for(const l of t){const t=s.isSome(l.transformation)?n.multiply(R,i,l.transformation):i;n.invert(M,t);const u=n.transpose(M,M),c=o.elementCount(l.data),m=c*r;let g=_(e.holes,c);s.isNone(g)&&(g=e.buffer.size/r,e.buffer.grow(m),d=o.vertexBufferLayout.createView(e.buffer.array.buffer)),o.write({transformation:t,invTranspTransformation:u},l.data,d,g);const y=l.instanceParameters.visible,b=!!l.instanceParameters.highlights&&y,w=!!l.instanceParameters.occludees,p=new h.Instance(l.id,g,g+c,y,b,w);f.assert(null==e.instances.get(l.id)),e.instances.set(l.id,p),a.push(new h.BufferRange(p.from*r,p.to*r))}},t._createClass(e,[{key:"isEmpty",get:function(){return 0===this._dataByOrigin.size}},{key:"hasHighlights",get:function(){return this._hasHighlights}},{key:"hasOccludees",get:function(){return this._hasOccludees}},{key:"hasWater",get:function(){return!this.isEmpty&&this._material instanceof l.WaterMaterial}},{key:"rendersOccluded",get:function(){return!this.isEmpty&&1!==this._material.renderOccluded}},{key:"test",get:function(){return{material:this._material,glMaterials:this._glMaterials}}}]),e}(),y=function(e){this.origin=e,this.toAdd=new Array,this.toRemove=new Array};function b(e,t){const r=new Map;for(const s of e)w(r,s,!0);for(const s of t)w(r,s,!1);return r}function w(e,t,r){const i=t.origin;if(s.isNone(i))return;let n=e.get(i.id);null==n&&(n=new y(i.vec3),e.set(i.id,n)),r?n.toAdd.push(t):n.toRemove.push(t)}function p(e){return e.hasOccludees||e.hasHighlights||e.hasHiddenInstances}function _(e,t){let r;if(!e.some((e=>!(e.to-e.from<t)&&(r=e,!0))))return null;const s=r.from;return r.from+=t,r.from>=r.to&&e.removeUnordered(r),s}function v(e){const t=new Map;e.forAll((e=>t.set(e.from,e)));let r=!0;for(;r;)r=!1,e.forEach((s=>{const i=t.get(s.to);i&&(s.to=i.to,t.delete(i.from),e.removeUnordered(i),r=!0)}))}let C=function(e,t){this.origin=e,this.buffer=t,this.instances=new Map,this.holes=new i({deallocator:null}),this.hasHiddenInstances=!1,this.hasHighlights=!1,this.hasOccludees=!1,this.drawCommandsDirty=!1},O=function(e,t,r,s){this.origin=e,this.buffer=t,this.renderCommands=r,this.occludeeCommands=s};const B=new i({deallocator:null}),H=a.create(),R=a.create(),M=a.create();e.MergedRenderer=g,Object.defineProperty(e,"__esModule",{value:!0})}));
