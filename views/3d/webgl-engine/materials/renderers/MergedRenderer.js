/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/arrayUtils","../../../../../core/MapUtils","../../../../../core/maybe","../../../../../core/NestedMap","../../../../../core/PooledArray","../../../../../chunks/mat4","../../../../../chunks/mat4f64","../../../support/buffer/glUtil","../../core/shaderLibrary/ShaderOutput","../../lib/AppleAmdDriverHelper","../../lib/GLMaterials","../../lib/Material","../../lib/ModelDirtyTypes","../../lib/Util","../DrawParameters","../WaterMaterial","./BufferRange","./Instance","./PerBufferData","./PerOriginData","./VaoCache"],(function(e,t,r,i,s,n,a,o,l,u,c,h,f,d,m,g,p,y,_,v,b,w,O){"use strict";let A=function(){function e(e,t,r){this._rctx=e,this._materialRepository=t,this.material=r,this._dataByOrigin=new Map,this._appleAmdDriverHelper=null,this._hasHighlights=!1,this._hasOccludees=!1,this._glMaterials=new f.GLMaterials(this.material,this._materialRepository),this._bufferWriter=r.createBufferWriter(),this._vaoCache=new O.VaoCache(e,r.vertexAttributeLocations,u.glLayout(this._bufferWriter.vertexBufferLayout)),this._rctx.driverTest.drawArraysRequiresIndicesTypeReset.result&&(this._appleAmdDriverHelper=new h.AppleAmdDriverHelper(this._rctx))}var a=e.prototype;return a.dispose=function(){this._glMaterials.destroy(),this._dataByOrigin.forEach((e=>e.dispose())),this._dataByOrigin.clear(),this._vaoCache.dispose(),this._appleAmdDriverHelper?.dispose()},a.forEachGeometry=function(e){this._dataByOrigin.forEach((t=>t.buffers.forEach((t=>t.instances.forEach((t=>e(t.geometry)))))))},a.modify=function(e){this._updateGeometries(e.updates),this._addAndRemoveGeometries(e.adds,e.removes),this._updateDrawCommands()},a._updateGeometries=function(e){const t=this._bufferWriter,r=t.vertexBufferLayout.stride/4;for(const i of e){const e=i.renderGeometry,n=this._dataByOrigin.get(e.localOrigin.id)?.findBuffer(e.id);if(s.isNone(n))return;const a=n.instances.get(e.id);if(i.updateType&(m.DirtyState.GEOMETRY|m.DirtyState.TRANSFORMATION)){const i=L(t.elementCount(a.geometry.geometry)*r),s=t.vertexBufferLayout.createView(i.buffer);this._writeGeometry(e,s,0),n.vao.vertexBuffers.geometry.setSubData(i,a.from*r,0,a.numElements*r)}i.updateType&(m.DirtyState.HIGHLIGHT|m.DirtyState.OCCLUDEE|m.DirtyState.VISIBILITY)&&(n.drawCommandsDirty=!0)}},a._computeDeltas=function(e,t){const r=new n.NestedMap;for(const i of e){const e=i.localOrigin;if(s.isNone(e))continue;let t=r.get(e.id,null);s.isNone(t)&&(t=new D(e.vec3),r.set(e.id,null,t)),t.changes.push(i)}for(const i of t){const e=i.localOrigin;if(s.isNone(e))continue;const t=this._dataByOrigin.get(e.id)?.findBuffer(i.id);if(s.isNone(t))continue;let n=r.get(e.id,t);s.isNone(n)&&(n=new D(e.vec3),r.set(e.id,t,n)),n.changes.push(i)}return r},a._addAndRemoveGeometries=function(e,t){const{_bufferWriter:i,_dataByOrigin:n}=this,a=i.vertexBufferLayout.stride/4,o=this._computeDeltas(e,t);o.forEach(((e,t)=>{const l=e.get(null),u=s.isSome(l)?l.changes:[];o.delete(t,null);let c=n.get(t);if(e.forEach(((e,l)=>{if(o.delete(t,l),s.isNone(l))return void g.assert(!1,"No VAO for removed geometries");if(l.instances.size===e.changes.length)return this._vaoCache.deleteVao(l.vao),r.removeUnordered(c.buffers,l),void(0===c.buffers.length&&0===u.length&&n.delete(t));const h=l.numElements,f=l.vao.size/4,d=u.reduce(((e,t)=>e+i.elementCount(t.geometry)),0),m=e.changes.reduce(((e,t)=>e+i.elementCount(t.geometry)),0),p=Math.min((h+d-m)*a,I),y=p>f;p>M&&p<f/2?(e.changes.forEach((({id:e})=>l.deleteInstance(e))),l.instances.forEach((({geometry:e})=>u.push(e))),this._vaoCache.deleteVao(l.vao),r.removeUnordered(c.buffers,l)):y?this._applyAndRebuild(l,u,e):this._applyRemoves(l,e)})),u.length>0)for(s.isNone(c)&&(c=new w.PerOriginData(l.origin),n.set(t,c)),c.buffers.forEach((e=>this._applyAdds(e,u)));u.length>0;)c.buffers.push(this._applyAndRebuild(new b.PerBufferData,u,null))}))},a._updateDrawCommands=function(){this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach((e=>{e.buffers.forEach((e=>{e.drawCommandsDirty&&(e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,i.someMap(e.instances,(t=>(e.updateDrawState(t),e.hasHiddenInstances&&e.hasHighlights&&e.hasOccludees))),e.updateDrawCommands(this._bufferWriter.vertexBufferLayout.stride)),this._hasHighlights=this._hasHighlights||e.hasHighlights,this._hasOccludees=this._hasOccludees||e.hasOccludees}))}))},a._applyAndRebuild=function(e,t,r){if(s.isSome(r))for(const s of r.changes)e.deleteInstance(s.id);const i=this._bufferWriter,n=i.vertexBufferLayout.stride,a=n/4,o=Math.floor(I/a);let l=e.numElements;for(;t.length>0;){const r=t.pop(),s=i.elementCount(r.geometry);if(l+s>o&&l>0){t.push(r);break}l+=s;const n=new v.Instance(r,0,0);g.assert(null==e.instances.get(r.id)),e.addInstance(r.id,n)}const u=l*a,c=L(u),h=i.vertexBufferLayout.createView(c.buffer);let f=0;e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,e.instances.forEach(((t,r)=>{this._writeGeometry(t.geometry,h,f);const s=f;f+=i.elementCount(t.geometry.geometry),e.updateInstance(r,s,f),e.updateDrawState(t)})),this._vaoCache.deleteVao(e.vao),e.vao=this._vaoCache.newVao(G(u)),e.vao.vertexBuffers.geometry.setSubData(c,0,0,f*a),e.holes.clear();const d=e.holes.pushNew();return d.from=f,d.to=Math.floor(e.vao.size/n),e.updateDrawCommands(n),e},a._applyRemoves=function(e,t){if(0===t.changes.length)return;for(const a of t.changes){const t=a.id,r=e.instances.get(t);if(!r)continue;e.deleteInstance(t);const i=H.back();if(i){if(i.to===r.from){i.to=r.to;continue}if(i.from===r.to){i.from=r.from;continue}}const s=H.pushNew();s.from=r.from,s.to=r.to}_.mergeAdjacentRanges(H);const r=this._bufferWriter.vertexBufferLayout.stride/4,i=H.reduce(((e,t)=>Math.max(e,t.numElements)),0)*r,s=L(i);s.fill(0,0,i);const n=e.vao.vertexBuffers.geometry;H.forAll((e=>n.setSubData(s,e.from*r,0,e.numElements*r))),e.holes.pushArray(H.data,H.length),H.forAll(((e,t)=>H.data[t]=null)),H.clear(),e.drawCommandsDirty=!0},a._applyAdds=function(e,t){if(0===t.length)return;if(!b.hasVao(e))return void this._applyAndRebuild(e,t,null);const i=this._bufferWriter,n=i.vertexBufferLayout.stride/4,a=e.numElements,o=t.reduce(((e,t)=>e+i.elementCount(t.geometry)),0),l=Math.min((a+o)*n,I),u=4*l;if(e.vao.size<G(I-M)&&u>e.vao.size)return void this._applyAndRebuild(e,t,null);_.mergeAdjacentRanges(e.holes);const c=new Array;for(const r of t){const t=i.elementCount(r.geometry),s=B(e.holes,t);c.push(s)}const h=e.vao.vertexBuffers.geometry;let f=0,d=0,m=0;const p=L(l),y=i.vertexBufferLayout.createView(p.buffer);t.forEach(((t,r)=>{const a=c[r];if(s.isNone(a))return;if(!(m===a)){const e=m-d;e>0&&h.setSubData(p,d*n,0,e*n),d=a,f=0}const o=i.elementCount(t.geometry);this._writeGeometry(t,y,f),f+=o,m=a+o;const l=new v.Instance(t,a,a+o);g.assert(null==e.instances.get(t.id)),e.addInstance(t.id,l),e.drawCommandsDirty=!0}));const w=m-d;w>0&&h.setSubData(p,d*n,0,w*n),r.filterInPlace(t,((e,t)=>s.isNone(c[t])))},a._writeGeometry=function(e,t,r){const i=e.localOrigin.vec3;g.setMatrixTranslation3(S,-i[0],-i[1],-i[2]);const s=o.multiply(C,S,e.transformation);o.invert(E,s),o.transpose(E,E),this._bufferWriter.write(s,E,e.geometry,t,r)},a.updateAnimation=function(e){return this.material.update(e)},a.requiresSlot=function(e,t){return this.material.requiresSlot(e,t)},a.render=function(e,t){if(!this.requiresSlot(t.slot,e))return!1;const r=e===c.ShaderOutput.Highlight||e===c.ShaderOutput.ShadowHighlight;if(r&&!this._hasHighlights)return!1;const i=e===c.ShaderOutput.ShadowExcludeHighlight,n=!(r||i),a=this._rctx;let o;const l=()=>{if(s.isSome(o))return o;const r=this._glMaterials.load(a,t.slot,e);return s.isNone(r)?null:(o=r.beginSlot(t),s.isNone(o)?null:(a.bindTechnique(o,this.material.parameters,t),o))};this._appleAmdDriverHelper?.resetIndicesType();for(const u of this._dataByOrigin.values())for(const e of u.buffers){if(r&&!e.hasHighlights)continue;const o=(r?e.drawCommandsHighlight:i&&e.needsMultipleCommands()?e.drawCommandsShadowHighlightRest:e.drawCommandsDefault)||null,c=n&&e.drawCommandsOccludees||null;if(o?.length||c?.length){const r=l();if(s.isNone(r))return!1;r.program.bindDraw(new p.DrawParameters(u.origin),t,this.material.parameters),r.ensureAttributeLocations(e.vao),a.bindVAO(e.vao),o?.length&&(r.bindPipelineState(a,t.slot,!1),o.forAll((e=>a.drawArrays(r.primitiveType,e.first,e.count)))),c?.length&&(r.bindPipelineState(a,t.slot,!0),c.forAll((e=>a.drawArrays(r.primitiveType,e.first,e.count))))}}return s.isSome(o)},t._createClass(e,[{key:"isEmpty",get:function(){return 0===this._dataByOrigin.size}},{key:"hasHighlights",get:function(){return this._hasHighlights}},{key:"hasOccludees",get:function(){return this._hasOccludees}},{key:"hasWater",get:function(){return!this.isEmpty&&this.material instanceof y.WaterMaterial}},{key:"rendersOccluded",get:function(){return!this.isEmpty&&this.material.renderOccluded!==d.RenderOccludedFlag.Occlude}},{key:"numGeometries",get:function(){let e=0;return this._dataByOrigin.forEach((t=>e+=t.buffers.reduce(((e,t)=>e+t.instances.size),0))),e}},{key:"test",get:function(){return{material:this.material,glMaterials:this._glMaterials,dataByOrigin:this._dataByOrigin}}}]),e}(),D=function(e){this.origin=e,this.changes=new Array};function B(e,t){let r;if(!e.some((e=>!(e.numElements<t)&&(r=e,!0))))return null;const i=r.from;return r.from+=t,r.from>=r.to&&e.removeUnordered(r),i}const S=l.create(),C=l.create(),E=l.create(),H=new a({allocator:e=>e||new _.BufferRange,deallocator:null}),M=65536,x=4*M,R=16777216,I=R/4;let N=new Float32Array(M);function L(e){return N.length<e&&(N=new Float32Array(e)),N}function G(e){const t=4*e;return t<x?x:Math.max(Math.min(Math.ceil(1.5*t/x)*x,R),t)}e.MergedRenderer=A,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
