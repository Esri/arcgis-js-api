/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/MapUtils","../../../../../core/maybe","../../../../../chunks/mat4","../../../../../chunks/mat4f64","../../../support/buffer/glUtil","../../lib/ResizableFloat32Array","../../lib/Util","../WaterGLMaterial","./Instance","./utils","../../statistics/RendererPerformanceInfo","../../../../webgl/BufferObject","../../../../webgl/Util","../../../../webgl/VertexArrayObject"],(function(e,t,s,a,i,r,n,o,d,l,h,c,u,g,m){"use strict";let f=function(){function i(e,t,s){this.type="MergedRenderer",this._dataByOrigin=new Map,this._hasHighlights=!1,this._hasOccludees=!1,this._rctx=e,this._material=s,this._materialRep=t,this._glMaterials=h.acquireMaterials(this._material,this._materialRep),this._bufferWriter=s.createBufferWriter()}var f=i.prototype;return f.dispose=function(){h.releaseMaterials(this._material,this._materialRep),this._dataByOrigin&&(this._dataByOrigin.forEach((e=>{e.vao.dispose(!0),e.vao=null})),this._dataByOrigin.clear(),this._dataByOrigin=null),this._glMaterials&&(this._glMaterials.forEach((e=>{e&&e.dispose()})),this._glMaterials.clear(),this._glMaterials=null)},f.modify=function(e){this.updateGeometries(e.updates),this.addAndRemoveGeometries(e.adds,e.removes),this.updateRenderCommands()},f.addAndRemoveGeometries=function(e,t){const s=this._bufferWriter,a=s.vertexBufferLayout,i=a.stride/4,r=this._dataByOrigin,n=p(r,s,e,t);n.forEach(((e,t)=>{n.delete(t);const s=e.optimalCount,d=e.sparseCount;let l=r.get(t);if(null==l)o.assert(s>0),l=this.createData(a,s,e.origin),r.set(t,l);else if(0===s)return l.vao.dispose(!0),l.vao=null,void r.delete(t);const h=s<e.sparseCount/2,c=h?s:d,u=w,g=l.buffer.size,m=l.buffer.array,f=l.buffer.resize(c,!1);h||f?this.removeAndRebuild(l,e.toRemove,i,m,u):e.toRemove.length>0?(this.removeByErasing(l,e.toRemove,i,u),e.toAdd.length>0&&(u.end=g)):(u.begin=g,u.end=g);const p=b;o.setMatrixTranslation3(p,-e.origin[0],-e.origin[1],-e.origin[2]),this.append(l,e.toAdd,i,p,u);const y=l.vao.vertexBuffers.geometry;if(y.byteSize!==l.buffer.array.buffer.byteLength)y.setData(l.buffer.array);else{const{begin:e,end:t}=u;if(e<t){const s=l.buffer.array,a=4,i=e*a,r=t*a;y.setSubData(s,i,i,r)}}l.drawCommandsDirty=!0}))},f.updateGeometries=function(e){const t=this._bufferWriter,s=t.vertexBufferLayout.stride/4;for(const a of e){const e=a.updateType,i=a.renderGeometry,r=this._dataByOrigin.get(i.origin.id),n=r&&r.instances.get(i.id);if(!n)return;if(1&e&&(n.isVisible=i.instanceParameters.visible),9&e){const e=i.instanceParameters.visible;n.hasHighlights=!!i.instanceParameters.highlights&&e}if(16&e&&(n.hasOccludees=!!i.instanceParameters.occludees),6&e){const e=r.buffer.array,a=r.vao;h.calculateTransformRelativeToOrigin(i,C,_),t.write({transformation:C,invTranspTransformation:_},i.data,t.vertexBufferLayout.createView(e.buffer),n.from),o.assert(n.from+t.elementCount(i.data)===n.to,"material VBO layout has changed"),a.vertexBuffers.geometry.setSubData(e,n.from*s*4,n.from*s*4,n.to*s*4)}r.drawCommandsDirty=!0}},f.updateRenderCommands=function(){this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach((e=>{e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,t.someMap(e.instances,(t=>(t.isVisible?(t.hasHighlights&&(this._hasHighlights=!0,e.hasHighlights=!0),t.hasOccludees&&(this._hasOccludees=!0,e.hasOccludees=!0)):e.hasHiddenInstances=!0,e.hasHiddenInstances&&e.hasHighlights&&e.hasOccludees)))}));const e=e=>{if(e.drawCommandsDefault=null,e.drawCommandsHighlight=null,e.drawCommandsOccludees=null,e.drawCommandsShadowHighlightRest=null,e.stats={default:0,highlight:0,occludees:0,shadowHighlightRest:0},0===e.instances.size)return;if(!y(e)){const t=4*e.buffer.size/g.getStride(e.vao.layout.geometry);return e.drawCommandsDefault=[{first:0,count:t}],void(e.stats={default:t,highlight:0,occludees:0,shadowHighlightRest:0})}const t=l.sortInstancesAccordingToRange([...e.instances.values()]);e.drawCommandsDefault=[],e.drawCommandsHighlight=[],e.drawCommandsOccludees=[],e.drawCommandsShadowHighlightRest=[];for(const a of t)a.isVisible&&(a.hasOccludees?l.addOrMerge(e.drawCommandsOccludees,a):l.addOrMerge(e.drawCommandsDefault,a),a.hasHighlights?l.addOrMerge(e.drawCommandsHighlight,a):l.addOrMerge(e.drawCommandsShadowHighlightRest,a));const s=e=>{let t=0;for(const s of e)t+=s.count;return t/3};e.stats={default:s(e.drawCommandsDefault),highlight:s(e.drawCommandsHighlight),occludees:s(e.drawCommandsOccludees),shadowHighlightRest:s(e.drawCommandsShadowHighlightRest)}};this._dataByOrigin.forEach((t=>{t.drawCommandsDirty&&(e(t),t.drawCommandsDirty=!1)}))},f.updateLogic=function(e){return this._material.update(e)},f.render=function(e,t,a,i){const r=this._rctx,n=this._glMaterials.get(t),o=5===t||7===t,d=6===t,l=!(o||d);if(!n||2!==n.ensureResources(r)||null!=e&&!n.beginSlot(e)||o&&!this._hasHighlights)return!1;n.ensureParameters(a);const h=n.getPipelineState(e,!1);r.setPipelineState(h);const u=n.technique;r.useProgram(u.program),n.bind(a);let g=!1;return this._dataByOrigin.forEach((t=>{if(s.isNone(t.drawCommandsDefault)&&s.isNone(t.drawCommandsHighlight)&&s.isNone(t.drawCommandsOccludees)&&s.isNone(t.drawCommandsShadowHighlightRest))return;if(o&&!t.hasHighlights)return;a.origin=t.origin,u.bindDraw(a,{},{}),u.ensureAttributeLocations(t.vao),r.bindVAO(t.vao);const m=u.primitiveType,f=o?t.drawCommandsHighlight:d&&y(t)?t.drawCommandsShadowHighlightRest:t.drawCommandsDefault;if(s.isSome(f)){this.renderCommands(r,m,f);const e=o?t.stats.highlight:d&&y(t)?t.stats.shadowHighlightRest:t.stats.default;c.addToRenderStats(f.length,e,i),g=!0}if(l){const a=t.drawCommandsOccludees;if(s.isSome(a)){const s=n.getPipelineState(e,!0);r.setPipelineState(s),this.renderCommands(r,m,a),r.setPipelineState(h),c.addToRenderStats(a.length,t.stats.occludees,i),g=!0}}})),g},f.renderCommands=function(e,t,s){for(let a=0;a<s.length;a++)e.drawArrays(t,s[a].first,s[a].count)},f.createData=function(e,t,s){return{instances:new Map,vao:new m(this._rctx,this._material.vertexAttributeLocations,{geometry:r.glLayout(e)},{geometry:u.createVertex(this._rctx,35044)}),buffer:new n.ResizableFloat32Array(t),optimalCount:0,origin:s,hasHiddenInstances:!1,hasHighlights:!1,hasOccludees:!1,drawCommandsDirty:!1,drawCommandsDefault:null,drawCommandsOccludees:null,drawCommandsHighlight:null,drawCommandsShadowHighlightRest:null,stats:{default:0,highlight:0,occludees:0,shadowHighlightRest:0}}},f.removeAndRebuild=function(e,t,s,a,i){for(const h of t){const t=h.id,a=e.instances.get(t);e.optimalCount-=(a.to-a.from)*s,e.instances.delete(t)}let r=0;const n=e.buffer.array;i.begin=0,i.end=0;let o=-1,d=-1,l=0;e.instances.forEach((e=>{const t=e.from*s,i=e.to*s,h=i-t;o!==d&&d!==t?(n.set(a.subarray(o,d),l),l+=d-o,o=t):-1===o&&(o=t),d=i,e.from=r/s,r+=h,e.to=r/s})),o!==d&&n.set(a.subarray(o,d),l),i.end=r},f.removeByErasing=function(e,t,s,a){a.begin=1/0,a.end=-1/0;let i=-1,r=-1;for(const n of t){const t=n.id,o=e.instances.get(t),d=o.from*s,l=o.to*s;i!==r&&r!==d?(e.buffer.erase(i,r),i=d):-1===i&&(i=d),r=l,e.instances.delete(t),e.optimalCount-=l-d,d<a.begin&&(a.begin=d),l>a.end&&(a.end=l)}i!==r&&e.buffer.erase(i,r)},f.append=function(e,t,i,r,n){const d=this._bufferWriter;for(const h of t){const t=s.isSome(h.transformation)?a.multiply(C,r,h.transformation):r;a.invert(_,t),a.transpose(_,_);const c=n.end;d.write({transformation:t,invTranspTransformation:_},h.data,d.vertexBufferLayout.createView(e.buffer.array.buffer),n.end/i);const u=d.elementCount(h.data)*i,g=c+u;o.assert(null==e.instances.get(h.id));const m=h.instanceParameters.visible,f=!!h.instanceParameters.highlights&&m,p=!!h.instanceParameters.occludees,y=new l.Instance(c/i,g/i,m,f,p);e.instances.set(h.id,y),e.optimalCount+=u,n.end+=u}},e._createClass(i,[{key:"isEmpty",get:function(){return 0===this._dataByOrigin.size}},{key:"hasHighlights",get:function(){return this._hasHighlights}},{key:"hasOccludees",get:function(){return this._hasOccludees}},{key:"hasWater",get:function(){return!this.isEmpty&&t.someMap(this._glMaterials,(e=>e instanceof d.WaterGLMaterial))}},{key:"rendersOccluded",get:function(){return!this.isEmpty&&1!==this._material.renderOccluded}},{key:"test",get:function(){return{material:this._material,glMaterials:this._glMaterials}}}]),i}();function p(e,t,a,i){const r=new Map,n=t.vertexBufferLayout.stride/4,o=(a,i)=>{const o=a.origin;if(s.isNone(o))return;const d=e.get(o.id);let l=r.get(o.id);null==l&&(l={optimalCount:null==d?0:d.optimalCount,sparseCount:null==d?0:d.buffer.size,toAdd:[],toRemove:[],origin:o.vec3},r.set(o.id,l));const h=t.elementCount(a.data)*n;i?(l.optimalCount+=h,l.sparseCount+=h,l.toAdd.push(a)):(l.optimalCount-=h,l.toRemove.push(a))};for(const s of a)o(s,!0);for(const s of i)o(s,!1);return r}function y(e){return e.hasOccludees||e.hasHighlights||e.hasHiddenInstances}const w={begin:0,end:0},b=i.create(),C=i.create(),_=i.create();return f}));
