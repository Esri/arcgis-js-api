/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{someMap as e}from"../../../../../core/MapUtils.js";import{isSome as t,isNone as r}from"../../../../../core/maybe.js";import s from"../../../../../core/PooledArray.js";import{m as i,a,t as o}from"../../../../../chunks/mat4.js";import{c as n}from"../../../../../chunks/mat4f64.js";import{glLayout as d}from"../../../support/buffer/glUtil.js";import{GLMaterials as h}from"../../lib/GLMaterials.js";import{RenderOccludedFlag as l}from"../../lib/Material.js";import{ModelDirty as m}from"../../lib/ModelDirtyTypes.js";import{RenderPass as f}from"../../lib/RenderPass.js";import{assert as c,setMatrixTranslation3 as u}from"../../lib/Util.js";import{DrawParameters as g}from"../DrawParameters.js";import{WaterMaterial as _}from"../WaterMaterial.js";import{sortInstancesByRange as p,BufferRange as b,Instance as w,addOrMerge as y}from"./Instance.js";import{MergedGeometryBuffer as C}from"./MergedGeometryBuffer.js";import{MergedGeometryBufferPool as H}from"./MergedGeometryBufferPool.js";import{calculateTransformRelativeToOrigin as v}from"./utils.js";class A{constructor(e,t,r){this._rctx=e,this._materialRepository=t,this._material=r,this.type="MergedRenderer",this._dataByOrigin=new Map,this._renderCommandData=new s,this._hasHighlights=!1,this._hasOccludees=!1,this._glMaterials=new h(this._material,this._materialRepository),this._bufferWriter=r.createBufferWriter(),this._bufferPool=new H(e,r.vertexAttributeLocations,d(this._bufferWriter.vertexBufferLayout))}dispose(){this._glMaterials.destroy(),this._dataByOrigin.forEach((e=>e.buffer.dispose())),this._dataByOrigin.clear(),this._bufferPool.dispose()}get isEmpty(){return 0===this._dataByOrigin.size}get hasHighlights(){return this._hasHighlights}get hasOccludees(){return this._hasOccludees}get hasWater(){return!this.isEmpty&&this._material instanceof _}get rendersOccluded(){return!this.isEmpty&&this._material.renderOccluded!==l.Occlude}modify(e){this._updateGeometries(e.updates),this._addAndRemoveGeometries(e.adds,e.removes),this._updateRenderCommands()}_addAndRemoveGeometries(e,t){const r=this._bufferWriter,s=r.vertexBufferLayout.stride/4,i=this._dataByOrigin,a=R(e,t);a.forEach(((e,t)=>{a.delete(t);const o=e.toAdd.reduce(((e,t)=>e+r.elementCount(t.data)),0);let n=i.get(t);if(null==n)c(0===e.toRemove.length),n=new D(e.origin,new C(this._bufferPool,o*s)),i.set(t,n);else if(0===e.toAdd.length&&n.instances.size===e.toRemove.length)return n.buffer.dispose(),void i.delete(t);let d=0;n.instances.forEach((e=>d+=e.to-e.from));const h=e.toRemove.reduce(((e,t)=>e+r.elementCount(t.data)),0),l=n.buffer.size,m=(d+o-h)*s,f=T;if(m<l/2?this._removeAndRebuild(n,e.toRemove,s,m,f):e.toRemove.length>0&&this._remove(n,e.toRemove,s,f),e.toAdd.length>0){const t=L;u(t,-e.origin[0],-e.origin[1],-e.origin[2]),this._add(n,e.toAdd,s,t,f)}const g=n.buffer.vao.vertexBuffers.geometry;B(f),f.forAll((({from:e,to:t})=>{if(e<t){const r=n.buffer.array,s=4,i=e*s,a=t*s;g.setSubData(r,i,i,a)}})),f.clear(),n.drawCommandsDirty=!0}))}_updateGeometries(e){const t=this._bufferWriter,r=t.vertexBufferLayout.stride/4;for(const s of e){const e=s.renderGeometry,i=this._dataByOrigin.get(e.origin.id),a=i&&i.instances.get(e.id);if(!a)return;const o=s.updateType;if(o&m.State.VISIBILITIES&&(a.isVisible=e.instanceParameters.visible),o&(m.State.HIGHLIGHTS|m.State.VISIBILITIES)){const t=e.instanceParameters.visible;a.hasHighlights=!!e.instanceParameters.highlights&&t}if(o&m.State.OCCLUDEES&&(a.hasOccludees=!!e.instanceParameters.occludees),o&(m.State.VERTEXATTRS|m.State.TRANSFORMATION)){const{array:s,vao:o}=i.buffer;v(e,P,j),t.write({transformation:P,invTranspTransformation:j},e.data,t.vertexBufferLayout.createView(s.buffer),a.from),c(a.from+t.elementCount(e.data)===a.to,"material VBO layout has changed"),o.vertexBuffers.geometry.setSubData(s,a.from*r*4,a.from*r*4,a.to*r*4)}i.drawCommandsDirty=!0}}_updateRenderCommands(){this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach((t=>{t.hasHiddenInstances=!1,t.hasHighlights=!1,t.hasOccludees=!1,e(t.instances,(e=>(e.isVisible?(e.hasHighlights&&(this._hasHighlights=!0,t.hasHighlights=!0),e.hasOccludees&&(this._hasOccludees=!0,t.hasOccludees=!0)):t.hasHiddenInstances=!0,t.hasHiddenInstances&&t.hasHighlights&&t.hasOccludees)))}));const t=e=>{if(e.drawCommandsDefault=null,e.drawCommandsHighlight=null,e.drawCommandsOccludees=null,e.drawCommandsShadowHighlightRest=null,0===e.instances.size)return;if(!I(e)){const t=this._bufferWriter.vertexBufferLayout.stride,r=4*e.buffer.size/t;return void(e.drawCommandsDefault=[{first:0,count:r}])}const t=p(e.instances);e.drawCommandsDefault=[],e.drawCommandsHighlight=[],e.drawCommandsOccludees=[],e.drawCommandsShadowHighlightRest=[];for(const r of t)r.isVisible&&(r.hasOccludees?y(e.drawCommandsOccludees,r):y(e.drawCommandsDefault,r),r.hasHighlights?y(e.drawCommandsHighlight,r):y(e.drawCommandsShadowHighlightRest,r))};this._dataByOrigin.forEach((e=>{e.drawCommandsDirty&&(t(e),e.drawCommandsDirty=!1)}))}updateAnimation(e){return this._material.update(e)}requiresSlot(e,t){return null==e||this._material.requiresSlot(e,t)}render(e,s){if(!this.requiresSlot(s.slot,e))return!1;const i=e===f.MATERIAL_HIGHLIGHT||e===f.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT;if(i&&!this._hasHighlights)return!1;const a=e===f.MATERIAL_DEPTH_SHADOWMAP_DEFAULT,o=!(i||a);if(this._dataByOrigin.forEach((e=>{if(i&&!e.hasHighlights)return;const r=(i?e.drawCommandsHighlight:a&&I(e)?e.drawCommandsShadowHighlightRest:e.drawCommandsDefault)||null,s=o&&e.drawCommandsOccludees||null;(t(r)||t(s))&&this._renderCommandData.push(new M(e.origin,e.buffer,r,s))})),0===this._renderCommandData.length)return!1;const n=this._rctx,d=this._glMaterials.load(n,e);if(r(d))return this._renderCommandData.clear(),!1;const h=d.beginSlot(s);return n.bindTechnique(h,this._material.parameters,s,!1),this._renderCommandData.forAll((e=>{h.bindDraw(e,s);const{buffer:r,renderCommands:i,occludeeCommands:a}=e;h.ensureAttributeLocations(r.vao),n.bindVAO(r.vao);const o=h.primitiveType;t(i)&&this._renderCommands(n,o,i),t(a)&&(h.bindPipelineState(n,s.slot,!0),this._renderCommands(n,o,a),h.bindPipelineState(n,s.slot,!1))})),this._renderCommandData.clear(),!0}_renderCommands(e,t,r){for(let s=0;s<r.length;s++)e.drawArrays(t,r[s].first,r[s].count)}_removeAndRebuild(e,t,r,s,i){for(const h of t)e.instances.delete(h.id);const a=p(e.instances);e.instances.clear();const o=e.buffer.size,n=e.buffer.alloc(s);let d=0;for(const h of a){const t=h.from*r,s=h.to*r;n.copy(d,t,s),h.from=d/r,d+=s-t,h.to=d/r,e.instances.set(h.id,h)}i.push(new b(0,n.hasNewBuffer?e.buffer.array.length:o)),n.dispose(),e.buffer.erase(d,i.back().to),e.holes.clear()}_remove(e,t,r,s){for(const i of t){const t=i.id,a=e.instances.get(t),o=a.from*r,n=a.to*r;e.buffer.erase(o,n),e.holes.push(new b(a.from,a.to)),e.instances.delete(t),s.push(new b(o,n))}B(e.holes)}_add(e,s,n,d,h){if(0===s.length)return;const l=this._bufferWriter;let m=l.vertexBufferLayout.createView(e.buffer.array.buffer);const f=e.holes.length>0;let u=Number.MAX_SAFE_INTEGER,g=Number.MIN_SAFE_INTEGER;for(const _ of s){const s=t(_.transformation)?i(P,d,_.transformation):d;a(j,s);const p=o(j,j),y=l.elementCount(_.data),C=y*n;let H=E(e.holes,y);r(H)&&(H=e.buffer.size/n,e.buffer.grow(C),m=l.vertexBufferLayout.createView(e.buffer.array.buffer)),l.write({transformation:s,invTranspTransformation:p},_.data,m,H);const v=_.instanceParameters.visible,A=!!_.instanceParameters.highlights&&v,O=!!_.instanceParameters.occludees,R=new w(_.id,H,H+y,v,A,O);c(null==e.instances.get(_.id)),e.instances.set(_.id,R),f?h.push(new b(R.from*n,R.to*n)):(u=Math.min(R.from,u),g=Math.max(R.to,g))}f||h.push(new b(u*n,g*n))}get test(){return{material:this._material,glMaterials:this._glMaterials,dataByOrigin:this._dataByOrigin}}}class O{constructor(e){this.origin=e,this.toAdd=new Array,this.toRemove=new Array}}function R(e,t){const r=new Map;for(const s of e)S(r,s,!0);for(const s of t)S(r,s,!1);return r}function S(e,t,s){const i=t.origin;if(r(i))return;let a=e.get(i.id);null==a&&(a=new O(i.vec3),e.set(i.id,a)),s?a.toAdd.push(t):a.toRemove.push(t)}function I(e){return e.hasOccludees||e.hasHighlights||e.hasHiddenInstances}function E(e,t){let r;if(!e.some((e=>!(e.to-e.from<t)&&(r=e,!0))))return null;const s=r.from;return r.from+=t,r.from>=r.to&&e.removeUnordered(r),s}function B(e){const t=new Map;e.forAll((e=>t.set(e.from,e)));let r=!0;for(;r;)r=!1,e.forEach((s=>{const i=t.get(s.to);i&&(s.to=i.to,t.delete(i.from),e.removeUnordered(i),r=!0)}))}class D{constructor(e,t){this.origin=e,this.buffer=t,this.instances=new Map,this.holes=new s({deallocator:null}),this.hasHiddenInstances=!1,this.hasHighlights=!1,this.hasOccludees=!1,this.drawCommandsDirty=!1}}class M extends g{constructor(e,t,r,s){super(e),this.buffer=t,this.renderCommands=r,this.occludeeCommands=s}}const T=new s({deallocator:null}),L=n(),P=n(),j=n();export{A as MergedRenderer};
