/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/mathUtils","../../support/buffer/BufferView","../../../../geometry/support/aaBoundingBox","../../support/buffer/InterleavedLayout","../lib/Util","../lib/geometryDataUtils","../lib/GLMaterial","./internal/MaterialUtil","../lib/Material","./internal/bufferWriterUtils","./VisualVariableMaterialParameters","../lib/PathGeometry","./PathTechnique"],(function(e,t,i,a,r,n,s,u,o,c,l,h,f,p,d,b){"use strict";const m=u.assert;let v=function(e){function r(t){var i;return(i=e.call(this,t,S)||this).supportsEdges=!0,i._vertexAttributeLocations=b.pathVertexAttributeLocations,i.techniqueConfig=new b.PathTechniqueConfiguration,i.vertexBufferLayout=r.getVertexBufferLayout(i.params),i}t._inheritsLoose(r,e);var u=r.prototype;return u.getTechniqueConfig=function(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.vvSize=this.params.vvSizeEnabled,this.techniqueConfig.vvColor=this.params.vvColorEnabled,this.techniqueConfig.vvOpacity=this.params.vvOpacityEnabled,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.transparent=this.params.transparent,this.techniqueConfig.sceneHasOcludees=this.params.sceneHasOcludees,0!==e&&7!==e||(this.techniqueConfig.doubleSidedMode=this.params.doubleSided&&"normal"===this.params.doubleSidedType?1:this.params.doubleSided&&"winding-order"===this.params.doubleSidedType?2:0,this.techniqueConfig.receiveShadows=this.params.receiveShadows,this.techniqueConfig.receiveSSAO=!(!t||!t.ssaoEnabled)&&this.params.receiveSSAO),this.techniqueConfig.transparencyPassType=t?t.transparencyPassType:3,this.techniqueConfig.multipassTerrainEnabled=!!t&&t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=!t||t.cullAboveGround,this.techniqueConfig},u.getPassParameters=function(){return this.params},u.isVisibleInPass=function(e){return 4!==e&&6!==e&&7!==e||this.params.castShadows},u.isVisible=function(){const t=this.params;return!!e.prototype.isVisible.call(this)&&t.opacity>0},u.intersect=function(e,t,r,s,u,o,c){const h=e;if(!d.isPathGeometry(h))return;const f=h.path,p=[this.params.size[0],this.params.size[1]];if(this.params.vvSizeEnabled){const e=this.params.vvSizeOffset,t=this.params.vvSizeFactor,i=this.params.vvSizeMinSize,r=this.params.vvSizeMaxSize,n=f.sizeAttributeValue;p[0]*=a.clamp(e[0]+n*t[0],i[0],r[0]),p[1]*=a.clamp(e[2]+n*t[2],i[2],r[2])}const b=Math.max(p[0],p[1]),m=e.boundingInfo;if(i.isNone(m))return void this._intersectTriangles(f,p,u,o,c);const v=n.fromValues(m.bbMin[0]-b,m.bbMin[1]-b,m.bbMin[2]-b,m.bbMax[0]+b,m.bbMax[1]+b,m.bbMax[2]+b),g=[o[0]-u[0],o[1]-u[1],o[2]-u[2]],S=Math.sqrt(g[0]*g[0]+g[1]*g[1]+g[2]*g[2]),y=[S/g[0],S/g[1],S/g[2]];l.intersectAabbInvDir(v,u,y,s.tolerance)&&this._intersectTriangles(f,p,u,o,c)},u._intersectTriangles=function(e,t,i,a,r){e.baked.size&&e.baked.size[0]===t[0]&&e.baked.size[1]===t[1]||e.baked.bake(t),e.baked.intersect(i,a,r)},u.computeAttachmentOrigin=function(e,t){const i=e.vertexAttributes;if(!i)return null;const a=i.get("position");return o.computeAttachmentOriginLines(a,null,!1,t)},u.createBufferWriter=function(){return new y(this.vertexBufferLayout)},u.getGLMaterial=function(e){if(0===e.output||7===e.output||1===e.output||2===e.output||4===e.output||3===e.output&&this.params.castShadows)return new g(e)},r.getVertexBufferLayout=function(e){let t=s.newLayout().vec3f("position").vec4f("profileRight").vec4f("profileUp").vec4f("profileVertexAndNormal");return(e.vvColorEnabled||e.vvSizeEnabled||e.vvOpacityEnabled)&&(t=t.vec4f("featureValue")),t},r}(h.Material),g=function(e){function i(t){var i;return(i=e.call(this,t)||this).updateParameters(),i}t._inheritsLoose(i,e);var a=i.prototype;return a.updateParameters=function(e){this.technique=this.techniqueRep.acquireAndReleaseExisting(b.PathTechnique,this.material.getTechniqueConfig(this.output,e),this.technique)},a.beginSlot=function(e){return e===(this.technique.configuration.transparent?5:3)},a._updateOccludeeState=function(e){e.hasOccludees!==this.material.params.sceneHasOcludees&&this.material.setParameterValues({sceneHasOcludees:e.hasOccludees})},a._updateShadowState=function(e){e.shadowMappingEnabled!==this.technique.configuration.receiveShadows&&this.material.setParameterValues({receiveShadows:e.shadowMappingEnabled})},a.ensureParameters=function(e){0!==this.output&&7!==this.output||(this._updateShadowState(e),this._updateOccludeeState(e)),this.updateParameters(e)},a.bind=function(e,t){e.bindProgram(this.technique.program),this.technique.bindPass(e,this.material.getPassParameters(),t)},i}(c);const S={size:[1,1,1],ambient:[.2,.2,.2],diffuse:[.8,.8,.8],specular:[0,0,0],opacity:1,doubleSided:!1,doubleSidedType:"normal",receiveSSAO:!0,receiveShadows:!1,castShadows:!0,slicePlaneEnabled:!1,transparent:!1,sceneHasOcludees:!1,...p.Default,...h.materialParametersDefaults};let y=function(){function e(e){this.vertexBufferLayout=e}var t=e.prototype;return t.allocate=function(e){return this.vertexBufferLayout.createBuffer(e)},t.elementCount=function(e){return e.indices.get("position").length},t.write=function(e,t,i,a){const n=e=>{if(t.vertexAttributes.has(e)){const n=t.vertexAttributes.get(e),s=t.indices.get(e);m(4===n.size);const u=i.getField(e,r.BufferViewVec4f);if(!u)throw new Error("unable to acquire view for "+e);f.writeBufferVec4(s,n.data,u,a)}};n("profileRight"),n("profileUp"),n("profileVertexAndNormal"),this.vertexBufferLayout.hasField("featureValue")&&n("featureValue"),f.writeDefaultAttributes(t,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,i,a)},e}();e.PathMaterial=v,Object.defineProperty(e,"__esModule",{value:!0})}));
