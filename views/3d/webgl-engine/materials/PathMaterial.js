/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/mathUtils","../../../../core/maybe","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/buffer/BufferView","../../support/buffer/InterleavedLayout","../core/shaderLibrary/ShaderOutputOptions","../core/shaderLibrary/shading/Normals.glsl","../lib/geometryDataUtils","../lib/GLMaterial","../lib/Material","../lib/PathGeometry","../lib/RenderPass","../lib/RenderSlot","../lib/Util","../lib/VertexAttribute","./PathTechnique","./VisualVariableMaterialParameters","./internal/bufferWriterUtils","./internal/MaterialUtil"],(function(e,t,r,i,a,s,n,u,o,l,c,h,d,p,f,b,m,S,A,v,g){"use strict";let O=function(e){function s(t){var r;return(r=e.call(this,t,E)||this).supportsEdges=!0,r._vertexAttributeLocations=S.pathVertexAttributeLocations,r.techniqueConfig=new S.PathTechniqueConfiguration,r.vertexBufferLayout=s.getVertexBufferLayout(r.parameters),r}t._inheritsLoose(s,e);var c=s.prototype;return c.getTechniqueConfig=function(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.vvSize=this.parameters.vvSizeEnabled,this.techniqueConfig.vvColor=this.parameters.vvColorEnabled,this.techniqueConfig.vvOpacity=this.parameters.vvOpacityEnabled,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.transparent=this.parameters.transparent,this.techniqueConfig.sceneHasOcludees=this.parameters.sceneHasOcludees,e!==u.ShaderOutput.Color&&e!==u.ShaderOutput.Alpha||(this.techniqueConfig.doubleSidedMode=this.parameters.doubleSided&&"normal"===this.parameters.doubleSidedType?o.NormalsDoubleSidedMode.View:this.parameters.doubleSided&&"winding-order"===this.parameters.doubleSidedType?o.NormalsDoubleSidedMode.WindingOrder:o.NormalsDoubleSidedMode.None,this.techniqueConfig.receiveShadows=this.parameters.receiveShadows,this.techniqueConfig.receiveSSAO=!!t.ssaoEnabled&&this.parameters.receiveSSAO),this.techniqueConfig.transparencyPassType=t.transparencyPassType,this.techniqueConfig.multipassTerrainEnabled=t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=t.cullAboveGround,this.techniqueConfig},c.getPassParameters=function(){return this.parameters},c.isVisibleInPass=function(e){return e!==p.RenderPass.MATERIAL_DEPTH_SHADOWMAP_ALL&&e!==p.RenderPass.MATERIAL_DEPTH_SHADOWMAP_DEFAULT&&e!==p.RenderPass.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT||this.parameters.castShadows},c.isVisible=function(){const t=this.parameters;return!!e.prototype.isVisible.call(this)&&t.opacity>0},c.intersect=function(e,t,s,n,u,o,l){const c=e;if(!d.isPathGeometry(c))return;const h=c.path,p=[this.parameters.size[0],this.parameters.size[1]];if(this.parameters.vvSizeEnabled){const e=this.parameters.vvSizeOffset,t=this.parameters.vvSizeFactor,i=this.parameters.vvSizeMinSize,a=this.parameters.vvSizeMaxSize,s=h.sizeAttributeValue;p[0]*=r.clamp(e[0]+s*t[0],i[0],a[0]),p[1]*=r.clamp(e[2]+s*t[2],i[2],a[2])}const f=Math.max(p[0],p[1]),b=e.boundingInfo;if(i.isNone(b))return void this._intersectTriangles(h,p,u,o,l);const m=a.fromValues(b.bbMin[0]-f,b.bbMin[1]-f,b.bbMin[2]-f,b.bbMax[0]+f,b.bbMax[1]+f,b.bbMax[2]+f),S=[o[0]-u[0],o[1]-u[1],o[2]-u[2]],A=Math.sqrt(S[0]*S[0]+S[1]*S[1]+S[2]*S[2]),v=[A/S[0],A/S[1],A/S[2]];g.intersectAabbInvDir(m,u,v,n.tolerance)&&this._intersectTriangles(h,p,u,o,l)},c._intersectTriangles=function(e,t,r,i,a){e.baked.size&&e.baked.size[0]===t[0]&&e.baked.size[1]===t[1]||e.baked.bake(t),e.baked.intersect(r,i,a)},c.computeAttachmentOrigin=function(e,t){const r=e.vertexAttributes;if(!r)return null;const i=r.get(m.VertexAttribute.POSITION);return l.computeAttachmentOriginLines(i,null,!1,t)},c.createBufferWriter=function(){return new T(this.vertexBufferLayout)},c.requiresSlot=function(e){return e===(this.parameters.transparent?f.RenderSlot.TRANSPARENT_MATERIAL:f.RenderSlot.OPAQUE_MATERIAL)||e===f.RenderSlot.DRAPED_MATERIAL},c.createGLMaterial=function(e){return e.output===u.ShaderOutput.Color||e.output===u.ShaderOutput.Alpha||e.output===u.ShaderOutput.Depth||e.output===u.ShaderOutput.Normal||e.output===u.ShaderOutput.Highlight||e.output===u.ShaderOutput.Shadow&&this.parameters.castShadows?new P(e):null},s.getVertexBufferLayout=function(e){let t=n.newLayout().vec3f(m.VertexAttribute.POSITION).vec4f(m.VertexAttribute.PROFILERIGHT).vec4f(m.VertexAttribute.PROFILEUP).vec4f(m.VertexAttribute.PROFILEVERTEXANDNORMAL);return(e.vvColorEnabled||e.vvSizeEnabled||e.vvOpacityEnabled)&&(t=t.vec4f(m.VertexAttribute.FEATUREVALUE)),t},s}(h.Material),P=function(e){function r(){return e.apply(this,arguments)||this}t._inheritsLoose(r,e);var a=r.prototype;return a.updateParameters=function(e){return this.ensureTechnique(S.PathTechnique,e)},a._updateOccludeeState=function(e){e.hasOccludees!==this._material.parameters.sceneHasOcludees&&this._material.setParameters({sceneHasOcludees:e.hasOccludees})},a._updateShadowState=function(e){(i.isNone(this.technique)||e.shadowMappingEnabled!==this.technique.configuration.receiveShadows)&&this._material.setParameters({receiveShadows:e.shadowMappingEnabled})},a.beginSlot=function(e){return this._output!==u.ShaderOutput.Color&&this._output!==u.ShaderOutput.Alpha||(this._updateShadowState(e),this._updateOccludeeState(e)),this.updateParameters(e)},a.bind=function(e,t){t.bindPass(this._material.getPassParameters(),e)},r}(c);const E={size:[1,1,1],ambient:[.2,.2,.2],diffuse:[.8,.8,.8],specular:[0,0,0],opacity:1,doubleSided:!1,doubleSidedType:"normal",receiveSSAO:!0,receiveShadows:!1,castShadows:!0,slicePlaneEnabled:!1,transparent:!1,sceneHasOcludees:!1,...A.VisualVariableDefaultMaterialParameters,...h.DefaultMaterialParameters};let T=function(){function e(e){this.vertexBufferLayout=e}var t=e.prototype;return t.allocate=function(e){return this.vertexBufferLayout.createBuffer(e)},t.elementCount=function(e){return e.indices.get(m.VertexAttribute.POSITION).length},t.write=function(e,t,r,i){const a=e=>{if(t.vertexAttributes.has(e)){const a=t.vertexAttributes.get(e),n=t.indices.get(e);b.assert(4===a.size);const u=r.getField(e,s.BufferViewVec4f);if(!u)throw new Error("unable to acquire view for "+e);v.writeBufferVec4(n,a.data,u,i)}};a(m.VertexAttribute.PROFILERIGHT),a(m.VertexAttribute.PROFILEUP),a(m.VertexAttribute.PROFILEVERTEXANDNORMAL),this.vertexBufferLayout.hasField(m.VertexAttribute.FEATUREVALUE)&&a(m.VertexAttribute.FEATUREVALUE),v.writeDefaultAttributes(t,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,r,i)},e}();e.PathMaterial=O,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
