/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/mathUtils","../../../../core/maybe","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/buffer/BufferView","../../support/buffer/InterleavedLayout","../lib/geometryDataUtils","../lib/GLMaterial","../lib/Material","../lib/PathGeometry","../lib/Util","./PathTechnique","./VisualVariableMaterialParameters","./internal/bufferWriterUtils","./internal/MaterialUtil"],(function(e,t,i,a,r,n,s,u,o,c,l,h,f,p,d,b){"use strict";const m=h.assert;let v=function(e){function n(t){var i;return(i=e.call(this,t,S)||this).supportsEdges=!0,i._vertexAttributeLocations=f.pathVertexAttributeLocations,i.techniqueConfig=new f.PathTechniqueConfiguration,i.vertexBufferLayout=n.getVertexBufferLayout(i.params),i}t._inheritsLoose(n,e);var o=n.prototype;return o.getTechniqueConfig=function(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.vvSize=this.params.vvSizeEnabled,this.techniqueConfig.vvColor=this.params.vvColorEnabled,this.techniqueConfig.vvOpacity=this.params.vvOpacityEnabled,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.transparent=this.params.transparent,this.techniqueConfig.sceneHasOcludees=this.params.sceneHasOcludees,0!==e&&7!==e||(this.techniqueConfig.doubleSidedMode=this.params.doubleSided&&"normal"===this.params.doubleSidedType?1:this.params.doubleSided&&"winding-order"===this.params.doubleSidedType?2:0,this.techniqueConfig.receiveShadows=this.params.receiveShadows,this.techniqueConfig.receiveSSAO=!(!t||!t.ssaoEnabled)&&this.params.receiveSSAO),this.techniqueConfig.transparencyPassType=t?t.transparencyPassType:3,this.techniqueConfig.multipassTerrainEnabled=!!t&&t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=!!t&&t.cullAboveGround,this.techniqueConfig},o.getPassParameters=function(){return this.params},o.isVisibleInPass=function(e){return 4!==e&&6!==e&&7!==e||this.params.castShadows},o.isVisible=function(){const t=this.params;return!!e.prototype.isVisible.call(this)&&t.opacity>0},o.intersect=function(e,t,n,s,u,o,c){const h=e;if(!l.isPathGeometry(h))return;const f=h.path,p=[this.params.size[0],this.params.size[1]];if(this.params.vvSizeEnabled){const e=this.params.vvSizeOffset,t=this.params.vvSizeFactor,a=this.params.vvSizeMinSize,r=this.params.vvSizeMaxSize,n=f.sizeAttributeValue;p[0]*=i.clamp(e[0]+n*t[0],a[0],r[0]),p[1]*=i.clamp(e[2]+n*t[2],a[2],r[2])}const d=Math.max(p[0],p[1]),m=e.boundingInfo;if(a.isNone(m))return void this._intersectTriangles(f,p,u,o,c);const v=r.fromValues(m.bbMin[0]-d,m.bbMin[1]-d,m.bbMin[2]-d,m.bbMax[0]+d,m.bbMax[1]+d,m.bbMax[2]+d),g=[o[0]-u[0],o[1]-u[1],o[2]-u[2]],S=Math.sqrt(g[0]*g[0]+g[1]*g[1]+g[2]*g[2]),y=[S/g[0],S/g[1],S/g[2]];b.intersectAabbInvDir(v,u,y,s.tolerance)&&this._intersectTriangles(f,p,u,o,c)},o._intersectTriangles=function(e,t,i,a,r){e.baked.size&&e.baked.size[0]===t[0]&&e.baked.size[1]===t[1]||e.baked.bake(t),e.baked.intersect(i,a,r)},o.computeAttachmentOrigin=function(e,t){const i=e.vertexAttributes;if(!i)return null;const a=i.get("position");return u.computeAttachmentOriginLines(a,null,!1,t)},o.createBufferWriter=function(){return new y(this.vertexBufferLayout)},o.getGLMaterial=function(e){if(0===e.output||7===e.output||1===e.output||2===e.output||4===e.output||3===e.output&&this.params.castShadows)return new g(e)},n.getVertexBufferLayout=function(e){let t=s.newLayout().vec3f("position").vec4f("profileRight").vec4f("profileUp").vec4f("profileVertexAndNormal");return(e.vvColorEnabled||e.vvSizeEnabled||e.vvOpacityEnabled)&&(t=t.vec4f("featureValue")),t},n}(c.Material),g=function(e){function i(t){var i;return(i=e.call(this,t)||this).updateParameters(),i}t._inheritsLoose(i,e);var a=i.prototype;return a.updateParameters=function(e){this._technique=this._techniqueRep.releaseAndAcquire(f.PathTechnique,this._material.getTechniqueConfig(this._output,e),this._technique)},a.beginSlot=function(e){return e===(this._technique.configuration.transparent?5:3)},a._updateOccludeeState=function(e){e.hasOccludees!==this._material.params.sceneHasOcludees&&this._material.setParameterValues({sceneHasOcludees:e.hasOccludees})},a._updateShadowState=function(e){e.shadowMappingEnabled!==this._technique.configuration.receiveShadows&&this._material.setParameterValues({receiveShadows:e.shadowMappingEnabled})},a.ensureParameters=function(e){0!==this._output&&7!==this._output||(this._updateShadowState(e),this._updateOccludeeState(e)),this.updateParameters(e)},a.bind=function(e){this._technique.bindPass(this._material.getPassParameters(),e)},i}(o);const S={size:[1,1,1],ambient:[.2,.2,.2],diffuse:[.8,.8,.8],specular:[0,0,0],opacity:1,doubleSided:!1,doubleSidedType:"normal",receiveSSAO:!0,receiveShadows:!1,castShadows:!0,slicePlaneEnabled:!1,transparent:!1,sceneHasOcludees:!1,...p.Default,...c.materialParametersDefaults};let y=function(){function e(e){this.vertexBufferLayout=e}var t=e.prototype;return t.allocate=function(e){return this.vertexBufferLayout.createBuffer(e)},t.elementCount=function(e){return e.indices.get("position").length},t.write=function(e,t,i,a){const r=e=>{if(t.vertexAttributes.has(e)){const r=t.vertexAttributes.get(e),s=t.indices.get(e);m(4===r.size);const u=i.getField(e,n.BufferViewVec4f);if(!u)throw new Error("unable to acquire view for "+e);d.writeBufferVec4(s,r.data,u,a)}};r("profileRight"),r("profileUp"),r("profileVertexAndNormal"),this.vertexBufferLayout.hasField("featureValue")&&r("featureValue"),d.writeDefaultAttributes(t,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,i,a)},e}();e.PathMaterial=v,Object.defineProperty(e,"__esModule",{value:!0})}));
