/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/promiseUtils","../../../../chunks/vec4f64","../lib/AutoDisposable","../../../support/screenshotUtils","../../../webgl/FramebufferObject"],(function(e,t,r,n,i,s,o,a){"use strict";let c=function(e){function s(t,r,n,i=null,s,o=!0){var a;return(a=e.call(this)||this)._rctx=t,a._renderScene=r,a._requestRenderScene=n,a._renderOverlay=i,a.forceCameraHook=s,a.supersample=o,a._screenshotQueue=new Array,a}t._inheritsLoose(s,e);var c=s.prototype;return c.dispose=function(){this._rctx=null},c.takeScreenshot=function(e){this._requestRenderScene(0);const t=n.createResolver();return this._screenshotQueue.push({settings:e,resolver:t}),t.promise},c.update=function(e){for(const t of this._screenshotQueue){if(this.isDisposed){t.resolver.reject();continue}const r={...t.settings,pixelRatio:t.settings.pixelRatio*e.viewCamera.pixelRatio},n=this._ensureScreenshotEncodeCanvas(),i=this._renderScreenshot(e,r),s=o.encodeResult(i,r,n,{flipY:!0,premultipliedAlpha:!0});t.resolver(s)}this._screenshotQueue.length=0},c._renderScreenshotOverlay=function(e,t,n){if(r.isNone(this._renderOverlay))return t;e.width=t.width,e.height=t.height;const i=e.getContext("2d"),s=n.pixelRatio;return i.save(),i.translate(0,t.height),i.scale(1,-1),n.region&&i.translate(-n.region.x,-n.region.y),i.scale(s,s),t=this._renderOverlay(e,t),i.restore(),t},c._readbackScreenshot=function(e){return e.resample?this._readbackScreenshotResampled(e):this._readbackScreenshotImmediate(e)},c._readbackScreenshotResampled=function(e){const{framebufferWidth:t,framebufferHeight:r,region:n,resample:i}=e,s=this._ensureScreenshotEncodeCanvas();let a=o.createEmptyImageData(t,r,s);this._rctx.gl.readPixels(0,0,t,r,6408,5121,new Uint8Array(a.data.buffer)),a=this._renderScreenshotOverlay(s,a,{...e,region:null});const c=o.createEmptyImageData(n.width,n.height,s);return o.resampleHermite(a,c,!0,i.region.x,r-(i.region.y+i.region.height),i.region.width,i.region.height)},c._readbackScreenshotImmediate=function(e){const{framebufferHeight:t,region:r}=e,n=this._ensureScreenshotEncodeCanvas(),i=o.createEmptyImageData(r.width,r.height,n);return this._rctx.gl.readPixels(r.x,t-(r.y+r.height),r.width,r.height,6408,5121,new Uint8Array(i.data.buffer)),this._renderScreenshotOverlay(n,i,e)},c._renderScreenshot=function(e,t){let r=null;const n=e.viewCamera,{framebufferWidth:s,framebufferHeight:o}=t;let c=!1;const h=t.disableDecorations&&e.frameHasDecorations,l=s!==n.fullWidth||o!==n.fullHeight,u=t.ignorePadding&&n.pixelRatio!==t.pixelRatio,d=l||h||u;if(d){const e=n.clone();if(t.ignorePadding){const r=i.clone(e.padding);for(let n=0;n<4;n++)r[n]=Math.round(r[n]/e.pixelRatio*t.pixelRatio);e.padding=r}e.fullWidth=s,e.fullHeight=o,e.pixelRatio=t.pixelRatio;const h=n.fovX-e.fovX,l=n.fovY-e.fovY;h<0&&h<l?e.fovX=n.fovX:l<0&&l<h&&(e.fovY=n.fovY),this.forceCameraHook(e),c=!0,r=new a(this._rctx,{width:e.fullWidth,height:e.fullHeight,colorTarget:0,depthStencilTarget:3}),this._renderScene(r,e,t.disableDecorations?0:1),!0===t.renderScreenshotTwice&&this._renderScene(r,e,t.disableDecorations?0:1)}const f=this._readbackScreenshot(t);if(d&&!this._rctx.contextAttributes.alpha)for(let i=3;i<f.data.length;i+=4)f.data[i]=255;return r&&r.dispose(),this._rctx.bindFramebuffer(null),c&&this.forceCameraHook(n),f},c._ensureScreenshotEncodeCanvas=function(){return this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas")),this._screenshotEncodeCanvas},s}(s.AutoDisposable);e.ScreenshotManager=c,Object.defineProperty(e,"__esModule",{value:!0})}));
