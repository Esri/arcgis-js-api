/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/promiseUtils","../../../../chunks/vec4f64","../lib/AutoDisposable","../lib/basicInterfaces","../../../support/screenshotUtils","../../../webgl/enums","../../../webgl/FramebufferObject","../../../../core/imageUtils"],(function(e,t,r,n,i,s,o,a,c,h,l){"use strict";let u=function(e,t){this.viewCamera=e,this.frameHasDecorations=t},f=function(e){function s(t,r,n,i){var s;return(s=e.call(this)||this)._rctx=t,s._renderFunctions=r,s._forceCameraHook=n,s._disposeOffscreenBuffers=i,s.supersample=!0,s._screenshotQueue=new Array,s}t._inheritsLoose(s,e);var u=s.prototype;return u.dispose=function(){this._rctx=null},u.takeScreenshot=function(){var e=t._asyncToGenerator((function*(e){yield this._renderFunctions.prepareOverlay(),this._renderFunctions.requestRenderScene(o.RenderRequestType.BACKGROUND);const t=n.createResolver();return this._screenshotQueue.push({settings:e,resolver:t}),t.promise}));function r(t){return e.apply(this,arguments)}return r}(),u.update=function(e,t){for(const r of this._screenshotQueue){if(this.isDisposed){r.resolver.reject();continue}const n={...r.settings,pixelRatio:r.settings.pixelRatio*e.viewCamera.pixelRatio},i=this._renderScreenshot(e,n,t);r.resolver(i)}this._screenshotQueue.length=0},u._renderScreenshotOverlay=function(e,t,r){e.width=t.width,e.height=t.height;const n=e.getContext("2d"),i=r.pixelRatio;return n.save(),n.translate(0,t.height),n.scale(1,-1),r.region&&n.translate(-r.region.x,-r.region.y),n.scale(i,i),t=this._renderFunctions.renderOverlay(e,t),n.restore(),t},u._readbackScreenshot=function(e,t){return e.resample?this._readbackScreenshotResampled(e,t):this._readbackScreenshotImmediate(e,t)},u._readbackScreenshotResampled=function(e,t){const{framebufferWidth:r,framebufferHeight:n,region:i,resample:s}=e,o=this._ensureScreenshotEncodeCanvas();let h=l.createEmptyImageData(r,n,o);this._rctx.gl.readPixels(0,0,r,n,c.PixelFormat.RGBA,c.DataType.UNSIGNED_BYTE,new Uint8Array(h.data.buffer)),t(),h=this._renderScreenshotOverlay(o,h,{...e,region:null});const u=l.createEmptyImageData(i.width,i.height,o);return a.resampleHermite(h,u,!0,s.region.x,n-(s.region.y+s.region.height),s.region.width,s.region.height)},u._readbackScreenshotImmediate=function(e,t){const{framebufferHeight:r,region:n}=e,i=this._ensureScreenshotEncodeCanvas(),s=l.createEmptyImageData(n.width,n.height,i);return this._rctx.gl.readPixels(n.x,r-(n.y+n.height),n.width,n.height,c.PixelFormat.RGBA,c.DataType.UNSIGNED_BYTE,new Uint8Array(s.data.buffer)),t(),this._renderScreenshotOverlay(i,s,e)},u._renderScreenshot=function(e,t,n){let s=null,a=null;const l=e.viewCamera,{framebufferWidth:u,framebufferHeight:f}=t;let d=!1;const g=t.disableDecorations&&e.frameHasDecorations,p=u!==l.fullWidth||f!==l.fullHeight,_=t.ignorePadding&&l.pixelRatio!==t.pixelRatio,b=p||g||_||t.objectAndLayerIdColor;if(t.objectAndLayerIdColor&&(a=new h.FramebufferObject(this._rctx,{width:u,height:f,colorTarget:c.TargetType.TEXTURE,depthStencilTarget:c.DepthStencilTargetType.DEPTH_STENCIL_RENDER_BUFFER})),b){const e=l.clone();if(t.ignorePadding){const r=i.clone(e.padding);for(let n=0;n<4;n++)r[n]=Math.round(r[n]/e.pixelRatio*t.pixelRatio);e.padding=r}e.fullWidth=u,e.fullHeight=f,e.pixelRatio=t.pixelRatio;const r=l.fovX-e.fovX,g=l.fovY-e.fovY;r<0&&r<g?e.fovX=l.fovX:g<0&&g<r&&(e.fovY=l.fovY),this._forceCameraHook(e),d=!0,s=new h.FramebufferObject(this._rctx,{width:e.fullWidth,height:e.fullHeight,colorTarget:c.TargetType.TEXTURE,depthStencilTarget:c.DepthStencilTargetType.DEPTH_STENCIL_RENDER_BUFFER}),this._renderFunctions.renderScene(s,a,e,t.disableDecorations?o.Decorations.OFF:o.Decorations.ON,n),this._disposeOffscreenBuffers()}const m=()=>{this._rctx.bindFramebuffer(null),r.disposeMaybe(s)},v=this._readbackScreenshot(t,m);m();let x=null;if(t.objectAndLayerIdColor){const e=()=>{this._rctx.bindFramebuffer(null),r.disposeMaybe(a)};this._rctx.bindFramebuffer(a),x=this._readbackScreenshot(t,e),this._rctx.bindFramebuffer(null),e()}if(b&&!this._rctx.contextAttributes.alpha)for(let r=3;r<v.data.length;r+=4)v.data[r]=255;if(x&&!this._rctx.contextAttributes.alpha)for(let r=3;r<x.data.length;r+=4)x.data[r]=255;return d&&this._forceCameraHook(l),[v,x]},u._ensureScreenshotEncodeCanvas=function(){return this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas")),this._screenshotEncodeCanvas},s}(s.AutoDisposable);e.ScreenshotContext=u,e.ScreenshotManager=f,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
