/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/has","../../../../core/maybe","../../../../core/Logger","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/decorators/subclass","../../../../core/urlUtils","../../../../core/uuid","../../../../portal/support/resourceExtension","../../../../core/scheduling","../../../../core/Accessor","../../../../core/Evented","../../../../layers/support/timeUtils","../../../../core/watchUtils","../../../webgl/context-util","../lib/AutoDisposable","../../../webgl/RenderingContext","../core/shaderTechnique/CommonUniformStore","../core/shaderTechnique/ShaderTechniqueRepository","../lib/GLMaterialRep","../materials/lineStippleUtils","../lib/WebGLDriverTest","../../support/animationUtils","./requireUtils","../statistics/tracer","../collections/Component/ComponentObjectCollection","../lib/CompositingHelper","../lib/depthRangeUtils","../lib/MagnifierHelper","../lib/Renderer","../lib/TextureRepository","../materials/internal/WaterTextureRepository","./ScreenshotManager"],(function(e,t,r,n,i,o,s,a,d,c,p,u,l,h,_,g,m,y,R,f,x,w,v,b,T,C,U,M,S,V,k,D,O,A,H,L){"use strict";const E=o.getLogger("esri.views.3d.webgl-engine.parts.View");let q=null;e.RenderView=function(e){function r(t){var r;(r=e.call(this,{})||this)._stage=t,r.events=new _,r._stippleTextureRepository=new b.StippleTextureRepository,r.waterTextureRepository=new H.WaterTextureRepository,r._magnifierHelper=new D.MagnifierHelper,r._commonUniformStore=new x.CommonUniformStore,r._componentObjectCollection=null,r._needsUpdate=!0,r._needsRender=!0,r._idleSuspend=!0,r._logicUpdateLast=0,r._container=r._stage.container,r._initializeContext(r._stage.options),m.init(r.waterTextureRepository,"loadingState",(()=>r.setNeedsRender())),r._magnifierHelper.events.on("request-render",(()=>r.setNeedsRender())),r._shaderTechniqueRepository=new w.ShaderTechniqueRepository({rctx:r._rctx,viewingMode:r._stage.options.viewingMode,commonUniformStore:r._commonUniformStore,stippleTextureRepository:r._stippleTextureRepository,waterTextureRepository:r.waterTextureRepository}),r._textureRepository=new A.TextureRepository(r._stage.scheduler,r._stage.getAll(4),r._shaderTechniqueRepository,r._rctx),r._textureRepository.events.on("changed",(e=>r.setNeedsRender(e))),r._materialRepository=new v(r._textureRepository,r._shaderTechniqueRepository,(()=>r.setNeedsRender())),r._compositingHelper=new V(r._rctx,r._shaderTechniqueRepository);const n=r._container.getBoundingClientRect();return r._renderer=new O(r._materialRepository,r._textureRepository,r._shaderTechniqueRepository,r._rctx,r._compositingHelper,r._magnifierHelper,((e=1)=>r.setNeedsRender(e)),[n.width,n.height],r._stage),r._screenshotManager=new L.ScreenshotManager(r._rctx,((e,t,n)=>r._render(e,t,n)),(()=>r.setNeedsRender()),r._stage.options.screenshot.renderOverlay,(e=>r.events.emit("force-camera-for-screenshot",e))),r._registerFrameTask(),r}t._inheritsLoose(r,e);var o=r.prototype;return o.normalizeCtorArgs=function(){return{}},o.dispose=function(){this._container.contains(this._canvas)&&this._container.removeChild(this._canvas),this._frameTask&&(this._frameTask.remove(),this._frameTask=null),this._shaderTechniqueRepository.dispose(),this._shaderTechniqueRepository=null,T.clearTestWebGLDriver(this._rctx),e.prototype.dispose.call(this),this._rctx=null},o.setNeedsRender=function(e=1){1===e?this._needsUpdate||(this._needsUpdate=!0,this.notifyChange("updating")):this._needsRender=!0},o.evaluateUpdating=function(){return this.needsUpdate||this._renderer.updating||this._textureRepository.loadingCount>0||this.waterTextureRepository.updating||this._magnifierHelper.updating||this._stage.dirty},o.ensureEdgeView=function(){return this._renderer.ensureEdgeView()},o.setRenderParameters=function(e){this.setNeedsRender(),void 0!==e.idleSuspend&&(this._idleSuspend=!!e.idleSuspend),this._renderer.setRenderParameters(e)},o.has=function(e){switch(e){case 0:return!!this._rctx.capabilities.compressedTextureS3TC;case 1:return!!this._rctx.capabilities.shaderTextureLOD;case 2:return this._renderer.hasShadowsEnabled;default:return!1}},o.modify=function(e,t,r){this._renderer.modify(e,e.length,t,t.length,r,r.length)},o.setCamera=function(e){this._renderer.camera=e},o.getCamera=function(){return this._renderer.camera},o.getCanvas=function(){return this._canvas},o.takeScreenshot=function(e){return this._screenshotManager.takeScreenshot(e)},o.getMinimalDepthForArea=function(e,t,r,n=80,i=1){const o=n*r.pixelRatio,s=r.constrainWindowSize(e,t,o,i);q=new Uint8Array(4*s[2]*s[3]),this._renderer.readDepthPixels(s[0],s[1],s[2],s[3],q);let a=Number.MAX_VALUE;for(let e=0;e<s[2]*s[3];e++){const t=k.texure2depth(4*e,q,r.nearFar);a>t&&t!==r.nearFar[0]&&t!==r.nearFar[1]&&(a=t)}return a===Number.MAX_VALUE?void 0:a},o.getGpuMemoryUsage=function(){return this._renderer.getGpuMemoryUsage()},o.hotReloadShaders=async function(){U.removeLoadedShaderModules(),await this._shaderTechniqueRepository.hotReload(),this.setNeedsRender()},o._registerFrameTask=function(){const e={viewCamera:this._renderer.camera,frameHasDecorations:!1};let t=!1;const r={preRender:e=>{t=this.evaluateUpdating(),M.begin();let r=!1;this._stage.processDirty();const n=g.Milliseconds(e.time-this._logicUpdateLast);if(n>C.DESIRED_ANIMATION_MS){const t={camera:this._renderer.camera,dt:n};r=this._renderer.updateLogic(t),this._logicUpdateLast=e.time}r&&this.setNeedsRender(0)},render:()=>{!this.needsUpdate&&!this._needsRender&&this._idleSuspend&&this._renderer.isCameraFinal||!this.canRender||(this._needsRender=!1,this._needsUpdate=!1,this._render(null,this._renderer.camera,!1))},postRender:()=>{t!==this.evaluateUpdating()&&this.notifyChange("updating"),M.end()},update:()=>{e.viewCamera=this._renderer.camera,e.frameHasDecorations=this._renderer.hasSlicePlane||this._magnifierHelper.enabled,this._textureRepository.update(),this._screenshotManager.update(e)}};this._frameTask=l.addFrameTask(r)},o._initializeContext=function(e){this._canvas=e.canvas,this._canvas||(this._canvas=document.createElement("canvas")),this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");const t={alpha:e.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:null==e.stencil||e.stencil,powerPreference:"high-performance"},r=M.instrumentContext(y.createContextOrErrorHTML(this._canvas,t,e.renderContext)),i={disabledExtensions:e.deactivatedWebGLExtensions||{},debugWebGLExtensions:e.debugWebGLExtensions||{}};this._rctx=new f(r,i),null!=this._rctx.parameters.maxMaxAnisotropy&&(this._rctx.parameters.maxMaxAnisotropy=Math.min(this._rctx.parameters.maxMaxAnisotropy,8)),this._loadShaderOnlyExtensions(this._rctx),!e.alpha&&this._rctx.contextAttributes.alpha&&E.error("WebGL context has alpha channel even though no alpha channel was requested"),!this._rctx.contextAttributes.alpha&&n("safari")>=11&&(this._container.style.backgroundColor="black"),this._container.appendChild(this._canvas)},o._render=function(e,t,r){this._renderer.render(e,t,r)},o._loadShaderOnlyExtensions=function(e){const t=e.capabilities;t.standardDerivatives,t.shaderTextureLOD,t.textureFloat},t._createClass(r,[{key:"performanceInfo",get:function(){const e=this._rctx.gl;return{renderer:this._renderer.performanceInfo,textureMemory:void 0!==e.getUsedTextureMemory?e.getUsedTextureMemory():void 0,renderbufferMemory:void 0!==e.getUsedRenderbufferMemory?e.getUsedRenderbufferMemory():void 0,VBOMemory:void 0!==e.getUsedVBOMemory?e.getUsedVBOMemory():void 0}}},{key:"canRender",get:function(){return this._renderer.canRender}},{key:"needsUpdate",get:function(){return this._needsUpdate}},{key:"updating",get:function(){return this.evaluateUpdating()}},{key:"edgeView",get:function(){return this._renderer.edgeView}},{key:"textureRepository",get:function(){return this._textureRepository}},{key:"compositingHelper",get:function(){return this._compositingHelper}},{key:"magnifier",set:function(e){this._magnifierHelper.magnifier=e}},{key:"renderingContext",get:function(){return this._rctx}},{key:"renderPlugins",get:function(){return this._renderer.renderPlugins}},{key:"test",get:function(){return{renderer:this._renderer}}},{key:"componentObjectCollection",get:function(){return i.isNone(this._componentObjectCollection)&&(this._componentObjectCollection=new S.ComponentObjectCollection(this._renderer.renderPassManager)),this._componentObjectCollection},set:function(e){this._componentObjectCollection=e}}]),r}(R.AutoDisposableMixin(h)),r.__decorate([a.property({type:Boolean,readOnly:!0,dependsOn:["waterTextureRepository.updating","_magnifierHelper.updating"],autoTracked:!1})],e.RenderView.prototype,"updating",null),r.__decorate([R.autoDispose()],e.RenderView.prototype,"_rctx",void 0),r.__decorate([R.autoDispose()],e.RenderView.prototype,"_container",void 0),r.__decorate([R.autoDispose()],e.RenderView.prototype,"_canvas",void 0),r.__decorate([R.autoDispose()],e.RenderView.prototype,"_stippleTextureRepository",void 0),r.__decorate([R.autoDispose(),a.property()],e.RenderView.prototype,"waterTextureRepository",void 0),r.__decorate([R.autoDispose(),a.property()],e.RenderView.prototype,"_magnifierHelper",void 0),r.__decorate([R.autoDispose()],e.RenderView.prototype,"_textureRepository",void 0),r.__decorate([R.autoDispose()],e.RenderView.prototype,"_commonUniformStore",void 0),r.__decorate([R.autoDispose()],e.RenderView.prototype,"_compositingHelper",void 0),r.__decorate([R.autoDispose()],e.RenderView.prototype,"_renderer",void 0),r.__decorate([R.autoDispose()],e.RenderView.prototype,"_screenshotManager",void 0),r.__decorate([R.autoDispose()],e.RenderView.prototype,"componentObjectCollection",null),r.__decorate([R.autoDispose()],e.RenderView.prototype,"_componentObjectCollection",void 0),e.RenderView=r.__decorate([d.subclass("esri.views.3d.webgl-engine.parts.RenderView")],e.RenderView),Object.defineProperty(e,"__esModule",{value:!0})}));
