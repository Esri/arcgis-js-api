/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Evented","../../../../core/has","../../../../core/Logger","../../../../core/maybe","../../../../core/scheduling","../../../../core/time","../../../../core/watchUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","../../support/animationUtils","../collections/Component/ComponentObjectCollection","../core/shaderTechnique/ShaderTechniqueRepository","../lib/AutoDisposable","../lib/CompositingHelper","../lib/depthRangeUtils","../lib/GLMaterialRep","../lib/MagnifierHelper","../lib/Renderer","../lib/TextureRepository","../lib/WebGLDriverTest","../materials/StippleTextureRepository","../materials/internal/WaterTextureRepository","./requireUtils","./ScreenshotManager","../../../webgl/context-util","../../../webgl/RenderingContext"],(function(e,t,r,i,n,s,o,a,d,c,p,u,h,l,_,g,f,y,m,R,x,v,b,w,T,S,U,M,C,D,k){"use strict";const V=o.getLogger("esri.views.3d.webgl-engine.parts.View");e.RenderView=function(e){function r(t){var r;return(r=e.call(this,{})||this).events=new n,r.waterTextureRepository=new U.WaterTextureRepository,r._magnifierHelper=new v.MagnifierHelper,r._componentObjectCollection=null,r._needsUpdate=!0,r._needsRender=!0,r._idleSuspend=!0,r._needsWaterReflectionUpdate=!1,r._logicUpdateLast=0,r._container=t.container,r._initializeContext(t.options),p.init(r.waterTextureRepository,"loadingState",(()=>r.setNeedsRender())),r._magnifierHelper.events.on("request-render",(()=>r.setNeedsRender())),r._stippleTextureRepository=new S.StippleTextureRepository(r._rctx),r._shaderTechniqueRepository=new f.ShaderTechniqueRepository({rctx:r._rctx,viewingMode:t.viewingMode,stippleTextureRepository:r._stippleTextureRepository,waterTextureRepository:r.waterTextureRepository}),r._textureRepository=new w.TextureRepository(t,r._shaderTechniqueRepository,r._rctx),r._textureRepository.events.on("changed",(e=>r.setNeedsRender(e))),r._materialRepository=new x(r._textureRepository,r._shaderTechniqueRepository,(()=>r.setNeedsRender())),r._compositingHelper=new m(r._rctx,r._shaderTechniqueRepository),r._renderer=new b(r._materialRepository,r._textureRepository,r._shaderTechniqueRepository,r._rctx,r._compositingHelper,r._magnifierHelper,((e=1)=>r.setNeedsRender(e)),((e,r)=>t.schedule(e,r)),t),r._screenshotManager=new C.ScreenshotManager(r._rctx,((e,t,i)=>r._renderer.render(e,t,t,i)),(()=>r.setNeedsRender()),t.options.screenshot.renderOverlay,(e=>r.events.emit("force-camera-for-screenshot",e))),r._registerFrameTask(t),r}t._inheritsLoose(r,e);var i=r.prototype;return i.normalizeCtorArgs=function(){return{}},i.dispose=function(){this._container.contains(this._canvas)&&this._container.removeChild(this._canvas),this._frameTask&&(this._frameTask.remove(),this._frameTask=null),this._shaderTechniqueRepository.dispose(),this._shaderTechniqueRepository=null,T.clearTestWebGLDriver(this._rctx),e.prototype.dispose.call(this),this._tmpDepthBuffer=null,this._rctx=null},i.setNeedsRender=function(e=1){1===e?this._needsUpdate||(this._needsUpdate=!0,this.notifyChange("updating")):this._needsRender=!0},i.evaluateUpdating=function(){return this.needsUpdate||this._needsWaterReflectionUpdate||this._renderer.updating||this._textureRepository.updating||this.waterTextureRepository.updating||this._magnifierHelper.updating},i.ensureEdgeView=function(){return this._renderer.ensureEdgeView()},i.updateLightSources=function(e,t,r){this._renderer.updateLightSources(e,t,r),this.setNeedsRender()},i.setRenderParameters=function(e){void 0!==e.idleSuspend&&this._idleSuspend!==!!e.idleSuspend&&(this._idleSuspend=!!e.idleSuspend,this.setNeedsRender()),this._renderer.setRenderParameters(e)},i.modify=function(e){this._renderer.modify(e),e.clear()},i.takeScreenshot=function(e){return this._screenshotManager.takeScreenshot(e)},i.readAccumulatedShadow=function(e){return this._renderer.readAccumulatedShadow(e[0],e[1])},i.getMinimalDepthForArea=function(e,t,r,i,n=i){const s=r.constrainWindowSize(e,t,i*r.pixelRatio,n*r.pixelRatio),o=this._ensureDepthBuffer(s);this._renderer.readDepthPixels(r,s[0],s[1],s[2],s[3],o);let a=Number.MAX_VALUE;for(let d=0;d<s[2]*s[3];d++){const e=R.textureToDepth(4*d,o,r.nearFar);a>e&&e!==r.nearFar[0]&&e!==r.nearFar[1]&&(a=e)}return a===Number.MAX_VALUE?void 0:a},i._ensureDepthBuffer=function(e){const t=4*e[2]*e[3];return(a.isNone(this._tmpDepthBuffer)||this._tmpDepthBuffer.byteLength<t)&&(this._tmpDepthBuffer=new Uint8Array(t)),this._tmpDepthBuffer},i.getGpuMemoryUsage=function(){return this._renderer.getGpuMemoryUsage()},i.hotReloadShaders=function(){var e=t._asyncToGenerator((function*(){M.removeLoadedShaderModules(),yield this._shaderTechniqueRepository.hotReload(),this.setNeedsRender()}));function r(){return e.apply(this,arguments)}return r}(),i._registerFrameTask=function(e){const t=e.state,r={viewCamera:t.camera,frameHasDecorations:!1};let i=!1;const n={preRender:r=>{i=this.evaluateUpdating(),e.processSyncLayers();const n=c.Milliseconds(r.time-this._logicUpdateLast);if(n>_.DESIRED_ANIMATION_MS||a.isSome(this.forcedAnimationTime)){const e={camera:t.camera,dt:n,forcedTime:this.forcedAnimationTime};this._logicUpdateLast=r.time,this._renderer.updateLogic(e)&&this.setNeedsRender(0)}},render:()=>{if((this.needsUpdate||this._needsRender||!this._idleSuspend||!this._renderer.isCameraFinal||this._needsWaterReflectionUpdate)&&t.camera.fullWidth>0&&t.camera.fullHeight>0){const e=this._needsUpdate&&this._idleSuspend&&this._renderer.isCameraFinal;this._needsRender=!1,this._needsUpdate=!1,this._needsWaterReflectionUpdate=!1,this._renderer.render(null,t.camera,t.contentCamera,!1),e&&this._renderer.hasWaterReflection&&(this.setNeedsRender(0),this._needsWaterReflectionUpdate=!0)}},postRender:()=>{i===this.updating&&i===this.evaluateUpdating()||this.notifyChange("updating")},update:()=>{r.viewCamera=t.camera,r.frameHasDecorations=this._renderer.hasSlicePlane||this._magnifierHelper.enabled,this._textureRepository.update(),this._screenshotManager.update(r)}};this._frameTask=d.addFrameTask(n)},i._initializeContext=function(e){this._canvas=e.canvas,this._canvas||(this._canvas=document.createElement("canvas")),this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");const t={alpha:e.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:null==e.stencil||e.stencil,powerPreference:"high-performance"};let r;const i=s("esri-force-webgl");if(i?r=D.createContextOrErrorHTML(this._canvas,i,t):(r=D.createContext(this._canvas,2,t),a.isNone(r)&&(r=D.createContextOrErrorHTML(this._canvas,1,t))),a.isNone(r))return void V.error(i);const n={disabledExtensions:e.deactivatedWebGLExtensions||{},debugWebGLExtensions:e.debugWebGLExtensions||{},maxAnisotropy:8};this._rctx=new k(r,n),T.testWebGLDriver(this._rctx),this._loadShaderOnlyExtensions(),!e.alpha&&this._rctx.contextAttributes.alpha&&V.error("WebGL context has alpha channel even though no alpha channel was requested"),!this._rctx.contextAttributes.alpha&&s("safari")>=11&&(this._container.style.backgroundColor="black"),this._container.appendChild(this._canvas)},i._loadShaderOnlyExtensions=function(){this._rctx.capabilities.enable("standardDerivatives"),this._rctx.capabilities.enable("shaderTextureLOD"),this._rctx.capabilities.enable("textureFloat")},t._createClass(r,[{key:"performanceInfo",get:function(){const e=this._rctx.gl;return{renderer:this._renderer.performanceInfo,textureMemory:void 0!==e.getUsedTextureMemory?e.getUsedTextureMemory():void 0,renderbufferMemory:void 0!==e.getUsedRenderbufferMemory?e.getUsedRenderbufferMemory():void 0,VBOMemory:void 0!==e.getUsedVBOMemory?e.getUsedVBOMemory():void 0}}},{key:"needsUpdate",get:function(){return this._needsUpdate}},{key:"updating",get:function(){return this.evaluateUpdating()}},{key:"edgeView",get:function(){return this._renderer.edgeView}},{key:"textureRepository",get:function(){return this._textureRepository}},{key:"compositingHelper",get:function(){return this._compositingHelper}},{key:"magnifier",set:function(e){this._magnifierHelper.magnifier=e}},{key:"renderingContext",get:function(){return this._rctx}},{key:"capabilities",get:function(){return this._rctx.capabilities}},{key:"canvas",get:function(){return this._canvas}},{key:"hasShadowsEnabled",get:function(){return this._renderer.hasShadowsEnabled}},{key:"renderPlugins",get:function(){return this._renderer.renderPlugins}},{key:"test",get:function(){return{renderer:this._renderer}}},{key:"componentObjectCollection",get:function(){return a.isNone(this._componentObjectCollection)&&(this._componentObjectCollection=new g.ComponentObjectCollection(this._renderer.renderPassManager)),this._componentObjectCollection},set:function(e){this._componentObjectCollection=e}}]),r}(y.AutoDisposableMixin(i)),r.__decorate([u.property({type:Boolean,readOnly:!0})],e.RenderView.prototype,"updating",null),r.__decorate([y.autoDispose()],e.RenderView.prototype,"_rctx",void 0),r.__decorate([y.autoDispose()],e.RenderView.prototype,"_container",void 0),r.__decorate([y.autoDispose()],e.RenderView.prototype,"_canvas",void 0),r.__decorate([y.autoDispose()],e.RenderView.prototype,"_stippleTextureRepository",void 0),r.__decorate([y.autoDispose(),u.property()],e.RenderView.prototype,"waterTextureRepository",void 0),r.__decorate([y.autoDispose(),u.property()],e.RenderView.prototype,"_magnifierHelper",void 0),r.__decorate([y.autoDispose(),u.property()],e.RenderView.prototype,"_textureRepository",void 0),r.__decorate([y.autoDispose()],e.RenderView.prototype,"_compositingHelper",void 0),r.__decorate([y.autoDispose()],e.RenderView.prototype,"_renderer",void 0),r.__decorate([y.autoDispose()],e.RenderView.prototype,"_screenshotManager",void 0),r.__decorate([y.autoDispose()],e.RenderView.prototype,"componentObjectCollection",null),r.__decorate([y.autoDispose()],e.RenderView.prototype,"_componentObjectCollection",void 0),e.RenderView=r.__decorate([l.subclass("esri.views.3d.webgl-engine.parts.RenderView")],e.RenderView),Object.defineProperty(e,"__esModule",{value:!0})}));
