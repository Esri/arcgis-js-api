/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Evented","../../../../core/has","../../../../core/Logger","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/scheduling","../../../../core/time","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/accessorSupport/decorators/subclass","../collections/Component/ComponentObjectCollection","../core/shaderTechnique/ShaderTechniqueRepository","../lib/basicInterfaces","../lib/CompositingHelper","../lib/depthRangeUtils","../lib/GLMaterialRepository","../lib/MagnifierHelper","../lib/Material","../lib/ObjectAndLayerIdRenderHelper","../lib/Renderer","../lib/RenderingContext","../lib/TextureRepository","../materials/StippleTextureRepository","../materials/internal/WaterTextureRepository","./contextCache","./requireUtils","./ScreenshotManager","./testUtils","../../../support/RenderState","../../../webgl/context-util"],(function(e,t,r,n,o,i,s,a,d,p,c,l,u,h,_,y,R,f,m,g,x,b,v,w,T,C,A,U,D,S,M,q,O,L,k){"use strict";e.RenderView=function(e){function r(t){var r;(r=e.call(this,{})||this).events=new o,r.waterTextureRepository=new D.WaterTextureRepository,r._magnifierHelper=new b.MagnifierHelper,r.objectAndLayerIdRenderHelper=i("enable-feature:objectAndLayerId-rendering")?new w.ObjectAndLayerIdRenderHelper:null,r._needsUpdate=!0,r._needsRender=!0,r._idleSuspend=!0,r._needsWaterReflectionUpdate=!1,r._lastAnimationUpdate=0,r._container=t.container,r._viewingMode=t.viewingMode,r._initializeContext(t),d.watch((()=>r.waterTextureRepository?.updating),(()=>r.requestRender()),d.initial),r._magnifierHelper.events.on("request-render",(()=>r.requestRender())),r._stippleTextureRepository=new U.StippleTextureRepository(r._rctx),r._shaderTechniqueRepository=new R.ShaderTechniqueRepository({rctx:r._rctx,viewingMode:t.viewingMode,stippleTextureRepository:r._stippleTextureRepository,waterTextureRepository:r.waterTextureRepository}),r._textureRepository=new A.TextureRepository(t,r._shaderTechniqueRepository,r._rctx),r._textureRepository.events.on("changed",(e=>r.requestRender(e))),r._materialRepository=new x.GLMaterialRepository(r._textureRepository,r._shaderTechniqueRepository,(()=>r.requestRender()),(()=>r.requestRender())),r._compositingHelper=new m(r._rctx,r._shaderTechniqueRepository),r.renderer=new T.Renderer(t,r._materialRepository,r._textureRepository,r._shaderTechniqueRepository,r._rctx,r._compositingHelper,r._magnifierHelper,(e=>r.requestRender(e)));const n={renderScene:(e,t,n,o,i)=>r.renderer.render(e,t,{camera:n,contentCamera:n,mode:L.RenderState.IDLE},o,i),requestRenderScene:e=>r.requestRender(e),prepareOverlay:()=>t.options.screenshot.prepareOverlay(),renderOverlay:(e,r)=>t.options.screenshot.renderOverlay(e,r)};return r._screenshotManager=new q.ScreenshotManager(r._rctx,n,(e=>r.events.emit("force-camera-for-screenshot",e)),(()=>r.renderer.disposeOffscreenBuffers())),r._registerFrameTask(t),r}t._inheritsLoose(r,e);var n=r.prototype;return n.normalizeCtorArgs=function(){return{}},n.destroy=function(){this._container.contains(this._canvas)&&this._container.removeChild(this._canvas),this._frameTask=a.removeMaybe(this._frameTask),this._shaderTechniqueRepository=a.destroyMaybe(this._shaderTechniqueRepository)},n.requestRender=function(e=f.RenderRequestType.UPDATE){this._needsRender=!0,e===f.RenderRequestType.UPDATE&&(this._needsUpdate=!0)},n.setIdleSuspend=function(e){this._idleSuspend!==e&&(this._idleSuspend=e,this.requestRender())},n.takeScreenshot=function(e){return this._screenshotManager.takeScreenshot(e).then((e=>e[0]))},n.takeScreenshotWithOID=function(e){return e.objectAndLayerIdColor=!0,this._screenshotManager.takeScreenshot(e)},n.getAlpha=function(){return!!this._rctx.contextAttributes.alpha},n.getMinimalDepthForArea=function(e,t,r,n,o,i=o){const s=n.constrainWindowSize(t,r,o*n.pixelRatio,i*n.pixelRatio),d=this._ensureDepthBuffer(s);this.renderer.readDepthPixels(n,s,d);let p=Number.MAX_VALUE;for(let a=0;a<s[2]*s[3];a++){const e=g.textureToDepth(4*a,d,n.nearFar);p>e&&e!==n.nearFar[0]&&e!==n.nearFar[1]&&(p=e)}if(a.isSome(e)){const o=e.pickDepth(t*n.pixelRatio,r*n.pixelRatio,n);a.isSome(o)&&p>o&&o!==n.nearFar[0]&&o!==n.nearFar[1]&&(p=o)}return p===Number.MAX_VALUE?void 0:p},n._ensureDepthBuffer=function(e){const t=4*e[2]*e[3];return(a.isNone(this._tmpDepthBuffer)||this._tmpDepthBuffer.byteLength<t)&&(this._tmpDepthBuffer=new Uint8Array(t)),this._tmpDepthBuffer},n.reloadShaders=function(){var e=t._asyncToGenerator((function*(){M.removeLoadedShaderModules(),yield this._shaderTechniqueRepository.reloadAll(),this.requestRender()}));function r(){return e.apply(this,arguments)}return r}(),n._registerFrameTask=function(e){const t=e.view.state;let r=!1,n=f.RenderRequestType.BACKGROUND,o=!1;const i={preRender:({time:o})=>{r=this.updating,n=this._needsUpdate?f.RenderRequestType.UPDATE:f.RenderRequestType.BACKGROUND,e.commitSyncLayers();const i=c.Milliseconds(o-this._lastAnimationUpdate);if(i>this.renderer.animationTimestep||a.isSome(t.forcedAnimationTime)||r||this._needsRender){const e=c.Milliseconds(i/this.renderer.animationTimeDilation),r=new v.UpdateParameters(t.camera,e,t.forcedAnimationTime);this.renderer.updateAnimation(r)&&this.requestRender(f.RenderRequestType.BACKGROUND),this._lastAnimationUpdate=o}},render:({time:e})=>{if((this._needsRender||!this._idleSuspend||!this.renderer.isCameraFinal||this._needsWaterReflectionUpdate)&&t.camera.fullWidth>0&&t.camera.fullHeight>0){const r=this._needsUpdate&&this._idleSuspend&&this.renderer.isCameraFinal;this._needsRender=!1,this._needsUpdate=!1,this._needsWaterReflectionUpdate=!1,this.renderer.render(null,null,t,f.Decorations.ON,e),o=!0,r&&this.renderer.hasWaterReflection&&(this.requestRender(f.RenderRequestType.BACKGROUND),this._needsWaterReflectionUpdate=!0)}},update:({time:e})=>{const r=new q.ScreenshotContext(t.camera,this.renderer.hasSlicePlane||this._magnifierHelper.enabled);this._textureRepository.update(),this._screenshotManager.update(r,e)},finish:()=>{o&&(this.renderer.finish(t.mode===L.RenderState.IDLE?n:f.RenderRequestType.UPDATE),o=!1)}};this._frameTask=p.addFrameTask(i)},n._initializeContext=function(e){const t=e.options;this._canvas=t.canvas,this._canvas||(this._canvas=document.createElement("canvas")),this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");const r={alpha:t.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:null==t.stencil||t.stencil,powerPreference:"high-performance",preserveDrawingBuffer:t.preserveDrawingBuffer??!1},n=k.createContextOrErrorHTML("3d",this._canvas,r);if(a.isNone(n)){const e=i("esri-force-webgl");s.getLogger(this.declaredClass).error(e)}else this._rctx=this._newRenderingContext(n,e),this._loadShaderOnlyExtensions(),!t.alpha&&this._rctx.contextAttributes.alpha&&s.getLogger(this.declaredClass).error("WebGL context has alpha channel even though no alpha channel was requested"),!this._rctx.contextAttributes.alpha&&i("safari")>=11&&(this._container.style.backgroundColor="black"),this._container.appendChild(this._canvas)},n._newRenderingContext=function(e,t){const r={disabledExtensions:t.options.deactivatedWebGLExtensions||{},debugWebGLExtensions:t.options.debugWebGLExtensions||{},maxAnisotropy:8},n=(e,r)=>t.view.resourceController.memoryController.newCache(e,r);if(O.contextCache.enabled){let t=V.get(e);return t?(t.configure(r),t.newCache=n,t.ref(),t):(t=new C.RenderingContext(e,r,n),V.set(e,t),t.ref(),t)}return new C.RenderingContext(e,r,n)},n._loadShaderOnlyExtensions=function(){this._rctx.capabilities.enable("standardDerivatives"),this._rctx.capabilities.enable("shaderTextureLOD"),this._rctx.capabilities.enable("textureFloat")},n.getObjectAndLayerIdColor=function(e){return a.isSome(this.objectAndLayerIdRenderHelper)?this.objectAndLayerIdRenderHelper.getObjectAndLayerIdColor(e):null},t._createClass(r,[{key:"performanceInfo",get:function(){const e=this._rctx.gl;return{renderer:this.renderer.performanceInfo,textureMemory:void 0!==e.getUsedTextureMemory?e.getUsedTextureMemory():void 0,renderbufferMemory:void 0!==e.getUsedRenderbufferMemory?e.getUsedRenderbufferMemory():void 0,VBOMemory:void 0!==e.getUsedVBOMemory?e.getUsedVBOMemory():void 0}}},{key:"updating",get:function(){return this._needsUpdate||this._needsWaterReflectionUpdate||this.renderer.updating||this._textureRepository.updating||this.waterTextureRepository.updating||this._magnifierHelper.updating}},{key:"textureRepository",get:function(){return this._textureRepository}},{key:"compositingHelper",get:function(){return this._compositingHelper}},{key:"magnifier",set:function(e){this._magnifierHelper.magnifier=e}},{key:"renderingContext",get:function(){return this._rctx}},{key:"capabilities",get:function(){return this._rctx.capabilities}},{key:"canvas",get:function(){return this._canvas}},{key:"componentObjectCollection",get:function(){return a.isNone(this._componentObjectCollection)&&(this._componentObjectCollection=new y.ComponentObjectCollection(this.renderer.renderPassManager,this._viewingMode)),this._componentObjectCollection},set:function(e){this._componentObjectCollection=e}}]),r}(n),r.__decorate([l.property({type:Boolean,readOnly:!0})],e.RenderView.prototype,"updating",null),r.__decorate([l.property({autoDestroy:!0})],e.RenderView.prototype,"_rctx",void 0),r.__decorate([l.property({autoDestroy:!0})],e.RenderView.prototype,"_container",void 0),r.__decorate([l.property({autoDestroy:!0})],e.RenderView.prototype,"_canvas",void 0),r.__decorate([l.property({autoDestroy:!0})],e.RenderView.prototype,"_stippleTextureRepository",void 0),r.__decorate([l.property({autoDestroy:!0})],e.RenderView.prototype,"waterTextureRepository",void 0),r.__decorate([l.property({autoDestroy:!0})],e.RenderView.prototype,"_magnifierHelper",void 0),r.__decorate([l.property({readOnly:!0})],e.RenderView.prototype,"objectAndLayerIdRenderHelper",void 0),r.__decorate([l.property({autoDestroy:!0})],e.RenderView.prototype,"_textureRepository",void 0),r.__decorate([l.property({autoDestroy:!0})],e.RenderView.prototype,"_compositingHelper",void 0),r.__decorate([l.property({autoDestroy:!0,readOnly:!0})],e.RenderView.prototype,"renderer",void 0),r.__decorate([l.property({autoDestroy:!0})],e.RenderView.prototype,"_screenshotManager",void 0),r.__decorate([l.property()],e.RenderView.prototype,"componentObjectCollection",null),r.__decorate([l.property({autoDestroy:!0})],e.RenderView.prototype,"_componentObjectCollection",void 0),r.__decorate([l.property()],e.RenderView.prototype,"_needsUpdate",void 0),r.__decorate([l.property()],e.RenderView.prototype,"_needsWaterReflectionUpdate",void 0),e.RenderView=r.__decorate([_.subclass("esri.views.3d.webgl-engine.parts.RenderView")],e.RenderView);const V=S.getContextCache();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
