// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../core/Accessor","../../../../core/Evented","../../../../core/has","../../../../core/Logger","../../../../core/maybe","../../../../core/scheduling","../../../../core/watchUtils","../../../../core/accessorSupport/decorators","../../../../layers/support/timeUtils","../../support/animationUtils","../collections/Component/ComponentObjectCollection","../core/shaderTechnique/CommonUniformStore","../core/shaderTechnique/ShaderTechniqueRepository","../lib/AutoDisposable","../lib/CompositingHelper","../lib/GLMaterialRep","../lib/Renderer","../lib/TextureRepository","../lib/tracer","../lib/WebGLDriverTest","../materials/lineStippleUtils","../materials/internal/WaterTextureRepository","./requireUtils","./ScreenshotManager","../../../webgl/context-util","../../../webgl/RenderingContext"],(function(e,t,r,o,n,i,s,a,p,c,d,u,l,_,h,g,y,m,f,b,x,R,v,T,w,C,O,S,M){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RenderView=void 0;var U=s.getLogger("esri.views.3d.webgl-engine.parts.View"),D=i("esri-debug-messages"),L=function(e){function t(t){var r=e.call(this,{})||this;r._stage=t,r.events=new n,r._stippleTextureRepository=new T.StippleTextureRepository,r.waterTextureRepository=new w.WaterTextureRepository,r._commonUniformStore=new h.CommonUniformStore,r._componentObjectCollection=null,r._needsUpdate=!0,r._needsRender=!0,r._idleSuspend=!0,r._logicUpdateLast=0,r._stats={renderTimeTotal:0,renderTimeLast:0,frameCount:0},r._container=r._stage.container,r._initializeContext(r._stage.options),c.init(r.waterTextureRepository,"loadingState",(function(){return r.setNeedsRender()})),r._shaderTechniqueRepository=new g.ShaderTechniqueRepository({rctx:r._rctx,viewingMode:r._stage.options.viewingMode,commonUniformStore:r._commonUniformStore,stippleTextureRepository:r._stippleTextureRepository,waterTextureRepository:r.waterTextureRepository}),r._textureRepository=new x.TextureRepository(r._stage.scheduler,r._stage.getAll(4),r._shaderTechniqueRepository,r._rctx),r._textureRepository.events.on("changed",(function(e){return r.setNeedsRender(e)})),r._materialRepository=new f(r._textureRepository,r._shaderTechniqueRepository,(function(){return r.setNeedsRender()})),r._compositingHelper=new m.default(r._rctx,r._shaderTechniqueRepository);var o=r._container.getBoundingClientRect();return r._renderer=new b.default(r._materialRepository,r._textureRepository,r._shaderTechniqueRepository,r._rctx,r._compositingHelper,(function(e){return void 0===e&&(e=1),r.setNeedsRender(e)}),[o.width,o.height],r._stage),r._screenshotManager=new O.ScreenshotManager(r._rctx,(function(e,t,o){return r._render(e,t,o)}),(function(){return r.setNeedsRender()}),r._stage.options.screenshot.renderOverlay,(function(e){return r.events.emit("force-camera-for-screenshot",e)})),r._registerFrameTask(),r}return r.__extends(t,e),t.prototype.normalizeCtorArgs=function(){return{}},t.prototype.dispose=function(){this._container.contains(this._canvas)&&this._container.removeChild(this._canvas),this._frameTask&&(this._frameTask.remove(),this._frameTask=null),this._shaderTechniqueRepository.dispose(),this._shaderTechniqueRepository=null,v.clearTestWebGLDriver(this._rctx),e.prototype.dispose.call(this),this._rctx=null},t.prototype.getCombinedStats=function(){var e=this._rctx.gl;return r.__assign(r.__assign({},this._stats),{scene:this._renderer.getStats(),textureMemory:void 0!==e.getUsedTextureMemory?e.getUsedTextureMemory():void 0,renderbufferMemory:void 0!==e.getUsedRenderbufferMemory?e.getUsedRenderbufferMemory():void 0,VBOMemory:void 0!==e.getUsedVBOMemory?e.getUsedVBOMemory():void 0})},t.prototype.setNeedsRender=function(e){void 0===e&&(e=1),1===e?this._needsUpdate||(this._needsUpdate=!0,this.notifyChange("updating")):this._needsRender=!0},Object.defineProperty(t.prototype,"canRender",{get:function(){return this._renderer.canRender},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"needsUpdate",{get:function(){return this._needsUpdate},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"updating",{get:function(){return this.needsUpdate||this._renderer.updating||this._textureRepository.loadingCount>0||this.waterTextureRepository.updating||this._stage.dirty},enumerable:!1,configurable:!0}),t.prototype.ensureEdgeView=function(){return this._renderer.ensureEdgeView()},Object.defineProperty(t.prototype,"edgeView",{get:function(){return this._renderer.edgeView},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"textureRepository",{get:function(){return this._textureRepository},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"compositingHelper",{get:function(){return this._compositingHelper},enumerable:!1,configurable:!0}),t.prototype.setRenderParameters=function(e){this.setNeedsRender(),void 0!==e.idleSuspend&&(this._idleSuspend=!!e.idleSuspend),this._renderer.setRenderParams(e)},Object.defineProperty(t.prototype,"renderingContext",{get:function(){return this._rctx},enumerable:!1,configurable:!0}),t.prototype.has=function(e){return"s3tc"===e?!!this._rctx.capabilities.compressedTextureS3TC:"shaderTextureLOD"===e&&!!this._rctx.capabilities.shaderTextureLOD},t.prototype.modify=function(e,t,r){this._renderer.modify(e,e.length,t,t.length,r,r.length)},t.prototype.setCamera=function(e){this._renderer.camera=e},t.prototype.getCamera=function(){return this._renderer.camera},t.prototype.getCanvas=function(){return this._canvas},t.prototype.takeScreenshot=function(e){return this._screenshotManager.takeScreenshot(e)},Object.defineProperty(t.prototype,"renderPlugins",{get:function(){return this._renderer.renderPlugins},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"test",{get:function(){return{renderer:this._renderer}},enumerable:!1,configurable:!0}),t.prototype.getGpuMemoryUsage=function(){return this._renderer.getGpuMemoryUsage()},t.prototype.hotReloadShaders=function(){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){switch(e.label){case 0:return C.removeLoadedShaderModules(),[4,this._shaderTechniqueRepository.hotReload()];case 1:return e.sent(),this.setNeedsRender(),[2]}}))}))},t.prototype._registerFrameTask=function(){var e=this,t={viewCamera:this._renderer.camera,frameHasSlicePlane:!1},r={preRender:function(t){R.begin();var r=!1;e._stage.processDirty();var o=u.Milliseconds(t.time-e._logicUpdateLast);if(o>l.DESIRED_ANIMATION_MS){var n={camera:e._renderer.camera,dt:o};r=e._renderer.updateLogic(n),e._logicUpdateLast=t.time}r&&e.setNeedsRender(0)},render:function(){(e.needsUpdate||e._needsRender||!e._idleSuspend)&&e.canRender&&(e._needsRender=!1,e._needsUpdate=!1,e._render(null,e._renderer.camera,!1))},postRender:function(){e.notifyChange("updating"),R.end()},update:function(){t.viewCamera=e._renderer.camera,t.frameHasSlicePlane=e._renderer.hasSlicePlane,e._textureRepository.update(),e._screenshotManager.update(t)}};this._frameTask=p.addFrameTask(r)},t.prototype._initializeContext=function(e){this._canvas=e.canvas,this._canvas||(this._canvas=document.createElement("canvas")),this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");var t={alpha:e.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:null==e.stencil||e.stencil,powerPreference:"high-performance"},r=R.instrumentContext(S.createContextOrErrorHTML(this._canvas,t,e.renderContext)),o={disabledExtensions:e.deactivatedWebGLExtensions||{},debugWebGLExtensions:e.debugWebGLExtensions||{}};this._rctx=new M(r,o),null!=this._rctx.parameters.maxMaxAnisotropy&&(this._rctx.parameters.maxMaxAnisotropy=Math.min(this._rctx.parameters.maxMaxAnisotropy,8)),this._loadShaderOnlyExtensions(this._rctx),!e.alpha&&this._rctx.contextAttributes.alpha&&U.error("WebGL context has alpha channel even though no alpha channel was requested"),!this._rctx.contextAttributes.alpha&&i("safari")>=11&&(this._container.style.backgroundColor="black"),this._container.appendChild(this._canvas)},t.prototype._render=function(e,t,r){var o;D&&(o=performance.now()),this._renderer.setLighting(this._stage.lighting),this._renderer.render(e,t,r,this._stage.mainLightDirection),D&&(this._stats.renderTimeLast=performance.now()-o,this._stats.renderTimeTotal+=this._stats.renderTimeLast,this._stats.frameCount++)},t.prototype._loadShaderOnlyExtensions=function(e){var t=e.capabilities;t.standardDerivatives,t.shaderTextureLOD,t.textureFloat},Object.defineProperty(t.prototype,"componentObjectCollection",{get:function(){return a.isNone(this._componentObjectCollection)&&(this._componentObjectCollection=new _.ComponentObjectCollection(this._renderer.renderPassManager)),this._componentObjectCollection},set:function(e){this._componentObjectCollection=e},enumerable:!1,configurable:!0}),r.__decorate([d.property({type:Boolean,readOnly:!0,dependsOn:["waterTextureRepository.updating"]})],t.prototype,"updating",null),r.__decorate([y.autoDispose()],t.prototype,"_rctx",void 0),r.__decorate([y.autoDispose()],t.prototype,"_container",void 0),r.__decorate([y.autoDispose()],t.prototype,"_canvas",void 0),r.__decorate([y.autoDispose()],t.prototype,"_stippleTextureRepository",void 0),r.__decorate([y.autoDispose(),d.property()],t.prototype,"waterTextureRepository",void 0),r.__decorate([y.autoDispose()],t.prototype,"_textureRepository",void 0),r.__decorate([y.autoDispose()],t.prototype,"_commonUniformStore",void 0),r.__decorate([y.autoDispose()],t.prototype,"_compositingHelper",void 0),r.__decorate([y.autoDispose()],t.prototype,"_renderer",void 0),r.__decorate([y.autoDispose()],t.prototype,"_screenshotManager",void 0),r.__decorate([y.autoDispose()],t.prototype,"componentObjectCollection",null),r.__decorate([y.autoDispose()],t.prototype,"_componentObjectCollection",void 0),t=r.__decorate([d.subclass("esri.views.3d.webgl-engine.parts.RenderView")],t)}(y.AutoDisposableMixin(o));t.RenderView=L}));