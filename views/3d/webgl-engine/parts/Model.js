/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/accessorSupport/ensureType","../../../../core/Logger","../../../../core/accessorSupport/decorators/subclass","../lib/localOrigin","../lib/ModelDirtySet","../lib/RenderGeometry","../lib/Util","../lib/WebGLLayer"],(function(e,t,n,o,r,i,s,a,c,d,l,u,h,f){"use strict";const g=h.assert,y=h.logWithBase,_=1e4,p=10;e.Model=function(e){function n(){var n;return(n=e.call(this)||this).dirtySet=new l({model:t._assertThisInitialized(n)}),n._id2origin=new Map,n._content=new Map,n}t._inheritsLoose(n,e);var o=n.prototype;return o.getObject=function(e){return this._content.get(e)},o.add=function(e){const t=e.id;g(!this._content.has(t),"Model/Stage already contains object to be added"),this._content.set(t,e),f.isWebGLLayer(e)&&this.dirtySet.layerAdded(e)},o.remove=function(e){g(this._content.has(e.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(e.id),e.unload(),f.isWebGLLayer(e)&&this.dirtySet.layerRemoved(e)},o.addMany=function(e){for(const t of e)g(!this._content.has(t.id),"Model/Stage already contains object to be added"),this._content.set(t.id,t)},o.removeMany=function(e){for(const t of e)g(this._content.has(t.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(t.id),t.unload()},o.forEachOfType=function(e,t){this._content.forEach((n=>{n.type===e&&t(n)}))},o._getOrigin=function(e){let t=0;const n=e[3]*p/_;n>1&&(t=Math.ceil(y(n,2)));const o=2**t*_,r=Math.round(e[0]/o),i=Math.round(e[1]/o),s=Math.round(e[2]/o),a=t+"_"+r+"_"+i+"_"+s;let c=this._id2origin.get(a);return null==c&&(c=d.fromValues(r*o,i*o,s*o,a),this._id2origin.set(a,c)),c},o.getRenderGeometry=function(e,t){const{geometry:n,material:o,id:r,shaderTransformation:i,origin:s,instanceParameters:a}=t,c=new u.RenderGeometry(n,o,null,null,r,n.boundingInfo,i,e.castShadow);return c.updateTransformation((n=>e.getCombinedStaticTransformation(t,n))),c.origin=s||this._getOrigin(c.boundingSphere),c.instanceParameters=a,c},o.updateRenderGeometryTransformation=function(e,t,n){n.updateTransformation((n=>e.getCombinedStaticTransformation(t,n)));const o=this._getOrigin(n.boundingSphere);return n.origin!==o},o.getStats=function(){const e={},t=Array.from(this._content.values());for(let n=0;n<5;++n)e[n]=t.filter((e=>e.type===n)).length;return{contentTypes:e,dirtySet:this.dirtySet.formatDebugInfo()}},t._createClass(n,[{key:"test",get:function(){return{content:Array.from(this._content.values())}}}]),n}(o),n.__decorate([r.property({constructOnly:!0})],e.Model.prototype,"dirtySet",void 0),e.Model=n.__decorate([c.subclass("esri.views.3d.webgl-engine.parts.Model")],e.Model),Object.defineProperty(e,"__esModule",{value:!0})}));
