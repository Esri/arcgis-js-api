/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["require","exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/mathUtils","../../../../core/maybe","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec2f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../chunks/vec4f64","../core/shaderTechnique/ReloadableShaderModule","../core/shaderTechnique/ShaderTechnique","../lib/DefaultVertexAttributeLocations","../lib/Program","../lib/Util","../../../../chunks/ShadowHighlight.glsl","../../../webgl/renderState"],(function(e,t,i,r,a,o,n,h,s,l,c,g,d,p,m,u,f,v){"use strict";const w=4e4,S=5e4;let T=function(e){function t(){var t;return(t=e.apply(this,arguments)||this).opacityElevation=1,t.dayNightTerminator=1,t.highlightShadowMapSlot=0,t.defaultSnapshotSlot=1,t}i._inheritsLoose(t,e);var n=t.prototype;return n.initializeProgram=function(e){const i=t.shader.get();this._viewingMode=e.viewingMode;const r=i.build({highlightedThreshold:.99999,selfShadowThreshold:.025});return new m.Program(e.rctx,r,p.Default3D)},n.initializePipeline=function(e){return v.makePipelineState({blending:v.separateBlendingParams(770,1,771,771),colorWrite:v.defaultColorWriteParams,depthTest:null,depthWrite:null})},n.bindPass=function(e,t){this.opacityElevation=1-r.smoothstep(w,S,t.camera.relativeElevation);const i=1===this._viewingMode?s.normalize(M,t.camera.center):s.set(M,0,0,1),n=s.dot(i,t.lighting.lightingMainDirection);this.dayNightTerminator=r.smoothstep(0,1,r.clamp(30*n,0,1)),this.program.bindTexture(t.linearDepthTexture,"depthMap"),this.program.bindTexture(t.highlightColorTexture,"highlightMap"),s.transformMat4(b,t.lighting.lightingMainDirection,t.camera.viewInverseTransposeMatrix),s.normalize(b,b),u.inverseProjectionInfo(t.camera.projectionMatrix,t.camera.fullWidth,t.camera.fullHeight,y,x),o.translate(P,t.camera.viewMatrix,t.camera.center),o.invert(P,P),this.program.setUniform4fv("color",e.shadowColor),this.program.setUniform1f("opacity",e.shadowOpacity),this.program.setUniform1f("occludedOpacity",e.occludedShadowOpacity),this.program.setUniform1f("terminationFactor",this.opacityElevation*this.dayNightTerminator),this.program.setUniform2fv("nearFar",t.camera.nearFar),this.program.setUniformMatrix4fv("inverseView",P),this.program.setUniform4fv("projInfo",y),this.program.setUniform2fv("zScale",x),this.program.setUniform3fv("lightingMainDirectionView",b),this.program.setUniform2f("texelSize",1/t.linearDepthTexture.descriptor.width,1/t.linearDepthTexture.descriptor.height),t.shadowMap.bind(this.program),t.shadowMap.bindView(this.program,t.camera.center);let h=t.shadowMap.getSnapshot(this.highlightShadowMapSlot);a.isSome(h)&&this.program.bindTexture(h,"highlightDepthTex"),h=t.shadowMap.getSnapshot(this.defaultSnapshotSlot),a.isSome(h)&&this.program.bindTexture(h,"defaultDepthTex")},i._createClass(t,[{key:"primitiveType",get:function(){return 5}}]),t}(d.ShaderTechnique);T.shader=new g.ReloadableShaderModule(f.ShadowHighlightShader,(()=>new Promise((function(t,i){e(["./ShadowHighlight.glsl"],t,i)}))));const M=l.create(),b=l.create(),x=h.create(),y=c.create(),P=n.create();t.ShadowHighlightTechnique=T,Object.defineProperty(t,"__esModule",{value:!0})}));
