/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["require","exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Logger","../../../../core/maybe","../../../../chunks/vec3f64","../core/shaderLibrary/ShaderOutputOptions","../core/shaderLibrary/Slice.glsl","../core/shaderLibrary/attributes/InstancedDoublePrecision.glsl","../core/shaderLibrary/attributes/NormalAttribute.glsl","../core/shaderLibrary/attributes/TextureCoordinateAttribute.glsl","../core/shaderLibrary/attributes/VerticalOffset.glsl","../core/shaderLibrary/output/OutputHighlight.glsl","../core/shaderLibrary/shading/MultipassTerrainTest.glsl","../core/shaderLibrary/shading/Normals.glsl","../core/shaderLibrary/shading/PhysicallyBasedRenderingParameters.glsl","../core/shaderLibrary/shading/ReadShadowMap.glsl","../core/shaderLibrary/shading/VisualVariables.glsl","../core/shaderLibrary/util/DoublePrecision.glsl","../core/shaderLibrary/util/View.glsl","../core/shaderTechnique/ReloadableShaderModule","../core/shaderTechnique/ShaderTechnique","../core/shaderTechnique/ShaderTechniqueConfiguration","../lib/basicInterfaces","../lib/DefaultVertexAttributeLocations","../lib/OrderIndependentTransparency","../lib/Program","../lib/StencilUtils","../materials/internal/MaterialUtil","../../../../chunks/DefaultMaterial.glsl","../../../webgl/enums","../../../webgl/renderState"],(function(e,r,t,a,o,i,s,n,l,c,u,p,d,h,m,f,g,b,v,T,y,_,M,P,S,x,O,C,D,A,w,N,U){"use strict";const E=o.getLogger("esri.views.3d.webgl-engine.shaders.DefaultTechnique");let L=function(e){function r(){return e.apply(this,arguments)||this}t._inheritsLoose(r,e);var a=r.prototype;return a.initializeProgram=function(e){const t=r.shader.get(),a=this.configuration,o=t.build({oitEnabled:a.transparencyPassType===S.TransparencyPassType.Color,output:a.output,viewingMode:e.viewingMode,receiveShadows:a.receiveShadows,slicePlaneEnabled:a.slicePlaneEnabled,sliceHighlightDisabled:a.sliceHighlightDisabled,sliceEnabledForVertexPrograms:!1,symbolColor:a.symbolColors,vvSize:a.vvSize,vvColor:a.vvColor,vvInstancingEnabled:!0,instanced:a.instanced,instancedColor:a.instancedColor,instancedDoublePrecision:a.instancedDoublePrecision,pbrMode:a.usePBR?a.isSchematic?g.PBRMode.Schematic:g.PBRMode.Normal:g.PBRMode.Disabled,hasMetalnessAndRoughnessTexture:a.hasMetalnessAndRoughnessTexture,hasEmissionTexture:a.hasEmissionTexture,hasOcclusionTexture:a.hasOcclusionTexture,hasNormalTexture:a.hasNormalTexture,hasColorTexture:a.hasColorTexture,hasModelTransformation:a.hasModelTransformation,receiveAmbientOcclusion:a.receiveAmbientOcclusion,useCustomDTRExponentForWater:!1,normalType:a.normalsTypeDerivate?u.NormalAttributeType.ScreenDerivative:u.NormalAttributeType.Attribute,doubleSidedMode:a.doubleSidedMode,vertexTangents:a.vertexTangents,attributeTextureCoordinates:a.hasMetalnessAndRoughnessTexture||a.hasEmissionTexture||a.hasOcclusionTexture||a.hasNormalTexture||a.hasColorTexture?p.TextureCoordinateAttributeType.Default:p.TextureCoordinateAttributeType.None,textureAlphaPremultiplied:a.textureAlphaPremultiplied,attributeColor:a.vertexColors,screenSizePerspectiveEnabled:a.screenSizePerspective,verticalOffsetEnabled:a.verticalOffset,offsetBackfaces:a.offsetBackfaces,doublePrecisionRequiresObfuscation:T.doublePrecisionRequiresObfuscation(e.rctx),alphaDiscardMode:a.alphaDiscardMode,supportsTextureAtlas:!1,multipassTerrainEnabled:a.multipassTerrainEnabled,cullAboveGround:a.cullAboveGround});return new C.Program(e.rctx,o,x.Default3D)},a.bindPass=function(e,r){var t,a;y.bindProjectionMatrix(this.program,r.camera.projectionMatrix);const o=this.configuration.output;this.configuration.hasModelTransformation&&(i.isSome(e.modelTransformation)?this.program.setUniformMatrix4fv("model",e.modelTransformation):E.warnOnce("hasModelTransformation true, but no modelTransformation found.")),(this.configuration.output===n.ShaderOutput.Depth||r.multipassTerrainEnabled||o===n.ShaderOutput.Shadow)&&this.program.setUniform2fv("nearFar",r.camera.nearFar),r.multipassTerrainEnabled&&(this.program.setUniform2fv("inverseViewport",r.inverseViewport),m.bindMultipassTerrainTexture(this.program,r)),o===n.ShaderOutput.Alpha&&(this.program.setUniform1f("opacity",e.opacity),this.program.setUniform1f("layerOpacity",e.layerOpacity),this.program.setUniform4fv("externalColor",e.externalColor),this.program.setUniform1i("colorMixMode",A.colorMixModes[e.colorMixMode])),o===n.ShaderOutput.Color?(r.lighting.setUniforms(this.program,!1,r.hasFillLights),this.program.setUniform3fv("ambient",e.ambient),this.program.setUniform3fv("diffuse",e.diffuse),this.program.setUniform4fv("externalColor",e.externalColor),this.program.setUniform1i("colorMixMode",A.colorMixModes[e.colorMixMode]),this.program.setUniform1f("opacity",e.opacity),this.program.setUniform1f("layerOpacity",e.layerOpacity),this.configuration.usePBR&&g.bindPBRUniforms(this.program,e,this.configuration.isSchematic)):o===n.ShaderOutput.Highlight&&h.bindOutputHighlight(this.program,r),v.bindVisualVariablesUniformsForSymbols(this.program,e),d.bindVerticalOffsetUniforms(this.program,e,r),A.bindScreenSizePerspective(e.screenSizePerspective,this.program,"screenSizePerspectiveAlignment"),e.textureAlphaMode!==S.AlphaDiscardMode.Mask&&e.textureAlphaMode!==S.AlphaDiscardMode.MaskBlend||this.program.setUniform1f("textureAlphaCutoff",e.textureAlphaCutoff),null==(t=r.shadowMap)||t.bind(this.program),null==(a=r.ssaoHelper)||a.bind(this.program,r.camera)},a.bindDraw=function(e){const r=this.configuration.instancedDoublePrecision?s.fromValues(e.camera.viewInverseTransposeMatrix[3],e.camera.viewInverseTransposeMatrix[7],e.camera.viewInverseTransposeMatrix[11]):e.origin;y.bindViewCustomOrigin(this.program,r,e.camera.viewMatrix),this.program.rebindTextures(),(this.configuration.output===n.ShaderOutput.Color||this.configuration.output===n.ShaderOutput.Alpha||this.configuration.output===n.ShaderOutput.Depth&&this.configuration.screenSizePerspective||this.configuration.output===n.ShaderOutput.Normal&&this.configuration.screenSizePerspective||this.configuration.output===n.ShaderOutput.Highlight&&this.configuration.screenSizePerspective)&&y.bindCameraPosition(this.program,r,e.camera.viewInverseTransposeMatrix),this.configuration.output===n.ShaderOutput.Normal&&this.program.setUniformMatrix4fv("viewNormal",e.camera.viewInverseTransposeMatrix),this.configuration.instancedDoublePrecision&&c.bindCustomOrigin(this.program,r),l.bindSliceUniforms(this.program,this.configuration,e.slicePlane,{origin:r}),this.configuration.output===n.ShaderOutput.Color&&b.bindReadShadowMapViewCustomOrigin(this.program,e,r)},a._convertDepthTestFunction=function(e){return e===S.DepthTestFunction.Lequal?N.CompareFunction.LEQUAL:N.CompareFunction.LESS},a._setPipeline=function(e,r){const t=this.configuration,a=e===S.TransparencyPassType.NONE,o=e===S.TransparencyPassType.FrontFace;return U.makePipelineState({blending:t.output!==n.ShaderOutput.Color&&t.output!==n.ShaderOutput.Alpha||!t.transparent?null:a?O.blendingDefault:O.oitBlending(e),culling:F(t)&&U.cullingParams(t.cullFace),depthTest:{func:O.oitDepthTest(e,this._convertDepthTestFunction(t.customDepthTest))},depthWrite:a||o?t.writeDepth&&U.defaultDepthWriteParams:null,colorWrite:U.defaultColorWriteParams,stencilWrite:t.sceneHasOcludees?D.stencilWriteMaskOn:null,stencilTest:t.sceneHasOcludees?r?D.stencilToolMaskBaseParams:D.stencilBaseAllZerosParams:null,polygonOffset:a||o?null:O.getOITPolygonOffset(t.enableOffset)})},a.initializePipeline=function(){return this._occludeePipelineState=this._setPipeline(this.configuration.transparencyPassType,!0),this._setPipeline(this.configuration.transparencyPassType,!1)},a.getPipelineState=function(r,t){return t?this._occludeePipelineState:e.prototype.getPipelineState.call(this,r,t)},r}(M.ShaderTechnique);function F(e){return e.cullFace?e.cullFace!==S.CullFaceOptions.None:!e.slicePlaneEnabled&&(!e.transparent&&!e.doubleSidedMode)}L.shader=new _.ReloadableShaderModule(w.DefaultMaterialShader,(()=>new Promise(((r,t)=>e(["./DefaultMaterial.glsl"],r,t)))));let R=function(e){function r(){var r;return(r=e.apply(this,arguments)||this).output=n.ShaderOutput.Color,r.alphaDiscardMode=S.AlphaDiscardMode.Opaque,r.doubleSidedMode=f.NormalsDoubleSidedMode.None,r.isSchematic=!1,r.vertexColors=!1,r.offsetBackfaces=!1,r.symbolColors=!1,r.vvSize=!1,r.vvColor=!1,r.verticalOffset=!1,r.receiveShadows=!1,r.slicePlaneEnabled=!1,r.sliceHighlightDisabled=!1,r.receiveAmbientOcclusion=!1,r.screenSizePerspective=!1,r.textureAlphaPremultiplied=!1,r.hasColorTexture=!1,r.usePBR=!1,r.hasMetalnessAndRoughnessTexture=!1,r.hasEmissionTexture=!1,r.hasOcclusionTexture=!1,r.hasNormalTexture=!1,r.instanced=!1,r.instancedColor=!1,r.instancedDoublePrecision=!1,r.vertexTangents=!1,r.normalsTypeDerivate=!1,r.writeDepth=!0,r.sceneHasOcludees=!1,r.transparent=!1,r.enableOffset=!0,r.cullFace=S.CullFaceOptions.None,r.transparencyPassType=S.TransparencyPassType.NONE,r.multipassTerrainEnabled=!1,r.cullAboveGround=!1,r.hasModelTransformation=!1,r.customDepthTest=S.DepthTestFunction.Less,r}return t._inheritsLoose(r,e),r}(P.ShaderTechniqueConfiguration);a.__decorate([P.parameter({count:n.ShaderOutput.COUNT})],R.prototype,"output",void 0),a.__decorate([P.parameter({count:S.AlphaDiscardMode.COUNT})],R.prototype,"alphaDiscardMode",void 0),a.__decorate([P.parameter({count:f.NormalsDoubleSidedMode.COUNT})],R.prototype,"doubleSidedMode",void 0),a.__decorate([P.parameter()],R.prototype,"isSchematic",void 0),a.__decorate([P.parameter()],R.prototype,"vertexColors",void 0),a.__decorate([P.parameter()],R.prototype,"offsetBackfaces",void 0),a.__decorate([P.parameter()],R.prototype,"symbolColors",void 0),a.__decorate([P.parameter()],R.prototype,"vvSize",void 0),a.__decorate([P.parameter()],R.prototype,"vvColor",void 0),a.__decorate([P.parameter()],R.prototype,"verticalOffset",void 0),a.__decorate([P.parameter()],R.prototype,"receiveShadows",void 0),a.__decorate([P.parameter()],R.prototype,"slicePlaneEnabled",void 0),a.__decorate([P.parameter()],R.prototype,"sliceHighlightDisabled",void 0),a.__decorate([P.parameter()],R.prototype,"receiveAmbientOcclusion",void 0),a.__decorate([P.parameter()],R.prototype,"screenSizePerspective",void 0),a.__decorate([P.parameter()],R.prototype,"textureAlphaPremultiplied",void 0),a.__decorate([P.parameter()],R.prototype,"hasColorTexture",void 0),a.__decorate([P.parameter()],R.prototype,"usePBR",void 0),a.__decorate([P.parameter()],R.prototype,"hasMetalnessAndRoughnessTexture",void 0),a.__decorate([P.parameter()],R.prototype,"hasEmissionTexture",void 0),a.__decorate([P.parameter()],R.prototype,"hasOcclusionTexture",void 0),a.__decorate([P.parameter()],R.prototype,"hasNormalTexture",void 0),a.__decorate([P.parameter()],R.prototype,"instanced",void 0),a.__decorate([P.parameter()],R.prototype,"instancedColor",void 0),a.__decorate([P.parameter()],R.prototype,"instancedDoublePrecision",void 0),a.__decorate([P.parameter()],R.prototype,"vertexTangents",void 0),a.__decorate([P.parameter()],R.prototype,"normalsTypeDerivate",void 0),a.__decorate([P.parameter()],R.prototype,"writeDepth",void 0),a.__decorate([P.parameter()],R.prototype,"sceneHasOcludees",void 0),a.__decorate([P.parameter()],R.prototype,"transparent",void 0),a.__decorate([P.parameter()],R.prototype,"enableOffset",void 0),a.__decorate([P.parameter({count:S.CullFaceOptions.COUNT})],R.prototype,"cullFace",void 0),a.__decorate([P.parameter({count:S.TransparencyPassType.COUNT})],R.prototype,"transparencyPassType",void 0),a.__decorate([P.parameter()],R.prototype,"multipassTerrainEnabled",void 0),a.__decorate([P.parameter()],R.prototype,"cullAboveGround",void 0),a.__decorate([P.parameter()],R.prototype,"hasModelTransformation",void 0),a.__decorate([P.parameter({count:S.DepthTestFunction.COUNT})],R.prototype,"customDepthTest",void 0),r.DefaultMaterialTechnique=L,r.DefaultMaterialTechniqueConfiguration=R,Object.defineProperties(r,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
