/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["require","exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/maybe","../../../../chunks/mat4","../../../../geometry/support/vectorStacks","../core/shaderLibrary/ShaderOutputOptions","../core/shaderLibrary/Slice.glsl","../core/shaderLibrary/output/OutputHighlight.glsl","../core/shaderLibrary/shading/MultipassTerrainTest.glsl","../core/shaderLibrary/shading/VisualVariables.glsl","../core/shaderLibrary/util/View.glsl","../core/shaderTechnique/ReloadableShaderModule","../core/shaderTechnique/ShaderTechnique","../core/shaderTechnique/ShaderTechniqueConfiguration","../lib/basicInterfaces","../lib/OrderIndependentTransparency","../lib/Program","../lib/RenderSlot","../lib/StencilUtils","../lib/VertexAttribute","../../../../chunks/RibbonLine.glsl","../../../webgl/enums","../../../webgl/renderState"],(function(e,t,r,i,o,a,n,s,l,p,c,d,u,h,f,m,b,g,T,y,P,v,_,S,O){"use strict";const E=new Map([[v.VertexAttribute.POSITION,0],[v.VertexAttribute.SUBDIVISIONFACTOR,1],[v.VertexAttribute.UV0,2],[v.VertexAttribute.AUXPOS1,3],[v.VertexAttribute.AUXPOS2,4],[v.VertexAttribute.SIZE,6],[v.VertexAttribute.SIZEFEATUREATTRIBUTE,6],[v.VertexAttribute.COLOR,5],[v.VertexAttribute.COLORFEATUREATTRIBUTE,5],[v.VertexAttribute.OPACITYFEATUREATTRIBUTE,7]]);let C=function(e){function t(t,r,i){var o;return(o=e.call(this,t,r,i)||this).stippleTextureRepository=t.stippleTextureRepository,o}r._inheritsLoose(t,e);var i=t.prototype;return i.initializeProgram=function(e){const r=t.shader.get(),i=this.configuration,o=r.build({oitEnabled:i.transparencyPassType===b.TransparencyPassType.Color,output:i.output,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,draped:i.draped,stippleEnabled:this.stippleEnabled,stippleOffColorEnabled:i.stippleOffColorEnabled,stippleRequiresClamp:!0,stippleScaleWithLineWidth:i.stippleScaleWithLineWidth,stipplePreferContinuous:i.stipplePreferContinuous,capType:i.capType,roundJoins:i.roundJoins,vvColor:i.vvColor,vvSize:i.vvSize,vvInstancingEnabled:!0,vvOpacity:i.vvOpacity,falloffEnabled:i.falloffEnabled,innerColorEnabled:i.innerColorEnabled,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround,wireframe:i.wireframe});return new T.Program(e.rctx,o,E)},i.destroy=function(){e.prototype.destroy.call(this),this.stippleTextureRepository.release(this.stipplePattern),this.stipplePattern=null,this.stippleTextureBind=null},i.bindPass=function(e,t){if(u.bindProjectionMatrix(this.program,t.camera.projectionMatrix),this.configuration.output===s.ShaderOutput.Highlight&&p.bindOutputHighlight(this.program,t),t.multipassTerrainEnabled&&(this.program.setUniform2fv("inverseViewport",t.inverseViewport),c.bindMultipassTerrainTexture(this.program,t)),this.program.setUniform1f("intrinsicWidth",e.width),this.program.setUniform4fv("intrinsicColor",e.color),this.program.setUniform1f("miterLimit","miter"!==e.join?0:e.miterLimit),this.program.setUniform2fv("nearFar",t.camera.nearFar),this.program.setUniform1f("pixelRatio",t.camera.pixelRatio),this.program.setUniform2f("screenSize",t.camera.fullViewport[2],t.camera.fullViewport[3]),d.bindVisualVariablesUniformsWithOpacity(this.program,e),this.stipplePattern!==e.stipplePattern){const t=e.stipplePattern;this.stippleTextureBind=this.stippleTextureRepository.swap(this.stipplePattern,t),this.stipplePattern=t}if(this.stippleEnabled){const{pixelSize:r,sdfNormalizer:i,pixels:a}=o.isSome(this.stippleTextureBind)?this.stippleTextureBind(this.program):{pixelSize:1,sdfNormalizer:1,pixels:1};if(this.program.setUniform1f("stipplePatternSDFNormalizer",i),this.program.setUniform1f("stipplePatternTextureSize",a),this.program.setUniform1f("stipplePatternPixelSize",r),this.program.setUniform1f("stipplePatternPixelSizeInv",1/r),this.configuration.draped?this.program.setUniform1f("worldToScreenRatio",1/t.screenToPCSRatio):this.program.setUniform1f("worldToScreenPerDistanceRatio",1/t.camera.perScreenPixelRatio),this.configuration.stippleOffColorEnabled){const t=o.unwrap(e.stippleOffColor);this.program.setUniform4f("stippleOffColor",t[0],t[1],t[2],t.length>3?t[3]:1)}}this.configuration.falloffEnabled&&this.program.setUniform1f("falloff",e.falloff),this.configuration.innerColorEnabled&&(this.program.setUniform4fv("innerColor",o.unwrapOr(e.innerColor,e.color)),this.program.setUniform1f("innerWidth",e.innerWidth*t.camera.pixelRatio))},i.bindDraw=function(e){u.bindView(this.program,e),this.stippleEnabled&&!this.configuration.draped&&u.bindCameraPosition(this.program,e.origin,e.camera.viewInverseTransposeMatrix),l.bindSliceUniforms(this.program,this.configuration,e.slicePlane,{origin:e.origin,view:e.camera.viewMatrix}),this.program.setUniformMatrix4fv("inverseProjectionMatrix",a.invert(n.sm4d.get(),e.camera.projectionMatrix)),this.program.rebindTextures()},i._makePipelineState=function(e,t){const r=this.configuration,i=e===b.TransparencyPassType.NONE,o=e===b.TransparencyPassType.FrontFace;return O.makePipelineState({blending:r.output===s.ShaderOutput.Color||r.output===s.ShaderOutput.Alpha?i?g.blendingDefault:g.oitBlending(e):null,depthTest:{func:g.oitDepthTest(e)},depthWrite:i?r.writeDepth&&O.defaultDepthWriteParams:g.oitDepthWrite(e),colorWrite:O.defaultColorWriteParams,stencilWrite:r.sceneHasOcludees?P.stencilWriteMaskOn:null,stencilTest:r.sceneHasOcludees?t?P.stencilToolMaskBaseParams:P.stencilBaseAllZerosParams:null,polygonOffset:i||o?r.polygonOffset&&x:g.OITPolygonOffset})},i.initializePipeline=function(){const e=this.configuration,t=e.polygonOffset&&x;return e.occluder&&(this._occluderPipelineTransparent=O.makePipelineState({blending:g.blendingDefault,polygonOffset:t,depthTest:P.depthCompareAlways,depthWrite:null,colorWrite:O.defaultColorWriteParams,stencilWrite:null,stencilTest:P.stencilToolTransparentOccluderParams}),this._occluderPipelineOpaque=O.makePipelineState({blending:g.blendingDefault,polygonOffset:t,depthTest:P.depthCompareAlways,depthWrite:null,colorWrite:O.defaultColorWriteParams,stencilWrite:P.stencilWriteMaskOff,stencilTest:P.stencilToolMaskOccluderParams}),this._occluderPipelineMaskWrite=O.makePipelineState({blending:null,polygonOffset:t,depthTest:P.depthCompareLess,depthWrite:null,colorWrite:null,stencilWrite:P.stencilWriteMaskOn,stencilTest:P.stencilToolMaskBaseParams})),this._occludeePipelineState=this._makePipelineState(this.configuration.transparencyPassType,!0),this._makePipelineState(this.configuration.transparencyPassType,!1)},i.getPipelineState=function(t,r){return r?this._occludeePipelineState:this.configuration.occluder?t===y.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL?this._occluderPipelineTransparent:t===y.RenderSlot.OCCLUDER_MATERIAL?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:e.prototype.getPipelineState.call(this,t,r)},r._createClass(t,[{key:"stippleEnabled",get:function(){return this.configuration.stippleEnabled&&this.configuration.output!==s.ShaderOutput.Highlight}},{key:"primitiveType",get:function(){return this.configuration.wireframe?S.PrimitiveType.LINES:S.PrimitiveType.TRIANGLE_STRIP}}]),t}(f.ShaderTechnique);C.shader=new h.ReloadableShaderModule(_.RibbonLineShader,(()=>new Promise(((t,r)=>e(["./RibbonLine.glsl"],t,r)))));const x={factor:0,units:-4};let R=function(e){function t(){var t;return(t=e.apply(this,arguments)||this).output=s.ShaderOutput.Color,t.occluder=!1,t.slicePlaneEnabled=!1,t.transparent=!1,t.polygonOffset=!1,t.writeDepth=!1,t.draped=!1,t.stippleEnabled=!1,t.stippleOffColorEnabled=!1,t.stippleScaleWithLineWidth=!1,t.stipplePreferContinuous=!0,t.capType=_.CapType.BUTT,t.roundJoins=!1,t.vvSize=!1,t.vvColor=!1,t.vvOpacity=!1,t.falloffEnabled=!1,t.innerColorEnabled=!1,t.sceneHasOcludees=!1,t.transparencyPassType=b.TransparencyPassType.NONE,t.multipassTerrainEnabled=!1,t.cullAboveGround=!1,t.wireframe=!1,t}return r._inheritsLoose(t,e),t}(m.ShaderTechniqueConfiguration);i.__decorate([m.parameter({count:s.ShaderOutput.COUNT})],R.prototype,"output",void 0),i.__decorate([m.parameter()],R.prototype,"occluder",void 0),i.__decorate([m.parameter()],R.prototype,"slicePlaneEnabled",void 0),i.__decorate([m.parameter()],R.prototype,"transparent",void 0),i.__decorate([m.parameter()],R.prototype,"polygonOffset",void 0),i.__decorate([m.parameter()],R.prototype,"writeDepth",void 0),i.__decorate([m.parameter()],R.prototype,"draped",void 0),i.__decorate([m.parameter()],R.prototype,"stippleEnabled",void 0),i.__decorate([m.parameter()],R.prototype,"stippleOffColorEnabled",void 0),i.__decorate([m.parameter()],R.prototype,"stippleScaleWithLineWidth",void 0),i.__decorate([m.parameter()],R.prototype,"stipplePreferContinuous",void 0),i.__decorate([m.parameter({count:_.CapType.COUNT})],R.prototype,"capType",void 0),i.__decorate([m.parameter()],R.prototype,"roundJoins",void 0),i.__decorate([m.parameter()],R.prototype,"vvSize",void 0),i.__decorate([m.parameter()],R.prototype,"vvColor",void 0),i.__decorate([m.parameter()],R.prototype,"vvOpacity",void 0),i.__decorate([m.parameter()],R.prototype,"falloffEnabled",void 0),i.__decorate([m.parameter()],R.prototype,"innerColorEnabled",void 0),i.__decorate([m.parameter()],R.prototype,"sceneHasOcludees",void 0),i.__decorate([m.parameter({count:b.TransparencyPassType.COUNT})],R.prototype,"transparencyPassType",void 0),i.__decorate([m.parameter()],R.prototype,"multipassTerrainEnabled",void 0),i.__decorate([m.parameter()],R.prototype,"cullAboveGround",void 0),i.__decorate([m.parameter()],R.prototype,"wireframe",void 0),t.RibbonLineTechnique=C,t.RibbonLineTechniqueConfiguration=R,t.ribbonVertexAttributeLocations=E,Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
