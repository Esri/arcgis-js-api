/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["require","exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/maybe","../core/shaderTechnique/ReloadableShaderModule","../core/shaderTechnique/ShaderTechnique","../core/shaderTechnique/ShaderTechniqueConfiguration","../../../webgl/Program","../../../webgl/renderState","../core/shaderLibrary/util/View.glsl","../core/shaderLibrary/Slice.glsl","../core/shaderLibrary/output/OutputHighlight.glsl","../core/shaderLibrary/shading/VisualVariables.glsl","../lib/OrderIndependentTransparency","../lib/StencilUtils","../../../../chunks/RibbonLine.glsl"],(function(e,t,i,r,o,n,a,s,l,p,c,d,u,f,h,b,g){"use strict";const m={position:0,subdivisionFactor:1,uv0:2,auxpos1:3,auxpos2:4,size:6,sizeFeatureAttribute:6,color:5,colorFeatureAttribute:5,opacityFeatureAttribute:7};let y=function(e){function t(t,i){var r;return(r=e.call(this,t,i)||this).stipplePattern=null,r.stippleTextureBind=null,r.stippleTextureRepository=t.stippleTextureRepository,r}i._inheritsLoose(t,e);var r=t.prototype;return r.initializeProgram=function(e){const i=t.shader.get(),r=this.configuration,o=i.build({OITEnabled:0===r.transparencyPassType,output:r.output,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:r.sliceHighlightDisabled,sliceEnabledForVertexPrograms:!1,stippleEnabled:r.stippleEnabled,stippleOffColorEnabled:r.stippleOffColorEnabled,stippleUVMaxEnabled:r.stippleIntegerRepeatsEnabled,stippleIntegerRepeatsEnabled:r.stippleIntegerRepeatsEnabled,roundCaps:r.roundCaps,roundJoins:r.roundJoins,vvColor:r.vvColor,vvSize:r.vvSize,vvInstancingEnabled:!0,vvOpacity:r.vvOpacity,falloffEnabled:r.falloffEnabled,innerColorEnabled:r.innerColorEnabled});return new l(e.rctx,o.generateSource("vertex"),o.generateSource("fragment"),m)},r.dispose=function(){e.prototype.dispose.call(this),this.stippleTextureRepository.release(this.stipplePattern),this.stipplePattern=null,this.stippleTextureBind=null},r.bindPass=function(e,t,i){if(c.View.bindProjectionMatrix(this.program,i.camera.projectionMatrix),4===this.configuration.output&&u.OutputHighlight.bindOutputHighlight(e,this.program,i),this.program.setUniform1f("intrinsicWidth",t.width),this.program.setUniform4fv("intrinsicColor",t.color),this.program.setUniform1f("miterLimit","miter"!==t.join?0:t.miterLimit),this.program.setUniform2fv("nearFar",i.camera.nearFar),this.program.setUniform1f("pixelRatio",i.camera.pixelRatio),this.program.setUniform2f("screenSize",i.camera.fullViewport[2],i.camera.fullViewport[3]),f.VisualVariables.bindUniformsWithOpacity(this.program,t),this.stipplePattern!==t.stipplePattern){const e=t.stipplePattern;this.stippleTextureBind=this.stippleTextureRepository.swap(this.stipplePattern,e),this.stipplePattern=e}if(this.configuration.stippleEnabled){const r=o.isSome(this.stippleTextureBind)?this.stippleTextureBind(e,0)*i.camera.pixelRatio:1;if(this.program.setUniform1i("stipplePatternTexture",0),this.program.setUniform1f("stipplePatternPixelSizeInv",1/r),this.configuration.stippleOffColorEnabled){const e=o.unwrap(t.stippleOffColor);this.program.setUniform4f("stippleOffColor",e[0],e[1],e[2],e.length>3?e[3]:1)}}this.configuration.falloffEnabled&&this.program.setUniform1f("falloff",t.falloff),this.configuration.innerColorEnabled&&(this.program.setUniform4fv("innerColor",o.unwrapOr(t.innerColor,t.color)),this.program.setUniform1f("innerWidth",t.innerWidth*i.camera.pixelRatio))},r.bindDraw=function(e){c.View.bindView(this.program,e),d.Slice.bindUniformsWithOrigin(this.program,this.configuration,e)},r.setPipelineState=function(e,t){const i=this.configuration,r=3===e,o=2===e;return p.makePipelineState({blending:0===i.output||7===i.output?r?h.blendingDefault:h.OITBlending(e):null,depthTest:{func:h.OITDepthTest(e)},depthWrite:r?!i.transparent&&i.writeDepth&&p.defaultDepthWriteParams:h.OITDepthWrite(e),colorWrite:p.defaultColorWriteParams,stencilWrite:i.sceneHasOcludees?b.stencilWriteMaskOn:null,stencilTest:i.sceneHasOcludees?t?b.stencilToolMaskBaseParams:b.stencilBaseAllZerosParams:null,polygonOffset:r||o?i.polygonOffset&&v:h.OITPolygonOffset})},r.initializePipeline=function(){const e=this.configuration,t=e.polygonOffset&&v;return e.occluder&&(this._occluderPipelineTransparent=p.makePipelineState({blending:h.blendingDefault,polygonOffset:t,depthTest:b.depthCompareAlways,depthWrite:null,colorWrite:p.defaultColorWriteParams,stencilWrite:null,stencilTest:b.stencilToolTransparentOccluderParams}),this._occluderPipelineOpaque=p.makePipelineState({blending:h.blendingDefault,polygonOffset:t,depthTest:b.depthCompareAlways,depthWrite:null,colorWrite:p.defaultColorWriteParams,stencilWrite:b.stencilWriteMaskOff,stencilTest:b.stencilToolMaskOccluderParams}),this._occluderPipelineMaskWrite=p.makePipelineState({blending:null,polygonOffset:t,depthTest:b.depthCompareLess,depthWrite:null,colorWrite:null,stencilWrite:b.stencilWriteMaskOn,stencilTest:b.stencilToolMaskBaseParams})),this._occludeePipelineState=this.setPipelineState(this.configuration.transparencyPassType,!0),this.setPipelineState(this.configuration.transparencyPassType,!1)},r.getPipelineState=function(e,t){return t?this._occludeePipelineState:this.configuration.occluder?11===e?this._occluderPipelineTransparent:10===e?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:this.pipeline},i._createClass(t,[{key:"primitiveType",get:function(){return 5}}]),t}(a.ShaderTechnique);y.shader=new n.ReloadableShaderModule(g.RibbonLineShader,(()=>new Promise((function(t,i){e(["./RibbonLine.glsl"],t,i)}))));const v={factor:0,units:-4};let T=function(e){function t(){var t;return(t=e.apply(this,arguments)||this).output=0,t.occluder=!1,t.slicePlaneEnabled=!1,t.sliceHighlightDisabled=!1,t.vertexColors=!1,t.transparent=!1,t.polygonOffset=!1,t.writeDepth=!1,t.stippleEnabled=!1,t.stippleOffColorEnabled=!1,t.stippleIntegerRepeatsEnabled=!1,t.roundCaps=!1,t.roundJoins=!1,t.vvSize=!1,t.vvColor=!1,t.vvOpacity=!1,t.falloffEnabled=!1,t.innerColorEnabled=!1,t.sceneHasOcludees=!1,t.transparencyPassType=3,t}return i._inheritsLoose(t,e),t}(s.ShaderTechniqueConfiguration);r.__decorate([s.parameter({count:8})],T.prototype,"output",void 0),r.__decorate([s.parameter()],T.prototype,"occluder",void 0),r.__decorate([s.parameter()],T.prototype,"slicePlaneEnabled",void 0),r.__decorate([s.parameter()],T.prototype,"sliceHighlightDisabled",void 0),r.__decorate([s.parameter()],T.prototype,"vertexColors",void 0),r.__decorate([s.parameter()],T.prototype,"transparent",void 0),r.__decorate([s.parameter()],T.prototype,"polygonOffset",void 0),r.__decorate([s.parameter()],T.prototype,"writeDepth",void 0),r.__decorate([s.parameter()],T.prototype,"stippleEnabled",void 0),r.__decorate([s.parameter()],T.prototype,"stippleOffColorEnabled",void 0),r.__decorate([s.parameter()],T.prototype,"stippleIntegerRepeatsEnabled",void 0),r.__decorate([s.parameter()],T.prototype,"roundCaps",void 0),r.__decorate([s.parameter()],T.prototype,"roundJoins",void 0),r.__decorate([s.parameter()],T.prototype,"vvSize",void 0),r.__decorate([s.parameter()],T.prototype,"vvColor",void 0),r.__decorate([s.parameter()],T.prototype,"vvOpacity",void 0),r.__decorate([s.parameter()],T.prototype,"falloffEnabled",void 0),r.__decorate([s.parameter()],T.prototype,"innerColorEnabled",void 0),r.__decorate([s.parameter()],T.prototype,"sceneHasOcludees",void 0),r.__decorate([s.parameter({count:4})],T.prototype,"transparencyPassType",void 0),t.RibbonLineTechnique=y,t.RibbonLineTechniqueConfiguration=T,t.RibbonVertexAttributeConstants={POSITION:"position",SUBDIVISIONFACTOR:"subdivisionFactor",UV0:"uv0",AUXPOS1:"auxpos1",AUXPOS2:"auxpos2",SUBDIVISIONS:"subdivisions",COLOR:"color",COLORFEATUREATTRIBUTE:"colorFeatureAttribute",SIZE:"size",SIZEFEATUREATTRIBUTE:"sizeFeatureAttribute",OPACITYFEATUREATTRIBUTE:"opacityFeatureAttribute"},t.ribbonVertexAttributeLocations=m,Object.defineProperty(t,"__esModule",{value:!0})}));
