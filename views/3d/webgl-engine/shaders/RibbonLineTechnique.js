/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{isSome as e}from"../../../../core/maybe.js";import{ShaderOutput as t}from"../core/shaderLibrary/ShaderOutputOptions.js";import{ReloadableShaderModule as i}from"../core/shaderTechnique/ReloadableShaderModule.js";import{ShaderTechnique as r}from"../core/shaderTechnique/ShaderTechnique.js";import{TransparencyPassType as s}from"../lib/basicInterfaces.js";import{blendingDefault as n,oitBlending as l,oitDepthTest as o,oitDepthWrite as p,OITPolygonOffset as a}from"../lib/OrderIndependentTransparency.js";import{Program as c}from"../lib/Program.js";import{RenderSlot as u}from"../lib/RenderSlot.js";import{stencilWriteMaskOn as h,stencilToolMaskBaseParams as d,stencilBaseAllZerosParams as f,depthCompareAlways as m,stencilToolTransparentOccluderParams as T,stencilWriteMaskOff as P,stencilToolMaskOccluderParams as g,depthCompareLess as S}from"../lib/StencilUtils.js";import{VertexAttribute as O}from"../lib/VertexAttribute.js";import{R}from"../../../../chunks/RibbonLine.glsl.js";import{PrimitiveType as b}from"../../../webgl/enums.js";import{makePipelineState as y,defaultDepthWriteParams as E,defaultColorWriteParams as x}from"../../../webgl/renderState.js";const A=new Map([[O.POSITION,0],[O.SUBDIVISIONFACTOR,1],[O.UV0,2],[O.AUXPOS1,3],[O.AUXPOS2,4],[O.COLOR,5],[O.COLORFEATUREATTRIBUTE,5],[O.SIZE,6],[O.SIZEFEATUREATTRIBUTE,6],[O.OPACITYFEATUREATTRIBUTE,7]]);class I extends r{constructor(e,t,i){super(e,t,i),this.stippleTextureRepository=e.stippleTextureRepository}initializeProgram(e){const t=I.shader.get().build(this.configuration);return new c(e.rctx,t,A)}destroy(){super.destroy(),this.stippleTextureRepository.release(this.stipplePattern),this.stipplePattern=null,this.stippleTextureBind=null}bindPass(t,i){if(this.program.bindPass(t,i),this.stipplePattern!==t.stipplePattern){const e=t.stipplePattern;this.stippleTextureBind=this.stippleTextureRepository.swap(this.stipplePattern,e),this.stipplePattern=e}if(this.configuration.stippleEnabled){const{pixelSize:t,sdfNormalizer:i,pixels:r}=e(this.stippleTextureBind)?this.stippleTextureBind(this.program):{pixelSize:1,sdfNormalizer:1,pixels:1};this.program.setUniform1f("stipplePatternSDFNormalizer",i),this.program.setUniform1f("stipplePatternTextureSize",r),this.program.setUniform1f("stipplePatternPixelSize",t),this.program.setUniform1f("stipplePatternPixelSizeInv",1/t)}}_makePipelineState(e,i){const r=this.configuration,c=e===s.NONE,u=e===s.FrontFace;return y({blending:r.output===t.Color||r.output===t.Alpha?c?n:l(e):null,depthTest:{func:o(e)},depthWrite:c?r.writeDepth&&E:p(e),colorWrite:x,stencilWrite:r.hasOccludees?h:null,stencilTest:r.hasOccludees?i?d:f:null,polygonOffset:c||u?r.hasPolygonOffset&&U:a})}initializePipeline(){const e=this.configuration;if(e.occluder){const t=e.hasPolygonOffset&&U;this._occluderPipelineTransparent=y({blending:n,polygonOffset:t,depthTest:m,depthWrite:null,colorWrite:x,stencilWrite:null,stencilTest:T}),this._occluderPipelineOpaque=y({blending:n,polygonOffset:t,depthTest:m,depthWrite:null,colorWrite:x,stencilWrite:P,stencilTest:g}),this._occluderPipelineMaskWrite=y({blending:null,polygonOffset:t,depthTest:S,depthWrite:null,colorWrite:null,stencilWrite:h,stencilTest:d})}return this._occludeePipelineState=this._makePipelineState(this.configuration.transparencyPassType,!0),this._makePipelineState(this.configuration.transparencyPassType,!1)}get primitiveType(){return this.configuration.wireframe?b.LINES:b.TRIANGLE_STRIP}getPipelineState(e,t){return t?this._occludeePipelineState:this.configuration.occluder?e===u.TRANSPARENT_OCCLUDER_MATERIAL?this._occluderPipelineTransparent:e===u.OCCLUDER_MATERIAL?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:super.getPipelineState(e,t)}}I.shader=new i(R,(()=>import("./RibbonLine.glsl.js")));const U={factor:0,units:-4};export{I as RibbonLineTechnique,A as ribbonVertexAttributeLocations};
