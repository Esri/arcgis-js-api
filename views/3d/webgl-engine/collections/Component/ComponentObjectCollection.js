/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/Logger","../../../../../core/maybe","../../../../../core/PooledArray","../../../../../chunks/mat3","../../../../../chunks/mat3f32","../../../../../chunks/vec3","../../../../../chunks/vec3f64","../../../../../chunks/vec4","../../../../../chunks/vec4f32","../../../layers/support/symbolColorUtils","../../../support/orientedBoundingBox","../../../support/buffer/glUtil","../../../support/buffer/InterleavedLayout","./ComponentData","./ComponentObject","./interface","./IntersectionGeometry","./Renderable","./RenderGeometry","./RenderSubmitSystem","./SourceGeometry","./Material/ComponentMaterial","./Material/ComponentTechnique","../../core/util/TwoVectorPosition","../../lib/ComponentUtils","../../lib/Util","../../lib/TextureBackedBuffer/BufferManager","../../../../webgl/BufferObject","../../../../webgl/VertexArrayObject"],(function(e,t,o,n,r,i,s,a,c,l,m,u,p,h,f,b,g,d,y,C,w,M,x,S,_,v,P,D,j,O,k){"use strict";const B=o.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection");let U=function(){function e(e){this._renderManager=e,this._objects=[new r,new r],this._renderSubmit=new M.RenderSubmitSystem(this),this._renderManager.register(this._renderSubmit),this._componentBufferManager=new j.BufferManager(e.rctx)}var o=e.prototype;return o.dispose=function(){D.assert(0===this._objects[0].length&&0===this._objects[1].length,"ObjectCollection should be empty upon disposal"),this._componentBufferManager.destroy()},o.createObject=function(e){const t=new g.ComponentObject;return t.toMapSpace=e.toMapSpace.slice(),t.transform=e.transform,t.obb=p.clone(e.obb),t.components=new b(this._componentBufferManager,e.geometry.componentOffsets),t.renderable=this._createRenderable(e,t.components),t.intersectionGeometry=new y(e.geometry.positionData,t.components),this._objects[t.visible].push(t),t},o.destroyObject=function(e){const t=e;this._objects[t.visible].removeUnordered(t),t.dispose(),this._notifyDirty()},o.setObjectVisibility=function(e,t){const o=e;t!==o.visible&&(this._objects[o.visible].removeUnordered(o),this._objects[t].push(o),o.visible=t,this._notifyDirty())},o.preSubmit=function(e){const t=e.camera.eye;this.visibleObjects.forAll((e=>{const o=a.squaredDistance(t,e.obb.center);e.renderable.meta.cameraDepthSquared=o}))},o.getMaterial=function(e){return e.renderable.material},o.updateMaterial=function(e,t){const o=e.renderable.material;t(o),o.dirty&&this._notifyDirty()},o.setAllComponentVisibilities=function(e,t){const o=e;o.components.visibility.reset(t),o.components.visibilityDirty(),this._notifyDirty()},o.forEachVisibleComponent=function(e,t){return e.components.visibility.forEachComponent(t)},o.getComponentCount=function(e){const t=e,o=t.components.visibility.componentCount();return{visible:o,invisible:t.components.count-o}},o.setComponentData=function(e,t){const o=e,n=o.renderable.material;if(d.isVaryingComponentParameters(t)){const e=o.components,r=e.materialDataBuffer,i=e.materialDataIndices,s={castShadows:!0,pickable:!0,externalColor:m.create(),externalColorMixMode:1},a=r.textureBuffer,c=new Uint8Array(4),l=new Uint32Array(c.buffer);let p=0,h=0,f=0,b=!1,g=0;for(let o=0;o<e.count;o++)t(o,s),p+=+(s.externalColor[3]<1),h+=+(3===s.externalColorMixMode&&1===s.externalColor[3]),f+=+s.castShadows,u.encodeSymbolColor(s.externalColor,s.externalColorMixMode,c),c[2]=254&c[2]|+s.castShadows,a.setData(i[o],0,c[0],c[1],c[2],c[3]),b=b||o>0&&g!==l[0],g=l[0],s.pickable!==P.getVisibility(e.pickability,o)&&(e.pickability=P.updateVisibilityWithCount(e.pickability,e.count,o,s.pickable));b?(n.componentParameters=new S.ComponentParametersVarying,n.componentParameters.castShadows=G(f,e.count),n.componentParameters.transparent=G(p,e.count),n.componentParameters.opaqueOverride=G(h,e.count),n.componentParameters.texture=a,a.updateTexture()):(n.componentParameters=new S.ComponentParametersUniform,n.componentParameters.castShadows=s.castShadows?0:2,n.componentParameters.externalColor=s.externalColor,n.componentParameters.externalColorMixMode=s.externalColorMixMode)}else n.componentParameters=new S.ComponentParametersUniform,n.componentParameters.castShadows=t.castShadows?0:2,n.componentParameters.externalColor=t.externalColor,n.componentParameters.externalColorMixMode=t.externalColorMixMode;this._notifyDirty()},o.getComponentAabb=function(e,t,o){return e.intersectionGeometry.getComponentAabb(t,o)},o.getComponentObb=function(e){return e.obb},o.getObjectTransform=function(e){return e.transform},o.getComponentPositions=function(e,t,o){return e.intersectionGeometry.getComponentPositions(t,o)},o.intersect=function(e,t,o,r,s,c){const l=e;n.isSome(s)&&(s.localOrigin=l.transform.position);const m=i.invert(R,l.transform.rotationScale);a.sub(A,t,l.transform.position),a.sub(L,o,l.transform.position),a.transformMat3(A,A,m),a.transformMat3(L,L,m);const u=i.transpose(R,m);return l.intersectionGeometry.intersect(A,L,r,u,s,c)},o.addEdges=function(e,t,o,n){const r=e,{indices:i,positions:s}=r.intersectionGeometry,a=r.components.offsets;return t.addComponentObject(e,r.transform,{center:r.obb.center,radius:p.radius(r.obb)},s,i,a,o,n)},o.addComponentHighlight=function(e,t){const o=e.components;n.isNone(o.highlightCounts)&&(o.highlightCounts=new Uint32Array(o.count+1));0===o.highlightCounts[t]++&&(o.highlightsDirty(),this._notifyDirty()),o.highlightCounts[o.count]++},o.removeComponentHighlight=function(e,t){const o=e.components;if(n.isNone(o.highlightCounts))return void B.warn("Removing non-existing highlight.");const r=o.highlightCounts[t],i=o.highlightCounts[o.count];if(0!==r){if(r>1)return o.highlightCounts[t]=r-1,void(o.highlightCounts[o.count]=i-1);o.highlightCounts[t]=0,o.highlightsDirty(),this._notifyDirty(),1===i?o.highlightCounts=null:o.highlightCounts[o.count]=i-1}else B.warn("Removing non-existing highlight.")},o.clearHighlights=function(e){const t=e.components;n.isSome(t.highlightCounts)&&(t.highlightCounts=null,t.highlightsDirty(),this._notifyDirty())},o.getObjectGPUMemoryUsage=function(e){return e.renderable.meta.gpuMemoryEstimate},o._createRenderable=function(e,t){const o=this._renderManager.rctx,r=e.geometry,c=r.vertices.layoutParameters,m=O.createVertex(o,35044,r.vertices.data),u=n.applySome(r.indices,(e=>O.createIndex(o,35044,e))),p=h.glLayout(x.createVertexBufferLayout(c)),f=new Uint16Array(r.vertices.count);for(let i=0;i<t.count;i++){const e=t.offsets[i],o=t.offsets[i+1],s=t.materialDataIndices[i];if(n.isSome(r.indices))for(let t=e;t<o;t++){f[r.indices[t]]=s}else for(let t=e;t<o;t++)f[t]=s}const b=O.createVertex(o,35044,f.buffer),g=new v.TwoVectorPosition(e.transform.position),d=s.clone(e.transform.rotationScale);i.invert(d,d),i.transpose(d,d);const y=new _.ComponentDrawParameters;a.copy(y.worldFromModel_TL,g.low),a.copy(y.worldFromModel_TH,g.high),i.copy(y.worldFromModel_RS,e.transform.rotationScale),i.copy(y.transformNormal_GlobalFromModel,d),l.copy(y.toMapSpace,e.toMapSpace);const M=new S.ComponentMaterial,P=new k(o,M.attributeLocations,{data:p,componentIndices:V},{data:m,componentIndices:b},n.unwrap(u)),D=new w.RenderGeometry(P,4,c,n.isSome(u)),j={cameraDepthSquared:.5,gpuMemoryEstimate:m.byteSize+b.byteSize+(n.isSome(u)?u.byteSize:0)};return new C.Renderable(M,y,D,j)},o._notifyDirty=function(){this._renderManager.notifyDirty()},t._createClass(e,[{key:"visibleObjects",get:function(){return this._objects[1]}}]),e}();const V=h.glLayout(f.newLayout().u16("componentIndex"));function G(e,t){return e===t?0:0===e?2:1}const R=s.create(),A=c.create(),L=c.create();e.ComponentObjectCollection=U,Object.defineProperty(e,"__esModule",{value:!0})}));
