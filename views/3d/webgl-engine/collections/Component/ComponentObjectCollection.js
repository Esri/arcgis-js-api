/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/Logger","../../../../../core/maybe","../../../../../core/PooledArray","../../../../../chunks/mat3","../../../../../chunks/mat3f32","../../../../../chunks/vec3","../../../../../chunks/vec3f64","../../../../../chunks/vec4","../../../../../chunks/vec4f32","../../../layers/support/symbolColorUtils","../../../support/orientedBoundingBox","../../../support/buffer/glUtil","../../../support/buffer/InterleavedLayout","./ComponentData","./ComponentObject","./interface","./IntersectionGeometry","./Renderable","./RenderGeometry","./RenderSubmitSystem","./SourceGeometry","./Material/ComponentMaterial","./Material/ComponentTechnique","../../core/util/TwoVectorPosition","../../lib/ComponentUtils","../../lib/Util","../../lib/VertexAttribute","../../lib/TextureBackedBuffer/BufferManager","../../../../webgl/BufferObject","../../../../webgl/enums","../../../../webgl/VertexArrayObject"],(function(e,t,o,n,r,i,a,s,c,l,m,u,p,h,f,b,g,d,y,C,S,M,x,w,v,P,_,D,j,O,A,T,V){"use strict";const B=o.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection");let U=function(){function e(e){this._renderManager=e,this._objects=[new r,new r],this._renderSubmit=new M.RenderSubmitSystem(this),this._renderManager.register(this._renderSubmit),this._componentBufferManager=new O.BufferManager(e.rctx)}var o=e.prototype;return o.dispose=function(){D.assert(0===this._objects[g.State.Hidden].length&&0===this._objects[g.State.Visible].length,"ObjectCollection should be empty upon disposal"),this._componentBufferManager.destroy()},o.createObject=function(e){const t=new g.ComponentObject;return t.toMapSpace=e.toMapSpace.slice(),t.transform=e.transform,t.obb=p.clone(e.obb),t.components=new b(this._componentBufferManager,e.geometry.componentOffsets),t.renderable=this._createRenderable(e,t.components),t.intersectionGeometry=new y(e.geometry.positionData,t.components),this._objects[t.visible].push(t),t},o.destroyObject=function(e){const t=e;this._objects[t.visible].removeUnordered(t),t.dispose(),this._notifyDirty()},o.setObjectVisibility=function(e,t){const o=e;t!==o.visible&&(this._objects[o.visible].removeUnordered(o),this._objects[t].push(o),o.visible=t,this._notifyDirty())},o.preSubmit=function(e){const t=e.camera.eye;this.visibleObjects.forAll((e=>{const o=s.squaredDistance(t,e.obb.center);e.renderable.meta.cameraDepthSquared=o}))},o.getMaterial=function(e){return e.renderable.material},o.updateMaterial=function(e,t){const o=e.renderable.material;t(o),o.dirty&&this._notifyDirty()},o.setAllComponentVisibilities=function(e,t){const o=e;o.components.visibility.reset(t),o.components.visibilityDirty(),this._notifyDirty()},o.forEachVisibleComponent=function(e,t){return e.components.visibility.forEachComponent(t)},o.getComponentCount=function(e){const t=e,o=t.components.visibility.componentCount();return{visible:o,invisible:t.components.count-o}},o.setComponentData=function(e,t){const o=e,n=o.renderable.material;if(d.isVaryingComponentParameters(t)){const e=o.components,r=e.materialDataBuffer,i=e.materialDataIndices,a={castShadows:!0,pickable:!0,externalColor:m.create(),externalColorMixMode:u.ColorMixModeEnum.Multiply},s=r.textureBuffer,c=new Uint8Array(4),l=new Uint32Array(c.buffer);let p=0,h=0,f=0,b=!1,g=0;for(let o=0;o<e.count;o++)t(o,a),p+=+(a.externalColor[3]<1),h+=+(a.externalColorMixMode===u.ColorMixModeEnum.Replace&&1===a.externalColor[3]),f+=+a.castShadows,u.encodeSymbolColor(a.externalColor,a.externalColorMixMode,c),c[2]=254&c[2]|+a.castShadows,s.setData(i[o],0,c[0],c[1],c[2],c[3]),b=b||o>0&&g!==l[0],g=l[0],a.pickable!==_.getVisibility(e.pickability,o)&&(e.pickability=_.updateVisibilityWithCount(e.pickability,e.count,o,a.pickable));b?(n.componentParameters=new w.ComponentParametersVarying,n.componentParameters.castShadows=k(f,e.count),n.componentParameters.transparent=k(p,e.count),n.componentParameters.opaqueOverride=k(h,e.count),n.componentParameters.texture=s,s.updateTexture()):(n.componentParameters=new w.ComponentParametersUniform,n.componentParameters.castShadows=a.castShadows?w.ComponentParameterSummary.All:w.ComponentParameterSummary.None,n.componentParameters.externalColor=a.externalColor,n.componentParameters.externalColorMixMode=a.externalColorMixMode)}else n.componentParameters=new w.ComponentParametersUniform,n.componentParameters.castShadows=t.castShadows?w.ComponentParameterSummary.All:w.ComponentParameterSummary.None,n.componentParameters.externalColor=t.externalColor,n.componentParameters.externalColorMixMode=t.externalColorMixMode;this._notifyDirty()},o.getComponentAabb=function(e,t,o){return e.intersectionGeometry.getComponentAabb(t,o)},o.getComponentObb=function(e){return e.obb},o.getObjectTransform=function(e){return e.transform},o.getComponentPositions=function(e,t,o){return e.intersectionGeometry.getComponentPositions(t,o)},o.intersect=function(e,t,o,r,a,c){const l=e;n.isSome(a)&&(a.localOrigin=l.transform.position);const m=i.invert(G,l.transform.rotationScale);s.sub(I,t,l.transform.position),s.sub(E,o,l.transform.position),s.transformMat3(I,I,m),s.transformMat3(E,E,m);const u=i.transpose(G,m);return l.intersectionGeometry.intersect(I,E,r,u,a,c)},o.addEdges=function(e,t,o,n){const r=e,{indices:i,positions:a}=r.intersectionGeometry,s=r.components.offsets;return t.addComponentObject(e,r.transform,{center:r.obb.center,radius:p.radius(r.obb)},a,i,s,o,n)},o.addComponentHighlight=function(e,t){const o=e.components;n.isNone(o.highlightCounts)&&(o.highlightCounts=new Uint32Array(o.count+1));0===o.highlightCounts[t]++&&(o.highlightsDirty(),this._notifyDirty()),o.highlightCounts[o.count]++},o.removeComponentHighlight=function(e,t){const o=e.components;if(n.isNone(o.highlightCounts))return void B.warn("Removing non-existing highlight.");const r=o.highlightCounts[t],i=o.highlightCounts[o.count];if(0!==r){if(r>1)return o.highlightCounts[t]=r-1,void(o.highlightCounts[o.count]=i-1);o.highlightCounts[t]=0,o.highlightsDirty(),this._notifyDirty(),1===i?o.highlightCounts=null:o.highlightCounts[o.count]=i-1}else B.warn("Removing non-existing highlight.")},o.clearHighlights=function(e){const t=e.components;n.isSome(t.highlightCounts)&&(t.highlightCounts=null,t.highlightsDirty(),this._notifyDirty())},o.getObjectGPUMemoryUsage=function(e){return e.renderable.meta.gpuMemoryEstimate},o._createRenderable=function(e,t){const o=this._renderManager.rctx,r=e.geometry,c=r.vertices.layoutParameters,m=A.BufferObject.createVertex(o,T.Usage.STATIC_DRAW,r.vertices.data),u=n.applySome(r.indices,(e=>A.BufferObject.createIndex(o,T.Usage.STATIC_DRAW,e))),p=h.glLayout(x.createVertexBufferLayout(c)),f=new Uint16Array(r.vertices.count);for(let i=0;i<t.count;i++){const e=t.offsets[i],o=t.offsets[i+1],a=t.materialDataIndices[i];if(n.isSome(r.indices))for(let t=e;t<o;t++){f[r.indices[t]]=a}else for(let t=e;t<o;t++)f[t]=a}const b=A.BufferObject.createVertex(o,T.Usage.STATIC_DRAW,f.buffer),g=new P.TwoVectorPosition(e.transform.position),d=a.clone(e.transform.rotationScale);i.invert(d,d),i.transpose(d,d);const y=new v.ComponentDrawParameters;s.copy(y.transformWorldFromModelTL,g.low),s.copy(y.transformWorldFromModelTH,g.high),i.copy(y.transformWorldFromModelRS,e.transform.rotationScale),i.copy(y.transformNormalGlobalFromModel,d),l.copy(y.toMapSpace,e.toMapSpace);const M=new w.ComponentMaterial,_=new V.VertexArrayObject(o,M.attributeLocations,{data:p,componentIndices:R},{data:m,componentIndices:b},n.unwrap(u)),D=new S.RenderGeometry(_,T.PrimitiveType.TRIANGLES,c,n.isSome(u)),j={cameraDepthSquared:.5,gpuMemoryEstimate:m.byteSize+b.byteSize+(n.isSome(u)?u.byteSize:0)};return new C.Renderable(M,y,D,j)},o._notifyDirty=function(){this._renderManager.notifyDirty()},t._createClass(e,[{key:"visibleObjects",get:function(){return this._objects[g.State.Visible]}}]),e}();const R=h.glLayout(f.newLayout().u16(j.VertexAttribute.COMPONENTINDEX));function k(e,t){return e===t?w.ComponentParameterSummary.All:0===e?w.ComponentParameterSummary.None:w.ComponentParameterSummary.Some}const G=a.create(),I=c.create(),E=c.create();e.ComponentObjectCollection=U,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
