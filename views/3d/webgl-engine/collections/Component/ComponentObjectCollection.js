/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/has","../../../../../core/Logger","../../../../../core/maybe","../../../../../core/PooledArray","../../../../../chunks/mat3","../../../../../chunks/mat3f32","../../../../../chunks/vec3","../../../../../chunks/vec3f64","../../../../../chunks/vec4f32","../../../../../chunks/vec32","../../../../../chunks/vec33","../../../../ViewingMode","../../../layers/i3s/I3SUtil","../../../layers/support/symbolColorUtils","../../../support/orientedBoundingBox","../../../support/buffer/glUtil","../../../support/buffer/InterleavedLayout","./ComponentData","./ComponentObject","./IntersectionGeometry","./Renderable","./RenderGeometry","./RenderSubmitSystem","./SourceGeometry","./Material/ComponentMaterial","./Material/ComponentTechnique","./Material/shader/ComponentData.glsl","../../lib/ComponentUtils","../../lib/Util","../../lib/VertexAttribute","../../lib/verticalOffsetUtils","../../lib/edgeRendering/bufferLayouts","../../lib/edgeRendering/edgeProcessing","../../lib/TextureBackedBuffer/BufferManager","../../../../webgl/BufferObject","../../../../webgl/enums","../../../../webgl/VertexArrayObject"],(function(e,t,n,o,i,r,s,a,c,l,u,m,f,b,p,h,d,g,y,C,v,S,M,O,_,w,x,A,j,D,I,P,L,E,B,V,R,U,T){"use strict";const k=o.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection");let G=function(){function e(e,t){this._renderManager=e,this._viewingMode=t,this._objects=[new r,new r],this._renderSubmit=new _.RenderSubmitSystem(this),this._renderManager.register(this._renderSubmit),this._hasObjectAndLayerId=n("enable-feature:objectAndLayerId-rendering"),this._componentBufferManager=new V.BufferManager(e.rctx,2+(this._hasObjectAndLayerId?1:0))}var o=e.prototype;return o.dispose=function(){I.assert(0===this._objects[v.State.Hidden].length&&0===this._objects[v.State.Visible].length,"ObjectCollection should be empty upon disposal"),this._componentBufferManager.destroy()},o.createObject=function(e){const t=new v.ComponentObject;return t.toMapSpace=e.toMapSpace,t.transform=e.transform,t.obb=d.clone(e.obb),t.components=new C(this._componentBufferManager,e.geometry.componentOffsets),t.renderable=this._createRenderable(e,t.components),t.intersectionGeometry=new S(e.geometry.positionData,t.components),this._objects[t.visible].push(t),t},o.destroyObject=function(e){const t=e;this._objects[t.visible].removeUnordered(t),t.dispose(),this._notifyDirty()},o.setObjectVisibility=function(e,t){const n=e;t!==n.visible&&(this._objects[n.visible].removeUnordered(n),this._objects[t].push(n),n.visible=t,this._notifyDirty())},o.preSubmit=function(e){const t=e.camera.eye;this.visibleObjects.forAll((e=>e.renderable.meta.cameraDepthSquared=c.squaredDistance(t,e.obb.center)))},o.getMaterial=function(e){return e.renderable.material},o.updateMaterial=function(e,t){const n=e.renderable.material;t(n),n.dirty&&this._notifyDirty()},o.setAllComponentVisibilities=function(e,t){const n=e;n.components.visibility.reset(t),n.components.visibilityDirty(),this._notifyDirty()},o.forEachVisibleComponent=function(e,t){return e.components.visibility.forEachComponent(t)},o.getComponentCount=function(e){const t=e,n=t.components.visibility.componentCount();return{visible:n,invisible:t.components.count-n}},o.setComponentData=function(e,t){const n=e,o=n.renderable.material,r=n.components,s=r.materialDataBuffer,a=r.materialDataIndices,c={castShadows:!0,pickable:!0,externalColor:u.create(),externalColorMixMode:h.ColorMixModeEnum.Multiply,elevationOffset:0,objectAndLayerIdColor:this._hasObjectAndLayerId?u.create():null},l=s.textureBuffer,m=new Uint8Array(4),f=new Uint32Array(m.buffer);let b=0,g=0,y=0,C=r.verticalOffsets,v=1/0,S=-1/0,M=!1,O=!1,_=0;for(let u=0;u<r.count;u++){if(t(u,c),b+=+(c.externalColor[3]<1),g+=+(c.externalColorMixMode===h.ColorMixModeEnum.Replace&&1===c.externalColor[3]),y+=+c.castShadows,h.encodeSymbolColor(c.externalColor,c.externalColorMixMode,m),m[2]=254&m[2]|+c.castShadows,l.setData(a[u],0,m[0],m[1],m[2],m[3]),M||(M=u>0&&_!==f[0]),_=f[0],O||(O=0!==c.elevationOffset),O&&i.isNone(C)&&(C=new Array(u).fill(0)),i.isSome(C)&&(C[u]=c.elevationOffset),v=Math.min(v,c.elevationOffset),S=Math.max(S,c.elevationOffset),j.encodeElevationOffset(c.elevationOffset,m),l.setData(a[u],1,m[0],m[1],m[2],m[3]),this._hasObjectAndLayerId){const e=c.objectAndLayerIdColor;l.setData(a[u],2,e[0],e[1],e[2],e[3])}c.pickable!==D.getVisibility(r.pickability,u)&&(r.pickability=D.updateVisibilityWithCount(r.pickability,r.count,u,c.pickable))}r.verticalOffsets=O?C:null,n.offsetObb=O?p.computeOffsetObb(n.obb,v,S,this._viewingMode,i.isSome(n.offsetObb)?n.offsetObb:d.clone(n.obb)):null,M||O||this._hasObjectAndLayerId?(o.componentParameters=new x.ComponentParametersVarying,o.componentParameters.castShadows=q(y,r.count),o.componentParameters.transparent=q(b,r.count),o.componentParameters.opaqueOverride=q(g,r.count),o.componentParameters.texture=l,l.updateTexture()):(o.componentParameters=new x.ComponentParametersUniform,o.componentParameters.castShadows=c.castShadows?x.ComponentParameterSummary.All:x.ComponentParameterSummary.None,o.componentParameters.externalColor=c.externalColor,o.componentParameters.externalColorMixMode=c.externalColorMixMode),this._notifyDirty()},o.getComponentAabb=function(e,t,n,o=!1){e.intersectionGeometry.getComponentAabb(t,n);const r=e,s=r.components.verticalOffsets;if(o||i.isNone(s))return n;const a=s[t];if(this._viewingMode===b.ViewingMode.Local||0===a)return n[2]+=a,n[5]+=a,n;const c=i.unwrap(L.getVerticalOffsetI3S(a));return c.localOrigin=r.transform.position,c.applyToAabb(n)},o.getComponentObb=function(e){return e.obb},o.getObjectTransform=function(e){return e.transform},o.getComponentPositions=function(e,t,n){return e.intersectionGeometry.getComponentPositions(t,n)},o.intersect=function(e,t,n,o,r,a){const l=e;i.isSome(r)&&(r.localOrigin=l.transform.position);const u=s.invert(H,l.transform.rotationScale);c.sub(W,t,l.transform.position),c.sub(z,n,l.transform.position),c.transformMat3(W,W,u),c.transformMat3(z,z,u);const m=s.transpose(H,u);return l.intersectionGeometry.intersect(W,z,o,m,r,l.components.verticalOffsets,a)},o.addEdges=function(e,t,n,o){const i=e,{indices:r,positions:s}=i.intersectionGeometry,a=i.components.offsets;return t.addComponentObject(e,i.transform,{center:i.obb.center,radius:d.radius(i.obb)},s,r,a,n,o)},o.extractEdgeInformation=function(){var e=t._asyncToGenerator((function*(e,t,n){const o=e,i=o.components.visibility;if(i.allInvisible())return{buffer:B.extractComponentsEdgeLocationsLayout.createBuffer(0),origin:[0,0,0]};const{indices:r,positions:s}=o.intersectionGeometry,a=o.components.offsets,c=E.EdgeInputBufferLayout.createBuffer(s.count);f.copy(c.position,s),m.transformMat3(c.position,c.position,o.transform.rotationScale),this._setComponentIndices(c.componentIndex,r,a);const u=c.count,b=this._computeVisibilityIndices(r,i,a,u);return{origin:l.clone(o.transform.position),buffer:yield t.extractComponentsEdgeLocations({indices:b,indicesLength:b.length,skipDeduplicate:!0,data:c,writerSettings:{reducedPrecision:!1,variants:0}},n)}}));function n(t,n,o){return e.apply(this,arguments)}return n}(),o._setComponentIndices=function(e,t,n){let o=0;for(let i=0;i<n.length-1;i++){const r=n[i],s=n[i+1];for(let n=r;n<s;n++){const i=t?t[n]:n;e.set(i,o)}o++}},o._computeVisibilityIndices=function(e,t,n,o){if(e&&t.allVisible())return e;let i=0;t.forEachComponentRange(((e,t)=>(i+=n[t]-n[e],!0)));const r=Array.isArray(e)?new Array(i):2===e?.BYTES_PER_ELEMENT||o<=65536?new Uint16Array(i):new Uint32Array(i);let s=0;return t.forEachComponentRange(((t,o)=>{const i=n[t],a=n[o];for(let n=i;n<a;n++)r[s++]=e?e[n]:n;return!0})),r},o.addComponentHighlight=function(e,t){const n=e.components;i.isNone(n.highlightCounts)&&(n.highlightCounts=new Uint32Array(n.count+1));0===n.highlightCounts[t]++&&(n.highlightsDirty(),this._notifyDirty()),n.highlightCounts[n.count]++},o.removeComponentHighlight=function(e,t){const n=e.components;if(i.isNone(n.highlightCounts))return void k.warn("Removing non-existing highlight.");const o=n.highlightCounts[t],r=n.highlightCounts[n.count];if(0!==o){if(o>1)return n.highlightCounts[t]=o-1,void(n.highlightCounts[n.count]=r-1);n.highlightCounts[t]=0,n.highlightsDirty(),this._notifyDirty(),1===r?n.highlightCounts=null:n.highlightCounts[n.count]=r-1}else k.warn("Removing non-existing highlight.")},o.clearHighlights=function(e){const t=e.components;i.isSome(t.highlightCounts)&&(t.highlightCounts=null,t.highlightsDirty(),this._notifyDirty())},o.getObjectGPUMemoryUsage=function(e){return e.renderable.meta.gpuMemoryEstimate},o._createRenderable=function(e,t){const n=this._renderManager.rctx,o=e.geometry,r=o.vertices.layoutParameters,s=R.BufferObject.createVertex(n,U.Usage.STATIC_DRAW,o.vertices.data),a=i.applySome(o.indices,(e=>R.BufferObject.createIndex(n,U.Usage.STATIC_DRAW,e))),c=g.glLayout(w.createVertexBufferLayout(r)),l=new Uint16Array(o.vertices.count);for(let h=0;h<t.count;h++){const e=t.offsets[h],n=t.offsets[h+1],r=t.materialDataIndices[h];if(i.isSome(o.indices))for(let t=e;t<n;t++){l[o.indices[t]]=r}else for(let t=e;t<n;t++)l[t]=r}const u=R.BufferObject.createVertex(n,U.Usage.STATIC_DRAW,l.buffer),m=new x.ComponentMaterial(e.transform,e.toMapSpace),f=new T.VertexArrayObject(n,A.attributeLocations,{data:c,componentIndices:N},{data:s,componentIndices:u},i.unwrap(a)),b=new O.RenderGeometry(f,U.PrimitiveType.TRIANGLES,r,i.isSome(a)),p={cameraDepthSquared:.5,gpuMemoryEstimate:s.byteSize+u.byteSize+(i.isSome(a)?a.byteSize:0)};return new M.Renderable(m,b,p)},o._notifyDirty=function(){this._renderManager.notifyDirty()},t._createClass(e,[{key:"visibleObjects",get:function(){return this._objects[v.State.Visible]}}]),e}();const N=g.glLayout(y.newLayout().u16(P.VertexAttribute.COMPONENTINDEX));function q(e,t){return e===t?x.ComponentParameterSummary.All:0===e?x.ComponentParameterSummary.None:x.ComponentParameterSummary.Some}const H=a.create(),W=l.create(),z=l.create();e.ComponentObjectCollection=G,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
