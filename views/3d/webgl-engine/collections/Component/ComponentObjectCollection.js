/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/has","../../../../../core/Logger","../../../../../core/maybe","../../../../../core/PooledArray","../../../../../chunks/mat3","../../../../../chunks/mat3f32","../../../../../chunks/vec3","../../../../../chunks/vec3f64","../../../../../chunks/vec32","../../../../../chunks/vec33","../../../../ViewingMode","../../../layers/support/symbolColorUtils","../../../support/orientedBoundingBox","../../../support/buffer/glUtil","../../../support/buffer/InterleavedLayout","./ComponentData","./ComponentObject","./IntersectionGeometry","./Renderable","./RenderGeometry","./RenderSubmitSystem","./SourceGeometry","./UniformComponentParameters","./Material/ComponentMaterial","./Material/ComponentTechnique","./Material/shader/ComponentData.glsl","../../lib/ComponentUtils","../../lib/Util","../../lib/VertexAttribute","../../lib/verticalOffsetUtils","../../lib/edgeRendering/bufferLayouts","../../lib/edgeRendering/edgeProcessing","../../lib/TextureBackedBuffer/BufferManager","../../../../webgl/BufferObject","../../../../webgl/enums","../../../../webgl/VertexArrayObject"],(function(e,t,n,o,i,r,s,a,c,l,u,m,f,b,p,h,g,d,y,C,v,S,O,_,M,w,x,A,j,D,P,I,L,B,E,U,V,R){"use strict";const T=o.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection");let k=function(){function e(e,t){this._renderManager=e,this._viewingMode=t,this._objects=[new r,new r],this._renderSubmit=new O.RenderSubmitSystem(this),this._renderManager.register(this._renderSubmit),this._hasObjectAndLayerId=n("enable-feature:objectAndLayerId-rendering"),this._componentBufferManager=new E.BufferManager(e.rctx,2+(this._hasObjectAndLayerId?1:0))}var o=e.prototype;return o.destroy=function(){D.assert(0===this._objects[y.State.Hidden].length&&0===this._objects[y.State.Visible].length,"ObjectCollection should be empty upon disposal"),this._componentBufferManager.destroy()},o.createObject=function(e){const t=new y.ComponentObject;return t.toMapSpace=e.toMapSpace,t.transform=e.transform,t.obb=p.clone(e.obb),t.components=new d(this._componentBufferManager,e.geometry.componentOffsets),t.renderable=this._createRenderable(e,t.components),t.intersectionGeometry=new C(e.geometry.positionData,t.components),this._objects[t.visible].push(t),t},o.destroyObject=function(e){const t=e;this._objects[t.visible].removeUnordered(t),t.destroy(),this._notifyDirty()},o.setObjectVisibility=function(e,t){const n=e;t!==n.visible&&(this._objects[n.visible].removeUnordered(n),this._objects[t].push(n),n.visible=t,this._notifyDirty())},o.preSubmit=function(e){const t=e.camera.eye;this.visibleObjects.forAll((e=>e.renderable.meta.cameraDepthSquared=c.squaredDistance(t,e.obb.center)))},o.getMaterial=function(e){return e.renderable.material},o.updateMaterial=function(e,t){const n=e.renderable.material;t(n),n.dirty&&this._notifyDirty()},o.setAllComponentVisibilities=function(e,t){const n=e;n.components.visibility.reset(t),n.components.visibilityDirty(),this._notifyDirty()},o.forEachVisibleComponent=function(e,t){return e.components.visibility.forEachComponent(t)},o.getComponentCount=function(e){const t=e,n=t.components.visibility.componentCount();return{visible:n,invisible:t.components.count-n}},o.setComponentData=function(e,t){const n=e,o=n.renderable.material,r=n.components,s=r.materialDataBuffer,a=r.materialDataIndices,c=new M.UniformComponentParameters,l=s.textureBuffer,u=new Uint8Array(4),m=new Uint32Array(u.buffer);let f=0,h=0,g=0,d=r.verticalOffsets,y=1/0,C=-1/0,v=!1,S=!1,O=0;for(let p=0;p<r.count;p++){t(p,c),f+=+(c.externalColor[3]<1),h+=+(c.externalColorMixMode===b.ColorMixModeEnum.Replace&&1===c.externalColor[3]),g+=+c.castShadows,b.encodeSymbolColor(c.externalColor,c.externalColorMixMode,u),u[2]=254&u[2]|+c.castShadows,l.setData(a[p],0,u[0],u[1],u[2],u[3]),v||(v=p>0&&O!==m[0]),O=m[0],S||(S=0!==c.elevationOffset),S&&i.isNone(d)&&(d=new Array(p).fill(0)),i.isSome(d)&&(d[p]=c.elevationOffset),y=Math.min(y,c.elevationOffset),C=Math.max(C,c.elevationOffset),A.encodeElevationOffset(c.elevationOffset,u),l.setData(a[p],1,u[0],u[1],u[2],u[3]);const e=c.objectAndLayerIdColor;i.isSome(e)&&l.setData(a[p],2,e[0],e[1],e[2],e[3]),c.pickable!==j.getVisibility(r.pickability,p)&&(r.pickability=j.updateVisibilityWithCount(r.pickability,r.count,p,c.pickable))}r.verticalOffsets=S?d:null,n.offsetObb=S?p.computeOffsetObb(n.obb,y,C,this._viewingMode,i.isSome(n.offsetObb)?n.offsetObb:p.clone(n.obb)):null,v||S||this._hasObjectAndLayerId?(o.componentParameters=new w.ComponentParametersVarying,o.componentParameters.castShadows=N(g,r.count),o.componentParameters.transparent=N(f,r.count),o.componentParameters.opaqueOverride=N(h,r.count),o.componentParameters.texture=l,l.updateTexture()):(o.componentParameters=new w.ComponentParametersUniform,o.componentParameters.castShadows=c.castShadows?w.ComponentParameterSummary.All:w.ComponentParameterSummary.None,o.componentParameters.externalColor=c.externalColor,o.componentParameters.externalColorMixMode=c.externalColorMixMode),this._notifyDirty()},o.getComponentAabb=function(e,t,n,o=!1){e.intersectionGeometry.getComponentAabb(t,n);const r=e,s=r.components.verticalOffsets;if(o||i.isNone(s))return n;const a=s[t];if(this._viewingMode===f.ViewingMode.Local||0===a)return n[2]+=a,n[5]+=a,n;const c=i.unwrap(I.getVerticalOffsetI3S(a));return c.localOrigin=r.transform.position,c.applyToAabb(n)},o.getComponentObb=function(e){return e.obb},o.getObjectTransform=function(e){return e.transform},o.getComponentPositions=function(e,t,n){return e.intersectionGeometry.getComponentPositions(t,n)},o.intersect=function(e,t,n,o,r,a){const l=e;i.isSome(r)&&(r.localOrigin=l.transform.position);const u=s.invert(q,l.transform.rotationScale);c.sub(H,t,l.transform.position),c.sub(W,n,l.transform.position),c.transformMat3(H,H,u),c.transformMat3(W,W,u);const m=s.transpose(q,u);return l.intersectionGeometry.intersect(H,W,o,m,r,l.components.verticalOffsets,a)},o.addEdges=function(e,t,n,o){const i=e,{indices:r,positions:s}=i.intersectionGeometry,a=i.components.offsets;return t.addComponentObject(e,i.transform,{center:i.obb.center,radius:p.radius(i.obb)},s,r,a,n,o)},o.extractEdgeInformation=function(){var e=t._asyncToGenerator((function*(e,t,n){const o=e,i=o.components.visibility;if(i.allInvisible())return{buffer:B.extractComponentsEdgeLocationsLayout.createBuffer(0),origin:[0,0,0]};const{indices:r,positions:s}=o.intersectionGeometry,a=o.components.offsets,c=L.EdgeInputBufferLayout.createBuffer(s.count);m.copy(c.position,s),u.transformMat3(c.position,c.position,o.transform.rotationScale),this._setComponentIndices(c.componentIndex,r,a);const f=c.count,b=this._computeVisibilityIndices(r,i,a,f);return{origin:l.clone(o.transform.position),buffer:yield t.extractComponentsEdgeLocations({indices:b,indicesLength:b.length,skipDeduplicate:!0,data:c,writerSettings:{reducedPrecision:!1,variants:0}},n)}}));function n(t,n,o){return e.apply(this,arguments)}return n}(),o._setComponentIndices=function(e,t,n){let o=0;for(let i=0;i<n.length-1;i++){const r=n[i],s=n[i+1];for(let n=r;n<s;n++){const i=t?t[n]:n;e.set(i,o)}o++}},o._computeVisibilityIndices=function(e,t,n,o){if(e&&t.allVisible())return e;let i=0;t.forEachComponentRange(((e,t)=>(i+=n[t]-n[e],!0)));const r=Array.isArray(e)?new Array(i):2===e?.BYTES_PER_ELEMENT||o<=65536?new Uint16Array(i):new Uint32Array(i);let s=0;return t.forEachComponentRange(((t,o)=>{const i=n[t],a=n[o];for(let n=i;n<a;n++)r[s++]=e?e[n]:n;return!0})),r},o.addComponentHighlight=function(e,t){const n=e.components;i.isNone(n.highlightCounts)&&(n.highlightCounts=new Uint32Array(n.count+1));0===n.highlightCounts[t]++&&(n.highlightsDirty(),this._notifyDirty()),n.highlightCounts[n.count]++},o.removeComponentHighlight=function(e,t){const n=e.components;if(i.isNone(n.highlightCounts))return void T.warn("Removing non-existing highlight.");const o=n.highlightCounts[t],r=n.highlightCounts[n.count];if(0!==o){if(o>1)return n.highlightCounts[t]=o-1,void(n.highlightCounts[n.count]=r-1);n.highlightCounts[t]=0,n.highlightsDirty(),this._notifyDirty(),1===r?n.highlightCounts=null:n.highlightCounts[n.count]=r-1}else T.warn("Removing non-existing highlight.")},o.clearHighlights=function(e){const t=e.components;i.isSome(t.highlightCounts)&&(t.highlightCounts=null,t.highlightsDirty(),this._notifyDirty())},o.getObjectGPUMemoryUsage=function(e){return e.renderable.meta.gpuMemoryEstimate},o._createRenderable=function(e,t){const n=this._renderManager.rctx,o=e.geometry,r=o.vertices.layoutParameters,s=U.BufferObject.createVertex(n,V.Usage.STATIC_DRAW,o.vertices.data),a=i.applySome(o.indices,(e=>U.BufferObject.createIndex(n,V.Usage.STATIC_DRAW,e))),c=h.glLayout(_.createVertexBufferLayout(r)),l=new Uint16Array(o.vertices.count);for(let h=0;h<t.count;h++){const e=t.offsets[h],n=t.offsets[h+1],r=t.materialDataIndices[h];if(i.isSome(o.indices))for(let t=e;t<n;t++){l[o.indices[t]]=r}else for(let t=e;t<n;t++)l[t]=r}const u=U.BufferObject.createVertex(n,V.Usage.STATIC_DRAW,l.buffer),m=new w.ComponentMaterial(e.transform,e.toMapSpace),f=new R.VertexArrayObject(n,x.attributeLocations,{data:c,componentIndices:G},{data:s,componentIndices:u},i.unwrap(a)),b=new S.RenderGeometry(f,V.PrimitiveType.TRIANGLES,r,i.isSome(a)),p={cameraDepthSquared:.5,gpuMemoryEstimate:s.byteSize+u.byteSize+(i.isSome(a)?a.byteSize:0)};return new v.Renderable(m,b,p)},o._notifyDirty=function(){this._renderManager.notifyDirty()},t._createClass(e,[{key:"visibleObjects",get:function(){return this._objects[y.State.Visible]}}]),e}();const G=h.glLayout(g.newLayout().u16(P.VertexAttribute.COMPONENTINDEX));function N(e,t){return e===t?w.ComponentParameterSummary.All:0===e?w.ComponentParameterSummary.None:w.ComponentParameterSummary.Some}const q=a.create(),H=l.create(),W=l.create();e.ComponentObjectCollection=k,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
