/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/vec3f64","../../../../../geometry/support/aaBoundingBox","../../materials/internal/MaterialUtil"],(function(t,e,n,i,r){"use strict";const s=40,o=20,a=.8,c=15,f=1e-6;function u(t,e,n){const i=e,r=n;let s=0,o=1/0;for(let a=0;a<3;++a){{const e=t[a];if(i[a]<e){if(r[a]<=f)return!1;const t=(e-i[a])/r[a];s=Math.max(s,t)}else if(r[a]<=-f){const t=(e-i[a])/r[a];o=Math.min(o,t)}if(s>o)return!1}{const e=t[a+3];if(i[a]>e){if(r[a]>=-f)return!1;const t=(e-i[a])/r[a];s=Math.max(s,t)}else if(r[a]>=f){const t=(e-i[a])/r[a];o=Math.min(o,t)}if(s>o)return!1}}return!0}let l=function(t,e,n,i,r){this.aabb=t,this.axis=e,this.d=n,this.midStartIndex=i,this.rightStartIndex=r},h=function(){function t(t,e,i,r){this.globalTriangleVertexIndices=t,this.firstTriangleIndex=e,this.positionAttribute=r,this.rayDirection=n.create(),this.bspNodeTree=new Array,this.vertexPositionBuffer=r.data,this.vertexPositionStride=r.stride;const s=i-e,f=s<=I?new Uint16Array(s):new Uint32Array(s);this.indices=f;for(let n=0;n<s;++n)f[n]=n;{const n=b(t,e,i,r.data,r.stride),u=(t,e,i)=>{const r=y(f,n,t,e),s=e-t;if(s<=o){const n=new l(r,void 0,0,t,e);return this.bspNodeTree.push(n),n}const{axis:h,midValue:d}=N(r),m=x(f,n,t,e,h,d),g=(t,e)=>{if(i>c)return;const n=e-t;return n<o||n>=a*s?void 0:u(t,e,i+1)},b=new l(r,h,d,m.next,m.mid);return this.bspNodeTree.push(b),b.leftNode=g(t,m.next),b.rightNode=g(m.mid,e),b};u(0,s,0),this.triangleVertexIndices=p(f,t,e,i)}}var i=t.prototype;return i.intersectRayTriangleRange=function(e,n){{if(e>=n)return;const t=this.triangleVertexIndices,i=this.positionAttribute.data,s=this.positionAttribute.stride,o=this.rayOrigin,a=o[0],c=o[1],f=o[2],u=this.rayDirection,l=u[0],h=u[1],m=u[2];for(let g=e,x=3*e;g<n;++g){const e=t[x]*s,n=i[e],o=i[e+1],u=i[e+2],y=t[x+1]*s,N=i[y],b=i[y+1],p=i[y+2],I=t[x+2]*s,M=i[I],S=i[I+1],T=i[I+2];x+=3;const R=N-n,V=b-o,v=p-u,A=M-n,P=S-o,w=T-u,B=h*w-P*m,D=m*A-w*l,U=l*P-A*h,k=R*B+V*D+v*U;if(Math.abs(k)<=Number.EPSILON)continue;const F=a-n,O=c-o,_=f-u,L=F*B+O*D+_*U;if(k>0){if(L<0||L>k)continue}else if(L>0||L<k)continue;const C=O*v-V*_,j=_*R-v*F,z=F*V-R*O,E=l*C+h*j+m*z;if(k>0){if(E<0||L+E>k)continue}else if(E>0||L+E<k)continue;const H=(A*C+P*j+w*z)/k;if(H>=0){const t=this.indices[g]+this.firstTriangleIndex,e=r.computeNormal(R,V,v,A,P,w,d);this.callback(H,e,t,!1)}}}t.numFacesTested+=n-e},i.intersectRay=function(e,i){t.numFacesTested=0;const r=n.fromValues(e.r0[0],e.r0[1],e.r0[2]),s=n.fromValues(e.r1[0],e.r1[1],e.r1[2]),o=s[0]-r[0],a=s[1]-r[1],c=s[2]-r[2];if(o*o+a*a+c*c<f)return;this.rayOrigin=r;const u=this.rayDirection;u[0]=o,u[1]=a,u[2]=c;const l=this.triangleVertexIndices.length/3;this.callback=i;const h=this.bspNodeTree[0];this.intersectRayBSP(h,0,l)},i.intersectRayBSP=function(t,e,n){const i=this.rayOrigin,r=this.rayDirection;if(!u(t.aabb,i,r))return;const s=t.axis,o=t.d;if(i[s]<o||r[s]<0){const n=e,i=t.midStartIndex;if(n<i){const e=t.leftNode;void 0!==e?this.intersectRayBSP(e,n,i):this.intersectRayTriangleRange(n,i)}}if(this.intersectRayTriangleRange(t.midStartIndex,t.rightStartIndex),i[s]>o||r[s]>0){const e=t.rightStartIndex,i=n;if(e<i){const n=t.rightNode;void 0!==n?this.intersectRayBSP(n,e,i):this.intersectRayTriangleRange(e,i)}}},e._createClass(t,[{key:"estimatedMemoryUsage",get:function(){return this.triangleVertexIndices.byteLength+this.indices.byteLength}}]),t}();h.numFacesTested=0;const d=n.create(),m=[1/0,1/0,1/0],g=[-1/0,-1/0,-1/0];function x(t,e,n,i,r,s){let o=n,a=i;for(;o<a;){const n=t[o];e[6*n+r+3]<=s?++o:(--a,t[o]=t[a],t[a]=n)}let c=o;for(a=i;c<a;){const n=t[a-1];e[6*n+r]>=s?--a:(t[a-1]=t[c],t[c]=n,++c)}return{next:o,mid:c}}function y(t,e,n,r){if(r<=n)return i.fromValues(NaN,NaN,NaN,NaN,NaN,NaN);{const i=6*t[n];for(let t=0;t<3;++t)m[t]=e[i+0+t],g[t]=e[i+3+t]}for(let i=n+1;i<r;++i){const n=6*t[i];for(let t=0;t<3;++t)m[t]=Math.min(m[t],e[n+0+t]),g[t]=Math.max(g[t],e[n+3+t])}return i.fromValues(m[0],m[1],m[2],g[0],g[1],g[2])}function N(t){const e=t[3]-t[0],n=t[4]-t[1],i=t[5]-t[2],r=e>n?e>i?0:n>i?1:2:n>i?1:i>e?2:0;return{axis:r,midValue:(t[r]+t[r+3])/2}}function b(t,e,n,i,r){const s=n-e,o=new Float32Array(6*s);for(let a=0;a<s;++a){const n=3*(a+e),s=t[n+0]*r,c=t[n+1]*r,f=t[n+2]*r;for(let t=0;t<3;++t){const e=i[s+t],n=i[c+t],r=i[f+t];o[6*a+t]=Math.min(e,n,r),o[6*a+3+t]=Math.max(e,n,r)}}return o}function p(t,e,n,i){const r=i-n;let s=0;for(let a=n;a<i;++a)for(let t=0;t<3;++t)s=Math.max(e[3*a+t],s);const o=s<=I?new Uint16Array(3*r):new Uint32Array(3*r);for(let a=0;a<r;++a){const i=3*(t[a]+n);for(let t=0;t<3;++t){const n=e[i+t];o[3*a+t]=n}}return o}const I=65535;t.ComponentIntersectionData=h,t.componentMinimalSizeForIntersectionData=s,Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
