// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../../../core/maybe","../../../../../../core/libs/gl-matrix-2/vec3","../../../../../../core/libs/gl-matrix-2/vec3f32","../../../../../../core/libs/gl-matrix-2/vec4","../../../../../../core/libs/gl-matrix-2/vec4f32","../../../../../../core/libs/gl-matrix-2/vec4f64","./ComponentTechnique","./shader/ComponentShader.glsl","../../../core/material/MaterialBase","../../../core/shaderLibrary/util/AlphaDiscard.glsl"],(function(e,t,r,a,o,i,s,n,l,c,p,u,d){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ComponentParametersVarying=t.ComponentParametersUniform=t.CommonMaterialParameters=t.ComponentMaterial=void 0;var m=function(e){function t(){var t=e.call(this)||this;return t.baseColor=n.vec4f32.fromValues(1,1,1,1),t.usePBR=!1,t.mrrFactors=i.vec3f32.fromValues(1,1,.5),t.emissiveFactor=i.vec3f32.fromValues(0,0,0),t.baseColorTexture=null,t.metallicRoughnessTexture=null,t.emissionTexture=null,t.occlusionTexture=null,t.normalTexture=null,t.overlayTexOffset=l.vec4f64.fromValues(-1,-1,-1,-1),t.overlayTexScale=l.vec4f64.fromValues(0,0,0,0),t.overlayColorInner=null,t.overlayColorOuter=null,t.overlayHighlightInner=null,t.overlayHighlightOuter=null,t.overlayNormalInner=null,t.overlayNormalOuter=null,t.objectOpacity=1,t.commonMaterialParameters=new h,t.componentParameters=new v,t.alphaCutoff=d.defaultMaskAlphaCutoff,t.alphaDiscardMode=1,t.isIntegratedMesh=!1,t.polygonOffsetEnabled=!1,t.sceneHasOcludees=!1,t._techniqueConfig=new c.ComponentTechniqueConfiguration,t}return r.__extends(t,e),t.prototype.dispose=function(e){this._technique&&(e.release(this._technique),this._technique=void 0),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null},t.prototype.getTechnique=function(e,t,r){var o=this._techniqueConfig;if(o.hasVertexColors=r.colors,o.hasNormals=r.normals,o.vertexTextureCoordinates=r.textureCoordinates,o.usePBR=this.usePBR,o.hasMetalnessAndRoughnessTexture=a.isSome(this.metallicRoughnessTexture),o.hasEmissionTexture=a.isSome(this.emissionTexture),o.hasOcclusionTexture=a.isSome(this.occlusionTexture),o.hasNormalTexture=a.isSome(this.normalTexture),o.transparencyPassType=0===t.identifier&&null!=t.transparencyPassType?t.transparencyPassType:3,this.dirty){o.componentData=this.componentParameters.type,o.cullFace=this.commonMaterialParameters.cullFace,o.doubleSidedMode=this.commonMaterialParameters.doubleSided?1:0,o.baseColorTexture=a.isSome(this.baseColorTexture);var i=this._computeWhichMaterialPass();o.blendingEnabled=1===i||2===i,o.alphaDiscardMode=this.alphaDiscardMode,o.integratedMeshMode=this.isIntegratedMesh?this.overlayColorInner||this.overlayColorOuter?this.overlayNormalInner||this.overlayNormalOuter?3:2:1:0,o.polygonOffsetEnabled=this.polygonOffsetEnabled,this._setClean()}return o.slicePlaneEnabled=t.slicePlaneEnabled&&this.commonMaterialParameters.slicePlaneEnabled,1===t.identifier?(o.output=3,o.vertexDiscardMode=0):2===t.identifier?(o.output=4,o.vertexDiscardMode=0):(2===this._computeWhichMaterialPass()?o.vertexDiscardMode=t.transparent?2:1:o.vertexDiscardMode=0,o.output=function(e){switch(e){case 0:return 0;case 1:return 1;case 2:return 2;case 3:return 7}}(t.subPass),0===t.subPass?(o.receiveAmbientOcclusion=t.ambientOcclusionEnabled,o.sceneHasOcludees=t.sceneHasOcludees,o.receiveShadows=t.shadowsEnabled,o.ssrEnabled=t.ssrParams.ssrEnabled):(o.receiveAmbientOcclusion=!1,o.receiveShadows=!1)),this._technique=e.repository.acquireAndReleaseExisting(c.ComponentTechnique,o,this._technique),this._technique},t.prototype.submit=function(e,t){var r=t.renderable.geometry,o=t.components,i=t.renderable.drawParameters,s=t.renderable.meta.cameraDepthSquared,n=o.geometryRanges,l=o.highlightRanges;switch(this._computeWhichMaterialPass()){case 0:e.materialOpaque.submitDraw(this,r,n,i,s);break;case 1:e.materialTransparent.submitDraw(this,r,n,i,s);break;case 2:e.materialOpaque.submitDraw(this,r,n,i,s),e.materialTransparent.submitDraw(this,r,n,i,s);break;case 3:e.materialIntegratedMesh.submitDraw(this,r,n,i,s),(this.overlayHighlightInner||this.overlayHighlightOuter)&&e.highlightIntegratedMesh.submitDraw(this,r,n,i,s)}a.isSome(e.shadowMap)&&2!==this.componentParameters.castShadows&&e.shadowMap.submitDraw(this,r,n,i,s),a.isSome(e.highlight)&&a.isSome(l)&&e.highlight.submitDraw(this,r,l,i,s)},Object.defineProperty(t.prototype,"attributeLocations",{get:function(){return p.attributeLocations},enumerable:!1,configurable:!0}),t.prototype._computeWhichMaterialPass=function(){return this.isIntegratedMesh?3:this.objectOpacity<1?1:0===this.componentParameters.opaqueOverride?0:this.baseColor[3]<1||0===this.alphaDiscardMode||3===this.alphaDiscardMode?1:2===this.componentParameters.transparent?0:0===this.componentParameters.transparent?1:2},r.__decorate([u.parameter({vectorOps:s.vec4})],t.prototype,"baseColor",void 0),r.__decorate([u.parameter()],t.prototype,"usePBR",void 0),r.__decorate([u.parameter({vectorOps:o.vec3})],t.prototype,"mrrFactors",void 0),r.__decorate([u.parameter({vectorOps:o.vec3})],t.prototype,"emissiveFactor",void 0),r.__decorate([u.parameter({dispose:!0})],t.prototype,"baseColorTexture",void 0),r.__decorate([u.parameter({dispose:!0})],t.prototype,"metallicRoughnessTexture",void 0),r.__decorate([u.parameter({dispose:!0})],t.prototype,"emissionTexture",void 0),r.__decorate([u.parameter({dispose:!0})],t.prototype,"occlusionTexture",void 0),r.__decorate([u.parameter({dispose:!0})],t.prototype,"normalTexture",void 0),r.__decorate([u.parameter({vectorOps:{equals:s.vec4.exactEquals,copy:s.vec4.copy}})],t.prototype,"overlayTexOffset",void 0),r.__decorate([u.parameter({vectorOps:{equals:s.vec4.exactEquals,copy:s.vec4.copy}})],t.prototype,"overlayTexScale",void 0),r.__decorate([u.parameter()],t.prototype,"overlayColorInner",void 0),r.__decorate([u.parameter()],t.prototype,"overlayColorOuter",void 0),r.__decorate([u.parameter()],t.prototype,"overlayHighlightInner",void 0),r.__decorate([u.parameter()],t.prototype,"overlayHighlightOuter",void 0),r.__decorate([u.parameter()],t.prototype,"overlayNormalInner",void 0),r.__decorate([u.parameter()],t.prototype,"overlayNormalOuter",void 0),r.__decorate([u.parameter()],t.prototype,"objectOpacity",void 0),r.__decorate([u.parameterBlock()],t.prototype,"commonMaterialParameters",void 0),r.__decorate([u.parameterBlock()],t.prototype,"componentParameters",void 0),r.__decorate([u.parameter()],t.prototype,"alphaCutoff",void 0),r.__decorate([u.parameter()],t.prototype,"alphaDiscardMode",void 0),r.__decorate([u.parameter()],t.prototype,"isIntegratedMesh",void 0),r.__decorate([u.parameter()],t.prototype,"polygonOffsetEnabled",void 0),r.__decorate([u.parameter()],t.prototype,"sceneHasOcludees",void 0),t}(u.MaterialBase);t.ComponentMaterial=m;var h=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.doubleSided=!1,t.cullFace=2,t.slicePlaneEnabled=!0,t}return r.__extends(t,e),r.__decorate([u.parameter()],t.prototype,"doubleSided",void 0),r.__decorate([u.parameter()],t.prototype,"cullFace",void 0),r.__decorate([u.parameter()],t.prototype,"slicePlaneEnabled",void 0),t}(u.MaterialParameterBlock);t.CommonMaterialParameters=h;var v=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.externalColor=n.vec4f32.fromValues(1,1,1,1),t.externalColorMixMode=1,t.castShadows=0,t}return r.__extends(t,e),Object.defineProperty(t.prototype,"transparent",{get:function(){return this.externalColor[3]<1?0:2},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"opaqueOverride",{get:function(){return 3===this.externalColorMixMode&&1===this.externalColor[3]?0:2},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"visible",{get:function(){return this.externalColor[3]>0?0:2},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"type",{get:function(){return 0},enumerable:!1,configurable:!0}),r.__decorate([u.parameter({vectorOps:s.vec4})],t.prototype,"externalColor",void 0),r.__decorate([u.parameter()],t.prototype,"externalColorMixMode",void 0),r.__decorate([u.parameter()],t.prototype,"castShadows",void 0),t}(u.MaterialParameterBlock);t.ComponentParametersUniform=v;var y=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.texture=null,t.transparent=2,t.opaqueOverride=2,t.castShadows=2,t}return r.__extends(t,e),Object.defineProperty(t.prototype,"type",{get:function(){return 1},enumerable:!1,configurable:!0}),r.__decorate([u.parameter()],t.prototype,"texture",void 0),r.__decorate([u.parameter()],t.prototype,"transparent",void 0),r.__decorate([u.parameter()],t.prototype,"opaqueOverride",void 0),r.__decorate([u.parameter()],t.prototype,"castShadows",void 0),t}(u.MaterialParameterBlock);t.ComponentParametersVarying=y}));