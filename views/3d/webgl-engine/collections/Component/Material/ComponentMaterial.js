/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../chunks/tslib.es6","../../../../../../core/maybe","../../../../../../chunks/vec3","../../../../../../chunks/vec3f32","../../../../../../chunks/vec4","../../../../../../chunks/vec4f32","../../../../../../chunks/vec4f64","../../../../layers/support/symbolColorUtils","./ComponentTechnique","./shader/ComponentData.glsl","../../../../../../chunks/ComponentShader.glsl","./shader/VertexDiscardByOpacity.glsl","../../../core/material/MaterialBase","../../../core/renderPasses/AllRenderPasses","../../../core/shaderLibrary/ShaderOutputOptions","../../../core/shaderLibrary/shading/Normals.glsl","../../../core/shaderLibrary/util/AlphaDiscard.glsl","../../../core/shaderLibrary/util/EllipsoidMode","../../../lib/basicInterfaces"],(function(e,a,r,t,o,s,n,i,l,p,d,u,c,m,h,y,v,M,_,b,P){"use strict";let S=function(r){function o(){var e;return(e=r.apply(this,arguments)||this).baseColor=i.fromValues(1,1,1,1),e.usePBR=!1,e.hasParametersFromSource=!1,e.mrrFactors=s.fromValues(1,1,.5),e.emissiveFactor=s.fromValues(0,0,0),e.baseColorTexture=null,e.metallicRoughnessTexture=null,e.emissionTexture=null,e.occlusionTexture=null,e.normalTexture=null,e.overlayTexOffset=l.fromValues(-1,-1,-1,-1),e.overlayTexScale=l.fromValues(0,0,0,0),e.overlayColor=null,e.overlayHighlight=null,e.overlayNormal=null,e.objectOpacity=1,e.commonMaterialParameters=new g,e.componentParameters=new T,e.alphaCutoff=_.defaultMaskAlphaCutoff,e.alphaDiscardMode=P.AlphaDiscardMode.Opaque,e.isIntegratedMesh=!1,e.polygonOffsetEnabled=!1,e.ellipsoidMode=b.EllipsoidMode.Earth,e.sceneHasOcludees=!1,e._techniqueConfig=new d.ComponentTechniqueConfiguration,e}a._inheritsLoose(o,r);var n=o.prototype;return n.dispose=function(){this._technique=t.releaseMaybe(this._technique),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null},n.prepareTechnique=function(e,a,r){const o=this._techniqueConfig;if(o.hasVertexColors=r.colors,o.hasNormals=r.normals,o.vertexTextureCoordinates=r.textureCoordinates,o.usePBR=this.usePBR,o.hasMetalnessAndRoughnessTexture=t.isSome(this.metallicRoughnessTexture),o.hasEmissionTexture=t.isSome(this.emissionTexture),o.hasOcclusionTexture=t.isSome(this.occlusionTexture),o.hasNormalTexture=t.isSome(this.normalTexture),o.transparencyPassType=a.identifier===y.RenderPassIdentifier.Material&&null!=a.transparencyPassType?a.transparencyPassType:P.TransparencyPassType.NONE,o.multipassTerrainEnabled=a.identifier===y.RenderPassIdentifier.Material&&null!=a.multipassTerrainParams&&a.multipassTerrainParams.multipassTerrainEnabled,o.cullAboveGround=a.identifier===y.RenderPassIdentifier.Material&&null!=a.multipassTerrainParams&&a.multipassTerrainParams.cullAboveGround,o.ellipsoidMode=this.ellipsoidMode,this.dirty){o.componentData=this.componentParameters.type,o.cullFace=this.commonMaterialParameters.cullFace,o.doubleSidedMode=this.commonMaterialParameters.doubleSided?M.NormalsDoubleSidedMode.View:M.NormalsDoubleSidedMode.None,o.baseColorTexture=t.isSome(this.baseColorTexture),o.isSchematic=this.hasParametersFromSource&&!t.isSome(this.baseColorTexture);const e=this._computeWhichMaterialPass();o.blendingEnabled=e===f.Transparent||e===f.OpaqueAndTransparent,o.alphaDiscardMode=this.alphaDiscardMode,o.integratedMeshMode=this.isIntegratedMesh?this.overlayColor?this.overlayNormal?d.IntegratedMeshMode.ColorOverlayWithWater:d.IntegratedMeshMode.ColorOverlay:d.IntegratedMeshMode.NoOverlay:d.IntegratedMeshMode.None,o.polygonOffsetEnabled=this.polygonOffsetEnabled,this._setClean()}return o.slicePlaneEnabled=a.slicePlaneEnabled&&this.commonMaterialParameters.slicePlaneEnabled,a.identifier===y.RenderPassIdentifier.ShadowMap?(o.output=v.ShaderOutput.Shadow,o.vertexDiscardMode=m.VertexDiscardMode.None):a.identifier===y.RenderPassIdentifier.Highlight?(o.output=v.ShaderOutput.Highlight,o.vertexDiscardMode=m.VertexDiscardMode.None):(this._computeWhichMaterialPass()===f.OpaqueAndTransparent?o.vertexDiscardMode=a.transparent?m.VertexDiscardMode.Opaque:m.VertexDiscardMode.Transparent:o.vertexDiscardMode=m.VertexDiscardMode.None,o.output=D(a.subPass),a.subPass===y.MaterialSubPass.Alpha&&(o.sceneHasOcludees=a.sceneHasOcludees),a.subPass===y.MaterialSubPass.Color?(o.receiveAmbientOcclusion=a.ambientOcclusionEnabled,o.sceneHasOcludees=a.sceneHasOcludees,o.receiveShadows=a.shadowsEnabled,o.ssrEnabled=a.ssrParams.ssrEnabled):(o.receiveAmbientOcclusion=!1,o.receiveShadows=!1)),this._technique=e.releaseAndAcquire(d.ComponentTechnique,o,this._technique),this._technique},n.submit=function(a,r){if(0===this.objectOpacity)return;const o=r.renderable.geometry,s=r.components,n=r.renderable.drawParameters,i=r.renderable.meta.cameraDepthSquared,l=s.geometryRanges,p=s.highlightRanges,d=s.defaultShadowMapRanges;switch(this._computeWhichMaterialPass()){case f.Opaque:a.materialOpaque.submitDraw(this,o,l,n,i);break;case f.Transparent:a.materialTransparent.submitDraw(this,o,l,n,i);break;case f.OpaqueAndTransparent:a.materialOpaque.submitDraw(this,o,l,n,i),a.materialTransparent.submitDraw(this,o,l,n,i);break;case f.IntegratedMesh:a.materialIntegratedMesh.submitDraw(this,o,l,n,i),this.overlayHighlight&&a.highlightIntegratedMesh.submitDraw(this,o,l,n,i)}const u=this.componentParameters.castShadows!==e.ComponentParameterSummary.None;u&&a.shadowMap.submitDraw(this,o,l,n,i),t.isSome(p)&&(a.highlight.submitDraw(this,o,p,n,i),u&&a.highlightShadowMap.submitDraw(this,o,p,n,i)),u&&t.isSome(d)&&a.defaultShadowMap.submitDraw(this,o,d,n,i)},n._computeWhichMaterialPass=function(){return this.isIntegratedMesh?f.IntegratedMesh:this.objectOpacity<1?f.Transparent:this.componentParameters.opaqueOverride===e.ComponentParameterSummary.All?f.Opaque:this.baseColor[3]<1||this.alphaDiscardMode===P.AlphaDiscardMode.Blend||this.alphaDiscardMode===P.AlphaDiscardMode.MaskBlend?f.Transparent:this.componentParameters.transparent===e.ComponentParameterSummary.None?f.Opaque:this.componentParameters.transparent===e.ComponentParameterSummary.All?f.Transparent:f.OpaqueAndTransparent},a._createClass(o,[{key:"attributeLocations",get:function(){return c.attributeLocations}}]),o}(h.MaterialBase);var C,f;r.__decorate([h.parameter({vectorOps:n.vec4})],S.prototype,"baseColor",void 0),r.__decorate([h.parameter()],S.prototype,"usePBR",void 0),r.__decorate([h.parameter()],S.prototype,"hasParametersFromSource",void 0),r.__decorate([h.parameter({vectorOps:o.vec3})],S.prototype,"mrrFactors",void 0),r.__decorate([h.parameter({vectorOps:o.vec3})],S.prototype,"emissiveFactor",void 0),r.__decorate([h.parameter({dispose:!0})],S.prototype,"baseColorTexture",void 0),r.__decorate([h.parameter({dispose:!0})],S.prototype,"metallicRoughnessTexture",void 0),r.__decorate([h.parameter({dispose:!0})],S.prototype,"emissionTexture",void 0),r.__decorate([h.parameter({dispose:!0})],S.prototype,"occlusionTexture",void 0),r.__decorate([h.parameter({dispose:!0})],S.prototype,"normalTexture",void 0),r.__decorate([h.parameter({vectorOps:{equals:n.exactEquals,copy:n.copy}})],S.prototype,"overlayTexOffset",void 0),r.__decorate([h.parameter({vectorOps:{equals:n.exactEquals,copy:n.copy}})],S.prototype,"overlayTexScale",void 0),r.__decorate([h.parameter()],S.prototype,"overlayColor",void 0),r.__decorate([h.parameter()],S.prototype,"overlayHighlight",void 0),r.__decorate([h.parameter()],S.prototype,"overlayNormal",void 0),r.__decorate([h.parameter()],S.prototype,"objectOpacity",void 0),r.__decorate([h.parameterBlock()],S.prototype,"commonMaterialParameters",void 0),r.__decorate([h.parameterBlock()],S.prototype,"componentParameters",void 0),r.__decorate([h.parameter()],S.prototype,"alphaCutoff",void 0),r.__decorate([h.parameter()],S.prototype,"alphaDiscardMode",void 0),r.__decorate([h.parameter()],S.prototype,"isIntegratedMesh",void 0),r.__decorate([h.parameter()],S.prototype,"polygonOffsetEnabled",void 0),r.__decorate([h.parameter()],S.prototype,"ellipsoidMode",void 0),r.__decorate([h.parameter()],S.prototype,"sceneHasOcludees",void 0),e.ShadingNormalSource=void 0,(C=e.ShadingNormalSource||(e.ShadingNormalSource={}))[C.VERTEX=0]="VERTEX",C[C.GROUND=1]="GROUND",C[C.SCREEN_DERIVATIVE=2]="SCREEN_DERIVATIVE",function(e){e[e.Opaque=0]="Opaque",e[e.Transparent=1]="Transparent",e[e.OpaqueAndTransparent=2]="OpaqueAndTransparent",e[e.IntegratedMesh=3]="IntegratedMesh"}(f||(f={}));let g=function(e){function r(){var a;return(a=e.apply(this,arguments)||this).doubleSided=!1,a.cullFace=P.CullFaceOptions.Back,a.slicePlaneEnabled=!0,a}return a._inheritsLoose(r,e),r}(h.MaterialParameterBlock);r.__decorate([h.parameter()],g.prototype,"doubleSided",void 0),r.__decorate([h.parameter()],g.prototype,"cullFace",void 0),r.__decorate([h.parameter()],g.prototype,"slicePlaneEnabled",void 0);let T=function(r){function t(){var a;return(a=r.apply(this,arguments)||this).externalColor=i.fromValues(1,1,1,1),a.externalColorMixMode=p.ColorMixModeEnum.Multiply,a.castShadows=e.ComponentParameterSummary.All,a}return a._inheritsLoose(t,r),a._createClass(t,[{key:"transparent",get:function(){return this.externalColor[3]<1?e.ComponentParameterSummary.All:e.ComponentParameterSummary.None}},{key:"opaqueOverride",get:function(){return this.externalColorMixMode===p.ColorMixModeEnum.Replace&&1===this.externalColor[3]?e.ComponentParameterSummary.All:e.ComponentParameterSummary.None}},{key:"visible",get:function(){return this.externalColor[3]>0?e.ComponentParameterSummary.All:e.ComponentParameterSummary.None}},{key:"type",get:function(){return u.ComponentDataType.Uniform}}]),t}(h.MaterialParameterBlock);var x;r.__decorate([h.parameter({vectorOps:n.vec4})],T.prototype,"externalColor",void 0),r.__decorate([h.parameter()],T.prototype,"externalColorMixMode",void 0),r.__decorate([h.parameter()],T.prototype,"castShadows",void 0),e.ComponentParameterSummary=void 0,(x=e.ComponentParameterSummary||(e.ComponentParameterSummary={}))[x.All=0]="All",x[x.Some=1]="Some",x[x.None=2]="None";let O=function(r){function t(){var a;return(a=r.apply(this,arguments)||this).texture=null,a.transparent=e.ComponentParameterSummary.None,a.opaqueOverride=e.ComponentParameterSummary.None,a.castShadows=e.ComponentParameterSummary.None,a}return a._inheritsLoose(t,r),a._createClass(t,[{key:"type",get:function(){return u.ComponentDataType.Varying}}]),t}(h.MaterialParameterBlock);function D(e){switch(e){case y.MaterialSubPass.Color:return v.ShaderOutput.Color;case y.MaterialSubPass.Alpha:return v.ShaderOutput.Alpha;case y.MaterialSubPass.Depth:return v.ShaderOutput.Depth;case y.MaterialSubPass.Normal:return v.ShaderOutput.Normal}}r.__decorate([h.parameter()],O.prototype,"texture",void 0),r.__decorate([h.parameter()],O.prototype,"transparent",void 0),r.__decorate([h.parameter()],O.prototype,"opaqueOverride",void 0),r.__decorate([h.parameter()],O.prototype,"castShadows",void 0),e.CommonMaterialParameters=g,e.ComponentMaterial=S,e.ComponentParametersUniform=T,e.ComponentParametersVarying=O,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
