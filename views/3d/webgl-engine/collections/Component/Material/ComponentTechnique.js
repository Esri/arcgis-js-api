/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["require","exports","../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../chunks/tslib.es6","../../../../../../core/maybe","../../../../../../chunks/mat3f64","../../../../../../chunks/vec4f64","../../../../../../chunks/ComponentShader.glsl","../../../core/shaderLibrary/Slice.glsl","../../../core/shaderLibrary/attributes/VertexPosition.glsl","../../../core/shaderLibrary/output/OutputHighlight.glsl","../../../core/shaderLibrary/shading/PhysicallyBasedRenderingParameters.glsl","../../../core/shaderLibrary/shading/ScreenSpaceReflections.glsl","../../../core/shaderLibrary/util/DoublePrecision.glsl","../../../core/shaderTechnique/ReloadableShaderModule","../../../core/shaderTechnique/ShaderTechnique","../../../core/shaderTechnique/ShaderTechniqueConfiguration","../../../lib/OrderIndependentTransparency","../../../lib/Program","../../../lib/StencilUtils","../../../../../webgl/renderState"],(function(e,r,t,o,a,i,s,n,l,d,c,u,p,m,h,b,f,T,x,g,v){"use strict";let _=function(e){function r(){return e.apply(this,arguments)||this}t._inheritsLoose(r,e);var o=r.prototype;return o.bindPass=function(e){const r=this.program;d.VertexPosition.bindViewProjTransform(r,e.viewTransform),l.bindSliceUniforms(this.program,this.configuration,e.slicePlane),0===e.identifier&&(void 0!==e.ssrParams&&p.bindSSRUniforms(this.program,e.ssrParams),r.setUniformMatrix3fv("uTransformNormal_ViewFromGlobal",e.transformNormal_ViewFromGlobal),2===e.subPass&&r.setUniform2fv("cameraNearFar",e.cameraNearFar),0===e.subPass&&e.lighting.setUniforms(this.program,e.integratedMesh)),1===e.identifier&&this.program.setUniform2fv("cameraNearFar",e.cameraNearFar)},o.bindMaterial=function(e,r){this._material=e;const t=this.program;t.setUniform4fv("uBaseColor",e.baseColor),t.setUniform1f("uObjectOpacity",e.objectOpacity),t.setUniform1f("textureAlphaCutoff",e.alphaCutoff),1===e.componentParameters.type?e.componentParameters.texture.bind(t,"uComponentColorTex","uComponentColorTexInvDim"):(t.setUniform4fv("uExternalColor",e.componentParameters.externalColor),t.setUniform1i("uExternalColorMixMode",e.componentParameters.externalColorMixMode)),a.isSome(e.baseColorTexture)&&e.baseColorTexture.bind(t,"uBaseColorTexture","uBaseColorTextureSize"),0!==this.configuration.output&&7!==this.configuration.output||(u.bindPBRUniforms(this.program,e,this.configuration.isSchematic),a.isSome(e.metallicRoughnessTexture)&&e.metallicRoughnessTexture.bind(t,"texMetallicRoughness","texMetallicRoughnessSize"),a.isSome(e.emissionTexture)&&e.emissionTexture.bind(t,"texEmission","texEmissionSize"),a.isSome(e.occlusionTexture)&&e.occlusionTexture.bind(t,"texOcclusion","texOcclusionSize"),a.isSome(e.normalTexture)&&e.normalTexture.bind(t,"normalTexture","normalTextureSize")),e.isIntegratedMesh&&(0===r.identifier&&0===r.subPass?(t.bindTexture(e.overlayColor,"ovColorTex"),t.bindTexture(e.overlayNormal,"ovNormalTex")):2===r.identifier&&t.bindTexture(e.overlayHighlight,"ovColorTex"),t.setUniform1f("overlayOpacity",1)),2===r.identifier&&c.bindOutputHighlight(this.program,r),0===r.identifier&&0===r.subPass&&(r.ambientOcclusionEnabled&&r.bindAmbientOcclusion(t),r.shadowsEnabled&&r.bindShadowMap(t)),0!==r.identifier||0!==r.subPass&&1!==r.subPass||!r.multipassTerrainParams.multipassTerrainEnabled||(this.program.setUniform2fv("cameraNearFar",r.cameraNearFar),t.setUniform2fv("inverseViewport",r.inverseViewport),r.multipassTerrainParams.terrainLinearDepthTexture&&t.bindTexture(r.multipassTerrainParams.terrainLinearDepthTexture,"terrainDepthTexture"))},o.bindDraw=function(e){if(d.VertexPosition.bindModelTransform(this.program,e),this.program.setUniformMatrix3fv("uTransformNormal_GlobalFromModel",e.transformNormal_GlobalFromModel),this.program.rebindTextures(),a.isSome(this._material)&&this._material.isIntegratedMesh){const r=this._material.overlayTexScale,t=this._material.overlayTexOffset;this.program.setUniform4fv("overlayTexOffset",[e.toMapSpace[0]*r[0]+t[0],e.toMapSpace[1]*r[1]+t[1],e.toMapSpace[0]*r[2]+t[2],e.toMapSpace[1]*r[3]+t[3]]),this.program.setUniform4fv("overlayTexScale",[e.toMapSpace[2]*r[0],e.toMapSpace[3]*r[1],e.toMapSpace[2]*r[2],e.toMapSpace[3]*r[3]])}},o.initializeProgram=function(e){const t=r.shader.get(),o=this.configuration,a=t.build({multipassTerrainEnabled:o.multipassTerrainEnabled,cullAboveGround:o.cullAboveGround,OITEnabled:0===o.transparencyPassType,output:o.output,normalType:0===o.integratedMeshMode?o.hasNormals?1:3:2,attributeColor:o.hasVertexColors,attributeTextureCoordinates:o.vertexTextureCoordinates,componentData:o.componentData,alphaDiscardMode:o.alphaDiscardMode,baseColorTexture:o.baseColorTexture,doubleSidedMode:o.doubleSidedMode,receiveAmbientOcclusion:o.receiveAmbientOcclusion,receiveShadows:o.receiveShadows,slicePlaneEnabled:o.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,viewingMode:e.viewingMode,vertexDiscardMode:o.vertexDiscardMode,pbrMode:3===o.integratedMeshMode?4:o.usePBR?o.isSchematic?2:1:0,hasMetalnessAndRoughnessTexture:o.hasMetalnessAndRoughnessTexture,hasEmissionTexture:o.hasEmissionTexture,hasOcclusionTexture:o.hasOcclusionTexture,hasNormalTexture:o.hasNormalTexture,vertexTangents:!1,supportsTextureAtlas:!0,doublePrecisionRequiresObfuscation:m.doublePrecisionRequiresObfuscation(e.rctx),overlayEnabled:2===o.integratedMeshMode||3===o.integratedMeshMode,ssrEnabled:o.ssrEnabled,highStepCount:!1,ellipsoidMode:o.ellipsoidMode});return new x.Program(e.rctx,a,t.attributeLocations)},o.setPipelineState=function(e){const r=this.configuration,t=0!==r.integratedMeshMode,o=3===e,a=2===e;return v.makePipelineState({blending:0!==r.output&&7!==r.output||!r.blendingEnabled?null:o?T.blendingDefault:T.OITBlending(e),culling:v.cullingParams(r.cullFace),depthTest:{func:T.OITDepthTest(e)},depthWrite:o||a?v.defaultDepthWriteParams:null,colorWrite:v.defaultColorWriteParams,stencilWrite:t||r.sceneHasOcludees?g.stencilWriteMaskOn:null,stencilTest:t?g.replaceBitWhenDepthTestPasses(1):r.sceneHasOcludees?g.stencilBaseAllZerosParams:null,polygonOffset:o||a?r.polygonOffsetEnabled?{factor:2,units:2}:null:T.OITPolygonOffset})},o.initializePipeline=function(){return this.setPipelineState(this.configuration.transparencyPassType)},r}(b.ShaderTechnique);_.shader=new h.ReloadableShaderModule(n.ComponentShader,(()=>new Promise(((r,t)=>e(["./shader/ComponentShader.glsl"],r,t)))));let y=function(e){function r(){var r;return(r=e.apply(this,arguments)||this).transformNormal_GlobalFromModel=i.create(),r.toMapSpace=s.create(),r}return t._inheritsLoose(r,e),r}(d.VertexPosition.ModelTransform),M=function(e){function r(){var r;return(r=e.apply(this,arguments)||this).output=0,r.hasVertexColors=!1,r.hasNormals=!1,r.vertexTextureCoordinates=0,r.componentData=0,r.slicePlaneEnabled=!1,r.cullFace=2,r.baseColorTexture=!1,r.receiveAmbientOcclusion=!0,r.receiveShadows=!0,r.vertexDiscardMode=0,r.doubleSidedMode=2,r.blendingEnabled=!0,r.alphaDiscardMode=1,r.integratedMeshMode=0,r.ssrEnabled=!1,r.polygonOffsetEnabled=!1,r.usePBR=!1,r.isSchematic=!1,r.hasMetalnessAndRoughnessTexture=!1,r.hasEmissionTexture=!1,r.hasOcclusionTexture=!1,r.hasNormalTexture=!1,r.sceneHasOcludees=!1,r.transparencyPassType=3,r.ellipsoidMode=1,r.multipassTerrainEnabled=!1,r.cullAboveGround=!1,r}return t._inheritsLoose(r,e),r}(f.ShaderTechniqueConfiguration);o.__decorate([f.parameter({count:8})],M.prototype,"output",void 0),o.__decorate([f.parameter()],M.prototype,"hasVertexColors",void 0),o.__decorate([f.parameter()],M.prototype,"hasNormals",void 0),o.__decorate([f.parameter({count:3})],M.prototype,"vertexTextureCoordinates",void 0),o.__decorate([f.parameter({count:2})],M.prototype,"componentData",void 0),o.__decorate([f.parameter()],M.prototype,"slicePlaneEnabled",void 0),o.__decorate([f.parameter({count:3})],M.prototype,"cullFace",void 0),o.__decorate([f.parameter()],M.prototype,"baseColorTexture",void 0),o.__decorate([f.parameter()],M.prototype,"receiveAmbientOcclusion",void 0),o.__decorate([f.parameter()],M.prototype,"receiveShadows",void 0),o.__decorate([f.parameter({count:3})],M.prototype,"vertexDiscardMode",void 0),o.__decorate([f.parameter({count:3})],M.prototype,"doubleSidedMode",void 0),o.__decorate([f.parameter()],M.prototype,"blendingEnabled",void 0),o.__decorate([f.parameter({count:4})],M.prototype,"alphaDiscardMode",void 0),o.__decorate([f.parameter({count:4})],M.prototype,"integratedMeshMode",void 0),o.__decorate([f.parameter()],M.prototype,"ssrEnabled",void 0),o.__decorate([f.parameter()],M.prototype,"polygonOffsetEnabled",void 0),o.__decorate([f.parameter()],M.prototype,"usePBR",void 0),o.__decorate([f.parameter()],M.prototype,"isSchematic",void 0),o.__decorate([f.parameter()],M.prototype,"hasMetalnessAndRoughnessTexture",void 0),o.__decorate([f.parameter()],M.prototype,"hasEmissionTexture",void 0),o.__decorate([f.parameter()],M.prototype,"hasOcclusionTexture",void 0),o.__decorate([f.parameter()],M.prototype,"hasNormalTexture",void 0),o.__decorate([f.parameter()],M.prototype,"sceneHasOcludees",void 0),o.__decorate([f.parameter({count:4})],M.prototype,"transparencyPassType",void 0),o.__decorate([f.parameter({count:4})],M.prototype,"ellipsoidMode",void 0),o.__decorate([f.parameter()],M.prototype,"multipassTerrainEnabled",void 0),o.__decorate([f.parameter()],M.prototype,"cullAboveGround",void 0),r.ComponentDrawParameters=y,r.ComponentTechnique=_,r.ComponentTechniqueConfiguration=M,Object.defineProperty(r,"__esModule",{value:!0})}));
