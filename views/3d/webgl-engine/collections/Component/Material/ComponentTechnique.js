// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../../../core/maybe","../../../../../../core/libs/gl-matrix-2/mat3f64","../../../../../../core/libs/gl-matrix-2/vec4f64","./shader/ComponentShader.glsl","../../../core/shaderLibrary/Slice.glsl","../../../core/shaderLibrary/attributes/VertexPosition.glsl","../../../core/shaderLibrary/output/OutputHighlight.glsl","../../../core/shaderLibrary/shading/PhysicallyBasedRenderingParameters.glsl","../../../core/shaderLibrary/shading/ScreenSpaceReflections.glsl","../../../core/shaderLibrary/util/DoublePrecision.glsl","../../../core/shaderTechnique/ReloadableShaderModule","../../../core/shaderTechnique/ShaderTechnique","../../../core/shaderTechnique/ShaderTechniqueConfiguration","../../../lib/StencilUtils","../../../../../webgl/Program","../../../../../webgl/renderState","../../../../../webgl/renderState","@dojo/framework/shim/Promise"],(function(e,t,r,o,a,i,n,s,l,u,p,c,d,m,h,f,x,b,T,O){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ComponentTechniqueConfiguration=t.ComponentDrawParameters=t.ComponentTechnique=t.TextureUnits=void 0,t.TextureUnits={DIFFUSE:0,COMPONENT_COLOR:1,NORMAL:2,EMISSION:3,OCCLUSION:4,METALLIC_ROUGHNESS:5,OVERLAY0_COLOR:2,OVERLAY1_COLOR:3,OVERLAY0_NORMAL:4,OVERLAY1_NORMAL:5,SSAO:6,SHADOW_MAP:7,PREPASS_LINEAR_DEPTH:8,LAST_FRAME_COLOR:9};var g=function(a){function i(){return null!==a&&a.apply(this,arguments)||this}return r.__extends(i,a),i.prototype.bindPass=function(e,r){var o=this.program;l.VertexPosition.bindViewProjTransform(o,r.viewTransform),s.Slice.bindUniforms(this.program,this.configuration,r.slicePlane),0===r.identifier&&void 0!==r.ssrParams&&(r.ssrParams.lastFrameColorTextureID=t.TextureUnits.LAST_FRAME_COLOR,r.ssrParams.linearDepthTextureID=t.TextureUnits.PREPASS_LINEAR_DEPTH,c.ScreenSpaceReflections.bindUniforms(this.program,e,r.ssrParams)),0===r.identifier&&(o.setUniformMatrix3fv("uTransformNormal_ViewFromGlobal",r.transformNormal_ViewFromGlobal),1===r.subPass&&o.setUniform2fv("uCameraNearFar",r.cameraNearFar),0===r.subPass&&(r.ambientOcclusionEnabled&&r.ambientOcclusion.bind(o,t.TextureUnits.SSAO),r.shadowsEnabled&&r.shadowMap.bind(o,t.TextureUnits.SHADOW_MAP),r.lighting.setUniforms(this.program,r.integratedMesh))),1===r.identifier&&this.program.setUniform2fv("uCameraNearFar",r.cameraNearFar),2===r.identifier&&u.OutputHighlight.bindOutputHighlight(e,this.program,r)},i.prototype.bindDraw=function(e,t){if(l.VertexPosition.bindModelTransform(this.program,e),this.program.setUniformMatrix3fv("uTransformNormal_GlobalFromModel",e.transformNormal_GlobalFromModel),t.isIntegratedMesh){var r=t.overlayTexScale,o=t.overlayTexOffset;this.program.setUniform4fv("overlayTexOffset",[e.toMapSpace[0]*r[0]+o[0],e.toMapSpace[1]*r[1]+o[1],e.toMapSpace[0]*r[2]+o[2],e.toMapSpace[1]*r[3]+o[3]]),this.program.setUniform4fv("overlayTexScale",[e.toMapSpace[2]*r[0],e.toMapSpace[3]*r[1],e.toMapSpace[2]*r[2],e.toMapSpace[3]*r[3]])}},i.prototype.bindMaterial=function(e,r,a){var i=this.program;i.setUniform4fv("uBaseColor",r.baseColor),i.setUniform1f("uObjectOpacity",r.objectOpacity),i.setUniform1f("textureAlphaCutoff",r.alphaCutoff),1===r.componentParameters.type?r.componentParameters.texture.bind(i,{texName:"uComponentColorTex",invDimName:"uComponentColorTexInvDim",unit:t.TextureUnits.COMPONENT_COLOR}):(i.setUniform4fv("uExternalColor",r.componentParameters.externalColor),i.setUniform1i("uExternalColorMixMode",r.componentParameters.externalColorMixMode)),o.isSome(r.baseColorTexture)&&r.baseColorTexture.bind(e,i,"uBaseColorTexture",t.TextureUnits.DIFFUSE,"uBaseColorTextureSize"),0===this.configuration.output&&(p.PhysicallyBasedRenderingParameters.bindUniforms(this.program,r),o.isSome(r.metallicRoughnessTexture)&&r.metallicRoughnessTexture.bind(e,i,"texMetallicRoughness",t.TextureUnits.METALLIC_ROUGHNESS,"texMetallicRoughnessSize"),o.isSome(r.emissionTexture)&&r.emissionTexture.bind(e,i,"texEmission",t.TextureUnits.EMISSION,"texEmissionSize"),o.isSome(r.occlusionTexture)&&r.occlusionTexture.bind(e,i,"texOcclusion",t.TextureUnits.OCCLUSION,"texOcclusionSize"),o.isSome(r.normalTexture)&&r.normalTexture.bind(e,i,"normalTexture",t.TextureUnits.NORMAL,"normalTextureSize")),r.isIntegratedMesh&&(0===a.identifier&&0===a.subPass?(e.bindTexture(o.unwrap(r.overlayColorInner),t.TextureUnits.OVERLAY0_COLOR),e.bindTexture(o.unwrap(r.overlayColorOuter),t.TextureUnits.OVERLAY1_COLOR),e.bindTexture(o.unwrap(r.overlayNormalInner),t.TextureUnits.OVERLAY0_NORMAL),e.bindTexture(o.unwrap(r.overlayNormalOuter),t.TextureUnits.OVERLAY1_NORMAL),i.setUniform1i("ovInnerNormalTex",t.TextureUnits.OVERLAY0_NORMAL),i.setUniform1i("ovOuterNormalTex",t.TextureUnits.OVERLAY1_NORMAL)):2===a.identifier&&(e.bindTexture(o.unwrap(r.overlayHighlightInner),t.TextureUnits.OVERLAY0_COLOR),e.bindTexture(o.unwrap(r.overlayHighlightOuter),t.TextureUnits.OVERLAY1_COLOR)),i.setUniform1i("ovInnerColorTex",t.TextureUnits.OVERLAY0_COLOR),i.setUniform1i("ovOuterColorTex",t.TextureUnits.OVERLAY1_COLOR),i.setUniform1f("overlayOpacity",1))},i.prototype.initializeProgram=function(e){var t=i.shader.get(),r=this.configuration,o=t.build({OITEnabled:0===this.configuration.transparencyPassType||1===this.configuration.transparencyPassType,alphaPass:1===r.transparencyPassType,output:r.output,normalType:0===r.integratedMeshMode?r.hasNormals?1:3:2,attributeColor:r.hasVertexColors,attributeTextureCoordinates:r.vertexTextureCoordinates,componentData:r.componentData,alphaDiscardMode:r.alphaDiscardMode,baseColorTexture:r.baseColorTexture,doubleSidedMode:r.doubleSidedMode,receiveAmbientOcclusion:r.receiveAmbientOcclusion,receiveShadows:r.receiveShadows,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,viewingMode:e.viewingMode,vertexDiscardMode:r.vertexDiscardMode,pbrMode:3===r.integratedMeshMode?4:r.usePBR?1:0,hasMetalnessAndRoughnessTexture:r.hasMetalnessAndRoughnessTexture,hasEmissionTexture:r.hasEmissionTexture,hasOcclusionTexture:r.hasOcclusionTexture,hasNormalTexture:r.hasNormalTexture,vertexTangets:!1,useOldSceneLightInterface:!1,supportsTextureAtlas:!0,doublePrecisionRequiresObfuscation:d.doublePrecisionRequiresObfuscation(e.rctx),overlayEnabled:2===r.integratedMeshMode||3===r.integratedMeshMode,ssrEnabled:r.ssrEnabled,highStepCount:!1});return new b(e.rctx,o.generateSource("vertex"),o.generateSource("fragment"),t.attributeLocations)},Object.defineProperty(i.prototype,"pipeline",{get:function(){switch(this.configuration.transparencyPassType){case 0:return this.colorPipelineState;case 1:return this.alphaPipelineState;case 2:return this.frontFacePipelineState;default:return this.defaultPipelineState}},enumerable:!1,configurable:!0}),i.prototype.pipelineState=function(e){var t,r,o,a,i=this.configuration,n=0!==i.integratedMeshMode;return 3===e?(a=_,t=513,r=O.defaultDepthWriteParams,o=i.polygonOffsetEnabled?{factor:2,units:2}:null):(a=2!==e?1===e?P:S:null,t=2===e?513:515,r=2===e?O.defaultDepthWriteParams:null,o=2!==e?{factor:-1,units:-2}:null),O.makePipelineState({blending:0===i.output&&i.blendingEnabled?a:null,culling:y[i.cullFace],depthTest:{func:t},depthWrite:r,colorWrite:O.defaultColorWriteParams,stencilWrite:n||i.sceneHasOcludees?x.stencilWriteMaskOn:null,stencilTest:n?x.replaceBitWhenDepthTestPasses(1):i.sceneHasOcludees?x.stencilBaseAllZerosParams:null,polygonOffset:o})},i.prototype.initializePipeline=function(){return this._colorPipelineState=this.pipelineState(0),this._alphaPipelineState=this.pipelineState(1),this._frontFacePipelineState=this.pipelineState(2),this._defaultPipelineState=this.pipelineState(3),this._defaultPipelineState},Object.defineProperty(i.prototype,"defaultPipelineState",{get:function(){return this._defaultPipelineState},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"colorPipelineState",{get:function(){return this._colorPipelineState},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"alphaPipelineState",{get:function(){return this._alphaPipelineState},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"frontFacePipelineState",{get:function(){return this._frontFacePipelineState},enumerable:!1,configurable:!0}),i.shader=new m.ReloadableShaderModule(n,(function(){return new Promise((function(t,r){e(["./shader/ComponentShader.glsl"],t,r)}))})),i}(h.ShaderTechnique);t.ComponentTechnique=g;var _=T.separateBlendingParams(770,1,771,771),S=O.simpleBlendingParams(1,1),P=O.simpleBlendingParams(0,771),y=[];y[0]=null,y[2]={face:1029,mode:2305},y[1]={face:1028,mode:2305};var v=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.transformNormal_GlobalFromModel=a.mat3f64.create(),t.toMapSpace=i.vec4f64.create(),t}return r.__extends(t,e),t}(l.VertexPosition.ModelTransform);t.ComponentDrawParameters=v;var M=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.output=0,t.hasVertexColors=!1,t.hasNormals=!1,t.vertexTextureCoordinates=0,t.componentData=0,t.slicePlaneEnabled=!1,t.cullFace=2,t.baseColorTexture=!1,t.receiveAmbientOcclusion=!0,t.receiveShadows=!0,t.vertexDiscardMode=0,t.doubleSidedMode=2,t.blendingEnabled=!0,t.alphaDiscardMode=1,t.integratedMeshMode=0,t.ssrEnabled=!1,t.polygonOffsetEnabled=!1,t.usePBR=!1,t.hasMetalnessAndRoughnessTexture=!1,t.hasEmissionTexture=!1,t.hasOcclusionTexture=!1,t.hasNormalTexture=!1,t.sceneHasOcludees=!1,t.transparencyPassType=3,t}return r.__extends(t,e),r.__decorate([f.parameter({count:7})],t.prototype,"output",void 0),r.__decorate([f.parameter()],t.prototype,"hasVertexColors",void 0),r.__decorate([f.parameter()],t.prototype,"hasNormals",void 0),r.__decorate([f.parameter({count:3})],t.prototype,"vertexTextureCoordinates",void 0),r.__decorate([f.parameter({count:2})],t.prototype,"componentData",void 0),r.__decorate([f.parameter()],t.prototype,"slicePlaneEnabled",void 0),r.__decorate([f.parameter({count:3})],t.prototype,"cullFace",void 0),r.__decorate([f.parameter()],t.prototype,"baseColorTexture",void 0),r.__decorate([f.parameter()],t.prototype,"receiveAmbientOcclusion",void 0),r.__decorate([f.parameter()],t.prototype,"receiveShadows",void 0),r.__decorate([f.parameter({count:3})],t.prototype,"vertexDiscardMode",void 0),r.__decorate([f.parameter({count:3})],t.prototype,"doubleSidedMode",void 0),r.__decorate([f.parameter()],t.prototype,"blendingEnabled",void 0),r.__decorate([f.parameter({count:4})],t.prototype,"alphaDiscardMode",void 0),r.__decorate([f.parameter({count:4})],t.prototype,"integratedMeshMode",void 0),r.__decorate([f.parameter()],t.prototype,"ssrEnabled",void 0),r.__decorate([f.parameter()],t.prototype,"polygonOffsetEnabled",void 0),r.__decorate([f.parameter()],t.prototype,"usePBR",void 0),r.__decorate([f.parameter()],t.prototype,"hasMetalnessAndRoughnessTexture",void 0),r.__decorate([f.parameter()],t.prototype,"hasEmissionTexture",void 0),r.__decorate([f.parameter()],t.prototype,"hasOcclusionTexture",void 0),r.__decorate([f.parameter()],t.prototype,"hasNormalTexture",void 0),r.__decorate([f.parameter()],t.prototype,"sceneHasOcludees",void 0),r.__decorate([f.parameter({count:4})],t.prototype,"transparencyPassType",void 0),t}(f.ShaderTechniqueConfiguration);t.ComponentTechniqueConfiguration=M}));