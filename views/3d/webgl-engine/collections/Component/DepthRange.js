/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../../core/PooledArray","../../../../../chunks/vec3f64","../../../../../chunks/vec3","../../../../../chunks/mat3f64","../../../../../chunks/quatf64","../../../../../chunks/mat3","../../../../../chunks/quat","../../../../../chunks/plane","../../../support/orientedBoundingBox","../../lib/depthRange"],(function(e,t,n,a,o,r,c,s,u,i,l){"use strict";const f=new t({allocator:e=>e||{near:1/0,far:-1/0,mask:0,object:null},deallocator:e=>(e.object=null,e)}),h=l.empty(),d=n.create(),p=n.create(),g=new t({deallocator:null}),b=new t({deallocator:null});function m(e,t,n){n.length=0;const o=t.length-3;w(d,t,o);const r=u.signedDistance(e,d);r<=0&&(n.push(d[0]),n.push(d[1]),n.push(d[2]));let c=0,s=r;for(;c<o;c+=3){w(p,t,c);const o=u.signedDistance(e,p);if(s*o<0){const e=o/(o-s);a.lerp(d,p,d,e),k(n,d)}o<=0&&k(n,p),s=o,a.copy(d,p)}if(s*r<0){w(p,t,o);const e=r/(r-s);a.lerp(d,p,d,e),k(n,d)}}function w(e,t,n){return a.set(e,t.data[n+0],t.data[n+1],t.data[n+2])}function k(e,t){e.push(t[0]),e.push(t[1]),e.push(t[2])}function j(e,t,n,o){s.conjugate(v,e.quaternion),a.sub(D,t,e.center),a.transformQuat(D,D,v);const r=8*((D[0]<-e.halfSize[0]?-1:D[0]>e.halfSize[0]?1:0)+3*(D[1]<-e.halfSize[1]?-1:D[1]>e.halfSize[1]?1:0)+9*(D[2]<-e.halfSize[2]?-1:D[2]>e.halfSize[2]?1:0)+13),u=y[r];if(0===u)return u;c.fromQuat(q,e.quaternion),c.scale(q,q,e.halfSize);const i=(t,n)=>{const o=y[r+n+1];return a.set(t,((1&o)<<1)-1,(2&o)-1,((4&o)>>1)-1),a.transformMat3(t,t,q),a.add(t,e.center,t)};return n.length=0,k(n,i(M,0)),k(n,i(P,1)),k(n,i(D,2)),k(n,i(R,3)),o(n),1===u?u:(n.length=0,k(n,M),k(n,R),k(n,i(D,4)),k(n,i(x,5)),o(n),2===u||(n.length=0,k(n,M),k(n,x),k(n,i(D,6)),k(n,P),o(n)),u)}const y=(()=>{const e=new Int8Array(216);let t=0;const n=n=>{for(let a=0;a<n.length;a++)e[t+a]=n[a];t+=8};return n([3,0,6,2,3,1,5,4]),n([2,0,2,3,1,5,4,0]),n([3,1,0,2,3,7,5,4]),n([2,0,1,3,2,6,4,0]),n([1,0,1,3,2,0,0,0]),n([2,1,5,7,3,2,0,0]),n([3,2,0,1,3,7,6,4]),n([2,2,0,1,3,7,6,0]),n([3,3,0,1,5,7,6,2]),n([2,0,1,5,4,6,2,0]),n([1,0,1,5,4,0,0,0]),n([2,1,3,7,5,4,0,0]),n([1,0,2,6,4,0,0,0]),n([0,0,0,0,0,0,0,0]),n([1,1,3,7,5,0,0,0]),n([2,2,3,7,6,4,0,0]),n([1,2,3,7,6,0,0,0]),n([2,3,1,5,7,6,2,0]),n([3,4,0,1,5,7,6,2]),n([2,5,7,6,4,0,1,0]),n([3,5,0,1,3,7,6,4]),n([2,4,5,7,6,2,0,0]),n([1,4,5,7,6,0,0,0]),n([2,5,1,3,7,6,4,0]),n([3,6,0,2,3,7,5,4]),n([2,6,2,3,7,5,4,0]),n([3,7,6,2,3,1,5,4]),e})(),z=4;function S(e,t){let n=0;for(let a=0;a<z;a++){const o=i.intersectPlane(e,t[a]);if(o>0)return-1;0===o&&(n|=1<<a)}return n}const q=o.create(),v=r.create(),D=n.create(),M=n.create(),P=n.create(),R=n.create(),x=n.create();e.computeDepthRange=function(e,t){const n=l.empty(),o=e.eye,r=e.viewForward,c=e.frustum.planes;for(let e=0;e<t.length;e++){const s=t[e].obb,u=a.dot(a.sub(D,s.center,o),r),d=i.projectedRadius(s,r);if(l.within(n,u-d)&&l.within(n,u+d))continue;const p=S(s,c);if(-1===p)continue;if(0===p){h.far=u+d,h.near=u-d,l.union(n,h);continue}const g=f.pushNew();g.near=u-d,g.far=u+d,g.mask=p,g.object=t[e]}for(let e=0;e<f.length;e++){const t=f.data[e];if(l.within(n,t.near)&&l.within(n,t.far))continue;h.far=t.far,h.near=1/0;0===j(t.object.obb,o,g,(e=>{let n=b;for(let a=0;a<z&&e.length>0;a++){if(0==(t.mask&1<<a))continue;m(c[a],e,n);const o=e;e=n,n=o}for(let t=0;t<e.length;t+=3){a.set(d,e.data[t+0],e.data[t+1],e.data[t+2]);const n=a.dot(a.sub(d,d,o),r);h.near=Math.min(h.near,n)}}))&&(h.near=0),l.union(n,h)}return f.length=0,n},Object.defineProperty(e,"__esModule",{value:!0})}));
