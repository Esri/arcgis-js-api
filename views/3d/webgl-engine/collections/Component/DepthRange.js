/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{isSome as t}from"../../../../../core/maybe.js";import n from"../../../../../core/PooledArray.js";import{g as o,d as e}from"../../../../../chunks/mat3.js";import{c as r}from"../../../../../chunks/mat3f64.js";import{c as a}from"../../../../../chunks/quat.js";import{a as s}from"../../../../../chunks/quatf64.js";import{e as f,v as c,q as l,a as u,s as i,h,c as m,t as p}from"../../../../../chunks/vec3.js";import{c as b}from"../../../../../chunks/vec3f64.js";import{signedDistance as d}from"../../../../../geometry/support/plane.js";import{projectedRadius as j,intersectPlane as g}from"../../../support/orientedBoundingBox.js";import{empty as k,within as w,union as z}from"../../lib/depthRange.js";function S(n,o){const e=k(),{eye:r,frustum:a,viewForward:s}=n;o.forAll((n=>{const o=t(n.offsetObb)?n.offsetObb:n.obb,l=f(c(E,o.center,r),s),u=j(o,s);if(w(e,l-u)&&w(e,l+u))return;const i=R(o,a);if(-1===i)return;if(0===i)return v.far=l+u,v.near=l-u,void z(e,v);const h=q.pushNew();h.near=l-u,h.far=l+u,h.mask=i,h.object=n}));for(let l=0;l<q.length;l++){const n=q.data[l];if(w(e,n.near)&&w(e,n.far))continue;v.far=n.far,v.near=1/0;const o=M(t(n.object.offsetObb)?n.object.offsetObb:n.object.obb,r,A,(t=>{let o=x;for(let e=0;e<P&&t.length>0;e++){if(0==(n.mask&1<<e))continue;B(a[e],t,o);const r=t;t=o,o=r}for(let n=0;n<t.length;n+=3){i(y,t.data[n+0],t.data[n+1],t.data[n+2]);const o=f(c(y,y,r),s);v.near=Math.min(v.near,o)}}));0===o&&(v.near=0),z(e,v)}return q.length=0,e}const q=new n({allocator:t=>t||{near:1/0,far:-1/0,mask:0,object:null},deallocator:t=>(t.object=null,t)}),v=k(),y=b(),O=b(),A=new n({deallocator:null}),x=new n({deallocator:null});function B(t,n,o){o.length=0;const e=n.length-3;F(y,n,e);const r=d(t,y);r<=0&&(o.push(y[0]),o.push(y[1]),o.push(y[2]));let a=0,s=r;for(;a<e;a+=3){F(O,n,a);const e=d(t,O);if(s*e<0){h(y,O,y,e/(e-s)),I(o,y)}e<=0&&I(o,O),s=e,m(y,O)}if(s*r<0){F(O,n,e);h(y,O,y,r/(r-s)),I(o,y)}}function F(t,n,o){return i(t,n.data[o+0],n.data[o+1],n.data[o+2])}function I(t,n){t.push(n[0]),t.push(n[1]),t.push(n[2])}function M(t,n,r,s){a(D,t.quaternion),c(E,n,t.center),l(E,E,D);const f=8*((E[0]<-t.halfSize[0]?-1:E[0]>t.halfSize[0]?1:0)+3*(E[1]<-t.halfSize[1]?-1:E[1]>t.halfSize[1]?1:0)+9*(E[2]<-t.halfSize[2]?-1:E[2]>t.halfSize[2]?1:0)+13),h=N[f];if(0===h)return h;o(C,t.quaternion),e(C,C,t.halfSize);const m=(n,o)=>{const e=N[f+o+1];return i(n,((1&e)<<1)-1,(2&e)-1,((4&e)>>1)-1),p(n,n,C),u(n,t.center,n)};return r.length=0,I(r,m(G,0)),I(r,m(H,1)),I(r,m(E,2)),I(r,m(J,3)),s(r),1===h?h:(r.length=0,I(r,G),I(r,J),I(r,m(E,4)),I(r,m(K,5)),s(r),2===h||(r.length=0,I(r,G),I(r,K),I(r,m(E,6)),I(r,H),s(r)),h)}const N=(()=>{const t=new Int8Array(216);let n=0;const o=o=>{for(let e=0;e<o.length;e++)t[n+e]=o[e];n+=8};return o([3,0,6,2,3,1,5,4]),o([2,0,2,3,1,5,4,0]),o([3,1,0,2,3,7,5,4]),o([2,0,1,3,2,6,4,0]),o([1,0,1,3,2,0,0,0]),o([2,1,5,7,3,2,0,0]),o([3,2,0,1,3,7,6,4]),o([2,2,0,1,3,7,6,0]),o([3,3,0,1,5,7,6,2]),o([2,0,1,5,4,6,2,0]),o([1,0,1,5,4,0,0,0]),o([2,1,3,7,5,4,0,0]),o([1,0,2,6,4,0,0,0]),o([0,0,0,0,0,0,0,0]),o([1,1,3,7,5,0,0,0]),o([2,2,3,7,6,4,0,0]),o([1,2,3,7,6,0,0,0]),o([2,3,1,5,7,6,2,0]),o([3,4,0,1,5,7,6,2]),o([2,5,7,6,4,0,1,0]),o([3,5,0,1,3,7,6,4]),o([2,4,5,7,6,2,0,0]),o([1,4,5,7,6,0,0,0]),o([2,5,1,3,7,6,4,0]),o([3,6,0,2,3,7,5,4]),o([2,6,2,3,7,5,4,0]),o([3,7,6,2,3,1,5,4]),t})(),P=4;function R(t,n){let o=0;for(let e=0;e<P;e++){const r=g(t,n[e]);if(r>0)return-1;0===r&&(o|=1<<e)}return o}const C=r(),D=s(),E=b(),G=b(),H=b(),J=b(),K=b();export{S as computeDepthRange};
