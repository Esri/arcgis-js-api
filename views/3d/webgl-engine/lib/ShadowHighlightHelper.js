/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../core/mathUtils","../../../../chunks/vec3f64","../../../../chunks/vec3","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec2f64","../../../../chunks/vec4f64","../../../../chunks/vec2","../../../../chunks/vec4f32","./Util","../../../webgl/Util","./glUtil3D","../shaders/ShadowHighlightTechnique"],(function(t,i,e,a,o,h,n,r,s,c,d,l,u,p){"use strict";const g=.001953125,_=4e4,f=5e4;let w=function(){function e(t,i,e,a){this._rctx=i,this.highlightShadowMapSlot=e,this.defaultSnapshotSlot=a,this._opacityElevationFactor=1,this._dayNightTerminatorFactor=1,this._maxOpacity=1,this._defaultOptions={shadowColor:c.fromValues(1,0,1,1),shadowOpacity:.2,occludedShadowOpacity:.1};const o=new p.ShadowHighlightTechniqueConfiguration;this._shadowHighlightTechnique=t.acquireAndReleaseExisting(p.ShadowHighlightTechnique,o,this._shadowHighlightTechnique),this._viewingMode=t.viewingMode,this._quadVAO=u.createQuadVAO(this._rctx)}var h=e.prototype;return h.render=function(t,i,e,h,n,r){if(d.assert(this._quadVAO),!e.enabled||!this.wouldRender)return;const c=this._rctx,u=this._quadVAO,p=this._shadowHighlightTechnique,g=x,_=M,f=q,w=S,m=v,T=O,F=this.defaultSnapshotSlot,V=this.highlightShadowMapSlot,A=this._defaultOptions,b=A.shadowColor,k=A.shadowOpacity,H=A.occludedShadowOpacity,C=this._opacityElevationFactor*this._dayNightTerminatorFactor,E=s.set(y,1/i.descriptor.width,1/i.descriptor.height);a.transformMat4(T,h,t.viewInverseTransposeMatrix),a.normalize(T,T),a.copy(m,t.center),s.copy(w,t.nearFar),d.inverseProjectionInfo(t.projectionMatrix,t.fullWidth,t.fullHeight,g,_),o.translate(f,t.viewMatrix,t.center),o.invert(f,f),c.bindFramebuffer(r),c.bindProgram(p.program),p.bindPipelineState(c),p.bindPass(c,{color:b,opacity:k,occludedOpacity:H,terminationFactor:C,defaultSnapshotSlot:F,highlightSnapshotSlot:V,shadowMappingEnabled:e.enabled,shadowMap:e,origin:m,zScale:_,inverseView:f,projInfo:g,nearFar:w,depthMap:i,lightDirView:T,highlightMap:n.colorTexture,texelSize:E}),c.bindVAO(u),c.drawArrays(p.primitiveType,0,l.vertexCount(u,"geometry"))},h.getGpuMemoryUsage=function(){return this._quadVAO?this._quadVAO.size:0},h.setDefaultOptions=function(t){this._defaultOptions=t,this._updateMaxOpacity()},h.setup=function(t,e){const a=t.relativeElevation;this._opacityElevationFactor=1-i.smoothstep(_,f,a),this._dayNightTerminatorFactor=this._evaluateDayNightTerminatorFactor(t.center,e)},h.dispose=function(){this._quadVAO&&(this._quadVAO.dispose(),this._quadVAO=null)},h._updateMaxOpacity=function(){const t=this._defaultOptions,i=t.shadowColor,e=Math.max(t.shadowOpacity,t.occludedShadowOpacity);this._maxOpacity=e*i[3]},h._evaluateDayNightTerminatorFactor=function(t,e){const o=1===this._viewingMode?a.normalize(m,t):a.set(m,0,0,1),h=a.dot(o,e);return i.smoothstep(0,1,i.glClamp(30*h,0,1))},t._createClass(e,[{key:"wouldRender",get:function(){return this._maxOpacity*this._opacityElevationFactor*this._dayNightTerminatorFactor>=g}}]),e}();const y=n.create(),m=e.create(),O=e.create(),v=e.create(),S=n.create(),M=n.create(),x=r.create(),q=h.create();return w}));
