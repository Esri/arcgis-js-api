/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{nextHighestPowerOfTwo as t}from"../../../../core/mathUtils.js";class s{constructor(t,s=0){this.capacity=0,this.count=0,this.emptySlots=[],this.emptySlotCount=0,this.id2slot=new Map,this.slot2id=[],this.layout=t,this._resize(s)}prepareAllocate(t){const s=this.count+t;s>this.capacity&&this._resize(s)}allocate(t){this.count>=this.capacity&&this._resize(this.count+1);const s=this.emptySlotCount>0?this.emptySlots[--this.emptySlotCount]:this.count;return this.id2slot.set(t,s),this.slot2id[s]=t,this.count++,s}prepareFree(t){this.emptySlots.length+=t}free(t){const s=this.id2slot.get(t);null!=s&&(this.emptySlots.length<=this.emptySlotCount&&(this.emptySlots.length=this.emptySlotCount+1),this.emptySlots[this.emptySlotCount++]=s,this.id2slot.delete(t),this.slot2id[s]=null,this.count--)}getCount(){return this.count}getSlot(t){return this.id2slot.get(t)}hasSlot(t){return this.id2slot.has(t)}getBuffer(){return this.buffer}compact(){if(this.emptySlotCount>0){const t=this.emptySlots;let s=this.emptySlotCount,i=this.count+s;for(t.length=s,t.sort(((t,s)=>t-s));s>0;){if(t[s-1]!==i-1){const e=i-1,o=t[s-1];this.buffer.copyFrom(this.buffer,e,o,1);const h=this.slot2id[e];this.slot2id[e]=null,this.slot2id[o]=h,this.id2slot.set(h,o)}s--,i--}}this.emptySlotCount=0,this.emptySlots.length=0,this._resize(this.count)}_resize(s){const i=this.capacity;if((s=Math.max(0,s))>0&&(s=t(s)),s>i){const t=this.layout.createBuffer(s);this.buffer&&t.copyFrom(this.buffer,0,0,i),this.buffer=t}else if(s<i){const t=this.layout.createBuffer(s);t.copyFrom(this.buffer,0,0,s),this.buffer=t}this.buffer||(this.buffer=this.layout.createBuffer(0)),this.capacity=s,this.slot2id.length=s}}export{s as default};
