/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/Logger","../../../../core/mathUtils","../../../../core/maybe","../../../../core/screenUtils","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec2","../../../../chunks/vec2f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../chunks/vec4","../../../../chunks/vec4f64","../../../../geometry/support/frustum","../../../../geometry/support/ray","../../../../geometry/support/vector","../../../ViewingMode","./Util"],(function(i,t,e,r,n,s,o,h,a,u,c,d,p,_,v,f,y,w,g){"use strict";const l=e.getLogger("esri.views.3d.webgl-engine.lib.Camera");let m=function(){function e(i=null,t=null,e=null){this._viewUp=d.create(),this._viewForward=d.create(),this._viewRight=d.create(),this._ray=f.create(),this._viewport=_.fromValues(0,0,1,1),this._padding=_.fromValues(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=u.fromValues(1,1e3),this._viewDirty=!0,this._viewMatrix=h.create(),this._projectionDirty=!0,this._projectionMatrix=h.create(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=h.create(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=h.create(),this._frustumDirty=!0,this._frustum=v.create(),this._fullViewport=_.create(),this.pixelRatio=1,this.relativeElevation=0,n.isSome(i)&&c.copy(this._ray.origin,i),this._center=n.isSome(t)?d.clone(t):d.create(),this._up=n.isSome(e)?d.clone(e):d.fromValues(0,0,1)}var m=e.prototype;return m.depthNDCToWorld=function(i){const t=2*i-1;return 2*this.near*this.far/(this.far+this.near-t*(this.far-this.near))},m.copyFrom=function(i){c.copy(this._ray.origin,i.eye),c.copy(this._center,i.center),c.copy(this._up,i.up),p.copy(this._viewport,i.viewport),p.copy(this._padding,i.padding),a.copy(this._nearFar,i.nearFar),this._fov=i.fov,this.relativeElevation=i.relativeElevation;const t=i;return this._viewDirty=t._viewDirty,this._viewDirty||(o.copy(this._viewMatrix,i.viewMatrix),c.copy(this._viewRight,i.viewRight),c.copy(this._viewUp,i.viewUp),c.copy(this._viewForward,i.viewForward)),t._projectionDirty?this._projectionDirty=!0:(o.copy(this._projectionMatrix,i.projectionMatrix),this._projectionDirty=!1),this._viewProjectionDirty=!0,this._frustumDirty=t._frustumDirty,this._frustumDirty||(v.copy(this._frustum,i.frustum),this._frustumDirty=!1),t._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:(o.copy(this._viewInverseTransposeMatrix,i.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),p.copy(this._fullViewport,i.fullViewport),this.pixelRatio=i.pixelRatio,this},m.copyViewFrom=function(i){this.eye=i.eye,this.center=i.center,this.up=i.up},m.clone=function(){return(new e).copyFrom(this)},m.equals=function(i){return c.exactEquals(this.eye,i.eye)&&c.exactEquals(this._center,i.center)&&c.exactEquals(this._up,i.up)&&p.exactEquals(this._viewport,i.viewport)&&p.exactEquals(this._padding,i.padding)&&a.exactEquals(this._nearFar,i.nearFar)&&this._fov===i.fov&&this.pixelRatio===i.pixelRatio&&this.relativeElevation===i.relativeElevation},m.almostEquals=function(i){if(this.pixelRatio!==i.pixelRatio||Math.abs(i.fov-this._fov)>=.001)return!1;const t=5e-4,e=1-1e-10;c.sub(M,i.eye,i.center),c.sub(D,this.eye,this._center);const r=c.dot(M,D),n=c.sqrLen(M),s=c.sqrLen(D);return r*r>=e*n*s&&c.sqrDist(i.eye,this.eye)<Math.max(n,s)*t*t&&p.squaredDistance(i.padding,this._padding)<.5&&p.squaredDistance(i.viewport,this._viewport)<.5},m.computeRenderPixelSizeAt=function(i){return this.computeRenderPixelSizeAtDist(this._viewDirectionDistance(i))},m.computeRenderPixelSizeAtDist=function(i){return i*this.perRenderPixelRatio},m.computeScreenPixelSizeAt=function(i){return this.computeScreenPixelSizeAtDist(this._viewDirectionDistance(i))},m._viewDirectionDistance=function(i){return Math.abs(y.projectPointSignedLength(this.viewForward,c.subtract(M,i,this.eye)))},m.computeScreenPixelSizeAtDist=function(i){return i*this.perScreenPixelRatio},m.computeDistanceFromRadius=function(i,t){return i/Math.tan(Math.min(this.fovX,this.fovY)/(2*(t||1)))},m.getScreenCenter=function(t=s.createScreenPointArray()){return t[0]=(this.padding[i.PaddingSide.LEFT]+this.width/2)/this.pixelRatio,t[1]=(this.padding[i.PaddingSide.TOP]+this.height/2)/this.pixelRatio,t},m.getRenderCenter=function(t,e=.5,r=.5){return t[0]=this.padding[i.PaddingSide.LEFT]+this.width*e,t[1]=this.padding[i.PaddingSide.BOTTOM]+this.height*r,t[2]=.5,t},m.setGLViewport=function(i){const t=this.viewport,e=this.padding;i.setViewport(t[0]-e[3],t[1]-e[2],t[2]+e[1]+e[3],t[3]+e[0]+e[2])},m.applyProjection=function(i,t,e=!1){i!==x&&c.copy(x,i),x[3]=1,e&&(t[2]=-x[2]),p.transformMat4(x,x,this.projectionMatrix),c.scale(x,x,1/Math.abs(x[3]));const n=this.fullViewport;return t[0]=r.lerp(0,n[0]+n[2],.5+.5*x[0]),t[1]=r.lerp(0,n[1]+n[3],.5+.5*x[1]),e||(t[2]=.5*(x[2]+1)),t},m.projectToScreen=function(i,t){this.projectToRenderScreen(i,T),this.renderToScreen(T,t)},m.projectToRenderScreen=function(i,t){if(x[0]=i[0],x[1]=i[1],x[2]=i[2],x[3]=1,p.transformMat4(x,x,this.viewProjectionMatrix),0===x[3])return null;c.scale(x,x,1/Math.abs(x[3]));const e=this.fullViewport;return"x"in t?(t.x=r.lerp(0,e[0]+e[2],.5+.5*x[0]),t.y=r.lerp(0,e[1]+e[3],.5+.5*x[1])):(t[0]=r.lerp(0,e[0]+e[2],.5+.5*x[0]),t[1]=r.lerp(0,e[1]+e[3],.5+.5*x[1]),t.length>2&&(t[2]=.5*(x[2]+1))),t},m.unprojectFromScreen=function(i,t){return this.unprojectFromRenderScreen(this.screenToRender(i,T),t)},m.unprojectFromRenderScreen=function(i,t){if(o.multiply(P,this.projectionMatrix,this.viewMatrix),!o.invert(P,P))return null;const e=this.fullViewport;return x[0]=2*(i[0]-e[0])/e[2]-1,x[1]=2*(i[1]-e[1])/e[3]-1,x[2]=2*i[2]-1,x[3]=1,p.transformMat4(x,x,P),0===x[3]?null:(t[0]=x[0]/x[3],t[1]=x[1]/x[3],t[2]=x[2]/x[3],t)},m.constrainWindowSize=function(i,t,e,r=e){const n=i*this.pixelRatio,s=t*this.pixelRatio,o=Math.max(n-e/2,0),h=Math.max(this.fullHeight-s-r/2,0),a=-Math.min(n-e/2,0),u=-Math.min(this.fullHeight-s-r/2,0);return[o,h,e-a- -Math.min(this.fullWidth-n-e/2,0),r-u- -Math.min(s-r/2,0)]},m.computeUp=function(i){i===w.ViewingMode.Global?this._computeUpGlobal():this._computeUpLocal()},m.screenToRender=function(i,t){const e=i[0]*this.pixelRatio,r=this.fullHeight-i[1]*this.pixelRatio;return t[0]=e,t[1]=r,t},m.renderToScreen=function(i,t){const e=i[0]/this.pixelRatio,r=(this.fullHeight-i[1])/this.pixelRatio;t[0]=e,t[1]=r},m._computeUpGlobal=function(){c.subtract(M,this.center,this.eye);const i=c.length(this.center);i<1?(c.set(this._up,0,0,1),this._markViewDirty()):Math.abs(c.dot(M,this.center))>.9999*c.length(M)*i||(c.cross(this._up,M,this.center),c.cross(this._up,this._up,M),c.normalize(this._up,this._up),this._markViewDirty())},m._computeUpLocal=function(){c.direction(M,this.eye,this.center),Math.abs(M[2])<=.9999&&(c.scale(M,M,M[2]),c.set(this._up,-M[0],-M[1],1-M[2]),c.normalize(this._up,this._up),this._markViewDirty())},m._compareAndSetView=function(i,t){"number"==typeof i[0]&&isFinite(i[0])&&"number"==typeof i[1]&&isFinite(i[1])&&"number"==typeof i[2]&&isFinite(i[2])?c.exactEquals(i,t)||(c.copy(t,i),this._markViewDirty()):l.warn("Camera vector contains invalid number, ignoring value")},m._markViewDirty=function(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0},m._recomputeFrustum=function(){this._frustumDirty&&(v.fromMatrix(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)},m._ensureViewClean=function(){this._viewDirty&&(o.lookAt(this._viewMatrix,this.eye,this._center,this._up),c.set(this._viewForward,-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10]),c.set(this._viewUp,this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9]),c.set(this._viewRight,this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8]),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)},t._createClass(e,[{key:"eye",get:function(){return this._ray.origin},set:function(i){this._compareAndSetView(i,this._ray.origin)}},{key:"center",get:function(){return this._center},set:function(i){this._compareAndSetView(i,this._center)}},{key:"ray",get:function(){return c.subtract(this._ray.direction,this.center,this.eye),this._ray}},{key:"up",get:function(){return this._up},set:function(i){this._compareAndSetView(i,this._up)}},{key:"viewMatrix",get:function(){return this._ensureViewClean(),this._viewMatrix},set:function(i){o.copy(this._viewMatrix,i),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}},{key:"viewForward",get:function(){return this._ensureViewClean(),this._viewForward}},{key:"viewUp",get:function(){return this._ensureViewClean(),this._viewUp}},{key:"viewRight",get:function(){return this._ensureViewClean(),this._viewRight}},{key:"nearFar",get:function(){return this._nearFar}},{key:"near",get:function(){return this._nearFar[0]},set:function(i){this._nearFar[0]!==i&&(this._nearFar[0]=i,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}},{key:"far",get:function(){return this._nearFar[1]},set:function(i){this._nearFar[1]!==i&&(this._nearFar[1]=i,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}},{key:"viewport",get:function(){return this._viewport},set:function(i){this.x=i[0],this.y=i[1],this.width=i[2],this.height=i[3]}},{key:"x",get:function(){return this._viewport[0]},set:function(t){t+=this._padding[i.PaddingSide.LEFT],this._viewport[0]!==t&&(this._viewport[0]=t,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}},{key:"y",get:function(){return this._viewport[1]},set:function(t){t+=this._padding[i.PaddingSide.BOTTOM],this._viewport[1]!==t&&(this._viewport[1]=t,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}},{key:"width",get:function(){return this._viewport[2]},set:function(i){this._viewport[2]!==i&&(this._viewport[2]=i,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}},{key:"height",get:function(){return this._viewport[3]},set:function(i){this._viewport[3]!==i&&(this._viewport[3]=i,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}},{key:"fullWidth",get:function(){return this._viewport[2]+this._padding[i.PaddingSide.RIGHT]+this._padding[i.PaddingSide.LEFT]},set:function(t){this.width=t-(this._padding[i.PaddingSide.RIGHT]+this._padding[i.PaddingSide.LEFT])}},{key:"fullHeight",get:function(){return this._viewport[3]+this._padding[i.PaddingSide.TOP]+this._padding[i.PaddingSide.BOTTOM]},set:function(t){this.height=t-(this._padding[i.PaddingSide.TOP]+this._padding[i.PaddingSide.BOTTOM])}},{key:"fullViewport",get:function(){return this._fullViewport[0]=this._viewport[0]-this._padding[i.PaddingSide.LEFT],this._fullViewport[1]=this._viewport[1]-this._padding[i.PaddingSide.BOTTOM],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}},{key:"aspect",get:function(){return this.width/this.height}},{key:"padding",get:function(){return this._padding},set:function(t){this._padding[i.PaddingSide.TOP]===t[i.PaddingSide.TOP]&&this._padding[i.PaddingSide.RIGHT]===t[i.PaddingSide.RIGHT]&&this._padding[i.PaddingSide.BOTTOM]===t[i.PaddingSide.BOTTOM]&&this._padding[i.PaddingSide.LEFT]===t[i.PaddingSide.LEFT]||(this._viewport[0]+=t[i.PaddingSide.LEFT]-this._padding[i.PaddingSide.LEFT],this._viewport[1]+=t[i.PaddingSide.BOTTOM]-this._padding[i.PaddingSide.BOTTOM],this._viewport[2]-=t[i.PaddingSide.RIGHT]+t[i.PaddingSide.LEFT]-(this._padding[i.PaddingSide.RIGHT]+this._padding[i.PaddingSide.LEFT]),this._viewport[3]-=t[i.PaddingSide.TOP]+t[i.PaddingSide.BOTTOM]-(this._padding[i.PaddingSide.TOP]+this._padding[i.PaddingSide.BOTTOM]),p.copy(this._padding,t),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}},{key:"viewProjectionMatrix",get:function(){return this._viewProjectionDirty&&(o.multiply(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}},{key:"projectionMatrix",get:function(){if(this._projectionDirty){const t=this.width,e=this.height,r=this.near*Math.tan(this.fovY/2),n=r*this.aspect;o.frustum(this._projectionMatrix,-n*(1+2*this._padding[i.PaddingSide.LEFT]/t),n*(1+2*this._padding[i.PaddingSide.RIGHT]/t),-r*(1+2*this._padding[i.PaddingSide.BOTTOM]/e),r*(1+2*this._padding[i.PaddingSide.TOP]/e),this.near,this.far),this._projectionDirty=!1}return this._projectionMatrix},set:function(i){o.copy(this._projectionMatrix,i),this._projectionDirty=!1,this._viewProjectionDirty=!0,this._frustumDirty=!0}},{key:"fov",get:function(){return this._fov},set:function(i){this._fov=i,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}},{key:"fovX",get:function(){return g.fovd2fovx(this._fov,this.width,this.height)},set:function(i){this._fov=g.fovx2fovd(i,this.width,this.height),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}},{key:"fovY",get:function(){return g.fovd2fovy(this._fov,this.width,this.height)},set:function(i){this._fov=g.fovy2fovd(i,this.width,this.height),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}},{key:"distance",get:function(){return c.distance(this._center,this.eye)}},{key:"frustum",get:function(){return this._recomputeFrustum(),this._frustum}},{key:"viewInverseTransposeMatrix",get:function(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&(o.invert(this._viewInverseTransposeMatrix,this.viewMatrix),o.transpose(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}},{key:"perRenderPixelRatio",get:function(){return Math.tan(this.fovX/2)/(this.width/2)}},{key:"perScreenPixelRatio",get:function(){return this.perRenderPixelRatio*this.pixelRatio}},{key:"aboveGround",get:function(){return this.relativeElevation&&this.relativeElevation>=0}}]),e}();const x=_.create(),P=h.create(),M=d.create(),D=d.create(),T=s.createRenderScreenPointArray3();var S;i.PaddingSide=void 0,(S=i.PaddingSide||(i.PaddingSide={}))[S.TOP=0]="TOP",S[S.RIGHT=1]="RIGHT",S[S.BOTTOM=2]="BOTTOM",S[S.LEFT=3]="LEFT",i.default=m,Object.defineProperties(i,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
