/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/Logger","../../../../core/mathUtils","../../../../core/maybe","../../../../core/screenUtils","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec2","../../../../chunks/vec2f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../chunks/vec4","../../../../chunks/vec4f64","../../../../geometry/support/frustum","../../../../geometry/support/ray","../../../../geometry/support/vector","../../../ViewingMode","./Util"],(function(i,t,e,r,n,s,o,h,a,c,u,_,d,p,v,f,y,l,w){"use strict";let g=function(){function g(i=null,t=null,e=null){this._viewUp=_.create(),this._viewForward=_.create(),this._viewRight=_.create(),this._ray=f.create(),this._viewport=p.fromValues(0,0,1,1),this._padding=p.fromValues(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=c.fromValues(1,1e3),this._viewDirty=!0,this._viewMatrix=h.create(),this._projectionDirty=!0,this._projectionMatrix=h.create(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=h.create(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=h.create(),this._inverseProjectionDirty=!0,this._inverseProjectionMatrix=null,this._frustumDirty=!0,this._frustum=v.create(),this._fullViewport=p.create(),this._pixelRatio=1,this.relativeElevation=0,n.isSome(i)&&u.copy(this._ray.origin,i),this._center=n.isSome(t)?_.clone(t):_.create(),this._up=n.isSome(e)?_.clone(e):_.fromValues(0,0,1)}var T=g.prototype;return T.depthNDCToWorld=function(i){const t=2*i-1;return 2*this.near*this.far/(this.far+this.near-t*(this.far-this.near))},T.copyFrom=function(i){u.copy(this._ray.origin,i.eye),u.copy(this._center,i.center),u.copy(this._up,i.up),d.copy(this._viewport,i.viewport),d.copy(this._padding,i.padding),a.copy(this._nearFar,i.nearFar),this._fov=i.fov,this.relativeElevation=i.relativeElevation;const t=i;return this._viewDirty=t._viewDirty,this._viewDirty||(o.copy(this._viewMatrix,i.viewMatrix),u.copy(this._viewRight,i.viewRight),u.copy(this._viewUp,i.viewUp),u.copy(this._viewForward,i.viewForward)),t._projectionDirty?this._projectionDirty=!0:(o.copy(this._projectionMatrix,i.projectionMatrix),this._projectionDirty=!1),this._viewProjectionDirty=!0,this._inverseProjectionDirty=!0,this._frustumDirty=t._frustumDirty,this._frustumDirty||(v.copy(this._frustum,i.frustum),this._frustumDirty=!1),t._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:(o.copy(this._viewInverseTransposeMatrix,i.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),d.copy(this._fullViewport,i.fullViewport),this._pixelRatio=i.pixelRatio,this},T.copyViewFrom=function(i){this.eye=i.eye,this.center=i.center,this.up=i.up},T.clone=function(){return(new g).copyFrom(this)},T.equals=function(i){return u.exactEquals(this.eye,i.eye)&&u.exactEquals(this._center,i.center)&&u.exactEquals(this._up,i.up)&&d.exactEquals(this._viewport,i.viewport)&&d.exactEquals(this._padding,i.padding)&&a.exactEquals(this._nearFar,i.nearFar)&&this._fov===i.fov&&this._pixelRatio===i.pixelRatio&&this.relativeElevation===i.relativeElevation},T.almostEquals=function(i){if(this._pixelRatio!==i.pixelRatio||Math.abs(i.fov-this._fov)>=.001)return!1;const t=5e-4,e=1-1e-10;u.sub(D,i.eye,i.center),u.sub(M,this.eye,this._center);const r=u.dot(D,M),n=u.sqrLen(D),s=u.sqrLen(M);return r*r>=e*n*s&&u.sqrDist(i.eye,this.eye)<Math.max(n,s)*t*t&&d.squaredDistance(i.padding,this._padding)<.5&&d.squaredDistance(i.viewport,this._viewport)<.5},T.computeRenderPixelSizeAt=function(i){return this.computeRenderPixelSizeAtDist(this._viewDirectionDistance(i))},T.computeRenderPixelSizeAtDist=function(i){return i*this.perRenderPixelRatio},T.computeScreenPixelSizeAt=function(i){return this.computeScreenPixelSizeAtDist(this._viewDirectionDistance(i))},T._viewDirectionDistance=function(i){return Math.abs(y.projectPointSignedLength(this.viewForward,u.subtract(D,i,this.eye)))},T.computeScreenPixelSizeAtDist=function(i){return i*this.perScreenPixelRatio},T.computeDistanceFromRadius=function(i,t){return i/Math.tan(Math.min(this.fovX,this.fovY)/(2*(t||1)))},T.getScreenCenter=function(t=s.createScreenPointArray()){return t[0]=(this.padding[i.PaddingSide.LEFT]+this.width/2)/this._pixelRatio,t[1]=(this.padding[i.PaddingSide.TOP]+this.height/2)/this._pixelRatio,t},T.getRenderCenter=function(t,e=.5,r=.5){return t[0]=this.padding[i.PaddingSide.LEFT]+this.width*e,t[1]=this.padding[i.PaddingSide.BOTTOM]+this.height*r,t[2]=.5,t},T.setGLViewport=function(i){const t=this.viewport,e=this.padding;i.setViewport(t[0]-e[3],t[1]-e[2],t[2]+e[1]+e[3],t[3]+e[0]+e[2])},T.applyProjection=function(i,t){i!==P&&u.copy(P,i),P[3]=1,d.transformMat4(P,P,this.projectionMatrix);const e=Math.abs(P[3]);u.scale(P,P,1/e);const n=this.fullViewport;t[0]=r.lerp(0,n[0]+n[2],.5+.5*P[0]),t[1]=r.lerp(0,n[1]+n[3],.5+.5*P[1]),t[2]=.5*(P[2]+1),t[3]=e},T.unapplyProjection=function(i,t){const e=this.fullViewport;P[0]=(i[0]/(e[0]+e[2])*2-1)*i[3],P[1]=(i[1]/(e[1]+e[3])*2-1)*i[3],P[2]=(2*i[2]-1)*i[3],P[3]=i[3],d.transformMat4(P,P,this.inverseProjectionMatrix),t[0]=P[0],t[1]=P[1],t[2]=P[2]},T.projectToScreen=function(i,t){return this.projectToRenderScreen(i,m),this.renderToScreen(m,t),t},T.projectToRenderScreen=function(i,t){if(P[0]=i[0],P[1]=i[1],P[2]=i[2],P[3]=1,d.transformMat4(P,P,this.viewProjectionMatrix),0===P[3])return null;u.scale(P,P,1/Math.abs(P[3]));const e=this.fullViewport;return"x"in t?(t.x=r.lerp(0,e[0]+e[2],.5+.5*P[0]),t.y=r.lerp(0,e[1]+e[3],.5+.5*P[1])):(t[0]=r.lerp(0,e[0]+e[2],.5+.5*P[0]),t[1]=r.lerp(0,e[1]+e[3],.5+.5*P[1]),t.length>2&&(t[2]=.5*(P[2]+1))),t},T.unprojectFromScreen=function(i,t){return this.unprojectFromRenderScreen(this.screenToRender(i,m),t)},T.unprojectFromRenderScreen=function(i,t){if(o.multiply(x,this.projectionMatrix,this.viewMatrix),!o.invert(x,x))return null;const e=this.fullViewport;return P[0]=2*(i[0]-e[0])/e[2]-1,P[1]=2*(i[1]-e[1])/e[3]-1,P[2]=2*i[2]-1,P[3]=1,d.transformMat4(P,P,x),0===P[3]?null:(t[0]=P[0]/P[3],t[1]=P[1]/P[3],t[2]=P[2]/P[3],t)},T.constrainWindowSize=function(i,t,e,r=e){const n=i*this._pixelRatio,s=t*this._pixelRatio,o=Math.max(n-e/2,0),h=Math.max(this.fullHeight-s-r/2,0),a=-Math.min(n-e/2,0),c=-Math.min(this.fullHeight-s-r/2,0);return[o,h,e-a- -Math.min(this.fullWidth-n-e/2,0),r-c- -Math.min(s-r/2,0)]},T.computeUp=function(i){i===l.ViewingMode.Global?this._computeUpGlobal():this._computeUpLocal()},T.screenToRender=function(i,t){const e=i[0]*this._pixelRatio,r=this.fullHeight-i[1]*this._pixelRatio;return t[0]=e,t[1]=r,t},T.renderToScreen=function(i,t){const e=i[0]/this._pixelRatio,r=(this.fullHeight-i[1])/this._pixelRatio;t[0]=e,t[1]=r},T._computeUpGlobal=function(){u.subtract(D,this.center,this.eye);const i=u.length(this.center);i<1?(u.set(this._up,0,0,1),this._markViewDirty()):Math.abs(u.dot(D,this.center))>.9999*u.length(D)*i||(u.cross(this._up,D,this.center),u.cross(this._up,this._up,D),u.normalize(this._up,this._up),this._markViewDirty())},T._computeUpLocal=function(){u.direction(D,this.eye,this.center),Math.abs(D[2])<=.9999&&(u.scale(D,D,D[2]),u.set(this._up,-D[0],-D[1],1-D[2]),u.normalize(this._up,this._up),this._markViewDirty())},T._compareAndSetView=function(i,t){"number"==typeof i[0]&&isFinite(i[0])&&"number"==typeof i[1]&&isFinite(i[1])&&"number"==typeof i[2]&&isFinite(i[2])?u.exactEquals(i,t)||(u.copy(t,i),this._markViewDirty()):e.getLogger("esri.views.3d.webgl-engine.lib.Camera").warn("Camera vector contains invalid number, ignoring value")},T._markViewDirty=function(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0},T._recomputeFrustum=function(){this._frustumDirty&&(v.fromMatrix(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)},T._ensureViewClean=function(){this._viewDirty&&(o.lookAt(this._viewMatrix,this.eye,this._center,this._up),u.set(this._viewForward,-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10]),u.set(this._viewUp,this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9]),u.set(this._viewRight,this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8]),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)},t._createClass(g,[{key:"pixelRatio",get:function(){return this._pixelRatio},set:function(i){this._pixelRatio=i>0?i:1}},{key:"eye",get:function(){return this._ray.origin},set:function(i){this._compareAndSetView(i,this._ray.origin)}},{key:"center",get:function(){return this._center},set:function(i){this._compareAndSetView(i,this._center)}},{key:"ray",get:function(){return u.subtract(this._ray.direction,this.center,this.eye),this._ray}},{key:"up",get:function(){return this._up},set:function(i){this._compareAndSetView(i,this._up)}},{key:"viewMatrix",get:function(){return this._ensureViewClean(),this._viewMatrix},set:function(i){o.copy(this._viewMatrix,i),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}},{key:"viewForward",get:function(){return this._ensureViewClean(),this._viewForward}},{key:"viewUp",get:function(){return this._ensureViewClean(),this._viewUp}},{key:"viewRight",get:function(){return this._ensureViewClean(),this._viewRight}},{key:"nearFar",get:function(){return this._nearFar}},{key:"near",get:function(){return this._nearFar[0]},set:function(i){this._nearFar[0]!==i&&(this._nearFar[0]=i,this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}},{key:"far",get:function(){return this._nearFar[1]},set:function(i){this._nearFar[1]!==i&&(this._nearFar[1]=i,this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}},{key:"viewport",get:function(){return this._viewport},set:function(i){this.x=i[0],this.y=i[1],this.width=i[2],this.height=i[3]}},{key:"x",get:function(){return this._viewport[0]},set:function(t){t+=this._padding[i.PaddingSide.LEFT],this._viewport[0]!==t&&(this._viewport[0]=t,this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}},{key:"y",get:function(){return this._viewport[1]},set:function(t){t+=this._padding[i.PaddingSide.BOTTOM],this._viewport[1]!==t&&(this._viewport[1]=t,this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}},{key:"width",get:function(){return this._viewport[2]},set:function(i){this._viewport[2]!==i&&(this._viewport[2]=i,this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}},{key:"height",get:function(){return this._viewport[3]},set:function(i){this._viewport[3]!==i&&(this._viewport[3]=i,this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}},{key:"fullWidth",get:function(){return this._viewport[2]+this._padding[i.PaddingSide.RIGHT]+this._padding[i.PaddingSide.LEFT]},set:function(t){this.width=t-(this._padding[i.PaddingSide.RIGHT]+this._padding[i.PaddingSide.LEFT])}},{key:"fullHeight",get:function(){return this._viewport[3]+this._padding[i.PaddingSide.TOP]+this._padding[i.PaddingSide.BOTTOM]},set:function(t){this.height=t-(this._padding[i.PaddingSide.TOP]+this._padding[i.PaddingSide.BOTTOM])}},{key:"fullViewport",get:function(){return this._fullViewport[0]=this._viewport[0]-this._padding[i.PaddingSide.LEFT],this._fullViewport[1]=this._viewport[1]-this._padding[i.PaddingSide.BOTTOM],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}},{key:"aspect",get:function(){return this.width/this.height}},{key:"padding",get:function(){return this._padding},set:function(t){this._padding[i.PaddingSide.TOP]===t[i.PaddingSide.TOP]&&this._padding[i.PaddingSide.RIGHT]===t[i.PaddingSide.RIGHT]&&this._padding[i.PaddingSide.BOTTOM]===t[i.PaddingSide.BOTTOM]&&this._padding[i.PaddingSide.LEFT]===t[i.PaddingSide.LEFT]||(this._viewport[0]+=t[i.PaddingSide.LEFT]-this._padding[i.PaddingSide.LEFT],this._viewport[1]+=t[i.PaddingSide.BOTTOM]-this._padding[i.PaddingSide.BOTTOM],this._viewport[2]-=t[i.PaddingSide.RIGHT]+t[i.PaddingSide.LEFT]-(this._padding[i.PaddingSide.RIGHT]+this._padding[i.PaddingSide.LEFT]),this._viewport[3]-=t[i.PaddingSide.TOP]+t[i.PaddingSide.BOTTOM]-(this._padding[i.PaddingSide.TOP]+this._padding[i.PaddingSide.BOTTOM]),d.copy(this._padding,t),this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}},{key:"viewProjectionMatrix",get:function(){return this._viewProjectionDirty&&(o.multiply(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}},{key:"projectionMatrix",get:function(){if(this._projectionDirty){const t=this.width,e=this.height,r=this.near*Math.tan(this.fovY/2),n=r*this.aspect;o.frustum(this._projectionMatrix,-n*(1+2*this._padding[i.PaddingSide.LEFT]/t),n*(1+2*this._padding[i.PaddingSide.RIGHT]/t),-r*(1+2*this._padding[i.PaddingSide.BOTTOM]/e),r*(1+2*this._padding[i.PaddingSide.TOP]/e),this.near,this.far),this._projectionDirty=!1}return this._projectionMatrix},set:function(i){o.copy(this._projectionMatrix,i),this._projectionDirty=!1,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}},{key:"inverseProjectionMatrix",get:function(){return n.isNone(this._inverseProjectionMatrix)&&(this._inverseProjectionMatrix=h.create()),this._inverseProjectionDirty&&o.invert(this._inverseProjectionMatrix,this.projectionMatrix),this._inverseProjectionMatrix}},{key:"fov",get:function(){return this._fov},set:function(i){this._fov=i,this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}},{key:"fovX",get:function(){return w.fovd2fovx(this._fov,this.width,this.height)},set:function(i){this._fov=w.fovx2fovd(i,this.width,this.height),this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}},{key:"fovY",get:function(){return w.fovd2fovy(this._fov,this.width,this.height)},set:function(i){this._fov=w.fovy2fovd(i,this.width,this.height),this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}},{key:"distance",get:function(){return u.distance(this._center,this.eye)}},{key:"frustum",get:function(){return this._recomputeFrustum(),this._frustum}},{key:"viewInverseTransposeMatrix",get:function(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&(o.invert(this._viewInverseTransposeMatrix,this.viewMatrix),o.transpose(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}},{key:"perRenderPixelRatio",get:function(){return Math.tan(this.fovX/2)/(this.width/2)}},{key:"perScreenPixelRatio",get:function(){return this.perRenderPixelRatio*this._pixelRatio}},{key:"aboveGround",get:function(){return null!=this.relativeElevation&&this.relativeElevation>=0}}]),g}();const P=p.create(),x=h.create(),D=_.create(),M=_.create(),m=s.createRenderScreenPointArray3();var T;i.PaddingSide=void 0,(T=i.PaddingSide||(i.PaddingSide={}))[T.TOP=0]="TOP",T[T.RIGHT=1]="RIGHT",T[T.BOTTOM=2]="BOTTOM",T[T.LEFT=3]="LEFT",i.Camera=g,Object.defineProperties(i,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
