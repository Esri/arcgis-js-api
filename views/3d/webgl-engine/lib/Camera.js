// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","../../../../core/mathUtils","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec2","../../../../core/libs/gl-matrix-2/vec2f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../core/libs/gl-matrix-2/vec4","../../../../core/libs/gl-matrix-2/vec4f64","../../support/geometryUtils","../../support/mathUtils","../../support/geometryUtils/vector","./Util"],(function(t,e,i,r,o,n,s,a,h,c,p,u,v,_,f,l){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var y=function(){function t(t,e,i){void 0===t&&(t=c.vec3f64.create()),void 0===e&&(e=c.vec3f64.create()),void 0===i&&(i=c.vec3f64.fromValues(0,0,1)),this._viewUp=c.vec3f64.create(),this._viewForward=c.vec3f64.create(),this._viewRight=c.vec3f64.create(),this._ray=v.ray.createWrapper(),this._viewport=u.vec4f64.fromValues(0,0,1,1),this._padding=u.vec4f64.fromValues(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=a.vec2f64.fromValues(1,1e3),this._viewDirty=!0,this._viewMatrix=n.mat4f64.create(),this._projectionDirty=!0,this._projectionMatrix=n.mat4f64.create(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=n.mat4f64.create(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=n.mat4f64.create(),this._frustumDirty=!0,this._frustum=v.frustum.create(),this._fullViewport=null,this.pixelRatio=1,this.relativeElevation=0,this._eye=c.vec3f64.clone(t),this._center=c.vec3f64.clone(e),this._up=c.vec3f64.clone(i),this._padding=u.vec4f64.create()}return Object.defineProperty(t.prototype,"eye",{get:function(){return this._eye},set:function(t){this._compareAndSetView(t,this._eye)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"center",{get:function(){return this._center},set:function(t){this._compareAndSetView(t,this._center)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"ray",{get:function(){return this._ray.origin=this.eye,this._ray.direction||(this._ray.direction=c.vec3f64.create()),h.vec3.subtract(this._ray.direction,this.center,this.eye),this._ray},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"up",{get:function(){return this._up},set:function(t){this._compareAndSetView(t,this._up)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"viewMatrix",{get:function(){return this._ensureViewClean(),this._viewMatrix},set:function(t){o.mat4.copy(this._viewMatrix,t),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"viewForward",{get:function(){return this._ensureViewClean(),this._viewForward},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"viewUp",{get:function(){return this._ensureViewClean(),this._viewUp},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"viewRight",{get:function(){return this._ensureViewClean(),this._viewRight},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"nearFar",{get:function(){return this._nearFar},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"near",{get:function(){return this._nearFar[0]},set:function(t){this._nearFar[0]!==t&&(this._nearFar[0]=t,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"far",{get:function(){return this._nearFar[1]},set:function(t){this._nearFar[1]!==t&&(this._nearFar[1]=t,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"viewport",{get:function(){return this._viewport},set:function(t){this.x=t[0],this.y=t[1],this.width=t[2],this.height=t[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"x",{get:function(){return this._viewport[0]},set:function(t){t+=this._padding[3],this._viewport[0]!==t&&(this._viewport[0]=t,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return this._viewport[1]},set:function(t){t+=this._padding[2],this._viewport[1]!==t&&(this._viewport[1]=t,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"width",{get:function(){return this._viewport[2]},set:function(t){this._viewport[2]!==t&&(this._viewport[2]=t,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return this._viewport[3]},set:function(t){this._viewport[3]!==t&&(this._viewport[3]=t,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"fullWidth",{get:function(){return this._viewport[2]+this._padding[1]+this._padding[3]},set:function(t){this.width=t-(this._padding[1]+this._padding[3])},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"fullHeight",{get:function(){return this._viewport[3]+this._padding[0]+this._padding[2]},set:function(t){this.height=t-(this._padding[0]+this._padding[2])},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"fullViewport",{get:function(){return this._fullViewport||(this._fullViewport=u.vec4f64.create()),this._fullViewport[0]=this._viewport[0]-this._padding[3],this._fullViewport[1]=this._viewport[1]-this._padding[2],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"aspect",{get:function(){return this.width/this.height},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"padding",{get:function(){return this._padding},set:function(t){this._padding[0]===t[0]&&this._padding[1]===t[1]&&this._padding[2]===t[2]&&this._padding[3]===t[3]||(this._viewport[0]+=t[3]-this._padding[3],this._viewport[1]+=t[2]-this._padding[2],this._viewport[2]-=t[1]+t[3]-(this._padding[1]+this._padding[3]),this._viewport[3]-=t[0]+t[2]-(this._padding[0]+this._padding[2]),p.vec4.copy(this._padding,t),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"viewProjectionMatrix",{get:function(){return this._viewProjectionDirty&&(o.mat4.multiply(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"projectionMatrix",{get:function(){if(this._projectionDirty){var t=this.width,e=this.height,i=this.near*Math.tan(this.fovY/2),r=i*this.aspect;o.mat4.frustum(this._projectionMatrix,-r*(1+2*this._padding[3]/t),r*(1+2*this._padding[1]/t),-i*(1+2*this._padding[2]/e),i*(1+2*this._padding[0]/e),this.near,this.far),this._projectionDirty=!1}return this._projectionMatrix},set:function(t){o.mat4.copy(this._projectionMatrix,t),this._projectionDirty=!1,this._viewProjectionDirty=!0,this._frustumDirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"fov",{get:function(){return this._fov},set:function(t){this._fov=t,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"fovX",{get:function(){return l.fovd2fovx(this._fov,this.width,this.height)},set:function(t){this._fov=l.fovx2fovd(t,this.width,this.height),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"fovY",{get:function(){return l.fovd2fovy(this._fov,this.width,this.height)},set:function(t){this._fov=l.fovy2fovd(t,this.width,this.height),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"distance",{get:function(){return h.vec3.distance(this._center,this._eye)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"frustum",{get:function(){return this._recomputeFrustum(),this._frustum},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"viewInverseTransposeMatrix",{get:function(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&(this._viewInverseTransposeMatrix||(this._viewInverseTransposeMatrix=n.mat4f64.create()),o.mat4.invert(this._viewInverseTransposeMatrix,this.viewMatrix),o.mat4.transpose(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix},enumerable:!1,configurable:!0}),t.prototype.depthNDCToWorld=function(t){var e=2*t-1;return 2*this.near*this.far/(this.far+this.near-e*(this.far-this.near))},Object.defineProperty(t.prototype,"perRenderPixelRatio",{get:function(){return Math.tan(this.fovX/2)/(this.width/2)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"perScreenPixelRatio",{get:function(){return this.perRenderPixelRatio*this.pixelRatio},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"aboveGround",{get:function(){return this.relativeElevation&&this.relativeElevation>=0},enumerable:!1,configurable:!0}),t.prototype.copyFrom=function(t){var e=t;return h.vec3.copy(this._eye,e._eye),h.vec3.copy(this._center,e._center),h.vec3.copy(this._up,e._up),p.vec4.copy(this._viewport,e._viewport),p.vec4.copy(this._padding,e._padding),s.vec2.copy(this._nearFar,e._nearFar),this._fov=e._fov,this.relativeElevation=t.relativeElevation,this._viewDirty=e._viewDirty,this._viewDirty||(o.mat4.copy(this._viewMatrix,e._viewMatrix),h.vec3.copy(this._viewRight,e._viewRight),h.vec3.copy(this._viewUp,e._viewUp),h.vec3.copy(this._viewForward,e._viewForward)),e._projectionDirty?this._projectionDirty=!0:(o.mat4.copy(this._projectionMatrix,e._projectionMatrix),this._projectionDirty=!1),this._viewProjectionDirty=!0,this._frustumDirty=e._frustumDirty,this._frustumDirty||(v.frustum.copy(e._frustum,this._frustum),this._frustumDirty=!1),e._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:(this._viewInverseTransposeMatrix?o.mat4.copy(this._viewInverseTransposeMatrix,e._viewInverseTransposeMatrix):this._viewInverseTransposeMatrix=n.mat4f64.clone(e._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),e._fullViewport?this._fullViewport?p.vec4.copy(this._fullViewport,e._fullViewport):this._fullViewport=u.vec4f64.clone(e._fullViewport):this._fullViewport=null,this.pixelRatio=t.pixelRatio,this},t.prototype.copyViewFrom=function(t){this.eye=t.eye,this.center=t.center,this.up=t.up},t.prototype.clone=function(){var e=new t;return e.copyFrom(this),e},t.prototype.equals=function(t){return h.vec3.exactEquals(this._eye,t._eye)&&h.vec3.exactEquals(this._center,t._center)&&h.vec3.exactEquals(this._up,t._up)&&p.vec4.exactEquals(this._viewport,t._viewport)&&p.vec4.exactEquals(this._padding,t._padding)&&s.vec2.exactEquals(this._nearFar,t._nearFar)&&this._fov===t._fov&&this.pixelRatio===t.pixelRatio&&this.relativeElevation===t.relativeElevation},t.prototype.almostEquals=function(t){if(this.pixelRatio!==t.pixelRatio||Math.abs(t._fov-this._fov)>=.001)return!1;h.vec3.sub(g,t._eye,t._center),h.vec3.sub(m,this._eye,this._center);var e=h.vec3.dot(g,m),i=h.vec3.sqrLen(g),r=h.vec3.sqrLen(m);return e*e>=(1-1e-10)*i*r&&h.vec3.sqrDist(t._eye,this._eye)<5e-4*Math.max(i,r)*5e-4&&p.vec4.squaredDistance(t._padding,this._padding)<.5&&p.vec4.squaredDistance(t._viewport,this._viewport)<.5},t.prototype.markViewDirty=function(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0},t.prototype.computeRenderPixelSizeAt=function(t){return this.computeRenderPixelSizeAtDist(this.viewDirectionDistance(t))},t.prototype.computeRenderPixelSizeAtDist=function(t){return t*this.perRenderPixelRatio},t.prototype.computeScreenPixelSizeAt=function(t){return this.computeScreenPixelSizeAtDist(this.viewDirectionDistance(t))},t.prototype.viewDirectionDistance=function(t){return Math.abs(f.projectPointSignedLength(this.viewForward,h.vec3.subtract(g,t,this._eye)))},t.prototype.computeScreenPixelSizeAtDist=function(t){return t*this.perScreenPixelRatio},t.prototype.computeDistanceFromRadius=function(t,e){return t/Math.tan(Math.min(this.fovX,this.fovY)/(2*(e||1)))},t.prototype.getScreenCenter=function(t){return void 0===t&&(t=r.createScreenPointArray()),t[0]=(this.padding[3]+this.width/2)/this.pixelRatio,t[1]=(this.padding[0]+this.height/2)/this.pixelRatio,t},t.prototype.getRenderCenter=function(t,e,i){return void 0===e&&(e=.5),void 0===i&&(i=.5),t||(t=r.createRenderScreenPointArray3()),t[0]=this.padding[3]+this.width*e,t[1]=this.padding[2]+this.height*i,t.length>2&&(t[2]=.5),t},t.prototype.setGLViewport=function(t){var e=this.viewport,i=this.padding;t.setViewport(e[0]-i[3],e[1]-i[2],e[2]+i[1]+i[3],e[3]+i[0]+i[2])},t.prototype.applyProjection=function(t,e,r){void 0===r&&(r=!1),t!==d&&h.vec3.copy(d,t),d[3]=1,r&&(e[2]=-d[2]),p.vec4.transformMat4(d,d,this.projectionMatrix),h.vec3.scale(d,d,1/Math.abs(d[3]));var o=this.fullViewport;return e[0]=i.lerp(0,o[0]+o[2],.5+.5*d[0]),e[1]=i.lerp(0,o[1]+o[3],.5+.5*d[1]),r||(e[2]=.5*(d[2]+1)),e},t.prototype.projectPoint=function(t,e){if(d[0]=t[0],d[1]=t[1],d[2]=t[2],d[3]=1,p.vec4.transformMat4(d,d,this.viewProjectionMatrix),0===d[3])return null;h.vec3.scale(d,d,1/Math.abs(d[3]));var r=this.fullViewport;return"x"in e?(e.x=i.lerp(0,r[0]+r[2],.5+.5*d[0]),e.y=i.lerp(0,r[1]+r[3],.5+.5*d[1])):(e[0]=i.lerp(0,r[0]+r[2],.5+.5*d[0]),e[1]=i.lerp(0,r[1]+r[3],.5+.5*d[1]),e.length>2&&(e[2]=.5*(d[2]+1))),e},t.prototype.unprojectPoint=function(t,e){if(o.mat4.multiply(w,this.projectionMatrix,this.viewMatrix),!o.mat4.invert(w,w))return null;var i=this.fullViewport;return d[0]=2*(t[0]-i[0])/i[2]-1,d[1]=2*(t[1]-i[1])/i[3]-1,d[2]=2*t[2]-1,d[3]=1,p.vec4.transformMat4(d,d,w),0===d[3]?null:(e[0]=d[0]/d[3],e[1]=d[1]/d[3],e[2]=d[2]/d[3],e)},t.prototype.computeUp=function(t){1===t?this.computeUpGlobal():this.computeUpLocal()},t.prototype.screenToRender=function(t,e){var i=t[0]*this.pixelRatio,r=this.fullHeight-t[1]*this.pixelRatio;return e[0]=i,e[1]=r,e},t.prototype.renderToScreen=function(t,e){var i=t[0]/this.pixelRatio,r=(this.fullHeight-t[1])/this.pixelRatio;return e[0]=i,e[1]=r,e},t.prototype.computeUpGlobal=function(){h.vec3.subtract(g,this.center,this.eye);var t=h.vec3.length(this.center);t<1?(h.vec3.set(this.up,0,0,1),this.markViewDirty()):Math.abs(h.vec3.dot(g,this.center))>.9999*h.vec3.length(g)*t||(h.vec3.cross(this.up,g,this.center),h.vec3.cross(this.up,this.up,g),h.vec3.normalize(this.up,this.up),this.markViewDirty())},t.prototype.computeUpLocal=function(){_.directionFromTo(g,this.eye,this.center),Math.abs(g[2])<=.9999&&(h.vec3.scale(g,g,g[2]),h.vec3.set(this.up,-g[0],-g[1],1-g[2]),h.vec3.normalize(this.up,this.up),this.markViewDirty())},t.prototype._compareAndSetView=function(t,e){h.vec3.exactEquals(t,e)||(h.vec3.copy(e,t),this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0)},t.prototype._recomputeFrustum=function(){this._frustumDirty&&(v.frustum.fromMatrix(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)},t.prototype._ensureViewClean=function(){this._viewDirty&&(o.mat4.lookAt(this._viewMatrix,this._eye,this._center,this._up),h.vec3.set(this._viewForward,-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10]),h.vec3.set(this._viewUp,this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9]),h.vec3.set(this._viewRight,this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8]),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)},t}();e.default=y;var d=u.vec4f64.create(),w=n.mat4f64.create(),g=c.vec3f64.create(),m=c.vec3f64.create()}));