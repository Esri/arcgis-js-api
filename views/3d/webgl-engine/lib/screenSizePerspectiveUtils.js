// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","./Util"],function(e,t,a){function r(e){return new g(e,t.defaultDescription)}function i(e){var a=t.defaultDescription.curvatureDependent,r=t.defaultDescription.scaleStart,i=t.defaultDescription.scaleFallOffRange;return new g(e,{curvatureDependent:{min:{curvature:a.min.curvature,tiltAngle:a.min.tiltAngle,scaleFallOffFactor:h.curvatureDependent.min.scaleFallOffFactor},max:{curvature:a.max.curvature,tiltAngle:a.max.tiltAngle,scaleFallOffFactor:h.curvatureDependent.max.scaleFallOffFactor}},scaleStart:r,scaleFallOffRange:i,minPixelSize:h.minPixelSize})}function n(e){return Math.abs(e*e*e)}function l(e,t,a,r){void 0===r&&(r=P);var i=a.parameters,l=a.paddingPixelsOverride;return r.scale=Math.min(i.divisor/(t-i.offset),1),r.factor=n(e),r.minPixelSize=i.minPixelSize,r.paddingPixels=l,r}function c(e,t){return 0===e?t.minPixelSize:t.minPixelSize*(1+2*t.paddingPixels/e)}function o(e,t){return Math.max(a.lerp(e*t.scale,e,t.factor),c(e,t))}function s(e,t,r){void 0===r&&(r=[0,0]);var i=Math.min(Math.max(t.scale,c(e[1],t)/e[1]),1);return r[0]=a.lerp(e[0]*i,e[0],t.factor),r[1]=a.lerp(e[1]*i,e[1],t.factor),r}function u(e,t,a){var r=l(e,t,a);return r.minPixelSize=0,r.paddingPixels=0,o(1,r)}function f(e,t,a,r){return r.scale=u(e,t,a),r.factor=0,r.minPixelSize=a.parameters.minPixelSize,r.paddingPixels=a.paddingPixelsOverride,r}function d(e,t,a){void 0===a&&(a=[0,0]);var r=Math.min(Math.max(t.scale,c(e[1],t)/e[1]),1);return a[0]=e[0]*r,a[1]=e[1]*r,a}function p(e,t,a,r){return o(e,l(t,a,r))}function m(){return{camera:{distance:0,fovY:0},divisor:0,offset:0,minPixelSize:0,paddingPixels:0}}function v(e,t){return t.camera.distance=e.camera.distance,t.camera.fovY=e.camera.fovY,t.divisor=e.divisor,t.offset=e.offset,t.minPixelSize=e.minPixelSize,t}Object.defineProperty(t,"__esModule",{value:!0}),t.getSettings=r,t.getLabelSettings=i,t.perspectiveFactor=n,t.scaleFactor=l,t.applyScaleFactor=o,t.applyScaleFactorVec2=s,t.precomputeScale=u,t.precomputeScaleFactor=f,t.applyPrecomputedScaleFactorVec2=d,t.scale=p;var g=function(){function e(e,t,a,r){void 0===a&&(a=m()),this.viewingMode=e,this.description=t,this.parameters=a,this._paddingPixelsOverride=r,"local"===this.viewingMode?(this.coverageCompensation=this.surfaceCoverageCompensationLocal,this.calculateCurvatureDependentParameters=this.calculateCurvatureDependentParametersLocal):(this.coverageCompensation=this.surfaceCoverageCompensationGlobal,this.calculateCurvatureDependentParameters=this.calculateCurvatureDependentParametersGlobal)}return Object.defineProperty(e.prototype,"paddingPixelsOverride",{get:function(){return this._paddingPixelsOverride||this.parameters.paddingPixels},enumerable:!0,configurable:!0}),e.prototype.update=function(e){return this.parameters&&this.parameters.camera.fovY===e.fovY&&this.parameters.camera.distance===e.distance?!1:(this.calculateParameters(e,this.parameters),!0)},e.prototype.overridePadding=function(t){return t!==this.paddingPixelsOverride?new e(this.viewingMode,this.description,this.parameters,t):this},e.prototype.calculateParameters=function(e,t){var a=this.description,r=a.scaleStart,i=a.scaleFallOffRange,n=a.minPixelSize,l=e.fovY,c=e.distance,o=this.calculateCurvatureDependentParameters(e),s=this.coverageCompensation(e,o),u=o.tiltAngle,f=o.scaleFallOffFactor,d=Math.sin(u)*c,p=.5*Math.PI-u-l*(.5-r*s),m=d/Math.cos(p),v=p+l*i*s,g=d/Math.cos(v),h=(m-f*g)/(1-f);return t.camera.fovY=e.fovY,t.camera.distance=e.distance,t.offset=h,t.divisor=m-h,t.minPixelSize=n,t},e.prototype.calculateCurvatureDependentParametersLocal=function(e,t){return void 0===t&&(t=x),t.tiltAngle=this.description.curvatureDependent.min.tiltAngle,t.scaleFallOffFactor=this.description.curvatureDependent.min.scaleFallOffFactor,t},e.prototype.calculateCurvatureDependentParametersGlobal=function(e,t){void 0===t&&(t=x);var r=this.description.curvatureDependent,i=1+e.distance/F,n=Math.sqrt(i*i-1),l=[r.min.curvature,r.max.curvature],c=l[0],o=l[1],s=a.clamp((n-c)/(o-c),0,1),u=[r.min,r.max],f=u[0],d=u[1];return t.tiltAngle=a.lerp(f.tiltAngle,d.tiltAngle,s),t.scaleFallOffFactor=a.lerp(f.scaleFallOffFactor,d.scaleFallOffFactor,s),t},e.prototype.surfaceCoverageCompensationLocal=function(e,t){return(e.fovY-t.tiltAngle)/e.fovY},e.prototype.surfaceCoverageCompensationGlobal=function(e,t){var a=F*F,r=t.tiltAngle+.5*Math.PI,i=e.fovY,n=e.distance,l=n*n,c=l+a-2*Math.cos(r)*n*F,o=Math.sqrt(c),s=Math.sqrt(c-a),u=Math.acos(s/o)-Math.asin(F/(o/Math.sin(r)));return(u+.5*i)/i},e}();t.defaultDescription={curvatureDependent:{min:{curvature:a.deg2rad(10),tiltAngle:a.deg2rad(12),scaleFallOffFactor:.5},max:{curvature:a.deg2rad(70),tiltAngle:a.deg2rad(40),scaleFallOffFactor:.8}},scaleStart:.3,scaleFallOffRange:.65,minPixelSize:0};var h={curvatureDependent:{min:{scaleFallOffFactor:.7},max:{scaleFallOffFactor:.95}},minPixelSize:14};t.copyParameters=v;var P={scale:0,factor:0,minPixelSize:0,paddingPixels:0},x={tiltAngle:0,scaleFallOffFactor:0},F=6378137});