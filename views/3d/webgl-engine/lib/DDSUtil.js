/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import e from"../../../../core/Logger.js";import{isPowerOfTwo as t}from"../../../../core/mathUtils.js";import{TextureSamplingMode as r,CompressedTextureFormat as n}from"../../../webgl/enums.js";import{Texture as o}from"../../../webgl/Texture.js";const a=e.getLogger("esri.views.3d.webgl-engine.lib.DDSUtil"),i=542327876,s=131072,l=4;function u(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}function m(e){return String.fromCharCode(255&e,e>>8&255,e>>16&255,e>>24&255)}const c=u("DXT1"),h=u("DXT3"),p=u("DXT5"),d=31,g=0,f=1,C=2,w=3,D=4,_=7,T=20,A=21;function E(e,t,n){const{textureData:a,internalFormat:i,width:s,height:l}=S(n,t.hasMipmap);return t.samplingMode=a.levels.length>1?r.LINEAR_MIPMAP_LINEAR:r.LINEAR,t.hasMipmap=a.levels.length>1,t.internalFormat=i,t.width=s,t.height=l,new o(e,t,a)}function S(e,r){const o=new Int32Array(e,0,d);if(o[g]!==i)return a.error("Invalid magic number in DDS header"),null;if(!(o[T]&l))return a.error("Unsupported format, must contain a FourCC code"),null;const u=o[A];let E,S;switch(u){case c:E=8,S=n.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case h:E=16,S=n.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case p:E=16,S=n.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return a.error("Unsupported FourCC code:",m(u)),null}let M=1,R=o[D],x=o[w];0==(3&R)&&0==(3&x)||(a.warn("Rounding up compressed texture size to nearest multiple of 4."),R=R+3&-4,x=x+3&-4);const X=R,b=x;let I,v;o[C]&s&&!1!==r&&(M=Math.max(1,o[_])),1===M||t(R)&&t(x)||(a.warn("Ignoring mipmaps of non power of two sized compressed texture."),M=1);let F=o[f]+4;const L=[];for(let t=0;t<M;++t)v=(R+3>>2)*(x+3>>2)*E,I=new Uint8Array(e,F,v),L.push(I),F+=v,R=Math.max(1,R>>1),x=Math.max(1,x>>1);return{textureData:{type:"compressed",levels:L},internalFormat:S,width:X,height:b}}export{E as createDDSTexture,S as createDDSTextureData};
