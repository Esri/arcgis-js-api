/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["require","exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/accessorSupport/decorators/property","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","../../../../support/requestImageUtils","./glUtil3D","./SMAATechnique","../../../../chunks/SMAA.glsl","../../../webgl/enums","../../../webgl/FramebufferObject","../../../webgl/Texture"],(function(e,t,r,i,s,o,a,n,h,u,l,d,c,T,_,p,b,g,x){"use strict";t.SmaaRenderPass=function(t){function i(e,r){var i;return(i=t.call(this,{})||this).rctx=e,i._techniqueRep=r,i._isEnabled=!1,i}r._inheritsLoose(i,t);var s=i.prototype;return s.normalizeCtorArgs=function(){return{}},s.dispose=function(){this._abortController=o.abortMaybe(this._abortController),this.disable()},s._loadResources=function(t){if(o.isSome(this._abortController))return!1;if(o.isSome(this._searchTexture))return!0;this._abortController=new AbortController;const r=this._abortController.signal;return new Promise(((t,r)=>e(["./SmaaRenderPassData"],t,r))).then((e=>this._loadTextures(e,r))).then((()=>t())).finally((()=>this._abortController=null)),!1},s._loadTextures=function(e,t){return a.throwIfAborted(t),Promise.all([this._loadTextureFromBase64(e.areaTexture,b.TextureSamplingMode.LINEAR,b.PixelFormat.RGB),this._loadTextureFromBase64(e.searchTexure,b.TextureSamplingMode.NEAREST,b.PixelFormat.LUMINANCE)]).then((([e,r])=>{a.isAborted(t)?(e.dispose(),r.dispose(),a.throwIfAborted(t)):(this._areaTexture=e,this._searchTexture=r)}))},s.enable=function(e){if(this._isEnabled)return!0;if(!this._edgeDetectTechnique||!this._blendWeightsTechnique||!this._blurTechnique){const e=new _.SMAATechniqueConfiguration,t=(e,t)=>this._techniqueRep.releaseAndAcquire(_.SMAATechnique,e,t);e.output=p.SMAAOutput.EdgeDetector,this._edgeDetectTechnique=t(e,this._edgeDetectTechnique),e.output=p.SMAAOutput.BlendWeight,this._blendWeightsTechnique=t(e,this._blendWeightsTechnique),e.output=p.SMAAOutput.Blur,this._blurTechnique=t(e,this._blurTechnique)}return!!this._loadResources(e)&&(this._vao=T.createScreenSizeTriangleVAO(this.rctx),this._edges=new g.FramebufferObject(this.rctx,{colorTarget:b.TargetType.TEXTURE,depthStencilTarget:b.DepthStencilTargetType.NONE},{target:b.TextureType.TEXTURE_2D,pixelFormat:b.PixelFormat.RGB,dataType:b.PixelType.UNSIGNED_BYTE,samplingMode:b.TextureSamplingMode.LINEAR,wrapMode:b.TextureWrapMode.CLAMP_TO_EDGE,width:4,height:4}),this._blend=new g.FramebufferObject(this.rctx,{colorTarget:b.TargetType.TEXTURE,depthStencilTarget:b.DepthStencilTargetType.NONE},{target:b.TextureType.TEXTURE_2D,pixelFormat:b.PixelFormat.RGBA,dataType:b.PixelType.UNSIGNED_BYTE,samplingMode:b.TextureSamplingMode.LINEAR,wrapMode:b.TextureWrapMode.CLAMP_TO_EDGE,width:4,height:4}),this._isEnabled=!0,!0)},s.disable=function(){this._isEnabled&&(this._vao=o.disposeMaybe(this._vao),this._areaTexture=o.disposeMaybe(this._areaTexture),this._searchTexture=o.disposeMaybe(this._searchTexture),this._blend=o.disposeMaybe(this._blend),this._edges=o.disposeMaybe(this._edges),this._isEnabled=!1)},s.render=function(e){if(!this._isEnabled)return;const t=this.rctx,r=t.getBoundFramebufferObject(),i={x:0,y:0,width:e.descriptor.width,height:e.descriptor.height};t.bindVAO(this._vao),t.setViewport(i.x,i.y,i.width,i.height),this._edges.resize(i.width,i.height),t.bindFramebuffer(this._edges),t.setClearColor(0,0,0,1),t.clear(b.ClearBufferBit.COLOR_BUFFER_BIT);const s=t.useTechnique(this._edgeDetectTechnique);s.bindTexture(e,"tColor"),s.setUniform4f("resolution",1/i.width,1/i.height,i.width,i.height),t.drawArrays(b.PrimitiveType.TRIANGLES,0,3),this._blend.resize(i.width,i.height),t.bindFramebuffer(this._blend),t.setClearColor(0,0,1,1),t.clear(b.ClearBufferBit.COLOR_BUFFER_BIT);const o=t.useTechnique(this._blendWeightsTechnique);o.setUniform4f("resolution",1/i.width,1/i.height,i.width,i.height),o.bindTexture(this._searchTexture,"tSearch"),o.bindTexture(this._areaTexture,"tArea"),o.bindTexture(this._edges.colorTexture,"tEdges"),t.drawArrays(b.PrimitiveType.TRIANGLES,0,3),t.bindFramebuffer(r),t.setClearColor(0,1,0,1),t.clear(b.ClearBufferBit.COLOR_BUFFER_BIT);const a=t.useTechnique(this._blurTechnique);a.setUniform4f("resolution",1/i.width,1/i.height,i.width,i.height),a.bindTexture(e,"tColor"),a.bindTexture(this._blend.colorTexture,"tBlendWeights"),t.drawArrays(b.PrimitiveType.TRIANGLES,0,3)},s._loadTextureFromBase64=function(e,t,r){const i=new x.Texture(this.rctx,{pixelFormat:r,dataType:b.PixelType.UNSIGNED_BYTE,wrapMode:b.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:t},null);return c.requestImage(e).then((e=>(i.resize(e.width,e.height),i.setData(e),i)))},r._createClass(i,[{key:"updating",get:function(){return o.isSome(this._abortController)}}]),i}(s),i.__decorate([n.property()],t.SmaaRenderPass.prototype,"_abortController",void 0),i.__decorate([n.property({readOnly:!0})],t.SmaaRenderPass.prototype,"updating",null),t.SmaaRenderPass=i.__decorate([d.subclass("esri.views.3d.webgl-engine.lib.SmaaRenderPass")],t.SmaaRenderPass),Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
