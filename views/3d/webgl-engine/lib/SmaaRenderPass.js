/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["require","exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../support/requestImageUtils","./glUtil3D","./SMAATechnique","../../../webgl/FramebufferObject","../../../webgl/Texture"],(function(e,t,r,i,s,h,o,a){"use strict";let n=function(){function t(e,t){this.rctx=e,this._techniqueRep=t,this.resourceLoadingPromise=null,this.isEnabled=!1}var n=t.prototype;return n.loadResources=function(e){if(!this.data||!this.textureArea||!this.textureSearch){const t=this.resourceLoadingPromise||this.loadDataModule().then((()=>this.loadTextures()));return e&&t.then(e),this.resourceLoadingPromise||(this.resourceLoadingPromise=t,t.then((()=>this.resourceLoadingPromise=null))),!1}return!0},n.loadDataModule=function(){return this.data?Promise.resolve():new Promise((function(t,r){e(["./SmaaRenderPassData"],t,r)})).then((e=>{this.data=e}))},n.loadTextures=function(){return Promise.all([this.loadTextureFromBase64(this.data.areaTexture,9729,6407),this.loadTextureFromBase64(this.data.searchTexure,9728,6409)]).then((([e,t])=>{this.textureArea=e,this.textureSearch=t}))},n.enable=function(){if(this.isEnabled)return!0;if(!this._edgeDetectTechnique||!this._blendWeights||!this._blur){const e=new h.SMAATechniqueConfiguration,t=(e,t)=>this._techniqueRep.releaseAndAcquire(h.SMAATechnique,e,t);e.output=0,this._edgeDetectTechnique=t(e,this._edgeDetectTechnique),e.output=1,this._blendWeights=t(e,this._blendWeights),e.output=2,this._blur=t(e,this._blur)}return!!this.loadResources()&&(this.vao=s.createScreenSizeTriangleVAO(this.rctx),this.edges=new o(this.rctx,{colorTarget:0,depthStencilTarget:0},{target:3553,pixelFormat:6407,dataType:5121,samplingMode:9729,wrapMode:33071,width:4,height:4}),this.blend=new o(this.rctx,{colorTarget:0,depthStencilTarget:0},{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:4,height:4}),this.isEnabled=!0,!0)},n.disable=function(){this.isEnabled&&(this.vao.dispose(),this.vao=null,this.textureArea.dispose(),this.textureArea=null,this.textureSearch.dispose(),this.textureSearch=null,this.blend.dispose(),this.blend=null,this.edges.dispose(),this.edges=null,this.isEnabled=!1)},n.render=function(e){this.enable();const t=this.rctx,r=t.getBoundFramebufferObject(),i={x:0,y:0,width:e.colorTexture.descriptor.width,height:e.colorTexture.descriptor.height};t.bindVAO(this.vao),t.setPipelineState(this._edgeDetectTechnique.pipeline),t.setViewport(i.x,i.y,i.width,i.height),this.edges.resize(i.width,i.height),t.bindFramebuffer(this.edges),t.setClearColor(0,0,0,1),t.clear(16384),t.useProgram(this._edgeDetectTechnique.program),this._edgeDetectTechnique.program.bindTexture(e.colorTexture,"tColor"),this._edgeDetectTechnique.program.setUniform4f("uResolution",1/i.width,1/i.height,i.width,i.height),t.drawArrays(4,0,3),this.blend.resize(i.width,i.height),t.bindFramebuffer(this.blend),t.setClearColor(0,0,1,1),t.clear(16384),t.useProgram(this._blendWeights.program),this._blendWeights.program.setUniform4f("uResolution",1/i.width,1/i.height,i.width,i.height),this._blendWeights.program.bindTexture(this.textureSearch,"tSearch"),this._blendWeights.program.bindTexture(this.textureArea,"tArea"),this._blendWeights.program.bindTexture(this.edges.colorTexture,"tEdges"),t.drawArrays(4,0,3),t.bindFramebuffer(r),t.setClearColor(0,1,0,1),t.clear(16384),t.useProgram(this._blur.program),this._blur.program.setUniform4f("uResolution",1/i.width,1/i.height,i.width,i.height),this._blur.program.bindTexture(e.colorTexture,"tColor"),this._blur.program.bindTexture(this.blend.colorTexture,"tBlendWeights"),t.drawArrays(4,0,3)},n.loadTextureFromBase64=function(e,t,r){const s=new a(this.rctx,{pixelFormat:r,dataType:5121,wrapMode:33071,samplingMode:t},null);return i.requestImage(e).then((e=>(s.resize(e.width,e.height),s.setData(e),s)))},r._createClass(t,[{key:"isLoadingResources",get:function(){return null!=this.resourceLoadingPromise}}]),t}();t.SmaaRenderPass=n,Object.defineProperty(t,"__esModule",{value:!0})}));
