/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/arrayUtils","../../../../core/maybe","../../../../chunks/vec4f64","../../../webgl/BufferObject","../../../webgl/FramebufferObject","../../../../core/has","../../../webgl/enums","../../../webgl/RenderingContext","../../../../chunks/builtins","../../../webgl/Texture","../../../webgl/VertexArrayObject","./glUtil3D","../shaders/ShadowAccumulationTechnique","../../../webgl/Util"],(function(i,e,t,a,s,n,o,u,l,r,h,c,d,_,m,v){"use strict";const f=[s.fromValues(.01,0,.25,0),s.fromValues(.01,0,.25,1)],p=4e4,b=5e4,z=1/512;let g=function(){function i(i,e,a,n){this._techniqueRep=i,this._rctx=e,this._shadowAccumulator=a,this._requestRender=n,this._enabled=!1,this._vao=_.createQuadVAO(e),this._visualizationConfig=new m.ShadowAccumulationTechniqueConfiguration,this._visualizationConfig.pass=1,this._visualizationConfig.visualization=0,this._visualizeAccumulationTechnique=i.acquire(m.ShadowAccumulationTechnique,this._visualizationConfig);const o={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:f.length,height:1};this._colorRampTexture=new c(this._rctx,o,R(f)),this._visualizationParams={shadowAccumulationMap:this._accumulationTexture,sampleScale:0,colorRamp:this._colorRampTexture,rampSize:o.width,threshold:.5,bandSize:.1,colors:t.flatten([s.fromValues(0,1,0,.5),s.fromValues(1,0,0,.5)]),opacityFromElevation:1}}var n=i.prototype;return n.dispose=function(){this._stop(),this._vao=a.disposeMaybe(this._vao),this._visualizeAccumulationTechnique=a.disposeMaybe(this._visualizeAccumulationTechnique),this._colorRampTexture=a.disposeMaybe(this._colorRampTexture),this._shadowAccumulator=null},n.render=function(){this._isRenderingVisualization&&(this._sampleScale=1/this._computedSamples,this._rctx.bindVAO(this._vao),this._rctx.useProgram(this._visualizeAccumulationTechnique.program),this._visualizeAccumulationTechnique.bindPipelineState(this._rctx),this._visualizeAccumulationTechnique.bindPass(this._visualizationParams),this._rctx.drawArrays(this._visualizeAccumulationTechnique.primitiveType,0,v.vertexCount(this._vao,"geometry")))},n.setOptions=function(i){void 0!==i.enabled&&this._setEnabled(i.enabled),void 0!==i.gradientColorRamp&&this._setColorRamp(i.gradientColorRamp),void 0!==i.threshold&&(this._threshold=i.threshold),void 0!==i.thresholdColors&&this._setThresholdColors(i.thresholdColors),void 0!==i.visualization&&(this._visualization=i.visualization),void 0!==i.bandSize&&(this._bandSize=i.bandSize),void 0!==i.bandsEnabled&&(this._bandsEnabled=i.bandsEnabled)},n._setColorRamp=function(i){const e=i.length,t=R(i);this._colorRampTexture.resize(e,1),this._colorRampTexture.setData(t),this._visualizationParams.rampSize=e,this._requestRenderIfRunning()},n._setThresholdColors=function(i){const e=this._visualizationParams.colors,a=t.flatten(i);t.equals(e,a)||(this._visualizationParams.colors=a,this._requestRenderIfRunning())},n._setEnabled=function(i){i!==this._enabled&&(i?this._start():this._stop())},n._requestRenderIfRunning=function(){this._enabled&&this._requestRender()},n._start=function(){this._enabled=!0,this._requestRender()},n._stop=function(){this._enabled=!1,this._requestRender()},e._createClass(i,[{key:"opacityFromElevation",get:function(){return this._visualizationParams.opacityFromElevation},set:function(i){this._visualizationParams.opacityFromElevation=i}},{key:"_isRenderingVisualization",get:function(){return this._enabled&&this._computedSamples>0&&this.opacityFromElevation>z}},{key:"_computedSamples",get:function(){return this._shadowAccumulator.computedSamples}},{key:"_accumulationTexture",get:function(){return this._shadowAccumulator.accumulationTexture}},{key:"_sampleScale",get:function(){return this._visualizationParams.sampleScale},set:function(i){this._visualizationParams.sampleScale=i}},{key:"_threshold",get:function(){return this._visualizationParams.threshold},set:function(i){this._threshold!==i&&(this._visualizationParams.threshold=i,this._requestRenderIfRunning())}},{key:"_visualization",get:function(){return this._visualizationConfig.visualization},set:function(i){if(i===this._visualization)return;const e=this._visualizationConfig;e.visualization=i,this._visualizeAccumulationTechnique=this._techniqueRep.releaseAndAcquire(m.ShadowAccumulationTechnique,e,this._visualizeAccumulationTechnique),this._requestRenderIfRunning()}},{key:"_bandSize",get:function(){return this._visualizationParams.bandSize},set:function(i){i!==this._bandSize&&(this._visualizationParams.bandSize=i,this._requestRenderIfRunning())}},{key:"_bandsEnabled",get:function(){return this._visualizationConfig.bandsEnabled},set:function(i){if(i===this._bandsEnabled)return;const e=this._visualizationConfig;e.bandsEnabled=i,this._visualizeAccumulationTechnique=this._techniqueRep.releaseAndAcquire(m.ShadowAccumulationTechnique,e,this._visualizeAccumulationTechnique),this._requestRenderIfRunning()}}]),i}();function R(i){const e=i.length,t=new Uint8Array(4*e);for(let a=0;a<e;++a){const e=i[a];t[4*a+0]=255*e[0],t[4*a+1]=255*e[1],t[4*a+2]=255*e[2],t[4*a+3]=255*e[3]}return t}i.ShadowAccumulationRenderer=g,i.shadowAccumulationDisableElevationMax=b,i.shadowAccumulationDisableElevationMin=p,i.shadowAccumulationDisabledElevationThreshold=z,Object.defineProperty(i,"__esModule",{value:!0})}));
