/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{clamp as t,acosClamped as e,lerp as s}from"../../../../core/mathUtils.js";import{isSome as a,disposeMaybe as i}from"../../../../core/maybe.js";import{c as r}from"../../../../chunks/mat3f64.js";import{j as h,m as c,q as o,a as n,n as u}from"../../../../chunks/mat4.js";import{c as m}from"../../../../chunks/mat4f64.js";import{a as d,b as p,f as l,l as _,s as f,g as x,h as g,n as T,i as S,c as b}from"../../../../chunks/vec2.js";import{a as w}from"../../../../chunks/vec2f64.js";import{k as M,c as C,o as D,m as E,s as j}from"../../../../chunks/vec3.js";import{c as v}from"../../../../chunks/vec3f64.js";import{s as z,t as R}from"../../../../chunks/vec4.js";import{c as U}from"../../../../chunks/vec4f64.js";import{ViewingMode as F}from"../../../ViewingMode.js";import{Camera as y}from"./Camera.js";import{assert as N,logWithBase as O,verify as A,rayRay2D as k}from"./Util.js";import{TextureType as L,ClearBufferBit as P,PixelFormat as B,PixelType as G,TextureWrapMode as I,TextureSamplingMode as X,TargetType as H,DepthStencilTargetType as q}from"../../../webgl/enums.js";import{FramebufferObject as Y}from"../../../webgl/FramebufferObject.js";import{Texture as V}from"../../../webgl/Texture.js";import{getGpuMemoryUsage as W}from"../../../webgl/Util.js";var J;!function(t){t[t.Highlight=0]="Highlight",t[t.Default=1]="Default"}(J||(J={}));class K{constructor(){this.camera=new y,this.lightMat=m()}}class Q{constructor(t,e,s=0){this.rctx=t,this.viewingMode=e,this._enabled=!1,this._snapshots=new Array,this._textureSize=0,this.maxTextureSize=0,this.numCascades=1,this.maxNumCascades=4,this.splitSchemeLambda=0,this.warp=!0,this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=U(),this._cascades=[new K,new K,new K,new K],this.maxTextureSize=this.rctx.parameters.maxTextureSize,this.snapshotCount=s}get depthTexture(){return this._depthTexture}get textureSize(){return this._textureSize}get cascadeDistances(){return z(this._usedCascadeDistances,this._cascadeDistances[0],this.numCascades>1?this._cascadeDistances[1]:1/0,this.numCascades>2?this._cascadeDistances[2]:1/0,this.numCascades>3?this._cascadeDistances[3]:1/0)}dispose(){this._discardDepthTexture(),this._discardAllSnapshots()}set maxCascades(e){this.maxNumCascades=t(Math.floor(e),1,4)}get maxCascades(){return this.maxNumCascades}set enabled(t){this._enabled=t,t||(this._discardDepthTexture(),this._discardAllSnapshots())}get enabled(){return this._enabled}get ready(){return this._enabled&&a(this._depthTexture)}get snapshotCount(){return this._snapshots.length}set snapshotCount(t){const e=this._snapshots.length;if(t>e){const s=t-e;this._snapshots.length=t;for(let t=0;t<s;++t)this._snapshots[e+t]=null}else if(t<this.snapshotCount){const s=e-t;for(let e=0;e<s;++e)this._discardSnapshot(t+e);this._snapshots.length=t}}getSnapshot(t){return this.enabled?this._snapshots[t]:null}getCascades(){for(let t=0;t<this.numCascades;++t)dt[t]=this._cascades[t];return dt.length=this.numCascades,dt}start(t,e,s){N(this.enabled),this._textureSize=this._computeTextureSize(t.fullWidth,t.fullHeight),this._ensureDepthTexture();const{near:a,far:i}=this._clampNearFar(s);this._computeCascadeDistances(i,a),this._setupMatrices(t,e);const r=t.viewMatrix,h=t.projectionMatrix;for(let c=0;c<this.numCascades;++c)this._constructCascade(c,h,r,e);this.lastOrigin=null,this.clear()}finish(t){N(this.enabled),this.rctx.bindFramebuffer(t)}getShadowMapMatrices(t){if(!this.lastOrigin||!M(t,this.lastOrigin)){this.lastOrigin=this.lastOrigin||v(),C(this.lastOrigin,t);for(let e=0;e<this.numCascades;++e){h(pt,this._cascades[e].lightMat,t);for(let t=0;t<16;++t)lt[16*e+t]=pt[t]}}return lt}takeCascadeSnapshotTo(t,e){N(this.enabled);const s=this._ensureSnapshot(e);this._bindFbo();const a=this.rctx,i=a.bindTexture(s,V.TEXTURE_UNIT_FOR_UPDATES);a.gl.copyTexSubImage2D(L.TEXTURE_2D,0,t.camera.viewport[0],t.camera.viewport[1],t.camera.viewport[0],t.camera.viewport[1],t.camera.viewport[2],t.camera.viewport[3]),a.bindTexture(i,V.TEXTURE_UNIT_FOR_UPDATES)}clear(){const t=this.rctx;this._bindFbo(),t.setClearColor(1,1,1,1),t.clearSafe(P.COLOR_BUFFER_BIT|P.DEPTH_BUFFER_BIT)}_computeTextureSize(t,e){const s=.5*Math.log(t*t+e*e)*Math.LOG2E,a=.35,i=2**Math.round(s+a);return Math.min(this.maxTextureSize,2*i)}_ensureDepthTexture(){if(a(this._depthTexture)&&this._depthTexture.descriptor.width===this._textureSize)return;this._discardDepthTexture();const t={target:L.TEXTURE_2D,pixelFormat:B.RGBA,dataType:G.UNSIGNED_BYTE,wrapMode:I.CLAMP_TO_EDGE,samplingMode:X.NEAREST,flipped:!0,width:this._textureSize,height:this._textureSize};this._depthTexture=new V(this.rctx,t),this._fbo=new Y(this.rctx,{colorTarget:H.TEXTURE,depthStencilTarget:q.DEPTH_RENDER_BUFFER,width:this._textureSize,height:this._textureSize},this._depthTexture)}_ensureSnapshot(t){let e=this._snapshots[t];if(a(e)&&e.descriptor.width===this._textureSize)return e;this._discardSnapshot(t);const s={target:L.TEXTURE_2D,pixelFormat:B.RGBA,dataType:G.UNSIGNED_BYTE,wrapMode:I.CLAMP_TO_EDGE,samplingMode:X.NEAREST,flipped:!0,width:this._textureSize,height:this._textureSize};return e=new V(this.rctx,s),this._snapshots[t]=e,e}_discardDepthTexture(){this._fbo=i(this._fbo),this._depthTexture=i(this._depthTexture)}_discardSnapshot(t){this._snapshots[t]=i(this._snapshots[t])}_discardAllSnapshots(){for(let t=0;t<this.snapshotCount;++t)this._discardSnapshot(t)}_bindFbo(){const t=this.rctx;t.unbindTexture(this._depthTexture),t.bindFramebuffer(this._fbo)}_constructCascade(t,e,s,a){const i=this._cascades[t],r=-this._cascadeDistances[t],o=-this._cascadeDistances[t+1],n=(e[10]*r+e[14])/Math.abs(e[11]*r+e[15]),u=(e[10]*o+e[14])/Math.abs(e[11]*o+e[15]);N(n<u);for(let h=0;h<8;++h){z(et,h%4==0||h%4==3?-1:1,h%4==0||h%4==1?-1:1,h<4?n:u,1),R(st[h],et,tt);for(let t=0;t<3;++t)st[h][t]/=st[h][3]}D(mt,st[0]),h(Z,ut,mt),i.camera.viewMatrix=Z;for(let h=0;h<8;++h)E(st[h],st[h],i.camera.viewMatrix);C(at,st[0]),C(it,st[0]);for(let h=1;h<8;++h)for(let t=0;t<3;++t)at[t]=Math.min(at[t],st[h][t]),it[t]=Math.max(it[t],st[h][t]);at[2]-=200,it[2]+=200,i.camera.near=-it[2],i.camera.far=-at[2],this.warp?this._constructTrapezoidalProjection(s,a,i):this._constructOrthogonalProjection(i),c(i.lightMat,i.camera.projectionMatrix,i.camera.viewMatrix);const m=this._textureSize/2;i.camera.viewport[0]=t%2==0?0:m,i.camera.viewport[1]=0===Math.floor(t/2)?0:m,i.camera.viewport[2]=m,i.camera.viewport[3]=m}_constructOrthogonalProjection(t){o(t.camera.projectionMatrix,at[0],it[0],at[1],it[1],t.camera.near,t.camera.far)}_constructTrapezoidalProjection(t,s,a){const i=1/st[0][3],r=1/st[4][3];N(i<r);let h=i+Math.sqrt(i*r);const c=Math.sin(e(t[2]*s[0]+t[6]*s[1]+t[10]*s[2]));h/=c,Dt(st,h,c,rt,ht,ct,ot,nt),Ut(rt,ht,ot,nt,a.camera.projectionMatrix),a.camera.projectionMatrix[10]=2/(at[2]-it[2]),a.camera.projectionMatrix[14]=-(at[2]+it[2])/(at[2]-it[2])}_setupMatrices(t,e){c($,t.projectionMatrix,t.viewMatrix),n(tt,$);const s=this.viewingMode===F.Global?t.eye:j(mt,0,0,1);u(ut,[0,0,0],[-e[0],-e[1],-e[2]],s)}_clampNearFar(t){let{near:e,far:s}=t;return e<2&&(e=2),s<2&&(s=2),e>=s&&(e=2,s=4),{near:e,far:s}}_computeCascadeDistances(t,e){this.numCascades=Math.min(1+Math.floor(O(t/e,4)),this.maxNumCascades);const a=(t-e)/this.numCascades,i=(t/e)**(1/this.numCascades);let r=e,h=e;for(let c=0;c<this.numCascades+1;++c)this._cascadeDistances[c]=s(r,h,this.splitSchemeLambda),r*=i,h+=a}get gpuMemoryUsage(){return this._snapshots.reduce(((t,e)=>t+W(e)),this._fbo?.gpuMemoryUsage??0)}get test(){const t=this;return{maxNumCascades:this.maxNumCascades,cascades:this._cascades,textureSize:this._textureSize,set splitSchemeLambda(e){t.splitSchemeLambda=e},get splitSchemeLambda(){return t.splitSchemeLambda},set warp(e){t.warp=e},get warp(){return t.warp}}}}const Z=m(),$=m(),tt=m(),et=U(),st=[];for(let Ft=0;Ft<8;++Ft)st.push(U());const at=v(),it=v(),rt=w(),ht=w(),ct=w(),ot=w(),nt=w(),ut=m(),mt=v(),dt=[],pt=m(),lt=new Float32Array(64),_t=w(),ft=w(),xt=[w(),w(),w(),w()],gt=w(),Tt=w(),St=w(),bt=w(),wt=w(),Mt=w(),Ct=w();function Dt(t,e,s,a,i,r,h,c){d(_t,0,0);for(let d=0;d<4;++d)p(_t,_t,t[d]);l(_t,_t,.25),d(ft,0,0);for(let d=4;d<8;++d)p(ft,ft,t[d]);l(ft,ft,.25),_(xt[0],t[4],t[5],.5),_(xt[1],t[5],t[6],.5),_(xt[2],t[6],t[7],.5),_(xt[3],t[7],t[4],.5);let o=0,n=f(xt[0],_t);for(let d=1;d<4;++d){const t=f(xt[d],_t);t<n&&(n=t,o=d)}x(gt,xt[o],t[o+4]);const u=gt[0];let m,w;gt[0]=-gt[1],gt[1]=u,x(Tt,ft,_t),g(Tt,gt)<0&&T(gt,gt),_(gt,gt,Tt,s),S(gt,gt),m=w=g(x(St,t[0],_t),gt);for(let d=1;d<8;++d){const e=g(x(St,t[d],_t),gt);e<m?m=e:e>w&&(w=e)}b(a,_t),l(St,gt,m-e),p(a,a,St);let M=-1,C=1,D=0,E=0;for(let d=0;d<8;++d){x(bt,t[d],a),S(bt,bt);const e=gt[0]*bt[1]-gt[1]*bt[0];e>0?e>M&&(M=e,D=d):e<C&&(C=e,E=d)}A(M>0,"leftArea"),A(C<0,"rightArea"),l(wt,gt,m),p(wt,wt,_t),l(Mt,gt,w),p(Mt,Mt,_t),Ct[0]=-gt[1],Ct[1]=gt[0];const j=k(a,t[E],Mt,p(St,Mt,Ct),1,i),v=k(a,t[D],Mt,St,1,r),z=k(a,t[D],wt,p(St,wt,Ct),1,h),R=k(a,t[E],wt,St,1,c);A(j,"rayRay"),A(v,"rayRay"),A(z,"rayRay"),A(R,"rayRay")}function Et(t,e){return 3*e+t}const jt=w();function vt(t,e){return d(jt,t[e],t[e+3]),jt}const zt=w(),Rt=r();function Ut(t,e,s,a,i){x(zt,s,a),l(zt,zt,.5),Rt[0]=zt[0],Rt[1]=zt[1],Rt[2]=0,Rt[3]=zt[1],Rt[4]=-zt[0],Rt[5]=0,Rt[6]=zt[0]*zt[0]+zt[1]*zt[1],Rt[7]=zt[0]*zt[1]-zt[1]*zt[0],Rt[8]=1,Rt[Et(0,2)]=-g(vt(Rt,0),t),Rt[Et(1,2)]=-g(vt(Rt,1),t);let r=g(vt(Rt,0),s)+Rt[Et(0,2)],h=g(vt(Rt,1),s)+Rt[Et(1,2)],c=g(vt(Rt,0),a)+Rt[Et(0,2)],o=g(vt(Rt,1),a)+Rt[Et(1,2)];r=-(r+c)/(h+o),Rt[Et(0,0)]+=Rt[Et(1,0)]*r,Rt[Et(0,1)]+=Rt[Et(1,1)]*r,Rt[Et(0,2)]+=Rt[Et(1,2)]*r,r=1/(g(vt(Rt,0),s)+Rt[Et(0,2)]),h=1/(g(vt(Rt,1),s)+Rt[Et(1,2)]),Rt[Et(0,0)]*=r,Rt[Et(0,1)]*=r,Rt[Et(0,2)]*=r,Rt[Et(1,0)]*=h,Rt[Et(1,1)]*=h,Rt[Et(1,2)]*=h,Rt[Et(2,0)]=Rt[Et(1,0)],Rt[Et(2,1)]=Rt[Et(1,1)],Rt[Et(2,2)]=Rt[Et(1,2)],Rt[Et(1,2)]+=1,r=g(vt(Rt,1),e)+Rt[Et(1,2)],h=g(vt(Rt,2),e)+Rt[Et(2,2)],c=g(vt(Rt,1),s)+Rt[Et(1,2)],o=g(vt(Rt,2),s)+Rt[Et(2,2)],r=-.5*(r/h+c/o),Rt[Et(1,0)]+=Rt[Et(2,0)]*r,Rt[Et(1,1)]+=Rt[Et(2,1)]*r,Rt[Et(1,2)]+=Rt[Et(2,2)]*r,r=g(vt(Rt,1),e)+Rt[Et(1,2)],h=g(vt(Rt,2),e)+Rt[Et(2,2)],c=-h/r,Rt[Et(1,0)]*=c,Rt[Et(1,1)]*=c,Rt[Et(1,2)]*=c,i[0]=Rt[0],i[1]=Rt[1],i[2]=0,i[3]=Rt[2],i[4]=Rt[3],i[5]=Rt[4],i[6]=0,i[7]=Rt[5],i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=Rt[6],i[13]=Rt[7],i[14]=0,i[15]=Rt[8]}export{Q as ShadowMap,J as SnapshotSlot};
