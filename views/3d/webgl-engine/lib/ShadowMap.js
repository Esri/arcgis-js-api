/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/has","../../../../core/mathUtils","../../../../core/maybe","../../../../chunks/mat3f64","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec2","../../../../chunks/vec2f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../chunks/vec4","../../../../chunks/vec4f64","../../../ViewingMode","./Camera","./Util","../../../webgl/enums","../../../webgl/FramebufferObject","../../../webgl/Texture","../../../webgl/Util"],(function(e,t,a,s,r,i,c,n,o,h,u,d,_,l,p,m,f,x,T,g,S){"use strict";var y;e.SnapshotSlot=void 0,(y=e.SnapshotSlot||(e.SnapshotSlot={}))[y.Highlight=0]="Highlight",y[y.Default=1]="Default";let b=function(){this.camera=new m.Camera,this.lightMat=n.create()},M=function(){function e(e,t){this._rctx=e,this._viewingMode=t,this._enabled=!1,this._snapshots=new Array,this._textureSize=0,this._numCascades=1,this._maxNumCascades=4,this._splitSchemeLambda=0,this._warp=!0,this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=l.create(),this._cascades=[new b,new b,new b,new b],this._maxTextureSize=Math.min(a("esri-mobile")?2048:8192,this._rctx.parameters.maxTextureSize)}var i=e.prototype;return i.dispose=function(){this._discardDepthTexture(),this._discardAllSnapshots()},i.getSnapshot=function(e){return this.enabled?this._snapshots[e]:null},i.getCascades=function(){for(let e=0;e<this._numCascades;++e)B[e]=this._cascades[e];return B.length=this._numCascades,B},i.start=function(e,t,a){f.assert(this.enabled),this._textureSize=this._computeTextureSize(e.fullWidth,e.fullHeight),this._ensureDepthTexture();const{near:s,far:r}=this._clampNearFar(a);this._computeCascadeDistances(r,s),this._setupMatrices(e,t);const i=e.viewMatrix,c=e.projectionMatrix;for(let n=0;n<this._numCascades;++n)this._constructCascade(n,c,i,t);this._lastOrigin=null,this.clear()},i.finish=function(e){f.assert(this.enabled),this._rctx.bindFramebuffer(e)},i.getShadowMapMatrices=function(e){if(!this._lastOrigin||!u.exactEquals(e,this._lastOrigin)){this._lastOrigin=this._lastOrigin||d.create(),u.copy(this._lastOrigin,e);for(let t=0;t<this._numCascades;++t){c.translate(j,this._cascades[t].lightMat,e);for(let e=0;e<16;++e)L[16*t+e]=j[e]}}return L},i.takeCascadeSnapshotTo=function(e,t){f.assert(this.enabled);const a=this._ensureSnapshot(t);this._bindFbo();const s=this._rctx,r=s.bindTexture(a,g.Texture.TEXTURE_UNIT_FOR_UPDATES);s.gl.copyTexSubImage2D(x.TextureType.TEXTURE_2D,0,e.camera.viewport[0],e.camera.viewport[1],e.camera.viewport[0],e.camera.viewport[1],e.camera.viewport[2],e.camera.viewport[3]),s.bindTexture(r,g.Texture.TEXTURE_UNIT_FOR_UPDATES)},i.clear=function(){const e=this._rctx;this._bindFbo(),e.setClearColor(1,1,1,1),e.clearSafe(x.ClearBufferBit.COLOR_BUFFER_BIT|x.ClearBufferBit.DEPTH_BUFFER_BIT)},i._computeTextureSize=function(e,t){const a=.5*Math.log(e*e+t*t)*Math.LOG2E,s=.35,r=2**Math.round(a+s);return Math.min(this._maxTextureSize,2*r)},i._ensureDepthTexture=function(){if(r.isSome(this._depthTexture)&&this._depthTexture.descriptor.width===this._textureSize)return;this._discardDepthTexture();const e={target:x.TextureType.TEXTURE_2D,pixelFormat:x.PixelFormat.RGBA,dataType:x.PixelType.UNSIGNED_BYTE,wrapMode:x.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:x.TextureSamplingMode.NEAREST,flipped:!0,width:this._textureSize,height:this._textureSize};this._depthTexture=new g.Texture(this._rctx,e),this._fbo=new T.FramebufferObject(this._rctx,{colorTarget:x.TargetType.TEXTURE,depthStencilTarget:x.DepthStencilTargetType.DEPTH_RENDER_BUFFER,width:this._textureSize,height:this._textureSize},this._depthTexture)},i._ensureSnapshot=function(e){let t=this._snapshots[e];if(r.isSome(t)&&t.descriptor.width===this._textureSize)return t;this._discardSnapshot(e);const a={target:x.TextureType.TEXTURE_2D,pixelFormat:x.PixelFormat.RGBA,dataType:x.PixelType.UNSIGNED_BYTE,wrapMode:x.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:x.TextureSamplingMode.NEAREST,flipped:!0,width:this._textureSize,height:this._textureSize};return t=new g.Texture(this._rctx,a),this._snapshots[e]=t,t},i._discardDepthTexture=function(){this._fbo=r.disposeMaybe(this._fbo),this._depthTexture=r.disposeMaybe(this._depthTexture)},i._discardSnapshot=function(e){this._snapshots[e]=r.disposeMaybe(this._snapshots[e])},i._discardAllSnapshots=function(){for(let e=0;e<this._snapshots.length;++e)this._discardSnapshot(e);this._snapshots.length=0},i._bindFbo=function(){const e=this._rctx;e.unbindTexture(this._depthTexture),e.bindFramebuffer(this._fbo)},i._constructCascade=function(e,t,a,s){const r=this._cascades[e],i=-this._cascadeDistances[e],n=-this._cascadeDistances[e+1],o=(t[10]*i+t[14])/Math.abs(t[11]*i+t[15]),h=(t[10]*n+t[14])/Math.abs(t[11]*n+t[15]);f.assert(o<h);for(let c=0;c<8;++c){const e=c%4==0||c%4==3?-1:1,t=c%4==0||c%4==1?-1:1,a=c<4?o:h;_.set(v,e,t,a,1),_.transformMat4(E[c],v,C);for(let s=0;s<3;++s)E[c][s]/=E[c][3]}u.negate(P,E[0]),c.translate(w,A,P),r.camera.viewMatrix=w;for(let c=0;c<8;++c)u.transformMat4(E[c],E[c],r.camera.viewMatrix);u.copy(R,E[0]),u.copy(z,E[0]);for(let c=1;c<8;++c)for(let e=0;e<3;++e)R[e]=Math.min(R[e],E[c][e]),z[e]=Math.max(z[e],E[c][e]);R[2]-=200,z[2]+=200,r.camera.near=-z[2],r.camera.far=-R[2],this._warp?this._constructTrapezoidalProjection(a,s,r):this._constructOrthogonalProjection(r),c.multiply(r.lightMat,r.camera.projectionMatrix,r.camera.viewMatrix);const d=this._textureSize/2;r.camera.viewport[0]=e%2==0?0:d,r.camera.viewport[1]=0===Math.floor(e/2)?0:d,r.camera.viewport[2]=d,r.camera.viewport[3]=d},i._constructOrthogonalProjection=function(e){c.ortho(e.camera.projectionMatrix,R[0],z[0],R[1],z[1],e.camera.near,e.camera.far)},i._constructTrapezoidalProjection=function(e,t,a){const r=1/E[0][3],i=1/E[4][3];f.assert(r<i);let c=r+Math.sqrt(r*i);const n=Math.sin(s.acosClamped(e[2]*t[0]+e[6]*t[1]+e[10]*t[2]));c/=n,Q(E,c,n,F,k,U,O,N),se(F,k,O,N,a.camera.projectionMatrix),a.camera.projectionMatrix[10]=2/(R[2]-z[2]),a.camera.projectionMatrix[14]=-(R[2]+z[2])/(R[2]-z[2])},i._setupMatrices=function(e,t){c.multiply(D,e.projectionMatrix,e.viewMatrix),c.invert(C,D);const a=this._viewingMode===p.ViewingMode.Global?e.eye:u.set(P,0,0,1);c.lookAt(A,[0,0,0],[-t[0],-t[1],-t[2]],a)},i._clampNearFar=function(e){let{near:t,far:a}=e;return t<2&&(t=2),a<2&&(a=2),t>=a&&(t=2,a=4),{near:t,far:a}},i._computeCascadeDistances=function(e,t){this._numCascades=Math.min(1+Math.floor(f.logWithBase(e/t,4)),this._maxNumCascades);const a=(e-t)/this._numCascades,r=(e/t)**(1/this._numCascades);let i=t,c=t;for(let n=0;n<this._numCascades+1;++n)this._cascadeDistances[n]=s.lerp(i,c,this._splitSchemeLambda),i*=r,c+=a},t._createClass(e,[{key:"depthTexture",get:function(){return this._depthTexture}},{key:"textureSize",get:function(){return this._textureSize}},{key:"numCascades",get:function(){return this._numCascades}},{key:"cascadeDistances",get:function(){return _.set(this._usedCascadeDistances,this._cascadeDistances[0],this._numCascades>1?this._cascadeDistances[1]:1/0,this._numCascades>2?this._cascadeDistances[2]:1/0,this._numCascades>3?this._cascadeDistances[3]:1/0)}},{key:"maxCascades",get:function(){return this._maxNumCascades},set:function(e){this._maxNumCascades=s.clamp(Math.floor(e),1,4)}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e,e||(this._discardDepthTexture(),this._discardAllSnapshots())}},{key:"ready",get:function(){return this._enabled&&r.isSome(this._depthTexture)}},{key:"gpuMemoryUsage",get:function(){return this._snapshots.reduce(((e,t)=>e+S.getGpuMemoryUsage(t)),this._fbo?.gpuMemoryUsage??0)}},{key:"test",get:function(){const e=this;return{maxNumCascades:this._maxNumCascades,cascades:this._cascades,textureSize:this._textureSize,set splitSchemeLambda(t){e._splitSchemeLambda=t},get splitSchemeLambda(){return e._splitSchemeLambda},set warp(t){e._warp=t},get warp(){return e._warp}}}}]),e}();const w=n.create(),D=n.create(),C=n.create(),v=l.create(),E=[];for(let re=0;re<8;++re)E.push(l.create());const R=d.create(),z=d.create(),F=h.create(),k=h.create(),U=h.create(),O=h.create(),N=h.create(),A=n.create(),P=d.create(),B=[],j=n.create(),L=new Float32Array(64),G=h.create(),I=h.create(),H=[h.create(),h.create(),h.create(),h.create()],X=h.create(),q=h.create(),W=h.create(),V=h.create(),Y=h.create(),J=h.create(),K=h.create();function Q(e,t,a,s,r,i,c,n){o.set(G,0,0);for(let f=0;f<4;++f)o.add(G,G,e[f]);o.scale(G,G,.25),o.set(I,0,0);for(let f=4;f<8;++f)o.add(I,I,e[f]);o.scale(I,I,.25),o.lerp(H[0],e[4],e[5],.5),o.lerp(H[1],e[5],e[6],.5),o.lerp(H[2],e[6],e[7],.5),o.lerp(H[3],e[7],e[4],.5);let h=0,u=o.squaredDistance(H[0],G);for(let f=1;f<4;++f){const e=o.squaredDistance(H[f],G);e<u&&(u=e,h=f)}o.subtract(X,H[h],e[h+4]);const d=X[0];let _,l;X[0]=-X[1],X[1]=d,o.subtract(q,I,G),o.dot(q,X)<0&&o.negate(X,X),o.lerp(X,X,q,a),o.normalize(X,X),_=l=o.dot(o.subtract(W,e[0],G),X);for(let f=1;f<8;++f){const t=o.dot(o.subtract(W,e[f],G),X);t<_?_=t:t>l&&(l=t)}o.copy(s,G),o.scale(W,X,_-t),o.add(s,s,W);let p=-1,m=1,x=0,T=0;for(let f=0;f<8;++f){o.subtract(V,e[f],s),o.normalize(V,V);const t=X[0]*V[1]-X[1]*V[0];t>0?t>p&&(p=t,x=f):t<m&&(m=t,T=f)}f.verify(p>0,"leftArea"),f.verify(m<0,"rightArea"),o.scale(Y,X,_),o.add(Y,Y,G),o.scale(J,X,l),o.add(J,J,G),K[0]=-X[1],K[1]=X[0];const g=f.rayRay2D(s,e[T],J,o.add(W,J,K),1,r),S=f.rayRay2D(s,e[x],J,W,1,i),y=f.rayRay2D(s,e[x],Y,o.add(W,Y,K),1,c),b=f.rayRay2D(s,e[T],Y,W,1,n);f.verify(g,"rayRay"),f.verify(S,"rayRay"),f.verify(y,"rayRay"),f.verify(b,"rayRay")}function Z(e,t){return 3*t+e}const $=h.create();function ee(e,t){return o.set($,e[t],e[t+3]),$}const te=h.create(),ae=i.create();function se(e,t,a,s,r){o.subtract(te,a,s),o.scale(te,te,.5),ae[0]=te[0],ae[1]=te[1],ae[2]=0,ae[3]=te[1],ae[4]=-te[0],ae[5]=0,ae[6]=te[0]*te[0]+te[1]*te[1],ae[7]=te[0]*te[1]-te[1]*te[0],ae[8]=1,ae[Z(0,2)]=-o.dot(ee(ae,0),e),ae[Z(1,2)]=-o.dot(ee(ae,1),e);let i=o.dot(ee(ae,0),a)+ae[Z(0,2)],c=o.dot(ee(ae,1),a)+ae[Z(1,2)],n=o.dot(ee(ae,0),s)+ae[Z(0,2)],h=o.dot(ee(ae,1),s)+ae[Z(1,2)];i=-(i+n)/(c+h),ae[Z(0,0)]+=ae[Z(1,0)]*i,ae[Z(0,1)]+=ae[Z(1,1)]*i,ae[Z(0,2)]+=ae[Z(1,2)]*i,i=1/(o.dot(ee(ae,0),a)+ae[Z(0,2)]),c=1/(o.dot(ee(ae,1),a)+ae[Z(1,2)]),ae[Z(0,0)]*=i,ae[Z(0,1)]*=i,ae[Z(0,2)]*=i,ae[Z(1,0)]*=c,ae[Z(1,1)]*=c,ae[Z(1,2)]*=c,ae[Z(2,0)]=ae[Z(1,0)],ae[Z(2,1)]=ae[Z(1,1)],ae[Z(2,2)]=ae[Z(1,2)],ae[Z(1,2)]+=1,i=o.dot(ee(ae,1),t)+ae[Z(1,2)],c=o.dot(ee(ae,2),t)+ae[Z(2,2)],n=o.dot(ee(ae,1),a)+ae[Z(1,2)],h=o.dot(ee(ae,2),a)+ae[Z(2,2)],i=-.5*(i/c+n/h),ae[Z(1,0)]+=ae[Z(2,0)]*i,ae[Z(1,1)]+=ae[Z(2,1)]*i,ae[Z(1,2)]+=ae[Z(2,2)]*i,i=o.dot(ee(ae,1),t)+ae[Z(1,2)],c=o.dot(ee(ae,2),t)+ae[Z(2,2)],n=-c/i,ae[Z(1,0)]*=n,ae[Z(1,1)]*=n,ae[Z(1,2)]*=n,r[0]=ae[0],r[1]=ae[1],r[2]=0,r[3]=ae[2],r[4]=ae[3],r[5]=ae[4],r[6]=0,r[7]=ae[5],r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=ae[6],r[13]=ae[7],r[14]=0,r[15]=ae[8]}e.ShadowMap=M,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
