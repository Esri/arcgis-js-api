/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../core/mathUtils","../../../../chunks/vec3f64","../../../../chunks/vec3","../../../../chunks/mat4","../../../../chunks/mat3f64","../../../../chunks/mat4f64","../../../../chunks/vec2f64","../../../../chunks/vec4f64","../../../../chunks/vec2","../../../../chunks/vec4","./Util","../../../webgl/Texture","../../../webgl/Util","./glUtil3D","./Camera","./DefaultTextureUnits","../../../webgl/FramebufferObject"],(function(t,e,s,a,i,r,n,c,o,h,u,d,l,p,f,m,x,g){"use strict";let b=function(){this.camera=new m,this.lightMat=n.create()},M=function(){function r(t,e,s=0){this.rctx=t,this.viewingMode=e,this._enabled=!1,this.snapshots=[],this.textureSize=0,this.maxTextureSize=0,this.numCascades=1,this.maxNumCascades=4,this.splitSchemeLambda=0,this.warp=!0,this.cascadeDistances=[0,0,0,0,0],this.cascades=[],this.emptyTexture=f.createColorTexture(this.rctx,[1,1,1,1]),this.maxTextureSize=this.rctx.parameters.maxTextureSize;for(let a=0;a<4;++a)this.cascades.push(new b);this.snapshotCount=s}var n=r.prototype;return n.dispose=function(){this.emptyTexture.dispose(),this.emptyTexture=null,this.discardDepthTexture(),this.discardAllSnapshots()},n.getDepthTexture=function(){return this.depthTexture},n.getSnapshot=function(t){return this.snapshots[t]},n.getCascades=function(){for(let t=0;t<this.numCascades;++t)F[t]=this.cascades[t];return F.length=this.numCascades,F},n.prepare=function(t,e,s){d.assert(this.enabled),this.textureSize=this.computeTextureSize(t.fullWidth,t.fullHeight),this.assertDepthTexture();const{near:a,far:i}=this.clampNearFar(s);this.computeCascadeDistances(i,a),this.setupMatrices(t,e);const r=t.viewMatrix,n=t.projectionMatrix;for(let c=0;c<this.numCascades;++c)this.constructCascade(c,n,r,e);this.lastOrigin=null,this.clear()},n.finish=function(t){d.assert(this.enabled),this.rctx.bindFramebuffer(t)},n.bind=function(t,e=x.DefaultTextureUnits.SHADOW_MAP){const s=this.rctx;s.bindTexture(this.enabled?this.depthTexture:this.emptyTexture,e),s.bindProgram(t),t.setUniform1i("uShadowMapTex",e),this.setUniforms(t)},n.bindToAllPrograms=function(t){const e=t.getProgramsUsingUniform("uShadowMapDistance");for(let s=0;s<e.length;s++)this.bind(e[s],x.DefaultTextureUnits.SHADOW_MAP)},n.bindView=function(t,e){if(!this.enabled)return;const r=this.lastOrigin;if(!(r&&r[0]===e[0]&&r[1]===e[1]&&r[2]===e[2])){this.lastOrigin=this.lastOrigin||s.create(),a.copy(this.lastOrigin,e);for(let t=0;t<this.numCascades;++t){i.translate(_,this.cascades[t].lightMat,e);for(let e=0;e<16;++e)N[16*t+e]=_[e]}}t.setUniformMatrix4fv("uShadowMapMatrix",N)},n.setUniforms=function(t){this.rctx.bindProgram(t),t.setUniform1f("uDepthHalfPixelSz",this.enabled?.5/this.textureSize:-1),t.setUniform1i("uShadowMapNum",this.numCascades),t.setUniform4f("uShadowMapDistance",this.cascadeDistances[0],this.numCascades>1?this.cascadeDistances[1]:1/0,this.numCascades>2?this.cascadeDistances[2]:1/0,this.numCascades>3?this.cascadeDistances[3]:1/0)},n.bindSnapshot=function(t,e){this.rctx.bindTexture(this.enabled?this.snapshots[t]:this.emptyTexture,e)},n.takeCascadeSnapshotTo=function(t,e){d.assert(this.enabled);const s=this.rctx;this.assertSnapshot(e),this.bindFbo(),s.bindTexture(this.snapshots[e],x.DefaultTextureUnits.SHADOW_MAP),s.gl.copyTexSubImage2D(3553,0,t.camera.viewport[0],t.camera.viewport[1],t.camera.viewport[0],t.camera.viewport[1],t.camera.viewport[2],t.camera.viewport[3]),s.bindTexture(null,x.DefaultTextureUnits.SHADOW_MAP)},n.clear=function(){const t=this.rctx;this.bindFbo(),t.setClearColor(1,1,1,1),t.clearSafe(16640)},n.computeTextureSize=function(t,e){const s=.5*Math.log(t*t+e*e)*Math.LOG2E,a=.35,i=2**Math.round(s+a);return Math.min(this.maxTextureSize,2*i)},n.assertDepthTexture=function(){if(null!=this.depthTexture&&this.depthTexture.descriptor.width===this.textureSize)return;this.discardDepthTexture();const t={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0,width:this.textureSize,height:this.textureSize};this.depthTexture=new l(this.rctx,t),this.fbo=new g(this.rctx,{colorTarget:0,depthStencilTarget:1,width:this.textureSize,height:this.textureSize},this.depthTexture)},n.assertSnapshot=function(t){const e=this.snapshots[t];if(null!==e&&e.descriptor.width===this.textureSize)return;this.discardSnapshot(t);const s={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0,width:this.textureSize,height:this.textureSize};this.snapshots[t]=new l(this.rctx,s)},n.discardDepthTexture=function(){this.fbo&&(this.fbo.dispose(),this.fbo=null),this.depthTexture&&(this.depthTexture.dispose(),this.depthTexture=null)},n.discardSnapshot=function(t){this.snapshots[t]&&(this.snapshots[t].dispose(),this.snapshots[t]=null)},n.discardAllSnapshots=function(){for(let t=0;t<this.snapshotCount;++t)this.discardSnapshot(t)},n.bindFbo=function(){const t=this.rctx;t.bindFramebuffer(this.fbo),t.bindTexture(null,x.DefaultTextureUnits.SHADOW_MAP)},n.constructCascade=function(t,e,s,r){const n=this.cascades[t],c=-this.cascadeDistances[t],o=-this.cascadeDistances[t+1],h=(e[10]*c+e[14])/Math.abs(e[11]*c+e[15]),l=(e[10]*o+e[14])/Math.abs(e[11]*o+e[15]);d.assert(h<l);for(let a=0;a<8;++a){const t=a%4==0||a%4==3?-1:1,e=a%4==0||a%4==1?-1:1,s=a<4?h:l;u.set(w,t,e,s,1),u.transformMat4(D[a],w,y);for(let i=0;i<3;++i)D[a][i]/=D[a][3]}a.negate(j,D[0]),i.translate(S,O,j),n.camera.viewMatrix=S;for(let i=0;i<8;++i)a.transformMat4(D[i],D[i],n.camera.viewMatrix);a.copy(C,D[0]),a.copy(v,D[0]);for(let a=1;a<8;++a)for(let t=0;t<3;++t)C[t]=Math.min(C[t],D[a][t]),v[t]=Math.max(v[t],D[a][t]);C[2]-=200,v[2]+=200,n.camera.near=-v[2],n.camera.far=-C[2],this.warp?this.constructTrapezoidalProjection(s,r,n):this.constructOrthogonalProjection(n),i.multiply(n.lightMat,n.camera.projectionMatrix,n.camera.viewMatrix);const p=this.textureSize/2;n.camera.viewport[0]=t%2==0?0:p,n.camera.viewport[1]=0===Math.floor(t/2)?0:p,n.camera.viewport[2]=p,n.camera.viewport[3]=p},n.constructOrthogonalProjection=function(t){i.ortho(t.camera.projectionMatrix,C[0],v[0],C[1],v[1],t.camera.near,t.camera.far)},n.constructTrapezoidalProjection=function(t,s,a){const i=1/D[0][3],r=1/D[4][3];d.assert(i<r);let n=i+Math.sqrt(i*r);const c=Math.sin(e.acosClamped(t[2]*s[0]+t[6]*s[1]+t[10]*s[2]));n/=c,J(D,n,c,z,U,A,k,P),$(z,U,k,P,a.camera.projectionMatrix),a.camera.projectionMatrix[10]=2/(C[2]-v[2]),a.camera.projectionMatrix[14]=-(C[2]+v[2])/(C[2]-v[2])},n.setupMatrices=function(t,e){i.multiply(T,t.projectionMatrix,t.viewMatrix),i.invert(y,T);const s=1===this.viewingMode?t.eye:a.set(j,0,0,1);i.lookAt(O,[0,0,0],[-e[0],-e[1],-e[2]],s)},n.clampNearFar=function(t){let{near:e,far:s}=t;return e<2&&(e=2),s<2&&(s=2),e>=s&&(e=2,s=4),{near:e,far:s}},n.computeCascadeDistances=function(t,s){this.numCascades=Math.min(1+Math.floor(d.logWithBase(t/s,4)),this.maxNumCascades);const a=(t-s)/this.numCascades,i=(t/s)**(1/this.numCascades);let r=s,n=s;for(let c=0;c<this.numCascades+1;++c)this.cascadeDistances[c]=e.lerp(r,n,this.splitSchemeLambda),r*=i,n+=a},n.getGpuMemoryUsage=function(){return this.snapshots.reduce(((t,e)=>t+p.getGpuMemoryUsage(e)),p.getGpuMemoryUsage(this.fbo))},t._createClass(r,[{key:"maxCascades",get:function(){return this.maxNumCascades},set:function(t){this.maxNumCascades=e.clamp(Math.floor(t),1,4)}},{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t,t||(this.discardDepthTexture(),this.discardAllSnapshots())}},{key:"snapshotCount",get:function(){return this.snapshots.length},set:function(t){const e=this.snapshots.length;if(t>e){const s=t-e;this.snapshots.length=t;for(let t=0;t<s;++t)this.snapshots[e+t]=null}else if(t<this.snapshotCount){const s=e-t;for(let e=0;e<s;++e)this.discardSnapshot(t+e);this.snapshots.length=t}}},{key:"test",get:function(){const t=this;return{maxNumCascades:this.maxNumCascades,cascades:this.cascades,textureSize:this.textureSize,set splitSchemeLambda(e){t.splitSchemeLambda=e},get splitSchemeLambda(){return t.splitSchemeLambda},set warp(e){t.warp=e},get warp(){return t.warp}}}}]),r}();const S=n.create(),T=n.create(),y=n.create(),w=o.create(),D=[];for(let tt=0;tt<8;++tt)D.push(o.create());const C=s.create(),v=s.create(),z=c.create(),U=c.create(),A=c.create(),k=c.create(),P=c.create(),O=n.create(),j=s.create(),F=[],_=n.create(),N=new Float32Array(64),H=c.create(),R=c.create(),L=[c.create(),c.create(),c.create(),c.create()],W=c.create(),G=c.create(),q=c.create(),B=c.create(),E=c.create(),I=c.create(),V=c.create();function J(t,e,s,a,i,r,n,c){h.set(H,0,0);for(let d=0;d<4;++d)h.add(H,H,t[d]);h.scale(H,H,.25),h.set(R,0,0);for(let d=4;d<8;++d)h.add(R,R,t[d]);h.scale(R,R,.25),h.lerp(L[0],t[4],t[5],.5),h.lerp(L[1],t[5],t[6],.5),h.lerp(L[2],t[6],t[7],.5),h.lerp(L[3],t[7],t[4],.5);let o=0,u=h.squaredDistance(L[0],H);for(let d=1;d<4;++d){const t=h.squaredDistance(L[d],H);t<u&&(u=t,o=d)}h.subtract(W,L[o],t[o+4]);const l=W[0];let p,f;W[0]=-W[1],W[1]=l,h.subtract(G,R,H),h.dot(G,W)<0&&h.negate(W,W),h.lerp(W,W,G,s),h.normalize(W,W),p=f=h.dot(h.subtract(q,t[0],H),W);for(let d=1;d<8;++d){const e=h.dot(h.subtract(q,t[d],H),W);e<p?p=e:e>f&&(f=e)}h.copy(a,H),h.scale(q,W,p-e),h.add(a,a,q);let m=-1,x=1,g=0,b=0;for(let d=0;d<8;++d){h.subtract(B,t[d],a),h.normalize(B,B);const e=W[0]*B[1]-W[1]*B[0];e>0?e>m&&(m=e,g=d):e<x&&(x=e,b=d)}d.verify(m>0,"leftArea"),d.verify(x<0,"rightArea"),h.scale(E,W,p),h.add(E,E,H),h.scale(I,W,f),h.add(I,I,H),V[0]=-W[1],V[1]=W[0];const M=d.rayRay2D(a,t[b],I,h.add(q,I,V),1,i),S=d.rayRay2D(a,t[g],I,q,1,r),T=d.rayRay2D(a,t[g],E,h.add(q,E,V),1,n),y=d.rayRay2D(a,t[b],E,q,1,c);d.verify(M,"rayRay"),d.verify(S,"rayRay"),d.verify(T,"rayRay"),d.verify(y,"rayRay")}function K(t,e){return 3*e+t}const Q=c.create();function X(t,e){return h.set(Q,t[e],t[e+3]),Q}const Y=c.create(),Z=r.create();function $(t,e,s,a,i){h.subtract(Y,s,a),h.scale(Y,Y,.5),Z[0]=Y[0],Z[1]=Y[1],Z[2]=0,Z[3]=Y[1],Z[4]=-Y[0],Z[5]=0,Z[6]=Y[0]*Y[0]+Y[1]*Y[1],Z[7]=Y[0]*Y[1]-Y[1]*Y[0],Z[8]=1,Z[K(0,2)]=-h.dot(X(Z,0),t),Z[K(1,2)]=-h.dot(X(Z,1),t);let r=h.dot(X(Z,0),s)+Z[K(0,2)],n=h.dot(X(Z,1),s)+Z[K(1,2)],c=h.dot(X(Z,0),a)+Z[K(0,2)],o=h.dot(X(Z,1),a)+Z[K(1,2)];r=-(r+c)/(n+o),Z[K(0,0)]+=Z[K(1,0)]*r,Z[K(0,1)]+=Z[K(1,1)]*r,Z[K(0,2)]+=Z[K(1,2)]*r,r=1/(h.dot(X(Z,0),s)+Z[K(0,2)]),n=1/(h.dot(X(Z,1),s)+Z[K(1,2)]),Z[K(0,0)]*=r,Z[K(0,1)]*=r,Z[K(0,2)]*=r,Z[K(1,0)]*=n,Z[K(1,1)]*=n,Z[K(1,2)]*=n,Z[K(2,0)]=Z[K(1,0)],Z[K(2,1)]=Z[K(1,1)],Z[K(2,2)]=Z[K(1,2)],Z[K(1,2)]+=1,r=h.dot(X(Z,1),e)+Z[K(1,2)],n=h.dot(X(Z,2),e)+Z[K(2,2)],c=h.dot(X(Z,1),s)+Z[K(1,2)],o=h.dot(X(Z,2),s)+Z[K(2,2)],r=-.5*(r/n+c/o),Z[K(1,0)]+=Z[K(2,0)]*r,Z[K(1,1)]+=Z[K(2,1)]*r,Z[K(1,2)]+=Z[K(2,2)]*r,r=h.dot(X(Z,1),e)+Z[K(1,2)],n=h.dot(X(Z,2),e)+Z[K(2,2)],c=-n/r,Z[K(1,0)]*=c,Z[K(1,1)]*=c,Z[K(1,2)]*=c,i[0]=Z[0],i[1]=Z[1],i[2]=0,i[3]=Z[2],i[4]=Z[3],i[5]=Z[4],i[6]=0,i[7]=Z[5],i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=Z[6],i[13]=Z[7],i[14]=0,i[15]=Z[8]}return M}));
