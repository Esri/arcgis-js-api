/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../core/mathUtils","../../../../core/maybe","../../../../chunks/mat3f64","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec2","../../../../chunks/vec2f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../chunks/vec4","../../../../chunks/vec4f64","../../../ViewingMode","./Camera","./Util","../../../webgl/enums","../../../webgl/FramebufferObject","../../../webgl/Texture","../../../webgl/Util"],(function(t,e,s,a,i,r,n,c,o,h,u,d,l,p,f,m,x,T,_){"use strict";let b=function(){this.camera=new p.default,this.lightMat=r.create()},g=function(){function a(t,e,s=0){this.rctx=t,this.viewingMode=e,this._enabled=!1,this._snapshots=new Array,this.textureSize=0,this.maxTextureSize=0,this.numCascades=1,this.maxNumCascades=4,this.splitSchemeLambda=0,this.warp=!0,this.cascadeDistances=[0,0,0,0,0],this.cascades=[],this.maxTextureSize=this.rctx.parameters.maxTextureSize;for(let a=0;a<4;++a)this.cascades.push(new b);this.snapshotCount=s}var r=a.prototype;return r.dispose=function(){this._discardDepthTexture(),this._discardAllSnapshots()},r.getSnapshot=function(t){return this.enabled?this._snapshots[t]:null},r.getCascades=function(){for(let t=0;t<this.numCascades;++t)P[t]=this.cascades[t];return P.length=this.numCascades,P},r.start=function(t,e,s){f.assert(this.enabled),this.textureSize=this._computeTextureSize(t.fullWidth,t.fullHeight),this._ensureDepthTexture();const{near:a,far:i}=this._clampNearFar(s);this._computeCascadeDistances(i,a),this._setupMatrices(t,e);const r=t.viewMatrix,n=t.projectionMatrix;for(let c=0;c<this.numCascades;++c)this._constructCascade(c,n,r,e);this.lastOrigin=null,this.clear()},r.finish=function(t){f.assert(this.enabled),this.rctx.bindFramebuffer(t)},r.bind=function(t){this.enabled?(this._depthTextureUnit=t.bindTexture(this._depthTexture,"shadowMapTex"),t.setUniform1f("depthHalfPixelSz",.5/this.textureSize),t.setUniform1i("numCascades",this.numCascades),t.setUniform4f("cascadeDistances",this.cascadeDistances[0],this.numCascades>1?this.cascadeDistances[1]:1/0,this.numCascades>2?this.cascadeDistances[2]:1/0,this.numCascades>3?this.cascadeDistances[3]:1/0)):t.setUniform1f("depthHalfPixelSz",-1)},r.bindView=function(t,e){if(!this.enabled)return;const s=this.lastOrigin;if(!(s&&s[0]===e[0]&&s[1]===e[1]&&s[2]===e[2])){this.lastOrigin=this.lastOrigin||h.create(),o.copy(this.lastOrigin,e);for(let t=0;t<this.numCascades;++t){i.translate(A,this.cascades[t].lightMat,e);for(let e=0;e<16;++e)O[16*t+e]=A[e]}}t.setUniformMatrix4fv("shadowMapMatrix",O)},r.takeCascadeSnapshotTo=function(t,e){f.assert(this.enabled),this._ensureSnapshot(e),this._bindFbo();const s=this.rctx,a=s.bindTexture(this._snapshots[e],T.Texture.TEXTURE_UNIT_FOR_UPDATES);s.gl.copyTexSubImage2D(m.TextureType.TEXTURE_2D,0,t.camera.viewport[0],t.camera.viewport[1],t.camera.viewport[0],t.camera.viewport[1],t.camera.viewport[2],t.camera.viewport[3]),s.bindTexture(a,T.Texture.TEXTURE_UNIT_FOR_UPDATES)},r.clear=function(){const t=this.rctx;this._bindFbo(),t.setClearColor(1,1,1,1),t.clearSafe(m.ClearBufferBit.COLOR_BUFFER_BIT|m.ClearBufferBit.DEPTH_BUFFER_BIT)},r._computeTextureSize=function(t,e){const s=.5*Math.log(t*t+e*e)*Math.LOG2E,a=.35,i=2**Math.round(s+a);return Math.min(this.maxTextureSize,2*i)},r._ensureDepthTexture=function(){if(null!=this._depthTexture&&this._depthTexture.descriptor.width===this.textureSize)return;this._discardDepthTexture();const t={target:m.TextureType.TEXTURE_2D,pixelFormat:m.PixelFormat.RGBA,dataType:m.PixelType.UNSIGNED_BYTE,wrapMode:m.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:m.TextureSamplingMode.NEAREST,flipped:!0,width:this.textureSize,height:this.textureSize};this._depthTexture=new T.Texture(this.rctx,t),this.fbo=new x.FramebufferObject(this.rctx,{colorTarget:m.TargetType.TEXTURE,depthStencilTarget:m.DepthStencilTargetType.DEPTH_RENDER_BUFFER,width:this.textureSize,height:this.textureSize},this._depthTexture)},r._ensureSnapshot=function(t){const e=this._snapshots[t];if(s.isSome(e)&&e.descriptor.width===this.textureSize)return;this._discardSnapshot(t);const a={target:m.TextureType.TEXTURE_2D,pixelFormat:m.PixelFormat.RGBA,dataType:m.PixelType.UNSIGNED_BYTE,wrapMode:m.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:m.TextureSamplingMode.NEAREST,flipped:!0,width:this.textureSize,height:this.textureSize};this._snapshots[t]=new T.Texture(this.rctx,a)},r._discardDepthTexture=function(){this.fbo=s.disposeMaybe(this.fbo),this._depthTexture=s.disposeMaybe(this._depthTexture)},r._discardSnapshot=function(t){this._snapshots[t]=s.disposeMaybe(this._snapshots[t])},r._discardAllSnapshots=function(){for(let t=0;t<this.snapshotCount;++t)this._discardSnapshot(t)},r._bindFbo=function(){const t=this.rctx;s.isSome(this._depthTextureUnit)&&(t.bindTexture(null,this._depthTextureUnit),this._depthTextureUnit=null),t.bindFramebuffer(this.fbo)},r._constructCascade=function(t,e,s,a){const r=this.cascades[t],n=-this.cascadeDistances[t],c=-this.cascadeDistances[t+1],h=(e[10]*n+e[14])/Math.abs(e[11]*n+e[15]),d=(e[10]*c+e[14])/Math.abs(e[11]*c+e[15]);f.assert(h<d);for(let i=0;i<8;++i){const t=i%4==0||i%4==3?-1:1,e=i%4==0||i%4==1?-1:1,s=i<4?h:d;u.set(w,t,e,s,1),u.transformMat4(C[i],w,S);for(let a=0;a<3;++a)C[i][a]/=C[i][3]}o.negate(N,C[0]),i.translate(M,k,N),r.camera.viewMatrix=M;for(let i=0;i<8;++i)o.transformMat4(C[i],C[i],r.camera.viewMatrix);o.copy(D,C[0]),o.copy(v,C[0]);for(let i=1;i<8;++i)for(let t=0;t<3;++t)D[t]=Math.min(D[t],C[i][t]),v[t]=Math.max(v[t],C[i][t]);D[2]-=200,v[2]+=200,r.camera.near=-v[2],r.camera.far=-D[2],this.warp?this._constructTrapezoidalProjection(s,a,r):this._constructOrthogonalProjection(r),i.multiply(r.lightMat,r.camera.projectionMatrix,r.camera.viewMatrix);const l=this.textureSize/2;r.camera.viewport[0]=t%2==0?0:l,r.camera.viewport[1]=0===Math.floor(t/2)?0:l,r.camera.viewport[2]=l,r.camera.viewport[3]=l},r._constructOrthogonalProjection=function(t){i.ortho(t.camera.projectionMatrix,D[0],v[0],D[1],v[1],t.camera.near,t.camera.far)},r._constructTrapezoidalProjection=function(t,s,a){const i=1/C[0][3],r=1/C[4][3];f.assert(i<r);let n=i+Math.sqrt(i*r);const c=Math.sin(e.acosClamped(t[2]*s[0]+t[6]*s[1]+t[10]*s[2]));n/=c,Y(C,n,c,E,U,z,R,F),tt(E,U,R,F,a.camera.projectionMatrix),a.camera.projectionMatrix[10]=2/(D[2]-v[2]),a.camera.projectionMatrix[14]=-(D[2]+v[2])/(D[2]-v[2])},r._setupMatrices=function(t,e){i.multiply(y,t.projectionMatrix,t.viewMatrix),i.invert(S,y);const s=this.viewingMode===l.ViewingMode.Global?t.eye:o.set(N,0,0,1);i.lookAt(k,[0,0,0],[-e[0],-e[1],-e[2]],s)},r._clampNearFar=function(t){let{near:e,far:s}=t;return e<2&&(e=2),s<2&&(s=2),e>=s&&(e=2,s=4),{near:e,far:s}},r._computeCascadeDistances=function(t,s){this.numCascades=Math.min(1+Math.floor(f.logWithBase(t/s,4)),this.maxNumCascades);const a=(t-s)/this.numCascades,i=(t/s)**(1/this.numCascades);let r=s,n=s;for(let c=0;c<this.numCascades+1;++c)this.cascadeDistances[c]=e.lerp(r,n,this.splitSchemeLambda),r*=i,n+=a},t._createClass(a,[{key:"maxCascades",get:function(){return this.maxNumCascades},set:function(t){this.maxNumCascades=e.clamp(Math.floor(t),1,4)}},{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t,t||(this._discardDepthTexture(),this._discardAllSnapshots())}},{key:"snapshotCount",get:function(){return this._snapshots.length},set:function(t){const e=this._snapshots.length;if(t>e){const s=t-e;this._snapshots.length=t;for(let t=0;t<s;++t)this._snapshots[e+t]=null}else if(t<this.snapshotCount){const s=e-t;for(let e=0;e<s;++e)this._discardSnapshot(t+e);this._snapshots.length=t}}},{key:"gpuMemoryUsage",get:function(){var t,e;return this._snapshots.reduce(((t,e)=>t+_.getGpuMemoryUsage(e)),null!=(t=null==(e=this.fbo)?void 0:e.gpuMemoryUsage)?t:0)}},{key:"test",get:function(){const t=this;return{maxNumCascades:this.maxNumCascades,cascades:this.cascades,textureSize:this.textureSize,depthTexture:this._depthTexture,set splitSchemeLambda(e){t.splitSchemeLambda=e},get splitSchemeLambda(){return t.splitSchemeLambda},set warp(e){t.warp=e},get warp(){return t.warp}}}}]),a}();const M=r.create(),y=r.create(),S=r.create(),w=d.create(),C=[];for(let et=0;et<8;++et)C.push(d.create());const D=h.create(),v=h.create(),E=c.create(),U=c.create(),z=c.create(),R=c.create(),F=c.create(),k=r.create(),N=h.create(),P=[],A=r.create(),O=new Float32Array(64),B=c.create(),j=c.create(),L=[c.create(),c.create(),c.create(),c.create()],G=c.create(),I=c.create(),H=c.create(),X=c.create(),W=c.create(),q=c.create(),V=c.create();function Y(t,e,s,a,i,r,c,o){n.set(B,0,0);for(let f=0;f<4;++f)n.add(B,B,t[f]);n.scale(B,B,.25),n.set(j,0,0);for(let f=4;f<8;++f)n.add(j,j,t[f]);n.scale(j,j,.25),n.lerp(L[0],t[4],t[5],.5),n.lerp(L[1],t[5],t[6],.5),n.lerp(L[2],t[6],t[7],.5),n.lerp(L[3],t[7],t[4],.5);let h=0,u=n.squaredDistance(L[0],B);for(let f=1;f<4;++f){const t=n.squaredDistance(L[f],B);t<u&&(u=t,h=f)}n.subtract(G,L[h],t[h+4]);const d=G[0];let l,p;G[0]=-G[1],G[1]=d,n.subtract(I,j,B),n.dot(I,G)<0&&n.negate(G,G),n.lerp(G,G,I,s),n.normalize(G,G),l=p=n.dot(n.subtract(H,t[0],B),G);for(let f=1;f<8;++f){const e=n.dot(n.subtract(H,t[f],B),G);e<l?l=e:e>p&&(p=e)}n.copy(a,B),n.scale(H,G,l-e),n.add(a,a,H);let m=-1,x=1,T=0,_=0;for(let f=0;f<8;++f){n.subtract(X,t[f],a),n.normalize(X,X);const e=G[0]*X[1]-G[1]*X[0];e>0?e>m&&(m=e,T=f):e<x&&(x=e,_=f)}f.verify(m>0,"leftArea"),f.verify(x<0,"rightArea"),n.scale(W,G,l),n.add(W,W,B),n.scale(q,G,p),n.add(q,q,B),V[0]=-G[1],V[1]=G[0];const b=f.rayRay2D(a,t[_],q,n.add(H,q,V),1,i),g=f.rayRay2D(a,t[T],q,H,1,r),M=f.rayRay2D(a,t[T],W,n.add(H,W,V),1,c),y=f.rayRay2D(a,t[_],W,H,1,o);f.verify(b,"rayRay"),f.verify(g,"rayRay"),f.verify(M,"rayRay"),f.verify(y,"rayRay")}function J(t,e){return 3*e+t}const K=c.create();function Q(t,e){return n.set(K,t[e],t[e+3]),K}const Z=c.create(),$=a.create();function tt(t,e,s,a,i){n.subtract(Z,s,a),n.scale(Z,Z,.5),$[0]=Z[0],$[1]=Z[1],$[2]=0,$[3]=Z[1],$[4]=-Z[0],$[5]=0,$[6]=Z[0]*Z[0]+Z[1]*Z[1],$[7]=Z[0]*Z[1]-Z[1]*Z[0],$[8]=1,$[J(0,2)]=-n.dot(Q($,0),t),$[J(1,2)]=-n.dot(Q($,1),t);let r=n.dot(Q($,0),s)+$[J(0,2)],c=n.dot(Q($,1),s)+$[J(1,2)],o=n.dot(Q($,0),a)+$[J(0,2)],h=n.dot(Q($,1),a)+$[J(1,2)];r=-(r+o)/(c+h),$[J(0,0)]+=$[J(1,0)]*r,$[J(0,1)]+=$[J(1,1)]*r,$[J(0,2)]+=$[J(1,2)]*r,r=1/(n.dot(Q($,0),s)+$[J(0,2)]),c=1/(n.dot(Q($,1),s)+$[J(1,2)]),$[J(0,0)]*=r,$[J(0,1)]*=r,$[J(0,2)]*=r,$[J(1,0)]*=c,$[J(1,1)]*=c,$[J(1,2)]*=c,$[J(2,0)]=$[J(1,0)],$[J(2,1)]=$[J(1,1)],$[J(2,2)]=$[J(1,2)],$[J(1,2)]+=1,r=n.dot(Q($,1),e)+$[J(1,2)],c=n.dot(Q($,2),e)+$[J(2,2)],o=n.dot(Q($,1),s)+$[J(1,2)],h=n.dot(Q($,2),s)+$[J(2,2)],r=-.5*(r/c+o/h),$[J(1,0)]+=$[J(2,0)]*r,$[J(1,1)]+=$[J(2,1)]*r,$[J(1,2)]+=$[J(2,2)]*r,r=n.dot(Q($,1),e)+$[J(1,2)],c=n.dot(Q($,2),e)+$[J(2,2)],o=-c/r,$[J(1,0)]*=o,$[J(1,1)]*=o,$[J(1,2)]*=o,i[0]=$[0],i[1]=$[1],i[2]=0,i[3]=$[2],i[4]=$[3],i[5]=$[4],i[6]=0,i[7]=$[5],i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=$[6],i[13]=$[7],i[14]=0,i[15]=$[8]}return g}));
