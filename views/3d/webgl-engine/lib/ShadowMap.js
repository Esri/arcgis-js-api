/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../core/mathUtils","../../../../core/maybe","../../../../chunks/mat3f64","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec2","../../../../chunks/vec2f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../chunks/vec4","../../../../chunks/vec4f64","./Camera","./Util","../../../webgl/FramebufferObject","../../../webgl/Texture","../../../webgl/Util"],(function(t,e,s,a,i,r,c,n,o,h,u,d,l,p,f,m,x){"use strict";let b=function(){this.camera=new l,this.lightMat=r.create()},g=function(){function a(t,e,s=0){this.rctx=t,this.viewingMode=e,this._enabled=!1,this._snapshots=new Array,this.textureSize=0,this.maxTextureSize=0,this.numCascades=1,this.maxNumCascades=4,this.splitSchemeLambda=0,this.warp=!0,this.cascadeDistances=[0,0,0,0,0],this.cascades=[],this.maxTextureSize=this.rctx.parameters.maxTextureSize;for(let a=0;a<4;++a)this.cascades.push(new b);this.snapshotCount=s}var r=a.prototype;return r.dispose=function(){this.discardDepthTexture(),this.discardAllSnapshots()},r.getSnapshot=function(t){return this.enabled?this._snapshots[t]:null},r.getCascades=function(){for(let t=0;t<this.numCascades;++t)R[t]=this.cascades[t];return R.length=this.numCascades,R},r.start=function(t,e,s){p.assert(this.enabled),this.textureSize=this.computeTextureSize(t.fullWidth,t.fullHeight),this.ensureDepthTexture();const{near:a,far:i}=this.clampNearFar(s);this.computeCascadeDistances(i,a),this.setupMatrices(t,e);const r=t.viewMatrix,c=t.projectionMatrix;for(let n=0;n<this.numCascades;++n)this.constructCascade(n,c,r,e);this.lastOrigin=null,this.clear()},r.finish=function(t){p.assert(this.enabled),this.rctx.bindFramebuffer(t)},r.bind=function(t){this.enabled?(this._depthTextureUnit=t.bindTexture(this._depthTexture,"uShadowMapTex"),t.setUniform1f("uDepthHalfPixelSz",.5/this.textureSize),t.setUniform1i("uShadowMapNum",this.numCascades),t.setUniform4f("uShadowMapDistance",this.cascadeDistances[0],this.numCascades>1?this.cascadeDistances[1]:1/0,this.numCascades>2?this.cascadeDistances[2]:1/0,this.numCascades>3?this.cascadeDistances[3]:1/0)):t.setUniform1f("uDepthHalfPixelSz",-1)},r.bindView=function(t,e){if(!this.enabled)return;const s=this.lastOrigin;if(!(s&&s[0]===e[0]&&s[1]===e[1]&&s[2]===e[2])){this.lastOrigin=this.lastOrigin||h.create(),o.copy(this.lastOrigin,e);for(let t=0;t<this.numCascades;++t){i.translate(N,this.cascades[t].lightMat,e);for(let e=0;e<16;++e)O[16*t+e]=N[e]}}t.setUniformMatrix4fv("uShadowMapMatrix",O)},r.takeCascadeSnapshotTo=function(t,e){p.assert(this.enabled),this.ensureSnapshot(e),this._bindFbo();const s=this.rctx,a=s.bindTexture(this._snapshots[e],m.TEXTURE_UNIT_FOR_UPDATES);s.gl.copyTexSubImage2D(3553,0,t.camera.viewport[0],t.camera.viewport[1],t.camera.viewport[0],t.camera.viewport[1],t.camera.viewport[2],t.camera.viewport[3]),s.bindTexture(a,m.TEXTURE_UNIT_FOR_UPDATES)},r.clear=function(){const t=this.rctx;this._bindFbo(),t.setClearColor(1,1,1,1),t.clearSafe(16640)},r.computeTextureSize=function(t,e){const s=.5*Math.log(t*t+e*e)*Math.LOG2E,a=.35,i=2**Math.round(s+a);return Math.min(this.maxTextureSize,2*i)},r.ensureDepthTexture=function(){if(null!=this._depthTexture&&this._depthTexture.descriptor.width===this.textureSize)return;this.discardDepthTexture();const t={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0,width:this.textureSize,height:this.textureSize};this._depthTexture=new m(this.rctx,t),this.fbo=new f(this.rctx,{colorTarget:0,depthStencilTarget:1,width:this.textureSize,height:this.textureSize},this._depthTexture)},r.ensureSnapshot=function(t){const e=this._snapshots[t];if(s.isSome(e)&&e.descriptor.width===this.textureSize)return;this.discardSnapshot(t);const a={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0,width:this.textureSize,height:this.textureSize};this._snapshots[t]=new m(this.rctx,a)},r.discardDepthTexture=function(){this.fbo=s.disposeMaybe(this.fbo),this._depthTexture=s.disposeMaybe(this._depthTexture)},r.discardSnapshot=function(t){this._snapshots[t]=s.disposeMaybe(this._snapshots[t])},r.discardAllSnapshots=function(){for(let t=0;t<this.snapshotCount;++t)this.discardSnapshot(t)},r._bindFbo=function(){const t=this.rctx;s.isSome(this._depthTextureUnit)&&(t.bindTexture(null,this._depthTextureUnit),this._depthTextureUnit=null),t.bindFramebuffer(this.fbo)},r.constructCascade=function(t,e,s,a){const r=this.cascades[t],c=-this.cascadeDistances[t],n=-this.cascadeDistances[t+1],h=(e[10]*c+e[14])/Math.abs(e[11]*c+e[15]),d=(e[10]*n+e[14])/Math.abs(e[11]*n+e[15]);p.assert(h<d);for(let i=0;i<8;++i){const t=i%4==0||i%4==3?-1:1,e=i%4==0||i%4==1?-1:1,s=i<4?h:d;u.set(y,t,e,s,1),u.transformMat4(w[i],y,T);for(let a=0;a<3;++a)w[i][a]/=w[i][3]}o.negate(j,w[0]),i.translate(M,F,j),r.camera.viewMatrix=M;for(let i=0;i<8;++i)o.transformMat4(w[i],w[i],r.camera.viewMatrix);o.copy(_,w[0]),o.copy(C,w[0]);for(let i=1;i<8;++i)for(let t=0;t<3;++t)_[t]=Math.min(_[t],w[i][t]),C[t]=Math.max(C[t],w[i][t]);_[2]-=200,C[2]+=200,r.camera.near=-C[2],r.camera.far=-_[2],this.warp?this.constructTrapezoidalProjection(s,a,r):this.constructOrthogonalProjection(r),i.multiply(r.lightMat,r.camera.projectionMatrix,r.camera.viewMatrix);const l=this.textureSize/2;r.camera.viewport[0]=t%2==0?0:l,r.camera.viewport[1]=0===Math.floor(t/2)?0:l,r.camera.viewport[2]=l,r.camera.viewport[3]=l},r.constructOrthogonalProjection=function(t){i.ortho(t.camera.projectionMatrix,_[0],C[0],_[1],C[1],t.camera.near,t.camera.far)},r.constructTrapezoidalProjection=function(t,s,a){const i=1/w[0][3],r=1/w[4][3];p.assert(i<r);let c=i+Math.sqrt(i*r);const n=Math.sin(e.acosClamped(t[2]*s[0]+t[6]*s[1]+t[10]*s[2]));c/=n,X(w,c,n,v,D,z,U,k),Z(v,D,U,k,a.camera.projectionMatrix),a.camera.projectionMatrix[10]=2/(_[2]-C[2]),a.camera.projectionMatrix[14]=-(_[2]+C[2])/(_[2]-C[2])},r.setupMatrices=function(t,e){i.multiply(S,t.projectionMatrix,t.viewMatrix),i.invert(T,S);const s=1===this.viewingMode?t.eye:o.set(j,0,0,1);i.lookAt(F,[0,0,0],[-e[0],-e[1],-e[2]],s)},r.clampNearFar=function(t){let{near:e,far:s}=t;return e<2&&(e=2),s<2&&(s=2),e>=s&&(e=2,s=4),{near:e,far:s}},r.computeCascadeDistances=function(t,s){this.numCascades=Math.min(1+Math.floor(p.logWithBase(t/s,4)),this.maxNumCascades);const a=(t-s)/this.numCascades,i=(t/s)**(1/this.numCascades);let r=s,c=s;for(let n=0;n<this.numCascades+1;++n)this.cascadeDistances[n]=e.lerp(r,c,this.splitSchemeLambda),r*=i,c+=a},r.getGpuMemoryUsage=function(){var t,e;return this._snapshots.reduce(((t,e)=>t+x.getGpuMemoryUsage(e)),null!=(t=null==(e=this.fbo)?void 0:e.gpuMemoryUsage)?t:0)},t._createClass(a,[{key:"maxCascades",get:function(){return this.maxNumCascades},set:function(t){this.maxNumCascades=e.clamp(Math.floor(t),1,4)}},{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t,t||(this.discardDepthTexture(),this.discardAllSnapshots())}},{key:"snapshotCount",get:function(){return this._snapshots.length},set:function(t){const e=this._snapshots.length;if(t>e){const s=t-e;this._snapshots.length=t;for(let t=0;t<s;++t)this._snapshots[e+t]=null}else if(t<this.snapshotCount){const s=e-t;for(let e=0;e<s;++e)this.discardSnapshot(t+e);this._snapshots.length=t}}},{key:"test",get:function(){const t=this;return{maxNumCascades:this.maxNumCascades,cascades:this.cascades,textureSize:this.textureSize,depthTexture:this._depthTexture,set splitSchemeLambda(e){t.splitSchemeLambda=e},get splitSchemeLambda(){return t.splitSchemeLambda},set warp(e){t.warp=e},get warp(){return t.warp}}}}]),a}();const M=r.create(),S=r.create(),T=r.create(),y=d.create(),w=[];for(let $=0;$<8;++$)w.push(d.create());const _=h.create(),C=h.create(),v=n.create(),D=n.create(),z=n.create(),U=n.create(),k=n.create(),F=r.create(),j=h.create(),R=[],N=r.create(),O=new Float32Array(64),A=n.create(),P=n.create(),E=[n.create(),n.create(),n.create(),n.create()],L=n.create(),H=n.create(),q=n.create(),G=n.create(),I=n.create(),B=n.create(),W=n.create();function X(t,e,s,a,i,r,n,o){c.set(A,0,0);for(let p=0;p<4;++p)c.add(A,A,t[p]);c.scale(A,A,.25),c.set(P,0,0);for(let p=4;p<8;++p)c.add(P,P,t[p]);c.scale(P,P,.25),c.lerp(E[0],t[4],t[5],.5),c.lerp(E[1],t[5],t[6],.5),c.lerp(E[2],t[6],t[7],.5),c.lerp(E[3],t[7],t[4],.5);let h=0,u=c.squaredDistance(E[0],A);for(let p=1;p<4;++p){const t=c.squaredDistance(E[p],A);t<u&&(u=t,h=p)}c.subtract(L,E[h],t[h+4]);const d=L[0];let l,f;L[0]=-L[1],L[1]=d,c.subtract(H,P,A),c.dot(H,L)<0&&c.negate(L,L),c.lerp(L,L,H,s),c.normalize(L,L),l=f=c.dot(c.subtract(q,t[0],A),L);for(let p=1;p<8;++p){const e=c.dot(c.subtract(q,t[p],A),L);e<l?l=e:e>f&&(f=e)}c.copy(a,A),c.scale(q,L,l-e),c.add(a,a,q);let m=-1,x=1,b=0,g=0;for(let p=0;p<8;++p){c.subtract(G,t[p],a),c.normalize(G,G);const e=L[0]*G[1]-L[1]*G[0];e>0?e>m&&(m=e,b=p):e<x&&(x=e,g=p)}p.verify(m>0,"leftArea"),p.verify(x<0,"rightArea"),c.scale(I,L,l),c.add(I,I,A),c.scale(B,L,f),c.add(B,B,A),W[0]=-L[1],W[1]=L[0];const M=p.rayRay2D(a,t[g],B,c.add(q,B,W),1,i),S=p.rayRay2D(a,t[b],B,q,1,r),T=p.rayRay2D(a,t[b],I,c.add(q,I,W),1,n),y=p.rayRay2D(a,t[g],I,q,1,o);p.verify(M,"rayRay"),p.verify(S,"rayRay"),p.verify(T,"rayRay"),p.verify(y,"rayRay")}function V(t,e){return 3*e+t}const J=n.create();function K(t,e){return c.set(J,t[e],t[e+3]),J}const Q=n.create(),Y=a.create();function Z(t,e,s,a,i){c.subtract(Q,s,a),c.scale(Q,Q,.5),Y[0]=Q[0],Y[1]=Q[1],Y[2]=0,Y[3]=Q[1],Y[4]=-Q[0],Y[5]=0,Y[6]=Q[0]*Q[0]+Q[1]*Q[1],Y[7]=Q[0]*Q[1]-Q[1]*Q[0],Y[8]=1,Y[V(0,2)]=-c.dot(K(Y,0),t),Y[V(1,2)]=-c.dot(K(Y,1),t);let r=c.dot(K(Y,0),s)+Y[V(0,2)],n=c.dot(K(Y,1),s)+Y[V(1,2)],o=c.dot(K(Y,0),a)+Y[V(0,2)],h=c.dot(K(Y,1),a)+Y[V(1,2)];r=-(r+o)/(n+h),Y[V(0,0)]+=Y[V(1,0)]*r,Y[V(0,1)]+=Y[V(1,1)]*r,Y[V(0,2)]+=Y[V(1,2)]*r,r=1/(c.dot(K(Y,0),s)+Y[V(0,2)]),n=1/(c.dot(K(Y,1),s)+Y[V(1,2)]),Y[V(0,0)]*=r,Y[V(0,1)]*=r,Y[V(0,2)]*=r,Y[V(1,0)]*=n,Y[V(1,1)]*=n,Y[V(1,2)]*=n,Y[V(2,0)]=Y[V(1,0)],Y[V(2,1)]=Y[V(1,1)],Y[V(2,2)]=Y[V(1,2)],Y[V(1,2)]+=1,r=c.dot(K(Y,1),e)+Y[V(1,2)],n=c.dot(K(Y,2),e)+Y[V(2,2)],o=c.dot(K(Y,1),s)+Y[V(1,2)],h=c.dot(K(Y,2),s)+Y[V(2,2)],r=-.5*(r/n+o/h),Y[V(1,0)]+=Y[V(2,0)]*r,Y[V(1,1)]+=Y[V(2,1)]*r,Y[V(1,2)]+=Y[V(2,2)]*r,r=c.dot(K(Y,1),e)+Y[V(1,2)],n=c.dot(K(Y,2),e)+Y[V(2,2)],o=-n/r,Y[V(1,0)]*=o,Y[V(1,1)]*=o,Y[V(1,2)]*=o,i[0]=Y[0],i[1]=Y[1],i[2]=0,i[3]=Y[2],i[4]=Y[3],i[5]=Y[4],i[6]=0,i[7]=Y[5],i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=Y[6],i[13]=Y[7],i[14]=0,i[15]=Y[8]}return g}));
