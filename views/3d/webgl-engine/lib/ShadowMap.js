/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/has","../../../../core/mathUtils","../../../../core/maybe","../../../../chunks/mat3f64","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec2","../../../../chunks/vec2f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../chunks/vec4","../../../../chunks/vec4f64","../../../ViewingMode","./CascadeCamera","./Util","../../../webgl/enums","../../../webgl/FramebufferObject","../../../webgl/Texture","../../../webgl/Util"],(function(e,t,s,a,i,r,c,n,o,h,u,d,_,l,p,f,m,x,T,g,S){"use strict";var b;e.SnapshotSlot=void 0,(b=e.SnapshotSlot||(e.SnapshotSlot={}))[b.Highlight=0]="Highlight",b[b.Default=1]="Default";let y=function(){this.camera=new f.CascadeCamera,this.lightMat=n.create()},M=function(){function e(e,t){this._rctx=e,this._viewingMode=t,this._enabled=!1,this._snapshots=new Array,this._textureSize=0,this._numCascades=1,this._maxNumCascades=4,this._projectionView=n.create(),this._projectionViewInverse=n.create(),this._modelViewLight=n.create(),this._splitSchemeLambda=0,this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=l.create(),this._cascades=[new y,new y,new y,new y],this._lastOrigin=null,this._maxTextureSize=Math.min(s("esri-mobile")?2048:8192,this._rctx.parameters.maxTextureSize)}var r=e.prototype;return r.dispose=function(){this.enabled=!1,this.disposeOffscreenBuffers()},r.disposeOffscreenBuffers=function(){this._discardDepthTexture(),this._discardAllSnapshots()},r.getSnapshot=function(e){return this.enabled?this._snapshots[e]:null},r.start=function(e,t,s){m.assert(this.enabled),this._textureSize=this._computeTextureSize(e.fullWidth,e.fullHeight),this._ensureDepthTexture();const{near:a,far:i}=this._clampNearFar(s);this._computeCascadeDistances(i,a),this._setupMatrices(e,t);const{viewMatrix:r,projectionMatrix:c}=e;for(let n=0;n<this._numCascades;++n)this._constructCascade(n,c,r,t);this._lastOrigin=null,this.clear()},r.finish=function(e){m.assert(this.enabled),this._rctx.bindFramebuffer(e)},r.getShadowMapMatrices=function(e){if(!this._lastOrigin||!u.exactEquals(e,this._lastOrigin)){this._lastOrigin=this._lastOrigin||d.create(),u.copy(this._lastOrigin,e);for(let t=0;t<this._numCascades;++t){c.translate(O,this._cascades[t].lightMat,e);for(let e=0;e<16;++e)B[16*t+e]=O[e]}}return B},r.takeCascadeSnapshotTo=function(e,t){m.assert(this.enabled);const s=this._ensureSnapshot(t);this._bindFbo();const a=this._rctx,i=a.bindTexture(s,g.Texture.TEXTURE_UNIT_FOR_UPDATES);a.gl.copyTexSubImage2D(x.TextureType.TEXTURE_2D,0,e.camera.viewport[0],e.camera.viewport[1],e.camera.viewport[0],e.camera.viewport[1],e.camera.viewport[2],e.camera.viewport[3]),a.bindTexture(i,g.Texture.TEXTURE_UNIT_FOR_UPDATES)},r.clear=function(){const e=this._rctx;this._bindFbo(),e.setClearColor(1,1,1,1),e.clearSafe(x.ClearBufferBit.COLOR_BUFFER_BIT|x.ClearBufferBit.DEPTH_BUFFER_BIT)},r._computeTextureSize=function(e,t){const s=.5*Math.log(e*e+t*t)*Math.LOG2E,a=.35,i=2**Math.round(s+a);return Math.min(this._maxTextureSize,2*i)},r._ensureDepthTexture=function(){if(i.isSome(this._depthTexture)&&this._depthTexture.descriptor.width===this._textureSize)return;this._discardDepthTexture();const e={target:x.TextureType.TEXTURE_2D,pixelFormat:x.PixelFormat.RGBA,dataType:x.PixelType.UNSIGNED_BYTE,wrapMode:x.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:x.TextureSamplingMode.NEAREST,flipped:!0,width:this._textureSize,height:this._textureSize};this._depthTexture=new g.Texture(this._rctx,e),this._fbo=new T.FramebufferObject(this._rctx,{colorTarget:x.TargetType.TEXTURE,depthStencilTarget:x.DepthStencilTargetType.DEPTH_RENDER_BUFFER,width:this._textureSize,height:this._textureSize},this._depthTexture)},r._ensureSnapshot=function(e){let t=this._snapshots[e];if(i.isSome(t)&&t.descriptor.width===this._textureSize)return t;this._discardSnapshot(e);const s={target:x.TextureType.TEXTURE_2D,pixelFormat:x.PixelFormat.RGBA,dataType:x.PixelType.UNSIGNED_BYTE,wrapMode:x.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:x.TextureSamplingMode.NEAREST,flipped:!0,width:this._textureSize,height:this._textureSize};return t=new g.Texture(this._rctx,s),this._snapshots[e]=t,t},r._discardDepthTexture=function(){this._fbo=i.disposeMaybe(this._fbo),this._depthTexture=i.disposeMaybe(this._depthTexture)},r._discardSnapshot=function(e){this._snapshots[e]=i.disposeMaybe(this._snapshots[e])},r._discardAllSnapshots=function(){for(let e=0;e<this._snapshots.length;++e)this._discardSnapshot(e);this._snapshots.length=0},r._bindFbo=function(){const e=this._rctx;e.unbindTexture(this._depthTexture),e.bindFramebuffer(this._fbo)},r._constructCascade=function(e,t,s,a){const i=this._cascades[e],r=-this._cascadeDistances[e],n=-this._cascadeDistances[e+1],o=(t[10]*r+t[14])/Math.abs(t[11]*r+t[15]),h=(t[10]*n+t[14])/Math.abs(t[11]*n+t[15]);m.assert(o<h);for(let c=0;c<8;++c){const e=c%4==0||c%4==3?-1:1,t=c%4==0||c%4==1?-1:1,s=c<4?o:h;_.set(C,e,t,s,1);const a=D[c];_.transformMat4(a,C,this._projectionViewInverse),a[0]/=a[3],a[1]/=a[3],a[2]/=a[3]}u.negate(F,D[0]),i.camera.viewMatrix=c.translate(w,this._modelViewLight,F);for(let c=0;c<8;++c)u.transformMat4(D[c],D[c],i.camera.viewMatrix);let d=D[0][2],l=D[0][2];for(let c=1;c<8;++c)d=Math.min(d,D[c][2]),l=Math.max(l,D[c][2]);d-=200,l+=200,i.camera.near=-l,i.camera.far=-d,$(s,a,d,l,i.camera),c.multiply(i.lightMat,i.camera.projectionMatrix,i.camera.viewMatrix);const p=this._textureSize/2;i.camera.viewport=[e%2==0?0:p,0===Math.floor(e/2)?0:p,p,p]},r._setupMatrices=function(e,t){c.multiply(this._projectionView,e.projectionMatrix,e.viewMatrix),c.invert(this._projectionViewInverse,this._projectionView);const s=this._viewingMode===p.ViewingMode.Global?e.eye:u.set(F,0,0,1);c.lookAt(this._modelViewLight,[0,0,0],[-t[0],-t[1],-t[2]],s)},r._clampNearFar=function(e){let{near:t,far:s}=e;return t<2&&(t=2),s<2&&(s=2),t>=s&&(t=2,s=4),{near:t,far:s}},r._computeCascadeDistances=function(e,t){this._numCascades=Math.min(1+Math.floor(m.logWithBase(e/t,4)),this._maxNumCascades);const s=(e-t)/this._numCascades,i=(e/t)**(1/this._numCascades);let r=t,c=t;for(let n=0;n<this._numCascades+1;++n)this._cascadeDistances[n]=a.lerp(r,c,this._splitSchemeLambda),r*=i,c+=s},t._createClass(e,[{key:"depthTexture",get:function(){return this._depthTexture}},{key:"textureSize",get:function(){return this._textureSize}},{key:"numCascades",get:function(){return this._numCascades}},{key:"cascadeDistances",get:function(){return _.set(this._usedCascadeDistances,this._cascadeDistances[0],this._numCascades>1?this._cascadeDistances[1]:1/0,this._numCascades>2?this._cascadeDistances[2]:1/0,this._numCascades>3?this._cascadeDistances[3]:1/0)}},{key:"maxCascades",get:function(){return this._maxNumCascades},set:function(e){this._maxNumCascades=a.clamp(Math.floor(e),1,4)}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e,e||(this._discardDepthTexture(),this._discardAllSnapshots())}},{key:"ready",get:function(){return this._enabled&&i.isSome(this._depthTexture)}},{key:"cascades",get:function(){for(let e=0;e<this._numCascades;++e)U[e]=this._cascades[e];return U.length=this._numCascades,U}},{key:"gpuMemoryUsage",get:function(){return this._snapshots.reduce(((e,t)=>e+S.getGpuMemoryUsage(t)),this._fbo?.gpuMemoryUsage??0)}},{key:"test",get:function(){const e=this;return{maxNumCascades:this._maxNumCascades,cascades:this._cascades,textureSize:this._textureSize,set splitSchemeLambda(t){e._splitSchemeLambda=t},get splitSchemeLambda(){return e._splitSchemeLambda}}}}]),e}();const w=n.create(),C=l.create(),D=[];for(let ee=0;ee<8;++ee)D.push(l.create());const E=h.create(),v=h.create(),R=h.create(),k=h.create(),z=h.create(),F=d.create(),U=[],O=n.create(),B=new Float32Array(64),N=h.create(),A=h.create(),j=[h.create(),h.create(),h.create(),h.create()],L=h.create(),P=h.create(),V=h.create(),I=h.create(),G=h.create(),H=h.create(),X=h.create();function q(e,t,s,a,i,r,c,n){o.set(N,0,0);for(let m=0;m<4;++m)o.add(N,N,e[m]);o.scale(N,N,.25),o.set(A,0,0);for(let m=4;m<8;++m)o.add(A,A,e[m]);o.scale(A,A,.25),o.lerp(j[0],e[4],e[5],.5),o.lerp(j[1],e[5],e[6],.5),o.lerp(j[2],e[6],e[7],.5),o.lerp(j[3],e[7],e[4],.5);let h=0,u=o.squaredDistance(j[0],N);for(let m=1;m<4;++m){const e=o.squaredDistance(j[m],N);e<u&&(u=e,h=m)}o.subtract(L,j[h],e[h+4]);const d=L[0];let _,l;L[0]=-L[1],L[1]=d,o.subtract(P,A,N),o.dot(P,L)<0&&o.negate(L,L),o.lerp(L,L,P,s),o.normalize(L,L),_=l=o.dot(o.subtract(V,e[0],N),L);for(let m=1;m<8;++m){const t=o.dot(o.subtract(V,e[m],N),L);t<_?_=t:t>l&&(l=t)}o.copy(a,N),o.scale(V,L,_-t),o.add(a,a,V);let p=-1,f=1,x=0,T=0;for(let m=0;m<8;++m){o.subtract(I,e[m],a),o.normalize(I,I);const t=L[0]*I[1]-L[1]*I[0];t>0?t>p&&(p=t,x=m):t<f&&(f=t,T=m)}m.verify(p>0,"leftArea"),m.verify(f<0,"rightArea"),o.scale(G,L,_),o.add(G,G,N),o.scale(H,L,l),o.add(H,H,N),X[0]=-L[1],X[1]=L[0];const g=m.rayRay2D(a,e[T],H,o.add(V,H,X),1,i),S=m.rayRay2D(a,e[x],H,V,1,r),b=m.rayRay2D(a,e[x],G,o.add(V,G,X),1,c),y=m.rayRay2D(a,e[T],G,V,1,n);m.verify(g,"rayRay"),m.verify(S,"rayRay"),m.verify(b,"rayRay"),m.verify(y,"rayRay")}function W(e,t){return 3*t+e}const Y=h.create();function J(e,t){return o.set(Y,e[t],e[t+3]),Y}const K=h.create(),Q=r.create();function Z(e,t,s,a,i){o.subtract(K,s,a),o.scale(K,K,.5),Q[0]=K[0],Q[1]=K[1],Q[2]=0,Q[3]=K[1],Q[4]=-K[0],Q[5]=0,Q[6]=K[0]*K[0]+K[1]*K[1],Q[7]=K[0]*K[1]-K[1]*K[0],Q[8]=1,Q[W(0,2)]=-o.dot(J(Q,0),e),Q[W(1,2)]=-o.dot(J(Q,1),e);let r=o.dot(J(Q,0),s)+Q[W(0,2)],c=o.dot(J(Q,1),s)+Q[W(1,2)],n=o.dot(J(Q,0),a)+Q[W(0,2)],h=o.dot(J(Q,1),a)+Q[W(1,2)];r=-(r+n)/(c+h),Q[W(0,0)]+=Q[W(1,0)]*r,Q[W(0,1)]+=Q[W(1,1)]*r,Q[W(0,2)]+=Q[W(1,2)]*r,r=1/(o.dot(J(Q,0),s)+Q[W(0,2)]),c=1/(o.dot(J(Q,1),s)+Q[W(1,2)]),Q[W(0,0)]*=r,Q[W(0,1)]*=r,Q[W(0,2)]*=r,Q[W(1,0)]*=c,Q[W(1,1)]*=c,Q[W(1,2)]*=c,Q[W(2,0)]=Q[W(1,0)],Q[W(2,1)]=Q[W(1,1)],Q[W(2,2)]=Q[W(1,2)],Q[W(1,2)]+=1,r=o.dot(J(Q,1),t)+Q[W(1,2)],c=o.dot(J(Q,2),t)+Q[W(2,2)],n=o.dot(J(Q,1),s)+Q[W(1,2)],h=o.dot(J(Q,2),s)+Q[W(2,2)],r=-.5*(r/c+n/h),Q[W(1,0)]+=Q[W(2,0)]*r,Q[W(1,1)]+=Q[W(2,1)]*r,Q[W(1,2)]+=Q[W(2,2)]*r,r=o.dot(J(Q,1),t)+Q[W(1,2)],c=o.dot(J(Q,2),t)+Q[W(2,2)],n=-c/r,Q[W(1,0)]*=n,Q[W(1,1)]*=n,Q[W(1,2)]*=n,i[0]=Q[0],i[1]=Q[1],i[2]=0,i[3]=Q[2],i[4]=Q[3],i[5]=Q[4],i[6]=0,i[7]=Q[5],i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=Q[6],i[13]=Q[7],i[14]=0,i[15]=Q[8]}function $(e,t,s,i,r){const c=1/D[0][3],n=1/D[4][3];m.assert(c<n);let o=c+Math.sqrt(c*n);const h=Math.sin(a.acosClamped(e[2]*t[0]+e[6]*t[1]+e[10]*t[2]));o/=h,q(D,o,h,E,v,R,k,z),Z(E,v,k,z,r.projectionMatrix),r.projectionMatrix[10]=2/(s-i),r.projectionMatrix[14]=-(s+i)/(s-i)}e.ShadowMap=M,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
