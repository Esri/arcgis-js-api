/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../core/mathUtils","../../../../chunks/vec3f64","../../../../chunks/vec3","../../../../chunks/mat4","../../../../chunks/mat3f64","../../../../chunks/mat4f64","../../../../chunks/vec2f64","../../../../chunks/vec4f64","../../../../chunks/vec2","../../../../chunks/vec4","./Util","../../../webgl/Texture","../../../webgl/Util","./glUtil3D","./Camera","./DefaultTextureUnits","../../../webgl/FramebufferObject"],(function(t,e,a,s,r,i,c,n,h,o,u,d,l,m,f,p,x,b){"use strict";let g=function(){this.camera=new p,this.lightMat=c.create()},M=function(){function i(t,e){this.rctx=t,this.viewingMode=e,this._enabled=!1,this.textureSize=0,this.maxTextureSize=0,this.numCascades=1,this.maxNumCascades=4,this.splitSchemeLambda=0,this.warp=!0,this.cascadeDistances=[0,0,0,0,0],this.cascades=[],this.emptyTexture=f.createEmptyTexture(this.rctx),this.maxTextureSize=this.rctx.parameters.maxTextureSize;for(let t=0;t<4;++t)this.cascades.push(new g)}var c=i.prototype;return c.dispose=function(){this.emptyTexture.dispose(),this.emptyTexture=null,this.discardDepthTexture()},c.getDepthTexture=function(){return this.depthTexture},c.getCascades=function(){for(let t=0;t<this.numCascades;++t)L[t]=this.cascades[t];return L.length=this.numCascades,L},c.prepare=function(t,a,i){d.assert(this.enabled),this.textureSize=this.computeTextureSize(t.fullWidth,t.fullHeight),this.assertDepthTexture(),r.multiply(T,t.projectionMatrix,t.viewMatrix);let c=i.near,n=i.far;c<2&&(c=2),n<2&&(n=2),c>=n&&(c=2,n=4),this.numCascades=Math.min(1+Math.floor(d.logWithBase(n/c,4)),this.maxNumCascades);const h=(n-c)/this.numCascades,o=Math.pow(n/c,1/this.numCascades);let l=c,m=c;for(let t=0;t<this.numCascades+1;++t)this.cascadeDistances[t]=e.lerp(l,m,this.splitSchemeLambda),l*=o,m+=h;r.invert(w,T);const f=1===this.viewingMode?t.eye:s.set(A,0,0,1);r.lookAt(R,[0,0,0],[-a[0],-a[1],-a[2]],f);const p=t.viewMatrix,x=t.projectionMatrix;for(let t=0;t<this.numCascades;++t){const i=this.cascades[t],h=-this.cascadeDistances[t],o=-this.cascadeDistances[t+1],l=(x[10]*h+x[14])/Math.abs(x[11]*h+x[15]),m=(x[10]*o+x[14])/Math.abs(x[11]*o+x[15]);d.assert(l<m);for(let t=0;t<8;++t){const e=t%4==0||t%4==3?-1:1,a=t%4==0||t%4==1?-1:1,s=t<4?l:m;u.set(D,e,a,s,1),u.transformMat4(S[t],D,w);for(let e=0;e<3;++e)S[t][e]/=S[t][3]}s.negate(A,S[0]),r.translate(y,R,A),i.camera.viewMatrix=y;for(let t=0;t<8;++t)s.transformMat4(S[t],S[t],i.camera.viewMatrix);s.copy(v,S[0]),s.copy(C,S[0]);for(let t=1;t<8;++t)for(let e=0;e<3;++e)v[e]=Math.min(v[e],S[t][e]),C[e]=Math.max(C[e],S[t][e]);if(v[2]-=200,C[2]+=200,i.camera.near=-C[2],i.camera.far=-v[2],this.warp){c=1/S[0][3],n=1/S[4][3],d.assert(c<n);let t=c+Math.sqrt(c*n);const s=Math.sin(e.acosClamped(p[2]*a[0]+p[6]*a[1]+p[10]*a[2]));t/=s,J(S,t,s,z,U,k,j,O),$(z,U,j,O,i.camera.projectionMatrix),i.camera.projectionMatrix[10]=2/(v[2]-C[2]),i.camera.projectionMatrix[14]=-(v[2]+C[2])/(v[2]-C[2])}else r.ortho(i.camera.projectionMatrix,v[0],C[0],v[1],C[1],i.camera.near,i.camera.far);r.multiply(i.lightMat,i.camera.projectionMatrix,i.camera.viewMatrix);const f=this.textureSize/2;i.camera.viewport[0]=t%2==0?0:f,i.camera.viewport[1]=0===Math.floor(t/2)?0:f,i.camera.viewport[2]=f,i.camera.viewport[3]=f}this.lastOrigin=null;const b=this.rctx;b.bindFramebuffer(this.fbo),b.bindTexture(null,7),b.setClearColor(1,1,1,1),b.clearSafe(16640)},c.finish=function(t){d.assert(this.enabled),this.rctx.bindFramebuffer(t)},c.bind=function(t,e){const a=this.rctx;a.bindTexture(this.enabled?this.depthTexture:this.emptyTexture,e),a.bindProgram(t),t.setUniform1i("depthTex",e),t.setUniform1f("depthHalfPixelSz",this.enabled?.5/this.textureSize:-1),t.setUniform1i("shadowMapNum",this.numCascades),t.setUniform4f("shadowMapDistance",this.cascadeDistances[0],this.numCascades>1?this.cascadeDistances[1]:1/0,this.numCascades>2?this.cascadeDistances[2]:1/0,this.numCascades>3?this.cascadeDistances[3]:1/0)},c.bindToAllPrograms=function(t){const e=t.getProgramsUsingUniform("shadowMapDistance");for(let t=0;t<e.length;t++)this.bind(e[t],x.DefaultTextureUnits.SHADOW_MAP)},c.bindView=function(t,e){if(!this.enabled)return;const i=this.lastOrigin;if(!(i&&i[0]===e[0]&&i[1]===e[1]&&i[2]===e[2])){this.lastOrigin=this.lastOrigin||a.create(),s.copy(this.lastOrigin,e);for(let t=0;t<this.numCascades;++t){r.translate(N,this.cascades[t].lightMat,e);for(let e=0;e<16;++e)P[16*t+e]=N[e]}}t.setUniformMatrix4fv("shadowMapMatrix",P)},c.computeTextureSize=function(t,e){const a=.5*Math.log(t*t+e*e)*Math.LOG2E,s=2**Math.round(a+.35);return Math.min(this.maxTextureSize,2*s)},c.assertDepthTexture=function(){if(null!=this.depthTexture&&this.depthTexture.descriptor.width===this.textureSize)return;this.discardDepthTexture();const t={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0,width:this.textureSize,height:this.textureSize};this.depthTexture=new l(this.rctx,t),this.fbo=new b(this.rctx,{colorTarget:0,depthStencilTarget:1,width:this.textureSize,height:this.textureSize},this.depthTexture)},c.discardDepthTexture=function(){this.fbo&&(this.fbo.dispose(),this.fbo=null),this.depthTexture&&(this.depthTexture.dispose(),this.depthTexture=null)},c.getGpuMemoryUsage=function(){return m.getGpuMemoryUsage(this.fbo)},t._createClass(i,[{key:"maxCascades",set:function(t){this.maxNumCascades=e.clamp(Math.floor(t),1,4)},get:function(){return this.maxNumCascades}},{key:"enabled",set:function(t){this._enabled=t,t||this.discardDepthTexture()},get:function(){return this._enabled}},{key:"test",get:function(){const t=this;return{maxNumCascades:this.maxNumCascades,cascades:this.cascades,textureSize:this.textureSize,set splitSchemeLambda(e){t.splitSchemeLambda=e},get splitSchemeLambda(){return t.splitSchemeLambda},set warp(e){t.warp=e},get warp(){return t.warp}}}}]),i}();const y=c.create(),T=c.create(),w=c.create(),D=h.create(),S=[];for(let t=0;t<8;++t)S.push(h.create());const v=a.create(),C=a.create(),z=n.create(),U=n.create(),k=n.create(),j=n.create(),O=n.create(),R=c.create(),A=a.create(),L=[],N=c.create(),P=new Float32Array(64),_=n.create(),F=n.create(),H=[n.create(),n.create(),n.create(),n.create()],q=n.create(),G=n.create(),W=n.create(),B=n.create(),E=n.create(),V=n.create(),I=n.create();function J(t,e,a,s,r,i,c,n){o.set(_,0,0);for(let e=0;e<4;++e)o.add(_,_,t[e]);o.scale(_,_,.25),o.set(F,0,0);for(let e=4;e<8;++e)o.add(F,F,t[e]);o.scale(F,F,.25),o.lerp(H[0],t[4],t[5],.5),o.lerp(H[1],t[5],t[6],.5),o.lerp(H[2],t[6],t[7],.5),o.lerp(H[3],t[7],t[4],.5);let h=0,u=o.squaredDistance(H[0],_);for(let t=1;t<4;++t){const e=o.squaredDistance(H[t],_);e<u&&(u=e,h=t)}o.subtract(q,H[h],t[h+4]);const l=q[0];let m,f;q[0]=-q[1],q[1]=l,o.subtract(G,F,_),o.dot(G,q)<0&&o.negate(q,q),o.lerp(q,q,G,a),o.normalize(q,q),m=f=o.dot(o.subtract(W,t[0],_),q);for(let e=1;e<8;++e){const a=o.dot(o.subtract(W,t[e],_),q);a<m?m=a:a>f&&(f=a)}o.copy(s,_),o.scale(W,q,m-e),o.add(s,s,W);let p=-1,x=1,b=0,g=0;for(let e=0;e<8;++e){o.subtract(B,t[e],s),o.normalize(B,B);const a=q[0]*B[1]-q[1]*B[0];a>0?a>p&&(p=a,b=e):a<x&&(x=a,g=e)}d.verify(p>0,"leftArea"),d.verify(x<0,"rightArea"),o.scale(E,q,m),o.add(E,E,_),o.scale(V,q,f),o.add(V,V,_),I[0]=-q[1],I[1]=q[0];const M=d.rayRay2D(s,t[g],V,o.add(W,V,I),1,r),y=d.rayRay2D(s,t[b],V,W,1,i),T=d.rayRay2D(s,t[b],E,o.add(W,E,I),1,c),w=d.rayRay2D(s,t[g],E,W,1,n);d.verify(M,"rayRay"),d.verify(y,"rayRay"),d.verify(T,"rayRay"),d.verify(w,"rayRay")}function K(t,e){return 3*e+t}const Q=n.create();function X(t,e){return o.set(Q,t[e],t[e+3]),Q}const Y=n.create(),Z=i.create();function $(t,e,a,s,r){o.subtract(Y,a,s),o.scale(Y,Y,.5),Z[0]=Y[0],Z[1]=Y[1],Z[2]=0,Z[3]=Y[1],Z[4]=-Y[0],Z[5]=0,Z[6]=Y[0]*Y[0]+Y[1]*Y[1],Z[7]=Y[0]*Y[1]-Y[1]*Y[0],Z[8]=1,Z[K(0,2)]=-o.dot(X(Z,0),t),Z[K(1,2)]=-o.dot(X(Z,1),t);let i=o.dot(X(Z,0),a)+Z[K(0,2)],c=o.dot(X(Z,1),a)+Z[K(1,2)],n=o.dot(X(Z,0),s)+Z[K(0,2)],h=o.dot(X(Z,1),s)+Z[K(1,2)];i=-(i+n)/(c+h),Z[K(0,0)]+=Z[K(1,0)]*i,Z[K(0,1)]+=Z[K(1,1)]*i,Z[K(0,2)]+=Z[K(1,2)]*i,i=1/(o.dot(X(Z,0),a)+Z[K(0,2)]),c=1/(o.dot(X(Z,1),a)+Z[K(1,2)]),Z[K(0,0)]*=i,Z[K(0,1)]*=i,Z[K(0,2)]*=i,Z[K(1,0)]*=c,Z[K(1,1)]*=c,Z[K(1,2)]*=c,Z[K(2,0)]=Z[K(1,0)],Z[K(2,1)]=Z[K(1,1)],Z[K(2,2)]=Z[K(1,2)],Z[K(1,2)]+=1,i=o.dot(X(Z,1),e)+Z[K(1,2)],c=o.dot(X(Z,2),e)+Z[K(2,2)],n=o.dot(X(Z,1),a)+Z[K(1,2)],h=o.dot(X(Z,2),a)+Z[K(2,2)],i=-.5*(i/c+n/h),Z[K(1,0)]+=Z[K(2,0)]*i,Z[K(1,1)]+=Z[K(2,1)]*i,Z[K(1,2)]+=Z[K(2,2)]*i,i=o.dot(X(Z,1),e)+Z[K(1,2)],c=o.dot(X(Z,2),e)+Z[K(2,2)],n=-c/i,Z[K(1,0)]*=n,Z[K(1,1)]*=n,Z[K(1,2)]*=n,r[0]=Z[0],r[1]=Z[1],r[2]=0,r[3]=Z[2],r[4]=Z[3],r[5]=Z[4],r[6]=0,r[7]=Z[5],r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=Z[6],r[13]=Z[7],r[14]=0,r[15]=Z[8]}return M}));
