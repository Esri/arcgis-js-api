// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","../../../../core/mathUtils","../../../../core/libs/gl-matrix-2/mat3f64","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec2","../../../../core/libs/gl-matrix-2/vec2f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../core/libs/gl-matrix-2/vec4","../../../../core/libs/gl-matrix-2/vec4f64","./Camera","./DefaultTextureUnits","./glUtil3D","./Util","../../../webgl/FramebufferObject","../../../webgl/Texture","../../../webgl/Util"],(function(e,t,a,r,i,c,s,o,n,h,v,u,d,f,m,p,l,x,b){"use strict";for(var g=function(){this.camera=new d.default,this.lightMat=c.mat4f64.create()},y=function(){function e(e,t){this.rctx=e,this.viewingMode=t,this._enabled=!1,this.textureSize=0,this.maxTextureSize=0,this.numCascades=1,this.maxNumCascades=4,this.splitSchemeLambda=0,this.warp=!0,this.cascadeDistances=[0,0,0,0,0],this.cascades=[],this.emptyTexture=m.createEmptyTexture(this.rctx),this.maxTextureSize=this.rctx.parameters.maxTextureSize;for(var a=0;a<4;++a)this.cascades.push(new g)}return e.prototype.dispose=function(){this.emptyTexture.dispose(),this.emptyTexture=null,this.discardDepthTexture()},Object.defineProperty(e.prototype,"maxCascades",{get:function(){return this.maxNumCascades},set:function(e){this.maxNumCascades=a.clamp(Math.floor(e),1,4)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"enabled",{get:function(){return this._enabled},set:function(e){this._enabled=e,e||this.discardDepthTexture()},enumerable:!1,configurable:!0}),e.prototype.getDepthTexture=function(){return this.depthTexture},e.prototype.getCascades=function(){for(var e=0;e<this.numCascades;++e)F[e]=this.cascades[e];return F.length=this.numCascades,F},e.prototype.prepare=function(e,t,r){p.assert(this.enabled),this.textureSize=this.computeTextureSize(e.fullWidth,e.fullHeight),this.assertDepthTexture(),i.mat4.multiply(T,e.projectionMatrix,e.viewMatrix);var c=r.near,s=r.far;c<2&&(c=2),s<2&&(s=2),c>=s&&(c=2,s=4),this.numCascades=Math.min(1+Math.floor(p.logWithBase(s/c,4)),this.maxNumCascades);for(var o=(s-c)/this.numCascades,h=Math.pow(s/c,1/this.numCascades),u=c,d=c,f=0;f<this.numCascades+1;++f)this.cascadeDistances[f]=a.lerp(u,d,this.splitSchemeLambda),u*=h,d+=o;i.mat4.invert(w,T);var m=1===this.viewingMode?e.eye:n.vec3.set(N,0,0,1);i.mat4.lookAt(L,[0,0,0],[-t[0],-t[1],-t[2]],m);var l=e.viewMatrix,x=e.projectionMatrix;for(f=0;f<this.numCascades;++f){var b=this.cascades[f],g=-this.cascadeDistances[f],y=-this.cascadeDistances[f+1],C=(x[10]*g+x[14])/Math.abs(x[11]*g+x[15]),F=(x[10]*y+x[14])/Math.abs(x[11]*y+x[15]);p.assert(C<F);for(var q=0;q<8;++q){var _=q%4==0||q%4==3?-1:1,G=q%4==0||q%4==1?-1:1,H=q<4?C:F;v.vec4.set(D,_,G,H,1),v.vec4.transformMat4(S[q],D,w);for(var W=0;W<3;++W)S[q][W]/=S[q][3]}n.vec3.negate(N,S[0]),i.mat4.translate(M,L,N),b.camera.viewMatrix=M;for(q=0;q<8;++q)n.vec3.transformMat4(S[q],S[q],b.camera.viewMatrix);n.vec3.copy(z,S[0]),n.vec3.copy(U,S[0]);for(q=1;q<8;++q)for(W=0;W<3;++W)z[W]=Math.min(z[W],S[q][W]),U[W]=Math.max(U[W],S[q][W]);if(z[2]-=200,U[2]+=200,b.camera.near=-U[2],b.camera.far=-z[2],this.warp){c=1/S[0][3],s=1/S[4][3],p.assert(c<s);var E=c+Math.sqrt(c*s),k=Math.sin(a.acosClamped(l[2]*t[0]+l[6]*t[1]+l[10]*t[2]));Q(S,E/=k,k,j,O,P,R,A),te(j,O,R,A,b.camera.projectionMatrix),b.camera.projectionMatrix[10]=2/(z[2]-U[2]),b.camera.projectionMatrix[14]=-(z[2]+U[2])/(z[2]-U[2])}else i.mat4.ortho(b.camera.projectionMatrix,z[0],U[0],z[1],U[1],b.camera.near,b.camera.far);i.mat4.multiply(b.lightMat,b.camera.projectionMatrix,b.camera.viewMatrix);var B=this.textureSize/2;b.camera.viewport[0]=f%2==0?0:B,b.camera.viewport[1]=0===Math.floor(f/2)?0:B,b.camera.viewport[2]=B,b.camera.viewport[3]=B}this.lastOrigin=null;var V=this.rctx;V.bindFramebuffer(this.fbo),V.bindTexture(null,7),V.setClearColor(1,1,1,1),V.clearSafe(16640)},e.prototype.finish=function(e){p.assert(this.enabled),this.rctx.bindFramebuffer(e)},e.prototype.bind=function(e,t){var a=this.rctx;a.bindTexture(this.enabled?this.depthTexture:this.emptyTexture,t),a.bindProgram(e),e.setUniform1i("depthTex",t),e.setUniform1f("depthHalfPixelSz",this.enabled?.5/this.textureSize:-1),e.setUniform1i("shadowMapNum",this.numCascades),e.setUniform4f("shadowMapDistance",this.cascadeDistances[0],this.numCascades>1?this.cascadeDistances[1]:1/0,this.numCascades>2?this.cascadeDistances[2]:1/0,this.numCascades>3?this.cascadeDistances[3]:1/0)},e.prototype.bindToAllPrograms=function(e){for(var t=e.getProgramsUsingUniform("shadowMapDistance"),a=0;a<t.length;a++)this.bind(t[a],f.DefaultTextureUnits.SHADOW_MAP)},e.prototype.bindView=function(e,t){if(this.enabled){var a=this.lastOrigin;if(!(a&&a[0]===t[0]&&a[1]===t[1]&&a[2]===t[2])){this.lastOrigin=this.lastOrigin||h.vec3f64.create(),n.vec3.copy(this.lastOrigin,t);for(var r=0;r<this.numCascades;++r){i.mat4.translate(q,this.cascades[r].lightMat,t);for(var c=0;c<16;++c)_[16*r+c]=q[c]}}e.setUniformMatrix4fv("shadowMapMatrix",_)}},e.prototype.computeTextureSize=function(e,t){var a=.5*Math.log(e*e+t*t)*Math.LOG2E,r=Math.pow(2,Math.round(a+.35));return Math.min(this.maxTextureSize,2*r)},e.prototype.assertDepthTexture=function(){if(null==this.depthTexture||this.depthTexture.descriptor.width!==this.textureSize){this.discardDepthTexture();var e={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0,width:this.textureSize,height:this.textureSize};this.depthTexture=new x(this.rctx,e),this.fbo=new l(this.rctx,{colorTarget:0,depthStencilTarget:1,width:this.textureSize,height:this.textureSize},this.depthTexture)}},e.prototype.discardDepthTexture=function(){this.fbo&&(this.fbo.dispose(),this.fbo=null),this.depthTexture&&(this.depthTexture.dispose(),this.depthTexture=null)},e.prototype.getGpuMemoryUsage=function(){return b.getGpuMemoryUsage(this.fbo)},Object.defineProperty(e.prototype,"test",{get:function(){var e=this;return{maxNumCascades:this.maxNumCascades,cascades:this.cascades,textureSize:this.textureSize,set splitSchemeLambda(t){e.splitSchemeLambda=t},get splitSchemeLambda(){return e.splitSchemeLambda},set warp(t){e.warp=t},get warp(){return e.warp}}},enumerable:!1,configurable:!0}),e}(),M=c.mat4f64.create(),T=c.mat4f64.create(),w=c.mat4f64.create(),D=u.vec4f64.create(),S=[],C=0;C<8;++C)S.push(u.vec4f64.create());var z=h.vec3f64.create(),U=h.vec3f64.create(),j=o.vec2f64.create(),O=o.vec2f64.create(),P=o.vec2f64.create(),R=o.vec2f64.create(),A=o.vec2f64.create(),L=c.mat4f64.create(),N=h.vec3f64.create(),F=[],q=c.mat4f64.create(),_=new Float32Array(64),G=o.vec2f64.create(),H=o.vec2f64.create(),W=[o.vec2f64.create(),o.vec2f64.create(),o.vec2f64.create(),o.vec2f64.create()],E=o.vec2f64.create(),k=o.vec2f64.create(),B=o.vec2f64.create(),V=o.vec2f64.create(),I=o.vec2f64.create(),J=o.vec2f64.create(),K=o.vec2f64.create();function Q(e,t,a,r,i,c,o,n){s.vec2.set(G,0,0);for(var h=0;h<4;++h)s.vec2.add(G,G,e[h]);s.vec2.scale(G,G,.25),s.vec2.set(H,0,0);for(h=4;h<8;++h)s.vec2.add(H,H,e[h]);s.vec2.scale(H,H,.25),s.vec2.lerp(W[0],e[4],e[5],.5),s.vec2.lerp(W[1],e[5],e[6],.5),s.vec2.lerp(W[2],e[6],e[7],.5),s.vec2.lerp(W[3],e[7],e[4],.5);var v=0,u=s.vec2.squaredDistance(W[0],G);for(h=1;h<4;++h){var d=s.vec2.squaredDistance(W[h],G);d<u&&(u=d,v=h)}s.vec2.subtract(E,W[v],e[v+4]);var f,m,l=E[0];E[0]=-E[1],E[1]=l,s.vec2.subtract(k,H,G),s.vec2.dot(k,E)<0&&s.vec2.negate(E,E),s.vec2.lerp(E,E,k,a),s.vec2.normalize(E,E),f=m=s.vec2.dot(s.vec2.subtract(B,e[0],G),E);for(h=1;h<8;++h){var x=s.vec2.dot(s.vec2.subtract(B,e[h],G),E);x<f?f=x:x>m&&(m=x)}s.vec2.copy(r,G),s.vec2.scale(B,E,f-t),s.vec2.add(r,r,B);var b=-1,g=1,y=0,M=0;for(h=0;h<8;++h){s.vec2.subtract(V,e[h],r),s.vec2.normalize(V,V);var T=E[0]*V[1]-E[1]*V[0];T>0?T>b&&(b=T,y=h):T<g&&(g=T,M=h)}p.verify(b>0,"leftArea"),p.verify(g<0,"rightArea"),s.vec2.scale(I,E,f),s.vec2.add(I,I,G),s.vec2.scale(J,E,m),s.vec2.add(J,J,G),K[0]=-E[1],K[1]=E[0];var w=p.rayRay2D(r,e[M],J,s.vec2.add(B,J,K),1,i),D=p.rayRay2D(r,e[y],J,B,1,c),S=p.rayRay2D(r,e[y],I,s.vec2.add(B,I,K),1,o),C=p.rayRay2D(r,e[M],I,B,1,n);p.verify(w,"rayRay"),p.verify(D,"rayRay"),p.verify(S,"rayRay"),p.verify(C,"rayRay")}function X(e,t){return 3*t+e}var Y=o.vec2f64.create();function Z(e,t){return s.vec2.set(Y,e[t],e[t+3]),Y}var $=o.vec2f64.create(),ee=r.mat3f64.create();function te(e,t,a,r,i){s.vec2.subtract($,a,r),s.vec2.scale($,$,.5),ee[0]=$[0],ee[1]=$[1],ee[2]=0,ee[3]=$[1],ee[4]=-$[0],ee[5]=0,ee[6]=$[0]*$[0]+$[1]*$[1],ee[7]=$[0]*$[1]-$[1]*$[0],ee[8]=1,ee[X(0,2)]=-s.vec2.dot(Z(ee,0),e),ee[X(1,2)]=-s.vec2.dot(Z(ee,1),e);var c=s.vec2.dot(Z(ee,0),a)+ee[X(0,2)],o=s.vec2.dot(Z(ee,1),a)+ee[X(1,2)],n=s.vec2.dot(Z(ee,0),r)+ee[X(0,2)],h=s.vec2.dot(Z(ee,1),r)+ee[X(1,2)];c=-(c+n)/(o+h),ee[X(0,0)]+=ee[X(1,0)]*c,ee[X(0,1)]+=ee[X(1,1)]*c,ee[X(0,2)]+=ee[X(1,2)]*c,c=1/(s.vec2.dot(Z(ee,0),a)+ee[X(0,2)]),o=1/(s.vec2.dot(Z(ee,1),a)+ee[X(1,2)]),ee[X(0,0)]*=c,ee[X(0,1)]*=c,ee[X(0,2)]*=c,ee[X(1,0)]*=o,ee[X(1,1)]*=o,ee[X(1,2)]*=o,ee[X(2,0)]=ee[X(1,0)],ee[X(2,1)]=ee[X(1,1)],ee[X(2,2)]=ee[X(1,2)],ee[X(1,2)]+=1,c=-.5*((c=s.vec2.dot(Z(ee,1),t)+ee[X(1,2)])/(o=s.vec2.dot(Z(ee,2),t)+ee[X(2,2)])+(n=s.vec2.dot(Z(ee,1),a)+ee[X(1,2)])/(h=s.vec2.dot(Z(ee,2),a)+ee[X(2,2)])),ee[X(1,0)]+=ee[X(2,0)]*c,ee[X(1,1)]+=ee[X(2,1)]*c,ee[X(1,2)]+=ee[X(2,2)]*c,c=s.vec2.dot(Z(ee,1),t)+ee[X(1,2)],n=-(o=s.vec2.dot(Z(ee,2),t)+ee[X(2,2)])/c,ee[X(1,0)]*=n,ee[X(1,1)]*=n,ee[X(1,2)]*=n,i[0]=ee[0],i[1]=ee[1],i[2]=0,i[3]=ee[2],i[4]=ee[3],i[5]=ee[4],i[6]=0,i[7]=ee[5],i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=ee[6],i[13]=ee[7],i[14]=0,i[15]=ee[8]}return y}));