/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/compilerUtils","../../../../core/Error","../../../../core/Evented","../../../../core/mathUtils","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/typedArrayUtil","../../../../core/urlUtils","../../../../support/requestImageUtils","../../../../support/requestUtils","./BasisUtil","./ContentObject","./DDSUtil","./glUtil3D","./Util","../../../webgl/FramebufferObject","../../../webgl/Texture","../../../webgl/Util","../../../webgl/capabilities/isWebGL2Context"],(function(e,t,r,i,a,o,s,n,l,h,m,d,p,u,c,f,g,w,T,x,y){"use strict";let D=function(e){function u(t,r){var i;return(i=e.call(this)||this).data=t,i.type=4,i.glTexture=null,i.powerOfTwoStretchInfo=null,i.loadingPromise=null,i.loadingController=null,i.events=new a,i.params=r||{},i.params.mipmap=!1!==i.params.mipmap,i.params.noUnpackFlip=i.params.noUnpackFlip||!1,i.params.preMultiplyAlpha=i.params.preMultiplyAlpha||!1,i.params.wrap=i.params.wrap||{s:10497,t:10497},i.params.powerOfTwoResizeMode=i.params.powerOfTwoResizeMode||1,i.estimatedTexMemRequired=u.estimateTexMemRequired(i.data,i.params),i.startPreload(),i}t._inheritsLoose(u,e);var D=u.prototype;return D.startPreload=function(){const e=this.data;s.isNone(e)||(e instanceof HTMLVideoElement?this.startPreloadVideoElement(e):e instanceof HTMLImageElement&&this.startPreloadImageElement(e))},D.startPreloadVideoElement=function(e){h.isBlobProtocol(e.src)||"auto"===e.preload&&e.crossOrigin||(e.preload="auto",e.crossOrigin="anonymous",e.src=e.src)},D.startPreloadImageElement=function(e){h.isDataProtocol(e.src)||h.isBlobProtocol(e.src)||e.crossOrigin||(e.crossOrigin="anonymous",e.src=e.src)},u.getDataDimensions=function(e){return e instanceof HTMLVideoElement?{width:e.videoWidth,height:e.videoHeight}:e},u.estimateTexMemRequired=function(e,t){if(s.isNone(e))return 0;if(l.isArrayBuffer(e)||l.isUint8Array(e))return t.encoding===u.KTX2_ENCODING?p.estimateMemoryKTX2(e,t.mipmap):t.encoding===u.BASIS_ENCODING?p.estimateMemoryBasis(e,t.mipmap):e.byteLength;const{width:r,height:i}=e instanceof Image||e instanceof ImageData||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement?u.getDataDimensions(e):t;return(t.mipmap?4/3:1)*r*i*(t.components||4)||0},D.dispose=function(){this.data=void 0},D.createDescriptor=function(e){var t;return{target:3553,pixelFormat:6408,dataType:5121,wrapMode:this.params.wrap,flipped:!this.params.noUnpackFlip,samplingMode:this.params.mipmap?9987:9729,hasMipmap:this.params.mipmap,preMultiplyAlpha:this.params.preMultiplyAlpha,maxAnisotropy:null!=(t=this.params.maxAnisotropy)?t:this.params.mipmap?e.parameters.maxMaxAnisotropy:1}},D.load=function(e,t){if(s.isSome(this.glTexture))return this.glTexture;if(s.isSome(this.loadingPromise))return this.loadingPromise;const r=this.data;return s.isNone(r)?(this.glTexture=new T(e,this.createDescriptor(e),null),this.glTexture):"string"==typeof r?this.loadFromURL(e,t,r):r instanceof Image?this.loadFromImageElement(e,t,r):r instanceof HTMLVideoElement?this.loadFromVideoElement(e,t,r):r instanceof ImageData||r instanceof HTMLCanvasElement?this.loadFromImage(e,r,t):(l.isArrayBuffer(r)||l.isUint8Array(r))&&this.params.encoding===u.DDS_ENCODING?this.loadFromDDSData(e,r):(l.isArrayBuffer(r)||l.isUint8Array(r))&&this.params.encoding===u.KTX2_ENCODING?this.loadFromKTX2(e,r):(l.isArrayBuffer(r)||l.isUint8Array(r))&&this.params.encoding===u.BASIS_ENCODING?this.loadFromBasis(e,r):l.isUint8Array(r)?this.loadFromPixelData(e,r):l.isArrayBuffer(r)?this.loadFromPixelData(e,new Uint8Array(r)):null},D.frameUpdate=function(e,t,r){if(!(this.data instanceof HTMLVideoElement)||s.isNone(this.glTexture))return r;if(this.data.readyState<2||r===this.data.currentTime)return r;if(s.isSome(this.powerOfTwoStretchInfo)){const{framebuffer:r,vao:i,sourceTexture:a}=this.powerOfTwoStretchInfo;a.setData(this.data),this.drawStretchedTexture(e,t,r,i,a,this.glTexture)}else{const{width:e,height:t}=this.data,{width:r,height:i}=this.glTexture.descriptor;e!==r||t!==i?this.glTexture.updateData(0,0,0,Math.min(e,r),Math.min(t,i),this.data):this.glTexture.setData(this.data)}return this.glTexture.descriptor.hasMipmap&&this.glTexture.generateMipmap(),this.data.currentTime},D.loadFromDDSData=function(e,t){return this.glTexture=c.createDDSTexture(e,this.createDescriptor(e),t),this.glTexture},D.loadFromKTX2=function(e,t){return this.loadAsync((()=>p.createTextureKTX2(e,this.createDescriptor(e),t).then((e=>(this.glTexture=e,e)))))},D.loadFromBasis=function(e,t){return this.loadAsync((()=>p.createTextureBasis(e,this.createDescriptor(e),t).then((e=>(this.glTexture=e,e)))))},D.loadFromPixelData=function(e,t){g.assert(this.params.width>0&&this.params.height>0);const r=this.createDescriptor(e);return r.pixelFormat=1===this.params.components?6409:3===this.params.components?6407:6408,r.width=this.params.width,r.height=this.params.height,this.glTexture=new T(e,r,t),this.glTexture},D.loadAsync=function(e){const t=n.createAbortController();this.loadingController=t;const r=e(t.signal);this.loadingPromise=r;const i=()=>{this.loadingController===t&&(this.loadingController=null),this.loadingPromise===r&&(this.loadingPromise=null)};return r.then(i,i),r},D.loadFromURL=function(e,r,i){var a=this;return this.loadAsync(function(){var o=t._asyncToGenerator((function*(t){const o=yield m.requestImage(i,{signal:t});return a.loadFromImage(e,o,r)}));return function(e){return o.apply(this,arguments)}}())},D.loadFromImageElement=function(e,r,i){var a=this;return i.complete?this.loadFromImage(e,i,r):this.loadAsync(function(){var o=t._asyncToGenerator((function*(t){const o=yield d.loadImageAsync(i,i.src,!1,t);return a.loadFromImage(e,o,r)}));return function(e){return o.apply(this,arguments)}}())},D.loadFromVideoElement=function(e,t,r){return r.readyState>=2?this.loadFromImage(e,r,t):this.loadFromVideoElementAsync(e,t,r)},D.loadFromVideoElementAsync=function(e,t,r){return this.loadAsync((a=>new Promise(((o,l)=>{const h=()=>{r.removeEventListener("loadeddata",m),r.removeEventListener("error",d),s.isSome(p)&&p.remove()},m=()=>{r.readyState>=2&&(h(),o(this.loadFromImage(e,r,t)))},d=e=>{h(),l(e||new i("Failed to load video"))};r.addEventListener("loadeddata",m),r.addEventListener("error",d);const p=n.onAbort(a,(()=>d(n.createAbortError())))}))))},D.loadFromImage=function(e,t,r){const i=u.getDataDimensions(t);this.params.width=i.width,this.params.height=i.height;const a=this.createDescriptor(e);return a.pixelFormat=3===this.params.components?6407:6408,!this.requiresPowerOfTwo(e,a)||o.isPowerOfTwo(i.width)&&o.isPowerOfTwo(i.height)?(a.width=i.width,a.height=i.height,this.glTexture=new T(e,a,t),this.glTexture):(this.glTexture=this.makePowerOfTwoTexture(e,t,i,a,r),this.glTexture)},D.requiresPowerOfTwo=function(e,t){const r=33071,i="number"==typeof t.wrapMode?t.wrapMode===r:t.wrapMode.s===r&&t.wrapMode.t===r;return!y(e.gl)&&(t.hasMipmap||!i)},D.makePowerOfTwoTexture=function(e,t,i,a,s){const{width:n,height:l}=i,h=o.nextHighestPowerOfTwo(n),m=o.nextHighestPowerOfTwo(l);let d;switch(a.width=h,a.height=m,this.params.powerOfTwoResizeMode){case 2:a.textureCoordinateScaleFactor=[n/h,l/m],d=new T(e,a),d.updateData(0,0,0,n,l,t);break;case 1:case null:case void 0:d=this.stretchToPowerOfTwo(e,t,a,s);break;default:r.neverReached(this.params.powerOfTwoResizeMode)}return a.hasMipmap&&d.generateMipmap(),d},D.stretchToPowerOfTwo=function(e,t,r,i){const a=new T(e,r),o=new w(e,{colorTarget:0,depthStencilTarget:0},a),s=new T(e,{target:3553,pixelFormat:r.pixelFormat,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!!r.flipped,maxAnisotropy:8,preMultiplyAlpha:r.preMultiplyAlpha},t),n=f.createQuadVAO(e);return this.drawStretchedTexture(e,i,o,n,s,a),this.requiresFrameUpdates?this.powerOfTwoStretchInfo={vao:n,sourceTexture:s,framebuffer:o}:(n.dispose(!0),s.dispose(),o.detachColorTexture(),e.bindFramebuffer(null),o.dispose()),a},D.drawStretchedTexture=function(e,t,r,i,a,o){e.bindFramebuffer(r);const s=e.getViewport();e.setViewport(0,0,o.descriptor.width,o.descriptor.height);const n=t.program;e.useProgram(n),n.setUniform4f("color",1,1,1,1),n.bindTexture(a,"tex"),e.bindVAO(i),e.setPipelineState(t.pipeline),e.drawArrays(5,0,x.vertexCount(i,"geometry")),e.bindFramebuffer(null),e.setViewport(s.x,s.y,s.width,s.height)},D.unload=function(){if(s.isSome(this.powerOfTwoStretchInfo)){const{framebuffer:e,vao:t,sourceTexture:r}=this.powerOfTwoStretchInfo;t.dispose(!0),r.dispose(),e.dispose(),this.glTexture=null,this.powerOfTwoStretchInfo=null}if(s.isSome(this.glTexture)&&(this.glTexture.dispose(),this.glTexture=null),s.isSome(this.loadingController)){const e=this.loadingController;this.loadingController=null,this.loadingPromise=null,e.abort()}this.events.emit("unloaded")},t._createClass(u,[{key:"width",get:function(){return this.params.width}},{key:"height",get:function(){return this.params.height}},{key:"requiresFrameUpdates",get:function(){return this.data instanceof HTMLVideoElement}}]),u}(u.ContentObject);D.DDS_ENCODING="image/vnd-ms.dds",D.KTX2_ENCODING="image/ktx2",D.BASIS_ENCODING="image/x.basis",e.Texture=D,Object.defineProperty(e,"__esModule",{value:!0})}));
