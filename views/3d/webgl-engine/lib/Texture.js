/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../core/compilerUtils","../../../../core/typedArrayUtil","../../../../core/maybe","../../../../core/Error","../../../../core/urlUtils","../../../../core/promiseUtils","../../../../core/Evented","../../../../core/mathUtils","../../../../support/requestUtils","../../../../support/requestImageUtils","./Util","../../../webgl/Texture","../../../webgl/Util","./glUtil3D","./IdGen","../../../webgl/FramebufferObject","../../../webgl/capabilities/isWebGL2Context","./DDSUtil"],(function(e,t,r,i,a,s,o,n,l,h,d,m,p,u,c,g,f,w,T){"use strict";let x=function(){function g(e,t,r){this.data=e,this.glTexture=null,this.powerOfTwoStretchInfo=null,this.loadingPromise=null,this.loadingController=null,this.events=new n,this.data=e,this.id=g.idGen.gen(t),this.params=r||{},this.params.mipmap=!1!==this.params.mipmap,this.params.noUnpackFlip=this.params.noUnpackFlip||!1,this.params.preMultiplyAlpha=this.params.preMultiplyAlpha||!1,this.params.wrap=this.params.wrap||{s:10497,t:10497},this.params.powerOfTwoResizeMode=this.params.powerOfTwoResizeMode||1,this.estimatedTexMemRequired=g.estimateTexMemRequired(this.data,this.params),this.startPreload()}var x=g.prototype;return x.startPreload=function(){const e=this.data;i.isNone(e)||(e instanceof HTMLVideoElement?this.startPreloadVideoElement(e):e instanceof HTMLImageElement&&this.startPreloadImageElement(e))},x.startPreloadVideoElement=function(e){s.isBlobProtocol(e.src)||"auto"===e.preload&&e.crossOrigin||(e.preload="auto",e.crossOrigin="anonymous",e.src=e.src)},x.startPreloadImageElement=function(e){s.isDataProtocol(e.src)||s.isBlobProtocol(e.src)||e.crossOrigin||(e.crossOrigin="anonymous",e.src=e.src)},g.getDataDimensions=function(e){return e instanceof HTMLVideoElement?{width:e.videoWidth,height:e.videoHeight}:e},g.estimateTexMemRequired=function(e,t){if(i.isNone(e))return 0;if(r.isArrayBuffer(e)||r.isUint8Array(e))return e.byteLength;const{width:a,height:s}=e instanceof Image||e instanceof ImageData||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement?g.getDataDimensions(e):t;return(t.mipmap?4/3:1)*a*s*(t.components||4)||0},x.dispose=function(){this.data=void 0},x.createDescriptor=function(e){const t=this.params.mipmap&&!this.params.disableAnisotropy;return{target:3553,pixelFormat:6408,dataType:5121,wrapMode:this.params.wrap,flipped:!this.params.noUnpackFlip,samplingMode:this.params.mipmap?9987:9729,hasMipmap:this.params.mipmap,preMultiplyAlpha:this.params.preMultiplyAlpha,maxAnisotropy:t?e.parameters.maxMaxAnisotropy:void 0}},x.load=function(e,t){if(i.isSome(this.glTexture))return this.glTexture;if(i.isSome(this.loadingPromise))return this.loadingPromise;const a=this.data;return i.isNone(a)?(this.glTexture=new p(e,this.createDescriptor(e),null),e.bindTexture(this.glTexture,0),this.glTexture):"string"==typeof a?this.loadFromURL(e,t,a):a instanceof Image?this.loadFromImageElement(e,t,a):a instanceof HTMLVideoElement?this.loadFromVideoElement(e,t,a):a instanceof ImageData||a instanceof HTMLCanvasElement?this.loadFromImage(e,a,t):(r.isArrayBuffer(a)||r.isUint8Array(a))&&this.params.encoding===g.DDS_ENCODING?this.loadFromDDSData(e,a):r.isUint8Array(a)?this.loadFromPixelData(e,a):r.isArrayBuffer(a)?this.loadFromPixelData(e,new Uint8Array(a)):null},x.frameUpdate=function(e,t,r){if(!(this.data instanceof HTMLVideoElement)||i.isNone(this.glTexture))return r;if(this.data.readyState<2||r===this.data.currentTime)return r;if(i.isSome(this.powerOfTwoStretchInfo)){const{framebuffer:r,vao:i,sourceTexture:a}=this.powerOfTwoStretchInfo;a.setData(this.data),this.drawStretchedTexture(e,t,r,i,a,this.glTexture)}else{const{width:e,height:t}=this.data,{width:r,height:i}=this.glTexture.descriptor;e!==r||t!==i?this.glTexture.updateData(0,0,0,Math.min(e,r),Math.min(t,i),this.data):this.glTexture.setData(this.data)}return this.glTexture.descriptor.hasMipmap&&this.glTexture.generateMipmap(),this.data.currentTime},x.loadFromDDSData=function(e,t){return this.glTexture=T.createDDSTexture(e,this.createDescriptor(e),t,this.params.mipmap),e.bindTexture(this.glTexture,0),this.glTexture},x.loadFromPixelData=function(e,t){m.assert(this.params.width>0&&this.params.height>0);const r=this.createDescriptor(e);return r.pixelFormat=1===this.params.components?6409:3===this.params.components?6407:6408,r.width=this.params.width,r.height=this.params.height,this.glTexture=new p(e,r,t),e.bindTexture(this.glTexture,0),this.glTexture},x.loadAsync=async function(e){const t=o.createAbortController();this.loadingController=t;const r=e(t.signal);this.loadingPromise=r;const i=()=>{this.loadingController===t&&(this.loadingController=null),this.loadingPromise===r&&(this.loadingPromise=null)};return r.then(i,i),r},x.loadFromURL=function(e,t,r){return this.loadAsync((async i=>{const a=await d.requestImage(r,{signal:i});return this.loadFromImage(e,a,t)}))},x.loadFromImageElement=function(e,t,r){return r.complete?this.loadFromImage(e,r,t):this.loadAsync((async i=>{const a=await h.loadImageAsync(r,r.src,!1,i);return this.loadFromImage(e,a,t)}))},x.loadFromVideoElement=function(e,t,r){return r.readyState>=2?this.loadFromImage(e,r,t):this.loadFromVideoElementAsync(e,t,r)},x.loadFromVideoElementAsync=function(e,t,r){return this.loadAsync((s=>o.create(((n,l)=>{const h=()=>{r.removeEventListener("loadeddata",d),r.removeEventListener("error",m),i.isSome(p)&&p.remove()},d=()=>{r.readyState>=2&&(h(),n(this.loadFromImage(e,r,t)))},m=e=>{h(),l(e||new a("Failed to load video"))};r.addEventListener("loadeddata",d),r.addEventListener("error",m);const p=o.onAbort(s,(()=>m(o.createAbortError())))}))))},x.loadFromImage=function(e,t,r){const i=g.getDataDimensions(t);this.params.width=i.width,this.params.height=i.height;const a=this.createDescriptor(e);return a.pixelFormat=3===this.params.components?6407:6408,!this.requiresPowerOfTwo(e,a)||l.isPowerOfTwo(i.width)&&l.isPowerOfTwo(i.height)?(a.width=i.width,a.height=i.height,this.glTexture=new p(e,a,t),e.bindTexture(this.glTexture,0),this.glTexture):(this.glTexture=this.makePowerOfTwoTexture(e,t,i,a,r),e.bindTexture(this.glTexture,0),this.glTexture)},x.requiresPowerOfTwo=function(e,t){const r=33071,i="number"==typeof t.wrapMode?t.wrapMode===r:t.wrapMode.s===r&&t.wrapMode.t===r;return!w(e.gl)&&(t.hasMipmap||!i)},x.makePowerOfTwoTexture=function(e,r,i,a,s){const{width:o,height:n}=i,h=l.nextHighestPowerOfTwo(o),d=l.nextHighestPowerOfTwo(n);let m;switch(a.width=h,a.height=d,this.params.powerOfTwoResizeMode){case 2:a.textureCoordinateScaleFactor=[o/h,n/d],m=new p(e,a),m.updateData(0,0,0,o,n,r);break;case 1:case null:case void 0:m=this.stretchToPowerOfTwo(e,r,a,s);break;default:t.neverReached(this.params.powerOfTwoResizeMode)}return a.hasMipmap&&m.generateMipmap(),m},x.stretchToPowerOfTwo=function(e,t,r,i){const a=new p(e,r),s=new f(e,{colorTarget:0,depthStencilTarget:0},a),o=new p(e,{target:3553,pixelFormat:r.pixelFormat,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!!r.flipped,maxAnisotropy:8,preMultiplyAlpha:r.preMultiplyAlpha},t),n=c.createQuadVAO(e);return this.drawStretchedTexture(e,i,s,n,o,a),this.requiresFrameUpdates?this.powerOfTwoStretchInfo={vao:n,sourceTexture:o,framebuffer:s}:(n.dispose(!0),o.dispose(),s.detachColorTexture(),e.bindFramebuffer(null),s.dispose()),a},x.drawStretchedTexture=function(e,t,r,i,a,s){e.bindFramebuffer(r);const o=e.getViewport();e.setViewport(0,0,s.descriptor.width,s.descriptor.height);const n=t.program;e.bindProgram(n),n.setUniform4f("color",1,1,1,1),n.setUniform1i("tex",0),e.bindTexture(a,0),e.bindVAO(i),e.setPipelineState(t.pipeline),e.drawArrays(5,0,u.vertexCount(i,"geometry")),e.bindFramebuffer(null),e.setViewport(o.x,o.y,o.width,o.height)},x.unload=function(){if(i.isSome(this.powerOfTwoStretchInfo)){const{framebuffer:e,vao:t,sourceTexture:r}=this.powerOfTwoStretchInfo;t.dispose(!0),r.dispose(),e.dispose(),this.glTexture=null,this.powerOfTwoStretchInfo=null}if(i.isSome(this.glTexture)&&(this.glTexture.dispose(),this.glTexture=null),i.isSome(this.loadingController)){const e=this.loadingController;this.loadingController=null,this.loadingPromise=null,e.abort()}this.events.emit("unloaded")},e._createClass(g,[{key:"width",get:function(){return this.params.width}},{key:"height",get:function(){return this.params.height}},{key:"requiresFrameUpdates",get:function(){return this.data instanceof HTMLVideoElement}}]),g}();return x.idGen=new g.IdGen,x.DDS_ENCODING="image/vnd-ms.dds",x}));
