// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../core/compilerUtils","../../../../core/Error","../../../../core/Evented","../../../../core/mathUtils","../../../../core/mathUtils","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/typedArrayUtil","../../../../core/urlUtils","../../../../support/requestUtils","../../support/imageUtils","./DDSUtil","./glUtil3D","./IdGen","./Util","../../../webgl/FramebufferObject","../../../webgl/Texture","../../../webgl/Util","../../../webgl/capabilities/isWebGL2Context"],(function(e,t,r,i,o,a,s,n,l,h,p,d,u,m,c,f,g,w,T,x,y,v){return function(){function e(t,r,i){this.data=t,this.glTexture=null,this.powerOfTwoStretchInfo=null,this.loadingPromise=null,this.loadingController=null,this.events=new a,this.data=t,this.id=e.idGen.gen(r),this.params=i||{},this.params.mipmap=!1!==this.params.mipmap,this.params.noUnpackFlip=this.params.noUnpackFlip||!1,this.params.preMultiplyAlpha=this.params.preMultiplyAlpha||!1,this.params.wrap=this.params.wrap||{s:10497,t:10497},this.params.powerOfTwoResizeMode=this.params.powerOfTwoResizeMode||1,this.estimatedTexMemRequired=e.estimateTexMemRequired(this.data,this.params),this.startPreload()}return e.prototype.startPreload=function(){var e=this.data;l.isNone(e)||(e instanceof HTMLVideoElement?this.startPreloadVideoElement(e):e instanceof HTMLImageElement&&this.startPreloadImageElement(e))},e.prototype.startPreloadVideoElement=function(e){d.isBlobProtocol(e.src)||"auto"===e.preload&&e.crossOrigin||(e.preload="auto",e.crossOrigin="anonymous",e.src=e.src)},e.prototype.startPreloadImageElement=function(e){d.isDataProtocol(e.src)||d.isBlobProtocol(e.src)||e.crossOrigin||(e.crossOrigin="anonymous",e.src=e.src)},e.getDataDimensions=function(e){return e instanceof HTMLVideoElement?{width:e.videoWidth,height:e.videoHeight}:e},e.estimateTexMemRequired=function(t,r){if(l.isNone(t))return 0;if(p.isArrayBuffer(t)||p.isUint8Array(t))return t.byteLength;var i=t instanceof Image||t instanceof ImageData||t instanceof HTMLCanvasElement||t instanceof HTMLVideoElement?e.getDataDimensions(t):r,o=i.width,a=i.height;return(r.mipmap?4/3:1)*o*a*(r.components||4)||0},e.prototype.dispose=function(){this.data=void 0},Object.defineProperty(e.prototype,"width",{get:function(){return this.params.width},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this.params.height},enumerable:!0,configurable:!0}),e.prototype.createDescriptor=function(e){var t=this.params.mipmap&&!this.params.disableAnisotropy;return{target:3553,pixelFormat:6408,dataType:5121,wrapMode:this.params.wrap,flipped:!this.params.noUnpackFlip,samplingMode:this.params.mipmap?9987:9729,hasMipmap:this.params.mipmap,preMultiplyAlpha:this.params.preMultiplyAlpha,maxAnisotropy:t?e.parameters.maxMaxAnisotropy:void 0}},e.prototype.load=function(t,r){if(l.isSome(this.glTexture))return this.glTexture;if(l.isSome(this.loadingPromise))return this.loadingPromise;var o=this.data;return l.isNone(o)?(this.glTexture=new x(t,this.createDescriptor(t),null),t.bindTexture(this.glTexture),this.glTexture):"string"==typeof o?this.loadFromURL(t,r,o):o instanceof Image?this.loadFromImageElement(t,r,o):o instanceof HTMLVideoElement?this.loadFromVideoElement(t,r,o):o instanceof ImageData||o instanceof HTMLCanvasElement?this.loadFromImage(t,o,r):(p.isArrayBuffer(o)||p.isUint8Array(o))&&this.params.encoding===e.DDS_ENCODING?this.loadFromDDSData(t,o):p.isUint8Array(o)?this.loadFromPixelData(t,o):p.isArrayBuffer(o)?this.loadFromPixelData(t,new Uint8Array(o)):(i.neverReachedSilent(o),null)},Object.defineProperty(e.prototype,"requiresFrameUpdates",{get:function(){return this.data instanceof HTMLVideoElement},enumerable:!0,configurable:!0}),e.prototype.frameUpdate=function(e,t,r){if(!(this.data instanceof HTMLVideoElement)||l.isNone(this.glTexture))return r;if(this.data.readyState<2||r===this.data.currentTime)return r;if(l.isSome(this.powerOfTwoStretchInfo)){var i=this.powerOfTwoStretchInfo,o=i.framebuffer,a=i.vao,s=i.sourceTexture;s.setData(this.data),this.drawStretchedTexture(e,t,o,a,s,this.glTexture)}else{var n=this.data,h=n.width,p=n.height,d=this.glTexture.descriptor,u=d.width,m=d.height;h!==u||p!==m?this.glTexture.updateData(0,0,0,Math.min(h,u),Math.min(p,m),this.data):this.glTexture.setData(this.data)}return this.glTexture.descriptor.hasMipmap&&this.glTexture.generateMipmap(),this.data.currentTime},e.prototype.loadFromDDSData=function(e,t){return this.glTexture=c.createDDSTexture(e,this.createDescriptor(e),t,this.params.mipmap),e.bindTexture(this.glTexture),this.glTexture},e.prototype.loadFromPixelData=function(e,t){w.assert(this.params.width>0&&this.params.height>0);var r=this.createDescriptor(e);return r.pixelFormat=1===this.params.components?6409:3===this.params.components?6407:6408,r.width=this.params.width,r.height=this.params.height,this.glTexture=new x(e,r,t),e.bindTexture(this.glTexture),this.glTexture},e.prototype.loadAsync=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,i,o,a=this;return r.__generator(this,(function(r){return t=h.createAbortController(),this.loadingController=t,i=e(t.signal),this.loadingPromise=i,o=function(){a.loadingController===t&&(a.loadingController=null),a.loadingPromise===i&&(a.loadingPromise=null)},i.then(o,o),[2,i]}))}))},e.prototype.loadFromURL=function(e,t,i){var o=this;return this.loadAsync((function(a){return r.__awaiter(o,void 0,void 0,(function(){var o;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,m.requestImage(i,{signal:a})];case 1:return o=r.sent(),[2,this.loadFromImage(e,o,t)]}}))}))}))},e.prototype.loadFromImageElement=function(e,t,i){var o=this;return i.complete?this.loadFromImage(e,i,t):this.loadAsync((function(a){return r.__awaiter(o,void 0,void 0,(function(){var o;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,u.loadImageAsync(i,i.src,!1,a)];case 1:return o=r.sent(),[2,this.loadFromImage(e,o,t)]}}))}))}))},e.prototype.loadFromVideoElement=function(e,t,r){return r.readyState>=2?this.loadFromImage(e,r,t):this.loadFromVideoElementAsync(e,t,r)},e.prototype.loadFromVideoElementAsync=function(e,t,r){var i=this;return this.loadAsync((function(a){return h.create((function(s,n){var p=function(){r.removeEventListener("loadeddata",d),r.removeEventListener("error",u),l.isSome(m)&&m.remove()},d=function(){r.readyState>=2&&(p(),s(i.loadFromImage(e,r,t)))},u=function(e){p(),n(e||new o("Failed to load video"))};r.addEventListener("loadeddata",d),r.addEventListener("error",u);var m=h.onAbort(a,(function(){return u(h.createAbortError())}))}))}))},e.prototype.loadFromImage=function(t,r,i){var o=e.getDataDimensions(r);this.params.width=o.width,this.params.height=o.height;var a=this.createDescriptor(t);return a.pixelFormat=3===this.params.components?6407:6408,!this.requiresPowerOfTwo(t,a)||n.isPowerOfTwo(o.width)&&n.isPowerOfTwo(o.height)?(a.width=o.width,a.height=o.height,this.glTexture=new x(t,a,r),t.bindTexture(this.glTexture),this.glTexture):(this.glTexture=this.makePowerOfTwoTexture(t,r,o,a,i),t.bindTexture(this.glTexture),this.glTexture)},e.prototype.requiresPowerOfTwo=function(e,t){var r="number"==typeof t.wrapMode?33071===t.wrapMode:33071===t.wrapMode.s&&33071===t.wrapMode.t;return!v.default(e.gl)&&(t.hasMipmap||!r)},e.prototype.makePowerOfTwoTexture=function(e,t,r,o,a){var n,l=r.width,h=r.height,p=s.nextHighestPowerOfTwo(l),d=s.nextHighestPowerOfTwo(h);switch(o.width=p,o.height=d,this.params.powerOfTwoResizeMode){case 2:o.textureCoordinateScaleFactor=[l/p,h/d],(n=new x(e,o)).updateData(0,0,0,l,h,t);break;case 1:case null:case void 0:n=this.stretchToPowerOfTwo(e,t,o,a);break;default:i.neverReached(this.params.powerOfTwoResizeMode)}return o.hasMipmap&&n.generateMipmap(),n},e.prototype.stretchToPowerOfTwo=function(e,t,r,i){var o=new x(e,r),a=new T(e,{colorTarget:0,depthStencilTarget:0},o),s=new x(e,{target:3553,pixelFormat:r.pixelFormat,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!!r.flipped,maxAnisotropy:8,preMultiplyAlpha:r.preMultiplyAlpha},t),n=f.createQuadVAO(e);return this.drawStretchedTexture(e,i,a,n,s,o),this.requiresFrameUpdates?this.powerOfTwoStretchInfo={vao:n,sourceTexture:s,framebuffer:a}:(n.dispose(!0),s.dispose(),a.detachColorTexture(),e.bindFramebuffer(null),a.dispose()),o},e.prototype.drawStretchedTexture=function(e,t,r,i,o,a){e.bindFramebuffer(r);var s=e.getViewport();e.setViewport(0,0,a.descriptor.width,a.descriptor.height);var n=t.program;e.bindProgram(n),n.setUniform4f("color",1,1,1,1),n.setUniform1i("tex",0),e.bindTexture(o,0),e.bindVAO(i),e.setPipelineState(t.pipeline),e.drawArrays(5,0,y.vertexCount(i,"geometry")),e.bindFramebuffer(null),e.setViewport(s.x,s.y,s.width,s.height)},e.prototype.unload=function(){if(l.isSome(this.powerOfTwoStretchInfo)){var e=this.powerOfTwoStretchInfo,t=e.framebuffer,r=e.vao,i=e.sourceTexture;r.dispose(!0),i.dispose(),t.dispose(),this.glTexture=null,this.powerOfTwoStretchInfo=null}if(l.isSome(this.glTexture)&&(this.glTexture.dispose(),this.glTexture=null),l.isSome(this.loadingController)){var o=this.loadingController;this.loadingController=null,this.loadingPromise=null,o.abort()}this.events.emit("unloaded")},e.idGen=new g.IdGen,e.DDS_ENCODING="image/vnd-ms.dds",e}()}));