/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import e from"../../../../core/PooledArray.js";import{isPromiseLike as t,createAbortError as r}from"../../../../core/promiseUtils.js";import{union as n}from"./depthRange.js";import{RenderSlot as s}from"./RenderSlot.js";class i{constructor(t){this.context=t,this._renderPlugins=new e,this.slots=[];for(let e=0;e<s.MAX_SLOTS;++e)this.slots[e]=[]}add(e,n,s){const i=()=>{if(s?.aborted)throw n.uninitializeRenderContext(),r();this._renderPlugins.push(n);for(const t of e)this.slots[t].push(n);this.context.requestRender()},o=n.initializeRenderContext(this.context,s);if(t(o))return o.then(i);i()}remove(e){if(null!=this._renderPlugins.removeUnordered(e)){for(let t=0;t<this.slots.length;++t)this.slots[t]=this.slots[t].filter((t=>t!==e));e.uninitializeRenderContext(),this.context.requestRender()}}prepareRender(){this._renderPlugins.forAll((e=>{e.prepareRender&&e.prepareRender(this.context.renderContext)}))}updateAnimation(e){let t=!1;return this._renderPlugins.forAll((r=>{r.updateAnimation&&(t=r.updateAnimation(e)||t)})),t}render(){const e=this.slots[this.context.renderContext.bindParameters.slot],t=new Array;e.filter((e=>{if(!e.canRender)return!1;if(o(e)){const r=e.prepareTechnique(this.context.renderContext);return!!r&&(t.push(r),!0)}return t.push(null),!0})).forEach(((e,r)=>e.render(this.context.renderContext,t[r])))}queryDepthRange(e){const t=d;return t.near=1/0,t.far=-1/0,this._renderPlugins.forAll((r=>{if(r.queryDepthRange){const s=r.queryDepthRange(e);s&&n(t,s,t)}})),t}get needsTransparentPass(){return this._renderPlugins.some((e=>e.needsTransparentPass))}get needsHighlight(){return this._renderPlugins.some((e=>e.needsHighlight))}get needsLinearDepth(){return this._renderPlugins.some((e=>e.needsLinearDepth))}get needsLaserlineWithContrastControl(){const e=this.slots[s.LASERLINES_CONTRAST_CONTROL];return!!e&&e.length>0}get renderOccludedFlags(){return this._renderPlugins.reduce(((e,t)=>e|t.renderOccludedFlags),0)}}function o(e){return"prepareTechnique"in e}const d={near:0,far:0};export{i as RenderPluginManager};
