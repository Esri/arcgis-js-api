/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../../core/maybe","../../../../geometry/SpatialReference","../../../../chunks/vec3f64","../../../../chunks/vec3","../../../../geometry/projection","../../../../chunks/mat4f64","./Util","./GeometryData","./Object3D","./Geometry","./localOrigin","./Layer","../materials/RibbonLineMaterial"],(function(t,i,e,n,r,o,s,a,c,h,l,d,O){"use strict";let _=0;let g=function(){function e(){this.ROOT_ORIGIN_ID="rg_root_"+_++,this._origins=new Map,this._gridSize=42e5}var g=e.prototype;return g.getOrigin=function(i){const r=this._origins.get(this.ROOT_ORIGIN_ID);if(null==r){if(t.isSome(e.testOrigin)){const t=e.testOrigin;return this._origins.set(this.ROOT_ORIGIN_ID,l.fromValues(t[0],t[1],t[2],this.ROOT_ORIGIN_ID)),this.getOrigin(i)}const n=l.fromValues(i[0]+Math.random()-.5,i[1]+Math.random()-.5,i[2]+Math.random()-.5,this.ROOT_ORIGIN_ID);return this._origins.set(this.ROOT_ORIGIN_ID,n),n}n.subtract(u,i,r.vec3),u[0]=Math.abs(u[0]),u[1]=Math.abs(u[1]),u[2]=Math.abs(u[2]);const o=this._gridSize;if(u[0]<o&&u[1]<o&&u[2]<o)return r;const s=Math.round(i[0]/o),a=Math.round(i[1]/o),c=Math.round(i[2]/o),h=`rg_${s}/${a}/${c}`;let d=this._origins.get(h);return d||(d=l.fromValues(s*o,a*o,c*o,h),this._origins.set(h,d)),d},g._drawOriginBox=function(t){const e=window.view,n=e._stage;if(null==this._object){this._material=new O.RibbonLineMaterial({width:2,color:[0,1,0,1]},"GridLocalOriginMaterial"),n.add(3,this._material);const t=new d("GridLocalOrigin",{isPickable:!1});n.add(0,t),this._object=new c({idHint:"GridLocalOrigin",castShadow:!1}),n.add(1,this._object),t.addObject(this._object),n.addToViewContent([t.id])}const l=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],_=l.length,g=new Float32Array(3*_),u=new Uint32Array(2*(_-1)),I=.5*this._gridSize;for(let i=0;i<_;i++)g[3*i+0]=t[0]+(1&l[i]?I:-I),g[3*i+1]=t[1]+(2&l[i]?I:-I),g[3*i+2]=t[2]+(4&l[i]?I:-I),i>0&&(u[2*i+0]=i-1,u[2*i+1]=i);r.projectBuffer(g,i.WebMercator,0,g,e.spatialReference,0,_);const f={};f[s.VertexAttrConstants.POSITION]={size:3,data:g};const m={};m[s.VertexAttrConstants.POSITION]=u;const b=new a.GeometryData(f,m,"line"),R=new h(b,"GridLocalOriginBox");n.add(2,R),this._object.addGeometry(R,this._material,o.IDENTITY),console.log(this._origins.size,t)},e}();const u=e.create();return function(t){t.testOrigin=null}(g||(g={})),g}));
