/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/arrayUtils","../../../../core/Handles","../../../../core/mathUtils","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec3","../../../../chunks/vec3f64","./BindParameters","./depthRange","./glUtil3D","./ShadowCastRenderer","./ShadowMap","../../../../chunks/ShadowCastAccumulate.glsl","../shaders/ShadowCastAccumulateTechnique","../../../support/Scheduler","../../../webgl/enums","../../../webgl/FramebufferObject","../../../webgl/Util"],(function(e,t,r,i,a,s,n,o,c,h,u,_,l,d,p,m,g,f,w,y,b,v,A,S,T){"use strict";e.ShadowAccumulator=function(e){function r(r,i,a,n,h,u){var _;(_=e.call(this,{})||this)._rctx=r,_._stage=a,_._prepareForShadowMapPass=n,_._renderToShadowMap=h,_._requestRender=u,_._progress=0,_._sampleCount=0,_._passParameters=new y.ShadowCastAccumulatePassParameters,_._enabledInternal=!1,_._cachedLightDirections=[],_._depthRange=m.ZERO,_._previewing=!1,_._handles=new s,_._cameraForcedForScreenshot=!1,_._bindParameters=new p.BindParameters(new w.ShadowMap(r,a.viewingMode),null,null),_._bindParameters.shadowMap.enabled=!0,_._vao=g.createQuadVAO(r);const l={colorTarget:A.TargetType.TEXTURE,depthStencilTarget:A.DepthStencilTargetType.NONE,width:0,height:0},d={target:A.TextureType.TEXTURE_2D,pixelFormat:A.PixelFormat.RGBA,dataType:A.PixelType.UNSIGNED_BYTE,samplingMode:A.TextureSamplingMode.LINEAR,wrapMode:A.TextureWrapMode.CLAMP_TO_EDGE,width:0,height:0};_._fbo=new S.FramebufferObject(r,l,d),_._accumulationRenderer=new f.ShadowCastRenderer(i,r,t._assertThisInitialized(_),u);const b=_._stage.view.resourceController.scheduler;return _._handles.add([b.registerTask(v.TaskPriority.SHADOW_ACCUMULATOR,t._assertThisInitialized(_)),c.watch((()=>a.renderView),(e=>{_._handles.remove(R),o.isSome(e)&&_._handles.add(e.events.on("force-camera-for-screenshot",(()=>_._cameraForcedForScreenshot=!0)),R)}),c.syncAndInitial),c.watch((()=>_._previewing),(()=>_._requestRenderIfEnabled()),c.sync)]),_}t._inheritsLoose(r,e);var i=r.prototype;return i.normalizeCtorArgs=function(){return{}},i.runTask=function(e){for(this._prepareForShadowMapPass(this._bindParameters);!e.done&&!this._isDoneAccumulating;)this._accumulateShadow(),e.madeProgress();this._requestRender()},i.renderAccumulation=function(e,t,r,i){if(this._depthRange=t,this._updateCamera(r),this._bindParameters.contentCamera=i,this._passParameters.linearDepthTexture=e,this._passParameters.origin=this._bindParameters.camera.center,this.notifyChange("canAccumulate"),!this.isAccumulating||!this.canAccumulate)return;(this._previewing||0===this._progress||this._cameraForcedForScreenshot)&&this._clear();const a=this._cameraForcedForScreenshot?this._sampleCount:Math.min(C,this._sampleCount-this._progress);for(let s=0;s<a;++s)this._accumulateShadow();this._cameraForcedForScreenshot=!1,this._requestRender()},i.render=function(e){this._accumulationRenderer.render(e)},i.dispose=function(){this._stop(),this._handles.destroy(),this._accumulationRenderer=o.disposeMaybe(this._accumulationRenderer),this._bindParameters.shadowMap.dispose(),this._fbo=o.disposeMaybe(this._fbo),this._vao=o.disposeMaybe(this._vao),this._accumulationTechniqueCached=o.releaseMaybe(this._accumulationTechniqueCached),this._cachedLightDirections.length=0,this._sampleCount=0},i.setOptions=function(e){void 0!==e.enabled&&(this._enabled=e.enabled),void 0!==e.previewing&&(this._previewing=e.previewing),void 0!==e.lightDirections&&(this._lightDirections=e.lightDirections),this._accumulationRenderer.setOptions(e)},i.readAccumulatedShadow=function(e,t){return!this._isActive||this._progress<1||e<0||e>this._fbo.width||t<0||t>this._fbo.height?0:(this._fbo.readPixels(e,t,1,1,A.PixelFormat.RGBA,A.PixelType.UNSIGNED_BYTE,D),D[0]/this._progress)},i._start=function(){this._progress=0,this._enabledInternal=!0},i._stop=function(){this._enabledInternal=!1},i._invalidate=function(){this._progress=0,this._requestRenderIfEnabled()},i._clear=function(){this._rctx.bindFramebuffer(this._fbo),this._rctx.setClearColor(0,0,0,0),this._rctx.clearSafe(A.ClearBufferBit.COLOR_BUFFER_BIT),this._progress=0},i._accumulateShadow=function(){this._renderToShadowMap(this._bindParameters,this._sampleLightDirection(),this._depthRange);const e=this._accumulationTechnique;this._rctx.bindFramebuffer(this._fbo),this._rctx.bindTechnique(e,this._passParameters,this._bindParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(e.primitiveType,0,T.vertexCount(this._vao,"geometry"))},i._sampleLightDirection=function(){return this._progress++,this._lightDirections[this._progress*P%this._lightDirections.length]},i._updateCamera=function(e){e.equals(this._bindParameters.camera)||(this._bindParameters.camera.copyFrom(e),this._fbo.resize(e.fullWidth,e.fullHeight),this._opacityFromElevation=1-n.smoothstep(f.shadowCastDisableElevationMin,f.shadowCastDisableElevationMax,e.relativeElevation))},i._requestRenderIfEnabled=function(){this._enabledInternal&&this._requestRender()},t._createClass(r,[{key:"computedSamples",get:function(){return this._progress}},{key:"shadowCastTexture",get:function(){return this._fbo.colorTexture}},{key:"isAccumulating",get:function(){return this._isPreviewing||this._isRefining}},{key:"_accumulationTechnique",get:function(){if(o.isNone(this._accumulationTechniqueCached)){const e={rctx:this._rctx,viewingMode:this._stage.viewingMode};this._accumulationTechniqueCached=new b.ShadowCastAccumulateTechnique(e)}return this._accumulationTechniqueCached}},{key:"_isRefining",get:function(){return this._isActive&&!this._isDoneAccumulating&&!this._previewing}},{key:"_isPreviewing",get:function(){return this._isActive&&this._previewing}},{key:"_isActive",get:function(){return this._enabledInternal&&this._sampleCount>0}},{key:"canAccumulate",get:function(){return null!==this._passParameters.linearDepthTexture&&this._depthRange!==m.ZERO&&this._opacityFromElevation>f.shadowCastDisabledElevationThreshold}},{key:"_isDoneAccumulating",get:function(){return this._progress>=this._sampleCount}},{key:"_lightDirections",get:function(){return this._cachedLightDirections},set:function(e){const t=this._cachedLightDirections;if(a.equals(t,e,l.equals))return;const r=Math.min(y.ShadowCastMaxSamples,e.length);t.length=r,this._sampleCount=r;for(let i=0;i<r;++i)t[i]=l.copy(t[i]??d.create(),e[i]);this._invalidate()}},{key:"_opacityFromElevation",get:function(){return this._accumulationRenderer.opacityFromElevation},set:function(e){this._accumulationRenderer.opacityFromElevation=e}},{key:"running",get:function(){return this._isRefining&&this.canAccumulate&&this._progress>0}},{key:"_enabled",set:function(e){e!==this._enabledInternal&&(e?this._start():this._stop())}},{key:"test",get:function(){const e=this;return{lightDirections:this._lightDirections,get isDone(){return e._isDoneAccumulating},get isActive(){return e._isActive}}}}]),r}(i),r.__decorate([h.property()],e.ShadowAccumulator.prototype,"_progress",void 0),r.__decorate([h.property()],e.ShadowAccumulator.prototype,"_sampleCount",void 0),r.__decorate([h.property()],e.ShadowAccumulator.prototype,"_enabledInternal",void 0),r.__decorate([h.property()],e.ShadowAccumulator.prototype,"_depthRange",void 0),r.__decorate([h.property()],e.ShadowAccumulator.prototype,"_previewing",void 0),r.__decorate([h.property()],e.ShadowAccumulator.prototype,"_accumulationRenderer",void 0),r.__decorate([h.property()],e.ShadowAccumulator.prototype,"_isRefining",null),r.__decorate([h.property()],e.ShadowAccumulator.prototype,"_isActive",null),r.__decorate([h.property()],e.ShadowAccumulator.prototype,"canAccumulate",null),r.__decorate([h.property()],e.ShadowAccumulator.prototype,"_isDoneAccumulating",null),r.__decorate([h.property()],e.ShadowAccumulator.prototype,"_opacityFromElevation",null),r.__decorate([h.property()],e.ShadowAccumulator.prototype,"running",null),e.ShadowAccumulator=r.__decorate([_.subclass("esri.views.3d.webgl-engine.lib.ShadowAccumulator")],e.ShadowAccumulator);const C=6,R="renderView",P=104729,D=new Uint8Array(4);Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
