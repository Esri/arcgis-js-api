/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/arrayUtils","../../../../core/Handles","../../../../core/mathUtils","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec3","../../../../chunks/vec3f64","./BindParameters","./Camera","./depthRange","./glUtil3D","./ShadowCastRenderer","./ShadowMap","../../../../chunks/ShadowCastAccumulate.glsl","../shaders/ShadowCastAccumulateTechnique","../../../support/Scheduler","../../../webgl/enums","../../../webgl/FramebufferObject","../../../webgl/Util"],(function(e,t,r,i,a,s,n,o,c,h,u,l,d,_,p,m,g,w,f,y,b,v,A,S,C,T){"use strict";var R;e.ShadowAccumulator=R=function(e){function r(r,i,a,n,h,u){var l;(l=e.call(this,{})||this)._rctx=r,l._stage=a,l._prepareForShadowMapPass=n,l._renderToShadowMap=h,l._requestRender=u,l._progress=0,l._sampleCount=0,l._passParameters=new b.ShadowCastAccumulatePassParameters,l._enabledInternal=!1,l._cachedLightDirections=[],l._depthRange=g.ZERO,l._previewingCached=!1,l._handles=new s,l._cameraForcedForScreenshot=!1,l._bindParameters=new p.BindParameters(new y.ShadowMap(r,a.viewingMode),null,null),l._bindParameters.shadowMap.enabled=!0,l._bindParameters.camera=new m.Camera,l._vao=w.createQuadVAO(r);const d={colorTarget:S.TargetType.TEXTURE,depthStencilTarget:S.DepthStencilTargetType.NONE,width:0,height:0},_={target:S.TextureType.TEXTURE_2D,pixelFormat:S.PixelFormat.RGBA,dataType:S.PixelType.UNSIGNED_BYTE,samplingMode:S.TextureSamplingMode.LINEAR,wrapMode:S.TextureWrapMode.CLAMP_TO_EDGE,width:0,height:0};l._fbo=new C.FramebufferObject(r,d,_),l._accumulationRenderer=new f.ShadowCastRenderer(i,r,t._assertThisInitialized(l),u);const v=l._stage.resourceController.scheduler;return l._handles.add(v.registerTask(A.TaskPriority.SHADOW_ACCUMULATOR,t._assertThisInitialized(l))),l._handles.add(c.watch((()=>a.renderView),(e=>{l._handles.remove(R.renderViewHandleKey),o.isNone(e)||l._handles.add(e.events.on("force-camera-for-screenshot",(()=>l._cameraForcedForScreenshot=!0)),R.renderViewHandleKey)}),c.syncAndInitial)),l}t._inheritsLoose(r,e);var i=r.prototype;return i.normalizeCtorArgs=function(){return{}},i.runTask=function(e){for(this._prepareForShadowMapPass(this._bindParameters);!e.done&&!this._isDoneAccumulating;)this._accumulateShadow(),e.madeProgress();this._requestRender()},i.renderAccumulation=function(e,t,r,i){if(this._passParameters.linearDepthTexture=e,this._depthRange=t,this._updateCamera(r),this._bindParameters.contentCamera=i,this.notifyChange("canAccumulate"),!this.isAccumulating||!this.canAccumulate)return;(this._previewingCached||0===this._progress||this._cameraForcedForScreenshot)&&this._clear();const a=this._cameraForcedForScreenshot?this._sampleCount:Math.min(R.previewSamples,this._sampleCount-this._progress);for(let s=0;s<a;++s)this._accumulateShadow();this._cameraForcedForScreenshot=!1},i.render=function(e){this._accumulationRenderer.render(e)},i.dispose=function(){this._stop(),this._handles.destroy(),this._accumulationRenderer=o.disposeMaybe(this._accumulationRenderer),this._bindParameters.shadowMap.dispose(),this._fbo=o.disposeMaybe(this._fbo),this._vao=o.disposeMaybe(this._vao),this._accumulationTechniqueCached=o.releaseMaybe(this._accumulationTechniqueCached),this._cachedLightDirections.length=0,this._sampleCount=0},i.setOptions=function(e){void 0!==e.enabled&&(this._enabled=e.enabled),void 0!==e.previewing&&(this._previewing=e.previewing),void 0!==e.lightDirections&&(this._lightDirections=e.lightDirections),this._accumulationRenderer.setOptions(e)},i.readAccumulatedShadow=function(e,t){if(!this._isActive||this._progress<1||e<0||e>this._fbo.width||t<0||t>this._fbo.height)return 0;const r=P;return this._fbo.readPixels(e,t,1,1,S.PixelFormat.RGBA,S.PixelType.UNSIGNED_BYTE,r),r[0]/this._progress},i._start=function(){this._progress=0,this._enabledInternal=!0},i._stop=function(){this._enabledInternal=!1},i._invalidate=function(){this._progress=0,this._requestRenderIfEnabled()},i._clear=function(){this._rctx.bindFramebuffer(this._fbo),this._rctx.setClearColor(0,0,0,0),this._rctx.clearSafe(S.ClearBufferBit.COLOR_BUFFER_BIT),this._progress=0},i._accumulateShadow=function(){const e=this._lightDirectionsInternal[this._progress];this._renderToShadowMap(this._bindParameters,e,this._depthRange),this._passParameters.origin=this._bindParameters.camera.center,this._rctx.bindFramebuffer(this._fbo);const t=this._accumulationTechnique;this._rctx.bindTechnique(t,this._passParameters,this._bindParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(t.primitiveType,0,T.vertexCount(this._vao,"geometry")),this._progress++},i._updateCamera=function(e){e.equals(this._bindParameters.camera)||(this._bindParameters.camera.copyFrom(e),this._fbo.resize(e.fullWidth,e.fullHeight),this._opacityFromElevation=1-n.smoothstep(f.shadowCastDisableElevationMin,f.shadowCastDisableElevationMax,e.relativeElevation))},i._requestRenderIfEnabled=function(){this._enabledInternal&&this._requestRender()},t._createClass(r,[{key:"computedSamples",get:function(){return this._progress}},{key:"shadowCastTexture",get:function(){return this._fbo.colorTexture}},{key:"isAccumulating",get:function(){return this._isPreviewing||this._isRefining}},{key:"_accumulationTechnique",get:function(){if(o.isNone(this._accumulationTechniqueCached)){const e={rctx:this._rctx,viewingMode:this._stage.viewingMode};this._accumulationTechniqueCached=new v.ShadowCastAccumulateTechnique(e)}return this._accumulationTechniqueCached}},{key:"_isRefining",get:function(){return this._isActive&&!this._isDoneAccumulating&&!this._previewingCached}},{key:"_isPreviewing",get:function(){return this._isActive&&this._previewingCached}},{key:"_isActive",get:function(){return this._enabledInternal&&this._sampleCount>0}},{key:"canAccumulate",get:function(){return null!==this._passParameters.linearDepthTexture&&this._depthRange!==g.ZERO&&this._opacityFromElevation>f.shadowCastDisabledElevationThreshold}},{key:"_isDoneAccumulating",get:function(){return this._progress>=this._sampleCount}},{key:"_lightDirectionsInternal",get:function(){return this._cachedLightDirections},set:function(e){const t=this._cachedLightDirections;if(a.equals(t,e,d.equals))return;const r=e.length;t.length=r,this._sampleCount=Math.min(b.shadowCastMaxSamples,r);for(let i=0;i<r;++i){const r=e[i],a=t[i]||_.create();d.copy(a,r),t[i]=a}this._invalidate()}},{key:"_opacityFromElevation",get:function(){return this._accumulationRenderer.opacityFromElevation},set:function(e){this._accumulationRenderer.opacityFromElevation=e}},{key:"running",get:function(){return this._isRefining&&this.canAccumulate&&this._progress>0}},{key:"_previewing",set:function(e){this._previewingCached!==e&&(this._previewingCached=e,this._requestRenderIfEnabled())}},{key:"_lightDirections",set:function(e){this._lightDirectionsInternal=e}},{key:"_enabled",set:function(e){e!==this._enabledInternal&&(e?this._start():this._stop())}},{key:"test",get:function(){const e=this;return{lightDirections:this._lightDirectionsInternal,get isDone(){return e._isDoneAccumulating},get isActive(){return e._isActive}}}}]),r}(i),e.ShadowAccumulator.previewSamples=6,e.ShadowAccumulator.renderViewHandleKey="renderView",r.__decorate([h.property()],e.ShadowAccumulator.prototype,"_progress",void 0),r.__decorate([h.property()],e.ShadowAccumulator.prototype,"_sampleCount",void 0),r.__decorate([h.property()],e.ShadowAccumulator.prototype,"_enabledInternal",void 0),r.__decorate([h.property()],e.ShadowAccumulator.prototype,"_depthRange",void 0),r.__decorate([h.property()],e.ShadowAccumulator.prototype,"_previewingCached",void 0),r.__decorate([h.property()],e.ShadowAccumulator.prototype,"_accumulationRenderer",void 0),r.__decorate([h.property()],e.ShadowAccumulator.prototype,"_isRefining",null),r.__decorate([h.property()],e.ShadowAccumulator.prototype,"_isActive",null),r.__decorate([h.property()],e.ShadowAccumulator.prototype,"canAccumulate",null),r.__decorate([h.property()],e.ShadowAccumulator.prototype,"_isDoneAccumulating",null),r.__decorate([h.property()],e.ShadowAccumulator.prototype,"_opacityFromElevation",null),r.__decorate([h.property()],e.ShadowAccumulator.prototype,"running",null),e.ShadowAccumulator=R=r.__decorate([l.subclass("esri.views.3d.webgl-engine.lib.ShadowAccumulator")],e.ShadowAccumulator);const P=new Uint8Array(4);Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
