/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/arrayUtils","../../../../core/Handles","../../../../core/mathUtils","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec2f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../chunks/vec4f64","./Camera","./depthRange","./glUtil3D","./ShadowCastRenderer","./ShadowMap","./Util","../../../../chunks/ShadowCast.glsl","../shaders/ShadowCastTechnique","../../../support/Scheduler","../../../webgl/enums","../../../webgl/FramebufferObject","../../../webgl/Util"],(function(e,t,i,r,a,s,o,n,c,h,u,_,l,d,p,m,g,w,f,v,y,S,b,A,T,C,M,R,x,D,E){"use strict";var F;e.ShadowAccumulator=F=function(e){function i(i,r,a,o,h,u){var _;(_=e.call(this,{})||this)._rctx=i,_._stage=a,_._prepareForShadowMapPass=o,_._renderToShadowMap=h,_._requestRender=u,_._progress=0,_._sampleCount=0,_._cachedCamera=new v.default,_._contentCamera=new v.default,_._enabled=!1,_._cachedLightDirections=[],_._depthRange=y.ZERO,_._previewing=!1,_._handles=new s,_._cameraForcedForScreenshot=!1,_._shadowMap=new A(i,a.viewingMode),_._shadowMap.enabled=!0,_._vao=S.createQuadVAO(i);const l={colorTarget:x.TargetType.TEXTURE,depthStencilTarget:x.DepthStencilTargetType.NONE,width:0,height:0},d={target:x.TextureType.TEXTURE_2D,pixelFormat:x.PixelFormat.RGBA,dataType:x.PixelType.UNSIGNED_BYTE,samplingMode:x.TextureSamplingMode.LINEAR,wrapMode:x.TextureWrapMode.CLAMP_TO_EDGE,width:0,height:0};_._fbo=new D.FramebufferObject(i,l,d),_._accumulationParams={camera:_._cachedCamera,linearDepthTexture:null,shadowMap:_._shadowMap,inverseViewMatrix:p.create(),projInfo:f.create(),zScale:m.create()},_._accumulationRenderer=new b.ShadowCastRenderer(r,i,t._assertThisInitialized(_),u);const g=_._stage.resourceController.scheduler;return _._handles.add(g.registerTask(R.TaskPriority.SHADOW_ACCUMULATOR,t._assertThisInitialized(_))),_._handles.add(c.watch((()=>a.renderView),(e=>{_._handles.remove(F.renderViewHandleKey),n.isNone(e)||_._handles.add(e.events.on("force-camera-for-screenshot",(()=>_._cameraForcedForScreenshot=!0)),F.renderViewHandleKey)}),c.syncAndInitial)),_}t._inheritsLoose(i,e);var r=i.prototype;return r.normalizeCtorArgs=function(){return{}},r.runTask=function(e){for(this._prepareForShadowMapPass(this._cachedCamera,this._contentCamera);!e.done&&!this._isDoneAccumulating;)this._accumulateShadow(),e.madeProgress();this._requestRender()},r.accumulateFixedSamples=function(){if(!this.isAccumulating||!this._canAccumulate)return;(this._previewing||0===this._progress||this._cameraForcedForScreenshot)&&this._clear();const e=this._cameraForcedForScreenshot?this._sampleCount:Math.min(F.previewSamples,this._sampleCount-this._progress);for(let t=0;t<e;++t)this._accumulateShadow();this._cameraForcedForScreenshot=!1},r.render=function(){this._accumulationRenderer.render()},r.dispose=function(){this._stop(),this._handles.destroy(),this._accumulationRenderer=n.disposeMaybe(this._accumulationRenderer),this._shadowMap=n.disposeMaybe(this._shadowMap),this._fbo=n.disposeMaybe(this._fbo),this._vao=n.disposeMaybe(this._vao),this._accumulationTechnique=n.releaseMaybe(this._accumulationTechnique),this._cachedLightDirections.length=0,this._sampleCount=0},r.setOptions=function(e){void 0!==e.enabled&&this._setEnabled(e.enabled),void 0!==e.previewing&&this.setPreviewing(e.previewing),void 0!==e.lightDirections&&this.setLightDirections(e.lightDirections),this._accumulationRenderer.setOptions(e)},r.setPreviewing=function(e){this._previewing!==e&&(this._previewing=e,this._requestRenderIfEnabled())},r.setLightDirections=function(e){this._lightDirections=e},r.setAccumulationDependencies=function(e,t,i,r){this._accumulationParams.linearDepthTexture=e,this._depthRange=t,this._updateCamera(i),this._contentCamera=r,this.notifyChange("_canAccumulate")},r.readAccumulatedShadow=function(e,t){if(!this._isActive||this._progress<1||e<0||e>this._fbo.width||t<0||t>this._fbo.height)return 0;const i=k;return this._fbo.readPixels(e,t,1,1,x.PixelFormat.RGBA,x.PixelType.UNSIGNED_BYTE,i),i[0]/this._progress},r._start=function(){this._progress=0,this._enabled=!0},r._stop=function(){this._enabled=!1},r._invalidate=function(){this._progress=0,this._requestRenderIfEnabled()},r._clear=function(){this._rctx.bindFramebuffer(this._fbo),this._rctx.setClearColor(0,0,0,0),this._rctx.clearSafe(x.ClearBufferBit.COLOR_BUFFER_BIT),this._progress=0},r._accumulateShadow=function(){const e=this._lightDirections[this._progress],t=this._cachedCamera;this._renderToShadowMap(this._shadowMap,e,t,this._depthRange),this._rctx.bindFramebuffer(this._fbo);const i=this.accumulationTechnique;this._rctx.useTechnique(i),i.bindPass(this._accumulationParams),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(i.primitiveType,0,E.vertexCount(this._vao,"geometry")),this._progress++},r._updateCamera=function(e){if(e.equals(this._cachedCamera))return;const{fullWidth:t,fullHeight:i,projectionMatrix:r,viewMatrix:a,center:s}=e;this._cachedCamera.copyFrom(e),this._fbo.resize(t,i),T.inverseProjectionInfo(r,t,i,this._projInfo,this._zScale),d.translate(this._inverseView,a,s),d.invert(this._inverseView,this._inverseView),this._opacityFromElevation=1-o.smoothstep(b.shadowCastDisableElevationMin,b.shadowCastDisableElevationMax,e.relativeElevation)},r._setEnabled=function(e){e!==this._enabled&&(e?this._start():this._stop())},r._requestRenderIfEnabled=function(){this._enabled&&this._requestRender()},t._createClass(i,[{key:"computedSamples",get:function(){return this._progress}},{key:"shadowCastTexture",get:function(){return this._fbo.colorTexture}},{key:"isAccumulating",get:function(){return this._isPreviewing||this._isRefining}},{key:"accumulationTechnique",get:function(){if(n.isNone(this._accumulationTechnique)){const e={rctx:this._rctx,viewingMode:this._stage.viewingMode},t=new M.ShadowCastTechniqueConfiguration;t.pass=C.ShadowCastPass.Accumulate,this._accumulationTechnique=new M.ShadowCastTechnique(e,t)}return this._accumulationTechnique}},{key:"_isRefining",get:function(){return this._isActive&&!this._isDoneAccumulating&&!this._previewing}},{key:"_isPreviewing",get:function(){return this._isActive&&this._previewing}},{key:"_isActive",get:function(){return this._enabled&&this._sampleCount>0}},{key:"_canAccumulate",get:function(){return null!==this._accumulationParams.linearDepthTexture&&this._depthRange!==y.ZERO&&this._opacityFromElevation>b.shadowCastDisabledElevationThreshold}},{key:"_isDoneAccumulating",get:function(){return this._progress>=this._sampleCount}},{key:"_lightDirections",get:function(){return this._cachedLightDirections},set:function(e){const t=this._cachedLightDirections;if(a.equals(t,e,g.equals))return;const i=e.length;t.length=i,this._sampleCount=Math.min(C.shadowCastMaxSamples,i);for(let r=0;r<i;++r){const i=e[r],a=t[r]||w.create();g.copy(a,i),t[r]=a}this._invalidate()}},{key:"_projInfo",get:function(){return this._accumulationParams.projInfo}},{key:"_zScale",get:function(){return this._accumulationParams.zScale}},{key:"_inverseView",get:function(){return this._accumulationParams.inverseViewMatrix}},{key:"_opacityFromElevation",get:function(){return this._accumulationRenderer.opacityFromElevation},set:function(e){this._accumulationRenderer.opacityFromElevation=e}},{key:"running",get:function(){return this._isRefining&&this._canAccumulate&&this._progress>0}},{key:"test",get:function(){return{lightDirections:this._lightDirections,isDone:()=>this._isDoneAccumulating,isActive:()=>this._isActive}}}]),i}(r),e.ShadowAccumulator.previewSamples=6,e.ShadowAccumulator.renderViewHandleKey="renderView",i.__decorate([h.property()],e.ShadowAccumulator.prototype,"_progress",void 0),i.__decorate([h.property()],e.ShadowAccumulator.prototype,"_sampleCount",void 0),i.__decorate([h.property()],e.ShadowAccumulator.prototype,"_enabled",void 0),i.__decorate([h.property()],e.ShadowAccumulator.prototype,"_depthRange",void 0),i.__decorate([h.property()],e.ShadowAccumulator.prototype,"_previewing",void 0),i.__decorate([h.property()],e.ShadowAccumulator.prototype,"_accumulationRenderer",void 0),i.__decorate([h.property()],e.ShadowAccumulator.prototype,"_isRefining",null),i.__decorate([h.property()],e.ShadowAccumulator.prototype,"_isActive",null),i.__decorate([h.property()],e.ShadowAccumulator.prototype,"_canAccumulate",null),i.__decorate([h.property()],e.ShadowAccumulator.prototype,"_isDoneAccumulating",null),i.__decorate([h.property()],e.ShadowAccumulator.prototype,"_opacityFromElevation",null),i.__decorate([h.property()],e.ShadowAccumulator.prototype,"running",null),e.ShadowAccumulator=F=i.__decorate([l.subclass("esri.views.3d.webgl-engine.lib.ShadowAccumulator")],e.ShadowAccumulator);const k=new Uint8Array(4);Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
