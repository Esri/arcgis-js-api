/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/arrayUtils","../../../../core/Handles","../../../../core/mathUtils","../../../../core/maybe","../../../../core/accessorSupport/trackingUtils","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec2f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../chunks/vec4f64","../../../webgl/BufferObject","../../../webgl/FramebufferObject","../../../../core/has","../../../webgl/checkWebGLError","../../../webgl/enums","../../../../chunks/builtins","../../../webgl/renderState","../../../webgl/Texture","../../../webgl/VertexArrayObject","./Camera","./depthRange","./glUtil3D","./ShadowCastRenderer","./ShadowMap","./Util","../../../../chunks/ShadowCast.glsl","../shaders/ShadowCastTechnique","../../../support/Scheduler","../../../webgl/Util"],(function(e,t,i,s,n,a,r,o,h,c,u,_,l,d,p,g,m,f,w,v,b,y,C,S,M,k,D,T,x,A,R,F){"use strict";let P=function(){function e(t,i,n,o,u,_){this._rctx=t,this._stage=n,this._prepareForShadowMapPass=o,this._renderToShadowMap=u,this._requestRender=_,this._progress=0,this._sampleCount=0,this._cachedCamera=new C,this._contentCamera=new C,this._enabled=!1,this._cachedLightDirections=[],this._depthRange=S.ZERO,this._previewing=!1,this._handles=new s,this._cameraForcedForScreenshot=!1,this._shadowMap=new D(t,n.viewingMode),this._shadowMap.enabled=!0,this._vao=M.createQuadVAO(t);const d={rctx:t,viewingMode:n.viewingMode},g=new A.ShadowCastTechniqueConfiguration;g.pass=0,this._accumulationTechnique=new A.ShadowCastTechnique(d,g);const m={colorTarget:0,depthStencilTarget:0,width:0,height:0},f={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0};this._fbo=new p(t,m,f),this._accumulationParams={camera:this._cachedCamera,linearDepthTexture:null,shadowMap:this._shadowMap,inverseView:h.create(),projInfo:l.create(),zScale:c.create()},this._accumulationRenderer=new k.ShadowCastRenderer(i,t,this,_);const w=this._stage.resourceController.scheduler;this._handles.add(w.registerTask(R.TaskPriority.SHADOW_ACCUMULATOR,this)),this._handles.add(r.reactionInit((()=>n.renderView),(t=>{this._handles.remove(e.renderViewHandleKey),a.isNone(t)||this._handles.add(t.events.on("force-camera-for-screenshot",(()=>this._cameraForcedForScreenshot=!0)),e.renderViewHandleKey)})))}var d=e.prototype;return d.runTask=function(e){for(this._prepareForShadowMapPass(this._cachedCamera,this._contentCamera);!e.done&&!this._isDoneAccumulating;)this._accumulateShadow(),e.madeProgress();this._requestRender()},d.accumulateFixedSamples=function(){if(!this.isAccumulating||!this._canAccumulate)return;(this._previewing||0===this._progress||this._cameraForcedForScreenshot)&&this._clear();const t=this._cameraForcedForScreenshot?this._sampleCount:Math.min(e.previewSamples,this._sampleCount-this._progress);for(let e=0;e<t;++e)this._accumulateShadow();this._cameraForcedForScreenshot=!1},d.render=function(){this._accumulationRenderer.render()},d.dispose=function(){this._stop(),this._handles.destroy(),this._accumulationRenderer=a.disposeMaybe(this._accumulationRenderer),this._shadowMap=a.disposeMaybe(this._shadowMap),this._fbo=a.disposeMaybe(this._fbo),this._vao=a.disposeMaybe(this._vao),this._accumulationTechnique=a.disposeMaybe(this._accumulationTechnique),this._cachedLightDirections.length=0,this._sampleCount=0},d.setOptions=function(e){void 0!==e.enabled&&this._setEnabled(e.enabled),void 0!==e.previewing&&this.setPreviewing(e.previewing),void 0!==e.lightDirections&&this.setLightDirections(e.lightDirections),this._accumulationRenderer.setOptions(e)},d.setPreviewing=function(e){this._previewing!==e&&(this._previewing=e,this._requestRenderIfEnabled())},d.setLightDirections=function(e){this._lightDirections=e},d.setAccumulationDependencies=function(e,t,i,s){this._accumulationParams.linearDepthTexture=e,this._depthRange=t,this._updateCamera(i),this._contentCamera=s},d.readAccumulatedShadow=function(e,t){if(!this._isActive||this._progress<1||e<0||e>this._fbo.width||t<0||t>this._fbo.height)return 0;const i=q;return this._fbo.readPixels(e,t,1,1,6408,5121,i),i[0]/this._progress},d._start=function(){this._progress=0,this._enabled=!0},d._stop=function(){this._enabled=!1},d._invalidate=function(){this._progress=0,this._requestRenderIfEnabled()},d._clear=function(){this._rctx.bindFramebuffer(this._fbo),this._rctx.setClearColor(0,0,0,0),this._rctx.clearSafe(16384),this._progress=0},d._accumulateShadow=function(){const e=this._lightDirections[this._progress],t=this._cachedCamera;this._renderToShadowMap(this._shadowMap,e,t,this._depthRange),this._rctx.bindFramebuffer(this._fbo),this._rctx.useProgram(this._accumulationTechnique.program),this._accumulationTechnique.bindPipelineState(this._rctx),this._accumulationTechnique.bindPass(this._accumulationParams),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(this._accumulationTechnique.primitiveType,0,F.vertexCount(this._vao,"geometry")),this._progress++},d._updateCamera=function(e){if(e.equals(this._cachedCamera))return;const{fullWidth:t,fullHeight:i,projectionMatrix:s,viewMatrix:a,center:r}=e;this._cachedCamera.copyFrom(e),this._fbo.resize(t,i),T.inverseProjectionInfo(s,t,i,this._projInfo,this._zScale),o.translate(this._inverseView,a,r),o.invert(this._inverseView,this._inverseView),this._opacityFromElevation=1-n.smoothstep(k.shadowCastDisableElevationMin,k.shadowCastDisableElevationMax,e.relativeElevation)},d._setEnabled=function(e){e!==this._enabled&&(e?this._start():this._stop())},d._requestRenderIfEnabled=function(){this._enabled&&this._requestRender()},t._createClass(e,[{key:"computedSamples",get:function(){return this._progress}},{key:"shadowCastTexture",get:function(){return this._fbo.colorTexture}},{key:"running",get:function(){return this._isRefining&&this._canAccumulate}},{key:"isAccumulating",get:function(){return this._isPreviewing||this._isRefining}},{key:"_isRefining",get:function(){return this._isActive&&!this._isDoneAccumulating&&!this._previewing}},{key:"_isPreviewing",get:function(){return this._isActive&&this._previewing}},{key:"_isActive",get:function(){return this._enabled&&this._sampleCount>0}},{key:"_canAccumulate",get:function(){return null!==this._accumulationParams.linearDepthTexture&&this._depthRange!==S.ZERO&&this._opacityFromElevation>k.shadowCastDisabledElevationThreshold}},{key:"_isDoneAccumulating",get:function(){return this._progress>=this._sampleCount}},{key:"_lightDirections",get:function(){return this._cachedLightDirections},set:function(e){const t=this._cachedLightDirections;if(i.equals(t,e,u.equals))return;const s=e.length;t.length=s,this._sampleCount=Math.min(x.shadowCastMaxSamples,s);for(let i=0;i<s;++i){const s=e[i],n=t[i]||_.create();u.copy(n,s),t[i]=n}this._invalidate()}},{key:"_projInfo",get:function(){return this._accumulationParams.projInfo}},{key:"_zScale",get:function(){return this._accumulationParams.zScale}},{key:"_inverseView",get:function(){return this._accumulationParams.inverseView}},{key:"_opacityFromElevation",get:function(){return this._accumulationRenderer.opacityFromElevation},set:function(e){this._accumulationRenderer.opacityFromElevation=e}},{key:"test",get:function(){return{lightDirections:this._lightDirections,isDone:()=>this._isDoneAccumulating,isActive:()=>this._isActive}}}]),e}();P.previewSamples=6,P.renderViewHandleKey="renderView";const q=new Uint8Array(4);e.ShadowAccumulator=P,Object.defineProperty(e,"__esModule",{value:!0})}));
