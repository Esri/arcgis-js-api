/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Handles","../../../../core/MapUtils","../../../../core/maybe","../../../../core/time","../../../../core/watchUtils","../../../../core/accessorSupport/decorators/property","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec2f64","../../support/animationUtils","../../support/debugFlags","../core/renderPasses/RenderPassManager","../core/shaderLibrary/hud/HUDUniforms","./basicInterfaces","./BoundingInfo","./depthRange","./depthRangeUtils","./glUtil3D","./HighlightHelper","./Material","./OffscreenRendering","./RenderContext","./rendererUtils","./RenderPass","./RenderPluginManager","./RenderSlot","./ShadowAccumulator","./ShadowHighlightHelper","./ShadowMap","./SliceHelper","./SmaaRenderPass","./SSAOHelper","./edgeRendering/EdgeView","./edgeRendering/interfaces","../lighting/SceneLighting","../materials/renderers/MergedRenderer","../shaders/CompositingTechnique","../shaders/ShadowHighlightTechnique","../statistics/RendererPerformanceInfo","../../../webgl/enums","../../../webgl/Measurement"],(function(e,r,t,n,s,i,a,d,o,h,l,_,c,p,u,g,f,m,R,T,S,P,A,E,C,b,x,y,M,H,D,w,I,O,L,N,v,U,F,q,G,k,B,V,W,j,Q,Y,X){"use strict";const z=.9;var K;e.Renderer=function(t){function n(e,r,n,i,a,h,l,_,c){var p;return(p=t.call(this,{})||this)._materialRepository=e,p._shaderTechniqueRepository=n,p._rctx=i,p._compositingHelper=a,p._magnifierHelper=h,p._requestRender=l,p._stage=c,p._materialRenderers=new Map,p._needsTransparentPass=!1,p._hasHUDElements=!1,p._hasHighlights=!1,p._hasOccludees=!1,p._hasWater=!1,p._hasOverlayWater=!1,p._content=new Map,p._isRendering=!1,p._fallbackDepthStencilTexture=null,p.performanceInfo=new Q.RendererPerformanceInfo,p._antialiasing=P.AntiAliasingMode.SMAA,p._oitEnabled=!1,p._multipassTerrain=!0,p._opaqueTerrain=!0,p._lighting=new B.SceneLighting,p._hasAnimations=!1,p._animationTimestep=d.Milliseconds(0),p._handles=new s,p._renderHiddenTransparentEdges=()=>{},p._oitUsed=!1,p._smaaPass=new F.SmaaRenderPass(p._rctx,n),p._oitEnabled=p._hasOITSupport,p._requestRender(),p._offscreenRendering=new M.OffscreenRendering(p._rctx,p._compositingHelper),p._sliceHelper=new U,p._shadowMap=new v(p._rctx,c.viewingMode,2),p._ssaoHelper=new q.SSAOHelper(n,p._rctx,(()=>p._requestRender())),p._highlightHelper=new x(n,p._rctx),p._shadowHighlightHelper=new N.ShadowHighlightHelper(p._rctx,c.viewingMode),p._shadowAccumulator=new L.ShadowAccumulator(p._rctx,n,c,((e,r)=>{p.renderPassManager.shadowCastingEnabled=!0,p._renderPlugins.prepareRender(e,r),p.renderPassManager.shadowCastingEnabled=p._shadowMap.enabled}),((e,r,t,n)=>{e.start(t,r,n),p._renderShadowCascades(w.RenderPass.MATERIAL_DEPTH_SHADOWMAP_ALL,e),t.setGLViewport(p._rctx),p._ensureCameraBindParameters(t)}),(()=>p._requestRender())),p._bindParameters={slot:null,camera:null,inverseViewport:f.create(),shadowMap:p._shadowMap,shadowMappingEnabled:p._shadowMap.enabled,ssaoHelper:p._ssaoHelper,ssaoEnabled:p._ssaoHelper.enabled,origin:null,screenToWorldRatio:null,screenToPCSRatio:null,slicePlane:p._sliceHelper.plane,highlightDepthTexture:null,hasOccludees:!1,linearDepthTexture:null,terrainLinearDepthTexture:null,geometryLinearDepthTexture:null,multipassTerrainEnabled:!1,multipassGeometryEnabled:!1,cullAboveGround:!1,lastFrameColorTexture:null,reprojectionMatrix:g.IDENTITY,ssrEnabled:!1,lighting:p._lighting,highlightColorTexture:null,cloudsCompositionParams:null,hasFillLights:!0},p._renderContext=new H.RenderContext(p._rctx,p._offscreenRendering,p._lighting,p._shadowMap,p._ssaoHelper,p._sliceHelper),p._renderContext.multipassTerrainParams={camera:null,multipassTerrainEnabled:!1,cullAboveGround:!1,terrainLinearDepthTexture:null},p._renderContext.multipassGeometryParams={multipassGeometryEnabled:!1,geometryLinearDepthTexture:null},p._renderContext.ssrParams={camera:null,linearDepthTexture:null,lastFrameColorTexture:null,reprojectionMatrix:g.IDENTITY,ssrEnabled:!1},p._renderPlugins=new I.RenderPluginManager({renderContext:p._renderContext,shaderTechniqueRepository:n,textureRep:r,materialRep:p._materialRepository,requestRender:p._requestRender,schedule:_}),p.renderPassManager=new T.RenderPassManager(p._rctx,p._shaderTechniqueRepository),p._renderPlugins.add(p.renderPassManager.slots(),p.renderPassManager),p._handles.add([o.init(R,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",(e=>{p._renderHiddenTransparentEdges=e?()=>p._renderEdges(k.Transparency.TRANSPARENT):()=>{},p._requestRender()})),o.init(p._stage,"camera",(()=>p._requestRender()),!0)]),p}r._inheritsLoose(n,t);var h=n.prototype;return h.normalizeCtorArgs=function(){return{}},h.dispose=function(){this._handles.destroy(),this._smaaPass.dispose(),this._materialRenderers.forEach((e=>e.dispose())),this._materialRenderers.clear(),this._edgeView=a.destroyMaybe(this._edgeView),this._offscreenRendering.dispose(),this._fallbackDepthStencilTexture=a.disposeMaybe(this._fallbackDepthStencilTexture),this._shadowMap.enabled=!1,this._shadowMap.dispose(),this._ssaoHelper.enabled=!1,this._ssaoHelper.dispose(),this._highlightHelper.dispose(),this._shadowHighlightHelper.dispose(),this._shadowAccumulator.dispose(),A.BoundingInfo.prune(),this._content.clear()},h.disposeOffscreenBuffers=function(){this._offscreenRendering.dispose(),this._shadowMap.dispose(),this._smaaPass.disable(),this._ssaoHelper.disposeOffscreenBuffers()},h.ensureEdgeView=function(){return a.isNone(this._edgeView)&&(this._edgeView=new G.EdgeView({rctx:this._rctx,renderSR:this._stage.renderSR,techniqueRepository:this._shaderTechniqueRepository,setNeedsRender:()=>this._requestRender(),schedule:e=>this._stage.resourceController.schedule(e)}),this._handles.add(this._edgeView.watch("updating",(()=>this._requestRender()),!0)),this._requestRender()),this._edgeView},h.setRenderParameters=function(e){const{renderPassManager:r,_shadowMap:t,_ssaoHelper:n}=this;void 0!==e.screenSpaceReflectionsEnabled&&r.screenSpaceReflectionsEnabled!==e.screenSpaceReflectionsEnabled&&(r.screenSpaceReflectionsEnabled=e.screenSpaceReflectionsEnabled,this._requestRender()),void 0!==e.fillLightsEnabled&&r.fillLightsEnabled!==e.fillLightsEnabled&&(r.fillLightsEnabled=e.fillLightsEnabled,this._requestRender()),void 0===e.shadowMap||t.enabled===e.shadowMap&&r.shadowCastingEnabled===e.shadowMap||(t.enabled=e.shadowMap,r.shadowCastingEnabled=e.shadowMap,this._requestRender()),void 0!==e.shadowMapMaxCascades&&t.maxCascades!==e.shadowMapMaxCascades&&(t.maxCascades=e.shadowMapMaxCascades,this._requestRender()),void 0!==e.ssao&&n.enabled!==e.ssao&&(n.enabled=e.ssao,this._requestRender()),e.background&&this._offscreenRendering.background!==e.background&&(this._offscreenRendering.background=e.background,this._requestRender());const s=e.antialiasingEnabled?P.AntiAliasingMode.SMAA:P.AntiAliasingMode.NONE;void 0!==e.antialiasingEnabled&&this._antialiasing!==s&&(this._antialiasing=s,this._requestRender()),void 0!==e.highQualityTransparency&&this._multipassTerrain!==e.highQualityTransparency&&(this._multipassTerrain=e.highQualityTransparency,this._oitEnabled=e.highQualityTransparency&&this._hasOITSupport,this._requestRender()),void 0!==e.defaultHighlightOptions&&(this._highlightHelper.setDefaultOptions(e.defaultHighlightOptions),this._shadowHighlightHelper.setDefaultOptions(e.defaultHighlightOptions),this._requestRender()),void 0!==e.slicePlane&&this._sliceHelper.plane!==e.slicePlane&&(this._sliceHelper.plane=a.unwrap(e.slicePlane),this._requestRender()),void 0!==e.waterReflectionEnabled&&this._waterReflectionEnabled!==e.waterReflectionEnabled&&(this._waterReflectionEnabled=e.waterReflectionEnabled,this._requestRender()),void 0!==e.fillLightsEnabled&&this._hasFillLights!==e.fillLightsEnabled&&(this._hasFillLights=e.fillLightsEnabled,this._requestRender()),void 0!==e.opaqueTerrain&&this._opaqueTerrain!==e.opaqueTerrain&&(this._opaqueTerrain=e.opaqueTerrain,this._requestRender()),void 0!==e.hasOverlayWater&&this._hasOverlayWater!==e.hasOverlayWater&&(this._hasOverlayWater=e.hasOverlayWater,this._requestRender()),void 0!==e.shadowCastOptions&&this._shadowAccumulator.setOptions(e.shadowCastOptions)},h.modify=function(e){this._isRendering&&console.warn("Renderer.modify called while rendering");const{adds:r,removes:t,updates:n}=e;if(0===r.length&&0===t.length&&0===n.length)return;t.forAll((({id:e})=>this._content.delete(e))),r.forAll((e=>this._content.set(e.id,e)));const s=D.splitRenderGeometryChangeSetByMaterial(e);let a=!1;s.forEach(((e,r)=>{let t=this._materialRenderers.get(r);if(!t){if(!(e.adds.length>0))return;t=new V.MergedRenderer(this._rctx,this._materialRepository,r),this._materialRenderers.set(r,t)}t.modify(e),t.isEmpty&&(a=!0)})),a&&this._materialRenderers.forEach(((e,r)=>{e.isEmpty&&(this._materialRenderers.delete(r),e.dispose())})),this._hasHighlights=i.someMap(this._materialRenderers,(e=>e.hasHighlights)),this._hasOccludees=i.someMap(this._materialRenderers,(e=>e.hasOccludees)),this._hasWater=i.someMap(this._materialRenderers,(e=>e.hasWater)),this._needsTransparentPass=i.someMap(this._materialRenderers,(e=>e.requiresSlot(O.RenderSlot.TRANSPARENT_MATERIAL,w.RenderPass.MATERIAL))),this._hasHUDElements=i.someMap(this._materialRenderers,(e=>e.requiresSlot(O.RenderSlot.LINE_CALLOUTS_HUD_DEPTH,w.RenderPass.MATERIAL)||e.requiresSlot(O.RenderSlot.HUD_MATERIAL,w.RenderPass.MATERIAL)||e.requiresSlot(O.RenderSlot.LABEL_MATERIAL,w.RenderPass.MATERIAL))),this._requestRender()},h.updateAnimation=function(e){return this._hasAnimations=!1,this._materialRenderers.forEach((r=>this._hasAnimations=r.updateAnimation(e)||this._hasAnimations)),this._hasAnimations=this._renderPlugins.updateAnimation(e)||this._hasAnimations,this._hasAnimations},h.updateLightSources=function(e,r,t){this._lighting.groundLightingFactor=r,this._lighting.globalFactor=t,this._lighting.set(e)},h.render=function(e,r,t,n){this._isRendering=!0,this.performanceInfo.prerender(this._rctx),this._bindParameters.lighting=this._lighting,this._renderContext.hasOccludees=this._hasOccludees,this._renderContext.transparencyPassType=this._bindParameters.transparencyPassType=P.TransparencyPassType.NONE,this._renderContext.hasFillLights=this._bindParameters.hasFillLights=this._hasFillLights;const s=this._offscreenRendering;s.needLastFrameColorTexture=this.hasWaterReflection,s.advanceCurrentRenderTarget();const i=this._sliceHelper.plane;n===P.Decorations.OFF&&(this._sliceHelper.plane=null),this._rctx.bindFramebuffer(e),r.setGLViewport(this._rctx),this.needsShadowCast&&(this.renderPassManager.shadowCastingEnabled=!0),this._renderPlugins.prepareRender(r,t),this.performanceInfo.advance(Q.Statistics.Prepare);const d=this._computeDepthRange(r);this._renderShadowMap(e,r,this._lighting.lightingMainDirection,d),this.performanceInfo.advance(Q.Statistics.Shadowmap),s.initializeFrame(r),this._ensureBindParameters(r),this._renderLinearDepth(),this.performanceInfo.advance(Q.Statistics.Lineardepth),this._accumulateShadows(d,r,t),this._renderNormal(),this.performanceInfo.advance(Q.Statistics.Normals),this._ensureBindParametersSSR(),this._ensureBindParametersCloudsReflections(),this._ssaoHelper.computeSSAO(r,s.linearDepthTexture,s.normalTexture),this.performanceInfo.advance(Q.Statistics.SSAO),this._renderContext.pass=w.RenderPass.MATERIAL,s.bindFramebuffer(),this._renderOpaqueGeometry(),this.performanceInfo.advance(Q.Statistics.Opaque);const o=this._multipassTerrain&&!this._opaqueTerrain;this._renderTerrainLinearDepth(o),this._setMultipassFlags(o),this._setTerrainCulling(o),this._renderEdges(k.Transparency.OPAQUE),this.performanceInfo.advance(Q.Statistics.OpaqueEdges),this._renderHiddenTransparentEdges();const h=this._needsTransparentPass||this._renderPlugins.needsTransparentPass;h&&(this._oitEnabled?this._renderOrderIndependentTransparency((()=>this._renderTransparentGeometry()),!1):this._renderTransparentGeometry()),this.performanceInfo.advance(Q.Statistics.Transparent),this._renderGeometryLinearDepth(o);const l=this._renderHUDVisibility();o||this._renderInternalSlot(O.RenderSlot.LINE_CALLOUTS),this.performanceInfo.advance(Q.Statistics.Hudvisibility),this._renderEdges(k.Transparency.TRANSPARENT,o),this.performanceInfo.advance(Q.Statistics.TransparentEdges),this._renderSlot(O.RenderSlot.VOXEL),this._renderTransparentTerrain(),!this._opaqueTerrain&&l&&(o?this._renderLineCallouts(S.HUDTransparentRenderStyle.OCCLUDED):s.compositeTransparentTerrainOntoHUDVisibility(),this._renderHUD(S.HUDTransparentRenderStyle.OCCLUDED,s.framebuffer),this.performanceInfo.advance(Q.Statistics.HudOccluded)),this.performanceInfo.advance(Q.Statistics.TransparentTerrain),this._setTerrainCulling(!1),this._opaqueTerrain||(s.compositeTransparentTerrainOntoMain(),o&&(this._renderEdges(k.Transparency.OPAQUE),this.performanceInfo.advance(Q.Statistics.OpaqueEdges),h&&(this._oitEnabled?this._renderOrderIndependentTransparency((()=>this._renderTransparentGeometry()),!1):this._renderTransparentGeometry()),this.performanceInfo.advance(Q.Statistics.Transparent),this._renderEdges(k.Transparency.TRANSPARENT),this.performanceInfo.advance(Q.Statistics.TransparentEdges))),o&&this._renderLineCallouts(S.HUDTransparentRenderStyle.NOTOCCLUDED),this._setMultipassFlags(!1),this._shadowAccumulator.render(),s.renderToTargets((()=>{this._renderInternalSlot(O.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),this._renderSlot(O.RenderSlot.POSTPROCESSING_ENVIRONMENT_TRANSPARENT),this._renderSlot(O.RenderSlot.LASERLINES)}),s.currentColorTarget,s.mainDepth),this.performanceInfo.advance(Q.Statistics.Atmosphere),this._renderPlugins.needsLaserlineWithContrastControl&&s.renderTmpAndCompositeToMain((()=>this._renderSlot(O.RenderSlot.LASERLINES_CONTRAST_CONTROL)),W.AlphaMode.PremultipliedAlpha),this.performanceInfo.advance(Q.Statistics.Laserline),this._renderOccluded(),this.performanceInfo.advance(Q.Statistics.Occluded);const _=n===P.Decorations.ON&&this._magnifierHelper.enabled,c=_&&a.isNone(e)?this._offscreenRendering.getFramebuffer(this._offscreenRendering.tmpColor,this._offscreenRendering.tmpDepth):e;this._rctx.bindFramebuffer(c);const p=this._offscreenRendering.colorTexture;!this._renderAntiAliasing(this._antialiasing,p)&&a.isSome(p)&&this._compositingHelper.composite(p,W.AlphaMode.None),this.performanceInfo.advance(Q.Statistics.Antialiasing),this._renderHUD(S.HUDTransparentRenderStyle.NOTOCCLUDED,c),this.performanceInfo.advance(Q.Statistics.HudNotoccluded),this._renderHighlights(c,this._bindParameters),this.performanceInfo.advance(Q.Statistics.Highlights),_&&this._magnifierHelper.render(this._rctx,this._bindParameters),c!==e&&(this._rctx.bindFramebuffer(e),this._compositingHelper.composite(this._offscreenRendering.tmpColorTexture,W.AlphaMode.None)),this._disposeOITBuffers(),this._renderContext.lastFrameCamera.copyFrom(this._renderContext.camera),this._sliceHelper.plane=i,this._isRendering=!1,this.onPostRender&&this.onPostRender(),this.performanceInfo.postrender()},h.finish=function(e){if(this._hasAnimations||(this._animationTimestep=d.Milliseconds(0)),e===P.RenderRequestType.BACKGROUND){this._rctx.gl.getError();const e=this.performanceInfo.elapsedTime/m.MAXIMUM_ANIMATION_LOAD;this._animationTimestep=d.Milliseconds(Math.max(this._animationTimestep*z+e*(1-z),m.MINIMUM_IDLE_ANIMATION_MS))}},h.readDepthPixels=function(e,r,t,n,s,i){const a=this._offscreenRendering.bindTarget(this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth);if(!this._needsLinearDepth){this._ensureBindParameters(e),this._renderContext.camera.setGLViewport(this._rctx),this._rctx.setClearColor(0,0,0,0);const r=Y.ClearBufferBit.COLOR_BUFFER_BIT|Y.ClearBufferBit.DEPTH_BUFFER_BIT|Y.ClearBufferBit.STENCIL_BUFFER_BIT;this._rctx.clearSafe(r),this._renderGeometryAndTransparentTerrainPass(w.RenderPass.MATERIAL_DEPTH)}a.readPixels(r,t,n,s,Y.PixelFormat.RGBA,Y.PixelType.UNSIGNED_BYTE,i)},h.readAccumulatedShadow=function(e,r){return this._shadowAccumulator.readAccumulatedShadow(e,r)},h._setMultipassFlags=function(e){this._renderContext.multipassTerrainParams.multipassTerrainEnabled=this._bindParameters.multipassTerrainEnabled=e,this._renderContext.multipassGeometryParams.multipassGeometryEnabled=this._bindParameters.multipassGeometryEnabled=e},h._setTerrainCulling=function(e){this._renderContext.multipassTerrainParams.cullAboveGround=this._bindParameters.cullAboveGround=e},h._renderSlot=function(e){this._renderContext.slot=e,this._renderPlugins.render()},h._renderEdges=function(e,r=!1){const t=this._edgeView;a.isSome(t)&&t.shouldRender()&&this._offscreenRendering.renderTmpAndCompositeToMain((()=>t.render(this._bindParameters,e)),W.AlphaMode.Alpha,r)},h._renderShadowMap=function(e,r,t,n){const s=this._shadowMap;s.enabled&&(s.start(r,t,n),this._shadowHighlightHelper.updateParameters(r,t),this.needsShadowHighlight?(this._renderShadowCascades(w.RenderPass.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT,this._shadowMap,(e=>s.takeCascadeSnapshotTo(e,j.HighlightShadowMapSlot))),s.clear(),this._renderShadowCascades(w.RenderPass.MATERIAL_DEPTH_SHADOWMAP_DEFAULT,this._shadowMap,(e=>{s.takeCascadeSnapshotTo(e,j.DefaultSnapshotSlot),this._renderGeometryAndTransparentTerrainPass(w.RenderPass.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT)}))):this._renderShadowCascades(w.RenderPass.MATERIAL_DEPTH_SHADOWMAP_ALL),s.finish(e),r.setGLViewport(this._rctx))},h._renderShadowCascades=function(e,r=this._shadowMap,t=(e=>{})){for(const n of r.getCascades())n.camera.setGLViewport(this._rctx),this._ensureCameraBindParameters(n.camera),this._renderGeometryAndTransparentTerrainPass(e),t(n)},h._renderLinearDepth=function(){this._needsLinearDepth?this._offscreenRendering.renderToTargets((()=>this._renderGeometryAndTransparentTerrainPass(w.RenderPass.MATERIAL_DEPTH)),this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.linearDepth),this._renderContext.ssrParams.linearDepthTexture=this._bindParameters.linearDepthTexture=this._offscreenRendering.linearDepthTexture},h._renderTerrainLinearDepth=function(e){if(e){const e=this._renderContext.pass;this._renderContext.pass=w.RenderPass.MATERIAL_DEPTH,this._offscreenRendering.renderToTargets((()=>this._renderTransparentTerrain()),this._offscreenRendering.terrainLinearDepth,this._offscreenRendering.tmpDepth,[-1e10,-1e10,-1e10,1],!0,!0),this._renderContext.pass=e}else this._offscreenRendering.disposeTarget(this._offscreenRendering.terrainLinearDepth);this._renderContext.multipassTerrainParams.terrainLinearDepthTexture=this._bindParameters.terrainLinearDepthTexture=this._offscreenRendering.terrainLinearDepthTexture},h._renderGeometryLinearDepth=function(e){if(e){const e=this._renderContext.pass;this._offscreenRendering.renderToTargets((()=>this._renderGeometryPass(w.RenderPass.MATERIAL_DEPTH)),this._offscreenRendering.geometryLinearDepth,this._offscreenRendering.tmpDepth,[1,1,1,1],!0,!0),this._renderContext.pass=e}else this._offscreenRendering.disposeTarget(this._offscreenRendering.geometryLinearDepth);this._renderContext.multipassGeometryParams.geometryLinearDepthTexture=this._bindParameters.geometryLinearDepthTexture=this._offscreenRendering.geometryLinearDepthTexture},h._renderNormal=function(){this.needsNormal?this._offscreenRendering.renderToTargets((()=>{this._renderGeometryAndTransparentTerrainPass(w.RenderPass.MATERIAL_NORMAL)}),this._offscreenRendering.normal,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.normal)},h._computeDepthRange=function(e){if(!this.needsDepthRange)return E.ZERO;const r=C.depthRangeFromScene(e,this._content,this._stage.layers);return E.union(r,this.renderPlugins.queryDepthRange(e)),r.near=Math.max(e.near,r.near),r.far=Math.min(e.far,r.far),r},h._renderGeometryAndTransparentTerrainPass=function(e){this._renderContext.pass=e,this._renderGeometryPass(e),this._renderTransparentTerrain()},h._renderGeometryPass=function(e){this._renderContext.pass=e,this._renderOpaqueGeometry(),this._renderTransparentGeometry()},h._renderOpaqueGeometry=function(){this._renderSlot(O.RenderSlot.INTEGRATED_MESH),this._renderSlot(O.RenderSlot.OPAQUE_TERRAIN),this._renderInternalSlot(O.RenderSlot.OPAQUE_MATERIAL),this._renderSlot(O.RenderSlot.OPAQUE_PLUGIN),this._renderSlot(O.RenderSlot.POSTPROCESSING_ENVIRONMENT_OPAQUE)},h._renderTransparentGeometry=function(){this._renderInternalSlot(O.RenderSlot.TRANSPARENT_MATERIAL),this._renderSlot(O.RenderSlot.TRANSPARENT_PLUGIN)},h._renderTransparentTerrain=function(){this._renderSlot(O.RenderSlot.TRANSPARENT_TERRAIN)},h._renderHUDVisibility=function(){let e=!1;return this._renderContext.offscreenRenderingHelper&&this._renderContext.offscreenRenderingHelper.renderHUDVisibility((()=>{this._bindParameters.hudVisibilityTexture=this._renderContext.offscreenRenderingHelper.hudVisibilityTexture,e=this._renderInternalSlot(O.RenderSlot.OCCLUSION_PIXELS)}),this._multipassTerrain&&!this._opaqueTerrain),e},h._renderLineCallouts=function(e){this._bindParameters.renderTransparentlyOccludedHUD=e,e===S.HUDTransparentRenderStyle.OCCLUDED?this._offscreenRendering.renderToTargets((()=>this._renderInternalSlot(O.RenderSlot.LINE_CALLOUTS)),this._offscreenRendering.currentColorTarget,this._offscreenRendering.tmpDepth,void 0,!0,!0):this._renderInternalSlot(O.RenderSlot.LINE_CALLOUTS)},h._renderHUD=function(e,r){this._hasHUDElements&&(this._oitEnabled?(this._renderOrderIndependentTransparency((()=>this._renderHUDElements(e)),!0),this._rctx.bindFramebuffer(r),this._compositingHelper.composite(this._offscreenRendering.hudColorTexture,W.AlphaMode.PremultipliedAlpha)):e===S.HUDTransparentRenderStyle.OCCLUDED?this._offscreenRendering.renderToTargets((()=>this._renderHUDElements(S.HUDTransparentRenderStyle.OCCLUDED)),this._offscreenRendering.currentColorTarget,this._offscreenRendering.tmpDepth,void 0,!0,!0):this._renderHUDElements(e))},h._renderHUDElements=function(e){this._bindParameters.renderTransparentlyOccludedHUD=e,this._renderInternalSlot(O.RenderSlot.LINE_CALLOUTS_HUD_DEPTH),this._renderInternalSlot(O.RenderSlot.HUD_MATERIAL),this._renderInternalSlot(O.RenderSlot.LABEL_MATERIAL)},h._renderHighlights=function(e,r){if(!this.needsHighlight)return void this._offscreenRendering.disposeTarget(this._offscreenRendering.highlight);const t=this._highlightHelper,n=t.profilingCallback&&X.startMeasurement(this._renderContext.rctx);this._renderContext.highlightDepthTexture=r.highlightDepthTexture;const s=this._offscreenRendering.renderToTargets((()=>{this._renderGeometryAndTransparentTerrainPass(w.RenderPass.MATERIAL_HIGHLIGHT),this._rctx.clearSafe(Y.ClearBufferBit.DEPTH_BUFFER_BIT),this._renderHUDElements(S.HUDTransparentRenderStyle.BOTH)}),this._offscreenRendering.highlight,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0);this._bindParameters.highlightColorTexture=s.colorTexture,this.needsShadowHighlight&&this._shadowHighlightHelper.render(r,e),t.render(this._renderContext.camera,s,e),a.isSome(n)&&t.profilingCallback&&n.stop((e=>{t.profilingCallback&&t.profilingCallback(e)}))},h._accumulateShadows=function(e,r,t){this.needsShadowCast&&(this._shadowAccumulator.setAccumulationDependencies(this._offscreenRendering.linearDepthTexture,e,r,t),this._shadowAccumulator.accumulateFixedSamples(),this.renderPassManager.shadowCastingEnabled=this._shadowMap.enabled)},h._renderOrderIndependentTransparency=function(e,r){const t=t=>{this._renderContext.transparencyPassType=t,this._bindParameters.transparencyPassType=this._renderContext.transparencyPassType,this._offscreenRendering.renderOITPass((()=>e()),t,r)},n=this._renderContext.pass;this._renderContext.pass=w.RenderPass.MATERIAL_ALPHA,t(P.TransparencyPassType.Alpha),this._renderContext.pass=w.RenderPass.MATERIAL,t(P.TransparencyPassType.Color),t(P.TransparencyPassType.FrontFace),this._offscreenRendering.compositeTransparentOntoOpaque(r),this._renderContext.transparencyPassType=P.TransparencyPassType.NONE,this._bindParameters.transparencyPassType=this._renderContext.transparencyPassType,this._renderContext.pass=n,this._oitUsed=!0},h._disposeOITBuffers=function(){this._oitUsed||(this._offscreenRendering.disposeTarget(this._offscreenRendering.alphaFloatTarget),this._offscreenRendering.disposeTarget(this._offscreenRendering.colorFloatTarget),this._offscreenRendering.disposeTarget(this._offscreenRendering.frontFaceTarget)),this._oitUsed=!1},h._renderOccluded=function(){let e=0;this._materialRenderers.forEach(((r,t)=>{t&&t.isVisible()&&t.renderOccluded===y.RenderOccludedFlag.OccludeAndTransparentStencil&&(e|=t.renderOccluded,J.push(t))}));const r=this._offscreenRendering,t=(t,n,s,i,a)=>{0!=(e&n)&&(r.renderToTargets(s,r.tmpColor,r.mainDepth,[0,0,0,0],i,a),r.compositeOccludedOntoMain(t))};0!==J.length&&(this._renderInternalSlot(O.RenderSlot.OCCLUDER_MATERIAL,J),t(.5,y.RenderOccludedFlag.OccludeAndTransparentStencil,(()=>this._renderInternalSlot(O.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL,J)),!1,!1),J.length=0),this._materialRenderers.forEach(((r,t)=>{t&&t.isVisible()&&(t.renderOccluded===y.RenderOccludedFlag.OccludeAndTransparent||t.renderOccluded===y.RenderOccludedFlag.Transparent||t.renderOccluded===y.RenderOccludedFlag.Opaque)&&(e|=t.renderOccluded,Z.push(t))}));const n=this._renderPlugins.renderOccludedFlags;if(e|=n,!e)return;const s=e=>{this._renderContext.renderOccludedMask=e,n>y.RenderOccludedFlag.Occlude&&this._renderSlot(O.RenderSlot.OCCLUDED_TERRAIN),this._renderInternalSlot(O.RenderSlot.OPAQUE_MATERIAL,Z),this._renderInternalSlot(O.RenderSlot.TRANSPARENT_MATERIAL,Z),this._renderInternalSlot(O.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,Z),this._renderContext.resetRenderOccludedMask()};this._renderContext.pass=w.RenderPass.MATERIAL,t(.5,y.RenderOccludedFlag.OccludeAndTransparent,(()=>s(y.RenderOccludedFlag.OccludeAndTransparent)),!0,P.StencilBits.OutlineVisualElementMask),t(.5,y.RenderOccludedFlag.Transparent,(()=>s(y.RenderOccludedFlag.Transparent)),!0,P.StencilBits.OutlineVisualElementMask),t(1,y.RenderOccludedFlag.Opaque,(()=>s(y.RenderOccludedFlag.Opaque)),!0,P.StencilBits.OutlineVisualElementMask),Z.length=0},h._renderAntiAliasing=function(e,r){if(e===P.AntiAliasingMode.SMAA){if(this._smaaPass.enable((()=>this._requestRender()))&&a.isSome(r))return this._smaaPass.render(r),!0}else this._smaaPass.disable();return!1},h._ensureCameraBindParameters=function(e){this._renderContext.camera=e,this._bindParameters.camera=this._renderContext.camera,this._bindParameters.inverseViewport[0]=1/this._renderContext.camera.fullViewport[2],this._bindParameters.inverseViewport[1]=1/this._renderContext.camera.fullViewport[3]},h._ensureBindParameters=function(e){var r;this._ensureCameraBindParameters(e);const t=this._renderContext.offscreenRenderingHelper;this._bindParameters.shadowMap=this._renderContext.shadowMap,this._bindParameters.shadowMappingEnabled=this._renderContext.shadowMap.enabled,this._bindParameters.ssaoHelper=this._renderContext.ssaoHelper,this._bindParameters.ssaoEnabled=this._renderContext.ssaoHelper.enabled,this._bindParameters.slicePlane=this._renderContext.sliceHelper.plane,this._bindParameters.hasOccludees=this._renderContext.hasOccludees,this._renderContext.multipassTerrainParams.camera=this._renderContext.camera,this._bindParameters.hudVisibilityTexture=t.hudVisibilityTexture,this._bindParameters.highlightDepthTexture=null!=(r=t.depthTexture)?r:this._getFallbackDepthTexture()},h._ensureBindParametersSSR=function(){this.hasWaterReflection?(this._renderContext.lastFrameCamera.equals(this._renderContext.camera)?this._renderContext.ssrParams.reprojectionMatrix=this._reprojectionMatrix=g.IDENTITY:(u.translate($,this._renderContext.lastFrameCamera.viewMatrix,this._bindParameters.origin?this._bindParameters.origin:[0,0,0]),u.translate(re,this._renderContext.camera.viewMatrix,this._bindParameters.origin?this._bindParameters.origin:[0,0,0]),u.invert(re,re),u.invert(ee,this._renderContext.camera.projectionMatrix),u.multiply(te,re,ee),u.multiply(te,$,te),u.multiply(te,this._renderContext.lastFrameCamera.projectionMatrix,te),this._renderContext.ssrParams.reprojectionMatrix=this._reprojectionMatrix=te),this._renderContext.ssrParams.camera=this._renderContext.camera,this._renderContext.ssrParams.lastFrameColorTexture=this._bindParameters.lastFrameColorTexture=this._offscreenRendering.lastFrameColorTexture):this._renderContext.ssrParams.lastFrameColorTexture=this._bindParameters.lastFrameColorTexture=null,this._renderContext.ssrParams.ssrEnabled=this._bindParameters.ssrEnabled=this.hasWaterReflection},h._ensureBindParametersCloudsReflections=function(){this._bindParameters.cloudsCompositionParams=this._renderContext.cloudsCompositionParams},h._renderInternalSlot=function(e,r){let t=!1;return this._bindParameters.slot=e,a.isSome(r)?r.forEach((r=>{if(!r.shouldRender(this._renderContext))return;const n=this._materialRenderers.get(r);a.isSome(n)&&(t=n.render(e,this._renderContext.pass,this._bindParameters)||t)})):this._materialRenderers.forEach(((r,n)=>{n.shouldRender(this._renderContext)&&(t=r.render(e,this._renderContext.pass,this._bindParameters)||t)})),t},h._getFallbackDepthTexture=function(){return this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=b.createEmptyDepthTexture(this._rctx)),this._fallbackDepthStencilTexture},r._createClass(n,[{key:"hasWater",get:function(){return this._hasWater||this._hasOverlayWater}},{key:"hasWaterReflection",get:function(){return this.hasWater&&this._waterReflectionEnabled}},{key:"updating",get:function(){return this._antialiasing===P.AntiAliasingMode.SMAA&&this._smaaPass.updating||a.isSome(this._edgeView)&&this._edgeView.updating||this._shadowAccumulator.running||!this.isCameraFinal}},{key:"edgeView",get:function(){return this._edgeView}},{key:"isCameraFinal",get:function(){return null===this._bindParameters.reprojectionMatrix||u.equals(this._bindParameters.reprojectionMatrix,g.IDENTITY)}},{key:"_reprojectionMatrix",set:function(e){u.equals(this._bindParameters.reprojectionMatrix,e)||(this._bindParameters.reprojectionMatrix=e,this.notifyChange("isCameraFinal"))}},{key:"hasShadowsEnabled",get:function(){var e;return!(null==(e=this._shadowMap)||!e.enabled)}},{key:"hasSlicePlane",get:function(){return!!this._sliceHelper.plane}},{key:"renderPlugins",get:function(){return this._renderPlugins}},{key:"_hasOITSupport",get:function(){return this._rctx.driverTest.floatBufferBlendWorking}},{key:"animationTimestep",get:function(){return this._animationTimestep}},{key:"_needsLinearDepth",get:function(){return this._ssaoHelper.enabled||this._renderPlugins.needsLinearDepth||this._hasWater&&this._waterReflectionEnabled||this.needsShadowHighlight||this.needsShadowCast}},{key:"needsNormal",get:function(){return this._ssaoHelper.enabled}},{key:"needsDepthRange",get:function(){return this._shadowMap.enabled||this.needsShadowCast}},{key:"needsHighlight",get:function(){return this._hasHighlights||this._renderPlugins.needsHighlight}},{key:"needsShadowHighlight",get:function(){return this._shadowMap.enabled&&this._shadowHighlightHelper.isVisible&&this.needsHighlight}},{key:"needsShadowCast",get:function(){return this._shadowAccumulator.isAccumulating}},{key:"gpuMemoryUsage",get:function(){var e,r,t,n,s,i,a,d,o,h;return{offscreen:null!=(e=null==(r=this._offscreenRendering)?void 0:r.gpuMemoryUsage)?e:0,highlights:(null!=(t=null==(n=this._highlightHelper)?void 0:n.gpuMemoryUsage)?t:0)+(null!=(s=null==(i=this._shadowHighlightHelper)?void 0:i.gpuMemoryUsage)?s:0),shadows:null!=(a=null==(d=this._shadowMap)?void 0:d.gpuMemoryUsage)?a:0,ssao:null!=(o=null==(h=this._ssaoHelper)?void 0:h.gpuMemoryUsage)?o:0}}},{key:"test",get:function(){const r=this;return{offscreen:this._offscreenRendering,shadowMap:this._shadowMap,ssao:this._ssaoHelper,highlight:this._highlightHelper,lighting:this._lighting,materialRenderers:this._materialRenderers,shadowAccumulator:this._shadowAccumulator,getFramebufferTexture:t=>{var n;switch(t){case e.FramebufferId.Color:return r._offscreenRendering.colorTexture;case e.FramebufferId.LinearDepth:return r._offscreenRendering.linearDepthTexture;case e.FramebufferId.Normals:return r._offscreenRendering.normalTexture;case e.FramebufferId.ShadowMap:return null==(n=r._shadowMap)?void 0:n.test.depthTexture;case e.FramebufferId.HudVisibility:return r._offscreenRendering.hudVisibilityTexture;case e.FramebufferId.Highlight:return r._offscreenRendering.highlightTexture}}}}}]),n}(n),t.__decorate([h.property()],e.Renderer.prototype,"_shadowAccumulator",void 0),t.__decorate([h.property()],e.Renderer.prototype,"_smaaPass",void 0),t.__decorate([h.property()],e.Renderer.prototype,"_antialiasing",void 0),t.__decorate([h.property()],e.Renderer.prototype,"_edgeView",void 0),t.__decorate([h.property()],e.Renderer.prototype,"updating",null),t.__decorate([h.property()],e.Renderer.prototype,"isCameraFinal",null),e.Renderer=t.__decorate([p.subclass("esri.views.3d.webgl-engine.lib.Renderer")],e.Renderer),e.FramebufferId=void 0,(K=e.FramebufferId||(e.FramebufferId={}))[K.Color=0]="Color",K[K.LinearDepth=1]="LinearDepth",K[K.Normals=2]="Normals",K[K.ShadowMap=3]="ShadowMap",K[K.HudVisibility=4]="HudVisibility",K[K.Highlight=5]="Highlight";const Z=[],J=[],$=g.create(),ee=g.create(),re=g.create(),te=g.create();Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
