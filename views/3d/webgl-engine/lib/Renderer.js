// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","../../../../core/compilerUtils","../../../../core/Handles","../../../../core/has","../../../../core/MapUtils","../../../../core/maybe","../../../../core/TimeProfiler","../../../../core/watchUtils","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec2f64","../../../../core/libs/gl-matrix-2/vec3f64","../../support/debugFlags","../core/renderPasses/RenderPassManager","../core/shaderLibrary/hud/HUD.glsl","./BoundingInfo","./Camera","./depthRange","./depthRangeUtils","./FxaaRenderPass","./glUtil3D","./HighlightHelper","./Material","./OffscreenRendering","./RenderContext","./rendererUtils","./RenderPluginManager","./renderStats","./ShadowMap","./SliceHelper","./SmaaRenderPass","./SSAOHelper","./edgeRendering/EdgeView","../lighting/SceneLighting","../materials/renderers/MergedRenderer","../../../webgl/Profiling"],(function(e,r,t,n,s,i,a,o,d,h,l,c,u,p,_,g,f,m,b,R,x,T,P,y,w,C,H,M,v,D,E,O,S,F,I,V,U){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var q=function(){function e(e,r,t,i,a,o,h,l){var g=this;this._materialRep=e,this._rctx=i,this._compositingHelper=a,this.requestRender=o,this._stage=l,this._materialRenderers=new Map,this._hasHighlights=!1,this._hasOccludees=!1,this._hasWater=!1,this._camera=new m.default(u.vec3f64.fromValues(0,100,-100)),this._lighting=new I.SceneLighting,this._content=new Map,this._isRendering=!1,this._fallbackDepthStencilTexture=null,this._stats=new v.RenderStatsAggregator,this._antialiasing=1,this._edgeView=null,this._handles=new n,this._OITEnabled=!1,this.renderHiddenTransparentEdges=function(){},this._shaderTechniqueRepository=t,this._fxaaPass=new x(this._rctx),this._smaaPass=new O(this._rctx),this.camera.viewport[2]=h[0],this.camera.viewport[3]=h[1],this.requestRender(),this._bindParameters={slot:null,camera:null,inverseViewport:c.vec2f64.create(),shadowMappingEnabled:!1,ssaoEnabled:!1,origin:null,screenToWorldRatio:null,screenToWorldRatioGlobalWM:null,slicePlane:null,highlightDepthTexture:null,hasOccludees:!1,linearDepthTexture:null,linearDepthTextureID:0,lastFrameColorTexture:null,lastFrameColorTextureID:0,reprojectionMat:null,ssrEnabled:!1,lighting:this._lighting},this._offscreenRendering=new w.OffscreenRendering(this._rctx,this._compositingHelper),this._sliceHelper=new E,this._shadowMap=new D(this._rctx,t.viewingMode),this._ssaoHelper=new S(t,this._rctx,(function(){return g.requestRender()})),this._highlightHelper=new P(t,this._rctx),this._renderPlugins=new M.RenderPluginManager({rctx:this._rctx,shaderTechniqueRep:t,textureRep:r,materialRep:this._materialRep,requestRender:this.requestRender}),this.renderPassManager=new _.RenderPassManager(this._rctx,this._shaderTechniqueRepository),this._renderPlugins.add(this.renderPassManager.slots(),this.renderPassManager),this._renderContext=new C(this._rctx,this._offscreenRendering,this._lighting,this._shadowMap,this._ssaoHelper,this._sliceHelper),this._renderContext.ssrParams={camera:null,linearDepthTexture:null,linearDepthTextureID:0,lastFrameColorTexture:null,lastFrameColorTextureID:0,reprojectionMat:null,ssrEnabled:!1},s("enable-feature:alo10771/OIT")&&(this._OITEnabled=!0),this._handles.add(d.init(p,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",(function(e){g.renderHiddenTransparentEdges=e?function(){return g.renderEdges(1)}:function(){},g.requestRender()})))}return e.prototype.dispose=function(){this._handles.destroy(),this._fxaaPass.disable(),this._smaaPass.disable(),this._materialRenderers.forEach((function(e){return e.dispose()})),this._materialRenderers=null,this._edgeView=a.destroyMaybe(this._edgeView),this._offscreenRendering=a.disposeMaybe(this._offscreenRendering),this._fallbackDepthStencilTexture=a.disposeMaybe(this._fallbackDepthStencilTexture),this._shadowMap&&(this._shadowMap.enabled=!1,this._shadowMap.dispose()),this._ssaoHelper&&(this._ssaoHelper.enabled=!1,this._ssaoHelper.dispose()),this._highlightHelper&&(this._highlightHelper.enabled=!1),f.tmpIndices.prune(),this._content.clear(),this._content=null},Object.defineProperty(e.prototype,"updating",{get:function(){return 1===this._antialiasing&&this._smaaPass.isLoadingResources},enumerable:!1,configurable:!0}),e.prototype.ensureEdgeView=function(){var e=this;return null==this._edgeView&&(this._edgeView=new F.EdgeView(this._rctx,this._shaderTechniqueRepository,{setNeedsRender:function(){return e.requestRender()}})),this._edgeView},Object.defineProperty(e.prototype,"camera",{get:function(){return this._camera},set:function(e){this._camera.copyFrom(e),this.requestRender()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"edgeView",{get:function(){return this._edgeView},enumerable:!1,configurable:!0}),e.prototype.setLighting=function(e){this._lighting.set(e)},e.prototype.setRenderParams=function(e){void 0!==e.ssrEnable&&(this.renderPassManager.screenSpaceReflectionsEnabled=e.ssrEnable),void 0!==e.shadowMap&&(this._shadowMap.enabled=e.shadowMap,this.renderPassManager.shadowCastingEnabled=e.shadowMap),void 0!==e.shadowMapMaxCascades&&(this._shadowMap.maxCascades=e.shadowMapMaxCascades),this._highlightHelper.enabled=!0,void 0!==e.ssao&&(this._ssaoHelper.enabled=e.ssao),void 0!==e.ssaoAttenuation&&(this._ssaoHelper.attenuation=e.ssaoAttenuation),void 0!==e.ssaoRadius&&(this._ssaoHelper.radius=e.ssaoRadius),void 0!==e.ssaoFilterRadius&&console.error("The property ssaoFilterRadius is no longer supported as a render parameter."),void 0!==e.ssaoSamples&&(this._ssaoHelper.samples=e.ssaoSamples),e.background&&(this._offscreenRendering.background=e.background),void 0!==e.antialiasingEnabled&&(this._antialiasing=e.antialiasingEnabled?1:0),void 0!==e.defaultHighlightOptions&&this._highlightHelper.setDefaultOptions(e.defaultHighlightOptions),void 0!==e.slicePlane&&(this._sliceHelper.plane=a.unwrap(e.slicePlane)),void 0!==e.waterReflectionEnabled&&(this._waterReflectionEnabled=this._rctx.parameters.maxTextureImageUnits>=10&&e.waterReflectionEnabled),this.requestRender()},Object.defineProperty(e.prototype,"hasSlicePlane",{get:function(){return!!this._sliceHelper.plane},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"renderPlugins",{get:function(){return this._renderPlugins},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"canRender",{get:function(){return this._camera.fullWidth>0&&this._camera.fullHeight>0},enumerable:!1,configurable:!0}),e.prototype.getStats=function(){return this._stats.getAggregatedStats()},e.prototype.getFramebufferTexture=function(e){switch(e){case"color":return this._offscreenRendering.colorTexture;case"hudVisibility":return this._offscreenRendering.hudVisibilityTexture;case"shadowMap":return this._shadowMap&&this._shadowMap.getDepthTexture();case"linearDepth":return this._offscreenRendering.linearDepthTexture;case"normals":return this._offscreenRendering.normalTexture;case"highlight":return this._offscreenRendering.highlightTexture;default:return t.neverReached(e),null}},e.prototype.modify=function(e,r,t,n,s,a){var o=this;void 0===r&&(r=e?e.length:0),void 0===n&&(n=t?t.length:0),void 0===a&&(a=s?s.length:0),this._isRendering&&console.warn("Renderer.modify called while rendering");for(var d=0;d<n;++d)this._content.delete(t[d].uniqueName);for(d=0;d<r;++d)this._content.set(e[d].uniqueName,e[d]);if(r||n||a){var h=H.splitRenderGeometryChangeSetByMaterial({toAdd:e,numToAdd:r,toRemove:t,numToRemove:n,toUpdate:s,numToUpdate:a}),l=!1;h.forEach((function(e,r){var t=o._materialRenderers.get(r);!t&&e.toAdd.length>0&&(t=new V(o._rctx,o._materialRep,r),o._materialRenderers.set(r,t)),t&&(t.modify(e),t.isEmpty&&(l=!0))})),l&&this._materialRenderers.forEach((function(e,r){e.isEmpty&&(o._materialRenderers.delete(r),e.dispose())})),this._hasHighlights=i.someMap(this._materialRenderers,(function(e){return e.hasHighlights})),this._hasOccludees=i.someMap(this._materialRenderers,(function(e){return e.hasOccludees})),this._hasWater=i.someMap(this._materialRenderers,(function(e){return e.hasWater})),this.requestRender()}},e.prototype.updateLogic=function(e){var r=!1;return this._materialRenderers.forEach((function(t){t.updateLogic&&(r=t.updateLogic(e)||r)})),r},e.prototype.render=function(e,r,t,n){var s=this;this._isRendering=!0;var i=this._offscreenRendering;i.needLastFrameColorTexture=this._waterReflectionEnabled,i.advanceCurrentRenderTarget();var a=this._sliceHelper.plane;t&&(this._sliceHelper.plane=null),this._rctx.bindFramebuffer(e),r.setGLViewport(this._rctx),this._renderPlugins.prepareRender(r),this.renderShadowMap(e,r,n),this.ensureBindParameters(this._renderContext,r),this.ensureBindParametersSSR(this._renderContext),i.initializeFrame(r),this.renderLinearDepth(),this.renderNormal(),this._ssaoHelper.enabled&&this._ssaoHelper.computeSSAO(r,i.linearDepthTexture,i.normalTexture),this._ssaoHelper.bindToAllPrograms(this._shaderTechniqueRepository),this._stats.reset(),this._renderContext.pass=0,this._renderContext.hasOccludees=this._hasOccludees,i.bindFramebuffer(),this._renderPlugins.render(0,this._renderContext),this.renderOpaqueGeometry(this._renderContext),this.renderEdges(2),this.renderHiddenTransparentEdges(),this.renderOrderIndependentTransparency(),this.renderEdges(1);var o={hudVisibility:!1,transparentTerrain:!1};o.hudVisibility=this.renderHUDVisibility(this._renderContext),this.renderInternalSlot(20,this._renderContext),o.transparentTerrain=this.renderTransparentTerrain(this._renderContext),o.transparentTerrain&&o.hudVisibility&&(i.compositeTransparentTerrainOntoHUDVisibility(),i.renderToTargets((function(){return s.renderHUD(g.HUD.TransparentRenderStyle.OCCLUDED)}),i.currentColorTarget,i.tmpDepth,void 0,!0,!0)),o.transparentTerrain&&i.compositeTransparentTerrainOntoMain(),i.renderToTargets((function(){s.renderInternalSlot(8,s._renderContext),s._renderPlugins.render(15,s._renderContext),s._renderPlugins.render(16,s._renderContext)}),i.currentColorTarget,i.mainDepth),this._renderPlugins.needsLaserlineWithContrastControl&&i.renderAndComposite((function(){s._renderPlugins.render(17,s._renderContext)}),2),this.renderOccluded(),this.renderAntiAliasing(e,this._antialiasing),this._rctx.bindFramebuffer(e),this._rctx.clearSafe(256),this.renderHUD(g.HUD.TransparentRenderStyle.NOTOCCLUDED),this.renderHighlights(this._renderContext.camera,e),this._renderContext.lastFrameCamera.copyFrom(this._renderContext.camera),this._sliceHelper.plane=a,this._isRendering=!1,this.onPostRender&&this.onPostRender()},e.prototype.renderEdges=function(e){var r=this,t=this._edgeView;t&&t.shouldRender()&&this._offscreenRendering.renderAndComposite((function(){return t.render(r._bindParameters,e)}),1)},e.prototype.renderShadowMap=function(e,r,t){var n=this._shadowMap;if(n.enabled){p.ENABLE_PROFILE_DEPTH_RANGE&&o.begin("depthRange");var s=this.computeDepthRange(r);p.ENABLE_PROFILE_DEPTH_RANGE&&o.end("depthRange"),n.prepare(r,t,s);for(var i=n.getCascades(),a=0;a<i.length;++a){var d=i[a];d.camera.setGLViewport(this._rctx),this.ensureCameraBindParameters(this._renderContext,d.camera),this.renderGeometryPass(3)}n.finish(e),r.setGLViewport(this._rctx)}n.bindToAllPrograms(this._shaderTechniqueRepository)},e.prototype.renderLinearDepth=function(){var e=this;this._ssaoHelper.enabled||this._renderPlugins.needsLinearDepth||this._hasWater&&this._waterReflectionEnabled?this._offscreenRendering.renderToTargets((function(){return e.renderGeometryPass(1)}),this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.linearDepth)},e.prototype.renderNormal=function(){var e=this;this._ssaoHelper.enabled?this._offscreenRendering.renderToTargets((function(){e.renderGeometryPass(2)}),this._offscreenRendering.normal,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.normal)},e.prototype.computeDepthRange=function(e){var r=R.depthRangeFromScene(e,this._content,this._stage.getLayers());return b.union(r,this.renderPlugins.queryDepthRange(e)),r.near=Math.max(e.near,r.near),r.far=Math.min(e.far,r.far),r},e.prototype.renderGeometryPass=function(e){this._renderContext.pass=e,this.renderOpaqueGeometry(this._renderContext),this.renderTransparentGeometry(this._renderContext),this.renderTransparentTerrain(this._renderContext)},e.prototype.renderOpaqueGeometry=function(e){this._renderPlugins.render(1,e),this._renderPlugins.render(2,e),this.renderInternalSlot(3,e),this._renderPlugins.render(4,e),e.ssaoHelper&&e.ssaoHelper.bindToAllPrograms(this._shaderTechniqueRepository),this._renderPlugins.render(14,this._renderContext)},e.prototype.renderTransparentGeometry=function(e){this.renderInternalSlot(5,e),this._renderPlugins.render(6,e),e.ssaoHelper&&e.ssaoHelper.bindToAllPrograms(this._shaderTechniqueRepository)},e.prototype.renderTransparentTerrain=function(e){return this._renderPlugins.render(7,e)},e.prototype.renderHUDVisibility=function(e){var r=this,t=!1;return e.offscreenRenderingHelper&&e.offscreenRenderingHelper.renderHUDVisibility((function(){r._bindParameters.hudVisibilityTexture=r._renderContext.offscreenRenderingHelper?r._renderContext.offscreenRenderingHelper.hudVisibilityTexture:null,t=r.renderInternalSlot(12,e)})),t},e.prototype.renderHUD=function(e){this._bindParameters.renderTransparentlyOccludedHUD=e,this.renderInternalSlot(21,this._renderContext),this.renderInternalSlot(18,this._renderContext),this.renderInternalSlot(19,this._renderContext)},e.prototype.renderHighlights=function(e,r){var t=this,n=this._highlightHelper;if(!!n&&n.enabled&&(this._hasHighlights||this._renderPlugins.needsHighlight)){var s=null;n.profilingCallback&&(s=U.startMeasurement(this._renderContext.rctx)),this._renderContext.highlightDepthTexture=this._bindParameters.highlightDepthTexture;var i=this._offscreenRendering.renderToTargets((function(){t.renderGeometryPass(4),t._rctx.clearSafe(256),t.renderHUD(g.HUD.TransparentRenderStyle.BOTH)}),this._offscreenRendering.highlight,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0);n.render(e,i,r),null!==s&&n.profilingCallback&&s.stop((function(e){n.profilingCallback&&n.profilingCallback(e)}))}else this._offscreenRendering.disposeTarget(this._offscreenRendering.highlight)},e.prototype.renderOrderIndependentTransparency=function(){var e=this;if(this._OITEnabled&&this._rctx.capabilities.textureFloat&&this._rctx.capabilities.textureFloat.textureFloat){var r=function(r){e._renderContext.transparencyPassType=r,e._offscreenRendering.renderOITPass((function(){return e.renderTransparentGeometry(e._renderContext)}),r)};r(0),r(1),r(2),this._offscreenRendering.compositeTransparentOntoOpaque(),this._renderContext.transparencyPassType=3}else this.renderTransparentGeometry(this._renderContext)},e.prototype.renderOccluded=function(){var e=this,r=0;this._materialRenderers.forEach((function(e,t){t&&t.isVisible()&&8===t.renderOccluded&&(r|=t.renderOccluded,A.push(t))}));var t=this._offscreenRendering,n=this._renderContext,s=function(e,n,s,i,o){void 0===s&&(s=function(){return a(n)}),void 0===i&&(i=!0),void 0===o&&(o=!0),0!=(r&n)&&(t.renderToTargets(s,t.tmpColor,t.mainDepth,[0,0,0,0],i,o),t.compositeOccludedOntoMain(e))};0!==A.length&&(this.renderInternalSlot(10,n,A),s(.2,8,(function(){return e.renderInternalSlot(11,n,A)}),!1,!1),A.length=0),this._materialRenderers.forEach((function(e,t){t&&t.isVisible()&&(4===t.renderOccluded||2===t.renderOccluded||32===t.renderOccluded||16===t.renderOccluded)&&(r|=t.renderOccluded,G.push(t))}));var i=this._renderPlugins.renderOccludedFlags;if(r|=i){var a=function(r){n.renderOccludedMask=r,i>1&&e._renderPlugins.render(9,n),e.renderInternalSlot(3,n,G),e.renderInternalSlot(5,n,G),e.renderInternalSlot(8,n,G),n.resetRenderOccludedMask()};n.pass=0,s(.5,4,(function(){return a(4)}),!0,2),s(.5,2,(function(){return a(2)}),!0,2),s(1,48,(function(){a(16),a(32)}),!0,2),G.length=0}},e.prototype.renderAntiAliasing=function(e,r){var t=this;switch(r){case 1:this._smaaPass.loadResources((function(){return t.requestRender()})),this._smaaPass.enable()?(this._fxaaPass.disable(),this._smaaPass.render({colorTexture:this._offscreenRendering.colorTexture},e)):(this._rctx.bindFramebuffer(e),this._offscreenRendering.composite());break;case 2:this._fxaaPass.enable()?(this._smaaPass.disable(),this._fxaaPass.render({colorTexture:this._offscreenRendering.colorTexture},e)):(this._rctx.bindFramebuffer(e),this._offscreenRendering.composite());break;default:this._rctx.bindFramebuffer(e),this._offscreenRendering.composite(),this._fxaaPass.disable(),this._smaaPass.disable()}},e.prototype.ensureCameraBindParameters=function(e,r){this._renderContext.camera=r,this._bindParameters.camera=e.camera,this._bindParameters.inverseViewport[0]=1/e.camera.fullViewport[2],this._bindParameters.inverseViewport[1]=1/e.camera.fullViewport[3]},e.prototype.ensureBindParameters=function(e,r){this.ensureCameraBindParameters(e,r);var t=this._renderContext.offscreenRenderingHelper;this._bindParameters.shadowMap=e.shadowMap,this._bindParameters.shadowMappingEnabled=!!e.shadowMap&&e.shadowMap.enabled,this._bindParameters.ssaoEnabled=!!e.ssaoHelper&&e.ssaoHelper.enabled,this._bindParameters.slicePlane=e.sliceHelper&&e.sliceHelper.plane,this._bindParameters.hasOccludees=e.hasOccludees,this._bindParameters.linearDepthTextureID=3,this._bindParameters.lastFrameColorTextureID=4,this._bindParameters.hudVisibilityTexture=t?t.hudVisibilityTexture:null,this._bindParameters.highlightDepthTexture=t&&t.depthTexture||this.getFallbackDepthTexture()},e.prototype.ensureBindParametersSSR=function(e){this._waterReflectionEnabled?(h.mat4.translate(L,e.lastFrameCamera.viewMatrix,this._bindParameters.origin?this._bindParameters.origin:[0,0,0]),h.mat4.translate(j,e.camera.viewMatrix,this._bindParameters.origin?this._bindParameters.origin:[0,0,0]),h.mat4.invert(j,j),h.mat4.invert(k,e.camera.projectionMatrix),h.mat4.multiply(N,j,k),h.mat4.multiply(N,L,N),h.mat4.multiply(N,e.lastFrameCamera.projectionMatrix,N),this._renderContext.ssrParams.camera=e.camera,this._renderContext.ssrParams.reprojectionMat=this._bindParameters.reprojectionMat=N,this._renderContext.ssrParams.linearDepthTexture=this._bindParameters.linearDepthTexture=this._offscreenRendering.linearDepthTexture,this._renderContext.ssrParams.lastFrameColorTexture=this._bindParameters.lastFrameColorTexture=this._offscreenRendering.lastFrameColorTexture):this._renderContext.ssrParams.lastFrameColorTexture=this._bindParameters.lastFrameColorTexture=null,this._renderContext.ssrParams.ssrEnabled=this._bindParameters.ssrEnabled=this._waterReflectionEnabled},e.prototype.renderInternalSlot=function(e,r,t){var n=this,s=0===r.pass?this._stats:null,i=!1;return this._bindParameters.slot=e,a.isSome(t)?t.forEach((function(t){if(y.materialPredicate(t,r)){var s=n._materialRenderers.get(t);a.isSome(s)&&(i=s.render(e,r,n._bindParameters)||i)}})):this._materialRenderers.forEach((function(t,a){if(y.materialPredicate(a,r)){var o=s?s.getMaterialRenderStatsObject(t.type):null;i=t.render(e,r,n._bindParameters,o)||i}})),i},e.prototype.getFallbackDepthTexture=function(){return this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=T.createEmptyDepthTexture(this._rctx)),this._fallbackDepthStencilTexture},e.prototype.getGpuMemoryUsage=function(){return{offscreen:this._offscreenRendering?this._offscreenRendering.getGpuMemoryUsage():0,highlights:this._highlightHelper?this._highlightHelper.getGpuMemoryUsage():0,shadows:this._shadowMap?this._shadowMap.getGpuMemoryUsage():0,ssao:this._ssaoHelper?this._ssaoHelper.getGpuMemoryUsage():0}},Object.defineProperty(e.prototype,"test",{get:function(){var e=this;return{antialiasing:this._antialiasing,offscreen:this._offscreenRendering,shadowMap:this._shadowMap,ssao:this._ssaoHelper,highlight:this._highlightHelper,materialRenderers:this._materialRenderers,OITEnabled:this._OITEnabled,setOITEnabled:function(r){return e._OITEnabled=r}}},enumerable:!1,configurable:!0}),e}();r.default=q;var G=[],A=[],L=l.mat4f64.create(),k=l.mat4f64.create(),j=l.mat4f64.create(),N=l.mat4f64.create()}));