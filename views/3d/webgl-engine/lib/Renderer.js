/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../core/has","../../../../core/maybe","../../../../chunks/vec3f64","../../../../core/Handles","../../../../core/watchUtils","../../../../chunks/mat4","../../../../core/MapUtils","../../../../core/TimeProfiler","../../../../chunks/mat4f64","../../../../chunks/vec2f64","./BoundingInfo","./glUtil3D","./Camera","../../support/debugFlags","./Material","./RenderContext","./rendererUtils","../../../webgl/Measurement","../statistics/RendererPerformanceInfo","../materials/renderers/MergedRenderer","../lighting/SceneLighting","./depthRange","./depthRangeUtils","../core/renderPasses/RenderPassManager","./HighlightHelper","./OffscreenRendering","./RenderPluginManager","./ShadowHighlightHelper","./ShadowMap","./SliceHelper","./SmaaRenderPass","./SSAOHelper","./edgeRendering/EdgeView"],(function(e,r,t,n,s,i,a,h,o,d,l,c,p,u,_,g,f,m,T,x,R,b,P,C,y,w,H,D,E,M,S,I,v,G){"use strict";let L=function(){function r(e,r,t,a,h,o,d,c,p){this._materialRep=e,this._shaderTechniqueRepository=t,this._rctx=a,this._compositingHelper=h,this._magnifierHelper=o,this.requestRender=d,this._stage=p,this._materialRenderers=new Map,this._hasHighlights=!1,this._hasOccludees=!1,this._hasWater=!1,this._camera=new u(n.fromValues(0,100,-100)),this._content=new Map,this._isRendering=!1,this._bindParameters={slot:null,camera:null,inverseViewport:l.create(),shadowMappingEnabled:!1,ssaoEnabled:!1,origin:null,screenToWorldRatio:null,screenToWorldRatioGlobalWM:null,slicePlane:null,highlightDepthTexture:null,hasOccludees:!1,linearDepthTexture:null,linearDepthTextureUnit:0,terrainLinearDepthTexture:null,geometryLinearDepthTexture:null,multipassTerrainEnabled:!1,multipassGeometryEnabled:!1,cullAboveGround:!0,lastFrameColorTexture:null,lastFrameColorTextureUnit:0,reprojectionMat:null,ssrEnabled:!1,lighting:new b.SceneLighting},this._fallbackDepthStencilTexture=null,this.performanceInfo=new x.RendererPerformanceInfo,this._antialiasing=1,this._oitEnabled=!1,this._multipassTerrain=!0,this._opaqueTerrain=!0,this._handles=new s,this.renderHiddenTransparentEdges=()=>{},this._smaaPass=new I(this._rctx),this._oitEnabled=this._hasOITSupport,this.camera.viewport[2]=c[0],this.camera.viewport[3]=c[1],this.requestRender(),this._offscreenRendering=new H.OffscreenRendering(this._rctx,this._compositingHelper),this._sliceHelper=new S,this._shadowMap=new M(this._rctx,t.viewingMode,2),this._ssaoHelper=new v(t,this._rctx,(()=>this.requestRender())),this._highlightHelper=new w(t,this._rctx),this._shadowHighlightHelper=new E(t,this._rctx,0,1),this._renderContext=new f(this._rctx,this._offscreenRendering,this._bindParameters.lighting,this._shadowMap,this._ssaoHelper,this._sliceHelper),this._renderPlugins=new D.RenderPluginManager({renderContext:this._renderContext,shaderTechniqueRep:t,textureRep:r,materialRep:this._materialRep,requestRender:this.requestRender}),this.renderPassManager=new y.RenderPassManager(this._rctx,this._shaderTechniqueRepository),this._renderPlugins.add(this.renderPassManager.slots(),this.renderPassManager),this._renderContext.ssrParams={camera:null,linearDepthTexture:null,linearDepthTextureUnit:0,lastFrameColorTexture:null,lastFrameColorTextureUnit:0,reprojectionMat:null,ssrEnabled:!1},this._renderContext.multipassTerrainParams={camera:null,multipassTerrainEnabled:!1,cullAboveGround:!0,terrainLinearDepthTexture:null},this._renderContext.multipassGeometryParams={multipassGeometryEnabled:!1,geometryLinearDepthTexture:null},this._handles.add(i.init(_,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",(e=>{this.renderHiddenTransparentEdges=e?()=>this.renderEdges(1):()=>{},this.requestRender()})))}var d=r.prototype;return d.dispose=function(){this._handles.destroy(),this._smaaPass.disable(),this._materialRenderers.forEach((e=>e.dispose())),this._materialRenderers.clear(),this._edgeView=t.destroyMaybe(this._edgeView),this._offscreenRendering.dispose(),this._fallbackDepthStencilTexture=t.disposeMaybe(this._fallbackDepthStencilTexture),this._shadowMap.enabled=!1,this._shadowMap.dispose(),this._ssaoHelper.enabled=!1,this._ssaoHelper.dispose(),this._highlightHelper.dispose(),this._shadowHighlightHelper.dispose(),c.BoundingInfo.prune(),this._content.clear()},d.ensureEdgeView=function(){return t.isNone(this._edgeView)&&(this._edgeView=new G.EdgeView({rctx:this._rctx,techniqueRepository:this._shaderTechniqueRepository,setNeedsRender:()=>this.requestRender(),scheduler:this._stage.scheduler}),this._handles.add(this._edgeView.watch("updating",(()=>this.requestRender()),!0)),this.requestRender()),this._edgeView},d.setLighting=function(e){this._bindParameters.lighting.set(e)},d.setRenderParameters=function(e){const{renderPassManager:r,_shadowMap:n,_ssaoHelper:s}=this;void 0!==e.screenSpaceReflectionsEnabled&&r.screenSpaceReflectionsEnabled!==e.screenSpaceReflectionsEnabled&&(r.screenSpaceReflectionsEnabled=e.screenSpaceReflectionsEnabled,this.requestRender()),void 0===e.shadowMap||n.enabled===e.shadowMap&&r.shadowCastingEnabled===e.shadowMap||(n.enabled=e.shadowMap,r.shadowCastingEnabled=e.shadowMap,this.requestRender()),void 0!==e.shadowMapMaxCascades&&n.maxCascades!==e.shadowMapMaxCascades&&(n.maxCascades=e.shadowMapMaxCascades,this.requestRender()),void 0!==e.ssao&&s.enabled!==e.ssao&&(s.enabled=e.ssao,this.requestRender()),void 0!==e.ssaoAttenuation&&s.attenuation!==e.ssaoAttenuation&&(s.attenuation=e.ssaoAttenuation,this.requestRender()),void 0!==e.ssaoRadius&&s.radius!==e.ssaoRadius&&(s.radius=e.ssaoRadius,this.requestRender()),void 0!==e.ssaoSamples&&s.samples!==e.ssaoSamples&&(s.samples=e.ssaoSamples,this.requestRender()),e.background&&this._offscreenRendering.background!==e.background&&(this._offscreenRendering.background=e.background,this.requestRender());const i=e.antialiasingEnabled?1:0;void 0!==e.antialiasingEnabled&&this._antialiasing!==i&&(this._antialiasing=i,this.requestRender()),void 0!==e.highQualityTransparency&&this._multipassTerrain!==e.highQualityTransparency&&(this._multipassTerrain=e.highQualityTransparency,this._oitEnabled=e.highQualityTransparency&&this._hasOITSupport,this.requestRender()),void 0!==e.defaultHighlightOptions&&(this._highlightHelper.setDefaultOptions(e.defaultHighlightOptions),this._shadowHighlightHelper.setDefaultOptions(e.defaultHighlightOptions),this.requestRender()),void 0!==e.slicePlane&&this._sliceHelper.plane!==e.slicePlane&&(this._sliceHelper.plane=t.unwrap(e.slicePlane),this.requestRender());const a=this._rctx.parameters.maxTextureImageUnits>=10&&e.waterReflectionEnabled;void 0!==e.waterReflectionEnabled&&this._waterReflectionEnabled!==a&&(this._waterReflectionEnabled=a,this.requestRender()),void 0!==e.opaqueTerrain&&this._opaqueTerrain!==e.opaqueTerrain&&(this._opaqueTerrain=e.opaqueTerrain,this.requestRender())},d.getFramebufferTexture=function(e){switch(e){case"color":return this._offscreenRendering.colorTexture;case"hudVisibility":return this._offscreenRendering.hudVisibilityTexture;case"shadowMap":return this._shadowMap&&this._shadowMap.getDepthTexture();case"linearDepth":return this._offscreenRendering.linearDepthTexture;case"normals":return this._offscreenRendering.normalTexture;case"highlight":return this._offscreenRendering.highlightTexture;default:return null}},d.modify=function(e){this._isRendering&&console.warn("Renderer.modify called while rendering");const{adds:r,removes:t,updates:n}=e;if(0===r.length&&0===t.length&&0===n.length)return;t.forAll((({id:e})=>this._content.delete(e))),r.forAll((e=>this._content.set(e.id,e)));const s=m.splitRenderGeometryChangeSetByMaterial(e);let i=!1;s.forEach(((e,r)=>{let t=this._materialRenderers.get(r);if(!t){if(!(e.adds.length>0))return;t=new R(this._rctx,this._materialRep,r),this._materialRenderers.set(r,t)}t.modify(e),t.isEmpty&&(i=!0)})),i&&this._materialRenderers.forEach(((e,r)=>{e.isEmpty&&(this._materialRenderers.delete(r),e.dispose())})),this._hasHighlights=h.someMap(this._materialRenderers,(e=>e.hasHighlights)),this._hasOccludees=h.someMap(this._materialRenderers,(e=>e.hasOccludees)),this._hasWater=h.someMap(this._materialRenderers,(e=>e.hasWater)),this.requestRender()},d.updateLogic=function(e){let r=!1;return this._materialRenderers.forEach((t=>{t.updateLogic&&(r=t.updateLogic(e)||r)})),r},d.render=function(e,r,n){this._isRendering=!0,this.performanceInfo.prerender(this._rctx),this.setLighting(this._stage.lighting),this._renderContext.hasOccludees=this._hasOccludees,this._renderContext.transparencyPassType=3,this._bindParameters.transparencyPassType=3;const s=this._offscreenRendering;s.needLastFrameColorTexture=this._waterReflectionEnabled,s.advanceCurrentRenderTarget();const i=this._sliceHelper.plane;n&&(this._sliceHelper.plane=null),this._rctx.bindFramebuffer(e),r.setGLViewport(this._rctx),this._renderPlugins.prepareRender(r),this.performanceInfo.advance(0),this._shadowHighlightHelper.setup(r,this._stage.mainLightDirection),this.renderShadowMap(e,r,this._stage.mainLightDirection),this.performanceInfo.advance(1),s.initializeFrame(r),this.ensureBindParameters(r),this.renderLinearDepth(),this.performanceInfo.advance(2),this.renderNormal(),this.performanceInfo.advance(3),this.ensureBindParametersSSR(),this._ssaoHelper.enabled&&this._ssaoHelper.computeSSAO(r,s.linearDepthTexture,s.normalTexture),this._ssaoHelper.bindToAllPrograms(this._shaderTechniqueRepository),this.performanceInfo.advance(4),this.performanceInfo.stats.reset(),this._renderContext.pass=0,s.bindFramebuffer(),this.renderSlot(0),this.renderOpaqueGeometry(),this.performanceInfo.advance(5);const a=this._multipassTerrain&&!this._opaqueTerrain;this.renderTerrainLinearDepth(a),this.setMultipassFlags(a),this.setTerrainCulling(a),this.renderEdges(2),this.performanceInfo.advance(6),this.renderHiddenTransparentEdges(),this._oitEnabled?this.renderOrderIndependentTransparency((()=>this.renderTransparentGeometry()),!1):this.renderTransparentGeometry(),this.performanceInfo.advance(7),this.renderGeometryLinearDepth(a);const h={hudVisibility:!1,transparentTerrain:!1};h.hudVisibility=this.renderHUDVisibility(),a||this.renderInternalSlot(20),this.performanceInfo.advance(9),this.renderEdges(1,a),this.performanceInfo.advance(8),h.transparentTerrain=this.renderTransparentTerrain(),h.transparentTerrain&&h.hudVisibility&&(s.compositeTransparentTerrainOntoHUDVisibility(),a&&this.renderLineCallouts(0),this.renderHUD(0,s.framebuffer),this.performanceInfo.advance(16)),this.performanceInfo.advance(10),this.setTerrainCulling(!1),h.transparentTerrain&&(s.compositeTransparentTerrainOntoMain(),a&&(this.renderEdges(2),this.performanceInfo.advance(6),this._oitEnabled?this.renderOrderIndependentTransparency((()=>this.renderTransparentGeometry()),!1):this.renderTransparentGeometry(),this.performanceInfo.advance(7),this.renderEdges(1),this.performanceInfo.advance(8))),a&&this.renderLineCallouts(1),this.setMultipassFlags(!1),s.renderToTargets((()=>{this.renderInternalSlot(8),this.renderSlot(15),this.renderSlot(16)}),s.currentColorTarget,s.mainDepth),this.performanceInfo.advance(11),this._renderPlugins.needsLaserlineWithContrastControl&&s.renderTmpAndCompositeToMain((()=>{this.renderSlot(17)}),2),this.performanceInfo.advance(12),this.renderOccluded(),this.performanceInfo.advance(13);const o=!n&&this._magnifierHelper.enabled,d=o&&t.isNone(e)?this._offscreenRendering.getFramebuffer(this._offscreenRendering.tmpColor,this._offscreenRendering.tmpDepth):e;this._rctx.bindFramebuffer(d),this.renderAntiAliasing(this._antialiasing,this._offscreenRendering.colorTexture)||this._compositingHelper.composite(this._offscreenRendering.colorTexture,0),this.performanceInfo.advance(14),this.renderHUD(1,d),this.performanceInfo.advance(17),this.renderHighlights(d,s.linearDepthTexture),this.performanceInfo.advance(15),o&&this._magnifierHelper.render(this._rctx,this._bindParameters),d!==e&&(this._rctx.bindFramebuffer(e),this._compositingHelper.composite(this._offscreenRendering.tmpColorTexture,0)),this._renderContext.lastFrameCamera.copyFrom(this._renderContext.camera),this._sliceHelper.plane=i,this._isRendering=!1,this.onPostRender&&this.onPostRender(),this.performanceInfo.postrender()},d.readDepthPixels=function(e,r,t,n,s){const i=this._offscreenRendering.bindTarget(this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth);if(!this.needsLinearDepth()){this._renderContext.camera.setGLViewport(this._rctx),this._rctx.setClearColor(0,0,0,0);const e=17664;this._rctx.clearSafe(e,255),this.renderGeometryAndTransparentTerrainPass(2),this._rctx.gl.flush(),this._rctx.gl.finish()}i.readPixels(e,r,t,n,6408,5121,s)},d.setMultipassFlags=function(e){this._renderContext.multipassTerrainParams.multipassTerrainEnabled=this._bindParameters.multipassTerrainEnabled=e,this._renderContext.multipassGeometryParams.multipassGeometryEnabled=this._bindParameters.multipassGeometryEnabled=e},d.setTerrainCulling=function(e){this._renderContext.multipassTerrainParams.cullAboveGround=this._bindParameters.cullAboveGround=e},d.renderSlot=function(e){return this._renderContext.slot=e,this._renderPlugins.render()},d.renderEdges=function(e,r=!1){const n=this._edgeView;t.isSome(n)&&n.shouldRender()&&this._offscreenRendering.renderTmpAndCompositeToMain((()=>n.render(this._bindParameters,e)),1,r)},d.renderShadowMap=function(e,r,t){const n=this._shadowMap;if(n.enabled){_.ENABLE_PROFILE_DEPTH_RANGE&&o.begin("depthRange");const s=this.computeDepthRange(r);_.ENABLE_PROFILE_DEPTH_RANGE&&o.end("depthRange"),n.prepare(r,t,s);const i=n.getCascades();if(this.needsShadowHighlight()){const e=this._shadowHighlightHelper;for(let r=0;r<i.length;++r){const t=i[r];t.camera.setGLViewport(this._rctx),this.ensureCameraBindParameters(t.camera),this.renderGeometryAndTransparentTerrainPass(7),n.takeCascadeSnapshotTo(t,e.highlightShadowMapSlot)}n.clear();for(let r=0;r<i.length;++r){const t=i[r];t.camera.setGLViewport(this._rctx),this.ensureCameraBindParameters(t.camera),this.renderGeometryAndTransparentTerrainPass(6),n.takeCascadeSnapshotTo(t,e.defaultSnapshotSlot),this.renderGeometryAndTransparentTerrainPass(7)}}else for(let e=0;e<i.length;++e){const r=i[e];r.camera.setGLViewport(this._rctx),this.ensureCameraBindParameters(r.camera),this.renderGeometryAndTransparentTerrainPass(4)}n.finish(e),r.setGLViewport(this._rctx)}n.bindToAllPrograms(this._shaderTechniqueRepository)},d.needsLinearDepth=function(){return this._ssaoHelper.enabled||this._renderPlugins.needsLinearDepth||this._hasWater&&this._waterReflectionEnabled||this.needsShadowHighlight()},d.renderLinearDepth=function(){this.needsLinearDepth()?this._offscreenRendering.renderToTargets((()=>this.renderGeometryAndTransparentTerrainPass(2)),this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.linearDepth)},d.renderTerrainLinearDepth=function(e){if(e){const e=this._renderContext.pass;this._renderContext.pass=2,this._offscreenRendering.renderToTargets((()=>this.renderTransparentTerrain()),this._offscreenRendering.terrainLinearDepth,this._offscreenRendering.tmpDepth,[-1e10,-1e10,-1e10,1],!0,!0),this._renderContext.pass=e}else this._offscreenRendering.disposeTarget(this._offscreenRendering.terrainLinearDepth);this._renderContext.multipassTerrainParams.terrainLinearDepthTexture=this._bindParameters.terrainLinearDepthTexture=this._offscreenRendering.terrainLinearDepthTexture},d.renderGeometryLinearDepth=function(e){if(e){const e=this._renderContext.pass;this._offscreenRendering.renderToTargets((()=>this.renderGeometryPass(2)),this._offscreenRendering.geometryLinearDepth,this._offscreenRendering.tmpDepth,[1,1,1,1],!0,!0),this._renderContext.pass=e}else this._offscreenRendering.disposeTarget(this._offscreenRendering.geometryLinearDepth);this._renderContext.multipassGeometryParams.geometryLinearDepthTexture=this._bindParameters.geometryLinearDepthTexture=this._offscreenRendering.geometryLinearDepthTexture},d.needsNormal=function(){return this._ssaoHelper.enabled},d.renderNormal=function(){this.needsNormal()?this._offscreenRendering.renderToTargets((()=>{this.renderGeometryAndTransparentTerrainPass(3)}),this._offscreenRendering.normal,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.normal)},d.computeDepthRange=function(e){const r=C.depthRangeFromScene(e,this._content,this._stage.layers);return P.union(r,this.renderPlugins.queryDepthRange(e)),r.near=Math.max(e.near,r.near),r.far=Math.min(e.far,r.far),r},d.renderGeometryAndTransparentTerrainPass=function(e){this._renderContext.pass=e,this.renderGeometryPass(e),this.renderTransparentTerrain()},d.renderGeometryPass=function(e){this._renderContext.pass=e,this.renderOpaqueGeometry(),this.renderTransparentGeometry()},d.renderOpaqueGeometry=function(){this.renderSlot(1),this.renderSlot(2),this.renderInternalSlot(3),this.renderSlot(4),this._bindParameters.ssaoEnabled&&this._renderContext.ssaoHelper.bindToAllPrograms(this._shaderTechniqueRepository),this.renderSlot(14)},d.renderTransparentGeometry=function(){this.renderInternalSlot(5),this.renderSlot(6),this._bindParameters.ssaoEnabled&&this._renderContext.ssaoHelper.bindToAllPrograms(this._shaderTechniqueRepository)},d.renderTransparentTerrain=function(){return this.renderSlot(7)},d.renderHUDVisibility=function(){let e=!1;return this._renderContext.offscreenRenderingHelper&&this._renderContext.offscreenRenderingHelper.renderHUDVisibility((()=>{this._bindParameters.hudVisibilityTexture=this._renderContext.offscreenRenderingHelper?this._renderContext.offscreenRenderingHelper.hudVisibilityTexture:null,e=this.renderInternalSlot(12)})),e},d.renderLineCallouts=function(e){this._bindParameters.renderTransparentlyOccludedHUD=e,0===e?this._offscreenRendering.renderToTargets((()=>this.renderInternalSlot(20)),this._offscreenRendering.currentColorTarget,this._offscreenRendering.tmpDepth,void 0,!0,!0):this.renderInternalSlot(20)},d.renderHUD=function(e,r){this._oitEnabled?(this.renderOrderIndependentTransparency((()=>this.renderHUDElements(e)),!0),this._rctx.bindFramebuffer(r),this._compositingHelper.composite(this._offscreenRendering.hudColorTexture,2)):0===e?this._offscreenRendering.renderToTargets((()=>this.renderHUDElements(0)),this._offscreenRendering.currentColorTarget,this._offscreenRendering.tmpDepth,void 0,!0,!0):this.renderHUDElements(e)},d.renderHUDElements=function(e){this._bindParameters.renderTransparentlyOccludedHUD=e,this.renderInternalSlot(21),this.renderInternalSlot(18),this.renderInternalSlot(19)},d.needsHighlight=function(){return this._hasHighlights||this._renderPlugins.needsHighlight},d.needsShadowHighlight=function(){return this._shadowMap.enabled&&this._shadowHighlightHelper.wouldRender&&this.needsHighlight()},d.renderHighlights=function(e,r){if(!this.needsHighlight())return void this._offscreenRendering.disposeTarget(this._offscreenRendering.highlight);const n=this._highlightHelper,s=n.profilingCallback&&T.startMeasurement(this._renderContext.rctx);this._renderContext.highlightDepthTexture=this._bindParameters.highlightDepthTexture;const i=this._offscreenRendering.renderToTargets((()=>{this.renderGeometryAndTransparentTerrainPass(5),this._rctx.clearSafe(256),this.renderHUDElements(2)}),this._offscreenRendering.highlight,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0);if(this.needsShadowHighlight()){this._shadowHighlightHelper.render(this._renderContext.camera,r,this._shadowMap,this._stage.mainLightDirection,i,e)}n.render(this._renderContext.camera,i,e),t.isSome(s)&&n.profilingCallback&&s.stop((e=>{n.profilingCallback&&n.profilingCallback(e)}))},d.renderOrderIndependentTransparency=function(e,r){const t=t=>{this._renderContext.transparencyPassType=t,this._bindParameters.transparencyPassType=this._renderContext.transparencyPassType,this._offscreenRendering.renderOITPass((()=>e()),t,r)},n=this._renderContext.pass;this._renderContext.pass=1,t(1),this._renderContext.pass=0,t(0),t(2),this._offscreenRendering.compositeTransparentOntoOpaque(r),this._renderContext.transparencyPassType=3,this._bindParameters.transparencyPassType=this._renderContext.transparencyPassType,this._renderContext.pass=n},d.renderOccluded=function(){let e=0;this._materialRenderers.forEach(((r,t)=>{t&&t.isVisible()&&8===t.renderOccluded&&(e|=t.renderOccluded,q.push(t))}));const r=this._offscreenRendering,t=(t,n,i=(()=>s(n)),a=!0,h=!0)=>{0!=(e&n)&&(r.renderToTargets(i,r.tmpColor,r.mainDepth,[0,0,0,0],a,h),r.compositeOccludedOntoMain(t))};0!==q.length&&(this.renderInternalSlot(10,q),t(.5,8,(()=>this.renderInternalSlot(11,q)),!1,!1),q.length=0),this._materialRenderers.forEach(((r,t)=>{t&&t.isVisible()&&(4===t.renderOccluded||2===t.renderOccluded||16===t.renderOccluded)&&(e|=t.renderOccluded,O.push(t))}));const n=this._renderPlugins.renderOccludedFlags;if(e|=n,!e)return;const s=e=>{this._renderContext.renderOccludedMask=e,n>1&&this.renderSlot(9),this.renderInternalSlot(3,O),this.renderInternalSlot(5,O),this.renderInternalSlot(8,O),this._renderContext.resetRenderOccludedMask()};this._renderContext.pass=0,t(.5,4,(()=>s(4)),!0,2),t(.5,2,(()=>s(2)),!0,2),t(1,16,(()=>s(16)),!0,2),O.length=0},d.renderAntiAliasing=function(e,r){if(1===e){if(this._smaaPass.loadResources((()=>this.requestRender())),this._smaaPass.enable())return this._smaaPass.render({colorTexture:r}),!0}else this._smaaPass.disable();return!1},d.ensureCameraBindParameters=function(e){this._renderContext.camera=e,this._bindParameters.camera=this._renderContext.camera,this._bindParameters.inverseViewport[0]=1/this._renderContext.camera.fullViewport[2],this._bindParameters.inverseViewport[1]=1/this._renderContext.camera.fullViewport[3]},d.ensureBindParameters=function(e){this.ensureCameraBindParameters(e);const r=this._renderContext.offscreenRenderingHelper;this._bindParameters.shadowMap=this._renderContext.shadowMap,this._bindParameters.shadowMappingEnabled=!!this._renderContext.shadowMap&&this._renderContext.shadowMap.enabled,this._bindParameters.ssaoEnabled=!!this._renderContext.ssaoHelper&&this._renderContext.ssaoHelper.enabled,this._bindParameters.slicePlane=this._renderContext.sliceHelper&&this._renderContext.sliceHelper.plane,this._bindParameters.hasOccludees=this._renderContext.hasOccludees,this._bindParameters.linearDepthTextureUnit=3,this._bindParameters.lastFrameColorTextureUnit=4,this._renderContext.multipassTerrainParams.camera=this._renderContext.camera,this._bindParameters.hudVisibilityTexture=r?r.hudVisibilityTexture:null,this._bindParameters.highlightDepthTexture=r&&r.depthTexture||this.getFallbackDepthTexture()},d.ensureBindParametersSSR=function(){this._waterReflectionEnabled?(a.translate(F,this._renderContext.lastFrameCamera.viewMatrix,this._bindParameters.origin?this._bindParameters.origin:[0,0,0]),a.translate(k,this._renderContext.camera.viewMatrix,this._bindParameters.origin?this._bindParameters.origin:[0,0,0]),a.invert(k,k),a.invert(V,this._renderContext.camera.projectionMatrix),a.multiply(A,k,V),a.multiply(A,F,A),a.multiply(A,this._renderContext.lastFrameCamera.projectionMatrix,A),this._renderContext.ssrParams.camera=this._renderContext.camera,this._renderContext.ssrParams.reprojectionMat=this._bindParameters.reprojectionMat=A,this._renderContext.ssrParams.linearDepthTexture=this._bindParameters.linearDepthTexture=this._offscreenRendering.linearDepthTexture,this._renderContext.ssrParams.lastFrameColorTexture=this._bindParameters.lastFrameColorTexture=this._offscreenRendering.lastFrameColorTexture):this._renderContext.ssrParams.lastFrameColorTexture=this._bindParameters.lastFrameColorTexture=null,this._renderContext.ssrParams.ssrEnabled=this._bindParameters.ssrEnabled=this._waterReflectionEnabled},d.renderInternalSlot=function(e,r){const n=0===this._renderContext.pass?this.performanceInfo.stats:null;let s=!1;return this._bindParameters.slot=e,t.isSome(r)?r.forEach((r=>{if(!g.materialPredicate(r,this._renderContext))return;const n=this._materialRenderers.get(r);t.isSome(n)&&(s=n.render(e,this._renderContext,this._bindParameters)||s)})):this._materialRenderers.forEach(((r,t)=>{g.materialPredicate(t,this._renderContext)&&(s=r.render(e,this._renderContext,this._bindParameters,n)||s)})),s},d.getFallbackDepthTexture=function(){return this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=p.createEmptyDepthTexture(this._rctx)),this._fallbackDepthStencilTexture},d.getGpuMemoryUsage=function(){return{offscreen:this._offscreenRendering?this._offscreenRendering.getGpuMemoryUsage():0,highlights:(this._highlightHelper?this._highlightHelper.getGpuMemoryUsage():0)+(this._shadowHighlightHelper?this._shadowHighlightHelper.getGpuMemoryUsage():0),shadows:this._shadowMap?this._shadowMap.getGpuMemoryUsage():0,ssao:this._ssaoHelper?this._ssaoHelper.getGpuMemoryUsage():0}},e._createClass(r,[{key:"updating",get:function(){return 1===this._antialiasing&&this._smaaPass.isLoadingResources||t.isSome(this._edgeView)&&this._edgeView.updating||!this.isCameraFinal}},{key:"camera",get:function(){return this._camera},set:function(e){this._camera.copyFrom(e),this.requestRender()}},{key:"edgeView",get:function(){return this._edgeView}},{key:"isCameraFinal",get:function(){return null===this._bindParameters.reprojectionMat||a.equals(this._bindParameters.reprojectionMat,U)}},{key:"hasShadowsEnabled",get:function(){var e;return!(null==(e=this._shadowMap)||!e.enabled)}},{key:"hasSlicePlane",get:function(){return!!this._sliceHelper.plane}},{key:"renderPlugins",get:function(){return this._renderPlugins}},{key:"canRender",get:function(){return this._camera.fullWidth>0&&this._camera.fullHeight>0}},{key:"_hasOITSupport",get:function(){return this._rctx.capabilities.textureFloat&&this._rctx.capabilities.textureFloat.textureFloat&&this._rctx.capabilities.colorBufferFloat&&this._rctx.capabilities.colorBufferFloat.textureFloat}},{key:"test",get:function(){return{antialiasing:this._antialiasing,offscreen:this._offscreenRendering,shadowMap:this._shadowMap,ssao:this._ssaoHelper,highlight:this._highlightHelper,materialRenderers:this._materialRenderers,oitEnabled:this._oitEnabled,shadowHighlights:this._shadowHighlightHelper}}}]),r}();const O=[],q=[],F=d.create(),V=d.create(),k=d.create(),A=d.create(),U=d.create();return L}));
