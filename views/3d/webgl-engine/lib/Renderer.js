/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/arrayUtils","../../../../core/Handles","../../../../core/has","../../../../core/maybe","../../../../core/PooledArray","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/boundedPlane","../../support/debugFlags","../../terrain/TerrainRenderer","../core/renderPasses/RenderPassManager","../core/shaderLibrary/ShaderOutput","../core/shaderLibrary/hud/HUDUniforms","./AnimationTimeStep","./basicInterfaces","./BoundingInfo","./depthRange","./depthRangeUtils","./glUtil3D","./Highlight","./Material","./OffscreenRendering","./RenderContext","./rendererUtils","./RenderFeature","./RenderPluginManager","./RenderSlot","./ShadowAccumulator","./ShadowHighlight","./ShadowMap","./SliceHelper","./SmaaRenderPass","./SSAOHelper","./TransparencyPassType","./edgeRendering/EdgeView","./edgeRendering/interfaces","../materials/renderers/MergedRenderer","../shaders/CompositingTechniqueConfiguration","../statistics/RendererPerformanceInfo","../../../support/RenderState","../../../webgl/enums"],(function(e,r,t,n,a,s,i,o,d,h,l,c,_,u,p,f,m,g,T,R,y,S,b,P,E,A,O,C,w,D,I,x,H,M,v,L,N,F,U,G,k,B,q,V,W,Q,j,Y,X){"use strict";var z;e.Renderer=function(t){r._inheritsLoose(l,t);var n=l.prototype;function l(e,r,n,a,i,o,l,c){var _;return(_=t.call(this,{})||this)._stage=e,_._materialRepository=r,_._shaderTechniqueRepository=a,_._rctx=i,_._compositingHelper=o,_._magnifierHelper=l,_._requestRender=c,_._materialRenderers=new d,_._needsTransparentPass=!1,_._hasHUDElements=!1,_._hasHighlights=!1,_._hasWater=!1,_._hasOverlayWater=!1,_._renderOverlay=e=>{},_._isRendering=!1,_._fallbackDepthStencilTexture=null,_._sliceHelper=new U,_._state=Y.RenderState.IDLE,_._renderStateFeatures=H.setupFeatureDefaults(),_._antialiasingEnabled=!0,_._highQualityTransparencyEnabled=!0,_._terrainRenderingEnabled=!0,_._terrainTransparency=g.TransparencyMode.Opaque,_._waterReflectionEnabled=!1,_._ssaoEnabled=!1,_._hasAnimations=!1,_._animationTimestep=new S.AnimationTimeStep,_._handles=new s,_._renderHiddenTransparentEdges=()=>{},_._oitUsed=!1,_._smaaPass=new G.SmaaRenderPass(_._rctx,a),c(),_._offscreen=new D.OffscreenRendering(_._rctx,_._compositingHelper),_.performanceInfo=new j.RendererPerformanceInfo(_._rctx),_._shadowMap=new F.ShadowMap(_._rctx,e.viewingMode),_._ssaoHelper=new k.SSAOHelper(e.view,a,_._rctx,c),_._highlight=new C.Highlight(a,_._rctx),_._shadowHighlight=new N.ShadowHighlight(_._rctx,e.viewingMode),_._shadowAccumulator=new L.ShadowAccumulator(_._rctx,a,e,(e=>{const r=_.shadowsEnabled;_._shadowMap.enabled=!0,_._prepare(e.camera,e.contentCamera),_._renderPlugins.prepareRender(),_._shadowMap.enabled=r}),((e,r,t)=>{e.shadowMap.start(e.camera,r,t),_._renderShadowCascades(R.ShaderOutput.Shadow,e.shadowMap),e.camera.setGLViewport(_._rctx),_._prepare(e.camera,e.contentCamera)}),c),_._renderContext=new I.RenderContext(_._rctx,_._offscreen,_._shadowMap,_._ssaoHelper,_._sliceHelper),_._renderPlugins=new M.RenderPluginManager({renderContext:_._renderContext,techniqueRepository:a,textureRepository:n,materialRepository:_._materialRepository,requestRender:c,controller:e}),_.renderPassManager=new T.RenderPassManager(_._rctx,_._shaderTechniqueRepository),_._renderPlugins.add(_.renderPassManager.slots(),_.renderPassManager),_._handles.add([h.watch((()=>_._stage.view.state.camera),(()=>c()),h.syncAndInitial),h.watch((()=>m.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES),(e=>{_._renderHiddenTransparentEdges=e?()=>_._renderEdges(V.Transparency.TRANSPARENT):()=>{},c()}),h.initial),h.watch((()=>_._ssaoEnabled||_.isFeatureEnabled(H.RenderFeature.SSAO)),(e=>_._ssaoHelper.enabled=e),h.syncAndInitial)]),_}return n.isFeatureEnabled=function(e,r=this._state){return o.unwrapOr(this._renderStateFeatures.get(r,e),!1)},n.setFeatureEnabled=function(e,r,t){this._renderStateFeatures.set(r,e,t),this.notifyChange("_renderStateFeatures"),this._requestRender()},n.normalizeCtorArgs=function(){return{}},n.destroy=function(){this._handles.destroy(),this._smaaPass.dispose(),this._gpuTimerHandle=o.removeMaybe(this._gpuTimerHandle),this._materialRenderers.forAll((e=>e.dispose())),this._materialRenderers.clear(),this._offscreen.dispose(),this._fallbackDepthStencilTexture=o.disposeMaybe(this._fallbackDepthStencilTexture),this._shadowMap.dispose(),this._ssaoHelper.dispose(),this._highlight.dispose(),this._shadowHighlight.dispose(),this._shadowAccumulator.dispose(),P.BoundingInfo.prune()},n.disposeOffscreenBuffers=function(){this._offscreen.dispose(),this._shadowMap.disposeOffscreenBuffers(),this._smaaPass.disable(),this._ssaoHelper.disposeOffscreenBuffers()},n.ensureEdgeView=function(){return o.isNone(this._edgeView)&&(this._edgeView=new q.EdgeView({rctx:this._rctx,renderSR:this._stage.view.renderSpatialReference,viewingMode:this._stage.viewingMode,techniqueRepository:this._shaderTechniqueRepository,setNeedsRender:()=>this._requestRender(),schedule:e=>this._stage.view.resourceController.immediate.schedule(e)}),this._handles.add(h.watch((()=>o.applySome(this._edgeView,(e=>e.updating))),(()=>this._requestRender()),h.sync)),this._requestRender()),this._edgeView},n.setParameters=function(e){const{_shadowMap:r,_bindParameters:t}=this;if(void 0!==e.screenSpaceReflectionsEnabled&&t.ssr.enabled!==e.screenSpaceReflectionsEnabled&&(t.ssr.enabled=e.screenSpaceReflectionsEnabled,this._requestRender()),void 0!==e.shadowMap&&this._shadowMap.enabled!==e.shadowMap&&(this._shadowMap.enabled=e.shadowMap,this._requestRender()),void 0!==e.shadowMapMaxCascades&&r.maxCascades!==e.shadowMapMaxCascades&&(r.maxCascades=e.shadowMapMaxCascades,this._requestRender()),o.isSome(e.environment)){o.isSome(e.environment.weather)&&(this._bindParameters.weather=e.environment.weather,this._bindParameters.weatherVisible=!!e.weatherVisible),void 0!==e.environment.lighting.ambientOcclusionEnabled&&this._ssaoEnabled!==e.environment.lighting.ambientOcclusionEnabled&&(this._ssaoEnabled=e.environment.lighting.ambientOcclusionEnabled,this._requestRender()),void 0!==e.environment.lighting.waterReflectionEnabled&&this._waterReflectionEnabled!==e.environment.lighting.waterReflectionEnabled&&(this._waterReflectionEnabled=e.environment.lighting.waterReflectionEnabled,this._requestRender());const r="virtual"!==e.environment.lighting.type;t.enableFillLights!==r&&(t.enableFillLights=r,this._requestRender())}e.background&&this._offscreen.background!==e.background&&(this._offscreen.background=e.background,this._requestRender()),void 0!==e.antialiasingEnabled&&this._antialiasingEnabled!==e.antialiasingEnabled&&(this._antialiasingEnabled=e.antialiasingEnabled,this._requestRender()),void 0!==e.highQualityTransparency&&this._highQualityTransparencyEnabled!==e.highQualityTransparency&&(this._highQualityTransparencyEnabled=e.highQualityTransparency,this._requestRender()),void 0!==e.defaultHighlightOptions&&(this._highlight.setDefaultOptions(e.defaultHighlightOptions),this._shadowHighlight.setDefaultOptions(e.defaultHighlightOptions),this._requestRender()),void 0!==e.overlays&&this._bindParameters.overlays!==e.overlays&&(this._bindParameters.overlays=e.overlays,this._requestRender()),void 0!==e.hasOverlayWater&&this._hasOverlayWater!==e.hasOverlayWater&&(this._hasOverlayWater=e.hasOverlayWater,this._requestRender()),void 0!==e.renderOverlay&&this._renderOverlay!==e.renderOverlay&&(this._renderOverlay=e.renderOverlay,this._requestRender()),void 0!==e.slicePlane&&this._sliceHelper.plane!==e.slicePlane&&(this._sliceHelper.plane=o.unwrap(e.slicePlane),this._requestRender()),void 0!==e.terrainRenderingEnabled&&this._terrainRenderingEnabled!==e.terrainRenderingEnabled&&(this._terrainRenderingEnabled=e.terrainRenderingEnabled,this._requestRender()),void 0!==e.terrainTransparency&&this._terrainTransparency!==e.terrainTransparency&&(this._terrainTransparency=e.terrainTransparency,this._requestRender()),void 0!==e.shadowCastOptions&&this._shadowAccumulator.setOptions(e.shadowCastOptions)},n.modify=function(e,r){this._isRendering&&console.warn("Renderer.modify called while rendering");const{adds:t,removes:n,updates:a}=e;if(0===t.length&&0===n.length&&0===a.length)return;const s=x.splitRenderGeometryChangeSetByMaterial(e);let i=!1;s.forEach(((t,n)=>{if(r.done)return;let a=this._materialRenderers.find((e=>e.material===n));o.isNone(a)&&t.adds.length>0&&(a=new W.MergedRenderer(this._rctx,this._materialRepository,n),this._materialRenderers.push(a)),a&&(a.modify(t),a.isEmpty&&(i=!0)),t.removes.forEach((r=>e.removes.removeUnordered(r))),t.adds.forEach((r=>e.adds.removeUnordered(r))),t.updates.forEach((r=>e.updates.removeUnordered(r))),r.madeProgress()})),i&&this._materialRenderers.filterInPlace((e=>!e.isEmpty||(e.dispose(),!1))),this._hasHighlights=this._materialRenderers.some((e=>e.hasHighlights)),this._bindParameters.hasOccludees=this._materialRenderers.some((e=>e.hasOccludees)),this._hasWater=this._materialRenderers.some((e=>e.hasWater)),this._hasHUDElements=this._materialRenderers.some((e=>e.requiresSlot(v.RenderSlot.LINE_CALLOUTS_HUD_DEPTH,R.ShaderOutput.Color)||e.requiresSlot(v.RenderSlot.HUD_MATERIAL,R.ShaderOutput.Color)||e.requiresSlot(v.RenderSlot.LABEL_MATERIAL,R.ShaderOutput.Color))),this._requestRender()},n.updateAnimation=function(e){const r=this._hasAnimations;return this._hasAnimations=!1,this._materialRenderers.forAll((r=>this._hasAnimations=r.updateAnimation(e)||this._hasAnimations)),this._hasAnimations=this._renderPlugins.updateAnimation(e)||this._hasAnimations,this._hasAnimations!==r&&(this._gpuTimerHandle=r?o.removeMaybe(this._gpuTimerHandle):this.performanceInfo.enableGPUPerformanceInfo()),this._hasAnimations},n.resetAnimation=function(){this._animationTimestep.clear()},n.render=function(e,r,t,n,a){this._isRendering=!0,this.performanceInfo.startFrame();const{camera:s,contentCamera:i,mode:d}=t;this._state=d,this._renderOverlay(a),this.performanceInfo.advance(j.PerformanceCategory.OVERLAY),this._renderContext.time=a,this._bindParameters.transparencyPassType=B.TransparencyPassType.NONE;const h=this._offscreen;h.setupRenderTarget(this.hasWaterReflection);const l=f.create(this._sliceHelper.plane);n===b.Decorations.OFF&&(this._sliceHelper.plane=null),this._rctx.bindFramebuffer(e),s.setGLViewport(this._rctx),this._prepare(s,i),this._renderPlugins.prepareRender(),this.performanceInfo.advance(j.PerformanceCategory.PREPARE);const c=this._computeDepthRange(s);this._renderShadowMap(e,s,this._bindParameters.lighting.mainLight.direction,c),this.performanceInfo.advance(j.PerformanceCategory.SHADOW_MAP),h.initializeFrame(s),this._ensureBindParameters(s,i),this._renderLinearDepth(),this.performanceInfo.advance(j.PerformanceCategory.LINEAR_DEPTH),this._accumulateShadows(c,s,i),this.performanceInfo.advance(j.PerformanceCategory.ACCUMULATED_SHADOWS),this._renderNormal(),this.performanceInfo.advance(j.PerformanceCategory.NORMALS),this._ensureBindParametersSSR(a),this._renderSSAO(a),this.performanceInfo.advance(j.PerformanceCategory.SSAO),this._renderContext.output=R.ShaderOutput.Color,h.bindFramebuffer(),this._renderOpaqueGeometry(),this.performanceInfo.advance(j.PerformanceCategory.OPAQUE);const _=this._terrainRenderingEnabled&&(this._terrainTransparency===g.TransparencyMode.Semitransparent||this._terrainTransparency===g.TransparencyMode.TransparentWithDraped),u=this._highQualityTransparency&&_;this._renderTerrainLinearDepth(u),this._setMultipassEnabled(u),this._setTerrainCulling(u),this._renderEdges(V.Transparency.OPAQUE),this.performanceInfo.advance(j.PerformanceCategory.OPAQUE_EDGES),this._offscreen.bindTarget(this._offscreen.currentColorTarget,this._offscreen.mainDepth),this._renderSlot(v.RenderSlot.VOXEL),this.performanceInfo.advance(j.PerformanceCategory.VOXEL),this._renderHiddenTransparentEdges();const p=this._needsTransparentPass||this._renderPlugins.needsTransparentPass;p&&(this._oitEnabled?this._renderOrderIndependentTransparency((()=>this._renderTransparentGeometry()),!1):this._renderTransparentGeometry()),this.performanceInfo.advance(j.PerformanceCategory.TRANSPARENT),this._renderGeometryLinearDepth(u);const m=this._renderHUDVisibility(u);u||this._renderInternalSlot(v.RenderSlot.LINE_CALLOUTS),this.performanceInfo.advance(j.PerformanceCategory.HUD_VISIBILITY),this._renderObjectAndLayerIdColor(r),this.performanceInfo.advance(j.PerformanceCategory.OBJECT_AND_LAYER_ID_COLOR),this._renderEdges(V.Transparency.TRANSPARENT,u),this.performanceInfo.advance(j.PerformanceCategory.TRANSPARENT_EDGES),this._renderTransparentTerrain(),_&&m&&(u?this._renderLineCallouts(y.HUDTransparentRenderStyle.Occluded):h.compositeTransparentTerrainOntoHUDVisibility(this._bindParameters),this._renderHUD(y.HUDTransparentRenderStyle.Occluded,h.framebuffer),this.performanceInfo.advance(j.PerformanceCategory.HUD_OCCLUDED)),this.performanceInfo.advance(j.PerformanceCategory.TRANSPARENT_TERRAIN),this._setTerrainCulling(!1),_&&(h.compositeTransparentTerrainOntoMain(this._bindParameters),u&&(this._renderEdges(V.Transparency.OPAQUE),this.performanceInfo.advance(j.PerformanceCategory.OPAQUE_EDGES),p&&(this._oitEnabled?this._renderOrderIndependentTransparency((()=>this._renderTransparentGeometry()),!1):this._renderTransparentGeometry()),this.performanceInfo.advance(j.PerformanceCategory.TRANSPARENT),this._renderEdges(V.Transparency.TRANSPARENT),this.performanceInfo.advance(j.PerformanceCategory.TRANSPARENT_EDGES))),u&&this._renderLineCallouts(y.HUDTransparentRenderStyle.NotOccluded),this._setMultipassEnabled(!1),this._shadowAccumulator.render(this._bindParameters),h.renderToTargets((()=>{this._renderInternalSlot(v.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),this._renderSlot(v.RenderSlot.POSTPROCESSING_ENVIRONMENT_TRANSPARENT),this._renderSlot(v.RenderSlot.LASERLINES)}),h.currentColorTarget,h.mainDepth),this.performanceInfo.advance(j.PerformanceCategory.ENVIRONMENT),this._renderPlugins.needsLaserlineWithContrastControl&&h.renderTmpAndCompositeToMain((()=>this._renderSlot(v.RenderSlot.LASERLINES_CONTRAST_CONTROL)),this._bindParameters,Q.AlphaMode.PremultipliedAlpha),this.performanceInfo.advance(j.PerformanceCategory.LASER_LINE),this._renderOccluded(),this.performanceInfo.advance(j.PerformanceCategory.OCCLUDED);const T=n===b.Decorations.ON&&this._magnifierHelper.enabled,S=T&&o.isNone(e)?this._offscreen.getFramebuffer(this._offscreen.tmpColor,this._offscreen.tmpDepth):e;this._rctx.bindFramebuffer(S);const P=this._offscreen.colorTexture;!this._renderAntiAliasing(P)&&o.isSome(P)&&this._compositingHelper.composite(this._bindParameters,P,Q.AlphaMode.None),this.performanceInfo.advance(j.PerformanceCategory.ANTIALIASING),this._renderHUD(y.HUDTransparentRenderStyle.NotOccluded,S),this.performanceInfo.advance(j.PerformanceCategory.HUD),this._renderHighlights(S,this._bindParameters),this.performanceInfo.advance(j.PerformanceCategory.HIGHLIGHTS),T&&this._magnifierHelper.render(this._rctx,this._bindParameters),S!==e&&(this._rctx.bindFramebuffer(e),this._compositingHelper.composite(this._bindParameters,this._offscreen.tmpColorTexture,Q.AlphaMode.None)),this._disposeOITBuffers(),this._renderContext.lastFrameCamera.copyFrom(this._bindParameters.camera),this._sliceHelper.plane=l,this._isRendering=!1,this.onPostRender&&this.onPostRender(),this.performanceInfo.finishFrame()},n._renderObjectAndLayerIdColor=function(e){if(o.isSome(e)&&i("enable-feature:objectAndLayerId-rendering")){const r=this._renderContext.output;this._rctx.bindFramebuffer(e),this._offscreen.renderToFBO((()=>this._renderGeometryAndTransparentTerrainPass(R.ShaderOutput.ObjectAndLayerIdColor)),[0,0,0,0],!0,!0),this._rctx.bindFramebuffer(e),this._offscreen.renderToFBO((()=>{this._bindParameters.renderTransparentlyOccludedHUD=y.HUDTransparentRenderStyle.NotOccluded,this._renderInternalSlot(v.RenderSlot.HUD_MATERIAL)}),void 0,!0,!0),this._renderContext.output=r}},n.finish=function(e){this._hasAnimations||this._animationTimestep.clear();const r=this.performanceInfo.gpuSamplingEnabled,t=e===b.RenderRequestType.BACKGROUND;if(t||r){const e=t?this.performanceInfo.elapsedTime:0,n=r?this.performanceInfo.totalGPUTimeSampler.last:this._rctx.gl.getError(),a=Math.max(e,n);this._animationTimestep.frame(a,t)}},n.readDepthPixels=function(e,r,t){const n=this._offscreen.bindTarget(this._offscreen.linearDepth,this._offscreen.tmpDepth);if(!this._needsLinearDepth){this._ensureBindParameters(e,e),this._bindParameters.camera.setGLViewport(this._rctx),this._rctx.setClearColor(0,0,0,0);const r=X.ClearBufferBit.COLOR_BUFFER_BIT|X.ClearBufferBit.DEPTH_BUFFER_BIT|X.ClearBufferBit.STENCIL_BUFFER_BIT;this._rctx.clearSafe(r),this._renderGeometryAndTransparentTerrainPass(R.ShaderOutput.Depth)}n.readPixels(r[0],r[1],r[2],r[3],X.PixelFormat.RGBA,X.PixelType.UNSIGNED_BYTE,t)},n.readHUDVisibility=function(e,r,t,n,a){this._offscreen.bindTarget(this._offscreen.hudVisibility).readPixels(e,r,t,n,X.PixelFormat.RGBA,X.PixelType.UNSIGNED_BYTE,a)},n.readAccumulatedShadow=function(e){return this._shadowAccumulator.readAccumulatedShadow(e[0],e[1])},n._setMultipassEnabled=function(e){this._bindParameters.multipassTerrain.enabled=this._bindParameters.multipassGeometry.enabled=e},n._setTerrainCulling=function(e){this._bindParameters.multipassTerrain.cullAboveGround=e},n._renderSlot=function(e){this._bindParameters.slot=e,this._renderPlugins.render()},n._renderEdges=function(e,r=!1){const t=this._edgeView;o.isSome(t)&&t.shouldRender()&&this._offscreen.renderTmpAndCompositeToMain((()=>t.render(this._bindParameters,e)),this._bindParameters,Q.AlphaMode.Alpha,r)},n._renderShadowMap=function(e,r,t,n){const a=this._shadowMap;a.enabled&&this.isFeatureEnabled(H.RenderFeature.ShadowMapUpdate)&&(a.start(r,t,n),this._shadowHighlight.updateParameters(r,t),this._needsShadowHighlight?(this._renderShadowCascades(R.ShaderOutput.ShadowHighlight,this._shadowMap,(e=>a.takeCascadeSnapshotTo(e,F.SnapshotSlot.Highlight))),a.clear(),this._renderShadowCascades(R.ShaderOutput.ShadowExcludeHighlight,this._shadowMap,(e=>{a.takeCascadeSnapshotTo(e,F.SnapshotSlot.Default),this._renderGeometryAndTransparentTerrainPass(R.ShaderOutput.ShadowHighlight)}))):this._renderShadowCascades(R.ShaderOutput.Shadow),a.finish(e),r.setGLViewport(this._rctx))},n._renderShadowCascades=function(e,r=this._shadowMap,t=(e=>{})){for(const n of r.cascades)n.camera.setGLViewport(this._rctx),this._prepare(n.camera,n.camera),this._renderGeometryAndTransparentTerrainPass(e),t(n)},n._renderLinearDepth=function(){this._needsLinearDepth?this._offscreen.renderToTargets((()=>this._renderGeometryAndTransparentTerrainPass(R.ShaderOutput.Depth)),this._offscreen.linearDepth,this._offscreen.tmpDepth,[0,0,0,0],!0,!0):this._offscreen.disposeTarget(this._offscreen.linearDepth),this._bindParameters.linearDepthTexture=this._offscreen.linearDepthTexture},n._renderTerrainLinearDepth=function(e){if(e){const e=this._renderContext.output;this._renderContext.output=R.ShaderOutput.Depth,this._offscreen.renderToTargets((()=>this._renderTransparentTerrain()),this._offscreen.terrainLinearDepth,this._offscreen.tmpDepth,[-1e10,-1e10,-1e10,1],!0,!0),this._renderContext.output=e}else this._offscreen.disposeTarget(this._offscreen.terrainLinearDepth);this._bindParameters.multipassTerrain.linearDepthTexture=this._offscreen.terrainLinearDepthTexture},n._renderGeometryLinearDepth=function(e){if(e){const e=this._renderContext.output;this._offscreen.renderToTargets((()=>this._renderGeometryPass(R.ShaderOutput.Depth)),this._offscreen.geometryLinearDepth,this._offscreen.tmpDepth,[1,1,1,1],!0,!0),this._renderContext.output=e}else this._offscreen.disposeTarget(this._offscreen.geometryLinearDepth);this._bindParameters.multipassGeometry.linearDepthTexture=this._offscreen.geometryLinearDepthTexture},n._renderNormal=function(){this._needsNormal?this._offscreen.renderToTargets((()=>{this._renderGeometryAndTransparentTerrainPass(R.ShaderOutput.Normal)}),this._offscreen.normal,this._offscreen.tmpDepth,[0,0,0,0],!0,!0):this._offscreen.disposeTarget(this._offscreen.normal)},n._computeDepthRange=function(e){if(!this._needsDepthRange)return E.ZERO;const r=A.depthRangeFromScene(e,this._materialRenderers,this._stage.layers);return E.union(r,this.renderPlugins.queryDepthRange(e)),r.near=Math.max(e.near,r.near),r.far=Math.min(e.far,r.far),r},n._renderGeometryAndTransparentTerrainPass=function(e){this._renderContext.output=e,this._renderGeometryPass(e),this._renderTransparentTerrain()},n._renderGeometryPass=function(e){this._renderContext.output=e,this._renderOpaqueGeometry(),this._renderTransparentGeometry()},n._renderSSAO=function(e){this._ssaoHelper.render(this._bindParameters,e,this._offscreen.linearDepthTexture,this._offscreen.normalTexture)},n._renderOpaqueGeometry=function(){this._renderSlot(v.RenderSlot.INTEGRATED_MESH),this._renderSlot(v.RenderSlot.OPAQUE_TERRAIN),this._renderInternalSlot(v.RenderSlot.OPAQUE_MATERIAL),this._renderSlot(v.RenderSlot.OPAQUE_MATERIAL),this._renderSlot(v.RenderSlot.POSTPROCESSING_ENVIRONMENT_OPAQUE)},n._renderTransparentGeometry=function(){this._renderInternalSlot(v.RenderSlot.TRANSPARENT_MATERIAL),this._renderSlot(v.RenderSlot.TRANSPARENT_MATERIAL)},n._renderTransparentTerrain=function(){this._renderSlot(v.RenderSlot.TRANSPARENT_TERRAIN)},n._renderHUDVisibility=function(e){let r=!1;return this._renderContext.offscreenRenderingHelper&&this._renderContext.offscreenRenderingHelper.renderHUDVisibility((()=>{this._bindParameters.hudVisibilityTexture=this._renderContext.offscreenRenderingHelper.hudVisibilityTexture,r=this._renderInternalSlot(v.RenderSlot.OCCLUSION_PIXELS)}),e),r},n._renderLineCallouts=function(e){this._bindParameters.renderTransparentlyOccludedHUD=e,e===y.HUDTransparentRenderStyle.Occluded?this._offscreen.renderToTargets((()=>this._renderInternalSlot(v.RenderSlot.LINE_CALLOUTS)),this._offscreen.currentColorTarget,this._offscreen.tmpDepth,void 0,!0,!0):this._renderInternalSlot(v.RenderSlot.LINE_CALLOUTS)},n._renderHUD=function(e,r){this._hasHUDElements&&(this._oitEnabled?(this._renderOrderIndependentTransparency((()=>this._renderHUDElements(e)),!0),this._rctx.bindFramebuffer(r),this._compositingHelper.composite(this._bindParameters,this._offscreen.hudColorTexture,Q.AlphaMode.PremultipliedAlpha)):e===y.HUDTransparentRenderStyle.Occluded?this._offscreen.renderToTargets((()=>this._renderHUDElements(y.HUDTransparentRenderStyle.Occluded)),this._offscreen.currentColorTarget,this._offscreen.tmpDepth,void 0,!0,!0):this._renderHUDElements(e))},n._renderHUDElements=function(e){this._bindParameters.renderTransparentlyOccludedHUD=e,this._renderInternalSlot(v.RenderSlot.LINE_CALLOUTS_HUD_DEPTH),this._renderInternalSlot(v.RenderSlot.HUD_MATERIAL),this._renderInternalSlot(v.RenderSlot.LABEL_MATERIAL)},n._renderHighlights=function(e,r){if(!this._needsHighlight)return void this._offscreen.disposeTarget(this._offscreen.highlight);const t=this._highlight,n=this._offscreen.renderToTargets((()=>{this._renderGeometryAndTransparentTerrainPass(R.ShaderOutput.Highlight),this._rctx.clearSafe(X.ClearBufferBit.DEPTH_BUFFER_BIT),this._renderHUDElements(y.HUDTransparentRenderStyle.Both)}),this._offscreen.highlight,this._offscreen.tmpDepth,[0,0,0,0],!0,!0);this._bindParameters.highlightColorTexture=n.colorTexture,this._needsShadowHighlight&&this._shadowHighlight.render(r,e),t.render(this._bindParameters,n,e)},n._accumulateShadows=function(e,r,t){this._needsShadowCast&&o.isSome(this._offscreen.linearDepthTexture)&&this._shadowAccumulator.renderAccumulation(this._offscreen.linearDepthTexture,e,r,t)},n._renderOrderIndependentTransparency=function(e,r){const t=t=>{this._bindParameters.transparencyPassType=t,this._offscreen.renderOITPass((()=>e()),t,r)},n=this._renderContext.output;this._renderContext.output=R.ShaderOutput.Alpha,t(B.TransparencyPassType.Alpha),this._renderContext.output=R.ShaderOutput.Color,t(B.TransparencyPassType.Color),t(B.TransparencyPassType.FrontFace),this._offscreen.compositeTransparentOntoOpaque(this._bindParameters,r),this._bindParameters.transparencyPassType=B.TransparencyPassType.NONE,this._renderContext.output=n,this._oitUsed=!0},n._disposeOITBuffers=function(){this._oitUsed||(this._offscreen.disposeTarget(this._offscreen.alphaFloatTarget),this._offscreen.disposeTarget(this._offscreen.colorFloatTarget),this._offscreen.disposeTarget(this._offscreen.frontFaceTarget)),this._oitUsed=!1},n._renderOccluded=function(){let e=0;J.clear(),this._materialRenderers.forAll((r=>{r.material&&r.material.isVisible()&&r.material.renderOccluded===w.RenderOccludedFlag.OccludeAndTransparentStencil&&(e|=r.material.renderOccluded,J.push(r))}));const r=this._offscreen,t=(t,n,a,s,i)=>{0!=(e&n)&&(r.renderToTargets(a,r.tmpColor,r.mainDepth,[0,0,0,0],s,i),r.compositeOccludedOntoMain(this._bindParameters,t))};0!==J.length&&(this._renderInternalSlot(v.RenderSlot.OCCLUDER_MATERIAL,J),t(.5,w.RenderOccludedFlag.OccludeAndTransparentStencil,(()=>this._renderInternalSlot(v.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL,J)),!1,!1)),J.clear(),this._materialRenderers.forAll((r=>{r.material&&r.material.isVisible()&&(r.material.renderOccluded===w.RenderOccludedFlag.OccludeAndTransparent||r.material.renderOccluded===w.RenderOccludedFlag.Transparent||r.material.renderOccluded===w.RenderOccludedFlag.Opaque)&&(e|=r.material.renderOccluded,J.push(r))}));const n=this._renderPlugins.renderOccludedFlags;if(e|=n,!e)return;const a=e=>{this._renderContext.renderOccludedMask=e,n>w.RenderOccludedFlag.Occlude&&this._renderSlot(v.RenderSlot.OCCLUDED_TERRAIN),this._renderInternalSlot(v.RenderSlot.OPAQUE_MATERIAL,J),this._renderInternalSlot(v.RenderSlot.TRANSPARENT_MATERIAL,J),this._renderInternalSlot(v.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,J),this._renderContext.resetRenderOccludedMask()};this._renderContext.output=R.ShaderOutput.Color,t(.5,w.RenderOccludedFlag.OccludeAndTransparent,(()=>a(w.RenderOccludedFlag.OccludeAndTransparent)),!0,b.StencilBits.OutlineVisualElementMask),t(.5,w.RenderOccludedFlag.Transparent,(()=>a(w.RenderOccludedFlag.Transparent)),!0,b.StencilBits.OutlineVisualElementMask),t(1,w.RenderOccludedFlag.Opaque,(()=>a(w.RenderOccludedFlag.Opaque)),!0,b.StencilBits.OutlineVisualElementMask),J.clear()},n._renderAntiAliasing=function(e){if(this._antialiasing){if(this._smaaPass.enable((()=>this._requestRender()))&&o.isSome(e))return this._smaaPass.render(e),!0}else this._smaaPass.disable();return!1},n._prepare=function(e,r){this._needsTransparentPass=this._materialRenderers.some((e=>e.requiresSlot(v.RenderSlot.TRANSPARENT_MATERIAL,R.ShaderOutput.Color))),this._bindParameters.camera=e,this._bindParameters.contentCamera=r},n._ensureBindParameters=function(e,r){this._bindParameters.camera=e,this._bindParameters.contentCamera=r;const t=this._renderContext.offscreenRenderingHelper;this._bindParameters.hudVisibilityTexture=t.hudVisibilityTexture,this._bindParameters.mainColorTexture=t.mainColorTexture,this._bindParameters.highlightDepthTexture=t.depthTexture??this._getFallbackDepthTexture()},n._ensureBindParametersSSR=function(e){if(this._bindParameters.ssr.enabled=this.hasWaterReflection,this._bindParameters.ssr.enabled){o.isNone(this._waterReflectionEnableTime)&&(this._waterReflectionEnableTime=e),this._renderContext.lastFrameCamera.equals(this._bindParameters.camera)?this._reprojectionMatrix=p.IDENTITY:(u.invert(Z,this._bindParameters.camera.viewMatrix),u.invert(K,this._bindParameters.camera.projectionMatrix),u.multiply($,Z,K),u.multiply($,this._renderContext.lastFrameCamera.viewMatrix,$),u.multiply($,this._renderContext.lastFrameCamera.projectionMatrix,$),this._reprojectionMatrix=$),this._bindParameters.ssr.lastFrameColorTexture=this._offscreen.lastFrameColorTexture;const r=this._stage.view.qualitySettings.fadeDuration;this._bindParameters.ssr.fadeFactor=r>0?Math.min(r,e-this._waterReflectionEnableTime)/r:1,this._bindParameters.ssr.fadeFactor<1&&this._requestRender()}else this._bindParameters.ssr.lastFrameColorTexture=null,this._waterReflectionEnableTime=null},n._renderInternalSlot=function(e,r=this._materialRenderers){let t=!1;return this._bindParameters.slot=e,r.forAll((e=>{e.material.shouldRender(this._renderContext)&&e.render(this._renderContext.output,this._bindParameters)&&(t=!0)})),t},n._getFallbackDepthTexture=function(){return this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=O.createEmptyDepthTexture(this._rctx)),this._fallbackDepthStencilTexture},r._createClass(l,[{key:"_bindParameters",get:function(){return this._renderContext.bindParameters}},{key:"_antialiasing",get:function(){return this._antialiasingEnabled||this.isFeatureEnabled(H.RenderFeature.Antialiasing)}},{key:"_highQualityTransparency",get:function(){return this._highQualityTransparencyEnabled||this.isFeatureEnabled(H.RenderFeature.HighQualityTransparency)}},{key:"hasWaterReflection",get:function(){return this.hasWater&&(this._waterReflectionEnabled||this.isFeatureEnabled(H.RenderFeature.WaterReflection))}},{key:"hasWater",get:function(){return this._hasWater||this._hasOverlayWater}},{key:"updating",get:function(){return this._antialiasing&&this._smaaPass.updating||o.isSome(this._edgeView)&&this._edgeView.updating||this._shadowAccumulator.running||!this.isCameraFinal}},{key:"edgeView",get:function(){return this._edgeView}},{key:"isCameraFinal",get:function(){return u.equals(this._bindParameters.ssr.reprojectionMatrix,p.IDENTITY)}},{key:"_reprojectionMatrix",set:function(e){a.update(this._bindParameters.ssr.reprojectionMatrix,e)&&this.notifyChange("isCameraFinal")}},{key:"shadowsEnabled",get:function(){return!!this._shadowMap?.enabled}},{key:"hasSlicePlane",get:function(){return!!this._sliceHelper.plane}},{key:"renderPlugins",get:function(){return this._renderPlugins}},{key:"_hasOITSupport",get:function(){return this._rctx.driverTest.floatBufferBlend.result}},{key:"_oitEnabled",get:function(){return this._highQualityTransparency&&this._hasOITSupport}},{key:"animationTimestep",get:function(){return this._animationTimestep.value}},{key:"animationTimeDilation",get:function(){return this._animationTimestep.timeDilation}},{key:"_needsLinearDepth",get:function(){return this._ssaoHelper.active||this._renderPlugins.needsLinearDepth||this.hasWaterReflection||this._needsShadowHighlight||this._needsShadowCast}},{key:"_needsNormal",get:function(){return this._ssaoHelper.active}},{key:"_needsDepthRange",get:function(){return this._shadowMap.enabled||this._needsShadowCast}},{key:"_needsHighlight",get:function(){return this._hasHighlights||this._renderPlugins.needsHighlight}},{key:"_needsShadowHighlight",get:function(){return this._shadowMap.enabled&&this._shadowHighlight.isVisible&&this._needsHighlight}},{key:"_needsShadowCast",get:function(){return this._shadowAccumulator.isAccumulating}},{key:"gpuMemoryUsage",get:function(){return{offscreen:this._offscreen?.gpuMemoryUsage??0,highlights:(this._highlight?.gpuMemoryUsage??0)+(this._shadowHighlight?.gpuMemoryUsage??0),shadows:this._shadowMap?.gpuMemoryUsage??0,ssao:this._ssaoHelper?.gpuMemoryUsage??0}}},{key:"test",get:function(){const r=this;return{offscreen:this._offscreen,shadowMap:this._shadowMap,ssao:this._ssaoHelper,highlight:this._highlight,lighting:this._bindParameters.lighting,materialRenderers:this._materialRenderers,shadowAccumulator:this._shadowAccumulator,weatherIsFading:this._bindParameters.cloudsFade.isFading,resetRenderStateFeatures:()=>{r._renderStateFeatures=H.setupFeatureDefaults()},getFramebufferTexture:t=>{switch(t){case e.FramebufferId.Color:return r._offscreen.colorTexture;case e.FramebufferId.LinearDepth:return r._offscreen.linearDepthTexture;case e.FramebufferId.Normals:return r._offscreen.normalTexture;case e.FramebufferId.ShadowMap:return r._shadowMap.depthTexture;case e.FramebufferId.HudVisibility:return r._offscreen.hudVisibilityTexture;case e.FramebufferId.Highlight:return r._offscreen.highlightTexture}}}}}]),l}(n),t.__decorate([l.property()],e.Renderer.prototype,"_shadowAccumulator",void 0),t.__decorate([l.property()],e.Renderer.prototype,"_state",void 0),t.__decorate([l.property()],e.Renderer.prototype,"_renderStateFeatures",void 0),t.__decorate([l.property()],e.Renderer.prototype,"_antialiasingEnabled",void 0),t.__decorate([l.property({readOnly:!0})],e.Renderer.prototype,"_antialiasing",null),t.__decorate([l.property()],e.Renderer.prototype,"_ssaoEnabled",void 0),t.__decorate([l.property()],e.Renderer.prototype,"_smaaPass",void 0),t.__decorate([l.property({autoDestroy:!0})],e.Renderer.prototype,"_edgeView",void 0),t.__decorate([l.property()],e.Renderer.prototype,"updating",null),t.__decorate([l.property()],e.Renderer.prototype,"isCameraFinal",null),e.Renderer=t.__decorate([_.subclass("esri.views.3d.webgl-engine.lib.Renderer")],e.Renderer),e.FramebufferId=void 0,(z=e.FramebufferId||(e.FramebufferId={}))[z.Color=0]="Color",z[z.LinearDepth=1]="LinearDepth",z[z.Normals=2]="Normals",z[z.ShadowMap=3]="ShadowMap",z[z.HudVisibility=4]="HudVisibility",z[z.Highlight=5]="Highlight";const J=new d,K=p.create(),Z=p.create(),$=p.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
