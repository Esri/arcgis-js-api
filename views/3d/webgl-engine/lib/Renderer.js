/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/arrayUtils","../../../../core/Handles","../../../../core/has","../../../../core/MapUtils","../../../../core/mathUtils","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/time","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/boundedPlane","../../support/animationUtils","../../support/debugFlags","../../terrain/TerrainRenderer","../core/renderPasses/RenderPassManager","../core/shaderLibrary/ShaderOutput","../core/shaderLibrary/hud/HUDUniforms","./basicInterfaces","./BoundingInfo","./depthRange","./depthRangeUtils","./glUtil3D","./Highlight","./Material","./OffscreenRendering","./RenderContext","./rendererUtils","./RenderPluginManager","./RenderSlot","./ShadowAccumulator","./ShadowHighlight","./ShadowMap","./SliceHelper","./SmaaRenderPass","./SSAOHelper","./TransparencyPassType","./edgeRendering/EdgeView","./edgeRendering/interfaces","../materials/renderers/MergedRenderer","../shaders/CompositingTechniqueConfiguration","../statistics/RendererPerformanceInfo","../../../webgl/enums"],(function(e,r,t,n,s,i,a,d,o,h,l,_,c,u,p,f,g,m,R,T,S,y,P,b,E,A,O,C,I,w,D,M,x,H,N,L,v,U,F,q,G,V,B,k,W,Q,j,Y,X){"use strict";const z=.9;var J;e.Renderer=function(t){function n(e,r,n,s,a,d,o,h,_){var c;return(c=t.call(this,{})||this)._materialRepository=e,c._shaderTechniqueRepository=n,c._rctx=s,c._compositingHelper=a,c._magnifierHelper=d,c._requestRender=o,c._stage=_,c._materialRenderers=new Map,c._needsTransparentPass=!1,c._hasHUDElements=!1,c._hasHighlights=!1,c._hasWater=!1,c._hasOverlayWater=!1,c._renderOverlay=e=>{},c._content=new Map,c._isRendering=!1,c._fallbackDepthStencilTexture=null,c._sliceHelper=new q,c._antialiasing=!0,c._oitEnabled=!1,c._multipassTerrain=!0,c._terrainRenderingEnabled=!0,c._terrainTransparency=S.TransparencyMode.Opaque,c._waterReflectionEnabled=!1,c._hasAnimations=!1,c._animationTimestep=R.MINIMUM_IDLE_ANIMATION_FPS_TIME,c._handles=new i,c._renderHiddenTransparentEdges=()=>{},c._oitUsed=!1,c._smaaPass=new G.SmaaRenderPass(c._rctx,n),c._oitEnabled=c._hasOITSupport,c._requestRender(),c._offscreenRendering=new M.OffscreenRendering(c._rctx,c._compositingHelper),c.performanceInfo=new Y.RendererPerformanceInfo(c._rctx),c._shadowMap=new F.ShadowMap(c._rctx,_.viewingMode),c._ssaoHelper=new V.SSAOHelper(n,c._rctx,(()=>c._requestRender())),c._highlight=new w.Highlight(n,c._rctx),c._shadowHighlight=new U.ShadowHighlight(c._rctx,_.viewingMode),c._shadowAccumulator=new v.ShadowAccumulator(c._rctx,n,_,(e=>{const r=c.shadowsEnabled;c._shadowMap.enabled=!0,c._prepare(e.camera,e.contentCamera),c._renderPlugins.prepareRender(),c._shadowMap.enabled=r}),((e,r,t)=>{e.shadowMap.start(e.camera,r,t),c._renderShadowCascades(P.ShaderOutput.Shadow,e.shadowMap),e.camera.setGLViewport(c._rctx),c._prepare(e.camera,e.contentCamera)}),(()=>c._requestRender())),c._renderContext=new x.RenderContext(c._rctx,c._offscreenRendering,c._shadowMap,c._ssaoHelper,c._sliceHelper),c._renderPlugins=new N.RenderPluginManager({renderContext:c._renderContext,shaderTechniqueRepository:n,textureRep:r,materialRep:c._materialRepository,requestRender:c._requestRender,schedule:h}),c.renderPassManager=new y.RenderPassManager(c._rctx,c._shaderTechniqueRepository),c._renderPlugins.add(c.renderPassManager.slots(),c.renderPassManager),c._handles.add([l.watch((()=>c._stage.state.camera),(()=>c._requestRender()),l.syncAndInitial),l.watch((()=>T.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES),(e=>{c._renderHiddenTransparentEdges=e?()=>c._renderEdges(W.Transparency.TRANSPARENT):()=>{},c._requestRender()}),l.initial)]),c}r._inheritsLoose(n,t);var c=n.prototype;return c.normalizeCtorArgs=function(){return{}},c.dispose=function(){this._handles.destroy(),this._smaaPass.dispose(),this._materialRenderers.forEach((e=>e.dispose())),this._materialRenderers.clear(),this._edgeView=h.destroyMaybe(this._edgeView),this._offscreenRendering.dispose(),this._fallbackDepthStencilTexture=h.disposeMaybe(this._fallbackDepthStencilTexture),this._shadowMap.enabled=!1,this._shadowMap.dispose(),this._ssaoHelper.enabled=!1,this._ssaoHelper.dispose(),this._highlight.dispose(),this._shadowHighlight.dispose(),this._shadowAccumulator.dispose(),A.BoundingInfo.prune(),this._content.clear()},c.disposeOffscreenBuffers=function(){this._offscreenRendering.dispose(),this._shadowMap.dispose(),this._smaaPass.disable(),this._ssaoHelper.disposeOffscreenBuffers()},c.ensureEdgeView=function(){return h.isNone(this._edgeView)&&(this._edgeView=new k.EdgeView({rctx:this._rctx,renderSR:this._stage.renderSR,viewingMode:this._stage.viewingMode,techniqueRepository:this._shaderTechniqueRepository,setNeedsRender:()=>this._requestRender(),schedule:e=>this._stage.resourceController.schedule(e)}),this._handles.add(l.watch((()=>h.applySome(this._edgeView,(e=>e.updating))),(()=>this._requestRender()),l.sync)),this._requestRender()),this._edgeView},c.setRenderParameters=function(e){const{_shadowMap:r,_ssaoHelper:t,_bindParameters:n}=this;if(void 0!==e.screenSpaceReflectionsEnabled&&n.ssr.enabled!==e.screenSpaceReflectionsEnabled&&(n.ssr.enabled=e.screenSpaceReflectionsEnabled,this._requestRender()),void 0!==e.shadowMap&&r.enabled!==e.shadowMap&&(r.enabled=e.shadowMap,this._requestRender()),void 0!==e.shadowMapMaxCascades&&r.maxCascades!==e.shadowMapMaxCascades&&(r.maxCascades=e.shadowMapMaxCascades,this._requestRender()),h.isSome(e.environment)){h.isSome(e.environment.weather)&&(this._bindParameters.weather=e.environment.weather,this._bindParameters.weatherVisible=e.weatherVisible),void 0!==e.environment.lighting.ambientOcclusionEnabled&&t.enabled!==e.environment.lighting.ambientOcclusionEnabled&&(t.enabled=e.environment.lighting.ambientOcclusionEnabled,this._requestRender()),void 0!==e.environment.lighting.waterReflectionEnabled&&this._waterReflectionEnabled!==e.environment.lighting.waterReflectionEnabled&&(this._waterReflectionEnabled=e.environment.lighting.waterReflectionEnabled,this._requestRender());const r="virtual"!==e.environment.lighting.type;n.enableFillLights!==r&&(n.enableFillLights=r,this._requestRender())}e.background&&this._offscreenRendering.background!==e.background&&(this._offscreenRendering.background=e.background,this._requestRender()),void 0!==e.antialiasingEnabled&&this._antialiasing!==e.antialiasingEnabled&&(this._antialiasing=e.antialiasingEnabled,this._requestRender()),void 0!==e.highQualityTransparency&&this._multipassTerrain!==e.highQualityTransparency&&(this._multipassTerrain=e.highQualityTransparency,this._oitEnabled=e.highQualityTransparency&&this._hasOITSupport,this._requestRender()),void 0!==e.defaultHighlightOptions&&(this._highlight.setDefaultOptions(e.defaultHighlightOptions),this._shadowHighlight.setDefaultOptions(e.defaultHighlightOptions),this._requestRender()),void 0!==e.overlays&&this._bindParameters.overlays!==e.overlays&&(this._bindParameters.overlays=e.overlays,this._requestRender()),void 0!==e.hasOverlayWater&&this._hasOverlayWater!==e.hasOverlayWater&&(this._hasOverlayWater=e.hasOverlayWater,this._requestRender()),void 0!==e.renderOverlay&&this._renderOverlay!==e.renderOverlay&&(this._renderOverlay=e.renderOverlay,this._requestRender()),void 0!==e.slicePlane&&this._sliceHelper.plane!==e.slicePlane&&(this._sliceHelper.plane=h.unwrap(e.slicePlane),this._requestRender()),void 0!==e.terrainRenderingEnabled&&this._terrainRenderingEnabled!==e.terrainRenderingEnabled&&(this._terrainRenderingEnabled=e.terrainRenderingEnabled,this._requestRender()),void 0!==e.terrainTransparency&&this._terrainTransparency!==e.terrainTransparency&&(this._terrainTransparency=e.terrainTransparency,this._requestRender()),void 0!==e.shadowCastOptions&&this._shadowAccumulator.setOptions(e.shadowCastOptions)},c.modify=function(e){this._isRendering&&console.warn("Renderer.modify called while rendering");const{adds:r,removes:t,updates:n}=e;if(0===r.length&&0===t.length&&0===n.length)return;t.forAll((({id:e})=>this._content.delete(e))),r.forAll((e=>this._content.set(e.id,e)));const s=H.splitRenderGeometryChangeSetByMaterial(e);let i=!1;s.forEach(((e,r)=>{let t=this._materialRenderers.get(r);if(!t){if(!(e.adds.length>0))return;t=new Q.MergedRenderer(this._rctx,this._materialRepository,r),this._materialRenderers.set(r,t)}t.modify(e),t.isEmpty&&(i=!0)})),i&&this._materialRenderers.forEach(((e,r)=>{e.isEmpty&&(this._materialRenderers.delete(r),e.dispose())})),this._hasHighlights=d.someMap(this._materialRenderers,(e=>e.hasHighlights)),this._bindParameters.hasOccludees=d.someMap(this._materialRenderers,(e=>e.hasOccludees)),this._hasWater=d.someMap(this._materialRenderers,(e=>e.hasWater)),this._hasHUDElements=d.someMap(this._materialRenderers,(e=>e.requiresSlot(L.RenderSlot.LINE_CALLOUTS_HUD_DEPTH,P.ShaderOutput.Color)||e.requiresSlot(L.RenderSlot.HUD_MATERIAL,P.ShaderOutput.Color)||e.requiresSlot(L.RenderSlot.LABEL_MATERIAL,P.ShaderOutput.Color))),this._requestRender()},c.updateAnimation=function(e){return this._hasAnimations=!1,this._materialRenderers.forEach((r=>this._hasAnimations=r.updateAnimation(e)||this._hasAnimations)),this._hasAnimations=this._renderPlugins.updateAnimation(e)||this._hasAnimations,this._hasAnimations},c.render=function(e,r,t,n,s){this._isRendering=!0;const{camera:i,contentCamera:a}=t;this._renderContext.time=s,this.performanceInfo.startFrame(),this._renderOverlay(s),this.performanceInfo.advance(Y.PerformanceCategory.OVERLAY),this._bindParameters.transparencyPassType=B.TransparencyPassType.NONE;const d=this._offscreenRendering;d.setupRenderTarget(this.hasWaterReflection);const o=m.create(this._sliceHelper.plane);n===E.Decorations.OFF&&(this._sliceHelper.plane=null),this._rctx.bindFramebuffer(e),i.setGLViewport(this._rctx),this._prepare(i,a),this._renderPlugins.prepareRender(),this.performanceInfo.advance(Y.PerformanceCategory.PREPARE);const l=this._computeDepthRange(i);this._renderShadowMap(e,i,this._bindParameters.lighting.mainLight.direction,l),this.performanceInfo.advance(Y.PerformanceCategory.SHADOW_MAP),d.initializeFrame(i),this._ensureBindParameters(i,a),this._renderLinearDepth(),this.performanceInfo.advance(Y.PerformanceCategory.LINEAR_DEPTH),this._accumulateShadows(l,i,a),this.performanceInfo.advance(Y.PerformanceCategory.ACCUMULATED_SHADOWS),this._renderNormal(),this.performanceInfo.advance(Y.PerformanceCategory.NORMALS),this._ensureBindParametersSSR(),this._renderSSAO(),this.performanceInfo.advance(Y.PerformanceCategory.SSAO),this._renderContext.output=P.ShaderOutput.Color,d.bindFramebuffer(),this._renderOpaqueGeometry(),this.performanceInfo.advance(Y.PerformanceCategory.OPAQUE);const _=this._terrainRenderingEnabled&&this._terrainTransparency!==S.TransparencyMode.Opaque,c=this._multipassTerrain&&_;this._renderTerrainLinearDepth(c),this._setMultipassEnabled(c),this._setTerrainCulling(c),this._renderEdges(W.Transparency.OPAQUE),this.performanceInfo.advance(Y.PerformanceCategory.OPAQUE_EDGES),this._offscreenRendering.bindTarget(this._offscreenRendering.currentColorTarget,this._offscreenRendering.mainDepth),this._renderSlot(L.RenderSlot.VOXEL),this.performanceInfo.advance(Y.PerformanceCategory.VOXEL),this._renderHiddenTransparentEdges();const u=this._needsTransparentPass||this._renderPlugins.needsTransparentPass;u&&(this._oitEnabled?this._renderOrderIndependentTransparency((()=>this._renderTransparentGeometry()),!1):this._renderTransparentGeometry()),this.performanceInfo.advance(Y.PerformanceCategory.TRANSPARENT),this._renderGeometryLinearDepth(c);const p=this._renderHUDVisibility(this._multipassTerrain&&_);c||this._renderInternalSlot(L.RenderSlot.LINE_CALLOUTS),this.performanceInfo.advance(Y.PerformanceCategory.HUD_VISIBILITY),this._renderObjectAndLayerIdColor(r),this.performanceInfo.advance(Y.PerformanceCategory.OBJECT_AND_LAYER_ID_COLOR),this._renderEdges(W.Transparency.TRANSPARENT,c),this.performanceInfo.advance(Y.PerformanceCategory.TRANSPARENT_EDGES),this._renderTransparentTerrain(),_&&p&&(c?this._renderLineCallouts(b.HUDTransparentRenderStyle.Occluded):d.compositeTransparentTerrainOntoHUDVisibility(this._bindParameters),this._renderHUD(b.HUDTransparentRenderStyle.Occluded,d.framebuffer),this.performanceInfo.advance(Y.PerformanceCategory.HUD_OCCLUDED)),this.performanceInfo.advance(Y.PerformanceCategory.TRANSPARENT_TERRAIN),this._setTerrainCulling(!1),_&&(d.compositeTransparentTerrainOntoMain(this._bindParameters),c&&(this._renderEdges(W.Transparency.OPAQUE),this.performanceInfo.advance(Y.PerformanceCategory.OPAQUE_EDGES),u&&(this._oitEnabled?this._renderOrderIndependentTransparency((()=>this._renderTransparentGeometry()),!1):this._renderTransparentGeometry()),this.performanceInfo.advance(Y.PerformanceCategory.TRANSPARENT),this._renderEdges(W.Transparency.TRANSPARENT),this.performanceInfo.advance(Y.PerformanceCategory.TRANSPARENT_EDGES))),c&&this._renderLineCallouts(b.HUDTransparentRenderStyle.NotOccluded),this._setMultipassEnabled(!1),this._shadowAccumulator.render(this._bindParameters),d.renderToTargets((()=>{this._renderInternalSlot(L.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),this._renderSlot(L.RenderSlot.POSTPROCESSING_ENVIRONMENT_TRANSPARENT),this._renderSlot(L.RenderSlot.LASERLINES)}),d.currentColorTarget,d.mainDepth),this.performanceInfo.advance(Y.PerformanceCategory.ENVIRONMENT),this._renderPlugins.needsLaserlineWithContrastControl&&d.renderTmpAndCompositeToMain((()=>this._renderSlot(L.RenderSlot.LASERLINES_CONTRAST_CONTROL)),this._bindParameters,j.AlphaMode.PremultipliedAlpha),this.performanceInfo.advance(Y.PerformanceCategory.LASER_LINE),this._renderOccluded(),this.performanceInfo.advance(Y.PerformanceCategory.OCCLUDED);const f=n===E.Decorations.ON&&this._magnifierHelper.enabled,g=f&&h.isNone(e)?this._offscreenRendering.getFramebuffer(this._offscreenRendering.tmpColor,this._offscreenRendering.tmpDepth):e;this._rctx.bindFramebuffer(g);const R=this._offscreenRendering.colorTexture;!this._renderAntiAliasing(R)&&h.isSome(R)&&this._compositingHelper.composite(this._bindParameters,R,j.AlphaMode.None),this.performanceInfo.advance(Y.PerformanceCategory.ANTIALIASING),this._renderHUD(b.HUDTransparentRenderStyle.NotOccluded,g),this.performanceInfo.advance(Y.PerformanceCategory.HUD_NOT_OCCLUDED),this._renderHighlights(g,this._bindParameters),this.performanceInfo.advance(Y.PerformanceCategory.HIGHLIGHTS),f&&this._magnifierHelper.render(this._rctx,this._bindParameters),g!==e&&(this._rctx.bindFramebuffer(e),this._compositingHelper.composite(this._bindParameters,this._offscreenRendering.tmpColorTexture,j.AlphaMode.None)),this._disposeOITBuffers(),this._renderContext.lastFrameCamera.copyFrom(this._bindParameters.camera),this._sliceHelper.plane=o,this._isRendering=!1,this.onPostRender&&this.onPostRender(),this.performanceInfo.finishFrame()},c._renderObjectAndLayerIdColor=function(e){h.isSome(e)&&a("enable-feature:objectAndLayerId-rendering")&&(this._rctx.bindFramebuffer(e),this._offscreenRendering.renderToFBO((()=>this._renderGeometryAndTransparentTerrainPass(P.ShaderOutput.ObjectAndLayerIdColor)),[0,0,0,0],!0,!0),this._rctx.bindFramebuffer(e),this._offscreenRendering.renderToFBO((()=>{this._bindParameters.renderTransparentlyOccludedHUD=b.HUDTransparentRenderStyle.NotOccluded,this._renderInternalSlot(L.RenderSlot.HUD_MATERIAL)}),null,!0,!0))},c.finish=function(e){if(this._hasAnimations||(this._animationTimestep=_.Milliseconds(0)),e===E.RenderRequestType.BACKGROUND){let e=0;this.performanceInfo.gpuSamplingEnabled?e=this.performanceInfo.totalGPUTimeSampler.last:this._rctx.gl.getError();const r=this.performanceInfo.elapsedTime,t=Math.max(r,e),n=o.clamp(t/R.MAXIMUM_ANIMATION_LOAD,R.MAXIMUM_IDLE_ANIMATION_FPS_TIME,R.MINIMUM_IDLE_ANIMATION_FPS_TIME);this._animationTimestep=_.Milliseconds(this._animationTimestep*z+n*(1-z))}},c.readDepthPixels=function(e,r,t){const n=this._offscreenRendering.bindTarget(this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth);if(!this._needsLinearDepth){this._ensureBindParameters(e,e),this._bindParameters.camera.setGLViewport(this._rctx),this._rctx.setClearColor(0,0,0,0);const r=X.ClearBufferBit.COLOR_BUFFER_BIT|X.ClearBufferBit.DEPTH_BUFFER_BIT|X.ClearBufferBit.STENCIL_BUFFER_BIT;this._rctx.clearSafe(r),this._renderGeometryAndTransparentTerrainPass(P.ShaderOutput.Depth)}n.readPixels(r[0],r[1],r[2],r[3],X.PixelFormat.RGBA,X.PixelType.UNSIGNED_BYTE,t)},c.readHUDVisibility=function(e,r,t,n,s){this._offscreenRendering.bindTarget(this._offscreenRendering.hudVisibility).readPixels(e,r,t,n,X.PixelFormat.RGBA,X.PixelType.UNSIGNED_BYTE,s)},c.readAccumulatedShadow=function(e,r){return this._shadowAccumulator.readAccumulatedShadow(e,r)},c._setMultipassEnabled=function(e){this._bindParameters.multipassTerrain.enabled=this._bindParameters.multipassGeometry.enabled=e},c._setTerrainCulling=function(e){this._bindParameters.multipassTerrain.cullAboveGround=e},c._renderSlot=function(e){this._bindParameters.slot=e,this._renderPlugins.render()},c._renderEdges=function(e,r=!1){const t=this._edgeView;h.isSome(t)&&t.shouldRender()&&this._offscreenRendering.renderTmpAndCompositeToMain((()=>t.render(this._bindParameters,e)),this._bindParameters,j.AlphaMode.Alpha,r)},c._renderShadowMap=function(e,r,t,n){const s=this._shadowMap;s.enabled&&(s.start(r,t,n),this._shadowHighlight.updateParameters(r,t),this._needsShadowHighlight?(this._renderShadowCascades(P.ShaderOutput.ShadowHighlight,this._shadowMap,(e=>s.takeCascadeSnapshotTo(e,F.SnapshotSlot.Highlight))),s.clear(),this._renderShadowCascades(P.ShaderOutput.ShadowExludeHighlight,this._shadowMap,(e=>{s.takeCascadeSnapshotTo(e,F.SnapshotSlot.Default),this._renderGeometryAndTransparentTerrainPass(P.ShaderOutput.ShadowHighlight)}))):this._renderShadowCascades(P.ShaderOutput.Shadow),s.finish(e),r.setGLViewport(this._rctx))},c._renderShadowCascades=function(e,r=this._shadowMap,t=(e=>{})){for(const n of r.getCascades())n.camera.setGLViewport(this._rctx),this._prepare(n.camera,n.camera),this._renderGeometryAndTransparentTerrainPass(e),t(n)},c._renderLinearDepth=function(){this._needsLinearDepth?this._offscreenRendering.renderToTargets((()=>this._renderGeometryAndTransparentTerrainPass(P.ShaderOutput.Depth)),this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.linearDepth),this._bindParameters.linearDepthTexture=this._offscreenRendering.linearDepthTexture},c._renderTerrainLinearDepth=function(e){if(e){const e=this._renderContext.output;this._renderContext.output=P.ShaderOutput.Depth,this._offscreenRendering.renderToTargets((()=>this._renderTransparentTerrain()),this._offscreenRendering.terrainLinearDepth,this._offscreenRendering.tmpDepth,[-1e10,-1e10,-1e10,1],!0,!0),this._renderContext.output=e}else this._offscreenRendering.disposeTarget(this._offscreenRendering.terrainLinearDepth);this._bindParameters.multipassTerrain.linearDepthTexture=this._offscreenRendering.terrainLinearDepthTexture},c._renderGeometryLinearDepth=function(e){if(e){const e=this._renderContext.output;this._offscreenRendering.renderToTargets((()=>this._renderGeometryPass(P.ShaderOutput.Depth)),this._offscreenRendering.geometryLinearDepth,this._offscreenRendering.tmpDepth,[1,1,1,1],!0,!0),this._renderContext.output=e}else this._offscreenRendering.disposeTarget(this._offscreenRendering.geometryLinearDepth);this._bindParameters.multipassGeometry.linearDepthTexture=this._offscreenRendering.geometryLinearDepthTexture},c._renderNormal=function(){this._needsNormal?this._offscreenRendering.renderToTargets((()=>{this._renderGeometryAndTransparentTerrainPass(P.ShaderOutput.Normal)}),this._offscreenRendering.normal,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.normal)},c._computeDepthRange=function(e){if(!this._needsDepthRange)return O.ZERO;const r=C.depthRangeFromScene(e,this._content,this._stage.layers);return O.union(r,this.renderPlugins.queryDepthRange(e)),r.near=Math.max(e.near,r.near),r.far=Math.min(e.far,r.far),r},c._renderGeometryAndTransparentTerrainPass=function(e){this._renderContext.output=e,this._renderGeometryPass(e),this._renderTransparentTerrain()},c._renderGeometryPass=function(e){this._renderContext.output=e,this._renderOpaqueGeometry(),this._renderTransparentGeometry()},c._renderSSAO=function(){this._ssaoHelper.loading?this._requestRender():this._ssaoHelper.computeSSAO(this._bindParameters,this._offscreenRendering.linearDepthTexture,this._offscreenRendering.normalTexture)},c._renderOpaqueGeometry=function(){this._renderSlot(L.RenderSlot.INTEGRATED_MESH),this._renderSlot(L.RenderSlot.OPAQUE_TERRAIN),this._renderInternalSlot(L.RenderSlot.OPAQUE_MATERIAL),this._renderSlot(L.RenderSlot.OPAQUE_MATERIAL),this._renderSlot(L.RenderSlot.POSTPROCESSING_ENVIRONMENT_OPAQUE)},c._renderTransparentGeometry=function(){this._renderInternalSlot(L.RenderSlot.TRANSPARENT_MATERIAL),this._renderSlot(L.RenderSlot.TRANSPARENT_MATERIAL)},c._renderTransparentTerrain=function(){this._renderSlot(L.RenderSlot.TRANSPARENT_TERRAIN)},c._renderHUDVisibility=function(e){let r=!1;return this._renderContext.offscreenRenderingHelper&&this._renderContext.offscreenRenderingHelper.renderHUDVisibility((()=>{this._bindParameters.hudVisibilityTexture=this._renderContext.offscreenRenderingHelper.hudVisibilityTexture,r=this._renderInternalSlot(L.RenderSlot.OCCLUSION_PIXELS)}),e),r},c._renderLineCallouts=function(e){this._bindParameters.renderTransparentlyOccludedHUD=e,e===b.HUDTransparentRenderStyle.Occluded?this._offscreenRendering.renderToTargets((()=>this._renderInternalSlot(L.RenderSlot.LINE_CALLOUTS)),this._offscreenRendering.currentColorTarget,this._offscreenRendering.tmpDepth,void 0,!0,!0):this._renderInternalSlot(L.RenderSlot.LINE_CALLOUTS)},c._renderHUD=function(e,r){this._hasHUDElements&&(this._oitEnabled?(this._renderOrderIndependentTransparency((()=>this._renderHUDElements(e)),!0),this._rctx.bindFramebuffer(r),this._compositingHelper.composite(this._bindParameters,this._offscreenRendering.hudColorTexture,j.AlphaMode.PremultipliedAlpha)):e===b.HUDTransparentRenderStyle.Occluded?this._offscreenRendering.renderToTargets((()=>this._renderHUDElements(b.HUDTransparentRenderStyle.Occluded)),this._offscreenRendering.currentColorTarget,this._offscreenRendering.tmpDepth,void 0,!0,!0):this._renderHUDElements(e))},c._renderHUDElements=function(e){this._bindParameters.renderTransparentlyOccludedHUD=e,this._renderInternalSlot(L.RenderSlot.LINE_CALLOUTS_HUD_DEPTH),this._renderInternalSlot(L.RenderSlot.HUD_MATERIAL),this._renderInternalSlot(L.RenderSlot.LABEL_MATERIAL)},c._renderHighlights=function(e,r){if(!this._needsHighlight)return void this._offscreenRendering.disposeTarget(this._offscreenRendering.highlight);const t=this._highlight,n=this._offscreenRendering.renderToTargets((()=>{this._renderGeometryAndTransparentTerrainPass(P.ShaderOutput.Highlight),this._rctx.clearSafe(X.ClearBufferBit.DEPTH_BUFFER_BIT),this._renderHUDElements(b.HUDTransparentRenderStyle.Both)}),this._offscreenRendering.highlight,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0);this._bindParameters.highlightColorTexture=n.colorTexture,this._needsShadowHighlight&&this._shadowHighlight.render(r,e),t.render(this._bindParameters,n,e)},c._accumulateShadows=function(e,r,t){this._needsShadowCast&&this._shadowAccumulator.renderAccumulation(this._offscreenRendering.linearDepthTexture,e,r,t)},c._renderOrderIndependentTransparency=function(e,r){const t=t=>{this._bindParameters.transparencyPassType=t,this._offscreenRendering.renderOITPass((()=>e()),t,r)},n=this._renderContext.output;this._renderContext.output=P.ShaderOutput.Alpha,t(B.TransparencyPassType.Alpha),this._renderContext.output=P.ShaderOutput.Color,t(B.TransparencyPassType.Color),t(B.TransparencyPassType.FrontFace),this._offscreenRendering.compositeTransparentOntoOpaque(this._bindParameters,r),this._bindParameters.transparencyPassType=B.TransparencyPassType.NONE,this._renderContext.output=n,this._oitUsed=!0},c._disposeOITBuffers=function(){this._oitUsed||(this._offscreenRendering.disposeTarget(this._offscreenRendering.alphaFloatTarget),this._offscreenRendering.disposeTarget(this._offscreenRendering.colorFloatTarget),this._offscreenRendering.disposeTarget(this._offscreenRendering.frontFaceTarget)),this._oitUsed=!1},c._renderOccluded=function(){let e=0;this._materialRenderers.forEach(((r,t)=>{t&&t.isVisible()&&t.renderOccluded===D.RenderOccludedFlag.OccludeAndTransparentStencil&&(e|=t.renderOccluded,Z.push(t))}));const r=this._offscreenRendering,t=(t,n,s,i,a)=>{0!=(e&n)&&(r.renderToTargets(s,r.tmpColor,r.mainDepth,[0,0,0,0],i,a),r.compositeOccludedOntoMain(this._bindParameters,t))};0!==Z.length&&(this._renderInternalSlot(L.RenderSlot.OCCLUDER_MATERIAL,Z),t(.5,D.RenderOccludedFlag.OccludeAndTransparentStencil,(()=>this._renderInternalSlot(L.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL,Z)),!1,!1),Z.length=0),this._materialRenderers.forEach(((r,t)=>{t&&t.isVisible()&&(t.renderOccluded===D.RenderOccludedFlag.OccludeAndTransparent||t.renderOccluded===D.RenderOccludedFlag.Transparent||t.renderOccluded===D.RenderOccludedFlag.Opaque)&&(e|=t.renderOccluded,K.push(t))}));const n=this._renderPlugins.renderOccludedFlags;if(e|=n,!e)return;const s=e=>{this._renderContext.renderOccludedMask=e,n>D.RenderOccludedFlag.Occlude&&this._renderSlot(L.RenderSlot.OCCLUDED_TERRAIN),this._renderInternalSlot(L.RenderSlot.OPAQUE_MATERIAL,K),this._renderInternalSlot(L.RenderSlot.TRANSPARENT_MATERIAL,K),this._renderInternalSlot(L.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,K),this._renderContext.resetRenderOccludedMask()};this._renderContext.output=P.ShaderOutput.Color,t(.5,D.RenderOccludedFlag.OccludeAndTransparent,(()=>s(D.RenderOccludedFlag.OccludeAndTransparent)),!0,E.StencilBits.OutlineVisualElementMask),t(.5,D.RenderOccludedFlag.Transparent,(()=>s(D.RenderOccludedFlag.Transparent)),!0,E.StencilBits.OutlineVisualElementMask),t(1,D.RenderOccludedFlag.Opaque,(()=>s(D.RenderOccludedFlag.Opaque)),!0,E.StencilBits.OutlineVisualElementMask),K.length=0},c._renderAntiAliasing=function(e){if(this._antialiasing){if(this._smaaPass.enable((()=>this._requestRender()))&&h.isSome(e))return this._smaaPass.render(e),!0}else this._smaaPass.disable();return!1},c._prepare=function(e,r){this._needsTransparentPass=d.someMap(this._materialRenderers,(e=>e.requiresSlot(L.RenderSlot.TRANSPARENT_MATERIAL,P.ShaderOutput.Color))),this._bindParameters.camera=e,this._bindParameters.contentCamera=r},c._ensureBindParameters=function(e,r){this._bindParameters.camera=e,this._bindParameters.contentCamera=r;const t=this._renderContext.offscreenRenderingHelper;this._bindParameters.hudVisibilityTexture=t.hudVisibilityTexture,this._bindParameters.mainColorTexture=t.mainColorTexture,this._bindParameters.highlightDepthTexture=t.depthTexture??this._getFallbackDepthTexture()},c._ensureBindParametersSSR=function(){this.hasWaterReflection?(this._renderContext.lastFrameCamera.equals(this._bindParameters.camera)?this._reprojectionMatrix=g.IDENTITY:(f.invert(ee,this._bindParameters.camera.viewMatrix),f.invert($,this._bindParameters.camera.projectionMatrix),f.multiply(re,ee,$),f.multiply(re,this._renderContext.lastFrameCamera.viewMatrix,re),f.multiply(re,this._renderContext.lastFrameCamera.projectionMatrix,re),this._reprojectionMatrix=re),this._bindParameters.ssr.lastFrameColorTexture=this._offscreenRendering.lastFrameColorTexture):this._bindParameters.ssr.lastFrameColorTexture=null,this._bindParameters.ssr.enabled=this.hasWaterReflection},c._renderInternalSlot=function(e,r){let t=!1;return this._bindParameters.slot=e,h.isSome(r)?r.forEach((e=>{if(!e.shouldRender(this._renderContext))return;const r=this._materialRenderers.get(e);h.isSome(r)&&(t=r.render(this._renderContext.output,this._bindParameters)||t)})):this._materialRenderers.forEach(((e,r)=>{r.shouldRender(this._renderContext)&&e.render(this._renderContext.output,this._bindParameters)&&(t=!0)})),t},c._getFallbackDepthTexture=function(){return this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=I.createEmptyDepthTexture(this._rctx)),this._fallbackDepthStencilTexture},r._createClass(n,[{key:"_bindParameters",get:function(){return this._renderContext.bindParameters}},{key:"hasWater",get:function(){return this._hasWater||this._hasOverlayWater}},{key:"hasWaterReflection",get:function(){return this.hasWater&&this._waterReflectionEnabled}},{key:"updating",get:function(){return this._antialiasing&&this._smaaPass.updating||h.isSome(this._edgeView)&&this._edgeView.updating||this._shadowAccumulator.running||!this.isCameraFinal}},{key:"edgeView",get:function(){return this._edgeView}},{key:"isCameraFinal",get:function(){return f.equals(this._bindParameters.ssr.reprojectionMatrix,g.IDENTITY)}},{key:"_reprojectionMatrix",set:function(e){s.update(this._bindParameters.ssr.reprojectionMatrix,e)&&this.notifyChange("isCameraFinal")}},{key:"shadowsEnabled",get:function(){return!!this._shadowMap?.enabled}},{key:"hasSlicePlane",get:function(){return!!this._sliceHelper.plane}},{key:"renderPlugins",get:function(){return this._renderPlugins}},{key:"_hasOITSupport",get:function(){return this._rctx.driverTest.floatBufferBlendWorking}},{key:"animationTimestep",get:function(){return this._animationTimestep}},{key:"_needsLinearDepth",get:function(){return this._ssaoHelper.ready||this._renderPlugins.needsLinearDepth||this._hasWater&&this._waterReflectionEnabled||this._needsShadowHighlight||this._needsShadowCast}},{key:"_needsNormal",get:function(){return this._ssaoHelper.ready}},{key:"_needsDepthRange",get:function(){return this._shadowMap.enabled||this._needsShadowCast}},{key:"_needsHighlight",get:function(){return this._hasHighlights||this._renderPlugins.needsHighlight}},{key:"_needsShadowHighlight",get:function(){return this._shadowMap.enabled&&this._shadowHighlight.isVisible&&this._needsHighlight}},{key:"_needsShadowCast",get:function(){return this._shadowAccumulator.isAccumulating}},{key:"gpuMemoryUsage",get:function(){return{offscreen:this._offscreenRendering?.gpuMemoryUsage??0,highlights:(this._highlight?.gpuMemoryUsage??0)+(this._shadowHighlight?.gpuMemoryUsage??0),shadows:this._shadowMap?.gpuMemoryUsage??0,ssao:this._ssaoHelper?.gpuMemoryUsage??0}}},{key:"test",get:function(){const r=this;return{offscreen:this._offscreenRendering,shadowMap:this._shadowMap,ssao:this._ssaoHelper,highlight:this._highlight,lighting:this._bindParameters.lighting,materialRenderers:this._materialRenderers,shadowAccumulator:this._shadowAccumulator,weatherIsFading:this._bindParameters.cloudsFade.isFading,getFramebufferTexture:t=>{switch(t){case e.FramebufferId.Color:return r._offscreenRendering.colorTexture;case e.FramebufferId.LinearDepth:return r._offscreenRendering.linearDepthTexture;case e.FramebufferId.Normals:return r._offscreenRendering.normalTexture;case e.FramebufferId.ShadowMap:return r._shadowMap.depthTexture;case e.FramebufferId.HudVisibility:return r._offscreenRendering.hudVisibilityTexture;case e.FramebufferId.Highlight:return r._offscreenRendering.highlightTexture}}}}}]),n}(n),t.__decorate([c.property()],e.Renderer.prototype,"_shadowAccumulator",void 0),t.__decorate([c.property()],e.Renderer.prototype,"_smaaPass",void 0),t.__decorate([c.property()],e.Renderer.prototype,"_antialiasing",void 0),t.__decorate([c.property()],e.Renderer.prototype,"_edgeView",void 0),t.__decorate([c.property()],e.Renderer.prototype,"updating",null),t.__decorate([c.property()],e.Renderer.prototype,"isCameraFinal",null),e.Renderer=t.__decorate([p.subclass("esri.views.3d.webgl-engine.lib.Renderer")],e.Renderer),e.FramebufferId=void 0,(J=e.FramebufferId||(e.FramebufferId={}))[J.Color=0]="Color",J[J.LinearDepth=1]="LinearDepth",J[J.Normals=2]="Normals",J[J.ShadowMap=3]="ShadowMap",J[J.HudVisibility=4]="HudVisibility",J[J.Highlight=5]="Highlight";const K=[],Z=[],$=g.create(),ee=g.create(),re=g.create();Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
