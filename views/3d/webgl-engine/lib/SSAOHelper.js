/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["require","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/Logger","../../../../chunks/vec3","../../../../chunks/vec2f64","../../../../chunks/vec4f64","../../../../chunks/vec4","../../../../support/requestImageUtils","./Util","../../../webgl/Texture","../../../webgl/Util","./glUtil3D","./DefaultTextureUnits","../../../webgl/FramebufferObject","./SSAOTechnique"],(function(e,t,i,s,r,n,o,a,h,u,l,_,c,f,p,d){"use strict";const m=s.getLogger("esri.views.3d.webgl-engine.lib.SSAOHelper");let g=function(){function s(e,t,i){this._enabled=!1,this._BLUR_F=2,this._attenuation=.5,this._radius=3,this._samples=16,this._viewportToRestore=o.create(),this.quadVAO=null,this._rctx=t,this._techniqueRep=e,this._requestRender=i,this._ssaoTechniqueConfig=new d.SSAOTechniqueConfiguration,this._emptyTexture=c.createColorTexture(t,[1,1,1,1])}var n=s.prototype;return n.dispose=function(){this._emptyTexture.dispose(),this._emptyTexture=null,i.isSome(this.quadVAO)&&(this.quadVAO=i.disposeMaybe(this.quadVAO))},n.computeSSAO=function(e,t,s){if(!this._noiseTexture)return;u.assert(this.enabled);const n=this._rctx,o=e.fullViewport,h=o[2],l=o[3],f=h/this._BLUR_F,p=l/this._BLUR_F;this._ssaoFBO.resize(h,l),this._blur0FBO.resize(f,p),this._blur1FBO.resize(f,p);const d=1*h,m=1*l;n.bindFramebuffer(this._ssaoFBO),a.copy(this._viewportToRestore,e.fullViewport),n.setViewport(0,0,h,l);const g=this._ssaoTechnique.program,x=this._blurTechnique.program;n.bindProgram(g),n.setPipelineState(this._ssaoTechnique.pipeline),g.setUniform2f("rnmScale",h/this._noiseTexture.descriptor.width,l/this._noiseTexture.descriptor.height),g.setUniform3fv("pSphere",this._samples<=8?this._data.random8:this._samples<=16?this._data.random16:this._samples<=32?this._data.random32:this._data.random64);const O=this._data.minDiscrepancy,U=this._samples<O.length?O[this._samples]:5779;g.setUniform1f("numSpiralTurns",U);const F=T,w=b;u.inverseProjectionInfo(e.projectionMatrix,e.fullWidth,e.fullHeight,F,w),g.setUniform4fv("projInfo",F),g.setUniform2fv("zScale",w),g.setUniform2f("nearFar",e.near,e.far);let S=1/e.computeRenderPixelSizeAtDist(1);g.setUniform1f("projScale",1*S),g.setUniform2f("screenDimensions",d,m);let B=2*this._radius;const q=r.distance(e.eye,e.center);B=20*e.computeRenderPixelSizeAtDist(q),B=Math.max(.1,B),g.setUniform1f("radius",B),g.setUniform1f("intensity",4*this._attenuation/Math.pow(B,6)),g.setUniform1i("rnm",0),g.setUniform1i("normalMap",1),g.setUniform1i("depthMap",2),n.bindTexture(this._noiseTexture,0),n.bindTexture(s,1),n.bindTexture(t,2),i.isSome(this.quadVAO)||(this.quadVAO=c.createQuadVAO(this._rctx));const y=this.quadVAO;n.bindVAO(y),n.drawArrays(5,0,_.vertexCount(y,"geometry"));n.bindTexture(this._ssaoFBO.colorTexture,0),n.setViewport(0,0,d/this._BLUR_F,m/this._BLUR_F),n.bindFramebuffer(this._blur0FBO),n.bindProgram(x),x.setUniform2f("screenDimensions",d,m),x.setUniform1i("tex",0),x.setUniform1i("normalMap",1),x.setUniform1i("depthMap",2),x.setUniform2f("blurSize",0,1*this._BLUR_F/m),x.setUniform1i("radius",4),x.setUniform1f("g_BlurFalloff",.08),x.setUniform2f("nearFar",e.near,e.far),q>5e4&&(S=Math.max(0,S-(q-5e4))),x.setUniform1f("projScale",S),x.setUniform2f("zScale",1,0),n.drawArrays(5,0,_.vertexCount(y,"geometry")),x.setUniform2f("blurSize",1*this._BLUR_F/d,0),n.bindFramebuffer(this._blur1FBO),n.bindTexture(this._blur0FBO.colorTexture,0),n.drawArrays(5,0,_.vertexCount(y,"geometry")),n.setViewport(this._viewportToRestore[0],this._viewportToRestore[1],this._viewportToRestore[2],this._viewportToRestore[3])},n.setUniforms=function(e,t){const i=this.enabled&&this._noiseTexture,s=this._rctx;s.bindTexture(i?this._blur1FBO.colorTexture:this._emptyTexture,t),s.setActiveTexture(0),e.setUniform1i("ssaoTex",t),i?e.setUniform4f("viewportPixelSz",this._viewportToRestore[0],this._viewportToRestore[1],1/this._ssaoFBO.width,1/this._ssaoFBO.height):e.setUniform4f("viewportPixelSz",-1,-1,-1,-1)},n.bindToAllPrograms=function(e){const t=e.getProgramsUsingUniform("viewportPixelSz");for(let e=0;e<t.length;e++)this.setUniforms(t[e],f.DefaultTextureUnits.SSAO)},n.selectPrograms=function(){const e=this._samples<=8?8:this._samples<=16?16:this._samples<=32?32:64;this._ssaoTechniqueConfig.samples=e,this._ssaoTechniqueConfig.radius=4,this._ssaoTechniqueConfig.output=0,this._ssaoTechnique=this._techniqueRep.acquireAndReleaseExisting(d.SSAOTechnique,this._ssaoTechniqueConfig,this._ssaoTechnique),this._ssaoTechniqueConfig.output=1,this._blurTechnique=this._techniqueRep.acquireAndReleaseExisting(d.SSAOTechnique,this._ssaoTechniqueConfig,this._blurTechnique)},n.enable=function(){this.enabled||(this.isSupported?(this._enabled=!0,this.loadResources((()=>{this._enabled&&this.initialize()}))):m.warn("SSAO is not supported for this browser or hardware"))},n.loadResources=function(t){this._data?t():new Promise((function(t,i){e(["./SSAOHelperData"],t,i)})).then((e=>{this._data=e,t()}))},n.initialize=function(){const e={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0},t={colorTarget:0,depthStencilTarget:0};this._ssaoFBO=new p(this._rctx,t,e),this._blur0FBO=new p(this._rctx,t,e),this._blur1FBO=new p(this._rctx,t,e),h.requestImage(this._data.noiseTexture).then((e=>{this._enabled&&(this._noiseTexture=new l(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,hasMipmap:!0,width:e.width,height:e.height},e),this._requestRender())})),this.selectPrograms()},n.disable=function(){this.enabled&&(this._enabled=!1,this._noiseTexture&&(this._noiseTexture.dispose(),this._noiseTexture=null),this._blur1FBO&&(this._blur1FBO.dispose(),this._blur1FBO=null),this._blur0FBO&&(this._blur0FBO.dispose(),this._blur0FBO=null),this._ssaoFBO&&(this._ssaoFBO.dispose(),this._ssaoFBO=null))},n.getGpuMemoryUsage=function(){return _.getGpuMemoryUsage(this._blur0FBO)+_.getGpuMemoryUsage(this._blur1FBO)+_.getGpuMemoryUsage(this._ssaoFBO)},t._createClass(s,[{key:"isSupported",get:function(){const e=this._rctx,t=-1!==e.parameters.versionString.indexOf("WebGL 0.93"),i=-1!==e.parameters.versionString.indexOf("WebGL 0.94");return!(t||i)}},{key:"enabled",set:function(e){e?this.enable():this.disable()},get:function(){return this._enabled}},{key:"attenuation",set:function(e){this._attenuation=e},get:function(){return this._attenuation}},{key:"radius",set:function(e){this._radius=e},get:function(){return this._radius}},{key:"filterRadius",get:function(){return 4}},{key:"samples",set:function(e){this._samples=e,this._enabled&&this.selectPrograms()},get:function(){return this._samples}},{key:"test",get:function(){return{ssao:this._ssaoFBO,blur:this._blur1FBO}}}]),s}();const b=n.create(),T=o.create();return g}));
