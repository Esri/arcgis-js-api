/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["require","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/Logger","../../../../chunks/vec3","../../../../chunks/vec2f64","../../../../chunks/vec4f64","../../../../chunks/vec4","../../../../support/requestImageUtils","./Util","../../../webgl/Texture","../../../webgl/Util","./glUtil3D","./DefaultTextureUnits","../../../webgl/FramebufferObject","./SSAOTechnique"],(function(e,t,s,i,r,n,o,a,h,u,l,_,c,f,p,d){"use strict";const m=i.getLogger("esri.views.3d.webgl-engine.lib.SSAOHelper"),b=4;let g=function(){function i(e,t,s){this._enabled=!1,this._BLUR_F=2,this._attenuation=.5,this._radius=3,this._samples=16,this._viewportToRestore=o.create(),this.quadVAO=null,this._rctx=t,this._techniqueRep=e,this._requestRender=s,this._ssaoTechniqueConfig=new d.SSAOTechniqueConfiguration,this._emptyTexture=c.createColorTexture(t,[1,1,1,1])}var n=i.prototype;return n.dispose=function(){this._emptyTexture.dispose(),this._emptyTexture=null,s.isSome(this.quadVAO)&&(this.quadVAO=s.disposeMaybe(this.quadVAO))},n.computeSSAO=function(e,t,i){if(!this._noiseTexture)return;u.assert(this.enabled);const n=this._rctx,o=e.fullViewport,h=o[2],l=o[3],f=h/this._BLUR_F,p=l/this._BLUR_F;this._ssaoFBO.resize(h,l),this._blur0FBO.resize(f,p),this._blur1FBO.resize(f,p);const d=1,m=1,g=h*d,O=l*m;n.bindFramebuffer(this._ssaoFBO),a.copy(this._viewportToRestore,e.fullViewport),n.setViewport(0,0,h,l);const U=this._ssaoTechnique.program,F=this._blurTechnique.program;n.bindProgram(U),n.setPipelineState(this._ssaoTechnique.pipeline),U.setUniform2f("rnmScale",h/this._noiseTexture.descriptor.width,l/this._noiseTexture.descriptor.height),U.setUniform3fv("pSphere",this._samples<=8?this._data.random8:this._samples<=16?this._data.random16:this._samples<=32?this._data.random32:this._data.random64);const S=this._data.minDiscrepancy,w=this._samples<S.length?S[this._samples]:5779;U.setUniform1f("numSpiralTurns",w);const B=x,q=T;u.inverseProjectionInfo(e.projectionMatrix,e.fullWidth,e.fullHeight,B,q),U.setUniform4fv("projInfo",B),U.setUniform2fv("zScale",q),U.setUniform2f("nearFar",e.near,e.far);let y=1/e.computeRenderPixelSizeAtDist(1);U.setUniform1f("projScale",y*d),U.setUniform2f("screenDimensions",g,O);let v=2*this._radius;const A=r.distance(e.eye,e.center);v=20*e.computeRenderPixelSizeAtDist(A),v=Math.max(.1,v),U.setUniform1f("radius",v),U.setUniform1f("intensity",4*this._attenuation/v**6),U.setUniform1i("rnm",0),U.setUniform1i("normalMap",1),U.setUniform1i("depthMap",2),n.bindTexture(this._noiseTexture,0),n.bindTexture(i,1),n.bindTexture(t,2),s.isSome(this.quadVAO)||(this.quadVAO=c.createQuadVAO(this._rctx));const R=this.quadVAO;n.bindVAO(R),n.drawArrays(5,0,_.vertexCount(R,"geometry"));const P=(b+1)/2,M=1/(2*P*P);n.bindTexture(this._ssaoFBO.colorTexture,0),n.setViewport(0,0,g/this._BLUR_F,O/this._BLUR_F),n.bindFramebuffer(this._blur0FBO),n.bindProgram(F),F.setUniform2f("screenDimensions",g,O),F.setUniform1i("tex",0),F.setUniform1i("normalMap",1),F.setUniform1i("depthMap",2),F.setUniform2f("blurSize",0,this._BLUR_F*d/O),F.setUniform1i("radius",b),F.setUniform1f("g_BlurFalloff",M),F.setUniform2f("nearFar",e.near,e.far),A>5e4&&(y=Math.max(0,y-(A-5e4))),F.setUniform1f("projScale",y),F.setUniform2f("zScale",1,0),n.drawArrays(5,0,_.vertexCount(R,"geometry")),F.setUniform2f("blurSize",this._BLUR_F*m/g,0),n.bindFramebuffer(this._blur1FBO),n.bindTexture(this._blur0FBO.colorTexture,0),n.drawArrays(5,0,_.vertexCount(R,"geometry")),n.setViewport(this._viewportToRestore[0],this._viewportToRestore[1],this._viewportToRestore[2],this._viewportToRestore[3])},n.setUniforms=function(e,t){const s=this.enabled&&this._noiseTexture,i=this._rctx;i.bindTexture(s?this._blur1FBO.colorTexture:this._emptyTexture,t),i.setActiveTexture(0),e.setUniform1i("ssaoTex",t),s?e.setUniform4f("viewportPixelSz",this._viewportToRestore[0],this._viewportToRestore[1],1/this._ssaoFBO.width,1/this._ssaoFBO.height):e.setUniform4f("viewportPixelSz",-1,-1,-1,-1)},n.bindToAllPrograms=function(e){const t=e.getProgramsUsingUniform("viewportPixelSz");for(const s of t)this.setUniforms(s,f.DefaultTextureUnits.SSAO)},n.selectPrograms=function(){const e=this._samples<=8?8:this._samples<=16?16:this._samples<=32?32:64;this._ssaoTechniqueConfig.samples=e,this._ssaoTechniqueConfig.radius=b,this._ssaoTechniqueConfig.output=0,this._ssaoTechnique=this._techniqueRep.acquireAndReleaseExisting(d.SSAOTechnique,this._ssaoTechniqueConfig,this._ssaoTechnique),this._ssaoTechniqueConfig.output=1,this._blurTechnique=this._techniqueRep.acquireAndReleaseExisting(d.SSAOTechnique,this._ssaoTechniqueConfig,this._blurTechnique)},n.enable=function(){this.enabled||(this.isSupported?(this._enabled=!0,this.loadResources((()=>{this._enabled&&this.initialize()}))):m.warn("SSAO is not supported for this browser or hardware"))},n.loadResources=function(t){this._data?t():new Promise((function(t,s){e(["./SSAOHelperData"],t,s)})).then((e=>{this._data=e,t()}))},n.initialize=function(){const e={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0},t={colorTarget:0,depthStencilTarget:0};this._ssaoFBO=new p(this._rctx,t,e),this._blur0FBO=new p(this._rctx,t,e),this._blur1FBO=new p(this._rctx,t,e),h.requestImage(this._data.noiseTexture).then((e=>{this._enabled&&(this._noiseTexture=new l(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,hasMipmap:!0,width:e.width,height:e.height},e),this._requestRender())})),this.selectPrograms()},n.disable=function(){this.enabled&&(this._enabled=!1,this._noiseTexture&&(this._noiseTexture.dispose(),this._noiseTexture=null),this._blur1FBO&&(this._blur1FBO.dispose(),this._blur1FBO=null),this._blur0FBO&&(this._blur0FBO.dispose(),this._blur0FBO=null),this._ssaoFBO&&(this._ssaoFBO.dispose(),this._ssaoFBO=null))},n.getGpuMemoryUsage=function(){return _.getGpuMemoryUsage(this._blur0FBO)+_.getGpuMemoryUsage(this._blur1FBO)+_.getGpuMemoryUsage(this._ssaoFBO)},t._createClass(i,[{key:"isSupported",get:function(){const e=this._rctx,t=-1!==e.parameters.versionString.indexOf("WebGL 0.93"),s=-1!==e.parameters.versionString.indexOf("WebGL 0.94");return!(t||s)}},{key:"enabled",get:function(){return this._enabled},set:function(e){e?this.enable():this.disable()}},{key:"attenuation",get:function(){return this._attenuation},set:function(e){this._attenuation=e}},{key:"radius",get:function(){return this._radius},set:function(e){this._radius=e}},{key:"filterRadius",get:function(){return b}},{key:"samples",get:function(){return this._samples},set:function(e){this._samples=e,this._enabled&&this.selectPrograms()}},{key:"test",get:function(){return{ssao:this._ssaoFBO,blur:this._blur1FBO}}}]),i}();const T=n.create(),x=o.create();return g}));
