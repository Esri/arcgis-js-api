/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["require","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../chunks/vec2f64","../../../../chunks/vec3","../../../../chunks/vec4","../../../../chunks/vec4f64","../../../../support/requestImageUtils","./glUtil3D","./SSAOTechnique","./Util","../../../webgl/FramebufferObject","../../../webgl/Texture","../../../webgl/Util"],(function(e,t,s,i,r,n,o,a,h,u,_,l,c,f){"use strict";let d=function(){function i(e,t,s){this._techniqueRep=e,this._rctx=t,this._requestRender=s,this._enabled=!1,this._ssaoTechniqueConfig=new u.SSAOTechniqueConfiguration,this.quadVAO=null,this._BLUR_F=2,this._attenuation=.5,this._radius=3,this._samples=16,this._viewportToRestore=o.create()}var d=i.prototype;return d.dispose=function(){this.quadVAO=s.disposeMaybe(this.quadVAO)},d.computeSSAO=function(e,t,i){if(!this.enabled||s.isNone(this._noiseTexture)||s.isNone(this._ssaoFBO)||s.isNone(this._blur0FBO)||s.isNone(this._blur1FBO))return;const o=this._rctx,a=e.fullViewport,l=a[2],c=a[3],d=l/this._BLUR_F,b=c/this._BLUR_F;this._ssaoFBO.resize(l,c),this._blur0FBO.resize(d,b),this._blur1FBO.resize(d,b);const F=1,T=1,g=l*F,O=c*T;n.copy(this._viewportToRestore,e.fullViewport),o.bindFramebuffer(this._ssaoFBO),o.setViewport(0,0,l,c);const B=this._ssaoTechnique.program;o.useProgram(B),o.setPipelineState(this._ssaoTechnique.pipeline),B.setUniform2f("rnmScale",l/this._noiseTexture.descriptor.width,c/this._noiseTexture.descriptor.height),B.setUniform3fv("pSphere",this._samples<=8?this._data.random8:this._samples<=16?this._data.random16:this._samples<=32?this._data.random32:this._data.random64);const x=this._data.minDiscrepancy,S=this._samples<x.length?x[this._samples]:5779;B.setUniform1f("numSpiralTurns",S);const U=p,q=m;_.inverseProjectionInfo(e.projectionMatrix,e.fullWidth,e.fullHeight,U,q),B.setUniform4fv("projInfo",U),B.setUniform2fv("zScale",q),B.setUniform2f("nearFar",e.near,e.far);let w=1/e.computeRenderPixelSizeAtDist(1);B.setUniform1f("projScale",w*F),B.setUniform2f("screenDimensions",g,O);const y=r.distance(e.eye,e.center);let R=20*e.computeRenderPixelSizeAtDist(y);R=Math.max(.1,R),B.setUniform1f("radius",R),B.setUniform1f("intensity",4*this._attenuation/R**6),B.bindTexture(this._noiseTexture,"rnm"),B.bindTexture(i,"normalMap"),B.bindTexture(t,"depthMap"),s.isNone(this.quadVAO)&&(this.quadVAO=h.createQuadVAO(this._rctx));const A=this.quadVAO;o.bindVAO(A),o.drawArrays(5,0,f.vertexCount(A,"geometry"));const v=(u.FILTER_RADIUS+1)/2,M=1/(2*v*v),z=this._blurTechnique.program;o.useProgram(z),z.bindTexture(this._ssaoFBO.colorTexture,"tex"),z.bindTexture(i,"normalMap"),z.bindTexture(t,"depthMap"),o.setViewport(0,0,g/this._BLUR_F,O/this._BLUR_F),o.bindFramebuffer(this._blur0FBO),z.setUniform2f("screenDimensions",g,O),z.setUniform2f("blurSize",0,this._BLUR_F*F/O),z.setUniform1i("radius",u.FILTER_RADIUS),z.setUniform1f("g_BlurFalloff",M),z.setUniform2f("nearFar",e.near,e.far),y>5e4&&(w=Math.max(0,w-(y-5e4))),z.setUniform1f("projScale",w),z.setUniform2f("zScale",1,0),o.drawArrays(5,0,f.vertexCount(A,"geometry")),z.setUniform2f("blurSize",this._BLUR_F*T/g,0),o.bindFramebuffer(this._blur1FBO),z.bindTexture(this._blur0FBO.colorTexture,"tex"),o.drawArrays(5,0,f.vertexCount(A,"geometry")),o.setViewport(this._viewportToRestore[0],this._viewportToRestore[1],this._viewportToRestore[2],this._viewportToRestore[3])},d.bind=function(e){this.enabled&&s.isSome(this._blur1FBO)&&s.isSome(this._ssaoFBO)?(e.bindTexture(this._blur1FBO.colorTexture,"ssaoTex"),e.setUniform4f("viewportPixelSz",this._viewportToRestore[0],this._viewportToRestore[1],1/this._ssaoFBO.width,1/this._ssaoFBO.height)):e.setUniform4f("viewportPixelSz",-1,-1,-1,-1)},d._selectPrograms=function(){const e=this._samples<=8?0:this._samples<=16?1:this._samples<=32?2:3;this._ssaoTechniqueConfig.samples=e,this._ssaoTechniqueConfig.output=0,this._ssaoTechnique=this._techniqueRep.releaseAndAcquire(u.SSAOTechnique,this._ssaoTechniqueConfig,this._ssaoTechnique),this._ssaoTechniqueConfig.output=1,this._blurTechnique=this._techniqueRep.releaseAndAcquire(u.SSAOTechnique,this._ssaoTechniqueConfig,this._blurTechnique)},d._enable=function(){this.enabled||(this._enabled=!0,this._loadResources((()=>{this._enabled&&this._initialize()})))},d._loadResources=function(t){this._data?t():new Promise((function(t,s){e(["./SSAOHelperData"],t,s)})).then((e=>{this._data=e,t()}))},d._initialize=function(){const e={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0},t={colorTarget:0,depthStencilTarget:0};a.requestImage(this._data.noiseTexture).then((s=>{this._enabled&&(this._ssaoFBO=new l(this._rctx,t,e),this._blur0FBO=new l(this._rctx,t,e),this._blur1FBO=new l(this._rctx,t,e),this._noiseTexture=new c(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,hasMipmap:!0,width:s.width,height:s.height},s),this._requestRender())})),this._selectPrograms()},d._disable=function(){this._enabled=!1,this._noiseTexture=s.disposeMaybe(this._noiseTexture),this._blur1FBO=s.disposeMaybe(this._blur1FBO),this._blur0FBO=s.disposeMaybe(this._blur0FBO),this._ssaoFBO=s.disposeMaybe(this._ssaoFBO)},t._createClass(i,[{key:"enabled",get:function(){return this._enabled},set:function(e){e?this._enable():this._disable()}},{key:"attenuation",get:function(){return this._attenuation},set:function(e){this._attenuation=e}},{key:"radius",get:function(){return this._radius},set:function(e){this._radius=e}},{key:"samples",get:function(){return this._samples},set:function(e){this._samples=e,this._enabled&&this._selectPrograms()}},{key:"ready",get:function(){return this.enabled&&s.isSome(this._noiseTexture)&&s.isSome(this._ssaoFBO)&&s.isSome(this._blur0FBO)&&s.isSome(this._blur1FBO)}},{key:"gpuMemoryUsage",get:function(){return(s.isSome(this._blur0FBO)?this._blur0FBO.gpuMemoryUsage:0)+(s.isSome(this._blur1FBO)?this._blur1FBO.gpuMemoryUsage:0)+(s.isSome(this._ssaoFBO)?this._ssaoFBO.gpuMemoryUsage:0)}},{key:"test",get:function(){return{ssao:this._ssaoFBO,blur:this._blur1FBO}}}]),i}();const m=i.create(),p=o.create();return d}));
