/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/time","../../../../chunks/vec2","./glUtil3D","./SSAOBlurTechnique","./SSAONoiseData","./SSAOTechnique","../../../../chunks/SSAO.glsl","../shaders/SSAOParameters","../../../webgl/enums","../../../webgl/FramebufferObject","../../../webgl/Texture","../../../webgl/Util"],(function(e,s,t,i,r,a,n,u,h,o,_,l,c,b,m){"use strict";const p=2;let T=function(){function e(e,s,t,i){this._view=e,this._techniqueRepository=s,this._rctx=t,this._requestRender=i,this._quadVAO=null,this._passParameters=new _.SSAOPassParameters,this._drawParameters=new _.BlurDrawParameters}var T=e.prototype;return T.dispose=function(){this.enabled=!1,this._quadVAO=t.disposeMaybe(this._quadVAO)},T.disposeOffscreenBuffers=function(){t.applySome(this._ssaoFBO,(e=>e.resize(0,0))),t.applySome(this._blur0FBO,(e=>e.resize(0,0))),t.applySome(this._blur1FBO,(e=>e.resize(0,0)))},T.render=function(e,s,i,n){if(t.isNone(this._enableTime)||t.isNone(i)||t.isNone(n)||t.isNone(this._ssaoFBO)||t.isNone(this._blur0FBO)||t.isNone(this._blur1FBO))return;if(!this.active)return this._enableTime=s,void this._requestRender();0===this._enableTime&&(this._enableTime=s);const u=this._rctx,h=e.camera,_=this._view.qualitySettings.fadeDuration,c=_>0?Math.min(_,s-this._enableTime)/_:1;this._passParameters.normalTexture=n,this._passParameters.depthTexture=i,this._passParameters.projScale=1/h.computeRenderPixelSizeAtDist(1),this._passParameters.intensity=4*d/o.getRadius(h)**6*c;const b=h.fullViewport,T=b[2],O=b[3],F=T/p,S=O/p;this._ssaoFBO.resize(T,O),this._blur0FBO.resize(F,S),this._blur1FBO.resize(F,S),t.isNone(this._quadVAO)&&(this._quadVAO=a.createQuadVAO(this._rctx)),u.bindFramebuffer(this._ssaoFBO),u.setViewport(0,0,T,O);u.bindTechnique(this._ssaoTechnique,this._passParameters,e).bindDraw(this._drawParameters,e,this._passParameters),u.bindVAO(this._quadVAO);const y=m.vertexCount(this._quadVAO,"geometry");u.drawArrays(l.PrimitiveType.TRIANGLE_STRIP,0,y);const B=u.bindTechnique(this._blurTechnique,this._passParameters,e);u.setViewport(0,0,F,S),u.bindFramebuffer(this._blur0FBO),this._drawParameters.colorTexture=this._ssaoFBO.colorTexture,r.set(this._drawParameters.blurSize,0,p/O),B.bindDraw(this._drawParameters,e,this._passParameters),u.setViewport(0,0,F,S),u.drawArrays(l.PrimitiveType.TRIANGLE_STRIP,0,y),u.bindFramebuffer(this._blur1FBO),this._drawParameters.colorTexture=this._blur0FBO.colorTexture,r.set(this._drawParameters.blurSize,p/T,0),B.bindDraw(this._drawParameters,e,this._passParameters),u.drawArrays(l.PrimitiveType.TRIANGLE_STRIP,0,y),u.setViewport(b[0],b[1],b[2],b[3]),c<1&&this._requestRender()},T._enable=function(){if(t.isSome(this._enableTime))return;const e={target:l.TextureType.TEXTURE_2D,pixelFormat:l.PixelFormat.RGBA,dataType:l.PixelType.UNSIGNED_BYTE,samplingMode:l.TextureSamplingMode.LINEAR,wrapMode:l.TextureWrapMode.CLAMP_TO_EDGE,width:0,height:0},s={colorTarget:l.TargetType.TEXTURE,depthStencilTarget:l.DepthStencilTargetType.NONE};this._ssaoFBO=new c.FramebufferObject(this._rctx,s,e),this._blur0FBO=new c.FramebufferObject(this._rctx,s,e),this._blur1FBO=new c.FramebufferObject(this._rctx,s,e);const r=Uint8Array.from(atob(u.noiseData),(e=>e.charCodeAt(0)));this._passParameters.noiseTexture=new b.Texture(this._rctx,{target:l.TextureType.TEXTURE_2D,pixelFormat:l.PixelFormat.RGB,dataType:l.PixelType.UNSIGNED_BYTE,hasMipmap:!0,width:32,height:32},r),t.isNone(this._ssaoTechnique)&&(this._ssaoTechnique=this._techniqueRepository.acquire(h.SSAOTechnique)),t.isNone(this._blurTechnique)&&(this._blurTechnique=this._techniqueRepository.acquire(n.SSAOBlurTechnique)),this._enableTime=i.Milliseconds(0),this._requestRender()},T._disable=function(){this._enableTime=null,this._passParameters.noiseTexture=t.disposeMaybe(this._passParameters.noiseTexture),this._blur1FBO=t.disposeMaybe(this._blur1FBO),this._blur0FBO=t.disposeMaybe(this._blur0FBO),this._ssaoFBO=t.disposeMaybe(this._ssaoFBO)},s._createClass(e,[{key:"enabled",get:function(){return t.isSome(this._enableTime)},set:function(e){e?this._enable():this._disable()}},{key:"active",get:function(){return this.enabled&&this._ssaoTechnique.compiled&&this._blurTechnique.compiled}},{key:"colorTexture",get:function(){return t.isSome(this._blur1FBO)?this._blur1FBO.colorTexture:null}},{key:"gpuMemoryUsage",get:function(){return(t.isSome(this._blur0FBO)?this._blur0FBO.gpuMemoryUsage:0)+(t.isSome(this._blur1FBO)?this._blur1FBO.gpuMemoryUsage:0)+(t.isSome(this._ssaoFBO)?this._ssaoFBO.gpuMemoryUsage:0)}},{key:"test",get:function(){return{ssao:this._ssaoFBO,blur:this._blur1FBO}}}]),e}();const d=.5;e.SSAOHelper=T,e.blurSizePixels=p,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
