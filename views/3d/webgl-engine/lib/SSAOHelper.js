/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["require","exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../chunks/vec2","../../../../support/requestImageUtils","./glUtil3D","./SSAOBlurTechnique","./SSAOTechnique","../shaders/SSAOParameters","../../../webgl/enums","../../../webgl/FramebufferObject","../../../webgl/Texture","../../../webgl/Util"],(function(e,s,t,i,r,a,u,h,o,n,_,l,b,c){"use strict";const d=2;let m=function(){function s(e,s,t){this._techniqueRepository=e,this._rctx=s,this._requestRender=t,this._enabled=!1,this._quadVAO=null,this._passParameters=new n.SSAOPassParameters,this._drawParameters=new n.BlurDrawParameters}var m=s.prototype;return m.dispose=function(){this._quadVAO=i.disposeMaybe(this._quadVAO)},m.disposeOffscreenBuffers=function(){i.applySome(this._ssaoFBO,(e=>e.resize(0,0))),i.applySome(this._blur0FBO,(e=>e.resize(0,0))),i.applySome(this._blur1FBO,(e=>e.resize(0,0)))},m.computeSSAO=function(e,s,t){if(!this.enabled||i.isNone(s)||i.isNone(t)||i.isNone(this._passParameters.noiseTexture)||i.isNone(this._ssaoFBO)||i.isNone(this._blur0FBO)||i.isNone(this._blur1FBO))return;const a=this._rctx,h=e.camera;this._passParameters.normalTexture=t,this._passParameters.depthTexture=s,this._passParameters.projScale=1/h.computeRenderPixelSizeAtDist(1);const o=h.fullViewport,n=o[2],l=o[3],b=n/d,m=l/d;this._ssaoFBO.resize(n,l),this._blur0FBO.resize(b,m),this._blur1FBO.resize(b,m),i.isNone(this._quadVAO)&&(this._quadVAO=u.createQuadVAO(this._rctx)),a.bindFramebuffer(this._ssaoFBO),a.setViewport(0,0,n,l);a.bindTechnique(this._ssaoTechnique,this._passParameters,e).bindDraw(this._drawParameters,e,this._passParameters),a.bindVAO(this._quadVAO),a.drawArrays(_.PrimitiveType.TRIANGLE_STRIP,0,c.vertexCount(this._quadVAO,"geometry"));const p=a.bindTechnique(this._blurTechnique,this._passParameters,e);a.setViewport(0,0,b,m),a.bindFramebuffer(this._blur0FBO),this._drawParameters.colorTexture=this._ssaoFBO.colorTexture,r.set(this._drawParameters.blurSize,0,d/l),p.bindDraw(this._drawParameters,e,this._passParameters),a.setViewport(0,0,b,m),a.drawArrays(_.PrimitiveType.TRIANGLE_STRIP,0,c.vertexCount(this._quadVAO,"geometry")),a.bindFramebuffer(this._blur1FBO),this._drawParameters.colorTexture=this._blur0FBO.colorTexture,r.set(this._drawParameters.blurSize,d/n,0),p.bindDraw(this._drawParameters,e,this._passParameters),a.drawArrays(_.PrimitiveType.TRIANGLE_STRIP,0,c.vertexCount(this._quadVAO,"geometry")),a.setViewport(o[0],o[1],o[2],o[3])},m._selectPrograms=function(){i.isNone(this._ssaoTechnique)&&(this._ssaoTechnique=this._techniqueRepository.acquire(o.SSAOTechnique)),i.isNone(this._blurTechnique)&&(this._blurTechnique=this._techniqueRepository.acquire(h.SSAOBlurTechnique))},m._enable=function(){this.enabled||(this._enabled=!0,this._loadResources((()=>{this._enabled&&this._initialize()})))},m._loadResources=function(s){this._data?s():new Promise(((s,t)=>e(["./SSAOHelperData"],s,t))).then((e=>{this._data=e,s()}))},m._initialize=function(){const e={target:_.TextureType.TEXTURE_2D,pixelFormat:_.PixelFormat.RGBA,dataType:_.PixelType.UNSIGNED_BYTE,samplingMode:_.TextureSamplingMode.LINEAR,wrapMode:_.TextureWrapMode.CLAMP_TO_EDGE,width:0,height:0},s={colorTarget:_.TargetType.TEXTURE,depthStencilTarget:_.DepthStencilTargetType.NONE};a.requestImage(this._data.noiseTexture).then((t=>{this._enabled&&(this._ssaoFBO=new l.FramebufferObject(this._rctx,s,e),this._blur0FBO=new l.FramebufferObject(this._rctx,s,e),this._blur1FBO=new l.FramebufferObject(this._rctx,s,e),this._passParameters.noiseTexture=new b.Texture(this._rctx,{target:_.TextureType.TEXTURE_2D,pixelFormat:_.PixelFormat.RGBA,dataType:_.PixelType.UNSIGNED_BYTE,hasMipmap:!0,width:t.width,height:t.height},t),this._requestRender())})),this._selectPrograms()},m._disable=function(){this._enabled=!1,this._passParameters.noiseTexture=i.disposeMaybe(this._passParameters.noiseTexture),this._blur1FBO=i.disposeMaybe(this._blur1FBO),this._blur0FBO=i.disposeMaybe(this._blur0FBO),this._ssaoFBO=i.disposeMaybe(this._ssaoFBO)},t._createClass(s,[{key:"enabled",get:function(){return this._enabled},set:function(e){e?this._enable():this._disable()}},{key:"ready",get:function(){return this.enabled&&i.isSome(this._passParameters.noiseTexture)&&i.isSome(this._ssaoFBO)&&i.isSome(this._blur0FBO)&&i.isSome(this._blur1FBO)}},{key:"loading",get:function(){return this.enabled&&!this.ready}},{key:"colorTexture",get:function(){return i.isSome(this._blur1FBO)?this._blur1FBO.colorTexture:null}},{key:"width",get:function(){return i.isSome(this._ssaoFBO)?this._ssaoFBO.width:-1}},{key:"height",get:function(){return i.isSome(this._ssaoFBO)?this._ssaoFBO.height:-1}},{key:"gpuMemoryUsage",get:function(){return(i.isSome(this._blur0FBO)?this._blur0FBO.gpuMemoryUsage:0)+(i.isSome(this._blur1FBO)?this._blur1FBO.gpuMemoryUsage:0)+(i.isSome(this._ssaoFBO)?this._ssaoFBO.gpuMemoryUsage:0)}},{key:"test",get:function(){return{ssao:this._ssaoFBO,blur:this._blur1FBO}}}]),s}();s.SSAOHelper=m,s.blurSizePixels=d,Object.defineProperties(s,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
