/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["require","exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../chunks/vec2f64","../../../../chunks/vec3","../../../../chunks/vec4f64","../../../../support/requestImageUtils","./glUtil3D","./SSAOTechnique","./Util","../../../../chunks/SSAO.glsl","../../../webgl/enums","../../../webgl/FramebufferObject","../../../webgl/Texture","../../../webgl/Util"],(function(e,t,i,s,r,n,o,u,h,a,l,_,c,b,f,d){"use strict";let p=function(){function t(e,t,i){this._techniqueRep=e,this._rctx=t,this._requestRender=i,this._enabled=!1,this._ssaoTechniqueConfig=new a.SSAOTechniqueConfiguration,this.quadVAO=null,this._blurSizePx=2,this._attenuation=.5}var r=t.prototype;return r.dispose=function(){this.quadVAO=s.disposeMaybe(this.quadVAO)},r.disposeOffscreenBuffers=function(){s.applySome(this._ssaoFBO,(e=>e.resize(0,0))),s.applySome(this._blur0FBO,(e=>e.resize(0,0))),s.applySome(this._blur1FBO,(e=>e.resize(0,0)))},r.computeSSAO=function(e,t,i){if(!this.enabled||s.isNone(t)||s.isNone(i)||s.isNone(this._noiseTexture)||s.isNone(this._ssaoFBO)||s.isNone(this._blur0FBO)||s.isNone(this._blur1FBO))return;const r=this._rctx,o=e.fullViewport,u=o[2],a=o[3],_=u/this._blurSizePx,b=a/this._blurSizePx;this._ssaoFBO.resize(u,a),this._blur0FBO.resize(_,b),this._blur1FBO.resize(_,b);const f=1,p=1,m=u*f,S=a*p;r.bindFramebuffer(this._ssaoFBO),r.setViewport(0,0,u,a);const x=r.useTechnique(this._ssaoTechnique);x.setUniform2f("rnmScale",u/this._noiseTexture.descriptor.width,a/this._noiseTexture.descriptor.height),l.inverseProjectionInfo(e.projectionMatrix,e.fullWidth,e.fullHeight,O,T),x.setUniform4fv("projInfo",O),x.setUniform2fv("zScale",T),x.setUniform2fv("nearFar",e.nearFar);let F=1/e.computeRenderPixelSizeAtDist(1);x.setUniform1f("projScale",F*f),x.setUniform2f("screenDimensions",m,S);const g=n.distance(e.eye,e.center);let B=20*e.computeRenderPixelSizeAtDist(g);B=Math.max(.1,B),x.setUniform1f("radius",B),x.setUniform1f("intensity",4*this._attenuation/B**6),x.bindTexture(this._noiseTexture,"rnm"),x.bindTexture(i,"normalMap"),x.bindTexture(t,"depthMap"),s.isNone(this.quadVAO)&&(this.quadVAO=h.createQuadVAO(this._rctx)),r.bindVAO(this.quadVAO),r.drawArrays(c.PrimitiveType.TRIANGLE_STRIP,0,d.vertexCount(this.quadVAO,"geometry"));const y=r.useTechnique(this._blurTechnique);y.bindTexture(this._ssaoFBO.colorTexture,"tex"),y.bindTexture(i,"normalMap"),y.bindTexture(t,"depthMap"),r.setViewport(0,0,m/this._blurSizePx,S/this._blurSizePx),r.bindFramebuffer(this._blur0FBO),y.setUniform2f("screenDimensions",m,S),y.setUniform2f("blurSize",0,this._blurSizePx*f/S),y.setUniform2fv("nearFar",e.nearFar),g>5e4&&(F=Math.max(0,F-(g-5e4))),y.setUniform1f("projScale",F),r.drawArrays(c.PrimitiveType.TRIANGLE_STRIP,0,d.vertexCount(this.quadVAO,"geometry")),y.setUniform2f("blurSize",this._blurSizePx*p/m,0),r.bindFramebuffer(this._blur1FBO),y.bindTexture(this._blur0FBO.colorTexture,"tex"),r.drawArrays(c.PrimitiveType.TRIANGLE_STRIP,0,d.vertexCount(this.quadVAO,"geometry")),r.setViewport(o[0],o[1],o[2],o[3])},r.bind=function(e,t){this.enabled&&s.isSome(this._blur1FBO)&&s.isSome(this._ssaoFBO)?(e.bindTexture(this._blur1FBO.colorTexture,"ssaoTex"),e.setUniform4f("viewportPixelSz",t.fullViewport[0],t.fullViewport[1],1/this._ssaoFBO.width,1/this._ssaoFBO.height)):e.setUniform4f("viewportPixelSz",-1,-1,-1,-1)},r._selectPrograms=function(){this._ssaoTechniqueConfig.output=_.SSAOOutput.SSAO,this._ssaoTechnique=this._techniqueRep.releaseAndAcquire(a.SSAOTechnique,this._ssaoTechniqueConfig,this._ssaoTechnique),this._ssaoTechniqueConfig.output=_.SSAOOutput.Blur,this._blurTechnique=this._techniqueRep.releaseAndAcquire(a.SSAOTechnique,this._ssaoTechniqueConfig,this._blurTechnique)},r._enable=function(){this.enabled||(this._enabled=!0,this._loadResources((()=>{this._enabled&&this._initialize()})))},r._loadResources=function(t){this._data?t():new Promise(((t,i)=>e(["./SSAOHelperData"],t,i))).then((e=>{this._data=e,t()}))},r._initialize=function(){const e={target:c.TextureType.TEXTURE_2D,pixelFormat:c.PixelFormat.RGBA,dataType:c.PixelType.UNSIGNED_BYTE,samplingMode:c.TextureSamplingMode.LINEAR,wrapMode:c.TextureWrapMode.CLAMP_TO_EDGE,width:0,height:0},t={colorTarget:c.TargetType.TEXTURE,depthStencilTarget:c.DepthStencilTargetType.NONE};u.requestImage(this._data.noiseTexture).then((i=>{this._enabled&&(this._ssaoFBO=new b.FramebufferObject(this._rctx,t,e),this._blur0FBO=new b.FramebufferObject(this._rctx,t,e),this._blur1FBO=new b.FramebufferObject(this._rctx,t,e),this._noiseTexture=new f.Texture(this._rctx,{target:c.TextureType.TEXTURE_2D,pixelFormat:c.PixelFormat.RGBA,dataType:c.PixelType.UNSIGNED_BYTE,hasMipmap:!0,width:i.width,height:i.height},i),this._requestRender())})),this._selectPrograms()},r._disable=function(){this._enabled=!1,this._noiseTexture=s.disposeMaybe(this._noiseTexture),this._blur1FBO=s.disposeMaybe(this._blur1FBO),this._blur0FBO=s.disposeMaybe(this._blur0FBO),this._ssaoFBO=s.disposeMaybe(this._ssaoFBO)},i._createClass(t,[{key:"enabled",get:function(){return this._enabled},set:function(e){e?this._enable():this._disable()}},{key:"ready",get:function(){return this.enabled&&s.isSome(this._noiseTexture)&&s.isSome(this._ssaoFBO)&&s.isSome(this._blur0FBO)&&s.isSome(this._blur1FBO)}},{key:"gpuMemoryUsage",get:function(){return(s.isSome(this._blur0FBO)?this._blur0FBO.gpuMemoryUsage:0)+(s.isSome(this._blur1FBO)?this._blur1FBO.gpuMemoryUsage:0)+(s.isSome(this._ssaoFBO)?this._ssaoFBO.gpuMemoryUsage:0)}},{key:"test",get:function(){return{ssao:this._ssaoFBO,blur:this._blur1FBO}}}]),t}();const T=r.create(),O=o.create();t.SSAOHelper=p,Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
