/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../chunks/vec4","../../../../chunks/vec4f64","../../../../geometry/support/ray","../../../ViewingMode","./IntersectorInterfaces","./intersectorUtils","./verticalOffsetUtils","../materials/renderers/utils"],(function(t,r,e,i,s,n,a,o,c,h,d,l,u,f,y){"use strict";const m=1e-5;let p=function(){function t(t){this.options=new l.IntersectorOptions,this._results=new _,this.transform=new f.IntersectorTransform,this.tolerance=m,this.verticalOffset=null,this._ray=h.create(),this._rayEnd=a.create(),this._rayBeginTransformed=a.create(),this._rayEndTransformed=a.create(),this.viewingMode=t??d.ViewingMode.Global}var i=t.prototype;return i.reset=function(t,r,e){this.resetWithRay(h.fromPoints(t,r,this._ray),e)},i.resetWithRay=function(t,r){this.camera=r,t!==this._ray&&h.copy(t,this._ray),0!==this.options.verticalOffset?this.viewingMode===d.ViewingMode.Local?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,n.add(this._rayEnd,this._ray.origin,this._ray.direction),this._results.init(this._ray)},i.intersect=function(t=null,r,i,s,n){this.point=r,this.filterPredicate=s,this.tolerance=i??m;const a=f.getVerticalOffsetObject3D(this.verticalOffset);if(e.isSome(t)&&t.length>0){const r=n?t=>{n(t)&&this.intersectObject(t)}:t=>{this.intersectObject(t)};for(const i of t){const t=i.getSpatialQueryAccelerator&&i.getSpatialQueryAccelerator();e.isSome(t)?(e.isSome(a)?t.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,r,a):t.forEachAlongRay(this._ray.origin,this._ray.direction,r),this.options.selectionMode&&this.options.hud&&t.forEachDegenerateObject(r)):i.objects.forAll((t=>r(t)))}}this.sortResults()},i.intersectObject=function(t){const r=t.geometryRecords;if(!r)return;const i=t.transformation,a=f.getVerticalOffsetObject3D(this.verticalOffset);for(const o of r){const{geometry:r,material:c,instanceParameters:h}=o;if(y.isInstanceHidden(h))continue;const d=r.id;this.transform.setAndInvalidateLazyTransforms(i,o.getShaderTransformation()),n.transformMat4(this._rayBeginTransformed,this.rayBegin,this.transform.inverse),n.transformMat4(this._rayEndTransformed,this.rayEnd,this.transform.inverse);const u=this.transform.transform;e.isSome(a)&&(a.objectTransform=this.transform),c.intersect(r,h,this.transform.transform,this,this._rayBeginTransformed,this._rayEndTransformed,((r,i,n,a,o,c)=>{if(r>=0){if(e.isSome(this.filterPredicate)&&!this.filterPredicate(this._ray.origin,this._rayEnd,r))return;const h=a?this._results.hud:this._results,f=a?a=>{const h={object:t,geometryId:d,triangleNr:n,center:e.isSome(c)?[c[0],c[1],c[2]]:null};a.set(l.IntersectorType.HUD,h,r,i,s.IDENTITY,o)}:e=>e.set(l.IntersectorType.OBJECT,{object:t,geometryId:d,triangleNr:n},r,i,u,o);if((null==h.min.drapedLayerOrder||o>=h.min.drapedLayerOrder)&&(null==h.min.dist||r<h.min.dist)&&f(h.min),this.options.store!==l.StoreResults.MIN&&(null==h.max.drapedLayerOrder||o<h.max.drapedLayerOrder)&&(null==h.max.dist||r>h.max.dist)&&f(h.max),this.options.store===l.StoreResults.ALL)if(a){const t=new L(this._ray);f(t),this._results.hud.all.push(t)}else{const t=new O(this._ray);f(t),this._results.all.push(t)}}}),o.shaderTransformation)}},i.sortResults=function(t=this._results.all){t.sort(((t,r)=>t.dist!==r.dist?e.unwrapOr(t.dist,0)-e.unwrapOr(r.dist,0):t.drapedLayerOrder!==r.drapedLayerOrder?e.unwrapOr(t.drapedLayerOrder,Number.MAX_VALUE)-e.unwrapOr(r.drapedLayerOrder,Number.MAX_VALUE):e.unwrapOr(r.drapedLayerGraphicOrder,Number.MIN_VALUE)-e.unwrapOr(t.drapedLayerGraphicOrder,Number.MIN_VALUE)))},r._createClass(t,[{key:"results",get:function(){return this._results}},{key:"ray",get:function(){return this._ray}},{key:"rayBegin",get:function(){return this._ray.origin}},{key:"rayEnd",get:function(){return this._rayEnd}}]),t}();function g(t){return new p(t)}let _=function(){function t(){this.min=new O(h.create()),this.max=new O(h.create()),this.hud={min:new L(h.create()),max:new L(h.create()),all:new Array},this.ground=new O(h.create()),this.all=[]}return t.prototype.init=function(t){this.min.init(t),this.max.init(t),this.ground.init(t),this.all.length=0,this.hud.min.init(t),this.hud.max.init(t),this.hud.all.length=0},t}(),O=function(){function t(t){this.intersector=l.IntersectorType.OBJECT,this.normal=a.create(),this.transformation=s.create(),this._ray=h.create(),this.init(t)}var c=t.prototype;return c.getIntersectionPoint=function(t){return!!u.isValidIntersectorResult(this)&&(n.scale(T,this.ray.direction,this.dist),n.add(t,this.ray.origin,T),!0)},c.getTransformedNormal=function(t){return n.copy(I,this.normal),I[3]=0,o.transformMat4(I,I,this.transformation),n.copy(t,I),n.normalize(t,t)},c.init=function(t){this.dist=null,this.target=null,this.drapedLayerOrder=null,this.drapedLayerGraphicOrder=null,this.intersector=l.IntersectorType.OBJECT,h.copy(t,this._ray)},c.set=function(t,r,o,c,h,d,l){this.intersector=t,this.dist=o,n.copy(this.normal,e.unwrapOr(c,a.UNIT_Z)),i.copy(this.transformation,e.unwrapOr(h,s.IDENTITY)),this.target=r,this.drapedLayerOrder=d,this.drapedLayerGraphicOrder=l},c.copy=function(t){h.copy(t.ray,this._ray),this.intersector=t.intersector,this.dist=t.dist,this.target=t.target,this.drapedLayerOrder=t.drapedLayerOrder,this.drapedLayerGraphicOrder=t.drapedLayerGraphicOrder,n.copy(this.normal,t.normal),i.copy(this.transformation,t.transformation)},r._createClass(t,[{key:"ray",get:function(){return this._ray}},{key:"distanceInRenderSpace",get:function(){return e.isSome(this.dist)?(n.scale(T,this.ray.direction,this.dist),n.length(T)):null}}]),t}(),L=function(t){function e(){var r;return(r=t.apply(this,arguments)||this).intersector=l.IntersectorType.HUD,r}return r._inheritsLoose(e,t),e}(O);function w(t){return new O(t)}const T=a.create(),I=c.create();t.DEFAULT_TOLERANCE=m,t.newIntersector=g,t.newIntersectorResult=w,Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
