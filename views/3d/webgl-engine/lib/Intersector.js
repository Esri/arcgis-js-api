/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../chunks/vec4","../../../../chunks/vec4f64","../../../../geometry/support/ray","../../../ViewingMode","./IntersectorInterfaces","./intersectorUtils","./verticalOffsetUtils","../materials/renderers/utils"],(function(t,r,e,s,i,n,a,o,c,h,d,u,l,f,y){"use strict";const m=1e-5;let p=function(){function t(t){this.options=new u.IntersectorOptions,this._results=new g,this.transform=new f.IntersectorTransform,this.tolerance=m,this.verticalOffset=null,this._ray=h.create(),this._rayEnd=a.create(),this._rayBeginTransformed=a.create(),this._rayEndTransformed=a.create(),this.viewingMode=null==t?d.ViewingMode.Global:t}var s=t.prototype;return s.reset=function(t,r,e){this.resetWithRay(h.fromPoints(t,r,this._ray),e)},s.resetWithRay=function(t,r){this.camera=r,t!==this._ray&&h.copy(t,this._ray),0!==this.options.verticalOffset?this.viewingMode===d.ViewingMode.Local?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,n.add(this._rayEnd,this._ray.origin,this._ray.direction),this._results.init(this._ray)},s.intersect=function(t=null,r,s,i,n){this.point=r,this.filterPredicate=i,this.tolerance=null==s?m:s;const a=f.getVerticalOffsetObject3D(this.verticalOffset);if(e.isSome(t)&&t.length>0){const r=n?t=>{n(t)&&this.intersectObject(t)}:t=>{this.intersectObject(t)};for(const s of t){const t=s.getSpatialQueryAccelerator&&s.getSpatialQueryAccelerator();e.isSome(t)?(e.isSome(a)?t.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,r,a):t.forEachAlongRay(this._ray.origin,this._ray.direction,r),this.options.selectionMode&&this.options.hud&&t.forEachDegenerateObject(r)):s.objects.forAll((t=>r(t)))}}this.sortResults()},s.intersectObject=function(t){const r=t.geometryRecords;if(!r)return;const s=t.transformation,a=f.getVerticalOffsetObject3D(this.verticalOffset);for(const o of r){const{geometry:r,material:c,instanceParameters:h}=o;if(y.isInstanceHidden(h))continue;const d=r.id;this.transform.setAndInvalidateLazyTransforms(s,o.getShaderTransformation()),n.transformMat4(this._rayBeginTransformed,this.rayBegin,this.transform.inverse),n.transformMat4(this._rayEndTransformed,this.rayEnd,this.transform.inverse);const l=this.transform.transform;e.isSome(a)&&(a.objectTransform=this.transform),c.intersect(r,h,this.transform.transform,this,this._rayBeginTransformed,this._rayEndTransformed,((r,s,n,a,o,c)=>{if(r>=0){if(e.isSome(this.filterPredicate)&&!this.filterPredicate(this._ray.origin,this._rayEnd,r))return;if(a){if(null==this._results.hud.dist||r<this._results.hud.dist){const e={object:t,geometryId:d,triangleNr:n,center:c};this._results.hud.set(u.IntersectorType.HUD,e,r,s,i.IDENTITY,o)}return}const h=e=>e.set(u.IntersectorType.OBJECT,{object:t,geometryId:d,triangleNr:n},r,s,l,o);if((null==this._results.min.drapedLayerOrder||o>=this._results.min.drapedLayerOrder)&&(null==this._results.min.dist||r<this._results.min.dist)&&h(this._results.min),this.options.store!==u.StoreResults.MIN&&(null==this._results.max.drapedLayerOrder||o<this._results.max.drapedLayerOrder)&&(null==this._results.max.dist||r>this._results.max.dist)&&h(this._results.max),this.options.store===u.StoreResults.ALL){const e=T(this._ray);e.set(u.IntersectorType.OBJECT,{object:t,geometryId:d,triangleNr:n},r,s,l),this._results.all.push(e)}}}),o.shaderTransformation)}},s.sortResults=function(){this._results.all.sort(((t,r)=>t.dist!==r.dist?e.unwrapOr(t.dist,0)-e.unwrapOr(r.dist,0):t.drapedLayerOrder!==r.drapedLayerOrder?e.unwrapOr(t.drapedLayerOrder,Number.MAX_VALUE)-e.unwrapOr(r.drapedLayerOrder,Number.MAX_VALUE):e.unwrapOr(r.drapedLayerGraphicOrder,Number.MIN_VALUE)-e.unwrapOr(t.drapedLayerGraphicOrder,Number.MIN_VALUE)))},r._createClass(t,[{key:"results",get:function(){return this._results}},{key:"ray",get:function(){return this._ray}},{key:"rayBegin",get:function(){return this._ray.origin}},{key:"rayEnd",get:function(){return this._rayEnd}}]),t}();function _(t){return new p(t)}let g=function(){function t(){this._min=new O(h.create()),this._max=new O(h.create()),this._hud=new O(h.create()),this._ground=new O(h.create())}return t.prototype.init=function(t){this._min.init(t),this._max.init(t),this._hud.init(t),this._ground.init(t),this.all=[]},r._createClass(t,[{key:"min",get:function(){return this._min}},{key:"max",get:function(){return this._max}},{key:"hud",get:function(){return this._hud}},{key:"ground",get:function(){return this._ground}}]),t}(),O=function(){function t(t){this.intersector=u.IntersectorType.OBJECT,this.normal=a.create(),this.transformation=i.create(),this._ray=h.create(),this.init(t)}var c=t.prototype;return c.getIntersectionPoint=function(t){return!!l.isValidIntersectorResult(this)&&(n.scale(L,this.ray.direction,this.dist),n.add(t,this.ray.origin,L),!0)},c.getTransformedNormal=function(t){return n.copy(I,this.normal),I[3]=0,o.transformMat4(I,I,this.transformation),n.copy(t,I),n.normalize(t,t)},c.init=function(t){this.dist=null,this.target=null,this.drapedLayerOrder=null,this.drapedLayerGraphicOrder=null,this.intersector=u.IntersectorType.OBJECT,h.copy(t,this._ray)},c.set=function(t,r,o,c,h,d,u){this.intersector=t,this.dist=o,n.copy(this.normal,e.unwrapOr(c,a.UNIT_Z)),s.copy(this.transformation,e.unwrapOr(h,i.IDENTITY)),this.target=r,this.drapedLayerOrder=d,this.drapedLayerGraphicOrder=u},c.copy=function(t){h.copy(t.ray,this._ray),this.intersector=t.intersector,this.dist=t.dist,this.target=t.target,this.drapedLayerOrder=t.drapedLayerOrder,this.drapedLayerGraphicOrder=t.drapedLayerGraphicOrder,n.copy(this.normal,t.normal),s.copy(this.transformation,t.transformation)},r._createClass(t,[{key:"ray",get:function(){return this._ray}},{key:"distanceInRenderSpace",get:function(){return e.isSome(this.dist)?(n.scale(L,this.ray.direction,this.dist),n.length(L)):null}}]),t}();function T(t){return new O(t)}const L=a.create(),I=c.create();t.DEFAULT_TOLERANCE=m,t.newIntersector=_,t.newIntersectorResult=T,Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
