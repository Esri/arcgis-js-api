/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/has","../../../../core/maybe","../../../../chunks/mat4f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/support/ray","./IntersectorInterfaces","./intersectorUtils","./verticalOffsetUtils","../materials/renderers/utils"],(function(t,r,e,s,i,n,a,o,c,h,d,l){"use strict";const f=1e-5;let u=function(){function t(t){this.options=new c.IntersectorOptions,this.results=new h.IntersectorResults,this.transform=new d.IntersectorTransform,this.performanceInfo={queryDuration:0,numObjectsTested:0},this.tolerance=f,this.verticalOffset=null,this._ray={origin:a.create(),direction:a.create()},this._rayEndPoint=a.create(),this._rayStartPointTransformed=a.create(),this._rayEndPointTransformed=a.create(),this.viewingMode=null==t?1:t}var e=t.prototype;return e.reset=function(t,r){this.resetWithRay(o.fromPoints(t,r,this._ray))},e.resetWithRay=function(t){t!==this._ray&&o.copy(t,this._ray),0!==this.options.verticalOffset?2===this.viewingMode?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,n.add(this._rayEndPoint,this._ray.origin,this._ray.direction),this._numObjectsTested=0,this.results.init(this._ray)},e.intersect=function(t=null,r,e,i,n,a){this.point=r,this.camera=e,this.filterPredicate=n,this.tolerance=null==i?f:i;const o=d.getVerticalOffsetObject3D(this.verticalOffset);if(s.isSome(t)&&t.length>0){const r=a?t=>{a(t)&&this.intersectObject(t)}:t=>{this.intersectObject(t)};for(const e of t){const t=e.getSpatialQueryAccelerator&&e.getSpatialQueryAccelerator();s.isSome(t)?(s.isSome(o)?t.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,r,o):t.forEachAlongRay(this._ray.origin,this._ray.direction,r),this.options.selectionMode&&this.options.hud&&t.forEachDegenerateObject(r)):e.objects.forAll((t=>r(t)))}}this.sortResults()},e.intersectObject=function(t){this._numObjectsTested++;const r=t.geometryRecords;if(!r)return;const e=t.id,a=t.transformation;let o;const c=d.getVerticalOffsetObject3D(this.verticalOffset);for(const d of r){const{geometry:r,material:f,instanceParameters:u}=d;if(l.isInstanceHidden(u))continue;o=r.id,this.transform.setAndInvalidateLazyTransforms(a,d.getShaderTransformation()),n.transformMat4(this._rayStartPointTransformed,this._ray.origin,this.transform.inverse),n.transformMat4(this._rayEndPointTransformed,this._rayEndPoint,this.transform.inverse);const y=this.transform.transform;s.isSome(c)&&(c.objectTransform=this.transform),f.intersect(r,u,this.transform.transform,this,this._rayStartPointTransformed,this._rayEndPointTransformed,((r,n,a,c,d,l)=>{if(r>=0){if(s.isSome(this.filterPredicate)&&!this.filterPredicate(this._ray.origin,this._rayEndPoint,r))return;const f=`Object3D ${e}`;if(d)return void((null==this.results.hud.dist||r<this.results.hud.dist)&&this.results.hud.set(t,f,r,n,i.IDENTITY,c,l,o,a));const u=e=>e.set(t,f,r,n,y,c,null,o,a);if((null==this.results.min.drapedLayerOrder||c>=this.results.min.drapedLayerOrder)&&(null==this.results.min.dist||r<this.results.min.dist)&&u(this.results.min),0!==this.options.store&&(null==this.results.max.drapedLayerOrder||c<this.results.max.drapedLayerOrder)&&(null==this.results.max.dist||r>this.results.max.dist)&&u(this.results.max),2===this.options.store){const t=new h.IntersectorResult(this._ray);u(t),this.results.all.push(t)}}}),d.shaderTransformation)}},e.sortResults=function(){this.results.all.sort(((t,r)=>t.dist!==r.dist?t.dist-r.dist:t.drapedLayerOrder!==r.drapedLayerOrder?(void 0!==t.drapedLayerOrder?t.drapedLayerOrder:Number.MAX_VALUE)-(void 0!==r.drapedLayerOrder?r.drapedLayerOrder:Number.MAX_VALUE):(void 0!==r.drapedLayerGraphicOrder?r.drapedLayerGraphicOrder:Number.MIN_VALUE)-(void 0!==t.drapedLayerGraphicOrder?t.drapedLayerGraphicOrder:Number.MIN_VALUE)))},r._createClass(t,[{key:"ray",get:function(){return this._ray}},{key:"rayBeginPoint",get:function(){return this._ray.origin}},{key:"rayEndPoint",get:function(){return this._rayEndPoint}}]),t}();u.DEFAULT_TOLERANCE=f,t.Intersector=u,Object.defineProperty(t,"__esModule",{value:!0})}));
