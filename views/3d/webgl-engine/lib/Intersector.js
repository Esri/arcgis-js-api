/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../chunks/vec4","../../../../chunks/vec4f64","../../../../geometry/support/ray","../../../ViewingMode","./IntersectorInterfaces","./IntersectorTarget","./intersectorUtils","./verticalOffsetUtils"],(function(t,r,e,i,s,n,a,o,c,h,d,l,u,f,y){"use strict";const p=1e-5;let m=function(){function t(t){this.options=new l.IntersectorOptions,this._results=new O,this.transform=new y.IntersectorTransform,this.tolerance=p,this.verticalOffset=null,this._ray=h.create(),this._rayEnd=a.create(),this._rayBeginTransformed=a.create(),this._rayEndTransformed=a.create(),this.viewingMode=t??d.ViewingMode.Global}var i=t.prototype;return i.reset=function(t,r,e){this.resetWithRay(h.fromPoints(t,r,this._ray),e)},i.resetWithRay=function(t,r){this.camera=r,t!==this._ray&&h.copy(t,this._ray),0!==this.options.verticalOffset?this.viewingMode===d.ViewingMode.Local?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,n.add(this._rayEnd,this._ray.origin,this._ray.direction),this._results.init(this._ray)},i.intersect=function(t=null,r,i,s,n){this.point=r,this.filterPredicate=s,this.tolerance=i??p;const a=y.getVerticalOffsetObject3D(this.verticalOffset);if(e.isSome(t)&&t.length>0){const r=n?t=>{n(t)&&this.intersectObject(t)}:t=>{this.intersectObject(t)};for(const i of t){const t=i.getSpatialQueryAccelerator&&i.getSpatialQueryAccelerator();e.isSome(t)?(e.isSome(a)?t.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,r,a):t.forEachAlongRay(this._ray.origin,this._ray.direction,r),this.options.selectionMode&&this.options.hud&&t.forEachDegenerateObject(r)):i.objects.forAll((t=>r(t)))}}this.sortResults()},i.intersectObject=function(t){const r=t.geometries;if(!r)return;const i=t.transformation,a=y.getVerticalOffsetObject3D(this.verticalOffset);for(const o of r){if(!o.visible)continue;const{material:r,id:c}=o;this.transform.setAndInvalidateLazyTransforms(i,o.shaderTransformation),n.transformMat4(this._rayBeginTransformed,this.rayBegin,this.transform.inverse),n.transformMat4(this._rayEndTransformed,this.rayEnd,this.transform.inverse);const h=this.transform.transform;e.isSome(a)&&(a.objectTransform=this.transform),r.intersect(o,this.transform.transform,this,this._rayBeginTransformed,this._rayEndTransformed,((r,i,n,a,o,d)=>{if(r>=0){if(e.isSome(this.filterPredicate)&&!this.filterPredicate(this._ray.origin,this._rayEnd,r))return;const f=a?this._results.hud:this._results,y=a?e=>{const a=new u.HudTarget(t,c,n,d);e.set(l.IntersectorType.HUD,a,r,i,s.IDENTITY,o)}:e=>e.set(l.IntersectorType.OBJECT,{object:t,geometryId:c,triangleNr:n},r,i,h,o);if((null==f.min.drapedLayerOrder||o>=f.min.drapedLayerOrder)&&(null==f.min.dist||r<f.min.dist)&&y(f.min),this.options.store!==l.StoreResults.MIN&&(null==f.max.drapedLayerOrder||o<f.max.drapedLayerOrder)&&(null==f.max.dist||r>f.max.dist)&&y(f.max),this.options.store===l.StoreResults.ALL)if(a){const t=new w(this._ray);y(t),this._results.hud.all.push(t)}else{const t=new _(this._ray);y(t),this._results.all.push(t)}}}))}},i.sortResults=function(t=this._results.all){t.sort(((t,r)=>t.dist!==r.dist?e.unwrapOr(t.dist,0)-e.unwrapOr(r.dist,0):t.drapedLayerOrder!==r.drapedLayerOrder?e.unwrapOr(t.drapedLayerOrder,Number.MAX_VALUE)-e.unwrapOr(r.drapedLayerOrder,Number.MAX_VALUE):e.unwrapOr(r.drapedLayerGraphicOrder,Number.MIN_VALUE)-e.unwrapOr(t.drapedLayerGraphicOrder,Number.MIN_VALUE)))},r._createClass(t,[{key:"results",get:function(){return this._results}},{key:"ray",get:function(){return this._ray}},{key:"rayBegin",get:function(){return this._ray.origin}},{key:"rayEnd",get:function(){return this._rayEnd}}]),t}();function g(t){return new m(t)}let O=function(){function t(){this.min=new _(h.create()),this.max=new _(h.create()),this.hud={min:new w(h.create()),max:new w(h.create()),all:new Array},this.ground=new _(h.create()),this.all=[]}return t.prototype.init=function(t){this.min.init(t),this.max.init(t),this.ground.init(t),this.all.length=0,this.hud.min.init(t),this.hud.max.init(t),this.hud.all.length=0},t}(),_=function(){var t=c.prototype;function c(t){this.intersector=l.IntersectorType.OBJECT,this.normal=a.create(),this.transformation=s.create(),this._ray=h.create(),this.init(t)}return t.getIntersectionPoint=function(t){return!!f.isValidIntersectorResult(this)&&(n.scale(T,this.ray.direction,this.dist),n.add(t,this.ray.origin,T),!0)},t.getTransformedNormal=function(t){return n.copy(I,this.normal),I[3]=0,o.transformMat4(I,I,this.transformation),n.copy(t,I),n.normalize(t,t)},t.init=function(t){this.dist=null,this.target=null,this.drapedLayerOrder=null,this.drapedLayerGraphicOrder=null,this.intersector=l.IntersectorType.OBJECT,h.copy(t,this._ray)},t.set=function(t,r,o,c,h,d,l){this.intersector=t,this.dist=o,n.copy(this.normal,e.unwrapOr(c,a.UNIT_Z)),i.copy(this.transformation,e.unwrapOr(h,s.IDENTITY)),this.target=r,this.drapedLayerOrder=d,this.drapedLayerGraphicOrder=l},t.copy=function(t){h.copy(t.ray,this._ray),this.intersector=t.intersector,this.dist=t.dist,this.target=t.target,this.drapedLayerOrder=t.drapedLayerOrder,this.drapedLayerGraphicOrder=t.drapedLayerGraphicOrder,n.copy(this.normal,t.normal),i.copy(this.transformation,t.transformation)},r._createClass(c,[{key:"ray",get:function(){return this._ray}},{key:"distanceInRenderSpace",get:function(){return e.isSome(this.dist)?(n.scale(T,this.ray.direction,this.dist),n.length(T)):null}}]),c}(),w=function(t){function e(){var r;return(r=t.apply(this,arguments)||this).intersector=l.IntersectorType.HUD,r}return r._inheritsLoose(e,t),e}(_);function L(t){return new _(t)}const T=a.create(),I=c.create();t.DEFAULT_TOLERANCE=p,t.newIntersector=g,t.newIntersectorResult=L,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
