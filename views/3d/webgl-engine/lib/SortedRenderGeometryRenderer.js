/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/has","../../../../core/maybe","../../../../core/Logger","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/decorators/subclass","../../../../core/urlUtils","../../../../core/uuid","../../../../portal/support/resourceExtension","../../../../core/PooledArray","../../../../core/Accessor","../../../../core/MapUtils","./Material","./ChangeSet","./rendererUtils","../materials/renderers/MergedRenderer"],(function(e,r,t,s,i,n,a,d,o,h,c,l,p,u,g,m,_,R,f){"use strict";e.SortedRenderGeometryRenderer=function(e){function t(){var r;return(r=e.apply(this,arguments)||this)._pendingAddsRemoves=new Map,r._changes=new _.ChangeSet,r._materialRenderers=new Map,r._sortedMaterialRenderers=new p,r._hasHighlights=!1,r._hasWater=!1,r}r._inheritsLoose(t,e);var s=t.prototype;return s.dispose=function(){this._changes.prune(),this._materialRenderers&&(this._materialRenderers.forEach((e=>e.dispose())),this._materialRenderers.clear(),this._sortedMaterialRenderers.clear())},s.stopAnimationsAtTime=function(e){this._sortedMaterialRenderers.forAll((r=>i.applySome(r.material.animation,(r=>r.stopAtTime(e)))))},s.commitChanges=function(){let e=!1;if(!this.updating)return!1;this.updateAddsRemoves();const r=R.splitRenderGeometryChangeSetByMaterial(this._changes);let t=!1,s=!1;return r.forEach(((r,i)=>{let n=this._materialRenderers.get(i);if(!n&&r.adds.length>0&&(n=new f(this.rctx,this.materialRepository,i),this._materialRenderers.set(i,n),e=!0,t=!0,s=!0),!n)return;const a=t||n.hasHighlights,d=s||n.hasWater;n.modify(r),t=t||a!==n.hasHighlights,s=s||d!==n.hasWater,n.isEmpty&&(this._materialRenderers.delete(i),n.dispose(),e=!0)})),this._changes.clear(),this._pendingAddsRemoves.clear(),e&&this.updateSortedMaterialRenderers(),t&&(this._hasHighlights=g.someMap(this._materialRenderers,(e=>e.hasHighlights))),s&&(this._hasWater=g.someMap(this._materialRenderers,(e=>e.hasWater))),this.notifyChange("updating"),!0},s.add=function(e){if(0===e.length)return;const r=0===this._pendingAddsRemoves.size;for(const t of e)this._pendingAddsRemoves.set(t,0);r&&this.notifyChange("updating")},s.remove=function(e){const r=0===this._pendingAddsRemoves.size;for(const t of e){const e=this._pendingAddsRemoves.get(t);0===e?this._pendingAddsRemoves.set(t,2):2!==e&&this._pendingAddsRemoves.set(t,1)}r&&this._pendingAddsRemoves.size>0&&this.notifyChange("updating")},s.modify=function(e,r){const t=0===this._changes.updates.length;for(const s of e){const e=this._changes.updates.pushNew();e.renderGeometry=s,e.updateType=r}t&&this._changes.updates.length>0&&this.notifyChange("updating")},s.updateLogic=function(e){let r=!1;return this._sortedMaterialRenderers.forAll((({materialRenderer:t})=>{t.updateLogic&&t.updateLogic(e)&&(r=!0)})),r},s.draw=function(e,r){for(let t=0;t<this._sortedMaterialRenderers.length;t++){const s=this._sortedMaterialRenderers.data[t];m.materialPredicate(s.material,e)&&s.materialRenderer.render(null,e,r,null)}},s.updateSortedMaterialRenderers=function(){this._sortedMaterialRenderers.clear();let e=0;this._materialRenderers.forEach(((r,t)=>{t.insertOrder=e++,this._sortedMaterialRenderers.push({material:t,materialRenderer:r})})),this._sortedMaterialRenderers.sort(((e,r)=>{const t=r.material.renderPriority-e.material.renderPriority;return 0!==t?t:e.material.insertOrder-r.material.insertOrder}))},s.updateAddsRemoves=function(){this._changes.adds.clear(),this._changes.removes.clear(),this._pendingAddsRemoves.forEach(((e,r)=>{switch(e){case 0:this._changes.adds.push(r);break;case 1:this._changes.removes.push(r)}}));let e=0;for(;e<this._changes.updates.length;){const r=this._changes.updates.data[e].renderGeometry;this._pendingAddsRemoves.has(r)?this._changes.updates.removeUnorderedIndex(e):e++}},r._createClass(t,[{key:"updating",get:function(){return this._pendingAddsRemoves.size>0||this._changes.updates.length>0}},{key:"hasHighlights",get:function(){return this._hasHighlights}},{key:"hasWater",get:function(){return this._hasWater}},{key:"rendersOccluded",get:function(){return g.someMap(this._materialRenderers,(e=>e.rendersOccluded))}},{key:"isEmpty",get:function(){return!this.updating&&0===this._materialRenderers.size}},{key:"test",get:function(){return{sortedMaterialRenderers:this._sortedMaterialRenderers}}}]),t}(u),t.__decorate([d.property()],e.SortedRenderGeometryRenderer.prototype,"rctx",void 0),t.__decorate([d.property()],e.SortedRenderGeometryRenderer.prototype,"materialRepository",void 0),t.__decorate([d.property()],e.SortedRenderGeometryRenderer.prototype,"updating",null),e.SortedRenderGeometryRenderer=t.__decorate([o.subclass("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],e.SortedRenderGeometryRenderer),Object.defineProperty(e,"__esModule",{value:!0})}));
