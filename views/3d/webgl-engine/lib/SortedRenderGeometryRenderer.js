/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/MapUtils","../../../../core/maybe","../../../../core/PooledArray","../../../../core/accessorSupport/decorators/property","../../../../core/arrayUtils","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec3f64","./ChangeSet","./Intersector","./IntersectorInterfaces","./ModelDirtyTypes","./rendererUtils","../materials/renderers/MergedRenderer"],(function(e,r,t,i,s,n,a,o,d,h,c,l,u,p,m,g,y,_){"use strict";e.SortedRenderGeometryRenderer=function(e){function t(r){var t;return(t=e.call(this,r)||this)._pending=new f,t._changes=new u.ChangeSet,t._materialRenderers=new Map,t._sortedMaterialRenderers=new a,t._geometries=new Map,t._hasHighlights=!1,t._hasWater=!1,t}r._inheritsLoose(t,e);var i=t.prototype;return i.destroy=function(){this._changes.prune(),this._materialRenderers.forEach((e=>e.dispose())),this._materialRenderers.clear(),this._sortedMaterialRenderers.clear(),this._geometries.clear()},i.commitChanges=function(){if(!this.updating)return!1;this._processAddsRemoves();const e=y.splitRenderGeometryChangeSetByMaterial(this._changes);let r=!1,t=!1,i=!1;return e.forEach(((e,s)=>{let n=this._materialRenderers.get(s);if(!n&&e.adds.length>0&&(n=new _.MergedRenderer(this.rctx,this._materialRepository,s),this._materialRenderers.set(s,n),r=!0,t=!0,i=!0),!n)return;const a=t||n.hasHighlights,o=i||n.hasWater;n.modify(e),t=t||a!==n.hasHighlights,i=i||o!==n.hasWater,n.isEmpty&&(this._materialRenderers.delete(s),n.dispose(),r=!0)})),this._changes.clear(),r&&this._updateSortedMaterialRenderers(),t&&(this._hasHighlights=s.someMap(this._materialRenderers,(e=>e.hasHighlights))),i&&(this._hasWater=s.someMap(this._materialRenderers,(e=>e.hasWater))),this.notifyChange("updating"),!0},i.addGeometries=function(e,r){if(0===e.length)return;const t=this._validateRenderGeometries(e);for(const s of t)this._geometries.set(s.id,s);const i=this._pending.empty;for(const s of t)this._pending.adds.add(s);i&&this.notifyChange("updating"),r===g.DirtyOperation.UPDATE&&this._notifyGraphicGeometryChanged(e)},i.removeGeometries=function(e,r){const t=this._pending.empty,i=this._pending.adds;for(const s of e)i.has(s)?(this._pending.removed.add(s),i.delete(s)):this._pending.removed.has(s)||this._pending.removes.add(s),this._geometries.delete(n.unwrap(s.id));t&&!this._pending.empty&&this.notifyChange("updating"),r===g.DirtyOperation.UPDATE&&this._notifyGraphicGeometryChanged(e)},i.modifyGeometries=function(e,r){const t=0===this._changes.updates.length;for(const i of e){const e=this._changes.updates.pushNew();e.renderGeometry=this._validateRenderGeometry(i),e.updateType=r}switch(t&&this._changes.updates.length>0&&this.notifyChange("updating"),r){case g.DirtyState.TRANSFORMATION:case g.DirtyState.VERTEXATTRS:return this._notifyGraphicGeometryChanged(e);case g.DirtyState.VISIBILITIES:return this._notifyGraphicVisibilityChanged(e)}},i.updateAnimation=function(e){let r=!1;return this._sortedMaterialRenderers.forAll((({materialRenderer:t})=>r=t.updateAnimation(e)||r)),r},i.render=function(e,r){for(let t=0;t<this._sortedMaterialRenderers.length;t++){const i=this._sortedMaterialRenderers.data[t];i.material.shouldRender(e)&&i.materialRenderer.render(e.output,r)}},i.intersect=function(e,r,t,i,s){return this._geometries.forEach((n=>{if(i&&!i(n))return;this._intersectRenderGeometry(n,t,r,0,e,s);const a=this.rendererContext.longitudeCyclical;a&&(n.boundingSphere[0]-n.boundingSphere[3]<a.min&&this._intersectRenderGeometry(n,t,r,a.range,e,s),n.boundingSphere[0]+n.boundingSphere[3]>a.max&&this._intersectRenderGeometry(n,t,r,-a.range,e,s)),s++})),s},i._updateSortedMaterialRenderers=function(){this._sortedMaterialRenderers.clear();let e=0;this._materialRenderers.forEach(((r,t)=>{t.insertOrder=e++,this._sortedMaterialRenderers.push({material:t,materialRenderer:r})})),this._sortedMaterialRenderers.sort(((e,r)=>{const t=r.material.renderPriority-e.material.renderPriority;return 0!==t?t:e.material.insertOrder-r.material.insertOrder}))},i._processAddsRemoves=function(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes));for(let e=0;e<this._changes.updates.length;){const r=this._changes.updates.data[e];this._pending.has(r.renderGeometry)?this._changes.updates.removeUnorderedIndex(e):e++}this._pending.clear()},i._intersectRenderGeometry=function(e,r,t,i,s,a){if(!e.instanceParameters.visible)return;let o=0;n.isSome(e.transformation)&&(i+=e.transformation[12],o=e.transformation[13]),S[0]=t[0]-i,S[1]=t[1]-o,S[2]=1,G[0]=t[0]-i,G[1]=t[1]-o,G[2]=0,e.screenToWorldRatio=this.rendererContext.screenToWorldRatio,e.material.intersect(e,null,e.getShaderTransformation(),s,S,G,((t,i,n)=>{R(r,n,e.material.renderPriority,a,s,e.layerUid,e.graphicUid)}),e.calculateShaderTransformation,r)},i._notifyGraphicGeometryChanged=function(e){if(n.isNone(this.drapeSource.notifyGraphicGeometryChanged))return;let r;for(const t of e){const e=t.graphicUid;n.isSome(e)&&e!==r&&(this.drapeSource.notifyGraphicGeometryChanged(e),r=e)}},i._notifyGraphicVisibilityChanged=function(e){if(n.isNone(this.drapeSource.notifyGraphicVisibilityChanged))return;let r;for(const t of e){const e=t.graphicUid;n.isSome(e)&&e!==r&&(this.drapeSource.notifyGraphicVisibilityChanged(e),r=e)}},i._validateRenderGeometries=function(e){for(const r of e)this._validateRenderGeometry(r);return e},i._validateRenderGeometry=function(e){return n.isNone(e.origin)&&(e.origin=this._localOriginFactory.getOrigin(e.boundingSphere)),e},r._createClass(t,[{key:"updating",get:function(){return!this._pending.empty||this._changes.updates.length>0}},{key:"rctx",get:function(){return this.rendererContext.rctx}},{key:"_materialRepository",get:function(){return this.rendererContext.materialRepository}},{key:"_localOriginFactory",get:function(){return this.rendererContext.localOriginFactory}},{key:"hasHighlights",get:function(){return this._hasHighlights}},{key:"hasWater",get:function(){return this._hasWater}},{key:"rendersOccluded",get:function(){return s.someMap(this._materialRenderers,(e=>e.rendersOccluded))}},{key:"isEmpty",get:function(){return!this.updating&&0===this._materialRenderers.size&&0===this._geometries.size}},{key:"test",get:function(){return{sortedMaterialRenderers:this._sortedMaterialRenderers}}}]),t}(i),t.__decorate([o.property()],e.SortedRenderGeometryRenderer.prototype,"drapeSource",void 0),t.__decorate([o.property()],e.SortedRenderGeometryRenderer.prototype,"updating",null),t.__decorate([o.property()],e.SortedRenderGeometryRenderer.prototype,"rctx",null),t.__decorate([o.property()],e.SortedRenderGeometryRenderer.prototype,"rendererContext",void 0),t.__decorate([o.property()],e.SortedRenderGeometryRenderer.prototype,"_materialRepository",null),t.__decorate([o.property()],e.SortedRenderGeometryRenderer.prototype,"_localOriginFactory",null),e.SortedRenderGeometryRenderer=t.__decorate([c.subclass("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],e.SortedRenderGeometryRenderer);let f=function(){function e(){this.adds=new Set,this.removes=new Set,this.removed=new Set}var t=e.prototype;return t.has=function(e){return this.adds.has(e)||this.removes.has(e)||this.removed.has(e)},t.clear=function(){this.adds.clear(),this.removes.clear(),this.removed.clear()},r._createClass(e,[{key:"empty",get:function(){return 0===this.adds.size&&0===this.removes.size&&0===this.removed.size}}]),e}();function R(e,r,t,i,s,n,a){const o={layerUid:n,graphicUid:a,triangleNr:r},d=r=>{r.set(m.IntersectorType.OVERLAY,o,e.dist,e.normal,e.transformation,t,i)};if((null==s.results.min.drapedLayerOrder||t>=s.results.min.drapedLayerOrder)&&(null==s.results.min.dist||s.results.ground.dist<=s.results.min.dist)&&d(s.results.min),s.options.store!==m.StoreResults.MIN&&(null==s.results.max.drapedLayerOrder||t<s.results.max.drapedLayerOrder)&&(null==s.results.max.dist||s.results.ground.dist>s.results.max.dist)&&d(s.results.max),s.options.store===m.StoreResults.ALL){const e=p.newIntersectorResult(s.ray);d(e),s.results.all.push(e)}}const S=l.create(),G=l.create();Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
