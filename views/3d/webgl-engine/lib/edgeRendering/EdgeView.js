/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/has","../../../../../core/typedArrayUtil","../../../../../core/maybe","../../../../../core/arrayUtils","../../../../../core/promiseUtils","../../../../../core/mathUtils","../../../../../chunks/vec3f64","../../../../../chunks/vec3","../../../../../chunks/mat4","../../../../../chunks/mat3f64","../../../../../chunks/mat4f64","../../../../../chunks/mat3","../../../../webgl/BufferObject","../../../../webgl/VertexArrayObject","../Object3D","../GridLocalOriginFactory","../../core/shaderLibrary/attributes/VertexPosition.glsl","../../../../../chunks/vec33","../../core/util/TwoVectorPosition","../TextureBackedBuffer/BufferManager","../localOriginHelper","../LocalOriginManager","./bufferLayouts","./edgeBufferWriters","./EdgeRenderer","./EdgeWorkerHandle","./strokes","./util"],(function(e,t,r,n,s,i,o,a,c,d,l,u,g,h,f,m,p,b,y,E,O,x,w,v,R,T,M,j,C,k){"use strict";let I=function(){function e(e,t,r,n){this.rctx=e,this.techniqueRepository=t,this.callbacks=r,this.profilingCallback=null,this.perObjectData=new Map,this.renderers=new Map,this.localOrigins=new v.LocalOriginManager(new b),this.numberOfRenderedEdges=0,this.gpuMemoryUsage=0,this.workerAbort=o.createAbortController(),this.destroyed=!1,this.tmpModelPosition=c.create(),this.tmpCameraPosition=c.create(),this.componentColorManager=new x.BufferManager(this.rctx,2),this.worker=new j(n);const s=R.VertexLayout.createBuffer(4);for(let e=0;e<4;e++)s.sideness.set(e,0,0===e||3===e?0:1),s.sideness.set(e,1,0===e||1===e?0:1);this.verticesBufferObject=f.createVertex(this.rctx,35044,s.buffer)}var r=e.prototype;return r.destroy=function(){this.destroyed||(this.perObjectData.forEach(((e,t)=>{this.perObjectData.delete(t),e.renderables.forEach((e=>{this.removeRenderable(e)}))})),this.strokesTexture=s.disposeMaybe(this.strokesTexture),this.componentColorManager=s.destroyMaybe(this.componentColorManager),this.workerAbort.abort(),this.worker.destroy(),this.verticesBufferObject=s.disposeMaybe(this.verticesBufferObject),this.perObjectData.clear(),this.renderers.clear(),this.destroyed=!0)},r.getUsedMemory=function(){return this.gpuMemoryUsage},r.shouldRender=function(){return this.renderers.size>0},r.addComponentObject=async function(e,t,r,n,s,i,a,c){if(this.hasObject(e))return;let d;const l=new B(o.create((e=>d=e)),r);this.perObjectData.set(e,l),await this.addComponentGeometry(t,l,n,s,i,a,c),this.callbacks.setNeedsRender(),d()},r.addOrUpdateObject3D=async function(e,t,r,n){const s=new Array;let a;const c=new B(o.create((e=>a=e))),d=this.perObjectData.get(e);if(this.perObjectData.set(e,c),r.mergeGeometries&&e.geometries.length>1&&function(e){let t=null,r=null;for(let n=0;n<e.geometries.length;n++){const s=e.geometryRecords[n];if(s.material.supportsEdges){if(t){if(!i.equals(t,s.transformation))return!1}else t=s.transformation;if(!r&&s.origin)r=s;else if(r&&s.origin&&r.origin.id!==s.origin.id)return!1}}return!0}(e))s.push(this.addObjectMergedGeometries(e,c,t,r,n));else for(let i=0;i<e.geometries.length;i++){const o=e.geometries[i],a=e.geometryRecords[i];a.material.supportsEdges&&s.push(this.addGeometryData(e,c,o.data,a,t[0],r,n))}await o.all(s),d&&d.waitLoaded((()=>{d.renderables.forEach((e=>this.removeRenderable(e))),this.callbacks.setNeedsRender()})),this.callbacks.setNeedsRender(),a()},r.hasObject=function(e){return this.perObjectData.has(e)},r.updateAllComponentOpacities=async function(e,t){const r=t instanceof Array?e=>t[e]:()=>t;(await this.getObjectEntry(e)).renderables.forEach((e=>{const t=e.components.meta.length;for(let n=0;n<t;n++){const t=r(n),s=e.components.meta[n],i=s.index;s.material.opacity=t,e.components.buffer.textureBuffer.setDataElement(i,1,3,255*t)}this.updateTransparency(e)})),this.callbacks.setNeedsRender()},r.updateAllComponentMaterials=async function(e,t,r,n){const s=e instanceof p,i=!!r.slicePlaneEnabled,o=k.determineRendererType(t),a=M.EdgeRenderer.getKey(o,i,s);(await this.getObjectEntry(e)).renderables.forEach((e=>{if(a!==e.rendererKey){const t=this.renderers.get(e.rendererKey),r=this.acquireRenderer(o,i,s);t.removeRenderable(e),t.refCount.decrement(),e.rendererKey=a,r.addRenderable(e)}for(let r=0;r<t.length;r++)e.components.meta[r].material=t[r];n&&this.updateComponentBuffer(e.components),this.updateTransparency(e)})),this.callbacks.setNeedsRender()},r.updateObjectVisibility=async function(e,t){(await this.getObjectEntry(e)).renderables.forEach((e=>e.visible=t)),this.callbacks.setNeedsRender()},r.removeObject=function(e){const t=this.perObjectData.get(e);t&&(this.perObjectData.delete(e),t.waitLoaded((()=>{t.renderables.forEach((e=>this.removeRenderable(e))),this.callbacks.setNeedsRender()})))},r.getObjectEntry=async function(e){const t=this.perObjectData.get(e);if(!t)throw"no object";return await t.loaded,t},r.removeAll=function(){this.perObjectData.forEach(((e,t)=>this.removeObject(t)))},r.render=function(e,t){if(s.isNone(this.componentColorManager))return;this.localOrigins.updateViewMatrices(e.camera.viewMatrix);const r=e.camera.viewInverseTransposeMatrix,n=c.create(),i=new O.TwoVectorPosition,o=new y.VertexPosition.ViewProjectionTransform,a=u.create();d.set(n,r[3],r[7],r[11]),i.set(n),d.copy(o.worldFromView_TH,i.high),d.copy(o.worldFromView_TL,i.low),h.fromMat4(o.viewFromCameraRelative_RS,e.camera.viewMatrix),l.copy(o.projFromView,e.camera.projectionMatrix);const g=u.create();h.transpose(g,o.viewFromCameraRelative_RS),h.invert(a,g),this.renderers.forEach((e=>{0===e.refCount.value&&(this.renderers.delete(e.key),e.dispose())})),this.componentColorManager.garbageCollect(),this.componentColorManager.updateTextures();let f=0,m=0;if(this.renderers.forEach((e=>e.forEachRenderable((e=>{f+=e.statistics.averageEdgeLength,m++}),t))),0===m)return;const p={distanceFalloffFactor:40*f/m,minimumEdgeLength:k.estimateLengthAtDistance(e.camera.fullViewport[3],e.camera.fovY,1,3.5*e.camera.pixelRatio),transparency:t,viewProjectionTransform:o,transformNormal_ViewFromGlobal:a};this.updateObjectCameraDistances(e),this.numberOfRenderedEdges=0,this.renderers.forEach((t=>{this.renderRegularEdges(t,e,p),this.renderSilhouetteEdges(t,e,p)}))},r.updateTransparency=function(e){const t=k.determineEdgeTransparency(e.components.meta),r=k.determineObjectTransparency(e.components.meta);t===e.edgeTransparency&&r===e.objectTransparency||(e.edgeTransparency=t,e.objectTransparency=r,this.renderers.get(e.rendererKey).setRenderablesDirty())},r.computeModelTransformWithLocalOrigin=function(e,t,r){if(e.getCombinedStaticTransformation(t,r),t.origin)this.localOrigins.register(t.origin);else{const e=d.set(this.tmpModelPosition,r[12],r[13],r[14]);t.origin=this.localOrigins.acquire(e)}return w.applyToModelMatrix(t.origin.vec3,r),r},r.updateComponentBuffer=function(e){const{meta:t,buffer:r}=e;for(let e=0;e<t.length;e++){const n=t[e].material,s=t[e].index,i=a.clamp(Math.round(n.size*M.LINE_WIDTH_FRACTION_FACTOR),0,255),o=a.clamp(n.extensionLength,-M.EXTENSION_LENGTH_OFFSET,255-M.EXTENSION_LENGTH_OFFSET)+M.EXTENSION_LENGTH_OFFSET,c="solid"===n.type?0:1,d=255*n.opacity,l=n.color,u=255*l[0],g=255*l[1],h=255*l[2],f=255*l[3];r.textureBuffer.setData(s,0,u,g,h,f),r.textureBuffer.setData(s,1,i,o,c,d)}},r.createComponentBuffers=function(e){if(s.isNone(this.componentColorManager))return null;const t=new Array,r=this.componentColorManager.getBuffer(e.length);for(let n=0;n<e.length;n++){const s=e[n],i=r.acquireIndex();t.push({index:i,material:s})}const n={meta:t,buffer:r};return this.updateComponentBuffer(n),n},r.extractEdges=function(e,t,r,n,s){return this.worker.process({data:t,originalIndices:s,writerSettings:e,skipDeduplicate:r},this.workerAbort.signal,n)},r.createEdgeResources=function(e){const t={};if(s.isNone(this.verticesBufferObject))return t;if(e.regular.lodInfo.lengths.length>0){const r=new m(this.rctx,R.EdgeShaderAttributeLocations,{vertices:R.glVertexLayout,instances:T.RegularEdgeBufferWriter.glLayout},{vertices:this.verticesBufferObject,instances:f.createVertex(this.rctx,35044,e.regular.instancesData.buffer)});t.regular={vao:r,lod:e.regular.lodInfo}}if(e.silhouette.lodInfo.lengths.length>0){const r=new m(this.rctx,R.EdgeShaderAttributeLocations,{vertices:R.glVertexLayout,instances:T.SilhouetteEdgeBufferWriter.glLayout},{vertices:this.verticesBufferObject,instances:f.createVertex(this.rctx,35044,e.silhouette.instancesData.buffer)});t.silhouette={vao:r,lod:e.silhouette.lodInfo}}return t},r.addGeometryData=async function(e,t,r,n,s,i,o){const a=r.getAttribute("position"),c=this.computeModelTransformWithLocalOrigin(e,n,g.create()),d=n.origin,l={position:a,indices:r.getIndices("position"),modelTransform:c,origin:d};return this.addPositionData(t,l,s,i,o)},r.addPositionData=async function(e,t,r,n,i=!1){const o=this.createComponentBuffers([r]);if(s.isNone(o))return;const a=this.acquireRenderer(r.type,!!n.slicePlaneEnabled),{modelTransform:c,origin:d,indices:l}=t,u=t.position,g=u.data.length/u.strideIdx,h=R.EdgeInputBufferLayout.createBuffer(g);for(let e=0;e<g;e++)h.position.set(e,0,u.data[u.offsetIdx+e*u.strideIdx+0]),h.position.set(e,1,u.data[u.offsetIdx+e*u.strideIdx+1]),h.position.set(e,2,u.data[u.offsetIdx+e*u.strideIdx+2]);k.fillComponenBufferIndices(o.meta,[0,h.componentIndex.count],h.componentIndex);const f=await this.extractEdges(a.writerSettings,h,!1,i,l),{regular:m,silhouette:p}=this.createEdgeResources(f),b=(m?m.vao.size:0)+(p?p.vao.size:0),y={regular:m,silhouette:p,transform:{modelMatrix:c,origin:d},statistics:{gpuMemoryUsage:b,averageEdgeLength:f.averageEdgeLength},components:o,visible:!0,edgeTransparency:k.determineEdgeTransparency(o.meta),objectTransparency:k.determineObjectTransparency(o.meta),distanceToCamera:0,rendererKey:a.key};e.renderables.push(y),a.addRenderable(y),this.gpuMemoryUsage+=b},r.addComponentGeometry=async function(e,t,r,n,i,o,a){const c=this.createComponentBuffers(o);if(s.isNone(c))return;const d=k.determineRendererType(o),l=this.acquireRenderer(d,a.slicePlaneEnabled||!1,!1),u=R.EdgeInputBufferLayout.createBuffer(r.count);E.copy(u.position,r),k.fillComponenBufferIndices(c.meta,i,u.componentIndex,n);const g=l.writerSettings,h=await this.extractEdges(g,u,!0,!1,n),{regular:f,silhouette:m}=this.createEdgeResources(h),p=(f?f.vao.size:0)+(m?m.vao.size:0),b={regular:f,silhouette:m,transform:e,statistics:{gpuMemoryUsage:p,averageEdgeLength:h.averageEdgeLength},components:c,visible:!0,edgeTransparency:k.determineEdgeTransparency(c.meta),objectTransparency:k.determineObjectTransparency(c.meta),distanceToCamera:0,rendererKey:l.key};t.renderables.push(b),l.addRenderable(b),this.gpuMemoryUsage+=p},r.addObjectMergedGeometries=async function(e,t,r,s,i){const o=new Map;let a=0,c=null,d=null;for(let t=0;t<e.geometries.length;t++){const r=e.geometries[t],s=e.geometryRecords[t];if(!s.material.supportsEdges)continue;!d&&s.origin&&(d=s);const i=r.data.getIndices("position");a+=i?i.length:0,(i&&null==c||c===Uint16Array)&&(c=n.isUint16Array(i)?Uint16Array:Uint32Array)}const l=a?new c(a):null,u=[];let h=0;for(let t=0;t<e.geometries.length;t++){const r=e.geometries[t];if(!e.geometryRecords[t].material.supportsEdges)continue;const n=r.data.getAttribute("position"),s=r.data.getIndices("position");let i=o.get(n.data);if(null==i){i=u.length/3;for(let e=n.offsetIdx;e<n.data.length;e+=n.strideIdx)u.push(n.data[e+0]),u.push(n.data[e+1]),u.push(n.data[e+2]);o.set(n.data,i)}if(s)for(let e=0;e<s.length;e++)l[h++]=i+s[e]}const f=d||e.geometryRecords[0],m=this.computeModelTransformWithLocalOrigin(e,f,g.create()),p=f.origin;for(let t=0;t<e.geometryRecords.length;t++)e.geometryRecords[t].origin=p;const b={position:{data:u,offsetIdx:0,strideIdx:3},indices:l,modelTransform:m,origin:p};await this.addPositionData(t,b,r[0],s,i)},r.acquireRenderer=function(e,t,r=!0){const n=M.EdgeRenderer.getKey(e,t,r);let i=this.renderers.get(n);return s.isNone(this.strokesTexture)&&(this.strokesTexture=C.generateStrokesTexture(this.rctx)),i||(i=new M.EdgeRenderer(this.rctx,this.techniqueRepository,{type:e,slicePlaneEnabled:t,strokesTexture:this.strokesTexture,legacy:r}),this.renderers.set(n,i)),i.refCount.increment(),i},r.removeRenderable=function(e){const t=this.renderers.get(e.rendererKey);if(t){t.removeRenderable(e),t.refCount.decrement(),function(e){e.regular&&(e.regular.vao.vertexBuffers.instances.dispose(),e.regular.vao.dispose(!1),e.regular.vao=null);e.silhouette&&(e.silhouette.vao.vertexBuffers.instances.dispose(),e.silhouette.vao.dispose(!1),e.silhouette.vao=null)}(e),"origin"in e.transform&&this.localOrigins.release(e.transform.origin),this.gpuMemoryUsage-=e.statistics.gpuMemoryUsage;for(const t of e.components.meta)e.components.buffer.releaseIndex(t.index)}},r.updateObjectCameraDistances=function(e){const t=e.camera.viewInverseTransposeMatrix;d.set(this.tmpCameraPosition,t[3],t[7],t[11]),this.perObjectData.forEach(((e,t)=>{const r=s.isSome(e.center)?e.center:t.getCenter(),n=d.distance(r,this.tmpCameraPosition);e.renderables.forEach((e=>e.distanceToCamera=n))}))},r.renderRegularEdges=function(e,t,r){e.bindRegularEdges(t,r);const n=r.transparency;e.forEachRenderable((n=>{if(!n.visible||!n.regular)return;const s=k.computeEdgeCount(n.regular.lod.lengths,n.distanceToCamera,r);"origin"in n.transform&&(t.localViewMatrixForEdges=this.localOrigins.getViewMatrix(n.transform.origin)),e.renderRegularEdges(n,t,s),this.numberOfRenderedEdges+=s}),n)},r.renderSilhouetteEdges=function(e,t,r){e.bindSilhouetteEdges(t,r);const n=r.transparency;e.forEachRenderable((n=>{if(!n.visible||!n.silhouette)return;const s=k.computeEdgeCount(n.silhouette.lod.lengths,n.distanceToCamera,r);"origin"in n.transform&&(t.localViewMatrixForEdges=this.localOrigins.getViewMatrix(n.transform.origin)),e.renderSilhouetteEdges(n,t,s),this.numberOfRenderedEdges+=s}),n)},t._createClass(e,[{key:"numberOfRenderedPrimitives",get:function(){return this.numberOfRenderedEdges}}]),e}();let B=function(){function e(e,t=null){this.center=t,this.renderables=new Array,this.loaded=e,this.loaded.then((()=>this.loaded=!0))}return e.prototype.waitLoaded=function(e){!0===this.loaded?e():this.loaded.then((()=>e()))},e}();e.EdgeView=I,Object.defineProperty(e,"__esModule",{value:!0})}));
