/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../core/has","../../../../../core/typedArrayUtil","../../../../../core/maybe","../../../../../core/Logger","../../../../../core/accessorSupport/ensureType","../../../../../core/accessorSupport/decorators/property","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/urlUtils","../../../../../core/uuid","../../../../../portal/support/resourceExtension","../../../../../core/arrayUtils","../../../../../core/promiseUtils","../../../../../core/Accessor","../../../../../core/mathUtils","../../../../../chunks/vec3f64","../../../../../chunks/vec3","../../../../../chunks/mat4","../../../../support/WatchUpdatingTracking","../../../../../chunks/mat3f64","../../../../../chunks/mat4f64","../../../../../chunks/mat3","../../../../../chunks/sphere","../../../../webgl/BufferObject","../../../../webgl/VertexArrayObject","../Object3D","../GridLocalOriginFactory","../../core/shaderLibrary/attributes/VertexPosition.glsl","../../../../../chunks/vec33","../../core/util/TwoVectorPosition","../TextureBackedBuffer/BufferManager","../localOriginHelper","../LocalOriginManager","./bufferLayouts","./edgeBufferWriters","./EdgeRenderer","./EdgeWorkerHandle","./strokes","./util"],(function(e,t,r,n,s,i,o,a,c,d,l,u,g,h,p,f,m,y,b,E,w,O,v,T,R,x,j,M,C,L,k,B,P,V,_,D,N,A,I,S,H){"use strict";function U(e){e.regular&&(e.regular.vao.vertexBuffers.instances.dispose(),e.regular.vao.dispose(!1),e.regular.vao=null),e.silhouette&&(e.silhouette.vao.vertexBuffers.instances.dispose(),e.silhouette.vao.dispose(!1),e.silhouette.vao=null)}function F(e){let t=null,r=null;for(let n=0;n<e.geometries.length;n++){const s=e.geometryRecords[n];if(s.material.supportsEdges){if(t){if(!h.equals(t,s.transformation))return!1}else t=s.transformation;if(!r&&s.origin)r=s;else if(r&&s.origin&&r.origin.id!==s.origin.id)return!1}}return!0}e.EdgeView=function(e){function r(t){var r;return(r=e.call(this,t)||this).updatingHandles=new w.WatchUpdatingTracking,r.perObjectData=new Map,r.renderers=new Map,r.localOrigins=new _.LocalOriginManager(new C),r.numberOfRenderedEdges=0,r.gpuMemoryUsage=0,r.workerAbort=p.createAbortController(),r.tmpModelPosition=y.create(),r.tmpCameraPosition=y.create(),r}t._inheritsLoose(r,e);var n=r.prototype;return n.initialize=function(){this.worker=new I(this.scheduler),this.componentColorManager=new P.BufferManager(this.rctx,2);const e=D.VertexLayout.createBuffer(4);for(let t=0;t<4;t++)e.sideness.set(t,0,0===t||3===t?0:1),e.sideness.set(t,1,0===t||1===t?0:1);this.verticesBufferObject=x.createVertex(this.rctx,35044,e.buffer)},n.destroy=function(){this.destroyed||(this.perObjectData.forEach(((e,t)=>{this.perObjectData.delete(t),e.renderables.forEach((e=>{this.removeRenderable(e)}))})),this.strokesTexture=i.disposeMaybe(this.strokesTexture),this.componentColorManager=i.destroyMaybe(this.componentColorManager),this.workerAbort.abort(),this.worker.destroy(),this.verticesBufferObject=i.disposeMaybe(this.verticesBufferObject),this.perObjectData.clear(),this.renderers.clear(),this.updatingHandles.destroy())},n.shouldRender=function(){return this.renderers.size>0},n.addComponentObject=async function(e,t,r,n,s,i,o,a){if(this.hasObject(e))return;let c;const d=new z(new Promise((e=>c=e)),r);this.perObjectData.set(e,d),await this.updatingHandles.addPromise(this.addComponentGeometry(t,d,n,s,i,o,a)),this.setNeedsRender(),c()},n.addOrUpdateObject3D=async function(e,t,r,n){const s=new Array;let i;const o=new z(new Promise((e=>i=e))),a=this.perObjectData.get(e);if(this.perObjectData.set(e,o),r.mergeGeometries&&e.geometries.length>1&&F(e))s.push(this.addObjectMergedGeometries(e,o,t,r,n));else for(let c=0;c<e.geometries.length;c++){const i=e.geometries[c],a=e.geometryRecords[c];a.material.supportsEdges&&s.push(this.addGeometry(e,o,i,a,t[0],r,n))}await this.updatingHandles.addPromise(Promise.all(s)),a&&a.waitLoaded((()=>{a.renderables.forEach((e=>this.removeRenderable(e))),this.setNeedsRender()}),this.updatingHandles),this.setNeedsRender(),i()},n.hasObject=function(e){return this.perObjectData.has(e)},n.updateAllComponentOpacities=async function(e,t){const r=t instanceof Array?e=>t[e]:()=>t;(await this.updatingHandles.addPromise(this.getObjectEntry(e))).renderables.forEach((e=>{const t=e.components.meta.length;for(let n=0;n<t;n++){const t=r(n),s=e.components.meta[n],i=s.index;s.material.opacity=t,e.components.buffer.textureBuffer.setDataElement(i,1,3,255*t)}this.updateTransparency(e)})),this.setNeedsRender()},n.updateAllComponentMaterials=async function(e,t,r,n){const s=e instanceof M.Object3D,i=!!r.slicePlaneEnabled,o=H.determineRendererType(t),a=A.EdgeRenderer.getKey(o,i,s);(await this.updatingHandles.addPromise(this.getObjectEntry(e))).renderables.forEach((e=>{if(a!==e.rendererKey){const t=this.renderers.get(e.rendererKey),r=this.acquireRenderer(o,i,s);t.removeRenderable(e),t.refCount.decrement(),e.rendererKey=a,r.addRenderable(e)}for(let r=0;r<t.length;r++)e.components.meta[r].material=t[r];n&&this.updateComponentBuffer(e.components),this.updateTransparency(e)})),this.setNeedsRender()},n.updateObjectVisibility=async function(e,t){(await this.updatingHandles.addPromise(this.getObjectEntry(e))).renderables.forEach((e=>e.visible=t)),this.setNeedsRender()},n.removeObject=function(e){const t=this.perObjectData.get(e);t&&(this.perObjectData.delete(e),t.waitLoaded((()=>{t.renderables.forEach((e=>this.removeRenderable(e))),this.setNeedsRender()}),this.updatingHandles))},n.getObjectEntry=async function(e){const t=this.perObjectData.get(e);if(!t)throw"no object";return await t.loaded,t},n.removeAll=function(){this.perObjectData.forEach(((e,t)=>this.removeObject(t)))},n.render=function(e,t){if(i.isNone(this.componentColorManager))return;this.localOrigins.updateViewMatrices(e.camera.viewMatrix);const r=e.camera.viewInverseTransposeMatrix,n=y.create(),s=new B.TwoVectorPosition,o=new L.VertexPosition.ViewProjectionTransform,a=O.create();b.set(n,r[3],r[7],r[11]),s.set(n),b.copy(o.worldFromView_TH,s.high),b.copy(o.worldFromView_TL,s.low),T.fromMat4(o.viewFromCameraRelative_RS,e.camera.viewMatrix),E.copy(o.projFromView,e.camera.projectionMatrix);const c=O.create();T.transpose(c,o.viewFromCameraRelative_RS),T.invert(a,c),this.renderers.forEach((e=>{0===e.refCount.value&&(this.renderers.delete(e.key),e.dispose())})),this.componentColorManager.garbageCollect(),this.componentColorManager.updateTextures();let d=0,l=0;if(this.renderers.forEach((e=>e.forEachRenderable((e=>{d+=e.statistics.averageEdgeLength,l++}),t))),0===l)return;const u={distanceFalloffFactor:40*d/l,minimumEdgeLength:H.estimateLengthAtDistance(e.camera.fullViewport[3],e.camera.fovY,1,3.5*e.camera.pixelRatio),transparency:t,viewProjectionTransform:o,transformNormal_ViewFromGlobal:a};this.updateObjectCameraDistances(e),this.numberOfRenderedEdges=0,this.renderers.forEach((t=>{this.renderRegularEdges(t,e,u),this.renderSilhouetteEdges(t,e,u)}))},n.updateTransparency=function(e){const t=H.determineEdgeTransparency(e.components.meta),r=H.determineObjectTransparency(e.components.meta);t===e.edgeTransparency&&r===e.objectTransparency||(e.edgeTransparency=t,e.objectTransparency=r,this.renderers.get(e.rendererKey).setRenderablesDirty())},n.computeModelTransformWithLocalOrigin=function(e,t,r){if(e.getCombinedStaticTransformation(t,r),t.origin)this.localOrigins.register(t.origin);else{const e=b.set(this.tmpModelPosition,r[12],r[13],r[14]);t.origin=this.localOrigins.acquire(e)}return V.applyToModelMatrix(t.origin.vec3,r),r},n.updateComponentBuffer=function(e){const{meta:t,buffer:r}=e;for(let n=0;n<t.length;n++){const e=t[n].material,s=t[n].index,i=m.clamp(Math.round(e.size*A.LINE_WIDTH_FRACTION_FACTOR),0,255),o=m.clamp(e.extensionLength,-A.EXTENSION_LENGTH_OFFSET,255-A.EXTENSION_LENGTH_OFFSET)+A.EXTENSION_LENGTH_OFFSET,a="solid"===e.type?0:1,c=255*e.opacity,d=e.color,l=255*d[0],u=255*d[1],g=255*d[2],h=255*d[3];r.textureBuffer.setData(s,0,l,u,g,h),r.textureBuffer.setData(s,1,i,o,a,c)}},n.createComponentBuffers=function(e){if(i.isNone(this.componentColorManager))return null;const t=new Array,r=this.componentColorManager.getBuffer(e.length);for(let s=0;s<e.length;s++){const n=e[s],i=r.acquireIndex();t.push({index:i,material:n})}const n={meta:t,buffer:r};return this.updateComponentBuffer(n),n},n.extractEdges=function(e,t,r,n,s,i=s.length){return this.worker.process({data:t,indices:s,indicesLength:i,writerSettings:e,skipDeduplicate:r},this.workerAbort.signal,n)},n.createEdgeResources=function(e){const t={};if(i.isNone(this.verticesBufferObject))return t;if(e.regular.lodInfo.lengths.length>0){const r=new j(this.rctx,D.EdgeShaderAttributeLocations,{vertices:D.glVertexLayout,instances:N.RegularEdgeBufferWriter.glLayout},{vertices:this.verticesBufferObject,instances:x.createVertex(this.rctx,35044,e.regular.instancesData.buffer)});t.regular={vao:r,lod:e.regular.lodInfo}}if(e.silhouette.lodInfo.lengths.length>0){const r=new j(this.rctx,D.EdgeShaderAttributeLocations,{vertices:D.glVertexLayout,instances:N.SilhouetteEdgeBufferWriter.glLayout},{vertices:this.verticesBufferObject,instances:x.createVertex(this.rctx,35044,e.silhouette.instancesData.buffer)});t.silhouette={vao:r,lod:e.silhouette.lodInfo}}return t},n.addGeometry=async function(e,t,r,n,s,i,o){const a={position:r.vertexAttributes.get("position"),indices:r.indices.get("position"),modelTransform:this.computeModelTransformWithLocalOrigin(e,n,v.create()),origin:n.origin};return this.addPositionData(t,a,r.edgeIndicesLength,s,i,o)},n.addPositionData=async function(e,t,r,n,s,o=!1){const a=this.createComponentBuffers([n]);if(i.isNone(a)||r<=0)return;const c=this.acquireRenderer(n.type,!!s.slicePlaneEnabled),{modelTransform:d,origin:l}=t,u=t.indices,g=t.position,h=g.data.length/g.size,p=D.EdgeInputBufferLayout.createBuffer(h);for(let i=0;i<h;i++)p.position.set(i,0,g.data[i*g.size+0]),p.position.set(i,1,g.data[i*g.size+1]),p.position.set(i,2,g.data[i*g.size+2]);H.fillComponenBufferIndices(a.meta,[0,p.componentIndex.count],p.componentIndex);const f=await this.updatingHandles.addPromise(this.extractEdges(c.writerSettings,p,!1,o,u,r)),{regular:m,silhouette:y}=this.createEdgeResources(f),b=(m?m.vao.size:0)+(y?y.vao.size:0),E={regular:m,silhouette:y,transform:{modelMatrix:d,origin:l},statistics:{gpuMemoryUsage:b,averageEdgeLength:f.averageEdgeLength},components:a,visible:!0,edgeTransparency:H.determineEdgeTransparency(a.meta),objectTransparency:H.determineObjectTransparency(a.meta),distanceToCamera:0,rendererKey:c.key};e.renderables.push(E),c.addRenderable(E),this.gpuMemoryUsage+=b},n.addComponentGeometry=async function(e,t,r,n,s,o,a){const c=this.createComponentBuffers(o);if(i.isNone(c))return;const d=H.determineRendererType(o),l=this.acquireRenderer(d,a.slicePlaneEnabled||!1,!1),u=D.EdgeInputBufferLayout.createBuffer(r.count);k.copy(u.position,r),H.fillComponenBufferIndices(c.meta,s,u.componentIndex,n);const g=!0,h=l.writerSettings,p=await this.updatingHandles.addPromise(this.extractEdges(h,u,g,!1,n)),{regular:f,silhouette:m}=this.createEdgeResources(p),y=(f?f.vao.size:0)+(m?m.vao.size:0),b={regular:f,silhouette:m,transform:e,statistics:{gpuMemoryUsage:y,averageEdgeLength:p.averageEdgeLength},components:c,visible:!0,edgeTransparency:H.determineEdgeTransparency(c.meta),objectTransparency:H.determineObjectTransparency(c.meta),distanceToCamera:0,rendererKey:l.key};t.renderables.push(b),l.addRenderable(b),this.gpuMemoryUsage+=y},n.addObjectMergedGeometries=async function(e,t,r,n,i){const o=new Map;let a=0,c=null,d=null;for(let y=0;y<e.geometries.length;y++){const t=e.geometries[y],r=e.geometryRecords[y];if(!r.material.supportsEdges)continue;!d&&r.origin&&(d=r);const n=t.indices.get("position");a+=t.edgeIndicesLength,null!=c&&c!==Uint16Array||(c=s.isUint16Array(n)?Uint16Array:Uint32Array)}const l=a?new c(a):null,u=[];let g=0;for(let s=0;s<e.geometries.length;s++){const t=e.geometries[s];if(!e.geometryRecords[s].material.supportsEdges)continue;const r=t.vertexAttributes.get("position"),n=t.indices.get("position");let i=o.get(r.data);if(null==i){i=u.length/3;for(let e=0;e<r.data.length;e+=r.size)u.push(r.data[e+0]),u.push(r.data[e+1]),u.push(r.data[e+2]);o.set(r.data,i)}if(n)for(let e=0;e<t.edgeIndicesLength;e++)l[g++]=i+n[e]}const h=d||e.geometryRecords[0],p=this.computeModelTransformWithLocalOrigin(e,h,v.create()),f=h.origin;for(let s=0;s<e.geometryRecords.length;s++)e.geometryRecords[s].origin=f;const m={position:{data:u,size:3},indices:l,modelTransform:p,origin:f};await this.updatingHandles.addPromise(this.addPositionData(t,m,l.length,r[0],n,i))},n.acquireRenderer=function(e,t,r=!0){const n=A.EdgeRenderer.getKey(e,t,r);let s=this.renderers.get(n);return i.isNone(this.strokesTexture)&&(this.strokesTexture=S.generateStrokesTexture(this.rctx)),s||(s=new A.EdgeRenderer(this.rctx,this.techniqueRepository,{type:e,slicePlaneEnabled:t,strokesTexture:this.strokesTexture,legacy:r}),this.renderers.set(n,s)),s.refCount.increment(),s},n.removeRenderable=function(e){const t=this.renderers.get(e.rendererKey);if(t){t.removeRenderable(e),t.refCount.decrement(),U(e),"origin"in e.transform&&this.localOrigins.release(e.transform.origin),this.gpuMemoryUsage-=e.statistics.gpuMemoryUsage;for(const t of e.components.meta)e.components.buffer.releaseIndex(t.index)}},n.updateObjectCameraDistances=function(e){const t=e.camera.viewInverseTransposeMatrix;b.set(this.tmpCameraPosition,t[3],t[7],t[11]),this.perObjectData.forEach(((e,t)=>{const r=i.isSome(e.center)?e.center:R.getCenter(t.getBounds()),n=b.distance(r,this.tmpCameraPosition);e.renderables.forEach((e=>e.distanceToCamera=n))}))},n.renderRegularEdges=function(e,t,r){e.bindRegularEdges(t,r);const n=r.transparency;e.forEachRenderable((n=>{if(!n.visible||!n.regular)return;const s=H.computeEdgeCount(n.regular.lod.lengths,n.distanceToCamera,r);"origin"in n.transform&&(t.localViewMatrixForEdges=this.localOrigins.getViewMatrix(n.transform.origin)),e.renderRegularEdges(n,t,s),this.numberOfRenderedEdges+=s}),n)},n.renderSilhouetteEdges=function(e,t,r){e.bindSilhouetteEdges(t,r);const n=r.transparency;e.forEachRenderable((n=>{if(!n.visible||!n.silhouette)return;const s=H.computeEdgeCount(n.silhouette.lod.lengths,n.distanceToCamera,r);"origin"in n.transform&&(t.localViewMatrixForEdges=this.localOrigins.getViewMatrix(n.transform.origin)),e.renderSilhouetteEdges(n,t,s),this.numberOfRenderedEdges+=s}),n)},t._createClass(r,[{key:"updating",get:function(){return this.updatingHandles.updating}},{key:"usedMemory",get:function(){return this.gpuMemoryUsage}},{key:"numberOfRenderedPrimitives",get:function(){return this.numberOfRenderedEdges}}]),r}(f),r.__decorate([c.property({constructOnly:!0})],e.EdgeView.prototype,"rctx",void 0),r.__decorate([c.property({constructOnly:!0})],e.EdgeView.prototype,"techniqueRepository",void 0),r.__decorate([c.property({constructOnly:!0})],e.EdgeView.prototype,"setNeedsRender",void 0),r.__decorate([c.property({constructOnly:!0})],e.EdgeView.prototype,"scheduler",void 0),r.__decorate([c.property({readOnly:!0})],e.EdgeView.prototype,"updatingHandles",void 0),r.__decorate([c.property({readOnly:!0})],e.EdgeView.prototype,"updating",null),e.EdgeView=r.__decorate([d.subclass("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView")],e.EdgeView);let z=function(){function e(e,t=null){this.center=t,this.renderables=new Array,this.loaded=e,this.loaded.then((()=>this.loaded=!0))}return e.prototype.waitLoaded=function(e,t){!0===this.loaded?e():t.addPromise(this.loaded.then((()=>e())))},e}();Object.defineProperty(e,"__esModule",{value:!0})}));
