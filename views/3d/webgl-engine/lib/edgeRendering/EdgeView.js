/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../core/Accessor","../../../../../core/arrayUtils","../../../../../core/Logger","../../../../../core/mathUtils","../../../../../core/maybe","../../../../../core/accessorSupport/decorators/property","../../../../../core/accessorSupport/ensureType","../../../../../core/accessorSupport/decorators/subclass","../../../../../chunks/mat3","../../../../../chunks/mat3f64","../../../../../chunks/mat4f64","../../../../../chunks/vec3","../../../../../chunks/vec3f64","../../../../../core/support/WatchUpdatingTracking","../../../../../chunks/sphere","../../../../../chunks/vec33","../../../../ViewingMode","../../collections/Component/Material/shader/ComponentData.glsl","../../core/util/TwoVectorPosition","../GridLocalOriginFactory","../localOriginHelper","../LocalOriginManager","../Object3D","../VertexArrayObject","../VertexAttribute","./bufferLayouts","./edgeBufferWriters","./edgePreprocessing","./EdgeRenderer","./EdgeShaderParameters","./EdgeWorkerHandle","./interfaces","./strokes","./util","../TextureBackedBuffer/BufferManager","../../../../webgl/BufferObject","../../../../webgl/enums"],(function(e,t,r,n,s,i,o,a,c,d,u,l,h,g,f,p,m,y,_,b,O,E,T,v,w,R,x,j,S,M,C,A,P,V,B,I,D,L,k,N){"use strict";function G(e){a.isSome(e.regular)&&(e.regular.vao.vertexBuffers.instances.dispose(),e.regular.vao.dispose(!1),e.regular.vao=null),a.isSome(e.silhouette)&&(e.silhouette.vao.vertexBuffers.instances.dispose(),e.silhouette.vao.dispose(!1),e.silhouette.vao=null)}function U(e){let t=null,r=null;for(let n=0;n<e.geometries.length;n++){const i=e.geometryRecords[n];if(i.material.supportsEdges){if(t){if(!s.equals(t,i.transformation))return!1}else t=i.transformation;if(!r&&a.isSome(i.origin))r=i;else if(a.isSome(r?.origin)&&a.isSome(i.origin)&&r.origin.id!==i.origin.id)return!1}}return!0}e.EdgeView=function(e){function r(t){var r;return(r=e.call(this,t)||this)._updatingHandles=new m.WatchUpdatingTracking,r._perObjectData=new Map,r._perObjectDataEvictionCache=new Set,r._renderers=new Map,r._gpuMemoryUsage=0,r._workerAbort=new AbortController,r._tmpModelPosition=p.create(),r._localOrigins=new w.LocalOriginManager(new T.GridLocalOriginFactory(t.renderSR)),r}t._inheritsLoose(r,e);var n=r.prototype;return n.initialize=function(){this._worker=new V.EdgeWorkerHandle(this.schedule),this._componentColorManager=new L.BufferManager(this.rctx,3);const e=S.VertexLayout.createBuffer(4);for(let t=0;t<4;t++)e.sideness.set(t,0,0===t||3===t?0:1),e.sideness.set(t,1,0===t||1===t?0:1);this._verticesBufferObject=k.BufferObject.createVertex(this.rctx,N.Usage.STATIC_DRAW,e.buffer)},n.destroy=function(){this.destroyed||(this._perObjectData.forEach((e=>this._discardObjectEntry(e))),this._perObjectData.clear(),this._strokesTexture=a.disposeMaybe(this._strokesTexture),this._componentColorManager=a.destroyMaybe(this._componentColorManager),this._workerAbort.abort(),this._worker.destroy(),this._verticesBufferObject=a.disposeMaybe(this._verticesBufferObject),this._renderers.clear(),this._updatingHandles.destroy())},n.shouldRender=function(){return this._renderers.size>0},n.addComponentObject=function(){var e=t._asyncToGenerator((function*(e,t,r,n,s,i,o,a){if(this.hasObject(e))return this.getObjectMemoryUsage(e);let c;const d=new H(new Promise((e=>c=e)),r.center,r.radius);this._perObjectData.set(e,d);const u=yield this._updatingHandles.addPromise(this._addComponentGeometry(t,d,n,s,i,o,a));return this.setNeedsRender(),c(),u}));function r(t,r,n,s,i,o,a,c){return e.apply(this,arguments)}return r}(),n.addOrUpdateObject3D=function(){var e=t._asyncToGenerator((function*(e,t,r,n){if(this.destroyed)return void i.getLogger(this.declaredClass).warn("Attempt to add an object to a destroyed instance");const s=this._perObjectData.get(e);let o;s?.renderables.length>0&&this._perObjectDataEvictionCache.add(s);const a=e.boundingVolumeWorldSpace.bounds,c=new H(new Promise((e=>o=e)),y.getCenter(a),y.getRadius(a));this._perObjectData.set(e,c);const d=new Array;if(r.mergeGeometries&&e.geometries.length>1&&U(e))d.push(this._addObjectMergedGeometries(e,c,t,r,n));else for(let i=0;i<e.geometries.length;i++){const s=e.geometryRecords[i];if(!s.material.supportsEdges)continue;const o=e.geometries[i];d.push(this._addGeometry(e,c,o,s,t[0],r,n))}yield this._updatingHandles.addPromise(Promise.all(d)),this._perObjectDataEvictionCache.delete(c),this._discardObjectEntry(s),this.setNeedsRender(),o()}));function r(t,r,n,s){return e.apply(this,arguments)}return r}(),n._discardObjectEntry=function(e){e&&(e.renderables.length&&(e.renderables.forEach((e=>this._removeRenderable(e))),this.setNeedsRender()),e.loaded=null)},n.hasObject=function(e){return this._perObjectData.has(e)},n.updateAllComponentOpacities=function(){var e=t._asyncToGenerator((function*(e,t){const r=yield this._updatingHandles.addPromise(this._getObjectEntry(e));if(a.isNone(r))return;const n=t instanceof Array?e=>t[e]:()=>t;r.renderables.forEach((e=>{const t=e.components.meta.length;for(let r=0;r<t;r++){const t=n(r),s=e.components.meta[r],i=s.index;s.material.opacity=t,e.components.buffer.textureBuffer.setDataElement(i,1,3,255*t)}this._updateTransparency(e)})),this.setNeedsRender()}));function r(t,r){return e.apply(this,arguments)}return r}(),n.getObjectMemoryUsage=function(){var e=t._asyncToGenerator((function*(e){const t=yield this._getObjectEntry(e);return a.isSome(t)?t.renderables.reduce(((e,t)=>e+t.statistics.gpuMemoryUsage),0):0}));function r(t){return e.apply(this,arguments)}return r}(),n.updateAllComponentMaterials=function(){var e=t._asyncToGenerator((function*(e,t,r,n){const s=e instanceof R.Object3D,i=!!r.hasSlicePlane,o=D.determineRendererType(t),c=A.EdgeRenderer.getKey(o,i,s),d=yield this._updatingHandles.addPromise(this._getObjectEntry(e));a.isNone(d)||(d.renderables.forEach((e=>{if(c!==e.rendererKey){const t=this._renderers.get(e.rendererKey),r=this._acquireRenderer(o,i,s);t.removeRenderable(e),--t.refCount,e.rendererKey=c,r.addRenderable(e)}for(let r=0;r<t.length;r++)e.components.meta[r].material=t[r];n&&this._updateComponentBuffer(e.components),this._updateTransparency(e)})),this.setNeedsRender())}));function r(t,r,n,s){return e.apply(this,arguments)}return r}(),n.updateAllVerticalOffsets=function(){var e=t._asyncToGenerator((function*(e,t){const r=yield this._updatingHandles.addPromise(this._getObjectEntry(e));a.isNone(r)||(r.renderables.forEach((e=>{const r=e.components.meta;for(let n=0;n<r.length;n++)e.components.meta[n].verticalOffset=t?.[n]??0;this._updateComponentBuffer(e.components)})),this.setNeedsRender())}));function r(t,r){return e.apply(this,arguments)}return r}(),n.updateObjectVisibility=function(){var e=t._asyncToGenerator((function*(e,t){const r=yield this._updatingHandles.addPromise(this._getObjectEntry(e));a.isSome(r)&&(r.renderables.forEach((e=>e.visible=t)),this.setNeedsRender())}));function r(t,r){return e.apply(this,arguments)}return r}(),n.removeObject=function(e){const t=this._perObjectData.get(e);t&&(this._perObjectData.delete(e),this._discardObjectEntry(t))},n._getObjectEntry=function(){var e=t._asyncToGenerator((function*(e){const t=this._perObjectData.get(e);if(!t)throw"no object";return yield t.loaded,null==t.loaded?null:t}));function r(t){return e.apply(this,arguments)}return r}(),n.render=function(e,t){if(a.isNone(this._componentColorManager))return;this._localOrigins.updateViewMatrices(e.camera.viewMatrix);const r=e.camera.viewInverseTransposeMatrix,n=p.create(),s=new E.TwoVectorPosition;let i=0,o=0;if(this._renderers.forEach((r=>{if(0===r.refCount)this._renderers.delete(r.key),r.dispose();else{let n=!0,s=!0;r.forEachRenderable((t=>{t.visible&&(i+=t.statistics.averageEdgeLength,o++,n&&t.regular&&(r.updateTechnique(e,!1),n=!1),s&&t.silhouette&&(r.updateTechnique(e,!0),s=!1))}),t)}})),this._componentColorManager.garbageCollect(),this._componentColorManager.updateTextures(),0===o)return;const c=40*i/o,d=new P.EdgePassParameters(c,t);f.set(n,r[3],r[7],r[11]),s.set(n),f.copy(d.transformWorldFromViewTH,s.high),f.copy(d.transformWorldFromViewTL,s.low),l.fromMat4(d.transformViewFromCameraRelativeRS,e.camera.viewMatrix),l.transpose($,d.transformViewFromCameraRelativeRS),l.invert(d.transformNormalViewFromGlobal,$),d.transformProjFromView=e.camera.projectionMatrix,this._updateObjectCameraDistances(e),this._renderers.forEach((t=>{this._renderRegularEdges(t,e,d),this._renderSilhouetteEdges(t,e,d)}))},n._updateTransparency=function(e){const t=D.determineEdgeTransparency(e.components.meta),r=D.determineObjectTransparency(e.components.meta);t===e.edgeTransparency&&r===e.objectTransparency||(e.edgeTransparency=t,e.objectTransparency=r,this._renderers.get(e.rendererKey).setRenderablesDirty())},n._computeModelTransformWithLocalOrigin=function(e,t,r){e.getCombinedStaticTransformation(t,r);const n=a.isSome(t.origin)?this._localOrigins.register(t.origin):this._localOrigins.acquire(f.set(this._tmpModelPosition,r[12],r[13],r[14]));return t.origin=n.origin,v.applyToModelMatrix(n.origin.vec3,r),n},n._updateComponentBuffer=function(e){const{meta:t,buffer:r}=e,n=new Uint8Array(4);for(let s=0;s<t.length;s++){const e=t[s].material,i=t[s].index,a=o.clamp(Math.round(e.size*A.LINE_WIDTH_FRACTION_FACTOR),0,255),c=o.clamp(e.extensionLength,-A.EXTENSION_LENGTH_OFFSET,255-A.EXTENSION_LENGTH_OFFSET)+A.EXTENSION_LENGTH_OFFSET,d="solid"===e.type?C.EdgeType.SOLID:C.EdgeType.SKETCH,u=255*e.opacity,l=e.color,h=255*l[0],g=255*l[1],f=255*l[2],p=255*l[3];r.textureBuffer.setData(i,0,h,g,f,p),r.textureBuffer.setData(i,1,a,c,d,u),O.encodeElevationOffset(t[s].verticalOffset,n),r.textureBuffer.setData(i,2,n[0],n[1],n[2],n[3])}},n._createComponentBuffers=function(e){if(a.isNone(this._componentColorManager))return null;const t=new Array,r=this._componentColorManager.getBuffer(e.length);for(let s=0;s<e.length;s++){const n=e[s],i=r.acquireIndex();t.push({index:i,verticalOffset:0,material:n})}const n=new F(r,t);return this._updateComponentBuffer(n),n},n._extractEdges=function(e,t,r,n,s,i=s.length){return this._worker.process({data:t,indices:s,indicesLength:i,writerSettings:e,skipDeduplicate:r},this._workerAbort.signal,n)},n._createRenderable=function(e,t,r,n,s){const i=a.isSome(this._verticesBufferObject)&&e.regular.lodInfo.lengths.length>0?new W(new x.VertexArrayObject(this.rctx,S.EdgeShaderAttributeLocations,{vertices:S.glVertexLayout,instances:M.RegularEdgeBufferWriter.glLayout},{vertices:this._verticesBufferObject,instances:k.BufferObject.createVertex(this.rctx,N.Usage.STATIC_DRAW,e.regular.instancesData.buffer)}),e.regular.lodInfo):null,o=a.isSome(this._verticesBufferObject)&&e.silhouette.lodInfo.lengths.length>0?new W(new x.VertexArrayObject(this.rctx,S.EdgeShaderAttributeLocations,{vertices:S.glVertexLayout,instances:M.SilhouetteEdgeBufferWriter.glLayout},{vertices:this._verticesBufferObject,instances:k.BufferObject.createVertex(this.rctx,N.Usage.STATIC_DRAW,e.silhouette.instancesData.buffer)}),e.silhouette.lodInfo):null,c=(a.isSome(i)?i.vao.size:0)+(a.isSome(o)?o.vao.size:0);return new q(i,o,{gpuMemoryUsage:c,externalMemoryUsage:s,averageEdgeLength:e.averageEdgeLength},r,D.determineEdgeTransparency(t.meta),D.determineObjectTransparency(t.meta),t,n)},n._addGeometry=function(){var e=t._asyncToGenerator((function*(e,t,r,n,s,i,o){const a=r.vertexAttributes.get(j.VertexAttribute.POSITION),c=r.indices.get(j.VertexAttribute.POSITION),d=g.create(),u=this._computeModelTransformWithLocalOrigin(e,n,d),l=new Z(a,c,d,u);return this._addPositionData(t,l,r.edgeIndicesLength,s,i,o)}));function r(t,r,n,s,i,o,a){return e.apply(this,arguments)}return r}(),n._addPositionData=function(){var e=t._asyncToGenerator((function*(e,t,r,n,s,i=!1){if(null==e.loaded)return;const o=this._createComponentBuffers([n]);if(a.isNone(o)||r<=0)return;const c=this._acquireRenderer(n.type,!!s.hasSlicePlane,!0),{modelTransform:d,origin:u}=t,l=t.indices,h=t.position,g=h.data.length/h.size,f=S.EdgeInputBufferLayout.createBuffer(g);for(let a=0;a<g;a++)f.position.set(a,0,h.data[a*h.size+0]),f.position.set(a,1,h.data[a*h.size+1]),f.position.set(a,2,h.data[a*h.size+2]);D.fillComponenBufferIndices(o.meta,[0,f.componentIndex.count],f.componentIndex);const p=yield this._updatingHandles.addPromise(this._extractEdges(c.writerSettings,f,!1,i,l,r));if(null==e.loaded)return;const m=this._createRenderable(p,o,new z(d,u),c.key,!1);e.renderables.push(m),c.addRenderable(m),this._gpuMemoryUsage+=m.statistics.gpuMemoryUsage}));function r(t,r,n,s,i){return e.apply(this,arguments)}return r}(),n._addComponentGeometry=function(){var e=t._asyncToGenerator((function*(e,t,r,n,s,i,o){if(null==t.loaded)return 0;const c=this._createComponentBuffers(i);if(a.isNone(c))return 0;const d=D.determineRendererType(i),u=this._acquireRenderer(d,o.hasSlicePlane||!1,!1),l=S.EdgeInputBufferLayout.createBuffer(r.count);_.copy(l.position,r),D.fillComponenBufferIndices(c.meta,s,l.componentIndex,n);const h=!0,g=u.writerSettings,f=yield this._updatingHandles.addPromise(this._extractEdges(g,l,h,!1,n));if(null==t.loaded)return 0;const p=this._createRenderable(f,c,e,u.key,!0);return t.renderables.push(p),u.addRenderable(p),p.statistics.gpuMemoryUsage}));function r(t,r,n,s,i,o,a){return e.apply(this,arguments)}return r}(),n._addObjectMergedGeometries=function(){var e=t._asyncToGenerator((function*(e,t,r,n,s){const i=new Map;let o=0,a=null,c=0;for(let g=0;g<e.geometries.length;g++){const t=e.geometries[g],r=e.geometryRecords[g];if(!r.material.supportsEdges)continue;!a&&r.origin&&(a=r);const n=t.vertexAttributes.get(j.VertexAttribute.POSITION);c+=n.data.length/n.size,o+=t.edgeIndicesLength}const d=c>=65536?Uint32Array:Uint16Array,u=o?new d(o):null,l=[];let h=0;for(let g=0;g<e.geometries.length;g++){const t=e.geometries[g];if(!e.geometryRecords[g].material.supportsEdges)continue;const r=t.vertexAttributes.get(j.VertexAttribute.POSITION),n=t.indices.get(j.VertexAttribute.POSITION);let s=i.get(r.data);if(null==s){s=l.length/3;for(let e=0;e<r.data.length;e+=r.size)l.push(r.data[e+0]),l.push(r.data[e+1]),l.push(r.data[e+2]);i.set(r.data,s)}if(n)for(let e=0;e<t.edgeIndicesLength;e++)u[h++]=s+n[e]}const f=a||e.geometryRecords[0],p=g.create(),m=this._computeModelTransformWithLocalOrigin(e,f,p);for(let g=0;g<e.geometryRecords.length;g++)e.geometryRecords[g].origin=m.origin;const y=new Z({data:l,size:3},u,p,m);yield this._updatingHandles.addPromise(this._addPositionData(t,y,u.length,r[0],n,s))}));function r(t,r,n,s,i){return e.apply(this,arguments)}return r}(),n._acquireRenderer=function(e,t,r){const n=A.EdgeRenderer.getKey(e,t,r);let s=this._renderers.get(n);return a.isNone(this._strokesTexture)&&(this._strokesTexture=I.generateStrokesTexture(this.rctx)),s||(s=new A.EdgeRenderer(this.rctx,this.techniqueRepository,{type:e,hasSlicePlane:t,strokesTexture:this._strokesTexture,legacy:r,spherical:this.viewingMode===b.ViewingMode.Global}),this._renderers.set(n,s)),++s.refCount,s},n._removeRenderable=function(e){G(e);const t=this._renderers.get(e.rendererKey);if(t){t.removeRenderable(e),--t.refCount,"origin"in e.transform&&this._localOrigins.release(e.transform.origin),this._gpuMemoryUsage-=e.statistics.externalMemoryUsage?0:e.statistics.gpuMemoryUsage;for(const t of e.components.meta)e.components.buffer.releaseIndex(t.index)}},n._updateObjectCameraDistances=function(e){const t=e.camera.eye,r=e.camera.viewForward,n=p.create(),s=e=>{f.sub(n,e.center,t);const s=f.dot(n,r),i=e.radius,o=s<-i?1/0:s<i?0:s-i;e.renderables.forEach((e=>e.distanceToCamera=o))};this._perObjectData.forEach(s),this._perObjectDataEvictionCache.forEach(s)},n._renderRegularEdges=function(e,t,r){const n=e.bindRegularEdges(r,t),s=r.transparency,i=t.camera.perScreenPixelRatio;e.forEachRenderable((s=>{if(!X(s)||!s.visible)return;const o=Y(s.regular.lod.lengths,s.distanceToCamera,i);e.renderRegularEdges(n,s,r,t,o)}),s)},n._renderSilhouetteEdges=function(e,t,r){const n=e.bindSilhouetteEdges(r,t),s=r.transparency,i=t.camera.perScreenPixelRatio;e.forEachRenderable((s=>{if(!J(s)||!s.visible)return;const o=Y(s.silhouette.lod.lengths,s.distanceToCamera,i);e.renderSilhouetteEdges(n,s,r,t,o)}),s)},t._createClass(r,[{key:"updating",get:function(){return this._updatingHandles.updating}},{key:"usedMemory",get:function(){return this._gpuMemoryUsage}},{key:"test",get:function(){return{hasRenderedPrimitives:e=>{let t=!1;const r=e.perScreenPixelRatio,n=(e,n)=>e.forEachRenderable((e=>{e.visible&&!t&&(X(e)&&(t=Y(e.regular.lod.lengths,e.distanceToCamera,r)>0),!t&&J(e)&&(t=Y(e.silhouette.lod.lengths,e.distanceToCamera,r)>0))}),n);return this._renderers.forEach((e=>{t||(n(e,B.Transparency.OPAQUE),n(e,B.Transparency.TRANSPARENT))})),t}}}}]),r}(n),r.__decorate([c.property({constructOnly:!0})],e.EdgeView.prototype,"rctx",void 0),r.__decorate([c.property({constructOnly:!0})],e.EdgeView.prototype,"renderSR",void 0),r.__decorate([c.property({constructOnly:!0})],e.EdgeView.prototype,"viewingMode",void 0),r.__decorate([c.property({constructOnly:!0})],e.EdgeView.prototype,"techniqueRepository",void 0),r.__decorate([c.property({constructOnly:!0})],e.EdgeView.prototype,"setNeedsRender",void 0),r.__decorate([c.property({constructOnly:!0})],e.EdgeView.prototype,"schedule",void 0),r.__decorate([c.property({readOnly:!0})],e.EdgeView.prototype,"_updatingHandles",void 0),r.__decorate([c.property({readOnly:!0})],e.EdgeView.prototype,"updating",null),e.EdgeView=r.__decorate([u.subclass("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView")],e.EdgeView);let H=function(e,t,r){this.center=t,this.radius=r,this.renderables=new Array,this.loaded=e,this.loaded.then((()=>{null!=this.loaded&&(this.loaded=!0)}))},F=function(e,t){this.buffer=e,this.meta=t},W=function(e,t){this.vao=e,this.lod=t},z=function(e,t){this.modelMatrix=e,this.origin=t},q=function(e,t,r,n,s,i,o,a){this.regular=e,this.silhouette=t,this.statistics=r,this.transform=n,this.edgeTransparency=s,this.objectTransparency=i,this.components=o,this.rendererKey=a,this.distanceToCamera=0,this.visible=!0},K=function(e){function r(){return e.apply(this,arguments)||this}return t._inheritsLoose(r,e),r}(q);function X(e){return a.isSome(e.regular)}let Q=function(e){function r(){return e.apply(this,arguments)||this}return t._inheritsLoose(r,e),r}(q);function J(e){return a.isSome(e.silhouette)}function Y(e,t,r){const n=t*r,i=s.binaryIndexOf(e,n,!0);return-1===i?n<e[0]?e.length:0:e.length-i}let Z=function(e,t,r,n){this.position=e,this.indices=t,this.modelTransform=r,this.origin=n};const $=h.create();e.LegacyTransform=z,e.RegularRenderable=K,e.Renderable=q,e.SilhouetteRenderable=Q,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
