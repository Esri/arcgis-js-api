/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/maybe","../../../../../core/PooledArray","../../../../../chunks/mat3","../../../../../chunks/mat3f32","../../../../../chunks/vec3","../../../../../chunks/vec3f64","../../../support/debugFlags","../../collections/Component/Material/ComponentTechnique","../../core/shaderLibrary/Slice.glsl","../../core/shaderLibrary/attributes/VertexPosition.glsl","../../core/shaderLibrary/shading/MultipassTerrainTest.glsl","../../core/shaderLibrary/util/DoublePrecision.glsl","../../core/util/TwoVectorPosition","./EdgeShaderTechnique","./interfaces","../../shaders/sources/edgeRenderer/EdgeUtil.glsl","../../../../webgl/enums"],(function(e,r,t,s,n,i,a,o,c,l,d,h,u,T,f,g,m,p,b){"use strict";const y=8,E=128,R={type:"uber",slicePlaneEnabled:!1,sliceHighlightDisabled:!1,strokesTexture:null,legacy:!0};let A=function(){function e(){this._value=0}var t=e.prototype;return t.increment=function(){this._value++},t.decrement=function(){this._value--},r._createClass(e,[{key:"value",get:function(){return this._value}}]),e}();const P={solid:p.EdgeUtilMode.SOLID,sketch:p.EdgeUtilMode.SKETCH,uber:p.EdgeUtilMode.MIXED};let S=function(){function e(r,t,n){this.rctx=r,this.shaderTechniqueRepository=t,this.config=new g.EdgeShaderTechniqueConfiguration,this.technique=null,this.refCount=new A,this.renderables=new Set,this.sortedRenderables={[m.Transparency.TRANSPARENT]:{[m.Transparency.TRANSPARENT]:new s,[m.Transparency.OPAQUE]:new s},[m.Transparency.OPAQUE]:{[m.Transparency.TRANSPARENT]:new s,[m.Transparency.OPAQUE]:new s}},this.renderablesDirty=!1,this.settings={...R,...n},this.key=e.getKey(this.settings.type,this.settings.slicePlaneEnabled,this.settings.legacy);const i=this.settings.strokesTexture.variants;this.writerSettings={variants:i,reducedPrecision:c.TESTS_DISABLE_OPTIMIZATIONS},this.config.legacy=this.settings.legacy,this.config.mode=P[this.settings.type],this.config.silhouette=!1,this.config.antialiasing=!!this.rctx.capabilities.blendMinMax,this.config.slicePlaneEnabled=this.settings.slicePlaneEnabled,this.config.doublePrecisionRequiresObfuscation=T.doublePrecisionRequiresObfuscation(r)}var r=e.prototype;return r.dispose=function(){this.technique=t.releaseMaybe(this.technique)},r.addRenderable=function(e){this.renderables.add(e),this.renderablesDirty=!0},r.removeRenderable=function(e){this.renderables.delete(e),this.renderablesDirty=!0},r.setRenderablesDirty=function(){this.renderablesDirty=!0},r.forEachRenderable=function(e,r){this.renderablesDirty&&this._sortRenderables(),this.sortedRenderables[r][m.Transparency.TRANSPARENT].forAll(e),this.sortedRenderables[r][m.Transparency.OPAQUE].forAll(e)},r.setMultipassParameters=function(e){this.config.multipassTerrainEnabled=!!e.multipassTerrainEnabled&&e.multipassTerrainEnabled,this.config.cullAboveGround=!!e.cullAboveGround&&e.cullAboveGround},r.bindRegularEdges=function(e,r){this.setMultipassParameters(e),this.config.silhouette=!1,this.technique=this.shaderTechniqueRepository.releaseAndAcquire(g.EdgeShaderTechnique,this.config,this.technique),this.rctx.useTechnique(this.technique,e.slot),this.technique.bindPass({bindParameters:e,edgeRenderParameters:r})},r.bindSilhouetteEdges=function(e,r){this.setMultipassParameters(e),this.config.silhouette=!0,this.technique=this.shaderTechniqueRepository.releaseAndAcquire(g.EdgeShaderTechnique,this.config,this.technique),this.rctx.useTechnique(this.technique,e.slot),this.technique.bindPass({bindParameters:e,edgeRenderParameters:r})},r.renderRegularEdges=function(e,r,t){this._render(e,e.regular.vao,r,t)},r.renderSilhouetteEdges=function(e,r,t){this._render(e,e.silhouette.vao,r,t)},r._render=function(e,r,t,s){this._setUniforms(e,t),this.rctx.bindVAO(r),this.rctx.capabilities.instancing.drawArraysInstanced(b.PrimitiveType.TRIANGLE_FAN,0,4,s)},r._setUniforms=function(e,r){const t=this.technique.program;if(e.components.buffer.textureBuffer.bind(t,N,v),r.multipassTerrainEnabled&&(t.setUniform2fv("nearFar",r.camera.nearFar),t.setUniform2fv("inverseViewport",r.inverseViewport),u.bindMultipassTerrainTexture(t,r)),"origin"in e.transform)t.setUniformMatrix4fv("view",r.localViewMatrixForEdges),t.setUniformMatrix4fv("model",e.transform.modelMatrix),d.bindSliceUniforms(t,this.settings,r.slicePlane,{origin:e.transform.origin.vec3});else{const s=new f.TwoVectorPosition(e.transform.position),i=n.transpose(U,n.invert(U,e.transform.rotationScale)),o=new l.ComponentDrawParameters;a.copy(o.transformWorldFromModelTL,s.low),a.copy(o.transformWorldFromModelTH,s.high),n.copy(o.transformWorldFromModelRS,e.transform.rotationScale),n.copy(o.transformNormalGlobalFromModel,i),h.bindModelTransform(t,o),t.setUniformMatrix3fv("transformNormalGlobalFromModel",o.transformNormalGlobalFromModel);const c=r.camera.viewInverseTransposeMatrix,u=a.set(M,c[3],c[7],c[11]);d.bindSliceUniforms(t,this.settings,r.slicePlane,{origin:u})}"uber"!==this.settings.type&&"sketch"!==this.settings.type||this._setSketchUniforms(t)},r._setSketchUniforms=function(e){const r=this.settings.strokesTexture,s=r.texture;t.isNone(s)||(e.bindTexture(s,"strokesTexture"),e.setUniform2f("strokesTextureScale",1/s.descriptor.width,1/s.descriptor.height),e.setUniform1f("strokesLog2Resolution",Math.log2(r.resolution)),e.setUniform1f("strokesNormalizationScale",r.normalizationScale),e.setUniform1f("strokesAmplitude",r.amplitude),e.setUniform1f("strokeVariants",r.variants))},r._sortRenderables=function(){this.renderablesDirty=!1,this.sortedRenderables[m.Transparency.TRANSPARENT][m.Transparency.TRANSPARENT].clear(),this.sortedRenderables[m.Transparency.TRANSPARENT][m.Transparency.OPAQUE].clear(),this.sortedRenderables[m.Transparency.OPAQUE][m.Transparency.TRANSPARENT].clear(),this.sortedRenderables[m.Transparency.OPAQUE][m.Transparency.OPAQUE].clear(),this.renderables.forEach((e=>{e.objectTransparency!==m.Transparency.INVISIBLE&&e.edgeTransparency!==m.Transparency.INVISIBLE&&this.sortedRenderables[e.objectTransparency][e.edgeTransparency].push(e)}));const e=(e,r)=>"origin"in e.transform&&"origin"in r.transform?e.transform.origin.id<r.transform.origin.id?-1:e.transform.origin.id>r.transform.origin.id?1:0:0;this.sortedRenderables[m.Transparency.TRANSPARENT][m.Transparency.TRANSPARENT].sort(e),this.sortedRenderables[m.Transparency.TRANSPARENT][m.Transparency.OPAQUE].sort(e),this.sortedRenderables[m.Transparency.OPAQUE][m.Transparency.TRANSPARENT].sort(e),this.sortedRenderables[m.Transparency.OPAQUE][m.Transparency.OPAQUE].sort(e)},e.getKey=function(e,r,t){return`edges-t:${e}:${r}:${t}`},e}();const N="componentDataTex",v="componentDataTexInvDim",U=i.create(),M=o.create();e.EXTENSION_LENGTH_OFFSET=E,e.EdgeRenderer=S,e.LINE_WIDTH_FRACTION_FACTOR=y,e.componentDataInvDimName=v,e.componentDataTexName=N,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
