/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/maybe","../../../../../core/PooledArray","../../../../../core/mathUtils","../../../../../chunks/vec3f64","../../../../../chunks/vec3","../../../../../chunks/mat3","../../../../../chunks/mat3f32","../../../support/debugFlags","../../core/shaderLibrary/Slice.glsl","../../core/shaderLibrary/shading/MultipassTerrainTest.glsl","../../core/shaderLibrary/util/DoublePrecision.glsl","../../core/shaderLibrary/attributes/VertexPosition.glsl","../../collections/Component/Material/ComponentTechnique","../../core/util/TwoVectorPosition","./EdgeShaderTechnique"],(function(e,t,i,r,s,n,o,a,l,c,h,d,u,f,m,g,b){"use strict";const p=8,T=128,y={type:"uber",slicePlaneEnabled:!1,sliceHighlightDisabled:!1,strokesTexture:null,legacy:!0};let R=function(){function e(){this._value=0}var i=e.prototype;return i.increment=function(){this._value++},i.decrement=function(){this._value--},t._createClass(e,[{key:"value",get:function(){return this._value}}]),e}();const x={solid:0,sketch:1,uber:2};let E=function(){function e(t,i,s){this.rctx=t,this.shaderTechniqueRepository=i,this.config=new b.EdgeShaderTechnique.Configuration,this.technique=null,this.refCount=new R,this.renderables=new Set,this.sortedRenderables={1:{1:new r,2:new r},2:{1:new r,2:new r}},this.renderablesDirty=!1,this.settings={...y,...s},this.key=e.getKey(this.settings.type,this.settings.slicePlaneEnabled,this.settings.legacy);const n=this.settings.strokesTexture.variants;this.writerSettings={variants:n,reducedPrecision:c.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES},this.config.legacy=this.settings.legacy,this.config.mode=x[this.settings.type],this.config.silhouette=!1,this.config.antialiasing=!!this.rctx.capabilities.blendMinMax,this.config.slicePlaneEnabled=this.settings.slicePlaneEnabled,this.config.doublePrecisionRequiresObfuscation=u.doublePrecisionRequiresObfuscation(t)}var t=e.prototype;return t.dispose=function(){this.technique&&(this.shaderTechniqueRepository.release(this.technique),this.technique=null)},t.addRenderable=function(e){this.renderables.add(e),this.renderablesDirty=!0},t.removeRenderable=function(e){this.renderables.delete(e),this.renderablesDirty=!0},t.setRenderablesDirty=function(){this.renderablesDirty=!0},t.forEachRenderable=function(e,t){this.renderablesDirty&&this.sortRenderables(),this.sortedRenderables[t][1].forAll(e),this.sortedRenderables[t][2].forAll(e)},t.setMultipassParameters=function(e){this.config.multipassTerrainEnabled=!!e.multipassTerrainEnabled&&e.multipassTerrainEnabled,this.config.cullAboveGround=!!e.cullAboveGround&&e.cullAboveGround},t.bindRegularEdges=function(e,t){this.setMultipassParameters(e),this.config.silhouette=!1,this.technique=this.shaderTechniqueRepository.acquireAndReleaseExisting(b.EdgeShaderTechnique,this.config,this.technique),this.technique.bindPass(this.rctx,{bindParameters:e,edgeRenderParameters:t}),this.rctx.setPipelineState(this.technique.pipeline),this.rctx.bindProgram(this.technique.program)},t.bindSilhouetteEdges=function(e,t){this.setMultipassParameters(e),this.config.silhouette=!0,this.technique=this.shaderTechniqueRepository.acquireAndReleaseExisting(b.EdgeShaderTechnique,this.config,this.technique),this.technique.bindPass(this.rctx,{bindParameters:e,edgeRenderParameters:t}),this.rctx.setPipelineState(this.technique.pipeline),this.rctx.bindProgram(this.technique.program)},t.renderRegularEdges=function(e,t,i){this.render(this.technique.program,e,e.regular.vao,t,i)},t.renderSilhouetteEdges=function(e,t,i){this.render(this.technique.program,e,e.silhouette.vao,t,i)},t.render=function(e,t,i,r,s){this.setUniforms(e,t,r),this.rctx.bindVAO(i),this.rctx.capabilities.instancing.drawArraysInstanced(6,0,4,s)},t.setUniforms=function(e,t,i){if(t.components.buffer.textureBuffer.bind(e,P),i.multipassTerrainEnabled&&(e.setUniform2fv("cameraNearFar",i.camera.nearFar),e.setUniform2fv("inverseViewport",i.inverseViewport),d.bindMultipassTerrainUniforms(e,this.rctx,i)),"origin"in t.transform)e.setUniformMatrix4fv("uView",i.localViewMatrixForEdges),e.setUniformMatrix4fv("uModel",t.transform.modelMatrix),h.Slice.bindUniforms(e,this.settings,i.slicePlane,t.transform.origin.vec3);else{const r=new g.TwoVectorPosition(t.transform.position),s=a.transpose(v,a.invert(v,t.transform.rotationScale)),n=new m.ComponentDrawParameters;o.copy(n.worldFromModel_TL,r.low),o.copy(n.worldFromModel_TH,r.high),a.copy(n.worldFromModel_RS,t.transform.rotationScale),a.copy(n.transformNormal_GlobalFromModel,s),f.VertexPosition.bindModelTransform(e,n),e.setUniformMatrix3fv("uTransformNormal_GlobalFromModel",n.transformNormal_GlobalFromModel);const l=i.camera.viewInverseTransposeMatrix,c=o.set(S,l[3],l[7],l[11]);h.Slice.bindUniforms(e,this.settings,i.slicePlane,c)}"uber"!==this.settings.type&&"sketch"!==this.settings.type||this.setSketchUniforms(e),e.setUniform1f("uWorldLineRadiusPerDistance",Math.tan(i.camera.fovY/2)/(i.camera.fullViewport[3]/2))},t.setSketchUniforms=function(e){const t=this.settings.strokesTexture,r=t.texture;i.isNone(r)||(this.rctx.bindTexture(r,0),e.setUniform1i("uStrokesTexture",0),e.setUniform2f("uStrokesTextureScale",1/r.descriptor.width,1/r.descriptor.height),e.setUniform1f("uStrokesLog2Resolution",s.log2(t.resolution)),e.setUniform1f("uStrokesNormalizationScale",t.normalizationScale),e.setUniform1f("uStrokesAmplitude",t.amplitude),e.setUniform1f("uStrokeVariants",t.variants))},t.sortRenderables=function(){this.renderablesDirty=!1,this.sortedRenderables[1][1].clear(),this.sortedRenderables[1][2].clear(),this.sortedRenderables[2][1].clear(),this.sortedRenderables[2][2].clear(),this.renderables.forEach((e=>{0!==e.objectTransparency&&0!==e.edgeTransparency&&this.sortedRenderables[e.objectTransparency][e.edgeTransparency].push(e)}));const e=(e,t)=>"origin"in e.transform&&"origin"in t.transform?e.transform.origin.id<t.transform.origin.id?-1:e.transform.origin.id>t.transform.origin.id?1:0:0;this.sortedRenderables[1][1].sort(e),this.sortedRenderables[1][2].sort(e),this.sortedRenderables[2][1].sort(e),this.sortedRenderables[2][2].sort(e)},e.getKey=function(e,t,i){return`edges-t:${e}:${t}:${i}`},e}();const P={texName:"uComponentDataTex",invDimName:"uComponentDataTexInvDim",unit:2},v=l.create(),S=n.create();e.EXTENSION_LENGTH_OFFSET=T,e.EdgeRenderer=E,e.LINE_WIDTH_FRACTION_FACTOR=p,e.componentDataBindParameters=P,Object.defineProperty(e,"__esModule",{value:!0})}));
