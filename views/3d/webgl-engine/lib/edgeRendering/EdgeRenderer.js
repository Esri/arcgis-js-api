/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{releaseMaybe as e,isNone as r}from"../../../../../core/maybe.js";import t from"../../../../../core/PooledArray.js";import{t as s,e as i}from"../../../../../chunks/mat3.js";import{c as n}from"../../../../../chunks/mat3f32.js";import{c as o,s as a}from"../../../../../chunks/vec3.js";import h from"../../../support/debugFlags.js";import{doublePrecisionRequiresObfuscation as l}from"../../core/shaderLibrary/util/DoublePrecision.glsl.js";import{TwoVectorPosition as d}from"../../core/util/TwoVectorPosition.js";import{EdgeDrawParameters as c}from"./EdgeShaderParameters.js";import{EdgeShaderTechnique as u}from"./EdgeShaderTechnique.js";import{EdgeShaderTechniqueConfiguration as m}from"./EdgeShaderTechniqueConfiguration.js";import{Transparency as f}from"./interfaces.js";import{EdgeUtilMode as g}from"../../shaders/sources/edgeRenderer/EdgeUtil.glsl.js";import{PrimitiveType as b}from"../../../../webgl/enums.js";const T=8,_=128,R={type:"uber",hasSlicePlane:!1,strokesTexture:null,legacy:!0,spherical:!0};class p{constructor(){this._value=0}get value(){return this._value}increment(){this._value++}decrement(){this._value--}}const A={solid:g.SOLID,sketch:g.SKETCH,uber:g.MIXED};class P{constructor(e,r,s){this.rctx=e,this.shaderTechniqueRepository=r,this._configuration=new m,this.refCount=new p,this.renderables=new Set,this.sortedRenderables={[f.TRANSPARENT]:{[f.TRANSPARENT]:new t,[f.OPAQUE]:new t},[f.OPAQUE]:{[f.TRANSPARENT]:new t,[f.OPAQUE]:new t}},this._renderablesDirty=!1,this._drawParameters=new c,this._settings={...R,...s},this.key=P.getKey(this._settings.type,this._settings.hasSlicePlane,this._settings.legacy);const i=this._settings.strokesTexture.variants;this.writerSettings={variants:i,reducedPrecision:h.TESTS_DISABLE_OPTIMIZATIONS},this._configuration.legacy=this._settings.legacy,this._configuration.mode=A[this._settings.type],this._configuration.silhouette=!1,this._configuration.antialiasing=!!this.rctx.capabilities.blendMinMax,this._configuration.hasSlicePlane=this._settings.hasSlicePlane,this._configuration.doublePrecisionRequiresObfuscation=l(e),this._configuration.spherical=s.spherical}dispose(){this._technique=e(this._technique)}addRenderable(e){this.renderables.add(e),this._renderablesDirty=!0}removeRenderable(e){this.renderables.delete(e),this._renderablesDirty=!0}setRenderablesDirty(){this._renderablesDirty=!0}forEachRenderable(e,r){this._renderablesDirty&&this._sortRenderables(),this.sortedRenderables[r][f.TRANSPARENT].forAll(e),this.sortedRenderables[r][f.OPAQUE].forAll(e)}updateTechnique(e,r){return this._configuration.hasMultipassTerrain=!!e.multipassTerrain.enabled,this._configuration.cullAboveGround=!!e.multipassTerrain.cullAboveGround,this._configuration.silhouette=r,this._technique=this.shaderTechniqueRepository.releaseAndAcquire(u,this._configuration,this._technique),this._technique}bindRegularEdges(e,r){return this.rctx.bindTechnique(this.updateTechnique(r,!1),e,r)}bindSilhouetteEdges(e,r){return this.rctx.bindTechnique(this.updateTechnique(r,!0),e,r)}renderRegularEdges(e,r,t,s,i){this._render(e,r,r.regular.vao,t,s,i)}renderSilhouetteEdges(e,r,t,s,i){this._render(e,r,r.silhouette.vao,t,s,i)}_render(e,r,t,s,i,n){this._bindDraw(e,r,s,n),this.rctx.bindVAO(t),this.rctx.capabilities.instancing.drawArraysInstanced(b.TRIANGLE_FAN,0,4,i)}_bindDraw(e,r,t,n){if(r.components.buffer.textureBuffer.bind(e,E,S),"origin"in r.transform)e.setUniformMatrix4fv("localView",n),e.setUniformMatrix4fv("model",r.transform.modelMatrix),o(this._drawParameters.slicePlaneLocalOrigin,r.transform.origin.vec3);else{const e=new d(r.transform.position),n=s(N,i(N,r.transform.rotationScale));this._drawParameters.transformWorldFromModelTL=e.low,this._drawParameters.transformWorldFromModelTH=e.high,this._drawParameters.transformWorldFromModelRS=r.transform.rotationScale,this._drawParameters.transformNormalGlobalFromModel=n;const o=t.camera.viewInverseTransposeMatrix;a(this._drawParameters.slicePlaneLocalOrigin,o[3],o[7],o[11])}e.bindDraw(this._drawParameters,t),"uber"!==this._settings.type&&"sketch"!==this._settings.type||this._setSketchUniforms(e)}_setSketchUniforms(e){const t=this._settings.strokesTexture,s=t.texture;r(s)||(e.bindTexture("strokesTexture",s),e.setUniform2f("strokesTextureScale",1/s.descriptor.width,1/s.descriptor.height),e.setUniform1f("strokesLog2Resolution",Math.log2(t.resolution)),e.setUniform1f("strokesNormalizationScale",t.normalizationScale),e.setUniform1f("strokesAmplitude",t.amplitude),e.setUniform1f("strokeVariants",t.variants))}_sortRenderables(){this._renderablesDirty=!1,this.sortedRenderables[f.TRANSPARENT][f.TRANSPARENT].clear(),this.sortedRenderables[f.TRANSPARENT][f.OPAQUE].clear(),this.sortedRenderables[f.OPAQUE][f.TRANSPARENT].clear(),this.sortedRenderables[f.OPAQUE][f.OPAQUE].clear(),this.renderables.forEach((e=>{e.objectTransparency!==f.INVISIBLE&&e.edgeTransparency!==f.INVISIBLE&&this.sortedRenderables[e.objectTransparency][e.edgeTransparency].push(e)}));const e=(e,r)=>"origin"in e.transform&&"origin"in r.transform?e.transform.origin.id<r.transform.origin.id?-1:e.transform.origin.id>r.transform.origin.id?1:0:0;this.sortedRenderables[f.TRANSPARENT][f.TRANSPARENT].sort(e),this.sortedRenderables[f.TRANSPARENT][f.OPAQUE].sort(e),this.sortedRenderables[f.OPAQUE][f.TRANSPARENT].sort(e),this.sortedRenderables[f.OPAQUE][f.OPAQUE].sort(e)}static getKey(e,r,t){return`edges-t:${e}:${r}:${t}`}}const E="componentDataTex",S="componentDataTexInvDim",N=n();export{_ as EXTENSION_LENGTH_OFFSET,P as EdgeRenderer,T as LINE_WIDTH_FRACTION_FACTOR,S as componentDataInvDimName,E as componentDataTexName};
