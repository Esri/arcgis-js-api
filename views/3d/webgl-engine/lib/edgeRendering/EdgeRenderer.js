// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../../core/mathUtils","../../../../../core/maybe","../../../../../core/PooledArray","../../../../../core/libs/gl-matrix-2/mat3","../../../../../core/libs/gl-matrix-2/mat3f32","../../../../../core/libs/gl-matrix-2/vec3","../../../../../core/libs/gl-matrix-2/vec3f64","../../collections/Component/Material/ComponentTechnique","../../core/shaderLibrary/Slice.glsl","../../core/shaderLibrary/attributes/VertexPosition.glsl","../../core/shaderLibrary/util/DoublePrecision.glsl","../../core/util/TwoVectorPosition","./EdgeShaderTechnique"],(function(e,t,i,r,s,n,o,a,c,l,h,d,u,f,m,g){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.componentDataBindParameters=t.EdgeRenderer=t.EXTENSION_LENGTH_OFFSET=t.LINE_WIDTH_FRACTION_FACTOR=void 0,t.LINE_WIDTH_FRACTION_FACTOR=8,t.EXTENSION_LENGTH_OFFSET=128;var p={type:"uber",slicePlaneEnabled:!1,sliceHighlightDisabled:!1,strokesTexture:null,legacy:!0},b=function(){function e(){this._value=0}return Object.defineProperty(e.prototype,"value",{get:function(){return this._value},enumerable:!1,configurable:!0}),e.prototype.increment=function(){this._value++},e.prototype.decrement=function(){this._value--},e}(),y={solid:0,sketch:1,uber:2},T=function(){function e(t,r,s){var o,a,c;this.rctx=t,this.shaderTechniqueRepository=r,this.config=new g.EdgeShaderTechnique.Configuration,this.technique=null,this.refCount=new b,this.renderables=new Set,this.sortedRenderables=((o={})[1]=((a={})[1]=new n,a[2]=new n,a),o[2]=((c={})[1]=new n,c[2]=new n,c),o),this.renderablesDirty=!1,this.settings=i.__assign(i.__assign({},p),s),this.key=e.getKey(this.settings.type,this.settings.slicePlaneEnabled,this.settings.legacy);var l=this.settings.strokesTexture.variants;this.writerSettings={variants:l},this.config.legacy=this.settings.legacy,this.config.mode=y[this.settings.type],this.config.silhouette=!1,this.config.antialiasing=!!this.rctx.capabilities.blendMinMax,this.config.slicePlaneEnabled=this.settings.slicePlaneEnabled,this.config.doublePrecisionRequiresObfuscation=f.doublePrecisionRequiresObfuscation(t)}return e.prototype.dispose=function(){this.technique&&(this.shaderTechniqueRepository.release(this.technique),this.technique=null)},e.prototype.addRenderable=function(e){this.renderables.add(e),this.renderablesDirty=!0},e.prototype.removeRenderable=function(e){this.renderables.delete(e),this.renderablesDirty=!0},e.prototype.setRenderablesDirty=function(){this.renderablesDirty=!0},e.prototype.forEachRenderable=function(e,t){this.renderablesDirty&&this.sortRenderables(),this.sortedRenderables[t][1].forEachSimple(e),this.sortedRenderables[t][2].forEachSimple(e)},e.prototype.bindRegularEdges=function(e,t){this.config.silhouette=!1,this.technique=this.shaderTechniqueRepository.acquireAndReleaseExisting(g.EdgeShaderTechnique,this.config,this.technique),this.technique.bindPass(this.rctx,{bindParameters:e,edgeRenderParameters:t}),this.rctx.setPipelineState(this.technique.pipeline),this.rctx.bindProgram(this.technique.program)},e.prototype.bindSilhouetteEdges=function(e,t){this.config.silhouette=!0,this.technique=this.shaderTechniqueRepository.acquireAndReleaseExisting(g.EdgeShaderTechnique,this.config,this.technique),this.technique.bindPass(this.rctx,{bindParameters:e,edgeRenderParameters:t}),this.rctx.setPipelineState(this.technique.pipeline),this.rctx.bindProgram(this.technique.program)},e.prototype.renderRegularEdges=function(e,t,i){this.render(this.technique.program,e,e.regular.vao,t,i)},e.prototype.renderSilhouetteEdges=function(e,t,i){this.render(this.technique.program,e,e.silhouette.vao,t,i)},e.prototype.render=function(e,t,i,r,s){this.setUniforms(e,t,r),this.rctx.bindVAO(i),this.rctx.capabilities.instancing.drawArraysInstanced(6,0,4,s)},e.prototype.setUniforms=function(e,i,r){if(i.components.buffer.textureBuffer.bind(e,t.componentDataBindParameters),"origin"in i.transform)e.setUniformMatrix4fv("uView",r.localViewMatrixForEdges),e.setUniformMatrix4fv("uModel",i.transform.modelMatrix),d.Slice.bindUniforms(e,this.settings,r.slicePlane,i.transform.origin.vec3);else{var s=new m.TwoVectorPosition(i.transform.position),n=o.mat3.transpose(R,o.mat3.invert(R,i.transform.rotationScale)),a=new h.ComponentDrawParameters;c.vec3.copy(a.worldFromModel_TL,s.low),c.vec3.copy(a.worldFromModel_TH,s.high),o.mat3.copy(a.worldFromModel_RS,i.transform.rotationScale),o.mat3.copy(a.transformNormal_GlobalFromModel,n),u.VertexPosition.bindModelTransform(e,a),e.setUniformMatrix3fv("uTransformNormal_GlobalFromModel",a.transformNormal_GlobalFromModel);var l=r.camera.viewInverseTransposeMatrix,f=c.vec3.set(v,l[3],l[7],l[11]);d.Slice.bindUniforms(e,this.settings,r.slicePlane,f)}"uber"!==this.settings.type&&"sketch"!==this.settings.type||this.setSketchUniforms(e),e.setUniform1f("uWorldLineRadiusPerDistance",Math.tan(r.camera.fovY/2)/(r.camera.fullViewport[3]/2))},e.prototype.setSketchUniforms=function(e){var t=this.settings.strokesTexture,i=t.texture;s.isNone(i)||(this.rctx.bindTexture(i,0),e.setUniform1i("uStrokesTexture",0),e.setUniform2f("uStrokesTextureScale",1/i.descriptor.width,1/i.descriptor.height),e.setUniform1f("uStrokesLog2Resolution",r.log2(t.resolution)),e.setUniform1f("uStrokesNormalizationScale",t.normalizationScale),e.setUniform1f("uStrokesAmplitude",t.amplitude),e.setUniform1f("uStrokeVariants",t.variants))},e.prototype.sortRenderables=function(){var e=this;this.renderablesDirty=!1,this.sortedRenderables[1][1].clear(),this.sortedRenderables[1][2].clear(),this.sortedRenderables[2][1].clear(),this.sortedRenderables[2][2].clear(),this.renderables.forEach((function(t){0!==t.objectTransparency&&0!==t.edgeTransparency&&e.sortedRenderables[t.objectTransparency][t.edgeTransparency].push(t)}));var t=function(e,t){return"origin"in e.transform&&"origin"in t.transform?e.transform.origin.id<t.transform.origin.id?-1:e.transform.origin.id>t.transform.origin.id?1:0:0};this.sortedRenderables[1][1].sort(t),this.sortedRenderables[1][2].sort(t),this.sortedRenderables[2][1].sort(t),this.sortedRenderables[2][2].sort(t)},e.getKey=function(e,t,i){return"edges-t:"+e+":"+t+":"+i},e}();t.EdgeRenderer=T,t.componentDataBindParameters={texName:"uComponentDataTex",invDimName:"uComponentDataTexInvDim",unit:2};var R=a.mat3f32.create(),v=l.vec3f64.create()}));