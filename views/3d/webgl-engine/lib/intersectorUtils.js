// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../../Graphic","../../../../core/maybe","../../../../core/libs/gl-matrix-2/mat3","../../../../core/libs/gl-matrix-2/mat3f64","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../core/libs/gl-matrix-2/vec4","../../../../core/libs/gl-matrix-2/vec4f64","../../support/geometryUtils","../../support/geometryUtils/boundedPlane","./Object3D"],function(t,e,r,i,n,a,s,o,c,l,u,h,p,f,m){function d(t){return function(e,r,i){return c.vec3.lerp(P,e,r,i),!f.extrusionContainsPoint(t,P)}}function y(t,e){return i.isNone(t)||null==t.layerUid?null:i.isSome(e.graphicsView)&&t.layerUid===e.graphicsView.mockLayerId?e.graphics:e.map.findLayerByUid(t.layerUid)}function g(t,e,r){if(i.isNone(t))return null;var n=y(t,e);if(i.isNone(n))return null;if(n===e.graphics)return i.isSome(e.graphicsView)?i.expect(e.graphicsView.getGraphicFromGraphicUid(t.graphicUid)):null;var a=e.allLayerViews.find(function(t){return t.layer===n});return a?v(a,t,r):null}function v(t,e,r){return!t||t.suspended?null:i.isSome(r)&&"getGraphicFromStageObject"in t?t.getGraphicFromStageObject(r.obj,r.triangleNr):"getGraphicFromGraphicUid"in t&&null!=e.graphicUid?t.getGraphicFromGraphicUid(e.graphicUid):null}function b(t,e){var r=t.metadata.layerUid;return null!=r?e.map.findLayerByUid(r):null}function _(t,e){var i=e.computeMapPointFromVec3d(t.point),n=new r(i),a=t.metadata.layerUid;if(null!=a){var s=e.map.findLayerByUid(a);n.layer=s,n.sourceLayer=s}return n}Object.defineProperty(e,"__esModule",{value:!0}),e.sliceFilterPredicate=d;var I=function(){function t(){this.hud=!0,this.selectOpaqueTerrainOnly=!0,this.invisibleTerrain=!1,this.backfacesTerrain=!0,this.storeTerrainResults=!0,this.storeAll=!0}return t}();e.EnableIntersectorOptions=I;var O=function(){function t(){this._transform=o.mat4f64.create(),this._transformInverse=new T({value:this._transform},s.mat4.invert,o.mat4f64.create),this._transformInverseTranspose=new T(this._transformInverse,s.mat4.transpose,o.mat4f64.create),this._transformTranspose=new T({value:this._transform},s.mat4.transpose,o.mat4f64.create),this._transformInverseRotation=new T({value:this._transform},n.mat3.normalFromMat4Legacy,a.mat3f64.create)}return t.prototype.invalidateLazyTransforms=function(){this._transformInverse.invalidate(),this._transformInverseTranspose.invalidate(),this._transformTranspose.invalidate(),this._transformInverseRotation.invalidate()},Object.defineProperty(t.prototype,"transform",{get:function(){return this._transform},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"inverse",{get:function(){return this._transformInverse.value},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"inverseTranspose",{get:function(){return this._transformInverseTranspose.value},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"inverseRotation",{get:function(){return this._transformInverseRotation.value},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"transpose",{get:function(){return this._transformTranspose.value},enumerable:!0,configurable:!0}),t.prototype.setTransformMatrix=function(t){s.mat4.copy(this._transform,t)},t.prototype.multiplyTransform=function(t){s.mat4.multiply(this._transform,this._transform,t)},t.prototype.set=function(t){s.mat4.copy(this._transform,t),this.invalidateLazyTransforms()},t.prototype.setAndInvalidateLazyTransforms=function(t,e){this.setTransformMatrix(t),this.multiplyTransform(e),this.invalidateLazyTransforms()},t}();e.IntersectorTransform=O;var T=function(){function t(t,e,r){this.original=t,this.update=e,this.dirty=!0,this.transform=r()}return t.prototype.invalidate=function(){this.dirty=!0},Object.defineProperty(t.prototype,"value",{get:function(){return this.dirty&&(this.update(this.transform,this.original.value),this.dirty=!1),this.transform},enumerable:!0,configurable:!0}),t}(),L=function(){function t(){this.min=new w,this.max=new w,this.hud=new w,this.terrain=new w}return t.prototype.init=function(t){this.min.init(t),this.max.init(t),this.hud.init(t),this.terrain.init(t),this.all=[]},t}();e.IntersectorResults=L;var w=function(){function t(t){this.normal=l.vec3f64.create(),this.transformation=o.mat4f64.create(),this._ray=p.ray.create(),this.init(t)}return Object.defineProperty(t.prototype,"ray",{get:function(){return this._ray},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hasIntersectionPoint",{get:function(){return null!=this.dist},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"distanceInRenderSpace",{get:function(){if(null!=this.dist)return c.vec3.scale(j,this.ray.direction,this.dist),c.vec3.length(j)},enumerable:!0,configurable:!0}),t.prototype.getIntersectionPoint=function(t){return!!this.hasIntersectionPoint&&(c.vec3.scale(j,this.ray.direction,this.dist),c.vec3.add(t,this.ray.origin,j),!0)},t.prototype.getTransformedNormal=function(t){return c.vec3.copy(x,this.normal),x[3]=0,u.vec4.transformMat4(x,x,this.transformation),c.vec3.copy(t,x),c.vec3.normalize(t,t),t},t.prototype.set=function(t,e,r,i,n,a,o,u,h,p){t instanceof m&&(t={type:"stage",obj:t}),this.dist=r,c.vec3.copy(this.normal,i),s.mat4.copy(this.transformation,n),this.target=t,this.name=e,this.drapedLayerOrder=a,this.center=o?l.vec3f64.clone(o):null,this.geometryId=u,this.triangleNr=h,this.drapedLayerGraphicOrder=p},t.prototype.copyFrom=function(t){p.ray.copy(t._ray,this._ray),this.dist=t.dist,this.target=t.target,this.name=t.name,this.drapedLayerOrder=t.drapedLayerOrder,this.center=t.center?l.vec3f64.clone(t.center):null,this.geometryId=t.geometryId,this.triangleNr=t.triangleNr,this.intersector=t.intersector,this.drapedLayerGraphicOrder=t.drapedLayerGraphicOrder,c.vec3.copy(this.normal,t.normal),s.mat4.copy(this.transformation,t.transformation)},t.prototype.init=function(t){this.dist=void 0,this.target=void 0,this.name=void 0,this.drapedLayerOrder=void 0,this.drapedLayerGraphicOrder=void 0,this.center=null,this.geometryId=null,this.triangleNr=null,this.intersector="Stage",t?p.ray.copy(t,this._ray):this._ray=p.ray.create()},t.prototype.toOwner=function(t){if(!this.target)return null;switch(this.target.type){case"stage":return y(this.target.obj.getMetadata(),t);case"external":switch(this.intersector){case"PointRenderer":return b(this.target,t);case"LodRenderer":case"DrapedRenderer":return y(this.target.metadata,t);case"TerrainRenderer":return t.map&&t.map.ground}}return null},t.prototype.toGraphic=function(t){if(!this.target)return null;switch(this.target.type){case"stage":var e=this.target.obj,r=this.triangleNr;return g(e.getMetadata(),t,{obj:e,triangleNr:r});case"external":switch(this.intersector){case"PointRenderer":return _(this.target,t);case"LodRenderer":case"DrapedRenderer":return g(this.target.metadata,t,null)}}return null},t}();e.IntersectorResult=w,e.TERRAIN_ID="terrain";var P=l.vec3f64.create(),j=l.vec3f64.create(),x=h.vec4f64.create()});