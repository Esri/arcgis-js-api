/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../webgl/FramebufferObject","../../../webgl/Renderbuffer","../../../webgl/Texture","../../../webgl/Util"],(function(e,t,r,i,h){"use strict";const s={dataType:5121,internalFormat:6408},o={};let d=function(){function e(e){this.rctx=e,this._activeTargets=new Set,this._depthTextures=new Map,this._depthBuffers=new Map,this._colorTextures=new Map,this._framebuffers=new Map,this._nextId=1,this.depthTextureSupported=e.capabilities.depthTexture}var d=e.prototype;return d.dispose=function(){this._depthBuffers.forEach((e=>e.dispose())),this._depthBuffers.clear(),this._depthTextures.forEach((e=>e.dispose())),this._depthTextures.clear(),this._colorTextures.forEach((e=>e.dispose())),this._colorTextures.clear(),this._framebuffers.forEach((e=>e.dispose())),this._framebuffers.clear()},d.disposeTargetResource=function(e){const t=e.id;this._activeTargets.has(t)&&(this._activeTargets.delete(t),this.disposeWithFramebuffers(this._depthTextures,t),this.disposeWithFramebuffers(this._depthBuffers,t),this.disposeWithFramebuffers(this._colorTextures,t))},d.disposeWithFramebuffers=function(e,t){const r=e.get(t);r&&(this._framebuffers.forEach(((e,t)=>{e.colorAttachment!==r&&e.depthStencilAttachment!==r||(e.detachAll(),e.dispose(),this._framebuffers.delete(t))})),r.dispose(),e.delete(t))},d.getDepthTexture=function(e,t){if(!this.depthTextureSupported)return;let r=this._depthTextures.get(e.id);return r&&(r.descriptor.width===t.width&&r.descriptor.height===t.height||(r.dispose(),r=void 0)),r||(r=new i(this.rctx,{target:3553,pixelFormat:34041,dataType:34042,samplingMode:9728,wrapMode:33071,width:t.width,height:t.height}),this._depthTextures.set(e.id,r),this._activeTargets.add(e.id)),r},d.getAllocatedDepthTexture=function(e){return this._depthTextures.get(e.id)},d.getDepthBuffer=function(e,t){if(this.depthTextureSupported)return;let i=this._depthBuffers.get(e.id);return i?i.descriptor.width===t.width&&i.descriptor.height===t.height||i.resize(t.width,t.height):(i=new r(this.rctx,{internalFormat:34041,...t}),this._depthBuffers.set(e.id,i),this._activeTargets.add(e.id)),i},d.getColorTexture=function(e,t){let r=this._colorTextures.get(e.id);return r&&(r.descriptor.width===t.width&&r.descriptor.height===t.height||(r.dispose(),r=void 0)),r||(r=new i(this.rctx,{target:3553,pixelFormat:6408,internalFormat:e.internalFormat,dataType:e.dataType,samplingMode:null!=e.samplingMode?e.samplingMode:9729,wrapMode:33071,width:t.width,height:t.height}),this._colorTextures.set(e.id,r),this._activeTargets.add(e.id)),r},d.getAllocatedColorTexture=function(e){return this._colorTextures.get(e.id)},d.registerDepthTarget=function(e={}){return{id:this._nextId++,...o,...e}},d.registerColorTarget=function(e={}){return{id:this._nextId++,...s,...e}},d.getFramebuffer=function(e,r,i){const h=this.getKey(r,i);let s=this._framebuffers.get(h);const o=this.getColorTexture(r,e);if(this.depthTextureSupported){const r=i?this.getDepthTexture(i,e):void 0;if(!s)return s=i?new t(this.rctx,{colorTarget:0,depthStencilTarget:4},o,r):new t(this.rctx,{colorTarget:0,depthStencilTarget:0},o),this._framebuffers.set(h,s),s;return(s.width!==e.width||s.height!==e.height||s.colorTexture!==o||s.depthStencilTexture!==r)&&(s.detachAll(),s.resize(e.width,e.height),s.attachColorTexture(o),s.attachDepthStencilTexture(r)),s}const d=i?this.getDepthBuffer(i,e):void 0;if(!s)return s=new t(this.rctx,{colorTarget:0,depthStencilTarget:i?3:0},o,d),this._framebuffers.set(h,s),s;return(s.width!==e.width||s.height!==e.height||s.colorTexture!==o)&&(s.detachAll(),s.resize(e.width,e.height),s.attachColorTexture(o),s.attachDepthStencilBuffer(d)),s},d.getKey=function(e,t){return`${e.id}_${t?t.id:"X"}_${e.name}${t?"_"+t.name:""}`},d.getGpuMemoryUsage=function(){let e=0;const t=new Set,r=r=>{t.has(r)||(t.add(r),e+=h.getGpuMemoryUsage(r))};return this._depthTextures.forEach(r),this._colorTextures.forEach(r),this._depthBuffers.forEach(r),e},e}();e.RenderTargetHelper=d,Object.defineProperty(e,"__esModule",{value:!0})}));
