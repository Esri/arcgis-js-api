/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/Evented","../../../../core/Logger","../../../../core/maybe","../../../../core/promiseUtils","./TextureTechnique","./Util","../../../support/Scheduler","../../../webgl/Texture"],(function(e,t,r,n,a,s,i,u,o,c){"use strict";const l=n.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository"),h=8;let f=function(){function e(e,t,n){this._stage=e,this._rctx=n,this._idToRefCountedTexture=new Map,this._loadingCount=0,this._frameUpdates=new Map,this._fallbackTextureData=new Uint8Array(h*h*4),this._fallbackTextureTransparentData=new Uint8Array(h*h*4),this.events=new r,this._textureTechnique=t.acquire(i.TextureTechnique,new i.TextureTechniqueConfiguration);for(let r=0;r<this._fallbackTextureData.length;++r)this._fallbackTextureData[r]=255,this._fallbackTextureTransparentData[r]=(r+1)%4!=0?255:0;this._fallbackTextureDesc={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:h,height:h,maxAnisotropy:this._rctx.parameters.maxMaxAnisotropy},this._frameTask=e.resourceController.scheduler.registerTask(o.TaskPriority.TEXTURE_UNLOAD)}var n=e.prototype;return n.dispose=function(){this._frameTask.remove(),a.isSome(this._fallbackTexture)&&(this._fallbackTexture.dispose(),this._fallbackTexture=null),a.isSome(this._fallbackTextureTransparent)&&(this._fallbackTextureTransparent.dispose(),this._fallbackTextureTransparent=null),this._stage.forEachOfType(4,(e=>e.unload()))},n.acquire=function(e,t=!1,r){const n=this._getOrCreateRef(e,t,r);return n.ref(),n},n.update=function(){let e=!1;this._frameUpdates.forEach((t=>{const r=t.texture.frameUpdate(this._rctx,this._textureTechnique,t.previousToken);r>=0&&r!==t.previousToken&&(t.previousToken=r,e=!0)})),e&&this.events.emit("changed",0)},n._getOrCreateRef=function(e,t,r){const n=this._idToRefCountedTexture.get(e);return n||this._createNewRef(e,t,r)},n._createNewRef=function(e,t,r){const n=this._stage.getObject(e);u.assert(void 0!==n);const a=n.events.on("unloaded",(()=>{a.remove(),this._onTextureUnloaded(e)})),i=new T;this._idToRefCountedTexture.set(e,i);const o=n.load(this._rctx,this._textureTechnique);this._loadingCount++;const c=t=>(this._loadingCount--,this._updateGLTexture(i,t),r&&r(i),n.requiresFrameUpdates&&this._frameUpdates.set(e,{texture:n,previousToken:-1}),i),h=e=>{this._loadingCount--,s.isAbortError(e)||l.error(e)};return s.isPromiseLike(o)?(this._updateGLTexture(i,t?this.fallbackTextureTransparent:this.fallbackTexture),o.then(c,h)):c(o),i},n._updateGLTexture=function(e,t){e.glTexture=t,this.events.emit("changed",1)},n.release=function(e){const t=this._idToRefCountedTexture.get(e);if(t&&(t.unref(),t.isUnreferenced)){const r=this._stage.getObject(e);this._frameTask.schedule((()=>{t.isUnreferenced&&r.unload()}))}},n.getTexture=function(e){return this._stage.getObject(e)},n._onTextureUnloaded=function(e){this._idToRefCountedTexture.delete(e),this._frameUpdates.delete(e)},t._createClass(e,[{key:"updating",get:function(){return this.loadingCount>0||this._frameTask.updating}},{key:"loadingCount",get:function(){return this._loadingCount}},{key:"fallbackTexture",get:function(){return a.isNone(this._fallbackTexture)&&(this._fallbackTexture=new c(this._rctx,this._fallbackTextureDesc,this._fallbackTextureData)),this._fallbackTexture}},{key:"fallbackTextureTransparent",get:function(){return a.isNone(this._fallbackTextureTransparent)&&(this._fallbackTextureTransparent=new c(this._rctx,this._fallbackTextureDesc,this._fallbackTextureTransparentData)),this._fallbackTextureTransparent}}]),e}(),T=function(){function e(){this._refCount=0,this.glTexture=null}var r=e.prototype;return r.ref=function(){++this._refCount},r.unref=function(){0!==this._refCount?--this._refCount:l.error("Cannot dereference texture that has no references!")},t._createClass(e,[{key:"isUnreferenced",get:function(){return 0===this._refCount}}]),e}();e.RefCountedTexture=T,e.TextureRepository=f,Object.defineProperty(e,"__esModule",{value:!0})}));
