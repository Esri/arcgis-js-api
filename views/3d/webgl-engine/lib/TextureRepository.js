// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","../../../../core/Evented","../../../../core/Logger","../../../../core/maybe","../../../../core/promiseUtils","./TextureTechnique","./Util","../../../support/Scheduler","../../../webgl/Texture"],(function(e,t,r,n,a,i,u,o,s,f){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RefCountedTexture=t.TextureRepository=void 0;var c=n.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository"),l=function(){function e(e,t,n,i){this._textures=t,this.rctx=i,this._idToRefCountedTexture=new Map,this._textureTechniqueConfig=new u.TextureTechniqueConfiguration,this._loadingCount=0,this._frameUpdates=new Map,this._fallbackTextureData=new Uint8Array(256),this._fallbackTextureTransparentData=new Uint8Array(256),this.events=new r,this._textureTechnique=n.acquireAndReleaseExisting(u.TextureTechnique,this._textureTechniqueConfig,this._textureTechnique);for(var o=0;o<this._fallbackTextureData.length;++o)this._fallbackTextureData[o]=255,this._fallbackTextureTransparentData[o]=(o+1)%4!=0?255:0;this._fallbackTextureDesc={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:8,height:8,maxAnisotropy:this.rctx.parameters.maxMaxAnisotropy},this._frameTask=a.isSome(e)?e.registerTask(s.Task.TEXTURE_UNLOAD,(function(){}),(function(){return!1})):new s.TestTaskHandle}return e.prototype.dispose=function(){this._frameTask.remove(),a.isSome(this._fallbackTexture)&&(this._fallbackTexture.dispose(),this._fallbackTexture=null),a.isSome(this._fallbackTextureTransparent)&&(this._fallbackTextureTransparent.dispose(),this._fallbackTextureTransparent=null),this._textures.forEach((function(e){return e.unload()}))},e.prototype.acquire=function(e,t,r){void 0===t&&(t=!1);var n=this._getOrCreateRef(e,t,r);return n.ref(),n},e.prototype.update=function(){var e=this,t=!1;this._frameUpdates.forEach((function(r){var n=r.texture.frameUpdate(e.rctx,e._textureTechnique,r.previousToken);n>=0&&n!==r.previousToken&&(r.previousToken=n,t=!0)})),t&&this.events.emit("changed",0)},e.prototype._getOrCreateRef=function(e,t,r){var n=this._idToRefCountedTexture.get(e);return n||this._createNewRef(e,t,r)},e.prototype._createNewRef=function(e,t,r){var n=this,a=this._textures.get(e);o.assert(void 0!==a);var u=a.events.on("unloaded",(function(){u.remove(),n._onTextureUnloaded(e)})),s=new h;this._idToRefCountedTexture.set(e,s);var f=a.load(this.rctx,this._textureTechnique);this._loadingCount++;var l=function(t){return n._loadingCount--,n._updateGLTexture(s,t),r&&r(s),a.requiresFrameUpdates&&n._frameUpdates.set(e,{texture:a,previousToken:-1}),s};return i.isThenable(f)?(this._updateGLTexture(s,t?this.fallbackTextureTransparent:this.fallbackTexture),f.then(l,(function(e){n._loadingCount--,i.isAbortError(e)||c.error(e)}))):l(f),s},e.prototype._updateGLTexture=function(e,t){e.glTexture=t,this.events.emit("changed",1)},e.prototype.release=function(e){var t=this._idToRefCountedTexture.get(e);if(t&&(t.unref(),t.isUnreferenced)){var r=this._textures.get(e);this._frameTask.schedule((function(){t.isUnreferenced&&r.unload()}))}},e.prototype.getTexture=function(e){return this._textures.get(e)},Object.defineProperty(e.prototype,"loadingCount",{get:function(){return this._loadingCount},enumerable:!1,configurable:!0}),e.prototype._onTextureUnloaded=function(e){this._idToRefCountedTexture.delete(e),this._frameUpdates.delete(e)},Object.defineProperty(e.prototype,"fallbackTexture",{get:function(){return a.isNone(this._fallbackTexture)&&(this._fallbackTexture=new f(this.rctx,this._fallbackTextureDesc,this._fallbackTextureData)),this._fallbackTexture},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"fallbackTextureTransparent",{get:function(){return a.isNone(this._fallbackTextureTransparent)&&(this._fallbackTextureTransparent=new f(this.rctx,this._fallbackTextureDesc,this._fallbackTextureTransparentData)),this._fallbackTextureTransparent},enumerable:!1,configurable:!0}),e}();t.TextureRepository=l;var h=function(){function e(){this._refCount=0,this.glTexture=null}return Object.defineProperty(e.prototype,"isUnreferenced",{get:function(){return 0===this._refCount},enumerable:!1,configurable:!0}),e.prototype.ref=function(){++this._refCount},e.prototype.unref=function(){0!==this._refCount?--this._refCount:c.error("Cannot dereference texture that has no references!")},e}();t.RefCountedTexture=h}));