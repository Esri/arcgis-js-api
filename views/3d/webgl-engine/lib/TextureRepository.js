/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Evented","../../../../core/Logger","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/accessorSupport/decorators/property","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","./TextureTechnique","./Util","../../../support/Scheduler"],(function(e,t,r,o,s,i,n,u,a,c,h,p,d,_,f,l){"use strict";const T=i.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository");e.TextureRepository=function(e){function r(t,r,o){var i;return(i=e.call(this,{})||this)._stage=t,i._techniqueRepository=r,i._rctx=o,i._idToRefCountedTexture=new Map,i._loadingCount=0,i._frameUpdates=new Map,i.events=new s,i._frameTask=t.resourceController.scheduler.registerTask(l.TaskPriority.TEXTURE_UNLOAD),i}t._inheritsLoose(r,e);var o=r.prototype;return o.normalizeCtorArgs=function(){return{}},o.dispose=function(){this._frameTask.remove(),this._stage.forEachOfType(4,(e=>e.unload()))},o.acquire=function(e){const t=this._idToRefCountedTexture.get(e);return t?(t.ref(),Promise.resolve(t)):this._createNewRef(e)},o.update=function(){let e=!1;this._frameUpdates.forEach((t=>{const r=t.texture.frameUpdate(this._rctx,this.textureTechnique,t.previousToken);r>=0&&r!==t.previousToken&&(t.previousToken=r,e=!0)})),e&&this.events.emit("changed",0)},o._createNewRef=function(){var e=t._asyncToGenerator((function*(e){const t=this._stage.getObject(e);if(n.isNone(t))return f.assert(void 0!==t),null;const r=t.events.on("unloaded",(()=>{r.remove(),this._onTextureUnloaded(e)})),o=new x(e,(()=>{this._frameTask.schedule((()=>{o.isUnreferenced&&t.unload()}))}));return this._idToRefCountedTexture.set(e,o),o.ref(),n.isSome(t.glTexture)?(this._updateGLTexture(o,t.glTexture),t.requiresFrameUpdates&&this._frameUpdates.set(e,{texture:t,previousToken:-1})):(this._loadingCount++,yield this._stage.schedule((()=>{const r=t.load(this._rctx,(()=>this.textureTechnique)),s=r=>(this._loadingCount--,this._updateGLTexture(o,r),t.requiresFrameUpdates&&this._frameUpdates.set(e,{texture:t,previousToken:-1}),o),i=e=>{this._loadingCount--,u.isAbortError(e)||T.error(e)};return u.isPromiseLike(r)?r.then(s,i):s(r)}))),o}));function r(t){return e.apply(this,arguments)}return r}(),o._updateGLTexture=function(e,t){e.glTexture=t,this.events.emit("changed",1)},o._onTextureUnloaded=function(e){this._idToRefCountedTexture.delete(e),this._frameUpdates.delete(e)},t._createClass(r,[{key:"updating",get:function(){return this._loadingCount>0||this._frameTask.updating}},{key:"textureTechnique",get:function(){return n.isNone(this._textureTechnique)&&(this._textureTechnique=this._techniqueRepository.acquire(_.TextureTechnique,new _.TextureTechniqueConfiguration)),this._textureTechnique}}]),r}(o),r.__decorate([a.property()],e.TextureRepository.prototype,"_loadingCount",void 0),r.__decorate([a.property()],e.TextureRepository.prototype,"_frameTask",void 0),r.__decorate([a.property()],e.TextureRepository.prototype,"updating",null),e.TextureRepository=r.__decorate([d.subclass("esri.views.3d.webgl-engine.lib.TextureRepository")],e.TextureRepository);let x=function(){function e(e,t){this.id=e,this._release=t,this._refCount=0}var r=e.prototype;return r.ref=function(){++this._refCount},r.release=function(){--this._refCount,this._refCount>0||(0!==this._refCount?(T.error("Cannot dereference texture that has no references!"),this._refCount=0):this._release())},t._createClass(e,[{key:"isUnreferenced",get:function(){return 0===this._refCount}}]),e}();Object.defineProperty(e,"__esModule",{value:!0})}));
