/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/Logger","../../../../core/promiseUtils","../../../../core/Evented","../../../support/Scheduler","./Util","../../../webgl/Texture","./TextureTechnique"],(function(e,t,r,n,s,a,i,u,o,l){"use strict";const c=n.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository");let h=function(){function e(e,t,n,s){this._textures=t,this.rctx=s,this._idToRefCountedTexture=new Map,this._textureTechniqueConfig=new l.TextureTechniqueConfiguration,this._loadingCount=0,this._frameUpdates=new Map,this._fallbackTextureData=new Uint8Array(256),this._fallbackTextureTransparentData=new Uint8Array(256),this.events=new a,this._textureTechnique=n.acquireAndReleaseExisting(l.TextureTechnique,this._textureTechniqueConfig,this._textureTechnique);for(let e=0;e<this._fallbackTextureData.length;++e)this._fallbackTextureData[e]=255,this._fallbackTextureTransparentData[e]=(e+1)%4!=0?255:0;this._fallbackTextureDesc={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:8,height:8,maxAnisotropy:this.rctx.parameters.maxMaxAnisotropy},this._frameTask=r.isSome(e)?e.registerTask(i.Task.TEXTURE_UNLOAD,(()=>{}),(()=>!1)):i.ImmediateTask}var n=e.prototype;return n.dispose=function(){this._frameTask.remove(),r.isSome(this._fallbackTexture)&&(this._fallbackTexture.dispose(),this._fallbackTexture=null),r.isSome(this._fallbackTextureTransparent)&&(this._fallbackTextureTransparent.dispose(),this._fallbackTextureTransparent=null),this._textures.forEach((e=>e.unload()))},n.acquire=function(e,t=!1,r){const n=this._getOrCreateRef(e,t,r);return n.ref(),n},n.update=function(){let e=!1;this._frameUpdates.forEach((t=>{const r=t.texture.frameUpdate(this.rctx,this._textureTechnique,t.previousToken);r>=0&&r!==t.previousToken&&(t.previousToken=r,e=!0)})),e&&this.events.emit("changed",0)},n._getOrCreateRef=function(e,t,r){const n=this._idToRefCountedTexture.get(e);return n||this._createNewRef(e,t,r)},n._createNewRef=function(e,t,r){const n=this._textures.get(e);u.assert(void 0!==n);const a=n.events.on("unloaded",(()=>{a.remove(),this._onTextureUnloaded(e)})),i=new f;this._idToRefCountedTexture.set(e,i);const o=n.load(this.rctx,this._textureTechnique);this._loadingCount++;const l=t=>(this._loadingCount--,this._updateGLTexture(i,t),r&&r(i),n.requiresFrameUpdates&&this._frameUpdates.set(e,{texture:n,previousToken:-1}),i),h=e=>{this._loadingCount--,s.isAbortError(e)||c.error(e)};return s.isThenable(o)?(this._updateGLTexture(i,t?this.fallbackTextureTransparent:this.fallbackTexture),o.then(l,h)):l(o),i},n._updateGLTexture=function(e,t){e.glTexture=t,this.events.emit("changed",1)},n.release=function(e){const t=this._idToRefCountedTexture.get(e);if(t&&(t.unref(),t.isUnreferenced)){const r=this._textures.get(e);this._frameTask.schedule((()=>{t.isUnreferenced&&r.unload()}))}},n.getTexture=function(e){return this._textures.get(e)},n._onTextureUnloaded=function(e){this._idToRefCountedTexture.delete(e),this._frameUpdates.delete(e)},t._createClass(e,[{key:"loadingCount",get:function(){return this._loadingCount}},{key:"fallbackTexture",get:function(){return r.isNone(this._fallbackTexture)&&(this._fallbackTexture=new o(this.rctx,this._fallbackTextureDesc,this._fallbackTextureData)),this._fallbackTexture}},{key:"fallbackTextureTransparent",get:function(){return r.isNone(this._fallbackTextureTransparent)&&(this._fallbackTextureTransparent=new o(this.rctx,this._fallbackTextureDesc,this._fallbackTextureTransparentData)),this._fallbackTextureTransparent}}]),e}(),f=function(){function e(){this._refCount=0,this.glTexture=null}var r=e.prototype;return r.ref=function(){++this._refCount},r.unref=function(){0!==this._refCount?--this._refCount:c.error("Cannot dereference texture that has no references!")},t._createClass(e,[{key:"isUnreferenced",get:function(){return 0===this._refCount}}]),e}();e.RefCountedTexture=f,e.TextureRepository=h,Object.defineProperty(e,"__esModule",{value:!0})}));
