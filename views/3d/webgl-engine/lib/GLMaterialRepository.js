/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import e from"../../../../core/Logger.js";import{isNone as t,isSome as r,disposeMaybe as i}from"../../../../core/maybe.js";import{NestedMap as s}from"../../../../core/NestedMap.js";import{assert as o}from"./Util.js";const a=e.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository");class l{constructor(e,t,r,i){this._textureRepository=e,this._techniqueRepository=t,this.materialChanged=r,this.requestRender=i,this._id2glMaterialRef=new s}dispose(){this._textureRepository.dispose()}acquire(e,r){this._ownMaterial(e);let i=this._id2glMaterialRef.get(r,e.id);if(t(i)){const t=e.createGLMaterial({material:e,techniqueRep:this._techniqueRepository,textureRep:this._textureRepository,output:r});i=new n(t),this._id2glMaterialRef.set(r,e.id,i)}return i.ref(),i.glMaterial}release(e,t){const s=this._id2glMaterialRef.get(t,e.id);r(s)&&(s.unref(),s.referenced||(i(s.glMaterial),this._id2glMaterialRef.delete(t,e.id)))}_ownMaterial(e){r(e.repository)&&e.repository!==this&&a.error("Material is already owned by a different material repository"),e.repository=this}}class n{constructor(e){this.glMaterial=e,this.refCnt=0}ref(){++this.refCnt}unref(){--this.refCnt,o(this.refCnt>=0)}get referenced(){return this.refCnt>0}}export{l as GLMaterialRepository};
