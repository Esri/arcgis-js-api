// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","../../../../core/ObjectPool","../../../../core/PooledArray","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../support/geometryUtils","./Util"],(function(e,t,r,n,i,o,a,s){"use strict";var c=function(){function e(e,t){this._objectToBoundingSphere=e,this._maximumObjectsPerNode=10,this._maximumDepth=20,this._degenerateObjects=new Set,this._objectCount=0,t&&(void 0!==t.maximumObjectsPerNode&&(this._maximumObjectsPerNode=t.maximumObjectsPerNode),void 0!==t.maximumDepth&&(this._maximumDepth=t.maximumDepth)),this._root=new u(null,o.vec3f64.fromValues(0,0,0),0)}return Object.defineProperty(e.prototype,"center",{get:function(){return this._root.center},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"size",{get:function(){return 2*this._root.halfSize},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"root",{get:function(){return this._root.node},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"maximumObjectsPerNode",{get:function(){return this._maximumObjectsPerNode},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"maximumDepth",{get:function(){return this._maximumDepth},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"objectCount",{get:function(){return this._objectCount},enumerable:!1,configurable:!0}),e.prototype.destroy=function(){this._degenerateObjects.clear(),this._root=null,u.clearPool(),b[0]=null,E.prune(),V.prune(),D.prune()},e.prototype.add=function(e,t){var r=y(e);t=null==t?r.length:t,this._objectCount+=t,this._grow(r,t);for(var n=u.acquire(),i=0;i<t;i++){var o=r[i];this._isDegenerate(o)?this._degenerateObjects.add(o):(n.init(this._root),this._add(o,n))}u.release(n)},e.prototype.remove=function(e,t){var r=y(e);this._objectCount-=r.length;for(var n=u.acquire(),i=0,o=r;i<o.length;i++){var a=o[i],s=t||this._boundingSphereFromObject(a,N);this._isValidRadius(s.radius)?(n.init(this._root),this._remove(a,s,n)):this._degenerateObjects.delete(a)}u.release(n),this._shrink()},e.prototype.update=function(e,t){!this._isValidRadius(t.radius)&&this._isDegenerate(e)||(this.remove(e,t),this.add(e))},e.prototype.forEachAlongRay=function(e,t,r){var n=this,i=a.ray.wrap(e,t);this._forEachNode(this._root,(function(e){if(!n._intersectsNode(i,e))return!1;var t=e.node;return t.terminals.forEachSimple((function(e){n._intersectsObject(i,e)&&r(e)})),null!==t.residents&&t.residents.forEachSimple((function(e){n._intersectsObject(i,e)&&r(e)})),!0}))},e.prototype.forEachAlongRayWithVerticalOffset=function(e,t,r,n){var i=this,o=a.ray.wrap(e,t);this._forEachNode(this._root,(function(e){if(!i._intersectsNodeWithOffset(o,e,n))return!1;var t=e.node;return t.terminals.forEachSimple((function(e){i._intersectsObjectWithOffset(o,e,n)&&r(e)})),null!==t.residents&&t.residents.forEachSimple((function(e){i._intersectsObjectWithOffset(o,e,n)&&r(e)})),!0}))},e.prototype.forEach=function(e){this._forEachNode(this._root,(function(t){var r=t.node;return r.terminals.forEachSimple(e),null!==r.residents&&r.residents.forEachSimple(e),!0})),this._degenerateObjects.forEach(e)},e.prototype.forEachDegenerateObject=function(e){this._degenerateObjects.forEach(e)},e.prototype.findClosest=function(e,t,r,n,i){return this._findClosest(e,"front-to-back"===t?1:-1,r,n,i)},e.prototype.forEachInDepthRange=function(e,t,r,n,i,o,a,s){this._forEachInDepthRange(e,t,"front-to-back"===r?1:-1,n,i,o,a,s)},e.prototype.forEachNode=function(e){this._forEachNode(this._root,(function(t){return e(t.node,t.center,2*t.halfSize)}))},e.prototype._intersectsNode=function(e,t){return d(t.center,2*-t.halfSize,x),d(t.center,2*t.halfSize,O),s.rayBoxTest(e.origin,e.direction,x,O)},e.prototype._intersectsNodeWithOffset=function(e,t,r){return d(t.center,2*-t.halfSize,x),d(t.center,2*t.halfSize,O),r.applyToMinMax(x,O),s.rayBoxTest(e.origin,e.direction,x,O)},e.prototype._intersectsObject=function(e,t){var r=this._objectToBoundingSphere.getRadius(t);return!(r>0)||a.sphere.intersectsRay(a.sphere.wrap(r,this._objectToBoundingSphere.getCenter(t)),e)},e.prototype._intersectsObjectWithOffset=function(e,t,r){var n=this._objectToBoundingSphere.getRadius(t);return!(n>0)||a.sphere.intersectsRay(r.applyToBoundingSphere(n,this._objectToBoundingSphere.getCenter(t)),e)},e.prototype._forEachNode=function(e,t){for(var r=u.acquire().init(e),n=[r];0!==n.length;){if(t(r=n.pop())&&!r.isLeaf())for(var i=0;i<r.node.children.length;i++){r.node.children[i]&&n.push(u.acquire().init(r).advance(i))}u.release(r)}},e.prototype._forEachNodeDepthOrdered=function(e,t,r,n){void 0===n&&(n=1);var i=u.acquire().init(e),o=[i];for(!function(e,t,r){if(!V.length)for(var n=0;n<8;++n)V.push({index:0,distance:0});for(n=0;n<8;++n){var i=_[n];V.data[n].index=n,V.data[n].distance=m(e,t,i)}V.sort((function(e,t){return e.distance-t.distance})),r.clear();for(n=0;n<8;++n)r.push(V.data[n].index)}(r,n,D);0!==o.length;){if(t(i=o.pop())&&!i.isLeaf())for(var a=7;a>=0;--a){var s=D.data[a];if(!(s>=i.node.children.length))i.node.children[s]&&o.push(u.acquire().init(i).advance(s))}u.release(i)}},e.prototype._findClosest=function(e,t,r,n,o){var a=this,s=1/0,c=1/0,u=null,h=p(e,t),f=0,d=function(i){if(++f,!n||n(i)){var o=a._objectToBoundingSphere.getCenter(i),h=a._objectToBoundingSphere.getRadius(i);if(!r||!l(o,h,r)){var d=m(e,t,o),p=d-h;p<s&&(s=p,c=d+h,u=i)}}};return this._forEachNodeDepthOrdered(this._root,(function(n){if(null!=o&&f>=o)return!1;if(r&&l(n.center,n.halfSize*g,r))return!1;if(i.vec3.scale(j,h,n.halfSize),i.vec3.add(j,j,n.center),m(e,t,j)>c)return!1;var a=n.node;return a.terminals.forEachSimple((function(e){d(e)})),null!==a.residents&&a.residents.forEachSimple((function(e){d(e)})),!0}),e,t),u},e.prototype._forEachInDepthRange=function(e,t,r,n,o,a,s,c){var u=this,h=-1/0,f=1/0,d={setRange:function(e){1===r?(h=Math.max(h,e.near),f=Math.min(f,e.far)):(h=Math.max(h,-e.far),f=Math.min(f,-e.near))}};d.setRange(n);var _=m(t,r,e),v=p(t,r),b=p(t,-1*r),y=0,S=function(e){if(++y,!s||s(e)){var n=u._objectToBoundingSphere.getCenter(e),i=u._objectToBoundingSphere.getRadius(e),c=m(t,r,n)-_;c-i>f||c+i<h||a&&l(n,i,a)||o(e,d)}};this._forEachNodeDepthOrdered(this._root,(function(e){if(null!=c&&y>=c)return!1;if(a&&l(e.center,e.halfSize*g,a))return!1;if(i.vec3.scale(j,v,e.halfSize),i.vec3.add(j,j,e.center),m(t,r,j)-_>f)return!1;if(i.vec3.scale(j,b,e.halfSize),i.vec3.add(j,j,e.center),m(t,r,j)-_<h)return!1;var n=e.node;return n.terminals.forEachSimple((function(e){S(e)})),null!==n.residents&&n.residents.forEachSimple((function(e){S(e)})),!0}),t,r)},e.prototype._remove=function(e,t,r){E.clear();var n=r.advanceTo(t,(function(e,t){E.push(e.node),E.push(t)}))?r.node.terminals:r.node.residents;if(n.removeUnordered(e),0===n.length)for(var i=E.length-2;i>=0;i-=2){var o=E.data[i],a=E.data[i+1];if(!this._purge(o,a))break}},e.prototype._nodeIsEmpty=function(e){if(0!==e.terminals.length)return!1;if(null!==e.residents)return 0===e.residents.length;for(var t=0;t<e.children.length;t++)if(e.children[t])return!1;return!0},e.prototype._purge=function(e,t){return t>=0&&(e.children[t]=null),!!this._nodeIsEmpty(e)&&(null===e.residents&&(e.residents=new n({shrink:!0})),!0)},e.prototype._add=function(e,t){t.advanceTo(this._boundingSphereFromObject(e,N))?t.node.terminals.push(e):(t.node.residents.push(e),t.node.residents.length>this._maximumObjectsPerNode&&t.depth<this._maximumDepth&&this._split(t))},e.prototype._split=function(e){var t=e.node.residents;e.node.residents=null;for(var r=0;r<t.length;r++){var n=u.acquire().init(e);this._add(t.data[r],n),u.release(n)}},e.prototype._grow=function(e,t){var r=this;if(0!==t){var n=this._boundingSphereFromObjects(e,t,(function(e,t){return r._boundingSphereFromObject(e,t)}),M);if(this._isValidRadius(n.radius)&&!this._fitsInsideTree(n))if(this._nodeIsEmpty(this._root.node))i.vec3.copy(this._root.center,n.center),this._root.halfSize=1.25*n.radius;else{var o=u.acquire();this._rootBoundsForRootAsSubNode(n,o),this._placingRootViolatesMaxDepth(o)?this._rebuildTree(n,o):this._growRootAsSubNode(o),u.release(o)}}},e.prototype._rebuildTree=function(e,t){var r=this;i.vec3.copy(z.center,t.center),z.radius=t.halfSize;var n=this._boundingSphereFromObjects([e,z],2,(function(e){return e}),R),o=u.acquire().init(this._root);this._root.initFrom(null,n.center,1.25*n.radius),this._forEachNode(o,(function(e){return r.add(e.node.terminals.data,e.node.terminals.length),null!==e.node.residents&&r.add(e.node.residents.data,e.node.residents.length),!0})),u.release(o)},e.prototype._placingRootViolatesMaxDepth=function(e){var t=0;return this._forEachNode(this._root,(function(e){return t=Math.max(t,e.depth),!0})),t+Math.log(e.halfSize/this._root.halfSize)*Math.LOG2E>this._maximumDepth},e.prototype._rootBoundsForRootAsSubNode=function(e,t){for(var r=e.radius,n=e.center,i=-1/0,o=this._root.center,a=this._root.halfSize,s=0;s<3;s++){var c=o[s]-a-(n[s]-r),u=n[s]+r-(o[s]+a),h=Math.max(0,Math.ceil(c/(2*a))),f=Math.max(0,Math.ceil(u/(2*a)))+1,d=Math.pow(2,Math.ceil(Math.log(h+f)*Math.LOG2E));i=Math.max(i,d),T[s].min=h,T[s].max=f}for(s=0;s<3;s++){var l=(i-((h=T[s].min)+(f=T[s].max)))/2;h+=Math.ceil(l),f+=Math.floor(l);var p=o[s]-a-h*a*2;S[s]=p+(f+h)*a}return t.initFrom(null,S,i*a,0)},e.prototype._growRootAsSubNode=function(e){var t=this._root.node;i.vec3.copy(M.center,this._root.center),M.radius=this._root.halfSize,this._root.init(e),e.advanceTo(M,null,!0),e.node.children=t.children,e.node.residents=t.residents,e.node.terminals=t.terminals},e.prototype._shrink=function(){for(;;){var e=this._findShrinkIndex();if(-1===e)break;this._root.advance(e),this._root.depth=0}},e.prototype._findShrinkIndex=function(){if(0!==this._root.node.terminals.length||this._root.isLeaf())return-1;for(var e=null,t=this._root.node.children,r=0,n=0;n<t.length&&null==e;)e=t[r=n++];for(;n<t.length;)if(t[n++])return-1;return r},e.prototype._isDegenerate=function(e){var t=this._objectToBoundingSphere.getRadius(e);return!this._isValidRadius(t)},e.prototype._isValidRadius=function(e){return!isNaN(e)&&e!==-1/0&&e!==1/0&&e>0},e.prototype._fitsInsideTree=function(e){var t=this._root.center,r=this._root.halfSize,n=e.center;return e.radius<=r&&n[0]>=t[0]-r&&n[0]<=t[0]+r&&n[1]>=t[1]-r&&n[1]<=t[1]+r&&n[2]>=t[2]-r&&n[2]<=t[2]+r},e.prototype._boundingSphereFromObject=function(e,t){return i.vec3.copy(t.center,this._objectToBoundingSphere.getCenter(e)),t.radius=this._objectToBoundingSphere.getRadius(e),t},e.prototype._boundingSphereFromObjects=function(e,t,r,n){if(1===t){var o=r(e[0],M);i.vec3.copy(n.center,o.center),n.radius=o.radius}else{x[0]=1/0,x[1]=1/0,x[2]=1/0,O[0]=-1/0,O[1]=-1/0,O[2]=-1/0;for(var a=0;a<t;a++){o=r(e[a],M);this._isValidRadius(o.radius)&&(h(x,o.center,o.radius),f(O,o.center,o.radius))}i.vec3.lerp(n.center,x,O,.5),n.radius=Math.max(O[0]-x[0],O[1]-x[1],O[2]-x[2])/2}return n},e}(),u=function(){function e(e,t,r){void 0===r&&(r=0),this.center=o.vec3f64.create(),this.initFrom(e,t,r,0)}return e.prototype.init=function(e){return this.initFrom(e.node,e.center,e.halfSize,e.depth)},e.prototype.initFrom=function(t,r,n,o){return void 0===t&&(t=null),void 0===n&&(n=this.halfSize),void 0===o&&(o=this.depth),this.node=t||e.createEmptyNode(),r&&i.vec3.copy(this.center,r),this.halfSize=n,this.depth=o,this},e.prototype.advance=function(t){var r=this.node.children[t];r||(r=e.createEmptyNode(),this.node.children[t]=r),this.node=r,this.halfSize/=2,this.depth++;var n=_[t];return this.center[0]+=n[0]*this.halfSize,this.center[1]+=n[1]*this.halfSize,this.center[2]+=n[2]*this.halfSize,this},e.prototype.advanceTo=function(e,t,r){for(void 0===r&&(r=!1);;){if(this.isTerminalFor(e))return t&&t(this,-1),!0;if(this.isLeaf()&&!r)return t&&t(this,-1),!1;this.isLeaf()&&(this.node.residents=null);var n=this._childIndex(e);t&&t(this,n),this.advance(n)}},e.prototype.isLeaf=function(){return null!=this.node.residents},e.prototype.isTerminalFor=function(e){return e.radius>this.halfSize/2},e.prototype._childIndex=function(e){for(var t=e.center,r=this.center,n=0,i=0;i<3;i++)r[i]<t[i]&&(n|=1<<i);return n},e.createEmptyNode=function(){return{children:[null,null,null,null,null,null,null,null],terminals:new n({shrink:!0}),residents:new n({shrink:!0})}},e.acquire=function(){return e._pool.acquire()},e.release=function(t){e._pool.release(t)},e.clearPool=function(){e._pool.prune()},e._pool=new r(e),e}();function h(e,t,r){e[0]=Math.min(e[0],t[0]-r),e[1]=Math.min(e[1],t[1]-r),e[2]=Math.min(e[2],t[2]-r)}function f(e,t,r){e[0]=Math.max(e[0],t[0]+r),e[1]=Math.max(e[1],t[1]+r),e[2]=Math.max(e[2],t[2]+r)}function d(e,t,r){return(r=r||e)[0]=e[0]+t,r[1]=e[1]+t,r[2]=e[2]+t,r}function l(e,t,r){return!a.frustum.intersectsSphere(r.planes,a.sphere.wrap(t,e))}function p(e,t){for(var r=1/0,n=null,i=0;i<8;++i){var o=m(e,t,v[i]);o<r&&(r=o,n=v[i])}return n}function m(e,t,r){return t*(e[0]*r[0]+e[1]*r[1]+e[2]*r[2])}var _=[o.vec3f64.fromValues(-1,-1,-1),o.vec3f64.fromValues(1,-1,-1),o.vec3f64.fromValues(-1,1,-1),o.vec3f64.fromValues(1,1,-1),o.vec3f64.fromValues(-1,-1,1),o.vec3f64.fromValues(1,-1,1),o.vec3f64.fromValues(-1,1,1),o.vec3f64.fromValues(1,1,1)],v=[o.vec3f64.fromValues(-1,-1,-1),o.vec3f64.fromValues(-1,-1,1),o.vec3f64.fromValues(-1,1,-1),o.vec3f64.fromValues(-1,1,1),o.vec3f64.fromValues(1,-1,-1),o.vec3f64.fromValues(1,-1,1),o.vec3f64.fromValues(1,1,-1),o.vec3f64.fromValues(1,1,1)],g=Math.sqrt(3),b=[null];function y(e){return Array.isArray(e)?e:(b[0]=e,b)}var S=o.vec3f64.create(),j=o.vec3f64.create(),x=o.vec3f64.create(),O=o.vec3f64.create(),E=new n,N={center:o.vec3f64.create(),radius:0},M={center:o.vec3f64.create(),radius:0},z={center:o.vec3f64.create(),radius:0},R={center:o.vec3f64.create(),radius:0},T=[{min:0,max:0},{min:0,max:0},{min:0,max:0}],V=new n,D=new n;return c}));