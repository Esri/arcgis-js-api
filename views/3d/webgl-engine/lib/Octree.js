/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/ObjectPool","../../../../core/PooledArray","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/support/frustum","../../../../geometry/support/ray","../../../../chunks/sphere","./Util"],(function(e,t,n,o,i,r,s,h,a,u,c){"use strict";let l=function(){function o(e,t){this._objectToBoundingSphere=e,this._maximumObjectsPerNode=10,this._maximumDepth=20,this._degenerateObjects=new Set,this._root=new d,this._objectCount=0,t&&(void 0!==t.maximumObjectsPerNode&&(this._maximumObjectsPerNode=t.maximumObjectsPerNode),void 0!==t.maximumDepth&&(this._maximumDepth=t.maximumDepth))}var s=o.prototype;return s.destroy=function(){this._degenerateObjects.clear(),d.clearPool(),y[0]=null,D.prune(),F.prune()},s.add=function(e,t=e.length){this._objectCount+=t,this._grow(e,t);const n=d.acquire();for(let o=0;o<t;o++){const t=e[o];this._isDegenerate(t)?this._degenerateObjects.add(t):(n.init(this._root),this._add(t,n))}d.release(n)},s.remove=function(e,t=null){this._objectCount-=e.length;const o=d.acquire();for(const i of e){const e=n.isSome(t)?t:u.copy(this._objectToBoundingSphere(i),B);x(e[3])?(o.init(this._root),this._remove(i,e,o)):this._degenerateObjects.delete(i)}d.release(o),this._shrink()},s.update=function(e,t){if(!x(t[3])&&this._isDegenerate(e))return;const n=M(e);this.remove(n,t),this.add(n)},s.forEachAlongRay=function(e,t,n){const o=a.wrap(e,t);this._forEachNode(this._root,(e=>{if(!this._intersectsNode(o,e))return!1;const t=e.node;return t.terminals.forAll((e=>{this._intersectsObject(o,e)&&n(e)})),null!==t.residents&&t.residents.forAll((e=>{this._intersectsObject(o,e)&&n(e)})),!0}))},s.forEachAlongRayWithVerticalOffset=function(e,t,n,o){const i=a.wrap(e,t);this._forEachNode(this._root,(e=>{if(!this._intersectsNodeWithOffset(i,e,o))return!1;const t=e.node;return t.terminals.forAll((e=>{this._intersectsObjectWithOffset(i,e,o)&&n(e)})),null!==t.residents&&t.residents.forAll((e=>{this._intersectsObjectWithOffset(i,e,o)&&n(e)})),!0}))},s.forEach=function(e){this._forEachNode(this._root,(t=>{const n=t.node;return n.terminals.forAll(e),null!==n.residents&&n.residents.forAll(e),!0})),this._degenerateObjects.forEach(e)},s.forEachDegenerateObject=function(e){this._degenerateObjects.forEach(e)},s.findClosest=function(e,t,n,o=(()=>!0),i=1/0){let s=1/0,a=1/0,c=null;const l=S(e,t),d=r=>{if(--i,!o(r))return;const l=this._objectToBoundingSphere(r);if(!h.intersectsSphere(n,l))return;const d=O(e,t,u.getCenter(l)),f=d-l[3],_=d+l[3];f<s&&(s=f,a=_,c=r)};return this._forEachNodeDepthOrdered(this._root,(o=>{if(i<=0||!h.intersectsSphere(n,o.bounds))return!1;r.scale(E,l,o.halfSize),r.add(E,E,o.bounds);if(O(e,t,E)>a)return!1;const s=o.node;return s.terminals.forAll((e=>d(e))),null!==s.residents&&s.residents.forAll((e=>d(e))),!0}),e,t),c},s.forEachInDepthRange=function(t,n,o,i,s,a,c){let l=-1/0,d=1/0;const f={setRange:t=>{o===e.DepthOrder.FRONT_TO_BACK?(l=Math.max(l,t.near),d=Math.min(d,t.far)):(l=Math.max(l,-t.far),d=Math.min(d,-t.near))}};f.setRange(i);const _=O(n,o,t),m=S(n,o),p=S(n,-o),b=e=>{if(!c(e))return;const t=this._objectToBoundingSphere(e),i=u.getCenter(t),r=O(n,o,i)-_,m=r-t[3],p=r+t[3];m>d||p<l||!h.intersectsSphere(a,t)||s(e,f)};this._forEachNodeDepthOrdered(this._root,(e=>{if(!h.intersectsSphere(a,e.bounds))return!1;r.scale(E,m,e.halfSize),r.add(E,E,e.bounds);if(O(n,o,E)-_>d)return!1;r.scale(E,p,e.halfSize),r.add(E,E,e.bounds);if(O(n,o,E)-_<l)return!1;const t=e.node;return t.terminals.forAll((e=>b(e))),null!==t.residents&&t.residents.forAll((e=>b(e))),!0}),n,o)},s.forEachNode=function(e){this._forEachNode(this._root,(t=>e(t.node,t.bounds,t.halfSize)))},s._intersectsNode=function(e,t){return p(t.bounds,2*-t.halfSize,v),p(t.bounds,2*t.halfSize,A),c.rayBoxTest(e.origin,e.direction,v,A)},s._intersectsNodeWithOffset=function(e,t,n){return p(t.bounds,2*-t.halfSize,v),p(t.bounds,2*t.halfSize,A),n.applyToMinMax(v,A),c.rayBoxTest(e.origin,e.direction,v,A)},s._intersectsObject=function(e,t){const n=this._objectToBoundingSphere(t);return!(n[3]>0)||u.intersectsRay(n,e)},s._intersectsObjectWithOffset=function(e,t,n){const o=this._objectToBoundingSphere(t);return!(o[3]>0)||u.intersectsRay(n.applyToBoundingSphere(o),e)},s._forEachNode=function(e,t){let n=d.acquire().init(e);const o=[n];for(;0!==o.length;){if(n=o.pop(),t(n)&&!n.isLeaf())for(let e=0;e<n.node.children.length;e++){n.node.children[e]&&o.push(d.acquire().init(n).advance(e))}d.release(n)}},s._forEachNodeDepthOrdered=function(t,n,o,i=e.DepthOrder.FRONT_TO_BACK){let r=d.acquire().init(t);const s=[r];for(g(o,i,w);0!==s.length;){if(r=s.pop(),n(r)&&!r.isLeaf())for(let e=7;e>=0;--e){const t=w[e];r.node.children[t]&&s.push(d.acquire().init(r).advance(t))}d.release(r)}},s._remove=function(e,t,n){D.clear();const o=n.advanceTo(t,((e,t)=>{D.push(e.node),D.push(t)}))?n.node.terminals:n.node.residents;if(o.removeUnordered(e),0===o.length)for(let i=D.length-2;i>=0;i-=2){const e=D.data[i],t=D.data[i+1];if(!this._purge(e,t))break}},s._nodeIsEmpty=function(e){if(0!==e.terminals.length)return!1;if(null!==e.residents)return 0===e.residents.length;for(let t=0;t<e.children.length;t++)if(e.children[t])return!1;return!0},s._purge=function(e,t){return t>=0&&(e.children[t]=null),!!this._nodeIsEmpty(e)&&(null===e.residents&&(e.residents=new i({shrink:!0})),!0)},s._add=function(e,t){t.advanceTo(this._objectToBoundingSphere(e))?t.node.terminals.push(e):(t.node.residents.push(e),t.node.residents.length>this._maximumObjectsPerNode&&t.depth<this._maximumDepth&&this._split(t))},s._split=function(e){const t=e.node.residents;e.node.residents=null;for(let n=0;n<t.length;n++){const o=d.acquire().init(e);this._add(t.getItemAt(n),o),d.release(o)}},s._grow=function(e,t){if(0!==t&&(b(e,t,(e=>this._objectToBoundingSphere(e)),k),x(k[3])&&!this._fitsInsideTree(k)))if(this._nodeIsEmpty(this._root.node))u.copy(k,this._root.bounds),this._root.halfSize=1.25*k[3];else{const e=this._rootBoundsForRootAsSubNode(k);this._placingRootViolatesMaxDepth(e)?this._rebuildTree(k,e):this._growRootAsSubNode(e),d.release(e)}},s._rebuildTree=function(e,t){r.copy(R,t.bounds),R[3]=t.halfSize,b([e,R],2,(e=>e),V);const n=d.acquire().init(this._root);this._root.initFrom(null,V,1.25*V[3]),this._forEachNode(n,(e=>(this.add(e.node.terminals.data,e.node.terminals.length),null!==e.node.residents&&this.add(e.node.residents.data,e.node.residents.length),!0))),d.release(n)},s._placingRootViolatesMaxDepth=function(e){const t=Math.log(e.halfSize/this._root.halfSize)*Math.LOG2E;let n=0;return this._forEachNode(this._root,(e=>(n=Math.max(n,e.depth),n+t<=this._maximumDepth))),n+t>this._maximumDepth},s._rootBoundsForRootAsSubNode=function(e){const t=e[3],n=e;let o=-1/0;const i=this._root.bounds,r=this._root.halfSize;for(let s=0;s<3;s++){const e=i[s]-r-(n[s]-t),h=n[s]+t-(i[s]+r),a=Math.max(0,Math.ceil(e/(2*r))),u=Math.max(0,Math.ceil(h/(2*r)))+1,c=2**Math.ceil(Math.log(a+u)*Math.LOG2E);o=Math.max(o,c),C[s].min=a,C[s].max=u}for(let s=0;s<3;s++){let e=C[s].min,t=C[s].max;const n=(o-(e+t))/2;e+=Math.ceil(n),t+=Math.floor(n);const h=i[s]-r-e*r*2;z[s]=h+(t+e)*r}return z[3]=o*r*T,d.acquire().initFrom(null,z,o*r,0)},s._growRootAsSubNode=function(e){const t=this._root.node;r.copy(k,this._root.bounds),k[3]=this._root.halfSize,this._root.init(e),e.advanceTo(k,null,!0),e.node.children=t.children,e.node.residents=t.residents,e.node.terminals=t.terminals},s._shrink=function(){for(;;){const e=this._findShrinkIndex();if(-1===e)break;this._root.advance(e),this._root.depth=0}},s._findShrinkIndex=function(){if(0!==this._root.node.terminals.length||this._root.isLeaf())return-1;let e=null;const t=this._root.node.children;let n=0,o=0;for(;o<t.length&&null==e;)n=o++,e=t[n];for(;o<t.length;)if(t[o++])return-1;return n},s._isDegenerate=function(e){return!x(this._objectToBoundingSphere(e)[3])},s._fitsInsideTree=function(e){const t=this._root.bounds,n=this._root.halfSize;return e[3]<=n&&e[0]>=t[0]-n&&e[0]<=t[0]+n&&e[1]>=t[1]-n&&e[1]<=t[1]+n&&e[2]>=t[2]-n&&e[2]<=t[2]+n},t._createClass(o,[{key:"bounds",get:function(){return this._root.bounds}},{key:"halfSize",get:function(){return this._root.halfSize}},{key:"root",get:function(){return this._root.node}},{key:"maximumObjectsPerNode",get:function(){return this._maximumObjectsPerNode}},{key:"maximumDepth",get:function(){return this._maximumDepth}},{key:"objectCount",get:function(){return this._objectCount}}]),o}(),d=function(){function e(){this.bounds=u.create(),this.halfSize=0,this.initFrom(null,null,0,0)}var t=e.prototype;return t.init=function(e){return this.initFrom(e.node,e.bounds,e.halfSize,e.depth)},t.initFrom=function(t,o,i,r=this.depth){return this.node=n.isSome(t)?t:e.createEmptyNode(),n.isSome(o)&&u.copy(o,this.bounds),this.halfSize=i,this.depth=r,this},t.advance=function(t){let n=this.node.children[t];n||(n=e.createEmptyNode(),this.node.children[t]=n),this.node=n,this.halfSize/=2,this.depth++;const o=N[t];return this.bounds[0]+=o[0]*this.halfSize,this.bounds[1]+=o[1]*this.halfSize,this.bounds[2]+=o[2]*this.halfSize,this.bounds[3]=this.halfSize*T,this},t.advanceTo=function(e,t,n=!1){for(;;){if(this.isTerminalFor(e))return t&&t(this,-1),!0;if(this.isLeaf()){if(!n)return t&&t(this,-1),!1;this.node.residents=null}const o=this._childIndex(e);t&&t(this,o),this.advance(o)}},t.isLeaf=function(){return null!=this.node.residents},t.isTerminalFor=function(e){return e[3]>this.halfSize/2},t._childIndex=function(e){const t=this.bounds;return(t[0]<e[0]?1:0)+(t[1]<e[1]?2:0)+(t[2]<e[2]?4:0)},e.createEmptyNode=function(){return{children:[null,null,null,null,null,null,null,null],terminals:new i({shrink:!0}),residents:new i({shrink:!0})}},e.acquire=function(){return e._pool.acquire()},e.release=function(t){e._pool.release(t)},e.clearPool=function(){e._pool.prune()},e}();var f;function _(e,t){e[0]=Math.min(e[0],t[0]-t[3]),e[1]=Math.min(e[1],t[1]-t[3]),e[2]=Math.min(e[2],t[2]-t[3])}function m(e,t){e[0]=Math.max(e[0],t[0]+t[3]),e[1]=Math.max(e[1],t[1]+t[3]),e[2]=Math.max(e[2],t[2]+t[3])}function p(e,t,n){n[0]=e[0]+t,n[1]=e[1]+t,n[2]=e[2]+t}function b(e,t,n,o){if(1===t){const t=n(e[0]);u.copy(t,o)}else{v[0]=1/0,v[1]=1/0,v[2]=1/0,A[0]=-1/0,A[1]=-1/0,A[2]=-1/0;for(let o=0;o<t;o++){const t=n(e[o]);x(t[3])&&(_(v,t),m(A,t))}r.lerp(o,v,A,.5),o[3]=Math.max(A[0]-v[0],A[1]-v[1],A[2]-v[2])/2}}function g(e,t,n){if(!F.length)for(let o=0;o<8;++o)F.push({index:0,distance:0});for(let o=0;o<8;++o){const n=N[o];F.data[o].index=o,F.data[o].distance=O(e,t,n)}F.sort(((e,t)=>e.distance-t.distance));for(let o=0;o<8;++o)n[o]=F.data[o].index}function S(e,t){let n=1/0,o=null;for(let i=0;i<8;++i){const r=O(e,t,j[i]);r<n&&(n=r,o=j[i])}return o}function O(e,t,n){return t*(e[0]*n[0]+e[1]*n[1]+e[2]*n[2])}function x(e){return!isNaN(e)&&e!==-1/0&&e!==1/0&&e>0}d._pool=new o(d),e.DepthOrder=void 0,(f=e.DepthOrder||(e.DepthOrder={}))[f.FRONT_TO_BACK=1]="FRONT_TO_BACK",f[f.BACK_TO_FRONT=-1]="BACK_TO_FRONT";const N=[s.fromValues(-1,-1,-1),s.fromValues(1,-1,-1),s.fromValues(-1,1,-1),s.fromValues(1,1,-1),s.fromValues(-1,-1,1),s.fromValues(1,-1,1),s.fromValues(-1,1,1),s.fromValues(1,1,1)],j=[s.fromValues(-1,-1,-1),s.fromValues(-1,-1,1),s.fromValues(-1,1,-1),s.fromValues(-1,1,1),s.fromValues(1,-1,-1),s.fromValues(1,-1,1),s.fromValues(1,1,-1),s.fromValues(1,1,1)],T=Math.sqrt(3),y=[null];function M(e){return y[0]=e,y}const z=u.create(),E=s.create(),v=s.create(),A=s.create(),D=new i,B=u.create(),k=u.create(),R=u.create(),V=u.create(),C=[{min:0,max:0},{min:0,max:0},{min:0,max:0}],F=new i,w=[0,0,0,0,0,0,0,0];e.default=l,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
