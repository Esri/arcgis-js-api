// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","../../../../core/libs/gl-matrix-2/vec4","../../../../core/libs/gl-matrix-2/vec4f32","../../../../core/libs/gl-matrix-2/vec4f64","../../support/debugFlags","./DefaultVertexAttributeLocations","./DefaultVertexBufferLayouts","./glUtil3D","./Util","../shaders/HighlightTechnique","../../../webgl/BufferObject","../../../webgl/FramebufferObject","../../../webgl/Util","../../../webgl/VertexArrayObject"],(function(e,i,t,r,o,a,l,h,p,n,s,u,g,c,d){return function(){function e(e,i){this._grid={coverageMipmap:null,vao:null,verticalCellCount:0,horizontalCellCount:0,cellPixelSize:0,mipmapLevels:0,viewportWidth:0,viewportHeight:0},this.quadVAO=null,this.blur0Fbo=null,this.blur1Fbo=null,this._rctx=i,this.viewportToRestore=o.vec4f64.create(),this.defaultOptions={color:r.vec4f32.fromValues(1,0,1,1),haloColor:r.vec4f32.fromValues(1,0,1,1),haloOpacity:1,fillOpacity:.2,haloOpacityOccluded:.25,fillOpacityOccluded:.05};var t=new s.HighlightCompositionTechniqueConfiguration,a=function(i,t){return e.acquireAndReleaseExisting(s.HighlightCompositionTechnique,i,t)};t.highlightStage=0,t.gridOptimization=!1,this.blurTechnique=a(t,this.blurTechnique),t.highlightStage=0,t.gridOptimization=!0,this.blurGridTechnique=a(t,this.blurGridTechnique),t.highlightStage=1,t.gridOptimization=!1,this.applyTechnique=a(t,this.applyTechnique),t.highlightStage=1,t.gridOptimization=!0,this.applyGridTechnique=a(t,this.applyGridTechnique),t.highlightStage=2,t.gridOptimization=!1,this.downsampleTechnique=a(t,this.downsampleTechnique)}return Object.defineProperty(e.prototype,"enabled",{get:function(){return null!==this.blur0Fbo},set:function(e){e?this.enable():this.disable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"profilingCallback",{get:function(){return a.HIGHLIGHTS_PROFILE_TO_CONSOLE?function(e){return console.log(e)}:null},enumerable:!0,configurable:!0}),e.prototype.setDefaultOptions=function(e){this.defaultOptions=e},e.prototype.render=function(e,i,r){var o=e.pixelRatio,l=!a.HIGHLIGHTS_GRID_OPTIMIZATION_DISABLED,h=this._rctx;n.assert(this.enabled),t.vec4.copy(this.viewportToRestore,e.fullViewport);var p=e.fullWidth,s=e.fullHeight,u=Math.ceil(p/o),g=Math.ceil(s/o);this.blur0Fbo.resize(u,g),this.blur1Fbo.resize(u,g),h.bindVAO(this.quadVAO);var d=null,b=null;l&&(this._gridUpdateResources(i,32),this._gridComputeMipmap()),l?(d=this._grid.vao,b=this.blurGridTechnique,h.bindTexture(this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture,1),b.program.setUniform1i("coverageTex",1)):(d=this.quadVAO,b=this.blurTechnique),b.bindPipelineState(h),h.bindProgram(b.program),h.bindVAO(d),h.bindFramebuffer(this.blur0Fbo),h.setViewport(0,0,u,g),h.setClearColor(0,0,0,0),h.clear(16384),b.program.setUniform1i("tex",0),h.bindTexture(i.colorTexture,0),b.program.setUniform2f("blurSize",1/u,0),h.drawArrays(b.primitiveType,0,c.vertexCount(d,"geometry")),h.bindFramebuffer(this.blur1Fbo),h.clear(16384),h.bindTexture(this.blur0Fbo.colorTexture,0),b.program.setUniform2f("blurSize",0,1/g),h.drawArrays(b.primitiveType,0,c.vertexCount(d,"geometry"));var m=l?this.applyGridTechnique:this.applyTechnique;if(h.bindFramebuffer(r),m.bindPipelineState(h),h.setViewport(this.viewportToRestore[0],this.viewportToRestore[1],this.viewportToRestore[2],this.viewportToRestore[3]),h.bindProgram(m.program),h.bindTexture(this.blur1Fbo.colorTexture,0),h.bindTexture(i.colorTexture,1),l){var v=this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture;h.bindTexture(v,2)}m.bindApplyPass(this.defaultOptions),h.drawArrays(m.primitiveType,0,c.vertexCount(d,"geometry")),h.bindVAO(null)},e.prototype.enable=function(){if(!this.enabled){this.quadVAO=p.createQuadVAO(this._rctx);var e={colorTarget:0,depthStencilTarget:0,width:0,height:0},i={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0};this.blur0Fbo=new g(this._rctx,e,i),this.blur1Fbo=new g(this._rctx,e,i)}},e.prototype.disable=function(){this.enabled&&(this.quadVAO.dispose(!0),this.blur1Fbo.dispose(),this.blur0Fbo.dispose(),this.quadVAO=null,this.blur0Fbo=null,this.blur1Fbo=null)},e.prototype._gridUpdateResources=function(e,i){var t=this._rctx,r=this._grid,o=!1;if(null===r.coverageMipmap&&(r.coverageMipmap=[e],o=!0),r.viewportWidth===e.width&&r.viewportHeight===e.height||(o=!0,r.viewportWidth=e.width,r.viewportHeight=e.height),r.coverageMipmap[0]=e,r.cellPixelSize!==i&&(r.cellPixelSize=i,o=!0),o){for(var a=1;a<r.coverageMipmap.length;a++)r.coverageMipmap[a].dispose();r.mipmapLevels=Math.ceil(Math.log(r.cellPixelSize)*Math.LOG2E),r.coverageMipmap.length=r.mipmapLevels+1;for(a=0;a<r.mipmapLevels;a++){var p=r.coverageMipmap[a],n={target:3553,pixelFormat:6407,dataType:33635,samplingMode:9729,wrapMode:33071,width:Math.ceil(p.width/2),height:Math.ceil(p.height/2)},s={colorTarget:0,depthStencilTarget:0,width:Math.ceil(p.width/2),height:Math.ceil(p.height/2)},c=new g(t,s,n);r.coverageMipmap[a+1]=c}}var b=Math.ceil(e.height/r.cellPixelSize),m=Math.ceil(e.width/r.cellPixelSize);if(!r.vao||r.verticalCellCount!==b||r.horizontalCellCount!==m){r.verticalCellCount=b,r.horizontalCellCount=m;for(var v=b+1,f=m+1,T=1/b,x=1/m,y=new Float32Array(24*v*f),w=0,O=0;O<v;O++)for(var M=0;M<f;M++)y[w+0]=(M-.5)*x*2-1,y[w+1]=(O-.5)*T*2-1,y[w+2]=M*x,y[w+3]=O*T,y[w+4]=(M+.5)*x*2-1,y[w+5]=(O-.5)*T*2-1,y[w+6]=M*x,y[w+7]=O*T,y[w+8]=(M-.5)*x*2-1,y[w+9]=(O+.5)*T*2-1,y[w+10]=M*x,y[w+11]=O*T,y[w+12]=(M-.5)*x*2-1,y[w+13]=(O+.5)*T*2-1,y[w+14]=M*x,y[w+15]=O*T,y[w+16]=(M+.5)*x*2-1,y[w+17]=(O-.5)*T*2-1,y[w+18]=M*x,y[w+19]=O*T,y[w+20]=(M+.5)*x*2-1,y[w+21]=(O+.5)*T*2-1,y[w+22]=M*x,y[w+23]=O*T,w+=24;r.vao&&r.vao.dispose(!0),r.vao=new d(t,l.Default3D,{geometry:h.Pos2Tex},{geometry:u.createVertex(t,35044,y)})}},e.prototype._gridComputeMipmap=function(){var e=this._rctx,i=this._grid,t=this.downsampleTechnique.program;this.downsampleTechnique.bindPipelineState(e),e.bindVAO(this.quadVAO);for(var r=0;r<i.mipmapLevels;r++){e.bindFramebuffer(i.coverageMipmap[r+1]),e.bindTexture(i.coverageMipmap[r].colorTexture,0);var o=i.coverageMipmap[r+1].width,a=i.coverageMipmap[r+1].height;e.bindProgram(t),t.setUniform1i("tex",0),t.setUniform2f("invFramebufferDim",1/o,1/a),e.setViewport(0,0,o,a),e.drawArrays(5,0,c.vertexCount(this.quadVAO,"geometry"))}},e.prototype.getGpuMemoryUsage=function(){var e=c.getGpuMemoryUsage(this.blur0Fbo)+c.getGpuMemoryUsage(this.blur1Fbo);if(this._grid&&this._grid.coverageMipmap)for(var i=0,t=this._grid.coverageMipmap;i<t.length;i++){var r=t[i];e+=c.getGpuMemoryUsage(r)}return e},Object.defineProperty(e.prototype,"test",{get:function(){return{coverage:this._grid.coverageMipmap,blur:[this.blur0Fbo,this.blur1Fbo]}},enumerable:!0,configurable:!0}),e}()}));