// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","./RenderTargetHelper"],(function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OffscreenRendering=void 0;var o=function(){function e(e,t){this._rctx=e,this._compositingHelper=t,this._currentRenderTarget=0,this.dimensions={width:4,height:4},this._needLastFrameColorTexture=!1,this._background={type:"color",color:[0,0,0,1]};var o=this._rctx;this.renderTargetHelper=new r.RenderTargetHelper(o);var i=this.renderTargetHelper;this.mainColorTarget0=i.registerColorTarget({name:"mainColorTarget0"}),this.mainColorTarget1=i.registerColorTarget({name:"mainColorTarget1"});var n=function(e){return i.registerColorTarget({name:e,dataType:5126,samplingMode:9728})};this.colorFloatTarget=n("colorFloatTarget"),this.alphaFloatTarget=n("alphaFloatTarget"),this.mainDepth=i.registerDepthTarget({name:"mainDepth"}),this.linearDepth=i.registerColorTarget({name:"linearDepth",samplingMode:9728}),this.normal=i.registerColorTarget({name:"normal"}),this.highlight=i.registerColorTarget({name:"highlight",dataType:32819}),this.hudVisibility=i.registerColorTarget({name:"hudVisibility",dataType:32819}),this.tmpColor=i.registerColorTarget({name:"tmpColor"}),this.tmpDepth=i.registerDepthTarget({name:"tmpDepth"})}return e.prototype.dispose=function(){this.renderTargetHelper.dispose()},Object.defineProperty(e.prototype,"width",{get:function(){return this.dimensions.width},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this.dimensions.height},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"background",{get:function(){return this._background},set:function(e){this._background=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"currentColorTarget",{get:function(){return 0===this._currentRenderTarget?this.mainColorTarget0:this.mainColorTarget1},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"previousColorTarget",{get:function(){return 0===this._currentRenderTarget?this.mainColorTarget1:this.mainColorTarget0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"currentRenderTarget",{get:function(){return this._currentRenderTarget},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"framebuffer",{get:function(){return this.renderTargetHelper.getFramebuffer(this.dimensions,this.currentColorTarget,this.mainDepth)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"colorTexture",{get:function(){return this.renderTargetHelper.getAllocatedColorTexture(this.currentColorTarget)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"depthTexture",{get:function(){return this.renderTargetHelper.getAllocatedDepthTexture(this.mainDepth)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"linearDepthTexture",{get:function(){return this.renderTargetHelper.getAllocatedColorTexture(this.linearDepth)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"lastFrameColorTexture",{get:function(){return this.renderTargetHelper.getAllocatedColorTexture(this.previousColorTarget)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"normalTexture",{get:function(){return this.renderTargetHelper.getAllocatedColorTexture(this.normal)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"highlightTexture",{get:function(){return this.renderTargetHelper.getAllocatedColorTexture(this.highlight)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"hudVisibilityTexture",{get:function(){return this.getColorTexture(this.hudVisibility)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"tmpColorTexture",{get:function(){return this.getColorTexture(this.tmpColor)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"mainColorTexture",{get:function(){return this.getColorTexture(this.currentColorTarget)},enumerable:!1,configurable:!0}),e.prototype.advanceCurrentRenderTarget=function(){this._currentRenderTarget=0===this._currentRenderTarget&&this._needLastFrameColorTexture?1:0},e.prototype.initializeFrame=function(e){var t=this._rctx;this.dimensions.width=e.fullWidth,this.dimensions.height=e.fullHeight,this.bindTarget(this.currentColorTarget,this.mainDepth),t.setClearStencil(0);var r=this._background.color;t.setClearColor(r[0]*r[3],r[1]*r[3],r[2]*r[3],r[3]),t.clearSafe(17664)},e.prototype.composite=function(){this._compositingHelper.composite(this.colorTexture,0)},e.prototype.renderAndComposite=function(e,t){this.renderToTargets(e,this.tmpColor,this.mainDepth,i),this._compositingHelper.composite(this.getColorTexture(this.tmpColor),t)},e.prototype.renderHUDVisibility=function(e){this.renderToTargets(e,this.hudVisibility,this.mainDepth,n)},e.prototype.compositeTransparentTerrainOntoHUDVisibility=function(){var e=this;this.renderToTargets((function(){e._compositingHelper.compositeSpecial(e.getColorTexture(e.tmpColor),2)}),this.hudVisibility,this.mainDepth)},e.prototype.renderOITPass=function(e,t){var r,o;switch(t){case 0:r=this.colorFloatTarget,o=[0,0,0,0];break;case 1:r=this.alphaFloatTarget,o=[1,1,1,1];break;case 2:r=this.tmpColor,o=[0,0,0,0]}this.renderToTargets(e,r,this.mainDepth,o,!1)},e.prototype.compositeTransparentTerrainOntoMain=function(){this.bindFramebuffer(),this._compositingHelper.composite(this.getColorTexture(this.tmpColor),2)},e.prototype.compositeOccludedOntoMain=function(e){this.bindFramebuffer(),this._compositingHelper.composite(this.getColorTexture(this.tmpColor),2,e)},e.prototype.compositeTransparentOntoOpaque=function(){this.bindFramebuffer(),this._compositingHelper.compositeTransparent(this.getColorTexture(this.colorFloatTarget),this.getColorTexture(this.alphaFloatTarget),this.getColorTexture(this.tmpColor))},e.prototype.bindFramebuffer=function(){this._rctx.bindFramebuffer(this.framebuffer)},e.prototype.renderDepthDetached=function(e){this.bindTarget(this.currentColorTarget),e(),this.bindTarget(this.currentColorTarget,this.mainDepth)},e.prototype.disposeTarget=function(e){this.renderTargetHelper.disposeTargetResource(e)},Object.defineProperty(e.prototype,"needLastFrameColorTexture",{get:function(){return this._needLastFrameColorTexture},set:function(e){!e&&this._needLastFrameColorTexture&&(this._currentRenderTarget=0,this.disposeTarget(this.mainColorTarget1)),this._needLastFrameColorTexture=e},enumerable:!1,configurable:!0}),e.prototype.renderToTargets=function(e,t,r,o,i,n){var a=this._rctx,s=this.bindTarget(t,r),l=0;if(o){var p=Math.max(1e-13,o[3]);a.setClearColor(o[0],o[1],o[2],p),l|=16384}return i&&(l|=256),n&&(l|=1024),a.clearSafe(l,!0===n?255:!1===n?0:n),e(),a.gl.flush(),this.bindTarget(this.currentColorTarget,this.mainDepth),s},e.prototype.bindTarget=function(e,t){var r=this.renderTargetHelper.getFramebuffer(this.dimensions,e,t);return this._rctx.bindFramebuffer(r),r},e.prototype.getColorTexture=function(e){return this.renderTargetHelper.getColorTexture(e,this.dimensions)},e.prototype.getGpuMemoryUsage=function(){var e=0;return this.renderTargetHelper&&(e+=this.renderTargetHelper.getGpuMemoryUsage()),e},e}();t.OffscreenRendering=o;var i=[0,0,0,0],n=[0,1,0,1]}));