/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","./basicInterfaces","./RenderTargetHelper","../../../../chunks/Compositing.glsl","../shaders/CompositingTechnique","../../../webgl/context-util","../../../webgl/enums"],(function(e,t,r,i,o,n,a,s,l){"use strict";let h=function(){function e(e,t){this._rctx=e,this._compositingHelper=t,this._mainColorTarget=0,this._dimensions={width:4,height:4},this._needLastFrameColorTexture=!1,this._background={type:"color",color:[0,0,0,1]};const r=e.type===s.ContextType.WEBGL2;this._renderTargetHelper=new o.RenderTargetHelper(e);const i=this._renderTargetHelper;this.mainColorTargets=[i.registerColorTarget({name:"mainColorTarget0"}),i.registerColorTarget({name:"mainColorTarget1"})],this.frontFaceTarget=i.registerColorTarget({name:"frontFaceTarget"});const n=e=>i.registerColorTarget({name:e,dataType:l.PixelType.FLOAT,internalFormat:r?l.SizedPixelFormat.RGBA32F:l.PixelFormat.RGBA,samplingMode:l.TextureSamplingMode.NEAREST});this.colorFloatTarget=n("colorFloatTarget"),this.alphaFloatTarget=n("alphaFloatTarget"),this.mainDepth=i.registerDepthTarget({name:"mainDepth"}),this.linearDepth=i.registerColorTarget({name:"linearDepth",samplingMode:l.TextureSamplingMode.NEAREST}),this.terrainLinearDepth=i.registerColorTarget({name:"terrainLinearDepth"}),this.geometryLinearDepth=i.registerColorTarget({name:"geometryLinearDepth"}),this.normal=i.registerColorTarget({name:"normal"}),this.highlight=i.registerColorTarget({name:"highlight",internalFormat:r?l.SizedPixelFormat.RGBA4:l.PixelFormat.RGBA,dataType:l.PixelType.UNSIGNED_SHORT_4_4_4_4}),this.hudVisibility=i.registerColorTarget({name:"hudVisibility",internalFormat:r?l.SizedPixelFormat.RGBA4:l.PixelFormat.RGBA,dataType:l.PixelType.UNSIGNED_SHORT_4_4_4_4}),this.tmpColor=i.registerColorTarget({name:"tmpColor"}),this.tmpDepth=i.registerDepthTarget({name:"tmpDepth"}),this.hudColor=i.registerColorTarget({name:"hudColor"})}var h=e.prototype;return h.dispose=function(){this._renderTargetHelper.dispose()},h.getFramebuffer=function(e,t){return this._renderTargetHelper.getFramebuffer(this._dimensions,e,t)},h.advanceCurrentRenderTarget=function(){this._mainColorTarget=0===this._mainColorTarget&&this._needLastFrameColorTexture?1:0},h.initializeFrame=function(e){const t=this._rctx;this._dimensions.width=e.fullWidth,this._dimensions.height=e.fullHeight,this.bindTarget(this.currentColorTarget,this.mainDepth),t.setClearStencil(0);const r=this._background.color;t.setClearColor(r[0]*r[3],r[1]*r[3],r[2]*r[3],r[3]),t.clearSafe(l.ClearBufferBit.COLOR_BUFFER_BIT|l.ClearBufferBit.DEPTH_BUFFER_BIT|l.ClearBufferBit.STENCIL_BUFFER_BIT)},h.composite=function(){r.isSome(this.colorTexture)&&this._compositingHelper.composite(this.colorTexture,a.AlphaMode.None)},h.renderTmpAndCompositeToMain=function(e,t,r=!1){this.renderToTargets(e,this.tmpColor,r?this.tmpDepth:this.mainDepth,g),this._compositingHelper.composite(this._getColorTexture(this.tmpColor),t)},h.renderHUDVisibility=function(e,t=!1){this.renderToTargets(e,this.hudVisibility,t?this.tmpDepth:this.mainDepth,u)},h.compositeTransparentTerrainOntoHUDVisibility=function(){this.renderToTargets((()=>this._compositingHelper.composite(this._getColorTexture(this.tmpColor),a.AlphaMode.None,1,n.CompositingFunction.TransparentToHUDVisibility)),this.hudVisibility,this.tmpDepth)},h.renderOITPass=function(e,t,r){let o,n;switch(t){case i.TransparencyPassType.Color:o=this.colorFloatTarget,n=[0,0,0,0];break;case i.TransparencyPassType.Alpha:o=this.alphaFloatTarget,n=[1,1,1,1];break;case i.TransparencyPassType.FrontFace:o=this.frontFaceTarget,n=[0,0,0,0]}r?this.renderToTargets(e,o,this.tmpDepth,n,!0,!0):this.renderToTargets(e,o,this.mainDepth,n,!1)},h.compositeTransparentTerrainOntoMain=function(){this.bindFramebuffer(),this._compositingHelper.composite(this._getColorTexture(this.tmpColor),a.AlphaMode.PremultipliedAlpha)},h.compositeOccludedOntoMain=function(e){this.bindFramebuffer(),this._compositingHelper.composite(this._getColorTexture(this.tmpColor),a.AlphaMode.PremultipliedAlpha,e)},h.compositeTransparentOntoOpaque=function(e){e?(this.bindTarget(this.hudColor,this.tmpDepth),this._rctx.setClearColor(0,0,0,1e-13),this._rctx.clearSafe(l.ClearBufferBit.COLOR_BUFFER_BIT)):this.bindFramebuffer(),this._compositingHelper.compositeTransparent(this._getColorTexture(this.colorFloatTarget),this._getColorTexture(this.alphaFloatTarget),this._getColorTexture(this.frontFaceTarget))},h.bindFramebuffer=function(){this._rctx.bindFramebuffer(this.framebuffer)},h.renderDepthDetached=function(e){this.bindTarget(this.currentColorTarget),e(),this.bindTarget(this.currentColorTarget,this.mainDepth)},h.disposeTarget=function(e){this._renderTargetHelper.disposeTargetResource(e)},h.renderToTargets=function(e,t,r,i,o=!1,n=!1){const a=this._rctx,s=this.bindTarget(t,r);let h=0;if(i){const e=1e-13,t=Math.max(e,i[3]);a.setClearColor(i[0],i[1],i[2],t),h|=l.ClearBufferBit.COLOR_BUFFER_BIT}return o&&(h|=l.ClearBufferBit.DEPTH_BUFFER_BIT),!1===n?n=0:(!0===n&&(n=255),h|=l.ClearBufferBit.STENCIL_BUFFER_BIT),h&&a.clearSafe(h,n),e(),a.gl.flush(),this.bindTarget(this.currentColorTarget,this.mainDepth),s},h.bindTarget=function(e,t){const r=this._renderTargetHelper.getFramebuffer(this._dimensions,e,t);return this._rctx.bindFramebuffer(r),r},h._getColorTexture=function(e){return this._renderTargetHelper.getColorTexture(e,this._dimensions)},t._createClass(e,[{key:"width",get:function(){return this._dimensions.width}},{key:"height",get:function(){return this._dimensions.height}},{key:"background",get:function(){return this._background},set:function(e){this._background=e}},{key:"currentColorTarget",get:function(){return this.mainColorTargets[this._mainColorTarget]}},{key:"previousColorTarget",get:function(){return this.mainColorTargets[1-this._mainColorTarget]}},{key:"framebuffer",get:function(){return this.getFramebuffer(this.currentColorTarget,this.mainDepth)}},{key:"colorTexture",get:function(){return this._renderTargetHelper.getAllocatedColorTexture(this.currentColorTarget)}},{key:"depthTexture",get:function(){return this._renderTargetHelper.getAllocatedDepthTexture(this.mainDepth)}},{key:"linearDepthTexture",get:function(){return this._renderTargetHelper.getAllocatedColorTexture(this.linearDepth)}},{key:"terrainLinearDepthTexture",get:function(){return this._renderTargetHelper.getAllocatedColorTexture(this.terrainLinearDepth)}},{key:"geometryLinearDepthTexture",get:function(){return this._renderTargetHelper.getAllocatedColorTexture(this.geometryLinearDepth)}},{key:"lastFrameColorTexture",get:function(){return this._renderTargetHelper.getAllocatedColorTexture(this.previousColorTarget)}},{key:"normalTexture",get:function(){return this._renderTargetHelper.getAllocatedColorTexture(this.normal)}},{key:"highlightTexture",get:function(){return this._renderTargetHelper.getAllocatedColorTexture(this.highlight)}},{key:"hudVisibilityTexture",get:function(){return this._getColorTexture(this.hudVisibility)}},{key:"tmpColorTexture",get:function(){return this._getColorTexture(this.tmpColor)}},{key:"hudColorTexture",get:function(){return this._getColorTexture(this.hudColor)}},{key:"mainColorTexture",get:function(){return this._getColorTexture(this.currentColorTarget)}},{key:"needLastFrameColorTexture",get:function(){return this._needLastFrameColorTexture},set:function(e){!e&&this._needLastFrameColorTexture&&(this._mainColorTarget=0,this.disposeTarget(this.mainColorTargets[1])),this._needLastFrameColorTexture=e}},{key:"gpuMemoryUsage",get:function(){let e=0;return this._renderTargetHelper&&(e+=this._renderTargetHelper.gpuMemoryUsage),e}}]),e}();const g=[0,0,0,0],u=[0,1,0,1];e.OffscreenRendering=h,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
