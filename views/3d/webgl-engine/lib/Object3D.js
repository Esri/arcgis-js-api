// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../support/mathUtils","./ComponentUtils","./GeometryRecord","./HighlightUtils","./IdGen","./Util"],function(t,e,i,o,n,r,s,a,l,m,h,c,p){var d=p.assert,b=n.mat4f64.create(),u=function(){function t(e){void 0===e&&(e={}),this._objectTransformation=n.mat4f64.create(),this._bvObjectSpace=new f,this._bvWorldSpace=new f,this._bvDirty=!0,this._hasVolatileTransformation=!1,this._allComponentsHiddenDirty=!0,this._allComponentsVisibleDirty=!0,this.id=t._idGen.gen(e.idHint),this.castShadow=null==e.castShadow||e.castShadow,this.metadata=e.metadata,this.metadata&&this.metadata.isElevationSource&&(this.metadata.lastValidElevationBB=new g),this.objectTransformation=n.mat4f64.create(),this._initializeGeometryRecords(e.geometries,e.materials,e.transformations,e.origins)}return Object.defineProperty(t.prototype,"geometryRecords",{get:function(){return this._geometryRecords},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"geometries",{get:function(){return this._geometries},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"objectTransformation",{get:function(){return this._objectTransformation},set:function(t){o.mat4.copy(this._objectTransformation,t),this._invalidateBoundingVolume(),this._notifyDirty("objTransformation")},enumerable:!0,configurable:!0}),t.prototype.dispose=function(){for(var t=0,e=this._geometryRecords;t<e.length;t++){var i=e[t];m.pool.release(i)}this._geometryRecords=null,this._geometries=null},t.prototype._initializeGeometryRecords=function(t,e,i,o){if(!Array.isArray(t))return this._geometryRecords=[],void(this._geometries=[]);d(e.length===t.length,"Object3D: materials don't match geometries"),d(i.length===t.length,"Object3D: transformations don't match geometries"),this._geometryRecords=new Array(t.length),this._geometries=t.slice();for(var r=0;r<t.length;r++){var s={};this._geometryRecords[r]=m.pool.acquire(t[r],e[r],n.mat4f64.clone(i[r]),s,o&&o[r])}this._hasVolatileTransformation=!1},Object.defineProperty(t.prototype,"parentLayer",{get:function(){return this._parentLayer},set:function(t){d(null==this._parentLayer||null==t,"Object3D can only be added to a single Layer"),this._parentLayer=t},enumerable:!0,configurable:!0}),t.prototype.getNumGeometryRecords=function(){return this._geometryRecords.length},t.prototype.findGeometryRecords=function(t){for(var e=[],i=0;i<this._geometries.length;i++)this._geometries[i]===t&&e.push(this._geometryRecords[i]);return e},t.prototype.getGeometryRecord=function(t){return d(t>=0&&t<this._geometryRecords.length,"Object3d.getGeometryDataByIndex: index out of range"),this._geometryRecords[t]},t.prototype.addGeometry=function(t,e,i,o,r,s){i=i?n.mat4f64.clone(i):b,this._geometries.push(t);var a=m.pool.acquire(t,e,i,o||{},r,s);return this._geometryRecords.push(a),this._hasVolatileTransformation=this._geometryRecords.some(function(t){return!!t.shaderTransformation}),this._notifyDirty("objGeometryAdded",a),this._invalidateBoundingVolume(),this._allComponentsHiddenDirty=!0,this._allComponentsVisibleDirty=!0,a},t.prototype.removeGeometry=function(t){var e=this._geometryRecords.splice(t,1)[0];return m.pool.release(e),this._hasVolatileTransformation=this._geometryRecords.some(function(t){return!!t.shaderTransformation}),this._geometries.splice(t,1),this._notifyDirty("objGeometryRemoved",e),this._invalidateBoundingVolume(),this._allComponentsHiddenDirty=!0,this._allComponentsVisibleDirty=!0,e},t.prototype.removeAllGeometries=function(){for(;this.getNumGeometryRecords()>0;)this.removeGeometry(0)},t.prototype.geometryVertexAttrsUpdated=function(t){this._notifyDirty("vertexAttrsUpdated",this._geometryRecords[t]),this._invalidateBoundingVolume()},t.prototype.areAllComponentsHidden=function(){if(this._allComponentsHiddenDirty){this._allComponentsHiddenDirty=!1,this._allComponentsHidden=!0;for(var t=0,e=this._geometryRecords;t<e.length;t++){var i=e[t],o=i.instanceParameters.componentVisibilities,n=i.geometry.data.componentOffsets;if(!l.isAllHidden(o,n)){this._allComponentsHidden=!1;break}}}return this._allComponentsHidden},t.prototype.areAllComponentsVisible=function(){if(this._allComponentsVisibleDirty){this._allComponentsVisibleDirty=!1,this._allComponentsVisible=!0;for(var t=0,e=this._geometryRecords;t<e.length;t++){var i=e[t],o=i.instanceParameters.componentVisibilities,n=i.geometry.data.componentOffsets;if(!l.isAllVisible(o,n)){this._allComponentsVisible=!1;break}}}return this._allComponentsVisible},t.prototype.hasComponents=function(){for(var t=!1,e=0;e<this._geometries.length;e++){var i=this._geometries[e];if(t=l.hasComponents(i.data.componentOffsets))break}return t},t.prototype.setComponentVisibility=function(t,e,i){var o=t.geometry,n=t.instanceParameters.componentVisibilities,r=o.data.componentOffsets,s=l.updateVisibility(n,r,e,i);t.instanceParameters.componentVisibilities=s,this._notifyDirty("visibilityChanged",t),this._allComponentsHiddenDirty=!0,this._allComponentsVisibleDirty=!0},t.prototype.setHidden=function(t,e){t.instanceParameters.hidden=!!e,this._notifyDirty("visibilityChanged",t)},t.prototype.isHidden=function(t){return!!t.instanceParameters.hidden},t.prototype.getComponentVisibility=function(t,e){var i=t.instanceParameters.componentVisibilities;return l.getVisibility(i,e)},t.prototype.hideAllComponents=function(){if(this._allComponentsHiddenDirty||!this._allComponentsHidden){for(var t=0,e=this._geometryRecords;t<e.length;t++){var i=e[t],o=i.instanceParameters.componentVisibilities,n=l.hideAllComponents(o);i.instanceParameters.componentVisibilities=n}this._notifyDirty("visibilityChanged"),this._allComponentsHiddenDirty=!1,this._allComponentsVisibleDirty=!1,this._allComponentsHidden=!0,this._allComponentsVisible=!1}},t.prototype.unhideAllComponents=function(){if(this._allComponentsVisibleDirty||!this._allComponentsVisible){for(var t=0,e=this._geometryRecords;t<e.length;t++){var i=e[t],o=i.instanceParameters.componentVisibilities,n=l.unhideAllComponents(o);i.instanceParameters.componentVisibilities=n}this._notifyDirty("visibilityChanged"),this._allComponentsHiddenDirty=!1,this._allComponentsVisibleDirty=!1,this._allComponentsHidden=!1,this._allComponentsVisible=!0}},t.prototype._setComponentHighlight=function(t,e,i,o){var n=t.instanceParameters.componentHighlights,r=l.addHighlight(n,e,i,o);t.instanceParameters.componentHighlights=r},t.prototype.setComponentHighlight=function(t,e,i){var o=h.generateHighlightId();return this._setComponentHighlight(t,e,i,o),this._notifyDirty("componentHighlightChanged"),o},t.prototype.highlightAllComponents=function(t){for(var e=h.generateHighlightId(),i=0,o=this._geometryRecords;i<o.length;i++){var n=o[i];this._setComponentHighlight(n,null,t,e)}return this._notifyDirty("componentHighlightChanged"),e},t.prototype.removeHighlights=function(t){for(var e=0,i=this._geometryRecords;e<i.length;e++){var o=i[e],n=o.instanceParameters,r=n.componentHighlights,s=l.removeHighlight(r,t);n.componentHighlights=s}this._notifyDirty("componentHighlightChanged")},t.prototype.getComponentFromTriangleNr=function(t,e){d(t>=0&&t<this._geometryRecords.length,"Object3d.getComponentFromTriangleNr: index out of range");var i=this._geometryRecords[t],o=i.geometry.data.componentOffsets;return l.componentFind(o,3*e)},t.prototype.setGeometryTransformation=function(t,e){d(t>=0&&t<this._geometryRecords.length,"Object3d.setGeometryTransformation: index out of range");var i=this._geometryRecords[t];m.pool.release(i);var o=m.pool.acquire(i.geometry,i.material,n.mat4f64.clone(e),i.instanceParameters);this._geometryRecords[t]=o,this._notifyDirty("objGeometryReplaced",[i,o]),this._invalidateBoundingVolume()},t.prototype.getCombinedStaticTransformation=function(t,e){return e=e||n.mat4f64.create(),o.mat4.multiply(e,this.objectTransformation,t.getStaticTransformation()),e},t.prototype.getCombinedShaderTransformation=function(t,e){return e=e||n.mat4f64.create(),o.mat4.multiply(e,this.objectTransformation,t.getShaderTransformation()),e},t.prototype.hasVolativeTransformation=function(){return this._hasVolatileTransformation},t.prototype.getMetadata=function(){return this.metadata},t.prototype.getBBMin=function(t){return this._validateBoundingVolume(),t?this._bvObjectSpace.bbMin:this._bvWorldSpace.bbMin},t.prototype.getBBMax=function(t){return this._validateBoundingVolume(),t?this._bvObjectSpace.bbMax:this._bvWorldSpace.bbMax},t.prototype.getCenter=function(t){return this._validateBoundingVolume(),t?this._bvObjectSpace.center:this._bvWorldSpace.center},t.prototype.getBSRadius=function(t){return this._validateBoundingVolume(),t?this._bvObjectSpace.bsRadius:this._bvWorldSpace.bsRadius},t.prototype._validateBoundingVolume=function(){if(this._bvDirty||this._hasVolatileTransformation){this._bvObjectSpace.init(),this._bvWorldSpace.init();for(var t=0;t<this._geometryRecords.length;++t){var e=this._geometries[t],i=this._geometryRecords[t],o=e.boundingInfo;this._calculateTransformedBoundingVolume(o,this._bvObjectSpace,i.getShaderTransformation()),this._calculateTransformedBoundingVolume(o,this._bvWorldSpace,this.getCombinedShaderTransformation(i))}r.vec3.lerp(this._bvObjectSpace.center,this._bvObjectSpace.bbMin,this._bvObjectSpace.bbMax,.5),r.vec3.lerp(this._bvWorldSpace.center,this._bvWorldSpace.bbMin,this._bvWorldSpace.bbMax,.5);for(var n=s.vec3f64.create(),l=s.vec3f64.create(),m=a.maxScale(this.objectTransformation),t=0;t<this._geometryRecords.length;++t){var e=this._geometries[t],h=this._geometryRecords[t].getShaderTransformation(),c=a.maxScale(h),o=e.boundingInfo;r.vec3.transformMat4(n,o.getCenter(),h);var p=r.vec3.distance(n,this._bvObjectSpace.center),d=o.getBSRadius()*c;this._bvObjectSpace.bsRadius=Math.max(this._bvObjectSpace.bsRadius,p+d),r.vec3.transformMat4(l,n,this.objectTransformation);var b=r.vec3.distance(l,this._bvWorldSpace.center),u=d*m;this._bvWorldSpace.bsRadius=Math.max(this._bvWorldSpace.bsRadius,b+u)}this._bvDirty=!1}},t.prototype._calculateTransformedBoundingVolume=function(t,e,i){var o=t.getBBMin(),n=t.getBBMax(),a=s.vec3f64.clone(o),l=s.vec3f64.clone(n);r.vec3.transformMat4(a,a,i),r.vec3.transformMat4(l,l,i);for(var m=0;m<3;++m)e.bbMin[m]=Math.min(e.bbMin[m],a[m],l[m]),e.bbMax[m]=Math.max(e.bbMax[m],a[m],l[m]);for(var m=0;m<3;++m){r.vec3.copy(a,o),r.vec3.copy(l,n),a[m]=n[m],l[m]=o[m],r.vec3.transformMat4(a,a,i),r.vec3.transformMat4(l,l,i);for(var h=0;h<3;++h)e.bbMin[h]=Math.min(e.bbMin[h],a[h],l[h]),e.bbMax[h]=Math.max(e.bbMax[h],a[h],l[h])}},t.prototype._invalidateBoundingVolume=function(){this._bvDirty=!0,this._parentLayer&&this._parentLayer.notifyObjectBBChanged(this,{center:this._bvWorldSpace.center,radius:this._bvWorldSpace.bsRadius})},t.prototype._notifyDirty=function(t,e,i,o){if(this._parentLayer){i=i||1;var n=o||this;this._parentLayer.notifyDirty(t,e,i,n)}},Object.defineProperty(t.prototype,"test",{get:function(){var t=this;return{hasGeometry:function(e){return t._geometries.indexOf(e)>-1},getGeometryIndex:function(e){return t._geometries.indexOf(e)}}},enumerable:!0,configurable:!0}),t._idGen=new c.IdGen,t}(),g=function(){function t(){this.bbMin=s.vec3f64.fromValues(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.bbMax=s.vec3f64.fromValues(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}return t.prototype.isEmpty=function(){return this.bbMax[0]<this.bbMin[0]&&this.bbMax[1]<this.bbMin[1]&&this.bbMax[2]<this.bbMin[2]},t}(),f=function(t){function e(){var e=t.call(this)||this;return e.center=s.vec3f64.create(),e.bsRadius=0,e}return i(e,t),e.prototype.init=function(){r.vec3.set(this.bbMin,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),r.vec3.set(this.bbMax,-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),r.vec3.set(this.center,0,0,0),this.bsRadius=0},e.prototype.getCenter=function(){return this.center},e.prototype.getBSRadius=function(){return this.bsRadius},e}(g);return u});