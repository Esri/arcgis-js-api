/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../chunks/sphere","../../support/mathUtils","./basicInterfaces","./ContentObject","./ContentObjectType","./GeometryRecord","./Object3DStateID","./Util","../materials/renderers/utils"],(function(e,t,i,o,n,s,r,a,c,h,m,l,u,d,_,g){"use strict";let b=function(e){function a(i={}){var o;(o=e.call(this)||this).type=l.ContentObjectType.Object,o._geometryRecords=new Array,o._geometries=new Array,o._objectTransformation=n.create(),o._bvObjectSpace=new y,o._bvWorldSpace=new y,o._bvDirty=!0,o._hasVolatileTransformation=!1,o._visible=!0,o.castShadow=null==i.castShadow||i.castShadow,o.metadata=i.metadata,o.metadata&&o.metadata.isElevationSource&&(o.metadata.lastValidElevationBB=new f),o.transformation=n.create();const{geometries:s,materials:r,transformations:a,origins:c}=i;if(!Array.isArray(s))return t._assertThisInitialized(o);_.assert(r.length===s.length,"Object3D: materials don't match geometries"),_.assert(a.length===s.length,"Object3D: transformations don't match geometries"),o._geometryRecords.length=s.length,o._geometries.length=s.length;for(let e=0;e<s.length;e++)o._geometries[e]=s[e],o._geometryRecords[e]=u.GeometryRecord.pool.acquire(s[e],r[e],n.clone(a[e]),{highlights:null,occludees:null,visible:o._visible},c&&c[e]);return o}t._inheritsLoose(a,e);var m=a.prototype;return m.dispose=function(){this._geometryRecords.length=0,this._geometries.length=0},m.addGeometry=function(e,t,o,s,r){o=o||n.IDENTITY,this._geometries.push(e);const a=u.GeometryRecord.pool.acquire(e,t,o,{highlights:null,occludees:null,visible:this._visible},s,r);return this._geometryRecords.push(a),this._hasVolatileTransformation=this._hasVolatileTransformation||i.isSome(a.shaderTransformation),this._emit("objectGeometryAdded",{object:this,record:a}),this._invalidateBoundingVolume(),a},m.removeGeometry=function(e){const t=this._geometryRecords.splice(e,1)[0];return this._hasVolatileTransformation=i.isSome(t.shaderTransformation)?this._geometryRecords.some((e=>i.isSome(e.shaderTransformation))):this._hasVolatileTransformation,t.dispose(),this._geometries.splice(e,1),this._emit("objectGeometryRemoved",{object:this,record:t}),this._invalidateBoundingVolume(),t},m.removeAllGeometries=function(){for(;this.geometryRecords.length>0;)this.removeGeometry(0)},m.geometryVertexAttrsUpdated=function(e){this._emit("vertexAttrsUpdated",{object:this,record:e}),this._invalidateBoundingVolume()},m.setVisible=function(e){if(this._visible!==e){this._visible=e;for(const e of this._geometryRecords)e.instanceParameters.visible=this._visible;this._emit("visibilityChanged",this)}},m.maskOccludee=function(){const e=new d.Object3DStateID(h.Object3DState.MaskOccludee);for(const t of this._geometryRecords)t.instanceParameters.occludees=g.addObject3DStateID(t.instanceParameters.occludees,e);return this._emit("occlusionChanged",this),e},m.removeOcclude=function(e){for(const t of this._geometryRecords)t.instanceParameters.occludees=g.removeObject3DStateID(t.instanceParameters.occludees,e);this._emit("occlusionChanged",this)},m.highlight=function(){const e=new d.Object3DStateID(h.Object3DState.Highlight);for(const t of this._geometryRecords)t.instanceParameters.highlights=g.addObject3DStateID(t.instanceParameters.highlights,e);return this._emit("highlightChanged",this),e},m.removeHighlight=function(e){for(const t of this._geometryRecords)t.instanceParameters.highlights=g.removeObject3DStateID(t.instanceParameters.highlights,e);this._emit("highlightChanged",this)},m.getCombinedStaticTransformation=function(e,t){return o.multiply(i.unwrapOr(t,n.create()),this.transformation,e.getStaticTransformation())},m._getCombinedShaderTransformation=function(e,t){return t=t||n.create(),o.multiply(t,this.transformation,e.getShaderTransformation()),t},m.hasVolativeTransformation=function(){return this._hasVolatileTransformation},m._validateBoundingVolume=function(){if(!this._bvDirty&&!this._hasVolatileTransformation)return;this._bvObjectSpace.init(),this._bvWorldSpace.init();for(let n=0;n<this._geometryRecords.length;++n){const e=this._geometries[n],t=this._geometryRecords[n],o=e.boundingInfo;i.isSome(o)&&(this._calculateTransformedBoundingVolume(o,this._bvObjectSpace,t.getShaderTransformation()),this._calculateTransformedBoundingVolume(o,this._bvWorldSpace,this._getCombinedShaderTransformation(t)))}s.lerp(this._bvObjectSpace.bounds,this._bvObjectSpace.min,this._bvObjectSpace.max,.5),s.lerp(this._bvWorldSpace.bounds,this._bvWorldSpace.min,this._bvWorldSpace.max,.5);const e=r.create(),t=r.create(),o=c.maxScale(this.transformation);for(let n=0;n<this._geometryRecords.length;++n){const r=this._geometries[n].boundingInfo;if(i.isNone(r))continue;const a=this._geometryRecords[n].getShaderTransformation(),h=c.maxScale(a);s.transformMat4(e,r.getCenter(),a);const m=s.distance(e,this._bvObjectSpace.bounds),l=r.getBSRadius()*h;this._bvObjectSpace.bounds[3]=Math.max(this._bvObjectSpace.bounds[3],m+l),s.transformMat4(t,e,this.transformation);const u=s.distance(t,this._bvWorldSpace.bounds),d=l*o;this._bvWorldSpace.bounds[3]=Math.max(this._bvWorldSpace.bounds[3],u+d)}this._bvDirty=!1},m._calculateTransformedBoundingVolume=function(e,t,i){const o=e.getBBMin(),n=e.getBBMax(),a=r.clone(o),c=r.clone(n);s.transformMat4(a,a,i),s.transformMat4(c,c,i);for(let s=0;s<3;++s)t.min[s]=Math.min(t.min[s],a[s],c[s]),t.max[s]=Math.max(t.max[s],a[s],c[s]);for(let r=0;r<3;++r){s.copy(a,o),s.copy(c,n),a[r]=n[r],c[r]=o[r],s.transformMat4(a,a,i),s.transformMat4(c,c,i);for(let e=0;e<3;++e)t.min[e]=Math.min(t.min[e],a[e],c[e]),t.max[e]=Math.max(t.max[e],a[e],c[e])}},m._invalidateBoundingVolume=function(){this._bvDirty=!0,i.isSome(this._parentLayer)&&this._parentLayer.notifyObjectBBChanged(this,this._bvWorldSpace.bounds)},m._emit=function(e,t){i.isSome(this._parentLayer)&&this._parentLayer.events.emit(e,t)},t._createClass(a,[{key:"geometryRecords",get:function(){return this._geometryRecords}},{key:"geometries",get:function(){return this._geometries}},{key:"transformation",get:function(){return this._objectTransformation},set:function(e){o.copy(this._objectTransformation,e),this._invalidateBoundingVolume(),this._emit("objectTransformation",this)}},{key:"parentLayer",get:function(){return this._parentLayer},set:function(e){_.assert(null==this._parentLayer||null==e,"Object3D can only be added to a single Layer"),this._parentLayer=e}},{key:"isVisible",get:function(){return this._visible}},{key:"boundingVolumeWorldSpace",get:function(){return this._validateBoundingVolume(),this._bvWorldSpace}},{key:"boundingVolumeObjectSpace",get:function(){return this._validateBoundingVolume(),this._bvObjectSpace}},{key:"test",get:function(){const e=this;return{hasGeometry:t=>e._geometries.indexOf(t)>-1,getGeometryIndex:t=>e._geometries.indexOf(t)}}}]),a}(m.ContentObject),f=function(){function e(){this.min=r.fromValues(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.max=r.fromValues(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}return e.prototype.isEmpty=function(){return this.max[0]<this.min[0]&&this.max[1]<this.min[1]&&this.max[2]<this.min[2]},e}(),y=function(e){function i(){var t;return(t=e.apply(this,arguments)||this).bounds=a.create(),t}return t._inheritsLoose(i,e),i.prototype.init=function(){s.set(this.min,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),s.set(this.max,-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),a.clear(this.bounds)},i}(f);e.Object3D=b,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
