// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../core/maybe","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../support/mathUtils","./GeometryRecord","./IdGen","./Object3DStateSet","./Util","../materials/renderers/utils"],(function(e,t,r,i,o,n,a,s,c,h,m,u,b,l){"use strict";var d=function(){function e(t){void 0===t&&(t={}),this._objectTransformation=n.mat4f64.create(),this._bvObjectSpace=new g,this._bvWorldSpace=new g,this._bvDirty=!0,this._hasVolatileTransformation=!1,this._visible=!0,this.id=e._idGen.gen(t.idHint),this.castShadow=null==t.castShadow||t.castShadow,this.metadata=t.metadata,this.metadata&&this.metadata.isElevationSource&&(this.metadata.lastValidElevationBB=new f),this.objectTransformation=n.mat4f64.create(),this._initializeGeometryRecords(t.geometries,t.materials,t.transformations,t.origins)}return Object.defineProperty(e.prototype,"geometryRecords",{get:function(){return this._geometryRecords},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"geometries",{get:function(){return this._geometries},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"objectTransformation",{get:function(){return this._objectTransformation},set:function(e){o.mat4.copy(this._objectTransformation,e),this._invalidateBoundingVolume(),this._notifyDirty("objTransformation")},enumerable:!1,configurable:!0}),e.prototype.dispose=function(){for(var e=0,t=this._geometryRecords;e<t.length;e++){var r=t[e];h.pool.release(r)}this._geometryRecords=null,this._geometries=null},e.prototype._initializeGeometryRecords=function(e,t,r,i){if(!Array.isArray(e))return this._geometryRecords=[],void(this._geometries=[]);b.assert(t.length===e.length,"Object3D: materials don't match geometries"),b.assert(r.length===e.length,"Object3D: transformations don't match geometries"),this._geometryRecords=new Array(e.length),this._geometries=e.slice();for(var o=0;o<e.length;o++){this._geometryRecords[o]=h.pool.acquire(e[o],t[o],n.mat4f64.clone(r[o]),{highlights:null,occludees:null,visible:!0},i&&i[o])}this._hasVolatileTransformation=!1},Object.defineProperty(e.prototype,"parentLayer",{get:function(){return this._parentLayer},set:function(e){b.assert(null==this._parentLayer||null==e,"Object3D can only be added to a single Layer"),this._parentLayer=e},enumerable:!1,configurable:!0}),e.prototype.getNumGeometryRecords=function(){return this._geometryRecords.length},e.prototype.getGeometryRecord=function(e){return b.assert(e>=0&&e<this._geometryRecords.length,"Object3d.getGeometryDataByIndex: index out of range"),this._geometryRecords[e]},e.prototype.addGeometry=function(e,t,r,i,o,a){r=r||n.mat4f64.IDENTITY,this._geometries.push(e);var s=h.pool.acquire(e,t,r,i||{highlights:null,occludees:null,visible:!0},o,a);return this._geometryRecords.push(s),this._hasVolatileTransformation=this._geometryRecords.some((function(e){return!!e.shaderTransformation})),this._notifyDirty("objGeometryAdded",s),this._invalidateBoundingVolume(),s},e.prototype.removeGeometry=function(e){var t=this._geometryRecords.splice(e,1)[0];return h.pool.release(t),this._hasVolatileTransformation=this._geometryRecords.some((function(e){return!!e.shaderTransformation})),this._geometries.splice(e,1),this._notifyDirty("objGeometryRemoved",t),this._invalidateBoundingVolume(),t},e.prototype.removeAllGeometries=function(){for(;this.getNumGeometryRecords()>0;)this.removeGeometry(0)},e.prototype.geometryVertexAttrsUpdated=function(e){this._notifyDirty("vertexAttrsUpdated",this._geometryRecords[e]),this._invalidateBoundingVolume()},Object.defineProperty(e.prototype,"isVisible",{get:function(){return this._visible},enumerable:!1,configurable:!0}),e.prototype.setVisible=function(e){this._visible=e;for(var t=0,r=this._geometryRecords;t<r.length;t++){r[t].instanceParameters.visible=this._visible}this._notifyDirty("visibilityChanged")},e.prototype.occlude=function(){for(var e=u.generateObject3DStateId(1),t=0,r=this._geometryRecords;t<r.length;t++){var i=r[t];i.instanceParameters.occludees=l.addObject3DStateID(i.instanceParameters.occludees,e)}return this._notifyDirty("occlusionChanged"),e},e.prototype.removeOcclude=function(e){for(var t=0,r=this._geometryRecords;t<r.length;t++){var i=r[t];i.instanceParameters.occludees=l.removeObject3DStateID(i.instanceParameters.occludees,e)}this._notifyDirty("occlusionChanged")},e.prototype.highlight=function(){for(var e=u.generateObject3DStateId(0),t=0,r=this._geometryRecords;t<r.length;t++){var i=r[t];i.instanceParameters.highlights=l.addObject3DStateID(i.instanceParameters.highlights,e)}return this._notifyDirty("highlightChanged"),e},e.prototype.removeHighlight=function(e){for(var t=0,r=this._geometryRecords;t<r.length;t++){var i=r[t];i.instanceParameters.highlights=l.removeObject3DStateID(i.instanceParameters.highlights,e)}this._notifyDirty("highlightChanged")},e.prototype.getCombinedStaticTransformation=function(e,t){return o.mat4.multiply(i.unwrapOr(t,n.mat4f64.create()),this.objectTransformation,e.getStaticTransformation())},e.prototype.getCombinedShaderTransformation=function(e,t){return t=t||n.mat4f64.create(),o.mat4.multiply(t,this.objectTransformation,e.getShaderTransformation()),t},e.prototype.hasVolativeTransformation=function(){return this._hasVolatileTransformation},e.prototype.getBBMin=function(e){return this._validateBoundingVolume(),e?this._bvObjectSpace.bbMin:this._bvWorldSpace.bbMin},e.prototype.getBBMax=function(e){return this._validateBoundingVolume(),e?this._bvObjectSpace.bbMax:this._bvWorldSpace.bbMax},e.prototype.getCenter=function(e){return this._validateBoundingVolume(),e?this._bvObjectSpace.center:this._bvWorldSpace.center},e.prototype.getBSRadius=function(e){return this._validateBoundingVolume(),e?this._bvObjectSpace.bsRadius:this._bvWorldSpace.bsRadius},e.prototype._validateBoundingVolume=function(){if(this._bvDirty||this._hasVolatileTransformation){this._bvObjectSpace.init(),this._bvWorldSpace.init();for(var e=0;e<this._geometryRecords.length;++e){var t=this._geometries[e],r=this._geometryRecords[e],i=t.boundingInfo;this._calculateTransformedBoundingVolume(i,this._bvObjectSpace,r.getShaderTransformation()),this._calculateTransformedBoundingVolume(i,this._bvWorldSpace,this.getCombinedShaderTransformation(r))}a.vec3.lerp(this._bvObjectSpace.center,this._bvObjectSpace.bbMin,this._bvObjectSpace.bbMax,.5),a.vec3.lerp(this._bvWorldSpace.center,this._bvWorldSpace.bbMin,this._bvWorldSpace.bbMax,.5);var o=s.vec3f64.create(),n=s.vec3f64.create(),h=c.maxScale(this.objectTransformation);for(e=0;e<this._geometryRecords.length;++e){t=this._geometries[e];var m=this._geometryRecords[e].getShaderTransformation(),u=c.maxScale(m);i=t.boundingInfo;a.vec3.transformMat4(o,i.getCenter(),m);var b=a.vec3.distance(o,this._bvObjectSpace.center),l=i.getBSRadius()*u;this._bvObjectSpace.bsRadius=Math.max(this._bvObjectSpace.bsRadius,b+l),a.vec3.transformMat4(n,o,this.objectTransformation);var d=a.vec3.distance(n,this._bvWorldSpace.center),f=l*h;this._bvWorldSpace.bsRadius=Math.max(this._bvWorldSpace.bsRadius,d+f)}this._bvDirty=!1}},e.prototype._calculateTransformedBoundingVolume=function(e,t,r){var i=e.getBBMin(),o=e.getBBMax(),n=s.vec3f64.clone(i),c=s.vec3f64.clone(o);a.vec3.transformMat4(n,n,r),a.vec3.transformMat4(c,c,r);for(var h=0;h<3;++h)t.bbMin[h]=Math.min(t.bbMin[h],n[h],c[h]),t.bbMax[h]=Math.max(t.bbMax[h],n[h],c[h]);for(h=0;h<3;++h){a.vec3.copy(n,i),a.vec3.copy(c,o),n[h]=o[h],c[h]=i[h],a.vec3.transformMat4(n,n,r),a.vec3.transformMat4(c,c,r);for(var m=0;m<3;++m)t.bbMin[m]=Math.min(t.bbMin[m],n[m],c[m]),t.bbMax[m]=Math.max(t.bbMax[m],n[m],c[m])}},e.prototype._invalidateBoundingVolume=function(){this._bvDirty=!0,this._parentLayer&&this._parentLayer.notifyObjectBBChanged(this,{center:this._bvWorldSpace.center,radius:this._bvWorldSpace.bsRadius})},e.prototype._notifyDirty=function(e,t,r,i){if(this._parentLayer){r=r||1;var o=i||this;this._parentLayer.notifyDirty(e,t,r,o)}},Object.defineProperty(e.prototype,"test",{get:function(){var e=this;return{hasGeometry:function(t){return e._geometries.indexOf(t)>-1},getGeometryIndex:function(t){return e._geometries.indexOf(t)}}},enumerable:!1,configurable:!0}),e._idGen=new m.IdGen,e}(),f=function(){function e(){this.bbMin=s.vec3f64.fromValues(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.bbMax=s.vec3f64.fromValues(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}return e.prototype.isEmpty=function(){return this.bbMax[0]<this.bbMin[0]&&this.bbMax[1]<this.bbMin[1]&&this.bbMax[2]<this.bbMin[2]},e}(),g=function(e){function t(){var t=e.call(this)||this;return t.center=s.vec3f64.create(),t.bsRadius=0,t}return r.__extends(t,e),t.prototype.init=function(){a.vec3.set(this.bbMin,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),a.vec3.set(this.bbMax,-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),a.vec3.set(this.center,0,0,0),this.bsRadius=0},t.prototype.getCenter=function(){return this.center},t.prototype.getBSRadius=function(){return this.bsRadius},t}(f);return d}));