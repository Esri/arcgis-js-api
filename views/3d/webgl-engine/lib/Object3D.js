/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../chunks/sphere","../../support/mathUtils","./ContentObject","./GeometryRecord","./Object3DStateID","./Util","../materials/renderers/utils"],(function(e,t,i,o,r,n,s,a,c,m,h,l,u,d){"use strict";let g=function(e){function a(i={}){var o;(o=e.call(this)||this).type=1,o._geometryRecords=new Array,o._geometries=new Array,o._objectTransformation=r.create(),o._bvObjectSpace=new f,o._bvWorldSpace=new f,o._bvDirty=!0,o._hasVolatileTransformation=!1,o._visible=!0,o.castShadow=null==i.castShadow||i.castShadow,o.metadata=i.metadata,o.metadata&&o.metadata.isElevationSource&&(o.metadata.lastValidElevationBB=new _),o.transformation=r.create();const{geometries:n,materials:s,transformations:a,origins:c}=i;if(!Array.isArray(n))return t._assertThisInitialized(o);u.assert(s.length===n.length,"Object3D: materials don't match geometries"),u.assert(a.length===n.length,"Object3D: transformations don't match geometries"),o._geometryRecords.length=n.length,o._geometries.length=n.length;for(let e=0;e<n.length;e++)o._geometries[e]=n[e],o._geometryRecords[e]=h.GeometryRecord.pool.acquire(n[e],s[e],r.clone(a[e]),{highlights:null,occludees:null,visible:!0},c&&c[e]);return o}t._inheritsLoose(a,e);var m=a.prototype;return m.dispose=function(){this._geometryRecords.length=0,this._geometries.length=0},m.getNumGeometryRecords=function(){return this._geometryRecords.length},m.getGeometryRecord=function(e){return u.assert(e>=0&&e<this._geometryRecords.length,"Object3d.getGeometryDataByIndex: index out of range"),this._geometryRecords[e]},m.addGeometry=function(e,t,o,n,s,a){o=o||r.IDENTITY,this._geometries.push(e);const c=h.GeometryRecord.pool.acquire(e,t,o,n||{highlights:null,occludees:null,visible:!0},s,a);return this._geometryRecords.push(c),this._hasVolatileTransformation=this._hasVolatileTransformation||i.isSome(c.shaderTransformation),this._emit("objectGeometryAdded",{object:this,record:c}),this._invalidateBoundingVolume(),c},m.removeGeometry=function(e){const t=this._geometryRecords.splice(e,1)[0];return this._hasVolatileTransformation=i.isSome(t.shaderTransformation)?this._geometryRecords.some((e=>i.isSome(e.shaderTransformation))):this._hasVolatileTransformation,t.dispose(),this._geometries.splice(e,1),this._emit("objectGeometryRemoved",{object:this,record:t}),this._invalidateBoundingVolume(),t},m.removeAllGeometries=function(){for(;this.getNumGeometryRecords()>0;)this.removeGeometry(0)},m.geometryVertexAttrsUpdated=function(e){this._emit("vertexAttrsUpdated",{object:this,record:this._geometryRecords[e]}),this._invalidateBoundingVolume()},m.setVisible=function(e){this._visible=e;for(const t of this._geometryRecords)t.instanceParameters.visible=this._visible;this._emit("visibilityChanged",this)},m.maskOccludee=function(){const e=new l.Object3DStateID(1);for(const t of this._geometryRecords)t.instanceParameters.occludees=d.addObject3DStateID(t.instanceParameters.occludees,e);return this._emit("occlusionChanged",this),e},m.removeOcclude=function(e){for(const t of this._geometryRecords)t.instanceParameters.occludees=d.removeObject3DStateID(t.instanceParameters.occludees,e);this._emit("occlusionChanged",this)},m.highlight=function(){const e=new l.Object3DStateID(0);for(const t of this._geometryRecords)t.instanceParameters.highlights=d.addObject3DStateID(t.instanceParameters.highlights,e);return this._emit("highlightChanged",this),e},m.removeHighlight=function(e){for(const t of this._geometryRecords)t.instanceParameters.highlights=d.removeObject3DStateID(t.instanceParameters.highlights,e);this._emit("highlightChanged",this)},m.getCombinedStaticTransformation=function(e,t){return o.multiply(i.unwrapOr(t,r.create()),this.transformation,e.getStaticTransformation())},m.getCombinedShaderTransformation=function(e,t){return t=t||r.create(),o.multiply(t,this.transformation,e.getShaderTransformation()),t},m.hasVolativeTransformation=function(){return this._hasVolatileTransformation},m._validateBoundingVolume=function(){if(!this._bvDirty&&!this._hasVolatileTransformation)return;this._bvObjectSpace.init(),this._bvWorldSpace.init();for(let r=0;r<this._geometryRecords.length;++r){const e=this._geometries[r],t=this._geometryRecords[r],o=e.boundingInfo;i.isSome(o)&&(this._calculateTransformedBoundingVolume(o,this._bvObjectSpace,t.getShaderTransformation()),this._calculateTransformedBoundingVolume(o,this._bvWorldSpace,this.getCombinedShaderTransformation(t)))}n.lerp(this._bvObjectSpace.bounds,this._bvObjectSpace.min,this._bvObjectSpace.max,.5),n.lerp(this._bvWorldSpace.bounds,this._bvWorldSpace.min,this._bvWorldSpace.max,.5);const e=s.create(),t=s.create(),o=c.maxScale(this.transformation);for(let r=0;r<this._geometryRecords.length;++r){const s=this._geometries[r].boundingInfo;if(i.isNone(s))continue;const a=this._geometryRecords[r].getShaderTransformation(),m=c.maxScale(a);n.transformMat4(e,s.getCenter(),a);const h=n.distance(e,this._bvObjectSpace.bounds),l=s.getBSRadius()*m;this._bvObjectSpace.bounds[3]=Math.max(this._bvObjectSpace.bounds[3],h+l),n.transformMat4(t,e,this.transformation);const u=n.distance(t,this._bvWorldSpace.bounds),d=l*o;this._bvWorldSpace.bounds[3]=Math.max(this._bvWorldSpace.bounds[3],u+d)}this._bvDirty=!1},m._calculateTransformedBoundingVolume=function(e,t,i){const o=e.getBBMin(),r=e.getBBMax(),a=s.clone(o),c=s.clone(r);n.transformMat4(a,a,i),n.transformMat4(c,c,i);for(let n=0;n<3;++n)t.min[n]=Math.min(t.min[n],a[n],c[n]),t.max[n]=Math.max(t.max[n],a[n],c[n]);for(let s=0;s<3;++s){n.copy(a,o),n.copy(c,r),a[s]=r[s],c[s]=o[s],n.transformMat4(a,a,i),n.transformMat4(c,c,i);for(let e=0;e<3;++e)t.min[e]=Math.min(t.min[e],a[e],c[e]),t.max[e]=Math.max(t.max[e],a[e],c[e])}},m._invalidateBoundingVolume=function(){this._bvDirty=!0,i.isSome(this._parentLayer)&&this._parentLayer.notifyObjectBBChanged(this,this._bvWorldSpace.bounds)},m._emit=function(e,t){i.isSome(this._parentLayer)&&this._parentLayer.events.emit(e,t)},t._createClass(a,[{key:"geometryRecords",get:function(){return this._geometryRecords}},{key:"geometries",get:function(){return this._geometries}},{key:"transformation",get:function(){return this._objectTransformation},set:function(e){o.copy(this._objectTransformation,e),this._invalidateBoundingVolume(),this._emit("objectTransformation",this)}},{key:"parentLayer",get:function(){return this._parentLayer},set:function(e){u.assert(null==this._parentLayer||null==e,"Object3D can only be added to a single Layer"),this._parentLayer=e}},{key:"isVisible",get:function(){return this._visible}},{key:"boundingVolumeWorldSpace",get:function(){return this._validateBoundingVolume(),this._bvWorldSpace}},{key:"boundingVolumeObjectSpace",get:function(){return this._validateBoundingVolume(),this._bvObjectSpace}},{key:"test",get:function(){const e=this;return{hasGeometry:t=>e._geometries.indexOf(t)>-1,getGeometryIndex:t=>e._geometries.indexOf(t)}}}]),a}(m.ContentObject),_=function(){function e(){this.min=s.fromValues(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.max=s.fromValues(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}return e.prototype.isEmpty=function(){return this.max[0]<this.min[0]&&this.max[1]<this.min[1]&&this.max[2]<this.min[2]},e}(),f=function(e){function i(){var t;return(t=e.apply(this,arguments)||this).bounds=a.create(),t}return t._inheritsLoose(i,e),i.prototype.init=function(){n.set(this.min,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),n.set(this.max,-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),a.clear(this.bounds)},i}(_);e.Object3D=g,Object.defineProperty(e,"__esModule",{value:!0})}));
