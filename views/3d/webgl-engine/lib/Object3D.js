/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../chunks/vec3f64","../../../../chunks/vec3","../../support/mathUtils","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/sphere","./Util","./ContentObject","./GeometryRecord","./Object3DStateID","../materials/renderers/utils"],(function(e,t,i,o,n,r,s,a,c,h,m,l,u,b){"use strict";let d=function(e){function c(i={}){var o;(o=e.call(this)||this).type=1,o._geometryRecords=new Array,o._geometries=new Array,o._objectTransformation=a.create(),o._bvObjectSpace=new g,o._bvWorldSpace=new g,o._bvDirty=!0,o._hasVolatileTransformation=!1,o._visible=!0,o.castShadow=null==i.castShadow||i.castShadow,o.metadata=i.metadata,o.metadata&&o.metadata.isElevationSource&&(o.metadata.lastValidElevationBB=new _),o.transformation=a.create();const{geometries:n,materials:r,transformations:s,origins:c}=i;if(!Array.isArray(n))return t._assertThisInitialized(o);h.assert(r.length===n.length,"Object3D: materials don't match geometries"),h.assert(s.length===n.length,"Object3D: transformations don't match geometries"),o._geometryRecords.length=n.length,o._geometries.length=n.length;for(let e=0;e<n.length;e++)o._geometries[e]=n[e],o._geometryRecords[e]=l.GeometryRecord.pool.acquire(n[e],r[e],a.clone(s[e]),{highlights:null,occludees:null,visible:!0},c&&c[e]);return o}t._inheritsLoose(c,e);var m=c.prototype;return m.dispose=function(){this._geometryRecords.length=0,this._geometries.length=0},m.getNumGeometryRecords=function(){return this._geometryRecords.length},m.getGeometryRecord=function(e){return h.assert(e>=0&&e<this._geometryRecords.length,"Object3d.getGeometryDataByIndex: index out of range"),this._geometryRecords[e]},m.addGeometry=function(e,t,o,n,r,s){o=o||a.IDENTITY,this._geometries.push(e);const c=l.GeometryRecord.pool.acquire(e,t,o,n||{highlights:null,occludees:null,visible:!0},r,s);return this._geometryRecords.push(c),this._hasVolatileTransformation=this._hasVolatileTransformation||i.isSome(c.shaderTransformation),this._emit("objectGeometryAdded",{object:this,record:c}),this._invalidateBoundingVolume(),c},m.removeGeometry=function(e){const t=this._geometryRecords.splice(e,1)[0];return this._hasVolatileTransformation=i.isSome(t.shaderTransformation)?this._geometryRecords.some((e=>i.isSome(e.shaderTransformation))):this._hasVolatileTransformation,t.dispose(),this._geometries.splice(e,1),this._emit("objectGeometryRemoved",{object:this,record:t}),this._invalidateBoundingVolume(),t},m.removeAllGeometries=function(){for(;this.getNumGeometryRecords()>0;)this.removeGeometry(0)},m.geometryVertexAttrsUpdated=function(e){this._emit("vertexAttrsUpdated",{object:this,record:this._geometryRecords[e]}),this._invalidateBoundingVolume()},m.setVisible=function(e){this._visible=e;for(const t of this._geometryRecords)t.instanceParameters.visible=this._visible;this._emit("visibilityChanged",this)},m.maskOccludee=function(){const e=new u.Object3DStateID(1);for(const t of this._geometryRecords)t.instanceParameters.occludees=b.addObject3DStateID(t.instanceParameters.occludees,e);return this._emit("occlusionChanged",this),e},m.removeOcclude=function(e){for(const t of this._geometryRecords)t.instanceParameters.occludees=b.removeObject3DStateID(t.instanceParameters.occludees,e);this._emit("occlusionChanged",this)},m.highlight=function(){const e=new u.Object3DStateID(0);for(const t of this._geometryRecords)t.instanceParameters.highlights=b.addObject3DStateID(t.instanceParameters.highlights,e);return this._emit("highlightChanged",this),e},m.removeHighlight=function(e){for(const t of this._geometryRecords)t.instanceParameters.highlights=b.removeObject3DStateID(t.instanceParameters.highlights,e);this._emit("highlightChanged",this)},m.getCombinedStaticTransformation=function(e,t){return s.multiply(i.unwrapOr(t,a.create()),this.transformation,e.getStaticTransformation())},m.getCombinedShaderTransformation=function(e,t){return t=t||a.create(),s.multiply(t,this.transformation,e.getShaderTransformation()),t},m.hasVolativeTransformation=function(){return this._hasVolatileTransformation},m.getBBMin=function(e){return this._validateBoundingVolume(),e?this._bvObjectSpace.bbMin:this._bvWorldSpace.bbMin},m.getBBMax=function(e){return this._validateBoundingVolume(),e?this._bvObjectSpace.bbMax:this._bvWorldSpace.bbMax},m.getBounds=function(e){return this._validateBoundingVolume(),e?this._bvObjectSpace.bounds:this._bvWorldSpace.bounds},m._validateBoundingVolume=function(){if(!this._bvDirty&&!this._hasVolatileTransformation)return;this._bvObjectSpace.init(),this._bvWorldSpace.init();for(let o=0;o<this._geometryRecords.length;++o){const e=this._geometries[o],t=this._geometryRecords[o],n=e.boundingInfo;i.isSome(n)&&(this._calculateTransformedBoundingVolume(n,this._bvObjectSpace,t.getShaderTransformation()),this._calculateTransformedBoundingVolume(n,this._bvWorldSpace,this.getCombinedShaderTransformation(t)))}n.lerp(this._bvObjectSpace.bounds,this._bvObjectSpace.bbMin,this._bvObjectSpace.bbMax,.5),n.lerp(this._bvWorldSpace.bounds,this._bvWorldSpace.bbMin,this._bvWorldSpace.bbMax,.5);const e=o.create(),t=o.create(),s=r.maxScale(this.transformation);for(let o=0;o<this._geometryRecords.length;++o){const a=this._geometries[o].boundingInfo;if(i.isNone(a))continue;const c=this._geometryRecords[o].getShaderTransformation(),h=r.maxScale(c);n.transformMat4(e,a.getCenter(),c);const m=n.distance(e,this._bvObjectSpace.bounds),l=a.getBSRadius()*h;this._bvObjectSpace.bounds[3]=Math.max(this._bvObjectSpace.bounds[3],m+l),n.transformMat4(t,e,this.transformation);const u=n.distance(t,this._bvWorldSpace.bounds),b=l*s;this._bvWorldSpace.bounds[3]=Math.max(this._bvWorldSpace.bounds[3],u+b)}this._bvDirty=!1},m._calculateTransformedBoundingVolume=function(e,t,i){const r=e.getBBMin(),s=e.getBBMax(),a=o.clone(r),c=o.clone(s);n.transformMat4(a,a,i),n.transformMat4(c,c,i);for(let o=0;o<3;++o)t.bbMin[o]=Math.min(t.bbMin[o],a[o],c[o]),t.bbMax[o]=Math.max(t.bbMax[o],a[o],c[o]);for(let o=0;o<3;++o){n.copy(a,r),n.copy(c,s),a[o]=s[o],c[o]=r[o],n.transformMat4(a,a,i),n.transformMat4(c,c,i);for(let e=0;e<3;++e)t.bbMin[e]=Math.min(t.bbMin[e],a[e],c[e]),t.bbMax[e]=Math.max(t.bbMax[e],a[e],c[e])}},m._invalidateBoundingVolume=function(){this._bvDirty=!0,i.isSome(this._parentLayer)&&this._parentLayer.notifyObjectBBChanged(this,this._bvWorldSpace.bounds)},m._emit=function(e,t){i.isSome(this._parentLayer)&&this._parentLayer.events.emit(e,t)},t._createClass(c,[{key:"geometryRecords",get:function(){return this._geometryRecords}},{key:"geometries",get:function(){return this._geometries}},{key:"transformation",get:function(){return this._objectTransformation},set:function(e){s.copy(this._objectTransformation,e),this._invalidateBoundingVolume(),this._emit("objectTransformation",this)}},{key:"parentLayer",get:function(){return this._parentLayer},set:function(e){h.assert(null==this._parentLayer||null==e,"Object3D can only be added to a single Layer"),this._parentLayer=e}},{key:"isVisible",get:function(){return this._visible}},{key:"test",get:function(){const e=this;return{hasGeometry:t=>e._geometries.indexOf(t)>-1,getGeometryIndex:t=>e._geometries.indexOf(t)}}}]),c}(m.ContentObject),_=function(){function e(){this.bbMin=o.fromValues(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.bbMax=o.fromValues(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}return e.prototype.isEmpty=function(){return this.bbMax[0]<this.bbMin[0]&&this.bbMax[1]<this.bbMin[1]&&this.bbMax[2]<this.bbMin[2]},e}(),g=function(e){function i(){var t;return(t=e.apply(this,arguments)||this).bounds=c.create(),t}return t._inheritsLoose(i,e),i.prototype.init=function(){n.set(this.bbMin,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),n.set(this.bbMax,-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),c.clear(this.bounds)},i}(_);e.Object3D=d,Object.defineProperty(e,"__esModule",{value:!0})}));
