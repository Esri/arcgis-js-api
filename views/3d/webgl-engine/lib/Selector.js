// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.5/esri/copyright.txt for details.

define(["require","exports","dojo/has","./PerformanceTimer","./gl-matrix","./Object3D"],function(t,e,r,i,s,n){var a=1e-5,o=s.vec3d.create(),h=s.vec3d.create(),l=r("dojo-debug-messages"),u=function(){function t(t,e,r,n,a,o,h,u){void 0===u&&(u=!1),this.dir=s.vec3d.create(),this.normalDir=null,this.minResult=new c,this.maxResult=new c,this.transform=s.mat4d.create(),this._transformInverse=new m({value:this.transform},s.mat4d.inverse,s.mat4d.create),this._transformInverseTranspose=new m(this._transformInverse,s.mat4d.transpose,s.mat4d.create),this._transformTranspose=new m({value:this.transform},s.mat4d.transpose,s.mat4d.create),this._transformInverseRotation=new m({value:this.transform},s.mat4d.toInverseMat3,s.mat3d.create),this.enableHUDSelection=!0,this.enableTerrain=!0,this.enableInvisibleTerrain=!1,this.enableBackfacesTerrain=!0,this.performanceInfo={queryDuration:0,numObjectsTested:0},this.viewingMode=t||"global",this.intersectObject=this.intersectObject.bind(this),l&&(this.timer=new i(1)),this.init(e,r,n,a,o,h,u)}return t.prototype.init=function(t,e,r,i,n,o,h){if(e&&r&&s.vec3d.subtract(r,e,this.dir),this.minResult.init(e,r),this.maxResult.init(e,r),this.numObjectsTested=0,this.point=i,this.camera=n,this.isSelection=h,this.layers=t,this.p0=e,this.p1=r,this.hudResults=[],null==o&&(o=a),this.tolerance=o,this.layers){l&&this.timer.start();for(var u=0;u<this.layers.length;++u){var c=this.layers[u],m=c.getSpatialQueryAccelerator?c.getSpatialQueryAccelerator():void 0;if(m)m.forEachAlongRay(this.p0,this.dir,this.intersectObject);else for(var f=c.getObjects(),p=0;p<f.length;++p)this.intersectObject(f[p])}l&&(this.timer.stop(),this.performanceInfo.queryDuration=this.timer.getLast(),this.performanceInfo.numObjectsTested=this.numObjectsTested)}},Object.defineProperty(t.prototype,"transformInverse",{get:function(){return this._transformInverse.value},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"transformInverseTranspose",{get:function(){return this._transformInverseTranspose.value},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"transformInverseRotation",{get:function(){return this._transformInverseRotation.value},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"transformTranspose",{get:function(){return this._transformTranspose.value},enumerable:!0,configurable:!0}),t.prototype.getDirection=function(){return this.normalDir||(this.normalDir=s.vec3d.create(),s.vec3d.normalize(this.dir,this.normalDir)),this.normalDir},t.prototype.intersectObject=function(t){var e=this;this.numObjectsTested++;for(var r,i=t.getId(),n=t.getGeometryRecords(),a=t.objectTransformation,l=0;l<n.length;l++){var u=n[l],m=u.geometry,f=u.materials,p=u.instanceParameters;r=m.getId(),s.mat4d.set(a,this.transform),s.mat4d.multiply(this.transform,u.getShaderTransformation()),this._transformInverse.invalidate(),this._transformInverseTranspose.invalidate(),this._transformTranspose.invalidate(),this._transformInverseRotation.invalidate(),s.mat4d.multiplyVec3(this.transformInverse,this.p0,o),s.mat4d.multiplyVec3(this.transformInverse,this.p1,h),f[0].intersect(m,p,this.transform,this,o,h,function(s,n,a,o,h,l){if(s>=0)if(h){var u=new c;u.set(t,i,s,n,o,l,r,a),e.hudResults.push(u)}else(null==e.minResult.priority||o>=e.minResult.priority)&&(null==e.minResult.dist||s<e.minResult.dist)&&e.minResult.set(t,i,s,n,o,null,r,a),(null==e.maxResult.priority||o>=e.maxResult.priority)&&(null==e.maxResult.dist||s>e.maxResult.dist)&&e.maxResult.set(t,i,s,n,o,null,r,a)},u.customTransformation)}},t.prototype.getMinResult=function(){return this.minResult},t.prototype.getMaxResult=function(){return this.maxResult},t.prototype.getHudResults=function(){return this.hudResults},t.DEFAULT_TOLERANCE=a,t}(),c=function(){function t(t,e){this.normal=s.vec3d.create(),this.init(t,e)}return t.prototype.getIntersectionPoint=function(t){return null==this.dist?!1:(s.vec3d.lerp(this.p0,this.p1,this.dist,t),!0)},t.prototype.set=function(t,e,r,i,a,o,h,l){this.dist=r,s.vec3d.set(i,this.normal),t?this.targetType=t instanceof n?"StageObject":"StagePoint":this.targetType="None",this.target=t,this.name=e,this.priority=a,this.center=o?s.vec3d.create(o):null,this.geometryId=h,this.triangleNr=l},t.prototype.setIntersector=function(t){this.intersector=t},t.prototype.init=function(t,e){this.dist=void 0,this.targetType="None",this.target=void 0,this.name=void 0,this.priority=void 0,this.center=null,this.geometryId=null,this.triangleNr=null,this.intersector="stage",this.p0=t,this.p1=e},t}(),m=function(){function t(t,e,r){this.original=t,this.update=e,this.dirty=!0,this.transform=r()}return t.prototype.invalidate=function(){this.dirty=!0},Object.defineProperty(t.prototype,"value",{get:function(){return this.dirty&&(this.update(this.original.value,this.transform),this.dirty=!1),this.transform},enumerable:!0,configurable:!0}),t}();return u});