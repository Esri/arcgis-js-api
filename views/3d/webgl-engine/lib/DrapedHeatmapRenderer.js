/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/arrayUtils","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","../../../ViewingMode","./glUtil3D","./SortedRenderGeometryRenderer","../shaders/HeatmapTechnique","../../../webgl/enums","../../../webgl/FramebufferObject","../../../webgl/Texture","../../../webgl/Util"],(function(e,t,r,a,i,s,o,n,p,h,d,c,m,l,u,y,_){"use strict";e.DrapedHeatmapRenderer=function(e){function r(t){var r;return(r=e.call(this,t)||this).pixelRatio=1,r._colorRampData=new Uint8ClampedArray(4),r.type="draped-heatmap",r._heatmapParameters=new m.HeatmapPassParameters,r}t._inheritsLoose(r,e);var s=r.prototype;return s.initialize=function(){const e={colorTarget:l.TargetType.TEXTURE,depthStencilTarget:l.DepthStencilTargetType.NONE,width:0,height:0},t={target:l.TextureType.TEXTURE_2D,pixelFormat:this.pixelFormat,internalFormat:this.internalFormat,dataType:this.dataType,samplingMode:this.samplingMode,wrapMode:l.TextureWrapMode.CLAMP_TO_EDGE,width:0,height:0};this._densityMap=new u.FramebufferObject(this.rctx,e,t),this._quad=d.createQuadVAO(this.rctx);const r=this._colorRampData,a={target:l.TextureType.TEXTURE_2D,pixelFormat:l.PixelFormat.RGBA,dataType:l.PixelType.UNSIGNED_BYTE,samplingMode:l.TextureSamplingMode.LINEAR,wrapMode:l.TextureWrapMode.CLAMP_TO_EDGE,width:r.length/4,height:1};this._colorRamp=new y.Texture(this.rctx,a,r);const s=new m.HeatmapTechniqueConfiguration;s.usesHalfFloat=this.dataType!==l.PixelType.FLOAT,this._technique=new m.HeatmapTechnique({rctx:this.rctx,viewingMode:h.ViewingMode.Local},s),this._heatmapParameters.densityMap=this._densityMap.colorTexture,this.addHandles(i.watch((()=>[this.colorRampData,this.minDensity,this.maxDensity,this.fieldTotal,this.pixelRatio,this.searchRadius]),(()=>this.rendererContext.notifyContentChanged())))},s.destroy=function(){this._technique=a.releaseMaybe(this._technique),this._densityMap=a.disposeMaybe(this._densityMap),this._quad=a.disposeMaybe(this._quad),this._colorRamp=a.disposeMaybe(this._colorRamp)},s.render=function(e,t){const r=this._sortedMaterialRenderers,a=r.length;if(a<1)return;const i=this.rctx.getBoundFramebufferObject(),s=this.rctx.getViewport(),{pixelRatio:o}=this,n=Math.ceil(s.width*o),p=Math.ceil(s.height*o);this._densityMap.resize(n,p),this.rctx.bindFramebuffer(this._densityMap),this.rctx.setViewport(0,0,n,p),this.rctx.clear(l.ClearBufferBit.COLOR_BUFFER_BIT);let h=!1;for(let d=0;d<a;d++){const a=r.getItemAt(d);a.material.shouldRender(e)&&(h=h||a.materialRenderer.render(e.output,t))}this.rctx.bindFramebuffer(i),this.rctx.setViewport(s.x,s.y,s.width,s.height),h&&(this.rctx.bindVAO(this._quad),this.rctx.bindTechnique(this._technique,this._heatmapParameters,e.bindParameters),this.rctx.drawArrays(this._technique.primitiveType,0,_.vertexCount(this._quad,"geometry")))},t._createClass(r,[{key:"searchRadius",get:function(){return this._heatmapParameters.searchRadius},set:function(e){e!==this._heatmapParameters.searchRadius&&(this._heatmapParameters.searchRadius=e,this.notifyChange("searchRadius"))}},{key:"minDensity",get:function(){return this._heatmapParameters.minDensity},set:function(e){e!==this._heatmapParameters.minDensity&&(this._heatmapParameters.minDensity=e,this.notifyChange("minDensity"))}},{key:"maxDensity",get:function(){return this._heatmapParameters.maxDensity},set:function(e){e!==this._heatmapParameters.maxDensity&&(this._heatmapParameters.maxDensity=e,this.notifyChange("maxDensity"))}},{key:"fieldTotal",get:function(){return this._heatmapParameters.fieldTotal},set:function(e){this._heatmapParameters.fieldTotal=e,this.notifyChange("fieldTotal")}},{key:"colorRampData",get:function(){return this._colorRampData},set:function(e){const{colorRamp:t}=this._heatmapParameters;if(a.isSome(t)&&e!==this._colorRampData){const r=t.descriptor.width,a=e.length/4;a!==r&&t.resize(a,1),t.setData(e)}this._colorRampData=e}},{key:"_colorRamp",get:function(){return this._heatmapParameters.colorRamp},set:function(e){this._heatmapParameters.colorRamp=e}},{key:"hasHighlights",get:function(){return!1}},{key:"hasWater",get:function(){return!1}},{key:"rendersOccluded",get:function(){return!1}}]),r}(c.SortedRenderGeometryRenderer),r.__decorate([s.property()],e.DrapedHeatmapRenderer.prototype,"searchRadius",null),r.__decorate([s.property()],e.DrapedHeatmapRenderer.prototype,"minDensity",null),r.__decorate([s.property()],e.DrapedHeatmapRenderer.prototype,"maxDensity",null),r.__decorate([s.property()],e.DrapedHeatmapRenderer.prototype,"fieldTotal",null),r.__decorate([s.property()],e.DrapedHeatmapRenderer.prototype,"pixelRatio",void 0),r.__decorate([s.property()],e.DrapedHeatmapRenderer.prototype,"colorRampData",null),r.__decorate([s.property({constructOnly:!0})],e.DrapedHeatmapRenderer.prototype,"dataType",void 0),r.__decorate([s.property({constructOnly:!0})],e.DrapedHeatmapRenderer.prototype,"samplingMode",void 0),r.__decorate([s.property({constructOnly:!0})],e.DrapedHeatmapRenderer.prototype,"pixelFormat",void 0),r.__decorate([s.property({constructOnly:!0})],e.DrapedHeatmapRenderer.prototype,"internalFormat",void 0),r.__decorate([s.property()],e.DrapedHeatmapRenderer.prototype,"_colorRampData",void 0),e.DrapedHeatmapRenderer=r.__decorate([p.subclass("esri.views.3d.webgl-engine.lib.DrapedHeatmapRenderer")],e.DrapedHeatmapRenderer),Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
