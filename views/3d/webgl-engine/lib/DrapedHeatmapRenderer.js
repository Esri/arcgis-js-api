/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/maybe","../../../../core/Logger","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/set","../../../../core/accessorSupport/decorators/subclass","../../../ViewingMode","./glUtil3D","./SortedRenderGeometryRenderer","../materials/HeatmapDensityMaterial","../shaders/HeatmapTechnique","../../../webgl/enums","../../../webgl/FramebufferObject","../../../webgl/Texture","../../../webgl/Util"],(function(e,t,r,i,a,s,n,o,c,l,h,d,p,u,m,y,g,x,_){"use strict";function T(e){return u.isHeatMapDensityMaterial(e.material)}e.DrapedHeatmapRenderer=function(e){function r(){var t;return(t=e.apply(this,arguments)||this).type="draped-heatmap",t}t._inheritsLoose(r,e);var a=r.prototype;return a.initialize=function(){e.prototype.initialize.call(this);const t={colorTarget:y.TargetType.TEXTURE,depthStencilTarget:y.DepthStencilTargetType.NONE,width:0,height:0},{capabilities:r}=this.rctx,{R32F:i}=r.colorBufferFloat,{textureFloatLinear:a}=r.textureFloat,s=null!=i,n={target:y.TextureType.TEXTURE_2D,pixelFormat:s?y.PixelFormat.RED:y.PixelFormat.RGBA,internalFormat:s?y.SizedPixelFormat.R32F:y.PixelFormat.RGBA,dataType:y.PixelType.FLOAT,samplingMode:a?y.TextureSamplingMode.LINEAR:y.TextureSamplingMode.NEAREST,wrapMode:y.TextureWrapMode.CLAMP_TO_EDGE,width:0,height:0};this._densityMap=new g.FramebufferObject(this.rctx,t,n),this._quad=d.createQuadVAO(this.rctx);const o={target:y.TextureType.TEXTURE_2D,pixelFormat:y.PixelFormat.RGBA,dataType:y.PixelType.UNSIGNED_BYTE,samplingMode:y.TextureSamplingMode.LINEAR,wrapMode:y.TextureWrapMode.CLAMP_TO_EDGE,width:1,height:1},c=new x.Texture(this.rctx,o,new Uint8ClampedArray(4));this._colorRamp=c,this._technique=new m.HeatmapTechnique({rctx:this.rctx,viewingMode:h.ViewingMode.Local},new m.HeatmapTechniqueConfiguration),this._heatmapParameters={colorRamp:c,densityMap:this._densityMap.colorTexture,searchRadius:1,minDensity:0,maxDensity:100,fieldTotal:0}},a.destroy=function(){this._technique=i.releaseMaybe(this._technique),this._densityMap=i.disposeMaybe(this._densityMap),this._quad=i.disposeMaybe(this._quad),this._colorRamp=i.disposeMaybe(this._colorRamp)},a.add=function(t){e.prototype.add.call(this,t)},a.remove=function(t){e.prototype.remove.call(this,t)},a.render=function(e,t){const r=this._heatmapDensityMaterialRenderers,a=r.length;if(a<1)return;const s=this.rctx.getBoundFramebufferObject(),n=this.rctx.getViewport(),o=r[0].material.parameters,{pixelRatio:c}=o,l=Math.ceil(n.width*c),h=Math.ceil(n.height*c);this._densityMap.resize(l,h),this.rctx.bindFramebuffer(this._densityMap),this.rctx.setViewport(0,0,l,h),this.rctx.clear(y.ClearBufferBit.COLOR_BUFFER_BIT);let d=!1;for(let i=0;i<a;i++){const a=r[i];a.material.shouldRender(e)&&(d=d||a.materialRenderer.render(t.slot,e.pass,t))}if(this.rctx.bindFramebuffer(s),this.rctx.setViewport(n.x,n.y,n.width,n.height),!d)return;const{searchRadius:p,minDensity:u,maxDensity:m,fieldTotal:g,colorRampData:x}=o,T=this._heatmapParameters;if(T.searchRadius=p,T.fieldTotal=g,T.searchRadius=p,T.minDensity=u,T.maxDensity=m,i.isSome(x)&&x!==this._colorRampData){const{colorRamp:e}=T,t=e.descriptor.width,r=x.length/4;r!==t&&e.resize(r,1),e.setData(x),this._colorRampData=x}this.rctx.bindVAO(this._quad),this.rctx.useProgram(this._technique.program),this._technique.bindPipelineState(this.rctx),this._technique.bindPass(T,t),this.rctx.drawArrays(this._technique.primitiveType,0,_.vertexCount(this._quad,"geometry"))},t._createClass(r,[{key:"hasHighlights",get:function(){return!1}},{key:"hasWater",get:function(){return!1}},{key:"rendersOccluded",get:function(){return!1}},{key:"_heatmapDensityMaterialRenderers",get:function(){return this._sortedMaterialRenderers.filter(T)}}]),r}(p.SortedRenderGeometryRenderer),e.DrapedHeatmapRenderer=r.__decorate([l.subclass("esri.views.3d.webgl-engine.lib.DrapedHeatmapRenderer")],e.DrapedHeatmapRenderer),Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
