/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{_ as t}from"../../../../chunks/tslib.es6.js";import{releaseMaybe as e,disposeMaybe as r,isSome as a}from"../../../../core/maybe.js";import{watch as i}from"../../../../core/reactiveUtils.js";import{property as s}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/arrayUtils.js";import"../../../../core/has.js";import"../../../../core/accessorSupport/ensureType.js";import{subclass as o}from"../../../../core/accessorSupport/decorators/subclass.js";import{ViewingMode as h}from"../../../ViewingMode.js";import{ShaderTechniqueConfiguration as n}from"../core/shaderTechnique/ShaderTechniqueConfiguration.js";import{createQuadVAO as m}from"./glUtil3D.js";import{SortedRenderGeometryRenderer as p}from"./SortedRenderGeometryRenderer.js";import{HeatmapPassParameters as c,HeatmapTechnique as l}from"../shaders/HeatmapTechnique.js";import{TargetType as d,DepthStencilTargetType as u,TextureType as _,PixelFormat as R,SizedPixelFormat as y,PixelType as g,TextureSamplingMode as f,TextureWrapMode as x,ClearBufferBit as D}from"../../../webgl/enums.js";import{FramebufferObject as T}from"../../../webgl/FramebufferObject.js";import{Texture as w}from"../../../webgl/Texture.js";import{vertexCount as P}from"../../../webgl/Util.js";let b=class extends p{constructor(t){super(t),this.pixelRatio=1,this._colorRampData=new Uint8ClampedArray(4),this.type="draped-heatmap",this._heatmapParameters=new c}initialize(){const t={colorTarget:d.TEXTURE,depthStencilTarget:u.NONE,width:0,height:0},{capabilities:e}=this.rctx,{R32F:r}=e.colorBufferFloat,{textureFloatLinear:a}=e.textureFloat,s=null!=r,o={target:_.TEXTURE_2D,pixelFormat:s?R.RED:R.RGBA,internalFormat:s?y.R32F:R.RGBA,dataType:g.FLOAT,samplingMode:a?f.LINEAR:f.NEAREST,wrapMode:x.CLAMP_TO_EDGE,width:0,height:0};this._densityMap=new T(this.rctx,t,o),this._quad=m(this.rctx);const p=this._colorRampData,c={target:_.TEXTURE_2D,pixelFormat:R.RGBA,dataType:g.UNSIGNED_BYTE,samplingMode:f.LINEAR,wrapMode:x.CLAMP_TO_EDGE,width:p.length/4,height:1};this._colorRamp=new w(this.rctx,c,p),this._technique=new l({rctx:this.rctx,viewingMode:h.Local},new n),this._heatmapParameters.densityMap=this._densityMap.colorTexture,this.own(i((()=>[this.colorRampData,this.minDensity,this.maxDensity,this.fieldTotal,this.pixelRatio,this.searchRadius]),(()=>this.rendererContext.notifyContentChanged())))}destroy(){this._technique=e(this._technique),this._densityMap=r(this._densityMap),this._quad=r(this._quad),this._colorRamp=r(this._colorRamp)}get searchRadius(){return this._heatmapParameters.searchRadius}set searchRadius(t){t!==this._heatmapParameters.searchRadius&&(this._heatmapParameters.searchRadius=t,this.notifyChange("searchRadius"))}get minDensity(){return this._heatmapParameters.minDensity}set minDensity(t){t!==this._heatmapParameters.minDensity&&(this._heatmapParameters.minDensity=t,this.notifyChange("minDensity"))}get maxDensity(){return this._heatmapParameters.maxDensity}set maxDensity(t){t!==this._heatmapParameters.maxDensity&&(this._heatmapParameters.maxDensity=t,this.notifyChange("maxDensity"))}get fieldTotal(){return this._heatmapParameters.fieldTotal}set fieldTotal(t){this._heatmapParameters.fieldTotal=t,this.notifyChange("fieldTotal")}get colorRampData(){return this._colorRampData}set colorRampData(t){const{colorRamp:e}=this._heatmapParameters;if(a(e)&&t!==this._colorRampData){const r=e.descriptor.width,a=t.length/4;a!==r&&e.resize(a,1),e.setData(t)}this._colorRampData=t}get _colorRamp(){return this._heatmapParameters.colorRamp}set _colorRamp(t){this._heatmapParameters.colorRamp=t}get hasHighlights(){return!1}get hasWater(){return!1}get rendersOccluded(){return!1}render(t,e){const r=this._sortedMaterialRenderers,a=r.length;if(a<1)return;const i=this.rctx.getBoundFramebufferObject(),s=this.rctx.getViewport(),{pixelRatio:o}=this,h=Math.ceil(s.width*o),n=Math.ceil(s.height*o);this._densityMap.resize(h,n),this.rctx.bindFramebuffer(this._densityMap),this.rctx.setViewport(0,0,h,n),this.rctx.clear(D.COLOR_BUFFER_BIT);let m=!1;for(let p=0;p<a;p++){const a=r.getItemAt(p);a.material.shouldRender(t)&&(m=m||a.materialRenderer.render(t.pass,e))}this.rctx.bindFramebuffer(i),this.rctx.setViewport(s.x,s.y,s.width,s.height),m&&(this.rctx.bindVAO(this._quad),this.rctx.useProgram(this._technique.program),this._technique.bindPipelineState(this.rctx),this._technique.bindPass(this._heatmapParameters,t.bindParameters),this.rctx.drawArrays(this._technique.primitiveType,0,P(this._quad,"geometry")))}};t([s()],b.prototype,"searchRadius",null),t([s()],b.prototype,"minDensity",null),t([s()],b.prototype,"maxDensity",null),t([s()],b.prototype,"fieldTotal",null),t([s()],b.prototype,"pixelRatio",void 0),t([s()],b.prototype,"colorRampData",null),t([s()],b.prototype,"_colorRampData",void 0),b=t([o("esri.views.3d.webgl-engine.lib.DrapedHeatmapRenderer")],b);export{b as DrapedHeatmapRenderer};
