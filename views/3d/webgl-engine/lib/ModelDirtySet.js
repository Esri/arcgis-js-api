/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/has","../../../../core/maybe","../../../../core/Logger","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/decorators/subclass","../../../../core/urlUtils","../../../../core/uuid","../../../../portal/support/resourceExtension","../../../../core/Accessor","../../../../core/uid","../../../../core/MapUtils","./Util","./GeometryRecord"],(function(e,t,o,r,s,d,i,c,n,a,l,u,h,y,m,f){"use strict";let _=function(t){function o(e){var o;return(o=t.call(this,e)||this)._residentGeomRecords=new Map,o._dirtyGeomRecords=new Map,o.dirty=!1,o}e._inheritsLoose(o,t);var s=o.prototype;return s.commit=function(e){this.dirty=!1,this._dirtyGeomRecords.forEach(((t,o)=>this.commitLayer(o,e)))},s.commitLayer=function(e,t){const o=this._dirtyGeomRecords.get(e);o&&(o.forEach(((o,r)=>{const s=this._ensureGeomRecord(e,r);o.forEach(((e,o)=>{const d=e[0],i=e[1],c=e[2];let n=!1;if(2&i){const e=s.get(o);if(e){const o=e[1];if(4&c){const e=this.model.getObject(r);this.model.updateRenderGeometryTransformation(e,d,o)&&(n=!0)}n||t.updates.push({renderGeometry:o,updateType:c})}else m.assert(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid update")}if(4&i||n){const e=s.get(o);e?(t.removes.push(e[1]),s.delete(o),e[0].disposed&&f.GeometryRecord.pool.release(e[0])):4===i&&m.assert(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid remove")}if(1&i||n){const e=this.model.getObject(r),i=this.model.getRenderGeometry(e,d),c=[d,i];t.adds.push(i),s.set(o,c)}})),0===s.size&&this._residentGeomRecords.get(e).delete(r)})),0===this._residentGeomRecords.get(e).size&&this._residentGeomRecords.delete(e),this._dirtyGeomRecords.delete(e))},s.getResidentRenderGeometries=function(e,t){const o=this._residentGeomRecords.get(e);o&&o.forEach((e=>e.forEach((e=>t.push(e[1])))))},s._objectStateChanged=function(e,t){for(const o of t.geometryRecords)this._updateOrCreateDirtyRecord(t,o,null,2,0,0,2,5,e)},s.visibilityChanged=function(e){this._objectStateChanged(1,e)},s.highlightChanged=function(e){this._objectStateChanged(8,e)},s.occlusionChanged=function(e){this._objectStateChanged(16,e)},s.vertexAttrsUpdated=function(e){this._updateOrCreateDirtyRecord(e.object,e.record,null,2,0,0,2,5,2)},s.layerAdded=function(e){e.getObjects().forAll((t=>this._layerObjectAdded(e,t)))},s.layerRemoved=function(e){e.getObjects().forAll((t=>this._layerObjectRemoved(e,t)))},s.layerObjectAdded=function(e){this._layerObjectAdded(e.layer,e.object)},s._layerObjectAdded=function(e,t){const o=e.id,r=t.geometryRecords;for(let s=0;s<r.length;s++)this._objectGeometryAdded(t,r[s],o)},s.layerObjectRemoved=function(e){this._layerObjectRemoved(e.layer,e.object)},s.layerObjectsAdded=function(e){for(const t of e.objects)this._layerObjectAdded(e.layer,t)},s.layerObjectsRemoved=function(e){for(const t of e.objects)this._layerObjectRemoved(e.layer,t)},s._layerObjectRemoved=function(e,t){const o=e.id,r=t.geometryRecords;for(let s=0;s<r.length;s++)this._objectGeometryRemoved(t,r[s],o)},s.shaderTransformationChanged=function(e){const t=this._residentGeomRecords.get(e.id);t&&t.forEach(((e,t)=>{const o=this.model.getObject(t);o&&o.hasVolativeTransformation()&&e.forEach((e=>{e[1].shaderTransformationChanged()}))}))},s.objectTransformation=function(e){const t=this._getParentLayerId(e),o=e.id;this._ensureGeomRecord(t,o).forEach((o=>{this._updateOrCreateDirtyRecord(e,o[0],t,2,0,0,2,5,4)}))},s.objectGeometryAdded=function(e){this._objectGeometryAdded(e.object,e.record)},s._objectGeometryAdded=function(e,t,o=null){this._updateOrCreateDirtyRecord(e,t,o,1,4,0,0,0)},s.objectGeometryRemoved=function(e){this._objectGeometryRemoved(e.object,e.record)},s._objectGeometryRemoved=function(e,t,o=null){this._updateOrCreateDirtyRecord(e,t,o,4,1,2,0,0)},s._updateOrCreateDirtyRecord=function(e,t,o,s,d,i,c,n,a){o=r.unwrapOr(o,this._getParentLayerId(e));const l=e.id,u=t.id,h=this._ensureDirtyRecord(o,l),y=h.get(u);if(y){const e=y[1];e&d?(h.delete(u),y[0].disposed&&f.GeometryRecord.pool.release(y[0])):e&i?(y[1]=s,y[2]=a):e&c?y[2]|=a:e&n||m.assert(!1,"ModelDirtySet.objectGeometryAdded: inconsistent state")}else h.set(u,[t,s,a]);this.dirty=this._hasDirtyGeometryRecords},s._ensureGeomRecord=function(e,t){let o=this._residentGeomRecords.get(e);o||(o=new Map,this._residentGeomRecords.set(e,o));let r=o.get(t);return r||(r=new Map,o.set(t,r)),r},s._ensureDirtyRecord=function(e,t){let o=this._dirtyGeomRecords.get(e);o||(o=new Map,this._dirtyGeomRecords.set(e,o));let r=o.get(t);return r||(r=new Map,o.set(t,r)),r},s._getParentLayerId=function(e){return r.isSome(e.parentLayer)?e.parentLayer.id:h.NullUID},s.formatDebugInfo=function(){const e=["ADD","UPD",void 0,"REM"];let t="";return this._dirtyGeomRecords.forEach(((o,r)=>{o.forEach(((o,s)=>{t.length>0&&(t+="\n"),t+=r+"."+s;const d=[];o.forEach((e=>{const t=e[1];d[t]||(d[t]=[]),d[t].push(e[0].geometry.id)}));for(let r=0;r<d.length;r++)if(d[r]){t+=" "+e[r-1]+": ";for(let e=0;e<d[r].length;e++)t+=d[r][e]+", "}}))})),t},e._createClass(o,[{key:"_hasDirtyGeometryRecords",get:function(){return y.someMap(this._dirtyGeomRecords,(e=>y.someMap(e,(e=>e&&e.size>0))))}},{key:"test",get:function(){const e=this;return{get residentLayerCount(){return e._residentGeomRecords.size},get residentObjectCount(){return Array.from(e._residentGeomRecords.values()).reduce(((e,t)=>e+t.size),0)}}}}]),o}(u);return t.__decorate([i.property({constructOnly:!0})],_.prototype,"model",void 0),t.__decorate([i.property()],_.prototype,"dirty",void 0),_=t.__decorate([c.subclass("esri.views.3d.webgl-engine.lib.ModelDirtySet")],_),_}));
