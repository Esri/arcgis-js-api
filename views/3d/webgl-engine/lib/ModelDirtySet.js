/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/MapUtils","../../../../core/maybe","../../../../core/uid","../../../../core/accessorSupport/decorators/property","../../../../core/arrayUtils","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","./GeometryRecord","./ModelDirtyTypes","./Util"],(function(e,t,r,o,i,s,n,d,c,a,y,m,h){"use strict";let l=function(e,t){this.geometryRecord=e,this.renderGeometry=t},u=function(e,t,r){this.operation=e,this.geometryRecord=t,this.states=r},p=function(t){function r(e){var r;return(r=t.call(this,e)||this)._residentGeomRecords=new Map,r._dirtyGeomRecords=new Map,r.dirty=!1,r}e._inheritsLoose(r,t);var n=r.prototype;return n.commit=function(e){this.dirty=!1,this._dirtyGeomRecords.forEach(((t,r)=>this.commitLayer(r,e)))},n.commitLayer=function(e,t){const r=this._dirtyGeomRecords.get(e);r&&(r.forEach(((r,o)=>{const s=this._ensureGeomRecord(e,o);r.forEach((({geometryRecord:e,operation:r,states:n},d)=>{let c=!1;if(r===m.DirtyOperation.UPDATE){const r=s.get(d);if(r){const i=r.renderGeometry;if(n&m.DirtyState.TRANSFORMATION){const t=this.model.getObject(o);this.model.updateRenderGeometryTransformation(t,e,i)&&(c=!0)}c||t.updates.push({renderGeometry:i,updateType:n})}else h.assert(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid update")}if(r===m.DirtyOperation.REMOVE||c){const e=s.get(d);e?(t.removes.push(e.renderGeometry),s.delete(d),e.geometryRecord.disposed&&y.GeometryRecord.pool.release(e.geometryRecord)):r===m.DirtyOperation.REMOVE&&h.assert(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid remove")}if(r===m.DirtyOperation.ADD||c){const r=this.model.getObject(o);if(i.isSome(r)){const o=this.model.getRenderGeometry(r,e),i=new l(e,o);t.adds.push(o),s.set(d,i)}}})),0===s.size&&this._residentGeomRecords.get(e).delete(o)})),0===this._residentGeomRecords.get(e).size&&this._residentGeomRecords.delete(e),this._dirtyGeomRecords.delete(e))},n.getResidentRenderGeometries=function(e,t){const r=this._residentGeomRecords.get(e);r&&r.forEach((e=>e.forEach((e=>t.push(e.renderGeometry)))))},n._objectStateChanged=function(e,t){for(const r of t.geometryRecords)this._updateOrCreateDirtyRecord(t,r,null,m.DirtyOperation.UPDATE,e)},n.visibilityChanged=function(e){this._objectStateChanged(m.DirtyState.VISIBILITIES,e)},n.highlightChanged=function(e){this._objectStateChanged(m.DirtyState.HIGHLIGHTS,e)},n.occlusionChanged=function(e){this._objectStateChanged(m.DirtyState.OCCLUDEES,e)},n.vertexAttrsUpdated=function(e){this._updateOrCreateDirtyRecord(e.object,e.record,null,m.DirtyOperation.UPDATE,m.DirtyState.VERTEXATTRS)},n.layerAdded=function(e){e.objects.forAll((t=>this._layerObjectAdded(e,t)))},n.layerRemoved=function(e){e.objects.forAll((t=>this._layerObjectRemoved(e,t)))},n.layerObjectAdded=function(e){this._layerObjectAdded(e.layer,e.object)},n._layerObjectAdded=function(e,t){const r=e.id;for(const o of t.geometryRecords)this._objectGeometryAdded(t,o,r)},n.layerObjectRemoved=function(e){this._layerObjectRemoved(e.layer,e.object)},n.layerObjectsAdded=function(e){for(const t of e.objects)this._layerObjectAdded(e.layer,t)},n.layerObjectsRemoved=function(e){for(const t of e.objects)this._layerObjectRemoved(e.layer,t)},n._layerObjectRemoved=function(e,t){const r=e.id;for(const o of t.geometryRecords)this._objectGeometryRemoved(t,o,r)},n.shaderTransformationChanged=function(e){const t=this._residentGeomRecords.get(e.id);t&&t.forEach(((e,t)=>{const r=this.model.getObject(t);r&&r.hasVolativeTransformation()&&e.forEach((e=>{e.renderGeometry.shaderTransformationChanged()}))}))},n.objectTransformation=function(e){const t=this._getParentLayerId(e),r=e.id;this._ensureGeomRecord(t,r).forEach((r=>{this._updateOrCreateDirtyRecord(e,r.geometryRecord,t,m.DirtyOperation.UPDATE,m.DirtyState.TRANSFORMATION)}))},n.objectGeometryAdded=function(e){this._objectGeometryAdded(e.object,e.record)},n._objectGeometryAdded=function(e,t,r=null){this._updateOrCreateDirtyRecord(e,t,r,m.DirtyOperation.ADD)},n.objectGeometryRemoved=function(e){this._objectGeometryRemoved(e.object,e.record)},n._objectGeometryRemoved=function(e,t,r=null){this._updateOrCreateDirtyRecord(e,t,r,m.DirtyOperation.REMOVE)},n._updateOrCreateDirtyRecord=function(e,t,r,o,s=m.DirtyState.NONE){r=i.unwrapOr(r,this._getParentLayerId(e));const n=e.id,d=t.id,c=this._ensureDirtyRecord(r,n),a=c.get(d);if(a){const e=a.operation;e===m.DirtyOperation.REMOVE&&o===m.DirtyOperation.ADD&&a.states!==m.DirtyState.NONE?a.operation=m.DirtyOperation.UPDATE:e===m.DirtyOperation.REMOVE&&o===m.DirtyOperation.ADD||e===m.DirtyOperation.ADD&&o===m.DirtyOperation.REMOVE?(c.delete(d),a.geometryRecord.disposed&&y.GeometryRecord.pool.release(a.geometryRecord)):e!==m.DirtyOperation.UPDATE||o!==m.DirtyOperation.REMOVE&&o!==m.DirtyOperation.UPDATE?(h.assert((e===m.DirtyOperation.REMOVE||e===m.DirtyOperation.ADD)&&o===m.DirtyOperation.UPDATE,"ModelDirtySet.objectGeometryAdded: inconsistent state"),a.states|=s):(a.operation=o,a.states|=s)}else c.set(d,new u(o,t,s));this.dirty=this._hasDirtyGeometryRecords},n._ensureGeomRecord=function(e,t){let r=this._residentGeomRecords.get(e);r||(r=new Map,this._residentGeomRecords.set(e,r));let o=r.get(t);return o||(o=new Map,r.set(t,o)),o},n._ensureDirtyRecord=function(e,t){let r=this._dirtyGeomRecords.get(e);r||(r=new Map,this._dirtyGeomRecords.set(e,r));let o=r.get(t);return o||(o=new Map,r.set(t,o)),o},n._getParentLayerId=function(e){return i.isSome(e.parentLayer)?e.parentLayer.id:s.NullUID},n.formatDebugInfo=function(){const e=["ADD","UPD",void 0,"REM"];let t="";return this._dirtyGeomRecords.forEach(((r,o)=>{r.forEach(((r,i)=>{t.length>0&&(t+="\n"),t+=o+"."+i;const s=[];r.forEach((e=>{const t=e.operation;s[t]||(s[t]=[]),s[t].push(e.geometryRecord.geometry.id)}));for(let o=0;o<s.length;o++)if(s[o]){t+=" "+e[o-1]+": ";for(let e=0;e<s[o].length;e++)t+=s[o][e]+", "}}))})),t},e._createClass(r,[{key:"_hasDirtyGeometryRecords",get:function(){return o.someMap(this._dirtyGeomRecords,(e=>o.someMap(e,(e=>e&&e.size>0))))}},{key:"test",get:function(){const e=this;return{get residentLayerCount(){return e._residentGeomRecords.size},get residentObjectCount(){return Array.from(e._residentGeomRecords.values()).reduce(((e,t)=>e+t.size),0)}}}}]),r}(r);t.__decorate([n.property({constructOnly:!0})],p.prototype,"model",void 0),t.__decorate([n.property()],p.prototype,"dirty",void 0),p=t.__decorate([a.subclass("esri.views.3d.webgl-engine.lib.ModelDirtySet")],p);return p}));
