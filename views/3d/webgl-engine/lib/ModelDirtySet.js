/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/MapUtils","../../../../core/maybe","../../../../core/uid","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/accessorSupport/decorators/subclass","./ModelDirtyTypes","./Util"],(function(e,t,r,o,i,s,n,d,c,a,y,h){"use strict";let l=function(e,t,r){this.operation=e,this.geometry=t,this.states=r},u=function(t){function r(e){var r;return(r=t.call(this,e)||this)._residentGeomRecords=new Map,r._dirtyGeomRecords=new Map,r.dirty=!1,r}e._inheritsLoose(r,t);var n=r.prototype;return n.commitLayer=function(e,t){const r=this._dirtyGeomRecords.get(e);r&&(r.forEach(((r,o)=>{const s=this._ensureGeomRecord(e,o);r.forEach((({geometry:e,operation:r,states:n},d)=>{let c=!1;if(r===y.DirtyOperation.UPDATE){const r=s.get(d);if(r){if(n&y.DirtyState.TRANSFORMATION){const t=this.model.getObject(o);this.model.updateRenderGeometryTransformation(t,e,r)&&(c=!0)}c||t.updates.push({renderGeometry:r,updateType:n})}else h.assert(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid update")}if(r===y.DirtyOperation.REMOVE||c){const e=s.get(d);e?(t.removes.push(e),s.delete(d)):r===y.DirtyOperation.REMOVE&&h.assert(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid remove")}if(r===y.DirtyOperation.ADD||c){const r=this.model.getObject(o);if(i.isSome(r)){const o=this.model.getRenderGeometry(r,e);t.adds.push(o),s.set(d,o)}}})),0===s.size&&this._residentGeomRecords.get(e).delete(o)})),0===this._residentGeomRecords.get(e).size&&this._residentGeomRecords.delete(e),this._dirtyGeomRecords.delete(e),this.dirty=this._hasDirtyGeometryRecords)},n.getResidentRenderGeometries=function(e,t){const r=this._residentGeomRecords.get(e);r&&r.forEach((e=>e.forEach((e=>t.push(e)))))},n._objectStateChanged=function(e,t){for(const r of t.geometries)this._updateOrCreateDirtyRecord(t,r,null,y.DirtyOperation.UPDATE,e)},n.visibilityChanged=function(e){this._objectStateChanged(y.DirtyState.VISIBILITY,e)},n.highlightChanged=function(e){this._objectStateChanged(y.DirtyState.HIGHLIGHT,e)},n.occlusionChanged=function(e){this._objectStateChanged(y.DirtyState.OCCLUDEE,e)},n.objectGeometryUpdated=function(e){this._updateOrCreateDirtyRecord(e.object,e.geometry,null,y.DirtyOperation.UPDATE,y.DirtyState.GEOMETRY)},n.layerAdded=function(e){e.objects.forAll((t=>this._layerObjectAdded(e,t)))},n.layerRemoved=function(e){e.objects.forAll((t=>this._layerObjectRemoved(e,t)))},n.layerObjectAdded=function(e){this._layerObjectAdded(e.layer,e.object)},n._layerObjectAdded=function(e,t){const r=e.id;for(const o of t.geometries)this._objectGeometryAdded(t,o,r)},n.layerObjectRemoved=function(e){this._layerObjectRemoved(e.layer,e.object)},n.layerObjectsAdded=function(e){for(const t of e.objects)this._layerObjectAdded(e.layer,t)},n.layerObjectsRemoved=function(e){for(const t of e.objects)this._layerObjectRemoved(e.layer,t)},n._layerObjectRemoved=function(e,t){const r=e.id;for(const o of t.geometries)this._objectGeometryRemoved(t,o,r)},n.shaderTransformationChanged=function(e){const t=this._residentGeomRecords.get(e.id);t&&t.forEach(((e,t)=>{const r=this.model.getObject(t);r&&r.hasVolativeTransformation()&&e.forEach((e=>e.shaderTransformationChanged()))}))},n.objectTransformation=function(e){const t=this._getParentLayerId(e),r=e.id;this._ensureGeomRecord(t,r).forEach((r=>{this._updateOrCreateDirtyRecord(e,r.geometry,t,y.DirtyOperation.UPDATE,y.DirtyState.TRANSFORMATION)}))},n.objectGeometryAdded=function(e){this._objectGeometryAdded(e.object,e.geometry)},n._objectGeometryAdded=function(e,t,r=null){this._updateOrCreateDirtyRecord(e,t,r,y.DirtyOperation.ADD)},n.objectGeometryRemoved=function(e){this._objectGeometryRemoved(e.object,e.geometry)},n._objectGeometryRemoved=function(e,t,r=null){this._updateOrCreateDirtyRecord(e,t,r,y.DirtyOperation.REMOVE)},n._updateOrCreateDirtyRecord=function(e,t,r,o,s=y.DirtyState.NONE){r=i.unwrapOr(r,this._getParentLayerId(e));const n=e.id,d=t.id,c=this._ensureDirtyRecord(r,n),a=c.get(d);if(a){const e=a.operation;e===y.DirtyOperation.REMOVE&&o===y.DirtyOperation.ADD&&a.states!==y.DirtyState.NONE?a.operation=y.DirtyOperation.UPDATE:e===y.DirtyOperation.REMOVE&&o===y.DirtyOperation.ADD||e===y.DirtyOperation.ADD&&o===y.DirtyOperation.REMOVE?c.delete(d):e!==y.DirtyOperation.UPDATE||o!==y.DirtyOperation.REMOVE&&o!==y.DirtyOperation.UPDATE?(h.assert((e===y.DirtyOperation.REMOVE||e===y.DirtyOperation.ADD)&&o===y.DirtyOperation.UPDATE,"ModelDirtySet.objectGeometryAdded: inconsistent state"),a.states|=s):(a.operation=o,a.states|=s)}else c.set(d,new l(o,t,s));this.dirty=this._hasDirtyGeometryRecords},n._ensureGeomRecord=function(e,t){let r=this._residentGeomRecords.get(e);r||(r=new Map,this._residentGeomRecords.set(e,r));let o=r.get(t);return o||(o=new Map,r.set(t,o)),o},n._ensureDirtyRecord=function(e,t){let r=this._dirtyGeomRecords.get(e);r||(r=new Map,this._dirtyGeomRecords.set(e,r));let o=r.get(t);return o||(o=new Map,r.set(t,o)),o},n._getParentLayerId=function(e){return i.isSome(e.parentLayer)?e.parentLayer.id:s.NullUID},n.formatDebugInfo=function(){const e=["ADD","UPD",void 0,"REM"];let t="";return this._dirtyGeomRecords.forEach(((r,o)=>{r.forEach(((r,i)=>{t.length>0&&(t+="\n"),t+=o+"."+i;const s=[];r.forEach((e=>{const t=e.operation;s[t]||(s[t]=[]),s[t].push(e.geometry.id)}));for(let o=0;o<s.length;o++)if(s[o]){t+=" "+e[o-1]+": ";for(let e=0;e<s[o].length;e++)t+=s[o][e]+", "}}))})),t},e._createClass(r,[{key:"_hasDirtyGeometryRecords",get:function(){return o.someMap(this._dirtyGeomRecords,(e=>o.someMap(e,(e=>e&&e.size>0))))}},{key:"test",get:function(){const e=this;return{get residentLayerCount(){return e._residentGeomRecords.size},get residentObjectCount(){return Array.from(e._residentGeomRecords.values()).reduce(((e,t)=>e+t.size),0)},commit:t=>e._dirtyGeomRecords.forEach(((r,o)=>e.commitLayer(o,t)))}}}]),r}(r);t.__decorate([n.property({constructOnly:!0})],u.prototype,"model",void 0),t.__decorate([n.property()],u.prototype,"dirty",void 0),u=t.__decorate([a.subclass("esri.views.3d.webgl-engine.lib.ModelDirtySet")],u);return u}));
