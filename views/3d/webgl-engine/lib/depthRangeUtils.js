/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/PooledArray","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec3","../../../../chunks/vec4","../../../../chunks/vec4f64","../../../../geometry/support/frustum","../../../../chunks/sphere","../../support/mathUtils","./depthRange","./Util"],(function(e,t,n,r,i,a,s,o,h,f,c,u,l,d){"use strict";const g=1e4,m=100,p=500,b=500,v=.1;function w(e,t,n){return d.unpackFloatRGBA(t,e)*(n[1]-n[0])+n[0]}function R(e,t,n){if(t.size<g)return F.compute(e,t);const r=l.empty();return n.forAll((t=>{t.isVisible&&l.union(r,y(e,t))})),r}function y(e,t){if(!t.isVisible)return;const r=l.empty(),i=t.getSpatialQueryAccelerator();return n.isSome(i)?B(r,e,i):M(r,e,t.objects),r}function B(e,t,n){const r=t.eye,i=t.viewForward,a=t.frustum,s=e=>e.isVisible,o=n.objectCount;if(o<p)l.set(k,t.near,Math.min(e.near,t.far)),n.forEachInDepthRange(r,i,1,k,((n,r)=>{C(e,t,n),k.far=e.near,r.setRange(k)}),a,s),l.set(k,Math.max(e.far,t.near),t.far),n.forEachInDepthRange(r,i,-1,k,((n,r)=>{C(e,t,n),k.near=e.far,r.setRange(k)}),a,s);else{const r=Math.max(Math.min(o,b),Math.ceil(o*v)),h=n.findClosest(i,1,a,s,r),f=n.findClosest(i,-1,a,s,r);h&&f&&(A(e,t,h.boundingVolumeWorldSpace.bounds),A(e,t,f.boundingVolumeWorldSpace.bounds))}}function M(e,t,n){D.clear(),n.forAll((e=>{e.isVisible&&0!==e.getNumGeometryRecords()&&D.add(e)})),D.empty||(D.sort(t),l.set(k,t.near,Math.min(e.near,t.far)),D.forEachInDepthRange(k,1,((n,r)=>{r<e.near&&C(e,t,n)})),l.set(k,Math.max(e.far,t.near),t.far),D.forEachInDepthRange(k,-1,((t,n,r)=>{e.far=Math.max(e.far,r)})))}function C(e,t,n){if(!n.isVisible)return;if(!f.intersectsSphere(t.frustum,n.boundingVolumeWorldSpace.bounds))return;const r=n.transformation,a=V;n.geometryRecords.forEach((n=>{i.multiply(a,r,n.getShaderTransformation());const s=u.maxScale(a);S(e,t,n.geometry.boundingInfo,a,s)}))}function S(e,t,r,i,a){if(n.isNone(r))return;const o=t.eye,h=t.viewForward;s.transformMat4(I,r.center,i);const c=h[0]*(I[0]-o[0])+h[1]*(I[1]-o[1])+h[2]*(I[2]-o[2]);if(I[3]=r.radius*a,!(c-I[3]>e.near&&c+I[3]<e.far)&&f.intersectsSphere(t.frustum,I))if(r.radius>m&&r.getChildren()){const n=r.getChildren();for(let r=0;r<8;++r)n[r]&&S(e,t,n[r],i,a)}else N.unionDepthRangeWithAABB(e,t.viewProjectionMatrix,i,r.bbMin,r.bbMax)}function A(e,t,n){const r=t.eye,i=t.viewForward,a=(n[0]-r[0])*i[0]+(n[1]-r[1])*i[1]+(n[2]-r[2])*i[2];e.near=Math.min(e.near,a-n[3]),e.far=Math.max(e.far,a+n[3])}let j=function(){function e(){this._items=new r({allocator:e=>e||{obj:null,distance:0,near:0,far:0},deallocator:e=>(e.obj=null,e.distance=0,e.near=0,e.far=0,e)})}var n=e.prototype;return n.clear=function(){this._items.clear()},n.add=function(e){this._items.pushNew().obj=e},n.sort=function(e){const t=e.eye,n=e.viewForward;this._items.forAll((e=>{const r=e.obj.boundingVolumeWorldSpace.bounds,i=(r[0]-t[0])*n[0]+(r[1]-t[1])*n[1]+(r[2]-t[2])*n[2];e.distance=i,e.near=i-r[3],e.far=i+r[3]})),this._items.sort(((e,t)=>e.distance-t.distance))},n.forEachInDepthRange=function(e,t,n){if(1===t)for(let r=0;r<this._items.length;++r){const t=this._items.data[r];t.far<e.near||t.near>e.far||n(t.obj,t.near,t.far)}else for(let r=this._items.length-1;r>=0;--r){const t=this._items.data[r];t.far<e.near||t.near>e.far||n(t.obj,t.near,t.far)}},t._createClass(e,[{key:"length",get:function(){return this._items.length}},{key:"empty",get:function(){return 0===this._items.length}}]),e}(),x=function(){function e(){this.view=a.create(),this.viewProj=a.create(),this.frustum=f.create(),this.geometries=[],this.near=[],this.far=[],this.nearCandidates=[],this.farCandidates=[],this.range={near:0,far:0},this.looseRange={near:0,far:0}}var t=e.prototype;return t.compute=function(e,t){this.reset(),i.copy(this.view,e.viewMatrix),i.multiply(this.viewProj,e.projectionMatrix,this.view),f.copy(e.frustum,this.frustum);const n=this.view,r=n[2],a=n[6],s=n[10],o=n[14],h=this.range;let c=0;if(t.forEach((e=>{if(!e.instanceParameters.visible)return;if(!e.castShadow)return;let t;e.hasShaderTransformation?(e.computeBoundingSphere(e.getShaderTransformation(),I,1),t=I):t=e.boundingSphere;const n=r*t[0]+a*t[1]+s*t[2]+o,i=n-t[3],h=n+t[3];this.geometries[c]=e,this.near[c]=-h,this.far[c]=-i,++c})),0===this.geometries.length)return h;for(let i=0;i<this.geometries.length;++i)this.near[i]>h.far&&(h.far=this.near[i]),this.near[i]>2&&this.far[i]<h.near&&(h.near=this.far[i]);const u=this.looseRange;u.near=Math.max(.5*h.near,2),u.far=2*h.far;let l=0,d=0;for(let i=0;i<this.geometries.length;++i)this.near[i]<h.near&&(this.near[i]>=u.near?h.near=this.near[i]:this.nearCandidates[l++]=i),this.far[i]>h.far&&(this.far[i]<=u.far?h.far=this.far[i]:this.farCandidates[d++]=i);if(0===this.nearCandidates.length&&0===this.farCandidates.length)return h;this.nearCandidates.sort(((e,t)=>this.near[e]<this.near[t]?-1:this.near[e]>this.near[t]?1:0)),this.farCandidates.sort(((e,t)=>this.far[e]<this.far[t]?1:this.far[e]>this.far[t]?-1:0));for(let i=0;i<this.nearCandidates.length;++i){const e=this.nearCandidates[i];if(this.near[e]<h.near){const t=this.geometries[e],n=t.boundingInfo;this.includeNearBoundingInfoRec(n,t.getShaderTransformation())}}for(let i=0;i<this.farCandidates.length;++i){const e=this.farCandidates[i];if(this.far[e]>h.far){const t=this.geometries[e],n=t.boundingInfo;this.includeFarBoundingInfoRec(n,t.getShaderTransformation())}}return h},t.reset=function(){this.geometries.length=0,this.near.length=0,this.far.length=0,this.nearCandidates.length=0,this.farCandidates.length=0,this.range.near=Number.MAX_VALUE,this.range.far=-Number.MAX_VALUE},t.includeNearBoundingInfoRec=function(e,t){if(n.isNone(e))return;const r=e.getCenter();s.transformMat4(I,r,t);const i=u.maxScale(t),a=I[0],o=I[1],h=I[2],f=e.getBSRadius()*i,c=this.frustum;if(c[0][0]*a+c[0][1]*o+c[0][2]*h+c[0][3]>f||c[1][0]*a+c[1][1]*o+c[1][2]*h+c[1][3]>f||c[2][0]*a+c[2][1]*o+c[2][2]*h+c[2][3]>f||c[3][0]*a+c[3][1]*o+c[3][2]*h+c[3][3]>f)return;const l=this.view[2]*a+this.view[6]*o+this.view[10]*h+this.view[14],d=l+f;if(!(-(l-f)<2||-d>=this.range.near))if(-d>this.looseRange.near)this.range.near=-d;else{if(f>m){const n=e.getChildren();if(void 0!==n){for(let e=0;e<8;++e)void 0!==n[e]&&this.includeNearBoundingInfoRec(n[e],t);return}}N.unionDepthRangeWithAABB(this.range,this.viewProj,t,e.getBBMin(),e.getBBMax())}},t.includeFarBoundingInfoRec=function(e,t){if(n.isNone(e))return;let r=e.getBSRadius();const i=e.getCenter();s.transformMat4(I,i,t);const a=u.maxScale(t),o=I[0],h=I[1],f=I[2];r*=a;const c=this.frustum;if(c[0][0]*o+c[0][1]*h+c[0][2]*f+c[0][3]>r||c[1][0]*o+c[1][1]*h+c[1][2]*f+c[1][3]>r||c[2][0]*o+c[2][1]*h+c[2][2]*f+c[2][3]>r||c[3][0]*o+c[3][1]*h+c[3][2]*f+c[3][3]>r)return;const l=this.view[2]*o+this.view[6]*h+this.view[10]*f+this.view[14]-r;if(!(-l<=this.range.far))if(-l<this.looseRange.far)this.range.far=-l;else{if(r>m){const n=e.getChildren();if(void 0!==n){for(let e=0;e<8;++e)void 0!==n[e]&&this.includeFarBoundingInfoRec(n[e],t);return}}N.unionDepthRangeWithAABB(this.range,this.viewProj,t,e.getBBMin(),e.getBBMax())}},e}(),_=function(){function e(){this.modelViewProj=a.create(),this.clipPosition=[h.create(),h.create(),h.create(),h.create(),h.create(),h.create(),h.create(),h.create()]}var t=e.prototype;return t.unionDepthRangeWithAABB=function(e,t,n,r,a){const s=this.modelViewProj;i.multiply(s,t,n);let o=!1;for(let i=0;i<8;++i){const e=this.clipPosition[i],t=0===i||3===i||4===i||7===i?r[0]:a[0],n=0===i||1===i||4===i||5===i?r[1]:a[1],o=i<4?r[2]:a[2];e[0]=s[0]*t+s[4]*n+s[8]*o+s[12],e[1]=s[1]*t+s[5]*n+s[9]*o+s[13],e[2]=s[2]*t+s[6]*n+s[10]*o+s[14],e[3]=s[3]*t+s[7]*n+s[11]*o+s[15]}for(let i=0;i<12;++i){const t=this.clipPosition[P[i][0]],n=this.clipPosition[P[i][1]],r=this.clipPosition[P[i][2]],a=this.clipTriangle(t,n,r);let s=!0;for(let e=0;e<a.length;++e){if(a[e][3]>=2){s=!1;break}}if(!s){o=!0;for(let t=0;t<a.length;++t){const n=a[t][3];n<e.near&&(e.near=n),n>e.far&&(e.far=n)}}}return o},t.inside=function(e,t){return 0===t?e[0]>=-e[3]:1===t?e[1]>=-e[3]:2===t?e[0]<=e[3]:3===t?e[1]<=e[3]:void d.assert(!1)},t.intersect=function(e,t,n){let r=0;return 0===n?r=(-e[3]-e[0])/(t[0]-e[0]+t[3]-e[3]):1===n?r=(-e[3]-e[1])/(t[1]-e[1]+t[3]-e[3]):2===n?r=(e[3]-e[0])/(t[0]-e[0]-t[3]+e[3]):3===n&&(r=(e[3]-e[1])/(t[1]-e[1]-t[3]+e[3])),o.lerp(h.create(),e,t,r)},t.clipTriangle=function(e,t,n){let r=[e,t,n];for(let i=0;i<4;++i){const e=r;r=[];for(let t=0;t<e.length;++t){const n=e[t],a=e[(t+1)%e.length];this.inside(a,i)?(this.inside(n,i)||r.push(this.intersect(n,a,i)),r.push(a)):this.inside(n,i)&&r.push(this.intersect(n,a,i))}}return r},e}();const P=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],I=c.create(),V=a.create(),k=l.empty(),D=new j,F=new x,N=new _;e.DepthRangeFromRenderGeometries=x,e.depthRangeFromLayer=y,e.depthRangeFromScene=R,e.textureToDepth=w,Object.defineProperty(e,"__esModule",{value:!0})}));
