/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/floatRGBA","../../../../core/maybe","../../../../core/PooledArray","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec3","../../../../chunks/vec4","../../../../chunks/vec4f64","../../../../geometry/support/frustum","../../../../chunks/sphere","../../support/mathUtils","./depthRange","./Octree","./Util"],(function(e,t,n,r,i,a,s,o,h,f,c,u,l,_,d,g){"use strict";const m=1e4,p=100,R=500,b=500,v=.1;function B(e,t,r){return n.unpackFloatRGBA(t,e)*(r[1]-r[0])+r[0]}function w(e,t,n){if(t.size<m)return V.compute(e,t);const r=_.empty();return n.forAll((t=>{t.isVisible&&_.union(r,C(e,t))})),r}function C(e,t){if(!t.isVisible)return;const n=_.empty(),i=t.getSpatialQueryAccelerator();return r.isSome(i)?M(n,e,i):y(n,e,t.objects),n}function M(e,t,n){const r=t.eye,i=t.viewForward,a=t.frustum,s=e=>e.isVisible,o=n.objectCount;if(o<R)_.set(P,t.near,Math.min(e.near,t.far)),n.forEachInDepthRange(r,i,d.DepthOrder.FRONT_TO_BACK,P,((n,r)=>{A(e,t,n),P.far=e.near,r.setRange(P)}),a,s),_.set(P,Math.max(e.far,t.near),t.far),n.forEachInDepthRange(r,i,d.DepthOrder.BACK_TO_FRONT,P,((n,r)=>{A(e,t,n),P.near=e.far,r.setRange(P)}),a,s);else{const r=Math.max(Math.min(o,b),Math.ceil(o*v)),h=n.findClosest(i,d.DepthOrder.FRONT_TO_BACK,a,s,r),f=n.findClosest(i,d.DepthOrder.BACK_TO_FRONT,a,s,r);h&&f&&(O(e,t,h.boundingVolumeWorldSpace.bounds),O(e,t,f.boundingVolumeWorldSpace.bounds))}}function y(e,t,n){I.clear(),n.forAll((e=>{e.isVisible&&0!==e.geometryRecords.length&&I.add(e)})),I.empty||(I.sort(t),_.set(P,t.near,Math.min(e.near,t.far)),I.forEachInDepthRange(P,d.DepthOrder.FRONT_TO_BACK,((n,r)=>{r<e.near&&A(e,t,n)})),_.set(P,Math.max(e.far,t.near),t.far),I.forEachInDepthRange(P,d.DepthOrder.BACK_TO_FRONT,((t,n,r)=>{e.far=Math.max(e.far,r)})))}function A(e,t,n){if(!n.isVisible)return;if(!c.intersectsSphere(t.frustum,n.boundingVolumeWorldSpace.bounds))return;const r=n.transformation,i=N;n.geometryRecords.forEach((n=>{a.multiply(i,r,n.getShaderTransformation());const s=l.maxScale(i);S(e,t,n.geometry.boundingInfo,i,s)}))}function S(e,t,n,i,a){if(r.isNone(n))return;o.transformMat4(j,n.center,i);const{eye:s,viewForward:h}=t,f=h[0]*(j[0]-s[0])+h[1]*(j[1]-s[1])+h[2]*(j[2]-s[2]);if(j[3]=n.radius*a,!(f-j[3]>e.near&&f+j[3]<e.far)&&c.intersectsSphere(t.frustum,j))if(n.radius>p&&n.getChildren()){const r=n.getChildren();for(let n=0;n<8;++n)r[n]&&S(e,t,r[n],i,a)}else k.unionDepthRangeWithAABB(e,t.viewProjectionMatrix,i,n.bbMin,n.bbMax)}function O(e,t,n){const r=t.eye,i=t.viewForward,a=(n[0]-r[0])*i[0]+(n[1]-r[1])*i[1]+(n[2]-r[2])*i[2];e.near=Math.min(e.near,a-n[3]),e.far=Math.max(e.far,a+n[3])}let T=function(){function e(){this._items=new i({allocator:e=>e||{obj:null,distance:0,near:0,far:0},deallocator:e=>(e.obj=null,e.distance=0,e.near=0,e.far=0,e)})}var n=e.prototype;return n.clear=function(){this._items.clear()},n.add=function(e){this._items.pushNew().obj=e},n.sort=function(e){const t=e.eye,n=e.viewForward;this._items.forAll((e=>{const r=e.obj.boundingVolumeWorldSpace.bounds,i=(r[0]-t[0])*n[0]+(r[1]-t[1])*n[1]+(r[2]-t[2])*n[2];e.distance=i,e.near=i-r[3],e.far=i+r[3]})),this._items.sort(((e,t)=>e.distance-t.distance))},n.forEachInDepthRange=function(e,t,n){if(t===d.DepthOrder.FRONT_TO_BACK)for(let r=0;r<this._items.length;++r){const t=this._items.data[r];t.far<e.near||t.near>e.far||n(t.obj,t.near,t.far)}else for(let r=this._items.length-1;r>=0;--r){const t=this._items.data[r];t.far<e.near||t.near>e.far||n(t.obj,t.near,t.far)}},t._createClass(e,[{key:"length",get:function(){return this._items.length}},{key:"empty",get:function(){return 0===this._items.length}}]),e}(),F=function(){function e(){this._view=s.create(),this._viewProj=s.create(),this._frustum=c.create(),this._geometries=[],this._near=[],this._far=[],this._nearCandidates=[],this._farCandidates=[],this._range={near:0,far:0},this._looseRange={near:0,far:0}}var t=e.prototype;return t.compute=function(e,t){this._reset(),a.copy(this._view,e.viewMatrix),a.multiply(this._viewProj,e.projectionMatrix,this._view),c.copy(this._frustum,e.frustum);const n=this._view,r=n[2],i=n[6],s=n[10],o=n[14],h=this._range;let f=0;if(t.forEach((e=>{if(!e.instanceParameters.visible)return;if(!e.castShadow)return;let t;e.hasShaderTransformation?(e.computeBoundingSphere(e.getShaderTransformation(),j,1),t=j):t=e.boundingSphere;const n=r*t[0]+i*t[1]+s*t[2]+o,a=n-t[3],h=n+t[3];this._geometries[f]=e,this._near[f]=-h,this._far[f]=-a,++f})),0===this._geometries.length)return h;for(let a=0;a<this._geometries.length;++a)this._near[a]>h.far&&(h.far=this._near[a]),this._near[a]>2&&this._far[a]<h.near&&(h.near=this._far[a]);const u=this._looseRange;u.near=Math.max(.5*h.near,2),u.far=2*h.far;let l=0,_=0;for(let a=0;a<this._geometries.length;++a)this._near[a]<h.near&&(this._near[a]>=u.near?h.near=this._near[a]:this._nearCandidates[l++]=a),this._far[a]>h.far&&(this._far[a]<=u.far?h.far=this._far[a]:this._farCandidates[_++]=a);if(0===this._nearCandidates.length&&0===this._farCandidates.length)return h;this._nearCandidates.sort(((e,t)=>this._near[e]<this._near[t]?-1:this._near[e]>this._near[t]?1:0)),this._farCandidates.sort(((e,t)=>this._far[e]<this._far[t]?1:this._far[e]>this._far[t]?-1:0));for(let a=0;a<this._nearCandidates.length;++a){const e=this._nearCandidates[a];if(this._near[e]<h.near){const t=this._geometries[e],n=t.boundingInfo;this._includeNearBoundingInfoRec(n,t.getShaderTransformation())}}for(let a=0;a<this._farCandidates.length;++a){const e=this._farCandidates[a];if(this._far[e]>h.far){const t=this._geometries[e],n=t.boundingInfo;this._includeFarBoundingInfoRec(n,t.getShaderTransformation())}}return h},t._reset=function(){this._geometries.length=0,this._near.length=0,this._far.length=0,this._nearCandidates.length=0,this._farCandidates.length=0,this._range.near=Number.MAX_VALUE,this._range.far=-Number.MAX_VALUE},t._includeNearBoundingInfoRec=function(e,t){if(r.isNone(e))return;const n=e.getCenter();o.transformMat4(j,n,t);const i=l.maxScale(t),a=j[0],s=j[1],h=j[2],f=e.getBSRadius()*i,c=this._frustum;if(c[0][0]*a+c[0][1]*s+c[0][2]*h+c[0][3]>f||c[1][0]*a+c[1][1]*s+c[1][2]*h+c[1][3]>f||c[2][0]*a+c[2][1]*s+c[2][2]*h+c[2][3]>f||c[3][0]*a+c[3][1]*s+c[3][2]*h+c[3][3]>f)return;const u=this._view[2]*a+this._view[6]*s+this._view[10]*h+this._view[14],_=u+f;if(!(-(u-f)<2||-_>=this._range.near))if(-_>this._looseRange.near)this._range.near=-_;else{if(f>p){const n=e.getChildren();if(void 0!==n){for(let e=0;e<8;++e)void 0!==n[e]&&this._includeNearBoundingInfoRec(n[e],t);return}}k.unionDepthRangeWithAABB(this._range,this._viewProj,t,e.getBBMin(),e.getBBMax())}},t._includeFarBoundingInfoRec=function(e,t){if(r.isNone(e))return;let n=e.getBSRadius();const i=e.getCenter();o.transformMat4(j,i,t);const a=l.maxScale(t),s=j[0],h=j[1],f=j[2];n*=a;const c=this._frustum;if(c[0][0]*s+c[0][1]*h+c[0][2]*f+c[0][3]>n||c[1][0]*s+c[1][1]*h+c[1][2]*f+c[1][3]>n||c[2][0]*s+c[2][1]*h+c[2][2]*f+c[2][3]>n||c[3][0]*s+c[3][1]*h+c[3][2]*f+c[3][3]>n)return;const u=this._view[2]*s+this._view[6]*h+this._view[10]*f+this._view[14]-n;if(!(-u<=this._range.far))if(-u<this._looseRange.far)this._range.far=-u;else{if(n>p){const n=e.getChildren();if(void 0!==n){for(let e=0;e<8;++e)void 0!==n[e]&&this._includeFarBoundingInfoRec(n[e],t);return}}k.unionDepthRangeWithAABB(this._range,this._viewProj,t,e.getBBMin(),e.getBBMax())}},e}(),x=function(){function e(){this._modelViewProj=s.create(),this._clipPosition=[f.create(),f.create(),f.create(),f.create(),f.create(),f.create(),f.create(),f.create()]}var t=e.prototype;return t.unionDepthRangeWithAABB=function(e,t,n,r,i){const s=this._modelViewProj;a.multiply(s,t,n);let o=!1;for(let a=0;a<8;++a){const e=this._clipPosition[a],t=0===a||3===a||4===a||7===a?r[0]:i[0],n=0===a||1===a||4===a||5===a?r[1]:i[1],o=a<4?r[2]:i[2];e[0]=s[0]*t+s[4]*n+s[8]*o+s[12],e[1]=s[1]*t+s[5]*n+s[9]*o+s[13],e[2]=s[2]*t+s[6]*n+s[10]*o+s[14],e[3]=s[3]*t+s[7]*n+s[11]*o+s[15]}for(let a=0;a<12;++a){const t=this._clipPosition[D[a][0]],n=this._clipPosition[D[a][1]],r=this._clipPosition[D[a][2]],i=this._clipTriangle(t,n,r);let s=!0;for(let e=0;e<i.length;++e){if(i[e][3]>=2){s=!1;break}}if(!s){o=!0;for(let t=0;t<i.length;++t){const n=i[t][3];Number.isFinite(n)&&(e.near=Math.min(n,e.near),e.far=Math.max(n,e.far))}}}return o},t._inside=function(e,t){return 0===t?e[0]>=-e[3]:1===t?e[1]>=-e[3]:2===t?e[0]<=e[3]:3===t?e[1]<=e[3]:void g.assert(!1)},t._intersect=function(e,t,n){let r=0;return 0===n?r=(-e[3]-e[0])/(t[0]-e[0]+t[3]-e[3]):1===n?r=(-e[3]-e[1])/(t[1]-e[1]+t[3]-e[3]):2===n?r=(e[3]-e[0])/(t[0]-e[0]-t[3]+e[3]):3===n&&(r=(e[3]-e[1])/(t[1]-e[1]-t[3]+e[3])),h.lerp(f.create(),e,t,r)},t._clipTriangle=function(e,t,n){let r=[e,t,n];for(let i=0;i<4;++i){const e=r;r=[];for(let t=0;t<e.length;++t){const n=e[t],a=e[(t+1)%e.length];this._inside(a,i)?(this._inside(n,i)||r.push(this._intersect(n,a,i)),r.push(a)):this._inside(n,i)&&r.push(this._intersect(n,a,i))}}return r},e}();const D=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],j=u.create(),N=s.create(),P=_.empty(),I=new T,V=new F,k=new x;e.DepthRangeFromRenderGeometries=F,e.depthRangeFromLayer=C,e.depthRangeFromScene=w,e.textureToDepth=B,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
