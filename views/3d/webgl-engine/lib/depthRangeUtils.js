/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/PooledArray","../../../../chunks/vec3f64","../../../../chunks/vec3","../../support/mathUtils","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec4f64","../../../../chunks/vec4","../../support/geometryUtils","./Util","./depthRange"],(function(e,t,n,r,i,a,s,o,h,f,c,u,l){"use strict";function g(e,t){if(!t.isVisible)return;const n=l.empty(),r=t.getObjects();return t.getSpatialQueryAccelerator()?function(e,t,n){const r=t.eye,i=t.viewForward,a=t.frustum,s=e=>e.isVisible,o=n.objectCount;if(o<500)l.set(y,t.near,Math.min(e.near,t.far)),n.forEachInDepthRange(r,i,"front-to-back",y,((n,r)=>{d(e,t,n),y.far=e.near,r.setRange(y)}),a,s),l.set(y,Math.max(e.far,t.near),t.far),n.forEachInDepthRange(r,i,"back-to-front",y,((n,r)=>{d(e,t,n),y.near=e.far,r.setRange(y)}),a,s);else{const r=Math.max(Math.min(o,500),Math.ceil(.1*o)),h=n.findClosest(i,"front-to-back",a,s,r),f=n.findClosest(i,"back-to-front",a,s,r);h&&f&&(p(e,t,h.getCenter(),h.getBSRadius()),p(e,t,f.getCenter(),f.getBSRadius()))}}(n,e,t.getSpatialQueryAccelerator()):function(e,t,n){if(M.clear(),n.forEach((e=>{e.isVisible&&M.add(e)})),M.empty)return;M.sort(t),l.set(y,t.near,Math.min(e.near,t.far)),M.forEachInDepthRange(y,"front-to-back",((n,r)=>{r<e.near&&d(e,t,n)})),l.set(y,Math.max(e.far,t.near),t.far),M.forEachInDepthRange(y,"back-to-front",((t,n,r)=>{e.far=Math.max(e.far,r)}))}(n,e,r),n}function d(e,t,n){if(!n.isVisible)return;if(!c.frustum.intersectsSphere(t.frustum.planes,c.sphere.wrap(n.getBSRadius(),n.getCenter())))return;const r=n.objectTransformation,i=C;n.geometryRecords.forEach((n=>{s.multiply(i,r,n.getShaderTransformation());const o=a.maxScale(i);m(e,t,n.geometry.boundingInfo,i,o)}))}function m(e,t,n,r,a){const s=t.eye,o=t.viewForward;i.transformMat4(B,n.center,r);const h=o[0]*(B[0]-s[0])+o[1]*(B[1]-s[1])+o[2]*(B[2]-s[2]),f=n.bsRadius*a;if(!(h-f>e.near&&h+f<e.far)&&c.frustum.intersectsSphere(t.frustum.planes,c.sphere.wrap(f,B)))if(n.bsRadius>100&&n.getChildren()){const i=n.getChildren();for(let n=0;n<8;++n)i[n]&&m(e,t,i[n],r,a)}else j.unionDepthRangeWithAABB(e,t.viewProjectionMatrix,r,n.bbMin,n.bbMax)}function p(e,t,n,r){const i=t.eye,a=t.viewForward,s=(n[0]-i[0])*a[0]+(n[1]-i[1])*a[1]+(n[2]-i[2])*a[2];e.near=Math.min(e.near,s-r),e.far=Math.max(e.far,s+r)}let b=function(){function e(){this._items=new n({allocator:e=>e||{obj:null,distance:0,near:0,far:0},deallocator:e=>(e.obj=null,e.distance=0,e.near=0,e.far=0,e)})}var r=e.prototype;return r.clear=function(){this._items.clear()},r.add=function(e){this._items.pushNew().obj=e},r.sort=function(e){const t=e.eye,n=e.viewForward;this._items.forAll((e=>{const r=e.obj,i=r.getCenter(),a=r.getBSRadius(),s=(i[0]-t[0])*n[0]+(i[1]-t[1])*n[1]+(i[2]-t[2])*n[2];e.distance=s,e.near=s-a,e.far=s+a})),this._items.sort(((e,t)=>e.distance-t.distance))},r.forEachInDepthRange=function(e,t,n){if("front-to-back"===t)for(let t=0;t<this._items.length;++t){const r=this._items.data[t];r.far<e.near||r.near>e.far||n(r.obj,r.near,r.far)}else for(let t=this._items.length-1;t>=0;--t){const r=this._items.data[t];r.far<e.near||r.near>e.far||n(r.obj,r.near,r.far)}},t._createClass(e,[{key:"length",get:function(){return this._items.length}},{key:"empty",get:function(){return 0===this._items.length}}]),e}(),R=function(){function e(){this.view=o.create(),this.viewProj=o.create(),this.frustum=c.frustum.create(),this.geometries=[],this.near=[],this.far=[],this.nearCandidates=[],this.farCandidates=[],this.range={near:0,far:0},this.looseRange={near:0,far:0}}var t=e.prototype;return t.compute=function(e,t){this.reset(),s.copy(this.view,e.viewMatrix),s.multiply(this.viewProj,e.projectionMatrix,this.view),c.frustum.copy(e.frustum,this.frustum);const n=this.view,r=n[2],i=n[6],a=n[10],o=n[14],h=this.range;let f=0;if(t.forEach((e=>{if(!e.instanceParameters.visible)return;if(!e.castShadow)return;let t,n;e.hasShaderTransformation?(t=e.getBoundingSphere(e.getShaderTransformation(),1,B),n=B):(t=e.bsRadius,n=e.center);const s=r*n[0]+i*n[1]+a*n[2]+o,h=s-t,c=s+t;this.geometries[f]=e,this.near[f]=-c,this.far[f]=-h,++f})),0===this.geometries.length)return h;for(let e=0;e<this.geometries.length;++e)this.near[e]>h.far&&(h.far=this.near[e]),this.near[e]>2&&this.far[e]<h.near&&(h.near=this.far[e]);const u=this.looseRange;u.near=Math.max(.5*h.near,2),u.far=2*h.far;let l=0,g=0;for(let e=0;e<this.geometries.length;++e)this.near[e]<h.near&&(this.near[e]>=u.near?h.near=this.near[e]:this.nearCandidates[l++]=e),this.far[e]>h.far&&(this.far[e]<=u.far?h.far=this.far[e]:this.farCandidates[g++]=e);if(0===this.nearCandidates.length&&0===this.farCandidates.length)return h;this.nearCandidates.sort(((e,t)=>this.near[e]<this.near[t]?-1:this.near[e]>this.near[t]?1:0)),this.farCandidates.sort(((e,t)=>this.far[e]<this.far[t]?1:this.far[e]>this.far[t]?-1:0));for(let e=0;e<this.nearCandidates.length;++e){const t=this.nearCandidates[e];if(this.near[t]<h.near){const e=this.geometries[t],n=e.boundingInfo;this.includeNearBoundingInfoRec(n,e.getShaderTransformation())}}for(let e=0;e<this.farCandidates.length;++e){const t=this.farCandidates[e];if(this.far[t]>h.far){const e=this.geometries[t],n=e.boundingInfo;this.includeFarBoundingInfoRec(n,e.getShaderTransformation())}}return h},t.reset=function(){this.geometries.length=0,this.near.length=0,this.far.length=0,this.nearCandidates.length=0,this.farCandidates.length=0,this.range.near=Number.MAX_VALUE,this.range.far=-Number.MAX_VALUE},t.includeNearBoundingInfoRec=function(e,t){let n=e.getBSRadius();const r=e.getCenter();i.transformMat4(B,r,t);const s=a.maxScale(t),o=B[0],h=B[1],f=B[2];n*=s;const{planes:c}=this.frustum;if(c[0][0]*o+c[0][1]*h+c[0][2]*f+c[0][3]>n)return;if(c[1][0]*o+c[1][1]*h+c[1][2]*f+c[1][3]>n)return;if(c[2][0]*o+c[2][1]*h+c[2][2]*f+c[2][3]>n)return;if(c[3][0]*o+c[3][1]*h+c[3][2]*f+c[3][3]>n)return;const u=this.view[2]*o+this.view[6]*h+this.view[10]*f+this.view[14],l=u+n;if(!(-(u-n)<2||-l>=this.range.near))if(-l>this.looseRange.near)this.range.near=-l;else{if(n>100){const n=e.getChildren();if(void 0!==n){for(let e=0;e<8;++e)void 0!==n[e]&&this.includeNearBoundingInfoRec(n[e],t);return}}j.unionDepthRangeWithAABB(this.range,this.viewProj,t,e.getBBMin(),e.getBBMax())}},t.includeFarBoundingInfoRec=function(e,t){let n=e.getBSRadius();const r=e.getCenter();i.transformMat4(B,r,t);const s=a.maxScale(t),o=B[0],h=B[1],f=B[2];n*=s;const{planes:c}=this.frustum;if(c[0][0]*o+c[0][1]*h+c[0][2]*f+c[0][3]>n)return;if(c[1][0]*o+c[1][1]*h+c[1][2]*f+c[1][3]>n)return;if(c[2][0]*o+c[2][1]*h+c[2][2]*f+c[2][3]>n)return;if(c[3][0]*o+c[3][1]*h+c[3][2]*f+c[3][3]>n)return;const u=this.view[2]*o+this.view[6]*h+this.view[10]*f+this.view[14]-n;if(!(-u<=this.range.far))if(-u<this.looseRange.far)this.range.far=-u;else{if(n>100){const n=e.getChildren();if(void 0!==n){for(let e=0;e<8;++e)void 0!==n[e]&&this.includeFarBoundingInfoRec(n[e],t);return}}j.unionDepthRangeWithAABB(this.range,this.viewProj,t,e.getBBMin(),e.getBBMax())}},e}(),v=function(){function e(){this.modelViewProj=o.create(),this.clipPosition=[h.create(),h.create(),h.create(),h.create(),h.create(),h.create(),h.create(),h.create()]}var t=e.prototype;return t.unionDepthRangeWithAABB=function(e,t,n,r,i){const a=this.modelViewProj;s.multiply(a,t,n);let o=!1;for(let e=0;e<8;++e){const t=this.clipPosition[e],n=0===e||3===e||4===e||7===e?r[0]:i[0],s=0===e||1===e||4===e||5===e?r[1]:i[1],o=e<4?r[2]:i[2];t[0]=a[0]*n+a[4]*s+a[8]*o+a[12],t[1]=a[1]*n+a[5]*s+a[9]*o+a[13],t[2]=a[2]*n+a[6]*s+a[10]*o+a[14],t[3]=a[3]*n+a[7]*s+a[11]*o+a[15]}for(let t=0;t<12;++t){const n=this.clipPosition[w[t][0]],r=this.clipPosition[w[t][1]],i=this.clipPosition[w[t][2]],a=this.clipTriangle(n,r,i);let s=!0;for(let e=0;e<a.length;++e){if(a[e][3]>=2){s=!1;break}}if(!s){o=!0;for(let t=0;t<a.length;++t){const n=a[t][3];n<e.near&&(e.near=n),n>e.far&&(e.far=n)}}}return o},t.inside=function(e,t){return 0===t?e[0]>=-e[3]:1===t?e[1]>=-e[3]:2===t?e[0]<=e[3]:3===t?e[1]<=e[3]:void u.assert(!1)},t.intersect=function(e,t,n){let r=0;return 0===n?r=(-e[3]-e[0])/(t[0]-e[0]+t[3]-e[3]):1===n?r=(-e[3]-e[1])/(t[1]-e[1]+t[3]-e[3]):2===n?r=(e[3]-e[0])/(t[0]-e[0]-t[3]+e[3]):3===n&&(r=(e[3]-e[1])/(t[1]-e[1]-t[3]+e[3])),f.lerp(h.create(),e,t,r)},t.clipTriangle=function(e,t,n){let r=[e,t,n];for(let e=0;e<4;++e){const t=r;r=[];for(let n=0;n<t.length;++n){const i=t[n],a=t[(n+1)%t.length];this.inside(a,e)?(this.inside(i,e)||r.push(this.intersect(i,a,e)),r.push(a)):this.inside(i,e)&&r.push(this.intersect(i,a,e))}}return r},e}();const w=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],B=r.create(),C=o.create(),y=l.empty(),M=new b,S=new R,j=new v;e.DepthRangeFromRenderGeometries=R,e.depthRangeFromLayer=g,e.depthRangeFromScene=function(e,t,n){if(t.size<1e4)return S.compute(e,t);const r=l.empty();return n.forEach((t=>{t.isVisible&&l.union(r,g(e,t))})),r},e.texure2depth=function(e,t,n){return u.unpackFloatRGBA(t,e)*(n[1]-n[0])+n[0]},Object.defineProperty(e,"__esModule",{value:!0})}));
