// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","./glUtil3D","./RenderTargetHelper","./Util","../shaders/OffscreenPrograms","../../../webgl/renderState","../../../webgl/Util"],function(e,t,r,i,o,n,a,s){var l=[0,0,0,0],p=[0,1,0,1];return function(){function e(e,t){this.dimensions={width:4,height:4},this._enabled=!1,this._background={type:"color",color:[0,0,0,1]},this._compositePipelineState=new Map,this._rctx=t,this.renderTargetHelper=new i.RenderTargetHelper(t);var r=this.renderTargetHelper;this.mainColor=r.registerColorTarget({name:"mainColor"}),this.mainDepth=r.registerDepthTarget({name:"mainDepth"}),this.linearDepth=r.registerColorTarget({name:"linearDepth"}),this.normal=r.registerColorTarget({name:"normal"}),this.highlight=r.registerColorTarget({name:"highlight",dataType:32819}),this.hudVisibility=r.registerColorTarget({name:"hudVisibility",dataType:32819}),this.tmpColor=r.registerColorTarget({name:"tmpColor"}),this.tmpDepth=r.registerDepthTarget({name:"tmpDepth"}),this._compositeProgram=e.getProgram(n.composite),this._compositePipelineState.set("none",a.makePipelineState({colorWrite:a.defaultColorWriteParams})),this._compositePipelineState.set("alpha",a.makePipelineState({blending:a.separateBlendingParams(770,1,771,771),colorWrite:a.defaultColorWriteParams})),this._compositePipelineState.set("premultiplied-alpha",a.makePipelineState({blending:a.simpleBlendingParams(1,771),colorWrite:a.defaultColorWriteParams})),this._compositeTransparentToHUDVisibilityProgram=e.getProgram(n.compositeTransparentToHUDVisibility),this._compositeTransparentToHUDVisibilityPipelineState=a.makePipelineState({colorWrite:{r:!1,g:!0,b:!1,a:!1}}),this._compositeOccludedProgram=e.getProgram(n.compositeOccluded),this._compositeOccludedPipelineState=a.makePipelineState({blending:a.simpleBlendingParams(1,771),colorWrite:a.defaultColorWriteParams})}return Object.defineProperty(e.prototype,"width",{get:function(){return this.dimensions.width},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this.dimensions.height},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"enabled",{get:function(){return this._enabled},set:function(e){e?this.enable():this.disable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"background",{get:function(){return this._background},set:function(e){this._background=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"framebuffer",{get:function(){return this.renderTargetHelper.getFramebuffer(this.dimensions,this.mainColor,this.mainDepth)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"colorTexture",{get:function(){return this.framebuffer.colorTexture},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"depthTexture",{get:function(){return this.framebuffer.depthStencilTexture},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"linearDepthTexture",{get:function(){return this.renderTargetHelper.getAllocatedColorTexture(this.linearDepth)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"normalTexture",{get:function(){return this.renderTargetHelper.getAllocatedColorTexture(this.normal)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"highlightTexture",{get:function(){return this.renderTargetHelper.getAllocatedColorTexture(this.highlight)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hudVisibilityTexture",{get:function(){return this.getColorTexture(this.hudVisibility)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"tmpColorTexture",{get:function(){return this.getColorTexture(this.tmpColor)},enumerable:!0,configurable:!0}),e.prototype.initializeFrame=function(e,t){o.assert(this.enabled);var r=this._rctx;this.dimensions.width=e.fullWidth,this.dimensions.height=e.fullHeight,this.outputFramebuffer=t,this.bindTarget(this.mainColor,this.mainDepth),r.setClearStencil(0);var i=this._background.color;r.setClearColor(i[0]*i[3],i[1]*i[3],i[2]*i[3],i[3]),r.clearSafe(17664)},e.prototype.renderAndComposite=function(e,t){this.renderToTargets(e,this.tmpColor,this.mainDepth,l),this.composite(this.getColorTexture(this.tmpColor),this.framebuffer,t)},e.prototype.renderHUDVisibility=function(e){this.renderToTargets(e,this.hudVisibility,this.mainDepth,p)},e.prototype.compositeTransparentTerrainOntoHUDVisibility=function(){var e=this,t=this._rctx;this.renderToTargets(function(){var r=e._compositeTransparentToHUDVisibilityProgram;t.bindProgram(r),t.setPipelineState(e._compositeTransparentToHUDVisibilityPipelineState),r.setUniform1i("tex",1),t.bindTexture(e.getColorTexture(e.tmpColor),1),t.bindVAO(e.quadVAO),t.drawArrays(5,0,s.vertexCount(e.quadVAO,"geometry"))},this.hudVisibility,this.mainDepth)},e.prototype.compositeTransparentTerrainOntoMain=function(){this.composite(this.getColorTexture(this.tmpColor),this.framebuffer,"premultiplied-alpha")},e.prototype.compositeOccludedOntoMain=function(e){var t=this._rctx,r=this._compositeOccludedProgram;this.bindFramebuffer(),t.bindProgram(r),t.setPipelineState(this._compositeOccludedPipelineState),t.bindVAO(this.quadVAO),t.bindTexture(this.getColorTexture(this.tmpColor),0),r.setUniform1i("occludedColorMap",0),r.setUniform1f("opacity",e),t.drawArrays(5,0,s.vertexCount(this.quadVAO,"geometry")),t.bindVAO(null)},e.prototype.bindFramebuffer=function(){this._rctx.bindFramebuffer(this.framebuffer)},e.prototype.renderDepthDetached=function(e){e(this.bindTarget(this.mainColor)),this.bindTarget(this.mainColor,this.mainDepth)},e.prototype.composite=function(e,t,r){void 0===e&&(e=this.framebuffer.colorTexture),void 0===t&&(t=this.outputFramebuffer),void 0===r&&(r="none");var i=this._rctx,o=this._compositeProgram;i.bindFramebuffer(t),i.bindProgram(o),i.setPipelineState(this._compositePipelineState.get(r)),o.setUniform1i("tex",1),i.bindTexture(e,1),i.bindVAO(this.quadVAO),i.drawArrays(5,0,s.vertexCount(this.quadVAO,"geometry"))},e.prototype.disposeTarget=function(e){this.renderTargetHelper.disposeTargetResource(e)},e.prototype.enable=function(){this.enabled||(this._enabled=!0,this.quadVAO=r.createQuadVAO(this._rctx))},e.prototype.disable=function(){this.enabled&&(this._enabled=!1,this.renderTargetHelper.disposeAllResource(),this.quadVAO.dispose(!0),this.quadVAO=null)},e.prototype.renderToTargets=function(e,t,r,i,o){var n=this._rctx,a=this.bindTarget(t,r),s=0;if(i){var l=Math.max(1e-13,i[3]);n.setClearColor(i[0],i[1],i[2],l),s|=16384}return o&&(s|=256),n.clearSafe(s),e(a),n.gl.flush(),this.bindTarget(this.mainColor,this.mainDepth),a},e.prototype.bindTarget=function(e,t){var r=this.renderTargetHelper.getFramebuffer(this.dimensions,e,t);return this._rctx.bindFramebuffer(r),r},e.prototype.getColorTexture=function(e){return this.renderTargetHelper.getColorTexture(e,this.dimensions)},e.prototype.getGpuMemoryUsage=function(){var e=0;return this.renderTargetHelper&&(e+=this.renderTargetHelper.getGpuMemoryUsage()),e},e}()});