/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/mathUtils","../../../../core/maybe","../../support/debugFlags"],(function(t,e,i,n,s){"use strict";let o=function(){function o(t,e,i,n=2048){this.text=t,this._alignment=e,this._parameters=i,this._maxSize=n,this._textWidths=[],this._lineWidths=[],this._renderPixelRatio=null,this._displayWidth=null,this._heightMetricsCached=null,this.key=`TextRenderer-${this._parameters.key}-${this._alignment}--${t}`,this._lines=t.split(/\r?\n/)}var h=o.prototype;return h._getLineXOffset=function(e){switch(this._alignment){case t.TextRenderAlignment.Left:return this._backgroundHorizontalPadding;case t.TextRenderAlignment.Center:return(this.displayWidth-this._lineWidths[e])/2;case t.TextRenderAlignment.Right:return this.displayWidth-this._backgroundHorizontalPadding-this._lineWidths[e]}},h.render=function(t,e=0,i=0){t.save();const n=e/=this.renderPixelRatio,o=i/=this.renderPixelRatio,r=this._haloSize,h=this._firstLineYOffset;e+=r,i+=h+this._baselinePosition;const a=this._haloSize>0;a&&this._renderHalo(t,n,o,r,h),this._setFontProperties(t,this._renderedFontSize);for(let s=0;s<this._lines.length;++s){const n=this._lines[s],o=this._getLineXOffset(s);a&&(t.globalCompositeOperation="destination-out",t.fillStyle="rgb(0, 0, 0)",this._fillText(t,n,e+o,i),this._renderLineDecoration(t,e+o,i,this._textWidths[s])),t.globalCompositeOperation="source-over",t.fillStyle=this._parameters.textStyle,this._fillText(t,n,e+this._getLineXOffset(s),i),this._renderLineDecoration(t,e+o,i,this._textWidths[s]),i+=this._lineSpacing}if(s.TEXT_SHOW_BASELINE){t.strokeStyle=c,t.setLineDash([2,2]),t.lineWidth=1;let e=o+h;for(let i=0;i<this._lines.length;++i){const i=e+this._baselinePosition;this._drawLine(t,[n,i],[n+this.displayWidth,i]),e+=this._lineSpacing}}if(s.TEXT_SHOW_BORDER&&(t.strokeStyle=c,t.setLineDash([]),t.lineWidth=1,this._drawBox(t,[n,o],[this.displayWidth,this.displayHeight])),this._hasBackground){const e=this._parameters.definition.background.borderRadius*this.renderPixelRatio;this._roundedRect(t,n,o,e),t.globalCompositeOperation="destination-over",t.fillStyle=this._parameters.backgroundStyle,t.fill()}t.restore()},h._renderLineDecoration=function(t,e,i,n,s=!1){if("none"===this._parameters.definition.font.decoration||0===n)return;const o=1,r=Math.max(this._parameters.definition.size/16,o);switch(this._parameters.definition.font.decoration){case"underline":i+=2*r;break;case"line-through":i-=.33*this._baselinePosition}const h=s?this._haloSize:0;t.strokeStyle=s?this._parameters.haloStyle:this._parameters.textStyle,t.lineWidth=this._toRenderUnit(r+2*h),t.beginPath(),t.moveTo(this._toRenderUnit(e-h),this._toRenderUnit(i)),t.lineTo(this._toRenderUnit(e+n+h),this._toRenderUnit(i)),t.stroke()},h._roundedRect=function(t,e,n,s){e=this._toRenderUnit(e),n=this._toRenderUnit(n);const o=this.renderedWidth,r=this.renderedHeight;0!==s?(s=i.clamp(s,0,Math.floor(r/2)),t.beginPath(),t.moveTo(e,n+s),t.arcTo(e,n,e+s,n,s),t.lineTo(e+o-s,n),t.arcTo(e+o,n,e+o,n+s,s),t.lineTo(e+o,n+r-s),t.arcTo(e+o,n+r,e+o-s,n+r,s),t.lineTo(e+s,n+r),t.arcTo(e,n+r,e,n+r-s,s),t.closePath()):t.rect(e,n,o,r)},h._renderHalo=function(t,e,i,n,s){const o=this.renderedWidth,r=this.renderedHeight,h=a(d,Math.max(o,_),Math.max(r,_)),l=h.getContext("2d");l.clearRect(0,0,o,r),this._setFontProperties(l,this._renderedFontSize),l.fillStyle=this._parameters.haloStyle,l.strokeStyle=this._parameters.haloStyle;const c=this._renderedHaloSize<3;l.lineJoin=c?"miter":"round",c?this._renderHaloEmulated(l,n,s):this._renderHaloNative(l,n,s);let g=s+this._baselinePosition;for(let a=0;a<this._lines.length;++a){const t=this._getLineXOffset(a);this._renderLineDecoration(l,n+t,g,this._textWidths[a],!0),g+=this._lineSpacing}t.globalAlpha=this._parameters.definition.halo.color[3],t.drawImage(h,0,0,o,r,this._toRenderUnit(e),this._toRenderUnit(i),o,r),t.globalAlpha=1},h._renderHaloEmulated=function(t,e,i){i+=this._baselinePosition;for(let n=0;n<this._lines.length;++n){const s=this._lines[n],o=this._getLineXOffset(n);for(const[n,h]of r)this._fillText(t,s,e+o+this._haloSize*n,i+this._haloSize*h);i+=this._lineSpacing}},h._renderHaloNative=function(t,e,i){const n=2*this._haloSize;i+=this._baselinePosition;for(let s=0;s<this._lines.length;++s){const o=this._lines[s],r=this._getLineXOffset(s),h=5,a=.1;for(let s=0;s<h;s++){const d=1-(h-1)*a+s*a;t.lineWidth=this._toRenderUnit(d*n),this._strokeText(t,o,e+r,i)}i+=this._lineSpacing}},h._setFontProperties=function(t,e){t.font=this._parameters.fontString(e),t.textAlign="left",t.textBaseline="alphabetic"},h._ensureTextWidth=function(){if(n.isSome(this._displayWidth))return this._displayWidth;const t=a(d,_,_).getContext("2d");this._setFontProperties(t,this._fontSize);let e=2*this._haloSize;const i=this._parameters.definition.font;"italic"!==i.style&&"oblique"!==i.style&&"bold"!==i.weight&&"bolder"!==i.weight||(e+=.3*t.measureText("A").width),this._textWidths.length=0,this._lineWidths.length=0;let s=0;for(const n of this._lines){const i=t.measureText(n).width,o=i+e;this._textWidths.push(i),this._lineWidths.push(o),s=Math.max(s,o)}return this._displayWidth=s,this._displayWidth},h._ensureHeightMetrics=function(){if(n.isNone(this._heightMetricsCached)){const t=a(d,_,_).getContext("2d");this._setFontProperties(t,this._fontSize);const e=t.measureText(this.text+g),i=this._hasBackground?t.measureText(this._lines[0]):e,n=1===this._lines.length?i:this._hasBackground?t.measureText(this._lines[this._lines.length-1]):e,s=e.actualBoundingBoxAscent+e.actualBoundingBoxDescent;this._heightMetricsCached={paddingTop:e.actualBoundingBoxAscent-i.actualBoundingBoxAscent,paddingBottom:e.actualBoundingBoxDescent-n.actualBoundingBoxDescent,lineHeight:s,baselinePosition:e.actualBoundingBoxAscent}}return this._heightMetricsCached},h._toRenderUnit=function(t){return t*this.renderPixelRatio},h._toRoundedRenderUnit=function(t){return Math.round(t*this.renderPixelRatio)},h._fillText=function(t,e,i,n){t.fillText(e,this._toRenderUnit(i),this._toRenderUnit(n))},h._strokeText=function(t,e,i,n){t.strokeText(e,this._toRenderUnit(i),this._toRenderUnit(n))},h._drawLine=function(t,e,i){t.beginPath(),t.moveTo(this._toRoundedRenderUnit(e[0])+.5,this._toRoundedRenderUnit(e[1])+.5),t.lineTo(this._toRoundedRenderUnit(i[0])+.5,this._toRoundedRenderUnit(i[1])+.5),t.stroke()},h._drawBox=function(t,e,i){const n=this._toRenderUnit(e[0]),s=this._toRenderUnit(e[1]),o=this._toRenderUnit(i[0]),r=this._toRenderUnit(i[1]),h=Math.floor(n)+.5,a=Math.ceil(n+o)-.5,d=Math.floor(s)+.5,l=Math.ceil(s+r)-.5;t.beginPath(),t.moveTo(h,d),t.lineTo(a,d),t.lineTo(a,l),t.lineTo(h,l),t.lineTo(h,d),t.stroke()},e._createClass(o,[{key:"displayWidth",get:function(){return Math.ceil(this._ensureTextWidth()+2*this._backgroundHorizontalPadding)}},{key:"displayHeight",get:function(){const t=this._lineSpacing*(this._lines.length-1),e=this._lineHeight;return Math.ceil(t+e+2*this._haloSize+this._backgroundTopPadding+this._backgroundBottomPadding)}},{key:"renderedWidth",get:function(){return Math.ceil(this._toRenderUnit(this.displayWidth))}},{key:"renderedHeight",get:function(){return Math.ceil(this._toRenderUnit(this.displayHeight))}},{key:"firstRenderedBaselinePosition",get:function(){return this._toRenderUnit(this._firstLineYOffset+this._baselinePosition)}},{key:"_firstLineYOffset",get:function(){return this._backgroundTopPadding+this._haloSize}},{key:"_heightMetrics",get:function(){return this._ensureHeightMetrics()}},{key:"_lineSpacing",get:function(){return(this._lineHeight+this._linePadding)*this._parameters.definition.lineSpacingFactor}},{key:"_lineHeight",get:function(){return this._heightMetrics.lineHeight}},{key:"_linePadding",get:function(){return this._lineHeight*l}},{key:"_baselinePosition",get:function(){return this._heightMetrics.baselinePosition}},{key:"_renderedFontSize",get:function(){return this._toRenderUnit(this._fontSize)}},{key:"_fontSize",get:function(){return this._parameters.definition.size}},{key:"_renderedHaloSize",get:function(){return this._toRenderUnit(this._haloSize)}},{key:"_haloSize",get:function(){return this._parameters.haloSize}},{key:"_backgroundHorizontalPadding",get:function(){return this._hasBackground?this._parameters.definition.background.padding[0]:0}},{key:"_backgroundVerticalPadding",get:function(){return this._hasBackground?this._parameters.definition.background.padding[1]:0}},{key:"_backgroundTopPadding",get:function(){return Math.max(0,this._backgroundVerticalPadding-this._heightMetrics.paddingTop)}},{key:"_backgroundBottomPadding",get:function(){return Math.max(0,this._backgroundVerticalPadding-this._heightMetrics.paddingBottom)}},{key:"_hasBackground",get:function(){return!!this._parameters.backgroundStyle}},{key:"renderPixelRatio",get:function(){if(n.isNone(this._renderPixelRatio)){const t=this._parameters.definition.pixelRatio;this._maxSize>0?this._renderPixelRatio=Math.min(t,Math.min(this._maxSize/this.displayWidth,this._maxSize/this.displayHeight)):this._renderPixelRatio=t}return this._renderPixelRatio}}]),o}();const r=[];{const t=16;for(let e=0;e<360;e+=360/t)r.push([Math.cos(Math.PI*e/180),Math.sin(Math.PI*e/180)])}var h;function a(t,e,i){return t.canvas||(t.canvas=document.createElement("canvas")),t.canvas.width=e,t.canvas.height=i,t.canvas}t.TextRenderAlignment=void 0,(h=t.TextRenderAlignment||(t.TextRenderAlignment={}))[h.Left=0]="Left",h[h.Center=1]="Center",h[h.Right=2]="Right";const d={canvas:null},l=.2,_=512,c="rgb(255, 0, 255, 0.5)",g=(()=>{let t="";for(let e=32;e<127;e++)t+=String.fromCharCode(e);return t})();t.TextRenderer=o,t.getTextHelperCanvas=a,Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
