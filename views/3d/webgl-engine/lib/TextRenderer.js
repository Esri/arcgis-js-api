// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","../../../../core/maybe","./TextRenderParameters"],(function(e,t,i,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getTextHelperCanvas=t.TextRenderer=void 0;var n=function(){function e(e,t,i){void 0===i&&(i=2048),this.text=e,this.maxSize=i,this._renderPixelRatio=null,this._displayWidth=null,t instanceof r.default?this.parameters=t:this.parameters=new r.default(t),this.key=this.parameters.key+"--"+e,this.textLines=e.split(/\r?\n/),this.lineHeight=this.computeLineHeight()}return Object.defineProperty(e.prototype,"displayWidth",{get:function(){return i.isNone(this._displayWidth)&&(this._displayWidth=this.computeTextWidth()),this._displayWidth},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"displayHeight",{get:function(){return this.lineHeight*this.textLines.length},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"renderedWidth",{get:function(){return Math.round(this.displayWidth*this.renderPixelRatio)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"renderedHeight",{get:function(){return Math.round(this.displayHeight*this.renderPixelRatio)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"renderedLineHeight",{get:function(){return Math.round(this.lineHeight*this.renderPixelRatio)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"renderedFontSize",{get:function(){return this.parameters.definition.size*this.renderPixelRatio},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"renderedHaloSize",{get:function(){return this.parameters.haloSize*this.renderPixelRatio},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"renderPixelRatio",{get:function(){if(i.isNone(this._renderPixelRatio)){var e=this.parameters.definition.pixelRatio;this.maxSize>0?this._renderPixelRatio=Math.min(e,Math.min(this.maxSize/(this.displayWidth*e),this.maxSize/(this.displayHeight*e))):this._renderPixelRatio=e}return this._renderPixelRatio},enumerable:!1,configurable:!0}),e.prototype.render=function(e,t,i){void 0===t&&(t=0),void 0===i&&(i=0);var r,n,o=this.renderedLineHeight,s=this.renderedHaloSize,h=(r=e.textAlign,n=this.renderedWidth,("center"===r?.5*n:"right"===r?n:0)+s),l=s+a;e.save(),s>0&&this.renderHalo(e,h,l,t,i),this.setFontProperties(e,this.renderedFontSize),i+=l,t+=h;for(var d=0,p=this.textLines;d<p.length;d++){var u=p[d];e.globalCompositeOperation="destination-out",e.fillStyle="rgb(0, 0, 0)",e.fillText(u,t,i),e.globalCompositeOperation="source-over",e.fillStyle=this.parameters.fillStyle,e.fillText(u,t,i),i+=o}e.restore()},e.prototype.renderHalo=function(e,t,i,r,n){var a=this.renderedWidth,o=this.renderedHeight,s=h(l,Math.max(a,d),Math.max(o,d)),p=s.getContext("2d");p.clearRect(0,0,a,o),this.setFontProperties(p,this.renderedFontSize),p.fillStyle=this.parameters.haloStyle,p.strokeStyle=this.parameters.haloStyle;var u=this.renderedHaloSize<3;p.lineJoin=u?"miter":"round",u?this.renderHaloEmulated(p,t,i):this.renderHaloNative(p,t,i),e.globalAlpha=this.parameters.definition.halo.color[3],e.drawImage(s,0,0,a,o,r,n,a,o),e.globalAlpha=1},e.prototype.renderHaloEmulated=function(e,t,i){for(var r=this.renderedLineHeight,n=this.renderedHaloSize,a=0,s=this.textLines;a<s.length;a++){for(var h=s[a],l=0,d=o;l<d.length;l++){var p=d[l],u=p[0],f=p[1];e.fillText(h,t+n*u,i+n*f)}i+=r}},e.prototype.renderHaloNative=function(e,t,i){for(var r=this.renderedLineHeight,n=this.renderedHaloSize,a=0,o=this.textLines;a<o.length;a++){for(var s=o[a],h=2*n,l=0;l<5;l++){var d=.6+.1*l;e.lineWidth=d*h,e.strokeText(s,t,i)}i+=r}},e.prototype.setFontProperties=function(e,t){var i=this.parameters.definition.font,r=i.style+" "+i.weight+" "+t+"px "+i.family+", sans-serif";e.font=r,e.textAlign="left",e.textBaseline="top"},e.prototype.computeTextWidth=function(){var e=h(l,d,d).getContext("2d");this.setFontProperties(e,this.parameters.definition.size);for(var t=0,i=0,r=this.textLines;i<r.length;i++){var n=r[i];t=Math.max(t,e.measureText(n).width)}var a=this.parameters.definition.font;return("italic"===a.style||"oblique"===a.style||"string"==typeof a.weight&&("bold"===a.weight||"bolder"===a.weight)||"number"==typeof a.weight&&a.weight>600)&&(t+=.3*e.measureText("A").width),t+=2*this.parameters.haloSize,Math.round(t)},e.prototype.computeLineHeight=function(){var e=1.275*this.parameters.definition.size;return Math.ceil(e+2*this.parameters.haloSize)+a},e}();t.TextRenderer=n;for(var a=1,o=[],s=0;s<360;s+=22.5)o.push([Math.cos(Math.PI*s/180),Math.sin(Math.PI*s/180)]);function h(e,t,i){return e.canvas||(e.canvas=document.createElement("canvas")),e.canvas.width=t,e.canvas.height=i,e.canvas}t.getTextHelperCanvas=h;var l={canvas:null},d=512;t.default=n}));