/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","./TextRenderParameters"],(function(e,t,i,n){"use strict";let r=function(){function e(e,t,i=2048){this.text=e,this.maxSize=i,this._renderPixelRatio=null,this._displayWidth=null,t instanceof n.TextRenderParameters?this.parameters=t:this.parameters=new n.TextRenderParameters(t),this.key=`${this.parameters.key}--${e}`,this.textLines=e.split(/\r?\n/),this.lineHeight=this.computeLineHeight()}var r=e.prototype;return r.render=function(e,t=0,i=0){const n=this.renderedLineHeight,r=this.renderedHaloSize,o=(a=e.textAlign,h=this.renderedWidth,("center"===a?.5*h:"right"===a?h:0)+r);var a,h;const l=r+s;e.save();r>0&&this.renderHalo(e,o,l,t,i),this.setFontProperties(e,this.renderedFontSize),i+=l,t+=o;for(const r of this.textLines)e.globalCompositeOperation="destination-out",e.fillStyle="rgb(0, 0, 0)",e.fillText(r,t,i),e.globalCompositeOperation="source-over",e.fillStyle=this.parameters.fillStyle,e.fillText(r,t,i),i+=n;e.restore()},r.renderHalo=function(e,t,i,n,r){const s=this.renderedWidth,o=this.renderedHeight,d=a(h,Math.max(s,l),Math.max(o,l)),c=d.getContext("2d");c.clearRect(0,0,s,o),this.setFontProperties(c,this.renderedFontSize),c.fillStyle=this.parameters.haloStyle,c.strokeStyle=this.parameters.haloStyle;const u=this.renderedHaloSize<3;c.lineJoin=u?"miter":"round",u?this.renderHaloEmulated(c,t,i):this.renderHaloNative(c,t,i),e.globalAlpha=this.parameters.definition.halo.color[3],e.drawImage(d,0,0,s,o,n,r,s,o),e.globalAlpha=1},r.renderHaloEmulated=function(e,t,i){const n=this.renderedLineHeight,r=this.renderedHaloSize;for(const s of this.textLines){for(const[n,a]of o)e.fillText(s,t+r*n,i+r*a);i+=n}},r.renderHaloNative=function(e,t,i){const n=this.renderedLineHeight,r=this.renderedHaloSize;for(const s of this.textLines){const o=2*r,a=5,h=.1;for(let n=0;n<a;n++){const r=1-(a-1)*h+n*h;e.lineWidth=r*o,e.strokeText(s,t,i)}i+=n}},r.setFontProperties=function(e,t){const i=this.parameters.definition.font,n=`${i.style} ${i.weight} ${t}px ${i.family}, sans-serif`;e.font=n,e.textAlign="left",e.textBaseline="top"},r.computeTextWidth=function(){const e=a(h,l,l).getContext("2d");this.setFontProperties(e,this.parameters.definition.size);let t=0;for(const i of this.textLines)t=Math.max(t,e.measureText(i).width);const i=this.parameters.definition.font;return("italic"===i.style||"oblique"===i.style||"string"==typeof i.weight&&("bold"===i.weight||"bolder"===i.weight)||"number"==typeof i.weight&&i.weight>600)&&(t+=.3*e.measureText("A").width),t+=2*this.parameters.haloSize,Math.round(t)},r.computeLineHeight=function(){const e=1.275*this.parameters.definition.size;return Math.ceil(e+2*this.parameters.haloSize)+s},t._createClass(e,[{key:"displayWidth",get:function(){return i.isNone(this._displayWidth)&&(this._displayWidth=this.computeTextWidth()),this._displayWidth}},{key:"displayHeight",get:function(){return this.lineHeight*this.textLines.length}},{key:"renderedWidth",get:function(){return Math.round(this.displayWidth*this.renderPixelRatio)}},{key:"renderedHeight",get:function(){return Math.round(this.displayHeight*this.renderPixelRatio)}},{key:"renderedLineHeight",get:function(){return Math.round(this.lineHeight*this.renderPixelRatio)}},{key:"renderedFontSize",get:function(){return this.parameters.definition.size*this.renderPixelRatio}},{key:"renderedHaloSize",get:function(){return this.parameters.haloSize*this.renderPixelRatio}},{key:"renderPixelRatio",get:function(){if(i.isNone(this._renderPixelRatio)){const e=this.parameters.definition.pixelRatio;this.maxSize>0?this._renderPixelRatio=Math.min(e,Math.min(this.maxSize/(this.displayWidth*e),this.maxSize/(this.displayHeight*e))):this._renderPixelRatio=e}return this._renderPixelRatio}}]),e}();const s=1,o=[];{const e=16;for(let t=0;t<360;t+=360/e)o.push([Math.cos(Math.PI*t/180),Math.sin(Math.PI*t/180)])}function a(e,t,i){return e.canvas||(e.canvas=document.createElement("canvas")),e.canvas.width=t,e.canvas.height=i,e.canvas}const h={canvas:null},l=512;e.TextRenderer=r,e.default=r,e.getTextHelperCanvas=a,Object.defineProperty(e,"__esModule",{value:!0})}));
