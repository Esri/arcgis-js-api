/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Evented","../../../../core/MapUtils","../../../../core/mathUtils","../../../../core/maybe","../../../../core/uid","../../../../core/accessorSupport/decorators/property","../../../../core/arrayUtils","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","./ContentObjectType","./testUtils","./VertexAttribute","../../../support/Scheduler","../../../webgl/enums","../../../webgl/Texture"],(function(e,t,s,i,r,n,a,o,l,h,c,d,u,_,g,m,p,x,T){"use strict";const f=512,y=4096,A=.85,v=.95;e.TextTextureAtlas=function(e){function s(t){var s;return(s=e.call(this,t)||this).type=_.ContentObjectType.Texture,s.id=l.generateUID(),s.events=new r,s._glTexture=null,s._needsClear=!1,s._elementsToAddOrUpdate=new Map,s._elementsToRemove=new Map,s._elementsToRender=new Map,s._elements=new Map,s._stageObjects=new Map,s.updating=!1,s}t._inheritsLoose(s,e);var i=s.prototype;return i.initialize=function(){this._stage=this.view._stage,this._canvas=this._create2DCanvas(),this._ctx=this._canvas.getContext("2d"),this._stage.add(this);const e=this._computeAtlasResolution(this.view.width,this.view.height);this._createAtlasRegion(e),this._update2DCanvasSize(),this._resetAtlasCursor()},i.unload=function(){this._glTexture=o.disposeMaybe(this._glTexture),this.updating=!1,this.events.emit("unloaded")},i._createDescriptor=function(e){return{target:x.TextureType.TEXTURE_2D,pixelFormat:x.PixelFormat.RGBA,dataType:x.PixelType.UNSIGNED_BYTE,wrapMode:x.TextureWrapMode.CLAMP_TO_EDGE,flipped:!0,samplingMode:x.TextureSamplingMode.LINEAR_MIPMAP_LINEAR,hasMipmap:!0,preMultiplyAlpha:!0,maxAnisotropy:e.parameters.maxMaxAnisotropy}},i.load=function(e){return o.isSome(this._glTexture)||(this._glTexture=new T.Texture(e,this._createDescriptor(e),this._canvas),this._frameWorker=this.view.resourceController.scheduler.registerTask(p.TaskPriority.TEXT_TEXTURE_ATLAS,this),this.setDirty()),this._glTexture},i.dispose=function(){this._elements=null,this._elementsToAddOrUpdate=null,this._elementsToRemove=null,this._elementsToRender=null,this._frameWorker=o.removeMaybe(this._frameWorker),this._glTexture&&(this._stage.remove(this),this._glTexture=o.disposeMaybe(this._glTexture)),this._canvas.width=0,this._canvas.height=0,this._canvas=null,this._ctx=null},i._create2DCanvas=function(){const e=document.createElement("canvas");return e.setAttribute("id","canvas2d"),e.setAttribute("style","display:none"),e.setAttribute("width",f.toString()),e.setAttribute("height",f.toString()),e},i._update2DCanvasSize=function(){this._canvas.setAttribute("width",this._atlas.size.width.toString()),this._canvas.setAttribute("height",this._atlas.size.height.toString())},i._createAtlasRegion=function(e=f){this._atlas={size:{width:e,height:e},cursor:{x:0,y:0},lineHeight:0}},i._computeAtlasResolution=function(e,t){let s=Math.max(e,t);return s+=256,s=a.nextHighestPowerOfTwo(s),s=Math.min(s,y),s},i._resizeAtlas=function(e,t){t=t||e;const s=this._atlas;s.size.width=e,s.size.height=t,o.isSome(this._glTexture)&&this._glTexture.resize(e,t),this._update2DCanvasSize()},i._resetAtlasCursor=function(){const e=this._atlas;e.cursor.x=z,e.cursor.y=z+R,e.lineHeight=0,this._needsClear=!0},i._getAtlasUsage=function(){const e=this._atlas;return(e.cursor.x+e.cursor.y*e.size.width)/(e.size.width*e.size.height)},i._getExpectedAtlasUsage=function(){const e=this._elementsToRemove.size,t=this._elementsToAddOrUpdate.size,s=this._elements.size;return this._getAtlasUsage()/s*(s+t-e)},i._addAtlasElement=function(e,t,s,i){const r=this._atlas,{renderedWidth:n,renderedHeight:a,displayWidth:o,displayHeight:l}=e.textRenderer;e.placement.offset.x=r.cursor.x,e.placement.offset.y=r.cursor.y,e.placement.size.width=n,e.placement.size.height=a,e.placement.size.displayWidth=o,e.placement.size.displayHeight=l,e.placement.uvMinMax=[e.placement.offset.x/r.size.width,1-(e.placement.offset.y+a)/r.size.height,(e.placement.offset.x+n)/r.size.width,1-e.placement.offset.y/r.size.height],r.cursor.x+=s,r.lineHeight=Math.max(r.lineHeight,i),this._elements.set(t,e)},i._removeAtlasElement=function(e){if(e&&this._elements.has(e.textId)){const t=e.placement.offset,s=e.placement.size;this._ctx.clearRect(t.x,t.y,s.width,s.height),this._elements.delete(e.textId)}},i._ensureStageObjects=function(e){const t=this._stageObjects.get(e);if(t)return t;const s=new Set;return this._stageObjects.set(e,s),s},i._addStageObject=function(e,t){this._ensureStageObjects(e).add(t)},i._removeStageObject=function(e,t){const s=this._stageObjects.get(e);s&&s.delete(t)&&(t.geometries[0].vertexAttributes.get(m.VertexAttribute.SIZE).data=[0,0],t.geometryVertexAttrsUpdated(t.geometryRecords[0]))},i._processAddition=function(e,t){const s=this._atlas,i=e.textId,r=e.textRenderer.renderedWidth,n=e.textRenderer.renderedHeight,a=r+z,o=n+z+R;if(s.cursor.x+a<s.size.width&&s.cursor.y+o<s.size.height)this._addAtlasElement(e,i,a,o),this._elementsToRender.set(i,e),this._elementsToAddOrUpdate.delete(i);else{if(!(s.cursor.y+o+s.lineHeight<s.size.height)){const e=this._getExpectedAtlasUsage(),i=e>A&&s.size.width<y;return i&&this._resizeAtlas(2*s.size.width,2*s.size.height),!t||!i&&e>v&&s.size.width===y?(this._processRemovals(),b.OK):(this._repack(),b.REPACK)}s.cursor.x=z,s.cursor.y+=s.lineHeight,s.lineHeight=0,this._addAtlasElement(e,i,a,o),this._elementsToRender.set(i,e),this._elementsToAddOrUpdate.delete(i)}return b.OK},i._processRemovals=function(){this._elementsToRemove.forEach(((e,t)=>{const s=this._stageObjects.get(t);s&&0!==s.size||this._removeAtlasElement(e),s&&0===s.size&&this._stageObjects.delete(t)})),this._elementsToRemove.clear()},i._repack=function(){this._processRemovals(),this._elements.forEach(((e,t)=>{e.rendered=!1,this._elementsToAddOrUpdate.set(t,e)})),this._elements.clear(),this._resetAtlasCursor(),this._elementsToRender.clear()},i._processRenderingRequest=function(e){this._ctx.clearRect(e.placement.offset.x,e.placement.offset.y,e.placement.size.width,e.placement.size.height),e.textRenderer.render(this._ctx,e.placement.offset.x,e.placement.offset.y);const t=this._stageObjects.get(e.textId);t&&t.forEach((t=>{t.geometries[0].vertexAttributes.get(m.VertexAttribute.UV0).data=new Float32Array(e.placement.uvMinMax),t.geometries[0].vertexAttributes.get(m.VertexAttribute.SIZE).data=[e.placement.size.displayWidth,e.placement.size.displayHeight],t.geometryVertexAttrsUpdated(t.geometryRecords[0])})),e.rendered=!0},i.runTask=function(e,t=!0){if(!this._glTexture)return;let s=!1;if(n.someMap(this._elementsToAddOrUpdate,((e,i)=>{const r=this._elements.get(i);if(r&&r.rendered){const e=this._stageObjects.get(i);return e&&e.forEach((e=>{const t=e.geometries[0].vertexAttributes,s=this._elements.get(i);t.get(m.VertexAttribute.UV0).data=new Float32Array(s.placement.uvMinMax),t.get(m.VertexAttribute.SIZE).data=new Float32Array([s.placement.size.displayWidth,s.placement.size.displayHeight]),e.geometryVertexAttrsUpdated(e.geometryRecords[0])})),this._elementsToAddOrUpdate.delete(i),!1}return this._processAddition(this._elementsToAddOrUpdate.get(i),t)===b.REPACK&&(s=!0,!0)})),s)return void this.runTask(p.noBudget,!1);let i=!1;this._elementsToRender.size>0&&this._needsClear&&(this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height),this._needsClear=!1),n.someMap(this._elementsToRender,((t,s)=>(this._processRenderingRequest(t),this._elementsToRender.delete(s),i=!0,e.madeProgress(),e.done))),i&&o.isSome(this._glTexture)&&this._glTexture.setData(this._canvas),this.updating=this._elementsToRender.size>0,!this.updating&&g.textTextureAtlas.orderedRepackingEnabled&&this.repackOrdered()},i.addTextTexture=function(e,t){const s=e.key;this._elementsToAddOrUpdate.has(s)||this._elementsToAddOrUpdate.set(s,{textId:s,placement:{offset:{x:0,y:0},size:{width:0,height:0,displayWidth:0,displayHeight:0},uvMinMax:[]},textRenderer:e,rendered:!1}),this._addStageObject(s,t),this._elementsToRemove.delete(s),this.setDirty()},i.removeTextTexture=function(e,t){const s=e.key;this._elementsToRemove.set(s,this._elements.get(s)),this._removeStageObject(s,t)},i.setDirty=function(){this._glTexture&&(this.updating=!0)},i.repackOrdered=function(){if(0===this._elements.size)return;const e=[];this._elements.forEach(((t,s)=>e.push({element:t,key:s})));let t=!0;for(let s=0;s<e.length-1;s++)if(e[s].key.localeCompare(e[s+1].key)>0){t=!1;break}if(!t||this._elementsToRemove.size){e.sort(((e,t)=>e.key.localeCompare(t.key))),this._elements.clear();for(const{element:t,key:s}of e)this._elements.set(s,t);this._repack(),this.setDirty()}},t._createClass(s,[{key:"width",get:function(){return this._atlas.size.width}},{key:"height",get:function(){return this._atlas.size.height}},{key:"requiresFrameUpdates",get:function(){return!1}},{key:"glTexture",get:function(){return this._glTexture}},{key:"running",get:function(){return this.updating}},{key:"test",get:function(){const{_elements:e,_stageObjects:t,_elementsToRemove:s,_atlas:i}=this,r=this;return{elements:e,stageObjects:t,elementsToRemove:s,atlas:i,_resizeAtlas:(e,t)=>r._resizeAtlas(e,t),run:(e,t)=>r.runTask(e,t)}}}]),s}(i),s.__decorate([h.property({constructOnly:!0})],e.TextTextureAtlas.prototype,"view",void 0),s.__decorate([h.property({type:Boolean})],e.TextTextureAtlas.prototype,"updating",void 0),e.TextTextureAtlas=s.__decorate([u.subclass("esri.views.3d.webgl-engine.lib.TextTextureAtlas")],e.TextTextureAtlas);const z=2,R=2;var b;!function(e){e[e.OK=0]="OK",e[e.REPACK=1]="REPACK"}(b||(b={})),Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
