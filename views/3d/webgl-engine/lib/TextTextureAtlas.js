// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../core/Accessor","../../../../core/Evented","../../../../core/MapUtils","../../../../core/mathUtils","../../../../core/maybe","../../../../core/accessorSupport/decorators","./Texture","../../../support/Scheduler","../../../webgl/Texture"],(function(e,t,s,r,i,n,a,o,l,h,d,c){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TextTextureAtlas=void 0;var p=function(e){function t(t){var s=e.call(this,t)||this;return s.events=new i,s.glTexture=null,s.dirty=!1,s.needsClear=!1,s.elementsToAddOrUpdate=new Map,s.elementsToRemove=new Map,s.elementsToRender=new Map,s.elements=new Map,s.stageObjects=new Map,s}var r;return s.__extends(t,e),r=t,t.prototype.initialize=function(){this.id=h.idGen.gen(this.idHint),this.stage=this.view._stage,this.canvas=this.create2DCanvas(),this.ctx=this.canvas.getContext("2d"),this.stage.add(4,this);var e=this.computeAtlasResolution(this.view.width,this.view.height);this.createAtlasRegion(e),this.update2DCanvasSize(),this.resetAtlasCursor()},t.prototype.unload=function(){o.isSome(this.glTexture)&&(this.glTexture.dispose(),this.glTexture=null),this.events.emit("unloaded")},Object.defineProperty(t.prototype,"width",{get:function(){return this.atlas.size.width},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return this.atlas.size.height},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"requiresFrameUpdates",{get:function(){return!1},enumerable:!1,configurable:!0}),t.prototype.createDescriptor=function(e){return{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,flipped:!0,samplingMode:9987,hasMipmap:!0,preMultiplyAlpha:!0,maxAnisotropy:e.parameters.maxMaxAnisotropy}},t.prototype.load=function(e){var t=this;if(o.isSome(this.glTexture))return this.glTexture;this.glTexture=new c(e,this.createDescriptor(e),this.canvas);var s=this.view.resourceController.scheduler;return this.frameWorker=s.registerTask(d.Task.TEXT_TEXTURE_ATLAS,(function(e){return t.run(e,!0)}),(function(){return t.dirty})),this.setDirty(),this.glTexture},t.prototype.dispose=function(){this.elements=null,this.elementsToAddOrUpdate=null,this.elementsToRemove=null,this.elementsToRender=null,this.frameWorker&&(this.frameWorker.remove(),this.frameWorker=null),this.glTexture&&(this.stage.remove(4,this.id),this.glTexture=null),this.canvas.width=0,this.canvas.height=0,this.canvas=null,this.ctx=null},t.prototype.create2DCanvas=function(){var e=document.createElement("canvas");return e.setAttribute("id","canvas2d"),e.setAttribute("style","display:none"),e.setAttribute("width",512..toString()),e.setAttribute("height",512..toString()),e},t.prototype.update2DCanvasSize=function(){this.canvas.setAttribute("width",this.atlas.size.width.toString()),this.canvas.setAttribute("height",this.atlas.size.height.toString())},t.prototype.createAtlasRegion=function(e){void 0===e&&(e=512),this.atlas={size:{width:e,height:e},cursor:{x:0,y:0},lineHeight:0}},t.prototype.computeAtlasResolution=function(e,t){var s=Math.max(e,t);return s+=256,s=a.nextHighestPowerOfTwo(s),s=Math.min(s,4096)},t.prototype.resizeAtlas=function(e,t){t=t||e;var s=this.atlas;s.size.width=e,s.size.height=t,o.isSome(this.glTexture)&&this.glTexture.resize(e,t),this.update2DCanvasSize()},t.prototype.resetAtlasCursor=function(){var e=this.atlas;e.cursor.x=u,e.cursor.y=u+m,e.lineHeight=0,this.needsClear=!0},t.prototype.getAtlasUsage=function(){var e=this.atlas;return(e.cursor.x+e.cursor.y*e.size.width)/(e.size.width*e.size.height)},t.prototype.getExpectedAtlasUsage=function(){var e=this.elementsToRemove.size,t=this.elementsToAddOrUpdate.size,s=this.elements.size;return this.getAtlasUsage()/s*(s+t-e)},t.prototype.addAtlasElement=function(e,t,s,r){var i=this.atlas,n=e.textRenderer,a=n.renderedWidth,o=n.renderedHeight,l=n.displayWidth,h=n.displayHeight;e.placement.offset.x=i.cursor.x,e.placement.offset.y=i.cursor.y,e.placement.size.width=a,e.placement.size.height=o,e.placement.size.displayWidth=l,e.placement.size.displayHeight=h,e.placement.uvMinMax=[e.placement.offset.x/i.size.width,1-(e.placement.offset.y+o)/i.size.height,(e.placement.offset.x+a)/i.size.width,1-e.placement.offset.y/i.size.height],i.cursor.x+=s,i.lineHeight=Math.max(i.lineHeight,r),this.elements.set(t,e)},t.prototype.removeAtlasElement=function(e){if(e&&this.elements.has(e.textId)){var t=e.placement.offset,s=e.placement.size;this.ctx.clearRect(t.x,t.y,s.width,s.height),this.elements.delete(e.textId)}},t.prototype.ensureStageObjects=function(e){var t=this.stageObjects.get(e);if(t)return t;var s=new Set;return this.stageObjects.set(e,s),s},t.prototype.addStageObject=function(e,t){this.ensureStageObjects(e).add(t)},t.prototype.removeStageObject=function(e,t){var s=this.stageObjects.get(e);s&&s.delete(t)&&(t.geometries[0].data.vertexAttributes.size.data=new Float32Array([0,0]),t.geometryVertexAttrsUpdated(0))},t.prototype._processAddition=function(e,t){var s=this.atlas,r=e.textId,i=e.textRenderer.renderedWidth,n=e.textRenderer.renderedHeight,a=i+u,o=n+u+m;if(s.cursor.x+a<s.size.width&&s.cursor.y+o<s.size.height)this.addAtlasElement(e,r,a,o),this.elementsToRender.set(r,e),this.elementsToAddOrUpdate.delete(r);else{if(!(s.cursor.y+o+s.lineHeight<s.size.height)){var l=this.getExpectedAtlasUsage(),h=l>.85&&s.size.width<4096;return h&&this.resizeAtlas(2*s.size.width,2*s.size.height),!t||!h&&l>.95&&4096===s.size.width?(this.processRemovals(),0):(this.repack(),1)}s.cursor.x=u,s.cursor.y+=s.lineHeight,s.lineHeight=0,this.addAtlasElement(e,r,a,o),this.elementsToRender.set(r,e),this.elementsToAddOrUpdate.delete(r)}return 0},t.prototype.processRemovals=function(){var e=this;this.elementsToRemove.forEach((function(t,s){var r=e.stageObjects.get(s);r&&0!==r.size||e.removeAtlasElement(t),r&&0===r.size&&e.stageObjects.delete(s)})),this.elementsToRemove.clear()},t.prototype.repack=function(){var e=this;this.processRemovals(),this.elements.forEach((function(t,s){t.rendered=!1,e.elementsToAddOrUpdate.set(s,t)})),this.elements.clear(),this.resetAtlasCursor(),this.elementsToRender.clear()},t.prototype.processRenderingRequest=function(e){this.ctx.clearRect(e.placement.offset.x,e.placement.offset.y,e.placement.size.width,e.placement.size.height),e.textRenderer.render(this.ctx,e.placement.offset.x,e.placement.offset.y);var t=this.stageObjects.get(e.textId);t&&t.forEach((function(t){t.geometries[0].data.vertexAttributes.uv0.data=new Float32Array(e.placement.uvMinMax),t.geometries[0].data.vertexAttributes.size.data=new Float32Array([e.placement.size.displayWidth,e.placement.size.displayHeight]),t.geometryVertexAttrsUpdated(0)})),e.rendered=!0},t.prototype.run=function(e,t){var s=this;if(this.glTexture){var i=!1;if(n.someMap(this.elementsToAddOrUpdate,(function(e,r){var n=s.elements.get(r);if(n&&n.rendered){var a=s.stageObjects.get(r);return a&&a.forEach((function(e){var t=e.geometries[0].data.vertexAttributes,i=s.elements.get(r);t.uv0.data=new Float32Array(i.placement.uvMinMax),t.size.data=new Float32Array([i.placement.size.displayWidth,i.placement.size.displayHeight]),e.geometryVertexAttrsUpdated(0)})),s.elementsToAddOrUpdate.delete(r),!1}return 1===s._processAddition(s.elementsToAddOrUpdate.get(r),t)&&(i=!0,!0)})),i)this.run(d.noBudget,!1);else{var a=!1;this.elementsToRender.size>0&&this.needsClear&&(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.needsClear=!1),n.someMap(this.elementsToRender,(function(t,r){return s.processRenderingRequest(t),s.elementsToRender.delete(r),a=!0,e.madeProgress(),e.done})),a&&o.isSome(this.glTexture)&&this.glTexture.setData(this.canvas),this.dirty=this.elementsToRender.size>0,this.dirty||(r.test.orderedRepackingEnabled&&this.repackOrdered(),this.notifyChange("updating"))}}},t.prototype.addTextTexture=function(e,t){var s=e.key;this.elementsToAddOrUpdate.has(s)||this.elementsToAddOrUpdate.set(s,{textId:s,placement:{offset:{x:0,y:0},size:{width:0,height:0,displayWidth:0,displayHeight:0},uvMinMax:[]},textRenderer:e,rendered:!1}),this.addStageObject(s,t),this.elementsToRemove.delete(s),this.setDirty()},t.prototype.removeTextTexture=function(e,t){var s=e.key;this.elementsToRemove.set(s,this.elements.get(s)),this.removeStageObject(s,t)},Object.defineProperty(t.prototype,"textureId",{get:function(){return this.id},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isDirty",{get:function(){return this.dirty},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"updating",{get:function(){return this.dirty&&!!this.frameWorker},enumerable:!1,configurable:!0}),t.prototype.setDirty=function(){this.dirty||(this.dirty=!0,this.notifyChange("updating"))},t.prototype.repackOrdered=function(){if(0!==this.elements.size){var e=[];this.elements.forEach((function(t,s){return e.push({element:t,key:s})}));for(var t=!0,s=0;s<e.length-1;s++)if(e[s].key.localeCompare(e[s+1].key)>0){t=!1;break}if(!t||this.elementsToRemove.size){e.sort((function(e,t){return e.key.localeCompare(t.key)})),this.elements.clear();for(var r=0,i=e;r<i.length;r++){var n=i[r],a=n.element,o=n.key;this.elements.set(o,a)}this.repack(),this.setDirty()}}},Object.defineProperty(t.prototype,"test",{get:function(){var e=this.elements,t=this.stageObjects,s=this.elementsToRemove,r=this.atlas,i=this;return{elements:e,stageObjects:t,elementsToRemove:s,atlas:r,resizeAtlas:function(e,t){return i.resizeAtlas(e,t)},run:function(e,t){return i.run(e,t)}}},enumerable:!1,configurable:!0}),t.test={orderedRepackingEnabled:!1},s.__decorate([l.property({constructOnly:!0})],t.prototype,"idHint",void 0),s.__decorate([l.property({constructOnly:!0})],t.prototype,"view",void 0),s.__decorate([l.property({type:Boolean,readOnly:!0})],t.prototype,"updating",null),t=r=s.__decorate([l.subclass("esri.views.3d.webgl-engine.lib.TextTextureAtlas")],t)}(r);t.TextTextureAtlas=p;var u=2,m=2;t.default=p}));