// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/extendsHelper","../../../../../core/Evented","../../../../../core/libs/gl-matrix-2/mat3","../../../../../core/libs/gl-matrix-2/mat3f64","../../../../../core/libs/gl-matrix-2/mat4","../../../../../core/libs/gl-matrix-2/mat4f64","../../../../../core/libs/gl-matrix-2/vec3","../../../../../core/libs/gl-matrix-2/vec3f64","../../../support/mathUtils","../../../support/buffer/BufferView","../../../support/buffer/InterleavedLayout","../Util"],function(t,e,r,i,a,o,s,n,f,l,c,u,h,p){function g(t){var e=h.newLayout().mat4f64("localTransform").mat4f64("globalTransform").vec4f64("boundingSphere").vec3f64("modelOrigin").mat3f("model").mat3f("modelNormal").vec2f("modelScaleFactors");return t.indexOf("color")>=0&&(e=e.vec4f("color")),t.indexOf("featureAttribute")>=0&&(e=e.vec4f("featureAttribute")),e=e.u8("state").u8("lodLevel").alignTo(8)}Object.defineProperty(e,"__esModule",{value:!0});var m;!function(t){t[t.ALLOCATED=1]="ALLOCATED",t[t.ACTIVE=2]="ACTIVE",t[t.VISIBLE=4]="VISIBLE",t[t.HIGHLIGHT=8]="HIGHLIGHT",t[t.HIGHLIGHT_ACTIVE=16]="HIGHLIGHT_ACTIVE",t[t.REMOVE=32]="REMOVE",t[t.TRANSFORM_CHANGED=64]="TRANSFORM_CHANGED"}(m=e.StateFlags||(e.StateFlags={}));var d=function(){function t(t){this.localTransform=t.getField("localTransform",u.BufferViewMat4f64),this.globalTransform=t.getField("globalTransform",u.BufferViewMat4f64),this.modelOrigin=t.getField("modelOrigin",u.BufferViewVec3f64),this.model=t.getField("model",u.BufferViewMat3f),this.modelNormal=t.getField("modelNormal",u.BufferViewMat3f),this.modelScaleFactors=t.getField("modelScaleFactors",u.BufferViewVec2f),this.boundingSphere=t.getField("boundingSphere",u.BufferViewVec4f64),this.color=t.getField("color",u.BufferViewVec4f),this.featureAttribute=t.getField("featureAttribute",u.BufferViewVec4f),this.state=t.getField("state",u.BufferViewUint8),this.lodLevel=t.getField("lodLevel",u.BufferViewUint8)}return t}();e.View=d;var v=function(t){function e(e,r){var i=t.call(this)||this;return i._capacity=0,i._size=0,i._next=0,i._layout=g(e),i._shaderTransformation=r,i}return r(e,t),Object.defineProperty(e.prototype,"capacity",{get:function(){return this._capacity},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"size",{get:function(){return this._size},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"buffer",{get:function(){return this._buffer.buffer},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"view",{get:function(){return this._view},enumerable:!0,configurable:!0}),e.prototype.addInstance=function(){this._size+1>this._capacity&&this.grow();var t=this.findSlot();return this._view.state.set(t,m.ALLOCATED),this._size++,this.emit("instance-added",{index:t}),t},e.prototype.removeInstance=function(t){var e=this._view.state;p.assert(t>=0&&t<this._capacity&&e.get(t)&m.ALLOCATED,"invalid instance handle"),this.getStateFlag(t,m.ACTIVE)?this.setStateFlags(t,m.REMOVE):this.freeInstance(t),this.emit("instance-removed",{index:t})},e.prototype.freeInstance=function(t){var e=this._view.state;p.assert(t>=0&&t<this._capacity&&e.get(t)&m.ALLOCATED,"invalid instance handle"),e.set(t,0),this._size--},e.prototype.setLocalTransform=function(t,e,r){void 0===r&&(r=!0),this._view.localTransform.setMat(t,e),r&&this.updateModelTransform(t)},e.prototype.getLocalTransform=function(t,e){this._view.localTransform.getMat(t,e)},e.prototype.setGlobalTransform=function(t,e,r){void 0===r&&(r=!0),this._view.globalTransform.setMat(t,e),r&&this.updateModelTransform(t)},e.prototype.getGlobalTransform=function(t,e){this._view.globalTransform.getMat(t,e)},e.prototype.updateModelTransform=function(t){var e=this._view,r=T,i=b;e.localTransform.getMat(t,w),e.globalTransform.getMat(t,F);var o=s.mat4.multiply(F,F,w);f.vec3.set(r,o[12],o[13],o[14]),e.modelOrigin.setVec(t,r),a.mat3.fromMat4(i,o),e.model.setMat(t,i);var n=c.scaleFromMatrix(T,o);n.sort(),e.modelScaleFactors.set(t,0,n[1]),e.modelScaleFactors.set(t,1,n[2]),a.mat3.invert(i,i),a.mat3.transpose(i,i),e.modelNormal.setMat(t,i),this.setStateFlags(t,m.TRANSFORM_CHANGED),this.emit("instance-transform-changed",{index:t})},e.prototype.getModelTransform=function(t,e){var r=this._view;r.model.getMat(t,b),r.modelOrigin.getVec(t,T),e[0]=b[0],e[1]=b[1],e[2]=b[2],e[3]=0,e[4]=b[3],e[5]=b[4],e[6]=b[5],e[7]=0,e[8]=b[6],e[9]=b[7],e[10]=b[8],e[11]=0,e[12]=T[0],e[13]=T[1],e[14]=T[2],e[15]=1},e.prototype.applyShaderTransformation=function(t,e){this._shaderTransformation&&this._shaderTransformation.applyTransform(this,t,e)},e.prototype.getCombinedModelTransform=function(t,e){return this.getModelTransform(t,e),this._shaderTransformation&&this._shaderTransformation.applyTransform(this,t,e),e},e.prototype.getCombinedLocalTransform=function(t,e){return this._view.localTransform.getMat(t,e),this._shaderTransformation&&this._shaderTransformation.applyTransform(this,t,e),e},e.prototype.getCombinedMaxScaleFactor=function(t){var e=this._view.modelScaleFactors.get(t,1);if(this._shaderTransformation){var r=this._shaderTransformation.scaleFactor(T,this,t);e*=Math.max(r[0],r[1],r[2])}return e},e.prototype.getCombinedMedianScaleFactor=function(t){var e=this._view.modelScaleFactors.get(t,0);if(this._shaderTransformation){var r=this._shaderTransformation.scaleFactor(T,this,t);r.sort(),e*=r[1]}return e},e.prototype.getModel=function(t,e){this._view.model.getMat(t,e)},e.prototype.setFeatureAttribute=function(t,e){this._view.featureAttribute.setVec(t,e)},e.prototype.getFeatureAttribute=function(t,e){this._view.featureAttribute.getVec(t,e)},e.prototype.setColor=function(t,e){this._view.color.setVec(t,e)},e.prototype.getColor=function(t,e){this._view.color.getVec(t,e)},e.prototype.setVisible=function(t,e){e!==this.getVisible(t)&&(this.setStateFlag(t,m.VISIBLE,e),this.emit("instance-visibility-changed",{index:t}))},e.prototype.getVisible=function(t){return this.getStateFlag(t,m.VISIBLE)},e.prototype.setHighlight=function(t,e){e!==this.getHighlight(t)&&(this.setStateFlag(t,m.HIGHLIGHT,e),this.emit("instance-highlight-changed",{index:t}))},e.prototype.getHighlight=function(t){return this.getStateFlag(t,m.HIGHLIGHT)},e.prototype.getState=function(t){return this._view.state.get(t)},e.prototype.getLodLevel=function(t){return this._view.lodLevel.get(t)},e.prototype.countFlags=function(t){for(var e=0,r=0;r<this._capacity;++r){this.getState(r)&t&&++e}return e},e.prototype.setStateFlags=function(t,e){var r=this._view.state;e=r.get(t)|e,r.set(t,e)},e.prototype.clearStateFlags=function(t,e){var r=this._view.state;e=r.get(t)&~e,r.set(t,e)},e.prototype.setStateFlag=function(t,e,r){r?this.setStateFlags(t,e):this.clearStateFlags(t,e)},e.prototype.getStateFlag=function(t,e){return!!(this._view.state.get(t)&e)},e.prototype.grow=function(){var t=Math.max(_,Math.floor(this._capacity*y)),e=this._layout.createBuffer(t);if(this._buffer){var r=new Uint8Array(this._buffer.buffer);new Uint8Array(e.buffer).set(r)}this._capacity=t,this._buffer=e,this._view=new d(this._buffer)},e.prototype.findSlot=function(){for(var t=this._view.state,e=this._next;t.get(e)&m.ALLOCATED;)e=(e+1)%this._capacity;return this._next=(e+1)%this._capacity,e},e}(i);e.InstanceData=v;var _=1024,y=2,T=l.vec3f64.create(),b=o.mat3f64.create(),w=n.mat4f64.create(),F=n.mat4f64.create()});