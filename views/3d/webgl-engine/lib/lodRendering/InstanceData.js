// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../../core/Evented","../../../../../core/libs/gl-matrix-2/mat3","../../../../../core/libs/gl-matrix-2/mat3f64","../../../../../core/libs/gl-matrix-2/mat4","../../../../../core/libs/gl-matrix-2/mat4f64","../../../../../core/libs/gl-matrix-2/vec3","../../../../../core/libs/gl-matrix-2/vec3f64","../../../support/mathUtils","../../../support/buffer/BufferView","../../../support/buffer/InterleavedLayout","../Util"],(function(t,e,i,r,a,o,s,n,f,l,c,h,u,g){"use strict";var p;Object.defineProperty(e,"__esModule",{value:!0}),e.InstanceData=e.View=e.StateFlags=void 0,function(t){t[t.ALLOCATED=1]="ALLOCATED",t[t.ACTIVE=2]="ACTIVE",t[t.VISIBLE=4]="VISIBLE",t[t.HIGHLIGHT=8]="HIGHLIGHT",t[t.HIGHLIGHT_ACTIVE=16]="HIGHLIGHT_ACTIVE",t[t.REMOVE=32]="REMOVE",t[t.TRANSFORM_CHANGED=64]="TRANSFORM_CHANGED"}(p=e.StateFlags||(e.StateFlags={}));var m=function(t){this.localTransform=t.getField("localTransform",h.BufferViewMat4f64),this.globalTransform=t.getField("globalTransform",h.BufferViewMat4f64),this.modelOrigin=t.getField("modelOrigin",h.BufferViewVec3f64),this.model=t.getField("model",h.BufferViewMat3f),this.modelNormal=t.getField("modelNormal",h.BufferViewMat3f),this.modelScaleFactors=t.getField("modelScaleFactors",h.BufferViewVec2f),this.boundingSphere=t.getField("boundingSphere",h.BufferViewVec4f64),this.color=t.getField("color",h.BufferViewVec4f),this.featureAttribute=t.getField("featureAttribute",h.BufferViewVec4f),this.state=t.getField("state",h.BufferViewUint8),this.lodLevel=t.getField("lodLevel",h.BufferViewUint8)};e.View=m;var d=function(t){function e(e,i){var r=t.call(this)||this;return r._capacity=0,r._size=0,r._next=0,r._layout=function(t){var e=u.newLayout().mat4f64("localTransform").mat4f64("globalTransform").vec4f64("boundingSphere").vec3f64("modelOrigin").mat3f("model").mat3f("modelNormal").vec2f("modelScaleFactors");return t.indexOf("color")>=0&&(e=e.vec4f("color")),t.indexOf("featureAttribute")>=0&&(e=e.vec4f("featureAttribute")),e=e.u8("state").u8("lodLevel").alignTo(8)}(e),r._shaderTransformation=i,r}return i.__extends(e,t),Object.defineProperty(e.prototype,"capacity",{get:function(){return this._capacity},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"size",{get:function(){return this._size},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"buffer",{get:function(){return this._buffer.buffer},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"view",{get:function(){return this._view},enumerable:!1,configurable:!0}),e.prototype.addInstance=function(){this._size+1>this._capacity&&this.grow();var t=this.findSlot();return this._view.state.set(t,p.ALLOCATED),this._size++,this.emit("instance-added",{index:t}),t},e.prototype.removeInstance=function(t){var e=this._view.state;g.assert(t>=0&&t<this._capacity&&e.get(t)&p.ALLOCATED,"invalid instance handle"),this.getStateFlag(t,p.ACTIVE)?this.setStateFlags(t,p.REMOVE):this.freeInstance(t),this.emit("instance-removed",{index:t})},e.prototype.freeInstance=function(t){var e=this._view.state;g.assert(t>=0&&t<this._capacity&&e.get(t)&p.ALLOCATED,"invalid instance handle"),e.set(t,0),this._size--},e.prototype.setLocalTransform=function(t,e,i){void 0===i&&(i=!0),this._view.localTransform.setMat(t,e),i&&this.updateModelTransform(t)},e.prototype.getLocalTransform=function(t,e){this._view.localTransform.getMat(t,e)},e.prototype.setGlobalTransform=function(t,e,i){void 0===i&&(i=!0),this._view.globalTransform.setMat(t,e),i&&this.updateModelTransform(t)},e.prototype.getGlobalTransform=function(t,e){this._view.globalTransform.getMat(t,e)},e.prototype.updateModelTransform=function(t){var e=this._view,i=y,r=T;e.localTransform.getMat(t,b),e.globalTransform.getMat(t,w);var o=s.mat4.multiply(w,w,b);f.vec3.set(i,o[12],o[13],o[14]),e.modelOrigin.setVec(t,i),a.mat3.fromMat4(r,o),e.model.setMat(t,r);var n=c.scaleFromMatrix(y,o);n.sort(),e.modelScaleFactors.set(t,0,n[1]),e.modelScaleFactors.set(t,1,n[2]),a.mat3.invert(r,r),a.mat3.transpose(r,r),e.modelNormal.setMat(t,r),this.setStateFlags(t,p.TRANSFORM_CHANGED),this.emit("instance-transform-changed",{index:t})},e.prototype.getModelTransform=function(t,e){var i=this._view;i.model.getMat(t,T),i.modelOrigin.getVec(t,y),e[0]=T[0],e[1]=T[1],e[2]=T[2],e[3]=0,e[4]=T[3],e[5]=T[4],e[6]=T[5],e[7]=0,e[8]=T[6],e[9]=T[7],e[10]=T[8],e[11]=0,e[12]=y[0],e[13]=y[1],e[14]=y[2],e[15]=1},e.prototype.applyShaderTransformation=function(t,e){this._shaderTransformation&&this._shaderTransformation.applyTransform(this,t,e)},e.prototype.getCombinedModelTransform=function(t,e){return this.getModelTransform(t,e),this._shaderTransformation&&this._shaderTransformation.applyTransform(this,t,e),e},e.prototype.getCombinedLocalTransform=function(t,e){return this._view.localTransform.getMat(t,e),this._shaderTransformation&&this._shaderTransformation.applyTransform(this,t,e),e},e.prototype.getCombinedMaxScaleFactor=function(t){var e=this._view.modelScaleFactors.get(t,1);if(this._shaderTransformation){var i=this._shaderTransformation.scaleFactor(y,this,t);e*=Math.max(i[0],i[1],i[2])}return e},e.prototype.getCombinedMedianScaleFactor=function(t){var e=this._view.modelScaleFactors.get(t,0);if(this._shaderTransformation){var i=this._shaderTransformation.scaleFactor(y,this,t);i.sort(),e*=i[1]}return e},e.prototype.getModel=function(t,e){this._view.model.getMat(t,e)},e.prototype.setFeatureAttribute=function(t,e){this._view.featureAttribute.setVec(t,e)},e.prototype.getFeatureAttribute=function(t,e){this._view.featureAttribute.getVec(t,e)},e.prototype.setColor=function(t,e){this._view.color.setVec(t,e)},e.prototype.getColor=function(t,e){this._view.color.getVec(t,e)},e.prototype.setVisible=function(t,e){e!==this.getVisible(t)&&(this.setStateFlag(t,p.VISIBLE,e),this.emit("instance-visibility-changed",{index:t}))},e.prototype.getVisible=function(t){return this.getStateFlag(t,p.VISIBLE)},e.prototype.setHighlight=function(t,e){e!==this.getHighlight(t)&&(this.setStateFlag(t,p.HIGHLIGHT,e),this.emit("instance-highlight-changed",{index:t}))},e.prototype.getHighlight=function(t){return this.getStateFlag(t,p.HIGHLIGHT)},e.prototype.getState=function(t){return this._view.state.get(t)},e.prototype.getLodLevel=function(t){return this._view.lodLevel.get(t)},e.prototype.countFlags=function(t){for(var e=0,i=0;i<this._capacity;++i){this.getState(i)&t&&++e}return e},e.prototype.setStateFlags=function(t,e){var i=this._view.state;e=i.get(t)|e,i.set(t,e)},e.prototype.clearStateFlags=function(t,e){var i=this._view.state;e=i.get(t)&~e,i.set(t,e)},e.prototype.setStateFlag=function(t,e,i){i?this.setStateFlags(t,e):this.clearStateFlags(t,e)},e.prototype.getStateFlag=function(t,e){return!!(this._view.state.get(t)&e)},e.prototype.grow=function(){var t=Math.max(v,Math.floor(this._capacity*_)),e=this._layout.createBuffer(t);if(this._buffer){var i=new Uint8Array(this._buffer.buffer);new Uint8Array(e.buffer).set(i)}this._capacity=t,this._buffer=e,this._view=new m(this._buffer)},e.prototype.findSlot=function(){for(var t=this._view.state,e=this._next;t.get(e)&p.ALLOCATED;)e=(e+1)%this._capacity;return this._next=(e+1)%this._capacity,e},e}(r);e.InstanceData=d;var v=1024,_=2,y=l.vec3f64.create(),T=o.mat3f64.create(),b=n.mat4f64.create(),w=n.mat4f64.create()}));