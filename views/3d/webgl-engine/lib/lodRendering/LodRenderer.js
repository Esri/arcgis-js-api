/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/promiseUtils","../../../../../chunks/mat4f64","../../../../../chunks/vec2f64","../../../../../chunks/vec3","../../../../../chunks/vec3f64","../../../../../chunks/vec4f64","../../../support/debugFlags","../../../support/buffer/glUtil","../../core/shaderLibrary/output/OutputHighlight.glsl","../Camera","../DefaultVertexAttributeLocations","../Util","./InstanceData","./InstanceOctree","./LevelSelector","./LodLevel","./RenderInstanceData","../../materials/DefaultMaterial","../../materials/internal/MaterialUtil","../../materials/renderers/utils","../../../../webgl/Util"],(function(e,t,n,a,s,i,r,l,c,o,h,u,d,f,g,p,_,m,y,D,I,v,b){"use strict";let C=function(e){const t=e.baseBoundingSphere.radius,n=e.levels.map((e=>e.minScreenSpaceRadius));return new _.LevelSelector(t,n)};function R(e){C=e}let E=function(){function e(e,t,n,a){this.type="Lod",this.isGround=!1,this._inverseViewport=s.create(),this._levels=[],this._defaultRenderInstanceData=[],this._highlightRenderInstanceData=[],this._instanceIndex=0,this._slicePlane=!1,this._enableLevelSelection=!0,this._lastCamera=new u,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.canRender=!0,this._symbol=e,this._optionalFields=t,this._metadata=n,this._instanceBufferLayout=D.DefaultMaterial.getInstanceBufferLayout({instancedDoublePrecision:!0,instanced:t}),this._glInstanceBufferLayout=o.glLayout(this._instanceBufferLayout,1),this._instanceData=new g.InstanceData(this._optionalFields,a),this._instanceData.on("instance-added",(()=>{this.requestUpdateCycle()})),this._instanceData.on("instance-removed",(()=>{this.requestUpdateCycle()})),this._instanceData.on("instance-transform-changed",(e=>{this.requestUpdateCycle(),this._metadata.notifyGraphicGeometryChanged(e.index)})),this._instanceData.on("instance-visibility-changed",(e=>{this.requestUpdateCycle(!0),this._metadata.notifyGraphicVisibilityChanged(e.index)})),this._instanceData.on("instance-highlight-changed",(()=>{this.requestUpdateCycle(!0)})),this._enableLevelSelection=this._symbol.levels.length>1}var a=e.prototype;return a.initializeRenderContext=function(){var e=t._asyncToGenerator((function*(e,t){this._context=e;const a=e.renderContext.rctx;this._levels=yield n.all(this._symbol.levels.map((n=>(this._defaultRenderInstanceData.push(new y.RenderInstanceData(a,this._instanceBufferLayout)),this._highlightRenderInstanceData.push(new y.RenderInstanceData(a,this._instanceBufferLayout)),m.LodLevel.create(e,n,t))))),this._levelSelector=C(this)}));function a(t,n){return e.apply(this,arguments)}return a}(),a.uninitializeRenderContext=function(){this.invalidateOctree(),this._levels.forEach((e=>e.destroy())),this._defaultRenderInstanceData.forEach((e=>e.destroy())),this._highlightRenderInstanceData.forEach((e=>e.destroy()))},a.prepareRender=function(e,t){if(c.LOD_INSTANCE_RENDERER_DISABLE_UPDATES)return;if(this._enableLevelSelection){const e=t.equals(this._lastCamera);this._lastCamera.copyFrom(t),e||this.requestUpdateCycle()}const n=this._needFullCycle?this._instanceData.size:2e3;this._needFullCycle=!1,this.updateInstances(t,n),this.needsUpdates&&this._context.requestRender()},a.render=function(e){const t=e.rctx,n=4===e.slot?3:6===e.slot?5:null;if(!n)return;if(!this.baseMaterial.isVisible()||!this.baseMaterial.isVisibleInPass(e.pass))return!1;const a=e.camera;this._inverseViewport[0]=1/a.fullViewport[2],this._inverseViewport[1]=1/a.fullViewport[3];const s={slot:n,origin:[0,0,0],camera:a,inverseViewport:this._inverseViewport,shadowMap:e.shadowMap,shadowMappingEnabled:e.shadowMap.enabled,ssaoHelper:e.ssaoHelper,ssaoEnabled:e.ssaoHelper.enabled,screenToWorldRatio:null,screenToPCSRatio:null,slicePlane:e.sliceHelper&&e.sliceHelper.plane,hudVisibilityTexture:e.offscreenRenderingHelper?e.offscreenRenderingHelper.hudVisibilityTexture:null,highlightDepthTexture:e.offscreenRenderingHelper?e.offscreenRenderingHelper.depthTexture:null,hasOccludees:!1,linearDepthTexture:null,lastFrameColorTexture:null,reprojectionMat:null,ssrEnabled:!1,lighting:e.scenelightingData,transparencyPassType:e.transparencyPassType,terrainLinearDepthTexture:e.multipassTerrainParams.terrainLinearDepthTexture,geometryLinearDepthTexture:e.multipassGeometryParams.geometryLinearDepthTexture,multipassTerrainEnabled:e.multipassTerrainParams.multipassTerrainEnabled,cullAboveGround:e.multipassTerrainParams.cullAboveGround,multipassGeometryEnabled:e.multipassGeometryParams.multipassGeometryEnabled,highlightColorTexture:null};t.bindVAO();const i=5!==e.pass&&7!==e.pass,r=6!==e.pass;return i&&this._renderComponents(e,n,s,this._defaultRenderInstanceData),r&&this._renderComponents(e,n,s,this._highlightRenderInstanceData),!0},a.intersect=function(e,t,n,a){if(!this.baseMaterial.isVisible())return;const s=r.create();i.subtract(s,a,n);const l=s=>{this._instanceData.getCombinedModelTransform(s,F),e.transform.set(F),i.transformMat4(A,n,e.transform.inverse),i.transformMat4(V,a,e.transform.inverse);const r=this._instanceData.getState(s),l=this._instanceData.getLodLevel(s);f.assert(r&g.StateFlags.ACTIVE,"invalid instance state"),f.assert(l>=0&&l<this._levels.length,"invaid lod level"),this._levels[l].intersect(e,t,A,V,s,this._metadata)};this.baseMaterial.params.verticalOffset?this.octree.forEach(l):this.octree.forEachAlongRay(n,s,l)},a.queryDepthRange=function(e){return this.queryDepthRangeOctree(e)},a.notifyShaderTransformationChanged=function(){this.invalidateOctree()},a.requestUpdateCycle=function(e=!1){this._updateCyclesWithStaticCamera=-1,e&&(this._needFullCycle=!0),this.needsUpdates&&this._context.requestRender()},a.invalidateOctree=function(){this._octree&&(this._octree.destroy(),this._octree=null)},a.buildOctree=function(){const e=new p.InstanceOctree(this._instanceData,this.baseBoundingSphere),t=this._instanceData,n=t.view?t.view.state:null;for(let a=0;a<this._instanceData.capacity;++a){n.get(a)&g.StateFlags.ACTIVE&&e.addInstance(a)}return e},a.queryDepthRangeOctree=function(e){const t=e.eye,n=e.viewForward,a=this.octree.findClosest(n,1,e.frustum),s=this.octree.findClosest(n,-1,e.frustum);if(null!=a&&null!=s){this._instanceData.view.boundingSphere.getVec(a,x),i.subtract(x,x,t);const r=i.dot(x,n)-x[3];this._instanceData.view.boundingSphere.getVec(s,x),i.subtract(x,x,t);const l=i.dot(x,n)+x[3];return{near:Math.max(e.near,r),far:Math.min(e.far,l)}}return{near:1/0,far:-1/0}},a.startUpdateCycle=function(){this._updateCyclesWithStaticCamera++,this._defaultRenderInstanceData.forEach((e=>{e.startUpdateCylce()})),this._highlightRenderInstanceData.forEach((e=>{e.startUpdateCylce()})),this.needsUpdates&&this._context.requestRender()},a.updateInstances=function(e,t){const n=this._enableLevelSelection,a=this._levelSelector;a.updateCamera(e),this._defaultRenderInstanceData.forEach((e=>{e.beginUpdate()})),this._highlightRenderInstanceData.forEach((e=>{e.beginUpdate()}));const s=this._instanceData,i=this._instanceData.view,r=s.size,l=s.capacity;let c=this._instanceIndex;t=Math.min(r,t);for(let o=0;o<t;++o){0===c&&this.startUpdateCycle();const e=i.state.get(c);let r=0;if(!(e&g.StateFlags.ALLOCATED)){c=(c+1)%l,t++;continue}const o=i.lodLevel.get(c);if(e&g.StateFlags.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[o].freeTail(),e&g.StateFlags.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[o].freeTail(),e&g.StateFlags.REMOVE)s.freeInstance(c);else if(e&g.StateFlags.VISIBLE){let t=0;n&&(i.modelOrigin.getVec(c,L),t=a.selectLevel(L,s.getCombinedMedianScaleFactor(c))),r=e&~(g.StateFlags.ACTIVE|g.StateFlags.TRANSFORM_CHANGED),t>=0&&(e&g.StateFlags.HIGHLIGHT?(S(this._highlightRenderInstanceData[t],i,c),r|=g.StateFlags.HIGHLIGHT_ACTIVE):(S(this._defaultRenderInstanceData[t],i,c),r|=g.StateFlags.DEFAULT_ACTIVE)),i.state.set(c,r),i.lodLevel.set(c,t)}else r=e&~(g.StateFlags.ACTIVE|g.StateFlags.TRANSFORM_CHANGED),i.state.set(c,r);if(this._octree){const t=!!(e&g.StateFlags.ACTIVE),n=!!(r&g.StateFlags.ACTIVE);!t&&n?this._octree.addInstance(c):t&&!n?this._octree.removeInstance(c):t&&n&&e&g.StateFlags.TRANSFORM_CHANGED&&(this._octree.removeInstance(c),this._octree.addInstance(c))}c=(c+1)%l}this._instanceIndex=c,this._defaultRenderInstanceData.forEach((e=>{e.endUpdate()})),this._highlightRenderInstanceData.forEach((e=>{e.endUpdate()}))},a._renderComponents=function(e,t,n,a){this.levels.forEach(((s,i)=>{s.components.forEach((s=>{this._renderComponent(e,t,n,a[i],s,i)}))}))},a._renderComponent=function(e,t,n,a,s,i){const r=s.glMaterials.get(e.pass);if(!r||!r.beginSlot(t)||0===a.size)return;const l=e.rctx,o=l.capabilities.instancing;r.ensureParameters(n);const u=r.technique,g=u.program,p=r.getPipelineState(t);l.setPipelineState(p),l.useProgram(g),r.bind(n),l.bindVAO(s.vao),u.ensureAttributeLocations(s.vao),e.isHighlightPass&&h.bindOutputHighlight(g,n),u.bindDraw(n,{},{}),c.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&0===e.pass&&(g.setUniform4fv("externalColor",U[Math.min(i,U.length-1)]),g.setUniform1i("colorMixMode",I.colorMixModes.replace));const _=a.capacity,m=a.headIndex,y=a.tailIndex,D=a.firstIndex,v=this._glInstanceBufferLayout,C=(e,t)=>{b.bindVertexBufferLayout(l,d.Default3D,a.buffer,v,e),o.drawArraysInstanced(u.primitiveType,0,s.vertexCount,t-e),b.unbindVertexBufferLayout(l,d.Default3D,a.buffer,v)};s.material.params.transparent&&null!=D?m>y?(f.assert(D>=y&&D<=m,"invalid firstIndex"),C(D,m),C(y,D)):m<y&&(D<=m?(f.assert(D>=0&&D<=m,"invalid firstIndex"),C(D,m),C(y,_),C(0,D)):(f.assert(D>=y&&D<=_,"invalid firstIndex"),C(D,_),C(0,m),C(y,D))):m>y?C(y,m):m<y&&(C(0,m),C(y,_)),l.bindVAO(null)},t._createClass(e,[{key:"levels",get:function(){return this._levels}},{key:"baseBoundingBox",get:function(){return this._levels[this._levels.length-1].boundingBox}},{key:"baseBoundingSphere",get:function(){return this._levels[this._levels.length-1].boundingSphere}},{key:"baseMaterial",get:function(){return this._levels[this._levels.length-1].components[0].material}},{key:"slicePlane",get:function(){return this._slicePlane},set:function(e){this._slicePlane=e}},{key:"intersectionHandlerId",get:function(){return this._metadata.layerUid}},{key:"instanceData",get:function(){return this._instanceData}},{key:"memoryUsage",get:function(){const e={cpu:0,gpu:0};return this._defaultRenderInstanceData.forEach((t=>{const n=t.memoryUsage;e.cpu+=n.cpu,e.gpu+=n.gpu})),this._highlightRenderInstanceData.forEach((t=>{const n=t.memoryUsage;e.cpu+=n.cpu,e.gpu+=n.gpu})),e}},{key:"renderStats",get:function(){const e=this._instanceData.size,t=[];return this._levels.forEach(((e,n)=>{const a=this._defaultRenderInstanceData[n],s=this._highlightRenderInstanceData[n],i=a.size+s.size,r=e.triangleCount;t.push({renderedInstances:i,renderedTriangles:i*r,trianglesPerInstance:r})})),{totalInstances:e,renderedInstances:t.reduce(((e,t)=>e+t.renderedInstances),0),renderedTriangles:t.reduce(((e,t)=>e+t.renderedTriangles),0),levels:t}}},{key:"slots",get:function(){return[4,6]}},{key:"needsHighlight",get:function(){return this._highlightRenderInstanceData.reduce(((e,t)=>e+t.size),0)>0}},{key:"needsUpdates",get:function(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}},{key:"octree",get:function(){return this._octree||(this._octree=this.buildOctree()),this._octree}}]),e}();function S(e,t,n){const a=e.allocateHead();T(t,n,e.view,a)}function T(e,t,n,a){v.encodeDoubleVec3(e.modelOrigin,t,n.modelOriginHi,n.modelOriginLo,a),n.model.copyFrom(a,e.model,t),n.modelNormal.copyFrom(a,e.modelNormal,t),e.color&&n.color&&n.color.copyFrom(a,e.color,t),e.featureAttribute&&n.featureAttribute&&n.featureAttribute.copyFrom(a,e.featureAttribute,t)}const L=r.create(),x=l.create(),F=a.create(),A=r.create(),V=r.create(),U=[[1,0,1,1],[0,0,1,1],[0,1,0,1],[1,1,0,1],[1,0,0,1]];e.LodRenderer=E,e.setLevelSelectorFactory=R,Object.defineProperty(e,"__esModule",{value:!0})}));
