/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/maybe","../../../../../core/promiseUtils","../../../../../chunks/mat4f64","../../../../../chunks/vec2f64","../../../../../chunks/vec3","../../../../../chunks/vec3f64","../../../../../chunks/vec4f64","../../../support/debugFlags","../../../support/buffer/glUtil","../../core/shaderLibrary/output/OutputHighlight.glsl","../Camera","../DefaultVertexAttributeLocations","../IntersectorInterfaces","../Octree","../RenderPass","../RenderSlot","../Util","./InstanceData","./InstanceOctree","./LevelSelector","./LodLevel","./RenderInstanceData","../../materials/DefaultMaterial","../../materials/internal/MaterialUtil","../../materials/renderers/utils","../../../../webgl/Util"],(function(e,t,n,a,s,i,r,l,o,c,h,d,u,_,f,g,p,m,I,y,D,R,v,T,b,E,A,S){"use strict";let C=function(e){const t=e.baseBoundingSphere.radius,n=e.levels.map((e=>e.minScreenSpaceRadius));return new R.LevelSelector(t,n)};function L(e){C=e}let x=function(){function e(e,t,n,a){this.type=f.IntersectorType.LOD,this.isGround=!1,this._inverseViewport=i.create(),this._levels=[],this._defaultRenderInstanceData=[],this._highlightRenderInstanceData=[],this._instanceIndex=0,this._slicePlane=!1,this._enableLevelSelection=!0,this._lastCamera=new u.default,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.slots=[m.RenderSlot.OPAQUE_PLUGIN,m.RenderSlot.TRANSPARENT_PLUGIN],this.canRender=!0,this._symbol=e,this._optionalFields=t,this._metadata=n,this._instanceBufferLayout=b.getInstanceBufferLayout({instancedDoublePrecision:!0,instanced:t}),this._glInstanceBufferLayout=h.glLayout(this._instanceBufferLayout,1),this._instanceData=new y.InstanceData(this._optionalFields,a),this._instanceData.on("instance-added",(()=>this._requestUpdateCycle())),this._instanceData.on("instance-removed",(()=>this._requestUpdateCycle())),this._instanceData.on("instance-transform-changed",(e=>{this._requestUpdateCycle(),this._metadata.notifyGraphicGeometryChanged(e.index)})),this._instanceData.on("instance-visibility-changed",(e=>{this._requestUpdateCycle(!0),this._metadata.notifyGraphicVisibilityChanged(e.index)})),this._instanceData.on("instance-highlight-changed",(()=>this._requestUpdateCycle(!0))),this._enableLevelSelection=this._symbol.levels.length>1}var o=e.prototype;return o.initializeRenderContext=function(){var e=t._asyncToGenerator((function*(e,t){this._context=e;const n=e.renderContext.rctx,s=yield Promise.allSettled(this._symbol.levels.map((a=>(this._defaultRenderInstanceData.push(new T.RenderInstanceData(n,this._instanceBufferLayout)),this._highlightRenderInstanceData.push(new T.RenderInstanceData(n,this._instanceBufferLayout)),v.LodLevel.create(e,a,t))))),i=s.map((e=>"fulfilled"===e.status?e.value:null)).filter((e=>e));if(a.isAborted(t)||i.length!==s.length){i.forEach((e=>e.destroy())),a.throwIfAborted(t);for(const e of s)if("rejected"===e.status)throw e.reason}this._levels=i,this._levelSelector=C(this)}));function n(t,n){return e.apply(this,arguments)}return n}(),o.uninitializeRenderContext=function(){this._invalidateOctree(),this._levels.forEach((e=>e.destroy())),this._defaultRenderInstanceData.forEach((e=>e.destroy())),this._highlightRenderInstanceData.forEach((e=>e.destroy()))},o.prepareRender=function(e,t){if(c.LOD_INSTANCE_RENDERER_DISABLE_UPDATES)return;if(this._enableLevelSelection){const e=t.equals(this._lastCamera);this._lastCamera.copyFrom(t),e||this._requestUpdateCycle()}const n=this._needFullCycle?this._instanceData.size:2e3;this._needFullCycle=!1,this._updateInstances(t,n),this.needsUpdates&&this._context.requestRender()},o.render=function(e){var t,n,a,i;const r=e.slot===m.RenderSlot.OPAQUE_PLUGIN?m.RenderSlot.OPAQUE_MATERIAL:e.slot===m.RenderSlot.TRANSPARENT_PLUGIN?m.RenderSlot.TRANSPARENT_MATERIAL:null;if(!r||!this.baseMaterial.isVisible()||!this.baseMaterial.isVisibleInPass(e.pass))return;const l=e.camera;this._inverseViewport[0]=1/l.fullViewport[2],this._inverseViewport[1]=1/l.fullViewport[3];const o={slot:r,origin:[0,0,0],camera:l,inverseViewport:this._inverseViewport,shadowMap:e.shadowMap,shadowMappingEnabled:e.shadowMap.enabled,ssaoHelper:e.ssaoHelper,ssaoEnabled:e.ssaoHelper.enabled,screenToWorldRatio:null,screenToPCSRatio:null,slicePlane:e.sliceHelper&&e.sliceHelper.plane,hudVisibilityTexture:null!=(t=null==(n=e.offscreenRenderingHelper)?void 0:n.hudVisibilityTexture)?t:null,highlightDepthTexture:null!=(a=null==(i=e.offscreenRenderingHelper)?void 0:i.depthTexture)?a:null,hasOccludees:!1,linearDepthTexture:null,lastFrameColorTexture:null,reprojectionMatrix:s.IDENTITY,ssrEnabled:!1,lighting:e.scenelightingData,transparencyPassType:e.transparencyPassType,terrainLinearDepthTexture:e.multipassTerrainParams.terrainLinearDepthTexture,geometryLinearDepthTexture:e.multipassGeometryParams.geometryLinearDepthTexture,multipassTerrainEnabled:e.multipassTerrainParams.multipassTerrainEnabled,cullAboveGround:e.multipassTerrainParams.cullAboveGround,multipassGeometryEnabled:e.multipassGeometryParams.multipassGeometryEnabled,highlightColorTexture:null,cloudsCompositionParams:null,hasFillLights:e.hasFillLights};e.rctx.bindVAO();const c=e.pass!==p.RenderPass.MATERIAL_HIGHLIGHT&&e.pass!==p.RenderPass.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT,h=e.pass!==p.RenderPass.MATERIAL_DEPTH_SHADOWMAP_DEFAULT;c&&this._renderComponents(e,r,o,this._defaultRenderInstanceData),h&&this._renderComponents(e,r,o,this._highlightRenderInstanceData)},o.intersect=function(e,t,n,a){if(!this.baseMaterial.isVisible())return;const s=l.create();r.subtract(s,a,n);const i=s=>{this._instanceData.getCombinedModelTransform(s,M),e.transform.set(M),r.transformMat4(H,n,e.transform.inverse),r.transformMat4(V,a,e.transform.inverse);const i=this._instanceData.getState(s),l=this._instanceData.getLodLevel(s);I.assert(i&y.StateFlags.ACTIVE,"invalid instance state"),I.assert(l>=0&&l<this._levels.length,"invaid lod level"),this._levels[l].intersect(e,t,H,V,s,this._metadata)};this.baseMaterial.parameters.verticalOffset?this.octree.forEach(i):this.octree.forEachAlongRay(n,s,i)},o.queryDepthRange=function(e){return this._queryDepthRangeOctree(e)},o.notifyShaderTransformationChanged=function(){this._invalidateOctree()},o._requestUpdateCycle=function(e=!1){this._updateCyclesWithStaticCamera=-1,e&&(this._needFullCycle=!0),this.needsUpdates&&this._context.requestRender()},o._invalidateOctree=function(){this._octree&&(this._octree.destroy(),this._octree=null)},o._buildOctree=function(){const e=new D.InstanceOctree(this._instanceData,this.baseBoundingSphere),t=this._instanceData,n=t.view?t.view.state:null;for(let a=0;a<this._instanceData.capacity;++a){n.get(a)&y.StateFlags.ACTIVE&&e.addInstance(a)}return e},o._queryDepthRangeOctree=function(e){const t=e.eye,n=e.viewForward,a=this.octree.findClosest(n,g.DepthOrder.FRONT_TO_BACK,e.frustum),s=this.octree.findClosest(n,g.DepthOrder.BACK_TO_FRONT,e.frustum);if(null!=a&&null!=s){this._instanceData.view.boundingSphere.getVec(a,U),r.subtract(U,U,t);const i=r.dot(U,n)-U[3];this._instanceData.view.boundingSphere.getVec(s,U),r.subtract(U,U,t);const l=r.dot(U,n)+U[3];return{near:Math.max(e.near,i),far:Math.min(e.far,l)}}return{near:1/0,far:-1/0}},o._startUpdateCycle=function(){this._updateCyclesWithStaticCamera++,this._defaultRenderInstanceData.forEach((e=>{e.startUpdateCylce()})),this._highlightRenderInstanceData.forEach((e=>{e.startUpdateCylce()})),this.needsUpdates&&this._context.requestRender()},o._updateInstances=function(e,t){const n=this._enableLevelSelection,a=this._levelSelector;a.updateCamera(e),this._defaultRenderInstanceData.forEach((e=>{e.beginUpdate()})),this._highlightRenderInstanceData.forEach((e=>{e.beginUpdate()}));const s=this._instanceData,i=this._instanceData.view,r=s.size,l=s.capacity;let o=this._instanceIndex;t=Math.min(r,t);for(let c=0;c<t;++c){0===o&&this._startUpdateCycle();const e=i.state.get(o);let r=0;if(!(e&y.StateFlags.ALLOCATED)){o=(o+1)%l,t++;continue}const c=i.lodLevel.get(o);if(e&y.StateFlags.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[c].freeTail(),e&y.StateFlags.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[c].freeTail(),e&y.StateFlags.REMOVE)s.freeInstance(o);else if(e&y.StateFlags.VISIBLE){let t=0;n&&(i.modelOrigin.getVec(o,P),t=a.selectLevel(P,s.getCombinedMedianScaleFactor(o))),r=e&~(y.StateFlags.ACTIVE|y.StateFlags.TRANSFORM_CHANGED),t>=0&&(e&y.StateFlags.HIGHLIGHT?(F(this._highlightRenderInstanceData[t],i,o),r|=y.StateFlags.HIGHLIGHT_ACTIVE):(F(this._defaultRenderInstanceData[t],i,o),r|=y.StateFlags.DEFAULT_ACTIVE)),i.state.set(o,r),i.lodLevel.set(o,t)}else r=e&~(y.StateFlags.ACTIVE|y.StateFlags.TRANSFORM_CHANGED),i.state.set(o,r);if(this._octree){const t=!!(e&y.StateFlags.ACTIVE),n=!!(r&y.StateFlags.ACTIVE);!t&&n?this._octree.addInstance(o):t&&!n?this._octree.removeInstance(o):t&&n&&e&y.StateFlags.TRANSFORM_CHANGED&&(this._octree.removeInstance(o),this._octree.addInstance(o))}o=(o+1)%l}this._instanceIndex=o,this._defaultRenderInstanceData.forEach((e=>{e.endUpdate()})),this._highlightRenderInstanceData.forEach((e=>{e.endUpdate()}))},o._renderComponents=function(e,t,n,a){this.levels.forEach(((s,i)=>{s.components.forEach((s=>{this._renderComponent(e,t,n,a[i],s,i)}))}))},o._renderComponent=function(e,t,a,s,i,r){if(0===s.size||!i.material.requiresSlot(t))return;const{rctx:l,pass:o}=e,h=i.glMaterials.load(l,o);if(n.isNone(h))return;const u=h.beginSlot(a),f=l.useTechnique(u,t);h.bind(a,u),l.bindVAO(i.vao),u.ensureAttributeLocations(i.vao),e.isHighlightPass&&d.bindOutputHighlight(f,a),u.bindDraw(a),c.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&e.pass===p.RenderPass.MATERIAL&&(f.setUniform4fv("externalColor",w[Math.min(r,w.length-1)]),f.setUniform1i("colorMixMode",E.colorMixModes.replace));const g=l.capabilities.instancing,m=s.capacity,y=s.headIndex,D=s.tailIndex,R=s.firstIndex,v=this._glInstanceBufferLayout,T=(e,t)=>{S.bindVertexBufferLayout(l,_.Default3D,s.buffer,v,e),g.drawArraysInstanced(u.primitiveType,0,i.vertexCount,t-e),S.unbindVertexBufferLayout(l,_.Default3D,s.buffer,v)};i.material.parameters.transparent&&null!=R?y>D?(I.assert(R>=D&&R<=y,"invalid firstIndex"),T(R,y),T(D,R)):y<D&&(R<=y?(I.assert(R>=0&&R<=y,"invalid firstIndex"),T(R,y),T(D,m),T(0,R)):(I.assert(R>=D&&R<=m,"invalid firstIndex"),T(R,m),T(0,y),T(D,R))):y>D?T(D,y):y<D&&(T(0,y),T(D,m)),l.bindVAO(null)},t._createClass(e,[{key:"levels",get:function(){return this._levels}},{key:"baseBoundingBox",get:function(){return this._levels[this._levels.length-1].boundingBox}},{key:"baseBoundingSphere",get:function(){return this._levels[this._levels.length-1].boundingSphere}},{key:"baseMaterial",get:function(){return this._levels[this._levels.length-1].components[0].material}},{key:"slicePlaneEnabled",get:function(){return this._slicePlane},set:function(e){this._slicePlane=e}},{key:"layerUid",get:function(){return this._metadata.layerUid}},{key:"instanceData",get:function(){return this._instanceData}},{key:"memoryUsage",get:function(){const e={cpu:0,gpu:0};return this._defaultRenderInstanceData.forEach((t=>{const n=t.memoryUsage;e.cpu+=n.cpu,e.gpu+=n.gpu})),this._highlightRenderInstanceData.forEach((t=>{const n=t.memoryUsage;e.cpu+=n.cpu,e.gpu+=n.gpu})),e}},{key:"renderStats",get:function(){const e=this._instanceData.size,t=[];return this._levels.forEach(((e,n)=>{const a=this._defaultRenderInstanceData[n],s=this._highlightRenderInstanceData[n],i=a.size+s.size,r=e.triangleCount;t.push({renderedInstances:i,renderedTriangles:i*r,trianglesPerInstance:r})})),{totalInstances:e,renderedInstances:t.reduce(((e,t)=>e+t.renderedInstances),0),renderedTriangles:t.reduce(((e,t)=>e+t.renderedTriangles),0),levels:t}}},{key:"needsTransparentPass",get:function(){return this._levels.some((e=>e.components.some((e=>e.material.requiresSlot(m.RenderSlot.TRANSPARENT_MATERIAL)))))}},{key:"needsHighlight",get:function(){return this._highlightRenderInstanceData.some((e=>e.size>0))}},{key:"needsUpdates",get:function(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}},{key:"octree",get:function(){return this._octree||(this._octree=this._buildOctree()),this._octree}}]),e}();function F(e,t,n){const a=e.allocateHead();O(t,n,e.view,a)}function O(e,t,n,a){A.encodeDoubleVec3(e.modelOrigin,t,n.modelOriginHi,n.modelOriginLo,a),n.model.copyFrom(a,e.model,t),n.modelNormal.copyFrom(a,e.modelNormal,t),e.color&&n.color&&n.color.copyFrom(a,e.color,t),e.featureAttribute&&n.featureAttribute&&n.featureAttribute.copyFrom(a,e.featureAttribute,t)}const P=l.create(),U=o.create(),M=s.create(),H=l.create(),V=l.create(),w=[[1,0,1,1],[0,0,1,1],[0,1,0,1],[1,1,0,1],[1,0,0,1]];e.LodRenderer=x,e.setLevelSelectorFactory=L,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
