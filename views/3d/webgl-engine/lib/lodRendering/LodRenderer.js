/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/maybe","../../../../../core/promiseUtils","../../../../../chunks/mat4f64","../../../../../chunks/vec3","../../../../../chunks/vec3f64","../../../../../chunks/vec4f64","../../../support/debugFlags","../../../support/buffer/glUtil","../../core/shaderLibrary/ShaderOutput","../Camera","../DefaultVertexAttributeLocations","../IntersectorInterfaces","../Octree","../RenderSlot","../Util","./InstanceData","./InstanceOctree","./LevelSelector","./LodLevel","./RenderInstanceData","../../materials/DefaultMaterial","../../materials/internal/MaterialUtil","../../materials/renderers/utils","../../shaders/DefaultMaterialTechnique","../../../../webgl/Util"],(function(e,t,a,n,s,i,r,o,c,l,h,d,u,_,f,g,p,m,y,I,C,D,b,v,S,R,E){"use strict";const A=e=>{const t=e.baseBoundingSphere.radius,a=e.levels.map((e=>e.minScreenSpaceRadius));return new I.LevelSelector(t,a)};let L=function(){function e(e,t,a,n){this.type=_.IntersectorType.LOD,this.isGround=!1,this._levels=[],this._defaultRenderInstanceData=[],this._highlightRenderInstanceData=[],this._instanceIndex=0,this._slicePlane=!1,this._lastCamera=new d.Camera,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.slots=[g.RenderSlot.OPAQUE_MATERIAL,g.RenderSlot.TRANSPARENT_MATERIAL],this.canRender=!0,this._symbol=e,this._optionalFields=t,this._metadata=a,this._instanceBufferLayout=b.getInstanceBufferLayout({instancedDoublePrecision:!0,instanced:t}),this._glInstanceBufferLayout=l.glLayout(this._instanceBufferLayout,1),this._instanceData=new m.InstanceData(this._optionalFields,n),this._instanceData.on("instance-added",(()=>this._requestUpdateCycle())),this._instanceData.on("instance-removed",(()=>this._requestUpdateCycle())),this._instanceData.on("instance-transform-changed",(e=>{this._requestUpdateCycle(),this._metadata.notifyGraphicGeometryChanged(e.index)})),this._instanceData.on("instance-visibility-changed",(e=>{this._requestUpdateCycle(!0),this._metadata.notifyGraphicVisibilityChanged(e.index)})),this._instanceData.on("instance-highlight-changed",(()=>this._requestUpdateCycle(!0))),this._enableLevelSelection=this._symbol.levels.length>1}var s=e.prototype;return s.initializeRenderContext=function(){var e=t._asyncToGenerator((function*(e,t){this._context=e;const a=e.renderContext.rctx,s=yield Promise.allSettled(this._symbol.levels.map((n=>(this._defaultRenderInstanceData.push(new D.RenderInstanceData(a,this._instanceBufferLayout)),this._highlightRenderInstanceData.push(new D.RenderInstanceData(a,this._instanceBufferLayout)),C.LodLevel.create(e,n,t))))),i=s.map((e=>"fulfilled"===e.status?e.value:null)).filter((e=>e));if(n.isAborted(t)||i.length!==s.length){i.forEach((e=>e.destroy())),n.throwIfAborted(t);for(const e of s)if("rejected"===e.status)throw e.reason}this._levels=i,this._levelSelector=A(this)}));function a(t,a){return e.apply(this,arguments)}return a}(),s.uninitializeRenderContext=function(){this._invalidateOctree(),this._levels.forEach((e=>e.destroy())),this._defaultRenderInstanceData.forEach((e=>e.destroy())),this._highlightRenderInstanceData.forEach((e=>e.destroy()))},s.prepareRender=function(e){if(c.LOD_INSTANCE_RENDERER_DISABLE_UPDATES)return;if(this._enableLevelSelection){const t=e.bindParameters.contentCamera.equals(this._lastCamera);this._lastCamera.copyFrom(e.bindParameters.contentCamera),t||this._requestUpdateCycle()}const t=this._needFullCycle?this._instanceData.size:2e3;this._needFullCycle=!1,this._updateInstances(e.bindParameters.contentCamera,t),this._needsUpdates&&this._context.requestRender()},s.render=function(e){if(!this.baseMaterial.isVisible()||!this.baseMaterial.isVisibleForOutput(e.output))return;e.rctx.bindVAO();e.output!==h.ShaderOutput.Highlight&&e.output!==h.ShaderOutput.ShadowHighlight&&this._renderComponents(e,this._defaultRenderInstanceData);e.output!==h.ShaderOutput.ShadowExludeHighlight&&this._renderComponents(e,this._highlightRenderInstanceData)},s.intersect=function(e,t,a,n){if(!this.baseMaterial.isVisible())return;const s=r.create();i.subtract(s,n,a);const o=s=>{this._instanceData.getCombinedModelTransform(s,x),e.transform.set(x),i.transformMat4(M,a,e.transform.inverse),i.transformMat4(V,n,e.transform.inverse);const r=this._instanceData.getState(s),o=this._instanceData.getLodLevel(s),c=this._levels.length;p.assert(r&m.StateFlags.ACTIVE,"invalid instance state"),p.assert(o>=0&&o<c,"invaid lod level"),this._levels[o].intersect(e,t,M,V,s,this._metadata,c)};this.baseMaterial.parameters.verticalOffset?this._octree.forEach(o):this._octree.forEachAlongRay(a,s,o)},s.queryDepthRange=function(e){return this._queryDepthRangeOctree(e)},s.notifyShaderTransformationChanged=function(){this._invalidateOctree()},s._requestUpdateCycle=function(e=!1){this._updateCyclesWithStaticCamera=-1,e&&(this._needFullCycle=!0),this._needsUpdates&&this._context.requestRender()},s._invalidateOctree=function(){this._octreeCached=a.destroyMaybe(this._octreeCached)},s._buildOctree=function(){const e=new y.InstanceOctree(this._instanceData,this.baseBoundingSphere),t=this._instanceData,a=t.view?t.view.state:null;for(let n=0;n<this._instanceData.capacity;++n){a.get(n)&m.StateFlags.ACTIVE&&e.addInstance(n)}return e},s._queryDepthRangeOctree=function(e){const t=e.eye,a=e.viewForward,n=this._octree.findClosest(a,f.DepthOrder.FRONT_TO_BACK,e.frustum),s=this._octree.findClosest(a,f.DepthOrder.BACK_TO_FRONT,e.frustum);if(null!=n&&null!=s){this._instanceData.view.boundingSphere.getVec(n,U),i.subtract(U,U,t);const r=i.dot(U,a)-U[3];this._instanceData.view.boundingSphere.getVec(s,U),i.subtract(U,U,t);const o=i.dot(U,a)+U[3];return{near:Math.max(e.near,r),far:Math.min(e.far,o)}}return{near:1/0,far:-1/0}},s._startUpdateCycle=function(){this._updateCyclesWithStaticCamera++,this._defaultRenderInstanceData.forEach((e=>{e.startUpdateCylce()})),this._highlightRenderInstanceData.forEach((e=>{e.startUpdateCylce()})),this._needsUpdates&&this._context.requestRender()},s._updateInstances=function(e,t){const n=this._enableLevelSelection,s=this._levelSelector;s.updateCamera(e),this._defaultRenderInstanceData.forEach((e=>e.beginUpdate())),this._highlightRenderInstanceData.forEach((e=>e.beginUpdate()));const i=this._instanceData,r=this._instanceData.view,o=i.size,c=i.capacity;let l=this._instanceIndex;t=Math.min(o,t);for(let h=0;h<t;++h){0===l&&this._startUpdateCycle();const e=r.state.get(l);let o=0;if(!(e&m.StateFlags.ALLOCATED)){l=l+1===c?0:l+1,t++;continue}const h=r.lodLevel.get(l);if(e&m.StateFlags.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[h].freeTail(),e&m.StateFlags.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[h].freeTail(),e&m.StateFlags.REMOVE)i.freeInstance(l);else if(e&m.StateFlags.VISIBLE){let t=0;n&&(r.modelOrigin.getVec(l,F),t=s.selectLevel(F,i.getCombinedMedianScaleFactor(l))),o=e&~(m.StateFlags.ACTIVE|m.StateFlags.TRANSFORM_CHANGED),t>=0&&(e&m.StateFlags.HIGHLIGHT?(T(this._highlightRenderInstanceData[t],r,l),o|=m.StateFlags.HIGHLIGHT_ACTIVE):(T(this._defaultRenderInstanceData[t],r,l),o|=m.StateFlags.DEFAULT_ACTIVE)),r.state.set(l,o),r.lodLevel.set(l,t)}else o=e&~(m.StateFlags.ACTIVE|m.StateFlags.TRANSFORM_CHANGED),r.state.set(l,o);if(a.isSome(this._octreeCached)){const t=!!(e&m.StateFlags.ACTIVE),a=!!(o&m.StateFlags.ACTIVE);!t&&a?this._octreeCached.addInstance(l):t&&!a?this._octreeCached.removeInstance(l):t&&a&&e&m.StateFlags.TRANSFORM_CHANGED&&(this._octreeCached.removeInstance(l),this._octreeCached.addInstance(l))}l=l+1===c?0:l+1}this._instanceIndex=l,this._defaultRenderInstanceData.forEach((e=>e.endUpdate())),this._highlightRenderInstanceData.forEach((e=>e.endUpdate()))},s._renderComponents=function(e,t){this.levels.forEach(((a,n)=>{a.components.forEach((a=>{this._renderComponent(e,t[n],a,n)}))}))},s._renderComponent=function(e,t,n,s){const{bindParameters:i,rctx:r,output:o}=e;if(0===t.size||!n.material.requiresSlot(i.slot,e.output))return;const l=n.glMaterials.load(r,i.slot,o);if(a.isNone(l))return;const d=l.beginSlot(i),_=r.bindTechnique(d,n.material.parameters,i);r.bindVAO(n.vao),d.ensureAttributeLocations(n.vao),_.bindDraw(N,i,n.material.parameters),c.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&e.output===h.ShaderOutput.Color&&(_.setUniform4fv("externalColor",w[Math.min(s,w.length-1)]),_.setUniform1i("colorMixMode",v.colorMixModes.replace));const f=r.capabilities.instancing,g=t.capacity,m=t.headIndex,y=t.tailIndex,I=t.firstIndex,C=this._glInstanceBufferLayout,D=(e,a)=>{E.bindVertexBufferLayout(r,u.Default3D,t.buffer,C,e),f.drawArraysInstanced(d.primitiveType,0,n.vertexCount,a-e),E.unbindVertexBufferLayout(r,u.Default3D,t.buffer,C)};n.material.parameters.transparent&&null!=I?m>y?(p.assert(I>=y&&I<=m,"invalid firstIndex"),D(I,m),D(y,I)):m<y&&(I<=m?(p.assert(I>=0&&I<=m,"invalid firstIndex"),D(I,m),D(y,g),D(0,I)):(p.assert(I>=y&&I<=g,"invalid firstIndex"),D(I,g),D(0,m),D(y,I))):m>y?D(y,m):m<y&&(D(0,m),D(y,g)),r.bindVAO(null)},t._createClass(e,[{key:"levels",get:function(){return this._levels}},{key:"baseBoundingBox",get:function(){return this._levels[this._levels.length-1].boundingBox}},{key:"baseBoundingSphere",get:function(){return this._levels[this._levels.length-1].boundingSphere}},{key:"baseMaterial",get:function(){return this._levels[this._levels.length-1].components[0].material}},{key:"slicePlaneEnabled",get:function(){return this._slicePlane},set:function(e){this._slicePlane=e}},{key:"layerUid",get:function(){return this._metadata.layerUid}},{key:"instanceData",get:function(){return this._instanceData}},{key:"memoryUsage",get:function(){const e={cpu:0,gpu:0};return this._defaultRenderInstanceData.forEach((t=>{const a=t.memoryUsage;e.cpu+=a.cpu,e.gpu+=a.gpu})),this._highlightRenderInstanceData.forEach((t=>{const a=t.memoryUsage;e.cpu+=a.cpu,e.gpu+=a.gpu})),e}},{key:"renderStats",get:function(){const e=this._instanceData.size,t=[];return this._levels.forEach(((e,a)=>{const n=this._defaultRenderInstanceData[a],s=this._highlightRenderInstanceData[a],i=n.size+s.size,r=e.triangleCount;t.push({renderedInstances:i,renderedTriangles:i*r,trianglesPerInstance:r})})),{totalInstances:e,renderedInstances:t.reduce(((e,t)=>e+t.renderedInstances),0),renderedTriangles:t.reduce(((e,t)=>e+t.renderedTriangles),0),levels:t}}},{key:"needsTransparentPass",get:function(){return this._levels.some((e=>e.components.some((e=>e.material.requiresSlot(g.RenderSlot.TRANSPARENT_MATERIAL,h.ShaderOutput.Color)))))}},{key:"needsHighlight",get:function(){return this._highlightRenderInstanceData.some((e=>e.size>0))}},{key:"_needsUpdates",get:function(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}},{key:"_octree",get:function(){return a.isNone(this._octreeCached)&&(this._octreeCached=this._buildOctree()),this._octreeCached}}]),e}();function T(e,t,a){const n=e.allocateHead();O(t,a,e.view,n)}function O(e,t,a,n){S.encodeDoubleVec3(e.modelOrigin,t,a.modelOriginHi,a.modelOriginLo,n),a.model.copyFrom(n,e.model,t),a.modelNormal.copyFrom(n,e.modelNormal,t),e.color&&a.color&&a.color.copyFrom(n,e.color,t),e.objectAndLayerIdColor&&a.objectAndLayerIdColor&&a.objectAndLayerIdColor.copyFrom(n,e.objectAndLayerIdColor,t),e.featureAttribute&&a.featureAttribute&&a.featureAttribute.copyFrom(n,e.featureAttribute,t)}const F=r.create(),U=o.create(),x=s.create(),M=r.create(),V=r.create(),w=[o.fromValues(1,0,1,1),o.fromValues(0,0,1,1),o.fromValues(0,1,0,1),o.fromValues(1,1,0,1),o.fromValues(1,0,0,1)],N=new R.DefaultMaterialDrawParameters;e.LodRenderer=L,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
