/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../core/Accessor","../../../../../core/maybe","../../../../../core/promiseUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/accessorSupport/ensureType","../../../../../core/arrayUtils","../../../../../core/accessorSupport/decorators/subclass","../../../../../chunks/mat4f64","../../../../../chunks/vec3","../../../../../chunks/vec3f64","../../../../../chunks/vec4f64","../../../support/debugFlags","../../../support/buffer/glUtil","../../../support/buffer/InterleavedLayout","../../core/shaderLibrary/ShaderOutput","../Camera","../DefaultVertexAttributeLocations","../IntersectorInterfaces","../Octree","../RenderSlot","../Util","../VertexAttribute","./InstanceData","./InstanceOctree","./LevelSelector","./LodLevel","./RenderInstanceData","../../materials/internal/MaterialUtil","../../materials/renderers/utils","../../shaders/DefaultMaterialTechnique","../../../../support/Scheduler","../../../../webgl/Util"],(function(e,t,n,a,r,s,i,o,c,l,d,u,h,_,f,p,g,y,m,I,C,R,b,S,v,D,L,A,E,T,O,x,F,V,N){"use strict";const M=e=>{const t=e.baseBoundingSphere.radius,n=e.levels.map((e=>e.minScreenSpaceRadius));return new A.LevelSelector(t,n)};function U(e,t,n){const a=e.allocateHead();k(t,n,e.view,a)}function k(e,t,n,a){x.encodeDoubleVec3(e.modelOrigin,t,n.modelOriginHi,n.modelOriginLo,a),n.model.copyFrom(a,e.model,t),n.modelNormal.copyFrom(a,e.modelNormal,t),e.color&&n.color&&n.color.copyFrom(a,e.color,t),e.objectAndLayerIdColor&&n.objectAndLayerIdColor&&n.objectAndLayerIdColor.copyFrom(a,e.objectAndLayerIdColor,t),e.featureAttribute&&n.featureAttribute&&n.featureAttribute.copyFrom(a,e.featureAttribute,t)}function w(e){let t=g.newLayout().vec3f(v.VertexAttribute.MODELORIGINHI).vec3f(v.VertexAttribute.MODELORIGINLO).mat3f(v.VertexAttribute.MODEL).mat3f(v.VertexAttribute.MODELNORMAL);return r.isSome(e)&&e.includes("color")&&(t=t.vec4f(v.VertexAttribute.INSTANCECOLOR)),r.isSome(e)&&e.includes("featureAttribute")&&(t=t.vec4f(v.VertexAttribute.INSTANCEFEATUREATTRIBUTE)),r.isSome(e)&&e.includes("objectAndLayerIdColor")&&(t=t.vec4u8(v.VertexAttribute.OBJECTANDLAYERIDCOLOR_INSTANCED)),t}e.LodRenderer=function(e){function n(n,a){var r;return(r=e.call(this,n)||this).type=C.IntersectorType.LOD,r.isGround=!1,r._levels=[],r._defaultRenderInstanceData=[],r._highlightRenderInstanceData=[],r._instanceIndex=0,r._cycleStartIndex=0,r._slicePlane=!1,r._camera=new m.Camera,r._updateCyclesWithStaticCamera=-1,r._needFullCycle=!1,r.slots=[b.RenderSlot.OPAQUE_MATERIAL,b.RenderSlot.TRANSPARENT_MATERIAL],r.canRender=!0,r._instanceData=new D.InstanceData({shaderTransformation:n.shaderTransformation},n.optionalFields),r._frameTask=a.registerTask(V.TaskPriority.LOD_RENDERER,t._assertThisInitialized(r)),r}t._inheritsLoose(n,e);var a=n.prototype;return a.initialize=function(){this._instanceBufferLayout=w(this.optionalFields),this._glInstanceBufferLayout=p.glLayout(this._instanceBufferLayout,1),this._instanceData.events.on("instances-changed",(()=>this._requestUpdateCycle())),this._instanceData.events.on("instance-transform-changed",(({index:e})=>{this._requestUpdateCycle(),this.metadata.notifyGraphicGeometryChanged(e)})),this._instanceData.events.on("instance-visibility-changed",(({index:e})=>{this._requestUpdateCycle(!0),this.metadata.notifyGraphicVisibilityChanged(e)})),this._instanceData.events.on("instance-highlight-changed",(()=>this._requestUpdateCycle(!0)))},a.destroy=function(){this._frameTask.remove()},a.initializeRenderContext=function(){var e=t._asyncToGenerator((function*(e,t){this._context=e;const n=e.renderContext.rctx,a=yield Promise.allSettled(this.symbol.levels.map((a=>(this._defaultRenderInstanceData.push(new T.RenderInstanceData(n,this._instanceBufferLayout)),this._highlightRenderInstanceData.push(new T.RenderInstanceData(n,this._instanceBufferLayout)),E.LodLevel.create(e,a,t))))),i=a.map((e=>"fulfilled"===e.status?e.value:null)).filter(r.isSome);if(s.isAborted(t)||i.length!==a.length){i.forEach((e=>e.destroy())),s.throwIfAborted(t);for(const e of a)if("rejected"===e.status)throw e.reason}this._levels=i,this._levelSelector=M(this)}));function n(t,n){return e.apply(this,arguments)}return n}(),a.uninitializeRenderContext=function(){this._invalidateOctree(),this._levels.forEach((e=>e.destroy())),this._defaultRenderInstanceData.forEach((e=>e.destroy())),this._highlightRenderInstanceData.forEach((e=>e.destroy()))},a.prepareRender=function(e){if(!f.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){const t=e.bindParameters.contentCamera.equals(this._camera);this._camera.copyFrom(e.bindParameters.contentCamera),t||this._requestUpdateCycle()}this._needFullCycle&&(this.runTask(V.noBudget),this._needFullCycle=!1)}},a.render=function(e){if(!this.baseMaterial.isVisible()||!this.baseMaterial.isVisibleForOutput(e.output))return;e.rctx.bindVAO();e.output!==y.ShaderOutput.Highlight&&e.output!==y.ShaderOutput.ShadowHighlight&&this._renderComponents(e,this._defaultRenderInstanceData);e.output!==y.ShaderOutput.ShadowExcludeHighlight&&this._renderComponents(e,this._highlightRenderInstanceData)},a.intersect=function(e,t,n,a){if(!this.baseMaterial.isVisible()||r.isNone(this._octree))return;const s=h.create();u.subtract(s,a,n);const i=r=>{this._instanceData.getCombinedModelTransform(r,P),e.transform.set(P),u.transformMat4(q,n,e.transform.inverse),u.transformMat4(G,a,e.transform.inverse);const s=this._instanceData.getState(r),i=this._instanceData.getLodLevel(r),o=this._levels.length;S.assert(0!=(s&D.StateFlags.ACTIVE),"invalid instance state"),S.assert(i>=0&&i<o,"invaid lod level"),this._levels[i].intersect(e,t,q,G,r,this.metadata,o)};this.baseMaterial.parameters.verticalOffset?this._octree.forEach(i):this._octree.forEachAlongRay(n,s,i)},a.queryDepthRange=function(e){return this._queryDepthRangeOctree(e)},a.notifyShaderTransformationChanged=function(){this._invalidateOctree(),this._requestUpdateCycle()},a._invalidateOctree=function(){this._octreeCached=r.destroyMaybe(this._octreeCached)},a._queryDepthRangeOctree=function(e){if(r.isNone(this._octree))return{near:1/0,far:-1/0};const t=e.viewForward,n=this._octree.findClosest(t,R.DepthOrder.FRONT_TO_BACK,e.frustum),a=this._octree.findClosest(t,R.DepthOrder.BACK_TO_FRONT,e.frustum);if(null==n||null==a)return{near:1/0,far:-1/0};const s=e.eye,i=this._instanceData.view;i.boundingSphere.getVec(n,H),u.subtract(H,H,s);const o=u.dot(H,t)-H[3];i.boundingSphere.getVec(a,H),u.subtract(H,H,s);const c=u.dot(H,t)+H[3];return{near:Math.max(e.near,o),far:Math.min(e.far,c)}},a._requestUpdateCycle=function(e=!1){this._updateCyclesWithStaticCamera=-1,this._cycleStartIndex=this._instanceIndex,e&&(this._needFullCycle=!0,this._context.requestRender())},a._startUpdateCycle=function(){this._updateCyclesWithStaticCamera++,this._defaultRenderInstanceData.forEach((e=>e.startUpdateCycle())),this._highlightRenderInstanceData.forEach((e=>e.startUpdateCycle()))},a.runTask=function(e){const{_enableLevelSelection:t,_camera:n,_levelSelector:a}=this;this._defaultRenderInstanceData.forEach((e=>e.beginUpdate())),this._highlightRenderInstanceData.forEach((e=>e.beginUpdate()));const s=this._instanceData,i=s.view;let o=s.size;const c=s.capacity;let l=this._instanceIndex;for(let d=0;d<o&&!e.done;++d){l===this._cycleStartIndex&&this._startUpdateCycle();const d=i.state.get(l);let u=0;if(!(d&D.StateFlags.ALLOCATED)){l=l+1===c?0:l+1,o++;continue}const h=i.lodLevel.get(l);if(d&D.StateFlags.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[h].freeTail(),d&D.StateFlags.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[h].freeTail(),d&D.StateFlags.REMOVE)s.freeInstance(l);else if(d&D.StateFlags.VISIBLE){let e=0;t&&(i.modelOrigin.getVec(l,B),e=a.selectLevel(B,s.getCombinedMedianScaleFactor(l),n)),u=d&~(D.StateFlags.ACTIVE|D.StateFlags.TRANSFORM_CHANGED),e>=0&&(d&D.StateFlags.HIGHLIGHT?(U(this._highlightRenderInstanceData[e],i,l),u|=D.StateFlags.HIGHLIGHT_ACTIVE):(U(this._defaultRenderInstanceData[e],i,l),u|=D.StateFlags.DEFAULT_ACTIVE)),i.state.set(l,u),i.lodLevel.set(l,e)}else u=d&~(D.StateFlags.ACTIVE|D.StateFlags.TRANSFORM_CHANGED),i.state.set(l,u);if(r.isSome(this._octreeCached)){const e=!!(d&D.StateFlags.ACTIVE),t=!!(u&D.StateFlags.ACTIVE);!e&&t?this._octreeCached.addInstance(l):e&&!t?this._octreeCached.removeInstance(l):e&&t&&d&D.StateFlags.TRANSFORM_CHANGED&&(this._octreeCached.removeInstance(l),this._octreeCached.addInstance(l))}l=l+1===c?0:l+1,e.madeProgress()}this._instanceIndex=l,this._defaultRenderInstanceData.forEach((e=>e.endUpdate())),this._highlightRenderInstanceData.forEach((e=>e.endUpdate())),this._context.requestRender()},a._renderComponents=function(e,t){this.levels.forEach(((n,a)=>{const r=n.components.map((n=>this._beginComponent(e,t[a],n)));n.components.forEach(((n,s)=>this._renderComponent(e,r[s],t[a],n,a)))}))},a._beginComponent=function(e,t,n){const{bindParameters:a,rctx:s,output:i}=e;if(0===t.size||!n.material.requiresSlot(a.slot,e.output))return null;const o=n.glMaterials.load(s,a.slot,i);return r.isSome(o)?o.beginSlot(a):null},a._renderComponent=function(e,t,n,a,s){if(r.isNone(t))return;const{bindParameters:i,rctx:o}=e,c=o.bindTechnique(t,a.material.parameters,i);o.bindVAO(a.vao),t.ensureAttributeLocations(a.vao),c.bindDraw(j,i,a.material.parameters),f.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&e.output===y.ShaderOutput.Color&&(c.setUniform4fv("externalColor",z[Math.min(s,z.length-1)]),c.setUniform1i("colorMixMode",O.colorMixModes.replace));const l=o.capabilities.instancing,d=n.capacity,u=n.headIndex,h=n.tailIndex,_=n.firstIndex,p=this._glInstanceBufferLayout,g=(e,r)=>{N.bindVertexBufferLayout(o,I.Default3D,n.buffer,p,e),l.drawArraysInstanced(t.primitiveType,0,a.vertexCount,r-e),N.unbindVertexBufferLayout(o,I.Default3D,n.buffer,p)};a.material.parameters.transparent&&null!=_?u>h?(S.assert(_>=h&&_<=u,"invalid firstIndex"),g(_,u),g(h,_)):u<h&&(_<=u?(S.assert(_>=0&&_<=u,"invalid firstIndex"),g(_,u),g(h,d),g(0,_)):(S.assert(_>=h&&_<=d,"invalid firstIndex"),g(_,d),g(0,u),g(h,_))):u>h?g(h,u):u<h&&(g(0,u),g(h,d)),o.bindVAO(null)},t._createClass(n,[{key:"_enableLevelSelection",get:function(){return this.symbol.levels.length>1}},{key:"levels",get:function(){return this._levels}},{key:"baseBoundingBox",get:function(){return this._levels[this._levels.length-1].boundingBox}},{key:"baseBoundingSphere",get:function(){return this._levels[this._levels.length-1].boundingSphere}},{key:"baseMaterial",get:function(){return this._levels[this._levels.length-1].components[0].material}},{key:"slicePlaneEnabled",get:function(){return this._slicePlane},set:function(e){this._slicePlane=e}},{key:"layerUid",get:function(){return this.metadata.layerUid}},{key:"instanceData",get:function(){return this._instanceData}},{key:"memoryUsage",get:function(){const e={cpu:0,gpu:0};return this._defaultRenderInstanceData.forEach((t=>{const n=t.memoryUsage;e.cpu+=n.cpu,e.gpu+=n.gpu})),this._highlightRenderInstanceData.forEach((t=>{const n=t.memoryUsage;e.cpu+=n.cpu,e.gpu+=n.gpu})),e}},{key:"renderStats",get:function(){const e=this._instanceData.size,t=[];return this._levels.forEach(((e,n)=>{const a=this._defaultRenderInstanceData[n],r=this._highlightRenderInstanceData[n],s=a.size+r.size,i=e.triangleCount;t.push({renderedInstances:s,renderedTriangles:s*i,trianglesPerInstance:i})})),{totalInstances:e,renderedInstances:t.reduce(((e,t)=>e+t.renderedInstances),0),renderedTriangles:t.reduce(((e,t)=>e+t.renderedTriangles),0),levels:t}}},{key:"needsTransparentPass",get:function(){return this._levels.some((e=>e.components.some((e=>e.material.requiresSlot(b.RenderSlot.TRANSPARENT_MATERIAL,y.ShaderOutput.Color)))))}},{key:"needsHighlight",get:function(){return this._highlightRenderInstanceData.some((e=>e.size>0))}},{key:"_octree",get:function(){if(r.isNone(this._octreeCached)){const e=this._instanceData,t=e.view?.state;if(!t)return null;this._octreeCached=new L.InstanceOctree(e,this.baseBoundingSphere);for(let n=0;n<e.capacity;++n)t.get(n)&D.StateFlags.ACTIVE&&this._octreeCached.addInstance(n)}return this._octreeCached}},{key:"running",get:function(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}}]),n}(a),n.__decorate([i.property({constructOnly:!0})],e.LodRenderer.prototype,"symbol",void 0),n.__decorate([i.property({constructOnly:!0})],e.LodRenderer.prototype,"optionalFields",void 0),n.__decorate([i.property({constructOnly:!0})],e.LodRenderer.prototype,"metadata",void 0),n.__decorate([i.property({constructOnly:!0})],e.LodRenderer.prototype,"shaderTransformation",void 0),n.__decorate([i.property()],e.LodRenderer.prototype,"_instanceData",void 0),n.__decorate([i.property()],e.LodRenderer.prototype,"_cycleStartIndex",void 0),n.__decorate([i.property({readOnly:!0})],e.LodRenderer.prototype,"_enableLevelSelection",null),n.__decorate([i.property()],e.LodRenderer.prototype,"_updateCyclesWithStaticCamera",void 0),n.__decorate([i.property({readOnly:!0})],e.LodRenderer.prototype,"running",null),e.LodRenderer=n.__decorate([l.subclass("esri.views.3d.webgl-engine.lib.lodRendering.LodRenderer")],e.LodRenderer);const B=h.create(),H=_.create(),P=d.create(),q=h.create(),G=h.create(),z=[_.fromValues(1,0,1,1),_.fromValues(0,0,1,1),_.fromValues(0,1,0,1),_.fromValues(1,1,0,1),_.fromValues(1,0,0,1)],j=new F.DefaultMaterialDrawParameters;Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
