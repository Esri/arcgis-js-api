/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/vec3f64","../../../../../chunks/vec3","../../../../../chunks/mat4f64","../../../../../chunks/vec2f64","../../../../../chunks/vec4f64","../../../../../geometry/support/aaBoundingBox","../DefaultVertexAttributeLocations","../../../support/buffer/glUtil","../Util","../../../../webgl/BufferObject","../../../../webgl/Util","../../../../webgl/VertexArrayObject","../../materials/renderers/utils","../intersectorUtils","../Camera","../../../support/debugFlags","../../materials/internal/MaterialUtil","../../core/shaderLibrary/output/OutputHighlight.glsl","../../materials/DefaultMaterial","./InstanceData","./InstanceOctree","./LevelSelector","./RenderInstanceData"],(function(e,t,n,s,a,i,r,o,l,c,h,u,d,f,g,p,_,m,y,b,I,v,D,C,S){"use strict";let x=function(e){const t=e.baseBoundingSphere.radius,n=e.levels.map((e=>e.minScreenSpaceRadius));return new C.LevelSelector(t,n)};let R=function(){function e(e,t){const n=e.rctx,s=t.geometry,a=t.material,i=s.data.toRenderData();this.materialRep=e.materialRep,a.setParameterValues({instancedDoublePrecision:!0});const r=a.createBufferWriter(),o=r.vertexBufferLayout,h=r.elementCount(i),d=r.allocate(h);r.write({},i,d,0),this.geometry=s,this.material=a,this.glMaterials=g.acquireMaterials(a,this.materialRep),this.vertexBufferLayout=o,this.vbo=u.createVertex(n,35044,d.buffer),this.vao=new f(n,l.Default3D,{geometry:c.glLayout(o)},{geometry:this.vbo}),this.vertexCount=h}var n=e.prototype;return n.destroy=function(){g.releaseMaterials(this.material,this.materialRep),this.vbo.dispose(),this.vao.dispose()},n.intersect=function(e,t,n,s,a,i){const r=this.geometry.id,o=a.toString();this.material.intersect(this.geometry,null,e.transform.transform,e,n,s,((n,s,l,c)=>{if(n>=0){if(null!=t&&!t(e.rayBeginPoint,e.rayEndPoint,n))return;const h={type:"external",metadata:{layerUid:i.layerUid,graphicUid:i.graphicUid(a)}};if((null==e.results.min.drapedLayerOrder||c>=e.results.min.drapedLayerOrder)&&(null==e.results.min.dist||n<e.results.min.dist)&&(e.results.min.set(h,o,n,s,e.transform.transform,c,null,r,l),e.results.min.intersector="LodRenderer"),0!==e.options.store&&(null==e.results.max.drapedLayerOrder||c>=e.results.max.drapedLayerOrder)&&(null==e.results.max.dist||n>e.results.max.dist)&&(e.results.max.set(h,o,n,s,e.transform.transform,c,null,r,l),e.results.min.intersector="LodRenderer"),2===e.options.store){const t=new p.IntersectorResult(e.results.min.ray);t.set(h,o,n,s,e.transform.transform,c,null,r,l),t.intersector="LodRenderer",e.results.all.push(t)}}}))},t._createClass(e,[{key:"boundingInfo",get:function(){return this.geometry.boundingInfo}},{key:"triangleCount",get:function(){return this.vertexCount/3}}]),e}(),E=function(){function e(e,t){this.components=[],this.minScreenSpaceRadius=t.minScreenSpaceRadius,t.components.forEach((t=>{this.components.push(new R(e,t))}))}var s=e.prototype;return s.destroy=function(){this.components.forEach((e=>{e.destroy()}))},s.intersect=function(e,t,n,s,a,i){this.components.forEach((r=>{r.intersect(e,t,n,s,a,i)}))},t._createClass(e,[{key:"boundingBox",get:function(){if(!this._boundingBox){const e=o.empty();this.components.forEach((t=>{o.expandWithVec3(e,t.boundingInfo.bbMin),o.expandWithVec3(e,t.boundingInfo.bbMax)})),this._boundingBox=e}return this._boundingBox}},{key:"boundingSphere",get:function(){if(!this._boundingSphere){const e=this.boundingBox,t=n.create();o.center(e,t),this._boundingSphere={center:t,radius:.5*o.diameter(e)}}return this._boundingSphere}},{key:"triangleCount",get:function(){return this.components.reduce(((e,t)=>e+t.triangleCount),0)}}]),e}(),L=function(){function e(e,t,n,s){this.type="Lod",this.isGround=!1,this._inverseViewport=i.create(),this._levels=[],this._renderInstanceData=[],this._highlightRenderInstanceData=[],this._instanceIndex=0,this._slicePlane=!1,this._enableLevelSelection=!0,this._lastCamera=new _,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.canRender=!0,this._symbol=e,this._optionalFields=t,this._metadata=n,this._instanceBufferLayout=I.DefaultMaterial.getInstanceBufferLayout({instancedDoublePrecision:!0,instanced:t}),this._glInstanceBufferLayout=c.glLayout(this._instanceBufferLayout,{divisor:1}),this._instanceData=new v.InstanceData(this._optionalFields,s),this._instanceData.on("instance-added",(()=>{this.requestUpdateCycle()})),this._instanceData.on("instance-removed",(()=>{this.requestUpdateCycle()})),this._instanceData.on("instance-transform-changed",(e=>{this.requestUpdateCycle(),this._metadata.notifyGraphicUpdate(e.index,2)})),this._instanceData.on("instance-visibility-changed",(e=>{this.requestUpdateCycle(!0),this._metadata.notifyGraphicUpdate(e.index,1)})),this._instanceData.on("instance-highlight-changed",(()=>{this.requestUpdateCycle(!0)})),this._enableLevelSelection=this._symbol.levels.length>1,V.push(this)}var a=e.prototype;return a.destroy=function(){V.splice(V.indexOf(this),1)},a.initializeRenderContext=function(e){this._initContext=e;const t=e.rctx;this._symbol.levels.forEach((n=>{this._levels.push(new E(e,n)),this._renderInstanceData.push(new S.RenderInstanceData(t,this._instanceBufferLayout)),this._highlightRenderInstanceData.push(new S.RenderInstanceData(t,this._instanceBufferLayout))})),this._levelSelector=x(this)},a.uninitializeRenderContext=function(){this.invalidateOctree(),this._levels.forEach((e=>{e.destroy()})),this._renderInstanceData.forEach((e=>{e.destroy()})),this._highlightRenderInstanceData.forEach((e=>{e.destroy()}))},a.prepareRender=function(e){this.runUpdates(e)},a.render=function(e){const t=e.rctx,n=4===e.slot?3:6===e.slot?5:null;if(!n)return;if(!this.baseMaterial.isVisible()||!this.baseMaterial.isVisibleInPass(e.pass))return!1;const s=e.camera;this._inverseViewport[0]=1/s.fullViewport[2],this._inverseViewport[1]=1/s.fullViewport[3];const a={slot:n,origin:[0,0,0],camera:s,inverseViewport:this._inverseViewport,shadowMap:e.shadowMap,shadowMappingEnabled:!!e.shadowMap&&e.shadowMap.enabled,ssaoEnabled:!!e.ssaoHelper&&e.ssaoHelper.enabled,screenToWorldRatio:null,screenToWorldRatioGlobalWM:null,slicePlane:e.sliceHelper&&e.sliceHelper.plane,hudVisibilityTexture:e.offscreenRenderingHelper?e.offscreenRenderingHelper.hudVisibilityTexture:null,highlightDepthTexture:e.offscreenRenderingHelper?e.offscreenRenderingHelper.depthTexture:null,hasOccludees:!1,linearDepthTexture:null,linearDepthTextureID:0,lastFrameColorTexture:null,lastFrameColorTextureID:0,reprojectionMat:null,ssrEnabled:!1,lighting:e.scenelightingData,transparencyPassType:e.transparencyPassType};t.bindVAO();for(let t=0;t<this._levels.length;++t){const s=e.isHighlightPass?this._highlightRenderInstanceData[t]:this._renderInstanceData[t];this._levels[t].components.forEach((i=>{this.renderComponent(e,n,a,s,i,t)}))}return!0},a.intersect=function(e,t,a,i){if(!this.baseMaterial.isVisible())return;const r=n.create();s.subtract(r,i,a);const o=n=>{this._instanceData.getCombinedModelTransform(n,M),e.transform.set(M),s.transformMat4(O,a,e.transform.inverse),s.transformMat4(w,i,e.transform.inverse);const r=this._instanceData.getState(n),o=this._instanceData.getLodLevel(n);h.assert(r&v.StateFlags.ACTIVE,"invalid instance state"),h.assert(o>=0&&o<this._levels.length,"invaid lod level"),this._levels[o].intersect(e,t,O,w,n,this._metadata)};this.baseMaterial.params.verticalOffset?this.octree.forEach(o):this.octree.forEachAlongRay(a,r,o)},a.queryDepthRange=function(e){return this.queryDepthRangeOctree(e)},a.notifyShaderTransformationChanged=function(){this.invalidateOctree()},a.requestUpdateCycle=function(e=!1){this._updateCyclesWithStaticCamera=-1,e&&(this._needFullCycle=!0),this.needsUpdates&&this._initContext.requestRender()},a.runUpdates=function(e){if(m.LOD_INSTANCE_RENDERER_DISABLE_UPDATES)return;if(this._enableLevelSelection){const t=e.equals(this._lastCamera);this._lastCamera.copyFrom(e),t||this.requestUpdateCycle()}const t=this._needFullCycle?this._instanceData.size:2e3;this._needFullCycle=!1,this.updateInstances(e,t),this.needsUpdates&&this._initContext.requestRender()},a.invalidateOctree=function(){this._octree&&(this._octree.destroy(),this._octree=null)},a.buildOctree=function(){const e=new D.InstanceOctree(this._instanceData,this.baseBoundingSphere),t=this._instanceData,n=t.view?t.view.state:null;for(let t=0;t<this._instanceData.capacity;++t){n.get(t)&v.StateFlags.ACTIVE&&e.addInstance(t)}return e},a.queryDepthRangeOctree=function(e){const t=e.eye,n=e.viewForward,a=this.octree.findClosest(n,"front-to-back",e.frustum),i=this.octree.findClosest(n,"back-to-front",e.frustum);if(null!=a&&null!=i){this._instanceData.view.boundingSphere.getVec(a,U),s.subtract(U,U,t);const r=s.dot(U,n)-U[3];this._instanceData.view.boundingSphere.getVec(i,U),s.subtract(U,U,t);const o=s.dot(U,n)+U[3];return{near:Math.max(e.near,r),far:Math.min(e.far,o)}}return{near:1/0,far:-1/0}},a.startUpdateCycle=function(){this._updateCyclesWithStaticCamera++,this._renderInstanceData.forEach((e=>{e.startUpdateCylce()})),this._highlightRenderInstanceData.forEach((e=>{e.startUpdateCylce()})),this.needsUpdates&&this._initContext.requestRender()},a.updateInstances=function(e,t){const n=this._enableLevelSelection,s=this._levelSelector;s.updateCamera(e),this._renderInstanceData.forEach((e=>{e.beginUpdate()})),this._highlightRenderInstanceData.forEach((e=>{e.beginUpdate()}));const a=this._instanceData,i=this._instanceData.view,r=a.size,o=a.capacity;let l=this._instanceIndex;t=Math.min(r,t);for(let e=0;e<t;++e){0===l&&this.startUpdateCycle();const e=i.state.get(l);let r=0;if(!(e&v.StateFlags.ALLOCATED)){l=(l+1)%o,t++;continue}const c=i.lodLevel.get(l);if(e&v.StateFlags.ACTIVE&&this._renderInstanceData[c].freeTail(),e&v.StateFlags.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[c].freeTail(),e&v.StateFlags.REMOVE)a.freeInstance(l);else if(e&v.StateFlags.VISIBLE){let t=0;if(n&&(i.modelOrigin.getVec(l,F),t=s.selectLevel(F,a.getCombinedMedianScaleFactor(l))),r=e&~(v.StateFlags.ACTIVE|v.StateFlags.HIGHLIGHT_ACTIVE|v.StateFlags.TRANSFORM_CHANGED),t>=0){const n=this._renderInstanceData[t],s=n.allocateHead();if(T(i,l,n.view,s),r|=v.StateFlags.ACTIVE,e&v.StateFlags.HIGHLIGHT){const e=this._highlightRenderInstanceData[t],n=e.allocateHead();T(i,l,e.view,n),r|=v.StateFlags.HIGHLIGHT_ACTIVE}}i.state.set(l,r),i.lodLevel.set(l,t)}else r=e&~(v.StateFlags.ACTIVE|v.StateFlags.HIGHLIGHT_ACTIVE|v.StateFlags.TRANSFORM_CHANGED),i.state.set(l,r);if(this._octree){const t=!!(e&v.StateFlags.ACTIVE),n=!!(r&v.StateFlags.ACTIVE);!t&&n?this._octree.addInstance(l):t&&!n?this._octree.removeInstance(l):t&&n&&e&v.StateFlags.TRANSFORM_CHANGED&&(this._octree.removeInstance(l),this._octree.addInstance(l))}l=(l+1)%o}this._instanceIndex=l,this._renderInstanceData.forEach((e=>{e.endUpdate()})),this._highlightRenderInstanceData.forEach((e=>{e.endUpdate()}))},a.renderComponent=function(e,t,n,s,a,i){const r=a.glMaterials.get(e.pass);if(!r||!r.beginSlot(t)||0===s.size)return;const o=e.rctx,c=o.capabilities.instancing;r.ensureParameters(n);const u=r.getTechnique(),f=r.getPipelineState(t);o.setPipelineState(f),r.bind(o,n),o.bindVAO(a.vao),u.ensureAttributeLocations(a.vao);const g=u.program;e.isHighlightPass&&b.OutputHighlight.bindOutputHighlight(o,g,n),u.bindDraw(n),m.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&0===e.pass&&(g.setUniform4fv("externalColor",H[Math.min(i,H.length-1)]),g.setUniform1i("colorMixMode",y.colorMixModes.replace));const p=s.capacity,_=s.headIndex,I=s.tailIndex,v=s.firstIndex,D=this._glInstanceBufferLayout,C=(e,t)=>{d.bindVertexBufferLayout(o,l.Default3D,s.buffer,D,e),c.drawArraysInstanced(u.primitiveType,0,a.vertexCount,t-e),d.unbindVertexBufferLayout(o,l.Default3D,s.buffer,D)};a.material.params.transparent&&null!=v?_>I?(h.assert(v>=I&&v<=_,"invalid firstIndex"),C(v,_),C(I,v)):_<I&&(v<=_?(h.assert(v>=0&&v<=_,"invalid firstIndex"),C(v,_),C(I,p),C(0,v)):(h.assert(v>=I&&v<=p,"invalid firstIndex"),C(v,p),C(0,_),C(I,v))):_>I?C(I,_):_<I&&(C(0,_),C(I,p)),o.bindVAO(null)},t._createClass(e,[{key:"levels",get:function(){return this._levels}},{key:"baseBoundingBox",get:function(){return this._levels[this._levels.length-1].boundingBox}},{key:"baseBoundingSphere",get:function(){return this._levels[this._levels.length-1].boundingSphere}},{key:"baseMaterial",get:function(){return this._levels[this._levels.length-1].components[0].material}},{key:"slicePlane",get:function(){return this._slicePlane},set:function(e){this._slicePlane=e}},{key:"intersectionHandlerId",get:function(){return this._metadata.layerUid}},{key:"instanceData",get:function(){return this._instanceData}},{key:"memoryUsage",get:function(){const e={cpu:0,gpu:0};return this._renderInstanceData.forEach((t=>{const n=t.memoryUsage;e.cpu+=n.cpu,e.gpu+=n.gpu})),this._highlightRenderInstanceData.forEach((t=>{const n=t.memoryUsage;e.cpu+=n.cpu,e.gpu+=n.gpu})),e}},{key:"renderStats",get:function(){const e=this._instanceData.size,t=[];return this._levels.forEach(((e,n)=>{const s=this._renderInstanceData[n],a=this._highlightRenderInstanceData[n],i=s.size+a.size,r=e.triangleCount;t.push({renderedInstances:i,renderedTriangles:i*r,trianglesPerInstance:r})})),{totalInstances:e,renderedInstances:t.reduce(((e,t)=>e+t.renderedInstances),0),renderedTriangles:t.reduce(((e,t)=>e+t.renderedTriangles),0),levels:t}}},{key:"slots",get:function(){return[4,6]}},{key:"needsHighlight",get:function(){return this._highlightRenderInstanceData.reduce(((e,t)=>e+t.size),0)>0}},{key:"needsUpdates",get:function(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}},{key:"octree",get:function(){return this._octree||(this._octree=this.buildOctree()),this._octree}}]),e}();function T(e,t,n,s){g.encodeDoubleVec3(e.modelOrigin,t,n.modelOriginHi,n.modelOriginLo,s),n.model.copyFrom(s,e.model,t),n.modelNormal.copyFrom(s,e.modelNormal,t),e.color&&n.color&&n.color.copyFrom(s,e.color,t),e.featureAttribute&&n.featureAttribute&&n.featureAttribute.copyFrom(s,e.featureAttribute,t)}const V=[],F=n.create(),U=r.create(),M=a.create(),O=n.create(),w=n.create(),H=[[1,0,1,1],[0,0,1,1],[0,1,0,1],[1,1,0,1],[1,0,0,1]];e.LodComponentData=R,e.LodLevelData=E,e.LodRenderer=L,e.lodRenderers=V,e.setLevelSelectorFactory=function(e){x=e},Object.defineProperty(e,"__esModule",{value:!0})}));
