/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/maybe","../../../../../chunks/vec3f64","../../../../../chunks/vec3","../../../../../chunks/mat4f64","../../../../../chunks/vec2f64","../../../../../chunks/vec4f64","../../../../../geometry/support/aaBoundingBox","../DefaultVertexAttributeLocations","../../../support/buffer/glUtil","../Util","../../../../webgl/BufferObject","../../../../webgl/Util","../../../../webgl/VertexArrayObject","../../materials/renderers/utils","../intersectorUtils","../Camera","../../../support/debugFlags","../../materials/internal/MaterialUtil","../../core/shaderLibrary/output/OutputHighlight.glsl","../../materials/DefaultMaterial","./InstanceData","./InstanceOctree","./LevelSelector","./RenderInstanceData"],(function(e,t,n,a,s,i,r,o,l,c,u,h,d,f,p,g,m,_,y,b,D,v,I,C,R,x){"use strict";let S=function(e){const t=e.baseBoundingSphere.radius,n=e.levels.map((e=>e.minScreenSpaceRadius));return new R.LevelSelector(t,n)};function E(e){S=e}let L=function(){function e(e,t){const n=e.renderContext.rctx,a=t.geometry,s=t.material;this.materialRep=e.materialRep,s.setParameterValues({instancedDoublePrecision:!0});const i=s.createBufferWriter(),r=i.vertexBufferLayout,o=i.elementCount(a),l=i.allocate(o);i.write({},a,l,0),this.geometry=a,this.material=s,this.glMaterials=g.acquireMaterials(s,this.materialRep),this.vertexBufferLayout=r,this.vbo=d.createVertex(n,35044,l.buffer),this.vao=new p(n,c.Default3D,{geometry:u.glLayout(r)},{geometry:this.vbo}),this.vertexCount=o}var n=e.prototype;return n.destroy=function(){g.releaseMaterials(this.material,this.materialRep),this.vbo.dispose(),this.vao.dispose()},n.intersect=function(e,t,n,a,s,i){const r=this.geometry.id,o=s.toString();this.material.intersect(this.geometry,null,e.transform.transform,e,n,a,((n,a,l,c)=>{if(n>=0){if(null!=t&&!t(e.rayBeginPoint,e.rayEndPoint,n))return;const u={type:"external",metadata:{layerUid:i.layerUid,graphicUid:i.graphicUid(s)}};if((null==e.results.min.drapedLayerOrder||c>=e.results.min.drapedLayerOrder)&&(null==e.results.min.dist||n<e.results.min.dist)&&(e.results.min.set(u,o,n,a,e.transform.transform,c,null,r,l),e.results.min.intersector="LodRenderer"),0!==e.options.store&&(null==e.results.max.drapedLayerOrder||c>=e.results.max.drapedLayerOrder)&&(null==e.results.max.dist||n>e.results.max.dist)&&(e.results.max.set(u,o,n,a,e.transform.transform,c,null,r,l),e.results.min.intersector="LodRenderer"),2===e.options.store){const t=new m.IntersectorResult(e.results.min.ray);t.set(u,o,n,a,e.transform.transform,c,null,r,l),t.intersector="LodRenderer",e.results.all.push(t)}}}))},t._createClass(e,[{key:"boundingInfo",get:function(){return this.geometry.boundingInfo}},{key:"triangleCount",get:function(){return this.vertexCount/3}}]),e}(),T=function(){function e(e,t){this.components=[],this.minScreenSpaceRadius=t.minScreenSpaceRadius,t.components.forEach((t=>{this.components.push(new L(e,t))}))}var s=e.prototype;return s.destroy=function(){this.components.forEach((e=>{e.destroy()}))},s.intersect=function(e,t,n,a,s,i){this.components.forEach((r=>{r.intersect(e,t,n,a,s,i)}))},t._createClass(e,[{key:"boundingBox",get:function(){if(!this._boundingBox){const e=l.empty();this.components.forEach((t=>{n.isSome(t.boundingInfo)&&(l.expandWithVec3(e,t.boundingInfo.bbMin),l.expandWithVec3(e,t.boundingInfo.bbMax))})),this._boundingBox=e}return this._boundingBox}},{key:"boundingSphere",get:function(){if(!this._boundingSphere){const e=this.boundingBox,t=a.create();l.center(e,t),this._boundingSphere={center:t,radius:.5*l.diameter(e)}}return this._boundingSphere}},{key:"triangleCount",get:function(){return this.components.reduce(((e,t)=>e+t.triangleCount),0)}}]),e}(),U=function(){function e(e,t,n,a){this.type="Lod",this.isGround=!1,this._inverseViewport=r.create(),this._levels=[],this._defaultRenderInstanceData=[],this._highlightRenderInstanceData=[],this._instanceIndex=0,this._slicePlane=!1,this._enableLevelSelection=!0,this._lastCamera=new _,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.canRender=!0,this._symbol=e,this._optionalFields=t,this._metadata=n,this._instanceBufferLayout=v.DefaultMaterial.getInstanceBufferLayout({instancedDoublePrecision:!0,instanced:t}),this._glInstanceBufferLayout=u.glLayout(this._instanceBufferLayout,{divisor:1}),this._instanceData=new I.InstanceData(this._optionalFields,a),this._instanceData.on("instance-added",(()=>{this.requestUpdateCycle()})),this._instanceData.on("instance-removed",(()=>{this.requestUpdateCycle()})),this._instanceData.on("instance-transform-changed",(e=>{this.requestUpdateCycle(),this._metadata.notifyGraphicGeometryChanged(e.index)})),this._instanceData.on("instance-visibility-changed",(e=>{this.requestUpdateCycle(!0),this._metadata.notifyGraphicVisibilityChanged(e.index)})),this._instanceData.on("instance-highlight-changed",(()=>{this.requestUpdateCycle(!0)})),this._enableLevelSelection=this._symbol.levels.length>1,A.push(this)}var n=e.prototype;return n.destroy=function(){A.splice(A.indexOf(this),1)},n.initializeRenderContext=function(e){this._context=e;const t=e.renderContext.rctx;this._symbol.levels.forEach((n=>{this._levels.push(new T(e,n)),this._defaultRenderInstanceData.push(new x.RenderInstanceData(t,this._instanceBufferLayout)),this._highlightRenderInstanceData.push(new x.RenderInstanceData(t,this._instanceBufferLayout))})),this._levelSelector=S(this)},n.uninitializeRenderContext=function(){this.invalidateOctree(),this._levels.forEach((e=>{e.destroy()})),this._defaultRenderInstanceData.forEach((e=>{e.destroy()})),this._highlightRenderInstanceData.forEach((e=>{e.destroy()}))},n.prepareRender=function(e){this.runUpdates(e)},n.render=function(e){const t=e.rctx,n=4===e.slot?3:6===e.slot?5:null;if(!n)return;if(!this.baseMaterial.isVisible()||!this.baseMaterial.isVisibleInPass(e.pass))return!1;const a=e.camera;this._inverseViewport[0]=1/a.fullViewport[2],this._inverseViewport[1]=1/a.fullViewport[3];const s={slot:n,origin:[0,0,0],camera:a,inverseViewport:this._inverseViewport,shadowMap:e.shadowMap,shadowMappingEnabled:!!e.shadowMap&&e.shadowMap.enabled,ssaoEnabled:!!e.ssaoHelper&&e.ssaoHelper.enabled,screenToWorldRatio:null,screenToWorldRatioGlobalWM:null,slicePlane:e.sliceHelper&&e.sliceHelper.plane,hudVisibilityTexture:e.offscreenRenderingHelper?e.offscreenRenderingHelper.hudVisibilityTexture:null,highlightDepthTexture:e.offscreenRenderingHelper?e.offscreenRenderingHelper.depthTexture:null,hasOccludees:!1,linearDepthTexture:null,linearDepthTextureUnit:0,lastFrameColorTexture:null,lastFrameColorTextureUnit:0,reprojectionMat:null,ssrEnabled:!1,lighting:e.scenelightingData,transparencyPassType:e.transparencyPassType,terrainLinearDepthTexture:e.multipassTerrainParams.terrainLinearDepthTexture,geometryLinearDepthTexture:e.multipassGeometryParams.geometryLinearDepthTexture,multipassTerrainEnabled:e.multipassTerrainParams.multipassTerrainEnabled,cullAboveGround:e.multipassTerrainParams.cullAboveGround,multipassGeometryEnabled:e.multipassGeometryParams.multipassGeometryEnabled};t.bindVAO();const i=5!==e.pass&&7!==e.pass,r=6!==e.pass;return i&&this.renderComponents(e,n,s,this._defaultRenderInstanceData),r&&this.renderComponents(e,n,s,this._highlightRenderInstanceData),!0},n.intersect=function(e,t,n,i){if(!this.baseMaterial.isVisible())return;const r=a.create();s.subtract(r,i,n);const o=a=>{this._instanceData.getCombinedModelTransform(a,w),e.transform.set(w),s.transformMat4(B,n,e.transform.inverse),s.transformMat4(H,i,e.transform.inverse);const r=this._instanceData.getState(a),o=this._instanceData.getLodLevel(a);h.assert(r&I.StateFlags.ACTIVE,"invalid instance state"),h.assert(o>=0&&o<this._levels.length,"invaid lod level"),this._levels[o].intersect(e,t,B,H,a,this._metadata)};this.baseMaterial.params.verticalOffset?this.octree.forEach(o):this.octree.forEachAlongRay(n,r,o)},n.queryDepthRange=function(e){return this.queryDepthRangeOctree(e)},n.notifyShaderTransformationChanged=function(){this.invalidateOctree()},n.requestUpdateCycle=function(e=!1){this._updateCyclesWithStaticCamera=-1,e&&(this._needFullCycle=!0),this.needsUpdates&&this._context.requestRender()},n.runUpdates=function(e){if(y.LOD_INSTANCE_RENDERER_DISABLE_UPDATES)return;if(this._enableLevelSelection){const t=e.equals(this._lastCamera);this._lastCamera.copyFrom(e),t||this.requestUpdateCycle()}const t=this._needFullCycle?this._instanceData.size:2e3;this._needFullCycle=!1,this.updateInstances(e,t),this.needsUpdates&&this._context.requestRender()},n.invalidateOctree=function(){this._octree&&(this._octree.destroy(),this._octree=null)},n.buildOctree=function(){const e=new C.InstanceOctree(this._instanceData,this.baseBoundingSphere),t=this._instanceData,n=t.view?t.view.state:null;for(let a=0;a<this._instanceData.capacity;++a){n.get(a)&I.StateFlags.ACTIVE&&e.addInstance(a)}return e},n.queryDepthRangeOctree=function(e){const t=e.eye,n=e.viewForward,a=this.octree.findClosest(n,"front-to-back",e.frustum),i=this.octree.findClosest(n,"back-to-front",e.frustum);if(null!=a&&null!=i){this._instanceData.view.boundingSphere.getVec(a,O),s.subtract(O,O,t);const r=s.dot(O,n)-O[3];this._instanceData.view.boundingSphere.getVec(i,O),s.subtract(O,O,t);const o=s.dot(O,n)+O[3];return{near:Math.max(e.near,r),far:Math.min(e.far,o)}}return{near:1/0,far:-1/0}},n.startUpdateCycle=function(){this._updateCyclesWithStaticCamera++,this._defaultRenderInstanceData.forEach((e=>{e.startUpdateCylce()})),this._highlightRenderInstanceData.forEach((e=>{e.startUpdateCylce()})),this.needsUpdates&&this._context.requestRender()},n.updateInstances=function(e,t){const n=this._enableLevelSelection,a=this._levelSelector;a.updateCamera(e),this._defaultRenderInstanceData.forEach((e=>{e.beginUpdate()})),this._highlightRenderInstanceData.forEach((e=>{e.beginUpdate()}));const s=this._instanceData,i=this._instanceData.view,r=s.size,o=s.capacity;let l=this._instanceIndex;t=Math.min(r,t);for(let c=0;c<t;++c){0===l&&this.startUpdateCycle();const e=i.state.get(l);let r=0;if(!(e&I.StateFlags.ALLOCATED)){l=(l+1)%o,t++;continue}const c=i.lodLevel.get(l);if(e&I.StateFlags.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[c].freeTail(),e&I.StateFlags.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[c].freeTail(),e&I.StateFlags.REMOVE)s.freeInstance(l);else if(e&I.StateFlags.VISIBLE){let t=0;n&&(i.modelOrigin.getVec(l,M),t=a.selectLevel(M,s.getCombinedMedianScaleFactor(l))),r=e&~(I.StateFlags.ACTIVE|I.StateFlags.TRANSFORM_CHANGED),t>=0&&(e&I.StateFlags.HIGHLIGHT?(V(this._highlightRenderInstanceData[t],i,l),r|=I.StateFlags.HIGHLIGHT_ACTIVE):(V(this._defaultRenderInstanceData[t],i,l),r|=I.StateFlags.DEFAULT_ACTIVE)),i.state.set(l,r),i.lodLevel.set(l,t)}else r=e&~(I.StateFlags.ACTIVE|I.StateFlags.TRANSFORM_CHANGED),i.state.set(l,r);if(this._octree){const t=!!(e&I.StateFlags.ACTIVE),n=!!(r&I.StateFlags.ACTIVE);!t&&n?this._octree.addInstance(l):t&&!n?this._octree.removeInstance(l):t&&n&&e&I.StateFlags.TRANSFORM_CHANGED&&(this._octree.removeInstance(l),this._octree.addInstance(l))}l=(l+1)%o}this._instanceIndex=l,this._defaultRenderInstanceData.forEach((e=>{e.endUpdate()})),this._highlightRenderInstanceData.forEach((e=>{e.endUpdate()}))},n.renderComponents=function(e,t,n,a){this.levels.forEach(((s,i)=>{s.components.forEach((s=>{this.renderComponent(e,t,n,a[i],s,i)}))}))},n.renderComponent=function(e,t,n,a,s,i){const r=s.glMaterials.get(e.pass);if(!r||!r.beginSlot(t)||0===a.size)return;const o=e.rctx,l=o.capabilities.instancing;r.ensureParameters(n);const u=r.getTechnique(),d=r.getPipelineState(t);o.setPipelineState(d),r.bind(o,n),o.bindVAO(s.vao),u.ensureAttributeLocations(s.vao);const p=u.program;e.isHighlightPass&&D.OutputHighlight.bindOutputHighlight(o,p,n),u.bindDraw(n),y.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&0===e.pass&&(p.setUniform4fv("externalColor",k[Math.min(i,k.length-1)]),p.setUniform1i("colorMixMode",b.colorMixModes.replace));const g=a.capacity,m=a.headIndex,_=a.tailIndex,v=a.firstIndex,I=this._glInstanceBufferLayout,C=(e,t)=>{f.bindVertexBufferLayout(o,c.Default3D,a.buffer,I,e),l.drawArraysInstanced(u.primitiveType,0,s.vertexCount,t-e),f.unbindVertexBufferLayout(o,c.Default3D,a.buffer,I)};s.material.params.transparent&&null!=v?m>_?(h.assert(v>=_&&v<=m,"invalid firstIndex"),C(v,m),C(_,v)):m<_&&(v<=m?(h.assert(v>=0&&v<=m,"invalid firstIndex"),C(v,m),C(_,g),C(0,v)):(h.assert(v>=_&&v<=g,"invalid firstIndex"),C(v,g),C(0,m),C(_,v))):m>_?C(_,m):m<_&&(C(0,m),C(_,g)),o.bindVAO(null)},t._createClass(e,[{key:"levels",get:function(){return this._levels}},{key:"baseBoundingBox",get:function(){return this._levels[this._levels.length-1].boundingBox}},{key:"baseBoundingSphere",get:function(){return this._levels[this._levels.length-1].boundingSphere}},{key:"baseMaterial",get:function(){return this._levels[this._levels.length-1].components[0].material}},{key:"slicePlane",get:function(){return this._slicePlane},set:function(e){this._slicePlane=e}},{key:"intersectionHandlerId",get:function(){return this._metadata.layerUid}},{key:"instanceData",get:function(){return this._instanceData}},{key:"memoryUsage",get:function(){const e={cpu:0,gpu:0};return this._defaultRenderInstanceData.forEach((t=>{const n=t.memoryUsage;e.cpu+=n.cpu,e.gpu+=n.gpu})),this._highlightRenderInstanceData.forEach((t=>{const n=t.memoryUsage;e.cpu+=n.cpu,e.gpu+=n.gpu})),e}},{key:"renderStats",get:function(){const e=this._instanceData.size,t=[];return this._levels.forEach(((e,n)=>{const a=this._defaultRenderInstanceData[n],s=this._highlightRenderInstanceData[n],i=a.size+s.size,r=e.triangleCount;t.push({renderedInstances:i,renderedTriangles:i*r,trianglesPerInstance:r})})),{totalInstances:e,renderedInstances:t.reduce(((e,t)=>e+t.renderedInstances),0),renderedTriangles:t.reduce(((e,t)=>e+t.renderedTriangles),0),levels:t}}},{key:"slots",get:function(){return[4,6]}},{key:"needsHighlight",get:function(){return this._highlightRenderInstanceData.reduce(((e,t)=>e+t.size),0)>0}},{key:"needsUpdates",get:function(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}},{key:"octree",get:function(){return this._octree||(this._octree=this.buildOctree()),this._octree}}]),e}();function V(e,t,n){const a=e.allocateHead();F(t,n,e.view,a)}function F(e,t,n,a){g.encodeDoubleVec3(e.modelOrigin,t,n.modelOriginHi,n.modelOriginLo,a),n.model.copyFrom(a,e.model,t),n.modelNormal.copyFrom(a,e.modelNormal,t),e.color&&n.color&&n.color.copyFrom(a,e.color,t),e.featureAttribute&&n.featureAttribute&&n.featureAttribute.copyFrom(a,e.featureAttribute,t)}const A=[],M=a.create(),O=o.create(),w=i.create(),B=a.create(),H=a.create(),k=[[1,0,1,1],[0,0,1,1],[0,1,0,1],[1,1,0,1],[1,0,0,1]];e.LodComponentData=L,e.LodLevelData=T,e.LodRenderer=U,e.lodRenderers=A,e.setLevelSelectorFactory=E,Object.defineProperty(e,"__esModule",{value:!0})}));
