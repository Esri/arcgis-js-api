// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/extendsHelper","../../../../../core/libs/gl-matrix-2/mat4f64","../../../../../core/libs/gl-matrix-2/vec3","../../../../../core/libs/gl-matrix-2/vec3f64","../../../../../core/libs/gl-matrix-2/vec4f64","../../../../../geometry/support/aaBoundingBox","../../../support/debugFlags","../../../support/buffer/glUtil","../Camera","../DefaultVertexAttributeLocations","../intersectorUtils","../Util","./InstanceData","./InstanceOctree","./LevelSelector","./RenderInstanceData","./utils","../../materials/DefaultMaterial","../../materials/internal/MaterialUtil","../../../../webgl/BufferObject","../../../../webgl/Util","../../../../webgl/VertexArrayObject"],function(e,t,n,r,a,i,s,o,l,c,u,d,h,f,p,g,b,v,m,y,_,I,D,C){function x(e){R=e}function S(e,t,n,r){m.encodeDoubleVec3(e.modelOrigin,t,n.modelOriginHi,n.modelOriginLo,r),n.model.copyFrom(r,e.model,t),n.modelNormal.copyFrom(r,e.modelNormal,t),e.color&&n.color&&n.color.copyFrom(r,e.color,t),e.featureAttribute&&n.featureAttribute&&n.featureAttribute.copyFrom(r,e.featureAttribute,t)}Object.defineProperty(t,"__esModule",{value:!0});var R=function(e){var t=e.baseBoundingSphere.radius,n=e.levels.map(function(e){return e.minScreenSpaceRadius});return new b.LevelSelector(t,n)};t.setLevelSelectorFactory=x;var E=function(){function e(e,t){this.glMaterials={};var n=e.rctx,r=t.geometry,a=t.material,i=r.data.toRenderData();this.materialRep=e.materialRep,a.setParameterValues({instancedDoublePrecision:!0});var s=a.createBufferWriter(),o=s.vertexBufferLayout,l=s.elementCount(i),u=s.allocate(l);s.write({},i,u,0),this.geometry=r,this.material=a,this.glMaterials=m.acquireGLMaterials(a,this.materialRep),this.vertexBufferLayout=o,this.vbo=I.createVertex(n,35044,u.buffer),this.vao=new C(n,d.Default3D,{geometry:c.glLayout(o)},{geometry:this.vbo}),this.vertexCount=l}return e.prototype.destroy=function(){m.releaseGLMaterials(this.material,this.materialRep),this.vbo.dispose(),this.vao.dispose()},Object.defineProperty(e.prototype,"boundingInfo",{get:function(){return this.geometry.boundingInfo},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"triangleCount",{get:function(){return this.vertexCount/3},enumerable:!0,configurable:!0}),e.prototype.intersect=function(e,t,n,r,a,i){var s=this.geometry.id,o=a.toString();this.material.intersect(this.geometry,null,e.transform.transform,e,n,r,function(n,r,l,c,u,d){if(n>=0){if(null!=t&&!t(e.rayBeginPoint,e.rayEndPoint,n))return;var f={type:"external",metadata:{layerUid:i.layerUid,graphicUid:i.graphicUid(a)}};if((null==e.results.min.drapedLayerOrder||c>=e.results.min.drapedLayerOrder)&&(null==e.results.min.dist||n<e.results.min.dist)&&(e.results.min.set(f,o,n,r,e.transform.transform,c,null,s,l),e.results.min.intersector="LodRenderer"),(null==e.results.max.drapedLayerOrder||c>=e.results.max.drapedLayerOrder)&&(null==e.results.max.dist||n>e.results.max.dist)&&(e.results.max.set(f,o,n,r,e.transform.transform,c,null,s,l),e.results.min.intersector="LodRenderer"),e.enable.storeAll){var p=new h.IntersectorResult(e.results.min.ray);p.set(f,o,n,r,e.transform.transform,c,null,s,l),p.intersector="LodRenderer",e.results.all.push(p)}}},null)},e}();t.LodComponentData=E;var L=function(){function e(e,t){var n=this;this.components=[],this.minScreenSpaceRadius=t.minScreenSpaceRadius,t.components.forEach(function(t){n.components.push(new E(e,t))})}return e.prototype.destroy=function(){this.components.forEach(function(e){e.destroy()})},e.prototype.intersect=function(e,t,n,r,a,i){this.components.forEach(function(s){s.intersect(e,t,n,r,a,i)})},Object.defineProperty(e.prototype,"boundingBox",{get:function(){if(!this._boundingBox){var e=o.empty();this.components.forEach(function(t){o.expand(e,t.boundingInfo.bbMin),o.expand(e,t.boundingInfo.bbMax)}),this._boundingBox=e}return this._boundingBox},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"boundingSphere",{get:function(){if(!this._boundingSphere){var e=this.boundingBox,t=i.vec3f64.create();o.center(e,t),this._boundingSphere={center:t,radius:.5*o.diameter(e)}}return this._boundingSphere},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"triangleCount",{get:function(){return this.components.reduce(function(e,t){return e+t.triangleCount},0)},enumerable:!0,configurable:!0}),e}();t.LodLevelData=L;var O=function(){function e(e,n,r,a){var i=this;this._levels=[],this._renderInstanceData=[],this._highlightRenderInstanceData=[],this._instanceIndex=0,this._slicePlaneEnabled=!1,this._enableLevelSelection=!0,this._lastCamera=new u.default,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.canRender=!0,this._symbol=e,this._optionalFields=n,this._metadata=r,this._instanceBufferLayout=y.getInstanceBufferLayout({instancedDoublePrecision:!0,instanced:n}),this._glInstanceBufferLayout=c.glLayout(this._instanceBufferLayout,{divisor:1}),this._instanceData=new p.InstanceData(this._optionalFields,a),this._instanceData.on("instance-added",function(e){i.requestUpdateCycle()}),this._instanceData.on("instance-removed",function(e){i.requestUpdateCycle()}),this._instanceData.on("instance-transform-changed",function(e){i.requestUpdateCycle()}),this._instanceData.on("instance-visibility-changed",function(e){i.requestUpdateCycle(!0)}),this._instanceData.on("instance-highlight-changed",function(e){i.requestUpdateCycle(!0)}),this._enableLevelSelection=this._symbol.levels.length>1,t.lodRenderers.push(this)}return e.prototype.destroy=function(){t.lodRenderers.splice(t.lodRenderers.indexOf(this),1)},Object.defineProperty(e.prototype,"levels",{get:function(){return this._levels},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"baseBoundingBox",{get:function(){return this._levels[this._levels.length-1].boundingBox},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"baseBoundingSphere",{get:function(){return this._levels[this._levels.length-1].boundingSphere},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"baseMaterial",{get:function(){return this._levels[this._levels.length-1].components[0].material},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"slicePlaneEnabled",{get:function(){return this._slicePlaneEnabled},set:function(e){this._slicePlaneEnabled=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"intersectionHandlerId",{get:function(){return this._metadata.layerUid},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"instanceData",{get:function(){return this._instanceData},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"memoryUsage",{get:function(){var e={cpu:0,gpu:0};return this._renderInstanceData.forEach(function(t){var n=t.memoryUsage;e.cpu+=n.cpu,e.gpu+=n.gpu}),this._highlightRenderInstanceData.forEach(function(t){var n=t.memoryUsage;e.cpu+=n.cpu,e.gpu+=n.gpu}),e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"renderStats",{get:function(){var e=this,t=this._instanceData.size,n=[];return this._levels.forEach(function(t,r){var a=e._renderInstanceData[r],i=e._highlightRenderInstanceData[r],s=a.size+i.size,o=t.triangleCount;n.push({renderedInstances:s,renderedTriangles:s*o,trianglesPerInstance:o})}),{totalInstances:t,renderedInstances:n.reduce(function(e,t){return e+t.renderedInstances},0),renderedTriangles:n.reduce(function(e,t){return e+t.renderedTriangles},0),levels:n}},enumerable:!0,configurable:!0}),e.prototype.initializeRenderContext=function(e){var t=this;this._initContext=e;var n=e.rctx;this._symbol.levels.forEach(function(r){t._levels.push(new L(e,r)),t._renderInstanceData.push(new v.RenderInstanceData(n,t._instanceBufferLayout)),t._highlightRenderInstanceData.push(new v.RenderInstanceData(n,t._instanceBufferLayout))}),this._levelSelector=R(this)},e.prototype.uninitializeRenderContext=function(e){this.invalidateOctree(),this._levels.forEach(function(e){e.destroy()}),this._renderInstanceData.forEach(function(e){e.destroy()}),this._highlightRenderInstanceData.forEach(function(e){e.destroy()})},Object.defineProperty(e.prototype,"slots",{get:function(){return[6,8]},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"needsHighlight",{get:function(){return this._highlightRenderInstanceData.reduce(function(e,t){return e+t.size},0)>0},enumerable:!0,configurable:!0}),e.prototype.prepareRender=function(e){this.runUpdates(e)},e.prototype.render=function(e){var t=e.rctx,n=6===e.slot?5:8===e.slot?7:null;if(n){if(!this.baseMaterial.isVisible()||!this.baseMaterial.isVisibleInPass(e.pass))return!1;var r=e.camera,a={view:r.viewMatrix,proj:r.projectionMatrix,origin:[0,0,0],viewInvTransp:r.viewInverseTransposeMatrix,viewport:r.viewport,fovY:r.fovY,nearFar:[r.near,r.far],shadowMap:e.shadowMap,shadowMappingEnabled:!!e.shadowMap&&e.shadowMap.enabled,ssaoEnabled:!!e.ssaoHelper&&e.ssaoHelper.enabled,pixelRatio:r.pixelRatio,slicePlane:e.sliceHelper&&e.sliceHelper.plane,cameraAboveGround:r.aboveGround,hudVisibilityTexture:e.offscreenRenderingHelper?e.offscreenRenderingHelper.hudVisibilityTexture:null};t.bindVAO();for(var i=0;i<this._levels.length;++i){var s=e.isHighlightPass?this._highlightRenderInstanceData[i]:this._renderInstanceData[i];this.renderLevel(e,n,a,s,i)}return!0}},e.prototype.intersect=function(e,t,n,r,s){var o=this;if(this.baseMaterial.isVisible()){var l=i.vec3f64.create();a.vec3.subtract(l,r,n);var c=function(i){o._instanceData.getCombinedModelTransform(i,P),e.transform.set(P),a.vec3.transformMat4(U,n,e.transform.inverse),a.vec3.transformMat4(A,r,e.transform.inverse);var s=o._instanceData.getState(i),l=o._instanceData.getLodLevel(i);f.assert(s&p.StateFlags.ACTIVE,"invalid instance state"),f.assert(l>=0&&l<o._levels.length,"invaid lod level"),o._levels[l].intersect(e,t,U,A,i,o._metadata)};this.baseMaterial.getParameters().verticalOffset?this.octree.forEach(c):this.octree.forEachAlongRay(n,l,c)}},e.prototype.queryDepthRange=function(e){return this.queryDepthRangeOctree(e)},e.prototype.notifyShaderTransformationChanged=function(){this.invalidateOctree()},e.prototype.requestUpdateCycle=function(e){void 0===e&&(e=!1),this._updateCyclesWithStaticCamera=-1,e&&(this._needFullCycle=!0),this.needsUpdates&&this._initContext.requestRender()},Object.defineProperty(e.prototype,"needsUpdates",{get:function(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1},enumerable:!0,configurable:!0}),e.prototype.runUpdates=function(e){if(!l.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){var t=e.equals(this._lastCamera);this._lastCamera.copyFrom(e),t||this.requestUpdateCycle()}var n=this._needFullCycle?this._instanceData.size:2e3;this._needFullCycle=!1,this.updateInstances(e,n),this.needsUpdates&&this._initContext.requestRender()}},Object.defineProperty(e.prototype,"octree",{get:function(){return this._octree||(this._octree=this.buildOctree()),this._octree},enumerable:!0,configurable:!0}),e.prototype.invalidateOctree=function(){this._octree&&(this._octree.destroy(),this._octree=null)},e.prototype.buildOctree=function(){for(var e=new g.InstanceOctree(this._instanceData,this.baseBoundingSphere),t=this._instanceData,n=t.view?t.view.state:null,r=0;r<this._instanceData.capacity;++r){n.get(r)&p.StateFlags.ACTIVE&&e.addInstance(r)}return e},e.prototype.queryDepthRangeOctree=function(e){var t=e.eye,n=e.viewForward,r=this.octree.findClosest(n,"front-to-back",e.frustum),i=this.octree.findClosest(n,"back-to-front",e.frustum);if(null!=r&&null!=i){this._instanceData.view.boundingSphere.getVec(r,M),a.vec3.subtract(M,M,t);var s=a.vec3.dot(M,n)-M[3];this._instanceData.view.boundingSphere.getVec(i,M),a.vec3.subtract(M,M,t);var o=a.vec3.dot(M,n)+M[3];return{near:Math.max(e.near,s),far:Math.min(e.far,o)}}return{near:1/0,far:-1/0}},e.prototype.startUpdateCycle=function(){this._updateCyclesWithStaticCamera++,this._renderInstanceData.forEach(function(e){e.startUpdateCylce()}),this._highlightRenderInstanceData.forEach(function(e){e.startUpdateCylce()}),this.needsUpdates&&this._initContext.requestRender()},e.prototype.updateInstances=function(e,t){var n=this._enableLevelSelection,r=this._levelSelector;r.updateCamera(e),this._renderInstanceData.forEach(function(e){e.beginUpdate()}),this._highlightRenderInstanceData.forEach(function(e){e.beginUpdate()});var a=this._instanceData,i=this._instanceData.view,s=a.size,o=a.capacity,l=this._instanceIndex;t=Math.min(s,t);for(var c=0;c<t;++c){0===l&&this.startUpdateCycle();var u=i.state.get(l),d=0;if(u&p.StateFlags.ALLOCATED){var h=i.lodLevel.get(l);if(u&p.StateFlags.ACTIVE&&this._renderInstanceData[h].freeTail(),u&p.StateFlags.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[h].freeTail(),u&p.StateFlags.REMOVE)a.freeInstance(l);else if(u&p.StateFlags.VISIBLE){var f=0;if(n&&(i.modelOrigin.getVec(l,w),f=r.selectLevel(w,a.getCombinedMedianScaleFactor(l))),d=u&~(p.StateFlags.ACTIVE|p.StateFlags.HIGHLIGHT_ACTIVE|p.StateFlags.TRANSFORM_CHANGED),f>=0){var g=this._renderInstanceData[f],b=g.allocateHead();if(S(i,l,g.view,b),d|=p.StateFlags.ACTIVE,u&p.StateFlags.HIGHLIGHT){var v=this._highlightRenderInstanceData[f],m=v.allocateHead();S(i,l,v.view,m),d|=p.StateFlags.HIGHLIGHT_ACTIVE}}i.state.set(l,d),i.lodLevel.set(l,f)}else d=u&~(p.StateFlags.ACTIVE|p.StateFlags.HIGHLIGHT_ACTIVE|p.StateFlags.TRANSFORM_CHANGED),i.state.set(l,d);if(this._octree){var y=!!(u&p.StateFlags.ACTIVE),_=!!(d&p.StateFlags.ACTIVE);!y&&_?this._octree.addInstance(l):y&&!_?this._octree.removeInstance(l):y&&_&&u&p.StateFlags.TRANSFORM_CHANGED&&(this._octree.removeInstance(l),this._octree.addInstance(l))}l=(l+1)%o}else l=(l+1)%o,t++}this._instanceIndex=l,this._renderInstanceData.forEach(function(e){e.endUpdate()}),this._highlightRenderInstanceData.forEach(function(e){e.endUpdate()})},e.prototype.renderLevel=function(e,t,n,r,a){var i=this;this._levels[a].components.forEach(function(s){i.renderComponent(e,t,n,r,s,a)})},e.prototype.renderComponent=function(e,t,n,r,a,i){var s=a.glMaterials[e.pass];if(s&&s.beginSlot(t)&&s.isVisible()&&s.isVisibleInPass(e.pass)&&0!==r.size){var o=e.rctx,c=o.capabilities.instancing,u=s.getDrawMode();n.origin=[0,0,0],s.bind(o,n),o.bindVAO(a.vao);var h=s.getProgram();if(D.assertCompatibleVertexAttributeLocations(a.vao,h),e.isHighlightPass){var p=e.offscreenRenderingHelper?e.offscreenRenderingHelper.depthTexture:null;o.bindTexture(p,5),h.setUniform1i("depthTex",5),h.setUniform4f("highlightViewportPixelSz",0,0,1/n.viewport[2],1/n.viewport[3])}s.bindView(o,n),l.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&0===e.pass&&(h.setUniform4fv("externalColor",F[Math.min(i,F.length-1)]),h.setUniform1i("colorMixMode",_.colorMixModes.replace));var g=r.capacity,b=r.headIndex,v=r.tailIndex,m=r.firstIndex,y=this._glInstanceBufferLayout,I=function(e,t){D.bindVertexBufferLayout(o,d.Default3D,r.buffer,y,e),c.drawArraysInstanced(u,0,a.vertexCount,t-e),D.unbindVertexBufferLayout(o,d.Default3D,r.buffer,y)};a.material.getParameters().transparent&&null!=m?b>v?(f.assert(m>=v&&m<=b,"invalid firstIndex"),I(m,b),I(v,m)):b<v&&(m<=b?(f.assert(m>=0&&m<=b,"invalid firstIndex"),I(m,b),I(v,g),I(0,m)):(f.assert(m>=v&&m<=g,"invalid firstIndex"),I(m,g),I(0,b),I(v,m))):b>v?I(v,b):b<v&&(I(0,b),I(v,g)),o.bindVAO(null),s.release(o,n)}},e}();t.LodRenderer=O,t.lodRenderers=[];var w=i.vec3f64.create(),M=s.vec4f64.create(),P=r.mat4f64.create(),U=i.vec3f64.create(),A=i.vec3f64.create(),F=[[1,0,1,1],[0,0,1,1],[0,1,0,1],[1,1,0,1],[1,0,0,1]]});