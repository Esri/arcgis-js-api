/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/Evented","../../../../core/Handles","../../../../core/maybe","../../../../core/PooledArray","./ContentObject","./ContentObjectType","./DirtyEvents","./Octree","./UpdatePolicy"],(function(e,t,s,i,o,n,r,a,c,d,h){"use strict";let l=function(e){function r(t,o=""){var r;return(r=e.call(this)||this).apiLayerUid=o,r.type=a.ContentObjectType.Layer,r.events=new s,r.sliceable=!1,r._objects=new n,r._objectsAdded=new n,r._stageHandles=new i,r.apiLayerUid=o,r.visible=t?.visible??!0,r.pickable=t?.pickable??!0,r.updatePolicy=t?.updatePolicy??h.UpdatePolicy.ASYNC,r._disableOctree=t?.disableOctree??!1,r}t._inheritsLoose(r,e);var l=r.prototype;return l.destroy=function(){this.detachStage(),this._stage=null},l.attachStage=function(e){this.detachStage(),this._stage=e;for(const t of c.DirtyEventNames)this._stageHandles.add(this.events.on(t,(s=>e.handleEvent(t,s))))},l.detachStage=function(){this._stageHandles.removeAll(),this.invalidateSpatialQueryAccelerator()},l.add=function(e){this._objects.push(e),e.parentLayer=this,this.events.emit("layerObjectAdded",{layer:this,object:e}),o.isSome(this._octree)&&this._objectsAdded.push(e)},l.remove=function(e){this._objects.removeUnordered(e)&&(e.parentLayer=null,this.events.emit("layerObjectRemoved",{layer:this,object:e}),o.isSome(this._octree)&&(this._objectsAdded.removeUnordered(e)||this._octree.remove([e])))},l.addMany=function(e){this._objects.pushArray(e);for(const t of e)t.parentLayer=this;this.events.emit("layerObjectsAdded",{layer:this,objects:e}),o.isSome(this._octree)&&this._objectsAdded.pushArray(e)},l.removeMany=function(e){const t=new Array;if(this._objects.removeUnorderedMany(e,e.length,t),0!==t.length){for(const e of t)e.parentLayer=null;if(this.events.emit("layerObjectsRemoved",{layer:this,objects:t}),o.isSome(this._octree)){for(let e=0;e<t.length;)this._objectsAdded.removeUnordered(t[e])?(t[e]=t[t.length-1],t.length-=1):++e;this._octree.remove(t)}}},l.sync=function(){o.isSome(this._stage)&&this.updatePolicy!==h.UpdatePolicy.SYNC&&this._stage.syncLayer(this.id)},l.notifyObjectBBChanged=function(e,t){o.isSome(this._octree)&&!this._objectsAdded.includes(e)&&this._octree.update(e,t)},l.getSpatialQueryAccelerator=function(){return o.isNone(this._octree)&&this._objects.length>50&&!this._disableOctree?(this._octree=new d((e=>e.boundingVolumeWorldSpace.bounds)),this._octree.add(this._objects.data,this._objects.length)):o.isSome(this._octree)&&this._objectsAdded.length>0&&(this._octree.add(this._objectsAdded.data,this._objectsAdded.length),this._objectsAdded.clear()),this._octree},l.shaderTransformationChanged=function(){this.invalidateSpatialQueryAccelerator(),this.events.emit("shaderTransformationChanged",this)},l.invalidateSpatialQueryAccelerator=function(){this._octree=o.destroyMaybe(this._octree),this._objectsAdded.clear()},t._createClass(r,[{key:"objects",get:function(){return this._objects}}]),r}(r.ContentObject);function y(e){return o.isSome(e)&&e.type===a.ContentObjectType.Layer}e.WebGLLayer=l,e.isWebGLLayer=y,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
