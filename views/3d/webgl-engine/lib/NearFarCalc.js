// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.5/esri/copyright.txt for details.

define(["require","exports","./Util","./gl-matrix","./ComponentUtils"],function(e,t,r,i,n){var a=i.vec3d,s=i.vec4d,o=i.mat4d,h=function(){function e(){this._context={content:[],near:[],far:[],nearSpecial:[],farSpecial:[],bestNear:0,bestFar:0,bestNear2:0,bestFar2:0},this._boundingInfoHelper=new c}return e.prototype._resetContext=function(){var e=this._context;return e.content.length=0,e.near.length=0,e.far.length=0,e.nearSpecial.length=0,e.farSpecial.length=0,e.bestNear=Number.MAX_VALUE,e.bestFar=-Number.MAX_VALUE,this._context},e.prototype.calculateSceneNearFar=function(e,t){var r=this._resetContext(),i=e.viewMatrix,a=i[2],s=i[6],o=i[10],h=i[14],c=0;for(var l in t){var p=t[l],f=p.instanceParameters.componentVisibilities,u=p.componentOffsets;if(!n.isAllHidden(f,u)&&p.castShadow){var v=void 0,b=void 0;p.hasShaderTransformation?(v=p.getBoundingSphere(p.getShaderTransformation(),null,_),b=_):(v=p.bsRadius,b=p.center);var d=a*b[0]+s*b[1]+o*b[2]+h,g=d-v,x=d+v;r.content[c]=p,r.near[c]=-x,r.far[c]=-g,++c}}if(0===c)return[r.bestNear,r.bestFar];for(var F=0;c>F;++F)r.near[F]>r.bestFar&&(r.bestFar=r.near[F]),r.near[F]>2&&r.far[F]<r.bestNear&&(r.bestNear=r.far[F]);r.bestNear2=Math.max(.5*r.bestNear,2),r.bestFar2=2*r.bestFar;for(var m=0,N=0,F=0;c>F;++F)r.near[F]<r.bestNear&&(r.near[F]>=r.bestNear2?r.bestNear=r.near[F]:r.nearSpecial[m++]=F),r.far[F]>r.bestFar&&(r.far[F]<=r.bestFar2?r.bestFar=r.far[F]:r.farSpecial[N++]=F);if(0===m&&0===N)return[r.bestNear,r.bestFar];r.nearSpecial.length=m,r.farSpecial.length=N,r.nearSpecial.sort(function(e,t){return r.near[e]<r.near[t]?-1:r.near[e]>r.near[t]?1:0}),r.farSpecial.sort(function(e,t){return r.far[e]<r.far[t]?1:r.far[e]>r.far[t]?-1:0}),this._boundingInfoHelper.init(e,r);for(var F=0;m>F;++F)if(r.near[r.nearSpecial[F]]<r.bestNear){var p=r.content[r.nearSpecial[F]],B=p.boundingInfo;this._boundingInfoHelper.includeNearBoundingInfoRec(B,p.getShaderTransformation())}for(var F=0;N>F;++F)if(r.far[r.farSpecial[F]]>r.bestFar){var p=r.content[r.farSpecial[F]],B=p.boundingInfo;this._boundingInfoHelper.includeFarBoundingInfoRec(B,p.getShaderTransformation())}return[r.bestNear,r.bestFar]},e}(),c=function(){function e(){this._clippingHelper=new l,this._planes=[s.create(),s.create(),s.create(),s.create(),s.create(),s.create()],this._viewProj=o.create(),this._view=o.create()}return e.prototype.init=function(e,t){this._context=t,o.set(e.viewMatrix,this._view),o.multiply(e.projectionMatrix,this._view,this._viewProj),e.copyFrustumPlanes(this._planes),this._clippingHelper.init(t)},e.prototype.includeNearBoundingInfoRec=function(e,t){var r=e.getBSRadius(),i=e.getCenter();o.multiplyVec3(t,i,_);var n=t[0]*t[0]+t[4]*t[4]+t[8]*t[8],a=t[1]*t[1]+t[5]*t[5]+t[9]*t[9],s=t[2]*t[2]+t[6]*t[6]+t[10]*t[10],h=Math.sqrt(Math.max(Math.max(n,a),s)),c=_[0],l=_[1],p=_[2];if(r*=h,!(this._planes[0][0]*c+this._planes[0][1]*l+this._planes[0][2]*p+this._planes[0][3]>r||this._planes[1][0]*c+this._planes[1][1]*l+this._planes[1][2]*p+this._planes[1][3]>r||this._planes[2][0]*c+this._planes[2][1]*l+this._planes[2][2]*p+this._planes[2][3]>r||this._planes[3][0]*c+this._planes[3][1]*l+this._planes[3][2]*p+this._planes[3][3]>r)){var f=this._view[2]*c+this._view[6]*l+this._view[10]*p+this._view[14],u=f-r,v=f+r;if(!(2>-u||-v>=this._context.bestNear)){if(-v>this._context.bestNear2)return void(this._context.bestNear=-v);if(r>100){var b=e.getChildren();if(void 0!==b){for(var d=0;8>d;++d)void 0!==b[d]&&this.includeNearBoundingInfoRec(b[d],t);return}}this._clippingHelper.intersectFrustumAABB(this._viewProj,t,e.getBBMin(),e.getBBMax())}}},e.prototype.includeFarBoundingInfoRec=function(e,t){var r=e.getBSRadius(),i=e.getCenter();o.multiplyVec3(t,i,_);var n=t[0]*t[0]+t[4]*t[4]+t[8]*t[8],a=t[1]*t[1]+t[5]*t[5]+t[9]*t[9],s=t[2]*t[2]+t[6]*t[6]+t[10]*t[10],h=Math.sqrt(Math.max(Math.max(n,a),s)),c=_[0],l=_[1],p=_[2];if(r*=h,!(this._planes[0][0]*c+this._planes[0][1]*l+this._planes[0][2]*p+this._planes[0][3]>r||this._planes[1][0]*c+this._planes[1][1]*l+this._planes[1][2]*p+this._planes[1][3]>r||this._planes[2][0]*c+this._planes[2][1]*l+this._planes[2][2]*p+this._planes[2][3]>r||this._planes[3][0]*c+this._planes[3][1]*l+this._planes[3][2]*p+this._planes[3][3]>r)){var f=this._view[2]*c+this._view[6]*l+this._view[10]*p+this._view[14],u=f-r;if(!(-u<=this._context.bestFar)){if(-u<this._context.bestFar2)return void(this._context.bestFar=-u);if(r>100){var v=e.getChildren();if(void 0!==v){for(var b=0;8>b;++b)void 0!==v[b]&&this.includeFarBoundingInfoRec(v[b],t);return}}this._clippingHelper.intersectFrustumAABB(this._viewProj,t,e.getBBMin(),e.getBBMax())}}},e}(),l=function(){function e(){this._clipP=new Array(8);for(var e=0;8>e;++e)this._clipP[e]=s.create()}return e.prototype.init=function(e){this._context=e},e.prototype.intersectFrustumAABB=function(e,t,r,i){o.multiply(e,t,f);for(var n=0;8>n;++n){var a=this._clipP[n],s=0===n||3===n||4===n||7===n?r[0]:i[0],h=0===n||1===n||4===n||5===n?r[1]:i[1],c=4>n?r[2]:i[2];a[0]=f[0]*s+f[4]*h+f[8]*c+f[12],a[1]=f[1]*s+f[5]*h+f[9]*c+f[13],a[2]=f[2]*s+f[6]*h+f[10]*c+f[14],a[3]=f[3]*s+f[7]*h+f[11]*c+f[15]}for(var n=0;12>n;++n){for(var l=this._clipP[p[n][0]],_=this._clipP[p[n][1]],u=this._clipP[p[n][2]],v=this._clipTriangle(l,_,u),b=!0,d=0;d<v.length;++d){var g=v[d][3];if(g>=2){b=!1;break}}if(!b)for(var d=0;d<v.length;++d){var g=v[d][3];g<this._context.bestNear&&(this._context.bestNear=g),g>this._context.bestFar&&(this._context.bestFar=g)}}},e.prototype._inside=function(e,t){return 0===t?e[0]>=-e[3]:1===t?e[1]>=-e[3]:2===t?e[0]<=e[3]:3===t?e[1]<=e[3]:void r.assert(!1)},e.prototype._intersect=function(e,t,r){var i=0;return 0===r?i=(-e[3]-e[0])/(t[0]-e[0]+t[3]-e[3]):1===r?i=(-e[3]-e[1])/(t[1]-e[1]+t[3]-e[3]):2===r?i=(e[3]-e[0])/(t[0]-e[0]-t[3]+e[3]):3===r&&(i=(e[3]-e[1])/(t[1]-e[1]-t[3]+e[3])),s.lerp(e,t,i,s.create())},e.prototype._clipTriangle=function(e,t,r){for(var i=[e,t,r],n=0;4>n;++n){var a=i;i=[];for(var s=0;s<a.length;++s){var o=a[s],h=a[(s+1)%a.length];this._inside(h,n)?(this._inside(o,n)||i.push(this._intersect(o,h,n)),i.push(h)):this._inside(o,n)&&i.push(this._intersect(o,h,n))}}return i},e}(),p=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],_=a.create(),f=o.create();return h});