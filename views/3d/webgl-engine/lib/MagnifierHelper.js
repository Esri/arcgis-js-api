/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/has","../../../../core/maybe","../../../../core/Logger","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/decorators/subclass","../../../../core/urlUtils","../../../../core/uuid","../../../../portal/support/resourceExtension","../../../../core/promiseUtils","../../../../core/Accessor","../../../../core/Evented","../../../../core/mathUtils","../../../../core/screenUtils","../../../../core/Handles","../../../../support/requestImageUtils","../../../webgl/Program","../../../webgl/renderState","../../../webgl/Texture","./DefaultVertexBufferLayouts","./glUtil3D","../../../webgl/FramebufferObject","../../../webgl/RenderingContext","../shaders/Magnifier.glsl","../../../magnifier/resources"],(function(e,s,i,t,r,o,a,n,u,c,l,m,d,p,g,h,f,_,y,k,S,v,b,T,x,M,L,w){"use strict";e.MagnifierHelper=function(e){function i(){var s;return(s=e.apply(this,arguments)||this)._handles=new _,s._magnifier=null,s._imageSources=null,s._imageLoadTask=null,s._resources=null,s.events=new g,s.tmpScreenPoint=f.createScreenPointArray(),s.tmpRenderPoint=f.createRenderScreenPointArray(),s}s._inheritsLoose(i,e);var t=i.prototype;return t.dispose=function(){this._magnifier=null,this._handles.destroy(),r.isSome(this._imageLoadTask)&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this.disposeResources()},t.render=function(e,s){const i=this._validMagnifier;if(r.isNone(i))return;const t=s.camera.pixelRatio,o=Math.ceil(t*i.size);if(this.updateResources(e,o),r.isNone(this._resources))return;const a=this._resources.textures,n=Math.ceil(1/this.factor*o);a.input.resize(n,n);const u=s.camera.fullWidth,c=s.camera.fullHeight;f.screenPointObjectToArray(i.position,this.tmpScreenPoint);const l=s.camera.screenToRender(this.tmpScreenPoint,this.tmpRenderPoint),m=.5*n,d=.5*n;l[0]=h.clamp(l[0],m,u-m-1),l[1]=h.clamp(l[1],d,c-d-1);const p=Math.floor(l[0]-m),g=Math.floor(l[1]-d);e.bindTexture(a.input,0),e.gl.copyTexImage2D(a.input.descriptor.target,0,a.input.descriptor.pixelFormat,p,g,n,n,0);const _=i.offsetX*t,y=i.offsetY*t,k=(l[0]+_)/u*2-1,S=(l[1]-y)/c*2-1,v=o/u*2,b=o/c*2;e.bindVAO(this._resources.vao),e.bindTexture(a.overlay,1),e.bindTexture(a.mask,2);const T=this._resources.program;e.bindProgram(T),T.setUniform1i("textureInput",0),T.setUniform1i("textureOverlay",1),T.setUniform1i("textureMask",2),T.setUniform4f("drawPosition",k,S,v,b),T.setUniform1i("maskEnabled",i.maskEnabled?1:0),T.setUniform1i("overlayEnabled",i.overlayEnabled?1:0),e.setPipelineState(this._resources.pipelineState),e.drawArrays(5,0,4)},t.updateResourceLoading=function(){const e=this._validMagnifier;if(r.isNone(e))return;const s=e.mask,i=e.overlay;!r.isSome(this._imageLoadTask)||this._imageLoadTask.mask===s&&this._imageLoadTask.overlay===i||(this._imageLoadTask.task.abort(),this._imageLoadTask=null,this._imageSources=null),r.isSome(this._imageSources)||r.isSome(this._imageLoadTask)||(this._imageLoadTask={mask:s,overlay:i,task:d.createTask((async e=>{const t=r.isNone(s)||r.isNone(i)?w.loadMagnifierResources(e):null,o=r.isSome(s)?y.requestImage(s,{signal:e}):t.then((e=>e.mask)),a=r.isSome(i)?y.requestImage(i,{signal:e}):t.then((e=>e.overlay));this._imageSources={mask:await o,overlay:await a},this.disposeResources(),this.events.emit("request-render")}))},this._imageLoadTask.task.promise.then((()=>this.notifyChange("updating")),(()=>this.notifyChange("updating"))))},t.updateResources=function(e,s){if(!this.enabled)return void this.disposeResources();if(r.isSome(this._resources)){if(this._resources.textures.size!==s){const i=this.createTextureResources(e,s);if(r.isNone(i))return void this.disposeResources();this.disposeTextureResources(this._resources.textures),this._resources.textures=i}return}const i=this.createTextureResources(e,s);r.isNone(i)||(this._resources={textures:i,program:this.createProgram(e),vao:this.createVAO(e),pipelineState:S.makePipelineState({blending:S.simpleBlendingParams(1,771),depthTest:null,depthWrite:null,colorWrite:S.defaultColorWriteParams})})},t.disposeResources=function(){r.isNone(this._resources)||(this.disposeTextureResources(this._resources.textures),this._resources.program.dispose(),this._resources.vao.dispose(),this._resources=null)},t.disposeTextureResources=function(e){e.mask.dispose(),e.overlay.dispose(),e.input.dispose()},t.createTextureResources=function(e,s){if(r.isNone(this._imageSources))return null;this._imageSources.overlay.width=s,this._imageSources.overlay.height=s,this._imageSources.mask.width=s,this._imageSources.mask.height=s;const i=new v(e,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0},this._imageSources.overlay),t=new v(e,{target:3553,pixelFormat:6406,internalFormat:6406,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0},this._imageSources.mask);return{input:new v(e,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1}),mask:t,overlay:i,size:s}},t.createProgram=function(e){const s=L.build();return new k(e,s.generateSource("vertex"),s.generateSource("fragment"),this.attributeLocations)},t.createVAO=function(e){return T.createQuadVAO(e,b.Pos2,this.attributeLocations,0,1)},s._createClass(i,[{key:"updating",get:function(){return r.isNone(this._imageSources)&&r.isSome(this._imageLoadTask)&&!this._imageLoadTask.task.finished}},{key:"magnifier",get:function(){return this._magnifier},set:function(e){if(e===this._magnifier)return;this._handles.removeAll(),this._magnifier=e;const s=()=>{this.updateResourceLoading(),this.events.emit("request-render")};r.isSome(this._magnifier)&&this._handles.add(this._magnifier.watch("version",s)),s()}},{key:"enabled",get:function(){return r.isSome(this._validMagnifier)}},{key:"_validMagnifier",get:function(){return r.isSome(this._magnifier)&&this._magnifier.visible&&r.isSome(this._magnifier.position)&&this._magnifier.size>0?this._magnifier:null}},{key:"factor",get:function(){return r.isSome(this._magnifier)&&this._magnifier.factor||1}},{key:"attributeLocations",get:function(){return{position:0}}}]),i}(p),i.__decorate([n.property()],e.MagnifierHelper.prototype,"_imageSources",void 0),i.__decorate([n.property()],e.MagnifierHelper.prototype,"_imageLoadTask",void 0),i.__decorate([n.property({readOnly:!0,dependsOn:["_imageSources","_imageLoadTask"]})],e.MagnifierHelper.prototype,"updating",null),e.MagnifierHelper=i.__decorate([u.subclass("esri/views/3d/webgl-engine/lib/MagnifierHelper")],e.MagnifierHelper),Object.defineProperty(e,"__esModule",{value:!0})}));
