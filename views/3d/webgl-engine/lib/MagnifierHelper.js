/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Evented","../../../../core/Handles","../../../../core/mathUtils","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/screenUtils","../../../../core/urlUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/accessorSupport/ensureType","../../../../core/Logger","../../../../core/accessorSupport/decorators/subclass","../../../../support/requestImageUtils","../../../webgl/BufferObject","../../../webgl/FramebufferObject","../../../webgl/enums","../../../webgl/RenderingContext","../../../../chunks/builtins","../../../webgl/Texture","../../../webgl/VertexArrayObject","./DefaultVertexBufferLayouts","./glUtil3D","./Program","./WebGLDriverTest","../shaders/Magnifier.glsl","../../../magnifier/resources","../../../webgl/renderState"],(function(e,s,i,r,t,o,a,n,u,c,l,p,m,d,h,g,f,_,y,k,v,b,S,T,x,M,w,L,P,R,U){"use strict";e.MagnifierHelper=function(e){function i(){var s;return(s=e.apply(this,arguments)||this)._handles=new o,s._magnifier=null,s._imageSources=null,s._imageLoadTask=null,s._resources=null,s.events=new t,s.attributeLocations=new Map([["position",0]]),s.tmpScreenPoint=c.createScreenPointArray(),s.tmpRenderPoint=c.createRenderScreenPointArray(),s}s._inheritsLoose(i,e);var r=i.prototype;return r.dispose=function(){this._magnifier=null,this._handles.destroy(),n.isSome(this._imageLoadTask)&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this.disposeResources()},r.render=function(e,s){const i=this._validMagnifier;if(n.isNone(i))return;const r=s.camera.pixelRatio,t=Math.ceil(r*i.size);if(this.updateResources(e,t),n.isNone(this._resources))return;const o=this._resources.program;e.useProgram(o);const u=this._resources.textures,l=Math.ceil(1/this.factor*t);u.input.resize(l,l);const p=s.camera.fullWidth,m=s.camera.fullHeight;c.screenPointObjectToArray(i.position,this.tmpScreenPoint);const d=s.camera.screenToRender(this.tmpScreenPoint,this.tmpRenderPoint),h=.5*l,g=.5*l;d[0]=a.clamp(d[0],h,p-h-1),d[1]=a.clamp(d[1],g,m-g-1);const f=Math.floor(d[0]-h),_=Math.floor(d[1]-g);o.bindTexture(u.input,"textureInput"),e.gl.copyTexImage2D(u.input.descriptor.target,0,u.input.descriptor.pixelFormat,f,_,l,l,0);const y=i.offset.x*r,k=i.offset.y*r,v=(d[0]+y)/p*2-1,b=(d[1]-k)/m*2-1,S=t/p*2,T=t/m*2;e.bindVAO(this._resources.vao),o.bindTexture(u.overlay,"textureOverlay"),o.bindTexture(u.mask,"textureMask"),o.setUniform4f("drawPosition",v,b,S,T),o.setUniform1i("maskEnabled",i.maskEnabled?1:0),o.setUniform1i("overlayEnabled",i.overlayEnabled?1:0),e.setPipelineState(this._resources.pipelineState),e.drawArrays(5,0,4)},r.updateResourceLoading=function(){var e=this;const i=this._validMagnifier;if(n.isNone(i))return;const r=i.maskUrl,t=i.overlayUrl;!n.isSome(this._imageLoadTask)||this._imageLoadTask.maskUrl===r&&this._imageLoadTask.overlayUrl===t||(this._imageLoadTask.task.abort(),this._imageLoadTask=null,this._imageSources=null),n.isSome(this._imageSources)||n.isSome(this._imageLoadTask)||(this._imageLoadTask={maskUrl:r,overlayUrl:t,task:u.createTask(function(){var i=s._asyncToGenerator((function*(s){const i=n.isNone(r)||n.isNone(t)?R.loadMagnifierResources(s):null,o=n.isSome(r)?f.requestImage(r,{signal:s}):i.then((e=>e.mask)),a=n.isSome(t)?f.requestImage(t,{signal:s}):i.then((e=>e.overlay));e._imageSources={mask:yield o,overlay:yield a},e.disposeResources(),e.events.emit("request-render")}));return function(e){return i.apply(this,arguments)}}())},this._imageLoadTask.task.promise.then((()=>this.notifyChange("updating")),(()=>this.notifyChange("updating"))))},r.updateResources=function(e,s){if(!this.enabled)return void this.disposeResources();if(n.isSome(this._resources)){if(this._resources.textures.size!==s){const i=this.createTextureResources(e,s);if(n.isNone(i))return void this.disposeResources();this.disposeTextureResources(this._resources.textures),this._resources.textures=i}return}const i=this.createTextureResources(e,s);n.isNone(i)||(this._resources={textures:i,program:this.createProgram(e),vao:M.createQuadVAO(e,x.Pos2,this.attributeLocations,0,1),pipelineState:U.makePipelineState({blending:U.simpleBlendingParams(1,771),depthTest:null,depthWrite:null,colorWrite:U.defaultColorWriteParams})})},r.disposeResources=function(){n.isNone(this._resources)||(this.disposeTextureResources(this._resources.textures),this._resources.program.dispose(),this._resources.vao.dispose(),this._resources=null)},r.disposeTextureResources=function(e){e.mask.dispose(),e.overlay.dispose(),e.input.dispose()},r.createTextureResources=function(e,s){if(n.isNone(this._imageSources))return null;this._imageSources.overlay.width=s,this._imageSources.overlay.height=s,this._imageSources.mask.width=s,this._imageSources.mask.height=s;const i=new S(e,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0,preMultiplyAlpha:!l.isSVG(this._imageSources.overlay.src)||!L.testWebGLDriver(e).svgAlwaysPremultipliesAlpha},this._imageSources.overlay),r=new S(e,{target:3553,pixelFormat:6406,internalFormat:6406,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0},this._imageSources.mask);return{input:new S(e,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1}),mask:r,overlay:i,size:s}},r.createProgram=function(e){const s=P.build();return new w.Program(e,s,this.attributeLocations)},s._createClass(i,[{key:"updating",get:function(){return n.isNone(this._imageSources)&&n.isSome(this._imageLoadTask)&&!this._imageLoadTask.task.finished}},{key:"magnifier",get:function(){return this._magnifier},set:function(e){if(e===this._magnifier)return;this._handles.removeAll(),this._magnifier=e;const s=()=>{this.updateResourceLoading(),this.events.emit("request-render")};n.isSome(this._magnifier)&&this._handles.add(this._magnifier.watch("version",s)),s()}},{key:"enabled",get:function(){return n.isSome(this._validMagnifier)}},{key:"_validMagnifier",get:function(){return n.isSome(this._magnifier)&&this._magnifier.visible&&n.isSome(this._magnifier.position)&&this._magnifier.size>0?this._magnifier:null}},{key:"factor",get:function(){return n.isSome(this._magnifier)&&this._magnifier.factor||1}}]),i}(r),i.__decorate([p.property()],e.MagnifierHelper.prototype,"_imageSources",void 0),i.__decorate([p.property()],e.MagnifierHelper.prototype,"_imageLoadTask",void 0),i.__decorate([p.property({readOnly:!0})],e.MagnifierHelper.prototype,"updating",null),e.MagnifierHelper=i.__decorate([g.subclass("esri/views/3d/webgl-engine/lib/MagnifierHelper")],e.MagnifierHelper),Object.defineProperty(e,"__esModule",{value:!0})}));
