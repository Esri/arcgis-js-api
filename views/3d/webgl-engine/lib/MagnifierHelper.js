/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/has","../../../../core/maybe","../../../../core/Logger","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/decorators/subclass","../../../../core/urlUtils","../../../../core/uuid","../../../../portal/support/resourceExtension","../../../../core/promiseUtils","../../../../core/Accessor","../../../../core/Evented","../../../../core/mathUtils","../../../../core/screenUtils","../../../../core/Handles","../../../../support/requestImageUtils","../../../webgl/Program","../../../webgl/renderState","../../../webgl/checkWebGLError","../../../webgl/Texture","./DefaultVertexBufferLayouts","./glUtil3D","../../../webgl/FramebufferObject","./WebGLDriverTest","../shaders/Magnifier.glsl","../../../magnifier/resources"],(function(e,s,i,r,t,o,a,n,u,c,l,m,p,h,d,g,f,_,y,k,S,v,b,T,x,L,M,w,P){"use strict";e.MagnifierHelper=function(e){function i(){var s;return(s=e.apply(this,arguments)||this)._handles=new _,s._magnifier=null,s._imageSources=null,s._imageLoadTask=null,s._resources=null,s.events=new d,s.tmpScreenPoint=f.createScreenPointArray(),s.tmpRenderPoint=f.createRenderScreenPointArray(),s}s._inheritsLoose(i,e);var r=i.prototype;return r.dispose=function(){this._magnifier=null,this._handles.destroy(),t.isSome(this._imageLoadTask)&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this.disposeResources()},r.render=function(e,s){const i=this._validMagnifier;if(t.isNone(i))return;const r=s.camera.pixelRatio,o=Math.ceil(r*i.size);if(this.updateResources(e,o),t.isNone(this._resources))return;const a=this._resources.textures,n=Math.ceil(1/this.factor*o);a.input.resize(n,n);const u=s.camera.fullWidth,c=s.camera.fullHeight;f.screenPointObjectToArray(i.position,this.tmpScreenPoint);const l=s.camera.screenToRender(this.tmpScreenPoint,this.tmpRenderPoint),m=.5*n,p=.5*n;l[0]=g.clamp(l[0],m,u-m-1),l[1]=g.clamp(l[1],p,c-p-1);const h=Math.floor(l[0]-m),d=Math.floor(l[1]-p);e.bindTexture(a.input,0),e.gl.copyTexImage2D(a.input.descriptor.target,0,a.input.descriptor.pixelFormat,h,d,n,n,0);const _=i.offset.x*r,y=i.offset.y*r,k=(l[0]+_)/u*2-1,S=(l[1]-y)/c*2-1,v=o/u*2,b=o/c*2;e.bindVAO(this._resources.vao),e.bindTexture(a.overlay,1),e.bindTexture(a.mask,2);const T=this._resources.program;e.bindProgram(T),T.setUniform1i("textureInput",0),T.setUniform1i("textureOverlay",1),T.setUniform1i("textureMask",2),T.setUniform4f("drawPosition",k,S,v,b),T.setUniform1i("maskEnabled",i.maskEnabled?1:0),T.setUniform1i("overlayEnabled",i.overlayEnabled?1:0),e.setPipelineState(this._resources.pipelineState),e.drawArrays(5,0,4)},r.updateResourceLoading=function(){const e=this._validMagnifier;if(t.isNone(e))return;const s=e.maskUrl,i=e.overlayUrl;!t.isSome(this._imageLoadTask)||this._imageLoadTask.maskUrl===s&&this._imageLoadTask.overlayUrl===i||(this._imageLoadTask.task.abort(),this._imageLoadTask=null,this._imageSources=null),t.isSome(this._imageSources)||t.isSome(this._imageLoadTask)||(this._imageLoadTask={maskUrl:s,overlayUrl:i,task:p.createTask((async e=>{const r=t.isNone(s)||t.isNone(i)?P.loadMagnifierResources(e):null,o=t.isSome(s)?y.requestImage(s,{signal:e}):r.then((e=>e.mask)),a=t.isSome(i)?y.requestImage(i,{signal:e}):r.then((e=>e.overlay));this._imageSources={mask:await o,overlay:await a},this.disposeResources(),this.events.emit("request-render")}))},this._imageLoadTask.task.promise.then((()=>this.notifyChange("updating")),(()=>this.notifyChange("updating"))))},r.updateResources=function(e,s){if(!this.enabled)return void this.disposeResources();if(t.isSome(this._resources)){if(this._resources.textures.size!==s){const i=this.createTextureResources(e,s);if(t.isNone(i))return void this.disposeResources();this.disposeTextureResources(this._resources.textures),this._resources.textures=i}return}const i=this.createTextureResources(e,s);t.isNone(i)||(this._resources={textures:i,program:this.createProgram(e),vao:this.createVAO(e),pipelineState:S.makePipelineState({blending:S.simpleBlendingParams(1,771),depthTest:null,depthWrite:null,colorWrite:S.defaultColorWriteParams})})},r.disposeResources=function(){t.isNone(this._resources)||(this.disposeTextureResources(this._resources.textures),this._resources.program.dispose(),this._resources.vao.dispose(),this._resources=null)},r.disposeTextureResources=function(e){e.mask.dispose(),e.overlay.dispose(),e.input.dispose()},r.createTextureResources=function(e,s){if(t.isNone(this._imageSources))return null;this._imageSources.overlay.width=s,this._imageSources.overlay.height=s,this._imageSources.mask.width=s,this._imageSources.mask.height=s;const i=new b(e,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0,preMultiplyAlpha:!c.isSVG(this._imageSources.overlay.src)||!M.testWebGLDriver(e).svgAlwaysPremultipliesAlpha},this._imageSources.overlay),r=new b(e,{target:3553,pixelFormat:6406,internalFormat:6406,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0},this._imageSources.mask);return{input:new b(e,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1}),mask:r,overlay:i,size:s}},r.createProgram=function(e){const s=w.build();return new k(e,s.generateSource("vertex"),s.generateSource("fragment"),this.attributeLocations)},r.createVAO=function(e){return x.createQuadVAO(e,T.Pos2,this.attributeLocations,0,1)},s._createClass(i,[{key:"updating",get:function(){return t.isNone(this._imageSources)&&t.isSome(this._imageLoadTask)&&!this._imageLoadTask.task.finished}},{key:"magnifier",get:function(){return this._magnifier},set:function(e){if(e===this._magnifier)return;this._handles.removeAll(),this._magnifier=e;const s=()=>{this.updateResourceLoading(),this.events.emit("request-render")};t.isSome(this._magnifier)&&this._handles.add(this._magnifier.watch("version",s)),s()}},{key:"enabled",get:function(){return t.isSome(this._validMagnifier)}},{key:"_validMagnifier",get:function(){return t.isSome(this._magnifier)&&this._magnifier.visible&&t.isSome(this._magnifier.position)&&this._magnifier.size>0?this._magnifier:null}},{key:"factor",get:function(){return t.isSome(this._magnifier)&&this._magnifier.factor||1}},{key:"attributeLocations",get:function(){return{position:0}}}]),i}(h),i.__decorate([n.property()],e.MagnifierHelper.prototype,"_imageSources",void 0),i.__decorate([n.property()],e.MagnifierHelper.prototype,"_imageLoadTask",void 0),i.__decorate([n.property({readOnly:!0})],e.MagnifierHelper.prototype,"updating",null),e.MagnifierHelper=i.__decorate([u.subclass("esri/views/3d/webgl-engine/lib/MagnifierHelper")],e.MagnifierHelper),Object.defineProperty(e,"__esModule",{value:!0})}));
