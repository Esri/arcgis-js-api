/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Evented","../../../../core/Handles","../../../../core/mathUtils","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/screenUtils","../../../../core/urlUtils","../../../../core/accessorSupport/decorators/property","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","../../../../support/requestImageUtils","./DefaultVertexBufferLayouts","./glUtil3D","./Program","./VertexAttribute","../shaders/Magnifier.glsl","../../../magnifier/resources","../../../webgl/enums","../../../webgl/renderState","../../../webgl/Texture"],(function(e,r,t,i,s,a,o,n,u,l,c,p,m,d,h,_,g,f,T,y,S,x,k,v,P,M){"use strict";e.MagnifierHelper=function(e){function t(){var r;return(r=e.apply(this,arguments)||this)._handles=new a,r._magnifier=null,r._imageSources=null,r._imageLoadTask=null,r._resources=null,r.events=new s,r.attributeLocations=new Map([[S.VertexAttribute.POSITION,0]]),r.tmpScreenPoint=l.createScreenPointArray(),r.tmpRenderPoint=l.createRenderScreenPointArray(),r}r._inheritsLoose(t,e);var i=t.prototype;return i.dispose=function(){this._magnifier=null,this._handles.destroy(),n.isSome(this._imageLoadTask)&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this._disposeResources()},i.render=function(e,r){const t=this._validMagnifier;if(n.isNone(t))return;const i=r.camera.pixelRatio,s=Math.ceil(i*t.size);if(this._updateResources(e,s),n.isNone(this._resources))return;const a=this._resources.program;e.useProgram(a);const u=this._resources.textures,c=Math.ceil(1/this.factor*s);u.input.resize(c,c);const p=r.camera.fullWidth,m=r.camera.fullHeight;l.screenPointObjectToArray(t.position,this.tmpScreenPoint);const d=r.camera.screenToRender(this.tmpScreenPoint,this.tmpRenderPoint),h=.5*c,_=.5*c;d[0]=o.clamp(d[0],h,p-h-1),d[1]=o.clamp(d[1],_,m-_-1);const g=Math.floor(d[0]-h),f=Math.floor(d[1]-_);a.bindTexture(u.input,"textureInput"),e.gl.copyTexImage2D(u.input.descriptor.target,0,u.input.descriptor.pixelFormat,g,f,c,c,0);const T=t.offset.x*i,y=t.offset.y*i,S=(d[0]+T)/p*2-1,x=(d[1]-y)/m*2-1,k=s/p*2,P=s/m*2;e.bindVAO(this._resources.vao),a.bindTexture(u.overlay,"textureOverlay"),a.bindTexture(u.mask,"textureMask"),a.setUniform4f("drawPosition",S,x,k,P),a.setUniform1b("maskEnabled",t.maskEnabled),a.setUniform1b("overlayEnabled",t.overlayEnabled),e.setPipelineState(this._resources.pipelineState),e.drawArrays(v.PrimitiveType.TRIANGLE_STRIP,0,4)},i._updateResourceLoading=function(){var e=this;const t=this._validMagnifier;if(n.isNone(t))return;const i=t.maskUrl,s=t.overlayUrl;!n.isSome(this._imageLoadTask)||this._imageLoadTask.maskUrl===i&&this._imageLoadTask.overlayUrl===s||(this._imageLoadTask.task.abort(),this._imageLoadTask=null,this._imageSources=null),n.isSome(this._imageSources)||n.isSome(this._imageLoadTask)||(this._imageLoadTask={maskUrl:i,overlayUrl:s,task:u.createTask(function(){var t=r._asyncToGenerator((function*(r){const t=n.isNone(i)||n.isNone(s)?k.loadMagnifierResources(r):null,a=n.isSome(i)?g.requestImage(i,{signal:r}):t.then((e=>e.mask)),o=n.isSome(s)?g.requestImage(s,{signal:r}):t.then((e=>e.overlay));e._imageSources={mask:yield a,overlay:yield o},e._disposeResources(),e.events.emit("request-render")}));return function(e){return t.apply(this,arguments)}}())},this._imageLoadTask.task.promise.then((()=>this.notifyChange("updating")),(()=>this.notifyChange("updating"))))},i._updateResources=function(e,r){if(!this.enabled)return void this._disposeResources();if(n.isSome(this._resources)){if(this._resources.textures.size!==r){const t=this._createTextureResources(e,r);if(n.isNone(t))return void this._disposeResources();this._disposeTextureResources(this._resources.textures),this._resources.textures=t}return}const t=this._createTextureResources(e,r);n.isNone(t)||(this._resources={textures:t,program:this._createProgram(e),vao:T.createQuadVAO(e,f.Pos2,this.attributeLocations,0,1),pipelineState:P.makePipelineState({blending:P.simpleBlendingParams(v.BlendFactor.ONE,v.BlendFactor.ONE_MINUS_SRC_ALPHA),depthTest:null,depthWrite:null,colorWrite:P.defaultColorWriteParams})})},i._disposeResources=function(){n.isNone(this._resources)||(this._disposeTextureResources(this._resources.textures),this._resources.program.dispose(),this._resources.vao.dispose(),this._resources=null)},i._disposeTextureResources=function(e){e.mask.dispose(),e.overlay.dispose(),e.input.dispose()},i._createTextureResources=function(e,r){if(n.isNone(this._imageSources))return null;this._imageSources.overlay.width=r,this._imageSources.overlay.height=r,this._imageSources.mask.width=r,this._imageSources.mask.height=r;const t=new M.Texture(e,{target:v.TextureType.TEXTURE_2D,pixelFormat:v.PixelFormat.RGBA,internalFormat:v.PixelFormat.RGBA,dataType:v.PixelType.UNSIGNED_BYTE,wrapMode:v.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:v.TextureSamplingMode.LINEAR,flipped:!0,preMultiplyAlpha:!c.isSVG(this._imageSources.overlay.src)||!e.driverTest.svgAlwaysPremultipliesAlpha},this._imageSources.overlay),i=new M.Texture(e,{target:v.TextureType.TEXTURE_2D,pixelFormat:v.PixelFormat.ALPHA,internalFormat:v.PixelFormat.ALPHA,dataType:v.PixelType.UNSIGNED_BYTE,wrapMode:v.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:v.TextureSamplingMode.LINEAR,flipped:!0},this._imageSources.mask);return{input:new M.Texture(e,{target:v.TextureType.TEXTURE_2D,pixelFormat:v.PixelFormat.RGBA,internalFormat:v.PixelFormat.RGBA,dataType:v.PixelType.UNSIGNED_BYTE,wrapMode:v.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:v.TextureSamplingMode.LINEAR,flipped:!1}),mask:i,overlay:t,size:r}},i._createProgram=function(e){const r=x.build();return new y.Program(e,r,this.attributeLocations)},r._createClass(t,[{key:"updating",get:function(){return n.isNone(this._imageSources)&&n.isSome(this._imageLoadTask)&&!this._imageLoadTask.task.finished}},{key:"magnifier",get:function(){return this._magnifier},set:function(e){if(e===this._magnifier)return;this._handles.removeAll(),this._magnifier=e;const r=()=>{this._updateResourceLoading(),this.events.emit("request-render")};n.isSome(this._magnifier)&&this._handles.add(this._magnifier.watch("version",r)),r()}},{key:"enabled",get:function(){return n.isSome(this._validMagnifier)}},{key:"_validMagnifier",get:function(){return n.isSome(this._magnifier)&&this._magnifier.visible&&n.isSome(this._magnifier.position)&&this._magnifier.size>0?this._magnifier:null}},{key:"factor",get:function(){return n.isSome(this._magnifier)&&this._magnifier.factor||1}}]),t}(i),t.__decorate([p.property()],e.MagnifierHelper.prototype,"_imageSources",void 0),t.__decorate([p.property()],e.MagnifierHelper.prototype,"_imageLoadTask",void 0),t.__decorate([p.property({readOnly:!0})],e.MagnifierHelper.prototype,"updating",null),e.MagnifierHelper=t.__decorate([_.subclass("esri/views/3d/webgl-engine/lib/MagnifierHelper")],e.MagnifierHelper),Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
