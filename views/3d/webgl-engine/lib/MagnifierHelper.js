/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/asyncUtils","../../../../core/Evented","../../../../core/Handles","../../../../core/mathUtils","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/screenUtils","../../../../core/urlUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/accessorSupport/decorators/subclass","../../../../support/requestImageUtils","./DefaultVertexBufferLayouts","./glUtil3D","./Program","./VertexAttribute","../shaders/Magnifier.glsl","../../../magnifier/resources","../../../webgl/enums","../../../webgl/renderState","../../../webgl/Texture"],(function(e,r,t,i,s,a,o,n,u,l,c,p,m,_,d,h,g,f,T,y,S,P,x,k,v,M){"use strict";e.MagnifierHelper=function(e){function t(){var r;return(r=e.apply(this,arguments)||this)._handles=new o,r._magnifier=null,r._imageSources=null,r._imageLoadTask=null,r._resources=null,r._passParameters=new P.MagnifierPassParameters,r.events=new a,r.attributeLocations=new Map([[S.VertexAttribute.POSITION,0]]),r._tmpScreenPoint=c.createScreenPointArray(),r._tmpRenderPoint=c.createRenderScreenPointArray(),r}r._inheritsLoose(t,e);var i=t.prototype;return i.destroy=function(){this._magnifier=null,this._handles.destroy(),u.isSome(this._imageLoadTask)&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this._disposeResources()},i.render=function(e,r){const t=this._validMagnifier;if(u.isNone(t))return;const i=r.camera.pixelRatio,s=Math.ceil(i*t.size);if(this._updateResources(e,s),u.isNone(this._resources))return;const a=this._passParameters.textures,o=Math.ceil(1/this._factor*s);a.input.resize(o,o),c.screenPointObjectToArray(t.position,this._tmpScreenPoint);const l=r.camera.screenToRender(this._tmpScreenPoint,this._tmpRenderPoint),p=r.camera.fullWidth,m=r.camera.fullHeight,_=.5*o,d=.5*o;l[0]=n.clamp(l[0],_,p-_-1),l[1]=n.clamp(l[1],d,m-d-1);const h=Math.floor(l[0]-_),g=Math.floor(l[1]-d),f=this._resources.program;f.bindTexture("textureInput",a.input),e.gl.copyTexImage2D(a.input.descriptor.target,0,a.input.descriptor.pixelFormat,h,g,o,o,0),this._passParameters.magnifier=t,e.useProgram(f),f.bindPass(this._passParameters,r),e.bindVAO(this._resources.vao),e.setPipelineState(this._resources.pipelineState),e.drawArrays(k.PrimitiveType.TRIANGLE_STRIP,0,4)},i._updateResourceLoading=function(){var e=this;const t=this._validMagnifier;if(u.isNone(t))return;const i=t.maskUrl,a=t.overlayUrl;!u.isSome(this._imageLoadTask)||this._imageLoadTask.maskUrl===i&&this._imageLoadTask.overlayUrl===a||(this._imageLoadTask.task.abort(),this._imageLoadTask=null,this._imageSources=null),u.isSome(this._imageSources)||u.isSome(this._imageLoadTask)||(this._imageLoadTask={maskUrl:i,overlayUrl:a,task:s.createTask(function(){var t=r._asyncToGenerator((function*(r){const t=u.isNone(i)||u.isNone(a)?x.loadMagnifierResources(r):null,s=u.isSome(i)?g.requestImage(i,{signal:r}):t.then((e=>e.mask)),o=u.isSome(a)?g.requestImage(a,{signal:r}):t.then((e=>e.overlay));e._imageSources={mask:yield s,overlay:yield o},e._disposeResources(),e.events.emit("request-render")}));return function(e){return t.apply(this,arguments)}}())},this._imageLoadTask.task.promise.then((()=>this.notifyChange("updating")),(()=>this.notifyChange("updating"))))},i._updateResources=function(e,r){if(!this.enabled)return void this._disposeResources();if(u.isSome(this._resources)){if(this._passParameters.textures.size!==r){const t=this._createTextureResources(e,r);if(u.isNone(t))return void this._disposeResources();this._disposeTextureResources(this._passParameters.textures),this._passParameters.textures=t}return}const t=this._createTextureResources(e,r);u.isNone(t)||(this._resources={program:this._createProgram(e),vao:T.createQuadVAO(e,f.Pos2,this.attributeLocations,0,1),pipelineState:v.makePipelineState({blending:v.simpleBlendingParams(k.BlendFactor.ONE,k.BlendFactor.ONE_MINUS_SRC_ALPHA),depthTest:null,depthWrite:null,colorWrite:v.defaultColorWriteParams})},this._passParameters.textures=t)},i._disposeResources=function(){u.isNone(this._resources)||(this._disposeTextureResources(this._passParameters.textures),this._resources.program.dispose(),this._resources.vao.dispose(),this._resources=null)},i._disposeTextureResources=function(e){e.mask.dispose(),e.overlay.dispose(),e.input.dispose()},i._createTextureResources=function(e,r){if(u.isNone(this._imageSources))return null;this._imageSources.overlay.width=r,this._imageSources.overlay.height=r,this._imageSources.mask.width=r,this._imageSources.mask.height=r;const t=new M.Texture(e,{target:k.TextureType.TEXTURE_2D,pixelFormat:k.PixelFormat.RGBA,internalFormat:k.PixelFormat.RGBA,dataType:k.PixelType.UNSIGNED_BYTE,wrapMode:k.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:k.TextureSamplingMode.LINEAR,flipped:!0,preMultiplyAlpha:!p.isSVG(this._imageSources.overlay.src)||!e.driverTest.svgPremultipliesAlpha.result},this._imageSources.overlay),i=new M.Texture(e,{target:k.TextureType.TEXTURE_2D,pixelFormat:k.PixelFormat.ALPHA,internalFormat:k.PixelFormat.ALPHA,dataType:k.PixelType.UNSIGNED_BYTE,wrapMode:k.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:k.TextureSamplingMode.LINEAR,flipped:!0},this._imageSources.mask);return{input:new M.Texture(e,{target:k.TextureType.TEXTURE_2D,pixelFormat:k.PixelFormat.RGBA,internalFormat:k.PixelFormat.RGBA,dataType:k.PixelType.UNSIGNED_BYTE,wrapMode:k.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:k.TextureSamplingMode.LINEAR,flipped:!1}),mask:i,overlay:t,size:r}},i._createProgram=function(e){return new y.Program(e,P.build(),this.attributeLocations)},r._createClass(t,[{key:"updating",get:function(){return u.isNone(this._imageSources)&&u.isSome(this._imageLoadTask)&&!this._imageLoadTask.task.finished}},{key:"magnifier",get:function(){return this._magnifier},set:function(e){if(e===this._magnifier)return;this._handles.removeAll(),this._magnifier=e;const r=()=>{this._updateResourceLoading(),this.events.emit("request-render")};u.isSome(this._magnifier)&&this._handles.add(l.watch((()=>u.applySome(this._magnifier,(e=>e.version))),r)),r()}},{key:"enabled",get:function(){return u.isSome(this._validMagnifier)}},{key:"_validMagnifier",get:function(){return u.isSome(this._magnifier)&&this._magnifier.visible&&u.isSome(this._magnifier.position)&&this._magnifier.size>0?this._magnifier:null}},{key:"_factor",get:function(){return u.isSome(this._magnifier)&&this._magnifier.factor||1}}]),t}(i),t.__decorate([m.property()],e.MagnifierHelper.prototype,"_imageSources",void 0),t.__decorate([m.property()],e.MagnifierHelper.prototype,"_imageLoadTask",void 0),t.__decorate([m.property({readOnly:!0})],e.MagnifierHelper.prototype,"updating",null),e.MagnifierHelper=t.__decorate([h.subclass("esri/views/3d/webgl-engine/lib/MagnifierHelper")],e.MagnifierHelper),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
