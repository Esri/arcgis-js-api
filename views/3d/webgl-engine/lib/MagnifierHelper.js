/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/asyncUtils","../../../../core/Evented","../../../../core/Handles","../../../../core/mathUtils","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/screenUtils","../../../../core/urlUtils","../../../../core/accessorSupport/decorators/property","../../../../core/arrayUtils","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","../../../../support/requestImageUtils","./DefaultVertexBufferLayouts","./glUtil3D","./Program","./VertexAttribute","../shaders/Magnifier.glsl","../../../magnifier/resources","../../../webgl/enums","../../../webgl/renderState","../../../webgl/Texture"],(function(e,r,i,s,t,a,o,n,u,l,c,p,m,_,d,h,g,f,T,y,S,P,x,v,k,M){"use strict";e.MagnifierHelper=function(e){function i(){var r;return(r=e.apply(this,arguments)||this)._handles=new o,r._magnifier=null,r._imageSources=null,r._imageLoadTask=null,r._resources=null,r._passParameters=new P.MagnifierPassParameters,r.events=new a,r.attributeLocations=new Map([[S.VertexAttribute.POSITION,0]]),r._tmpScreenPoint=c.createScreenPointArray(),r._tmpRenderPoint=c.createRenderScreenPointArray(),r}r._inheritsLoose(i,e);var s=i.prototype;return s.dispose=function(){this._magnifier=null,this._handles.destroy(),u.isSome(this._imageLoadTask)&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this._disposeResources()},s.render=function(e,r){const i=this._validMagnifier;if(u.isNone(i))return;const s=r.camera.pixelRatio,t=Math.ceil(s*i.size);if(this._updateResources(e,t),u.isNone(this._resources))return;const a=this._passParameters.textures,o=Math.ceil(1/this._factor*t);a.input.resize(o,o),c.screenPointObjectToArray(i.position,this._tmpScreenPoint);const l=r.camera.screenToRender(this._tmpScreenPoint,this._tmpRenderPoint),p=r.camera.fullWidth,m=r.camera.fullHeight,_=.5*o,d=.5*o;l[0]=n.clamp(l[0],_,p-_-1),l[1]=n.clamp(l[1],d,m-d-1);const h=Math.floor(l[0]-_),g=Math.floor(l[1]-d),f=this._resources.program;f.bindTexture("textureInput",a.input),e.gl.copyTexImage2D(a.input.descriptor.target,0,a.input.descriptor.pixelFormat,h,g,o,o,0),this._passParameters.magnifier=i,e.useProgram(f),f.bindPass(this._passParameters,r),e.bindVAO(this._resources.vao),e.setPipelineState(this._resources.pipelineState),e.drawArrays(v.PrimitiveType.TRIANGLE_STRIP,0,4)},s._updateResourceLoading=function(){var e=this;const i=this._validMagnifier;if(u.isNone(i))return;const s=i.maskUrl,a=i.overlayUrl;!u.isSome(this._imageLoadTask)||this._imageLoadTask.maskUrl===s&&this._imageLoadTask.overlayUrl===a||(this._imageLoadTask.task.abort(),this._imageLoadTask=null,this._imageSources=null),u.isSome(this._imageSources)||u.isSome(this._imageLoadTask)||(this._imageLoadTask={maskUrl:s,overlayUrl:a,task:t.createTask(function(){var i=r._asyncToGenerator((function*(r){const i=u.isNone(s)||u.isNone(a)?x.loadMagnifierResources(r):null,t=u.isSome(s)?g.requestImage(s,{signal:r}):i.then((e=>e.mask)),o=u.isSome(a)?g.requestImage(a,{signal:r}):i.then((e=>e.overlay));e._imageSources={mask:yield t,overlay:yield o},e._disposeResources(),e.events.emit("request-render")}));return function(e){return i.apply(this,arguments)}}())},this._imageLoadTask.task.promise.then((()=>this.notifyChange("updating")),(()=>this.notifyChange("updating"))))},s._updateResources=function(e,r){if(!this.enabled)return void this._disposeResources();if(u.isSome(this._resources)){if(this._passParameters.textures.size!==r){const i=this._createTextureResources(e,r);if(u.isNone(i))return void this._disposeResources();this._disposeTextureResources(this._passParameters.textures),this._passParameters.textures=i}return}const i=this._createTextureResources(e,r);u.isNone(i)||(this._resources={program:this._createProgram(e),vao:T.createQuadVAO(e,f.Pos2,this.attributeLocations,0,1),pipelineState:k.makePipelineState({blending:k.simpleBlendingParams(v.BlendFactor.ONE,v.BlendFactor.ONE_MINUS_SRC_ALPHA),depthTest:null,depthWrite:null,colorWrite:k.defaultColorWriteParams})},this._passParameters.textures=i)},s._disposeResources=function(){u.isNone(this._resources)||(this._disposeTextureResources(this._passParameters.textures),this._resources.program.dispose(),this._resources.vao.dispose(),this._resources=null)},s._disposeTextureResources=function(e){e.mask.dispose(),e.overlay.dispose(),e.input.dispose()},s._createTextureResources=function(e,r){if(u.isNone(this._imageSources))return null;this._imageSources.overlay.width=r,this._imageSources.overlay.height=r,this._imageSources.mask.width=r,this._imageSources.mask.height=r;const i=new M.Texture(e,{target:v.TextureType.TEXTURE_2D,pixelFormat:v.PixelFormat.RGBA,internalFormat:v.PixelFormat.RGBA,dataType:v.PixelType.UNSIGNED_BYTE,wrapMode:v.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:v.TextureSamplingMode.LINEAR,flipped:!0,preMultiplyAlpha:!p.isSVG(this._imageSources.overlay.src)||!e.driverTest.svgAlwaysPremultipliesAlpha},this._imageSources.overlay),s=new M.Texture(e,{target:v.TextureType.TEXTURE_2D,pixelFormat:v.PixelFormat.ALPHA,internalFormat:v.PixelFormat.ALPHA,dataType:v.PixelType.UNSIGNED_BYTE,wrapMode:v.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:v.TextureSamplingMode.LINEAR,flipped:!0},this._imageSources.mask);return{input:new M.Texture(e,{target:v.TextureType.TEXTURE_2D,pixelFormat:v.PixelFormat.RGBA,internalFormat:v.PixelFormat.RGBA,dataType:v.PixelType.UNSIGNED_BYTE,wrapMode:v.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:v.TextureSamplingMode.LINEAR,flipped:!1}),mask:s,overlay:i,size:r}},s._createProgram=function(e){return new y.Program(e,P.build(),this.attributeLocations)},r._createClass(i,[{key:"updating",get:function(){return u.isNone(this._imageSources)&&u.isSome(this._imageLoadTask)&&!this._imageLoadTask.task.finished}},{key:"magnifier",get:function(){return this._magnifier},set:function(e){if(e===this._magnifier)return;this._handles.removeAll(),this._magnifier=e;const r=()=>{this._updateResourceLoading(),this.events.emit("request-render")};u.isSome(this._magnifier)&&this._handles.add(l.watch((()=>u.applySome(this._magnifier,(e=>e.version))),r)),r()}},{key:"enabled",get:function(){return u.isSome(this._validMagnifier)}},{key:"_validMagnifier",get:function(){return u.isSome(this._magnifier)&&this._magnifier.visible&&u.isSome(this._magnifier.position)&&this._magnifier.size>0?this._magnifier:null}},{key:"_factor",get:function(){return u.isSome(this._magnifier)&&this._magnifier.factor||1}}]),i}(s),i.__decorate([m.property()],e.MagnifierHelper.prototype,"_imageSources",void 0),i.__decorate([m.property()],e.MagnifierHelper.prototype,"_imageLoadTask",void 0),i.__decorate([m.property({readOnly:!0})],e.MagnifierHelper.prototype,"updating",null),e.MagnifierHelper=i.__decorate([h.subclass("esri/views/3d/webgl-engine/lib/MagnifierHelper")],e.MagnifierHelper),Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
