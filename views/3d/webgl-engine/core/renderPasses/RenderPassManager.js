/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/maybe","../../../../../chunks/vec3f64","../../../../../chunks/vec3","../../../../../chunks/mat4","../../../../../chunks/mat3f64","../../../../../chunks/mat3","../../../../../chunks/vec2","../../../../../chunks/vec4","../../../support/geometryUtils","../../lib/depthRange","../util/TwoVectorPosition","./AllRenderPasses","./RenderPass"],(function(s,a,e,t,i,r,h,n,o,l,P,m,c,p,d){"use strict";let u=function(){function s(s,a){this.rctx=s,this.shaderTechniqueRepository=a,this.canRender=!0,this._materialPassParams=new p.MaterialPassesParameters,this._shadowPassParams=new p.ShadowMapPassParameters,this._highlightPassParams=new p.HighlightPassParameters,this._systems=new Set,this._passes=new Array,this._shadowMapPass=this._registerPass(new d.RenderPass(s,this.shaderTechniqueRepository)),this.passes={materialOpaque:this._registerPass(new d.RenderPass(s,this.shaderTechniqueRepository)),materialTransparent:this._registerPass(new d.RenderPass(s,this.shaderTechniqueRepository,1)),materialIntegratedMesh:this._registerPass(new d.RenderPass(s,this.shaderTechniqueRepository)),shadowMap:this._shadowMapPass,highlight:this._registerPass(new d.RenderPass(s,this.shaderTechniqueRepository)),highlightIntegratedMesh:this._registerPass(new d.RenderPass(s,this.shaderTechniqueRepository))}}var t=s.prototype;return t.register=function(s){this._systems.add(s)},t.prepareRender=function(s){this._passes.forEach((s=>s.prepareSubmit())),this._systems.forEach((a=>{a.submit(this.passes,{camera:s})})),this._passes.forEach((s=>s.finishSubmit())),this.shaderTechniqueRepository.frameUpdate()},t.render=function(s){if(4===s.slot)switch(this._configure(s),s.pass){case 0:this._materialPassParams.subPass=0,this._configureMaterialColorPass(s),this.passes.materialOpaque.dispatch(this._materialPassParams);break;case 2:this._materialPassParams.subPass=2,this.passes.materialOpaque.dispatch(this._materialPassParams);break;case 3:this._materialPassParams.subPass=3,this.passes.materialOpaque.dispatch(this._materialPassParams);break;case 5:this.passes.highlight.dispatch(this._highlightPassParams);break;case 4:this._shadowMapPass.dispatch(this._shadowPassParams)}if(6===s.slot)switch(this._configure(s),s.pass){case 0:this._materialPassParams.subPass=0,this._configureMaterialColorPass(s),this.passes.materialTransparent.dispatch(this._materialPassParams);break;case 1:this._materialPassParams.subPass=1,this._configureMaterialColorPass(s),this.passes.materialTransparent.dispatch(this._materialPassParams);break;case 2:this._materialPassParams.subPass=2,this.passes.materialTransparent.dispatch(this._materialPassParams);break;case 3:this._materialPassParams.subPass=3,this.passes.materialTransparent.dispatch(this._materialPassParams)}if(1===s.slot)switch(this._configure(s),s.pass){case 0:this._materialPassParams.subPass=0,this._configureMaterialColorPass(s),this._materialPassParams.ssrParams=s.ssrParams,this.passes.materialIntegratedMesh.dispatch(this._materialPassParams);break;case 2:this._materialPassParams.subPass=2,this.passes.materialIntegratedMesh.dispatch(this._materialPassParams);break;case 3:this._materialPassParams.subPass=3,this.passes.materialIntegratedMesh.dispatch(this._materialPassParams);break;case 5:this.passes.highlightIntegratedMesh.dispatch(this._highlightPassParams)}return!0},t.notifyDirty=function(){this.initContext.requestRender()},t.slots=function(){return[4,6,1]},t.initializeRenderContext=function(s){this.initContext=s},t.uninitializeRenderContext=function(){},t.queryDepthRange=function(s){const a={near:1/0,far:-1/0};return this._systems.forEach((t=>{const i=t.queryShadowCasterDepthRange(s);e.isSome(i)&&m.union(a,i,a)})),a},t._configureMaterialColorPass=function(s){this._materialPassParams.shadowMap={bind:(a,e)=>{s.shadowMap.bind(a,e);const t=this._materialPassParams.viewTransform;i.add(_,t.worldFromView_TL,t.worldFromView_TH),s.shadowMap.bindView(a,_)}},this._materialPassParams.ambientOcclusion={bind:(a,e)=>{s.ssaoHelper.setUniforms(a,e)}},this._materialPassParams.ambientOcclusionEnabled=s.ssaoHelper.enabled,this._materialPassParams.sceneHasOcludees=s.hasOccludees},t._configure=function(s){const a=4===s.pass?this._shadowPassParams:5===s.pass?this._highlightPassParams:this._materialPassParams;this._updateParameters(s,a)},t._updateParameters=function(s,a){const e=s.camera,t=e.viewInverseTransposeMatrix;i.set(_,t[3],t[7],t[11]),w.set(_),i.copy(a.viewTransform.worldFromView_TH,w.high),i.copy(a.viewTransform.worldFromView_TL,w.low),n.fromMat4(a.viewTransform.viewFromCameraRelative_RS,e.viewMatrix),r.copy(a.viewTransform.projFromView,e.projectionMatrix),0===a.identifier?(this._materialPassParams.transparent=6===s.slot,this._materialPassParams.integratedMesh=1===s.slot,this._materialPassParams.lighting=s.scenelightingData,n.transpose(g,a.viewTransform.viewFromCameraRelative_RS),n.invert(a.transformNormal_ViewFromGlobal,g),o.set(a.cameraNearFar,e.near,e.far)):1===a.identifier?o.set(a.cameraNearFar,e.near,e.far):2===a.identifier&&(a.highlightDepthTexture=s.highlightDepthTexture,l.copy(a.viewport,e.fullViewport),a.inverseViewport[0]=1/e.fullViewport[2],a.inverseViewport[1]=1/e.fullViewport[3]),P.boundedPlane.copy(s.sliceHelper.plane,a.slicePlane),i.subtract(a.slicePlane.origin,a.slicePlane.origin,_),a.slicePlaneEnabled=s.sliceHelper.isEnabled,this._materialPassParams.transparencyPassType=s.transparencyPassType},t._registerPass=function(s){return this._passes.push(s),s},a._createClass(s,[{key:"shadowCastingEnabled",get:function(){return e.isSome(this.passes.shadowMap)},set:function(s){s?(this._materialPassParams.shadowsEnabled=!0,this.passes.shadowMap=this._shadowMapPass):(this._materialPassParams.shadowsEnabled=!1,this.passes.shadowMap=null)}},{key:"screenSpaceReflectionsEnabled",get:function(){return e.isSome(this._materialPassParams.ssrParams.ssrEnabled)},set:function(s){this._materialPassParams.ssrParams.ssrEnabled=!!s}},{key:"needsHighlight",get:function(){return this.passes.highlight.count>0||this.passes.highlightIntegratedMesh.count>0}}]),s}();const _=t.create(),g=h.create(),w=new c.TwoVectorPosition;s.RenderPassManager=u,Object.defineProperty(s,"__esModule",{value:!0})}));
