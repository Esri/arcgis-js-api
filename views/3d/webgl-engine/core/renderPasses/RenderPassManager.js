// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","../../../../../core/maybe","../../../../../core/libs/gl-matrix-2/mat3","../../../../../core/libs/gl-matrix-2/mat3f64","../../../../../core/libs/gl-matrix-2/mat4","../../../../../core/libs/gl-matrix-2/vec2","../../../../../core/libs/gl-matrix-2/vec3","../../../../../core/libs/gl-matrix-2/vec3f64","../../../../../core/libs/gl-matrix-2/vec4","../../../support/geometryUtils","./AllRenderPasses","./RenderPass","../util/TwoVectorPosition","../../lib/depthRange"],(function(s,a,e,t,r,i,n,h,o,l,m,p,c,P,d){"use strict";Object.defineProperty(a,"__esModule",{value:!0}),a.RenderPassManager=void 0;var u=function(){function s(s,a){this.rctx=s,this.shaderTechniqueRepository=a,this.canRender=!0,this._materialPassParams=new p.MaterialPassesParameters,this._shadowPassParams=new p.ShadowMapPassParameters,this._highlightPassParams=new p.HighlightPassParameters,this._systems=new Set,this._passes=new Array,this._shadowMapPass=this._registerPass(new c.RenderPass(s,this.shaderTechniqueRepository)),this.passes={materialOpaque:this._registerPass(new c.RenderPass(s,this.shaderTechniqueRepository)),materialTransparent:this._registerPass(new c.RenderPass(s,this.shaderTechniqueRepository,1)),materialIntegratedMesh:this._registerPass(new c.RenderPass(s,this.shaderTechniqueRepository)),shadowMap:this._shadowMapPass,highlight:this._registerPass(new c.RenderPass(s,this.shaderTechniqueRepository)),highlightIntegratedMesh:this._registerPass(new c.RenderPass(s,this.shaderTechniqueRepository))}}return s.prototype.register=function(s){this._systems.add(s)},s.prototype.prepareRender=function(s){var a=this;this._passes.forEach((function(s){return s.prepareSubmit()})),this._systems.forEach((function(e){e.submit(a.passes,{camera:s})})),this._passes.forEach((function(s){return s.finishSubmit()})),this.shaderTechniqueRepository.frameUpdate()},s.prototype.render=function(s){if(4===s.slot)switch(this._configure(s),s.pass){case 0:this._materialPassParams.subPass=0,this._configureMaterialColorPass(s),this.passes.materialOpaque.dispatch(this._materialPassParams);break;case 1:this._materialPassParams.subPass=1,this.passes.materialOpaque.dispatch(this._materialPassParams);break;case 2:this._materialPassParams.subPass=2,this.passes.materialOpaque.dispatch(this._materialPassParams);break;case 4:this.passes.highlight.dispatch(this._highlightPassParams);break;case 3:this._shadowMapPass.dispatch(this._shadowPassParams)}if(6===s.slot)switch(this._configure(s),s.pass){case 0:this._materialPassParams.subPass=0,this._configureMaterialColorPass(s),this.passes.materialTransparent.dispatch(this._materialPassParams);break;case 1:this._materialPassParams.subPass=1,this.passes.materialTransparent.dispatch(this._materialPassParams);break;case 2:this._materialPassParams.subPass=2,this.passes.materialTransparent.dispatch(this._materialPassParams)}if(1===s.slot)switch(this._configure(s),s.pass){case 0:this._materialPassParams.subPass=0,this._configureMaterialColorPass(s),this._materialPassParams.ssrParams=s.ssrParams,this.passes.materialIntegratedMesh.dispatch(this._materialPassParams);break;case 1:this._materialPassParams.subPass=1,this.passes.materialIntegratedMesh.dispatch(this._materialPassParams);break;case 2:this._materialPassParams.subPass=2,this.passes.materialIntegratedMesh.dispatch(this._materialPassParams);break;case 4:this.passes.highlightIntegratedMesh.dispatch(this._highlightPassParams)}return!0},s.prototype.notifyDirty=function(){this.initContext.requestRender()},s.prototype.slots=function(){return[4,6,1]},s.prototype.initializeRenderContext=function(s){this.initContext=s},s.prototype.uninitializeRenderContext=function(){},s.prototype.queryDepthRange=function(s){var a={near:1/0,far:-1/0};return this._systems.forEach((function(t){var r=t.queryShadowCasterDepthRange(s);e.isSome(r)&&d.union(a,r,a)})),a},Object.defineProperty(s.prototype,"shadowCastingEnabled",{get:function(){return e.isSome(this.passes.shadowMap)},set:function(s){s?(this._materialPassParams.shadowsEnabled=!0,this.passes.shadowMap=this._shadowMapPass):(this._materialPassParams.shadowsEnabled=!1,this.passes.shadowMap=null)},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"screenSpaceReflectionsEnabled",{get:function(){return e.isSome(this._materialPassParams.ssrParams.ssrEnabled)},set:function(s){this._materialPassParams.ssrParams.ssrEnabled=!!s},enumerable:!1,configurable:!0}),s.prototype._configureMaterialColorPass=function(s){var a=this;this._materialPassParams.shadowMap={bind:function(e,t){s.shadowMap.bind(e,t);var r=a._materialPassParams.viewTransform;h.vec3.add(g,r.worldFromView_TL,r.worldFromView_TH),s.shadowMap.bindView(e,g)}},this._materialPassParams.ambientOcclusion={bind:function(a,e){s.ssaoHelper.setUniforms(a,e)}},this._materialPassParams.ambientOcclusionEnabled=s.ssaoHelper.enabled,this._materialPassParams.sceneHasOcludees=s.hasOccludees},s.prototype._configure=function(s){var a=3===s.pass?this._shadowPassParams:4===s.pass?this._highlightPassParams:this._materialPassParams;this._updateParameters(s,a)},s.prototype._updateParameters=function(s,a){var e=s.camera,r=e.viewInverseTransposeMatrix;h.vec3.set(g,r[3],r[7],r[11]),f.set(g),h.vec3.copy(a.viewTransform.worldFromView_TH,f.high),h.vec3.copy(a.viewTransform.worldFromView_TL,f.low),t.mat3.fromMat4(a.viewTransform.viewFromCameraRelative_RS,e.viewMatrix),i.mat4.copy(a.viewTransform.projFromView,e.projectionMatrix),0===a.identifier?(this._materialPassParams.transparent=6===s.slot,this._materialPassParams.integratedMesh=1===s.slot,this._materialPassParams.lighting=s.scenelightingData,t.mat3.transpose(_,a.viewTransform.viewFromCameraRelative_RS),t.mat3.invert(a.transformNormal_ViewFromGlobal,_),n.vec2.set(a.cameraNearFar,e.near,e.far)):1===a.identifier?n.vec2.set(a.cameraNearFar,e.near,e.far):2===a.identifier&&(a.highlightDepthTexture=s.highlightDepthTexture,l.vec4.copy(a.viewport,e.fullViewport),a.inverseViewport[0]=1/e.fullViewport[2],a.inverseViewport[1]=1/e.fullViewport[3]),m.boundedPlane.copy(s.sliceHelper.plane,a.slicePlane),h.vec3.subtract(a.slicePlane.origin,a.slicePlane.origin,g),a.slicePlaneEnabled=s.sliceHelper.isEnabled,this._materialPassParams.transparencyPassType=s.transparencyPassType},s.prototype._registerPass=function(s){return this._passes.push(s),s},Object.defineProperty(s.prototype,"needsHighlight",{get:function(){return this.passes.highlight.count>0||this.passes.highlightIntegratedMesh.count>0},enumerable:!1,configurable:!0}),s}();a.RenderPassManager=u;var g=o.vec3f64.create(),_=r.mat3f64.create(),f=new P.TwoVectorPosition}));