/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/maybe","../../../../../chunks/mat3","../../../../../chunks/mat3f64","../../../../../chunks/mat4","../../../../../chunks/vec3","../../../../../chunks/vec3f64","./AllRenderPasses","./RenderPass","../shaderLibrary/ShaderOutput","../util/TwoVectorPosition","../../lib/depthRange","../../lib/RenderSlot"],(function(a,e,s,t,r,i,h,n,u,o,P,d,m,l){"use strict";let p=function(){function a(a,e){this.rctx=a,this.shaderTechniqueRepository=e,this.canRender=!0,this._materialPassParameters=new u.MaterialPassParameters,this._shadowPassParameters=new u.ShadowMapPassParameters,this._highlightPassParameters=new u.HighlightPassParameters,this._systems=new Set,this._passes={materialOpaque:new o.RenderPass(a,e),materialTransparent:new o.RenderPass(a,e,o.RenderPassSorting.BackToFront),materialIntegratedMesh:new o.RenderPass(a,e),shadowMap:new o.RenderPass(a,e),highlight:new o.RenderPass(a,e),highlightIntegratedMesh:new o.RenderPass(a,e),highlightShadowMap:new o.RenderPass(a,e),defaultShadowMap:new o.RenderPass(a,e)}}var r=a.prototype;return r.register=function(a){this._systems.add(a)},r.prepareRender=function(a){if(0!==this._systems.size){for(const a of Object.values(this._passes))a.prepareSubmit();this._systems.forEach((e=>e.submit(this._passes,a.bindParameters)));for(const a of Object.values(this._passes))a.finishSubmit();this.shaderTechniqueRepository.frameUpdate()}},r.render=function(a){if(0!==this._systems.size)switch(this._configure(a),a.bindParameters.slot){case l.RenderSlot.OPAQUE_MATERIAL:switch(a.output){case P.ShaderOutput.Color:return this._materialPassParameters.subPass=u.MaterialSubPass.Color,this._passes.materialOpaque.dispatch(this._materialPassParameters,a.bindParameters);case P.ShaderOutput.Depth:return this._materialPassParameters.subPass=u.MaterialSubPass.Depth,this._passes.materialOpaque.dispatch(this._materialPassParameters,a.bindParameters);case P.ShaderOutput.Normal:return this._materialPassParameters.subPass=u.MaterialSubPass.Normal,this._passes.materialOpaque.dispatch(this._materialPassParameters,a.bindParameters);case P.ShaderOutput.Highlight:return this._passes.highlight.dispatch(this._highlightPassParameters,a.bindParameters);case P.ShaderOutput.Shadow:return this._passes.shadowMap.dispatch(this._shadowPassParameters,a.bindParameters);case P.ShaderOutput.ShadowHighlight:return this._passes.highlightShadowMap.dispatch(this._shadowPassParameters,a.bindParameters);case P.ShaderOutput.ShadowExludeHighlight:return this._passes.defaultShadowMap.dispatch(this._shadowPassParameters,a.bindParameters);case P.ShaderOutput.ObjectAndLayerIdColor:return this._materialPassParameters.subPass=u.MaterialSubPass.ObjectAndLayerIdColor,this._passes.materialOpaque.dispatch(this._materialPassParameters,a.bindParameters)}return;case l.RenderSlot.TRANSPARENT_MATERIAL:switch(a.output){case P.ShaderOutput.Color:return this._materialPassParameters.subPass=u.MaterialSubPass.Color,this._passes.materialTransparent.dispatch(this._materialPassParameters,a.bindParameters);case P.ShaderOutput.Alpha:return this._materialPassParameters.subPass=u.MaterialSubPass.Alpha,this._passes.materialTransparent.dispatch(this._materialPassParameters,a.bindParameters);case P.ShaderOutput.Depth:return this._materialPassParameters.subPass=u.MaterialSubPass.Depth,this._passes.materialTransparent.dispatch(this._materialPassParameters,a.bindParameters);case P.ShaderOutput.Normal:return this._materialPassParameters.subPass=u.MaterialSubPass.Normal,this._passes.materialTransparent.dispatch(this._materialPassParameters,a.bindParameters);case P.ShaderOutput.ObjectAndLayerIdColor:return this._materialPassParameters.subPass=u.MaterialSubPass.ObjectAndLayerIdColor,this._passes.materialTransparent.dispatch(this._materialPassParameters,a.bindParameters)}return;case l.RenderSlot.INTEGRATED_MESH:switch(a.output){case P.ShaderOutput.Color:return this._materialPassParameters.subPass=u.MaterialSubPass.Color,this._passes.materialIntegratedMesh.dispatch(this._materialPassParameters,a.bindParameters);case P.ShaderOutput.Depth:return this._materialPassParameters.subPass=u.MaterialSubPass.Depth,this._passes.materialIntegratedMesh.dispatch(this._materialPassParameters,a.bindParameters);case P.ShaderOutput.Normal:return this._materialPassParameters.subPass=u.MaterialSubPass.Normal,this._passes.materialIntegratedMesh.dispatch(this._materialPassParameters,a.bindParameters);case P.ShaderOutput.Highlight:return this._passes.highlightIntegratedMesh.dispatch(this._highlightPassParameters,a.bindParameters);case P.ShaderOutput.ObjectAndLayerIdColor:return this._materialPassParameters.subPass=u.MaterialSubPass.ObjectAndLayerIdColor,this._passes.materialIntegratedMesh.dispatch(this._materialPassParameters,a.bindParameters)}return}},r.notifyDirty=function(){this._context.requestRender()},r.slots=function(){return[l.RenderSlot.OPAQUE_MATERIAL,l.RenderSlot.TRANSPARENT_MATERIAL,l.RenderSlot.INTEGRATED_MESH]},r.initializeRenderContext=function(a){this._context=a},r.uninitializeRenderContext=function(){},r.queryDepthRange=function(a){const e={near:1/0,far:-1/0};return this._systems.forEach((t=>{const r=t.queryShadowCasterDepthRange(a);s.isSome(r)&&m.union(e,r,e)})),e},r._configure=function(a){const e=a.output===P.ShaderOutput.Shadow||a.output===P.ShaderOutput.ShadowHighlight||a.output===P.ShaderOutput.ShadowExludeHighlight?this._shadowPassParameters:a.output===P.ShaderOutput.Highlight?this._highlightPassParameters:this._materialPassParameters;this._updateParameters(a,e)},r._updateParameters=function(a,e){const s=a.bindParameters.camera,r=s.viewInverseTransposeMatrix;h.set(c,r[3],r[7],r[11]),S.set(c),h.copy(e.transformWorldFromViewTH,S.high),h.copy(e.transformWorldFromViewTL,S.low),h.copy(e.slicePlaneLocalOrigin,c),t.fromMat4(e.transformViewFromCameraRelativeRS,s.viewMatrix),i.copy(e.transformProjFromView,s.projectionMatrix),e.identifier===u.RenderPassIdentifier.Material&&(this._materialPassParameters.transparent=a.bindParameters.slot===l.RenderSlot.TRANSPARENT_MATERIAL,this._materialPassParameters.integratedMesh=a.bindParameters.slot===l.RenderSlot.INTEGRATED_MESH,t.transpose(_,e.transformViewFromCameraRelativeRS),t.invert(e.transformNormalViewFromGlobal,_))},e._createClass(a,[{key:"needsHighlight",get:function(){return this._passes.highlight.count>0||this._passes.highlightIntegratedMesh.count>0}},{key:"needsTransparentPass",get:function(){return this._passes.materialTransparent.count>0}}]),a}();const c=n.create(),_=r.create(),S=new d.TwoVectorPosition;a.RenderPassManager=p,Object.defineProperties(a,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
