/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/Error","../../../../../core/Logger","../../../../../core/maybe"],(function(e,n,t,r,i){"use strict";const o=r.getLogger("esri.views.3d.webgl-engine.core.shaderModules.shaderBuilder");let s=function(){function e(){this._includedModules=new Map}return e.prototype.include=function(e,n){if(this._includedModules.has(e)){const t=this._includedModules.get(e);if(t!==n){o.error("Trying to include shader module multiple times with different sets of options.");const n=new Set;for(const r of Object.keys(t))t[r]!==e[r]&&n.add(r);for(const r of Object.keys(e))t[r]!==e[r]&&n.add(r);n.forEach((n=>console.error(`  ${n}: current ${t[n]} new ${e[n]}`)))}}else this._includedModules.set(e,n),e(this.builder,n)},e}(),a=function(e){function t(){var n;return(n=e.apply(this,arguments)||this).vertex=new f,n.fragment=new f,n.attributes=new m,n.varyings=new d,n.extensions=new l,n.constants=new _,n}n._inheritsLoose(t,e);var r=t.prototype;return r.generate=function(e){const n=this.extensions.generateSource(e),t=this.attributes.generateSource(e),r=this.varyings.generateSource(),i="vertex"===e?this.vertex:this.fragment,o=i.uniforms.generateSource(),s=i.code.generateSource(),a="vertex"===e?p:h,u=this.constants.generateSource().concat(i.constants.generateSource());return`\n${n.join("\n")}\n\n${a}\n\n${u.join("\n")}\n\n${o.join("\n")}\n\n${t.join("\n")}\n\n${r.join("\n")}\n\n${s.join("\n")}`},r.generateBind=function(e,n){const t=new Map;this.vertex.uniforms.entries.forEach((n=>{const r=n.bind[e];i.isSome(r)&&t.set(n.name,r)})),this.fragment.uniforms.entries.forEach((n=>{const r=n.bind[e];i.isSome(r)&&t.set(n.name,r)}));const r=Array.from(t.values()),o=r.length;return(e,t,i)=>{for(let s=0;s<o;++s)r[s](n,e,t,i)}},n._createClass(t,[{key:"fragmentUniforms",get:function(){return this.fragment.uniforms.entries}},{key:"builder",get:function(){return this}}]),t}(s),u=function(){function e(){this._entries=new Map}var r=e.prototype;return r.add=function(e){if(!Array.isArray(e))return this._add(e);for(const n of e)this._add(n)},r.get=function(e){return this._entries.get(e)},r._add=function(e){if(i.isNone(e))o.error(`Trying to add null Uniform from ${(new Error).stack}.`);else{if(this._entries.has(e.name)&&!this._entries.get(e.name).equals(e))throw new t(`Duplicate uniform name ${e.name} for different uniform type`);this._entries.set(e.name,e)}},r.generateSource=function(){return Array.from(this._entries.values()).map((e=>i.isSome(e.arraySize)?`uniform ${e.type} ${e.name}[${e.arraySize}];`:`uniform ${e.type} ${e.name};`))},n._createClass(e,[{key:"entries",get:function(){return Array.from(this._entries.values())}}]),e}(),c=function(){function e(){this._entries=new Array}var n=e.prototype;return n.add=function(e){this._entries.push(e)},n.generateSource=function(){return this._entries},e}(),f=function(e){function t(){var n;return(n=e.apply(this,arguments)||this).uniforms=new u,n.code=new c,n.constants=new _,n}return n._inheritsLoose(t,e),n._createClass(t,[{key:"builder",get:function(){return this}}]),t}(s),m=function(){function e(){this._entries=new Array}var n=e.prototype;return n.add=function(e,n){this._entries.push([e,n])},n.generateSource=function(e){return"fragment"===e?[]:this._entries.map((e=>`attribute ${e[1]} ${e[0]};`))},e}(),d=function(){function e(){this._entries=new Array}var n=e.prototype;return n.add=function(e,n){this._entries.push([e,n])},n.generateSource=function(){return this._entries.map((e=>`varying ${e[1]} ${e[0]};`))},e}(),l=function(){function e(){this._entries=new Set}var n=e.prototype;return n.add=function(e){this._entries.add(e)},n.generateSource=function(n){const t="vertex"===n?e.ALLOWLIST_VERTEX:e.ALLOWLIST_FRAGMENT;return Array.from(this._entries).filter((e=>t.includes(e))).map((e=>`#extension ${e} : enable`))},e}();l.ALLOWLIST_FRAGMENT=["GL_EXT_shader_texture_lod","GL_OES_standard_derivatives"],l.ALLOWLIST_VERTEX=[];let _=function(){function e(){this._entries=new Set}var n=e.prototype;return n.add=function(n,t,r){let i="ERROR_CONSTRUCTOR_STRING";switch(t){case"float":i=e._numberToFloatStr(r);break;case"int":i=e._numberToIntStr(r);break;case"bool":i=r.toString();break;case"vec2":i=`vec2(${e._numberToFloatStr(r[0])},                            ${e._numberToFloatStr(r[1])})`;break;case"vec3":i=`vec3(${e._numberToFloatStr(r[0])},                            ${e._numberToFloatStr(r[1])},                            ${e._numberToFloatStr(r[2])})`;break;case"vec4":i=`vec4(${e._numberToFloatStr(r[0])},                            ${e._numberToFloatStr(r[1])},                            ${e._numberToFloatStr(r[2])},                            ${e._numberToFloatStr(r[3])})`;break;case"ivec2":i=`ivec2(${e._numberToIntStr(r[0])},                             ${e._numberToIntStr(r[1])})`;break;case"ivec3":i=`ivec3(${e._numberToIntStr(r[0])},                             ${e._numberToIntStr(r[1])},                             ${e._numberToIntStr(r[2])})`;break;case"ivec4":i=`ivec4(${e._numberToIntStr(r[0])},                             ${e._numberToIntStr(r[1])},                             ${e._numberToIntStr(r[2])},                             ${e._numberToIntStr(r[3])})`;break;case"mat2":case"mat3":case"mat4":i=`${t}(${Array.prototype.map.call(r,(n=>e._numberToFloatStr(n))).join(", ")})`}return this._entries.add(`const ${t} ${n} = ${i};`),this},e._numberToIntStr=function(e){return e.toFixed(0)},e._numberToFloatStr=function(e){return Number.isInteger(e)?e.toFixed(1):e.toString()},n.generateSource=function(){return Array.from(this._entries)},e}();const h="#ifdef GL_FRAGMENT_PRECISION_HIGH\n  precision highp float;\n  precision highp sampler2D;\n#else\n  precision mediump float;\n  precision mediump sampler2D;\n#endif",p="precision highp float;\nprecision highp sampler2D;";e.Code=c,e.Includes=s,e.ShaderBuilder=a,e.Stage=f,e.Uniforms=u,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
