/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../../chunks/tslib.es6.js";import t from"../../../../../core/Evented.js";import i from"../../../../../core/Handles.js";import r from"../../../../../core/Logger.js";import{destroyMaybe as o,isSome as s,isNone as n,unwrap as a}from"../../../../../core/maybe.js";import{watch as m,syncAndInitial as h}from"../../../../../core/reactiveUtils.js";import{property as l}from"../../../../../core/accessorSupport/decorators/property.js";import"../../../../../core/arrayUtils.js";import"../../../../../core/has.js";import"../../../../../core/accessorSupport/ensureType.js";import{subclass as c}from"../../../../../core/accessorSupport/decorators/subclass.js";import p from"../../../../../geometry/Point.js";import{tryProjectWithZConversion as d}from"../../../../../geometry/projection.js";import{empty as u,expandPointInPlace as y}from"../../../../../geometry/support/aaBoundingRect.js";import{logFailedGeometryProjectionError as g}from"../../support/projectionUtils.js";import{createCoordinateHelper as G}from"../../../../interactive/coordinateHelper.js";import{EditGeometry as f,Component as v}from"../../../../interactive/editGeometry/EditGeometry.js";import{EditGeometryOperations as _}from"../../../../interactive/editGeometry/EditGeometryOperations.js";const V=r.getLogger("esri.views.3d.analysis.AreaMeasurement.support.AreaMeasurement3DPathHelper");let x=class extends t.EventedAccessor{constructor(e={}){super(e),this._handles=new i,this._version=0,this._internalGeometryChange=!1,this._extent=u()}destroy(){this._handles=o(this._handles)}set areaMeasurement(e){this._set("areaMeasurement",e),s(e)&&s(this.view)&&this._initialize(e,this.view)}set view(e){this._set("view",e),s(e)&&s(this.areaMeasurement)&&this._initialize(this.areaMeasurement,e)}get initialized(){return s(this.areaMeasurement)&&s(this.view)}get version(){return this._version}get isValidPolygon(){return this.initialized&&this.editGeometry.components.length>0&&this.editGeometry.components[0].isClosed()}get extent(){if(this.initialized&&this.editGeometry.components.length>0&&this.editGeometry.components[0].vertices.length>0){const e=u(this._extent);return this.forEachVertex((t=>{y(e,t.pos)})),e}return null}get spatialReference(){return this.initialized?this.editGeometry.coordinateHelper.spatialReference:null}_initialize(e,t){this._handles.removeAll(),this._handles.add(m((()=>e.geometry),(()=>{this._updateEditGeometryFromModelGeometry(e,t)}),h)),this._makeDirty(!0)}_makeDirty(e=!1){this.notifyChange("isValidPolygon"),this.notifyChange("initialized"),this.notifyChange("extent"),e&&this.notifyChange("numVertices")}_updateEditGeometryFromModelGeometry(e,t){if(this._version++,this._internalGeometryChange)return;this._handles.remove("EditGeometry");let i=e.geometry;if(s(i)){const r=d(i,t.spatialReference);n(r)&&g(e,i.spatialReference,V),i=r}s(i)?this._editGeometryOperations=_.fromGeometry(i,t.state.viewingMode):this._editGeometryOperations=new _(new f("polygon",G(!0,!1,t.spatialReference))),this._makeDirty(!0),this.emit("change"),this._handles.add(this.editGeometry.on("change",(t=>{this._makeDirty(null!=t.addedVertices||null!=t.removedVertices),this._internalGeometryChange=!0,e.geometry=this.numVertices>0?this.editGeometry.geometry:null,this._internalGeometryChange=!1})),"EditGeometry")}get editGeometry(){return this._editGeometryOperations.data}get vertices(){const e=[];return this.forEachVertex((t=>{e.push(t)})),e}get numVertices(){return this.initialized&&this.editGeometry.components.length>0?this.editGeometry.components[0].vertices.length:0}get lastPoint(){if(this.initialized&&this.editGeometry.components.length>0){const e=this.editGeometry.components[0].getLastVertex();if(s(e))return this.editGeometry.coordinateHelper.vectorToPoint(e.pos)}return null}getVertex(e){if(!this.initialized||0===this.editGeometry.components.length||0===this.editGeometry.components[0].vertices.length)return null;const t=this.editGeometry.components[0].vertices[0];let i=t;do{if(i.index===e)return i;i=i.rightEdge.rightVertex}while(i!==t&&null!=i);return null}getVertexPositionAsPoint(e){return this.editGeometry.coordinateHelper.vectorToPoint(e.pos)}getVertexPositionAsPointFromIndex(e){return this.editGeometry.coordinateHelper.vectorToPoint(this.getVertex(e).pos)}forEachVertex(e){this.initialized&&this.editGeometry.components.length>0&&this.editGeometry.components[0].iterateVertices(e)}forEachVertexPosition(e){const t=this.editGeometry.coordinateHelper;this.forEachVertex(((i,r)=>{t.vectorToPoint(i.pos,P),e(P,r)}))}clear(){s(this.areaMeasurement)&&(this.areaMeasurement.geometry=null)}add(e){if(!this.initialized)return null;if(0===this.editGeometry.components.length){const e=a(this.view);this.editGeometry.components.push(new v(e.spatialReference,e.state.viewingMode))}const t=this._editGeometryOperations.appendVertex(this.editGeometry.coordinateHelper.pointToVector(e));return this.emit("change"),t}close(){if(!this.initialized||0===this.editGeometry.components.length)return null;const e=this._editGeometryOperations.closeComponent(this.editGeometry.components[0]);return this.emit("change"),e}ensureContains(e,t=""){let i=!1;if(this.editGeometry.components.forEach((t=>{t.iterateVertices((t=>{t===e&&(i=!0)}))})),!i)throw new Error(`vertex doesnt exist ${t}`);return i}setVertexPosition(e,t){if(!this.initialized)return null;const i=this._editGeometryOperations.setVertexPosition(e,this.editGeometry.coordinateHelper.pointToVector(t));return this.emit("change"),i}equals(e){if(this.numVertices!==e.numVertices)return!1;let t=!0;return this.forEachVertexPosition(((i,r)=>{const o=e.getVertexPositionAsPointFromIndex(r);i.equals(o)||(t=!1)})),!!t}};e([l({value:null})],x.prototype,"areaMeasurement",null),e([l({value:null})],x.prototype,"view",null),e([l()],x.prototype,"isValidPolygon",null),e([l()],x.prototype,"extent",null),e([l()],x.prototype,"spatialReference",null),e([l()],x.prototype,"numVertices",null),x=e([c("esri.views.3d.analysis.AreaMeasurement.support.AreaMeasurement3DPathHelper")],x);const P=new p;export{x as AreaMeasurement3DPathHelper};
