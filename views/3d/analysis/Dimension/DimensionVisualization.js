/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../Color","../../../../intl","../../../../core/Accessor","../../../../core/handleUtils","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/screenUtils","../../../../core/accessorSupport/decorators/property","../../../../core/arrayUtils","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec4f64","./LengthDimensionVisualization","./settings","../../webgl-engine/lib/Material","../../webgl-engine/materials/LineMarkerMaterial","../../webgl-engine/materials/lineStippleUtils","../../webgl-engine/materials/MarkerTextureCache","../../webgl-engine/materials/RibbonLineMaterial","../../webgl-engine/shaders/LineMarkerTechniqueConfiguration","../../../../intl/locale","../../../../intl/messages"],(function(e,i,t,a,s,n,r,o,l,c,d,u,h,m,p,_,f,g,M,y,w,b,L,v,O){"use strict";function z(e){const{fontSize:i,lineSize:t,textColor:a,textBackgroundColor:s}=e.style;return{fontSize:i,lineSize:t,textBackgroundColor:s.clone(),textColor:a.clone()}}e.DimensionVisualization=function(e){function t(i){var t;return(t=e.call(this,i)||this).loadingMessages=!1,t._messages=null,t._dimensionVisualizations=new Map,t._markerMaterial=new M.LineMarkerMaterial({width:1,anchor:L.LineMarkerAnchor.Tip,color:p.ZEROS,placement:"begin-end",worldSpace:!0,hideOnShortSegments:!0,hasTip:!0,renderOccluded:g.RenderOccludedFlag.OccludeAndTransparent}),t._dimensionLineMaterial=new b.RibbonLineMaterial({width:1,color:p.ZEROS,renderOccluded:g.RenderOccludedFlag.OccludeAndTransparent,markerParameters:t._markerMaterial.parameters}),t._offsetLineMaterial=new b.RibbonLineMaterial({width:1,color:p.ZEROS,renderOccluded:g.RenderOccludedFlag.OccludeAndTransparent,stipplePattern:y.createStipplePatternSimple(5),stippleScaleWithLineWidth:!0}),t._smallDimensionLineMaterial=new b.RibbonLineMaterial({width:1,color:p.ZEROS,renderOccluded:g.RenderOccludedFlag.OccludeAndTransparent}),t._smallOffsetLineMaterial=new b.RibbonLineMaterial({width:1,color:p.ZEROS,renderOccluded:g.RenderOccludedFlag.OccludeAndTransparent,stipplePattern:y.createStipplePatternSimple(5),stippleScaleWithLineWidth:!0}),t}i._inheritsLoose(t,e);var s=t.prototype;return s.initialize=function(){const{textures:e}=this.view.sharedSymbolResources;if(o.isSome(e)){const{textureRepository:i}=this.view._stage.renderView,t=new w.MarkerTextureCache(e,i),a=t.acquire("triangle");this.addHandles(r.makeHandle((()=>t.destroy()))),this._markerMaterial.setParameters({textureId:a.id})}for(const t of this._lineMaterials())this.view._stage.add(t),this.addHandles(r.makeHandle((()=>{this.view._stage.remove(t),t.dispose()})));const{computations:i}=this.analysisViewData;for(const t of i)this._addComputation(t);this.addHandles([i.on("change",(({added:e,removed:i})=>{for(const t of i)this._removeComputation(t);for(const t of e)this._addComputation(t)})),l.watch((()=>a.toUnitRGBA(this.analysis.style.color)),(e=>{for(const i of this._lineMaterials())i.setParameters({color:e})}),l.syncAndInitial),l.watch((()=>this.analysis.style.lineSize),(e=>{const i=c.pt2px(e);this._markerMaterial.setParameters({width:i*f.settings.markers.lineSizeFraction}),this._dimensionLineMaterial.setParameters({width:i,markerParameters:this._markerMaterial.parameters});const t=Math.max(i*f.settings.offsetLine.lineSizeFraction,1);this._offsetLineMaterial.setParameters({width:t})}),l.syncAndInitial),l.watch((()=>({camera:this.view.state.camera,style:z(this.analysis)})),(({camera:e,style:i})=>{for(const[t,a]of this._dimensionVisualizations)a.updateCameraDependentElements(e,t.geometry,i),a.updateLabelStyle(i)})),l.watch((()=>this.visible),(e=>{for(const i of this._dimensionVisualizations.values())i.visible=e}))]),this.addHandles([v.onLocaleChange((()=>this._updateMessageBundle())),l.when((()=>!this.loadingMessages),(()=>{for(const e of this._dimensionVisualizations.values())e.updateUnitsMessages(this._messages)}),l.sync)]),this._updateMessageBundle()},s.destroy=function(){this._dimensionVisualizations.forEach((e=>{e.destroy()})),this._dimensionVisualizations.clear()},s._addComputation=function(e){this._dimensionVisualizations.has(e)||this._dimensionVisualizations.set(e,new _.LengthDimensionVisualization({analysis:this.analysis,computation:e,view:this.view,visible:this.visible,markerMaterial:this._markerMaterial,dimensionLineMaterial:this._dimensionLineMaterial,offsetLineMaterial:this._offsetLineMaterial,smallDimensionLineMaterial:this._smallDimensionLineMaterial,smallOffsetLineMaterial:this._smallOffsetLineMaterial,messages:this._messages}))},s._removeComputation=function(e){const i=this._dimensionVisualizations.get(e);o.isNone(i)||(i.destroy(),this._dimensionVisualizations.delete(e))},s._lineMaterials=function(){return[this._markerMaterial,this._dimensionLineMaterial,this._offsetLineMaterial,this._smallDimensionLineMaterial,this._smallOffsetLineMaterial]},s._updateMessageBundle=function(){var e=i._asyncToGenerator((function*(){this.loadingMessages=!0;try{this._messages=yield O.fetchMessageBundle("esri/core/t9n/Units")}finally{this.loadingMessages=!1}}));function t(){return e.apply(this,arguments)}return t}(),i._createClass(t,[{key:"analysis",get:function(){return this.analysisViewData.analysis}},{key:"visible",get:function(){return this.analysisViewData.visible}},{key:"testInfo",get:function(){return{visualizations:Array.from(this._dimensionVisualizations.values()),disablePartialOcclusion:()=>{for(const e of this._lineMaterials())e.setParameters({renderOccluded:g.RenderOccludedFlag.Occlude})}}}}]),t}(n),t.__decorate([d.property({constructOnly:!0})],e.DimensionVisualization.prototype,"analysisViewData",void 0),t.__decorate([d.property({constructOnly:!0,nonNullable:!0})],e.DimensionVisualization.prototype,"view",void 0),t.__decorate([d.property()],e.DimensionVisualization.prototype,"analysis",null),t.__decorate([d.property()],e.DimensionVisualization.prototype,"visible",null),t.__decorate([d.property()],e.DimensionVisualization.prototype,"loadingMessages",void 0),e.DimensionVisualization=t.__decorate([m.subclass("esri.views.3d.analysis.Dimension.DimensionVisualization")],e.DimensionVisualization),Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
