/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../analysis/dimensionUtils","../../../../core/mathUtils","../../../../core/maybe","../../../../core/quantityUtils","../../../../core/unitUtils","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/support/Axis","../../../../geometry/support/vectorStacks","../../../../layers/graphics/dehydratedFeatures","../../../../layers/graphics/hydratedFeatures","../../interactive/visualElements/support/Segment","../../../support/euclideanLengthMeasurementUtils"],(function(e,n,t,r,i,o,s,a,d,c,l,u,m,S,p,g){"use strict";function f(e,t,s){if(r.isNone(e))return null;const a=e.dimensionSegment.startRenderSpace,d=e.dimensionSegment.endRenderSpace,c=g.euclideanDirectDistance(a,d,e.spatialReference);if(r.isNone(c))return null;const l=t===n.LengthDimensionMeasureType.Vertical?o.preferredVerticalLengthUnit(c.value,c.unit,s):o.preferredLengthUnit(c.value,c.unit,s);return i.toUnit(c,l)}function v(e){const{elevationAlignedStartPoint:n,elevationAlignedEndPoint:t,dimension:{offset:r,measureType:i,orientation:o}}=e;return{elevationAlignedStartPoint:n,elevationAlignedEndPoint:t,offset:r,measureType:i,orientation:o}}function y({elevationAlignedStartPoint:e,elevationAlignedEndPoint:t,offset:i,measureType:o,orientation:s},a,l=null){if(r.isNone(e)||r.isNone(t))return null;const u=T(r.isSome(l)?l.directSegment:new p.EuclideanSegment,{elevationAlignedStartPoint:e,elevationAlignedEndPoint:t},a),m=r.isSome(l)?l.primaryOffsetAxis:c.create();x(m,{measureType:o,elevationAlignedStartPoint:e,elevationAlignedEndPoint:t,directSegment:u,orientation:s,renderCoordsHelper:a});const S=r.isSome(l)?l.dimensionSegment:new p.EuclideanSegment;return C({elevationAlignedStartPoint:e,elevationAlignedEndPoint:t})&&o===n.LengthDimensionMeasureType.Vertical?(d.copy(S.startRenderSpace,u.startRenderSpace),d.copy(S.endRenderSpace,u.endRenderSpace)):U(S,{offsetAxis:m,offset:i,relativeToSegment:u,renderCoordsHelper:a}),{directSegment:u,dimensionSegment:S,primaryOffsetAxis:m,spatialReference:a.spatialReference}}function R(n,t,r,i){return t===e.OffsetSegmentLocation.Start?(d.copy(n.startRenderSpace,r.startRenderSpace),d.copy(n.endRenderSpace,i.startRenderSpace)):(d.copy(n.startRenderSpace,r.endRenderSpace),d.copy(n.endRenderSpace,i.endRenderSpace)),n}var A;function P(e,n,t,r){d.scaleAndAdd(e.startRenderSpace,n.startRenderSpace,t,r),d.scaleAndAdd(e.endRenderSpace,n.endRenderSpace,t,r)}function h(e,t,r,i){switch(t){case n.LengthDimensionMeasureType.Direct:return T(e,r,i);case n.LengthDimensionMeasureType.Horizontal:case n.LengthDimensionMeasureType.Vertical:{const{elevationAlignedStartPoint:o,elevationAlignedEndPoint:s,dimension:a,geometry:d}=r;let c;if(a.measureType===n.LengthDimensionMeasureType.Direct){c=D(d,i)===o.z>s.z,t===n.LengthDimensionMeasureType.Horizontal&&(c=!c)}else c=!E(d);const[l,u]=c?[o,s]:[s,o],m=S.clonePoint(u,L);return t===n.LengthDimensionMeasureType.Horizontal?m.z=l.z:(m.x=l.x,m.y=l.y),i.toRenderCoords(l,e.startRenderSpace),i.toRenderCoords(m,e.endRenderSpace),e}}}function T(e,n,t){return t.toRenderCoords(n.elevationAlignedStartPoint,e.startRenderSpace),t.toRenderCoords(n.elevationAlignedEndPoint,e.endRenderSpace),e}function D(e,n){const t=e.directSegment.eval(.5,u.sv3d.get()),r=n.worldUpAtPosition(t,u.sv3d.get()),i=e.dimensionSegment.eval(.5,u.sv3d.get()),o=d.sub(u.sv3d.get(),i,t);return!d.equals(o,c.ZEROS)&&d.dot(o,r)>0}function E(e){const{startRenderSpace:n,endRenderSpace:t}=e.dimensionSegment,{startRenderSpace:r,endRenderSpace:i}=e.directSegment;return d.sqrDist(r,n)<d.sqrDist(i,t)}e.OffsetSegmentLocation=void 0,(A=e.OffsetSegmentLocation||(e.OffsetSegmentLocation={}))[A.Start=0]="Start",A[A.End=1]="End";const L=m.makeDehydratedPoint(0,0,0,null);function M(e,n,t,r){const{directSegment:i}=t,o=x(u.sv3d.get(),{measureType:n,directSegment:i,renderCoordsHelper:r}),s=U(b,{offsetAxis:o,offset:0,relativeToSegment:i,renderCoordsHelper:r}).eval(.5,u.sv3d.get()),a=d.sub(u.sv3d.get(),e,s);return d.dot(a,o)*r.unitInMeters}const b=new p.EuclideanSegment;function x(e,i){const{measureType:o,elevationAlignedStartPoint:a,elevationAlignedEndPoint:m,directSegment:{startRenderSpace:S,endRenderSpace:p},directSegment:g,renderCoordsHelper:f}=i,v=g.eval(.5,u.sv3d.get()),y=f.worldUpAtPosition(v,u.sv3d.get()),R=f.worldBasisAtPosition(v,l.Axis.Y,u.sv3d.get());switch(o){case n.LengthDimensionMeasureType.Horizontal:d.copy(e,y);break;case n.LengthDimensionMeasureType.Vertical:d.dot(S,y)<d.dot(p,y)?d.sub(e,p,S):d.sub(e,S,p),d.cross(e,e,y),d.cross(e,e,y);break;case n.LengthDimensionMeasureType.Direct:{const n=r.unwrapOr(i.orientation,0);if(C({elevationAlignedStartPoint:a,elevationAlignedEndPoint:m}))s.fromRotation(O,-t.deg2rad(n),y),d.transformMat4(e,R,O);else{const r=d.sub(u.sv3d.get(),p,S),i=d.cross(u.sv3d.get(),r,y);d.cross(i,i,r),s.fromRotation(O,t.deg2rad(n),r),d.transformMat4(e,i,O)}break}}return d.equals(e,c.ZEROS)?d.copy(e,R):d.normalize(e,e)}const O=a.create();function C({elevationAlignedStartPoint:e,elevationAlignedEndPoint:n}){return r.isSome(e)&&r.isSome(n)&&e.x===n.x&&e.y===n.y}function U(e,n){const{offsetAxis:t,offset:r,relativeToSegment:{startRenderSpace:i,endRenderSpace:o},relativeToSegment:s,renderCoordsHelper:a}=n,c=r/a.unitInMeters,[l,u]=H(i,o,t,c);return d.scaleAndAdd(e.startRenderSpace,s.startRenderSpace,t,l),d.scaleAndAdd(e.endRenderSpace,s.endRenderSpace,t,u),e}function H(e,n,t,r=0){const i=d.dot(n,t),o=d.dot(e,t),s=Math.abs(i-o)+r;return i>o?[s,r]:[r,s]}function w(e,n,t){const r=n.directSegment.eval(.5,u.sv3d.get());return t.worldUpAtPosition(r,e)}function k(e,n){const{startRenderSpace:t,endRenderSpace:r}=n.directSegment;return d.sub(e,r,t)}function z(e,n,t={invert:!1}){const{startRenderSpace:r,endRenderSpace:i}=n.dimensionSegment;return t.invert?d.sub(e,r,i):d.sub(e,i,r)}function q(e,n){const t=e.directSegment.eval(.5,u.sv3d.get());return n.headingAtPosition(t,e.primaryOffsetAxis)}function F(e,n){return d.squaredLength(z(N,e))/n**2}const N=c.create();function V(e){const{elevationAlignedStartPoint:n,elevationAlignedEndPoint:t}=e;if(r.isNone(n)||r.isNone(t))return!1;const o=g.euclideanDirectDistanceBetweenPoints(n,t);return r.isSome(o)&&i.toUnit(o,"meters").value>G}const G=1e5;function I(e){return r.isSome(e.geometry)}e.GEODESIC_DISTANCE_THRESHOLD=G,e.arePointsVerticallyAligned=C,e.computationToGeometryDependencies=v,e.computeGeometryFromDimension=y,e.computeLength=f,e.computeOffsetAxis=x,e.computeOffsetForPoint=M,e.computeSegmentForMeasureType=h,e.computeSpanningSegment=R,e.dimensionStartToEnd=z,e.directStartToEnd=k,e.directUp=w,e.headingFromGeometry=q,e.isGeodesicDimension=V,e.isValidComputation=I,e.maxScreenLengthSquaredFromGeometry=F,e.offsetSegment=P,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
