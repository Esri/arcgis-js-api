/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/Handles","../../../../core/lang","../../../../core/maybe","../../../../core/quantityFormatUtils","../../../../core/reactiveUtils","../../../../core/screenUtils","../../../../chunks/vec3f64","./lengthDimensionUtils","./settings","../../interactive/visualElements/LabelVisualElement","../../interactive/visualElements/LineVisualElement","../../interactive/visualElements/MarkerVisualElement","../../interactive/visualElements/support/Segment"],(function(e,t,n,s,i,l,a,o,m,r,f,u,c,d,S){"use strict";let h=function(){function e(e){this.destroyed=!1,this._handles=new n,this._messages=null,this._labelSegment=new S.EuclideanSegment;const{analysis:t,computation:l,view:m,messages:r}=e;this.analysis=t,this.computation=l,this.view=m,this._messages=r;const f=e.visible,h={view:m,attached:f},{fontSize:g,textColor:p,textBackgroundColor:v}=t.style;this._visualElements=new y({marker:new d.MarkerVisualElement(h,e.markerMaterial),dimension:new c.LineVisualElement(h,e.dimensionLineMaterial),startOffset:new c.LineVisualElement(h,e.offsetLineMaterial),endOffset:new c.LineVisualElement(h,e.offsetLineMaterial),dimensionSmall:new c.LineVisualElement(h,e.smallDimensionLineMaterial),startOffsetSmall:new c.LineVisualElement(h,e.smallOffsetLineMaterial),endOffsetSmall:new c.LineVisualElement(h,e.smallOffsetLineMaterial),label:new u.LabelVisualElement({view:m,attached:f,distance:0,geometry:{type:"segment",sampleLocation:"center",segment:this._labelSegment,callout:!1},fontSize:o.pt2px(g),textColor:p.clone(),backgroundColor:v.clone()})}),this._handles.add([a.watch((()=>l.geometry),(e=>{this.updateCameraDependentElements(m.state.camera,e,t.style),i.isSome(l.geometry)&&this._updateLines(l.geometry)}),{...a.initial,equals:s.equals}),a.watch((()=>l.length),(e=>this._updateLabelContent(e)),a.initial)])}var m=e.prototype;return m.destroy=function(){this.destroyed=!0,this._handles=i.destroyMaybe(this._handles);for(const e of this._visualElements.values())e.destroy()},m._updateLines=function(e){const t=r.computeSpanningSegment(p,r.OffsetSegmentLocation.Start,e.directSegment,e.dimensionSegment),n=r.computeSpanningSegment(v,r.OffsetSegmentLocation.End,e.directSegment,e.dimensionSegment),s=this._visualElements;s.marker.setGeometryFromSegment(e.dimensionSegment,e.primaryOffsetAxis),s.dimension.setGeometryFromSegment(e.dimensionSegment),s.startOffset.setGeometryFromSegment(t),s.endOffset.setGeometryFromSegment(n),s.dimensionSmall.setGeometryFromSegment(e.dimensionSegment),s.startOffsetSmall.setGeometryFromSegment(t),s.endOffsetSmall.setGeometryFromSegment(n)},m.updateCameraDependentElements=function(e,t,n){const s=this._visualElements;if(i.isNone(t)){for(const e of s.values())e.visible=!1;return}const l=e.computeScreenPixelSizeAt(t.dimensionSegment.eval(.5,b)),a=r.maxScreenLengthSquaredFromGeometry(t,l),m=a<(o.pt2px(n.lineSize)*f.settings.smallScreenLengthLineSizeFactor)**2,u=!m;s.marker.visible=u,s.dimension.visible=u,s.startOffset.visible=u,s.endOffset.visible=u,s.dimensionSmall.visible=m,s.startOffsetSmall.visible=m,s.endOffsetSmall.visible=m;const c=o.pt2px(n.fontSize)*f.settings.labels.minScreenLengthFontSizeFactor,{label:d}=s;if(a<c**2)return void(d.visible=!1);d.visible=!0;const{dimensionSegment:S,primaryOffsetAxis:h}=t,{offset:p}=this.computation.dimension,v=(Math.sign(p)>=0?1:-1)*g(n)*l;r.offsetSegment(this._labelSegment,S,h,v),d.updateLabelPosition()},m.updateLabelStyle=function(e){const{label:t}=this._visualElements;t.fontSize=o.pt2px(e.fontSize),t.textColor=e.textColor,t.backgroundColor=e.textBackgroundColor},m.updateUnitsMessages=function(e){this._messages=e;const{length:t}=this.computation;this._updateLabelContent(t)},m._updateLabelContent=function(e){const{label:t}=this._visualElements;i.isNone(e)||i.isNone(this._messages)?t.text="":t.text=l.formatDecimal(this._messages,e,e.unit)},t._createClass(e,[{key:"visible",set:function(e){for(const t of this._visualElements.values())t.attached=e}},{key:"testInfo",get:function(){return{dimensionVisualElement:this._visualElements.dimension,label:this._visualElements.label}}}]),e}();function g(e){return 1.5*o.pt2px(e.fontSize)+f.settings.labels.marginPx+o.pt2px(e.lineSize/2)}const p=new S.EuclideanSegment,v=new S.EuclideanSegment,b=m.create();let y=function(){function e(e){this.marker=e.marker,this.dimension=e.dimension,this.startOffset=e.startOffset,this.endOffset=e.endOffset,this.dimensionSmall=e.dimensionSmall,this.startOffsetSmall=e.startOffsetSmall,this.endOffsetSmall=e.endOffsetSmall,this.label=e.label}return e.prototype.values=function(){return[this.marker,this.dimension,this.startOffset,this.endOffset,this.dimensionSmall,this.startOffsetSmall,this.endOffsetSmall,this.label]},e}();e.LengthDimensionVisualElements=y,e.LengthDimensionVisualization=h,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
