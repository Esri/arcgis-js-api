/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../Color","../../../../geometry","../../../../analysis/dimensionUtils","../../../../core/Cyclical","../../../../core/mathUtils","../../../../core/maybe","../../../../core/screenUtils","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/support/plane","../../../../geometry/support/vectorStacks","../../../../layers/graphics/hydratedFeatures","./lengthDimensionUtils","./settings","../../interactive/Manipulator3D","../../interactive/manipulatorUtils","../../interactive/editingTools/dragEventPipeline3D","../../interactive/visualElements/support/Segment","../../support/engineContent/marker","../../webgl-engine/lib/GeometryUtil","../../../interactive/dragEventPipeline","../../../interactive/interfaces","../../../../geometry/Point"],(function(e,t,n,a,r,i,o,s,c,l,u,d,p,m,f,g,M,h,y,S,v,T,P,D,x,H){"use strict";let F=function(){function e(e){this.start=e.start,this.end=e.end,this.offset=e.offset,this.heading=e.heading,this.rotation=e.rotation,this.direct=e.direct,this.horizontal=e.horizontal,this.vertical=e.vertical}var t=e.prototype;return t.manipulatorName=function(e){return Object.keys(this).find((t=>this.hasOwnProperty(t)&&e===this[t]))},t.values=function(){return[this.start,this.end,this.offset,this.heading,this.rotation,this.direct,this.horizontal,this.vertical]},t.forEachMeasureTypeManipulator=function(e){for(const t of a.lengthDimensionMeasureType)e(this.manipulatorForMeasureType(t),t)},t.manipulatorForMeasureType=function(e){switch(e){case a.LengthDimensionMeasureType.Direct:return this.direct;case a.LengthDimensionMeasureType.Horizontal:return this.horizontal;case a.LengthDimensionMeasureType.Vertical:return this.vertical}},e}();function O(e,n){const a=y.createSphereManipulator(e,t.toUnitRGB(M.settings.pointManipulators.color),M.settings.pointManipulators.opacity,ae);return a.available=!1,a.grabCursor="crosshair",a.radius=M.settings.pointManipulators.radius,a.metadata=n.metadata,a.collisionPriority=1,a}function E(e,t){const n=[d.fromValues(-.5,0,0),d.fromValues(.5,0,0)],{lengthFraction:a}=M.settings.offsetManipulator,r=P.createPolylineGeometry(n.map((e=>u.scale(d.create(),e,a))));return new h.Manipulator3D({view:e,renderObjects:[{geometry:r,material:t.unfocusedMaterial,stateMask:x.ManipulatorStateFlags.Unfocused|x.ManipulatorStateFlags.Selected|ae},{geometry:r,material:t.focusedMaterial,stateMask:x.ManipulatorStateFlags.Focused|ae}],collisionType:{type:"line",paths:[n]},radius:ne(t.lineSizePt)/2,metadata:t.metadata,available:!1,...y.worldScaledManipulatorSettings})}function R(e,{lineSizePt:t,material:n}){const{calloutOffsetPx:a,calloutOpacity:r,calloutWidth:i,discScale:o,focusMultiplier:c}=M.settings.orientationManipulator;return{calloutLength:.25*T.MARKER_SIZE_PER_LINE_WIDTH*M.settings.markers.lineSizeFraction*s.pt2px(t)+a,calloutOpacity:r,calloutWidth:i,customStateMask:ae,discScale:o,focusMultiplier:c,material:n,metadata:e}}function w(e,t){return y.createRotateManipulator(e,R(t.metadata,t))}function C(e,t){y.updateRotateManipulator(e,R(e.metadata,t))}function b(e,t){const n=[d.fromValues(-.5,0,0),d.fromValues(.5,0,0)],{lengthFraction:a}=M.settings.offsetManipulator,r=P.createPolylineGeometry(n),i=P.createPolylineGeometry(n.map((e=>u.scale(d.create(),e,a))));return new h.Manipulator3D({view:e,renderObjects:[{geometry:i,material:t.unfocusedMaterial,stateMask:x.ManipulatorStateFlags.Unfocused|ae},{geometry:i,material:t.focusedMaterial,stateMask:x.ManipulatorStateFlags.Focused|ae},{geometry:r,material:t.thinOffsetManipulatorMaterial,stateMask:ae}],collisionType:{type:"line",paths:[n]},radius:ne(t.lineSizePt)/2,available:!1,metadata:t.metadata,...y.worldScaledManipulatorSettings})}function k(e,{isStart:t,createSnappingPipelineStep:n,dimension:a,onUpdate:r,snappingPipeline:i,view:o}){const s=t?"startPoint":"endPoint",c=D.createManipulatorDragEventPipeline(e,((e,t,c,l)=>{const u=S.hideManipulatorWhileDragging(e);c=c.next(u).next(D.resetProperties(a,[s,"measureType","orientation"])),t.next(u).next(S.screenToMap3D(o)).next(n(c,l),i.next).next((e=>{const t=f.clonePoint(e.mapEnd,new H);r("startPoint"===s?{startPoint:t}:{endPoint:t})}))}));return[c]}function L(e,{computation:t,view:n}){return[D.createManipulatorDragEventPipeline(e,((e,a,r)=>{if(!g.isValidComputation(t)||!e.selected)return;const{geometry:i,dimension:o}=t,s=S.hideManipulatorWhileDragging(e);a.next(s).next(W(n,o,i.dimensionSegment,i.primaryOffsetAxis)),r.next(s).next(D.resetProperties(o,["offset"]))}))]}function U(e,{computation:t,view:n}){return[D.createManipulatorDragEventPipeline(e,((e,a,r)=>{z({cancel:r,computation:t,settingHeading:!0,steps:a,view:n})}))]}function G(e,{computation:t,view:n}){return[D.createManipulatorDragEventPipeline(e,((e,a,r)=>{z({cancel:r,computation:t,settingHeading:!1,steps:a,view:n})})),e.events.on("immediate-click",(e=>{A(e,t,n)}))]}function A(e,t,n){const{dimension:a,geometry:i}=t;if(90===a.orientation||270===a.orientation)return a.orientation=0,void e.stopPropagation();if(o.isNone(i))return;const{renderCoordsHelper:s}=n,c=g.computeGeometryFromDimension({...g.computationToGeometryDependencies(t),orientation:90},s),l=g.computeGeometryFromDimension({...g.computationToGeometryDependencies(t),orientation:270},s);if(o.isNone(c)||o.isNone(l))return;const u=g.headingFromGeometry(c,s),d=g.headingFromGeometry(l,s),p=I(i,n),m=r.cyclicalDegrees.shortestSignedDiff(p,u),f=r.cyclicalDegrees.shortestSignedDiff(p,d);a.orientation=Math.abs(m)<Math.abs(f)?90:270,e.stopPropagation()}function z(e){const{cancel:t,computation:n,settingHeading:a,steps:r,view:s}=e;if(!g.isValidComputation(n))return;const{renderCoordsHelper:c}=s,{dimension:l,geometry:f}=n,M=d.create(),h=Q(d.create(),f,f.directSegment,c),v=X(m.sv3d.get(),{forHeading:a,geometry:f,renderCoordsHelper:c}),T=p.fromPositionAndNormal(h,v,p.create()),P=a?o.unwrapOr(l.orientation,(()=>g.headingFromGeometry(f,s.renderCoordsHelper))):o.unwrapOr(l.orientation,0);r.next(S.screenToRenderPlane(s,T)).next((e=>{"start"===e.action&&u.copy(M,e.renderStart);const t=p.normal(T),n=y.calculateInputRotationTransform(M,e.renderEnd,h,t);let r=P-i.rad2deg(n);a||(r=N(r)),l.orientation=r})),t.next(D.resetProperties(l,["orientation"]))}function N(e){const t=r.cyclicalDegrees.normalize(e)%90;return t<M.settings.orientationSnapThresholdDegrees?e-t:90-t<M.settings.orientationSnapThresholdDegrees?e+(90-t):e}function V(e,{computation:t,manipulatorMeasureType:n,view:r}){let i=a.LengthDimensionMeasureType.Direct,o=0,s=0;return[e.events.on("grab-changed",(a=>{if("start"!==a.action||!g.isValidComputation(t))return;const{dimension:c,geometry:l}=t;i=c.measureType,o=c.offset,s=c.orientation;const d=u.copy(m.sv3d.get(),e.renderLocation);c.measureType=n,c.offset=g.computeOffsetForPoint(d,n,l,r.renderCoordsHelper),c.orientation=0})),D.createManipulatorDragEventPipeline(e,((e,a,c)=>{if(!g.isValidComputation(t))return;const{geometry:l,dimension:u}=t,{renderCoordsHelper:d}=r,p=g.computeSegmentForMeasureType(se,n,t,d),f=g.computeOffsetAxis(m.sv3d.get(),{measureType:n,directSegment:l.directSegment,renderCoordsHelper:d}),M=S.hideManipulatorWhileDragging(e);a.next(M).next(W(r,u,p,f)),c.next(M).next((e=>(u.measureType=i,u.offset=o,u.orientation=s,e)))}))]}function W(e,t,n,a){const r=u.subtract(m.sv3d.get(),n.endRenderSpace,n.startRenderSpace);u.cross(r,r,a);const i=p.fromPositionAndNormal(n.startRenderSpace,r,p.create()),o=p.fromPositionAndNormal(n.startRenderSpace,a,p.create()),s=t.offset;let c,l=0;const d=new D.EventPipeline;return d.next(S.screenToRenderPlane(e,i)).next((n=>{"start"===n.action&&(l=p.signedDistance(o,n.renderStart));const a=(p.signedDistance(o,n.renderEnd)-l)*e.renderCoordsHelper.unitInMeters;t.offset=s+a,c=n})),e=>(d.execute(e),c)}function I(e,t){const{directSegment:n}=e,{renderCoordsHelper:a}=t,r=g.directUp(m.sv3d.get(),e,a),i=g.directStartToEnd(m.sv3d.get(),e),o=u.cross(m.sv3d.get(),i,r),{viewForward:s}=t.state.camera;u.dot(o,s)>0&&u.scale(o,o,-1);const c=n.eval(.5,m.sv3d.get());return a.headingAtPosition(c,o)}function _(e,t,n){const{dimensionSegment:a,primaryOffsetAxis:r}=t,i=g.dimensionStartToEnd(re,t),o=u.exactEquals(i,d.ZEROS)?c.identity(oe):y.calculateTranslateRotateFromBases(i,r,d.ZEROS,oe),s=Math.max(u.length(i),M.settings.offsetManipulator.minLengthMeters/n.unitInMeters);c.scale(o,o,u.set(re,s,s,s)),e.modelTransform=o,e.renderLocation=a.eval(.5,re)}function Z(e,t,n){B(e,t,n,{forHeading:!0})}function j(e,t,n){B(e,t,n,{forHeading:!1})}function B(e,t,n,{forHeading:a}){const{dimension:r,geometry:i}=t,{primaryOffsetAxis:o}=i,s=u.scale(q,o,r.offset>=0?1:-1),c=X(K,{forHeading:a,geometry:i,renderCoordsHelper:n});u.cross(c,c,s);const l=y.calculateTranslateRotateFromBases(s,c,d.ZEROS,oe);e.modelTransform=l,e.renderLocation=Q(re,i,i.dimensionSegment,n)}const q=d.create(),K=d.create();function J(e,t,n,a){const{geometry:r}=t,i=g.computeSegmentForMeasureType(se,n,t,a),o=g.computeOffsetAxis(re,{measureType:n,directSegment:r.directSegment,renderCoordsHelper:a}),s=u.sub(ie,i.endRenderSpace,i.startRenderSpace),l=y.calculateTranslateRotateFromBases(s,o,d.ZEROS,oe),p=u.length(s);c.scale(l,l,u.set(ie,p,p,p)),e.modelTransform=l,e.renderLocation=i.eval(.5,ie)}function Q(e,t,n,a){const{startRenderSpace:r,endRenderSpace:i}=n,o=Y(t,a)?r:i;return u.copy(e,o)}function X(e,{forHeading:t,geometry:n,renderCoordsHelper:a}){return t?g.directUp(e,n,a):g.dimensionStartToEnd(e,n,{invert:!0})}function Y(e,t){const n=g.directStartToEnd($,e),a=g.directUp(ee,e,t);return u.dot(n,a)>0}const $=d.create(),ee=d.create();function te(e){return s.pt2px(e)+M.settings.offsetManipulator.linePaddingPx}function ne(e){return s.pt2px(e)+M.settings.offsetManipulator.focusedLinePaddingPx}const ae=x.ManipulatorStateCustomFlags.Custom1,re=d.create(),ie=d.create(),oe=l.create(),se=new v.EuclideanSegment;e.DidPointerMoveRecentlyFlag=ae,e.LengthDimensionManipulators=F,e.automaticHeadingFromCamera=I,e.createMeasureTypeManipulator=b,e.createOffsetManipulator=E,e.createOrientationManipulator=w,e.createPointManipulator=O,e.focusedOffsetWidth=ne,e.headingManipulatorHandles=U,e.measureTypeManipulatorHandles=V,e.offsetManipulatorHandles=L,e.pointManipulatorHandles=k,e.rotationManipulatorHandles=G,e.snapOrientationToNearestRightAngle=N,e.unfocusedOffsetWidth=te,e.updateHeadingManipulatorTransform=Z,e.updateMeasureTypeManipulatorTransform=J,e.updateOffsetManipulatorTransform=_,e.updateOrientationManipulator=C,e.updateRotationManipulatorTransform=j,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
