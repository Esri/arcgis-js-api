/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../analysis/SlicePlane","../../../../core/Accessor","../../../../core/Handles","../../../../core/Logger","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/boundedPlane","../../../../layers/Layer","../../../../layers/buildingSublayers/BuildingComponentSublayer","./sliceToolUtils","../support/projectionUtils","../../terrain/isTerrainSurfaceLayer"],(function(e,i,a,t,l,s,n,r,o,c,h,u,d,y,p,w,S,v,_){"use strict";const f="esri.views.3d.analysis.Slice.SliceController",g=n.getLogger(f);e.SliceController=function(e){function a(i){var a;return(a=e.call(this,i)||this)._handles=new s,a._internalChange=!1,a._currentSlicePlane=null,a}i._inheritsLoose(a,e);var l=a.prototype;return l.initialize=function(){this._handles.add(this.analysis.excludedLayers.on("before-add",(e=>{const i=e.item;null!=i&&(i instanceof p||i instanceof w)?i instanceof p&&_.isTerrainSurfaceLayer(i)?(g.error("excludedLayers",`Layer '${i.title}, id:${i.id}' of type '${i.type}' can not be individually excluded from slicing. Use 'excludeGroundSurface' instead.`),e.preventDefault()):this.analysis.excludedLayers.includes(i)&&e.preventDefault():(g.error("excludedLayers","Invalid layer type, layer must derive from Layer or BuildingComponentSublayer"),e.preventDefault())}))),P(this.view,this),this._handles.add([o.watch((()=>this.analysisViewData.plane),(()=>{this._internalChange||this._updateSlicePlaneFromBoundedPlane(),this._updateLayerViews()}),{sync:!0}),o.watch((()=>this.analysis.excludeGroundSurface),(()=>this._updateLayerViews()),{sync:!0}),this.analysis.excludedLayers.on("change",(()=>this._updateLayerViews())),o.watch((()=>[this.analysisViewData.active,this.analysisViewData.visible]),(()=>{this._updateActiveController(),this._updateViewSlicePlane()}),{sync:!0}),o.watch((()=>this._allLayerAndSubLayerViews),(()=>this._updateLayerViews()))]),this._handles.add([o.watch((()=>this.analysis.shape),(()=>{this._internalChange||(this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane())}),{sync:!0})],"analysis"),this._updateActiveController(),this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane()},l.destroy=function(){this.analysisViewData.active&&(this.analysisViewData.active=!1,this.view.slicePlane=null),L(this.view,this),this._handles.destroy(),this.set("view",null)},l._updateBoundedPlaneFromSlicePlane=function(){const e=this.analysis.shape,i=this._currentSlicePlane;if(r.isNone(i)&&r.isNone(e)||r.isSome(i)&&r.isSome(e)&&e.equals(i))return;let a=null,t=null;if(r.isSome(e)&&r.isSome(e.position)){const i=e.position.spatialReference,l=S.projectAndElevationAlignShape(e,this.view);r.isNone(l)&&v.logFailedGeometryProjectionError(this.analysis,i,g),a=S.projectedShapeToPlane(l,this.view,{tiltEnabled:this.analysis.tiltEnabled},y.create()),r.isSome(a)&&(t={heading:e.heading,tilt:e.tilt,position:e.position,width:e.width,height:e.height})}this._currentSlicePlane=t,this._internalChange=!0,this.analysisViewData.plane=a,this._internalChange=!1},l._updateSlicePlaneFromBoundedPlane=function(){const e=this.analysisViewData.plane,i=S.planeToShape(e,this.view,this.view.spatialReference,new t);let a=null;r.isSome(i)&&(a={heading:i.heading,tilt:i.tilt,position:i.position,width:i.width,height:i.height}),this._currentSlicePlane=a,this._internalChange=!0,this.analysis.shape=i,this._internalChange=!1,this._updateViewSlicePlane()},l._updateActiveController=function(){if(b)return;const e=m(this.view);if(!e)return;if(this.analysisViewData.active)r.isSome(e.activeController)&&e.activeController!==this?(b=!0,e.activeController.analysisViewData.active=!1,b=!1):r.isSome(e.activeController)&&e.activeController,this._updateLayerViews(),e.activeController=this;else{if(r.isSome(e.activeController)&&e.activeController!==this)return;r.isSome(e.activeController)&&e.activeController===this&&(e.activeController=null,this._updateLayerViews())}},l._updateViewSlicePlane=function(){C(this.view)},l._updateLayerViews=function(){const e=r.isSome(this.analysisViewData.plane)&&this.analysisViewData.visible&&this.analysisViewData.active,i=[],a=e=>{"layers"in e?e.layers.forEach(a):i.push(e)};this.analysis.excludedLayers.forEach(a),this.view.allLayerViews.forEach((a=>{a.destroyed||("slicePlaneEnabled"in a&&(a.slicePlaneEnabled=e&&!i.includes(a.layer)),"sublayerViews"in a&&a.sublayerViews.forEach((a=>{a.slicePlaneEnabled=e&&!i.includes(a.sublayer)})))})),null!=this.view.basemapTerrain&&(this.view.basemapTerrain.slicePlaneEnabled=e&&!this.analysis.excludeGroundSurface)},i._createClass(a,[{key:"_allLayerAndSubLayerViews",get:function(){const e=this.view.allLayerViews.items;return e.concat(e.filter(S.isIBuildingSceneLayerView3D).flatMap((({sublayerViews:e})=>e.items)))}}]),a}(l),a.__decorate([c.property()],e.SliceController.prototype,"view",void 0),a.__decorate([c.property()],e.SliceController.prototype,"analysis",void 0),a.__decorate([c.property()],e.SliceController.prototype,"analysisViewData",void 0),a.__decorate([c.property()],e.SliceController.prototype,"_allLayerAndSubLayerViews",null),e.SliceController=a.__decorate([d.subclass(f)],e.SliceController);const V=new Map;let b=!1;function C(e){const i=m(e)?.activeController;r.isSome(i)&&r.isSome(i.analysisViewData.plane)&&i.analysisViewData.visible?e.slicePlane=i.analysisViewData.plane:e.slicePlane=null}function P(e,i){V.has(e)||V.set(e,{all:[],activeController:null}),V.get(e)?.all.push(i)}function m(e){return V.get(e)}function L(e,i){if(!V.has(e))throw new Error("view expected in global slice register");const a=V.get(e),t=a?.all.lastIndexOf(i)??-1;if(!a||-1===t)throw new Error("controller expected in global slice register");a.all.splice(t,1),0===a.all.length&&V.delete(e)}Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
