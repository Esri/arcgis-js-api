/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../analysis/SlicePlane","../../../../core/Accessor","../../../../core/Handles","../../../../core/Logger","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/watchUtils","../../../../core/accessorSupport/decorators/property","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/boundedPlane","../../../../layers/Layer","../../../../layers/buildingSublayers/BuildingComponentSublayer","../support/projectionUtils","../../interactive/analysisTools/slice/sliceToolUtils"],(function(e,i,t,a,s,l,n,r,o,c,d,h,u,y,p,w,v,_,S,f){"use strict";const g=n.getLogger("esri.views.3d.analysis.Slice.SliceController");e.SliceController=function(e){function t(i){var t;return(t=e.call(this,i)||this)._handles=new l,t._internalChange=!1,t._currentSlicePlane=null,t.state="ready",t}i._inheritsLoose(t,e);var s=t.prototype;return s.initialize=function(){this._handles.add(this.analysis.excludedLayers.on("before-add",(e=>{const i=e.item;null!=i&&(i instanceof v||i instanceof _)?i instanceof v&&f.isAlwaysDrapedLayer(i)?(g.error("excludedLayers",`Layer '${i.title}, id:${i.id}' of type '${i.type}' can not be individually excluded from slicing. Use 'excludeGroundSurface' instead.`),e.preventDefault()):this.analysis.excludedLayers.includes(i)&&e.preventDefault():(g.error("excludedLayers","Invalid layer type, layer must derive from Layer or BuildingComponentSublayer"),e.preventDefault())}))),P(this.view,this),this._handles.add([o.watch((()=>this.analysisViewData.plane),(()=>{this._internalChange||this._updateSlicePlaneFromBoundedPlane(),this._updateLayerViews()}),{sync:!0}),o.watch((()=>this.analysis.excludeGroundSurface),(()=>this._updateLayerViews()),{sync:!0}),this.analysis.excludedLayers.on("change",(()=>this._updateLayerViews())),o.watch((()=>[this.analysisViewData.active,this.analysisViewData.visible]),(()=>{this._updateActiveController(),this._updateViewSlicePlane()}),{sync:!0}),o.watch((()=>this._allLayerAndSubLayerViews),(()=>this._updateLayerViews()))]),this._handles.add([o.watch((()=>this.analysis.shape),(()=>{this._internalChange||(this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane())}),{sync:!0})],"analysis"),this._set("state","ready"),this._updateActiveController(),this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane()},s.destroy=function(){"destroyed"!==this.state&&(this.analysisViewData.active&&(this.analysisViewData.active=!1,this.view.slicePlane=null),L(this.view,this),this._handles.destroy(),this.set("view",null),this._set("state","destroyed"))},s.whenReady=function(){var e=i._asyncToGenerator((function*(){return yield c.whenOnce(this,"ready"),this}));function t(){return e.apply(this,arguments)}return t}(),s._updateBoundedPlaneFromSlicePlane=function(){const e=this.analysis.shape,i=this._currentSlicePlane;if(r.isNone(i)&&r.isNone(e)||r.isSome(i)&&r.isSome(e)&&e.equals(i))return;let t=null,a=null;if(r.isSome(e)&&r.isSome(e.position)){const i=e.position.spatialReference,s=f.projectAndElevationAlignShape(e,this.view);r.isNone(s)&&S.logFailedGeometryProjectionError(this.analysis,i,g),t=f.projectedShapeToPlane(s,this.view,{tiltEnabled:this.analysis.tiltEnabled},w.create()),r.isSome(t)&&(a={heading:e.heading,tilt:e.tilt,position:e.position,width:e.width,height:e.height})}this._currentSlicePlane=a,this._internalChange=!0,this.analysisViewData.plane=t,this._internalChange=!1},s._updateSlicePlaneFromBoundedPlane=function(){const e=this.analysisViewData.plane,i=f.planeToShape(e,this.view,this.view.spatialReference,new a);let t=null;r.isSome(i)&&(t={heading:i.heading,tilt:i.tilt,position:i.position,width:i.width,height:i.height}),this._currentSlicePlane=t,this._internalChange=!0,this.analysis.shape=i,this._internalChange=!1,this._updateViewSlicePlane()},s._updateActiveController=function(){if(V)return;const e=m(this.view);if(this.analysisViewData.active)r.isSome(e.activeController)&&e.activeController!==this?(V=!0,e.activeController.analysisViewData.active=!1,V=!1):r.isSome(e.activeController)&&e.activeController,this._updateLayerViews(),e.activeController=this;else{if(r.isSome(e.activeController)&&e.activeController!==this)return;r.isSome(e.activeController)&&e.activeController===this&&(e.activeController=null,this._updateLayerViews())}},s._updateViewSlicePlane=function(){"ready"===this.state&&b(this.view)},s._updateLayerViews=function(){const e=r.isSome(this.analysisViewData.plane)&&this.analysisViewData.visible&&this.analysisViewData.active,i=[],t=e=>{"layers"in e?e.layers.forEach(t):i.push(e)};this.analysis.excludedLayers.forEach(t),this.view.allLayerViews.forEach((t=>{t.destroyed||("slicePlaneEnabled"in t&&(t.slicePlaneEnabled=e&&i.indexOf(t.layer)<0),"sublayerViews"in t&&t.sublayerViews.forEach((t=>{t.slicePlaneEnabled=e&&i.indexOf(t.sublayer)<0})))})),null!=this.view.basemapTerrain&&(this.view.basemapTerrain.slicePlaneEnabled=e&&!this.analysis.excludeGroundSurface)},i._createClass(t,[{key:"ready",get:function(){return"ready"===this.state}},{key:"_allLayerAndSubLayerViews",get:function(){const e=this.view.allLayerViews.items;return e.concat(e.filter(f.isIBuildingSceneLayerView3D).flatMap((({sublayerViews:e})=>e.items)))}}]),t}(s),t.__decorate([d.property({readOnly:!0})],e.SliceController.prototype,"state",void 0),t.__decorate([d.property()],e.SliceController.prototype,"view",void 0),t.__decorate([d.property()],e.SliceController.prototype,"analysis",void 0),t.__decorate([d.property()],e.SliceController.prototype,"analysisViewData",void 0),t.__decorate([d.property()],e.SliceController.prototype,"ready",null),t.__decorate([d.property()],e.SliceController.prototype,"_allLayerAndSubLayerViews",null),e.SliceController=t.__decorate([p.subclass("esri.views.3d.analysis.Slice.SliceController")],e.SliceController);const C=new Map;let V=!1;function b(e){const i=m(e).activeController;r.isSome(i)&&r.isSome(i.analysisViewData.plane)&&i.analysisViewData.visible?e.slicePlane=i.analysisViewData.plane:e.slicePlane=null}function P(e,i){C.has(e)||C.set(e,{all:[],activeController:null}),C.get(e).all.push(i)}function m(e){return C.get(e)}function L(e,i){if(!C.has(e))throw new Error("view expected in global slice register");const t=C.get(e),a=t.all.lastIndexOf(i);if(-1===a)throw new Error("controller expected in global slice register");t.all.splice(a,1),0===t.all.length&&C.delete(e)}Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
