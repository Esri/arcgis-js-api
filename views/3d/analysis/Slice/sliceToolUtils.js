/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../geometry","../../../../analysis/SlicePlane","../../../../core/has","../../../../core/Logger","../../../../core/mathUtils","../../../../core/maybe","../../../../core/screenUtils","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/quat","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/projection","../../../../geometry/support/Axis","../../../../chunks/boundedPlane","../../../../geometry/support/plane","../../../../geometry/support/ray","../../../../geometry/support/vector","../../../../geometry/support/vectorStacks","./sliceToolConfig","../support/projectionUtils","../../interactive/Manipulator3D","../../interactive/manipulatorUtils","../../interactive/RenderObject","../../interactive/visualElements/LineVisualElement","../../interactive/visualElements/SlicePlaneVisualElement","../../support/RenderCoordsHelper","../../support/geometryUtils/ray","../../webgl-engine/lib/basicInterfaces","../../webgl-engine/lib/GeometryUtil","../../webgl-engine/lib/Material","../../webgl-engine/materials/ColorMaterial","../../webgl-engine/materials/NativeLineMaterial","../../webgl-engine/materials/RibbonLineMaterial","../../../interactive/interfaces","../../../../geometry/Extent"],(function(e,t,n,i,a,o,r,s,c,l,d,u,T,R,g,E,p,_,O,S,m,A,I,b,f,L,h,N,v,P,F,C,H,M,y,w,D){"use strict";function U(e,t,n,i,a,o,r,s){return V(t,r.worldUpAtPosition(e,S.sv3d.get()),a,o,s.basis1,s.basis2),u.scale(s.basis1,s.basis1,n),u.scale(s.basis2,s.basis2,i),u.copy(s.origin,e),p.fromVectorsAndPoint(s.basis2,s.basis1,s.origin,s.plane),s}function V(t,n,i,a,o,r){const s=u.dot(t,n),c=S.sv3d.get(),l=S.sv3d.get();switch(a===e.SliceOrientation.HORIZONTAL_OR_VERTICAL?Math.abs(s)>m.VERTICAL_DOT_THRESHOLD?e.SliceOrientation.HORIZONTAL:e.SliceOrientation.VERTICAL:a){case e.SliceOrientation.VERTICAL:{const e=Math.abs(s)<=m.SMALL_ANGLE_DOT_THRESHOLD?t:i.viewUp;u.cross(c,e,n),u.copy(l,n);break}case e.SliceOrientation.HORIZONTAL:u.cross(c,i.viewUp,n),u.cross(l,n,c);break;case e.SliceOrientation.TILTED:{const e=Math.abs(s)<=m.SMALL_ANGLE_DOT_THRESHOLD?n:i.viewUp;u.cross(c,e,t),u.cross(l,t,c);break}}const d=u.cross(S.sv3d.get(),c,l);u.dot(d,i.viewForward)>0&&u.scale(l,l,-1),u.normalize(o,c),u.normalize(r,l)}function G(e,t,n){const i=t.worldUpAtPosition(e.origin,S.sv3d.get()),a=e.basis1,o=Te(e,i),r=Math.round(o/Ie)*Ie;return E.rotate(e,r-o,a,n)}function j(e,t,n,i,a,o){const r=u.copy(S.sv3d.get(),a.origin);u.add(r,r,u.scale(S.sv3d.get(),a.basis1,e.direction[0]<0?1:-1)),u.add(r,r,u.scale(S.sv3d.get(),a.basis2,e.direction[1]<0?1:-1));const s=u.length(a.basis1),c=u.length(a.basis2),l=u.subtract(S.sv3d.get(),n,r),d=u.subtract(S.sv3d.get(),t,r);let T=0,R=0;if(te(e)){const t=ee(a),n=ee(o);T=s-.5*e.direction[0]*u.dot(a.basis1,d)/s,R=c-.5*e.direction[1]*u.dot(a.basis2,d)/c;const i=n/t;T*=i,R*=i}const g=T+.5*e.direction[0]*u.dot(a.basis1,l)/s,p=R+.5*e.direction[1]*u.dot(a.basis2,l)/c,_=u.scale(S.sv3d.get(),a.basis1,g/s),O=u.scale(S.sv3d.get(),a.basis2,p/c);(g<=0||$(o.origin,_,i)<=m.PLANE_MIN_BASIS_SCREEN_LEN2)&&u.copy(_,o.basis1),(p<=0||$(o.origin,O,i)<=m.PLANE_MIN_BASIS_SCREEN_LEN2)&&u.copy(O,o.basis2);const A=u.copy(S.sv3d.get(),r);return u.add(A,A,u.scale(S.sv3d.get(),_,e.direction[0]<0?-1:1)),u.add(A,A,u.scale(S.sv3d.get(),O,e.direction[1]<0?-1:1)),E.fromValues(A,_,O,o)}function x(e,t){return m.INITIAL_PLANE_HALF_SIZE_VIEW_PROPORTION*Math.min(t.width,t.height)*t.computeRenderPixelSizeAt(e)}function z(e,t,n,i){const a=u.cross(S.sv3d.get(),t,n);return u.cross(a,a,t),p.fromPositionAndNormal(e,a,i)}function Z(e,t){return b.calculateTranslateRotateFromBases(e.basis1,e.basis2,e.origin,t)}function W(t,n,i,a){const o=n.worldUpAtPosition(t.origin,S.sv3d.get()),r=S.sv3d.get();switch(i){case e.RotationAxis.HEADING:u.copy(r,o);break;case e.RotationAxis.TILT:u.copy(r,t.basis1)}return p.fromPositionAndNormal(t.origin,r,a)}function k(e,t,n,i){const a=K(n,Q.NEGATIVE_X),o=S.sm4d.get();c.rotateZ(o,t,a.edge*Math.PI/2);const r=u.normalize(S.sv3d.get(),a.basis);let l=u.scale(S.sv3d.get(),r,a.direction*i.computeScreenPixelSizeAt(a.position)*m.SHIFT_RESTART_OFFSET_DISTANCE);u.add(l,l,a.position);const d=i.projectToRenderScreen(l,s.castRenderScreenPointArray3(S.sv3d.get())),R=B(i,d);v.fromRender(i,d,Ae),u.normalize(Ae.direction,Ae.direction);const g=S.sv3d.get();!R&&E.intersectRay(n,Ae,g)&&(l=g),o[12]=0,o[13]=0,o[14]=0,e.modelTransform=o,e.renderLocation=T.clone(l),R?e.state|=me:e.state&=~me}function B(e,t){const[n,i,a,o]=e.viewport,r=Math.min(a,o)/16;let s=!0;return t[0]<n+r?(t[0]=n+r,s=!1):t[0]>n+a-r&&(t[0]=n+a-r,s=!1),t[1]<i+r?(t[1]=i+r,s=!1):t[1]>i+o-r&&(t[1]=i+o-r,s=!1),s}function X(e,t,n,i){const a=u.length(i.basis1),o=u.length(i.basis2),r=J(i),s=ee(i),l=u.set(S.sv3d.get(),0,0,0);u.add(l,u.scale(S.sv3d.get(),i.basis1,t.direction[0]),u.scale(S.sv3d.get(),i.basis2,t.direction[1])),u.add(l,i.origin,l);let d=0,T=1;if(te(t))1===t.direction[0]&&-1===t.direction[1]?d=Ie:1===t.direction[0]&&1===t.direction[1]?d=Math.PI:-1===t.direction[0]&&1===t.direction[1]&&(d=3*Math.PI/2),T=s;else{const e=0!==t.direction[0]?1:2;d=1===e?Ie:0,T=(1===e?o:a)-r}const R=c.fromZRotation(S.sm4d.get(),d);c.scale(R,R,u.set(S.sv3d.get(),T,T,T)),c.multiply(R,n,R),R[12]=0,R[13]=0,R[14]=0,e.modelTransform=R,e.renderLocation=l}function Y(e,t,n,i){const a=i.worldUpAtPosition(n.origin,S.sv3d.get()),o=K(n,Q.POSITIVE_X),r=c.fromZRotation(S.sm4d.get(),o.edge*Math.PI/2);c.rotateX(r,r,-Te(n,a)),c.multiply(r,t,r),r[12]=0,r[13]=0,r[14]=0,e.modelTransform=r,e.renderLocation=o.position}function q(e,t,n){const i=K(n,Q.POSITIVE_Y),a=c.fromZRotation(S.sm4d.get(),i.edge*Math.PI/2);c.rotateX(a,a,Ie),c.multiply(a,t,a),a[12]=0,a[13]=0,a[14]=0,e.modelTransform=a,e.renderLocation=i.position}var Q;function K(e,t){switch(t){case Q.POSITIVE_X:return{basis:e.basis1,direction:1,position:u.add(S.sv3d.get(),e.origin,e.basis1),edge:t};case Q.POSITIVE_Y:return{basis:e.basis2,direction:1,position:u.add(S.sv3d.get(),e.origin,e.basis2),edge:t};case Q.NEGATIVE_X:return{basis:e.basis1,direction:-1,position:u.subtract(S.sv3d.get(),e.origin,e.basis1),edge:t};case Q.NEGATIVE_Y:return{basis:e.basis2,direction:-1,position:u.subtract(S.sv3d.get(),e.origin,e.basis2),edge:t}}}function $(e,t,n){const i=n.projectToRenderScreen(u.add(S.sv3d.get(),e,t),s.castRenderScreenPointArray3(S.sv3d.get())),a=n.projectToRenderScreen(u.subtract(S.sv3d.get(),e,t),s.castRenderScreenPointArray3(S.sv3d.get()));return u.squaredLength(u.subtract(i,i,a))}function J(e){const t=u.length(e.basis1),n=u.length(e.basis2);return m.RESIZE_HANDLE_EDGE_PADDING_FRAC*Math.min(t,n)}function ee(e){return J(e)}function te(e){return 0!==e.direction[0]&&0!==e.direction[1]}function ne(t,n=e.OffsetMode.CENTER_ON_ARROW){const i=n===e.OffsetMode.CENTER_ON_CALLOUT?m.SHIFT_RESTART_OFFSET_DISTANCE:0,a=[T.fromValues(i,0,-m.SHIFT_RESTART_ARROW_LENGTH/2),T.fromValues(i,0,m.SHIFT_RESTART_ARROW_LENGTH/2)],o=le(a,!0),r=(e,t)=>se(a,e,t),s=r(0,!1),c=r(m.SHIFT_RESTART_ARROW_OUTLINE_WIDTH,!0),l=new M.NativeLineMaterial({color:m.SHIFT_RESTART_CALLOUT_COLOR,renderOccluded:C.RenderOccludedFlag.OccludeAndTransparent}),d=F.createPolylineGeometry(l,[[i,0,0],[i-m.SHIFT_RESTART_OFFSET_DISTANCE,0,0]]),u=F.createPolylineGeometry(l,[[i,0,0],[i-m.SHIFT_RESTART_OFFSET_DISTANCE,0,0]]);return new I.Manipulator3D({view:t,renderObjects:[...s.normal.map((e=>new f.RenderObject(e,w.ManipulatorStateFlags.Unfocused|_e))),...c.normal.map((e=>new f.RenderObject(e,w.ManipulatorStateFlags.Unfocused|_e))),new f.RenderObject(d,w.ManipulatorStateFlags.Unfocused|_e|me),...s.focused.map((e=>new f.RenderObject(e,w.ManipulatorStateFlags.Focused|_e))),...c.focused.map((e=>new f.RenderObject(e,w.ManipulatorStateFlags.Focused|_e))),new f.RenderObject(u,w.ManipulatorStateFlags.Focused|_e|me)],autoScaleRenderObjects:!1,collisionType:{type:"line",paths:[o]},collisionPriority:1,radius:m.SHIFT_RESTART_TIP_RADIUS,state:_e})}function ie(e,t){const n=b.createRotateManipulator(e,{customStateMask:_e,texture:t});return n.state=_e,n}function ae(e){const t=[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0],[-1,-1,0]];return new L.LineVisualElement({view:e,attached:!1,color:m.PLANE_OUTLINE_COLOR,width:m.PLANE_OUTLINE_WIDTH,writeDepthEnabled:!1,renderOccluded:C.RenderOccludedFlag.OccludeAndTransparent,geometry:[t]})}function oe(e){return new h.SlicePlaneVisualElement({view:e,attached:!1,backgroundColor:[...m.PLANE_BACKGROUND_COLOR],gridColor:m.GRID_COLOR,gridWidth:4,renderOccluded:C.RenderOccludedFlag.OccludeAndTransparent})}function re(e,t){const n=te(t),i=n?[T.fromValues(1,0,0),T.fromValues(0,0,0),T.fromValues(0,1,0)]:[T.fromValues(1,0,0),T.fromValues(-1,0,0)],a=m.RESIZE_HANDLE_COLOR,o=e=>new y.RibbonLineMaterial({color:a,width:e,renderOccluded:C.RenderOccludedFlag.OccludeAndTransparent}),r=()=>new M.NativeLineMaterial({color:a,renderOccluded:C.RenderOccludedFlag.OccludeAndTransparent}),s=n?m.RESIZE_HANDLE_CORNER_WIDTH:m.RESIZE_HANDLE_EDGE_WIDTH,c=s*m.DISPLAY_FOCUS_MULTIPLIER,l=m.RESIZE_HANDLE_EDGE_WIDTH,d=e=>e>1?o(e):r(),u=[new f.RenderObject(F.createPolylineGeometry(d(s),i),w.ManipulatorStateFlags.Unfocused|be),new f.RenderObject(F.createPolylineGeometry(d(c),i),w.ManipulatorStateFlags.Focused|be),new f.RenderObject(F.createPolylineGeometry(d(l),i),fe)],R=new I.Manipulator3D({view:e,renderObjects:u,collisionType:{type:"line",paths:[i]},radius:n?m.RESIZE_HANDLE_CORNER_INPUT_RADIUS:m.RESIZE_HANDLE_EDGE_INPUT_RADIUS,...b.worldScaledManipulatorSettings});return R.state=be,R}function se(e,t,n){const i=new H.ColorMaterial({color:m.SHIFT_RESTART_ARROW_TIP_COLOR,cullFace:P.CullFaceOptions.Back,renderOccluded:C.RenderOccludedFlag.Opaque}),a=new H.ColorMaterial({color:m.SHIFT_RESTART_ARROW_CAP_COLOR,cullFace:P.CullFaceOptions.Back,renderOccluded:C.RenderOccludedFlag.Opaque}),o=new H.ColorMaterial({color:m.SHIFT_RESTART_TUBE_COLOR,cullFace:P.CullFaceOptions.Back,renderOccluded:C.RenderOccludedFlag.Opaque}),r=new H.ColorMaterial({color:m.SHIFT_RESTART_OUTLINE_COLOR,transparent:!0,writeDepth:!1,cullFace:P.CullFaceOptions.Front,renderOccluded:C.RenderOccludedFlag.Transparent}),s=s=>{e=e.slice(0);const R=u.subtract(S.sv3d.get(),e[0],e[1]);u.normalize(R,R);const g=u.subtract(S.sv3d.get(),e[e.length-1],e[e.length-2]);if(u.normalize(g,g),t>0){const n=u.scale(T.create(),g,-t);e[e.length-1]=u.add(n,n,e[e.length-1]);const i=u.scale(T.create(),R,-t);e[0]=u.add(i,i,e[0])}const E=s?m.SHIFT_RESTART_TIP_FOCUS_MULTIPLIER:1,p=m.SHIFT_RESTART_TIP_LENGTH*E,_=m.SHIFT_RESTART_TIP_RADIUS*E,O=c.identity(S.sm4d.get());if(t>0){const e=p/4,n=u.set(S.sv3d.get(),0,e,0),i=1+t/e;c.translate(O,O,n),c.scale(O,O,u.set(S.sv3d.get(),i,i,i)),c.translate(O,O,u.scale(n,n,-1/i))}const A=c.identity(l.create()),I=T.fromValues(0,1,0),b=c.fromQuat(l.create(),d.rotationTo(S.sq4d.get(),I,g));b[12]=e[e.length-1][0],b[13]=e[e.length-1][1],b[14]=e[e.length-1][2],c.multiply(b,b,O);const f=n?r:o,L=ce(m.SHIFT_RESTART_TUBE_RADIUS*(s?m.SHIFT_RESTART_TUBE_FOCUS_MULTIPLIER:1)+t,e,f);L.transformation=A;const h=[L],N=n?r:i,v=F.createConeGeometry(N,p,_,24,!1,!1,!0);v.transformation=b,h.push(v);const P=n?r:a,C=F.createConeGeometry(P,p,_,24,!1,!0,!1);C.transformation=b,h.push(C);const H=c.fromQuat(l.create(),d.rotationTo(S.sq4d.get(),I,R));return H[12]=e[0][0],H[13]=e[0][1],H[14]=e[0][2],c.multiply(H,H,O),h.push(v.instantiate({transformation:H})),h.push(C.instantiate({transformation:H})),h};return{normal:s(!1),focused:s(!0)}}function ce(e,t,n){const i=[],a=12;for(let o=0;o<a;o++){const t=o/a*2*Math.PI;i.push([Math.cos(t)*e,Math.sin(t)*e])}return F.createPathExtrusionGeometry(n,i,t,[],[],!1)}function le(e,t){const n=u.subtract(T.create(),e[e.length-1],e[e.length-2]);if(u.normalize(n,n),u.scale(n,n,m.SHIFT_RESTART_TIP_LENGTH),u.add(n,n,e[e.length-1]),t){const t=u.subtract(T.create(),e[0],e[1]);return u.normalize(t,t),u.scale(t,t,m.SHIFT_RESTART_TIP_LENGTH),u.add(t,t,e[0]),[t,...e,n]}return[...e,n]}function de(e,t,i,a=new n){if(r.isNone(e))return null;const{renderCoordsHelper:s}=t,c=s.fromRenderCoords(e.origin,t.spatialReference);if(r.isNone(c))return null;const l=R.tryProjectWithZConversion(c,i);if(r.isNone(l))return null;a.position=l;const d=2*u.length(e.basis1),T=2*u.length(e.basis2),g=N.RenderCoordsHelper.renderUnitScaleFactor(t.spatialReference,i);a.width=d*g,a.height=T*g;const E=s.worldUpAtPosition(e.origin,S.sv3d.get());return a.tilt=o.rad2deg(Te(e,E)),a.heading=s.headingAtPosition(e.origin,e.basis1)-90,a}function ue(e,t,n){if(r.isNone(e))return null;const i=e.origin,a=S.sv3d.get(),o=S.sv3d.get(),s=S.sv3d.get(),c=S.sv3d.get();let l,d,T,R,g,E;u.add(a,i,e.basis1),u.add(a,a,e.basis2),u.add(o,i,e.basis1),u.sub(o,o,e.basis2),u.sub(s,i,e.basis1),u.sub(s,s,e.basis2),u.sub(c,i,e.basis1),u.add(c,c,e.basis2);for(const u of[a,o,s,c]){const e=t.fromRenderCoords(u,u,n);if(r.isNone(e))return null;l=null==l?e[0]:Math.min(l,e[0]),d=null==d?e[0]:Math.max(d,e[0]),T=null==T?e[1]:Math.min(T,e[1]),R=null==R?e[1]:Math.max(R,e[1]),g=null==g?e[2]:Math.min(g,e[2]),E=null==E?e[2]:Math.max(E,e[2])}return new D({xmin:l,xmax:d,ymin:T,ymax:R,zmin:g,zmax:E,spatialReference:n})}function Te(e,t){return O.angleAroundAxis(t,e.basis2,e.basis1)+Ie}function Re(e,t,n,i,r,s,c=E.create()){return s.toRenderCoords(e,c.origin)?(s.worldBasisAtPosition(c.origin,g.Axis.X,c.basis1),s.worldBasisAtPosition(c.origin,g.Axis.Y,c.basis2),p.fromVectorsAndPoint(c.basis2,c.basis1,c.origin,c.plane),E.rotate(c,-o.deg2rad(t),E.normal(c),c),E.rotate(c,o.deg2rad(n),c.basis1,c),u.scale(c.basis1,c.basis1,i/2),u.scale(c.basis2,c.basis2,r/2),E.updateUnboundedPlane(c),c):(a.getLogger("esri.views.3d.analysis.Slice.sliceToolUtils").error(`Failed to project slice plane position, projection from ${e.spatialReference.wkid} is not supported`),null)}function ge(e,t){if(r.isNone(e)||r.isNone(e.position))return null;const n=A.applyProjectionAndElevationAlignment(e.position,t.spatialReference,t.elevationProvider);if(r.isNone(n))return null;const i=N.RenderCoordsHelper.renderUnitScaleFactor(e.position.spatialReference,t.spatialReference),a=e.width*i,o=e.height*i;return{position:n,heading:e.heading,tilt:e.tilt,renderWidth:a,renderHeight:o}}function Ee(e,t,n,i=E.create()){const a=ge(e,t);return r.isNone(a)?null:pe(a,t,n,i)}function pe(e,t,n,i=E.create()){if(r.isNone(e))return null;const a=Re(e.position,e.heading,e.tilt,e.renderWidth,e.renderHeight,t.renderCoordsHelper,i);return!n.tiltEnabled&&r.isSome(a)&&G(a,t.renderCoordsHelper,a),a}!function(e){e[e.POSITIVE_X=0]="POSITIVE_X",e[e.POSITIVE_Y=1]="POSITIVE_Y",e[e.NEGATIVE_X=2]="NEGATIVE_X",e[e.NEGATIVE_Y=3]="NEGATIVE_Y"}(Q||(Q={}));const _e=w.ManipulatorStateCustomFlags.Custom1;var Oe,Se;e.RotationAxis=void 0,(Oe=e.RotationAxis||(e.RotationAxis={}))[Oe.HEADING=1]="HEADING",Oe[Oe.TILT=2]="TILT",e.SliceOrientation=void 0,(Se=e.SliceOrientation||(e.SliceOrientation={}))[Se.HORIZONTAL_OR_VERTICAL=0]="HORIZONTAL_OR_VERTICAL",Se[Se.HORIZONTAL=1]="HORIZONTAL",Se[Se.VERTICAL=2]="VERTICAL",Se[Se.TILTED=3]="TILTED";const me=w.ManipulatorStateCustomFlags.Custom2,Ae=_.create(),Ie=Math.PI/2,be=w.ManipulatorStateCustomFlags.Custom1,fe=w.ManipulatorStateCustomFlags.Custom2;var Le;function he(e){const t="building-scene-3d"===e.type?e:null;return r.isSome(t)}e.OffsetMode=void 0,(Le=e.OffsetMode||(e.OffsetMode={}))[Le.CENTER_ON_CALLOUT=0]="CENTER_ON_CALLOUT",Le[Le.CENTER_ON_ARROW=1]="CENTER_ON_ARROW",e.DidPointerMoveRecentlyFlag=_e,e.IsShiftEdgeOnScreenFlag=me,e.addArrowTips=le,e.calculateBoundedPlaneTranslateRotate=Z,e.calculateDiagonalResizeHandleScale=ee,e.calculatePlaneHalfSize=x,e.calculateResizeHandlePadding=J,e.calculateScreenSpaceBasisLength2=$,e.createArrowGeometry=se,e.createGridVisualElement=oe,e.createOutlineVisualElement=ae,e.createPlane=U,e.createResizeManipulator=re,e.createRotateManipulator=ie,e.createRotatePlane=W,e.createShiftManipulator=ne,e.createShiftPlane=z,e.forceHorizontalOrVertical=G,e.isDiagonalResizeHandle=te,e.isIBuildingSceneLayerView3D=he,e.normalToBases=V,e.planeToExtent=ue,e.planeToShape=de,e.projectAndElevationAlignShape=ge,e.projectedShapeToPlane=pe,e.resizeNormal=be,e.resizeOutlineOnly=fe,e.resizePlane=j,e.shapeToPlane=Ee,e.updateResizeHandle=X,e.updateRotateHeadingHandle=Y,e.updateRotateTiltHandle=q,e.updateShiftRestartHandle=k,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
