/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import{destroyHandle as t}from"../../../../core/handleUtils.js";import{isSome as i,isNone as o}from"../../../../core/maybe.js";import{watch as s,syncAndInitial as n}from"../../../../core/reactiveUtils.js";import{property as r}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/arrayUtils.js";import"../../../../core/has.js";import"../../../../core/accessorSupport/ensureType.js";import{subclass as a}from"../../../../core/accessorSupport/decorators/subclass.js";import{sv3d as l}from"../../../../geometry/support/vectorStacks.js";import{LengthDimensionSubTool as c}from"./LengthDimensionSubTool.js";import{newIntersector as p}from"../../webgl-engine/lib/Intersector.js";import{StoreResults as m}from"../../webgl-engine/lib/IntersectorInterfaces.js";import{AnalysisToolBase as u}from"../../../interactive/AnalysisToolBase.js";import{createScreenPointArrayFromEvent as h}from"../../../support/screenUtils.js";var d;!function(e){e.Ready="ready",e.Creating="creating",e.Created="created"}(d||(d={}));let v=class extends u{constructor(e){super(e),this.preferManipulatorCursor=!0,this.analysisViewData=null}initialize(){this._intersector=p(this.view.state.viewingMode),this._intersector.options.store=m.MIN,this._lengthDimensionSubTool=new c({view:this.view}),this.own(t(this._lengthDimensionSubTool));for(const e of this.analysis.dimensions.items)this._addDimension(e);this.own(this.analysis.dimensions.on("change",(e=>{for(const t of e.added)this._addDimension(t);for(const t of e.removed)this._removeDimension(t)}))),this.own(s((()=>this.state),(e=>{e===d.Created&&this.finishToolCreation()}),n))}get state(){return this.analysis.dimensions.some((e=>"length"===e.type))?i(this._activeSubTool)?d.Creating:d.Created:d.Ready}get updating(){return this._lengthDimensionSubTool.updating}get cursor(){return this.active?"crosshair":null}getManipulatorsForDimension(e){return this._lengthDimensionSubTool.getManipulatorsForDimension(e)}onInputEvent(e){switch(e.type){case"immediate-click":this._clickHandler(e);break;case"immediate-double-click":this._doubleClickHandler(e);break;case"pointer-move":this._pointerMoveHandler(e)}}onActivate(){this._activeSubTool=this._lengthDimensionSubTool}onDeactivate(){i(this._activeSubTool)&&(this._activeSubTool.onDeactivate(),i(this._activeSubTool.stagedDimension)&&(this.analysis.dimensions.remove(this._activeSubTool.stagedDimension),this._activeSubTool.stagedDimension=null),this._activeSubTool=null)}_clickHandler(e){if(o(this._activeSubTool))return;const t=this._intersectScreen(e);if(!o(t)){if(o(this._activeSubTool.stagedDimension)){const i=this._activeSubTool.onUnstagedClick({mapPoint:t,pointerType:e.pointerType});this.analysis.dimensions.add(i)}else this._activeSubTool.onStagedClick({mapPoint:t,pointerType:e.pointerType});e.stopPropagation()}}_doubleClickHandler(e){this.view.activeTool=null,e.stopPropagation()}_pointerMoveHandler(e){if(o(this._activeSubTool))return;if(this.hasFocusedManipulators)return;const t=this._intersectScreen(e);o(t)||this._activeSubTool.onPointerMove({mapPoint:t,pointerType:e.pointerType})}_intersectScreen(e){const t=h(e);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(t,this._intersector);const i=this._intersector.results.min,o=l.get();return i.getIntersectionPoint(o)?this.view.renderCoordsHelper.fromRenderCoords(o,this.view.spatialReference):null}_addDimension(e){this._lengthDimensionSubTool.addDimension(e,this.manipulators)}_removeDimension(e){this._lengthDimensionSubTool.removeDimension(e,this.manipulators)}};e([r({constructOnly:!0})],v.prototype,"view",void 0),e([r({constructOnly:!0})],v.prototype,"analysis",void 0),e([r({readOnly:!0})],v.prototype,"state",null),e([r({readOnly:!0})],v.prototype,"updating",null),e([r({readOnly:!0})],v.prototype,"cursor",null),e([r({readOnly:!0})],v.prototype,"preferManipulatorCursor",void 0),e([r({constructOnly:!0})],v.prototype,"analysisViewData",void 0),e([r()],v.prototype,"_activeSubTool",void 0),e([r()],v.prototype,"_lengthDimensionSubTool",void 0),v=e([a("esri.views.3d.analysis.Dimensioning.DimensioningTool")],v);export{v as DimensioningTool};
