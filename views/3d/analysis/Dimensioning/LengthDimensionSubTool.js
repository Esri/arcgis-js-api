/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{_ as n}from"../../../../chunks/tslib.es6.js";import i from"../../../../Color.js";import"../../../../geometry.js";import t from"../../../../analysis/LengthDimension.js";import{HandleOwner as e}from"../../../../core/HandleOwner.js";import s from"../../../../core/Handles.js";import{isSome as a,applySome as o,destroyMaybe as r,isNone as p}from"../../../../core/maybe.js";import{ignoreAbortErrors as m}from"../../../../core/promiseUtils.js";import{watch as d,sync as g,syncAndInitial as l}from"../../../../core/reactiveUtils.js";import{property as c}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/arrayUtils.js";import"../../../../core/has.js";import"../../../../core/accessorSupport/ensureType.js";import{subclass as u}from"../../../../core/accessorSupport/decorators/subclass.js";import{clonePoint as h}from"../../../../layers/graphics/hydratedFeatures.js";import{settings as _}from"./settings.js";import{createSphereManipulator as v}from"../../interactive/manipulatorUtils.js";import{SnappingVisualizer3D as M}from"../../interactive/SnappingVisualizer3D.js";import{screenToMap3D as f,hideManipulatorWhileDragging as P}from"../../interactive/editingTools/dragEventPipeline3D.js";import{createCoordinateHelper as j}from"../../../interactive/coordinateHelper.js";import{createManipulatorDragEventPipeline as y,resetProperties as w}from"../../../interactive/dragEventPipeline.js";import{EditGeometry as D}from"../../../interactive/editGeometry/EditGeometry.js";import{EditGeometryOperations as S}from"../../../interactive/editGeometry/EditGeometryOperations.js";import{acquire as x}from"../../../interactive/snapping/SceneSnappingManagerPool.js";import{SnappingContext as H}from"../../../interactive/snapping/SnappingContext.js";import{SnappingPipeline as b}from"../../../interactive/snapping/SnappingDragPipelineStep.js";import{SnappingOperation as O}from"../../../interactive/snapping/SnappingOperation.js";import C from"../../../../geometry/Point.js";let T=class extends e{constructor(n){super(n),this.stagedDimension=null,this._dimensionManipulators=new Map,this._dimensionHandles=new s,this._snappingPipeline=new b,this._snappingManagerResult=x(n.view),this.own(this._snappingManagerResult)}initialize(){this._snappingOperation=new O({view:this.view}),this.own([this._dimensionHandles,d((()=>this._snappingOperation.stagedPoint),(n=>{a(this.stagedDimension)&&(this.stagedDimension.endPoint=o(n,(n=>h(n,new C))))}),g)])}destroy(){this._snappingOperation=r(this._snappingOperation)}get updating(){return this.updatingHandles.updating||this._snappingManager.updating}get _snappingManager(){return this._snappingManagerResult.snappingManager}addDimension(n,i){if(this._dimensionManipulators.has(n))return;const t=this._createPointManipulator(n,{isStart:!0}),e=this._createPointManipulator(n,{isStart:!1}),s={startManipulator:t,endManipulator:e};this._setupDimensionToManipulatorsSync(n,s),this._dimensionManipulators.set(n,s),i.add(t),i.add(e)}removeDimension(n,i){const t=this._dimensionManipulators.get(n);if(p(t))return;this._dimensionHandles.remove(n);const{startManipulator:e,endManipulator:s}=t;this._dimensionManipulators.delete(n),i.remove(e),i.remove(s)}getManipulatorsForDimension(n){return this._dimensionManipulators.get(n)}onDeactivate(){this._snappingManager.doneSnapping()}onUnstagedClick({mapPoint:n,pointerType:i}){const e=this._snappingContext(i),s=h(this._snappingManager.update(n,e),new C),a=new t({startPoint:s,endPoint:null});return this.stagedDimension=a,this._snappingManager.doneSnapping(),a}onStagedClick({mapPoint:n,pointerType:i}){if(p(this.stagedDimension))return;const t=this._snappingContext(i),e=h(this._snappingManager.update(n,t),new C);this.stagedDimension.endPoint=e,this.stagedDimension=null,this._snappingManager.doneSnapping()}onPointerMove({mapPoint:n,pointerType:i}){const t=this._snappingContext(i);this.updatingHandles.addPromise(m(this._snappingOperation.snap(n,this._snappingManager,t)))}_setupDimensionToManipulatorsSync(n,i){const{startManipulator:t,endManipulator:e}=i;this._dimensionHandles.add([d((()=>({startPoint:n.startPoint,endPoint:n.endPoint,stagedDimension:this.stagedDimension})),(({startPoint:i,endPoint:s,stagedDimension:o})=>{a(i)?(t.available=p(o)||o===n,t.location=i):t.available=!1,a(s)?(e.available=p(o),e.location=s):e.available=!1}),l)],n)}_createPointManipulator(n,t){const{isStart:e}=t,s=e?"startPoint":"endPoint",a=v(this.view,i.toUnitRGB(_.pointManipulators.color),_.pointManipulators.opacity);a.available=!1,a.radius=_.pointManipulators.radius;const o=y(a,((i,t,e,a)=>{const o=P(i);t.next(o).next(f(this.view)).next(this._snappingPipeline.createSnapDragEventPipelineStep({snappingContext:this._snappingContext(a),snappingManager:this._snappingManager,cancel:e,updatingHandles:this.updatingHandles}),this._snappingPipeline.next).next((i=>{const t=h(i.mapEnd,new C);n[s]=t})),e.next(o).next(w(n,[s]))}));return this._dimensionHandles.add(o,n),a}_snappingContext(n){return new H({elevationInfo:{mode:"absolute-height",offset:0},pointer:n,editGeometryOperations:new S(new D("point",j(!0,!1,this.view.spatialReference))),visualizer:new M})}};n([c({constructOnly:!0,nonNullable:!0})],T.prototype,"view",void 0),n([c({readOnly:!0})],T.prototype,"updating",null),n([c()],T.prototype,"stagedDimension",void 0),T=n([u("esri.views.3d.analysis.Dimensioning.LengthDimensionSubTool")],T);export{T as LengthDimensionSubTool};
