/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import t from"../../../../core/Accessor.js";import{destroyHandle as s}from"../../../../core/handleUtils.js";import{isNone as i}from"../../../../core/maybe.js";import{toUnit as n}from"../../../../core/quantityUtils.js";import{watch as r,initial as o}from"../../../../core/reactiveUtils.js";import{property as a}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/arrayUtils.js";import"../../../../core/has.js";import"../../../../core/accessorSupport/ensureType.js";import{subclass as m}from"../../../../core/accessorSupport/decorators/subclass.js";import{C as l,e as d,v as c,f as h,z as p,c as f,n as u}from"../../../../chunks/vec3.js";import{c as _,Z as S}from"../../../../chunks/vec3f64.js";import{f as g}from"../../../../chunks/vec4f64.js";import{Axis as b}from"../../../../geometry/support/Axis.js";import{sv3d as v}from"../../../../geometry/support/vectorStacks.js";import{formatNumber as y}from"../../../../intl/number.js";import{settings as V}from"./settings.js";import{LabelVisualElement as w}from"../../interactive/visualElements/LabelVisualElement.js";import{LineVisualElement as j}from"../../interactive/visualElements/LineVisualElement.js";import{EuclideanSegment as E}from"../../interactive/visualElements/support/Segment.js";import{RenderOccludedFlag as R}from"../../webgl-engine/lib/Material.js";import{createStipplePatternSimple as O}from"../../webgl-engine/materials/lineStippleUtils.js";let G=class extends t{constructor(e){super(e),this._directSegment=new E,this._dimensionSegment=new E,this._offsetAxis=_(),this._startOffsetSegment=new E(this._directSegment.startRenderSpace,this._dimensionSegment.startRenderSpace),this._endOffsetSegment=new E(this._directSegment.endRenderSpace,this._dimensionSegment.endRenderSpace),this._labelSegment=new E,this._hasValidGeometry=!1;const t={view:e.view,attached:!0,width:1,color:g(1,.5,0,1),renderOccluded:R.OccludeAndTransparent},s={...t,stipplePattern:O(5)};this._dimensionVisualElement=new j(t),this._startOffsetVisualElement=new j(s),this._endOffsetVisualElement=new j(s),this._label=new w({view:e.view,attached:!0,distance:0,fontSize:V.labels.fontSize})}initialize(){this.own([s(this._dimensionVisualElement),s(this._startOffsetVisualElement),s(this._endOffsetVisualElement),s(this._label)]);const{computation:e,view:t}=this,{dimension:i}=e;this.own([r((()=>({startPoint:i.startPoint,endPoint:i.endPoint,offset:i.offset,axis:i.axis,heading:i.heading})),(e=>{this._updateGeometry(e),this._updateLines(),this._updateLabelGeometry(t.state.camera)}),o),r((()=>e.length),(e=>this._updateLabelContent(e)),o),r((()=>t.state.camera),(e=>this._updateLabelGeometry(e)),o)])}get testInfo(){return{dimensionVisualElement:this._dimensionVisualElement,label:this._label}}_updateGeometry({startPoint:e,endPoint:t,offset:s,axis:n}){const{renderCoordsHelper:r}=this.view,o=this._directSegment;if(i(e)||i(t)||!r.toRenderCoords(e,o.startRenderSpace)||!r.toRenderCoords(t,o.endRenderSpace))return void(this._hasValidGeometry=!1);const{startRenderSpace:a,endRenderSpace:m}=o,d=o.eval(.5,v.get()),c=r.worldUpAtPosition(d,v.get()),h=r.worldBasisAtPosition(d,b.X,v.get()),p=this._offsetAxis;x(p,a,m,c,n,h);const f=s/r.unitInMeters,[u,_]=L(a,m,p,f),S=this._dimensionSegment;l(S.startRenderSpace,o.startRenderSpace,p,u),l(S.endRenderSpace,o.endRenderSpace,p,_),this._hasValidGeometry=!0}_updateLines(){if(!this._hasValidGeometry)return this._dimensionVisualElement.visible=!1,this._startOffsetVisualElement.visible=!1,void(this._endOffsetVisualElement.visible=!1);this._dimensionVisualElement.setGeometryFromSegment(this._dimensionSegment),this._startOffsetVisualElement.setGeometryFromSegment(this._startOffsetSegment),this._endOffsetVisualElement.setGeometryFromSegment(this._endOffsetSegment),this._dimensionVisualElement.visible=!0,this._startOffsetVisualElement.visible=!0,this._endOffsetVisualElement.visible=!0}_updateLabelContent(e){if(i(e)||!this._hasValidGeometry)return this._label.text="",void(this._label.visible=!1);const{value:t}=n(e,"meters");this._label.text=`${y(t,{minimumFractionDigits:2,maximumFractionDigits:2})} m`,this._label.visible=!0}_updateLabelGeometry(e){if(!this._hasValidGeometry)return void(this._label.visible=!1);const{offset:t}=this.computation.dimension,s=e.computeRenderPixelSizeAt(this._dimensionSegment.eval(.5,v.get())),i=(Math.sign(t)>=0?1:-1)*V.labels.offset*s;P(this._labelSegment,this._dimensionSegment,this._offsetAxis,i),this._label.geometry={type:"segment",sampleLocation:"center",segment:this._labelSegment,callout:!1}}};function x(e,t,s,i,n,r){switch(n){case"horizontal":return f(e,i);case"vertical":return d(t,i)<d(s,i)?c(e,s,t):c(e,t,s),h(e,e,i),p(e,S)?f(e,r):(h(e,e,i),u(e,e),e);case"direct":return d(t,r)>d(s,r)?c(e,s,t):c(e,t,s),h(e,e,i),p(e,S)?f(e,r):(u(e,e),e)}}function L(e,t,s,i=0){const n=d(t,s),r=d(e,s),o=Math.abs(n-r)+i;return n>r?[o,i]:[i,o]}function P(e,t,s,i){l(e.startRenderSpace,t.startRenderSpace,s,i),l(e.endRenderSpace,t.endRenderSpace,s,i)}e([a({constructOnly:!0,nonNullable:!0})],G.prototype,"computation",void 0),e([a({constructOnly:!0,nonNullable:!0})],G.prototype,"view",void 0),G=e([m("esri.views.3d.analysis.Dimensioning.LengthDimensionVisualization")],G);export{G as LengthDimensionVisualization};
