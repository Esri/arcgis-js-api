/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../intl","../../../../core/Accessor","../../../../core/Handles","../../../../core/mathUtils","../../../../core/maybe","../../../../core/quantityFormatUtils","../../../../core/quantityUtils","../../../../core/reactiveUtils","../../../../core/screenUtils","../../../../core/unitUtils","../../../../core/watchUtils","../../../../core/accessorSupport/decorators/property","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec2","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../chunks/vec4f32","../interfaces","./interfaces","../support/viewUtils","../../interactive/visualElements/LabelVisualElement","../../interactive/visualElements/LineVisualElement","../../interactive/visualElements/MeasurementArrowVisualElement","../../interactive/visualElements/RightAngleQuadVisualElement","../../interactive/visualElements/support/Segment","../../webgl-engine/lib/Material","../../webgl-engine/materials/lineStippleUtils","../../../../intl/locale","../../../../intl/messages"],(function(e,t,i,n,a,s,r,o,l,c,d,u,h,g,m,p,_,v,y,L,b,w,S,V,M,f,E,P,z,D,A,O,G,R,C){"use strict";var T;function k(e,t,i,n,a){const s=U,r=N;a.projectToRenderScreen(i,s),a.projectToRenderScreen(t,r);const o={segment:"bottom",horizontal:"top",vertical:s[0]<r[0]?"left":"right"};{const n=F,s=I;if(f.screenSpaceTangent(e,i,n,a),f.screenSpaceTangent(e,t,s,a),L.dot(n,s)>=H){const e=Math.sign(n[1])===Math.sign(s[1]);o.segment=e?E.mirrorPosition(o.vertical):o.vertical}else{const e=W;f.screenSpaceTangent(i,t,e,a),L.dot(e,s)>=H&&(o.segment=Math.sign(e[0])===Math.sign(s[0])?E.mirrorPosition(o.horizontal):o.horizontal)}}if(n===M.VisualElementOrientation.BelowSegment){const e=e=>"top"===e?"bottom":"top";o.segment=e(o.segment),o.horizontal=e(o.horizontal),o.vertical=e(o.vertical)}return o}e.State=void 0,(T=e.State||(e.State={}))[T.Pending=0]="Pending",T[T.Ready=1]="Ready",T[T.Destroyed=2]="Destroyed",e.DirectLineMeasurementVisualization=function(i){function n(t){var n;return(n=i.call(this,t)||this)._params={...x},n._handles=new s,n._segmentVisualElement=null,n._triangleVisualElement=null,n._rightAngleQuad=null,n._projectedGeodesicLine=null,n._geodesicStartHint=null,n._geodesicEndHint=null,n._segmentLabel=null,n._verticalLabel=null,n._horizontalLabel=null,n._startPosition=w.create(),n._endPosition=w.create(),n._cornerPosition=w.create(),n._startPositionAtSeaLevel=w.create(),n._endPositionAtSeaLevel=w.create(),n._state=e.State.Pending,n._triangleOrientationOverride=null,n.messages=null,n.loadingMessages=!0,n.visualElementOrientation=M.VisualElementOrientation.Auto,n.triangleCollapseRatioThreshold=.03,n}t._inheritsLoose(n,i);var a=n.prototype;return a.initialize=function(){this._handles.add(g.whenOnce(this.view,"ready",(()=>this._initialize()),!0))},a._initialize=function(){var i=this;switch(this._state){case e.State.Ready:throw new Error("invalid state");case e.State.Destroyed:return}const n=this._params,a={attached:!0,view:this.view};this._segmentVisualElement=new z.MeasurementArrowVisualElement({...a,geometry:null,renderOccluded:O.RenderOccludedFlag.OccludeAndTransparent}),this._triangleVisualElement=new P.LineVisualElement({...a,width:n.triangleLineWidth,color:n.triangleColor,renderOccluded:O.RenderOccludedFlag.OccludeAndTransparent}),this._rightAngleQuad=new D.RightAngleQuadVisualElement({...a,color:j,renderOccluded:O.RenderOccludedFlag.OccludeAndTransparent});const s={...a,polygonOffset:!0,renderOccluded:O.RenderOccludedFlag.OccludeAndTransparent};this._projectedGeodesicLine=new P.LineVisualElement({...s,width:n.geodesicProjectionLineWidth,color:n.geodesicProjectionLineColor,stipplePattern:G.createStipplePatternSimple(n.guideStippleLengthPixels)}),this._geodesicStartHint=new P.LineVisualElement({...s,width:n.guideLineWidth,color:n.geodesicProjectionLineColor,stipplePattern:G.createStipplePatternSimple(n.guideStippleLengthPixels)}),this._geodesicEndHint=new P.LineVisualElement({...s,width:n.guideLineWidth,color:n.geodesicProjectionLineColor,stipplePattern:G.createStipplePatternSimple(n.guideStippleLengthPixels)}),this._segmentLabel=new E.LabelVisualElement({...a,fontSize:n.direcLabelFontSize}),this._verticalLabel=new E.LabelVisualElement({...a,fontSize:n.verticalLabelFontSize}),this._horizontalLabel=new E.LabelVisualElement({...a,fontSize:n.horizontalLabelFontSize}),this._handles.add([d.watch((()=>{const{elevationAlignedStartPoint:e,elevationAlignedEndPoint:t}=this.analysisView,i=this.view;return{view:i,camera:i.state.camera,viewMode:this.viewMode,elevationAlignedStartPoint:e,elevationAlignedEndPoint:t,orientation:this._actualVisualElementsOrientation,visualizedMeasurement:this.actualVisualizedMeasurement,stripeLength:this._measurementArrowStripeLength}}),(e=>this._updateGeometryAndViewMode(e)),d.syncAndInitial),d.watch((()=>({visible:this.visible,viewMode:this.viewMode})),(e=>this._updateVisualElementVisibility(e)),d.syncAndInitial),d.watch((()=>({text:this._labelsText,visualizedMeasurement:this.actualVisualizedMeasurement})),(e=>this._updateLabelText(e)),d.syncAndInitial),d.watch((()=>({visible:this.visible,viewMode:this.viewMode,state:this._state})),(e=>this._updateLabelVisibility(e)),d.syncAndInitial),d.watch((()=>this._measurementArrowStripeLength),(e=>this._updateSegmentStripeLength(e)),d.syncAndInitial),R.onLocaleChange(t._asyncToGenerator((function*(){return i._updateMessageBundle()})))]),this._state=e.State.Ready,this._updateMessageBundle()},a.destroy=function(){this._state!==e.State.Destroyed&&(this._handles=o.destroyMaybe(this._handles),this._segmentVisualElement=o.destroyMaybe(this._segmentVisualElement),this._triangleVisualElement=o.destroyMaybe(this._triangleVisualElement),this._rightAngleQuad=o.destroyMaybe(this._rightAngleQuad),this._projectedGeodesicLine=o.destroyMaybe(this._projectedGeodesicLine),this._geodesicStartHint=o.destroyMaybe(this._geodesicStartHint),this._geodesicEndHint=o.destroyMaybe(this._geodesicEndHint),this._segmentLabel=o.destroyMaybe(this._segmentLabel),this._verticalLabel=o.destroyMaybe(this._verticalLabel),this._horizontalLabel=o.destroyMaybe(this._horizontalLabel),this.set("view",null),this._state=e.State.Destroyed)},a.whenReady=function(){var e=t._asyncToGenerator((function*(){yield g.whenOnce(this,"ready")}));function i(){return e.apply(this,arguments)}return i}(),a._updateVisualElementVisibility=function({visible:e,viewMode:t}){if(this._segmentVisualElement.visible=!1,this._triangleVisualElement.visible=!1,this._rightAngleQuad.visible=!1,this._projectedGeodesicLine.visible=!1,this._geodesicStartHint.visible=!1,this._geodesicEndHint.visible=!1,e)switch(t){case M.ViewMode.None:break;case M.ViewMode.Direct:this._segmentVisualElement.visible=!0;break;case M.ViewMode.Triangle:this._segmentVisualElement.visible=!0,this._triangleVisualElement.visible=!0,this._rightAngleQuad.visible=!0;break;case M.ViewMode.ProjectedGeodesic:this._segmentVisualElement.visible=!0,this._projectedGeodesicLine.visible=!0,this._geodesicStartHint.visible=!0,this._geodesicEndHint.visible=!0}},a._updateGeometryAndViewMode=function({view:e,camera:t,viewMode:i,elevationAlignedStartPoint:n,elevationAlignedEndPoint:a,orientation:s,visualizedMeasurement:r,stripeLength:l}){const c=e.renderCoordsHelper;if(o.isNone(n)||o.isNone(a)||n.equals(a))return;let d=this._startPosition,u=this._endPosition;c.toRenderCoords(n,d),c.toRenderCoords(a,u);const h=s===M.VisualElementOrientation.AboveSegment?1:-1,g=h*(c.getAltitude(u)-c.getAltitude(d));g<0&&(d=this._endPosition,u=this._startPosition);const m="geodesic"===r?new A.GeodesicSegment(this._startPosition,this._endPosition,c.spatialReference):new A.EuclideanSegment(this._startPosition,this._endPosition);switch(this._segmentVisualElement.geometry=m,this._updateSegmentStripeLength(l),i){case M.ViewMode.Direct:this._updateSegment(m,s);break;case M.ViewMode.Triangle:this._updateSegmentAndTriangle({view:e,camera:t,segment:m,orientation:s,startPosition:d,endPosition:u,deltaSign:h,altitudeDelta:g});break;case M.ViewMode.ProjectedGeodesic:this._updateSegmentAndProjection({view:e,orientation:s,startPosition:d,endPosition:u})}},a._updateSegment=function(e,t){this._segmentLabel.anchor=t===M.VisualElementOrientation.AboveSegment?"top":"bottom",this._segmentLabel.geometry={type:"segment",segment:e,sampleLocation:"center"}},a._updateSegmentAndTriangle=function({view:{renderCoordsHelper:e},camera:t,segment:i,orientation:n,startPosition:a,endPosition:s,deltaSign:r,altitudeDelta:o}){const l=this._cornerPosition;e.worldUpAtPosition(a,l),b.scale(l,l,r*Math.abs(o)),b.add(l,l,a),this._triangleVisualElement.geometry=[[[a[0],a[1],a[2]],[l[0],l[1],l[2]],[s[0],s[1],s[2]]]],this._rightAngleQuad.geometry={previous:a,center:l,next:s};const c=new A.EuclideanSegment(a,l),d=new A.EuclideanSegment(l,s),u=k(a,s,l,n,t);this._segmentLabel.anchor=u.segment,this._segmentLabel.geometry={type:"segment",segment:i,sampleLocation:"center"},this._verticalLabel.geometry={type:"segment",segment:c,sampleLocation:"center"},this._verticalLabel.anchor=u.vertical,this._horizontalLabel.geometry={type:"segment",segment:d,sampleLocation:"center"},this._horizontalLabel.anchor=u.horizontal},a._updateSegmentAndProjection=function({view:{renderCoordsHelper:e},orientation:t,startPosition:i,endPosition:n}){e.setAltitude(this._startPositionAtSeaLevel,0,i),e.setAltitude(this._endPositionAtSeaLevel,0,n);const a=new A.GeodesicSegment(this._startPositionAtSeaLevel,this._endPositionAtSeaLevel,e.spatialReference);this._projectedGeodesicLine.setGeometryFromSegment(a),this._geodesicStartHint.setGeometryFromSegment(new A.EuclideanSegment(this._startPositionAtSeaLevel,i)),this._geodesicEndHint.setGeometryFromSegment(new A.EuclideanSegment(this._endPositionAtSeaLevel,n)),this._segmentLabel.geometry={type:"segment",segment:a,sampleLocation:"center"},this._segmentLabel.anchor=t===M.VisualElementOrientation.AboveSegment?"top":"bottom"},a._updateLabelText=function({text:e,visualizedMeasurement:t}){o.isSome(e)?(this._segmentLabel.text="euclidean"===t?e.euclideanDistance:e.geodesicDistance,this._horizontalLabel.text=e.horizontalDistance,this._verticalLabel.text=e.verticalDistance):(this._segmentLabel.text=null,this._horizontalLabel.text=null,this._verticalLabel.text=null),this.notifyChange("labels")},a._updateLabelVisibility=function({state:t,visible:i,viewMode:n}){if(t!==e.State.Ready)return;const a=this._segmentLabel,s=this._horizontalLabel,r=this._verticalLabel;if(a.visible=!1,s.visible=!1,r.visible=!1,i)switch(n){case M.ViewMode.Direct:a.visible=!0;break;case M.ViewMode.Triangle:a.visible=!0,s.visible=!0,r.visible=!0;break;case M.ViewMode.ProjectedGeodesic:a.visible=!0;case M.ViewMode.None:}},a._updateSegmentStripeLength=function(e){const t=this._segmentVisualElement;o.isSome(e)?(t.stripeLength=e,t.stripesEnabled=!0):t.stripesEnabled=!1},a._requiresGeodesicGuideAt=function(e){const t=this.view;if(null==t||!t.state)return!1;const i=t.state.camera,n=t.renderCoordsHelper,a=i.computeScreenPixelSizeAt(e);return n.getAltitude(e)/a>=10},a._updateMessageBundle=function(){this.loadingMessages=!0,C.fetchMessageBundle("esri/core/t9n/Units").then((e=>{this.messages=e})).finally((()=>{this.loadingMessages=!1}))},t._createClass(n,[{key:"ready",get:function(){return this._state===e.State.Ready}},{key:"visible",get:function(){return this.analysisView.visible}},{key:"viewMode",get:function(){const{elevationAlignedStartPoint:e,elevationAlignedEndPoint:t}=this.analysisView;if(o.isNone(e)||o.isNone(t)||e.equals(t))return M.ViewMode.None;const i=this.analysisView.result;if(o.isNone(i))return M.ViewMode.Direct;if("geodesic"===i.mode)return this._requiresGeodesicGuideAt(this._startPosition)||this._requiresGeodesicGuideAt(this._endPosition)?M.ViewMode.ProjectedGeodesic:M.ViewMode.Direct;const{verticalDistance:n,horizontalDistance:a}=i,s=n.value,r=a.value;return Math.min(s/r,r/s)<this.triangleCollapseRatioThreshold?M.ViewMode.Direct:M.ViewMode.Triangle}},{key:"actualVisualizedMeasurement",get:function(){if(o.isNone(this.analysisView.result))switch(this.analysisView.measurementMode){case V.MeasurementMode.Auto:case V.MeasurementMode.Euclidean:default:return"euclidean";case V.MeasurementMode.Geodesic:return"geodesic"}return this.analysisView.result.mode}},{key:"allowVisualElementsOrientationChange",get:function(){return o.isNone(this._triangleOrientationOverride)},set:function(e){o.isNone(this._triangleOrientationOverride)!==e&&(o.isNone(this._triangleOrientationOverride)?this._triangleOrientationOverride=this._actualVisualElementsOrientation:this._triangleOrientationOverride=null)}},{key:"labels",get:function(){const e="geodesic"===this.actualVisualizedMeasurement;return{direct:this._segmentLabel,horizontal:e?this._segmentLabel:this._horizontalLabel,vertical:this._verticalLabel}}},{key:"testData",get:function(){var e;return{labels:this.labels,stripeLength:null==(e=this._segmentVisualElement)?void 0:e.stripeLength}}},{key:"_labelsText",get:function(){if(this._state!==e.State.Ready)return null;const t=this.messages,i=this.analysisView.result;if(o.isNone(i)||o.isNone(t))return null;const{directDistance:n,horizontalDistance:a,verticalDistance:s,geodesicDistance:r}=i,c=this.analysisView.unit,d=e=>({euclideanDistance:"",geodesicDistance:"",horizontalDistance:"",verticalDistance:"",...e});switch(c){case"metric":return d({euclideanDistance:n&&l.formatMetricLength(t,n),geodesicDistance:r&&l.formatMetricLength(t,r),horizontalDistance:a&&l.formatMetricLength(t,a),verticalDistance:s&&l.formatMetricVerticalLength(t,s)});case"imperial":return d({euclideanDistance:n&&l.formatImperialLength(t,n),geodesicDistance:r&&l.formatImperialLength(t,r),horizontalDistance:a&&l.formatImperialLength(t,a),verticalDistance:s&&l.formatImperialVerticalLength(t,s)});default:return d({euclideanDistance:n&&l.formatDecimal(t,n,c),geodesicDistance:r&&l.formatDecimal(t,r,c),horizontalDistance:a&&l.formatDecimal(t,a,c),verticalDistance:s&&l.formatDecimal(t,s,c)})}}},{key:"_actualVisualElementsOrientation",get:function(){if(o.isSome(this._triangleOrientationOverride))return this._triangleOrientationOverride;const e=this.visualElementOrientation;return e===M.VisualElementOrientation.Auto?this.view.state.camera.aboveGround?M.VisualElementOrientation.AboveSegment:M.VisualElementOrientation.BelowSegment:e}},{key:"_measurementArrowStripeLength",get:function(){const{result:e,unit:t}=this.analysisView;if(o.isNone(e))return null;let i=null;const n=e.directDistance;switch(t){case"metric":i=n&&c.toUnit(n,"meters");break;case"imperial":i=n&&c.toUnit(n,h.preferredImperialLengthUnit(n.value,n.unit));break;default:i=n&&c.toUnit(n,t)}if(o.isNone(i))return null;return r.nextHighestPowerOfTen(i.value/30)*h.convertUnit(1,i.unit,"meters")}}]),n}(a),i.__decorate([m.property()],e.DirectLineMeasurementVisualization.prototype,"_state",void 0),i.__decorate([m.property()],e.DirectLineMeasurementVisualization.prototype,"_triangleOrientationOverride",void 0),i.__decorate([m.property()],e.DirectLineMeasurementVisualization.prototype,"messages",void 0),i.__decorate([m.property()],e.DirectLineMeasurementVisualization.prototype,"view",void 0),i.__decorate([m.property()],e.DirectLineMeasurementVisualization.prototype,"analysis",void 0),i.__decorate([m.property()],e.DirectLineMeasurementVisualization.prototype,"analysisView",void 0),i.__decorate([m.property()],e.DirectLineMeasurementVisualization.prototype,"ready",null),i.__decorate([m.property()],e.DirectLineMeasurementVisualization.prototype,"loadingMessages",void 0),i.__decorate([m.property()],e.DirectLineMeasurementVisualization.prototype,"visible",null),i.__decorate([m.property()],e.DirectLineMeasurementVisualization.prototype,"viewMode",null),i.__decorate([m.property()],e.DirectLineMeasurementVisualization.prototype,"actualVisualizedMeasurement",null),i.__decorate([m.property()],e.DirectLineMeasurementVisualization.prototype,"visualElementOrientation",void 0),i.__decorate([m.property()],e.DirectLineMeasurementVisualization.prototype,"triangleCollapseRatioThreshold",void 0),i.__decorate([m.property()],e.DirectLineMeasurementVisualization.prototype,"allowVisualElementsOrientationChange",null),i.__decorate([m.property()],e.DirectLineMeasurementVisualization.prototype,"labels",null),i.__decorate([m.property()],e.DirectLineMeasurementVisualization.prototype,"testData",null),i.__decorate([m.property()],e.DirectLineMeasurementVisualization.prototype,"_labelsText",null),i.__decorate([m.property()],e.DirectLineMeasurementVisualization.prototype,"_actualVisualElementsOrientation",null),i.__decorate([m.property()],e.DirectLineMeasurementVisualization.prototype,"_measurementArrowStripeLength",null),e.DirectLineMeasurementVisualization=i.__decorate([y.subclass("esri.views.3d.analysis.DirectLineMeasurement.DirectLineMeasurementVisualization")],e.DirectLineMeasurementVisualization);const j=S.fromValues(1,.5,0,.75),x={laserLineGlowColor:[1,.5,0],laserLineGlowWidth:8,laserLineGlowFalloff:8,laserLineInnerColor:[1,1,1],laserLineInnerWidth:.75,laserLineGlobalAlpha:.75,laserLineEnabled:!0,handleColor:[1,.5,0],handleOpacity:.5,handleRadius:5,triangleColor:j,triangleLineWidth:3,triangleCornerSize:32,triangleSubdivisions:128,arrowWidth:16,arrowOutlineColor:[1,.5,0,1],arrowOutlineWidth:.2,arrowStripeEvenColor:[1,1,1,1],arrowStripeOddColor:[1,.5,0,1],arrowStripeLength:16,arrowSubdivisions:128,geodesicProjectionLineWidth:2,geodesicProjectionLineColor:j,guideLineWidth:2,guideLineColor:j,guideStippleLengthPixels:6,labelDistance:25,direcLabelFontSize:16,horizontalLabelFontSize:12,verticalLabelFontSize:12},H=Math.cos(r.deg2rad(12)),U=u.createRenderScreenPointArray3(),N=u.createRenderScreenPointArray3(),F=u.createRenderScreenPointArray(),I=u.createRenderScreenPointArray(),W=u.createRenderScreenPointArray();Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
