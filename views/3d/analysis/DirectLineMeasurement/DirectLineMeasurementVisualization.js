/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../intl","../../../../core/Accessor","../../../../core/Handles","../../../../core/mathUtils","../../../../core/maybe","../../../../core/quantityFormatUtils","../../../../core/reactiveUtils","../../../../core/screenUtils","../../../../core/unitUtils","../../../../core/watchUtils","../../../../core/accessorSupport/decorators/property","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec2","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../chunks/vec4f32","../../../../geometry/projectionEllipsoid","../support/viewUtils","../../interactive/visualElements/LabelVisualElement","../../interactive/visualElements/LineVisualElement","../../interactive/visualElements/MeasurementArrowVisualElement","../../interactive/visualElements/RightAngleQuadVisualElement","../../interactive/visualElements/support/Segment","../../webgl-engine/materials/lineStippleUtils","../../../../intl/locale","../../../../intl/messages"],(function(e,t,i,n,s,a,r,o,l,c,d,u,h,g,m,p,_,v,L,y,b,w,S,f,V,M,z,E,P,D,A,O){"use strict";function C(e,t,i,n,s){const a=H,r=R;s.projectToRenderScreen(i,a),s.projectToRenderScreen(t,r);const o={segment:"bottom",horizontal:"top",vertical:a[0]<r[0]?"left":"right"};{const n=j,a=T;if(f.screenSpaceTangent(e,i,n,s),f.screenSpaceTangent(e,t,a,s),L.dot(n,a)>=x){const e=Math.sign(n[1])===Math.sign(a[1]);o.segment=e?V.mirrorPosition(o.vertical):o.vertical}else{const e=U;f.screenSpaceTangent(i,t,e,s),L.dot(e,a)>=x&&(o.segment=Math.sign(e[0])===Math.sign(a[0])?V.mirrorPosition(o.horizontal):o.horizontal)}}if(2===n){const e=e=>"top"===e?"bottom":"top";o.segment=e(o.segment),o.horizontal=e(o.horizontal),o.vertical=e(o.vertical)}return o}e.DirectLineMeasurementVisualization=function(e){function i(t){var i;return(i=e.call(this,t)||this)._params={...k},i._handles=new a,i._segmentVisualElement=null,i._triangleVisualElement=null,i._rightAngleQuad=null,i._projectedGeodesicLine=null,i._geodesicStartHint=null,i._geodesicEndHint=null,i._segmentLabel=null,i._verticalLabel=null,i._horizontalLabel=null,i._startPosition=b.create(),i._endPosition=b.create(),i._cornerPosition=b.create(),i._startPositionAtSeaLevel=b.create(),i._endPositionAtSeaLevel=b.create(),i._state=0,i._triangleOrientationOverride=null,i.messages=null,i.loadingMessages=!0,i.visualElementOrientation=0,i.triangleCollapseRatioThreshold=.03,i}t._inheritsLoose(i,e);var n=i.prototype;return n.initialize=function(){this._handles.add(h.whenOnce(this.view,"ready",(()=>this._initialize()),!0))},n._initialize=function(){var e=this;switch(this._state){case 1:throw new Error("invalid state");case 2:return}const i=this._params,n={attached:!0,view:this.view};this._segmentVisualElement=new z.MeasurementArrowVisualElement({...n,geometry:null,renderOccluded:4}),this._triangleVisualElement=new M.LineVisualElement({...n,width:i.triangleLineWidth,color:i.triangleColor,renderOccluded:4}),this._rightAngleQuad=new E.RightAngleQuadVisualElement({...n,color:G,renderOccluded:4});const s={...n,polygonOffset:!0,renderOccluded:4};this._projectedGeodesicLine=new M.LineVisualElement({...s,width:i.geodesicProjectionLineWidth,color:i.geodesicProjectionLineColor,stipplePattern:D.createStipplePatternSimple(i.guideStippleLengthPixels)}),this._geodesicStartHint=new M.LineVisualElement({...s,width:i.guideLineWidth,color:i.geodesicProjectionLineColor,stipplePattern:D.createStipplePatternSimple(i.guideStippleLengthPixels)}),this._geodesicEndHint=new M.LineVisualElement({...s,width:i.guideLineWidth,color:i.geodesicProjectionLineColor,stipplePattern:D.createStipplePatternSimple(i.guideStippleLengthPixels)}),this._segmentLabel=new V.LabelVisualElement({...n,fontSize:i.direcLabelFontSize}),this._verticalLabel=new V.LabelVisualElement({...n,fontSize:i.verticalLabelFontSize}),this._horizontalLabel=new V.LabelVisualElement({...n,fontSize:i.horizontalLabelFontSize}),this._handles.add([c.react((()=>{const{elevationAlignedStartPoint:e,elevationAlignedEndPoint:t}=this.analysisView,i=this.view;return{view:i,camera:i.state.camera,viewMode:this.viewMode,elevationAlignedStartPoint:e,elevationAlignedEndPoint:t,orientation:this._actualVisualElementsOrientation,visualizedMeasurement:this.actualVisualizedMeasurement,stripeLength:this._measurementArrowStripeLength}}),(e=>this._updateGeometryAndViewMode(e)),c.syncAndInitial),c.react((()=>({visible:this.visible,viewMode:this.viewMode})),(e=>this._updateVisualElementVisibility(e)),c.syncAndInitial),c.react((()=>({text:this._labelsText,visualizedMeasurement:this.actualVisualizedMeasurement})),(e=>this._updateLabelText(e)),c.syncAndInitial),c.react((()=>({visible:this.visible,viewMode:this.viewMode,state:this._state})),(e=>this._updateLabelVisibility(e)),c.syncAndInitial),c.react((()=>this._measurementArrowStripeLength),(e=>this._updateSegmentStripeLength(e)),c.syncAndInitial),A.onLocaleChange(t._asyncToGenerator((function*(){return e._updateMessageBundle()})))]),this._state=1,this._updateMessageBundle()},n.destroy=function(){2!==this._state&&(this._handles=o.destroyMaybe(this._handles),this._segmentVisualElement=o.destroyMaybe(this._segmentVisualElement),this._triangleVisualElement=o.destroyMaybe(this._triangleVisualElement),this._rightAngleQuad=o.destroyMaybe(this._rightAngleQuad),this._projectedGeodesicLine=o.destroyMaybe(this._projectedGeodesicLine),this._geodesicStartHint=o.destroyMaybe(this._geodesicStartHint),this._geodesicEndHint=o.destroyMaybe(this._geodesicEndHint),this._segmentLabel=o.destroyMaybe(this._segmentLabel),this._verticalLabel=o.destroyMaybe(this._verticalLabel),this._horizontalLabel=o.destroyMaybe(this._horizontalLabel),this.set("view",null),this._state=2)},n.whenReady=function(){var e=t._asyncToGenerator((function*(){yield h.whenOnce(this,"ready")}));function i(){return e.apply(this,arguments)}return i}(),n._updateVisualElementVisibility=function({visible:e,viewMode:t}){if(this._segmentVisualElement.visible=!1,this._triangleVisualElement.visible=!1,this._rightAngleQuad.visible=!1,this._projectedGeodesicLine.visible=!1,this._geodesicStartHint.visible=!1,this._geodesicEndHint.visible=!1,e)switch(t){case 0:break;case 1:this._segmentVisualElement.visible=!0;break;case 2:this._segmentVisualElement.visible=!0,this._triangleVisualElement.visible=!0,this._rightAngleQuad.visible=!0;break;case 3:this._segmentVisualElement.visible=!0,this._projectedGeodesicLine.visible=!0,this._geodesicStartHint.visible=!0,this._geodesicEndHint.visible=!0}},n._updateGeometryAndViewMode=function({view:e,camera:t,viewMode:i,elevationAlignedStartPoint:n,elevationAlignedEndPoint:s,orientation:a,visualizedMeasurement:r,stripeLength:l}){const c=e.renderCoordsHelper;if(o.isNone(n)||o.isNone(s)||n.equals(s))return;let d=this._startPosition,u=this._endPosition;c.toRenderCoords(n,d),c.toRenderCoords(s,u);const h=1===a?1:-1,g=h*(c.getAltitude(u)-c.getAltitude(d));g<0&&(d=this._endPosition,u=this._startPosition);const m="geodesic"===r?new P.GeodesicSegment(this._startPosition,this._endPosition,c.spatialReference):new P.EuclideanSegment(this._startPosition,this._endPosition);switch(this._segmentVisualElement.geometry=m,this._updateSegmentStripeLength(l),i){case 1:this._updateSegment(m,a);break;case 2:this._updateSegmentAndTriangle({view:e,camera:t,segment:m,orientation:a,startPosition:d,endPosition:u,deltaSign:h,altitudeDelta:g});break;case 3:this._updateSegmentAndProjection({view:e,orientation:a,startPosition:d,endPosition:u})}},n._updateSegment=function(e,t){this._segmentLabel.anchor=1===t?"top":"bottom",this._segmentLabel.geometry={type:"segment",segment:e,sampleLocation:"center"}},n._updateSegmentAndTriangle=function({view:{renderCoordsHelper:e},camera:t,segment:i,orientation:n,startPosition:s,endPosition:a,deltaSign:r,altitudeDelta:o}){const l=this._cornerPosition;e.worldUpAtPosition(s,l),y.scale(l,l,r*Math.abs(o)),y.add(l,l,s),this._triangleVisualElement.geometry=[[[s[0],s[1],s[2]],[l[0],l[1],l[2]],[a[0],a[1],a[2]]]],this._rightAngleQuad.geometry={previous:s,center:l,next:a};const c=new P.EuclideanSegment(s,l),d=new P.EuclideanSegment(l,a),u=C(s,a,l,n,t);this._segmentLabel.anchor=u.segment,this._segmentLabel.geometry={type:"segment",segment:i,sampleLocation:"center"},this._verticalLabel.geometry={type:"segment",segment:c,sampleLocation:"center"},this._verticalLabel.anchor=u.vertical,this._horizontalLabel.geometry={type:"segment",segment:d,sampleLocation:"center"},this._horizontalLabel.anchor=u.horizontal},n._updateSegmentAndProjection=function({view:{renderCoordsHelper:e},orientation:t,startPosition:i,endPosition:n}){e.setAltitude(this._startPositionAtSeaLevel,0,i),e.setAltitude(this._endPositionAtSeaLevel,0,n);const s=new P.GeodesicSegment(this._startPositionAtSeaLevel,this._endPositionAtSeaLevel,e.spatialReference);this._projectedGeodesicLine.setGeometryFromSegment(s),this._geodesicStartHint.setGeometryFromSegment(new P.EuclideanSegment(this._startPositionAtSeaLevel,i)),this._geodesicEndHint.setGeometryFromSegment(new P.EuclideanSegment(this._endPositionAtSeaLevel,n)),this._segmentLabel.geometry={type:"segment",segment:s,sampleLocation:"center"},this._segmentLabel.anchor=1===t?"top":"bottom"},n._updateLabelText=function({text:e,visualizedMeasurement:t}){o.isSome(e)?(this._segmentLabel.text="euclidean"===t?e.euclideanDistance:e.geodesicDistance,this._horizontalLabel.text=e.horizontalDistance,this._verticalLabel.text=e.verticalDistance):(this._segmentLabel.text=null,this._horizontalLabel.text=null,this._verticalLabel.text=null),this.notifyChange("labels")},n._updateLabelVisibility=function({state:e,visible:t,viewMode:i}){if(1!==e)return;const n=this._segmentLabel,s=this._horizontalLabel,a=this._verticalLabel;if(n.visible=!1,s.visible=!1,a.visible=!1,t)switch(i){case 1:case 3:n.visible=!0;break;case 2:n.visible=!0,s.visible=!0,a.visible=!0}},n._updateSegmentStripeLength=function(e){const t=this._segmentVisualElement;o.isSome(e)?(t.stripeLength=e,t.stripesEnabled=!0):t.stripesEnabled=!1},n._requiresGeodesicGuideAt=function(e){const t=this.view;if(null==t||!t.state)return!1;const i=t.state.camera,n=t.renderCoordsHelper,s=i.computeScreenPixelSizeAt(e);return n.getAltitude(e)/s>=10},n._updateMessageBundle=function(){this.loadingMessages=!0,O.fetchMessageBundle("esri/core/t9n/Units").then((e=>{this.messages=e})).finally((()=>{this.loadingMessages=!1}))},t._createClass(i,[{key:"ready",get:function(){return 1===this._state}},{key:"visible",get:function(){return this.analysisView.visible}},{key:"viewMode",get:function(){const{elevationAlignedStartPoint:e,elevationAlignedEndPoint:t}=this.analysisView;if(o.isNone(e)||o.isNone(t)||e.equals(t))return 0;const i=this.analysisView.result;if(o.isNone(i))return 1;if("geodesic"===i.mode)return this._requiresGeodesicGuideAt(this._startPosition)||this._requiresGeodesicGuideAt(this._endPosition)?3:1;const{verticalDistance:n,horizontalDistance:s}=i,a=n.value,r=s.value;return Math.min(a/r,r/a)<this.triangleCollapseRatioThreshold?1:2}},{key:"actualVisualizedMeasurement",get:function(){if(o.isNone(this.analysisView.result))switch(this.analysisView.measurementMode){case 0:case 1:default:return"euclidean";case 2:return"geodesic"}return this.analysisView.result.mode}},{key:"allowVisualElementsOrientationChange",get:function(){return o.isNone(this._triangleOrientationOverride)},set:function(e){o.isNone(this._triangleOrientationOverride)!==e&&(o.isNone(this._triangleOrientationOverride)?this._triangleOrientationOverride=this._actualVisualElementsOrientation:this._triangleOrientationOverride=null)}},{key:"labels",get:function(){const e="geodesic"===this.actualVisualizedMeasurement;return{direct:this._segmentLabel,horizontal:e?this._segmentLabel:this._horizontalLabel,vertical:this._verticalLabel}}},{key:"testData",get:function(){var e;return{labels:this.labels,stripeLength:null==(e=this._segmentVisualElement)?void 0:e.stripeLength}}},{key:"_labelsText",get:function(){if(1!==this._state)return null;const e=this.messages,t=this.analysisView.result;if(o.isNone(t)||o.isNone(e))return null;const{directDistance:i,horizontalDistance:n,verticalDistance:s,geodesicDistance:a,geodesicAngle:r}=t,c=this.analysisView.unit,d=e=>({euclideanDistance:"",geodesicDistance:"",horizontalDistance:"",verticalDistance:"",...e});switch(c){case"metric":return d({euclideanDistance:i&&l.formatMetricLength(e,i),geodesicDistance:a&&l.formatMetricLength(e,a),horizontalDistance:n&&l.formatMetricLength(e,n),verticalDistance:s&&l.formatMetricVerticalLength(e,s)});case"imperial":return d({euclideanDistance:i&&l.formatImperialLength(e,i),geodesicDistance:a&&l.formatImperialLength(e,a),horizontalDistance:n&&l.formatImperialLength(e,n),verticalDistance:s&&l.formatImperialVerticalLength(e,s)});case"degrees":{const t=r&&l.formatDecimal(e,r,"degrees");return d({euclideanDistance:t,geodesicDistance:t,horizontalDistance:t})}case"degrees-minutes-seconds":return d({horizontalDistance:r&&l.formatDMS(r)});default:return d({euclideanDistance:i&&l.formatDecimal(e,i,c),geodesicDistance:a&&l.formatDecimal(e,a,c),horizontalDistance:n&&l.formatDecimal(e,n,c),verticalDistance:s&&l.formatDecimal(e,s,c)})}}},{key:"_actualVisualElementsOrientation",get:function(){if(o.isSome(this._triangleOrientationOverride))return this._triangleOrientationOverride;const e=this.visualElementOrientation;return 0===e?this.view.state.camera.aboveGround?1:2:e}},{key:"_measurementArrowStripeLength",get:function(){const{result:e,unit:t}=this.analysisView;if(o.isNone(e))return null;let i=null;const n=e.directDistance;switch(t){case"metric":i=n&&n.toUnit("meters");break;case"imperial":i=n&&n.toUnit(u.preferredImperialLengthUnit(n.value,n.unit));break;case"degrees":case"degrees-minutes-seconds":{const t=e.geodesicAngle;i=t&&t.toUnit("degrees");break}default:i=n&&n.toUnit(t)}if(o.isNone(i))return null;return r.nextHighestPowerOfTen(i.value/30)*("degrees"===i.unit?S.getReferenceEllipsoid(this.view.spatialReference).metersPerDegree:u.convertUnit(1,i.unit,"meters"))}}]),i}(s),i.__decorate([g.property()],e.DirectLineMeasurementVisualization.prototype,"_state",void 0),i.__decorate([g.property()],e.DirectLineMeasurementVisualization.prototype,"_triangleOrientationOverride",void 0),i.__decorate([g.property()],e.DirectLineMeasurementVisualization.prototype,"messages",void 0),i.__decorate([g.property()],e.DirectLineMeasurementVisualization.prototype,"view",void 0),i.__decorate([g.property()],e.DirectLineMeasurementVisualization.prototype,"analysis",void 0),i.__decorate([g.property()],e.DirectLineMeasurementVisualization.prototype,"analysisView",void 0),i.__decorate([g.property()],e.DirectLineMeasurementVisualization.prototype,"ready",null),i.__decorate([g.property()],e.DirectLineMeasurementVisualization.prototype,"loadingMessages",void 0),i.__decorate([g.property()],e.DirectLineMeasurementVisualization.prototype,"visible",null),i.__decorate([g.property()],e.DirectLineMeasurementVisualization.prototype,"viewMode",null),i.__decorate([g.property()],e.DirectLineMeasurementVisualization.prototype,"actualVisualizedMeasurement",null),i.__decorate([g.property()],e.DirectLineMeasurementVisualization.prototype,"visualElementOrientation",void 0),i.__decorate([g.property()],e.DirectLineMeasurementVisualization.prototype,"triangleCollapseRatioThreshold",void 0),i.__decorate([g.property()],e.DirectLineMeasurementVisualization.prototype,"allowVisualElementsOrientationChange",null),i.__decorate([g.property()],e.DirectLineMeasurementVisualization.prototype,"labels",null),i.__decorate([g.property()],e.DirectLineMeasurementVisualization.prototype,"testData",null),i.__decorate([g.property()],e.DirectLineMeasurementVisualization.prototype,"_labelsText",null),i.__decorate([g.property()],e.DirectLineMeasurementVisualization.prototype,"_actualVisualElementsOrientation",null),i.__decorate([g.property()],e.DirectLineMeasurementVisualization.prototype,"_measurementArrowStripeLength",null),e.DirectLineMeasurementVisualization=i.__decorate([v.subclass("esri.views.3d.analysis.DirectLineMeasurement.DirectLineMeasurementVisualization")],e.DirectLineMeasurementVisualization);const G=w.fromValues(1,.5,0,.75),k={laserLineGlowColor:[1,.5,0],laserLineGlowWidth:8,laserLineGlowFalloff:8,laserLineInnerColor:[1,1,1],laserLineInnerWidth:.75,laserLineGlobalAlpha:.75,laserLineEnabled:!0,handleColor:[1,.5,0],handleOpacity:.5,handleRadius:5,triangleColor:G,triangleLineWidth:3,triangleCornerSize:32,triangleSubdivisions:128,arrowWidth:16,arrowOutlineColor:[1,.5,0,1],arrowOutlineWidth:.2,arrowStripeEvenColor:[1,1,1,1],arrowStripeOddColor:[1,.5,0,1],arrowStripeLength:16,arrowSubdivisions:128,geodesicProjectionLineWidth:2,geodesicProjectionLineColor:G,guideLineWidth:2,guideLineColor:G,guideStippleLengthPixels:6,labelDistance:25,direcLabelFontSize:16,horizontalLabelFontSize:12,verticalLabelFontSize:12},x=Math.cos(r.deg2rad(12)),H=d.createRenderScreenPointArray3(),R=d.createRenderScreenPointArray3(),j=d.createRenderScreenPointArray(),T=d.createRenderScreenPointArray(),U=d.createRenderScreenPointArray();Object.defineProperty(e,"__esModule",{value:!0})}));
