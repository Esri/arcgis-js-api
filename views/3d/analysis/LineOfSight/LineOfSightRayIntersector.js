/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/maybe","../../../../core/screenUtils","../../../../core/accessorSupport/decorators/property","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/support/ray","../../../../geometry/support/vectorStacks","../../../../layers/graphics/dehydratedFeatures","./LineOfSightIntersectionResult","../../layers/i3s/Intersector","../../support/geometryUtils/ray","../../terrain/Intersector","../../terrain/tileUtils","../../webgl-engine/lib/Intersector","../../webgl-engine/lib/IntersectorInterfaces","../../webgl-engine/lib/intersectorUtilsConversions"],(function(e,t,r,n,s,i,o,c,a,l,p,u,d,y,I,h,g,f,R,m,v,S,w,b){"use strict";e.LineOfSightRayIntersector=function(e){function r(t){return e.call(this,t)||this}t._inheritsLoose(r,e);var n=r.prototype;return n.initialize=function(){this.intersector=S.newIntersector(this.view.state.viewingMode),this.intersector.options.hud=!1,this.intersector.options.store=w.StoreResults.MIN},n.getScreenPointIntersection=function(e){const t=i.screenPointObjectToArray(e,I.sv2d.get()),r=R.fromScreen(this.view.state.camera,t,L);return this._getRayIntersection(r)},n._getRayIntersection=function(e){if(s.isNone(e))return null;this.view.sceneIntersectionHelper.intersectToolIntersectorRay(e,this.intersector);const t=this.intersector.results.min;if(!t.getIntersectionPoint(T))return null;const r=this.view.renderCoordsHelper.fromRenderCoords(T,this.view.spatialReference),n=d.fromArray(t.normal),i=u.dot(n,e.direction)>0?-1:1;if(u.scale(n,n,i),f.isI3sIntersectorResult(t))return new g.LineOfSightIntersectionResult({type:w.IntersectorType.OBJECT,id:`${t.target.layerUid}/${t.target.nodeIndex}/${t.target.componentIndex}`,point:r,normal:n,ray:y.copy(e)});if(m.isTerrainIntersectorResult(t))return new g.LineOfSightIntersectionResult({type:w.IntersectorType.TERRAIN,id:t.target.lij.slice(),point:r,normal:n,ray:y.copy(e)});const o=b.toGraphic(t,this.view);if(s.isSome(o)){const t=o.layer,s=o.sourceLayer;let i;if(s)if("scene"===s.type)i=h.getObjectId(o,s.objectIdField);else i=o.uid;else i=o.uid;return new g.LineOfSightIntersectionResult({type:w.IntersectorType.OBJECT,id:`${t.uid}/${i}`,point:r,normal:n,ray:y.copy(e)})}return null},n._canUpdateFromIntersectionResult=function(e,t){if(s.isNone(e)||!t||e.type!==t.type)return!1;switch(e.type){case w.IntersectorType.TERRAIN:{const r=e.id,n=t.id;return r[0]===n[0]&&r[1]===n[1]&&r[2]===n[2]||v.tilesAreRelated(r,n)}case w.IntersectorType.OBJECT:case w.IntersectorType.I3S:return e.id===t.id}},n.updateFromIntersectionResult=function(e){let t;if(e.type===w.IntersectorType.TERRAIN&&s.isSome(e.point)){const r=T,n=O,s=_;this.view.renderCoordsHelper.toRenderCoords(e.point,n),this.view.renderCoordsHelper.worldUpAtPosition(n,s);const i=this.view.basemapTerrain.elevationBounds,o=this.view.renderCoordsHelper.getAltitude(n),c=i?Math.abs(i.max-i.min)/Math.abs(o):100,a=o>0?1:-1;u.normalize(s,s),u.scale(s,s,a*c),u.add(r,n,s),y.fromPoints(r,n,L),t=this._getRayIntersection(L)}else t=this._getRayIntersection(e.ray);return this._canUpdateFromIntersectionResult(t,e)?t.point:null},r}(n),r.__decorate([o.property()],e.LineOfSightRayIntersector.prototype,"view",void 0),r.__decorate([o.property()],e.LineOfSightRayIntersector.prototype,"intersector",void 0),e.LineOfSightRayIntersector=r.__decorate([p.subclass("esri.views.3d.analysis.LineOfSight.LineOfSightRayIntersector")],e.LineOfSightRayIntersector);const T=d.create(),O=d.create(),_=d.create(),L=y.create();Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
