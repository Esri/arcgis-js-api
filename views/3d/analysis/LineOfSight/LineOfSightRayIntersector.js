/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/maybe","../../../../core/screenUtils","../../../../core/accessorSupport/decorators/property","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/support/ray","../../../../geometry/support/vectorStacks","../../../../layers/graphics/dehydratedFeatures","./LineOfSightIntersectionResult","../../layers/i3s/Intersector","../../support/geometryUtils/ray","../../terrain/Intersector","../../terrain/tileUtils","../../webgl-engine/lib/Intersector","../../webgl-engine/lib/intersectorUtilsConversions"],(function(e,t,r,i,n,s,o,c,a,l,p,u,d,y,h,f,g,I,m,R,v,w,S){"use strict";e.LineOfSightRayIntersector=function(e){function r(t){return e.call(this,t)||this}t._inheritsLoose(r,e);var i=r.prototype;return i.initialize=function(){this.intersector=w.newIntersector(this.view.state.viewingMode),this.intersector.options.hud=!1,this.intersector.options.store=0},i.getScreenPointIntersection=function(e){const t=s.screenPointObjectToArray(e,h.sv2d.get()),r=m.fromScreen(this.view.state.camera,t,L);return this._getRayIntersection(r)},i._getRayIntersection=function(e){if(n.isNone(e))return null;this.view.sceneIntersectionHelper.intersectToolIntersectorRay(e,this.intersector);const t=this.intersector.results.min;if(!t.getIntersectionPoint(b))return null;const r=this.view.renderCoordsHelper.fromRenderCoords(b,this.view.spatialReference),i=d.fromArray(t.normal),s=u.dot(i,e.direction)>0?-1:1;if(u.scale(i,i,s),I.isI3sIntersectorResult(t))return new g.LineOfSightIntersectionResult({type:0,id:`${t.target.layerUid}/${t.target.nodeIndex}/${t.target.componentIndex}`,point:r,normal:i,ray:y.copy(e)});if(R.isTerrainIntersectorResult(t))return new g.LineOfSightIntersectionResult({type:2,id:t.target.lij.slice(),point:r,normal:i,ray:y.copy(e)});const o=S.toGraphic(t,this.view);if(n.isSome(o)){const t=o.layer,n=o.sourceLayer;let s;if(n)if("scene"===n.type)s=f.getObjectId(o,n.objectIdField);else s=o.uid;else s=o.uid;return new g.LineOfSightIntersectionResult({type:0,id:`${t.uid}/${s}`,point:r,normal:i,ray:y.copy(e)})}return null},i._canUpdateFromIntersectionResult=function(e,t){if(n.isNone(e)||!t||e.type!==t.type)return!1;switch(e.type){case 2:{const r=e.id,i=t.id;return r[0]===i[0]&&r[1]===i[1]&&r[2]===i[2]||v.tilesAreRelated(r,i)}case 0:case 4:return e.id===t.id}},i.updateFromIntersectionResult=function(e){let t;if(2===e.type&&n.isSome(e.point)){const r=b,i=_,n=O;this.view.renderCoordsHelper.toRenderCoords(e.point,i),this.view.renderCoordsHelper.worldUpAtPosition(i,n);const s=this.view.basemapTerrain.elevationBounds,o=this.view.renderCoordsHelper.getAltitude(i),c=s?Math.abs(s.max-s.min)/Math.abs(o):100,a=o>0?1:-1;u.normalize(n,n),u.scale(n,n,a*c),u.add(r,i,n),y.fromPoints(r,i,L),t=this._getRayIntersection(L)}else t=this._getRayIntersection(e.ray);return this._canUpdateFromIntersectionResult(t,e)?t.point:null},r}(i),r.__decorate([o.property()],e.LineOfSightRayIntersector.prototype,"view",void 0),r.__decorate([o.property()],e.LineOfSightRayIntersector.prototype,"intersector",void 0),e.LineOfSightRayIntersector=r.__decorate([p.subclass("esri.views.3d.analysis.LineOfSight.LineOfSightRayIntersector")],e.LineOfSightRayIntersector);const b=d.create(),_=d.create(),O=d.create(),L=y.create();Object.defineProperty(e,"__esModule",{value:!0})}));
