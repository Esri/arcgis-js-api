/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../Color","../../../../core/Accessor","../../../../core/Handles","../../../../core/handleUtils","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/mat4f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../core/support/WatchUpdatingTracking","./LineOfSightVisualElement","../../interactive/visualElements/LineVisualElement","../../interactive/visualElements/PointVisualElement","../../webgl-engine/lib/Material"],(function(e,i,t,n,o,a,r,s,l,c,u,d,h,p,f,g,m,v,y,_,b){"use strict";e.LineOfSightVisualization=function(e){function t(i){var t;return(t=e.call(this,i)||this)._lineOfSightVisualElements=new Array,t._computationHandles=new a,t._updatingHandles=new m.WatchUpdatingTracking,t}i._inheritsLoose(t,e);var o=t.prototype;return o.initialize=function(){this.addHandles(this._connectComputations()),this._createObserverVisualization()},o.destroy=function(){this._updatingHandles=s.destroyMaybe(this._updatingHandles),this._computationHandles=s.destroyMaybe(this._computationHandles),this._observerVisualElement=s.destroyMaybe(this._observerVisualElement)},o._createLineOfSightVisualization=function(){const e=this._configuration,i=this.view,t={view:i,attached:!0,width:e.outerWidth,innerWidth:e.innerWidth},o=n.toUnitRGBA(e.visibleOuterColor),a=n.toUnitRGBA(e.visibleInnerColor),r=n.toUnitRGBA(e.occludedOuterColor),s=n.toUnitRGBA(e.occludedInnerColor),l=n.toUnitRGBA(e.undefinedOuterColor),c=n.toUnitRGBA(e.undefinedInnerColor),u=new y.LineVisualElement({...t,color:o,innerColor:a}),d=new y.LineVisualElement({...t,color:r,innerColor:s}),h=new y.LineVisualElement({...t,color:l,innerColor:c}),p=new _.PointVisualElement({view:i,attached:!0,...O,size:8}),f=new v.LineOfSightVisualElement(u,d,h,p);return this._lineOfSightVisualElements.push(f),f},o._destroyLineOfSightVisualization=function(e){e.destroy(),this._lineOfSightVisualElements.splice(this._lineOfSightVisualElements.indexOf(e),1)},o._updateLineOfSightVisualization=function(e,i,t){const o=this._configuration,{computationResult:a,inputPoints:r}=e,{start:l,end:c,intersection:u,isValid:d,isTargetVisible:h}=a,{observer:p}=r,m=S;m[12]=p[0],m[13]=p[1],m[14]=p[2];const v=f.subtract(V,l,p),y=f.subtract(E,c,p),_=f.subtract(L,u,p),{visibleLineVisualElement:b,occludedLineVisualElement:O,undefinedLineVisualElement:C,targetVisualElement:A}=i,z=s.isNone(this.analysisViewData.elevationAlignedObserver)||s.isNone(e.elevationAlignedTargetLocation),w=this.visible&&!z;b.visible=w,O.visible=w,C.visible=w,A.visible=w,A.attached=!t.interactiveAndEditable,w&&(b.geometry=null,O.geometry=null,C.geometry=null,A.geometry=e.elevationAlignedTargetLocation,d?h?(b.geometry=[[g.fromArray(v),g.fromArray(y)]],b.transform=m,b.color=n.toUnitRGBA(o.visibleOuterColor),A.color=n.toUnitRGBA(o.visibleInnerColor)):(b.geometry=[[g.fromArray(v),g.fromArray(_)]],b.transform=m,b.color=n.toUnitRGBA(o.occludedOuterColor),O.geometry=[[g.fromArray(_),g.fromArray(y)]],O.transform=m,A.color=n.toUnitRGBA(o.occludedInnerColor)):(C.geometry=[[g.fromArray(v),g.fromArray(y)]],C.transform=m,A.color=n.toUnitRGBA(o.undefinedInnerColor)))},o._getLineOfSightVisualizationDependencies=function(e){const{computationResult:i}=e,{occludedOuterColor:t,visibleOuterColor:n}=this._configuration;return{computationResult:i,occludedOuterColor:t,visibleOuterColor:n,visible:this.visible,interactiveAndEditable:this.interactiveAndEditable}},o._connectComputation=function(e){const i=this._computationHandles;if(i.has(e))return;const t=this._createLineOfSightVisualization();i.add([this._updatingHandles.add((()=>this._getLineOfSightVisualizationDependencies(e)),(i=>this._updateLineOfSightVisualization(e,t,i)),{initial:!0,equals:()=>!1}),r.makeHandle((()=>this._destroyLineOfSightVisualization(t)))],e)},o._disconnectComputation=function(e){this._computationHandles.remove(e)},o._connectComputations=function(){return this._updatingHandles.addOnCollectionChange((()=>this.analysisViewData.computations),(e=>this._onComputationsCollectionChange(e)),{initial:!0,final:!0})},o._onComputationsCollectionChange=function({added:e,removed:i}){for(const t of i)this._disconnectComputation(t);for(const t of e)this._connectComputation(t)},o._createObserverVisualization=function(){const e=n.toUnitRGBA(this._configuration.visibleInnerColor),i=new _.PointVisualElement({view:this.view,attached:!1,color:e,...O});this._observerVisualElement=i,this.addHandles(this._updatingHandles.add((()=>({observer:this.analysisViewData.elevationAlignedObserver,interactiveAndEditable:this.interactiveAndEditable,visible:this.visible})),(({observer:e,interactiveAndEditable:t,visible:n})=>{s.isNone(e)||t||!n?i.attached=!1:(i.geometry=e,this._observerVisualElement.attached=!0)}),l.initial))},i._createClass(t,[{key:"visible",get:function(){return this.analysisViewData.visible}},{key:"updating",get:function(){return this._updatingHandles.updating}},{key:"interactiveAndEditable",get:function(){return this.analysisViewData.interactive&&this.analysisViewData.editable}},{key:"test",get:function(){return{disablePartialOcclusion:()=>{for(const e of this._lineOfSightVisualElements)e.visibleLineVisualElement.renderOccluded=b.RenderOccludedFlag.Occlude,e.occludedLineVisualElement.renderOccluded=b.RenderOccludedFlag.Occlude,e.undefinedLineVisualElement.renderOccluded=b.RenderOccludedFlag.Occlude},visualizations:this._lineOfSightVisualElements}}},{key:"_configuration",get:function(){return this.analysisViewData.configuration}}]),t}(o),t.__decorate([c.property({constructOnly:!0})],e.LineOfSightVisualization.prototype,"analysis",void 0),t.__decorate([c.property({constructOnly:!0})],e.LineOfSightVisualization.prototype,"analysisViewData",void 0),t.__decorate([c.property({constructOnly:!0})],e.LineOfSightVisualization.prototype,"view",void 0),t.__decorate([c.property({readOnly:!0})],e.LineOfSightVisualization.prototype,"visible",null),t.__decorate([c.property()],e.LineOfSightVisualization.prototype,"updating",null),t.__decorate([c.property()],e.LineOfSightVisualization.prototype,"interactiveAndEditable",null),t.__decorate([c.property()],e.LineOfSightVisualization.prototype,"test",null),t.__decorate([c.property()],e.LineOfSightVisualization.prototype,"_configuration",null),e.LineOfSightVisualization=t.__decorate([h.subclass("esri.views.3d.analysis.LineOfSight.LineOfSightVisualization")],e.LineOfSightVisualization);const O={size:6,pixelSnappingEnabled:!1,primitive:"circle",elevationInfo:{mode:"absolute-height",offset:0},outlineSize:0},V=g.create(),E=g.create(),L=g.create(),S=p.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
