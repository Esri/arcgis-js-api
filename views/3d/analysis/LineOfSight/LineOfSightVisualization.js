/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../Color","../../../../core/Accessor","../../../../core/Handles","../../../../core/handleUtils","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/mat4f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../interactive/visualElements/LineVisualElement"],(function(e,i,t,n,o,s,a,r,l,u,c,d,h,f,m,y,p,g){"use strict";e.LineOfSightVisualization=function(e){function t(i){var t;return(t=e.call(this,i)||this)._lineOfSightVisualizations=[],t._handle=null,t._computationHandles=new s,t}i._inheritsLoose(t,e);var o=t.prototype;return o.initialize=function(){this._handle=this._connectAnalysis()},o.destroy=function(){this._handle=r.removeMaybe(this._handle),this._computationHandles=r.destroyMaybe(this._computationHandles)},o.createLineOfSightVisualization=function(){const e=this._configuration,i={view:this.view,attached:!0,width:e.outerWidth,innerWidth:e.innerWidth},t=n.toUnitRGBA(e.visibleOuterColor),o=n.toUnitRGBA(e.visibleInnerColor),s=n.toUnitRGBA(e.occludedOuterColor),a=n.toUnitRGBA(e.occludedInnerColor),r=n.toUnitRGBA(e.undefinedOuterColor),l=n.toUnitRGBA(e.undefinedInnerColor),u={visibleLineVisualElement:new g.LineVisualElement({...i,color:t,innerColor:o}),occludedLineVisualElement:new g.LineVisualElement({...i,color:s,innerColor:a}),undefinedLineVisualElement:new g.LineVisualElement({...i,color:r,innerColor:l})};return this._lineOfSightVisualizations.push(u),u},o.destroyLineOfSightVisualization=function(e){e.visibleLineVisualElement=r.destroyMaybe(e.visibleLineVisualElement),e.occludedLineVisualElement=r.destroyMaybe(e.occludedLineVisualElement),e.undefinedLineVisualElement=r.destroyMaybe(e.undefinedLineVisualElement),this._lineOfSightVisualizations.splice(this._lineOfSightVisualizations.indexOf(e),1)},o.updateLineOfSightVisualization=function(e,i){const t=this._configuration,{computationResult:o,inputPoints:s}=e,{start:a,end:l,intersection:u,isValid:c,isTargetVisible:d}=o,{observer:h}=s,f=O;f[12]=h[0],f[13]=h[1],f[14]=h[2];const m=y.subtract(_,a,h),g=y.subtract(v,l,h),b=y.subtract(V,u,h),{visibleLineVisualElement:L,occludedLineVisualElement:C,undefinedLineVisualElement:S}=i,z=r.isNone(this.analysisViewData.elevationAlignedObserver)||r.isNone(e.elevationAlignedTargetLocation),A=this.visible&&!z;L.visible=A,C.visible=A,S.visible=A,A&&(L.geometry=null,C.geometry=null,S.geometry=null,c?d?(L.geometry=[[p.fromArray(m),p.fromArray(g)]],L.transform=f,L.color=n.toUnitRGBA(t.visibleOuterColor)):(L.geometry=[[p.fromArray(m),p.fromArray(b)]],L.transform=f,L.color=n.toUnitRGBA(t.occludedOuterColor),C.geometry=[[p.fromArray(b),p.fromArray(g)]],C.transform=f):(S.geometry=[[p.fromArray(m),p.fromArray(g)]],S.transform=f))},o.getLineOfSightVisualizationDependencies=function(e){const{computationResult:i}=e,{occludedOuterColor:t,visibleOuterColor:n}=this._configuration;return{computationResult:i,occludedOuterColor:t,visibleOuterColor:n,visible:this.visible}},o._connectComputation=function(e){const i=this._computationHandles;if(i.has(e))return;const t=this.createLineOfSightVisualization();i.add([l.watch((()=>this.getLineOfSightVisualizationDependencies(e)),(()=>this.updateLineOfSightVisualization(e,t)),l.syncAndInitial),a.makeHandle((()=>this.destroyLineOfSightVisualization(t)))],e)},o._disconnectComputation=function(e){this._computationHandles.remove(e)},o._connectAnalysis=function(){let e=null;return a.handlesGroup([l.watch((()=>this.analysisViewData.computations),(i=>{e=r.removeMaybe(e),e=i.on("change",(e=>this._onComputationsCollectionChange(e))),this._onComputationsCollectionChange({target:i,added:i.items,removed:[],moved:[]})}),l.syncAndInitial),a.makeHandle((()=>e=r.removeMaybe(e)))])},o._onComputationsCollectionChange=function(e){e.added.forEach((e=>this._connectComputation(e))),e.removed.forEach((e=>this._disconnectComputation(e)))},i._createClass(t,[{key:"visible",get:function(){return this.analysisViewData.visible}},{key:"testInfo",get:function(){return{visualizations:this._lineOfSightVisualizations}}},{key:"_configuration",get:function(){return this.analysisViewData.configuration}}]),t}(o),t.__decorate([u.property({constructOnly:!0})],e.LineOfSightVisualization.prototype,"analysis",void 0),t.__decorate([u.property({constructOnly:!0})],e.LineOfSightVisualization.prototype,"analysisViewData",void 0),t.__decorate([u.property({constructOnly:!0})],e.LineOfSightVisualization.prototype,"view",void 0),t.__decorate([u.property({readOnly:!0})],e.LineOfSightVisualization.prototype,"visible",null),t.__decorate([u.property()],e.LineOfSightVisualization.prototype,"testInfo",null),t.__decorate([u.property()],e.LineOfSightVisualization.prototype,"_configuration",null),e.LineOfSightVisualization=t.__decorate([f.subclass("esri.views.3d.analysis.LineOfSight.LineOfSightVisualization")],e.LineOfSightVisualization);const _=p.create(),v=p.create(),V=p.create(),O=m.create();Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
