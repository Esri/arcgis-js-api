/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{_ as i}from"../../../../chunks/tslib.es6.js";import e from"../../../../Color.js";import t from"../../../../core/Accessor.js";import o from"../../../../core/Handles.js";import{makeHandle as n}from"../../../../core/handleUtils.js";import{equals as s}from"../../../../core/lang.js";import{destroyMaybe as r,isNone as a}from"../../../../core/maybe.js";import{watch as l,on as c,initial as u}from"../../../../core/reactiveUtils.js";import{property as d}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/accessorSupport/ensureType.js";import{subclass as m}from"../../../../core/accessorSupport/decorators/subclass.js";import{c as h}from"../../../../chunks/mat4f64.js";import{b as p}from"../../../../chunks/vec3.js";import{d as v,c as f}from"../../../../chunks/vec3f64.js";import{LineVisualElement as g}from"../../interactive/visualElements/LineVisualElement.js";import{PointVisualElement as b}from"../../interactive/visualElements/PointVisualElement.js";let V=class extends t{constructor(i){super(i),this._lineOfSightVisualizations=[],this._computationHandles=new o}initialize(){this.own(this._connectComputations()),this._createObserverVisualization()}destroy(){this._computationHandles=r(this._computationHandles),this._observerVisualElement=r(this._observerVisualElement)}get visible(){return this.analysisViewData.visible}get interactiveAndEditable(){return this.analysisViewData.interactive&&this.analysisViewData.editable}get testInfo(){return{visualizations:this._lineOfSightVisualizations}}get _configuration(){return this.analysisViewData.configuration}_createLineOfSightVisualization(){const i=this._configuration,t=this.view,o={view:t,attached:!0,width:i.outerWidth,innerWidth:i.innerWidth},n=e.toUnitRGBA(i.visibleOuterColor),s=e.toUnitRGBA(i.visibleInnerColor),r=e.toUnitRGBA(i.occludedOuterColor),a=e.toUnitRGBA(i.occludedInnerColor),l=e.toUnitRGBA(i.undefinedOuterColor),c=e.toUnitRGBA(i.undefinedInnerColor),u={visibleLineVisualElement:new g({...o,color:n,innerColor:s}),occludedLineVisualElement:new g({...o,color:r,innerColor:a}),undefinedLineVisualElement:new g({...o,color:l,innerColor:c}),targetVisualElement:new b({view:t,attached:!0,..._,size:8})};return this._lineOfSightVisualizations.push(u),u}_destroyLineOfSightVisualization(i){i.visibleLineVisualElement=r(i.visibleLineVisualElement),i.occludedLineVisualElement=r(i.occludedLineVisualElement),i.undefinedLineVisualElement=r(i.undefinedLineVisualElement),i.targetVisualElement=r(i.targetVisualElement),this._lineOfSightVisualizations.splice(this._lineOfSightVisualizations.indexOf(i),1)}_updateLineOfSightVisualization(i,t,o){const n=this._configuration,{computationResult:s,inputPoints:r}=i,{start:l,end:c,intersection:u,isValid:d,isTargetVisible:m}=s,{observer:h}=r,f=O;f[12]=h[0],f[13]=h[1],f[14]=h[2];const g=p(y,l,h),b=p(C,c,h),V=p(E,u,h),{visibleLineVisualElement:_,occludedLineVisualElement:L,undefinedLineVisualElement:A,targetVisualElement:w}=t,z=a(this.analysisViewData.elevationAlignedObserver)||a(i.elevationAlignedTargetLocation),S=this.visible&&!z;_.visible=S,L.visible=S,A.visible=S,w.visible=S,w.attached=!o.interactiveAndEditable,S&&(_.geometry=null,L.geometry=null,A.geometry=null,w.geometry=i.elevationAlignedTargetLocation,d?m?(_.geometry=[[v(g),v(b)]],_.transform=f,_.color=e.toUnitRGBA(n.visibleOuterColor),w.color=e.toUnitRGBA(n.visibleInnerColor)):(_.geometry=[[v(g),v(V)]],_.transform=f,_.color=e.toUnitRGBA(n.occludedOuterColor),L.geometry=[[v(V),v(b)]],L.transform=f,w.color=e.toUnitRGBA(n.occludedInnerColor)):(A.geometry=[[v(g),v(b)]],A.transform=f,w.color=e.toUnitRGBA(n.undefinedInnerColor)))}_getLineOfSightVisualizationDependencies(i){const{computationResult:e}=i,{occludedOuterColor:t,visibleOuterColor:o}=this._configuration;return{computationResult:e,occludedOuterColor:t,visibleOuterColor:o,visible:this.visible,interactiveAndEditable:this.interactiveAndEditable}}_connectComputation(i){const e=this._computationHandles;if(e.has(i))return;const t=this._createLineOfSightVisualization();e.add([l((()=>this._getLineOfSightVisualizationDependencies(i)),(e=>this._updateLineOfSightVisualization(i,t,e)),{sync:!0,initial:!0,equals:s}),n((()=>this._destroyLineOfSightVisualization(t)))],i)}_disconnectComputation(i){this._computationHandles.remove(i)}_connectComputations(){return c((()=>this.analysisViewData.computations),"change",(i=>this._onComputationsCollectionChange(i)),{sync:!0,onListenerAdd:i=>{for(const e of i)this._connectComputation(e)},onListenerRemove:i=>{for(const e of i)this._disconnectComputation(e)}})}_onComputationsCollectionChange({added:i,removed:e}){for(const t of e)this._disconnectComputation(t);for(const t of i)this._connectComputation(t)}_createObserverVisualization(){const i=e.toUnitRGBA(this._configuration.visibleInnerColor),t=new b({view:this.view,attached:!1,color:i,..._});this._observerVisualElement=t,this.own(l((()=>({observer:this.analysisViewData.elevationAlignedObserver,interactiveAndEditable:this.interactiveAndEditable,visible:this.visible})),(({observer:i,interactiveAndEditable:e,visible:o})=>{a(i)||e||!o?t.attached=!1:(t.geometry=i,this._observerVisualElement.attached=!0)}),u))}};i([d({constructOnly:!0})],V.prototype,"analysis",void 0),i([d({constructOnly:!0})],V.prototype,"analysisViewData",void 0),i([d({constructOnly:!0})],V.prototype,"view",void 0),i([d({readOnly:!0})],V.prototype,"visible",null),i([d()],V.prototype,"interactiveAndEditable",null),i([d()],V.prototype,"testInfo",null),i([d()],V.prototype,"_configuration",null),V=i([m("esri.views.3d.analysis.LineOfSight.LineOfSightVisualization")],V);const _={size:6,pixelSnappingEnabled:!1,primitive:"circle",elevationInfo:{mode:"absolute-height",offset:0},outlineSize:0},y=f(),C=f(),E=f(),O=h();export{V as LineOfSightVisualization};
