/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import t from"../../../../Color.js";import i from"../../../../analysis/LineOfSightAnalysisObserver.js";import r from"../../../../analysis/LineOfSightAnalysisTarget.js";import a from"../../../../core/Collection.js";import n from"../../../../core/Handles.js";import s from"../../../../core/Logger.js";import{destroyMaybe as o,isSome as l,isNone as c,applySome as u}from"../../../../core/maybe.js";import{watch as p,syncAndInitial as h,sync as d,on as g}from"../../../../core/reactiveUtils.js";import{property as m}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/arrayUtils.js";import"../../../../core/has.js";import"../../../../core/accessorSupport/ensureType.js";import{subclass as _}from"../../../../core/accessorSupport/decorators/subclass.js";import{create as v,fromPoints as b}from"../../../../geometry/support/lineSegment.js";import{getGraphicEffectiveElevationInfo as y,getConvertedElevation as f}from"../../../../support/elevationInfoUtils.js";import T from"../../../../symbols/support/ElevationInfo.js";import{LineOfSightRayIntersector as C}from"./LineOfSightRayIntersector.js";import{LineOfSightToolConfiguration as M}from"./LineOfSightToolConfiguration.js";import{createSphereManipulator as w,createSphereManipulatorRenderObjects as L}from"./lineOfSightToolUtils.js";import{LaserlineVisualElement as k}from"../../interactive/visualElements/LaserlineVisualElement.js";import{IntersectorType as V}from"../../webgl-engine/lib/IntersectorInterfaces.js";import"../../../input/ViewEvents.js";import{AnalysisToolBase as O}from"../../../interactive/AnalysisToolBase.js";import{createManipulatorDragEventPipeline as S}from"../../../interactive/dragEventPipeline.js";import{ManipulatorStateCustomFlags as D}from"../../../interactive/interfaces.js";import{createScreenPointFromEvent as E}from"../../../support/screenUtils.js";import{MouseButton as I}from"../../../input/IViewEvents.js";var R;!function(e){e.Ready="ready",e.Creating="creating",e.Created="created"}(R||(R={}));const j=a.ofType(r),P=s.getLogger("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightTool");let H=class extends O{constructor(e){super(e),this.preferManipulatorCursor=!0,this.removeIncompleteOnCancel=!1,this.configuration=new M,this.analysisViewData=null,this._laserlineVisualElement=null,this._grabbedManipulator=null,this._analysisHandles=new n,this._handles=new n,this._manipulatorHandles=new n,this._targetTrackerManipulator=null}initialize(){this._intersector=new C({view:this.view}),this._handles.add(p((()=>this.state),(e=>{e===R.Created&&this.finishToolCreation()}),h)),this._observerManipulator=this._createObserverManipulator(),this._handles.add([p((()=>({...this.configuration.observer})),(()=>this._updateObserverManipulatorStyle()),d),p((()=>this.analysisViewData.elevationAlignedObserver),(e=>this._onObserverLocationChange(e)),h),p((()=>({...this.configuration.laserLine})),(()=>this._createVisualElements()),h),p((()=>this._laserLineRendererDependencies()),(e=>this._updateLaserLineRenderer(e))),this._connectComputations()])}destroy(){this._handles=o(this._handles),this._manipulatorHandles=o(this._manipulatorHandles),this._analysisHandles=o(this._analysisHandles),this._observerManipulator=null,this._clearCursorTracker(),this._removeVisualElements(),this._intersector=null,this._set("analysis",null)}get state(){return this.active?l(this._grabbedManipulator)?R.Created:R.Creating:l(this.analysis.observer)&&l(this.analysis.observer.position)?R.Created:R.Ready}get cursor(){return this.active&&this._showTracker?"crosshair":null}get updating(){return!!l(this.analysisViewData)&&this.analysisViewData.updating}get _showTracker(){return this.active&&"mouse"===this._latestPointerMovePointerType}get _shouldRenderTracker(){return this._showTracker&&l(this.analysis.observer)&&l(this.analysis.observer.position)&&!this.hasFocusedManipulators}continue(){this.view.activeTool=this}stop(){this.view.activeTool=null}onEditableChange(){this.analysisViewData.editable=this.internallyEditable}onInputEvent(e){switch(e.type){case"immediate-double-click":this._doubleClickHandler(e);break;case"key-down":this._keyDownHandler(e);break;case"pointer-move":this._pointerMoveHandler(e)}}onInputEventAfter(e){if("immediate-click"===e.type)this._clickHandler(e)}onShow(){}onHide(){this._grabbedManipulator=null}onDeactivate(){this._clearCursorTracker()}_connectComputations(){return g((()=>this.analysisViewData.computations),"change",(e=>this._onComputationsCollectionChange(e)),{onListenerAdd:e=>{for(const t of e)this._connectComputation(t)},onListenerRemove:e=>{for(const t of e)this._disconnectComputation(t)},sync:!0})}_onComputationsCollectionChange({added:e,removed:t}){for(const i of t)this._disconnectComputation(i);for(const i of e)this._connectComputation(i)}_connectComputation(e){if(this.destroyed)return void P.warn("Attempting to connect an analysis to a destroyed LineOfSight tool. Ignoring.");const t=this._analysisHandles;if(t.has(e))return;const i=this._createTargetManipulator(e.target);c(this._targetTrackerManipulator)&&i.metadata.target===this.analysisViewData.cursorTarget&&(this._targetTrackerManipulator=i,this._targetTrackerManipulator.available=!1,this._targetTrackerManipulator.interactive=!1,this._updateLaserLineRenderer()),t.add([p((()=>this._getLineOfSightManipulatorStateDependencies(e)),(()=>this._updateManipulatorState(i,e)),h),p((()=>e.elevationAlignedTargetLocation),(e=>this._onTargetLocationChange(e,i)),h)],e)}_disconnectComputation(e){if(this.destroyed)return void P.warn("Attempting to disconnect an analysis from a destroyed LineOfSight tool. Ignoring.");this._analysisHandles.remove(e);const t=this._getTargetManipulator(e.target);l(t)&&(this.manipulators.remove(t),this._manipulatorHandles.remove(t),l(this._targetTrackerManipulator)&&this._targetTrackerManipulator===t&&(this._targetTrackerManipulator=null))}_clearCursorTracker(){this.analysisViewData.cursorTarget=o(this.analysisViewData.cursorTarget)}_createManipulator(e,t,i){const r=w(this.view,e);return r.metadata=i,this._manipulatorHandles.add([t(r),r.events.on("grab-changed",(e=>this._manipulatorGrabChanged(r,e))),r.events.on("immediate-click",(e=>this._manipulatorClick(r,e)))],r),this.manipulators.add(r),r}_createTargetManipulator(e){const t=this.configuration,i={size:t.target.size,customColor1:t.target.visibleColor,customColor2:t.target.occludedColor,customColor3:t.target.undefinedColor,visible:!0},r={target:e,type:"target"},a=this._createManipulator(i,(e=>this._createTargetManipulatorDragPipeline(e)),r);return l(e.position)?a.elevationAlignedLocation=e.position:a.available=!1,a}_getTargetManipulator(e){let t=null;return this.manipulators.forEach((i=>{const r=i.manipulator;c(t)&&"target"===r.metadata.type&&r.metadata.target===e&&(t=r)})),t}_createObserverManipulator(){const e=this.configuration,t={size:e.observer.size,color:e.observer.color,visible:!0};return this._createManipulator(t,(e=>this._createObserverManipulatorDragPipeline(e)),{type:"observer",intersection:null})}_updateObserverManipulatorStyle(){const e=this._observerManipulator,t=this.configuration.observer,i={size:t.size,color:t.color,visible:e.available};e.renderObjects=L(i)}_screenToIntersection(){return e=>{const t=this._intersector.getScreenPointIntersection(e.screenEnd);return c(t)?null:{...e,intersection:t}}}_createTargetManipulatorDragPipeline(e){return S(e,((t,i,r)=>{i.next(this._screenToIntersection()).next(this._updateTargetDragStep(e)).next((()=>this._updateLaserLineRenderer())),r.next(this._cancelTargetDragStep(e.metadata.target)).next((()=>this._updateLaserLineRenderer()))}))}_createObserverManipulatorDragPipeline(e){return S(e,((e,t,i)=>{t.next(this._screenToIntersection()).next(this._updateObserverDragStep()).next((()=>this._updateLaserLineRenderer())),i.next(this._cancelObserverDragStep()).next((()=>this._updateLaserLineRenderer()))}))}_updateObserverDragStep(){return e=>(l(e.intersection.point)?(c(this.analysis.observer)&&(this.analysis.observer=new i),this._updateFromIntersection(this.analysis.observer,e.intersection)):this.analysis.observer=null,e)}_cancelObserverDragStep(){const e=l(this.analysis.observer)&&l(this.analysis.observer.position)?this.analysis.observer.clone():null;return t=>(this.analysis.observer=e,t)}_updateTargetDragStep(e){return t=>{this._updateFromIntersection(e.metadata.target,t.intersection);const i=t.intersection.point;return l(i)&&(e.elevationAlignedLocation=i),t}}_cancelTargetDragStep(e){const t=u(e.position,(e=>e.clone()));return i=>(e.position=t,i)}_manipulatorGrabChanged(e,t){switch(t.action){case"start":this._grabbedManipulator=e;break;case"end":this._grabbedManipulator===e&&(this._grabbedManipulator=null)}}_updateManipulatorState(e,t){const{isValid:i,isTargetVisible:r}=t.computationResult;e.state=i?r?D.Custom1:D.Custom2:D.Custom3}_getLineOfSightManipulatorStateDependencies(e){const{isValid:t,isTargetVisible:i}=e.computationResult;return{isValid:t,isTargetVisible:i}}_laserLineRendererDependencies(){return{laserlineVisualElement:this._laserlineVisualElement,grabbedManipulator:this._grabbedManipulator,shouldRenderTracker:this._shouldRenderTracker,observerPosition:l(this.analysis.observer)?this.analysis.observer.position:null,visible:this.visible}}_updateLaserLineRenderer(e=this._laserLineRendererDependencies()){const{laserlineVisualElement:t,grabbedManipulator:i,shouldRenderTracker:r,observerPosition:a,visible:n}=e;if(c(t))return;const s=l(i)?i:r&&l(a)?this._targetTrackerManipulator:null;this.configuration.laserLine.enabled&&l(s)&&n?(t.visible=!0,t.heightManifoldTarget=s.renderLocation,s!==this._observerManipulator?t.lineVerticalPlaneSegment=b(this._observerManipulator.renderLocation,s.renderLocation,A):t.lineVerticalPlaneSegment=null):(t.visible=!1,t.heightManifoldTarget=null,t.lineVerticalPlaneSegment=null)}_createVisualElements(){const e=this.configuration.laserLine;this._removeVisualElements(),this._laserlineVisualElement=new k({view:this.view,attached:!0,visible:this.visible,style:{glowColor:t.toUnitRGB(e.glowColor),glowWidth:e.glowWidth,innerColor:t.toUnitRGB(e.innerColor),innerWidth:e.innerWidth,globalAlpha:e.globalAlpha}})}_removeVisualElements(){l(this._laserlineVisualElement)&&(this._laserlineVisualElement.destroy(),this._laserlineVisualElement=null)}_onObserverLocationChange(e){c(e)?this._observerManipulator.available=!1:(this._observerManipulator.metadata.intersection=null,this._observerManipulator.available=!0,this._observerManipulator.elevationAlignedLocation=e)}_onTargetLocationChange(e,t){l(e)?(t.elevationAlignedLocation=e,t!==this._targetTrackerManipulator&&(t.available=!0)):t.available=!1}_addPointFromClickEvent(e){const t=this._intersector.getScreenPointIntersection(e);if(!c(t)&&!c(t.point))if(l(this.analysis.observer)&&l(this.analysis.observer.position)){this._clearCursorTracker();const e=new r;this._updateFromIntersection(e,t),this.analysis.targets.add(e)}else{const e=new i;this._updateFromIntersection(e,t),this.analysis.observer=e}}_clickHandler(e){this.active&&e.button!==I.Right&&(this._addPointFromClickEvent(E(e)),e.stopPropagation())}_doubleClickHandler(e){this.active&&e.button!==I.Right&&(this.stop(),e.stopPropagation())}_keyDownHandler(e){this.active&&"Escape"===e.key&&(this.stop(),e.stopPropagation())}_pointerMoveHandler(e){if(this.hasFocusedManipulators)return;if(this._latestPointerMovePointerType=e.pointerType,this._updateLaserLineRenderer(),!this._showTracker||c(this.analysis.observer)||c(this.analysis.observer.position))return;const t=E(e),i=this._intersector.getScreenPointIntersection(t);l(i)&&l(i.point)&&(c(this.analysisViewData.cursorTarget)&&(this.analysisViewData.cursorTarget=new r),this._updateFromIntersection(this.analysisViewData.cursorTarget,i),this._updateLaserLineRenderer())}_updateFromIntersection(e,t){if(c(t.point))return e.position=null,e.elevationInfo=null,void(e.feature=null);switch(t.type){case V.OBJECT:if(l(t.graphic)){const i=t.graphic,r=y(i);"on-the-ground"===r.mode&&(r.mode="relative-to-ground",r.offset=0),e.elevationInfo=new T(r),e.feature=i}else e.elevationInfo=null,e.feature=null;break;case V.TERRAIN:case V.I3S:e.elevationInfo=new T({mode:"on-the-ground"}),e.feature=null;break;default:e.elevationInfo=null,e.feature=null}const i=t.point.clone();i.z=f(this.view,i,{mode:"absolute-height",offset:0},e.elevationInfo),e.position=i}_manipulatorClick(e,t){if("observer"===e.metadata.type||e.grabbing||e.dragging||t.button!==I.Right||this.analysis.targets.length<=1)return;const{target:i}=e.metadata;this.analysis.targets.remove(i),t.stopPropagation()}get testInfo(){return{laserLineVisualElement:this._laserlineVisualElement}}};e([m({constructOnly:!0})],H.prototype,"view",void 0),e([m({constructOnly:!0})],H.prototype,"analysis",void 0),e([m({readOnly:!0})],H.prototype,"state",null),e([m({readOnly:!0})],H.prototype,"cursor",null),e([m({readOnly:!0})],H.prototype,"preferManipulatorCursor",void 0),e([m()],H.prototype,"removeIncompleteOnCancel",void 0),e([m({readOnly:!0})],H.prototype,"updating",null),e([m({type:M})],H.prototype,"configuration",void 0),e([m({constructOnly:!0})],H.prototype,"analysisViewData",void 0),e([m({readOnly:!0})],H.prototype,"_showTracker",null),e([m()],H.prototype,"_latestPointerMovePointerType",void 0),e([m()],H.prototype,"_shouldRenderTracker",null),e([m()],H.prototype,"_laserlineVisualElement",void 0),e([m()],H.prototype,"_grabbedManipulator",void 0),H=e([_("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightTool")],H);const A=v();export{j as LineOfSightTargetCollection,H as LineOfSightTool};
