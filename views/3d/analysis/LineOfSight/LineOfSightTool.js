/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../Color","../../../../analysis/LineOfSightAnalysisObserver","../../../../analysis/LineOfSightAnalysisTarget","../../../../core/Handles","../../../../core/Logger","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/accessorSupport/decorators/subclass","../../../../core/support/WatchUpdatingTracking","../../../../geometry/support/lineSegment","../../../../support/elevationInfoUtils","../../../../symbols/support/ElevationInfo","./LineOfSightRayIntersector","./LineOfSightToolConfiguration","./lineOfSightToolUtils","../../interactive/visualElements/LaserlineVisualElement","../../webgl-engine/lib/IntersectorInterfaces","../../../input/ViewEvents","../../../interactive/AnalysisToolBase","../../../interactive/dragEventPipeline","../../../interactive/interfaces","../../../support/screenUtils","../../../input/IViewEvents"],(function(e,t,i,n,a,r,o,s,l,c,u,h,p,d,g,_,v,f,y,m,b,T,S,M,L,C,w,O,k){"use strict";var V;!function(e){e.Ready="ready",e.Creating="creating",e.Created="created"}(V||(V={})),e.LineOfSightTool=function(e){function i(t){var i;return(i=e.call(this,t)||this).removeIncompleteOnCancel=!1,i.configuration=new m.LineOfSightToolConfiguration,i.analysisViewData=null,i._latestPointerMovePointerType=null,i._laserlineVisualElement=null,i._grabbedManipulator=null,i._analysisHandles=new o,i._handles=new o,i._updatingHandles=new g.WatchUpdatingTracking,i._manipulatorHandles=new o,i._targetTrackerManipulator=null,i}t._inheritsLoose(i,e);var u=i.prototype;return u.initialize=function(){this._intersector=new y.LineOfSightRayIntersector({view:this.view}),this._handles.add(c.watch((()=>this.state),(e=>{e===V.Created&&this.finishToolCreation()}),c.syncAndInitial)),this._observerManipulator=this._createObserverManipulator(),this._handles.add([this._updatingHandles.add((()=>({...this.configuration.observer})),(()=>this._updateObserverManipulatorStyle())),this._updatingHandles.add((()=>this.analysisViewData?.elevationAlignedObserver),(e=>this._onObserverLocationChange(e)),c.initial),this._updatingHandles.add((()=>({...this.configuration.laserLine})),(()=>this._createVisualElements()),c.initial),this._updatingHandles.add((()=>this._laserLineRendererDependencies()),(e=>this._updateLaserLineRenderer(e))),this._connectComputations(),this._updatingHandles.addWhen((()=>!this._shouldRenderTracker),(()=>this._clearCursorTracker()),c.initial)])},u.destroy=function(){this._updatingHandles=l.destroyMaybe(this._updatingHandles),this._handles=l.destroyMaybe(this._handles),this._manipulatorHandles=l.destroyMaybe(this._manipulatorHandles),this._analysisHandles=l.destroyMaybe(this._analysisHandles),this._observerManipulator=null,this._clearCursorTracker(),this._removeVisualElements(),this._intersector=null,this._set("analysis",null)},u.continue=function(){this.view.activeTool=this},u.stop=function(){this.view.activeTool=null},u.onEditableChange=function(){this.analysisViewData.editable=this.internallyEditable},u.onInputEvent=function(e){switch(e.type){case"immediate-double-click":this._doubleClickHandler(e);break;case"key-down":this._keyDownHandler(e);break;case"pointer-move":this._pointerMoveHandler(e)}},u.onInputEventAfter=function(e){if("immediate-click"===e.type)this._clickHandler(e)},u.onShow=function(){},u.onHide=function(){},u.onDeactivate=function(){this._clearCursorTracker()},u._connectComputations=function(){return this._updatingHandles.addOnCollectionChange((()=>this.analysisViewData.computations),(e=>this._onComputationsCollectionChange(e)),{initial:!0,final:!0})},u._onComputationsCollectionChange=function({added:e,removed:t}){for(const i of t)this._disconnectComputation(i);for(const i of e)this._connectComputation(i)},u._connectComputation=function(e){if(this.destroyed)return void s.getLogger(this.declaredClass).warn("Attempting to connect an analysis to a destroyed LineOfSight tool. Ignoring.");const t=this._analysisHandles;if(t.has(e))return;const i=this._createTargetManipulator(e.target);l.isNone(this._targetTrackerManipulator)&&i.metadata.target===this.analysisViewData.cursorTarget&&(this._targetTrackerManipulator=i,this._targetTrackerManipulator.available=!1,this._targetTrackerManipulator.interactive=!1,this._updateLaserLineRenderer()),t.add([this._updatingHandles.add((()=>this._getLineOfSightManipulatorStateDependencies(e)),(()=>this._updateManipulatorState(i,e)),c.initial),this._updatingHandles.add((()=>e.elevationAlignedTargetLocation),(e=>this._onTargetLocationChange(e,i)),c.initial)],e)},u._disconnectComputation=function(e){if(this.destroyed)return void s.getLogger(this.declaredClass).warn("Attempting to disconnect an analysis from a destroyed LineOfSight tool. Ignoring.");this._analysisHandles.remove(e);const t=this._getTargetManipulator(e.target);l.isSome(t)&&(this.manipulators.remove(t),this._manipulatorHandles.remove(t),l.isSome(this._targetTrackerManipulator)&&this._targetTrackerManipulator===t&&(this._targetTrackerManipulator=null))},u._clearCursorTracker=function(){this.analysisViewData.cursorTarget=l.destroyMaybe(this.analysisViewData.cursorTarget)},u._createManipulator=function(e,t,i){const n=b.createSphereManipulator(this.view,e);return n.metadata=i,this._manipulatorHandles.add([t(n),n.events.on("grab-changed",(e=>this._manipulatorGrabChanged(n,e))),n.events.on("immediate-click",(e=>this._manipulatorClick(n,e)))],n),this.manipulators.add(n),n},u._createTargetManipulator=function(e){const t=this.configuration,i={size:t.target.size,customColor1:t.target.visibleColor,customColor2:t.target.occludedColor,customColor3:t.target.undefinedColor,visible:!0},n={target:e,type:"target"},a=this._createManipulator(i,(e=>this._createTargetManipulatorDragPipeline(e)),n);return l.isSome(e.position)?a.elevationAlignedLocation=e.position:a.available=!1,a},u._getTargetManipulator=function(e){let t=null;return this.manipulators.forEach((i=>{const n=i.manipulator;l.isNone(t)&&"target"===n.metadata.type&&n.metadata.target===e&&(t=n)})),t},u._createObserverManipulator=function(){const e=this.configuration,t={size:e.observer.size,color:e.observer.color,visible:!0};return this._createManipulator(t,(e=>this._createObserverManipulatorDragPipeline(e)),{type:"observer",intersection:null})},u._updateObserverManipulatorStyle=function(){const e=this._observerManipulator,t=this.configuration.observer,i={size:t.size,color:t.color,visible:e.available};e.renderObjects=b.createSphereManipulatorRenderObjects(i)},u._screenToIntersection=function(){return e=>{const t=this._intersector.getScreenPointIntersection(e.screenEnd);return l.isNone(t)?null:{...e,intersection:t}}},u._createTargetManipulatorDragPipeline=function(e){return C.createManipulatorDragEventPipeline(e,((t,i,n)=>{i.next(this._screenToIntersection()).next(this._updateTargetDragStep(e)).next((()=>this._updateLaserLineRenderer())),n.next(this._cancelTargetDragStep(e.metadata.target)).next((()=>this._updateLaserLineRenderer()))}))},u._createObserverManipulatorDragPipeline=function(e){return C.createManipulatorDragEventPipeline(e,((e,t,i)=>{t.next(this._screenToIntersection()).next(this._updateObserverDragStep()).next((()=>this._updateLaserLineRenderer())),i.next(this._cancelObserverDragStep()).next((()=>this._updateLaserLineRenderer()))}))},u._updateObserverDragStep=function(){return e=>(l.isSome(e.intersection.mapPoint)?(l.isNone(this.analysis.observer)&&(this.analysis.observer=new a),this._updateFromIntersection(this.analysis.observer,e.intersection)):this.analysis.observer=null,e)},u._cancelObserverDragStep=function(){const e=l.isSome(this.analysis.observer)&&l.isSome(this.analysis.observer.position)?this.analysis.observer.clone():null;return t=>(this.analysis.observer=e,t)},u._updateTargetDragStep=function(e){return t=>{this._updateFromIntersection(e.metadata.target,t.intersection);const i=t.intersection.mapPoint;return l.isSome(i)&&(e.elevationAlignedLocation=i),t}},u._cancelTargetDragStep=function(e){const t=l.applySome(e.position,(e=>e.clone()));return i=>(e.position=t,i)},u._manipulatorGrabChanged=function(e,t){switch(t.action){case"start":this._grabbedManipulator=e;break;case"end":this._grabbedManipulator===e&&(this._grabbedManipulator=null)}},u._updateManipulatorState=function(e,t){const{isValid:i,isTargetVisible:n}=t.computationResult;e.state=i?n?w.ManipulatorStateCustomFlags.Custom1:w.ManipulatorStateCustomFlags.Custom2:w.ManipulatorStateCustomFlags.Custom3},u._getLineOfSightManipulatorStateDependencies=function(e){const{isValid:t,isTargetVisible:i}=e.computationResult;return{isValid:t,isTargetVisible:i}},u._laserLineRendererDependencies=function(){return{laserlineVisualElement:this._laserlineVisualElement,grabbedManipulator:this._grabbedManipulator,shouldRenderTracker:this._shouldRenderTracker,observerPosition:l.isSome(this.analysis.observer)?this.analysis.observer.position:null,visible:this.visible}},u._updateLaserLineRenderer=function(e=this._laserLineRendererDependencies()){const{laserlineVisualElement:t,grabbedManipulator:i,shouldRenderTracker:n,observerPosition:a,visible:r}=e;if(l.isNone(t))return;const o=l.isSome(i)?i:n&&l.isSome(a)?this._targetTrackerManipulator:null;this.configuration.laserLine.enabled&&l.isSome(o)&&r?(t.visible=!0,t.heightManifoldTarget=o.renderLocation,o!==this._observerManipulator?t.lineVerticalPlaneSegment=_.fromPoints(this._observerManipulator.renderLocation,o.renderLocation,E):t.lineVerticalPlaneSegment=null):(t.visible=!1,t.heightManifoldTarget=null,t.lineVerticalPlaneSegment=null)},u._createVisualElements=function(){const e=this.configuration.laserLine;this._removeVisualElements(),this._laserlineVisualElement=new T.LaserlineVisualElement({view:this.view,attached:!0,visible:this.visible,style:{glowColor:n.toUnitRGB(e.glowColor),glowWidth:e.glowWidth,innerColor:n.toUnitRGB(e.innerColor),innerWidth:e.innerWidth,globalAlpha:e.globalAlpha}})},u._removeVisualElements=function(){l.isSome(this._laserlineVisualElement)&&(this._laserlineVisualElement.destroy(),this._laserlineVisualElement=null)},u._onObserverLocationChange=function(e){l.isNone(e)?this._observerManipulator.available=!1:(this._observerManipulator.metadata.intersection=null,this._observerManipulator.available=!0,this._observerManipulator.elevationAlignedLocation=e)},u._onTargetLocationChange=function(e,t){l.isSome(e)?(t.elevationAlignedLocation=e,t!==this._targetTrackerManipulator&&(t.available=!0)):t.available=!1},u._addPointFromClickEvent=function(e){const t=this._intersector.getScreenPointIntersection(e);if(!l.isNone(t)&&!l.isNone(t.mapPoint))if(l.isSome(this.analysis.observer)&&l.isSome(this.analysis.observer.position)){this._clearCursorTracker();const e=new r;this._updateFromIntersection(e,t),this.analysis.targets.add(e)}else{const e=new a;this._updateFromIntersection(e,t),this.analysis.observer=e}},u._clickHandler=function(e){this.active&&e.button!==k.MouseButton.Right&&(this._addPointFromClickEvent(O.createScreenPointFromEvent(e)),e.stopPropagation())},u._doubleClickHandler=function(e){this.active&&e.button!==k.MouseButton.Right&&(this.stop(),e.stopPropagation())},u._keyDownHandler=function(e){this.active&&"Escape"===e.key&&(this.stop(),e.stopPropagation())},u._pointerMoveHandler=function(e){if(this.hasGrabbedManipulators)return;if(this._latestPointerMovePointerType=e.pointerType,this._updateLaserLineRenderer(),!this._showTracker||l.isNone(this.analysis.observer)||l.isNone(this.analysis.observer.position))return;const t=O.createScreenPointFromEvent(e),i=this._intersector.getScreenPointIntersection(t);l.isSome(i)&&l.isSome(i.mapPoint)&&(l.isNone(this.analysisViewData.cursorTarget)&&(this.analysisViewData.cursorTarget=new r),this._updateFromIntersection(this.analysisViewData.cursorTarget,i),this._updateLaserLineRenderer())},u._updateFromIntersection=function(e,t){if(l.isNone(t.mapPoint))return e.position=null,e.elevationInfo=null,void(e.feature=null);switch(t.type){case S.IntersectorType.OBJECT:if(l.isSome(t.graphic)){const i=t.graphic,n=v.getGraphicEffectiveElevationInfo(i);"on-the-ground"===n.mode&&(n.mode="relative-to-ground",n.offset=0),e.elevationInfo=new f(n),e.feature=i}else e.elevationInfo=null,e.feature=null;break;case S.IntersectorType.TERRAIN:case S.IntersectorType.I3S:e.elevationInfo=new f({mode:"on-the-ground"}),e.feature=null;break;default:e.elevationInfo=null,e.feature=null}const i=t.mapPoint.clone();i.z=v.getConvertedElevation(this.view,i,{mode:"absolute-height",offset:0},e.elevationInfo),e.position=i},u._manipulatorClick=function(e,t){if("observer"===e.metadata.type||e.grabbing||e.dragging||t.button!==k.MouseButton.Right||this.analysis.targets.length<=1)return;const{target:i}=e.metadata;this.analysis.targets.remove(i),t.stopPropagation()},t._createClass(i,[{key:"state",get:function(){return this.active?this.hasGrabbedManipulators?V.Created:V.Creating:l.isSome(this.analysis.observer)&&l.isSome(this.analysis.observer.position)?V.Created:V.Ready}},{key:"cursor",get:function(){return this.active&&this._showTracker?"crosshair":null}},{key:"updating",get:function(){return l.isSome(this.analysisViewData)&&this.analysisViewData.updating||this._updatingHandles.updating}},{key:"_showTracker",get:function(){return this.active&&"mouse"===this._latestPointerMovePointerType}},{key:"_shouldRenderTracker",get:function(){return this._showTracker&&l.isSome(this.analysis.observer)&&l.isSome(this.analysis.observer.position)&&!this.hasGrabbedManipulators}},{key:"testInfo",get:function(){return{laserLineVisualElement:this._laserlineVisualElement}}}]),i}(L.AnalysisToolBase),i.__decorate([u.property({constructOnly:!0})],e.LineOfSightTool.prototype,"view",void 0),i.__decorate([u.property({constructOnly:!0})],e.LineOfSightTool.prototype,"analysis",void 0),i.__decorate([u.property({readOnly:!0})],e.LineOfSightTool.prototype,"state",null),i.__decorate([u.property({readOnly:!0})],e.LineOfSightTool.prototype,"cursor",null),i.__decorate([u.property()],e.LineOfSightTool.prototype,"removeIncompleteOnCancel",void 0),i.__decorate([u.property({readOnly:!0})],e.LineOfSightTool.prototype,"updating",null),i.__decorate([u.property({type:m.LineOfSightToolConfiguration})],e.LineOfSightTool.prototype,"configuration",void 0),i.__decorate([u.property({constructOnly:!0})],e.LineOfSightTool.prototype,"analysisViewData",void 0),i.__decorate([u.property({readOnly:!0})],e.LineOfSightTool.prototype,"_showTracker",null),i.__decorate([u.property()],e.LineOfSightTool.prototype,"_latestPointerMovePointerType",void 0),i.__decorate([u.property()],e.LineOfSightTool.prototype,"_shouldRenderTracker",null),i.__decorate([u.property()],e.LineOfSightTool.prototype,"_laserlineVisualElement",void 0),i.__decorate([u.property()],e.LineOfSightTool.prototype,"_grabbedManipulator",void 0),e.LineOfSightTool=i.__decorate([d.subclass("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightTool")],e.LineOfSightTool);const E=_.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
