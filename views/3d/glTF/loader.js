/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../core/maybe","../../../core/promiseUtils","../../../chunks/mat4f64","./DefaultErrorContext","./LoaderResult","./internal/Resource"],(function(e,t,o,r,s,a,n){"use strict";let i=0;function l(e){const o=e.json;let r=null;return o.nodes.forEach((e=>{const o=e.extras;t.isSome(o)&&(o.ESRI_proxyEllipsoid||o.ESRI_lod)&&(r=o)})),r}function u(e){return e.extensions&&e.extensions.MSFT_lod&&Array.isArray(e.extensions.MSFT_lod.ids)}function c(e,t,o){const r=t=>{const r=`${o}_tex_${t&&t.id}${t&&t.name?"_"+t.name:""}`;if(t&&!e.textures.has(r)){const o=a.makeTextureSource(t.data,{wrap:{s:d(t.wrapS),t:d(t.wrapT)},mipmap:p.some((e=>e===t.minFilter)),noUnpackFlip:!0});e.textures.set(r,o)}return r},s=`${o}_mat_${t.id}_${t.name}`;if(!e.materials.has(s)){const o=a.makeMaterialParameters({color:[t.color[0],t.color[1],t.color[2]],opacity:t.color[3],alphaMode:t.alphaMode,alphaCutoff:t.alphaCutoff,doubleSided:t.doubleSided,colorMixMode:t.ESRI_externalColorMixMode,textureColor:t.colorTexture?r(t.colorTexture):void 0,textureNormal:t.normalTexture?r(t.normalTexture):void 0,textureOcclusion:t.occlusionTexture?r(t.occlusionTexture):void 0,textureEmissive:t.emissiveTexture?r(t.emissiveTexture):void 0,textureMetallicRoughness:t.metallicRoughnessTexture?r(t.metallicRoughnessTexture):void 0,emissiveFactor:[t.emissiveFactor[0],t.emissiveFactor[1],t.emissiveFactor[2]],metallicFactor:t.metallicFactor,roughnessFactor:t.roughnessFactor});e.materials.set(s,o)}return s}function d(e){if(33071===e||33648===e||10497===e)return e;m.error(`Unexpected TextureSampler WrapMode: ${e}`)}const m=new s.DefaultErrorContext,p=[9987,9985],x=["POINTS","LINES","LINE_LOOP","LINE_STRIP","TRIANGLES","TRIANGLE_STRIP","TRIANGLE_FAN"];e.load=async function(e,s,a={}){const d=await n.Resource.load(e,m,s,a),p="gltf_"+i++,f={lods:[],materials:new Map,textures:new Map,meta:l(d)},h=!(!d.json.asset.extras||"symbolResource"!==d.json.asset.extras.ESRI_type);return await async function(e,t){const r=e.json,s=r.scenes[r.scene||0].nodes,a=s.length>1;for(const e of s){const t=r.nodes[e],s=[n(e,0)];if(u(t)&&!a){const e=t.extensions.MSFT_lod.ids;s.push(...e.map(((e,t)=>n(e,t+1))))}await o.all(s)}async function n(o,s){const a=r.nodes[o],i=e.getNodeTransform(o);if(m.warnUnsupportedIf(null!=a.weights,"Morph targets are not supported."),null!=a.mesh){const e=r.meshes[a.mesh];for(const o of e.primitives)await t(o,i,s,e.name)}for(const e of a.children||[])await n(e,s)}}(d,(async(e,o,s,n)=>{const i=void 0!==e.mode?e.mode:4,l=function(e){switch(e){case 4:case 5:case 6:return e;default:return null}}(i);if(t.isNone(l))return void m.warnUnsupported("Unsupported primitive mode ("+x[i]+"). Skipping primitive.");if(!d.hasPositions(e))return void m.warn("Skipping primitive without POSITION vertex attribute.");const u=await d.getMaterial(e,a),h={transform:r.clone(o),attributes:{position:await d.getPositionData(e,a),normal:null,texCoord0:null,color:null,tangent:null},indices:await d.getIndexData(e,a),primitiveType:l,material:c(f,u,p)};d.hasNormals(e)&&(h.attributes.normal=await d.getNormalData(e,a)),d.hasTangents(e)&&(h.attributes.tangent=await d.getTangentData(e,a)),d.hasTextureCoordinates(e)&&(h.attributes.texCoord0=await d.getTextureCoordinates(e,a)),d.hasVertexColors(e)&&(h.attributes.color=await d.getVertexColors(e,a));let T=null;t.isSome(f.meta)&&t.isSome(f.meta.ESRI_lod)&&"screenSpaceRadius"===f.meta.ESRI_lod.metric&&(T=f.meta.ESRI_lod.thresholds[s]),f.lods[s]=f.lods[s]||{parts:[],name:n,lodThreshold:T},f.lods[s].parts.push(h)})),{model:f,meta:{isEsriSymbolResource:h,uri:d.uri},customMeta:{}}},Object.defineProperty(e,"__esModule",{value:!0})}));
