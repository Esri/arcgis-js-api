/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../core/maybe","../../../chunks/mat4f64","./DefaultErrorContext","./LoaderResult","./internal/Resource"],(function(e,t,o,r,s,a){"use strict";let n=0;async function i(e,r,s={},i=!0){const d=await a.Resource.load(e,x,r,s),p="gltf_"+n++,f={lods:[],materials:new Map,textures:new Map,meta:u(d)},T=!(!d.json.asset.extras||"symbolResource"!==d.json.asset.extras.ESRI_type);return await c(d,(async(e,r,a,n)=>{const u=void 0!==e.mode?e.mode:4,c=l(u);if(t.isNone(c))return void x.warnUnsupported("Unsupported primitive mode ("+h[u]+"). Skipping primitive.");if(!d.hasPositions(e))return void x.warn("Skipping primitive without POSITION vertex attribute.");const T=await d.getMaterial(e,s,i),S={transform:o.clone(r),attributes:{position:await d.getPositionData(e,s),normal:null,texCoord0:null,color:null,tangent:null},indices:await d.getIndexData(e,s),primitiveType:c,material:m(f,T,p)};d.hasNormals(e)&&(S.attributes.normal=await d.getNormalData(e,s)),d.hasTangents(e)&&(S.attributes.tangent=await d.getTangentData(e,s)),d.hasTextureCoordinates(e)&&(S.attributes.texCoord0=await d.getTextureCoordinates(e,s)),d.hasVertexColors(e)&&(S.attributes.color=await d.getVertexColors(e,s));let w=null;t.isSome(f.meta)&&t.isSome(f.meta.ESRI_lod)&&"screenSpaceRadius"===f.meta.ESRI_lod.metric&&(w=f.meta.ESRI_lod.thresholds[a]),f.lods[a]=f.lods[a]||{parts:[],name:n,lodThreshold:w},f.lods[a].parts.push(S)})),{model:f,meta:{isEsriSymbolResource:T,uri:d.uri},customMeta:{}}}function l(e){switch(e){case 4:case 5:case 6:return e;default:return null}}function u(e){const o=e.json;let r=null;return o.nodes.forEach((e=>{const o=e.extras;t.isSome(o)&&(o.ESRI_proxyEllipsoid||o.ESRI_lod)&&(r=o)})),r}async function c(e,t){const o=e.json,r=o.scenes[o.scene||0].nodes,s=r.length>1;for(const n of r){const e=o.nodes[n],t=[a(n,0)];if(d(e)&&!s){const o=e.extensions.MSFT_lod.ids;t.push(...o.map(((e,t)=>a(e,t+1))))}await Promise.all(t)}async function a(r,s){const n=o.nodes[r],i=e.getNodeTransform(r);if(x.warnUnsupportedIf(null!=n.weights,"Morph targets are not supported."),null!=n.mesh){const e=o.meshes[n.mesh];for(const o of e.primitives)await t(o,i,s,e.name)}for(const e of n.children||[])await a(e,s)}}function d(e){return e.extensions&&e.extensions.MSFT_lod&&Array.isArray(e.extensions.MSFT_lod.ids)}function m(e,t,o){const r=t=>{const r=`${o}_tex_${t&&t.id}${t&&t.name?"_"+t.name:""}`;if(t&&!e.textures.has(r)){const o=s.makeTextureSource(t.data,{wrap:{s:p(t.wrapS),t:p(t.wrapT)},mipmap:f.some((e=>e===t.minFilter)),noUnpackFlip:!0});e.textures.set(r,o)}return r},a=`${o}_mat_${t.id}_${t.name}`;if(!e.materials.has(a)){const o=s.makeMaterialParameters({color:[t.color[0],t.color[1],t.color[2]],opacity:t.color[3],alphaMode:t.alphaMode,alphaCutoff:t.alphaCutoff,doubleSided:t.doubleSided,colorMixMode:t.ESRI_externalColorMixMode,textureColor:t.colorTexture?r(t.colorTexture):void 0,textureNormal:t.normalTexture?r(t.normalTexture):void 0,textureOcclusion:t.occlusionTexture?r(t.occlusionTexture):void 0,textureEmissive:t.emissiveTexture?r(t.emissiveTexture):void 0,textureMetallicRoughness:t.metallicRoughnessTexture?r(t.metallicRoughnessTexture):void 0,emissiveFactor:[t.emissiveFactor[0],t.emissiveFactor[1],t.emissiveFactor[2]],metallicFactor:t.metallicFactor,roughnessFactor:t.roughnessFactor});e.materials.set(a,o)}return a}function p(e){if(33071===e||33648===e||10497===e)return e;x.error(`Unexpected TextureSampler WrapMode: ${e}`)}const x=new r.DefaultErrorContext,f=[9987,9985],h=["POINTS","LINES","LINE_LOOP","LINE_STRIP","TRIANGLES","TRIANGLE_STRIP","TRIANGLE_FAN"];e.load=i,Object.defineProperty(e,"__esModule",{value:!0})}));
