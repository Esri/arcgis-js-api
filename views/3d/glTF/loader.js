/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/Logger","../../../core/maybe","../../../chunks/mat4f64","./LoaderResult","./internal/Resource","../../webgl/enums"],(function(e,t,o,r,s,n,i,a){"use strict";let l=0;function u(e,t){return c.apply(this,arguments)}function c(){return c=t._asyncToGenerator((function*(e,n,u={},c=!0){const p=yield i.GLTFResource.load(e,n,u),T="gltf_"+l++,x={lods:[],materials:new Map,textures:new Map,meta:m(p)},g=!(!p.json.asset.extras||"symbolResource"!==p.json.asset.extras.ESRI_type),h=new Map;yield d(p,function(){var e=t._asyncToGenerator((function*(e,t,n,i){const l=h.get(n)??0;h.set(n,l+1);const m=void 0!==e.mode?e.mode:a.PrimitiveType.TRIANGLES,d=m===a.PrimitiveType.TRIANGLES||m===a.PrimitiveType.TRIANGLE_STRIP||m===a.PrimitiveType.TRIANGLE_FAN?m:null;if(r.isNone(d))return void o.getLogger("esri.views.3d.glTF").warn("[Unsupported Feature] Unsupported primitive mode ("+a.PrimitiveType[m]+"). Skipping primitive.");if(!p.hasPositions(e))return void o.getLogger("esri.views.3d.glTF").warn("Skipping primitive without POSITION vertex attribute.");const g=p.getPositionData(e,u),y=p.getMaterial(e,u,c),v=p.hasNormals(e)?p.getNormalData(e,u):null,S=p.hasTangents(e)?p.getTangentData(e,u):null,_=p.hasTextureCoordinates(e)?p.getTextureCoordinates(e,u):null,R=p.hasVertexColors(e)?p.getVertexColors(e,u):null,M=p.getIndexData(e,u),E={transform:s.clone(t),attributes:{position:yield g,normal:v?yield v:null,texCoord0:_?yield _:null,color:R?yield R:null,tangent:S?yield S:null},indices:yield M,primitiveType:d,material:f(x,yield y,T)};let F=null;r.isSome(x.meta)&&r.isSome(x.meta.ESRI_lod)&&"screenSpaceRadius"===x.meta.ESRI_lod.metric&&(F=x.meta.ESRI_lod.thresholds[n]),x.lods[n]=x.lods[n]||{parts:[],name:i,lodThreshold:F},x.lods[n].parts[l]=E}));return function(t,o,r,s){return e.apply(this,arguments)}}());for(const t of x.lods)t.parts=t.parts.filter((e=>!!e));const y=yield p.getLoadedBuffersSize();return{model:x,meta:{isEsriSymbolResource:g,uri:p.uri},customMeta:{},size:y}})),c.apply(this,arguments)}function m(e){const t=e.json;let o=null;return t.nodes.forEach((e=>{const t=e.extras;r.isSome(t)&&(t.ESRI_proxyEllipsoid||t.ESRI_lod)&&(o=t)})),o}function d(e,t){return p.apply(this,arguments)}function p(){return p=t._asyncToGenerator((function*(e,r){const s=e.json,n=s.scenes[s.scene||0].nodes,i=n.length>1,a=[];for(const t of n){const e=s.nodes[t];if(a.push(l(t,0)),T(e)&&!i){e.extensions.MSFT_lod.ids.forEach(((e,t)=>l(e,t+1)))}}function l(e,t){return u.apply(this,arguments)}function u(){return(u=t._asyncToGenerator((function*(t,n){const i=s.nodes[t],u=e.getNodeTransform(t);if(null!=i.weights&&o.getLogger("esri.views.3d.glTF").warn("[Unsupported Feature] Morph targets are not supported."),null!=i.mesh){const e=s.meshes[i.mesh];for(const t of e.primitives)a.push(r(t,u,n,e.name))}for(const e of i.children||[])a.push(l(e,n))}))).apply(this,arguments)}yield Promise.all(a)})),p.apply(this,arguments)}function T(e){return e.extensions&&e.extensions.MSFT_lod&&Array.isArray(e.extensions.MSFT_lod.ids)}function f(e,t,o){const r=t=>{const r=`${o}_tex_${t&&t.id}${t&&t.name?"_"+t.name:""}`;if(t&&!e.textures.has(r)){const o=n.makeTextureSource(t.data,{wrap:{s:t.wrapS,t:t.wrapT},mipmap:x.includes(t.minFilter),noUnpackFlip:!0});e.textures.set(r,o)}return r},s=`${o}_mat_${t.id}_${t.name}`;if(!e.materials.has(s)){const o=n.makeMaterialParameters({color:[t.color[0],t.color[1],t.color[2]],opacity:t.color[3],alphaMode:t.alphaMode,alphaCutoff:t.alphaCutoff,doubleSided:t.doubleSided,colorMixMode:t.ESRI_externalColorMixMode,textureColor:t.colorTexture?r(t.colorTexture):void 0,textureNormal:t.normalTexture?r(t.normalTexture):void 0,textureOcclusion:t.occlusionTexture?r(t.occlusionTexture):void 0,textureEmissive:t.emissiveTexture?r(t.emissiveTexture):void 0,textureMetallicRoughness:t.metallicRoughnessTexture?r(t.metallicRoughnessTexture):void 0,emissiveFactor:[t.emissiveFactor[0],t.emissiveFactor[1],t.emissiveFactor[2]],colorTextureTransform:t.colorTextureTransform,normalTextureTransform:t.normalTextureTransform,occlusionTextureTransform:t.occlusionTextureTransform,emissiveTextureTransform:t.emissiveTextureTransform,metallicRoughnessTextureTransform:t.metallicRoughnessTextureTransform,metallicFactor:t.metallicFactor,roughnessFactor:t.roughnessFactor});e.materials.set(s,o)}return s}const x=[a.TextureSamplingMode.LINEAR_MIPMAP_LINEAR,a.TextureSamplingMode.LINEAR_MIPMAP_NEAREST];e.loadGLTF=u,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
