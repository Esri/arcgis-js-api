/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/maybe","../../../chunks/mat4f64","./DefaultErrorContext","./LoaderResult","./internal/Resource"],(function(e,t,o,r,s,n,i){"use strict";let a=0;function l(e,t){return u.apply(this,arguments)}function u(){return u=t._asyncToGenerator((function*(e,s,n={},l=!0){const u=yield i.Resource.load(e,h,s,n),m="gltf_"+a++,p={lods:[],materials:new Map,textures:new Map,meta:c(u)},x=!(!u.json.asset.extras||"symbolResource"!==u.json.asset.extras.ESRI_type),y=new Map;yield d(u,function(){var e=t._asyncToGenerator((function*(e,t,s,i){var a;const c=null!=(a=y.get(s))?a:0;y.set(s,c+1);const d=void 0!==e.mode?e.mode:4,x=4===d||5===d||6===d?d:null;if(o.isNone(x))return void h.warnUnsupported("Unsupported primitive mode ("+T[d]+"). Skipping primitive.");if(!u.hasPositions(e))return void h.warn("Skipping primitive without POSITION vertex attribute.");const _=u.getPositionData(e,n),S=u.getMaterial(e,n,l),g=u.hasNormals(e)?u.getNormalData(e,n):null,v=u.hasTangents(e)?u.getTangentData(e,n):null,R=u.hasTextureCoordinates(e)?u.getTextureCoordinates(e,n):null,E=u.hasVertexColors(e)?u.getVertexColors(e,n):null,I=u.getIndexData(e,n),M={transform:r.clone(t),attributes:{position:yield _,normal:g?yield g:null,texCoord0:R?yield R:null,color:E?yield E:null,tangent:v?yield v:null},indices:yield I,primitiveType:x,material:f(p,yield S,m)};let F=null;o.isSome(p.meta)&&o.isSome(p.meta.ESRI_lod)&&"screenSpaceRadius"===p.meta.ESRI_lod.metric&&(F=p.meta.ESRI_lod.thresholds[s]),p.lods[s]=p.lods[s]||{parts:[],name:i,lodThreshold:F},p.lods[s].parts[c]=M}));return function(t,o,r,s){return e.apply(this,arguments)}}());for(const t of p.lods)t.parts=t.parts.filter((e=>!!e));return{model:p,meta:{isEsriSymbolResource:x,uri:u.uri},customMeta:{}}})),u.apply(this,arguments)}function c(e){const t=e.json;let r=null;return t.nodes.forEach((e=>{const t=e.extras;o.isSome(t)&&(t.ESRI_proxyEllipsoid||t.ESRI_lod)&&(r=t)})),r}function d(e,t){return m.apply(this,arguments)}function m(){return m=t._asyncToGenerator((function*(e,o){const r=e.json,s=r.scenes[r.scene||0].nodes,n=s.length>1,i=[];for(const t of s){const e=r.nodes[t];if(i.push(a(t,0)),p(e)&&!n){e.extensions.MSFT_lod.ids.forEach(((e,t)=>a(e,t+1)))}}function a(e,t){return l.apply(this,arguments)}function l(){return(l=t._asyncToGenerator((function*(t,s){const n=r.nodes[t],l=e.getNodeTransform(t);if(h.warnUnsupportedIf(null!=n.weights,"Morph targets are not supported."),null!=n.mesh){const e=r.meshes[n.mesh];for(const t of e.primitives)i.push(o(t,l,s,e.name))}for(const e of n.children||[])i.push(a(e,s))}))).apply(this,arguments)}yield Promise.all(i)})),m.apply(this,arguments)}function p(e){return e.extensions&&e.extensions.MSFT_lod&&Array.isArray(e.extensions.MSFT_lod.ids)}function f(e,t,o){const r=t=>{const r=`${o}_tex_${t&&t.id}${t&&t.name?"_"+t.name:""}`;if(t&&!e.textures.has(r)){const o=n.makeTextureSource(t.data,{wrap:{s:t.wrapS,t:t.wrapT},mipmap:x.some((e=>e===t.minFilter)),noUnpackFlip:!0});e.textures.set(r,o)}return r},s=`${o}_mat_${t.id}_${t.name}`;if(!e.materials.has(s)){const o=n.makeMaterialParameters({color:[t.color[0],t.color[1],t.color[2]],opacity:t.color[3],alphaMode:t.alphaMode,alphaCutoff:t.alphaCutoff,doubleSided:t.doubleSided,colorMixMode:t.ESRI_externalColorMixMode,textureColor:t.colorTexture?r(t.colorTexture):void 0,textureNormal:t.normalTexture?r(t.normalTexture):void 0,textureOcclusion:t.occlusionTexture?r(t.occlusionTexture):void 0,textureEmissive:t.emissiveTexture?r(t.emissiveTexture):void 0,textureMetallicRoughness:t.metallicRoughnessTexture?r(t.metallicRoughnessTexture):void 0,emissiveFactor:[t.emissiveFactor[0],t.emissiveFactor[1],t.emissiveFactor[2]],metallicFactor:t.metallicFactor,roughnessFactor:t.roughnessFactor});e.materials.set(s,o)}return s}const h=new s.DefaultErrorContext,x=[9987,9985],T=["POINTS","LINES","LINE_LOOP","LINE_STRIP","TRIANGLES","TRIANGLE_STRIP","TRIANGLE_FAN"];e.load=l,Object.defineProperty(e,"__esModule",{value:!0})}));
