/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/maybe","../../../chunks/mat4f64","./DefaultErrorContext","./LoaderResult","./internal/Resource"],(function(e,t,o,r,s,n,i){"use strict";let a=0;function l(e,t){return u.apply(this,arguments)}function u(){return(u=t._asyncToGenerator((function*(e,s,n={},l=!0){const u=yield i.Resource.load(e,x,s,n),m="gltf_"+a++,p={lods:[],materials:new Map,textures:new Map,meta:c(u)},h=!(!u.json.asset.extras||"symbolResource"!==u.json.asset.extras.ESRI_type);return yield d(u,function(){var e=t._asyncToGenerator((function*(e,t,s,i){const a=void 0!==e.mode?e.mode:4,c=4===a||5===a||6===a?a:null;if(o.isNone(c))return void x.warnUnsupported("Unsupported primitive mode ("+y[a]+"). Skipping primitive.");if(!u.hasPositions(e))return void x.warn("Skipping primitive without POSITION vertex attribute.");const d=yield u.getMaterial(e,n,l),h={transform:r.clone(t),attributes:{position:yield u.getPositionData(e,n),normal:null,texCoord0:null,color:null,tangent:null},indices:yield u.getIndexData(e,n),primitiveType:c,material:f(p,d,m)};u.hasNormals(e)&&(h.attributes.normal=yield u.getNormalData(e,n)),u.hasTangents(e)&&(h.attributes.tangent=yield u.getTangentData(e,n)),u.hasTextureCoordinates(e)&&(h.attributes.texCoord0=yield u.getTextureCoordinates(e,n)),u.hasVertexColors(e)&&(h.attributes.color=yield u.getVertexColors(e,n));let T=null;o.isSome(p.meta)&&o.isSome(p.meta.ESRI_lod)&&"screenSpaceRadius"===p.meta.ESRI_lod.metric&&(T=p.meta.ESRI_lod.thresholds[s]),p.lods[s]=p.lods[s]||{parts:[],name:i,lodThreshold:T},p.lods[s].parts.push(h)}));return function(t,o,r,s){return e.apply(this,arguments)}}()),{model:p,meta:{isEsriSymbolResource:h,uri:u.uri},customMeta:{}}}))).apply(this,arguments)}function c(e){const t=e.json;let r=null;return t.nodes.forEach((e=>{const t=e.extras;o.isSome(t)&&(t.ESRI_proxyEllipsoid||t.ESRI_lod)&&(r=t)})),r}function d(e,t){return m.apply(this,arguments)}function m(){return(m=t._asyncToGenerator((function*(e,o){const r=e.json,s=r.scenes[r.scene||0].nodes,n=s.length>1;for(const t of s){const e=r.nodes[t],o=[i(t,0)];if(p(e)&&!n){const t=e.extensions.MSFT_lod.ids;o.push(...t.map(((e,t)=>i(e,t+1))))}yield Promise.all(o)}function i(e,t){return a.apply(this,arguments)}function a(){return(a=t._asyncToGenerator((function*(t,s){const n=r.nodes[t],a=e.getNodeTransform(t);if(x.warnUnsupportedIf(null!=n.weights,"Morph targets are not supported."),null!=n.mesh){const e=r.meshes[n.mesh];for(const t of e.primitives)yield o(t,a,s,e.name)}for(const e of n.children||[])yield i(e,s)}))).apply(this,arguments)}}))).apply(this,arguments)}function p(e){return e.extensions&&e.extensions.MSFT_lod&&Array.isArray(e.extensions.MSFT_lod.ids)}function f(e,t,o){const r=t=>{const r=`${o}_tex_${t&&t.id}${t&&t.name?"_"+t.name:""}`;if(t&&!e.textures.has(r)){const o=n.makeTextureSource(t.data,{wrap:{s:t.wrapS,t:t.wrapT},mipmap:h.some((e=>e===t.minFilter)),noUnpackFlip:!0});e.textures.set(r,o)}return r},s=`${o}_mat_${t.id}_${t.name}`;if(!e.materials.has(s)){const o=n.makeMaterialParameters({color:[t.color[0],t.color[1],t.color[2]],opacity:t.color[3],alphaMode:t.alphaMode,alphaCutoff:t.alphaCutoff,doubleSided:t.doubleSided,colorMixMode:t.ESRI_externalColorMixMode,textureColor:t.colorTexture?r(t.colorTexture):void 0,textureNormal:t.normalTexture?r(t.normalTexture):void 0,textureOcclusion:t.occlusionTexture?r(t.occlusionTexture):void 0,textureEmissive:t.emissiveTexture?r(t.emissiveTexture):void 0,textureMetallicRoughness:t.metallicRoughnessTexture?r(t.metallicRoughnessTexture):void 0,emissiveFactor:[t.emissiveFactor[0],t.emissiveFactor[1],t.emissiveFactor[2]],metallicFactor:t.metallicFactor,roughnessFactor:t.roughnessFactor});e.materials.set(s,o)}return s}const x=new s.DefaultErrorContext,h=[9987,9985],y=["POINTS","LINES","LINE_LOOP","LINE_STRIP","TRIANGLES","TRIANGLE_STRIP","TRIANGLE_FAN"];e.load=l,Object.defineProperty(e,"__esModule",{value:!0})}));
