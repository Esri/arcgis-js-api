// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../../core/maybe","../../../core/promiseUtils","../../../core/libs/gl-matrix-2/mat4f64","./DefaultErrorContext","./LoaderResult","./internal/Resource"],(function(e,t,r,a,s,o,n,i,l){Object.defineProperty(t,"__esModule",{value:!0});var u=0;function c(e){var t=e.json,r=null;return t.nodes.forEach((function(e){var t=e.extras;a.isSome(t)&&(t.ESRI_proxyEllipsoid||t.ESRI_lod)&&(r=t)})),r}function d(e,t){return r.__awaiter(this,void 0,void 0,(function(){function a(s,n){return r.__awaiter(this,void 0,void 0,(function(){var i,l,u,c,d,m,h,x;return r.__generator(this,(function(r){switch(r.label){case 0:if(i=o.nodes[s],l=e.getNodeTransform(s),p.warnUnsupportedIf(null!=i.weights,"Morph targets are not supported."),null==i.mesh)return[3,4];u=o.meshes[i.mesh],c=0,d=u.primitives,r.label=1;case 1:return c<d.length?(m=d[c],[4,t(m,l,n,u.name)]):[3,4];case 2:r.sent(),r.label=3;case 3:return c++,[3,1];case 4:h=0,x=i.children||[],r.label=5;case 5:return h<x.length?[4,a(x[h],n)]:[3,8];case 6:r.sent(),r.label=7;case 7:return h++,[3,5];case 8:return[2]}}))}))}var o,n,i,l,u,c,d,m,h,x;return r.__generator(this,(function(t){switch(t.label){case 0:o=e.json,n=o.scenes[o.scene||0],i=n.nodes,l=i.length>1,u=0,c=i,t.label=1;case 1:return u<c.length?(d=c[u],m=o.nodes[d],h=[a(d,0)],function(e){return e.extensions&&e.extensions.MSFT_lod&&Array.isArray(e.extensions.MSFT_lod.ids)}(m)&&!l&&(x=m.extensions.MSFT_lod.ids,h.push.apply(h,x.map((function(e,t){return a(e,t+1)})))),[4,s.all(h)]):[3,4];case 2:t.sent(),t.label=3;case 3:return u++,[3,1];case 4:return[2]}}))}))}function m(e){if(33071===e||33648===e||10497===e)return e;p.error("Unexpected TextureSampler WrapMode: "+e)}t.load=function(e,t,s){return void 0===s&&(s={}),r.__awaiter(this,void 0,void 0,(function(){var n,f,v,_,g=this;return r.__generator(this,(function(T){switch(T.label){case 0:return[4,l.Resource.load(e,p,t,s)];case 1:return n=T.sent(),f="gltf_"+u++,v={lods:[],materials:new Map,textures:new Map,meta:c(n)},_=!(!n.json.asset.extras||"symbolResource"!==n.json.asset.extras.ESRI_type),[4,d(n,(function(e,t,l,u){return r.__awaiter(g,void 0,void 0,(function(){var c,d,_,g,T,b,S,R,w,I,E;return r.__generator(this,(function(r){switch(r.label){case 0:return c=void 0!==e.mode?e.mode:4,d=function(e){switch(e){case 4:case 5:case 6:return e;default:return null}}(c),a.isNone(d)?(p.warnUnsupported("Unsupported primitive mode ("+x[c]+"). Skipping primitive."),[2]):n.hasPositions(e)?[4,n.getMaterial(e,s)]:(p.warn("Skipping primitive without POSITION vertex attribute."),[2]);case 1:return _=r.sent(),T={transform:o.mat4f64.clone(t)},b={},[4,n.getPositionData(e,s)];case 2:return T.attributes=(b.position=r.sent(),b.normal=null,b.texCoord0=null,b.color=null,b.tangent=null,b),[4,n.getIndexData(e,s)];case 3:return T.indices=r.sent(),T.primitiveType=d,T.material=function(e,t,r){var a=function(t){var a=r+"_tex_"+(t&&t.id)+(t&&t.name?"_"+t.name:"");if(t&&!e.textures.has(a)){var s=i.makeTextureSource(t.data,{wrap:{s:m(t.wrapS),t:m(t.wrapT)},mipmap:h.some((function(e){return e===t.minFilter})),noUnpackFlip:!0});e.textures.set(a,s)}return a},s=r+"_mat_"+t.id+"_"+t.name;if(!e.materials.has(s)){var o=i.makeMaterialParameters({color:[t.color[0],t.color[1],t.color[2]],opacity:t.color[3],alphaMode:t.alphaMode,alphaCutoff:t.alphaCutoff,doubleSided:t.doubleSided,colorMixMode:t.ESRI_externalColorMixMode,textureColor:t.colorTexture?a(t.colorTexture):void 0,textureNormal:t.normalTexture?a(t.normalTexture):void 0,textureOcclusion:t.occlusionTexture?a(t.occlusionTexture):void 0,textureEmissive:t.emissiveTexture?a(t.emissiveTexture):void 0,textureMetallicRoughness:t.metallicRoughnessTexture?a(t.metallicRoughnessTexture):void 0,emissiveFactor:[t.emissiveFactor[0],t.emissiveFactor[1],t.emissiveFactor[2]],metallicFactor:t.metallicFactor,roughnessFactor:t.roughnessFactor});e.materials.set(s,o)}return s}(v,_,f),g=T,n.hasNormals(e)?(S=g.attributes,[4,n.getNormalData(e,s)]):[3,5];case 4:S.normal=r.sent(),r.label=5;case 5:return n.hasTangents(e)?(R=g.attributes,[4,n.getTangentData(e,s)]):[3,7];case 6:R.tangent=r.sent(),r.label=7;case 7:return n.hasTextureCoordinates(e)?(w=g.attributes,[4,n.getTextureCoordinates(e,s)]):[3,9];case 8:w.texCoord0=r.sent(),r.label=9;case 9:return n.hasVertexColors(e)?(I=g.attributes,[4,n.getVertexColors(e,s)]):[3,11];case 10:I.color=r.sent(),r.label=11;case 11:return E=null,a.isSome(v.meta)&&a.isSome(v.meta.ESRI_lod)&&"screenSpaceRadius"===v.meta.ESRI_lod.metric&&(E=v.meta.ESRI_lod.thresholds[l]),v.lods[l]=v.lods[l]||{parts:[],name:u,lodThreshold:E},v.lods[l].parts.push(g),[2]}}))}))}))];case 2:return T.sent(),[2,{model:v,meta:{isEsriSymbolResource:_,uri:n.uri},customMeta:{}}]}}))}))};var p=new n.DefaultErrorContext,h=[9987,9985],x=["POINTS","LINES","LINE_LOOP","LINE_STRIP","TRIANGLES","TRIANGLE_STRIP","TRIANGLE_FAN"]}));