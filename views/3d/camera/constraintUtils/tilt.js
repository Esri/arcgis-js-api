// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","../../../../core/compilerUtils","../../../../core/mathUtils","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../geometry/support/geodesicConstants","./common","../../state/utils/viewUtils","../../support/geometryUtils"],(function(e,t,r,a,n,i,s,c,o,u,l,d){"use strict";function p(e,t,n,i,c){if(void 0===n&&(n=u.defaultApplyOptions),void 0===i&&(i=u.defaultApplyOptions),!e.state.constraints.tilt)return 0;var y=t.distance,C=e.state.constraints.tilt(y,g);return function(e,t,r){if(0===t.interactionType)return;var a=t.interactionStartCamera,n=t.interactionFactor,i=r.min,s=r.max,c=p(e,a,u.defaultApplyOptions,t),o=0===c?0:l.viewAngle(e.renderCoordsHelper,a.center,a.eye);r.min=i,r.max=s,2===t.interactionType?(u.hasConstraintType(t.selection,2)&&v(e,a,r),u.adjustRangeForInteraction(c,o,!0,n,M,r)):u.adjustRangeForInteraction(c,o,!1,n,M,r)}(e,n,C),2===i.interactionType&&u.hasConstraintType(i.selection,2)&&v(e,i.interactionStartCamera,C),1===n.tiltMode||1===i.tiltMode?function(e,t,n,i){i&&(i.requiresTwoSteps=!1);switch(e.viewingMode){case"global":return function(e,t,r,n){var i,c,u=function(e,t,r){var n=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,i=n+o.earthRadius,c=e.renderCoordsHelper.intersectManifold(t.ray,n,h);r.eyeCenterDistance=t.distance,c?(r.eyeCenterDistance=s.vec3.distance(t.eye,h),r.tiltAtCenter=l.viewAngle(e.renderCoordsHelper,h,t.eye)):e.state.isLocal?r.tiltAtCenter=l.viewAngle(e.renderCoordsHelper,t.center,t.eye):(d.sphere.closestPointOnSilhouette(d.sphere.wrap(i),t.ray,h),r.eyeCenterDistance=s.vec3.distance(t.eye,h),r.tiltAtCenter=a.acosClamped(-s.vec3.dot(t.viewForward,s.vec3.normalize(h,h))));return r.radius=i,r.eyeRadius=s.vec3.length(t.eye),r.constraints=e.state.constraints,r.centerIsOnSurface=c,r}(e,t,w),p=a.clamp(u.tiltAtCenter,r.min,r.max);if(!m(u.tiltAtCenter-p))return 0;u.centerIsOnSurface?(i=function(e){var t=e.constraints,r=e.eyeCenterDistance,a=e.tiltAtCenter,n=a,i=t.clampTilt(r,a),s=f(e,i);if(t.clampTilt(s,a)===i)return i;var c=0;for(;c<10&&m(i-n);){var o=(n+i)/2,u=f(e,o);m(t.clampTilt(u,o)-o)?n=o:i=o,c++}return i}(u),c=function(e,t){var r=a.asinClamped(e.radius/e.eyeRadius*Math.sin(e.tiltAtCenter)),n=a.asinClamped(e.radius/e.eyeRadius*Math.sin(t));if(e.eyeRadius>e.radius)return r-n;return n-r}(u,i)):(i=u.constraints.clampTilt(u.eyeCenterDistance,u.tiltAtCenter),n&&i<Math.PI/2&&(n.requiresTwoSteps=!0,i=Math.PI/2-1e-5),c=function(e,t){var r=e.tiltAtCenter-Math.PI/2,a=t-Math.PI/2;return r-a}(u,i));n&&(n.eyeCenterDistance=f(u,i));return c}(e,t,n,i);case"local":return function(e,t,r,n){var i=l.viewAngle(e.renderCoordsHelper,t.center,t.eye),s=a.clamp(i,r.min,r.max),c=i-s;if(!m(c))return 0;if(n){var o=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,u=e.renderCoordsHelper.getAltitude(t.eye)-o,d=Math.cos(s);Math.abs(d)>1e-4?n.eyeCenterDistance=u/d:n.eyeCenterDistance=t.distance}return c}(e,t,n,i);default:return void r.neverReached(e.viewingMode)}}(e,t,C,c):function(e,t,r){var n=l.viewAngle(e.renderCoordsHelper,t.center,t.eye),i=a.clamp(n,r.min,r.max),s=n-i;if(!m(s))return 0;return s}(e,t,C)}function m(e){return Math.abs(e)>1e-9}function f(e,t){if(!e.centerIsOnSurface)return e.eyeCenterDistance;var r=Math.PI-a.clamp(t,0,Math.PI),n=a.asinClamped(e.radius/e.eyeRadius*Math.sin(r)),i=Math.PI-r-n,s=Math.sin(i)/Math.sin(r);if(e.eyeRadius<e.radius&&s>1){var c=Math.PI-n,o=Math.PI-r-c;return Math.sin(o)/Math.sin(r)*e.eyeRadius}return s*e.eyeRadius}function v(e,t,r){if(!e.state.isLocal){var n=e.state.constraints;if(n.altitude){var i=s.vec3.squaredLength(t.center),c=Math.sqrt(i),u=t.distance,l=n.altitude.min+o.earthRadius,d=n.altitude.max+o.earthRadius,p=(l*l-u*u-i)/(-2*c*u),m=(d*d-u*u-i)/(-2*c*u);r.min=Math.max(r.min,Math.min(Math.PI-a.acosClamped(m),r.max)),r.max=Math.min(r.max,Math.PI-a.acosClamped(p))}}}Object.defineProperty(t,"__esModule",{value:!0}),t.getTiltConstraintError=t.applyTiltConstraint=void 0,t.applyTiltConstraint=function e(t,a,i,c){void 0===i&&(i=u.defaultApplyOptions),void 0===c&&(c=!0),A.eyeCenterDistance=0,A.requiresTwoSteps=!1;var o=p(t,a,i,void 0,A);if(0===o)return!1;switch(n.mat4.identity(C),n.mat4.rotate(C,C,-o,a.viewRight),i.tiltMode){case 1:s.vec3.transformMat4(y,a.viewForward,C),s.vec3.scale(y,y,A.eyeCenterDistance),s.vec3.add(a.center,a.eye,y);break;case 0:s.vec3.subtract(y,a.center,a.eye),s.vec3.transformMat4(y,y,C),s.vec3.subtract(a.eye,a.center,y);break;default:r.neverReached(i.tiltMode)}return s.vec3.transformMat4(a.up,a.up,C),a.markViewDirty(),!A.requiresTwoSteps||!c||e(t,a,i,!1)},t.getTiltConstraintError=p;var y=c.vec3f64.create(),C=i.mat4f64.create(),h=c.vec3f64.create(),M=a.deg2rad(5),g={min:0,max:0},w={constraints:null,radius:0,eyeRadius:0,centerIsOnSurface:!0,eyeCenterDistance:0,tiltAtCenter:0},A={eyeCenterDistance:0,requiresTwoSteps:!1}}));