/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../../core/compilerUtils","../../../../core/mathUtils","../../../../core/maybe","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/projectionEllipsoid","../../../../chunks/sphere","./common","../../state/utils/viewUtils"],(function(e,t,n,r,a,i,s,c,o,u,l,d){"use strict";function p(e,n,r=l.defaultApplyOptions,i=!0){q.eyeCenterDistance=0,q.requiresTwoSteps=!1;const c=f(e,n,r,void 0,q);if(0===c)return!1;switch(a.identity(O),a.rotate(O,O,-c,n.viewRight),r.tiltMode){case 1:s.transformMat4(T,n.viewForward,O),s.scale(T,T,q.eyeCenterDistance),n.center=s.add(D,n.eye,T);break;case 0:s.subtract(T,n.center,n.eye),s.transformMat4(T,T,O),n.eye=s.subtract(D,n.center,T);break;default:t.neverReached(r.tiltMode)}return n.up=s.transformMat4(D,n.up,O),!q.requiresTwoSteps||!i||p(e,n,r,!1)}function f(e,t,n=l.defaultApplyOptions,r=l.defaultApplyOptions,a){if(!e.state.constraints.tilt)return 0;const i=t.distance,s=e.state.constraints.tilt(i,x);return v(e,n,s),2===r.interactionType&&l.hasConstraintType(r.selection,2)&&S(e,r.interactionStartCamera,s),1===n.tiltMode||1===r.tiltMode?y(e,t,s,a):m(e,t,s)}function m(e,t,r){const a=d.viewAngle(e.renderCoordsHelper,t.center,t.eye),i=a-n.clamp(a,r.min,r.max);return A(i)?i:0}function y(e,n,r,a){switch(a&&(a.requiresTwoSteps=!1),e.viewingMode){case"global":return C(e,n,r,a);case"local":return h(e,n,r,a);default:return void t.neverReached(e.viewingMode)}}function h(e,t,r,a){const i=d.viewAngle(e.renderCoordsHelper,t.center,t.eye),s=n.clamp(i,r.min,r.max),c=i-s;if(!A(c))return 0;if(a){const n=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,r=e.renderCoordsHelper.getAltitude(t.eye)-n,i=Math.cos(s);Math.abs(i)>1e-4?a.eyeCenterDistance=r/i:a.eyeCenterDistance=t.distance}return c}function C(e,t,r,a){const i=M(e,t,b),s=n.clamp(i.tiltAtCenter,r.min,r.max);if(!A(i.tiltAtCenter-s))return 0;let c,o;return i.centerIsOnSurface?(c=w(i),o=g(i,c)):(c=i.constraints.clampTilt(i.eyeCenterDistance,i.tiltAtCenter),a&&c<Math.PI/2&&(a.requiresTwoSteps=!0,c=Math.PI/2-1e-5),o=R(i,c)),a&&(a.eyeCenterDistance=I(i,c)),o}function M(e,t,a){const i=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,c=i+o.getReferenceEllipsoid(e.spatialReference).radius,l=e.renderCoordsHelper.intersectManifold(t.ray,i,D);return a.eyeCenterDistance=t.distance,a.centerIsOnSurface=!1,r.isSome(l)?(a.eyeCenterDistance=s.distance(t.eye,l),a.tiltAtCenter=d.viewAngle(e.renderCoordsHelper,l,t.eye),a.centerIsOnSurface=!0):e.state.isLocal?a.tiltAtCenter=d.viewAngle(e.renderCoordsHelper,t.center,t.eye):(u.closestPointOnSilhouette(u.fromRadius(c),t.ray,D),a.eyeCenterDistance=s.distance(t.eye,D),a.tiltAtCenter=n.acosClamped(-s.dot(t.viewForward,s.normalize(D,D)))),a.radius=c,a.eyeRadius=s.length(t.eye),a.constraints=e.state.constraints,a}function A(e){return Math.abs(e)>1e-9}function w(e){const{constraints:t,eyeCenterDistance:n,tiltAtCenter:r}=e;let a=r,i=t.clampTilt(n,r);const s=I(e,i);if(t.clampTilt(s,r)===i)return i;let c=0;for(;c<10&&A(i-a);){const n=(a+i)/2,r=I(e,n);A(t.clampTilt(r,n)-n)?a=n:i=n,c++}return i}function I(e,t){if(!e.centerIsOnSurface)return e.eyeCenterDistance;const r=Math.PI-n.clamp(t,0,Math.PI),a=n.asinClamped(e.radius/e.eyeRadius*Math.sin(r)),i=Math.PI-r-a,s=Math.sin(i)/Math.sin(r);if(e.eyeRadius<e.radius&&s>1){const t=Math.PI-a,n=Math.PI-r-t;return Math.sin(n)/Math.sin(r)*e.eyeRadius}return s*e.eyeRadius}function g(e,t){const r=n.asinClamped(e.radius/e.eyeRadius*Math.sin(e.tiltAtCenter)),a=n.asinClamped(e.radius/e.eyeRadius*Math.sin(t));return e.eyeRadius>e.radius?r-a:a-r}function R(e,t){return e.tiltAtCenter-Math.PI/2-(t-Math.PI/2)}function v(e,t,n){if(0===t.interactionType)return;const{interactionStartCamera:r,interactionFactor:a}=t,{min:i,max:s}=n,c=f(e,r,l.defaultApplyOptions,t),o=0===c?0:d.viewAngle(e.renderCoordsHelper,r.center,r.eye);n.min=i,n.max=s,2===t.interactionType?(l.hasConstraintType(t.selection,2)&&S(e,r,n),l.adjustRangeForInteraction(c,o,!0,a,P,n)):l.adjustRangeForInteraction(c,o,!1,a,P,n)}function S(e,t,r){if(e.state.isLocal)return;const a=e.state.constraints;if(!a.altitude)return;const i=s.squaredLength(t.center),c=Math.sqrt(i),u=t.distance,l=o.getReferenceEllipsoid(e.spatialReference).radius,d=a.altitude.min+l,p=a.altitude.max+l,f=(d*d-u*u-i)/(-2*c*u),m=(p*p-u*u-i)/(-2*c*u);r.min=Math.max(r.min,Math.min(Math.PI-n.acosClamped(m),r.max)),r.max=Math.min(r.max,Math.PI-n.acosClamped(f))}const T=c.create(),O=i.create(),D=c.create(),P=n.deg2rad(5),x={min:0,max:0},b={constraints:null,radius:0,eyeRadius:0,centerIsOnSurface:!0,eyeCenterDistance:0,tiltAtCenter:0},q={eyeCenterDistance:0,requiresTwoSteps:!1};e.applyTiltConstraint=p,e.getTiltConstraintError=f,Object.defineProperty(e,"__esModule",{value:!0})}));
