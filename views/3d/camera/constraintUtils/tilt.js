/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../core/compilerUtils","../../../../core/mathUtils","../../../../core/maybe","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/projectionEllipsoid","../../../../chunks/sphere","./common","./ConstraintTypes","./InteractionType","./TiltMode","../../state/utils/viewUtils"],(function(e,t,n,r,i,a,s,o,c,u,l,d,p,f,m){"use strict";function y(e,n,r=l.defaultConstraintOptions,a=!0){q.eyeCenterDistance=0,q.requiresTwoSteps=!1;const o=C(e,n,r,void 0,q);if(0===o)return!1;switch(i.fromRotation(x,-o,n.viewRight),r.tiltMode){case f.TiltMode.LOOK_AROUND:s.transformMat4(P,n.viewForward,x),s.scale(P,P,q.eyeCenterDistance),n.center=s.add(L,n.eye,P);break;case f.TiltMode.TUMBLE:s.subtract(P,n.center,n.eye),s.transformMat4(P,P,x),n.eye=s.subtract(L,n.center,P);break;default:t.neverReached(r.tiltMode)}return n.up=s.transformMat4(L,n.up,x),!q.requiresTwoSteps||!a||y(e,n,r,!1)}function C(e,t,n=l.defaultConstraintOptions,r=l.defaultConstraintOptions,i){if(!e.state.constraints.tilt)return 0;const a=t.distance,s=e.state.constraints.tilt(a,b);return v(e,n,s),r.interactionType===p.InteractionType.TUMBLE&&l.hasConstraintType(r.selection,d.ConstraintTypes.ALTITUDE)&&D(e,r.interactionStartCamera,s),n.tiltMode===f.TiltMode.LOOK_AROUND||r.tiltMode===f.TiltMode.LOOK_AROUND?h(e,t,s,i):M(e,t,s)}function M(e,t,r){const i=m.viewAngle(e.renderCoordsHelper,t.center,t.eye),a=i-n.clamp(i,r.min,r.max);return A(a)?a:0}function h(e,n,r,i){switch(i&&(i.requiresTwoSteps=!1),e.viewingMode){case"global":return I(e,n,r,i);case"local":return T(e,n,r,i);default:return void t.neverReached(e.viewingMode)}}function T(e,t,r,i){const a=m.viewAngle(e.renderCoordsHelper,t.center,t.eye),s=n.clamp(a,r.min,r.max),o=a-s;if(!A(o))return 0;if(i){const n=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,r=e.renderCoordsHelper.getAltitude(t.eye)-n,a=Math.cos(s);Math.abs(a)>1e-4?i.eyeCenterDistance=r/a:i.eyeCenterDistance=t.distance}return o}function I(e,t,r,i){const a=O(e,t,E),s=n.clamp(a.tiltAtCenter,r.min,r.max);if(!A(a.tiltAtCenter-s))return 0;let o,c;return a.centerIsOnSurface?(o=R(a),c=S(a,o)):(o=a.constraints.clampTilt(a.eyeCenterDistance,a.tiltAtCenter),i&&o<Math.PI/2&&(i.requiresTwoSteps=!0,o=Math.PI/2-1e-5),c=w(a,o)),i&&(i.eyeCenterDistance=g(a,o)),c}function O(e,t,i){const a=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,o=a+c.getReferenceEllipsoid(e.spatialReference).radius,l=e.renderCoordsHelper.intersectManifold(t.ray,a,L);return i.eyeCenterDistance=t.distance,i.centerIsOnSurface=!1,r.isSome(l)?(i.eyeCenterDistance=s.distance(t.eye,l),i.tiltAtCenter=m.viewAngle(e.renderCoordsHelper,l,t.eye),i.centerIsOnSurface=!0):e.state.isLocal?i.tiltAtCenter=m.viewAngle(e.renderCoordsHelper,t.center,t.eye):(u.closestPointOnSilhouette(u.fromRadius(u.tmpSphere,o),t.ray,L),i.eyeCenterDistance=s.distance(t.eye,L),i.tiltAtCenter=n.acosClamped(-s.dot(t.viewForward,s.normalize(L,L)))),i.radius=o,i.eyeRadius=s.length(t.eye),i.constraints=e.state.constraints,i}function A(e){return Math.abs(e)>1e-9}function R(e){const{constraints:t,eyeCenterDistance:n,tiltAtCenter:r}=e;let i=r,a=t.clampTilt(n,r);const s=g(e,a);if(t.clampTilt(s,r)===a)return a;let o=0;for(;o<10&&A(a-i);){const n=(i+a)/2,r=g(e,n);A(t.clampTilt(r,n)-n)?i=n:a=n,o++}return a}function g(e,t){if(!e.centerIsOnSurface)return e.eyeCenterDistance;const r=Math.PI-n.clamp(t,0,Math.PI),i=n.asinClamped(e.radius/e.eyeRadius*Math.sin(r)),a=Math.PI-r-i,s=Math.sin(a)/Math.sin(r);if(e.eyeRadius<e.radius&&s>1){const t=Math.PI-i,n=Math.PI-r-t;return Math.sin(n)/Math.sin(r)*e.eyeRadius}return s*e.eyeRadius}function S(e,t){const r=n.asinClamped(e.radius/e.eyeRadius*Math.sin(e.tiltAtCenter)),i=n.asinClamped(e.radius/e.eyeRadius*Math.sin(t));return e.eyeRadius>e.radius?r-i:i-r}function w(e,t){return e.tiltAtCenter-Math.PI/2-(t-Math.PI/2)}function v(e,t,n){if(t.interactionType===p.InteractionType.NONE)return;const{interactionStartCamera:r,interactionFactor:i}=t,{min:a,max:s}=n,o=C(e,r,l.defaultConstraintOptions,t),c=0===o?0:m.viewAngle(e.renderCoordsHelper,r.center,r.eye);n.min=a,n.max=s,t.interactionType===p.InteractionType.TUMBLE?(l.hasConstraintType(t.selection,d.ConstraintTypes.ALTITUDE)&&D(e,r,n),l.adjustRangeForInteraction(o,c,!0,i,U,n)):l.adjustRangeForInteraction(o,c,!1,i,U,n)}function D(e,t,r){if(e.state.isLocal)return;const i=e.state.constraints;if(!i.altitude)return;const a=s.squaredLength(t.center),o=Math.sqrt(a),u=t.distance,l=c.getReferenceEllipsoid(e.spatialReference).radius,d=i.altitude.min+l,p=i.altitude.max+l,f=(d*d-u*u-a)/(-2*o*u),m=(p*p-u*u-a)/(-2*o*u);r.min=Math.max(r.min,Math.min(Math.PI-n.acosClamped(m),r.max)),r.max=Math.min(r.max,Math.PI-n.acosClamped(f))}const P=o.create(),x=a.create(),L=o.create(),U=n.deg2rad(5),b={min:0,max:0},E={constraints:null,radius:0,eyeRadius:0,centerIsOnSurface:!0,eyeCenterDistance:0,tiltAtCenter:0},q={eyeCenterDistance:0,requiresTwoSteps:!1};e.applyTiltConstraint=y,e.getTiltConstraintError=C,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
