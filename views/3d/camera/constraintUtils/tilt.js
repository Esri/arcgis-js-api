/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../core/compilerUtils","../../../../core/mathUtils","../../../../chunks/vec3f64","../../../../chunks/vec3","../../../../geometry/projectionEllipsoid","../../../../chunks/mat4","../../../../chunks/mat4f64","../../support/geometryUtils","./common","../../state/utils/viewUtils"],(function(e,t,n,r,i,a,s,c,o,u,l){"use strict";function d(e,r,s=u.defaultApplyOptions,c=u.defaultApplyOptions,y){if(!e.state.constraints.tilt)return 0;const h=r.distance,g=e.state.constraints.tilt(h,w);return function(e,t,n){if(0===t.interactionType)return;const{interactionStartCamera:r,interactionFactor:i}=t,{min:a,max:s}=n,c=d(e,r,u.defaultApplyOptions,t),o=0===c?0:l.viewAngle(e.renderCoordsHelper,r.center,r.eye);n.min=a,n.max=s,2===t.interactionType?(u.hasConstraintType(t.selection,2)&&m(e,r,n),u.adjustRangeForInteraction(c,o,!0,i,M,n)):u.adjustRangeForInteraction(c,o,!1,i,M,n)}(e,s,g),2===c.interactionType&&u.hasConstraintType(c.selection,2)&&m(e,c.interactionStartCamera,g),1===s.tiltMode||1===c.tiltMode?function(e,r,s,c){c&&(c.requiresTwoSteps=!1);switch(e.viewingMode){case"global":return function(e,t,r,s){const c=function(e,t,r){const s=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,c=s+a.getReferenceEllipsoid(e.spatialReference).radius,u=e.renderCoordsHelper.intersectManifold(t.ray,s,C);r.eyeCenterDistance=t.distance,u?(r.eyeCenterDistance=i.distance(t.eye,C),r.tiltAtCenter=l.viewAngle(e.renderCoordsHelper,C,t.eye)):e.state.isLocal?r.tiltAtCenter=l.viewAngle(e.renderCoordsHelper,t.center,t.eye):(o.sphere.closestPointOnSilhouette(o.sphere.wrap(c),t.ray,C),r.eyeCenterDistance=i.distance(t.eye,C),r.tiltAtCenter=n.acosClamped(-i.dot(t.viewForward,i.normalize(C,C))));return r.radius=c,r.eyeRadius=i.length(t.eye),r.constraints=e.state.constraints,r.centerIsOnSurface=u,r}(e,t,A),u=n.clamp(c.tiltAtCenter,r.min,r.max);if(!p(c.tiltAtCenter-u))return 0;let d,m;c.centerIsOnSurface?(d=function(e){const{constraints:t,eyeCenterDistance:n,tiltAtCenter:r}=e;let i=r,a=t.clampTilt(n,r);const s=f(e,a);if(t.clampTilt(s,r)===a)return a;let c=0;for(;c<10&&p(a-i);){const n=(i+a)/2,r=f(e,n);p(t.clampTilt(r,n)-n)?i=n:a=n,c++}return a}(c),m=function(e,t){const r=n.asinClamped(e.radius/e.eyeRadius*Math.sin(e.tiltAtCenter)),i=n.asinClamped(e.radius/e.eyeRadius*Math.sin(t));if(e.eyeRadius>e.radius)return r-i;return i-r}(c,d)):(d=c.constraints.clampTilt(c.eyeCenterDistance,c.tiltAtCenter),s&&d<Math.PI/2&&(s.requiresTwoSteps=!0,d=Math.PI/2-1e-5),m=function(e,t){const n=e.tiltAtCenter-Math.PI/2,r=t-Math.PI/2;return n-r}(c,d));s&&(s.eyeCenterDistance=f(c,d));return m}(e,r,s,c);case"local":return function(e,t,r,i){const a=l.viewAngle(e.renderCoordsHelper,t.center,t.eye),s=n.clamp(a,r.min,r.max),c=a-s;if(!p(c))return 0;if(i){const n=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,r=e.renderCoordsHelper.getAltitude(t.eye)-n,a=Math.cos(s);Math.abs(a)>1e-4?i.eyeCenterDistance=r/a:i.eyeCenterDistance=t.distance}return c}(e,r,s,c);default:return void t.neverReached(e.viewingMode)}}(e,r,g,y):function(e,t,r){const i=l.viewAngle(e.renderCoordsHelper,t.center,t.eye),a=n.clamp(i,r.min,r.max),s=i-a;if(!p(s))return 0;return s}(e,r,g)}function p(e){return Math.abs(e)>1e-9}function f(e,t){if(!e.centerIsOnSurface)return e.eyeCenterDistance;const r=Math.PI-n.clamp(t,0,Math.PI),i=n.asinClamped(e.radius/e.eyeRadius*Math.sin(r)),a=Math.PI-r-i,s=Math.sin(a)/Math.sin(r);if(e.eyeRadius<e.radius&&s>1){const t=Math.PI-i,n=Math.PI-r-t;return Math.sin(n)/Math.sin(r)*e.eyeRadius}return s*e.eyeRadius}function m(e,t,r){if(e.state.isLocal)return;const s=e.state.constraints;if(!s.altitude)return;const c=i.squaredLength(t.center),o=Math.sqrt(c),u=t.distance,l=a.getReferenceEllipsoid(e.spatialReference).radius,d=s.altitude.min+l,p=s.altitude.max+l,f=(d*d-u*u-c)/(-2*o*u),m=(p*p-u*u-c)/(-2*o*u);r.min=Math.max(r.min,Math.min(Math.PI-n.acosClamped(m),r.max)),r.max=Math.min(r.max,Math.PI-n.acosClamped(f))}const y=r.create(),h=c.create(),C=r.create(),M=n.deg2rad(5),w={min:0,max:0},A={constraints:null,radius:0,eyeRadius:0,centerIsOnSurface:!0,eyeCenterDistance:0,tiltAtCenter:0},g={eyeCenterDistance:0,requiresTwoSteps:!1};e.applyTiltConstraint=function e(n,r,a=u.defaultApplyOptions,c=!0){g.eyeCenterDistance=0,g.requiresTwoSteps=!1;const o=d(n,r,a,void 0,g);if(0===o)return!1;switch(s.identity(h),s.rotate(h,h,-o,r.viewRight),a.tiltMode){case 1:i.transformMat4(y,r.viewForward,h),i.scale(y,y,g.eyeCenterDistance),i.add(r.center,r.eye,y);break;case 0:i.subtract(y,r.center,r.eye),i.transformMat4(y,y,h),i.subtract(r.eye,r.center,y);break;default:t.neverReached(a.tiltMode)}return i.transformMat4(r.up,r.up,h),r.markViewDirty(),!g.requiresTwoSteps||!c||e(n,r,a,!1)},e.getTiltConstraintError=d,Object.defineProperty(e,"__esModule",{value:!0})}));
