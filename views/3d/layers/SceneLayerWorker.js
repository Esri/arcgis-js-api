/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../core/typedArrayUtil","../../../core/maybe","../../../core/promiseUtils","../../../libs/i3s/I3SWorker"],(function(e,t,r,n,o){"use strict";let s,i;function f(e){const t=e.modifications,r=i._malloc(8*t.length),n=new Float64Array(i.HEAPU8.buffer,r,t.length);for(let e=0;e<t.length;++e)n[e]=t[e];i.setModifications(e.context,r,t.length,e.isGeodetic),i._free(r)}function a(e,n){if(!i)return null;const{context:o,localOrigin:s,globalTrafo:f,mbs:a,obb:c,elevationOffset:l,geometryBuffer:y,geometryDescriptor:b,indexToVertexProjector:d,vertexToRenderProjector:m}=e,h=i._malloc(y.byteLength),E=i._malloc(33*Float64Array.BYTES_PER_ELEMENT),p=new Uint8Array(i.HEAPU8.buffer,h,y.byteLength);p.set(new Uint8Array(y));const g=new Float64Array(i.HEAPU8.buffer,E,33);u(g,s);let w=g.byteOffset+3*g.BYTES_PER_ELEMENT,_=new Float64Array(g.buffer,w);u(_,f),w+=16*g.BYTES_PER_ELEMENT,_=new Float64Array(g.buffer,w),u(_,a),w+=4*g.BYTES_PER_ELEMENT,r.isSome(c)&&(_=new Float64Array(g.buffer,w),u(_,c.center),w+=3*g.BYTES_PER_ELEMENT,_=new Float64Array(g.buffer,w),u(_,c.halfSize),w+=3*g.BYTES_PER_ELEMENT,_=new Float64Array(g.buffer,w),u(_,c.quaternion));const A=b,L={isDraco:!1,isLegacy:!1,color:e.layouts.some((e=>e.some((e=>"color"===e.name)))),normal:e.needNormals&&e.layouts.some((e=>e.some((e=>"normalCompressed"===e.name)))),uv0:e.layouts.some((e=>e.some((e=>"uv0"===e.name)))),uvRegion:e.layouts.some((e=>e.some((e=>"uvRegion"===e.name)))),featureIndex:A.featureIndex},T=i.process(o,!!e.obb,h,p.byteLength,A,L,E,l,d,m,e.normalReferenceFrame);if(i._free(E),i._free(h),T.error.length>0)throw`i3s.wasm: ${T.error}`;if(T.discarded)return null;const M=T.componentOffsets.length>0?t.slice(T.componentOffsets):null,P=T.featureIds.length>0?t.slice(T.featureIds):null,I=t.slice(T.interleavedVertedData).buffer,O=1===T.indicesType?t.slice(new Uint16Array(T.indices.buffer,T.indices.byteOffset,T.indices.byteLength/2)):t.slice(new Uint32Array(T.indices.buffer,T.indices.byteOffset,T.indices.byteLength/4)),S=t.slice(T.positions),U=1===T.positionIndicesType?t.slice(new Uint16Array(T.positionIndices.buffer,T.positionIndices.byteOffset,T.positionIndices.byteLength/2)):t.slice(new Uint32Array(T.positionIndices.buffer,T.positionIndices.byteOffset,T.positionIndices.byteLength/4)),F={layout:e.layouts[0],interleavedVertexData:I,indices:O,hasColors:T.hasColors,hasModifications:T.hasModifications,positionData:{data:S,indices:U}};return P&&n.push(P.buffer),M&&n.push(M.buffer),n.push(I),n.push(O.buffer),n.push(S.buffer),n.push(U.buffer),{componentOffsets:M,featureIds:P,transformedGeometry:F,obb:T.obb}}function c(e){const{context:t,buffer:r}=e,n=i._malloc(r.byteLength),o=r.byteLength/Float64Array.BYTES_PER_ELEMENT,s=new Float64Array(i.HEAPU8.buffer,n,o),f=new Float64Array(r);s.set(f),i.filterOBBs(t,n,o),f.set(s),i._free(n)}function l(e){i&&i.destroy(e)}function u(e,t){for(let r=0;r<t.length;++r)e[r]=t[r]}function y(){return i?n.resolve():(s||(s=o.getWorkerModule().then((e=>{i=e,s=null}))),s)}const b={transform:a,destroy:l};e.destroyContext=function(e){l(e)},e.dracoDecompressPointCloudData=async function(e){var r;await y();const n=[e.geometryBuffer],{geometryBuffer:o}=e,s=o.byteLength,f=i._malloc(s),a=new Uint8Array(i.HEAPU8.buffer,f,s);a.set(new Uint8Array(o));const c=i.dracoDecompressPointCloudData(f,a.byteLength);if(i._free(f),c.error.length>0)throw`i3s.wasm: ${c.error}`;const l=(null==(r=c.featureIds)?void 0:r.length)>0?t.slice(c.featureIds):null,u=t.slice(c.positions);return l&&n.push(l.buffer),n.push(u.buffer),{result:{positions:u,featureIds:l},transferList:n}},e.filterObbsForModifications=async function(e){await y(),c(e);const t={buffer:e.buffer};return{result:t,transferList:[t.buffer]}},e.filterObbsForModificationsSync=c,e.initialize=y,e.interpretObbModificationResults=function(e){return 0===e?0:1===e?1:2===e?2:3},e.process=async function(e){await y();const t=[e.geometryBuffer];return{result:a(e,t),transferList:t}},e.setLegacySchema=async function(e){await y(),i.setLegacySchema(e.context,e.jsonSchema)},e.setModifications=async function(e){await y(),f(e)},e.setModificationsSync=f,e.test=b,Object.defineProperty(e,"__esModule",{value:!0})}));
