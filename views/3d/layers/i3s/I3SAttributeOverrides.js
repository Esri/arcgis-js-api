/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/Logger","../../../../core/arrayUtils","../../../../core/promiseUtils","../../../../intl/number","../../../../request","../../../../core/asyncUtils","../../../../core/byteSizeEstimations","../../../../layers/support/featureQueryAll"],(function(e,t,i,s,r,n,a,o,c,d,h){"use strict";const u=s.getLogger("esri.views.3d.layers.i3s.I3SAttributeOverrides");let l=function(){function e(e,t){this.layer=e,this.warnMaximumChangedObjectsExceeded=!1,this.changedObjectIds=new Set,this.pendingFetchAbortController=n.createAbortController(),this.interactiveEditingSessions=null,this._maximumNumberOfEditOVerrides=f,this.memCache=t.getMemCache(`${e.uid}-attribute-overrides`),this.pendingFetchChangedObjectIds=this.fetchChangedObjectIds(this.pendingFetchAbortController.signal),this.pendingFetchChangedObjectIds.then((()=>this.pendingFetchAbortController=null))}var s=e.prototype;return s.destroy=function(){this.layer=null,this.memCache.destroy(),this.memCache=null,this.pendingFetchAbortController&&(this.pendingFetchAbortController.abort(),this.pendingFetchAbortController=null),this.pendingFetchChangedObjectIds=null},s.createInteractiveEditSession=function(e){this.changedObjectIds.add(e),i.isNone(this.interactiveEditingSessions)&&(this.interactiveEditingSessions=[]);const t=this.interactiveEditingSessions,s=new m(e,{rollback:()=>{r.remove(t,s),0===t.length&&(this.interactiveEditingSessions=null)},commit:t=>{for(const[i,s]of t)this.updateValue(e,i,s)}});return t.unshift(s),s},s.apply=async function(e,t,s){if(i.isNone(t))return;const{loadedAttributes:r,attributeData:a}=t;if(i.isNone(r)||0===r.length||i.isNone(a))return;if(await n.whenOrAbort(this.pendingFetchChangedObjectIds,s),0===this.changedObjectIds.size)return;const o={loadedAttributes:r,attributeData:a},c=this.getOverridesFromCache(e,o,this.changedObjectIds),{objectIds:d,fieldNames:h}=c,u=await this.queryOverridesFromAssociatedLayer(d,h,s);i.isNone(u)||this.processOverridesFromAssociatedLayer(e,u,h,o)},s.updateValue=function(e,t,i){this.changedObjectIds.add(e),this.cacheValue(e,t,i)},s.cacheValue=function(e,t,i){this.memCache.put(this.getCacheKey(e,t),i,this.memCacheValueSize(i))},s.getOverridesFromCache=function(e,{loadedAttributes:t,attributeData:i},s){const r=new Set,n=new Array;for(const o of t)n[o.index]=i[o.name];const a=new Set;for(let o=0;o<e.length;o++){const i=e[o];if(s.has(i))for(const e of t){const t=this.fromCache(i,e.index);void 0===t?(r.add(i),a.add(e.name)):n[e.index][o]=t}}return{objectIds:Array.from(r),fieldNames:Array.from(a)}},s.fromCache=function(e,t){const i=this.fromInteractiveEditingSession(e,t);if(void 0!==i)return i;const s=this.getCacheKey(e,t);return this.memCache.get(s)},s.fromInteractiveEditingSession=function(e,t){if(!i.isNone(this.interactiveEditingSessions))for(const i of this.interactiveEditingSessions){if(i.objectId!==e)continue;const s=i.get(t);if(void 0!==s)return s}},s.getCacheKey=function(e,t){return`${e}-${t}`},s.queryOverridesFromAssociatedLayer=async function(e,t,s){if(0===e.length||0===t.length)return null;e=e.sort(((e,t)=>e-t)),this.warnMaximumChangedObjectsExceeded&&(this.warnMaximumChangedObjectsExceeded=!1,this.logMaximumObjectsExceededWarning());const n=i.unwrap(this.layer.associatedLayer),a=n.createQuery();a.where="1=1",a.returnGeometry=!1,a.outFields=[n.objectIdField,...t],a.cacheHint=!0,a.objectIds=e;const o=h.getMaximumQuerySize(n),d=e.length>o?r.splitIntoChunks(e,o).map((e=>{const t=a.clone();return t.objectIds=e,c.resultOrAbort(h.queryAllJSON(n,t,{signal:s}))})):[c.resultOrAbort(h.queryAllJSON(n,a,{signal:s}))];return(await Promise.all(d)).reduce(((e,t)=>e.concat(t.ok?t.value.features:[])),[])},s.logMaximumObjectsExceededWarning=function(){let e=`The number of edited objects that are not yet cached in the scene service exceeds the maximum limit. Attribute changes will only be available for the first ${a.formatNumber(this._maximumNumberOfEditOVerrides)} objects. Please consider re-caching the scene service`;const t=this.layer.portalItem;t&&t.loaded?e+=` (${t.portal.url}/home/item.html?id=${t.id}#settings)`:e+=` (${this.layer.parsedUrl.path})`,u.warn(`("${this.layer.title}"):`,`${e}.`)},s.processOverridesFromAssociatedLayer=function(e,t,s,{loadedAttributes:r,attributeData:n}){const a=i.unwrap(this.layer.associatedLayer).objectIdField,o=s.map((e=>n[e])),c=new Map(r.map((e=>[e.name,e.index]))),d=s.map((e=>c.get(e))),h=new Map(Array.from(e,((e,t)=>[e,t])));for(const i of t){const e=i.attributes[a];for(let t=0;t<s.length;t++){const r=d[t],n=h.get(e),a=i.attributes[s[t]];o[t][n]=a,this.cacheValue(e,r,a)}}},s.memCacheValueSize=function(e){return"string"==typeof e?d.estimateStringByteSize(e):d.estimateNumberByteSize()},s.fetchChangedObjectIds=async function(e){var t,s,r;const n=this.layer;if(await n.load({signal:e}),this.changedObjectIds.clear(),i.isNone(n.associatedLayer)||null==(t=n.associatedLayer.capabilities)||null==(s=t.operations)||!s.supportsChangeTracking)return;const a=this.getFetchChangedObjectIdsServerGen();if(i.isNone(a))return null;const d=n.associatedLayer.layerId,h=await c.result(o(`${n.associatedLayer.url}/extractChanges`,{method:"post",query:{f:"json",returnIdsOnly:!0,layers:`${d}`,returnUpdates:!0,returnDeletes:!1,returnInserts:!1,layerServerGens:JSON.stringify([{id:d,serverGen:a}])},timeout:g,signal:e})),u=h.ok&&null!=(r=h.value.data)&&r.edits?i.get(h.value.data.edits[0],"objectIds","updates"):null;if(i.isSome(u)){const e=Math.min(this._maximumNumberOfEditOVerrides,u.length);e<u.length&&(this.warnMaximumChangedObjectsExceeded=!0);const t=u.sort(((e,t)=>e-t));for(let i=0;i<e;i++)this.changedObjectIds.add(t[i])}},s.getFetchChangedObjectIdsServerGen=function(){const e=this.layer;if(i.isSome(e.serviceUpdateTimeStamp)&&i.isSome(e.serviceUpdateTimeStamp.lastUpdate))return e.serviceUpdateTimeStamp.lastUpdate;const t=e.associatedLayer;return i.isSome(t)&&i.isSome(t.serverGens)&&i.isSome(t.serverGens.minServerGen)?t.serverGens.minServerGen:null},t._createClass(e,[{key:"test",get:function(){const e=Array.from(this.changedObjectIds),t=this.pendingFetchChangedObjectIds,i=this;return{changedObjectIds:e,pendingFetchChangedObjectIds:t,get maximumNumberOfEditOVerrides(){return i._maximumNumberOfEditOVerrides},set maximumNumberOfEditOVerrides(e){i._maximumNumberOfEditOVerrides=e}}}}]),e}(),m=function(){function e(e,t){this.objectId=e,this.options=t,this.updates=new Map,this.state=0}var i=e.prototype;return i.get=function(e){return this.updates.get(e)},i.set=function(e,t){this.isActive&&this.updates.set(e,t)},i.rollback=function(){this.isActive&&(this.state=2,this.options.rollback())},i.commit=function(){this.isActive&&(this.state=1,this.options.commit(this.updates),this.updates.clear())},t._createClass(e,[{key:"isActive",get:function(){return 0===this.state}}]),e}();const g=1e4,f=5e4;e.I3SAttributeOverrides=l,Object.defineProperty(e,"__esModule",{value:!0})}));
