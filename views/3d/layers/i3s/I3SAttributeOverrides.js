/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../request","../../../../core/arrayUtils","../../../../core/asyncUtils","../../../../core/byteSizeEstimations","../../../../core/Logger","../../../../core/maybe","../../../../core/promiseUtils","../../../../intl/number","../../../../layers/support/featureQueryAll"],(function(e,t,i,s,r,n,a,o,c,d,u){"use strict";const h=a.getLogger("esri.views.3d.layers.i3s.I3SAttributeOverrides");let l=function(){function e(e,t){this.layer=e,this.warnMaximumChangedObjectsExceeded=!1,this.changedObjectIds=new Set,this.pendingFetchAbortController=c.createAbortController(),this.interactiveEditingSessions=null,this._maximumNumberOfEditOVerrides=f,this.memCache=t.getMemCache(`${e.uid}-attribute-overrides`),this.pendingFetchChangedObjectIds=this.fetchChangedObjectIds(this.pendingFetchAbortController.signal),this.pendingFetchChangedObjectIds.then((()=>this.pendingFetchAbortController=null))}var a=e.prototype;return a.destroy=function(){this.layer=null,this.memCache.destroy(),this.memCache=null,this.pendingFetchAbortController&&(this.pendingFetchAbortController.abort(),this.pendingFetchAbortController=null),this.pendingFetchChangedObjectIds=null},a.createInteractiveEditSession=function(e){this.changedObjectIds.add(e),o.isNone(this.interactiveEditingSessions)&&(this.interactiveEditingSessions=[]);const t=this.interactiveEditingSessions,i=new m(e,{rollback:()=>{s.remove(t,i),0===t.length&&(this.interactiveEditingSessions=null)},commit:t=>{for(const[i,s]of t)this.updateValue(e,i,s)}});return t.unshift(i),i},a.apply=function(){var e=t._asyncToGenerator((function*(e,t,i){if(o.isNone(t))return;const{loadedAttributes:s,attributeData:r}=t;if(o.isNone(s)||0===s.length||o.isNone(r))return;if(yield c.whenOrAbort(this.pendingFetchChangedObjectIds,i),0===this.changedObjectIds.size)return;const n={loadedAttributes:s,attributeData:r},a=this.getOverridesFromCache(e,n,this.changedObjectIds),{objectIds:d,fieldNames:u}=a,h=yield this.queryOverridesFromAssociatedLayer(d,u,i);o.isNone(h)||this.processOverridesFromAssociatedLayer(e,h,u,n)}));function i(t,i,s){return e.apply(this,arguments)}return i}(),a.updateValue=function(e,t,i){this.changedObjectIds.add(e),this.cacheValue(e,t,i)},a.cacheValue=function(e,t,i){this.memCache.put(this.getCacheKey(e,t),i,this.memCacheValueSize(i))},a.getOverridesFromCache=function(e,{loadedAttributes:t,attributeData:i},s){const r=new Set,n=new Array;for(const o of t)n[o.index]=i[o.name];const a=new Set;for(let o=0;o<e.length;o++){const i=e[o];if(s.has(i))for(const e of t){const t=this.fromCache(i,e.index);void 0===t?(r.add(i),a.add(e.name)):n[e.index][o]=t}}return{objectIds:Array.from(r),fieldNames:Array.from(a)}},a.fromCache=function(e,t){const i=this.fromInteractiveEditingSession(e,t);if(void 0!==i)return i;const s=this.getCacheKey(e,t);return this.memCache.get(s)},a.fromInteractiveEditingSession=function(e,t){if(!o.isNone(this.interactiveEditingSessions))for(const i of this.interactiveEditingSessions){if(i.objectId!==e)continue;const s=i.get(t);if(void 0!==s)return s}},a.getCacheKey=function(e,t){return`${e}-${t}`},a.queryOverridesFromAssociatedLayer=function(){var e=t._asyncToGenerator((function*(e,t,i){if(0===e.length||0===t.length)return null;e=e.sort(((e,t)=>e-t)),this.warnMaximumChangedObjectsExceeded&&(this.warnMaximumChangedObjectsExceeded=!1,this.logMaximumObjectsExceededWarning());const n=o.unwrap(this.layer.associatedLayer),a=n.createQuery();a.where="1=1",a.returnGeometry=!1,a.outFields=[n.objectIdField,...t],a.cacheHint=!0,a.objectIds=e;const c=u.getMaximumQuerySize(n),d=e.length>c?s.splitIntoChunks(e,c).map((e=>{const t=a.clone();return t.objectIds=e,r.resultOrAbort(u.queryAllJSON(n,t,{signal:i}))})):[r.resultOrAbort(u.queryAllJSON(n,a,{signal:i}))];return(yield Promise.all(d)).reduce(((e,t)=>e.concat(t.ok?t.value.features:[])),[])}));function i(t,i,s){return e.apply(this,arguments)}return i}(),a.logMaximumObjectsExceededWarning=function(){let e=`The number of edited objects that are not yet cached in the scene service exceeds the maximum limit. Attribute changes will only be available for the first ${d.formatNumber(this._maximumNumberOfEditOVerrides)} objects. Please consider re-caching the scene service`;const t=this.layer.portalItem;t&&t.loaded?e+=` (${t.portal.url}/home/item.html?id=${t.id}#settings)`:e+=` (${this.layer.parsedUrl.path})`,h.warn("#queryOverrides()",this.layer.title,`${e}.`)},a.processOverridesFromAssociatedLayer=function(e,t,i,{loadedAttributes:s,attributeData:r}){const n=o.unwrap(this.layer.associatedLayer).objectIdField,a=i.map((e=>r[e])),c=new Map(s.map((e=>[e.name,e.index]))),d=i.map((e=>c.get(e))),u=new Map(Array.from(e,((e,t)=>[e,t])));for(const o of t){const e=o.attributes[n];for(let t=0;t<i.length;t++){const s=d[t],r=u.get(e),n=o.attributes[i[t]];a[t][r]=n,this.cacheValue(e,s,n)}}},a.memCacheValueSize=function(e){return"string"==typeof e?n.estimateStringByteSize(e):n.estimateNumberByteSize()},a.fetchChangedObjectIds=function(){var e=t._asyncToGenerator((function*(e){var t,s,n;const a=this.layer;if(yield a.load({signal:e}),this.changedObjectIds.clear(),o.isNone(a.associatedLayer)||null==(t=a.associatedLayer.capabilities)||null==(s=t.operations)||!s.supportsChangeTracking)return;const c=this.getFetchChangedObjectIdsServerGen();if(o.isNone(c))return null;const d=a.associatedLayer.layerId,u=yield r.result(i(`${a.associatedLayer.url}/extractChanges`,{method:"post",query:{f:"json",returnIdsOnly:!0,layers:`${d}`,returnUpdates:!0,returnDeletes:!1,returnInserts:!1,layerServerGens:JSON.stringify([{id:d,serverGen:c}])},timeout:g,signal:e})),h=u.ok&&null!=(n=u.value.data)&&n.edits?o.get(u.value.data.edits[0],"objectIds","updates"):null;if(o.isSome(h)){const e=Math.min(this._maximumNumberOfEditOVerrides,h.length);e<h.length&&(this.warnMaximumChangedObjectsExceeded=!0);const t=h.sort(((e,t)=>e-t));for(let i=0;i<e;i++)this.changedObjectIds.add(t[i])}}));function s(t){return e.apply(this,arguments)}return s}(),a.getFetchChangedObjectIdsServerGen=function(){const e=this.layer;if(o.isSome(e.serviceUpdateTimeStamp)&&o.isSome(e.serviceUpdateTimeStamp.lastUpdate))return e.serviceUpdateTimeStamp.lastUpdate;const t=e.associatedLayer;return o.isSome(t)&&o.isSome(t.serverGens)&&o.isSome(t.serverGens.minServerGen)?t.serverGens.minServerGen:null},t._createClass(e,[{key:"test",get:function(){const e=Array.from(this.changedObjectIds),t=this.pendingFetchChangedObjectIds,i=this;return{changedObjectIds:e,pendingFetchChangedObjectIds:t,get maximumNumberOfEditOVerrides(){return i._maximumNumberOfEditOVerrides},set maximumNumberOfEditOVerrides(e){i._maximumNumberOfEditOVerrides=e}}}}]),e}(),m=function(){function e(e,t){this.objectId=e,this.options=t,this.updates=new Map,this.state=0}var i=e.prototype;return i.get=function(e){return this.updates.get(e)},i.set=function(e,t){this.isActive&&this.updates.set(e,t)},i.rollback=function(){this.isActive&&(this.state=2,this.options.rollback())},i.commit=function(){this.isActive&&(this.state=1,this.options.commit(this.updates),this.updates.clear())},t._createClass(e,[{key:"isActive",get:function(){return 0===this.state}}]),e}();const g=1e4,f=5e4;e.I3SAttributeOverrides=l,Object.defineProperty(e,"__esModule",{value:!0})}));
