/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/Logger","../../../../core/arrayUtils","../../../../core/promiseUtils","../../../../intl/number","../../../../request","../../../../core/asyncUtils","../../../../core/byteSizeEstimations","../../../../layers/support/featureQueryAll"],(function(e,t,i,s,n,r,a,o,c,d,h){"use strict";const l=s.getLogger("esri.views.3d.layers.i3s.I3SAttributeOverrides");let u=function(){function e(e,t){this.layer=e,this.warnMaximumChangedObjectsExceeded=!1,this.changedObjectIds=new Set,this.pendingFetchAbortController=r.createAbortController(),this.interactiveEditingSessions=null,this.memCache=t.getMemCache(`${e.uid}-attribute-overrides`),this.pendingFetchChangedObjectIds=this.fetchChangedObjectIds(this.pendingFetchAbortController.signal),this.pendingFetchChangedObjectIds.then((()=>this.pendingFetchAbortController=null))}var t=e.prototype;return t.destroy=function(){this.layer=null,this.memCache.destroy(),this.memCache=null,this.pendingFetchAbortController&&(this.pendingFetchAbortController.abort(),this.pendingFetchAbortController=null),this.pendingFetchChangedObjectIds=null},t.createInteractiveEditSession=function(e){this.changedObjectIds.add(e),i.isNone(this.interactiveEditingSessions)&&(this.interactiveEditingSessions=[]);const t=this.interactiveEditingSessions,s=new m(e,{rollback:()=>{n.remove(t,s),0===t.length&&(this.interactiveEditingSessions=null)},commit:t=>{for(const[i,s]of t)this.updateValue(e,i,s)}});return t.unshift(s),s},t.apply=async function(e,t,s){if(i.isNone(t))return;const{loadedAttributes:n,attributeData:a}=t;if(i.isNone(n)||0===n.length||i.isNone(a))return;if(await r.whenOrAbort(this.pendingFetchChangedObjectIds,s),0===this.changedObjectIds.size)return;const o={loadedAttributes:n,attributeData:a},c=this.getOverridesFromCache(e,o,this.changedObjectIds),{objectIds:d,fieldNames:h}=c,l=await this.queryOverridesFromAssociatedLayer(d,h,s);i.isNone(l)||this.processOverridesFromAssociatedLayer(e,l,h,o)},t.updateValue=function(e,t,i){this.changedObjectIds.add(e),this.cacheValue(e,t,i)},t.cacheValue=function(e,t,i){this.memCache.put(this.getCacheKey(e,t),i,this.memCacheValueSize(i))},t.getOverridesFromCache=function(e,{loadedAttributes:t,attributeData:i},s){const n=new Set,r=new Array;for(const e of t)r[e.index]=i[e.name];const a=new Set;for(let i=0;i<e.length;i++){const o=e[i];if(s.has(o))for(const e of t){const t=this.fromCache(o,e.index);void 0===t?(n.add(o),a.add(e.name)):r[e.index][i]=t}}return{objectIds:Array.from(n),fieldNames:Array.from(a)}},t.fromCache=function(e,t){const i=this.fromInteractiveEditingSession(e,t);if(void 0!==i)return i;const s=this.getCacheKey(e,t);return this.memCache.get(s)},t.fromInteractiveEditingSession=function(e,t){if(!i.isNone(this.interactiveEditingSessions))for(const i of this.interactiveEditingSessions){if(i.objectId!==e)continue;const s=i.get(t);if(void 0!==s)return s}},t.getCacheKey=function(e,t){return`${e}-${t}`},t.queryOverridesFromAssociatedLayer=async function(e,t,s){if(0===e.length||0===t.length)return null;e=e.sort(((e,t)=>e-t)),this.warnMaximumChangedObjectsExceeded&&(this.warnMaximumChangedObjectsExceeded=!1,this.logMaximumObjectsExceededWarning());const a=i.unwrap(this.layer.associatedLayer),o=a.createQuery();o.where="1=1",o.returnGeometry=!1,o.outFields=[a.objectIdField,...t],o.cacheHint=!0,o.objectIds=e;const d=h.getMaximumQuerySize(a),l=e.length>d?n.splitIntoChunks(e,d).map((e=>{const t=o.clone();return t.objectIds=e,c.resultOrAbort(h.queryAllJSON(a,t,{signal:s}))})):[c.resultOrAbort(h.queryAllJSON(a,o,{signal:s}))];return(await r.all(l)).reduce(((e,t)=>e.concat(t.ok?t.value.features:[])),[])},t.logMaximumObjectsExceededWarning=function(){let e=`The number of edited objects that are not yet cached in the scene service exceeds the maximum limit. Attribute changes will only be available for the first ${a.formatNumber(f)} objects. Please consider re-caching the scene service`;const t=this.layer.portalItem;t&&t.loaded?e+=` (${t.portal.url}/home/item.html?id=${t.id}#settings)`:e+=` (${this.layer.parsedUrl.path})`,l.warn(`("${this.layer.title}"):`,`${e}.`)},t.processOverridesFromAssociatedLayer=function(e,t,s,{loadedAttributes:n,attributeData:r}){const a=i.unwrap(this.layer.associatedLayer).objectIdField,o=s.map((e=>r[e])),c=new Map(n.map((e=>[e.name,e.index]))),d=s.map((e=>c.get(e))),h=new Map(Array.from(e,((e,t)=>[e,t])));for(const e of t){const t=e.attributes[a];for(let i=0;i<s.length;i++){const n=d[i],r=h.get(t),a=e.attributes[s[i]];o[i][r]=a,this.cacheValue(t,n,a)}}},t.memCacheValueSize=function(e){return"string"==typeof e?d.estimateStringByteSize(e):d.estimateNumberByteSize()},t.fetchChangedObjectIds=async function(e){var t,s,n;const r=this.layer;if(this.changedObjectIds.clear(),i.isNone(r.associatedLayer)||null==(t=r.associatedLayer.capabilities)||null==(s=t.operations)||!s.supportsChangeTracking)return;const a=this.getFetchChangedObjectIdsServerGen();if(i.isNone(a))return null;const d=r.associatedLayer.layerId,h=await c.result(o(`${r.associatedLayer.url}/extractChanges`,{method:"post",query:{f:"json",returnIdsOnly:!0,layers:`${d}`,returnUpdates:!0,returnDeletes:!1,returnInserts:!1,layerServerGens:JSON.stringify([{id:d,serverGen:a}])},timeout:g,signal:e})),l=h.ok&&null!=(n=h.value.data)&&n.edits?i.get(h.value.data.edits[0],"objectIds","updates"):null;if(i.isSome(l)){const e=Math.min(f,l.length);e<l.length&&(this.warnMaximumChangedObjectsExceeded=!0);const t=l.sort(((e,t)=>e-t));for(let i=0;i<e;i++)this.changedObjectIds.add(t[i])}},t.getFetchChangedObjectIdsServerGen=function(){const e=this.layer;if(i.isSome(e.serviceUpdateTimeStamp)&&i.isSome(e.serviceUpdateTimeStamp.lastUpdate))return e.serviceUpdateTimeStamp.lastUpdate;const t=e.associatedLayer;return i.isSome(t)&&i.isSome(t.serverGens)&&i.isSome(t.serverGens.minServerGen)?t.serverGens.minServerGen:null},e}(),m=function(){function e(e,t){this.objectId=e,this.options=t,this.updates=new Map,this.state=0}var i=e.prototype;return i.get=function(e){return this.updates.get(e)},i.set=function(e,t){this.isActive&&this.updates.set(e,t)},i.rollback=function(){this.isActive&&(this.state=2,this.options.rollback())},i.commit=function(){this.isActive&&(this.state=1,this.options.commit(this.updates),this.updates.clear())},t._createClass(e,[{key:"isActive",get:function(){return 0===this.state}}]),e}();const g=1e4,f=5e4;e.I3SAttributeOverrides=u,Object.defineProperty(e,"__esModule",{value:!0})}));
