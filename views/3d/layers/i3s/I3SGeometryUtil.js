// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","./I3SBinaryReader","../../support/meshProcessing","../../webgl-engine/lib/gl-matrix","../../webgl-engine/lib/Util"],function(e,r,t,n,a,i){function o(e,r,t,n,a){void 0===n&&(n=[]),void 0===a&&(a=[]);var i=e.params.vertexAttributes,o=i.position.count;if(!d(t[0].stride))throw l("Layout stride must use "+Uint32Array.BYTES_PER_ELEMENT+"-byte words");var v=t[0].stride/Uint32Array.BYTES_PER_ELEMENT,y=new Uint32Array(v*o);t=t.slice(0).sort(function(e,r){return e.offset-r.offset});for(var m=0,w=t;m<w.length;m++){var A=w[m];!function(e){if(-1!==a.indexOf(e.name))return"continue";var t=i[e.name],v=c(e.type),m=void 0,w=!1;if(null==t){var A=n.filter(function(r){return r.name===e.name})[0];if(!A)throw l("Geometry definition is missing attribute");t={valueType:u(e.type),byteOffset:0,count:o,valuesPerElement:e.count};for(var T=0;T<h.length;T++)h[T]=A.byteValue;m=h.buffer,w=!0}else m=r;if(u(e.type)!==t.valueType)throw l("Geometry definition type must match attribute type");if(!E(t.byteOffset)||!E(e.offset))throw l(e.name+" offset must use "+Uint32Array.BYTES_PER_ELEMENT+"-byte words");if(!d(t.valuesPerElement*v.BYTES_PER_ELEMENT)||!d(e.count*v.BYTES_PER_ELEMENT))throw l(e.name+" data must use "+Uint32Array.BYTES_PER_ELEMENT+"-byte words");var b=new Uint32Array(m),I=t.byteOffset/Uint32Array.BYTES_PER_ELEMENT,U=t.valuesPerElement*v.BYTES_PER_ELEMENT/Uint32Array.BYTES_PER_ELEMENT,_=e.offset/Uint32Array.BYTES_PER_ELEMENT,p=e.stride/Uint32Array.BYTES_PER_ELEMENT;w?f(b[0],U,y,_,p,o):s(b,I,U,y,_,p,o)}(A)}return y.buffer}function s(e,r,t,n,a,i,o){switch(t){case 1:for(var s=0;s<o;s++)n[a]=e[r],r+=1,a+=i;break;case 2:for(var s=0;s<o;s++)n[a]=e[r],n[a+1]=e[r+1],r+=2,a+=i;break;case 3:for(var s=0;s<o;s++)n[a]=e[r],n[a+1]=e[r+1],n[a+2]=e[r+2],r+=3,a+=i;break;case 4:for(var s=0;s<o;s++)n[a]=e[r],n[a+1]=e[r+1],n[a+2]=e[r+2],n[a+3]=e[r+3],r+=4,a+=i;break;default:throw l("Unhandled stride size "+t)}}function f(e,r,t,n,a,i){switch(r){case 1:for(var o=0;o<i;o++)t[n]=e,n+=a;break;case 2:for(var o=0;o<i;o++)t[n]=e,t[n+1]=e,n+=a;break;case 3:for(var o=0;o<i;o++)t[n]=e,t[n+1]=e,t[n+2]=e,n+=a;break;case 4:for(var o=0;o<i;o++)t[n]=e,t[n+1]=e,t[n+2]=e,t[n+3]=e,n+=a;break;default:throw l("Unhandled stride size "+r)}}function c(e){switch(e){case 5120:return Int8Array;case 5126:return Float32Array;case 5124:return Int32Array;case 5122:return Int16Array;case 5121:return Uint8Array;case 5125:return Uint32Array;case 5123:return Uint16Array}throw new Error("Unhandled data type: "+e)}function u(e){switch(e){case 5120:return"Int8";case 5126:return"Float32";case 5124:return"Int32";case 5122:return"Int16";case 5121:return"UInt8";case 5125:return"UInt32";case 5123:return"UInt16"}throw new Error("Unhandled data type: "+e)}function E(e){return e%Uint32Array.BYTES_PER_ELEMENT==0}function d(e){return e>0&&e%Uint32Array.BYTES_PER_ELEMENT==0}function l(e){return new Error("I3SGeometryUtil processing failed: "+e)}function v(e,r,n,a,i){if("none"===e)y(i);else{var o=t.createTypedView(n,r.params.vertexAttributes.normal),s="earth-centered"===e?a:null;m(o,i.normals,s)}}function y(e){var r=e.normals,t=e.positions,n=e.normalInd,o=e.positionInd;i.assert(e.normalInd.length===e.positionInd.length);for(var s=a.vec3.create(),f=a.vec3.create(),c=a.vec2.create(),u=t.data,E=t.offsetIdx,d=t.strideIdx,l=r.data,v=r.offsetIdx,y=r.strideIdx,m=0;m<o.length;m+=3){var w=o[m],h=E+d*w,A=u[h],T=u[h+1],b=u[h+2];w=o[m+1],h=E+d*w,s[0]=u[h]-A,s[1]=u[h+1]-T,s[2]=u[h+2]-b,w=o[m+2],h=E+d*w,f[0]=u[h]-A,f[1]=u[h+1]-T,f[2]=u[h+2]-b,a.vec3.cross(s,f,s),i.encodeNormal(s,c);for(var I=0;I<3;I++){var U=n[m+I],_=v+y*U;l[_]=i.encodeInt16(c[0]),l[_+1]=i.encodeInt16(c[1])}}}function m(e,r,t){var n=e.length/3,a=r.data,o=r.offsetIdx,s=r.strideIdx;if(null!=t)for(var f=t,c=f[0],u=f[1],E=f[2],d=f[4],l=f[5],v=f[6],y=f[8],m=f[9],w=f[10],h=0;h<n;h++){var A=e[3*h],I=e[3*h+1],U=e[3*h+2];T[0]=c*A+u*I+E*U,T[1]=d*A+l*I+v*U,T[2]=y*A+m*I+w*U,i.encodeNormal(T,b),a[o+h*s]=i.encodeInt16(b[0]),a[o+h*s+1]=i.encodeInt16(b[1])}else for(var h=0;h<n;h++)T[0]=e[3*h],T[1]=e[3*h+1],T[2]=e[3*h+2],i.encodeNormal(T,b),a[o+h*s]=i.encodeInt16(b[0]),a[o+h*s+1]=i.encodeInt16(b[1])}function w(e,r,t){var a=r[0];if(null==a||"position"!==a.name||5126!==a.type)return null;for(var i=new Float32Array(e),o=a.stride/4,s=3*i.length/o,f=new Float32Array(s),c=0;c<s/3;c++)f[3*c]=i[c*o+a.offset],f[3*c+1]=i[c*o+a.offset+1],f[3*c+2]=i[c*o+a.offset+2];var u,E=n.deduplicate(f.buffer,3),d=E.uniqueCount<A;if(t){u=new(d?Uint16Array:Uint32Array)(t.length);for(var c=0;c<t.length;c++)u[c]=E.indices[t[c]]}else u=d?new Uint16Array(E.indices):E.indices;return{data:new Float32Array(E.buffer),indices:u}}Object.defineProperty(r,"__esModule",{value:!0});var h=new Uint8Array(64);r.interleaveGeometryBuffer=o,r.processAndInterleaveNormals=v;var A=65536;r.extractPositionData=w;var T=a.vec3.create(),b=a.vec2.create()});