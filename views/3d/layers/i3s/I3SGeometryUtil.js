// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../core/arrayUtils","../../../../core/maybe","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../support/projectionUtils","@dojo/framework/shim/Promise"],(function(e,t,r,n,a,o,i,s,c,u){"use strict";var f;function d(){return!!f}function l(e,t){return f.intersects(e,t)?f.contains(e,t)?0:2:1}function g(e,t){return f.intersects(e,t)?f.contains(e,t)?1:2:0}Object.defineProperty(t,"__esModule",{value:!0}),t.boundingBoxTop=t.createGetFeatureExtent=t.boundingBoxCornerPoints=t.filterWithMask=t.testMaskWithGeometry=t.computeMaskNodeMBS=t.acquireMaskFilterContext=t.processFilterGeometry=t.loadGeometryEngine=t.isGeometryEngineLoaded=void 0,t.isGeometryEngineLoaded=d,t.loadGeometryEngine=function(){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){switch(t.label){case 0:return d()?[2,f]:[4,new Promise((function(t,r){e(["../../../../geometry/geometryEngine"],t,r)}))];case 1:return[2,f=t.sent()]}}))}))},t.processFilterGeometry=function(e,t){if(!e)return null;if("disjoint"===t&&"polygon"===e.type){for(var r=new Array(e.rings.length),a=0;a<e.rings.length;++a){var o=c.fromValues(1/0,1/0,-1/0,-1/0);c.expandWithNestedArray(o,e.rings[a]),r[a]={type:"polygon",rings:[e.rings[a]],spatialReference:e.spatialReference,aabr:o}}r.sort((function(e,t){return e.aabr[0]-t.aabr[0]}));var i=new Set,s=new n.PositionHint,u=function(e){for(var t=r[e],a=e+1;a<r.length;++a){var o=r[a];if(o.aabr[0]>=t.aabr[2])break;i.add(o)}i.forEach((function(e){if(t!==e)if(e.aabr[2]<=t.aabr[0])i.delete(e);else if(f.intersects(t,e)){t.rings=t.rings.concat(e.rings),c.expand(t.aabr,e.aabr),delete t._geVersion,i.delete(e);var a=n.indexOf(r,e,r.length,s);r.splice(a,1)}})),i.add(t)};for(a=0;a<r.length;++a)u(a);for(var d=0,l=r;d<l.length;d++){delete l[d].aabr}return r}return[e]},t.acquireMaskFilterContext=function(e,t,r,n,a){var o,i,s=t.renderSpatialReference,c=new Map,u={rings:[[[0,0,0],[0,0,0],[0,0,0],[0,0,0]]],hasZ:!1,hasM:!1,type:"polygon",spatialReference:r};switch(u.rings[0][3]=u.rings[0][0],e){case"intersects":o=function(e,t){return f.intersects(e,t)?0:2},i=l;break;case"contains":o=function(e,t){return f.contains(e,t)?2:1},i=l;break;case"disjoint":default:o=function(e,t){return f.disjoint(e,t)?2:1},i=g}return{collection:n,object:a,type:e,maskSR:r,renderSR:s,aabbCache:c,triangle:u,positions:{indices:null,data:null,stride:0,startIndex:0,endIndex:0},triangleTest:o,geometryTest:i}},t.computeMaskNodeMBS=function(e,t){var r={x:e[0],y:e[1],hasZ:!1,hasM:!1,type:"point",spatialReference:t.maskSR},n=!t.maskSR.isWGS84&&!t.maskSR.isWebMercator?f.buffer(r,e[3],1):f.geodesicBuffer(r,e[3],1);return n.type="polygon",n},t.testMaskWithGeometry=function(e,t,r){switch(r){case"intersects":case"contains":return l(e,t);case"disjoint":return g(e,t)}};var p=Math.pow(2,-32);function v(e,t,r,n){for(var a=t.getComponentAabb(r,e,m),i=t.getObjectTransform(r),s=0;s<8;++s)b[0]=1&s?a[0]:a[3],b[1]=2&s?a[1]:a[4],b[2]=4&s?a[2]:a[5],o.vec3.transformMat3(b,b,i.rotationScale),o.vec3.add(b,b,i.position),n[3*s]=b[0],n[3*s+1]=b[1],n[3*s+2]=b[2];return n}t.filterWithMask=function(e,t,r){var n=r.collection,a=r.object,i=r.renderSR,s=r.maskSR,c=r.geometryTest,f=r.aabbCache,d=f.get(t);if(!d){var l=n.getObjectTransform(a);n.getComponentAabb(a,t,m);for(var g=[[m[0],m[1],0],[m[0],m[4],0],[m[3],m[4],0],[m[3],m[1],0]],v=0;v<4;++v)o.vec3.transformMat3(g[v],g[v],l.rotationScale),o.vec3.add(g[v],g[v],l.position),u.vectorToVector(g[v],i,g[v],s);(d={rings:[g],hasZ:!1,hasM:!1,type:"polygon",spatialReference:s}).rings[0][4]=d.rings[0][0],f.set(t,d)}switch(c(e,d)){case 1:return!1;case 0:return!0}var b=r.triangle,y=r.triangleTest,h=r.positions,x=b.rings[0][0],M=b.rings[0][1],T=b.rings[0][2],S=n.getObjectTransform(a);n.getComponentPositions(a,t,h);var E=h.indices,I=h.data,k=h.stride,w=h.startIndex,R=h.endIndex;for(v=w;v<R;v+=3){var j=k*E[v+0],N=k*E[v+1],B=k*E[v+2];o.vec3.set(x,I[j+0],I[j+1],I[j+2]),o.vec3.set(M,I[N+0],I[N+1],I[N+2]),o.vec3.set(T,I[B+0],I[B+1],I[B+2]),o.vec3.transformMat3(x,x,S.rotationScale),o.vec3.transformMat3(M,M,S.rotationScale),o.vec3.transformMat3(T,T,S.rotationScale),o.vec3.add(x,x,S.position),o.vec3.add(M,M,S.position),o.vec3.add(T,T,S.position),u.vectorToVector(x,i,x,s),u.vectorToVector(M,i,M,s),u.vectorToVector(T,i,T,s);var F=M[0]-x[0],_=M[1]-x[1],G=T[0]-x[0],A=T[1]-x[1];if(!(Math.abs(F*A-_*G)<p))switch(delete b._geVersion,y(e,b)){case 1:return!1;case 0:return!0}}switch(r.type){case"intersects":return!1;case"contains":case"disjoint":default:return!0}},t.boundingBoxCornerPoints=v,t.createGetFeatureExtent=function(e,t,r){var n=new Float64Array(24);return function(o){var i=o.meta.featureExtents;if(a.isNone(i)){i=new Float64Array(6*o.meta.featureIds.length),o.meta.featureExtents=i;for(var c=0;c<i.length;c+=6)i[c]=Number.POSITIVE_INFINITY}var f=new Float64Array(i.buffer,6*o.index*Float64Array.BYTES_PER_ELEMENT,6);return f[0]===Number.POSITIVE_INFINITY&&(v(o.index,r,o.meta.objectHandle,n),u.bufferToBuffer(n,t,0,n,e,0,8)?s.expandWithBuffer(s.NEGATIVE_INFINITY,n,0,8,f):s.set(f,s.ZERO)),f}},t.boundingBoxTop=function(e,t,r,n){var a=t.getComponentAabb(r,e,m),i=t.getObjectTransform(r);n[0]=0,n[1]=0,n[2]=0;for(var s=0;s<8;++s)b[0]=1&s?a[0]:a[3],b[1]=2&s?a[1]:a[4],b[2]=a[5],o.vec3.transformMat3(b,b,i.rotationScale),o.vec3.add(b,b,i.position),n[0]+=b[0],n[1]+=b[1],n[2]+=b[2];return n[0]/=8,n[1]/=8,n[2]/=8,n};var m=s.create(),b=i.vec3f64.create()}));