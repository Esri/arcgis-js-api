// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../core/Error","../../../../core/lang","../../../../core/Logger","./LEPCC"],(function(e,t,r,n,a,o,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getBytesPerValue=t.isValueType=t.valueType2ArrayBufferReader=t.valueType2TypedArrayClassMap=t.readBinaryAttribute=t.createGeometryDescriptorForDraco=t.createGeometryDescriptorFromSchema=t.createGeometryDescriptor=t.createGeometryIndexFromSchema=t.createGeometryDescriptorFromDefinition=t.createAttributeDataIndex=t.createRawView=t.createTypedView=t.readStringArray=t.readHeader=void 0;var u=o.getLogger("esri.views.3d.layers.i3s.I3SBinaryReader");function s(e,t,r){for(var a="",o=0;o<r;){var i=e[t+o];if(i<128)a+=String.fromCharCode(i),o++;else if(i>=192&&i<224){if(o+1>=r)throw new n("utf8-decode-error","UTF-8 Decode failed. Two byte character was truncated.");var u=(31&i)<<6|63&e[t+o+1];a+=String.fromCharCode(u),o+=2}else if(i>=224&&i<240){if(o+2>=r)throw new n("utf8-decode-error","UTF-8 Decode failed. Multi byte character was truncated.");u=(15&i)<<12|(63&e[t+o+1])<<6|63&e[t+o+2];a+=String.fromCharCode(u),o+=3}else{if(!(i>=240&&i<248))throw new n("utf8-decode-error","UTF-8 Decode failed. Invalid multi byte sequence.");if(o+3>=r)throw new n("utf8-decode-error","UTF-8 Decode failed. Multi byte character was truncated.");if((u=(7&i)<<18|(63&e[t+o+1])<<12|(63&e[t+o+2])<<6|63&e[t+o+3])>=65536){var s=55296+(u-65536>>10),c=56320+(1023&u);a+=String.fromCharCode(s,c)}else a+=String.fromCharCode(u);o+=4}}return a}function c(e,r){for(var n={byteOffset:0,byteCount:0,fields:Object.create(null)},a=0,o=0;o<r.length;o++){var i=r[o],u=i.valueType||i.type,s=t.valueType2ArrayBufferReader[u];n.fields[i.property]=s(e,a),a+=t.valueType2TypedArrayClassMap[u].BYTES_PER_ELEMENT}return n.byteCount=a,n}function f(e,t,r){var a,o,i=[],u=0;for(o=0;o<e;o+=1){if((a=t[o])>0){if(i.push(s(r,u,a-1)),0!==r[u+a-1])throw new n("string-array-error","Invalid string array: missing null termination.")}else i.push(null);u+=a}return i}function l(e,r){return new(0,t.valueType2TypedArrayClassMap[r.valueType])(e,r.byteOffset,r.count*r.valuesPerElement)}function y(e,t){return new Uint8Array(e,t.byteOffset,t.byteCount)}function d(e,t,r){for(var o=null!=t.header?c(e,t.header):{byteOffset:0,byteCount:0,fields:{count:r}},i={header:o,byteOffset:o.byteCount,byteCount:0,entries:Object.create(null)},u=o.byteCount,s=0;s<t.ordering.length;s++){var f=t.ordering[s],l=a.clone(t[f]);if(l.count=o.fields.count,"String"===l.valueType){if(l.byteOffset=u,l.byteCount=o.fields[f+"ByteCount"],"UTF-8"!==l.encoding)throw new n("unsupported-encoding","Unsupported String encoding.",{encoding:l.encoding})}else{if(!m(l.valueType))throw new n("unsupported-value-type","Unsupported binary valueType",{valueType:l.valueType});var y=C(l.valueType);u+=u%y!=0?y-u%y:0,l.byteOffset=u,l.byteCount=y*l.valuesPerElement*l.count}u+=l.byteCount,i.entries[f]=l}return i.byteCount=u-i.byteOffset,i}function b(e,t,r){if(t!==e&&u.error("Invalid "+r+" buffer size\n expected: "+e+", actual: "+t+")"),t<e)throw new n("buffer-too-small","Binary buffer is too small",{expectedSize:e,actualSize:t})}function g(e){return{isDraco:!1,isLegacy:!1,color:null!=e.color,normal:null!=e.normal,uv0:null!=e.uv0,uvRegion:null!=e.uvRegion,featureIndex:null!=e.faceRange&&null!=e.featureId}}function v(e){for(var t={isDraco:!1,isLegacy:!0,color:!1,normal:!1,uv0:!1,uvRegion:!1,featureIndex:!1},r=0,n=e.ordering;r<n.length;r++){var a=n[r];if(e.vertexAttributes[a])switch(a){case"position":break;case"normal":t.normal=!0;break;case"color":t.color=!0;break;case"uv0":t.uv0=!0;break;case"region":t.uvRegion=!0}}return e.featureAttributes&&e.featureAttributeOrder&&(t.featureIndex=!0),t}function p(e){for(var t={isDraco:!0,isLegacy:!1,color:!1,normal:!1,uv0:!1,uvRegion:!1,featureIndex:!1},r=0,n=e;r<n.length;r++){switch(n[r]){case"position":break;case"normal":t.normal=!0;break;case"uv0":t.uv0=!0;break;case"color":t.color=!0;break;case"uv-region":t.uvRegion=!0;break;case"feature-index":t.featureIndex=!0}}return t}t.readHeader=c,t.readStringArray=f,t.createTypedView=l,t.createRawView=y,t.createAttributeDataIndex=d,t.createGeometryDescriptorFromDefinition=g,t.createGeometryIndexFromSchema=function(e,t){for(var n=c(e,t&&t.header),a=n.byteCount,o={isDraco:!1,header:n,byteOffset:n.byteCount,byteCount:0,vertexAttributes:{}},i=n.fields,u=null!=i.vertexCount?i.vertexCount:i.count,s=0,f=t.ordering;s<f.length;s++){var l=f[s];if(t.vertexAttributes[l]){var y=r.__assign(r.__assign({},t.vertexAttributes[l]),{byteOffset:a,count:u}),d=w[l]?w[l]:"_"+l;o.vertexAttributes[d]=y,a+=C(y.valueType)*y.valuesPerElement*u}}var g=i.faceCount;if(t.faces&&g){o.faces={};for(var v=0,p=t.ordering;v<p.length;v++){var m=p[v];if(t.faces[m]){y=r.__assign(r.__assign({},t.faces[m]),{byteOffset:a,count:g});o.faces[m]=y,a+=C(y.valueType)*y.valuesPerElement*g}}}var T=i.featureCount;if(t.featureAttributes&&t.featureAttributeOrder&&T){o.featureAttributes={};for(var h=0,A=t.featureAttributeOrder;h<A.length;h++){var I=A[h];if(t.featureAttributes[I]){y=r.__assign(r.__assign({},t.featureAttributes[I]),{byteOffset:a,count:T});o.featureAttributes[I]=y,a+=("UInt64"===y.valueType?8:C(y.valueType))*y.valuesPerElement*T}}}return b(a,e.byteLength,"geometry"),o.byteCount=a-o.byteOffset,o},t.createGeometryDescriptor=function(e,t){return!(!e||!e.compressedAttributes||"draco"!==e.compressedAttributes.encoding)?p(e.compressedAttributes.attributes):e?g(e):v(t)},t.createGeometryDescriptorFromSchema=v,t.createGeometryDescriptorForDraco=p;var w={position:"position",normal:"normal",color:"color",uv0:"uv0",region:"uvRegion"};function m(e){return t.valueType2TypedArrayClassMap.hasOwnProperty(e)}function C(e){return m(e)?t.valueType2TypedArrayClassMap[e].BYTES_PER_ELEMENT:0}t.readBinaryAttribute=function(e,t,r){if("lepcc-rgb"===e.encoding)return i.decodeRGB(t);if("lepcc-intensity"===e.encoding)return i.decodeIntensity(t);if(null!=e.encoding&&""!==e.encoding)throw new n("unknown-attribute-storage-info-encoding","Unknown Attribute Storage Info Encoding");e["attributeByteCounts "]&&!e.attributeByteCounts&&(u.warn("Warning: Trailing space in 'attributeByteCounts '."),e.attributeByteCounts=e["attributeByteCounts "]),"ObjectIds"===e.ordering[0]&&e.hasOwnProperty("objectIds")&&(u.warn("Warning: Case error in objectIds"),e.ordering[0]="objectIds");var a=d(t,e,r);b(a.byteOffset+a.byteCount,t.byteLength,"attribute");var o=a.entries.attributeValues||a.entries.objectIds;if(o){if("String"===o.valueType){var s=a.entries.attributeByteCounts,c=l(t,s),g=y(t,o);return f(s.count,c,g)}return l(t,o)}throw new n("bad-attribute-storage-info","Bad attributeStorageInfo specification.")},t.valueType2TypedArrayClassMap={Float32:Float32Array,Float64:Float64Array,UInt8:Uint8Array,Int8:Int8Array,UInt16:Uint16Array,Int16:Int16Array,UInt32:Uint32Array,Int32:Int32Array},t.valueType2ArrayBufferReader={Float32:function(e,t){return new DataView(e,0).getFloat32(t,!0)},Float64:function(e,t){return new DataView(e,0).getFloat64(t,!0)},UInt8:function(e,t){return new DataView(e,0).getUint8(t)},Int8:function(e,t){return new DataView(e,0).getInt8(t)},UInt16:function(e,t){return new DataView(e,0).getUint16(t,!0)},Int16:function(e,t){return new DataView(e,0).getInt16(t,!0)},UInt32:function(e,t){return new DataView(e,0).getUint32(t,!0)},Int32:function(e,t){return new DataView(e,0).getInt32(t,!0)}},t.isValueType=m,t.getBytesPerValue=C}));