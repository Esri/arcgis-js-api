/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/has","../../../../core/maybe","../../../../core/Logger","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/decorators/subclass","../../../../core/Error","../../../../core/urlUtils","../../../../core/uuid","../../../../portal/support/resourceExtension","../../../../core/Accessor","../../../../geometry/Extent","../../../../core/Handles","../../../../tasks/support/FeatureSet","../../../../tasks/support/Query","../../../../layers/graphics/data/QueryEngine"],(function(e,t,r,n,s,a,u,o,i,c,y,l,d,p,h,f,Q,g,_){"use strict";const E=_.default;e.I3SQueryEngine=function(e){function r(t){var r;return(r=e.call(this,t)||this)._dataQueryEngineInstance=null,r._handles=new f,r}t._inheritsLoose(r,e);var n=r.prototype;return n.initialize=function(){this._handles.add(this.layerView.on("visible-geometry-changed",(()=>this.spatialIndex.events.emit("changed"))))},n.destroy=function(){this._dataQueryEngineInstance&&(this._dataQueryEngineInstance.destroy(),this._dataQueryEngineInstance=null),this._handles&&(this._handles.destroy(),this._handles=null),this._set("layerView",null)},n.executeQueryForCount=async function(e,t){return this.dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(e),t)},n.executeQueryForExtent=async function(e,t){const{count:r,extent:n}=await this.dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(e),t);return{count:r,extent:h.fromJSON(n)}},n.executeQueryForIds=async function(e,t){return this.dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(e),t)},n.executeQuery=async function(e,t){const r=this._ensureQueryJSON(e);if(r.returnGeometry)throw new c("feature-store:unsupported-query","returnGeometry is not yet supported for mesh scene layer queries");if(r.returnCentroid)throw new c("feature-store:unsupported-query","returnCentroid is not yet supported for mesh scene layer queries");const n=await this.dataQueryEngine.executeQuery(r,t),s=Q.fromJSON(n);return s.features.forEach((e=>{e.geometry=null})),s},n._ensureQueryJSON=function(e){if(s.isNone(e))return this.defaultQueryJSON;const t=e.toJSON();return t.outSpatialReference||(e.outSpatialReference=this.spatialReference),t},n.ensureDataQueryEngine=function(){if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;const e=this.layer.objectIdField||"OBJECTID",t=this.layer.fields.map((e=>e.toJSON())),r=this.layerView.view.resourceController.scheduler,n=this.spatialReference.toJSON(),s=this.task,a=this.spatialIndex;return this._dataQueryEngineInstance=new E({hasZ:!0,hasM:!1,geometryType:"esriGeometryPolygon",fields:t,timeInfo:null,spatialReference:n,objectIdField:e,featureStore:a,scheduler:r,task:s}),this._dataQueryEngineInstance},t._createClass(r,[{key:"defaultQueryJSON",get:function(){return new g({outSpatialReference:this.spatialReference}).toJSON()}},{key:"dataQueryEngine",get:function(){return this.ensureDataQueryEngine()}}]),r}(p),r.__decorate([o.property({constructOnly:!0})],e.I3SQueryEngine.prototype,"layerView",void 0),r.__decorate([o.property({constructOnly:!0})],e.I3SQueryEngine.prototype,"task",void 0),r.__decorate([o.property({constructOnly:!0})],e.I3SQueryEngine.prototype,"spatialIndex",void 0),r.__decorate([o.property({readOnly:!0,aliasOf:"layerView.view.spatialReference"})],e.I3SQueryEngine.prototype,"spatialReference",void 0),r.__decorate([o.property({readOnly:!0,aliasOf:"layerView.i3slayer"})],e.I3SQueryEngine.prototype,"layer",void 0),r.__decorate([o.property({readOnly:!0,dependsOn:["spatialReference"]})],e.I3SQueryEngine.prototype,"defaultQueryJSON",null),e.I3SQueryEngine=r.__decorate([i.subclass("esri.views.3d.layers.i3s.I3SQueryEngine")],e.I3SQueryEngine);var S=e.I3SQueryEngine;e.default=S,Object.defineProperty(e,"__esModule",{value:!0})}));
