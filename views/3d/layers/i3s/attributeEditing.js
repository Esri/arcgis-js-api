/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../core/lang","../../../../core/maybe","../support/attributeUtils"],(function(t,e,n,r){"use strict";const o={setAttribute(){},rollback(){},commit(){}};var s;function i(t,r){const i=r.attributes[t.objectIdField],a=t.sessions.get(i);if(a)return a;const u=e.clone(r.attributes),c=new Set;if(null==i)return o;const f=t.i3sOverrides.createInteractiveEditSession(i),d=new Map,l=(t,e)=>{const n=d.get(t);if(null==n){const n=e.indexOf(i);return d.set(t,n),n}return n};let I=s.EDITING;const b={setAttribute(e,o){if(I!==s.EDITING)return;const i=t.fieldsIndex.get(e);if(n.isNone(i))return;const a=t.attributeStorageInfo.findIndex((t=>t.name===i.name));if(a<0)return;f.set(a,o);const u=t.attributeStorageInfo[a];let d=!1;c.add(e),t.forEachNode(((e,n)=>{const s=l(e,n);if(-1===s)return;const i=t.getAttributeData(e.index);if(i){const n=i[u.name];n&&(n[s]=o,t.setAttributeData(e.index,i,r),d=!0)}})),d&&t.clearMemCache()},rollback(){if(I===s.EDITING){for(const t of c)this.setAttribute(t,u[t]);f.rollback(),I=s.ROLLED_BACK,t.sessions.delete(i)}},commit(){I===s.EDITING&&(f.commit(),I=s.COMMITTED,t.sessions.delete(i))}};return t.sessions.set(i,b),b}function a(t,e){const n=[...e.addedFeatures,...e.updatedFeatures,...e.deletedFeatures];for(const r of n)r.objectId&&t.i3sOverrides.updateGeometry(r.objectId)}function u(t,e){const r=c(t,e);if(0===r.size)return;const o=new Map;for(let n=0;n<t.attributeStorageInfo.length;n++)o.set(t.attributeStorageInfo[n].name,n);let s=!1;r.forEach(((e,r)=>{const i=t.getAttributeData(r);let a=!1;e.forEach(((e,r)=>{const u=n.isSome(i)?i[r]:null,c=o.get(r);for(const{featureIndex:n,value:o,featureId:i}of e)u&&(u[n]=o,a=!0,s=!0),t.i3sOverrides.updateAttributeValue(i,c,o)})),a&&t.setAttributeData(r,i,null)})),s&&t.clearMemCache()}function c(t,e){const n=e.edits.updateFeatures;if(!n||0===n.length)return new b;const o=l(e),s=new b,i=new Map;for(let r=0;r<t.attributeStorageInfo.length;r++)i.set(t.attributeStorageInfo[r].name,r);const a=t.fieldsIndex,u=t.objectIdField,c=n.filter((t=>{const e=r.attributeLookup(a,t.attributes,u);return o.has(e)}));return t.forEachNode(((e,n)=>{const o=new Set(n);for(const i of c){const c=r.attributeLookup(a,i.attributes,u);if(!o.has(c))continue;const d=n.indexOf(c);for(const n in i.attributes){const r=t.fieldsIndex.normalizeFieldName(n),o=f(s,e.index,r),a=i.attributes[n];o.push({featureIndex:d,featureId:c,value:a})}}})),s}function f(t,e,n){const r=d(t,e),o=null!=n&&r.get(n);if(o)return o;const s=new Array;return r.set(n,s),s}function d(t,e){const n=t.get(e);if(n)return n;const r=new I;return t.set(e,r),r}function l(t){const e=new Set;if(!t.updatedFeatures)return e;for(const n of t.updatedFeatures)null!=n.objectId&&null==n.error&&e.add(n.objectId);return e}!function(t){t[t.EDITING=0]="EDITING",t[t.ROLLED_BACK=1]="ROLLED_BACK",t[t.COMMITTED=2]="COMMITTED"}(s||(s={}));const I=Map,b=Map;t.createInteractiveEditSession=i,t.processAttributeEdits=u,t.processGeometryEdits=a,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
