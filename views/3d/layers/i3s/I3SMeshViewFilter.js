/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["require","exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../geometry","../../../../core/Accessor","../../../../core/arrayUtils","../../../../core/Logger","../../../../core/maybe","../../../../core/unitUtils","../../../../core/watchUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec3","../../../../core/sql/WhereClause","../../../../geometry/projection","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/webMercatorUtils","../../../../layers/support/FeatureFilter","./I3SUtil","../../../../geometry/SpatialReference"],(function(e,t,r,n,i,o,s,a,c,l,p,u,d,f,h,y,g,S,m,b,w,_,j,M){"use strict";const F=a.getLogger("esri.views.3d.layers.i3s.I3SMeshViewFilter");let I;function R(){return!!I}function V(){return k.apply(this,arguments)}function k(){return(k=r._asyncToGenerator((function*(){return R()||(I=yield new Promise(((t,r)=>e(["../../../../geometry/geometryEngine"],t,r)))),I}))).apply(this,arguments)}t.I3SMeshViewFilter=function(e){function t(t){var r;return(r=e.call(this,t)||this)._projectionEngineLoaded=!1,r}r._inheritsLoose(t,e);var n=t.prototype;return n.initialize=function(){p.whenOnce(this,"filter.geometry").then((()=>this.loadAsyncModule(V().then((e=>{this.destroyed||(this._geometryEngine=e,this.applyFilters())})))))},n.addFilters=function(e,t,r,n){const i=this.sortedObjectIds;c.isSome(i)&&e.push((e=>j.objectIdFilter(i,!0,e))),this.addSqlFilter(e,this.parsedWhereClause);const o=this.parsedGeometry;if(c.isSome(o)){const i=this.spatialRelationship;e.push(((e,s)=>B(e,s,n,t,r,o,i)))}},n.isMBSGeoemtryVisible=function(e,t,r){const n=this.parsedGeometry;if(c.isSome(n)){const i=this.spatialRelationship,o=n[0].spatialReference||t;if(!S.projectBoundingSphere(e,r,T,o))return F.warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter for MBS"),!0;return O(T,n,o,i)}return!0},t.checkSupport=function(e){return e.timeExtent?(F.warn("Filters with a timeExtent are not supported for mesh scene layers"),!1):!!x(e.spatialRelationship)||(F.warn(`Filters with spatialRelationship other than ${v.join(", ")} are not supported for mesh scene layers`),!1)},r._createClass(t,[{key:"sortedObjectIds",get:function(){if(c.isNone(this.filter.objectIds))return null;const e=new Float64Array(this.filter.objectIds);return e.sort(),e}},{key:"parsedWhereClause",get:function(){const e=c.isSome(this.filter)?this.filter.where:null;if(c.isNone(e)||!e)return null;try{return g.WhereClause.create(e,this.layerFieldsIndex)}catch(t){F.error(`Failed to parse filter where clause: ${t}`)}return null}},{key:"parsedGeometry",get:function(){if(c.isNone(this.filter))return null;if(!this._geometryEngine)return null;const{geometry:e}=this.filter;if(c.isNone(e))return null;const{distance:t,units:r}=this.filter,n=this.spatialRelationship,i="mesh"===e.type?e.extent:e;if(c.isNone(t)||0===t)return E(i,n);const o=r||l.getUnitString(i.spatialReference);if(i.spatialReference.isWGS84){return E(this._geometryEngine.geodesicBuffer(i,t,o),n)}const s=w.project(i,M.WGS84);if(c.isSome(s)){return E(w.project(this._geometryEngine.geodesicBuffer(s,t,o),i.spatialReference),n)}if(!this._projectionEngineLoaded&&(this.loadAsyncModule(S.load().then((()=>this._projectionEngineLoaded=!0))),!this._projectionEngineLoaded))return null;let a=null;try{a=S.project(i,M.WGS84)}catch(p){}if(a)try{a=S.project(this._geometryEngine.geodesicBuffer(a,t,o),i.spatialReference)}catch(p){a=null}return a||F.error(`Filter by geodesic buffer (distance) unsupported, failed to project input geometry (${i.spatialReference.wkid}) to WGS84.`),E(a,n)}},{key:"spatialRelationship",get:function(){return c.isSome(this.filter)?this.filter.spatialRelationship:"intersects"}}]),t}(o),n.__decorate([u.property({type:_})],t.I3SMeshViewFilter.prototype,"filter",void 0),n.__decorate([u.property()],t.I3SMeshViewFilter.prototype,"layerFieldsIndex",void 0),n.__decorate([u.property()],t.I3SMeshViewFilter.prototype,"loadAsyncModule",void 0),n.__decorate([u.property()],t.I3SMeshViewFilter.prototype,"applyFilters",void 0),n.__decorate([u.property()],t.I3SMeshViewFilter.prototype,"addSqlFilter",void 0),n.__decorate([u.property({readOnly:!0})],t.I3SMeshViewFilter.prototype,"sortedObjectIds",null),n.__decorate([u.property({readOnly:!0})],t.I3SMeshViewFilter.prototype,"parsedWhereClause",null),n.__decorate([u.property({readOnly:!0})],t.I3SMeshViewFilter.prototype,"parsedGeometry",null),n.__decorate([u.property({readOnly:!0})],t.I3SMeshViewFilter.prototype,"spatialRelationship",null),n.__decorate([u.property()],t.I3SMeshViewFilter.prototype,"_projectionEngineLoaded",void 0),n.__decorate([u.property()],t.I3SMeshViewFilter.prototype,"_geometryEngine",void 0),t.I3SMeshViewFilter=n.__decorate([h.subclass("esri.views.3d.layers.i3s.I3SMeshViewFilter")],t.I3SMeshViewFilter);const v=(e=>e)(["contains","intersects","disjoint"]);function x(e){return null!=e&&v.indexOf(e)>=0}function E(e,t){if(c.isNone(e))return null;if("disjoint"===t&&"polygon"===e.type){const t=new Array(e.rings.length);for(let i=0;i<e.rings.length;++i){const r=b.fromValues(1/0,1/0,-1/0,-1/0);b.expandWithNestedArray(r,e.rings[i]),t[i]={type:"polygon",rings:[e.rings[i]],spatialReference:e.spatialReference,aabr:r}}t.sort(((e,t)=>e.aabr[0]-t.aabr[0]));const r=new Set,n=new s.PositionHint;for(let e=0;e<t.length;++e){const i=t[e];for(let n=e+1;n<t.length;++n){const e=t[n];if(e.aabr[0]>=i.aabr[2])break;r.add(e)}r.forEach((e=>{if(i!==e)if(e.aabr[2]<=i.aabr[0])r.delete(e);else if(I.intersects(i,e)){i.rings=i.rings.concat(e.rings),b.expand(i.aabr,e.aabr,i.aabr),delete i._geVersion,r.delete(e);const o=s.indexOf(t,e,t.length,n);t.splice(o,1)}})),r.add(i)}for(const e of t)delete e.aabr;return t}return[e]}function O(e,t,r,n){const i=G(e,r);return t.every((e=>1!==C(e,i,n)))}function B(e,t,r,n,i,o,s){const a=o[0].spatialReference||n.spatialReference;if(!S.projectBoundingSphere(t.node.mbs,i,T,a))return void F.warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter");const c=G(T,a),l=W(s,n,a,r,t.objectHandle);for(const p of o){if(0===e.length)return;switch(C(p,c,s)){case 1:return void(e.length=0);case 0:continue}j.filterInPlace(e,t.featureIds,(e=>P(p,e,l)))}}const T=[0,0,0,0];function W(e,t,r,n,i){const o=t.renderSpatialReference,s=new Map,a={rings:[[[0,0,0],[0,0,0],[0,0,0],[0,0,0]]],hasZ:!1,hasM:!1,type:"polygon",spatialReference:r};a.rings[0][3]=a.rings[0][0];const c={indices:null,data:null,stride:0,startIndex:0,endIndex:0};let l,p;switch(e){case"intersects":l=(e,t)=>I.intersects(e,t)?0:2,p=L;break;case"contains":l=(e,t)=>I.contains(e,t)?2:1,p=L;break;default:l=(e,t)=>I.disjoint(e,t)?2:1,p=A}return{collection:n,object:i,type:e,maskSR:r,renderSR:o,aabbCache:s,triangle:a,positions:c,triangleTest:l,geometryTest:p}}function G(e,t){const r={x:e[0],y:e[1],hasZ:!1,hasM:!1,type:"point",spatialReference:t},n=!t.isWGS84&&!t.isWebMercator?I.buffer(r,e[3],1):I.geodesicBuffer(r,e[3],1);return n.type="polygon",n}function C(e,t,r){switch(r){case"intersects":case"contains":return L(e,t);case"disjoint":return A(e,t)}}function L(e,t){return I.intersects(e,t)?I.contains(e,t)?0:2:1}function A(e,t){return I.intersects(e,t)?I.contains(e,t)?1:2:0}const N=2**-32;function P(e,t,r){const{collection:n,object:i,renderSR:o,maskSR:s,geometryTest:a,aabbCache:c}=r;let l=c.get(t);if(!l){const e=n.getObjectTransform(i);n.getComponentAabb(i,t,U);const r=[[U[0],U[1],0],[U[0],U[4],0],[U[3],U[4],0],[U[3],U[1],0]];for(let t=0;t<4;++t)y.transformMat3(r[t],r[t],e.rotationScale),y.add(r[t],r[t],e.position),S.projectVectorToVector(r[t],o,r[t],s);l={rings:[r],hasZ:!1,hasM:!1,type:"polygon",spatialReference:s},l.rings[0][4]=l.rings[0][0],c.set(t,l)}switch(a(e,l)){case 1:return!1;case 0:return!0}const{triangle:p,triangleTest:u,positions:d}=r,f=p.rings[0][0],h=p.rings[0][1],g=p.rings[0][2],m=n.getObjectTransform(i);n.getComponentPositions(i,t,d);const{indices:b,data:w,stride:_,startIndex:j,endIndex:M}=d;for(let F=j;F<M;F+=3){const t=_*b[F+0],r=_*b[F+1],n=_*b[F+2];y.set(f,w[t+0],w[t+1],w[t+2]),y.set(h,w[r+0],w[r+1],w[r+2]),y.set(g,w[n+0],w[n+1],w[n+2]),y.transformMat3(f,f,m.rotationScale),y.transformMat3(h,h,m.rotationScale),y.transformMat3(g,g,m.rotationScale),y.add(f,f,m.position),y.add(h,h,m.position),y.add(g,g,m.position),S.projectVectorToVector(f,o,f,s),S.projectVectorToVector(h,o,h,s),S.projectVectorToVector(g,o,g,s);const i=h[0]-f[0],a=h[1]-f[1],c=g[0]-f[0],l=g[1]-f[1];if(!(Math.abs(i*l-a*c)<N))switch(delete p._geVersion,u(e,p)){case 1:return!1;case 0:return!0}}return"intersects"!==r.type}const U=m.create();Object.defineProperty(t,"__esModule",{value:!0})}));
