/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["require","exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../geometry","../../../../core/Accessor","../../../../core/arrayUtils","../../../../core/Logger","../../../../core/mathUtils","../../../../core/maybe","../../../../core/maybeUpdating","../../../../core/reactiveUtils","../../../../core/unitUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec3","../../../../core/sql/WhereClause","../../../../geometry/projection","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/Ellipsoid","../../../../geometry/support/spatialReferenceUtils","../../../../geometry/support/webMercatorUtils","../../../../layers/support/FeatureFilter","./I3SUtil","../../webgl-engine/lib/DoubleArray","../../../../geometry/SpatialReference"],(function(e,t,r,i,n,o,s,a,c,l,p,u,d,g,y,h,f,m,S,w,_,F,b,R,E,M,I,v){"use strict";const j="esri.views.3d.layers.i3s.I3SMeshViewFilter",k=a.getLogger(j);t.I3SMeshViewFilter=function(t){function i(e){var r;return(r=t.call(this,e)||this)._projectionEngineLoaded=!1,r}r._inheritsLoose(i,t);var n=i.prototype;return n.initialize=function(){u.whenOnce((()=>l.unwrap(this.viewFilter)?.geometry||l.isSome(this.layerFilter))).then((()=>this.loadAsyncModule(new Promise(((t,r)=>e(["../../../../geometry/geometryEngine"],t,r))).then((e=>{this.destroyed||(this._geometryEngine=e)})))))},n.addFilters=function(e,t,r,i){const n=this.sortedObjectIds;l.isSome(n)&&e.push((e=>M.objectIdFilter(n,!0,e))),this.addSqlFilter(e,this.parsedWhereClause);const o=p.unwrapUpdating(this._layerMaskGeometries),s=this._geometryEngine;if(l.isSome(o)&&l.isSome(this.layerFilter)&&l.isSome(s)){const n=this.layerFilter.spatialRelationship;e.push(((e,a)=>A(s,e,a,i,t,r,o,n)))}const a=p.unwrapUpdating(this._viewMaskGeometries);if(l.isSome(a)&&l.isSome(this.viewFilter)&&l.isSome(s)){const n=this.viewFilter.spatialRelationship;e.push(((e,o)=>A(s,e,o,i,t,r,a,n)))}},n.isMBSGeometryVisible=function(e,t,r){const i=p.unwrapUpdating(this._layerMaskGeometries),n=this._geometryEngine;if(l.isSome(i)&&l.isSome(this.layerFilter)&&l.isSome(n)){const o=this.layerFilter.spatialRelationship,s=i[0].spatialReference||t;if(!S.projectBoundingSphere(e,r,N,s))return k.warnOnce("SceneLayer.mask geometry is using unsupported SpatialReference, skipping geometry filter for MBS"),!0;return G(n,N,i,s,o)}const o=p.unwrapUpdating(this._viewMaskGeometries);if(l.isSome(o)&&l.isSome(this.viewFilter)&&l.isSome(n)){const i=this.viewFilter.spatialRelationship,s=o[0].spatialReference||t;if(!S.projectBoundingSphere(e,r,N,s))return k.warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter for MBS"),!0;return G(n,N,o,s,i)}return!0},i.checkSupport=function(e){return!l.isNone(e)&&(e.timeExtent?(k.warn("Filters with a timeExtent are not supported for mesh scene layers"),!1):!!T(e.spatialRelationship)||(k.warn(`Filters with spatialRelationship other than ${V.join(", ")} are not supported for mesh scene layers`),!1))},r._createClass(i,[{key:"sortedObjectIds",get:function(){if(l.isNone(this.viewFilter)||l.isNone(this.viewFilter.objectIds))return null;const e=I.doubleArrayFrom(this.viewFilter.objectIds);return e.sort(),e}},{key:"parsedWhereClause",get:function(){const e=l.isSome(this.viewFilter)?this.viewFilter.where:null;if(l.isNone(e)||!e)return null;try{return m.WhereClause.create(e,this.layerFieldsIndex)}catch(t){k.error(`Failed to parse filter where clause: ${t}`)}return null}},{key:"parsedGeometry",get:function(){const e=p.unwrapUpdating(this._viewMaskGeometries),t=p.unwrapUpdating(this._layerMaskGeometries);return l.isNone(e)||l.isNone(t)?e||t:t.concat(e)}},{key:"_layerMaskGeometries",get:function(){const e=this.layerFilter;return l.isNone(e)?null:l.isNone(this._geometryEngine)?p.updating:"disjoint"===e.spatialRelationship?e.geometries.map((e=>({type:"polygon",rings:e.rings,spatialReference:e.spatialReference,cache:{}}))):[e.geometries.reduce(((e,t)=>(e.rings=[...e.rings,...t.rings],e)),{type:"polygon",rings:[],spatialReference:e.geometries[0].spatialReference,cache:{}})]}},{key:"_viewMaskGeometries",get:function(){if(l.isNone(this.viewFilter))return null;const{geometry:e}=this.viewFilter;if(l.isNone(e))return null;if(l.isNone(this.viewFilter)||l.isNone(this._geometryEngine))return p.updating;const{distance:t,units:r}=this.viewFilter,i=this.viewFilter.spatialRelationship,n="mesh"===e.type?e.extent:e;if(l.isNone(t)||0===t)return C(this._geometryEngine,n,i);const o=r||d.getUnitString(n.spatialReference);if(n.spatialReference.isWGS84){const e=this._geometryEngine.geodesicBuffer(n,t,o);return C(this._geometryEngine,e,i)}const s=R.project(n,v.WGS84);if(l.isSome(s)){const e=R.project(this._geometryEngine.geodesicBuffer(s,t,o),n.spatialReference);return C(this._geometryEngine,e,i)}if(!this._projectionEngineLoaded&&(this.loadAsyncModule(S.load().then((()=>this._projectionEngineLoaded=!0))),!this._projectionEngineLoaded))return null;let a=null;try{a=S.project(n,v.WGS84)}catch(c){}if(a)try{a=S.project(this._geometryEngine.geodesicBuffer(a,t,o),n.spatialReference)}catch(c){a=null}return a||k.error(`Filter by geodesic buffer (distance) unsupported, failed to project input geometry (${n.spatialReference.wkid}) to WGS84.`),C(this._geometryEngine,a,i)}},{key:"updating",get:function(){return p.isUpdating(this._layerMaskGeometries)||p.isUpdating(this._viewMaskGeometries)}}]),i}(o),i.__decorate([g.property()],t.I3SMeshViewFilter.prototype,"layerFilter",void 0),i.__decorate([g.property({type:E})],t.I3SMeshViewFilter.prototype,"viewFilter",void 0),i.__decorate([g.property()],t.I3SMeshViewFilter.prototype,"layerFieldsIndex",void 0),i.__decorate([g.property()],t.I3SMeshViewFilter.prototype,"loadAsyncModule",void 0),i.__decorate([g.property()],t.I3SMeshViewFilter.prototype,"addSqlFilter",void 0),i.__decorate([g.property({readOnly:!0})],t.I3SMeshViewFilter.prototype,"sortedObjectIds",null),i.__decorate([g.property({readOnly:!0})],t.I3SMeshViewFilter.prototype,"parsedWhereClause",null),i.__decorate([g.property({readOnly:!0})],t.I3SMeshViewFilter.prototype,"parsedGeometry",null),i.__decorate([g.property({readOnly:!0})],t.I3SMeshViewFilter.prototype,"_layerMaskGeometries",null),i.__decorate([g.property({readOnly:!0})],t.I3SMeshViewFilter.prototype,"_viewMaskGeometries",null),i.__decorate([g.property()],t.I3SMeshViewFilter.prototype,"updating",null),i.__decorate([g.property()],t.I3SMeshViewFilter.prototype,"_projectionEngineLoaded",void 0),i.__decorate([g.property()],t.I3SMeshViewFilter.prototype,"_geometryEngine",void 0),t.I3SMeshViewFilter=i.__decorate([h.subclass(j)],t.I3SMeshViewFilter);const V=(e=>e)(["contains","intersects","disjoint"]);function T(e){return null!=e&&V.includes(e)}var D;function C(e,t,r){if(l.isNone(t))return null;if("disjoint"===r&&"polygon"===t.type){const r=t.rings.length,i=t.spatialReference,n=new Array(r);for(let e=0;e<r;++e){const r=_.fromValues(1/0,1/0,-1/0,-1/0);_.expandWithNestedArray(r,t.rings[e]),n[e]={type:"polygon",rings:[t.rings[e]],spatialReference:i,cache:{},aabr:r}}n.sort(((e,t)=>e.aabr[0]-t.aabr[0]));const o=new Set,a=new s.PositionHint;for(let t=0;t<n.length;++t){const r=n[t],i=r.aabr[0];o.forEach((t=>{if(i>=t.aabr[2])return void o.delete(t);if(r.aabr[1]>t.aabr[3]||r.aabr[3]<t.aabr[1]||!e.intersects(r,t))return;r.rings=r.rings.concat(t.rings),_.expand(r.aabr,t.aabr,r.aabr),r.cache={},o.delete(t);const c=s.indexOf(n,t,n.length,a);n.splice(c,1)})),o.add(r)}for(const e of n)e.aabr=void 0;return n}return[t]}function G(e,t,r,i,n){const o=O(e,t,i);return r.every((t=>x(e,t,o,n)!==D.DISCARD))}function A(e,t,r,i,n,o,s,a){const c=s[0].spatialReference||n.spatialReference;if(!S.projectBoundingSphere(r.node.mbs,o,N,c))return void k.warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter");const l=O(e,N,c),p=U(a,n,c,i,r.objectHandle);for(const u of s){if(0===t.length)return;switch(x(e,u,l,a)){case D.DISCARD:return void(t.length=0);case D.KEEP:continue}M.filterInPlace(t,r.featureIds,(t=>W(e,u,t,p)))}}!function(e){e[e.KEEP=0]="KEEP",e[e.DISCARD=1]="DISCARD",e[e.TEST=2]="TEST"}(D||(D={}));const N=[0,0,0,0];function U(e,t,r,i,n){const o=t.renderSpatialReference,s=new Map,a={type:"polygon",rings:[[[0,0,0],[0,0,0],[0,0,0],[0,0,0]]],spatialReference:r};a.rings[0][3]=a.rings[0][0];const c={indices:null,data:null,stride:0,startIndex:0,endIndex:0};let l,p;switch(e){case"intersects":l=(e,t,r)=>e.intersects(t,r)?D.KEEP:D.TEST,p=B;break;case"contains":l=(e,t,r)=>e.contains(t,r)?D.TEST:D.DISCARD,p=B;break;default:l=(e,t,r)=>e.disjoint(t,r)?D.TEST:D.DISCARD,p=P}return{collection:i,object:n,type:e,maskSR:r,renderSR:o,aabbCache:s,triangle:a,positions:c,triangleTest:l,geometryTest:p}}function O(e,t,r){const i={type:"point",x:t[0],y:t[1],hasZ:!1,hasM:!1,spatialReference:r},n=!b.isWGS84(r)&&!b.isWebMercator(r),o=Number.isNaN(t[3])?0:c.clamp(t[3],0,2*F.earth.radius),s=n?e.buffer(i,o,1):e.geodesicBuffer(i,o,1);return s.type="polygon",s}function x(e,t,r,i){switch(i){case"intersects":case"contains":return B(e,t,r);case"disjoint":return P(e,t,r)}}function B(e,t,r){return e.intersects(t,r)?e.contains(t,r)?D.KEEP:D.TEST:D.DISCARD}function P(e,t,r){return e.intersects(t,r)?e.contains(t,r)?D.DISCARD:D.TEST:D.KEEP}function W(e,t,r,i){const{collection:n,object:o,renderSR:s,maskSR:a,geometryTest:c,aabbCache:l}=i;let p=l.get(r);if(!p){const e=n.getObjectTransform(o);n.getComponentAabb(o,r,L);const t=[[L[0],L[1],0],[L[0],L[4],0],[L[3],L[4],0],[L[3],L[1],0]];for(let r=0;r<4;++r)f.transformMat3(t[r],t[r],e.rotationScale),f.add(t[r],t[r],e.position),S.projectVectorToVector(t[r],s,t[r],a);p={type:"polygon",rings:[t],spatialReference:a,cache:{}},p.rings[0][4]=p.rings[0][0],l.set(r,p)}switch(c(e,t,p)){case D.DISCARD:return!1;case D.KEEP:return!0}const{triangle:u,triangleTest:d,positions:g}=i,y=u.rings[0][0],h=u.rings[0][1],m=u.rings[0][2],w=n.getObjectTransform(o);n.getComponentPositions(o,r,g);const{indices:_,data:F,stride:b,startIndex:R,endIndex:E}=g;for(let M=R;M<E;M+=3){const r=b*_[M+0],i=b*_[M+1],n=b*_[M+2];switch(f.set(y,F[r+0],F[r+1],F[r+2]),f.set(h,F[i+0],F[i+1],F[i+2]),f.set(m,F[n+0],F[n+1],F[n+2]),f.transformMat3(y,y,w.rotationScale),f.transformMat3(h,h,w.rotationScale),f.transformMat3(m,m,w.rotationScale),f.add(y,y,w.position),f.add(h,h,w.position),f.add(m,m,w.position),S.projectVectorToVector(y,s,y,a),S.projectVectorToVector(h,s,h,a),S.projectVectorToVector(m,s,m,a),d(e,t,u)){case D.DISCARD:return!1;case D.KEEP:return!0}}return"intersects"!==i.type}const L=w.create();Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
