/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["require","exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../geometry","../../../../core/Accessor","../../../../core/arrayUtils","../../../../core/Logger","../../../../core/mathUtils","../../../../core/maybe","../../../../core/unitUtils","../../../../core/watchUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec3","../../../../core/sql/WhereClause","../../../../geometry/projection","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/Ellipsoid","../../../../geometry/support/webMercatorUtils","../../../../layers/support/FeatureFilter","./I3SUtil","../../../../geometry/SpatialReference"],(function(e,t,r,n,i,o,s,a,c,l,p,u,d,f,h,y,g,S,m,b,w,_,I,R,E,j){"use strict";const M=a.getLogger("esri.views.3d.layers.i3s.I3SMeshViewFilter");let F;function V(){return!!F}function T(){return C.apply(this,arguments)}function C(){return(C=r._asyncToGenerator((function*(){return V()||(F=yield new Promise(((t,r)=>e(["../../../../geometry/geometryEngine"],t,r)))),F}))).apply(this,arguments)}t.I3SMeshViewFilter=function(e){function t(t){var r;return(r=e.call(this,t)||this)._projectionEngineLoaded=!1,r}r._inheritsLoose(t,e);var n=t.prototype;return n.initialize=function(){u.whenOnce(this,"filter.geometry").then((()=>this.loadAsyncModule(T().then((e=>{this.destroyed||(this._geometryEngine=e,this.applyFilters())})))))},n.addFilters=function(e,t,r,n){const i=this.sortedObjectIds;l.isSome(i)&&e.push((e=>E.objectIdFilter(i,!0,e))),this.addSqlFilter(e,this.parsedWhereClause);const o=this.parsedGeometry;if(l.isSome(o)){const i=this.spatialRelationship;e.push(((e,s)=>O(e,s,n,t,r,o,i)))}},n.isMBSGeoemtryVisible=function(e,t,r){const n=this.parsedGeometry;if(l.isSome(n)){const i=this.spatialRelationship,o=n[0].spatialReference||t;if(!m.projectBoundingSphere(e,r,P,o))return M.warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter for MBS"),!0;return x(P,n,o,i)}return!0},t.checkSupport=function(e){return e.timeExtent?(M.warn("Filters with a timeExtent are not supported for mesh scene layers"),!1):!!v(e.spatialRelationship)||(M.warn(`Filters with spatialRelationship other than ${D.join(", ")} are not supported for mesh scene layers`),!1)},r._createClass(t,[{key:"sortedObjectIds",get:function(){if(l.isNone(this.filter.objectIds))return null;const e=new Float64Array(this.filter.objectIds);return e.sort(),e}},{key:"parsedWhereClause",get:function(){const e=l.isSome(this.filter)?this.filter.where:null;if(l.isNone(e)||!e)return null;try{return S.WhereClause.create(e,this.layerFieldsIndex)}catch(t){M.error(`Failed to parse filter where clause: ${t}`)}return null}},{key:"parsedGeometry",get:function(){if(l.isNone(this.filter))return null;if(!this._geometryEngine)return null;const{geometry:e}=this.filter;if(l.isNone(e))return null;const{distance:t,units:r}=this.filter,n=this.spatialRelationship,i="mesh"===e.type?e.extent:e;if(l.isNone(t)||0===t)return k(i,n);const o=r||p.getUnitString(i.spatialReference);if(i.spatialReference.isWGS84){return k(this._geometryEngine.geodesicBuffer(i,t,o),n)}const s=I.project(i,j.WGS84);if(l.isSome(s)){return k(I.project(this._geometryEngine.geodesicBuffer(s,t,o),i.spatialReference),n)}if(!this._projectionEngineLoaded&&(this.loadAsyncModule(m.load().then((()=>this._projectionEngineLoaded=!0))),!this._projectionEngineLoaded))return null;let a=null;try{a=m.project(i,j.WGS84)}catch(c){}if(a)try{a=m.project(this._geometryEngine.geodesicBuffer(a,t,o),i.spatialReference)}catch(c){a=null}return a||M.error(`Filter by geodesic buffer (distance) unsupported, failed to project input geometry (${i.spatialReference.wkid}) to WGS84.`),k(a,n)}},{key:"spatialRelationship",get:function(){return l.isSome(this.filter)?this.filter.spatialRelationship:"intersects"}}]),t}(o),n.__decorate([d.property({type:R})],t.I3SMeshViewFilter.prototype,"filter",void 0),n.__decorate([d.property()],t.I3SMeshViewFilter.prototype,"layerFieldsIndex",void 0),n.__decorate([d.property()],t.I3SMeshViewFilter.prototype,"loadAsyncModule",void 0),n.__decorate([d.property()],t.I3SMeshViewFilter.prototype,"applyFilters",void 0),n.__decorate([d.property()],t.I3SMeshViewFilter.prototype,"addSqlFilter",void 0),n.__decorate([d.property({readOnly:!0})],t.I3SMeshViewFilter.prototype,"sortedObjectIds",null),n.__decorate([d.property({readOnly:!0})],t.I3SMeshViewFilter.prototype,"parsedWhereClause",null),n.__decorate([d.property({readOnly:!0})],t.I3SMeshViewFilter.prototype,"parsedGeometry",null),n.__decorate([d.property({readOnly:!0})],t.I3SMeshViewFilter.prototype,"spatialRelationship",null),n.__decorate([d.property()],t.I3SMeshViewFilter.prototype,"_projectionEngineLoaded",void 0),n.__decorate([d.property()],t.I3SMeshViewFilter.prototype,"_geometryEngine",void 0),t.I3SMeshViewFilter=n.__decorate([y.subclass("esri.views.3d.layers.i3s.I3SMeshViewFilter")],t.I3SMeshViewFilter);const D=(e=>e)(["contains","intersects","disjoint"]);function v(e){return null!=e&&D.indexOf(e)>=0}var A;function k(e,t){if(l.isNone(e))return null;if("disjoint"===t&&"polygon"===e.type){const t=new Array(e.rings.length);for(let i=0;i<e.rings.length;++i){const r=w.fromValues(1/0,1/0,-1/0,-1/0);w.expandWithNestedArray(r,e.rings[i]),t[i]={type:"polygon",rings:[e.rings[i]],spatialReference:e.spatialReference,aabr:r}}t.sort(((e,t)=>e.aabr[0]-t.aabr[0]));const r=new Set,n=new s.PositionHint;for(let e=0;e<t.length;++e){const i=t[e];for(let n=e+1;n<t.length;++n){const e=t[n];if(e.aabr[0]>=i.aabr[2])break;r.add(e)}r.forEach((e=>{if(i!==e)if(e.aabr[2]<=i.aabr[0])r.delete(e);else if(F.intersects(i,e)){i.rings=i.rings.concat(e.rings),w.expand(i.aabr,e.aabr,i.aabr),delete i._geVersion,r.delete(e);const o=s.indexOf(t,e,t.length,n);t.splice(o,1)}})),r.add(i)}for(const e of t)delete e.aabr;return t}return[e]}function x(e,t,r,n){const i=W(e,r);return t.every((e=>G(e,i,n)!==A.DISCARD))}function O(e,t,r,n,i,o,s){const a=o[0].spatialReference||n.spatialReference;if(!m.projectBoundingSphere(t.node.mbs,i,P,a))return void M.warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter");const c=W(P,a),l=B(s,n,a,r,t.objectHandle);for(const p of o){if(0===e.length)return;switch(G(p,c,s)){case A.DISCARD:return void(e.length=0);case A.KEEP:continue}E.filterInPlace(e,t.featureIds,(e=>U(p,e,l)))}}!function(e){e[e.KEEP=0]="KEEP",e[e.DISCARD=1]="DISCARD",e[e.TEST=2]="TEST"}(A||(A={}));const P=[0,0,0,0];function B(e,t,r,n,i){const o=t.renderSpatialReference,s=new Map,a={rings:[[[0,0,0],[0,0,0],[0,0,0],[0,0,0]]],hasZ:!1,hasM:!1,type:"polygon",spatialReference:r};a.rings[0][3]=a.rings[0][0];const c={indices:null,data:null,stride:0,startIndex:0,endIndex:0};let l,p;switch(e){case"intersects":l=(e,t)=>F.intersects(e,t)?A.KEEP:A.TEST,p=L;break;case"contains":l=(e,t)=>F.contains(e,t)?A.TEST:A.DISCARD,p=L;break;default:l=(e,t)=>F.disjoint(e,t)?A.TEST:A.DISCARD,p=N}return{collection:n,object:i,type:e,maskSR:r,renderSR:o,aabbCache:s,triangle:a,positions:c,triangleTest:l,geometryTest:p}}function W(e,t){const r={x:e[0],y:e[1],hasZ:!1,hasM:!1,type:"point",spatialReference:t},n=!t.isWGS84&&!t.isWebMercator,i=Number.isNaN(e[3])?0:c.clamp(e[3],0,2*_.earth.radius),o=n?F.buffer(r,i,1):F.geodesicBuffer(r,i,1);return o.type="polygon",o}function G(e,t,r){switch(r){case"intersects":case"contains":return L(e,t);case"disjoint":return N(e,t)}}function L(e,t){return F.intersects(e,t)?F.contains(e,t)?A.KEEP:A.TEST:A.DISCARD}function N(e,t){return F.intersects(e,t)?F.contains(e,t)?A.DISCARD:A.TEST:A.KEEP}const K=2**-32;function U(e,t,r){const{collection:n,object:i,renderSR:o,maskSR:s,geometryTest:a,aabbCache:c}=r;let l=c.get(t);if(!l){const e=n.getObjectTransform(i);n.getComponentAabb(i,t,q);const r=[[q[0],q[1],0],[q[0],q[4],0],[q[3],q[4],0],[q[3],q[1],0]];for(let t=0;t<4;++t)g.transformMat3(r[t],r[t],e.rotationScale),g.add(r[t],r[t],e.position),m.projectVectorToVector(r[t],o,r[t],s);l={rings:[r],hasZ:!1,hasM:!1,type:"polygon",spatialReference:s},l.rings[0][4]=l.rings[0][0],c.set(t,l)}switch(a(e,l)){case A.DISCARD:return!1;case A.KEEP:return!0}const{triangle:p,triangleTest:u,positions:d}=r,f=p.rings[0][0],h=p.rings[0][1],y=p.rings[0][2],S=n.getObjectTransform(i);n.getComponentPositions(i,t,d);const{indices:b,data:w,stride:_,startIndex:I,endIndex:R}=d;for(let E=I;E<R;E+=3){const t=_*b[E+0],r=_*b[E+1],n=_*b[E+2];g.set(f,w[t+0],w[t+1],w[t+2]),g.set(h,w[r+0],w[r+1],w[r+2]),g.set(y,w[n+0],w[n+1],w[n+2]),g.transformMat3(f,f,S.rotationScale),g.transformMat3(h,h,S.rotationScale),g.transformMat3(y,y,S.rotationScale),g.add(f,f,S.position),g.add(h,h,S.position),g.add(y,y,S.position),m.projectVectorToVector(f,o,f,s),m.projectVectorToVector(h,o,h,s),m.projectVectorToVector(y,o,y,s);const i=h[0]-f[0],a=h[1]-f[1],c=y[0]-f[0],l=y[1]-f[1];if(!(Math.abs(i*l-a*c)<K))switch(delete p._geVersion,u(e,p)){case A.DISCARD:return!1;case A.KEEP:return!0}}return"intersects"!==r.type}const q=b.create();Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
