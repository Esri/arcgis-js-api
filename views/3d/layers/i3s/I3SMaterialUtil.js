/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../core/has","../../../../core/mathUtils","../../../../core/maybe","./enums","../../webgl-engine/core/material/RenderTexture","../../webgl-engine/core/shaderLibrary/shading/PhysicallyBasedRenderingParameters.glsl","../../webgl-engine/core/shaderLibrary/util/AlphaDiscard.glsl","../../webgl-engine/core/shaderLibrary/util/EllipsoidMode","../../webgl-engine/lib/basicInterfaces","../../webgl-engine/lib/Texture","../../../webgl/enums"],(function(e,a,r,o,t,s,n,l,i,u,c,d){"use strict";function g(e,a){const r=new Map,s=(e,a)=>{if(o.isNone(e))return-1;if(r.has(e.id)){const o=r.get(e.id);return o.usage|=a,o.id}const t=r.size;return r.set(e.id,{id:t,usage:a}),t},l=a.pbrMetallicRoughness,i=l&&l.baseColorFactor,c=a.emissiveFactor,d=null==a.normalTexture&&null==a.emissiveTexture&&null==a.occlusionTexture&&(!l||null==l.metallicRoughnessTexture&&1===l.roughnessFactor&&(1===l.metallicFactor||0===l.metallicFactor)),g=d?n.PBRSchematicMRRValues[0]:l?l.metallicFactor:1,x=d?n.PBRSchematicMRRValues[1]:l?l.roughnessFactor:1,p="mask"===a.alphaMode?t.TextureUsage.Color|t.TextureUsage.AlphaMask:t.TextureUsage.Color,h={baseColorFactor:i?[i[0],i[1],i[2],i[3]]:[1,1,1,1],baseColorTextureId:s(l&&l.baseColorTexture,p),metallicRoughnessTextureId:s(l&&l.metallicRoughnessTexture,t.TextureUsage.MetallicRoughness),metallicFactor:g,roughnessFactor:x},f={alphaMode:a.alphaMode,alphaCutoff:a.alphaCutoff,doubleSided:a.doubleSided,cullFace:"none"===a.cullFace?u.CullFaceOptions.None:"back"===a.cullFace?u.CullFaceOptions.Back:"front"===a.cullFace?u.CullFaceOptions.Front:void 0,normalTextureId:s(a.normalTexture,t.TextureUsage.Normal),emissiveTextureId:s(a.emissiveTexture,t.TextureUsage.Emissive),occlusionTextureId:s(a.occlusionTexture,t.TextureUsage.Occlusion),emissiveFactor:c?[c[0],c[1],c[2]]:[0,0,0],metallicRoughness:h,wrapTextures:!1,hasParametersFromSource:d},F=[];return r.forEach((({usage:a},r)=>{const t=o.isSome(e)&&e[r]&&e[r].formats,s=t?m(t.map((({name:e,format:a})=>({name:e,encoding:T[a]})))):[];F.push({id:r,usage:a,encodings:s})})),{material:f,textures:F}}function m(e){return e.sort(((e,a)=>e.encoding-a.encoding))}const T={ktx2:t.TextureEncoding.KTX2,basis:t.TextureEncoding.Basis,dds:t.TextureEncoding.DDS_S3TC,png:t.TextureEncoding.PNG,jpg:t.TextureEncoding.JPG,"ktx-etc2":t.TextureEncoding.KTX_ETC2},x={[c.Texture.KTX2_ENCODING]:t.TextureEncoding.Basis,[c.Texture.BASIS_ENCODING]:t.TextureEncoding.Basis,[c.Texture.DDS_ENCODING]:t.TextureEncoding.DDS_S3TC,"image/png":t.TextureEncoding.PNG,"image/jpg":t.TextureEncoding.JPG,"image/jpeg":t.TextureEncoding.JPG,"image/ktx":t.TextureEncoding.KTX_ETC2};function p(e){const a=e&&e.materialDefinitions?Object.keys(e.materialDefinitions)[0]:null,o=e&&e.textureDefinitions?Object.keys(e.textureDefinitions)[0]:null,s=a&&e.materialDefinitions[a],n=o&&e.textureDefinitions[o],l=h();if(null!=s){const e=s.params;e.diffuse&&(l.metallicRoughness.baseColorFactor=[e.diffuse[0],e.diffuse[1],e.diffuse[2],1]),null!=e.doubleSided&&(l.doubleSided=e.doubleSided,l.cullFace=e.doubleSided?u.CullFaceOptions.None:u.CullFaceOptions.Back),"none"!==e.cullFace&&"front"!==e.cullFace&&"back"!==e.cullFace||(l.cullFace="none"===e.cullFace?u.CullFaceOptions.None:"back"===e.cullFace?u.CullFaceOptions.Back:u.CullFaceOptions.Front),e.transparency&&(l.metallicRoughness.baseColorFactor[3]=r.clamp(1-e.transparency,0,1)),(e.useVertexColorAlpha||l.metallicRoughness.baseColorFactor[3]<1)&&(l.alphaMode="blend")}const i=[];if(null!=n){const e=0;!n.wrap||"repeat"!==n.wrap[0]&&"repeat"!==n.wrap[1]||(l.wrapTextures=!0);let a=t.TextureUsage.Color;"rgba"===n.channels&&(l.alphaMode="blend",a|=t.TextureUsage.AlphaMask);const r=n.images.length-1,o=n.images[r],s=e=>e&&e.split("/").pop(),u=Array.isArray(n.encoding)?m(n.encoding.map(((e,a)=>({name:s(o.href[a]),encoding:x[e]||0})))):[{name:s(o.href),encoding:x[n.encoding]||0}];i.push({id:e,usage:a,encodings:u}),l.metallicRoughness.baseColorTextureId=e}return{material:l,textures:i}}const h=()=>({alphaMode:"opaque",alphaCutoff:l.defaultMaskAlphaCutoff,doubleSided:!0,cullFace:u.CullFaceOptions.None,normalTextureId:-1,emissiveTextureId:-1,occlusionTextureId:-1,emissiveFactor:[0,0,0],metallicRoughness:{baseColorFactor:[.8,.8,.8,1],baseColorTextureId:-1,metallicRoughnessTextureId:-1,metallicFactor:0,roughnessFactor:.6},wrapTextures:!1,hasParametersFromSource:!0});function f(e,a,s,n){if(o.isNone(e)||null==e.data)return null;const l=e.data,i=!(l instanceof HTMLImageElement)||r.isPowerOfTwo(l.width)&&r.isPowerOfTwo(l.height),u=n.renderingContext.parameters.maxMaxAnisotropy,d=s&&!n.capabilities.shaderTextureLOD?1:u,g=i&&!e.downsampled&&d>1,m=s||!a.wrapTextures?F:b,T={mipmap:g,maxAnisotropy:d,encoding:P(e.encoding),wrap:m,components:e.usage&t.TextureUsage.Color?"opaque"===a.alphaMode?3:4:3,noUnpackFlip:!0};return new c.Texture(l,T)}const F={s:d.TextureWrapMode.CLAMP_TO_EDGE,t:d.TextureWrapMode.CLAMP_TO_EDGE},b={s:d.TextureWrapMode.REPEAT,t:d.TextureWrapMode.REPEAT};function C(e,a,n,c,d,g){const m=g.rendererTextureUsage,T=e=>S(c,n,e&m),x=a.metallicRoughness.baseColorFactor,p=r.clamp(a.metallicRoughness.baseColorFactor[3],0,1);e.baseColor=[x[0],x[1],x[2],p],e.hasParametersFromSource=!!a.hasParametersFromSource,e.usePBR=g.usePBR,e.mrrFactors=[a.metallicRoughness.metallicFactor,a.metallicRoughness.roughnessFactor,a.hasParametersFromSource?.2:.5],e.emissiveFactor=a.emissiveFactor,e.isIntegratedMesh=g.isIntegratedMesh,e.alphaCutoff="mask"===a.alphaMode?a.alphaCutoff:l.defaultMaskAlphaCutoff,e.alphaDiscardMode="opaque"===a.alphaMode?u.AlphaDiscardMode.Opaque:"mask"===a.alphaMode?u.AlphaDiscardMode.Mask:u.AlphaDiscardMode.MaskBlend;const h=[],f=T(t.TextureUsage.Color|t.TextureUsage.AlphaMask);o.isSome(f)&&(e.baseColorTexture=new s.RenderTexture(d,f),h.push(e.baseColorTexture.loadPromise));const F=T(t.TextureUsage.MetallicRoughness);o.isSome(F)&&(e.metallicRoughnessTexture=new s.RenderTexture(d,F),h.push(e.metallicRoughnessTexture.loadPromise));const b=T(t.TextureUsage.Emissive);o.isSome(b)&&(e.emissionTexture=new s.RenderTexture(d,b),h.push(e.emissionTexture.loadPromise));const C=T(t.TextureUsage.Occlusion);o.isSome(C)&&(e.occlusionTexture=new s.RenderTexture(d,C),h.push(e.occlusionTexture.loadPromise));const E=T(t.TextureUsage.Normal);return o.isSome(E)&&(e.normalTexture=new s.RenderTexture(d,E),h.push(e.normalTexture.loadPromise)),e.commonMaterialParameters.slicePlaneEnabled=g.slicePlaneEnabled,e.commonMaterialParameters.doubleSided=a.doubleSided,e.commonMaterialParameters.cullFace=a.cullFace,e.ellipsoidMode=i.getEllipsoidMode(g.viewSpatialReference),Promise.all(h)}function E(e){const r=!!e.compressedTextureS3TC,o=!!e.compressedTextureETC,s=a("disable-feature:i3s-basis")?0:t.TextureEncoding.Basis|t.TextureEncoding.KTX2,n=t.TextureEncoding.JPG|t.TextureEncoding.PNG,l=s|t.TextureEncoding.DDS_S3TC;return n|(r?l:0)|(o?s:0)}function M(e,a){return e.find((e=>0!=(e.encoding&a)))}function S(e,a,r){if(o.isNone(e)||r===t.TextureUsage.None)return null;for(let t=0;t<e.length;t++){const s=e[t];if(o.isSome(s)&&0!=(s.usage&r)){const e=a[t];return o.isSome(e)?e.id:null}}return null}function P(e){switch(e){case t.TextureEncoding.KTX2:return c.Texture.KTX2_ENCODING;case t.TextureEncoding.Basis:return c.Texture.BASIS_ENCODING;case t.TextureEncoding.DDS_S3TC:return c.Texture.DDS_ENCODING;case t.TextureEncoding.PNG:return"image/png";case t.TextureEncoding.JPG:return"image/jpeg";case t.TextureEncoding.KTX_ETC2:return"image/ktx";default:return""}}e.configureMaterial=C,e.createTexture=f,e.defaultMaterial=h,e.getMaterialAndTextures=g,e.getMaterialAndTexturesFromShared=p,e.getSupportedEncodings=E,e.selectEncoding=M,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
