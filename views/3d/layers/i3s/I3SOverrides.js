/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../request","../../../../core/Accessor","../../../../core/arrayUtils","../../../../core/asyncUtils","../../../../core/byteSizeEstimations","../../../../core/Logger","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","../../../../intl/number","../../../../layers/support/featureQueryAll","../../../../support/featureFlags","../FeatureLayerView3D"],(function(e,t,i,r,s,n,a,o,c,d,h,u,l,y,p,_,g,m,b){"use strict";e.I3SOverrides=function(e){function i(t){var i;return(i=e.call(this,t)||this)._warnMaximumChangedObjectsExceeded=!1,i._interactiveEditingSessions=null,i._maximumNumberOfEditOVerrides=I,i._original3DOFLDefinitionExpression=null,i._associatedLayerView=null,i._changedObjectIds=new Set,i._pendingFetchChangedObjectIds=null,i._pendingFetchAbortController=new AbortController,i}t._inheritsLoose(i,e);var s=i.prototype;return s.initialize=function(){this._memCache=this.memoryController.newCache(`${this.layer.uid}-attribute-overrides`),this._pendingFetchChangedObjectIds=this._fetchChangedObjectIds(this._pendingFetchAbortController?.signal),this._pendingFetchChangedObjectIds.then((()=>{this._pendingFetchAbortController=null,this._pendingFetchChangedObjectIds=null})),this.is3DOFL&&m.enableDirect3DObjectFeatureLayerDisplay()&&d.isSome(this._associatedLayer)&&this._associatedLayer.load().then((e=>{this.destroyed||(this._original3DOFLDefinitionExpression=e.definitionExpression,this.addHandles(u.watch((()=>this._definitionExpression),(t=>e.definitionExpression=t),u.initial)),this._associatedLayerView=new b({layer:this._associatedLayer,view:this.view}))}))},s.destroy=function(){this.is3DOFL&&m.enableDirect3DObjectFeatureLayerDisplay()&&d.isSome(this._associatedLayerView)&&d.isSome(this._associatedLayer)&&(this._associatedLayer.definitionExpression=d.unwrap(this._original3DOFLDefinitionExpression)),this._set("layer",null),this._memCache=d.destroyMaybe(this._memCache),this._pendingFetchAbortController=d.abortMaybe(this._pendingFetchAbortController),this._pendingFetchChangedObjectIds=null},s.createInteractiveEditSession=function(e){this._changedObjectIds.add(e),this.notifyChange("_changedObjectIds"),d.isNone(this._interactiveEditingSessions)&&(this._interactiveEditingSessions=[]);const t=this._interactiveEditingSessions,i=new f(e,{rollback:()=>{n.remove(t,i),0===t.length&&(this._interactiveEditingSessions=null)},commit:t=>{for(const[i,r]of t)this.updateAttributeValue(e,i,r)}});return t.unshift(i),i},s.apply=function(){var e=t._asyncToGenerator((function*(e,t,i){if(d.isNone(t))return;const{loadedAttributes:r,attributeData:s}=t;if(d.isNone(r)||0===r.length||d.isNone(s))return;if(this._pendingFetchChangedObjectIds&&(yield h.whenOrAbort(this._pendingFetchChangedObjectIds,i)),0===this._changedObjectIds.size)return;const n={loadedAttributes:r,attributeData:s},a=this._getOverridesFromCache(e,n,this._changedObjectIds),{objectIds:o,fieldNames:c}=a;if(0===o.length||0===c.length)return;const u=yield this._queryOverridesFromAssociatedLayer(o,c,i);d.isNone(u)||this._processOverridesFromAssociatedLayer(e,u,c,n)}));function i(t,i,r){return e.apply(this,arguments)}return i}(),s.updateGeometry=function(e){this._changedObjectIds.add(e),this.notifyChange("_changedObjectIds")},s.updateAttributeValue=function(e,t,i){this._changedObjectIds.add(e),this._cacheAttributeValue(e,t,i),this.notifyChange("_changedObjectIds")},s._cacheAttributeValue=function(e,t,i){this._memCache.put(this._getAttributeCacheKey(e,t),i,this._memCacheAttributeValueSize(i))},s._getOverridesFromCache=function(e,{loadedAttributes:t,attributeData:i},r){const s=new Set,n=new Array;for(const o of t)n[o.index]=i[o.name];const a=new Set;for(let o=0;o<e.length;o++){const i=e[o];if(r.has(i))for(const e of t){const t=this._fromCache(i,e.index);void 0===t?(s.add(i),a.add(e.name)):n[e.index][o]=t}}return{objectIds:Array.from(s),fieldNames:Array.from(a)}},s._fromCache=function(e,t){const i=this._fromInteractiveEditingSession(e,t);if(void 0!==i)return i;const r=this._getAttributeCacheKey(e,t);return this._memCache.get(r)},s._fromInteractiveEditingSession=function(e,t){if(!d.isNone(this._interactiveEditingSessions))for(const i of this._interactiveEditingSessions){if(i.objectId!==e)continue;const r=i.get(t);if(void 0!==r)return r}},s._getAttributeCacheKey=function(e,t){return`${e}-${t}`},s._queryOverridesFromAssociatedLayer=function(){var e=t._asyncToGenerator((function*(e,t,i){if(0===e.length||0===t.length)return null;e=e.sort(((e,t)=>e-t)),this._warnMaximumChangedObjectsExceeded&&(this._warnMaximumChangedObjectsExceeded=!1,this._logMaximumObjectsExceededWarning());const r=this.layer.associatedLayer;if(d.isNone(r))return null;const s=r.createQuery();s.where="1=1",s.returnGeometry=!1,s.outFields=[r.objectIdField,...t],s.cacheHint=!0,s.objectIds=e;const o=g.getMaximumQuerySize(r),c=e.length>o?n.splitIntoChunks(e,o).map((e=>{const t=s.clone();return t.objectIds=e,a.resultOrAbort(g.queryAllJSON(r,t,{signal:i}))})):[a.resultOrAbort(g.queryAllJSON(r,s,{signal:i}))];return(yield Promise.all(c)).reduce(((e,t)=>e.concat(t.ok?t.value.features:[])),[])}));function i(t,i,r){return e.apply(this,arguments)}return i}(),s._logMaximumObjectsExceededWarning=function(){let e=`The number of edited objects that are not yet cached in the scene service exceeds the maximum limit. Attribute changes will only be available for the first ${_.formatNumber(this._maximumNumberOfEditOVerrides)} objects. Please consider re-caching the scene service`;const t=this.layer.portalItem;t&&t.loaded?e+=` (${t.portal.url}/home/item.html?id=${t.id}#settings)`:e+=` (${this.layer.parsedUrl.path})`,c.getLogger("esri.views.3d.layers.i3s.I3SOverrides").warn("#queryOverrides()",this.layer.title,`${e}.`)},s._processOverridesFromAssociatedLayer=function(e,t,i,{loadedAttributes:r,attributeData:s}){const n=this.layer.associatedLayer;if(d.isNone(n))return;const a=n.objectIdField,o=i.map((e=>s[e])),c=new Map(r.map((e=>[e.name,e.index]))),h=i.map((e=>c.get(e))),u=new Map(Array.from(e,((e,t)=>[e,t])));for(const d of t){const e=d.attributes[a];for(let t=0;t<i.length;t++){const r=h[t],s=u.get(e),n=d.attributes[i[t]];o[t][s]=n,this._cacheAttributeValue(e,r,n)}}},s._memCacheAttributeValueSize=function(e){return"string"==typeof e?o.estimateStringByteSize(e):o.estimateNumberByteSize()},s._fetchChangedObjectIds=function(){var e=t._asyncToGenerator((function*(e){const t=this.layer;if(yield t.load({signal:e}),this._changedObjectIds.clear(),d.isNone(t.associatedLayer)||!t.associatedLayer.capabilities?.operations?.supportsChangeTracking)return;const i=this._getFetchChangedObjectIdsServerGen();if(d.isNone(i))return;const s=t.associatedLayer.layerId,n=d.isSome(t.associatedLayer.infoFor3D),o=yield a.result(r(`${t.associatedLayer.url}/extractChanges`,{method:"post",query:{f:"json",returnIdsOnly:!0,layers:`[${s}]`,returnUpdates:!0,returnDeletes:n,returnInserts:n,layerServerGens:JSON.stringify([{id:s,serverGen:i}])},timeout:v,signal:e}));if(o.ok&&o.value.data?.edits&&1===o.value.data.edits.length){const e=o.value.data.edits[0],t=d.get(e,"objectIds","adds"),i=d.get(e,"objectIds","updates"),r=d.get(e,"objectIds","deletes");let s=[];d.isSome(t)&&(s=s.concat(t)),d.isSome(i)&&(s=s.concat(i)),d.isSome(r)&&(s=s.concat(r));const n=Math.min(this._maximumNumberOfEditOVerrides,s.length);n<s.length&&(this._warnMaximumChangedObjectsExceeded=!0);const a=s.sort(((e,t)=>e-t));for(let o=0;o<n;o++)this._changedObjectIds.add(a[o])}this.notifyChange("_changedObjectIds")}));function i(t){return e.apply(this,arguments)}return i}(),s._getFetchChangedObjectIdsServerGen=function(){const e=this.layer;if(d.isSome(e.serviceUpdateTimeStamp)&&d.isSome(e.serviceUpdateTimeStamp.lastUpdate))return e.serviceUpdateTimeStamp.lastUpdate;const t=e.associatedLayer;return d.isSome(t)&&d.isSome(t.serverGens)&&d.isSome(t.serverGens.minServerGen)?t.serverGens.minServerGen:null},t._createClass(i,[{key:"is3DOFL",get:function(){return m.sceneLayerEditingEnabled()&&d.isSome(this._associatedLayer)&&d.isSome(this._associatedLayer.infoFor3D)}},{key:"geometryChangedObjectIds",get:function(){return this.is3DOFL?[...this._changedObjectIds]:[]}},{key:"_associatedLayer",get:function(){return null==this.layer?null:this.layer.associatedLayer}},{key:"_definitionExpression",get:function(){const e=this.geometryChangedObjectIds;return 0===e.length?"1 = 0":`OBJECTID IN (${e.join(",")})`}},{key:"updating",get:function(){if(!this.is3DOFL)return!1;if(!m.enableDirect3DObjectFeatureLayerDisplay())return!1;return!d.isSome(this._associatedLayerView)||d.isSome(this._associatedLayerView)&&this._associatedLayerView.updating}},{key:"isEmpty",get:function(){return null==this._pendingFetchChangedObjectIds&&0===this._changedObjectIds.size}},{key:"test",get:function(){const e=Array.from(this._changedObjectIds),t=this._pendingFetchChangedObjectIds,i=this;return{changedObjectIds:e,pendingFetchChangedObjectIds:t,get maximumNumberOfEditOVerrides(){return i._maximumNumberOfEditOVerrides},set maximumNumberOfEditOVerrides(e){i._maximumNumberOfEditOVerrides=e}}}}]),i}(s),i.__decorate([l.property({constructOnly:!0})],e.I3SOverrides.prototype,"view",void 0),i.__decorate([l.property({constructOnly:!0})],e.I3SOverrides.prototype,"layer",void 0),i.__decorate([l.property({readOnly:!0})],e.I3SOverrides.prototype,"is3DOFL",null),i.__decorate([l.property({readOnly:!0})],e.I3SOverrides.prototype,"geometryChangedObjectIds",null),i.__decorate([l.property()],e.I3SOverrides.prototype,"_associatedLayer",null),i.__decorate([l.property()],e.I3SOverrides.prototype,"_associatedLayerView",void 0),i.__decorate([l.property({constructOnly:!0})],e.I3SOverrides.prototype,"memoryController",void 0),i.__decorate([l.property()],e.I3SOverrides.prototype,"_changedObjectIds",void 0),i.__decorate([l.property()],e.I3SOverrides.prototype,"_pendingFetchChangedObjectIds",void 0),i.__decorate([l.property()],e.I3SOverrides.prototype,"_definitionExpression",null),i.__decorate([l.property()],e.I3SOverrides.prototype,"updating",null),i.__decorate([l.property()],e.I3SOverrides.prototype,"isEmpty",null),e.I3SOverrides=i.__decorate([p.subclass("esri.views.3d.layers.i3s.I3SOverrides")],e.I3SOverrides);let f=function(){function e(e,t){this.objectId=e,this._options=t,this._updates=new Map,this._state=O.ACTIVE}var i=e.prototype;return i.get=function(e){return this._updates.get(e)},i.set=function(e,t){this._isActive&&this._updates.set(e,t)},i.rollback=function(){this._isActive&&(this._state=O.ROLLED_BACK,this._options.rollback())},i.commit=function(){this._isActive&&(this._state=O.COMMITTED,this._options.commit(this._updates),this._updates.clear())},t._createClass(e,[{key:"_isActive",get:function(){return this._state===O.ACTIVE}}]),e}();var O;!function(e){e[e.ACTIVE=0]="ACTIVE",e[e.COMMITTED=1]="COMMITTED",e[e.ROLLED_BACK=2]="ROLLED_BACK"}(O||(O={}));const v=1e4,I=5e4;Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
