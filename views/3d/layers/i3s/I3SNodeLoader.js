// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../core/asyncUtils","../../../../core/has","../../../../core/lang","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/urlUtils","./I3SBinaryReader","./I3SMaterialUtil","./I3SUtil"],(function(e,t,r,n,i,a,o,s,u,l,f,d){"use strict";var c=function(){function e(e,t,r,n,i,a){if(this.streamDataController=t,this.logger=r,this.defaultGeometrySchema=n,this.requiredAttributes=i,this.options=a,this.layerUrl=e.parsedUrl.path,this.geometryDefinitions=e.geometryDefinitions,e.materialDefinitions){var o=e.textureSetDefinitions;this.materialAndTextures=e.materialDefinitions.map((function(e){return f.getMaterialAndTextures(o,e)}))}}return e.prototype.load=function(e,t,r){return this.streamDataController.request(e,t,{signal:r})},e.prototype.loadAttribute=function(e,t,r){var n=this.layerUrl+"/nodes/"+e.resources.attributes+"/attributes/"+t.key+"/0";return this.load(n,"binary",r).then((function(e){return l.readBinaryAttribute(t,e)}))},e.prototype.loadAttributes=function(e,t,r){var n=this;return s.eachAlways(t.map((function(t){return n.loadAttribute(e,t.attributeStorageInfo,r)}))).then((function(r){for(var i={},a=0;a<t.length;++a)if(r[a].value)i[t[a].name]=r[a].value;else{if(s.isAbortError(r[a].error))throw r[a].error;n.logger.error("Failed to load attributeData for '"+t[a].name+"' on node '"+e.id+"'",r[a].error)}return i}))},e.prototype.loadNodeData=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var u,d,c,h,m,g,p,y,b,D,v,x,A,T,I,S,w,U,F,C,q,N,k,G,R,j,B,E,M,_,O,P;return r.__generator(this,(function(r){switch(r.label){case 0:return u=null!=this.requiredAttributes&&e.resources.attributes?n.result(this.loadAttributes(e,this.requiredAttributes,t)):null,d=function(e,t){var r={bufferDefinition:null,bufferIndex:0};if(null==e||t.resources.geometryDefinition<0)return r;var n=t.resources.geometryDefinition>=0?e[t.resources.geometryDefinition].geometryBuffers:null;if(null==n)return r;for(var a=0;a<n.length;a++){var o=n[a];if(null==o.compressedAttributes)r.bufferIndex=a,r.bufferDefinition=n[a];else if("draco"===o.compressedAttributes.encoding&&!i("disable-feature:i3s-draco"))return r.bufferIndex=a,r.bufferDefinition=o,r}return r}(this.geometryDefinitions,e),c=d.bufferDefinition,h=d.bufferIndex,m=!!e.resources.geometry,g=m?n.result(this.loadGeometry(e.resources.geometry,h,t)):null,e.resources.hasSharedResource?[4,this.loadShared(e,t)]:[3,2];case 1:return y=r.sent(),[3,3];case 2:y=null,r.label=3;case 3:return p=y,b=this.materialAndTextures&&e.resources.materialDefinition>=0?this.materialAndTextures[e.resources.materialDefinition]:null!=p?f.getMaterialAndTexturesFromShared(p):null,D=b&&b.material,v=b&&b.textures,x=""+e.id,(A=!m&&this.options.loadFeatureData)?[4,this.loadFeatureData(x,t)]:[3,5];case 4:return I=r.sent(),[3,6];case 5:I=null,r.label=6;case 6:return T=I,S=A?function(e){for(var t=0,r=e.featureData;t<r.length;t++){var n=r[t],i=n.geometries;if(null!=i)for(var a=0,o=i;a<o.length;a++){var s=o[a];return{featureIds:[n.id],featureDataPosition:n.position,geometries:[s]}}}return null}(T):function(e){return{featureIds:[],geometries:[{type:"ArrayBufferView",params:{material:e}}],featureDataPosition:[0,0,0]}}(D),w=o.isNone(S)&&function(e){for(var t=new Array,r=0,n=e.featureData;r<n.length;r++){var i=n[r];null!=i.position&&t.push({featureIds:[i.id],featureDataPosition:i.position,geometries:null})}return t}(T),U=null!=v&&v.length>0?n.result(this.loadTextures(e,v,t)):null,F=null,C=null,g?(N=(q=n).assertResult,[4,g]):[3,8];case 7:F=N.apply(q,[r.sent()]),k=function(e,t){if(!e||!t||!t.materialDefinitions)return e;var r=Object.keys(t.materialDefinitions)[0];!t.materialDefinitions[r].params.vertexRegions&&e.vertexAttributes.region&&delete(e=a.clone(e)).vertexAttributes.region;return e}(this.defaultGeometrySchema,p),C=l.createGeometryDescriptor(c,k),r.label=8;case 8:return U?(B=(j=n).assertResult,[4,U]):[3,10];case 9:return R=B.apply(j,[r.sent()]),[3,11];case 10:R=null,r.label=11;case 11:return G=R,u?(O=(_=n).assertResult,[4,u]):[3,13];case 12:return M=O.apply(_,[r.sent()]),[3,14];case 13:M={},r.label=14;case 14:return P=(E=M)?{attributeData:E,loadedAttributes:this.requiredAttributes}:null,o.isSome(S)?[2,{geometryData:S,attributeDataInfo:P,geometryBuffer:F,geometryDescriptor:C,requiredTextures:v,textureData:G}]:o.isSome(w)?[2,{pointData:w,attributeDataInfo:P,geometryBuffer:F,geometryDescriptor:C,requiredTextures:v,textureData:G}]:[2,s.reject()]}}))}))},e.addAbsoluteHrefTexture=function(e,t){var r=e.textureDefinitions;if(null!=r)for(var n=0,i=Object.keys(r);n<i.length;n++)for(var a=0,o=r[i[n]].images;a<o.length;a++){var s=o[a];Array.isArray(s.href)?s.hrefConcat=s.href.map((function(e){return u.makeAbsolute(e,t)})):s.hrefConcat=u.makeAbsolute(s.href,t)}},e.fixTextureEncodings=function(e){var t=e.textureDefinitions;if(null!=t)for(var r in t){var n=t[r];if(Array.isArray(n.encoding))for(var i=0;i<n.encoding.length;i++){var a;"data:"===(a=n.encoding[i]).substring(0,5)&&(n.encoding[i]=a.substring(5))}else"data:"===(a=n.encoding).substring(0,5)&&(n.encoding=a.substring(5))}},e.prototype.loadShared=function(t,r){var n=this.layerUrl+"/nodes/"+t.resources.geometry+"/shared";return this.load(n,"json",r).then((function(t){return e.fixTextureEncodings(t),e.addAbsoluteHrefTexture(t,n),t}))},e.prototype.loadTexture=function(e,t,r,n,i,a){return i===d.DDS_ENCODING_STRING?this.load(e,"binary",a).then((function(e){return{id:t,usage:r,data:e,encoding:i}})):this.load(e,"image",a).then((function(e){var a=e;if(n&&e.width*e.height>=4096){var o=Math.ceil(e.width/2),s=Math.ceil(e.height/2),u=document.createElement("canvas");u.width=o,u.height=s,u.getContext("2d").drawImage(e,0,0,o,s),a=u}return{id:t,usage:r,data:a,encoding:i}}))},e.prototype.loadTextures=function(t,r,n){var i=this,a=this.options.textureFormat===e.TextureFormat.Compressed,o=this.options.textureFormat===e.TextureFormat.Downsampled,u=this.options.textureUsageMask;return s.all(r.map((function(e){if(0==(e.usage&u))return null;var r=d.selectEncoding(e.encodings,a);if(null==r)return i.logger.error("No known encoding for texture found on node "+t.id),s.reject();var l=t.resources.texture||t.id,f=i.layerUrl+"/nodes/"+l+"/textures/"+r.name;return i.loadTexture(f,e.id,e.usage,o,r.encoding,n)})))},e.prototype.loadFeatureData=function(e,t){var r=this.layerUrl+"/nodes/"+e+"/features/0";return this.load(r,"json",t)},e.prototype.loadGeometry=function(e,t,r){var n=this.layerUrl+"/nodes/"+e+"/geometries/"+t;return this.load(n,"binary",r)},e}();return function(e){!function(e){e[e.Compressed=0]="Compressed",e[e.Normal=1]="Normal",e[e.Downsampled=2]="Downsampled"}(e.TextureFormat||(e.TextureFormat={}))}(c||(c={})),c}));