/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../core/asyncUtils","../../../../core/has","../../../../core/lang","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/urlUtils","./enums","./I3SBinaryReader","./I3SMaterialUtil"],(function(e,t,r,n,i,o,s,a,u,l){"use strict";let d=function(){function r(e,t,r,n,i,o){if(this.streamDataController=t,this.logger=r,this.defaultGeometrySchema=n,this.requiredAttributes=i,this.options=o,this.logLayer=e,this.layerUrl=e.parsedUrl.path,this.geometryDefinitions=e.geometryDefinitions,e.materialDefinitions){const t=e.textureSetDefinitions;this.materialAndTextures=e.materialDefinitions.map((e=>l.getMaterialAndTextures(t,e)))}}var n=r.prototype;return n._load=function(e,t,r){return this.streamDataController.request(e,t,r)},n._loadAttribute=function(e,t,r){const n=`${this.layerUrl}/nodes/${e.resources.attributes}/attributes/${t.key}/0`;return this._load(n,"binary",r).then((e=>u.readBinaryAttribute(t,e)))},n.loadAttributes=function(e,t,r){return o.eachAlways(t.map((t=>this._loadAttribute(e,t.attributeStorageInfo,r)))).then((r=>{const n={};for(let i=0;i<t.length;++i)if(r[i].value)n[t[i].name]=r[i].value;else{if(o.isAbortError(r[i].error))throw r[i].error;this.logger.error("#loadAttributes",this.logLayer,`Failed to load attributeData for '${t[i].name}' on node '${e.id}'`,r[i].error)}return n}))},n.loadNodeData=function(){var r=e._asyncToGenerator((function*(e,r){const n=null!=this.requiredAttributes&&e.resources.attributes?t.result(this.loadAttributes(e,this.requiredAttributes,r)):null,{bufferDefinition:o,bufferIndex:s}=m(this.geometryDefinitions,e),a=!!e.resources.geometry,d=a?t.result(this._loadGeometry(e.resources.geometry,s,r)):null,y=e.resources.hasSharedResource?yield this._loadShared(e,r):null,b=this.materialAndTextures&&e.resources.materialDefinition>=0?this.materialAndTextures[e.resources.materialDefinition]:null!=y?l.getMaterialAndTexturesFromShared(y):null,D=b&&b.material,x=b&&b.textures,p=`${e.id}`,A=!a&&this.options.loadFeatureData,_=A?yield this._loadFeatureData(p,r):null,T=A?c(_):f(D),$=i.isNone(T)&&h(_),S=null!=x&&x.length>0?t.result(this.loadTextures(e,x,r)):null;let I=null,w=null;if(d){I=t.assertResult(yield d);const e=g(this.defaultGeometrySchema,y);w=u.createGeometryDescriptor(o,e)}const U=S?t.assertResult(yield S):null,E=n?t.assertResult(yield n):{},k=E?{attributeData:E,loadedAttributes:this.requiredAttributes}:null;return i.isSome(T)?{geometryData:T,attributeDataInfo:k,geometryBuffer:I,geometryDescriptor:w,requiredTextures:x,textureData:U}:i.isSome($)?{pointData:$,attributeDataInfo:k,geometryBuffer:I,geometryDescriptor:w,requiredTextures:x,textureData:U}:Promise.reject()}));function n(e,t){return r.apply(this,arguments)}return n}(),r._addAbsoluteHrefTexture=function(e,t){const r=e.textureDefinitions;if(null!=r)for(const n of Object.keys(r))for(const e of r[n].images)Array.isArray(e.href)?e.hrefConcat=e.href.map((e=>s.makeAbsolute(e,t))):e.hrefConcat=s.makeAbsolute(e.href,t)},r._fixTextureEncodings=function(e){const t=e.textureDefinitions;if(null!=t)for(const r in t){const e=t[r];if(Array.isArray(e.encoding))for(let t=0;t<e.encoding.length;t++){const r=e.encoding[t];"data:"===r.substring(0,5)&&(e.encoding[t]=r.substring(5))}else{const t=e.encoding;"data:"===t.substring(0,5)&&(e.encoding=t.substring(5))}}},n._loadShared=function(e,t){const n=`${this.layerUrl}/nodes/${e.resources.geometry}/shared`;return this._load(n,"json",t).then((e=>(r._fixTextureEncodings(e),r._addAbsoluteHrefTexture(e,n),e)))},n._loadTexture=function(e,t,r,n,i,o){let s=!1;return i===a.TextureEncoding.DDS_S3TC||i===a.TextureEncoding.KTX2||i===a.TextureEncoding.Basis?this._load(e,"binary",o).then((e=>({id:t,usage:r,data:e,encoding:i,downsampled:s}))):this._load(e,"image",o).then((e=>{let o=e;const a=4096,u=2;if(n&&e.width*e.height>=a){const t=Math.ceil(e.width/u),r=Math.ceil(e.height/u),n=document.createElement("canvas");n.width=t,n.height=r;n.getContext("2d").drawImage(e,0,0,t,r),o=n,s=!0}return{id:t,usage:r,data:o,encoding:i,downsampled:s}}))},n.loadTextures=function(e,t,r){const n=this.options.uncompressedTextureDownsamplingEnabled,i=this.options.textureUsageMask;return Promise.all(t.map((t=>{if(0==(t.usage&i))return null;const o=l.selectEncoding(t.encodings,this.options.textureEncodings);if(null==o)return this.logger.error("#loadTextures",this.logLayer,`No known encoding for texture found on node ${e.id}`),Promise.reject();const s=e.resources.texture||e.id,a=`${this.layerUrl}/nodes/${s}/textures/${o.name}`;return this._loadTexture(a,t.id,t.usage,n,o.encoding,r)})))},n._loadFeatureData=function(e,t){const r=`${this.layerUrl}/nodes/${e}/features/0`;return this._load(r,"json",t)},n._loadGeometry=function(e,t,r){const n=`${this.layerUrl}/nodes/${e}/geometries/${t}`;return this._load(n,"binary",r)},r}();function f(e){return{featureIds:[],geometries:[{type:"ArrayBufferView",params:{material:e}}],featureDataPosition:[0,0,0]}}function c(e){for(const t of e.featureData){const e=t.geometries;if(null!=e)for(const r of e)return{featureIds:[t.id],featureDataPosition:t.position,geometries:[r]}}return null}function h(e){const t=new Array;for(const r of e.featureData)null!=r.position&&t.push({featureIds:[r.id],featureDataPosition:r.position,geometries:null});return t}function g(e,t){if(!e||!t||!t.materialDefinitions)return e;const r=Object.keys(t.materialDefinitions)[0];return!t.materialDefinitions[r].params.vertexRegions&&e.vertexAttributes.region&&delete(e=n.clone(e)).vertexAttributes.region,e}function m(e,t){const n={bufferDefinition:null,bufferIndex:0};if(null==e||t.resources.geometryDefinition<0)return n;const i=t.resources.geometryDefinition>=0?e[t.resources.geometryDefinition].geometryBuffers:null;if(null==i)return n;for(let o=0;o<i.length;o++){const e=i[o];if(null==e.compressedAttributes)n.bufferIndex=o,n.bufferDefinition=i[o];else if("draco"===e.compressedAttributes.encoding&&!r("disable-feature:i3s-draco"))return n.bufferIndex=o,n.bufferDefinition=e,n}return n}return d}));
