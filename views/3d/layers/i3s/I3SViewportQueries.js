// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../core/libs/gl-matrix-2/vec4","../../../../core/libs/gl-matrix-2/vec4f64","../../../../layers/graphics/dehydratedFeatures","../graphics/ElevationContext","../graphics/featureExpressionInfoUtils","../graphics/Graphics3DSymbolCommonCode","./I3SUtil","../../support/geometryUtils","../../support/orientedBoundingBox","../../support/projectionUtils"],function(e,t,i,r,s,n,a,o,c,h,p,u,m,l){return function(){function e(e,t,i,s,n,o,c){void 0===c&&(c={}),this.indexSR=e,this._renderCoordsHelper=t,this.extent=s,this.elevationProvider=n,this.options=c,this.fp=u.frustum.create(),this._poi=r.vec3f64.create(),this.minDistance=1/0,this.maxDistance=0,this.maxLodLevel=2,this._tmp1=r.vec3f64.create(),this._tmp2=r.vec3f64.create(),this._tmp3=r.vec3f64.create(),this._tmp0=r.vec3f64.create(),this.screenspaceErrorBias=c.screenspaceErrorBias||1,this.progressiveLoadFactor=c.progressiveLoadFactor||1,this.updateCamera(i),this.engineSR=this._renderCoordsHelper.spatialReference,this.updateElevationInfo(o.elevationInfo),this.tmpPoint=a.makeDehydratedPoint(0,0,0,e)}return e.prototype.updateElevationInfo=function(e){if(null==e)return void(this._elevationContext=null);this._elevationContext=new o,this._elevationContext.featureExpressionInfoContext=c.createContext(c.extractExpressionInfo(e,!1)),this._elevationContext.mixinApi(e)},e.prototype.updateCamera=function(e){u.frustum.fromMatrix(e.viewMatrix,e.projectionMatrix,this.fp),this._screenSizeFactor=1/(e.perScreenPixelRatio/2),this._camPos=e.eye,this.minDistance=1/0,this.maxDistance=0},e.prototype.setPointOfInterest=function(e){i.vec3.copy(this._poi,e)},e.prototype.updateScreenSpaceErrorBias=function(e){var t=this.screenspaceErrorBias;return this.screenspaceErrorBias=e,t},e.prototype.updateExtent=function(e){this.extent=e},e.prototype.getRenderMbs=function(e){var t=e.renderMbs;return t||(t=n.vec4f64.fromValues(e.mbs[0],e.mbs[1],e.mbs[2],-1),e.renderMbs=t),t[3]<0&&(s.vec4.copy(t,e.mbs),this._elevationContext&&t[3]<1e5&&(this.tmpPoint.x=t[0],this.tmpPoint.y=t[1],this.tmpPoint.z=t[2],t[2]=h.computeElevation(this.elevationProvider,this.tmpPoint,this._elevationContext,this._renderCoordsHelper,null)),l.mbsToMbs(t,this.indexSR,t,this.engineSR)),t},e.prototype.getRenderObb=function(e){if(e.obb&&!(e.obb.halfSize[0]<0)&&e.renderObb){var t=e.renderObb;if(t.halfSize[0]<0){var i=0;this._elevationContext&&e.mbs[3]<1e5&&(this.tmpPoint.x=e.obb.center[0],this.tmpPoint.y=e.obb.center[1],this.tmpPoint.z=e.obb.center[2],i=h.computeElevation(this.elevationProvider,this.tmpPoint,this._elevationContext,this._renderCoordsHelper,null)-e.obb.center[2]),p.transformObb(e.obb,this.indexSR,t,this.engineSR,i)}return t}},e.prototype.isNodeVisible=function(e){var t=this.getRenderMbs(e);if(!this.isMBSinExtent(t))return!1;if(e.obb){var i=this.getRenderObb(e);return m.isVisible(i,this.fp)}return this.isMBSVisible(t)},e.prototype.isGeometryVisible=function(e){var t=this.getRenderObb(e);return!t||m.isVisible(t,this.fp)},e.prototype.isMBSinExtent=function(e){return!this.extent||0!==p.intersectBoundingBoxWithMbs(this.extent,e)},e.prototype.isMBSVisible=function(e){return u.frustum.intersectsSphere(this.fp.planes,u.sphere.wrap(e[3],e))},e.prototype.screenSpaceDiameterMbs=function(e,t){var r=this.getRenderMbs(e),s=Math.sqrt(i.vec3.squaredDistance(r,this._camPos)),n=s-r[3];return this._updateMinMaxDistance(s),n<0?.5*Number.MAX_VALUE:t/n*this._screenSizeFactor},e.prototype.calcCameraDistance=function(e){return this.calcCameraDistanceToCenter(e)-this.getRenderMbs(e)[3]},e.prototype.calcCameraDistanceToCenter=function(e){var t=this.getRenderMbs(e),r=i.vec3.distance(t,this._camPos);return this._updateMinMaxDistance(r),r},e.prototype.calcAngleDependentLoD=function(e){var t=this.getRenderMbs(e),r=t[3],s=Math.abs(t[0]*(t[0]-this._camPos[0])+t[1]*(t[1]-this._camPos[1])+t[2]*(t[2]-this._camPos[2]))/i.vec3.length(t),n=(s+r)/i.vec3.distance(t,this._camPos);return Math.min(1,n)},e.prototype.hasLOD=function(e){return 0!==e.lodMetric},e.prototype.getDistancePlanarMode=function(e,t){var i=e[0]-t[0],r=e[1]-t[1],s=e[2]-t[2],n=i*i+r*r,a=t[3];if(n<=a*a)return Math.abs(s);var o=Math.sqrt(n)-a;return Math.sqrt(s*s+o*o)},e.prototype.getDistanceGlobeMode=function(e,t){var r=i.vec3.length(t),s=i.vec3.length(e)-r;i.vec3.scale(this._tmp0,e,i.vec3.dot(e,t)/i.vec3.squaredLength(e));var n=i.vec3.squaredDistance(t,this._tmp0),a=t[3];if(n<=a*a)return Math.abs(s);var o=i.vec3.scale(this._tmp0,t,1/r),c=r,h=a*a/2/c,p=i.vec3.scale(this._tmp1,o,c-h),u=e,m=i.vec3.subtract(this._tmp2,u,p),l=i.vec3.subtract(this._tmp2,m,i.vec3.scale(this._tmp3,o,i.vec3.dot(o,m))),v=i.vec3.add(this._tmp2,p,i.vec3.scale(this._tmp2,l,a/i.vec3.length(l))),d=i.vec3.distance(u,v);if(s>=2e5){var f=i.vec3.subtract(this._tmp1,u,v),b=i.vec3.dot(f,o)/i.vec3.length(f);b<.08&&(b=1e-4),d/=b}return d},e.prototype.getDistance=function(e,t){return this.engineSR===l.SphericalECEFSpatialReference?this.getDistanceGlobeMode(e,t):this.getDistancePlanarMode(e,t)},e.prototype._updateMinMaxDistance=function(e){e>0?(this.minDistance=Math.min(this.minDistance,e),this.maxDistance=Math.max(this.maxDistance,e)):(this.minDistance=0,this.maxDistance=Math.max(this.maxDistance,-e))},e.prototype.getLodLevel=function(e){if(0===e.lodMetric||!e.resources.hasFeatureData)return 0;if(0===e.childCount)return this.maxLodLevel;if(this.progressiveLoadFactor<1){var t=this.progressiveLoadFactor*this.screenspaceErrorBias,i=this.screenspaceErrorBias;return this.evaluateLODmetric(e,t)?this.evaluateLODmetric(e,i)?2:1:0}return this.evaluateLODmetric(e,this.screenspaceErrorBias)?this.maxLodLevel:0},e.prototype.evaluateLODmetric=function(e,t){switch(e.lodMetric){case 2:var i=this.getRenderMbs(e),r=this.getDistance(this._camPos,i),s=2*r/this._screenSizeFactor,n=r+i[3];return this._updateMinMaxDistance(n),e.maxError*t<=s;case 1:var a=this.screenSpaceDiameterMbs(e,e.mbs[3]*t);return this.options.angleDependentLoD&&(a*=this.calcAngleDependentLoD(e)),a<e.maxError;case 3:return this.screenSpaceDiameterMbs(e,e.maxError)*t<10;case 4:return this.calcCameraDistance(e)>e.maxError*t}return!1},e.prototype.distToPOI=function(e){var t=this.getRenderMbs(e);return i.vec3.distance(t,this._poi)-t[3]},e.prototype.distCameraToPOI=function(){return i.vec3.distance(this._camPos,this._poi)},e}()});