/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../../core/maybe","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../chunks/vec4","../../../../geometry/ellipsoidUtils","../../../../geometry/projection","../../../../geometry/spatialReferenceEllipsoidUtils","../../../../geometry/support/frustum","../../../../geometry/support/spatialReferenceUtils","../../../../chunks/sphere","../../../../layers/graphics/dehydratedFeatures","../graphics/elevationAlignmentUtils","../graphics/ElevationContext","../graphics/featureExpressionInfoUtils","./I3SNode","./I3SUtil","../../support/orientedBoundingBox"],(function(e,t,i,s,n,r,o,a,c,h,u,l,m,d,_,p,b){"use strict";const g=1e5;return function(){function f(e,t,s,r,o,h,l,m,d={}){this._indexSR=e,this._renderCoordsHelper=t,this._clippingArea=o,this._elevationProvider=h,this._viewingMode=l,this._options=d,this._frustum=a.create(),this._useFrustumCulling=!1,this._poi=i.create(),this._elevationContext=null,this.minDistance=1/0,this.maxDistance=0,this.maxLodLevel=2,this._tmpObb=b.create(),this._tmp1=i.create(),this._tmp2=i.create(),this._tmp3=i.create(),this._tmp0=i.create(),this._screenspaceErrorBias=d.screenspaceErrorBias||1,this._progressiveLoadFactor=d.progressiveLoadFactor||1,this.updateCamera(s,r),this.engineSR=this._renderCoordsHelper.spatialReference,this.updateElevationInfo(m),this._tmpPoint=u.makeDehydratedPoint(0,0,0,e),this._isECEFOBBInLocalMode=this._indexSR.isWGS84&&(this.engineSR.isWebMercator||c.isPlateCarree(this.engineSR)),this._indexSREllipsoidRadius=n.getReferenceEllipsoid(this._indexSR).radius}var v=f.prototype;return v.updateElevationInfo=function(e){null!=e?(this._elevationContext=m.ElevationContext.fromElevationInfo(e),this._elevationContext.updateFeatureExpressionInfoContext(d.createContextWithoutExpressionSupport(d.extractExpressionInfo(e,!1)))):this._elevationContext=null},v.updateCamera=function(e,t){this._useFrustumCulling=t,t&&a.fromMatrix(e.viewMatrix,e.projectionMatrix,this._frustum),this._screenSizeFactor=1/(e.perScreenPixelRatio/2),this._camPos=e.eye,this.minDistance=1/0,this.maxDistance=0},v.setPointOfInterest=function(e){this._poi=e},v.updateScreenSpaceErrorBias=function(e){const t=this._screenspaceErrorBias;return this._screenspaceErrorBias=e,t},v.updateClippingArea=function(e){this._clippingArea=e},v.getElevationRange=function(t){if(e.isNone(this._elevationContext))return null;const i=t.mbs;if(!i)return null;const s=i[0],n=i[1],r=i[2],o=i[3],a="relative-to-scene"===this._elevationContext.mode?"scene":"ground";if(this._elevationProvider.getSphereElevationBounds)return this._elevationProvider.getSphereElevationBounds(s,n,r,o,this._indexSR,a);const c=this._elevationProvider.getElevation(s,n,r,this._indexSR,a);return e.isSome(c)?{min:c,max:c}:null},v.getRenderMbs=function(e){const t=e.renderMbs;return p.isValidMbs(t)||(e.mbs&&s.copy(t,e.mbs),this._elevationContext&&t[3]<g&&(this._tmpPoint.x=t[0],this._tmpPoint.y=t[1],this._tmpPoint.z=t[2],t[2]=l.evaluateElevationAlignmentAtPoint(this._tmpPoint,this._elevationProvider,this._elevationContext,this._renderCoordsHelper)),r.projectBoundingSphere(t,this._indexSR,t,this.engineSR)),t},v.getVisibilityObb=function(t){if(e.isSome(t.visibilityObb))return t.visibilityObb;const i=t.serviceObb,s=.01*this._indexSREllipsoidRadius;return e.isNone(i)||!t.mbs||!p.isValidObb(i)||this._isECEFOBBInLocalMode&&i.halfSize.some((e=>e>s))?null:(t.serviceObbInRenderSR=this._computeRenderObb(i,t.serviceObbInRenderSR,t.mbs[3],t.elevationRange),t.serviceObbInRenderSR)},v._computeRenderObb=function(t,i,s,n){if(e.isNone(i))i=b.create();else if(p.isValidObb(i))return i;let r=0,o=0;if(this._elevationContext&&e.isSome(n)&&Number.isFinite(n.min))switch(this._elevationContext.mode){case"relative-to-ground":r=this._elevationContext.geometryZWithOffset(t.center[2],this._renderCoordsHelper)+n.min-t.center[2],o=n.max-n.min;break;case"on-the-ground":r=n.min-t.center[2],o=n.max-n.min}else this._elevationContext&&s<g&&(this._tmpPoint.x=t.center[0],this._tmpPoint.y=t.center[1],this._tmpPoint.z=t.center[2],r=l.evaluateElevationAlignmentAtPoint(this._tmpPoint,this._elevationProvider,this._elevationContext,this._renderCoordsHelper)-t.center[2]);return o>0?(p.transformObb(t,this._indexSR,this._tmpObb,this.engineSR,r),b.computeOffsetObb(this._tmpObb,0,o,this._viewingMode,i)):p.transformObb(t,this._indexSR,i,this.engineSR,r),i},v.isNodeVisible=function(t){const i=this.getRenderMbs(t);if(!this._isMBSinClippingArea(i))return!1;if(!this._useFrustumCulling)return!0;const s=this.getVisibilityObb(t);return e.isSome(s)?b.isVisible(s,this._frustum):a.intersectsSphere(this._frustum,h.wrap(i))},v.isGeometryVisible=function(t){if(!this._useFrustumCulling)return!0;const i=t.geometryObb;return e.isSome(i)?b.isVisible(i,this._frustum):this.isNodeVisible(t)},v._isMBSinClippingArea=function(t){return!!e.isNone(this._clippingArea)||p.intersectBoundingRectWithMbs(this._clippingArea,t)!==p.MbsIntersectResult.OUTSIDE},v._screenSpaceDiameterMbs=function(e,i){const s=this.getRenderMbs(e),n=Math.sqrt(t.squaredDistance(s,this._camPos)),r=n-s[3];return this._updateMinMaxDistance(n),r<0?.5*Number.MAX_VALUE:i/r*this._screenSizeFactor},v.calcCameraDistance=function(e){return this.calcCameraDistanceToCenter(e)-this.getRenderMbs(e)[3]},v.calcCameraDistanceToCenter=function(e){const i=this.getRenderMbs(e),s=t.distance(i,this._camPos);return this._updateMinMaxDistance(s),s},v.calcAngleDependentLoD=function(e){const i=this.getRenderMbs(e),s=i[3],n=(Math.abs(i[0]*(i[0]-this._camPos[0])+i[1]*(i[1]-this._camPos[1])+i[2]*(i[2]-this._camPos[2]))/t.length(i)+s)/t.distance(i,this._camPos);return Math.min(1,n)},v.hasLOD=function(e){return e.lodMetric!==_.LodMetric.None},v._getDistancePlanarMode=function(e,t){const i=e[0]-t[0],s=e[1]-t[1],n=e[2]-t[2],r=i*i+s*s,o=t[3];if(r<=o*o)return Math.abs(n);const a=Math.sqrt(r)-o;return Math.sqrt(n*n+a*a)},v._getDistanceGlobeMode=function(e,i){const s=t.length(i),n=t.length(e)-s;t.scale(this._tmp0,e,t.dot(e,i)/t.squaredLength(e));const r=t.squaredDistance(i,this._tmp0),o=i[3];if(r<=o*o)return Math.abs(n);{const r=t.scale(this._tmp0,i,1/s),a=s,c=o*o/2/a,h=t.scale(this._tmp1,r,a-c),u=e,l=t.subtract(this._tmp2,u,h),m=t.subtract(this._tmp2,l,t.scale(this._tmp3,r,t.dot(r,l))),d=t.add(this._tmp2,h,t.scale(this._tmp2,m,o/t.length(m)));let _=t.distance(u,d);if(n>=2e5){const e=t.subtract(this._tmp1,u,d);let i=t.dot(e,r)/t.length(e);i<.08&&(i=1e-4),_/=i}return _}},v._getDistance=function(e,t){return this.engineSR===o.getSphericalPCPF(this.engineSR)?this._getDistanceGlobeMode(e,t):this._getDistancePlanarMode(e,t)},v._updateMinMaxDistance=function(e){e>0?(this.minDistance=Math.min(this.minDistance,e),this.maxDistance=Math.max(this.maxDistance,e)):(this.minDistance=0,this.maxDistance=Math.max(this.maxDistance,-e))},v.getLodLevel=function(e){if(e.lodMetric===_.LodMetric.None)return 0;if(0===e.childCount)return this.maxLodLevel;if(this._useFrustumCulling&&this._progressiveLoadFactor<1){const t=this._progressiveLoadFactor*this._screenspaceErrorBias,i=this._screenspaceErrorBias;return this.evaluateLODmetric(e,t)?this.evaluateLODmetric(e,i)?2:1:0}return this.evaluateLODmetric(e,this._screenspaceErrorBias)?this.maxLodLevel:0},v.evaluateLODmetric=function(e,t){switch(e.lodMetric){case _.LodMetric.ScreenSpaceRelative:{const i=this.getRenderMbs(e),s=this._getDistance(this._camPos,i),n=2*s/this._screenSizeFactor,r=s+i[3];return this._updateMinMaxDistance(r),e.maxError*t<=n}case _.LodMetric.MaxScreenThreshold:{let i=this._screenSpaceDiameterMbs(e,e.mbs[3]*t);return this._options.angleDependentLoD&&(i*=this.calcAngleDependentLoD(e)),i<e.maxError}case _.LodMetric.RemovedFeatureDiameter:return this._screenSpaceDiameterMbs(e,e.maxError)*t<10;case _.LodMetric.DistanceRangeFromDefaultCamera:return this.calcCameraDistance(e)>e.maxError*t}return!1},v.distToPOI=function(e){const i=this.getRenderMbs(e);return t.distance(i,this._poi)-i[3]},v.distCameraToPOI=function(){return t.distance(this._camPos,this._poi)},f}()}));
