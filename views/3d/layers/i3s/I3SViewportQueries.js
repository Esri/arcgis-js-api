// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../core/libs/gl-matrix-2/vec4","../../../../core/libs/gl-matrix-2/vec4f64","../../../../layers/graphics/dehydratedFeatures","../graphics/elevationAlignmentUtils","../graphics/ElevationContext","../graphics/featureExpressionInfoUtils","./I3SUtil","../../support/geometryUtils","../../support/orientedBoundingBox","../../support/projectionUtils"],(function(t,e,i,r,s,n,a,o,c,h,p,u,m,l){return function(){function t(t,e,i,s,n,o,c){void 0===c&&(c={}),this.indexSR=t,this._renderCoordsHelper=e,this.extent=s,this.elevationProvider=n,this.options=c,this.fp=u.frustum.create(),this._poi=r.vec3f64.create(),this.minDistance=1/0,this.maxDistance=0,this.maxLodLevel=2,this._tmp1=r.vec3f64.create(),this._tmp2=r.vec3f64.create(),this._tmp3=r.vec3f64.create(),this._tmp0=r.vec3f64.create(),this.screenspaceErrorBias=c.screenspaceErrorBias||1,this.progressiveLoadFactor=c.progressiveLoadFactor||1,this.updateCamera(i),this.engineSR=this._renderCoordsHelper.spatialReference,this.updateElevationInfo(o),this.tmpPoint=a.makeDehydratedPoint(0,0,0,t)}return t.prototype.updateElevationInfo=function(t){null!=t?(this._elevationContext=c.fromElevationInfo(t),this._elevationContext.featureExpressionInfoContext=h.createContextWithoutExpressionSupport(h.extractExpressionInfo(t,!1))):this._elevationContext=null},t.prototype.updateCamera=function(t){u.frustum.fromMatrix(t.viewMatrix,t.projectionMatrix,this.fp),this._screenSizeFactor=1/(t.perScreenPixelRatio/2),this._camPos=t.eye,this.minDistance=1/0,this.maxDistance=0},t.prototype.setPointOfInterest=function(t){i.vec3.copy(this._poi,t)},t.prototype.updateScreenSpaceErrorBias=function(t){var e=this.screenspaceErrorBias;return this.screenspaceErrorBias=t,e},t.prototype.updateExtent=function(t){this.extent=t},t.prototype.getRenderMbs=function(t){var e=t.renderMbs;return e||(e=n.vec4f64.fromValues(t.mbs[0],t.mbs[1],t.mbs[2],-1),t.renderMbs=e),e[3]<0&&(s.vec4.copy(e,t.mbs),this._elevationContext&&e[3]<1e5&&(this.tmpPoint.x=e[0],this.tmpPoint.y=e[1],this.tmpPoint.z=e[2],e[2]=o.evaluateElevationAlignmentAtPoint(this.tmpPoint,this.elevationProvider,this._elevationContext,this._renderCoordsHelper)),l.mbsToMbs(e,this.indexSR,e,this.engineSR)),e},t.prototype.getRenderObb=function(t){if(t.obb&&!(t.obb.halfSize[0]<0)&&t.renderObb){var e=t.renderObb;if(e.halfSize[0]<0){var i=0;this._elevationContext&&t.mbs[3]<1e5&&(this.tmpPoint.x=t.obb.center[0],this.tmpPoint.y=t.obb.center[1],this.tmpPoint.z=t.obb.center[2],i=o.evaluateElevationAlignmentAtPoint(this.tmpPoint,this.elevationProvider,this._elevationContext,this._renderCoordsHelper)-t.obb.center[2]),p.transformObb(t.obb,this.indexSR,e,this.engineSR,i,t.isComputedObb)}return e}},t.prototype.isNodeVisible=function(t){var e=this.getRenderMbs(t);if(!this.isMBSinExtent(e))return!1;if(t.obb){var i=this.getRenderObb(t);return m.isVisible(i,this.fp)}return this.isMBSVisible(e)},t.prototype.isGeometryVisible=function(t){var e=this.getRenderObb(t);return!e||m.isVisible(e,this.fp)},t.prototype.isMBSinExtent=function(t){return!this.extent||0!==p.intersectBoundingBoxWithMbs(this.extent,t)},t.prototype.isMBSVisible=function(t){return u.frustum.intersectsSphere(this.fp.planes,u.sphere.wrap(t[3],t))},t.prototype.screenSpaceDiameterMbs=function(t,e){var r=this.getRenderMbs(t),s=Math.sqrt(i.vec3.squaredDistance(r,this._camPos)),n=s-r[3];return this._updateMinMaxDistance(s),n<0?.5*Number.MAX_VALUE:e/n*this._screenSizeFactor},t.prototype.calcCameraDistance=function(t){return this.calcCameraDistanceToCenter(t)-this.getRenderMbs(t)[3]},t.prototype.calcCameraDistanceToCenter=function(t){var e=this.getRenderMbs(t),r=i.vec3.distance(e,this._camPos);return this._updateMinMaxDistance(r),r},t.prototype.calcAngleDependentLoD=function(t){var e=this.getRenderMbs(t),r=e[3],s=(Math.abs(e[0]*(e[0]-this._camPos[0])+e[1]*(e[1]-this._camPos[1])+e[2]*(e[2]-this._camPos[2]))/i.vec3.length(e)+r)/i.vec3.distance(e,this._camPos);return Math.min(1,s)},t.prototype.hasLOD=function(t){return 0!==t.lodMetric},t.prototype.getDistancePlanarMode=function(t,e){var i=t[0]-e[0],r=t[1]-e[1],s=t[2]-e[2],n=i*i+r*r,a=e[3];if(n<=a*a)return Math.abs(s);var o=Math.sqrt(n)-a;return Math.sqrt(s*s+o*o)},t.prototype.getDistanceGlobeMode=function(t,e){var r=i.vec3.length(e),s=i.vec3.length(t)-r;i.vec3.scale(this._tmp0,t,i.vec3.dot(t,e)/i.vec3.squaredLength(t));var n=i.vec3.squaredDistance(e,this._tmp0),a=e[3];if(n<=a*a)return Math.abs(s);var o=i.vec3.scale(this._tmp0,e,1/r),c=r,h=a*a/2/c,p=i.vec3.scale(this._tmp1,o,c-h),u=t,m=i.vec3.subtract(this._tmp2,u,p),l=i.vec3.subtract(this._tmp2,m,i.vec3.scale(this._tmp3,o,i.vec3.dot(o,m))),v=i.vec3.add(this._tmp2,p,i.vec3.scale(this._tmp2,l,a/i.vec3.length(l))),d=i.vec3.distance(u,v);if(s>=2e5){var b=i.vec3.subtract(this._tmp1,u,v),f=i.vec3.dot(b,o)/i.vec3.length(b);f<.08&&(f=1e-4),d/=f}return d},t.prototype.getDistance=function(t,e){return this.engineSR===l.SphericalECEFSpatialReference?this.getDistanceGlobeMode(t,e):this.getDistancePlanarMode(t,e)},t.prototype._updateMinMaxDistance=function(t){t>0?(this.minDistance=Math.min(this.minDistance,t),this.maxDistance=Math.max(this.maxDistance,t)):(this.minDistance=0,this.maxDistance=Math.max(this.maxDistance,-t))},t.prototype.getLodLevel=function(t){if(0===t.lodMetric||!t.resources.hasFeatureData)return 0;if(0===t.childCount)return this.maxLodLevel;if(this.progressiveLoadFactor<1){var e=this.progressiveLoadFactor*this.screenspaceErrorBias,i=this.screenspaceErrorBias;return this.evaluateLODmetric(t,e)?this.evaluateLODmetric(t,i)?2:1:0}return this.evaluateLODmetric(t,this.screenspaceErrorBias)?this.maxLodLevel:0},t.prototype.evaluateLODmetric=function(t,e){switch(t.lodMetric){case 2:var i=this.getRenderMbs(t),r=this.getDistance(this._camPos,i),s=2*r/this._screenSizeFactor,n=r+i[3];return this._updateMinMaxDistance(n),t.maxError*e<=s;case 1:var a=this.screenSpaceDiameterMbs(t,t.mbs[3]*e);return this.options.angleDependentLoD&&(a*=this.calcAngleDependentLoD(t)),a<t.maxError;case 3:return this.screenSpaceDiameterMbs(t,t.maxError)*e<10;case 4:return this.calcCameraDistance(t)>t.maxError*e}return!1},t.prototype.distToPOI=function(t){var e=this.getRenderMbs(t);return i.vec3.distance(e,this._poi)-e[3]},t.prototype.distCameraToPOI=function(){return i.vec3.distance(this._camPos,this._poi)},t}()}));