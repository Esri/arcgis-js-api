/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../chunks/vec3f64","../../../../chunks/vec3","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec4","../../../../geometry/support/aaBoundingBox","../../webgl-engine/lib/DefaultVertexAttributeLocations","../../../../chunks/mat4f32","../../../../chunks/vec3f32","../../support/geometryUtils","../../../webgl/BufferObject","../../../webgl/VertexArrayObject","../../webgl-engine/lib/intersectorUtils","../../webgl-engine/core/shaderLibrary/Slice.glsl","../../webgl-engine/core/shaderLibrary/output/OutputHighlight.glsl","../../support/orientedBoundingBox","./PointHighlights","../../webgl-engine/shaders/PointRendererTechnique"],(function(e,t,i,n,s,r,o,a,c,h,l,u,d,f,g,p,m,_,x,S,P){"use strict";const z={positions:[{name:"position",count:3,type:5126,offset:0,stride:12,normalized:!1}],colors:[{name:"color",count:3,type:5121,offset:0,stride:3,normalized:!0}]};function b(e){return e?256:64}function y(e,t,i,n,s){if(i.drawScreenSpace)return i.fixedSize*t*n;const r=b(s)*t*n;return i.drawFixedSize?Math.min(i.fixedSize/2,r):i.screenMinSize>0?Math.min(Math.max(i.screenMinSize*t*n,e/2),r):Math.min(e/2,r)}function R(e,t,i,n,s){return i.drawScreenSpace?0:y(e,t,i,n,s)}function w(e,t,i){return null==i&&(i=n.create()),i[0]=e.origin[0]+e.coordinates[3*t],i[1]=e.origin[1]+e.coordinates[3*t+1],i[2]=e.origin[2]+e.coordinates[3*t+2],i}function q(e){return i.isSome(e.component)?e.component:-1}e.PointRenderer=function(){function e(e){this._params=e,this.type="Point",this.isGround=!1,this._bindParameters={inverseViewport:[0,0],highlightDepthTexture:null},this._highlights=new S.PointHighlights({forEachNode:e=>this.forEachNode(e),addHighlight:(e,t,i)=>this.addHighlight(e,t,i),removeHighlight:(e,t)=>this.removeHighlight(e,t)}),this.canRender=!0,this.layerUid="",this._useFixedSizes=!1,this._scaleFactor=1,this._minSizePx=0,this._useRealWorldSymbolSizes=!1,this._size=0,this._sizePx=0,this._slicePlaneEnabled=!1,this._clipBox=c.create(c.POSITIVE_INFINITY),this._techniqueConfig=new P.PointRendererTechniqueConfiguration,this.tempMatrix4=l.create(),this.tempVec3=u.create(),this.nodes=[]}var v=e.prototype;return v.initializeRenderContext=function(e){this._initContext=e,this._techniqueRep=this._initContext.shaderTechniqueRep,e.requestRender()},v.uninitializeRenderContext=function(){},v.intersect=function(e,t,i,r){const h=n.create(),l=n.create(),u=n.create(),f=n.create(),g=d.plane.create(),m=e.camera.perScreenPixelRatio/2,_=e.camera.near,S=this._getSizeParams();s.subtract(l,r,i);const P=1/s.length(l);s.scale(l,l,P),s.negate(u,l),a.set(g,l[0],l[1],l[2],-s.dot(l,i));let z=function(){this.node=null,this.pointId=null,this.point=null,this.dist=null,this.normal=null,this.layerUid=""};const b=new z,q=new z,v=[],M=c.create(),H=c.create(this._clipBox);c.offset(H,-i[0],-i[1],-i[2],H);for(const n of this.nodes){const o=n.splatSize*this._scaleFactor;let a=x.minimumDistancePlane(n.obb,g),d=x.maximumDistancePlane(n.obb,g);a-=R(o,a+_,S,m,n.isLeaf),d-=R(o,d+_,S,m,n.isLeaf);const p=d<0,I=null!=b.dist&&null!=q.dist&&b.dist<a*P&&q.dist>d*P;if(p||I)continue;const F=y(o,d+_,S,m,n.isLeaf);if(!x.intersectLine(n.obb,i,l,F))continue;const V=F*F;x.toAaBoundingBox(n.obb,M),c.offset(M,-i[0],-i[1],-i[2],M);const U=!c.contains(H,M);s.subtract(f,n.origin,i);const k=n.coordinates.length/3;for(let a=0;a<k;a++){if(h[0]=f[0]+n.coordinates[3*a],h[1]=f[1]+n.coordinates[3*a+1],h[2]=f[2]+n.coordinates[3*a+2],U&&!c.containsPoint(H,h))continue;const d=s.dot(h,l),g=s.squaredLength(h)-d*d;if(g>V)continue;let p=d+_;const x=R(o,p,S,m,n.isLeaf);if(d-x<0)continue;p-=x;const M=y(o,p,S,m,n.isLeaf);if(g>M*M)continue;const I=(d-x)*P,F=e=>{e.point=w(n,a,e.point),e.dist=I,e.normal=u,e.node=n,e.pointId=a,e.layerUid=this.layerUid};if((null==b.dist||I<b.dist)&&(null==t||t(i,r,I))&&F(b),0!==e.options.store&&(null==q.dist||I>q.dist)&&(null==t||t(i,r,I))&&F(q),2===e.options.store&&(null==t||t(i,r,I))){const e=new z;F(e),v.push(e)}}}const I=e=>{const{layerUid:t,node:i,pointId:n}=e;return{type:"external",point:e.point,metadata:{layerUid:t,createGraphic:()=>this._params.createGraphic(i,n,e.point)}}},F=(e,t)=>{const i=I(t),n=`${t.layerUid}/${t.node.id}/${t.pointId}`;e.set(i,n,t.dist,t.normal,o.IDENTITY,void 0),e.intersector="PointRenderer"};if(null!=b.dist){const t=e.results.min;(null==t.dist||b.dist<t.dist)&&F(t,b)}if(null!=q.dist&&0!==e.options.store){const t=e.results.max;(null==t.dist||q.dist>t.dist)&&F(t,q)}if(2===e.options.store){const t=d.ray.fromPoints(i,r);for(const i of v){const n=new p.IntersectorResult(t);F(n,i),e.results.all.push(n)}}},v.render=function(e){if(0!==e.pass&&2!==e.pass&&5!==e.pass)return!1;const t=2===e.pass,i=e.rctx;for(const t of this.nodes)null==t.vao&&this._initNode(e,t);const n=this._getSizeParams(),o=this.selectTechnique(e,n),a=o.program;if(null==a||0===this.nodes.length)return!0;const h=this._clipBox,l=!c.equals(h,c.POSITIVE_INFINITY,((e,t)=>e===t));l||(s.set(this.tempVec3,-1/0,-1/0,-1/0),a.setUniform3fv("uClipMin",this.tempVec3),s.set(this.tempVec3,1/0,1/0,1/0),a.setUniform3fv("uClipMax",this.tempVec3)),i.bindProgram(a),o.bindPipelineState(i),a.setUniformMatrix4fv("uProjectionMatrix",e.camera.projectionMatrix),t&&a.setUniform2f("nearFar",e.camera.near,e.camera.far),e.isHighlightPass&&(this._bindParameters.inverseViewport[0]=1/e.camera.fullViewport[2],this._bindParameters.inverseViewport[1]=1/e.camera.fullViewport[3],this._bindParameters.highlightDepthTexture=e.highlightDepthTexture,_.OutputHighlight.bindOutputHighlight(i,a,this._bindParameters));const u=e.camera.pixelRatio;n.drawFixedSize&&a.setUniform2f("uPointScale",n.fixedSize*u,e.camera.fullHeight);const d=this._slicePlaneEnabled?e.sliceHelper&&e.sliceHelper.plane:null;for(const t of this.nodes){if(0===t.coordinates.length)continue;if(e.isHighlightPass&&!t.highlights)continue;if(a.setUniform2f("uScreenMinMaxSize",n.screenMinSize*u,b(t.isLeaf)*u),!n.drawFixedSize){const i=t.splatSize*this._scaleFactor;a.setUniform2f("uPointScale",i*u,e.camera.fullHeight/u)}const c=t.origin;l&&(s.set(this.tempVec3,h[0]-c[0],h[1]-c[1],h[2]-c[2]),a.setUniform3fv("uClipMin",this.tempVec3),s.set(this.tempVec3,h[3]-c[0],h[4]-c[1],h[5]-c[2]),a.setUniform3fv("uClipMax",this.tempVec3)),r.identity(this.tempMatrix4),r.translate(this.tempMatrix4,this.tempMatrix4,c),r.multiply(this.tempMatrix4,e.camera.viewMatrix,this.tempMatrix4),a.setUniformMatrix4fv("uModelViewMatrix",this.tempMatrix4),m.Slice.bindUniforms(a,o.configuration,d,c),i.bindVAO(t.vao),e.isHighlightPass?this._renderHighlightFragments(i,t):i.drawArrays(0,0,t.coordinates.length/3)}return!0},v._renderHighlightFragments=function(e,t){const n=t.highlights;if(i.isNone(n))return;let s=i.unwrap(n[0].component),r=s+1;for(let t=1;t<n.length;t++){const o=i.unwrap(n[t].component);if(o!==r){const t=r-s;t>0&&e.drawArrays(0,s,t),s=o}r=o+1}const o=r-s;o>0&&e.drawArrays(0,s,o)},v.addNode=function(e){this.nodes.push(e),this._highlights.nodeAdded(e),this._requestRender()},v.removeNode=function(e){let t=null;return this.nodes=this.nodes.filter((i=>i.id!==e||(t=i,i.vao&&(i.vao.dispose(!0),i.vao=null),this._highlights.nodeRemoved(i),!1))),this._requestRender(),t},v.forEachNode=function(e){this.nodes.forEach(e)},v.removeAll=function(){this.nodes.forEach((e=>{e.vao&&(e.vao.dispose(!0),e.vao=null)})),this._highlights.removeAll(),this.nodes=[],this._requestRender()},v.highlight=function(e){return this._highlights.add(e)},v.addHighlight=function(e,t,n){e.highlights=function(e,t,n){i.isNone(e)&&(e=[]);const s={component:t,id:n};e.push(s);const r=q(s);let o=e.length-1;for(;o>0&&r<q(e[o-1]);)[e[o-1],e[o]]=[e[o],e[o-1]],--o;return e}(e.highlights,t,n),this._requestRender()},v.removeHighlight=function(e,t){e.highlights=function(e,t){if(i.isNone(e))return e;const n=e.filter((e=>e.id!==t));if(0===n.length)return null;return n}(e.highlights,t),this._requestRender()},v._initNode=function(e,t){const i=e.rctx;t.vao=new g(i,h.Default3D,z,{positions:f.createVertex(i,35044,t.coordinates),colors:f.createVertex(i,35044,t.rgb)})},v._requestRender=function(){this._initContext&&this._initContext.requestRender()},v._getSizeParams=function(){const e=this._useFixedSizes,t=e&&!this._useRealWorldSymbolSizes,i=t?this._sizePx:this._size;let n=this._minSizePx;return e&&(n=0),{drawScreenSpace:t,drawFixedSize:e,fixedSize:i,screenMinSize:n}},v.selectTechnique=function(e,t){return this._techniqueConfig.drawScreenSize=t.drawScreenSpace,this._techniqueConfig.slicePlaneEnabled=this._slicePlaneEnabled,this._techniqueConfig.sceneHasOcludees=e.hasOccludees,this._techniqueConfig.output=2===e.pass?1:5===e.pass?4:0,this._techniqueRep.acquireAndReleaseExisting(P.PointRendererTechnique,this._techniqueConfig,this._technique)},t._createClass(e,[{key:"needsHighlight",get:function(){return this._highlights.hasHighlights}},{key:"useFixedSizes",set:function(e){this._useFixedSizes!==e&&(this._useFixedSizes=e,this._requestRender())},get:function(){return this._useFixedSizes}},{key:"scaleFactor",set:function(e){this._scaleFactor!==e&&(this._scaleFactor=e,this._requestRender())},get:function(){return this._scaleFactor}},{key:"minSizePx",set:function(e){this._minSizePx!==e&&(this._minSizePx=e,this._requestRender())},get:function(){return this._minSizePx}},{key:"useRealWorldSymbolSizes",set:function(e){this._useRealWorldSymbolSizes!==e&&(this._useRealWorldSymbolSizes=e,this._requestRender())},get:function(){return this._useRealWorldSymbolSizes}},{key:"size",set:function(e){this._size!==e&&(this._size=e,this._requestRender())},get:function(){return this._size}},{key:"sizePx",set:function(e){this._sizePx!==e&&(this._sizePx=e,this._requestRender())},get:function(){return this._sizePx}},{key:"clippingBox",set:function(e){c.set(this._clipBox,e||c.POSITIVE_INFINITY)}},{key:"slicePlane",get:function(){return this._slicePlaneEnabled},set:function(e){this._slicePlaneEnabled!==e&&(this._slicePlaneEnabled=e,this._requestRender())}},{key:"intersectionHandlerId",get:function(){return this.layerUid}}]),e}(),(e.PointRenderer||(e.PointRenderer={})).isInstanceOfNode=function(e){return e.hasOwnProperty("splatSize")},Object.defineProperty(e,"__esModule",{value:!0})}));
