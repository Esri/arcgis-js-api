/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{isSome as e,isNone as i,unwrap as t,disposeMaybe as s}from"../../../../core/maybe.js";import n from"../../../../core/PooledArray.js";import{f as r,m as o}from"../../../../chunks/mat4.js";import{c as h}from"../../../../chunks/mat4f32.js";import{b as a,l,g as c,o as d,e as u,p as m,s as g}from"../../../../chunks/vec3.js";import{c as p}from"../../../../chunks/vec3f32.js";import{c as f}from"../../../../chunks/vec3f64.js";import{s as _}from"../../../../chunks/vec4.js";import{create as S,POSITIVE_INFINITY as x,offset as z,contains as b,containsPoint as P,equals as w,set as R}from"../../../../geometry/support/aaBoundingBox.js";import{create as A}from"../../../../geometry/support/plane.js";import{fromPoints as q}from"../../../../geometry/support/ray.js";import{PointHighlights as y}from"./PointHighlights.js";import{minimumDistancePlane as j,maximumDistancePlane as M,intersectLine as I,toAaBoundingBox as v}from"../../support/orientedBoundingBox.js";import{ShaderOutput as H}from"../../webgl-engine/core/shaderLibrary/ShaderOutputOptions.js";import{SlicePlaneParameters as T}from"../../webgl-engine/core/shaderLibrary/Slice.glsl.js";import{NoParameters as L}from"../../webgl-engine/core/shaderModules/interfaces.js";import{Default3D as F}from"../../webgl-engine/lib/DefaultVertexAttributeLocations.js";import{newIntersectorResult as E}from"../../webgl-engine/lib/Intersector.js";import{IntersectorType as V,StoreResults as O}from"../../webgl-engine/lib/IntersectorInterfaces.js";import{RenderPass as U}from"../../webgl-engine/lib/RenderPass.js";import{VertexAttribute as N}from"../../webgl-engine/lib/VertexAttribute.js";import{PointRendererTechnique as C}from"../../webgl-engine/shaders/PointRendererTechnique.js";import{PointRendererTechniqueConfiguration as B}from"../../webgl-engine/shaders/PointRendererTechniqueConfiguration.js";import{BufferObject as D}from"../../../webgl/BufferObject.js";import{DataType as W,PrimitiveType as G,Usage as k}from"../../../webgl/enums.js";import{VertexArrayObject as Y}from"../../../webgl/VertexArrayObject.js";import{VertexElementDescriptor as J}from"../../../webgl/VertexElementDescriptor.js";const K={positions:[new J(N.POSITION,3,W.FLOAT,0,12)],colors:[new J(N.COLOR,3,W.UNSIGNED_BYTE,0,3,!0)]};class Q{constructor(e){this._params=e,this.type=V.PCL,this.isGround=!1,this._highlights=new y({forEachNode:e=>this.forEachNode(e),addHighlight:(e,i,t)=>this._addHighlight(e,i,t),removeHighlight:(e,i)=>this._removeHighlight(e,i)}),this.canRender=!0,this.layerUid="",this._useFixedSizes=!1,this._scaleFactor=1,this._minSizePx=0,this._useRealWorldSymbolSizes=!1,this._size=0,this._sizePx=0,this._slicePlaneEnabled=!1,this._clipBox=S(x),this._techniqueConfig=new B,this.tempMatrix4=h(),this.tempVec3=p(),this.nodes=new n}get needsHighlight(){return this._highlights.hasHighlights}initializeRenderContext(e){this._context=e,this._techniqueRep=this._context.shaderTechniqueRepository,e.requestRender()}uninitializeRenderContext(){}intersect(e,i,t,s){const n=f(),r=f(),o=f(),h=f(),g=A(),p=e.camera.perScreenPixelRatio/2,x=e.camera.near,w=this._getSizeParams();a(r,s,t);const R=1/l(r);c(r,r,R),d(o,r),_(g,r[0],r[1],r[2],-u(r,t));const y=new re,H=new re,T=new Array,L=S(),F=S(this._clipBox);z(F,-t[0],-t[1],-t[2],F),this.nodes.forAll((l=>{const c=l.splatSize*this._scaleFactor;let d=j(l.obb,g),f=M(l.obb,g);d-=ee(c,d+x,w,p,l.isLeaf),f-=ee(c,f+x,w,p,l.isLeaf);const _=f<0,S=null!=y.dist&&null!=H.dist&&y.dist<d*R&&H.dist>f*R;if(_||S)return;const A=$(c,f+x,w,p,l.isLeaf);if(!I(l.obb,t,r,A))return;const q=A*A;v(l.obb,L),z(L,-t[0],-t[1],-t[2],L);const E=!b(F,L);a(h,l.origin,t);const V=l.coordinates.length/3;for(let a=0;a<V;a++){if(n[0]=h[0]+l.coordinates[3*a],n[1]=h[1]+l.coordinates[3*a+1],n[2]=h[2]+l.coordinates[3*a+2],E&&!P(F,n))continue;const d=u(n,r),g=m(n)-d*d;if(g>q)continue;let f=d+x;const _=ee(c,f,w,p,l.isLeaf);if(d-_<0)continue;f-=_;const S=$(c,f,w,p,l.isLeaf);if(g>S*S)continue;const z=(d-_)*R,b=e=>(e.point=ie(l,a,e.point),e.dist=z,e.normal=o,e.node=l,e.pointId=a,e.layerUid=this.layerUid,e);if((null==y.dist||z<y.dist)&&(null==i||i(t,s,z))&&b(y),e.options.store!==O.MIN&&(null==H.dist||z>H.dist)&&(null==i||i(t,s,z))&&b(H),e.options.store===O.ALL&&(null==i||i(t,s,z))){const e=new re;T.push(b(e))}}}));const V=e=>{const{layerUid:i,node:t,pointId:s}=e;return{point:e.point,layerUid:i,graphicUid:s,createGraphic:()=>this._params.createGraphic(t,s,e.point)}},U=(e,i)=>{const t=V(i);e.set(this.type,t,i.dist,i.normal)};if(oe(y)){const i=e.results.min;(null==i.dist||y.dist<i.dist)&&U(i,y)}if(oe(H)&&e.options.store!==O.MIN){const i=e.results.max;(null==i.dist||H.dist>i.dist)&&U(i,H)}if(e.options.store===O.ALL){const i=q(t,s);for(const t of T){const s=E(i);U(s,t),e.results.all.push(s)}}}prepareTechnique(e){if(0===this.nodes.length||e.pass!==U.MATERIAL&&e.pass!==U.MATERIAL_DEPTH&&e.pass!==U.MATERIAL_HIGHLIGHT)return null;this.nodes.forAll((i=>{null==i.vao&&this._initNode(e,i)}));const i=this._getSizeParams();return this._techniqueConfig.drawScreenSize=i.drawScreenSpace,this._techniqueConfig.hasSlicePlane=this._slicePlaneEnabled,this._techniqueConfig.hasOccludees=e.bindParameters.hasOccludees,this._techniqueConfig.output=e.pass===U.MATERIAL_DEPTH?H.Depth:e.pass===U.MATERIAL_HIGHLIGHT?H.Highlight:H.Color,this._techniqueRep.releaseAndAcquire(C,this._techniqueConfig,this._technique)}render(e,i){const t=e.rctx,s=t.bindTechnique(i,he,e.bindParameters),n=e.bindParameters.camera,h=this._clipBox,a=!w(h,x,((e,i)=>e===i));a||(g(this.tempVec3,-1/0,-1/0,-1/0),s.setUniform3fv("clipMin",this.tempVec3),g(this.tempVec3,1/0,1/0,1/0),s.setUniform3fv("clipMax",this.tempVec3));const l=this._getSizeParams(),c=n.pixelRatio;l.drawFixedSize&&s.setUniform2f("pointScale",l.fixedSize*c,n.fullHeight),this.nodes.forAll((d=>{if(0===d.coordinates.length||e.isHighlightPass&&!d.highlights)return;if(s.setUniform2f("screenMinMaxSize",l.screenMinSize*c,Z(d.isLeaf)*c),!l.drawFixedSize){const e=d.splatSize*this._scaleFactor;s.setUniform2f("pointScale",e*c,n.fullHeight/c)}const u=d.origin;a&&(g(this.tempVec3,h[0]-u[0],h[1]-u[1],h[2]-u[2]),s.setUniform3fv("clipMin",this.tempVec3),g(this.tempVec3,h[3]-u[0],h[4]-u[1],h[5]-u[2]),s.setUniform3fv("clipMax",this.tempVec3)),r(this.tempMatrix4,u),o(this.tempMatrix4,n.viewMatrix,this.tempMatrix4),s.setUniformMatrix4fv("modelView",this.tempMatrix4),i.bindDraw(new T(u),e.bindParameters),t.bindVAO(d.vao),e.isHighlightPass?this._renderHighlightFragments(t,d):t.drawArrays(G.POINTS,0,d.coordinates.length/3)}))}_renderHighlightFragments(e,s){const n=s.highlights;if(i(n))return;let r=t(n[0].component),o=r+1;for(let i=1;i<n.length;i++){const s=t(n[i].component);if(s!==o){const i=o-r;i>0&&e.drawArrays(G.POINTS,r,i),r=s}o=s+1}const h=o-r;h>0&&e.drawArrays(G.POINTS,r,h)}set useFixedSizes(e){this._useFixedSizes!==e&&(this._useFixedSizes=e,this._requestRender())}get useFixedSizes(){return this._useFixedSizes}set scaleFactor(e){this._scaleFactor!==e&&(this._scaleFactor=e,this._requestRender())}get scaleFactor(){return this._scaleFactor}set minSizePx(e){this._minSizePx!==e&&(this._minSizePx=e,this._requestRender())}get minSizePx(){return this._minSizePx}set useRealWorldSymbolSizes(e){this._useRealWorldSymbolSizes!==e&&(this._useRealWorldSymbolSizes=e,this._requestRender())}get useRealWorldSymbolSizes(){return this._useRealWorldSymbolSizes}set size(e){this._size!==e&&(this._size=e,this._requestRender())}get size(){return this._size}set sizePx(e){this._sizePx!==e&&(this._sizePx=e,this._requestRender())}get sizePx(){return this._sizePx}set clippingBox(e){R(this._clipBox,e||x)}get slicePlaneEnabled(){return this._slicePlaneEnabled}set slicePlaneEnabled(e){this._slicePlaneEnabled!==e&&(this._slicePlaneEnabled=e,this._requestRender())}addNode(e){this.nodes.push(e),this._highlights.nodeAdded(e),this._requestRender()}removeNode(e){let i=null;return this.nodes.filterInPlace((t=>t.id!==e||(i=t,t.vao=s(t.vao),this._highlights.nodeRemoved(t),!1))),this._requestRender(),i}forEachNode(e){this.nodes.forAll(e)}removeAll(){this.nodes.forAll((e=>e.vao=s(e.vao))),this._highlights.removeAll(),this.nodes.clear(),this._requestRender()}highlight(e){return this._highlights.add(e)}_addHighlight(e,i,t){e.highlights=se(e.highlights,i,t),this._requestRender()}_removeHighlight(e,i){e.highlights=ne(e.highlights,i),this._requestRender()}_initNode(e,i){const t=e.rctx;i.vao=new Y(t,F,K,{positions:D.createVertex(t,k.STATIC_DRAW,i.coordinates),colors:D.createVertex(t,k.STATIC_DRAW,i.rgb)})}_requestRender(){this._context&&this._context.requestRender()}_getSizeParams(){const e=this._useFixedSizes,i=e&&!this._useRealWorldSymbolSizes;return{drawScreenSpace:i,drawFixedSize:e,fixedSize:i?this._sizePx:this._size,screenMinSize:e?0:this._minSizePx}}}function X(e){return e.hasOwnProperty("splatSize")}function Z(e){return e?256:64}function $(e,i,t,s,n){if(t.drawScreenSpace)return t.fixedSize*i*s;const r=Z(n)*i*s;return t.drawFixedSize?Math.min(t.fixedSize/2,r):t.screenMinSize>0?Math.min(Math.max(t.screenMinSize*i*s,e/2),r):Math.min(e/2,r)}function ee(e,i,t,s,n){return t.drawScreenSpace?0:$(e,i,t,s,n)}function ie(e,t,s){return i(s)&&(s=f()),s[0]=e.origin[0]+e.coordinates[3*t],s[1]=e.origin[1]+e.coordinates[3*t+1],s[2]=e.origin[2]+e.coordinates[3*t+2],s}function te(i){return e(i.component)?i.component:-1}function se(e,t,s){i(e)&&(e=[]);const n={component:t,id:s};e.push(n);const r=te(n);let o=e.length-1;for(;o>0&&r<te(e[o-1]);)[e[o-1],e[o]]=[e[o],e[o-1]],--o;return e}function ne(e,t){if(i(e))return e;const s=e.filter((e=>e.id!==t));return 0===s.length?null:s}class re{constructor(){this.node=null,this.pointId=null,this.point=null,this.dist=null,this.normal=null,this.layerUid=""}}function oe(i){return e(i.dist)&&e(i.point)&&e(i.pointId)&&e(i.node)}const he=new L;export{Q as PointRenderer,X as isInstanceOfNode};
