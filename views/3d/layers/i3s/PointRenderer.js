/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/PooledArray","../../../../chunks/mat4","../../../../chunks/mat4f32","../../../../chunks/vec3","../../../../chunks/vec3f32","../../../../chunks/vec3f64","../../../../chunks/vec4","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/plane","../../../../geometry/support/ray","./PointHighlights","../../support/orientedBoundingBox","../../webgl-engine/core/shaderLibrary/Slice.glsl","../../webgl-engine/core/shaderLibrary/output/OutputHighlight.glsl","../../webgl-engine/lib/DefaultVertexAttributeLocations","../../webgl-engine/lib/Intersector","../../webgl-engine/shaders/PointRendererTechnique","../../../webgl/BufferObject","../../../webgl/VertexArrayObject"],(function(e,t,i,n,s,r,o,a,c,h,l,u,d,f,g,p,m,_,x,S,P,z){"use strict";const b={positions:[{name:"position",count:3,type:5126,offset:0,stride:12,normalized:!1}],colors:[{name:"color",count:3,type:5121,offset:0,stride:3,normalized:!0}]};function y(e){return e?256:64}function w(e,t,i,n,s){if(i.drawScreenSpace)return i.fixedSize*t*n;const r=y(s)*t*n;return i.drawFixedSize?Math.min(i.fixedSize/2,r):i.screenMinSize>0?Math.min(Math.max(i.screenMinSize*t*n,e/2),r):Math.min(e/2,r)}function R(e,t,i,n,s){return i.drawScreenSpace?0:w(e,t,i,n,s)}function q(e,t,i){return null==i&&(i=c.create()),i[0]=e.origin[0]+e.coordinates[3*t],i[1]=e.origin[1]+e.coordinates[3*t+1],i[2]=e.origin[2]+e.coordinates[3*t+2],i}function M(e){return i.isSome(e.component)?e.component:-1}function v(e,t,n){i.isNone(e)&&(e=[]);const s={component:t,id:n};e.push(s);const r=M(s);let o=e.length-1;for(;o>0&&r<M(e[o-1]);)[e[o-1],e[o]]=[e[o],e[o-1]],--o;return e}function F(e,t){if(i.isNone(e))return e;const n=e.filter((e=>e.id!==t));return 0===n.length?null:n}e.PointRenderer=function(){function e(e){this._params=e,this.type=5,this.isGround=!1,this._bindParameters={inverseViewport:[0,0],highlightDepthTexture:null},this._highlights=new f.PointHighlights({forEachNode:e=>this.forEachNode(e),addHighlight:(e,t,i)=>this.addHighlight(e,t,i),removeHighlight:(e,t)=>this.removeHighlight(e,t)}),this.canRender=!0,this.layerUid="",this._useFixedSizes=!1,this._scaleFactor=1,this._minSizePx=0,this._useRealWorldSymbolSizes=!1,this._size=0,this._sizePx=0,this._slicePlaneEnabled=!1,this._clipBox=l.create(l.POSITIVE_INFINITY),this._techniqueConfig=new S.PointRendererTechniqueConfiguration,this.tempMatrix4=r.create(),this.tempVec3=a.create(),this.nodes=new n}var M=e.prototype;return M.initializeRenderContext=function(e){this._context=e,this._techniqueRep=this._context.shaderTechniqueRep,e.requestRender()},M.uninitializeRenderContext=function(){},M.intersect=function(e,t,i,n){const s=c.create(),r=c.create(),a=c.create(),f=c.create(),p=u.create(),m=e.camera.perScreenPixelRatio/2,_=e.camera.near,S=this._getSizeParams();o.subtract(r,n,i);const P=1/o.length(r);o.scale(r,r,P),o.negate(a,r),h.set(p,r[0],r[1],r[2],-o.dot(r,i));let z=function(){this.node=null,this.pointId=null,this.point=null,this.dist=null,this.normal=null,this.layerUid=""};const b=new z,y=new z,M=[],v=l.create(),F=l.create(this._clipBox);l.offset(F,-i[0],-i[1],-i[2],F),this.nodes.forAll((c=>{const h=c.splatSize*this._scaleFactor;let u=g.minimumDistancePlane(c.obb,p),d=g.maximumDistancePlane(c.obb,p);u-=R(h,u+_,S,m,c.isLeaf),d-=R(h,d+_,S,m,c.isLeaf);const x=d<0,H=null!=b.dist&&null!=y.dist&&b.dist<u*P&&y.dist>d*P;if(x||H)return;const V=w(h,d+_,S,m,c.isLeaf);if(!g.intersectLine(c.obb,i,r,V))return;const I=V*V;g.toAaBoundingBox(c.obb,v),l.offset(v,-i[0],-i[1],-i[2],v);const A=!l.contains(F,v);o.subtract(f,c.origin,i);const U=c.coordinates.length/3;for(let g=0;g<U;g++){if(s[0]=f[0]+c.coordinates[3*g],s[1]=f[1]+c.coordinates[3*g+1],s[2]=f[2]+c.coordinates[3*g+2],A&&!l.containsPoint(F,s))continue;const u=o.dot(s,r),d=o.squaredLength(s)-u*u;if(d>I)continue;let p=u+_;const x=R(h,p,S,m,c.isLeaf);if(u-x<0)continue;p-=x;const v=w(h,p,S,m,c.isLeaf);if(d>v*v)continue;const H=(u-x)*P,V=e=>{e.point=q(c,g,e.point),e.dist=H,e.normal=a,e.node=c,e.pointId=g,e.layerUid=this.layerUid};if((null==b.dist||H<b.dist)&&(null==t||t(i,n,H))&&V(b),0!==e.options.store&&(null==y.dist||H>y.dist)&&(null==t||t(i,n,H))&&V(y),2===e.options.store&&(null==t||t(i,n,H))){const e=new z;V(e),M.push(e)}}}));const H=e=>{const{layerUid:t,node:i,pointId:n}=e;return{point:e.point,layerUid:t,graphicUid:n,createGraphic:()=>this._params.createGraphic(i,n,e.point)}},V=(e,t)=>{const i=H(t);e.set(this.type,i,t.dist,t.normal)};if(null!=b.dist){const t=e.results.min;(null==t.dist||b.dist<t.dist)&&V(t,b)}if(null!=y.dist&&0!==e.options.store){const t=e.results.max;(null==t.dist||y.dist>t.dist)&&V(t,y)}if(2===e.options.store){const t=d.fromPoints(i,n);for(const i of M){const n=x.newIntersectorResult(t);V(n,i),e.results.all.push(n)}}},M.render=function(e){if(0===this.nodes.length||0!==e.pass&&2!==e.pass&&5!==e.pass)return!1;const t=this._getSizeParams(),i=this.selectTechnique(e,t),n=i.program;if(null==n)return!1;this.nodes.forAll((t=>{null==t.vao&&this._initNode(e,t)}));const r=e.rctx;r.useProgram(n),i.bindPipelineState(r);const a=this._clipBox,c=!l.equals(a,l.POSITIVE_INFINITY,((e,t)=>e===t));c||(o.set(this.tempVec3,-1/0,-1/0,-1/0),n.setUniform3fv("uClipMin",this.tempVec3),o.set(this.tempVec3,1/0,1/0,1/0),n.setUniform3fv("uClipMax",this.tempVec3)),n.setUniformMatrix4fv("uProjectionMatrix",e.camera.projectionMatrix);2===e.pass&&n.setUniform2f("nearFar",e.camera.near,e.camera.far),e.isHighlightPass&&(this._bindParameters.inverseViewport[0]=1/e.camera.fullViewport[2],this._bindParameters.inverseViewport[1]=1/e.camera.fullViewport[3],this._bindParameters.highlightDepthTexture=e.highlightDepthTexture,m.bindOutputHighlight(n,this._bindParameters));const h=e.camera.pixelRatio;t.drawFixedSize&&n.setUniform2f("uPointScale",t.fixedSize*h,e.camera.fullHeight);const u=this._slicePlaneEnabled?e.sliceHelper&&e.sliceHelper.plane:null;return this.nodes.forAll((l=>{if(0===l.coordinates.length||e.isHighlightPass&&!l.highlights)return;if(n.setUniform2f("uScreenMinMaxSize",t.screenMinSize*h,y(l.isLeaf)*h),!t.drawFixedSize){const t=l.splatSize*this._scaleFactor;n.setUniform2f("uPointScale",t*h,e.camera.fullHeight/h)}const d=l.origin;c&&(o.set(this.tempVec3,a[0]-d[0],a[1]-d[1],a[2]-d[2]),n.setUniform3fv("uClipMin",this.tempVec3),o.set(this.tempVec3,a[3]-d[0],a[4]-d[1],a[5]-d[2]),n.setUniform3fv("uClipMax",this.tempVec3)),s.identity(this.tempMatrix4),s.translate(this.tempMatrix4,this.tempMatrix4,d),s.multiply(this.tempMatrix4,e.camera.viewMatrix,this.tempMatrix4),n.setUniformMatrix4fv("uModelViewMatrix",this.tempMatrix4),p.bindSliceUniforms(n,i.configuration,u,d),r.bindVAO(l.vao),e.isHighlightPass?this._renderHighlightFragments(r,l):r.drawArrays(0,0,l.coordinates.length/3)})),!0},M._renderHighlightFragments=function(e,t){const n=t.highlights;if(i.isNone(n))return;let s=i.unwrap(n[0].component),r=s+1;for(let a=1;a<n.length;a++){const t=i.unwrap(n[a].component);if(t!==r){const i=r-s;i>0&&e.drawArrays(0,s,i),s=t}r=t+1}const o=r-s;o>0&&e.drawArrays(0,s,o)},M.addNode=function(e){this.nodes.push(e),this._highlights.nodeAdded(e),this._requestRender()},M.removeNode=function(e){let t=null;return this.nodes.filterInPlace((n=>n.id!==e||(t=n,n.vao=i.disposeMaybe(n.vao),this._highlights.nodeRemoved(n),!1))),this._requestRender(),t},M.forEachNode=function(e){this.nodes.forAll(e)},M.removeAll=function(){this.nodes.forAll((e=>e.vao=i.disposeMaybe(e.vao))),this._highlights.removeAll(),this.nodes.clear(),this._requestRender()},M.highlight=function(e){return this._highlights.add(e)},M.addHighlight=function(e,t,i){e.highlights=v(e.highlights,t,i),this._requestRender()},M.removeHighlight=function(e,t){e.highlights=F(e.highlights,t),this._requestRender()},M._initNode=function(e,t){const i=e.rctx;t.vao=new z(i,_.Default3D,b,{positions:P.createVertex(i,35044,t.coordinates),colors:P.createVertex(i,35044,t.rgb)})},M._requestRender=function(){this._context&&this._context.requestRender()},M._getSizeParams=function(){const e=this._useFixedSizes,t=e&&!this._useRealWorldSymbolSizes;return{drawScreenSpace:t,drawFixedSize:e,fixedSize:t?this._sizePx:this._size,screenMinSize:e?0:this._minSizePx}},M.selectTechnique=function(e,t){return this._techniqueConfig.drawScreenSize=t.drawScreenSpace,this._techniqueConfig.slicePlaneEnabled=this._slicePlaneEnabled,this._techniqueConfig.sceneHasOcludees=e.hasOccludees,this._techniqueConfig.output=2===e.pass?1:5===e.pass?4:0,this._techniqueRep.releaseAndAcquire(S.PointRendererTechnique,this._techniqueConfig,this._technique)},t._createClass(e,[{key:"needsHighlight",get:function(){return this._highlights.hasHighlights}},{key:"useFixedSizes",get:function(){return this._useFixedSizes},set:function(e){this._useFixedSizes!==e&&(this._useFixedSizes=e,this._requestRender())}},{key:"scaleFactor",get:function(){return this._scaleFactor},set:function(e){this._scaleFactor!==e&&(this._scaleFactor=e,this._requestRender())}},{key:"minSizePx",get:function(){return this._minSizePx},set:function(e){this._minSizePx!==e&&(this._minSizePx=e,this._requestRender())}},{key:"useRealWorldSymbolSizes",get:function(){return this._useRealWorldSymbolSizes},set:function(e){this._useRealWorldSymbolSizes!==e&&(this._useRealWorldSymbolSizes=e,this._requestRender())}},{key:"size",get:function(){return this._size},set:function(e){this._size!==e&&(this._size=e,this._requestRender())}},{key:"sizePx",get:function(){return this._sizePx},set:function(e){this._sizePx!==e&&(this._sizePx=e,this._requestRender())}},{key:"clippingBox",set:function(e){l.set(this._clipBox,e||l.POSITIVE_INFINITY)}},{key:"slicePlaneEnabled",get:function(){return this._slicePlaneEnabled},set:function(e){this._slicePlaneEnabled!==e&&(this._slicePlaneEnabled=e,this._requestRender())}}]),e}(),function(e){function t(e){return e.hasOwnProperty("splatSize")}e.isInstanceOfNode=t}(e.PointRenderer||(e.PointRenderer={})),Object.defineProperty(e,"__esModule",{value:!0})}));
