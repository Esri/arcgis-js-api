/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/PooledArray","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../chunks/vec4","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/plane","../../../../geometry/support/ray","./PointHighlights","../../support/orientedBoundingBox","../../webgl-engine/core/shaderLibrary/ShaderOutput","../../webgl-engine/lib/DefaultVertexAttributeLocations","../../webgl-engine/lib/Intersector","../../webgl-engine/lib/IntersectorInterfaces","../../webgl-engine/lib/VertexArrayObject","../../webgl-engine/lib/VertexAttribute","../../../../chunks/PointRenderer.glsl","../../webgl-engine/shaders/PointRendererTechnique","../../webgl-engine/shaders/PointRendererTechniqueConfiguration","../../../webgl/BufferObject","../../../webgl/enums","../../../webgl/VertexElementDescriptor"],(function(e,t,i,s,n,r,o,a,h,u,c,l,d,p,g,f,_,m,P,S,b,x,y,R){"use strict";const q={positions:[new R.VertexElementDescriptor(m.VertexAttribute.POSITION,3,y.DataType.FLOAT,0,12)],colors:[new R.VertexElementDescriptor(m.VertexAttribute.COLOR,3,y.DataType.UNSIGNED_BYTE,0,3,!0)]};let w=function(){function e(e){this._params=e,this.type=f.IntersectorType.PCL,this.isGround=!1,this._passParameters=new P.PointRendererPassParameters,this._highlights=new c.PointHighlights({forEachNode:e=>this.forEachNode(e),addHighlight:(e,t,i)=>this._addHighlight(e,t,i),removeHighlight:(e,t)=>this._removeHighlight(e,t)}),this.canRender=!0,this.layerUid="",this._slicePlaneEnabled=!1,this._techniqueConfig=new b.PointRendererTechniqueConfiguration,this._nodes=new s}var m=e.prototype;return m.initializeRenderContext=function(e){this._context=e,this._techniqueRep=this._context.shaderTechniqueRepository,e.requestRender()},m.uninitializeRenderContext=function(){},m.intersect=function(e,t,i,s){const c=r.create(),d=r.create(),p=r.create(),_=r.create(),m=h.create(),P=e.camera.perScreenPixelRatio/2,S=e.camera.near;n.subtract(d,s,i);const b=1/n.length(d);n.scale(d,d,b),n.negate(p,d),o.set(m,d[0],d[1],d[2],-n.dot(d,i));const x=new E,y=new E,R=new Array,q=a.create(),w=a.create(this._passParameters.clipBox);a.offset(w,-i[0],-i[1],-i[2],w),this._nodes.forAll((r=>{const o=r.splatSize*this._passParameters.scaleFactor;let h=l.minimumDistancePlane(r.obb,m),u=l.maximumDistancePlane(r.obb,m);h-=A(o,h+S,this._passParameters,P,r.isLeaf),u-=A(o,u+S,this._passParameters,P,r.isLeaf);const g=u<0,z=null!=x.dist&&null!=y.dist&&x.dist<h*b&&y.dist>u*b;if(g||z)return;const I=O(o,u+S,this._passParameters,P,r.isLeaf);if(!l.intersectLine(r.obb,i,d,I))return;const N=I*I;l.toAaBoundingBox(r.obb,q),a.offset(q,-i[0],-i[1],-i[2],q);const v=!a.contains(w,q);n.subtract(_,r.origin,i);const C=r.coordinates.length/3;for(let l=0;l<C;l++){if(c[0]=_[0]+r.coordinates[3*l],c[1]=_[1]+r.coordinates[3*l+1],c[2]=_[2]+r.coordinates[3*l+2],v&&!a.containsPoint(w,c))continue;const h=n.dot(c,d),u=n.squaredLength(c)-h*h;if(u>N)continue;let g=h+S;const m=A(o,g,this._passParameters,P,r.isLeaf);if(h-m<0)continue;g-=m;const q=O(o,g,this._passParameters,P,r.isLeaf);if(u>q*q)continue;const z=(h-m)*b,I=e=>(e.point=T(r,l,e.point),e.dist=z,e.normal=p,e.node=r,e.pointId=l,e.layerUid=this.layerUid,e);if((null==x.dist||z<x.dist)&&(null==t||t(i,s,z))&&I(x),e.options.store!==f.StoreResults.MIN&&(null==y.dist||z>y.dist)&&(null==t||t(i,s,z))&&I(y),e.options.store===f.StoreResults.ALL&&(null==t||t(i,s,z))){const e=new E;R.push(I(e))}}}));const z=e=>{const{layerUid:t,node:i,pointId:s}=e;return{point:e.point,layerUid:t,graphicUid:s,createGraphic:()=>this._params.createGraphic(i,s,e.point)}},I=(e,t)=>{const i=z(t);e.set(this.type,i,t.dist,t.normal)};if(D(x)){const t=e.results.min;(null==t.dist||x.dist<t.dist)&&I(t,x)}if(D(y)&&e.options.store!==f.StoreResults.MIN){const t=e.results.max;(null==t.dist||y.dist>t.dist)&&I(t,y)}if(e.options.store===f.StoreResults.ALL){const t=u.fromPoints(i,s);for(const i of R){const s=g.newIntersectorResult(t);I(s,i),e.results.all.push(s)}}},m.prepareTechnique=function(e){return 0===this._nodes.length||e.output!==d.ShaderOutput.Color&&e.output!==d.ShaderOutput.Depth&&e.output!==d.ShaderOutput.Highlight?null:(this._nodes.forAll((t=>{null==t.vao&&this._initNode(e,t)})),this._techniqueConfig.drawScreenSize=this._passParameters.drawScreenSpace,this._techniqueConfig.useFixedSizes=this._passParameters.useFixedSizes,this._techniqueConfig.hasSlicePlane=this._slicePlaneEnabled,this._techniqueConfig.hasOccludees=e.bindParameters.hasOccludees,this._techniqueConfig.clippingEnabled=this._clippingEnabled,this._techniqueConfig.output=e.output===d.ShaderOutput.Depth?d.ShaderOutput.Depth:e.output===d.ShaderOutput.Highlight?d.ShaderOutput.Highlight:d.ShaderOutput.Color,this._techniqueRep.releaseAndAcquire(S.PointRendererTechnique,this._techniqueConfig,this._technique))},m.render=function(e,t){const i=e.rctx,s=i.bindTechnique(t,this._passParameters,e.bindParameters),n=e.output===d.ShaderOutput.Highlight;this._nodes.forAll((t=>{0===t.coordinates.length||n&&!t.highlights||(s.bindDraw(t,e.bindParameters,this._passParameters),i.bindVAO(t.vao),n?this._renderHighlightFragments(i,t):i.drawArrays(y.PrimitiveType.POINTS,0,t.coordinates.length/3))}))},m._renderHighlightFragments=function(e,t){const s=t.highlights;if(i.isNone(s))return;let n=i.unwrap(s[0].component),r=n+1;for(let a=1;a<s.length;a++){const t=i.unwrap(s[a].component);if(t!==r){const i=r-n;i>0&&e.drawArrays(y.PrimitiveType.POINTS,n,i),n=t}r=t+1}const o=r-n;o>0&&e.drawArrays(y.PrimitiveType.POINTS,n,o)},m.addNode=function(e){this._nodes.push(e),this._highlights.nodeAdded(e),this._requestRender()},m.removeNode=function(e){let t=null;return this._nodes.filterInPlace((s=>s.id!==e||(t=s,s.vao=i.disposeMaybe(s.vao),this._highlights.nodeRemoved(s),!1))),this._requestRender(),t},m.forEachNode=function(e){this._nodes.forAll(e)},m.removeAll=function(){this._nodes.forAll((e=>e.vao=i.disposeMaybe(e.vao))),this._highlights.removeAll(),this._nodes.clear(),this._requestRender()},m.highlight=function(e){return this._highlights.add(e)},m._addHighlight=function(e,t,i){e.highlights=v(e.highlights,t,i),this._requestRender()},m._removeHighlight=function(e,t){e.highlights=C(e.highlights,t),this._requestRender()},m._initNode=function(e,t){const i=e.rctx;t.vao=new _.VertexArrayObject(i,p.Default3D,q,{positions:x.BufferObject.createVertex(i,y.Usage.STATIC_DRAW,t.coordinates),colors:x.BufferObject.createVertex(i,y.Usage.STATIC_DRAW,t.rgb)})},m._requestRender=function(){this._context&&this._context.requestRender()},t._createClass(e,[{key:"needsHighlight",get:function(){return this._highlights.hasHighlights}},{key:"useFixedSizes",get:function(){return this._passParameters.useFixedSizes},set:function(e){this._passParameters.useFixedSizes!==e&&(this._passParameters.useFixedSizes=e,this._requestRender())}},{key:"scaleFactor",get:function(){return this._passParameters.scaleFactor},set:function(e){this._passParameters.scaleFactor!==e&&(this._passParameters.scaleFactor=e,this._requestRender())}},{key:"minSizePx",get:function(){return this._passParameters.minSizePx},set:function(e){this._passParameters.minSizePx!==e&&(this._passParameters.minSizePx=e,this._requestRender())}},{key:"useRealWorldSymbolSizes",get:function(){return this._passParameters.useRealWorldSymbolSizes},set:function(e){this._passParameters.useRealWorldSymbolSizes!==e&&(this._passParameters.useRealWorldSymbolSizes=e,this._requestRender())}},{key:"size",get:function(){return this._passParameters.size},set:function(e){this._passParameters.size!==e&&(this._passParameters.size=e,this._requestRender())}},{key:"sizePx",get:function(){return this._passParameters.sizePx},set:function(e){this._passParameters.sizePx!==e&&(this._passParameters.sizePx=e,this._requestRender())}},{key:"clippingBox",set:function(e){a.set(this._passParameters.clipBox,e||a.POSITIVE_INFINITY)}},{key:"_clippingEnabled",get:function(){return!a.equals(this._passParameters.clipBox,a.POSITIVE_INFINITY,((e,t)=>e===t))}},{key:"slicePlaneEnabled",get:function(){return this._slicePlaneEnabled},set:function(e){this._slicePlaneEnabled!==e&&(this._slicePlaneEnabled=e,this._requestRender())}}]),e}(),z=function(e){function i(t,i,s,n,r,o,a,h,u=null,c=null){var l;return(l=e.call(this,s,r,i)||this).id=t,l.obb=n,l.coordinates=o,l.rgb=a,l.attributes=h,l.pointIdFilterMap=u,l.highlights=c,l}return t._inheritsLoose(i,e),i}(P.PointRendererDrawParameters);function I(e){return e.hasOwnProperty("splatSize")}function O(e,t,i,s,n){if(i.drawScreenSpace)return i.fixedSize*t*s;const r=P.getMaxPointSizeScreenspace(n)*t*s;return i.useFixedSizes?Math.min(i.fixedSize/2,r):i.screenMinSize>0?Math.min(Math.max(i.screenMinSize*t*s,e/2),r):Math.min(e/2,r)}function A(e,t,i,s,n){return i.drawScreenSpace?0:O(e,t,i,s,n)}function T(e,t,s){return i.isNone(s)&&(s=r.create()),s[0]=e.origin[0]+e.coordinates[3*t],s[1]=e.origin[1]+e.coordinates[3*t+1],s[2]=e.origin[2]+e.coordinates[3*t+2],s}function N(e){return i.isSome(e.component)?e.component:-1}function v(e,t,s){i.isNone(e)&&(e=[]);const n={component:t,id:s};e.push(n);const r=N(n);let o=e.length-1;for(;o>0&&r<N(e[o-1]);)[e[o-1],e[o]]=[e[o],e[o-1]],--o;return e}function C(e,t){if(i.isNone(e))return e;const s=e.filter((e=>e.id!==t));return 0===s.length?null:s}let E=function(){this.node=null,this.pointId=null,this.point=null,this.dist=null,this.normal=null,this.layerUid=""};function D(e){return i.isSome(e.dist)&&i.isSome(e.point)&&i.isSome(e.pointId)&&i.isSome(e.node)}e.PointRenderer=w,e.PointRendererNode=z,e.isInstanceOfNode=I,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
