// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","../../../../core/maybe","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f32","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f32","../../../../core/libs/gl-matrix-2/vec3f64","../../../../core/libs/gl-matrix-2/vec4","../../../../geometry/support/aaBoundingBox","./PointHighlights","../../support/geometryUtils","../../support/geometryUtils","../../support/orientedBoundingBox","../../webgl-engine/core/shaderLibrary/Slice.glsl","../../webgl-engine/core/shaderLibrary/output/OutputHighlight.glsl","../../webgl-engine/lib/DefaultVertexAttributeLocations","../../webgl-engine/lib/intersectorUtils","../../webgl-engine/shaders/PointRendererTechnique","../../../webgl/BufferObject","../../../webgl/VertexArrayObject"],(function(e,t,i,n,r,s,o,a,l,c,h,u,d,f,p,g,m,v,_,b,x,y){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PointRenderer=void 0;var P={positions:[{name:"position",count:3,type:5126,offset:0,stride:12,normalized:!1}],colors:[{name:"color",count:3,type:5121,offset:0,stride:3,normalized:!0}]},S=function(){function e(e){var t=this;this._params=e,this.type="Point",this.isGround=!1,this._bindParameters={inverseViewport:[0,0],highlightDepthTexture:null},this._highlights=new u.PointHighlights({forEachNode:function(e){return t.forEachNode(e)},addHighlight:function(e,i,n){return t.addHighlight(e,i,n)},removeHighlight:function(e,i){return t.removeHighlight(e,i)}}),this.canRender=!0,this.layerUid="",this._useFixedSizes=!1,this._scaleFactor=1,this._minSizePx=0,this._useRealWorldSymbolSizes=!1,this._size=0,this._sizePx=0,this._slicePlaneEnabled=!1,this._clipBox=h.create(h.POSITIVE_INFINITY),this._techniqueConfig=new b.PointRendererTechniqueConfiguration,this.tempMatrix4=r.mat4f32.create(),this.tempVec3=a.vec3f32.create(),this.nodes=[]}return Object.defineProperty(e.prototype,"needsHighlight",{get:function(){return this._highlights.hasHighlights},enumerable:!1,configurable:!0}),e.prototype.initializeRenderContext=function(e){this._initContext=e,this._techniqueRep=this._initContext.shaderTechniqueRep,e.requestRender()},e.prototype.uninitializeRenderContext=function(){},e.prototype.intersect=function(e,t,i,n){var r=this,a=l.vec3f64.create(),u=l.vec3f64.create(),g=l.vec3f64.create(),m=l.vec3f64.create(),v=f.plane.create(),b=e.camera.perScreenPixelRatio/2,x=e.camera.near,y=this._getSizeParams();o.vec3.subtract(u,n,i);var P=1/o.vec3.length(u);o.vec3.scale(u,u,P),o.vec3.negate(g,u),c.vec4.set(v,u[0],u[1],u[2],-o.vec3.dot(u,i));var S=function(){this.node=null,this.pointId=null,this.point=null,this.dist=null,this.normal=null,this.layerUid=""},z=new S,q=new S,M=[],H=h.create(),I=h.create(this._clipBox);h.offset(I,-i[0],-i[1],-i[2],I);for(var O=function(s){var c=s.splatSize*F._scaleFactor,d=p.minimumDistancePlane(s.obb,v),f=p.maximumDistancePlane(s.obb,v);d-=w(c,d+x,y,b,s.isLeaf);var _=(f-=w(c,f+x,y,b,s.isLeaf))<0,O=null!=z.dist&&null!=q.dist&&z.dist<d*P&&q.dist>f*P;if(_||O)return"continue";var V=R(c,f+x,y,b,s.isLeaf);if(!p.intersectLine(s.obb,i,u,V))return"continue";var U=V*V;p.toAaBoundingBox(s.obb,H),h.offset(H,-i[0],-i[1],-i[2],H);var N=!h.contains(I,H);o.vec3.subtract(m,s.origin,i);for(var C=s.coordinates.length/3,E=function(d){if(a[0]=m[0]+s.coordinates[3*d],a[1]=m[1]+s.coordinates[3*d+1],a[2]=m[2]+s.coordinates[3*d+2],N&&!h.containsPoint(I,a))return"continue";var f=o.vec3.dot(a,u),p=o.vec3.squaredLength(a)-f*f;if(p>U)return"continue";var v=f+x,_=w(c,v,y,b,s.isLeaf);if(f-_<0)return"continue";var H=R(c,v-=_,y,b,s.isLeaf);if(p>H*H)return"continue";var O=(f-_)*P,F=function(e){e.point=function(e,t,i){null==i&&(i=l.vec3f64.create());return i[0]=e.origin[0]+e.coordinates[3*t],i[1]=e.origin[1]+e.coordinates[3*t+1],i[2]=e.origin[2]+e.coordinates[3*t+2],i}(s,d,e.point),e.dist=O,e.normal=g,e.node=s,e.pointId=d,e.layerUid=r.layerUid};if((null==z.dist||O<z.dist)&&(null==t||t(i,n,O))&&F(z),0!==e.options.store&&(null==q.dist||O>q.dist)&&(null==t||t(i,n,O))&&F(q),2===e.options.store&&(null==t||t(i,n,O))){var V=new S;F(V),M.push(V)}},T=0;T<C;T++)E(T)},F=this,V=0,U=this.nodes;V<U.length;V++){O(U[V])}var N=function(e,t){var i=function(e){var t=e.layerUid,i=e.node,n=e.pointId;return{type:"external",point:e.point,metadata:{layerUid:t,createGraphic:function(){return r._params.createGraphic(i,n,e.point)}}}}(t),n=t.layerUid+"/"+t.node.id+"/"+t.pointId;e.set(i,n,t.dist,t.normal,s.mat4f64.IDENTITY,void 0),e.intersector="PointRenderer"};if(null!=z.dist){var C=e.results.min;(null==C.dist||z.dist<C.dist)&&N(C,z)}if(null!=q.dist&&0!==e.options.store){var E=e.results.max;(null==E.dist||q.dist>E.dist)&&N(E,q)}if(2===e.options.store)for(var T=d.ray.fromPoints(i,n),j=0,B=M;j<B.length;j++){var A=B[j],L=new _.IntersectorResult(T);N(L,A),e.results.all.push(L)}},e.prototype.render=function(e){if(0!==e.pass&&1!==e.pass&&4!==e.pass)return!1;for(var t=1===e.pass,i=e.rctx,r=0,s=this.nodes;r<s.length;r++){null==(b=s[r]).vao&&this._initNode(e,b)}var a=this._getSizeParams(),l=this.selectTechnique(e,a),c=l.program;if(null==c||0===this.nodes.length)return!0;var u=this._clipBox,d=!h.equals(u,h.POSITIVE_INFINITY,(function(e,t){return e===t}));d||(o.vec3.set(this.tempVec3,-1/0,-1/0,-1/0),c.setUniform3fv("uClipMin",this.tempVec3),o.vec3.set(this.tempVec3,1/0,1/0,1/0),c.setUniform3fv("uClipMax",this.tempVec3)),i.bindProgram(c),l.bindPipelineState(i),c.setUniformMatrix4fv("uProjectionMatrix",e.camera.projectionMatrix),t&&c.setUniform2f("nearFar",e.camera.near,e.camera.far),e.isHighlightPass&&(this._bindParameters.inverseViewport[0]=1/e.camera.fullViewport[2],this._bindParameters.inverseViewport[1]=1/e.camera.fullViewport[3],this._bindParameters.highlightDepthTexture=e.highlightDepthTexture,m.OutputHighlight.bindOutputHighlight(i,c,this._bindParameters));var f=e.camera.pixelRatio;a.drawFixedSize&&c.setUniform2f("uPointScale",a.fixedSize*f,e.camera.fullHeight);for(var p=this._slicePlaneEnabled?e.sliceHelper&&e.sliceHelper.plane:null,v=0,_=this.nodes;v<_.length;v++){var b;if(0!==(b=_[v]).coordinates.length&&(!e.isHighlightPass||b.highlights)){if(c.setUniform2f("uScreenMinMaxSize",a.screenMinSize*f,z(b.isLeaf)*f),!a.drawFixedSize){var x=b.splatSize*this._scaleFactor;c.setUniform2f("uPointScale",x*f,e.camera.fullHeight/f)}var y=b.origin;d&&(o.vec3.set(this.tempVec3,u[0]-y[0],u[1]-y[1],u[2]-y[2]),c.setUniform3fv("uClipMin",this.tempVec3),o.vec3.set(this.tempVec3,u[3]-y[0],u[4]-y[1],u[5]-y[2]),c.setUniform3fv("uClipMax",this.tempVec3)),n.mat4.identity(this.tempMatrix4),n.mat4.translate(this.tempMatrix4,this.tempMatrix4,y),n.mat4.multiply(this.tempMatrix4,e.camera.viewMatrix,this.tempMatrix4),c.setUniformMatrix4fv("uModelViewMatrix",this.tempMatrix4),g.Slice.bindUniforms(c,l.configuration,p,y),i.bindVAO(b.vao),e.isHighlightPass?this._renderHighlightFragments(i,b):i.drawArrays(0,0,b.coordinates.length/3)}}return!0},e.prototype._renderHighlightFragments=function(e,t){var n=t.highlights;if(!i.isNone(n)){for(var r=i.unwrap(n[0].component),s=r+1,o=1;o<n.length;o++){var a=i.unwrap(n[o].component);if(a!==s){var l=s-r;l>0&&e.drawArrays(0,r,l),r=a}s=a+1}var c=s-r;c>0&&e.drawArrays(0,r,c)}},Object.defineProperty(e.prototype,"useFixedSizes",{get:function(){return this._useFixedSizes},set:function(e){this._useFixedSizes!==e&&(this._useFixedSizes=e,this._requestRender())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"scaleFactor",{get:function(){return this._scaleFactor},set:function(e){this._scaleFactor!==e&&(this._scaleFactor=e,this._requestRender())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"minSizePx",{get:function(){return this._minSizePx},set:function(e){this._minSizePx!==e&&(this._minSizePx=e,this._requestRender())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"useRealWorldSymbolSizes",{get:function(){return this._useRealWorldSymbolSizes},set:function(e){this._useRealWorldSymbolSizes!==e&&(this._useRealWorldSymbolSizes=e,this._requestRender())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"size",{get:function(){return this._size},set:function(e){this._size!==e&&(this._size=e,this._requestRender())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"sizePx",{get:function(){return this._sizePx},set:function(e){this._sizePx!==e&&(this._sizePx=e,this._requestRender())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"clippingBox",{set:function(e){h.set(this._clipBox,e||h.POSITIVE_INFINITY)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"slicePlane",{get:function(){return this._slicePlaneEnabled},set:function(e){this._slicePlaneEnabled!==e&&(this._slicePlaneEnabled=e,this._requestRender())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"intersectionHandlerId",{get:function(){return this.layerUid},enumerable:!1,configurable:!0}),e.prototype.addNode=function(e){this.nodes.push(e),this._highlights.nodeAdded(e),this._requestRender()},e.prototype.removeNode=function(e){var t=this,i=null;return this.nodes=this.nodes.filter((function(n){return n.id!==e||(i=n,n.vao&&(n.vao.dispose(!0),n.vao=null),t._highlights.nodeRemoved(n),!1)})),this._requestRender(),i},e.prototype.forEachNode=function(e){this.nodes.forEach(e)},e.prototype.removeAll=function(){this.nodes.forEach((function(e){e.vao&&(e.vao.dispose(!0),e.vao=null)})),this._highlights.removeAll(),this.nodes=[],this._requestRender()},e.prototype.highlight=function(e){return this._highlights.add(e)},e.prototype.addHighlight=function(e,t,n){e.highlights=function(e,t,n){var r;i.isNone(e)&&(e=[]);var s={component:t,id:n};e.push(s);var o=q(s),a=e.length-1;for(;a>0&&o<q(e[a-1]);)r=[e[a],e[a-1]],e[a-1]=r[0],e[a]=r[1],--a;return e}(e.highlights,t,n),this._requestRender()},e.prototype.removeHighlight=function(e,t){e.highlights=function(e,t){if(i.isNone(e))return e;var n=e.filter((function(e){return e.id!==t}));if(0===n.length)return null;return n}(e.highlights,t),this._requestRender()},e.prototype._initNode=function(e,t){var i=e.rctx;t.vao=new y(i,v.Default3D,P,{positions:x.createVertex(i,35044,t.coordinates),colors:x.createVertex(i,35044,t.rgb)})},e.prototype._requestRender=function(){this._initContext&&this._initContext.requestRender()},e.prototype._getSizeParams=function(){var e=this._useFixedSizes,t=e&&!this._useRealWorldSymbolSizes,i=t?this._sizePx:this._size,n=this._minSizePx;return e&&(n=0),{drawScreenSpace:t,drawFixedSize:e,fixedSize:i,screenMinSize:n}},e.prototype.selectTechnique=function(e,t){return this._techniqueConfig.drawScreenSize=t.drawScreenSpace,this._techniqueConfig.slicePlaneEnabled=this._slicePlaneEnabled,this._techniqueConfig.sceneHasOcludees=e.hasOccludees,this._techniqueConfig.output=1===e.pass?1:4===e.pass?4:0,this._techniqueRep.acquireAndReleaseExisting(b.PointRendererTechnique,this._techniqueConfig,this._technique)},e}();function z(e){return e?256:64}function R(e,t,i,n,r){if(i.drawScreenSpace)return i.fixedSize*t*n;var s=z(r)*t*n;return i.drawFixedSize?Math.min(i.fixedSize/2,s):i.screenMinSize>0?Math.min(Math.max(i.screenMinSize*t*n,e/2),s):Math.min(e/2,s)}function w(e,t,i,n,r){return i.drawScreenSpace?0:R(e,t,i,n,r)}function q(e){return i.isSome(e.component)?e.component:-1}t.PointRenderer=S,function(e){e.isInstanceOfNode=function(e){return e.hasOwnProperty("splatSize")}}(S=t.PointRenderer||(t.PointRenderer={})),t.PointRenderer=S}));