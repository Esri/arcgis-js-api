/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/PooledArray","../../../../chunks/mat4","../../../../chunks/mat4f32","../../../../chunks/mat4f64","../../../../chunks/vec3","../../../../chunks/vec3f32","../../../../chunks/vec3f64","../../../../chunks/vec4","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/plane","../../../../geometry/support/ray","./PointHighlights","../../support/orientedBoundingBox","../../webgl-engine/core/shaderLibrary/Slice.glsl","../../webgl-engine/core/shaderLibrary/output/OutputHighlight.glsl","../../webgl-engine/lib/DefaultVertexAttributeLocations","../../webgl-engine/lib/intersectorUtils","../../webgl-engine/shaders/PointRendererTechnique","../../../webgl/BufferObject","../../../webgl/VertexArrayObject"],(function(e,t,i,n,s,r,o,a,c,h,l,u,d,f,g,p,m,_,x,S,P,z,b){"use strict";const y={positions:[{name:"position",count:3,type:5126,offset:0,stride:12,normalized:!1}],colors:[{name:"color",count:3,type:5121,offset:0,stride:3,normalized:!0}]};function R(e){return e?256:64}function w(e,t,i,n,s){if(i.drawScreenSpace)return i.fixedSize*t*n;const r=R(s)*t*n;return i.drawFixedSize?Math.min(i.fixedSize/2,r):i.screenMinSize>0?Math.min(Math.max(i.screenMinSize*t*n,e/2),r):Math.min(e/2,r)}function q(e,t,i,n,s){return i.drawScreenSpace?0:w(e,t,i,n,s)}function v(e,t,i){return null==i&&(i=h.create()),i[0]=e.origin[0]+e.coordinates[3*t],i[1]=e.origin[1]+e.coordinates[3*t+1],i[2]=e.origin[2]+e.coordinates[3*t+2],i}function M(e){return i.isSome(e.component)?e.component:-1}function I(e,t,n){i.isNone(e)&&(e=[]);const s={component:t,id:n};e.push(s);const r=M(s);let o=e.length-1;for(;o>0&&r<M(e[o-1]);)[e[o-1],e[o]]=[e[o],e[o-1]],--o;return e}function H(e,t){if(i.isNone(e))return e;const n=e.filter((e=>e.id!==t));return 0===n.length?null:n}e.PointRenderer=function(){function e(e){this._params=e,this.type="Point",this.isGround=!1,this._bindParameters={inverseViewport:[0,0],highlightDepthTexture:null},this._highlights=new g.PointHighlights({forEachNode:e=>this.forEachNode(e),addHighlight:(e,t,i)=>this.addHighlight(e,t,i),removeHighlight:(e,t)=>this.removeHighlight(e,t)}),this.canRender=!0,this.layerUid="",this._useFixedSizes=!1,this._scaleFactor=1,this._minSizePx=0,this._useRealWorldSymbolSizes=!1,this._size=0,this._sizePx=0,this._slicePlaneEnabled=!1,this._clipBox=u.create(u.POSITIVE_INFINITY),this._techniqueConfig=new P.PointRendererTechniqueConfiguration,this.tempMatrix4=r.create(),this.tempVec3=c.create(),this.nodes=new n}var M=e.prototype;return M.initializeRenderContext=function(e){this._context=e,this._techniqueRep=this._context.shaderTechniqueRep,e.requestRender()},M.uninitializeRenderContext=function(){},M.intersect=function(e,t,i,n){const s=h.create(),r=h.create(),c=h.create(),g=h.create(),m=d.create(),_=e.camera.perScreenPixelRatio/2,x=e.camera.near,P=this._getSizeParams();a.subtract(r,n,i);const z=1/a.length(r);a.scale(r,r,z),a.negate(c,r),l.set(m,r[0],r[1],r[2],-a.dot(r,i));let b=function(){this.node=null,this.pointId=null,this.point=null,this.dist=null,this.normal=null,this.layerUid=""};const y=new b,R=new b,M=[],I=u.create(),H=u.create(this._clipBox);u.offset(H,-i[0],-i[1],-i[2],H),this.nodes.forAll((o=>{const h=o.splatSize*this._scaleFactor;let l=p.minimumDistancePlane(o.obb,m),d=p.maximumDistancePlane(o.obb,m);l-=q(h,l+x,P,_,o.isLeaf),d-=q(h,d+x,P,_,o.isLeaf);const f=d<0,S=null!=y.dist&&null!=R.dist&&y.dist<l*z&&R.dist>d*z;if(f||S)return;const F=w(h,d+x,P,_,o.isLeaf);if(!p.intersectLine(o.obb,i,r,F))return;const V=F*F;p.toAaBoundingBox(o.obb,I),u.offset(I,-i[0],-i[1],-i[2],I);const U=!u.contains(H,I);a.subtract(g,o.origin,i);const k=o.coordinates.length/3;for(let p=0;p<k;p++){if(s[0]=g[0]+o.coordinates[3*p],s[1]=g[1]+o.coordinates[3*p+1],s[2]=g[2]+o.coordinates[3*p+2],U&&!u.containsPoint(H,s))continue;const l=a.dot(s,r),d=a.squaredLength(s)-l*l;if(d>V)continue;let f=l+x;const m=q(h,f,P,_,o.isLeaf);if(l-m<0)continue;f-=m;const S=w(h,f,P,_,o.isLeaf);if(d>S*S)continue;const I=(l-m)*z,F=e=>{e.point=v(o,p,e.point),e.dist=I,e.normal=c,e.node=o,e.pointId=p,e.layerUid=this.layerUid};if((null==y.dist||I<y.dist)&&(null==t||t(i,n,I))&&F(y),0!==e.options.store&&(null==R.dist||I>R.dist)&&(null==t||t(i,n,I))&&F(R),2===e.options.store&&(null==t||t(i,n,I))){const e=new b;F(e),M.push(e)}}}));const F=e=>{const{layerUid:t,node:i,pointId:n}=e;return{type:"external",point:e.point,metadata:{layerUid:t,createGraphic:()=>this._params.createGraphic(i,n,e.point)}}},V=(e,t)=>{const i=F(t),n=`${t.layerUid}/${t.node.id}/${t.pointId}`;e.set(i,n,t.dist,t.normal,o.IDENTITY,void 0),e.intersector="PointRenderer"};if(null!=y.dist){const t=e.results.min;(null==t.dist||y.dist<t.dist)&&V(t,y)}if(null!=R.dist&&0!==e.options.store){const t=e.results.max;(null==t.dist||R.dist>t.dist)&&V(t,R)}if(2===e.options.store){const t=f.fromPoints(i,n);for(const i of M){const n=new S.IntersectorResult(t);V(n,i),e.results.all.push(n)}}},M.render=function(e){if(0!==e.pass&&2!==e.pass&&5!==e.pass)return!1;const t=2===e.pass,i=e.rctx;this.nodes.forAll((t=>{null==t.vao&&this._initNode(e,t)}));const n=this._getSizeParams(),r=this.selectTechnique(e,n),o=r.program;if(null==o||0===this.nodes.length)return!0;const c=this._clipBox,h=!u.equals(c,u.POSITIVE_INFINITY,((e,t)=>e===t));h||(a.set(this.tempVec3,-1/0,-1/0,-1/0),o.setUniform3fv("uClipMin",this.tempVec3),a.set(this.tempVec3,1/0,1/0,1/0),o.setUniform3fv("uClipMax",this.tempVec3)),i.useProgram(o),r.bindPipelineState(i),o.setUniformMatrix4fv("uProjectionMatrix",e.camera.projectionMatrix),t&&o.setUniform2f("nearFar",e.camera.near,e.camera.far),e.isHighlightPass&&(this._bindParameters.inverseViewport[0]=1/e.camera.fullViewport[2],this._bindParameters.inverseViewport[1]=1/e.camera.fullViewport[3],this._bindParameters.highlightDepthTexture=e.highlightDepthTexture,_.bindOutputHighlight(o,this._bindParameters));const l=e.camera.pixelRatio;n.drawFixedSize&&o.setUniform2f("uPointScale",n.fixedSize*l,e.camera.fullHeight);const d=this._slicePlaneEnabled?e.sliceHelper&&e.sliceHelper.plane:null;return this.nodes.forAll((t=>{if(0===t.coordinates.length||e.isHighlightPass&&!t.highlights)return;if(o.setUniform2f("uScreenMinMaxSize",n.screenMinSize*l,R(t.isLeaf)*l),!n.drawFixedSize){const i=t.splatSize*this._scaleFactor;o.setUniform2f("uPointScale",i*l,e.camera.fullHeight/l)}const u=t.origin;h&&(a.set(this.tempVec3,c[0]-u[0],c[1]-u[1],c[2]-u[2]),o.setUniform3fv("uClipMin",this.tempVec3),a.set(this.tempVec3,c[3]-u[0],c[4]-u[1],c[5]-u[2]),o.setUniform3fv("uClipMax",this.tempVec3)),s.identity(this.tempMatrix4),s.translate(this.tempMatrix4,this.tempMatrix4,u),s.multiply(this.tempMatrix4,e.camera.viewMatrix,this.tempMatrix4),o.setUniformMatrix4fv("uModelViewMatrix",this.tempMatrix4),m.bindSliceUniforms(o,r.configuration,d,u),i.bindVAO(t.vao),e.isHighlightPass?this._renderHighlightFragments(i,t):i.drawArrays(0,0,t.coordinates.length/3)})),!0},M._renderHighlightFragments=function(e,t){const n=t.highlights;if(i.isNone(n))return;let s=i.unwrap(n[0].component),r=s+1;for(let a=1;a<n.length;a++){const t=i.unwrap(n[a].component);if(t!==r){const i=r-s;i>0&&e.drawArrays(0,s,i),s=t}r=t+1}const o=r-s;o>0&&e.drawArrays(0,s,o)},M.addNode=function(e){this.nodes.push(e),this._highlights.nodeAdded(e),this._requestRender()},M.removeNode=function(e){let t=null;return this.nodes.filterInPlace((n=>n.id!==e||(t=n,n.vao=i.disposeMaybe(n.vao),this._highlights.nodeRemoved(n),!1))),this._requestRender(),t},M.forEachNode=function(e){this.nodes.forAll(e)},M.removeAll=function(){this.nodes.forAll((e=>e.vao=i.disposeMaybe(e.vao))),this._highlights.removeAll(),this.nodes.clear(),this._requestRender()},M.highlight=function(e){return this._highlights.add(e)},M.addHighlight=function(e,t,i){e.highlights=I(e.highlights,t,i),this._requestRender()},M.removeHighlight=function(e,t){e.highlights=H(e.highlights,t),this._requestRender()},M._initNode=function(e,t){const i=e.rctx;t.vao=new b(i,x.Default3D,y,{positions:z.createVertex(i,35044,t.coordinates),colors:z.createVertex(i,35044,t.rgb)})},M._requestRender=function(){this._context&&this._context.requestRender()},M._getSizeParams=function(){const e=this._useFixedSizes,t=e&&!this._useRealWorldSymbolSizes;return{drawScreenSpace:t,drawFixedSize:e,fixedSize:t?this._sizePx:this._size,screenMinSize:e?0:this._minSizePx}},M.selectTechnique=function(e,t){return this._techniqueConfig.drawScreenSize=t.drawScreenSpace,this._techniqueConfig.slicePlaneEnabled=this._slicePlaneEnabled,this._techniqueConfig.sceneHasOcludees=e.hasOccludees,this._techniqueConfig.output=2===e.pass?1:5===e.pass?4:0,this._techniqueRep.releaseAndAcquire(P.PointRendererTechnique,this._techniqueConfig,this._technique)},t._createClass(e,[{key:"needsHighlight",get:function(){return this._highlights.hasHighlights}},{key:"useFixedSizes",get:function(){return this._useFixedSizes},set:function(e){this._useFixedSizes!==e&&(this._useFixedSizes=e,this._requestRender())}},{key:"scaleFactor",get:function(){return this._scaleFactor},set:function(e){this._scaleFactor!==e&&(this._scaleFactor=e,this._requestRender())}},{key:"minSizePx",get:function(){return this._minSizePx},set:function(e){this._minSizePx!==e&&(this._minSizePx=e,this._requestRender())}},{key:"useRealWorldSymbolSizes",get:function(){return this._useRealWorldSymbolSizes},set:function(e){this._useRealWorldSymbolSizes!==e&&(this._useRealWorldSymbolSizes=e,this._requestRender())}},{key:"size",get:function(){return this._size},set:function(e){this._size!==e&&(this._size=e,this._requestRender())}},{key:"sizePx",get:function(){return this._sizePx},set:function(e){this._sizePx!==e&&(this._sizePx=e,this._requestRender())}},{key:"clippingBox",set:function(e){u.set(this._clipBox,e||u.POSITIVE_INFINITY)}},{key:"slicePlane",get:function(){return this._slicePlaneEnabled},set:function(e){this._slicePlaneEnabled!==e&&(this._slicePlaneEnabled=e,this._requestRender())}},{key:"intersectionHandlerId",get:function(){return this.layerUid}}]),e}(),function(e){function t(e){return e.hasOwnProperty("splatSize")}e.isInstanceOfNode=t}(e.PointRenderer||(e.PointRenderer={})),Object.defineProperty(e,"__esModule",{value:!0})}));
