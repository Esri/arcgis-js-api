/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/PooledArray","../../../../chunks/mat4","../../../../chunks/mat4f32","../../../../chunks/vec3","../../../../chunks/vec3f32","../../../../chunks/vec3f64","../../../../chunks/vec4","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/plane","../../../../geometry/support/ray","./PointHighlights","../../support/orientedBoundingBox","../../webgl-engine/core/shaderLibrary/ShaderOutputOptions","../../webgl-engine/core/shaderLibrary/Slice.glsl","../../webgl-engine/core/shaderLibrary/output/OutputHighlight.glsl","../../webgl-engine/lib/DefaultVertexAttributeLocations","../../webgl-engine/lib/Intersector","../../webgl-engine/lib/IntersectorInterfaces","../../webgl-engine/lib/RenderPass","../../webgl-engine/lib/VertexAttribute","../../webgl-engine/shaders/PointRendererTechnique","../../../webgl/BufferObject","../../../webgl/enums","../../../webgl/VertexArrayObject","../../../webgl/VertexElementDescriptor"],(function(e,t,i,n,s,r,o,a,c,h,l,u,d,g,f,p,m,_,S,x,b,P,R,z,y,w,I,T){"use strict";const A={positions:[new T.VertexElementDescriptor(R.VertexAttribute.POSITION,3,w.DataType.FLOAT,0,12)],colors:[new T.VertexElementDescriptor(R.VertexAttribute.COLOR,3,w.DataType.UNSIGNED_BYTE,0,3,!0)]};let v=function(){function e(e){this._params=e,this.type=b.IntersectorType.PCL,this.isGround=!1,this._bindParameters={inverseViewport:[0,0],highlightDepthTexture:null},this._highlights=new g.PointHighlights({forEachNode:e=>this.forEachNode(e),addHighlight:(e,t,i)=>this._addHighlight(e,t,i),removeHighlight:(e,t)=>this._removeHighlight(e,t)}),this.canRender=!0,this.layerUid="",this._useFixedSizes=!1,this._scaleFactor=1,this._minSizePx=0,this._useRealWorldSymbolSizes=!1,this._size=0,this._sizePx=0,this._slicePlaneEnabled=!1,this._clipBox=l.create(l.POSITIVE_INFINITY),this._techniqueConfig=new z.PointRendererTechniqueConfiguration,this.tempMatrix4=r.create(),this.tempVec3=a.create(),this.nodes=new n}var R=e.prototype;return R.initializeRenderContext=function(e){this._context=e,this._techniqueRep=this._context.shaderTechniqueRepository,e.requestRender()},R.uninitializeRenderContext=function(){},R.intersect=function(e,t,i,n){const s=c.create(),r=c.create(),a=c.create(),g=c.create(),p=u.create(),m=e.camera.perScreenPixelRatio/2,_=e.camera.near,S=this._getSizeParams();o.subtract(r,n,i);const P=1/o.length(r);o.scale(r,r,P),o.negate(a,r),h.set(p,r[0],r[1],r[2],-o.dot(r,i));const R=new F,z=new F,y=new Array,w=l.create(),I=l.create(this._clipBox);l.offset(I,-i[0],-i[1],-i[2],I),this.nodes.forAll((c=>{const h=c.splatSize*this._scaleFactor;let u=f.minimumDistancePlane(c.obb,p),d=f.maximumDistancePlane(c.obb,p);u-=V(h,u+_,S,m,c.isLeaf),d-=V(h,d+_,S,m,c.isLeaf);const x=d<0,T=null!=R.dist&&null!=z.dist&&R.dist<u*P&&z.dist>d*P;if(x||T)return;const A=H(h,d+_,S,m,c.isLeaf);if(!f.intersectLine(c.obb,i,r,A))return;const v=A*A;f.toAaBoundingBox(c.obb,w),l.offset(w,-i[0],-i[1],-i[2],w);const M=!l.contains(I,w);o.subtract(g,c.origin,i);const q=c.coordinates.length/3;for(let f=0;f<q;f++){if(s[0]=g[0]+c.coordinates[3*f],s[1]=g[1]+c.coordinates[3*f+1],s[2]=g[2]+c.coordinates[3*f+2],M&&!l.containsPoint(I,s))continue;const u=o.dot(s,r),d=o.squaredLength(s)-u*u;if(d>v)continue;let p=u+_;const x=V(h,p,S,m,c.isLeaf);if(u-x<0)continue;p-=x;const w=H(h,p,S,m,c.isLeaf);if(d>w*w)continue;const T=(u-x)*P,A=e=>(e.point=O(c,f,e.point),e.dist=T,e.normal=a,e.node=c,e.pointId=f,e.layerUid=this.layerUid,e);if((null==R.dist||T<R.dist)&&(null==t||t(i,n,T))&&A(R),e.options.store!==b.StoreResults.MIN&&(null==z.dist||T>z.dist)&&(null==t||t(i,n,T))&&A(z),e.options.store===b.StoreResults.ALL&&(null==t||t(i,n,T))){const e=new F;y.push(A(e))}}}));const T=e=>{const{layerUid:t,node:i,pointId:n}=e;return{point:e.point,layerUid:t,graphicUid:n,createGraphic:()=>this._params.createGraphic(i,n,e.point)}},A=(e,t)=>{const i=T(t);e.set(this.type,i,t.dist,t.normal)};if(U(R)){const t=e.results.min;(null==t.dist||R.dist<t.dist)&&A(t,R)}if(U(z)&&e.options.store!==b.StoreResults.MIN){const t=e.results.max;(null==t.dist||z.dist>t.dist)&&A(t,z)}if(e.options.store===b.StoreResults.ALL){const t=d.fromPoints(i,n);for(const i of y){const n=x.newIntersectorResult(t);A(n,i),e.results.all.push(n)}}},R.prepareTechnique=function(e){if(0===this.nodes.length||e.pass!==P.RenderPass.MATERIAL&&e.pass!==P.RenderPass.MATERIAL_DEPTH&&e.pass!==P.RenderPass.MATERIAL_HIGHLIGHT)return null;this.nodes.forAll((t=>{null==t.vao&&this._initNode(e,t)}));const t=this._getSizeParams();return this._techniqueConfig.drawScreenSize=t.drawScreenSpace,this._techniqueConfig.slicePlaneEnabled=this._slicePlaneEnabled,this._techniqueConfig.sceneHasOcludees=e.hasOccludees,this._techniqueConfig.output=e.pass===P.RenderPass.MATERIAL_DEPTH?p.ShaderOutput.Depth:e.pass===P.RenderPass.MATERIAL_HIGHLIGHT?p.ShaderOutput.Highlight:p.ShaderOutput.Color,this._techniqueRep.releaseAndAcquire(z.PointRendererTechnique,this._techniqueConfig,this._technique)},R.render=function(e,t){const i=e.rctx,n=i.useTechnique(t),r=this._clipBox,a=!l.equals(r,l.POSITIVE_INFINITY,((e,t)=>e===t));a||(o.set(this.tempVec3,-1/0,-1/0,-1/0),n.setUniform3fv("clipMin",this.tempVec3),o.set(this.tempVec3,1/0,1/0,1/0),n.setUniform3fv("clipMax",this.tempVec3)),n.setUniformMatrix4fv("proj",e.camera.projectionMatrix);e.pass===P.RenderPass.MATERIAL_DEPTH&&n.setUniform2fv("nearFar",e.camera.nearFar),e.isHighlightPass&&(this._bindParameters.inverseViewport[0]=1/e.camera.fullViewport[2],this._bindParameters.inverseViewport[1]=1/e.camera.fullViewport[3],this._bindParameters.highlightDepthTexture=e.highlightDepthTexture,_.bindOutputHighlight(n,this._bindParameters));const c=this._getSizeParams(),h=e.camera.pixelRatio;c.drawFixedSize&&n.setUniform2f("pointScale",c.fixedSize*h,e.camera.fullHeight);const u=this._slicePlaneEnabled?e.sliceHelper&&e.sliceHelper.plane:null;this.nodes.forAll((l=>{if(0===l.coordinates.length||e.isHighlightPass&&!l.highlights)return;if(n.setUniform2f("screenMinMaxSize",c.screenMinSize*h,q(l.isLeaf)*h),!c.drawFixedSize){const t=l.splatSize*this._scaleFactor;n.setUniform2f("pointScale",t*h,e.camera.fullHeight/h)}const d=l.origin;a&&(o.set(this.tempVec3,r[0]-d[0],r[1]-d[1],r[2]-d[2]),n.setUniform3fv("clipMin",this.tempVec3),o.set(this.tempVec3,r[3]-d[0],r[4]-d[1],r[5]-d[2]),n.setUniform3fv("clipMax",this.tempVec3)),s.fromTranslation(this.tempMatrix4,d),s.multiply(this.tempMatrix4,e.camera.viewMatrix,this.tempMatrix4),n.setUniformMatrix4fv("modelView",this.tempMatrix4),m.bindSliceUniforms(n,t.configuration,u,{origin:d}),i.bindVAO(l.vao),e.isHighlightPass?this._renderHighlightFragments(i,l):i.drawArrays(w.PrimitiveType.POINTS,0,l.coordinates.length/3)}))},R._renderHighlightFragments=function(e,t){const n=t.highlights;if(i.isNone(n))return;let s=i.unwrap(n[0].component),r=s+1;for(let a=1;a<n.length;a++){const t=i.unwrap(n[a].component);if(t!==r){const i=r-s;i>0&&e.drawArrays(w.PrimitiveType.POINTS,s,i),s=t}r=t+1}const o=r-s;o>0&&e.drawArrays(w.PrimitiveType.POINTS,s,o)},R.addNode=function(e){this.nodes.push(e),this._highlights.nodeAdded(e),this._requestRender()},R.removeNode=function(e){let t=null;return this.nodes.filterInPlace((n=>n.id!==e||(t=n,n.vao=i.disposeMaybe(n.vao),this._highlights.nodeRemoved(n),!1))),this._requestRender(),t},R.forEachNode=function(e){this.nodes.forAll(e)},R.removeAll=function(){this.nodes.forAll((e=>e.vao=i.disposeMaybe(e.vao))),this._highlights.removeAll(),this.nodes.clear(),this._requestRender()},R.highlight=function(e){return this._highlights.add(e)},R._addHighlight=function(e,t,i){e.highlights=L(e.highlights,t,i),this._requestRender()},R._removeHighlight=function(e,t){e.highlights=N(e.highlights,t),this._requestRender()},R._initNode=function(e,t){const i=e.rctx;t.vao=new I.VertexArrayObject(i,S.Default3D,A,{positions:y.BufferObject.createVertex(i,w.Usage.STATIC_DRAW,t.coordinates),colors:y.BufferObject.createVertex(i,w.Usage.STATIC_DRAW,t.rgb)})},R._requestRender=function(){this._context&&this._context.requestRender()},R._getSizeParams=function(){const e=this._useFixedSizes,t=e&&!this._useRealWorldSymbolSizes;return{drawScreenSpace:t,drawFixedSize:e,fixedSize:t?this._sizePx:this._size,screenMinSize:e?0:this._minSizePx}},t._createClass(e,[{key:"needsHighlight",get:function(){return this._highlights.hasHighlights}},{key:"useFixedSizes",get:function(){return this._useFixedSizes},set:function(e){this._useFixedSizes!==e&&(this._useFixedSizes=e,this._requestRender())}},{key:"scaleFactor",get:function(){return this._scaleFactor},set:function(e){this._scaleFactor!==e&&(this._scaleFactor=e,this._requestRender())}},{key:"minSizePx",get:function(){return this._minSizePx},set:function(e){this._minSizePx!==e&&(this._minSizePx=e,this._requestRender())}},{key:"useRealWorldSymbolSizes",get:function(){return this._useRealWorldSymbolSizes},set:function(e){this._useRealWorldSymbolSizes!==e&&(this._useRealWorldSymbolSizes=e,this._requestRender())}},{key:"size",get:function(){return this._size},set:function(e){this._size!==e&&(this._size=e,this._requestRender())}},{key:"sizePx",get:function(){return this._sizePx},set:function(e){this._sizePx!==e&&(this._sizePx=e,this._requestRender())}},{key:"clippingBox",set:function(e){l.set(this._clipBox,e||l.POSITIVE_INFINITY)}},{key:"slicePlaneEnabled",get:function(){return this._slicePlaneEnabled},set:function(e){this._slicePlaneEnabled!==e&&(this._slicePlaneEnabled=e,this._requestRender())}}]),e}();function M(e){return e.hasOwnProperty("splatSize")}function q(e){return e?256:64}function H(e,t,i,n,s){if(i.drawScreenSpace)return i.fixedSize*t*n;const r=q(s)*t*n;return i.drawFixedSize?Math.min(i.fixedSize/2,r):i.screenMinSize>0?Math.min(Math.max(i.screenMinSize*t*n,e/2),r):Math.min(e/2,r)}function V(e,t,i,n,s){return i.drawScreenSpace?0:H(e,t,i,n,s)}function O(e,t,n){return i.isNone(n)&&(n=c.create()),n[0]=e.origin[0]+e.coordinates[3*t],n[1]=e.origin[1]+e.coordinates[3*t+1],n[2]=e.origin[2]+e.coordinates[3*t+2],n}function E(e){return i.isSome(e.component)?e.component:-1}function L(e,t,n){i.isNone(e)&&(e=[]);const s={component:t,id:n};e.push(s);const r=E(s);let o=e.length-1;for(;o>0&&r<E(e[o-1]);)[e[o-1],e[o]]=[e[o],e[o-1]],--o;return e}function N(e,t){if(i.isNone(e))return e;const n=e.filter((e=>e.id!==t));return 0===n.length?null:n}let F=function(){this.node=null,this.pointId=null,this.point=null,this.dist=null,this.normal=null,this.layerUid=""};function U(e){return i.isSome(e.dist)&&i.isSome(e.point)&&i.isSome(e.pointId)&&i.isSome(e.node)}e.PointRenderer=v,e.isInstanceOfNode=M,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
