/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/PooledArray","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../chunks/vec4","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/plane","../../../../geometry/support/ray","./Intersector","./PointHighlights","../../support/orientedBoundingBox","../../webgl-engine/core/shaderLibrary/ShaderOutput","../../webgl-engine/lib/DefaultVertexAttributeLocations","../../webgl-engine/lib/Intersector","../../webgl-engine/lib/IntersectorInterfaces","../../webgl-engine/lib/VertexArrayObject","../../webgl-engine/lib/VertexAttribute","../../../../chunks/PointRenderer.glsl","../../webgl-engine/shaders/PointRendererTechnique","../../webgl-engine/shaders/PointRendererTechniqueConfiguration","../../../webgl/BufferObject","../../../webgl/enums","../../../webgl/VertexElementDescriptor"],(function(e,t,i,s,n,r,o,a,h,u,c,l,d,p,g,f,_,m,P,S,b,x,y,R,q){"use strict";const w={positions:[new q.VertexElementDescriptor(P.VertexAttribute.POSITION,3,R.DataType.FLOAT,0,12)],colors:[new q.VertexElementDescriptor(P.VertexAttribute.COLOR,3,R.DataType.UNSIGNED_BYTE,0,3,!0)]};let z=function(){function e(e){this._params=e,this.type=_.IntersectorType.PCL,this.isGround=!1,this._passParameters=new S.PointRendererPassParameters,this._highlights=new l.PointHighlights({forEachNode:e=>this.forEachNode(e),addHighlight:(e,t,i)=>this._addHighlight(e,t,i),removeHighlight:(e,t)=>this._removeHighlight(e,t)}),this.canRender=!0,this.layerUid="",this._slicePlaneEnabled=!1,this._techniqueConfig=new x.PointRendererTechniqueConfiguration,this._nodes=new s}var P=e.prototype;return P.initializeRenderContext=function(e){this._context=e,this._techniqueRepository=this._context.techniqueRepository,e.requestRender()},P.uninitializeRenderContext=function(){},P.intersect=function(e,t,i,s){const l=r.create(),p=r.create(),g=r.create(),m=r.create(),P=h.create(),S=e.camera.perScreenPixelRatio/2,b=e.camera.near;n.subtract(p,s,i);const x=1/n.length(p);n.scale(p,p,x),n.negate(g,p),o.set(P,p[0],p[1],p[2],-n.dot(p,i));const y=new D,R=new D,q=new Array,w=a.create(),z=a.create(this._passParameters.clipBox);a.offset(z,-i[0],-i[1],-i[2],z),this._nodes.forAll((r=>{const o=r.splatSize*this._passParameters.scaleFactor;let h=d.minimumDistancePlane(r.obb,P),u=d.maximumDistancePlane(r.obb,P);h-=T(o,h+b,this._passParameters,S,r.isLeaf),u-=T(o,u+b,this._passParameters,S,r.isLeaf);const c=u<0,f=null!=y.dist&&null!=R.dist&&y.dist<h*x&&R.dist>u*x;if(c||f)return;const I=A(o,u+b,this._passParameters,S,r.isLeaf);if(!d.intersectLine(r.obb,i,p,I))return;const O=I*I;d.toAaBoundingBox(r.obb,w),a.offset(w,-i[0],-i[1],-i[2],w);const v=!a.contains(z,w);n.subtract(m,r.origin,i);const C=r.coordinates.length/3;for(let d=0;d<C;d++){if(l[0]=m[0]+r.coordinates[3*d],l[1]=m[1]+r.coordinates[3*d+1],l[2]=m[2]+r.coordinates[3*d+2],v&&!a.containsPoint(z,l))continue;const h=n.dot(l,p),u=n.squaredLength(l)-h*h;if(u>O)continue;let c=h+b;const f=T(o,c,this._passParameters,S,r.isLeaf);if(h-f<0)continue;c-=f;const P=A(o,c,this._passParameters,S,r.isLeaf);if(u>P*P)continue;const w=(h-f)*x,I=e=>(e.point=N(r,d,e.point),e.dist=w,e.normal=g,e.node=r,e.pointId=d,e.layerUid=this.layerUid,e);if((null==y.dist||w<y.dist)&&(null==t||t(i,s,w))&&I(y),e.options.store!==_.StoreResults.MIN&&(null==R.dist||w>R.dist)&&(null==t||t(i,s,w))&&I(R),e.options.store===_.StoreResults.ALL&&(null==t||t(i,s,w))){const e=new D;q.push(I(e))}}}));const I=e=>{const{layerUid:t,node:i,pointId:s}=e;return new c.PclTarget(e.point,t,s,(()=>this._params.createGraphic(i,s,e.point)))},O=(e,t)=>{const i=I(t);e.set(this.type,i,t.dist,t.normal)};if(F(y)){const t=e.results.min;(null==t.dist||y.dist<t.dist)&&O(t,y)}if(F(R)&&e.options.store!==_.StoreResults.MIN){const t=e.results.max;(null==t.dist||R.dist>t.dist)&&O(t,R)}if(e.options.store===_.StoreResults.ALL){const t=u.fromPoints(i,s);for(const i of q){const s=f.newIntersectorResult(t);O(s,i),e.results.all.push(s)}}},P.prepareTechnique=function(e){return 0===this._nodes.length||e.output!==p.ShaderOutput.Color&&e.output!==p.ShaderOutput.Depth&&e.output!==p.ShaderOutput.Highlight?null:(this._nodes.forAll((t=>{null==t.vao&&this._initNode(e,t)})),this._techniqueConfig.drawScreenSize=this._passParameters.drawScreenSpace,this._techniqueConfig.useFixedSizes=this._passParameters.useFixedSizes,this._techniqueConfig.hasSlicePlane=this._slicePlaneEnabled,this._techniqueConfig.hasOccludees=e.bindParameters.hasOccludees,this._techniqueConfig.clippingEnabled=this._clippingEnabled,this._techniqueConfig.output=e.output===p.ShaderOutput.Depth?p.ShaderOutput.Depth:e.output===p.ShaderOutput.Highlight?p.ShaderOutput.Highlight:p.ShaderOutput.Color,this._techniqueRepository.releaseAndAcquire(b.PointRendererTechnique,this._techniqueConfig,this._technique))},P.render=function(e,t){const i=e.rctx,s=i.bindTechnique(t,this._passParameters,e.bindParameters),n=e.output===p.ShaderOutput.Highlight;this._nodes.forAll((t=>{0===t.coordinates.length||n&&!t.highlights||(s.bindDraw(t,e.bindParameters,this._passParameters),i.bindVAO(t.vao),n?this._renderHighlightFragments(i,t):i.drawArrays(R.PrimitiveType.POINTS,0,t.coordinates.length/3))}))},P._renderHighlightFragments=function(e,t){const s=t.highlights;if(i.isNone(s))return;let n=i.unwrap(s[0].component),r=n+1;for(let a=1;a<s.length;a++){const t=i.unwrap(s[a].component);if(t!==r){const i=r-n;i>0&&e.drawArrays(R.PrimitiveType.POINTS,n,i),n=t}r=t+1}const o=r-n;o>0&&e.drawArrays(R.PrimitiveType.POINTS,n,o)},P.addNode=function(e){this._nodes.push(e),this._highlights.nodeAdded(e),this._requestRender()},P.removeNode=function(e){let t=null;return this._nodes.filterInPlace((s=>s.id!==e||(t=s,s.vao=i.disposeMaybe(s.vao),this._highlights.nodeRemoved(s),!1))),this._requestRender(),t},P.forEachNode=function(e){this._nodes.forAll(e)},P.removeAll=function(){this._nodes.forAll((e=>e.vao=i.disposeMaybe(e.vao))),this._highlights.removeAll(),this._nodes.clear(),this._requestRender()},P.highlight=function(e){return this._highlights.add(e)},P._addHighlight=function(e,t,i){e.highlights=C(e.highlights,t,i),this._requestRender()},P._removeHighlight=function(e,t){e.highlights=E(e.highlights,t),this._requestRender()},P._initNode=function(e,t){const i=e.rctx;t.vao=new m.VertexArrayObject(i,g.Default3D,w,{positions:y.BufferObject.createVertex(i,R.Usage.STATIC_DRAW,t.coordinates),colors:y.BufferObject.createVertex(i,R.Usage.STATIC_DRAW,t.rgb)})},P._requestRender=function(){this._context&&this._context.requestRender()},t._createClass(e,[{key:"needsHighlight",get:function(){return this._highlights.hasHighlights}},{key:"useFixedSizes",get:function(){return this._passParameters.useFixedSizes},set:function(e){this._passParameters.useFixedSizes!==e&&(this._passParameters.useFixedSizes=e,this._requestRender())}},{key:"scaleFactor",get:function(){return this._passParameters.scaleFactor},set:function(e){this._passParameters.scaleFactor!==e&&(this._passParameters.scaleFactor=e,this._requestRender())}},{key:"minSizePx",get:function(){return this._passParameters.minSizePx},set:function(e){this._passParameters.minSizePx!==e&&(this._passParameters.minSizePx=e,this._requestRender())}},{key:"useRealWorldSymbolSizes",get:function(){return this._passParameters.useRealWorldSymbolSizes},set:function(e){this._passParameters.useRealWorldSymbolSizes!==e&&(this._passParameters.useRealWorldSymbolSizes=e,this._requestRender())}},{key:"size",get:function(){return this._passParameters.size},set:function(e){this._passParameters.size!==e&&(this._passParameters.size=e,this._requestRender())}},{key:"sizePx",get:function(){return this._passParameters.sizePx},set:function(e){this._passParameters.sizePx!==e&&(this._passParameters.sizePx=e,this._requestRender())}},{key:"clippingBox",set:function(e){a.set(this._passParameters.clipBox,e||a.POSITIVE_INFINITY)}},{key:"_clippingEnabled",get:function(){return!a.equals(this._passParameters.clipBox,a.POSITIVE_INFINITY,((e,t)=>e===t))}},{key:"slicePlaneEnabled",get:function(){return this._slicePlaneEnabled},set:function(e){this._slicePlaneEnabled!==e&&(this._slicePlaneEnabled=e,this._requestRender())}}]),e}(),I=function(e){function i(t,i,s,n,r,o,a,h,u=null,c=null){var l;return(l=e.call(this,s,r,i)||this).id=t,l.obb=n,l.coordinates=o,l.rgb=a,l.attributes=h,l.pointIdFilterMap=u,l.highlights=c,l}return t._inheritsLoose(i,e),i}(S.PointRendererDrawParameters);function O(e){return e.hasOwnProperty("splatSize")}function A(e,t,i,s,n){if(i.drawScreenSpace)return i.fixedSize*t*s;const r=S.getMaxPointSizeScreenspace(n)*t*s;return i.useFixedSizes?Math.min(i.fixedSize/2,r):i.screenMinSize>0?Math.min(Math.max(i.screenMinSize*t*s,e/2),r):Math.min(e/2,r)}function T(e,t,i,s,n){return i.drawScreenSpace?0:A(e,t,i,s,n)}function N(e,t,s){return i.isNone(s)&&(s=r.create()),s[0]=e.origin[0]+e.coordinates[3*t],s[1]=e.origin[1]+e.coordinates[3*t+1],s[2]=e.origin[2]+e.coordinates[3*t+2],s}function v(e){return i.isSome(e.component)?e.component:-1}function C(e,t,s){i.isNone(e)&&(e=[]);const n={component:t,id:s};e.push(n);const r=v(n);let o=e.length-1;for(;o>0&&r<v(e[o-1]);)[e[o-1],e[o]]=[e[o],e[o-1]],--o;return e}function E(e,t){if(i.isNone(e))return e;const s=e.filter((e=>e.id!==t));return 0===s.length?null:s}let D=function(){this.node=null,this.pointId=null,this.point=null,this.dist=null,this.normal=null,this.layerUid=""};function F(e){return i.isSome(e.dist)&&i.isSome(e.point)&&i.isSome(e.pointId)&&i.isSome(e.node)}e.PointRenderer=z,e.PointRendererNode=I,e.isInstanceOfNode=O,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
