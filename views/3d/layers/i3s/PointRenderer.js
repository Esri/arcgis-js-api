/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/PooledArray","../../../../chunks/vec3f64","../../../../chunks/vec3","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec4","../../../../geometry/support/aaBoundingBox","../../webgl-engine/lib/DefaultVertexAttributeLocations","../../../../chunks/mat4f32","../../../../chunks/vec3f32","../../support/geometryUtils","../../../webgl/BufferObject","../../../webgl/VertexArrayObject","../../webgl-engine/lib/intersectorUtils","../../webgl-engine/core/shaderLibrary/Slice.glsl","../../webgl-engine/core/shaderLibrary/output/OutputHighlight.glsl","../../support/orientedBoundingBox","./PointHighlights","../../webgl-engine/shaders/PointRendererTechnique"],(function(e,t,i,n,s,r,o,a,c,h,l,u,d,f,g,p,m,_,x,S,P,z){"use strict";const b={positions:[{name:"position",count:3,type:5126,offset:0,stride:12,normalized:!1}],colors:[{name:"color",count:3,type:5121,offset:0,stride:3,normalized:!0}]};function y(e){return e?256:64}function R(e,t,i,n,s){if(i.drawScreenSpace)return i.fixedSize*t*n;const r=y(s)*t*n;return i.drawFixedSize?Math.min(i.fixedSize/2,r):i.screenMinSize>0?Math.min(Math.max(i.screenMinSize*t*n,e/2),r):Math.min(e/2,r)}function w(e,t,i,n,s){return i.drawScreenSpace?0:R(e,t,i,n,s)}function q(e,t,i){return null==i&&(i=s.create()),i[0]=e.origin[0]+e.coordinates[3*t],i[1]=e.origin[1]+e.coordinates[3*t+1],i[2]=e.origin[2]+e.coordinates[3*t+2],i}function v(e){return i.isSome(e.component)?e.component:-1}function M(e,t,n){i.isNone(e)&&(e=[]);const s={component:t,id:n};e.push(s);const r=v(s);let o=e.length-1;for(;o>0&&r<v(e[o-1]);)[e[o-1],e[o]]=[e[o],e[o-1]],--o;return e}function H(e,t){if(i.isNone(e))return e;const n=e.filter((e=>e.id!==t));return 0===n.length?null:n}e.PointRenderer=function(){function e(e){this._params=e,this.type="Point",this.isGround=!1,this._bindParameters={inverseViewport:[0,0],highlightDepthTexture:null},this._highlights=new P.PointHighlights({forEachNode:e=>this.forEachNode(e),addHighlight:(e,t,i)=>this.addHighlight(e,t,i),removeHighlight:(e,t)=>this.removeHighlight(e,t)}),this.canRender=!0,this.layerUid="",this._useFixedSizes=!1,this._scaleFactor=1,this._minSizePx=0,this._useRealWorldSymbolSizes=!1,this._size=0,this._sizePx=0,this._slicePlaneEnabled=!1,this._clipBox=h.create(h.POSITIVE_INFINITY),this._techniqueConfig=new z.PointRendererTechniqueConfiguration,this.tempMatrix4=u.create(),this.tempVec3=d.create(),this.nodes=new n}var v=e.prototype;return v.initializeRenderContext=function(e){this._context=e,this._techniqueRep=this._context.shaderTechniqueRep,e.requestRender()},v.uninitializeRenderContext=function(){},v.intersect=function(e,t,i,n){const o=s.create(),l=s.create(),u=s.create(),d=s.create(),g=f.plane.create(),p=e.camera.perScreenPixelRatio/2,_=e.camera.near,x=this._getSizeParams();r.subtract(l,n,i);const P=1/r.length(l);r.scale(l,l,P),r.negate(u,l),c.set(g,l[0],l[1],l[2],-r.dot(l,i));let z=function(){this.node=null,this.pointId=null,this.point=null,this.dist=null,this.normal=null,this.layerUid=""};const b=new z,y=new z,v=[],M=h.create(),H=h.create(this._clipBox);h.offset(H,-i[0],-i[1],-i[2],H),this.nodes.forAll((s=>{const a=s.splatSize*this._scaleFactor;let c=S.minimumDistancePlane(s.obb,g),f=S.maximumDistancePlane(s.obb,g);c-=w(a,c+_,x,p,s.isLeaf),f-=w(a,f+_,x,p,s.isLeaf);const m=f<0,I=null!=b.dist&&null!=y.dist&&b.dist<c*P&&y.dist>f*P;if(m||I)return;const F=R(a,f+_,x,p,s.isLeaf);if(!S.intersectLine(s.obb,i,l,F))return;const V=F*F;S.toAaBoundingBox(s.obb,M),h.offset(M,-i[0],-i[1],-i[2],M);const U=!h.contains(H,M);r.subtract(d,s.origin,i);const k=s.coordinates.length/3;for(let g=0;g<k;g++){if(o[0]=d[0]+s.coordinates[3*g],o[1]=d[1]+s.coordinates[3*g+1],o[2]=d[2]+s.coordinates[3*g+2],U&&!h.containsPoint(H,o))continue;const c=r.dot(o,l),f=r.squaredLength(o)-c*c;if(f>V)continue;let m=c+_;const S=w(a,m,x,p,s.isLeaf);if(c-S<0)continue;m-=S;const M=R(a,m,x,p,s.isLeaf);if(f>M*M)continue;const I=(c-S)*P,F=e=>{e.point=q(s,g,e.point),e.dist=I,e.normal=u,e.node=s,e.pointId=g,e.layerUid=this.layerUid};if((null==b.dist||I<b.dist)&&(null==t||t(i,n,I))&&F(b),0!==e.options.store&&(null==y.dist||I>y.dist)&&(null==t||t(i,n,I))&&F(y),2===e.options.store&&(null==t||t(i,n,I))){const e=new z;F(e),v.push(e)}}}));const I=e=>{const{layerUid:t,node:i,pointId:n}=e;return{type:"external",point:e.point,metadata:{layerUid:t,createGraphic:()=>this._params.createGraphic(i,n,e.point)}}},F=(e,t)=>{const i=I(t),n=`${t.layerUid}/${t.node.id}/${t.pointId}`;e.set(i,n,t.dist,t.normal,a.IDENTITY,void 0),e.intersector="PointRenderer"};if(null!=b.dist){const t=e.results.min;(null==t.dist||b.dist<t.dist)&&F(t,b)}if(null!=y.dist&&0!==e.options.store){const t=e.results.max;(null==t.dist||y.dist>t.dist)&&F(t,y)}if(2===e.options.store){const t=f.ray.fromPoints(i,n);for(const i of v){const n=new m.IntersectorResult(t);F(n,i),e.results.all.push(n)}}},v.render=function(e){if(0!==e.pass&&2!==e.pass&&5!==e.pass)return!1;const t=2===e.pass,i=e.rctx;this.nodes.forAll((t=>{null==t.vao&&this._initNode(e,t)}));const n=this._getSizeParams(),s=this.selectTechnique(e,n),a=s.program;if(null==a||0===this.nodes.length)return!0;const c=this._clipBox,l=!h.equals(c,h.POSITIVE_INFINITY,((e,t)=>e===t));l||(r.set(this.tempVec3,-1/0,-1/0,-1/0),a.setUniform3fv("uClipMin",this.tempVec3),r.set(this.tempVec3,1/0,1/0,1/0),a.setUniform3fv("uClipMax",this.tempVec3)),i.bindProgram(a),s.bindPipelineState(i),a.setUniformMatrix4fv("uProjectionMatrix",e.camera.projectionMatrix),t&&a.setUniform2f("nearFar",e.camera.near,e.camera.far),e.isHighlightPass&&(this._bindParameters.inverseViewport[0]=1/e.camera.fullViewport[2],this._bindParameters.inverseViewport[1]=1/e.camera.fullViewport[3],this._bindParameters.highlightDepthTexture=e.highlightDepthTexture,x.OutputHighlight.bindOutputHighlight(i,a,this._bindParameters));const u=e.camera.pixelRatio;n.drawFixedSize&&a.setUniform2f("uPointScale",n.fixedSize*u,e.camera.fullHeight);const d=this._slicePlaneEnabled?e.sliceHelper&&e.sliceHelper.plane:null;return this.nodes.forAll((t=>{if(0===t.coordinates.length||e.isHighlightPass&&!t.highlights)return;if(a.setUniform2f("uScreenMinMaxSize",n.screenMinSize*u,y(t.isLeaf)*u),!n.drawFixedSize){const i=t.splatSize*this._scaleFactor;a.setUniform2f("uPointScale",i*u,e.camera.fullHeight/u)}const h=t.origin;l&&(r.set(this.tempVec3,c[0]-h[0],c[1]-h[1],c[2]-h[2]),a.setUniform3fv("uClipMin",this.tempVec3),r.set(this.tempVec3,c[3]-h[0],c[4]-h[1],c[5]-h[2]),a.setUniform3fv("uClipMax",this.tempVec3)),o.identity(this.tempMatrix4),o.translate(this.tempMatrix4,this.tempMatrix4,h),o.multiply(this.tempMatrix4,e.camera.viewMatrix,this.tempMatrix4),a.setUniformMatrix4fv("uModelViewMatrix",this.tempMatrix4),_.Slice.bindUniforms(a,s.configuration,d,h),i.bindVAO(t.vao),e.isHighlightPass?this._renderHighlightFragments(i,t):i.drawArrays(0,0,t.coordinates.length/3)})),!0},v._renderHighlightFragments=function(e,t){const n=t.highlights;if(i.isNone(n))return;let s=i.unwrap(n[0].component),r=s+1;for(let a=1;a<n.length;a++){const t=i.unwrap(n[a].component);if(t!==r){const i=r-s;i>0&&e.drawArrays(0,s,i),s=t}r=t+1}const o=r-s;o>0&&e.drawArrays(0,s,o)},v.addNode=function(e){this.nodes.push(e),this._highlights.nodeAdded(e),this._requestRender()},v.removeNode=function(e){let t=null;return this.nodes.filterInPlace((n=>n.id!==e||(t=n,n.vao=i.disposeMaybe(n.vao),this._highlights.nodeRemoved(n),!1))),this._requestRender(),t},v.forEachNode=function(e){this.nodes.forAll(e)},v.removeAll=function(){this.nodes.forAll((e=>e.vao=i.disposeMaybe(e.vao))),this._highlights.removeAll(),this.nodes.clear(),this._requestRender()},v.highlight=function(e){return this._highlights.add(e)},v.addHighlight=function(e,t,i){e.highlights=M(e.highlights,t,i),this._requestRender()},v.removeHighlight=function(e,t){e.highlights=H(e.highlights,t),this._requestRender()},v._initNode=function(e,t){const i=e.rctx;t.vao=new p(i,l.Default3D,b,{positions:g.createVertex(i,35044,t.coordinates),colors:g.createVertex(i,35044,t.rgb)})},v._requestRender=function(){this._context&&this._context.requestRender()},v._getSizeParams=function(){const e=this._useFixedSizes,t=e&&!this._useRealWorldSymbolSizes,i=t?this._sizePx:this._size;let n=this._minSizePx;return e&&(n=0),{drawScreenSpace:t,drawFixedSize:e,fixedSize:i,screenMinSize:n}},v.selectTechnique=function(e,t){return this._techniqueConfig.drawScreenSize=t.drawScreenSpace,this._techniqueConfig.slicePlaneEnabled=this._slicePlaneEnabled,this._techniqueConfig.sceneHasOcludees=e.hasOccludees,this._techniqueConfig.output=2===e.pass?1:5===e.pass?4:0,this._techniqueRep.acquireAndReleaseExisting(z.PointRendererTechnique,this._techniqueConfig,this._technique)},t._createClass(e,[{key:"needsHighlight",get:function(){return this._highlights.hasHighlights}},{key:"useFixedSizes",get:function(){return this._useFixedSizes},set:function(e){this._useFixedSizes!==e&&(this._useFixedSizes=e,this._requestRender())}},{key:"scaleFactor",get:function(){return this._scaleFactor},set:function(e){this._scaleFactor!==e&&(this._scaleFactor=e,this._requestRender())}},{key:"minSizePx",get:function(){return this._minSizePx},set:function(e){this._minSizePx!==e&&(this._minSizePx=e,this._requestRender())}},{key:"useRealWorldSymbolSizes",get:function(){return this._useRealWorldSymbolSizes},set:function(e){this._useRealWorldSymbolSizes!==e&&(this._useRealWorldSymbolSizes=e,this._requestRender())}},{key:"size",get:function(){return this._size},set:function(e){this._size!==e&&(this._size=e,this._requestRender())}},{key:"sizePx",get:function(){return this._sizePx},set:function(e){this._sizePx!==e&&(this._sizePx=e,this._requestRender())}},{key:"clippingBox",set:function(e){h.set(this._clipBox,e||h.POSITIVE_INFINITY)}},{key:"slicePlane",get:function(){return this._slicePlaneEnabled},set:function(e){this._slicePlaneEnabled!==e&&(this._slicePlaneEnabled=e,this._requestRender())}},{key:"intersectionHandlerId",get:function(){return this.layerUid}}]),e}(),function(e){function t(e){return e.hasOwnProperty("splatSize")}e.isInstanceOfNode=t}(e.PointRenderer||(e.PointRenderer={})),Object.defineProperty(e,"__esModule",{value:!0})}));
