/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/PooledArray","../../../../core/promiseUtils","../../../../chunks/vec3","../../../../chunks/vec4f64","./I3SNode","./I3SUtil","../../support/orientedBoundingBox"],(function(e,t,i,n,s,o,r,a,d,l){"use strict";let h=function(e,t,i,n,s){this.childOffset=e,this.childCount=t,this.visibilityCache=i,this.ref=n,this.node=s,this.useAsHole=0,this.filterImpact=a.NodeFilterImpact.NotChecked},u=function(){function e(e,t,i,s,o,r,d,l,h,u,c,g,f,v){this._streamDataController=i,this._viewportQueries=s,this._logger=o,this.holeFilling=r,this._isLoaded=d,this._isReloading=l,this._isSelected=h,this._enable=u,this._needsUpdate=c,this._canRequest=g,this._computeVisibilityObb=f,this._computeNodeFiltering=v,this._dirty=!0,this._nodePages=[],this._nodeCount=0,this._nodesPerPage=0,this._rootIndex=0,this._lodMetric=a.LodMetric.None,this._lodConversion=e=>e,this._urlPrefix="",this._loading=new Set,this._failedNodes=new Set,this._failedPages=new Set,this._indexMissing=1,this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.POSITIVE_INFINITY,this._nodeTraversalState=new Map,this._version=m(0),this._visibilityCacheVersion=m(0),this._maxLevel=1,this._featureEstimate={estimate:0,leavesReached:!1},this._unloadedMemoryEstimate=0,this._missing=new n({deallocator:null}),this._prefetch=new n({deallocator:null}),this._updates=new _(this._missing),this._imModificationUncategorized=new n({deallocator:null}),this.ignoreServiceObb=!1,this.progressiveLoadPenalty=0,this._pageQueue=[],this.needNodeElevationRange=!1,this.layerHasModifications=!1,this._layerHasFilter=!1,this._logLayer=e,e.serviceUpdateTimeStamp&&e.serviceUpdateTimeStamp.lastUpdate&&(this._lastUpdate=`${e.serviceUpdateTimeStamp.lastUpdate}`),this._maxLodLevel=this._viewportQueries?this._viewportQueries.maxLodLevel:1,this._init(t)}var u=e.prototype;return u._init=function(e){if("page"===e.type){switch(this._urlPrefix=e.urlPrefix,this._nodesPerPage=e.pageSize,this._rootIndex=e.rootIndex,e.lodMetric){case"maxScreenThreshold":this._lodMetric=a.LodMetric.MaxScreenThreshold;break;case"maxScreenThresholdSQ":this._lodMetric=a.LodMetric.MaxScreenThreshold,this._lodConversion=S}this._addPage(N(this._rootIndex,this._nodesPerPage),e.rootPage),this._updateParentsAndLevel()}else if("node"===e.type){this._urlPrefix=e.urlPrefix,this._nodePages.push({nodes:[],children:[],parents:[]}),this._makeRefNode(new a.NodeBase(e.rootNode.id,null),-1);const t=this._validateNode(e.rootNode.id,e.rootNode);t&&this._addNode(t,0)}},u._loadPage=function(e){this._loading.add(e);const t=this._urlPrefix+e;this._streamDataController.request(t,"json").then((t=>{this._pageQueue.push({pageIndex:e,page:t})})).catch((t=>{this._loading.delete(e),s.isAbortError(t)||(this._failedPages.add(e),this._logger.error("#loadPage()",this._logLayer,`Error when loading page ${e}`,t))}))},u._addQueuedPages=function(e){for(;this._pageQueue.length>0&&!e.done;){const{pageIndex:t,page:i}=this._pageQueue.shift();this._addPage(t,i),this._loading.delete(t),e.madeProgress()}this._updateParentsAndLevel()},u._addPage=function(e,t){for(let o=this._nodePages.length;o<e;o++)this._nodePages[o]=null;const i=[],n=[],s=t.nodes.map(((t,s)=>{const d=i.length,u=t.children?t.children.length:0;n.push(-1);for(let e=0;e<u;e++)i.push(t.children[e]);const c=`${t.index}`,_=l.clone(t.obb),g=r.fromArray([_.center[0],_.center[1],_.center[2],o.length(_.halfSize)]),m=t.mesh&&t.mesh.attribute,v=t.mesh&&t.mesh.geometry,b=t.mesh&&t.mesh.material,p={hasSharedResource:!1,hasFeatureData:!!v,attributes:m&&null!=m.resource?`${m.resource}`:void 0,geometry:v&&null!=v.resource?`${v.resource}`:void 0,texture:b&&null!=b.resource?`${b.resource}`:void 0,geometryDefinition:v?v.definition:-1,materialDefinition:b?b.definition:-1},N=new a.Node(c,e*this._nodesPerPage+s,g,u,0,p,this._lastUpdate,this._lodMetric,this._lodConversion(t.lodThreshold),v?v.featureCount:null);return N.serviceObb=_,N.visibilityObb=this._computeVisibilityObb(N),N.vertexCount=v?v.vertexCount:0,new h(d,u,f(this._visibilityCacheVersion),null,N)}));this._nodePages[e]={nodes:s,children:i,parents:n},this._nodeCount+=s.length},u._updateParentsAndLevel=function(){const e=new Array,t=(t,n,s)=>{const o=this._getPage(t);if(i.isSome(o)){const r=y(t,this._nodesPerPage);o.parents[r]=n;const a=o.nodes[r].node;i.isSome(a)&&(a.level=s,e.push(t))}};for(t(this._rootIndex,-1,0);e.length;){const n=e.pop(),s=this.getNode(n);if(i.isSome(s))for(let e=0;e<s.childCount;e++){t(this.getChildIndex(s.index,e),n,s.level+1),this._maxLevel=Math.max(this._maxLevel,s.level+1)}}},u._getPage=function(e){return this._nodePages[N(e,this._nodesPerPage)]},u._getNodeInternal=function(e){const t=this._getPage(e);return i.isNone(t)?null:t.nodes[y(e,this._nodesPerPage)]},u._addNode=function(e,t){null!=e.children&&this.populateChildren(t,e.children);const n=this.getParent(t),s=i.isSome(n)?n.level+1:0;this._maxLevel=Math.max(this._maxLevel,e.children?s+1:s);const{lodMetric:o,maxError:d}=x(e.lodSelection),h=i.unwrap(this._getNodeInternal(t));return h.node=new a.Node(e.id,t,r.fromArray(e.mbs),h.childCount,s,e.resources,e.version,o,d,e.numFeatures),e.obb&&(h.node.serviceObb=l.clone(e.obb)),h.node.visibilityObb=this._computeVisibilityObb(h.node),i.isSome(h.ref)&&(null==h.ref.mbs&&(h.ref.mbs=e.mbs),h.node.renderMbs=h.ref.renderMbs,h.node.serviceObbInRenderSR=h.ref.serviceObbInRenderSR,h.ref.visibilityObb=h.node.visibilityObb),h.node},u._makeRefNode=function(e,t){const i=this._nodePages[0];if(null==i)return-1;const n=i.nodes.length;return i.nodes.push(new h(0,0,f(this._visibilityCacheVersion),e,null)),this._nodeCount++,i.parents.push(t),d.invalidateMbs(e.renderMbs),d.invalidateObb(e.serviceObbInRenderSR),n},u.populateChildren=function(e,t){const n=i.unwrap(this._getNodeInternal(e)),s=i.unwrap(this._getPage(e));n.childOffset=s.children.length,n.childCount=t.length;for(let i=0;i<t.length;i++){const n=this._makeRefNode(t[i],e);s.children.push(n)}},u.getNode=function(e){const t=this._getNodeInternal(e);return i.isSome(t)?t.node:null},u.getIndexById=function(e){let t;return this._forAllNodes(((n,s)=>{(i.isSome(n.node)&&n.node.id===e||i.isSome(n.ref)&&n.ref.id===e)&&(t=s)})),t},u.getNodeById=function(e){const t=this.getIndexById(e);return null!=t&&t>=0?this.getNode(t):null},u.getChildIndex=function(e,t){const n=this._getPage(e);if(i.isNone(n))return-1;const s=n.nodes[y(e,this._nodesPerPage)];return n.children[s.childOffset+t]},u.getParentIndex=function(e){const t=this._getPage(e);return i.isSome(t)?t.parents[y(e,this._nodesPerPage)]:-1},u.getParent=function(e){return(e=this.getParentIndex(e))>=0?this.getNode(e):null},u.isLeaf=function(e){const t=this._getNodeInternal(e);return i.isSome(t)&&0===t.childCount},u.removeAllGeometryObbs=function(){this._forAllNodes((e=>{i.isSome(e.node)&&(e.node.geometryObb=null)}))},u.invalidateVisibilityCache=function(){this._visibilityCacheVersion=m(this._visibilityCacheVersion)},u.invalidateNodeVisibilityCache=function(e){const t=this._getNodeInternal(e);i.isSome(t)&&this.invalidateNodeVisibilityCacheInternal(t)},u.invalidateNodeVisibilityCacheInternal=function(e){e.visibilityCache=f(this._visibilityCacheVersion)},u.invalidateBoundingVolumeCache=function(e){const t=this._getNodeInternal(e);i.isSome(t)&&(g(t),this.invalidateNodeVisibilityCacheInternal(t))},u.updateElevationChanged=function(e){const t=this._getNodeInternal(e);if(i.isNone(t))return;if(!this.needNodeElevationRange)return void this.invalidateBoundingVolumeCache(e);const n=i.isSome(t.node)?t.node:t.ref;if(i.isNone(n))return;const s=n.elevationRange;i.isNone(s)||(s.valid=!1)},u.invalidateGeometryVisibility=function(e){const t=this._getNodeInternal(e);i.isSome(t)&&i.isSome(t.node)&&(t.node.geometryObb=null,d.invalidateMbs(t.node.renderMbs),d.invalidateObb(t.node.serviceObbInRenderSR))},u.invalidateVisibilityObbs=function(){i.isNone(this.rootNode)||this.traverse(this.rootNode,(e=>(e.visibilityObb=this._computeVisibilityObb(e),e.geometryObb=null,!0)))},u._updateElevationRange=function(e){const t=this._getNodeInternal(e);if(i.isNone(t))return null;const n=i.isSome(t.node)?t.node:t.ref;if(i.isNone(n))return null;const s=n.elevationRange;if(i.isSome(s)&&s.valid)return s;const o=new a.ElevationRange;let r=!1;for(let a=0;a<t.childCount;a++){const t=this._updateElevationRange(this.getChildIndex(e,a));i.isNone(t)?r=!0:(o.min=Math.min(o.min,t.min),o.max=Math.max(o.max,t.max))}if(0===t.childCount||r&&i.isSome(t.node)&&t.node.resources.geometry){const e=this._viewportQueries.getElevationRange(n);i.isSome(e)&&(o.min=Math.min(o.min,e.min),o.max=Math.max(o.max,e.max))}return i.isSome(s)&&s.min===o.min&&s.max===o.max?(s.valid=!0,s):(o.valid=!0,n.elevationRange=o,this.invalidateBoundingVolumeCache(e),o)},u.isNodeVisible=function(e){const t=this._getNodeInternal(e);if(i.isNone(t)||i.isSome(t.ref)&&!t.ref.mbs)return!0;if(this.needNodeElevationRange&&this._updateElevationRange(e),!b(t.visibilityCache,this._visibilityCacheVersion)){const e=t.node,n=i.isSome(e)&&(i.isNone(t.ref)||i.isSome(e.visibilityObb))?e:i.isSome(t.ref)?t.ref:null;if(this._layerHasFilter&&this._computeNodeFiltering&&(i.isSome(e)||i.isSome(t.ref))&&t.filterImpact===a.NodeFilterImpact.NotChecked){const n=i.isSome(e)?e.mbs:i.isSome(t.ref)?t.ref.mbs:null;t.filterImpact=null!=n?this._computeNodeFiltering(n):a.NodeFilterImpact.Unmodified}const s=i.isSome(e)&&t.filterImpact===a.NodeFilterImpact.Culled,o=!(i.isSome(e)&&e.imModificationImpact===a.NodeIMModificationImpact.Culled)&&(!n||this._viewportQueries.isNodeVisible(n))&&!s;return t.visibilityCache=v(o,this._visibilityCacheVersion),o}return p(t.visibilityCache)},u.isGeometryVisible=function(e){if(!this.isNodeVisible(e))return!1;const t=this._getNodeInternal(e);return!(i.isSome(t)&&i.isSome(t.node)&&i.isSome(t.node.geometryObb)&&(!this.layerHasModifications||t.node.imModificationImpact!==a.NodeIMModificationImpact.NotChecked))||this._viewportQueries.isGeometryVisible(t.node)},u._traverseCoverage=function(e,t,n,s,o){const r=this._getPage(e);if(i.isNone(r)||0===t.childCount)return;const a=t.childOffset+t.childCount,d=new Array;for(let l=t.childOffset;l<a;++l){const e=r.children[l],t=this._getNodeInternal(e);i.isSome(t)&&i.isSome(t.node)&&this.isGeometryVisible(e)&&d.push(t)}s/=d.length;for(const l of d){const e=i.unwrap(l.node).index;this._isLoaded(e)||this._isReloading(e)?(o.delta=Math.max(o.delta,n),o.coverage+=s):this._traverseCoverage(e,l,n+1,s,o)}},u.useNodeAsHole=function(e){if("off"===this.holeFilling)return!1;const t=this._getNodeInternal(e);if(i.isNone(t))return!1;if("always"===this.holeFilling)return!0;if(b(t.useAsHole,this._version))return p(t.useAsHole);const n={delta:0,coverage:0};this._traverseCoverage(e,t,0,1,n);const s=n.delta*n.coverage<=.5;return t.useAsHole=v(s,this._version),s},u.destroy=function(){this._updates.add.prune(),this._updates.update.prune()},u.requestUpdate=function(){this._dirty=!0,this._indexMissing=1,this._version=m(this._version)},u.imModificationsChanged=function(e){this.layerHasModifications=e,this._forAllNodes((({node:e})=>{i.isSome(e)&&(e.imModificationImpact=a.NodeIMModificationImpact.NotChecked,e.visibilityObb=this._computeVisibilityObb(e),e.hasModifications&&this.invalidateGeometryVisibility(e.index))})),this.invalidateVisibilityCache()},u.layerFilterChanged=function(e){this._layerHasFilter=e,this._forAllNodes((e=>{if(i.isSome(e)){e.filterImpact=a.NodeFilterImpact.NotChecked;const t=e.node;i.isSome(t)&&this.invalidateNodeVisibilityCache(t.index)}})),this.invalidateVisibilityCache()},u.update=function(e,t,n){if(!this._dirty)return;this._pageQueue.length>0&&this._addQueuedPages(t),this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.NEGATIVE_INFINITY,this._missing.clear(),this._prefetch.clear(),this._updates.reset(e),c.clear();let s=!0;const o=new I,r=new I,d=this._imModificationUncategorized;d.clear();const l=new Set,h=(h,u,_)=>{if(i.isNone(u)){let e=this._entryPriority(h);e===1/0&&(e=this._entryPriority(_));const t=N(h,this._nodesPerPage);return c.set(t,Math.max(e,c.get(t)||0)),this._loading.has(t)||this._failedPages.has(t)||this._missing.push(t),void(this._maxProcessingPrio=Math.max(this._maxProcessingPrio,e))}const g=u.node;if(this._updateNodeFeatureEstimate(g,r),i.isNone(g)){const e=this._entryPriority(h);return this._loading.has(h)||this._failedNodes.has(h)||(this._missing.push(h),c.set(h,e)),void(this._maxProcessingPrio=Math.max(this._maxProcessingPrio,e))}const f=i.unwrap(this._getPage(h));if(0===this._missing.length&&0===this._nodesPerPage)for(let e=0;e<u.childCount;e++){const t=f.children[u.childOffset+e],n=this._getNodeInternal(t);!i.isSome(n)||n.node||this._loading.has(t)||this._failedNodes.has(t)||(c.set(t,this._entryPriority(t)),this._prefetch.push(t))}if(g.failed||!g.resources.hasFeatureData)return void(s&&u.childCount>0&&this._isSelected(g)&&(s=!1));if(l.add(g.id),this._isLoaded(h)){if(o.known+=g.memory,++o.knownNodes,this._isSelected(g)?u.childCount>0&&(s=!1):(o.unremoved+=g.memory,s=!1),this._needsUpdate(g)){const e=this._entryPriority(h);c.set(h,e),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,e),this._updates.update.push(h)}return}if(g.memory&&(o.known+=g.memory,++o.knownNodes),!this._isSelected(g))return void(this._isReloading(h)&&this._updates.remove.push(h));if(u.childCount>0&&(s=!1),g.memory?(o.missing+=g.memory,o.known+=g.memory,++o.knownNodes):++o.missingNodes,e.includes(g.index))return this._maxProcessingPrio=Math.max(this._maxProcessingPrio,this._entryPriority(h)),void(this._updates.cancel=this._updates.cancel.filter((e=>e!==g.index)));if(!t.done&&this._enable(g))return void t.madeProgress();const m=this._entryPriority(h);c.set(h,m),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,m),this._updates.add.push(h),this.layerHasModifications&&n&&i.isSome(g)&&g.imModificationImpact===a.NodeIMModificationImpact.NotChecked&&d.push(h)};this.traverseVisible(h);const u=this._updates.add;u.length>0&&this.layerHasModifications&&(d.length>0&&n?.(d),u.filterInPlace((e=>{const t=this._getNodeInternal(e),n=i.isNone(t)||i.isNone(t.node)||t.node.imModificationImpact!==a.NodeIMModificationImpact.Culled;return n||this.invalidateNodeVisibilityCache(e),n}))),this._unloadedMemoryEstimate=o.missing-o.unremoved,o.knownNodes>3&&o.missingNodes>0&&(this._unloadedMemoryEstimate+=o.known/o.knownNodes*o.missingNodes),this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate),this._featureEstimate.estimate=this._computeFeatureEstimate(r),this._featureEstimate.leavesReached=s,this._missing.sort(((e,t)=>e-t)),this._missing.filterInPlace(((e,t)=>t<1||this._missing.data[t-1]!==e)),this._missing.sort(((e,t)=>c.get(e)-c.get(t))),this._missing.length>0&&(this._maxUnloadedPrio=c.get(this._missing.back()),this._prefetch.clear()),this._updates.add.filterInPlace((e=>c.get(e)>=this._maxUnloadedPrio)).sort(((e,t)=>c.get(e)-c.get(t))),this._updates.update.sort(((e,t)=>c.get(e)-c.get(t))),this._indexMissing=this._loading.size+this._missing.length,this._dirty=this._indexMissing>0,c.clear()},u.checkFeatureTarget=function(e,t){const i=this._viewportQueries.updateScreenSpaceErrorBias(t);let n=t,s=t,o=i,r=10;for(;r--;){const i=new I;this._updateFeatureEstimate(n,i);if(this._computeFeatureEstimate(i)<=e){if(n>=t||i.missingNodes>0||0===r)break;o=n,n=.5*(n+s)}else s=n,n=.5*(n+o)}return this._version=m(this._version),this._viewportQueries.updateScreenSpaceErrorBias(i),Math.min(t,n)},u._updateFeatureEstimate=function(e,t){this._version=m(this._version),this._viewportQueries.updateScreenSpaceErrorBias(e),this.traverseVisible(((e,n)=>this._updateNodeFeatureEstimate(i.isSome(n)?n.node:void 0,t)))},u._updateNodeFeatureEstimate=function(e,t){if(!(i.isNone(e)||e.failed||i.isNone(e.numFeatures)))return this._isLoaded(e.index)?(t.known+=e.numFeatures,++t.knownNodes,void(this._isSelected(e)||(t.unremoved+=e.numFeatures))):void(this._isSelected(e)&&(i.isSome(e.numFeatures)?(t.missing+=e.numFeatures,t.known+=e.numFeatures,++t.knownNodes):++t.missingNodes))},u._computeFeatureEstimate=function(e){let t=e.known-e.unremoved;return e.knownNodes>3&&e.missingNodes>0&&(t+=e.known/e.knownNodes*e.missingNodes),Math.max(0,t)},u.load=function(){return this._load(this._missing)},u.prefetch=function(){return this._prefetch.sort(((e,t)=>c.get(e)-c.get(t))),this._load(this._prefetch)},u._load=function(e){if(0===e.length||!this._canRequest())return!1;for(;e.length>0&&this._canRequest();)0===this._nodesPerPage?this._loadNode(e.pop()):this._loadPage(e.pop());return!0},u.nodeTraversalState=function(e){if(i.isNone(e))return null;let t=this._nodeTraversalState.get(e.index);if(t&&b(t.version,this._version))return t;const n=this._viewportQueries.getLodLevel(e),s=this._viewportQueries.hasLOD(e);let o=!0;if(s){const t=this.getParentIndex(e.index);if(t>=0){const e=this._nodeTraversalState.get(t);o=!!e&&n>e.lodLevel}else o=n>0}else o=0===e.childCount;return t?(t.lodLevel=n,t.isChosen=o,t.version=v(!0,this._version),t):(t=new a.NodeTraversalState(s,o,n,v(!0,this._version)),this._nodeTraversalState.set(e.index,t),t)},u._loadNode=function(e){this._loading.add(e);const t=i.unwrap(this._getNodeInternal(e)).ref;if(i.isNone(t))return void this._failedNodes.add(e);const n=t.id,o=this._urlPrefix+n,r=()=>{this._loading.delete(e),0===this._missing.length&&0===this._loading.size&&this.requestUpdate()};this._streamDataController.request(o,"json").then((t=>{r();const i=this._validateNode(n,t);if(null==i)return;i.obb&&this.invalidateNodeVisibilityCache(e);const s=this._addNode(i,e);this.nodeTraversalState(s)}),(t=>{r(),s.isAbortError(t)||(this._logger.error("#loadNode()",this._logLayer,"Error loading node: "+o),this._failedNodes.add(e))}))},u._validateNode=function(e,t){if(null==t||"object"!=typeof t||t.id!==e)return this._logger.error("#validateNode()",this._logLayer,`Invalid node. Wrong type or wrong id "${e}"`),null;if(!Array.isArray(t.mbs))return this._logger.error("#validateNode()",this._logLayer,`Invalid bounding volume on node ${e}.`),null;t.sharedResource&&"./shared"!==t.sharedResource.href&&"./shared/"!==t.sharedResource.href&&this._logger.warn("#validateNode()",this._logLayer,`Invalid shared resource href on node "${e}"`),null==t.geometryData||Array.isArray(t.geometryData)&&1===t.geometryData.length&&"./geometries/0"===t.geometryData[0].href||this._logger.warn("#validateNode()",this._logLayer,`Invalid geometry data on node "${e}"`),null==t.attributeData||Array.isArray(t.attributeData)&&!t.attributeData.some(((e,t)=>e.href!==`./attributes/f_${t}/0`))||this._logger.warn("#validateNode()",this._logLayer,`Invalid attribute data on node "${e}"`),t.featureData&&t.featureData.length>1&&this._logger.warn("#validateNode()",this._logLayer,`Node ${e} has ${t.featureData.length} bundles. Only the first bundle will be loaded.`);const i=t.hasOwnProperty("obb")&&!this.ignoreServiceObb?t.obb:null,n=t.featureData&&1===t.featureData.length&&t.featureData[0].featureRange?t.featureData[0].featureRange[1]-t.featureData[0].featureRange[0]+1:void 0,s=t=>{if(null==t)return null;const i=t=>this._logger.error("#validateNode()",this._logLayer,`Invalid node reference on node ${e}: ${t}`);if("number"==typeof t.id)i(`id ${t.id} is a number instead of a string.`);else if("string"!=typeof t.id||!Array.isArray(t.mbs))return i("Missing or invalid id."),null;if(!Array.isArray(t.mbs))return i(`Invalid bounding volume on reference ${t.id}.`),null;t.href&&t.href!=="../"+t.id&&this._logger.error("#validateNode()",this._logLayer,`Invalid node href on node "${e}"`);const n=t.hasOwnProperty("obb")&&!this.ignoreServiceObb?t.obb:null,s=new a.NodeBase(`${t.id}`,t.mbs);return s.serviceObb=n,s.visibilityObb=this._computeVisibilityObb(s),s},o=Array.isArray(t.children)?t.children.map(s).filter((e=>null!=e)):null;return{id:e,mbs:t.mbs,obb:i,children:o,resources:{hasFeatureData:t.featureData&&t.featureData.length>0,hasSharedResource:null!=t.sharedResource,attributes:t.attributeData?e:void 0,texture:t.textureData&&t.textureData.length>0?e:void 0,geometry:null!=t.geometryData?e:void 0},version:"string"==typeof t.version?t.version:null,lodSelection:Array.isArray(t.lodSelection)?t.lodSelection:null,numFeatures:n}},u.resetFailedNodes=function(){this._failedNodes.clear(),this._failedPages.clear(),this._forAllNodes((e=>{i.isSome(e.node)&&(e.node.failed=!1)}))},u._entryPriority=function(e){const t=this._getNodeInternal(e),n=this.getParentIndex(e);if(i.isNone(t)||n<0&&null==t.node)return n<0?1/0:this._entryPriority(n);let s=0;if(t.node&&n>=0){const e=this._nodeTraversalState.get(n);null!=e&&(s=e.lodLevel)}let o=this.progressiveLoadPenalty;for(let i=e;i>=0;i=this.getParentIndex(i))if(this._isLoaded(i)){o=0;break}const r=i.isSome(t.ref)?this._viewportQueries.distToPOI(t.ref):i.isSome(t.node)?this._viewportQueries.distToPOI(t.node):0;return-r-s*(r+this.progressiveLoadPenalty)+o},u.traverseVisible=function(e){const t=this._getNodeInternal(this._rootIndex);i.isNone(t)?e(this._rootIndex,null,null):this._traverseVisible(this._rootIndex,-1,t,e)},u._traverseVisible=function(e,t,n,s){if(n.node&&0===n.childCount)return void(this.isGeometryVisible(e)&&s(e,n,t));if(!this.isNodeVisible(e))return;if(s(e,n,t),null==n.node)return;const o=this.nodeTraversalState(n.node);if(o?.nodeHasLOD&&o.lodLevel===this._maxLodLevel)return;const r=i.unwrap(this._getPage(e));for(let a=0;a<n.childCount;a++){const t=r.children[n.childOffset+a],o=this._getNodeInternal(t);i.isSome(o)?this._traverseVisible(t,e,o,s):s(t,null,e)}},u.traverse=function(e,t){t(e)&&this.traverseChildren(e,t)},u.traverseChildren=function(e,t){const n=e.index,s=this._getNodeInternal(n);i.isSome(s)&&this._traverseChildren(n,s,t)},u._traverseChildren=function(e,t,n){const s=this._getPage(e);if(i.isNone(s))return;const o=t.childOffset+t.childCount;for(let r=t.childOffset;r<o;++r){const e=s.children[r],t=this._getNodeInternal(e);i.isSome(t)&&i.isSome(t.node)&&n(t.node)&&this._traverseChildren(e,t,n)}},u.updateChildrenLoaded=function(e,t){let n=this.getNode(e);for(;i.isSome(n);)n.childrenLoaded+=t,n=this.getParent(n.index)},u.checkChildrenLoadedInvariant=function(){if(i.isNone(this.rootNode))return!0;const e=[],t=i=>{let n=this._isLoaded(i.index)||this._isReloading(i.index)?1:0;return this.traverseChildren(i,(e=>(n+=t(e),!1))),i.childrenLoaded!==n&&e.push(i.index),n};return t(this.rootNode),e.length&&this._logger.error("childrenLoaded invariant broken at following nodes: "+e.join(",")),e.length>0},u.updateStats=function(e){if(this._updates.add.length>0&&(e.nodes+=" + "+this._updates.add.length),(this._indexMissing||this._prefetch.length>0)&&(e.index+=" + "+this._indexMissing||this._prefetch.length),e.prio=this._maxProcessingPrio,this._featureEstimate.estimate){const t=this._featureEstimate.estimate-e.features;t>0?e.features+=" + "+t:t<0&&(e.features+=" - "+-t)}},u.updateElevationInfo=function(e,t){this.needNodeElevationRange=t&&!!e&&("relative-to-ground"===e.mode||"on-the-ground"===e.mode),this._viewportQueries.updateElevationInfo(e),this.invalidateAllElevationRanges()},u.invalidateAllElevationRanges=function(){this._forAllNodes((e=>{g(e),i.isSome(e.node)&&(e.node.elevationRange=null),i.isSome(e.ref)&&(e.ref.elevationRange=null)}))},u._forAllNodes=function(e){for(let t=0;t<this._nodePages.length;t++){const i=this._nodePages[t];if(i){const n=t*this._nodesPerPage;for(let t=0;t<i.nodes.length;t++)e(i.nodes[t],n+t)}}},t._createClass(e,[{key:"rootNode",get:function(){return this.getNode(this._rootIndex)}},{key:"size",get:function(){return this._nodeCount}},{key:"maxLevel",get:function(){return this._maxLevel}},{key:"dirty",get:function(){return this._dirty}},{key:"isLoading",get:function(){return this._indexMissing>0}},{key:"isPrefetching",get:function(){return this._prefetch.length>0}},{key:"indexLoading",get:function(){return this._loading.size}},{key:"indexMissing",get:function(){return this._indexMissing}},{key:"unloadedMemoryEstimate",get:function(){return this._unloadedMemoryEstimate}},{key:"updates",get:function(){return this._updates}},{key:"featureEstimate",get:function(){return this._featureEstimate}},{key:"maxPriority",get:function(){return Math.max(this._maxProcessingPrio,this._maxUnloadedPrio)}},{key:"test",get:function(){return{addNode:(e,t)=>this._addNode(e,t)}}}]),e}();const c=new Map;let _=function(){function e(e){this.missing=e,this.update=new n({deallocator:null}),this.add=new n({deallocator:null}),this.remove=new n({deallocator:null}),this.cancel=[]}return e.prototype.reset=function(e){this.add.clear(),this.update.clear(),this.cancel=e},e}();function g(e){i.isSome(e.node)&&(d.invalidateMbs(e.node.renderMbs),d.invalidateObb(e.node.serviceObbInRenderSR)),i.isSome(e.ref)&&(d.invalidateMbs(e.ref.renderMbs),d.invalidateObb(e.ref.serviceObbInRenderSR))}function f(e){return d.addWraparound(e,-2)}function m(e){return d.addWraparound(e,2)}function v(e,t){return t+(e?1:0)}function b(e,t){return(-2&e)===t}function p(e){return 1==(1&e)}function N(e,t){return 0===t?0:e/t|0}function y(e,t){return 0===t?e:e%t}const P=[["maxScreenThreshold",a.LodMetric.MaxScreenThreshold],["screenSpaceRelative",a.LodMetric.ScreenSpaceRelative],["removedFeatureDiameter",a.LodMetric.RemovedFeatureDiameter],["distanceRangeFromDefaultCamera",a.LodMetric.DistanceRangeFromDefaultCamera]];function x(e){if(e)for(let t=0;t<e.length;t++)for(const i of P)if(i[0]===e[t].metricType)return{lodMetric:i[1],maxError:e[t].maxError};return{lodMetric:a.LodMetric.None,maxError:0}}let I=function(){this.known=0,this.knownNodes=0,this.missing=0,this.missingNodes=0,this.unremoved=0};function S(e){return Math.sqrt(e*(4/Math.PI))}e.I3SIndex=u,e.selectErrorMetric=x,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
