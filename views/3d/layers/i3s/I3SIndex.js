// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","../../../../core/maybe","../../../../core/PooledArray","../../../../core/promiseUtils","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec4f64","./I3SNode","./I3SUtil","../../support/orientedBoundingBox"],(function(e,t,i,r,n,o,s,a,d,l){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.selectErrorMetric=t.I3SIndex=void 0;var h=function(e,t,i,r,n){this.childOffset=e,this.childCount=t,this.visibilityCache=i,this.ref=r,this.node=n,this.useAsHole=0},u=function(){function e(e,t,i,n,o,s,a,d,l,h,u,c){this.streamDataController=t,this.viewportQueries=i,this.logger=n,this.holeFilling=o,this._isLoaded=s,this._isReloading=a,this._isSelected=d,this._enable=l,this._needsUpdate=h,this._canRequest=u,this._computeVisibilityObb=c,this._dirty=!0,this._nodePages=[],this.nodeCount=0,this.nodesPerPage=0,this.rootIndex=0,this.lodMetric=0,this.lodConversion=function(e){return e},this._loading=new Set,this._failedNodes=new Set,this._failedPages=new Set,this._indexMissing=1,this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.POSITIVE_INFINITY,this._nodeTraversalState={},this._version=m(0),this._visibilityCacheVersion=m(0),this._maxLevel=1,this._featureEstimate={estimate:0,leafsReached:!1},this._unloadedMemoryEstimate=0,this._missing=new r({deallocator:null}),this._prefetch=new r({deallocator:null}),this._updates=new f,this._imModificationUncategorized=new r({deallocator:null}),this.ignoreServiceObb=!1,this.progressiveLoadPenalty=0,this.layerHasModifications=!1,this.layerUrl=e.parsedUrl.path,this.rootId=e.rootNode&&e.rootNode.split("/").pop(),e.serviceUpdateTimeStamp&&e.serviceUpdateTimeStamp.lastUpdate&&(this.lastUpdate=""+e.serviceUpdateTimeStamp.lastUpdate),this._maxLodLevel=this.viewportQueries?this.viewportQueries.maxLodLevel:1;var g=e.nodePages;g?this.initNodePages(g):this.initNodeDocuments(this.rootId)}return e.prototype.initNodePages=function(e){switch(this.nodesPerPage=e.nodesPerPage,this.rootIndex=e.rootIndex,e.lodSelectionMetricType){case"maxScreenThreshold":this.lodMetric=1;break;case"maxScreenThresholdSQ":this.lodMetric=1,this.lodConversion=x}},e.prototype.initNodeDocuments=function(e){this.nodesPerPage=0,this.rootIndex=0,this._nodePages.push({nodes:[],children:[],parents:[]}),this.makeRefNode(new a.NodeBase(e,null),-1)},e.prototype.loadPage=function(e){var t=this;this._loading.add(e);var i=this.layerUrl+"/nodepages/"+e;this.streamDataController.request(i,"json").then((function(i){t._loading.delete(e),t.addPage(e,i)})).catch((function(i){if(t._loading.delete(e),!n.isAbortError(i)){if(0===t._nodePages.length)return t.initNodeDocuments(t.rootId);t._failedPages.add(e),t.logger.error("Error when loading page "+e,i)}}))},e.prototype.addPage=function(e,t){for(var i=this,r=this._nodePages.length;r<e;r++)this._nodePages[r]=null;var n=[],d=[],u=t.nodes.map((function(t,r){var u=n.length,c=t.children?t.children.length:0;d.push(-1);for(var f=0;f<c;f++)n.push(t.children[f]);var g=""+t.index,m=l.clone(t.obb),v=s.vec4f64.fromArray([m.center[0],m.center[1],m.center[2],o.vec3.length(m.halfSize)]),y=t.mesh&&t.mesh.attribute,_=t.mesh&&t.mesh.geometry,b=t.mesh&&t.mesh.material,P={hasSharedResource:!1,hasFeatureData:!!_,attributes:y&&null!=y.resource?""+y.resource:null,geometry:_&&null!=_.resource?""+_.resource:null,texture:b&&null!=b.resource?""+b.resource:null,geometryDefinition:_?_.definition:-1,materialDefinition:b?b.definition:-1},N=new a.Node(g,e*i.nodesPerPage+r,v,c,0,P,i.lastUpdate,i.lodMetric,i.lodConversion(t.lodThreshold),_?_.featureCount:null);return N.serviceObb=m,N.visibilityObb=i._computeVisibilityObb(N),N.vertexCount=_?_.vertexCount:0,new h(u,c,p(i._visibilityCacheVersion),null,N)}));this._nodePages[e]={nodes:u,children:n,parents:d},this.nodeCount+=u.length,this.updateParentsAndLevel()},e.prototype.updateParentsAndLevel=function(){var e=this,t=[],r=function(r,n,o){var s=e.getPage(r);if(i.isSome(s)){var a=P(r,e.nodesPerPage);s.parents[a]=n;var d=s.nodes[a].node;i.isSome(d)&&(d.level=o,t.push(r))}};for(r(this.rootIndex,-1,0);t.length;){var n=t.pop(),o=this.getNode(n);if(i.isSome(o))for(var s=0;s<o.childCount;s++){r(this.getChildIndex(o,s),n,o.level+1)}}},e.prototype.getPage=function(e){return this._nodePages[b(e,this.nodesPerPage)]},e.prototype.getNodeInternal=function(e){var t=this.getPage(e);return i.isNone(t)?null:t.nodes[P(e,this.nodesPerPage)]},e.prototype.addNode=function(e,t){null!=e.children&&this.populateChildren(t,e.children);var r=this.getParent(t),n=i.isSome(r)?r.level+1:1;this._maxLevel=Math.max(this._maxLevel,n);var o=S(e.lodSelection),d=o.lodMetric,h=o.maxError,u=i.unwrap(this.getNodeInternal(t));return u.node=new a.Node(e.id,t,s.vec4f64.fromArray(e.mbs),u.childCount,n,e.resources,e.version,d,h,e.numFeatures),e.obb&&(u.node.serviceObb=l.clone(e.obb)),u.node.visibilityObb=this._computeVisibilityObb(u.node),i.isSome(u.ref)&&(null==u.ref.mbs&&(u.ref.mbs=e.mbs),u.node.renderMbs=u.ref.renderMbs,u.node.serviceObbInRenderSR=u.ref.serviceObbInRenderSR,u.ref.visibilityObb=u.node.visibilityObb),u.node},e.prototype.makeRefNode=function(e,t){var r=this._nodePages[0],n=r.nodes.length;return r.nodes.push(new h(0,0,p(this._visibilityCacheVersion),e,null)),this.nodeCount++,r.parents.push(t),e.renderMbs[3]=-1,i.isSome(e.serviceObbInRenderSR)&&(e.serviceObbInRenderSR.halfSize[0]=-1),n},e.prototype.populateChildren=function(e,t){var r=i.unwrap(this.getNodeInternal(e)),n=i.unwrap(this.getPage(e));r.childOffset=n.children.length,r.childCount=t.length;for(var o=0;o<t.length;o++){var s=this.makeRefNode(t[o],e);n.children.push(s)}},e.prototype.getNode=function(e){var t=this.getNodeInternal(e);return i.isSome(t)?t.node:null},e.prototype.getIndexById=function(e){var t;return this.forAllNodes((function(r,n){i.isSome(r.node)&&r.node.id===e?t=n:i.isSome(r.ref)&&r.ref.id===e&&(t=n)})),t},e.prototype.getNodeById=function(e){var t=this.getIndexById(e);return t>=0?this.getNode(t):null},e.prototype.getChildIndex=function(e,t){var r=this.getPage(e.index);if(i.isNone(r))return-1;var n=r.nodes[P(e.index,this.nodesPerPage)];return r.children[n.childOffset+t]},e.prototype.getParentIndex=function(e){var t=this.getPage(e);return i.isSome(t)?t.parents[P(e,this.nodesPerPage)]:-1},e.prototype.getParent=function(e){return(e=this.getParentIndex(e))>=0?this.getNode(e):null},e.prototype.isLeaf=function(e){var t=this.getNodeInternal(e);return i.isSome(t)&&0===t.childCount},Object.defineProperty(e.prototype,"rootNode",{get:function(){return this.getNode(this.rootIndex)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"size",{get:function(){return this.nodeCount},enumerable:!1,configurable:!0}),e.prototype.invalidateVisibilityCache=function(){this._visibilityCacheVersion=m(this._visibilityCacheVersion)},e.prototype.invalidateNodeVisibilityCache=function(e){var t=this.getNodeInternal(e);i.isSome(t)&&this.invalidateNodeVisibilityCacheInternal(t)},e.prototype.invalidateNodeVisibilityCacheInternal=function(e){e.visibilityCache=p(this._visibilityCacheVersion)},e.prototype.invalidateBoundingVolumeCache=function(e){var t=this.getNodeInternal(e);i.isSome(t)&&(g(t),this.invalidateNodeVisibilityCacheInternal(t))},e.prototype.invalidateGeometryVisibility=function(e){var t=this.getNodeInternal(e);i.isSome(t)&&i.isSome(t.node)&&(t.node.geometryObb=null,t.node.renderMbs[3]=-1,i.isSome(t.node.serviceObbInRenderSR)&&(t.node.serviceObbInRenderSR.halfSize[0]=-1))},e.prototype.invalidateVisibilityObbs=function(){var e=this;i.isNone(this.rootNode)||this.traverse(this.rootNode,(function(t){return t.visibilityObb=e._computeVisibilityObb(t),t.geometryObb=null,!0}))},e.prototype.isNodeVisible=function(e){var t=this.getNodeInternal(e);if(i.isNone(t)||i.isSome(t.ref)&&!t.ref.mbs)return!0;if(!y(t.visibilityCache,this._visibilityCacheVersion)){var r=t.node,n=i.isSome(r)&&(i.isNone(t.ref)||i.isSome(r.visibilityObb))?r:i.isSome(t.ref)?t.ref:null,o=!(i.isSome(r)&&2===r.imModificationImpact)&&(!n||this.viewportQueries.isNodeVisible(n));return t.visibilityCache=v(o,this._visibilityCacheVersion),o}return _(t.visibilityCache)},e.prototype.isGeometryVisible=function(e){if(!this.isNodeVisible(e))return!1;var t=this.getNodeInternal(e);return!(i.isSome(t)&&i.isSome(t.node)&&i.isSome(t.node.geometryObb)&&(!this.layerHasModifications||4!==t.node.imModificationImpact))||this.viewportQueries.isGeometryVisible(t.node)},e.prototype._traverseCoverage=function(e,t,r,n,o){var s=this.getPage(e);if(!i.isNone(s)&&0!==t.childCount){for(var a=t.childOffset+t.childCount,d=new Array,l=t.childOffset;l<a;++l){var h=s.children[l],u=this.getNodeInternal(h);i.isSome(u)&&i.isSome(u.node)&&this.isGeometryVisible(h)&&d.push(u)}n/=d.length;for(var c=0,f=d;c<f.length;c++){u=f[c],h=i.unwrap(u.node).index;this._isLoaded(h)||this._isReloading(h)?(o.delta=Math.max(o.delta,r),o.coverage+=n):this._traverseCoverage(h,u,r+1,n,o)}}},e.prototype.useNodeAsHole=function(e){if("off"===this.holeFilling)return!1;var t=this.getNodeInternal(e);if(i.isNone(t))return!1;if("always"===this.holeFilling)return!0;if(y(t.useAsHole,this._version))return _(t.useAsHole);var r={delta:0,coverage:0};this._traverseCoverage(e,t,0,1,r);var n=r.delta*r.coverage<=.5;return t.useAsHole=v(n,this._version),n},Object.defineProperty(e.prototype,"maxLevel",{get:function(){return this._maxLevel},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"dirty",{get:function(){return this._dirty},enumerable:!1,configurable:!0}),e.prototype.destroy=function(){this._updates.add.prune(),this._updates.update.prune()},e.prototype.requestUpdate=function(){this._dirty=!0,this._indexMissing=1,this._version=m(this._version)},e.prototype.imModificationsChanged=function(e){var t=this;this.layerHasModifications=e,this.forAllNodes((function(e){var r=e.node;i.isSome(r)&&(r.imModificationImpact=4,r.visibilityObb=t._computeVisibilityObb(r),r.hasModifications&&t.invalidateGeometryVisibility(r.index))})),this.invalidateVisibilityCache()},e.prototype.update=function(e,t,r){var n=this;if(this._dirty){this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.NEGATIVE_INFINITY,this._missing.clear(),this._prefetch.clear(),this._updates.reset(e,this._missing),c.clear();var o=!0,s=new I,a=new I,d=this._imModificationUncategorized;d.clear();this.traverseVisible((function(l,h){if(!h){var u=n.entryPriority(l),f=b(l,n.nodesPerPage);return c.set(f,Math.max(u,c.get(f)||0)),n._loading.has(f)||n._failedPages.has(f)||n._missing.push(f),void(n._maxProcessingPrio=Math.max(n._maxProcessingPrio,u))}var g=h.node;if(n._updateNodeFeatureEstimate(g,a),i.isNone(g)){var p=n.entryPriority(l);return n._loading.has(l)||n._failedNodes.has(l)||(n._missing.push(l),c.set(l,p)),void(n._maxProcessingPrio=Math.max(n._maxProcessingPrio,p))}var m=i.unwrap(n.getPage(l));if(0===n._missing.length&&0===n.nodesPerPage)for(var v=0;v<h.childCount;v++){var y=m.children[h.childOffset+v],_=n.getNodeInternal(y);!i.isSome(_)||_.node||n._loading.has(y)||n._failedNodes.has(y)||(c.set(y,n.entryPriority(y)),n._prefetch.push(y))}if(!g.failed&&g.resources.hasFeatureData)if(n._isLoaded(l)){if(s.known+=g.memory,++s.knownNodes,n._isSelected(g)?h.childCount>0&&(o=!1):(s.unremoved+=g.memory,o=!1),n._needsUpdate(g)){var P=n.entryPriority(l);c.set(l,P),n._maxProcessingPrio=Math.max(n._maxProcessingPrio,P),n._updates.update.push(l)}}else if(g.memory&&(s.known+=g.memory,++s.knownNodes),n._isSelected(g)){if(h.childCount>0&&(o=!1),g.memory?(s.missing+=g.memory,s.known+=g.memory,++s.knownNodes):++s.missingNodes,e.indexOf(g.index)>=0)return n._maxProcessingPrio=Math.max(n._maxProcessingPrio,n.entryPriority(l)),void(n._updates.cancel=n._updates.cancel.filter((function(e){return e!==g.index})));if(t.done||!n._enable(g)){var N=n.entryPriority(l);c.set(l,N),n._maxProcessingPrio=Math.max(n._maxProcessingPrio,N),n._updates.add.push(l),n.layerHasModifications&&r&&i.isSome(h)&&i.isSome(h.node)&&4===h.node.imModificationImpact&&d.push(l)}else t.madeProgress()}else n._isReloading(l)&&n._updates.remove.push(l)}));var l=this._updates.add;l.length>0&&this.layerHasModifications&&(d.length>0&&r(d),l.filterInPlace((function(e){var t=n.getNodeInternal(e),r=i.isNone(t)||i.isNone(t.node)||2!==t.node.imModificationImpact;return r||n.invalidateNodeVisibilityCache(e),r}))),this._unloadedMemoryEstimate=s.missing-s.unremoved,s.knownNodes>3&&s.missingNodes>0&&(this._unloadedMemoryEstimate+=s.known/s.knownNodes*s.missingNodes),this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate),this._featureEstimate.estimate=this._computeFeatureEstimate(a),this._featureEstimate.leafsReached=o,this._missing.sort((function(e,t){return e-t})),this._missing.filterInPlace((function(e,t){return t<1||n._missing.data[t-1]!==e})),this._missing.sort((function(e,t){return c.get(e)-c.get(t)})),this._missing.length>0?(this._maxUnloadedPrio=c.get(this._missing.back()),this._prefetch.clear()):this._prefetch.sort((function(e,t){return c.get(e)-c.get(t)})),this._updates.add.filterInPlace((function(e){return c.get(e)>=n._maxUnloadedPrio})).sort((function(e,t){return c.get(e)-c.get(t)})),this._updates.update.sort((function(e,t){return c.get(e)-c.get(t)})),this._indexMissing=this._loading.size+this._missing.length,this._dirty=this._indexMissing>0,c.clear()}},e.prototype.checkFeatureTarget=function(e,t){for(var i=this.viewportQueries.updateScreenSpaceErrorBias(t),r=t,n=t,o=i,s=10;s--;){var a=new I;if(this._updateFeatureEstimate(r,a),this._computeFeatureEstimate(a)<=e){if(r>=t||a.missingNodes>0||0===s)break;o=r,r=.5*(r+n)}else n=r,r=.5*(r+o)}return this._version=m(this._version),this.viewportQueries.updateScreenSpaceErrorBias(i),Math.min(t,r)},e.prototype._updateFeatureEstimate=function(e,t){var i=this;this._version=m(this._version),this.viewportQueries.updateScreenSpaceErrorBias(e),this.traverseVisible((function(e,r){return i._updateNodeFeatureEstimate(r&&r.node,t)}))},e.prototype._updateNodeFeatureEstimate=function(e,t){if(!(i.isNone(e)||e.failed||i.isNone(e.numFeatures)))return this._isLoaded(e.index)?(t.known+=e.numFeatures,++t.knownNodes,void(this._isSelected(e)||(t.unremoved+=e.numFeatures))):void(this._isSelected(e)&&(i.isSome(e.numFeatures)?(t.missing+=e.numFeatures,t.known+=e.numFeatures,++t.knownNodes):++t.missingNodes))},e.prototype._computeFeatureEstimate=function(e){var t=e.known-e.unremoved;return e.knownNodes>3&&e.missingNodes>0&&(t+=e.known/e.knownNodes*e.missingNodes),Math.max(0,t)},e.prototype.load=function(){return this._load(this._missing)},e.prototype.prefetch=function(){return this._load(this._prefetch)},e.prototype._load=function(e){if(0===e.length||!this._canRequest())return!1;for(;e.length>0&&this._canRequest();)0===this.nodesPerPage?this._loadNode(e.pop()):this.loadPage(e.pop());return!0},e.prototype.isLoading=function(){return this._indexMissing>0},e.prototype.getIndexLoading=function(){return this._loading.size},e.prototype.getIndexMissing=function(){return this._indexMissing},e.prototype.getUnloadedMemoryEstimate=function(){return this._unloadedMemoryEstimate},Object.defineProperty(e.prototype,"updates",{get:function(){return this._updates},enumerable:!1,configurable:!0}),e.prototype.getFeatureEstimate=function(){return this._featureEstimate},e.prototype.nodeTraversalState=function(e){if(i.isNone(e))return null;var t=this._nodeTraversalState[e.index];if(t&&y(t.version,this._version))return t;var r=this.viewportQueries.getLodLevel(e),n=this.viewportQueries.hasLOD(e),o=!0;if(n){var s=this.getParentIndex(e.index);if(s>=0){var a=this._nodeTraversalState[s];o=a&&r>a.lodLevel}else o=r>0}else o=0===e.childCount;return t?(t.lodLevel=r,t.isChosen=o,t.version=v(!0,this._version),t):(this._nodeTraversalState[e.index]={nodeHasLOD:n,lodLevel:r,isChosen:o,version:v(!0,this._version)},this._nodeTraversalState[e.index])},e.prototype._loadNode=function(e){var t=this;this._loading.add(e);var r=i.unwrap(this.getNodeInternal(e)).ref;if(i.isNone(r))this._failedNodes.add(e);else{var o=r.id,s=this.layerUrl+"/nodes/"+o,a=function(){t._loading.delete(e),0===t._missing.length&&0===t._loading.size&&t.requestUpdate()};this.streamDataController.request(s,"json").then((function(i){var r=t._validateNode(o,i);if(null!=r){r.obb&&t.invalidateNodeVisibilityCache(e);var n=t.addNode(r,e);t.nodeTraversalState(n),a()}else a()}),(function(i){n.isAbortError(i)||(t.logger.error("Error loading node: "+s),t._failedNodes.add(e)),a()}))}},e.prototype._validateNode=function(e,t){var i=this;if(null==t||"object"!=typeof t||t.id!==e)return this.logger.error('Invalid node. Wrong type or wrong id "'+e+'"'),null;t.sharedResource&&"./shared"!==t.sharedResource.href&&"./shared/"!==t.sharedResource.href&&this.logger.warn('Invalid shared resource href on node "'+e+'"'),null==t.geometryData||Array.isArray(t.geometryData)&&1===t.geometryData.length&&"./geometries/0"===t.geometryData[0].href||this.logger.warn('Invalid geometry data on node "'+e+'"'),null==t.attributeData||Array.isArray(t.attributeData)&&!t.attributeData.some((function(e,t){return e.href!=="./attributes/f_"+t+"/0"}))||this.logger.warn('Invalid attribute data on node "'+e+'"'),t.featureData&&t.featureData.length>1&&this.logger.warn("Node "+e+" has "+t.featureData.length+" bundles. Only the first bundle will be loaded.");var r=t.hasOwnProperty("obb")&&!this.ignoreServiceObb?t.obb:null,n=t.featureData&&1===t.featureData.length&&t.featureData[0].featureRange?t.featureData[0].featureRange[1]-t.featureData[0].featureRange[0]+1:null,o=Array.isArray(t.children)?t.children.map((function(t){if(null==t)return null;var r=function(t){return i.logger.error("Invalid node reference on node "+e+": "+t)};if("number"==typeof t.id)r("id "+t.id+" is a number instead of a string.");else if("string"!=typeof t.id||!Array.isArray(t.mbs))return r("Missing or invalid id."),null;if(!Array.isArray(t.mbs))return r("Invalid bounding volume on reference "+t.id+"."),null;t.href&&t.href!=="../"+t.id&&i.logger.error('Invalid node href on node "'+e+'"');var n=t.hasOwnProperty("obb")&&!i.ignoreServiceObb?t.obb:null,o=new a.NodeBase(""+t.id,t.mbs);return o.serviceObb=n,o.visibilityObb=i._computeVisibilityObb(o),o})).filter((function(e){return null!=e})):null;return{id:e,mbs:t.mbs,obb:r,children:o,resources:{hasFeatureData:t.featureData&&t.featureData.length>0,hasSharedResource:null!=t.sharedResource,attributes:t.attributeData?e:null,texture:t.textureData&&t.textureData.length>0?e:null,geometry:null!=t.geometryData?e:null},version:"string"==typeof t.version?t.version:null,lodSelection:Array.isArray(t.lodSelection)?t.lodSelection:null,numFeatures:n}},e.prototype.resetFailedNodes=function(){this._failedNodes.clear(),this._failedPages.clear(),this.forAllNodes((function(e){i.isSome(e.node)&&(e.node.failed=!1)}))},e.prototype.entryPriority=function(e){var t=this.getNodeInternal(e),r=this.getParentIndex(e);if(i.isNone(t)||r<0&&null==t.node)return r<0?1/0:this.entryPriority(r);var n=0;if(t.node&&r>=0){var o=this._nodeTraversalState[r];null!=o&&(n=o.lodLevel)}for(var s=this.progressiveLoadPenalty,a=e;a>=0;a=this.getParentIndex(a))if(this._isLoaded(a)){s=0;break}var d=i.isSome(t.ref)?this.viewportQueries.distToPOI(t.ref):i.isSome(t.node)?this.viewportQueries.distToPOI(t.node):0;return-d-n*(d+this.progressiveLoadPenalty)+s},e.prototype.traverseVisible=function(e){var t=this.getNodeInternal(this.rootIndex);i.isNone(t)?e(this.rootIndex,null):this._traverseVisible(this.rootIndex,t,e)},e.prototype._traverseVisible=function(e,t,r){if(t.node&&0===t.childCount)this.isGeometryVisible(e)&&r(e,t);else if(this.isNodeVisible(e)&&(r(e,t),null!=t.node)){var n=this.nodeTraversalState(t.node);if(!n.nodeHasLOD||n.lodLevel!==this._maxLodLevel)for(var o=i.unwrap(this.getPage(e)),s=0;s<t.childCount;s++){var a=o.children[t.childOffset+s],d=this.getNodeInternal(a);i.isSome(d)?this._traverseVisible(a,d,r):r(a,null)}}},e.prototype.traverse=function(e,t){t(e)&&this.traverseChildren(e,t)},e.prototype.traverseChildren=function(e,t){var r=e.index,n=this.getNodeInternal(r);i.isSome(n)&&this._traverseChildren(r,n,t)},e.prototype._traverseChildren=function(e,t,r){var n=this.getPage(e);if(!i.isNone(n))for(var o=t.childOffset+t.childCount,s=t.childOffset;s<o;++s){var a=n.children[s],d=this.getNodeInternal(a);i.isSome(d)&&i.isSome(d.node)&&r(d.node)&&this._traverseChildren(a,d,r)}},e.prototype.updateStats=function(e){if(this._updates.add.length>0&&(e.nodes+=" + "+this._updates.add.length),(this._indexMissing||this._prefetch.length>0)&&(e.index+=" + "+this._indexMissing||this._prefetch.length),e.prio=this._maxProcessingPrio,this._featureEstimate.estimate){var t=this._featureEstimate.estimate-e.features;t>0?e.features+=" + "+t:t<0&&(e.features+=" - "+-t)}},e.prototype.getPriority=function(){return Math.max(this._maxProcessingPrio,this._maxUnloadedPrio)},e.prototype.updateElevationInfo=function(e){this.forAllNodes(g),this.viewportQueries.updateElevationInfo(e)},e.prototype.forAllNodes=function(e){for(var t=0;t<this._nodePages.length;t++){var i=this._nodePages[t];if(i)for(var r=t*this.nodesPerPage,n=0;n<i.nodes.length;n++)e(i.nodes[n],r+n)}},Object.defineProperty(e.prototype,"test",{get:function(){var e=this;return{addNode:function(t,i){return e.addNode(t,i)}}},enumerable:!1,configurable:!0}),e}();t.I3SIndex=u;var c=new Map,f=function(){function e(){this.update=new r({deallocator:null}),this.add=new r({deallocator:null}),this.remove=new r({deallocator:null}),this.cancel=[]}return e.prototype.reset=function(e,t){this.add.clear(),this.update.clear(),this.cancel=e,this.missing=t},e}();function g(e){i.isSome(e.node)&&(e.node.renderMbs[3]=-1,i.isSome(e.node.serviceObbInRenderSR)&&(e.node.serviceObbInRenderSR.halfSize[0]=-1)),i.isSome(e.ref)&&(e.ref.renderMbs[3]=-1,i.isSome(e.ref.serviceObbInRenderSR)&&(e.ref.serviceObbInRenderSR.halfSize[0]=-1))}function p(e){return d.addWraparound(e,-2)}function m(e){return d.addWraparound(e,2)}function v(e,t){return t+(e?1:0)}function y(e,t){return(-2&e)===t}function _(e){return 1==(1&e)}function b(e,t){return 0===t?0:e/t|0}function P(e,t){return 0===t?e:e%t}var N=[["maxScreenThreshold",1],["screenSpaceRelative",2],["removedFeatureDiameter",3],["distanceRangeFromDefaultCamera",4]];function S(e){if(e)for(var t=0;t<e.length;t++)for(var i=0,r=N;i<r.length;i++){var n=r[i];if(n[0]===e[t].metricType)return{lodMetric:n[1],maxError:e[t].maxError}}return{lodMetric:0,maxError:0}}t.selectErrorMetric=S;var I=function(){this.known=0,this.knownNodes=0,this.missing=0,this.missingNodes=0,this.unremoved=0};function x(e){return Math.sqrt(e*(4/Math.PI))}}));