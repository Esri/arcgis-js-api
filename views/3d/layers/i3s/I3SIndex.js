/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/PooledArray","../../../../core/promiseUtils","../../../../chunks/vec3","../../../../chunks/vec4f64","../../support/orientedBoundingBox","./I3SNode","./I3SUtil"],(function(e,t,i,s,n,o,r,a,d,l){"use strict";let h=function(e,t,i,s,n){this.childOffset=e,this.childCount=t,this.visibilityCache=i,this.ref=s,this.node=n,this.useAsHole=0},u=function(){function e(e,t,i,n,o,r,a,d,l,h,u,c,g,m){this.streamDataController=i,this.viewportQueries=n,this.logger=o,this.holeFilling=r,this._isLoaded=a,this._isReloading=d,this._isSelected=l,this._enable=h,this._needsUpdate=u,this._canRequest=c,this._computeVisibilityObb=g,this._computeNodeFiltering=m,this._dirty=!0,this._nodePages=[],this.nodeCount=0,this.nodesPerPage=0,this.rootIndex=0,this.lodMetric=0,this.lodConversion=e=>e,this.urlPrefix="",this._loading=new Set,this._failedNodes=new Set,this._failedPages=new Set,this._indexMissing=1,this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.POSITIVE_INFINITY,this._nodeTraversalState=new Map,this._version=_(0),this._visibilityCacheVersion=_(0),this._maxLevel=1,this._featureEstimate={estimate:0,leavesReached:!1},this._unloadedMemoryEstimate=0,this._missing=new s({deallocator:null}),this._prefetch=new s({deallocator:null}),this._updates=new f,this._imModificationUncategorized=new s({deallocator:null}),this.ignoreServiceObb=!1,this.progressiveLoadPenalty=0,this.layerHasModifications=!1,this._layerHasFilter=!1,this.logLayer=e,e.serviceUpdateTimeStamp&&e.serviceUpdateTimeStamp.lastUpdate&&(this.lastUpdate=`${e.serviceUpdateTimeStamp.lastUpdate}`),this._maxLodLevel=this.viewportQueries?this.viewportQueries.maxLodLevel:1,this.init(t)}var l=e.prototype;return l.init=function(e){if("page"===e.type){switch(this.urlPrefix=e.urlPrefix,this.nodesPerPage=e.pageSize,this.rootIndex=e.rootIndex,e.lodMetric){case"maxScreenThreshold":this.lodMetric=1;break;case"maxScreenThresholdSQ":this.lodMetric=1,this.lodConversion=I}this.addPage(p(this.rootIndex,this.nodesPerPage),e.rootPage)}else if("node"===e.type){this.urlPrefix=e.urlPrefix,this._nodePages.push({nodes:[],children:[],parents:[]}),this.makeRefNode(new d.NodeBase(e.rootNode.id,null),-1);const t=this._validateNode(e.rootNode.id,e.rootNode);t&&this.addNode(t,0)}},l.loadPage=function(e){this._loading.add(e);const t=this.urlPrefix+e;this.streamDataController.request(t,"json").then((t=>{this._loading.delete(e),this.addPage(e,t)})).catch((t=>{this._loading.delete(e),n.isAbortError(t)||(this._failedPages.add(e),this.logger.error("#loadPage()",this.logLayer,`Error when loading page ${e}`,t))}))},l.addPage=function(e,t){for(let o=this._nodePages.length;o<e;o++)this._nodePages[o]=null;const i=[],s=[],n=t.nodes.map(((t,n)=>{const l=i.length,u=t.children?t.children.length:0;s.push(-1);for(let e=0;e<u;e++)i.push(t.children[e]);const c=`${t.index}`,f=a.clone(t.obb),g=r.fromArray([f.center[0],f.center[1],f.center[2],o.length(f.halfSize)]),_=t.mesh&&t.mesh.attribute,b=t.mesh&&t.mesh.geometry,v=t.mesh&&t.mesh.material,y={hasSharedResource:!1,hasFeatureData:!!b,attributes:_&&null!=_.resource?`${_.resource}`:null,geometry:b&&null!=b.resource?`${b.resource}`:null,texture:v&&null!=v.resource?`${v.resource}`:null,geometryDefinition:b?b.definition:-1,materialDefinition:v?v.definition:-1},p=new d.Node(c,e*this.nodesPerPage+n,g,u,0,y,this.lastUpdate,this.lodMetric,this.lodConversion(t.lodThreshold),b?b.featureCount:null);return p.serviceObb=f,p.visibilityObb=this._computeVisibilityObb(p),p.vertexCount=b?b.vertexCount:0,new h(l,u,m(this._visibilityCacheVersion),null,p)}));this._nodePages[e]={nodes:n,children:i,parents:s},this.nodeCount+=n.length,this.updateParentsAndLevel()},l.updateParentsAndLevel=function(){const e=new Array,t=(t,s,n)=>{const o=this.getPage(t);if(i.isSome(o)){const r=N(t,this.nodesPerPage);o.parents[r]=s;const a=o.nodes[r].node;i.isSome(a)&&(a.level=n,e.push(t))}};for(t(this.rootIndex,-1,0);e.length;){const s=e.pop(),n=this.getNode(s);if(i.isSome(n))for(let e=0;e<n.childCount;e++){t(this.getChildIndex(n,e),s,n.level+1),this._maxLevel=Math.max(this._maxLevel,n.level+1)}}},l.getPage=function(e){return this._nodePages[p(e,this.nodesPerPage)]},l.getNodeInternal=function(e){const t=this.getPage(e);return i.isNone(t)?null:t.nodes[N(e,this.nodesPerPage)]},l.addNode=function(e,t){null!=e.children&&this.populateChildren(t,e.children);const s=this.getParent(t),n=i.isSome(s)?s.level+1:0;this._maxLevel=Math.max(this._maxLevel,e.children?n+1:n);const{lodMetric:o,maxError:l}=x(e.lodSelection),h=i.unwrap(this.getNodeInternal(t));return h.node=new d.Node(e.id,t,r.fromArray(e.mbs),h.childCount,n,e.resources,e.version,o,l,e.numFeatures),e.obb&&(h.node.serviceObb=a.clone(e.obb)),h.node.visibilityObb=this._computeVisibilityObb(h.node),i.isSome(h.ref)&&(null==h.ref.mbs&&(h.ref.mbs=e.mbs),h.node.renderMbs=h.ref.renderMbs,h.node.serviceObbInRenderSR=h.ref.serviceObbInRenderSR,h.ref.visibilityObb=h.node.visibilityObb),h.node},l.makeRefNode=function(e,t){const s=this._nodePages[0],n=s.nodes.length;return s.nodes.push(new h(0,0,m(this._visibilityCacheVersion),e,null)),this.nodeCount++,s.parents.push(t),e.renderMbs[3]=-1,i.isSome(e.serviceObbInRenderSR)&&(e.serviceObbInRenderSR.halfSize[0]=-1),n},l.populateChildren=function(e,t){const s=i.unwrap(this.getNodeInternal(e)),n=i.unwrap(this.getPage(e));s.childOffset=n.children.length,s.childCount=t.length;for(let i=0;i<t.length;i++){const s=this.makeRefNode(t[i],e);n.children.push(s)}},l.getNode=function(e){const t=this.getNodeInternal(e);return i.isSome(t)?t.node:null},l.getIndexById=function(e){let t;return this.forAllNodes(((s,n)=>{(i.isSome(s.node)&&s.node.id===e||i.isSome(s.ref)&&s.ref.id===e)&&(t=n)})),t},l.getNodeById=function(e){const t=this.getIndexById(e);return t>=0?this.getNode(t):null},l.getChildIndex=function(e,t){const s=this.getPage(e.index);if(i.isNone(s))return-1;const n=s.nodes[N(e.index,this.nodesPerPage)];return s.children[n.childOffset+t]},l.getParentIndex=function(e){const t=this.getPage(e);return i.isSome(t)?t.parents[N(e,this.nodesPerPage)]:-1},l.getParent=function(e){return(e=this.getParentIndex(e))>=0?this.getNode(e):null},l.isLeaf=function(e){const t=this.getNodeInternal(e);return i.isSome(t)&&0===t.childCount},l.invalidateVisibilityCache=function(){this._visibilityCacheVersion=_(this._visibilityCacheVersion)},l.invalidateNodeVisibilityCache=function(e){const t=this.getNodeInternal(e);i.isSome(t)&&this.invalidateNodeVisibilityCacheInternal(t)},l.invalidateNodeVisibilityCacheInternal=function(e){e.visibilityCache=m(this._visibilityCacheVersion)},l.invalidateBoundingVolumeCache=function(e){const t=this.getNodeInternal(e);i.isSome(t)&&(g(t),this.invalidateNodeVisibilityCacheInternal(t))},l.invalidateGeometryVisibility=function(e){const t=this.getNodeInternal(e);i.isSome(t)&&i.isSome(t.node)&&(t.node.geometryObb=null,t.node.renderMbs[3]=-1,i.isSome(t.node.serviceObbInRenderSR)&&(t.node.serviceObbInRenderSR.halfSize[0]=-1))},l.invalidateVisibilityObbs=function(){i.isNone(this.rootNode)||this.traverse(this.rootNode,(e=>(e.visibilityObb=this._computeVisibilityObb(e),e.geometryObb=null,!0)))},l.isNodeVisible=function(e){const t=this.getNodeInternal(e);if(i.isNone(t)||i.isSome(t.ref)&&!t.ref.mbs)return!0;if(!v(t.visibilityCache,this._visibilityCacheVersion)){const e=t.node,s=i.isSome(e)&&(i.isNone(t.ref)||i.isSome(e.visibilityObb))?e:i.isSome(t.ref)?t.ref:null;this._layerHasFilter&&this._computeNodeFiltering&&i.isSome(e)&&2===e.filterImpact&&this._computeNodeFiltering(e);const n=i.isSome(e)&&1===e.filterImpact,o=!(i.isSome(e)&&2===e.imModificationImpact)&&(!s||this.viewportQueries.isNodeVisible(s))&&!n;return t.visibilityCache=b(o,this._visibilityCacheVersion),o}return y(t.visibilityCache)},l.isGeometryVisible=function(e){if(!this.isNodeVisible(e))return!1;const t=this.getNodeInternal(e);return!(i.isSome(t)&&i.isSome(t.node)&&i.isSome(t.node.geometryObb)&&(!this.layerHasModifications||4!==t.node.imModificationImpact))||this.viewportQueries.isGeometryVisible(t.node)},l._traverseCoverage=function(e,t,s,n,o){const r=this.getPage(e);if(i.isNone(r)||0===t.childCount)return;const a=t.childOffset+t.childCount,d=new Array;for(let l=t.childOffset;l<a;++l){const e=r.children[l],t=this.getNodeInternal(e);i.isSome(t)&&i.isSome(t.node)&&this.isGeometryVisible(e)&&d.push(t)}n/=d.length;for(const l of d){const e=i.unwrap(l.node).index;this._isLoaded(e)||this._isReloading(e)?(o.delta=Math.max(o.delta,s),o.coverage+=n):this._traverseCoverage(e,l,s+1,n,o)}},l.useNodeAsHole=function(e){if("off"===this.holeFilling)return!1;const t=this.getNodeInternal(e);if(i.isNone(t))return!1;if("always"===this.holeFilling)return!0;if(v(t.useAsHole,this._version))return y(t.useAsHole);const s={delta:0,coverage:0};this._traverseCoverage(e,t,0,1,s);const n=s.delta*s.coverage<=.5;return t.useAsHole=b(n,this._version),n},l.destroy=function(){this._updates.add.prune(),this._updates.update.prune()},l.requestUpdate=function(){this._dirty=!0,this._indexMissing=1,this._version=_(this._version)},l.imModificationsChanged=function(e){this.layerHasModifications=e,this.forAllNodes((({node:e})=>{i.isSome(e)&&(e.imModificationImpact=4,e.visibilityObb=this._computeVisibilityObb(e),e.hasModifications&&this.invalidateGeometryVisibility(e.index))})),this.invalidateVisibilityCache()},l.layerFilterChanged=function(e){this._layerHasFilter=e,this.forAllNodes((({node:e})=>{i.isSome(e)&&(e.filterImpact=2,this.invalidateNodeVisibilityCache(e.index),e.visibilityObb=this._computeVisibilityObb(e),this.invalidateGeometryVisibility(e.index))})),this.invalidateVisibilityCache()},l.update=function(e,t,s){if(!this._dirty)return;this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.NEGATIVE_INFINITY,this._missing.clear(),this._prefetch.clear(),this._updates.reset(e,this._missing),c.clear();let n=!0;const o=new S,r=new S,a=this._imModificationUncategorized;a.clear();const d=new Set,l=(l,h,u)=>{if(i.isNone(h)){let e=this.entryPriority(l);e===1/0&&(e=this.entryPriority(u));const t=p(l,this.nodesPerPage);return c.set(t,Math.max(e,c.get(t)||0)),this._loading.has(t)||this._failedPages.has(t)||this._missing.push(t),void(this._maxProcessingPrio=Math.max(this._maxProcessingPrio,e))}const f=h.node;if(this._updateNodeFeatureEstimate(f,r),i.isNone(f)){const e=this.entryPriority(l);return this._loading.has(l)||this._failedNodes.has(l)||(this._missing.push(l),c.set(l,e)),void(this._maxProcessingPrio=Math.max(this._maxProcessingPrio,e))}const g=i.unwrap(this.getPage(l));if(0===this._missing.length&&0===this.nodesPerPage)for(let e=0;e<h.childCount;e++){const t=g.children[h.childOffset+e],s=this.getNodeInternal(t);!i.isSome(s)||s.node||this._loading.has(t)||this._failedNodes.has(t)||(c.set(t,this.entryPriority(t)),this._prefetch.push(t))}if(f.failed||!f.resources.hasFeatureData)return;if(d.add(f.id),this._isLoaded(l)){if(o.known+=f.memory,++o.knownNodes,this._isSelected(f)?h.childCount>0&&(n=!1):(o.unremoved+=f.memory,n=!1),this._needsUpdate(f)){const e=this.entryPriority(l);c.set(l,e),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,e),this._updates.update.push(l)}return}if(f.memory&&(o.known+=f.memory,++o.knownNodes),!this._isSelected(f))return void(this._isReloading(l)&&this._updates.remove.push(l));if(h.childCount>0&&(n=!1),f.memory?(o.missing+=f.memory,o.known+=f.memory,++o.knownNodes):++o.missingNodes,e.indexOf(f.index)>=0)return this._maxProcessingPrio=Math.max(this._maxProcessingPrio,this.entryPriority(l)),void(this._updates.cancel=this._updates.cancel.filter((e=>e!==f.index)));if(!t.done&&this._enable(f))return void t.madeProgress();const m=this.entryPriority(l);c.set(l,m),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,m),this._updates.add.push(l),this.layerHasModifications&&s&&i.isSome(f)&&4===f.imModificationImpact&&a.push(l)};this.traverseVisible(l);const h=this._updates.add;h.length>0&&this.layerHasModifications&&(a.length>0&&s(a),h.filterInPlace((e=>{const t=this.getNodeInternal(e),s=i.isNone(t)||i.isNone(t.node)||2!==t.node.imModificationImpact;return s||this.invalidateNodeVisibilityCache(e),s}))),this._unloadedMemoryEstimate=o.missing-o.unremoved,o.knownNodes>3&&o.missingNodes>0&&(this._unloadedMemoryEstimate+=o.known/o.knownNodes*o.missingNodes),this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate),this._featureEstimate.estimate=this._computeFeatureEstimate(r),this._featureEstimate.leavesReached=n,this._missing.sort(((e,t)=>e-t)),this._missing.filterInPlace(((e,t)=>t<1||this._missing.data[t-1]!==e)),this._missing.sort(((e,t)=>c.get(e)-c.get(t))),this._missing.length>0?(this._maxUnloadedPrio=c.get(this._missing.back()),this._prefetch.clear()):this._prefetch.sort(((e,t)=>c.get(e)-c.get(t))),this._updates.add.filterInPlace((e=>c.get(e)>=this._maxUnloadedPrio)).sort(((e,t)=>c.get(e)-c.get(t))),this._updates.update.sort(((e,t)=>c.get(e)-c.get(t))),this._indexMissing=this._loading.size+this._missing.length,this._dirty=this._indexMissing>0,c.clear()},l.checkFeatureTarget=function(e,t){const i=this.viewportQueries.updateScreenSpaceErrorBias(t);let s=t,n=t,o=i,r=10;for(;r--;){const i=new S;this._updateFeatureEstimate(s,i);if(this._computeFeatureEstimate(i)<=e){if(s>=t||i.missingNodes>0||0===r)break;o=s,s=.5*(s+n)}else n=s,s=.5*(s+o)}return this._version=_(this._version),this.viewportQueries.updateScreenSpaceErrorBias(i),Math.min(t,s)},l._updateFeatureEstimate=function(e,t){this._version=_(this._version),this.viewportQueries.updateScreenSpaceErrorBias(e),this.traverseVisible(((e,s)=>this._updateNodeFeatureEstimate(i.isSome(s)&&s.node,t)))},l._updateNodeFeatureEstimate=function(e,t){if(!(i.isNone(e)||e.failed||i.isNone(e.numFeatures)))return this._isLoaded(e.index)?(t.known+=e.numFeatures,++t.knownNodes,void(this._isSelected(e)||(t.unremoved+=e.numFeatures))):void(this._isSelected(e)&&(i.isSome(e.numFeatures)?(t.missing+=e.numFeatures,t.known+=e.numFeatures,++t.knownNodes):++t.missingNodes))},l._computeFeatureEstimate=function(e){let t=e.known-e.unremoved;return e.knownNodes>3&&e.missingNodes>0&&(t+=e.known/e.knownNodes*e.missingNodes),Math.max(0,t)},l.load=function(){return this._load(this._missing)},l.prefetch=function(){return this._load(this._prefetch)},l._load=function(e){if(0===e.length||!this._canRequest())return!1;for(;e.length>0&&this._canRequest();)0===this.nodesPerPage?this._loadNode(e.pop()):this.loadPage(e.pop());return!0},l.isLoading=function(){return this._indexMissing>0},l.getIndexLoading=function(){return this._loading.size},l.getIndexMissing=function(){return this._indexMissing},l.getUnloadedMemoryEstimate=function(){return this._unloadedMemoryEstimate},l.nodeTraversalState=function(e){if(i.isNone(e))return null;let t=this._nodeTraversalState.get(e.index);if(t&&v(t.version,this._version))return t;const s=this.viewportQueries.getLodLevel(e),n=this.viewportQueries.hasLOD(e);let o=!0;if(n){const t=this.getParentIndex(e.index);if(t>=0){const e=this._nodeTraversalState.get(t);o=e&&s>e.lodLevel}else o=s>0}else o=0===e.childCount;return t?(t.lodLevel=s,t.isChosen=o,t.version=b(!0,this._version),t):(t=new d.NodeTraversalState(n,o,s,b(!0,this._version)),this._nodeTraversalState.set(e.index,t),t)},l._loadNode=function(e){this._loading.add(e);const t=i.unwrap(this.getNodeInternal(e)).ref;if(i.isNone(t))return void this._failedNodes.add(e);const s=t.id,o=this.urlPrefix+s,r=()=>{this._loading.delete(e),0===this._missing.length&&0===this._loading.size&&this.requestUpdate()};this.streamDataController.request(o,"json").then((t=>{r();const i=this._validateNode(s,t);if(null==i)return;i.obb&&this.invalidateNodeVisibilityCache(e);const n=this.addNode(i,e);this.nodeTraversalState(n)}),(t=>{r(),n.isAbortError(t)||(this.logger.error("#loadNode()",this.logLayer,"Error loading node: "+o),this._failedNodes.add(e))}))},l._validateNode=function(e,t){if(null==t||"object"!=typeof t||t.id!==e)return this.logger.error("#validateNode()",this.logLayer,`Invalid node. Wrong type or wrong id "${e}"`),null;if(!Array.isArray(t.mbs))return this.logger.error("#validateNode()",this.logLayer,`Invalid bounding volume on node ${e}.`),null;t.sharedResource&&"./shared"!==t.sharedResource.href&&"./shared/"!==t.sharedResource.href&&this.logger.warn("#validateNode()",this.logLayer,`Invalid shared resource href on node "${e}"`),null==t.geometryData||Array.isArray(t.geometryData)&&1===t.geometryData.length&&"./geometries/0"===t.geometryData[0].href||this.logger.warn("#validateNode()",this.logLayer,`Invalid geometry data on node "${e}"`),null==t.attributeData||Array.isArray(t.attributeData)&&!t.attributeData.some(((e,t)=>e.href!==`./attributes/f_${t}/0`))||this.logger.warn("#validateNode()",this.logLayer,`Invalid attribute data on node "${e}"`),t.featureData&&t.featureData.length>1&&this.logger.warn("#validateNode()",this.logLayer,`Node ${e} has ${t.featureData.length} bundles. Only the first bundle will be loaded.`);const i=t.hasOwnProperty("obb")&&!this.ignoreServiceObb?t.obb:null,s=t.featureData&&1===t.featureData.length&&t.featureData[0].featureRange?t.featureData[0].featureRange[1]-t.featureData[0].featureRange[0]+1:null,n=t=>{if(null==t)return null;const i=t=>this.logger.error("#validateNode()",this.logLayer,`Invalid node reference on node ${e}: ${t}`);if("number"==typeof t.id)i(`id ${t.id} is a number instead of a string.`);else if("string"!=typeof t.id||!Array.isArray(t.mbs))return i("Missing or invalid id."),null;if(!Array.isArray(t.mbs))return i(`Invalid bounding volume on reference ${t.id}.`),null;t.href&&t.href!=="../"+t.id&&this.logger.error("#validateNode()",this.logLayer,`Invalid node href on node "${e}"`);const s=t.hasOwnProperty("obb")&&!this.ignoreServiceObb?t.obb:null,n=new d.NodeBase(`${t.id}`,t.mbs);return n.serviceObb=s,n.visibilityObb=this._computeVisibilityObb(n),n},o=Array.isArray(t.children)?t.children.map(n).filter((e=>null!=e)):null;return{id:e,mbs:t.mbs,obb:i,children:o,resources:{hasFeatureData:t.featureData&&t.featureData.length>0,hasSharedResource:null!=t.sharedResource,attributes:t.attributeData?e:null,texture:t.textureData&&t.textureData.length>0?e:null,geometry:null!=t.geometryData?e:null},version:"string"==typeof t.version?t.version:null,lodSelection:Array.isArray(t.lodSelection)?t.lodSelection:null,numFeatures:s}},l.resetFailedNodes=function(){this._failedNodes.clear(),this._failedPages.clear(),this.forAllNodes((e=>{i.isSome(e.node)&&(e.node.failed=!1)}))},l.entryPriority=function(e){const t=this.getNodeInternal(e),s=this.getParentIndex(e);if(i.isNone(t)||s<0&&null==t.node)return s<0?1/0:this.entryPriority(s);let n=0;if(t.node&&s>=0){const e=this._nodeTraversalState.get(s);null!=e&&(n=e.lodLevel)}let o=this.progressiveLoadPenalty;for(let i=e;i>=0;i=this.getParentIndex(i))if(this._isLoaded(i)){o=0;break}const r=i.isSome(t.ref)?this.viewportQueries.distToPOI(t.ref):i.isSome(t.node)?this.viewportQueries.distToPOI(t.node):0;return-r-n*(r+this.progressiveLoadPenalty)+o},l.traverseVisible=function(e){const t=this.getNodeInternal(this.rootIndex);i.isNone(t)?e(this.rootIndex,null,null):this._traverseVisible(this.rootIndex,-1,t,e)},l._traverseVisible=function(e,t,s,n){if(s.node&&0===s.childCount)return void(this.isGeometryVisible(e)&&n(e,s,t));if(!this.isNodeVisible(e))return;if(n(e,s,t),null==s.node)return;const o=this.nodeTraversalState(s.node);if(o.nodeHasLOD&&o.lodLevel===this._maxLodLevel)return;const r=i.unwrap(this.getPage(e));for(let a=0;a<s.childCount;a++){const t=r.children[s.childOffset+a],o=this.getNodeInternal(t);i.isSome(o)?this._traverseVisible(t,e,o,n):n(t,null,e)}},l.traverse=function(e,t){t(e)&&this.traverseChildren(e,t)},l.traverseChildren=function(e,t){const s=e.index,n=this.getNodeInternal(s);i.isSome(n)&&this._traverseChildren(s,n,t)},l._traverseChildren=function(e,t,s){const n=this.getPage(e);if(i.isNone(n))return;const o=t.childOffset+t.childCount;for(let r=t.childOffset;r<o;++r){const e=n.children[r],t=this.getNodeInternal(e);i.isSome(t)&&i.isSome(t.node)&&s(t.node)&&this._traverseChildren(e,t,s)}},l.updateStats=function(e){if(this._updates.add.length>0&&(e.nodes+=" + "+this._updates.add.length),(this._indexMissing||this._prefetch.length>0)&&(e.index+=" + "+this._indexMissing||this._prefetch.length),e.prio=this._maxProcessingPrio,this._featureEstimate.estimate){const t=this._featureEstimate.estimate-e.features;t>0?e.features+=" + "+t:t<0&&(e.features+=" - "+-t)}},l.getPriority=function(){return Math.max(this._maxProcessingPrio,this._maxUnloadedPrio)},l.updateElevationInfo=function(e){this.forAllNodes(g),this.viewportQueries.updateElevationInfo(e)},l.forAllNodes=function(e){for(let t=0;t<this._nodePages.length;t++){const i=this._nodePages[t];if(i){const s=t*this.nodesPerPage;for(let t=0;t<i.nodes.length;t++)e(i.nodes[t],s+t)}}},t._createClass(e,[{key:"rootNode",get:function(){return this.getNode(this.rootIndex)}},{key:"size",get:function(){return this.nodeCount}},{key:"maxLevel",get:function(){return this._maxLevel}},{key:"dirty",get:function(){return this._dirty}},{key:"updates",get:function(){return this._updates}},{key:"featureEstimate",get:function(){return this._featureEstimate}},{key:"test",get:function(){return{addNode:(e,t)=>this.addNode(e,t)}}}]),e}();const c=new Map;let f=function(){function e(){this.update=new s({deallocator:null}),this.add=new s({deallocator:null}),this.remove=new s({deallocator:null}),this.cancel=[]}return e.prototype.reset=function(e,t){this.add.clear(),this.update.clear(),this.cancel=e,this.missing=t},e}();function g(e){i.isSome(e.node)&&(e.node.renderMbs[3]=-1,i.isSome(e.node.serviceObbInRenderSR)&&(e.node.serviceObbInRenderSR.halfSize[0]=-1)),i.isSome(e.ref)&&(e.ref.renderMbs[3]=-1,i.isSome(e.ref.serviceObbInRenderSR)&&(e.ref.serviceObbInRenderSR.halfSize[0]=-1))}function m(e){return l.addWraparound(e,-2)}function _(e){return l.addWraparound(e,2)}function b(e,t){return t+(e?1:0)}function v(e,t){return(-2&e)===t}function y(e){return 1==(1&e)}function p(e,t){return 0===t?0:e/t|0}function N(e,t){return 0===t?e:e%t}const P=[["maxScreenThreshold",1],["screenSpaceRelative",2],["removedFeatureDiameter",3],["distanceRangeFromDefaultCamera",4]];function x(e){if(e)for(let t=0;t<e.length;t++)for(const i of P)if(i[0]===e[t].metricType)return{lodMetric:i[1],maxError:e[t].maxError};return{lodMetric:0,maxError:0}}let S=function(){this.known=0,this.knownNodes=0,this.missing=0,this.missingNodes=0,this.unremoved=0};function I(e){return Math.sqrt(e*(4/Math.PI))}e.I3SIndex=u,e.selectErrorMetric=x,Object.defineProperty(e,"__esModule",{value:!0})}));
