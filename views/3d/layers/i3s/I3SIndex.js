// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/assignHelper","../../../../core/PooledArray","../../../../core/urlUtils","./I3SUtil","../../support/orientedBoundingBox"],function(e,t,i,s,r,n,o){var a=["version","level","sharedResource","attributeData","geometryData","textureData","lodSelection"],d=function(){function e(e,t,i,n,o,a,d,u,l,p,_,f){var c=this;this.rootId=i,this.progressiveLoadPenalty=n,this.nodeIndex=o,this.streamDataSupplier=a,this.viewportQueries=d,this.logger=u,this._isLoaded=l,this._isSelected=p,this._enable=_,this._needsUpdate=f,this._dirty=!0,this._loading=!0,this._prefetching=!0,this._loadingNodes=new Set,this._indexMissing=1,this._nodesMissing=0,this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._nodeTraversalState={},this._version=0,this._featureEstimate={estimate:0,leafsReached:!1},this._unloadedMemoryEstimate=0,this._missing=new s,this._prefetch=new s,this._updates=new h,this.ignoreServiceOBB=!1,this._maxLodLevel=this.viewportQueries.maxLodLevel,this.rootUrl=r.makeAbsolute(t,e),this.traverseVisible(function(e,t){return c.nodeTraversalState(t)})}return e.prototype.requestReload=function(){this._dirty=!0,this._loading=!0,this._prefetching=!0,++this._version},e.prototype.update=function(e){var t=this;if(this._dirty){this._indexMissing=0,this._nodesMissing=0,this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._missing.clear(),this._prefetch.clear(),this._updates.reset(e),this._loading=!1,this._prefetching=!1;var s=!0,r=new u,n=new u,o=function(o,a,d){if(t._updateFeatureEstimate(a,n),!a)return++t._indexMissing,t._loading=!0,t._prefetching=!1,void(t._loadingNodes.has(o.id)||t._missing.push(i({},o,{baseUrl:d})));if(0===t._missing.length&&a.children)for(var h=0,u=a.children;h<u.length;h++){var l=u[h];t.nodeIndex[l.id]||(t._prefetching=!0,t._loadingNodes.has(l.id)||t._prefetch.push(i({},l,{baseUrl:a.baseUrl})))}if(!a.failed&&a.featureData&&0!==a.featureData.length){if(t._isLoaded(a))return r.known+=a.memory,++r.knownNodes,t._isSelected(a)?a.children&&(s=!1):(r.unremoved+=a.memory,s=!1),void(t._needsUpdate(a)&&t._updates.update.push(a));if(a.memory&&(r.known+=a.memory,++r.knownNodes),t._isSelected(a)){if(++t._nodesMissing,a.children&&(s=!1),a.memory?(r.missing+=a.memory,r.known+=a.memory,++r.knownNodes):++r.missingNodes,e.indexOf(a.id)>=0)return void(t._updates.cancel=t._updates.cancel.filter(function(e){return e!==a.id}));t._enable(a)||t._updates.add.push(a)}}};if(this.traverseVisible(o),this._unloadedMemoryEstimate=r.missing-r.unremoved,r.knownNodes>3&&(this._unloadedMemoryEstimate+=r.missingNodes*r.known/r.knownNodes),this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate),this._featureEstimate.estimate=n.known-n.missing,this._featureEstimate.leafsReached=s,n.knownNodes>0){var a=n.known/n.knownNodes,d=n.missing-n.unremoved+n.missingNodes*a;this._featureEstimate.estimate+d>0&&(this._featureEstimate.estimate+=d)}this._dirty=this._indexMissing>0||this._nodesMissing>0||this._updates.add.length>0||this._updates.update.length>0||this._updates.cancel.length>0}},e.prototype.checkFeatureTarget=function(e,t){var i=this,s=this.viewportQueries.updateScreenSpaceErrorBias(t);++this._version;var r=new u;this.traverseVisible(function(e,t){return i._updateFeatureEstimate(t,r)});var n=r.known-r.missing;if(r.knownNodes>0){var o=r.known/r.knownNodes,a=r.missing-r.unremoved+r.missingNodes*o;n+a>0&&(n+=a)}return this.viewportQueries.updateScreenSpaceErrorBias(s),++this._version,n<=e},e.prototype._updateFeatureEstimate=function(e,t){if(e&&!e.failed&&e.featureData&&0!==e.featureData.length)return this._isLoaded(e)?(t.known+=e.numFeatures,++t.knownNodes,void(this._isSelected(e)||(t.unremoved+=e.numFeatures))):void(this._isSelected(e)&&(e.numFeatures?(t.missing+=e.numFeatures,t.known+=e.numFeatures,++t.knownNodes):++t.missingNodes))},e.prototype.load=function(e){var t=this;return n.buildTopNodeMap(this._missing,e,function(e){return t.entryPriority(e)}),this._missing.length<=0?this._loading:(this._maxUnloadedPrio=this.entryPriority(this._missing.front()),this._missing.forEach(function(e){return t._loadNode(e)}),this._missing.clear(),this._loading)},e.prototype.prefetch=function(e){var t=this;return n.buildTopNodeMap(this._prefetch,e,function(e){return t.entryPriority(e)}),this._prefetch.forEach(function(e){return t._loadNode(e)}),this._prefetch.clear(),this._prefetching},e.prototype.isLoading=function(){return this._loading},e.prototype.isPrefetching=function(){return this._prefetching},e.prototype.getIndexLoading=function(){return this._loadingNodes.size},e.prototype.getIndexMissing=function(){return this._indexMissing},e.prototype.getUnloadedMemoryEstimate=function(){return this._unloadedMemoryEstimate},e.prototype.getNodesMissing=function(){return this._nodesMissing},e.prototype.getUpdates=function(e){var t=this;return n.buildTopNodeMap(this._updates.add,e,function(e){return t.entryPriority(e)},this._maxUnloadedPrio),n.buildTopNodeMap(this._updates.update,Number.POSITIVE_INFINITY,function(e){return t.entryPriority(e)}),this._updates},e.prototype.getFeatureEstimate=function(){return this._featureEstimate},e.prototype.nodeTraversalState=function(e){if(!e)return null;var t=this._nodeTraversalState[e.id];if(t&&t.version===this._version)return t;var i=this.viewportQueries.getLodLevel(e),s=this.viewportQueries.hasLOD(e),r=!0;if(s)if(e.parentNode){var n=this.nodeIndex[e.parentNode.id];if(null==n)return null;var o=this._nodeTraversalState[n.id];r=o&&i>o.lodLevel}else r=i>0;return t?(t.lodLevel=i,t.isChosen=r,t.version=this._version,t):(this._nodeTraversalState[e.id]={nodeHasLOD:s,lodLevel:i,isChosen:r,version:this._version},this._nodeTraversalState[e.id])},e.prototype._loadNode=function(e){var t=this;this._loadingNodes.add(e.id);var i=r.makeAbsolute(e.href,e.baseUrl);this.streamDataSupplier.request(i,"json").then(function(e,i){var s=i,r={id:s.id,mbs:s.mbs,parentNode:s.parentNode,children:s.children,featureData:s.featureData};a.forEach(function(e){r[e]=s.hasOwnProperty(e)?s[e]:null}),s.hasOwnProperty("obb")&&!t.ignoreServiceOBB&&(r.obb=o.clone(s.obb),r.hasServiceOBB=!0,t.viewportQueries.updateNode(r.id)),t.nodeIndex[r.id]=r,r.baseUrl=e,r.featureData&&1===r.featureData.length&&r.featureData[0].featureRange&&(r.numFeatures=r.featureData[0].featureRange[1]-r.featureData[0].featureRange[0]+1),t.nodeTraversalState(r),t._loadingNodes.delete(r.id),t._dirty=!0},function(s){t.loadErrorCallback(i),t._loadingNodes.delete(e.id),t._dirty=!0})},e.prototype.entryPriority=function(e){if(e.id===this.rootId)return 0;var t=0,i=this.nodeIndex[e.id];if(null!=i&&null!=i.parentNode){var s=this._nodeTraversalState[i.parentNode.id];null!=s&&(t=s.lodLevel)}for(var r=this.progressiveLoadPenalty,n=i;n;n=n.parentNode?this.nodeIndex[n.parentNode.id]:null)if(this._isLoaded(n)){r=0;break}var o=this.viewportQueries.distToPOI(e);return-o-t*(o+this.progressiveLoadPenalty)+r},e.prototype.traverseVisible=function(e){var t=this.nodeIndex[this.rootId];if(!t)return void e({id:this.rootId,mbs:null,href:this.rootUrl},null,"");this._traverse({id:this.rootId,mbs:t.mbs,href:this.rootUrl},t,e,"")},e.prototype._traverse=function(e,t,i,s){if(!t.children||0===t.children.length)return void(this.viewportQueries.isGeometryVisible(t)&&i(e,t,s));if(this.viewportQueries.isNodeVisible(t)){i(e,t,s);var r=this.nodeTraversalState(t);if(!r.nodeHasLOD||r.lodLevel!==this._maxLodLevel)for(var n=0,o=t.children;n<o.length;n++){var a=o[n],d=this.nodeIndex[a.id];d?this._traverse(a,d,i,t.baseUrl):this.viewportQueries.isNodeVisible(a)&&i(a,null,t.baseUrl)}}},e.prototype.loadErrorCallback=function(e){this.logger.warn("Error loading node: "+e)},e.prototype.updateStats=function(e){if(this._nodesMissing&&(e.nodes+=" + "+Math.round(this._nodesMissing)),this._indexMissing&&(e.index+=" + "+this._indexMissing),this._featureEstimate.estimate){var t=this._featureEstimate.estimate-e.features;t>0?e.features+=" + "+t:t<0&&(e.features+=" - "+-t)}},e}(),h=function(){function e(){this.update=new s,this.add=new s,this.cancel=[]}return e.prototype.reset=function(e){this.add.clear(),this.update.clear(),this.cancel=e},e}(),u=function(){function e(){this.known=0,this.knownNodes=0,this.missing=0,this.missingNodes=0,this.unremoved=0}return e}();return d});