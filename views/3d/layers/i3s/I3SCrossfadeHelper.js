/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/scheduling"],(function(e,s,o,i){"use strict";let t=function(){this.lodCrossfadeSignedDuration=0},d=function(){function e(e){this.view=e,this._preRenderFrameTaskHandle=null,this._currentFrameStartTime=null,this._numFadingNodes=0}var t=e.prototype;return t.stopNodeFading=function(e){null!=e.lodCrossfadeProgress&&(this._numFadingNodes--,e.lodCrossfadeProgress=null,0===this._numFadingNodes&&(null!=this._preRenderFrameTaskHandle&&(this._preRenderFrameTaskHandle=o.removeMaybe(this._preRenderFrameTaskHandle)),this.view.notifyLODUpdate(),this.view.notifyUpdate()))},t._startNodeFading=function(e,s,o){0===this._numFadingNodes&&(this._preRenderFrameTaskHandle=i.addFrameTask({preRender:e=>this._updateAllNodeFading(e)}),this.view.notifyLODUpdate()),null==e.lodCrossfadeProgress&&(this._numFadingNodes++,this.view.notifyUpdate()),e.lodCrossfadeSignedDuration=o,e.lodCrossfadeProgress=s},t._updateAllNodeFading=function(e){const s=this.view.nodeCrossfadingEnabled;this.view.foreachCrossfadeNode(((i,t)=>{if(o.isSome(t)&&o.isSome(t.lodCrossfadeProgress)){const o=t.lodCrossfadeSignedDuration,d=o>0?this.view.fullOpacity:0,a=e.deltaTime/o,n=t.lodCrossfadeProgress+Math.abs(a),r=!s||n>=1||0===o,l=d-(r?0:o>0?1:-1)*(1-n);r?(this.stopNodeFading(t),o<0&&this.view.markNodeToRemove(i)):t.lodCrossfadeProgress=n,this.view.setNodeOpacityByIndex(i,l)}})),this.view.removeMarkedNodes()},t.stopAllNodeFading=function(){this.view.foreachCrossfadeNode(((e,s)=>{if(o.isSome(s)&&o.isSome(s.lodCrossfadeProgress)){this.stopNodeFading(s);const o=s.lodCrossfadeSignedDuration;o<0&&this.view.markNodeToRemove(e);const i=o>0?this.view.fullOpacity:0;this.view.setNodeOpacityByIndex(e,i)}})),this.view.removeMarkedNodes()},t.fadeNode=function(e,s,o,i){null==this._currentFrameStartTime&&(this._currentFrameStartTime=Date.now());const t=this.view,d=t.nodeCrossfadingEnabled,n=0===o?t.fullOpacity:0,r=d?i?0===o?t.lodCrossfadeinDuration:t.lodCrossfadeoutDuration:t.lodCrossfadeUncoveredDuration:0,l=this.view.getNodeOpacityByIndex(e);if(d&&l!==n&&r>0){const e=1-Math.abs(n-l);this._startNodeFading(s,e,a(o)*r)}else this.stopNodeFading(s),this.view.setNodeOpacityByIndex(e,n),1===o&&this.view.removeNode(e)},t.isNodeFullyFadedIn=function(e){const s=this.view.getNodeCrossfadeMetaData(e);return o.isSome(s)&&null==s.lodCrossfadeProgress&&this.view.getNodeOpacityByIndex(e)===this.view.fullOpacity},s._createClass(e,[{key:"updating",get:function(){return this._numFadingNodes>0}}]),e}();function a(e){return 0===e?1:-1}e.I3SCrossfadeHelper=d,e.NodeCrossfadeMetaData=t,Object.defineProperty(e,"__esModule",{value:!0})}));
