/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../chunks/vec3","../../support/orientedBoundingBox","../../webgl-engine/lib/intersectorUtils","../../webgl-engine/lib/verticalOffsetUtils"],(function(e,t,i,n,r,s,o){"use strict";let l=function(){function e(e){this.type="I3S",this.layerUid=e.layerUid,this.sublayerUid=e.sublayerUid,this.collection=e.collection,this.traverseNodeHierarchy=e.traverseNodeHierarchy,this.slicePlane=e.slicePlaneEnabled,this.isGround=e.isGround}return e.prototype.intersect=function(e,t,l,d){const a=e.results,u=2===e.options.store,b=e.ray.direction,y=e.tolerance;let h=e=>e,p=e=>e;const f=o.getVerticalOffsetI3S(e.verticalOffset);i.isSome(f)&&(h=e=>f.applyToMbs(e),p=e=>f.applyToObb(e)),this.traverseNodeHierarchy(((o,m)=>!(i.isSome(o.serviceObbInRenderSR)&&!r.intersectLine(p(o.serviceObbInRenderSR),l,b,y))&&(!m||i.isSome(o.geometryObb)&&!r.intersectLine(p(o.geometryObb),l,b,y)||!i.isSome(o.serviceObbInRenderSR)&&!c(h(o.renderMbs),l,b,y)||this.collection.intersect(m,l,d,y,f,((i,r,c,b)=>{if(r>=0){if(null!=t&&!t(l,d,r))return;const y=e=>{e.intersector=this.type,e.target={type:"external",metadata:{layerUid:this.layerUid,sublayerUid:this.sublayerUid,nodeIndex:o.index,componentIndex:i}},e.dist=r,n.copy(e.normal,c),e.triangleNr=b};if(this.isGround&&(null==a.ground.dist||r<a.ground.dist)&&y(a.ground),e.options.isFiltered)return;if((null==a.min.dist||r<a.min.dist)&&y(a.min),(null==a.max.dist||r>a.max.dist)&&y(a.max),u){const t=new s.IntersectorResult(e.ray);y(t),e.results.all.push(t)}}})),!0)))},t._createClass(e,[{key:"intersectionHandlerId",get:function(){return this.layerUid}}]),e}();function c(e,t,i,n=0){const r=e[3]+n,s=t[0]-e[0],o=t[1]-e[1],l=t[2]-e[2],c=i[0],d=i[1],a=i[2],u=c*s+d*o+a*l;return u*u-(c*c+d*d+a*a)*(s*s+o*o+l*l-r*r)>=0}e.I3SIntersectionHandler=l,Object.defineProperty(e,"__esModule",{value:!0})}));
