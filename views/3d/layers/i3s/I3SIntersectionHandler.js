/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../core/maybe","../../../ViewingMode","./I3SUtil","./Intersector","../../support/orientedBoundingBox","../../webgl-engine/lib/Intersector","../../webgl-engine/lib/IntersectorInterfaces","../../webgl-engine/lib/verticalOffsetUtils"],(function(e,t,i,n,r,s,o,l,c){"use strict";let d=function(){function e(e){this.type=l.IntersectorType.I3S,this._needVerticalOffset=!1,this.layerUid=e.layerUid,this.sublayerUid=e.sublayerUid,this._collection=e.collection,this._traverseNodeHierarchy=e.traverseNodeHierarchy,this.slicePlaneEnabled=e.slicePlaneEnabled,this.isGround=e.isGround}var d=e.prototype;return d.updateElevationAlignState=function(e,t){this._needVerticalOffset=e&&t===i.ViewingMode.Global},d.intersect=function(e,i,d,u){const b=e.results,f=e.options.store===l.StoreResults.ALL,y=e.ray.direction,h=e.tolerance;let g=e=>e,p=e=>e;const S=c.getVerticalOffsetI3S(t.isSome(e.verticalOffset)?e.verticalOffset:this._needVerticalOffset?0:null);t.isSome(e.verticalOffset)&&t.isSome(S)&&(g=e=>S.applyToMbs(e),p=e=>S.applyToObb(e)),this._traverseNodeHierarchy(((l,c)=>{if(0===l.childrenLoaded)return!1;const m=t.isSome(l.serviceObbInRenderSR)&&n.isValidObb(l.serviceObbInRenderSR)?l.serviceObbInRenderSR:null;return!(t.isSome(m)&&!s.intersectLine(p(m),d,y,h))&&(c&&(t.isSome(m)||!n.isValidMbs(l.renderMbs)||a(g(l.renderMbs),d,y,h))&&(t.isNone(l.geometryObb)||s.intersectLine(p(l.geometryObb),d,y,h))&&this._collection.intersect(c,d,u,h,S,((t,n,s,c)=>{if(n>=0){if(null!=i&&!i(d,u,n))return;const a=e=>{const i=new r.I3sTarget(this.layerUid,this.sublayerUid,l.index,t,c);e.set(this.type,i,n,s)};if(this.isGround&&(null==b.ground.dist||n<b.ground.dist)&&a(b.ground),e.options.isFiltered)return;if((null==b.min.dist||n<b.min.dist)&&a(b.min),(null==b.max.dist||n>b.max.dist)&&a(b.max),f){const t=o.newIntersectorResult(e.ray);a(t),e.results.all.push(t)}}})),!0)}))},e}();function a(e,t,i,n=0){const r=e[3]+n,s=t[0]-e[0],o=t[1]-e[1],l=t[2]-e[2],c=i[0],d=i[1],a=i[2],u=c*s+d*o+a*l;return u*u-(c*c+d*d+a*a)*(s*s+o*o+l*l-r*r)>=0}e.I3SIntersectionHandler=d,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
