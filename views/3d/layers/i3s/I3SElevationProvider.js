/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Evented","../../../../core/Logger","../../../../core/maybe","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/support/aaBoundingRect","../../webgl-engine/lib/Intersector","../../webgl-engine/lib/IntersectorInterfaces"],(function(e,t,r,n,i,s,o,c,a,l,p,h,u,d,f,_,v){"use strict";const m=f.empty(),y=h.create(),g=d.create(),x=d.create(),E=d.create();let w=function(t){function r(e){var r;return(r=t.call(this,e)||this)._tmpEvent={spatialReference:null,extent:m,context:"scene"},r}e._inheritsLoose(r,t);var n=r.prototype;return n.initialize=function(){this.view=this.layerView.view,this._renderCoordsHelper=this.view.renderCoordsHelper,this._intersector=_.newIntersector(this.view.state.viewingMode),this._intersector.options.store=v.StoreResults.MIN;const e=this.layerView.i3slayer.fullExtent;s.isNone(e)?i.getLogger(this.declaredClass).error("I3SElevationProvider expected fullExtent on I3SLayer."):(this._zmin=e.zmin,this._zmax=e.zmax),this._tmpEvent.context=this.intersectionHandler.isGround?"ground":"scene"},n.getElevation=function(e,t,r,n){if(g[0]=e,g[1]=t,g[2]=r,!this._renderCoordsHelper.toRenderCoords(g,n,g))return i.getLogger(this.declaredClass).error("could not project point to compute elevation"),null;const s=this.layerView.elevationOffset,o=this._zmin+s,c=this._zmax+s;return this._renderCoordsHelper.setAltitude(x,c,g),this._renderCoordsHelper.setAltitude(E,o,g),this._intersector.reset(x,E,null),this.intersectionHandler.intersect(this._intersector,null,x,E),this._intersector.results.min.getIntersectionPoint(g)?this._renderCoordsHelper.getAltitude(g):null},n.layerChanged=function(){this.spatialReference&&(this._tmpEvent.extent=this._computeLayerExtent(),this._tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this._tmpEvent))},n.objectChanged=function(e){this.spatialReference&&(this._tmpEvent.extent=this._computeObjectExtent(e),this._tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this._tmpEvent))},n._computeObjectExtent=function(e){return f.empty(m),this._expandExtent(e,m),m},n._computeLayerExtent=function(){f.empty(m);for(const e of this.layerView.getVisibleNodes())this._expandExtent(e,m);return m},n._expandExtent=function(e,t){const r=this.spatialReference;if(s.isNone(r))return;const n=this.layerView.getNodeComponentObb(e);if(!s.isNone(n)){p.fromQuat(y,n.quaternion),y[12]=n.center[0],y[13]=n.center[1],y[14]=n.center[2];for(let e=0;e<8;++e)g[0]=1&e?n.halfSize[0]:-n.halfSize[0],g[1]=2&e?n.halfSize[1]:-n.halfSize[1],g[2]=4&e?n.halfSize[2]:-n.halfSize[2],u.transformMat4(g,g,y),this._renderCoordsHelper.fromRenderCoords(g,g,r),f.expand(t,g,t)}},e._createClass(r,[{key:"spatialReference",get:function(){return this.view?.elevationProvider?.spatialReference}}]),r}(n.EventedMixin(r));t.__decorate([o.property({constructOnly:!0})],w.prototype,"layerView",void 0),t.__decorate([o.property({constructOnly:!0})],w.prototype,"intersectionHandler",void 0),t.__decorate([o.property()],w.prototype,"view",void 0),t.__decorate([o.property()],w.prototype,"spatialReference",null),w=t.__decorate([l.subclass("esri.views.3d.layers.i3s.I3SElevationProvider")],w);return w}));
