// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","../../../../request","../../../../core/arrayUtils","../../../../core/Error","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/typedArrayUtil","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/quat","../../../../core/libs/gl-matrix-2/quatf32","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec4f64","../../../../geometry/SpatialReference","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/geodesicConstants","../../../../geometry/support/webMercatorUtils","../../../../tasks/support/Query","./I3SBinaryReader","./I3SProjectionUtil","../support/edgeUtils","../support/symbolColorUtils","../../support/orientedBoundingBox","../../support/projectionUtils"],(function(e,t,r,a,n,o,i,c,l,s,u,f,p,h,d,m,g,v,y,b,S,M,x,I,w,C){"use strict";function R(e){return e&&parseInt(e.substring(e.lastIndexOf("/")+1,e.length),10)}Object.defineProperty(t,"__esModule",{value:!0}),t.computeVisibilityObb=t.transformObb=t.addWraparound=t.getSymbolInfo=t.SymbolInfo=t.transparentEdgeMaterial=t.rendererNeedsTextures=t.checkPointCloudLayerCompatibleWithView=t.checkPointCloudLayerValid=t.checkSceneLayerCompatibleWithView=t.checkSceneLayerValid=t.checkSpatialReferences=t.checkSpatialReference=t.getCacheKeySuffix=t.getVertexCrs=t.getIndexCrs=t.getCachedAttributeValue=t.whenGraphicAttributes=t.findFieldsCaseInsensitive=t.intersectBoundingBoxWithMbs=t.intersectBoundingRectWithMbs=t.getClipAABB=t.filterInPlace=t.findIntersectingNodes=t.selectEncoding=t.extractWkid=t.BROWSER_SUPPORTED_IMAGE_ENCODING_STRINGS=t.DDS_ENCODING_STRING=void 0,t.DDS_ENCODING_STRING="image/vnd-ms.dds",t.BROWSER_SUPPORTED_IMAGE_ENCODING_STRINGS=["image/jpeg","image/png"],t.extractWkid=R,t.selectEncoding=function(e,r){if(r)for(var a=0;a<e.length;a++)if(e[a].encoding===t.DDS_ENCODING_STRING)return e[a];for(a=0;a<e.length;a++)if(t.BROWSER_SUPPORTED_IMAGE_ENCODING_STRINGS.indexOf(e[a].encoding)>-1)return e[a];return null},t.findIntersectingNodes=function(e,t,r,a,n,o){n.traverse(r,(function(r){var n=r.mbs;t!==a&&(n=E,C.mbsToMbs(r.mbs,a,n,t));var i=q(e,n);return 0!==i&&(o(r,i),!0)}))},t.filterInPlace=function(e,t,r){for(var a=0,n=0,o=0;o<t.length&&a<e.length;o++)e[a]===t[o]&&(r(o)&&(e[n]=e[a],n++),a++);e.length=n};var T=m.create();t.getClipAABB=function(e,t){if(0===t.rotationScale[1]&&0===t.rotationScale[2]&&0===t.rotationScale[3]&&0===t.rotationScale[5]&&0===t.rotationScale[6]&&0===t.rotationScale[7])return T[0]=(e[0]-t.position[0])/t.rotationScale[0],T[1]=(e[1]-t.position[1])/t.rotationScale[4],T[2]=(e[2]-t.position[2])/t.rotationScale[8],T[3]=(e[3]-t.position[0])/t.rotationScale[0],T[4]=(e[4]-t.position[1])/t.rotationScale[4],T[5]=(e[5]-t.position[2])/t.rotationScale[8],T};var E=h.vec4f64.create();function q(e,t){var r=t[0],a=t[1],n=t[3],o=e[0]-r,i=r-e[2],c=e[1]-a,l=a-e[3],s=Math.max(o,i,0),u=Math.max(c,l,0),f=s*s+u*u;return f>n*n?0:f>0?1:-Math.max(o,i,c,l)>n?3:2}function A(e,t,r){for(var a=[],n=r&&r.missingFields,o=r&&r.originalFields,i=0,c=e;i<c.length;i++){for(var l=c[i],s=l.toLowerCase(),u=!1,f=0,p=t;f<p.length;f++){var h=p[f];if(s===h.name.toLowerCase()){a.push(h.name),u=!0,o&&o.push(l);break}}!u&&n&&n.push(l)}return a}t.intersectBoundingRectWithMbs=q,t.intersectBoundingBoxWithMbs=function(e,t){var r=t[0],a=t[1],n=t[2],o=t[3],i=e[0]-r,c=r-e[3],l=e[1]-a,s=a-e[4],u=e[2]-n,f=n-e[5],p=Math.max(i,c,0),h=Math.max(l,s,0),d=Math.max(u,f,0),m=p*p+h*h+d*d;return m>o*o?0:m>0?1:-Math.max(i,c,l,s,u,f)>o?3:2},t.findFieldsCaseInsensitive=A,t.whenGraphicAttributes=function(e,t,c,l,s,u){var f;if(!0===(u&&u.populateObjectId)&&(f=c,l=l.filter((function(e){return e!==f})).concat([f])),0===t.length)return i.resolve(t);var p=e.associatedLayer,h=e.attributeStorageInfo;if(o.isSome(p)&&p.loaded)return function(e,t,r,o){t.sort((function(e,t){return e.attributes[r]-t.attributes[r]}));var c=t.map((function(e){return e.attributes[r]})),l=[],s=A(o,e.fields,{originalFields:l});return function e(t,r,o){var c=t.capabilities.query.maxRecordCount;if(null!=c&&r.length>c){var l=a.splitIntoChunks(r,c);return i.all(l.map((function(r){return e(t,r,o)}))).then(a.flatten)}var s=new b({objectIds:r,outFields:o,orderByFields:[t.objectIdField]});return t.queryFeatures(s).then((function(e){if(e&&e.features&&e.features.length===r.length)return e.features.map((function(e){return e.attributes}));throw new n("scenelayer:feature-not-in-associated-layer","Feature not found in associated feature layer")}))}(e,c,s).then((function(e){for(var r=0;r<t.length;r++){var a=t[r],n=e[r],o={};if(a.attributes)for(var i in a.attributes)o[i]=a.attributes[i];for(var c=0;c<l.length;c++)o[l[c]]=n[s[c]];a.attributes=o}return t}))}(p,t,c,l);if(h){var d=s(t);if(!d)return i.reject(new n("scenelayer:features-not-loaded","Tried to query attributes for unloaded features"));var m=e.parsedUrl.path;return i.all(d.map((function(e){return function(e,t,a,n,o){for(var c=[],l=0,s=t;l<s.length;l++){var u=s[l];if(u&&-1!==o.indexOf(u.name)){var f=e+"/nodes/"+a.resources.attributes+"/attributes/"+u.key+"/0";c.push({url:f,storageInfo:u})}}return i.eachAlways(c.map((function(e){return r(e.url,{responseType:"array-buffer"}).then((function(t){return S.readBinaryAttribute(e.storageInfo,t.data)}))}))).then((function(e){for(var t=[],r=0,a=n;r<a.length;r++){for(var o=a[r],i={},l=0;l<e.length;l++)null!=e[l].value&&(i[c[l].storageInfo.name]=N(e[l].value,o));t.push(i)}return t}))}(m,h,e.node,e.indices,l).then((function(t){for(var r=0;r<e.graphics.length;r++){var a=e.graphics[r],n=t[r];if(a.attributes)for(var o in a.attributes)o in n||(n[o]=a.attributes[o]);a.attributes=n}return e.graphics}))}))).then(a.flatten)}return i.reject(new n("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available"))};var B=-Math.pow(2,15),G=-Math.pow(2,31);function N(e,t){if(!e)return null;var r=e[t];return c.isInt16Array(e)?r===B?null:r:c.isInt32Array(e)?r===G?null:r:r!=r?null:r}function O(e){var t=new d(R(e.store.indexCRS||e.store.geographicCRS));return t.equals(e.spatialReference)?e.spatialReference:t}function P(e){var t=new d(R(e.store.vertexCRS||e.store.projectedCRS));return t.equals(e.spatialReference)?e.spatialReference:t}function k(e,t,r){if(!y.canProject(e,t))throw new n("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});if("local"===r&&e.isGeographic)throw new n("layerview:local-gcs-not-supported","Geographic coordinate systems are not supported in local scenes",{})}function _(e,t,r){var a=O(e),n=P(e);k(a,t,r),k(n,t,r)}function V(e){return"mesh-3d"===e.type}t.getCachedAttributeValue=N,t.getIndexCrs=O,t.getVertexCrs=P,t.getCacheKeySuffix=function(e,t){return t===C.SphericalECEFSpatialReference?"@ECEF":e.equals(t)?"":null!=t.wkid?"@"+t.wkid:null},t.checkSpatialReference=k,t.checkSpatialReferences=_,t.checkSceneLayerValid=function(e){if(null==e.store||null==e.store.defaultGeometrySchema||(null!=(t=e.store.defaultGeometrySchema).geometryType&&"triangles"!==t.geometryType||null!=t.topology&&"PerAttributeArray"!==t.topology||null==t.vertexAttributes||null==t.vertexAttributes.position))throw new n("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{url:e.parsedUrl.path});var t},t.checkSceneLayerCompatibleWithView=function(e,t){_(e,t.spatialReference,t.viewingMode)},t.checkPointCloudLayerValid=function(e){if(null==e.store||null==e.store.defaultGeometrySchema||(null==(t=e.store.defaultGeometrySchema).geometryType||"points"!==t.geometryType||null!=t.topology&&"PerAttributeArray"!==t.topology||null!=t.encoding&&""!==t.encoding&&"lepcc-xyz"!==t.encoding||null==t.vertexAttributes||null==t.vertexAttributes.position))throw new n("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{});var t},t.checkPointCloudLayerCompatibleWithView=function(e,t){k(e.spatialReference,t.spatialReference,t.viewingMode)},t.rendererNeedsTextures=function(e){if(null==e||!function(e){return"simple"===e.type||"class-breaks"===e.type||"unique-value"===e.type}(e))return!0;if(("unique-value"===e.type||"class-breaks"===e.type)&&null==e.defaultSymbol)return!0;var t=e.getSymbols();if(0===t.length)return!0;for(var r=0,a=t;r<a.length;r++){var n=a[r];if(!V(n)||0===n.symbolLayers.length)return!0;for(var i=0,c=n.symbolLayers.items;i<c.length;i++){var l=c[i];if("fill"!==l.type||o.isNone(l.material)||o.isNone(l.material.color)||"replace"!==l.material.colorMixMode)return!0}}return!1},t.transparentEdgeMaterial=x.createSolidEdgeMaterial({color:[0,0,0,0],opacity:0});var D=function(){this.edgeMaterial=null,this.material=null,this.castShadows=!0};function F(e,t,r,a,n){void 0===n&&(n=0),a===L?t.isGeographic?function(e,t,r,a){var n=1+Math.max(0,a)/(v.earthRadius+e.center[2]);p.vec3.set(t.center,e.center[0],e.center[1],e.center[2]+a),C.bufferToBuffer(t.center,r,0,t.center,L,0,1),u.quat.copy(t.quaternion,e.quaternion),u.quat.conjugate(j,e.quaternion),p.vec3.set(Z,0,0,1),p.vec3.transformQuat(Z,Z,j),p.vec3.set(Z,e.halfSize[0]*Math.abs(Z[0]),e.halfSize[1]*Math.abs(Z[1]),e.halfSize[2]*Math.abs(Z[2])),p.vec3.scale(Z,Z,v.earthInverseFlattening),p.vec3.add(t.halfSize,e.halfSize,Z),p.vec3.scale(t.halfSize,t.halfSize,n)}(e,r,t,n):function(e,t,r,a){w.corners(e,U),p.vec3.set(t.center,e.center[0],e.center[1],e.center[2]+a),C.computeLinearTransformation(r,t.center,W,L),p.vec3.set(t.center,W[12],W[13],W[14]);var n=2*Math.sqrt(1+W[0]+W[5]+W[10]);j[0]=(W[6]-W[9])/n,j[1]=(W[8]-W[2])/n,j[2]=(W[1]-W[4])/n,j[3]=.25*n,u.quat.multiply(t.quaternion,j,e.quaternion),u.quat.conjugate(j,t.quaternion);for(var o=0,i=0,c=0,l=0,s=U;l<s.length;l++){var f=s[l];f[2]+=a,C.bufferToBuffer(f,r,0,f,L,0,1),p.vec3.sub(Z,f,t.center),p.vec3.transformQuat(Z,Z,j),o=Math.max(o,Math.abs(Z[0])),i=Math.max(i,Math.abs(Z[1])),c=Math.max(c,Math.abs(Z[2]))}p.vec3.set(t.halfSize,o,i,c)}(e,r,t,n):e===r?(r.center[2]+=n,C.bufferToBuffer(r.center,t,0,r.center,a,0,1)):(p.vec3.set(r.center,e.center[0],e.center[1],e.center[2]+n),C.bufferToBuffer(r.center,t,0,r.center,a,0,1),u.quat.copy(r.quaternion,e.quaternion),p.vec3.copy(r.halfSize,e.halfSize))}t.SymbolInfo=D,t.getSymbolInfo=function(e){for(var t=new D,r=!1,a=!1,n=0,i=e.symbolLayers.items;n<i.length;n++){var c=i[n];if("fill"===c.type&&c.enabled){var l=c.material,s=c.edges;if(o.isSome(l)&&!r){var u=l.color,f=I.parseColorMixMode(l.colorMixMode);o.isSome(u)?t.material={color:[u.r/255,u.g/255,u.b/255],alpha:u.a,colorMixMode:f}:t.material={color:[1,1,1],alpha:1,colorMixMode:1},t.castShadows=c.castShadows,r=!0}o.isSome(s)&&!a&&(t.edgeMaterial=x.createMaterialFromEdges(s,{}),a=!0)}}return t.material||(t.material={color:[1,1,1],alpha:1,colorMixMode:1}),t},t.addWraparound=function(e,t){return(0|e)+(0|t)|0},t.transformObb=F,t.computeVisibilityObb=function(e,t,r,a,n,i){if(!i||0===i.length)return null;var c,s=M.computeGlobalTransformation(e.mbs,n,r,t);l.mat4.invert(J,s);var u=1/0,f=-1/0,h=function(i){if("replace"===i.type){var l=i.geometry;if(l.hasZ){g.empty(z);var s=l.spatialReference||a,h=l.rings.reduce((function(e,r){return r.reduce((function(e,r){return C.vectorToVector(r,s,Z,t),p.vec3.transformMat4(Z,Z,J),g.expandPointInPlace(z,Z),Math.min(Z[2],e)}),e)}),1/0);!function(){if(!c)if(c=U,g.empty(Q),o.isSome(e.serviceObb)){F(e.serviceObb,r,K,t,n),w.corners(K,c);for(var a=0,i=c;a<i.length;a++){var l=i[a];p.vec3.transformMat4(l,l,J),g.expandPointInPlace(Q,l)}}else{var s=e.mbs,u=s[3];C.vectorToVector(s,r,Z,t),p.vec3.transformMat4(Z,Z,J),Z[2]+=n;for(var f=0;f<8;++f){var h=1&f?u:-u,d=2&f?u:-u,m=4&f?u:-u;l=c[f];p.vec3.copy(l,[Z[0]+h,Z[1]+d,Z[2]+m]),g.expandPointInPlace(Q,l)}}}(),g.intersects(Q,z)&&(u=Math.min(u,h),f=Math.max(f,h))}}};if(i.forEach((function(e){return h(e)})),u===1/0)return null;for(var d,m,v,y=0;y<8;++y)d=H.data,m=3*y,v=c[y],p.vec3.transformMat4(Z,v,s),d[m+0]=Z[0],d[m+1]=Z[1],d[m+2]=Z[2],m+=24,v[2]=u,p.vec3.transformMat4(Z,v,s),d[m+0]=Z[0],d[m+1]=Z[1],d[m+2]=Z[2],m+=24,v[2]=f,p.vec3.transformMat4(Z,v,s),d[m+0]=Z[0],d[m+1]=Z[1],d[m+2]=Z[2];return w.compute(H)};var L=C.SphericalECEFSpatialReference,W=s.mat4f64.create(),j=f.quatf32.create(),U=[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]],z=g.create(),Q=g.create(),K=w.create(),Z=[0,0,0],H={data:new Array(72),size:3,offsetIdx:0,strideIdx:3},J=s.mat4f64.create()}));