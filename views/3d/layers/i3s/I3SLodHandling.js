/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/PooledArray","./I3SNode","../support/I3SLayerView"],(function(e,i,n,o,t){"use strict";let s=function(){function n(e){this.layerView=e,this._lodGlobalDirty=!1}var s=n.prototype;return s.startNodeLoading=function(e,i,n,o){this._maxLodLevel=o.maxLodLevel,this._index=n,this._isNodeInScaleBounds=e,this._removeNodes=i},s.shouldLoadNode=function(e){if(i.isNone(e))return!1;const n=this._index.nodeTraversalState(e);return!!this._isChosenMaxLOD(n)||!!n.isChosen&&this._childrenRequireLoading(e)},s.setLodGlobalDirty=function(){this._lodGlobalDirty=!0},s.lodGlobalHandling=function(e){if(!this.requiresLODGlobalHandling)return!1;this._lodGlobalDirty=!1;const i=this.layerView.view.resourceController.memoryController.usedMemory,n=Math.max(0,Math.floor(10*(i-1)));d.clear(),this._lodGlobalHandling(this._index.rootNode,n,!1);const o=d.length;this._removeNodes(d,e);const t=d.length<o;return 0!==d.length&&(this._lodGlobalDirty=!0),d.clear(),t},s._lodGlobalHandling=function(e,n,s){if(i.isNone(e))return!1;const l=e.index,r=this._index,a=this.layerView,h=r.nodeTraversalState(e),u=this._isChosenMaxLOD(h),c=a.isNodeLoaded(l),_=a.nodeCrossfadingEnabled;if(_&&c&&u){const i=!s&&this.hasNoVisibleChildren(e);a.fadeNode(l,t.FadeDirection.FadeIn,!i)}const x=c&&(!a.isNodeFullyFadedIn||a.isNodeFullyFadedIn(l));if(c&&(a.updateNodeState(l,u?o.NodeState.Leaf:o.NodeState.Hole),u))return x&&this._removeChildrenRecursive(e),x;const f=e.childCount>0;let N=f;if(f)for(let o=0;o<e.childCount;o++){const t=r.getChildIndex(e,o),d=r.getNode(t);if(i.isSome(d)){!(!r.isGeometryVisible(t)||this._lodGlobalHandling(d,n,s||x))&&this._isNodeInScaleBounds(d)&&(N=!1)}else r.isNodeVisible(t)&&(N=!1)}const L=c&&!u&&(N||d.length<n);L&&d.push(l),!_||L||!c||s||N||a.fadeNode(l,t.FadeDirection.FadeIn,!1);const y=!e.resources.hasFeatureData;return N||x&&!L||y},s._removeChildrenRecursive=function(e){this._index.traverseChildren(e,(e=>((this.layerView.isNodeLoaded(e.index)||this.layerView.isNodeReloading(e.index))&&d.push(e.index),!0)))},s.hasNoVisibleChildren=function(e){let i=!0;return this._index.traverseChildren(e,(e=>!(!i||!this._index.isNodeVisible(e.index))&&(!this.layerView.isNodeLoaded(e.index)||(i=!1,!1)))),i},s._childrenRequireLoading=function(e){let i=!1,n=!0;return this._index.traverseChildren(e,(e=>{if(!n||!this._index.isNodeVisible(e.index))return!1;const o=this._index.nodeTraversalState(e);return this._isChosenMaxLOD(o)&&this._index.isGeometryVisible(e.index)&&(i=!0),!this.layerView.isNodeLoaded(e.index)||(n=!1,!1)})),n&&i},s._isChosenMaxLOD=function(e){return e.isChosen&&(!e.nodeHasLOD||e.lodLevel===this._maxLodLevel)},e._createClass(n,[{key:"requiresLODGlobalHandling",get:function(){return null!=this._index&&!0===this._lodGlobalDirty}}]),n}();const d=new n({deallocator:null});return s}));
