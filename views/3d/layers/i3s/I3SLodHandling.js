// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports"],function(e,o){var i=!1,t=!1,r=function(){function e(e,o,i){this.layerViewRequiredFunctions=e,this.layerViewOptionalFunctions=o,this.lodGlobalDirtyChanged=i,this._lodSwapNodeIndex={},this._lodSwapFeatureLookup={},this._lodSwapRootFeatureLookup={}}return e.prototype.startNodeLoading=function(e,o,t,r,n,d){if(this._lodGlobalDirty=!1,this._lodMode=t,this._lodSwapNodeIndex={},this._lodSwapFeatureLookup={},this._lodSwapRootFeatureLookup={},this._nodeIndex=r,this._rootId=d,this._nodeTraversalState=o,this._nodeIsVisible=e,i&&console.debug("_removeInvisibleNodes started"),"swap"===this._lodMode){for(var l in n){var a=n[l];this._nodeTraversalState(a.id).nodeHasLOD&&!this._nodeTraversalState(a.id).isChosenLOD&&(i&&console.debug("_removeInvisibleNodes: added node "+a.id+" to swap index"),this._lodSwapNodeIndex[l]=a)}this._lodSwapBuildUnmatchingFeatureLookups()}this.lodGlobalDirtyChanged(this._lodGlobalDirty)},e.prototype.cancelNodeLoading=function(){this._lodSwapNodeIndex={}},e.prototype.shouldLoadNode=function(e,o){var i=this._nodeTraversalState(e.id),t=i.nodeHasLOD,r=i.isChosenLOD;return"perLevel"!==this._lodMode?r||!t:r||!t?!0:this.layerViewOptionalFunctions.traversalOptions.allowPartialOverlaps?this._someSubtreesIncomplete(e):this._allSubtreesIncomplete(e)},e.prototype.shouldSetPolygonOffset=function(e){return"perLevel"===this._lodMode?!this._nodeTraversalState(e.id).isChosenLOD:!1},e.prototype._allSubtreesIncomplete=function(e){if(this.layerViewRequiredFunctions.areAllBundlesLoaded(e))return!1;var o=!0;if(null!=e.children)for(var i=0;i<e.children.length;++i){var t=e.children[i];if(this._nodeIsVisible(t)){var r=this._nodeIndex[t.id];o=o&&(null==r||this._allSubtreesIncomplete(r))}}return o},e.prototype._someSubtreesIncomplete=function(e){if(this.layerViewRequiredFunctions.areAllBundlesLoaded(e))return!1;var o=!1;if(null!=e.children)for(var i=0;i<e.children.length;++i){var t=e.children[i];if(this._nodeIsVisible(t)){var r=this._nodeIndex[t.id];o=o||null==r||this._allSubtreesIncomplete(r)}}return o},e.prototype.setLodGlobalDirty=function(){this._lodGlobalDirty=!0,this.lodGlobalDirtyChanged(this._lodGlobalDirty)},e.prototype.finishedLevel=function(e){"perLevel"===this._lodMode&&this._deleteUpToLevelRecurse(e-1,0,this._nodeIndex[this._rootId])},e.prototype._deleteUpToLevelRecurse=function(e,o,t){if(null!=t&&!(o>e)&&(this._nodeTraversalState(t.id).isChosenLOD||(i&&console.debug("_deleteUpToLevelRecurse: removing node "+t.id),this.layerViewRequiredFunctions.removeNodeData(t)),null!=t.children))for(var r=0;r<t.children.length;++r){var n=t.children[r];this._deleteUpToLevelRecurse(e,o+1,this._nodeIndex[n.id])}},e.prototype.lodSwapBundleLoaded=function(e,o,t){if(i&&console.debug("lodSwapBundleLoaded "+e.id),null!=t)if(null!=t.swapPairs&&Object.keys(t.swapPairs).length>0){if(null!=o){for(var r=t.swapPairs,n={},d=0;d<o.length;d++)for(var l=o[d].features,a=0;a<l.length;a++)n[l[a].id]=!0;for(var s in r){for(var u=r[s],h=[],p=u.features,f=0;f<p.length;f++)null!=n[p[f]]&&h.push(p[f]);this.layerViewRequiredFunctions.removeFeatures(u.node,u.features)}}}else{for(var c in t.nodesHigherInTree)this.layerViewRequiredFunctions.removeNodeData(t.nodesHigherInTree[c]);for(var c in t.nodesDeeperInTree)this.layerViewRequiredFunctions.removeNodeData(t.nodesDeeperInTree[c])}this.setLodGlobalDirty()},Object.defineProperty(e.prototype,"requiresLODGlobalHandling",{get:function(){return"global"===this._lodMode&&null!=this._rootId&&(this._lodGlobalDirty===!0||this.layerViewRequiredFunctions.isOverMemory())},enumerable:!0,configurable:!0}),e.prototype.lodGlobalHandling=function(){if(this.requiresLODGlobalHandling){var e=this._rootId;t&&console.debug("****************** _perNodeLodHandling started *******************");var o={id:e,mbs:null};this._lodGlobalHandlingRecursion(o,this._nodeIndex,!1,!1,0),this._lodGlobalHandlingRecursionRemoveIntermediate(e,this._nodeIndex,!1,0),this._lodGlobalDirty=!1,this.lodGlobalDirtyChanged(this._lodGlobalDirty)}},e.prototype.lodSwapBuildInfoForNode=function(e){var o=!0;i&&console.debug("lodSwapBuildInfoForNode: node "+e.id);var t=this._nodeTraversalState(e.id).nodeHasLOD;if(!t)return null;if("swap"===this._lodMode){var r={},n={},d={},l=!1,a=!1,s=e.id+"";for(var u in this._lodSwapNodeIndex){var h=this._lodSwapNodeIndex[u],p=this.layerViewRequiredFunctions.getAddedFeatures(h.id);if(null!=p&&(l=null===e.parentNode||0===(h.id+"").indexOf(s),a=null==h.parentNode||0===s.indexOf(h.id+""),a===!0&&(d[h.id]=h),l===!0)){if(n[h.id]=h,o)continue;for(var f=0;f<p.length;f++)null==r&&(r={}),null==r[u]&&(r[u]={features:[],node:h}),r[u].features.push(p[f])}}if(null!=e.features&&!o)for(var c in e.features){var v=e.features[c];if(null!=v.rootFeature){var _=this._lodSwapRootFeatureLookup[v.rootFeature];if(null!=_)for(var g=0;g<_.length;g++){var y=_[g].node;if(null!=y&&null==n[y.id]&&null!=d[y.id]){var b=y.id;null==r[b]&&(r[b]={features:[],node:y}),r[b].features.push(_[g].featureId)}}var F=this._lodSwapFeatureLookup[v.rootFeature];if(null!=F&&!n[F.id]){var w=F.id;null==r[w]&&(r[w]={features:[],node:F}),r[w].features.push(v.rootFeature)}}}if(i&&o){var I={},L={};for(var S in this._nodeIndex){var R=this._nodeIndex[S],p=this.layerViewRequiredFunctions.getAddedFeatures(S);null!=p&&(l=null===e.parentNode||0===(S+"").indexOf(s),a=null==R.parentNode||0===s.indexOf(S+""),a===!0&&(L[S]=R),l===!0&&(I[S]=R))}(Object.keys(L).length!==Object.keys(d).length||Object.keys(I).length!==Object.keys(n).length)&&console.debug("!! mismatch node nodesInTreeAll vs nodesInTree from unmatchingLodNodeId")}if(o){if(i){var m="nodesHigherInTree: ";for(var D in d)m+="["+d[D].id+"], ";m+=" nodesDeeperInTree: ";for(var D in n)m+="["+n[D].id+"], ";console.debug("_lodSwapBuildInfoForNode: node "+e.id+", swapPairs "+m)}return{nodesHigherInTree:d,nodesDeeperInTree:n}}if(i&&r){var m="";for(var D in r)m+="["+r[D].features+", nodeId: "+r[D].node.id+"], ";console.debug("_lodSwapBuildInfoForNode: node "+e.id+", swapPairs "+m)}return{swapPairs:r}}if("perLevel"===this._lodMode&&this._nodeTraversalState(e.id).isChosenLOD){var n={};return this._getNodesRecurse(e,n),{nodesHigherInTree:null,nodesDeeperInTree:n}}},e.prototype._getNodesRecurse=function(e,o){if(null!=e.children)for(var i=0;i<e.children.length;++i){var t=e.children[i],r=this._nodeIndex[t.id];null!=r&&(o[t.id]=r,this._getNodesRecurse(r,o))}},e.prototype._lodSwapBuildUnmatchingFeatureLookups=function(){this._lodSwapFeatureLookup={},this._lodSwapRootFeatureLookup={};for(var e in this._lodSwapNodeIndex){var o=this._lodSwapNodeIndex[e],i=this.layerViewRequiredFunctions.getAddedFeatures(o.id);if(null!=i)for(var t=0;t<i.length;t++){var r=i[t];this._lodSwapFeatureLookup[r.id]=o,null!=r.rootFeature&&(null==this._lodSwapRootFeatureLookup[r.rootFeature]&&(this._lodSwapRootFeatureLookup[r.rootFeature]=[]),this._lodSwapRootFeatureLookup[r.rootFeature].push({node:o,featureId:r.id}))}}},e.prototype._validateLodTreeVisibilities=function(){if(null!=this.layerViewOptionalFunctions.getAllAddedFeatures){var e=this.layerViewOptionalFunctions.getAllAddedFeatures();console.debug("validating lod tree: ");var o={},i={},t=!0;for(var r in e)for(var n=e[r],d=0;d<n.length;d++){var l=n[d];null!=o[l.id]&&o[l.id]!==r&&(console.debug("node "+r+" !! encountered feature "+l.id+" already in node "+o[l.id]),t=!1),null!=i[l.id]&&i[l.id]!==r&&(console.debug("node "+r+" !! encountered feature "+l.id+" already as rootFeature in node "+i[l.id]),t=!1),o[l.id]=r,null!=l.rootFeature&&i[l.rootFeature]!==r&&(null!=i[l.rootFeature]&&(console.debug("node "+r+" !! encountered rootFeature "+l.rootFeature+" already in node "+i[l.rootFeature]),t=!1),null!=o[l.rootFeature]&&(console.debug("node "+r+" !! encountered rootFeature "+l.rootFeature+" already as feature"),t=!1),i[l.rootFeature]=r)}return t}},e.prototype._lodGlobalHandlingRecursion=function(e,o,i,r,n){var d=e.id,l=o[d];if(null==l){var a=null!=e.mbs?this._nodeIsVisible(e):!1,s=r||!a;return t&&console.debug(new Array(n).join(" ")+"node == null id "+d+" isComplete "+s+" higherNodeIsChosen "+r+" isVisible "+a),s}var u=this._nodeTraversalState(d),h=this._nodeIsVisible(l),p=u.isChosenLOD,f=this.layerViewRequiredFunctions.isBundleAlreadyAddedToStage(l,0),c=!0;if(null!=l.children)for(var v=0;v<l.children.length;++v){var _=l.children[v],g=this._lodGlobalHandlingRecursion(_,o,f&&p||i,p||r,n+1);g||(c=!1)}var y=this.layerViewRequiredFunctions.isOverMemory();if(f&&!p&&((r?i:c)||y)&&(this.setLodGlobalDirty(),this.layerViewRequiredFunctions.removeNodeData(l),f=!1,t&&console.debug(new Array(n).join(" ")+"**qeued node removal id "+l.id)),f&&this.layerViewOptionalFunctions.setPolygonOffset){var b=!(p&&!r);this.layerViewOptionalFunctions.setPolygonOffset(l,b)}var F=c||f;return(p&&f||!h||r)&&(F=!0),p&&!f&&h&&(F=!1),t&&console.debug(new Array(n).join(" ")+"id "+l.id+" isComplete "+F+" isVisible "+h+" isAddedToStage "+f+" isChosenLOD "+p+" subtreeComplete "+c+" higherNodeIsShown "+i+" higherNodeIsChosen "+r),F},e.prototype._lodGlobalHandlingRecursionRemoveIntermediate=function(e,o,i,t){var r=o[e];if(null!=r){var n=this.layerViewRequiredFunctions.isBundleAlreadyAddedToStage(r,0),d=this._nodeTraversalState(e),l=d.isChosenLOD;if(null!=r.children)for(var a=0;a<r.children.length;++a){var s=r.children[a];this._lodGlobalHandlingRecursionRemoveIntermediate(s.id,o,n||i,t+1)}i&&!l&&n&&(this.layerViewRequiredFunctions.removeNodeData(r),this.setLodGlobalDirty())}},e}();return r});