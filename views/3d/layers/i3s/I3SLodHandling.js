/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/PooledArray"],(function(e,i,n){"use strict";let o=function(){function n(e){this.layerView=e,this._lodGlobalDirty=!1}var o=n.prototype;return o.startNodeLoading=function(e,i,n,o){this._maxLodLevel=o.maxLodLevel,this._index=n,this._isNodeInScaleBounds=e,this._removeNodes=i},o.shouldLoadNode=function(e){if(i.isNone(e))return!1;const n=this._index.nodeTraversalState(e);return!!this.isChosenMaxLOD(n)||!!n.isChosen&&this._childrenRequireLoading(e)},o.setLodGlobalDirty=function(){this._lodGlobalDirty=!0},o.lodGlobalHandling=function(e){if(!this.requiresLODGlobalHandling)return!1;this._lodGlobalDirty=!1;const i=this.layerView.view.resourceController.memoryController.usedMemory,n=Math.max(0,Math.floor(10*(i-1)));t.clear(),this._lodGlobalHandling(this._index.rootNode,n,!1);const o=t.length;this._removeNodes(t,e);const s=t.length<o;return 0!==t.length&&(this._lodGlobalDirty=!0),t.clear(),s},o._lodGlobalHandling=function(e,n,o){if(i.isNone(e))return!1;const s=e.index,l=this._index,d=this.layerView,r=l.nodeTraversalState(e),a=this.isChosenMaxLOD(r),h=d.isNodeLoaded(s),u=d.nodeCrossfadingEnabled;if(u&&h&&a){const i=!o&&this.hasNoVisibleChildren(e);d.fadeNode(s,0,!i)}const c=h&&(!d.isNodeFullyFadedIn||d.isNodeFullyFadedIn(s));if(h&&(d.updateNodeState(s,a?1:0),a))return c&&this._removeChildrenRecursive(e),c;const _=e.childCount>0;let x=_;if(_)for(let t=0;t<e.childCount;t++){const s=l.getChildIndex(e,t),d=l.getNode(s);if(i.isSome(d)){!(!l.isGeometryVisible(s)||this._lodGlobalHandling(d,n,o||c))&&this._isNodeInScaleBounds(d)&&(x=!1)}else l.isNodeVisible(s)&&(x=!1)}const f=h&&!a&&(x||t.length<n);f&&t.push(s),!u||f||!h||o||x||d.fadeNode(s,0,!1);const N=!e.resources.hasFeatureData;return x||c&&!f||N},o._removeChildrenRecursive=function(e){this._index.traverseChildren(e,(e=>((this.layerView.isNodeLoaded(e.index)||this.layerView.isNodeReloading(e.index))&&t.push(e.index),!0)))},o.hasNoVisibleChildren=function(e){let i=!0;return this._index.traverseChildren(e,(e=>!(!i||!this._index.isNodeVisible(e.index))&&(!this.layerView.isNodeLoaded(e.index)||(i=!1,!1)))),i},o._childrenRequireLoading=function(e){let i=!1,n=!0;return this._index.traverseChildren(e,(e=>{if(!n||!this._index.isNodeVisible(e.index))return!1;const o=this._index.nodeTraversalState(e);return this.isChosenMaxLOD(o)&&this._index.isGeometryVisible(e.index)&&(i=!0),!this.layerView.isNodeLoaded(e.index)||(n=!1,!1)})),n&&i},o.isChosenMaxLOD=function(e){return e.isChosen&&(!e.nodeHasLOD||e.lodLevel===this._maxLodLevel)},e._createClass(n,[{key:"requiresLODGlobalHandling",get:function(){return null!=this._index&&!0===this._lodGlobalDirty}}]),n}();const t=new n({deallocator:null});return o}));
