/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/has","../../../core/Logger","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass","../../../core/urlUtils","../../../core/uuid","../../../portal/support/resourceExtension","../../../core/promiseUtils","../../../core/watchUtils","../../2d/engine/vectorTiles/SchemaHelper","../../2d/engine/vectorTiles/style/StyleRepository","../terrain/terrainUtils","./LayerView3D","./TiledLayerView3D","../../layers/LayerView","../../2d/engine/vectorTiles/TileHandler","../../2d/engine/vectorTiles/VTLPainter3D"],(function(e,t,r,i,l,s,o,n,a,h,c,p,d,y,u,g,_,m,f,H){"use strict";let v=function(t){function r(e){return t.call(this,e)||this}e._inheritsLoose(r,t);var i=r.prototype;return i.initialize=function(){const e=u.test.force512VTL?this.layer.tileInfo:this.layer.compatibleTileInfo256,t=this._getTileInfoSupportError(e,this.layer.fullExtent);if(t)return void this.addResolvingPromise(c.reject(t));const r=p.whenTrueOnce(this.view,"basemapTerrain.tilingSchemeLocked").then((()=>{const e=this.view.basemapTerrain.tilingScheme,t=e.pixelSize;let r;this.schemaHelper=new d(t,this.view.spatialReference.isGeographic),r=256===t?this.layer.compatibleTileInfo256:this.view.spatialReference.isGeographic?this.layer.compatibleTileInfo512:this.layer.tileInfo;const i=this._getTileInfoCompatibilityError(r,e);if(i)throw i;this._set("tileInfo",r)}));this._tileHandlerController=c.createAbortController(),this._memCache=this.view.resourceController.memoryController.getMemCache(this.layer.uid,(e=>this.tileHandler.releaseVectorTile(e)));const i=this.view.resourceController.scheduler,{style:l,spriteUrl:s,glyphsUrl:o}=this.layer.currentStyleInfo;this.tileHandler=new f.TileHandler(this.layer,new y(l,{spriteUrl:s,glyphsUrl:o}),this.view.pixelRatio,this._memCache);const n=this.tileHandler.start({signal:this._tileHandlerController.signal,scheduler:i}),a=this.tileHandler.spriteMosaic;a.then((e=>this.painter=new H(e,this.tileHandler.glyphMosaic))),n.then((()=>this._tileHandlerController=null));const h=()=>{this._tileHandlerController&&this._tileHandlerController.abort(),this._tileHandlerController=c.createAbortController(),this._memCache.clear();const{style:e,spriteUrl:t,glyphsUrl:r}=this.layer.currentStyleInfo,l=new f.TileHandler(this.layer,new y(e,{spriteUrl:t,glyphsUrl:r}),this.view.pixelRatio,this._memCache),s=l.start({signal:this._tileHandlerController.signal,scheduler:i}),o=l.spriteMosaic;s.then((()=>this._tileHandlerController=null)),this.updatingHandles.addPromise(c.all([s,o]).then((([,e])=>{const t=this.tileHandler,r=this.painter;this.painter=new H(e,l.glyphMosaic),this.tileHandler=l,this.emit("data-changed"),t.destroy(),r&&r.dispose()})))};this.updatingHandles.add(this,"layer.currentStyleInfo",h),this.updatingHandles.add(this,"view.pixelRatio",h);const g=c.all([r,n,a]);this.addResolvingPromise(g)},i.destroy=function(){this._memCache&&(this._memCache.destroy(),this._memCache=null),this.painter&&(this.painter.dispose(),this.painter=null),this._tileHandlerController&&(this._tileHandlerController.abort(),this._tileHandlerController=null),this.tileHandler&&(this.tileHandler.destroy(),this.tileHandler=null)},e._createClass(r,[{key:"dataLevelRange",get:function(){const e=this.tileInfo.lods,t=e[0].scale,r=e[e.length-1].scale,i=this.levelRangeFromScaleRange(t,r);return 1===i.minLevel&&256===this.tileInfo.size[0]&&(i.minLevel=0),i}}]),r}(_.TiledLayerView3D(g.LayerView3D(m)));return t.__decorate([s.property({aliasOf:"layer.fullExtent"})],v.prototype,"fullExtent",void 0),t.__decorate([s.property()],v.prototype,"layer",void 0),t.__decorate([s.property()],v.prototype,"tileInfo",void 0),t.__decorate([s.property()],v.prototype,"dataLevelRange",null),t.__decorate([s.property()],v.prototype,"updatingProgressValue",void 0),v=t.__decorate([o.subclass("esri.views.3d.layers.VectorTileLayerView3D")],v),v}));
