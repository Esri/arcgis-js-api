/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/has","../../../core/maybe","../../../core/Logger","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass","../../../core/urlUtils","../../../core/uuid","../../../portal/support/resourceExtension","../../../core/promiseUtils","../../../core/watchUtils","../../2d/engine/vectorTiles/SchemaHelper","../../2d/engine/vectorTiles/style/StyleRepository","../terrain/terrainUtils","./LayerView3D","./TiledLayerView3D","../../layers/LayerView","../../2d/engine/vectorTiles/TileHandler3D","../../2d/engine/vectorTiles/VTLPainter3D"],(function(e,t,r,i,l,s,o,n,a,h,c,p,d,y,u,g,m,_,f,H,C){"use strict";let v=function(t){function r(e){return t.call(this,e)||this}e._inheritsLoose(r,t);var l=r.prototype;return l.initialize=function(){const e=g.test.force512VTL?this.layer.tileInfo:this.layer.compatibleTileInfo256,t=this._getTileInfoSupportError(e,this.layer.fullExtent);if(t)return void this.addResolvingPromise(Promise.reject(t));const{basemapTerrain:r,spatialReference:i,pixelRatio:l}=this.view,s=d.whenTrueOnce(this.view,"basemapTerrain.tilingSchemeLocked").then((()=>{const e=r.tilingScheme,t=e.pixelSize;let l;this.schemaHelper=new y(t,i.isGeographic),l=256===t?this.layer.compatibleTileInfo256:this.view.spatialReference.isGeographic?this.layer.compatibleTileInfo512:this.layer.tileInfo;const s=this._getTileInfoCompatibilityError(l,e);if(s)throw s;this._set("tileInfo",l)}));this._tileHandlerController=p.createAbortController();const{memoryController:o,scheduler:n}=this.view.resourceController;this._memCache=o.getMemCache(this.layer.uid,(e=>e.release()));const{style:a,spriteUrl:h,glyphsUrl:c}=this.layer.currentStyleInfo,m=new u(a,{spriteUrl:h,glyphsUrl:c}),_=r.mapTileRequester;this.tileHandler=new H(this.layer,m,l,this._memCache,_);const f=this._tileHandlerController.signal,v=this.tileHandler.start({signal:f,scheduler:n}),w=this.tileHandler.spriteMosaic;w.then((e=>{!p.isAborted(f)&&this.tileHandler&&(this.painter=new C(e,this.tileHandler.glyphMosaic))})),v.then((()=>this._tileHandlerController=null));const T=()=>{this._tileHandlerController&&this._tileHandlerController.abort(),this._tileHandlerController=p.createAbortController(),this._memCache.clear();const{style:e,spriteUrl:t,glyphsUrl:r}=this.layer.currentStyleInfo,i=new u(e,{spriteUrl:t,glyphsUrl:r}),s=new H(this.layer,i,l,this._memCache,_),o=s.start({signal:this._tileHandlerController.signal,scheduler:n}),a=s.spriteMosaic;o.then((()=>this._tileHandlerController=null)),this.updatingHandles.addPromise(Promise.all([o,a]).then((([,e])=>{const t=this.tileHandler,r=this.painter;this.painter=new C(e,s.glyphMosaic),this.tileHandler=s,this.emit("data-changed"),t.destroy(),r&&r.dispose()})))};this.updatingHandles.add(this,"layer.currentStyleInfo",T),this.updatingHandles.add(this,"view.pixelRatio",T);const b=Promise.all([s,v,w]);this.addResolvingPromise(b)},l.destroy=function(){this.painter=i.disposeMaybe(this.painter),this._tileHandlerController&&(this._tileHandlerController.abort(),this._tileHandlerController=null),i.destroyMaybe(this.tileHandler),this._memCache=i.destroyMaybe(this._memCache),this.tileHandler=null},e._createClass(r,[{key:"dataLevelRange",get:function(){const e=this.tileInfo.lods,t=e[0].scale,r=e[e.length-1].scale,i=this.levelRangeFromScaleRange(t,r);return 1===i.minLevel&&256===this.tileInfo.size[0]&&(i.minLevel=0),i}}]),r}(_.TiledLayerView3D(m.LayerView3D(f)));return t.__decorate([o.property({aliasOf:"layer.fullExtent"})],v.prototype,"fullExtent",void 0),t.__decorate([o.property()],v.prototype,"layer",void 0),t.__decorate([o.property()],v.prototype,"tileInfo",void 0),t.__decorate([o.property()],v.prototype,"dataLevelRange",null),t.__decorate([o.property()],v.prototype,"updatingProgressValue",void 0),v=t.__decorate([n.subclass("esri.views.3d.layers.VectorTileLayerView3D")],v),v}));
