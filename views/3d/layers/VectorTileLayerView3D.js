/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/maybe","../../../core/promiseUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/accessorSupport/ensureType","../../../core/Logger","../../../core/accessorSupport/decorators/subclass","../../2d/engine/vectorTiles/SchemaHelper","../../2d/engine/vectorTiles/TileHandler3D","../../2d/engine/vectorTiles/VTLPainter3D","../../2d/engine/vectorTiles/style/StyleRepository","./LayerView3D","./TiledLayerView3D","../terrain/terrainUtils","../../layers/LayerView"],(function(e,t,r,i,l,s,o,n,a,h,c,p,d,y,u,_,g,m){"use strict";let f=function(t){function s(e){var r;return(r=t.call(this,e)||this).type="vector-tile-3d",r}e._inheritsLoose(s,t);var o=s.prototype;return o.initialize=function(){const e=g.test.force512VTL?this.layer.tileInfo:this.layer.compatibleTileInfo256,t=this._getTileInfoSupportError(e,this.layer.fullExtent);if(t)return void this.addResolvingPromise(Promise.reject(t));const{basemapTerrain:r,spatialReference:s,pixelRatio:o}=this.view,n=l.whenTrueOnce(this.view,"basemapTerrain.tilingSchemeLocked").then((()=>{const e=r.tilingScheme,t=e.pixelSize;let i;this.schemaHelper=new c(t,s.isGeographic),i=256===t?this.layer.compatibleTileInfo256:this.view.spatialReference.isGeographic?this.layer.compatibleTileInfo512:this.layer.tileInfo;const l=this._getTileInfoCompatibilityError(i,e);if(l)throw l;this._set("tileInfo",i)}));this._tileHandlerController=i.createAbortController();const a=this.view.resourceController;this._memCache=a.memoryController.getMemCache(this.layer.uid,(e=>e.release()));const{style:h,spriteUrl:u,glyphsUrl:_}=this.layer.currentStyleInfo,m=new y(h,{spriteUrl:u,glyphsUrl:_}),f=r.mapTileRequester;this._tileHandler=new p(this.layer,m,o,this._memCache,f);const H=this._tileHandlerController.signal,v=e=>a.schedule(e),C=this._tileHandler.start({signal:H,schedule:v}),T=this._tileHandler.spriteMosaic;T.then((e=>{!i.isAborted(H)&&this._tileHandler&&(this.painter=new d(e,this._tileHandler.glyphMosaic))})),C.then((()=>this._tileHandlerController=null));const w=()=>{this._tileHandlerController&&this._tileHandlerController.abort(),this._tileHandlerController=i.createAbortController(),this._memCache.clear();const{style:e,spriteUrl:t,glyphsUrl:r}=this.layer.currentStyleInfo,l=new y(e,{spriteUrl:t,glyphsUrl:r}),s=new p(this.layer,l,o,this._memCache,f),n=s.start({signal:this._tileHandlerController.signal,schedule:v}),a=s.spriteMosaic;n.then((()=>this._tileHandlerController=null)),this.updatingHandles.addPromise(Promise.all([n,a]).then((([,e])=>{const t=this._tileHandler,r=this.painter;this.painter=new d(e,s.glyphMosaic),this._tileHandler=s,this.emit("data-changed"),t.destroy(),r&&r.dispose()})))};this.updatingHandles.add(this,"layer.currentStyleInfo",w),this.updatingHandles.add(this,"view.pixelRatio",w);const b=Promise.all([n,C,T]);this.addResolvingPromise(b)},o.destroy=function(){this.painter=r.disposeMaybe(this.painter),this._tileHandlerController&&(this._tileHandlerController.abort(),this._tileHandlerController=null),r.destroyMaybe(this._tileHandler),this._memCache=r.destroyMaybe(this._memCache),this._tileHandler=null},o.fetchTile=function(){var t=e._asyncToGenerator((function*(e,t,r,i){return this._tileHandler.getVectorTile(e,t,r,i)}));function r(e,r,i,l){return t.apply(this,arguments)}return r}(),e._createClass(s,[{key:"dataLevelRange",get:function(){const e=this.tileInfo.lods,t=e[0].scale,r=e[e.length-1].scale,i=this.levelRangeFromScaleRange(t,r);return 1===i.minLevel&&256===this.tileInfo.size[0]&&(i.minLevel=0),i}}]),s}(_.TiledLayerView3D(u.LayerView3D(m)));return t.__decorate([s.property({aliasOf:"layer.fullExtent"})],f.prototype,"fullExtent",void 0),t.__decorate([s.property()],f.prototype,"layer",void 0),t.__decorate([s.property()],f.prototype,"tileInfo",void 0),t.__decorate([s.property()],f.prototype,"dataLevelRange",null),t.__decorate([s.property()],f.prototype,"updatingProgressValue",void 0),f=t.__decorate([h.subclass("esri.views.3d.layers.VectorTileLayerView3D")],f),f}));
