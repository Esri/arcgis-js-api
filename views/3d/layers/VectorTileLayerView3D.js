/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Error","../../../core/maybe","../../../core/promiseUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../2d/engine/vectorTiles/SchemaHelper","../../2d/engine/vectorTiles/TileHandler3D","../../2d/engine/vectorTiles/VTLPainter3D","../../2d/engine/vectorTiles/style/StyleRepository","./LayerView3D","./TiledLayerView3D","../terrain/terrainUtils","../../layers/LayerView"],(function(e,t,i,r,l,s,n,o,a,h,c,d,p,y,u,_,f,m,g){"use strict";let v=function(t){function n(){var e;return(e=t.apply(this,arguments)||this).type="vector-tile-3d",e}e._inheritsLoose(n,t);var o=n.prototype;return o.initialize=function(){if(r.isNone(this.layer.fullExtent))return void this.addResolvingPromise(Promise.reject(new i("vectortilelayerview:full-extent-undefined","This layer view's layer does not define a fullExtent.")));const e=m.test.force512VTL?this.layer.tileInfo:this.layer.compatibleTileInfo256,t=this._getTileInfoSupportError(e,this.layer.fullExtent);if(t)return this.addResolvingPromise(Promise.reject(t));const{basemapTerrain:n,spatialReference:o,pixelRatio:a}=this.view,h=s.whenTrueOnce(this.view,"basemapTerrain.tilingSchemeLocked").then((()=>{const e=n.tilingScheme,t=e.pixelSize;let i;this.schemaHelper=new d(t,o.isGeographic),i=256===t?this.layer.compatibleTileInfo256:this.view.spatialReference.isGeographic?this.layer.compatibleTileInfo512:this.layer.tileInfo;const r=this._getTileInfoCompatibilityError(i,e);if(r)throw r;this._set("tileInfo",i)}));this._tileHandlerController=new AbortController;const c=this.view.resourceController;this._memCache=c.memoryController.newCache(this.layer.uid,(e=>{e.release()}));const{style:_}=this.layer.currentStyleInfo,f=new u(_),g=n.mapTileRequester;this._tileHandler=new p(this.layer,f,a,this._memCache,g);const v=this._tileHandlerController.signal,w=e=>c.schedule(e),H=this._tileHandler.start({signal:v,schedule:w}),C=this._tileHandler.spriteMosaic;C.then((e=>{!l.isAborted(v)&&this._tileHandler&&(this.painter=new y(e,this._tileHandler.glyphMosaic))})),H.then((()=>this._tileHandlerController=null));const T=()=>{this._tileHandlerController&&this._tileHandlerController.abort(),this._tileHandlerController=new AbortController,this._memCache.clear();const{style:e}=this.layer.currentStyleInfo,t=new u(e),i=new p(this.layer,t,a,this._memCache,g),r=i.start({signal:this._tileHandlerController.signal,schedule:w}),l=i.spriteMosaic;r.then((()=>this._tileHandlerController=null)),this.updatingHandles.addPromise(Promise.all([r,l]).then((([,e])=>{const t=this._tileHandler,r=this.painter;this.painter=new y(e,i.glyphMosaic),this._tileHandler=i,this.emit("data-changed"),t.destroy(),r&&r.dispose()})))};this.updatingHandles.add(this,"layer.currentStyleInfo",T),this.updatingHandles.add(this,"view.pixelRatio",T);const b=Promise.all([h,H,C]);this.addResolvingPromise(b)},o.destroy=function(){this.painter=r.disposeMaybe(this.painter),this._tileHandlerController&&(this._tileHandlerController.abort(),this._tileHandlerController=null),r.destroyMaybe(this._tileHandler),this._memCache=r.destroyMaybe(this._memCache),this._tileHandler=null},o.fetchTile=function(){var t=e._asyncToGenerator((function*(e,t,i,r){return this._tileHandler.getVectorTile(e,t,i,r)}));function i(e,i,r,l){return t.apply(this,arguments)}return i}(),e._createClass(n,[{key:"dataLevelRange",get:function(){const e=this.tileInfo.lods,t=e[0].scale,i=e[e.length-1].scale,r=this.levelRangeFromScaleRange(t,i);return 1===r.minLevel&&256===this.tileInfo.size[0]&&(r.minLevel=0),r}}]),n}(f.TiledLayerView3D(_.LayerView3D(g)));t.__decorate([n.property({aliasOf:"layer.fullExtent"})],v.prototype,"fullExtent",void 0),t.__decorate([n.property()],v.prototype,"layer",void 0),t.__decorate([n.property()],v.prototype,"tileInfo",void 0),t.__decorate([n.property()],v.prototype,"dataLevelRange",null),t.__decorate([n.property()],v.prototype,"updatingProgressValue",void 0),v=t.__decorate([c.subclass("esri.views.3d.layers.VectorTileLayerView3D")],v);return v}));
