/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Error","../../../core/maybe","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/accessorSupport/decorators/subclass","../../2d/engine/vectorTiles/SchemaHelper","../../2d/engine/vectorTiles/TileHandler3D","../../2d/engine/vectorTiles/VTLPainter3D","../../2d/engine/vectorTiles/style/StyleRepository","./LayerView3D","./TiledLayerView3D","../terrain/terrainUtils","../../layers/LayerView"],(function(e,t,i,r,l,s,n,a,o,c,h,d,p,y,u,m,f,_){"use strict";let g=function(t){function n(){var e;return(e=t.apply(this,arguments)||this)._tileHandlerController=null,e.type="vector-tile-3d",e}e._inheritsLoose(n,t);var a=n.prototype;return a.initialize=function(){if(r.isNone(this.layer.fullExtent))return void this.addResolvingPromise(Promise.reject(new i("vectortilelayerview:full-extent-undefined","This layer view's layer does not define a fullExtent.")));const{basemapTerrain:e,spatialReference:t,state:n,viewingMode:a}=this.view,o="local"===a&&!f.vtlAssumes256PixelSizeAsDefault(t)||f.test.force512VTL,c=this.layer.tileInfo.spatialReference.isGeographic,u=o?this.layer.tileInfo:this.layer.tileInfo.getOrCreateCompatible(256,c?1:2),m=this._getTileInfoSupportError(u,this.layer.fullExtent);if(r.isSome(m))return this.addResolvingPromise(Promise.reject(m));const _=s.whenOnce((()=>this.view?.basemapTerrain?.tilingSchemeLocked)).then((()=>{const t=e.tilingScheme,i=t.pixelSize;let l;if(this.schemaHelper=new h.SchemaHelper(i,r.isSome(e.spatialReference)&&e.spatialReference.isGeographic),256===i){const e=this.layer.tileInfo.spatialReference.isGeographic;l=this.layer.tileInfo.getOrCreateCompatible(256,e?1:2)}else l=this.view.spatialReference?.isGeographic?this.layer.tileInfo.getOrCreateCompatible(512,.5):this.layer.tileInfo;const s=this._getTileInfoCompatibilityError(l,t);if(s)throw s;this.tileInfo=l}));this._tileHandlerController=new AbortController;const g=this.view.resourceController;this._memCache=g.memoryController.newCache(this.layer.uid,(e=>{e.release()}));const v=new y(this.layer.currentStyleInfo.style),C=e.mapTileRequester;this._tileHandler=new d(this.layer,v,n.contentPixelRatio,this._memCache,C);const w=this._tileHandlerController.signal,H=e=>g.immediate.schedule(e),b=this._tileHandler.start({signal:w,schedule:H}),T=this._tileHandler.spriteMosaic;T.then((e=>{!l.isAborted(w)&&this._tileHandler&&(this.painter=new p(e,this._tileHandler.glyphMosaic))})),b.then((()=>this._tileHandlerController=null)),this.updatingHandles.add((()=>({style:this.layer.currentStyleInfo.style,pixelRatio:this.view.state?.contentPixelRatio})),(({style:e,pixelRatio:t})=>{this._tileHandlerController&&this._tileHandlerController.abort(),this._tileHandlerController=new AbortController,this._memCache.clear();const i=new y(e),r=new d(this.layer,i,t,this._memCache,C),l=r.start({signal:this._tileHandlerController.signal,schedule:H}),s=r.spriteMosaic;l.then((()=>this._tileHandlerController=null)),this.updatingHandles.addPromise(Promise.all([l,s]).then((([,e])=>{const t=this._tileHandler,i=this.painter;this.painter=new p(e,r.glyphMosaic),this._tileHandler=r,this.emit("data-changed"),t.destroy(),i&&i.dispose()})))}));const R=Promise.all([_,b,T]);this.addResolvingPromise(R)},a.destroy=function(){this.painter=r.disposeMaybe(this.painter),this._tileHandlerController=r.abortMaybe(this._tileHandlerController),r.destroyMaybe(this._tileHandler),this._memCache=r.destroyMaybe(this._memCache),this._tileHandler=null},a.fetchTile=function(){var t=e._asyncToGenerator((function*(e,t,i,r){return this._tileHandler.getVectorTile(e,t,i,r)}));function i(e,i,r,l){return t.apply(this,arguments)}return i}(),e._createClass(n,[{key:"dataLevelRange",get:function(){const e=this.tileInfo.lods,t=e[0].scale,i=e[e.length-1].scale,r=this.levelRangeFromScaleRange(t,i);return 1===r.minLevel&&256===this.tileInfo.size[0]&&(r.minLevel=0),r}}]),n}(m.TiledLayerView3D(u.LayerView3D(_)));t.__decorate([n.property()],g.prototype,"layer",void 0),t.__decorate([n.property()],g.prototype,"dataLevelRange",null),t.__decorate([n.property()],g.prototype,"updatingProgressValue",void 0),g=t.__decorate([c.subclass("esri.views.3d.layers.VectorTileLayerView3D")],g);return g}));
