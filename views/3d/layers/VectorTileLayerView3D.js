/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Error","../../../core/maybe","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../2d/engine/vectorTiles/SchemaHelper","../../2d/engine/vectorTiles/TileHandler3D","../../2d/engine/vectorTiles/VTLPainter3D","../../2d/engine/vectorTiles/style/StyleRepository","./LayerView3D","./TiledLayerView3D","../terrain/terrainUtils","../../layers/LayerView"],(function(e,t,i,r,l,s,n,a,o,h,c,d,p,y,u,f,m,_){"use strict";let g=function(t){function n(){var e;return(e=t.apply(this,arguments)||this).type="vector-tile-3d",e}e._inheritsLoose(n,t);var a=n.prototype;return a.initialize=function(){if(r.isNone(this.layer.fullExtent))return void this.addResolvingPromise(Promise.reject(new i("vectortilelayerview:full-extent-undefined","This layer view's layer does not define a fullExtent.")));const{basemapTerrain:e,spatialReference:t,state:n,viewingMode:a}=this.view,{pixelRatio:o}=n,h="local"===a&&!m.vtlAssumes256PixelSizeAsDefault(t)||m.test.force512VTL,u=this.layer.tileInfo.spatialReference.isGeographic,f=h?this.layer.tileInfo:this.layer.tileInfo.getOrCreateCompatible(256,u?1:2),_=this._getTileInfoSupportError(f,this.layer.fullExtent);if(r.isSome(_))return this.addResolvingPromise(Promise.reject(_));const g=s.whenOnce((()=>this.view?.basemapTerrain?.tilingSchemeLocked)).then((()=>{const t=e.tilingScheme,i=t.pixelSize;let l;if(this.schemaHelper=new c.SchemaHelper(i,r.isSome(e.spatialReference)&&e.spatialReference.isGeographic),256===i){const e=this.layer.tileInfo.spatialReference.isGeographic;l=this.layer.tileInfo.getOrCreateCompatible(256,e?1:2)}else l=this.view.spatialReference.isGeographic?this.layer.tileInfo.getOrCreateCompatible(512,.5):this.layer.tileInfo;const s=this._getTileInfoCompatibilityError(l,t);if(s)throw s;this.tileInfo=l}));this._tileHandlerController=new AbortController;const v=this.view.resourceController;this._memCache=v.memoryController.newCache(this.layer.uid,(e=>{e.release()}));const C=new y(this.layer.currentStyleInfo.style),w=e.mapTileRequester;this._tileHandler=new d(this.layer,C,o,this._memCache,w);const H=this._tileHandlerController.signal,T=e=>v.schedule(e),b=this._tileHandler.start({signal:H,schedule:T}),R=this._tileHandler.spriteMosaic;R.then((e=>{!l.isAborted(H)&&this._tileHandler&&(this.painter=new p(e,this._tileHandler.glyphMosaic))})),b.then((()=>this._tileHandlerController=null)),this.updatingHandles.add((()=>({style:this.layer.currentStyleInfo.style,newPixelRatio:this.view.state?.pixelRatio})),(({style:e})=>{this._tileHandlerController&&this._tileHandlerController.abort(),this._tileHandlerController=new AbortController,this._memCache.clear();const t=new y(e),i=new d(this.layer,t,o,this._memCache,w),r=i.start({signal:this._tileHandlerController.signal,schedule:T}),l=i.spriteMosaic;r.then((()=>this._tileHandlerController=null)),this.updatingHandles.addPromise(Promise.all([r,l]).then((([,e])=>{const t=this._tileHandler,r=this.painter;this.painter=new p(e,i.glyphMosaic),this._tileHandler=i,this.emit("data-changed"),t.destroy(),r&&r.dispose()})))}));const S=Promise.all([g,b,R]);this.addResolvingPromise(S)},a.destroy=function(){this.painter=r.disposeMaybe(this.painter),this._tileHandlerController&&(this._tileHandlerController.abort(),this._tileHandlerController=null),r.destroyMaybe(this._tileHandler),this._memCache=r.destroyMaybe(this._memCache),this._tileHandler=null},a.fetchTile=function(){var t=e._asyncToGenerator((function*(e,t,i,r){return this._tileHandler.getVectorTile(e,t,i,r)}));function i(e,i,r,l){return t.apply(this,arguments)}return i}(),e._createClass(n,[{key:"dataLevelRange",get:function(){const e=this.tileInfo.lods,t=e[0].scale,i=e[e.length-1].scale,r=this.levelRangeFromScaleRange(t,i);return 1===r.minLevel&&256===this.tileInfo.size[0]&&(r.minLevel=0),r}}]),n}(f.TiledLayerView3D(u.LayerView3D(_)));t.__decorate([n.property()],g.prototype,"layer",void 0),t.__decorate([n.property()],g.prototype,"dataLevelRange",null),t.__decorate([n.property()],g.prototype,"updatingProgressValue",void 0),g=t.__decorate([h.subclass("esri.views.3d.layers.VectorTileLayerView3D")],g);return g}));
