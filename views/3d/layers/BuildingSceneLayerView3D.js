// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../Graphic","../../../core/Accessor","../../../core/Collection","../../../core/Logger","../../../core/maybe","../../../core/promiseUtils","../../../core/promiseUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators","../../../layers/buildingSublayers/BuildingGroupSublayer","./BuildingComponentSublayerView3D","./BuildingSublayerView3D","./LayerView3D","./i3s/BuildingFilterUtil","./i3s/I3SUtil","./support/layerViewUpdatingProperties","../../layers/BuildingSceneLayerView"],(function(e,r,t,i,n,o,s,a,u,l,p,c,y,f,d,h,g,b,w,v){"use strict";var m=s.getLogger("esri.views.3d.layers.BuildingSceneLayerView3D"),V=d.BuildingSublayerView3DMixin(n,y);return function(e){function r(){var r=null!==e&&e.apply(this,arguments)||this;return r.sublayerViews=new o,r._abortController=u.createAbortController(),r._loadingComponents=0,r}return t.__extends(r,e),Object.defineProperty(r.prototype,"filterExpression",{get:function(){var e=this.layer.activeFilterId,r=null!=e?this.layer.filters.find((function(r){return r.id===e})):null,t=null!=r?r.filterBlocks.find((function(e){return"solid"===e.filterMode.type})):null;return t?t.filterExpression:null},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"filterExpressions",{get:function(){var e=this.layer.activeFilterId,r=null!=e?this.layer.filters.find((function(r){return r.id===e})):null;return r&&r.filterBlocks?r.filterBlocks.toArray().map((function(e){return[e.filterExpression,g.parseFilterMode(e)]})):[]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"updatingProgressValue",{get:function(){var e=this.sublayerViews,r=this._loadingComponents+(e?e.length:0);return e.reduce((function(e,r){return e+r.updatingProgress}),0)/r},enumerable:!1,configurable:!0}),r.prototype.isUpdating=function(){return this._loadingComponents>0||this.sublayerViews&&this.sublayerViews.some((function(e){return e.updating}))},r.prototype.initialize=function(){b.checkSpatialReference(this.layer.spatialReference,this.view.spatialReference,this.view.viewingMode),this.initializeSubLayerViews(this.layer.sublayers,this)},r.prototype.destroy=function(){this.sublayerViews&&(this.sublayerViews.forEach((function(e){return e.destroy()})),this.sublayerViews=null),this._abortController.abort(),this._abortController=null},r.prototype.initializeSubLayerViews=function(e,r){var t=this,i=this,n=this.view;e.forEach((function(e){if(!e.isEmpty)if("building-group"===e.type){var o=new V({sublayer:e,view:n,parent:r});t.initializeSubLayerViews(e.sublayers,o)}else"mesh"===e.geometryType&&(t._loadingComponents++,e.load({signal:t._abortController.signal}).then((function(){var o=new f({sublayer:e,layerView:i,view:n,parent:r});t.sublayerViews.push(o),t.handles.add([p.init(o,"updating",(function(){return t.notifyChange("updating")}),!0),p.init(o,"updatingProgress",(function(){return t.notifyChange("updatingProgressValue")}),!0)])})).catch((function(r){l.isAbortError(r)||m.error("Error while creating view for sublayer "+e.id+"\nLayer: "+t.layer.url+"\n",r)})).then((function(){t._loadingComponents--,t.notifyChange("updating"),t.notifyChange("updatingProgressValue")})))}))},r.prototype.getGraphicFromIntersectorMetadata=function(e){for(var r=0,t=this.sublayerViews.items;r<t.length;r++){var i=t[r];if(i.sublayer.uid===e.sublayerUid)return i.getGraphicFromIntersectorMetadata(e)}return null},r.prototype.fetchPopupFeatures=function(e,r){return t.__awaiter(this,void 0,void 0,(function(){var i;return t.__generator(this,(function(t){return a.isSome(r)&&r.clientGraphics&&0!==r.clientGraphics.length?(i=this._findComponent(r.clientGraphics[0].sourceLayer),a.isNone(i)?[2,void 0]:[2,i.fetchPopupFeatures(e,r)]):[2,void 0]}))}))},r.prototype.whenGraphicBounds=function(e){var r=this._findComponent(e.sourceLayer);return a.isNone(r)?u.reject():r.whenGraphicBounds(e)},r.prototype._findComponent=function(e){return this.sublayerViews.find((function(r){return e===r.sublayer}))},r.prototype.highlight=function(e){e instanceof i?e=[e]:e instanceof o&&(e=e.toArray());var r=[];if(Array.isArray(e)&&e.length>0&&e[0]instanceof i){for(var t=e,n=new Map,s=0,a=t;s<a.length;s++){var u=a[s],l=n.get(u.sourceLayer);null==l&&(l=[],n.set(u.sourceLayer,l)),l.push(u)}this.sublayerViews.forEach((function(e){var t=n.get(e.sublayer);t&&r.push(e.highlight(t))}))}return{remove:function(){return r.forEach((function(e){return e.remove()}))},pause:function(){return r.forEach((function(e){return e.pause()}))},resume:function(){return r.forEach((function(e){return e.resume()}))}}},r.prototype.getUsedMemory=function(){return this.sublayerViews.reduce((function(e,r){return e+r.getUsedMemory()}),0)},r.prototype.getUnloadedMemory=function(){return this.sublayerViews.reduce((function(e,r){return e+r.getUnloadedMemory()}),0)},r.prototype.ignoresMemoryFactor=function(){return!1},t.__decorate([c.property()],r.prototype,"sublayerViews",void 0),t.__decorate([c.property({readOnly:!0,dependsOn:["layer.filters","layer.activeFilterId"]})],r.prototype,"filterExpression",null),t.__decorate([c.property({readOnly:!0,dependsOn:["layer.filters","layer.activeFilterId"]})],r.prototype,"filterExpressions",null),t.__decorate([c.property(w.updatingProgress)],r.prototype,"updatingProgress",void 0),t.__decorate([c.property({readOnly:!0})],r.prototype,"updatingProgressValue",null),r=t.__decorate([c.subclass("esri.views.3d.layers.BuildingSceneLayerView3D")],r)}(h.LayerView3D(v))}));