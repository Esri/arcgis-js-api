/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/has","../../../core/maybe","../../../core/Logger","../../../core/accessorSupport/ensureType","../../../core/handleUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass","../../../core/urlUtils","../../../core/uuid","../../../portal/support/resourceExtension","../../../core/promiseUtils","../../../core/Accessor","../../../core/Collection","../../../Graphic","../../../core/watchUtils","../../../layers/buildingSublayers/BuildingGroupSublayer","./LayerView3D","./support/layerViewUpdatingProperties","../../layers/BuildingSceneLayerView","./i3s/I3SUtil","./BuildingSublayerView3D","./i3s/BuildingFilterUtil","./BuildingComponentSublayerView3D"],(function(e,r,i,t,s,n,o,a,l,u,c,p,y,d,h,g,f,b,w,V,_,m,C,v,S){"use strict";const L=s.getLogger("esri.views.3d.layers.BuildingSceneLayerView3D"),B=C.BuildingSublayerView3DMixin(d);let E=function(r){function i(){var e;return(e=r.apply(this,arguments)||this).sublayerViews=new h,e._abortController=y.createAbortController(),e._loadingComponents=0,e}e._inheritsLoose(i,r);var s=i.prototype;return s.isUpdating=function(){return this._loadingComponents>0||this.sublayerViews&&this.sublayerViews.some((e=>e.updating))},s.initialize=function(){m.checkSpatialReference(this.layer.spatialReference,this.view.spatialReference,this.view.viewingMode),this.initializeSubLayerViews(this.layer.sublayers,this)},s.destroy=function(){this.sublayerViews&&(this.sublayerViews.forEach((e=>e.destroy())),this.sublayerViews=null),this._abortController.abort(),this._abortController=null},s.initializeSubLayerViews=function(e,r){const i=this,t=this.view;e.forEach((e=>{if(!e.isEmpty)if("building-group"===e.type){const i=new B({sublayer:e,view:t,parent:r});this.initializeSubLayerViews(e.sublayers,i)}else"mesh"===e.geometryType&&(this._loadingComponents++,e.load({signal:this._abortController.signal}).then((()=>{const s=new S({sublayer:e,layerView:i,view:t,parent:r});this.sublayerViews.push(s),this.handles.add([f.init(s,"updating",(()=>this.notifyChange("updating")),!0),f.init(s,"updatingProgress",(()=>this.notifyChange("updatingProgressValue")),!0)])})).catch((r=>{y.isAbortError(r)||L.error(`Error while creating view for sublayer ${e.id}\nLayer: ${this.layer.url}\n`,r)})).then((()=>{this._loadingComponents--,this.notifyChange("updating"),this.notifyChange("updatingProgressValue")})))}))},s.getGraphicFromIntersectorMetadata=function(e){for(const r of this.sublayerViews.items)if(r.sublayer.uid===e.sublayerUid)return r.getGraphicFromIntersectorMetadata(e);return null},s.fetchPopupFeatures=async function(e,r){if(!t.isSome(r)||!r.clientGraphics||0===r.clientGraphics.length)return;const i=this._findComponent(r.clientGraphics[0].sourceLayer);return t.isNone(i)?void 0:i.fetchPopupFeatures(e,r)},s.whenGraphicBounds=function(e){const r=this._findComponent(e.sourceLayer);return t.isNone(r)?y.reject():r.whenGraphicBounds(e)},s._findComponent=function(e){return this.sublayerViews.find((r=>e===r.sublayer))},s.highlight=function(e){e instanceof g?e=[e]:e instanceof h&&(e=e.toArray());const r=[];if(Array.isArray(e)&&e.length>0&&e[0]instanceof g){const i=e,t=new Map;for(const e of i){let r=t.get(e.sourceLayer);null==r&&(r=[],t.set(e.sourceLayer,r)),r.push(e)}this.sublayerViews.forEach((e=>{const i=t.get(e.sublayer);i&&r.push(e.highlight(i))}))}return o.handlesGroup(r)},s.getUsedMemory=function(){return this.sublayerViews.reduce(((e,r)=>e+r.getUsedMemory()),0)},s.getUnloadedMemory=function(){return this.sublayerViews.reduce(((e,r)=>e+r.getUnloadedMemory()),0)},s.ignoresMemoryFactor=function(){return!1},e._createClass(i,[{key:"filterExpression",get:function(){const e=this.layer.activeFilterId,r=null!=e?this.layer.filters.find((r=>r.id===e)):null,i=null!=r?r.filterBlocks.find((e=>"solid"===e.filterMode.type)):null;return i?i.filterExpression:null}},{key:"filterExpressions",get:function(){const e=this.layer.activeFilterId,r=null!=e?this.layer.filters.find((r=>r.id===e)):null;return r&&r.filterBlocks?r.filterBlocks.toArray().map((e=>[e.filterExpression,v.parseFilterMode(e)])):[]}},{key:"updatingProgressValue",get:function(){const e=this.sublayerViews,r=this._loadingComponents+(e?e.length:0);return e.reduce(((e,r)=>e+r.updatingProgress),0)/r}}]),i}(w.LayerView3D(_));return r.__decorate([a.property()],E.prototype,"sublayerViews",void 0),r.__decorate([a.property({readOnly:!0,dependsOn:["layer.filters","layer.activeFilterId"]})],E.prototype,"filterExpression",null),r.__decorate([a.property({readOnly:!0,dependsOn:["layer.filters","layer.activeFilterId"]})],E.prototype,"filterExpressions",null),r.__decorate([a.property(V.updatingProgress)],E.prototype,"updatingProgress",void 0),r.__decorate([a.property({readOnly:!0,dependsOn:[],autoTracked:!1})],E.prototype,"updatingProgressValue",null),E=r.__decorate([l.subclass("esri.views.3d.layers.BuildingSceneLayerView3D")],E),E}));
