/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/Error","../../../../core/maybe","../../../../core/screenUtils","../../../../chunks/vec2f64","../../../../symbols/callouts/calloutUtils","./ElevationAligners","./elevationAlignmentUtils","./ElevationContext","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolLayer","./graphicUtils","./pointUtils","../../webgl-engine/lib/GeometryUtil","../../webgl-engine/lib/TextRenderParameters","../../webgl-engine/lib/TextTexture","../../webgl-engine/materials/HUDMaterial"],(function(e,t,n,r,i,o,s,a,l,c,d,h,u,p,f,y,m,g){"use strict";const v=[0,0,1];let x=function(e){function h(t,n,r,i){var o;return(o=e.call(this,t,n,r,i)||this)._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},o.ensureDrapedStatus(!1),o}t._inheritsLoose(h,e);var x=h.prototype;return x.doLoad=function(){var e=t._asyncToGenerator((function*(){if(!this._drivenProperties.size){const e=u.validateSymbolLayerSize(this.symbolLayer.size);if(e)throw new n("graphics3dtextsymbollayer:invalid-size",e)}this._createTextRenderParameters()}));function r(){return e.apply(this,arguments)}return r}(),x._createTextRenderParameters=function(){const e=this._context.layerView.view.pixelRatio;this._textRenderParameters=y.TextRenderParameters.fromSymbol(this.symbolLayer,e)},x.destroy=function(){e.prototype.destroy.call(this)},x.createGraphics3DGraphic=function(e){const t=e.graphic,n=p.placePointOnGeometry(t.geometry);if(r.isNone(n))return this.logger.warn(`unsupported geometry type for text symbol: ${t.geometry.type}`),null;const i=this.symbolLayer.text;if(!i)return null;const o=s.isCalloutSupport(this.symbol)&&this.symbol.hasVisibleVerticalOffset()?this.symbol:null;return this._createAs3DShape(t,n,i,o)},x.createLabel=function(e,t,n,i){const o=e.graphic,s=p.placePointOnGeometry(o.geometry);if(r.isNone(s))return this.logger.warn(`unsupported geometry type for label: ${o.geometry.type}`),null;const a=t.text;return!a||/^\s+$/.test(a)?null:this._createAs3DShape(o,s,a,t,t,n,i)},x.setGraphicElevationContext=function(t,n,r=0){const i=e.prototype.setGraphicElevationContext.call(this,t,n);return i.addOffsetRenderUnits(r),i},x.layerOpacityChanged=function(){return this.logger.warn("layer opacity change not yet implemented in Graphics3DTextSymbolLayer"),!1},x.layerElevationInfoChanged=function(e,t){return b(e,t,((e,t)=>{this.updateGraphicElevationContext(t,e)})),l.SymbolUpdateType.UPDATE},x.slicePlaneEnabledChanged=function(e,t){return b(e,t,(e=>{for(const t of e.stageObject.geometryRecords)t.material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled})})),!0},x.physicalBasedRenderingChanged=function(){return!0},x.pixelRatioChanged=function(){return!1},x.updateGraphicElevationContext=function(e,t){this.setGraphicElevationContext(e,t.elevationContext,t.metadata.elevationOffset),t.needsElevationUpdates=l.needsElevationUpdates2D(t.elevationContext.mode)||"absolute-height"===t.elevationContext.mode},x._defaultElevationInfoNoZ=function(){return S},x._createAs3DShape=function(e,t,n,s,h=O,y,x){const b=this.setGraphicElevationContext(e,new c.ElevationContext,h.elevationOffset),S="polyline"===r.get(e.geometry,"type"),P=e.uid,E=this._context.stage.renderView.renderingContext,D=h.anchor in u.namedAnchorToHUDMaterialAnchorPos?h.anchor:"center",_=u.namedAnchorToHUDMaterialAnchorPos[D],G=r.isNone(x)?new m(E,n,this._textRenderParameters):null,U={occlusionTest:!0,screenOffset:h.screenOffset,anchorPos:_,polygonOffset:!0,color:[1,1,1,1],centerOffsetUnits:h.centerOffsetUnits,debugDrawBorder:h.debugDrawBorder,drawInSecondSlot:!0};if(r.isSome(G)&&(U.textureId=G.id,U.texCoordScale=G.texcoordScale),r.isSome(x)&&(U.textureId=x.id),r.isSome(s)&&r.isSome(s.verticalOffset)){const{screenLength:e,minWorldLength:t,maxWorldLength:n}=s.verticalOffset;U.verticalOffset={screenLength:i.pt2px(e),minWorldLength:t||0,maxWorldLength:null!=n?n:1/0}}if(this._context.screenSizePerspectiveEnabled){const{screenSizePerspectiveSettings:e,screenSizePerspectiveSettingsLabels:t}=this._context.sharedResources;U.screenSizePerspective=t.overridePadding(this._textRenderParameters.haloSize),U.screenSizePerspectiveAlignment=e}let w;if(S&&(U.shaderPolygonOffset=1e-4),U.slicePlaneEnabled=this._context.slicePlaneEnabled,r.isSome(y)){const e=JSON.stringify(U);w=y.get(e),r.isNone(w)&&(w=new g.HUDMaterial(U),y.add(e,w))}else w=new g.HUDMaterial(U);const C=[w],L=h.translation,T=r.isSome(G)?[G.displayWidth,G.displayHeight]:[0,0],A=h.centerOffset,R=v,z=[0,0],H=[f.createPointGeometry(R,L,null,T,A,z,null)],j=this._context.layer.uid,N=p.createStageObjectForHUD(this._context,t,H,C,null,null,b,j,P);if(null===N)return null;const W=a.perObjectElevationAligner,M=new d.Graphics3DObject3DGraphicLayer(this,N.object,H,r.isNone(y)?C:null,r.isSome(G)?[G]:null,W,b);M.alignedSampledElevation=N.sampledElevation,M.needsElevationUpdates=l.needsElevationUpdates2D(b.mode)||"absolute-height"===b.mode;const{displayWidth:B,displayHeight:I}=r.isSome(G)?G:h;M.getScreenSize=(e=o.create())=>(e[0]=B,e[1]=I,e);const V={labelText:n,elevationOffset:h.elevationOffset};return M.metadata=V,p.extendPointGraphicElevationContext(M,t,this._context.elevationProvider),M},h}(h.Graphics3DSymbolLayer);function b(e,t,n){e&&e.forEach((e=>{const i=t(e);r.isSome(i)&&n(i,e.graphic)}))}const S={mode:"relative-to-ground",offset:0},O={text:null,translation:[0,0,0],elevationOffset:0,centerOffset:[0,0,0,1],screenOffset:[0,0],anchor:"center",verticalOffset:null,centerOffsetUnits:null,debugDrawBorder:!1,displayWidth:0,displayHeight:0};e.Graphics3DTextSymbolLayer=x,e.default=x,Object.defineProperty(e,"__esModule",{value:!0})}));
