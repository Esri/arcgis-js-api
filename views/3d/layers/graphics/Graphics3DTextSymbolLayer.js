/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/Error","../../../../core/ObjectPool","../../../../core/screenUtils","../../../../symbols/callouts/calloutUtils","../../../../chunks/vec2f64","../../webgl-engine/lib/GeometryData","../../webgl-engine/lib/GeometryUtil","../../webgl-engine/materials/HUDMaterial","./graphicUtils","./elevationAlignmentUtils","./ElevationAligners","./ElevationContext","./Graphics3DObject3DGraphicLayer","../../webgl-engine/lib/Geometry","./Graphics3DSymbolLayer","./pointUtils","../../webgl-engine/lib/TextRenderParameters","../../webgl-engine/lib/TextTexture"],(function(e,t,n,o,i,r,a,s,l,c,d,u,h,f,p,y,m,g,b,x,v){"use strict";const S=[0,0,1];let P=function(e){function g(t,o,r,a){var s;return(s=e.call(this,t,o,r,a)||this)._geometryDataPool=new i(l.GeometryData,((e,t,o)=>{const i=t.translation,r=n.isSome(o)?[o.displayWidth,o.displayHeight]:[0,0],a=t.centerOffset;if(0===e.indexCount){const t=S,n=[0,0];c.createPointGeometry(t,i,null,r,a,n,null,e)}else c.updatePointGeometry(null,i,null,r,a,null,null,e)})),s._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},s.ensureDrapedStatus(!1),s}t._inheritsLoose(g,e);var P=g.prototype;return P.doLoad=async function(){if(!this._drivenProperties.size){const e=u.validateSymbolLayerSize(this.symbolLayer.size);if(e)throw new o("graphics3dtextsymbollayer:invalid-size",e)}this._createTextRenderParameters()},P._createTextRenderParameters=function(){const e=this._context.layerView.view.pixelRatio;this._textRenderParameters=x.TextRenderParameters.fromSymbol(this.symbolLayer,e)},P.destroy=function(){e.prototype.destroy.call(this),this._geometryDataPool.destroy()},P.createGraphics3DGraphic=function(e){const t=e.graphic,o=b.placePointOnGeometry(t.geometry);if(n.isNone(o))return this.logger.warn(`unsupported geometry type for text symbol: ${t.geometry.type}`),null;const i=this.symbolLayer.text;if(!i)return null;const r=a.isCalloutSupport(this.symbol)&&this.symbol.hasVisibleVerticalOffset()?this.symbol:null;return this._createAs3DShape(t,o,i,r)},P.onRemoveGraphic=function(e){this._geometryDataPool.release(e.stageObject.geometries[0].data)},P.createLabel=function(e,t,o,i){const r=e.graphic,a=b.placePointOnGeometry(r.geometry);if(n.isNone(a))return this.logger.warn(`unsupported geometry type for label: ${r.geometry.type}`),null;const s=t.text;return!s||/^\s+$/.test(s)?null:this._createAs3DShape(r,a,s,t,t,o,i)},P.setGraphicElevationContext=function(t,n,o=0){const i=e.prototype.setGraphicElevationContext.call(this,t,n);return i.addOffsetRenderUnits(o),i},P.layerOpacityChanged=function(){return this.logger.warn("layer opacity change not yet implemented in Graphics3DTextSymbolLayer"),!1},P.layerElevationInfoChanged=function(e,t){return O(e,t,((e,t)=>{this.updateGraphicElevationContext(t,e)})),h.SymbolUpdateType.UPDATE},P.slicePlaneEnabledChanged=function(e,t){return O(e,t,(e=>{for(const t of e.stageObject.geometryRecords)t.material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled})})),!0},P.physicalBasedRenderingChanged=function(){return!0},P.pixelRatioChanged=function(){return!1},P.updateGraphicElevationContext=function(e,t){this.setGraphicElevationContext(e,t.elevationContext,t.metadata.elevationOffset),t.needsElevationUpdates=h.needsElevationUpdates2D(t.elevationContext.mode)||"absolute-height"===t.elevationContext.mode},P._defaultElevationInfoNoZ=function(){return _},P._createAs3DShape=function(e,t,o,i,a=D,l,c){const g=this.setGraphicElevationContext(e,new p.ElevationContext,a.elevationOffset),x=this._context.layer.id+"_label_"+e.uid,S="polyline"===n.get(e.geometry,"type"),P=e.uid,O=this._context.stage.renderView.renderingContext,_=a.anchor in u.namedAnchorToHUDMaterialAnchorPos?a.anchor:"center",E=u.namedAnchorToHUDMaterialAnchorPos[_],w=n.isNone(c)?new v(O,o,this._textRenderParameters,x):null,G={occlusionTest:!0,screenOffset:a.screenOffset,anchorPos:E,polygonOffset:!0,color:[1,1,1,1],centerOffsetUnits:a.centerOffsetUnits,debugDrawBorder:a.debugDrawBorder,drawInSecondSlot:!0};if(n.isSome(w)&&(G.textureId=w.id,G.texCoordScale=w.texcoordScale),n.isSome(c)&&(G.textureId=c.textureId),n.isSome(i)&&n.isSome(i.verticalOffset)){const{screenLength:e,minWorldLength:t,maxWorldLength:n}=i.verticalOffset;G.verticalOffset={screenLength:r.pt2px(e),minWorldLength:t||0,maxWorldLength:null!=n?n:1/0}}if(this._context.screenSizePerspectiveEnabled){const{screenSizePerspectiveSettings:e,screenSizePerspectiveSettingsLabels:t}=this._context.sharedResources;G.screenSizePerspective=t.overridePadding(this._textRenderParameters.haloSize),G.screenSizePerspectiveAlignment=e}S&&(G.shaderPolygonOffset=1e-4),G.slicePlaneEnabled=this._context.slicePlaneEnabled;let U=null;if(n.isSome(l)){const e=JSON.stringify(G);U=l.getMaterial(e),null==U&&(U=new d.HUDMaterial(G,x),l.addMaterial(e,U))}else U=new d.HUDMaterial(G,x);const C=[U],L=this._geometryDataPool.acquire(a,w),T=[new m(L,x)],R=this._context.layer.uid,A=b.createStageObjectForHUD(this._context,t,T,C,null,null,g,x,R,P);if(null===A)return null;const z=f.perObjectElevationAligner,H=new y(this,A.object,T,n.isNone(l)?C:null,n.isSome(w)?[w]:null,z,g);H.alignedSampledElevation=A.sampledElevation,H.needsElevationUpdates=h.needsElevationUpdates2D(g.mode)||"absolute-height"===g.mode;const{displayWidth:j,displayHeight:M}=n.isSome(w)?w:a;H.getScreenSize=(e=s.create())=>(e[0]=j,e[1]=M,e);const W={labelText:o,elevationOffset:a.elevationOffset};return H.metadata=W,b.extendPointGraphicElevationContext(H,t,this._context.elevationProvider),H},g}(g.Graphics3DSymbolLayer);function O(e,t,o){e&&e.forEach((e=>{const i=t(e);n.isSome(i)&&o(i,e.graphic)}))}const _={mode:"relative-to-ground",offset:0},D={text:null,translation:[0,0,0],elevationOffset:0,centerOffset:[0,0,0,1],screenOffset:[0,0],anchor:"center",verticalOffset:null,centerOffsetUnits:null,debugDrawBorder:!1,displayWidth:0,displayHeight:0};e.Graphics3DTextSymbolLayer=P,e.default=P,Object.defineProperty(e,"__esModule",{value:!0})}));
