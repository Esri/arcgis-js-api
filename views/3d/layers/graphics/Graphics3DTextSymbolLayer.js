/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/Error","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/screenUtils","../../../../chunks/vec2f64","../../../../symbols/callouts/calloutUtils","./CreateLabelParameters","./ElevationAligners","./elevationAlignmentUtils","./ElevationContext","./Graphics3DObject3DGraphicLayer","./Graphics3DObjectMetadata","./Graphics3DSymbolLayer","./graphicUtils","./placementUtils","./pointUtils","../../webgl-engine/lib/GeometryUtil","../../webgl-engine/lib/TextRenderParameters","../../webgl-engine/lib/TextTextureFactory","../../webgl-engine/materials/HUDMaterial"],(function(e,t,n,r,i,o,a,s,l,c,h,u,m,d,p,f,y,g,b,v,x,S){"use strict";const P=[0,0,1];let O=function(e){function p(t,n,r,i){var o;return(o=e.call(this,t,n,r,i)||this)._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},o.ensureDrapedStatus(!1),o}t._inheritsLoose(p,e);var O=p.prototype;return O.doLoad=function(){var e=t._asyncToGenerator((function*(){if(!this._drivenProperties.size){const e=f.validateSymbolLayerSize(this.symbolLayer.size);if(e)throw new n("graphics3dtextsymbollayer:invalid-size",e)}yield this._createTextRenderParameters()}));function r(){return e.apply(this,arguments)}return r}(),O._createTextRenderParameters=function(){var e=t._asyncToGenerator((function*(){const e=this._context.graphicsCoreOwner.view.state.rasterPixelRatio;this._textRenderParameters=yield v.TextRenderParameters.fromSymbol(this.symbolLayer,e)}));function n(){return e.apply(this,arguments)}return n}(),O.destroy=function(){e.prototype.destroy.call(this)},O.createGraphics3DGraphic=function(e){const t=e.graphic,n=g.placePointOnGeometry(t.geometry);if(r.isNone(n))return this.logger.warn(`unsupported geometry type for text symbol: ${t.geometry.type}`),null;const i=this.symbolLayer.text;if(r.isNone(i)||""===i)return null;const o=s.hasCalloutSupport(this.symbol)&&this.symbol.hasVisibleVerticalOffset()?this.symbol.verticalOffset:null;if(r.isSome(o)&&!s.textSymbolLayerSupportsVerticalOffset(this.symbolLayer))return this.logger.errorOncePerTick(`Callouts and vertical offset on text symbols are currently only supported with 'center' horizontal alignment (not with '${this.symbolLayer.horizontalAlignment}' alignment)`),null;const a=new l.CreateLabelParameters(o,this.symbolLayer.horizontalAlignment,y.verticalPlacementFromAlignment(this.symbolLayer.verticalAlignment));return this._createAs3DShape(t,n,i,a)},O.createLabel=function(e,t,n,i){const o=e.graphic,a=g.placePointOnGeometry(o.geometry);if(r.isNone(a))return this.logger.warn(`unsupported geometry type for label: ${o.geometry.type}`),null;const s=t.text;return!s||/^\s+$/.test(s)?null:this._createAs3DShape(o,a,s,t,n,i)},O.setGraphicElevationContext=function(t,n,r=0){const i=e.prototype.setGraphicElevationContext.call(this,t,n);return i.addOffsetRenderUnits(r),i},O.layerOpacityChanged=function(){return this.logger.warn("layer opacity change not yet implemented in Graphics3DTextSymbolLayer"),!1},O.layerElevationInfoChanged=function(e,t){return L(e,t,((e,t)=>{this.updateGraphicElevationContext(t,e)})),h.SymbolUpdateType.UPDATE},O.slicePlaneEnabledChanged=function(e,t){return L(e,t,(e=>{for(const t of e.stageObject.geometries)t.material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})})),!0},O.physicalBasedRenderingChanged=function(){return!0},O.pixelRatioChanged=function(){return!1},O.skipHighSymbolLodsChanged=function(){return!0},O.updateGraphicElevationContext=function(e,t){const n=t.elevationContext;this.setGraphicElevationContext(e,n,r.isSome(t.metadata)?t.metadata.elevationOffset:0),t.needsElevationUpdates=h.needsElevationUpdates2D(n.mode)||"absolute-height"===n.mode},O._defaultElevationInfoNoZ=function(){return G},O._createAs3DShape=function(e,t,n,s,l,p){const f=this.setGraphicElevationContext(e,new u.ElevationContext,s.elevationOffset),v="polyline"===r.get(e.geometry,"type"),O=e.uid;let L=null,G=null;if(r.isNone(p)){const e=y.textRenderAlignmentFromHorizontalPlacement(s.horizontalPlacement);L=new x(n,e,this._textRenderParameters);let t=null;if(r.isSome(this._context.sharedResources.textures)){G=this._context.sharedResources.textures.fromData(L.key,(()=>r.unwrap(L).create()),(()=>{r.isSome(t)&&t.release()}));const e=this._context.stage.renderView.textureRepository.acquire(G.texture.id);if(r.isNone(e)||i.isPromiseLike(e))return G.release(),null;t=e}}const _=E(L,s),w={occlusionTest:!0,screenOffset:s.screenOffset,anchorPosition:_,polygonOffset:!0,color:[1,1,1,1],centerOffsetUnits:s.centerOffsetUnits,drawInSecondSlot:!0};if(r.isSome(p)?w.textureId=p.id:r.isSome(G)&&(w.textureId=G.texture.id),r.isSome(s.verticalOffset)){const{screenLength:e,minWorldLength:t,maxWorldLength:n}=s.verticalOffset;w.verticalOffset={screenLength:o.pt2px(e),minWorldLength:t||0,maxWorldLength:r.isSome(n)?n:1/0}}if(this._context.screenSizePerspectiveEnabled){const{screenSizePerspectiveSettings:e,screenSizePerspectiveSettingsLabels:t}=this._context.sharedResources;w.screenSizePerspective=t.overridePadding(this._textRenderParameters.haloSize+this._textRenderParameters.definition.background.padding[0]),w.screenSizePerspectiveAlignment=e}let D;if(v&&(w.shaderPolygonOffset=1e-4),w.hasSlicePlane=this._context.slicePlaneEnabled,r.isSome(l)){const e=JSON.stringify(w);D=l.get(e),r.isNone(D)&&(D=new S.HUDMaterial(w),l.add(e,D))}else D=new S.HUDMaterial(w);const C=s.translation,U=r.isSome(L)?a.fromValues(L.displayWidth,L.displayHeight):a.ZEROS,z=s.centerOffset,A=P,R=[0,0],T=b.createPointGeometry(D,A,C,null,U,z,R,null),j=g.createStageObject(this._context,t,T,f,O);if(r.isNone(j))return null;const N=new m.Graphics3DObject3DGraphicLayer(this,j.object,[T],r.isNone(l)?[D]:null,G,c.perObjectElevationAligner,f);N.alignedSampledElevation=j.sampledElevation,N.needsElevationUpdates=h.needsElevationUpdates2D(f.mode)||"absolute-height"===f.mode;const{displayWidth:H,displayHeight:k}=r.isSome(L)?L:s;N.getScreenSize=(e=a.create())=>(e[0]=H,e[1]=k,e);const M=new d.Graphics3DObjectMetadata(s.elevationOffset,n);return N.metadata=M,g.extendPointGraphicElevationContext(N,t,this._context.elevationProvider),N},p}(p.Graphics3DSymbolLayer);function L(e,t,n){e&&e.forEach((e=>{const i=t(e);r.isSome(i)&&n(i,e.graphic)}))}function E(e,t){if("baseline"===t.verticalPlacement){const n=y.horizontalPlacementToAnchorX[t.horizontalPlacement],i=r.isSome(e)?e.baselineAnchorY:0;return a.fromValues(n,i)}const n=y.anchorFromPlacements(t.horizontalPlacement,t.verticalPlacement);return y.namedAnchorToHUDMaterialAnchorPos[n]}const G={mode:"relative-to-ground",offset:0};e.Graphics3DTextSymbolLayer=O,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
