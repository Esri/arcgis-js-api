// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../core/Accessor","../../../../core/MapUtils","../../../../core/mathUtils","../../../../core/maybe","../../../../core/PooledArray","../../../../core/accessorSupport/decorators","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec2f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../core/libs/gl-matrix-2/vec4","../../../../core/libs/gl-matrix-2/vec4f64","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/geodesicConstants","./deconflictorDebug","../../support/debugFlags","../../support/geometryUtils","../../support/geometryUtils/sphere","../../webgl-engine/lib/Camera","../../webgl-engine/lib/screenSizePerspectiveUtils","../../webgl-engine/lib/Util","../../webgl-engine/materials/HUDMaterial"],(function(t,i,e,r,s,a,o,n,c,l,h,p,u,f,d,v,g,y,b,m,G,S,w,B,D,_,V){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.Deconflictor=i.DeconflictorViewState=i.DeconflictorGraphic=void 0;var P=f.vec3f64.create(),N=v.vec4f64.create(),x=v.vec4f64.create(),C=f.vec3f64.create(),M=h.mat4f64.create(),O=S.sphere.create(),A=S.ray.create(),I=f.vec3f64.create(),z=y.create(),E=function(){this.aabr=y.create(),this.distance=0,this.culled=!1,this.visible=!1},F=function(t,i,e){void 0===e&&(e={}),this.graphics3DGraphic=t,this.slicePlaneEnabled=i,this.info=e};i.DeconflictorGraphic=F;var R=function(){function t(){this.active=new Map,this.visible=new Map}return t.prototype.clear=function(){this.active.clear(),this.visible.clear()},t}(),T=function(){},j=function(){this.sortArray=new n({allocator:function(t){return t||new T}})},X=function(){function t(){this.camera=new B.default,this.slicePlane=S.boundedPlane.create(),this.slicePlaneEnabled=!1}return t.prototype.copyFrom=function(t){this.camera.copyFrom(t.camera),S.boundedPlane.copy(t.slicePlane,this.slicePlane),this.slicePlaneEnabled=t.slicePlaneEnabled},t}();i.DeconflictorViewState=X;var Y=function(t){function i(){var i=null!==t&&t.apply(this,arguments)||this;return i._dirty=!1,i._runningViewState=new X,i._state=0,i.graphics=new R,i.iterators=new j,i.accBinsNumX=15,i.accBinsNumY=20,i.accBinsSizeX=0,i.accBinsSizeY=0,i.accBins=null,i.accNumTests=0,i}return e.__extends(i,t),Object.defineProperty(i.prototype,"dirty",{get:function(){return this._dirty},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"state",{get:function(){return this._state},enumerable:!1,configurable:!0}),i.prototype.destroy=function(){this.graphics.clear(),this.iterators=null},i.prototype.setDirty=function(){!this._dirty&&this.graphics.active.size>0&&(this._dirty=!0,this.notifyChange("updating"))},Object.defineProperty(i.prototype,"updating",{get:function(){return 0!==this._state||this._dirty},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"updatingProgress",{get:function(){if(!this.updating)return 1;var t=this._state/4;return this._dirty?.5*t:t},enumerable:!1,configurable:!0}),i.prototype.needsUpdate=function(){return this.view.ready&&null!=this.view.state&&this.updating},i.prototype.update=function(t){switch(this._state){case 0:this.startUpdate(),t.madeProgress();case 1:if(this._state=1,!this.processActiveGraphics(t))return;case 2:if(this._state=2,!this.sortVisibleGraphics(t))return;case 3:if(this._state=3,!this.deconflictVisibleGraphics(t))return;default:m.drawAccelerationStruct(this,this.graphics.visible),this._state=0,this.notifyChange("updating")}},i.prototype.modifyGraphics=function(t,i){var e=this;i?t.forEach((function(t){return e.addToActiveGraphics(t)})):t.forEach((function(t){return e.removeFromActiveGraphics(t)})),this.setDirty()},i.prototype.layerSupportsDeconfliction=function(t){if(o.isNone(t)||"object3d"!==t.type)return!1;var i=t.stageObject;return 1===(i?i.getNumGeometryRecords():0)&&i.getGeometryRecord(0).material instanceof V.default},i.prototype.startUpdate=function(){m.prepare(this.view),this._dirty=!1,this._runningViewState.copyFrom(this.viewState);var t=this._runningViewState.camera,i=t.fullWidth,e=t.fullHeight;this.initBins(i,e),this.resetIterators()},i.prototype.addToActiveGraphics=function(t){t.info[this.visibilityGroup]=new E,this.graphics.active.set(t.graphics3DGraphic.graphic.uid,t),this.setDirty()},i.prototype.removeFromActiveGraphics=function(t){this.removeFromVisibleGraphics(t),function(t,i){var e=t.graphics3DGraphic;e.destroyed||e.clearVisibilityFlag(3,i)}(t,this.visibilityGroup),delete t.info[this.visibilityGroup],this.graphics.active.delete(t.graphics3DGraphic.graphic.uid),this.setDirty()},i.prototype.addToVisibleGraphics=function(t){this.graphics.visible.set(t.graphics3DGraphic.graphic.uid,t)},i.prototype.removeFromVisibleGraphics=function(t){this.graphics.visible.delete(t.graphics3DGraphic.graphic.uid)},i.prototype.processActiveGraphics=function(t){var i=this.ensureActiveGraphicsIterator(),e=l.mat4.invert(M,this._runningViewState.camera.projectionMatrix),r="global"===this.view.viewingMode&&1===this.view.map.ground.opacity&&this._runningViewState.camera.relativeElevation>0?O:null,s=0;for(o.isSome(r)&&(u.vec3.transformMat4(r.center,g.ZEROS,this._runningViewState.camera.viewMatrix),r.radius=b.earthRadius,s=S.sphere.distanceToSilhouette(r,g.ZEROS));!t.done;){t.madeProgress();var a=i.next();if(a.done)return this.resetActiveGraphicsIterator(),!0;var n=a.value,c=n&&n.info[this.visibilityGroup];c&&(this.collectGraphics3DGraphics(n,e,r,s),c.culled?this.removeFromVisibleGraphics(n):this.addToVisibleGraphics(n))}return!1},i.prototype.sortVisibleGraphics=function(t){for(var i=this.ensureSortGraphicsIterator();!t.done;){var e=i.next();if(t.madeProgress(),e.done)return this.resetSortGraphicsIterator(),!0}return!1},i.prototype.deconflictVisibleGraphics=function(t){for(var i=this.ensureVisibleGraphicsIterator(),e=1===this.visibilityGroup;!t.done;){t.madeProgress();var r=i.next();if(r.done)return this.resetVisibleGraphicsIterator(),!0;var s=r.value,a=s.info[this.visibilityGroup];if(a&&!a.culled){var o=s.graphics3DGraphic,n=(!e||o.isVisible())&&!this.isConflicted(s);n&&this.addToBins(s),a.visible=n,this.setGraphicVisibility(s,n),m.drawPoly(a,n)}}return!1},i.prototype.resetIterators=function(){this.iterators.active=null,this.iterators.visible=null,this.iterators.sort=null},i.prototype.ensureActiveGraphicsIterator=function(){return this.iterators.active||(this.iterators.active=U(this.graphics.active)),this.iterators.active},i.prototype.resetActiveGraphicsIterator=function(){this.iterators.active=null},i.prototype.ensureVisibleGraphicsIterator=function(){return this.iterators.visible||(this.iterators.visible=U(this.graphics.visible)),this.iterators.visible},i.prototype.resetVisibleGraphicsIterator=function(){this.iterators.visible=null},i.prototype.ensureSortGraphicsIterator=function(){return this.iterators.sort||(this.iterators.sort=function(t,i,r){var s,a;return e.__generator(this,(function(e){switch(e.label){case 0:return i.clear(),t.forEach((function(t,e){var s=i.pushNew();s.id=e,s.prio=t.info?-t.info[r].distance:Number.MAX_VALUE})),[4];case 1:e.sent(),s=i.iterableSort((function(t,i){return i.prio-t.prio})),a=s.next(),e.label=2;case 2:return a.done?[3,5]:[4];case 3:e.sent(),e.label=4;case 4:return a=s.next(),[3,2];case 5:return i.forEachSimple((function(i){var e=t.get(i.id);e&&(t.delete(i.id),t.set(i.id,e))})),i.clear(),[2]}}))}(this.graphics.visible,this.iterators.sortArray,this.visibilityGroup)),this.iterators.sort},i.prototype.resetSortGraphicsIterator=function(){this.iterators.sort=null},i.prototype.collectGraphics3DGraphics=function(t,i,e,r){var s=t.graphics3DGraphic;if(!s.destroyed){var a=t.info[this.visibilityGroup];if(s.isVisible(0,3)){var n=this.getGraphicsLayers(s);y.empty(a.aabr);for(var c=null,l=0,h=n;l<h.length;l++){var p=h[l];if(this.layerSupportsDeconfliction(p)){var u=p.stageObject.getGeometryRecord(0).material;if(o.isNone(c)){if((c=this.getProjectionInfo(p,i,L)).isOutsideScreen||this.isCulledBySlice(t,P)||o.isSome(e)&&this.isCulledByHorizon(c,e,r))return void(a.culled=!0);!G.DISABLE_DECONFLICTOR_VISIBILITY_OFFSET&&a.visible&&(c.distance*=.7)}this.expandBoundingRect(a,p,u,c)}}o.isNone(c)?a.culled=!0:(a.distance=c.distance,a.culled=!1)}else a.culled=!0}},i.prototype.getProjectionInfo=function(t,i,e){var r=this._runningViewState.camera,s=t.stageObject,a=s.getGeometryRecord(0),o=a.material,n=s.getCenter();u.vec3.transformMat4(P,n,r.viewMatrix);var c=a.geometry.data.getVertexAttr(),l=c[_.VertexAttrConstants.NORMAL].data,h=c[_.VertexAttrConstants.AUXPOS1].data;return o.applyShaderOffsetsView(P,l,s.objectTransformation,h,r,e.scaleInfo,P),d.vec4.set(N,P[0],P[1],P[2],1),d.vec4.transformMat4(x,N,r.projectionMatrix),u.vec3.scale(e.positionNDC,x,1/x[3]),o.applyShaderOffsetsNDC(e.positionNDC,h,r,e.positionNDC,C),e.distanceWithoutPolygonOffset=r.depthNDCToWorld(C[2]),e.distance=C[2]===e.positionNDC[2]?e.distanceWithoutPolygonOffset:r.depthNDCToWorld(e.positionNDC[2]),d.vec4.set(x,e.positionNDC[0],e.positionNDC[1],e.positionNDC[2],1),d.vec4.transformMat4(N,x,i),d.vec4.scale(N,N,1/N[3]),u.vec3.set(e.positionView,P[0],P[1],P[2]),e},i.prototype.isCulledByHorizon=function(t,i,e){return u.vec3.copy(A.direction,t.positionView),u.vec3.set(A.origin,0,0,0),!!w.intersectRay(i,A,I)&&t.distanceWithoutPolygonOffset>e},i.prototype.isCulledBySlice=function(t,i){return t.slicePlaneEnabled&&this._runningViewState.slicePlaneEnabled&&S.boundedPlane.extrusionContainsPoint(this._runningViewState.slicePlane,i)},i.prototype.expandBoundingRect=function(t,i,e,r){var s=r.positionNDC,o=r.scaleInfo,n=this._runningViewState.camera,c=i.getScreenSize(W);D.applyPrecomputedScaleFactor(c,o.factor,c),c[0]*=n.pixelRatio,c[1]*=n.pixelRatio;var l=y.offset(e.calculateRelativeScreenBounds(c,o.factorAlignment.scale,z),a.lerp(0,n.fullWidth,.5+.5*s[0]),a.lerp(0,n.fullHeight,.5+.5*s[1])),h=this.iconMarginFactor;if(0!==h){var p=h*Math.min(y.width(l),y.height(l));l[0]-=p,l[1]-=p,l[2]+=p,l[3]+=p}y.expand(t.aabr,l)},i.prototype.isConflicted=function(t){for(var i=t.graphics3DGraphic.graphic.uid,e=t.info[this.visibilityGroup],r=Math.floor(e.aabr[0]/this.accBinsSizeX);r<=Math.floor(e.aabr[2]/this.accBinsSizeX);r++)if(!(r<0||r>=this.accBinsNumX))for(var s=Math.floor(e.aabr[1]/this.accBinsSizeY);s<=Math.floor(e.aabr[3]/this.accBinsSizeY);s++)if(!(s<0||s>=this.accBinsNumY))for(var a=this.accBins[r][s],o=0;o<a.length;o++){var n=a.data[o],c=n.info[this.visibilityGroup];if(c&&c.visible&&(n.graphics3DGraphic.graphic.uid!==i&&(this.accNumTests++,y.intersects(c.aabr,e.aabr))))return!0}return!1},i.prototype.initBins=function(t,i){if(null==this.accBins){this.accBins=[];for(var e=0;e<this.accBinsNumX;e++){this.accBins.push([]);for(var r=this.accBins[this.accBins.length-1],s=0;s<this.accBinsNumY;s++)r.push(new n)}}else for(e=0;e<this.accBinsNumX;e++)for(s=0;s<this.accBinsNumY;s++)this.accBins[e][s].clear();this.accBinsSizeX=t/this.accBinsNumX,this.accBinsSizeY=i/this.accBinsNumY,this.accNumTests=0},i.prototype.addToBins=function(t){for(var i=t.info[this.visibilityGroup],e=Math.floor(i.aabr[0]/this.accBinsSizeX),r=Math.floor(i.aabr[2]/this.accBinsSizeX),s=Math.floor(i.aabr[1]/this.accBinsSizeY),a=Math.floor(i.aabr[3]/this.accBinsSizeY),o=e;o<=r;o++)if(!(o<0||o>=this.accBinsNumX))for(var n=s;n<=a;n++)n<0||n>=this.accBinsNumY||this.accBins[o][n].push(t)},i.prototype.setGraphicVisibility=function(t,i){var e=t.graphics3DGraphic;e.destroyed||(e.setVisibilityFlag(3,i,this.visibilityGroup),1===this.visibilityGroup&&this.view.labeler.setLabelGraphicVisibility(e,i))},e.__decorate([c.property({constructOnly:!0})],i.prototype,"view",void 0),e.__decorate([c.property({type:Boolean,readOnly:!0})],i.prototype,"updating",null),i=e.__decorate([c.subclass("esri.views.3d.layers.graphics.Deconflictor")],i)}(r);function U(t){var i,r,a,o,n;return e.__generator(this,(function(e){switch(e.label){case 0:if(!Map.prototype.entries)return[3,5];i=t.entries(),n=i.next(),e.label=1;case 1:return n.done?[3,4]:[4,n.value[1]];case 2:e.sent(),e.label=3;case 3:return n=i.next(),[3,1];case 4:return[3,9];case 5:r=s.valuesOfMap(t),a=0,o=r,e.label=6;case 6:return a<o.length?[4,n=o[a]]:[3,9];case 7:e.sent(),e.label=8;case 8:return a++,[3,6];case 9:return[2]}}))}i.Deconflictor=Y;var W=p.vec2f64.create(),L=new(function(){function t(){this.positionView=f.vec3f64.create(),this.positionNDC=f.vec3f64.create(),this.distance=0,this.distanceWithoutPolygonOffset=0,this.scaleInfo={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},factorAlignment:{scale:0,factor:0,minPixelSize:0,paddingPixels:0}}}return Object.defineProperty(t.prototype,"isOutsideScreen",{get:function(){var t=this.positionNDC;return t[0]<-1||t[1]<-1||t[2]<-1||t[0]>=1||t[1]>=1},enumerable:!1,configurable:!0}),t}())}));