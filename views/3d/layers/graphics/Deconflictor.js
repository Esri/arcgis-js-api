// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/declareExtendsHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/decorateHelper","../../../../core/Accessor","../../../../core/Handles","../../../../core/mathUtils","../../../../core/maybe","../../../../core/PooledArray","../../../../core/watchUtils","../../../../core/accessorSupport/decorators","../../../../core/libs/gl-matrix-2/vec2f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../core/libs/gl-matrix-2/vec4f64","../../../../geometry/support/aaBoundingRect","./deconflictorDebug","../../support/debugFlags","../../support/earthUtils","../../support/geometryUtils","../../support/geometryUtils/sphere","../../webgl-engine/lib/screenSizePerspectiveUtils","../../webgl-engine/lib/Util","../../webgl-engine/materials/HUDMaterial","../../webgl-engine/materials/internal/MaterialUtil","../../../support/index"],function(e,t,i,r,a,s,n,o,c,h,l,p,u,f,d,v,g,y,b,m,G,x,D,w,M,C,S){function V(e){var t,i,a,s,n,o,i;return r(this,function(r){switch(r.label){case 0:if(!Map.prototype.entries)return[3,5];t=e.entries(),i=t.next(),r.label=1;case 1:return i.done?[3,4]:[4,i.value[1]];case 2:r.sent(),r.label=3;case 3:return i=t.next(),[3,1];case 4:return[3,9];case 5:a=new Array(e.size),s=0,e.forEach(function(e){return a[s++]=e}),n=0,o=a,r.label=6;case 6:return n<o.length?(i=o[n],[4,i]):[3,9];case 7:r.sent(),r.label=8;case 8:return n++,[3,6];case 9:return[2]}})}Object.defineProperty(t,"__esModule",{value:!0});var P=v.vec4f64.create(),B=v.vec4f64.create(),E=v.vec4f64.create(),I=v.vec4f64.create(),F=G.sphere.create(),A=G.ray.create(),R=d.vec3f64.create(),T=g.create(),O=g.create(),N=function(){function e(){this.xMin=0,this.xMax=0,this.yMin=0,this.yMax=0,this.posView=0,this.culled=!1,this.visible=!1,this.pooled=!1}return e}(),U=function(){function e(e,t,i){void 0===i&&(i={}),this.graphics3DGraphic=e,this.slicePlaneEnabled=t,this.info=i}return e}(),z=function(){function e(e,t){void 0===t&&(t=new Map),this.graphics3DCore=e,this.graphics=t}return e}(),L=function(e){function t(){var t,i,r=null!==e&&e.apply(this,arguments)||this;return r.handles=new n,r.dirty=!1,r.state=0,r.contexts=[],r.graphics=(t={},t[0]={active:new Map,visible:new h,remove:new h},t[1]={active:new Map,visible:new h,remove:new h},t),r.iterators=(i={},i[0]={active:null,visible:null,remove:null,sort:null},i[1]={active:null,visible:null,remove:null,sort:null},i),r.accBinsNumX=15,r.accBinsNumY=20,r.accBinsSizeX=0,r.accBinsSizeY=0,r.accBins=null,r.accNumTests=0,r._iconMarginFactor=-.1,r.slicePlaneViewSpace=null,r}return i(t,e),Object.defineProperty(t.prototype,"iconMarginFactor",{get:function(){return this._iconMarginFactor},set:function(e){this._iconMarginFactor=e,this.setDirty()},enumerable:!0,configurable:!0}),t.prototype.initialize=function(){var e=this;this.handles.add([this.view.watch("state.camera",function(){e.updateSlicePlane(),e.setDirtyUrgent()}),this.view.watch("map.ground.opacity",function(t,i){1!==t&&1!==i||e.setDirtyUrgent()}),l.init(this.view,"slicePlane",function(){return e.updateSlicePlane()})]),this.frameWorker=this.view.resourceController.scheduler.registerTask(S.Task.DECONFLICTOR_DELAYED,function(t){return e.run(t)},function(){return e.needsUpdate()})},t.prototype.updateSlicePlane=function(){var e=this.view&&this.view.slicePlane;if(!e)return void(this.slicePlaneViewSpace&&(this.slicePlaneViewSpace=null,this.slicePlaneChanged()));this.slicePlaneViewSpace||(this.slicePlaneViewSpace=G.boundedPlane.create());var t=this.view.state.camera,i=t.viewMatrix;G.boundedPlane.transform(e,i,this.slicePlaneViewSpace),this.slicePlaneChanged()},t.prototype.slicePlaneChanged=function(){for(var e=0,t=this.contexts;e<t.length;e++){if(t[e].graphics3DCore.symbolCreationContext.slicePlaneEnabled){this.setDirty();break}}},t.prototype.destroy=function(){this.handles.destroy(),this.handles=null,this.frameWorker&&(this.frameWorker.remove(),this.frameWorker=null),this.graphics=null,this.iterators=null},t.prototype.addGraphicsOwner=function(e){var t,i=this,r=this.findDeconflictionContext(e);return-1!==r?t=this.contexts[r]:(t=new z(e),this.contexts.push(t),this.setDirtyUrgent()),{addGraphic:function(e){return i.addGraphic(t,e)},removeGraphic:function(e){return i.removeGraphic(t,e)},labelingInfoChange:function(){return i.globalLabelingInfoChanged(t)},visibilityInfoChange:function(){},featureReductionChange:function(){return i.globalFeatureReductionChanged(t)},slicePlaneEnabledChange:function(){return i.globalSlicePlaneEnabledChanged(t)},clear:function(){return t.graphics.forEach(function(e){return i.removeGraphic(t,e.graphics3DGraphic)})}}},t.prototype.removeGraphicsOwner=function(e){var t=this,i=this.findDeconflictionContext(e);if(-1!==i){var r=this.contexts.splice(i,1)[0];r.graphics.forEach(function(e){return t.removeGraphic(r,e.graphics3DGraphic)}),this.setDirtyUrgent()}},t.prototype.setInitialIconVisibilityFlag=function(e,t){var i=!(this.graphicSupportsDeconfliction(t)&&this.isFeatureReductionEnabled(e));t.setVisibilityFlag(3,i,0)},t.prototype.setDirtyUrgent=function(){!this.dirty&&this.contexts.length>0&&(this.dirty=!0,this.notifyChange("updating")),this.frameWorker.task=S.Task.DECONFLICTOR_IMMEDIATE},t.prototype.setDirty=function(){!this.dirty&&this.contexts.length>0&&(this.dirty=!0,this.notifyChange("updating"),this.frameWorker.task=S.Task.DECONFLICTOR_DELAYED)},Object.defineProperty(t.prototype,"updating",{get:function(){return 0!==this.state||this.dirty},enumerable:!0,configurable:!0}),t.prototype.needsUpdate=function(){return this.view.ready&&null!=this.view.state&&this.updating},t.prototype.run=function(e){switch(this.state){case 0:y.prepare(this.view),this.dirty=!1,this.camera=this.view.state.camera;var t=this.camera.fullWidth,i=this.camera.fullHeight;this.initBins(t,i),this.resetIterators(),e.madeProgress();case 1:if(this.state=1,!this.processActiveGraphics(0,e))return;case 3:if(this.state=3,!this.cleanVisibleGraphics(0,e))return;case 5:if(this.state=5,!this.sortVisibleGraphics(0,e))return;case 7:if(this.state=7,!this.deconflictVisibleGraphics(0,e))return;y.drawAccelerationStruct(this,this.graphics[0].visible);case 2:if(this.state=2,!this.processActiveGraphics(1,e))return;case 4:if(this.state=4,!this.cleanVisibleGraphics(1,e))return;case 6:if(this.state=6,!this.sortVisibleGraphics(1,e))return;case 8:if(this.state=8,!this.deconflictVisibleGraphics(1,e))return;y.drawAccelerationStruct(this,this.graphics[1].visible);default:this.state=0,this.notifyChange("updating")}},t.prototype.findDeconflictionContext=function(e){for(var t=0;t<this.contexts.length;t++)if(this.contexts[t].graphics3DCore===e)return t;return-1},t.prototype.globalFeatureReductionChanged=function(e){var t=this.isFeatureReductionEnabled(e.graphics3DCore);t||this.clearVisibilityFlags(e),this.modifyGraphics(e,t,0)},t.prototype.globalLabelingInfoChanged=function(e){var t=e.graphics3DCore.labelsEnabled;this.modifyGraphics(e,t,1)},t.prototype.globalSlicePlaneEnabledChanged=function(e){var t=e.graphics3DCore.symbolCreationContext.slicePlaneEnabled;e.graphics.forEach(function(e){e.slicePlaneEnabled=t}),this.setDirtyUrgent()},t.prototype.modifyGraphics=function(e,t,i){var r=this;t?e.graphics.forEach(function(e){return r.addToActiveGraphics(e,i)}):e.graphics.forEach(function(e){return r.removeFromActiveGraphics(e,i)}),this.setDirtyUrgent()},t.prototype.graphicSupportsDeconfliction=function(e){var t=e._graphics;if(!t||!t.length)return!1;if(e.isDraped())return!1;for(var i=0,r=t;i<r.length;i++){var a=r[i];if(this.graphics3DGraphicsLayerSupportsDeconfliction(a))return!0}return!1},t.prototype.graphics3DGraphicsLayerSupportsDeconfliction=function(e){if(c.isNone(e)||"object3d"!==e.type)return!1;var t=e.stageObject;return 1===(t?t.getNumGeometryRecords():0)&&t.getGeometryRecord(0).material instanceof M},t.prototype.addGraphic=function(e,t){var i=t.graphic.uid,r=new U(t,e.graphics3DCore.symbolCreationContext.slicePlaneEnabled);e.graphics.set(i,r),this.isFeatureReductionEnabled(e.graphics3DCore)&&this.addToActiveGraphics(r,0),e.graphics3DCore.labelsEnabled&&this.addToActiveGraphics(r,1),this.setDirty()},t.prototype.removeGraphic=function(e,t){var i=t.graphic.uid,r=e.graphics.get(i);r&&(this.removeFromActiveGraphics(r,0),this.removeFromActiveGraphics(r,1),e.graphics.delete(i),this.setDirty())},t.prototype.addToActiveGraphics=function(e,t){e.info[t]=new N;var i=e.graphics3DGraphic.graphic.uid;this.graphics[t].active.set(i,e)},t.prototype.removeFromActiveGraphics=function(e,t){this.removeFromVisibleGraphics(e,t),this.clearGraphicVisibility(e,t),delete e.info[t];var i=e.graphics3DGraphic.graphic.uid;this.graphics[t].active.delete(i)},t.prototype.addToVisibleGraphics=function(e,t){var i=e.info[t];i&&!i.pooled&&(this.graphics[t].visible.push(e),i.pooled=!0)},t.prototype.removeFromVisibleGraphics=function(e,t){var i=e.info[t];i&&i.pooled&&(this.graphics[t].remove.push(e),i.pooled=!1)},t.prototype.processActiveGraphics=function(e,t){for(var i=this.getOrCreateActiveGraphicsIterator(e),r="global"===this.view.viewingMode&&1===this.view.map.ground.opacity&&this.camera&&this.camera.relativeElevation>0;!t.done;){t.madeProgress();var a=i.next();if(a.done)return this.resetActiveGraphicsIterator(e),!0;var s=a.value,n=s&&s.info[e];n&&(this.collectGraphics3DGraphics(s,e,r),n.culled?this.removeFromVisibleGraphics(s,e):this.addToVisibleGraphics(s,e))}return!1},t.prototype.cleanVisibleGraphics=function(e,t){for(var i=this.graphics[e],r=this.ensureRemoveGraphicsIterator(e);!t.done;){var a=r.next();if(t.madeProgress(),a.done)return i.remove.clear(),this.resetRemoveGraphicsIterator(e),!0}return!1},t.prototype.sortVisibleGraphics=function(e,t){for(var i=this.ensureSortGraphicsIterator(e,function(t,i){return t.info[e]&&i.info[e]?i.info[e].posView-t.info[e].posView:Number.MAX_VALUE});!t.done;){var r=i.next();if(t.madeProgress(),r.done)return this.resetSortGraphicsIterator(e),!0}return!1},t.prototype.deconflictVisibleGraphics=function(e,t){for(var i=this.getOrCreateVisibleGraphicsIterator(e),r=1===e;!t.done;){t.madeProgress();var a=i.next();if(a.done)return this.resetVisibleGraphicsIterator(e),!0;var s=a.value,n=s.info[e];if(n&&!n.culled){var o=s.graphics3DGraphic,c=r&&!o.isVisible(),h=!c&&!this.doesIntersectExistingPoly(s,e);n.visible=h,h&&this.addToBins(s,e),this.setGraphicVisibility(s,e,h),h&&y.drawPoly(n,h?"green":"red")}}return!1},t.prototype.resetIterators=function(){this.iterators[0].active=null,this.iterators[0].visible=null,this.iterators[0].remove=null,this.iterators[0].sort=null,this.iterators[1].active=null,this.iterators[1].visible=null,this.iterators[1].remove=null,this.iterators[1].sort=null},t.prototype.getOrCreateActiveGraphicsIterator=function(e){var t=this.graphics[e],i=this.iterators[e];return i.active||(i.active=V(t.active)),i.active},t.prototype.resetActiveGraphicsIterator=function(e){this.iterators[e].active=null},t.prototype.getOrCreateVisibleGraphicsIterator=function(e){var t=this.graphics[e],i=this.iterators[e];return i.visible||(i.visible=t.visible.iterableForEach()),i.visible},t.prototype.resetVisibleGraphicsIterator=function(e){this.iterators[e].visible=null},t.prototype.ensureRemoveGraphicsIterator=function(e){var t=this.graphics[e],i=this.iterators[e];return i.remove||(i.remove=t.visible.iterableRemoveMany(t.remove.data)),i.remove},t.prototype.resetRemoveGraphicsIterator=function(e){this.iterators[e].remove=null},t.prototype.ensureSortGraphicsIterator=function(e,t){var i=this.graphics[e],r=this.iterators[e];return r.sort||(r.sort=i.visible.iterableSort(t)),r.sort},t.prototype.resetSortGraphicsIterator=function(e){this.iterators[e].sort=null},t.prototype.collectGraphics3DGraphics=function(e,t,i){var r=e.graphics3DGraphic;if(!r.destroyed){var a=e.info[t];if(!r.isVisible(0,3))return void(a.culled=!0);for(var s,n,c=1===t,h=c?r._labelGraphics:r._graphics,l=c?0:this.iconMarginFactor,p=g.empty(T),u=0,v=h;u<v.length;u++){var y=v[u];if(this.graphics3DGraphicsLayerSupportsDeconfliction(y)){var M=y.stageObject,S=M.getGeometryRecord(0),V=S.material,N=this.camera,U=S.geometry.data,z=U.getVertexAttr();if(i&&(F.radius=m.earthRadius,f.vec3.sub(A.direction,M.getCenter(),this.camera.eye),f.vec3.copy(A.origin,this.camera.eye),x.intersectRay(F,A,R))){var L=Math.abs(Math.tan(f.vec3.angle(M.getCenter(),A.direction))),k=1-L/this.view.width,X=Math.pow(k,4),W=f.vec3.sqrDist(this.camera.eye,R);if(X*f.vec3.sqrDist(this.camera.eye,M.getCenter())>W)return void(a.culled=!0)}if(!n){var j=M.getCenter(),H=S.origin.vec3;C.transformToWorld(j,H,P),C.transformToView(P,H,N.viewMatrix,B);var q=z[w.VertexAttrConstants.NORMAL].data;if(V.applyVerticalOffsetTransformation(B,q,M.objectTransformation,N,Y),e.slicePlaneEnabled&&this.slicePlaneViewSpace&&G.boundedPlane.extrusionContainsPoint(this.slicePlaneViewSpace,B))return void(a.culled=!0);var Z=z[w.VertexAttrConstants.AUXPOS1].data,J="screen"!==V.getParameters().centerOffsetUnits,K=J?Z:d.vec3f64.ZEROS;C.transformToProjection(B,N.projectionMatrix,K,E),n=C.transformToNDC(E,I),J||(n[0]+=Z[0]/N.fullWidth*2,n[1]+=Z[1]/N.fullHeight*2);if(n[0]<-1||n[1]<-1||n[2]<-1||n[0]>=1||n[1]>=1)break;s=B[2],!b.DISABLE_DECONFLICTOR_VISIBILITY_OFFSET&&a.visible&&(s*=.7)}var Q=y.getScreenSize(_);Q[0]*=N.pixelRatio,Q[1]*=N.pixelRatio,D.applyPrecomputedScaleFactorVec2(Q,Y.factor,Q);var $=g.offset(V.calculateRelativeScreenBounds(Q,Y.factorAlignment.scale,O),o.lerp(0,N.fullWidth,.5+.5*n[0]),o.lerp(0,N.fullHeight,.5+.5*n[1]));if(0!==l){var ee=l*Math.min(g.width($),g.height($));$[0]-=ee,$[1]-=ee,$[2]+=ee,$[3]+=ee}g.expand(p,$)}}null==s?a.culled=!0:(a.xMin=p[0],a.yMin=p[1],a.xMax=p[2],a.yMax=p[3],a.posView=s,a.culled=!1)}},t.prototype.doesIntersectExistingPoly=function(e,t){for(var i=e.graphics3DGraphic.graphic.uid,r=e.info[t],a=Math.floor(r.xMin/this.accBinsSizeX);a<=Math.floor(r.xMax/this.accBinsSizeX);a++)if(!(a<0||a>=this.accBinsNumX))for(var s=Math.floor(r.yMin/this.accBinsSizeY);s<=Math.floor(r.yMax/this.accBinsSizeY);s++)if(!(s<0||s>=this.accBinsNumY))for(var n=this.accBins[a][s],o=0;o<n.length;o++){var c=n.data[o],h=c.info[t];if(h&&h.visible&&(c.graphics3DGraphic.graphic.uid!==i&&(this.accNumTests++,!(h.xMin>r.xMax||h.xMax<r.xMin||h.yMin>r.yMax||h.yMax<r.yMin))))return!0}return!1},t.prototype.initBins=function(e,t){if(null==this.accBins){this.accBins=[];for(var i=0;i<this.accBinsNumX;i++){this.accBins.push([]);for(var r=this.accBins[this.accBins.length-1],a=0;a<this.accBinsNumY;a++)r.push(new h)}}for(var i=0;i<this.accBinsNumX;i++)for(var a=0;a<this.accBinsNumY;a++)this.accBins[i][a].clear();this.accBinsSizeX=e/this.accBinsNumX,this.accBinsSizeY=t/this.accBinsNumY,this.accNumTests=0},t.prototype.addToBins=function(e,t){for(var i=e.info[t],r=Math.floor(i.xMin/this.accBinsSizeX);r<=Math.floor(i.xMax/this.accBinsSizeX);r++)if(!(r<0||r>=this.accBinsNumX))for(var a=Math.floor(i.yMin/this.accBinsSizeY);a<=Math.floor(i.yMax/this.accBinsSizeY);a++)a<0||a>=this.accBinsNumY||this.accBins[r][a].push(e)},t.prototype.isFeatureReductionEnabled=function(e){var t=e.layer;return!(!t||!t.featureReduction||"selection"!==t.featureReduction.type)},t.prototype.clearVisibilityFlags=function(e){var t=e.graphics3DCore.graphics3DGraphics;t&&t.forEach(function(e){return e.clearVisibilityFlag(3)})},t.prototype.setGraphicVisibility=function(e,t,i){var r=e.graphics3DGraphic;r.destroyed||(r.setVisibilityFlag(3,i,t),1===t&&this.view.labeler.setLabelGraphicVisibility(r,i))},t.prototype.clearGraphicVisibility=function(e,t){var i=e.graphics3DGraphic;i.destroyed||i.clearVisibilityFlag(3,t)},a([p.property({constructOnly:!0})],t.prototype,"view",void 0),a([p.property({type:Boolean,readOnly:!0})],t.prototype,"updating",null),t=a([p.subclass("esri.views.3d.layers.graphics.Deconflictor")],t)}(p.declared(s));t.Deconflictor=L;var Y={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},factorAlignment:{scale:0,factor:0,minPixelSize:0,paddingPixels:0}},_=u.vec2f64.create()});