/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../Graphic","../../../../core/Accessor","../../../../core/Collection","../../../../core/Handles","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/watchUtils","../../../../core/accessorSupport/decorators/property","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","../../../../core/accessorSupport/diffUtils","../../../../layers/Layer","../../../../layers/graphics/hydratedFeatures","../../../../rest/support/Query","./constants","./Graphics3DCore","./Graphics3DElevationAlignment","./Graphics3DObjectStates","./Graphics3DScaleVisibility","./graphicUtils","../../../support/WatchUpdatingTracking"],(function(e,t,i,s,r,n,a,o,c,h,p,l,u,d,y,g,b,f,m,S,w,C,v,_,E){"use strict";let x=function(t){function s(e){var i;return(i=t.call(this,e)||this).graphicsCore=null,i.elevationAlignment=new w,i.watchUpdatingTracking=new E.WatchUpdatingTracking,i.handles=new n,i.suspendResumeExtent=null,i}e._inheritsLoose(s,t);var h=s.prototype;return h.normalizeCtorArgs=function(e){let t=null;e.scaleVisibilityEnabled&&(delete(e={...e}).scaleVisibilityEnabled,t=new v);const i=new S.Graphics3DCore({owner:e.owner,layer:e.layer,preferredUpdatePolicy:1,graphicSymbolSupported:!0});return{...e,graphicsCore:i,scaleVisibility:t}},h.initialize=function(){const e=this.scaleVisibility;a.isSome(e)&&"minScale"in this.layer&&this.watchUpdatingTracking.add(this.layer,"scaleRangeId",(()=>e.layerMinMaxScaleChangeHandler())),"elevationInfo"in this.layer&&this.watchUpdatingTracking.add(this.layer,"elevationInfo",((e,t)=>{y.diff(e,t)&&this.watchUpdatingTracking.addPromise(this.graphicsCore.elevationInfoChange())}))},h.setup=function(){var t=e._asyncToGenerator((function*(){const e=(e,t,i)=>this.graphicsCore.spatialIndex.queryGraphicUIDsInExtent(e,t,i);if(this.elevationAlignment.setup(this.owner,e,this.graphicsCore,this.view.elevationProvider),a.isSome(this.scaleVisibility)&&"minScale"in this.layer){const t=this.owner.view.basemapTerrain;this.scaleVisibility.setup(this.owner,this.layer,e,this.graphicsCore,t)}this._set("objectStates",new C.Graphics3DObjectStates(this.graphicsCore));try{yield this.graphicsCore.setup({elevationAlignment:this.elevationAlignment,scaleVisibility:this.scaleVisibility,objectStates:this.objectStates})}catch(t){if(o.isAbortError(t))return;throw t}this.destroyed||(this.handles.add(this.view.watch("clippingArea",(()=>this.updateClippingExtent()),!0)),this.updateClippingExtent(),this.setupSuspendResumeExtent(),this.graphicsCore.startCreateGraphics())}));function i(){return t.apply(this,arguments)}return i}(),h.destroy=function(){this.handles=a.destroyMaybe(this.handles),this.watchUpdatingTracking.destroy(),this._set("elevationAlignment",a.destroyMaybe(this.elevationAlignment)),this._set("scaleVisibility",a.destroyMaybe(this.scaleVisibility)),this._set("objectStates",a.destroyMaybe(this.objectStates)),this._set("graphicsCore",a.destroyMaybe(this.graphicsCore))},h.getGraphicFromGraphicUid=function(e){if(this.owner.loadedGraphics){const t=this.owner.loadedGraphics.find((t=>t.uid===e));if(t){const e=this.layer instanceof g?this.layer:null;return b.hydrateGraphic(t,e)}}},h.whenGraphicBounds=function(e,t){return this.graphicsCore?this.graphicsCore.whenGraphicBounds(e,t):Promise.reject()},h.computeAttachmentOrigin=function(e,t){return this.graphicsCore?this.graphicsCore.computeAttachmentOrigin(e,t):null},h.getSymbolLayerSize=function(e,t){return this.graphicsCore?this.graphicsCore.getSymbolLayerSize(e,t):null},h.maskOccludee=function(e){const{set:t,handle:i}=this.objectStates.acquireSet(1,null);return this.objectStates.setUid(t,e.uid),i},h.highlight=function(e){if(e instanceof f)return U;if("number"==typeof e)return this.highlight([e]);if(e instanceof i)return this.highlight([e]);if(e instanceof r&&(e=e.toArray()),Array.isArray(e)&&e.length>0){if(e[0]instanceof i){const t=e.map((e=>e.uid)),{set:i,handle:s}=this.objectStates.acquireSet(0,null);return this.objectStates.setUids(i,t),s}if("number"==typeof e[0]){const t=e,{set:i,handle:s}=this.objectStates.acquireSet(0,null);return this.objectStates.setObjectIds(i,t),s}}return U},h.updateClippingExtent=function(){const e=this.view.clippingArea;this.graphicsCore.setClippingExtent(e,this.view.spatialReference)&&this.graphicsCore.recreateAllGraphics()},h.updateSuspendResumeExtent=function(){a.isNone(this.scaleVisibility)||(this.suspendResumeExtent=_.enlargeExtent(this.graphicsCore.computedExtent,this.suspendResumeExtent,m.SUSPEND_RESUME_EXTENT_OPTIMISM,this.graphicsCore.extentPadding),this.scaleVisibility.setExtent(this.suspendResumeExtent))},h.setupSuspendResumeExtent=function(){a.isNone(this.scaleVisibility)||(c.init(this.graphicsCore,"computedExtent",(e=>this.updateSuspendResumeExtent()),!0),this.graphicsCore.watch("extentPadding",(e=>this.updateSuspendResumeExtent())))},e._createClass(s,[{key:"suspended",get:function(){return!(!a.isSome(this.scaleVisibility)||!this.scaleVisibility.suspended)}},{key:"updating",get:function(){var e,t;return!!(null!=(e=this.graphicsCore)&&e.updating||a.isSome(this.scaleVisibility)&&this.scaleVisibility.updating||null!=(t=this.watchUpdatingTracking)&&t.updating)}}]),s}(s);t.__decorate([h.property({constructOnly:!0})],x.prototype,"owner",void 0),t.__decorate([h.property({constructOnly:!0})],x.prototype,"layer",void 0),t.__decorate([h.property({readOnly:!0,aliasOf:"owner.view"})],x.prototype,"view",void 0),t.__decorate([h.property({constructOnly:!0})],x.prototype,"graphicsCore",void 0),t.__decorate([h.property({constructOnly:!0})],x.prototype,"scaleVisibility",void 0),t.__decorate([h.property({readOnly:!0})],x.prototype,"elevationAlignment",void 0),t.__decorate([h.property({readOnly:!0})],x.prototype,"objectStates",void 0),t.__decorate([h.property({readOnly:!0})],x.prototype,"watchUpdatingTracking",void 0),t.__decorate([h.property({readOnly:!0})],x.prototype,"suspended",null),t.__decorate([h.property({readOnly:!0})],x.prototype,"updating",null),x=t.__decorate([d.subclass("esri.views.3d.layers.graphics.Graphics3DGraphicLikeLayerView")],x);const U={remove(){},pause(){},resume(){}};return x}));
