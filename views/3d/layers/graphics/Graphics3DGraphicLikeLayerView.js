/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/has","../../../../core/maybe","../../../../core/Logger","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/decorators/subclass","../../../../core/urlUtils","../../../../core/uuid","../../../../portal/support/resourceExtension","../../../../core/promiseUtils","../../../../core/Accessor","../../../../core/Collection","../../../../Graphic","../../../../core/Handles","../../../../layers/Layer","../../../../core/watchUtils","../../../../core/accessorSupport/diffUtils","../../../../tasks/support/Query","../../../support/WatchUpdatingTracking","../../../../layers/graphics/hydratedFeatures","./graphicUtils","./constants","./Graphics3DCore","./Graphics3DScaleVisibility","./Graphics3DElevationAlignment","./Graphics3DObjectStates"],(function(e,t,i,s,r,n,a,o,c,h,p,l,u,d,y,g,b,f,m,S,w,C,v,_,E,x,U,V){"use strict";let A=function(t){function i(e){var i;return(i=t.call(this,e)||this).graphicsCore=null,i.elevationAlignment=new U,i.watchUpdatingTracking=new w.WatchUpdatingTracking,i.handles=new g,i.suspendResumeExtent=null,i}e._inheritsLoose(i,t);var r=i.prototype;return r.normalizeCtorArgs=function(e){let t=null;e.scaleVisibilityEnabled&&(delete(e={...e}).scaleVisibilityEnabled,t=new x);const i=new E.Graphics3DCore({owner:e.owner,layer:e.layer,preferredUpdatePolicy:0,graphicSymbolSupported:!0});return{...e,graphicsCore:i,scaleVisibility:t}},r.initialize=function(){const e=this.scaleVisibility;s.isSome(e)&&"minScale"in this.layer&&this.watchUpdatingTracking.add(this.layer,"scaleRangeId",(()=>e.layerMinMaxScaleChangeHandler())),"elevationInfo"in this.layer&&this.watchUpdatingTracking.add(this.layer,"elevationInfo",((e,t)=>{m.diff(e,t)&&this.watchUpdatingTracking.addPromise(this.graphicsCore.elevationInfoChange())}))},r.setup=async function(){const e=(e,t,i)=>this.graphicsCore.spatialIndex.queryGraphicUIDsInExtent(e,t,i);if(this.elevationAlignment.setup(this.owner,e,this.graphicsCore,this.view.elevationProvider),s.isSome(this.scaleVisibility)&&"minScale"in this.layer){const t=this.owner.view.basemapTerrain;this.scaleVisibility.setup(this.owner,this.layer,e,this.graphicsCore,t)}this._set("objectStates",new V.Graphics3DObjectStates(this.graphicsCore));try{await this.graphicsCore.setup({elevationAlignment:this.elevationAlignment,scaleVisibility:this.scaleVisibility,objectStates:this.objectStates})}catch(t){if(l.isAbortError(t))return;throw t}this.destroyed||(this.handles.add(this.view.watch("clippingArea",(()=>this.updateClippingExtent()),!0)),this.updateClippingExtent(),this.setupSuspendResumeExtent(),this.graphicsCore.startCreateGraphics())},r.destroy=function(){this.handles=s.destroyMaybe(this.handles),this.watchUpdatingTracking.destroy(),this._set("elevationAlignment",s.destroyMaybe(this.elevationAlignment)),this._set("scaleVisibility",s.destroyMaybe(this.scaleVisibility)),this._set("objectStates",s.destroyMaybe(this.objectStates)),this._set("graphicsCore",s.destroyMaybe(this.graphicsCore))},r.getGraphicFromGraphicUid=function(e){if(this.owner.loadedGraphics){const t=this.owner.loadedGraphics.find((t=>t.uid===e));if(t){const e=this.layer instanceof b?this.layer:null;return C.hydrateGraphic(t,e)}}},r.whenGraphicBounds=function(e,t){return this.graphicsCore?this.graphicsCore.whenGraphicBounds(e,t):Promise.reject()},r.computeAttachmentOrigin=function(e,t){return this.graphicsCore?this.graphicsCore.computeAttachmentOrigin(e,t):null},r.getSymbolLayerSize=function(e,t){return this.graphicsCore?this.graphicsCore.getSymbolLayerSize(e,t):null},r.maskOccludee=function(e){const{set:t,handle:i}=this.objectStates.acquireSet(1,null);return this.objectStates.setUid(t,e.uid),i},r.highlight=function(e){if(e instanceof S)return G;if("number"==typeof e)return this.highlight([e]);if(e instanceof y)return this.highlight([e]);if(e instanceof d&&(e=e.toArray()),Array.isArray(e)&&e.length>0){if(e[0]instanceof y){const t=e.map((e=>e.uid)),{set:i,handle:s}=this.objectStates.acquireSet(0,null);return this.objectStates.setUids(i,t),s}if("number"==typeof e[0]){const t=e,{set:i,handle:s}=this.objectStates.acquireSet(0,null);return this.objectStates.setObjectIds(i,t),s}}return G},r.updateClippingExtent=function(){const e=this.view.clippingArea;this.graphicsCore.setClippingExtent(e,this.view.spatialReference)&&this.graphicsCore.recreateAllGraphics()},r.updateSuspendResumeExtent=function(){s.isNone(this.scaleVisibility)||(this.suspendResumeExtent=v.enlargeExtent(this.graphicsCore.computedExtent,this.suspendResumeExtent,_.SUSPEND_RESUME_EXTENT_OPTIMISM,this.graphicsCore.extentPadding),this.scaleVisibility.setExtent(this.suspendResumeExtent))},r.setupSuspendResumeExtent=function(){s.isNone(this.scaleVisibility)||(f.init(this.graphicsCore,"computedExtent",(e=>this.updateSuspendResumeExtent()),!0),this.graphicsCore.watch("extentPadding",(e=>this.updateSuspendResumeExtent())))},e._createClass(i,[{key:"suspended",get:function(){return!(!s.isSome(this.scaleVisibility)||!this.scaleVisibility.suspended)}},{key:"updating",get:function(){var e,t;return!!(null!=(e=this.graphicsCore)&&e.updating||s.isSome(this.scaleVisibility)&&this.scaleVisibility.updating||null!=(t=this.watchUpdatingTracking)&&t.updating)}}]),i}(u);t.__decorate([a.property({constructOnly:!0})],A.prototype,"owner",void 0),t.__decorate([a.property({constructOnly:!0})],A.prototype,"layer",void 0),t.__decorate([a.property({readOnly:!0,aliasOf:"owner.view"})],A.prototype,"view",void 0),t.__decorate([a.property({constructOnly:!0})],A.prototype,"graphicsCore",void 0),t.__decorate([a.property({constructOnly:!0})],A.prototype,"scaleVisibility",void 0),t.__decorate([a.property({readOnly:!0})],A.prototype,"elevationAlignment",void 0),t.__decorate([a.property({readOnly:!0})],A.prototype,"objectStates",void 0),t.__decorate([a.property({readOnly:!0})],A.prototype,"watchUpdatingTracking",void 0),t.__decorate([a.property({readOnly:!0})],A.prototype,"suspended",null),t.__decorate([a.property({readOnly:!0})],A.prototype,"updating",null),A=t.__decorate([o.subclass("esri.views.3d.layers.graphics.Graphics3DGraphicLikeLayerView")],A);const G={remove(){},pause(){},resume(){}};return A}));
