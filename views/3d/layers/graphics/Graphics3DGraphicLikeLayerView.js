/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/has","../../../../core/Logger","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/decorators/subclass","../../../../core/urlUtils","../../../../core/uuid","../../../../portal/support/resourceExtension","../../../../core/promiseUtils","../../../../core/Accessor","../../../../core/Collection","../../../../Graphic","../../../../core/Handles","../../../../layers/Layer","../../../../core/watchUtils","../../../../core/accessorSupport/diffUtils","../../../../tasks/support/Query","../../../support/WatchUpdatingTracking","../../../../layers/graphics/hydratedFeatures","./graphicUtils","./constants","./Graphics3DCore","./Graphics3DScaleVisibility","./Graphics3DElevationAlignment","./Graphics3DObjectStates"],(function(t,e,i,s,r,n,a,o,c,h,l,p,d,u,g,y,b,f,m,S,w,C,v,_,E,x,U){"use strict";let V=function(e){function i(t){var i;return(i=e.call(this,t)||this).graphicsCore=null,i.elevationAlignment=new x,i.watchUpdatingTracking=new S.WatchUpdatingTracking,i.handles=new g,i.suspendResumeExtent=null,i}t._inheritsLoose(i,e);var s=i.prototype;return s.normalizeCtorArgs=function(t){let e=null;t.scaleVisibilityEnabled&&(delete(t={...t}).scaleVisibilityEnabled,e=new E);const i=new _.Graphics3DCore({owner:t.owner,layer:t.layer,preferredUpdatePolicy:0,graphicSymbolSupported:!0});return{...t,graphicsCore:i,scaleVisibility:e}},s.initialize=function(){this.scaleVisibility&&"minScale"in this.layer&&this.watchUpdatingTracking.add(this.layer,"scaleRangeId",(()=>this.scaleVisibility.layerMinMaxScaleChangeHandler())),this.elevationAlignment&&"elevationInfo"in this.layer&&this.watchUpdatingTracking.add(this.layer,"elevationInfo",((t,e)=>{f.diff(t,e)&&this.watchUpdatingTracking.addPromise(this.graphicsCore.elevationInfoChange())}))},s.setup=async function(){const t=(t,e,i)=>this.graphicsCore.spatialIndex.queryGraphicUIDsInExtent(t,e,i);if(this.elevationAlignment.setup(this.owner,t,this.graphicsCore,this.view.elevationProvider),this.scaleVisibility&&"minScale"in this.layer){const e=this.owner.view.basemapTerrain;this.scaleVisibility.setup(this.owner,this.layer,t,this.graphicsCore,e)}this._set("objectStates",new U.Graphics3DObjectStates(this.graphicsCore));try{await this.graphicsCore.setup({elevationAlignment:this.elevationAlignment,scaleVisibility:this.scaleVisibility,objectStates:this.objectStates})}catch(t){if(l.isAbortError(t))return;throw t}this.destroyed||(this.handles.add(this.view.watch("clippingArea",(()=>this.updateClippingExtent()),!0)),this.updateClippingExtent(),this.setupSuspendResumeExtent(),this.graphicsCore.startCreateGraphics())},s.destroy=function(){this.handles&&(this.handles.destroy(),this.handles=null),this.watchUpdatingTracking.destroy(),this.elevationAlignment&&(this.elevationAlignment.destroy(),this._set("elevationAlignment",null)),this.scaleVisibility&&(this.scaleVisibility.destroy(),this._set("scaleVisibility",null)),this.objectStates&&(this.objectStates.destroy(),this._set("objectStates",null)),this.graphicsCore&&(this.graphicsCore.destroy(),this._set("graphicsCore",null))},s.getGraphicFromGraphicUid=function(t){if(this.owner.loadedGraphics){const e=this.owner.loadedGraphics.find((e=>e.uid===t));if(e){const t=this.layer instanceof y?this.layer:null;return w.hydrateGraphic(e,t)}}},s.whenGraphicBounds=function(t,e){return this.graphicsCore?this.graphicsCore.whenGraphicBounds(t,e):l.reject()},s.computeAttachmentOrigin=function(t,e){return this.graphicsCore?this.graphicsCore.computeAttachmentOrigin(t,e):null},s.getSymbolLayerSize=function(t,e){return this.graphicsCore?this.graphicsCore.getSymbolLayerSize(t,e):null},s.maskOccludee=function(t){const{set:e,handle:i}=this.objectStates.acquireSet(1,null);return this.objectStates.setUid(e,t.uid),i},s.highlight=function(t){if(t instanceof m)return A;if("number"==typeof t)return this.highlight([t]);if(t instanceof u)return this.highlight([t]);if(t instanceof d&&(t=t.toArray()),Array.isArray(t)&&t.length>0){if(t[0]instanceof u){const e=t.map((t=>t.uid)),{set:i,handle:s}=this.objectStates.acquireSet(0,null);return this.objectStates.setUids(i,e),s}if("number"==typeof t[0]){const e=t,{set:i,handle:s}=this.objectStates.acquireSet(0,null);return this.objectStates.setObjectIds(i,e),s}}return A},s.updateClippingExtent=function(){const t=this.view.clippingArea;this.graphicsCore.setClippingExtent(t,this.view.spatialReference)&&this.graphicsCore.recreateAllGraphics()},s.updateSuspendResumeExtent=function(){this.suspendResumeExtent=C.enlargeExtent(this.graphicsCore.computedExtent,this.suspendResumeExtent,v.SUSPEND_RESUME_EXTENT_OPTIMISM,this.graphicsCore.extentPadding),this.scaleVisibility.setExtent(this.suspendResumeExtent)},s.setupSuspendResumeExtent=function(){this.scaleVisibility&&(b.init(this.graphicsCore,"computedExtent",(t=>this.updateSuspendResumeExtent()),!0),this.graphicsCore.watch("extentPadding",(t=>this.updateSuspendResumeExtent())))},t._createClass(i,[{key:"suspended",get:function(){return!(!this.scaleVisibility||!this.scaleVisibility.suspended)}},{key:"updating",get:function(){return!!(this.graphicsCore&&this.graphicsCore.updating||this.scaleVisibility&&this.scaleVisibility.updating||this.watchUpdatingTracking&&this.watchUpdatingTracking.updating)}}]),i}(p);e.__decorate([n.property({constructOnly:!0})],V.prototype,"owner",void 0),e.__decorate([n.property({constructOnly:!0})],V.prototype,"layer",void 0),e.__decorate([n.property({readOnly:!0,aliasOf:"owner.view"})],V.prototype,"view",void 0),e.__decorate([n.property({constructOnly:!0})],V.prototype,"graphicsCore",void 0),e.__decorate([n.property({constructOnly:!0})],V.prototype,"scaleVisibility",void 0),e.__decorate([n.property({readOnly:!0})],V.prototype,"elevationAlignment",void 0),e.__decorate([n.property({readOnly:!0})],V.prototype,"objectStates",void 0),e.__decorate([n.property({readOnly:!0})],V.prototype,"watchUpdatingTracking",void 0),e.__decorate([n.property({readOnly:!0,dependsOn:["scaleVisibility.suspended"]})],V.prototype,"suspended",null),e.__decorate([n.property({readOnly:!0,dependsOn:["graphicsCore.updating","scaleVisibility.updating","watchUpdatingTracking.updating"]})],V.prototype,"updating",null),V=e.__decorate([a.subclass("esri.views.3d.layers.graphics.Graphics3DGraphicLikeLayerView")],V);const A={remove(){},pause(){},resume(){}};return V}));
