/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/Error","../../../../core/mathUtils","../../../../chunks/vec3f64","../../../../chunks/vec3","../../../../geometry/projection","../../../../chunks/vec2f64","../../../../chunks/vec2","../../../../geometry/support/aaBoundingBox","../../../../layers/graphics/dehydratedFeatures","../../../../chunks/vec3f32","../../webgl-engine/lib/Object3D","./graphicUtils","./elevationAlignmentUtils","./ElevationContext","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolLayer","../../webgl-engine/materials/DefaultMaterial","../support/FastSymbolUpdates","../../../../chunks/mat2","../../webgl-engine/lib/PathGeometry","../../webgl-engine/lib/pathGeometryUtils","../../webgl-engine/materials/PathMaterial"],(function(e,t,i,a,r,s,n,o,l,c,h,p,d,u,m,f,y,g,_,b,v,S,x,w,P){"use strict";const D=["polyline"];let C=function(e){function r(t,i,a,r){var s;return(s=e.call(this,t,i,a,r)||this)._intrinsicSize=l.fromValues(1,1),s.upVectorAlignment="path",s.stencilWidth=.1,s.ensureDrapedStatus(!1),s}t._inheritsLoose(r,e);var p=r.prototype;return p.doLoad=async function(){const e=i.isSome(this.symbolLayer.width)?this.symbolLayer.width:i.isSome(this.symbolLayer.height)?this.symbolLayer.height:this.symbolLayer.size,t=i.isSome(this.symbolLayer.height)?this.symbolLayer.height:e;this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[e,1,t],unitInMeters:this._context.renderCoordsHelper.unitInMeters,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=v.initFastSymbolUpdatesState(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1};const r=this.symbolLayer.anchor||"center";this.upVectorAlignment="path","heading"===this.symbolLayer.profileRotation&&(this.upVectorAlignment="world");const n=this.symbolLayer.profile||"circle";switch(n){case"circle":default:this._profile=w.Profile.circle(k);break;case"quad":this._profile=w.Profile.rect()}let o=[0,0];"center"!==r&&(o={left:[.5,0],right:[-.5,0],top:[0,-.5],bottom:[0,.5]}[r],this._profile.translate(o[0],o[1]));switch(this.symbolLayer.join||"simple"){case"round":this._extruder=new w.MiterExtruder(0,B);break;case"bevel":this._extruder=new w.MiterExtruder(0,1);break;case"miter":this._extruder=new w.MiterExtruder(.8*Math.PI,1);break;case"simple":default:this._extruder=new w.SimpleExtruder}const l=this.symbolLayer.cap||"butt";switch(l){case"none":this._startCap=new w.NoCapBuilder,this._endCap=new w.NoCapBuilder;break;case"butt":default:this._startCap=new w.TriangulationCapBuilder(this._profile,0),this._endCap=new w.TriangulationCapBuilder(this._profile,0,!0);break;case"square":this._startCap=new w.TriangulationCapBuilder(this._profile,-.5),this._endCap=new w.TriangulationCapBuilder(this._profile,.5,!0);break;case"round":{const e="quad"===n;this._startCap=new w.RoundCapBuilder({profile:this._profile,flip:!1,breakNormals:e,subdivisions:G}),this._endCap=new w.RoundCapBuilder({profile:this._profile,flip:!0,breakNormals:e,subdivisions:G});break}}const h=i.get(this.symbolLayer,"material","color"),p=this._getCombinedOpacityAndColor(h),d=s.fromArray(p),u=p[3],f={diffuse:d,ambient:d,opacity:u,transparent:u<1||this.needsDrivenTransparentPass,vertexColors:!1,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,cullFace:"none"===l?0:void 0,offsetTransparentBackfaces:!0};if(!this._drivenProperties.size&&(c.set(this._intrinsicSize,e,t),!m.isValidSize(this._intrinsicSize[0])||!m.isValidSize(this._intrinsicSize[1])))throw new a("graphics3dpathsymbollayer:invalid-size","Symbol sizes may not be negative values");this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size||c.scale(this._intrinsicSize,this._intrinsicSize,1/this._context.renderCoordsHelper.unitInMeters),this._fastUpdates.enabled?(Object.assign(f,this._fastUpdates.materialParameters,{size:[this._intrinsicSize[0],this._intrinsicSize[1],0]}),this._material=new P.PathMaterial(f)):(f.vertexColors=this._drivenProperties.color||this._drivenProperties.opacity,this._material=new b.DefaultMaterial(f)),this._material.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._context.stage.add(this._material)},p.destroy=function(){e.prototype.destroy.call(this),this._context.stage.remove(this._material),this._material=null},p.createGraphics3DGraphic=function(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,D,this.symbolLayer.type))return null;const i=this.setGraphicElevationContext(t,new y.ElevationContext),a=e.renderingInfo;return this._createAs3DShape(t,a,i,t.uid)},p.layerOpacityChanged=function(){const e=i.get(this.symbolLayer,"material","color"),t=this._getCombinedOpacity(e),a=t<1||this.needsDrivenTransparentPass;return this._material.setParameterValues({opacity:t,transparent:a}),!0},p.layerElevationInfoChanged=function(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,f.needsElevationUpdates3D)},p.slicePlaneEnabledChanged=function(){return this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0},p.physicalBasedRenderingChanged=function(){return this._material.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0},p.pixelRatioChanged=function(){return!0},p.applyRendererDiff=function(e,t){for(const i in e.diff)switch(i){case"visualVariables":if(!v.updateFastSymbolUpdatesState(this._fastUpdates,t,this._vvConvertOptions))return!1;this._material.setParameterValues(this._fastUpdates.materialParameters);break;default:return!1}return!0},p.getVertexData=function(e){let t=0;const i=e.paths,a=[],r=e.spatialReference,s=this._context.elevationProvider.spatialReference,n=this._context.renderCoordsHelper.spatialReference;for(const o of i)t+=o.length;const l=new Float64Array(3*t),c=new Float64Array(3*t),h=new Float64Array(3*t);let p=0;for(const o of i){a.push({index:p,numVertices:o.length});for(const t of o)l[p++]=t[0],l[p++]=t[1],l[p++]=e.hasZ?t[2]:0}let d=!0;return r.equals(s)?this._copyVertices(l,0,c,0,t):d=o.projectBuffer(l,r,0,c,s,0,t),s.equals(n)?this._copyVertices(c,0,h,0,t):o.projectBuffer(c,s,0,h,n,0,t),{pathVertexDataInfos:a,vertexDataGS:l,vertexDataES:c,vertexDataRS:h,projectionSuccess:d,terrainElevation:0}},p._copyVertices=function(e,t,i,a,r){t*=3,a*=3;for(let s=0;s<r;++s)i[a++]=e[t++],i[a++]=e[t++],i[a++]=e[t++]},p._createAs3DShape=function(e,t,a,r){const s=e.geometry,o=new Array,l=new Array,c=new Array,p=s.spatialReference,d=h.create(),m=this._context.renderCoordsHelper,y=this.getVertexData(s);if(!y.projectionSuccess)return this.logger.warn("PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)"),null;if(y.pathVertexDataInfos.length>0){for(let r=0;r<y.pathVertexDataInfos.length;++r){const s=y.pathVertexDataInfos[r],u=s.index,g=s.numVertices;if(g<2){this.logger.warn("PathSymbol3DLayer geometry failed to be created (paths should contain at least 2 vertices)");continue}if(i.isSome(this._context.clippingExtent)&&(h.empty(d),h.expandWithBuffer(d,y.vertexDataES,3*u,g),!h.intersectsClippingArea(d,this._context.clippingExtent)))continue;const b=[];for(let e=u;e<u+3*g;){const t=e++,i=e++,r=e++,s=new w.PathVertex;n.set(s.posGS,y.vertexDataGS[t],y.vertexDataGS[i],y.vertexDataGS[r]),n.set(s.posES,y.vertexDataES[t],y.vertexDataES[i],y.vertexDataES[r]);const o=f.evaluateElevationAlignmentAtPoint(s.posES,this._context.elevationProvider,a,m,null);n.set(L,y.vertexDataRS[t],y.vertexDataRS[i],y.vertexDataRS[r]),m.setAltitude(o,L),n.set(s.pos,L[0],L[1],L[2]),b.push(s)}const v=new w.Path(b);V(v,this.upVectorAlignment,this._context.renderCoordsHelper);const S=new w.Builder(v,this._profile,this._extruder,this._startCap,this._endCap);let P=null;if(this._fastUpdates.enabled){const t=this._fastUpdates.visualVariables,i=t.size?_.getAttributeValue(t.size.field,e):0,a=t.color?_.getAttributeValue(t.color.field,e):0,r=t.opacity?_.getAttributeValue(t.opacity.field,e):0;P=new w.FastUpdatePathGeometry(S,i,a,r)}else{const e=[this._intrinsicSize[0],this._intrinsicSize[1]];this._drivenProperties.size&&(e[0]*=R(t.size[0],"symbol-value"===t.size[2]?this.symbolLayer.height||0:t.size[2],this.symbolLayer.width||0),e[1]*=R(t.size[2],"symbol-value"===t.size[0]?this.symbolLayer.width||0:t.size[0],this.symbolLayer.height||0));let i=null;this._drivenProperties.color&&(i=t.color),this._drivenProperties.opacity&&null!=t.opacity&&(i=i?[i[0],i[1],i[2],t.opacity]:[1,1,1,t.opacity]);const a=new w.StaticPathGeometry(S);a.bake(e),i&&a.bakeVertexColors(i),P=a}const{vertexAttributes:D,indices:C}=P.createGeometryData(),A=new x.PathGeometry(D,C,P,p,this.upVectorAlignment,this.stencilWidth);o.push(A),l.push(this._material),c.push(P.xform)}if(o.length>0){const e={layerUid:this._context.layer.uid,graphicUid:r},t=new u.Object3D({geometries:o,materials:l,transformations:c,metadata:e}),i=new g(this,t,o,null,null,E,a);return i.alignedSampledElevation=y.terrainElevation,i.needsElevationUpdates=f.needsElevationUpdates3D(a.mode),i}}else this.logger.warn("PathSymbol3DLayer geometry failed to be created (no paths were defined)");return null},r}(_.Graphics3DSymbolLayer);function V(e,t,i){switch(t){case"world":for(const t of e.vertices)n.add(z,t.pos,e.offset),i.worldUpAtPosition(z,L),t.setFrameFromUpVector(L),t.computeRotationAxisAndAngleFromUpVector();break;case"path":n.add(z,e.vertices[0].pos,e.offset),i.worldUpAtPosition(z,L),w.computeMinimumRotationTangentFrame(e,L);for(const t of e.vertices){const e=r.sign(n.dot(t.frame.right,t.vRight));n.cross(t.rotationFrame.up,t.vRight,t.vLeft),n.scale(t.rotationFrame.up,t.rotationFrame.up,e),n.normalize(t.rotationFrame.up,t.rotationFrame.up);const i=n.dot(t.rotationFrame.up,t.frame.up),a=n.dot(t.rotationFrame.up,t.frame.right);if(n.scale(z,t.frame.up,-a),n.scale(I,t.frame.right,i),n.add(z,z,I),n.normalize(t.rotationFrame.right,z),w.vertexSpaceToProfileSpace(t.rotationRight,t.frame,t.rotationFrame.right),n.negate(z,t.vLeft),t.rotationAngle=-e*(Math.PI-r.acosClamped(n.dot(z,t.vRight))),Math.abs(t.rotationAngle)>0){const e=r.reciprocalClamped(Math.cos(.5*t.rotationAngle));S.set(t.miterStretch,1+(e-1)*t.rotationRight[0]*t.rotationRight[0],(e-1)*t.rotationRight[0]*t.rotationRight[1],(e-1)*t.rotationRight[0]*t.rotationRight[1],1+(e-1)*t.rotationRight[1]*t.rotationRight[1])}const s=Math.PI-t.rotationAngle;t.maxStretchDistance=Math.abs(Math.min(t.vLeftLength,t.vRightLength)*r.reciprocalClamped(Math.cos(.5*s)))}}}function R(e,t,i){switch(e){case"symbol-value":return i;case"proportional":return t;default:return e}}function A(e,t,i,a){let r=0;for(const s of e.vertices){const o=f.evaluateElevationAlignmentAtPoint(s.posES,i,t,a,F);r+=F.sampledElevation,n.add(L,s.pos,e.offset),a.setAltitude(o,L),n.subtract(s.pos,L,e.offset)}return e.updatePathVertexInformation(),r/e.vertices.length}function E(e,t,i,a){const r=e.stageObject,s=r.geometryRecords,n=s.length;let o=0;U.spatialReference=a.spatialReference;for(let l=0;l<n;l++){const e=s[l].geometry;if(!x.isPathGeometry(e))continue;const n=e.path,c=n.builder.path;e.geometrySR;o+=A(c,t,i,a),"world"!==e.upVectorAlignment&&V(c,e.upVectorAlignment,a),n.onPathChanged(),e.invalidateBoundingInfo(),r.geometryVertexAttrsUpdated(l)}return o/n}const U=p.makeDehydratedPoint(0,0,0,null),L=s.create(),z=d.create(),I=d.create(),B=3,G=3,k=10,F={verticalDistanceToGround:0,sampledElevation:0};e.Graphics3DPathSymbolLayer=C,e.NUM_CIRCLE_PROFILE_SUBDIVISIONS=k,e.NUM_ROUND_CAP_EXTRUSION_SUBDIVISIONS=G,e.NUM_ROUND_JOIN_SUBDIVISIONS=B,e.default=C,Object.defineProperty(e,"__esModule",{value:!0})}));
