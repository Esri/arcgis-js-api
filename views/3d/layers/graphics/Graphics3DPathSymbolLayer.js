// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../core/Error","../../../../core/lang","../../../../core/mathUtils","../../../../core/maybe","../../../../core/libs/gl-matrix-2/mat2","../../../../core/libs/gl-matrix-2/vec2","../../../../core/libs/gl-matrix-2/vec2f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f32","../../../../core/libs/gl-matrix-2/vec3f64","../../../../geometry/support/aaBoundingBox","../../../../layers/graphics/dehydratedFeatures","./elevationAlignmentUtils","./elevationAlignmentUtils","./ElevationContext","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolLayer","./graphicUtils","../support/FastSymbolUpdates","../../support/projectionUtils","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/pathGeometryUtils","../../webgl-engine/materials/DefaultMaterial","../../webgl-engine/materials/PathMaterial"],(function(e,t,a,r,i,s,o,n,l,h,c,p,d,u,m,v,f,y,_,g,b,S,x,D,R,U,I,P){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NUM_CIRCLE_PROFILE_SUBDIVISIONS=t.NUM_ROUND_CAP_EXTRUSION_SUBDIVISIONS=t.NUM_ROUND_JOIN_SUBDIVISIONS=t.Graphics3DPathSymbolLayer=void 0;var w=function(e){function s(t,a,r,i){var s=e.call(this,t,a,r,i)||this;return s._intrinsicSize=h.vec2f64.fromValues(1,1),s.upVectorAlignment="path",s.stencilWidth=.1,s.ensureDrapedStatus(!1),s}return a.__extends(s,e),s.prototype.doLoad=function(){return a.__awaiter(this,void 0,void 0,(function(){var e,s,n,h,c,p,u,m,v,f,y,_,g;return a.__generator(this,(function(a){switch(e=o.isSome(this.symbolLayer.width)?this.symbolLayer.width:o.isSome(this.symbolLayer.height)?this.symbolLayer.height:this.symbolLayer.size,s=o.isSome(this.symbolLayer.height)?this.symbolLayer.height:e,this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[e,1,s],unitInMeters:this._context.renderCoordsHelper.unitInMeters,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=S.initFastSymbolUpdatesState(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1},n=this.symbolLayer.anchor||"center",this.upVectorAlignment="path","heading"===this.symbolLayer.profileRotation&&(this.upVectorAlignment="world"),h=this.symbolLayer.profile||"circle"){case"circle":default:this._profile=U.Profile.circle(t.NUM_CIRCLE_PROFILE_SUBDIVISIONS);break;case"quad":this._profile=U.Profile.rect()}switch(c=[0,0],"center"!==n&&(c={left:[.5,0],right:[-.5,0],top:[0,-.5],bottom:[0,.5]}[n],this._profile.translate(c[0],c[1])),this.symbolLayer.join||"simple"){case"round":this._extruder=new U.MiterExtruder(0,t.NUM_ROUND_JOIN_SUBDIVISIONS);break;case"bevel":this._extruder=new U.MiterExtruder(0,1);break;case"miter":this._extruder=new U.MiterExtruder(.8*Math.PI,1);break;case"simple":default:this._extruder=new U.SimpleExtruder}switch(p=this.symbolLayer.cap||"butt"){case"none":this._startCap=new U.NoCapBuilder,this._endCap=new U.NoCapBuilder;break;case"butt":default:this._startCap=new U.TriangulationCapBuilder(this._profile,0),this._endCap=new U.TriangulationCapBuilder(this._profile,0,!0);break;case"square":this._startCap=new U.TriangulationCapBuilder(this._profile,-.5),this._endCap=new U.TriangulationCapBuilder(this._profile,.5,!0);break;case"round":u="quad"===h,this._startCap=new U.RoundCapBuilder({profile:this._profile,flip:!1,breakNormals:u,subdivisions:t.NUM_ROUND_CAP_EXTRUSION_SUBDIVISIONS}),this._endCap=new U.RoundCapBuilder({profile:this._profile,flip:!0,breakNormals:u,subdivisions:t.NUM_ROUND_CAP_EXTRUSION_SUBDIVISIONS})}if(m=this._getIdHint(),v=o.get(this.symbolLayer,"material","color"),f=this._getCombinedOpacityAndColor(v),y=d.vec3f64.fromArray(f),_=f[3],g={diffuse:y,ambient:y,opacity:_,transparent:_<1||this.needsDrivenTransparentPass,vertexColors:!1,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,cullFace:"none"===p?0:void 0,offsetTransparentBackfaces:!0},!this._drivenProperties.size&&(l.vec2.set(this._intrinsicSize,e,s),!b.isValidSize(this._intrinsicSize[0])||!b.isValidSize(this._intrinsicSize[1])))throw new r("graphics3dpathsymbollayer:invalid-size","Symbol sizes may not be negative values");return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size||l.vec2.scale(this._intrinsicSize,this._intrinsicSize,1/this._context.renderCoordsHelper.unitInMeters),this._fastUpdates.enabled?(i.mixin(g,this._fastUpdates.materialParameters,{size:[this._intrinsicSize[0],this._intrinsicSize[1],0]}),this._material=new P(g,m+"_pathmat")):(g.vertexColors=this._drivenProperties.color||this._drivenProperties.opacity,this._material=new I(g,m+"_pathmat")),this._material.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._context.stage.add(3,this._material),[2]}))}))},s.prototype.destroy=function(){e.prototype.destroy.call(this),this._material&&(this._context.stage.remove(3,this._material.id),this._material=null)},s.prototype.createGraphics3DGraphic=function(e){var t=e.graphic;if(!this._validateGeometryType(t.geometry,s.validGeometryTypes,this.symbolLayer.type))return null;if(!this._validateGeometry(t.geometry))return null;var a="graphic"+t.uid,r=this.setGraphicElevationContext(t,new y.ElevationContext),i=e.renderingInfo;return this._createAs3DShape(t,i,r,a,t.uid)},s.prototype.layerOpacityChanged=function(){var e=o.get(this.symbolLayer,"material","color"),t=this._getCombinedOpacity(e),a=t<1||this.needsDrivenTransparentPass;return this._material.setParameterValues({opacity:t,transparent:a}),!0},s.prototype.layerElevationInfoChanged=function(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,f.needsElevationUpdates3D)},s.prototype.slicePlaneEnabledChanged=function(){return this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0},s.prototype.physicalBasedRenderingChanged=function(){return this._material.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0},s.prototype.pixelRatioChanged=function(){return!0},s.prototype.applyRendererDiff=function(e,t){for(var a in e.diff)switch(a){case"visualVariables":if(!S.updateFastSymbolUpdatesState(this._fastUpdates,t,this._vvConvertOptions))return!1;this._material.setParameterValues(this._fastUpdates.materialParameters);break;default:return!1}return!0},s.prototype.getVertexData=function(e){for(var t=0,a=e.paths,r=[],i=e.spatialReference,s=this._context.elevationProvider.spatialReference,o=this._context.renderCoordsHelper.spatialReference,n=0,l=a;n<l.length;n++){t+=(v=l[n]).length}for(var h=new Float64Array(3*t),c=new Float64Array(3*t),p=new Float64Array(3*t),d=0,u=0,m=a;u<m.length;u++){var v=m[u];r.push({index:d,numVertices:v.length});for(var f=0,y=v;f<y.length;f++){var _=y[f];h[d++]=_[0],h[d++]=_[1],h[d++]=e.hasZ?_[2]:0}}var g=!0;return i.equals(s)?this._copyVertices(h,0,c,0,t):g=x.bufferToBuffer(h,i,0,c,s,0,t),s.equals(o)?this._copyVertices(c,0,p,0,t):x.bufferToBuffer(c,s,0,p,o,0,t),{pathVertexDataInfos:r,vertexDataGS:h,vertexDataES:c,vertexDataRS:p,projectionSuccess:g,terrainElevation:0}},s.prototype._copyVertices=function(e,t,a,r,i){t*=3,r*=3;for(var s=0;s<i;++s)a[r++]=e[t++],a[r++]=e[t++],a[r++]=e[t++]},s.prototype._createAs3DShape=function(e,t,a,r,i){var s=e.geometry,n=[],l=[],h=[],p=s.spatialReference,d=this._context.elevationProvider.spatialReference,m=u.create(),y=this._context.renderCoordsHelper;O.spatialReference=p,N.spatialReference=d;var b=this.getVertexData(s);if(!b.projectionSuccess)return this.logger.warn("PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)"),null;if(b.pathVertexDataInfos.length>0){for(var S=0;S<b.pathVertexDataInfos.length;++S){var x=b.pathVertexDataInfos[S],I=x.index,P=x.numVertices;if(P<2)this.logger.warn("PathSymbol3DLayer geometry failed to be created (paths should contain at least 2 vertices)");else if(!o.isSome(this._context.clippingExtent)||(u.empty(m),u.expandWithBuffer(m,b.vertexDataES,3*I,P),u.intersectsClippingArea(m,this._context.clippingExtent))){for(var w=[],V=I;V<I+3*P;){var L=V++,B=V++,G=V++,M=new U.PathVertex;c.vec3.set(M.posGS,b.vertexDataGS[L],b.vertexDataGS[B],b.vertexDataGS[G]),c.vec3.set(M.posES,b.vertexDataES[L],b.vertexDataES[B],b.vertexDataES[G]),N.x=M.posES[0],N.y=M.posES[1],N.z=M.posES[2];var F=v.evaluateElevationAlignmentAtPoint(N,this._context.elevationProvider,a,y,null);c.vec3.set(z,b.vertexDataRS[L],b.vertexDataRS[B],b.vertexDataRS[G]),y.setAltitude(F,z),c.vec3.set(M.pos,z[0],z[1],z[2]),w.push(M)}var T=new U.Path(w);C(T,this.upVectorAlignment,this._context.renderCoordsHelper);var k=new U.Builder(T,this._profile,this._extruder,this._startCap,this._endCap),j=null;if(this._fastUpdates.enabled){var H=this._fastUpdates.visualVariables,q=H.size?g.getAttributeValue(H.size.field,e):0,W=H.color?g.getAttributeValue(H.color.field,e):0,X=H.opacity?g.getAttributeValue(H.opacity.field,e):0;j=new U.FastUpdatePathGeometry(k,q,W,X)}else{var J=[this._intrinsicSize[0],this._intrinsicSize[1]];this._drivenProperties.size&&(J[0]*=E(t.size[0],"symbol-value"===t.size[2]?this.symbolLayer.height||0:t.size[2],this.symbolLayer.width||0),J[1]*=E(t.size[2],"symbol-value"===t.size[0]?this.symbolLayer.width||0:t.size[0],this.symbolLayer.height||0));var Z=null;this._drivenProperties.color&&(Z=t.color),this._drivenProperties.opacity&&null!=t.opacity&&(Z=Z?[Z[0],Z[1],Z[2],t.opacity]:[1,1,1,t.opacity]);var K=new U.StaticPathGeometry(k);K.bake(J),Z&&K.bakeVertexColors(Z),j=K}var Q=j.createGeometryData(),Y=new D(Q,r+"path"+S),$={pathGeometry:j,geometrySR:p,upVectorAlignment:this.upVectorAlignment,stencilWidth:this.stencilWidth};Y.metadata=$,n.push(Y),l.push(this._material),h.push(j.xform)}}var ee={layerUid:this._context.layer.uid,graphicUid:i};if(n.length>0){var te=new R({geometries:n,materials:l,transformations:h,castShadow:!0,metadata:ee,idHint:r}),ae=new _(this,te,n,null,null,A,a);return ae.alignedSampledElevation=b.terrainElevation,ae.needsElevationUpdates=f.needsElevationUpdates3D(a.mode),ae}}else this.logger.warn("PathSymbol3DLayer geometry failed to be created (no paths were defined)");return null},s.validGeometryTypes=["polyline"],s}(g.Graphics3DSymbolLayer);function C(e,t,a){switch(t){case"world":for(var r=0,i=e.vertices;r<i.length;r++){var o=i[r];c.vec3.add(B,o.pos,e.offset),a.worldUpAtPosition(B,z),o.setFrameFromUpVector(z),o.computeRotationAxisAndAngleFromUpVector()}break;case"path":c.vec3.add(B,e.vertices[0].pos,e.offset),a.worldUpAtPosition(B,z),U.computeMinimumRotationTangentFrame(e,z);for(var l=0,h=e.vertices;l<h.length;l++){o=h[l];var p=s.sign(c.vec3.dot(o.frame.right,o.vRight));c.vec3.cross(o.rotationFrame.up,o.vRight,o.vLeft),c.vec3.scale(o.rotationFrame.up,o.rotationFrame.up,p),c.vec3.normalize(o.rotationFrame.up,o.rotationFrame.up);var d=c.vec3.dot(o.rotationFrame.up,o.frame.up),u=c.vec3.dot(o.rotationFrame.up,o.frame.right);if(c.vec3.scale(B,o.frame.up,-u),c.vec3.scale(G,o.frame.right,d),c.vec3.add(B,B,G),c.vec3.normalize(o.rotationFrame.right,B),U.vertexSpaceToProfileSpace(o.rotationRight,o.frame,o.rotationFrame.right),c.vec3.negate(B,o.vLeft),o.rotationAngle=-p*(Math.PI-s.acosClamped(c.vec3.dot(B,o.vRight))),Math.abs(o.rotationAngle)>0){var m=s.reciprocalClamped(Math.cos(.5*o.rotationAngle));n.mat2.set(o.miterStretch,1+(m-1)*o.rotationRight[0]*o.rotationRight[0],(m-1)*o.rotationRight[0]*o.rotationRight[1],(m-1)*o.rotationRight[0]*o.rotationRight[1],1+(m-1)*o.rotationRight[1]*o.rotationRight[1])}var v=Math.PI-o.rotationAngle;o.maxStretchDistance=Math.abs(Math.min(o.vLeftLength,o.vRightLength)*s.reciprocalClamped(Math.cos(.5*v)))}}}function E(e,t,a){switch(e){case"symbol-value":return a;case"proportional":return t;default:return e}}function V(e,t,a,r){for(var i=0,s=0,o=e.vertices;s<o.length;s++){var n=o[s];N.x=n.posES[0],N.y=n.posES[1],N.z=n.posES[2];var l=v.evaluateElevationAlignmentAtPoint(N,a,t,r,M);i+=M.sampledElevation,c.vec3.add(z,n.pos,e.offset),r.setAltitude(l,z),c.vec3.subtract(n.pos,z,e.offset)}return e.updatePathVertexInformation(),i/e.vertices.length}function A(e,t,a,r){var i=e.stageObject,s=i.geometryRecords,o=s.length,n=0;N.spatialReference=a.spatialReference,L.spatialReference=r.spatialReference;for(var l=0;l<o;l++){var h=s[l].geometry,c=h.metadata,p=c.pathGeometry,d=p.builder.path,u=c.geometrySR;O.spatialReference=u,n+=V(d,t,a,r),"world"!==d.upVector&&C(d,c.upVectorAlignment,r),p.onPathChanged(),h.invalidateBoundingInfo(),i.geometryVertexAttrsUpdated(l)}return n/o}t.Graphics3DPathSymbolLayer=w;var L=m.makeDehydratedPoint(0,0,0,null),N=m.makeDehydratedPoint(0,0,0,null),O=m.makeDehydratedPoint(0,0,0,null),z=d.vec3f64.create(),B=p.vec3f32.create(),G=p.vec3f32.create();t.NUM_ROUND_JOIN_SUBDIVISIONS=3,t.NUM_ROUND_CAP_EXTRUSION_SUBDIVISIONS=3,t.NUM_CIRCLE_PROFILE_SUBDIVISIONS=10;var M={verticalDistanceToGround:0,sampledElevation:0};t.default=w}));