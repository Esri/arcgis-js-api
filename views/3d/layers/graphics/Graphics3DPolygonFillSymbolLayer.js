// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../Color","../../../../core/maybe","../../../../core/screenUtils","../../../../core/libs/earcut/earcut","../../../../core/libs/gl-matrix-2/mat4f64","../../../../geometry/support/aaBoundingBox","./ElevationAligners","./elevationAlignmentUtils","./ElevationContext","./Graphics3DDrapedGraphicLayer","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolLayer","./graphicUtils","./lineUtils","./polygonUtils","../support/patternUtils","../support/uvUtils","../../support/buffer/BufferView","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/RenderGeometry","../../webgl-engine/lib/Util","../../webgl-engine/materials/lineStippleUtils","../../webgl-engine/materials/NativeLineMaterial","../../webgl-engine/materials/PatternMaterial","../../webgl-engine/materials/RibbonLineMaterial"],(function(e,t,i,r,a,n,o,l,s,u,p,d,c,h,y,m,f,_,g,v,b,E,S,x,M,D,A,O,w){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Graphics3DPolygonFillSymbolLayer=void 0;var P=function(e){function t(t,i,r,a){var n=e.call(this,t,i,r,a)||this;return n._needsUV=!1,n._hasOutline=!1,n}return i.__extends(t,e),t.prototype.doLoad=function(){return i.__awaiter(this,void 0,void 0,(function(){return i.__generator(this,(function(e){return[2]}))}))},t.prototype.ensureMaterials=function(){this.ensureFillMaterial(),this.ensureOutlineMaterial()},t.prototype.ensureFillMaterial=function(){if(!a.isSome(this._material)){var e=a.get(this.symbolLayer,"material","color"),t=this._getCombinedOpacityAndColor(e);this._material=g.createMaterial(this.symbolLayer,{color:t,transparent:t[3]<1||this.needsDrivenTransparentPass,polygonOffset:!1,vertexColors:!0,slicePlaneEnabled:this._context.slicePlaneEnabled},{isDraped:this.draped,idHint:this._getIdHint()}),this._needsUV=this._material instanceof O,this._context.stage.add(3,this._material)}},t.prototype.ensureOutlineMaterial=function(){var e=this,t=this.symbolLayer.outline;if(!a.isSome(this._outlineMaterial)&&this._isValidOutline(t)){this._hasOutline=!0;var i,o,l;this._outlineMaterial=(i=n.pt2px(t.size),o=t.stipplePattern?D.createStipplePattern(t.stipplePattern.map(n.pt2px)):null,l=t.stippleOffColor?r.toUnitRGBA(t.stippleOffColor):null,i>1.5?new w({width:i,color:e._getOutlineColor(),polygonOffset:!0,slicePlaneEnabled:e._context.slicePlaneEnabled,isClosed:!0,stipplePattern:o,stippleIntegerRepeats:!0,stippleOffColor:l},e._getIdHint("_outline_ribbonlinemat")):new A({color:e._getOutlineColor(),slicePlaneEnabled:e._context.slicePlaneEnabled,width:i,stipplePattern:o,stippleIntegerRepeats:!0,stippleOffColor:l},e._getIdHint("_outline_nativelinemat"))),this._context.stage.add(3,this._outlineMaterial)}},t.prototype._isValidOutline=function(e){return a.isSome(e)&&e.size&&e.size>0&&a.isSome(e.color)},t.prototype.destroy=function(){e.prototype.destroy.call(this),a.isSome(this._material)&&(this._context.stage.remove(3,this._material.id),this._material=null),a.isSome(this._outlineMaterial)&&(this._context.stage.remove(3,this._outlineMaterial.id),this._outlineMaterial=null)},t.prototype.createGraphics3DGraphic=function(e){var i=e.graphic;if(!this._validateGeometryType(i.geometry,t.validGeometryTypes,this.symbolLayer.type))return null;if(!this._validateGeometry(i.geometry))return null;var r="graphic"+i.uid,a=this._getVertexOpacityAndColor(e.renderingInfo,Uint8Array,255),n=this.setGraphicElevationContext(i,new d.ElevationContext);return this.ensureDrapedStatus("on-the-ground"===n.mode),this.ensureMaterials(),this.draped?this._createAsOverlay(i,a,r):this._createAs3DShape(i,a,n,r)},t.prototype.layerOpacityChanged=function(){if(a.isSome(this._material)){var e=this._material.getParameters().color,t=a.get(this.symbolLayer,"material","color"),i=this._getCombinedOpacity(t);this._material.setParameterValues({color:[e[0],e[1],e[2],i],transparent:i<1||this.needsDrivenTransparentPass})}if(a.isSome(this._outlineMaterial)){var r=this._outlineMaterial.getParameters().color;this._outlineMaterial.setParameterValues({color:[r[0],r[1],r[2],this._getOutlineOpacity()]})}return!0},t.prototype.layerElevationInfoChanged=function(e,i,r){var a=this._elevationContext.mode,n=p.elevationModeChangeUpdateType(t.elevationModeChangeTypes,r,a);if(n!==p.SymbolUpdateType.UPDATE)return n;var o=p.needsElevationUpdates2D(a);return this.updateGraphics3DGraphicElevationInfo(e,i,(function(){return o}))},t.prototype.slicePlaneEnabledChanged=function(){if(a.isSome(this._material)&&this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),a.isSome(this._outlineMaterial)){var e={slicePlaneEnabled:this._context.slicePlaneEnabled};this._outlineMaterial.setParameterValues(e)}return!0},t.prototype.physicalBasedRenderingChanged=function(){return!0},t.prototype.pixelRatioChanged=function(){return!0},t.prototype._createAs3DShape=function(e,t,i,r){var n=_.geometryAsPolygon(e.geometry);if(a.isNone(n))return null;T.renderData=_.geometryToRenderInfo(n,this._context.elevationProvider,this._context.renderCoordsHelper,i),T.idHint=r,T.color=t;var o=T.renderData.position.length/3;if(this._needsUV&&(T.uvMapSpace=new Float32Array(4*o),T.bound1=new Float64Array(3*o),T.bound2=new Float64Array(3*o),T.bound3=new Float64Array(3*o)),T.outNum=0,T.outGeometries=[],T.outTransforms=[],T.outMaterials=[],this._createAs3DShapeFill(T),this._hasOutline&&this._createAs3DShapeOutline(T),this._logGeometryCreationWarnings(T.renderData,n.rings,"rings","FillSymbol3DLayer"),0===T.outNum)return null;this._needsUV&&v.createMapSpaceUVCoords(b.BufferViewVec4f.fromTypedArray(T.uvMapSpace),b.BufferViewVec3f64.fromTypedArray(T.renderData.position),this._context.layerView.view.renderCoordsHelper,b.BufferViewVec3f64.fromTypedArray(T.bound1),b.BufferViewVec3f64.fromTypedArray(T.bound2),b.BufferViewVec3f64.fromTypedArray(T.bound3));var l=new S({geometries:T.outGeometries,materials:T.outMaterials,transformations:T.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:e.uid},idHint:r}),s=u.perVertexElevationAligner,d=new h(this,l,T.outGeometries,null,null,s,i);return d.alignedSampledElevation=T.renderData.sampledElevation,d.needsElevationUpdates=p.needsElevationUpdates2D(i.mode),d},t.prototype._createAs3DShapeFill=function(e){for(var t=0,i=e.renderData.polygons;t<i.length;t++){var r=i[t],n=r.position,u=r.mapPosition,p=r.holeIndices,d=r.index,c=r.count;if(!a.isSome(this._context.clippingExtent)||(s.empty(U),s.expandWithBuffer(U,u),s.intersectsClippingArea(U,this._context.clippingExtent))){var h=o.earcut(u,p,3);if(0!==h.length){var y=new Uint32Array(h),m=_.createColorGeometryData({indices:y,attributeData:{position:n,color:e.color,mapPosition:u,uvMapSpace:this._needsUV?new Float32Array(e.uvMapSpace.buffer,4*d*e.uvMapSpace.BYTES_PER_ELEMENT,4*c):null,bound1:this._needsUV?new Float64Array(e.bound1.buffer,3*d*e.bound1.BYTES_PER_ELEMENT,3*c):null,bound2:this._needsUV?new Float64Array(e.bound2.buffer,3*d*e.bound2.BYTES_PER_ELEMENT,3*c):null,bound3:this._needsUV?new Float64Array(e.bound3.buffer,3*d*e.bound3.BYTES_PER_ELEMENT,3*c):null}}),f=new E(m,e.idHint);e.outGeometries.push(f),e.outMaterials.push(a.unwrap(this._material)),e.outTransforms.push(l.mat4f64.IDENTITY),e.outNum++}}}},t.prototype._createAs3DShapeOutline=function(e){if(this._hasOutline)for(var t=e.renderData.outlines,i=this._outlineMaterial instanceof A,r=0;r<t.length;++r){var n=t[r],o=n.mapPosition,u=n.position;if(!a.isSome(this._context.clippingExtent)||(s.empty(U),s.expandWithBuffer(U,o),s.intersectsClippingArea(U,this._context.clippingExtent))){var p=f.createGeometryData({removeDuplicateStartEnd:i?0:1,attributeData:{position:u,mapPosition:o}}),d=p.vertexAttributes[M.VertexAttrConstants.POSITION];d.data===u&&(d.data=new Float64Array(u));var c=new E(p,e.idHint+"outline"+r);e.outGeometries.push(c),e.outMaterials.push(a.unwrap(this._outlineMaterial)),e.outTransforms.push(l.mat4f64.IDENTITY),e.outNum++}}},t.prototype._createAsOverlay=function(e,t,i){var r=_.geometryAsPolygon(e.geometry);if(a.isNone(r))return null;a.unwrap(this._material).renderPriority=this._renderPriority+this._renderPriorityStep/2,a.isSome(this._outlineMaterial)&&(this._outlineMaterial.renderPriority=this._renderPriority),C.renderData=_.geometryToRenderInfoDraped(r,this._context.overlaySR),C.idHint=i,C.color=t;var n=C.renderData.position.length/3;return this._needsUV&&(C.uvMapSpace=new Float32Array(4*n)),C.outNum=0,C.outGeometries=[],C.outBoundingBox=s.empty(),C.layerUid=this._context.layer.uid,C.graphicsUid=e.uid,this._createAsOverlayFill(C),this._hasOutline&&this._createAsOverlayOutline(C),this._logGeometryCreationWarnings(C.renderData,r.rings,"rings","FillSymbol3DLayer"),0===C.outNum?null:(this._needsUV&&v.createMapSpaceUVCoordsDraped(b.BufferViewVec4f.fromTypedArray(C.uvMapSpace),b.BufferViewVec3f64.fromTypedArray(C.renderData.position),this._context.overlaySR),C.outNum>0?new c(this,C.outGeometries,C.outBoundingBox):null)},t.prototype._createAsOverlayFill=function(e){for(var t=0,i=e.renderData.polygons;t<i.length;t++){var r=i[t],n=r.position,l=r.holeIndices,u=r.index,p=r.count;if(s.empty(U),s.expandWithBuffer(U,n),s.intersectsClippingArea(U,this._context.clippingExtent)){var d=o.earcut(n,l,3);if(0!==d.length){s.expand(e.outBoundingBox,U);var c=new Uint32Array(d),h=_.createColorGeometryData({indices:c,attributeData:{position:n,color:e.color,uvMapSpace:this._needsUV?new Float32Array(e.uvMapSpace.buffer,4*u*e.uvMapSpace.BYTES_PER_ELEMENT,4*p):null}}),y=new x(h);y.data.layerUid=e.layerUid,y.data.graphicUid=e.graphicsUid,y.material=a.unwrap(this._material);var m=U;y.center=[.5*(m[0]+m[3]),.5*(m[1]+m[4]),0],y.bsRadius=.5*Math.sqrt((m[3]-m[0])*(m[3]-m[0])+(m[4]-m[1])*(m[4]-m[1])),e.outGeometries.push(y),e.outNum++}}}},t.prototype._createAsOverlayOutline=function(e){if(this._hasOutline)for(var t=e.renderData.outlines,i=0;i<t.length;++i){var r=t[i].position;if(s.empty(U),s.expandWithBuffer(U,r),s.intersectsClippingArea(U,this._context.clippingExtent)){s.expand(e.outBoundingBox,U);var n=this._outlineMaterial instanceof A,o=f.createGeometryData({removeDuplicateStartEnd:n?0:1,attributeData:{position:r}}),l=new x(o);l.data.layerUid=e.layerUid,l.data.graphicUid=e.graphicsUid,l.material=a.unwrap(this._outlineMaterial);var u=U;l.center=[.5*(u[0]+u[3]),.5*(u[1]+u[4]),0],l.bsRadius=.5*Math.sqrt((u[3]-u[0])*(u[3]-u[0])+(u[4]-u[1])*(u[4]-u[1])),e.outGeometries.push(l),e.outNum++}}},t.prototype._getOutlineOpacity=function(){var e=a.get(this.symbolLayer,"outline","color");return(this.draped?1:this._getLayerOpacity())*(a.isSome(e)?e.a:0)},t.prototype._getOutlineColor=function(){var e=a.get(this.symbolLayer,"outline","color"),t=this._getOutlineOpacity();return m.mixinColorAndOpacity(a.isSome(e)?r.toUnitRGB(e):null,t)},Object.defineProperty(t.prototype,"test",{get:function(){var e=this;return{createAsOverlay:function(t,i,r){return e._createAsOverlay(t,i,r)},createAs3DShape:function(t,i,r,a){return e._createAs3DShape(t,i,r,a)}}},enumerable:!1,configurable:!0}),t.validGeometryTypes=["polyline","polygon","extent"],t.elevationModeChangeTypes={definedChanged:p.SymbolUpdateType.RECREATE,staysOnTheGround:p.SymbolUpdateType.NONE,onTheGroundChanged:p.SymbolUpdateType.RECREATE},t}(y.default);t.Graphics3DPolygonFillSymbolLayer=P;var U=s.create(),T={idHint:null,renderData:null,color:null,uvMapSpace:null,bound1:null,bound2:null,bound3:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},C={idHint:null,renderData:null,color:null,uvMapSpace:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null};t.default=P}));