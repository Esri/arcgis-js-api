/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../Color","../../../../core/maybe","../../../../core/screenUtils","../../../../chunks/earcut","../../../../chunks/vec4","../../../../geometry/support/aaBoundingBox","./elevationAlignmentUtils","./ElevationContext","./Graphics3DDrapedGraphicLayer","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolLayer","./graphicUtils","./lineUtils","./polygonUtils","../support/patternUtils","../support/uvUtils","../../support/engineContent/line","../../support/renderInfoUtils/polygon","../../webgl-engine/lib/DoubleArray","../../webgl-engine/lib/FloatArray","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/RenderGeometry","../../webgl-engine/lib/VertexAttribute","../../webgl-engine/materials/lineStippleUtils","../../webgl-engine/materials/PatternMaterial","../../webgl-engine/materials/RibbonLineMaterial"],(function(e,t,i,n,r,o,a,s,l,c,u,p,h,d,y,g,_,m,f,b,S,x,v,C,A,D,O,M){"use strict";const P=["polyline","polygon","extent"];let G=function(e){function h(t,i,n,r){var o;return(o=e.call(this,t,i,n,r)||this)._needsUV=!1,o._hasOutline=!1,o}t._inheritsLoose(h,e);var G=h.prototype;return G.doLoad=function(){var e=t._asyncToGenerator((function*(){}));function i(){return e.apply(this,arguments)}return i}(),G._ensureMaterials=function(){this._ensureFillMaterial(),this._ensureOutlineMaterial()},G._ensureFillMaterial=function(){if(n.isSome(this._material))return;const e=n.get(this.symbolLayer,"material","color"),t=this._getCombinedOpacityAndColor(e);this._material=_.createMaterial(this.symbolLayer,{color:t,transparent:t[3]<1||this.needsDrivenTransparentPass,polygonOffset:!1,hasVertexColors:!0,writeLinearDepth:!0,hasSlicePlane:this._context.slicePlaneEnabled},{isDraped:this.draped}),this._needsUV=this._material instanceof O.PatternMaterial,this._context.stage.add(this._material)},G._ensureOutlineMaterial=function(){const e=this.symbolLayer.outline;if(n.isSome(this._outlineMaterial)||!this._isValidOutline(e))return;this._hasOutline=!0;const t=t=>{const i=D.getStipplePatternForLinePattern(e.pattern);return new M.RibbonLineMaterial({width:t,color:this._getOutlineColor(),hasPolygonOffset:!0,hasSlicePlane:this._context.slicePlaneEnabled,isClosed:!0,stipplePattern:i,stippleScaleWithLineWidth:!0,cap:y.parseCapType(e.patternCap||"butt")})};this._outlineMaterial=t(r.pt2px(e.size)),this._context.stage.add(this._outlineMaterial)},G._isValidOutline=function(e){return n.isSome(e)&&null!=e.size&&e.size>0&&n.isSome(e.color)&&(n.isNone(e.pattern)||"style"!==e.pattern.type||"none"!==e.pattern.style)},G.destroy=function(){e.prototype.destroy.call(this),this._context.stage.remove(this._material),this._material=null,this._context.stage.remove(this._outlineMaterial),this._outlineMaterial=null},G.createGraphics3DGraphic=function(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,P,this.symbolLayer.type))return null;const i=this._getVertexOpacityAndColor(e.renderingInfo,255),n=this.setGraphicElevationContext(t,new c.ElevationContext);return this.ensureDrapedStatus("on-the-ground"===n.mode),this._ensureMaterials(),this.draped?this._createAsOverlay(t,i):this._createAs3DShape(t,i,n)},G.layerOpacityChanged=function(){if(n.isSome(this._material)){const e=this._material.parameters.color,t=n.get(this.symbolLayer,"material","color"),i=this._getCombinedOpacity(t);this._material.setParameters({color:[e[0],e[1],e[2],i],transparent:i<1||this.needsDrivenTransparentPass})}if(n.isSome(this._outlineMaterial)){const e=this._outlineMaterial.parameters.color;this._outlineMaterial.setParameters({color:[e[0],e[1],e[2],this._getOutlineOpacity()]})}},G.layerElevationInfoChanged=function(e,t,i){const n=this._elevationContext.mode,r=l.elevationModeChangeUpdateType(h.elevationModeChangeTypes,i,n);if(r!==l.SymbolUpdateType.UPDATE)return r;const o=l.needsElevationUpdates2D(n);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>o))},G.slicePlaneEnabledChanged=function(){if(n.isSome(this._material)&&this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),n.isSome(this._outlineMaterial)){const e={hasSlicePlane:this._context.slicePlaneEnabled};this._outlineMaterial.setParameters(e)}return!0},G.physicalBasedRenderingChanged=function(){return!0},G.pixelRatioChanged=function(){return!0},G.skipHighSymbolLodsChanged=function(){return!0},G._createAs3DShape=function(e,t,i){const r=g.geometryAsPolygon(e.geometry);if(n.isNone(r))return null;const o=b.geometryToRenderInfo(r,this._context.elevationProvider,this._context.renderCoordsHelper,i),a=new w(o,t,this._context.layer.uid,e.uid),s=a.renderData.position.length/3;if(this._needsUV&&(a.uvMapSpace=x.newFloatArray(4*s,!0),a.boundingRect=S.newDoubleArray(9*s,!0),m.createMapSpaceUVCoords(a.uvMapSpace,a.boundingRect,a.renderData.position,this._context.renderCoordsHelper)),a.objectAndLayerIdColor=this._context.stage.renderView?.getObjectAndLayerIdColor(a),this._createAs3DShapeFill(a),this._hasOutline&&this._createAs3DShapeOutline(a),this._logGeometryCreationWarnings(a.renderData,r.rings,"rings","FillSymbol3DLayer"),0===a.outGeometries.length)return null;const c=new v.Object3D({geometries:a.outGeometries,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:e.uid}}),u=new p.Graphics3DObject3DGraphicLayer(this,c,a.outGeometries,null,null,_.uvElevationAligner,i);return u.alignedSampledElevation=a.renderData.sampledElevation,u.needsElevationUpdates=l.needsElevationUpdates2D(i.mode),u},G._createAs3DShapeFill=function(e){const t=e.renderData.polygons;for(const{position:i,mapPositions:r,holeIndices:a,index:l,count:c}of t){if(n.isSome(this._context.clippingExtent)&&(s.empty(L),s.expandWithBuffer(L,r),!s.intersectsClippingArea(L,this._context.clippingExtent)))continue;const t=o.earcut(r,a,3);if(0===t.length)continue;const u=g.createColorGeometry({material:n.unwrap(this._material),indices:t,mapPositions:r,attributeData:{position:i,color:e.color,uvMapSpace:this._needsUV?x.floatSubArray(e.uvMapSpace,4*l,4*c):null,boundingRect:this._needsUV?S.doubleSubArray(e.boundingRect,9*l,9*c):null,objectAndLayerIdColor:e.objectAndLayerIdColor}});e.outGeometries.push(u)}},G._createAs3DShapeOutline=function(e){if(!this._hasOutline)return;const t=e.renderData.outlines;for(let i=0;i<t.length;++i){const{mapPositions:r,position:o}=t[i];if(n.isSome(this._context.clippingExtent)&&(s.empty(L),s.expandWithBuffer(L,r),!s.intersectsClippingArea(L,this._context.clippingExtent)))continue;const a=f.createGeometry(n.unwrap(this._outlineMaterial),{overlayInfo:null,removeDuplicateStartEnd:!0,mapPositions:r,attributeData:{position:o}},e.objectAndLayerIdColor),l=a.vertexAttributes.get(A.VertexAttribute.POSITION);l.data===o&&(l.data=S.doubleArrayFrom(o)),e.outGeometries.push(a)}},G._createAsOverlay=function(e,t){const i=g.geometryAsPolygon(e.geometry);if(n.isNone(i))return null;n.unwrap(this._material).renderPriority=this._renderPriority+this._renderPriorityStep/2,n.isSome(this._outlineMaterial)&&(this._outlineMaterial.renderPriority=this._renderPriority);const r=b.geometryToRenderInfoDraped(i,this._context.overlaySR),o=new E(r,t,this._context.layer.uid,e.uid),a=o.renderData.position.length/3;return this._needsUV&&(o.uvMapSpace=x.newFloatArray(4*a,!0),m.createMapSpaceUVCoordsDraped(o.uvMapSpace,o.renderData.position,this._context.overlaySR,this._context.graphicsCoreOwner.view.state.viewingMode)),o.outBoundingBox=s.empty(),o.objectAndLayerIdColor=this._context.stage.renderView?.getObjectAndLayerIdColor(o),this._createAsOverlayFill(o),this._hasOutline&&this._createAsOverlayOutline(o),this._logGeometryCreationWarnings(o.renderData,i.rings,"rings","FillSymbol3DLayer"),0===o.outGeometries.length?null:new u(this,o.outGeometries,o.outBoundingBox,this._context.drapeSourceRenderer)},G._createAsOverlayFill=function(e){const t=e.renderData.polygons;for(const{position:i,holeIndices:r,index:l,count:c}of t){const t=s.empty(L);if(s.expandWithBuffer(t,i),!s.intersectsClippingArea(t,this._context.clippingExtent))continue;const u=o.earcut(i,r,3);if(0===u.length)continue;s.expandWithAABB(e.outBoundingBox,t);const p=g.createColorGeometry({material:n.unwrap(this._material),indices:u,attributeData:{position:i,color:e.color,uvMapSpace:this._needsUV?x.floatSubArray(e.uvMapSpace,4*l,4*c):null,objectAndLayerIdColor:e.objectAndLayerIdColor}}),h=new C.RenderGeometry(p,e);a.set(h.boundingSphere,.5*(t[0]+t[3]),.5*(t[1]+t[4]),0,.5*Math.sqrt((t[3]-t[0])*(t[3]-t[0])+(t[4]-t[1])*(t[4]-t[1]))),e.outGeometries.push(h)}},G._createAsOverlayOutline=function(e){if(!this._hasOutline)return;const t=e.renderData.outlines;for(let i=0;i<t.length;++i){const{position:r}=t[i];if(s.empty(L),s.expandWithBuffer(L,r),!s.intersectsClippingArea(L,this._context.clippingExtent))continue;s.expandWithAABB(e.outBoundingBox,L);const o=f.createGeometry(n.unwrap(this._outlineMaterial),{overlayInfo:{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper},removeDuplicateStartEnd:!0,attributeData:{position:r}},e.objectAndLayerIdColor),l=new C.RenderGeometry(o,e),c=L;a.set(l.boundingSphere,.5*(c[0]+c[3]),.5*(c[1]+c[4]),0,.5*Math.sqrt((c[3]-c[0])*(c[3]-c[0])+(c[4]-c[1])*(c[4]-c[1]))),e.outGeometries.push(l)}},G._getOutlineOpacity=function(){const e=n.get(this.symbolLayer,"outline","color");return(this.draped?1:this._getLayerOpacity())*(n.isSome(e)?e.a:0)},G._getOutlineColor=function(){const e=n.get(this.symbolLayer,"outline","color"),t=this._getOutlineOpacity();return d.mixinColorAndOpacity(n.isSome(e)?i.toUnitRGB(e):null,t)},G.test=function(){return{...e.prototype.test.call(this),createAsOverlay:(e,t)=>this._createAsOverlay(e,t),createAs3DShape:(e,t,i)=>this._createAs3DShape(e,t,i)}},h}(h.Graphics3DSymbolLayer);G.elevationModeChangeTypes={definedChanged:l.SymbolUpdateType.RECREATE,staysOnTheGround:l.SymbolUpdateType.NONE,onTheGroundChanged:l.SymbolUpdateType.RECREATE};const L=s.create();let w=function(e){function i(t,i,n,r){var o;return(o=e.call(this,t,n,r)||this).color=i,o}return t._inheritsLoose(i,e),i}(g.PolygonCreationDataBase),E=function(e){function i(t,i,n,r){var o;return(o=e.call(this,t,n,r)||this).color=i,o}return t._inheritsLoose(i,e),i}(g.PolygonCreationDataBase);e.Graphics3DPolygonFillSymbolLayer=G,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
