/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../Color","../../../../core/maybe","../../../../core/screenUtils","../../../../chunks/earcut","../../../../chunks/mat4f64","../../../../chunks/vec4","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/buffer/BufferView","./elevationAlignmentUtils","./ElevationContext","./Graphics3DDrapedGraphicLayer","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolLayer","./graphicUtils","./lineUtils","./polygonUtils","../support/patternUtils","../support/uvUtils","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/RenderGeometry","../../webgl-engine/materials/lineStippleUtils","../../webgl-engine/materials/NativeLineMaterial","../../webgl-engine/materials/PatternMaterial","../../webgl-engine/materials/RibbonLineMaterial"],(function(e,t,i,n,a,r,o,s,l,u,c,p,h,d,m,y,f,g,_,b,M,S,v,x,D,E){"use strict";const O=["polyline","polygon","extent"];let A=function(e){function m(t,i,n,a){var r;return(r=e.call(this,t,i,n,a)||this)._needsUV=!1,r._hasOutline=!1,r}t._inheritsLoose(m,e);var A=m.prototype;return A.doLoad=function(){var e=t._asyncToGenerator((function*(){}));function i(){return e.apply(this,arguments)}return i}(),A.ensureMaterials=function(){this.ensureFillMaterial(),this.ensureOutlineMaterial()},A.ensureFillMaterial=function(){if(n.isSome(this._material))return;const e=n.get(this.symbolLayer,"material","color"),t=this._getCombinedOpacityAndColor(e);this._material=_.createMaterial(this.symbolLayer,{color:t,transparent:t[3]<1||this.needsDrivenTransparentPass,polygonOffset:!1,vertexColors:!0,writeLinearDepth:!0,slicePlaneEnabled:this._context.slicePlaneEnabled},{isDraped:this.draped}),this._needsUV=this._material instanceof D.PatternMaterial,this._context.stage.add(this._material)},A.ensureOutlineMaterial=function(){const e=this.symbolLayer.outline;if(n.isSome(this._outlineMaterial)||!this._isValidOutline(e))return;this._hasOutline=!0;const t=t=>{const r=n.mapOr(e.stipplePattern,v.scaleStipplePattern(v.getStipplePatternForLinePattern(e.pattern),a.pt2px(e.size)),(e=>v.createStipplePattern(e.map(a.pt2px)))),o=e.stippleOffColor?i.toUnitRGBA(e.stippleOffColor):null;return t>1.5?new E.RibbonLineMaterial({width:t,color:this._getOutlineColor(),polygonOffset:!0,slicePlaneEnabled:this._context.slicePlaneEnabled,isClosed:!0,stipplePattern:r,stippleIntegerRepeats:!0,stippleOffColor:o,cap:e.patternCap||"butt"}):new x.NativeLineMaterial({color:this._getOutlineColor(),slicePlaneEnabled:this._context.slicePlaneEnabled,width:t,stipplePattern:r,stippleIntegerRepeats:!0,stippleOffColor:o})};this._outlineMaterial=t(a.pt2px(e.size)),this._context.stage.add(this._outlineMaterial)},A._isValidOutline=function(e){return n.isSome(e)&&e.size&&e.size>0&&n.isSome(e.color)&&"none"!==e.pattern},A.destroy=function(){e.prototype.destroy.call(this),this._context.stage.remove(this._material),this._material=null,this._context.stage.remove(this._outlineMaterial),this._outlineMaterial=null},A.createGraphics3DGraphic=function(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,O,this.symbolLayer.type))return null;const i=this._getVertexOpacityAndColor(e.renderingInfo,255),n=this.setGraphicElevationContext(t,new p.ElevationContext);return this.ensureDrapedStatus("on-the-ground"===n.mode),this.ensureMaterials(),this.draped?this._createAsOverlay(t,i):this._createAs3DShape(t,i,n)},A.layerOpacityChanged=function(){if(n.isSome(this._material)){const e=this._material.params.color,t=n.get(this.symbolLayer,"material","color"),i=this._getCombinedOpacity(t);this._material.setParameterValues({color:[e[0],e[1],e[2],i],transparent:i<1||this.needsDrivenTransparentPass})}if(n.isSome(this._outlineMaterial)){const e=this._outlineMaterial.params.color;this._outlineMaterial.setParameterValues({color:[e[0],e[1],e[2],this._getOutlineOpacity()]})}return!0},A.layerElevationInfoChanged=function(e,t,i){const n=this._elevationContext.mode,a=c.elevationModeChangeUpdateType(m.elevationModeChangeTypes,i,n);if(a!==c.SymbolUpdateType.UPDATE)return a;const r=c.needsElevationUpdates2D(n);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>r))},A.slicePlaneEnabledChanged=function(){if(n.isSome(this._material)&&this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),n.isSome(this._outlineMaterial)){const e={slicePlaneEnabled:this._context.slicePlaneEnabled};this._outlineMaterial.setParameterValues(e)}return!0},A.physicalBasedRenderingChanged=function(){return!0},A.pixelRatioChanged=function(){return!0},A._createAs3DShape=function(e,t,i){const a=g.geometryAsPolygon(e.geometry);if(n.isNone(a))return null;P.renderData=g.geometryToRenderInfo(a,this._context.elevationProvider,this._context.renderCoordsHelper,i),P.color=t;const r=P.renderData.position.length/3;if(this._needsUV&&(P.uvMapSpace=new Float32Array(4*r),P.boundingRect=new Float64Array(9*r)),P.outNum=0,P.outGeometries=[],P.outTransforms=[],P.outMaterials=[],this._createAs3DShapeFill(P),this._hasOutline&&this._createAs3DShapeOutline(P),this._logGeometryCreationWarnings(P.renderData,a.rings,"rings","FillSymbol3DLayer"),0===P.outNum)return null;this._needsUV&&b.createMapSpaceUVCoords(u.BufferViewVec4f.fromTypedArray(P.uvMapSpace),u.BufferViewVec3f64.fromTypedArray(P.renderData.position),this._context.renderCoordsHelper,u.BufferViewMat3f64.fromTypedArray(P.boundingRect));const o=new M.Object3D({geometries:P.outGeometries,materials:P.outMaterials,transformations:P.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:e.uid}}),s=_.uvElevationAligner,l=new d.Graphics3DObject3DGraphicLayer(this,o,P.outGeometries,null,null,s,i);return l.alignedSampledElevation=P.renderData.sampledElevation,l.needsElevationUpdates=c.needsElevationUpdates2D(i.mode),l},A._createAs3DShapeFill=function(e){const t=e.renderData.polygons;for(const{position:i,mapPosition:a,holeIndices:s,index:u,count:c}of t){if(n.isSome(this._context.clippingExtent)&&(l.empty(C),l.expandWithBuffer(C,a),!l.intersectsClippingArea(C,this._context.clippingExtent)))continue;const t=r.earcut(a,s,3);if(0===t.length)continue;const p=new Uint32Array(t),h=g.createColorGeometry({indices:p,attributeData:{position:i,color:e.color,mapPosition:a,uvMapSpace:this._needsUV?new Float32Array(e.uvMapSpace.buffer,4*u*e.uvMapSpace.BYTES_PER_ELEMENT,4*c):null,boundingRect:this._needsUV?new Float64Array(e.boundingRect.buffer,9*u*e.boundingRect.BYTES_PER_ELEMENT,9*c):null}});e.outGeometries.push(h),e.outMaterials.push(n.unwrap(this._material)),e.outTransforms.push(o.IDENTITY),e.outNum++}},A._createAs3DShapeOutline=function(e){if(!this._hasOutline)return;const t=e.renderData.outlines,i=this._outlineMaterial instanceof x.NativeLineMaterial;for(let a=0;a<t.length;++a){const{mapPosition:r,position:s}=t[a];if(n.isSome(this._context.clippingExtent)&&(l.empty(C),l.expandWithBuffer(C,r),!l.intersectsClippingArea(C,this._context.clippingExtent)))continue;const u=f.createGeometry({removeDuplicateStartEnd:i?0:1,attributeData:{position:s,mapPosition:r}}),c=u.vertexAttributes.get("position");c.data===s&&(c.data=new Float64Array(s)),e.outGeometries.push(u),e.outMaterials.push(n.unwrap(this._outlineMaterial)),e.outTransforms.push(o.IDENTITY),e.outNum++}},A._createAsOverlay=function(e,t){const i=g.geometryAsPolygon(e.geometry);if(n.isNone(i))return null;n.unwrap(this._material).renderPriority=this._renderPriority+this._renderPriorityStep/2,n.isSome(this._outlineMaterial)&&(this._outlineMaterial.renderPriority=this._renderPriority),G.renderData=g.geometryToRenderInfoDraped(i,this._context.overlaySR),G.color=t;const a=G.renderData.position.length/3;return this._needsUV&&(G.uvMapSpace=new Float32Array(4*a)),G.outNum=0,G.outGeometries=[],G.outBoundingBox=l.empty(),G.layerUid=this._context.layer.uid,G.graphicsUid=e.uid,this._createAsOverlayFill(G),this._hasOutline&&this._createAsOverlayOutline(G),this._logGeometryCreationWarnings(G.renderData,i.rings,"rings","FillSymbol3DLayer"),0===G.outNum?null:(this._needsUV&&b.createMapSpaceUVCoordsDraped(u.BufferViewVec4f.fromTypedArray(G.uvMapSpace),u.BufferViewVec3f64.fromTypedArray(G.renderData.position),this._context.overlaySR),G.outNum>0?new h(this,G.outGeometries,G.outBoundingBox):null)},A._createAsOverlayFill=function(e){const t=e.renderData.polygons;for(const{position:i,holeIndices:a,index:o,count:u}of t){if(l.empty(C),l.expandWithBuffer(C,i),!l.intersectsClippingArea(C,this._context.clippingExtent))continue;const t=r.earcut(i,a,3);if(0===t.length)continue;l.expandWithAABB(e.outBoundingBox,C);const c=new Uint32Array(t),p=g.createColorGeometry({indices:c,attributeData:{position:i,color:e.color,uvMapSpace:this._needsUV?new Float32Array(e.uvMapSpace.buffer,4*o*e.uvMapSpace.BYTES_PER_ELEMENT,4*u):null}}),h=new S.RenderGeometry(p,n.unwrap(this._material),e.layerUid,e.graphicsUid),d=C;s.set(h.boundingSphere,.5*(d[0]+d[3]),.5*(d[1]+d[4]),0,.5*Math.sqrt((d[3]-d[0])*(d[3]-d[0])+(d[4]-d[1])*(d[4]-d[1]))),e.outGeometries.push(h),e.outNum++}},A._createAsOverlayOutline=function(e){if(!this._hasOutline)return;const t=e.renderData.outlines;for(let i=0;i<t.length;++i){const{position:a}=t[i];if(l.empty(C),l.expandWithBuffer(C,a),!l.intersectsClippingArea(C,this._context.clippingExtent))continue;l.expandWithAABB(e.outBoundingBox,C);const r=this._outlineMaterial instanceof x.NativeLineMaterial,o=f.createGeometry({removeDuplicateStartEnd:r?0:1,attributeData:{position:a}}),u=new S.RenderGeometry(o,n.unwrap(this._outlineMaterial),e.layerUid,e.graphicsUid),c=C;s.set(u.boundingSphere,.5*(c[0]+c[3]),.5*(c[1]+c[4]),0,.5*Math.sqrt((c[3]-c[0])*(c[3]-c[0])+(c[4]-c[1])*(c[4]-c[1]))),e.outGeometries.push(u),e.outNum++}},A._getOutlineOpacity=function(){const e=n.get(this.symbolLayer,"outline","color");return(this.draped?1:this._getLayerOpacity())*(n.isSome(e)?e.a:0)},A._getOutlineColor=function(){const e=n.get(this.symbolLayer,"outline","color"),t=this._getOutlineOpacity();return y.mixinColorAndOpacity(n.isSome(e)?i.toUnitRGB(e):null,t)},t._createClass(m,[{key:"test",get:function(){return{createAsOverlay:(e,t)=>this._createAsOverlay(e,t),createAs3DShape:(e,t,i)=>this._createAs3DShape(e,t,i)}}}]),m}(m.Graphics3DSymbolLayer);A.elevationModeChangeTypes={definedChanged:c.SymbolUpdateType.RECREATE,staysOnTheGround:c.SymbolUpdateType.NONE,onTheGroundChanged:c.SymbolUpdateType.RECREATE};const C=l.create(),P={renderData:null,color:null,uvMapSpace:null,boundingRect:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},G={renderData:null,color:null,uvMapSpace:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null};e.Graphics3DPolygonFillSymbolLayer=A,e.default=A,Object.defineProperty(e,"__esModule",{value:!0})}));
