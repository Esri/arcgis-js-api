/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../Color","../../../../core/screenUtils","../../../../chunks/mat4f64","../../../../core/libs/earcut/earcut","../../support/buffer/BufferView","../../../../geometry/support/aaBoundingBox","../../webgl-engine/lib/Util","../../webgl-engine/lib/Object3D","./graphicUtils","./elevationAlignmentUtils","../../webgl-engine/materials/PatternMaterial","../support/uvUtils","./ElevationAligners","./ElevationContext","./Graphics3DObject3DGraphicLayer","../../webgl-engine/lib/Geometry","./Graphics3DSymbolLayer","../../webgl-engine/materials/RibbonLineMaterial","../../webgl-engine/materials/lineStippleUtils","./polygonUtils","./Graphics3DDrapedGraphicLayer","../../webgl-engine/lib/RenderGeometry","./lineUtils","../../webgl-engine/materials/NativeLineMaterial","../support/patternUtils"],(function(e,t,i,n,a,r,o,l,s,u,c,p,d,h,y,m,f,_,g,b,E,v,M,S,A,x,D,w){"use strict";let O=function(e){function b(t,i,n,a){var r;return(r=e.call(this,t,i,n,a)||this)._needsUV=!1,r._hasOutline=!1,r}t._inheritsLoose(b,e);var O=b.prototype;return O.doLoad=async function(){},O.ensureMaterials=function(){this.ensureFillMaterial(),this.ensureOutlineMaterial()},O.ensureFillMaterial=function(){if(i.isSome(this._material))return;const e=i.get(this.symbolLayer,"material","color"),t=this._getCombinedOpacityAndColor(e);this._material=w.createMaterial(this.symbolLayer,{color:t,transparent:t[3]<1||this.needsDrivenTransparentPass,polygonOffset:!1,vertexColors:!0,writeLinearDepth:!0,slicePlaneEnabled:this._context.slicePlaneEnabled},{isDraped:this.draped,idHint:this._getIdHint()}),this._needsUV=this._material instanceof h.PatternMaterial,this._context.stage.add(3,this._material)},O.ensureOutlineMaterial=function(){const e=this.symbolLayer.outline;if(i.isSome(this._outlineMaterial)||!this._isValidOutline(e))return;this._hasOutline=!0;this._outlineMaterial=(t=>{const i=e.stipplePattern?v.createStipplePattern(e.stipplePattern.map(a.pt2px)):null,r=e.stippleOffColor?n.toUnitRGBA(e.stippleOffColor):null;return t>1.5?new E.RibbonLineMaterial({width:t,color:this._getOutlineColor(),polygonOffset:!0,slicePlaneEnabled:this._context.slicePlaneEnabled,isClosed:!0,stipplePattern:i,stippleIntegerRepeats:!0,stippleOffColor:r},this._getIdHint("_outline_ribbonlinemat")):new D.NativeLineMaterial({color:this._getOutlineColor(),slicePlaneEnabled:this._context.slicePlaneEnabled,width:t,stipplePattern:i,stippleIntegerRepeats:!0,stippleOffColor:r},this._getIdHint("_outline_nativelinemat"))})(a.pt2px(e.size)),this._context.stage.add(3,this._outlineMaterial)},O._isValidOutline=function(e){return i.isSome(e)&&e.size&&e.size>0&&i.isSome(e.color)},O.destroy=function(){e.prototype.destroy.call(this),i.isSome(this._material)&&(this._context.stage.remove(3,this._material.id),this._material=null),i.isSome(this._outlineMaterial)&&(this._context.stage.remove(3,this._outlineMaterial.id),this._outlineMaterial=null)},O.createGraphics3DGraphic=function(e){const t=e.graphic;if(!this._validateGeometryType(t.geometry,b.validGeometryTypes,this.symbolLayer.type))return null;if(!this._validateGeometry(t.geometry))return null;const i="graphic"+t.uid,n=this._getVertexOpacityAndColor(e.renderingInfo,Uint8Array,255),a=this.setGraphicElevationContext(t,new f.ElevationContext);return this.ensureDrapedStatus("on-the-ground"===a.mode),this.ensureMaterials(),this.draped?this._createAsOverlay(t,n,i):this._createAs3DShape(t,n,a,i)},O.layerOpacityChanged=function(){if(i.isSome(this._material)){const e=this._material.params.color,t=i.get(this.symbolLayer,"material","color"),n=this._getCombinedOpacity(t);this._material.setParameterValues({color:[e[0],e[1],e[2],n],transparent:n<1||this.needsDrivenTransparentPass})}if(i.isSome(this._outlineMaterial)){const e=this._outlineMaterial.params.color;this._outlineMaterial.setParameterValues({color:[e[0],e[1],e[2],this._getOutlineOpacity()]})}return!0},O.layerElevationInfoChanged=function(e,t,i){const n=this._elevationContext.mode,a=d.elevationModeChangeUpdateType(b.elevationModeChangeTypes,i,n);if(a!==d.SymbolUpdateType.UPDATE)return a;const r=d.needsElevationUpdates2D(n);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>r))},O.slicePlaneEnabledChanged=function(){if(i.isSome(this._material)&&this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),i.isSome(this._outlineMaterial)){const e={slicePlaneEnabled:this._context.slicePlaneEnabled};this._outlineMaterial.setParameterValues(e)}return!0},O.physicalBasedRenderingChanged=function(){return!0},O.pixelRatioChanged=function(){return!0},O._createAs3DShape=function(e,t,n,a){const r=M.geometryAsPolygon(e.geometry);if(i.isNone(r))return null;T.renderData=M.geometryToRenderInfo(r,this._context.elevationProvider,this._context.renderCoordsHelper,n),T.idHint=a,T.color=t;const o=T.renderData.position.length/3;if(this._needsUV&&(T.uvMapSpace=new Float32Array(4*o),T.bound1=new Float64Array(3*o),T.bound2=new Float64Array(3*o),T.bound3=new Float64Array(3*o)),T.outNum=0,T.outGeometries=[],T.outTransforms=[],T.outMaterials=[],this._createAs3DShapeFill(T),this._hasOutline&&this._createAs3DShapeOutline(T),this._logGeometryCreationWarnings(T.renderData,r.rings,"rings","FillSymbol3DLayer"),0===T.outNum)return null;this._needsUV&&y.createMapSpaceUVCoords(l.BufferViewVec4f.fromTypedArray(T.uvMapSpace),l.BufferViewVec3f64.fromTypedArray(T.renderData.position),this._context.layerView.view.renderCoordsHelper,l.BufferViewVec3f64.fromTypedArray(T.bound1),l.BufferViewVec3f64.fromTypedArray(T.bound2),l.BufferViewVec3f64.fromTypedArray(T.bound3));const s=new c({geometries:T.outGeometries,materials:T.outMaterials,transformations:T.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:e.uid},idHint:a}),u=m.uvElevationAligner,p=new _(this,s,T.outGeometries,null,null,u,n);return p.alignedSampledElevation=T.renderData.sampledElevation,p.needsElevationUpdates=d.needsElevationUpdates2D(n.mode),p},O._createAs3DShapeFill=function(e){const t=e.renderData.polygons;for(const{position:n,mapPosition:a,holeIndices:l,index:u,count:c}of t){if(i.isSome(this._context.clippingExtent)&&(s.empty(U),s.expandWithBuffer(U,a),!s.intersectsClippingArea(U,this._context.clippingExtent)))continue;const t=o.earcut(a,l,3);if(0===t.length)continue;const p=new Uint32Array(t),d=M.createColorGeometryData({indices:p,attributeData:{position:n,color:e.color,mapPosition:a,uvMapSpace:this._needsUV?new Float32Array(e.uvMapSpace.buffer,4*u*e.uvMapSpace.BYTES_PER_ELEMENT,4*c):null,bound1:this._needsUV?new Float64Array(e.bound1.buffer,3*u*e.bound1.BYTES_PER_ELEMENT,3*c):null,bound2:this._needsUV?new Float64Array(e.bound2.buffer,3*u*e.bound2.BYTES_PER_ELEMENT,3*c):null,bound3:this._needsUV?new Float64Array(e.bound3.buffer,3*u*e.bound3.BYTES_PER_ELEMENT,3*c):null}}),h=new g(d,e.idHint);e.outGeometries.push(h),e.outMaterials.push(i.unwrap(this._material)),e.outTransforms.push(r.IDENTITY),e.outNum++}},O._createAs3DShapeOutline=function(e){if(!this._hasOutline)return;const t=e.renderData.outlines,n=this._outlineMaterial instanceof D.NativeLineMaterial;for(let a=0;a<t.length;++a){const{mapPosition:o,position:l}=t[a];if(i.isSome(this._context.clippingExtent)&&(s.empty(U),s.expandWithBuffer(U,o),!s.intersectsClippingArea(U,this._context.clippingExtent)))continue;const c=x.createGeometryData({removeDuplicateStartEnd:n?0:1,attributeData:{position:l,mapPosition:o}}),p=c.vertexAttributes[u.VertexAttrConstants.POSITION];p.data===l&&(p.data=new Float64Array(l));const d=new g(c,e.idHint+"outline"+a);e.outGeometries.push(d),e.outMaterials.push(i.unwrap(this._outlineMaterial)),e.outTransforms.push(r.IDENTITY),e.outNum++}},O._createAsOverlay=function(e,t,n){const a=M.geometryAsPolygon(e.geometry);if(i.isNone(a))return null;i.unwrap(this._material).renderPriority=this._renderPriority+this._renderPriorityStep/2,i.isSome(this._outlineMaterial)&&(this._outlineMaterial.renderPriority=this._renderPriority),P.renderData=M.geometryToRenderInfoDraped(a,this._context.overlaySR),P.idHint=n,P.color=t;const r=P.renderData.position.length/3;return this._needsUV&&(P.uvMapSpace=new Float32Array(4*r)),P.outNum=0,P.outGeometries=[],P.outBoundingBox=s.empty(),P.layerUid=this._context.layer.uid,P.graphicsUid=e.uid,this._createAsOverlayFill(P),this._hasOutline&&this._createAsOverlayOutline(P),this._logGeometryCreationWarnings(P.renderData,a.rings,"rings","FillSymbol3DLayer"),0===P.outNum?null:(this._needsUV&&y.createMapSpaceUVCoordsDraped(l.BufferViewVec4f.fromTypedArray(P.uvMapSpace),l.BufferViewVec3f64.fromTypedArray(P.renderData.position),this._context.overlaySR),P.outNum>0?new S(this,P.outGeometries,P.outBoundingBox):null)},O._createAsOverlayFill=function(e){const t=e.renderData.polygons;for(const{position:n,holeIndices:a,index:r,count:l}of t){if(s.empty(U),s.expandWithBuffer(U,n),!s.intersectsClippingArea(U,this._context.clippingExtent))continue;const t=o.earcut(n,a,3);if(0===t.length)continue;s.expandWithAABB(e.outBoundingBox,U);const u=new Uint32Array(t),c=M.createColorGeometryData({indices:u,attributeData:{position:n,color:e.color,uvMapSpace:this._needsUV?new Float32Array(e.uvMapSpace.buffer,4*r*e.uvMapSpace.BYTES_PER_ELEMENT,4*l):null}}),p=new A(c);p.data.layerUid=e.layerUid,p.data.graphicUid=e.graphicsUid,p.material=i.unwrap(this._material);const d=U;p.center=[.5*(d[0]+d[3]),.5*(d[1]+d[4]),0],p.bsRadius=.5*Math.sqrt((d[3]-d[0])*(d[3]-d[0])+(d[4]-d[1])*(d[4]-d[1])),e.outGeometries.push(p),e.outNum++}},O._createAsOverlayOutline=function(e){if(!this._hasOutline)return;const t=e.renderData.outlines;for(let n=0;n<t.length;++n){const{position:a}=t[n];if(s.empty(U),s.expandWithBuffer(U,a),!s.intersectsClippingArea(U,this._context.clippingExtent))continue;s.expandWithAABB(e.outBoundingBox,U);const r=this._outlineMaterial instanceof D.NativeLineMaterial,o=x.createGeometryData({removeDuplicateStartEnd:r?0:1,attributeData:{position:a}}),l=new A(o);l.data.layerUid=e.layerUid,l.data.graphicUid=e.graphicsUid,l.material=i.unwrap(this._outlineMaterial);const u=U;l.center=[.5*(u[0]+u[3]),.5*(u[1]+u[4]),0],l.bsRadius=.5*Math.sqrt((u[3]-u[0])*(u[3]-u[0])+(u[4]-u[1])*(u[4]-u[1])),e.outGeometries.push(l),e.outNum++}},O._getOutlineOpacity=function(){const e=i.get(this.symbolLayer,"outline","color");return(this.draped?1:this._getLayerOpacity())*(i.isSome(e)?e.a:0)},O._getOutlineColor=function(){const e=i.get(this.symbolLayer,"outline","color"),t=this._getOutlineOpacity();return p.mixinColorAndOpacity(i.isSome(e)?n.toUnitRGB(e):null,t)},t._createClass(b,[{key:"test",get:function(){return{createAsOverlay:(e,t,i)=>this._createAsOverlay(e,t,i),createAs3DShape:(e,t,i,n)=>this._createAs3DShape(e,t,i,n)}}}]),b}(b.Graphics3DSymbolLayer);O.validGeometryTypes=["polyline","polygon","extent"],O.elevationModeChangeTypes={definedChanged:d.SymbolUpdateType.RECREATE,staysOnTheGround:d.SymbolUpdateType.NONE,onTheGroundChanged:d.SymbolUpdateType.RECREATE};const U=s.create(),T={idHint:null,renderData:null,color:null,uvMapSpace:null,bound1:null,bound2:null,bound3:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},P={idHint:null,renderData:null,color:null,uvMapSpace:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null};e.Graphics3DPolygonFillSymbolLayer=O,e.default=O,Object.defineProperty(e,"__esModule",{value:!0})}));
