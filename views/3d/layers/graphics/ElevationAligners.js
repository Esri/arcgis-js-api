/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../core/maybe","../../../../geometry/Point","../../../../chunks/vec3f64","../../../../chunks/vec3","../../../../chunks/mat4","../../../../geometry/projection","../../../../chunks/mat4f64","../../support/buffer/BufferView","../../webgl-engine/lib/Util","../../support/debugFlags","./graphicUtils","./elevationAlignmentUtils","../support/uvUtils"],(function(e,t,a,n,r,o,s,i,l,c,f,u,d,m){"use strict";const p=c.VertexAttrConstants;function A(e,t,a,n){const r=e.stageObject,o=a.spatialReference;T.spatialReference=o;const s=r.geometryRecords,i=s.length,l="absolute-height"!==t.mode;let c=0;for(let e=0;e<i;e++){const o=s[e].geometry,i=s[e].getShaderTransformation();v[0]=i[12],v[1]=i[13],v[2]=i[14],o.invalidateBoundingInfo();const u=o.data.getVertexAttr(),m=u[p.POSITION],A=m.data,g=u.mapPos.data,y=m.size,V=A.length/y;let S=0,O=0,M=!1,P=0;for(let e=0;e<V;e++){T.x=g[O++],T.y=g[O++],T.z=g[O++],h[0]=A[S],h[1]=A[S+1],h[2]=A[S+2];const e=d.evaluateElevationAlignmentAtPoint(T,a,t,n,l?I:null);if(l&&(P+=I.sampledElevation),b[0]=A[S]+v[0],b[1]=A[S+1]+v[1],b[2]=A[S+2]+v[2],n.setAltitude(e,b),A[S]=b[0]-v[0],A[S+1]=b[1]-v[1],A[S+2]=b[2]-v[2],f.TESTS_DISABLE_UPDATE_THRESHOLDS)M=!0;else{const e=E/n.unitInMeters;(Math.abs(h[0]-A[S])>=e||Math.abs(h[1]-A[S+1])>=e||Math.abs(h[2]-A[S+2])>=e)&&(M=!0)}S+=y}c+=P/V,M&&r.geometryVertexAttrsUpdated(e)}return c/i}const g=i.create();let E=.01;const T=new a,b=n.create(),v=n.create(),h=n.create(),y=i.create(),V=n.create(),I={verticalDistanceToGround:0,sampledElevation:0};e.iterativeUpdatesEnabled=!0,e.perLodInstanceElevationAligner=function(e,a,n,o){const i=e.graphics3DSymbolLayer.lodRenderer;if(t.isNone(i))return 0;const l=a.centerPointInElevationSR;let c=0,u=0;const m="absolute-height"!==a.mode;c=d.evaluateElevationAlignmentAtPoint(l,n,a,o,m?I:null),m&&(u=I.sampledElevation);const p=i.instanceData,A=e.instanceIndex,g=y;p.getGlobalTransform(A,g);const T=r.set(V,g[12],g[13],g[14]);f.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES?(b[0]=l.x,b[1]=l.y,b[2]=c,s.computeLinearTransformation(l.spatialReference,b,g,o.spatialReference)&&p.setGlobalTransform(A,g)):o.setAltitudeOfTransformation(c,g);const v=E/o.unitInMeters;return(Math.abs(g[12]-T[0])>=v||Math.abs(g[13]-T[1])>=v||Math.abs(g[14]-T[2])>=v)&&p.setGlobalTransform(A,g),u},e.perObjectElevationAligner=function(e,t,a,n){const i=e.stageObject,l=t.centerPointInElevationSR;let c=0,m=0;if(i.metadata.usesVerticalDistanceToGround)c=d.evaluateElevationAlignmentAtPoint(l,a,t,n,I),u.updateVertexAttributeAuxpos1w(i,I.verticalDistanceToGround),m=I.sampledElevation;else{const e="absolute-height"!==t.mode;c=d.evaluateElevationAlignmentAtPoint(l,a,t,n,e?I:null),e&&(m=I.sampledElevation)}const p=o.copy(g,i.objectTransformation),A=r.set(V,p[12],p[13],p[14]);f.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES?(b[0]=l.x,b[1]=l.y,b[2]=c,s.computeLinearTransformation(l.spatialReference,b,p,n.spatialReference)&&(i.objectTransformation=p)):n.setAltitudeOfTransformation(c,p);const T=E/n.unitInMeters;return(Math.abs(p[12]-A[0])>=T||Math.abs(p[13]-A[1])>=T||Math.abs(p[14]-A[2])>=T)&&(i.objectTransformation=p),m},e.perVertexElevationAligner=A,e.updateThresholdInMeters=E,e.uvElevationAligner=function(e,t,a,n){const r=A(e,t,a,n),o=e.stageObject.geometryRecords;for(let e=0;e<o.length;e++)if(m.requiresUVUpdates(o[e])){const t=o[e].geometry.data.getVertexAttr(),a=t[p.POSITION].data,r=t[p.BOUND1].data,s=t[p.BOUND2].data,i=t[p.BOUND3].data,c=t[p.UVMAPSPACE].data;m.createMapSpaceUVCoords(l.BufferViewVec4f.fromTypedArray(c),l.BufferViewVec3f64.fromTypedArray(a),n,l.BufferViewVec3f64.fromTypedArray(r),l.BufferViewVec3f64.fromTypedArray(s),l.BufferViewVec3f64.fromTypedArray(i))}return r},Object.defineProperty(e,"__esModule",{value:!0})}));
