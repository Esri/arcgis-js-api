/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/has","../../../../core/maybe","../../../../core/Logger","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/decorators/subclass","../../../../core/urlUtils","../../../../core/uuid","../../../../portal/support/resourceExtension","../../../../core/Accessor","../../../../core/Handles","../../../support/Scheduler","../../../support/layerViewUtils"],(function(e,i,t,a,s,r,l,n,c,h,o,u,p,y,d){"use strict";let b=function(i){function t(){var e;return(e=i.apply(this,arguments)||this)._scaleRangeActive=!1,e.layerScaleRangeVisibilityQuery=!1,e.handles=new p,e.layerView=null,e.layer=null,e.queryGraphicUIDsInExtent=null,e.extent=null,e.graphicsCore=null,e.basemapTerrain=null,e.layerScaleEnabled=!0,e.suspended=!1,e.updating=!0,e}e._inheritsLoose(t,i);var s=t.prototype;return s.setup=function(e,i,t,a,s){this.layerView=e,this.layer=i,this.queryGraphicUIDsInExtent=t,this.graphicsCore=a,this.basemapTerrain=s,this.updateScaleRangeActive();const r=this.layerView.view.resourceController.scheduler;this.handles.add(r.registerTask(y.Task.SCALE_VISIBILITY,(()=>this.update()),(()=>this.needsUpdate())))},s.destroy=function(){this.handles.destroy(),this.handles=null,this.layerView=null,this.extent=null,this.queryGraphicUIDsInExtent=null,this.graphicsCore=null},s.needsUpdate=function(){return!(!this.layerView.view.basemapTerrain||!this.updating)},s._setDirty=function(){this.updating||this._set("updating",!0)},s.setExtent=function(e){this.extent=e,this._setDirty()},s.scaleRangeActive=function(){return this._scaleRangeActive},s.updateScaleRangeActive=function(){const e=this.layer;let i=this.layerScaleEnabled&&g(e.minScale,e.maxScale);e.labelingInfo&&!i&&(i=e.labelingInfo.some((e=>e&&g(e.minScale,e.maxScale))));const t=this._scaleRangeActive!==i;return this._scaleRangeActive=i,i&&!this.handles.has(S)&&this.basemapTerrain?(this.handles.add(this.basemapTerrain.on("scale-change",(e=>this.scaleUpdateHandler(e))),S),this.layerScaleEnabled&&this.handles.add(this.basemapTerrain.on("tiles-visibility-changed",(()=>this._setDirty())),S)):!i&&this.handles.has(S)&&this.handles.remove(S),t},s.update=function(){const e=this.layerView.view.basemapTerrain;this.extent&&e&&e.ready&&this._scaleRangeActive&&this.layerScaleEnabled?this.layerScaleRangeVisibilityQuery||(this.layerScaleRangeVisibilityQuery=!0,e.queryVisibleScaleRange(this.extent,this.layer.minScale,this.layer.maxScale,(e=>this.finishUpdate(e)))):this.finishUpdate(!0)},s.finishUpdate=function(e){this.layerScaleRangeVisibilityQuery=!1,this._set("suspended",!e),this._set("updating",!1)},s.visibleAtLayerScale=function(e){return!this.layerScaleEnabled||d.scaleBoundsPredicate(e,this.layer.minScale||0,this.layer.maxScale||0)},s.visibleAtLabelScale=function(e,i){return d.scaleBoundsPredicate(e,i.minScale||0,i.maxScale||0)},s.graphicScale=function(e){let i;if(a.isSome(e.centroid)?i=e.centroid:a.isSome(e.graphic.geometry)&&"point"===e.graphic.geometry.type&&(i=e.graphic.geometry),i){return this.layerView.view.basemapTerrain?this.layerView.view.basemapTerrain.getScale(i):1}return null},s.graphicVisible=function(e){if(!this.layerScaleEnabled)return!0;const i=this.graphicScale(e);return this.visibleAtLayerScale(i)},s.updateVisibility=function(e){if(this._scaleRangeActive){const i=this.graphicVisible(e);return e.setVisibilityFlag(1,i,0)}return!1},s.updateGraphicLabelScaleVisibility=function(e){if(!this._scaleRangeActive)return!1;if(!e.labelGraphics||0===e.labelGraphics.length)return!1;const i=this.graphicScale(e),t=this.updateLabelScaleVisibility(e,i);return t&&(this.layerView.view.deconflictor.setDirty(),this.layerView.view.labeler.setDirty()),t},s.updateLabelScaleVisibility=function(e,i){if(!e.labelGraphics||0===e.labelGraphics.length)return!1;const t=e.labelGraphics[0]._labelClass;if(t&&null!=t.minScale&&null!=t.maxScale){const a=this.visibleAtLabelScale(i,t);if(e.setVisibilityFlag(1,a,1))return!0}return!1},s.scaleUpdateHandler=function(e){if(this._setDirty(),this.layerView.suspended)return;const i=e.extent,t=e.scale,s=this.visibleAtLayerScale(t);let r=!1;this.queryGraphicUIDsInExtent(i,e.spatialReference,(e=>{const l=this.graphicsCore.getGraphics3DGraphicById(e);if(!l)return;const n=l.centroid;a.isSome(n)&&(i[0]>n.x||i[1]>n.y||i[2]<n.x||i[3]<n.y)||(l.setVisibilityFlag(1,s,0)&&(r=!0),this.updateLabelScaleVisibility(l,t)&&(r=!0))})),r&&(this.layerView.view.deconflictor.setDirty(),this.layerView.view.labeler.setDirty())},s.layerMinMaxScaleChangeHandler=function(){this.updateScaleRangeActive()&&!this._scaleRangeActive?this.graphicsCore.modifyGraphics3DGraphicVisibilities((e=>e.clearVisibilityFlag(1))):this._scaleRangeActive&&this.graphicsCore.updateAllGraphicsVisibility(),this._setDirty()},t}(u);function g(e,i){return e>0||i>0}i.__decorate([l.property({constructOnly:!0})],b.prototype,"layerScaleEnabled",void 0),i.__decorate([l.property({readOnly:!0})],b.prototype,"suspended",void 0),i.__decorate([l.property({readOnly:!0})],b.prototype,"updating",void 0),b=i.__decorate([n.subclass("esri.views.3d.layers.graphics.Graphics3DScaleVisibility")],b);const S="terrain-events";return b}));
