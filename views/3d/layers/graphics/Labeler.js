/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/asyncUtils","../../../../core/Handles","../../../../core/Logger","../../../../core/MapUtils","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/accessorSupport/decorators/property","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","../../../../layers/graphics/hydratedFeatures","../../../../layers/support/labelFormatUtils","../../../../layers/support/layerUtils","../../../../symbols/callouts/calloutUtils","./enums","./Graphics3DCalloutSymbolLayerFactory","./Graphics3DGraphicCreationContext","./graphicSymbolUtils","./labelPlacement","./placementUtils","../../support/debugFlags","../../webgl-engine/lib/MaterialCollection","../../webgl-engine/lib/TextRenderer","../../webgl-engine/lib/TextRenderParameters","../../webgl-engine/lib/TextTextureAtlas","../../webgl-engine/lib/WebGLLayer","../../../support/Scheduler"],(function(e,t,l,i,s,a,r,n,o,c,h,b,u,d,p,y,f,g,_,C,x,m,v,L,T,G,A,D,R,w,S,I){"use strict";const P=r.getLogger("esri.views.3d.layers.graphics.Labeler");function O(e){return e.active&&g.areLabelsVisible(e.layer)}function E(e){return e.labelClassPromise&&!!e.labelClassAbortController}function V(e){return e.labelClassContexts&&e.labelClassContexts.length}function F(e){return null===e.labelClassContexts}e.Labeler=function(e){function l(){var t;return(t=e.apply(this,arguments)||this)._dirty=!1,t._labels=new Map,t._labelsToAdd=new Map,t._labelsToRemove=new Map,t._labelingContexts=new Array,t}t._inheritsLoose(l,e);var i=l.prototype;return i.setup=function(){this.dispose(),this._handles=new a,this._handles.add([this.view.watch("state.camera",(()=>this.setDirty())),this.view.watch("pixelRatio",(()=>this._resetAllLabels())),this.view.resourceController.scheduler.registerTask(I.TaskPriority.LABELER,this)]),this._textTextureAtlas=new w.default({view:this.view}),this._hudMaterialCollection=new A.MaterialCollection(this.view._stage),this._calloutMaterialCollection=new A.MaterialCollection(this.view._stage)},i.dispose=function(){this._handles=o.destroyMaybe(this._handles),this._textTextureAtlas=o.disposeMaybe(this._textTextureAtlas),this._hudMaterialCollection=o.disposeMaybe(this._hudMaterialCollection),this._calloutMaterialCollection=o.disposeMaybe(this._calloutMaterialCollection),this._labelingContexts.length=0,this._labels.clear(),this._labelsToAdd.clear(),this._labelsToRemove.clear()},i._activateLabelingContext=function(e){e.labels.forEach(((e,t)=>{this._labels.set(t,e),e.graphics3DGraphic.setVisibilityFlag(C.VisibilityFlag.USER_SETTING,!0,C.VisibilityGroup.LABEL)})),e.active=!0},i._deactivateLabelingContext=function(e){e.labels.forEach(((e,t)=>{e.graphics3DGraphic.setVisibilityFlag(C.VisibilityFlag.USER_SETTING,!1,C.VisibilityGroup.LABEL),this.setLabelGraphicVisibility(e.graphics3DGraphic,!1),this._labels.delete(t)})),e.active=!1},i._addLabelTextureToAtlas=function(e){for(const t of e.graphics3DGraphic.labelGraphics){if(!t._labelClass)continue;const l=e.textTextureResources.textRenderers[t._labelIndex];o.isSome(l)&&this._textTextureAtlas.addTextTexture(l,t.stageObject)}e.rendered=!0},i._removeLabelTextureFromAtlas=function(e){for(const t of e.graphics3DGraphic.labelGraphics){if(!t._labelClass)continue;const l=e.textTextureResources.textRenderers[t._labelIndex];o.isSome(l)&&this._textTextureAtlas.removeTextTexture(l,t.stageObject)}e.rendered=!1},i.runTask=function(e){this._updateLabels(e),!this._dirty&&this.deconflictor.running&&this.deconflictor.runTask(e)},i._updateLabels=function(e){if(this._dirty){this._dirty=!1;for(const t of this._labelingContexts)if(O(t)){if(!V(t)){if(F(t)){this._deactivateLabelingContext(t);continue}if(this._createLabelClassContext(t),E(t)){this._dirty=!0;continue}if(!V(t))continue}n.someMap(t.labelsToInitialize,((l,i)=>(this._ensureGraphics3DResources(l)&&(this._labels.set(i,l),this.deconflictor.setDirty(),e.madeProgress()),(l.visible&&l.textTextureResources.initialized||!l.visible&&l.hasGraphics3DResources)&&(t.labelsToInitialize.delete(i),e.madeProgress()),e.done)))&&(this._dirty=!0)}this._labelsToRemove.forEach((e=>this._removeLabelTextureFromAtlas(e))),this._labelsToAdd.forEach((e=>this._addLabelTextureToAtlas(e))),this._labelsToRemove.clear(),this._labelsToAdd.clear(),this._dirty||this.notifyChange("updating")}},i._createLabelClassContextAsync=function(){var e=t._asyncToGenerator((function*(e){var l=this;const i=e.labelClassAbortController.signal;yield e.layer.when(),c.throwIfAborted(i),e.scaleVisibility&&e.scaleVisibility.updateScaleRangeActive();const a=e.graphics3DCore,r=a.layer,n=r.labelingInfo&&r.labelingInfo.filter((e=>!!e.symbol));if(!n||0===n.length)return;const h=new Array(n.length);let b=!1;yield s.forEach(n,function(){var r=t._asyncToGenerator((function*(t,r){const n=t.symbol,u=v.getGraphics3DSymbol(a.getOrCreateGraphics3DSymbol(n));if(o.isNone(u))return void P.error("Failed to create Graphics3DSymbol for label");yield u.load(),c.throwIfAborted(i);let d=null;_.hasCalloutSupport(n)&&n.hasVisibleCallout()&&(d=x.make(n,a.symbolCreationContext),yield d.load(),c.throwIfAborted(i));const p=yield s.result(f.createLabelFunction(t,e.layer.fieldsIndex,l.view.spatialReference));if(c.throwIfAborted(i),!0===p.ok){const e=yield l._createTextRenderParameters(u.symbol);c.throwIfAborted(i),h[r]={labelClass:t,labelFunction:p.value,graphics3DSymbol:u,graphics3DCalloutSymbolLayer:d,calloutSymbolLayerIndex:0,textRenderParameters:e}}else P.error(`Label expression failed to evaluate: ${p.error}`),b=!0}));return function(e,t){return r.apply(this,arguments)}}()),c.throwIfAborted(i),b||(e.labelClassContexts=h)}));function l(t){return e.apply(this,arguments)}return l}(),i._createLabelClassContext=function(){var e=t._asyncToGenerator((function*(e){return e.labelClassPromise||(e.labelClassPromise=this._createLabelClassContextAsync(e).catch((t=>{if(c.isAbortError(t))throw t;e.labelClassContexts=null})).then((()=>{e.labelClassAbortController=null,this.notifyChange("updating")})).catch((()=>{})),this.notifyChange("updating")),e.labelClassPromise}));function l(t){return e.apply(this,arguments)}return l}(),i._createTextRenderParameters=function(){var e=t._asyncToGenerator((function*(e){const t=e.symbolLayers.getItemAt(0);return t&&"text"===t.type?R.TextRenderParameters.fromSymbol(t,this.view.pixelRatio):null}));function l(t){return e.apply(this,arguments)}return l}(),i._destroyLabelClassContext=function(e){for(const l of e.labelClassContexts)--l.graphics3DSymbol.referenced,l.graphics3DSymbol=null;const t=e.labelClassAbortController;e.labelClassAbortController=new AbortController,t&&t.abort(),e.labelClassContexts=[],e.labelClassPromise=null,this.notifyChange("updating")},i._createTextSymbolGraphic=function(e,t,l,i,s){const a={text:e.text,centerOffset:l.centerOffset,translation:l.translation,elevationOffset:l.elevationOffset,screenOffset:l.screenOffset,centerOffsetUnits:l.centerOffsetUnits,horizontalPlacement:T.horizontalPlacementFromAnchor(l.anchor),verticalPlacement:T.verticalPlacementFromAnchor(l.anchor),verticalOffset:l.verticalOffset,debugDrawLabelBorder:G.LABELS_SHOW_BORDER,displayWidth:e.displayWidth,displayHeight:e.displayHeight};return M.graphic=t,M.renderingInfo=null,M.layer=i,s.createLabel(M,a,this._hudMaterialCollection,this._textTextureAtlas)},i._createLineCalloutGraphic=function(e,t,l,i,s){const a={symbol:t,translation:i.translation,elevationOffset:i.elevationOffset,screenOffset:i.screenOffset,centerOffset:i.centerOffset,centerOffsetUnits:i.centerOffsetUnits,materialCollection:this._calloutMaterialCollection};return M.graphic=e,M.renderingInfo=a,M.layer=s,l.createGraphics3DGraphic(M)},i._ensureGraphics3DResources=function(e){if(e.hasGraphics3DResources)return!1;const t=e.graphics3DGraphic;if(t.destroyed)return!1;this._ensureTextTextureResources(e);const{textTextureResources:l}=e,i=e.labelingContext,s=i.labelClassContexts;if(!s||0===s.length||!i.emptySymbolLabelSupported&&0===t.graphics.length)return!1;let a=!1;const r=t.graphic,n=i.layer,c=g.areLabelsVisible(i.layer),h=this.view._stage;for(let b=0;b<s.length;b++){const e=l.textRenderers[b],u=l.labelPlacements[b];if(o.isNone(e)||o.isNone(u))continue;const d=s[b],p=d.graphics3DSymbol,y=p.symbol&&"label-3d"===p.symbol.type?p.symbol:null,f=p.symbolLayers[0];if(!f)continue;f.setElevationInfoOverride(i.elevationInfoOverride);const g=this._createTextSymbolGraphic(e,r,u,n,f);if(!g)return!1;g._labelClass=d.labelClass,g._labelIndex=b,t.addLabelGraphic(g,h,i.stageLayer),t.setVisibilityFlag(C.VisibilityFlag.USER_SETTING,c,C.VisibilityGroup.LABEL),t.clearVisibilityFlag(C.VisibilityFlag.SCALE_RANGE,C.VisibilityGroup.LABEL),t.setVisibilityFlag(C.VisibilityFlag.DECONFLICTION,!1,C.VisibilityGroup.LABEL),a=!0;const _=d.graphics3DCalloutSymbolLayer;if(_&&u.hasLabelVerticalOffset){_.setElevationInfoOverride(i.elevationInfoOverride);const e=this._createLineCalloutGraphic(r,y,_,u,n);o.isSome(e)&&(d.calloutSymbolLayerIndex=t.labelGraphics.length,t.addLabelGraphic(e,h,i.stageLayer))}break}return i.scaleVisibility&&a&&i.scaleVisibility.updateGraphicLabelScaleVisibility(t),e.hasGraphics3DResources=!0,!0},i._destroyGraphics3DResources=function(e){const t=e.labelingContext.labelClassContexts;for(const l of e.graphics3DGraphic.labelGraphics){if(null==l._labelClass)continue;const e=t[l._labelIndex].graphics3DSymbol.symbolLayers[0];null!=e&&e.onRemoveGraphic(l)}e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1},i._ensureTextTextureResources=function(e){const{textTextureResources:t}=e;if(t.initialized)return;const l=e.labelingContext,i=l.labelClassContexts;if(!i||0===i.length)return;const s=e.graphics3DGraphic.graphic;for(let r=0;r<i.length;r++){const n=i[r];if(t.textRenderers[r]=null,t.labelPlacements[r]=null,!n.textRenderParameters)continue;const c=n.labelFunction;let h;if("arcade"===c.type)try{const e=c.needsHydrationToEvaluate()?y.hydrateGraphic(s,l.layer):s;h=c.evaluate(e)}catch(a){h=null}else h=c.evaluate(s);if(o.isNone(h)||""===h||/^\s+$/.test(h))continue;const b=n.graphics3DSymbol,u=b.symbol&&"label-3d"===b.symbol.type?b.symbol:null;if(!b.symbolLayers[0])continue;const d=e.graphics3DGraphic,p=n.labelClass,f=l.disablePlacement,g=L.get({graphics3DGraphic:d,labelSymbol:u,labelClass:p,disablePlacement:f});if(o.isNone(g))continue;const _=T.horizontalPlacementFromAnchor(g.anchor),C=T.textRenderAlignmentFromHorizontalPlacement(_);t.textRenderers[r]=new D.TextRenderer(h,C,n.textRenderParameters),t.labelPlacements[r]=g}t.initialized=!0},i._destroyTextTextureResources=function(e){const{textTextureResources:t}=e;t.initialized=!1,t.textRenderers=[],t.labelPlacements=[]},i._addGraphic=function(e,t){const l={hasGraphics3DResources:!1,visible:!1,rendered:!1,labelingContext:e,graphics3DGraphic:t,textTextureResources:{initialized:!1,textRenderers:[],labelPlacements:[]}},i=t.graphic.uid;e.labels.set(i,l),e.labelsToInitialize.set(i,l),this.setDirty(),this.deconflictor.setDirty()},i._removeGraphic=function(e,t){const l=t.graphic.uid,i=e.labels.get(l);i&&(this._destroyGraphic(i,l),e.labels.delete(l),e.labelsToInitialize.delete(l),this.setDirty(),this.deconflictor.setDirty())},i._destroyGraphic=function(e,t){this._labels.has(t)&&(this._labels.delete(t),this._labelsToAdd.delete(t),this._labelsToRemove.delete(t)),e.textTextureResources.initialized&&(this._removeLabelTextureFromAtlas(e),this._destroyTextTextureResources(e)),e.hasGraphics3DResources&&this._destroyGraphics3DResources(e)},i._labelingInfoChange=function(){var e=t._asyncToGenerator((function*(e,t){if(!t)return this._visibilityInfoChange(e),this._resetLabels(e),this._createLabelClassContext(e);for(const l of t){const t=e.labels.get(l);t&&(this._removeGraphic(e,t.graphics3DGraphic),this._addGraphic(e,t.graphics3DGraphic))}}));function l(t,l){return e.apply(this,arguments)}return l}(),i._globalPropertyChanged=function(e,t){for(const l of t.labelClassContexts){const i=new Map;t.labels.forEach((e=>{const t=e.graphics3DGraphic;i.set(t.graphic.uid,t)}));const s=e=>e.labelGraphics[0];if(o.unwrap(l.graphics3DSymbol.symbolLayers[0]).globalPropertyChanged(e,i,s),l.graphics3DCalloutSymbolLayer){const t=e=>e.labelGraphics[l.calloutSymbolLayerIndex];l.graphics3DCalloutSymbolLayer.globalPropertyChanged(e,i,t)}}},i._visibilityInfoChange=function(e){const t=e.layer.labelsVisible;t&&!e.active&&this._activateLabelingContext(e),!t&&e.active&&this._deactivateLabelingContext(e),this.setDirty()},i._resetAllLabels=function(){for(const e of this._labelingContexts)this._resetLabels(e)},i._resetLabels=function(e){e.labels.forEach(((t,l)=>{this._destroyGraphic(t,l),t.visible=!1,t.rendered=!1,e.labelsToInitialize.set(l,t)})),this._destroyLabelClassContext(e),this.setDirty(),this.deconflictor.setDirty()},i._findLabelingContext=function(e){for(const t of this._labelingContexts)if(t.graphics3DCore===e)return t;return null},i.addGraphicsOwner=function(e,t,l){const i=l&&l.emptySymbolLabelSupported||!1,s=l&&l.elevationInfoOverride||null,a=l&&l.disablePlacement||null;if(this._findLabelingContext(e))return;const r=e.layer,n={graphics3DCore:e,layer:r,scaleVisibility:t,emptySymbolLabelSupported:i,elevationInfoOverride:s,disablePlacement:a,active:r.labelsVisible,labelClassPromise:null,labelClassAbortController:new AbortController,labelClassContexts:[],labels:new Map,labelsToInitialize:new Map,stageLayer:new S.WebGLLayer({isPickable:!0},r.uid)};return this.view._stage.add(n.stageLayer),this._labelingContexts.push(n),this.setDirty(),{addGraphic:e=>this._addGraphic(n,e),removeGraphic:e=>this._removeGraphic(n,e),featureReductionChange:()=>{},layerLabelsEnabled:()=>g.areLabelsVisible(n.layer),labelingInfoChange:e=>this._labelingInfoChange(n,e),elevationInfoChange:()=>this._globalPropertyChanged("elevationInfo",n),slicePlaneEnabledChange:()=>this._globalPropertyChanged("slicePlaneEnabled",n),visibilityInfoChange:()=>this._visibilityInfoChange(n),reset:()=>this._resetLabels(n),clear:()=>{}}},i.removeGraphicsOwner=function(e){const t=this._findLabelingContext(e);if(!t)return;const l=this._labelingContexts.indexOf(t);this._labelingContexts.splice(l,1),t.labels.forEach((e=>this._removeGraphic(t,e.graphics3DGraphic))),this.view._stage.remove(t.stageLayer),t.stageLayer=null,this.setDirty()},i.setLabelGraphicVisibility=function(e,t){const l=e.graphic.uid,i=this._labels.get(l);i&&i.visible!==t&&(t&&!i.rendered?(this._labelsToAdd.set(l,i),this._labelsToRemove.delete(l),i.textTextureResources.initialized||i.labelingContext.labelsToInitialize.set(l,i)):!t&&i.rendered&&(this._labelsToRemove.set(l,i),this._labelsToAdd.delete(l)),i.visible=t,this.setDirty())},i.setDirty=function(){!this._dirty&&this._labelingContexts.length>0&&(this._dirty=!0,this.notifyChange("updating"))},t._createClass(l,[{key:"running",get:function(){var e;return this.view.ready&&(this._dirty||(null==(e=this._textTextureAtlas)?void 0:e.updating)||this.deconflictor.running)}},{key:"updating",get:function(){var e;return this._dirty||(null==(e=this._textTextureAtlas)?void 0:e.updating)||this.deconflictor.updating||this._labelingContexts.some((e=>E(e)))}},{key:"updatingProgress",get:function(){if(!this.updating||!this._textTextureAtlas)return 1;const e=this._labelingContexts.length>0?this._labelingContexts.reduce(((e,t)=>e+(E(t)?0:1)),0)/this._labelingContexts.length:1;return(this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*e+.5*this.deconflictor.updatingProgress}},{key:"test",get:function(){return{textTextureAtlas:this._textTextureAtlas,resetAllLabels:()=>this._resetAllLabels()}}}]),l}(i),l.__decorate([h.property({constructOnly:!0})],e.Labeler.prototype,"view",void 0),l.__decorate([h.property({constructOnly:!0})],e.Labeler.prototype,"deconflictor",void 0),l.__decorate([h.property()],e.Labeler.prototype,"_textTextureAtlas",void 0),l.__decorate([h.property({type:Boolean,readOnly:!0})],e.Labeler.prototype,"updating",null),e.Labeler=l.__decorate([p.subclass("esri.views.3d.layers.graphics.Labeler")],e.Labeler);const M=new m(null,null,null);Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
