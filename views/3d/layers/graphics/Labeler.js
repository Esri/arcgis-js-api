// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../core/Accessor","../../../../core/asyncUtils","../../../../core/Handles","../../../../core/Logger","../../../../core/MapUtils","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/accessorSupport/decorators","../../../../layers/graphics/hydratedFeatures","../../../../layers/support/labelFormatUtils","../../../../layers/support/layerUtils","../../../../symbols/callouts/calloutUtils","./Graphics3DCalloutSymbolLayerFactory","./graphicSymbolUtils","./labelPlacement","../../support/debugFlags","../../webgl-engine/lib/Layer","../../webgl-engine/lib/MaterialCollection","../../webgl-engine/lib/TextRenderer","../../webgl-engine/lib/TextRenderParameters","../../webgl-engine/lib/TextTextureAtlas","../../../support/Scheduler"],(function(e,t,r,a,i,l,s,n,o,c,h,u,b,p,d,f,y,g,v,C,x,m,L,T,_){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Labeler=void 0;var D=s.getLogger("esri.views.3d.layers.graphics.Labeler"),G=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.idHint="__labeler",t._dirty=!1,t.labels=new Map,t.labelsToAdd=new Map,t.labelsToRemove=new Map,t.labelingContexts=[],t}return r.__extends(t,e),t.prototype.setup=function(){var e=this;this.handles||(this.handles=new l,this.handles.add([this.view.watch("state.camera",(function(){return e.setDirty()})),this.view.watch("pixelRatio",(function(){return e.resetAllLabels()}))])),this.textTextureAtlas||(this.textTextureAtlas=new T.default({idHint:this.idHint+"_atlas",view:this.view}),this.hudMaterialCollection=new x(this.view._stage),this.calloutMaterialCollection=new x(this.view._stage));var t=this.view.resourceController.scheduler;this.handles.add(t.registerTask(_.Task.LABELER,(function(t){return e.update(t)}),(function(){return e.needsUpdate()})))},t.prototype.dispose=function(){this.handles&&(this.handles.destroy(),this.handles=null),this.textTextureAtlas&&(this.textTextureAtlas.dispose(),this.textTextureAtlas=null),this.hudMaterialCollection&&(this.hudMaterialCollection.dispose(),this.hudMaterialCollection=null),this.calloutMaterialCollection&&(this.calloutMaterialCollection.dispose(),this.calloutMaterialCollection=null),this.labelingContexts=[],this.labels.clear(),this.labelsToAdd.clear(),this.labelsToRemove.clear()},t.prototype.isActiveLabelingContext=function(e){return e.active&&p.areLabelsVisible(e.layer)},t.prototype.activateLabelingContext=function(e){var t=this;e.labels.forEach((function(e,r){t.labels.set(r,e),e.graphics3DGraphic.setVisibilityFlag(0,!0,1)})),e.active=!0},t.prototype.deactivateLabelingContext=function(e){var t=this;e.labels.forEach((function(e,r){e.graphics3DGraphic.setVisibilityFlag(0,!1,1),t.setLabelGraphicVisibility(e.graphics3DGraphic,!1),t.labels.delete(r)})),e.active=!1},t.prototype.addLabelTextureToAtlas=function(e){for(var t=0,r=e.graphics3DGraphic.labelGraphics;t<r.length;t++){var a=r[t];if(a._labelClass){var i=e.textRenderers[a._labelIndex];i&&this.textTextureAtlas.addTextTexture(i,a.stageObject)}}e.rendered=!0},t.prototype.removeLabelTextureFromAtlas=function(e){for(var t=0,r=e.graphics3DGraphic.labelGraphics;t<r.length;t++){var a=r[t];if(a._labelClass){var i=e.textRenderers[a._labelIndex];i&&this.textTextureAtlas.removeTextTexture(i,a.stageObject)}}e.rendered=!1},t.prototype.needsUpdate=function(){return this.view.ready&&this.isDirty},t.prototype.update=function(e){this._updateLabels(e),!this._dirty&&this.deconflictor.needsUpdate()&&this.deconflictor.update(e)},t.prototype._updateLabels=function(e){var t=this;if(this._dirty){this._dirty=!1;for(var r=function(r){if(!a.isActiveLabelingContext(r))return"continue";if(!a.hasValidLabelClassContext(r)){if(a.hasInvalidLabelClassContext(r))return a.deactivateLabelingContext(r),"continue";if(a.createLabelClassContext(r),a.hasPendingLabelClassContext(r))return a._dirty=!0,"continue";if(!a.hasValidLabelClassContext(r))return"continue"}n.someMap(r.labelsToInitialize,(function(a,i){return t.ensureGraphics3DResources(a)&&(t.labels.set(i,a),t.deconflictor.setDirty(),e.madeProgress()),(a.visible&&a.hasTextTextureResources||!a.visible&&a.hasGraphics3DResources)&&(r.labelsToInitialize.delete(i),e.madeProgress()),e.done}))&&(a._dirty=!0)},a=this,i=0,l=this.labelingContexts;i<l.length;i++){r(l[i])}this.labelsToRemove.forEach((function(e){return t.removeLabelTextureFromAtlas(e)})),this.labelsToRemove.clear(),this.labelsToAdd.forEach((function(e){return t.addLabelTextureToAtlas(e)})),this.labelsToAdd.clear(),this._dirty||this.notifyChange("updating")}},t.prototype.hasPendingLabelClassContext=function(e){return e.labelClassPromise&&!!e.labelClassAbortController},t.prototype.hasValidLabelClassContext=function(e){return e.labelClassContexts&&e.labelClassContexts.length},t.prototype.hasInvalidLabelClassContext=function(e){return null===e.labelClassContexts},t.prototype.createLabelClassContextAsync=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,a,l,s,n,h,u=this;return r.__generator(this,(function(p){switch(p.label){case 0:return t=e.labelClassAbortController.signal,[4,e.layer.when()];case 1:return p.sent(),c.throwIfAborted(t),e.scaleVisibility&&e.scaleVisibility.updateScaleRangeActive(),a=e.graphics3DCore,l=a.layer,(s=l.labelingInfo&&l.labelingInfo.filter((function(e){return!!e.symbol})))&&0!==s.length?(n=new Array(s.length),h=!1,[4,i.forEach(s,(function(l,s){return r.__awaiter(u,void 0,void 0,(function(){var u,p,g,v;return r.__generator(this,(function(r){switch(r.label){case 0:return u=l.symbol,p=y.getGraphics3DSymbol(a.getOrCreateGraphics3DSymbol(u)),o.isNone(p)?(D.error("Failed to create Graphics3DSymbol for label"),[2]):[4,p.load()];case 1:return r.sent(),c.throwIfAborted(t),g=null,d.isCalloutSupport(u)&&u.hasVisibleCallout()?[4,(g=f.make(u,a.symbolCreationContext)).load()]:[3,3];case 2:r.sent(),c.throwIfAborted(t),r.label=3;case 3:return[4,i.result(b.createLabelFunction(l,e.layer.fields.map((function(e){return e.toJSON()})),this.view.spatialReference))];case 4:return v=r.sent(),c.throwIfAborted(t),!0===v.ok?n[s]={labelClass:l,labelFunction:v.value,graphics3DSymbol:p,graphics3DCalloutSymbolLayer:g,calloutSymbolLayerIndex:0,textRenderParameters:this.createTextRenderParameters(p.symbol)}:(D.error("Label expression failed to evaluate: "+v.error),h=!0),[2]}}))}))}))]):[2];case 2:return p.sent(),c.throwIfAborted(t),h?[2]:(e.labelClassContexts=n,[2])}}))}))},t.prototype.createLabelClassContext=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t=this;return r.__generator(this,(function(r){return e.labelClassPromise||(e.labelClassPromise=this.createLabelClassContextAsync(e).catch((function(t){if(c.isAbortError(t))throw t;e.labelClassContexts=null})).then((function(){e.labelClassAbortController=null,t.notifyChange("updating")})).catch((function(){})),this.notifyChange("updating")),[2,e.labelClassPromise]}))}))},t.prototype.createTextRenderParameters=function(e){var t=e.symbolLayers.getItemAt(0);return t&&"text"===t.type?L.default.fromSymbol(t,this.view.pixelRatio):null},t.prototype.destroyLabelClassContext=function(e){for(var t=0,r=e.labelClassContexts;t<r.length;t++){var a=r[t];--a.graphics3DSymbol.referenced,a.graphics3DSymbol=null}var i=e.labelClassAbortController;e.labelClassAbortController=c.createAbortController(),i&&i.abort(),e.labelClassContexts=[],e.labelClassPromise=null,this.notifyChange("updating")},t.prototype.createTextSymbolGraphic=function(e,t,r,a,i){var l={text:e.text,centerOffset:r.centerOffset,translation:r.translation,elevationOffset:r.elevationOffset,screenOffset:r.screenOffset,anchor:r.anchor,centerOffsetUnits:r.centerOffsetUnits,verticalOffset:r.verticalOffset,debugDrawBorder:v.LABELS_SHOW_BORDER,displayWidth:e.displayWidth,displayHeight:e.displayHeight};return A.graphic=t,A.renderingInfo=null,A.layer=a,i.createLabel(A,l,this.hudMaterialCollection,this.textTextureAtlas)},t.prototype.createLineCalloutGraphic=function(e,t,r,a,i){var l={symbol:t,translation:a.translation,elevationOffset:a.elevationOffset,screenOffset:a.screenOffset,centerOffset:a.centerOffset,centerOffsetUnits:a.centerOffsetUnits,materialCollection:this.calloutMaterialCollection};return A.graphic=e,A.renderingInfo=l,A.layer=i,r.createGraphics3DGraphic(A)},t.prototype.ensureGraphics3DResources=function(e){if(e.hasGraphics3DResources)return!1;var t=e.graphics3DGraphic;if(t.destroyed)return!1;this.ensureTextTextureResources(e);var r=e.labelingContext,a=r.labelClassContexts;if(!a||0===a.length||!r.emptySymbolLabelSupported&&0===t._graphics.length)return!1;for(var i=!1,l=t.graphic,s=r.layer,n=p.areLabelsVisible(r.layer),c=this.view._stage,h=0;h<a.length;h++){var u=e.textRenderers[h];if(u){var b=a[h],d=b.graphics3DSymbol,f=null;d.symbol&&"label-3d"===d.symbol.type&&(f=d.symbol);var y=d.symbolLayers[0];if(y){var v=b.labelClass,C=r.disablePlacement,x=g.get({graphics3DGraphic:t,labelSymbol:f,labelClass:v,disablePlacement:C});if(!o.isNone(x)){y.setElevationInfoOverride(r.elevationInfoOverride);var m=this.createTextSymbolGraphic(u,l,x,s,y);if(!m)return!1;m._labelClass=v,m._labelIndex=h,t.addLabelGraphic(m,c,r.stageLayer),t.setVisibilityFlag(0,n,1),t.clearVisibilityFlag(1,1),t.setVisibilityFlag(3,!1,1),i=!0;var L=b.graphics3DCalloutSymbolLayer;if(L&&x.hasLabelVerticalOffset){L.setElevationInfoOverride(r.elevationInfoOverride);var T=this.createLineCalloutGraphic(l,f,L,x,s);T&&(b.calloutSymbolLayerIndex=t.labelGraphics.length,t.addLabelGraphic(T,c,r.stageLayer))}break}}}}return r.scaleVisibility&&i&&r.scaleVisibility.updateGraphicLabelScaleVisibility(t),e.hasGraphics3DResources=!0,!0},t.prototype.destroyGraphics3DResources=function(e){for(var t=e.labelingContext.labelClassContexts,r=0,a=e.graphics3DGraphic.labelGraphics;r<a.length;r++){var i=a[r];if(null!=i._labelClass){var l=t[i._labelIndex].graphics3DSymbol.symbolLayers[0];null!=l&&l.onRemoveGraphic(i)}}e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1},t.prototype.ensureTextTextureResources=function(e){if(!e.hasTextTextureResources){var t=e.labelingContext,r=t.labelClassContexts;if(r&&0!==r.length){for(var a=e.graphics3DGraphic.graphic,i=0;i<r.length;i++){var l=r[i];if(e.textRenderers[i]=null,l.textRenderParameters){var s=l.labelFunction,n=void 0;if("arcade"===s.type)try{var c=s.needsHydrationToEvaluate()?u.hydrateGraphic(a,t.layer):a;n=s.evaluate(c)}catch(e){n=null}else n=s.evaluate(a);o.isNone(n)||""===n||/^\s+$/.test(n)||(e.textRenderers[i]=new m.default(n,l.textRenderParameters))}}e.hasTextTextureResources=!0}}},t.prototype.destroyTextTextureResources=function(e){e.textRenderers=[],e.hasTextTextureResources=!1},t.prototype.addGraphic=function(e,t){var r={hasGraphics3DResources:!1,hasTextTextureResources:!1,visible:!1,rendered:!1,labelingContext:e,graphics3DGraphic:t,textRenderers:[]},a=t.graphic.uid;e.labels.set(a,r),e.labelsToInitialize.set(a,r),this.setDirty(),this.deconflictor.setDirty()},t.prototype.removeGraphic=function(e,t){var r=t.graphic.uid,a=e.labels.get(r);a&&(this.destroyGraphic(a,r),e.labels.delete(r),e.labelsToInitialize.delete(r),this.setDirty(),this.deconflictor.setDirty())},t.prototype.destroyGraphic=function(e,t){this.labels.has(t)&&(this.labels.delete(t),this.labelsToAdd.delete(t),this.labelsToRemove.delete(t)),e.hasTextTextureResources&&(this.removeLabelTextureFromAtlas(e),this.destroyTextTextureResources(e)),e.hasGraphics3DResources&&this.destroyGraphics3DResources(e)},t.prototype.labelingInfoChange=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var a,i,l,s;return r.__generator(this,(function(r){if(t){for(a=0,i=t;a<i.length;a++)l=i[a],(s=e.labels.get(l))&&(this.removeGraphic(e,s.graphics3DGraphic),this.addGraphic(e,s.graphics3DGraphic));return[2]}return this.visibilityInfoChange(e),this.resetLabels(e),[2,this.createLabelClassContext(e)]}))}))},t.prototype.globalPropertyChanged=function(e,t){for(var r=function(r){var a=new Map;t.labels.forEach((function(e){var t=e.graphics3DGraphic;a.set(t.graphic.uid,t)}));if(o.unwrap(r.graphics3DSymbol.symbolLayers[0]).globalPropertyChanged(e,a,(function(e){return e.labelGraphics[0]})),r.graphics3DCalloutSymbolLayer){r.graphics3DCalloutSymbolLayer.globalPropertyChanged(e,a,(function(e){return e.labelGraphics[r.calloutSymbolLayerIndex]}))}},a=0,i=t.labelClassContexts;a<i.length;a++){r(i[a])}},t.prototype.visibilityInfoChange=function(e){var t=e.layer.labelsVisible;t&&!e.active&&this.activateLabelingContext(e),!t&&e.active&&this.deactivateLabelingContext(e),this.setDirty()},t.prototype.resetAllLabels=function(){for(var e=0,t=this.labelingContexts;e<t.length;e++){var r=t[e];this.resetLabels(r)}},t.prototype.resetLabels=function(e){var t=this;e.labels.forEach((function(r,a){t.destroyGraphic(r,a),r.visible=!1,r.rendered=!1,e.labelsToInitialize.set(a,r)})),this.destroyLabelClassContext(e),this.setDirty(),this.deconflictor.setDirty()},t.prototype.findLabelingContext=function(e){for(var t=0,r=this.labelingContexts;t<r.length;t++){var a=r[t];if(a.graphics3DCore===e)return a}return null},t.prototype.addGraphicsOwner=function(e,t,r){var a=this,i=r&&r.emptySymbolLabelSupported||!1,l=r&&r.elevationInfoOverride||null,s=r&&r.disablePlacement||null;if(!this.findLabelingContext(e)){var n=e.layer,o={graphics3DCore:e,layer:n,scaleVisibility:t,emptySymbolLabelSupported:i,elevationInfoOverride:l,disablePlacement:s,active:n.labelsVisible,labelClassPromise:null,labelClassAbortController:c.createAbortController(),labelClassContexts:[],labels:new Map,labelsToInitialize:new Map,stageLayer:new C(this.idHint+"_"+n.uid,{isPickable:!0},n.uid)};return this.view._stage.add(0,o.stageLayer),this.view._stage.addToViewContent([o.stageLayer.id]),this.labelingContexts.push(o),this.setDirty(),{addGraphic:function(e){return a.addGraphic(o,e)},removeGraphic:function(e){return a.removeGraphic(o,e)},featureReductionChange:function(){},layerLabelsEnabled:function(){return p.areLabelsVisible(o.layer)},labelingInfoChange:function(e){return a.labelingInfoChange(o,e)},elevationInfoChange:function(){return a.globalPropertyChanged("elevationInfo",o)},slicePlaneEnabledChange:function(){return a.globalPropertyChanged("slicePlaneEnabled",o)},visibilityInfoChange:function(){return a.visibilityInfoChange(o)},reset:function(){return a.resetLabels(o)},clear:function(){},processStageDirty:function(){return a.view._stage.processDirtyLayer(o.stageLayer.id)}}}},t.prototype.removeGraphicsOwner=function(e){var t=this,r=this.findLabelingContext(e);if(r){var a=this.labelingContexts.indexOf(r);this.labelingContexts.splice(a,1),r.labels.forEach((function(e){return t.removeGraphic(r,e.graphics3DGraphic)}));var i=r.stageLayer.id;this.view._stage.removeFromViewContent([i]),this.view._stage.remove(0,i),r.stageLayer=null,this.setDirty()}},t.prototype.setLabelGraphicVisibility=function(e,t){var r=e.graphic.uid,a=this.labels.get(r);a&&a.visible!==t&&(t&&!a.rendered?(this.labelsToAdd.set(r,a),this.labelsToRemove.delete(r),a.hasTextTextureResources||a.labelingContext.labelsToInitialize.set(r,a)):!t&&a.rendered&&(this.labelsToRemove.set(r,a),this.labelsToAdd.delete(r)),a.visible=t,this.setDirty())},Object.defineProperty(t.prototype,"isDirty",{get:function(){return this._dirty||this.textTextureAtlas&&this.textTextureAtlas.isDirty||this.deconflictor.needsUpdate()},enumerable:!1,configurable:!0}),t.prototype.setDirty=function(){this._dirty||(this._dirty=!0,this.notifyChange("updating"))},Object.defineProperty(t.prototype,"updating",{get:function(){var e=this;return this._dirty||this.textTextureAtlas&&this.textTextureAtlas.updating||this.deconflictor.updating||this.labelingContexts.some((function(t){return e.hasPendingLabelClassContext(t)}))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"updatingProgress",{get:function(){var e=this;if(!this.updating||!this.textTextureAtlas)return 1;var t=this.labelingContexts.length>0?this.labelingContexts.reduce((function(t,r){return t+(e.hasPendingLabelClassContext(r)?0:1)}),0)/this.labelingContexts.length:1;return(this._dirty?0:.3)+(this.textTextureAtlas.updating?0:.1)+.1*t+.5*this.deconflictor.updatingProgress},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"test",{get:function(){var e=this;return{textTextureAtlas:this.textTextureAtlas,resetAllLabels:function(){return e.resetAllLabels()}}},enumerable:!1,configurable:!0}),r.__decorate([h.property({constructOnly:!0})],t.prototype,"view",void 0),r.__decorate([h.property({constructOnly:!0})],t.prototype,"deconflictor",void 0),r.__decorate([h.property()],t.prototype,"textTextureAtlas",void 0),r.__decorate([h.property({type:Boolean,readOnly:!0,dependsOn:["textTextureAtlas.updating","deconflictor.updating"]})],t.prototype,"updating",null),t=r.__decorate([h.subclass("esri.views.3d.layers.graphics.Labeler")],t)}(a);t.Labeler=G;var A={graphic:null,renderingInfo:null,layer:null}}));