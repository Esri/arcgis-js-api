/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/has","../../../../core/maybe","../../../../core/Logger","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/decorators/subclass","../../../../core/urlUtils","../../../../core/uuid","../../../../portal/support/resourceExtension","../../../../core/promiseUtils","../../../../core/Accessor","../../../../symbols/callouts/calloutUtils","../../../../core/asyncUtils","../../../../core/Handles","../../../support/Scheduler","../../../../core/MapUtils","../../../../layers/support/layerUtils","../../support/debugFlags","../../../../layers/graphics/hydratedFeatures","../../../../layers/support/labelFormatUtils","./Graphics3DCalloutSymbolLayerFactory","./Graphics3DGraphicCreationContext","../../webgl-engine/lib/WebGLLayer","../../webgl-engine/lib/TextRenderParameters","../../webgl-engine/lib/TextRenderer","./graphicSymbolUtils","./labelPlacement","../../webgl-engine/lib/MaterialCollection","../../webgl-engine/lib/TextTextureAtlas"],(function(e,t,s,a,l,i,r,n,o,c,h,b,u,d,p,y,f,g,C,x,L,m,v,T,G,D,A,w,R,_,I,S){"use strict";const O=i.getLogger("esri.views.3d.layers.graphics.Labeler");e.Labeler=function(e){function s(){var t;return(t=e.apply(this,arguments)||this)._dirty=!1,t.labels=new Map,t.labelsToAdd=new Map,t.labelsToRemove=new Map,t.labelingContexts=[],t}t._inheritsLoose(s,e);var a=s.prototype;return a.setup=function(){if(l.isNone(this.handles)){const e=this.view.resourceController.scheduler;this.handles=new f,this.handles.add([this.view.watch("state.camera",(()=>this.setDirty())),this.view.watch("pixelRatio",(()=>this.resetAllLabels())),e.registerTask(g.Task.LABELER,(e=>this.update(e)),(()=>this.needsUpdate()))])}l.isNone(this.textTextureAtlas)&&(this.textTextureAtlas=new S.default({view:this.view}),this.hudMaterialCollection=new I.MaterialCollection(this.view._stage),this.calloutMaterialCollection=new I.MaterialCollection(this.view._stage))},a.dispose=function(){this.handles=l.destroyMaybe(this.handles),this.textTextureAtlas=l.disposeMaybe(this.textTextureAtlas),this.hudMaterialCollection=l.disposeMaybe(this.hudMaterialCollection),this.calloutMaterialCollection=l.disposeMaybe(this.calloutMaterialCollection),this.labelingContexts=[],this.labels.clear(),this.labelsToAdd.clear(),this.labelsToRemove.clear()},a.isActiveLabelingContext=function(e){return e.active&&x.areLabelsVisible(e.layer)},a.activateLabelingContext=function(e){e.labels.forEach(((e,t)=>{this.labels.set(t,e),e.graphics3DGraphic.setVisibilityFlag(0,!0,1)})),e.active=!0},a.deactivateLabelingContext=function(e){e.labels.forEach(((e,t)=>{e.graphics3DGraphic.setVisibilityFlag(0,!1,1),this.setLabelGraphicVisibility(e.graphics3DGraphic,!1),this.labels.delete(t)})),e.active=!1},a.addLabelTextureToAtlas=function(e){for(const t of e.graphics3DGraphic.labelGraphics){if(!t._labelClass)continue;const s=e.textRenderers[t._labelIndex];s&&this.textTextureAtlas.addTextTexture(s,t.stageObject)}e.rendered=!0},a.removeLabelTextureFromAtlas=function(e){for(const t of e.graphics3DGraphic.labelGraphics){if(!t._labelClass)continue;const s=e.textRenderers[t._labelIndex];s&&this.textTextureAtlas.removeTextTexture(s,t.stageObject)}e.rendered=!1},a.needsUpdate=function(){return this.view.ready&&this.isDirty},a.update=function(e){this._updateLabels(e),!this._dirty&&this.deconflictor.needsUpdate()&&this.deconflictor.update(e)},a._updateLabels=function(e){if(this._dirty){this._dirty=!1;for(const t of this.labelingContexts)if(this.isActiveLabelingContext(t)){if(!this.hasValidLabelClassContext(t)){if(this.hasInvalidLabelClassContext(t)){this.deactivateLabelingContext(t);continue}if(this.createLabelClassContext(t),this.hasPendingLabelClassContext(t)){this._dirty=!0;continue}if(!this.hasValidLabelClassContext(t))continue}C.someMap(t.labelsToInitialize,((s,a)=>(this.ensureGraphics3DResources(s)&&(this.labels.set(a,s),this.deconflictor.setDirty(),e.madeProgress()),(s.visible&&s.hasTextTextureResources||!s.visible&&s.hasGraphics3DResources)&&(t.labelsToInitialize.delete(a),e.madeProgress()),e.done)))&&(this._dirty=!0)}this.labelsToRemove.forEach((e=>this.removeLabelTextureFromAtlas(e))),this.labelsToRemove.clear(),this.labelsToAdd.forEach((e=>this.addLabelTextureToAtlas(e))),this.labelsToAdd.clear(),this._dirty||this.notifyChange("updating")}},a.hasPendingLabelClassContext=function(e){return e.labelClassPromise&&!!e.labelClassAbortController},a.hasValidLabelClassContext=function(e){return e.labelClassContexts&&e.labelClassContexts.length},a.hasInvalidLabelClassContext=function(e){return null===e.labelClassContexts},a.createLabelClassContextAsync=async function(e){const t=e.labelClassAbortController.signal;await e.layer.when(),u.throwIfAborted(t),e.scaleVisibility&&e.scaleVisibility.updateScaleRangeActive();const s=e.graphics3DCore,a=s.layer,i=a.labelingInfo&&a.labelingInfo.filter((e=>!!e.symbol));if(!i||0===i.length)return;const r=new Array(i.length);let n=!1;await y.forEach(i,(async(a,i)=>{const o=a.symbol,c=R.getGraphics3DSymbol(s.getOrCreateGraphics3DSymbol(o));if(l.isNone(c))return void O.error("Failed to create Graphics3DSymbol for label");await c.load(),u.throwIfAborted(t);let h=null;p.isCalloutSupport(o)&&o.hasVisibleCallout()&&(h=T.make(o,s.symbolCreationContext),await h.load(),u.throwIfAborted(t));const b=await y.result(v.createLabelFunction(a,e.layer.fields.map((e=>e.toJSON())),this.view.spatialReference));u.throwIfAborted(t),!0===b.ok?r[i]={labelClass:a,labelFunction:b.value,graphics3DSymbol:c,graphics3DCalloutSymbolLayer:h,calloutSymbolLayerIndex:0,textRenderParameters:this.createTextRenderParameters(c.symbol)}:(O.error(`Label expression failed to evaluate: ${b.error}`),n=!0)})),u.throwIfAborted(t),n||(e.labelClassContexts=r)},a.createLabelClassContext=async function(e){return e.labelClassPromise||(e.labelClassPromise=this.createLabelClassContextAsync(e).catch((t=>{if(u.isAbortError(t))throw t;e.labelClassContexts=null})).then((()=>{e.labelClassAbortController=null,this.notifyChange("updating")})).catch((()=>{})),this.notifyChange("updating")),e.labelClassPromise},a.createTextRenderParameters=function(e){const t=e.symbolLayers.getItemAt(0);return t&&"text"===t.type?A.TextRenderParameters.fromSymbol(t,this.view.pixelRatio):null},a.destroyLabelClassContext=function(e){for(const s of e.labelClassContexts)--s.graphics3DSymbol.referenced,s.graphics3DSymbol=null;const t=e.labelClassAbortController;e.labelClassAbortController=u.createAbortController(),t&&t.abort(),e.labelClassContexts=[],e.labelClassPromise=null,this.notifyChange("updating")},a.createTextSymbolGraphic=function(e,t,s,a,l){const i={text:e.text,centerOffset:s.centerOffset,translation:s.translation,elevationOffset:s.elevationOffset,screenOffset:s.screenOffset,anchor:s.anchor,centerOffsetUnits:s.centerOffsetUnits,verticalOffset:s.verticalOffset,debugDrawBorder:L.LABELS_SHOW_BORDER,displayWidth:e.displayWidth,displayHeight:e.displayHeight};return P.graphic=t,P.renderingInfo=null,P.layer=a,l.createLabel(P,i,this.hudMaterialCollection,this.textTextureAtlas)},a.createLineCalloutGraphic=function(e,t,s,a,l){const i={symbol:t,translation:a.translation,elevationOffset:a.elevationOffset,screenOffset:a.screenOffset,centerOffset:a.centerOffset,centerOffsetUnits:a.centerOffsetUnits,materialCollection:this.calloutMaterialCollection};return P.graphic=e,P.renderingInfo=i,P.layer=l,s.createGraphics3DGraphic(P)},a.ensureGraphics3DResources=function(e){if(e.hasGraphics3DResources)return!1;const t=e.graphics3DGraphic;if(t.destroyed)return!1;this.ensureTextTextureResources(e);const s=e.labelingContext,a=s.labelClassContexts;if(!a||0===a.length||!s.emptySymbolLabelSupported&&0===t._graphics.length)return!1;let i=!1;const r=t.graphic,n=s.layer,o=x.areLabelsVisible(s.layer),c=this.view._stage;for(let h=0;h<a.length;h++){const b=e.textRenderers[h];if(!b)continue;const u=a[h],d=u.graphics3DSymbol;let p=null;d.symbol&&"label-3d"===d.symbol.type&&(p=d.symbol);const y=d.symbolLayers[0];if(!y)continue;const f=u.labelClass,g=s.disablePlacement,C=_.get({graphics3DGraphic:t,labelSymbol:p,labelClass:f,disablePlacement:g});if(l.isNone(C))continue;y.setElevationInfoOverride(s.elevationInfoOverride);const x=this.createTextSymbolGraphic(b,r,C,n,y);if(!x)return!1;x._labelClass=f,x._labelIndex=h,t.addLabelGraphic(x,c,s.stageLayer),t.setVisibilityFlag(0,o,1),t.clearVisibilityFlag(1,1),t.setVisibilityFlag(3,!1,1),i=!0;const L=u.graphics3DCalloutSymbolLayer;if(L&&C.hasLabelVerticalOffset){L.setElevationInfoOverride(s.elevationInfoOverride);const e=this.createLineCalloutGraphic(r,p,L,C,n);e&&(u.calloutSymbolLayerIndex=t.labelGraphics.length,t.addLabelGraphic(e,c,s.stageLayer))}break}return s.scaleVisibility&&i&&s.scaleVisibility.updateGraphicLabelScaleVisibility(t),e.hasGraphics3DResources=!0,!0},a.destroyGraphics3DResources=function(e){const t=e.labelingContext.labelClassContexts;for(const s of e.graphics3DGraphic.labelGraphics){if(null==s._labelClass)continue;const e=t[s._labelIndex].graphics3DSymbol.symbolLayers[0];null!=e&&e.onRemoveGraphic(s)}e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1},a.ensureTextTextureResources=function(e){if(e.hasTextTextureResources)return;const t=e.labelingContext,s=t.labelClassContexts;if(!s||0===s.length)return;const a=e.graphics3DGraphic.graphic;for(let r=0;r<s.length;r++){const n=s[r];if(e.textRenderers[r]=null,!n.textRenderParameters)continue;const o=n.labelFunction;let c;if("arcade"===o.type)try{const e=o.needsHydrationToEvaluate()?m.hydrateGraphic(a,t.layer):a;c=o.evaluate(e)}catch(i){c=null}else c=o.evaluate(a);l.isNone(c)||""===c||/^\s+$/.test(c)||(e.textRenderers[r]=new w.TextRenderer(c,n.textRenderParameters))}e.hasTextTextureResources=!0},a.destroyTextTextureResources=function(e){e.textRenderers=[],e.hasTextTextureResources=!1},a.addGraphic=function(e,t){const s={hasGraphics3DResources:!1,hasTextTextureResources:!1,visible:!1,rendered:!1,labelingContext:e,graphics3DGraphic:t,textRenderers:[]},a=t.graphic.uid;e.labels.set(a,s),e.labelsToInitialize.set(a,s),this.setDirty(),this.deconflictor.setDirty()},a.removeGraphic=function(e,t){const s=t.graphic.uid,a=e.labels.get(s);a&&(this.destroyGraphic(a,s),e.labels.delete(s),e.labelsToInitialize.delete(s),this.setDirty(),this.deconflictor.setDirty())},a.destroyGraphic=function(e,t){this.labels.has(t)&&(this.labels.delete(t),this.labelsToAdd.delete(t),this.labelsToRemove.delete(t)),e.hasTextTextureResources&&(this.removeLabelTextureFromAtlas(e),this.destroyTextTextureResources(e)),e.hasGraphics3DResources&&this.destroyGraphics3DResources(e)},a.labelingInfoChange=async function(e,t){if(!t)return this.visibilityInfoChange(e),this.resetLabels(e),this.createLabelClassContext(e);for(const s of t){const t=e.labels.get(s);t&&(this.removeGraphic(e,t.graphics3DGraphic),this.addGraphic(e,t.graphics3DGraphic))}},a.globalPropertyChanged=function(e,t){for(const s of t.labelClassContexts){const a=new Map;t.labels.forEach((e=>{const t=e.graphics3DGraphic;a.set(t.graphic.uid,t)}));const i=e=>e.labelGraphics[0];if(l.unwrap(s.graphics3DSymbol.symbolLayers[0]).globalPropertyChanged(e,a,i),s.graphics3DCalloutSymbolLayer){const t=e=>e.labelGraphics[s.calloutSymbolLayerIndex];s.graphics3DCalloutSymbolLayer.globalPropertyChanged(e,a,t)}}},a.visibilityInfoChange=function(e){const t=e.layer.labelsVisible;t&&!e.active&&this.activateLabelingContext(e),!t&&e.active&&this.deactivateLabelingContext(e),this.setDirty()},a.resetAllLabels=function(){for(const e of this.labelingContexts)this.resetLabels(e)},a.resetLabels=function(e){e.labels.forEach(((t,s)=>{this.destroyGraphic(t,s),t.visible=!1,t.rendered=!1,e.labelsToInitialize.set(s,t)})),this.destroyLabelClassContext(e),this.setDirty(),this.deconflictor.setDirty()},a.findLabelingContext=function(e){for(const t of this.labelingContexts)if(t.graphics3DCore===e)return t;return null},a.addGraphicsOwner=function(e,t,s){const a=s&&s.emptySymbolLabelSupported||!1,l=s&&s.elevationInfoOverride||null,i=s&&s.disablePlacement||null;if(this.findLabelingContext(e))return;const r=e.layer,n={graphics3DCore:e,layer:r,scaleVisibility:t,emptySymbolLabelSupported:a,elevationInfoOverride:l,disablePlacement:i,active:r.labelsVisible,labelClassPromise:null,labelClassAbortController:u.createAbortController(),labelClassContexts:[],labels:new Map,labelsToInitialize:new Map,stageLayer:new D.WebGLLayer({isPickable:!0},r.uid)};return this.view._stage.add(n.stageLayer),this.labelingContexts.push(n),this.setDirty(),{addGraphic:e=>this.addGraphic(n,e),removeGraphic:e=>this.removeGraphic(n,e),featureReductionChange:()=>{},layerLabelsEnabled:()=>x.areLabelsVisible(n.layer),labelingInfoChange:e=>this.labelingInfoChange(n,e),elevationInfoChange:()=>this.globalPropertyChanged("elevationInfo",n),slicePlaneEnabledChange:()=>this.globalPropertyChanged("slicePlaneEnabled",n),visibilityInfoChange:()=>this.visibilityInfoChange(n),reset:()=>this.resetLabels(n),clear:()=>{},processStageDirty:()=>n.stageLayer.commit()}},a.removeGraphicsOwner=function(e){const t=this.findLabelingContext(e);if(!t)return;const s=this.labelingContexts.indexOf(t);this.labelingContexts.splice(s,1),t.labels.forEach((e=>this.removeGraphic(t,e.graphics3DGraphic))),this.view._stage.remove(t.stageLayer),t.stageLayer=null,this.setDirty()},a.setLabelGraphicVisibility=function(e,t){const s=e.graphic.uid,a=this.labels.get(s);a&&a.visible!==t&&(t&&!a.rendered?(this.labelsToAdd.set(s,a),this.labelsToRemove.delete(s),a.hasTextTextureResources||a.labelingContext.labelsToInitialize.set(s,a)):!t&&a.rendered&&(this.labelsToRemove.set(s,a),this.labelsToAdd.delete(s)),a.visible=t,this.setDirty())},a.setDirty=function(){this._dirty||(this._dirty=!0,this.notifyChange("updating"))},t._createClass(s,[{key:"isDirty",get:function(){return this._dirty||this.textTextureAtlas&&this.textTextureAtlas.updating||this.deconflictor.needsUpdate()}},{key:"updating",get:function(){return this._dirty||this.textTextureAtlas&&this.textTextureAtlas.updating||this.deconflictor.updating||this.labelingContexts.some((e=>this.hasPendingLabelClassContext(e)))}},{key:"updatingProgress",get:function(){if(!this.updating||!this.textTextureAtlas)return 1;const e=this.labelingContexts.length>0?this.labelingContexts.reduce(((e,t)=>e+(this.hasPendingLabelClassContext(t)?0:1)),0)/this.labelingContexts.length:1;return(this._dirty?0:.3)+(this.textTextureAtlas.updating?0:.1)+.1*e+.5*this.deconflictor.updatingProgress}},{key:"test",get:function(){return{textTextureAtlas:this.textTextureAtlas,resetAllLabels:()=>this.resetAllLabels()}}}]),s}(d),s.__decorate([n.property({constructOnly:!0})],e.Labeler.prototype,"view",void 0),s.__decorate([n.property({constructOnly:!0})],e.Labeler.prototype,"deconflictor",void 0),s.__decorate([n.property()],e.Labeler.prototype,"textTextureAtlas",void 0),s.__decorate([n.property({type:Boolean,readOnly:!0})],e.Labeler.prototype,"updating",null),e.Labeler=s.__decorate([o.subclass("esri.views.3d.layers.graphics.Labeler")],e.Labeler);const P=new G(null,null,null);Object.defineProperty(e,"__esModule",{value:!0})}));
