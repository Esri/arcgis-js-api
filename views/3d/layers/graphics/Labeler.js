/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/asyncUtils","../../../../core/Handles","../../../../core/Logger","../../../../core/MapUtils","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","../../../../layers/graphics/hydratedFeatures","../../../../layers/support/labelFormatUtils","../../../../layers/support/layerUtils","../../../../symbols/callouts/calloutUtils","./Graphics3DCalloutSymbolLayerFactory","./Graphics3DGraphicCreationContext","./graphicSymbolUtils","./labelPlacement","../../support/debugFlags","../../webgl-engine/lib/MaterialCollection","../../webgl-engine/lib/TextRenderer","../../webgl-engine/lib/TextRenderParameters","../../webgl-engine/lib/TextTextureAtlas","../../webgl-engine/lib/WebGLLayer","../../../support/Scheduler"],(function(e,t,s,l,a,i,r,n,o,c,h,b,u,d,p,y,f,g,_,C,x,v,m,L,T,G,D,A,R){"use strict";const w=r.getLogger("esri.views.3d.layers.graphics.Labeler");function I(e){return e.active&&f.areLabelsVisible(e.layer)}function O(e){return e.labelClassPromise&&!!e.labelClassAbortController}function S(e){return e.labelClassContexts&&e.labelClassContexts.length}function P(e){return null===e.labelClassContexts}e.Labeler=function(e){function s(){var t;return(t=e.apply(this,arguments)||this)._dirty=!1,t._labels=new Map,t._labelsToAdd=new Map,t._labelsToRemove=new Map,t._labelingContexts=new Array,t}t._inheritsLoose(s,e);var l=s.prototype;return l.setup=function(){this.dispose(),this._handles=new i,this._handles.add([this.view.watch("state.camera",(()=>this.setDirty())),this.view.watch("pixelRatio",(()=>this._resetAllLabels())),this.view.resourceController.scheduler.registerTask(R.TaskPriority.LABELER,this)]),this._textTextureAtlas=new D.default({view:this.view}),this._hudMaterialCollection=new L.MaterialCollection(this.view._stage),this._calloutMaterialCollection=new L.MaterialCollection(this.view._stage)},l.dispose=function(){this._handles=o.destroyMaybe(this._handles),this._textTextureAtlas=o.disposeMaybe(this._textTextureAtlas),this._hudMaterialCollection=o.disposeMaybe(this._hudMaterialCollection),this._calloutMaterialCollection=o.disposeMaybe(this._calloutMaterialCollection),this._labelingContexts.length=0,this._labels.clear(),this._labelsToAdd.clear(),this._labelsToRemove.clear()},l._activateLabelingContext=function(e){e.labels.forEach(((e,t)=>{this._labels.set(t,e),e.graphics3DGraphic.setVisibilityFlag(0,!0,1)})),e.active=!0},l._deactivateLabelingContext=function(e){e.labels.forEach(((e,t)=>{e.graphics3DGraphic.setVisibilityFlag(0,!1,1),this.setLabelGraphicVisibility(e.graphics3DGraphic,!1),this._labels.delete(t)})),e.active=!1},l._addLabelTextureToAtlas=function(e){for(const t of e.graphics3DGraphic.labelGraphics){if(!t._labelClass)continue;const s=e.textRenderers[t._labelIndex];s&&this._textTextureAtlas.addTextTexture(s,t.stageObject)}e.rendered=!0},l._removeLabelTextureFromAtlas=function(e){for(const t of e.graphics3DGraphic.labelGraphics){if(!t._labelClass)continue;const s=e.textRenderers[t._labelIndex];s&&this._textTextureAtlas.removeTextTexture(s,t.stageObject)}e.rendered=!1},l.runTask=function(e){this._updateLabels(e),!this._dirty&&this.deconflictor.running&&this.deconflictor.runTask(e)},l._updateLabels=function(e){if(this._dirty){this._dirty=!1;for(const t of this._labelingContexts)if(I(t)){if(!S(t)){if(P(t)){this._deactivateLabelingContext(t);continue}if(this._createLabelClassContext(t),O(t)){this._dirty=!0;continue}if(!S(t))continue}n.someMap(t.labelsToInitialize,((s,l)=>(this._ensureGraphics3DResources(s)&&(this._labels.set(l,s),this.deconflictor.setDirty(),e.madeProgress()),(s.visible&&s.hasTextTextureResources||!s.visible&&s.hasGraphics3DResources)&&(t.labelsToInitialize.delete(l),e.madeProgress()),e.done)))&&(this._dirty=!0)}this._labelsToRemove.forEach((e=>this._removeLabelTextureFromAtlas(e))),this._labelsToAdd.forEach((e=>this._addLabelTextureToAtlas(e))),this._labelsToRemove.clear(),this._labelsToAdd.clear(),this._dirty||this.notifyChange("updating")}},l._createLabelClassContextAsync=function(){var e=t._asyncToGenerator((function*(e){var s=this;const l=e.labelClassAbortController.signal;yield e.layer.when(),c.throwIfAborted(l),e.scaleVisibility&&e.scaleVisibility.updateScaleRangeActive();const i=e.graphics3DCore,r=i.layer,n=r.labelingInfo&&r.labelingInfo.filter((e=>!!e.symbol));if(!n||0===n.length)return;const h=new Array(n.length);let b=!1;yield a.forEach(n,function(){var r=t._asyncToGenerator((function*(t,r){const n=t.symbol,u=x.getGraphics3DSymbol(i.getOrCreateGraphics3DSymbol(n));if(o.isNone(u))return void w.error("Failed to create Graphics3DSymbol for label");yield u.load(),c.throwIfAborted(l);let d=null;g.isCalloutSupport(n)&&n.hasVisibleCallout()&&(d=_.make(n,i.symbolCreationContext),yield d.load(),c.throwIfAborted(l));const p=yield a.result(y.createLabelFunction(t,e.layer.fieldsIndex,s.view.spatialReference));c.throwIfAborted(l),!0===p.ok?h[r]={labelClass:t,labelFunction:p.value,graphics3DSymbol:u,graphics3DCalloutSymbolLayer:d,calloutSymbolLayerIndex:0,textRenderParameters:s._createTextRenderParameters(u.symbol)}:(w.error(`Label expression failed to evaluate: ${p.error}`),b=!0)}));return function(e,t){return r.apply(this,arguments)}}()),c.throwIfAborted(l),b||(e.labelClassContexts=h)}));function s(t){return e.apply(this,arguments)}return s}(),l._createLabelClassContext=function(){var e=t._asyncToGenerator((function*(e){return e.labelClassPromise||(e.labelClassPromise=this._createLabelClassContextAsync(e).catch((t=>{if(c.isAbortError(t))throw t;e.labelClassContexts=null})).then((()=>{e.labelClassAbortController=null,this.notifyChange("updating")})).catch((()=>{})),this.notifyChange("updating")),e.labelClassPromise}));function s(t){return e.apply(this,arguments)}return s}(),l._createTextRenderParameters=function(e){const t=e.symbolLayers.getItemAt(0);return t&&"text"===t.type?G.TextRenderParameters.fromSymbol(t,this.view.pixelRatio):null},l._destroyLabelClassContext=function(e){for(const s of e.labelClassContexts)--s.graphics3DSymbol.referenced,s.graphics3DSymbol=null;const t=e.labelClassAbortController;e.labelClassAbortController=c.createAbortController(),t&&t.abort(),e.labelClassContexts=[],e.labelClassPromise=null,this.notifyChange("updating")},l._createTextSymbolGraphic=function(e,t,s,l,a){const i={text:e.text,centerOffset:s.centerOffset,translation:s.translation,elevationOffset:s.elevationOffset,screenOffset:s.screenOffset,anchor:s.anchor,centerOffsetUnits:s.centerOffsetUnits,verticalOffset:s.verticalOffset,debugDrawBorder:m.LABELS_SHOW_BORDER,displayWidth:e.displayWidth,displayHeight:e.displayHeight};return M.graphic=t,M.renderingInfo=null,M.layer=l,a.createLabel(M,i,this._hudMaterialCollection,this._textTextureAtlas)},l._createLineCalloutGraphic=function(e,t,s,l,a){const i={symbol:t,translation:l.translation,elevationOffset:l.elevationOffset,screenOffset:l.screenOffset,centerOffset:l.centerOffset,centerOffsetUnits:l.centerOffsetUnits,materialCollection:this._calloutMaterialCollection};return M.graphic=e,M.renderingInfo=i,M.layer=a,s.createGraphics3DGraphic(M)},l._ensureGraphics3DResources=function(e){if(e.hasGraphics3DResources)return!1;const t=e.graphics3DGraphic;if(t.destroyed)return!1;this._ensureTextTextureResources(e);const s=e.labelingContext,l=s.labelClassContexts;if(!l||0===l.length||!s.emptySymbolLabelSupported&&0===t.graphics.length)return!1;let a=!1;const i=t.graphic,r=s.layer,n=f.areLabelsVisible(s.layer),c=this.view._stage;for(let h=0;h<l.length;h++){const b=e.textRenderers[h];if(!b)continue;const u=l[h],d=u.graphics3DSymbol;let p=null;d.symbol&&"label-3d"===d.symbol.type&&(p=d.symbol);const y=d.symbolLayers[0];if(!y)continue;const f=u.labelClass,g=s.disablePlacement,_=v.get({graphics3DGraphic:t,labelSymbol:p,labelClass:f,disablePlacement:g});if(o.isNone(_))continue;y.setElevationInfoOverride(s.elevationInfoOverride);const C=this._createTextSymbolGraphic(b,i,_,r,y);if(!C)return!1;C._labelClass=f,C._labelIndex=h,t.addLabelGraphic(C,c,s.stageLayer),t.setVisibilityFlag(0,n,1),t.clearVisibilityFlag(1,1),t.setVisibilityFlag(3,!1,1),a=!0;const x=u.graphics3DCalloutSymbolLayer;if(x&&_.hasLabelVerticalOffset){x.setElevationInfoOverride(s.elevationInfoOverride);const e=this._createLineCalloutGraphic(i,p,x,_,r);e&&(u.calloutSymbolLayerIndex=t.labelGraphics.length,t.addLabelGraphic(e,c,s.stageLayer))}break}return s.scaleVisibility&&a&&s.scaleVisibility.updateGraphicLabelScaleVisibility(t),e.hasGraphics3DResources=!0,!0},l._destroyGraphics3DResources=function(e){const t=e.labelingContext.labelClassContexts;for(const s of e.graphics3DGraphic.labelGraphics){if(null==s._labelClass)continue;const e=t[s._labelIndex].graphics3DSymbol.symbolLayers[0];null!=e&&e.onRemoveGraphic(s)}e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1},l._ensureTextTextureResources=function(e){if(e.hasTextTextureResources)return;const t=e.labelingContext,s=t.labelClassContexts;if(!s||0===s.length)return;const l=e.graphics3DGraphic.graphic;for(let i=0;i<s.length;i++){const r=s[i];if(e.textRenderers[i]=null,!r.textRenderParameters)continue;const n=r.labelFunction;let c;if("arcade"===n.type)try{const e=n.needsHydrationToEvaluate()?p.hydrateGraphic(l,t.layer):l;c=n.evaluate(e)}catch(a){c=null}else c=n.evaluate(l);o.isNone(c)||""===c||/^\s+$/.test(c)||(e.textRenderers[i]=new T.TextRenderer(c,r.textRenderParameters))}e.hasTextTextureResources=!0},l._destroyTextTextureResources=function(e){e.textRenderers=[],e.hasTextTextureResources=!1},l._addGraphic=function(e,t){const s={hasGraphics3DResources:!1,hasTextTextureResources:!1,visible:!1,rendered:!1,labelingContext:e,graphics3DGraphic:t,textRenderers:[]},l=t.graphic.uid;e.labels.set(l,s),e.labelsToInitialize.set(l,s),this.setDirty(),this.deconflictor.setDirty()},l._removeGraphic=function(e,t){const s=t.graphic.uid,l=e.labels.get(s);l&&(this._destroyGraphic(l,s),e.labels.delete(s),e.labelsToInitialize.delete(s),this.setDirty(),this.deconflictor.setDirty())},l._destroyGraphic=function(e,t){this._labels.has(t)&&(this._labels.delete(t),this._labelsToAdd.delete(t),this._labelsToRemove.delete(t)),e.hasTextTextureResources&&(this._removeLabelTextureFromAtlas(e),this._destroyTextTextureResources(e)),e.hasGraphics3DResources&&this._destroyGraphics3DResources(e)},l._labelingInfoChange=function(){var e=t._asyncToGenerator((function*(e,t){if(!t)return this._visibilityInfoChange(e),this._resetLabels(e),this._createLabelClassContext(e);for(const s of t){const t=e.labels.get(s);t&&(this._removeGraphic(e,t.graphics3DGraphic),this._addGraphic(e,t.graphics3DGraphic))}}));function s(t,s){return e.apply(this,arguments)}return s}(),l._globalPropertyChanged=function(e,t){for(const s of t.labelClassContexts){const l=new Map;t.labels.forEach((e=>{const t=e.graphics3DGraphic;l.set(t.graphic.uid,t)}));const a=e=>e.labelGraphics[0];if(o.unwrap(s.graphics3DSymbol.symbolLayers[0]).globalPropertyChanged(e,l,a),s.graphics3DCalloutSymbolLayer){const t=e=>e.labelGraphics[s.calloutSymbolLayerIndex];s.graphics3DCalloutSymbolLayer.globalPropertyChanged(e,l,t)}}},l._visibilityInfoChange=function(e){const t=e.layer.labelsVisible;t&&!e.active&&this._activateLabelingContext(e),!t&&e.active&&this._deactivateLabelingContext(e),this.setDirty()},l._resetAllLabels=function(){for(const e of this._labelingContexts)this._resetLabels(e)},l._resetLabels=function(e){e.labels.forEach(((t,s)=>{this._destroyGraphic(t,s),t.visible=!1,t.rendered=!1,e.labelsToInitialize.set(s,t)})),this._destroyLabelClassContext(e),this.setDirty(),this.deconflictor.setDirty()},l._findLabelingContext=function(e){for(const t of this._labelingContexts)if(t.graphics3DCore===e)return t;return null},l.addGraphicsOwner=function(e,t,s){const l=s&&s.emptySymbolLabelSupported||!1,a=s&&s.elevationInfoOverride||null,i=s&&s.disablePlacement||null;if(this._findLabelingContext(e))return;const r=e.layer,n={graphics3DCore:e,layer:r,scaleVisibility:t,emptySymbolLabelSupported:l,elevationInfoOverride:a,disablePlacement:i,active:r.labelsVisible,labelClassPromise:null,labelClassAbortController:c.createAbortController(),labelClassContexts:[],labels:new Map,labelsToInitialize:new Map,stageLayer:new A.WebGLLayer({isPickable:!0},r.uid)};return this.view._stage.add(n.stageLayer),this._labelingContexts.push(n),this.setDirty(),{addGraphic:e=>this._addGraphic(n,e),removeGraphic:e=>this._removeGraphic(n,e),featureReductionChange:()=>{},layerLabelsEnabled:()=>f.areLabelsVisible(n.layer),labelingInfoChange:e=>this._labelingInfoChange(n,e),elevationInfoChange:()=>this._globalPropertyChanged("elevationInfo",n),slicePlaneEnabledChange:()=>this._globalPropertyChanged("slicePlaneEnabled",n),visibilityInfoChange:()=>this._visibilityInfoChange(n),reset:()=>this._resetLabels(n),clear:()=>{}}},l.removeGraphicsOwner=function(e){const t=this._findLabelingContext(e);if(!t)return;const s=this._labelingContexts.indexOf(t);this._labelingContexts.splice(s,1),t.labels.forEach((e=>this._removeGraphic(t,e.graphics3DGraphic))),this.view._stage.remove(t.stageLayer),t.stageLayer=null,this.setDirty()},l.setLabelGraphicVisibility=function(e,t){const s=e.graphic.uid,l=this._labels.get(s);l&&l.visible!==t&&(t&&!l.rendered?(this._labelsToAdd.set(s,l),this._labelsToRemove.delete(s),l.hasTextTextureResources||l.labelingContext.labelsToInitialize.set(s,l)):!t&&l.rendered&&(this._labelsToRemove.set(s,l),this._labelsToAdd.delete(s)),l.visible=t,this.setDirty())},l.setDirty=function(){!this._dirty&&this._labelingContexts.length>0&&(this._dirty=!0,this.notifyChange("updating"))},t._createClass(s,[{key:"running",get:function(){var e;return!!this.view.ready&&(this._dirty||(null==(e=this._textTextureAtlas)?void 0:e.updating)||this.deconflictor.running)}},{key:"updating",get:function(){var e;return this._dirty||(null==(e=this._textTextureAtlas)?void 0:e.updating)||this.deconflictor.updating||this._labelingContexts.some((e=>O(e)))}},{key:"updatingProgress",get:function(){if(!this.updating||!this._textTextureAtlas)return 1;const e=this._labelingContexts.length>0?this._labelingContexts.reduce(((e,t)=>e+(O(t)?0:1)),0)/this._labelingContexts.length:1;return(this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*e+.5*this.deconflictor.updatingProgress}},{key:"test",get:function(){return{textTextureAtlas:this._textTextureAtlas,resetAllLabels:()=>this._resetAllLabels()}}}]),s}(l),s.__decorate([h.property({constructOnly:!0})],e.Labeler.prototype,"view",void 0),s.__decorate([h.property({constructOnly:!0})],e.Labeler.prototype,"deconflictor",void 0),s.__decorate([h.property()],e.Labeler.prototype,"_textTextureAtlas",void 0),s.__decorate([h.property({type:Boolean,readOnly:!0})],e.Labeler.prototype,"updating",null),e.Labeler=s.__decorate([d.subclass("esri.views.3d.layers.graphics.Labeler")],e.Labeler);const M=new C(null,null,null);Object.defineProperty(e,"__esModule",{value:!0})}));
