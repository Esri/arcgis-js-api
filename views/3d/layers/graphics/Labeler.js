/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/asyncUtils","../../../../core/Handles","../../../../core/Logger","../../../../core/MapUtils","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/accessorSupport/decorators/subclass","../../../../layers/graphics/hydratedFeatures","../../../../layers/support/labelFormatUtils","../../../../symbols/callouts/calloutUtils","./CreateLabelParameters","./enums","./Graphics3DCalloutSymbolLayerFactory","./Graphics3DLineCalloutSymbolLayer","./graphicSymbolUtils","./labelPlacement","./placementUtils","../../webgl-engine/lib/MaterialCollection","../../webgl-engine/lib/TextRenderer","../../webgl-engine/lib/TextRenderParameters","../../webgl-engine/lib/TextTextureAtlas","../../webgl-engine/lib/WebGLLayer","../../../support/Scheduler"],(function(e,t,i,s,l,a,r,n,o,c,h,b,u,d,y,p,g,f,_,C,x,m,L,v,T,G,A,w,I,D,R){"use strict";let S=function(e,t){this.labelingContext=e,this.graphics3DGraphic=t,this.hasGraphics3DResources=!1,this.visible=!1,this.rendered=!1,this.textInitialized=!1,this.textRenderers=new Array,this.textLabelPlacements=new Array},P=function(e,t,i,s,l){this.labelClass=e,this.graphics3DSymbol=t,this.graphics3DCalloutSymbolLayer=i,this.textRenderParameters=s,this.labelFunction=l,this.calloutSymbolLayerIndex=0},E=function(e,t,i,s,l,a,r){this.layer=e,this.graphics3DCore=t,this.scaleVisibility=i,this.emptySymbolLabelSupported=s,this.elevationInfoOverride=l,this.disablePlacement=a,this.active=r,this.labelClassAbortController=new AbortController,this.labelClassContexts=new Array,this.graphics=new Map,this.labelsToInitialize=new Map,this.stageLayer=new D.WebGLLayer({pickable:!0,disableOctree:!0},e.uid)};function O(e){return!!e.labelClassPromise&&!!e.labelClassAbortController}function V(e){return e.labelClassContexts&&e.labelClassContexts.length}function F(e){return null===e.labelClassContexts}function M(e){return!0===e.labelsVisible&&!!e.labelingInfo?.some((e=>!!e.symbol))}e.Labeler=function(e){function i(t){var i;return(i=e.call(this,t)||this)._dirty=!1,i._labels=new Map,i._labelsToAdd=new Map,i._labelsToRemove=new Map,i._labelingContexts=new Array,i}t._inheritsLoose(i,e);var s=i.prototype;return s.setup=function(){this.dispose(),this._handles=new a,this._handles.add([h.watch((()=>this.view.state?.camera),(()=>this.setDirty())),h.watch((()=>this.view.state?.rasterPixelRatio),(()=>this._resetAllLabels())),this.view.resourceController.scheduler.registerTask(R.TaskPriority.LABELER,this)]),this._textTextureAtlas=new I.TextTextureAtlas({view:this.view}),this._hudMaterialCollection=new G.MaterialCollection(this.view._stage),this._calloutMaterialCollection=new G.MaterialCollection(this.view._stage)},s.dispose=function(){this._handles=o.destroyMaybe(this._handles),this._textTextureAtlas=o.disposeMaybe(this._textTextureAtlas),this._hudMaterialCollection=o.disposeMaybe(this._hudMaterialCollection),this._calloutMaterialCollection=o.disposeMaybe(this._calloutMaterialCollection),this._labelingContexts.length=0,this._labels.clear(),this._labelsToAdd.clear(),this._labelsToRemove.clear()},s._activateLabelingContext=function(e){e.graphics.forEach(((t,i)=>{const s=new S(e,t);this._labels.set(i,s),e.labelsToInitialize.set(i,s),t.setVisibilityFlag(C.VisibilityFlag.USER_SETTING,!0,C.VisibilityGroup.LABEL)})),e.active=!0},s._deactivateLabelingContext=function(e){e.graphics.forEach(((e,t)=>{e.setVisibilityFlag(C.VisibilityFlag.USER_SETTING,!1,C.VisibilityGroup.LABEL),this.setLabelGraphicVisibility(e,!1),this._labels.delete(t)})),e.active=!1},s._addLabelTextureToAtlas=function(e){for(const t of e.graphics3DGraphic.labelLayers){if(!t._labelClass)continue;const i=e.textRenderers[t._labelIndex];o.isSome(i)&&this._textTextureAtlas.addTextTexture(i,t.stageObject)}e.rendered=!0},s._removeLabelTextureFromAtlas=function(e){for(const t of e.graphics3DGraphic.labelLayers){if(!t._labelClass)continue;const i=e.textRenderers[t._labelIndex];o.isSome(i)&&this._textTextureAtlas.removeTextTexture(i,t.stageObject)}e.rendered=!1},s.runTask=function(e){return this._updateLabels(e),!this._dirty&&this.deconflictor.running&&this.deconflictor.runTask(e),R.Task.YIELD},s._updateLabels=function(e){if(this._dirty){this._dirty=!1;for(const t of this._labelingContexts)if(t.active){if(!V(t)){if(F(t)){this._deactivateLabelingContext(t);continue}if(this._createLabelClassContext(t),O(t)){this._dirty=!0;continue}if(!V(t))continue}n.someMap(t.labelsToInitialize,((i,s)=>(this._ensureGraphics3DResources(i)&&(this._labels.set(s,i),this.deconflictor.setDirty(),e.madeProgress()),(i.visible&&i.textInitialized||!i.visible&&i.hasGraphics3DResources)&&(t.labelsToInitialize.delete(s),e.madeProgress()),e.done)))&&(this._dirty=!0)}this._labelsToRemove.forEach((e=>this._removeLabelTextureFromAtlas(e))),this._labelsToAdd.forEach((e=>this._addLabelTextureToAtlas(e))),this._labelsToRemove.clear(),this._labelsToAdd.clear(),this._dirty||this.notifyChange("updating")}},s._createLabelClassContextAsync=function(){var e=t._asyncToGenerator((function*(e){var i=this;const s=e.labelClassAbortController?.signal;yield e.layer.when?.(),c.throwIfAborted(s),e.scaleVisibility&&e.scaleVisibility.updateScaleRangeActive();const a=e.graphics3DCore,n=a.layer,h=n.labelingInfo&&n.labelingInfo.filter((e=>!!e.symbol));if(!h||0===h.length)return;let b=!1;yield l.forEach(h,function(){var n=t._asyncToGenerator((function*(t,n){const h=t.symbol,u=L.getGraphics3DSymbol(a.getOrCreateGraphics3DSymbol(h));if(o.isNone(u))return void r.getLogger(i.declaredClass).error("Failed to create Graphics3DSymbol for label");yield u.load(),c.throwIfAborted(s);let d=null;f.hasCalloutSupport(h)&&h.hasVisibleCallout()&&(d=x.make(h,a.symbolCreationContext),yield d.load(),c.throwIfAborted(s));const y=yield l.result(g.createLabelFunction(t,e.layer.fieldsIndex,i.view.spatialReference));if(c.throwIfAborted(s),!0===y.ok){const l=yield i._createTextRenderParameters(u.symbol);c.throwIfAborted(s),e.labelClassContexts[n]=new P(t,u,d,l,y.value)}else r.getLogger(i.declaredClass).error(`Label expression failed to evaluate: ${y.error}`),b=!0}));return function(e,t){return n.apply(this,arguments)}}()),c.throwIfAborted(s)}));function i(t){return e.apply(this,arguments)}return i}(),s._createLabelClassContext=function(){var e=t._asyncToGenerator((function*(e){return o.isNone(e.labelClassPromise)&&(e.labelClassPromise=this._createLabelClassContextAsync(e).catch((t=>{if(c.isAbortError(t))throw t;e.labelClassContexts.length=0})).then((()=>{e.labelClassAbortController=null,this.notifyChange("updating")})).catch((()=>{})),this.notifyChange("updating")),e.labelClassPromise}));function i(t){return e.apply(this,arguments)}return i}(),s._createTextRenderParameters=function(){var e=t._asyncToGenerator((function*(e){const t=e.symbolLayers.getItemAt(0);return t&&"text"===t.type?w.TextRenderParameters.fromSymbol(t,this.view.state.rasterPixelRatio):null}));function i(t){return e.apply(this,arguments)}return i}(),s._destroyLabelClassContext=function(e){for(const i of e.labelClassContexts)--i.graphics3DSymbol.referenced;const t=e.labelClassAbortController;e.labelClassAbortController=new AbortController,o.abortMaybe(t),e.labelClassContexts.length=0,e.labelClassPromise=null,this.notifyChange("updating")},s._createTextSymbolGraphic=function(e,t,i,s,l){const a=new _.CreateLabelParameters(i.verticalOffset,T.horizontalPlacementFromAnchor(i.anchor),T.verticalPlacementFromAnchor(i.anchor),e.text,i.translation,i.elevationOffset,i.centerOffset,i.screenOffset,i.centerOffsetUnits,e.displayWidth,e.displayHeight);return z.graphic=t,z.renderingInfo=null,z.layer=s,l.createLabel(z,a,this._hudMaterialCollection,this._textTextureAtlas)},s._createLineCalloutGraphic=function(e,t,i,s,l){return z.graphic=e,z.layer=l,z.renderingInfo=new m.LineCalloutSymbolLayerRenderingInfo(null,t,s.translation,s.centerOffset,s.screenOffset,s.centerOffsetUnits,s.elevationOffset,this._calloutMaterialCollection),i.createGraphics3DGraphic(z)},s._ensureGraphics3DResources=function(e){if(e.hasGraphics3DResources)return!1;const t=e.graphics3DGraphic;if(t.destroyed)return!1;this._ensureTextTextureResources(e);const i=e.labelingContext,s=i.labelClassContexts;if(!s||0===s.length||!i.emptySymbolLabelSupported&&0===t.layers.length)return!1;let l=!1;const a=t.graphic,r=i.layer,n=M(i.layer),c=this.view._stage;for(let h=0;h<s.length;h++){const b=e.textRenderers[h],u=e.textLabelPlacements[h];if(o.isNone(b)||o.isNone(u))continue;const d=s[h],y=d.graphics3DSymbol,p=y.symbol&&"label-3d"===y.symbol.type?y.symbol:null,g=y.symbolLayers[0];if(!g)continue;g.setElevationInfoOverride(i.elevationInfoOverride);const f=this._createTextSymbolGraphic(b,a,u,r,g);if(o.isNone(f))return!1;f._labelClass=d.labelClass,f._labelIndex=h,t.addLabelGraphic(f,c,i.stageLayer),t.setVisibilityFlag(C.VisibilityFlag.USER_SETTING,n,C.VisibilityGroup.LABEL),t.clearVisibilityFlag(C.VisibilityFlag.SCALE_RANGE,C.VisibilityGroup.LABEL),t.setVisibilityFlag(C.VisibilityFlag.DECONFLICTION,!1,C.VisibilityGroup.LABEL),l=!0;const _=d.graphics3DCalloutSymbolLayer;if(_&&u.hasLabelVerticalOffset){_.setElevationInfoOverride(i.elevationInfoOverride);const e=this._createLineCalloutGraphic(a,p,_,u,r);o.isSome(e)&&(d.calloutSymbolLayerIndex=t.labelLayers.length,t.addLabelGraphic(e,c,i.stageLayer))}break}return i.scaleVisibility&&l&&i.scaleVisibility.updateGraphicLabelScaleVisibility(t),e.hasGraphics3DResources=!0,!0},s._destroyGraphics3DResources=function(e){const t=e.labelingContext.labelClassContexts;for(const i of e.graphics3DGraphic.labelLayers){if(null==i._labelClass)continue;const e=t[i._labelIndex].graphics3DSymbol.symbolLayers[0];null!=e&&e.onRemoveGraphic(i)}e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1},s._ensureTextTextureResources=function(e){if(e.textInitialized)return;const t=e.labelingContext,i=t.labelClassContexts;if(!i||0===i.length)return;const s=e.graphics3DGraphic.graphic;for(let a=0;a<i.length;a++){const r=i[a];if(e.textRenderers[a]=null,e.textLabelPlacements[a]=null,!r.textRenderParameters)continue;const n=r.labelFunction;let c;if("arcade"===n.type)try{const e=n.needsHydrationToEvaluate()?p.hydrateGraphic(s,t.layer):s;c=n.evaluate(e)}catch(l){c=null}else c=n.evaluate(s);if(o.isNone(c)||""===c||/^\s+$/.test(c))continue;const h=r.graphics3DSymbol,b="label-3d"===h.symbol?.type?h.symbol:null;if(!h.symbolLayers[0])continue;const u=e.graphics3DGraphic,d=r.labelClass,y=t.disablePlacement,g=v.get({graphics3DGraphic:u,labelSymbol:b,labelClass:d,disablePlacement:y});if(o.isNone(g))continue;const f=T.horizontalPlacementFromAnchor(g.anchor),_=T.textRenderAlignmentFromHorizontalPlacement(f);e.textRenderers[a]=new A.TextRenderer(c,_,r.textRenderParameters),e.textLabelPlacements[a]=g}e.textInitialized=!0},s._destroyTextTextureResources=function(e){e.textInitialized=!1,e.textRenderers.length=0,e.textLabelPlacements.length=0},s._addGraphic=function(e,t){const i=t.graphic.uid;if(e.graphics.set(i,t),e.active){const s=new S(e,t);this._labels.set(i,s),e.labelsToInitialize.set(i,s)}this.setDirty(),this.deconflictor.setDirty()},s._removeGraphic=function(e,t){const i=t.graphic.uid,s=this._labels.get(i);e.graphics.delete(i),s&&(this._destroyGraphic(s,i),e.labelsToInitialize.delete(i),this.setDirty(),this.deconflictor.setDirty())},s._destroyGraphic=function(e,t){this._labels.has(t)&&(this._labels.delete(t),this._labelsToAdd.delete(t),this._labelsToRemove.delete(t)),e.textInitialized&&(this._removeLabelTextureFromAtlas(e),this._destroyTextTextureResources(e)),e.hasGraphics3DResources&&this._destroyGraphics3DResources(e)},s._labelingInfoChange=function(){var e=t._asyncToGenerator((function*(e,t){if(!t)return this._visibilityInfoChange(e),this._resetLabels(e),this._createLabelClassContext(e);for(const i of t){const t=e.graphics.get(i);t&&(this._removeGraphic(e,t),this._addGraphic(e,t))}}));function i(t,i){return e.apply(this,arguments)}return i}(),s._globalPropertyChanged=function(e,t){for(const i of t.labelClassContexts){const s=new Map;t.graphics.forEach((e=>s.set(e.graphic.uid,e)));const l=e=>e.labelLayers[0];if(o.unwrap(i.graphics3DSymbol.symbolLayers[0]).globalPropertyChanged(e,s,l),i.graphics3DCalloutSymbolLayer){const t=e=>e.labelLayers[i.calloutSymbolLayerIndex];i.graphics3DCalloutSymbolLayer.globalPropertyChanged(e,s,t)}}},s._visibilityInfoChange=function(e){const t=M(e.layer);t&&!e.active&&this._activateLabelingContext(e),!t&&e.active&&this._deactivateLabelingContext(e),this.setDirty()},s._resetAllLabels=function(){for(const e of this._labelingContexts)this._resetLabels(e)},s._resetLabels=function(e){e.graphics.forEach(((t,i)=>{const s=this._labels.get(i);s&&(this._destroyGraphic(s,i),s.visible=!1,s.rendered=!1,e.labelsToInitialize.set(i,s))})),this._destroyLabelClassContext(e),this.setDirty(),this.deconflictor.setDirty()},s._findLabelingContext=function(e){for(const t of this._labelingContexts)if(t.graphics3DCore===e)return t;return null},s.addGraphicsOwner=function(e,t,i){const s=i&&i.emptySymbolLabelSupported||!1,l=i&&i.elevationInfoOverride||null,a=i&&i.disablePlacement||null;if(this._findLabelingContext(e))return;const r=e.layer,n=new E(r,e,t,s,l,a,M(r));return this.view._stage.add(n.stageLayer),this._labelingContexts.push(n),this.setDirty(),{addGraphic:e=>this._addGraphic(n,e),removeGraphic:e=>this._removeGraphic(n,e),featureReductionChange:()=>{},layerLabelsEnabled:()=>M(n.layer),labelingInfoChange:e=>this._labelingInfoChange(n,e),elevationInfoChange:()=>this._globalPropertyChanged("elevationInfo",n),slicePlaneEnabledChange:()=>this._globalPropertyChanged("slicePlaneEnabled",n),visibilityInfoChange:()=>this._visibilityInfoChange(n),reset:()=>this._resetLabels(n),clear:()=>{}}},s.removeGraphicsOwner=function(e){const t=this._findLabelingContext(e);if(!t)return;const i=this._labelingContexts.indexOf(t);this._labelingContexts.splice(i,1),t.graphics.forEach((e=>this._removeGraphic(t,e))),this.view._stage.remove(t.stageLayer),this.setDirty()},s.setLabelGraphicVisibility=function(e,t){const i=e.graphic.uid,s=this._labels.get(i);s&&s.visible!==t&&(t&&!s.rendered?(this._labelsToAdd.set(i,s),this._labelsToRemove.delete(i),s.textInitialized||s.labelingContext.labelsToInitialize.set(i,s)):!t&&s.rendered&&(this._labelsToRemove.set(i,s),this._labelsToAdd.delete(i)),s.visible=t,this.setDirty())},s.setDirty=function(){!this._dirty&&this._labelingContexts.length>0&&(this._dirty=!0,this.notifyChange("updating"))},t._createClass(i,[{key:"running",get:function(){return this.view.ready&&(this._dirty||this.deconflictor.running)}},{key:"updating",get:function(){return this._dirty||this._textTextureAtlas?.updating||this.deconflictor.updating||this._labelingContexts.some((e=>O(e)))}},{key:"updatingProgress",get:function(){if(!this.updating||!this._textTextureAtlas)return 1;const e=this._labelingContexts.length>0?this._labelingContexts.reduce(((e,t)=>e+(O(t)?0:1)),0)/this._labelingContexts.length:1;return(this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*e+.5*this.deconflictor.updatingProgress}},{key:"test",get:function(){return{textTextureAtlas:this._textTextureAtlas,resetAllLabels:()=>this._resetAllLabels()}}}]),i}(s),i.__decorate([b.property({constructOnly:!0})],e.Labeler.prototype,"view",void 0),i.__decorate([b.property({constructOnly:!0})],e.Labeler.prototype,"deconflictor",void 0),i.__decorate([b.property()],e.Labeler.prototype,"_textTextureAtlas",void 0),i.__decorate([b.property({type:Boolean,readOnly:!0})],e.Labeler.prototype,"updating",null),e.Labeler=i.__decorate([y.subclass("esri.views.3d.layers.graphics.Labeler")],e.Labeler);const z=new m.LineCalloutCreationContext(null,null,null);e.areLabelsVisible=M,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
