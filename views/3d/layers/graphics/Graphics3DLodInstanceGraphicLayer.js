/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../chunks/vec3f64","../../../../chunks/vec3","../../../../chunks/mat4f64","../../../../geometry/support/aaBoundingBox","../../webgl-engine/lib/Object3DStateID","./graphicUtils","./featureExpressionInfoUtils"],(function(e,t,n,i,s,a,o,r,h){"use strict";let l=function(){function s(e,t,n,i){this.graphics3DSymbolLayer=e,this.instanceIndex=t,this.elevationAligner=n,this.elevationContext=i,this.type="lod-instance",this.alignedSampledElevation=0,this.isElevationSource=!1,this.needsElevationUpdates=!1}var l=s.prototype;return l.initialize=function(){},l.setVisibility=function(e){const t=this.lodRenderer.instanceData;e!==t.getVisible(this.instanceIndex)&&t.setVisible(this.instanceIndex,e)},l.destroy=function(){null!=this.instanceIndex&&(this.lodRenderer.instanceData.removeInstance(this.instanceIndex),this.graphics3DSymbolLayer.notifyDestroyGraphicLayer(this))},l.alignWithElevation=function(e,t,n){if(this.elevationAligner){h.setContextFeature(this.elevationContext.featureExpressionInfoContext,n);const i=this.elevationAligner(this,this.elevationContext,e,t);null!=i&&(this.alignedSampledElevation=i)}},l.getBSRadius=function(){const e=this.lodRenderer;return e.baseBoundingSphere.radius*e.instanceData.getCombinedMaxScaleFactor(this.instanceIndex)},l.getCenterObjectSpace=function(e=n.create()){return this.lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,f),i.transformMat4(e,this.lodRenderer.baseBoundingSphere.center,f)},l.getBoundingBoxObjectSpace=function(e=a.create()){this.lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,f);const t=this.lodRenderer.baseBoundingBox;a.empty(e);for(let n=0;n<8;++n)i.set(d,0==(1&n)?t[0]:t[3],0==(2&n)?t[1]:t[4],0==(4&n)?t[2]:t[5]),i.transformMat4(d,d,f),a.expandWithVec3(e,d);return e},l.computeAttachmentOrigin=function(e){this.lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,f),e.render.origin[0]+=f[12],e.render.origin[1]+=f[13],e.render.origin[2]+=f[14],e.render.num++},l.getProjectedBoundingBox=async function(e,n,s,o,h){const l=this.getBoundingBoxObjectSpace(h),m=u,x=a.isPoint(l)?1:m.length;this.lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,f);for(let t=0;t<x;t++){const e=m[t];d[0]=l[e[0]],d[1]=l[e[1]],d[2]=l[e[2]],i.transformMat4(d,d,f),c[3*t+0]=d[0],c[3*t+1]=d[1],c[3*t+2]=d[2]}if(!e(c,0,x))return null;a.empty(l);let p=null;this.calculateRelativeScreenBounds&&(p=this.calculateRelativeScreenBounds());for(let t=0;t<3*x;t+=3){for(let e=0;e<3;e++)l[e]=Math.min(l[e],c[t+e]),l[e+3]=Math.max(l[e+3],c[t+e]);p&&s.push({location:c.slice(t,t+3),screenSpaceBoundingRect:p})}if(n&&(a.center(l,g),"absolute-height"!==this.elevationContext.mode)){let e;const i=r.demResolutionForBoundingBox(l,n);try{e=await n.service.queryElevation(g[0],g[1],o,i,"ground")}catch(b){}t.isSome(e)&&a.offset(l,0,0,-this.alignedSampledElevation+e)}return l},l.addObjectState=function(e,t){if(0===e){const n=new o.Object3DStateID(e);this.addHighlightId(n),t.addExternal((e=>{this.removeHighlightId(e)}),n)}},l.removeObjectState=function(e){this.highlights&&this.highlights.forEach((t=>e.remove(t)))},l.addHighlightId=function(e){this.highlights=this.highlights||new Set,this.highlights.add(e),this.lodRenderer.instanceData.setHighlight(this.instanceIndex,!0)},l.removeHighlightId=function(e){this.highlights&&(this.highlights.delete(e),this.lodRenderer.instanceData.setHighlight(this.instanceIndex,this.highlights.size>0),0===this.highlights.size&&(this.highlights=null))},e._createClass(s,[{key:"lodRenderer",get:function(){return this.graphics3DSymbolLayer.lodRenderer}}]),s}();const c=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],d=n.create(),g=n.create(),u=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],f=s.create();return l}));
