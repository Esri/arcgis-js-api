/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/vec3f64","../../../../chunks/vec3","../../../../chunks/mat4f64","../../../../geometry/support/aaBoundingBox","../../webgl-engine/lib/Object3DStateSet","./graphicUtils","./featureExpressionInfoUtils"],(function(e,t,n,i,s,a,o,r){"use strict";let h=function(){function i(e,t,n,i){this.graphics3DSymbolLayer=e,this.instanceIndex=t,this.elevationAligner=n,this.elevationContext=i,this.type="lod-instance",this.alignedSampledElevation=0,this.isElevationSource=!1,this.needsElevationUpdates=!1}var h=i.prototype;return h.initialize=function(){},h.setVisibility=function(e){const t=this.lodRenderer.instanceData;e!==t.getVisible(this.instanceIndex)&&t.setVisible(this.instanceIndex,e)},h.destroy=function(){null!=this.instanceIndex&&(this.lodRenderer.instanceData.removeInstance(this.instanceIndex),this.graphics3DSymbolLayer.notifyDestroyGraphicLayer(this))},h.alignWithElevation=function(e,t,n){if(this.elevationAligner){r.setContextFeature(this.elevationContext.featureExpressionInfoContext,n);const i=this.elevationAligner(this,this.elevationContext,e,t);null!=i&&(this.alignedSampledElevation=i)}},h.getBSRadius=function(){const e=this.lodRenderer;return e.baseBoundingSphere.radius*e.instanceData.getCombinedMaxScaleFactor(this.instanceIndex)},h.getCenterObjectSpace=function(e=t.create()){return this.lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,u),n.transformMat4(e,this.lodRenderer.baseBoundingSphere.center,u)},h.getBoundingBoxObjectSpace=function(e=s.create()){this.lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,u);const t=this.lodRenderer.baseBoundingBox;s.empty(e);for(let i=0;i<8;++i)n.set(c,0==(1&i)?t[0]:t[3],0==(2&i)?t[1]:t[4],0==(4&i)?t[2]:t[5]),n.transformMat4(c,c,u),s.expandWithVec3(e,c);return e},h.computeAttachmentOrigin=function(e){this.lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,u),e.render.origin[0]+=u[12],e.render.origin[1]+=u[13],e.render.origin[2]+=u[14],e.render.num++},h.getProjectedBoundingBox=async function(e,t,i,a,r){const h=this.getBoundingBoxObjectSpace(r),f=g,m=s.isPoint(h)?1:f.length;this.lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,u);for(let e=0;e<m;e++){const t=f[e];c[0]=h[t[0]],c[1]=h[t[1]],c[2]=h[t[2]],n.transformMat4(c,c,u),l[3*e+0]=c[0],l[3*e+1]=c[1],l[3*e+2]=c[2]}if(!e(l,0,m))return null;s.empty(h);let x=null;this.calculateRelativeScreenBounds&&(x=this.calculateRelativeScreenBounds());for(let e=0;e<3*m;e+=3){for(let t=0;t<3;t++)h[t]=Math.min(h[t],l[e+t]),h[t+3]=Math.max(h[t+3],l[e+t]);x&&i.push({location:l.slice(e,e+3),screenSpaceBoundingRect:x})}if(t&&(s.center(h,d),"absolute-height"!==this.elevationContext.mode)){let e;const n=o.demResolutionForBoundingBox(h,t);try{e=await t.service.queryElevation(d[0],d[1],a,n,"ground")}catch(t){e=null}null!=e&&s.offset(h,0,0,-this.alignedSampledElevation+e)}return h},h.addObjectState=function(e,t){if(0===e){const n=a.generateObject3DStateId(e);this.addHighlightId(n),t.addExternal((e=>{this.removeHighlightId(e)}),n)}},h.removeObjectState=function(e){this.highlights&&this.highlights.forEach((t=>e.remove(t)))},h.addHighlightId=function(e){this.highlights=this.highlights||new Set,this.highlights.add(e),this.lodRenderer.instanceData.setHighlight(this.instanceIndex,!0)},h.removeHighlightId=function(e){this.highlights&&(this.highlights.delete(e),this.lodRenderer.instanceData.setHighlight(this.instanceIndex,this.highlights.size>0),0===this.highlights.size&&(this.highlights=null))},e._createClass(i,[{key:"lodRenderer",get:function(){return this.graphics3DSymbolLayer.lodRenderer}}]),i}();const l=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],c=t.create(),d=t.create(),g=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],u=i.create();return h}));
