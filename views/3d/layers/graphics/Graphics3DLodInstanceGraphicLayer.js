/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../chunks/mat4f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/support/aaBoundingBox","./elevationAlignmentUtils","./featureExpressionInfoUtils","./graphicUtils","../../webgl-engine/lib/basicInterfaces","../../webgl-engine/lib/Object3DStateID"],(function(e,t,n,i,s,a,o,r,l,c,h){"use strict";let d=function(){function n(e,t,n,i){this.graphics3DSymbolLayer=e,this.instanceIndex=t,this.elevationAligner=n,this.elevationContext=i,this.type="lod-instance",this._highlights=new Set,this.alignedSampledElevation=0,this.isElevationSource=!1,this.needsElevationUpdates=!1}var d=n.prototype;return d.initialize=function(){},d.setVisibility=function(e){const t=this._lodRenderer.instanceData;e!==t.getVisible(this.instanceIndex)&&t.setVisible(this.instanceIndex,e)},d.destroy=function(){null!=this.instanceIndex&&(this._lodRenderer.instanceData.removeInstance(this.instanceIndex),this.graphics3DSymbolLayer.notifyDestroyGraphicLayer(this))},d.alignWithElevation=function(e,n,i){if(this.elevationAligner){r.setContextFeature(this.elevationContext.featureExpressionInfoContext,i);const s=(t,i)=>o.evaluateElevationInfoAtPoint(t,e,this.elevationContext,n,i),a=this.elevationAligner(this,this.elevationContext,e.spatialReference,s,n);t.isSome(a)&&(this.alignedSampledElevation=a)}},d.getCenterObjectSpace=function(e=s.create()){return this._lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,p),i.transformMat4(e,this._lodRenderer.baseBoundingSphere.center,p)},d.getBoundingBoxObjectSpace=function(e=a.create()){this._lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,p);const t=this._lodRenderer.baseBoundingBox;a.empty(e);for(let n=0;n<8;++n)i.set(u,0==(1&n)?t[0]:t[3],0==(2&n)?t[1]:t[4],0==(4&n)?t[2]:t[5]),i.transformMat4(u,u,p),a.expandWithVec3(e,u);return e},d.computeAttachmentOrigin=function(e){this._lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,p),e.render.origin[0]+=p[12],e.render.origin[1]+=p[13],e.render.origin[2]+=p[14],e.render.num++},d.getProjectedBoundingBox=function(){var n=e._asyncToGenerator((function*(e,n,s,o,r){const c=this.getBoundingBoxObjectSpace(r),h=m,d=a.isPoint(c)?1:h.length;this._lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,p);for(let t=0;t<d;t++){const e=h[t];u[0]=c[e[0]],u[1]=c[e[1]],u[2]=c[e[2]],i.transformMat4(u,u,p),g[3*t+0]=u[0],g[3*t+1]=u[1],g[3*t+2]=u[2]}if(!e(g,0,d))return null;a.empty(c);let v=null;this.calculateRelativeScreenBounds&&(v=this.calculateRelativeScreenBounds());for(let t=0;t<3*d;t+=3){for(let e=0;e<3;e++)c[e]=Math.min(c[e],g[t+e]),c[e+3]=Math.max(c[e+3],g[t+e]);v&&s.push({location:g.slice(t,t+3),screenSpaceBoundingRect:v})}if(n&&(a.center(c,f),"absolute-height"!==this.elevationContext.mode)){let e;const i=l.demResolutionForBoundingBox(c,n.service.spatialReference,n);try{e=yield n.service.queryElevation(f[0],f[1],o,i,"ground")}catch(x){}t.isSome(e)&&a.offset(c,0,0,-this.alignedSampledElevation+e)}return c}));function s(e,t,i,s,a){return n.apply(this,arguments)}return s}(),d.addObjectState=function(e,t){if(e===c.Object3DState.Highlight){const n=new h.Object3DStateID(e);this._addHighlightId(n),t.addExternal((e=>{this._removeHighlightId(e)}),n)}},d.removeObjectState=function(e){this._highlights.forEach((t=>e.remove(t)))},d._addHighlightId=function(e){this._highlights.add(e),this._lodRenderer.instanceData.setHighlight(this.instanceIndex,!0)},d._removeHighlightId=function(e){this._highlights.delete(e),this._lodRenderer.instanceData.setHighlight(this.instanceIndex,this._highlights.size>0)},e._createClass(n,[{key:"_lodRenderer",get:function(){return this.graphics3DSymbolLayer.lodRenderer}}]),n}();const g=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],u=s.create(),f=s.create(),m=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],p=n.create();return d}));
