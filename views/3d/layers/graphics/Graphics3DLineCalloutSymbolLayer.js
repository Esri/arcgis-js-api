/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../Color","../../../../core/maybe","../../../../core/screenUtils","./ElevationAligners","./elevationAlignmentUtils","./ElevationContext","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolLayer","./graphicUtils","./pointUtils","./symbolComplexity","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/Material","../../webgl-engine/materials/LineCalloutMaterial"],(function(e,t,n,a,i,r,o,l,s,c,u,d,p,m,h,f){"use strict";let y=function(e){function c(t,n){var a;return(a=e.call(this,t,null,n,x)||this)._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},a.ensureDrapedStatus(!1),a}t._inheritsLoose(c,e);var y=c.prototype;return y.doLoad=function(){var e=t._asyncToGenerator((function*(){this._material=new f.LineCalloutMaterial(this.materialParameters),this._context.stage.add(this._material)}));function n(){return e.apply(this,arguments)}return n}(),y.destroy=function(){e.prototype.destroy.call(this),this._context.stage.remove(this._material),this._material=null},y.perInstanceMaterialParameters=function(e){const t=this.materialParameters;return t.screenOffset=e.screenOffset||[0,0],t.centerOffsetUnits=e.centerOffsetUnits||"world",t},y._defaultElevationInfoNoZ=function(){return C},y.createGraphics3DGraphic=function(e){const t=e.renderingInfo,n=e.graphic,i=this.setGraphicElevationContext(n,new l.ElevationContext,t.elevationOffset||0),r=t.symbol,o="on-the-ground"===this._elevationContext.mode&&("cim"===r.type||!r.symbolLayers.some((e=>"object"===e.type||"text"===e.type)));if("label-3d"!==r.type&&o)return null;const s=u.computeCentroid(n.geometry);return a.isNone(s)?null:this._createAs3DShape(s,i,t,n.uid)},y.layerOpacityChanged=function(){return a.isNone(this._material)||this._material.setParameterValues(this.materialParameters),!0},y.layerElevationInfoChanged=function(e,t,n){const i=this._elevationContext.mode,r=o.elevationModeChangeUpdateType(c.elevationModeChangeTypes,n,i);return r!==o.SymbolUpdateType.UPDATE||e.forEach((e=>{const n=t(e);a.isSome(n)&&this.updateGraphicElevationContext(e.graphic,n)})),r},y.slicePlaneEnabledChanged=function(){return a.isNone(this._material)||this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0},y.physicalBasedRenderingChanged=function(){return!0},y.pixelRatioChanged=function(){return!0},y.setGraphicElevationContext=function(t,n,a=0){const i=e.prototype.setGraphicElevationContext.call(this,t,n);return i.addOffsetRenderUnits(a),i},y.updateGraphicElevationContext=function(e,t){this.setGraphicElevationContext(e,t.elevationContext,t.metadata.elevationOffset),t.needsElevationUpdates=o.needsElevationUpdates2D(t.elevationContext.mode)},y.updateGeometry=function(e,t){return!1},y.computeComplexity=function(){return{primitivesPerFeature:2,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:p.emptySymbolComplexity.memory}},y.createVertexData=function(e){const{translation:t,centerOffset:n}=e;return[["position",t?{size:3,data:[t[0],t[1],t[2]],exclusive:!0}:{size:3,data:[0,0,0],exclusive:!0}],["normal",{size:3,data:[0,0,1],exclusive:!0}],["auxpos1",n?{size:4,data:[n[0],n[1],n[2],n[3]],exclusive:!0}:{size:4,data:[0,0,0,1],exclusive:!0}]]},y._getOrCreateMaterial=function(e){const t=this.perInstanceMaterialParameters(e),n=f.LineCalloutMaterial.uniqueMaterialIdentifier(t);if(a.isSome(this._material)&&n===this._material.uniqueMaterialIdentifier)return{material:this._material,isUnique:!1};if(e.materialCollection){let i=e.materialCollection.get(n);return a.isNone(i)&&(i=new f.LineCalloutMaterial(t),e.materialCollection.add(n,i)),{material:i,isUnique:!1}}return{material:new f.LineCalloutMaterial(t),isUnique:!0}},y._createAs3DShape=function(e,t,n,a){const i=[new m.Geometry(this.createVertexData(n),g,1)],l=this._getOrCreateMaterial(n),c=d.createStageObjectForHUD(this._context,e,i,[l.material],null,null,t,this._context.layer.uid,a);if(null===c)return null;const u=r.perObjectElevationAligner,p=new s.Graphics3DObject3DGraphicLayer(this,c.object,i,l.isUnique?[l.material]:null,null,u,t);return p.metadata={elevationOffset:n.elevationOffset||0},p.alignedSampledElevation=c.sampledElevation,p.needsElevationUpdates=o.needsElevationUpdates2D(t.mode),d.extendPointGraphicElevationContext(p,e,this._context.elevationProvider),p},t._createClass(c,[{key:"materialParameters",get:function(){const e=this.symbol,t=e.callout,r=a.isSome(t.color)?n.toUnitRGBA(t.color):[0,0,0,0];r[3]*=this._getLayerOpacity();const o=i.pt2px(t.size||0);let l=null;if(e.verticalOffset){const{screenLength:t,minWorldLength:n,maxWorldLength:a}=e.verticalOffset;l={screenLength:i.pt2px(t),minWorldLength:n||0,maxWorldLength:null!=a?a:1/0}}const s=a.isSome(t.border)&&a.isSome(t.border.color)?n.toUnitRGBA(t.border.color):null,c="object"===e.symbolLayers.getItemAt(0).type,u=!c,d=c?0:void 0,p="label-3d"===e.type;return{color:r,size:o,verticalOffset:l,screenSizePerspective:this._context.screenSizePerspectiveEnabled?this._context.sharedResources.screenSizePerspectiveSettings:null,screenOffset:[0,0],centerOffsetUnits:"world",borderColor:s,occlusionTest:u,shaderPolygonOffset:d,depthHUDAlignStart:p,slicePlaneEnabled:this._context.slicePlaneEnabled,renderOccluded:h.materialParametersDefaults.renderOccluded}}}]),c}(c.Graphics3DSymbolLayer);y.elevationModeChangeTypes={definedChanged:o.SymbolUpdateType.UPDATE,staysOnTheGround:o.SymbolUpdateType.UPDATE,onTheGroundChanged:o.SymbolUpdateType.RECREATE};const v=new Uint16Array([0]),g=[["position",v],["normal",v],["auxpos1",v]],C={mode:"relative-to-ground",offset:0},x={ignoreDrivers:!0,renderPriority:0,renderPriorityStep:1};e.Graphics3DLineCalloutSymbolLayer=y,e.default=y,Object.defineProperty(e,"__esModule",{value:!0})}));
