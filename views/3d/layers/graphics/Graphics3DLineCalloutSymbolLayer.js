/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../Color","../../../../core/maybe","../../../../core/screenUtils","../../../../chunks/vec2f64","../../../../chunks/vec3f64","../../../../chunks/vec4f64","../../../../symbols/callouts/calloutUtils","./ElevationAligners","./elevationAlignmentUtils","./ElevationContext","./Graphics3DGraphicCreationContext","./Graphics3DObject3DGraphicLayer","./Graphics3DObjectMetadata","./Graphics3DSymbolLayer","./graphicUtils","./pointUtils","./symbolComplexity","../../webgl-engine/lib/Attribute","../../webgl-engine/lib/ContentObjectType","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/VertexAttribute","../../webgl-engine/materials/LineCalloutMaterial"],(function(e,t,n,i,r,a,o,l,s,c,u,h,d,p,m,f,y,b,g,C,v,x,O,_){"use strict";let S=function(e){function o(t,n){var i;return(i=e.call(this,t,null,n,U)||this)._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},i.ensureDrapedStatus(!1),i}t._inheritsLoose(o,e);var l=o.prototype;return l.doLoad=function(){var e=t._asyncToGenerator((function*(){this._material=new _.LineCalloutMaterial(this._materialParameters),this._context.stage.add(this._material)}));function n(){return e.apply(this,arguments)}return n}(),l.destroy=function(){e.prototype.destroy.call(this),this._context.stage.remove(this._material),this._material=null},l._perInstanceMaterialParameters=function(e){const t=this._materialParameters;return t.screenOffset=e.screenOffset||a.ZEROS,t.centerOffsetUnits=e.centerOffsetUnits||"world",t},l._defaultElevationInfoNoZ=function(){return L},l.createGraphics3DGraphic=function(e){const t=e.renderingInfo,n=e.graphic,r=this.setGraphicElevationContext(n,new h.ElevationContext,t.elevationOffset||0),a=t.symbol,o="on-the-ground"===this._elevationContext.mode&&("cim"===a.type||!a.symbolLayers.some((e=>"object"===e.type||"text"===e.type)));if("label-3d"!==a.type&&o)return null;if("point-3d"===a.type&&a.symbolLayers.every((e=>"text"===e.type&&!s.textSymbolLayerSupportsVerticalOffset(e))))return null;const l=y.computeCentroid(n.geometry);return i.isNone(l)?null:this._createAs3DShape(l,r,t,n.uid)},l.layerOpacityChanged=function(){i.isSome(this._material)&&this._material.setParameters(this._materialParameters)},l.layerElevationInfoChanged=function(e,t,n){const r=this._elevationContext.mode,a=u.elevationModeChangeUpdateType(o.elevationModeChangeTypes,n,r);return a!==u.SymbolUpdateType.UPDATE||e.forEach((e=>{const n=t(e);i.isSome(n)&&this.updateGraphicElevationContext(e.graphic,n)})),a},l.slicePlaneEnabledChanged=function(){return i.isNone(this._material)||this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0},l.physicalBasedRenderingChanged=function(){return!0},l.pixelRatioChanged=function(){return!0},l.skipHighSymbolLodsChanged=function(){return!0},l.setGraphicElevationContext=function(t,n,i=0){const r=e.prototype.setGraphicElevationContext.call(this,t,n);return r.addOffsetRenderUnits(i),r},l.updateGraphicElevationContext=function(e,t){this.setGraphicElevationContext(e,t.elevationContext,i.isSome(t.metadata)?t.metadata.elevationOffset:0),t.needsElevationUpdates=u.needsElevationUpdates2D(t.elevationContext.mode)},l.computeComplexity=function(){return{primitivesPerFeature:2,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:g.emptySymbolComplexity.memory}},l._createVertexData=function(e){const{translation:t,centerOffset:n}=e,i=t?new C.Attribute([t[0],t[1],t[2]],3,!0):new C.Attribute([0,0,0],3,!0),r=n?new C.Attribute([n[0],n[1],n[2],n[3]],4,!0):new C.Attribute([0,0,0,1],4,!0);return[[O.VertexAttribute.POSITION,i],[O.VertexAttribute.NORMAL,new C.Attribute([0,0,1],3,!0)],[O.VertexAttribute.AUXPOS1,r]]},l._getOrCreateMaterial=function(e){const t=this._perInstanceMaterialParameters(e),n=_.LineCalloutMaterial.uniqueMaterialIdentifier(t);if(i.isSome(this._material)&&n===this._material.uniqueMaterialIdentifier)return{material:this._material,isUnique:!1};if(i.isSome(e.materialCollection)){let r=e.materialCollection.get(n);return i.isNone(r)&&(r=new _.LineCalloutMaterial(t),e.materialCollection.add(n,r)),{material:r,isUnique:!1}}return{material:new _.LineCalloutMaterial(t),isUnique:!0}},l._createAs3DShape=function(e,t,n,r){const a=this._context.layer.uid,o=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:r,layerUid:a}),l=this._getOrCreateMaterial(n),s=new x.Geometry(l.material,this._createVertexData(n),A,null,v.ContentObjectType.Point,o),h=b.createStageObject(this._context,e,s,t,r);if(i.isNone(h))return null;const d=new p.Graphics3DObject3DGraphicLayer(this,h.object,[s],l.isUnique?[l.material]:null,null,c.perObjectElevationAligner,t);return d.metadata=new m.Graphics3DObjectMetadata(n.elevationOffset),d.alignedSampledElevation=h.sampledElevation,d.needsElevationUpdates=u.needsElevationUpdates2D(t.mode),b.extendPointGraphicElevationContext(d,e,this._context.elevationProvider),d},t._createClass(o,[{key:"_materialParameters",get:function(){const e=new _.Parameters,t=this.symbol,a=t.callout;if(e.color=i.isSome(a.color)?n.toUnitRGBA(a.color):[0,0,0,0],e.color[3]*=this._getLayerOpacity(),e.size=r.pt2px(a.size||0),t.verticalOffset){const{screenLength:n,minWorldLength:a,maxWorldLength:o}=t.verticalOffset;e.verticalOffset={screenLength:r.pt2px(n),minWorldLength:a||0,maxWorldLength:i.isSome(o)?o:1/0}}e.borderColor=i.isSome(a.border)&&i.isSome(a.border.color)?n.toUnitRGBA(a.border.color):null;const o="object"===t.symbolLayers.getItemAt(0).type,l="label-3d"===t.type;return e.occlusionTest=!o,e.shaderPolygonOffset=o?0:void 0,e.depthHUDAlignStart=l,e.hasSlicePlane=this._context.slicePlaneEnabled,e.screenSizePerspective=this._context.screenSizePerspectiveEnabled?this._context.sharedResources.screenSizePerspectiveSettings:null,e}}]),o}(f.Graphics3DSymbolLayer);S.elevationModeChangeTypes={definedChanged:u.SymbolUpdateType.UPDATE,staysOnTheGround:u.SymbolUpdateType.UPDATE,onTheGroundChanged:u.SymbolUpdateType.RECREATE};const P=[0],A=[[O.VertexAttribute.POSITION,P],[O.VertexAttribute.NORMAL,P],[O.VertexAttribute.AUXPOS1,P]],L={mode:"relative-to-ground",offset:0},U={ignoreDrivers:!0,renderPriority:0,renderPriorityStep:1};let E=function(e,t,n=o.create(),i=l.create(),r=a.create(),s="world",c=0,u=null){this.renderer=e,this.symbol=t,this.translation=n,this.centerOffset=i,this.screenOffset=r,this.centerOffsetUnits=s,this.elevationOffset=c,this.materialCollection=u},G=function(e){function n(){return e.apply(this,arguments)||this}return t._inheritsLoose(n,e),n}(d);e.Graphics3DLineCalloutSymbolLayer=S,e.LineCalloutCreationContext=G,e.LineCalloutSymbolLayerRenderingInfo=E,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
