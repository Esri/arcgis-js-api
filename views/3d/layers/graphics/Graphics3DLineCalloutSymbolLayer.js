/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../Color","../../../../core/screenUtils","../../webgl-engine/lib/Util","../../webgl-engine/lib/GeometryData","../../webgl-engine/lib/Material","./graphicUtils","./elevationAlignmentUtils","./ElevationAligners","./ElevationContext","./Graphics3DObject3DGraphicLayer","../../webgl-engine/lib/Geometry","./symbolComplexity","./Graphics3DSymbolLayer","./pointUtils","../../webgl-engine/materials/LineCalloutMaterial"],(function(e,t,n,a,i,r,o,l,s,c,d,u,m,h,p,f,y,g){"use strict";const v=r.VertexAttrConstants;let C=function(e){function r(t,n){var a;return(a=e.call(this,t,null,n,x)||this)._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},a.ensureDrapedStatus(!1),a}t._inheritsLoose(r,e);var f=r.prototype;return f.doLoad=async function(){this._material=new g.LineCalloutMaterial(this.materialParameters,this._getIdHint("_lineCallout_common")),this._context.stage.add(3,this._material)},f.destroy=function(){e.prototype.destroy.call(this),n.isSome(this._material)&&(this._context.stage.remove(3,this._material.id),this._material=null)},f.perInstanceMaterialParameters=function(e){const t=this.materialParameters;return t.screenOffset=e.screenOffset||[0,0],t.centerOffsetUnits=e.centerOffsetUnits||"world",t},f._defaultElevationInfoNoZ=function(){return P},f.createGraphics3DGraphic=function(e){const t=e.renderingInfo,a=e.graphic,i=this.setGraphicElevationContext(a,new u.ElevationContext,t.elevationOffset||0),r=t.symbol,o="on-the-ground"===this._elevationContext.mode&&("cim"===r.type||!r.symbolLayers.some((e=>"object"===e.type||"text"===e.type)));if("label-3d"!==r.type&&o)return null;const l=s.computeCentroid(a.geometry);if(n.isNone(l))return null;const c="graphic"+a.uid;return this._createAs3DShape(l,i,t,c,a.uid)},f.layerOpacityChanged=function(){return n.isNone(this._material)||this._material.setParameterValues(this.materialParameters),!0},f.layerElevationInfoChanged=function(e,t,a){const i=this._elevationContext.mode,o=c.elevationModeChangeUpdateType(r.elevationModeChangeTypes,a,i);return o!==c.SymbolUpdateType.UPDATE||e.forEach((e=>{const a=t(e);n.isSome(a)&&this.updateGraphicElevationContext(e.graphic,a)})),o},f.slicePlaneEnabledChanged=function(){return n.isNone(this._material)||this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0},f.physicalBasedRenderingChanged=function(){return!0},f.pixelRatioChanged=function(){return!0},f.setGraphicElevationContext=function(t,n,a=0){const i=e.prototype.setGraphicElevationContext.call(this,t,n);return i.addOffsetRenderUnits(a),i},f.updateGraphicElevationContext=function(e,t){this.setGraphicElevationContext(e,t.elevationContext,t.metadata.elevationOffset),t.needsElevationUpdates=c.needsElevationUpdates2D(t.elevationContext.mode)},f.updateGeometry=function(e,t){return!1},f.computeComplexity=function(){return{primitivesPerFeature:2,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:p.emptySymbolComplexity.memory}},f.createVertexData=function(e){const{translation:t,centerOffset:n}=e;if(!t&&!n)return O;const a=t?{size:3,data:[t[0],t[1],t[2]]}:O[v.POSITION],i=n?{size:4,data:[n[0],n[1],n[2],n[3]]}:O[v.AUXPOS1];return{[v.POSITION]:a,[v.NORMAL]:O[v.NORMAL],[v.AUXPOS1]:i}},f.getOrCreateMaterial=function(e,t){const a=this.perInstanceMaterialParameters(e),i=g.LineCalloutMaterial.uniqueMaterialIdentifier(a);if(n.isSome(this._material)&&i===this._material.uniqueMaterialIdentifier)return{material:this._material,isUnique:!1};if(e.materialCollection){let n=e.materialCollection.getMaterial(i);return n||(n=new g.LineCalloutMaterial(a,`${t}_lineCallout_shared`),e.materialCollection.addMaterial(i,n)),{material:n,isUnique:!1}}return{material:new g.LineCalloutMaterial(a,`${t}_lineCallout_unique`),isUnique:!0}},f._createAs3DShape=function(e,t,n,a,i){const r=new o.GeometryData(this.createVertexData(n),_,"point"),l=[new h(r,a)],s=this.getOrCreateMaterial(n,a),u=y.createStageObjectForHUD(this._context,e,l,[s.material],null,null,t,a,this._context.layer.uid,i);if(null===u)return null;const p=d.perObjectElevationAligner,f=new m(this,u.object,l,s.isUnique?[s.material]:null,null,p,t);return f.metadata={elevationOffset:n.elevationOffset||0},f.alignedSampledElevation=u.sampledElevation,f.needsElevationUpdates=c.needsElevationUpdates2D(t.mode),y.extendPointGraphicElevationContext(f,e,this._context.elevationProvider),f},t._createClass(r,[{key:"materialParameters",get:function(){const e=this.symbol,t=e.callout,r=n.isSome(t.color)?a.toUnitRGBA(t.color):[0,0,0,0];r[3]*=this._getLayerOpacity();const o=i.pt2px(t.size||0);let s=null;if(e.verticalOffset){const{screenLength:t,minWorldLength:n,maxWorldLength:a}=e.verticalOffset;s={screenLength:i.pt2px(t),minWorldLength:n||0,maxWorldLength:null!=a?a:1/0}}const c=n.isSome(t.border)&&n.isSome(t.border.color)?a.toUnitRGBA(t.border.color):null,d="object"===e.symbolLayers.getItemAt(0).type,u=!d,m=d?0:void 0,h="label-3d"===e.type;return{color:r,size:o,verticalOffset:s,screenSizePerspective:this._context.screenSizePerspectiveEnabled?this._context.sharedResources.screenSizePerspectiveSettings:null,screenOffset:[0,0],centerOffsetUnits:"world",borderColor:c,occlusionTest:u,shaderPolygonOffset:m,depthHUDAlignStart:h,slicePlaneEnabled:this._context.slicePlaneEnabled,renderOccluded:l.materialParametersDefaults.renderOccluded}}}]),r}(f.Graphics3DSymbolLayer);C.elevationModeChangeTypes={definedChanged:c.SymbolUpdateType.UPDATE,staysOnTheGround:c.SymbolUpdateType.UPDATE,onTheGroundChanged:c.SymbolUpdateType.RECREATE};const O={[v.POSITION]:{size:3,data:[0,0,0]},[v.NORMAL]:{size:3,data:[0,0,1]},[v.AUXPOS1]:{size:4,data:[0,0,0,1]}},b=new Uint32Array([0]),_={[v.POSITION]:b,[v.NORMAL]:b,[v.AUXPOS1]:b},P={mode:"relative-to-ground",offset:0},x={ignoreDrivers:!0,renderPriority:0,renderPriorityStep:1};e.Graphics3DLineCalloutSymbolLayer=C,e.default=C,Object.defineProperty(e,"__esModule",{value:!0})}));
