/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../Color","../../../../core/maybe","../../../../core/screenUtils","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../chunks/vec4f64","../../../../geometry/projection","../../../../geometry/support/aaBoundingBox","../../../../symbols/support/ObjectSymbol3DLayerResource","../../../../symbols/support/symbolLayerUtils3D","./ElevationAligners","./elevationAlignmentUtils","./ElevationContext","./Graphics3DLodInstanceGraphicLayer","./Graphics3DSymbolLayer","./graphicUtils","./lodResourceUtils","./objectResourceUtils","./pointUtils","./primitiveObjectSymbolUtils","./symbolComplexity","../support/FastSymbolUpdates","../../webgl-engine/lib/lodRendering/LodRenderer","../../webgl-engine/lib/lodRendering/LodResources","../../webgl-engine/materials/DefaultMaterial"],(function(e,t,s,r,i,a,o,n,c,l,h,d,u,p,m,y,f,_,b,g,P,v,S,R,x,L,E,C,U){"use strict";let O=function(e){function o(t,s,r,i){var a;return(a=e.call(this,t,s,r,i)||this)._resources=null,a._optionalFields=new Array,a._instanceIndexToGraphicUid=new Map,a.hasLoadedPBRTextures=!1,a.ensureDrapedStatus(!1),a.hasLoadedPBRTextures=r.physicalBasedRenderingEnabled,a}t._inheritsLoose(o,e);var b=o.prototype;return b.getCachedSize=function(){const[e,t,s]=r.isSome(this._resources)?this._resources.symbolSize:[1,1,1];return{width:e,depth:t,height:s}},b.doLoad=function(){var e=t._asyncToGenerator((function*(e){if(!this._drivenProperties.size){if(g.validateSymbolLayerSize(this.symbolLayer))throw new Error}const t=this.symbolLayer;if(this.isPrimitive){const s=t.resource?t.resource.primitive:u.defaultPrimitive;this._resources=yield this._createResourcesForPrimitive(s,e)}else this._resources=yield this._createResourcesForUrl(t.resource.href,e);this.layerOpacityChanged(),this.slicePlaneEnabledChanged(),this.physicalBasedRenderingChanged(),this.complexity=this.computeComplexity()}));function s(t){return e.apply(this,arguments)}return s}(),b.setMaterialTransparencyParams=function(e,t=r.get(this.symbolLayer,"material","color")){const s=this._getCombinedOpacity(t),i=s<1||this.needsDrivenTransparentPass;return e.transparent=i,e.opacity=s,e.cullFace=i?0:2,e},b._createResourcesForPrimitive=function(){var e=t._asyncToGenerator((function*(e,t){if(!R.isValidPrimitive(e))throw new Error(`Unknown object symbol primitive: ${e}`);const a=this.symbolLayer,o=d.create(p.objectSymbolLayerPrimitiveBoundingBox(e)),h=c.fromArray(d.size(o)),u=c.fromArray(p.objectSymbolLayerSizeWithResourceSize(h,a)),m=n.length(u),y=!1,f=!1,_={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,instanced:["transformation"],ambient:c.ONES,diffuse:c.ONES,slicePlaneEnabled:this._context.slicePlaneEnabled,sliceHighlightDisabled:!0,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!this.symbolLayer.isPrimitive},b=_.usePBR;this.setMaterialTransparencyParams(_);const g=this.symbol;if("point-3d"===g.type&&g.verticalOffset){const{screenLength:e,minWorldLength:t,maxWorldLength:s}=g.verticalOffset;_.verticalOffset={screenLength:i.pt2px(e),minWorldLength:t||0,maxWorldLength:null!=s?s:1/0},_.castShadows=!1}if(this._context.screenSizePerspectiveEnabled&&(_.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),this._drivenProperties.color)_.externalColor=l.ONES;else{const e=r.isSome(a.material)&&a.material.color,t=r.isSome(e)?s.toUnitRGBA(e):l.ONES;_.externalColor=t}this._fastUpdates=L.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions(o,u,h,r.none)),this._fastUpdates.enabled?(Object.assign(_,this._fastUpdates.materialParameters),_.instanced.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(_.instanced.push("color"),this._optionalFields.push("color"));const P=new U.DefaultMaterial(_),v=R.primitiveLodResources(e,P);if(!v)throw new Error(`Unknown object symbol primitive: ${e}`);const S=C.materialsFromLodResources(v).map((e=>({opacity:1,transparent:e.params.transparent}))),x=this._createStageResources(v,b);return{lodResources:v,lodRenderer:yield this._createLodRenderer(v,t),stageResources:x,symbolSize:u,extentPadding:m,isEsriSymbolResource:y,isWosr:f,originalMaterialParameters:S,physicalBasedRenderingEnabled:b,resourceBoundingBox:o,resourceSize:h,dispose:r.none,pivotOffset:r.none}}));function a(t,s){return e.apply(this,arguments)}return a}(),b._createResourcesForUrl=function(){var e=t._asyncToGenerator((function*(e,t){const s=["transformation"],a={materialParamsMixin:{instanced:s,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},streamDataRequester:this._context.streamDataRequester,cache:this._context.sharedResources.objectResourceCache};this._fastUpdates=L.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions(r.none,r.none,r.none,r.none)),this._fastUpdates.enabled?(Object.assign(a.materialParamsMixin,this._fastUpdates.materialParameters),s.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(s.push("color"),this._optionalFields.push("color"));const o=this.symbol;if("point-3d"===o.type&&o.verticalOffset){const{screenLength:e,minWorldLength:t,maxWorldLength:s}=o.verticalOffset;a.materialParamsMixin.verticalOffset={screenLength:i.pt2px(e),minWorldLength:t||0,maxWorldLength:null!=s?s:1/0},a.materialParamsMixin.castShadows=!1}a.signal=t,a.usePBR=this._context.physicalBasedRenderingEnabled;const l=a.usePBR,h=yield v.fetch(e,a),u=h.isEsriSymbolResource,m=h.isWosr,y=h.remove,f=P.makeLodResources(h.lods);P.fillEstimatedMinScreenSpaceRadius(f),f.levels.sort(((e,t)=>e.minScreenSpaceRadius-t.minScreenSpaceRadius)),f.levels[0].minScreenSpaceRadius=Math.min(2,f.levels[0].minScreenSpaceRadius);const _=this._context,b=this.symbolLayer.material,g=this._getExternalColorParameters(b),S=r.get(this.symbolLayer,"material","color"),R=this._getCombinedOpacity(S,{hasIntrinsicColor:!0}),x=this.needsDrivenTransparentPass,E=C.materialsFromLodResources(f),U=C.materialsFromLodResources(f).map((e=>({opacity:e.params.opacity||1,transparent:e.params.transparent})));E.forEach((e=>{const t=e.params;e.setParameterValues(g);const s=t.opacity*R,r=s<1||x||t.transparent;e.setParameterValues({opacity:s,transparent:r}),_.screenSizePerspectiveEnabled&&e.setParameterValues({screenSizePerspective:_.sharedResources.screenSizePerspectiveSettings})}));const O=h.referenceBoundingBox,T=c.fromArray(d.size(O)),G=c.fromArray(f.levels[0].pivotOffset),B=c.fromArray(p.objectSymbolLayerSizeWithResourceSize(T,this.symbolLayer)),w=n.length(B);L.updateFastSymbolUpdatesState(this._fastUpdates,this._context.renderer,this._fastVisualVariableConvertOptions(O,B,T,G))&&E.forEach((e=>e.setParameterValues(this._fastUpdates.materialParameters)));const z=this._createStageResources(f,l);return{lodResources:f,lodRenderer:yield this._createLodRenderer(f,t),stageResources:z,symbolSize:B,extentPadding:w,isEsriSymbolResource:u,isWosr:m,originalMaterialParameters:U,physicalBasedRenderingEnabled:l,resourceBoundingBox:O,resourceSize:T,dispose:y,pivotOffset:G}}));function s(t,s){return e.apply(this,arguments)}return s}(),b._createStageResources=function(e,t){const s=this._context.stage,r=C.materialsFromLodResources(e);t!==this._context.physicalBasedRenderingEnabled&&this.physicalBasedRenderingChanged(),s.addMany(r);const i=C.texturesFromLodResources(e);s.addMany(i);const a=C.geometriesFromLodResources(e);return s.addMany(a),{materials:r,textures:i,geometries:a}},b._createLodRenderer=function(){var e=t._asyncToGenerator((function*(e,t){const s=this._context.stage,r={layerUid:this._context.layer.uid,graphicUid:e=>this._instanceIndexToGraphicUid.get(e),notifyGraphicGeometryChanged:e=>this._context.notifyGraphicGeometryChanged(this._instanceIndexToGraphicUid.get(e)),notifyGraphicVisibilityChanged:e=>this._context.notifyGraphicVisibilityChanged(this._instanceIndexToGraphicUid.get(e))},i=this._fastUpdates.enabled?{applyTransform:(e,t,s)=>{e.getFeatureAttribute(t,w),a.copy(s,L.evaluateModelTransform(this._fastUpdates.materialParameters,w,s))},scaleFactor:(e,t,s)=>(t.getFeatureAttribute(s,w),L.evaluateModelTransformScale(e,this._fastUpdates.materialParameters,w))}:null,o=new E.LodRenderer(e,this._optionalFields,r,i);return o.slicePlane=this._context.slicePlaneEnabled,yield s.addRenderPlugin(o.slots,o,t),o}));function s(t,s){return e.apply(this,arguments)}return s}(),b._getExternalColorParameters=function(e){const t={};return this._drivenProperties.color?t.externalColor=l.ONES:r.isSome(e)&&r.isSome(e.color)?t.externalColor=s.toUnitRGBA(e.color):(t.externalColor=l.ONES,t.colorMixMode="ignore"),t},b.destroy=function(){e.prototype.destroy.call(this);const t=this._context.stage;if(r.isSome(this._resources)){t.removeRenderPlugin(this._resources.lodRenderer);const e=this._resources.stageResources;t.removeMany(e.materials),t.removeMany(e.textures),t.removeMany(e.geometries),r.isSome(this._resources.dispose)&&this._resources.dispose()}this._resources=null},b.createGraphics3DGraphic=function(e){const t=e.graphic;if(!this._validateGeometry(t.geometry))return null;const s=S.placePointOnGeometry(t.geometry);if(r.isNone(s))return this.logger.warn(`unsupported geometry type for icon symbol: ${t.geometry.type}`),null;const i=this.setGraphicElevationContext(t,new f.ElevationContext),a=e.renderingInfo;return this._createAs3DShape(t,s,a,i,t.uid)},b.notifyDestroyGraphicLayer=function(e){this._instanceIndexToGraphicUid.delete(e.instanceIndex)},b.graphicLayerToGraphicId=function(){return 0},b.layerOpacityChanged=function(){if(r.isNone(this._resources))return!0;const e=this._drivenProperties.opacity,t=!this.isPrimitive,s=this._resources.stageResources.materials,i=this._resources.originalMaterialParameters;for(let a=0;a<s.length;a++){const o=s[a],n=r.get(this.symbolLayer,"material","color"),c=i[a],l=this._getCombinedOpacity(n,{hasIntrinsicColor:t})*c.opacity,h=l<1||e||c.transparent;o.setParameterValues({opacity:l,transparent:h}),this.isPrimitive&&o.setParameterValues({cullFace:h?0:2})}return!0},b.layerElevationInfoChanged=function(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,y.needsElevationUpdates3D)},b.slicePlaneEnabledChanged=function(){if(r.isNone(this._resources))return!0;this._resources.lodRenderer.slicePlane=this._context.slicePlaneEnabled;for(const e of this._resources.stageResources.materials)e.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});return!0},b.physicalBasedRenderingChanged=function(){if(r.isNone(this._resources))return!0;const{stageResources:e,isWosr:t}=this._resources;for(const s of e.materials)this.isPrimitive?s.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}):t||s.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!1});return!1!==this.hasLoadedPBRTextures||!0!==this._context.physicalBasedRenderingEnabled||(this.hasLoadedPBRTextures=!0,!1)},b.pixelRatioChanged=function(){return!0},b.applyRendererDiff=function(e,t){if(r.isNone(this._resources))return!0;const{stageResources:{materials:s},lodRenderer:i,resourceBoundingBox:a,symbolSize:o,resourceSize:n,pivotOffset:c}=this._resources;for(const r in e.diff)switch(r){case"visualVariables":if(!L.updateFastSymbolUpdatesState(this._fastUpdates,t,this._fastVisualVariableConvertOptions(a,o,n,c)))return!1;for(const e of s)e.setParameterValues(this._fastUpdates.materialParameters);i.notifyShaderTransformationChanged();break;default:return!1}return!0},b.computeComplexity=function(){if(r.isNone(this._resources))return e.prototype.computeComplexity.call(this);return{primitivesPerFeature:C.geometriesFromLodLevelResources(this._resources.lodResources.levels[0]).reduce(((e,t)=>e+t.indices.get("position").length),0)/3,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:x.defaultSymbolLayerMemoryComplexity(this.symbol,this.symbolLayer)}},b.hasLodRenderer=function(){return r.isSome(this._resources)},b._createAs3DShape=function(e,t,s,i,a){if(!this.hasLodRenderer()||r.isNone(this._resources))return null;const o=this.getFastUpdateAttrValues(e),n=!this._fastUpdates.enabled&&this._hasPerInstanceColor()?g.mixinColorAndOpacity(s.color,s.opacity):null,c=this._context.clippingExtent;if(h.projectPointToVector(t,T,this._context.elevationProvider.spatialReference),r.isSome(c)&&!d.containsPoint(c,T))return null;const l=this._requiresTerrainElevation(i),u=this._computeGlobalTransform(t,i,B,l?z:null),p=this._computeLocalTransform(this._resources,this.symbolLayer,s,G),f=this._resources.lodRenderer.instanceData,b=f.addInstance();this._instanceIndexToGraphicUid.set(b,a),f.setLocalTransform(b,p,!1),f.setGlobalTransform(b,u),o&&f.setFeatureAttribute(b,o),n&&f.setColor(b,n);const P=m.perLodInstanceElevationAligner,v=new _(this,b,P,i);return l&&(v.alignedSampledElevation=z.sampledElevation),v.needsElevationUpdates=y.needsElevationUpdates3D(i.mode),S.extendPointGraphicElevationContext(v,t,this._context.elevationProvider),v},b._computeGlobalTransform=function(e,t,s,r){const i=y.evaluateElevationAlignmentAtPoint(e,this._context.elevationProvider,t,this._context.renderCoordsHelper,r);return T[0]=e.x,T[1]=e.y,T[2]=i,h.computeLinearTransformation(e.spatialReference,T,s,this._context.renderCoordsHelper.spatialReference),s},b._computeLocalTransform=function(e,t,s,r){return a.identity(r),this._applyObjectRotation(s,!1,r),this._applyObjectRotation(t,!0,r),this._applyObjectScale(e,s,r),this._applyAnchor(e,t,r),r},b._applyObjectScale=function(e,t,s){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const r=this._drivenProperties.size&&t.size?t.size:e.symbolSize,i=g.computeObjectScale(r,e.symbolSize,e.resourceSize,this._context.renderCoordsHelper.unitInMeters);1===i[0]&&1===i[1]&&1===i[2]||a.scale(s,s,i)},b.prepareSymbolLayerPatch=function(e){if("partial"!==e.diff.type)return;const t=e.diff.diff;this._preparePatchTransform(e,t),this._preparePatchColor(e,t)},b.updateGeometry=function(e,t){if(r.isNone(this._resources))return!0;const s=t&&S.placePointOnGeometry(t);if(r.isNone(s))return!1;const i=this.getGeometryElevationMode(t);if(e.elevationContext.mode!==i)return!1;const a=this._requiresTerrainElevation(e.elevationContext);return this._computeGlobalTransform(s,e.elevationContext,B,a?z:null),a&&(e.alignedSampledElevation=z.sampledElevation),this._resources.lodRenderer.instanceData.setGlobalTransform(e.instanceIndex,B,!0),S.extendPointGraphicElevationContext(e,s,this._context.elevationProvider),!0},b._preparePatchTransform=function(e,t){if(!(t.heading||t.tilt||t.roll||t.width||t.height||t.depth||t.anchor||t.anchorPosition))return;if(r.isNone(this._resources))return;const s=(e,t,s)=>r.unwrapOr(null!=e&&"complete"===e.type?e.newValue:t,s),i=s(t.heading,this.symbolLayer.heading,0),a=s(t.tilt,this.symbolLayer.tilt,0),o=s(t.roll,this.symbolLayer.roll,0),n=s(t.width,this.symbolLayer.width,void 0),l=s(t.height,this.symbolLayer.height,void 0),h=s(t.depth,this.symbolLayer.depth,void 0),d=s(t.anchor,this.symbolLayer.anchor,void 0),u=s(t.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete t.heading,delete t.tilt,delete t.roll,delete t.width,delete t.height,delete t.depth,delete t.anchor,delete t.anchorPosition;const m={heading:i,tilt:a,roll:o,anchor:d,anchorPosition:u},y=this._resources;1===this.loadStatus&&e.symbolLayerStatePatches.push((()=>{y.symbolSize=c.fromArray(p.objectSymbolLayerSizeWithResourceSize(y.resourceSize,{width:n,height:l,depth:h,isPrimitive:this.symbolLayer.isPrimitive}))})),e.graphics3DGraphicPatches.push(((e,t)=>{const s=this._computeLocalTransform(y,m,t,G),r=e.instanceIndex;y.lodRenderer.instanceData.setLocalTransform(r,s,!0)}))},b._preparePatchColor=function(e,t){if(!t.material||"partial"!==t.material.type)return;const i=t.material.diff;if(!i.color||"complete"!==i.color.type||null==i.color.newValue||null==i.color.oldValue)return;const a=i.color.newValue,o=r.isSome(a)?s.toUnitRGBA(a):l.ONES;delete i.color;const n=this._resources;r.isNone(n)||e.graphics3DGraphicPatches.push((e=>{let t;this._hasPerInstanceColor()?(n.lodRenderer.instanceData.setColor(e.instanceIndex,o),t=this.setMaterialTransparencyParams({},a)):t=this.setMaterialTransparencyParams({externalColor:o},a);for(const s of n.stageResources.materials)s.setParameterValues(t)}))},b._requiresTerrainElevation=function(e){return"absolute-height"!==e.mode},b._applyObjectRotation=function(e,t,s){if(!(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation&&t))return g.computeObjectRotation(e.heading,e.tilt,e.roll,s)},b._computeAnchor=function(e,t,s){const i=c.create();switch(s.anchor){case"center":n.copy(i,d.center(e)),n.negate(i,i);break;case"top":{const t=d.center(e);n.set(i,-t[0],-t[1],-e[5]);break}case"bottom":{const t=d.center(e);n.set(i,-t[0],-t[1],-e[2]);break}case"relative":{const t=d.center(e),r=d.size(e),a=s.anchorPosition,o=a?c.fromValues(a.x,a.y,a.z):c.ZEROS;n.multiply(i,r,o),n.add(i,i,t),n.negate(i,i);break}case"origin":default:r.isSome(t)?n.negate(i,t):n.copy(i,c.ZEROS)}return i},b._applyAnchor=function(e,t,s){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const r=this._computeAnchor(e.resourceBoundingBox,e.pivotOffset,t);r&&a.translate(s,s,r)},b._hasPerInstanceColor=function(){return this._drivenProperties.color||this._drivenProperties.opacity},b._fastVisualVariableConvertOptions=function(e,t,s,i){const a=r.isSome(e)?c.fromArray(d.size(e)):c.ONES,o=r.isSome(e)?this._computeAnchor(e,i,this.symbolLayer):c.ZEROS,n=this._context.renderCoordsHelper.unitInMeters,l=g.computeObjectScale(r.isSome(t)?t:void 0,t,s,n),h=c.fromValues(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return{modelSize:a,symbolSize:r.isSome(t)?t:c.ONES,unitInMeters:n,transformation:{anchor:o,scale:l,rotation:h}}},t._createClass(o,[{key:"extentPadding",get:function(){return r.isSome(this._resources)?this._resources.extentPadding:0}},{key:"isPrimitive",get:function(){return!(this.symbolLayer.resource&&this.symbolLayer.resource.href)}},{key:"lodRenderer",get:function(){return r.get(this._resources,"lodRenderer")}}]),o}(b.Graphics3DSymbolLayer);const T=c.create(),G=o.create(),B=o.create(),w=l.create(),z={verticalDistanceToGround:0,sampledElevation:0};e.Graphics3DObjectSymbolLayer=O,e.default=O,Object.defineProperty(e,"__esModule",{value:!0})}));
