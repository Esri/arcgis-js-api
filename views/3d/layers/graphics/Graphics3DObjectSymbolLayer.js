/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../Color","../../../../core/screenUtils","../../../../symbols/support/ObjectSymbol3DLayerResource","../../../../chunks/vec3f64","../../../../chunks/vec3","../../../../chunks/mat4","../../../../geometry/projection","../../../../chunks/mat4f64","../../../../chunks/vec4f64","../../../../geometry/support/aaBoundingBox","./graphicUtils","./elevationAlignmentUtils","./ElevationAligners","./ElevationContext","./primitiveObjectSymbolUtils","../../webgl-engine/lib/lodRendering/LodResources","./symbolComplexity","./Graphics3DSymbolLayer","./pointUtils","../../webgl-engine/materials/DefaultMaterial","../support/FastSymbolUpdates","../../../../symbols/support/symbolLayerUtils3D","./Graphics3DLodInstanceGraphicLayer","./lodResourceUtils","./objectResourceUtils","../../webgl-engine/lib/lodRendering/LodRenderer"],(function(e,t,s,r,i,o,a,n,c,l,h,d,u,m,p,y,f,_,b,g,S,P,v,R,x,L,E,C,U){"use strict";let O=function(e){function h(t,s,r,i){var o;return(o=e.call(this,t,s,r,i)||this)._resources=null,o._optionalFields=[],o._instanceIndexToGraphicUid=new Map,o.hasLoadedPBRTextures=!1,o.ensureDrapedStatus(!1),o.hasLoadedPBRTextures=r.physicalBasedRenderingEnabled,o}t._inheritsLoose(h,e);var S=h.prototype;return S.getCachedSize=function(){const[e,t,r]=s.isSome(this._resources)?this._resources.symbolSize:[1,1,1];return{width:e,depth:t,height:r}},S.doLoad=async function(e){if(!this._drivenProperties.size){if(m.validateSymbolLayerSize(this.symbolLayer))throw new Error}const t=this.symbolLayer;if(this.isPrimitive){const e=t.resource?t.resource.primitive:o.defaultPrimitive;this._resources=this._createResourcesForPrimitive(e)}else this._resources=await this._createResourcesForUrl(t.resource.href,e);this.complexity=this.computeComplexity()},S.setMaterialTransparencyParams=function(e,t=s.get(this.symbolLayer,"material","color")){const r=this._getCombinedOpacity(t),i=r<1||this.needsDrivenTransparentPass;return e.transparent=i,e.opacity=r,e},S._createResourcesForPrimitive=function(e){if(!_.isValidPrimitive(e))throw new Error(`Unknown object symbol primitive: ${e}`);const t=this.symbolLayer,o=u.create(x.objectSymbolLayerPrimitiveBoundingBox(e)),c=a.fromArray(u.size(o)),l=a.fromArray(x.objectSymbolLayerSizeWithResourceSize(c,t)),h=n.length(l),m=!1,p=!1,y={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,instanced:["transformation"],ambient:a.ONES,diffuse:a.ONES,slicePlaneEnabled:this._context.slicePlaneEnabled,sliceHighlightDisabled:!0,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!this.symbolLayer.isPrimitive},f=y.usePBR;this.setMaterialTransparencyParams(y);const g=this.symbol;if("point-3d"===g.type&&g.verticalOffset){const{screenLength:e,minWorldLength:t,maxWorldLength:s}=g.verticalOffset;y.verticalOffset={screenLength:i.pt2px(e),minWorldLength:t||0,maxWorldLength:null!=s?s:1/0},y.castShadows=!1}if(this._context.screenSizePerspectiveEnabled&&(y.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),this._drivenProperties.color)y.externalColor=d.ONES;else{const e=s.isSome(t.material)&&t.material.color,i=s.isSome(e)?r.toUnitRGBA(e):d.ONES;y.externalColor=i}this._fastUpdates=R.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions(o,l,c,s.none)),this._fastUpdates.enabled?(Object.assign(y,this._fastUpdates.materialParameters),y.instanced.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(y.instanced.push("color"),this._optionalFields.push("color"));const S=new v.DefaultMaterial(y),P=_.primitiveLodResources(e,S);if(!P)throw new Error(`Unknown object symbol primitive: ${e}`);const L=b.materialsFromLodResources(P).map((e=>({opacity:1,transparent:e.params.transparent}))),E=this._createStageResources(P,f);return{lodResources:P,lodRenderer:this._createLodRenderer(P),stageResources:E,symbolSize:l,extentPadding:h,isEsriSymbolResource:m,isWosr:p,originalMaterialParameters:L,physicalBasedRenderingEnabled:f,resourceBoundingBox:o,resourceSize:c,dispose:s.none,pivotOffset:s.none}},S._createResourcesForUrl=async function(e,t){const r=["transformation"],o={materialParamsMixin:{instanced:r,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},streamDataRequester:this._context.streamDataRequester,cache:this._context.sharedResources.objectResourceCache};this._fastUpdates=R.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions(s.none,s.none,s.none,s.none)),this._fastUpdates.enabled?(Object.assign(o.materialParamsMixin,this._fastUpdates.materialParameters),r.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(r.push("color"),this._optionalFields.push("color"));const c=this.symbol;if("point-3d"===c.type&&c.verticalOffset){const{screenLength:e,minWorldLength:t,maxWorldLength:s}=c.verticalOffset;o.materialParamsMixin.verticalOffset={screenLength:i.pt2px(e),minWorldLength:t||0,maxWorldLength:null!=s?s:1/0},o.materialParamsMixin.castShadows=!1}o.signal=t,o.usePBR=this._context.physicalBasedRenderingEnabled;const l=o.usePBR,h=await C.fetch(e,o),d=h.isEsriSymbolResource,m=h.isWosr,p=h.remove,y=E.makeLodResources(h.lods);E.fillEstimatedMinScreenSpaceRadius(y),y.levels.sort(((e,t)=>e.minScreenSpaceRadius-t.minScreenSpaceRadius)),y.levels[0].minScreenSpaceRadius=Math.min(2,y.levels[0].minScreenSpaceRadius);const f=this._context,_=this.symbolLayer.material,g=this._getExternalColorParameters(_),S=s.get(this.symbolLayer,"material","color"),P=this._getCombinedOpacity(S,{hasIntrinsicColor:!0}),v=this.needsDrivenTransparentPass,L=b.materialsFromLodResources(y),U=b.materialsFromLodResources(y).map((e=>{const t=e.params;return{opacity:t.opacity||1,transparent:t.transparent}}));L.forEach((e=>{const t=e.params;e.setParameterValues(g);const s=t.opacity*P,r=s<1||v||t.transparent;e.setParameterValues({opacity:s,transparent:r}),f.screenSizePerspectiveEnabled&&e.setParameterValues({screenSizePerspective:f.sharedResources.screenSizePerspectiveSettings})}));const O=h.referenceBoundingBox,T=a.fromArray(u.size(O)),G=a.fromArray(y.levels[0].pivotOffset),B=a.fromArray(x.objectSymbolLayerSizeWithResourceSize(T,this.symbolLayer)),w=n.length(B);R.updateFastSymbolUpdatesState(this._fastUpdates,this._context.renderer,this._fastVisualVariableConvertOptions(O,B,T,G))&&L.forEach((e=>e.setParameterValues(this._fastUpdates.materialParameters)));const z=this._createStageResources(y,l);return{lodResources:y,lodRenderer:this._createLodRenderer(y),stageResources:z,symbolSize:B,extentPadding:w,isEsriSymbolResource:d,isWosr:m,originalMaterialParameters:U,physicalBasedRenderingEnabled:l,resourceBoundingBox:O,resourceSize:T,dispose:p,pivotOffset:G}},S._createStageResources=function(e,t){const s=this._context.stage,r=b.materialsFromLodResources(e);t!==this._context.physicalBasedRenderingEnabled&&this.physicalBasedRenderingChanged(),s.addMany(r);const i=b.texturesFromLodResources(e);s.addMany(i);const o=b.geometriesFromLodResources(e);return s.addMany(o),{materials:r,textures:i,geometries:o}},S._createLodRenderer=function(e){const t=this._context.stage,s={layerUid:this._context.layer.uid,graphicUid:e=>this._instanceIndexToGraphicUid.get(e),notifyGraphicGeometryChanged:e=>this._context.notifyGraphicGeometryChanged(this._instanceIndexToGraphicUid.get(e)),notifyGraphicVisibilityChanged:e=>this._context.notifyGraphicVisibilityChanged(this._instanceIndexToGraphicUid.get(e))},r=this._fastUpdates.enabled?{applyTransform:(e,t,s)=>{e.getFeatureAttribute(t,w),c.copy(s,R.evaluateModelTransform(this._fastUpdates.materialParameters,w,s))},scaleFactor:(e,t,s)=>(t.getFeatureAttribute(s,w),R.evaluateModelTransformScale(e,this._fastUpdates.materialParameters,w))}:null,i=new U.LodRenderer(e,this._optionalFields,s,r);return i.slicePlane=this._context.slicePlaneEnabled,t.addRenderPlugin(i.slots,i),i},S._getExternalColorParameters=function(e){const t={};return this._drivenProperties.color?t.externalColor=d.ONES:s.isSome(e)&&s.isSome(e.color)?t.externalColor=r.toUnitRGBA(e.color):(t.externalColor=d.ONES,t.colorMixMode="ignore"),t},S.destroy=function(){e.prototype.destroy.call(this);const t=this._context.stage;if(s.isSome(this._resources)){t.removeRenderPlugin(this._resources.lodRenderer),this._resources.lodRenderer.destroy();const e=this._resources.stageResources;t.removeMany(e.materials),t.removeMany(e.textures),t.removeMany(e.geometries),s.isSome(this._resources.dispose)&&this._resources.dispose()}this._resources=null},S.createGraphics3DGraphic=function(e){const t=e.graphic;if(!this._validateGeometry(t.geometry))return null;const r=P.placePointOnGeometry(t.geometry);if(s.isNone(r))return this.logger.warn(`unsupported geometry type for icon symbol: ${t.geometry.type}`),null;const i=this.setGraphicElevationContext(t,new f.ElevationContext),o=e.renderingInfo;return this._createAs3DShape(t,r,o,i,t.uid)},S.notifyDestroyGraphicLayer=function(e){this._instanceIndexToGraphicUid.delete(e.instanceIndex)},S.graphicLayerToGraphicId=function(){return 0},S.layerOpacityChanged=function(){if(s.isNone(this._resources))return!0;const e=this._drivenProperties.opacity,t=!this.isPrimitive,r=this._resources.stageResources.materials,i=this._resources.originalMaterialParameters;for(let o=0;o<r.length;o++){const a=r[o],n=s.get(this.symbolLayer,"material","color"),c=i[o],l=this._getCombinedOpacity(n,{hasIntrinsicColor:t})*c.opacity;a.setParameterValues({opacity:l,transparent:l<1||e||c.transparent})}return!0},S.layerElevationInfoChanged=function(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,p.needsElevationUpdates3D)},S.slicePlaneEnabledChanged=function(){if(s.isNone(this._resources))return!0;this._resources.lodRenderer.slicePlane=this._context.slicePlaneEnabled;for(const e of this._resources.stageResources.materials)e.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});return!0},S.physicalBasedRenderingChanged=function(){if(s.isNone(this._resources))return!0;const{stageResources:e,isWosr:t}=this._resources;for(const s of e.materials)this.isPrimitive?s.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}):t||s.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!1});return!1!==this.hasLoadedPBRTextures||!0!==this._context.physicalBasedRenderingEnabled||(this.hasLoadedPBRTextures=!0,!1)},S.pixelRatioChanged=function(){return!0},S.applyRendererDiff=function(e,t){if(s.isNone(this._resources))return!0;const{stageResources:{materials:r},lodRenderer:i,resourceBoundingBox:o,symbolSize:a,resourceSize:n,pivotOffset:c}=this._resources;for(const s in e.diff)switch(s){case"visualVariables":if(!R.updateFastSymbolUpdatesState(this._fastUpdates,t,this._fastVisualVariableConvertOptions(o,a,n,c)))return!1;for(const e of r)e.setParameterValues(this._fastUpdates.materialParameters);i.notifyShaderTransformationChanged();break;default:return!1}return!0},S.computeComplexity=function(){if(s.isNone(this._resources))return e.prototype.computeComplexity.call(this);return{primitivesPerFeature:b.geometriesFromLodLevelResources(this._resources.lodResources.levels[0]).reduce(((e,t)=>e+t.indices.get("position").length),0)/3,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:g.defaultSymbolLayerMemoryComplexity(this.symbol,this.symbolLayer)}},S.hasLodRenderer=function(){return s.isSome(this._resources)},S._createAs3DShape=function(e,t,r,i,o){if(!this.hasLodRenderer()||s.isNone(this._resources))return null;const a=this.getFastUpdateAttrValues(e),n=!this._fastUpdates.enabled&&this._hasPerInstanceColor()?m.mixinColorAndOpacity(r.color,r.opacity):null,c=this._context.clippingExtent;if(l.projectPointToVector(t,T,this._context.elevationProvider.spatialReference),s.isSome(c)&&!u.containsPoint(c,T))return null;const h=this._requiresTerrainElevation(i),d=this._computeGlobalTransform(t,i,B,h?z:null),f=this._computeLocalTransform(this._resources,this.symbolLayer,r,G),_=this._resources.lodRenderer.instanceData,b=_.addInstance();this._instanceIndexToGraphicUid.set(b,o),_.setLocalTransform(b,f,!1),_.setGlobalTransform(b,d),a&&_.setFeatureAttribute(b,a),n&&_.setColor(b,n);const g=y.perLodInstanceElevationAligner,S=new L(this,b,g,i);return h&&(S.alignedSampledElevation=z.sampledElevation),S.needsElevationUpdates=p.needsElevationUpdates3D(i.mode),P.extendPointGraphicElevationContext(S,t,this._context.elevationProvider),S},S._computeGlobalTransform=function(e,t,s,r){const i=p.evaluateElevationAlignmentAtPoint(e,this._context.elevationProvider,t,this._context.renderCoordsHelper,r);return T[0]=e.x,T[1]=e.y,T[2]=i,l.computeLinearTransformation(e.spatialReference,T,s,this._context.renderCoordsHelper.spatialReference),s},S._computeLocalTransform=function(e,t,s,r){return c.identity(r),this._applyObjectRotation(s,!1,r),this._applyObjectRotation(t,!0,r),this._applyObjectScale(e,s,r),this._applyAnchor(e,t,r),r},S._applyObjectScale=function(e,t,s){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const r=this._drivenProperties.size&&t.size?t.size:e.symbolSize,i=m.computeObjectScale(r,e.symbolSize,e.resourceSize,this._context.renderCoordsHelper.unitInMeters);1===i[0]&&1===i[1]&&1===i[2]||c.scale(s,s,i)},S.prepareSymbolLayerPatch=function(e){if("partial"!==e.diff.type)return;const t=e.diff.diff;this._preparePatchTransform(e,t),this._preparePatchColor(e,t)},S.updateGeometry=function(e,t){if(s.isNone(this._resources))return!0;const r=t&&P.placePointOnGeometry(t);if(s.isNone(r))return!1;const i=this.getGeometryElevationMode(t);if(e.elevationContext.mode!==i)return!1;const o=this._requiresTerrainElevation(e.elevationContext);return this._computeGlobalTransform(r,e.elevationContext,B,o?z:null),o&&(e.alignedSampledElevation=z.sampledElevation),this._resources.lodRenderer.instanceData.setGlobalTransform(e.instanceIndex,B,!0),P.extendPointGraphicElevationContext(e,r,this._context.elevationProvider),!0},S._preparePatchTransform=function(e,t){if(!(t.heading||t.tilt||t.roll||t.width||t.height||t.depth||t.anchor||t.anchorPosition))return;if(s.isNone(this._resources))return;const r=(e,t,r)=>s.unwrapOr(null!=e&&"complete"===e.type?e.newValue:t,r),i=r(t.heading,this.symbolLayer.heading,0),o=r(t.tilt,this.symbolLayer.tilt,0),n=r(t.roll,this.symbolLayer.roll,0),c=r(t.width,this.symbolLayer.width,void 0),l=r(t.height,this.symbolLayer.height,void 0),h=r(t.depth,this.symbolLayer.depth,void 0),d=r(t.anchor,this.symbolLayer.anchor,void 0),u=r(t.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete t.heading,delete t.tilt,delete t.roll,delete t.width,delete t.height,delete t.depth,delete t.anchor,delete t.anchorPosition;const m={heading:i,tilt:o,roll:n,anchor:d,anchorPosition:u},p=this._resources;1===this.loadStatus&&e.symbolLayerStatePatches.push((()=>{p.symbolSize=a.fromArray(x.objectSymbolLayerSizeWithResourceSize(p.resourceSize,{width:c,height:l,depth:h,isPrimitive:this.symbolLayer.isPrimitive}))})),e.graphics3DGraphicPatches.push(((e,t)=>{const s=this._computeLocalTransform(p,m,t,G),r=e.instanceIndex;p.lodRenderer.instanceData.setLocalTransform(r,s,!0)}))},S._preparePatchColor=function(e,t){if(!t.material||"partial"!==t.material.type)return;const i=t.material.diff;if(!i.color||"complete"!==i.color.type||null==i.color.newValue||null==i.color.oldValue)return;const o=i.color.newValue,a=s.isSome(o)?r.toUnitRGBA(o):d.ONES;delete i.color;const n=this._resources;s.isNone(n)||e.graphics3DGraphicPatches.push((e=>{let t;this._hasPerInstanceColor()?(n.lodRenderer.instanceData.setColor(e.instanceIndex,a),t=this.setMaterialTransparencyParams({},o)):t=this.setMaterialTransparencyParams({externalColor:a},o);for(const s of n.stageResources.materials)s.setParameterValues(t)}))},S._requiresTerrainElevation=function(e){return"absolute-height"!==e.mode},S._applyObjectRotation=function(e,t,s){if(!(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation&&t))return m.computeObjectRotation(e.heading,e.tilt,e.roll,s)},S._computeAnchor=function(e,t,r){const i=a.create();switch(r.anchor){case"center":n.copy(i,u.center(e)),n.negate(i,i);break;case"top":{const t=u.center(e);n.set(i,-t[0],-t[1],-e[5]);break}case"bottom":{const t=u.center(e);n.set(i,-t[0],-t[1],-e[2]);break}case"relative":{const t=u.center(e),s=u.size(e),o=r.anchorPosition,c=o?a.fromValues(o.x,o.y,o.z):a.ZEROS;n.multiply(i,s,c),n.add(i,i,t),n.negate(i,i);break}case"origin":default:s.isSome(t)?n.negate(i,t):n.copy(i,a.ZEROS)}return i},S._applyAnchor=function(e,t,s){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const r=this._computeAnchor(e.resourceBoundingBox,e.pivotOffset,t);r&&c.translate(s,s,r)},S._hasPerInstanceColor=function(){return this._drivenProperties.color||this._drivenProperties.opacity},S._fastVisualVariableConvertOptions=function(e,t,r,i){const o=s.isSome(e)?a.fromArray(u.size(e)):a.ONES,n=s.isSome(e)?this._computeAnchor(e,i,this.symbolLayer):a.ZEROS,c=this._context.renderCoordsHelper.unitInMeters,l=m.computeObjectScale(s.isSome(t)?t:void 0,t,r,c),h=a.fromValues(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return{modelSize:o,symbolSize:s.isSome(t)?t:a.ONES,unitInMeters:c,transformation:{anchor:n,scale:l,rotation:h}}},t._createClass(h,[{key:"extentPadding",get:function(){return s.isSome(this._resources)?this._resources.extentPadding:0}},{key:"isPrimitive",get:function(){return!(this.symbolLayer.resource&&this.symbolLayer.resource.href)}},{key:"lodRenderer",get:function(){return s.get(this._resources,"lodRenderer")}}]),h}(S.Graphics3DSymbolLayer);const T=a.create(),G=h.create(),B=h.create(),w=d.create(),z={verticalDistanceToGround:0,sampledElevation:0};e.Graphics3DObjectSymbolLayer=O,e.default=O,Object.defineProperty(e,"__esModule",{value:!0})}));
