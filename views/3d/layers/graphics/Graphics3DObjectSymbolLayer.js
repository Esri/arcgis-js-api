/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import e from"../../../../Color.js";import{isSome as t,get as s,none as r,isNone as a,unwrapOr as i}from"../../../../core/maybe.js";import{pt2px as o}from"../../../../core/screenUtils.js";import{c as n,i as c,h as l,j as h}from"../../../../chunks/mat4.js";import{c as d}from"../../../../chunks/mat4f64.js";import{l as p,o as m,c as u,E as y,a as f,s as _}from"../../../../chunks/vec3.js";import{d as b,O as g,Z as P,f as R,c as v}from"../../../../chunks/vec3f64.js";import{O as x,c as S}from"../../../../chunks/vec4f64.js";import{projectPointToVector as L,computeTranslationToOriginAndRotation as C}from"../../../../geometry/projection.js";import{create as w,size as E,containsPoint as U,center as j}from"../../../../geometry/support/aaBoundingBox.js";import{defaultPrimitive as B}from"../../../../symbols/support/ObjectSymbol3DLayerResource.js";import{objectSymbolLayerPrimitiveBoundingBox as T,objectSymbolLayerSizeWithResourceSize as G}from"../../../../symbols/support/symbolLayerUtils3D.js";import{perLodInstanceElevationAligner as O}from"./ElevationAligners.js";import{needsElevationUpdates3D as D,evaluateElevationInfoAtPoint as I,SampleElevationInfo as z}from"./elevationAlignmentUtils.js";import{ElevationContext as M}from"./ElevationContext.js";import A from"./Graphics3DLodInstanceGraphicLayer.js";import{Graphics3DSymbolLayer as F}from"./Graphics3DSymbolLayer.js";import{validateSymbolLayerSize as V,mixinColorAndOpacity as k,computeObjectScale as W,computeObjectRotation as H}from"./graphicUtils.js";import{ApplyRendererDiffResult as q}from"./interfaces.js";import{LoadStatus as N}from"./Loadable.js";import{makeLodResources as $,fillEstimatedMinScreenSpaceRadius as Z}from"./lodResourceUtils.js";import{fetch as J}from"./objectResourceUtils.js";import{placePointOnGeometry as K,extendPointGraphicElevationContext as Q}from"./pointUtils.js";import{isValidPrimitive as X,primitiveLodResources as Y}from"./primitiveObjectSymbolUtils.js";import{defaultSymbolLayerMemoryComplexity as ee}from"./symbolComplexity.js";import{initFastSymbolUpdatesState as te,updateFastSymbolUpdatesState as se,evaluateModelTransform as re,evaluateModelTransformScale as ae}from"../support/FastSymbolUpdates.js";import{CullFaceOptions as ie}from"../../webgl-engine/lib/basicInterfaces.js";import{VertexAttribute as oe}from"../../webgl-engine/lib/VertexAttribute.js";import{LodRenderer as ne}from"../../webgl-engine/lib/lodRendering/LodRenderer.js";import{materialsFromLodResources as ce,texturesFromLodResources as le,geometriesFromLodResources as he,geometriesFromLodLevelResources as de}from"../../webgl-engine/lib/lodRendering/LodResources.js";import{DefaultMaterial as pe}from"../../webgl-engine/materials/DefaultMaterial.js";class me extends F{constructor(e,t,s,r){super(e,t,s,r),this._resources=null,this._optionalFields=new Array,this._instanceIndexToGraphicUid=new Map,this.hasLoadedPBRTextures=!1,this._disposeResourceHandles=new Array,this.ensureDrapedStatus(!1),this.hasLoadedPBRTextures=s.physicalBasedRenderingEnabled}getCachedSize(){const[e,s,r]=t(this._resources)?this._resources.symbolSize:[1,1,1];return{width:e,depth:s,height:r}}async doLoad(e){if(!this._drivenProperties.size){if(V(this.symbolLayer))throw new Error}const t=this.symbolLayer;if(this.isPrimitive){const s=t.resource?t.resource.primitive:B;this._resources=await this._createResourcesForPrimitive(s,e)}else this._resources=await this._createResourcesForUrl(t.resource.href,e);this.layerOpacityChanged(),this.slicePlaneEnabledChanged(),this.physicalBasedRenderingChanged(),this.complexity=this.computeComplexity()}get extentPadding(){return t(this._resources)?this._resources.extentPadding:0}get isPrimitive(){return!(this.symbolLayer.resource&&this.symbolLayer.resource.href)}get lodRenderer(){return s(this._resources,"lodRenderer")}_setMaterialTransparencyParams(e,t=s(this.symbolLayer,"material","color")){const r=this._getCombinedOpacity(t),a=r<1||this.needsDrivenTransparentPass;return e.transparent=a,e.opacity=r,e.cullFace=a?ie.None:ie.Back,e}async _createResourcesForPrimitive(s,a){if(!X(s))throw new Error(`Unknown object symbol primitive: ${s}`);const i=this.symbolLayer,n=w(T(s)),c=b(E(n)),l=b(G(c,i)),h=p(l),d=!1,m=!1,u={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,ambient:g,diffuse:g,hasSlicePlane:this._context.slicePlaneEnabled,hasSliceHighlight:!1,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!this.symbolLayer.isPrimitive},y=u.usePBR;this._setMaterialTransparencyParams(u);const f=this.symbol;if("point-3d"===f.type&&f.verticalOffset){const{screenLength:e,minWorldLength:t,maxWorldLength:s}=f.verticalOffset;u.verticalOffset={screenLength:o(e),minWorldLength:t||0,maxWorldLength:null!=s?s:1/0},u.castShadows=!1}if(this._context.screenSizePerspectiveEnabled&&(u.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),this._drivenProperties.color)u.externalColor=x;else{const s=t(i.material)&&i.material.color,r=t(s)?e.toUnitRGBA(s):x;u.externalColor=r}this._fastUpdates=te(this._context.renderer,this._fastVisualVariableConvertOptions(n,l,c,r)),u.instanced=["transformation"],this._fastUpdates.enabled?(Object.assign(u,this._fastUpdates.materialParameters),u.instanced.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(u.instanced.push("color"),this._optionalFields.push("color"));const _=new pe(u),P=Y(s,_);if(!P)throw new Error(`Unknown object symbol primitive: ${s}`);const R=ce(P).map((e=>({opacity:1,transparent:e.parameters.transparent}))),v=await this._createStageResources(P,y);return{lodResources:P,lodRenderer:await this._createLodRenderer(P,a),stageResources:v,symbolSize:l,extentPadding:h,isEsriSymbolResource:d,isWosr:m,originalMaterialParameters:R,physicalBasedRenderingEnabled:y,resourceBoundingBox:n,resourceSize:c,pivotOffset:r}}async _createResourcesForUrl(e,t){const a=["transformation"],i={materialParamsMixin:{instanced:a,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},streamDataRequester:this._context.streamDataRequester,cache:this._context.sharedResources.objectResourceCache};this._fastUpdates=te(this._context.renderer,this._fastVisualVariableConvertOptions(r,r,r,r)),this._fastUpdates.enabled?(Object.assign(i.materialParamsMixin,this._fastUpdates.materialParameters),a.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(a.push("color"),this._optionalFields.push("color"));const n=this.symbol;if("point-3d"===n.type&&n.verticalOffset){const{screenLength:e,minWorldLength:t,maxWorldLength:s}=n.verticalOffset;i.materialParamsMixin.verticalOffset={screenLength:o(e),minWorldLength:t||0,maxWorldLength:null!=s?s:1/0},i.materialParamsMixin.castShadows=!1}i.signal=t,i.usePBR=this._context.physicalBasedRenderingEnabled;const c=i.usePBR,l=await J(e,i),h=l.isEsriSymbolResource,d=l.isWosr;this._addDisposeResource((()=>l.remove()));const m=$(l.lods);Z(m),m.levels.sort(((e,t)=>e.minScreenSpaceRadius-t.minScreenSpaceRadius)),m.levels[0].minScreenSpaceRadius=Math.min(2,m.levels[0].minScreenSpaceRadius);const u=this._context,y=this.symbolLayer.material,f=this._getExternalColorParameters(y),_=s(this.symbolLayer,"material","color"),g=this._getCombinedOpacity(_,{hasIntrinsicColor:!0}),P=this.needsDrivenTransparentPass,R=ce(m),v=ce(m).map((e=>({opacity:e.parameters.opacity||1,transparent:e.parameters.transparent})));R.forEach((e=>{const t=e.parameters;e.setParameters(f);const s=t.opacity*g,r=s<1||P||t.transparent;e.setParameters({opacity:s,transparent:r}),u.screenSizePerspectiveEnabled&&e.setParameters({screenSizePerspective:u.sharedResources.screenSizePerspectiveSettings})}));const x=l.referenceBoundingBox,S=b(E(x)),L=b(m.levels[0].pivotOffset),C=b(G(S,this.symbolLayer)),w=p(C);se(this._fastUpdates,this._context.renderer,this._fastVisualVariableConvertOptions(x,C,S,L))&&R.forEach((e=>e.setParameters(this._fastUpdates.materialParameters)));const U=await this._createStageResources(m,c);return{lodResources:m,lodRenderer:await this._createLodRenderer(m,t),stageResources:U,symbolSize:C,extentPadding:w,isEsriSymbolResource:h,isWosr:d,originalMaterialParameters:v,physicalBasedRenderingEnabled:c,resourceBoundingBox:x,resourceSize:S,pivotOffset:L}}_addDisposeResource(e){this._disposeResourceHandles.push(e)}async _createStageResources(e,t){const s=this._context.stage,r=ce(e);t!==this._context.physicalBasedRenderingEnabled&&this.physicalBasedRenderingChanged(),s.addMany(r),this._addDisposeResource((()=>s.removeMany(r)));const a=le(e);s.addMany(a),this._addDisposeResource((()=>s.removeMany(a))),await s.load(a);const i=he(e);return s.addMany(i),this._addDisposeResource((()=>s.removeMany(i))),{materials:r,textures:a,geometries:i}}async _createLodRenderer(e,t){const s=this._context.stage,r={layerUid:this._context.layer.uid,graphicUid:e=>this._instanceIndexToGraphicUid.get(e),notifyGraphicGeometryChanged:e=>this._context.notifyGraphicGeometryChanged(this._instanceIndexToGraphicUid.get(e)),notifyGraphicVisibilityChanged:e=>this._context.notifyGraphicVisibilityChanged(this._instanceIndexToGraphicUid.get(e))},a=this._fastUpdates.enabled?{applyTransform:(e,t,s)=>{e.getFeatureAttribute(t,_e),n(s,re(this._fastUpdates.materialParameters,_e,s))},scaleFactor:(e,t,s)=>(t.getFeatureAttribute(s,_e),ae(e,this._fastUpdates.materialParameters,_e))}:null,i=new ne(e,this._optionalFields,r,a);return i.slicePlaneEnabled=this._context.slicePlaneEnabled,this._addDisposeResource((()=>{s.removeRenderPlugin(i)})),await s.addRenderPlugin(i.slots,i,t),i}_getExternalColorParameters(s){const r={};return this._drivenProperties.color?r.externalColor=x:t(s)&&t(s.color)?r.externalColor=e.toUnitRGBA(s.color):(r.externalColor=x,r.colorMixMode="ignore"),r}destroy(){super.destroy(),this._cleanupResources()}_cleanupResources(){this._disposeResourceHandles.forEach((e=>e())),this._disposeResourceHandles.length=0,this._resources=null}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry))return null;const s=K(t.geometry);if(a(s))return this.logger.warn(`unsupported geometry type for icon symbol: ${t.geometry.type}`),null;const r=this.setGraphicElevationContext(t,new M),i=e.renderingInfo;return this._createAs3DShape(t,s,i,r,t.uid)}notifyDestroyGraphicLayer(e){this._instanceIndexToGraphicUid.delete(e.instanceIndex)}graphicLayerToGraphicId(){return 0}layerOpacityChanged(){if(a(this._resources))return!0;const e=this._drivenProperties.opacity,t=!this.isPrimitive,r=this._resources.stageResources.materials,i=this._resources.originalMaterialParameters;for(let a=0;a<r.length;a++){const o=r[a],n=s(this.symbolLayer,"material","color"),c=i[a],l=this._getCombinedOpacity(n,{hasIntrinsicColor:t})*c.opacity,h=l<1||e||c.transparent;o.setParameters({opacity:l,transparent:h}),this.isPrimitive&&o.setParameters({cullFace:h?ie.None:ie.Back})}return!0}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,D)}slicePlaneEnabledChanged(){if(a(this._resources))return!0;this._resources.lodRenderer.slicePlaneEnabled=this._context.slicePlaneEnabled;for(const e of this._resources.stageResources.materials)e.setParameters({hasSlicePlane:this._context.slicePlaneEnabled});return!0}physicalBasedRenderingChanged(){if(a(this._resources))return!0;const{stageResources:e,isWosr:t}=this._resources;for(const s of e.materials)this.isPrimitive?s.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}):t||s.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!1});return!1!==this.hasLoadedPBRTextures||!0!==this._context.physicalBasedRenderingEnabled||(this.hasLoadedPBRTextures=!0,!1)}pixelRatioChanged(){return!0}applyRendererDiff(e,t){if(a(this._resources))return q.Recreate_Symbol;const{stageResources:{materials:s},lodRenderer:r,resourceBoundingBox:i,symbolSize:o,resourceSize:n,pivotOffset:c}=this._resources;for(const a in e.diff){if("visualVariables"!==a)return q.Recreate_Symbol;if(!se(this._fastUpdates,t,this._fastVisualVariableConvertOptions(i,o,n,c)))return q.Recreate_Symbol;for(const e of s)e.setParameters(this._fastUpdates.materialParameters);r.notifyShaderTransformationChanged()}return q.Fast_Update}computeComplexity(){if(a(this._resources))return super.computeComplexity();return{primitivesPerFeature:de(this._resources.lodResources.levels[0]).reduce(((e,t)=>e+t.indices.get(oe.POSITION).length),0)/3,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:ee(this.symbol,this.symbolLayer)}}_hasLodRenderer(){return t(this._resources)}_createAs3DShape(e,s,r,i,o){if(!this._hasLodRenderer()||a(this._resources))return null;const n=this.getFastUpdateAttrValues(e),c=!this._fastUpdates.enabled&&this._hasPerInstanceColor()?k(r.color,r.opacity):null,l=this._context.clippingExtent;if(L(s,ue,this._context.elevationProvider.spatialReference),t(l)&&!U(l,ue))return null;const h=this._requiresTerrainElevation(i),d=this._computeGlobalTransform(s,i,fe,be),p=this._computeLocalTransform(this._resources,this.symbolLayer,r,ye),m=this._resources.lodRenderer.instanceData,u=m.addInstance();this._instanceIndexToGraphicUid.set(u,o),m.setLocalTransform(u,p,!1),m.setGlobalTransform(u,d),n&&m.setFeatureAttribute(u,n),c&&m.setColor(u,c);const y=new A(this,u,O,i);return h&&(y.alignedSampledElevation=be.sampledElevation),y.needsElevationUpdates=D(i.mode),Q(y,s,this._context.elevationProvider),y}_computeGlobalTransform(e,t,s,r){return I(e,this._context.elevationProvider,t,this._context.renderCoordsHelper,r),ue[0]=e.x,ue[1]=e.y,ue[2]=r.z,C(e.spatialReference,ue,s,this._context.renderCoordsHelper.spatialReference),s}_computeLocalTransform(e,t,s,r){return c(r),this._applyObjectRotation(s,!1,r),this._applyObjectRotation(t,!0,r),this._applyObjectScale(e,s,r),this._applyAnchor(e,t,r),r}_applyObjectScale(e,t,s){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const r=this._drivenProperties.size&&t.size?t.size:e.symbolSize,a=W(r,e.symbolSize,e.resourceSize,this._context.renderCoordsHelper.unitInMeters);1===a[0]&&1===a[1]&&1===a[2]||l(s,s,a)}prepareSymbolLayerPatch(e){if("partial"!==e.diff.type)return;const t=e.diff.diff;this._preparePatchTransform(e,t),this._preparePatchColor(e,t)}updateGeometry(e,t){if(a(this._resources))return!0;const s=t&&K(t);if(a(s))return!1;const r=this.getGeometryElevationMode(t);return e.elevationContext.mode===r&&(this._computeGlobalTransform(s,e.elevationContext,fe,be),this._requiresTerrainElevation(e.elevationContext)&&(e.alignedSampledElevation=be.sampledElevation),this._resources.lodRenderer.instanceData.setGlobalTransform(e.instanceIndex,fe,!0),Q(e,s,this._context.elevationProvider),!0)}_preparePatchTransform(e,t){if(!(t.heading||t.tilt||t.roll||t.width||t.height||t.depth||t.anchor||t.anchorPosition))return;if(a(this._resources))return;const s=(e,t,s)=>i(null!=e&&"complete"===e.type?e.newValue:t,s),r=s(t.heading,this.symbolLayer.heading,0),o=s(t.tilt,this.symbolLayer.tilt,0),n=s(t.roll,this.symbolLayer.roll,0),c=s(t.width,this.symbolLayer.width,void 0),l=s(t.height,this.symbolLayer.height,void 0),h=s(t.depth,this.symbolLayer.depth,void 0),d=s(t.anchor,this.symbolLayer.anchor,void 0),p=s(t.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete t.heading,delete t.tilt,delete t.roll,delete t.width,delete t.height,delete t.depth,delete t.anchor,delete t.anchorPosition;const m={heading:r,tilt:o,roll:n,anchor:d,anchorPosition:p},u=this._resources;this.loadStatus===N.LOADED&&e.symbolLayerStatePatches.push((()=>{u.symbolSize=b(G(u.resourceSize,{width:c,height:l,depth:h,isPrimitive:this.symbolLayer.isPrimitive}))})),e.graphics3DGraphicPatches.push(((e,t)=>{const s=this._computeLocalTransform(u,m,t,ye),r=e.instanceIndex;u.lodRenderer.instanceData.setLocalTransform(r,s,!0)}))}_preparePatchColor(s,r){if(!r.material||"partial"!==r.material.type)return;const i=r.material.diff;if(!i.color||"complete"!==i.color.type||null==i.color.newValue||null==i.color.oldValue)return;const o=i.color.newValue,n=t(o)?e.toUnitRGBA(o):x;delete i.color;const c=this._resources;a(c)||s.graphics3DGraphicPatches.push((e=>{let t;this._hasPerInstanceColor()?(c.lodRenderer.instanceData.setColor(e.instanceIndex,n),t=this._setMaterialTransparencyParams({},o)):t=this._setMaterialTransparencyParams({externalColor:n},o);for(const s of c.stageResources.materials)s.setParameters(t)}))}_requiresTerrainElevation(e){return"absolute-height"!==e.mode}_applyObjectRotation(e,t,s){if(!(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation&&t))return H(e.heading,e.tilt,e.roll,s)}_computeAnchor(e,s,r){const a=v();switch(r.anchor){case"center":u(a,j(e)),m(a,a);break;case"top":{const t=j(e);_(a,-t[0],-t[1],-e[5]);break}case"bottom":{const t=j(e);_(a,-t[0],-t[1],-e[2]);break}case"relative":{const t=j(e),s=E(e),i=r.anchorPosition,o=i?R(i.x,i.y,i.z):P;y(a,s,o),f(a,a,t),m(a,a);break}default:t(s)?m(a,s):u(a,P)}return a}_applyAnchor(e,t,s){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const r=this._computeAnchor(e.resourceBoundingBox,e.pivotOffset,t);r&&h(s,s,r)}_hasPerInstanceColor(){return this._drivenProperties.color||this._drivenProperties.opacity}_fastVisualVariableConvertOptions(e,s,r,a){const i=t(e)?b(E(e)):g,o=t(e)?this._computeAnchor(e,a,this.symbolLayer):P,n=this._context.renderCoordsHelper.unitInMeters,c=W(t(s)?s:void 0,s,r,n),l=R(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return{modelSize:i,symbolSize:t(s)?s:g,unitInMeters:n,transformation:{anchor:o,scale:c,rotation:l}}}}const ue=v(),ye=d(),fe=d(),_e=S(),be=new z;export{me as Graphics3DObjectSymbolLayer};
