/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../Color","../../../../core/maybe","../../../../core/screenUtils","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../chunks/vec4f64","../../../../geometry/projection","../../../../geometry/support/aaBoundingBox","../../../../symbols/support/ObjectSymbol3DLayerResource","../../../../symbols/support/symbolLayerUtils3D","./ElevationAligners","./elevationAlignmentUtils","./ElevationContext","./Graphics3DLodInstanceGraphicLayer","./Graphics3DSymbolLayer","./graphicUtils","./lodResourceUtils","./objectResourceUtils","./pointUtils","./primitiveObjectSymbolUtils","./symbolComplexity","../support/FastSymbolUpdates","../../webgl-engine/lib/lodRendering/LodRenderer","../../webgl-engine/lib/lodRendering/LodResources","../../webgl-engine/materials/DefaultMaterial"],(function(e,t,r,s,i,o,a,n,c,l,h,d,u,p,m,y,f,_,b,g,P,S,v,R,x,L,E,C,O){"use strict";let U=function(e){function a(t,r,s,i){var o;return(o=e.call(this,t,r,s,i)||this)._resources=null,o._optionalFields=new Array,o._instanceIndexToGraphicUid=new Map,o.hasLoadedPBRTextures=!1,o.ensureDrapedStatus(!1),o.hasLoadedPBRTextures=s.physicalBasedRenderingEnabled,o}t._inheritsLoose(a,e);var b=a.prototype;return b.getCachedSize=function(){const[e,t,r]=s.isSome(this._resources)?this._resources.symbolSize:[1,1,1];return{width:e,depth:t,height:r}},b.doLoad=function(){var e=t._asyncToGenerator((function*(e){if(!this._drivenProperties.size){if(g.validateSymbolLayerSize(this.symbolLayer))throw new Error}const t=this.symbolLayer;if(this.isPrimitive){const r=t.resource?t.resource.primitive:u.defaultPrimitive;this._resources=yield this._createResourcesForPrimitive(r,e)}else this._resources=yield this._createResourcesForUrl(t.resource.href,e);this.layerOpacityChanged(),this.slicePlaneEnabledChanged(),this.physicalBasedRenderingChanged(),this.complexity=this.computeComplexity()}));function r(t){return e.apply(this,arguments)}return r}(),b.setMaterialTransparencyParams=function(e,t=s.get(this.symbolLayer,"material","color")){const r=this._getCombinedOpacity(t),i=r<1||this.needsDrivenTransparentPass;return e.transparent=i,e.opacity=r,e.cullFace=i?0:2,e},b._createResourcesForPrimitive=function(){var e=t._asyncToGenerator((function*(e,t){if(!R.isValidPrimitive(e))throw new Error(`Unknown object symbol primitive: ${e}`);const o=this.symbolLayer,a=d.create(p.objectSymbolLayerPrimitiveBoundingBox(e)),h=c.fromArray(d.size(a)),u=c.fromArray(p.objectSymbolLayerSizeWithResourceSize(h,o)),m=n.length(u),y=!1,f=!1,_={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,instanced:["transformation"],ambient:c.ONES,diffuse:c.ONES,slicePlaneEnabled:this._context.slicePlaneEnabled,sliceHighlightDisabled:!0,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!this.symbolLayer.isPrimitive},b=_.usePBR;this.setMaterialTransparencyParams(_);const g=this.symbol;if("point-3d"===g.type&&g.verticalOffset){const{screenLength:e,minWorldLength:t,maxWorldLength:r}=g.verticalOffset;_.verticalOffset={screenLength:i.pt2px(e),minWorldLength:t||0,maxWorldLength:null!=r?r:1/0},_.castShadows=!1}if(this._context.screenSizePerspectiveEnabled&&(_.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),this._drivenProperties.color)_.externalColor=l.ONES;else{const e=s.isSome(o.material)&&o.material.color,t=s.isSome(e)?r.toUnitRGBA(e):l.ONES;_.externalColor=t}this._fastUpdates=L.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions(a,u,h,s.none)),this._fastUpdates.enabled?(Object.assign(_,this._fastUpdates.materialParameters),_.instanced.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(_.instanced.push("color"),this._optionalFields.push("color"));const P=new O.DefaultMaterial(_),S=R.primitiveLodResources(e,P);if(!S)throw new Error(`Unknown object symbol primitive: ${e}`);const v=C.materialsFromLodResources(S).map((e=>({opacity:1,transparent:e.parameters.transparent}))),x=yield this._createStageResources(S,b);return{lodResources:S,lodRenderer:yield this._createLodRenderer(S,t),stageResources:x,symbolSize:u,extentPadding:m,isEsriSymbolResource:y,isWosr:f,originalMaterialParameters:v,physicalBasedRenderingEnabled:b,resourceBoundingBox:a,resourceSize:h,dispose:s.none,pivotOffset:s.none}}));function o(t,r){return e.apply(this,arguments)}return o}(),b._createResourcesForUrl=function(){var e=t._asyncToGenerator((function*(e,t){const r=["transformation"],o={materialParamsMixin:{instanced:r,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},streamDataRequester:this._context.streamDataRequester,cache:this._context.sharedResources.objectResourceCache};this._fastUpdates=L.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions(s.none,s.none,s.none,s.none)),this._fastUpdates.enabled?(Object.assign(o.materialParamsMixin,this._fastUpdates.materialParameters),r.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(r.push("color"),this._optionalFields.push("color"));const a=this.symbol;if("point-3d"===a.type&&a.verticalOffset){const{screenLength:e,minWorldLength:t,maxWorldLength:r}=a.verticalOffset;o.materialParamsMixin.verticalOffset={screenLength:i.pt2px(e),minWorldLength:t||0,maxWorldLength:null!=r?r:1/0},o.materialParamsMixin.castShadows=!1}o.signal=t,o.usePBR=this._context.physicalBasedRenderingEnabled;const l=o.usePBR,h=yield S.fetch(e,o),u=h.isEsriSymbolResource,m=h.isWosr,y=h.remove,f=P.makeLodResources(h.lods);P.fillEstimatedMinScreenSpaceRadius(f),f.levels.sort(((e,t)=>e.minScreenSpaceRadius-t.minScreenSpaceRadius)),f.levels[0].minScreenSpaceRadius=Math.min(2,f.levels[0].minScreenSpaceRadius);const _=this._context,b=this.symbolLayer.material,g=this._getExternalColorParameters(b),v=s.get(this.symbolLayer,"material","color"),R=this._getCombinedOpacity(v,{hasIntrinsicColor:!0}),x=this.needsDrivenTransparentPass,E=C.materialsFromLodResources(f),O=C.materialsFromLodResources(f).map((e=>({opacity:e.parameters.opacity||1,transparent:e.parameters.transparent})));E.forEach((e=>{const t=e.parameters;e.setParameters(g);const r=t.opacity*R,s=r<1||x||t.transparent;e.setParameters({opacity:r,transparent:s}),_.screenSizePerspectiveEnabled&&e.setParameters({screenSizePerspective:_.sharedResources.screenSizePerspectiveSettings})}));const U=h.referenceBoundingBox,T=c.fromArray(d.size(U)),G=c.fromArray(f.levels[0].pivotOffset),B=c.fromArray(p.objectSymbolLayerSizeWithResourceSize(T,this.symbolLayer)),z=n.length(B);L.updateFastSymbolUpdatesState(this._fastUpdates,this._context.renderer,this._fastVisualVariableConvertOptions(U,B,T,G))&&E.forEach((e=>e.setParameters(this._fastUpdates.materialParameters)));const w=yield this._createStageResources(f,l);return{lodResources:f,lodRenderer:yield this._createLodRenderer(f,t),stageResources:w,symbolSize:B,extentPadding:z,isEsriSymbolResource:u,isWosr:m,originalMaterialParameters:O,physicalBasedRenderingEnabled:l,resourceBoundingBox:U,resourceSize:T,dispose:y,pivotOffset:G}}));function r(t,r){return e.apply(this,arguments)}return r}(),b._createStageResources=function(){var e=t._asyncToGenerator((function*(e,t){const r=this._context.stage,s=C.materialsFromLodResources(e);t!==this._context.physicalBasedRenderingEnabled&&this.physicalBasedRenderingChanged(),r.addMany(s);const i=C.texturesFromLodResources(e);r.addMany(i),yield r.load(i);const o=C.geometriesFromLodResources(e);return r.addMany(o),{materials:s,textures:i,geometries:o}}));function r(t,r){return e.apply(this,arguments)}return r}(),b._createLodRenderer=function(){var e=t._asyncToGenerator((function*(e,t){const r=this._context.stage,s={layerUid:this._context.layer.uid,graphicUid:e=>this._instanceIndexToGraphicUid.get(e),notifyGraphicGeometryChanged:e=>this._context.notifyGraphicGeometryChanged(this._instanceIndexToGraphicUid.get(e)),notifyGraphicVisibilityChanged:e=>this._context.notifyGraphicVisibilityChanged(this._instanceIndexToGraphicUid.get(e))},i=this._fastUpdates.enabled?{applyTransform:(e,t,r)=>{e.getFeatureAttribute(t,z),o.copy(r,L.evaluateModelTransform(this._fastUpdates.materialParameters,z,r))},scaleFactor:(e,t,r)=>(t.getFeatureAttribute(r,z),L.evaluateModelTransformScale(e,this._fastUpdates.materialParameters,z))}:null,a=new E.LodRenderer(e,this._optionalFields,s,i);return a.slicePlaneEnabled=this._context.slicePlaneEnabled,yield r.addRenderPlugin(a.slots,a,t),a}));function r(t,r){return e.apply(this,arguments)}return r}(),b._getExternalColorParameters=function(e){const t={};return this._drivenProperties.color?t.externalColor=l.ONES:s.isSome(e)&&s.isSome(e.color)?t.externalColor=r.toUnitRGBA(e.color):(t.externalColor=l.ONES,t.colorMixMode="ignore"),t},b.destroy=function(){if(e.prototype.destroy.call(this),s.isSome(this._resources)){const e=this._context.stage;e.removeRenderPlugin(this._resources.lodRenderer);const t=this._resources.stageResources;e.removeMany(t.materials),e.removeMany(t.textures),e.removeMany(t.geometries),s.isSome(this._resources.dispose)&&this._resources.dispose(),this._resources=null}},b.createGraphics3DGraphic=function(e){const t=e.graphic;if(!this._validateGeometry(t.geometry))return null;const r=v.placePointOnGeometry(t.geometry);if(s.isNone(r))return this.logger.warn(`unsupported geometry type for icon symbol: ${t.geometry.type}`),null;const i=this.setGraphicElevationContext(t,new f.ElevationContext),o=e.renderingInfo;return this._createAs3DShape(t,r,o,i,t.uid)},b.notifyDestroyGraphicLayer=function(e){this._instanceIndexToGraphicUid.delete(e.instanceIndex)},b.graphicLayerToGraphicId=function(){return 0},b.layerOpacityChanged=function(){if(s.isNone(this._resources))return!0;const e=this._drivenProperties.opacity,t=!this.isPrimitive,r=this._resources.stageResources.materials,i=this._resources.originalMaterialParameters;for(let o=0;o<r.length;o++){const a=r[o],n=s.get(this.symbolLayer,"material","color"),c=i[o],l=this._getCombinedOpacity(n,{hasIntrinsicColor:t})*c.opacity,h=l<1||e||c.transparent;a.setParameters({opacity:l,transparent:h}),this.isPrimitive&&a.setParameters({cullFace:h?0:2})}return!0},b.layerElevationInfoChanged=function(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,y.needsElevationUpdates3D)},b.slicePlaneEnabledChanged=function(){if(s.isNone(this._resources))return!0;this._resources.lodRenderer.slicePlaneEnabled=this._context.slicePlaneEnabled;for(const e of this._resources.stageResources.materials)e.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled});return!0},b.physicalBasedRenderingChanged=function(){if(s.isNone(this._resources))return!0;const{stageResources:e,isWosr:t}=this._resources;for(const r of e.materials)this.isPrimitive?r.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}):t||r.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!1});return!1!==this.hasLoadedPBRTextures||!0!==this._context.physicalBasedRenderingEnabled||(this.hasLoadedPBRTextures=!0,!1)},b.pixelRatioChanged=function(){return!0},b.applyRendererDiff=function(e,t){if(s.isNone(this._resources))return 0;const{stageResources:{materials:r},lodRenderer:i,resourceBoundingBox:o,symbolSize:a,resourceSize:n,pivotOffset:c}=this._resources;for(const s in e.diff){if("visualVariables"!==s)return 0;if(!L.updateFastSymbolUpdatesState(this._fastUpdates,t,this._fastVisualVariableConvertOptions(o,a,n,c)))return 0;for(const e of r)e.setParameters(this._fastUpdates.materialParameters);i.notifyShaderTransformationChanged()}return 2},b.computeComplexity=function(){if(s.isNone(this._resources))return e.prototype.computeComplexity.call(this);return{primitivesPerFeature:C.geometriesFromLodLevelResources(this._resources.lodResources.levels[0]).reduce(((e,t)=>e+t.indices.get("position").length),0)/3,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:x.defaultSymbolLayerMemoryComplexity(this.symbol,this.symbolLayer)}},b.hasLodRenderer=function(){return s.isSome(this._resources)},b._createAs3DShape=function(e,t,r,i,o){if(!this.hasLodRenderer()||s.isNone(this._resources))return null;const a=this.getFastUpdateAttrValues(e),n=!this._fastUpdates.enabled&&this._hasPerInstanceColor()?g.mixinColorAndOpacity(r.color,r.opacity):null,c=this._context.clippingExtent;if(h.projectPointToVector(t,T,this._context.elevationProvider.spatialReference),s.isSome(c)&&!d.containsPoint(c,T))return null;const l=this._requiresTerrainElevation(i),u=this._computeGlobalTransform(t,i,B,w),p=this._computeLocalTransform(this._resources,this.symbolLayer,r,G),f=this._resources.lodRenderer.instanceData,b=f.addInstance();this._instanceIndexToGraphicUid.set(b,o),f.setLocalTransform(b,p,!1),f.setGlobalTransform(b,u),a&&f.setFeatureAttribute(b,a),n&&f.setColor(b,n);const P=new _(this,b,m.perLodInstanceElevationAligner,i);return l&&(P.alignedSampledElevation=w.sampledElevation),P.needsElevationUpdates=y.needsElevationUpdates3D(i.mode),v.extendPointGraphicElevationContext(P,t,this._context.elevationProvider),P},b._computeGlobalTransform=function(e,t,r,s){return y.evaluateElevationInfoAtPoint(e,this._context.elevationProvider,t,this._context.renderCoordsHelper,s),T[0]=e.x,T[1]=e.y,T[2]=s.z,h.computeTranslationToOriginAndRotation(e.spatialReference,T,r,this._context.renderCoordsHelper.spatialReference),r},b._computeLocalTransform=function(e,t,r,s){return o.identity(s),this._applyObjectRotation(r,!1,s),this._applyObjectRotation(t,!0,s),this._applyObjectScale(e,r,s),this._applyAnchor(e,t,s),s},b._applyObjectScale=function(e,t,r){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const s=this._drivenProperties.size&&t.size?t.size:e.symbolSize,i=g.computeObjectScale(s,e.symbolSize,e.resourceSize,this._context.renderCoordsHelper.unitInMeters);1===i[0]&&1===i[1]&&1===i[2]||o.scale(r,r,i)},b.prepareSymbolLayerPatch=function(e){if("partial"!==e.diff.type)return;const t=e.diff.diff;this._preparePatchTransform(e,t),this._preparePatchColor(e,t)},b.updateGeometry=function(e,t){if(s.isNone(this._resources))return!0;const r=t&&v.placePointOnGeometry(t);if(s.isNone(r))return!1;const i=this.getGeometryElevationMode(t);return e.elevationContext.mode===i&&(this._computeGlobalTransform(r,e.elevationContext,B,w),this._requiresTerrainElevation(e.elevationContext)&&(e.alignedSampledElevation=w.sampledElevation),this._resources.lodRenderer.instanceData.setGlobalTransform(e.instanceIndex,B,!0),v.extendPointGraphicElevationContext(e,r,this._context.elevationProvider),!0)},b._preparePatchTransform=function(e,t){if(!(t.heading||t.tilt||t.roll||t.width||t.height||t.depth||t.anchor||t.anchorPosition))return;if(s.isNone(this._resources))return;const r=(e,t,r)=>s.unwrapOr(null!=e&&"complete"===e.type?e.newValue:t,r),i=r(t.heading,this.symbolLayer.heading,0),o=r(t.tilt,this.symbolLayer.tilt,0),a=r(t.roll,this.symbolLayer.roll,0),n=r(t.width,this.symbolLayer.width,void 0),l=r(t.height,this.symbolLayer.height,void 0),h=r(t.depth,this.symbolLayer.depth,void 0),d=r(t.anchor,this.symbolLayer.anchor,void 0),u=r(t.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete t.heading,delete t.tilt,delete t.roll,delete t.width,delete t.height,delete t.depth,delete t.anchor,delete t.anchorPosition;const m={heading:i,tilt:o,roll:a,anchor:d,anchorPosition:u},y=this._resources;1===this.loadStatus&&e.symbolLayerStatePatches.push((()=>{y.symbolSize=c.fromArray(p.objectSymbolLayerSizeWithResourceSize(y.resourceSize,{width:n,height:l,depth:h,isPrimitive:this.symbolLayer.isPrimitive}))})),e.graphics3DGraphicPatches.push(((e,t)=>{const r=this._computeLocalTransform(y,m,t,G),s=e.instanceIndex;y.lodRenderer.instanceData.setLocalTransform(s,r,!0)}))},b._preparePatchColor=function(e,t){if(!t.material||"partial"!==t.material.type)return;const i=t.material.diff;if(!i.color||"complete"!==i.color.type||null==i.color.newValue||null==i.color.oldValue)return;const o=i.color.newValue,a=s.isSome(o)?r.toUnitRGBA(o):l.ONES;delete i.color;const n=this._resources;s.isNone(n)||e.graphics3DGraphicPatches.push((e=>{let t;this._hasPerInstanceColor()?(n.lodRenderer.instanceData.setColor(e.instanceIndex,a),t=this.setMaterialTransparencyParams({},o)):t=this.setMaterialTransparencyParams({externalColor:a},o);for(const r of n.stageResources.materials)r.setParameters(t)}))},b._requiresTerrainElevation=function(e){return"absolute-height"!==e.mode},b._applyObjectRotation=function(e,t,r){if(!(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation&&t))return g.computeObjectRotation(e.heading,e.tilt,e.roll,r)},b._computeAnchor=function(e,t,r){const i=c.create();switch(r.anchor){case"center":n.copy(i,d.center(e)),n.negate(i,i);break;case"top":{const t=d.center(e);n.set(i,-t[0],-t[1],-e[5]);break}case"bottom":{const t=d.center(e);n.set(i,-t[0],-t[1],-e[2]);break}case"relative":{const t=d.center(e),s=d.size(e),o=r.anchorPosition,a=o?c.fromValues(o.x,o.y,o.z):c.ZEROS;n.multiply(i,s,a),n.add(i,i,t),n.negate(i,i);break}default:s.isSome(t)?n.negate(i,t):n.copy(i,c.ZEROS)}return i},b._applyAnchor=function(e,t,r){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const s=this._computeAnchor(e.resourceBoundingBox,e.pivotOffset,t);s&&o.translate(r,r,s)},b._hasPerInstanceColor=function(){return this._drivenProperties.color||this._drivenProperties.opacity},b._fastVisualVariableConvertOptions=function(e,t,r,i){const o=s.isSome(e)?c.fromArray(d.size(e)):c.ONES,a=s.isSome(e)?this._computeAnchor(e,i,this.symbolLayer):c.ZEROS,n=this._context.renderCoordsHelper.unitInMeters,l=g.computeObjectScale(s.isSome(t)?t:void 0,t,r,n),h=c.fromValues(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return{modelSize:o,symbolSize:s.isSome(t)?t:c.ONES,unitInMeters:n,transformation:{anchor:a,scale:l,rotation:h}}},t._createClass(a,[{key:"extentPadding",get:function(){return s.isSome(this._resources)?this._resources.extentPadding:0}},{key:"isPrimitive",get:function(){return!(this.symbolLayer.resource&&this.symbolLayer.resource.href)}},{key:"lodRenderer",get:function(){return s.get(this._resources,"lodRenderer")}}]),a}(b.Graphics3DSymbolLayer);const T=c.create(),G=a.create(),B=a.create(),z=l.create(),w=new y.SampleElevationInfo;e.Graphics3DObjectSymbolLayer=U,Object.defineProperty(e,"__esModule",{value:!0})}));
