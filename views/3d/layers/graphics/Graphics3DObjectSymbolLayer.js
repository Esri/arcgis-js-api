/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/lang","../../../../core/maybe","../../../../Color","../../../../core/screenUtils","../../../../symbols/support/ObjectSymbol3DLayerResource","../../../../chunks/vec3f64","../../../../chunks/vec3","../../../../chunks/mat4","../../../../geometry/projection","../../../../chunks/mat4f64","../../../../chunks/vec4f64","../../../../geometry/support/aaBoundingBox","../../webgl-engine/lib/Util","./graphicUtils","./elevationAlignmentUtils","./ElevationAligners","./ElevationContext","./primitiveObjectSymbolUtils","../../webgl-engine/lib/lodRendering/LodResources","./symbolComplexity","./Graphics3DSymbolLayer","./pointUtils","../../webgl-engine/materials/DefaultMaterial","../support/FastSymbolUpdates","../../../../symbols/support/symbolLayerUtils3D","./Graphics3DLodInstanceGraphicLayer","./lodResourceUtils","./objectResourceUtils","../../webgl-engine/lib/lodRendering/LodRenderer"],(function(e,t,s,r,i,o,a,n,c,l,h,d,u,m,p,f,y,_,b,g,S,v,P,R,x,L,E,C,U,O,w){"use strict";let T=function(e){function d(t,s,r,i){var o;return(o=e.call(this,t,s,r,i)||this)._resources=null,o._optionalFields=[],o._instanceIndexToGraphicUid=new Map,o.ensureDrapedStatus(!1),o}t._inheritsLoose(d,e);var P=d.prototype;return P.getCachedSize=function(){const[e,t,s]=r.isSome(this._resources)?this._resources.symbolSize:[1,1,1];return{width:e,depth:t,height:s}},P.doLoad=async function(e){const t=this._getIdHint("_objectmat");if(!this._drivenProperties.size){if(f.validateSymbolLayerSize(this.symbolLayer))throw new Error}const s=this.symbolLayer;if(this.isPrimitive){const e=s.resource?s.resource.primitive:a.defaultPrimitive;this._resources=this._createResourcesForPrimitive(e,t)}else this._resources=await this._createResourcesForUrl(s.resource.href,e);this.complexity=this.computeComplexity()},P.setMaterialTransparencyParams=function(e,t=r.get(this.symbolLayer,"material","color")){const s=this._getCombinedOpacity(t),i=s<1||this.needsDrivenTransparentPass;return e.transparent=i,e.opacity=s,e},P._createResourcesForPrimitive=function(e,t){if(!g.isValidPrimitive(e))throw new Error(`Unknown object symbol primitive: ${e}`);const a=this.symbolLayer,l=m.create(E.objectSymbolLayerPrimitiveBoundingBox(e)),h=n.fromArray(m.size(l)),d=n.fromArray(E.objectSymbolLayerSizeWithResourceSize(h,a)),p=c.length(d),f={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,instanced:["transformation"],ambient:n.ONES,diffuse:n.ONES,slicePlaneEnabled:this._context.slicePlaneEnabled,sliceHighlightDisabled:!0,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!this.symbolLayer.isPrimitive},y=f.usePBR;this.setMaterialTransparencyParams(f);const _=this.symbol;if("point-3d"===_.type&&_.verticalOffset){const{screenLength:e,minWorldLength:t,maxWorldLength:s}=_.verticalOffset;f.verticalOffset={screenLength:o.pt2px(e),minWorldLength:t||0,maxWorldLength:null!=s?s:1/0},f.castShadows=!1}if(this._context.screenSizePerspectiveEnabled&&(f.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),this._drivenProperties.color)f.externalColor=u.ONES;else{const e=r.isSome(a.material)&&a.material.color,t=r.isSome(e)?i.toUnitRGBA(e):u.ONES;f.externalColor=t}this._fastUpdates=L.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions(l,d,h,r.none)),this._fastUpdates.enabled?(s.mixin(f,this._fastUpdates.materialParameters),f.instanced.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(f.instanced.push("color"),this._optionalFields.push("color"));const b=new x.DefaultMaterial(f,t),v=g.primitiveLodResources(e,b,t);if(!v)throw new Error(`Unknown object symbol primitive: ${e}`);const P=S.materialsFromLodResources(v).map((e=>({opacity:1,transparent:e.params.transparent}))),R=this._createStageResources(v,y);return{lodResources:v,lodRenderer:this._createLodRenderer(v),stageResources:R,symbolSize:d,extentPadding:p,isEsriSymbolResource:!1,isWosr:!1,originalMaterialParameters:P,physicalBasedRenderingEnabled:y,resourceBoundingBox:l,resourceSize:h,dispose:r.none,pivotOffset:r.none}},P._createResourcesForUrl=async function(e,t){const i=["transformation"],a={materialParamsMixin:{instanced:i,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},streamDataRequester:this._context.streamDataRequester,cache:this._context.sharedResources.objectResourceCache};this._fastUpdates=L.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions(r.none,r.none,r.none,r.none)),this._fastUpdates.enabled?(s.mixin(a.materialParamsMixin,this._fastUpdates.materialParameters),i.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(i.push("color"),this._optionalFields.push("color"));const l=this.symbol;if("point-3d"===l.type&&l.verticalOffset){const{screenLength:e,minWorldLength:t,maxWorldLength:s}=l.verticalOffset;a.materialParamsMixin.verticalOffset={screenLength:o.pt2px(e),minWorldLength:t||0,maxWorldLength:null!=s?s:1/0},a.materialParamsMixin.castShadows=!1}a.signal=t,a.usePBR=this._context.physicalBasedRenderingEnabled;const h=a.usePBR,d=await O.fetch(e,a),u=d.isEsriSymbolResource,p=d.isWosr,f=d.remove,y=U.makeLodResources(d.lods);U.fillEstimatedMinScreenSpaceRadius(y),y.levels.sort(((e,t)=>e.minScreenSpaceRadius-t.minScreenSpaceRadius)),y.levels[0].minScreenSpaceRadius=Math.min(2,y.levels[0].minScreenSpaceRadius);const _=this._context,b=this.symbolLayer.material,g=this._getExternalColorParameters(b),v=r.get(this.symbolLayer,"material","color"),P=this._getCombinedOpacity(v,{hasIntrinsicColor:!0}),R=this.needsDrivenTransparentPass,x=S.materialsFromLodResources(y),C=S.materialsFromLodResources(y).map((e=>{const t=e.params;return{opacity:t.opacity||1,transparent:t.transparent}}));x.forEach((e=>{const t=e.params;e.setParameterValues(g);const s=t.opacity*P,r=s<1||R||t.transparent;e.setParameterValues({opacity:s,transparent:r}),_.screenSizePerspectiveEnabled&&e.setParameterValues({screenSizePerspective:_.sharedResources.screenSizePerspectiveSettings})}));const w=d.referenceBoundingBox,T=n.fromArray(m.size(w)),z=n.fromArray(y.levels[0].pivotOffset),G=n.fromArray(E.objectSymbolLayerSizeWithResourceSize(T,this.symbolLayer)),B=c.length(G);L.updateFastSymbolUpdatesState(this._fastUpdates,this._context.renderer,this._fastVisualVariableConvertOptions(w,G,T,z))&&x.forEach((e=>e.setParameterValues(this._fastUpdates.materialParameters)));const A=this._createStageResources(y,h);return{lodResources:y,lodRenderer:this._createLodRenderer(y),stageResources:A,symbolSize:G,extentPadding:B,isEsriSymbolResource:u,isWosr:p,originalMaterialParameters:C,physicalBasedRenderingEnabled:h,resourceBoundingBox:w,resourceSize:T,dispose:f,pivotOffset:z}},P._createStageResources=function(e,t){const s=this._context.stage,r=S.materialsFromLodResources(e);t!==this._context.physicalBasedRenderingEnabled&&this.physicalBasedRenderingChanged();for(const e of r)s.add(3,e);const i=S.texturesFromLodResources(e);for(const e of i)s.add(4,e);const o=S.geometriesFromLodResources(e);for(const e of o)s.add(2,e);return{materials:r,textures:i,geometries:o}},P._createLodRenderer=function(e){const t=this._context.stage,s={layerUid:this._context.layer.uid,graphicUid:e=>this._instanceIndexToGraphicUid.get(e),notifyGraphicUpdate:(e,t)=>this._context.notifyGraphicUpdate(this._instanceIndexToGraphicUid.get(e),t)},r=this._fastUpdates.enabled?{applyTransform:(e,t,s)=>{e.getFeatureAttribute(t,A),l.copy(s,L.evaluateModelTransform(this._fastUpdates.materialParameters,A,s))},scaleFactor:(e,t,s)=>(t.getFeatureAttribute(s,A),L.evaluateModelTransformScale(e,this._fastUpdates.materialParameters,A))}:null,i=new w.LodRenderer(e,this._optionalFields,s,r);return i.slicePlane=this._context.slicePlaneEnabled,t.addRenderPlugin(i.slots,i),i},P._getExternalColorParameters=function(e){const t={};return this._drivenProperties.color?t.externalColor=u.ONES:r.isSome(e)&&r.isSome(e.color)?t.externalColor=i.toUnitRGBA(e.color):(t.externalColor=u.ONES,t.colorMixMode="ignore"),t},P.destroy=function(){e.prototype.destroy.call(this);const t=this._context.stage;if(r.isSome(this._resources)){t.removeRenderPlugin(this._resources.lodRenderer),this._resources.lodRenderer.destroy();const e=this._resources.stageResources;for(const s of e.materials)t.remove(3,s.id);for(const s of e.textures)t.remove(4,s.id);for(const s of e.geometries)t.remove(2,s.id);r.isSome(this._resources.dispose)&&this._resources.dispose()}this._resources=null},P.createGraphics3DGraphic=function(e){const t=e.graphic;if(!this._validateGeometry(t.geometry))return null;const s=R.placePointOnGeometry(t.geometry);if(r.isNone(s))return this.logger.warn(`unsupported geometry type for icon symbol: ${t.geometry.type}`),null;const i=this.setGraphicElevationContext(t,new b.ElevationContext),o=e.renderingInfo;return this._createAs3DShape(t,s,o,i,t.uid)},P.notifyDestroyGraphicLayer=function(e){this._instanceIndexToGraphicUid.delete(e.instanceIndex)},P.graphicLayerToGraphicId=function(){return 0},P.layerOpacityChanged=function(){if(r.isNone(this._resources))return!0;const e=this._drivenProperties.opacity,t=!this.isPrimitive,s=this._resources.stageResources.materials,i=this._resources.originalMaterialParameters;for(let o=0;o<s.length;o++){const a=s[o],n=r.get(this.symbolLayer,"material","color"),c=i[o],l=this._getCombinedOpacity(n,{hasIntrinsicColor:t})*c.opacity;a.setParameterValues({opacity:l,transparent:l<1||e||c.transparent})}return!0},P.layerElevationInfoChanged=function(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,y.needsElevationUpdates3D)},P.slicePlaneEnabledChanged=function(){if(r.isNone(this._resources))return!0;this._resources.lodRenderer.slicePlane=this._context.slicePlaneEnabled;for(const e of this._resources.stageResources.materials)e.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});return!0},P.physicalBasedRenderingChanged=function(){if(r.isNone(this._resources))return!0;const{stageResources:e,isEsriSymbolResource:t,isWosr:s}=this._resources;for(const r of e.materials)this.isPrimitive?r.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}):t&&!s&&r.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!1});return!0},P.pixelRatioChanged=function(){return!0},P.applyRendererDiff=function(e,t){if(r.isNone(this._resources))return!0;const{stageResources:{materials:s},lodRenderer:i,resourceBoundingBox:o,symbolSize:a,resourceSize:n,pivotOffset:c}=this._resources;for(const r in e.diff)switch(r){case"visualVariables":if(!L.updateFastSymbolUpdatesState(this._fastUpdates,t,this._fastVisualVariableConvertOptions(o,a,n,c)))return!1;for(const e of s)e.setParameterValues(this._fastUpdates.materialParameters);i.notifyShaderTransformationChanged();break;default:return!1}return!0},P.computeComplexity=function(){if(r.isNone(this._resources))return e.prototype.computeComplexity.call(this);return{primitivesPerFeature:S.geometriesFromLodLevelResources(this._resources.lodResources.levels[0]).reduce(((e,t)=>e+t.data.getIndices(p.VertexAttrConstants.POSITION).length),0)/3,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:v.defaultSymbolLayerMemoryComplexity(this.symbol,this.symbolLayer)}},P.hasLodRenderer=function(){return r.isSome(this._resources)},P._createAs3DShape=function(e,t,s,i,o){if(!this.hasLodRenderer()||r.isNone(this._resources))return null;const a=this.getFastUpdateAttrValues(e),n=!this._fastUpdates.enabled&&this._hasPerInstanceColor()?f.mixinColorAndOpacity(s.color,s.opacity):null,c=this._context.clippingExtent;if(h.projectPointToVector(t,z,this._context.elevationProvider.spatialReference),r.isSome(c)&&!m.containsPoint(c,z))return null;const l=this._requiresTerrainElevation(i),d=this._computeGlobalTransform(t,i,B,l?V:null),u=this._computeLocalTransform(this._resources,this.symbolLayer,s,G),p=this._resources.lodRenderer.instanceData,b=p.addInstance();this._instanceIndexToGraphicUid.set(b,o),p.setLocalTransform(b,u,!1),p.setGlobalTransform(b,d),a&&p.setFeatureAttribute(b,a),n&&p.setColor(b,n);const g=_.perLodInstanceElevationAligner,S=new C(this,b,g,i);return l&&(S.alignedSampledElevation=V.sampledElevation),S.needsElevationUpdates=y.needsElevationUpdates3D(i.mode),R.extendPointGraphicElevationContext(S,t,this._context.elevationProvider),S},P._computeGlobalTransform=function(e,t,s,r){const i=y.evaluateElevationAlignmentAtPoint(e,this._context.elevationProvider,t,this._context.renderCoordsHelper,r);return z[0]=e.x,z[1]=e.y,z[2]=i,h.computeLinearTransformation(e.spatialReference,z,s,this._context.renderCoordsHelper.spatialReference),s},P._computeLocalTransform=function(e,t,s,r){return l.identity(r),this._applyObjectRotation(s,!1,r),this._applyObjectRotation(t,!0,r),this._applyObjectScale(e,s,r),this._applyAnchor(e,t,r),r},P._applyObjectScale=function(e,t,s){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const r=this._drivenProperties.size&&t.size?t.size:e.symbolSize,i=f.computeObjectScale(r,e.symbolSize,e.resourceSize,this._context.renderCoordsHelper.unitInMeters);1===i[0]&&1===i[1]&&1===i[2]||l.scale(s,s,i)},P.prepareSymbolLayerPatch=function(e){if("partial"!==e.diff.type)return;const t=e.diff.diff;this._preparePatchTransform(e,t),this._preparePatchColor(e,t)},P.updateGeometry=function(e,t){if(r.isNone(this._resources))return!0;const s=t&&R.placePointOnGeometry(t);if(r.isNone(s))return!1;const i=this.getGeometryElevationMode(t);if(e.elevationContext.mode!==i)return!1;const o=this._requiresTerrainElevation(e.elevationContext);return this._computeGlobalTransform(s,e.elevationContext,B,o?V:null),o&&(e.alignedSampledElevation=V.sampledElevation),this._resources.lodRenderer.instanceData.setGlobalTransform(e.instanceIndex,B,!0),R.extendPointGraphicElevationContext(e,s,this._context.elevationProvider),!0},P._preparePatchTransform=function(e,t){if(!(t.heading||t.tilt||t.roll||t.width||t.height||t.depth||t.anchor||t.anchorPosition))return;if(r.isNone(this._resources))return;const s=(e,t,s)=>r.unwrapOr(null!=e&&"complete"===e.type?e.newValue:t,s),i=s(t.heading,this.symbolLayer.heading,0),o=s(t.tilt,this.symbolLayer.tilt,0),a=s(t.roll,this.symbolLayer.roll,0),c=s(t.width,this.symbolLayer.width,void 0),l=s(t.height,this.symbolLayer.height,void 0),h=s(t.depth,this.symbolLayer.depth,void 0),d=s(t.anchor,this.symbolLayer.anchor,void 0),u=s(t.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete t.heading,delete t.tilt,delete t.roll,delete t.width,delete t.height,delete t.depth,delete t.anchor,delete t.anchorPosition;const m={heading:i,tilt:o,roll:a,anchor:d,anchorPosition:u},p=this._resources;1===this.loadStatus&&e.symbolLayerStatePatches.push((()=>{p.symbolSize=n.fromArray(E.objectSymbolLayerSizeWithResourceSize(p.resourceSize,{width:c,height:l,depth:h,isPrimitive:this.symbolLayer.isPrimitive}))})),e.graphics3DGraphicPatches.push(((e,t)=>{const s=this._computeLocalTransform(p,m,t,G),r=e.instanceIndex;p.lodRenderer.instanceData.setLocalTransform(r,s,!0)}))},P._preparePatchColor=function(e,t){if(!t.material||"partial"!==t.material.type)return;const s=t.material.diff;if(!s.color||"complete"!==s.color.type||null==s.color.newValue||null==s.color.oldValue)return;const o=s.color.newValue,a=r.isSome(o)?i.toUnitRGBA(o):u.ONES;delete s.color;const n=this._resources;r.isNone(n)||e.graphics3DGraphicPatches.push((e=>{let t;this._hasPerInstanceColor()?(n.lodRenderer.instanceData.setColor(e.instanceIndex,a),t=this.setMaterialTransparencyParams({},o)):t=this.setMaterialTransparencyParams({externalColor:a},o);for(const e of n.stageResources.materials)e.setParameterValues(t)}))},P._requiresTerrainElevation=function(e){return"absolute-height"!==e.mode},P._applyObjectRotation=function(e,t,s){if(!(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation&&t))return f.computeObjectRotation(e.heading,e.tilt,e.roll,s)},P._computeAnchor=function(e,t,s){const i=n.create();switch(s.anchor){case"center":c.copy(i,m.center(e)),c.negate(i,i);break;case"top":{const t=m.center(e);c.set(i,-t[0],-t[1],-e[5]);break}case"bottom":{const t=m.center(e);c.set(i,-t[0],-t[1],-e[2]);break}case"relative":{const t=m.center(e),r=m.size(e),o=s.anchorPosition,a=o?n.fromValues(o.x,o.y,o.z):n.ZEROS;c.multiply(i,r,a),c.add(i,i,t),c.negate(i,i);break}case"origin":default:r.isSome(t)?c.negate(i,t):c.copy(i,n.ZEROS)}return i},P._applyAnchor=function(e,t,s){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const r=this._computeAnchor(e.resourceBoundingBox,e.pivotOffset,t);r&&l.translate(s,s,r)},P._hasPerInstanceColor=function(){return this._drivenProperties.color||this._drivenProperties.opacity},P._fastVisualVariableConvertOptions=function(e,t,s,i){const o=r.isSome(e)?n.fromArray(m.size(e)):n.ONES,a=r.isSome(e)?this._computeAnchor(e,i,this.symbolLayer):n.ZEROS,c=this._context.renderCoordsHelper.unitInMeters,l=f.computeObjectScale(r.isSome(t)?t:void 0,t,s,c),h=n.fromValues(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return{modelSize:o,symbolSize:r.isSome(t)?t:n.ONES,unitInMeters:c,transformation:{anchor:a,scale:l,rotation:h}}},t._createClass(d,[{key:"extentPadding",get:function(){return r.isSome(this._resources)?this._resources.extentPadding:0}},{key:"isPrimitive",get:function(){return!(this.symbolLayer.resource&&this.symbolLayer.resource.href)}},{key:"lodRenderer",get:function(){return r.get(this._resources,"lodRenderer")}}]),d}(P.Graphics3DSymbolLayer);const z=n.create(),G=d.create(),B=d.create(),A=u.create(),V={verticalDistanceToGround:0,sampledElevation:0};e.Graphics3DObjectSymbolLayer=T,e.default=T,Object.defineProperty(e,"__esModule",{value:!0})}));
