/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../Color","../../../../core/has","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/screenUtils","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../chunks/vec4f64","../../../../geometry/projection","../../../../geometry/support/aaBoundingBox","../../../../symbols/support/ObjectSymbol3DLayerResource","../../../../symbols/support/symbolLayerUtils3D","./ElevationAligners","./elevationAlignmentUtils","./ElevationContext","./Graphics3DLodInstanceGraphicLayer","./Graphics3DSymbolLayer","./graphicUtils","./interfaces","./Loadable","./lodResourceUtils","./objectResourceUtils","./pointUtils","./primitiveObjectSymbolUtils","./symbolComplexity","../support/FastSymbolUpdates","../../webgl-engine/lib/basicInterfaces","../../webgl-engine/lib/VertexAttribute","../../webgl-engine/lib/lodRendering/LodRenderer","../../webgl-engine/lib/lodRendering/LodResources","../../webgl-engine/materials/DefaultMaterial"],(function(e,t,r,s,i,o,a,n,c,l,h,d,u,p,m,y,f,_,b,g,S,R,P,v,x,L,C,E,O,A,U,T,G,w,I){"use strict";let B=function(e,t,r,s,i,o,a,n,c,l,h,d){this.lodResources=e,this.lodRenderer=t,this.stageResources=r,this.originalMaterialParameters=s,this.resourceSize=i,this.isEsriSymbolResource=o,this.isWosr=a,this.resourceBoundingBox=n,this.symbolSize=c,this.extentPadding=l,this.physicalBasedRenderingEnabled=h,this.pivotOffset=d},F=function(e){t._inheritsLoose(S,e);var c=S.prototype;function S(t,r,s,i){var o;return(o=e.call(this,t,r,s,i)||this)._resources=null,o._optionalFields=new Array,o._instanceIndexToGraphicUid=new Map,o._hasLoadedPBRTextures=!1,o._disposeResourceHandles=new Array,o.ensureDrapedStatus(!1),o._hasLoadedPBRTextures=s.physicalBasedRenderingEnabled,o}return c.getCachedSize=function(){const[e,t,r]=i.isSome(this._resources)?this._resources.symbolSize:[1,1,1];return{width:e,depth:t,height:r}},c.doLoad=function(){var e=t._asyncToGenerator((function*(e){if(!this._drivenProperties.size){if(R.validateSymbolLayerSize(this.symbolLayer))throw new Error}const t=this.symbolLayer;if(this._isPrimitive){const r=t.resource?t.resource.primitive:m.defaultPrimitive;this._resources=yield this._createResourcesForPrimitive(r,e)}else this._resources=yield this._createResourcesForUrl(t.resource.href,e);this.layerOpacityChanged(),this.slicePlaneEnabledChanged(),this.physicalBasedRenderingChanged(),this.complexity=this.computeComplexity()}));function r(t){return e.apply(this,arguments)}return r}(),c._setMaterialTransparencyParams=function(e,t=i.get(this.symbolLayer,"material","color")){const r=this._getCombinedOpacity(t),s=r<1||this.needsDrivenTransparentPass;return e.transparent=s,e.opacity=r,e.cullFace=s?U.CullFaceOptions.None:U.CullFaceOptions.Back,e},c._createResourcesForPrimitive=function(){var e=t._asyncToGenerator((function*(e,t){if(!E.isValidPrimitive(e))throw new Error(`Unknown object symbol primitive: ${e}`);const o=this.symbolLayer,n=p.create(y.objectSymbolLayerPrimitiveBoundingBox(e)),c=h.fromArray(p.size(n)),u=h.fromArray(y.objectSymbolLayerSizeWithResourceSize(c,o)),m=l.length(u),f=!1,_=!1,b={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,ambient:h.ONES,diffuse:h.ONES,hasSlicePlane:this._context.slicePlaneEnabled,hasSliceHighlight:!1,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!this.symbolLayer.isPrimitive},g=!!b.usePBR;this._setMaterialTransparencyParams(b);const S=this.symbol;if("point-3d"===S.type&&S.verticalOffset){const{screenLength:e,minWorldLength:t,maxWorldLength:r}=S.verticalOffset;b.verticalOffset={screenLength:a.pt2px(e),minWorldLength:t||0,maxWorldLength:i.isSome(r)?r:1/0},b.castShadows=!1}if(this._context.screenSizePerspectiveEnabled&&(b.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),this._drivenProperties.color)b.externalColor=d.ONES;else{const e=i.isSome(o.material)?o.material.color:null,t=i.isSome(e)?r.toUnitRGBA(e):d.ONES;b.externalColor=t}this._fastUpdates=A.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions(n,u,c,i.none)),b.instanced=["transformation"],this._fastUpdates.enabled?(Object.assign(b,this._fastUpdates.materialParameters),b.instanced.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(b.instanced.push("color"),this._optionalFields.push("color")),s("enable-feature:objectAndLayerId-rendering")&&(b.instanced.push("objectAndLayerIdColor"),this._optionalFields.push("objectAndLayerIdColor"));const R=new I.DefaultMaterial(b),P=E.primitiveLodResources(e,R);if(!P)throw new Error(`Unknown object symbol primitive: ${e}`);const v=w.materialsFromLodResources(P).map((e=>({opacity:1,transparent:e.parameters.transparent}))),x=yield this._createStageResources(P,g,t),L=yield this._createLodRenderer(P,t);return new B(P,L,x,v,c,f,_,n,u,m,g,i.none)}));function o(t,r){return e.apply(this,arguments)}return o}(),c._createResourcesForUrl=function(){var e=t._asyncToGenerator((function*(e,t){const r=["transformation"],o={materialParamsMixin:{instanced:r,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},streamDataRequester:this._context.streamDataRequester,cache:this._context.sharedResources.objectResourceCache};this._fastUpdates=A.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions(i.none,i.none,i.none,i.none)),this._fastUpdates.enabled?(Object.assign(o.materialParamsMixin,this._fastUpdates.materialParameters),r.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(r.push("color"),this._optionalFields.push("color")),s("enable-feature:objectAndLayerId-rendering")&&(r.push("objectAndLayerIdColor"),this._optionalFields.push("objectAndLayerIdColor"));const n=this.symbol;if("point-3d"===n.type&&n.verticalOffset){const{screenLength:e,minWorldLength:t,maxWorldLength:r}=n.verticalOffset;o.materialParamsMixin.verticalOffset={screenLength:a.pt2px(e),minWorldLength:t||0,maxWorldLength:i.isSome(r)?r:1/0},o.materialParamsMixin.castShadows=!1}o.signal=t,o.usePBR=this._context.physicalBasedRenderingEnabled,o.skipHighLods=this._context.skipHighSymbolLods;const c=o.usePBR,d=yield L.fetch(e,o),u=d.isEsriSymbolResource,m=d.isWosr,f=x.makeLodResources(d.lods);f.levels.sort(((e,t)=>e.minScreenSpaceRadius-t.minScreenSpaceRadius));const _=this._context,b=this.symbolLayer.material,g=this._getExternalColorParameters(b),S=i.get(this.symbolLayer,"material","color"),R=this._getCombinedOpacity(S,{hasIntrinsicColor:!0}),P=this.needsDrivenTransparentPass,v=w.materialsFromLodResources(f),C=w.materialsFromLodResources(f).map((e=>({opacity:e.parameters.opacity||1,transparent:e.parameters.transparent})));v.forEach((e=>{const t=e.parameters;e.setParameters(g);const r=t.opacity*R,s=r<1||P||t.transparent;e.setParameters({opacity:r,transparent:s}),_.screenSizePerspectiveEnabled&&e.setParameters({screenSizePerspective:_.sharedResources.screenSizePerspectiveSettings})}));const E=d.referenceBoundingBox,O=h.fromArray(p.size(E)),U=h.fromArray(f.levels[0].pivotOffset),T=h.fromArray(y.objectSymbolLayerSizeWithResourceSize(O,this.symbolLayer)),G=l.length(T);A.updateFastSymbolUpdatesState(this._fastUpdates,this._context.renderer,this._fastVisualVariableConvertOptions(E,T,O,U))&&v.forEach((e=>e.setParameters(this._fastUpdates.materialParameters)));const I=yield this._createStageResources(f,c,t),F=yield this._createLodRenderer(f,t);return new B(f,F,I,C,O,u,m,E,T,G,c,U)}));function r(t,r){return e.apply(this,arguments)}return r}(),c._addDisposeResource=function(e){this._disposeResourceHandles.push(e)},c._createStageResources=function(){var e=t._asyncToGenerator((function*(e,t,r){const s=this._context.stage,i=w.materialsFromLodResources(e);t!==this._context.physicalBasedRenderingEnabled&&this.physicalBasedRenderingChanged(),s.addMany(i),this._addDisposeResource((()=>s.removeMany(i)));const a=w.texturesFromLodResources(e);s.addMany(a),this._addDisposeResource((()=>s.removeMany(a))),yield s.load(a,r),o.throwIfAborted(r);const n=w.geometriesFromLodResources(e);return s.addMany(n),this._addDisposeResource((()=>s.removeMany(n))),{materials:i,textures:a,geometries:n}}));function r(t,r,s){return e.apply(this,arguments)}return r}(),c._createLodRenderer=function(){var e=t._asyncToGenerator((function*(e,t){const r=this._context.stage,s={layerUid:this._context.layer.uid,graphicUid:e=>this._instanceIndexToGraphicUid.get(e),notifyGraphicGeometryChanged:e=>this._context.notifyGraphicGeometryChanged(this._instanceIndexToGraphicUid.get(e)),notifyGraphicVisibilityChanged:e=>this._context.notifyGraphicVisibilityChanged(this._instanceIndexToGraphicUid.get(e))},i=this._fastUpdates.enabled?{applyTransform:(e,t,r)=>{e.getFeatureAttribute(t,M),n.copy(r,A.evaluateModelTransform(this._fastUpdates.materialParameters,M,r))},scaleFactor:(e,t,r)=>(t.getFeatureAttribute(r,M),A.evaluateModelTransformScale(e,this._fastUpdates.materialParameters,M))}:null,o=new G.LodRenderer({symbol:e,optionalFields:this._optionalFields,metadata:s,shaderTransformation:i},this._context.scheduler);return o.slicePlaneEnabled=this._context.slicePlaneEnabled,this._addDisposeResource((()=>{r.removeRenderPlugin(o),o.destroy()})),yield r.addRenderPlugin(o.slots,o,t),o}));function r(t,r){return e.apply(this,arguments)}return r}(),c._getExternalColorParameters=function(e){const t={};return this._drivenProperties.color?t.externalColor=d.ONES:i.isSome(e)&&i.isSome(e.color)?t.externalColor=r.toUnitRGBA(e.color):(t.externalColor=d.ONES,t.colorMixMode="ignore"),t},c.destroy=function(){e.prototype.destroy.call(this),this._cleanupResources()},c._cleanupResources=function(){this._disposeResourceHandles.forEach((e=>e())),this._disposeResourceHandles.length=0,this._resources=null},c.createGraphics3DGraphic=function(e){const t=e.graphic;if(!this._validateGeometry(t.geometry))return null;const r=C.placePointOnGeometry(t.geometry);if(i.isNone(r))return this.logger.warn(`unsupported geometry type for icon symbol: ${t.geometry.type}`),null;const s=this.setGraphicElevationContext(t,new b.ElevationContext),o=e.renderingInfo;return this._createAs3DShape(t,r,o,s,t.uid,e.layer.uid)},c.notifyDestroyGraphicLayer=function(e){this._instanceIndexToGraphicUid.delete(e.instanceIndex)},c.graphicLayerToGraphicId=function(){return 0},c.layerOpacityChanged=function(){if(i.isNone(this._resources))return;const e=this._drivenProperties.opacity,t=!this._isPrimitive,r=this._resources.stageResources.materials,s=this._resources.originalMaterialParameters;for(let o=0;o<r.length;o++){const a=r[o],n=i.get(this.symbolLayer,"material","color"),c=s[o],l=this._getCombinedOpacity(n,{hasIntrinsicColor:t})*c.opacity,h=l<1||e||c.transparent;a.setParameters({opacity:l,transparent:h}),this._isPrimitive&&a.setParameters({cullFace:h?U.CullFaceOptions.None:U.CullFaceOptions.Back})}},c.layerElevationInfoChanged=function(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,_.needsElevationUpdates3D)},c.slicePlaneEnabledChanged=function(){if(i.isNone(this._resources))return!0;this._resources.lodRenderer.slicePlaneEnabled=this._context.slicePlaneEnabled;for(const e of this._resources.stageResources.materials)e.setParameters({hasSlicePlane:this._context.slicePlaneEnabled});return!0},c.physicalBasedRenderingChanged=function(){if(i.isNone(this._resources))return!0;const{stageResources:e,isWosr:t}=this._resources;for(const r of e.materials)this._isPrimitive?r.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}):t||r.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!1});return!1!==this._hasLoadedPBRTextures||!0!==this._context.physicalBasedRenderingEnabled||(this._hasLoadedPBRTextures=!0,!1)},c.pixelRatioChanged=function(){return!0},c.skipHighSymbolLodsChanged=function(){return!1},c.applyRendererDiff=function(e,t){if(i.isNone(this._resources))return P.ApplyRendererDiffResult.Recreate_Symbol;const{stageResources:{materials:r},lodRenderer:s,resourceBoundingBox:o,symbolSize:a,resourceSize:n,pivotOffset:c}=this._resources;for(const i in e.diff){if("visualVariables"!==i)return P.ApplyRendererDiffResult.Recreate_Symbol;if(!A.updateFastSymbolUpdatesState(this._fastUpdates,t,this._fastVisualVariableConvertOptions(o,a,n,c)))return P.ApplyRendererDiffResult.Recreate_Symbol;for(const e of r)e.setParameters(this._fastUpdates.materialParameters);s.notifyShaderTransformationChanged()}return P.ApplyRendererDiffResult.Fast_Update},c.computeComplexity=function(){if(i.isNone(this._resources))return e.prototype.computeComplexity.call(this);const t=this._resources.lodResources,r=w.geometriesFromLodLevelResources(t.levels[0]).reduce(((e,t)=>e+t.indices.get(T.VertexAttribute.POSITION).length),0)/3,s=e=>Array.from(e.vertexAttributes.values()).reduce(((e,t)=>e+(t.data.buffer?.byteLength??0)),0)+Array.from(e.indices.values()).reduce(((e,t)=>e+(Array.isArray(t)?12*t.length:t.buffer.byteLength)),0),o=w.texturesFromLodResources(t).reduce(((e,t)=>e+(t.params.encoding&&"image/ktx2"===t.params.encoding?t.estimatedTexMemRequired:t.estimatedTexMemRequired/4)),0)+w.geometriesFromLodResources(t).reduce(((e,t)=>e+s(t)),0);return{primitivesPerFeature:r,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:{...O.defaultSymbolLayerMemoryComplexity(this.symbol,this.symbolLayer),resourceBytes:o}}},c._hasLodRenderer=function(){return i.isSome(this._resources)},c._createAs3DShape=function(e,t,r,s,o,a){if(!this._hasLodRenderer()||i.isNone(this._resources))return null;const n=this.getFastUpdateAttrValues(e),c=!this._fastUpdates.enabled&&this._hasPerInstanceColor()?R.mixinColorAndOpacity(r.color,r.opacity):null,l=this._context.clippingExtent;if(u.projectPointToVector(t,D,this._context.elevationProvider.spatialReference),i.isSome(l)&&!p.containsPoint(l,D))return null;const h=this._requiresTerrainElevation(s),d=this._computeGlobalTransform(t,s,j,V),m=this._computeLocalTransform(this._resources,this.symbolLayer,r,z),y=this._resources.lodRenderer.instanceData,b=y.addInstance();this._instanceIndexToGraphicUid.set(b,o),y.setLocalTransform(b,m,!1),y.setGlobalTransform(b,d),n&&y.setFeatureAttribute(b,n),c&&y.setColor(b,c),i.isSome(this._context.stage.renderView.objectAndLayerIdRenderHelper)&&y.setObjectAndLayerIdColor(b,this._context.stage.renderView.objectAndLayerIdRenderHelper.getObjectAndLayerIdColor({graphicUid:o,layerUid:a}));const S=new g(this,b,f.perLodInstanceElevationAligner,s);return h&&(S.alignedSampledElevation=V.sampledElevation),S.needsElevationUpdates=_.needsElevationUpdates3D(s.mode),C.extendPointGraphicElevationContext(S,t,this._context.elevationProvider),S},c._computeGlobalTransform=function(e,t,r,s){return _.evaluateElevationInfoAtPoint(e,this._context.elevationProvider,t,this._context.renderCoordsHelper,s),D[0]=e.x,D[1]=e.y,D[2]=s.z,u.computeTranslationToOriginAndRotation(e.spatialReference,D,r,this._context.renderCoordsHelper.spatialReference),r},c._computeLocalTransform=function(e,t,r,s){return n.identity(s),this._applyObjectRotation(r,!1,s),this._applyObjectRotation(t,!0,s),this._applyObjectScale(e,r,s),this._applyAnchor(e,t,s),s},c._applyObjectScale=function(e,t,r){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const s=this._drivenProperties.size&&t.size?t.size:e.symbolSize,i=R.computeObjectScale(s,e.symbolSize,e.resourceSize,this._context.renderCoordsHelper.unitInMeters);1===i[0]&&1===i[1]&&1===i[2]||n.scale(r,r,i)},c.prepareSymbolLayerPatch=function(e){if("partial"!==e.diff.type)return;const t=e.diff.diff;this._preparePatchTransform(e,t),this._preparePatchColor(e,t)},c.updateGeometry=function(e,t){if(i.isNone(this._resources))return!0;const r=t&&C.placePointOnGeometry(t);if(i.isNone(r))return!1;const s=this.getGeometryElevationMode(t);return e.elevationContext.mode===s&&(this._computeGlobalTransform(r,e.elevationContext,j,V),this._requiresTerrainElevation(e.elevationContext)&&(e.alignedSampledElevation=V.sampledElevation),this._resources.lodRenderer.instanceData.setGlobalTransform(e.instanceIndex,j,!0),C.extendPointGraphicElevationContext(e,r,this._context.elevationProvider),!0)},c._preparePatchTransform=function(e,t){if(!(t.heading||t.tilt||t.roll||t.width||t.height||t.depth||t.anchor||t.anchorPosition))return;if(i.isNone(this._resources))return;const r=(e,t,r)=>i.unwrapOr(null!=e&&"complete"===e.type?e.newValue:t,r),s=r(t.heading,this.symbolLayer.heading,0),o=r(t.tilt,this.symbolLayer.tilt,0),a=r(t.roll,this.symbolLayer.roll,0),n=r(t.width,this.symbolLayer.width,void 0),c=r(t.height,this.symbolLayer.height,void 0),l=r(t.depth,this.symbolLayer.depth,void 0),d=r(t.anchor,this.symbolLayer.anchor,void 0),u=r(t.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete t.heading,delete t.tilt,delete t.roll,delete t.width,delete t.height,delete t.depth,delete t.anchor,delete t.anchorPosition;const p={heading:s,tilt:o,roll:a,anchor:d,anchorPosition:u},m=this._resources;this.loadStatus===v.LoadStatus.LOADED&&e.symbolLayerStatePatches.push((()=>{m.symbolSize=h.fromArray(y.objectSymbolLayerSizeWithResourceSize(m.resourceSize,{width:n,height:c,depth:l,isPrimitive:this.symbolLayer.isPrimitive}))})),e.graphics3DGraphicPatches.push(((e,t)=>{const r=this._computeLocalTransform(m,p,t,z),s=e.instanceIndex;m.lodRenderer.instanceData.setLocalTransform(s,r,!0)}))},c._preparePatchColor=function(e,t){if(!t.material||"partial"!==t.material.type)return;const s=t.material.diff;if(!s.color||"complete"!==s.color.type||null==s.color.newValue||null==s.color.oldValue)return;const o=s.color.newValue,a=i.isSome(o)?r.toUnitRGBA(o):d.ONES;delete s.color;const n=this._resources;i.isNone(n)||e.graphics3DGraphicPatches.push((e=>{let t;this._hasPerInstanceColor()?(n.lodRenderer.instanceData.setColor(e.instanceIndex,a),t=this._setMaterialTransparencyParams({},o)):t=this._setMaterialTransparencyParams({externalColor:a},o);for(const r of n.stageResources.materials)r.setParameters(t)}))},c._requiresTerrainElevation=function(e){return"absolute-height"!==e.mode},c._applyObjectRotation=function(e,t,r){if(!(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation&&t))return R.computeObjectRotation(e.heading,e.tilt,e.roll,r)},c._computeAnchor=function(e,t,r){const s=h.create();switch(r.anchor){case"center":l.copy(s,p.center(e)),l.negate(s,s);break;case"top":{const t=p.center(e);l.set(s,-t[0],-t[1],-e[5]);break}case"bottom":{const t=p.center(e);l.set(s,-t[0],-t[1],-e[2]);break}case"relative":{const t=p.center(e),i=p.size(e),o=r.anchorPosition,a=o?h.fromValues(o.x,o.y,o.z):h.ZEROS;l.multiply(s,i,a),l.add(s,s,t),l.negate(s,s);break}default:i.isSome(t)?l.negate(s,t):l.copy(s,h.ZEROS)}return s},c._applyAnchor=function(e,t,r){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const s=this._computeAnchor(e.resourceBoundingBox,e.pivotOffset,t);s&&n.translate(r,r,s)},c._hasPerInstanceColor=function(){return this._drivenProperties.color||this._drivenProperties.opacity},c._fastVisualVariableConvertOptions=function(e,t,r,s){const o=i.isSome(e)?h.fromArray(p.size(e)):h.ONES,a=i.isSome(e)?this._computeAnchor(e,s,this.symbolLayer):h.ZEROS,n=this._context.renderCoordsHelper.unitInMeters,c=R.computeObjectScale(i.isSome(t)?t:void 0,t,r,n),l=h.fromValues(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return{modelSize:o,symbolSize:i.isSome(t)?t:h.ONES,unitInMeters:n,transformation:{anchor:a,scale:c,rotation:l}}},t._createClass(S,[{key:"extentPadding",get:function(){return i.isSome(this._resources)?this._resources.extentPadding:0}},{key:"_isPrimitive",get:function(){return!(this.symbolLayer.resource&&this.symbolLayer.resource.href)}},{key:"lodRenderer",get:function(){return i.isSome(this._resources)?this._resources.lodRenderer:null}}]),S}(S.Graphics3DSymbolLayer);const D=h.create(),z=c.create(),j=c.create(),M=d.create(),V=new _.SampleElevationInfo;e.Graphics3DObjectSymbolLayer=F,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
