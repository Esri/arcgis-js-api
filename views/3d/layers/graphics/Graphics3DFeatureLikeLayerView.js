// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../Graphic","../../../../core/Accessor","../../../../core/compilerUtils","../../../../core/Handles","../../../../core/promiseUtils","../../../../core/watchUtils","../../../../core/accessorSupport/decorators","../../../../core/accessorSupport/diffUtils","../../../../geometry/support/webMercatorUtils","../../../../tasks/support/Query","./constants","./Graphics3DCore","./Graphics3DElevationAlignment","./Graphics3DFilterVisibility","./Graphics3DFrustumVisibility","./Graphics3DObjectStates","./Graphics3DScaleVisibility","./graphicUtils","../support/attributeUtils","../../../support/WatchUpdatingTracking"],(function(t,e,i,r,s,n,a,o,p,l,u,c,d,h,y,g,f,b,m,_,v,w,E){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var V=function(t){function e(e){var i=t.call(this,e)||this;return i._handles=new a,i.watchUpdatingTracking=new E.WatchUpdatingTracking,i.suspendResumeExtentMode="computed",i.dataExtent=null,i.suspendResumeExtent=null,i}return i.__extends(e,t),Object.defineProperty(e.prototype,"suspended",{get:function(){return this.scaleVisibility&&this.scaleVisibility.suspended||this.frustumVisibility&&this.frustumVisibility.suspended},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"suspendInfo",{get:function(){var t={};return this.scaleVisibility&&this.scaleVisibility.suspended&&(t.outsideScaleRange=!0),this.frustumVisibility&&this.frustumVisibility.suspended&&(t.outsideOfView=!0),t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"updating",{get:function(){return!!(this.graphicsCore&&this.graphicsCore.updating||this.frustumVisibility&&this.frustumVisibility.updating||this.watchUpdatingTracking&&this.watchUpdatingTracking.updating)},enumerable:!1,configurable:!0}),e.prototype.normalizeCtorArgs=function(t){var e=t.frustumVisibilityEnabled?new b:null,i=t.scaleVisibilityEnabled?new _:null,r=(t.filterVisibilityEnabled||t.timeExtentVisibilityEnabled)&&"multipatch"!==t.layer.geometryType?new f.Graphics3DFilterVisibility:null,s=t.elevationAlignmentEnabled?new g.default:null;return{graphicsCore:new y.Graphics3DCore({owner:t.owner,layer:t.layer,preferredUpdatePolicy:t.preferredUpdatePolicy,elevationFeatureExpressionEnabled:t.elevationFeatureExpressionEnabled,graphicSymbolSupported:!1,hasZ:t.owner.hasZ,hasM:t.owner.hasM}),frustumVisibility:e,scaleVisibility:i,filterVisibility:r,elevationAlignment:s,updateClippingExtent:t.updateClippingExtent,suspendResumeExtentMode:t.suspendResumeExtentMode,dataExtent:t.dataExtent}},e.prototype.initialize=function(){var t=this;this.scaleVisibility&&this.watchUpdatingTracking.add(this.layer,"scaleRangeId",(function(){return t.scaleVisibility.layerMinMaxScaleChangeHandler()})),this.filterVisibility&&(this.watchUpdatingTracking.add(this.owner,"filter",(function(){return t.filterVisibility.filterChanged()})),this.watchUpdatingTracking.add(this.owner,"timeExtent",(function(){return t.filterVisibility.filterChanged()}))),this.elevationAlignment&&this.watchUpdatingTracking.add(this.layer,"elevationInfo",(function(e,i){u.diff(e,i)&&t.watchUpdatingTracking.addPromise(t.graphicsCore.elevationInfoChange())})),this.watchUpdatingTracking.add(this.layer,"labelsVisible",(function(){return t.graphicsCore.updateVisibilityInfo()})),this.watchUpdatingTracking.add(this.layer,"labelingInfo",(function(e,i){u.diff(e,i)&&t.graphicsCore.updateLabelingInfo()}))},e.prototype.setup=function(){return i.__awaiter(this,void 0,void 0,(function(){var t,e,r,s,n=this;return i.__generator(this,(function(i){switch(i.label){case 0:return this.frustumVisibility&&this.frustumVisibility.setup(this.owner),t=this.owner,e=this.owner.view.basemapTerrain,r=function(t,e,i){return n.graphicsCore.spatialIndex.queryGraphicUIDsInExtent(t,e,i)},this.scaleVisibility&&this.scaleVisibility.setup(t,this.layer,r,this.graphicsCore,e),this.filterVisibility&&("filter"in t||"timeExtent"in t)&&this.filterVisibility.setup(t,this.graphicsCore),this.elevationAlignment&&(s=t.view.elevationProvider,this.elevationAlignment.setup(t,r,this.graphicsCore,s)),this._set("objectStates",new m.Graphics3DObjectStates(this.graphicsCore)),this._set("labeling",this.owner.view.labeler.addGraphicsOwner(this.graphicsCore,this.scaleVisibility)),this._set("deconfliction",t.view.deconflictor.addGraphicsOwner(this.graphicsCore)),[4,o.logOnError(this.graphicsCore.setup({elevationAlignment:this.elevationAlignment,scaleVisibility:this.scaleVisibility,filterVisibility:this.filterVisibility,deconflictor:this.deconfliction,labeler:this.labeling,objectStates:this.objectStates}))];case 1:return i.sent(),this.watchUpdatingTracking.add(this.layer,"renderer",(function(t){return n.watchUpdatingTracking.addPromise(n.graphicsCore.rendererChange(t))})),this.watchUpdatingTracking.add(t,"fullOpacity",(function(){return n.graphicsCore.opacityChange()})),this.setupSuspendResumeExtent(),this.updateClippingExtent&&(this.watchUpdatingTracking.add(t.view,"clippingArea",(function(){return n._updateClippingExtent()})),this._updateClippingExtent()),this.graphicsCore.startCreateGraphics(),this.graphicsCore.labelsEnabled?[4,o.logOnError(this.graphicsCore.updateLabelingInfo())]:[3,3];case 2:i.sent(),i.label=3;case 3:return[2]}}))}))},e.prototype.destroy=function(){this._handles&&(this._handles.destroy(),this._handles=null);for(var t=0,e=["watchUpdatingTracking","frustumVisibility","scaleVisibility","filterVisibility","elevationAlignment","objectStates","graphicsCore"];t<e.length;t++){var i=e[t],r=this[i];r&&(r.destroy(),this._set(i,null))}this._set("layer",null),this._set("owner",null)},e.prototype.highlight=function(t,e){var i=this;if(t instanceof d){var s=this.objectStates.acquireSet(0,e),n=s.set,a=s.handle;return this.owner.queryObjectIds(t).then((function(t){return i.objectStates.setObjectIds(n,t)})),a}if("number"==typeof t||"string"==typeof t)return this.highlight([t],e);if(t instanceof r)return this.highlight([t],e);if("toArray"in t&&(t=t.toArray()),Array.isArray(t)&&t.length>0){if(t[0]instanceof r){var o=t;if(!e||!o[0].attributes||null===w.attributeLookup(o[0].attributes,e)){var p=o.map((function(t){return t.uid})),l=this.objectStates.acquireSet(0,null),u=l.set;a=l.handle;return this.objectStates.setUids(u,p),a}t=o.map((function(t){return w.attributeLookup(t.attributes,e)}))}if("number"==typeof t[0]||"string"==typeof t[0]){var c=t,h=this.objectStates.acquireSet(0,e);u=h.set,a=h.handle;return this.objectStates.setObjectIds(u,c),a}}return C},e.prototype._updateClippingExtent=function(){var t=this.owner.view.clippingArea;this.graphicsCore.setClippingExtent(t,this.owner.view.spatialReference)&&(this.updateClippingExtent(t)||this.graphicsCore.recreateAllGraphics())},e.prototype.setupSuspendResumeExtent=function(){var t=this;(this.frustumVisibility||this.scaleVisibility)&&this._handles.add(p.init(this,"suspendResumeExtentMode",(function(){switch(t._handles.remove(x),t.suspendResumeExtentMode){case"computed":t._handles.add([p.init(t.graphicsCore,"computedExtent",(function(e){return t.updateSuspendResumeExtent(e)})),t.graphicsCore.watch("extentPadding",(function(){return t.updateSuspendResumeExtent(t.graphicsCore.computedExtent)}))],x);break;case"data":t._handles.add([p.init(t,"dataExtent",(function(e){return t.updateSuspendResumeExtent(e)})),t.graphicsCore.watch("extentPadding",(function(){return t.updateSuspendResumeExtent(t.dataExtent)}))],x);break;default:n.neverReached(t.suspendResumeExtentMode)}})))},e.prototype.updateSuspendResumeExtent=function(t){t?this.suspendResumeExtentChanged(this.extentToSuspendResumeRect(t,this.suspendResumeExtent)):this.suspendResumeExtentChanged(null)},e.prototype.extentToSuspendResumeRect=function(t,e){var i=this.owner.view.spatialReference;if(!t.spatialReference.equals(i)){if(!c.canProject(t,i))return;t=c.project(t,i)}return v.enlargeExtent(t,e,h.SUSPEND_RESUME_EXTENT_OPTIMISM,this.graphicsCore.extentPadding)},e.prototype.suspendResumeExtentChanged=function(t){this.frustumVisibility&&this.frustumVisibility.setExtent(t),this.scaleVisibility&&this.scaleVisibility.setExtent(t)},i.__decorate([l.property({aliasOf:"graphicsCore.layer"})],e.prototype,"layer",void 0),i.__decorate([l.property({aliasOf:"graphicsCore.owner"})],e.prototype,"owner",void 0),i.__decorate([l.property({constructOnly:!0})],e.prototype,"updateClippingExtent",void 0),i.__decorate([l.property({constructOnly:!0})],e.prototype,"graphicsCore",void 0),i.__decorate([l.property({constructOnly:!0})],e.prototype,"scaleVisibility",void 0),i.__decorate([l.property({constructOnly:!0})],e.prototype,"filterVisibility",void 0),i.__decorate([l.property({constructOnly:!0})],e.prototype,"elevationAlignment",void 0),i.__decorate([l.property({constructOnly:!0})],e.prototype,"frustumVisibility",void 0),i.__decorate([l.property({readOnly:!0})],e.prototype,"deconfliction",void 0),i.__decorate([l.property({readOnly:!0})],e.prototype,"labeling",void 0),i.__decorate([l.property({readOnly:!0})],e.prototype,"objectStates",void 0),i.__decorate([l.property({readOnly:!0})],e.prototype,"watchUpdatingTracking",void 0),i.__decorate([l.property()],e.prototype,"suspendResumeExtentMode",void 0),i.__decorate([l.property()],e.prototype,"dataExtent",void 0),i.__decorate([l.property({readOnly:!0,dependsOn:["scaleVisibility.suspended","frustumVisibility.suspended"]})],e.prototype,"suspended",null),i.__decorate([l.property({readOnly:!0,dependsOn:["scaleVisibility.suspended","frustumVisibility.suspended"]})],e.prototype,"suspendInfo",null),i.__decorate([l.property({readOnly:!0,dependsOn:["graphicsCore.updating","frustumVisibility.updating","watchUpdatingTracking.updating"]})],e.prototype,"updating",null),e=i.__decorate([l.subclass("esri.views.3d.layers.graphics.Graphics3DFeatureLikeLayerView")],e)}(s);e.default=V;var x="suspendResumeExtentMode",C={remove:function(){},pause:function(){},resume:function(){}}}));