/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import"../../../../core/has.js";import{isNone as t,isSome as e,unwrapOr as o}from"../../../../core/maybe.js";import{slice as n}from"../../../../core/typedArrayUtil.js";import{d as r}from"../../../../chunks/vec2.js";import{s as i}from"../../../../chunks/vec3.js";import{c as a}from"../../../../chunks/vec3f64.js";import{projectBuffer as s,lonLatToWebMercatorComparable as u}from"../../../../geometry/projection.js";import{getReferenceEllipsoid as c}from"../../../../geometry/projectionEllipsoid.js";import{CounterClockwiseMode as l,pathsToTriangulationInfo as p}from"../../../../geometry/support/triangulationUtils.js";import{ViewingMode as f}from"../../../ViewingMode.js";import{WHITE_UNIT as m}from"./constants.js";import{applyPerVertexElevationAlignment as h}from"./elevationAlignmentUtils.js";import{DRAPED_Z as E}from"../../terrain/OverlayRenderer.js";import{PrimitiveType as T}from"../../webgl-engine/lib/basicInterfaces.js";import{Geometry as g}from"../../webgl-engine/lib/Geometry.js";import{VertexAttribute as y}from"../../webgl-engine/lib/VertexAttribute.js";import{CapType as A}from"../../webgl-engine/shaders/RibbonLineTechniqueConfiguration.js";function O(t){const e=[],o=[];I(t,o,e);const n=o[0][1].data,r=e[0][1].length,i=new Uint16Array(r);return j(t,o,e),S(t,o,e,i),w(t,o,e,i),U(t,o,e,i),F(t,o,e,i),v(t,o,e,i),C(t,o,e,n),new g(o,e,T.Line)}function R(t,e,o,n){const r="polygon"===t.type?l.CCW_IS_HOLE:l.NONE,i="polygon"===t.type?t.rings:t.paths,{position:a,outlines:s}=p(i,t.hasZ,r),u=new Float64Array(a.length),c=h(a,t.spatialReference,0,u,0,a,0,a.length/3,e,o,n),f=null!=c;return{lines:f?b(s,a,u):[],projectionSuccess:f,sampledElevation:c}}function b(t,e,o){const n=new Array;for(const{index:r,count:i}of t){if(i<=1)continue;const t=3*r,a=t+3*i;n.push({position:e.subarray(t,a),mapPosition:o?o.subarray(t,a):void 0})}return n}function d(t,e){const o="polygon"===t.type?l.CCW_IS_HOLE:l.NONE,n="polygon"===t.type?t.rings:t.paths,{position:r,outlines:i}=p(n,!1,o),a=s(r,t.spatialReference,0,r,e,0,r.length/3);for(let s=2;s<r.length;s+=3)r[s]=E;return{lines:a?b(i,r):[],projectionSuccess:a}}function I(t,e,o){const{attributeData:{position:r},removeDuplicateStartEnd:i}=t,a=D(r)&&i===P.REMOVE,s=r.length/3-(a?1:0),u=new Uint32Array(2*(s-1)),c=a?n(r,0,r.length-3):r;let l=0;for(let n=0;n<s-1;n++)u[l++]=n,u[l++]=n+1;e.push([y.POSITION,{size:3,data:c,exclusive:a}]),o.push([y.POSITION,u])}function j(e,o,n){const r=e.attributeData.mapPosition;t(r)||(n.push([y.MAPPOS,n[0][1]]),o.push([y.MAPPOS,{size:3,data:r}]))}function S(t,n,r,i){if(e(t.attributeData.colorFeature))return;const a=t.attributeData.color;n.push([y.COLOR,{size:4,data:o(a,m)}]),r.push([y.COLOR,i])}function U(e,o,n,r){const i=e.attributeData.colorFeature;t(i)||(o.push([y.COLORFEATUREATTRIBUTE,{size:1,data:new Float32Array([i])}]),n.push([y.COLOR,r]))}function w(t,n,r,i){if(e(t.attributeData.sizeFeature))return;const a=t.attributeData.size;n.push([y.SIZE,{size:1,data:[o(a,1)]}]),r.push([y.SIZE,i])}function F(e,o,n,r){const i=e.attributeData.sizeFeature;t(i)||(o.push([y.SIZEFEATUREATTRIBUTE,{size:1,data:new Float32Array([i])}]),n.push([y.SIZEFEATUREATTRIBUTE,r]))}function v(e,o,n,r){const i=e.attributeData.opacityFeature;t(i)||(o.push([y.OPACITYFEATUREATTRIBUTE,{size:1,data:new Float32Array([i])}]),n.push([y.OPACITYFEATUREATTRIBUTE,r]))}function C(e,o,n,a){if(t(e.overlayInfo)||e.overlayInfo.renderCoordsHelper.viewingMode!==f.Global||!e.overlayInfo.spatialReference.isGeographic)return;const s=new Float64Array(a.length),l=c(e.overlayInfo.spatialReference);for(let t=0;t<s.length;t+=3)u(a,t,s,t,l);const p=a.length/3,m=new Float32Array(p+1);let h=z,E=N,T=0,g=0;i(h,s[g++],s[g++],s[g++]),m[0]=0;for(let t=1;t<p+1;++t)t===p&&(g=0),i(E,s[g++],s[g++],s[g++]),T+=r(h,E),m[t]=T,[h,E]=[E,h];o.push([y.DISTANCETOSTART,{size:1,data:m}]),n.push([y.DISTANCETOSTART,n[0][1]])}function D(t){const e=t.length;return t[0]===t[e-3]&&t[1]===t[e-2]&&t[2]===t[e-1]}var P;!function(t){t[t.KEEP=0]="KEEP",t[t.REMOVE=1]="REMOVE"}(P||(P={}));const z=a(),N=a();function L(t){switch(t){case"butt":return A.BUTT;case"square":return A.SQUARE;case"round":return A.ROUND;default:return null}}export{P as RemoveDuplicateStartEnd,O as createGeometry,R as geometryToRenderInfo,d as geometryToRenderInfoDraped,L as parseCapType};
