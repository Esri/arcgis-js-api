/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../core/has","../../../../core/maybe","../../../../core/typedArrayUtil","../../../../chunks/vec2","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/projection","../../../../geometry/projectionEllipsoid","../../../../geometry/support/triangulationUtils","../../../ViewingMode","./constants","./elevationAlignmentUtils","../../terrain/OverlayRenderer","../../webgl-engine/lib/basicInterfaces","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/VertexAttribute","../../../../chunks/RibbonLine.glsl"],(function(e,t,r,n,o,i,a,s,u,l,c,p,A,T,E,f,b,y){"use strict";function d(e){const t=[],r=[];I(e,r,t);const n=r[0][1].data,o=t[0][1].length,i=new Uint16Array(o);return O(e,r,t),C(e,r,t,i),m(e,r,t,i),S(e,r,t,i),v(e,r,t,i),w(e,r,t,i),V(e,r,t,n),new f.Geometry(r,t,E.PrimitiveType.Line)}function g(e,t,r,n){const o="polygon"===e.type?l.CounterClockwiseMode.CCW_IS_HOLE:l.CounterClockwiseMode.NONE,i="polygon"===e.type?e.rings:e.paths,{position:a,outlines:s}=l.pathsToTriangulationInfo(i,e.hasZ,o),u=new Float64Array(a.length),c=A.applyPerVertexElevationAlignment(a,e.spatialReference,0,u,0,a,0,a.length/3,t,r,n),p=null!=c;return{lines:p?h(s,a,u):[],projectionSuccess:p,sampledElevation:c}}function h(e,t,r){const n=new Array;for(const{index:o,count:i}of e){if(i<=1)continue;const e=3*o,a=e+3*i;n.push({position:t.subarray(e,a),mapPosition:r?r.subarray(e,a):void 0})}return n}function R(e,t){const r="polygon"===e.type?l.CounterClockwiseMode.CCW_IS_HOLE:l.CounterClockwiseMode.NONE,n="polygon"===e.type?e.rings:e.paths,{position:o,outlines:i}=l.pathsToTriangulationInfo(n,!1,r),a=s.projectBuffer(o,e.spatialReference,0,o,t,0,o.length/3);for(let s=2;s<o.length;s+=3)o[s]=T.DRAPED_Z;return{lines:a?h(i,o):[],projectionSuccess:a}}function I(t,r,o){const{attributeData:{position:i},removeDuplicateStartEnd:a}=t,s=x(i)&&a===e.RemoveDuplicateStartEnd.REMOVE,u=i.length/3-(s?1:0),l=new Uint32Array(2*(u-1)),c=s?n.slice(i,0,i.length-3):i;let p=0;for(let e=0;e<u-1;e++)l[p++]=e,l[p++]=e+1;r.push([b.VertexAttribute.POSITION,{size:3,data:c,exclusive:s}]),o.push([b.VertexAttribute.POSITION,l])}function O(e,t,n){const o=e.attributeData.mapPosition;r.isNone(o)||(n.push([b.VertexAttribute.MAPPOS,n[0][1]]),t.push([b.VertexAttribute.MAPPOS,{size:3,data:o}]))}function C(e,t,n,o){if(r.isSome(e.attributeData.colorFeature))return;const i=e.attributeData.color;t.push([b.VertexAttribute.COLOR,{size:4,data:r.unwrapOr(i,p.WHITE_UNIT)}]),n.push([b.VertexAttribute.COLOR,o])}function S(e,t,n,o){const i=e.attributeData.colorFeature;r.isNone(i)||(t.push([b.VertexAttribute.COLORFEATUREATTRIBUTE,{size:1,data:new Float32Array([i])}]),n.push([b.VertexAttribute.COLOR,o]))}function m(e,t,n,o){if(r.isSome(e.attributeData.sizeFeature))return;const i=e.attributeData.size;t.push([b.VertexAttribute.SIZE,{size:1,data:[r.unwrapOr(i,1)]}]),n.push([b.VertexAttribute.SIZE,o])}function v(e,t,n,o){const i=e.attributeData.sizeFeature;r.isNone(i)||(t.push([b.VertexAttribute.SIZEFEATUREATTRIBUTE,{size:1,data:new Float32Array([i])}]),n.push([b.VertexAttribute.SIZEFEATUREATTRIBUTE,o]))}function w(e,t,n,o){const i=e.attributeData.opacityFeature;r.isNone(i)||(t.push([b.VertexAttribute.OPACITYFEATUREATTRIBUTE,{size:1,data:new Float32Array([i])}]),n.push([b.VertexAttribute.OPACITYFEATUREATTRIBUTE,o]))}function V(e,t,n,a){if(r.isNone(e.overlayInfo)||e.overlayInfo.renderCoordsHelper.viewingMode!==c.ViewingMode.Global||!e.overlayInfo.spatialReference.isGeographic)return;const l=new Float64Array(a.length),p=u.getReferenceEllipsoid(e.overlayInfo.spatialReference);for(let r=0;r<l.length;r+=3)s.lonLatToWebMercatorComparable(a,r,l,r,p);const A=a.length/3,T=new Float32Array(A+1);let E=U,f=F,y=0,d=0;i.set(E,l[d++],l[d++],l[d++]),T[0]=0;for(let r=1;r<A+1;++r)r===A&&(d=0),i.set(f,l[d++],l[d++],l[d++]),y+=o.dist(E,f),T[r]=y,[E,f]=[f,E];t.push([b.VertexAttribute.DISTANCETOSTART,{size:1,data:T}]),n.push([b.VertexAttribute.DISTANCETOSTART,n[0][1]])}function x(e){const t=e.length;return e[0]===e[t-3]&&e[1]===e[t-2]&&e[2]===e[t-1]}var D;e.RemoveDuplicateStartEnd=void 0,(D=e.RemoveDuplicateStartEnd||(e.RemoveDuplicateStartEnd={}))[D.KEEP=0]="KEEP",D[D.REMOVE=1]="REMOVE";const U=a.create(),F=a.create();function P(e){switch(e){case"butt":return y.CapType.BUTT;case"square":return y.CapType.SQUARE;case"round":return y.CapType.ROUND;default:return null}}e.createGeometry=d,e.geometryToRenderInfo=g,e.geometryToRenderInfoDraped=R,e.parseCapType=P,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
