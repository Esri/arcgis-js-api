/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../../core/has","../../../../core/mathUtils","../../../../core/maybe","../../../../core/typedArrayUtil","../../../../chunks/vec2","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/projection","../../../../geometry/projectionEllipsoid","../../../../geometry/support/triangulationUtils","./constants","./elevationAlignmentUtils","../../terrain/OverlayRenderer","../../webgl-engine/lib/Geometry"],(function(t,e,n,o,r,a,i,s,u,c,l,p,f,h,y){"use strict";function d(t){const e=[],n=[];A(t,n,e);const o=n[0][1].data,r=e[0][1].length,a=new Uint16Array(r);return v(t,n,e),z(t,n,e,a),F(t,n,e,a),w(t,n,e,a),D(t,n,e,a),I(t,n,e,a),T(t,n,e,o),P(t,n,e,o),new y.Geometry(n,e,2)}function g(t,e,n,o){const r="polygon"===t.type?1:0,a="polygon"===t.type?t.rings:t.paths,{position:i,outlines:s}=l.pathsToTriangulationInfo(a,t.hasZ,r),u=new Float64Array(i.length),c=f.applyPerVertexElevationAlignment(i,t.spatialReference,0,u,0,i,0,i.length/3,e,n,o),p=null!=c;return{lines:p?b(s,i,u):[],projectionSuccess:p,sampledElevation:c}}function b(t,e,n){const o=new Array;for(const{index:r,count:a}of t){if(a<=1)continue;const t=3*r,i=t+3*a;o.push({position:e.subarray(t,i),mapPosition:n?n.subarray(t,i):void 0})}return o}function m(t,e){const n="polygon"===t.type?1:0,o="polygon"===t.type?t.rings:t.paths,{position:r,outlines:a}=l.pathsToTriangulationInfo(o,!1,n),i=u.projectBuffer(r,t.spatialReference,0,r,e,0,r.length/3);for(let s=2;s<r.length;s+=3)r[s]=h.DRAPED_Z;return{lines:i?b(a,r):[],projectionSuccess:i}}function A(t,e,n){const{attributeData:{position:o},removeDuplicateStartEnd:a}=t,i=S(o)&&1===a,s=o.length/3-(i?1:0),u=new Uint32Array(2*(s-1)),c=i?r.slice(o,0,o.length-3):o;let l=0;for(let r=0;r<s-1;r++)u[l++]=r,u[l++]=r+1;e.push(["position",{size:3,data:c,exclusive:i}]),n.push(["position",u])}function v(t,e,n){const r=t.attributeData.mapPosition;o.isNone(r)||(n.push(["mapPos",n[0][1]]),e.push(["mapPos",{size:3,data:r}]))}function z(t,e,n,r){if(o.isSome(t.attributeData.colorFeature))return;const a=t.attributeData.color;e.push(["color",{size:4,data:o.unwrapOr(a,p.WHITE_UNIT)}]),n.push(["color",r])}function w(t,e,n,r){const a=t.attributeData.colorFeature;o.isNone(a)||(e.push(["colorFeatureAttribute",{size:1,data:new Float32Array([a])}]),n.push(["color",r]))}function F(t,e,n,r){if(o.isSome(t.attributeData.sizeFeature))return;const a=t.attributeData.size;e.push(["size",{size:1,data:[o.unwrapOr(a,1)]}]),n.push(["size",r])}function D(t,e,n,r){const a=t.attributeData.sizeFeature;o.isNone(a)||(e.push(["sizeFeatureAttribute",{size:1,data:new Float32Array([a])}]),n.push(["sizeFeatureAttribute",r]))}function I(t,e,n,r){const a=t.attributeData.opacityFeature;o.isNone(a)||(e.push(["opacityFeatureAttribute",{size:1,data:new Float32Array([a])}]),n.push(["opacityFeatureAttribute",r]))}function T(t,e,r,a){if("round"!==t.join)return;const s=a.length/3,u=new Float32Array(s),c=j,l=E;i.set(c,0,0,0);const p=o.unwrapOr(t.uniformSize,1);for(let o=-1;o<s;++o){const t=o<0?s+o:o,e=(o+1)%s;if(i.set(l,a[3*e+0]-a[3*t+0],a[3*e+1]-a[3*t+1],a[3*e+2]-a[3*t+2]),i.normalize(l,l),o>=0){const t=1*((Math.PI-n.acosClamped(i.dot(c,l)))*M)*R(p);u[o]=Math.max(Math.floor(t),0)}i.scale(c,l,-1)}e.push(["subdivisions",{size:1,data:u}]),r.push(["subdivisions",r[0][1]])}function P(t,e,n,r){if(o.isNone(t.overlayInfo)||1!==t.overlayInfo.renderCoordsHelper.viewingMode||!t.overlayInfo.spatialReference.isGeographic)return;const s=new Float64Array(r.length),l=c.getReferenceEllipsoid(t.overlayInfo.spatialReference);for(let o=0;o<s.length;o+=3)u.lonLatToWebMercatorComparable(r,o,s,o,l);const p=r.length/3,f=new Float32Array(p+1);let h=j,y=E,d=0,g=0;i.set(h,s[g++],s[g++],s[g++]),f[0]=0;for(let o=1;o<p+1;++o)o===p&&(g=0),i.set(y,s[g++],s[g++],s[g++]),d+=a.dist(h,y),f[o]=d,[h,y]=[y,h];e.push(["distanceToStart",{size:1,data:f}]),n.push(["distanceToStart",n[0][1]])}function R(t){return 1.863798+-2.0062872/(1+t/18.2313)**.8856294}function S(t){const e=t.length;return t[0]===t[e-3]&&t[1]===t[e-2]&&t[2]===t[e-1]}const j=s.create(),E=s.create(),M=4/Math.PI;function U(t){switch(t){case"butt":return 0;case"square":return 1;case"round":return 2;default:return null}}t.createGeometry=d,t.geometryToRenderInfo=g,t.geometryToRenderInfoDraped=m,t.parseCapType=U,Object.defineProperty(t,"__esModule",{value:!0})}));
