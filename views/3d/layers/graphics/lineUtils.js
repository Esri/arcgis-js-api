// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","../../../../core/mathUtils","../../../../core/maybe","../../../../core/typedArrayUtil","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../geometry/support/triangulationUtils","./constants","./elevationAlignmentUtils","../../support/projectionUtils","../../terrain/OverlayRenderer","../../webgl-engine/lib/GeometryData","../../webgl-engine/shaders/RibbonLineTechnique"],(function(t,e,r,n,a,o,i,s,u,b,l,f,I,d){"use strict";function c(t,e,r){for(var n=new Array,a=0,o=t;a<o.length;a++){var i=o[a],s=i.index,u=i.count;if(!(u<=1)){var b=3*s,l=b+3*u;n.push({position:e.subarray(b,l),mapPosition:r?r.subarray(b,l):void 0})}}return n}Object.defineProperty(e,"__esModule",{value:!0}),e.geometryToRenderInfoDraped=e.geometryToRenderInfo=e.createGeometryData=void 0,e.createGeometryData=function(t){var e={},i={};!function(t,e,r){for(var n=t.attributeData.position,o=t.removeDuplicateStartEnd,i=(I=n,c=void 0,c=I.length,I[0]===I[c-3]&&I[1]===I[c-2]&&I[2]===I[c-1]&&1===o),s=n.length/3-(i?1:0),u=new Uint32Array(2*(s-1)),b=i?a.slice(n,0,n.length-3):n,l=0,f=0;f<s-1;f++)u[l++]=f,u[l++]=f+1;var I,c;e[d.RibbonVertexAttributeConstants.POSITION]={size:3,data:b,offsetIdx:0,strideIdx:3},r[d.RibbonVertexAttributeConstants.POSITION]=u}(t,i,e);var s=new Uint32Array(e[d.RibbonVertexAttributeConstants.POSITION].length);return function(t,e,r){var a=t.attributeData.mapPosition;if(n.isNone(a))return;r.mapPos=r[d.RibbonVertexAttributeConstants.POSITION],e.mapPos={size:3,data:a,offsetIdx:0,strideIdx:3}}(t,i,e),function(t,e,r,a){if(n.isSome(t.attributeData.colorFeature))return;var o=t.attributeData.color;e[d.RibbonVertexAttributeConstants.COLOR]={size:4,data:n.unwrapOr(o,u.WHITE_UNIT),offsetIdx:0,strideIdx:4},r[d.RibbonVertexAttributeConstants.COLOR]=a}(t,i,e,s),function(t,e,r,a){if(n.isSome(t.attributeData.sizeFeature))return;var o=t.attributeData.size;e[d.RibbonVertexAttributeConstants.SIZE]={size:1,data:new Float32Array([n.unwrapOr(o,1)]),offsetIdx:0,strideIdx:1},r[d.RibbonVertexAttributeConstants.SIZE]=a}(t,i,e,s),function(t,e,r,a){var o=t.attributeData.colorFeature;if(n.isNone(o))return;e[d.RibbonVertexAttributeConstants.COLORFEATUREATTRIBUTE]={size:1,data:new Float32Array([o]),offsetIdx:0,strideIdx:1},r[d.RibbonVertexAttributeConstants.COLOR]=a}(t,i,e,s),function(t,e,r,a){var o=t.attributeData.sizeFeature;if(n.isNone(o))return;e[d.RibbonVertexAttributeConstants.SIZEFEATUREATTRIBUTE]={size:1,data:new Float32Array([o]),offsetIdx:0,strideIdx:1},r[d.RibbonVertexAttributeConstants.SIZEFEATUREATTRIBUTE]=a}(t,i,e,s),function(t,e,r,a){var o=t.attributeData.opacityFeature;if(n.isNone(o))return;e[d.RibbonVertexAttributeConstants.OPACITYFEATUREATTRIBUTE]={size:1,data:new Float32Array([o]),offsetIdx:0,strideIdx:1},r[d.RibbonVertexAttributeConstants.OPACITYFEATUREATTRIBUTE]=a}(t,i,e,s),function(t,e,a){if("round"!==t.join)return;var i=e[d.RibbonVertexAttributeConstants.POSITION].data,s=i.length/3,u=new Float32Array(s),b=p,l=A;o.vec3.set(b,0,0,0);for(var f=n.unwrapOr(t.uniformSize,1),I=-1;I<s;++I){var c=I<0?s+I:I,x=(I+1)%s;if(o.vec3.set(l,i[3*x+0]-i[3*c+0],i[3*x+1]-i[3*c+1],i[3*x+2]-i[3*c+2]),o.vec3.normalize(l,l),I>=0){var T=1*((Math.PI-r.acosClamped(o.vec3.dot(b,l)))*R)*(v=f,1.863798+-2.0062872/Math.pow(1+v/18.2313,.8856294));u[I]=Math.max(Math.floor(T),0)}o.vec3.scale(b,l,-1)}var v;e[d.RibbonVertexAttributeConstants.SUBDIVISIONS]={size:1,data:u,offsetIdx:0,strideIdx:1},a[d.RibbonVertexAttributeConstants.SUBDIVISIONS]=a[d.RibbonVertexAttributeConstants.POSITION]}(t,i,e),new I.GeometryData(i,e,"line")},e.geometryToRenderInfo=function(t,e,r,n){var a="polygon"===t.type?1:0,o="polygon"===t.type?t.rings:t.paths,i=s.pathsToTriangulationInfo(o,t.hasZ,a),u=i.position,l=i.outlines,f=new Float64Array(u.length),I=b.applyPerVertexElevationAlignment(u,t.spatialReference,0,f,0,u,0,u.length/3,e,r,n),d=null!=I;return{lines:d?c(l,u,f):[],projectionSuccess:d,sampledElevation:I}},e.geometryToRenderInfoDraped=function(t,e){for(var r="polygon"===t.type?1:0,n="polygon"===t.type?t.rings:t.paths,a=s.pathsToTriangulationInfo(n,!1,r),o=a.position,i=a.outlines,u=l.bufferToBuffer(o,t.spatialReference,0,o,e,0,o.length/3),b=2;b<o.length;b+=3)o[b]=f.DRAPED_Z;return{lines:u?c(i,o):[],projectionSuccess:u}};var p=i.vec3f64.create(),A=i.vec3f64.create(),R=4/Math.PI}));