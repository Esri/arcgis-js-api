/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../../../core/mathUtils","../../../../core/maybe","../../../../core/typedArrayUtil","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/projection","../../../../geometry/support/triangulationUtils","./constants","./elevationAlignmentUtils","../../terrain/OverlayRenderer","../../webgl-engine/lib/Geometry"],(function(t,e,n,o,r,a,i,s,u,c,l,p){"use strict";function f(t){const e=[],n=[];g(t,n,e);const o=n[0][1].data,r=e[0][1].length,a=new Uint16Array(r);return m(t,n,e),b(t,n,e,a),A(t,n,e,a),z(t,n,e,a),F(t,n,e,a),w(t,n,e,a),D(t,n,e,o),new p.Geometry(n,e,2)}function h(t,e,n,o){const r="polygon"===t.type?1:0,a="polygon"===t.type?t.rings:t.paths,{position:i,outlines:u}=s.pathsToTriangulationInfo(a,t.hasZ,r),l=new Float64Array(i.length),p=c.applyPerVertexElevationAlignment(i,t.spatialReference,0,l,0,i,0,i.length/3,e,n,o),f=null!=p;return{lines:f?y(u,i,l):[],projectionSuccess:f,sampledElevation:p}}function y(t,e,n){const o=new Array;for(const{index:r,count:a}of t){if(a<=1)continue;const t=3*r,i=t+3*a;o.push({position:e.subarray(t,i),mapPosition:n?n.subarray(t,i):void 0})}return o}function d(t,e){const n="polygon"===t.type?1:0,o="polygon"===t.type?t.rings:t.paths,{position:r,outlines:a}=s.pathsToTriangulationInfo(o,!1,n),u=i.projectBuffer(r,t.spatialReference,0,r,e,0,r.length/3);for(let i=2;i<r.length;i+=3)r[i]=l.DRAPED_Z;return{lines:u?y(a,r):[],projectionSuccess:u}}function g(t,e,n){const{attributeData:{position:r},removeDuplicateStartEnd:a}=t,i=P(r)&&1===a,s=r.length/3-(i?1:0),u=new Uint32Array(2*(s-1)),c=i?o.slice(r,0,r.length-3):r;let l=0;for(let o=0;o<s-1;o++)u[l++]=o,u[l++]=o+1;e.push(["position",{size:3,data:c,exclusive:i}]),n.push(["position",u])}function m(t,e,o){const r=t.attributeData.mapPosition;n.isNone(r)||(o.push(["mapPos",o[0][1]]),e.push(["mapPos",{size:3,data:r}]))}function b(t,e,o,r){if(n.isSome(t.attributeData.colorFeature))return;const a=t.attributeData.color;e.push(["color",{size:4,data:n.unwrapOr(a,u.WHITE_UNIT)}]),o.push(["color",r])}function z(t,e,o,r){const a=t.attributeData.colorFeature;n.isNone(a)||(e.push(["colorFeatureAttribute",{size:1,data:new Float32Array([a])}]),o.push(["color",r]))}function A(t,e,o,r){if(n.isSome(t.attributeData.sizeFeature))return;const a=t.attributeData.size;e.push(["size",{size:1,data:[n.unwrapOr(a,1)]}]),o.push(["size",r])}function F(t,e,o,r){const a=t.attributeData.sizeFeature;n.isNone(a)||(e.push(["sizeFeatureAttribute",{size:1,data:new Float32Array([a])}]),o.push(["sizeFeatureAttribute",r]))}function w(t,e,o,r){const a=t.attributeData.opacityFeature;n.isNone(a)||(e.push(["opacityFeatureAttribute",{size:1,data:new Float32Array([a])}]),o.push(["opacityFeatureAttribute",r]))}function D(t,o,a,i){if("round"!==t.join)return;const s=i.length/3,u=new Float32Array(s),c=I,l=T;r.set(c,0,0,0);const p=n.unwrapOr(t.uniformSize,1);for(let n=-1;n<s;++n){const t=n<0?s+n:n,o=(n+1)%s;if(r.set(l,i[3*o+0]-i[3*t+0],i[3*o+1]-i[3*t+1],i[3*o+2]-i[3*t+2]),r.normalize(l,l),n>=0){const t=1*((Math.PI-e.acosClamped(r.dot(c,l)))*U)*v(p);u[n]=Math.max(Math.floor(t),0)}r.scale(c,l,-1)}o.push(["subdivisions",{size:1,data:u}]),a.push(["subdivisions",a[0][1]])}function v(t){return 1.863798+-2.0062872/(1+t/18.2313)**.8856294}function P(t){const e=t.length;return t[0]===t[e-3]&&t[1]===t[e-2]&&t[2]===t[e-1]}const I=a.create(),T=a.create(),U=4/Math.PI;t.createGeometry=f,t.geometryToRenderInfo=h,t.geometryToRenderInfoDraped=d,Object.defineProperty(t,"__esModule",{value:!0})}));
