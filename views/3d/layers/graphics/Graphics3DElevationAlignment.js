/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/has","../../../../core/maybe","../../../../core/Logger","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/decorators/subclass","../../../../core/urlUtils","../../../../core/uuid","../../../../portal/support/resourceExtension","../../../../core/Accessor","../../../../core/Evented","../../../../core/Handles","../../../support/Scheduler","./ExtentSet"],(function(e,t,i,s,r,n,a,o,h,c,l,d,p,u,y,g){"use strict";let f=function(t){function i(){var e;return(e=t.apply(this,arguments)||this).dirtyExtents=new g.ExtentSet,e.globalDirty=!1,e.dirtyGraphicsSet=new Set,e.handles=new u,e.updateElevation=!1,e.layerView=null,e.graphicsCore=null,e.events=new p,e}e._inheritsLoose(i,t);var r=i.prototype;return r.setup=function(e,t,i,s){this.layerView=e,this.queryGraphicUIDsInExtent=t,this.graphicsCore=i,this.elevationProvider=s;const r=this.layerView.view.resourceController.scheduler;this.handles.add([s.on("elevation-change",(e=>this._elevationChanged(e))),this.layerView.watch("suspended",(()=>this.suspendedChange())),r.registerTask(y.Task.ELEVATION_ALIGNMENT,(e=>this.update(e)),(()=>this.needsUpdate()))])},r.destroy=function(){this.dirtyGraphicsSet.clear(),this.handles.destroy(),this.handles=null,this.layerView=null,this.graphicsCore=null,this.queryGraphicUIDsInExtent=null},r.clear=function(){this.dirtyGraphicsSet.clear(),this.notifyChange("updating")},r.suspendedChange=function(){!0===this.layerView.suspended?this.updateElevation=!1:!1===this.layerView.suspended&&this.updateElevation&&(this.globalDirty=!0,this.notifyChange("updating"))},r.elevationInfoChange=function(){this.globalDirty=!0,this.notifyChange("updating")},r.needsUpdate=function(){return this.dirtyGraphicsSet.size>0||this.dirtyExtents&&!this.dirtyExtents.empty||this.globalDirty},r.update=function(e){for(this.globalDirty&&(this.markAllGraphicsElevationDirty(),this.globalDirty=!1,e.madeProgress()),e.run((()=>this.dirtyExtents.merge(e)));this.needsUpdate()&&!e.done;)this._updateDirtyGraphics(e),this._updateDirtyExtents(e);this.layerView.view.deconflictor.setDirty(),this.notifyChange("updating")},r._updateDirtyGraphics=function(e){const t=this.layerView.view.renderCoordsHelper,i=this.graphicsCore.asyncUpdates;for(const r of this.dirtyGraphicsSet.keys()){const n=this.graphicsCore.getGraphics3DGraphicById(r);if(this.dirtyGraphicsSet.delete(r),s.isSome(n)&&(n.alignWithElevation(this.elevationProvider,t,i),e.madeProgress()),e.done)return}},r._updateDirtyExtents=function(e){for(;!this.dirtyExtents.empty&&!e.done;){const t=this.dirtyExtents.pop(),i=this.elevationProvider.spatialReference;this.events.emit("invalidate-elevation",{extent:t,spatialReference:i}),this.queryGraphicUIDsInExtent(t,i,(e=>{const t=this.graphicsCore.getGraphics3DGraphicById(e);s.isSome(t)&&t.needsElevationUpdates()&&this.dirtyGraphicsSet.add(e)})),e.madeProgress()}},r.markAllGraphicsElevationDirty=function(){this.dirtyExtents.clear(),this.dirtyGraphicsSet.clear(),this.graphicsCore.graphics3DGraphics.forEach(((e,t)=>this.dirtyGraphicsSet.add(t)))},r._elevationChanged=function(e){if("scene"===e.context&&(!this.graphicsCore.layer.elevationInfo||"relative-to-scene"!==this.graphicsCore.layer.elevationInfo.mode))return;const{extent:t,spatialReference:i}=e;if(this.layerView.suspended){if(!this.updateElevation){const e=this.graphicsCore.computedExtent;e&&t[2]>e.xmin&&t[0]<e.xmax&&t[3]>e.ymin&&t[1]<e.ymax&&(this.updateElevation=!0)}this.events.emit("invalidate-elevation",{extent:t,spatialReference:i})}else t[0]===-1/0?this.globalDirty=!0:this.dirtyExtents.add(t),this.notifyChange("updating")},e._createClass(i,[{key:"updating",get:function(){return this.needsUpdate()}}]),i}(d);return t.__decorate([a.property({readOnly:!0})],f.prototype,"updating",null),f=t.__decorate([o.subclass("esri.views.3d.layers.graphics.Graphics3DElevationAlignment")],f),f}));
