// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../core/Accessor","../../../../core/Evented","../../../../core/Handles","../../../../core/SetUtils","../../../../core/accessorSupport/decorators","./ExtentSet","../../../support/Scheduler"],(function(e,t,i,r,s,n,a,o,h,p){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var d=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.dirtyExtents=new h.ExtentSet,t.globalDirty=!1,t.dirtyGraphicsSet=new Set,t.handles=new n,t.updateElevation=!1,t.layerView=null,t.graphicsCore=null,t.events=new s,t}return i.__extends(t,e),Object.defineProperty(t.prototype,"updating",{get:function(){return this.needsUpdate()},enumerable:!1,configurable:!0}),t.prototype.setup=function(e,t,i,r){var s=this;this.layerView=e,this.queryGraphicUIDsInExtent=t,this.graphicsCore=i,this.elevationProvider=r;var n=this.layerView.view.resourceController.scheduler;this.handles.add([r.on("elevation-change",(function(e){return s._elevationChanged(e)})),this.layerView.watch("suspended",(function(){return s.suspendedChange()})),n.registerTask(p.Task.ELEVATION_ALIGNMENT,(function(e){return s.update(e)}),(function(){return s.needsUpdate()}))])},t.prototype.destroy=function(){this.dirtyGraphicsSet=null,this.handles.destroy(),this.handles=null,this.layerView=null,this.graphicsCore=null,this.queryGraphicUIDsInExtent=null},t.prototype.clear=function(){this.dirtyGraphicsSet.clear(),this.notifyChange("updating")},t.prototype.suspendedChange=function(){!0===this.layerView.suspended?this.updateElevation=!1:!1===this.layerView.suspended&&this.updateElevation&&(this.globalDirty=!0,this.notifyChange("updating"))},t.prototype.elevationInfoChange=function(){this.globalDirty=!0,this.notifyChange("updating")},t.prototype.needsUpdate=function(){return this.dirtyGraphicsSet&&this.dirtyGraphicsSet.size>0||this.dirtyExtents&&!this.dirtyExtents.empty||this.globalDirty},t.prototype.update=function(e){var t=this;for(this.globalDirty&&(this.markAllGraphicsElevationDirty(),this.globalDirty=!1,e.madeProgress()),e.run((function(){return t.dirtyExtents.merge(e)}));this.needsUpdate()&&!e.done;)this._updateDirtyGraphics(e),this._updateDirtyExtents(e);this.layerView.view.deconflictor.setDirty(),this.notifyChange("updating")},t.prototype._updateDirtyGraphics=function(e){for(var t=this,i=this.layerView.view,r=this.graphicsCore.stageLayer.id,s=this.layerView.labeling,n=function(){var n=Math.min(o.dirtyGraphicsSet.size,100);a.someSet(o.dirtyGraphicsSet,(function(r){var s=t.graphicsCore.getGraphics3DGraphicById(r);return t.dirtyGraphicsSet.delete(r),s&&s.alignWithElevation(t.elevationProvider,i.renderCoordsHelper,t.graphicsCore.asyncUpdates),e.madeProgress(),--n<=0||e.done})),i._stage.processDirtyLayer(r),s&&s.processStageDirty()},o=this;this.dirtyGraphicsSet.size>0&&!e.done;)n()},t.prototype._updateDirtyExtents=function(e){for(var t=this;!this.dirtyExtents.empty&&this.dirtyGraphicsSet.size<100&&!e.done;){var i=this.dirtyExtents.pop(),r=this.elevationProvider.spatialReference;this.events.emit("invalidate-elevation",{extent:i,spatialReference:r}),this.queryGraphicUIDsInExtent(i,r,(function(e){var i=t.graphicsCore.getGraphics3DGraphicById(e);i&&i.needsElevationUpdates()&&t.dirtyGraphicsSet.add(e)})),e.madeProgress()}},t.prototype.markAllGraphicsElevationDirty=function(){var e=this;this.dirtyExtents.clear(),this.dirtyGraphicsSet.clear(),this.graphicsCore.graphics3DGraphics.forEach((function(t,i){return e.dirtyGraphicsSet.add(i)}))},t.prototype._elevationChanged=function(e){if("scene"!==e.context||this.graphicsCore.layer.elevationInfo&&"relative-to-scene"===this.graphicsCore.layer.elevationInfo.mode){var t=e.extent,i=e.spatialReference;if(this.layerView.suspended){if(!this.updateElevation){var r=this.graphicsCore.computedExtent;r&&t[2]>r.xmin&&t[0]<r.xmax&&t[3]>r.ymin&&t[1]<r.ymax&&(this.updateElevation=!0)}this.events.emit("invalidate-elevation",{extent:t,spatialReference:i})}else t[0]===-1/0?this.globalDirty=!0:this.dirtyExtents.add(t),this.notifyChange("updating")}},i.__decorate([o.property({readOnly:!0})],t.prototype,"updating",null),t=i.__decorate([o.subclass("esri.views.3d.layers.graphics.Graphics3DElevationAlignment")],t)}(r);t.default=d}));