/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Evented","../../../../core/Handles","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/accessorSupport/decorators/subclass","./ExtentSet","../../webgl-engine/lib/UpdatePolicy","../../../support/Scheduler"],(function(e,t,i,r,s,n,a,o,h,c,p,d,l,y){"use strict";let u=function(t){function i(e){var i;return(i=t.call(this,e)||this)._dirtyExtents=new d.ExtentSet,i._globalDirty=!1,i._averageExtentUpdateSize=0,i._dirtyGraphicsSet=new Set,i._handles=new s,i._updateElevation=!1,i.graphicsCoreOwner=null,i.graphicsCore=null,i.events=new r,i}e._inheritsLoose(i,t);var o=i.prototype;return o.initialize=function(){const e=this.elevationProvider,t=this.graphicsCoreOwner.view.resourceController.scheduler;this._handles.add([e.on("elevation-change",(e=>this._elevationChanged(e))),a.watch((()=>this.graphicsCoreOwner.suspended),(()=>this._suspendedChange())),t.registerTask(y.TaskPriority.ELEVATION_ALIGNMENT,this)])},o.destroy=function(){this._dirtyGraphicsSet.clear(),this._handles=n.destroyMaybe(this._handles),this.graphicsCoreOwner=null,this.graphicsCore=null,this.queryGraphicUIDsInExtent=null,this.elevationProvider=null},o.clear=function(){this._dirtyGraphicsSet.clear(),this.notifyChange("updating")},o._suspendedChange=function(){!0===this.graphicsCoreOwner.suspended?this._updateElevation=!1:!1===this.graphicsCoreOwner.suspended&&this._updateElevation&&(this._globalDirty=!0,this.notifyChange("updating"))},o.elevationInfoChange=function(){this._globalDirty=!0,this.notifyChange("updating")},o.runTask=function(e){for(this._globalDirty&&(this._markAllGraphicsElevationDirty(),this._globalDirty=!1,e.madeProgress()),e.run((()=>this._dirtyExtents.merge(e)));this.running&&!e.done;)this._updateDirtyGraphics(e),this._updateDirtyExtents(e);this.notifyChange("updating")},o._updateDirtyGraphics=function(e){const t=this.graphicsCoreOwner.view.renderCoordsHelper,i=this.graphicsCore.effectiveUpdatePolicy===l.UpdatePolicy.ASYNC;for(const r of this._dirtyGraphicsSet.keys()){const s=this.graphicsCore.getGraphics3DGraphicById(r);if(this._dirtyGraphicsSet.delete(r),n.isSome(s)&&(s.alignWithElevation(this.elevationProvider,t,i),this.graphicsCoreOwner.view.deconflictor.setDirty(),e.madeProgress()),e.done)return}},o._updateDirtyExtents=function(e){for(;!this._dirtyExtents.empty&&!e.done;){const t=this._dirtyExtents.pop(),i=this.elevationProvider.spatialReference;this.events.emit("invalidate-elevation",{extent:t,spatialReference:i});const r=this._dirtyGraphicsSet.size;this.queryGraphicUIDsInExtent(t,i,(e=>{const t=this.graphicsCore.getGraphics3DGraphicById(e);n.isSome(t)&&t.needsElevationUpdates()&&this._dirtyGraphicsSet.add(e)})),this._averageExtentUpdateSize=.1*(this._dirtyGraphicsSet.size-r)+.9*this._averageExtentUpdateSize,e.madeProgress()}},o._markAllGraphicsElevationDirty=function(){this._dirtyExtents.clear(),this._dirtyGraphicsSet.clear(),this.graphicsCore.graphics3DGraphics.forEach(((e,t)=>this._dirtyGraphicsSet.add(t)))},o._elevationChanged=function(e){if("scene"===e.context&&(!this.graphicsCore.layer.elevationInfo||"relative-to-scene"!==this.graphicsCore.layer.elevationInfo.mode))return;const{extent:t,spatialReference:i}=e;if(this.graphicsCoreOwner.suspended){if(!this._updateElevation){const e=this.graphicsCore.computedExtent;e&&t[2]>e.xmin&&t[0]<e.xmax&&t[3]>e.ymin&&t[1]<e.ymax&&(this._updateElevation=!0)}this.events.emit("invalidate-elevation",{extent:t,spatialReference:i})}else t[0]===-1/0?this._globalDirty=!0:this._dirtyExtents.add(t),this.notifyChange("updating")},e._createClass(i,[{key:"updating",get:function(){return this.running}},{key:"running",get:function(){return this._dirtyGraphicsSet.size>0||this._dirtyExtents&&!this._dirtyExtents.empty||this._globalDirty}},{key:"updatingRemaining",get:function(){return this._dirtyGraphicsSet.size+this._dirtyExtents.size*this._averageExtentUpdateSize}}]),i}(i);t.__decorate([o.property()],u.prototype,"graphicsCoreOwner",void 0),t.__decorate([o.property()],u.prototype,"graphicsCore",void 0),t.__decorate([o.property()],u.prototype,"queryGraphicUIDsInExtent",void 0),t.__decorate([o.property()],u.prototype,"elevationProvider",void 0),t.__decorate([o.property({readOnly:!0})],u.prototype,"updating",null),t.__decorate([o.property({readOnly:!0})],u.prototype,"updatingRemaining",null),u=t.__decorate([p.subclass("esri.views.3d.layers.graphics.Graphics3DElevationAlignment")],u);return u}));
