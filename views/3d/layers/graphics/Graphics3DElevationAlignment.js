/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/has","../../../../core/Logger","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/decorators/subclass","../../../../core/urlUtils","../../../../core/uuid","../../../../portal/support/resourceExtension","../../../../core/Accessor","../../../../core/Evented","../../../../core/Handles","../../../support/Scheduler","../../../../core/SetUtils","./ExtentSet"],(function(e,t,i,s,r,a,n,h,o,c,l,d,p,u,y,g){"use strict";let v=function(t){function i(){var e;return(e=t.apply(this,arguments)||this).dirtyExtents=new g.ExtentSet,e.globalDirty=!1,e.dirtyGraphicsSet=new Set,e.handles=new p,e.updateElevation=!1,e.layerView=null,e.graphicsCore=null,e.events=new d,e}e._inheritsLoose(i,t);var s=i.prototype;return s.setup=function(e,t,i,s){this.layerView=e,this.queryGraphicUIDsInExtent=t,this.graphicsCore=i,this.elevationProvider=s;const r=this.layerView.view.resourceController.scheduler;this.handles.add([s.on("elevation-change",(e=>this._elevationChanged(e))),this.layerView.watch("suspended",(()=>this.suspendedChange())),r.registerTask(u.Task.ELEVATION_ALIGNMENT,(e=>this.update(e)),(()=>this.needsUpdate()))])},s.destroy=function(){this.dirtyGraphicsSet=null,this.handles.destroy(),this.handles=null,this.layerView=null,this.graphicsCore=null,this.queryGraphicUIDsInExtent=null},s.clear=function(){this.dirtyGraphicsSet.clear(),this.notifyChange("updating")},s.suspendedChange=function(){!0===this.layerView.suspended?this.updateElevation=!1:!1===this.layerView.suspended&&this.updateElevation&&(this.globalDirty=!0,this.notifyChange("updating"))},s.elevationInfoChange=function(){this.globalDirty=!0,this.notifyChange("updating")},s.needsUpdate=function(){return this.dirtyGraphicsSet&&this.dirtyGraphicsSet.size>0||this.dirtyExtents&&!this.dirtyExtents.empty||this.globalDirty},s.update=function(e){for(this.globalDirty&&(this.markAllGraphicsElevationDirty(),this.globalDirty=!1,e.madeProgress()),e.run((()=>this.dirtyExtents.merge(e)));this.needsUpdate()&&!e.done;)this._updateDirtyGraphics(e),this._updateDirtyExtents(e);this.layerView.view.deconflictor.setDirty(),this.notifyChange("updating")},s._updateDirtyGraphics=function(e){const t=this.layerView.view,i=this.graphicsCore.stageLayer.id,s=this.layerView.labeling;for(;this.dirtyGraphicsSet.size>0&&!e.done;){let r=Math.min(this.dirtyGraphicsSet.size,100);y.someSet(this.dirtyGraphicsSet,(i=>{const s=this.graphicsCore.getGraphics3DGraphicById(i);return this.dirtyGraphicsSet.delete(i),s&&s.alignWithElevation(this.elevationProvider,t.renderCoordsHelper,this.graphicsCore.asyncUpdates),e.madeProgress(),--r<=0||e.done})),t._stage.processDirtyLayer(i),s&&s.processStageDirty()}},s._updateDirtyExtents=function(e){for(;!this.dirtyExtents.empty&&this.dirtyGraphicsSet.size<100&&!e.done;){const t=this.dirtyExtents.pop(),i=this.elevationProvider.spatialReference;this.events.emit("invalidate-elevation",{extent:t,spatialReference:i}),this.queryGraphicUIDsInExtent(t,i,(e=>{const t=this.graphicsCore.getGraphics3DGraphicById(e);t&&t.needsElevationUpdates()&&this.dirtyGraphicsSet.add(e)})),e.madeProgress()}},s.markAllGraphicsElevationDirty=function(){this.dirtyExtents.clear(),this.dirtyGraphicsSet.clear(),this.graphicsCore.graphics3DGraphics.forEach(((e,t)=>this.dirtyGraphicsSet.add(t)))},s._elevationChanged=function(e){if("scene"===e.context&&(!this.graphicsCore.layer.elevationInfo||"relative-to-scene"!==this.graphicsCore.layer.elevationInfo.mode))return;const{extent:t,spatialReference:i}=e;if(this.layerView.suspended){if(!this.updateElevation){const e=this.graphicsCore.computedExtent;e&&t[2]>e.xmin&&t[0]<e.xmax&&t[3]>e.ymin&&t[1]<e.ymax&&(this.updateElevation=!0)}this.events.emit("invalidate-elevation",{extent:t,spatialReference:i})}else t[0]===-1/0?this.globalDirty=!0:this.dirtyExtents.add(t),this.notifyChange("updating")},e._createClass(i,[{key:"updating",get:function(){return this.needsUpdate()}}]),i}(l);return t.__decorate([a.property({readOnly:!0})],v.prototype,"updating",null),v=t.__decorate([n.subclass("esri.views.3d.layers.graphics.Graphics3DElevationAlignment")],v),v}));
