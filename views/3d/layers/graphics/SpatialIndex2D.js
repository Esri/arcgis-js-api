/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/has","../../../../core/Logger","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/decorators/subclass","../../../../core/urlUtils","../../../../core/uuid","../../../../portal/support/resourceExtension","../../../../core/Accessor","../../../../geometry/support/aaBoundingBox","../../../../layers/graphics/dehydratedFeatures","../../../../core/libs/rbush/PooledRBush"],(function(e,t,i,n,s,r,o,a,c,u,d,p,l,h,_){"use strict";e.SpatialIndex2D=function(e){function i(t){var i;return(i=e.call(this,t)||this)._index=new _.PooledRBush(9,n("csp-restrictions")?e=>({minX:e.extent[0],minY:e.extent[1],maxX:e.extent[2],maxY:e.extent[3]}):[".extent[0]",".extent[1]",".extent[2]",".extent[3]"]),i._missing=new Set,i._boundsByFeature=new Map,i.spatialReference=null,i.hasZ=null,i.hasM=null,i.objectIdField=null,i.updating=!1,i}t._inheritsLoose(i,e);var s=i.prototype;return s.setup=function(e){this._addMany(e)},s.destroy=function(){this._missing.clear(),this._index.destroy(),this._index=null,this._boundsByFeature.clear(),this._boundsByFeature=null},s.update=function(){this._missing.size>0&&(this._addMany(Array.from(this._missing.values())),this.updating=!1,this._missing.clear())},s.queryGraphicUIDsInExtent=function(e,t,i){t.equals(this.spatialReference)&&(x.minX=e[0],x.minY=e[1],x.maxX=e[2],x.maxY=e[3],this.update(),this._index.search(x,(e=>i(e.graphic.uid))))},s.add=function(e){this._missing.add(e),this.updating=!0},s.remove=function(e){if(this._missing.delete(e))return void(this.updating=this._missing.size>0);this._index.remove(e);const t=h.getObjectId(e.graphic,this._get("objectIdField"));null!=t&&this._boundsByFeature.delete(t)},s._addMany=function(e){if(0===e.length)return;const t=this._get("objectIdField");for(const i of e){i.computeExtent(this.spatialReference);const e=h.getObjectId(i.graphic,t);null!=e&&this._boundsByFeature.set(e,i.extent)}this._index.load(e)},s.clear=function(){this._index.clear(),this._missing.clear(),this._boundsByFeature.clear(),this.updating=!1},s.forEachInBounds=function(e,t){x.minX=e[0],x.minY=e[1],x.maxX=e[2],x.maxY=e[3],this.update(),this._index.search(x,(e=>{t(e)}))},s.getBounds=function(e,t){this.update();const i=this._boundsByFeature.get(e);return i?l.fromRect(t,i):null},t._createClass(i,[{key:"updatingRemaining",get:function(){return this._missing.size}}]),i}(p),i.__decorate([o.property({constructOnly:!0})],e.SpatialIndex2D.prototype,"spatialReference",void 0),i.__decorate([o.property({constructOnly:!0})],e.SpatialIndex2D.prototype,"hasZ",void 0),i.__decorate([o.property({constructOnly:!0})],e.SpatialIndex2D.prototype,"hasM",void 0),i.__decorate([o.property({constructOnly:!0})],e.SpatialIndex2D.prototype,"objectIdField",void 0),i.__decorate([o.property()],e.SpatialIndex2D.prototype,"updating",void 0),e.SpatialIndex2D=i.__decorate([a.subclass("esri.views.3d.layers.graphics.SpatialIndex2D")],e.SpatialIndex2D);const x={minX:0,minY:0,maxX:0,maxY:0};Object.defineProperty(e,"__esModule",{value:!0})}));
