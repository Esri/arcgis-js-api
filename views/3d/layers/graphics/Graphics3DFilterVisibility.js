/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import t from"../../../../core/Accessor.js";import i from"../../../../core/Handles.js";import r from"../../../../core/Logger.js";import{isSome as s,isNone as o}from"../../../../core/maybe.js";import{ObservableChangesType as l}from"../../../../core/ObservableChangesType.js";import{isAbortError as h}from"../../../../core/promiseUtils.js";import{on as n}from"../../../../core/reactiveUtils.js";import{property as a}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/arrayUtils.js";import"../../../../core/has.js";import"../../../../core/accessorSupport/ensureType.js";import{subclass as c}from"../../../../core/accessorSupport/decorators/subclass.js";import u from"../../../../layers/support/FeatureFilter.js";import{getFloorFilterClause as y}from"../../../../layers/support/floorFilterUtils.js";import{VisibilityFlag as d,VisibilityGroup as p}from"./enums.js";import{QueryEngine as _}from"./QueryEngine.js";import{TaskPriority as g}from"../../../support/Scheduler.js";const m=r.getLogger("esri.views.3d.layers.graphics.Graphics3DFilterVisibility");let F=class extends t{constructor(...e){super(...e),this._dirty=!1,this._querying=!1,this._handles=new i}get updating(){return this._dirty||this._querying||s(this._queryResult)}setup(e,t){this._layerView=e,this._core=t,this._objectIdField=e.layer.objectIdField,this._queryEngine=new _({layerView:this._layerView,priority:g.FILTER_VISIBILITY});const i=this._layerView.view.resourceController.scheduler;this._handles.add(i.registerTask(g.FILTER_VISIBILITY,this)),this._handles.add(n((()=>t.owner?.loadedGraphics),"after-changes",(e=>this._graphicsChanged(e)),{onListenerAdd:()=>this.dirty=!0})),this.filterChanged()}destroy(){this._handles.destroy(),this._handles=null,this.clear(),this._layerView=null,this._core=null}clear(){this._queryEngine.clear()&&(this._core.modifyGraphics3DGraphicVisibilities((e=>e.clearVisibilityFlag(d.FILTER))),this._queryResult=null,this._querying=!1),this.dirty=!1}_graphicsChanged(e){this._queryEngine&&0==(e.type&l.ADD)||(this.dirty=!0)}updateVisibility(e){this.active&&(e.hasVisibilityFlag(d.FILTER,p.GRAPHIC)||e.setVisibilityFlag(d.FILTER,!1,p.GRAPHIC),this.dirty=!0)}filterChanged(){const e=this._recomputeFilter();e!==this._featureFilter&&(this._featureFilter=e,this.dirty=!0);const t="layerFilter"in this._layerView?this._layerView.layerFilter:null;t!==this._sceneFilter&&(this._sceneFilter=t,this.dirty=!0)}get active(){return(this._featureFilter||this._sceneFilter)&&this._core.graphics3DGraphics.size>0}_recomputeFilter(){const e="filter"in this._layerView?this._layerView.filter:null,t="timeExtent"in this._layerView?this._layerView.timeExtent:null,i=y(this._layerView);if(o(t)&&o(i))return e;const r=s(e)?e.clone():new u;if(s(t)&&(r.timeExtent=s(r.timeExtent)?r.timeExtent.intersection(t):t),s(i)){const e=null==r.where||""===r.where;r.where=e?i:`(${r.where}) AND (${i})`}return r}get running(){return this._dirty&&!this._querying||s(this._queryResult)}runTask(e){if(!this.active)return void this.clear();!this._dirty||this._querying||e.done||(this._querying=!0,this.dirty=!1,this._queryEngine.executeQueryForIdSet(this._featureFilter,this._sceneFilter).then((e=>{this._queryResult=e,this._querying=!1})).catch((e=>{if(!h(e)){m.warn("FeatureFilter query failed: "+e,{error:e});const t=new Set;this._core.graphics3DGraphics.forEach((e=>t.add(this._getFeatureId(e.graphic)))),this._queryResult=t,this._querying=!1}})),e.madeProgress());const t=this._queryResult;s(t)&&!e.done&&(this._core.modifyGraphics3DGraphicVisibilities((i=>{if(e.done)return!1;const r=t.has(this._getFeatureId(i.graphic));return!!i.setVisibilityFlag(d.FILTER,r,p.GRAPHIC)&&(e.madeProgress(),!0)})),e.done||(this._queryResult=null))}_getFeatureId(e){return null==e.objectId?e.attributes[this._objectIdField]:e.objectId}set dirty(e){this._dirty=e}};e([a({readOnly:!0})],F.prototype,"updating",null),e([a({readOnly:!0})],F.prototype,"running",null),e([a()],F.prototype,"_dirty",void 0),e([a()],F.prototype,"_querying",void 0),e([a()],F.prototype,"_queryResult",void 0),F=e([c("esri.views.3d.layers.graphics.Graphics3DFilterVisibility")],F);export{F as Graphics3DFilterVisibility};
