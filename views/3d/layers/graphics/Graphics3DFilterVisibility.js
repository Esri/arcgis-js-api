/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Handles","../../../../core/Logger","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/watchUtils","../../../../core/accessorSupport/decorators/property","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","../../../../layers/support/FeatureFilter","./QueryEngine","../../../support/floorFilterUtils","../../../support/Scheduler"],(function(e,i,t,r,s,o,n,l,a,c,h,u,y,d,_,p,g,f){"use strict";const F=o.getLogger("esri.views.3d.layers.graphics.Graphics3DFilterVisibility");e.Graphics3DFilterVisibility=function(e){function t(...i){var t;return(t=e.call(this,...i)||this)._dirty=!1,t._querying=!1,t._handles=new s,t}i._inheritsLoose(t,e);var r=t.prototype;return r.setup=function(e,i){this._layerView=e,this._core=i,this._objectIdField=e.layer.objectIdField,this._queryEngine=new p.default({layerView:this._layerView,priority:f.TaskPriority.FILTER_VISIBILITY});const t=this._layerView.view.resourceController.scheduler;this._handles.add(t.registerTask(f.TaskPriority.FILTER_VISIBILITY,this)),this._handles.add(a.on(i.owner,"loadedGraphics","after-changes",(e=>this._graphicsChanged(e)),(()=>this.dirty=!0))),this.filterChanged()},r.destroy=function(){this._handles.destroy(),this._handles=null,this.clear(),this._layerView=null,this._core=null},r.clear=function(){this._queryEngine.clear()&&(this._core.modifyGraphics3DGraphicVisibilities((e=>e.clearVisibilityFlag(2))),this._queryResult=null,this._querying=!1),this.dirty=!1},r._graphicsChanged=function(e){this._queryEngine&&0==(1&e.type)||(this.dirty=!0)},r.updateVisibility=function(e){this.active&&(e.hasVisibilityFlag(2,0)||e.setVisibilityFlag(2,!1,0),this.dirty=!0)},r.filterChanged=function(){const e=this.recomputeFilter();e!==this._filter&&(this._filter=e,this.dirty=!0)},r.recomputeFilter=function(){const e="filter"in this._layerView?this._layerView.filter:null,i="timeExtent"in this._layerView?this._layerView.timeExtent:null,t=g.getFloorFilterClause(this._layerView);if(n.isNone(i)&&n.isNone(t))return e;const r=n.isSome(e)?e.clone():new _;if(n.isSome(i)&&(r.timeExtent=n.isSome(r.timeExtent)?r.timeExtent.intersection(i):i),n.isSome(t)){const e=null==r.where||""===r.where;r.where=e?t:`(${r.where}) AND (${t})`}return r},r.runTask=function(e){if(!this.active)return void this.clear();!this._dirty||this._querying||e.done||(this._querying=!0,this.dirty=!1,this._queryEngine.executeQueryForIdSet(this._filter).then((e=>{this._queryResult=e,this._querying=!1})).catch((e=>{if(!l.isAbortError(e)){F.warn("FeatureFilter query failed: "+e,{error:e});const i=new Set;this._core.graphics3DGraphics.forEach((e=>i.add(this._getFeatureId(e.graphic)))),this._queryResult=i,this._querying=!1}})),e.madeProgress());const i=this._queryResult;n.isSome(i)&&!e.done&&(this._core.modifyGraphics3DGraphicVisibilities((t=>{if(e.done)return!1;const r=i.has(this._getFeatureId(t.graphic));return!!t.setVisibilityFlag(2,r,0)&&(e.madeProgress(),!0)})),e.done||(this._queryResult=null))},r._getFeatureId=function(e){return null==e.objectId?e.attributes[this._objectIdField]:e.objectId},i._createClass(t,[{key:"updating",get:function(){return this._dirty||this._querying||n.isSome(this._queryResult)}},{key:"active",get:function(){return this._filter&&this._core.graphics3DGraphics.size>0}},{key:"running",get:function(){return this._dirty&&!this._querying||n.isSome(this._queryResult)}},{key:"dirty",set:function(e){this._dirty=e}}]),t}(r),t.__decorate([c.property({readOnly:!0})],e.Graphics3DFilterVisibility.prototype,"updating",null),t.__decorate([c.property({readOnly:!0})],e.Graphics3DFilterVisibility.prototype,"running",null),t.__decorate([c.property()],e.Graphics3DFilterVisibility.prototype,"_dirty",void 0),t.__decorate([c.property()],e.Graphics3DFilterVisibility.prototype,"_querying",void 0),t.__decorate([c.property()],e.Graphics3DFilterVisibility.prototype,"_queryResult",void 0),e.Graphics3DFilterVisibility=t.__decorate([d.subclass("esri.views.3d.layers.graphics.Graphics3DFilterVisibility")],e.Graphics3DFilterVisibility),Object.defineProperty(e,"__esModule",{value:!0})}));
