/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../geometry","../../../../core/Accessor","../../../../core/maybe","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/accessorSupport/decorators/subclass","../../../../geometry/Extent","../../../../layers/graphics/data/QueryEngine","../../../../rest/support/FeatureSet","../../../../rest/support/Query","../../../../geometry/support/typeUtils"],(function(e,t,r,n,u,o,i,a,s,y,c,l,p,f,h){"use strict";const d=l.QueryEngine;e.QueryEngine=function(e){function r(t){var r;return(r=e.call(this,t)||this)._dataQueryEngineInstance=null,r}t._inheritsLoose(r,e);var n=r.prototype;return n.destroy=function(){this.clear()},n.clear=function(){return!!this._dataQueryEngineInstance&&(this._dataQueryEngineInstance.destroy(),this._dataQueryEngineInstance=null,!0)},n.executeQueryForIdSet=function(){var e=t._asyncToGenerator((function*(e,t,r){return this._dataQueryEngine.executeQueryForIdSet(this._ensureQueryJSON(e,t),r)}));function r(t,r,n){return e.apply(this,arguments)}return r}(),n.executeQueryForCount=function(){var e=t._asyncToGenerator((function*(e,t){return this._dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(e),t)}));function r(t,r){return e.apply(this,arguments)}return r}(),n.executeQueryForExtent=function(){var e=t._asyncToGenerator((function*(e,t){const{count:r,extent:n}=yield this._dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(e),t);return{count:r,extent:c.fromJSON(n)}}));function r(t,r){return e.apply(this,arguments)}return r}(),n.executeQueryForIds=function(){var e=t._asyncToGenerator((function*(e,t){return this._dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(e),t)}));function r(t,r){return e.apply(this,arguments)}return r}(),n.executeQueryForLatestObservations=function(){var e=t._asyncToGenerator((function*(e,t){const r=yield this._dataQueryEngine.executeQueryForLatestObservations(this._ensureQueryJSON(e),t),n=p.fromJSON(r);return n.features.forEach((e=>{e.layer=this.layer,e.sourceLayer=this.layer})),n}));function r(t,r){return e.apply(this,arguments)}return r}(),n.executeQuery=function(){var e=t._asyncToGenerator((function*(e,t){const r=yield this._dataQueryEngine.executeQuery(this._ensureQueryJSON(e),t),n=p.fromJSON(r);return n.features.forEach((e=>{e.layer=this.layer,e.sourceLayer=this.layer})),n}));function r(t,r){return e.apply(this,arguments)}return r}(),n._ensureQueryJSON=function(e,t){let r=this.defaultQueryJSON;if(o.isSome(e)&&("outSpatialReference"in e&&!e.outSpatialReference&&(e.outSpatialReference=this.spatialReference),r=e.toJSON()),o.isSome(t)){const e=t.geometries.map((e=>e.toJSON())).reduce(((e,t)=>(e.rings=e.rings.concat(t.rings),e)));r={...r,sceneFilter:{...t,geometry:e}}}return r},n._ensureDataQueryEngine=function(){if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;const e="timeInfo"in this.layer&&this.layer.timeInfo&&this.layer.timeInfo.toJSON()||null,t=this.layer.objectIdField,r=h.featureGeometryTypeKebabDictionary.toJSON(this._queryGeometryType),n=this.layer.fields?.map((e=>e.toJSON()))??[],u=this.priority,o=this.spatialReference.toJSON(),{hasZ:i,hasM:a,featureStore:s,scheduler:y}=this.context;return this._dataQueryEngineInstance=new d({hasZ:i,hasM:a,geometryType:r,fields:n,timeInfo:e,spatialReference:o,objectIdField:t,featureStore:s,scheduler:y,priority:u}),this._dataQueryEngineInstance},t._createClass(r,[{key:"layer",get:function(){return this.context.layer}},{key:"spatialReference",get:function(){return this.context.spatialReference}},{key:"_queryGeometryType",get:function(){switch(this.layer.geometryType){case"multipoint":case"point":case"polygon":case"polyline":return this.layer.geometryType;case"mesh":return"polygon";default:return}}},{key:"defaultQueryJSON",get:function(){return new f({outSpatialReference:this.spatialReference}).toJSON()}},{key:"_dataQueryEngine",get:function(){return this._ensureDataQueryEngine()}}]),r}(u),r.__decorate([i.property({constructOnly:!0})],e.QueryEngine.prototype,"context",void 0),r.__decorate([i.property({constructOnly:!0})],e.QueryEngine.prototype,"priority",void 0),r.__decorate([i.property()],e.QueryEngine.prototype,"layer",null),r.__decorate([i.property()],e.QueryEngine.prototype,"spatialReference",null),r.__decorate([i.property()],e.QueryEngine.prototype,"_queryGeometryType",null),r.__decorate([i.property()],e.QueryEngine.prototype,"defaultQueryJSON",null),e.QueryEngine=r.__decorate([y.subclass("esri.views.3d.layers.graphics.QueryEngine")],e.QueryEngine),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
