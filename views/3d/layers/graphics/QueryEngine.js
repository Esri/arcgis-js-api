/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/has","../../../../core/maybe","../../../../core/Logger","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/decorators/subclass","../../../../core/urlUtils","../../../../core/uuid","../../../../portal/support/resourceExtension","../../../../core/Accessor","../../../../geometry/Extent","../../../../geometry/support/typeUtils","../../../../geometry","../../../../tasks/support/FeatureSet","../../../../tasks/support/Query","../../../../layers/graphics/data/QueryEngine"],(function(e,t,r,n,a,s,u,o,i,y,c,l,p,d,h,f,Q,g,E){"use strict";const _=E.default;e.QueryEngine=function(e){function r(t){var r;return(r=e.call(this,t)||this)._dataQueryEngineInstance=null,r}t._inheritsLoose(r,e);var n=r.prototype;return n.destroy=function(){this.clear()},n.clear=function(){return!!this._dataQueryEngineInstance&&(this._dataQueryEngineInstance.destroy(),this._dataQueryEngineInstance=null,!0)},n.executeQueryForIdSet=async function(e,t){return this.dataQueryEngine.executeQueryForIdSet(this._ensureQueryJSON(e),t)},n.executeQueryForCount=async function(e,t){return this.dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(e),t)},n.executeQueryForExtent=async function(e,t){const{count:r,extent:n}=await this.dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(e),t);return{count:r,extent:d.fromJSON(n)}},n.executeQueryForIds=async function(e,t){return this.dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(e),t)},n.executeQueryForLatestObservations=async function(e,t){const r=await this.dataQueryEngine.executeQueryForLatestObservations(this._ensureQueryJSON(e),t),n=Q.fromJSON(r);return n.features.forEach((e=>{e.layer=this.layer,e.sourceLayer=this.layer})),n},n.executeQuery=async function(e,t){const r=await this.dataQueryEngine.executeQuery(this._ensureQueryJSON(e),t),n=Q.fromJSON(r);return n.features.forEach((e=>{e.layer=this.layer,e.sourceLayer=this.layer})),n},n._ensureQueryJSON=function(e){return a.isNone(e)?this.defaultQueryJSON:("outSpatialReference"in e&&!e.outSpatialReference&&(e.outSpatialReference=this.spatialReference),e.toJSON())},n.ensureDataQueryEngine=function(){if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;const e="timeInfo"in this.layer&&this.layer.timeInfo&&this.layer.timeInfo.toJSON()||null,t=this.layer.objectIdField,r=h.featureGeometryTypeKebabDictionary.toJSON(this.queryGeometryType),n=this.layer.fields.map((e=>e.toJSON())),a=this.layerView.view.resourceController.scheduler,s=this.task,u=this.spatialReference.toJSON(),o=this.layerView.graphics3d.graphicsCore.featureStore,{hasZ:i,hasM:y}=this.layerView;return this._dataQueryEngineInstance=new _({hasZ:i,hasM:y,geometryType:r,fields:n,timeInfo:e,spatialReference:u,objectIdField:t,featureStore:o,scheduler:a,task:s}),this._dataQueryEngineInstance},t._createClass(r,[{key:"queryGeometryType",get:function(){switch(this.layer.geometryType){case"multipoint":case"point":case"polygon":case"polyline":return this.layer.geometryType;case"mesh":return"polygon";default:return}}},{key:"defaultQueryJSON",get:function(){return new g({outSpatialReference:this.spatialReference}).toJSON()}},{key:"dataQueryEngine",get:function(){return this.ensureDataQueryEngine()}}]),r}(p),r.__decorate([o.property({constructOnly:!0})],e.QueryEngine.prototype,"layerView",void 0),r.__decorate([o.property({constructOnly:!0})],e.QueryEngine.prototype,"task",void 0),r.__decorate([o.property({readOnly:!0,aliasOf:"layerView.view.spatialReference"})],e.QueryEngine.prototype,"spatialReference",void 0),r.__decorate([o.property({readOnly:!0,aliasOf:"layerView.layer"})],e.QueryEngine.prototype,"layer",void 0),r.__decorate([o.property({readOnly:!0,dependsOn:["layer.geometryType"]})],e.QueryEngine.prototype,"queryGeometryType",null),r.__decorate([o.property({readOnly:!0,dependsOn:["spatialReference"]})],e.QueryEngine.prototype,"defaultQueryJSON",null),e.QueryEngine=r.__decorate([i.subclass("esri.views.3d.layers.graphics.QueryEngine")],e.QueryEngine);var O=e.QueryEngine;e.default=O,Object.defineProperty(e,"__esModule",{value:!0})}));
