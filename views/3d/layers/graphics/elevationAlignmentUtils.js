/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../core/maybe","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec3f64","../../../../geometry/projection","../../../../layers/graphics/dehydratedFeatureUtils","./graphicUtils","../../support/ElevationProvider"],(function(e,t,n,o,r,a,i,l,s){"use strict";function u(e,t,n,o,r,i,l,s,u,c,f){const p=U[f.mode];let d,v,g=0;if(a.projectBuffer(e,t,n,o,u.spatialReference,r,s))return p.requiresAlignment(f)?(g=p.applyElevationAlignmentBuffer(o,r,i,l,s,u,c,f),d=i,v=l):(d=o,v=r),a.projectBuffer(d,u.spatialReference,v,i,c.spatialReference,l,s)?g:void 0}function c(e,n,o,r,a){const l=(i.isDehydratedPoint(e)?e.z:s.isSamplePosition(e)?e.array[e.offset+2]:e[2])||0;switch(o.mode){case"on-the-ground":{const o=t.unwrapOr(s.getElevationAtPoint(n,e,"ground"),0);return a.verticalDistanceToGround=0,a.sampledElevation=o,void(a.z=o)}case"relative-to-ground":{const i=t.unwrapOr(s.getElevationAtPoint(n,e,"ground"),0),u=o.geometryZWithOffset(l,r);return a.verticalDistanceToGround=u,a.sampledElevation=i,void(a.z=u+i)}case"relative-to-scene":{const i=t.unwrapOr(s.getElevationAtPoint(n,e,"scene"),0),u=o.geometryZWithOffset(l,r);return a.verticalDistanceToGround=u,a.sampledElevation=i,void(a.z=u+i)}case"absolute-height":{const i=o.geometryZWithOffset(l,r),u=t.unwrapOr(s.getElevationAtPoint(n,e,"ground"),0);return a.verticalDistanceToGround=i-u,a.sampledElevation=u,void(a.z=i)}default:return void(a.z=0)}}function f(e,t,n,o){return c(e,t,n,o,b),b.z}function p(t,n,o){return null==n||null==o?t.definedChanged:"on-the-ground"===n&&"on-the-ground"===o?t.staysOnTheGround:n===o||"on-the-ground"!==n&&"on-the-ground"!==o?e.SymbolUpdateType.UPDATE:t.onTheGroundChanged}function d(e){return"relative-to-ground"===e||"relative-to-scene"===e}function v(e){return"absolute-height"!==e}function g(e,t,o,r,i){c(t,o,i,r,b),l.updateVertexAttributeAuxpos1w(e,b.verticalDistanceToGround);const s=b.sampledElevation,u=n.copy(R,e.transformation);P[0]=t.x,P[1]=t.y,P[2]=b.z;return a.computeTranslationToOriginAndRotation(t.spatialReference,P,u,r.spatialReference)?e.transformation=u:console.warn("Could not locate symbol object properly, it might be misplaced"),s}function m(e,n,o,r,a,i){let l=0;const s=i.spatialReference;n*=3,r*=3;for(let u=0;u<a;++u){const a=e[n+0],u=e[n+1],c=e[n+2],f=t.unwrapOr(i.getElevation(a,u,c,s,"ground"),0);l+=f,o[r+0]=a,o[r+1]=u,o[r+2]=f,n+=3,r+=3}return l/a}function E(e,n,o,r,a,i,l,s){let u=0;const c=s.calculateOffsetRenderUnits(l),f=s.featureExpressionInfoContext,p=i.spatialReference;n*=3,r*=3;for(let d=0;d<a;++d){const a=e[n+0],l=e[n+1],s=e[n+2],d=t.unwrapOr(i.getElevation(a,l,s,p,"ground"),0);u+=d,o[r+0]=a,o[r+1]=l,o[r+2]=null==f?s+d+c:d+c,n+=3,r+=3}return u/a}function h(e,n,o,r,a,i,l,s){let u=0;const c=s.calculateOffsetRenderUnits(l),f=s.featureExpressionInfoContext,p=i.spatialReference;n*=3,r*=3;for(let d=0;d<a;++d){const a=e[n+0],l=e[n+1],s=e[n+2],d=t.unwrapOr(i.getElevation(a,l,s,p,"scene"),0);u+=d,o[r+0]=a,o[r+1]=l,o[r+2]=null==f?s+d+c:d+c,n+=3,r+=3}return u/a}function y(e){const t=e.meterUnitOffset,n=e.featureExpressionInfoContext;return 0!==t||null!=n}function A(e,t,n,o,r,a,i,l){const s=l.calculateOffsetRenderUnits(i),u=l.featureExpressionInfoContext;t*=3,o*=3;for(let c=0;c<r;++c){const r=e[t+0],a=e[t+1],i=e[t+2];n[o+0]=r,n[o+1]=a,n[o+2]=null==u?i+s:s,t+=3,o+=3}return 0}let T=function(){this.verticalDistanceToGround=0,this.sampledElevation=0,this.z=0};var O;e.SymbolUpdateType=void 0,(O=e.SymbolUpdateType||(e.SymbolUpdateType={}))[O.NONE=0]="NONE",O[O.UPDATE=1]="UPDATE",O[O.RECREATE=2]="RECREATE";const U={"absolute-height":{applyElevationAlignmentBuffer:A,requiresAlignment:y},"on-the-ground":{applyElevationAlignmentBuffer:m,requiresAlignment:()=>!0},"relative-to-ground":{applyElevationAlignmentBuffer:E,requiresAlignment:()=>!0},"relative-to-scene":{applyElevationAlignmentBuffer:h,requiresAlignment:()=>!0}},R=o.create(),b=new T,P=r.create();e.SampleElevationInfo=T,e.applyElevationAlignmentForHUD=g,e.applyPerVertexElevationAlignment=u,e.elevationModeChangeUpdateType=p,e.evaluateElevationAlignmentAtPoint=f,e.evaluateElevationInfoAtPoint=c,e.needsElevationUpdates2D=d,e.needsElevationUpdates3D=v,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
