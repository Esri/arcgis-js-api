/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../core/has","../../../../core/maybe","../../../../core/Logger","../../../../chunks/vec3f64","../../../../chunks/vec3","../../../../chunks/vec2f64","../../../../chunks/vec4f64","../../../../geometry/support/aaBoundingBox","../../webgl-engine/materials/HUDMaterial","./graphicSymbolUtils"],(function(e,t,n,r,a,c,l,s,o,i,f){"use strict";const h=r.getLogger("esri.views.3d.layers.graphics.labelPlacement");function m(e){const t=e.graphics3DGraphic.graphics3DSymbol,r=f.getGraphics3DSymbol(t);return n.isSome(r)?r.symbol.symbolLayers.getItemAt(0):null}function p(e,t){return`the requested label placement '${e}' is currently unsupported for ${t} in SceneView`}function u(e){const t=e.graphics3DGraphic.graphic.geometry;if(n.isNone(t))return null;switch(t.type){case"polyline":case"extent":case"multipoint":return{placement:"center-center",normalizedOffset:null,anchor:"center"};case"polygon":{const t=m(e);return n.isSome(t)&&"extrude"===t.type?O["above-center"]:{placement:"center-center",normalizedOffset:null,anchor:"center"}}case"point":case"mesh":return O["above-center"];default:return}}function b(e,t,r){const l=r.graphics3DGraphic._graphics[0],s=n.isSome(l)?l.getBoundingBoxObjectSpace(P):P,o=a.fromValues(s[3]-s[0],s[4]-s[1],s[5]-s[2]),i=Math.sqrt(o[0]*o[0]+o[1]*o[1]);e.centerOffset[0]=i/2*t.normalizedOffset[0];const f=e.translation[2],h=o[2]/2*t.normalizedOffset[1];e.translation[2]=0,e.elevationOffset=f+h;const m=c.length(o);e.centerOffset[2]=m/2*t.normalizedOffset[2]}function g(e){const{screenLength:t,minWorldLength:n,maxWorldLength:r}=e;return{screenLength:t,minWorldLength:n,maxWorldLength:r}}const O={"above-center":{placement:"above-center",normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{placement:"above-left",normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{placement:"above-right",normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{placement:"below-center",normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{placement:"below-left",normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{placement:"below-right",normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{placement:"center-center",normalizedOffset:[0,0,1],anchor:"center"},"center-left":{placement:"center-left",normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{placement:"center-right",normalizedOffset:[1,0,0],anchor:"left"}},d={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};for(const e in d){const t=d[e],n=O[e];t.forEach((e=>{O[e]=n}))}Object.freeze&&(Object.freeze(O),Object.keys(O).forEach((function(e){Object.freeze(O[e]),Object.freeze(O[e].normalizedOffset)})));const v=[0,0],y=[0,0],P=o.create();e.get=function(e){const t=function(e){const t=e.labelClass.labelPlacement,{labelSymbol:r,graphics3DGraphic:a}=e,c=f.getGraphics3DSymbol(a.graphics3DSymbol),l=n.isSome(c)?c.symbol:null,s=O[t]||u(e);if("point-3d"===l.type&&l.supportsCallout()&&l.hasVisibleVerticalOffset()&&!a.isDraped)return{placement:null,hasLabelVerticalOffset:!1,verticalOffset:g(l.verticalOffset),anchor:null,normalizedOffset:null};if(r&&r.hasVisibleVerticalOffset()&&("point-3d"!==l.type||!l.supportsCallout()||!l.verticalOffset||a.isDraped))return function(e){switch(e){case"above-center":return!0;default:return!1}}(s.placement)?{placement:"above-center",verticalOffset:g(r.verticalOffset),anchor:"bottom",normalizedOffset:[0,s.normalizedOffset[1],0],hasLabelVerticalOffset:!0}:(h.errorOncePerTick("Callouts and vertical offset on labels are currently only supported with 'above-center' label placement (not with "+t+" placement)"),null);return{placement:null,verticalOffset:null,anchor:null,normalizedOffset:null,hasLabelVerticalOffset:!1}}(e);if(n.isNone(t))return null;const r=function(e,t){if(t.anchor)return t;const r=e.labelClass.labelPlacement,a=O[r],c=a||u(e);r&&!a&&h.warnOncePerTick(`the requested label placement '${r}' is not currently supported in SceneView`);return function(e,t){const r=t.graphics3DGraphic.graphic.geometry;if(n.isNone(r))return null;if(n.isSome(t.disablePlacement)){return t.labelClass.labelPlacement?(h.warnOncePerTick(p(e.placement,t.disablePlacement.logEntityDescription)),u(t)):e}const a=r.type;switch(a){case"polyline":case"polygon":case"extent":case"multipoint":if(t.labelClass.labelPlacement)return h.warnOncePerTick(p(e.placement,`'${a}' geometries`)),u(t);break;case"point":case"mesh":return e}return e}(c,e)}(e,t);if(n.isNone(r))return null;const c=r.anchor,d=!!t.hasLabelVerticalOffset;return function(e,t,r){const a=r.graphics3DGraphic.graphic.geometry;if(n.isNone(a))return null;switch(a.type){case"point":!function(e,t,r){const a=m(r);if(n.isNone(a))return;switch(r.graphics3DGraphic.getCenterObjectSpace(e.translation),a.type){case"icon":case"text":!function(e,t,r){const{graphics3DGraphic:a}=r,c=a._graphics[0],l=n.isSome(c)?c.getScreenSize():null;if(!a.isDraped&&n.isSome(l)){const a=function(e,t=y){const{graphics3DGraphic:r}=e,a=r._graphics[0],c=n.isSome(a)?a.stageObject.geometryRecords[0].material:null;if(c&&c instanceof i.HUDMaterial){const e=c.params.anchorPos;t[0]=2*(e[0]-.5),t[1]=2*(e[1]-.5)}else t[0]=0,t[1]=0;return t}(r);v[0]=l[0]/2*(t.normalizedOffset[0]-a[0]),v[1]=l[1]/2*(t.normalizedOffset[1]-a[1]),e.screenOffset[0]=v[0],e.hasLabelVerticalOffset?(e.centerOffset[1]=v[1],e.centerOffsetUnits="screen"):e.screenOffset[1]=v[1]}else e.hasLabelVerticalOffset||"center"===e.anchor||(O[r.labelClass.labelPlacement]&&h.warnOncePerTick(`the requested placement '${t.placement}' is currently unsupported for draped graphics`),e.anchor="center")}(e,t,r);break;case"object":b(e,t,r)}}(e,t,r);break;case"polygon":!function(e,t,r){const a=m(r);if(n.isNone(a))return;switch(a.type){case"extrude":{const a=r.graphics3DGraphic._graphics[0];n.isSome(a)&&a.getBoundingBoxObjectSpace(P),o.center(P,e.translation),e.translation[2]=o.height(P)/2,b(e,t,r);break}}}(e,t,r);break;case"mesh":b(e,t,r)}return e}({anchor:c,verticalOffset:t.verticalOffset,screenOffset:l.create(),centerOffset:s.fromValues(0,0,0,-1),centerOffsetUnits:"world",translation:a.create(),elevationOffset:0,hasLabelVerticalOffset:d},r,e)},Object.defineProperty(e,"__esModule",{value:!0})}));
