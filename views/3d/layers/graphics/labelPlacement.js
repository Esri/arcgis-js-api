/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../core/has","../../../../core/Logger","../../../../core/maybe","../../../../chunks/vec2f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../chunks/vec4f64","../../../../geometry/support/aaBoundingBox","./graphicSymbolUtils","../../webgl-engine/materials/HUDMaterial"],(function(e,t,n,r,a,c,l,o,s,i,f){"use strict";const m=n.getLogger("esri.views.3d.layers.graphics.labelPlacement");function h(e){const t=z(e);if(r.isNone(t))return null;const n=p(e,t);if(r.isNone(n))return null;const c=n.anchor,s=!!t.hasLabelVerticalOffset;return d({anchor:c,verticalOffset:t.verticalOffset,screenOffset:a.create(),centerOffset:o.fromValues(0,0,0,-1),centerOffsetUnits:"world",translation:l.create(),elevationOffset:0,hasLabelVerticalOffset:s},n,e)}function p(e,t){if(t.anchor)return t;const n=e.labelClass.labelPlacement,r=k[n],a=r||O(e);return n&&!r&&m.warnOncePerTick(`the requested label placement '${n}' is not currently supported in SceneView`),b(a,e)}function u(e){const t=e.graphics3DGraphic.graphics3DSymbol,n=i.getGraphics3DSymbol(t);return r.isSome(n)?n.symbol.symbolLayers.getItemAt(0):null}function b(e,t){const n=t.graphics3DGraphic.graphic.geometry;if(r.isNone(n))return null;if(r.isSome(t.disablePlacement)){return t.labelClass.labelPlacement?(m.warnOncePerTick(g(e.placement,t.disablePlacement.logEntityDescription)),O(t)):e}const a=n.type;switch(a){case"polyline":case"polygon":case"extent":case"multipoint":if(t.labelClass.labelPlacement)return m.warnOncePerTick(g(e.placement,`'${a}' geometries`)),O(t);break;case"point":case"mesh":return e}return e}function g(e,t){return`the requested label placement '${e}' is currently unsupported for ${t} in SceneView`}function O(e){const t=e.graphics3DGraphic.graphic.geometry;if(r.isNone(t))return null;switch(t.type){case"polyline":case"extent":case"multipoint":return{placement:"center-center",normalizedOffset:null,anchor:"center"};case"polygon":{const t=u(e);return r.isSome(t)&&"extrude"===t.type?k["above-center"]:{placement:"center-center",normalizedOffset:null,anchor:"center"}}case"point":case"mesh":return k["above-center"];default:return}}function d(e,t,n){const a=n.graphics3DGraphic.graphic.geometry;if(r.isNone(a))return null;switch(a.type){case"point":y(e,t,n);break;case"polygon":v(e,t,n);break;case"mesh":w(e,t,n.graphics3DGraphic.graphics[0])}return e}function v(e,t,n){const a=u(n);if(!r.isNone(a))switch(a.type){case"extrude":{const a=n.graphics3DGraphic.graphics[0];r.isSome(a)?(a.getBoundingBoxObjectSpace(j),s.center(j,e.translation),e.translation[2]=s.height(j)/2):c.set(e.translation,0,0,0),w(e,t,a);break}}}function y(e,t,n){const a=u(n);if(r.isNone(a))return;const l=n.graphics3DGraphic.graphics[0];switch(r.isSome(l)?l.getCenterObjectSpace(e.translation):c.set(e.translation,0,0,0),a.type){case"icon":case"text":S(e,t,n,l);break;case"object":w(e,t,l)}}function S(e,t,n,a){const{graphics3DGraphic:c}=n,l=r.isSome(a)?a.getScreenSize():null;if(!c.isDraped&&r.isSome(l)){const r=P(n);V[0]=l[0]/2*(t.normalizedOffset[0]-r[0]),V[1]=l[1]/2*(t.normalizedOffset[1]-r[1]),e.screenOffset[0]=V[0],e.hasLabelVerticalOffset?(e.centerOffset[1]=V[1],e.centerOffsetUnits="screen"):e.screenOffset[1]=V[1]}else e.hasLabelVerticalOffset||"center"===e.anchor||(k[n.labelClass.labelPlacement]&&m.warnOncePerTick(`the requested placement '${t.placement}' is currently unsupported for draped graphics`),e.anchor="center")}function P(e,t=G){const{graphics3DGraphic:n}=e,a=n.graphics[0],c=r.isSome(a)?a.stageObject.geometryRecords[0].material:null;if(c&&c instanceof f.HUDMaterial){const e=c.parameters.anchorPos;t[0]=2*(e[0]-.5),t[1]=2*(e[1]-.5)}else t[0]=0,t[1]=0;return t}function w(e,t,n){const a=r.isSome(n)?n.getBoundingBoxObjectSpace(j):j,o=l.fromValues(a[3]-a[0],a[4]-a[1],a[5]-a[2]),s=Math.sqrt(o[0]*o[0]+o[1]*o[1]);e.centerOffset[0]=s/2*t.normalizedOffset[0];const i=e.translation[2],f=o[2]/2*t.normalizedOffset[1];e.translation[2]=0,e.elevationOffset=i+f;const m=c.length(o);e.centerOffset[2]=m/2*t.normalizedOffset[2]}function L(e){return"above-center"===e}function z(e){const t=e.labelClass.labelPlacement,{labelSymbol:n,graphics3DGraphic:a}=e,c=i.getGraphics3DSymbol(a.graphics3DSymbol),l=r.applySome(c,(e=>"point-3d"===e.symbol.type?e.symbol:null)),o=k[t]||O(e);return r.isSome(l)&&l.supportsCallout()&&l.hasVisibleVerticalOffset()&&!a.isDraped?{placement:null,hasLabelVerticalOffset:!1,verticalOffset:D(l.verticalOffset),anchor:null,normalizedOffset:null}:n&&n.hasVisibleVerticalOffset()&&(r.isNone(l)||!l.supportsCallout()||!l.verticalOffset||a.isDraped)?L(o.placement)?{placement:"above-center",verticalOffset:D(n.verticalOffset),anchor:"bottom",normalizedOffset:[0,o.normalizedOffset[1],0],hasLabelVerticalOffset:!0}:(m.errorOncePerTick("Callouts and vertical offset on labels are currently only supported with 'above-center' label placement (not with "+t+" placement)"),null):{placement:null,verticalOffset:null,anchor:null,normalizedOffset:null,hasLabelVerticalOffset:!1}}function D(e){const{screenLength:t,minWorldLength:n,maxWorldLength:r}=e;return{screenLength:t,minWorldLength:n,maxWorldLength:r}}const k={"above-center":{placement:"above-center",normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{placement:"above-left",normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{placement:"above-right",normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{placement:"below-center",normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{placement:"below-left",normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{placement:"below-right",normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{placement:"center-center",normalizedOffset:[0,0,1],anchor:"center"},"center-left":{placement:"center-left",normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{placement:"center-right",normalizedOffset:[1,0,0],anchor:"left"}},C={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};for(const x in C){const e=C[x],t=k[x];e.forEach((e=>{k[e]=t}))}Object.freeze&&(Object.freeze(k),Object.keys(k).forEach((function(e){Object.freeze(k[e]),Object.freeze(k[e].normalizedOffset)})));const V=[0,0],G=[0,0],j=s.create();e.get=h,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
