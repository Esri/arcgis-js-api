/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../Graphic","../../../../core/compilerUtils","../../../../core/HandleOwner","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","../../../../core/accessorSupport/diffUtils","../../../../geometry/support/webMercatorUtils","../../../../renderers/support/renderingInfoUtils","../../../../rest/support/Query","./constants","./Graphics3DCore","./Graphics3DElevationAlignment","./Graphics3DFilterVisibility","./Graphics3DFrustumVisibility","./Graphics3DObjectStates","./Graphics3DScaleVisibility","./graphicUtils","../support/attributeUtils","../../webgl-engine/lib/basicInterfaces"],(function(e,t,i,r,s,n,a,o,l,p,u,c,d,h,y,g,f,b,m,_,v,C,E,w,S,x,V){"use strict";let O=function(t){function s(e){var i;return(i=t.call(this,e)||this).type="graphics-3d",i.elevationFeatureExpressionEnabled=!1,i.dataExtent=null,i.preferredUpdatePolicy=V.UpdatePolicy.ASYNC,i.suspendResumeExtent=null,i}e._inheritsLoose(s,t);var l=s.prototype;return l.normalizeCtorArgs=function(e){const t=e.frustumVisibilityEnabled?new C:null,i=e.scaleVisibilityEnabled?new w:null,r=(e.filterVisibilityEnabled||e.timeExtentVisibilityEnabled)&&"multipatch"!==e.owner.layer.geometryType?new v.Graphics3DFilterVisibility:null,s=e.elevationAlignmentEnabled?new _:null,{owner:n,updateClippingExtent:a,dataExtent:o,elevationFeatureExpressionEnabled:l,preferredUpdatePolicy:p}=e;return{owner:n,updateClippingExtent:a,dataExtent:o,frustumVisibility:t,scaleVisibility:i,filterVisibility:r,elevationAlignment:s,elevationFeatureExpressionEnabled:l,preferredUpdatePolicy:p}},l.initialize=function(){const e=new m.Graphics3DCore({owner:this,layer:this.layer,preferredUpdatePolicy:this.preferredUpdatePolicy,elevationFeatureExpressionEnabled:this.elevationFeatureExpressionEnabled,graphicSymbolSupported:!1,hasZ:this.owner.hasZ,hasM:this.owner.hasM});this._set("graphicsCore",e),this.scaleVisibility&&this.updatingHandles.add((()=>this.layer.effectiveScaleRange),(()=>this.scaleVisibility.layerMinMaxScaleChangeHandler())),this.filterVisibility&&(this.updatingHandles.add((()=>"filter"in this.owner&&this.owner.filter),(()=>this.filterVisibility.filterChanged())),this.updatingHandles.add((()=>"timeExtent"in this.owner&&this.owner.timeExtent),(()=>this.filterVisibility.filterChanged()))),this.elevationAlignment&&this.updatingHandles.add((()=>this.layer.elevationInfo),((e,t)=>{h.diff(e,t)&&this.updatingHandles.addPromise(this.graphicsCore.elevationInfoChange())})),this.updatingHandles.add((()=>this.layer.labelsVisible),(()=>this.graphicsCore.updateVisibilityInfo())),this.updatingHandles.add((()=>this.layer.labelingInfo),((e,t)=>{h.diff(e,t)&&this.graphicsCore.updateLabelingInfo()})),this.updatingHandles.add((()=>this.preferredUpdatePolicy),(e=>this.graphicsCore.preferredUpdatePolicy=e)),this.handles.add(this.view.resourceController.memoryController.events.on("quality-changed",(()=>this.notifyChange("displayFeatureLimit"))))},l.destroy=function(){this.handles.removeAll(),this.updatingHandles.removeAll(),this._set("frustumVisibility",n.destroyMaybe(this.frustumVisibility)),this._set("scaleVisibility",n.destroyMaybe(this.scaleVisibility)),this._set("filterVisibility",n.destroyMaybe(this.filterVisibility)),this._set("elevationAlignment",n.destroyMaybe(this.elevationAlignment)),this._set("objectStates",n.destroyMaybe(this.objectStates)),this._set("graphicsCore",n.destroyMaybe(this.graphicsCore)),this._set("owner",null)},l.setup=function(){var t=e._asyncToGenerator((function*(){this.frustumVisibility&&this.frustumVisibility.setup(this);const e=this.owner,t=this.owner.view.basemapTerrain,i=(e,t,i)=>this.graphicsCore.spatialIndex.queryGraphicUIDsInExtent(e,t,i);if(this.scaleVisibility&&this.scaleVisibility.setup(this,this.layer,i,this.graphicsCore,t),this.filterVisibility&&("filter"in e||"timeExtent"in e)&&this.filterVisibility.setup(e,this.graphicsCore),this.elevationAlignment){const t=e.view.elevationProvider;this.elevationAlignment.setup(this,i,this.graphicsCore,t)}this._set("objectStates",new E.Graphics3DObjectStates(this.graphicsCore)),this._set("labeling",this.owner.view.labeler.addGraphicsOwner(this.graphicsCore,this.scaleVisibility)),this._set("deconfliction",e.view.deconflictor.addGraphicsOwner(this.graphicsCore)),yield a.logOnError(this.graphicsCore.setup({elevationAlignment:this.elevationAlignment,scaleVisibility:this.scaleVisibility,filterVisibility:this.filterVisibility,deconflictor:this.deconfliction,labeler:this.labeling,objectStates:this.objectStates})),this.updatingHandles.add((()=>this.layer.renderer),(e=>this.updatingHandles.addPromise(this.graphicsCore.rendererChange(e)))),this.updatingHandles.add((()=>e.fullOpacity),(()=>this.graphicsCore.opacityChange())),this._setupSuspendResumeExtent(),this.updateClippingExtent&&(this.updatingHandles.add((()=>e.view.clippingArea),(()=>this._updateClippingExtent())),this._updateClippingExtent()),this.graphicsCore.startCreateGraphics(),this.graphicsCore.labelsEnabled&&(yield a.logOnError(this.graphicsCore.updateLabelingInfo()))}));function i(){return t.apply(this,arguments)}return i}(),l.maskOccludee=function(e){const{set:t,handle:i}=this.objectStates.acquireSet(V.Object3DState.MaskOccludee,null);return this.objectStates.setUid(t,e.uid),i},l.highlight=function(e,t){if(e instanceof f){const{set:i,handle:r}=this.objectStates.acquireSet(V.Object3DState.Highlight,t);return this.owner.queryObjectIds(e).then((e=>this.objectStates.setObjectIds(i,e))),r}if("number"==typeof e||"string"==typeof e)return this.highlight([e],t);if(e instanceof i)return this.highlight([e],t);if("toArray"in e&&(e=e.toArray()),Array.isArray(e)&&e.length>0){if(e[0]instanceof i){const i=e;if(null==x.attributeLookup(this.layer.fieldsIndex,i[0].attributes,t)){const e=i.map((e=>e.uid)),{set:t,handle:r}=this.objectStates.acquireSet(V.Object3DState.Highlight,null);return this.objectStates.setUids(t,e),r}e=i.map((e=>x.attributeLookup(this.layer.fieldsIndex,e.attributes,t)))}if("number"==typeof e[0]||"string"==typeof e[0]){const i=e,{set:r,handle:s}=this.objectStates.acquireSet(V.Object3DState.Highlight,t);return this.objectStates.setObjectIds(r,i),s}}return k},l.whenGraphicBounds=function(e,t){var i;return null==(i=this.graphicsCore)?void 0:i.whenGraphicBounds(e,t)},l.computeAttachmentOrigin=function(e,t){var i;return null==(i=this.graphicsCore)?void 0:i.computeAttachmentOrigin(e,t)},l.notifyGraphicGeometryChanged=function(e){this.graphicsCore.notifyGraphicGeometryChanged(e)},l.notifyGraphicVisibilityChanged=function(e){this.graphicsCore.notifyGraphicVisibilityChanged(e)},l.getRenderingInfo=function(e,t,i){const r=g.getRenderingInfo(e,{renderer:t,arcade:i});if(n.isSome(r)&&r.color){const e=r.color;e[0]=e[0]/255,e[1]=e[1]/255,e[2]=e[2]/255}return r},l.getRenderingInfoAsync=function(e,t,i,r){return g.getRenderingInfoAsync(e,{renderer:t,arcade:i,...r})},l.getSymbolLayerSize=function(e,t){var i;return null==(i=this.graphicsCore)?void 0:i.getSymbolLayerSize(e,t)},l.setObjectIdVisibility=function(e,t){var i;null==(i=this.graphicsCore)||i.setObjectIdVisibility(e,t)},l._updateClippingExtent=function(){const e=this.owner.view.clippingArea;this.graphicsCore.setClippingExtent(e,this.owner.view.spatialReference)&&(this.updateClippingExtent(e)||this.graphicsCore.recreateAllGraphics())},l._setupSuspendResumeExtent=function(){(this.frustumVisibility||this.scaleVisibility)&&this.handles.add(o.watch((()=>this.suspendResumeExtentMode),(()=>{switch(this.handles.remove(R),this.suspendResumeExtentMode){case"computed":this.handles.add([o.watch((()=>this.graphicsCore.computedExtent),(e=>this._updateSuspendResumeExtent(e)),o.initial),o.watch((()=>this.graphicsCore.extentPadding),(()=>this._updateSuspendResumeExtent(this.graphicsCore.computedExtent)))],R);break;case"data":this.handles.add([o.when((()=>this.dataExtent),(e=>this._updateSuspendResumeExtent(e)),o.initial),o.watch((()=>this.graphicsCore.extentPadding),(()=>this._updateSuspendResumeExtent(n.unwrap(this.dataExtent))))],R);break;default:r.neverReached(this.suspendResumeExtentMode)}}),o.initial))},l._updateSuspendResumeExtent=function(e){e?this._suspendResumeExtentChanged(this._extentToSuspendResumeRect(e,this.suspendResumeExtent)):this._suspendResumeExtentChanged(null)},l._extentToSuspendResumeRect=function(e,t){const i=this.owner.view.spatialReference;if(!e.spatialReference.equals(i)){if(!y.canProject(e,i))return;e=y.project(e,i)}return S.enlargeExtent(e,t,b.SUSPEND_RESUME_EXTENT_OPTIMISM,this.graphicsCore.extentPadding)},l._suspendResumeExtentChanged=function(e){this.frustumVisibility&&this.frustumVisibility.setExtent(e),this.scaleVisibility&&this.scaleVisibility.setExtent(e)},e._createClass(s,[{key:"featureSpatialReference",get:function(){return"featureSpatialReference"in this.owner?this.owner.featureSpatialReference:void 0}},{key:"layer",get:function(){return this.owner.layer}},{key:"suspendResumeExtentMode",get:function(){return"suspendResumeExtentMode"in this.owner?this.owner.suspendResumeExtentMode:"computed"}},{key:"scaleVisibilitySuspended",get:function(){var e;return null==(e=this.scaleVisibility)?void 0:e.suspended}},{key:"suspended",get:function(){return this.owner.suspended}},{key:"legendEnabled",get:function(){return!this.frustumVisibility.suspended}},{key:"suspendInfo",get:function(){var e,t;const i={};return null!=(e=this.scaleVisibility)&&e.suspended&&(i.outsideScaleRange=!0),null!=(t=this.frustumVisibility)&&t.suspended&&(i.outsideOfView=!0),i}},{key:"updating",get:function(){var e,t,i;return!!(null!=(e=this.graphicsCore)&&e.updating||null!=(t=this.frustumVisibility)&&t.updating||null!=(i=this.updatingHandles)&&i.updating)}},{key:"updatingRemaining",get:function(){var e,t;return null!=(e=null==(t=this.graphicsCore)?void 0:t.updatingRemaining)?e:0}},{key:"featureStore",get:function(){var e;return null==(e=this.graphicsCore)?void 0:e.featureStore}},{key:"view",get:function(){return this.owner.view}},{key:"loadedGraphics",get:function(){return this.owner.loadedGraphics}},{key:"fullOpacity",get:function(){return this.owner.fullOpacity}},{key:"filter",get:function(){return"filter"in this.owner?this.owner.filter:null}},{key:"slicePlaneEnabled",get:function(){return this.owner.slicePlaneEnabled}},{key:"drapeSourceType",get:function(){return this.owner.drapeSourceType}},{key:"updatePolicy",get:function(){return this.owner.updatePolicy}},{key:"graphics3DGraphics",get:function(){var e;return null==(e=this.graphicsCore)?void 0:e.graphics3DGraphics}},{key:"graphics3DGraphicsByObjectID",get:function(){var e;return null==(e=this.graphicsCore)?void 0:e.graphics3DGraphicsByObjectID}},{key:"symbolUpdateType",get:function(){var e;return null==(e=this.graphicsCore)?void 0:e.symbolUpdateType}},{key:"displayFeatureLimit",get:function(){var e;const t=this.view.resourceController.memoryController.memoryFactor,i=null==(e=this.graphicsCore)?void 0:e.displayFeatureLimit;if(1===t)return i;const r=Math.ceil(i.maximumNumberOfFeatures*t),s=Math.ceil(i.maximumTotalNumberOfFeatures*t),n=Math.ceil(i.minimumTotalNumberOfFeatures*t);return{...i,maximumNumberOfFeatures:r,maximumTotalNumberOfFeatures:s,minimumTotalNumberOfFeatures:n}}},{key:"usedMemory",get:function(){var e,t;return null!=(e=null==(t=this.graphicsCore)?void 0:t.usedMemory)?e:0}},{key:"usedMemoryPerFeature",get:function(){var e,t;return null!=(e=null==(t=this.graphicsCore)?void 0:t.usedMemoryPerGraphic)?e:0}},{key:"unprocessedMemoryEstimate",get:function(){var e,t;return null!=(e=null==(t=this.graphicsCore)?void 0:t.unprocessedMemoryEstimate)?e:0}},{key:"performanceInfo",get:function(){return{core:this.graphicsCore.performanceInfo,elevationUpdating:this.elevationAlignment.updating,visibilityFrustum:!this.frustumVisibility.suspended,visibilityScale:!this.scaleVisibility.suspended}}}]),s}(s.HandleOwner);t.__decorate([l.property()],O.prototype,"type",void 0),t.__decorate([l.property({constructOnly:!0})],O.prototype,"owner",void 0),t.__decorate([l.property()],O.prototype,"layer",null),t.__decorate([l.property({constructOnly:!0})],O.prototype,"updateClippingExtent",void 0),t.__decorate([l.property({constructOnly:!0})],O.prototype,"elevationFeatureExpressionEnabled",void 0),t.__decorate([l.property({constructOnly:!0})],O.prototype,"graphicsCore",void 0),t.__decorate([l.property({constructOnly:!0})],O.prototype,"scaleVisibility",void 0),t.__decorate([l.property({constructOnly:!0})],O.prototype,"filterVisibility",void 0),t.__decorate([l.property({constructOnly:!0})],O.prototype,"elevationAlignment",void 0),t.__decorate([l.property({constructOnly:!0})],O.prototype,"frustumVisibility",void 0),t.__decorate([l.property({readOnly:!0})],O.prototype,"deconfliction",void 0),t.__decorate([l.property({readOnly:!0})],O.prototype,"labeling",void 0),t.__decorate([l.property({readOnly:!0})],O.prototype,"objectStates",void 0),t.__decorate([l.property()],O.prototype,"suspendResumeExtentMode",null),t.__decorate([l.property()],O.prototype,"dataExtent",void 0),t.__decorate([l.property()],O.prototype,"scaleVisibilitySuspended",null),t.__decorate([l.property()],O.prototype,"suspended",null),t.__decorate([l.property()],O.prototype,"legendEnabled",null),t.__decorate([l.property()],O.prototype,"suspendInfo",null),t.__decorate([l.property()],O.prototype,"updating",null),t.__decorate([l.property()],O.prototype,"updatingRemaining",null),t.__decorate([l.property()],O.prototype,"featureStore",null),t.__decorate([l.property()],O.prototype,"view",null),t.__decorate([l.property()],O.prototype,"loadedGraphics",null),t.__decorate([l.property()],O.prototype,"fullOpacity",null),t.__decorate([l.property()],O.prototype,"filter",null),t.__decorate([l.property()],O.prototype,"slicePlaneEnabled",null),t.__decorate([l.property()],O.prototype,"drapeSourceType",null),t.__decorate([l.property()],O.prototype,"updatePolicy",null),t.__decorate([l.property()],O.prototype,"preferredUpdatePolicy",void 0),t.__decorate([l.property()],O.prototype,"displayFeatureLimit",null),O=t.__decorate([d.subclass("esri.views.3d.layers.graphics.Graphics3DFeatureProcessor")],O);const R="suspendResumeExtentMode",k={remove(){},pause(){},resume(){}};return O}));
