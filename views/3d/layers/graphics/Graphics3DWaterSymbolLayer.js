/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../Color","../../../../core/maybe","../../../../core/unitUtils","../../../../chunks/earcut","../../../../chunks/mat4f64","../../../../chunks/vec2","../../../../chunks/vec2f64","../../../../chunks/vec4","../../../../chunks/common","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","./ElevationAligners","./elevationAlignmentUtils","./ElevationContext","./Graphics3DDrapedGraphicLayer","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolLayer","./polygonUtils","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/RenderGeometry","../../webgl-engine/materials/WaterMaterial","../../webgl-engine/materials/internal/waterMaterialUtils"],(function(e,t,r,n,o,a,i,s,l,u,c,h,d,p,m,y,g,f,v,_,D,x,b,S){"use strict";const C=["polyline","polygon","extent"];let E=function(e){function v(t,r,n,o){return e.call(this,t,r,n,o)||this}t._inheritsLoose(v,e);var E=v.prototype;return E.doLoad=function(){var e=t._asyncToGenerator((function*(){}));function r(){return e.apply(this,arguments)}return r}(),E.destroy=function(){e.prototype.destroy.call(this),this._context.stage.remove(this._material),this._material=null},E.createGraphics3DGraphic=function(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,C,this.symbolLayer.type))return null;const r=this.setGraphicElevationContext(t,new y.ElevationContext);return this.ensureDrapedStatus("on-the-ground"===r.mode),this.ensureMaterial(),this.draped?this._createAsOverlay(t):this._createAs3DShape(t,r,t.uid)},E.ensureMaterial=function(){if(n.isSome(this._material))return;const e={...S.defaultWaterMaterialParameters},t=this.symbolLayer.color;n.isSome(t)&&(e.color=r.toUnitRGBA(t));const o=this._getCombinedOpacity(t,{hasIntrinsicColor:!0});e.color=[e.color[0],e.color[1],e.color[2],o],e.transparent=o<1||this.needsDrivenTransparentPass,e.waveDirection=n.isSome(this.symbolLayer.waveDirection)?v.headingVectorFromAngle(this.symbolLayer.waveDirection):l.fromValues(0,0);const a=this.symbolLayer.waveStrength+"-"+this.symbolLayer.waterbodySize,i=S.wavePresets[a];e.waveStrength=i.waveStrength,e.waveTextureRepeat=i.textureRepeat,e.waveVelocity=i.waveVelocity,e.flowStrength=i.perturbationStrength,e.slicePlaneEnabled=this._context.slicePlaneEnabled,e.isDraped=this.draped,this._material=new b.WaterMaterial(e),this._context.stage.add(this._material)},E.layerOpacityChanged=function(){if(n.isNone(this._material))return!0;const e=this._material.parameters.color,t=this._getCombinedOpacity(this.symbolLayer.color,{hasIntrinsicColor:!0}),r=t<1||this.needsDrivenTransparentPass;return this._material.setParameters({color:[e[0],e[1],e[2],t],transparent:r}),!0},E.layerElevationInfoChanged=function(e,t,r){const n=this._elevationContext.mode,o=m.elevationModeChangeUpdateType(v.elevationModeChangeTypes,r,n);if(o!==m.SymbolUpdateType.UPDATE)return o;const a=m.needsElevationUpdates2D(n);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>a))},E.slicePlaneEnabledChanged=function(){return n.isSome(this._material)&&this._material.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0},E.physicalBasedRenderingChanged=function(){return!0},E.pixelRatioChanged=function(){return!0},E._createAs3DShape=function(e,t,r){const o=_.geometryAsPolygon(e.geometry);if(n.isNone(o))return null;A.renderData=_.geometryToRenderInfo(o,this._context.elevationProvider,this._context.renderCoordsHelper,t);const a=A.renderData.position.length/3;if(A.uvCoords=new Float64Array(2*a),A.outNum=0,A.outGeometries=[],A.outTransforms=[],A.outMaterials=[],this._create3DShapeGeometries(A),this._logGeometryCreationWarnings(A.renderData,o.rings,"rings","WaterSymbol3DLayer"),0===A.outNum)return null;this._createUVCoordsFromVertices(A.uvCoords,A.renderData.mapPosition,a,this._context.elevationProvider.spatialReference);const i=new D.Object3D({geometries:A.outGeometries,materials:A.outMaterials,transformations:A.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:r}}),s=new f.Graphics3DObject3DGraphicLayer(this,i,A.outGeometries,null,null,p.perVertexElevationAligner,t);return s.alignedSampledElevation=A.renderData.sampledElevation,s.needsElevationUpdates=m.needsElevationUpdates2D(t.mode),s},E._createUVCoordsFromVertices=function(e,t,r,n){const a=o.getMetersPerUnitForSR(n);d.empty(T);for(let o=0;o<r;o++)s.set(w,t[3*o+0],t[3*o+1]),d.expandPointInPlace(T,w);u.scale(T,T,a);const i=T[0]%v.unitSizeOfTexture,l=T[1]%v.unitSizeOfTexture;G[0]=T[0]-i,G[1]=T[1]-l;for(let o=0;o<r;o++)e[2*o+0]=(t[3*o+0]*a-G[0])/v.unitSizeOfTexture,e[2*o+1]=(t[3*o+1]*a-G[1])/v.unitSizeOfTexture},E._create3DShapeGeometries=function(e){const t=e.renderData.polygons,r=e.uvCoords;for(const{count:o,index:s,position:l,mapPosition:u,holeIndices:c}of t){if(n.isSome(this._context.clippingExtent)&&(h.empty(U),h.expandWithBuffer(U,u),!h.intersectsClippingArea(U,this._context.clippingExtent)))continue;const t=a.earcut(u,c,3);if(0===t.length)continue;const d=new Uint32Array(t),p=new Float64Array(r.buffer,2*s*r.BYTES_PER_ELEMENT,2*o),m=_.createWaterGeometry({indices:d,attributeData:{position:l,uv0:p,mapPosition:u}});e.outGeometries.push(m),e.outMaterials.push(n.unwrap(this._material)),e.outTransforms.push(i.IDENTITY),e.outNum++}},E._createAsOverlay=function(e){const t=_.geometryAsPolygon(e.geometry);if(n.isNone(t))return null;n.unwrap(this._material).renderPriority=this._renderPriority,P.renderData=_.geometryToRenderInfoDraped(t,this._context.overlaySR);const r=P.renderData.position.length/3;return P.uvCoords=new Float64Array(2*r),P.outNum=0,P.outGeometries=[],P.outBoundingBox=h.empty(),P.layerUid=this._context.layer.uid,P.graphicsUid=e.uid,this._createAsOverlayWater(P),this._logGeometryCreationWarnings(P.renderData,t.rings,"rings","WaterSymbol3DLayer"),0===P.outNum?null:(this._createUVCoordsFromVertices(P.uvCoords,P.renderData.position,r,this._context.overlaySR),P.outNum>0?new g(this,P.outGeometries,P.outBoundingBox):null)},E._createAsOverlayWater=function(e){const t=e.uvCoords,r=e.renderData.polygons;for(const{position:o,holeIndices:i,index:s,count:l}of r){if(h.empty(U),h.expandWithBuffer(U,o),!h.intersectsClippingArea(U,this._context.clippingExtent))continue;h.expandWithAABB(e.outBoundingBox,U);const r=a.earcut(o,i,3);if(0===r.length)continue;const c=new Uint32Array(r),d=new Float64Array(t.buffer,2*s*t.BYTES_PER_ELEMENT,2*l),p=_.createWaterGeometry({indices:c,attributeData:{position:o,uv0:d}}),m=new x.RenderGeometry(p,n.unwrap(this._material),{layerUid:e.layerUid,graphicUid:e.graphicsUid}),y=U;u.set(m.boundingSphere,.5*(y[0]+y[3]),.5*(y[1]+y[4]),0,.5*Math.sqrt((y[3]-y[0])*(y[3]-y[0])+(y[4]-y[1])*(y[4]-y[1]))),e.outGeometries.push(m),e.outNum++}},v.headingVectorFromAngle=function(e){const t=l.create(),r=c.toRadian(e);return t[0]=Math.sin(r),t[1]=Math.cos(r),t},t._createClass(v,[{key:"test",get:function(){return{create3DShape:e=>this._createAs3DShape(e.graphic,e.elevationContext,e.graphicUid),ensureMaterial:()=>this.ensureMaterial()}}}]),v}(v.Graphics3DSymbolLayer);E.unitSizeOfTexture=100,E.elevationModeChangeTypes={definedChanged:m.SymbolUpdateType.RECREATE,staysOnTheGround:m.SymbolUpdateType.NONE,onTheGroundChanged:m.SymbolUpdateType.RECREATE};const G=l.create(),T=d.create(),w=l.create(),U=h.create(),A={renderData:null,uvCoords:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},P={renderData:null,uvCoords:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null};e.Graphics3DWaterSymbolLayer=E,e.default=E,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
