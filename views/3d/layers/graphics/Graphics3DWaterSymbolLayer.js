/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../Color","../../../../core/maybe","../../../../core/unitUtils","../../../../chunks/earcut","../../../../chunks/vec2","../../../../chunks/vec2f64","../../../../chunks/vec4","../../../../chunks/common","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","./ElevationAligners","./elevationAlignmentUtils","./ElevationContext","./Graphics3DDrapedGraphicLayer","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolLayer","./polygonUtils","../../support/renderInfoUtils/polygon","../../webgl-engine/lib/DoubleArray","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/RenderGeometry","../../webgl-engine/materials/WaterMaterial","../../webgl-engine/materials/internal/waterMaterialUtils"],(function(e,t,n,r,i,o,a,s,l,c,u,h,p,d,y,m,g,f,v,_,b,S,x,D,C){"use strict";const G=["polyline","polygon","extent"];let w=function(e){function f(t,n,r,i){return e.call(this,t,n,r,i)||this}t._inheritsLoose(f,e);var w=f.prototype;return w.doLoad=function(){var e=t._asyncToGenerator((function*(){}));function n(){return e.apply(this,arguments)}return n}(),w.destroy=function(){e.prototype.destroy.call(this),this._context.stage.remove(this._material),this._material=null},w.createGraphics3DGraphic=function(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,G,this.symbolLayer.type))return null;const n=this.setGraphicElevationContext(t,new y.ElevationContext);return this.ensureDrapedStatus("on-the-ground"===n.mode),this.ensureMaterial(),this.draped?this._createAsOverlay(t):this._createAs3DShape(t,n,t.uid)},w.ensureMaterial=function(){if(r.isSome(this._material))return;const e=new D.WaterMaterialParameters,t=this.symbolLayer.color;r.isSome(t)&&(e.color=n.toUnitRGBA(t));const i=this._getCombinedOpacity(t,{hasIntrinsicColor:!0});e.color=[e.color[0],e.color[1],e.color[2],i],e.transparent=i<1||this.needsDrivenTransparentPass,e.waveDirection=r.isSome(this.symbolLayer.waveDirection)?f.headingVectorFromAngle(this.symbolLayer.waveDirection):s.fromValues(0,0);const o=this.symbolLayer.waveStrength+"-"+this.symbolLayer.waterbodySize,a=C.wavePresets[o];e.waveStrength=a.waveStrength,e.waveTextureRepeat=a.textureRepeat,e.waveVelocity=a.waveVelocity,e.flowStrength=a.perturbationStrength,e.hasSlicePlane=this._context.slicePlaneEnabled,e.isDraped=this.draped,this._material=new D.WaterMaterial(e),this._context.stage.add(this._material)},w.layerOpacityChanged=function(){if(r.isNone(this._material))return;const e=this._material.parameters.color,t=this._getCombinedOpacity(this.symbolLayer.color,{hasIntrinsicColor:!0}),n=t<1||this.needsDrivenTransparentPass;this._material.setParameters({color:[e[0],e[1],e[2],t],transparent:n})},w.layerElevationInfoChanged=function(e,t,n){const r=this._elevationContext.mode,i=d.elevationModeChangeUpdateType(f.elevationModeChangeTypes,n,r);if(i!==d.SymbolUpdateType.UPDATE)return i;const o=d.needsElevationUpdates2D(r);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>o))},w.slicePlaneEnabledChanged=function(){return r.isSome(this._material)&&this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0},w.physicalBasedRenderingChanged=function(){return!0},w.pixelRatioChanged=function(){return!0},w.skipHighSymbolLodsChanged=function(){return!0},w._createAs3DShape=function(e,t,n){const i=v.geometryAsPolygon(e.geometry);if(r.isNone(i))return null;const o=_.geometryToRenderInfo(i,this._context.elevationProvider,this._context.renderCoordsHelper,t),a=o.position.length/3,s=b.newDoubleArray(2*a);this._createUVCoordsFromVertices(s,o.mapPositions,a,this._context.elevationProvider.spatialReference);const l=new U(o,s);if(this._create3DShapeGeometries(l),this._logGeometryCreationWarnings(l.renderData,i.rings,"rings","WaterSymbol3DLayer"),0===l.outGeometries.length)return null;const c=new S.Object3D({geometries:l.outGeometries,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:n}}),u=new g.Graphics3DObject3DGraphicLayer(this,c,l.outGeometries,null,null,p.perVertexElevationAligner,t);return u.alignedSampledElevation=l.renderData.sampledElevation,u.needsElevationUpdates=d.needsElevationUpdates2D(t.mode),u},w._createUVCoordsFromVertices=function(e,t,n,r){const o=i.getMetersPerUnitForSR(r);h.empty(A);for(let i=0;i<n;i++)a.set(E,t[3*i],t[3*i+1]),h.expandPointInPlace(A,E);l.scale(A,A,o);const s=A[0]%f.unitSizeOfTexture,c=A[1]%f.unitSizeOfTexture;P[0]=A[0]-s,P[1]=A[1]-c;for(let i=0;i<n;i++)e[2*i]=(t[3*i]*o-P[0])/f.unitSizeOfTexture,e[2*i+1]=(t[3*i+1]*o-P[1])/f.unitSizeOfTexture},w._create3DShapeGeometries=function(e){const t=e.renderData.polygons,n=e.uvCoords;for(const{count:i,index:a,position:s,mapPositions:l,holeIndices:c}of t){if(r.isSome(this._context.clippingExtent)&&(u.empty(T),u.expandWithBuffer(T,l),!u.intersectsClippingArea(T,this._context.clippingExtent)))continue;const t=o.earcut(l,c,3);if(0===t.length)continue;const h=b.doubleSubArray(n,2*a,2*i),p=v.createWaterGeometry({material:r.unwrap(this._material),indices:t,mapPositions:l,attributeData:{position:s,uv0:h}});e.outGeometries.push(p)}},w._createAsOverlay=function(e){const t=v.geometryAsPolygon(e.geometry);if(r.isNone(t))return null;r.unwrap(this._material).renderPriority=this._renderPriority;const n=_.geometryToRenderInfoDraped(t,this._context.overlaySR),i=n.position.length/3,o=b.newDoubleArray(2*i);this._createUVCoordsFromVertices(o,n.position,i,this._context.overlaySR);const a=new L(n,o,this._context.layer.uid,e.uid);return a.outBoundingBox=u.empty(),this._createAsOverlayWater(a),this._logGeometryCreationWarnings(a.renderData,t.rings,"rings","WaterSymbol3DLayer"),0===a.outGeometries.length?null:new m(this,a.outGeometries,a.outBoundingBox,this._context.drapeSourceRenderer)},w._createAsOverlayWater=function(e){const t=e.uvCoords,n=e.renderData.polygons;for(const{position:i,holeIndices:a,index:s,count:c}of n){if(u.empty(T),u.expandWithBuffer(T,i),!u.intersectsClippingArea(T,this._context.clippingExtent))continue;u.expandWithAABB(e.outBoundingBox,T);const n=o.earcut(i,a,3);if(0===n.length)continue;const h=b.doubleSubArray(t,2*s,2*c),p=v.createWaterGeometry({material:r.unwrap(this._material),indices:n,attributeData:{position:i,uv0:h}}),d=new x.RenderGeometry(p,e),y=T;l.set(d.boundingSphere,.5*(y[0]+y[3]),.5*(y[1]+y[4]),0,.5*Math.sqrt((y[3]-y[0])*(y[3]-y[0])+(y[4]-y[1])*(y[4]-y[1]))),e.outGeometries.push(d)}},f.headingVectorFromAngle=function(e){const t=s.create(),n=c.toRadian(e);return t[0]=Math.sin(n),t[1]=Math.cos(n),t},w.test=function(){return{...e.prototype.test.call(this),create3DShape:e=>this._createAs3DShape(e.graphic,e.elevationContext,e.graphicUid),ensureMaterial:()=>this.ensureMaterial()}},f}(f.Graphics3DSymbolLayer);w.unitSizeOfTexture=100,w.elevationModeChangeTypes={definedChanged:d.SymbolUpdateType.RECREATE,staysOnTheGround:d.SymbolUpdateType.NONE,onTheGroundChanged:d.SymbolUpdateType.RECREATE};const P=s.create(),A=h.create(),E=s.create(),T=u.create();let U=function(e){function n(t,n){var r;return(r=e.call(this,t,null,null)||this).uvCoords=n,r}return t._inheritsLoose(n,e),n}(v.PolygonCreationDataBase),L=function(e){function n(t,n,r,i){var o;return(o=e.call(this,t,r,i)||this).uvCoords=n,o}return t._inheritsLoose(n,e),n}(v.PolygonCreationDataBase);e.Graphics3DWaterSymbolLayer=w,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
