/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../Color","../../../../chunks/common","../../../../core/unitUtils","../../../../geometry/support/aaBoundingRect","../../../../chunks/mat4f64","../../../../chunks/vec2f64","../../../../core/libs/earcut/earcut","../../../../chunks/vec2","../../../../chunks/vec4","../../../../geometry/support/aaBoundingBox","../../webgl-engine/lib/Object3D","./elevationAlignmentUtils","./ElevationAligners","./ElevationContext","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolLayer","./polygonUtils","./Graphics3DDrapedGraphicLayer","../../webgl-engine/lib/RenderGeometry","../../webgl-engine/materials/internal/waterMaterialUtils","../../webgl-engine/materials/WaterMaterial"],(function(e,t,r,n,o,a,i,s,l,u,c,h,d,p,m,y,g,f,v,_,D,x,b,S){"use strict";const C=["polyline","polygon","extent"];let E=function(e){function v(t,r,n,o){return e.call(this,t,r,n,o)||this}t._inheritsLoose(v,e);var E=v.prototype;return E.doLoad=async function(){},E.destroy=function(){e.prototype.destroy.call(this),this._context.stage.remove(this._material),this._material=null},E.createGraphics3DGraphic=function(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,C,this.symbolLayer.type))return null;const r=this.setGraphicElevationContext(t,new g.ElevationContext);return this.ensureDrapedStatus("on-the-ground"===r.mode),this.ensureMaterial(),this.draped?this._createAsOverlay(t):this._createAs3DShape(t,r,t.uid)},E.ensureMaterial=function(){if(r.isSome(this._material))return;const e={...b.defaultWaterMaterialParameters},t=this.symbolLayer.color;r.isSome(t)&&(e.color=n.toUnitRGBA(t));const o=this._getCombinedOpacity(t,{hasIntrinsicColor:!0});e.color=[e.color[0],e.color[1],e.color[2],o],e.transparent=o<1||this.needsDrivenTransparentPass,e.waveDirection=r.isSome(this.symbolLayer.waveDirection)?v.headingVectorFromAngle(this.symbolLayer.waveDirection):l.fromValues(0,0);const a=this.symbolLayer.waveStrength+"-"+this.symbolLayer.waterbodySize,i=b.wavePresets[a];e.waveStrength=i.waveStrength,e.waveTextureRepeat=i.textureRepeat,e.waveVelocity=i.waveVelocity,e.flowStrength=i.perturbationStrength,e.slicePlaneEnabled=this._context.slicePlaneEnabled,e.isDraped=this.draped,this._material=new S.WaterMaterial(e),this._context.stage.add(this._material)},E.layerOpacityChanged=function(){if(r.isNone(this._material))return!0;const e=this._material.params.color,t=this._getCombinedOpacity(this.symbolLayer.color,{hasIntrinsicColor:!0}),n=t<1||this.needsDrivenTransparentPass;return this._material.setParameterValues({color:[e[0],e[1],e[2],t],transparent:n}),!0},E.layerElevationInfoChanged=function(e,t,r){const n=this._elevationContext.mode,o=m.elevationModeChangeUpdateType(v.elevationModeChangeTypes,r,n);if(o!==m.SymbolUpdateType.UPDATE)return o;const a=m.needsElevationUpdates2D(n);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>a))},E.slicePlaneEnabledChanged=function(){return r.isSome(this._material)&&this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0},E.physicalBasedRenderingChanged=function(){return!0},E.pixelRatioChanged=function(){return!0},E._createAs3DShape=function(e,t,n){const o=_.geometryAsPolygon(e.geometry);if(r.isNone(o))return null;P.renderData=_.geometryToRenderInfo(o,this._context.elevationProvider,this._context.renderCoordsHelper,t);const a=P.renderData.position.length/3;if(P.uvCoords=new Float64Array(2*a),P.outNum=0,P.outGeometries=[],P.outTransforms=[],P.outMaterials=[],this._create3DShapeGeometries(P),this._logGeometryCreationWarnings(P.renderData,o.rings,"rings","WaterSymbol3DLayer"),0===P.outNum)return null;this._createUVCoordsFromVertices(P.uvCoords,P.renderData.mapPosition,a,this._context.elevationProvider.spatialReference);const i=new p.Object3D({geometries:P.outGeometries,materials:P.outMaterials,transformations:P.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:n}}),s=y.perVertexElevationAligner,l=new f(this,i,P.outGeometries,null,null,s,t);return l.alignedSampledElevation=P.renderData.sampledElevation,l.needsElevationUpdates=m.needsElevationUpdates2D(t.mode),l},E._createUVCoordsFromVertices=function(e,t,r,n){const o=a.getMetersPerUnitForSR(n);i.empty(G);for(let a=0;a<r;a++)c.set(T,t[3*a+0],t[3*a+1]),i.expandPointInPlace(G,T);h.scale(G,G,o);const s=G[0]%v.unitSizeOfTexture,l=G[1]%v.unitSizeOfTexture;w[0]=G[0]-s,w[1]=G[1]-l;for(let a=0;a<r;a++)e[2*a+0]=(t[3*a+0]*o-w[0])/v.unitSizeOfTexture,e[2*a+1]=(t[3*a+1]*o-w[1])/v.unitSizeOfTexture},E._create3DShapeGeometries=function(e){const t=e.renderData.polygons,n=e.uvCoords;for(const{count:o,index:a,position:i,mapPosition:l,holeIndices:c}of t){if(r.isSome(this._context.clippingExtent)&&(d.empty(A),d.expandWithBuffer(A,l),!d.intersectsClippingArea(A,this._context.clippingExtent)))continue;const t=u.earcut(l,c,3);if(0===t.length)continue;const h=new Uint32Array(t),p=new Float64Array(n.buffer,2*a*n.BYTES_PER_ELEMENT,2*o),m=_.createWaterGeometry({indices:h,attributeData:{position:i,uv0:p,mapPosition:l}});e.outGeometries.push(m),e.outMaterials.push(r.unwrap(this._material)),e.outTransforms.push(s.IDENTITY),e.outNum++}},E._createAsOverlay=function(e){const t=_.geometryAsPolygon(e.geometry);if(r.isNone(t))return null;r.unwrap(this._material).renderPriority=this._renderPriority,U.renderData=_.geometryToRenderInfoDraped(t,this._context.overlaySR);const n=U.renderData.position.length/3;return U.uvCoords=new Float64Array(2*n),U.outNum=0,U.outGeometries=[],U.outBoundingBox=d.empty(),U.layerUid=this._context.layer.uid,U.graphicsUid=e.uid,this._createAsOverlayWater(U),this._logGeometryCreationWarnings(U.renderData,t.rings,"rings","WaterSymbol3DLayer"),0===U.outNum?null:(this._createUVCoordsFromVertices(U.uvCoords,U.renderData.position,n,this._context.overlaySR),U.outNum>0?new D(this,U.outGeometries,U.outBoundingBox):null)},E._createAsOverlayWater=function(e){const t=e.uvCoords,n=e.renderData.polygons;for(const{position:o,holeIndices:a,index:i,count:s}of n){if(d.empty(A),d.expandWithBuffer(A,o),!d.intersectsClippingArea(A,this._context.clippingExtent))continue;d.expandWithAABB(e.outBoundingBox,A);const n=u.earcut(o,a,3);if(0===n.length)continue;const l=new Uint32Array(n),c=new Float64Array(t.buffer,2*i*t.BYTES_PER_ELEMENT,2*s),p=_.createWaterGeometry({indices:l,attributeData:{position:o,uv0:c}}),m=new x.RenderGeometry(p,r.unwrap(this._material),e.layerUid,e.graphicsUid),y=A;h.set(m.boundingSphere,.5*(y[0]+y[3]),.5*(y[1]+y[4]),0,.5*Math.sqrt((y[3]-y[0])*(y[3]-y[0])+(y[4]-y[1])*(y[4]-y[1]))),e.outGeometries.push(m),e.outNum++}},v.headingVectorFromAngle=function(e){const t=l.create(),r=o.toRadian(e);return t[0]=Math.sin(r),t[1]=Math.cos(r),t},t._createClass(v,[{key:"test",get:function(){return{create3DShape:e=>this._createAs3DShape(e.graphic,e.elevationContext,e.graphicUid),ensureMaterial:()=>this.ensureMaterial()}}}]),v}(v.Graphics3DSymbolLayer);E.unitSizeOfTexture=100,E.elevationModeChangeTypes={definedChanged:m.SymbolUpdateType.RECREATE,staysOnTheGround:m.SymbolUpdateType.NONE,onTheGroundChanged:m.SymbolUpdateType.RECREATE};const w=l.create(),G=i.create(),T=l.create(),A=d.create(),P={renderData:null,uvCoords:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},U={renderData:null,uvCoords:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null};e.Graphics3DWaterSymbolLayer=E,e.default=E,Object.defineProperty(e,"__esModule",{value:!0})}));
