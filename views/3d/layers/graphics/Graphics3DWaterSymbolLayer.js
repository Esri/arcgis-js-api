/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../Color","../../../../chunks/common","../../../../core/unitUtils","../../../../geometry/support/aaBoundingRect","../../../../chunks/mat4f64","../../../../chunks/vec2f64","../../../../core/libs/earcut/earcut","../../../../chunks/vec2","../../../../chunks/vec4","../../../../geometry/support/aaBoundingBox","../../webgl-engine/lib/Object3D","./elevationAlignmentUtils","./ElevationAligners","./ElevationContext","./Graphics3DObject3DGraphicLayer","../../webgl-engine/lib/Geometry","./Graphics3DSymbolLayer","./polygonUtils","./Graphics3DDrapedGraphicLayer","../../webgl-engine/lib/RenderGeometry","../../webgl-engine/materials/internal/waterMaterialUtils","../../webgl-engine/materials/WaterMaterial"],(function(e,t,r,n,a,i,o,s,l,u,c,d,h,p,m,y,g,f,v,_,D,x,b,S,C){"use strict";let E=function(e){function _(t,r,n,a){return e.call(this,t,r,n,a)||this}t._inheritsLoose(_,e);var E=_.prototype;return E.doLoad=async function(){},E.destroy=function(){e.prototype.destroy.call(this),r.isSome(this._material)&&(this._context.stage.remove(3,this._material.id),this._material=null)},E.createGraphics3DGraphic=function(e){const t=e.graphic;if(!this._validateGeometryType(t.geometry,_.validGeometryTypes,this.symbolLayer.type))return null;if(!this._validateGeometry(t.geometry))return null;const r="graphic"+t.uid,n=this.setGraphicElevationContext(t,new g.ElevationContext);return this.ensureDrapedStatus("on-the-ground"===n.mode),this.ensureMaterial(),this.draped?this._createAsOverlay(t,r):this._createAs3DShape(t,n,r,t.uid)},E.ensureMaterial=function(){if(r.isSome(this._material))return;const e={...S.defaultWaterMaterialParameters},t=this.symbolLayer.color;r.isSome(t)&&(e.color=n.toUnitRGBA(t));const a=this._getCombinedOpacity(t,{hasIntrinsicColor:!0});e.color=[e.color[0],e.color[1],e.color[2],a],e.transparent=a<1||this.needsDrivenTransparentPass,e.waveDirection=r.isSome(this.symbolLayer.waveDirection)?_.headingVectorFromAngle(this.symbolLayer.waveDirection):l.fromValues(0,0);const i=this.symbolLayer.waveStrength+"-"+this.symbolLayer.waterbodySize,o=S.wavePresets[i];e.waveStrength=o.waveStrength,e.waveTextureRepeat=o.textureRepeat,e.waveVelocity=o.waveVelocity,e.flowStrength=o.perturbationStrength,e.slicePlaneEnabled=this._context.slicePlaneEnabled,e.isDraped=this.draped,this._material=new C.WaterMaterial(e,"water"),this._context.stage.add(3,this._material)},E.layerOpacityChanged=function(){if(r.isNone(this._material))return!0;const e=this._material.params.color,t=this._getCombinedOpacity(this.symbolLayer.color,{hasIntrinsicColor:!0}),n=t<1||this.needsDrivenTransparentPass;return this._material.setParameterValues({color:[e[0],e[1],e[2],t],transparent:n}),!0},E.layerElevationInfoChanged=function(e,t,r){const n=this._elevationContext.mode,a=m.elevationModeChangeUpdateType(_.elevationModeChangeTypes,r,n);if(a!==m.SymbolUpdateType.UPDATE)return a;const i=m.needsElevationUpdates2D(n);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>i))},E.slicePlaneEnabledChanged=function(){return r.isSome(this._material)&&this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0},E.physicalBasedRenderingChanged=function(){return!0},E.pixelRatioChanged=function(){return!0},E._createAs3DShape=function(e,t,n,a){const i=D.geometryAsPolygon(e.geometry);if(r.isNone(i))return null;A.renderData=D.geometryToRenderInfo(i,this._context.elevationProvider,this._context.renderCoordsHelper,t);const o=A.renderData.position.length/3;if(A.uvCoords=new Float64Array(2*o),A.idHint=n,A.outNum=0,A.outGeometries=[],A.outTransforms=[],A.outMaterials=[],this._create3DShapeGeometries(A),this._logGeometryCreationWarnings(A.renderData,i.rings,"rings","WaterSymbol3DLayer"),0===A.outNum)return null;this._createUVCoordsFromVertices(A.uvCoords,A.renderData.mapPosition,o,this._context.elevationProvider.spatialReference);const s=new p({geometries:A.outGeometries,materials:A.outMaterials,transformations:A.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:a},idHint:n}),l=y.perVertexElevationAligner,u=new f(this,s,A.outGeometries,null,null,l,t);return u.alignedSampledElevation=A.renderData.sampledElevation,u.needsElevationUpdates=m.needsElevationUpdates2D(t.mode),u},E._createUVCoordsFromVertices=function(e,t,r,n){const a=i.getMetersPerUnitForSR(n);o.empty(G);for(let e=0;e<r;e++)c.set(T,t[3*e+0],t[3*e+1]),o.expandPointInPlace(G,T);d.scale(G,G,a);const s=G[0]%_.unitSizeOfTexture,l=G[1]%_.unitSizeOfTexture;w[0]=G[0]-s,w[1]=G[1]-l;for(let n=0;n<r;n++)e[2*n+0]=(t[3*n+0]*a-w[0])/_.unitSizeOfTexture,e[2*n+1]=(t[3*n+1]*a-w[1])/_.unitSizeOfTexture},E._create3DShapeGeometries=function(e){const t=e.renderData.polygons,n=e.uvCoords;for(const{count:a,index:i,position:o,mapPosition:l,holeIndices:c}of t){if(r.isSome(this._context.clippingExtent)&&(h.empty(U),h.expandWithBuffer(U,l),!h.intersectsClippingArea(U,this._context.clippingExtent)))continue;const t=u.earcut(l,c,3);if(0===t.length)continue;const d=new Uint32Array(t),p=new Float64Array(n.buffer,2*i*n.BYTES_PER_ELEMENT,2*a),m=D.createWaterGeometryData({indices:d,attributeData:{position:o,uv0:p,mapPosition:l}}),y=new v(m,e.idHint);e.outGeometries.push(y),e.outMaterials.push(r.unwrap(this._material)),e.outTransforms.push(s.IDENTITY),e.outNum++}},E._createAsOverlay=function(e,t){const n=D.geometryAsPolygon(e.geometry);if(r.isNone(n))return null;r.unwrap(this._material).renderPriority=this._renderPriority,P.renderData=D.geometryToRenderInfoDraped(n,this._context.overlaySR),P.idHint=t;const a=P.renderData.position.length/3;return P.uvCoords=new Float64Array(2*a),P.outNum=0,P.outGeometries=[],P.outBoundingBox=h.empty(),P.layerUid=this._context.layer.uid,P.graphicsUid=e.uid,this._createAsOverlayWater(P),this._logGeometryCreationWarnings(P.renderData,n.rings,"rings","WaterSymbol3DLayer"),0===P.outNum?null:(this._createUVCoordsFromVertices(P.uvCoords,P.renderData.position,a,this._context.overlaySR),P.outNum>0?new x(this,P.outGeometries,P.outBoundingBox):null)},E._createAsOverlayWater=function(e){const t=e.uvCoords,n=e.renderData.polygons;for(const{position:a,holeIndices:i,index:o,count:s}of n){if(h.empty(U),h.expandWithBuffer(U,a),!h.intersectsClippingArea(U,this._context.clippingExtent))continue;h.expandWithAABB(e.outBoundingBox,U);const n=u.earcut(a,i,3);if(0===n.length)continue;const l=new Uint32Array(n),c=new Float64Array(t.buffer,2*o*t.BYTES_PER_ELEMENT,2*s),d=D.createWaterGeometryData({indices:l,attributeData:{position:a,uv0:c}}),p=new b(d);p.data.layerUid=e.layerUid,p.data.graphicUid=e.graphicsUid,p.material=r.unwrap(this._material);const m=U;p.center=[.5*(m[0]+m[3]),.5*(m[1]+m[4]),0],p.bsRadius=.5*Math.sqrt((m[3]-m[0])*(m[3]-m[0])+(m[4]-m[1])*(m[4]-m[1])),e.outGeometries.push(p),e.outNum++}},_.headingVectorFromAngle=function(e){const t=l.create(),r=a.toRadian(e);return t[0]=Math.sin(r),t[1]=Math.cos(r),t},t._createClass(_,[{key:"test",get:function(){return{create3DShape:e=>this._createAs3DShape(e.graphic,e.elevationContext,e.idHint,e.graphicUid),ensureMaterial:()=>this.ensureMaterial()}}}]),_}(_.Graphics3DSymbolLayer);E.validGeometryTypes=["polyline","polygon","extent"],E.unitSizeOfTexture=100,E.elevationModeChangeTypes={definedChanged:m.SymbolUpdateType.RECREATE,staysOnTheGround:m.SymbolUpdateType.NONE,onTheGroundChanged:m.SymbolUpdateType.RECREATE};const w=l.create(),G=o.create(),T=l.create(),U=h.create(),A={idHint:null,renderData:null,uvCoords:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},P={idHint:null,renderData:null,uvCoords:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null};e.Graphics3DWaterSymbolLayer=E,e.default=E,Object.defineProperty(e,"__esModule",{value:!0})}));
