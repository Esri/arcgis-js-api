/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../Color","../../../../core/maybe","../../../../core/unitUtils","../../../../chunks/earcut","../../../../chunks/mat4f64","../../../../chunks/vec2","../../../../chunks/vec2f64","../../../../chunks/vec4","../../../../chunks/common","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","./ElevationAligners","./elevationAlignmentUtils","./ElevationContext","./Graphics3DDrapedGraphicLayer","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolLayer","./polygonUtils","../../support/renderInfoUtils/polygon","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/RenderGeometry","../../webgl-engine/materials/WaterMaterial","../../webgl-engine/materials/internal/waterMaterialUtils"],(function(e,t,r,n,o,i,a,s,l,c,u,h,p,d,y,m,g,f,v,_,S,x,D,b,C){"use strict";const E=["polyline","polygon","extent"];let w=function(e){function v(t,r,n,o){return e.call(this,t,r,n,o)||this}t._inheritsLoose(v,e);var w=v.prototype;return w.doLoad=function(){var e=t._asyncToGenerator((function*(){}));function r(){return e.apply(this,arguments)}return r}(),w.destroy=function(){e.prototype.destroy.call(this),this._context.stage.remove(this._material),this._material=null},w.createGraphics3DGraphic=function(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,E,this.symbolLayer.type))return null;const r=this.setGraphicElevationContext(t,new m.ElevationContext);return this.ensureDrapedStatus("on-the-ground"===r.mode),this.ensureMaterial(),this.draped?this._createAsOverlay(t):this._createAs3DShape(t,r,t.uid)},w.ensureMaterial=function(){if(n.isSome(this._material))return;const e=new b.WaterMaterialParameters,t=this.symbolLayer.color;n.isSome(t)&&(e.color=r.toUnitRGBA(t));const o=this._getCombinedOpacity(t,{hasIntrinsicColor:!0});e.color=[e.color[0],e.color[1],e.color[2],o],e.transparent=o<1||this.needsDrivenTransparentPass,e.waveDirection=n.isSome(this.symbolLayer.waveDirection)?v.headingVectorFromAngle(this.symbolLayer.waveDirection):l.fromValues(0,0);const i=this.symbolLayer.waveStrength+"-"+this.symbolLayer.waterbodySize,a=C.wavePresets[i];e.waveStrength=a.waveStrength,e.waveTextureRepeat=a.textureRepeat,e.waveVelocity=a.waveVelocity,e.flowStrength=a.perturbationStrength,e.hasSlicePlane=this._context.slicePlaneEnabled,e.isDraped=this.draped,this._material=new b.WaterMaterial(e),this._context.stage.add(this._material)},w.layerOpacityChanged=function(){if(n.isNone(this._material))return;const e=this._material.parameters.color,t=this._getCombinedOpacity(this.symbolLayer.color,{hasIntrinsicColor:!0}),r=t<1||this.needsDrivenTransparentPass;this._material.setParameters({color:[e[0],e[1],e[2],t],transparent:r})},w.layerElevationInfoChanged=function(e,t,r){const n=this._elevationContext.mode,o=y.elevationModeChangeUpdateType(v.elevationModeChangeTypes,r,n);if(o!==y.SymbolUpdateType.UPDATE)return o;const i=y.needsElevationUpdates2D(n);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>i))},w.slicePlaneEnabledChanged=function(){return n.isSome(this._material)&&this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0},w.physicalBasedRenderingChanged=function(){return!0},w.pixelRatioChanged=function(){return!0},w._createAs3DShape=function(e,t,r){const o=_.geometryAsPolygon(e.geometry);if(n.isNone(o))return null;const i=S.geometryToRenderInfo(o,this._context.elevationProvider,this._context.renderCoordsHelper,t),a=i.position.length/3,s=new Float64Array(2*a),l=new U(i,s);if(this._create3DShapeGeometries(l),this._logGeometryCreationWarnings(l.renderData,o.rings,"rings","WaterSymbol3DLayer"),0===l.outGeometries.length)return null;this._createUVCoordsFromVertices(l.uvCoords,l.renderData.mapPosition,a,this._context.elevationProvider.spatialReference);const c=new x.Object3D({geometries:l.outGeometries,materials:l.outMaterials,transformations:l.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:r}}),u=new f.Graphics3DObject3DGraphicLayer(this,c,l.outGeometries,null,null,d.perVertexElevationAligner,t);return u.alignedSampledElevation=l.renderData.sampledElevation,u.needsElevationUpdates=y.needsElevationUpdates2D(t.mode),u},w._createUVCoordsFromVertices=function(e,t,r,n){const i=o.getMetersPerUnitForSR(n);p.empty(T);for(let o=0;o<r;o++)s.set(P,t[3*o+0],t[3*o+1]),p.expandPointInPlace(T,P);c.scale(T,T,i);const a=T[0]%v.unitSizeOfTexture,l=T[1]%v.unitSizeOfTexture;G[0]=T[0]-a,G[1]=T[1]-l;for(let o=0;o<r;o++)e[2*o+0]=(t[3*o+0]*i-G[0])/v.unitSizeOfTexture,e[2*o+1]=(t[3*o+1]*i-G[1])/v.unitSizeOfTexture},w._create3DShapeGeometries=function(e){const t=e.renderData.polygons,r=e.uvCoords;for(const{count:o,index:s,position:l,mapPosition:c,holeIndices:u}of t){if(n.isSome(this._context.clippingExtent)&&(h.empty(A),h.expandWithBuffer(A,c),!h.intersectsClippingArea(A,this._context.clippingExtent)))continue;const t=i.earcut(c,u,3);if(0===t.length)continue;const p=new Float64Array(r.buffer,2*s*r.BYTES_PER_ELEMENT,2*o),d=_.createWaterGeometry({indices:t,attributeData:{position:l,uv0:p,mapPosition:c}});e.outGeometries.push(d),e.outMaterials.push(n.unwrap(this._material)),e.outTransforms.push(a.IDENTITY)}},w._createAsOverlay=function(e){const t=_.geometryAsPolygon(e.geometry);if(n.isNone(t))return null;n.unwrap(this._material).renderPriority=this._renderPriority;const r=S.geometryToRenderInfoDraped(t,this._context.overlaySR),o=r.position.length/3,i=new Float64Array(2*o),a=new R(r,i,this._context.layer.uid,e.uid);return a.outBoundingBox=h.empty(),this._createAsOverlayWater(a),this._logGeometryCreationWarnings(a.renderData,t.rings,"rings","WaterSymbol3DLayer"),0===a.outGeometries.length?null:(this._createUVCoordsFromVertices(a.uvCoords,a.renderData.position,o,this._context.overlaySR),new g(this,a.outGeometries,a.outBoundingBox,this._context.drapeSourceRenderer))},w._createAsOverlayWater=function(e){const t=e.uvCoords,r=e.renderData.polygons;for(const{position:o,holeIndices:a,index:s,count:l}of r){if(h.empty(A),h.expandWithBuffer(A,o),!h.intersectsClippingArea(A,this._context.clippingExtent))continue;h.expandWithAABB(e.outBoundingBox,A);const r=i.earcut(o,a,3);if(0===r.length)continue;const u=new Float64Array(t.buffer,2*s*t.BYTES_PER_ELEMENT,2*l),p=_.createWaterGeometry({indices:r,attributeData:{position:o,uv0:u}}),d=new D.RenderGeometry(p,n.unwrap(this._material),{layerUid:e.layerUid,graphicUid:e.graphicsUid}),y=A;c.set(d.boundingSphere,.5*(y[0]+y[3]),.5*(y[1]+y[4]),0,.5*Math.sqrt((y[3]-y[0])*(y[3]-y[0])+(y[4]-y[1])*(y[4]-y[1]))),e.outGeometries.push(d)}},v.headingVectorFromAngle=function(e){const t=l.create(),r=u.toRadian(e);return t[0]=Math.sin(r),t[1]=Math.cos(r),t},w.test=function(){return{...e.prototype.test.call(this),create3DShape:e=>this._createAs3DShape(e.graphic,e.elevationContext,e.graphicUid),ensureMaterial:()=>this.ensureMaterial()}},v}(v.Graphics3DSymbolLayer);w.unitSizeOfTexture=100,w.elevationModeChangeTypes={definedChanged:y.SymbolUpdateType.RECREATE,staysOnTheGround:y.SymbolUpdateType.NONE,onTheGroundChanged:y.SymbolUpdateType.RECREATE};const G=l.create(),T=p.create(),P=l.create(),A=h.create();let U=function(e){function r(t,r){var n;return(n=e.call(this,t,null,null)||this).uvCoords=r,n}return t._inheritsLoose(r,e),r}(_.PolygonCreationDataBase),R=function(e){function r(t,r,n,o){var i;return(i=e.call(this,t,n,o)||this).uvCoords=r,i}return t._inheritsLoose(r,e),r}(_.PolygonCreationDataBase);e.Graphics3DWaterSymbolLayer=w,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
