/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Handles","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/accessorSupport/decorators/subclass","../../../../geometry/ellipsoidUtils","../../support/FrustumExtentIntersection","../../../support/Scheduler"],(function(e,t,i,s,n,r,o,a,c,u,l,h,p){"use strict";const d=1.2;let _=function(t){function i(e){var i;return(i=t.call(this,e)||this).suspended=!1,i._extent=null,i._extentIntersectionDirty=!0,i._isVisibleBelowSurfaceInternal=!1,i._handles=new s,i.graphicsCoreOwner=null,i.updating=!0,i}e._inheritsLoose(i,t);var o=i.prototype;return o.initialize=function(){const{graphicsCoreOwner:e}=this;this._extentIntersection=new h.FrustumExtentIntersection({renderCoordsHelper:e.view.renderCoordsHelper});const t=e.view,i=t.basemapTerrain,s=t.resourceController.scheduler;this._handles.add([t.on("resize",(()=>this._viewChange())),r.watch((()=>t.state.camera),(()=>this._viewChange()),r.sync),s.registerTask(p.TaskPriority.FRUSTUM_VISIBILITY,this),r.watch((()=>i.visibleElevationBounds),(()=>this._elevationBoundsChange()))]),"local"===t.viewingMode?this._isVisibleBelowSurface=!0:this._handles.add([r.watch((()=>[i.baseOpacity,i.wireframe,t.map?.ground?.navigationConstraint?.type]),(()=>this._updateIsVisibleBelowSurface()),r.initial)])},o.destroy=function(){this._set("graphicsCoreOwner",null),this._extent=null,this._extentIntersection=null,this._handles=n.destroyMaybe(this._handles)},o._setDirty=function(){this.updating||this._set("updating",!0)},o.setExtent=function(e){this._extent=e,this._extentIntersectionDirty=!0,this._setDirty()},o._viewChange=function(){this._setDirty()},o._elevationBoundsChange=function(){this._setDirty(),this._extentIntersectionDirty=!0},o._updateIsVisibleBelowSurface=function(){const e=this.graphicsCoreOwner.view,t=e.basemapTerrain,i="local"===e.viewingMode,s="none"===e.map.ground?.navigationConstraint?.type;this._isVisibleBelowSurface=i||!t.opaque||s},o._updateExtentIntersection=function(){if(!this._extentIntersectionDirty)return;this._extentIntersectionDirty=!1;const e=this.graphicsCoreOwner.view;let t;if(this._isVisibleBelowSurfaceInternal)t=-.3*l.getReferenceEllipsoid(e.spatialReference).radius;else{const{min:i,max:s}=e.basemapTerrain.visibleElevationBounds;t=i-Math.max(1,(s-i)*(d-1))}this._extentIntersection.update(this._extent,e.spatialReference,t)},o.runTask=function(e){if(this._set("updating",!1),!this._extent)return this._set("suspended",!1),p.Task.YIELD;this._updateExtentIntersection();const t=this.graphicsCoreOwner.view.frustum,i=l.getReferenceEllipsoid(this.graphicsCoreOwner.view.spatialReference).radius;this._set("suspended",!this._extentIntersection.isVisibleInFrustum(t,i)),e.madeProgress()},e._createClass(i,[{key:"_isVisibleBelowSurface",set:function(e){this._isVisibleBelowSurfaceInternal=e,this._setDirty(),this._extentIntersectionDirty=!0}},{key:"running",get:function(){return this.updating}}]),i}(i);t.__decorate([o.property({readOnly:!0})],_.prototype,"suspended",void 0),t.__decorate([o.property({constructOnly:!0})],_.prototype,"graphicsCoreOwner",void 0),t.__decorate([o.property({readOnly:!0})],_.prototype,"updating",void 0),_=t.__decorate([u.subclass("esri.views.3d.layers.graphics.Graphics3DFrustumVisibility")],_);return _}));
