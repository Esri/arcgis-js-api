/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/has","../../../../core/Logger","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/decorators/subclass","../../../../core/urlUtils","../../../../core/uuid","../../../../portal/support/resourceExtension","../../../../core/Accessor","../../../../core/Handles","../../../../core/watchUtils","../../../../geometry/projectionEllipsoid","../../../support/Scheduler","../../support/FrustumExtentIntersection"],(function(e,t,i,s,n,r,o,a,u,c,l,p,h,d,y,f){"use strict";let w=function(t){function i(){var e;return(e=t.apply(this,arguments)||this).suspended=!1,e.extent=null,e.extentIntersectionDirty=!0,e._isVisibleBelowSurface=!1,e.handles=new p,e.layerView=null,e.updating=!0,e}e._inheritsLoose(i,t);var s=i.prototype;return s.setup=function(e){this.layerView=e,this.extentIntersection=new f.FrustumExtentIntersection({renderCoordsHelper:e.view.renderCoordsHelper});const t=e.view,i=t.basemapTerrain,s=t.resourceController.scheduler;this.handles.add([t.on("resize",(()=>this.viewChange())),t.state.watch("camera",(()=>this.viewChange()),!0),s.registerTask(y.Task.FRUSTUM_VISIBILITY,(()=>this.update()),(()=>this.updating)),i.on("elevation-bounds-change",(()=>this.elevationBoundsChange()))]),"local"===t.viewingMode?this.isVisibleBelowSurface=!0:this.handles.add([h.init(i,["opacity","wireframe"],(()=>this.updateIsVisibleBelowSurface())),h.init(t,"map.ground.navigationConstraint.type",(()=>this.updateIsVisibleBelowSurface()))])},s.destroy=function(){this.layerView=null,this.extent=null,this.extentIntersection=null,this.handles&&(this.handles.destroy(),this.handles=null)},s._setDirty=function(){this.updating||this._set("updating",!0)},s.setExtent=function(e){this.extent=e,this.extentIntersectionDirty=!0,this._setDirty()},s.viewChange=function(){this._setDirty()},s.elevationBoundsChange=function(){this._setDirty(),this.extentIntersectionDirty=!0},s.updateIsVisibleBelowSurface=function(){const e=this.layerView.view,t=e.basemapTerrain,i="local"===e.viewingMode,s=e.map.ground&&e.map.ground.navigationConstraint&&"none"===e.map.ground.navigationConstraint.type;this.isVisibleBelowSurface=i||!t.isOpaque()||s},s.updateExtentIntersection=function(){if(!this.extentIntersectionDirty)return;this.extentIntersectionDirty=!1;const e=this.layerView.view;let t;if(this._isVisibleBelowSurface)t=-.3*d.getReferenceEllipsoid(e.spatialReference).radius;else{const{min:i,max:s}=e.basemapTerrain.elevationBounds;t=i-Math.max(1,(s-i)*(1.2-1))}this.extentIntersection.update(this.extent,e.spatialReference,t)},s.update=function(){if(this._set("updating",!1),!this.extent)return void this._set("suspended",!1);this.updateExtentIntersection();const e=this.layerView.view.frustum,t=d.getReferenceEllipsoid(this.layerView.view.spatialReference).radius;this._set("suspended",!this.extentIntersection.isVisibleInFrustum(e,t))},e._createClass(i,[{key:"isVisibleBelowSurface",set:function(e){this._isVisibleBelowSurface=e,this._setDirty(),this.extentIntersectionDirty=!0}}]),i}(l);return t.__decorate([r.property({readOnly:!0})],w.prototype,"suspended",void 0),t.__decorate([r.property({readOnly:!0})],w.prototype,"updating",void 0),w=t.__decorate([o.subclass("esri.views.3d.layers.graphics.Graphics3DFrustumVisibility")],w),w}));
