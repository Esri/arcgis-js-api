// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../core/Error","../../../../core/maybe","../../../../core/libs/earcut/earcut","../../../../core/libs/gl-matrix-2/mat3","../../../../core/libs/gl-matrix-2/mat3f64","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../geometry/support/aaBoundingBox","../../../../layers/graphics/dehydratedFeatures","../../../../renderers/support/renderingInfoUtils","./elevationAlignmentUtils","./elevationAlignmentUtils","./ElevationContext","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolLayer","./graphicUtils","./polygonUtils","../support/edgeUtils","../../support/projectionUtils","../../support/buffer/BufferView","../../support/buffer/math/vec3","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryData","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/Util","../../webgl-engine/materials/DefaultMaterial"],(function(e,t,r,a,n,i,o,s,l,c,p,h,d,u,f,y,m,v,g,_,b,E,x,A,P,S,w,C,L,T,M){Object.defineProperty(t,"__esModule",{value:!0});var O=function(e){function t(t,r,a,n){var i=e.call(this,t,r,a,n)||this;return i.ensureDrapedStatus(!1),i}return r.__extends(t,e),t.prototype.doLoad=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t,i,o,s,l;return r.__generator(this,(function(r){if(!this._drivenProperties.size&&(e=b.validateSymbolLayerSize(this._getSymbolSize())))throw new a("graphics3dextrudesymbollayer:invalid-size",e);return t=n.get(this.symbolLayer,"material","color"),i=this._getCombinedOpacityAndColor(t),o=h.vec3f64.fromArray(i),s=i[3],l={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:o,ambient:o,opacity:s,transparent:s<1||this.needsDrivenTransparentPass,vertexColors:!0,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!0},this._material=new M(l,this._getIdHint("_3dlinemat")),this._context.stage.add(3,this._material),[2]}))}))},t.prototype.destroy=function(){e.prototype.destroy.call(this),this._material&&this._context.stage.remove(3,this._material.id)},t.prototype.createGraphics3DGraphic=function(e){var r=e.graphic;if(!this._validateGeometryType(r.geometry,t.validGeometryTypes,this.symbolLayer.type))return null;if(!this._validateGeometry(r.geometry))return null;var a="graphic"+r.uid,n=this._getVertexOpacityAndColor(e.renderingInfo,Float32Array,255),i=this.setGraphicElevationContext(r,new v.ElevationContext);return this._createAs3DShape(r,e.renderingInfo,n,i,a,r.uid)},t.prototype.layerOpacityChanged=function(e,t){var r=this,a=n.get(this.symbolLayer,"material","color"),i=this._getCombinedOpacity(a),o=i<1||this.needsDrivenTransparentPass;this._material.setParameterValues({opacity:i,transparent:o});var s=this._getLayerOpacity();return e.forEach((function(e){var a=t(e);n.isSome(a)&&a.layerOpacityChanged(s,r._context.isAsync)})),!0},t.prototype.layerElevationInfoChanged=function(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,m.needsElevationUpdates3D)},t.prototype.slicePlaneEnabledChanged=function(e,t){var r=this;return this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),e.forEach((function(e){var a=t(e);n.isSome(a)&&a.slicePlaneEnabledChanged(r._context.slicePlaneEnabled,r._context.isAsync)})),!0},t.prototype.physicalBasedRenderingChanged=function(){return this._material.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0},t.prototype.pixelRatioChanged=function(){return!0},t.prototype._getExtrusionSize=function(e){var t,r;return r=e.size&&this._drivenProperties.size?null!==(t=f.getDriverAxisSizeValue(e.size,2))&&void 0!==t?t:0:this._getSymbolSize(),r/=this._context.renderCoordsHelper.unitInMeters},t.prototype._getSymbolSize=function(){var e;return null!==(e=this.symbolLayer.size)&&void 0!==e?e:1},t.prototype._createAs3DShape=function(e,t,r,a,p,u){var f=E.geometryAsPolygon(e.geometry);if(n.isNone(f))return null;var y=new Array,v=new Array,_=new Array,x=d.create(),C="global"===this._context.renderCoordsHelper.type,T=this._getExtrusionSize(t),M=h.vec3f64.create();C||this._context.renderCoordsHelper.worldUpAtPosition(null,M);var O=E.geometryToRenderInfo(f,this._context.elevationProvider,this._context.renderCoordsHelper,a);if(this._logGeometryCreationWarnings(O,f.rings,"rings","ExtrudeSymbol3DLayer"),0===f.rings.length||!f.rings.some((function(e){return e.length>0})))return null;var z=b.computeCentroid(f);if(n.isNone(z))return null;var B=c.mat4f64.create();A.computeLinearTransformation(f.spatialReference,[z.x,z.y,0],B,this._context.renderCoordsHelper.spatialReference);var I=c.mat4f64.create();l.mat4.invert(I,B);var V=s.mat3f64.create();o.mat3.normalFromMat4(V,I);for(var G=O.polygons,R=O.mapPosition,U=O.position,N=U.length/3,F=new Float64Array(3*N*6),j=new Float64Array(3*N*6),Y=new Float64Array(3*N*6),k=new Float64Array(1*N*6),W=0,Z=0;Z<G.length;++Z){var q=G[Z],J=q.count;if(!this._context.clippingExtent||(d.empty(x),d.expandWithBuffer(x,q.mapPosition),d.intersectsClippingArea(x,this._context.clippingExtent))){var K=i.earcut(q.mapPosition,q.holeIndices,3);if(0!==K.length){var Q=3*J*2+2*K.length,X=new Uint32Array(Q),$=6*J,ee=3*F.BYTES_PER_ELEMENT,te=new P.BufferViewVec3f64(F.buffer,W*ee,ee,(W+$)*ee),re=3*j.BYTES_PER_ELEMENT,ae=new P.BufferViewVec3f64(j.buffer,W*re,re,(W+$)*re),ne=new Float64Array(Y.buffer,3*W*Y.BYTES_PER_ELEMENT,3*$),ie=new Float64Array(k.buffer,1*W*k.BYTES_PER_ELEMENT,1*$);D(U,R,K,q,te.typedBuffer,ne,ae.typedBuffer,ie,0,X,0,T,M,C),S.transformMat4(te,te,I),S.transformMat3(ae,ae,V),W+=6*J;var oe=this._createExtrudeGeometry(X,{positions:te.typedBuffer,elevation:ne,normals:ae.typedBuffer,heights:ie},r),se=new w(oe,p+"path"+Z);y.push(se),v.push(this._material),_.push(c.mat4f64.IDENTITY)}}}if(0===y.length)return null;var le=new L({geometries:y,materials:v,transformations:_,castShadow:!0,metadata:{layerUid:this._context.layer.uid,graphicUid:u,isElevationSource:!0},idHint:p});le.objectTransformation=B;var ce=H,pe=this._createEdgeMaterial(),he=n.isSome(pe)?{baseMaterial:this._material,edgeMaterials:[pe],slicePlaneEnabled:this._context.slicePlaneEnabled}:null,de=new g(this,le,y,null,null,ce,a,he);return de.alignedSampledElevation=O.sampledElevation,de.needsElevationUpdates=m.needsElevationUpdates3D(a.mode),de},t.prototype._createExtrudeGeometry=function(e,t,r){for(var a=e.length,n=e,i=new Uint32Array(a),o=0;o<a;o++)i[o]=0;var s={},l={};return s[T.VertexAttrConstants.POSITION]=n,s[T.VertexAttrConstants.NORMAL]=n,s[T.VertexAttrConstants.COLOR]=i,l[T.VertexAttrConstants.POSITION]={size:3,data:t.positions},l[T.VertexAttrConstants.NORMAL]={size:3,data:t.normals},l[T.VertexAttrConstants.COLOR]={size:4,data:r},l[T.VertexAttrConstants.SIZE]={size:1,data:t.heights},t.elevation&&(l.mapPos={size:3,data:t.elevation},s.mapPos=n),new C.GeometryData(l,s)},t.prototype._createEdgeMaterial=function(){var e={opacity:this._getLayerOpacity()};return x.createMaterial(this.symbolLayer,e)},t.validGeometryTypes=["polygon","extent"],t}(_.default);function D(e,t,r,a,n,i,o,s,l,c,h,d,u,f){var y=r.length/3,m=0;h+=2*a.count,function(e,t,r,a,n,i,o,s,l,c,h,d,u,f,y,m,v){p.vec3.copy(k,m);for(var g=y>0?1:-1,_=3*r,b=d,E=3*b,x=d+a,A=3*x,P=0;P<a;++P)v&&(k[0]=e[_+0],k[1]=e[_+1],k[2]=e[_+2],p.vec3.normalize(k,k)),s[E+0]=e[_+0],s[E+1]=e[_+1],s[E+2]=e[_+2],l[E+0]=t[_+0],l[E+1]=t[_+1],l[E+2]=t[_+2],c[E+0]=-g*k[0],c[E+1]=-g*k[1],c[E+2]=-g*k[2],h[b]=0,s[A+0]=e[_+0]+y*k[0],s[A+1]=e[_+1]+y*k[1],s[A+2]=e[_+2]+y*k[2],l[A+0]=t[_+0],l[A+1]=t[_+1],l[A+2]=t[_+2],c[A+0]=g*k[0],c[A+1]=g*k[1],c[A+2]=g*k[2],h[x]=y,E+=3,A+=3,_+=3,b+=1,x+=1;_=3*i,E=3*f,A=3*(f+o),E=3*(f+o),A=3*f;var S=W,w=Z;y<0&&(S=Z,w=W);for(P=0;P<o;++P)u[E+0]=n[_+S[0]],u[E+1]=n[_+S[1]],u[E+2]=n[_+S[2]],u[A+0]=n[_+w[0]]+a,u[A+1]=n[_+w[1]]+a,u[A+2]=n[_+w[2]]+a,E+=3,A+=3,_+=3}(e,t,a.index,a.count,r,0,y,n,i,o,s,l,c,h,d,u,f),l+=2*a.count,h+=2*y,h-=2*a.count+2*y,I(n,i,s,o,m,a.pathLengths[0],a.count,l,c,h,d),l+=4*a.pathLengths[0],h+=2*a.pathLengths[0],m+=a.pathLengths[0];for(var v=1;v<a.pathLengths.length;++v)I(n,i,s,o,m,a.pathLengths[v],a.count,l,c,h,d),l+=4*a.pathLengths[v],h+=2*a.pathLengths[v],m+=a.pathLengths[v]}function z(e,t,r,a,n,i,o){a[i]=a[o],o*=3,e[(i*=3)+0]=e[o+0],e[i+1]=e[o+1],e[i+2]=e[o+2],t[i+0]=t[o+0],t[i+1]=t[o+1],t[i+2]=t[o+2],r[i+0]=n[0],r[i+1]=n[1],r[i+2]=n[2]}t.Graphics3DExtrudeSymbolLayer=O;var B=h.vec3f64.create();function I(e,t,r,a,n,i,o,s,l,c,p){var h=n,d=n+1,u=n+o,f=n+o+1,y=s,m=s+1,v=s+2*i,g=s+2*i+1;p<0&&(h=n+o+1,f=n),c*=3;for(var _=0;_<i;++_)_===i-1&&(p>0?(d=n,f=n+o):(d=n,h=n+o)),F(e,h,d,u,B),z(e,t,a,r,B,y,h),z(e,t,a,r,B,m,d),z(e,t,a,r,B,v,u),z(e,t,a,r,B,g,f),l[c++]=y,l[c++]=v,l[c++]=g,l[c++]=y,l[c++]=g,l[c++]=m,h++,d++,u++,f++,y+=2,m+=2,v+=2,g+=2}var V=h.vec3f64.create(),G=h.vec3f64.create(),R=h.vec3f64.create(),U=h.vec3f64.create(),N=h.vec3f64.create();function F(e,t,r,a,n){t*=3,r*=3,a*=3,p.vec3.set(V,e[t++],e[t++],e[t++]),p.vec3.set(G,e[r++],e[r++],e[r++]),p.vec3.set(R,e[a++],e[a++],e[a++]),p.vec3.subtract(U,G,V),p.vec3.subtract(N,R,V),p.vec3.cross(n,N,U),p.vec3.normalize(n,n)}var j=h.vec3f64.create();function H(e,t,r,a){var n=e.stageObject;q.spatialReference=r.spatialReference;for(var i=n.geometryRecords,o=i.length,s="absolute-height"!==t.mode,h=0,d=n.objectTransformation,u=l.mat4.invert(c.mat4f64.create(),d),f=0;f<o;f++){var m=i[f].geometry;m.invalidateBoundingInfo();for(var v=m.data.getVertexAttr(),g=v[T.VertexAttrConstants.POSITION].data,_=v[T.VertexAttrConstants.SIZE].data,b=v.mapPos.data,E=g.length/3,x=0,A=0,P=!1,S=0,w=0;w<E;w++){q.x=b[A],q.y=b[A+1],q.z=b[A+2],j[0]=g[x],j[1]=g[x+1],j[2]=g[x+2];var C=y.evaluateElevationAlignmentAtPoint(q,r,t,a,s?J:null);s&&(S+=J.sampledElevation),p.vec3.set(Y,g[x+0],g[x+1],g[x+2]),p.vec3.transformMat4(Y,Y,d),a.setAltitude(C+_[x/3],Y),p.vec3.transformMat4(Y,Y,u),g[x]=Y[0],g[x+1]=Y[1],g[x+2]=Y[2];var L=.01/a.unitInMeters;(Math.abs(j[0]-g[x])>L||Math.abs(j[1]-g[x+1])>L||Math.abs(j[2]-g[x+2])>L)&&(P=!0),A+=3,x+=3}P&&n.geometryVertexAttrsUpdated(f),h+=S/E}return h/o}var Y=h.vec3f64.create(),k=h.vec3f64.create(),W=[0,2,1],Z=[0,1,2],q=u.makeDehydratedPoint(0,0,0,null),J={verticalDistanceToGround:0,sampledElevation:0};t.default=O}));