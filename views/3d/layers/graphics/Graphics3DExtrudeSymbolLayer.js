/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/has","../../../../core/Error","../../../../core/lang","../../../../core/maybe","../../../../core/unitUtils","../../../../chunks/earcut","../../../../chunks/mat3","../../../../chunks/mat3f64","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/projection","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/buffer/BufferView","../../../../chunks/vec32","../../../../layers/graphics/data/SnappingCandidate","../../../../renderers/support/renderingInfoUtils","../../../ViewingMode","./elevationAlignmentUtils","./ElevationContext","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolLayer","./graphicUtils","./interfaces","./polygonUtils","../support/edgeUtils","../../support/debugFlags","../../support/ElevationProvider","../../support/renderInfoUtils/polygon","../../webgl-engine/lib/Attribute","../../webgl-engine/lib/basicInterfaces","../../webgl-engine/lib/ContentObjectType","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryWithMapPositions","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/VertexAttribute","../../webgl-engine/materials/DefaultMaterial"],(function(e,t,n,r,i,a,s,o,l,c,h,u,d,p,g,f,y,m,b,_,x,E,S,A,P,v,w,M,C,L,O,I,R,B,D,T,V,z,G,U){"use strict";const k=["polygon","extent"];let F=function(e){function n(t,n,r,i){var a;return(a=e.call(this,t,n,r,i)||this).ensureDrapedStatus(!1),a}t._inheritsLoose(n,e);var d=n.prototype;return d.doLoad=function(){var e=t._asyncToGenerator((function*(){if(!this._drivenProperties.size){const e=v.validateSymbolLayerSize(this._getSymbolSize());if(e)throw new r("graphics3dextrudesymbollayer:invalid-size",e)}const e=a.get(this.symbolLayer,"material","color"),t=this._getCombinedOpacityAndColor(e),n=p.fromArray(t),i=t[3],s=i<1||this.needsDrivenTransparentPass,o={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:n,ambient:n,opacity:i,transparent:s,cullFace:s?B.CullFaceOptions.None:B.CullFaceOptions.Back,hasVertexColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!0};this._material=new U.DefaultMaterial(o),this._bottomMaterial=new U.DefaultMaterial({...o,cullFace:B.CullFaceOptions.Back}),this._context.stage.add(this._material),this._context.stage.add(this._bottomMaterial)}));function n(){return e.apply(this,arguments)}return n}(),d.destroy=function(){e.prototype.destroy.call(this),this._material&&(this._context.stage.remove(this._material),this._context.stage.remove(this._bottomMaterial))},d.createGraphics3DGraphic=function(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,k,this.symbolLayer.type))return null;const n=this._getVertexOpacityAndColor(e.renderingInfo,255),r=this.setGraphicElevationContext(t,new S.ElevationContext);return this._createAs3DShape(t,e.renderingInfo,n,r,t.uid)},d.layerOpacityChanged=function(e,t){const n=a.get(this.symbolLayer,"material","color"),r=this._getCombinedOpacity(n),i=r<1||this.needsDrivenTransparentPass;this._material.setParameters({opacity:r,transparent:i}),this._bottomMaterial.setParameters({opacity:r,transparent:i});const s=this._getLayerOpacity();e.forEach((e=>{const n=t(e);a.isSome(n)&&n.layerOpacityChanged(s,this._context.isAsync)}))},d.layerElevationInfoChanged=function(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,E.needsElevationUpdates3D)},d.slicePlaneEnabledChanged=function(e,t){return this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),this._bottomMaterial.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),e.forEach((e=>{const n=t(e);a.isSome(n)&&n.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)})),!0},d.physicalBasedRenderingChanged=function(){return this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._bottomMaterial.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0},d.pixelRatioChanged=function(){return!0},d.skipHighSymbolLodsChanged=function(){return!0},d._getExtrusionSize=function(e){let t;return t=e.size&&this._drivenProperties.size?_.getDriverAxisSizeValue(e.size,2)??0:this._getSymbolSize(),t/=this._context.renderCoordsHelper.unitInMeters,t},d.applyRendererDiff=function(e,t){return this._drivenPropertiesChanged(t)?w.ApplyRendererDiffResult.Recreate_Symbol:w.ApplyRendererDiffResult.Recreate_Graphics},d.queryForSnapping=function(){var e=t._asyncToGenerator((function*(e,t,n,r){const a=this._getExtrusionSize(n)*this._context.renderCoordsHelper.unitInMeters/s.getMetersPerVerticalUnitForSR(t),{objectId:o,target:l}=e,c=i.clone(l);switch(c.z=(c.z??0)+a,e.type){case"edge":{const{start:t,end:n}=e,r=i.clone(t),s=i.clone(n);return r.z=(r.z??0)+a,s.z=(s.z??0)+a,[b.makeEdgeCandidate(o,c,1/0,r,s)]}case"vertex":return[b.makeVertexCandidate(o,c,1/0),b.makeEdgeCandidate(o,l,1/0,l,c)];default:return[]}}));function n(t,n,r,i){return e.apply(this,arguments)}return n}(),d._getSymbolSize=function(){return this.symbolLayer.size??1},d._createAs3DShape=function(e,t,n,r,i){const s=M.geometryAsPolygon(e.geometry);if(a.isNone(s))return null;if(0===s.rings.length||!s.rings.some((e=>e.length>0)))return this._logGeometryValidationWarnings(s.rings,"rings","ExtrudeSymbol3DLayer"),null;const d=I.geometryToRenderInfo(s,this._context.elevationProvider,this._context.renderCoordsHelper,r);this._logGeometryCreationWarnings(d,s.rings,"rings","ExtrudeSymbol3DLayer");const b=v.computeCentroid(s);if(a.isNone(b))return null;const _=new Array,S=f.create(),P=u.create(),w=p.create(),L=this._context.renderCoordsHelper.viewingMode===x.ViewingMode.Global;L||this._context.renderCoordsHelper.worldUpAtPosition(null,w),g.computeTranslationToOriginAndRotation(s.spatialReference,[b.x,b.y,0],P,this._context.renderCoordsHelper.spatialReference);const O=u.create();h.invert(O,P);const R=c.create();l.normalFromMat4(R,O);const{polygons:B,mapPositions:D,position:T}=d,V=T.length/3,G=new Float64Array(3*V*6),U=new Float64Array(3*V*6),k=new Float64Array(3*V*6),F=new Float64Array(1*V*6);let H=0;for(let a=0;a<B.length;++a){const e=B[a],r=e.count;if(this._context.clippingExtent&&(f.empty(S),f.expandWithBuffer(S,e.mapPositions),!f.intersectsClippingArea(S,this._context.clippingExtent)))continue;const s=o.earcut(e.mapPositions,e.holeIndices,3);if(0===s.length)continue;const l=3*r*2+s.length,c=new Array(l),h=new Array(s.length),u=6*r,d=3*G.BYTES_PER_ELEMENT,p=new y.BufferViewVec3f64(G.buffer,H*d,d,(H+u)*d),g=3*U.BYTES_PER_ELEMENT,b=new y.BufferViewVec3f64(U.buffer,H*g,g,(H+u)*g),x=new Float64Array(k.buffer,3*H*k.BYTES_PER_ELEMENT,3*u),E=new Float64Array(F.buffer,1*H*F.BYTES_PER_ELEMENT,1*u),A=this._getExtrusionSize(t);j(T,D,s,e,p.typedBuffer,x,b.typedBuffer,E,c,h,A,w,L),m.transformMat4(p,p,O),m.transformMat3(b,b,R),H+=6*r;const P=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:i,layerUid:this._context.layer.uid}),v=new le(p.typedBuffer,x,b.typedBuffer,E);_.push(N(this._material,c,c.length-h.length,v,n,P)),_.push(N(this._bottomMaterial,h,0,v,n,P))}if(0===_.length)return null;const W=new z.Object3D({geometries:_,metadata:{layerUid:this._context.layer.uid,graphicUid:i,isElevationSource:!0}});W.transformation=P;const Y=C.createMaterial(this.symbolLayer,{opacity:this._getLayerOpacity()}),Z=a.isSome(Y)?{baseMaterial:this._material,edgeMaterials:[Y],properties:{mergeGeometries:!0,hasSlicePlane:this._context.slicePlaneEnabled}}:null,q=new A.Graphics3DObject3DGraphicLayer(this,W,_,null,null,te,r,Z);return q.alignedSampledElevation=d.sampledElevation,q.needsElevationUpdates=E.needsElevationUpdates3D(r.mode),q},n}(P.Graphics3DSymbolLayer);function N(e,t,n,r,i,a){const s=new Array(t.length).fill(0),o=[[G.VertexAttribute.POSITION,new R.Attribute(r.positions,3,!0)],[G.VertexAttribute.NORMAL,new R.Attribute(r.normals,3,!0)],[G.VertexAttribute.COLOR,new R.Attribute(i,4,!0)],[G.VertexAttribute.SIZE,new R.Attribute(r.heights,1,!0)]],l=[[G.VertexAttribute.POSITION,t],[G.VertexAttribute.NORMAL,t],[G.VertexAttribute.COLOR,s]];return new T.Geometry(e,o,l,r.elevation,D.ContentObjectType.Mesh,a,n)}function j(e,t,n,r,i,a,s,o,l,c,h,u,d){const p=n.length/3;let g=0,f=2*r.count;H(e,t,r.index,r.count,n,0,p,i,a,s,o,l,c,f,h,u,d);let y=2*r.count;f=0,Z(i,a,o,s,g,r.pathLengths[0],r.count,y,l,f,h),y+=4*r.pathLengths[0],f+=2*r.pathLengths[0],g+=r.pathLengths[0];for(let m=1;m<r.pathLengths.length;++m)Z(i,a,o,s,g,r.pathLengths[m],r.count,y,l,f,h),y+=4*r.pathLengths[m],f+=2*r.pathLengths[m],g+=r.pathLengths[m]}function H(e,t,n,r,i,a,s,o,l,c,h,u,p,g,f,y,m){d.copy(re,y);const b=f>0?1:-1;let _=3*n,x=0,E=3*x,S=r,A=3*S;for(let w=0;w<r;++w)m&&(re[0]=e[_+0],re[1]=e[_+1],re[2]=e[_+2],d.normalize(re,re)),o[E+0]=e[_+0],o[E+1]=e[_+1],o[E+2]=e[_+2],l[E+0]=t[_+0],l[E+1]=t[_+1],l[E+2]=t[_+2],c[E+0]=-b*re[0],c[E+1]=-b*re[1],c[E+2]=-b*re[2],h[x]=0,o[A+0]=e[_+0]+f*re[0],o[A+1]=e[_+1]+f*re[1],o[A+2]=e[_+2]+f*re[2],l[A+0]=t[_+0],l[A+1]=t[_+1],l[A+2]=t[_+2],c[A+0]=b*re[0],c[A+1]=b*re[1],c[A+2]=b*re[2],h[S]=f,E+=3,A+=3,_+=3,x+=1,S+=1;_=3*a,E=0,A=3*g;const P=f<0?se:ae,v=f<0?ae:se;for(let d=0;d<s;++d)p[E+0]=i[_+P[0]],p[E+1]=i[_+P[1]],p[E+2]=i[_+P[2]],u[A+0]=i[_+v[0]]+r,u[A+1]=i[_+v[1]]+r,u[A+2]=i[_+v[2]]+r,E+=3,A+=3,_+=3}function W(e,t,n,r,i,a,s){r[a]=r[s],s*=3,e[(a*=3)+0]=e[s+0],e[a+1]=e[s+1],e[a+2]=e[s+2],t[a+0]=t[s+0],t[a+1]=t[s+1],t[a+2]=t[s+2],n[a+0]=i[0],n[a+1]=i[1],n[a+2]=i[2]}const Y=p.create();function Z(e,t,n,r,i,a,s,o,l,c,h){let u=i,d=i+1,p=i+s,g=i+s+1,f=o,y=o+1,m=o+2*a,b=o+2*a+1;h<0&&(u=i+s+1,g=i),c*=3;for(let _=0;_<a;++_)_===a-1&&(h>0?(d=i,g=i+s):(d=i,u=i+s)),$(e,u,d,p,Y),W(e,t,r,n,Y,f,u),W(e,t,r,n,Y,y,d),W(e,t,r,n,Y,m,p),W(e,t,r,n,Y,b,g),l[c++]=f,l[c++]=m,l[c++]=b,l[c++]=f,l[c++]=b,l[c++]=y,u++,d++,p++,g++,f+=2,y+=2,m+=2,b+=2}const q=p.create(),J=p.create(),K=p.create(),Q=p.create(),X=p.create();function $(e,t,n,r,i){t*=3,n*=3,r*=3,d.set(q,e[t++],e[t++],e[t++]),d.set(J,e[n++],e[n++],e[n++]),d.set(K,e[r++],e[r++],e[r++]),d.subtract(Q,J,q),d.subtract(X,K,q),d.cross(i,X,Q),d.normalize(i,i)}const ee=p.create();function te(e,t,n,r,i){const s=e.stageObject,o=s.geometries,l=o.length,c="absolute-height"!==t.mode;let p=0;const g=s.transformation,f=h.invertOrIdentity(u.create(),g);for(let h=0;h<l;h+=2){const e=o[h];if(!V.isGeometryWithMapPositions(e))continue;const t=e.getMutableAttribute(G.VertexAttribute.POSITION).data,l=e.vertexAttributes.get(G.VertexAttribute.SIZE).data,u=new O.SamplePosition(e.mapPositions),y=t.length/3;let m=0,b=!1,_=0;for(let s=0;s<y;s++){ee[0]=t[m],ee[1]=t[m+1],ee[2]=t[m+2],r(u,ie),c&&(_+=ie.sampledElevation),L.TESTS_DISABLE_OPTIMIZATIONS?(d.set(ne,u.array[u.offset+0],u.array[u.offset+1],ie.z+l[m/3]),a.isSome(n)&&i.toRenderCoords(ne,n,ne),d.transformMat4(ne,ne,f)):(d.set(ne,t[m+0],t[m+1],t[m+2]),d.transformMat4(ne,ne,g),i.setAltitude(ne,ie.z+l[m/3]),d.transformMat4(ne,ne,f)),t[m]=ne[0],t[m+1]=ne[1],t[m+2]=ne[2];const e=oe/i.unitInMeters;(Math.abs(ee[0]-t[m])>=e||Math.abs(ee[1]-t[m+1])>=e||Math.abs(ee[2]-t[m+2])>=e)&&(b=!0),u.offset+=3,m+=3}b&&(e.invalidateBoundingInfo(),s.geometryVertexAttrsUpdated(o[h]),o[h+1].invalidateBoundingInfo(),s.geometryVertexAttrsUpdated(o[h+1])),p+=_/y}return p/l}const ne=p.create(),re=p.create(),ie=new E.SampleElevationInfo,ae=[0,2,1],se=[0,1,2],oe=.01;let le=function(e,t,n,r){this.positions=e,this.elevation=t,this.normals=n,this.heights=r};e.Graphics3DExtrudeSymbolLayer=F,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
