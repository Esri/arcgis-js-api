/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/Error","../../../../chunks/vec3f64","../../../../chunks/vec3","../../../../chunks/mat4","../../../../geometry/projection","../../../../chunks/mat3f64","../../../../chunks/mat4f64","../../../../core/libs/earcut/earcut","../../../../chunks/mat3","../../support/buffer/BufferView","../../../../chunks/vec32","../../../../geometry/support/aaBoundingBox","../../support/ElevationProvider","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/Object3D","../../support/debugFlags","./graphicUtils","./elevationAlignmentUtils","./ElevationContext","./Graphics3DObject3DGraphicLayer","../support/edgeUtils","./Graphics3DSymbolLayer","../../../../renderers/support/renderingInfoUtils","./polygonUtils","../../webgl-engine/materials/DefaultMaterial"],(function(e,t,n,a,r,i,s,o,l,c,h,u,d,p,m,f,g,y,_,E,b,v,x,P,A,S,w,L){"use strict";const M=["polygon","extent"];let B=function(e){function i(t,n,a,r){var i;return(i=e.call(this,t,n,a,r)||this).ensureDrapedStatus(!1),i}t._inheritsLoose(i,e);var f=i.prototype;return f.doLoad=async function(){if(!this._drivenProperties.size){const e=E.validateSymbolLayerSize(this._getSymbolSize());if(e)throw new a("graphics3dextrudesymbollayer:invalid-size",e)}const e=n.get(this.symbolLayer,"material","color"),t=this._getCombinedOpacityAndColor(e),i=r.fromArray(t),s=t[3],o={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:i,ambient:i,opacity:s,transparent:s<1||this.needsDrivenTransparentPass,vertexColors:!0,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!0};this._material=new L.DefaultMaterial(o),this._bottomMaterial=new L.DefaultMaterial({...o,cullFace:2}),this._context.stage.add(this._material),this._context.stage.add(this._bottomMaterial)},f.destroy=function(){e.prototype.destroy.call(this),this._material&&(this._context.stage.remove(this._material),this._context.stage.remove(this._bottomMaterial))},f.createGraphics3DGraphic=function(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,M,this.symbolLayer.type))return null;const n=this._getVertexOpacityAndColor(e.renderingInfo,255),a=this.setGraphicElevationContext(t,new v.ElevationContext);return this._createAs3DShape(t,e.renderingInfo,n,a,t.uid)},f.layerOpacityChanged=function(e,t){const a=n.get(this.symbolLayer,"material","color"),r=this._getCombinedOpacity(a),i=r<1||this.needsDrivenTransparentPass;this._material.setParameterValues({opacity:r,transparent:i}),this._bottomMaterial.setParameterValues({opacity:r,transparent:i});const s=this._getLayerOpacity();return e.forEach((e=>{const a=t(e);n.isSome(a)&&a.layerOpacityChanged(s,this._context.isAsync)})),!0},f.layerElevationInfoChanged=function(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,b.needsElevationUpdates3D)},f.slicePlaneEnabledChanged=function(e,t){return this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),this._bottomMaterial.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),e.forEach((e=>{const a=t(e);n.isSome(a)&&a.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)})),!0},f.physicalBasedRenderingChanged=function(){return this._material.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._bottomMaterial.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0},f.pixelRatioChanged=function(){return!0},f._getExtrusionSize=function(e){let t;var n;e.size&&this._drivenProperties.size?t=null!=(n=S.getDriverAxisSizeValue(e.size,2))?n:0:t=this._getSymbolSize();return t/=this._context.renderCoordsHelper.unitInMeters,t},f._getSymbolSize=function(){var e;return null!=(e=this.symbolLayer.size)?e:1},f._createAs3DShape=function(e,t,a,i,f){const g=w.geometryAsPolygon(e.geometry);if(n.isNone(g))return null;const _=w.geometryToRenderInfo(g,this._context.elevationProvider,this._context.renderCoordsHelper,i);if(this._logGeometryCreationWarnings(_,g.rings,"rings","ExtrudeSymbol3DLayer"),0===g.rings.length||!g.rings.some((e=>e.length>0)))return null;const v=E.computeCentroid(g);if(n.isNone(v))return null;const A=new Array,S=new Array,L=new Array,M=m.create(),B=c.create(),C=r.create(),z=1===this._context.renderCoordsHelper.viewingMode;z||this._context.renderCoordsHelper.worldUpAtPosition(null,C),o.computeLinearTransformation(g.spatialReference,[v.x,v.y,0],B,this._context.renderCoordsHelper.spatialReference);const T=c.create();s.invert(T,B);const G=l.create();u.normalFromMat4(G,T);const{polygons:I,mapPosition:R,position:U}=_,V=U.length/3,O=new Float64Array(3*V*6),N=new Float64Array(3*V*6),k=new Float64Array(3*V*6),j=new Float64Array(1*V*6);let H=0;for(let n=0;n<I.length;++n){const e=I[n],r=e.count;if(this._context.clippingExtent&&(m.empty(M),m.expandWithBuffer(M,e.mapPosition),!m.intersectsClippingArea(M,this._context.clippingExtent)))continue;const i=h.earcut(e.mapPosition,e.holeIndices,3);if(0===i.length)continue;const s=3*r*2+i.length,o=new Uint32Array(s),l=new Uint32Array(i.length),u=6*r,f=3*O.BYTES_PER_ELEMENT,g=new d.BufferViewVec3f64(O.buffer,H*f,f,(H+u)*f),y=3*N.BYTES_PER_ELEMENT,_=new d.BufferViewVec3f64(N.buffer,H*y,y,(H+u)*y),E=new Float64Array(k.buffer,3*H*k.BYTES_PER_ELEMENT,3*u),b=new Float64Array(j.buffer,1*H*j.BYTES_PER_ELEMENT,1*u),v=this._getExtrusionSize(t);D(U,R,i,e,g.typedBuffer,E,_.typedBuffer,b,0,o,l,v,C,z),p.transformMat4(g,g,T),p.transformMat3(_,_,G),H+=6*r;const x=this._createExtrudeGeometry(o,o.length-l.length,{positions:g.typedBuffer,elevation:E,normals:_.typedBuffer,heights:b},a);A.push(x),S.push(this._material),L.push(c.IDENTITY);const P=this._createExtrudeGeometry(l,0,{positions:g.typedBuffer,elevation:E,normals:_.typedBuffer,heights:b},a);A.push(P),S.push(this._bottomMaterial),L.push(c.IDENTITY)}if(0===A.length)return null;const Y=new y.Object3D({geometries:A,materials:S,transformations:L,metadata:{layerUid:this._context.layer.uid,graphicUid:f,isElevationSource:!0}});Y.transformation=B;const W=F,q=P.createMaterial(this.symbolLayer,{opacity:this._getLayerOpacity()}),J=n.isSome(q)?{baseMaterial:this._material,edgeMaterials:[q],properties:{mergeGeometries:!0,slicePlaneEnabled:this._context.slicePlaneEnabled}}:null,K=new x(this,Y,A,null,null,W,i,J);return K.alignedSampledElevation=_.sampledElevation,K.needsElevationUpdates=b.needsElevationUpdates3D(i.mode),K},f._createExtrudeGeometry=function(e,t,n,a){const r=new Uint32Array(e.length),i=[["position",{size:3,data:n.positions,exclusive:!0}],["normal",{size:3,data:n.normals,exclusive:!0}],["color",{size:4,data:a,exclusive:!0}],["size",{size:1,data:n.heights,exclusive:!0}]],s=[["position",e],["normal",e],["color",r]];return n.elevation&&(i.push(["mapPos",{size:3,data:n.elevation}]),s.push(["mapPos",e])),new g.Geometry(i,s,0,t)},i}(A.Graphics3DSymbolLayer);function D(e,t,n,a,r,i,s,o,l,c,h,u,d,p){const m=n.length/3;let f=0,g=2*a.count;C(e,t,a.index,a.count,n,0,m,r,i,s,o,l,c,h,g,u,d,p),l+=2*a.count,g=0,G(r,i,o,s,f,a.pathLengths[0],a.count,l,c,g,u),l+=4*a.pathLengths[0],g+=2*a.pathLengths[0],f+=a.pathLengths[0];for(let y=1;y<a.pathLengths.length;++y)G(r,i,o,s,f,a.pathLengths[y],a.count,l,c,g,u),l+=4*a.pathLengths[y],g+=2*a.pathLengths[y],f+=a.pathLengths[y]}function C(e,t,n,a,r,s,o,l,c,h,u,d,p,m,f,g,y,_){i.copy(H,y);const E=g>0?1:-1;let b=3*n,v=d,x=3*v,P=d+a,A=3*P;for(let L=0;L<a;++L)_&&(H[0]=e[b+0],H[1]=e[b+1],H[2]=e[b+2],i.normalize(H,H)),l[x+0]=e[b+0],l[x+1]=e[b+1],l[x+2]=e[b+2],c[x+0]=t[b+0],c[x+1]=t[b+1],c[x+2]=t[b+2],h[x+0]=-E*H[0],h[x+1]=-E*H[1],h[x+2]=-E*H[2],u[v]=0,l[A+0]=e[b+0]+g*H[0],l[A+1]=e[b+1]+g*H[1],l[A+2]=e[b+2]+g*H[2],c[A+0]=t[b+0],c[A+1]=t[b+1],c[A+2]=t[b+2],h[A+0]=E*H[0],h[A+1]=E*H[1],h[A+2]=E*H[2],u[P]=g,x+=3,A+=3,b+=3,v+=1,P+=1;b=3*s,x=0,A=3*f;const S=g<0?W:Y,w=g<0?Y:W;for(let i=0;i<o;++i)m[x+0]=r[b+S[0]],m[x+1]=r[b+S[1]],m[x+2]=r[b+S[2]],p[A+0]=r[b+w[0]]+a,p[A+1]=r[b+w[1]]+a,p[A+2]=r[b+w[2]]+a,x+=3,A+=3,b+=3}function z(e,t,n,a,r,i,s){a[i]=a[s],s*=3,e[(i*=3)+0]=e[s+0],e[i+1]=e[s+1],e[i+2]=e[s+2],t[i+0]=t[s+0],t[i+1]=t[s+1],t[i+2]=t[s+2],n[i+0]=r[0],n[i+1]=r[1],n[i+2]=r[2]}const T=r.create();function G(e,t,n,a,r,i,s,o,l,c,h){let u=r,d=r+1,p=r+s,m=r+s+1,f=o,g=o+1,y=o+2*i,_=o+2*i+1;h<0&&(u=r+s+1,m=r),c*=3;for(let E=0;E<i;++E)E===i-1&&(h>0?(d=r,m=r+s):(d=r,u=r+s)),N(e,u,d,p,T),z(e,t,a,n,T,f,u),z(e,t,a,n,T,g,d),z(e,t,a,n,T,y,p),z(e,t,a,n,T,_,m),l[c++]=f,l[c++]=y,l[c++]=_,l[c++]=f,l[c++]=_,l[c++]=g,u++,d++,p++,m++,f+=2,g+=2,y+=2,_+=2}const I=r.create(),R=r.create(),U=r.create(),V=r.create(),O=r.create();function N(e,t,n,a,r){t*=3,n*=3,a*=3,i.set(I,e[t++],e[t++],e[t++]),i.set(R,e[n++],e[n++],e[n++]),i.set(U,e[a++],e[a++],e[a++]),i.subtract(V,R,I),i.subtract(O,U,I),i.cross(r,O,V),i.normalize(r,r)}const k=r.create();function F(e,t,n,a){const r=e.stageObject,o=r.geometryRecords,l=o.length,h="absolute-height"!==t.mode;let u=0;const d=r.transformation,p=s.invert(c.create(),d);for(let s=0;s<l;s+=2){const e=o[s].geometry,l=e.getMutableAttribute("position").data,c=e.vertexAttributes.get("size").data,m=e.vertexAttributes.get("mapPos").data,g=new f.SamplePosition(m),y=l.length/3;let E=0,v=!1,x=0;const P=n.spatialReference;for(let r=0;r<y;r++){k[0]=l[E],k[1]=l[E+1],k[2]=l[E+2];const e=b.evaluateElevationAlignmentAtPoint(g,n,t,a,h?J:null);h&&(x+=J.sampledElevation),_.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES?(i.set(j,g.array[g.offset+0],g.array[g.offset+1],e+c[E/3]),a.toRenderCoords(j,P,j),i.transformMat4(j,j,p)):(i.set(j,l[E+0],l[E+1],l[E+2]),i.transformMat4(j,j,d),a.setAltitude(e+c[E/3],j),i.transformMat4(j,j,p)),l[E]=j[0],l[E+1]=j[1],l[E+2]=j[2];const r=q/a.unitInMeters;(Math.abs(k[0]-l[E])>=r||Math.abs(k[1]-l[E+1])>=r||Math.abs(k[2]-l[E+2])>=r)&&(v=!0),g.offset+=3,E+=3}v&&(e.invalidateBoundingInfo(),r.geometryVertexAttrsUpdated(s),o[s+1].geometry.invalidateBoundingInfo(),r.geometryVertexAttrsUpdated(s+1)),u+=x/y}return u/l}const j=r.create(),H=r.create(),Y=[0,2,1],W=[0,1,2],q=.01,J={verticalDistanceToGround:0,sampledElevation:0};e.Graphics3DExtrudeSymbolLayer=B,e.default=B,Object.defineProperty(e,"__esModule",{value:!0})}));
