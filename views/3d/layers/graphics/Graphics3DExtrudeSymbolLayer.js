/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/Error","../../../../core/maybe","../../../../chunks/earcut","../../../../chunks/mat3","../../../../chunks/mat3f64","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/projection","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/buffer/BufferView","../../../../chunks/vec32","../../../../renderers/support/renderingInfoUtils","./elevationAlignmentUtils","./ElevationContext","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolLayer","./graphicUtils","./polygonUtils","../support/edgeUtils","../../support/debugFlags","../../support/ElevationProvider","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/Object3D","../../webgl-engine/materials/DefaultMaterial"],(function(e,t,n,a,r,i,s,o,l,c,h,u,p,d,m,f,g,y,_,E,b,v,x,P,A,S,L,w){"use strict";const M=["polygon","extent"];let B=function(e){function c(t,n,a,r){var i;return(i=e.call(this,t,n,a,r)||this).ensureDrapedStatus(!1),i}t._inheritsLoose(c,e);var E=c.prototype;return E.doLoad=function(){var e=t._asyncToGenerator((function*(){if(!this._drivenProperties.size){const e=b.validateSymbolLayerSize(this._getSymbolSize());if(e)throw new n("graphics3dextrudesymbollayer:invalid-size",e)}const e=a.get(this.symbolLayer,"material","color"),t=this._getCombinedOpacityAndColor(e),r=h.fromArray(t),i=t[3],s=i<1||this.needsDrivenTransparentPass,o={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:r,ambient:r,opacity:i,transparent:s,cullFace:s?0:2,vertexColors:!0,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!0};this._material=new w.DefaultMaterial(o),this._bottomMaterial=new w.DefaultMaterial({...o,cullFace:2}),this._context.stage.add(this._material),this._context.stage.add(this._bottomMaterial)}));function r(){return e.apply(this,arguments)}return r}(),E.destroy=function(){e.prototype.destroy.call(this),this._material&&(this._context.stage.remove(this._material),this._context.stage.remove(this._bottomMaterial))},E.createGraphics3DGraphic=function(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,M,this.symbolLayer.type))return null;const n=this._getVertexOpacityAndColor(e.renderingInfo,255),a=this.setGraphicElevationContext(t,new y.ElevationContext);return this._createAs3DShape(t,e.renderingInfo,n,a,t.uid)},E.layerOpacityChanged=function(e,t){const n=a.get(this.symbolLayer,"material","color"),r=this._getCombinedOpacity(n),i=r<1||this.needsDrivenTransparentPass;this._material.setParameterValues({opacity:r,transparent:i}),this._bottomMaterial.setParameterValues({opacity:r,transparent:i});const s=this._getLayerOpacity();return e.forEach((e=>{const n=t(e);a.isSome(n)&&n.layerOpacityChanged(s,this._context.isAsync)})),!0},E.layerElevationInfoChanged=function(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,g.needsElevationUpdates3D)},E.slicePlaneEnabledChanged=function(e,t){return this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),this._bottomMaterial.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),e.forEach((e=>{const n=t(e);a.isSome(n)&&n.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)})),!0},E.physicalBasedRenderingChanged=function(){return this._material.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._bottomMaterial.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0},E.pixelRatioChanged=function(){return!0},E._getExtrusionSize=function(e){let t;var n;e.size&&this._drivenProperties.size?t=null!=(n=f.getDriverAxisSizeValue(e.size,2))?n:0:t=this._getSymbolSize();return t/=this._context.renderCoordsHelper.unitInMeters,t},E._getSymbolSize=function(){var e;return null!=(e=this.symbolLayer.size)?e:1},E._createAs3DShape=function(e,t,n,c,f){const y=v.geometryAsPolygon(e.geometry);if(a.isNone(y))return null;const E=v.geometryToRenderInfo(y,this._context.elevationProvider,this._context.renderCoordsHelper,c);if(this._logGeometryCreationWarnings(E,y.rings,"rings","ExtrudeSymbol3DLayer"),0===y.rings.length||!y.rings.some((e=>e.length>0)))return null;const P=b.computeCentroid(y);if(a.isNone(P))return null;const A=new Array,S=new Array,w=new Array,M=p.create(),B=l.create(),C=h.create(),G=1===this._context.renderCoordsHelper.viewingMode;G||this._context.renderCoordsHelper.worldUpAtPosition(null,C),u.computeLinearTransformation(y.spatialReference,[P.x,P.y,0],B,this._context.renderCoordsHelper.spatialReference);const T=l.create();o.invert(T,B);const z=s.create();i.normalFromMat4(z,T);const{polygons:I,mapPosition:R,position:U}=E,V=U.length/3,O=new Float64Array(3*V*6),k=new Float64Array(3*V*6),F=new Float64Array(3*V*6),j=new Float64Array(1*V*6);let H=0;for(let a=0;a<I.length;++a){const e=I[a],i=e.count;if(this._context.clippingExtent&&(p.empty(M),p.expandWithBuffer(M,e.mapPosition),!p.intersectsClippingArea(M,this._context.clippingExtent)))continue;const s=r.earcut(e.mapPosition,e.holeIndices,3);if(0===s.length)continue;const o=3*i*2+s.length,c=new Uint32Array(o),h=new Uint32Array(s.length),u=6*i,f=3*O.BYTES_PER_ELEMENT,g=new d.BufferViewVec3f64(O.buffer,H*f,f,(H+u)*f),y=3*k.BYTES_PER_ELEMENT,_=new d.BufferViewVec3f64(k.buffer,H*y,y,(H+u)*y),E=new Float64Array(F.buffer,3*H*F.BYTES_PER_ELEMENT,3*u),b=new Float64Array(j.buffer,1*H*j.BYTES_PER_ELEMENT,1*u),v=this._getExtrusionSize(t);D(U,R,s,e,g.typedBuffer,E,_.typedBuffer,b,0,c,h,v,C,G),m.transformMat4(g,g,T),m.transformMat3(_,_,z),H+=6*i;const x=this._createExtrudeGeometry(c,c.length-h.length,{positions:g.typedBuffer,elevation:E,normals:_.typedBuffer,heights:b},n);A.push(x),S.push(this._material),w.push(l.IDENTITY);const P=this._createExtrudeGeometry(h,0,{positions:g.typedBuffer,elevation:E,normals:_.typedBuffer,heights:b},n);A.push(P),S.push(this._bottomMaterial),w.push(l.IDENTITY)}if(0===A.length)return null;const Y=new L.Object3D({geometries:A,materials:S,transformations:w,metadata:{layerUid:this._context.layer.uid,graphicUid:f,isElevationSource:!0}});Y.transformation=B;const W=N,q=x.createMaterial(this.symbolLayer,{opacity:this._getLayerOpacity()}),J=a.isSome(q)?{baseMaterial:this._material,edgeMaterials:[q],properties:{mergeGeometries:!0,slicePlaneEnabled:this._context.slicePlaneEnabled}}:null,K=new _.Graphics3DObject3DGraphicLayer(this,Y,A,null,null,W,c,J);return K.alignedSampledElevation=E.sampledElevation,K.needsElevationUpdates=g.needsElevationUpdates3D(c.mode),K},E._createExtrudeGeometry=function(e,t,n,a){const r=new Uint32Array(e.length),i=[["position",{size:3,data:n.positions,exclusive:!0}],["normal",{size:3,data:n.normals,exclusive:!0}],["color",{size:4,data:a,exclusive:!0}],["size",{size:1,data:n.heights,exclusive:!0}]],s=[["position",e],["normal",e],["color",r]];return n.elevation&&(i.push(["mapPos",{size:3,data:n.elevation}]),s.push(["mapPos",e])),new S.Geometry(i,s,0,t)},c}(E.Graphics3DSymbolLayer);function D(e,t,n,a,r,i,s,o,l,c,h,u,p,d){const m=n.length/3;let f=0,g=2*a.count;C(e,t,a.index,a.count,n,0,m,r,i,s,o,l,c,h,g,u,p,d),l+=2*a.count,g=0,z(r,i,o,s,f,a.pathLengths[0],a.count,l,c,g,u),l+=4*a.pathLengths[0],g+=2*a.pathLengths[0],f+=a.pathLengths[0];for(let y=1;y<a.pathLengths.length;++y)z(r,i,o,s,f,a.pathLengths[y],a.count,l,c,g,u),l+=4*a.pathLengths[y],g+=2*a.pathLengths[y],f+=a.pathLengths[y]}function C(e,t,n,a,r,i,s,o,l,h,u,p,d,m,f,g,y,_){c.copy(H,y);const E=g>0?1:-1;let b=3*n,v=p,x=3*v,P=p+a,A=3*P;for(let w=0;w<a;++w)_&&(H[0]=e[b+0],H[1]=e[b+1],H[2]=e[b+2],c.normalize(H,H)),o[x+0]=e[b+0],o[x+1]=e[b+1],o[x+2]=e[b+2],l[x+0]=t[b+0],l[x+1]=t[b+1],l[x+2]=t[b+2],h[x+0]=-E*H[0],h[x+1]=-E*H[1],h[x+2]=-E*H[2],u[v]=0,o[A+0]=e[b+0]+g*H[0],o[A+1]=e[b+1]+g*H[1],o[A+2]=e[b+2]+g*H[2],l[A+0]=t[b+0],l[A+1]=t[b+1],l[A+2]=t[b+2],h[A+0]=E*H[0],h[A+1]=E*H[1],h[A+2]=E*H[2],u[P]=g,x+=3,A+=3,b+=3,v+=1,P+=1;b=3*i,x=0,A=3*f;const S=g<0?W:Y,L=g<0?Y:W;for(let c=0;c<s;++c)m[x+0]=r[b+S[0]],m[x+1]=r[b+S[1]],m[x+2]=r[b+S[2]],d[A+0]=r[b+L[0]]+a,d[A+1]=r[b+L[1]]+a,d[A+2]=r[b+L[2]]+a,x+=3,A+=3,b+=3}function G(e,t,n,a,r,i,s){a[i]=a[s],s*=3,e[(i*=3)+0]=e[s+0],e[i+1]=e[s+1],e[i+2]=e[s+2],t[i+0]=t[s+0],t[i+1]=t[s+1],t[i+2]=t[s+2],n[i+0]=r[0],n[i+1]=r[1],n[i+2]=r[2]}const T=h.create();function z(e,t,n,a,r,i,s,o,l,c,h){let u=r,p=r+1,d=r+s,m=r+s+1,f=o,g=o+1,y=o+2*i,_=o+2*i+1;h<0&&(u=r+s+1,m=r),c*=3;for(let E=0;E<i;++E)E===i-1&&(h>0?(p=r,m=r+s):(p=r,u=r+s)),k(e,u,p,d,T),G(e,t,a,n,T,f,u),G(e,t,a,n,T,g,p),G(e,t,a,n,T,y,d),G(e,t,a,n,T,_,m),l[c++]=f,l[c++]=y,l[c++]=_,l[c++]=f,l[c++]=_,l[c++]=g,u++,p++,d++,m++,f+=2,g+=2,y+=2,_+=2}const I=h.create(),R=h.create(),U=h.create(),V=h.create(),O=h.create();function k(e,t,n,a,r){t*=3,n*=3,a*=3,c.set(I,e[t++],e[t++],e[t++]),c.set(R,e[n++],e[n++],e[n++]),c.set(U,e[a++],e[a++],e[a++]),c.subtract(V,R,I),c.subtract(O,U,I),c.cross(r,O,V),c.normalize(r,r)}const F=h.create();function N(e,t,n,a){const r=e.stageObject,i=r.geometryRecords,s=i.length,h="absolute-height"!==t.mode;let u=0;const p=r.transformation,d=o.invert(l.create(),p);for(let o=0;o<s;o+=2){const e=i[o].geometry,s=e.getMutableAttribute("position").data,l=e.vertexAttributes.get("size").data,m=e.vertexAttributes.get("mapPos").data,f=new A.SamplePosition(m),y=s.length/3;let _=0,E=!1,b=0;const v=n.spatialReference;for(let r=0;r<y;r++){F[0]=s[_],F[1]=s[_+1],F[2]=s[_+2];const e=g.evaluateElevationAlignmentAtPoint(f,n,t,a,h?J:null);h&&(b+=J.sampledElevation),P.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES?(c.set(j,f.array[f.offset+0],f.array[f.offset+1],e+l[_/3]),a.toRenderCoords(j,v,j),c.transformMat4(j,j,d)):(c.set(j,s[_+0],s[_+1],s[_+2]),c.transformMat4(j,j,p),a.setAltitude(j,e+l[_/3]),c.transformMat4(j,j,d)),s[_]=j[0],s[_+1]=j[1],s[_+2]=j[2];const r=q/a.unitInMeters;(Math.abs(F[0]-s[_])>=r||Math.abs(F[1]-s[_+1])>=r||Math.abs(F[2]-s[_+2])>=r)&&(E=!0),f.offset+=3,_+=3}E&&(e.invalidateBoundingInfo(),r.geometryVertexAttrsUpdated(o),i[o+1].geometry.invalidateBoundingInfo(),r.geometryVertexAttrsUpdated(o+1)),u+=b/y}return u/s}const j=h.create(),H=h.create(),Y=[0,2,1],W=[0,1,2],q=.01,J={verticalDistanceToGround:0,sampledElevation:0};e.Graphics3DExtrudeSymbolLayer=B,e.default=B,Object.defineProperty(e,"__esModule",{value:!0})}));
