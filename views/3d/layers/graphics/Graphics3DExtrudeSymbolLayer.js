/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/has","../../../../core/Error","../../../../core/lang","../../../../core/maybe","../../../../core/unitUtils","../../../../chunks/earcut","../../../../chunks/mat3","../../../../chunks/mat3f64","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/projection","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/buffer/BufferView","../../../../chunks/vec32","../../../../layers/graphics/data/SnappingCandidate","../../../../renderers/support/renderingInfoUtils","../../../ViewingMode","./elevationAlignmentUtils","./ElevationContext","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolLayer","./graphicUtils","./interfaces","./polygonUtils","../support/edgeUtils","../../support/debugFlags","../../support/ElevationProvider","../../support/renderInfoUtils/polygon","../../webgl-engine/lib/basicInterfaces","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/VertexAttribute","../../webgl-engine/materials/DefaultMaterial"],(function(e,t,n,r,a,i,s,o,l,c,h,u,d,p,g,f,y,m,b,_,x,E,S,v,A,P,M,w,L,C,O,I,R,B,D,T,z){"use strict";const V=["polygon","extent"];let G=function(e){function n(t,n,r,a){var i;return(i=e.call(this,t,n,r,a)||this).ensureDrapedStatus(!1),i}t._inheritsLoose(n,e);var d=n.prototype;return d.doLoad=function(){var e=t._asyncToGenerator((function*(){if(!this._drivenProperties.size){const e=P.validateSymbolLayerSize(this._getSymbolSize());if(e)throw new r("graphics3dextrudesymbollayer:invalid-size",e)}const e=i.get(this.symbolLayer,"material","color"),t=this._getCombinedOpacityAndColor(e),n=p.fromArray(t),a=t[3],s=a<1||this.needsDrivenTransparentPass,o={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:n,ambient:n,opacity:a,transparent:s,cullFace:s?R.CullFaceOptions.None:R.CullFaceOptions.Back,hasVertexColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!0};this._material=new z.DefaultMaterial(o),this._bottomMaterial=new z.DefaultMaterial({...o,cullFace:R.CullFaceOptions.Back}),this._context.stage.add(this._material),this._context.stage.add(this._bottomMaterial)}));function n(){return e.apply(this,arguments)}return n}(),d.destroy=function(){e.prototype.destroy.call(this),this._material&&(this._context.stage.remove(this._material),this._context.stage.remove(this._bottomMaterial))},d.createGraphics3DGraphic=function(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,V,this.symbolLayer.type))return null;const n=this._getVertexOpacityAndColor(e.renderingInfo,255),r=this.setGraphicElevationContext(t,new S.ElevationContext);return this._createAs3DShape(t,e.renderingInfo,n,r,t.uid)},d.layerOpacityChanged=function(e,t){const n=i.get(this.symbolLayer,"material","color"),r=this._getCombinedOpacity(n),a=r<1||this.needsDrivenTransparentPass;this._material.setParameters({opacity:r,transparent:a}),this._bottomMaterial.setParameters({opacity:r,transparent:a});const s=this._getLayerOpacity();e.forEach((e=>{const n=t(e);i.isSome(n)&&n.layerOpacityChanged(s,this._context.isAsync)}))},d.layerElevationInfoChanged=function(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,E.needsElevationUpdates3D)},d.slicePlaneEnabledChanged=function(e,t){return this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),this._bottomMaterial.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),e.forEach((e=>{const n=t(e);i.isSome(n)&&n.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)})),!0},d.physicalBasedRenderingChanged=function(){return this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._bottomMaterial.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0},d.pixelRatioChanged=function(){return!0},d._getExtrusionSize=function(e){let t;return t=e.size&&this._drivenProperties.size?_.getDriverAxisSizeValue(e.size,2)??0:this._getSymbolSize(),t/=this._context.renderCoordsHelper.unitInMeters,t},d.applyRendererDiff=function(e,t){return this._drivenPropertiesChanged(t)?M.ApplyRendererDiffResult.Recreate_Symbol:M.ApplyRendererDiffResult.Recreate_Graphics},d.queryForSnapping=function(){var e=t._asyncToGenerator((function*(e,t,n,r){const i=this._getExtrusionSize(n)*this._context.renderCoordsHelper.unitInMeters/s.getMetersPerVerticalUnitForSR(t),{objectId:o,target:l}=e,c=a.clone(l);switch(c.z=(c.z??0)+i,e.type){case"edge":{const{start:t,end:n}=e,r=a.clone(t),s=a.clone(n);return r.z=(r.z??0)+i,s.z=(s.z??0)+i,[b.makeEdgeCandidate(o,c,1/0,r,s)]}case"vertex":return[b.makeVertexCandidate(o,c,1/0),b.makeEdgeCandidate(o,l,1/0,l,c)];default:return[]}}));function n(t,n,r,a){return e.apply(this,arguments)}return n}(),d._getSymbolSize=function(){return this.symbolLayer.size??1},d._createAs3DShape=function(e,t,n,r,a){const s=w.geometryAsPolygon(e.geometry);if(i.isNone(s))return null;if(0===s.rings.length||!s.rings.some((e=>e.length>0)))return this._logGeometryValidationWarnings(s.rings,"rings","ExtrudeSymbol3DLayer"),null;const d=I.geometryToRenderInfo(s,this._context.elevationProvider,this._context.renderCoordsHelper,r);this._logGeometryCreationWarnings(d,s.rings,"rings","ExtrudeSymbol3DLayer");const b=P.computeCentroid(s);if(i.isNone(b))return null;const _=new Array,S=new Array,A=new Array,M=f.create(),C=u.create(),O=p.create(),R=this._context.renderCoordsHelper.viewingMode===x.ViewingMode.Global;R||this._context.renderCoordsHelper.worldUpAtPosition(null,O),g.computeTranslationToOriginAndRotation(s.spatialReference,[b.x,b.y,0],C,this._context.renderCoordsHelper.spatialReference);const B=u.create();h.invert(B,C);const T=c.create();l.normalFromMat4(T,B);const{polygons:z,mapPosition:V,position:G}=d,F=G.length/3,N=new Float64Array(3*F*6),j=new Float64Array(3*F*6),H=new Float64Array(3*F*6),Y=new Float64Array(1*F*6);let W=0;for(let i=0;i<z.length;++i){const e=z[i],r=e.count;if(this._context.clippingExtent&&(f.empty(M),f.expandWithBuffer(M,e.mapPosition),!f.intersectsClippingArea(M,this._context.clippingExtent)))continue;const s=o.earcut(e.mapPosition,e.holeIndices,3);if(0===s.length)continue;const l=3*r*2+s.length,c=new Array(l),h=new Array(s.length),d=6*r,p=3*N.BYTES_PER_ELEMENT,g=new y.BufferViewVec3f64(N.buffer,W*p,p,(W+d)*p),b=3*j.BYTES_PER_ELEMENT,x=new y.BufferViewVec3f64(j.buffer,W*b,b,(W+d)*b),E=new Float64Array(H.buffer,3*W*H.BYTES_PER_ELEMENT,3*d),v=new Float64Array(Y.buffer,1*W*Y.BYTES_PER_ELEMENT,1*d),P=this._getExtrusionSize(t);k(G,V,s,e,g.typedBuffer,E,x.typedBuffer,v,c,h,P,O,R),m.transformMat4(g,g,B),m.transformMat3(x,x,T),W+=6*r;const w=this._context.stage.renderView._getObjectAndLayerIdColor({graphicUid:a,layerUid:this._context.layer.uid}),L=U(c,c.length-h.length,{positions:g.typedBuffer,elevation:E,normals:x.typedBuffer,heights:v},n,w);_.push(L),S.push(this._material),A.push(u.IDENTITY);const C=U(h,0,{positions:g.typedBuffer,elevation:E,normals:x.typedBuffer,heights:v},n,w);_.push(C),S.push(this._bottomMaterial),A.push(u.IDENTITY)}if(0===_.length)return null;const Z=new D.Object3D({geometries:_,materials:S,transformations:A,metadata:{layerUid:this._context.layer.uid,graphicUid:a,isElevationSource:!0}});Z.transformation=C;const q=L.createMaterial(this.symbolLayer,{opacity:this._getLayerOpacity()}),J=i.isSome(q)?{baseMaterial:this._material,edgeMaterials:[q],properties:{mergeGeometries:!0,hasSlicePlane:this._context.slicePlaneEnabled}}:null,K=new v.Graphics3DObject3DGraphicLayer(this,Z,_,null,null,X,r,J);return K.alignedSampledElevation=d.sampledElevation,K.needsElevationUpdates=E.needsElevationUpdates3D(r.mode),K},n}(A.Graphics3DSymbolLayer);function U(e,t,n,r,a){const i=new Array(e.length).fill(0),s=[[T.VertexAttribute.POSITION,{size:3,data:n.positions,exclusive:!0}],[T.VertexAttribute.NORMAL,{size:3,data:n.normals,exclusive:!0}],[T.VertexAttribute.COLOR,{size:4,data:r,exclusive:!0}],[T.VertexAttribute.SIZE,{size:1,data:n.heights,exclusive:!0}]],o=[[T.VertexAttribute.POSITION,e],[T.VertexAttribute.NORMAL,e],[T.VertexAttribute.COLOR,i]];return n.elevation&&(s.push([T.VertexAttribute.MAPPOS,{size:3,data:n.elevation}]),o.push([T.VertexAttribute.MAPPOS,e])),new B.Geometry(s,o,R.PrimitiveType.Triangle,a,t)}function k(e,t,n,r,a,i,s,o,l,c,h,u,d){const p=n.length/3;let g=0,f=2*r.count;F(e,t,r.index,r.count,n,0,p,a,i,s,o,l,c,f,h,u,d);let y=2*r.count;f=0,H(a,i,o,s,g,r.pathLengths[0],r.count,y,l,f,h),y+=4*r.pathLengths[0],f+=2*r.pathLengths[0],g+=r.pathLengths[0];for(let m=1;m<r.pathLengths.length;++m)H(a,i,o,s,g,r.pathLengths[m],r.count,y,l,f,h),y+=4*r.pathLengths[m],f+=2*r.pathLengths[m],g+=r.pathLengths[m]}function F(e,t,n,r,a,i,s,o,l,c,h,u,p,g,f,y,m){d.copy(ee,y);const b=f>0?1:-1;let _=3*n,x=0,E=3*x,S=r,v=3*S;for(let M=0;M<r;++M)m&&(ee[0]=e[_+0],ee[1]=e[_+1],ee[2]=e[_+2],d.normalize(ee,ee)),o[E+0]=e[_+0],o[E+1]=e[_+1],o[E+2]=e[_+2],l[E+0]=t[_+0],l[E+1]=t[_+1],l[E+2]=t[_+2],c[E+0]=-b*ee[0],c[E+1]=-b*ee[1],c[E+2]=-b*ee[2],h[x]=0,o[v+0]=e[_+0]+f*ee[0],o[v+1]=e[_+1]+f*ee[1],o[v+2]=e[_+2]+f*ee[2],l[v+0]=t[_+0],l[v+1]=t[_+1],l[v+2]=t[_+2],c[v+0]=b*ee[0],c[v+1]=b*ee[1],c[v+2]=b*ee[2],h[S]=f,E+=3,v+=3,_+=3,x+=1,S+=1;_=3*i,E=0,v=3*g;const A=f<0?re:ne,P=f<0?ne:re;for(let d=0;d<s;++d)p[E+0]=a[_+A[0]],p[E+1]=a[_+A[1]],p[E+2]=a[_+A[2]],u[v+0]=a[_+P[0]]+r,u[v+1]=a[_+P[1]]+r,u[v+2]=a[_+P[2]]+r,E+=3,v+=3,_+=3}function N(e,t,n,r,a,i,s){r[i]=r[s],s*=3,e[(i*=3)+0]=e[s+0],e[i+1]=e[s+1],e[i+2]=e[s+2],t[i+0]=t[s+0],t[i+1]=t[s+1],t[i+2]=t[s+2],n[i+0]=a[0],n[i+1]=a[1],n[i+2]=a[2]}const j=p.create();function H(e,t,n,r,a,i,s,o,l,c,h){let u=a,d=a+1,p=a+s,g=a+s+1,f=o,y=o+1,m=o+2*i,b=o+2*i+1;h<0&&(u=a+s+1,g=a),c*=3;for(let _=0;_<i;++_)_===i-1&&(h>0?(d=a,g=a+s):(d=a,u=a+s)),K(e,u,d,p,j),N(e,t,r,n,j,f,u),N(e,t,r,n,j,y,d),N(e,t,r,n,j,m,p),N(e,t,r,n,j,b,g),l[c++]=f,l[c++]=m,l[c++]=b,l[c++]=f,l[c++]=b,l[c++]=y,u++,d++,p++,g++,f+=2,y+=2,m+=2,b+=2}const Y=p.create(),W=p.create(),Z=p.create(),q=p.create(),J=p.create();function K(e,t,n,r,a){t*=3,n*=3,r*=3,d.set(Y,e[t++],e[t++],e[t++]),d.set(W,e[n++],e[n++],e[n++]),d.set(Z,e[r++],e[r++],e[r++]),d.subtract(q,W,Y),d.subtract(J,Z,Y),d.cross(a,J,q),d.normalize(a,a)}const Q=p.create();function X(e,t,n,r){const a=e.stageObject,s=a.geometryRecords,o=s.length,l="absolute-height"!==t.mode;let c=0;const p=a.transformation,g=h.invert(u.create(),p);for(let h=0;h<o;h+=2){const e=s[h].geometry,o=e.getMutableAttribute(T.VertexAttribute.POSITION).data,u=e.vertexAttributes.get(T.VertexAttribute.SIZE).data,f=e.vertexAttributes.get(T.VertexAttribute.MAPPOS).data,y=new O.SamplePosition(f),m=o.length/3;let b=0,_=!1,x=0;const S=n.spatialReference;for(let a=0;a<m;a++){Q[0]=o[b],Q[1]=o[b+1],Q[2]=o[b+2],E.evaluateElevationInfoAtPoint(y,n,t,r,te),l&&(x+=te.sampledElevation),C.TESTS_DISABLE_OPTIMIZATIONS?(d.set($,y.array[y.offset+0],y.array[y.offset+1],te.z+u[b/3]),i.isSome(S)&&r.toRenderCoords($,S,$),d.transformMat4($,$,g)):(d.set($,o[b+0],o[b+1],o[b+2]),d.transformMat4($,$,p),r.setAltitude($,te.z+u[b/3]),d.transformMat4($,$,g)),o[b]=$[0],o[b+1]=$[1],o[b+2]=$[2];const e=ae/r.unitInMeters;(Math.abs(Q[0]-o[b])>=e||Math.abs(Q[1]-o[b+1])>=e||Math.abs(Q[2]-o[b+2])>=e)&&(_=!0),y.offset+=3,b+=3}_&&(e.invalidateBoundingInfo(),a.geometryVertexAttrsUpdated(s[h]),s[h+1].geometry.invalidateBoundingInfo(),a.geometryVertexAttrsUpdated(s[h+1])),c+=x/m}return c/o}const $=p.create(),ee=p.create(),te=new E.SampleElevationInfo,ne=[0,2,1],re=[0,1,2],ae=.01;e.Graphics3DExtrudeSymbolLayer=G,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
