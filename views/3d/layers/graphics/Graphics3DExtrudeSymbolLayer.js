/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/Error","../../../../core/maybe","../../../../chunks/earcut","../../../../chunks/mat3","../../../../chunks/mat3f64","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/projection","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/buffer/BufferView","../../../../chunks/vec32","../../../../renderers/support/renderingInfoUtils","./elevationAlignmentUtils","./ElevationContext","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolLayer","./graphicUtils","./polygonUtils","../support/edgeUtils","../../support/debugFlags","../../support/ElevationProvider","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/Object3D","../../webgl-engine/materials/DefaultMaterial"],(function(e,t,n,r,a,i,s,o,l,c,h,u,p,d,f,m,g,y,_,b,E,v,x,P,S,w,A,M){"use strict";const L=["polygon","extent"];let B=function(e){function c(t,n,r,a){var i;return(i=e.call(this,t,n,r,a)||this).ensureDrapedStatus(!1),i}t._inheritsLoose(c,e);var b=c.prototype;return b.doLoad=function(){var e=t._asyncToGenerator((function*(){if(!this._drivenProperties.size){const e=E.validateSymbolLayerSize(this._getSymbolSize());if(e)throw new n("graphics3dextrudesymbollayer:invalid-size",e)}const e=r.get(this.symbolLayer,"material","color"),t=this._getCombinedOpacityAndColor(e),a=h.fromArray(t),i=t[3],s=i<1||this.needsDrivenTransparentPass,o={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:a,ambient:a,opacity:i,transparent:s,cullFace:s?0:2,vertexColors:!0,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!0};this._material=new M.DefaultMaterial(o),this._bottomMaterial=new M.DefaultMaterial({...o,cullFace:2}),this._context.stage.add(this._material),this._context.stage.add(this._bottomMaterial)}));function a(){return e.apply(this,arguments)}return a}(),b.destroy=function(){e.prototype.destroy.call(this),this._material&&(this._context.stage.remove(this._material),this._context.stage.remove(this._bottomMaterial))},b.createGraphics3DGraphic=function(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,L,this.symbolLayer.type))return null;const n=this._getVertexOpacityAndColor(e.renderingInfo,255),r=this.setGraphicElevationContext(t,new y.ElevationContext);return this._createAs3DShape(t,e.renderingInfo,n,r,t.uid)},b.layerOpacityChanged=function(e,t){const n=r.get(this.symbolLayer,"material","color"),a=this._getCombinedOpacity(n),i=a<1||this.needsDrivenTransparentPass;this._material.setParameters({opacity:a,transparent:i}),this._bottomMaterial.setParameters({opacity:a,transparent:i});const s=this._getLayerOpacity();return e.forEach((e=>{const n=t(e);r.isSome(n)&&n.layerOpacityChanged(s,this._context.isAsync)})),!0},b.layerElevationInfoChanged=function(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,g.needsElevationUpdates3D)},b.slicePlaneEnabledChanged=function(e,t){return this._material.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),this._bottomMaterial.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),e.forEach((e=>{const n=t(e);r.isSome(n)&&n.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)})),!0},b.physicalBasedRenderingChanged=function(){return this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._bottomMaterial.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0},b.pixelRatioChanged=function(){return!0},b._getExtrusionSize=function(e){let t;var n;e.size&&this._drivenProperties.size?t=null!=(n=m.getDriverAxisSizeValue(e.size,2))?n:0:t=this._getSymbolSize();return t/=this._context.renderCoordsHelper.unitInMeters,t},b.applyRendererDiff=function(){return 1},b._getSymbolSize=function(){var e;return null!=(e=this.symbolLayer.size)?e:1},b._createAs3DShape=function(e,t,n,c,m){const y=v.geometryAsPolygon(e.geometry);if(r.isNone(y))return null;const b=v.geometryToRenderInfo(y,this._context.elevationProvider,this._context.renderCoordsHelper,c);if(this._logGeometryCreationWarnings(b,y.rings,"rings","ExtrudeSymbol3DLayer"),0===y.rings.length||!y.rings.some((e=>e.length>0)))return null;const P=E.computeCentroid(y);if(r.isNone(P))return null;const S=new Array,w=new Array,M=new Array,L=p.create(),B=l.create(),z=h.create(),C=1===this._context.renderCoordsHelper.viewingMode;C||this._context.renderCoordsHelper.worldUpAtPosition(null,z),u.computeTranslationToOriginAndRotation(y.spatialReference,[P.x,P.y,0],B,this._context.renderCoordsHelper.spatialReference);const T=l.create();o.invert(T,B);const G=s.create();i.normalFromMat4(G,T);const{polygons:I,mapPosition:R,position:O}=b,U=O.length/3,k=new Float64Array(3*U*6),F=new Float64Array(3*U*6),N=new Float64Array(3*U*6),j=new Float64Array(1*U*6);let H=0;for(let r=0;r<I.length;++r){const e=I[r],i=e.count;if(this._context.clippingExtent&&(p.empty(L),p.expandWithBuffer(L,e.mapPosition),!p.intersectsClippingArea(L,this._context.clippingExtent)))continue;const s=a.earcut(e.mapPosition,e.holeIndices,3);if(0===s.length)continue;const o=3*i*2+s.length,c=new Uint32Array(o),h=new Uint32Array(s.length),u=6*i,m=3*k.BYTES_PER_ELEMENT,g=new d.BufferViewVec3f64(k.buffer,H*m,m,(H+u)*m),y=3*F.BYTES_PER_ELEMENT,_=new d.BufferViewVec3f64(F.buffer,H*y,y,(H+u)*y),b=new Float64Array(N.buffer,3*H*N.BYTES_PER_ELEMENT,3*u),E=new Float64Array(j.buffer,1*H*j.BYTES_PER_ELEMENT,1*u),v=this._getExtrusionSize(t);D(O,R,s,e,g.typedBuffer,b,_.typedBuffer,E,0,c,h,v,z,C),f.transformMat4(g,g,T),f.transformMat3(_,_,G),H+=6*i;const x=this._createExtrudeGeometry(c,c.length-h.length,{positions:g.typedBuffer,elevation:b,normals:_.typedBuffer,heights:E},n);S.push(x),w.push(this._material),M.push(l.IDENTITY);const P=this._createExtrudeGeometry(h,0,{positions:g.typedBuffer,elevation:b,normals:_.typedBuffer,heights:E},n);S.push(P),w.push(this._bottomMaterial),M.push(l.IDENTITY)}if(0===S.length)return null;const Y=new A.Object3D({geometries:S,materials:w,transformations:M,metadata:{layerUid:this._context.layer.uid,graphicUid:m,isElevationSource:!0}});Y.transformation=B;const W=x.createMaterial(this.symbolLayer,{opacity:this._getLayerOpacity()}),Z=r.isSome(W)?{baseMaterial:this._material,edgeMaterials:[W],properties:{mergeGeometries:!0,slicePlaneEnabled:this._context.slicePlaneEnabled}}:null,q=new _.Graphics3DObject3DGraphicLayer(this,Y,S,null,null,V,c,Z);return q.alignedSampledElevation=b.sampledElevation,q.needsElevationUpdates=g.needsElevationUpdates3D(c.mode),q},b._createExtrudeGeometry=function(e,t,n,r){const a=new Uint32Array(e.length),i=[["position",{size:3,data:n.positions,exclusive:!0}],["normal",{size:3,data:n.normals,exclusive:!0}],["color",{size:4,data:r,exclusive:!0}],["size",{size:1,data:n.heights,exclusive:!0}]],s=[["position",e],["normal",e],["color",a]];return n.elevation&&(i.push(["mapPos",{size:3,data:n.elevation}]),s.push(["mapPos",e])),new w.Geometry(i,s,0,t)},c}(b.Graphics3DSymbolLayer);function D(e,t,n,r,a,i,s,o,l,c,h,u,p,d){const f=n.length/3;let m=0,g=2*r.count;z(e,t,r.index,r.count,n,0,f,a,i,s,o,l,c,h,g,u,p,d),l+=2*r.count,g=0,G(a,i,o,s,m,r.pathLengths[0],r.count,l,c,g,u),l+=4*r.pathLengths[0],g+=2*r.pathLengths[0],m+=r.pathLengths[0];for(let y=1;y<r.pathLengths.length;++y)G(a,i,o,s,m,r.pathLengths[y],r.count,l,c,g,u),l+=4*r.pathLengths[y],g+=2*r.pathLengths[y],m+=r.pathLengths[y]}function z(e,t,n,r,a,i,s,o,l,h,u,p,d,f,m,g,y,_){c.copy(H,y);const b=g>0?1:-1;let E=3*n,v=p,x=3*v,P=p+r,S=3*P;for(let M=0;M<r;++M)_&&(H[0]=e[E+0],H[1]=e[E+1],H[2]=e[E+2],c.normalize(H,H)),o[x+0]=e[E+0],o[x+1]=e[E+1],o[x+2]=e[E+2],l[x+0]=t[E+0],l[x+1]=t[E+1],l[x+2]=t[E+2],h[x+0]=-b*H[0],h[x+1]=-b*H[1],h[x+2]=-b*H[2],u[v]=0,o[S+0]=e[E+0]+g*H[0],o[S+1]=e[E+1]+g*H[1],o[S+2]=e[E+2]+g*H[2],l[S+0]=t[E+0],l[S+1]=t[E+1],l[S+2]=t[E+2],h[S+0]=b*H[0],h[S+1]=b*H[1],h[S+2]=b*H[2],u[P]=g,x+=3,S+=3,E+=3,v+=1,P+=1;E=3*i,x=0,S=3*m;const w=g<0?Z:W,A=g<0?W:Z;for(let c=0;c<s;++c)f[x+0]=a[E+w[0]],f[x+1]=a[E+w[1]],f[x+2]=a[E+w[2]],d[S+0]=a[E+A[0]]+r,d[S+1]=a[E+A[1]]+r,d[S+2]=a[E+A[2]]+r,x+=3,S+=3,E+=3}function C(e,t,n,r,a,i,s){r[i]=r[s],s*=3,e[(i*=3)+0]=e[s+0],e[i+1]=e[s+1],e[i+2]=e[s+2],t[i+0]=t[s+0],t[i+1]=t[s+1],t[i+2]=t[s+2],n[i+0]=a[0],n[i+1]=a[1],n[i+2]=a[2]}const T=h.create();function G(e,t,n,r,a,i,s,o,l,c,h){let u=a,p=a+1,d=a+s,f=a+s+1,m=o,g=o+1,y=o+2*i,_=o+2*i+1;h<0&&(u=a+s+1,f=a),c*=3;for(let b=0;b<i;++b)b===i-1&&(h>0?(p=a,f=a+s):(p=a,u=a+s)),F(e,u,p,d,T),C(e,t,r,n,T,m,u),C(e,t,r,n,T,g,p),C(e,t,r,n,T,y,d),C(e,t,r,n,T,_,f),l[c++]=m,l[c++]=y,l[c++]=_,l[c++]=m,l[c++]=_,l[c++]=g,u++,p++,d++,f++,m+=2,g+=2,y+=2,_+=2}const I=h.create(),R=h.create(),O=h.create(),U=h.create(),k=h.create();function F(e,t,n,r,a){t*=3,n*=3,r*=3,c.set(I,e[t++],e[t++],e[t++]),c.set(R,e[n++],e[n++],e[n++]),c.set(O,e[r++],e[r++],e[r++]),c.subtract(U,R,I),c.subtract(k,O,I),c.cross(a,k,U),c.normalize(a,a)}const N=h.create();function V(e,t,n,r){const a=e.stageObject,i=a.geometryRecords,s=i.length,h="absolute-height"!==t.mode;let u=0;const p=a.transformation,d=o.invert(l.create(),p);for(let o=0;o<s;o+=2){const e=i[o].geometry,s=e.getMutableAttribute("position").data,l=e.vertexAttributes.get("size").data,f=e.vertexAttributes.get("mapPos").data,m=new S.SamplePosition(f),y=s.length/3;let _=0,b=!1,E=0;const v=n.spatialReference;for(let a=0;a<y;a++){N[0]=s[_],N[1]=s[_+1],N[2]=s[_+2],g.evaluateElevationInfoAtPoint(m,n,t,r,Y),h&&(E+=Y.sampledElevation),P.TESTS_DISABLE_OPTIMIZATIONS?(c.set(j,m.array[m.offset+0],m.array[m.offset+1],Y.z+l[_/3]),r.toRenderCoords(j,v,j),c.transformMat4(j,j,d)):(c.set(j,s[_+0],s[_+1],s[_+2]),c.transformMat4(j,j,p),r.setAltitude(j,Y.z+l[_/3]),c.transformMat4(j,j,d)),s[_]=j[0],s[_+1]=j[1],s[_+2]=j[2];const e=q/r.unitInMeters;(Math.abs(N[0]-s[_])>=e||Math.abs(N[1]-s[_+1])>=e||Math.abs(N[2]-s[_+2])>=e)&&(b=!0),m.offset+=3,_+=3}b&&(e.invalidateBoundingInfo(),a.geometryVertexAttrsUpdated(i[o]),i[o+1].geometry.invalidateBoundingInfo(),a.geometryVertexAttrsUpdated(i[o+1])),u+=E/y}return u/s}const j=h.create(),H=h.create(),Y=new g.SampleElevationInfo,W=[0,2,1],Z=[0,1,2],q=.01;e.Graphics3DExtrudeSymbolLayer=B,Object.defineProperty(e,"__esModule",{value:!0})}));
