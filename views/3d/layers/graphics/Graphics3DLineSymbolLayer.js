/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../geometry","../../../../core/Error","../../../../core/maybe","../../../../core/screenUtils","../../../../chunks/mat4f64","../../../../chunks/vec4","../../../../chunks/vec4f64","../../../../geometry/support/aaBoundingBox","../../../../renderers/support/renderingInfoUtils","./ElevationAligners","./elevationAlignmentUtils","./ElevationContext","./Graphics3DDrapedGraphicLayer","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolLayer","./interfaces","./lineUtils","../support/FastSymbolUpdates","../support/markerUtils","../../support/debugFlags","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/RenderGeometry","../../webgl-engine/materials/LineMarkerMaterial","../../webgl-engine/materials/lineStippleUtils","../../webgl-engine/materials/RibbonLineMaterial","../../../../geometry/Extent","../../../../geometry/Polygon"],(function(e,t,i,r,a,n,s,o,l,p,h,c,u,d,y,m,f,_,g,b,M,v,S,E,L,P,w,D,x){"use strict";const R=["polyline","polygon","extent"];let A=function(e){function i(t,i,r,a){var n;return(n=e.call(this,t,i,r,a)||this)._uniformSize=1,n}t._inheritsLoose(i,e);var A=i.prototype;return A.doLoad=function(){var e=t._asyncToGenerator((function*(){if(this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[1,1,1],unitInMeters:1,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=b.initFastSymbolUpdatesState(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1},!this._drivenProperties.size){const e=null!=this.symbolLayer.size?this.symbolLayer.size:n.px2pt(1);if(e<0)throw new r("graphics3dlinesymbollayer:invalid-size","Symbol sizes may not be negative values");this._uniformSize=e}this._markerTexture=M.prepareMarkerResources(this._context.sharedResources.textures,this.symbolLayer.marker)}));function i(){return e.apply(this,arguments)}return i}(),A._getMaterialParameters=function(e,t=!1){var i;const r=a.applySome(this.symbolLayer.marker,(e=>e.color)),n=a.applySome(this.symbolLayer.material,(e=>e.color)),s=this._getCombinedOpacityAndColor(t&&r||n);this._patternHidesLine&&!t&&(s[3]=0);const o=s[3],l={width:this._computeMaterialWidth(null==(i=this.symbolLayer)?void 0:i.size),color:s,polygonOffset:!0,join:this.symbolLayer.join||"miter",cap:g.parseCapType(this.symbolLayer.cap||"butt"),transparent:o<1||this.needsDrivenTransparentPass,slicePlaneEnabled:this._context.slicePlaneEnabled,isClosed:e,stipplePattern:P.getStipplePatternForLinePattern(this.symbolLayer.pattern),stippleScaleWithLineWidth:!0};return this._fastUpdates&&this._fastUpdates.visualVariables?{...l,...this._fastUpdates.materialParameters}:l},A.destroy=function(){e.prototype.destroy.call(this),this._forEachMaterial((e=>this._context.stage.remove(e))),this._lineMaterial=null,this._ringMaterial=null,this._wireframeLineMaterial=null,this._wireframeRingMaterial=null,this._markerMaterial=null,this._markerTexture=a.releaseMaybe(this._markerTexture)},A._getDrivenSize=function(e){return this._drivenProperties.size&&e.size?n.pt2px(h.getDriverAxisSizeValueAny(e.size)):1},A._getSizeFeatureAttributeData=function(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?f.getAttributeValue(this._fastUpdates.visualVariables.size.field,e):null},A._getDrivenColor=function(e){const t=l.fromValues(1,1,1,1);return this._drivenProperties.color&&e.color&&(t[0]=e.color[0],t[1]=e.color[1],t[2]=e.color[2],e.color.length>0&&(t[3]=e.color[3])),this._drivenProperties.opacity&&e.opacity&&(t[3]=e.opacity),t},A._getColorFeatureAttributeData=function(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color?f.getAttributeValue(this._fastUpdates.visualVariables.color.field,e):null},A._getOpacityFeatureAttributeData=function(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.opacity?f.getAttributeValue(this._fastUpdates.visualVariables.opacity.field,e):null},A.createGraphics3DGraphic=function(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,R,this.symbolLayer.type))return null;const i=this.setGraphicElevationContext(t,new d.ElevationContext);return this.ensureDrapedStatus("on-the-ground"===i.mode),this.draped?this._createAsOverlay(e,this._context.layer.uid):this._createAs3DShape(e,i,t.uid)},A.applyRendererDiff=function(e,t){for(const i in e.diff){if("visualVariables"!==i)return _.ApplyRendererDiffResult.Recreate_Symbol;if(!b.updateFastSymbolUpdatesState(this._fastUpdates,t,this._vvConvertOptions))return _.ApplyRendererDiffResult.Recreate_Symbol;this._forEachMaterial((e=>e.setParameters(this._fastUpdates.materialParameters)))}return _.ApplyRendererDiffResult.Fast_Update},A.prepareSymbolLayerPatch=function(e){var t,i;if("partial"!==e.diff.type)return;const r=e.diff.diff,n={};"complete"===(null==(t=r.size)?void 0:t.type)&&(n.width=this._computeMaterialWidth(r.size.newValue),delete r.size),"complete"===(null==(i=r.cap)?void 0:i.type)&&(n.cap=g.parseCapType(a.unwrapOr(r.cap.newValue,"butt")),delete r.cap);const s=this._prepareMarkerPatch(e,r);this._prepareMaterialPatch(e,r,s),e.symbolLayerStatePatches.push((()=>this._forEachMaterial((e=>e.setParameters(n)))))},A.layerOpacityChanged=function(){return this._forEachMaterial(((e,t)=>this._updateMaterialLayerOpacity(e,t))),!0},A._forEachMaterial=function(e){a.isSome(this._lineMaterial)&&e(this._lineMaterial),a.isSome(this._ringMaterial)&&e(this._ringMaterial),a.isSome(this._wireframeLineMaterial)&&e(this._wireframeLineMaterial),a.isSome(this._wireframeRingMaterial)&&e(this._wireframeRingMaterial),a.isSome(this._markerMaterial)&&e(this._markerMaterial,!0)},A._updateMaterialLayerOpacity=function(e,t=!1){const i=e.parameters.color,r=a.get(this.symbolLayer,"material","color"),n=this._patternHidesLine&&!t?0:this._getCombinedOpacity(r),s=n<1||this.needsDrivenTransparentPass,o=[i[0],i[1],i[2],n];e.setParameters({color:o,transparent:s})},A.layerElevationInfoChanged=function(e,t,r){const a=this._elevationContext.mode,n=u.elevationModeChangeUpdateType(i.elevationModeChangeTypes,r,a);if(n!==u.SymbolUpdateType.UPDATE)return n;const s=u.needsElevationUpdates2D(a);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>s))},A.slicePlaneEnabledChanged=function(){const e={slicePlaneEnabled:this._context.slicePlaneEnabled};return this._forEachMaterial((t=>t.setParameters(e))),!0},A.physicalBasedRenderingChanged=function(){return!0},A.pixelRatioChanged=function(){return!0},A._getGeometryAsPolygonOrPolyline=function(e){switch(e.type){case"extent":if(e instanceof D)return x.fromExtent(e);break;case"polygon":case"polyline":return e}return null},A._createAs3DShape=function(e,t,i){const r=e.graphic,n=this._getGeometryAsPolygonOrPolyline(r.geometry),o="polygon"===n.type?n.rings:n.paths,l=new Array,h=new Array,d=new Array,y=p.create(),f=g.geometryToRenderInfo(n,this._context.elevationProvider,this._context.renderCoordsHelper,t),_="polygon"===n.type?"rings":"paths";this._logGeometryCreationWarnings(f,o,_,"LineSymbol3DLayer");for(let c=0;c<f.lines.length;c++){const{position:t,mapPosition:i}=f.lines[c];if(a.isSome(this._context.clippingExtent)&&(p.empty(y),p.expandWithBuffer(y,i),!p.intersectsClippingArea(y,this._context.clippingExtent)))continue;const r=this._createGeometry(e,t,i,n.type,k.ELEVATED);l.push(r),h.push("polygon"===n.type?this.ringMaterial:this.lineMaterial),d.push(s.IDENTITY),v.LINE_WIREFRAMES&&(l.push(r.cloneShallow()),h.push("polygon"===n.type?this.wireframeRingMaterial:this.wireframeLineMaterial),d.push(s.IDENTITY));const o=this.markerMaterial;a.isSome(o)&&(l.push(r.cloneShallow()),h.push(o),d.push(s.IDENTITY))}if(0===l.length)return null;const b=new S.Object3D({geometries:l,materials:h,transformations:d,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:i}}),M=new m.Graphics3DObject3DGraphicLayer(this,b,l,null,null,c.sharedGeometryElevationAligner,t);return M.alignedSampledElevation=f.sampledElevation,M.needsElevationUpdates=u.needsElevationUpdates2D(t.mode),M},A._createGeometry=function(e,t,i,r,a){const n="polygon"===r?g.RemoveDuplicateStartEnd.REMOVE:g.RemoveDuplicateStartEnd.KEEP,s=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color,o=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size;return g.createGeometry({overlayInfo:a===k.DRAPED?{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper}:null,removeDuplicateStartEnd:n,uniformSize:this._uniformSize,attributeData:{position:t,mapPosition:i,size:o?null:this._getDrivenSize(e.renderingInfo),color:s?null:this._getDrivenColor(e.renderingInfo),sizeFeature:this._getSizeFeatureAttributeData(e.graphic),colorFeature:this._getColorFeatureAttributeData(e.graphic),opacityFeature:this._getOpacityFeatureAttributeData(e.graphic)}})},A._createAsOverlay=function(e,t){const i=e.graphic,r=this._getGeometryAsPolygonOrPolyline(i.geometry),n="polygon"===r.type?r.rings:r.paths,s="polygon"===r.type?this.ringMaterial:this.lineMaterial;s.renderPriority=this._renderPriority;const o=v.LINE_WIREFRAMES?"polygon"===r.type?this.wireframeRingMaterial:this.wireframeLineMaterial:null,l=this.markerMaterial;a.isSome(o)&&(o.renderPriority=this._renderPriority-.001),a.isSome(l)&&(l.renderPriority=this._renderPriority-.002);const h=new Array,c=p.create(),u=p.empty(),d=g.geometryToRenderInfoDraped(r,this._context.overlaySR),m="polygon"===r.type?"rings":"paths";this._logGeometryCreationWarnings(d,n,m,"LineSymbol3DLayer");for(const y of d.lines){if(p.empty(c),p.expandWithBuffer(c,y.position),!p.intersectsClippingArea(c,this._context.clippingExtent))continue;p.expandWithAABB(u,c);const n=this._createGeometry(e,y.position,null,r.type,k.DRAPED),d=e=>{const r=new E.RenderGeometry(n,e,{layerUid:t,graphicUid:i.uid});return h.push(r),r};if(a.isSome(l)){const e=d(l),t=a.unwrap(this.symbolLayer.marker).placement;"begin"!==t&&"begin-end"!==t||p.expandWithBuffer(c,y.position,0,1),"end"!==t&&"begin-end"!==t||p.expandWithBuffer(c,y.position,y.position.length-3,1),this._updateBoundingSphere(e,c)}const m=d(s);if(this._updateBoundingSphere(m,c),v.LINE_WIREFRAMES){const e=d(o);this._updateBoundingSphere(e,c)}}return new y(this,h,u)},A._updateBoundingSphere=function(e,t){o.set(e.boundingSphere,.5*(t[0]+t[3]),.5*(t[1]+t[4]),0,.5*Math.sqrt((t[3]-t[0])*(t[3]-t[0])+(t[4]-t[1])*(t[4]-t[1])))},A._computeMaterialWidth=function(e){return e=a.unwrapOr(e,n.px2pt(1)),this._drivenProperties.size?this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?n.pt2px(1):1:n.pt2px(e)},A._prepareMaterialPatch=function(e,t,i){const r=t.material;if(a.isNone(r)||"collection"===r.type)return;const n="complete"===r.type?a.applySome(r.newValue,(e=>e.color)):"complete"===r.diff.color.type?r.diff.color.newValue:null,s=this._getCombinedOpacityAndColor(n);i&&this._patchMaterialColor(l.clone(s),this._markerMaterial,e),this._patternHidesLine&&(s[3]=0),this._patchMaterialColor(s,this._lineMaterial,e),delete t.material},A._prepareMarkerPatch=function(e,t){const i=t.marker;if(a.isNone(i)||"partial"!==i.type||a.isSome(i.diff.style)||a.isSome(i.diff.placement)||a.isSome(i.diff.color)&&"complete"!==i.diff.color.type)return!1;const r=i.diff.color;if(a.isNone(r))return delete t.marker,a.isNone(this.symbolLayer)||a.isNone(this.symbolLayer.marker)||a.isNone(this.symbolLayer.marker.color);const n=a.unwrap(r.newValue);return a.isNone(n)?(delete t.marker,!0):(this._patchMaterialColor(this._getCombinedOpacityAndColor(n),this._markerMaterial,e),delete t.marker,!1)},A._patchMaterialColor=function(e,t,i){if(a.isNone(t))return;const r=e[3];i.symbolLayerStatePatches.push((()=>t.setParameters({color:e,transparent:r<1||this.needsDrivenTransparentPass})))},t._createClass(i,[{key:"lineMaterial",get:function(){return a.isNone(this._lineMaterial)&&(this._lineMaterial=new w.RibbonLineMaterial(this._getMaterialParameters(!1)),this._context.stage.add(this._lineMaterial)),this._lineMaterial}},{key:"ringMaterial",get:function(){return a.isNone(this._ringMaterial)&&(this._ringMaterial=new w.RibbonLineMaterial(this._getMaterialParameters(!0)),this._context.stage.add(this._ringMaterial)),this._ringMaterial}},{key:"wireframeLineMaterial",get:function(){return a.isNone(this._wireframeLineMaterial)&&(this._wireframeLineMaterial=new w.RibbonLineMaterial({...this._getMaterialParameters(!1),wireframe:!0}),this._context.stage.add(this._wireframeLineMaterial)),this._wireframeLineMaterial}},{key:"wireframeRingMaterial",get:function(){return a.isNone(this._wireframeRingMaterial)&&(this._wireframeRingMaterial=new w.RibbonLineMaterial({...this._getMaterialParameters(!0),wireframe:!0}),this._context.stage.add(this._wireframeRingMaterial)),this._wireframeRingMaterial}},{key:"markerMaterial",get:function(){return a.isNone(this._markerMaterial)&&a.isSome(this.symbolLayer.marker)&&a.isSome(this._markerTexture)&&(this._markerMaterial=new L.LineMarkerMaterial({...this._getMaterialParameters(!1,!0),placement:this.symbolLayer.marker.placement,textureId:this._markerTexture.texture.id}),this._context.stage.add(this._markerMaterial)),this._markerMaterial}},{key:"_patternHidesLine",get:function(){const e=this.symbolLayer.pattern;return a.isSome(e)&&"style"===e.type&&"none"===e.style}}]),i}(f.Graphics3DSymbolLayer);var k;A.elevationModeChangeTypes={definedChanged:u.SymbolUpdateType.RECREATE,staysOnTheGround:u.SymbolUpdateType.NONE,onTheGroundChanged:u.SymbolUpdateType.RECREATE},function(e){e[e.DRAPED=0]="DRAPED",e[e.ELEVATED=1]="ELEVATED"}(k||(k={})),e.Graphics3DLineSymbolLayer=A,e.default=A,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
