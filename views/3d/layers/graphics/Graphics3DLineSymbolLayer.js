/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../geometry","../../../../core/Error","../../../../core/maybe","../../../../core/screenUtils","../../../../chunks/mat4f64","../../../../chunks/vec4","../../../../chunks/vec4f64","../../../../geometry/support/aaBoundingBox","../../../../renderers/support/renderingInfoUtils","./ElevationAligners","./elevationAlignmentUtils","./ElevationContext","./Graphics3DDrapedGraphicLayer","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolLayer","./interfaces","./lineUtils","../support/FastSymbolUpdates","../../support/debugFlags","../../support/engineContent/line","../../support/engineContent/marker","../../support/renderInfoUtils/line","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/RenderGeometry","../../webgl-engine/materials/LineMarkerMaterial","../../webgl-engine/materials/lineStippleUtils","../../webgl-engine/materials/RibbonLineMaterial","../../../../geometry/Extent","../../../../geometry/Polygon"],(function(e,t,i,a,r,n,s,o,l,h,c,p,d,u,y,m,_,f,g,b,M,C,S,v,L,x,E,w,P,D,k){"use strict";const R=["polyline","polygon","extent"];let A=function(e){function i(t,i,a,r){return e.call(this,t,i,a,r)||this}t._inheritsLoose(i,e);var A=i.prototype;return A.doLoad=function(){var e=t._asyncToGenerator((function*(){if(this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[1,1,1],unitInMeters:1,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=b.initFastSymbolUpdatesState(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1},!this._drivenProperties.size){if((null!=this.symbolLayer.size?this.symbolLayer.size:n.px2pt(1))<0)throw new a("graphics3dlinesymbollayer:invalid-size","Symbol sizes may not be negative values")}this._markerTexture=r.isSome(this.symbolLayer.marker)&&r.isSome(this._context.sharedResources.textures)?S.prepareMarkerResources(this._context.sharedResources.textures,g.parseLineMarkerStyle(this.symbolLayer.marker.style)):null}));function i(){return e.apply(this,arguments)}return i}(),A._getMaterialParameters=function(e,t=!1){const i=this._getCombinedOpacityAndColor(t&&this._markerColor||this._materialColor);this._patternHidesLine&&!t&&(i[3]=0);const a={width:this._computeMaterialWidth(this.symbolLayer?.size),color:i,hasPolygonOffset:!0,join:this.symbolLayer.join||"miter",cap:g.parseCapType(this.symbolLayer.cap||"butt"),hasSlicePlane:this._context.slicePlaneEnabled,isClosed:e,stipplePattern:w.getStipplePatternForLinePattern(this.symbolLayer.pattern),stippleScaleWithLineWidth:!0};return this._fastUpdates&&this._fastUpdates.visualVariables?{...a,...this._fastUpdates.materialParameters}:a},A.destroy=function(){e.prototype.destroy.call(this),this._forEachMaterial((e=>this._context.stage.remove(e))),this._lineMaterialCached=null,this._ringMaterialCached=null,this._wireframeLineMaterialCached=null,this._wireframeRingMaterialCached=null,this._markerMaterialCached=null,this._markerTexture=r.releaseMaybe(this._markerTexture)},A._getDrivenSize=function(e){return this._drivenProperties.size&&e.size?n.pt2px(c.getDriverAxisSizeValueAny(e.size)):1},A._getSizeFeatureAttributeData=function(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?_.getAttributeValue(this._fastUpdates.visualVariables.size.field,e):null},A._getDrivenColor=function(e){const t=l.fromValues(1,1,1,1);return this._drivenProperties.color&&e.color&&(t[0]=e.color[0],t[1]=e.color[1],t[2]=e.color[2],e.color.length>0&&(t[3]=e.color[3])),this._drivenProperties.opacity&&e.opacity&&(t[3]=e.opacity),t},A._getColorFeatureAttributeData=function(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color?_.getAttributeValue(this._fastUpdates.visualVariables.color.field,e):null},A._getOpacityFeatureAttributeData=function(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.opacity?_.getAttributeValue(this._fastUpdates.visualVariables.opacity.field,e):null},A.createGraphics3DGraphic=function(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,R,this.symbolLayer.type))return null;const i=this.setGraphicElevationContext(t,new u.ElevationContext);return this.ensureDrapedStatus("on-the-ground"===i.mode),this.draped?this._createAsOverlay(e,this._context.layer.uid):this._createAs3DShape(e,i,t.uid)},A.applyRendererDiff=function(e,t){for(const i in e.diff){if("visualVariables"!==i)return f.ApplyRendererDiffResult.Recreate_Symbol;if(!b.updateFastSymbolUpdatesState(this._fastUpdates,t,this._vvConvertOptions))return f.ApplyRendererDiffResult.Recreate_Symbol;this._forEachMaterial((e=>e.setParameters(this._fastUpdates.materialParameters)))}return f.ApplyRendererDiffResult.Fast_Update},A.prepareSymbolLayerPatch=function(e){if("partial"!==e.diff.type)return;const t=e.diff.diff,i={};"complete"===t.size?.type&&(i.width=this._computeMaterialWidth(t.size.newValue),delete t.size),"complete"===t.cap?.type&&(i.cap=g.parseCapType(r.unwrapOr(t.cap.newValue,"butt")),delete t.cap);const a=this._prepareMarkerPatch(e,t);this._prepareMaterialPatch(e,t,a),e.symbolLayerStatePatches.push((()=>this._forEachMaterial((e=>e.setParameters(i)))))},A.layerOpacityChanged=function(){this._forEachMaterial(((e,t)=>this._updateMaterialLayerOpacity(e,t)))},A._forEachMaterial=function(e){r.isSome(this._lineMaterialCached)&&e(this._lineMaterialCached),r.isSome(this._ringMaterialCached)&&e(this._ringMaterialCached),r.isSome(this._wireframeLineMaterialCached)&&e(this._wireframeLineMaterialCached),r.isSome(this._wireframeRingMaterialCached)&&e(this._wireframeRingMaterialCached),r.isSome(this._markerMaterialCached)&&e(this._markerMaterialCached,!0)},A._updateMaterialLayerOpacity=function(e,t=!1){const i=e.parameters.color,a=r.get(this.symbolLayer,"material","color"),n=this._patternHidesLine&&!t?0:this._getCombinedOpacity(a),s=l.fromValues(i[0],i[1],i[2],n);e.setParameters({color:s})},A.layerElevationInfoChanged=function(e,t,a){const r=this._elevationContext.mode,n=d.elevationModeChangeUpdateType(i.elevationModeChangeTypes,a,r);if(n!==d.SymbolUpdateType.UPDATE)return n;const s=d.needsElevationUpdates2D(r);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>s))},A.slicePlaneEnabledChanged=function(){const e={hasSlicePlane:this._context.slicePlaneEnabled};return this._forEachMaterial((t=>t.setParameters(e))),!0},A.physicalBasedRenderingChanged=function(){return!0},A.pixelRatioChanged=function(){return!0},A._getGeometryAsPolygonOrPolyline=function(e){switch(e.type){case"extent":if(e instanceof D)return k.fromExtent(e);break;case"polygon":case"polyline":return e}return null},A._createAs3DShape=function(e,t,i){const a=e.graphic,n=this._getGeometryAsPolygonOrPolyline(a.geometry),o="polygon"===n.type?n.rings:n.paths,l=new Array,c=new Array,u=new Array,y=h.create(),_=v.geometryToRenderInfo(n,this._context.elevationProvider,this._context.renderCoordsHelper,t),f="polygon"===n.type?"rings":"paths";this._logGeometryCreationWarnings(_,o,f,"LineSymbol3DLayer");for(let p=0;p<_.lines.length;p++){const{position:t,mapPosition:a}=_.lines[p];if(r.isSome(this._context.clippingExtent)&&(h.empty(y),h.expandWithBuffer(y,a),!h.intersectsClippingArea(y,this._context.clippingExtent)))continue;const o=this._createGeometry(e,t,a,n.type,U.ELEVATED,i);l.push(o),c.push("polygon"===n.type?this._ringMaterial:this._lineMaterial),u.push(s.IDENTITY),M.LINE_WIREFRAMES&&(l.push(o.cloneShallow()),c.push("polygon"===n.type?this._wireframeRingMaterial:this._wireframeLineMaterial),u.push(s.IDENTITY));const d=this._markerMaterial;r.isSome(d)&&(l.push(o.cloneShallow()),c.push(d),u.push(s.IDENTITY))}if(0===l.length)return null;const g=new L.Object3D({geometries:l,materials:c,transformations:u,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:i}}),b=new m.Graphics3DObject3DGraphicLayer(this,g,l,null,null,p.sharedGeometryElevationAligner,t);return b.alignedSampledElevation=_.sampledElevation,b.needsElevationUpdates=d.needsElevationUpdates2D(t.mode),b},A._createGeometry=function(e,t,i,a,r,n){const s="polygon"===a,o=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color,l=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size,h=this._context.stage.renderView._getObjectAndLayerIdColor({graphicUid:n,layerUid:this._context.layer.uid});return C.createGeometry({overlayInfo:r===U.DRAPED?{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper}:null,removeDuplicateStartEnd:s,attributeData:{position:t,mapPosition:i,size:l?null:this._getDrivenSize(e.renderingInfo),color:o?null:this._getDrivenColor(e.renderingInfo),sizeFeature:this._getSizeFeatureAttributeData(e.graphic),colorFeature:this._getColorFeatureAttributeData(e.graphic),opacityFeature:this._getOpacityFeatureAttributeData(e.graphic)}},h)},A._createAsOverlay=function(e,t){const i=e.graphic,a=this._getGeometryAsPolygonOrPolyline(i.geometry),n="polygon"===a.type?a.rings:a.paths,s="polygon"===a.type?this._ringMaterial:this._lineMaterial;s.renderPriority=this._renderPriority;const o=M.LINE_WIREFRAMES?"polygon"===a.type?this._wireframeRingMaterial:this._wireframeLineMaterial:null,l=this._markerMaterial;r.isSome(o)&&(o.renderPriority=this._renderPriority-.001),r.isSome(l)&&(l.renderPriority=this._renderPriority-.002);const c=new Array,p=h.create(),d=h.empty(),u=v.geometryToRenderInfoDraped(a,this._context.overlaySR),m="polygon"===a.type?"rings":"paths";this._logGeometryCreationWarnings(u,n,m,"LineSymbol3DLayer");for(const y of u.lines){if(h.empty(p),h.expandWithBuffer(p,y.position),!h.intersectsClippingArea(p,this._context.clippingExtent))continue;h.expandWithAABB(d,p);const n=this._createGeometry(e,y.position,null,a.type,U.DRAPED,i.uid),u=e=>{const a=new x.RenderGeometry(n,e,{layerUid:t,graphicUid:i.uid});return c.push(a),a};if(r.isSome(l)){const e=u(l),t=r.unwrap(this.symbolLayer.marker).placement;"begin"!==t&&"begin-end"!==t||h.expandWithBuffer(p,y.position,0,1),"end"!==t&&"begin-end"!==t||h.expandWithBuffer(p,y.position,y.position.length-3,1),this._updateBoundingSphere(e,p)}const m=u(s);if(this._updateBoundingSphere(m,p),M.LINE_WIREFRAMES){const e=u(o);this._updateBoundingSphere(e,p)}}return new y(this,c,d,this._context.drapeSourceRenderer)},A._updateBoundingSphere=function(e,t){o.set(e.boundingSphere,.5*(t[0]+t[3]),.5*(t[1]+t[4]),0,.5*Math.sqrt((t[3]-t[0])*(t[3]-t[0])+(t[4]-t[1])*(t[4]-t[1])))},A._computeMaterialWidth=function(e){return e=r.unwrapOr(e,n.px2pt(1)),this._drivenProperties.size?this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?n.pt2px(1):1:n.pt2px(e)},A._prepareMaterialPatch=function(e,t,i){const a=t.material;if(r.isNone(a))return void(i.changed&&i.useMaterialColor&&this._patchMaterialColor(this._getCombinedOpacityAndColor(this._materialColor),this._markerMaterialCached,e));if("collection"===a.type)return;const n="complete"===a.type?r.applySome(a.newValue,(e=>e.color)):"complete"===a.diff.color.type?a.diff.color.newValue:null,s=this._getCombinedOpacityAndColor(n);i.useMaterialColor&&this._patchMaterialColor(l.clone(s),this._markerMaterialCached,e),this._patternHidesLine&&(s[3]=0),this._patchMaterialColor(s,this._lineMaterialCached,e),delete t.material},A._prepareMarkerPatch=function(e,t){const i=t.marker;if(r.isNone(i)||"partial"!==i.type||r.isSome(i.diff.style)||r.isSome(i.diff.placement)||r.isSome(i.diff.color)&&"complete"!==i.diff.color.type)return{changed:!1,useMaterialColor:r.isNone(this._markerColor)};const a=i.diff.color;if(r.isNone(a))return delete t.marker,{changed:!1,useMaterialColor:r.isNone(this._markerColor)};const n=r.unwrap(a.newValue);return r.isNone(n)?(delete t.marker,{changed:!0,useMaterialColor:!0}):(this._patchMaterialColor(this._getCombinedOpacityAndColor(n),this._markerMaterialCached,e),delete t.marker,{changed:!0,useMaterialColor:!1})},A._patchMaterialColor=function(e,t,i){r.isNone(t)||i.symbolLayerStatePatches.push((()=>t.setParameters({color:e})))},t._createClass(i,[{key:"_materialColor",get:function(){return r.applySome(this.symbolLayer.material,(e=>e.color))}},{key:"_markerColor",get:function(){return r.applySome(this.symbolLayer.marker,(e=>e.color))}},{key:"_lineMaterial",get:function(){return r.isNone(this._lineMaterialCached)&&(this._lineMaterialCached=new P.RibbonLineMaterial(this._getMaterialParameters(!1)),this._context.stage.add(this._lineMaterialCached)),this._lineMaterialCached}},{key:"_ringMaterial",get:function(){return r.isNone(this._ringMaterialCached)&&(this._ringMaterialCached=new P.RibbonLineMaterial(this._getMaterialParameters(!0)),this._context.stage.add(this._ringMaterialCached)),this._ringMaterialCached}},{key:"_wireframeLineMaterial",get:function(){return r.isNone(this._wireframeLineMaterialCached)&&(this._wireframeLineMaterialCached=new P.RibbonLineMaterial({...this._getMaterialParameters(!1),wireframe:!0}),this._context.stage.add(this._wireframeLineMaterialCached)),this._wireframeLineMaterialCached}},{key:"_wireframeRingMaterial",get:function(){return r.isNone(this._wireframeRingMaterialCached)&&(this._wireframeRingMaterialCached=new P.RibbonLineMaterial({...this._getMaterialParameters(!0),wireframe:!0}),this._context.stage.add(this._wireframeRingMaterialCached)),this._wireframeRingMaterialCached}},{key:"_markerMaterial",get:function(){return r.isNone(this._markerMaterialCached)&&r.isSome(this.symbolLayer.marker)&&r.isSome(this._markerTexture)&&(this._markerMaterialCached=new E.LineMarkerMaterial({...this._getMaterialParameters(!1,!0),placement:this.symbolLayer.marker.placement,textureId:this._markerTexture.texture.id}),this._context.stage.add(this._markerMaterialCached)),this._markerMaterialCached}},{key:"_patternHidesLine",get:function(){const e=this.symbolLayer.pattern;return r.isSome(e)&&"style"===e.type&&"none"===e.style}}]),i}(_.Graphics3DSymbolLayer);var U;A.elevationModeChangeTypes={definedChanged:d.SymbolUpdateType.RECREATE,staysOnTheGround:d.SymbolUpdateType.NONE,onTheGroundChanged:d.SymbolUpdateType.RECREATE},function(e){e[e.DRAPED=0]="DRAPED",e[e.ELEVATED=1]="ELEVATED"}(U||(U={})),e.Graphics3DLineSymbolLayer=A,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
