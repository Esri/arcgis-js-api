/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../geometry","../../../../core/Error","../../../../core/maybe","../../../../core/screenUtils","../../../../chunks/mat4f64","../../../../chunks/vec4","../../../../chunks/vec4f64","../../../../geometry/support/aaBoundingBox","../../../../renderers/support/renderingInfoUtils","./ElevationAligners","./elevationAlignmentUtils","./ElevationContext","./Graphics3DDrapedGraphicLayer","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolLayer","./lineUtils","../support/FastSymbolUpdates","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/RenderGeometry","../../webgl-engine/materials/lineStippleUtils","../../webgl-engine/materials/RibbonLineMaterial","../../../../geometry/Extent","../../../../geometry/Polygon"],(function(e,t,i,a,r,n,s,o,l,p,h,c,y,d,u,g,m,_,f,b,v,S,x,M,P){"use strict";const U=["polyline","polygon","extent"];let D=function(e){function i(t,i,a,r){var n;return(n=e.call(this,t,i,a,r)||this)._uniformSize=1,n}t._inheritsLoose(i,e);var D=i.prototype;return D.doLoad=function(){var e=t._asyncToGenerator((function*(){if(this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[1,1,1],unitInMeters:1,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=f.initFastSymbolUpdatesState(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1},!this._drivenProperties.size){const e=null!=this.symbolLayer.size?this.symbolLayer.size:n.px2pt(1);if(e<0)throw new a("graphics3dlinesymbollayer:invalid-size","Symbol sizes may not be negative values");this._uniformSize=e}}));function i(){return e.apply(this,arguments)}return i}(),D.getMaterialParameters=function(e){const t=r.get(this.symbolLayer,"material","color"),i=this._getCombinedOpacityAndColor(t);this._patternHidesLine&&(i[3]=0);const a=i[3],s={width:1,color:i,polygonOffset:!0,join:this.symbolLayer.join||"miter",cap:_.parseCapType(this.symbolLayer.cap||"butt"),transparent:a<1||this.needsDrivenTransparentPass,slicePlaneEnabled:this._context.slicePlaneEnabled,isClosed:e,stipplePattern:S.getStipplePatternForLinePattern(this.symbolLayer.pattern),stippleScaleWithLineWidth:!0};if(this._drivenProperties.size)this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size&&(s.width=n.pt2px(1));else{const e=null!=this.symbolLayer.size?this.symbolLayer.size:n.px2pt(1);s.width=n.pt2px(e)}return this._fastUpdates&&this._fastUpdates.visualVariables?{...s,...this._fastUpdates.materialParameters}:s},D.destroy=function(){e.prototype.destroy.call(this),this._context.stage.remove(this._lineMaterial),this._lineMaterial=null,this._context.stage.remove(this._ringMaterial),this._ringMaterial=null},D.getDrivenSize=function(e){return this._drivenProperties.size&&e.size?n.pt2px(h.getDriverAxisSizeValueAny(e.size)):1},D.getSizeFeatureAttributeData=function(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?m.getAttributeValue(this._fastUpdates.visualVariables.size.field,e):null},D.getDrivenColor=function(e){const t=l.fromValues(1,1,1,1);return this._drivenProperties.color&&e.color&&(t[0]=e.color[0],t[1]=e.color[1],t[2]=e.color[2],e.color.length>0&&(t[3]=e.color[3])),this._drivenProperties.opacity&&e.opacity&&(t[3]=e.opacity),t},D.getColorFeatureAttributeData=function(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color?m.getAttributeValue(this._fastUpdates.visualVariables.color.field,e):null},D.getOpacityFeatureAttributeData=function(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.opacity?m.getAttributeValue(this._fastUpdates.visualVariables.opacity.field,e):null},D.createGraphics3DGraphic=function(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,U,this.symbolLayer.type))return null;const i=this.setGraphicElevationContext(t,new d.ElevationContext);return this.ensureDrapedStatus("on-the-ground"===i.mode),this.draped?this._createAsOverlay(e,this._context.layer.uid):this._createAs3DShape(e,i,t.uid)},D.applyRendererDiff=function(e,t){for(const i in e.diff){if("visualVariables"!==i)return 0;if(!f.updateFastSymbolUpdatesState(this._fastUpdates,t,this._vvConvertOptions))return 0;r.isSome(this._lineMaterial)&&this._lineMaterial.setParameters(this._fastUpdates.materialParameters),r.isSome(this._ringMaterial)&&this._ringMaterial.setParameters(this._fastUpdates.materialParameters)}return 2},D.layerOpacityChanged=function(){return r.isSome(this._lineMaterial)&&this.updateMaterialLayerOpacity(this._lineMaterial),r.isSome(this._ringMaterial)&&this.updateMaterialLayerOpacity(this._ringMaterial),!0},D.updateMaterialLayerOpacity=function(e){const t=e.parameters.color,i=r.get(this.symbolLayer,"material","color"),a=this._patternHidesLine?0:this._getCombinedOpacity(i),n=a<1||this.needsDrivenTransparentPass,s=[t[0],t[1],t[2],a];e.setParameters({color:s,transparent:n})},D.layerElevationInfoChanged=function(e,t,a){const r=this._elevationContext.mode,n=y.elevationModeChangeUpdateType(i.elevationModeChangeTypes,a,r);if(n!==y.SymbolUpdateType.UPDATE)return n;const s=y.needsElevationUpdates2D(r);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>s))},D.slicePlaneEnabledChanged=function(){return r.isSome(this._lineMaterial)&&this._lineMaterial.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),r.isSome(this._ringMaterial)&&this._ringMaterial.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0},D.physicalBasedRenderingChanged=function(){return!0},D.pixelRatioChanged=function(){return!0},D._getGeometryAsPolygonOrPolyline=function(e){switch(e.type){case"extent":if(e instanceof M)return P.fromExtent(e);break;case"polygon":case"polyline":return e}return null},D._createAs3DShape=function(e,t,i){const a=e.graphic,n=this._getGeometryAsPolygonOrPolyline(a.geometry),o="polygon"===n.type?n.rings:n.paths,l=new Array,h=new Array,d=new Array,u=p.create(),m=_.geometryToRenderInfo(n,this._context.elevationProvider,this._context.renderCoordsHelper,t),f="polygon"===n.type?"rings":"paths";this._logGeometryCreationWarnings(m,o,f,"LineSymbol3DLayer");for(let c=0;c<m.lines.length;c++){const{position:t,mapPosition:i}=m.lines[c];if(r.isSome(this._context.clippingExtent)&&(p.empty(u),p.expandWithBuffer(u,i),!p.intersectsClippingArea(u,this._context.clippingExtent)))continue;const a=this._createGeometry(e,t,i,n.type,1);l.push(a),h.push("polygon"===n.type?this.ringMaterial:this.lineMaterial),d.push(s.IDENTITY)}if(0===l.length)return null;const v=new b.Object3D({geometries:l,materials:h,transformations:d,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:i}}),S=new g.Graphics3DObject3DGraphicLayer(this,v,l,null,null,c.perVertexElevationAligner,t);return S.alignedSampledElevation=m.sampledElevation,S.needsElevationUpdates=y.needsElevationUpdates2D(t.mode),S},D._createGeometry=function(e,t,i,a,r){const n="polygon"===a?1:0,s=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color,o=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size;return _.createGeometry({overlayInfo:0===r?{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper}:null,removeDuplicateStartEnd:n,uniformSize:this._uniformSize,attributeData:{position:t,mapPosition:i,size:o?null:this.getDrivenSize(e.renderingInfo),color:s?null:this.getDrivenColor(e.renderingInfo),sizeFeature:this.getSizeFeatureAttributeData(e.graphic),colorFeature:this.getColorFeatureAttributeData(e.graphic),opacityFeature:this.getOpacityFeatureAttributeData(e.graphic)}})},D._createAsOverlay=function(e,t){const i=e.graphic,a=this._getGeometryAsPolygonOrPolyline(i.geometry),r="polygon"===a.type?a.rings:a.paths,n="polygon"===a.type?this.ringMaterial:this.lineMaterial;n.renderPriority=this._renderPriority;const s=new Array,l=p.create(),h=p.empty(),c=_.geometryToRenderInfoDraped(a,this._context.overlaySR),y="polygon"===a.type?"rings":"paths";this._logGeometryCreationWarnings(c,r,y,"LineSymbol3DLayer");for(const d of c.lines){if(p.empty(l),p.expandWithBuffer(l,d.position),!p.intersectsClippingArea(l,this._context.clippingExtent))continue;p.expandWithAABB(h,l);const r=this._createGeometry(e,d.position,null,a.type,0),c=new v.RenderGeometry(r,n,t,i.uid);o.set(c.boundingSphere,.5*(l[0]+l[3]),.5*(l[1]+l[4]),0,.5*Math.sqrt((l[3]-l[0])*(l[3]-l[0])+(l[4]-l[1])*(l[4]-l[1]))),s.push(c)}return new u(this,s,h)},t._createClass(i,[{key:"lineMaterial",get:function(){return r.isNone(this._lineMaterial)&&(this._lineMaterial=new x.RibbonLineMaterial(this.getMaterialParameters(!1)),this._context.stage.add(this._lineMaterial)),this._lineMaterial}},{key:"ringMaterial",get:function(){return r.isNone(this._ringMaterial)&&(this._ringMaterial=new x.RibbonLineMaterial(this.getMaterialParameters(!0)),this._context.stage.add(this._ringMaterial)),this._ringMaterial}},{key:"_patternHidesLine",get:function(){const e=this.symbolLayer.pattern;return r.isSome(e)&&"style"===e.type&&"none"===e.style}}]),i}(m.Graphics3DSymbolLayer);D.elevationModeChangeTypes={definedChanged:y.SymbolUpdateType.RECREATE,staysOnTheGround:y.SymbolUpdateType.NONE,onTheGroundChanged:y.SymbolUpdateType.RECREATE},e.Graphics3DLineSymbolLayer=D,e.default=D,Object.defineProperty(e,"__esModule",{value:!0})}));
