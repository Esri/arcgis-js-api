/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/Error","../../../../geometry/Extent","../../../../geometry/Polygon","../../../../geometry","../../../../Color","../../../../core/screenUtils","../../../../chunks/mat4f64","../../../../chunks/vec4f64","../../../../geometry/support/aaBoundingBox","../../webgl-engine/lib/Object3D","./elevationAlignmentUtils","./ElevationAligners","./ElevationContext","./Graphics3DObject3DGraphicLayer","../../webgl-engine/lib/Geometry","./Graphics3DSymbolLayer","../../../../renderers/support/renderingInfoUtils","../../webgl-engine/materials/RibbonLineMaterial","../../webgl-engine/materials/lineStippleUtils","./Graphics3DDrapedGraphicLayer","../support/FastSymbolUpdates","../../webgl-engine/lib/RenderGeometry","./lineUtils"],(function(e,t,i,a,r,s,n,o,l,p,h,c,d,u,y,g,m,_,f,b,v,M,U,x,P,S){"use strict";let D=function(e){function n(t,i,a,r){var s;return(s=e.call(this,t,i,a,r)||this)._uniformSize=1,s}t._inheritsLoose(n,e);var D=n.prototype;return D.doLoad=async function(){if(this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[1,1,1],unitInMeters:1,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=x.initFastSymbolUpdatesState(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1},!this._drivenProperties.size){const e=null!=this.symbolLayer.size?this.symbolLayer.size:l.px2pt(1);if(e<0)throw new a("graphics3dlinesymbollayer:invalid-size","Symbol sizes may not be negative values");this._uniformSize=e}},D.getMaterialParameters=function(e){const t=i.get(this.symbolLayer,"material","color"),a=this._getCombinedOpacityAndColor(t),r=a[3],s={width:1,color:a,polygonOffset:!0,join:this.symbolLayer.join||"miter",cap:this.symbolLayer.cap||"butt",transparent:r<1||this.needsDrivenTransparentPass,slicePlaneEnabled:this._context.slicePlaneEnabled,isClosed:e,stipplePattern:this.symbolLayer.stipplePattern?M.createStipplePattern(this.symbolLayer.stipplePattern.map(l.pt2px)):null,stippleOffColor:this.symbolLayer.stippleOffColor?o.toUnitRGBA(this.symbolLayer.stippleOffColor):null,stippleIntegerRepeats:!0};if(this._drivenProperties.size)this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size&&(s.width=l.pt2px(1));else{const e=null!=this.symbolLayer.size?this.symbolLayer.size:l.px2pt(1);s.width=l.pt2px(e)}return this._fastUpdates&&this._fastUpdates.visualVariables?{...s,...this._fastUpdates.materialParameters}:s},D.destroy=function(){e.prototype.destroy.call(this),i.isSome(this._lineMaterial)&&(this._context.stage.remove(3,this._lineMaterial.id),this._lineMaterial=null),i.isSome(this._ringMaterial)&&(this._context.stage.remove(3,this._ringMaterial.id),this._ringMaterial=null)},D.getDrivenSize=function(e){return this._drivenProperties.size&&e.size?l.pt2px(b.getDriverAxisSizeValueAny(e.size)):1},D.getSizeFeatureAttributeData=function(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?f.getAttributeValue(this._fastUpdates.visualVariables.size.field,e):null},D.getDrivenColor=function(e){const t=h.fromValues(1,1,1,1);return this._drivenProperties.color&&e.color&&(t[0]=e.color[0],t[1]=e.color[1],t[2]=e.color[2],e.color.length>0&&(t[3]=e.color[3])),this._drivenProperties.opacity&&e.opacity&&(t[3]=e.opacity),t},D.getColorFeatureAttributeData=function(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color?f.getAttributeValue(this._fastUpdates.visualVariables.color.field,e):null},D.getOpacityFeatureAttributeData=function(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.opacity?f.getAttributeValue(this._fastUpdates.visualVariables.opacity.field,e):null},D.createGraphics3DGraphic=function(e){const t=e.graphic,i=t.geometry;if(!this._validateGeometryType(t.geometry,n.validGeometryTypes,this.symbolLayer.type))return null;if(!this._validateGeometry(i))return null;const a="graphic"+t.uid,r=this.setGraphicElevationContext(t,new g.ElevationContext);return this.ensureDrapedStatus("on-the-ground"===r.mode),this.draped?this._createAsOverlay(e,this._context.layer.uid):this._createAs3DShape(e,r,a,t.uid)},D.applyRendererDiff=function(e,t){for(const a in e.diff)switch(a){case"visualVariables":if(!x.updateFastSymbolUpdatesState(this._fastUpdates,t,this._vvConvertOptions))return!1;i.isSome(this._lineMaterial)&&this._lineMaterial.setParameterValues(this._fastUpdates.materialParameters),i.isSome(this._ringMaterial)&&this._ringMaterial.setParameterValues(this._fastUpdates.materialParameters);break;default:return!1}return!0},D.layerOpacityChanged=function(){return i.isSome(this._lineMaterial)&&this.updateMaterialLayerOpacity(this._lineMaterial),i.isSome(this._ringMaterial)&&this.updateMaterialLayerOpacity(this._ringMaterial),!0},D.updateMaterialLayerOpacity=function(e){const t=e.params.color,a=i.get(this.symbolLayer,"material","color"),r=this._getCombinedOpacity(a),s=r<1||this.needsDrivenTransparentPass,n=[t[0],t[1],t[2],r];e.setParameterValues({color:n,transparent:s})},D.layerElevationInfoChanged=function(e,t,i){const a=this._elevationContext.mode,r=u.elevationModeChangeUpdateType(n.elevationModeChangeTypes,i,a);if(r!==u.SymbolUpdateType.UPDATE)return r;const s=u.needsElevationUpdates2D(a);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>s))},D.slicePlaneEnabledChanged=function(){return i.isSome(this._lineMaterial)&&this._lineMaterial.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),i.isSome(this._ringMaterial)&&this._ringMaterial.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0},D.physicalBasedRenderingChanged=function(){return!0},D.pixelRatioChanged=function(){return!0},D._getGeometryAsPolygonOrPolyline=function(e){switch(e.type){case"extent":if(e instanceof r)return s.fromExtent(e);break;case"polygon":case"polyline":return e}return null},D._createAs3DShape=function(e,t,a,r){const s=e.graphic,n=this._getGeometryAsPolygonOrPolyline(s.geometry),o="polygon"===n.type?n.rings:n.paths,l=[],h=[],g=[],f=c.create(),b=S.geometryToRenderInfo(n,this._context.elevationProvider,this._context.renderCoordsHelper,t),v="polygon"===n.type?"rings":"paths";this._logGeometryCreationWarnings(b,o,v,"LineSymbol3DLayer");for(let t=0;t<b.lines.length;t++){const{position:r,mapPosition:s}=b.lines[t];if(i.isSome(this._context.clippingExtent)&&(c.empty(f),c.expandWithBuffer(f,s),!c.intersectsClippingArea(f,this._context.clippingExtent)))continue;const o=this._createGeometryData(e,r,s,n.type),d=new _(o,a+"path"+t);l.push(d),h.push("polygon"===n.type?this.ringMaterial:this.lineMaterial),g.push(p.IDENTITY)}if(0===l.length)return null;const M=new d({geometries:l,materials:h,transformations:g,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:r},idHint:a}),U=y.perVertexElevationAligner,x=new m(this,M,l,null,null,U,t);return x.alignedSampledElevation=b.sampledElevation,x.needsElevationUpdates=u.needsElevationUpdates2D(t.mode),x},D._createGeometryData=function(e,t,i,a){const r="polygon"===a?1:0,s=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color,n=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size;return S.createGeometryData({removeDuplicateStartEnd:r,uniformSize:this._uniformSize,attributeData:{position:t,mapPosition:i,size:n?null:this.getDrivenSize(e.renderingInfo),color:s?null:this.getDrivenColor(e.renderingInfo),sizeFeature:this.getSizeFeatureAttributeData(e.graphic),colorFeature:this.getColorFeatureAttributeData(e.graphic),opacityFeature:this.getOpacityFeatureAttributeData(e.graphic)}})},D._createAsOverlay=function(e,t){const i=e.graphic,a=this._getGeometryAsPolygonOrPolyline(i.geometry),r="polygon"===a.type?a.rings:a.paths,s="polygon"===a.type?this.ringMaterial:this.lineMaterial;s.renderPriority=this._renderPriority;const n=[],o=c.create(),l=c.empty(),p=S.geometryToRenderInfoDraped(a,this._context.overlaySR),h="polygon"===a.type?"rings":"paths";if(this._logGeometryCreationWarnings(p,r,h,"LineSymbol3DLayer"),r.length>0){const{lines:r}=p;for(let p=0;p<r.length;++p){const h=r[p];if(c.empty(o),c.expandWithBuffer(o,h.position),!c.intersectsClippingArea(o,this._context.clippingExtent))continue;c.expandWithAABB(l,o);const d=this._createGeometryData(e,h.position,null,a.type),u=new P(d);u.data.layerUid=t,u.data.graphicUid=i.uid,u.material=s,u.center=[.5*(o[0]+o[3]),.5*(o[1]+o[4]),0],u.bsRadius=.5*Math.sqrt((o[3]-o[0])*(o[3]-o[0])+(o[4]-o[1])*(o[4]-o[1])),n.push(u)}return new U(this,n,l)}return null},t._createClass(n,[{key:"lineMaterial",get:function(){return i.isNone(this._lineMaterial)&&(this._lineMaterial=new v.RibbonLineMaterial(this.getMaterialParameters(!1),this._getIdHint("_ribbonlinemat")),this._context.stage.add(3,this._lineMaterial)),this._lineMaterial}},{key:"ringMaterial",get:function(){return i.isNone(this._ringMaterial)&&(this._ringMaterial=new v.RibbonLineMaterial(this.getMaterialParameters(!0),this._getIdHint("_ribbonlinemat")),this._context.stage.add(3,this._ringMaterial)),this._ringMaterial}}]),n}(f.Graphics3DSymbolLayer);D.validGeometryTypes=["polyline","polygon","extent"],D.elevationModeChangeTypes={definedChanged:u.SymbolUpdateType.RECREATE,staysOnTheGround:u.SymbolUpdateType.NONE,onTheGroundChanged:u.SymbolUpdateType.RECREATE},e.Graphics3DLineSymbolLayer=D,e.default=D,Object.defineProperty(e,"__esModule",{value:!0})}));
