/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{remove as t}from"../../../../core/arrayUtils.js";import{isSome as i}from"../../../../core/maybe.js";import{getObjectId as e}from"../../../../layers/graphics/dehydratedFeatures.js";class s{constructor(t){this.graphicsCore=t,this.idToState=new Map,this.states=new Set;const i=t.owner.layer&&t.owner.layer.objectIdField;i?(this.getGraphicId=t=>e(t,i),this.getGraphics3DGraphicById=t=>this.graphicsCore.getGraphics3DGraphicByObjectId(t)):(this.getGraphicId=t=>t.uid,this.getGraphics3DGraphicById=t=>this.graphicsCore.getGraphics3DGraphicById(t))}destroy(){this.idToState.clear(),this.states.forEach(((t,i)=>this.remove(i)))}add(t){const e={remove:()=>this.remove(t)};if(this.states.has(t))return e;const s=this.getGraphicId(t.graphic),a=this.getGraphics3DGraphicById(s);this.states.has(t)||this.states.add(t);return this._ensureStateList(s).push(t),t.displaying=!!i(a)&&a.isVisible(),t.isDraped=!!i(a)&&a.isDraped,t.tracking=!0,i(a)&&t.emit("changed",{}),e}remove(i){if(this.states.has(i)){if(this.idToState.size){const e=this.getGraphicId(i.graphic),s=this.idToState.get(e);s&&(t(s,i),0===s.length&&this.idToState.delete(e))}this.states.delete(i),i.tracking=!1,i.displaying=!1}}addGraphic(t){this._forEachState(t,(i=>{i.displaying=t.isVisible(),i.isDraped=t.isDraped,i.emit("changed",{})}))}removeGraphic(t){this._forEachState(t,(t=>{t.displaying=!1,t.isDraped=!1}))}updateGraphicGeometry(t){this._forEachState(t,(t=>{t.emit("changed",{})}))}updateGraphicVisibility(t){this._forEachState(t,(i=>{i.displaying=t.isVisible()}))}allGraphicsDeleted(){this.states.forEach((t=>{t.displaying=!1}))}_ensureStateList(t){const i=this.idToState.get(t);if(i)return i;const e=new Array;return this.idToState.set(t,e),e}_forEachState(t,i){if(0===this.states.size||0===this.idToState.size)return;const e=this.getGraphicId(t.graphic),s=this.idToState.get(e);null!=s&&s.forEach(i)}}export{s as GraphicStateTracking};
