// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../Color","../../../../symbols","../../../../core/asyncUtils","../../../../core/compilerUtils","../../../../core/Error","../../../../core/has","../../../../core/lang","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/screenUtils","../../../../core/urlUtils","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec2f64","../../../../core/libs/gl-matrix-2/vec3f64","../../../../core/libs/gl-matrix-2/vec4f64","../../../../geometry/support/aaBoundingBox","../../../../support/arcadeOnDemand","../../../../symbols/support/IconSymbol3DLayerResource","../../../../symbols/support/utils","../../../2d/arcade/callExpressionWithFeature","./constants","./ElevationAligners","./elevationAlignmentUtils","./ElevationContext","./Graphics3DDrapedGraphicLayer","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolLayer","./graphicUtils","./pointUtils","./sdfPrimitives","../support/FastSymbolUpdates","../../support/pointUtils","../../terrain/OverlayRenderer","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryUtil","../../webgl-engine/lib/RenderGeometry","../../webgl-engine/lib/Texture","../../webgl-engine/materials/HUDMaterial","@dojo/framework/shim/Promise"],(function(e,t,r,i,a,s,o,n,l,c,u,h,d,p,m,_,f,y,v,g,b,x,S,P,z,R,M,T,w,I,C,E,U,O,A,D,G,L,F,V,N){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Graphics3DIconSymbolLayer=void 0;var H=m.mat4f64.create(),k=f.vec3f64.fromValues(0,0,1),B=[.25,.25,.75,.75],q=[64,64],j=function(t){function m(e,r,i,a){var s=t.call(this,e,r,i,a)||this;return s._cimLayers=null,s._cimSymbolMaterials=new Map,s._cimSymbolTextures=new Map,s._cimMaterialParametersInfo=null,s._cimRequiredFields=null,s._cimScaleFactorOrFunction=null,s._size=null,s._symbolTextureRatio=1,s._outlineSize=0,s._texture=null,s._releaseTexture=null,s._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!0},s}return r.__extends(m,t),m.prototype.getCachedSize=function(){return{size:this._getIconSize()}},m.prototype.doLoad=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,i,a,s;return r.__generator(this,(function(r){switch(r.label){case 0:return this._validateOrThrow(),t=this._prepareMaterialParameters(),i=this._getPrimitive(),u.isSome(i)?(this._prepareResourcesPrimitive(t,i),[3,5]):[3,1];case 1:return a=x.getIconHref(this.symbol,this.symbolLayer),(s=p.dataComponents(a))&&"application/json"===s.mediaType?[4,this._prepareResourcesCIM(t,JSON.parse(s.data),e)]:[3,3];case 2:return r.sent(),[3,5];case 3:return[4,this._prepareResourcesHref(t,a,e)];case 4:r.sent(),r.label=5;case 5:return[2]}}))}))},m.prototype._validateOrThrow=function(){if(!this._drivenProperties.size){var e=C.validateSymbolLayerSize(this._getIconSize());if(e)throw new n("graphics3diconsymbollayer:invalid-size",e)}},m.prototype._getIconSize=function(){var e=this.symbolLayer,t=Math.round(null!=e.size?d.pt2px(e.size):16);return this._drivenProperties.size?Math.max(t,64):t},m.prototype._generateTextureCIM=function(e){var t=this._getGraphicHash(e),r=""===t?null:this._cimSymbolTextures.get(t);if(!r){var i={scaleFactor:this._cimScaleFactorOrFunction},a=this._context.sharedResources.cimSymbolRasterizer.rasterizeCIMSymbol(this._cimLayers,e,"esriGeometryPoint",i,null,null);this._cimMaterialParametersInfo.anchorPos=this._getAnchorPos("relative",a.anchorPosition);var s={width:a.imageData.width,height:a.imageData.height,powerOfTwoResizeMode:2};r=new V(a.imageData,"symbol",s),this._cimSymbolTextures.set(t,r),this._context.stage.add(4,r)}return r},m.prototype._computeSize=function(e,t){var r=e.width/e.height;return r>1?[t,Math.round(t/r)]:[Math.round(t*r),t]},m.prototype._prepareMaterialParameters=function(){var e={anchorPos:this._getAnchorPos(this.symbolLayer.anchor,this.symbolLayer.anchorPosition)},t=this.symbol;if(function(e){return e&&"point-3d"===e.type&&e.hasVisibleVerticalOffset()}(t)){var r=t.verticalOffset,i=r.screenLength,a=r.minWorldLength,s=r.maxWorldLength;e.verticalOffset={screenLength:d.pt2px(i),minWorldLength:a||0,maxWorldLength:null!=s?s:1/0}}return this._context.screenSizePerspectiveEnabled&&(e.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),e.occlusionTest=!0,e.slicePlaneEnabled=this._context.slicePlaneEnabled,e},m.prototype._prepareResourcesPrimitive=function(e,t){var r=this,i=this._getOutlineSize();if(W(t)&&0===i)throw new Error("Nothing to render");this._outlineSize=i,e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize;var a=this._context.sharedResources.textures.fromData(t,(function(){return function(e){var t;switch(e){case"circle":t=U.createCircle(128,64);break;case"square":t=U.createSquare(128,64);break;case"kite":t=U.createKite(128,64);break;case"cross":t=U.createCross(128,64);break;case"x":t=U.createX(128,64);break;case"triangle":t=U.createTriangle(128,64);break;default:o.neverReached(e)}return new V(t,"sdf_"+e,{mipmap:!1,wrap:{s:33071,t:33071},width:128,height:128,components:4,noUnpackFlip:!0})}(t)}));this._texture=a.texture,this._releaseTexture=function(){return r._context.sharedResources.textures.release(a.uid)},e.textureIsSignedDistanceField=!0,e.distanceFieldBoundingBox=B,e.textureId=this._texture.id;var s=this._getIconSize();this._size=[s,s],this._symbolTextureRatio=2,this._createMaterialAndAddToStage(e,this._context.stage)},m.prototype._prepareResourcesHref=function(e,t,i){return r.__awaiter(this,void 0,void 0,(function(){var a,o,c,u,d,m,_,f=this;return r.__generator(this,(function(r){switch(r.label){case 0:if(!l("esri-canvas-svg-support")&&p.isSVG(t))throw new n("graphics3diconsymbollayer:unsupported-image-format","IconSymbol3DLayer failed to load (SVG symbols are not supported in IE11)");return this._outlineSize=this._getOutlineSize(),e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize,e.textureIsSignedDistanceField=!1,a=this._getIconSize(),o=a*this._context.layerView.view.pixelRatio,[4,s.result(this._context.sharedResources.textures.fromUrl(t,o,{signal:i}))];case 1:if(!1===(c=r.sent()).ok)throw h.throwIfAbortError(c.error),new n("graphics3diconsymbollayer:request-failed","Failed to load (Request for icon resource failed: "+t+")");return u=c.value,d=u.uid,m=u.texture,this._releaseTexture=function(){return f._context.sharedResources.textures.release(d)},_=m.params,this._size=this._computeSize(_,a),e.textureId=m.id,this._createMaterialAndAddToStage(e,this._context.stage),[2]}}))}))},m.prototype._prepareResourcesCIM=function(t,i,s){return r.__awaiter(this,void 0,void 0,(function(){var o,n,l,c,u,d,p,m,_,f,y,v;return r.__generator(this,(function(r){switch(r.label){case 0:return o=new a.CIMSymbol({data:i}),this._context.sharedResources.cimSymbolRasterizer?[3,2]:[4,new Promise((function(t,r){e(["../../../../symbols/cim/CIMSymbolRasterizer"],t,r)}))];case 1:n=r.sent().CIMSymbolRasterizer,h.throwIfAborted(s),this._context.sharedResources.cimSymbolRasterizer||(this._context.sharedResources.cimSymbolRasterizer=new n(this._context.renderCoordsHelper.spatialReference,!0)),r.label=2;case 2:return l=this._context.layer.fields?this._context.layer.fields.map((function(e){return e.toJSON()})):null,c=this,[4,this._context.sharedResources.cimSymbolRasterizer.analyzeCIMSymbol(o,l,this._context.renderer&&"dictionary"===this._context.renderer.type?this._context.renderer.fieldMap:null,"esriGeometryPoint",{signal:s})];case 3:return c._cimLayers=r.sent(),this._context.renderer&&"dictionary"===this._context.renderer.type&&this._context.renderer.scaleExpression?(p=this._context.renderer,isNaN(p.scaleExpression)?(m=p.scaleExpression,[4,g.createRendererExpression(m,this._context.layer.spatialReference,l)]):[3,5]):[3,6];case 4:return _=r.sent(),d=function(e,t,r){var i=S.default(_,e,{$view:r},"esriGeometryPoint",t);return null!==i?i:1},[3,6];case 5:u=Number(p.scaleExpression),r.label=6;case 6:return this._cimScaleFactorOrFunction=u||d||1,this._context.renderer?[3,7]:(y=[],[3,9]);case 7:return[4,this._context.renderer.getRequiredFields(this._context.layer.fields)];case 8:y=r.sent(),r.label=9;case 9:return f=y,h.throwIfAborted(s),v=this._context.layer.fieldsIndex,this._cimRequiredFields=f.map((function(e){return v.get(e).name})),this._cimMaterialParametersInfo=t,this._cimMaterialParametersInfo.color=this._getFillColor(),this._cimMaterialParametersInfo.outlineColor=[0,0,0,0],this._cimMaterialParametersInfo.outlineSize=0,this._cimMaterialParametersInfo.textureIsSignedDistanceField=!1,[2]}}))}))},m.prototype._getPrimitive=function(){return this.symbolLayer.resource&&this.symbolLayer.resource.href?null:this.symbolLayer.resource&&this.symbolLayer.resource.primitive||b.defaultPrimitive},m.prototype._getOutlineSize=function(){var e,t=this.symbolLayer;return u.isSome(t.outline)&&null!=t.outline.size?Math.max(d.pt2px(t.outline.size),0):(e=W(this._getPrimitive())?1.5:0,Math.max(e,0))},m.prototype._getOutlineColor=function(){var e=this._getLayerOpacity(),t=this.symbolLayer,r=u.get(t,"outline","color");if(u.isSome(r)){var a=i.toUnitRGB(r),s=r.a*e;return[a[0],a[1],a[2],s]}return[0,0,0,0]},m.prototype._getFillColor=function(){if(W(this._getPrimitive()))return P.TRANSPARENT_UNIT;var e=u.isNone(this._getPrimitive()),t=u.get(this.symbolLayer,"material","color");return this._getCombinedOpacityAndColor(t,{hasIntrinsicColor:e})},m.prototype._getAnchorPos=function(e,t){return"relative"===e?_.vec2f64.fromValues((t.x||0)+.5,.5-(t.y||0)):e in C.namedAnchorToHUDMaterialAnchorPos?C.namedAnchorToHUDMaterialAnchorPos[e]:C.namedAnchorToHUDMaterialAnchorPos.center},m.prototype._createMaterialAndAddToStage=function(e,t){if(this._cimLayers?this._fastUpdates={enabled:!1}:this._fastUpdates=O.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions()),this._fastUpdates.enabled&&c.mixin(e,this._fastUpdates.materialParameters),this._cimLayers){var r=this._cimSymbolMaterials.get(e.textureId);return r||(r=new N.default(e,this._getIdHint("_icon")),this._cimSymbolMaterials.set(e.textureId,r),t.add(3,r)),r}return this._material=new N.default(e,this._getIdHint("_icon")),t.add(3,this._material),this._material},m.prototype._setDrapingDependentMaterialParameters=function(){this.draped&&(this._forEachMaterial((function(e){e.setParameterValues({verticalOffset:null,screenSizePerspective:null,occlusionTest:!1,slicePlaneEnabled:!1,shaderPolygonOffset:0})})),this.layerOpacityChanged())},m.prototype.destroy=function(){var e=this;t.prototype.destroy.call(this),this._forEachMaterial((function(t){e._context.stage.remove(3,t.id)})),u.isSome(this._material)&&(this._material=null),this._cimSymbolMaterials.clear(),this._cimSymbolTextures.forEach((function(t){e._context.stage.remove(4,t.id)})),this._cimSymbolTextures.clear(),this._releaseTexture&&(this._releaseTexture(),this._releaseTexture=null)},m.prototype._getScaleFactor=function(e,t){if(this._drivenProperties.size&&e.size){for(var r=0;r<3;r++){var i=e.size[r];i&&"symbol-value"!==i&&"proportional"!==i&&(e.size[r]=d.pt2px(i))}if("symbol-value"===e.size[0])return 1;if(isFinite(+e.size[0]))return+e.size[0]/t;if(isFinite(+e.size[2]))return+e.size[2]/t}return 1},m.prototype.createGraphics3DGraphic=function(e){var t,i,a=e.renderingInfo,s=e.graphic;if(this._cimLayers){if(!this._cimLayers.length)return null;var o=this._generateTextureCIM(s),n=r.__assign({textureId:o.id},this._cimMaterialParametersInfo);i=this._createMaterialAndAddToStage(n,this._context.stage),t=[o.params.width,o.params.height]}else t=this._size,i=u.unwrap(this._material);if(!this._validateGeometry(s.geometry))return null;var l=E.placePointOnGeometry(s.geometry);if(u.isNone(l))return this.logger.warn("unsupported geometry type for icon symbol: "+s.geometry.type),null;var c="graphic"+s.uid,h=this._getVertexOpacityAndColor(a),d=1;if(!this._fastUpdates.enabled||!this._fastUpdates.visualVariables.size){var p=t[0]>t[1]?t[0]:t[1];d=this._getScaleFactor(a,p)}d*=this._symbolTextureRatio;var m=[t[0]*d,t[1]*d],_=this.setGraphicElevationContext(s,new M.ElevationContext);return this.ensureDrapedStatus("on-the-ground"===_.mode)&&this._setDrapingDependentMaterialParameters(),this.draped?this._createAsOverlay(s,l,i,h,m,e.layer.uid):this._createAs3DShape(s,l,i,h,m,_,c,s.uid)},m.prototype.layerOpacityChanged=function(){var e=this._getFillColor(),t=this._getOutlineColor();return this._forEachMaterial((function(r){r.setParameterValues({color:e}),r.setParameterValues({outlineColor:t})})),!0},m.prototype.layerElevationInfoChanged=function(e,t,r){var i=this._elevationContext.mode,a=R.elevationModeChangeUpdateType(m.elevationModeChangeTypes,r,i);if(a!==R.SymbolUpdateType.UPDATE)return a;var s=R.needsElevationUpdates2D(i)||"absolute-height"===i;return this.updateGraphics3DGraphicElevationInfo(e,t,(function(){return s}))},m.prototype.slicePlaneEnabledChanged=function(){var e=this;return this.draped||this._forEachMaterial((function(t){t.setParameterValues({slicePlaneEnabled:e._context.slicePlaneEnabled})})),!0},m.prototype.physicalBasedRenderingChanged=function(){return!0},m.prototype.pixelRatioChanged=function(){return!!this._getPrimitive()},m.prototype.applyRendererDiff=function(e,t){for(var r in e.diff)switch(r){case"visualVariables":if(!O.updateFastSymbolUpdatesState(this._fastUpdates,t,this._fastVisualVariableConvertOptions()))return!1;u.isSome(this._material)&&this._material.setParameterValues(this._fastUpdates.materialParameters);break;default:return!1}return!0},m.prototype._defaultElevationInfoNoZ=function(){return Z},m.prototype._createAs3DShape=function(e,t,r,i,a,s,o,n){var l=this,c=this.getFastUpdateAttrValues(e),u=c?function(e){return O.evaluateModelTransform(l._fastUpdates.materialParameters,c,e)}:null,h=L.createPointGeometry(k,null,i,a,J,null,c),d=[new G(h,o)],p=E.createStageObjectForHUD(this._context,t,d,[r],null,null,s,o,this._context.layer.uid,n,u);if(null===p)return null;var m=z.perObjectElevationAligner,_=new w(this,p.object,d,null,null,m,s);return _.alignedSampledElevation=p.sampledElevation,_.needsElevationUpdates=R.needsElevationUpdates2D(s.mode)||"absolute-height"===s.mode,_.getScreenSize=this._createScreenSizeGetter(a,u),_.calculateRelativeScreenBounds=function(e){return r.calculateRelativeScreenBounds(_.getScreenSize(),1,e)},E.extendPointGraphicElevationContext(_,t,this._context.elevationProvider),_},m.prototype._createAsOverlay=function(e,t,r,i,a,s){var o=this;r.renderPriority=this._renderPriority;var n=f.vec3f64.create();A.pointToVector(t,n,this._context.overlaySR),n[2]=D.DRAPED_Z;var l=this._context.clippingExtent;if(u.isSome(l)&&!v.containsPoint(l,n))return null;var c=this.getFastUpdateAttrValues(e),h=c?function(e){return O.evaluateModelTransform(o._fastUpdates.materialParameters,c,e)}:null,d=L.createPointGeometry(k,n,i,a,null,null,c),p=new F(d);p.material=r,p.center=n,p.bsRadius=0,p.data.layerUid=s,p.data.graphicUid=e.uid,p.calculateShaderTransformation=h;var m=new T(this,[p],null);return m.getScreenSize=this._createScreenSizeGetter(a,h),m.calculateRelativeScreenBounds=function(e){return r.calculateRelativeScreenBounds(m.getScreenSize(),1,e)},m},m.prototype._createScreenSizeGetter=function(e,t){var r=this._outlineSize+2;if(this._fastUpdates.enabled){var i=e[0]/this._symbolTextureRatio,a=e[1]/this._symbolTextureRatio;return function(e){void 0===e&&(e=_.vec2f64.create());var s=t(H);return e[0]=s[0]*i+r,e[1]=s[5]*a+r,e}}var s=e[0]/this._symbolTextureRatio+r,o=e[1]/this._symbolTextureRatio+r;return function(e){return void 0===e&&(e=_.vec2f64.create()),e[0]=s,e[1]=o,e}},m.prototype._fastVisualVariableConvertOptions=function(){var e=this._size[0]>this._size[1]?this._size[0]:this._size[1],t=f.vec3f64.fromValues(e,e,e),r=d.px2pt(1),i=e*r;return{modelSize:t,symbolSize:f.vec3f64.fromValues(i,i,i),unitInMeters:r,transformation:{anchor:f.vec3f64.ZEROS,scale:f.vec3f64.ONES,rotation:f.vec3f64.ZEROS}}},m.prototype._getGraphicHash=function(e){for(var t="",r=0,i=this._cimRequiredFields;r<i.length;r++){var a=i[r];t+=a+e.attributes[a]}return t},m.prototype._forEachMaterial=function(e){u.isSome(this._material)&&e(this._material),this._cimSymbolMaterials.forEach(e)},m.PRIMITIVE_SIZE=q,m.elevationModeChangeTypes={definedChanged:R.SymbolUpdateType.UPDATE,staysOnTheGround:R.SymbolUpdateType.NONE,onTheGroundChanged:R.SymbolUpdateType.RECREATE},m}(I.default);function W(e){return!!u.isSome(e)&&("cross"===e||"x"===e)}t.Graphics3DIconSymbolLayer=j;var Z={mode:"relative-to-ground",offset:0},J=y.vec4f64.fromValues(0,0,0,1);t.default=j}));