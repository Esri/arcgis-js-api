/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["require","exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/has","../../../../core/lang","../../../../core/maybe","../../../../core/Error","../../../../core/urlUtils","../../../../core/promiseUtils","../../../../support/arcadeOnDemand","../../../../Color","../../../../symbols/CIMSymbol","../../../../core/screenUtils","../../../../symbols/support/IconSymbol3DLayerResource","../../../../chunks/symbols","../../../../core/asyncUtils","../../../../chunks/vec3f64","../../../../geometry/projection","../../../../symbols/support/utils","../../../../chunks/mat4f64","../../../../chunks/vec2f64","../../../../chunks/vec4f64","../../../../geometry/support/aaBoundingBox","../../webgl-engine/lib/GeometryUtil","../../webgl-engine/materials/HUDMaterial","./graphicUtils","./elevationAlignmentUtils","./ElevationAligners","./ElevationContext","./Graphics3DObject3DGraphicLayer","../../webgl-engine/lib/Geometry","./Graphics3DSymbolLayer","./pointUtils","../../terrain/OverlayRenderer","../../../2d/arcade/callExpressionWithFeature","./constants","./Graphics3DDrapedGraphicLayer","./sdfPrimitives","../support/FastSymbolUpdates","../../webgl-engine/lib/RenderGeometry","../../webgl-engine/lib/Texture"],(function(e,t,i,r,s,a,n,o,l,c,h,u,d,m,_,p,f,y,g,S,b,x,v,P,z,R,M,T,w,C,E,I,U,O,D,A,L,G,F,V,H){"use strict";const k=S.create(),N=f.fromValues(0,0,1),B=128,j=.5,q=[.25,.25,.75,.75],W=[64,64];let Z=function(t){function _(e,i,r,s){var a;return(a=t.call(this,e,i,r,s)||this)._cimLayers=null,a._cimSymbolMaterials=new Map,a._cimSymbolTextures=new Map,a._cimMaterialParametersInfo=null,a._cimRequiredFields=null,a._cimScaleFactorOrFunction=null,a._size=null,a._symbolTextureRatio=1,a._outlineSize=0,a._texture=null,a._releaseTexture=null,a._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!0},a}i._inheritsLoose(_,t);var S=_.prototype;return S.getCachedSize=function(){return{size:this._getIconSize()}},S.doLoad=async function(e){this._validateOrThrow();const t=this._prepareMaterialParameters(),i=this._getPrimitive();if(a.isSome(i))this._prepareResourcesPrimitive(t,i);else{const i=g.getIconHref(this.symbol,this.symbolLayer),r=o.dataComponents(i);r&&"application/json"===r.mediaType?await this._prepareResourcesCIM(t,JSON.parse(r.data),e):await this._prepareResourcesHref(t,i,e)}},S._validateOrThrow=function(){if(this._drivenProperties.size)return;const e=R.validateSymbolLayerSize(this._getIconSize());if(e)throw new n("graphics3diconsymbollayer:invalid-size",e)},S._getIconSize=function(){const e=this.symbolLayer,t=Math.round(null!=e.size?d.pt2px(e.size):16);return this._drivenProperties.size?Math.max(t,64):t},S._generateTextureCIM=function(e){const t=this._getGraphicHash(e);let i=""===t?null:this._cimSymbolTextures.get(t);if(!i){const r={scaleFactor:this._cimScaleFactorOrFunction},s=this._context.sharedResources.cimSymbolRasterizer.rasterizeCIMSymbol(this._cimLayers,e,"esriGeometryPoint",r,null,null);this._cimMaterialParametersInfo.anchorPos=this._getAnchorPos("relative",s.anchorPosition);const a={width:s.imageData.width,height:s.imageData.height,powerOfTwoResizeMode:2};i=new H(s.imageData,"symbol",a),this._cimSymbolTextures.set(t,i),this._context.stage.add(4,i)}return i},S._computeSize=function(e,t){const i=e.width/e.height;return i>1?[t,Math.round(t/i)]:[Math.round(t*i),t]},S._prepareMaterialParameters=function(){const e={anchorPos:this._getAnchorPos(this.symbolLayer.anchor,this.symbolLayer.anchorPosition)},t=this.symbol;if(function(e){return e&&"point-3d"===e.type&&e.hasVisibleVerticalOffset()}(t)){const{screenLength:i,minWorldLength:r,maxWorldLength:s}=t.verticalOffset;e.verticalOffset={screenLength:d.pt2px(i),minWorldLength:r||0,maxWorldLength:null!=s?s:1/0}}return this._context.screenSizePerspectiveEnabled&&(e.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),e.occlusionTest=!0,e.slicePlaneEnabled=this._context.slicePlaneEnabled,e},S._prepareResourcesPrimitive=function(e,t){const i=this._getOutlineSize();if($(t)&&0===i)throw new Error("Nothing to render");this._outlineSize=i,e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize;const r=this._context.sharedResources.textures.fromData(t,(()=>function(e){let t;const i=B,r=i*j;switch(e){case"circle":t=G.createCircle(i,r);break;case"square":t=G.createSquare(i,r);break;case"kite":t=G.createKite(i,r);break;case"cross":t=G.createCross(i,r);break;case"x":t=G.createX(i,r);break;case"triangle":t=G.createTriangle(i,r)}return new H(t,"sdf_"+e,{mipmap:!1,wrap:{s:33071,t:33071},width:B,height:B,components:4,noUnpackFlip:!0})}(t)));this._texture=r.texture,this._releaseTexture=()=>this._context.sharedResources.textures.release(r.uid),e.textureIsSignedDistanceField=!0,e.distanceFieldBoundingBox=q,e.textureId=this._texture.id;const s=this._getIconSize();this._size=[s,s],this._symbolTextureRatio=2,this._createMaterialAndAddToStage(e,this._context.stage)},S._prepareResourcesHref=async function(e,t,i){if(!r("esri-canvas-svg-support")&&o.isSVG(t)){throw new n("graphics3diconsymbollayer:unsupported-image-format","IconSymbol3DLayer failed to load (SVG symbols are not supported in IE11)")}this._outlineSize=this._getOutlineSize(),e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize,e.textureIsSignedDistanceField=!1;const s=this._getIconSize(),a=s*this._context.layerView.view.pixelRatio,c=await p.result(this._context.sharedResources.textures.fromUrl(t,a,{signal:i}));if(!1===c.ok){l.throwIfAbortError(c.error);throw new n("graphics3diconsymbollayer:request-failed",`Failed to load (Request for icon resource failed: ${t})`)}const{uid:h,texture:u}=c.value;this._releaseTexture=()=>this._context.sharedResources.textures.release(h);const d=u.params;this._size=this._computeSize(d,s),e.textureId=u.id,this._createMaterialAndAddToStage(e,this._context.stage)},S._prepareResourcesCIM=async function(t,i,r){const s=new u({data:i});if(!this._context.sharedResources.cimSymbolRasterizer){const t=(await new Promise((function(t,i){e(["../../../../symbols/cim/CIMSymbolRasterizer"],t,i)}))).CIMSymbolRasterizer;l.throwIfAborted(r),this._context.sharedResources.cimSymbolRasterizer||(this._context.sharedResources.cimSymbolRasterizer=new t(this._context.renderCoordsHelper.spatialReference,!0))}const a=this._context.layer.fields?this._context.layer.fields.map((e=>e.toJSON())):null;let n,o;if(this._cimLayers=await this._context.sharedResources.cimSymbolRasterizer.analyzeCIMSymbol(s,a,this._context.renderer&&"dictionary"===this._context.renderer.type?this._context.renderer.fieldMap:null,"esriGeometryPoint",{signal:r}),this._context.renderer&&"dictionary"===this._context.renderer.type&&this._context.renderer.scaleExpression){const e=this._context.renderer;if(isNaN(e.scaleExpression)){const t=e.scaleExpression,i=await c.createRendererExpression(t,this._context.layer.spatialReference,a);o=(e,t,r)=>{const s=D(i,e,{$view:r},"esriGeometryPoint",t);return null!==s?s:1}}else n=Number(e.scaleExpression)}this._cimScaleFactorOrFunction=n||o||1;const h=this._context.renderer?await this._context.renderer.getRequiredFields(this._context.layer.fields):[];l.throwIfAborted(r);const d=this._context.layer.fieldsIndex;this._cimRequiredFields=h.map((e=>d.get(e).name)),this._cimMaterialParametersInfo=t,this._cimMaterialParametersInfo.color=this._getFillColor(),this._cimMaterialParametersInfo.outlineColor=[0,0,0,0],this._cimMaterialParametersInfo.outlineSize=0,this._cimMaterialParametersInfo.textureIsSignedDistanceField=!1},S._getPrimitive=function(){return this.symbolLayer.resource&&this.symbolLayer.resource.href?null:this.symbolLayer.resource&&this.symbolLayer.resource.primitive||m.defaultPrimitive},S._getOutlineSize=function(){let e=0;const t=this.symbolLayer;if(a.isSome(t.outline)&&null!=t.outline.size)return Math.max(d.pt2px(t.outline.size),0);return e=$(this._getPrimitive())?1.5:0,Math.max(e,0)},S._getOutlineColor=function(){const e=this._getLayerOpacity(),t=this.symbolLayer,i=a.get(t,"outline","color");if(a.isSome(i)){const t=h.toUnitRGB(i),r=i.a*e;return[t[0],t[1],t[2],r]}return[0,0,0,0]},S._getFillColor=function(){if($(this._getPrimitive()))return A.TRANSPARENT_UNIT;const e=a.isNone(this._getPrimitive()),t=a.get(this.symbolLayer,"material","color");return this._getCombinedOpacityAndColor(t,{hasIntrinsicColor:e})},S._getAnchorPos=function(e,t){return"relative"===e?b.fromValues((t.x||0)+.5,.5-(t.y||0)):e in R.namedAnchorToHUDMaterialAnchorPos?R.namedAnchorToHUDMaterialAnchorPos[e]:R.namedAnchorToHUDMaterialAnchorPos.center},S._createMaterialAndAddToStage=function(e,t){if(this._cimLayers?this._fastUpdates={enabled:!1}:this._fastUpdates=F.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions()),this._fastUpdates.enabled&&s.mixin(e,this._fastUpdates.materialParameters),this._cimLayers){let i=this._cimSymbolMaterials.get(e.textureId);return i||(i=new z.HUDMaterial(e,this._getIdHint("_icon")),this._cimSymbolMaterials.set(e.textureId,i),t.add(3,i)),i}return this._material=new z.HUDMaterial(e,this._getIdHint("_icon")),t.add(3,this._material),this._material},S._setDrapingDependentMaterialParameters=function(){this.draped&&(this._forEachMaterial((e=>{e.setParameterValues({verticalOffset:null,screenSizePerspective:null,occlusionTest:!1,slicePlaneEnabled:!1,shaderPolygonOffset:0,isDraped:this.draped})})),this.layerOpacityChanged())},S.destroy=function(){t.prototype.destroy.call(this),this._forEachMaterial((e=>{this._context.stage.remove(3,e.id)})),a.isSome(this._material)&&(this._material=null),this._cimSymbolMaterials.clear(),this._cimSymbolTextures.forEach((e=>{this._context.stage.remove(4,e.id)})),this._cimSymbolTextures.clear(),this._releaseTexture&&(this._releaseTexture(),this._releaseTexture=null)},S._getScaleFactor=function(e,t){if(this._drivenProperties.size&&e.size){for(let t=0;t<3;t++){const i=e.size[t];i&&"symbol-value"!==i&&"proportional"!==i&&(e.size[t]=d.pt2px(i))}if("symbol-value"===e.size[0])return 1;if(isFinite(+e.size[0]))return+e.size[0]/t;if(isFinite(+e.size[2]))return+e.size[2]/t}return 1},S.createGraphics3DGraphic=function(e){const t=e.renderingInfo,i=e.graphic;let r,s;if(this._cimLayers){if(!this._cimLayers.length)return null;const e=this._generateTextureCIM(i),t={textureId:e.id,...this._cimMaterialParametersInfo};s=this._createMaterialAndAddToStage(t,this._context.stage),r=[e.params.width,e.params.height]}else r=this._size,s=a.unwrap(this._material);if(!this._validateGeometry(i.geometry))return null;const n=U.placePointOnGeometry(i.geometry);if(a.isNone(n))return this.logger.warn(`unsupported geometry type for icon symbol: ${i.geometry.type}`),null;const o="graphic"+i.uid,l=this._getVertexOpacityAndColor(t);let c=1;if(!this._fastUpdates.enabled||!this._fastUpdates.visualVariables.size){const e=r[0]>r[1]?r[0]:r[1];c=this._getScaleFactor(t,e)}c*=this._symbolTextureRatio;const h=[r[0]*c,r[1]*c],u=this.setGraphicElevationContext(i,new w.ElevationContext);return this.ensureDrapedStatus("on-the-ground"===u.mode)&&this._setDrapingDependentMaterialParameters(),this.draped?this._createAsOverlay(i,n,s,l,h,e.layer.uid):this._createAs3DShape(i,n,s,l,h,u,o,i.uid)},S.layerOpacityChanged=function(){const e=this._getFillColor(),t=this._getOutlineColor();return this._forEachMaterial((i=>{i.setParameterValues({color:e}),i.setParameterValues({outlineColor:t})})),!0},S.layerElevationInfoChanged=function(e,t,i){const r=this._elevationContext.mode,s=M.elevationModeChangeUpdateType(_.elevationModeChangeTypes,i,r);if(s!==M.SymbolUpdateType.UPDATE)return s;const a=M.needsElevationUpdates2D(r)||"absolute-height"===r;return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>a))},S.slicePlaneEnabledChanged=function(){return this.draped||this._forEachMaterial((e=>{e.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled})})),!0},S.physicalBasedRenderingChanged=function(){return!0},S.pixelRatioChanged=function(){return!!this._getPrimitive()},S.applyRendererDiff=function(e,t){for(const i in e.diff)switch(i){case"visualVariables":if(!F.updateFastSymbolUpdatesState(this._fastUpdates,t,this._fastVisualVariableConvertOptions()))return!1;a.isSome(this._material)&&this._material.setParameterValues(this._fastUpdates.materialParameters);break;default:return!1}return!0},S._defaultElevationInfoNoZ=function(){return J},S._createAs3DShape=function(e,t,i,r,s,a,n,o){const l=this.getFastUpdateAttrValues(e),c=l?e=>F.evaluateModelTransform(this._fastUpdates.materialParameters,l,e):null,h=P.createPointGeometry(N,null,r,s,K,null,l),u=[new E(h,n)],d=U.createStageObjectForHUD(this._context,t,u,[i],null,null,a,n,this._context.layer.uid,o,c);if(null===d)return null;const m=T.perObjectElevationAligner,_=new C(this,d.object,u,null,null,m,a);return _.alignedSampledElevation=d.sampledElevation,_.needsElevationUpdates=M.needsElevationUpdates2D(a.mode)||"absolute-height"===a.mode,_.getScreenSize=this._createScreenSizeGetter(s,c),_.calculateRelativeScreenBounds=e=>i.calculateRelativeScreenBounds(_.getScreenSize(),1,e),U.extendPointGraphicElevationContext(_,t,this._context.elevationProvider),_},S._createAsOverlay=function(e,t,i,r,s,n){i.renderPriority=this._renderPriority;const o=f.create();y.projectPointToVector(t,o,this._context.overlaySR),o[2]=O.DRAPED_Z;const l=this._context.clippingExtent;if(a.isSome(l)&&!v.containsPoint(l,o))return null;const c=this.getFastUpdateAttrValues(e),h=c?e=>F.evaluateModelTransform(this._fastUpdates.materialParameters,c,e):null,u=P.createPointGeometry(N,o,r,s,null,null,c),d=new V(u);d.material=i,d.center=o,d.bsRadius=0,d.data.layerUid=n,d.data.graphicUid=e.uid,d.calculateShaderTransformation=h;const m=new L(this,[d],null);return m.getScreenSize=this._createScreenSizeGetter(s,h),m.calculateRelativeScreenBounds=e=>i.calculateRelativeScreenBounds(m.getScreenSize(),1,e),m},S._createScreenSizeGetter=function(e,t){const i=this._outlineSize+2;if(this._fastUpdates.enabled){const r=e[0]/this._symbolTextureRatio,s=e[1]/this._symbolTextureRatio;return(e=b.create())=>{const a=t(k);return e[0]=a[0]*r+i,e[1]=a[5]*s+i,e}}{const t=e[0]/this._symbolTextureRatio+i,r=e[1]/this._symbolTextureRatio+i;return(e=b.create())=>(e[0]=t,e[1]=r,e)}},S._fastVisualVariableConvertOptions=function(){const e=this._size[0]>this._size[1]?this._size[0]:this._size[1],t=f.fromValues(e,e,e),i=d.px2pt(1),r=e*i;return{modelSize:t,symbolSize:f.fromValues(r,r,r),unitInMeters:i,transformation:{anchor:f.ZEROS,scale:f.ONES,rotation:f.ZEROS}}},S._getGraphicHash=function(e){let t="";for(const i of this._cimRequiredFields)t+=i+e.attributes[i];return t},S._forEachMaterial=function(e){a.isSome(this._material)&&e(this._material),this._cimSymbolMaterials.forEach(e)},_}(I.Graphics3DSymbolLayer);function $(e){return!!a.isSome(e)&&("cross"===e||"x"===e)}Z.PRIMITIVE_SIZE=W,Z.elevationModeChangeTypes={definedChanged:M.SymbolUpdateType.UPDATE,staysOnTheGround:M.SymbolUpdateType.NONE,onTheGroundChanged:M.SymbolUpdateType.RECREATE};const J={mode:"relative-to-ground",offset:0},K=x.fromValues(0,0,0,1);t.Graphics3DIconSymbolLayer=Z,t.default=Z,Object.defineProperty(t,"__esModule",{value:!0})}));
