// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../Color","../../../../core/compilerUtils","../../../../core/maybe","../../../../core/libs/gl-matrix-2/mat3","../../../../core/libs/gl-matrix-2/mat3f64","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../core/libs/gl-matrix-2/vec4f64","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/MeshComponent","../../../../geometry/support/MeshMaterialMetallicRoughness","../../../../geometry/support/webMercatorUtils","../../../../geometry/support/meshUtils/projection","./ElevationAligners","./elevationAlignmentUtils","./ElevationContext","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolLayer","../support/edgeUtils","../support/symbolColorUtils","../../support/debugFlags","../../support/projectionUtils","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryData","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/Texture","../../webgl-engine/lib/Util","../../webgl-engine/materials/DefaultMaterial","../../webgl-engine/materials/NativeLineMaterial"],(function(e,t,r,a,o,n,i,s,l,u,c,p,m,h,f,d,v,g,x,_,y,b,T,C,M,w,A,O,S,N,I,P,E,R){Object.defineProperty(t,"__esModule",{value:!0});var B=P.VertexAttrConstants,F=function(e){function t(t,r,a,o){var n=e.call(this,t,r,a,o)||this;return n._materials=new Map,n._textures=new Map,n.ensureDrapedStatus(!1),n}return r.__extends(t,e),t.prototype.doLoad=function(){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){return w.DRAW_MESH_GEOMETRY_NORMALS&&(this._debugVertexNormalMaterial=new R({color:[1,0,1,1]},"debugVertexNormal"),this._debugFaceNormalMaterial=new R({color:[0,1,1,1]},"debugFAceNormal")),[2]}))}))},t.prototype.destroy=function(){var t=this;e.prototype.destroy.call(this),this._materials.forEach((function(e){t._context.stage.remove(3,e.material.id)})),this._textures.forEach((function(e){t._context.stage.remove(4,e.id)})),this._materials.clear(),this._textures.clear()},t.prototype.createGraphics3DGraphic=function(e){var r=e.graphic;if(!this._validateGeometryType(r.geometry,t.validGeometryTypes,"fill on mesh-3d"))return null;if(!this._validateGeometry(r.geometry))return null;var a="graphic"+r.uid,o=this.setGraphicElevationContext(r,new y.ElevationContext),n=e.renderingInfo;return this._createAs3DShape(r,n,o,a,r.uid)},t.prototype.layerOpacityChanged=function(e,t){var r=this,a=this._getLayerOpacity();return this._materials.forEach((function(e){e.material.setParameterValues({layerOpacity:a});var t=e.material.getParameters();r._setMaterialTransparentParameter(t,e),e.material.setParameterValues({transparent:t.transparent})})),e.forEach((function(e){var o=t(e);n.isSome(o)&&o.layerOpacityChanged(a,r._context.isAsync)})),!0},t.prototype.layerElevationInfoChanged=function(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,_.needsElevationUpdates3D)},t.prototype.slicePlaneEnabledChanged=function(e,t){var r=this;return this._materials.forEach((function(e){e.material.setParameterValues({slicePlaneEnabled:r._context.slicePlaneEnabled})})),e.forEach((function(e){var a=t(e);n.isSome(a)&&a.slicePlaneEnabledChanged(r._context.slicePlaneEnabled,r._context.isAsync)})),!0},t.prototype.physicalBasedRenderingChanged=function(){var e=this;return this._materials.forEach((function(t){var r=t.material.getParameters().isSchematic;t.material.setParameterValues({usePBR:e._usePBR(r)})})),!0},t.prototype.pixelRatioChanged=function(){return!0},t.prototype._requiresSymbolVertexColors=function(){return this._drivenProperties.color||this._drivenProperties.opacity},t.prototype._colorOrTextureUid=function(e){return e?e instanceof a?e.toHex():e.contentHash:"-"},t.prototype._materialPropertiesDefault=function(e,t){var r=this._requiresSymbolVertexColors(),a=!!e.vertexAttributes.color,o=!!e.vertexAttributes.tangent;return{hasSymbolVertexColors:r,hasVertexColors:a,hasVertexTangents:o,uid:"vc:"+a+",vt:"+o+",vct"+t+",svc:"+r}},t.prototype._materialProperties=function(e,t,r){var a=this._materialPropertiesDefault(e,r);if(!t.material)return a;var o=t.material,n=o.color,i=o.colorTexture,s=o.normalTexture,l=o.doubleSided,u=o.alphaCutoff,c=o.alphaMode,p=this._colorOrTextureUid(n),m=this._colorOrTextureUid(i),h=this._colorOrTextureUid(s);if(a.color=n,a.colorTexture=i,a.normalTexture=s,a.uid=a.uid+",cmuid:"+p+",ctmuid:"+m+",ntmuid:"+h+",ds:"+l+",ac:"+u+",am:"+c,t.material instanceof d){var f=t.material,v=f.metallic,g=f.roughness,x=f.metallicRoughnessTexture,_=f.emissiveColor,y=f.emissiveTexture,b=f.occlusionTexture,T=this._colorOrTextureUid(x),C=this._colorOrTextureUid(_),M=this._colorOrTextureUid(y),w=this._colorOrTextureUid(b);a.metallic=v,a.roughness=g,a.metallicRoughnessTexture=x,a.emissiveColor=_,a.emissiveTexture=y,a.occlusionTexture=b,a.uid=a.uid+",mrm:"+v+",mrr:"+g+",mrt:"+T+",emuid:"+C+",etmuid:"+M+",otmuid:"+w}return a},t.prototype._setInternalColorValueParameters=function(e,t){t.diffuse=a.toUnitRGB(e),t.opacity=e.a},t.prototype._getLoadableTextureResource=function(e){return e.data?e.data:e.url},t.prototype._getInternalTextureId=function(e,t){var r=this._getLoadableTextureResource(e);if(r){var a=e.contentHash,o=this._textures.get(a);return o||(o=new I(r,t+"_"+a+"_tex",{mipmap:!0,wrap:this._castTextureWrap(e.wrap),noUnpackFlip:!0,preMultiplyAlpha:!0}),this._textures.set(a,o),this._context.stage.add(4,o)),o.id}},t.prototype._castTextureWrap=function(e){if(void 0===e&&(e="repeat"),"string"==typeof e){var t=this._castTextureWrapIndividual(e);return{s:t,t:t}}return{s:this._castTextureWrapIndividual(e.horizontal),t:this._castTextureWrapIndividual(e.vertical)}},t.prototype._castTextureWrapIndividual=function(e){switch(e){case"clamp":return 33071;case"mirror":return 33648;case"repeat":default:return 10497}},t.prototype._setInternalMaterialParameters=function(e,t,r){e.color&&this._setInternalColorValueParameters(e.color,r),e.colorTexture&&(r.textureId=this._getInternalTextureId(e.colorTexture,t)),e.normalTexture&&(r.normalTextureId=this._getInternalTextureId(e.normalTexture,t)),e.emissiveColor&&(r.emissiveFactor=a.toUnitRGB(e.emissiveColor)),e.emissiveTexture&&(r.emissiveTextureId=this._getInternalTextureId(e.emissiveTexture,t)),e.occlusionTexture&&(r.occlusionTextureId=this._getInternalTextureId(e.occlusionTexture,t)),e.metallicRoughnessTexture&&(r.metallicRoughnessTextureId=this._getInternalTextureId(e.metallicRoughnessTexture,t))},t.prototype._setExternalMaterialParameters=function(e){var t=this._drivenProperties.color,r=n.isSome(this.symbolLayer.material)?this.symbolLayer.material.colorMixMode:null;if(t)e.externalColor=m.vec4f64.ONES;else{var o=n.isSome(this.symbolLayer.material)?this.symbolLayer.material.color:null;n.isSome(o)?e.externalColor=a.toUnitRGBA(o):(r=null,e.externalColor=m.vec4f64.ONES)}r&&(e.colorMixMode=r),e.castShadows=!!this.symbolLayer.castShadows},t.prototype._hasTransparentVertexColors=function(e){var t=e.vertexAttributes.color;if(!t)return!1;for(var r=3;r<t.length;r+=4)if(255!==t[r])return!0;return!1},t.prototype._getOrCreateMaterial=function(e,t){var r=t.material&&t.material.color,a=t.material&&t.material.colorTexture,o=t.material&&"blend"===t.material.alphaMode,n=!(t.material&&"opaque"===t.material.alphaMode)&&(this._hasTransparentVertexColors(e)||r&&r.a<1||a&&a.transparent||o),i=this._materialProperties(e,t,n),s=this._materials.get(i.uid);if(s)return s.material;var l={material:null,isComponentTransparent:n,alphaMode:t.material?t.material.alphaMode:"opaque"},u=this._getIdHint(),c=null==i.metallicRoughnessTexture&&null==i.metallic&&null==i.roughness,m={usePBR:this._usePBR(c),isSchematic:c,vertexColors:i.hasVertexColors,symbolColors:i.hasSymbolVertexColors,vertexTangents:i.hasVertexTangents,ambient:p.vec3f64.ZEROS,diffuse:p.vec3f64.ONES,opacity:1,doubleSided:!0,doubleSidedType:"winding-order",cullFace:0,textureAlphaPremultiplied:!0,layerOpacity:this._getLayerOpacity(),slicePlaneEnabled:this._context.slicePlaneEnabled,initTextureTransparent:!0};c||(m.mrrFactors=[null!=i.metallic?i.metallic:1,null!=i.roughness?i.roughness:1,.5]),t.material&&(m.doubleSided=t.material.doubleSided,m.cullFace=t.material.doubleSided?0:2,m.textureAlphaCutoff=t.material.alphaCutoff),this._setInternalMaterialParameters(i,u,m),this._setExternalMaterialParameters(m),this._setMaterialTransparentParameter(m,l);var h=new E(m,u+"_"+i.uid+"_mat");return l.material=h,this._materials.set(i.uid,l),this._context.stage.add(3,h),h},t.prototype._usePBR=function(e){return!e||this._context.physicalBasedRenderingEnabled},t.prototype._setMaterialTransparentParameter=function(e,t){e.transparent=this.needsDrivenTransparentPass||t.isComponentTransparent||e.layerOpacity<1||e.opacity<1||e.externalColor&&e.externalColor[3]<1,"auto"===t.alphaMode?e.textureAlphaMode=e.transparent?3:1:e.textureAlphaMode="opaque"===t.alphaMode?1:"mask"===t.alphaMode?2:0},t.prototype._addDebugNormals=function(e,t,r,a){for(var o,n,i,s,l=t.length,p=e.spatialReference.isGeographic?20015077/180:1,m=.1*Math.max(e.extent.width*p,e.extent.height*p,e.extent.zmax-e.extent.zmin),h=[],f=[],d=[],v=[],g=0;g<l;g++)for(var x=t[g],_=x.data.getAttribute(B.POSITION),y=x.data.getAttribute(B.NORMAL),b=x.data.getIndices(B.POSITION),T=x.data.getIndices(B.NORMAL),C=_.data,M=y.data,w=0;w<b.length;w++){for(var A=3*b[w],N=3*T[w],I=0;I<3;I++)h.push(C[A+I]);for(I=0;I<3;I++)h.push(C[A+I]+M[N+I]*m);if(f.push(f.length),f.push(f.length),w%3==0){this._calculateFaceNormal(C,b,w,D),this._getFaceVertices(C,b,w,L,V,G),c.vec3.add(L,L,V),c.vec3.add(L,L,G),c.vec3.scale(L,L,1/3);for(I=0;I<3;I++)d.push(L[I]);for(I=0;I<3;I++)d.push(L[I]+D[I]*m);v.push(v.length),v.push(v.length)}}var P=((o={})[B.POSITION]={data:new Float64Array(h),size:3},o),E=((n={})[B.POSITION]=new Uint32Array(f),n),R=new S.GeometryData(P,E,"line"),F=new O(R,"debugVertexNormal");t.push(F),r.push(this._debugVertexNormalMaterial),a.push(u.mat4f64.clone(a[0]));(i={})[B.POSITION]={data:new Float64Array(d),size:3},P=i,(s={})[B.POSITION]=new Uint32Array(v),E=s,R=new S.GeometryData(P,E,"line"),F=new O(R,"debugFaceNormal");t.push(F),r.push(this._debugFaceNormalMaterial),a.push(u.mat4f64.clone(a[0]))},t.prototype._createAs3DShape=function(e,t,r,a,o){var i=e.geometry;if("mesh"!==i.type)return null;var s=this._createGeometryInfo(i,t,a);if(!s)return null;var l=s.geometries,u=s.materials,c=s.transformations,p=s.objectTransformation;w.DRAW_MESH_GEOMETRY_NORMALS&&this._addDebugNormals(i,l,u,c);var m=new N({geometries:l,materials:u,transformations:c,castShadow:!0,metadata:{layerUid:this._context.layer.uid,graphicUid:o},idHint:a});m.objectTransformation=p;var h=x.perObjectElevationAligner,f=this._createEdgeMaterial(),d=n.isSome(f)?{baseMaterial:u[0],edgeMaterials:[f],addObjectSettings:{mergeGeometries:!0},slicePlaneEnabled:this._context.slicePlaneEnabled}:null,v=new b(this,m,l,null,null,h,r,d);v.needsElevationUpdates=_.needsElevationUpdates3D(r.mode);var g=i.extent.center.clone();return g.z=0,v.elevationContext.centerPointInElevationSR=g,v.alignedSampledElevation=h(v,v.elevationContext,this._context.elevationProvider,this._context.renderCoordsHelper),v},t.prototype._createComponentNormals=function(e,t,r,a){var n=r.shading||"flat";switch(n){case"source":return this._createComponentNormalsSource(e,t,r,a);case"flat":return this._createComponentNormalsFlat(e,a);case"smooth":return this._createComponentNormalsSmooth(e,a);default:return void o.neverReached(n)}},t.prototype._createComponentNormalsSource=function(e,t,r,a){if(!t)return this._createComponentNormalsFlat(e,a);var o=!1;if(!r.trustSourceNormals)for(var n=0;n<a.length;n+=3){this._calculateFaceNormal(e,a,n,D);for(var i=0;i<3;i++){var s=3*a[n+i];L[0]=t[s+0],L[1]=t[s+1],L[2]=t[s+2],c.vec3.dot(D,L)<0&&(t[s+0]=-t[s+0],t[s+1]=-t[s+1],t[s+2]=-t[s+2],o=!0)}}return{normals:t,indices:a,didFlipNormals:o}},t.prototype._createComponentNormalsFlat=function(e,t){for(var r=new Float32Array(t.length),a=new Uint32Array(3*t.length),o=0;o<t.length;o+=3)for(var n=this._calculateFaceNormal(e,t,o,D),i=0;i<3;i++)r[o+i]=n[i],a[o+i]=o/3;return{normals:r,indices:a,didFlipNormals:!1}},t.prototype._createComponentNormalsSmooth=function(e,t){for(var r={},a=0;a<t.length;a+=3)for(var o=this._calculateFaceNormal(e,t,a,D),n=0;n<3;n++){(u=r[l=t[a+n]])||(u={normal:p.vec3f64.create(),count:0},r[l]=u),c.vec3.add(u.normal,u.normal,o),u.count++}var i=new Float32Array(3*t.length),s=new Uint32Array(3*t.length);for(a=0;a<t.length;a++){var l,u;1!==(u=r[l=t[a]]).count&&(c.vec3.normalize(u.normal,u.normal),u.count=1);for(n=0;n<3;n++)i[3*a+n]=u.normal[n];s[a]=a}return{normals:i,indices:s,didFlipNormals:!1}},t.prototype._getFaceVertices=function(e,t,r,a,o,n){var i=3*t[r+0],s=3*t[r+1],l=3*t[r+2];a[0]=e[i+0],a[1]=e[i+1],a[2]=e[i+2],o[0]=e[s+0],o[1]=e[s+1],o[2]=e[s+2],n[0]=e[l+0],n[1]=e[l+1],n[2]=e[l+2]},t.prototype._calculateFaceNormal=function(e,t,r,a){return this._getFaceVertices(e,t,r,L,V,G),c.vec3.subtract(V,V,L),c.vec3.subtract(G,G,L),c.vec3.cross(L,V,G),c.vec3.normalize(a,L),a},t.prototype._getOrCreateComponents=function(e){return e.components?e.components:W},t.prototype._createPositionBuffer=function(e){var t=e.vertexAttributes.position,r=new Float64Array(t.length),a=this._context.renderCoordsHelper.spatialReference;return A.bufferToBuffer(e.vertexAttributes.position,e.spatialReference,0,r,a,0,t.length/3),r},t.prototype._createNormalBuffer=function(e,t){var r=e.vertexAttributes.normal;if(!r)return null;if("local"===this._context.layerView.view.viewingMode)return r;var a=e.vertexAttributes.position,o=new Float32Array(r.length);return g.projectNormalToECEF(r,a,t,e.spatialReference,o)},t.prototype._createTangentBuffer=function(e,t){var r=e.vertexAttributes.tangent;if(!r)return null;if("local"===this._context.layerView.view.viewingMode)return r;var a=e.vertexAttributes.position,o=new Float32Array(r.length);return g.projectTangentToECEF(r,a,t,e.spatialReference,o)},t.prototype._createColorBuffer=function(e){return e.vertexAttributes.color},t.prototype._createSymbolColorBuffer=function(e){if(this._requiresSymbolVertexColors()){var t=this._getVertexOpacityAndColor(e),r=M.parseColorMixMode(n.get(this.symbolLayer,"material","colorMixMode")),a=new Uint8Array(4);return M.encodeSymbolColor(t,r,a),a}return null},t.prototype._createColorIndices=function(e){for(var t=new Uint32Array(e.length),r=0;r<t.length;r++)t[r]=0;return t},t.prototype._createBuffers=function(e,t){var r=e.vertexAttributes&&e.vertexAttributes.position;if(!r)return this.logger.warn("Mesh geometry must contain position vertex attributes"),null;var a=e.vertexAttributes.normal,o=e.vertexAttributes.uv,n=e.vertexAttributes.tangent;if(a&&a.length!==r.length)return this.logger.warn("Mesh normal vertex buffer must contain the same number of elements as the position buffer"),null;if(n&&n.length/4!=r.length/3)return this.logger.warn("Mesh tangent vertex buffer must contain the same number of elements as the position buffer"),null;if(o&&o.length/2!=r.length/3)return this.logger.warn("Mesh uv vertex buffer must contain the same number of elements as the position buffer"),null;var i=this._createPositionBuffer(e),s=this._createColorBuffer(e),l=this._createSymbolColorBuffer(t),u=this._createNormalBuffer(e,i);return{positionBuffer:i,normalBuffer:u,tangentBuffer:this._createTangentBuffer(e,i),uvBuffer:o,colorBuffer:s,symbolColorBuffer:l,objectTransformation:this._transformCenterLocal(e,i,u)}},t.prototype._transformCenterLocal=function(e,t,r){var a=e.extent.center,o=this._context.renderCoordsHelper.spatialReference;U[0]=a.x,U[1]=a.y,U[2]=0;var n=u.mat4f64.create();A.computeLinearTransformation(e.spatialReference,U,n,o),l.mat4.invert(j,n);for(var s=0;s<t.length;s+=3)L[0]=t[s+0],L[1]=t[s+1],L[2]=t[s+2],c.vec3.transformMat4(L,L,j),t[s+0]=L[0],t[s+1]=L[1],t[s+2]=L[2];if(r){i.mat3.fromMat4(z,n),i.mat3.transpose(z,z);for(s=0;s<r.length;s+=3)L[0]=r[s+0],L[1]=r[s+1],L[2]=r[s+2],c.vec3.transformMat3(L,L,z),r[s+0]=L[0],r[s+1]=L[1],r[s+2]=L[2]}return n},t.prototype._validateFaces=function(e,t){var r=e.vertexAttributes.position.length/3,a=t.faces;if(a){for(var o=-1,n=0;n<a.length;n++){var i=a[n];i>o&&(o=i)}if(r<=o)return this.logger.warn("Vertex index "+o+" is out of bounds of the mesh position buffer"),!1}else if(r%3!=0)return this.logger.warn("Mesh position buffer length must be a multiple of 9 if no component faces are defined (3 values per vertex * 3 vertices per triangle)"),!1;return!0},t.prototype._getOrCreateFaces=function(e,t){if(t.faces)return t.faces;for(var r=new Uint32Array(e.vertexAttributes.position.length/3),a=0;a<r.length;a++)r[a]=a;return r},t.prototype._isOutsideClippingArea=function(e){if(!this._context.clippingExtent)return!1;var t=e.vertexAttributes&&e.vertexAttributes.position;if(!t)return!1;var r,a=this._context.elevationProvider.spatialReference,o=t.length/3;return e.spatialReference.equals(a)?r=t:(r=new Float64Array(t.length),A.bufferToBuffer(e.vertexAttributes.position,e.spatialReference,0,r,a,0,o)),h.empty(H),h.expandWithBuffer(H,r,0,o),!h.intersectsClippingArea(H,this._context.clippingExtent)},t.prototype._createGeometryInfo=function(e,t,r){var a,o;if(!v.canProject(e,this._context.layerView.view.spatialReference))return this.logger.warn("Geometry spatial reference is not compatible with the view"),null;if(this._isOutsideClippingArea(e))return null;var n=this._createBuffers(e,t);if(!n)return null;for(var i=n.positionBuffer,s=n.uvBuffer,l=n.colorBuffer,c=n.symbolColorBuffer,p=n.normalBuffer,m=n.tangentBuffer,h=n.objectTransformation,f=[],d=[],g=[],x=!1,_=0,y=this._getOrCreateComponents(e);_<y.length;_++){var b=y[_];if(!this._validateFaces(e,b))return null;var T=this._getOrCreateFaces(e,b);if(0!==T.length){var C=this._createComponentNormals(i,p,b,T);C.didFlipNormals&&(x=!0);var M=((a={})[B.POSITION]={size:3,data:i},a[B.NORMAL]={size:3,data:C.normals},a),w=((o={})[B.POSITION]=T,o[B.NORMAL]=C.indices,o);l&&(M[B.COLOR]={size:4,data:l},w[B.COLOR]=T),c&&(M[B.SYMBOLCOLOR]={size:4,data:c},w[B.SYMBOLCOLOR]=this._createColorIndices(T)),e.vertexAttributes.uv&&(M[B.UV0]={size:2,data:s},w[B.UV0]=T),e.vertexAttributes.tangent&&(M[B.TANGENT]={size:4,data:m},w[B.TANGENT]=T);var A=new S.GeometryData(M,w),N=new O(A,r+"_mesh");f.push(N),d.push(u.mat4f64.create()),g.push(this._getOrCreateMaterial(e,b))}}return x&&this.logger.warn("Normals have been automatically flipped to be consistent with the counter clock wise face winding order. It is better to generate mesh geometries that have consistent normals."),{geometries:f,transformations:d,materials:g,objectTransformation:h}},t.prototype._createEdgeMaterial=function(){var e={opacity:this._getLayerOpacity()};return C.createMaterial(this.symbolLayer,e)},t.validGeometryTypes=["mesh"],t}(T.default);t.Graphics3DMeshFillSymbolLayer=F;var U=p.vec3f64.create(),L=p.vec3f64.create(),V=p.vec3f64.create(),G=p.vec3f64.create(),D=p.vec3f64.create(),j=u.mat4f64.create(),z=s.mat3f64.create(),H=h.create(),W=[new f];t.default=F}));