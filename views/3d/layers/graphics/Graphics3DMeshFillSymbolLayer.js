/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../Color","../../../../core/has","../../../../core/maybe","../../../../chunks/mat3","../../../../chunks/mat3f64","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../chunks/vec4f64","../../../../geometry/projection","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/MeshComponent","../../../../geometry/support/MeshMaterialMetallicRoughness","../../../../geometry/support/buffer/BufferView","../../../../chunks/vec32","../../../../geometry/support/meshUtils/projection","../../../../layers/graphics/dehydratedFeatures","./ElevationAligners","./elevationAlignmentUtils","./ElevationContext","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolLayer","../support/edgeUtils","../support/symbolColorUtils","../../support/debugFlags","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/geometryDataUtils","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/Texture","../../webgl-engine/materials/DefaultMaterial","../../webgl-engine/materials/NativeLineMaterial"],(function(e,t,r,o,n,a,i,s,l,c,u,m,f,h,p,d,g,x,_,y,b,v,T,C,S,M,w,A,P,B,E,R,N,O){"use strict";const F=["mesh"];let j=function(e){function o(t,r,o,n){var a;return(a=e.call(this,t,r,o,n)||this)._materials=new Map,a._textures=new Map,a.ensureDrapedStatus(!1),a}t._inheritsLoose(o,e);var i=o.prototype;return i.doLoad=function(){var e=t._asyncToGenerator((function*(){A.DRAW_MESH_GEOMETRY_NORMALS&&(this._debugVertexNormalMaterial=new O.NativeLineMaterial({color:[1,0,1,1]}),this._debugFaceNormalMaterial=new O.NativeLineMaterial({color:[0,1,1,1]}))}));function r(){return e.apply(this,arguments)}return r}(),i.destroy=function(){e.prototype.destroy.call(this),this._context.stage.removeMany(Array.from(this._materials.values(),(e=>e.material))),this._context.stage.removeMany(Array.from(this._textures.values())),this._materials.clear(),this._textures.clear()},i.createGraphics3DGraphic=function(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,F,"fill on mesh-3d"))return null;const r=this.setGraphicElevationContext(t,new T.ElevationContext),o=e.renderingInfo;return this._createAs3DShape(t,o,r,t.uid)},i.layerOpacityChanged=function(e,t){const r=this._getLayerOpacity();return this._materials.forEach((e=>{e.material.setParameterValues({layerOpacity:r});const t=e.material.params;this._setMaterialTransparentParameter(t,e),e.material.setParameterValues({transparent:t.transparent})})),e.forEach((e=>{const o=t(e);n.isSome(o)&&o.layerOpacityChanged(r,this._context.isAsync)})),!0},i.layerElevationInfoChanged=function(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,v.needsElevationUpdates3D)},i.slicePlaneEnabledChanged=function(e,t){return this._materials.forEach((e=>{e.material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled})})),e.forEach((e=>{const r=t(e);n.isSome(r)&&r.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)})),!0},i.physicalBasedRenderingChanged=function(){const e=this._usePBR();return this._materials.forEach((t=>t.material.setParameterValues({usePBR:e}))),!0},i.pixelRatioChanged=function(){return!0},i._requiresSymbolVertexColors=function(){return this._drivenProperties.color||this._drivenProperties.opacity},i._colorOrTextureUid=function(e){return n.isNone(e)?"-":e instanceof r?e.toHex():e.contentHash},i._materialPropertiesDefault=function(e,t){const r=this._requiresSymbolVertexColors(),o=!!e.vertexAttributes.color,n=!!e.vertexAttributes.tangent;return{hasSymbolVertexColors:r,hasVertexColors:o,hasVertexTangents:n,uid:`vc:${o},vt:${n},vct${t},svc:${r}`}},i._materialProperties=function(e,t,r){const o=this._materialPropertiesDefault(e,r);if(!t.material)return o;const{color:n,colorTexture:a,normalTexture:i,doubleSided:s,alphaCutoff:l,alphaMode:c}=t.material,u=this._colorOrTextureUid(n),m=this._colorOrTextureUid(a),f=this._colorOrTextureUid(i);if(o.color=n,o.colorTexture=a,o.normalTexture=i,o.uid=`${o.uid},cmuid:${u},ctmuid:${m},ntmuid:${f},ds:${s},ac:${l},am:${c}`,t.material instanceof d){const{metallic:e,roughness:r,metallicRoughnessTexture:n,emissiveColor:a,emissiveTexture:i,occlusionTexture:s}=t.material,l=this._colorOrTextureUid(n),c=this._colorOrTextureUid(a),u=this._colorOrTextureUid(i),m=this._colorOrTextureUid(s);o.metallic=e,o.roughness=r,o.metallicRoughnessTexture=n,o.emissiveColor=a,o.emissiveTexture=i,o.occlusionTexture=s,o.uid=`${o.uid},mrm:${e},mrr:${r},mrt:${l},emuid:${c},etmuid:${u},otmuid:${m}`}return o},i._setInternalColorValueParameters=function(e,t){t.diffuse=r.toUnitRGB(e),t.opacity=e.a},i._getLoadableTextureResource=function(e){return e.data?e.data:e.url},i._getInternalTextureId=function(e){const t=this._getLoadableTextureResource(e);if(!t)return;const r=e.contentHash;let o=this._textures.get(r);return o||(o=new R.Texture(t,{mipmap:!0,wrap:this._castTextureWrap(e.wrap),noUnpackFlip:!0,preMultiplyAlpha:!0}),this._textures.set(r,o),this._context.stage.add(o)),o.id},i._castTextureWrap=function(e="repeat"){if("string"==typeof e){const t=this._castTextureWrapIndividual(e);return{s:t,t}}return{s:this._castTextureWrapIndividual(e.horizontal),t:this._castTextureWrapIndividual(e.vertical)}},i._castTextureWrapIndividual=function(e){switch(e){case"clamp":return 33071;case"mirror":return 33648;case"repeat":default:return 10497}},i._setInternalMaterialParameters=function(e,t){n.isSome(e.color)&&this._setInternalColorValueParameters(e.color,t),n.isSome(e.colorTexture)&&(t.textureId=this._getInternalTextureId(e.colorTexture)),n.isSome(e.normalTexture)&&(t.normalTextureId=this._getInternalTextureId(e.normalTexture)),n.isSome(e.emissiveColor)&&(t.emissiveFactor=r.toUnitRGB(e.emissiveColor)),n.isSome(e.emissiveTexture)&&(t.emissiveTextureId=this._getInternalTextureId(e.emissiveTexture)),n.isSome(e.occlusionTexture)&&(t.occlusionTextureId=this._getInternalTextureId(e.occlusionTexture)),n.isSome(e.metallicRoughnessTexture)&&(t.metallicRoughnessTextureId=this._getInternalTextureId(e.metallicRoughnessTexture))},i._setExternalMaterialParameters=function(e){const t=this._drivenProperties.color;let o=n.isSome(this.symbolLayer.material)?this.symbolLayer.material.colorMixMode:null;if(t)e.externalColor=m.ONES;else{const t=n.isSome(this.symbolLayer.material)?this.symbolLayer.material.color:null;n.isSome(t)?e.externalColor=r.toUnitRGBA(t):(o=null,e.externalColor=m.ONES)}o&&(e.colorMixMode=o),e.castShadows=!!this.symbolLayer.castShadows},i._hasTransparentVertexColors=function(e){const t=e.vertexAttributes.color;if(n.isNone(t))return!1;for(let r=3;r<t.length;r+=4)if(255!==t[r])return!0;return!1},i._getOrCreateMaterial=function(e,t){const r=t.material&&t.material.color,o=t.material&&t.material.colorTexture,a=t.material&&"blend"===t.material.alphaMode,i=!(t.material&&"opaque"===t.material.alphaMode)&&(this._hasTransparentVertexColors(e)||n.isSome(r)&&r.a<1||n.isSome(o)&&o.transparent||a),s=this._materialProperties(e,t,i),l=this._materials.get(s.uid);if(l)return l.material;const c={material:null,isComponentTransparent:i,alphaMode:t.material?t.material.alphaMode:"opaque"},m=null==s.metallicRoughnessTexture&&null==s.metallic&&null==s.roughness,f={usePBR:this._usePBR(),isSchematic:m,vertexColors:s.hasVertexColors,symbolColors:s.hasSymbolVertexColors,vertexTangents:s.hasVertexTangents,ambient:u.ZEROS,diffuse:u.ONES,opacity:1,doubleSided:!0,doubleSidedType:"winding-order",cullFace:0,textureAlphaPremultiplied:!0,layerOpacity:this._getLayerOpacity(),slicePlaneEnabled:this._context.slicePlaneEnabled,initTextureTransparent:!0};m||(f.mrrFactors=[null!=s.metallic?s.metallic:1,null!=s.roughness?s.roughness:1,.5]),t.material&&(f.doubleSided=t.material.doubleSided,f.cullFace=t.material.doubleSided?0:2,f.textureAlphaCutoff=t.material.alphaCutoff),this._setInternalMaterialParameters(s,f),this._setExternalMaterialParameters(f),this._setMaterialTransparentParameter(f,c);const h=new N.DefaultMaterial(f);return c.material=h,this._materials.set(s.uid,c),this._context.stage.add(h),h},i._usePBR=function(){return this._context.physicalBasedRenderingEnabled},i._setMaterialTransparentParameter=function(e,t){e.transparent=this.needsDrivenTransparentPass||t.isComponentTransparent||e.layerOpacity<1||e.opacity<1||e.externalColor&&e.externalColor[3]<1,"auto"===t.alphaMode?e.textureAlphaMode=e.transparent?3:1:e.textureAlphaMode="opaque"===t.alphaMode?1:"mask"===t.alphaMode?2:0},i._addDebugNormals=function(e,t,r,o){const n=t.length,a=e.spatialReference.isGeographic?20015077/180:1,i=.1*Math.max(e.extent.width*a,e.extent.height*a,e.extent.zmax-e.extent.zmin),s=[],u=[],m=[],f=[];for(let l=0;l<n;l++){const e=t[l],r=e.vertexAttributes.get("position"),o=e.vertexAttributes.get("normal"),n=e.indices.get("position"),a=e.indices.get("normal"),h=r.data,p=o.data;for(let t=0;t<n.length;t++){const e=3*n[t],r=3*a[t];for(let t=0;t<3;t++)s.push(h[e+t]);for(let t=0;t<3;t++)s.push(h[e+t]+p[r+t]*i);if(u.push(u.length),u.push(u.length),t%3==0){this._calculateFaceNormal(h,n,t,G),this._getFaceVertices(h,n,t,V,D,L),c.add(V,V,D),c.add(V,V,L),c.scale(V,V,1/3);for(let e=0;e<3;e++)m.push(V[e]);for(let e=0;e<3;e++)m.push(V[e]+G[e]*i);f.push(f.length),f.push(f.length)}}}const h=new P.Geometry([["position",{data:s,size:3,exclusive:!0}]],[["position",new Uint32Array(u)]],2);t.push(h),r.push(this._debugVertexNormalMaterial),o.push(l.clone(o[0]));const p=new P.Geometry([["position",{data:m,size:3,exclusive:!0}]],[["position",new Uint32Array(f)]],2);t.push(p),r.push(this._debugFaceNormalMaterial),o.push(l.clone(o[0]))},i._createAs3DShape=function(e,t,r,o){const a=e.geometry;if("mesh"!==a.type)return null;const i=this._createGeometryInfo(a,t);if(!i)return null;const{geometries:s,materials:l,transformations:c,objectTransformation:u}=i;A.DRAW_MESH_GEOMETRY_NORMALS&&this._addDebugNormals(a,s,l,c);const m=new E.Object3D({geometries:s,materials:l,transformations:c,metadata:{layerUid:this._context.layer.uid,graphicUid:o}});m.transformation=u;const f=b.perObjectElevationAligner,h=this._createEdgeMaterial(),p=n.isSome(h)?{baseMaterial:l[0],edgeMaterials:[h],properties:{mergeGeometries:!0,slicePlaneEnabled:this._context.slicePlaneEnabled}}:null,d=new C.Graphics3DObject3DGraphicLayer(this,m,s,null,null,f,r,p);return d.needsElevationUpdates=v.needsElevationUpdates3D(r.mode),d.useObjectOriginAsAttachmentOrigin=!0,d.elevationContext.centerPointInElevationSR=this.getCenterPointInElevationSR(m),d.alignedSampledElevation=f(d,d.elevationContext,this._context.elevationProvider,this._context.renderCoordsHelper),d},i.getCenterPointInElevationSR=function(e){const t=y.makeDehydratedPoint(0,0,0,this._context.elevationProvider.spatialReference);return f.projectVectorToDehydratedPoint([e.transformation[12],e.transformation[13],e.transformation[14]],this._context.renderCoordsHelper.spatialReference,t),t},i._createComponentNormals=function(e,t,r,o){switch(r.shading||"flat"){case"source":return this._createComponentNormalsSource(e,t,r,o);case"flat":return this._createComponentNormalsFlat(e,o);case"smooth":return this._createComponentNormalsSmooth(e,o);default:return}},i._createComponentNormalsSource=function(e,t,r,o){if(n.isNone(t))return this._createComponentNormalsFlat(e,o);let a=!1;if(!r.trustSourceNormals)for(let n=0;n<o.length;n+=3){this._calculateFaceNormal(e,o,n,G);for(let e=0;e<3;e++){const r=3*o[n+e];V[0]=t[r+0],V[1]=t[r+1],V[2]=t[r+2],c.dot(G,V)<0&&(t[r+0]=-t[r+0],t[r+1]=-t[r+1],t[r+2]=-t[r+2],a=!0)}}return{normals:t,indices:o,didFlipNormals:a}},i._createComponentNormalsFlat=function(e,t){const r=new Float32Array(t.length),o=new Uint32Array(3*t.length);for(let n=0;n<t.length;n+=3){const a=this._calculateFaceNormal(e,t,n,G);for(let e=0;e<3;e++)r[n+e]=a[e],o[n+e]=n/3}return{normals:r,indices:o,didFlipNormals:!1}},i._createComponentNormalsSmooth=function(e,t){const r={};for(let a=0;a<t.length;a+=3){const o=this._calculateFaceNormal(e,t,a,G);for(let e=0;e<3;e++){const n=t[a+e];let i=r[n];i||(i={normal:u.create(),count:0},r[n]=i),c.add(i.normal,i.normal,o),i.count++}}const o=new Float32Array(3*t.length),n=new Uint32Array(3*t.length);for(let a=0;a<t.length;a++){const e=r[t[a]];1!==e.count&&(c.normalize(e.normal,e.normal),e.count=1);for(let t=0;t<3;t++)o[3*a+t]=e.normal[t];n[a]=a}return{normals:o,indices:n,didFlipNormals:!1}},i._getFaceVertices=function(e,t,r,o,n,a){const i=3*t[r+0],s=3*t[r+1],l=3*t[r+2];o[0]=e[i+0],o[1]=e[i+1],o[2]=e[i+2],n[0]=e[s+0],n[1]=e[s+1],n[2]=e[s+2],a[0]=e[l+0],a[1]=e[l+1],a[2]=e[l+2]},i._calculateFaceNormal=function(e,t,r,o){return this._getFaceVertices(e,t,r,V,D,L),c.subtract(D,D,V),c.subtract(L,L,V),c.cross(V,D,L),c.normalize(o,V),o},i._getOrCreateComponents=function(e){return e.components?e.components:k},i._createPositionBuffer=function(e,t){let r=e.vertexAttributes.position;const o=1===t.reprojection?t.transformBeforeProject:null;if(n.isSome(o)&&(r=_.transformPosition(r,new Float64Array(r.length),o)),0===t.reprojection)return t.needsBufferCopy?new Float64Array(r):r;const a=n.isSome(o)?r:new Float64Array(r.length);return f.projectBuffer(r,e.spatialReference,0,a,this._context.renderCoordsHelper.spatialReference,0,r.length/3),a},i._createNormalBuffer=function(e,t,r){let o=e.vertexAttributes.normal;if(n.isNone(o))return null;const a=1===r.reprojection?r.transformBeforeProject:null;n.isSome(a)&&(o=_.transformNormal(o,new Float32Array(o.length),a));if("local"===this._context.layerView.view.viewingMode||0===r.reprojection)return r.needsBufferCopy&&e.vertexAttributes.normal===o?new Float32Array(o):o;const i=e.vertexAttributes.position,s=n.isSome(a)?o:new Float32Array(o.length);return _.projectNormalToPCPF(o,i,t,e.spatialReference,s)},i._createTangentBuffer=function(e,t,r){let o=e.vertexAttributes.tangent;if(n.isNone(o))return null;const a=1===r.reprojection?r.transformBeforeProject:null;n.isSome(a)&&(o=_.transformTangent(o,new Float32Array(o.length),a));if("local"===this._context.layerView.view.viewingMode||0===r.reprojection)return r.needsBufferCopy&&e.vertexAttributes.normal===o?new Float32Array(o):o;const i=e.vertexAttributes.position,s=n.isSome(a)?o:new Float32Array(o.length);return _.projectTangentToPCPF(o,i,t,e.spatialReference,s)},i._createColorBuffer=function(e){return e.vertexAttributes.color},i._createSymbolColorBuffer=function(e){if(this._requiresSymbolVertexColors()){const t=this._getVertexOpacityAndColor(e),r=w.parseColorMixMode(n.get(this.symbolLayer,"material","colorMixMode")),o=new Uint8Array(4);return w.encodeSymbolColor(t,r,o),o}return null},i._createBuffers=function(e,t){const r=e.vertexAttributes&&e.vertexAttributes.position;if(!r)return this.logger.warn("Mesh geometry must contain position vertex attributes"),null;const o=e.vertexAttributes.normal,a=e.vertexAttributes.uv,i=e.vertexAttributes.tangent;if(n.isSome(o)&&o.length!==r.length)return this.logger.warn("Mesh normal vertex buffer must contain the same number of elements as the position buffer"),null;if(n.isSome(i)&&i.length/4!=r.length/3)return this.logger.warn("Mesh tangent vertex buffer must contain the same number of elements as the position buffer"),null;if(n.isSome(a)&&a.length/2!=r.length/3)return this.logger.warn("Mesh uv vertex buffer must contain the same number of elements as the position buffer"),null;const s=this._computeReprojectionInfo(e),c=this._createPositionBuffer(e,s),u=this._createColorBuffer(e),m=this._createSymbolColorBuffer(t),f=this._createNormalBuffer(e,c,s),h=this._createTangentBuffer(e,c,s);return{positionBuffer:c,normalBuffer:f,tangentBuffer:h,uvBuffer:a,colorBuffer:u,symbolColorBuffer:m,objectTransformation:0===s.reprojection&&n.isSome(s.objectTransformation)?s.objectTransformation:this._transformOriginLocal(e,c,f,h),geometryTransformation:0===s.reprojection&&n.isSome(s.geometryTransformation)?s.geometryTransformation:l.create()}},i._computeReprojectionInfo=function(e){const t=n.isSome(e.transform)&&e.transform.geographic||2===this._context.renderCoordsHelper.viewingMode?0:1;let r=null;if(n.isSome(e.transform)){if(0===t){const r=l.create();f.computeLinearTransformation(e.spatialReference,e.transform.origin,r,this._context.renderCoordsHelper.spatialReference);return{reprojection:t,objectTransformation:r,geometryTransformation:l.clone(e.transform.localMatrix),needsBufferCopy:!1}}return r=s.fromTranslation(l.create(),e.transform.origin),s.multiply(r,r,e.transform.localMatrix),{reprojection:t,transformBeforeProject:r,needsBufferCopy:!0}}return{reprojection:t,needsBufferCopy:!0}},i._transformOriginLocal=function(e,t,r,o){const i=this._context.renderCoordsHelper.spatialReference,c=e.anchor;I[0]=c.x,I[1]=c.y,I[2]=c.z;const u=l.create();f.computeLinearTransformation(e.spatialReference,I,u,i);const m=g.BufferViewVec3f64.fromTypedArray(t);if(s.invert(U,u),x.transformMat4(m,m,U),n.isSome(r)||n.isSome(o)){if(a.fromMat4($,u),a.transpose($,$),n.isSome(r)){const e=g.BufferViewVec3f.fromTypedArray(r);x.transformMat3(e,e,$)}if(n.isSome(o)){const e=g.BufferViewVec3f.fromTypedArray(o,4*o.BYTES_PER_ELEMENT);x.transformMat3(e,e,$)}}return u},i._validateFaces=function(e,t){const r=e.vertexAttributes.position.length/3,o=t.faces;if(o){let e=-1;for(let t=0;t<o.length;t++){const r=o[t];r>e&&(e=r)}if(r<=e)return this.logger.warn(`Vertex index ${e} is out of bounds of the mesh position buffer`),!1}else if(r%3!=0)return this.logger.warn("Mesh position buffer length must be a multiple of 9 if no component faces are defined (3 values per vertex * 3 vertices per triangle)"),!1;return!0},i._getOrCreateFaces=function(e,t){return t.faces?t.faces:B.generateDefaultIndexArray(e.vertexAttributes.position.length/3)},i._isOutsideClippingArea=function(e){if(!this._context.clippingExtent)return!1;const t=e.vertexAttributes&&e.vertexAttributes.position;if(!t)return!1;const r=this._context.elevationProvider.spatialReference;let o;const n=t.length/3;return e.spatialReference.equals(r)?o=t:(o=new Float64Array(t.length),f.projectBuffer(e.vertexAttributes.position,e.spatialReference,0,o,r,0,n)),h.empty(z),h.expandWithBuffer(z,o,0,n),!h.intersectsClippingArea(z,this._context.clippingExtent)},i._createGeometryInfo=function(e,t){if(!f.canProjectWithoutEngine(e.spatialReference,this._context.layerView.view.spatialReference))return this.logger.warn("Geometry spatial reference is not compatible with the view"),null;if(this._isOutsideClippingArea(e))return null;const r=this._createBuffers(e,t);if(n.isNone(r))return null;const{positionBuffer:o,uvBuffer:a,colorBuffer:i,symbolColorBuffer:s,normalBuffer:l,tangentBuffer:c,objectTransformation:u,geometryTransformation:m}=r,h=this._getOrCreateComponents(e),p=[],d=[],g=[];let x=!1;for(const f of h){if(!this._validateFaces(e,f))return null;const t=this._getOrCreateFaces(e,f);if(0===t.length)continue;const r=this._createComponentNormals(o,l,f,t);r.didFlipNormals&&(x=!0);const u=[["position",{size:3,data:o,exclusive:!0}],["normal",{size:3,data:r.normals,exclusive:!0}]],h=[["position",t],["normal",r.indices]];n.isSome(i)&&(u.push(["color",{size:4,data:i,exclusive:!0}]),h.push(["color",t])),n.isSome(s)&&(u.push(["symbolColor",{size:4,data:s,exclusive:!0}]),h.push(["symbolColor",new Uint16Array(t.length)])),n.isSome(a)&&(u.push(["uv0",{size:2,data:a,exclusive:!0}]),h.push(["uv0",t])),n.isSome(c)&&(u.push(["tangent",{size:4,data:c,exclusive:!0}]),h.push(["tangent",t]));const _=new P.Geometry(u,h);p.push(_),d.push(m),g.push(this._getOrCreateMaterial(e,f))}return x&&this.logger.warn("Normals have been automatically flipped to be consistent with the counter clock wise face winding order. It is better to generate mesh geometries that have consistent normals."),{geometries:p,transformations:d,materials:g,objectTransformation:u}},i._createEdgeMaterial=function(){const e={opacity:this._getLayerOpacity()};return M.createMaterial(this.symbolLayer,e)},o}(S.Graphics3DSymbolLayer);const I=u.create(),V=u.create(),D=u.create(),L=u.create(),G=u.create(),U=l.create(),$=i.create(),z=h.create(),k=[new p];e.Graphics3DMeshFillSymbolLayer=j,e.default=j,Object.defineProperty(e,"__esModule",{value:!0})}));
