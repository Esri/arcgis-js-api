/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../request","../../../../core/asyncUtils","../../../../core/Error","../../../../core/Logger","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/Version","../../../../chunks/vec3f64","../../../../geometry/support/aaBoundingBox","../../../../support/requestImageUtils","../../webgl-engine/lib/basicInterfaces","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/Texture","../../webgl-engine/materials/DefaultMaterial","../../../webgl/enums"],(function(e,t,r,n,a,s,o,i,u,l,c,p,d,f,m,y,g){"use strict";const x=s.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");function h(e,t){return b.apply(this,arguments)}function b(){return(b=t._asyncToGenerator((function*(e,t){const r=yield v(e,t);return{resource:r,textures:yield E(r.textureDefinitions,t)}}))).apply(this,arguments)}function v(e,t){return w.apply(this,arguments)}function w(){return(w=t._asyncToGenerator((function*(e,t){const a=o.isSome(t)&&t.streamDataRequester;if(a)return A(e,a,t);const s=yield n.result(r(e,o.unwrap(t)));if(!0===s.ok)return s.value.data;i.throwIfAbortError(s.error),T(s.error)}))).apply(this,arguments)}function A(e,t,r){return M.apply(this,arguments)}function M(){return(M=t._asyncToGenerator((function*(e,t,r){const a=yield n.result(t.request(e,"json",r));if(!0===a.ok)return a.value;i.throwIfAbortError(a.error),T(a.error.details.url)}))).apply(this,arguments)}function T(e){throw new a("",`Request for object resource failed: ${e}`)}function I(e){const t=e.params,r=t.topology;let n=!0;switch(t.vertexAttributes||(x.warn("Geometry must specify vertex attributes"),n=!1),t.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:{const e=t.faces;if(e){if(t.vertexAttributes)for(const r in t.vertexAttributes){const t=e[r];t&&t.values?(null!=t.valueType&&"UInt32"!==t.valueType&&(x.warn(`Unsupported indexed geometry indices type '${t.valueType}', only UInt32 is currently supported`),n=!1),null!=t.valuesPerElement&&1!==t.valuesPerElement&&(x.warn(`Unsupported indexed geometry values per element '${t.valuesPerElement}', only 1 is currently supported`),n=!1)):(x.warn(`Indexed geometry does not specify face indices for '${r}' attribute`),n=!1)}}else x.warn("Indexed geometries must specify faces"),n=!1;break}default:x.warn(`Unsupported topology '${r}'`),n=!1}e.params.material||(x.warn("Geometry requires material"),n=!1);const a=e.params.vertexAttributes;for(const s in a){a[s].values||(x.warn("Geometries with externally defined attributes are not yet supported"),n=!1)}return n}function P(e,t){const r=[],n=[],a=[],s=[],i=e.resource,c=u.Version.parse(i.version||"1.0","wosr");q.validate(c);const p=i.model.name,g=i.model.geometries,x=i.materialDefinitions,h=e.textures;let b=0;const v=new Map;for(let u=0;u<g.length;u++){const e=g[u];if(!I(e))continue;const i=B(e),c=e.params.vertexAttributes,p=[];for(const t in c){const e=c[t],r=e.values;p.push([t,{data:r,size:e.valuesPerElement,exclusive:!0}])}const w=[];if("PerAttributeArray"!==e.params.topology){const t=e.params.faces;for(const e in t)w.push([e,new Uint32Array(t[e].values)])}const A=h&&h[i.texture];if(A&&!v.has(i.texture)){const{image:e,params:t}=A,r=new m.Texture(e,t);s.push(r),v.set(i.texture,r)}const M=v.get(i.texture),T=M?M.id:void 0;let P=a[i.material]?a[i.material][i.texture]:null;if(!P){const e=x[i.material.substring(i.material.lastIndexOf("/")+1)].params;1===e.transparency&&(e.transparency=0);const r=A&&A.alphaChannelUsage,n=e.transparency>0||"transparency"===r||"maskAndTransparency"===r,s=A?D(A.alphaChannelUsage):void 0,u={ambient:l.fromArray(e.diffuse),diffuse:l.fromArray(e.diffuse),opacity:1-(e.transparency||0),transparent:n,textureAlphaMode:s,textureAlphaCutoff:.33,textureId:T,initTextureTransparent:!0,doubleSided:!0,cullFace:d.CullFaceOptions.None,colorMixMode:e.externalColorMixMode||"tint",textureAlphaPremultiplied:!!A&&!!A.params.preMultiplyAlpha};o.isSome(t)&&t.materialParamsMixin&&Object.assign(u,t.materialParamsMixin),P=new y.DefaultMaterial(u),a[i.material]||(a[i.material]={}),a[i.material][i.texture]=P}n.push(P);const U=new f.Geometry(p,w);b+=w.position?w.position.length:0,r.push(U)}return{name:p,stageResources:{textures:s,materials:n,geometries:r},pivotOffset:i.model.pivotOffset,boundingBox:U(r),numberOfVertices:b,lodThreshold:null}}function U(e){const t=c.empty();return e.forEach((e=>{const r=e.boundingInfo;o.isSome(r)&&(c.expandWithVec3(t,r.getBBMin()),c.expandWithVec3(t,r.getBBMax()))})),t}function E(e,t){return k.apply(this,arguments)}function k(){return(k=t._asyncToGenerator((function*(e,t){const r=[];for(const s in e){const n=e[s],a=n.images[0].data;if(!a){x.warn("Externally referenced texture data is not yet supported");continue}const i=n.encoding+";base64,"+a,u="/textureDefinitions/"+s,l="rgba"===n.channels?n.alphaChannelUsage||"transparency":"none",c={noUnpackFlip:!0,wrap:{s:g.TextureWrapMode.REPEAT,t:g.TextureWrapMode.REPEAT},preMultiplyAlpha:D(l)!==d.AlphaDiscardMode.Opaque},f=o.isSome(t)&&t.disableTextures?Promise.resolve(null):p.requestImage(i,t);r.push(f.then((e=>({refId:u,image:e,params:c,alphaChannelUsage:l}))))}const n=yield Promise.all(r),a={};for(const s of n)a[s.refId]=s;return a}))).apply(this,arguments)}function D(e){switch(e){case"mask":return d.AlphaDiscardMode.Mask;case"maskAndTransparency":return d.AlphaDiscardMode.MaskBlend;case"none":return d.AlphaDiscardMode.Opaque;default:return d.AlphaDiscardMode.Blend}}function B(e){const t=e.params;return{id:1,material:t.material,texture:t.texture,region:t.texture}}const q=new u.Version(1,2,"wosr");e.createTextureResources=E,e.load=h,e.processLoadResult=P,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
