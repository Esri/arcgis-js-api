// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../request","../../../../core/asyncUtils","../../../../core/Error","../../../../core/lang","../../../../core/Logger","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/Version","../../../../core/libs/gl-matrix-2/vec3f64","../../../../geometry/support/aaBoundingBox","../../support/imageUtils","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryData","../../webgl-engine/lib/Texture","../../webgl-engine/materials/DefaultMaterial"],function(e,r,t,n,a,i,s,o,u,l,c,p,d,f,m,v,g,y,x,h){function b(e,r){return a(this,void 0,void 0,function(){var t;return n(this,function(n){switch(n.label){case 0:return[4,w(e,r)];case 1:return t=n.sent(),[2,M(t,r)]}})})}function w(e,r){return a(this,void 0,void 0,function(){var t,a;return n(this,function(n){switch(n.label){case 0:return t=c.isSome(r)&&r.streamDataRequester,t?[2,A(e,t,r)]:[4,s.result(i(e,c.unwrap(r)))];case 1:return a=n.sent(),!0===a.ok?[2,a.value.data]:(p.throwIfAbortError(a.error),U(a.error),[2,void 0])}})})}function A(e,r,t){return a(this,void 0,void 0,function(){var a;return n(this,function(n){switch(n.label){case 0:return[4,s.result(r.request(e,"json",t))];case 1:return a=n.sent(),!0===a.ok?[2,a.value]:(p.throwIfAbortError(a.error),U(a.error.details.url),[2,void 0])}})})}function U(e){throw new o("","Request for object resource failed: "+e)}function I(e){var r=e.params,t=r.topology,n=!0;switch(r.vertexAttributes||(B.warn("Geometry must specify vertex attributes"),n=!1),r.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:var a=r.faces;if(a){if(r.vertexAttributes)for(var i in r.vertexAttributes){var s=a[i];s&&s.values?(null!=s.valueType&&"UInt32"!==s.valueType&&(B.warn("Unsupported indexed geometry indices type '"+s.valueType+"', only UInt32 is currently supported"),n=!1),null!=s.valuesPerElement&&1!==s.valuesPerElement&&(B.warn("Unsupported indexed geometry values per element '"+s.valuesPerElement+"', only 1 is currently supported"),n=!1)):(B.warn("Indexed geometry does not specify face indices for '"+i+"' attribute"),n=!1)}}else B.warn("Indexed geometries must specify faces"),n=!1;break;default:B.warn("Unsupported topology '"+t+"'"),n=!1}e.params.material||(B.warn("Geometry requires material"),n=!1);var o=e.params.vertexAttributes;for(var u in o){o[u].values||(B.warn("Geometries with externally defined attributes are not yet supported"),n=!1)}return n}function M(e,r){return a(this,void 0,void 0,function(){var t,a,i,s,o,l,p,m,v,x,b,w,A,U,M,B,S,j,D,C,G,R,V,H,_,z,F,L,J,K,N,Q,W,X;return n(this,function(n){switch(n.label){case 0:return t=[],a=[],i=[],s=[],o=d.Version.parse(e.version||"1.0","wosr"),O.validate(o),l="meshsymbol_"+e.model.name,p=e.textureDefinitions,[4,k(l,p,r)];case 1:m=n.sent();for(v in m)s.push(m[v].engineTexObj);for(x=e.model.geometries,b=e.materialDefinitions,w=0,A=0;A<x.length;A++)if(U=x[A],I(U)){M=E(U),B=U.params.vertexAttributes,S={};for(j in B)D=B[j],C=D.values,S[j]={data:C,size:D.valuesPerElement};if(G={},"PerAttributeArray"===U.params.topology){R=S.position.data.length/S.position.size,V=q(R);for(H in S)G[H]=V}else{_=U.params.faces;for(z in _)G[z]=new Uint32Array(_[z].values)}F=M.texture?m[M.texture]:null,L=i[M.material]?i[M.material][M.texture]:null,L||(J=M.material.substring(M.material.lastIndexOf("/")+1),K=b[J].params,1===K.transparency&&(K.transparency=0),N=F&&F.alphaChannelUsage,Q=K.transparency>0||"transparency"===N||"maskAndTransparency"===N,W={ambient:f.vec3f64.fromArray(K.diffuse),diffuse:f.vec3f64.fromArray(K.diffuse),specular:[0,0,0],opacity:1-(K.transparency||0),transparent:Q,textureAlphaMode:F?P(F.alphaChannelUsage):void 0,textureAlphaCutoff:.33,textureId:F?F.engineTexObj.id:void 0,textureInitTransparent:!0,doubleSided:!0,cullFace:"none",flipV:!1,colorMixMode:K.externalColorMixMode||"tint",textureAlphaPremultiplied:!0},c.isSome(r)&&r.materialParamsMixin&&u.mixin(W,r.materialParamsMixin),L=new h(W,l),i[M.material]||(i[M.material]={}),i[M.material][M.texture]=L),a.push(L),X=new g(new y.GeometryData(S,G),l),w+=G.position?G.position.length:0,t.push(X)}return[2,{name:l,stageResources:{textures:s,materials:a,geometries:t},pivotOffset:e.model.pivotOffset,boundingBox:T(t),numberOfVertices:w,lodThreshold:null}]}})})}function T(e){var r=m.empty();return e.forEach(function(e){var t=e.boundingInfo;m.expand(r,t.getBBMin()),m.expand(r,t.getBBMax())}),r}function k(e,r,t){return a(this,void 0,void 0,function(){var a,i,s,o,u,l,d,f;return n(this,function(n){switch(n.label){case 0:a=[],i=function(n){var i=r[n],s=i.images[0].data;if(!s)return B.warn("Externally referenced texture data is not yet supported"),"continue";var o=i.encoding+";base64,"+s,u="/textureDefinitions/"+n,l={noUnpackFlip:!0,wrap:{s:10497,t:10497},preMultiplyAlpha:!0},d=c.isSome(t)&&t.disableTextures?p.resolve(null):v.requestImage(o,t);a.push(d.then(function(r){return{refId:u,engineTexObj:new x(r,e,l),alphaChannelUsage:"rgba"===i.channels?i.alphaChannelUsage||"transparency":"none"}}))};for(s in r)i(s);return[4,p.all(a)];case 1:for(o=n.sent(),u={},l=0,d=o;l<d.length;l++)f=d[l],u[f.refId]=f;return[2,u]}})})}function P(e){switch(e){case"mask":return"mask";case"maskAndTransparency":return"maskBlend";case"none":return"opaque";case"transparency":default:return"blend"}}function E(e){var r=e.params;return{id:1,material:r.material,texture:r.texture,region:r.texture}}function q(e){for(var r=new Uint32Array(e),t=0;t<e;t++)r[t]=t;return r}Object.defineProperty(r,"__esModule",{value:!0});var B=l.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");r.load=b,r.createStageResources=M;var O=new d.Version(1,2,"wosr")});