/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../geometry","../../../../renderers/ClassBreaksRenderer","../../../../renderers/DictionaryRenderer","../../../../renderers/DotDensityRenderer","../../../../renderers/HeatmapRenderer","../../../../renderers/PieChartRenderer","../../../../renderers/Renderer","../../../../renderers/SimpleRenderer","../../../../renderers/UniqueValueRenderer","../../../../renderers/support/jsonUtils","../../../../symbols","../../../../core/Accessor","../../../../core/has","../../../../core/Error","../../../../core/Handles","../../../../core/handleUtils","../../../../core/Logger","../../../../core/MapUtils","../../../../core/maybe","../../../../core/PooledArray","../../../../core/promiseUtils","../../../../core/reactiveUtils","../../../../core/scheduling","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/accessorSupport/decorators/subclass","../../../../core/accessorSupport/diffUtils","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/projection","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/spatialReferenceUtils","../../../../layers/Layer","../../../../layers/graphics/dehydratedFeatures","../../../../layers/graphics/hydratedFeatures","../../../../renderers/support/rendererConversion","../../../../support/arcadeOnDemand","../../../../symbols/support/defaults3D","../../../../symbols/support/symbolConversion","./ElevationQuery","./enums","./featureExpressionInfoUtils","./Graphics3DFeatureStore","./Graphics3DGraphicCreationContext","./Graphics3DSymbolCreationContext","./Graphics3DSymbolFactory","./Graphics3DWebStyleSymbol","./GraphicStateTracking","./graphicUtils","./interfaces","./Loadable","./SpatialIndex2D","./symbolComplexity","../support/StageLayerElevationProvider","../../support/extentUtils","../../support/PropertiesPool","../../webgl-engine/lib/GridLocalOriginFactory","../../webgl-engine/lib/UpdatePolicy","../../webgl-engine/lib/WebGLLayer","../../../support/Scheduler","../../../../geometry/Extent","../../../../geometry/Point","../../../../symbols/LabelSymbol3D","../../../../symbols/TextSymbol","../../../../symbols/WebStyleSymbol"],(function(e,i,t,r,s,n,a,o,l,h,c,d,p,y,u,g,m,b,_,f,S,v,C,G,w,D,P,x,R,I,E,U,A,O,V,L,F,k,T,N,M,j,z,W,B,H,q,Y,$,Z,J,Q,X,K,ee,ie,te,re,se,ne,ae,oe,le,he,ce,de,pe,ye,ue,ge){"use strict";var me;const be=A.create(),_e=V.create(),fe="esri.views.3d.layers.graphics.Graphics3DCore",Se=f.getLogger(fe);var ve;e.Graphics3DCore=me=function(e){i._inheritsLoose(r,e);var t=r.prototype;function r(t){var r;return(r=e.call(this,t)||this)._propertiesPool=new ae.PropertiesPool({computedExtent:de},i._assertThisInitialized(r)),r.computedExtent=null,r.currentRenderer=null,r.rendererHasGeometryOperations=!1,r._graphicStateTracking=null,r.graphics3DGraphics=new Map,r.stageLayer=null,r.stage=null,r._graphicsDrapedUids=new Set,r._graphicsBySymbol=new Map,r._symbolConversionCache=new Map,r._symbols=new Map,r._graphicsWithoutSymbol=new Map,r._graphicsWaitingForSymbol=new Map,r._graphicsUpdateId=0,r._handles=new b,r._frameTask=ce.ImmediateTask,r._suspendSymbolCleanup=!1,r._arcadeOnDemand=null,r._rendererChangeAbortController=null,r._elevationInfoChangeAbortController=null,r._initializeAbortController=null,r._scaleVisibility=null,r._filterVisibility=null,r._spatialIndex=null,r.extentPadding=0,r._updatingPendingLoadedGraphicsChange=null,r._featureStore=null,r._deconflictor=null,r._labeler=null,r._objectStates=null,r._viewElevationProvider=null,r._stageLayerElevationProvider=null,r._sharedSymbolResourcesOwnerHandle=null,r._whenGraphics3DGraphicRequests={},r._pendingUpdates=new Map,r._numberOfGraphics=0,r._numberOfGraphicsProvidingElevation=0,r._pendingAdds=0,r._pendingRemoves=0,r._applyPendingRemovesFirst=!1,r._loadingSymbols=0,r._pendingUpdatesPool=new C({allocator:e=>e||new Ce,deallocator:e=>(e.clear(),e)}),r._symbolWarningLogged=!1,r._geometryWarningLogged=!1,r._objectIdInvisibleSet=new Set,r._whenSymbolRemoved=new C,r.preferredUpdatePolicy=le.UpdatePolicy.SYNC,r._forcedUpdatePolicy=null,r.elevationFeatureExpressionEnabled=!0,r.owner=null,r.layer=null,r.graphicSymbolSupported=!0,r.getRenderingInfoWithoutRenderer=!1,r.setUidToIdOnAdd=!0,r.hasZ=null,r.hasM=null,r._usedMemory=0,r._visible=!1,r._startCreateGraphics=!1,r.symbolCreationContext=new Z.Graphics3DSymbolCreationContext(t.owner.view.resourceController.scheduler,((e,i)=>r._frameTask.schedule(e,i))),r}return t._getConvertedSymbol=function(e){if("web-style"===e.type)return e.clone();const i=this._symbolConversionCache.get(e.id);if(v.isSome(i))return i;const t=W.to3D(e,{geometryType:this.layer?.geometryType??void 0,retainId:!0,hasLabelingContext:this._hasLabelingContext(e)}),r=t.symbol||null;return v.isNone(r)&&t.error&&Se.error(t.error.message),this._symbolConversionCache.set(e.id,r),r},t._getSymbolComplexitiesUsedOrRenderer=function(e){if(v.isNone(e))return[];const i=e.getSymbols(),t="backgroundFillSymbol"in e?e.backgroundFillSymbol:null;if(!(t||i&&i.length))return[];const r=[],s=this._getSymbolComplexityUsedOrRenderer(t);v.isSome(s)&&r.push(s);for(const n of i){const e=this._getSymbolComplexityUsedOrRenderer(n);v.isSome(e)&&r.push(e)}return r},t._getSymbolComplexityUsedOrRenderer=function(e){if(v.isNone(e))return null;const i=this._symbols.get(e.id);if(v.isSome(i))return i.complexity;const t=this._getConvertedSymbol(e);return v.isSome(t)?re.defaultSymbolComplexity(t):null},t._getSymbolComplexitiesUsed=function(){const e=[];return this._symbols.forEach((i=>{v.isSome(i)&&e.push(i.complexity)})),e},t.initialize=function(){this._featureStore=new Y.Graphics3DFeatureStore({objectIdField:this.owner.layer&&this.owner.layer.objectIdField,hasZ:!!this.hasZ,hasM:!!this.hasM,viewSpatialReference:this._viewSpatialReference,featureSpatialReference:this.owner.featureSpatialReference,getSpatialIndex:()=>this.spatialIndex,forEach:e=>this.graphics3DGraphics.forEach(e)});const e=(e,i,t)=>this.spatialIndex.queryGraphicUIDsInExtent(e,i,t),{componentFactories:i}=this;if(v.isSome(i.elevationAlignment)){const t=i.elevationAlignment(this,e);this._elevationAlignment=t}if(v.isSome(i.scaleVisibility)){const t=i.scaleVisibility(this,e);this._scaleVisibility=t}if(v.isSome(i.filterVisibility)){const e=i.filterVisibility({featureStore:this._featureStore,getFeatureCount:()=>this.graphics3DGraphics.size,updateFeatureVisibilities:e=>this.modifyGraphics3DGraphicVisibilities((i=>i.setVisibilityFlag(H.VisibilityFlag.FILTER,e(T.getObjectId(i.graphic,this._objectIdField)),H.VisibilityGroup.GRAPHIC))),setAllFeaturesVisibility:e=>this.modifyGraphics3DGraphicVisibilities((i=>i.setVisibilityFlag(H.VisibilityFlag.FILTER,e,H.VisibilityGroup.GRAPHIC))),clearFeaturesVisibility:()=>this.modifyGraphics3DGraphicVisibilities((e=>e.clearVisibilityFlag(H.VisibilityFlag.FILTER)))});this._filterVisibility=e}if(v.isSome(i.deconflictor)){const e=i.deconflictor(this);this._deconflictor=e}if(v.isSome(i.labeler)&&v.isSome(this._scaleVisibility)){const e=i.labeler(this,this._scaleVisibility);this._labeler=e}if(v.isSome(i.objectStates)){const e=i.objectStates(this);this._objectStates=e}this._initializeAbortController=new AbortController,this._initializePromise=this._initializeAsync()},t._initializeAsync=function(){var e=i._asyncToGenerator((function*(){const e=this._initializeAbortController?.signal,i=this.owner.view;this._viewElevationProvider=new B.ViewElevationProvider(this._viewSpatialReference,i),this._initializeStage(i,this.layer.uid);const t=i.sharedSymbolResources;this.symbolCreationContext.sharedResources=t,this._sharedSymbolResourcesOwnerHandle=t.addGraphicsOwner(this.owner),v.isSome(this.currentRenderer)&&(this.symbolCreationContext.renderer=this.currentRenderer),this.symbolCreationContext.stage=this.stage,this.symbolCreationContext.streamDataRequester=t.streamDataRequester,this.symbolCreationContext.renderCoordsHelper=i.renderCoordsHelper,this.symbolCreationContext.layer=this.layer,this.symbolCreationContext.graphicsCoreOwner=this.owner,this.symbolCreationContext.localOriginFactory=new oe.GridLocalOriginFactory(i.renderSpatialReference),this.symbolCreationContext.elevationProvider=i.elevationProvider,this.symbolCreationContext.notifyGraphicGeometryChanged=e=>this.notifyGraphicGeometryChanged(e),this.symbolCreationContext.notifyGraphicVisibilityChanged=e=>this.notifyGraphicVisibilityChanged(e);const r=q.extractExpressionInfo(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);if(this.symbolCreationContext.featureExpressionInfoContext=yield q.createContext(r,this._viewSpatialReference,e,Se),G.throwIfAborted(e),this.symbolCreationContext.screenSizePerspectiveEnabled=i.screenSizePerspectiveEnabled&&!!this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this.symbolCreationContext.physicalBasedRenderingEnabled=!!this.owner.view.qualitySettings?.physicallyBasedRenderingEnabled,this.symbolCreationContext.skipHighSymbolLods=!!this.owner.view.qualitySettings?.graphics3D?.skipHighSymbolLods,"drapeSourceType"in this.owner){const{owner:e}=this;this.symbolCreationContext.drapeSourceRenderer=i.basemapTerrain.overlayManager.registerGeometryDrapeSource(e),this._handles.add(_.makeHandle((()=>i.basemapTerrain.overlayManager.unregisterDrapeSource(e))))}this._handles.add([w.watch((()=>this.suspendedOrOutsideOfView),(()=>this._frameTask.reschedule((()=>this._updateLayerVisibility())))),w.watch((()=>[this.layer?.screenSizePerspectiveEnabled,this.owner.view.screenSizePerspectiveEnabled]),(()=>{const e=i.screenSizePerspectiveEnabled&&!!this.layer.screenSizePerspectiveEnabled;e!==this.symbolCreationContext.screenSizePerspectiveEnabled&&(this.symbolCreationContext.screenSizePerspectiveEnabled=e,this._labeler?.reset(),this.recreateAllGraphicsAndSymbols())})),w.watch((()=>this.owner.slicePlaneEnabled),(e=>this._slicePlaneEnabledChange(!!e))),w.watch((()=>this.owner.view.state?.rasterPixelRatio),(()=>this._pixelRatioChange())),w.watch((()=>!!this.owner.view.qualitySettings?.physicallyBasedRenderingEnabled),(e=>this._physicalBasedRenderingChange(e))),w.watch((()=>!!this.owner.view.qualitySettings?.graphics3D?.skipHighSymbolLods),(e=>this._skipHighSymbolLoDsChange(e))),w.when((()=>i.basemapTerrain?.tilingScheme),(e=>{if(!e.spatialReference.equals(this.symbolCreationContext.overlaySR)&&v.isSome(i.basemapTerrain.spatialReference)&&(this.symbolCreationContext.overlaySR=i.basemapTerrain.spatialReference),this._handles.has("loaded-graphics"))this.recreateAllGraphics();else{const e=()=>this.owner?.loadedGraphics;this._handles.add([w.on(e,"change",(e=>{this._graphicsCollectionChanged(e),this._signalUpdatingDuringAsyncLoadedGraphicsChange()}),{onListenerAdd:()=>{this.recreateAllGraphics(),this._signalUpdatingDuringAsyncLoadedGraphicsChange()}})],"loaded-graphics")}}),{initial:!0}),w.watch((()=>this.effectiveUpdatePolicy),(e=>{v.isSome(this.stageLayer)&&(this.stageLayer.updatePolicy=e),this.symbolCreationContext.isAsync=this.effectiveUpdatePolicy===le.UpdatePolicy.ASYNC,e===le.UpdatePolicy.SYNC&&this.runTask(ce.noBudget)}),w.syncAndInitial)]),this._frameTask=i.resourceController.scheduler.registerTask(ce.TaskPriority.GRAPHICS_CORE,this),this.layer&&"featureReduction"in this.layer&&this._handles.add(w.watch((()=>this.layer.featureReduction),(()=>this._deconflictor.featureReductionChange()))),this.notifyChange("averageSymbolComplexity"),this.rendererChange(this.owner.renderer).catch((()=>{})),this._initializeAbortController=null}));function t(){return e.apply(this,arguments)}return t}(),t._abortInitialize=function(){this._initializeAbortController&&(this._initializeAbortController.abort(),this._initializeAbortController=null)},t.destroy=function(){this._abortInitialize(),this._abortRendererChange(),this._abortElevationInfoChange(),this._frameTask.remove(),this._frameTask=ce.ImmediateTask,this.owner.view.deconflictor.removeGraphicsOwner(this),this.owner.view.labeler.removeGraphicsOwner(this),this._elevationAlignment=v.destroyMaybe(this._elevationAlignment),this._scaleVisibility=v.destroyMaybe(this._scaleVisibility),this._filterVisibility=v.destroyMaybe(this._filterVisibility),this._deconflictor=null,this._labeler=null,this._objectStates=v.destroyMaybe(this._objectStates),this.clear(),this._featureStore=v.destroyMaybe(this._featureStore),this._updatingPendingLoadedGraphicsChange=v.removeMaybe(this._updatingPendingLoadedGraphicsChange),this._graphicStateTracking=v.destroyMaybe(this._graphicStateTracking),this.stage&&(this.stage.remove(this.stageLayer),this.stageLayer=null,this.stage=null),this._handles=v.destroyMaybe(this._handles),this._set("owner",null);for(const e in this._whenGraphics3DGraphicRequests)this._whenGraphics3DGraphicRequests[e].reject(new m("graphic:layer-destroyed","Layer has been destroyed"));this._whenGraphics3DGraphicRequests=null,this._sharedSymbolResourcesOwnerHandle=v.removeMaybe(this._sharedSymbolResourcesOwnerHandle),this._propertiesPool=v.destroyMaybe(this._propertiesPool),this._pendingUpdatesPool=null,this._symbolConversionCache.clear(),this._objectIdInvisibleSet.clear(),this._spatialIndex=v.destroyMaybe(this._spatialIndex)},t.clear=function(){this._objectStates?.allGraphicsDeleted(),v.isSome(this._graphicStateTracking)&&this._graphicStateTracking.allGraphicsDeleted(),this.graphics3DGraphics.forEach((e=>e.destroy())),this._spatialIndex?.clear(),this.graphics3DGraphics.clear(),this._numberOfGraphics=0,this._usedMemory=0,this._updateLayerVisibility(),this._symbols.forEach(v.destroyMaybe),this._symbols.clear(),this._graphicsBySymbol.clear(),this._graphicsWithoutSymbol.clear(),this._graphicsWaitingForSymbol.clear(),this._pendingUpdates.clear(),this._pendingUpdatesPool.clear(),this._pendingAdds=0,this._pendingRemoves=0,this._applyPendingRemovesFirst=!1,this.notifyChange("updating"),this.notifyChange("running"),this.notifyChange("updatingRemaining"),this._featureStore.events.emit("changed")},t._initializeStage=function(e,i){this.stage=e._stage,this.stageLayer=new he.WebGLLayer({pickable:!this.suspendedOrOutsideOfView,updatePolicy:this.effectiveUpdatePolicy},i),this.stage.add(this.stageLayer);const t=this.stageLayer.events;t.on("objectTransformation",(e=>this.notifyGraphicGeometryChanged(e.metadata.graphicUid))),t.on("visibilityChanged",(e=>this.notifyGraphicVisibilityChanged(e.metadata.graphicUid))),t.on("objectGeometryAdded",(e=>this.notifyGraphicGeometryChanged(e.object.metadata.graphicUid))),t.on("objectGeometryRemoved",(e=>this.notifyGraphicGeometryChanged(e.object.metadata.graphicUid))),t.on("objectGeometryUpdated",(e=>this.notifyGraphicGeometryChanged(e.object.metadata.graphicUid)))},t.notifyGraphicGeometryChanged=function(e){if(v.isNone(this._graphicStateTracking)||v.isNone(e))return;const i=this.graphics3DGraphics.get(e);i&&this._graphicStateTracking.updateGraphicGeometry(i)},t.notifyGraphicVisibilityChanged=function(e){if(v.isNone(this._graphicStateTracking)||v.isNone(e))return;const i=this.graphics3DGraphics.get(e);i&&this._graphicStateTracking.updateGraphicVisibility(i)},t._updateLayerVisibility=function(){const e=this.displayFeatureLimit.maximumNumberOfFeatures,i=this._numberOfGraphics>e*Ge,t=!this.suspendedOrOutsideOfView&&!i;t!==this._visible&&(this._visible=t,t?(this.stageLayer.pickable=!0,this.updateAllGraphicsVisibility()):(this.stageLayer.pickable=!1,this._hideAllGraphics()),this._updateStageLayerVisibility())},t._updateStageLayerVisibility=function(){this.stageLayer.visible=this._visible&&(null==this.layer.opacity||this.layer.opacity>0)},t.getGraphics3DGraphicById=function(e){return null!=e?this.graphics3DGraphics.get(e):void 0},t.getGraphics3DGraphicByObjectId=function(e){return this.owner.layer?.objectIdField?this._findGraphics3DGraphicByObjectId(e):null},t._getGraphicObjectID=function(e,i=this.owner.layer&&this.owner.layer.objectIdField){return T.getObjectId(e,i)},t.updateLabelingInfo=function(){var e=i._asyncToGenerator((function*(e){const i=this._deconflictor&&this._deconflictor.labelingInfoChange(e),t=this._labeler&&this._labeler.labelingInfoChange(e);yield G.eachAlways([i,t])}));function t(i){return e.apply(this,arguments)}return t}(),t.updateVisibilityInfo=function(){this._deconflictor&&this._deconflictor.labelingInfoChange(),this._labeler&&this._labeler.visibilityInfoChange()},t.runTask=function(e){if(this._frameTask.processQueue(e),this._applyPendingUpdates(e),this.notifyChange("running"),this.running||this.notifyChange("updating"),this.notifyChange("updatingRemaining"),!e.hasProgressed)return ce.Task.YIELD},t.setObjectIdVisibility=function(e,i){i?this._objectIdInvisibleSet.delete(e):this._objectIdInvisibleSet.add(e);const t=this._findGraphics3DGraphicByObjectId(e);v.isSome(t)&&this._updateUserVisibility(t)},t._findGraphics3DGraphicByObjectId=function(e){return S.findInMap(this.graphics3DGraphics,(i=>this._getGraphicObjectID(i.graphic)===e))},t._updateUserVisibility=function(e){if(v.isNone(e))return!1;const i=e.graphic,t=this._getGraphicObjectID(i),r=i.visible&&!this.owner.suspended&&(v.isNone(t)||!this._objectIdInvisibleSet.has(t));return e.setVisibilityFlag(H.VisibilityFlag.USER_SETTING,r,H.VisibilityGroup.GRAPHIC)},t._whenGraphics3DGraphic=function(e){const i=this.graphics3DGraphics.get(e.uid);if(i)return Promise.resolve(i);const t=this._whenGraphics3DGraphicRequests[e.uid];if(t)return t.promise;const r=G.createDeferred();return this._whenGraphics3DGraphicRequests[e.uid]=r,r.promise},t._boundsForGraphics3DGraphic=function(){var e=i._asyncToGenerator((function*(e,i){const t=this._viewSpatialReference,r=this.owner.view.renderSpatialReference,s=this.owner.view.basemapTerrain.spatialReference,n=(e,i,s)=>O.projectBuffer(e,r,i,e,t,i,s),a=(e,i,r)=>O.projectBuffer(e,s,i,e,t,i,r),o=this._viewElevationProvider?{service:this._viewElevationProvider,useViewElevation:!!v.isSome(i)&&!!i.useViewElevation,minDemResolution:v.isSome(i)?i.minDemResolution:null,minDemResolutionForPoints:this.owner.view.resolution}:null,l=yield e.getProjectedBoundingBox(n,a,o,v.get(i,"signal"));if(!l)return null;const h=l.boundingBox;if(l.requiresDrapedElevation){const e=this.symbolCreationContext.elevationProvider;if(e){V.center(h,be);const i=v.unwrapOr(e.getElevation(be[0],be[1],0,t,"ground"),0);h[2]=Math.min(h[2],i),h[5]=Math.max(h[5],i)}}return{boundingBox:h,screenSpaceObjects:l.screenSpaceObjects}}));function t(i,t){return e.apply(this,arguments)}return t}(),t.whenGraphicBounds=function(){var e=i._asyncToGenerator((function*(e,i){yield w.whenOnce((()=>this.owner?.loadedGraphics));const t=this.owner.layer&&this.owner.layer.objectIdField,r=this.owner.loadedGraphics.find((i=>i===e||null!=t&&null!=i.attributes&&e.attributes&&i.attributes[t]===e.attributes[t]));if(!r)throw new m("internal:graphic-not-part-of-view","Graphic is not part of this view");const s=yield this._whenGraphics3DGraphic(r);return this._boundsForGraphics3DGraphic(s,i)}));function t(i,t){return e.apply(this,arguments)}return t}(),t.computeAttachmentOrigin=function(e,i){const t=this.graphics3DGraphics.get(e.uid);if(!t)return null;const r=t.computeAttachmentOrigin();if(0===r.render.num&&0===r.draped.num)return null;U.set(we,0,0,0);let s=0;if(r.render.num>0){if(!O.projectVectorToVector(r.render.origin,this.symbolCreationContext.renderCoordsHelper.spatialReference,De,i))return null;U.add(we,we,De),s++}if(r.draped.num>0){const[e,t]=r.draped.origin,n=v.unwrapOr(this._viewElevationProvider.getElevation(e,t,"ground"),0);if(U.set(De,e,t,n),!O.projectVectorToVector(De,this._viewElevationProvider.spatialReference,De,i))return null;U.add(we,we,De),s++}return s>1&&U.scale(we,we,1/s),new pe({x:we[0],y:we[1],z:we[2],spatialReference:i})},t.getSymbolLayerSize=function(e,i){const t=this._symbols.get(e.id);if(v.isNone(t))throw new m("internal:symbol-not-part-of-view","Symbol is not part of this view");const r=e.symbolLayers.indexOf(i);if(-1===r)throw new m("internal:missing-symbol-layer","Symbol layer is not in symbol");const s=t.getSymbolLayerSize(r);if(v.isNone(s))throw new m("internal:missing-size","Symbol layer has no valid size");return s},t._graphicsCollectionChanged=function(e){this._startCreateGraphics&&(this.add(e.added),this.remove(e.removed))},t.graphicUpdateHandler=function(e){const i=e.graphic.uid,t=this.graphics3DGraphics.get(i);if(!v.isNone(t)||!v.isNone(this._graphicsWithoutSymbol.get(i)))switch(e.property){case"visible":this._graphicUpdateVisibleHandler(t);break;case"geometry":this._graphicUpdateGeometryHandler(t,e);break;case"symbol":this._graphicUpdateSymbolHandler(t,e);break;case"attributes":break;case"transform":this._graphicUpdateTransformHandler(t,e)}},t._graphicUpdateGeometryHandler=function(e,i){const t=i.graphic.geometry;if(v.isNone(t))return void this._recreateGraphic(i.graphic);if(v.isNone(e)){const e=i.graphic.symbol&&i.graphic.symbol.id;if(e){const i=this._symbols.get(e);if(v.isSome(i)&&i.loadStatus===ie.LoadStatus.LOADING)return}return void this._recreateGraphic(i.graphic)}const r=e.graphics3DSymbol;!v.isNone(i.newValue)&&r.updateGeometry(e,i.newValue)||this._recreateGraphic(e.graphic),this._expandComputedExtent(t)},t._graphicUpdateSymbolHandler=function(e,i){const t=i.graphic,r=v.isSome(e)?e.graphics3DSymbol:v.isSome(i.oldValue)?this._symbols.get(i.oldValue.id):null;if(v.isNone(r)||v.isNone(i.newValue))return void this._recreateGraphic(t);const s=r.symbol,n=this._getConvertedSymbol(i.newValue);if(v.isSome(n)&&(n.type!==s.type||"web-style"===n.type)||"web-style"===s.type)return void this._recreateGraphic(t);const a=this._graphicsBySymbol.get(s.id);if(a&&1!==a.size)return void this._recreateGraphic(t);const o=E.diff(s,n);if(v.isNone(o))return void this._updateSymbolMapping(s.id,n);const l={diff:o,graphics3DGraphicPatches:[],symbolStatePatches:[]};if(r.prepareSymbolPatch(l),!E.isEmpty(l.diff))return void this._recreateGraphic(t);const h=this._getRenderingInfo(t);if(v.isNone(h))return void this._recreateGraphic(t);const c=r.extentPadding;for(const d of l.symbolStatePatches)d();if(c!==r.extentPadding&&this._recomputeExtentPadding(),v.isSome(e))for(const d of l.graphics3DGraphicPatches)d(e,h);this._updateSymbolMapping(s.id,n)},t._graphicUpdateVisibleHandler=function(e){this._updateUserVisibility(e)&&(this._labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty())},t._graphicUpdateTransformHandler=function(e,i){},t.recreateGraphics=function(e){this._suspendSymbolCleanup=!0,this.remove(e),this.add(e),this._suspendSymbolCleanup=!1,this.effectiveUpdatePolicy===le.UpdatePolicy.SYNC&&this._cleanupSymbols()},t._recreateGraphic=function(e){this.recreateGraphics([e])},t._beginGraphicUpdate=function(e){const i=this._graphicsUpdateId;return this._graphicsUpdateId++,this._graphicsWaitingForSymbol.set(e.uid,i),1===this._graphicsWaitingForSymbol.size&&this.notifyChange("updating"),i},t._endGraphicUpdate=function(e){e&&(this._graphicsWaitingForSymbol.delete(e.uid),0===this._graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("updating")))},t._recomputeExtentPadding=function(){let e=0;this._symbols.forEach((i=>{v.isSome(i)&&(e=Math.max(e,i.extentPadding))})),this._set("extentPadding",e)},t._expandComputedExtent=function(e){const i=_e,t=e.spatialReference;T.computeAABB(e,i);const r=this._viewSpatialReference,s=me.tmpVec;if(F.equals(t,r)||O.projectXYZToVector(i[0],i[1],0,t,s,r)&&(i[0]=s[0],i[1]=s[1],O.projectXYZToVector(i[3],i[4],0,t,s,r),i[3]=s[0],i[4]=s[1]),!(isFinite(i[0])&&isFinite(i[3])&&isFinite(i[1])&&isFinite(i[4])))return;const n=this.computedExtent;let a=null;const o=isFinite(i[2])&&isFinite(i[5]),l=o&&(!n||null==n.zmin||i[2]<n.zmin),h=o&&(!n||null==n.zmax||i[5]>n.zmax);if(n){(i[0]<n.xmin||i[1]<n.ymin||i[3]>n.xmax||i[4]>n.ymax||l||h)&&(a=this._propertiesPool.get("computedExtent"),a.xmin=Math.min(i[0],n.xmin),a.ymin=Math.min(i[1],n.ymin),a.xmax=Math.max(i[3],n.xmax),a.ymax=Math.max(i[4],n.ymax),a.spatialReference=r)}else a=this._propertiesPool.get("computedExtent"),a.xmin=i[0],a.ymin=i[1],a.xmax=i[3],a.ymax=i[4],a.spatialReference=r;a&&(l&&(a.zmin=i[2]),h&&(a.zmax=i[5]),this._set("computedExtent",a))},t._abortElevationInfoChange=function(){this._elevationInfoChangeAbortController&&(this._elevationInfoChangeAbortController.abort(),this._elevationInfoChangeAbortController=null)},t.elevationInfoChange=function(){var e=i._asyncToGenerator((function*(){this._abortElevationInfoChange();const e=new AbortController;this._elevationInfoChangeAbortController=e;const i=q.extractExpressionInfo(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=yield q.createContext(i,this._viewSpatialReference,e.signal,Se),G.throwIfAborted(e.signal),this._elevationInfoChangeAbortController=null,this._labeler?.elevationInfoChange(),this.forEachGraphics3DSymbol(((e,i,t)=>{e.globalPropertyChanged("elevationInfo",i)?i.forEach((e=>{const i=e.graphic,t=e.labelLayers;for(const r of t){r.graphics3DSymbolLayer.updateGraphicElevationContext(i,r)}})):this._recreateSymbol(t)})),this.updateStageLayerElevationProvider(),this._elevationAlignment?.elevationInfoChange()}));function t(){return e.apply(this,arguments)}return t}(),t.updateStageLayerElevationProvider=function(){this._stageLayerElevationProvider?(this.layer.elevationInfo&&"relative-to-scene"===this.layer.elevationInfo.mode||0===this._numberOfGraphicsProvidingElevation)&&(this.owner.view.elevationProvider.unregister(this._stageLayerElevationProvider),this._stageLayerElevationProvider=v.disposeMaybe(this._stageLayerElevationProvider)):(!this.layer.elevationInfo||this.layer.elevationInfo&&"relative-to-scene"!==this.layer.elevationInfo.mode)&&this._numberOfGraphicsProvidingElevation>0&&(this._stageLayerElevationProvider=new se.StageLayerElevationProvider({layer:this.layer,stageLayer:this.stageLayer,view:this.owner.view}),this.owner.view.elevationProvider.register("scene",this._stageLayerElevationProvider))},t._clearSymbolsAndGraphics=function(){this.clear(),v.isSome(this._filterVisibility)&&this._filterVisibility.clear(),this._labeler?.reset(),this._deconflictor?.clear(),this._elevationAlignment?.clear(),this.stageLayer?.invalidateSpatialQueryAccelerator(),this._stageLayerElevationProvider&&(this.owner.view.elevationProvider.unregister(this._stageLayerElevationProvider),this._stageLayerElevationProvider=v.disposeMaybe(this._stageLayerElevationProvider))},t.startCreateGraphics=function(){this._startCreateGraphics=!0,this.recreateAllGraphics()},t.recreateAllGraphics=function(){this._recreateAllGraphics(!1)},t.recreateAllGraphicsAndSymbols=function(){this._recreateAllGraphics(!0)},t._recreateAllGraphics=function(e=!1){if(!this._startCreateGraphics)return;const{loadedGraphics:i,view:t}=this.owner,r=t.basemapTerrain.tilingScheme&&i&&i.length?i.toArray():null;!e&&r||this._clearSymbolsAndGraphics(),this.symbolCreationContext.screenSizePerspectiveEnabled=this.owner.view.screenSizePerspectiveEnabled&&!!this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this._set("computedExtent",null),r&&(e?this.add(r):this.recreateGraphics(r))},t._recreateSymbol=function(e){const i=this._graphicsBySymbol.get(e),t=[];i&&(i.forEach(((e,i)=>{const r=e.usedMemory;this._conditionalRemove(e,i),this._spatialIndex?.remove(e),t.push(e.graphic),e.destroy(),this._removeGraphics3DGraphic(i,r),this._updateLayerVisibility(),this._featureStore.events.emit("changed")})),this._graphicsBySymbol.set(e,new Map));const r=this._symbols.get(e);v.destroyMaybe(r),this._symbols.delete(e),this.add(t)},t._recreateGraphicsForSymbol=function(e){const i=this._graphicsBySymbol.get(e);if(i){const e=[];i.forEach((i=>e.push(i.graphic))),this.recreateGraphics(e)}},t._conditionalRemove=function(e,i){this._graphicsDrapedUids.delete(i),this._objectStates?.removeGraphic(e),this._labeler?.removeGraphic(e),this._deconflictor?.removeGraphic(e),v.isSome(this._graphicStateTracking)&&this._graphicStateTracking.removeGraphic(e)},t.add=function(e){e&&0!==e.length&&(this.owner.view.basemapTerrain&&this.owner.view.basemapTerrain.tilingScheme?(this._updatePolicyForGraphics(e)===le.UpdatePolicy.ASYNC?this._addDelayed(e):this._addImmediate(e),this.notifyChange("updating")):Se.error("#add()","Cannot add graphics before terrain surface has been initialized"))},t._updatePolicyForGraphics=function(e){if(this.effectiveUpdatePolicy===le.UpdatePolicy.SYNC&&("mesh"===this.layer.geometryType||null==this.layer.geometryType))for(const i of e)if(v.isSome(i.geometry)&&"mesh"===i.geometry.type&&!i.geometry.loaded)return le.UpdatePolicy.ASYNC;return this.effectiveUpdatePolicy},t._addImmediate=function(e){this._geometryWarningLogged=!1,this._symbolWarningLogged=!1;for(const i of e)this._addGraphic(i,this._getRenderingInfo(i,Se),le.UpdatePolicy.SYNC);this._cleanupSymbols(),this._labeler&&(this.owner.view.labeler.setDirty(),this._cleanupSymbols()),this.owner.view.deconflictor.setDirty()},t._addDelayed=function(e){for(const i of e){const e=i.uid;let t=this._pendingUpdates.get(e);t?t.add?t.state!==ve.NEW&&t.abortController?.abort():this._pendingAdds++:(t=this._pendingUpdatesPool.pushNew(),this._pendingAdds++,this._pendingUpdates.set(e,t)),t.add=i}this.notifyChange("running"),this.notifyChange("updatingRemaining")},t.remove=function(e){this.effectiveUpdatePolicy===le.UpdatePolicy.ASYNC?this._removeDelayed(e):this._removeImmediate(e),this.notifyChange("updating")},t._removeImmediate=function(e){for(const i of e)this._removeGraphic(i);this._cleanupSymbols(),this._labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty()},t._removeDelayed=function(e){for(const i of e){const e=i.uid,t=this._pendingUpdates.get(e);if(t)t.add&&(t.remove?t.add=null:this._pendingUpdates.delete(e),t.state===ve.LOADING&&t.abortController?.abort(),this._pendingAdds--);else{const t=this._pendingUpdatesPool.pushNew();t.remove=i,this._pendingUpdates.set(e,t),this._pendingRemoves++,this._applyPendingRemovesFirst=!0}}0===this._pendingUpdates.size&&this._finishPendingUpdates(),this.notifyChange("running"),this.notifyChange("updatingRemaining")},t._finishPendingUpdates=function(){this._pendingUpdatesPool.clear(),this._cleanupSymbols(),(this._pendingAdds||this._pendingRemoves)&&Se.warn("pendingAdds/Removes in inconsistent state!"),this._pendingAdds=0,this._pendingRemoves=0,this._applyPendingRemovesFirst=!1},t._applyPendingUpdates=function(e){if(this._geometryWarningLogged=!1,this._symbolWarningLogged=!1,0===this._pendingUpdates.size&&this._spatialIndex?.updating)return this._spatialIndex.update(),void e.madeProgress();if(this._applyPendingRemovesFirst){this._applyPendingRemovesFirst=!1;for(const[i,t]of this._pendingUpdates){if(e.done){this._applyPendingRemovesFirst=!0;break}if(t.remove&&!t.add&&(this._pendingRemoves--,e.madeProgress(),this._removeGraphic(t.remove),t.remove=null,this._pendingUpdates.delete(i),0===this._pendingRemoves))break}}for(const[i,t]of this._pendingUpdates){if(e.done)break;t.add&&t.state===ve.NEW&&this._processPendingUpdateNew(t);let r=this.effectiveUpdatePolicy;if(!t.remove||t.add&&t.state!==ve.READY||(this._pendingRemoves--,e.madeProgress(),this._removeGraphic(t.remove),t.remove=null,r=le.UpdatePolicy.SYNC),t.add)switch(t.state){case ve.READY:this._addGraphic(t.add,t.renderingInfo,r),t.add=null,this._pendingAdds--,e.madeProgress();break;case ve.REJECTED:t.add=null,this._pendingAdds--;case ve.LOADING:}null==t.remove&&null==t.add&&this._pendingUpdates.delete(i)}0===this._pendingUpdates.size&&(this._finishPendingUpdates(),this.notifyChange("running"))},t._processPendingUpdateNew=function(e){if(!e.add)return void(e.state=ve.READY);const i=e.add.geometry;v.isSome(i)&&"mesh"===i.type&&!i.loaded?this._processPendingUpdateNewMesh(e,i):this._processPendingUpdateNewRenderingInfo(e)},t._processPendingUpdateNewMesh=function(){var e=i._asyncToGenerator((function*(e,i){e.state=ve.LOADING,e.abortController=new AbortController;const t=e.abortController.signal;try{yield i.load({signal:t})}catch(r){return this._processPendingUpdateNewError(e,r)}e.abortController=null,this._processPendingUpdateNewRenderingInfo(e)}));function t(i,t){return e.apply(this,arguments)}return t}(),t._processPendingUpdateNewError=function(e,i){e.abortController=null,G.isAbortError(i)?e.state=ve.NEW:e.state=ve.REJECTED},t._processPendingUpdateNewRenderingInfo=function(){var e=i._asyncToGenerator((function*(e){if(v.isNone(this.layer.renderer)||"dictionary"!==this.layer.renderer.type)return e.renderingInfo=this._getRenderingInfo(e.add,Se),void(e.state=ve.READY);e.state=ve.LOADING,e.abortController=new AbortController;let i=null;try{i=yield this._getRenderingInfoAsync(e.add,{signal:e.abortController.signal})}catch(t){return e.abortController=null,void(G.isAbortError(t)?e.state=ve.NEW:e.state=ve.REJECTED)}v.isNone(i)||v.isNone(i.symbol)?(Se&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,Se.warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),e.renderingInfo=null):e.renderingInfo=i,e.state=ve.READY}));function t(i){return e.apply(this,arguments)}return t}(),t._addGraphic=function(e,i,t){if(this._graphicsWithoutSymbol.set(e.uid,e),v.isNone(i)||v.isNone(i.symbol)||!T.hasGeometry(e))return;v.isSome(this.stage.renderView.objectAndLayerIdRenderHelper)&&this.setUidToIdOnAdd&&this.stage.renderView.objectAndLayerIdRenderHelper.setUidToObjectAndLayerId(e.objectId,e.uid,this.layer.id,this.layer.uid,!!this.layer.popupEnabled);const r=i.symbol,s=this.getOrCreateGraphics3DSymbol(r,i.renderer);if(v.isNone(s))return;this._expandComputedExtent(e.geometry);const n=this._beginGraphicUpdate(e),a=new $(e,i,this.layer);let o=!1;const l=e=>{e===s.symbol.id&&(o=!0)};this._whenSymbolRemoved.push(l);const h=()=>{if(--this._loadingSymbols,this.destroyed)return;this._whenSymbolRemoved.removeUnordered(l);if(this._graphicsWaitingForSymbol.get(e.uid)!==n||o||s.destroyed||this.graphicSymbolSupported&&e.symbol&&e.symbol.id!==s.symbol.id)--s.referenced,this._cleanupSymbols();else{const i=this._createGraphics3DGraphic(s,a);this._spatialIndex&&v.isSome(i)&&this._spatialIndex.add(i),--s.referenced,this._endGraphicUpdate(e)}this._featureStore.events.emit("changed"),this._labeler&&this.owner.view.labeler.setDirty()},c=i=>{--this._loadingSymbols,this.destroyed||(this._whenSymbolRemoved.removeUnordered(l),o||(G.isAbortError(i)?this.add([e]):s.destroyed||this._endGraphicUpdate(e)))};++this._loadingSymbols,t===le.UpdatePolicy.ASYNC?s.load((()=>this._frameTask.schedule(h)),(e=>this._frameTask.schedule((()=>c(e))))):s.load(h,c)},t._removeGraphic=function(e){const i=e.uid,t=this.graphics3DGraphics.get(i);if(t){t.graphics3DSymbol.onRemoveGraphic(t);const e=t.usedMemory,r=t.isElevationSource;this._conditionalRemove(t,i),this._spatialIndex?.remove(t);const s=t.graphics3DSymbol.symbol.id;this._graphicsBySymbol.get(s)?.delete(i),this._graphicsWithoutSymbol.delete(i),this._removeGraphics3DGraphic(i,e,r),t.destroy(),this._featureStore.events.emit("changed")}else this._graphicsWithoutSymbol.delete(i),this._graphicsWaitingForSymbol.delete(i),0===this._graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("updating"))},t._hasLabelingContext=function(e){if(e instanceof ye||e instanceof ue){const i=this.symbolCreationContext.layer;return!!i.labelingInfo&&i.labelingInfo.some((i=>i.symbol===e))}return!1},t._hasValidSymbolCreationContext=function(e){return!(e instanceof ye&&!this._hasLabelingContext(e))||(Se.error("LabelSymbol3D is only valid as part of a LabelClass. Using LabelSymbol3D as a renderer symbol is not supported."),!1)},t._getRenderingInfo=function(e,i){const t=e.geometry;if(v.isNone(t))return i&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,i.warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;if(!O.canProjectWithoutEngine(t.spatialReference,this._viewSpatialReference))return i&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,i.warn(`Graphic in layer ${this.layer.id} has incompatible spatial reference and will not render`)),null;if(!this.graphicSymbolSupported&&v.isSome(e.symbol))return i&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,i.warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;const r=this.rendererHasGeometryOperations?N.hydrateGraphic(e,this.layer):e;let s;if(this.owner.getRenderingInfo&&(this.getRenderingInfoWithoutRenderer||v.isSome(this.currentRenderer)))s=this.owner.getRenderingInfo(r,this.currentRenderer,this._arcadeOnDemand);else{s={symbol:r.symbol||z.getDefaultSymbol3D(r.geometry)}}return v.isNone(s)||v.isNone(s.symbol)?(i&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,i.warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),null):s},t._getRenderingInfoAsync=function(e,i){const t=e.geometry;if(v.isNone(t))return Se&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,Se.warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;if(!this.graphicSymbolSupported&&v.isSome(e.symbol))return Se&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,Se.warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;const r=this.rendererHasGeometryOperations?N.hydrateGraphic(e,this.layer):e;return this.owner.getRenderingInfoAsync(r,this.currentRenderer,this._arcadeOnDemand,i)},t._createGraphics3DSymbol=function(e,i){if(!this._hasValidSymbolCreationContext(e))return null;const t=this._getConvertedSymbol(e);if(!t)return null;let r;if(v.isSome(i)&&"backgroundFillSymbol"in i&&i.backgroundFillSymbol){const e=W.to3D(i.backgroundFillSymbol,{ignoreDrivers:!0});v.isSome(e.symbol)&&"web-style"!==e.symbol.type&&"cim"!==e.symbol.type&&(r=e.symbol.symbolLayers)}const s=J.make(t,this.symbolCreationContext,r);return s.load((()=>{const e=s.extentPadding;e>this.extentPadding&&this._set("extentPadding",e),this.notifyChange("averageSymbolComplexity")}),(()=>{})),s},t.getOrCreateGraphics3DSymbol=function(e,i){let t=this._symbols.get(e.id);return void 0===t&&(t=e instanceof ge?new Q(e,(e=>this._frameTask.schedule(e)),(e=>this._createGraphics3DSymbol(e,i))):this._createGraphics3DSymbol(e,i),this._symbols.set(e.id,t)),v.isSome(t)&&++t.referenced,t},t.trackGraphicState=function(e){return v.isNone(this._graphicStateTracking)&&(this._graphicStateTracking=new X.GraphicStateTracking(this)),this._graphicStateTracking.add(e)},t._addGraphics3DGraphic=function(e){this._usedMemory+=e.usedMemory,this.graphics3DGraphics.set(e.graphic.uid,e),this._numberOfGraphics++,e.isElevationSource&&(this._numberOfGraphicsProvidingElevation++,this.updateStageLayerElevationProvider()),this._updateLayerVisibility()},t._removeGraphics3DGraphic=function(e,i,t=!1){this._usedMemory-=i,this.graphics3DGraphics.delete(e),this._numberOfGraphics--,t&&(this._numberOfGraphicsProvidingElevation--,this.updateStageLayerElevationProvider()),this._updateLayerVisibility()},t._createGraphics3DGraphic=function(e,i){const t=i.graphic;if(this._graphicsWithoutSymbol.delete(t.uid),!this._symbols.has(e.symbol.id))return this.add([t]),null;if(this.graphics3DGraphics.has(t.uid))return null;const r=e.createGraphics3DGraphic(i);if(v.isNone(r))return null;this._addGraphics3DGraphic(r);const s=e.symbol.id;this._graphicsBySymbol.has(s)||this._graphicsBySymbol.set(s,new Map),this._graphicsBySymbol.get(s).set(t.uid,r);if(r.isDraped&&this._graphicsDrapedUids.add(t.uid),r.centroid=null,v.isSome(t.geometry)&&"point"!==t.geometry.type&&(r.centroid=K.computeCentroid(t.geometry,this._viewSpatialReference)),this._updateUserVisibility(r),v.isSome(this._scaleVisibility)&&this._scaleVisibility.updateVisibility(r),v.isSome(this._filterVisibility)){const{defaultVisibility:e}=this._filterVisibility;r.setVisibilityFlag(H.VisibilityFlag.FILTER,e,H.VisibilityGroup.GRAPHIC),e||this._filterVisibility.reapply()}this._deconflictor?.addGraphic(r),this._labeler?.addGraphic(r),this._objectStates?.addGraphic(r),this._deconflictor&&this.owner.view.deconflictor.setInitialIconVisibilityFlag(this,r),r.initialize(this.stage,this.stageLayer,this.owner),v.isSome(this._graphicStateTracking)&&this._graphicStateTracking.addGraphic(r);const n=this._whenGraphics3DGraphicRequests[t.uid];return n&&(delete this._whenGraphics3DGraphicRequests[t.uid],n.resolve(r)),r},t._abortRendererChange=function(){this._rendererChangeAbortController&&(this._rendererChangeAbortController.abort(),this._rendererChangeAbortController=null)},t.rendererChange=function(){var e=i._asyncToGenerator((function*(e){if(this._abortRendererChange(),e!==this.currentRenderer)if(this._validateRenderer(e),v.isNone(e)&&this._currentRendererChange(null,!1),M.isSupportedRenderer3D(e))if(v.isSome(e)&&e.arcadeRequired){const i=new AbortController;this._rendererChangeAbortController=i;const{arcadeUtils:t}=yield this._ensureArcade();G.throwIfAborted(i);const r=t.hasGeometryOperations(e);r&&(yield t.enableGeometryOperations(),G.throwIfAborted(i)),this.effectiveUpdatePolicy===le.UpdatePolicy.ASYNC?yield this._frameTask.schedule((()=>this._currentRendererChange(e,r)),i.signal):this._currentRendererChange(e,r),this._rendererChangeAbortController=null}else if(this.effectiveUpdatePolicy===le.UpdatePolicy.ASYNC){const i=new AbortController;this._rendererChangeAbortController=i,yield this._frameTask.schedule((()=>this._currentRendererChange(e,!1)),i.signal),this._rendererChangeAbortController=null}else this._currentRendererChange(e,!1);else this._currentRendererChange(e,!1)}));function t(i){return e.apply(this,arguments)}return t}(),t._ensureArcade=function(){var e=i._asyncToGenerator((function*(){return v.isNone(this._arcadeOnDemand)?(this._arcadeOnDemand=yield j.loadArcade(),this._arcadeOnDemand):this._arcadeOnDemand}));function t(){return e.apply(this,arguments)}return t}(),t._currentRendererChange=function(e,i){this.currentRenderer=e,this.rendererHasGeometryOperations=i,this.symbolCreationContext.arcade=v.unwrap(this._arcadeOnDemand);const t=this.symbolCreationContext.renderer;if(e===t)return;if(this._symbolConversionCache.clear(),v.isNone(e))return this.symbolCreationContext.renderer=null,void this.recreateAllGraphicsAndSymbols();const r=E.diff(t,e);this._updateUnchangedSymbolMappings(r,e,t),this.symbolCreationContext.renderer=e,v.isNone(r)||("complete"===r.type?this.recreateAllGraphicsAndSymbols():"partial"===r.type&&(this._applyRendererDiff(r,e,t)?this._volatileGraphicsUpdated():this.recreateAllGraphicsAndSymbols()),this.notifyChange("averageSymbolComplexity"))},t._diffHasSymbolChange=function(e){for(const i in e.diff)switch(i){case"visualVariables":case"defaultSymbol":case"uniqueValueInfos":break;case"uniqueValueGroups":case"authoringInfo":case"fieldDelimiter":delete e.diff[i];break;default:return!0}return!1},t._applySymbolSetDiff=function(e,i,t){e=e||[],i=i||[];const r=[];for(const s of i){const i=this._graphicsBySymbol.get(s.id);i&&i.forEach(((n,a)=>{const o=n.graphic,l=this.layer instanceof k?this.layer:null,h=v.unwrap(this._arcadeOnDemand);if(s===t.defaultSymbol&&t.getSymbol(N.hydrateGraphic(o,l),{arcade:h})===t.defaultSymbol)return;const c=n.usedMemory;e.length||t.defaultSymbol?r.push(o):this._graphicsWithoutSymbol.set(a,o);const d=this.graphics3DGraphics.get(a);this._conditionalRemove(d,a),n.destroy(),i.delete(a),this._removeGraphics3DGraphic(a,c),this._updateLayerVisibility()})),this._whenSymbolRemoved.forAll((e=>e(s.id)))}(e.length||r.length)&&(this._graphicsWithoutSymbol.forEach((e=>r.push(e))),this._graphicsWithoutSymbol.clear(),this.add(r)),this._cleanupSymbols(),this._labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty()},t._applyUniqueValueRendererDiff=function(e,i,t){const r=e.diff.defaultSymbol,s=e.diff.uniqueValueInfos;if(r||s){const n=s?s.added.map((e=>e.symbol)).filter(v.isSome):[],a=s?s.removed.map((e=>e.symbol)).filter(v.isSome):[];if(s)for(let e=0;e<s.changed.length;e++)n.push(s.changed[e].newValue.symbol),a.push(s.changed[e].oldValue.symbol);return r?(t.defaultSymbol&&a.push(t.defaultSymbol),i.defaultSymbol&&n.push(i.defaultSymbol)):t.defaultSymbol&&n.length&&a.push(i.defaultSymbol),this._applySymbolSetDiff(n,a,i),delete e.diff.defaultSymbol,delete e.diff.uniqueValueInfos,!0}return!1},t._calculateUnchangedSymbolMapping=function(e,i,t){if("unique-value"!==i?.type||"unique-value"!==t?.type||v.isSome(e)&&"partial"!==e.type)return[];const r=e=>v.isSome(e)?e.id:null,s=e&&e.diff,n=s&&s.defaultSymbol,a=s&&s.uniqueValueInfos;let o;if(a)o=a.unchanged.map((e=>({oldId:r(e.oldValue.symbol),newId:r(e.newValue.symbol)})));else{o=[];for(const e of t.uniqueValueInfos??[]){const t=r(e.symbol),s=i.uniqueValueInfos?.find((i=>i.value===e.value));s&&t!==r(s.symbol)&&o.push({oldId:t,newId:r(s.symbol)})}}return!n&&t.defaultSymbol&&o.push({oldId:r(t.defaultSymbol),newId:r(i.defaultSymbol)}),o},t._updateSymbolMapping=function(e,i){const t=v.isSome(i)&&i?"string"==typeof i?i:i.id:null;if(v.isNone(e)||e===t)return;const r=this._graphicsBySymbol.get(e);this._graphicsBySymbol.delete(e),void 0!==r&&this._graphicsBySymbol.set(t,r);const s=this._symbols.get(e);if(void 0!==s&&(this._symbols.delete(e),this._symbols.set(t,s),v.isSome(s))){const e="string"==typeof i?null:i;v.isSome(e)?s.symbol=e:s.symbol.id=t}},t._updateUnchangedSymbolMappings=function(e,i,t){const r=this._calculateUnchangedSymbolMapping(e,i,t);for(const{oldId:s,newId:n}of r)this._updateSymbolMapping(s,n)},t._applyRendererDiff=function(e,i,t){if(this._diffHasSymbolChange(e))return!1;if(i instanceof d&&t instanceof d&&this._applyUniqueValueRendererDiff(e,i,t)&&0===Object.keys(e.diff).length)return!0;for(const[r]of this._graphicsBySymbol){const t=this._symbols.get(r);if(v.isSome(t))switch(t.applyRendererDiff(e,i)){case ee.ApplyRendererDiffResult.Recreate_Symbol:this._recreateSymbol(r);break;case ee.ApplyRendererDiffResult.Recreate_Graphics:this._recreateGraphicsForSymbol(r);case ee.ApplyRendererDiffResult.Fast_Update:}}return!0},t.opacityChange=function(){this.forEachGraphics3DSymbol(((e,i)=>e.globalPropertyChanged("opacity",i))),this._updateStageLayerVisibility()},t._slicePlaneEnabledChange=function(e){e!==this.symbolCreationContext.slicePlaneEnabled&&(this.symbolCreationContext.slicePlaneEnabled=e,this.stageLayer.sliceable=e,this.forEachGraphics3DSymbol(((e,i)=>e.globalPropertyChanged("slicePlaneEnabled",i))),this._deconflictor&&this._deconflictor.slicePlaneEnabledChange(),this._labeler&&this._labeler.slicePlaneEnabledChange())},t._physicalBasedRenderingChange=function(e){this.symbolCreationContext.physicalBasedRenderingEnabled=e,this.forEachGraphics3DSymbol(((e,i,t)=>{e.globalPropertyChanged("physicalBasedRenderingEnabled",i)||this._recreateSymbol(t)}))},t._skipHighSymbolLoDsChange=function(e){this.symbolCreationContext.skipHighSymbolLods=e,this.forEachGraphics3DSymbol(((e,i,t)=>{e.globalPropertyChanged("skipHighSymbolLods",i)||this._recreateSymbol(t)}))},t._pixelRatioChange=function(){this.forEachGraphics3DSymbol(((e,i,t)=>{e.globalPropertyChanged("pixelRatio",i)||this._recreateSymbol(t)}))},t._signalUpdatingDuringAsyncLoadedGraphicsChange=function(){this._updatingPendingLoadedGraphicsChange&&this._updatingPendingLoadedGraphicsChange.remove(),this._updatingPendingLoadedGraphicsChange=D.schedule((()=>{this._updatingPendingLoadedGraphicsChange=null}))},t.setClippingExtent=function(e,i){const t=this.symbolCreationContext.clippingExtent,r=L.create();return ne.toBoundingRect(e,r,i)?this.symbolCreationContext.clippingExtent=V.fromRect(V.create(),r):this.symbolCreationContext.clippingExtent=null,!V.equals(this.symbolCreationContext.clippingExtent,t)},t.modifyGraphics3DGraphicVisibilities=function(e){let i=!1;this.graphics3DGraphics.forEach((t=>{e(t)&&(i=!0)})),i&&(this.owner.view.labeler?.setDirty(),this.owner.view.deconflictor.setDirty())},t.forEachGraphics3DSymbol=function(e){for(const[i,t]of this._symbols){if(v.isNone(t))return;e(t,this._graphicsBySymbol.get(i)||Pe,i)}},t.updateAllGraphicsVisibility=function(){v.isSome(this._filterVisibility)&&this._filterVisibility.reapply(),this.modifyGraphics3DGraphicVisibilities((e=>{const i=this._updateUserVisibility(e),t=v.isSome(this._scaleVisibility)&&this._scaleVisibility.updateVisibility(e);return i||t}))},t._hideAllGraphics=function(){this.modifyGraphics3DGraphicVisibilities((e=>e.setVisibilityFlag(H.VisibilityFlag.USER_SETTING,!1,H.VisibilityGroup.GRAPHIC)))},t._validateRenderer=function(e){const i=M.validateTo3D(e,{geometryType:this.layer?.geometryType});if(i){const e=`Renderer for layer '${this.layer.title?`${this.layer.title}, `:""}, id:${this.layer.id}' is not supported in a SceneView`;Se.warn(e,i.message)}},t._volatileGraphicsUpdated=function(){this._labeler?.reset(),this.stageLayer.shaderTransformationChanged(),this.notifyChange("updating")},t._cleanupSymbols=function(){if(this._graphicsWaitingForSymbol.size>0||this._suspendSymbolCleanup)return;let e=!1;this._symbols.forEach(((i,t)=>{if(v.isNone(i)||i.referenced>0)return;const r=this._graphicsBySymbol.get(t);r&&0!==r.size||(this._graphicsBySymbol.delete(t),this._symbols.delete(t),v.destroyMaybe(i),e=!0)})),e&&(this._recomputeExtentPadding(),this.notifyChange("averageSymbolComplexity"))},i._createClass(r,[{key:"_viewSpatialReference",get:function(){return this.owner.view.spatialReference}},{key:"spatialIndex",get:function(){return this._spatialIndex||(this._spatialIndex=new te.SpatialIndex2D({objectIdField:this.owner.layer?.objectIdField,spatialReference:this._viewSpatialReference,hasZ:!!this.hasZ,hasM:!!this.hasM}),this._spatialIndex.setup(Array.from(this.graphics3DGraphics.values()))),this._spatialIndex.update(),this._spatialIndex}},{key:"numberOfGraphics",get:function(){return this._numberOfGraphics}},{key:"effectiveUpdatePolicy",get:function(){return v.isSome(this.currentRenderer)&&"dictionary"===this.currentRenderer.type?le.UpdatePolicy.ASYNC:v.unwrapOr(this._forcedUpdatePolicy,this.preferredUpdatePolicy)}},{key:"featureStore",get:function(){return this._featureStore}},{key:"initializePromise",get:function(){return this._initializePromise}},{key:"scaleVisibility",get:function(){return this._scaleVisibility}},{key:"elevationAlignment",get:function(){return this._elevationAlignment}},{key:"objectStates",get:function(){return this._objectStates}},{key:"filterVisibility",get:function(){return this._filterVisibility}},{key:"updating",get:function(){return!!(this._graphicsWaitingForSymbol.size>0||this.running||this._elevationAlignment?.updating||v.isSome(this._scaleVisibility)&&this._scaleVisibility.updating||v.isSome(this._filterVisibility)&&this._filterVisibility.updating||this._rendererChangeAbortController||this._elevationInfoChangeAbortController||this._updatingPendingLoadedGraphicsChange||this._frameTask.updating||this._loadingSymbols>0)}},{key:"running",get:function(){return this._pendingUpdates.size>0||!!this._spatialIndex?.updating}},{key:"suspendedOrOutsideOfView",get:function(){return this.owner.suspended||!!this.owner.suspendInfo?.outsideOfView}},{key:"updatingRemaining",get:function(){return this.updating?this._pendingUpdates.size+.1*(this._spatialIndex?.updatingRemaining||0)+.1*(this._elevationAlignment?.updatingRemaining||0):0}},{key:"displayFeatureLimit",get:function(){const e=this.owner&&this.owner.view&&this.owner.view.qualitySettings,i=e?e.graphics3D.minTotalNumberOfFeatures:0,t=e?e.graphics3D.maxTotalNumberOfFeatures:0,r=e?e.graphics3D.maxTotalNumberOfPrimitives:0,s=this.averageSymbolComplexity,n=Math.max(1,v.isSome(s)?s.primitivesPerFeature:1),a=v.isSome(s)&&s.drawCallsPerFeature>0?t/s.drawCallsPerFeature*.3:t,o=Math.ceil(r/n),l=Math.max(i,Math.min(t,o,a)),h=this._get("displayFeatureLimit");return h&&h.minimumTotalNumberOfFeatures===i&&h.maximumTotalNumberOfFeatures===t&&h.maximumTotalNumberOfPrimitives===r&&h.averageSymbolComplexity===s&&h.maximumNumberOfFeatures===l?h:{minimumTotalNumberOfFeatures:i,maximumTotalNumberOfFeatures:t,maximumTotalNumberOfPrimitives:r,averageSymbolComplexity:s,maximumNumberOfFeatures:l}}},{key:"averageSymbolComplexity",get:function(){const e=re.averageSymbolComplexities(this._symbolComplexities),i=this._get("averageSymbolComplexity");return 0===e.numComplexities||v.isSome(i)&&(e.estimated&&(i.primitivesPerFeature>=e.primitivesPerFeature||i.primitivesPerCoordinate>=e.primitivesPerCoordinate||i.drawCallsPerFeature>=e.drawCallsPerFeature)||i.primitivesPerFeature===e.primitivesPerFeature&&i.primitivesPerCoordinate===e.primitivesPerCoordinate&&i.drawCallsPerFeature===e.drawCallsPerFeature)?i:e}},{key:"usedMemory",get:function(){const e=v.isSome(this.averageSymbolComplexity)&&this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel*this._numberOfGraphics:0,i=this._getSymbolComplexitiesUsed().reduce(((e,i)=>e+i.memory.resourceBytes),0);return this._usedMemory+e+i}},{key:"usedMemoryPerGraphic",get:function(){if(this._usedMemory&&this._numberOfGraphics){const e=this._numberOfGraphics/(this._numberOfGraphics+Math.max(this._pendingAdds,this._pendingRemoves));return this._usedMemory/this._numberOfGraphics*e}if(v.isSome(this.averageSymbolComplexity)){const e=this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel:0;return this.averageSymbolComplexity.memory.bytesPerFeature+e}return 0}},{key:"unprocessedMemoryEstimate",get:function(){return(this._pendingAdds-this._pendingRemoves)*this.usedMemoryPerGraphic}},{key:"_symbolComplexities",get:function(){return this.currentRenderer?this._getSymbolComplexitiesUsedOrRenderer(this.currentRenderer):this._getSymbolComplexitiesUsed()}},{key:"visible",get:function(){return this._visible}},{key:"_objectIdField",get:function(){return this.layer.objectIdField}},{key:"graphics3DGraphicsByObjectID",get:function(){const e=this.owner.layer&&this.owner.layer.objectIdField;if(!e)return;const i=new Map;return this.graphics3DGraphics.forEach((t=>{if(!t)return;const r=t.graphic,s=this._getGraphicObjectID(r,e);v.isSome(s)&&i.set(s,t)})),i}},{key:"labelsEnabled",get:function(){return!(!this._labeler||!this._labeler.layerLabelsEnabled())}},{key:"symbolUpdateType",get:function(){if(this._pendingUpdates.size>0)return"unknown";let e=0,i=0;return S.someMap(this._symbols,((t,r)=>{if(v.isSome(t)){const s=t.getFastUpdateStatus();if(s.loading>0)return!0;this._graphicsBySymbol.has(r)&&(i+=s.fast,e+=s.slow)}return!1}))?"unknown":i>=0&&0===e?"fast":e>=0&&0===i?"slow":"mixed"}},{key:"test",get:function(){return{snapshotInternals:()=>({graphics:[...this.graphics3DGraphics.keys()].sort(),symbols:[...this._symbols.keys()].sort(),graphicsBySymbol:[...this._graphicsBySymbol.keys()].sort().map((e=>({symbolId:e,graphics:[...this._graphicsBySymbol.get(e).keys()].sort()}))),graphicsWithoutSymbol:[...this._graphicsWithoutSymbol.keys()].sort(),graphicsDrapedUids:[...this._graphicsDrapedUids].sort(),pendingUpdates:this._pendingUpdates}),symbols:this._symbols,filterVisibility:this._filterVisibility,numPending:this._pendingUpdates.size,forceUpdatePolicy:e=>{this._forcedUpdatePolicy=e}}}},{key:"performanceInfo",get:function(){return{visible:this.graphics3DGraphics.size,missing:this._graphicsWithoutSymbol.size,pending:this._pendingUpdates.size}}}]),r}(u),e.Graphics3DCore.tmpVec=A.create(),t.__decorate([P.property({readOnly:!0})],e.Graphics3DCore.prototype,"computedExtent",void 0),t.__decorate([P.property()],e.Graphics3DCore.prototype,"currentRenderer",void 0),t.__decorate([P.property()],e.Graphics3DCore.prototype,"rendererHasGeometryOperations",void 0),t.__decorate([P.property()],e.Graphics3DCore.prototype,"_frameTask",void 0),t.__decorate([P.property({readOnly:!0})],e.Graphics3DCore.prototype,"_viewSpatialReference",null),t.__decorate([P.property()],e.Graphics3DCore.prototype,"_rendererChangeAbortController",void 0),t.__decorate([P.property()],e.Graphics3DCore.prototype,"_elevationInfoChangeAbortController",void 0),t.__decorate([P.property()],e.Graphics3DCore.prototype,"_initializeAbortController",void 0),t.__decorate([P.property()],e.Graphics3DCore.prototype,"_elevationAlignment",void 0),t.__decorate([P.property()],e.Graphics3DCore.prototype,"_scaleVisibility",void 0),t.__decorate([P.property()],e.Graphics3DCore.prototype,"_filterVisibility",void 0),t.__decorate([P.property()],e.Graphics3DCore.prototype,"_initializePromise",void 0),t.__decorate([P.property()],e.Graphics3DCore.prototype,"_spatialIndex",void 0),t.__decorate([P.property({readOnly:!0})],e.Graphics3DCore.prototype,"extentPadding",void 0),t.__decorate([P.property()],e.Graphics3DCore.prototype,"_updatingPendingLoadedGraphicsChange",void 0),t.__decorate([P.property()],e.Graphics3DCore.prototype,"_featureStore",void 0),t.__decorate([P.property()],e.Graphics3DCore.prototype,"_deconflictor",void 0),t.__decorate([P.property()],e.Graphics3DCore.prototype,"_labeler",void 0),t.__decorate([P.property()],e.Graphics3DCore.prototype,"_objectStates",void 0),t.__decorate([P.property()],e.Graphics3DCore.prototype,"_loadingSymbols",void 0),t.__decorate([P.property()],e.Graphics3DCore.prototype,"preferredUpdatePolicy",void 0),t.__decorate([P.property()],e.Graphics3DCore.prototype,"_forcedUpdatePolicy",void 0),t.__decorate([P.property({readOnly:!0})],e.Graphics3DCore.prototype,"effectiveUpdatePolicy",null),t.__decorate([P.property({constructOnly:!0})],e.Graphics3DCore.prototype,"elevationFeatureExpressionEnabled",void 0),t.__decorate([P.property({constructOnly:!0})],e.Graphics3DCore.prototype,"owner",void 0),t.__decorate([P.property({constructOnly:!0})],e.Graphics3DCore.prototype,"layer",void 0),t.__decorate([P.property({constructOnly:!0})],e.Graphics3DCore.prototype,"graphicSymbolSupported",void 0),t.__decorate([P.property({constructOnly:!0})],e.Graphics3DCore.prototype,"getRenderingInfoWithoutRenderer",void 0),t.__decorate([P.property({constructOnly:!0})],e.Graphics3DCore.prototype,"componentFactories",void 0),t.__decorate([P.property({constructOnly:!0})],e.Graphics3DCore.prototype,"setUidToIdOnAdd",void 0),t.__decorate([P.property()],e.Graphics3DCore.prototype,"featureStore",null),t.__decorate([P.property()],e.Graphics3DCore.prototype,"initializePromise",null),t.__decorate([P.property()],e.Graphics3DCore.prototype,"scaleVisibility",null),t.__decorate([P.property()],e.Graphics3DCore.prototype,"elevationAlignment",null),t.__decorate([P.property()],e.Graphics3DCore.prototype,"objectStates",null),t.__decorate([P.property()],e.Graphics3DCore.prototype,"filterVisibility",null),t.__decorate([P.property({readOnly:!0})],e.Graphics3DCore.prototype,"updating",null),t.__decorate([P.property({readOnly:!0})],e.Graphics3DCore.prototype,"running",null),t.__decorate([P.property({readOnly:!0})],e.Graphics3DCore.prototype,"suspendedOrOutsideOfView",null),t.__decorate([P.property({readOnly:!0,dependsOn:[]})],e.Graphics3DCore.prototype,"updatingRemaining",null),t.__decorate([P.property({readOnly:!0,dependsOn:["owner.view.qualitySettings.graphics3D.maxTotalNumberOfPrimitives","owner.view.qualitySettings.graphics3D.maxTotalNumberOfFeatures","averageSymbolComplexity"]})],e.Graphics3DCore.prototype,"displayFeatureLimit",null),t.__decorate([P.property({readOnly:!0,dependsOn:[]})],e.Graphics3DCore.prototype,"averageSymbolComplexity",null),t.__decorate([P.property({constructOnly:!0})],e.Graphics3DCore.prototype,"hasZ",void 0),t.__decorate([P.property({constructOnly:!0})],e.Graphics3DCore.prototype,"hasM",void 0),t.__decorate([P.property()],e.Graphics3DCore.prototype,"_objectIdField",null),e.Graphics3DCore=me=t.__decorate([I.subclass(fe)],e.Graphics3DCore),function(e){e[e.NEW=0]="NEW",e[e.LOADING=1]="LOADING",e[e.READY=2]="READY",e[e.REJECTED=3]="REJECTED"}(ve||(ve={}));let Ce=function(){function e(){this.add=null,this.renderingInfo=null,this.state=ve.NEW,this.abortController=null,this.remove=null}return e.prototype.clear=function(){this.add=null,this.renderingInfo=null,this.state=ve.NEW,this.abortController=null,this.remove=null},e}();const Ge=10,we=A.create(),De=A.create(),Pe=new Map;Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
