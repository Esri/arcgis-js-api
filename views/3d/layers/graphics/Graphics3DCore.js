// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../geometry","../../../../renderers","../../../../symbols","../../../../core/Accessor","../../../../core/arrayUtils","../../../../core/compilerUtils","../../../../core/Error","../../../../core/Handles","../../../../core/Logger","../../../../core/MapUtils","../../../../core/mathUtils","../../../../core/maybe","../../../../core/ObjectPool","../../../../core/PooledArray","../../../../core/promiseUtils","../../../../core/scheduling","../../../../core/watchUtils","../../../../core/accessorSupport/decorators","../../../../core/accessorSupport/diffUtils","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../layers/Layer","../../../../layers/graphics/dehydratedFeatures","../../../../layers/graphics/hydratedFeatures","../../../../renderers/support/rendererConversion","../../../../support/arcadeOnDemand","../../../../symbols/support/defaults3D","../../../../symbols/support/symbolConversion","./ElevationQuery","./featureExpressionInfoUtils","./Graphics3DFeatureStore","./Graphics3DGraphic","./Graphics3DSymbolCreationContext","./Graphics3DSymbolFactory","./Graphics3DWebStyleSymbol","./GraphicStateTracking","./graphicUtils","./SpatialIndex2D","./symbolComplexity","../support/StageLayerElevationProvider","../../support/extentUtils","../../support/projectionUtils","../../support/PropertiesPool","../../webgl-engine/lib/GridLocalOriginFactory","../../webgl-engine/lib/Layer","../../../support/Scheduler"],(function(e,t,i,r,a,n,o,s,l,h,p,d,c,y,u,g,m,b,f,v,S,C,w,G,_,x,P,D,R,U,E,I,O,A,L,V,F,M,j,T,k,z,B,W,N,q,H,Z,Q,J,K){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Graphics3DCore=void 0;var X=G.vec3f64.create(),Y=_.create(),$=d.getLogger("esri.views.3d.layers.graphics.Graphics3DCore"),ee=function(e){function t(t){var i=e.call(this,t)||this;return i.propertiesPool=new Z.PropertiesPool({computedExtent:r.Extent},i),i.computedExtent=null,i.currentRenderer=null,i.rendererHasGeometryOperations=!1,i.graphicStateTracking=null,i.symbolCreationContext=new M.Graphics3DSymbolCreationContext,i.graphics3DGraphics=new Map,i.stageLayer=null,i.stage=null,i.graphicsDrapedUids=new Set,i.graphicsBySymbol=new Map,i.symbolConversionCache=new Map,i.symbols=new Map,i.graphicsWithoutSymbol=new Map,i.graphicsWaitingForSymbol=new Set,i.handles=new p,i.suspendSymbolCleanup=!1,i._spatialReference=null,i.arcadeOnDemand=null,i.rendererChangeAbortController=null,i.elevationInfoChangeAbortController=null,i.setupAbortController=null,i.elevationAlignment=null,i.scaleVisibility=null,i.filterVisibility=null,i._spatialIndex=null,i.extentPadding=0,i._updatingPendingLoadedGraphicsChange=null,i.featureStore=null,i.deconflictor=null,i.labeler=null,i.objectStates=null,i.viewElevationProvider=null,i.stageLayerElevationProvider=null,i.sharedSymbolResourcesOwnerHandle=null,i.whenGraphics3DGraphicRequests={},i.pendingUpdates=new Map,i.numberOfGraphics=0,i.numberOfGraphicsProvidingElevation=0,i.pendingAdds=0,i.pendingRemoves=0,i.pendingUpdatesPool=new m({allocator:function(e){return e||{add:null,renderingInfo:null,abortController:null,state:0,remove:null}},deallocator:function(e){return e.add=null,e.renderingInfo=null,e.remove=null,e.state=0,e.abortController=null,e}}),i.symbolWarningLogged=!1,i.geometryWarningLogged=!1,i.objectIdInvisibleSet=new Set,i._whenSymbolRemoved=new m,i.preferredUpdatePolicy=0,i.forcedUpdatePolicy=null,i._asyncUpdates=!1,i.elevationFeatureExpressionEnabled=!0,i.owner=null,i.layer=null,i.hasDraped=!1,i.graphicSymbolSupported=!0,i.getRenderingInfoWithoutRenderer=!1,i.hasZ=null,i.hasM=null,i._usedMemory=0,i._visible=void 0,i._startCreateGraphics=!1,i.maxPendingUpdates=0,i}var o;return i.__extends(t,e),o=t,Object.defineProperty(t.prototype,"spatialIndex",{get:function(){if(!this._spatialIndex){this._spatialIndex=new B.default({objectIdField:this.owner.layer&&this.owner.layer.objectIdField,spatialReference:this._spatialReference,hasZ:this.hasZ,hasM:this.hasM});var e=0,t=new Array(this.graphics3DGraphics.size);this.graphics3DGraphics.forEach((function(i){return t[e++]=i})),this._spatialIndex.addMany(t)}return this._spatialIndex},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"asyncUpdates",{get:function(){return this._asyncUpdates},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"updating",{get:function(){return!!(this.graphicsWaitingForSymbol.size>0||this.needsUpdate()||this.elevationAlignment&&this.elevationAlignment.updating||this.scaleVisibility&&this.scaleVisibility.updating||this.filterVisibility&&this.filterVisibility.updating||this.rendererChangeAbortController||this.elevationInfoChangeAbortController||this._updatingPendingLoadedGraphicsChange)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"updatingRemaining",{get:function(){return this.updating?this.pendingUpdates.size:0},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"updatingTotal",{get:function(){return this.updating?this.maxPendingUpdates:0},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"displayFeatureLimit",{get:function(){var e=this.owner&&this.owner.view&&this.owner.view.qualitySettings,t=e?e.graphics3D.minTotalNumberOfFeatures:0,i=e?e.graphics3D.maxTotalNumberOfFeatures:0,r=e?e.graphics3D.maxTotalNumberOfPrimitives:0,a=this.maxSymbolComplexity,n=Math.max(t,Math.min(i,Math.ceil(r/Math.max(1,a?a.primitivesPerFeature:1)))),o=this._get("displayFeatureLimit");return o&&o.minimumTotalNumberOfFeatures===t&&o.maximumTotalNumberOfFeatures===i&&o.maximumTotalNumberOfPrimitives===r&&o.maximumSymbolComplexity===a&&o.maximumNumberOfFeatures===n?o:{minimumTotalNumberOfFeatures:t,maximumTotalNumberOfFeatures:i,maximumTotalNumberOfPrimitives:r,maximumSymbolComplexity:a,maximumNumberOfFeatures:n}},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"maxSymbolComplexity",{get:function(){for(var e=null,t=this.symbolComplexities,i=this._get("maxSymbolComplexity"),r=!1,a=0,n=t;a<n.length;a++){var o=n[a];(!e||0===e.primitivesPerCoordinate&&o.primitivesPerFeature>e.primitivesPerFeature||0!==e.primitivesPerCoordinate&&o.primitivesPerCoordinate>e.primitivesPerCoordinate)&&(e=o),r=r||o.estimated}return!e||r&&i&&(i.primitivesPerFeature>=e.primitivesPerFeature||i.primitivesPerCoordinate>=e.primitivesPerCoordinate)||i&&i.primitivesPerFeature===e.primitivesPerFeature&&i.primitivesPerCoordinate===e.primitivesPerCoordinate?i:e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"spatialReference",{get:function(){return this._spatialReference},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"usedMemory",{get:function(){var e=this.maxSymbolComplexity&&this.labelsEnabled?this.maxSymbolComplexity.memory.bytesPerFeatureLabel*this.numberOfGraphics:0;return this._usedMemory+e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"usedMemoryPerGraphic",{get:function(){if(this._usedMemory&&this.numberOfGraphics)return this._usedMemory/this.numberOfGraphics;if(this.maxSymbolComplexity){var e=this.labelsEnabled?this.maxSymbolComplexity.memory.bytesPerFeatureLabel:0;return this.maxSymbolComplexity.memory.bytesPerFeature+e}return 0},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"unprocessedMemoryEstimate",{get:function(){return Math.max(0,(this.pendingAdds-this.pendingRemoves)*this.usedMemoryPerGraphic)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"symbolComplexities",{get:function(){return this.currentRenderer?this.getSymbolComplexitiesUsedOrRenderer(this.currentRenderer):this.getSymbolComplexitiesUsed()},enumerable:!1,configurable:!0}),t.prototype.getConvertedSymbol=function(e){if("web-style"===e.type)return e.clone();var t=this.symbolConversionCache.get(e.id);if(void 0!==t)return t;var i=O.to3D(e,!0,!1,this.hasLabelingContext(e)),r=i.symbol||null;return r||i.error&&$.error(i.error.message),this.symbolConversionCache.set(e.id,r),r},t.prototype.getSymbolComplexitiesUsedOrRenderer=function(e){if(u.isNone(e))return[];var t=e.getSymbols(),i="backgroundFillSymbol"in e&&e.backgroundFillSymbol;if(!(i||t&&t.length))return[];var r=[],a=this.getSymbolComplexityUsedOrRenderer(i);u.isSome(a)&&r.push(a);for(var n=0,o=t;n<o.length;n++){var s=o[n],l=this.getSymbolComplexityUsedOrRenderer(s);u.isSome(l)&&r.push(l)}return r},t.prototype.getSymbolComplexityUsedOrRenderer=function(e){if(u.isNone(e))return null;var t=this.symbols.get(e.id);if(u.isSome(t))return t.complexity;var i=this.getConvertedSymbol(e);return i?W.defaultSymbolComplexity(i):null},t.prototype.getSymbolComplexitiesUsed=function(){var e=[];return this.symbols.forEach((function(t){u.isSome(t)&&e.push(t.complexity)})),e},t.prototype.initialize=function(){var e=this;this._spatialReference=this.owner.view.spatialReference,this._set("featureStore",new V.default({objectIdField:this.owner.layer&&this.owner.layer.objectIdField,hasZ:this.hasZ,hasM:this.hasM,spatialReference:this._spatialReference,getSpatialIndex:function(){return e.spatialIndex},forAllGraphics:function(t){return e.graphics3DGraphics.forEach(t)}}))},t.prototype.setup=function(e){return i.__awaiter(this,void 0,void 0,(function(){var t,r,a,n,o,s=this;return i.__generator(this,(function(i){switch(i.label){case 0:return this.setupAbortController=b.createAbortController(),t=this.setupAbortController.signal,this._set("elevationAlignment",e.elevationAlignment),this._set("scaleVisibility",e.scaleVisibility),this._set("filterVisibility",e.filterVisibility),this._set("deconflictor",e.deconflictor),this._set("labeler",e.labeler),this._set("objectStates",e.objectStates),r=this.owner.view,this.viewElevationProvider=new A.ViewElevationProvider(this._spatialReference,r),this.initializeStage(r,this.layer.uid),this.symbolCreationContext.sharedResources=r.sharedSymbolResources,this.sharedSymbolResourcesOwnerHandle=r.sharedSymbolResources.addGraphicsOwner(this.owner),u.isSome(this.currentRenderer)&&(this.symbolCreationContext.renderer=this.currentRenderer),this.symbolCreationContext.stage=this.stage,this.symbolCreationContext.streamDataRequester=r.sharedSymbolResources.streamDataRequester,this.symbolCreationContext.renderCoordsHelper=r.renderCoordsHelper,this.symbolCreationContext.layer=this.layer,this.symbolCreationContext.layerView=this.owner,this.symbolCreationContext.localOriginFactory=new Q,this.symbolCreationContext.elevationProvider=r.elevationProvider,this.symbolCreationContext.notifyGraphicUpdate=function(e,t){return s.notifyGraphicUpdate(e,t)},a=L.extractExpressionInfo(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled),n=this.symbolCreationContext,[4,L.createContext(a,this._spatialReference,$)];case 1:n.featureExpressionInfoContext=i.sent(),b.throwIfAborted(t),this.symbolCreationContext.screenSizePerspectiveEnabled=r.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this.symbolCreationContext.physicalBasedRenderingEnabled=!!this.owner.view.qualitySettings.physicallyBasedRenderingEnabled,this.handles.add(this.owner.watch("suspended",(function(){return s.updateLayerVisibility()}))),o="layer"in this.owner?["layer.screenSizePerspectiveEnabled,view.screenSizePerspectiveEnabled"]:"view.screenSizePerspectiveEnabled",this.handles.add([this.owner.watch(o,(function(){var e=r.screenSizePerspectiveEnabled&&s.layer.screenSizePerspectiveEnabled;e!==s.symbolCreationContext.screenSizePerspectiveEnabled&&(s.symbolCreationContext.screenSizePerspectiveEnabled=e,s.recreateAllGraphics())})),v.init(this,"preferredUpdatePolicy",(function(){return s.updateUpdatePolicy()}),!0),this.owner.watch("slicePlaneEnabled",(function(e){return s.slicePlaneEnabledChange(!!e)})),this.owner.view.watch("pixelRatio",(function(){return s.pixelRatioChange()})),this.owner.view.watch("qualitySettings.physicallyBasedRenderingEnabled",(function(e){return s.physicalBasedRenderingChange(e)})),v.when(r.basemapTerrain,"tilingScheme",(function(e){e.spatialReference.equals(s.symbolCreationContext.overlaySR)||(s.symbolCreationContext.overlaySR=r.basemapTerrain.spatialReference),s.handles.has("loaded-graphics")?s.recreateAllGraphics():s.handles.add([v.on(s.owner,"loadedGraphics","change",(function(e){return s.graphicsCollectionChanged(e)}),(function(){return s.recreateAllGraphics()})),v.on(s.owner,"loadedGraphics","after-changes",(function(){return s._signalUpdatingDuringAsyncLoadedGraphicsChange()}),(function(){return s._signalUpdatingDuringAsyncLoadedGraphicsChange()}))],"loaded-graphics")})),r.resourceController.scheduler.registerTask(K.Task.GRAPHICS_CORE,(function(e){return s.update(e)}),(function(){return s.needsUpdate()}))]),this.owner.layer&&"featureReduction"in this.owner.layer&&this.handles.add(this.owner.watch("layer.featureReduction",(function(){return s.deconflictor.featureReductionChange()}))),this.notifyChange("maxSymbolComplexity"),i.label=2;case 2:return i.trys.push([2,4,,5]),[4,this.rendererChange(this.layer.renderer)];case 3:return i.sent(),[3,5];case 4:return i.sent(),[3,5];case 5:return b.throwIfAborted(t),this.setupAbortController=null,[2]}}))}))},t.prototype.abortSetup=function(){this.setupAbortController&&(this.setupAbortController.abort(),this.setupAbortController=null)},t.prototype.destroy=function(){for(var e in this.abortSetup(),this.abortRendererChange(),this.abortElevationInfoChange(),this.owner.view.deconflictor.removeGraphicsOwner(this),this.owner.view.labeler.removeGraphicsOwner(this),this._updatingPendingLoadedGraphicsChange&&(this._updatingPendingLoadedGraphicsChange.remove(),this._updatingPendingLoadedGraphicsChange=null),this.clear(),u.isSome(this.graphicStateTracking)&&(this.graphicStateTracking.destroy(),this.graphicStateTracking=null),this.stage&&(this.stage.removeFromViewContent([this.stageLayer.id]),this.stage.remove(0,this.stageLayer.id),this.stageLayer=null,this.stage=null),this.handles.destroy(),this.handles=null,this._spatialReference=null,this._set("owner",null),this.whenGraphics3DGraphicRequests)this.whenGraphics3DGraphicRequests[e].reject(new h("graphic:layer-destroyed","Layer has been destroyed"));this.whenGraphics3DGraphicRequests=null,this.sharedSymbolResourcesOwnerHandle&&(this.sharedSymbolResourcesOwnerHandle.remove(),this.sharedSymbolResourcesOwnerHandle=null),this.propertiesPool&&(this.propertiesPool.destroy(),this.propertiesPool=null),this.pendingUpdatesPool=null,this.symbolConversionCache.clear(),this.objectIdInvisibleSet.clear(),this._spatialIndex&&(this._spatialIndex.destroy(),this._spatialIndex=null),this.featureStore&&(this.featureStore.destroy(),this._set("featureStore",null))},t.prototype.clear=function(){this.objectStates&&this.objectStates.allGraphicsDeleted(),u.isSome(this.graphicStateTracking)&&this.graphicStateTracking.allGraphicsDeleted(),this.graphics3DGraphics.forEach((function(e){return e.destroy()})),this._spatialIndex&&this._spatialIndex.clear(),this.graphics3DGraphics.clear(),this.numberOfGraphics=0,this._usedMemory=0,this.updateLayerVisibility(),this.symbols.forEach((function(e){u.isSome(e)&&e.destroy()})),this.symbols.clear(),this.graphicsBySymbol.clear(),this.graphicsWithoutSymbol.clear(),this.graphicsWaitingForSymbol.clear(),this.pendingUpdates.clear(),this.pendingUpdatesPool.clear(),this.maxPendingUpdates=0,this.pendingAdds=0,this.pendingRemoves=0,this._set("hasDraped",!1),this.notifyChange("updating"),this.notifyChange("updatingTotal"),this.notifyChange("updatingRemaining"),this.featureStore.events.emit("changed")},t.prototype.initializeStage=function(e,t){var i=this;this.stage=e._stage,this.stageLayer=new J(t,{isPickable:!this.owner.suspended},t),this.stage.add(0,this.stageLayer),this.stage.addToViewContent([this.stageLayer.id]),this.stageLayer.on("dirty",(function(e){if(i.graphicStateTracking)switch(e.dirtyType){case"objTransformation":case"objGeometryAdded":case"objGeometryRemoved":case"shaderTransformationChanged":case"vertexAttrsUpdated":var t=e.origin.metadata.graphicUid;i.notifyGraphicUpdate(t,2);break;case"visibilityChanged":t=e.origin.metadata.graphicUid;i.notifyGraphicUpdate(t,1)}}))},t.prototype.notifyGraphicUpdate=function(e,t){switch(t){case 1:this.notifyGraphicVisibilityChanged(e);break;case 2:this.notifyGraphicGeometryChanged(e)}},t.prototype.notifyGraphicGeometryChanged=function(e){if(!u.isNone(this.graphicStateTracking)){var t=this.graphics3DGraphics.get(e);t&&this.graphicStateTracking.updateGraphicGeometry(t)}},t.prototype.notifyGraphicVisibilityChanged=function(e){if(!u.isNone(this.graphicStateTracking)){var t=this.graphics3DGraphics.get(e);t&&this.graphicStateTracking.updateGraphicVisibility(t)}},t.prototype.updateLayerVisibility=function(){var e=!!this.owner.suspended,t=this.numberOfGraphics>this.displayFeatureLimit.maximumNumberOfFeatures*ae,i=!e&&!t;i!==this._visible&&(this._visible=i,i?(this.stageLayer.isPickable=!0,this.updateAllGraphicsVisibility()):(this.stageLayer.isPickable=!1,this.hideAllGraphics()),this.updateStageLayerVisibility())},t.prototype.updateStageLayerVisibility=function(){this.stageLayer.isVisible=this._visible&&(null==this.layer.opacity||this.layer.opacity>0)},t.prototype.getGraphics3DGraphicById=function(e){return this.graphics3DGraphics.get(e)},t.prototype.getGraphics3DGraphicByObjectId=function(e){var t=this;if(!(this.owner.layer&&this.owner.layer.objectIdField))return null;var i=null;return c.someMap(this.graphics3DGraphics,(function(r){return t._getGraphicObjectID(r.graphic)!==e||(i=r,!1)})),i},t.prototype._getGraphicObjectID=function(e,t){return void 0===t&&(t=this.owner.layer&&this.owner.layer.objectIdField),D.getObjectId(e,t)},Object.defineProperty(t.prototype,"graphics3DGraphicsByObjectID",{get:function(){var e=this,t=this.owner.layer&&this.owner.layer.objectIdField;if(!t)return null;var i=new Map;return this.graphics3DGraphics.forEach((function(r){if(r){var a=r.graphic,n=e._getGraphicObjectID(a,t);u.isSome(n)&&i.set(n,r)}})),i},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"labelsEnabled",{get:function(){return!(!this.labeler||!this.labeler.layerLabelsEnabled())},enumerable:!1,configurable:!0}),t.prototype.updateLabelingInfo=function(e){return i.__awaiter(this,void 0,void 0,(function(){var t,r;return i.__generator(this,(function(i){switch(i.label){case 0:return t=this.deconflictor&&this.deconflictor.labelingInfoChange(e),r=this.labeler&&this.labeler.labelingInfoChange(e),[4,b.eachAlways([t,r])];case 1:return i.sent(),[2]}}))}))},t.prototype.updateVisibilityInfo=function(){this.deconflictor&&this.deconflictor.labelingInfoChange(),this.labeler&&this.labeler.visibilityInfoChange()},Object.defineProperty(t.prototype,"symbolUpdateType",{get:function(){var e=this;if(this.pendingUpdates.size>0)return"unknown";var t=0,i=0;return c.someMap(this.symbols,(function(r,a){if(u.isSome(r)){var n=r.getFastUpdateStatus();if(n.loading>0)return!0;e.graphicsBySymbol.has(a)&&(i+=n.fast,t+=n.slow)}return!1}))?"unknown":i>=0&&0===t?"fast":t>=0&&0===i?"slow":"mixed"},enumerable:!1,configurable:!0}),t.prototype.needsUpdate=function(){return this.pendingUpdates.size>0},t.prototype.update=function(e){this._applyPendingUpdates(e),this.needsUpdate()||this.notifyChange("updating")},t.prototype.setObjectIdVisibility=function(e,t){t?this.objectIdInvisibleSet.delete(e):this.objectIdInvisibleSet.add(e);var i=this._findGraphics3DGraphicByObjectId(e);u.isSome(i)&&this._updateUserVisibility(i)},t.prototype._findGraphics3DGraphicByObjectId=function(e){var t,i=this;return c.someMap(this.graphics3DGraphics,(function(r){return i._getGraphicObjectID(r.graphic)===e&&(t=r,!0)})),t},t.prototype._updateUserVisibility=function(e){if(u.isNone(e))return!1;var t=e.graphic,i=this._getGraphicObjectID(t),r=t.visible&&!this.owner.suspended&&(u.isNone(i)||!this.objectIdInvisibleSet.has(i));return e.setVisibilityFlag(0,r,0)},t.prototype.whenGraphics3DGraphic=function(e){var t=this.graphics3DGraphics.get(e.uid);if(t)return b.resolve(t);var i=this.whenGraphics3DGraphicRequests[e.uid];if(i)return i.promise;var r=b.createDeferred();return this.whenGraphics3DGraphicRequests[e.uid]=r,r.promise},t.prototype.boundsForGraphics3DGraphic=function(e,t){return i.__awaiter(this,void 0,void 0,(function(){var r,a,n,o,s,l,h,p,d,c;return i.__generator(this,(function(i){switch(i.label){case 0:return r=this._spatialReference,a=this.owner.view.renderSpatialReference,n=this.owner.view.basemapTerrain.spatialReference,o=function(e,t,i){return H.bufferToBuffer(e,a,t,e,r,t,i)},s=function(e,t,i){return H.bufferToBuffer(e,n,t,e,r,t,i)},l=this.viewElevationProvider?{service:this.viewElevationProvider,useViewElevation:u.isSome(t)&&t.useViewElevation,minDemResolution:u.isSome(t)&&t.minDemResolution,minDemResolutionForPoints:this.owner.view.resolution}:null,[4,e.getProjectedBoundingBox(o,s,l,u.get(t,"signal"))];case 1:return(h=i.sent())?(p=h.boundingBox,h.requiresDrapedElevation&&(d=this.symbolCreationContext.elevationProvider)&&(_.center(p,X),c=d.getElevation(X[0],X[1],0,r,"ground")||0,p[2]=Math.min(p[2],c),p[5]=Math.max(p[5],c)),[2,{boundingBox:p,screenSpaceObjects:h.screenSpaceObjects}]):[2,null]}}))}))},t.prototype.whenGraphicBounds=function(e,t){var i=this;return v.whenOnce(this.owner,"loadedGraphics").then((function(){var t=i.owner.layer&&i.owner.layer.objectIdField,r=i.owner.loadedGraphics.find((function(i){return i===e||t&&i.attributes&&e.attributes&&i.attributes[t]===e.attributes[t]}));if(r)return i.whenGraphics3DGraphic(r);throw new h("internal:graphic-not-part-of-view","Graphic is not part of this view")})).then((function(e){return i.boundsForGraphics3DGraphic(e,t)}))},t.prototype.computeAttachmentOrigin=function(e,t){var i=this.graphics3DGraphics.get(e.uid);if(!i)return null;var a=i.computeAttachmentOrigin();if(0===a.render.num&&0===a.draped.num)return null;w.vec3.set(ne,0,0,0);var n=0;if(a.render.num>0){if(!H.vectorToVector(a.render.origin,this.symbolCreationContext.renderCoordsHelper.spatialReference,oe,t))return null;w.vec3.add(ne,ne,oe),n++}if(a.draped.num>0){var o=a.draped.origin,s=o[0],l=o[1],h=this.viewElevationProvider.getElevation(s,l,"ground")||0;if(w.vec3.set(oe,s,l,h),!H.vectorToVector(oe,this.viewElevationProvider.spatialReference,oe,t))return null;w.vec3.add(ne,ne,oe),n++}return n>1&&w.vec3.scale(ne,ne,1/n),new r.Point({x:ne[0],y:ne[1],z:ne[2],spatialReference:t})},t.prototype.getSymbolLayerSize=function(e,t){var i=this.symbols.get(e.id);if(u.isNone(i))throw new h("internal:symbol-not-part-of-view","Symbol is not part of this view");var r=e.symbolLayers.indexOf(t);if(-1===r)throw new h("internal:missing-symbol-layer","Symbol layer is not in symbol");var a=i.getSymbolLayerSize(r);if(null==a)throw new h("internal:missing-size","Symbol layer has no valid size");return a},t.prototype.graphicsCollectionChanged=function(e){this._startCreateGraphics&&(this.add(e.added),this.remove(e.removed))},t.prototype.graphicUpdateHandler=function(e){var t=e.graphic.uid,i=this.graphics3DGraphics.get(t),r=this.graphicsWithoutSymbol.get(t);if(i||r)switch(e.property){case"visible":this.graphicUpdateVisibleHandler(i);break;case"geometry":this.graphicUpdateGeometryHandler(i,e);break;case"symbol":this.graphicUpdateSymbolHandler(i,e);break;case"attributes":break;default:l.neverReached(e)}},t.prototype.graphicUpdateGeometryHandler=function(e,t){var i=t.graphic.geometry;if(u.isNone(i))this.recreateGraphic(t.graphic);else if(u.isNone(e)){var r=t.graphic.symbol&&t.graphic.symbol.id;if(r){var a=this.symbols.get(r);if(u.isSome(a)&&0===a.loadStatus)return}this.recreateGraphic(t.graphic)}else{e.graphics3DSymbol.updateGeometry(e,t.newValue)||this.recreateGraphic(e.graphic),this.expandComputedExtent(i)}},t.prototype.graphicUpdateSymbolHandler=function(e,t){var i=t.graphic,r=u.isSome(e)?e.graphics3DSymbol:t.oldValue&&this.symbols.get(t.oldValue.id);if(u.isNone(r))this.recreateGraphic(i);else{var a=r.symbol,n=this.getConvertedSymbol(t.newValue);if(n.type===a.type&&"web-style"!==n.type&&"web-style"!==a.type){var o=this.graphicsBySymbol.get(a.id);if(o&&1!==o.size)this.recreateGraphic(i);else{var s=C.diff(a,n);if(u.isNone(s))this.updateSymbolMapping(a.id,n);else{var l={diff:s,graphics3DGraphicPatches:[],symbolStatePatches:[]};if(r.prepareSymbolPatch(l),C.isEmpty(l.diff)){for(var h=r.extentPadding,p=0,d=l.symbolStatePatches;p<d.length;p++){(0,d[p])()}h!==r.extentPadding&&this.recomputeExtentPadding();var c=this._getRenderingInfo(i);if(u.isSome(e))for(var y=0,g=l.graphics3DGraphicPatches;y<g.length;y++){(0,g[y])(e,c)}this.updateSymbolMapping(a.id,n)}else this.recreateGraphic(i)}}}else this.recreateGraphic(i)}},t.prototype.graphicUpdateVisibleHandler=function(e){this._updateUserVisibility(e)&&(this.labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty())},t.prototype.recreateGraphic=function(e){var t=[e];this.suspendSymbolCleanup=!0,this.remove(t),this.add(t),this.suspendSymbolCleanup=!1,this.asyncUpdates||this._cleanupSymbols()},t.prototype._beginGraphicUpdate=function(e){this.graphicsWaitingForSymbol.add(e.uid),1===this.graphicsWaitingForSymbol.size&&this.notifyChange("updating"),this._get("symbolsUpdating")||this._set("symbolsUpdating",!0)},t.prototype._endGraphicUpdate=function(e){e&&(this.graphicsWaitingForSymbol.delete(e.uid),0===this.graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("updating"),this._get("symbolsUpdating")&&(this.owner.view.flushDisplayModifications(),this._set("symbolsUpdating",!1))))},t.prototype.recomputeExtentPadding=function(){var e=0;this.symbols.forEach((function(t){u.isSome(t)&&(e=Math.max(e,t.extentPadding))})),this._set("extentPadding",e)},t.prototype.expandComputedExtent=function(e){var t=Y,i=e.spatialReference;D.computeAABB(e,t);var r=this._spatialReference,a=o.tmpVec;if(i.equals(r)||H.xyzToVector(t[0],t[1],0,i,a,r)&&(t[0]=a[0],t[1]=a[1],H.xyzToVector(t[3],t[4],0,i,a,r),t[3]=a[0],t[4]=a[1]),y.isFinite(t[0])&&y.isFinite(t[3])&&y.isFinite(t[1])&&y.isFinite(t[4])){var n=this.computedExtent,s=null,l=y.isFinite(t[2])&&y.isFinite(t[5]),h=l&&(!n||null==n.zmin||t[2]<n.zmin),p=l&&(!n||null==n.zmax||t[5]>n.zmax);if(n)(t[0]<n.xmin||t[1]<n.ymin||t[3]>n.xmax||t[4]>n.ymax||h||p)&&((s=this.propertiesPool.get("computedExtent")).xmin=Math.min(t[0],n.xmin),s.ymin=Math.min(t[1],n.ymin),s.xmax=Math.max(t[3],n.xmax),s.ymax=Math.max(t[4],n.ymax),s.spatialReference=r);else(s=this.propertiesPool.get("computedExtent")).xmin=t[0],s.ymin=t[1],s.xmax=t[3],s.ymax=t[4],s.spatialReference=r;s&&(h&&(s.zmin=t[2]),p&&(s.zmax=t[5]),this._set("computedExtent",s))}},t.prototype.updateHasDraped=function(){var e=this.graphicsDrapedUids.size>0;this._set("hasDraped",e)},t.prototype.abortElevationInfoChange=function(){this.elevationInfoChangeAbortController&&(this.elevationInfoChangeAbortController.abort(),this.elevationInfoChangeAbortController=null)},t.prototype.elevationInfoChange=function(){return i.__awaiter(this,void 0,void 0,(function(){var e,t,r,a=this;return i.__generator(this,(function(i){switch(i.label){case 0:return this.abortElevationInfoChange(),e=b.createAbortController(),this.elevationInfoChangeAbortController=e,t=L.extractExpressionInfo(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled),r=this.symbolCreationContext,[4,L.createContext(t,this._spatialReference,$)];case 1:return r.featureExpressionInfoContext=i.sent(),b.throwIfAborted(e),this.elevationInfoChangeAbortController=null,this.labeler&&this.labeler.elevationInfoChange(),this.forEachGraphics3DSymbol((function(e,t,i){e.globalPropertyChanged("elevationInfo",t)?t.forEach((function(e){for(var t=e.graphic,i=0,r=e.labelGraphics;i<r.length;i++){var a=r[i];a.graphics3DSymbolLayer.updateGraphicElevationContext(t,a)}})):a._recreateSymbol(i)})),this.updateStageLayerElevationProvider(),this.elevationAlignment&&this.elevationAlignment.elevationInfoChange(),[2]}}))}))},t.prototype.updateStageLayerElevationProvider=function(){this.stageLayerElevationProvider?(this.layer.elevationInfo&&"relative-to-scene"===this.layer.elevationInfo.mode||0===this.numberOfGraphicsProvidingElevation)&&(this.owner.view.elevationProvider.unregister(this.stageLayerElevationProvider),this.stageLayerElevationProvider.dispose(),this.stageLayerElevationProvider=null):(!this.layer.elevationInfo||this.layer.elevationInfo&&"relative-to-scene"!==this.layer.elevationInfo.mode)&&this.numberOfGraphicsProvidingElevation>0&&(this.stageLayerElevationProvider=new N.StageLayerElevationProvider({layer:this.layer,stageLayer:this.stageLayer,view:this.owner.view}),this.owner.view.elevationProvider.register("scene",this.stageLayerElevationProvider))},t.prototype.clearSymbolsAndGraphics=function(){this.clear(),this.filterVisibility&&this.filterVisibility.clear(),this.labeler&&this.labeler.reset(),this.deconflictor&&this.deconflictor.clear(),this.elevationAlignment&&this.elevationAlignment.clear(),this.stageLayer&&this.stageLayer.invalidateSpatialQueryAccelerator(),this.stageLayerElevationProvider&&(this.owner.view.elevationProvider.unregister(this.stageLayerElevationProvider),this.stageLayerElevationProvider.dispose(),this.stageLayerElevationProvider=null)},t.prototype.startCreateGraphics=function(){this._startCreateGraphics=!0,this.recreateAllGraphics()},t.prototype.recreateAllGraphics=function(){this._startCreateGraphics&&(this.clearSymbolsAndGraphics(),this._set("computedExtent",null),this.symbolCreationContext.screenSizePerspectiveEnabled=this.owner.view.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this.owner.loadedGraphics&&this.owner.loadedGraphics.length&&this.owner.view.basemapTerrain.tilingScheme&&this.add(this.owner.loadedGraphics.toArray()))},t.prototype._recreateSymbol=function(e){var t=this;var i=this.graphicsBySymbol.get(e),r=[];i&&(i.forEach((function(e,i){var a=e.usedMemory;t._conditionalRemove(e,i),t._spatialIndex&&t._spatialIndex.remove(e),r.push(e.graphic),e.destroy(),t.removeGraphics3DGraphic(i,a),t.updateLayerVisibility(),t.featureStore.events.emit("changed")})),this.graphicsBySymbol.set(e,new Map));var a=this.symbols.get(e);u.isSome(a)&&a.destroy(),this.symbols.delete(e),this.updateHasDraped(),this.add(r)},t.prototype._conditionalRemove=function(e,t){e.isDraped&&this.graphicsDrapedUids.delete(t),this.objectStates&&this.objectStates.removeGraphic(e),this.labeler&&this.labeler.removeGraphic(e),this.deconflictor&&this.deconflictor.removeGraphic(e),u.isSome(this.graphicStateTracking)&&this.graphicStateTracking.removeGraphic(e)},t.prototype.add=function(e){e&&0!==e.length&&(this.owner.view.basemapTerrain&&this.owner.view.basemapTerrain.tilingScheme?(this.asyncUpdates?this._addDelayed(e):this._addImmediate(e),this.notifyChange("updating")):$.error("#add()","Cannot add graphics before terrain surface has been initialized"))},t.prototype._addImmediate=function(e){var t=this;this.geometryWarningLogged=!1,this.symbolWarningLogged=!1,te.clear();for(var i=0,r=e;i<r.length;i++){var a=r[i];this._startAddGraphic(a,this._getRenderingInfo(a,$),te)}te.forEach((function(e){return t._finishAddGraphics(e)})),te.clear(),this.updateHasDraped(),this._cleanupSymbols(),this.labeler&&(this.owner.view.labeler.setDirty(),this._cleanupSymbols()),this.owner.view.deconflictor.setDirty()},t.prototype._addDelayed=function(e){for(var t=0,i=e;t<i.length;t++){var r=i[t],a=r.uid,n=this.pendingUpdates.get(a);n?n.add?0!==n.state&&n.abortController.abort():this.pendingAdds++:(n=this.pendingUpdatesPool.pushNew(),this.pendingAdds++,this.pendingUpdates.set(a,n)),n.add=r}this.maxPendingUpdates=Math.max(this.maxPendingUpdates,this.pendingUpdates.size),this.notifyChange("updatingTotal"),this.notifyChange("updatingRemaining")},t.prototype.remove=function(e){this.asyncUpdates?this._removeDelayed(e):this._removeImmediate(e),this.notifyChange("updating")},t.prototype._removeImmediate=function(e){for(var t=0,i=e;t<i.length;t++){var r=i[t];this._removeGraphic(r)}this.updateHasDraped(),this._cleanupSymbols(),this.labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty()},t.prototype._removeDelayed=function(e){for(var t=0,i=e;t<i.length;t++){var r=i[t],a=r.uid,n=this.pendingUpdates.get(a);if(n)n.add&&(n.remove?n.add=null:this.pendingUpdates.delete(a),1===n.state&&n.abortController.abort(),this.pendingAdds--);else{var o=this.pendingUpdatesPool.pushNew();o.remove=r,this.pendingUpdates.set(a,o),this.pendingRemoves++}}0===this.pendingUpdates.size&&this._finishPendingUpdates(),this.maxPendingUpdates=Math.max(this.maxPendingUpdates,this.pendingUpdates.size),this.notifyChange("updatingTotal"),this.notifyChange("updatingRemaining")},t.prototype._finishPendingUpdates=function(){this.pendingUpdatesPool.clear(),this.maxPendingUpdates=0,this._cleanupSymbols(),(this.pendingAdds||this.pendingRemoves)&&$.warn("pendingAdds/Removes in inconsistent state!"),this.pendingAdds=0,this.pendingRemoves=0},t.prototype._applyPendingUpdates=function(e){var t=this;this.geometryWarningLogged=!1,this.symbolWarningLogged=!1;var i=2===e.state?1e3:100,r=0;te.clear(),c.someMap(this.pendingUpdates,(function(a,n){if(a.add&&0===a.state&&t._startAddRenderingInfo(a),!a.remove||a.add&&2!==a.state||(t.pendingRemoves--,t._removeGraphic(a.remove),a.remove=null),a.add)switch(a.state){case 2:t._startAddGraphic(a.add,a.renderingInfo,te)&&r++,a.add=null,t.pendingAdds--;break;case 3:a.add=null,t.pendingAdds--}return r>i&&(te.forEach((function(e){return t._finishAddGraphics(e)})),te.clear(),r=0),null==a.remove&&null==a.add&&(t.pendingUpdates.delete(n),e.madeProgress()),e.done})),te.forEach((function(e){return t._finishAddGraphics(e)})),te.clear(),0===this.pendingUpdates.size&&this._finishPendingUpdates(),this.notifyChange("updatingTotal"),this.notifyChange("updatingRemaining"),this.updateHasDraped()},t.prototype._startAddRenderingInfo=function(e){var t=this;u.isSome(this.layer.renderer)&&"dictionary"===this.layer.renderer.type?(e.state=1,e.abortController=b.createAbortController(),this._getRenderingInfoAsync(e.add,{signal:e.abortController.signal}).then((function(i){u.isNone(i)||u.isNone(i.symbol)?($&&!t.symbolWarningLogged&&(t.symbolWarningLogged=!0,$.warn("Graphic in layer "+t.layer.id+" has no symbol and will not render")),e.renderingInfo=null):e.renderingInfo=i,e.state=2}),(function(t){e.abortController=null,b.isAbortError(t)?e.state=0:e.state=3}))):(e.renderingInfo=this._getRenderingInfo(e.add,$),e.state=2)},t.prototype._startAddGraphic=function(e,t,i){if(this.graphicsWithoutSymbol.set(e.uid,e),!t||u.isNone(t.symbol)||!D.hasGeometry(e))return!1;var r=t.symbol,a=this.getOrCreateGraphics3DSymbol(r,t.renderer);if(u.isNone(a))return!1;this.expandComputedExtent(e.geometry),this._beginGraphicUpdate(e);var n={graphic:e,renderingInfo:t,layer:this.layer},o=a.symbol.id,s=i.get(o);if(s)s.graphics.push(n);else{var l=re.acquire();l.clear(),l.push(n),i.set(o,{asyncSymbol:a,graphics:l})}return!0},t.prototype._finishAddGraphics=function(e){var t=this,i=!1,r=function(t){t===e.asyncSymbol.symbol.id&&(i=!0)};this._whenSymbolRemoved.push(r);e.asyncSymbol.load((function(){if(!t.destroyed){t._whenSymbolRemoved.removeUnordered(r),ie.clear();for(var a=0;a<e.graphics.length;a++){var n=e.graphics.data[a],o=n.graphic;if(!(i||e.asyncSymbol.destroyed||t.graphicSymbolSupported&&o.symbol&&o.symbol.id!==e.asyncSymbol.symbol.id)){if(t.graphicsWaitingForSymbol.has(o.uid)){var s=t.createGraphics3DGraphic(e.asyncSymbol,n);t._spatialIndex&&u.isSome(s)&&ie.push(s)}t._endGraphicUpdate(o)}--e.asyncSymbol.referenced}ie.length>0&&(t._spatialIndex.addMany(ie.data,ie.length),ie.clear()),t.featureStore.events.emit("changed"),e.graphics.clear(),re.release(e.graphics),t.labeler&&t.owner.view.labeler.setDirty()}}),(function(a){if(!t.destroyed){if(t._whenSymbolRemoved.removeUnordered(r),!i)if(b.isAbortError(a))t.add(e.graphics.map((function(e){return e.graphic})));else if(!e.asyncSymbol.destroyed)for(var n=0;n<e.graphics.length;n++)t._endGraphicUpdate(e.graphics.data[n].graphic);e.graphics.clear(),re.release(e.graphics)}}))},t.prototype._removeGraphic=function(e){var t=e.uid,i=this.graphics3DGraphics.get(t);if(i){i.graphics3DSymbol.onRemoveGraphic(i);var r=i.usedMemory,a=i.isElevationSource;this._conditionalRemove(i,t),this._spatialIndex&&this._spatialIndex.remove(i);var n=i.graphics3DSymbol.symbol.id;this.graphicsBySymbol.get(n).delete(t),this.graphicsWithoutSymbol.delete(t),this.removeGraphics3DGraphic(t,r,a),i.destroy(),this.featureStore.events.emit("changed")}else this.graphicsWithoutSymbol.delete(t),this.graphicsWaitingForSymbol.delete(t)},t.prototype.hasLabelingContext=function(e){if(e instanceof n.LabelSymbol3D||e instanceof n.TextSymbol){var t=this.symbolCreationContext.layer;return!!t.labelingInfo&&t.labelingInfo.some((function(t){return t.symbol===e}))}return!1},t.prototype.hasValidSymbolCreationContext=function(e){return!(e instanceof n.LabelSymbol3D&&!this.hasLabelingContext(e))||($.error("LabelSymbol3D is only valid as part of a LabelClass. Using LabelSymbol3D as a renderer symbol is not supported."),!1)},t.prototype._getRenderingInfo=function(e,t){var i=e.geometry;if(u.isNone(i))return t&&!this.geometryWarningLogged&&(this.geometryWarningLogged=!0,t.warn("Graphic in layer "+this.layer.id+" has no geometry and will not render")),null;if(!H.canProject(i.spatialReference,this._spatialReference))return t&&!this.geometryWarningLogged&&(this.geometryWarningLogged=!0,t.warn("Graphic in layer "+this.layer.id+" has incompatible spatial reference and will not render")),null;if(!this.graphicSymbolSupported&&u.isSome(e.symbol))return t&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,t.warn("Graphic in layer "+this.layer.id+" is not allowed to have a symbol, use a renderer instead")),null;var r,a=this.rendererHasGeometryOperations?R.hydrateGraphic(e,this.layer):e;this.owner.getRenderingInfo&&(this.getRenderingInfoWithoutRenderer||u.isSome(this.currentRenderer))?r=this.owner.getRenderingInfo(a,this.currentRenderer,u.unwrap(this.arcadeOnDemand)):r={symbol:a.symbol||I.getDefaultSymbol3D(a.geometry)};return!r||u.isNone(r.symbol)?(t&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,t.warn("Graphic in layer "+this.layer.id+" has no symbol and will not render")),null):r},t.prototype._getRenderingInfoAsync=function(e,t){var i=e.geometry;if(u.isNone(i))return $&&!this.geometryWarningLogged&&(this.geometryWarningLogged=!0,$.warn("Graphic in layer "+this.layer.id+" has no geometry and will not render")),null;if(!this.graphicSymbolSupported&&u.isSome(e.symbol))return $&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,$.warn("Graphic in layer "+this.layer.id+" is not allowed to have a symbol, use a renderer instead")),null;var r=this.rendererHasGeometryOperations?R.hydrateGraphic(e,this.layer):e;return this.owner.getRenderingInfoAsync(r,u.unwrap(this.currentRenderer),u.unwrap(this.arcadeOnDemand),t)},t.prototype.createGraphics3DSymbol=function(e,t){var i=this;if(!this.hasValidSymbolCreationContext(e))return null;var r,a=this.getConvertedSymbol(e);if(!a)return null;if(u.isSome(t)&&"backgroundFillSymbol"in t&&t.backgroundFillSymbol){var n=O.to3D(t.backgroundFillSymbol,!1,!0);n.symbol&&"web-style"!==n.symbol.type&&(r=n.symbol.symbolLayers)}var o=j.make(a,this.symbolCreationContext,r);return o.load((function(){var e=o.extentPadding;e>i.extentPadding&&i._set("extentPadding",e),i.notifyChange("maxSymbolComplexity")}),(function(){})),o},t.prototype.getOrCreateGraphics3DSymbol=function(e,t){var i=this,r=this.symbols.get(e.id);return void 0===r&&(r=e instanceof n.WebStyleSymbol?new T(e,(function(e){return i.createGraphics3DSymbol(e,t)})):this.createGraphics3DSymbol(e,t),this.symbols.set(e.id,r)),u.isSome(r)&&++r.referenced,r},t.prototype.trackGraphicState=function(e){return u.isNone(this.graphicStateTracking)&&(this.graphicStateTracking=new k.GraphicStateTracking(this)),this.graphicStateTracking.add(e)},t.prototype.addGraphics3DGraphic=function(e){this._usedMemory+=e.usedMemory,this.graphics3DGraphics.set(e.graphic.uid,e),this.numberOfGraphics++,e.isElevationSource&&(this.numberOfGraphicsProvidingElevation++,this.updateStageLayerElevationProvider()),this.updateLayerVisibility()},t.prototype.removeGraphics3DGraphic=function(e,t,i){void 0===i&&(i=!1),this._usedMemory-=t,this.graphics3DGraphics.delete(e),this.numberOfGraphics--,i&&(this.numberOfGraphicsProvidingElevation--,this.updateStageLayerElevationProvider()),this.updateLayerVisibility()},t.prototype.createGraphics3DGraphic=function(e,t){var i=t.graphic;if(this.graphicsWithoutSymbol.delete(i.uid),!this.symbols.has(e.symbol.id))return this.add([i]),null;if(this.graphics3DGraphics.has(i.uid))return null;var r=e.createGraphics3DGraphic(t);if(u.isNone(r))return null;this.addGraphics3DGraphic(r);var a=e.symbol.id;this.graphicsBySymbol.has(a)||this.graphicsBySymbol.set(a,new Map),this.graphicsBySymbol.get(a).set(i.uid,r),r.isDraped&&(this.graphicsDrapedUids.add(i.uid),this._set("hasDraped",!0)),r.centroid=null,u.isSome(i.geometry)&&"point"!==i.geometry.type&&r instanceof F&&(r.centroid=z.computeCentroid(i.geometry,this._spatialReference)),this._updateUserVisibility(r),this.scaleVisibility&&this.scaleVisibility.updateVisibility(r),this.filterVisibility&&this.filterVisibility.updateVisibility(r),this.deconflictor&&this.deconflictor.addGraphic(r),this.labeler&&this.labeler.addGraphic(r),this.objectStates&&this.objectStates.addGraphic(r),this.deconflictor&&this.owner.view.deconflictor.setInitialIconVisibilityFlag(this,r),r.initialize(this.stage,this.stageLayer,this.owner),u.isSome(this.graphicStateTracking)&&this.graphicStateTracking.addGraphic(r);var n=this.whenGraphics3DGraphicRequests[i.uid];return n&&(delete this.whenGraphics3DGraphicRequests[i.uid],n.resolve(r)),r},t.prototype.abortRendererChange=function(){this.rendererChangeAbortController&&(this.rendererChangeAbortController.abort(),this.rendererChangeAbortController=null)},t.prototype.rendererChange=function(e){return i.__awaiter(this,void 0,void 0,(function(){var t,r;return i.__generator(this,(function(i){switch(i.label){case 0:return this.abortRendererChange(),e===this.currentRenderer?[2]:(this.validateRenderer(e),U.isSupportedRenderer3D(e)?u.isSome(e)&&e.arcadeRequired?(t=b.createAbortController(),this.rendererChangeAbortController=t,[4,this.ensureArcade()]):[3,4]:(this.currentRendererChange(null,!1),[2]));case 1:return r=i.sent().arcadeUtils,b.throwIfAborted(t),r.hasGeometryOperations(e)?[4,r.enableGeometryOperations()]:[3,3];case 2:i.sent(),b.throwIfAborted(t),i.label=3;case 3:return this.rendererChangeAbortController=null,this.currentRendererChange(e,!0),[3,5];case 4:this.currentRendererChange(e,!1),i.label=5;case 5:return[2]}}))}))},t.prototype.ensureArcade=function(){return i.__awaiter(this,void 0,void 0,(function(){var e;return i.__generator(this,(function(t){switch(t.label){case 0:return u.isNone(this.arcadeOnDemand)?(e=this,[4,E.loadArcade()]):[3,2];case 1:return e.arcadeOnDemand=t.sent(),[2,this.arcadeOnDemand];case 2:return[2,this.arcadeOnDemand]}}))}))},t.prototype.currentRendererChange=function(e,t){this.currentRenderer=e,this.rendererHasGeometryOperations=t,this.symbolCreationContext.arcade=u.unwrap(this.arcadeOnDemand);var i=this.symbolCreationContext.renderer;if(e!==i){if(this.updateUpdatePolicy(),this.symbolConversionCache.clear(),u.isNone(e))return this.symbolCreationContext.renderer=null,void this.recreateAllGraphics();var r=C.diff(i,e);this.updateUnchangedSymbolMappings(r,e,i),this.symbolCreationContext.renderer=e,u.isNone(r)||("complete"===r.type?this.recreateAllGraphics():"partial"===r.type&&(this.applyRendererDiff(r,e,i)?this.volatileGraphicsUpdated():this.recreateAllGraphics()),this.notifyChange("maxSymbolComplexity"))}},t.prototype.diffHasSymbolChange=function(e){for(var t in e.diff)switch(t){case"visualVariables":case"defaultSymbol":case"uniqueValueInfos":break;case"authoringInfo":case"fieldDelimiter":delete e.diff[t];break;default:return!0}return!1},t.prototype.applySymbolSetDiff=function(e,t,i){var r=this;e=e||[];for(var a=[],n=function(t){var n=o.graphicsBySymbol.get(t.id);n&&n.forEach((function(o,s){var l=o.graphic,h=r.layer instanceof P?r.layer:null,p=u.unwrap(r.arcadeOnDemand);if(t!==i.defaultSymbol||i.getSymbol(R.hydrateGraphic(l,h),{arcade:p})!==i.defaultSymbol){var d=o.usedMemory;e.length||i.defaultSymbol?a.push(l):r.graphicsWithoutSymbol.set(s,l);var c=r.graphics3DGraphics.get(s);r._conditionalRemove(c,s),o.destroy(),n.delete(s),r.removeGraphics3DGraphic(s,d),r.updateLayerVisibility()}})),o._whenSymbolRemoved.forEachSimple((function(e){return e(t.id)}))},o=this,s=0,l=t=t||[];s<l.length;s++){n(l[s])}(e.length||a.length)&&(this.graphicsWithoutSymbol.forEach((function(e){return a.push(e)})),this.graphicsWithoutSymbol.clear(),this.add(a)),this.updateHasDraped(),this._cleanupSymbols(),this.labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty()},t.prototype.applyUniqueValueRendererDiff=function(e,t,i){var r=e.diff.defaultSymbol,a=e.diff.uniqueValueInfos;if(r||a){var n=a?a.added.map((function(e){return e.symbol})):[],o=a?a.removed.map((function(e){return e.symbol})):[];if(a)for(var s=0;s<a.changed.length;s++)n.push(a.changed[s].newValue.symbol),o.push(a.changed[s].oldValue.symbol);return r?(i.defaultSymbol&&o.push(i.defaultSymbol),t.defaultSymbol&&n.push(t.defaultSymbol)):i.defaultSymbol&&n.length&&o.push(t.defaultSymbol),this.applySymbolSetDiff(n,o,t),delete e.diff.defaultSymbol,delete e.diff.uniqueValueInfos,!0}return!1},t.prototype.calculateUnchangedSymbolMapping=function(e,t,i){var r=function(e){return u.isSome(e)?e.id:null};if(t instanceof a.UniqueValueRenderer&&i instanceof a.UniqueValueRenderer&&(u.isNone(e)||"partial"===e.type)){var n=e&&e.diff,o=n&&n.defaultSymbol,s=n&&n.uniqueValueInfos,l=void 0;return l=s?s.unchanged.map((function(e){return{oldId:r(e.oldValue.symbol),newId:r(e.newValue.symbol)}})):i.uniqueValueInfos.map((function(e,i){return{oldId:r(e.symbol),newId:r(t.uniqueValueInfos[i].symbol)}})),!o&&i.defaultSymbol&&l.push({oldId:r(i.defaultSymbol),newId:r(t.defaultSymbol)}),l}return[]},t.prototype.updateSymbolMapping=function(e,t){var i=t?"string"==typeof t?t:t.id:null,r="string"==typeof t?null:t;if(e&&e!==i){var a=this.graphicsBySymbol.get(e);this.graphicsBySymbol.delete(e),void 0!==a&&this.graphicsBySymbol.set(i,a);var n=this.symbols.get(e);void 0!==n&&(this.symbols.delete(e),this.symbols.set(i,n),u.isSome(n)&&(u.isSome(r)?n.symbol=r:n.symbol.id=i))}},t.prototype.updateUnchangedSymbolMappings=function(e,t,i){for(var r=0,a=this.calculateUnchangedSymbolMapping(e,t,i);r<a.length;r++){var n=a[r],o=n.oldId,s=n.newId;this.updateSymbolMapping(o,s)}},t.prototype.applyRendererDiff=function(e,t,i){var r=this;return!this.diffHasSymbolChange(e)&&(!!(t instanceof a.UniqueValueRenderer&&i instanceof a.UniqueValueRenderer&&this.applyUniqueValueRendererDiff(e,t,i)&&0===Object.keys(e.diff).length)||!c.someMap(this.graphicsBySymbol,(function(i,a){var n=r.symbols.get(a);return u.isSome(n)&&!n.applyRendererDiff(e,t)})))},t.prototype.opacityChange=function(){this.forEachGraphics3DSymbol((function(e,t){return e.globalPropertyChanged("opacity",t)})),this.updateStageLayerVisibility()},t.prototype.updateUpdatePolicy=function(){var e=u.isSome(this.currentRenderer)&&"dictionary"===this.currentRenderer.type;u.isSome(this.forcedUpdatePolicy)?this._asyncUpdates=1===this.forcedUpdatePolicy:this._asyncUpdates=1===this.preferredUpdatePolicy||e,this.symbolCreationContext.isAsync=this._asyncUpdates,this._asyncUpdates||this.update(K.noBudget)},t.prototype.slicePlaneEnabledChange=function(e){e!==this.symbolCreationContext.slicePlaneEnabled&&(this.symbolCreationContext.slicePlaneEnabled=e,this.stageLayer.isSliceable=e,this.forEachGraphics3DSymbol((function(e,t){return e.globalPropertyChanged("slicePlaneEnabled",t)})),this.deconflictor&&this.deconflictor.slicePlaneEnabledChange(),this.labeler&&this.labeler.slicePlaneEnabledChange())},t.prototype.physicalBasedRenderingChange=function(e){e!==this.symbolCreationContext.physicalBasedRenderingEnabled&&(this.symbolCreationContext.physicalBasedRenderingEnabled=e,this.forEachGraphics3DSymbol((function(e,t){return e.globalPropertyChanged("physicalBasedRenderingEnabled",t)})))},t.prototype.pixelRatioChange=function(){var e=this;this.forEachGraphics3DSymbol((function(t,i,r){t.globalPropertyChanged("pixelRatio",i)||e._recreateSymbol(r)}))},t.prototype._signalUpdatingDuringAsyncLoadedGraphicsChange=function(){var e=this;this._updatingPendingLoadedGraphicsChange&&this._updatingPendingLoadedGraphicsChange.remove(),this._updatingPendingLoadedGraphicsChange=f.schedule((function(){e._updatingPendingLoadedGraphicsChange=null}))},t.prototype.setClippingExtent=function(e,t){var i=this.symbolCreationContext.clippingExtent,r=x.create();return q.toBoundingRect(e,r,t)?this.symbolCreationContext.clippingExtent=_.fromRect(_.create(),r):this.symbolCreationContext.clippingExtent=null,!_.equals(this.symbolCreationContext.clippingExtent,i)},t.prototype.modifyGraphics3DGraphicVisibilities=function(e){var t=!1;this.graphics3DGraphics.forEach((function(i){e(i)&&(t=!0)})),t&&(this.labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty())},t.prototype.forEachGraphics3DSymbol=function(e){for(var t=0,i=s.keysOfMap(this.symbols);t<i.length;t++){var r=i[t],a=this.symbols.get(r);if(u.isNone(a))return;e(a,this.graphicsBySymbol.get(r)||se,r)}},t.prototype.updateAllGraphicsVisibility=function(){var e=this;this.filterVisibility&&(this.filterVisibility.dirty=!0),this.modifyGraphics3DGraphicVisibilities((function(t){var i=e._updateUserVisibility(t),r=e.scaleVisibility&&e.scaleVisibility.updateVisibility(t);return i||r}))},t.prototype.hideAllGraphics=function(){this.modifyGraphics3DGraphicVisibilities((function(e){return e.setVisibilityFlag(0,!1,0)}))},t.prototype.validateRenderer=function(e){var t=U.validateTo3D(e);if(t){var i="Renderer for layer '"+(this.layer.title?this.layer.title+", ":"")+", id:"+this.layer.id+"' is not supported in a SceneView";$.warn(i,t.message)}},t.prototype.volatileGraphicsUpdated=function(){this.labeler&&this.labeler.reset(),this.stageLayer.invalidateSpatialQueryAccelerator(),this.stageLayer.shaderTransformationChanged(),this.notifyChange("updating")},t.prototype._cleanupSymbols=function(){var e=this;if(!(this.graphicsWaitingForSymbol.size>0||this.suspendSymbolCleanup)){var t=!1;this.symbols.forEach((function(i,r){if(!(u.isNone(i)||i.referenced>0)){var a=e.graphicsBySymbol.get(r);a&&0!==a.size||(e.graphicsBySymbol.delete(r),e.symbols.delete(r),i&&i.destroy(),t=!0)}})),t&&(this.recomputeExtentPadding(),this.notifyChange("maxSymbolComplexity"))}},t.prototype.snapshotInternals=function(){var e=this;return{graphics:s.keysOfMap(this.graphics3DGraphics).sort(),symbols:s.keysOfMap(this.symbols).sort(),graphicsBySymbol:s.keysOfMap(this.graphicsBySymbol).sort().map((function(t){return{symbolId:t,graphics:s.keysOfMap(e.graphicsBySymbol.get(t)).sort()}})),graphicsWithoutSymbol:s.keysOfMap(this.graphicsWithoutSymbol).sort(),graphicsDrapedUids:s.keysOfSet(this.graphicsDrapedUids).sort(),pendingUpdates:this.pendingUpdates}},Object.defineProperty(t.prototype,"test",{get:function(){var e=this;return{symbols:this.symbols,filterVisibility:this.filterVisibility,numPending:this.pendingUpdates.size,forceUpdatePolicy:function(t){e.forcedUpdatePolicy=t,e.updateUpdatePolicy()}}},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"performanceInfo",{get:function(){return{visible:this.graphics3DGraphics.size,missing:this.graphicsWithoutSymbol.size,pending:this.pendingUpdates.size}},enumerable:!1,configurable:!0}),t.tmpVec=G.vec3f64.create(),i.__decorate([S.property({readOnly:!0})],t.prototype,"computedExtent",void 0),i.__decorate([S.property()],t.prototype,"currentRenderer",void 0),i.__decorate([S.property()],t.prototype,"rendererHasGeometryOperations",void 0),i.__decorate([S.property()],t.prototype,"rendererChangeAbortController",void 0),i.__decorate([S.property()],t.prototype,"elevationInfoChangeAbortController",void 0),i.__decorate([S.property()],t.prototype,"setupAbortController",void 0),i.__decorate([S.property({readOnly:!0})],t.prototype,"elevationAlignment",void 0),i.__decorate([S.property({readOnly:!0})],t.prototype,"scaleVisibility",void 0),i.__decorate([S.property({readOnly:!0})],t.prototype,"filterVisibility",void 0),i.__decorate([S.property({readOnly:!0})],t.prototype,"extentPadding",void 0),i.__decorate([S.property()],t.prototype,"_updatingPendingLoadedGraphicsChange",void 0),i.__decorate([S.property({readOnly:!0})],t.prototype,"featureStore",void 0),i.__decorate([S.property({readOnly:!0})],t.prototype,"deconflictor",void 0),i.__decorate([S.property({readOnly:!0})],t.prototype,"labeler",void 0),i.__decorate([S.property({readOnly:!0})],t.prototype,"objectStates",void 0),i.__decorate([S.property()],t.prototype,"preferredUpdatePolicy",void 0),i.__decorate([S.property({constructOnly:!0})],t.prototype,"elevationFeatureExpressionEnabled",void 0),i.__decorate([S.property({constructOnly:!0})],t.prototype,"owner",void 0),i.__decorate([S.property({constructOnly:!0})],t.prototype,"layer",void 0),i.__decorate([S.property({readOnly:!0})],t.prototype,"hasDraped",void 0),i.__decorate([S.property({readOnly:!0})],t.prototype,"symbolsUpdating",void 0),i.__decorate([S.property({constructOnly:!0})],t.prototype,"graphicSymbolSupported",void 0),i.__decorate([S.property({constructOnly:!0})],t.prototype,"getRenderingInfoWithoutRenderer",void 0),i.__decorate([S.property({readOnly:!0,dependsOn:["elevationAlignment.updating","scaleVisibility.updating","filterVisibility.updating","rendererChangeAbortController","elevationInfoChangeAbortController","_updatingPendingLoadedGraphicsChange"]})],t.prototype,"updating",null),i.__decorate([S.property({readOnly:!0})],t.prototype,"updatingRemaining",null),i.__decorate([S.property({readOnly:!0})],t.prototype,"updatingTotal",null),i.__decorate([S.property({readOnly:!0,dependsOn:["owner.view.qualitySettings.graphics3D.maxTotalNumberOfPrimitives","owner.view.qualitySettings.graphics3D.maxTotalNumberOfFeatures","maxSymbolComplexity"]})],t.prototype,"displayFeatureLimit",null),i.__decorate([S.property({readOnly:!0})],t.prototype,"maxSymbolComplexity",null),i.__decorate([S.property({constructOnly:!0})],t.prototype,"hasZ",void 0),i.__decorate([S.property({constructOnly:!0})],t.prototype,"hasM",void 0),t=o=i.__decorate([S.subclass("esri.views.3d.layers.graphics.Graphics3DCore")],t)}(o);t.Graphics3DCore=ee;var te=new Map,ie=new m,re=new g(m),ae=10,ne=G.vec3f64.create(),oe=G.vec3f64.create(),se=new Map}));