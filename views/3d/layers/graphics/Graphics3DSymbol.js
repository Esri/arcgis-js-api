/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../core/asyncUtils","../../../../core/maybe","../../../../core/promiseUtils","./Graphics3DGraphic","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolLayerFactory","./interfaces","./Loadable","./symbolComplexity"],(function(e,t,r,s,o,n,a,i,y,l){"use strict";let c=function(c){function u(e,t,r){var s;return(s=c.call(this,t.schedule)||this)._symbol=e,s._context=t,s._backgroundLayers=r,s._destroyed=!1,s.symbolLayers=new Array,s.referenced=0,s._extentPadding=0,s}e._inheritsLoose(u,c);var f=u.prototype;return f.doLoad=function(){var o=e._asyncToGenerator((function*(o){var n=this;let i=this._symbol.symbolLayers;this._extentPadding=0,this._backgroundLayers&&(i=this._backgroundLayers.concat(i));const y=i.length;for(;this.symbolLayers.length<i.length;)this.symbolLayers.push(null);this.symbolLayers.length=i.length;const l=[];for(let e=0;e<y;e++){const t=i.getItemAt(e);if(!1===t.enabled)continue;h.renderPriority=1-(1+e)/y,h.renderPriorityStep=1/y,h.ignoreDrivers=t._ignoreDrivers;const r=a.make(this.symbol,t,this._context,h),n=s.onAbortOrThrow(o,(()=>{this.symbolLayers[e]=null,r.destroy()}));n&&l.push(n),this.symbolLayers[e]=r}if(yield t.forEach(this.symbolLayers,function(){var t=e._asyncToGenerator((function*(e,t){if(r.isSome(e))try{yield e.load(),n._extentPadding+=Math.max(n._extentPadding,e.extentPadding)}catch{n.symbolLayers[t]=null}}));return function(e,r){return t.apply(this,arguments)}}()),l.forEach((e=>e.remove())),s.throwIfAborted(o),this.symbolLayers.length&&!this.symbolLayers.some((e=>!!e)))throw new Error}));function n(e){return o.apply(this,arguments)}return n}(),f.getSymbolLayerSize=function(e){const t=this.symbolLayers[e];return r.isSome(t)?t.getCachedSize():null},f.createGraphics3DGraphic=function(e,t){const s=e.graphic,n=new Array(this.symbolLayers.length);for(let o=0;o<this.symbolLayers.length;o++){const t=this.symbolLayers[o];n[o]=r.isSome(t)?t.createGraphics3DGraphic(e):null}const a=this._context.arcade||this._context.featureExpressionInfoContext&&this._context.featureExpressionInfoContext.arcade&&this._context.featureExpressionInfoContext.arcade.modules||null;return new o(s,t||this,n,e.layer,a)},f.globalPropertyChanged=function(e,t){const s=this.symbolLayers.length;for(let o=0;o<s;o++){const s=this.symbolLayers[o],a=e=>{const t=e.layers[o];return t instanceof n.Graphics3DObject3DGraphicLayer?t:null};if(r.isSome(s)&&!s.globalPropertyChanged(e,t,a))return!1}return!0},f.applyRendererDiff=function(e,t){return this.loadStatus!==y.LoadStatus.LOADED?i.ApplyRendererDiffResult.Recreate_Symbol:this.symbolLayers.reduce(((s,o)=>s!==i.ApplyRendererDiffResult.Recreate_Symbol&&r.isSome(o)?Math.min(s,o.applyRendererDiff(e,t)):s),i.ApplyRendererDiffResult.Fast_Update)},f.prepareSymbolPatch=function(e){if(this.loadStatus===y.LoadStatus.FAILED)return;if("partial"!==e.diff.type)return;const t=e.diff.diff;if(!t.symbolLayers||"partial"!==t.symbolLayers.type)return;const s=t.symbolLayers.diff;this.symbolLayers.forEach(((t,o)=>{if(r.isNone(t))return;const n=s[o];if(n){const s={diff:n,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};t.prepareSymbolLayerPatch(s),e.symbolStatePatches.push(...s.symbolLayerStatePatches),s.graphics3DGraphicPatches.length&&e.graphics3DGraphicPatches.push(((e,t)=>{const n=e.layers[o];r.isSome(n)&&s.graphics3DGraphicPatches.forEach((e=>e(n,t)))}))}}))},f.updateGeometry=function(e,t){for(let s=0;s<this.symbolLayers.length;s++){const o=this.symbolLayers[s];if(r.isNone(o))continue;const n=e.layers[s];if(r.isNone(n)||!o.updateGeometry(n,t))return!1}return!0},f.onRemoveGraphic=function(e){for(let t=0;t<this.symbolLayers.length;t++){const s=this.symbolLayers[t];if(r.isNone(s))continue;const o=e.layers[t];r.isSome(o)&&s.onRemoveGraphic(o)}},f.getFastUpdateStatus=function(){let e=0,t=0,s=0;return this.symbolLayers.forEach((o=>{r.isNone(o)||(o.loadStatus===y.LoadStatus.LOADING?e++:o.isFastUpdatesEnabled()?s++:t++)})),{loading:e,slow:t,fast:s}},f.queryForSnapping=function(){var t=e._asyncToGenerator((function*(e,t,o,n){const a=this.symbolLayers.filter(r.isSome).filter((e=>r.isSome(e.queryForSnapping))).map((r=>r.queryForSnapping(e,t,o,n))),i=yield Promise.all(a);return s.throwIfAborted(n),i.flat()}));function o(e,r,s,o){return t.apply(this,arguments)}return o}(),f.destroy=function(){if(this.destroyed)console.error("Graphics3DSymbol.destroy called when already destroyed!");else{c.prototype.destroy.call(this);for(const e of this.symbolLayers)r.isSome(e)&&e.destroy();this.symbolLayers.length=0,this._destroyed=!0}},e._createClass(u,[{key:"symbol",get:function(){return this._symbol},set:function(e){this._symbol=e,e.symbolLayers.forEach(((t,s)=>{const o=this.symbolLayers[s];r.isSome(o)&&(o.symbol=e,o.symbolLayer=t)}))}},{key:"extentPadding",get:function(){return this._extentPadding}},{key:"symbologySnappingSupported",get:function(){return this.symbolLayers.some((e=>r.isSome(e)&&e.queryForSnapping))}},{key:"complexity",get:function(){return l.totalSymbolComplexities(this.symbolLayers.map((e=>r.get(e,"complexity"))))}},{key:"destroyed",get:function(){return this._destroyed}}]),u}(y.Loadable);const h={renderPriority:0,renderPriorityStep:1,ignoreDrivers:!1};return c}));
