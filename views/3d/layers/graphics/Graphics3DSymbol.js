/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/asyncUtils","./Graphics3DObject3DGraphicLayer","./Loadable","./symbolComplexity","./Graphics3DGraphic","./Graphics3DSymbolLayerFactory"],(function(e,t,s,r,o,n,i,a,y){"use strict";let l=function(n){function l(e,t,s){var r;return(r=n.call(this)||this)._symbol=e,r._context=t,r._backgroundLayers=s,r._destroyed=!1,r.symbolLayers=[],r.referenced=0,r._extentPadding=0,r}e._inheritsLoose(l,n);var h=l.prototype;return h.doLoad=async function(e){let o=this._symbol.symbolLayers;this._extentPadding=0,this._backgroundLayers&&(o=this._backgroundLayers.concat(o));const n=o.length;for(;this.symbolLayers.length<o.length;)this.symbolLayers.push(null);this.symbolLayers.length=o.length;const i=[];for(let t=0;t<n;t++){const r=o.getItemAt(t);if(!1===r.enabled)continue;c.renderPriority=1-(1+t)/n,c.renderPriorityStep=1/n,c.ignoreDrivers=r._ignoreDrivers;const a=y.make(this.symbol,r,this._context,c);i.push(s.onAbortOrThrow(e,(()=>{this.symbolLayers[t]=null,a.destroy()}))),this.symbolLayers[t]=a}await r.forEach(this.symbolLayers,(async(e,s)=>{if(t.isSome(e))try{await e.load(),this._extentPadding+=Math.max(this._extentPadding,e.extentPadding)}catch{this.symbolLayers[s]=null}}));for(const e of i)null==e||e.remove();if(i.length=0,s.throwIfAborted(e),this.symbolLayers.length&&!this.symbolLayers.some((e=>!!e)))throw new Error},h.getSymbolLayerSize=function(e){const s=this.symbolLayers[e];return t.isSome(s)?s.getCachedSize():null},h.createGraphics3DGraphic=function(e,s){const r=e.graphic,o=new Array(this.symbolLayers.length);for(let s=0;s<this.symbolLayers.length;s++){const r=this.symbolLayers[s];o[s]=t.isSome(r)?r.createGraphics3DGraphic(e):null}const n=this._context.arcade||this._context.featureExpressionInfoContext&&this._context.featureExpressionInfoContext.arcade&&this._context.featureExpressionInfoContext.arcade.modules||null;return new a(r,s||this,o,e.layer,n)},h.globalPropertyChanged=function(e,s){const r=this.symbolLayers.length;for(let n=0;n<r;n++){const r=this.symbolLayers[n],i=e=>{const t=e._graphics[n];return t instanceof o?t:null};if(t.isSome(r)&&!r.globalPropertyChanged(e,s,i))return!1}return!0},h.applyRendererDiff=function(e,s){return 1===this.loadStatus&&this.symbolLayers.reduce(((r,o)=>r&&(t.isNone(o)||o.applyRendererDiff(e,s))),!0)},h.prepareSymbolPatch=function(e){if(2===this.loadStatus)return;if("partial"!==e.diff.type)return;const s=e.diff.diff;if(!s.symbolLayers||"partial"!==s.symbolLayers.type)return;const r=s.symbolLayers.diff;this.symbolLayers.forEach(((s,o)=>{if(t.isNone(s))return;const n=r[o];if(n){const r={diff:n,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};s.prepareSymbolLayerPatch(r),e.symbolStatePatches.push(...r.symbolLayerStatePatches),r.graphics3DGraphicPatches.length&&e.graphics3DGraphicPatches.push(((e,s)=>{const n=e._graphics[o];t.isSome(n)&&r.graphics3DGraphicPatches.forEach((e=>e(n,s)))}))}}))},h.updateGeometry=function(e,s){for(let r=0;r<this.symbolLayers.length;r++){const o=this.symbolLayers[r];if(t.isNone(o))continue;const n=e._graphics[r];if(t.isNone(n)||!o.updateGeometry(n,s))return!1}return!0},h.onRemoveGraphic=function(e){for(let s=0;s<this.symbolLayers.length;s++){const r=this.symbolLayers[s];if(t.isNone(r))continue;const o=e._graphics[s];t.isSome(o)&&r.onRemoveGraphic(o)}},h.getFastUpdateStatus=function(){let e=0,s=0,r=0;return this.symbolLayers.forEach((o=>{t.isNone(o)||(0===o.loadStatus?e++:o.isFastUpdatesEnabled()?r++:s++)})),{loading:e,slow:s,fast:r}},h.destroy=function(){if(this.destroyed)console.error("Graphics3DSymbol.destroy called when already destroyed!");else{this.abortLoad();for(const e of this.symbolLayers)t.isSome(e)&&e.destroy();this.symbolLayers.length=0,this._destroyed=!0}},e._createClass(l,[{key:"symbol",set:function(e){if(this._symbol=e,this.symbolLayers)for(let s=0;s<e.symbolLayers.length;s++){const r=this.symbolLayers[s];t.isNone(r)||(r.symbol=e,r.symbolLayer=e.symbolLayers.items[s])}},get:function(){return this._symbol}},{key:"extentPadding",get:function(){return this._extentPadding}},{key:"complexity",get:function(){return i.totalSymbolComplexities(this.symbolLayers.map((e=>t.get(e,"complexity"))))}},{key:"destroyed",get:function(){return this._destroyed}}]),l}(n.Loadable);const c={renderPriority:0,renderPriorityStep:1,ignoreDrivers:!1};return l}));
