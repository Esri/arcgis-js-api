/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../core/asyncUtils","../../../../core/maybe","../../../../core/promiseUtils","./Graphics3DGraphic","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolLayerFactory","./Loadable","./symbolComplexity"],(function(e,t,s,r,o,n,i,a,y){"use strict";let l=function(a){function l(e,t,s){var r;return(r=a.call(this,t.schedule)||this)._symbol=e,r._context=t,r._backgroundLayers=s,r._destroyed=!1,r.symbolLayers=new Array,r.referenced=0,r._extentPadding=0,r}e._inheritsLoose(l,a);var h=l.prototype;return h.doLoad=function(){var o=e._asyncToGenerator((function*(o){var n=this;let a=this._symbol.symbolLayers;this._extentPadding=0,this._backgroundLayers&&(a=this._backgroundLayers.concat(a));const y=a.length;for(;this.symbolLayers.length<a.length;)this.symbolLayers.push(null);this.symbolLayers.length=a.length;const l=[];for(let e=0;e<y;e++){const t=a.getItemAt(e);if(!1===t.enabled)continue;c.renderPriority=1-(1+e)/y,c.renderPriorityStep=1/y,c.ignoreDrivers=t._ignoreDrivers;const s=i.make(this.symbol,t,this._context,c);l.push(r.onAbortOrThrow(o,(()=>{this.symbolLayers[e]=null,s.destroy()}))),this.symbolLayers[e]=s}yield t.forEach(this.symbolLayers,function(){var t=e._asyncToGenerator((function*(e,t){if(s.isSome(e))try{yield e.load(),n._extentPadding+=Math.max(n._extentPadding,e.extentPadding)}catch{n.symbolLayers[t]=null}}));return function(e,s){return t.apply(this,arguments)}}());for(const e of l)null==e||e.remove();if(l.length=0,r.throwIfAborted(o),this.symbolLayers.length&&!this.symbolLayers.some((e=>!!e)))throw new Error}));function n(e){return o.apply(this,arguments)}return n}(),h.getSymbolLayerSize=function(e){const t=this.symbolLayers[e];return s.isSome(t)?t.getCachedSize():null},h.createGraphics3DGraphic=function(e,t){const r=e.graphic,n=new Array(this.symbolLayers.length);for(let o=0;o<this.symbolLayers.length;o++){const t=this.symbolLayers[o];n[o]=s.isSome(t)?t.createGraphics3DGraphic(e):null}const i=this._context.arcade||this._context.featureExpressionInfoContext&&this._context.featureExpressionInfoContext.arcade&&this._context.featureExpressionInfoContext.arcade.modules||null;return new o(r,t||this,n,e.layer,i)},h.globalPropertyChanged=function(e,t){const r=this.symbolLayers.length;for(let o=0;o<r;o++){const r=this.symbolLayers[o],i=e=>{const t=e.graphics[o];return t instanceof n.Graphics3DObject3DGraphicLayer?t:null};if(s.isSome(r)&&!r.globalPropertyChanged(e,t,i))return!1}return!0},h.applyRendererDiff=function(e,t){return 1!==this.loadStatus?0:this.symbolLayers.reduce(((r,o)=>0!==r&&s.isSome(o)?Math.min(r,o.applyRendererDiff(e,t)):r),2)},h.prepareSymbolPatch=function(e){if(2===this.loadStatus)return;if("partial"!==e.diff.type)return;const t=e.diff.diff;if(!t.symbolLayers||"partial"!==t.symbolLayers.type)return;const r=t.symbolLayers.diff;this.symbolLayers.forEach(((t,o)=>{if(s.isNone(t))return;const n=r[o];if(n){const r={diff:n,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};t.prepareSymbolLayerPatch(r),e.symbolStatePatches.push(...r.symbolLayerStatePatches),r.graphics3DGraphicPatches.length&&e.graphics3DGraphicPatches.push(((e,t)=>{const n=e.graphics[o];s.isSome(n)&&r.graphics3DGraphicPatches.forEach((e=>e(n,t)))}))}}))},h.updateGeometry=function(e,t){for(let r=0;r<this.symbolLayers.length;r++){const o=this.symbolLayers[r];if(s.isNone(o))continue;const n=e.graphics[r];if(s.isNone(n)||!o.updateGeometry(n,t))return!1}return!0},h.onRemoveGraphic=function(e){for(let t=0;t<this.symbolLayers.length;t++){const r=this.symbolLayers[t];if(s.isNone(r))continue;const o=e.graphics[t];s.isSome(o)&&r.onRemoveGraphic(o)}},h.getFastUpdateStatus=function(){let e=0,t=0,r=0;return this.symbolLayers.forEach((o=>{s.isNone(o)||(0===o.loadStatus?e++:o.isFastUpdatesEnabled()?r++:t++)})),{loading:e,slow:t,fast:r}},h.destroy=function(){if(this.destroyed)console.error("Graphics3DSymbol.destroy called when already destroyed!");else{a.prototype.destroy.call(this);for(const e of this.symbolLayers)s.isSome(e)&&e.destroy();this.symbolLayers.length=0,this._destroyed=!0}},e._createClass(l,[{key:"symbol",get:function(){return this._symbol},set:function(e){this._symbol=e;for(let t=0;t<e.symbolLayers.length;t++){const r=this.symbolLayers[t];s.isNone(r)||(r.symbol=e,r.symbolLayer=e.symbolLayers.items[t])}}},{key:"extentPadding",get:function(){return this._extentPadding}},{key:"complexity",get:function(){return y.totalSymbolComplexities(this.symbolLayers.map((e=>s.get(e,"complexity"))))}},{key:"destroyed",get:function(){return this._destroyed}}]),l}(a.Loadable);const c={renderPriority:0,renderPriorityStep:1,ignoreDrivers:!1};return l}));
