// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../core/asyncUtils","../../../../core/maybe","../../../../core/promiseUtils","./Graphics3DGraphic","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolLayerFactory","./Loadable","./symbolComplexity"],(function(e,t,r,o,s,a,n,i,y,l,c){"use strict";var h=function(e){function t(t,r,o){var s=e.call(this)||this;return s._symbol=t,s._context=r,s._backgroundLayers=o,s._destroyed=!1,s.symbolLayers=[],s.referenced=0,s._extentPadding=0,s}return r.__extends(t,e),Object.defineProperty(t.prototype,"symbol",{get:function(){return this._symbol},set:function(e){if(this._symbol=e,this.symbolLayers)for(var t=0;t<e.symbolLayers.length;t++){var r=this.symbolLayers[t];s.isNone(r)||(r.symbol=e,r.symbolLayer=e.symbolLayers.items[t])}},enumerable:!1,configurable:!0}),t.prototype.doLoad=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n,i,l,c,h,f,p,b,d=this;return r.__generator(this,(function(m){switch(m.label){case 0:for(t=this._symbol.symbolLayers,this._extentPadding=0,this._backgroundLayers&&(t=this._backgroundLayers.concat(t)),n=t.length;this.symbolLayers.length<t.length;)this.symbolLayers.push(null);for(this.symbolLayers.length=t.length,i=[],l=function(r){var o=t.getItemAt(r);if(!1===o.enabled)return"continue";u.renderPriority=1-(1+r)/n,u.renderPriorityStep=1/n,u.ignoreDrivers=o._ignoreDrivers;var s=y.make(c.symbol,o,c._context,u);i.push(a.onAbortOrThrow(e,(function(){d.symbolLayers[r]=null,s.destroy()}))),c.symbolLayers[r]=s},c=this,h=0;h<n;h++)l(h);return[4,o.forEach(this.symbolLayers,(function(e,t){return r.__awaiter(d,void 0,void 0,(function(){return r.__generator(this,(function(r){switch(r.label){case 0:if(!s.isSome(e))return[3,4];r.label=1;case 1:return r.trys.push([1,3,,4]),[4,e.load()];case 2:return r.sent(),this._extentPadding+=Math.max(this._extentPadding,e.extentPadding),[3,4];case 3:return r.sent(),this.symbolLayers[t]=null,[3,4];case 4:return[2]}}))}))}))];case 1:for(m.sent(),f=0,p=i;f<p.length;f++)null==(b=p[f])||b.remove();if(i.length=0,a.throwIfAborted(e),this.symbolLayers.length&&!this.symbolLayers.some((function(e){return!!e})))throw new Error;return[2]}}))}))},t.prototype.getSymbolLayerSize=function(e){var t=this.symbolLayers[e];return s.isSome(t)?t.getCachedSize():null},Object.defineProperty(t.prototype,"extentPadding",{get:function(){return this._extentPadding},enumerable:!1,configurable:!0}),t.prototype.createGraphics3DGraphic=function(e,t){for(var r=e.graphic,o=new Array(this.symbolLayers.length),a=0;a<this.symbolLayers.length;a++){var i=this.symbolLayers[a];o[a]=s.isSome(i)?i.createGraphics3DGraphic(e):null}var y=this._context.arcade||this._context.featureExpressionInfoContext&&this._context.featureExpressionInfoContext.arcade&&this._context.featureExpressionInfoContext.arcade.modules||null;return new n(r,t||this,o,e.layer,y)},Object.defineProperty(t.prototype,"complexity",{get:function(){return c.totalSymbolComplexities(this.symbolLayers.map((function(e){return s.get(e,"complexity")})))},enumerable:!1,configurable:!0}),t.prototype.globalPropertyChanged=function(e,t){for(var r=this.symbolLayers.length,o=function(r){var o=a.symbolLayers[r];if(s.isSome(o)&&!o.globalPropertyChanged(e,t,(function(e){var t=e._graphics[r];return t instanceof i?t:null})))return{value:!1}},a=this,n=0;n<r;n++){var y=o(n);if("object"==typeof y)return y.value}return!0},t.prototype.applyRendererDiff=function(e,t){return 1===this.loadStatus&&this.symbolLayers.reduce((function(r,o){return r&&(s.isNone(o)||o.applyRendererDiff(e,t))}),!0)},t.prototype.prepareSymbolPatch=function(e){if(2!==this.loadStatus&&"partial"===e.diff.type){var t=e.diff.diff;if(t.symbolLayers&&"partial"===t.symbolLayers.type){var r=t.symbolLayers.diff;this.symbolLayers.forEach((function(t,o){var a;if(!s.isNone(t)){var n=r[o];if(n){var i={diff:n,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};t.prepareSymbolLayerPatch(i),(a=e.symbolStatePatches).push.apply(a,i.symbolLayerStatePatches),i.graphics3DGraphicPatches.length&&e.graphics3DGraphicPatches.push((function(e,t){var r=e._graphics[o];s.isSome(r)&&i.graphics3DGraphicPatches.forEach((function(e){return e(r,t)}))}))}}}))}}},t.prototype.updateGeometry=function(e,t){for(var r=0;r<this.symbolLayers.length;r++){var o=this.symbolLayers[r];if(!s.isNone(o)){var a=e._graphics[r];if(s.isNone(a)||!o.updateGeometry(a,t))return!1}}return!0},t.prototype.onRemoveGraphic=function(e){for(var t=0;t<this.symbolLayers.length;t++){var r=this.symbolLayers[t];if(!s.isNone(r)){var o=e._graphics[t];s.isSome(o)&&r.onRemoveGraphic(o)}}},t.prototype.getFastUpdateStatus=function(){var e=0,t=0,r=0;return this.symbolLayers.forEach((function(o){s.isNone(o)||(0===o.loadStatus?e++:o.isFastUpdatesEnabled()?r++:t++)})),{loading:e,slow:t,fast:r}},t.prototype.destroy=function(){if(this.destroyed)console.error("Graphics3DSymbol.destroy called when already destroyed!");else{this.abortLoad();for(var e=0,t=this.symbolLayers;e<t.length;e++){var r=t[e];s.isSome(r)&&r.destroy()}this.symbolLayers.length=0,this._destroyed=!0}},Object.defineProperty(t.prototype,"destroyed",{get:function(){return this._destroyed},enumerable:!1,configurable:!0}),t}(l.Loadable),u={renderPriority:0,renderPriorityStep:1,ignoreDrivers:!1};return h}));