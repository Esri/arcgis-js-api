/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../core/asyncUtils","../../../../core/byteSizeEstimations","../../../../core/maybe","../../../../core/ObjectPool","../../../../chunks/vec2","../../../../chunks/vec2f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/Polygon","../../../../geometry/projection","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../layers/graphics/dehydratedFeatures","../../../../layers/graphics/featureConversionUtils","./enums","./featureExpressionInfoUtils"],(function(i,e,t,r,s,n,o,a,c,h,l,u,p,y,d,f,m){"use strict";const b=new s(Array,(i=>u.set(i,u.ZERO)),null,10,5),g=p.create();let _=function(){function s(i,e,t,s,n){this.graphic=i,this.graphics3DSymbol=e,this.graphics=t,this._labelGraphics=new Array,this._auxiliaryGraphics=new Array,this._visibilityFlags=G(f.VisibilityGroup._COUNT,f.VisibilityFlag._COUNT),this._featureExpressionFeature=null,this._optimizedGeometry={geometry:null,hasZ:!1,hasM:!1},this._extent=null,this.isElevationSource=!1,++e.referenced,this._featureExpressionFeature=n?m.createFeature(n,i,s):null;for(const o of t)r.isSome(o)&&(this.isElevationSource=this.isElevationSource||o.isElevationSource)}var _=s.prototype;return _.initialize=function(i,e,t){this._layer=e,this._stage=i,this._forEachSymbolLayerGraphic((r=>{r.initialize(i,e,t),r.setVisibility(this.isVisible())}))},_.destroy=function(){this._forEachSymbolLayerGraphic((i=>i.destroy())),this.graphics=null,this._auxiliaryGraphics=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null},_.clearLabelGraphics=function(){this._forEachLabelGraphic((i=>i.destroy())),this._labelGraphics.length=0},_.addLabelGraphic=function(i,e,t){this._labelGraphics.push(i),i.initialize(e,t),i.setVisibility(this.isVisible(f.VisibilityGroup.LABEL))},_.addAuxiliaryGraphic=function(i){this._auxiliaryGraphics.push(i),this._layer&&(i.initialize(this._stage,this._layer),i.setVisibility(this.isVisible()))},_.isVisible=function(i=f.VisibilityGroup.GRAPHIC,e){for(let t=0;t<=i;t++){const i=this._visibilityFlags[t];for(let t=0;t<i.length;++t)if(!1===i[t]&&t!==e)return!1}return!0},_.hasVisibilityFlag=function(i,e){return null!=this._visibilityFlags[e][i]},_.setVisibilityFlag=function(i,e,t){const r=this.isVisible(t);this._visibilityFlags[t][i]=e;const s=this.isVisible(t);if(r===s)return!1;if(t===f.VisibilityGroup.LABEL)this._forEachLabelGraphic((i=>i.setVisibility(s)));else{this._forEachSymbolLayerGraphic((i=>i.setVisibility(s)));const i=this.isVisible(f.VisibilityGroup.LABEL);this._forEachLabelGraphic((e=>e.setVisibility(i)))}return!0},_.clearVisibilityFlag=function(i,e=f.VisibilityGroup.GRAPHIC){return this.setVisibilityFlag(i,void 0,e)},_.computeExtent=function(i){if(!this._extent){const e=this.graphic.geometry;if(r.isNone(e))return!1;this._extent=p.create(),y.computeAABR(e,this._extent);const t=e.spatialReference;if(!t.equals(i)&&!l.projectBoundingRect(this._extent,t,this._extent,i))return this._extent=null,!1}return!0},_.getAsOptimizedGeometry=function(i,e){return r.isSome(this._optimizedGeometry.geometry)&&this._optimizedGeometry.hasZ===i&&this._optimizedGeometry.hasM===e||(this._optimizedGeometry.geometry=this._convertGraphicToOptimizedGeometry(this.graphic,i,e),this._optimizedGeometry.hasZ=i,this._optimizedGeometry.hasM=e),this._optimizedGeometry.geometry},_._convertGraphicToOptimizedGeometry=function(i,e,t){let r=i.geometry;return"mesh"!==r.type&&"extent"!==r.type||(r=h.fromExtent("mesh"===r.type?r.extent:r)),d.convertFromGeometry(r,e,t)},_.computeAttachmentOrigin=function(){const i={render:{origin:c.create(),num:0},draped:{origin:o.create(),num:0}};for(const e of this.graphics)r.isNone(e)||e.computeAttachmentOrigin(i);return i.render.num&&a.scale(i.render.origin,i.render.origin,1/i.render.num),i.draped.num&&n.scale(i.draped.origin,i.draped.origin,1/i.draped.num),i},_.getProjectedBoundingBox=function(){var t=i._asyncToGenerator((function*(t,s,n,o,a){return a||(a={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),a.boundingBox?u.empty(a.boundingBox):a.boundingBox=u.empty(),a.requiresDrapedElevation=!1,yield e.forEach(this.graphics,function(){var e=i._asyncToGenerator((function*(i){if(r.isNone(i))return;const e="draped"===i.type?s:t,c=b.acquire(),h=yield i.getProjectedBoundingBox(e,n,a.screenSpaceObjects,o,c);isFinite(h[2])&&isFinite(h[5])||(a.requiresDrapedElevation=!0),h&&u.expandWithAABB(a.boundingBox,c),b.release(c)}));return function(i){return e.apply(this,arguments)}}()),u.allFinite(a.boundingBox)||p.allFinite(u.toRect(a.boundingBox,g))?a:null}));function s(i,e,r,s,n){return t.apply(this,arguments)}return s}(),_.needsElevationUpdates=function(){for(const i of this.graphics)if(r.isSome(i)&&("object3d"===i.type||"lod-instance"===i.type)&&i.needsElevationUpdates)return!0;for(const i of this._labelGraphics)if(i&&i.needsElevationUpdates)return!0;return!1},_.alignWithElevation=function(i,e,t){this._forEachRenderedGraphic((r=>{"object3d"!==r.type&&"lod-instance"!==r.type||r.alignWithElevation(i,e,this._featureExpressionFeature,t)}))},_.addObjectStateSet=function(i,e){this._forEachSymbolLayerGraphic((t=>t.addObjectState(i,e)))},_.removeObjectState=function(i){this._forEachSymbolLayerGraphic((e=>e.removeObjectState(i)))},_._forEachGraphicList=function(i,e){i.forEach((i=>i&&e(i)))},_._forEachSymbolLayerGraphic=function(i){this._forEachGraphicList(this.graphics,i),this._forEachGraphicList(this._auxiliaryGraphics,i)},_._forEachLabelGraphic=function(i){this._forEachGraphicList(this._labelGraphics,i)},_._forEachRenderedGraphic=function(i){this._forEachSymbolLayerGraphic(i),this._forEachLabelGraphic(i)},i._createClass(s,[{key:"labelGraphics",get:function(){return this._labelGraphics}},{key:"extent",get:function(){return this._extent}},{key:"destroyed",get:function(){return null==this.graphics}},{key:"isDraped",get:function(){let i=!1;return this._forEachSymbolLayerGraphic((e=>{"draped"===e.type&&(i=!0)})),i}},{key:"usedMemory",get:function(){let i=t.estimateAttributesObjectSize(this.graphic.attributes);return this._forEachSymbolLayerGraphic((e=>{const t=e.graphics3DSymbolLayer.complexity;if(r.isNone(t))return;const s="draped"===e.type?t.memory.draped:t.memory;i+=s.bytesPerFeature,s.bytesPerCoordinate&&(i+=y.numVertices(this.graphic.geometry)*s.bytesPerCoordinate)})),i}}]),s}();function G(i,e){const t=new Array(i);for(let r=0;r<t.length;r++)t[r]=new Array(e);return t}return _}));
