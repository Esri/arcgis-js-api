/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../core/asyncUtils","../../../../core/byteSizeEstimations","../../../../core/maybe","../../../../core/ObjectPool","../../../../chunks/vec2","../../../../chunks/vec2f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/Polygon","../../../../geometry/projection","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/spatialReferenceUtils","../../../../layers/graphics/dehydratedFeatures","../../../../layers/graphics/featureConversionUtils","./enums","./featureExpressionInfoUtils"],(function(e,i,t,r,s,n,o,a,c,h,l,u,p,y,f,d,m,b){"use strict";const g=new s(Array,(e=>u.set(e,u.ZERO)),null,10,5),_=p.create();let G=function(){function s(e,i,t,s,n){this.graphic=e,this.graphics3DSymbol=i,this.graphics=t,this._labelGraphics=new Array,this._auxiliaryGraphics=new Array,this._visibilityFlags=E(m.VisibilityGroup._COUNT,m.VisibilityFlag._COUNT),this._featureExpressionFeature=null,this._optimizedGeometry={geometry:null,hasZ:!1,hasM:!1},this._extent=null,this.isElevationSource=!1,++i.referenced,this._featureExpressionFeature=n?b.createFeature(n,e,s):null;for(const o of t)r.isSome(o)&&(this.isElevationSource=this.isElevationSource||o.isElevationSource)}var G=s.prototype;return G.initialize=function(e,i){this._layer=i,this._stage=e,this._forEachSymbolLayerGraphic((t=>{t.initialize(e,i),t.setVisibility(this.isVisible())}))},G.destroy=function(){this._forEachSymbolLayerGraphic((e=>e.destroy())),this.graphics=null,this._auxiliaryGraphics=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null},G.clearLabelGraphics=function(){this._forEachLabelGraphic((e=>e.destroy())),this._labelGraphics.length=0},G.addLabelGraphic=function(e,i,t){this._labelGraphics.push(e),e.initialize(i,t),e.setVisibility(this.isVisible(m.VisibilityGroup.LABEL))},G.addAuxiliaryGraphic=function(e){this._auxiliaryGraphics.push(e),this._layer&&(e.initialize(this._stage,this._layer),e.setVisibility(this.isVisible()))},G.isVisible=function(e=m.VisibilityGroup.GRAPHIC,i){for(let t=0;t<=e;t++){const e=this._visibilityFlags[t];for(let t=0;t<e.length;++t)if(!1===e[t]&&t!==i)return!1}return!0},G.hasVisibilityFlag=function(e,i){return null!=this._visibilityFlags[i][e]},G.setVisibilityFlag=function(e,i,t){const r=this.isVisible(t);this._visibilityFlags[t][e]=i;const s=this.isVisible(t);if(r===s)return!1;if(t===m.VisibilityGroup.LABEL)this._forEachLabelGraphic((e=>e.setVisibility(s)));else{this._forEachSymbolLayerGraphic((e=>e.setVisibility(s)));const e=this.isVisible(m.VisibilityGroup.LABEL);this._forEachLabelGraphic((i=>i.setVisibility(e)))}return!0},G.clearVisibilityFlag=function(e,i=m.VisibilityGroup.GRAPHIC){return this.setVisibilityFlag(e,void 0,i)},G.computeExtent=function(e){if(!this._extent){const i=this.graphic.geometry;if(r.isNone(i))return!1;this._extent=p.create(),f.computeAABR(i,this._extent);const t=i.spatialReference;if(!y.equals(t,e)&&!l.projectBoundingRect(this._extent,t,this._extent,e))return this._extent=null,!1}return!0},G.getAsOptimizedGeometry=function(e,i){return r.isSome(this._optimizedGeometry.geometry)&&this._optimizedGeometry.hasZ===e&&this._optimizedGeometry.hasM===i||(this._optimizedGeometry.geometry=this._convertGraphicToOptimizedGeometry(this.graphic,e,i),this._optimizedGeometry.hasZ=e,this._optimizedGeometry.hasM=i),this._optimizedGeometry.geometry},G._convertGraphicToOptimizedGeometry=function(e,i,t){let r=e.geometry;return"mesh"!==r.type&&"extent"!==r.type||(r=h.fromExtent("mesh"===r.type?r.extent:r)),d.convertFromGeometry(r,i,t)},G.computeAttachmentOrigin=function(){const e={render:{origin:c.create(),num:0},draped:{origin:o.create(),num:0}};for(const i of this.graphics)r.isNone(i)||i.computeAttachmentOrigin(e);return e.render.num&&a.scale(e.render.origin,e.render.origin,1/e.render.num),e.draped.num&&n.scale(e.draped.origin,e.draped.origin,1/e.draped.num),e},G.getProjectedBoundingBox=function(){var t=e._asyncToGenerator((function*(t,s,n,o,a){return a||(a={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),a.boundingBox?u.empty(a.boundingBox):a.boundingBox=u.empty(),a.requiresDrapedElevation=!1,yield i.forEach(this.graphics,function(){var i=e._asyncToGenerator((function*(e){if(r.isNone(e))return;const i="draped"===e.type?s:t,c=g.acquire(),h=yield e.getProjectedBoundingBox(i,n,a.screenSpaceObjects,o,c);isFinite(h[2])&&isFinite(h[5])||(a.requiresDrapedElevation=!0),h&&u.expandWithAABB(a.boundingBox,c),g.release(c)}));return function(e){return i.apply(this,arguments)}}()),u.allFinite(a.boundingBox)||p.allFinite(u.toRect(a.boundingBox,_))?a:null}));function s(e,i,r,s,n){return t.apply(this,arguments)}return s}(),G.needsElevationUpdates=function(){for(const e of this.graphics)if(r.isSome(e)&&("object3d"===e.type||"lod-instance"===e.type)&&e.needsElevationUpdates)return!0;for(const e of this._labelGraphics)if(e&&e.needsElevationUpdates)return!0;return!1},G.alignWithElevation=function(e,i,t){this._forEachRenderedGraphic((r=>{"object3d"!==r.type&&"lod-instance"!==r.type||r.alignWithElevation(e,i,this._featureExpressionFeature,t)}))},G.addObjectStateSet=function(e,i){this._forEachSymbolLayerGraphic((t=>t.addObjectState(e,i)))},G.removeObjectState=function(e){this._forEachSymbolLayerGraphic((i=>i.removeObjectState(e)))},G._forEachGraphicList=function(e,i){e.forEach((e=>e&&i(e)))},G._forEachSymbolLayerGraphic=function(e){this._forEachGraphicList(this.graphics,e),this._forEachGraphicList(this._auxiliaryGraphics,e)},G._forEachLabelGraphic=function(e){this._forEachGraphicList(this._labelGraphics,e)},G._forEachRenderedGraphic=function(e){this._forEachSymbolLayerGraphic(e),this._forEachLabelGraphic(e)},e._createClass(s,[{key:"labelGraphics",get:function(){return this._labelGraphics}},{key:"extent",get:function(){return this._extent}},{key:"destroyed",get:function(){return null==this.graphics}},{key:"isDraped",get:function(){let e=!1;return this._forEachSymbolLayerGraphic((i=>{"draped"===i.type&&(e=!0)})),e}},{key:"usedMemory",get:function(){let e=t.estimateAttributesObjectSize(this.graphic.attributes);return this._forEachSymbolLayerGraphic((i=>{const t=i.graphics3DSymbolLayer.complexity;if(r.isNone(t))return;const s="draped"===i.type?t.memory.draped:t.memory;e+=s.bytesPerFeature,s.bytesPerCoordinate&&(e+=f.numVertices(this.graphic.geometry)*s.bytesPerCoordinate)})),e}}]),s}();function E(e,i){const t=new Array(e);for(let r=0;r<t.length;r++)t[r]=new Array(i);return t}return G}));
