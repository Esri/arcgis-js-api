/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../core/asyncUtils","../../../../core/byteSizeEstimations","../../../../core/maybe","../../../../core/ObjectPool","../../../../chunks/vec2","../../../../chunks/vec2f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/Polygon","../../../../geometry/projection","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../layers/graphics/dehydratedFeatures","../../../../layers/graphics/featureConversionUtils","./featureExpressionInfoUtils"],(function(e,i,t,r,n,s,o,a,c,h,l,u,p,y,d,f){"use strict";const m=new n(Array,(e=>u.set(e,u.ZERO)),null,10,5),g=p.create();let b=function(){function n(e,i,t,n,s){this.graphic=e,this.graphics3DSymbol=i,this.graphics=t,this._labelGraphics=new Array,this._auxiliaryGraphics=new Array,this._visibilityFlags=G(2,4),this._featureExpressionFeature=null,this._optimizedGeometry={geometry:null,hasZ:!1,hasM:!1},this._extent=null,this.isElevationSource=!1,++i.referenced,this._featureExpressionFeature=s?f.createFeature(s,e,n):null;for(const o of t)r.isSome(o)&&(this.isElevationSource=this.isElevationSource||o.isElevationSource)}var b=n.prototype;return b.initialize=function(e,i,t){this._layer=i,this._stage=e,this.forEachSymbolLayerGraphic((r=>{r.initialize(e,i,t),r.setVisibility(this.isVisible())}))},b.destroy=function(){this.forEachSymbolLayerGraphic((e=>e.destroy())),this.graphics=null,this._auxiliaryGraphics=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null},b.clearLabelGraphics=function(){this.forEachLabelGraphic((e=>e.destroy())),this._labelGraphics.length=0},b.addLabelGraphic=function(e,i,t){this._labelGraphics.push(e),e.initialize(i,t),e.setVisibility(this.isVisible(1))},b.addAuxiliaryGraphic=function(e){this._auxiliaryGraphics.push(e),this._layer&&(e.initialize(this._stage,this._layer),e.setVisibility(this.isVisible()))},b.isVisible=function(e=0,i){for(let t=0;t<=e;t++){const e=this._visibilityFlags[t];for(let t=0;t<e.length;++t)if(!1===e[t]&&t!==i)return!1}return!0},b.hasVisibilityFlag=function(e,i){return null!=this._visibilityFlags[i][e]},b.setVisibilityFlag=function(e,i,t){const r=this.isVisible(t);this._visibilityFlags[t][e]=i;const n=this.isVisible(t);if(r===n)return!1;if(1===t)this.forEachLabelGraphic((e=>e.setVisibility(n)));else{this.forEachSymbolLayerGraphic((e=>e.setVisibility(n)));const e=this.isVisible(1);this.forEachLabelGraphic((i=>i.setVisibility(e)))}return!0},b.clearVisibilityFlag=function(e,i=0){return this.setVisibilityFlag(e,void 0,i)},b.computeExtent=function(e){if(!this._extent){const i=this.graphic.geometry;if(r.isNone(i))return!1;this._extent=p.create(),y.computeAABR(i,this._extent);const t=i.spatialReference;if(!t.equals(e)&&!l.projectBoundingRect(this._extent,t,this._extent,e))return this._extent=null,!1}return!0},b.getAsOptimizedGeometry=function(e,i){return r.isSome(this._optimizedGeometry.geometry)&&this._optimizedGeometry.hasZ===e&&this._optimizedGeometry.hasM===i||(this._optimizedGeometry.geometry=this._convertGraphicToOptimizedGeometry(this.graphic,e,i),this._optimizedGeometry.hasZ=e,this._optimizedGeometry.hasM=i),this._optimizedGeometry.geometry},b._convertGraphicToOptimizedGeometry=function(e,i,t){let r=e.geometry;return"mesh"!==r.type&&"extent"!==r.type||(r=h.fromExtent("mesh"===r.type?r.extent:r)),d.convertFromGeometry(r,i,t)},b.computeAttachmentOrigin=function(){const e={render:{origin:c.create(),num:0},draped:{origin:o.create(),num:0}};for(const i of this.graphics)r.isNone(i)||i.computeAttachmentOrigin(e);return e.render.num&&a.scale(e.render.origin,e.render.origin,1/e.render.num),e.draped.num&&s.scale(e.draped.origin,e.draped.origin,1/e.draped.num),e},b.getProjectedBoundingBox=function(){var t=e._asyncToGenerator((function*(t,n,s,o,a){return a||(a={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),a.boundingBox?u.empty(a.boundingBox):a.boundingBox=u.empty(),a.requiresDrapedElevation=!1,yield i.forEach(this.graphics,function(){var i=e._asyncToGenerator((function*(e){if(r.isNone(e))return;const i="draped"===e.type?n:t,c=m.acquire(),h=yield e.getProjectedBoundingBox(i,s,a.screenSpaceObjects,o,c);isFinite(h[2])&&isFinite(h[5])||(a.requiresDrapedElevation=!0),h&&u.expandWithAABB(a.boundingBox,c),m.release(c)}));return function(e){return i.apply(this,arguments)}}()),u.allFinite(a.boundingBox)||p.allFinite(u.toRect(a.boundingBox,g))?a:null}));function n(e,i,r,n,s){return t.apply(this,arguments)}return n}(),b.needsElevationUpdates=function(){for(const e of this.graphics)if(r.isSome(e)&&("object3d"===e.type||"lod-instance"===e.type)&&e.needsElevationUpdates)return!0;for(const e of this._labelGraphics)if(e&&e.needsElevationUpdates)return!0;return!1},b.alignWithElevation=function(e,i,t){this.forEachRenderedGraphic((r=>{"object3d"!==r.type&&"lod-instance"!==r.type||r.alignWithElevation(e,i,this._featureExpressionFeature,t)}))},b.addObjectStateSet=function(e,i){this.forEachSymbolLayerGraphic((t=>t.addObjectState(e,i)))},b.removeObjectState=function(e){this.forEachSymbolLayerGraphic((i=>i.removeObjectState(e)))},b.forEachGraphicList=function(e,i){e.forEach((e=>e&&i(e)))},b.forEachSymbolLayerGraphic=function(e){this.forEachGraphicList(this.graphics,e),this.forEachGraphicList(this._auxiliaryGraphics,e)},b.forEachLabelGraphic=function(e){this.forEachGraphicList(this._labelGraphics,e)},b.forEachRenderedGraphic=function(e){this.forEachSymbolLayerGraphic(e),this.forEachLabelGraphic(e)},e._createClass(n,[{key:"labelGraphics",get:function(){return this._labelGraphics}},{key:"extent",get:function(){return this._extent}},{key:"destroyed",get:function(){return null==this.graphics}},{key:"isDraped",get:function(){let e=!1;return this.forEachSymbolLayerGraphic((i=>{"draped"===i.type&&(e=!0)})),e}},{key:"usedMemory",get:function(){let e=t.estimateAttributesObjectSize(this.graphic.attributes);return this.forEachSymbolLayerGraphic((i=>{const t=i.graphics3DSymbolLayer.complexity;if(r.isNone(t))return;const n="draped"===i.type?t.memory.draped:t.memory;e+=n.bytesPerFeature,n.bytesPerCoordinate&&(e+=y.numVertices(this.graphic.geometry)*n.bytesPerCoordinate)})),e}}]),n}();function G(e,i){const t=new Array(e);for(let r=0;r<t.length;r++)t[r]=new Array(i);return t}return b}));
