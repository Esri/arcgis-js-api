/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/ObjectPool","../../../../geometry/Polygon","../../../../core/asyncUtils","../../../../chunks/vec3f64","../../../../chunks/vec3","../../../../geometry/support/aaBoundingRect","../../../../geometry/projection","../../../../layers/graphics/featureConversionUtils","../../../../chunks/vec2f64","../../../../chunks/vec2","../../../../geometry/support/aaBoundingBox","../../../../layers/graphics/dehydratedFeatures","./featureExpressionInfoUtils"],(function(e,i,t,r,s,n,a,o,c,h,l,u,p,y,d){"use strict";const f=new t(Array,(e=>p.set(e,p.ZERO)),null,10,5),g=o.create();return function(){function t(e,t,r,s,n){this._labelGraphics=new Array,this._auxiliaryGraphics=new Array,this._visibilityFlags=function(e,i){const t=new Array(e);for(let e=0;e<t.length;e++)t[e]=new Array(i);return t}(2,4),this._featureExpressionFeature=null,this._optimizedGeometry={geometry:null,hasZ:!1,hasM:!1},this._extent=null,this.isElevationSource=!1,++t.referenced,this.graphics3DSymbol=t,this.graphic=e,this._graphics=r,this._featureExpressionFeature=n?d.createFeature(n,e,s):null;for(const e of this._graphics)i.isSome(e)&&(this.isElevationSource=this.isElevationSource||e.isElevationSource)}var m=t.prototype;return m.initialize=function(e,i,t){this._layer=i,this._stage=e,this.forEachSymbolLayerGraphic((r=>{r.initialize(e,i,t),r.setVisibility(this.isVisible())}))},m.destroy=function(){this.forEachSymbolLayerGraphic((e=>e.destroy())),this._graphics=null,this._auxiliaryGraphics=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null},m.clearLabelGraphics=function(){this.forEachLabelGraphic((e=>e.destroy())),this._labelGraphics.length=0},m.addLabelGraphic=function(e,i,t){this._labelGraphics.push(e),e.initialize(i,t),e.setVisibility(this.isVisible(1))},m.addAuxiliaryGraphic=function(e){this._auxiliaryGraphics.push(e),this._layer&&(e.initialize(this._stage,this._layer),e.setVisibility(this.isVisible()))},m.isVisible=function(e=0,i){for(let t=0;t<=e;t++){const e=this._visibilityFlags[t];for(let t=0;t<e.length;++t)if(!1===e[t]&&t!==i)return!1}return!0},m.hasVisibilityFlag=function(e,i){return null!=this._visibilityFlags[i][e]},m.setVisibilityFlag=function(e,i,t){const r=this.isVisible(t);this._visibilityFlags[t][e]=i;const s=this.isVisible(t);if(r===s)return!1;if(1===t)this.forEachLabelGraphic((e=>e.setVisibility(s)));else{this.forEachSymbolLayerGraphic((e=>e.setVisibility(s)));const e=this.isVisible(1);this.forEachLabelGraphic((i=>i.setVisibility(e)))}return!0},m.clearVisibilityFlag=function(e,i=0){return this.setVisibilityFlag(e,void 0,i)},m.getBSRadius=function(){let e=0;return this.forEachSymbolLayerGraphic((i=>{e=Math.max(e,i.getBSRadius())})),e},m.getCenterObjectSpace=function(e=n.create()){if(0===this._graphics.length)return a.set(e,0,0,0),e;const t=this._graphics[0];return i.isSome(t)?t.getCenterObjectSpace(e):e},m.computeExtent=function(e){if(!this._extent){const t=this.graphic.geometry;if(i.isNone(t))return!1;this._extent=o.create(),y.computeAABR(t,this._extent);const r=t.spatialReference;if(!r.equals(e)&&!c.projectBoundingRect(this._extent,r,this._extent,e))return this._extent=null,!1}return!0},m.getAsOptimizedGeometry=function(e,i){return this._optimizedGeometry.geometry&&this._optimizedGeometry.hasZ===e&&this._optimizedGeometry.hasM===i||(this._optimizedGeometry.geometry=this._convertGraphicToOptimizedGeometry(this.graphic,e,i),this._optimizedGeometry.hasZ=e,this._optimizedGeometry.hasM=i),this._optimizedGeometry.geometry},m._convertGraphicToOptimizedGeometry=function(e,i,t){let s=e.geometry;return"mesh"!==s.type&&"extent"!==s.type||(s=r.fromExtent("mesh"===s.type?s.extent:s)),h.convertFromGeometry(s,i,t)},m.computeAttachmentOrigin=function(){const e={render:{origin:n.create(),num:0},draped:{origin:l.create(),num:0}};for(const t of this._graphics)i.isNone(t)||t.computeAttachmentOrigin(e);return e.render.num&&a.scale(e.render.origin,e.render.origin,1/e.render.num),e.draped.num&&u.scale(e.draped.origin,e.draped.origin,1/e.draped.num),e},m.getProjectedBoundingBox=async function(e,t,r,n,a){return a||(a={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),a.boundingBox?p.empty(a.boundingBox):a.boundingBox=p.empty(),a.requiresDrapedElevation=!1,await s.forEach(this._graphics,(async s=>{if(i.isNone(s))return;const o="draped"===s.type?t:e,c=f.acquire(),h=await s.getProjectedBoundingBox(o,r,a.screenSpaceObjects,n,c);isFinite(h[2])&&isFinite(h[5])||(a.requiresDrapedElevation=!0),h&&p.expandWithAABB(a.boundingBox,c),f.release(c)})),p.allFinite(a.boundingBox)||o.allFinite(p.toRect(a.boundingBox,g))?a:null},m.needsElevationUpdates=function(){for(const e of this._graphics)if(i.isSome(e)&&("object3d"===e.type||"lod-instance"===e.type)&&e.needsElevationUpdates)return!0;for(const e of this._labelGraphics)if(e&&e.needsElevationUpdates)return!0;return!1},m.alignWithElevation=function(e,i,t){this.forEachRenderedGraphic((r=>{"object3d"!==r.type&&"lod-instance"!==r.type||r.alignWithElevation(e,i,this._featureExpressionFeature,t)}))},m.addObjectStateSet=function(e,i){this.forEachSymbolLayerGraphic((t=>t.addObjectState(e,i)))},m.removeObjectState=function(e){this.forEachSymbolLayerGraphic((i=>i.removeObjectState(e)))},m.forEachGraphicList=function(e,i){e.forEach((e=>e&&i(e)))},m.forEachSymbolLayerGraphic=function(e){this.forEachGraphicList(this._graphics,e),this.forEachGraphicList(this._auxiliaryGraphics,e)},m.forEachLabelGraphic=function(e){this.forEachGraphicList(this._labelGraphics,e)},m.forEachRenderedGraphic=function(e){this.forEachSymbolLayerGraphic(e),this.forEachLabelGraphic(e)},e._createClass(t,[{key:"labelGraphics",get:function(){return this._labelGraphics}},{key:"extent",get:function(){return this._extent}},{key:"destroyed",get:function(){return null==this._graphics}},{key:"isDraped",get:function(){let e=!1;return this.forEachSymbolLayerGraphic((i=>{"draped"===i.type&&(e=!0)})),e}},{key:"usedMemory",get:function(){let e=y.estimateAttributesObjectSize(this.graphic.attributes);return this.forEachSymbolLayerGraphic((t=>{const r=t.graphics3DSymbolLayer.complexity;if(i.isNone(r))return;const s="draped"===t.type?r.memory.draped:r.memory;e+=s.bytesPerFeature,s.bytesPerCoordinate&&(e+=y.numVertices(this.graphic.geometry)*s.bytesPerCoordinate)})),e}}]),t}()}));
