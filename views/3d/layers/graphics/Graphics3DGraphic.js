// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../core/asyncUtils","../../../../core/maybe","../../../../core/ObjectPool","../../../../core/libs/gl-matrix-2/vec2","../../../../core/libs/gl-matrix-2/vec2f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../geometry/Polygon","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../layers/graphics/dehydratedFeatures","../../../../layers/graphics/featureConversionUtils","./featureExpressionInfoUtils","../../support/projectionUtils"],(function(e,t,i,r,o,n,a,s,c,h,p,u,l,y,f,d,b){"use strict";var g=new n(Array,(function(e){return u.set(e,u.ZERO)}),null,10,5),m=l.create();return function(){function e(e,t,i,r,n){this._labelGraphics=new Array,this._auxiliaryGraphics=new Array,this._visibilityFlags=function(e,t){for(var i=new Array(e),r=0;r<i.length;r++)i[r]=new Array(t);return i}(2,4),this._featureExpressionFeature=null,this._optimizedGeometry={geometry:null,hasZ:!1,hasM:!1},this._extent=null,this.isElevationSource=!1,++t.referenced,this.graphics3DSymbol=t,this.graphic=e,this._graphics=i,this._featureExpressionFeature=n?d.createFeature(n,e,r):null;for(var a=0,s=this._graphics;a<s.length;a++){var c=s[a];o.isSome(c)&&(this.isElevationSource=this.isElevationSource||c.isElevationSource)}}return Object.defineProperty(e.prototype,"labelGraphics",{get:function(){return this._labelGraphics},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"extent",{get:function(){return this._extent},enumerable:!1,configurable:!0}),e.prototype.initialize=function(e,t,i){var r=this;this._layer=t,this._stage=e,this.forEachSymbolLayerGraphic((function(o){o.initialize(e,t,i),o.setVisibility(r.isVisible())}))},e.prototype.destroy=function(){this.forEachSymbolLayerGraphic((function(e){return e.destroy()})),this._graphics=null,this._auxiliaryGraphics=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null},Object.defineProperty(e.prototype,"destroyed",{get:function(){return null==this._graphics},enumerable:!1,configurable:!0}),e.prototype.clearLabelGraphics=function(){this.forEachLabelGraphic((function(e){return e.destroy()})),this._labelGraphics.length=0},e.prototype.addLabelGraphic=function(e,t,i){this._labelGraphics.push(e),e.initialize(t,i),e.setVisibility(this.isVisible(1))},e.prototype.addAuxiliaryGraphic=function(e){this._auxiliaryGraphics.push(e),this._layer&&(e.initialize(this._stage,this._layer),e.setVisibility(this.isVisible()))},Object.defineProperty(e.prototype,"isDraped",{get:function(){var e=!1;return this.forEachSymbolLayerGraphic((function(t){"draped"===t.type&&(e=!0)})),e},enumerable:!1,configurable:!0}),e.prototype.isVisible=function(e,t){void 0===e&&(e=0);for(var i=0;i<=e;i++)for(var r=this._visibilityFlags[i],o=0;o<r.length;++o)if(!1===r[o]&&o!==t)return!1;return!0},e.prototype.hasVisibilityFlag=function(e,t){return null!=this._visibilityFlags[t][e]},e.prototype.setVisibilityFlag=function(e,t,i){var r=this.isVisible(i);this._visibilityFlags[i][e]=t;var o=this.isVisible(i);if(r===o)return!1;if(1===i)this.forEachLabelGraphic((function(e){return e.setVisibility(o)}));else{this.forEachSymbolLayerGraphic((function(e){return e.setVisibility(o)}));var n=this.isVisible(1);this.forEachLabelGraphic((function(e){return e.setVisibility(n)}))}return!0},e.prototype.clearVisibilityFlag=function(e,t){return void 0===t&&(t=0),this.setVisibilityFlag(e,void 0,t)},e.prototype.getBSRadius=function(){var e=0;return this.forEachSymbolLayerGraphic((function(t){e=Math.max(e,t.getBSRadius())})),e},e.prototype.getCenterObjectSpace=function(e){if(void 0===e&&(e=h.vec3f64.create()),0===this._graphics.length)return c.vec3.set(e,0,0,0),e;var t=this._graphics[0];return o.isSome(t)?t.getCenterObjectSpace(e):e},e.prototype.computeExtent=function(e){if(!this._extent){var t=this.graphic.geometry;if(o.isNone(t))return!1;this._extent=l.create(),y.computeAABR(t,this._extent);var i=t.spatialReference;if(!i.equals(e)&&!b.boundingRectToBoundingRect(this._extent,i,this._extent,e))return this._extent=null,!1}return!0},e.prototype.getAsOptimizedGeometry=function(e,t){return this._optimizedGeometry.geometry&&this._optimizedGeometry.hasZ===e&&this._optimizedGeometry.hasM===t?this._optimizedGeometry.geometry:(this._optimizedGeometry.geometry=this._convertGraphicToOptimizedGeometry(this.graphic,e,t),this._optimizedGeometry.hasZ=e,this._optimizedGeometry.hasM=t,this._optimizedGeometry.geometry)},e.prototype._convertGraphicToOptimizedGeometry=function(e,t,i){var r=e.geometry;return"mesh"!==r.type&&"extent"!==r.type||(r=p.fromExtent("mesh"===r.type?r.extent:r)),f.convertFromGeometry(r,t,i)},Object.defineProperty(e.prototype,"usedMemory",{get:function(){var e=this,t=y.estimateAttributesObjectSize(this.graphic.attributes);return this.forEachSymbolLayerGraphic((function(i){var r=i.graphics3DSymbolLayer.complexity;if(!o.isNone(r)){var n="draped"===i.type?r.memory.draped:r.memory;t+=n.bytesPerFeature,n.bytesPerCoordinate&&(t+=y.numVertices(e.graphic.geometry)*n.bytesPerCoordinate)}})),t},enumerable:!1,configurable:!0}),e.prototype.computeAttachmentOrigin=function(){for(var e={render:{origin:h.vec3f64.create(),num:0},draped:{origin:s.vec2f64.create(),num:0}},t=0,i=this._graphics;t<i.length;t++){var r=i[t];o.isNone(r)||r.computeAttachmentOrigin(e)}return e.render.num&&c.vec3.scale(e.render.origin,e.render.origin,1/e.render.num),e.draped.num&&a.vec2.scale(e.draped.origin,e.draped.origin,1/e.draped.num),e},e.prototype.getProjectedBoundingBox=function(e,t,n,a,s){return i.__awaiter(this,void 0,void 0,(function(){var c=this;return i.__generator(this,(function(h){switch(h.label){case 0:return s||(s={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),s.boundingBox?u.empty(s.boundingBox):s.boundingBox=u.empty(),s.requiresDrapedElevation=!1,[4,r.forEach(this._graphics,(function(r){return i.__awaiter(c,void 0,void 0,(function(){var c,h,p;return i.__generator(this,(function(i){switch(i.label){case 0:return o.isNone(r)?[2]:(c="draped"===r.type?t:e,h=g.acquire(),[4,r.getProjectedBoundingBox(c,n,s.screenSpaceObjects,a,h)]);case 1:return p=i.sent(),isFinite(p[2])&&isFinite(p[5])||(s.requiresDrapedElevation=!0),p&&u.expand(s.boundingBox,h),g.release(h),[2]}}))}))}))];case 1:return h.sent(),u.allFinite(s.boundingBox)||l.allFinite(u.toRect(s.boundingBox,m))?[2,s]:[2,null]}}))}))},e.prototype.needsElevationUpdates=function(){for(var e=0,t=this._graphics;e<t.length;e++){var i=t[e];if(o.isSome(i)&&("object3d"===i.type||"lod-instance"===i.type)&&i.needsElevationUpdates)return!0}for(var r=0,n=this._labelGraphics;r<n.length;r++){if((i=n[r])&&i.needsElevationUpdates)return!0}return!1},e.prototype.alignWithElevation=function(e,t,i){var r=this;this.forEachRenderedGraphic((function(o){"object3d"!==o.type&&"lod-instance"!==o.type||o.alignWithElevation(e,t,r._featureExpressionFeature,i)}))},e.prototype.addObjectStateSet=function(e,t){this.forEachSymbolLayerGraphic((function(i){return i.addObjectState(e,t)}))},e.prototype.removeObjectState=function(e){this.forEachSymbolLayerGraphic((function(t){return t.removeObjectState(e)}))},e.prototype.forEachGraphicList=function(e,t){e.forEach((function(e){return e&&t(e)}))},e.prototype.forEachSymbolLayerGraphic=function(e){this.forEachGraphicList(this._graphics,e),this.forEachGraphicList(this._auxiliaryGraphics,e)},e.prototype.forEachLabelGraphic=function(e){this.forEachGraphicList(this._labelGraphics,e)},e.prototype.forEachRenderedGraphic=function(e){this.forEachSymbolLayerGraphic(e),this.forEachLabelGraphic(e)},e}()}));