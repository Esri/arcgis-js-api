/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{forEach as i}from"../../../../core/asyncUtils.js";import{estimateAttributesObjectSize as e}from"../../../../core/byteSizeEstimations.js";import{isSome as t,isNone as r}from"../../../../core/maybe.js";import s from"../../../../core/ObjectPool.js";import{f as a}from"../../../../chunks/vec2.js";import{a as o}from"../../../../chunks/vec2f64.js";import{g as h}from"../../../../chunks/vec3.js";import{c as n}from"../../../../chunks/vec3f64.js";import c from"../../../../geometry/Polygon.js";import{projectBoundingRect as l}from"../../../../geometry/projection.js";import{set as p,ZERO as m,empty as y,expandWithAABB as u,allFinite as d,toRect as f}from"../../../../geometry/support/aaBoundingBox.js";import{create as g,allFinite as b}from"../../../../geometry/support/aaBoundingRect.js";import{computeAABR as _,numVertices as G}from"../../../../layers/graphics/dehydratedFeatures.js";import{convertFromGeometry as E}from"../../../../layers/graphics/featureConversionUtils.js";import{VisibilityFlag as x,VisibilityGroup as j}from"./enums.js";import{createFeature as L}from"./featureExpressionInfoUtils.js";const v=new s(Array,(i=>p(i,m)),null,10,5),S=g();class B{constructor(i,e,r,s,a){this.graphic=i,this.graphics3DSymbol=e,this.graphics=r,this._labelGraphics=new Array,this._auxiliaryGraphics=new Array,this._visibilityFlags=V(j._COUNT,x._COUNT),this._featureExpressionFeature=null,this._optimizedGeometry={geometry:null,hasZ:!1,hasM:!1},this._extent=null,this.isElevationSource=!1,++e.referenced,this._featureExpressionFeature=a?L(a,i,s):null;for(const o of r)t(o)&&(this.isElevationSource=this.isElevationSource||o.isElevationSource)}get labelGraphics(){return this._labelGraphics}get extent(){return this._extent}initialize(i,e){this._layer=e,this._stage=i,this._forEachSymbolLayerGraphic((t=>{t.initialize(i,e),t.setVisibility(this.isVisible())}))}destroy(){this._forEachSymbolLayerGraphic((i=>i.destroy())),this.graphics=null,this._auxiliaryGraphics=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null}get destroyed(){return null==this.graphics}clearLabelGraphics(){this._forEachLabelGraphic((i=>i.destroy())),this._labelGraphics.length=0}addLabelGraphic(i,e,t){this._labelGraphics.push(i),i.initialize(e,t),i.setVisibility(this.isVisible(j.LABEL))}addAuxiliaryGraphic(i){this._auxiliaryGraphics.push(i),this._layer&&(i.initialize(this._stage,this._layer),i.setVisibility(this.isVisible()))}get isDraped(){let i=!1;return this._forEachSymbolLayerGraphic((e=>{"draped"===e.type&&(i=!0)})),i}isVisible(i=j.GRAPHIC,e){for(let t=0;t<=i;t++){const i=this._visibilityFlags[t];for(let t=0;t<i.length;++t)if(!1===i[t]&&t!==e)return!1}return!0}hasVisibilityFlag(i,e){return null!=this._visibilityFlags[e][i]}setVisibilityFlag(i,e,t){const r=this.isVisible(t);this._visibilityFlags[t][i]=e;const s=this.isVisible(t);if(r===s)return!1;if(t===j.LABEL)this._forEachLabelGraphic((i=>i.setVisibility(s)));else{this._forEachSymbolLayerGraphic((i=>i.setVisibility(s)));const i=this.isVisible(j.LABEL);this._forEachLabelGraphic((e=>e.setVisibility(i)))}return!0}clearVisibilityFlag(i,e=j.GRAPHIC){return this.setVisibilityFlag(i,void 0,e)}computeExtent(i){if(!this._extent){const e=this.graphic.geometry;if(r(e))return!1;this._extent=g(),_(e,this._extent);const t=e.spatialReference;if(!t.equals(i)&&!l(this._extent,t,this._extent,i))return this._extent=null,!1}return!0}getAsOptimizedGeometry(i,e){return t(this._optimizedGeometry.geometry)&&this._optimizedGeometry.hasZ===i&&this._optimizedGeometry.hasM===e||(this._optimizedGeometry.geometry=this._convertGraphicToOptimizedGeometry(this.graphic,i,e),this._optimizedGeometry.hasZ=i,this._optimizedGeometry.hasM=e),this._optimizedGeometry.geometry}_convertGraphicToOptimizedGeometry(i,e,t){let r=i.geometry;return"mesh"!==r.type&&"extent"!==r.type||(r=c.fromExtent("mesh"===r.type?r.extent:r)),E(r,e,t)}get usedMemory(){let i=e(this.graphic.attributes);return this._forEachSymbolLayerGraphic((e=>{const t=e.graphics3DSymbolLayer.complexity;if(r(t))return;const s="draped"===e.type?t.memory.draped:t.memory;i+=s.bytesPerFeature,s.bytesPerCoordinate&&(i+=G(this.graphic.geometry)*s.bytesPerCoordinate)})),i}computeAttachmentOrigin(){const i={render:{origin:n(),num:0},draped:{origin:o(),num:0}};for(const e of this.graphics)r(e)||e.computeAttachmentOrigin(i);return i.render.num&&h(i.render.origin,i.render.origin,1/i.render.num),i.draped.num&&a(i.draped.origin,i.draped.origin,1/i.draped.num),i}async getProjectedBoundingBox(e,t,s,a,o){return o||(o={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),o.boundingBox?y(o.boundingBox):o.boundingBox=y(),o.requiresDrapedElevation=!1,await i(this.graphics,(async i=>{if(r(i))return;const h="draped"===i.type?t:e,n=v.acquire(),c=await i.getProjectedBoundingBox(h,s,o.screenSpaceObjects,a,n);isFinite(c[2])&&isFinite(c[5])||(o.requiresDrapedElevation=!0),c&&u(o.boundingBox,n),v.release(n)})),d(o.boundingBox)||b(f(o.boundingBox,S))?o:null}needsElevationUpdates(){for(const i of this.graphics)if(t(i)&&("object3d"===i.type||"lod-instance"===i.type)&&i.needsElevationUpdates)return!0;for(const i of this._labelGraphics)if(i&&i.needsElevationUpdates)return!0;return!1}alignWithElevation(i,e,t){this._forEachRenderedGraphic((r=>{"object3d"!==r.type&&"lod-instance"!==r.type||r.alignWithElevation(i,e,this._featureExpressionFeature,t)}))}addObjectStateSet(i,e){this._forEachSymbolLayerGraphic((t=>t.addObjectState(i,e)))}removeObjectState(i){this._forEachSymbolLayerGraphic((e=>e.removeObjectState(i)))}_forEachGraphicList(i,e){i.forEach((i=>i&&e(i)))}_forEachSymbolLayerGraphic(i){this._forEachGraphicList(this.graphics,i),this._forEachGraphicList(this._auxiliaryGraphics,i)}_forEachLabelGraphic(i){this._forEachGraphicList(this._labelGraphics,i)}_forEachRenderedGraphic(i){this._forEachSymbolLayerGraphic(i),this._forEachLabelGraphic(i)}}function V(i,e){const t=new Array(i);for(let r=0;r<t.length;r++)t[r]=new Array(e);return t}export{B as default};
