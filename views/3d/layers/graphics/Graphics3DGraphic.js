/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../core/asyncUtils","../../../../core/byteSizeEstimations","../../../../core/maybe","../../../../core/ObjectPool","../../../../chunks/vec2","../../../../chunks/vec2f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/Polygon","../../../../geometry/projection","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/spatialReferenceUtils","../../../../layers/graphics/dehydratedFeatures","../../../../layers/graphics/featureConversionUtils","./enums","./featureExpressionInfoUtils"],(function(e,i,t,r,n,s,o,a,c,l,h,u,y,p,d,f,b,m){"use strict";const g=new n(Array,(e=>u.set(e,u.ZERO)),null,10,5),_=y.create();let E=function(){function n(e,i,t,n,s){this.graphic=e,this.graphics3DSymbol=i,this.layers=t,this._labelLayers=new Array,this._auxiliaryLayers=new Array,this._visibilityFlags=G(b.VisibilityGroup._COUNT,b.VisibilityFlag._COUNT),this._featureExpressionFeature=null,this._optimizedGeometry={geometry:null,hasZ:!1,hasM:!1},this._extent=null,this.isElevationSource=!1,++i.referenced,this._featureExpressionFeature=s?m.createFeature(s,e,n):null;for(const o of t)r.isSome(o)&&(this.isElevationSource=this.isElevationSource||o.isElevationSource)}var E=n.prototype;return E.initialize=function(e,i){this._layer=i,this._stage=e,this._forEachSymbolLayerGraphic((t=>{t.initialize(e,i),t.setVisibility(this.isVisible())}))},E.destroy=function(){this._forEachSymbolLayerGraphic((e=>e.destroy())),this.layers=null,this._auxiliaryLayers=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null},E.clearLabelGraphics=function(){this._forEachLabelGraphic((e=>e.destroy())),this._labelLayers.length=0},E.addLabelGraphic=function(e,i,t){this._labelLayers.push(e),e.initialize(i,t),e.setVisibility(this.isVisible(b.VisibilityGroup.LABEL))},E.addAuxiliaryGraphic=function(e){this._auxiliaryLayers.push(e),this._layer&&(e.initialize(this._stage,this._layer),e.setVisibility(this.isVisible()))},E.isVisible=function(e=b.VisibilityGroup.GRAPHIC,i){for(let t=0;t<=e;t++){const e=this._visibilityFlags[t];for(let t=0;t<e.length;++t)if(!1===e[t]&&t!==i)return!1}return!0},E.hasVisibilityFlag=function(e,i){return null!=this._visibilityFlags[i][e]},E.setVisibilityFlag=function(e,i,t){const r=this.isVisible(t);this._visibilityFlags[t][e]=i;const n=this.isVisible(t);if(r===n)return!1;if(t===b.VisibilityGroup.LABEL)this._forEachLabelGraphic((e=>e.setVisibility(n)));else{this._forEachSymbolLayerGraphic((e=>e.setVisibility(n)));const e=this.isVisible(b.VisibilityGroup.LABEL);this._forEachLabelGraphic((i=>i.setVisibility(e)))}return!0},E.clearVisibilityFlag=function(e,i=b.VisibilityGroup.GRAPHIC){return this.setVisibilityFlag(e,void 0,i)},E.computeExtent=function(e){if(!this._extent){const i=this.graphic.geometry;if(r.isNone(i))return!1;this._extent=y.create(),d.computeAABR(i,this._extent);const t=i.spatialReference;if(!p.equals(t,e)&&!h.projectBoundingRect(this._extent,t,this._extent,e))return this._extent=null,!1}return!0},E.getAsOptimizedGeometry=function(e,i){return r.isSome(this._optimizedGeometry.geometry)&&this._optimizedGeometry.hasZ===e&&this._optimizedGeometry.hasM===i||(this._optimizedGeometry.geometry=this._convertGraphicToOptimizedGeometry(this.graphic,e,i),this._optimizedGeometry.hasZ=e,this._optimizedGeometry.hasM=i),this._optimizedGeometry.geometry},E._convertGraphicToOptimizedGeometry=function(e,i,t){let r=e.geometry;return"mesh"!==r.type&&"extent"!==r.type||(r=l.fromExtent("mesh"===r.type?r.extent:r)),f.convertFromGeometry(r,i,t)},E.computeAttachmentOrigin=function(){const e={render:{origin:c.create(),num:0},draped:{origin:o.create(),num:0}};for(const i of this.layers)r.isNone(i)||i.computeAttachmentOrigin(e);return e.render.num>1&&a.scale(e.render.origin,e.render.origin,1/e.render.num),e.draped.num>1&&s.scale(e.draped.origin,e.draped.origin,1/e.draped.num),e},E.getProjectedBoundingBox=function(){var t=e._asyncToGenerator((function*(t,n,s,o,a){return a||(a={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),a.boundingBox?u.empty(a.boundingBox):a.boundingBox=u.empty(),a.requiresDrapedElevation=!1,yield i.forEach(this.layers,function(){var i=e._asyncToGenerator((function*(e){if(r.isNone(e))return;const i="draped"===e.type?n:t,c=g.acquire(),l=yield e.getProjectedBoundingBox(i,s,a.screenSpaceObjects,o,c);isFinite(l[2])&&isFinite(l[5])||(a.requiresDrapedElevation=!0),l&&u.expandWithAABB(a.boundingBox,c),g.release(c)}));return function(e){return i.apply(this,arguments)}}()),u.allFinite(a.boundingBox)||y.allFinite(u.toRect(a.boundingBox,_))?a:null}));function n(e,i,r,n,s){return t.apply(this,arguments)}return n}(),E.needsElevationUpdates=function(){for(const e of this.layers)if(r.isSome(e)&&("object3d"===e.type||"lod-instance"===e.type)&&e.needsElevationUpdates)return!0;for(const e of this._labelLayers)if(e&&e.needsElevationUpdates)return!0;return!1},E.alignWithElevation=function(e,i,t){this._forEachRenderedGraphic((r=>{"object3d"!==r.type&&"lod-instance"!==r.type||r.alignWithElevation(e,i,this._featureExpressionFeature,t)}))},E.alignWithAbsoluteElevation=function(e,i,t){this._forEachRenderedGraphic((r=>{"object3d"===r.type&&r.alignWithAbsoluteElevation(e,i,t)}))},E.addObjectStateSet=function(e,i){this._forEachSymbolLayerGraphic((t=>t.addObjectState(e,i)))},E.removeObjectState=function(e){this._forEachSymbolLayerGraphic((i=>i.removeObjectState(e)))},E._forEachGraphicList=function(e,i){e.forEach((e=>e&&i(e)))},E._forEachSymbolLayerGraphic=function(e){this._forEachGraphicList(this.layers,e),this._forEachGraphicList(this._auxiliaryLayers,e)},E._forEachLabelGraphic=function(e){this._forEachGraphicList(this._labelLayers,e)},E._forEachRenderedGraphic=function(e){this._forEachSymbolLayerGraphic(e),this._forEachLabelGraphic(e)},e._createClass(n,[{key:"labelLayers",get:function(){return this._labelLayers}},{key:"extent",get:function(){return this._extent}},{key:"destroyed",get:function(){return null==this.layers}},{key:"isDraped",get:function(){let e=!1;return this._forEachSymbolLayerGraphic((i=>{"draped"===i.type&&(e=!0)})),e}},{key:"usedMemory",get:function(){let e=t.estimateAttributesObjectSize(this.graphic.attributes);return this._forEachSymbolLayerGraphic((i=>{const t=i.graphics3DSymbolLayer.complexity;if(r.isNone(t))return;const n="draped"===i.type?t.memory.draped:t.memory;e+=n.bytesPerFeature,n.bytesPerCoordinate&&(e+=d.numVertices(this.graphic.geometry)*n.bytesPerCoordinate)})),e}}]),n}();function G(e,i){const t=new Array(e);for(let r=0;r<t.length;r++)t[r]=new Array(i);return t}return E}));
