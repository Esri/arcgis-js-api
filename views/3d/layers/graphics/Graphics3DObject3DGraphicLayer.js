/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/support/aaBoundingBox","../../../../chunks/sphere","./elevationAlignmentUtils","./featureExpressionInfoUtils","./graphicUtils","../../webgl-engine/lib/basicInterfaces","../../webgl-engine/lib/edgeRendering/interfaces"],(function(e,t,i,s,n,a,r,o,c,l,h,g){"use strict";let d=function(e,t,i){this.baseMaterial=e,this.edgeMaterials=t,this.properties=i},u=function(){function e(e,t,i,s,n,a,r,o=null){this.graphics3DSymbolLayer=e,this.stageObject=t,this._uniqueGeometries=i,this._uniqueMaterials=s,this._sharedResource=n,this.elevationAligner=a,this.elevationContext=r,this._edgeState=o,this.type="object3d",this._stageLayer=null,this._stage=null,this._visible=!1,this._addedToStage=!1,this.alignedSampledElevation=0,this.needsElevationUpdates=!1,this.useObjectOriginAsAttachmentOrigin=!1}var g=e.prototype;return g.initialize=function(e,t){this._stageLayer=t,this._stage=e,e.addMany(this._uniqueMaterials),e.addMany(this._uniqueGeometries),e.add(this.stageObject)},g.destroy=function(){const e=this._stage;this._stageLayer&&(e.removeMany(this._uniqueMaterials),e.removeMany(this._uniqueGeometries)),e.remove(this.stageObject),this._addedToStage&&(this._stageLayer.remove(this.stageObject),this._addedToStage=!1);const t=this._stage.renderer.ensureEdgeView();t.hasObject(this.stageObject)&&t.removeObject(this.stageObject),this.stageObject.dispose(),i.isSome(this._sharedResource)&&this._sharedResource.release(),this._visible=!1,this._stageLayer=null,this._stage=null},g.layerOpacityChanged=function(e,t){if(i.isNone(this._edgeState))return;const s=b(this._edgeState.baseMaterial);let n=!1;for(const i of this._edgeState.edgeMaterials)i.objectTransparency!==s&&(i.objectTransparency=s,n=!0);n&&this._resetEdgeObject(t);this._stage.renderer.ensureEdgeView().updateAllComponentOpacities(this.stageObject,[e])},g.slicePlaneEnabledChanged=function(e,t){if(i.isNone(this._edgeState))return;this._stage.renderer.ensureEdgeView().updateAllComponentMaterials(this.stageObject,this._edgeState.edgeMaterials,{hasSlicePlane:e},!t),this._edgeState.properties.hasSlicePlane=e},g.setVisibility=function(e){if(null!=this._stage&&this._visible!==e&&(this._visible=e,this.stageObject.visible=e,this._visible&&!this._addedToStage&&(this._stageLayer.add(this.stageObject),this._addedToStage=!0),i.isSome(this._edgeState))){const t=this._stage.renderer.ensureEdgeView();t.hasObject(this.stageObject)?t.updateObjectVisibility(this.stageObject,e):e&&this._addOrUpdateEdgeObject(t,!1)}},g.alignWithElevation=function(e,t,s,n){if(null==this.elevationAligner)return;i.isSome(s)&&c.setContextFeature(this.elevationContext.featureExpressionInfoContext,s);const a=(i,s)=>o.evaluateElevationInfoAtPoint(i,e,this.elevationContext,t,s);this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,i.unwrap(e.spatialReference),a,t),this._resetEdgeObject(n)},g.alignWithAbsoluteElevation=function(e,t,i){const s=(t,i)=>{i.sampledElevation=e,i.verticalDistanceToGround=0,i.z=e};this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,null,s,t),this._resetEdgeObject(i)},g.getCenterObjectSpace=function(e=n.create()){return s.copy(e,r.getCenter(this.stageObject.boundingVolumeObjectSpace.bounds))},g.getBoundingBoxObjectSpace=function(e=a.create()){const t=this.stageObject.boundingVolumeObjectSpace;return a.setMin(e,t.min),a.setMax(e,t.max),e},g.computeAttachmentOrigin=function(e){if(this.useObjectOriginAsAttachmentOrigin){const t=this.stageObject.transformation;e.render.origin[0]+=t[12],e.render.origin[1]+=t[13],e.render.origin[2]+=t[14],e.render.num++}else for(const t of this.stageObject.geometries)t.computeAttachmentOrigin(j)&&(s.transformMat4(j,j,this.stageObject.transformation),s.add(e.render.origin,e.render.origin,j),e.render.num++)},g.getProjectedBoundingBox=function(){var e=t._asyncToGenerator((function*(e,t,n,r,o){const c=this.getBoundingBoxObjectSpace(o),h=f,g=a.isPoint(c)?1:h.length;for(let i=0;i<g;i++){const e=h[i];p[0]=c[e[0]],p[1]=c[e[1]],p[2]=c[e[2]],s.transformMat4(p,p,this.stageObject.transformation),O[3*i+0]=p[0],O[3*i+1]=p[1],O[3*i+2]=p[2]}if(!e(O,0,g))return null;a.empty(c);let d=null;this.calculateRelativeScreenBounds&&(d=this.calculateRelativeScreenBounds());for(let i=0;i<3*g;i+=3){for(let e=0;e<3;e++)c[e]=Math.min(c[e],O[i+e]),c[e+3]=Math.max(c[e+3],O[i+e]);d&&n.push({location:O.slice(i,i+3),screenSpaceBoundingRect:d})}if(t&&t.service&&"absolute-height"!==this.elevationContext.mode){a.center(c,j);const e="relative-to-scene"===this.elevationContext.mode?"scene":"ground";let s=0;if(t.useViewElevation)s=i.unwrapOr(t.service.getElevation(j[0],j[1],e),0);else try{const n=l.demResolutionForBoundingBox(c,t.service.spatialReference,t);s=i.unwrapOr(yield t.service.queryElevation(j[0],j[1],r,n,e),0)}catch(u){}a.offset(c,0,0,-this.alignedSampledElevation+s)}return c}));function n(t,i,s,n,a){return e.apply(this,arguments)}return n}(),g.addObjectState=function(e,t){e===h.Object3DState.Highlight&&t.addObject(this.stageObject,this.stageObject.highlight()),e===h.Object3DState.MaskOccludee&&t.addObject(this.stageObject,this.stageObject.maskOccludee())},g.removeObjectState=function(e){e.removeObject(this.stageObject)},g._resetEdgeObject=function(e){if(i.isNone(this._edgeState))return;const t=this._stage.renderer.ensureEdgeView();this._visible?this._addOrUpdateEdgeObject(t,e):t.removeObject(this.stageObject)},g._addOrUpdateEdgeObject=function(e,t){const s=this._edgeState;if(i.isNone(s))return;const n=b(s.baseMaterial);for(const i of s.edgeMaterials)i.objectTransparency=n;e.addOrUpdateObject3D(this.stageObject,s.edgeMaterials,s.properties,!t).then((()=>this._stageLayer?.sync()))},t._createClass(e,[{key:"isElevationSource",get:function(){return!(!this.stageObject.metadata||!this.stageObject.metadata.isElevationSource)}},{key:"visible",get:function(){return this._visible}}]),e}();function b(e){return e.isVisible()?e.parameters.transparent?g.Transparency.TRANSPARENT:g.Transparency.OPAQUE:g.Transparency.INVISIBLE}const O=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],p=n.create(),j=n.create(),f=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];e.Graphics3DObject3DGraphicLayer=u,e.Object3DEdgeState=d,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
