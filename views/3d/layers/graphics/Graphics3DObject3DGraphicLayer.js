// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../core/maybe","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../geometry/support/aaBoundingBox","./featureExpressionInfoUtils","./graphicUtils"],(function(e,t,i,s,a,n,r,o,c){"use strict";var u=function(){function e(t,i,s,a,n,r,o,c,u){this.uniqueGeometries=s,this.uniqueMaterials=a,this.uniqueTextures=n,this.elevationAligner=r,this.elevationContext=o,this._edgeState=c,this.type="object3d",this.stageLayer=null,this.stage=null,this._visible=!1,this._addedToStage=!1,this.alignedSampledElevation=0,this.needsElevationUpdates=!1,this.graphics3DSymbolLayer=t,this.stageObject=i,this.visibilityMode=null!=u?u:e.VisibilityModes.HIDE_FACERANGE}return Object.defineProperty(e.prototype,"isElevationSource",{get:function(){return!(!this.stageObject.metadata||!this.stageObject.metadata.isElevationSource)},enumerable:!1,configurable:!0}),e.prototype.initialize=function(e,t){if(this.stageLayer=t,this.stage=e,this.uniqueMaterials)for(var i=0;i<this.uniqueMaterials.length;i++)e.add(3,this.uniqueMaterials[i]);if(this.uniqueGeometries)for(i=0;i<this.uniqueGeometries.length;i++)e.add(2,this.uniqueGeometries[i]);if(this.uniqueTextures)for(i=0;i<this.uniqueTextures.length;i++)e.add(4,this.uniqueTextures[i]);e.add(1,this.stageObject)},e.prototype.layerOpacityChanged=function(e,t){if(!s.isNone(this._edgeState)){for(var i=h(this._edgeState.baseMaterial),a=!1,n=0,r=this._edgeState.edgeMaterials;n<r.length;n++){var o=r[n];o.objectTransparency!==i&&(o.objectTransparency=i,a=!0)}a&&this.resetEdgeObject(t),this.stage.renderView.ensureEdgeView().updateAllComponentOpacities(this.stageObject,[e])}},e.prototype.slicePlaneEnabledChanged=function(e,t){s.isNone(this._edgeState)||(this.stage.renderView.ensureEdgeView().updateAllComponentMaterials(this.stageObject,this._edgeState.edgeMaterials,{slicePlaneEnabled:e},!t),this._edgeState.slicePlaneEnabled=e)},e.prototype.setVisibility=function(t){if(null!=this.stage){if(this._visible===t)return!1;if(this._visible=t,this._visible?this._addedToStage?this.stageObject.setVisible(!0):(this.stageLayer.addObject(this.stageObject),this._addedToStage=!0):this.visibilityMode===e.VisibilityModes.HIDE_FACERANGE?this.stageObject.setVisible(!1):(this.stageLayer.removeObject(this.stageObject),this._addedToStage=!1),s.isSome(this._edgeState)){var i=this.stage.renderView.ensureEdgeView();i.hasObject(this.stageObject)?i.updateObjectVisibility(this.stageObject,t):t&&this.addOrUpdateEdgeObject(i,!1)}return!0}},Object.defineProperty(e.prototype,"visible",{get:function(){return this._visible},enumerable:!1,configurable:!0}),e.prototype.destroy=function(){var e=this.stage;if(this.stageLayer){if(this.uniqueMaterials)for(var t=0;t<this.uniqueMaterials.length;t++)e.remove(3,this.uniqueMaterials[t].id);if(this.uniqueGeometries)for(t=0;t<this.uniqueGeometries.length;t++)e.remove(2,this.uniqueGeometries[t].id);if(this.uniqueTextures)for(t=0;t<this.uniqueTextures.length;t++)e.remove(4,this.uniqueTextures[t].id)}e.remove(1,this.stageObject.id),this._addedToStage&&(this.stageLayer.removeObject(this.stageObject),this._addedToStage=!1);var i=this.stage.renderView.ensureEdgeView();i.hasObject(this.stageObject)&&i.removeObject(this.stageObject),this.stageObject.dispose(),this._visible=!1,this.stageLayer=null,this.stage=null},e.prototype.alignWithElevation=function(e,t,i,a){if(null!=this.elevationAligner){s.isSome(i)&&o.setContextFeature(this.elevationContext.featureExpressionInfoContext,i);var n=this.elevationAligner(this,this.elevationContext,e,t);null!=n&&(this.alignedSampledElevation=n),this.resetEdgeObject(a)}},e.prototype.getBSRadius=function(){return this.stageObject.getBSRadius()},e.prototype.getCenterObjectSpace=function(e){return void 0===e&&(e=n.vec3f64.create()),a.vec3.copy(e,this.stageObject.getCenter(!0))},e.prototype.getBoundingBoxObjectSpace=function(e){return void 0===e&&(e=r.create()),function(e,t,i){i||(i=r.create());return r.setMin(i,e.getBBMin(t)),r.setMax(i,e.getBBMax(t)),i}(this.stageObject,!0,e)},e.prototype.computeAttachmentOrigin=function(e){for(var t=0,i=this.stageObject.geometryRecords;t<i.length;t++){i[t].computeAttachmentOrigin(g)&&(a.vec3.transformMat4(g,g,this.stageObject.objectTransformation),a.vec3.add(e.render.origin,e.render.origin,g),e.render.num++)}},e.prototype.getProjectedBoundingBox=function(e,t,s,n,o){return i.__awaiter(this,void 0,void 0,(function(){var u,h,p,v,f,O,j,m,y,E;return i.__generator(this,(function(i){switch(i.label){case 0:for(u=this.getBoundingBoxObjectSpace(o),h=b,p=r.isPoint(u)?1:h.length,O=0;O<p;O++)v=h[O],d[0]=u[v[0]],d[1]=u[v[1]],d[2]=u[v[2]],a.vec3.transformMat4(d,d,this.stageObject.objectTransformation),l[3*O+0]=d[0],l[3*O+1]=d[1],l[3*O+2]=d[2];if(!e(l,0,p))return[2,null];for(r.empty(u),f=null,this.calculateRelativeScreenBounds&&(f=this.calculateRelativeScreenBounds()),O=0;O<3*p;O+=3){for(j=0;j<3;j++)u[j]=Math.min(u[j],l[O+j]),u[j+3]=Math.max(u[j+3],l[O+j]);f&&s.push({location:l.slice(O,O+3),screenSpaceBoundingRect:f})}return t&&t.service&&"absolute-height"!==this.elevationContext.mode?(r.center(u,g),m="relative-to-scene"===this.elevationContext.mode?"scene":"ground",y=void 0,t.useViewElevation?(y=t.service.getElevation(g[0],g[1],m),[3,4]):[3,1]):[3,5];case 1:return i.trys.push([1,3,,4]),E=c.demResolutionForBoundingBox(u,t),[4,t.service.queryElevation(g[0],g[1],n,E,m)];case 2:return y=i.sent(),[3,4];case 3:return i.sent(),y=null,[3,4];case 4:r.offset(u,0,0,-this.alignedSampledElevation+y),i.label=5;case 5:return[2,u]}}))}))},e.prototype.addObjectState=function(e,t){0===e&&t.addObject(this.stageObject,this.stageObject.highlight()),1===e&&t.addObject(this.stageObject,this.stageObject.occlude())},e.prototype.removeObjectState=function(e){e.removeObject(this.stageObject)},e.prototype.resetEdgeObject=function(e){if(!s.isNone(this._edgeState)){var t=this.stage.renderView.ensureEdgeView();this._visible?this.addOrUpdateEdgeObject(t,e):t.removeObject(this.stageObject)}},e.prototype.addOrUpdateEdgeObject=function(e,t){var i=this._edgeState;if(!s.isNone(i)){for(var a=h(i.baseMaterial),n=0,r=i.edgeMaterials;n<r.length;n++){r[n].objectTransparency=a}e.addOrUpdateObject(this.stageObject,i.edgeMaterials,{slicePlaneEnabled:i.slicePlaneEnabled},!t,i.addObjectSettings)}},e}();function h(e){return e.isVisible?e.getParameters().transparent?1:2:0}!function(e){!function(e){e[e.REMOVE_OBJECT=0]="REMOVE_OBJECT",e[e.HIDE_FACERANGE=1]="HIDE_FACERANGE"}(e.VisibilityModes||(e.VisibilityModes={}))}(u||(u={}));var l=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],d=n.vec3f64.create(),g=n.vec3f64.create(),b=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];return u}));