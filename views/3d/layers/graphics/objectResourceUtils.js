/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../core/maybe","../../../../chunks/vec3f64","../../../../chunks/vec3","../../../../chunks/mat4","../../../../core/devEnvironmentUtils","../../../../chunks/mat3f64","../../../../chunks/mat4f64","../../../../chunks/mat3","../../support/buffer/BufferView","../../../../chunks/vec32","../../../../geometry/support/aaBoundingBox","../../webgl-engine/lib/GeometryData","../../webgl-engine/lib/Geometry","../../webgl-engine/materials/DefaultMaterial","../../webgl-engine/lib/Texture","../../glTF/DefaultLoadingContext","../../../../chunks/vec22","../../../../chunks/vec33","../../../../chunks/vec43","../../support/buffer/utils","../../glTF/loader","../../glTF/internal/indexUtils","./wosrLoader","../../../../chunks/vec42"],(function(e,t,r,o,s,i,a,u,n,l,c,f,m,d,g,x,p,h,b,M,B,w,v,R,S){"use strict";function y(e){const t=e.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);if(t)return{fileType:"gltf",url:t[1],specifiedLodIndex:null!=t[4]?Number(t[4]):null};return e.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:e,specifiedLodIndex:null}:{fileType:"unknown",url:e,specifiedLodIndex:null}}function V(e,r,o,s){const i=e.model,u=a.create(),p=new Array,w=new Map,R=new Map;return i.lods.forEach(((e,a)=>{if(void 0!==s&&a!==s)return;let y=0;const V={name:e.name,stageResources:{textures:new Array,materials:new Array,geometries:new Array},lodThreshold:t.isSome(e.lodThreshold)?e.lodThreshold:null,pivotOffset:[0,0,0],numberOfVertices:0,boundingBox:f.empty()};p.push(V),e.parts.forEach((s=>{const a=s.material+(s.attributes.normal?"_normal":"")+(s.attributes.color?"_color":"")+(s.attributes.texCoord0?"_texCoord0":"")+(s.attributes.tangent?"_tangent":""),p=i.materials.get(s.material),O=t.isSome(s.attributes.texCoord0),T=t.isSome(s.attributes.normal);if(!w.has(a)){if(O){if(t.isSome(p.textureColor)&&!R.has(p.textureColor)){const e=i.textures.get(p.textureColor),t={...e.parameters,preMultiplyAlpha:!0};R.set(p.textureColor,new x(e.data,p.textureColor,t))}if(t.isSome(p.textureNormal)&&!R.has(p.textureNormal)){const e=i.textures.get(p.textureNormal),t={...e.parameters,preMultiplyAlpha:!0};R.set(p.textureNormal,new x(e.data,p.textureNormal,t))}if(t.isSome(p.textureOcclusion)&&!R.has(p.textureOcclusion)){const e=i.textures.get(p.textureOcclusion),t={...e.parameters,preMultiplyAlpha:!0};R.set(p.textureOcclusion,new x(e.data,p.textureOcclusion,t))}if(t.isSome(p.textureEmissive)&&!R.has(p.textureEmissive)){const e=i.textures.get(p.textureEmissive),t={...e.parameters,preMultiplyAlpha:!0};R.set(p.textureEmissive,new x(e.data,p.textureEmissive,t))}if(t.isSome(p.textureMetallicRoughness)&&!R.has(p.textureMetallicRoughness)){const e=i.textures.get(p.textureMetallicRoughness),t={...e.parameters,preMultiplyAlpha:!0};R.set(p.textureMetallicRoughness,new x(e.data,p.textureMetallicRoughness,t))}}const e=Math.pow(p.color[0],1/g.COLOR_GAMMA),u=Math.pow(p.color[1],1/g.COLOR_GAMMA),n=Math.pow(p.color[2],1/g.COLOR_GAMMA),l=Math.pow(p.emissiveFactor[0],1/g.COLOR_GAMMA),c=Math.pow(p.emissiveFactor[1],1/g.COLOR_GAMMA),f=Math.pow(p.emissiveFactor[2],1/g.COLOR_GAMMA);w.set(a,new g.DefaultMaterial({...r,transparent:"BLEND"===p.alphaMode,textureAlphaMode:C(p.alphaMode),textureAlphaCutoff:p.alphaCutoff,diffuse:[e,u,n],ambient:[e,u,n],opacity:p.opacity,doubleSided:p.doubleSided,doubleSidedType:"winding-order",cullFace:p.doubleSided?0:2,vertexColors:!!s.attributes.color,vertexTangents:!!s.attributes.tangent,normals:T?"default":"screenDerivative",castShadows:!0,receiveSSAO:!0,textureId:t.isSome(p.textureColor)&&O?R.get(p.textureColor).id:void 0,colorMixMode:p.colorMixMode,normalTextureId:t.isSome(p.textureNormal)&&O?R.get(p.textureNormal).id:void 0,textureAlphaPremultiplied:!0,occlusionTextureId:t.isSome(p.textureOcclusion)&&O?R.get(p.textureOcclusion).id:void 0,emissiveTextureId:t.isSome(p.textureEmissive)&&O?R.get(p.textureEmissive).id:void 0,metallicRoughnessTextureId:t.isSome(p.textureMetallicRoughness)&&O?R.get(p.textureMetallicRoughness).id:void 0,emissiveFactor:[l,c,f],mrrFactors:[p.metallicFactor,p.roughnessFactor,r.mrrFactors[2]],isSchematic:!1,...o},a))}const A=function(e,t){switch(t){case 4:return v.trianglesToTriangles(e);case 5:return v.triangleStripToTriangles(e);case 6:return v.triangleFanToTriangles(e)}}(s.indices||s.attributes.position.count,s.primitiveType),E={},L={},F=s.attributes.position.count,_=B.createBuffer(l.BufferViewVec3f,F);if(c.transformMat4(_,s.attributes.position,s.transform),L.position={data:_.typedBuffer,size:_.elementCount},E.position=A,t.isSome(s.attributes.normal)){const e=B.createBuffer(l.BufferViewVec3f,F);n.normalFromMat4(u,s.transform),c.transformMat3(e,s.attributes.normal,u),L.normal={data:e.typedBuffer,size:e.elementCount},E.normal=A}if(t.isSome(s.attributes.tangent)){const e=B.createBuffer(l.BufferViewVec4f,F);n.normalFromMat4(u,s.transform),S.transformMat3(e,s.attributes.tangent,u),L.tangent={data:e.typedBuffer,size:e.elementCount},E.tangent=A}if(t.isSome(s.attributes.texCoord0)){const e=B.createBuffer(l.BufferViewVec2f,F);h.normalizeIntegerBuffer(e,s.attributes.texCoord0),L.uv0={data:e.typedBuffer,size:e.elementCount},E.uv0=A}if(t.isSome(s.attributes.color)){const e=B.createBuffer(l.BufferViewVec4u8,F);if(4===s.attributes.color.elementCount)s.attributes.color instanceof l.BufferViewVec4f?S.scale(e,s.attributes.color,255):s.attributes.color instanceof l.BufferViewVec4u8?M.copy(e,s.attributes.color):s.attributes.color instanceof l.BufferViewVec4u16&&S.scale(e,s.attributes.color,1/256);else{M.fill(e,255,255,255,255);const t=new l.BufferViewVec3u8(e.buffer,0,4);s.attributes.color instanceof l.BufferViewVec3f?c.scale(t,s.attributes.color,255):s.attributes.color instanceof l.BufferViewVec3u8?b.copy(t,s.attributes.color):s.attributes.color instanceof l.BufferViewVec3u16&&c.scale(t,s.attributes.color,1/256)}L.color={data:e.typedBuffer,size:e.elementCount},E.color=A}const I=new d(new m.GeometryData(L,E),`gltf_${e.name}_${y++}`);V.stageResources.geometries.push(I),V.stageResources.materials.push(w.get(a)),O&&(t.isSome(p.textureColor)&&V.stageResources.textures.push(R.get(p.textureColor)),t.isSome(p.textureNormal)&&V.stageResources.textures.push(R.get(p.textureNormal)),t.isSome(p.textureOcclusion)&&V.stageResources.textures.push(R.get(p.textureOcclusion)),t.isSome(p.textureEmissive)&&V.stageResources.textures.push(R.get(p.textureEmissive)),t.isSome(p.textureMetallicRoughness)&&V.stageResources.textures.push(R.get(p.textureMetallicRoughness))),V.numberOfVertices+=F;const N=I.boundingInfo;f.expandWithVec3(V.boundingBox,N.getBBMin()),f.expandWithVec3(V.boundingBox,N.getBBMax())}))})),p}function C(e){switch(e){case"BLEND":return 0;case"MASK":return 2;case"OPAQUE":return 1;default:return 0}}e.fetch=async function(e,a){const n=y(i.adjustStaticAGOUrl(e));if("wosr"===n.fileType){const e=await(a.cache?a.cache.loadWOSR(n.url,a):R.load(n.url,a)),t=R.processLoadResult(e,a);return{lods:[t],referenceBoundingBox:t.boundingBox,isEsriSymbolResource:!1,isWosr:!0,remove:e.remove}}const c=await(a.cache?a.cache.loadGLTF(n.url,a):w.load(new p.DefaultLoadingContext(a.streamDataRequester),n.url,a)),f=t.get(c.model.meta,"ESRI_proxyEllipsoid");c.meta.isEsriSymbolResource&&t.isSome(f)&&-1!==c.meta.uri.indexOf("/RealisticTrees/")&&function(e,i){for(let a=0;a<e.model.lods.length;++a){const n=e.model.lods[a];e.customMeta.esriTreeRendering=!0;for(const c of n.parts){const n=c.attributes.normal;if(t.isNone(n))return;const f=c.attributes.position,m=f.count,d=r.create(),g=r.create(),x=r.create(),p=B.createBuffer(l.BufferViewVec4u8,m),h=B.createBuffer(l.BufferViewVec3f,m),b=s.invert(u.create(),c.transform);for(let t=0;t<m;t++){f.getVec(t,g),n.getVec(t,d),o.transformMat4(g,g,c.transform),o.subtract(x,g,i.center),o.divide(x,x,i.radius);const r=x[2],s=o.length(x),u=Math.min(.45+.55*s*s,1);o.divide(x,x,i.radius),o.transformMat4(x,x,b),o.normalize(x,x),a+1!==e.model.lods.length&&e.model.lods.length>1&&(r>-1?o.lerp(x,x,d,.2):o.lerp(x,x,d,Math.min(-4*r-3.8,1))),h.setVec(t,x),p.set(t,0,255*u),p.set(t,1,255*u),p.set(t,2,255*u),p.set(t,3,255)}c.attributes.normal=h,c.attributes.color=p}}}(c,f);const m=c.meta.isEsriSymbolResource?{usePBR:a.usePBR,isSchematic:!1,treeRendering:c.customMeta.esriTreeRendering,mrrFactors:[0,1,.2]}:{usePBR:!0,isSchematic:!1,mrrFactors:[0,1,.5]},d={...a.materialParamsMixin,treeRendering:c.customMeta.esriTreeRendering};if(null!=n.specifiedLodIndex){const e=V(c,m,d,n.specifiedLodIndex);let t=e[0].boundingBox;if(0!==n.specifiedLodIndex){t=V(c,m,d,0)[0].boundingBox}return{lods:e,referenceBoundingBox:t,isEsriSymbolResource:c.meta.isEsriSymbolResource,isWosr:!1,remove:c.remove}}const g=V(c,m,d);return{lods:g,referenceBoundingBox:g[0].boundingBox,isEsriSymbolResource:c.meta.isEsriSymbolResource,isWosr:!1,remove:c.remove}},e.gltfToEngineResources=V,e.parseUrl=y,Object.defineProperty(e,"__esModule",{value:!0})}));
