// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../core/devEnvironmentUtils","../../../../core/maybe","../../../../core/libs/gl-matrix-2/mat3","../../../../core/libs/gl-matrix-2/mat3f64","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../geometry/support/aaBoundingBox","../../glTF/DefaultLoadingContext","../../glTF/loader","../../glTF/internal/indexUtils","./wosrLoader","../../support/buffer/BufferView","../../support/buffer/math","../../support/buffer/utils","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryData","../../webgl-engine/lib/Texture","../../webgl-engine/materials/DefaultMaterial"],(function(e,t,r,s,o,i,a,u,n,l,c,m,f,d,g,x,p,v,b,h,B,w,M){function S(e){var t=e.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return t?{fileType:"gltf",url:t[1],specifiedLodIndex:null!=t[4]?Number(t[4]):null}:e.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:e,specifiedLodIndex:null}:{fileType:"unknown",url:e,specifiedLodIndex:null}}function _(e,t,s,u){var n=e.model,l=a.mat3f64.create(),c=new Array,f=new Map,d=new Map;return n.lods.forEach((function(e,a){if(void 0===u||a===u){var x=0,S={name:e.name,stageResources:{textures:new Array,materials:new Array,geometries:new Array},lodThreshold:o.isSome(e.lodThreshold)?e.lodThreshold:null,pivotOffset:[0,0,0],numberOfVertices:0,boundingBox:m.empty()};c.push(S),e.parts.forEach((function(a){var u=a.material+(a.attributes.normal?"_normal":"")+(a.attributes.color?"_color":"")+(a.attributes.texCoord0?"_texCoord0":"")+(a.attributes.tangent?"_tangent":""),c=n.materials.get(a.material),_=o.isSome(a.attributes.texCoord0),y=o.isSome(a.attributes.normal);if(!f.has(u)){if(_){if(o.isSome(c.textureColor)&&!d.has(c.textureColor)){var V=n.textures.get(c.textureColor),T=r.__assign(r.__assign({},V.parameters),{preMultiplyAlpha:!0});d.set(c.textureColor,new w(V.data,c.textureColor,T))}if(o.isSome(c.textureNormal)&&!d.has(c.textureNormal)){V=n.textures.get(c.textureNormal),T=r.__assign(r.__assign({},V.parameters),{preMultiplyAlpha:!0});d.set(c.textureNormal,new w(V.data,c.textureNormal,T))}if(o.isSome(c.textureOcclusion)&&!d.has(c.textureOcclusion)){V=n.textures.get(c.textureOcclusion),T=r.__assign(r.__assign({},V.parameters),{preMultiplyAlpha:!0});d.set(c.textureOcclusion,new w(V.data,c.textureOcclusion,T))}if(o.isSome(c.textureEmissive)&&!d.has(c.textureEmissive)){V=n.textures.get(c.textureEmissive),T=r.__assign(r.__assign({},V.parameters),{preMultiplyAlpha:!0});d.set(c.textureEmissive,new w(V.data,c.textureEmissive,T))}if(o.isSome(c.textureMetallicRoughness)&&!d.has(c.textureMetallicRoughness)){V=n.textures.get(c.textureMetallicRoughness),T=r.__assign(r.__assign({},V.parameters),{preMultiplyAlpha:!0});d.set(c.textureMetallicRoughness,new w(V.data,c.textureMetallicRoughness,T))}}var C=M.COLOR_GAMMA,E=Math.pow(c.color[0],1/C),O=Math.pow(c.color[1],1/C),A=Math.pow(c.color[2],1/C),F=Math.pow(c.emissiveFactor[0],1/C),I=Math.pow(c.emissiveFactor[1],1/C),L=Math.pow(c.emissiveFactor[2],1/C);f.set(u,new M(r.__assign(r.__assign(r.__assign({},t),{transparent:"BLEND"===c.alphaMode,textureAlphaMode:R(c.alphaMode),textureAlphaCutoff:c.alphaCutoff,diffuse:[E,O,A],ambient:[E,O,A],opacity:c.opacity,doubleSided:c.doubleSided,doubleSidedType:"winding-order",cullFace:c.doubleSided?0:2,vertexColors:!!a.attributes.color,vertexTangents:!!a.attributes.tangent,normals:y?"default":"screenDerivative",castShadows:!0,receiveSSAO:!0,textureId:o.isSome(c.textureColor)&&_?d.get(c.textureColor).id:void 0,colorMixMode:c.colorMixMode,normalTextureId:o.isSome(c.textureNormal)&&_?d.get(c.textureNormal).id:void 0,textureAlphaPremultiplied:!0,occlusionTextureId:o.isSome(c.textureOcclusion)&&_?d.get(c.textureOcclusion).id:void 0,emissiveTextureId:o.isSome(c.textureEmissive)&&_?d.get(c.textureEmissive).id:void 0,metallicRoughnessTextureId:o.isSome(c.textureMetallicRoughness)&&_?d.get(c.textureMetallicRoughness).id:void 0,emissiveFactor:[F,I,L],mrrFactors:[c.metallicFactor,c.roughnessFactor,t.mrrFactors[2]],isSchematic:!1}),s),u))}var N=function(e,t){switch(t){case 4:return g.trianglesToTriangles(e);case 5:return g.triangleStripToTriangles(e);case 6:return g.triangleFanToTriangles(e)}}(a.indices||a.attributes.position.count,a.primitiveType),D={},z={},P=a.attributes.position.count,G=b.createBuffer(p.BufferViewVec3f,P);if(v.vec3.transformMat4(G,a.attributes.position,a.transform),z.position={data:G.typedBuffer,size:G.elementCount},D.position=N,o.isSome(a.attributes.normal)){var U=b.createBuffer(p.BufferViewVec3f,P);i.mat3.normalFromMat4(l,a.transform),v.vec3.transformMat3(U,a.attributes.normal,l),z.normal={data:U.typedBuffer,size:U.elementCount},D.normal=N}if(o.isSome(a.attributes.tangent)){var j=b.createBuffer(p.BufferViewVec4f,P);i.mat3.normalFromMat4(l,a.transform),v.vec4.transformMat3(j,a.attributes.tangent,l),z.tangent={data:j.typedBuffer,size:j.elementCount},D.tangent=N}if(o.isSome(a.attributes.texCoord0)){var W=b.createBuffer(p.BufferViewVec2f,P);b.vec2.normalizeIntegerBuffer(W,a.attributes.texCoord0),z.uv0={data:W.typedBuffer,size:W.elementCount},D.uv0=N}if(o.isSome(a.attributes.color)){var q=b.createBuffer(p.BufferViewVec4u8,P);if(4===a.attributes.color.elementCount)a.attributes.color instanceof p.BufferViewVec4f?v.vec4.scale(q,a.attributes.color,255):a.attributes.color instanceof p.BufferViewVec4u8?b.vec4.copy(q,a.attributes.color):a.attributes.color instanceof p.BufferViewVec4u16&&v.vec4.scale(q,a.attributes.color,1/256);else{b.vec4.fill(q,255,255,255,255);var $=new p.BufferViewVec3u8(q.buffer,0,4);a.attributes.color instanceof p.BufferViewVec3f?v.vec3.scale($,a.attributes.color,255):a.attributes.color instanceof p.BufferViewVec3u8?b.vec3.copy($,a.attributes.color):a.attributes.color instanceof p.BufferViewVec3u16&&v.vec3.scale($,a.attributes.color,1/256)}z.color={data:q.typedBuffer,size:q.elementCount},D.color=N}var k=new h(new B.GeometryData(z,D),"gltf_"+e.name+"_"+x++);S.stageResources.geometries.push(k),S.stageResources.materials.push(f.get(u)),_&&(o.isSome(c.textureColor)&&S.stageResources.textures.push(d.get(c.textureColor)),o.isSome(c.textureNormal)&&S.stageResources.textures.push(d.get(c.textureNormal)),o.isSome(c.textureOcclusion)&&S.stageResources.textures.push(d.get(c.textureOcclusion)),o.isSome(c.textureEmissive)&&S.stageResources.textures.push(d.get(c.textureEmissive)),o.isSome(c.textureMetallicRoughness)&&S.stageResources.textures.push(d.get(c.textureMetallicRoughness))),S.numberOfVertices+=P;var K=k.boundingInfo;m.expand(S.boundingBox,K.getBBMin()),m.expand(S.boundingBox,K.getBBMax())}))}})),c}function R(e){switch(e){case"BLEND":return 0;case"MASK":return 2;case"OPAQUE":return 1;default:return 0}}Object.defineProperty(t,"__esModule",{value:!0}),t.fetch=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var i,a,m,g,v,h,B,w,M,R,y,V;return r.__generator(this,(function(T){switch(T.label){case 0:return"wosr"!==(i=S(s.adjustStaticAGOUrl(e))).fileType?[3,2]:[4,t.cache?t.cache.loadWOSR(i.url,t):x.load(i.url,t)];case 1:return a=T.sent(),[2,{lods:[m=x.processLoadResult(a,t)],referenceBoundingBox:m.boundingBox,isEsriSymbolResource:!1,isWosr:!0,remove:a.remove}];case 2:return[4,t.cache?t.cache.loadGLTF(i.url,t):d.load(new f.DefaultLoadingContext(t.streamDataRequester),i.url,t)];case 3:return g=T.sent(),v=o.get(g.model.meta,"ESRI_proxyEllipsoid"),g.meta.isEsriSymbolResource&&o.isSome(v)&&-1!==g.meta.uri.indexOf("/RealisticTrees/")&&function(e,t){for(var r=0;r<e.model.lods.length;++r){var s=e.model.lods[r];e.customMeta.esriTreeRendering=!0;for(var i=0,a=s.parts;i<a.length;i++){var m=a[i],f=m.attributes.normal;if(o.isNone(f))return;for(var d=m.attributes.position,g=d.count,x=c.vec3f64.create(),v=c.vec3f64.create(),h=c.vec3f64.create(),B=b.createBuffer(p.BufferViewVec4u8,g),w=b.createBuffer(p.BufferViewVec3f,g),M=u.mat4.invert(n.mat4f64.create(),m.transform),S=0;S<g;S++){d.getVec(S,v),f.getVec(S,x),l.vec3.transformMat4(v,v,m.transform),l.vec3.subtract(h,v,t.center),l.vec3.divide(h,h,t.radius);var _=h[2],R=l.vec3.length(h),y=Math.min(.45+.55*R*R,1);l.vec3.divide(h,h,t.radius),l.vec3.transformMat4(h,h,M),l.vec3.normalize(h,h),r+1!==e.model.lods.length&&e.model.lods.length>1&&(_>-1?l.vec3.lerp(h,h,x,.2):l.vec3.lerp(h,h,x,Math.min(-4*_-3.8,1))),w.setVec(S,h),B.set(S,0,255*y),B.set(S,1,255*y),B.set(S,2,255*y),B.set(S,3,255)}m.attributes.normal=w,m.attributes.color=B}}}(g,v),h=g.meta.isEsriSymbolResource?{usePBR:t.usePBR,isSchematic:!1,treeRendering:g.customMeta.esriTreeRendering,mrrFactors:[0,1,.2]}:{usePBR:!0,isSchematic:!1,mrrFactors:[0,1,.5]},B=r.__assign(r.__assign({},t.materialParamsMixin),{treeRendering:g.customMeta.esriTreeRendering}),null!=i.specifiedLodIndex?(w=_(g,h,B,i.specifiedLodIndex),M=w[0].boundingBox,0!==i.specifiedLodIndex&&(R=_(g,h,B,0),M=R[0].boundingBox),[2,{lods:w,referenceBoundingBox:M,isEsriSymbolResource:g.meta.isEsriSymbolResource,isWosr:!1,remove:g.remove}]):(y=_(g,h,B),V=y[0].boundingBox,[2,{lods:y,referenceBoundingBox:V,isEsriSymbolResource:g.meta.isEsriSymbolResource,isWosr:!1,remove:g.remove}])}}))}))},t.parseUrl=S,t.gltfToEngineResources=_}));