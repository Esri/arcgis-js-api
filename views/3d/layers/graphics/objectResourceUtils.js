/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/devEnvironmentUtils","../../../../core/maybe","../../../../chunks/mat3","../../../../chunks/mat3f64","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/buffer/BufferView","../../../../chunks/vec32","../../../../chunks/vec42","../../../../geometry/support/buffer/utils","../../glTF/DefaultLoadingContext","../../glTF/loader","../../glTF/internal/indexUtils","./wosrLoader","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/Texture","../../webgl-engine/materials/DefaultMaterial","../../webgl-engine/materials/DefaultMaterial_COLOR_GAMMA","../../../../chunks/vec22","../../../../chunks/vec43","../../../../chunks/vec33"],(function(e,t,r,s,o,i,u,a,n,l,c,f,m,d,x,g,p,h,b,B,M,v,R,S,y,w){"use strict";function T(e,t){return V.apply(this,arguments)}function V(){return(V=t._asyncToGenerator((function*(e,t){const o=C(r.adjustStaticAGOUrl(e));if("wosr"===o.fileType){const e=yield t.cache?t.cache.loadWOSR(o.url,t):b.load(o.url,t),r=b.processLoadResult(e,t);return{lods:[r],referenceBoundingBox:r.boundingBox,isEsriSymbolResource:!1,isWosr:!0,remove:e.remove}}const i=yield t.cache?t.cache.loadGLTF(o.url,t,t.usePBR):p.load(new g.DefaultLoadingContext(t.streamDataRequester),o.url,t,t.usePBR),u=s.get(i.model.meta,"ESRI_proxyEllipsoid");i.meta.isEsriSymbolResource&&s.isSome(u)&&-1!==i.meta.uri.indexOf("/RealisticTrees/")&&L(i,u);const a=i.meta.isEsriSymbolResource?{usePBR:t.usePBR,isSchematic:!1,treeRendering:i.customMeta.esriTreeRendering,mrrFactors:[0,1,.2]}:{usePBR:t.usePBR,isSchematic:!1,mrrFactors:[0,1,.5]},n={...t.materialParamsMixin,treeRendering:i.customMeta.esriTreeRendering};if(null!=o.specifiedLodIndex){const e=O(i,a,n,o.specifiedLodIndex);let t=e[0].boundingBox;if(0!==o.specifiedLodIndex){t=O(i,a,n,0)[0].boundingBox}return{lods:e,referenceBoundingBox:t,isEsriSymbolResource:i.meta.isEsriSymbolResource,isWosr:!1,remove:i.remove}}const l=O(i,a,n);return{lods:l,referenceBoundingBox:l[0].boundingBox,isEsriSymbolResource:i.meta.isEsriSymbolResource,isWosr:!1,remove:i.remove}}))).apply(this,arguments)}function C(e){const t=e.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);if(t)return{fileType:"gltf",url:t[1],specifiedLodIndex:null!=t[4]?Number(t[4]):null};return e.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:e,specifiedLodIndex:null}:{fileType:"unknown",url:e,specifiedLodIndex:null}}function O(e,t,r,u){const a=e.model,n=i.create(),l=new Array,g=new Map,p=new Map;return a.lods.forEach(((e,i)=>{if(void 0!==u&&i!==u)return;const h={name:e.name,stageResources:{textures:new Array,materials:new Array,geometries:new Array},lodThreshold:s.isSome(e.lodThreshold)?e.lodThreshold:null,pivotOffset:[0,0,0],numberOfVertices:0,boundingBox:c.empty()};l.push(h),e.parts.forEach((e=>{const i=e.material+(e.attributes.normal?"_normal":"")+(e.attributes.color?"_color":"")+(e.attributes.texCoord0?"_texCoord0":"")+(e.attributes.tangent?"_tangent":""),u=a.materials.get(e.material),l=s.isSome(e.attributes.texCoord0),b=s.isSome(e.attributes.normal);if(!g.has(i)){if(l){if(s.isSome(u.textureColor)&&!p.has(u.textureColor)){const e=a.textures.get(u.textureColor),t={...e.parameters,preMultiplyAlpha:!0};p.set(u.textureColor,new M.Texture(e.data,t))}if(s.isSome(u.textureNormal)&&!p.has(u.textureNormal)){const e=a.textures.get(u.textureNormal),t={...e.parameters,preMultiplyAlpha:!0};p.set(u.textureNormal,new M.Texture(e.data,t))}if(s.isSome(u.textureOcclusion)&&!p.has(u.textureOcclusion)){const e=a.textures.get(u.textureOcclusion),t={...e.parameters,preMultiplyAlpha:!0};p.set(u.textureOcclusion,new M.Texture(e.data,t))}if(s.isSome(u.textureEmissive)&&!p.has(u.textureEmissive)){const e=a.textures.get(u.textureEmissive),t={...e.parameters,preMultiplyAlpha:!0};p.set(u.textureEmissive,new M.Texture(e.data,t))}if(s.isSome(u.textureMetallicRoughness)&&!p.has(u.textureMetallicRoughness)){const e=a.textures.get(u.textureMetallicRoughness),t={...e.parameters,preMultiplyAlpha:!0};p.set(u.textureMetallicRoughness,new M.Texture(e.data,t))}}const o=u.color[0]**(1/R.COLOR_GAMMA),n=u.color[1]**(1/R.COLOR_GAMMA),c=u.color[2]**(1/R.COLOR_GAMMA),f=u.emissiveFactor[0]**(1/R.COLOR_GAMMA),m=u.emissiveFactor[1]**(1/R.COLOR_GAMMA),d=u.emissiveFactor[2]**(1/R.COLOR_GAMMA);g.set(i,new v.DefaultMaterial({...t,transparent:"BLEND"===u.alphaMode,textureAlphaMode:A(u.alphaMode),textureAlphaCutoff:u.alphaCutoff,diffuse:[o,n,c],ambient:[o,n,c],opacity:u.opacity,doubleSided:u.doubleSided,doubleSidedType:"winding-order",cullFace:u.doubleSided?0:2,vertexColors:!!e.attributes.color,vertexTangents:!!e.attributes.tangent,normals:b?"default":"screenDerivative",castShadows:!0,receiveSSAO:!0,textureId:s.isSome(u.textureColor)&&l?p.get(u.textureColor).id:void 0,colorMixMode:u.colorMixMode,normalTextureId:s.isSome(u.textureNormal)&&l?p.get(u.textureNormal).id:void 0,textureAlphaPremultiplied:!0,occlusionTextureId:s.isSome(u.textureOcclusion)&&l?p.get(u.textureOcclusion).id:void 0,emissiveTextureId:s.isSome(u.textureEmissive)&&l?p.get(u.textureEmissive).id:void 0,metallicRoughnessTextureId:s.isSome(u.textureMetallicRoughness)&&l?p.get(u.textureMetallicRoughness).id:void 0,emissiveFactor:[f,m,d],mrrFactors:[u.metallicFactor,u.roughnessFactor,t.mrrFactors[2]],isSchematic:!1,...r}))}const T=E(e.indices||e.attributes.position.count,e.primitiveType),V=e.attributes.position.count,C=x.createBuffer(f.BufferViewVec3f,V);m.transformMat4(C,e.attributes.position,e.transform);const O=[["position",{data:C.typedBuffer,size:C.elementCount,exclusive:!0}]],L=[["position",T]];if(s.isSome(e.attributes.normal)){const t=x.createBuffer(f.BufferViewVec3f,V);o.normalFromMat4(n,e.transform),m.transformMat3(t,e.attributes.normal,n),O.push(["normal",{data:t.typedBuffer,size:t.elementCount,exclusive:!0}]),L.push(["normal",T])}if(s.isSome(e.attributes.tangent)){const t=x.createBuffer(f.BufferViewVec4f,V);o.normalFromMat4(n,e.transform),d.transformMat3(t,e.attributes.tangent,n),O.push(["tangent",{data:t.typedBuffer,size:t.elementCount,exclusive:!0}]),L.push(["tangent",T])}if(s.isSome(e.attributes.texCoord0)){const t=x.createBuffer(f.BufferViewVec2f,V);S.normalizeIntegerBuffer(t,e.attributes.texCoord0),O.push(["uv0",{data:t.typedBuffer,size:t.elementCount,exclusive:!0}]),L.push(["uv0",T])}if(s.isSome(e.attributes.color)){const t=x.createBuffer(f.BufferViewVec4u8,V);if(4===e.attributes.color.elementCount)e.attributes.color instanceof f.BufferViewVec4f?d.scale(t,e.attributes.color,255):e.attributes.color instanceof f.BufferViewVec4u8?y.copy(t,e.attributes.color):e.attributes.color instanceof f.BufferViewVec4u16&&d.scale(t,e.attributes.color,1/256);else{y.fill(t,255,255,255,255);const r=new f.BufferViewVec3u8(t.buffer,0,4);e.attributes.color instanceof f.BufferViewVec3f?m.scale(r,e.attributes.color,255):e.attributes.color instanceof f.BufferViewVec3u8?w.copy(r,e.attributes.color):e.attributes.color instanceof f.BufferViewVec3u16&&m.scale(r,e.attributes.color,1/256)}O.push(["color",{data:t.typedBuffer,size:t.elementCount,exclusive:!0}]),L.push(["color",T])}const F=new B.Geometry(O,L);h.stageResources.geometries.push(F),h.stageResources.materials.push(g.get(i)),l&&(s.isSome(u.textureColor)&&h.stageResources.textures.push(p.get(u.textureColor)),s.isSome(u.textureNormal)&&h.stageResources.textures.push(p.get(u.textureNormal)),s.isSome(u.textureOcclusion)&&h.stageResources.textures.push(p.get(u.textureOcclusion)),s.isSome(u.textureEmissive)&&h.stageResources.textures.push(p.get(u.textureEmissive)),s.isSome(u.textureMetallicRoughness)&&h.stageResources.textures.push(p.get(u.textureMetallicRoughness))),h.numberOfVertices+=V;const _=F.boundingInfo;s.isSome(_)&&(c.expandWithVec3(h.boundingBox,_.getBBMin()),c.expandWithVec3(h.boundingBox,_.getBBMax()))}))})),l}function A(e){switch(e){case"BLEND":return 0;case"MASK":return 2;case"OPAQUE":return 1;default:return 0}}function E(e,t){switch(t){case 4:return h.trianglesToTriangles(e);case 5:return h.triangleStripToTriangles(e);case 6:return h.triangleFanToTriangles(e)}}function L(e,t){for(let r=0;r<e.model.lods.length;++r){const o=e.model.lods[r];e.customMeta.esriTreeRendering=!0;for(const i of o.parts){const o=i.attributes.normal;if(s.isNone(o))return;const c=i.attributes.position,m=c.count,d=l.create(),g=l.create(),p=l.create(),h=x.createBuffer(f.BufferViewVec4u8,m),b=x.createBuffer(f.BufferViewVec3f,m),B=u.invert(a.create(),i.transform);for(let s=0;s<m;s++){c.getVec(s,g),o.getVec(s,d),n.transformMat4(g,g,i.transform),n.subtract(p,g,t.center),n.divide(p,p,t.radius);const u=p[2],a=n.length(p),l=Math.min(.45+.55*a*a,1);n.divide(p,p,t.radius),n.transformMat4(p,p,B),n.normalize(p,p),r+1!==e.model.lods.length&&e.model.lods.length>1&&(u>-1?n.lerp(p,p,d,.2):n.lerp(p,p,d,Math.min(-4*u-3.8,1))),b.setVec(s,p),h.set(s,0,255*l),h.set(s,1,255*l),h.set(s,2,255*l),h.set(s,3,255)}i.attributes.normal=b,i.attributes.color=h}}}e.fetch=T,e.gltfToEngineResources=O,e.parseUrl=C,Object.defineProperty(e,"__esModule",{value:!0})}));
