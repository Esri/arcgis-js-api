/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/devEnvironmentUtils","../../../../core/maybe","../../../../chunks/mat3","../../../../chunks/mat3f64","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/buffer/BufferView","../../../../chunks/vec32","../../../../chunks/vec42","../../../../geometry/support/buffer/utils","../../glTF/DefaultLoadingContext","../../glTF/loader","../../glTF/internal/indexUtils","./wosrLoader","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/Texture","../../webgl-engine/materials/DefaultMaterial","../../webgl-engine/materials/DefaultMaterial_COLOR_GAMMA","../../../../chunks/vec22","../../../../chunks/vec43","../../../../chunks/vec33"],(function(e,t,r,s,o,i,u,a,n,c,l,f,m,d,x,g,p,h,b,B,v,M,R,S,w,y){"use strict";function T(e,t){return V.apply(this,arguments)}function V(){return(V=t._asyncToGenerator((function*(e,t){const o=C(r.adjustStaticAGOUrl(e));if("wosr"===o.fileType){const e=yield t.cache?t.cache.loadWOSR(o.url,t):b.load(o.url,t),r=b.processLoadResult(e,t);return{lods:[r],referenceBoundingBox:r.boundingBox,isEsriSymbolResource:!1,isWosr:!0,remove:e.remove}}const i=yield t.cache?t.cache.loadGLTF(o.url,t,t.usePBR):p.load(new g.DefaultLoadingContext(t.streamDataRequester),o.url,t,t.usePBR),u=s.get(i.model.meta,"ESRI_proxyEllipsoid");i.meta.isEsriSymbolResource&&s.isSome(u)&&-1!==i.meta.uri.indexOf("/RealisticTrees/")&&L(i,u);const a=i.meta.isEsriSymbolResource?{usePBR:t.usePBR,isSchematic:!1,treeRendering:i.customMeta.esriTreeRendering,mrrFactors:[0,1,.2]}:{usePBR:t.usePBR,isSchematic:!1,mrrFactors:[0,1,.5]},n={...t.materialParamsMixin,treeRendering:i.customMeta.esriTreeRendering};if(null!=o.specifiedLodIndex){const e=O(i,a,n,o.specifiedLodIndex);let t=e[0].boundingBox;if(0!==o.specifiedLodIndex){t=O(i,a,n,0)[0].boundingBox}return{lods:e,referenceBoundingBox:t,isEsriSymbolResource:i.meta.isEsriSymbolResource,isWosr:!1,remove:i.remove}}const c=O(i,a,n);return{lods:c,referenceBoundingBox:c[0].boundingBox,isEsriSymbolResource:i.meta.isEsriSymbolResource,isWosr:!1,remove:i.remove}}))).apply(this,arguments)}function C(e){const t=e.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);if(t)return{fileType:"gltf",url:t[1],specifiedLodIndex:null!=t[4]?Number(t[4]):null};return e.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:e,specifiedLodIndex:null}:{fileType:"unknown",url:e,specifiedLodIndex:null}}function O(e,t,r,u){const a=e.model,n=i.create(),c=new Array,g=new Map,p=new Map;return a.lods.forEach(((e,i)=>{if(void 0!==u&&i!==u)return;const h={name:e.name,stageResources:{textures:new Array,materials:new Array,geometries:new Array},lodThreshold:s.isSome(e.lodThreshold)?e.lodThreshold:null,pivotOffset:[0,0,0],numberOfVertices:0,boundingBox:l.empty()};c.push(h),e.parts.forEach((e=>{const i=e.material+(e.attributes.normal?"_normal":"")+(e.attributes.color?"_color":"")+(e.attributes.texCoord0?"_texCoord0":"")+(e.attributes.tangent?"_tangent":""),u=a.materials.get(e.material),c=s.isSome(e.attributes.texCoord0),b=s.isSome(e.attributes.normal),T=A(u.alphaMode);if(!g.has(i)){if(c){if(s.isSome(u.textureColor)&&!p.has(u.textureColor)){const e=a.textures.get(u.textureColor),t={...e.parameters,preMultiplyAlpha:1!==T};p.set(u.textureColor,new v.Texture(e.data,t))}if(s.isSome(u.textureNormal)&&!p.has(u.textureNormal)){const e=a.textures.get(u.textureNormal);p.set(u.textureNormal,new v.Texture(e.data,e.parameters))}if(s.isSome(u.textureOcclusion)&&!p.has(u.textureOcclusion)){const e=a.textures.get(u.textureOcclusion);p.set(u.textureOcclusion,new v.Texture(e.data,e.parameters))}if(s.isSome(u.textureEmissive)&&!p.has(u.textureEmissive)){const e=a.textures.get(u.textureEmissive);p.set(u.textureEmissive,new v.Texture(e.data,e.parameters))}if(s.isSome(u.textureMetallicRoughness)&&!p.has(u.textureMetallicRoughness)){const e=a.textures.get(u.textureMetallicRoughness);p.set(u.textureMetallicRoughness,new v.Texture(e.data,e.parameters))}}const o=u.color[0]**(1/R.COLOR_GAMMA),n=u.color[1]**(1/R.COLOR_GAMMA),l=u.color[2]**(1/R.COLOR_GAMMA),f=u.emissiveFactor[0]**(1/R.COLOR_GAMMA),m=u.emissiveFactor[1]**(1/R.COLOR_GAMMA),d=u.emissiveFactor[2]**(1/R.COLOR_GAMMA),x=s.isSome(u.textureColor)&&c?p.get(u.textureColor):null;g.set(i,new M.DefaultMaterial({...t,transparent:0===T,textureAlphaMode:T,textureAlphaCutoff:u.alphaCutoff,diffuse:[o,n,l],ambient:[o,n,l],opacity:u.opacity,doubleSided:u.doubleSided,doubleSidedType:"winding-order",cullFace:u.doubleSided?0:2,vertexColors:!!e.attributes.color,vertexTangents:!!e.attributes.tangent,normals:b?"default":"screenDerivative",castShadows:!0,receiveSSAO:!0,textureId:s.isSome(x)?x.id:void 0,colorMixMode:u.colorMixMode,normalTextureId:s.isSome(u.textureNormal)&&c?p.get(u.textureNormal).id:void 0,textureAlphaPremultiplied:s.isSome(x)&&!!x.params.preMultiplyAlpha,occlusionTextureId:s.isSome(u.textureOcclusion)&&c?p.get(u.textureOcclusion).id:void 0,emissiveTextureId:s.isSome(u.textureEmissive)&&c?p.get(u.textureEmissive).id:void 0,metallicRoughnessTextureId:s.isSome(u.textureMetallicRoughness)&&c?p.get(u.textureMetallicRoughness).id:void 0,emissiveFactor:[f,m,d],mrrFactors:[u.metallicFactor,u.roughnessFactor,t.mrrFactors[2]],isSchematic:!1,...r}))}const V=E(e.indices||e.attributes.position.count,e.primitiveType),C=e.attributes.position.count,O=x.createBuffer(f.BufferViewVec3f,C);m.transformMat4(O,e.attributes.position,e.transform);const L=[["position",{data:O.typedBuffer,size:O.elementCount,exclusive:!0}]],F=[["position",V]];if(s.isSome(e.attributes.normal)){const t=x.createBuffer(f.BufferViewVec3f,C);o.normalFromMat4(n,e.transform),m.transformMat3(t,e.attributes.normal,n),L.push(["normal",{data:t.typedBuffer,size:t.elementCount,exclusive:!0}]),F.push(["normal",V])}if(s.isSome(e.attributes.tangent)){const t=x.createBuffer(f.BufferViewVec4f,C);o.normalFromMat4(n,e.transform),d.transformMat3(t,e.attributes.tangent,n),L.push(["tangent",{data:t.typedBuffer,size:t.elementCount,exclusive:!0}]),F.push(["tangent",V])}if(s.isSome(e.attributes.texCoord0)){const t=x.createBuffer(f.BufferViewVec2f,C);S.normalizeIntegerBuffer(t,e.attributes.texCoord0),L.push(["uv0",{data:t.typedBuffer,size:t.elementCount,exclusive:!0}]),F.push(["uv0",V])}if(s.isSome(e.attributes.color)){const t=x.createBuffer(f.BufferViewVec4u8,C);if(4===e.attributes.color.elementCount)e.attributes.color instanceof f.BufferViewVec4f?d.scale(t,e.attributes.color,255):e.attributes.color instanceof f.BufferViewVec4u8?w.copy(t,e.attributes.color):e.attributes.color instanceof f.BufferViewVec4u16&&d.scale(t,e.attributes.color,1/256);else{w.fill(t,255,255,255,255);const r=new f.BufferViewVec3u8(t.buffer,0,4);e.attributes.color instanceof f.BufferViewVec3f?m.scale(r,e.attributes.color,255):e.attributes.color instanceof f.BufferViewVec3u8?y.copy(r,e.attributes.color):e.attributes.color instanceof f.BufferViewVec3u16&&m.scale(r,e.attributes.color,1/256)}L.push(["color",{data:t.typedBuffer,size:t.elementCount,exclusive:!0}]),F.push(["color",V])}const _=new B.Geometry(L,F);h.stageResources.geometries.push(_),h.stageResources.materials.push(g.get(i)),c&&(s.isSome(u.textureColor)&&h.stageResources.textures.push(p.get(u.textureColor)),s.isSome(u.textureNormal)&&h.stageResources.textures.push(p.get(u.textureNormal)),s.isSome(u.textureOcclusion)&&h.stageResources.textures.push(p.get(u.textureOcclusion)),s.isSome(u.textureEmissive)&&h.stageResources.textures.push(p.get(u.textureEmissive)),s.isSome(u.textureMetallicRoughness)&&h.stageResources.textures.push(p.get(u.textureMetallicRoughness))),h.numberOfVertices+=C;const I=_.boundingInfo;s.isSome(I)&&(l.expandWithVec3(h.boundingBox,I.getBBMin()),l.expandWithVec3(h.boundingBox,I.getBBMax()))}))})),c}function A(e){switch(e){case"BLEND":return 0;case"MASK":return 2;case"OPAQUE":case null:case void 0:return 1}}function E(e,t){switch(t){case 4:return h.trianglesToTriangles(e);case 5:return h.triangleStripToTriangles(e);case 6:return h.triangleFanToTriangles(e)}}function L(e,t){for(let r=0;r<e.model.lods.length;++r){const o=e.model.lods[r];e.customMeta.esriTreeRendering=!0;for(const i of o.parts){const o=i.attributes.normal;if(s.isNone(o))return;const l=i.attributes.position,m=l.count,d=c.create(),g=c.create(),p=c.create(),h=x.createBuffer(f.BufferViewVec4u8,m),b=x.createBuffer(f.BufferViewVec3f,m),B=u.invert(a.create(),i.transform);for(let s=0;s<m;s++){l.getVec(s,g),o.getVec(s,d),n.transformMat4(g,g,i.transform),n.subtract(p,g,t.center),n.divide(p,p,t.radius);const u=p[2],a=n.length(p),c=Math.min(.45+.55*a*a,1);n.divide(p,p,t.radius),n.transformMat4(p,p,B),n.normalize(p,p),r+1!==e.model.lods.length&&e.model.lods.length>1&&(u>-1?n.lerp(p,p,d,.2):n.lerp(p,p,d,Math.min(-4*u-3.8,1))),b.setVec(s,p),h.set(s,0,255*c),h.set(s,1,255*c),h.set(s,2,255*c),h.set(s,3,255)}i.attributes.normal=b,i.attributes.color=h}}}e.fetch=T,e.gltfToEngineResources=O,e.parseUrl=C,Object.defineProperty(e,"__esModule",{value:!0})}));
