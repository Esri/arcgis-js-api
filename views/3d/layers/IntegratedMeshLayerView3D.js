/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../Graphic","../../../core/maybe","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec4f64","../../../geometry/support/aaBoundingRect","./I3SMeshView3D","./LayerView3D","../support/updatingProperties","../../layers/LayerView"],(function(e,t,r,o,a,i,s,l,n,c,d,y,h,p,u){"use strict";const _=.2;let g=function(t){function a(){var e;return(e=t.apply(this,arguments)||this).type="integrated-mesh-3d",e.lodFactor=1,e._elevationContext="im",e._isIntegratedMesh=!0,e._supportsLabeling=!1,e.drapeTargetType=1,e._overlayTexOffset=c.fromValues(-1,-1,-1,-1),e._overlayTexScale=c.create(),e._overlayColor=null,e._overlayHighlight=null,e._overlayNormal=null,e}e._inheritsLoose(a,t);var i=a.prototype;return i.setDrapingTextures=function(e){this._clearDrapingTexture(0),this._clearDrapingTexture(1);for(const t of e){const e=t.index,r=t.extent,a=t.needsColorWithoutRasterImage?t.getValidTarget(1):t.hasDrapedFeatureSource?t.getValidTarget(0):null;if(o.isSome(a)&&d.area(r)>0){this._overlayTexOffset[2*e]=-r[0]/d.width(r),this._overlayTexOffset[2*e+1]=-r[1]/d.height(r),this._overlayTexScale[2*e]=1/d.width(r),this._overlayTexScale[2*e+1]=1/d.height(r);const o=t.getValidTarget(2),i=t.getValidTarget(3);this._overlayColor=a.getTexture(),this._overlayHighlight=o?o.getTexture():null,this._overlayNormal=i?i.getTexture():null}}this._forAllNodes((e=>o.isSome(e)&&this._collection.updateMaterial(e.objectHandle,(e=>this._updateMaterialOverlay(e)))))},i._clearDrapingTexture=function(e){this._overlayTexOffset[2*e]=-1,this._overlayTexOffset[2*e+1]=-1,this._overlayTexScale[2*e]=0,this._overlayTexScale[2*e+1]=0,this._overlayColor=null,this._overlayHighlight=null,this._overlayNormal=null},i._updateMaterialOverlay=function(e){e.overlayColor=this._overlayColor,e.overlayHighlight=this._overlayHighlight,e.overlayNormal=this._overlayNormal,e.overlayTexOffset=this._overlayTexOffset,e.overlayTexScale=this._overlayTexScale},i.initialize=function(){this.updatingHandles.add(this.layer,"modifications",(()=>this._loadModifications()),2)},i._createLayerGraphic=function(){const e=new r;return e.layer=this.layer,e.sourceLayer=this.layer,e},i.canResume=function(){return t.prototype.canResume.call(this)&&(!this._controller||this._controller.rootNodeVisible)},i._loadModifications=function(){if(this.handles.remove("modifications"),o.isNone(this.layer.modifications))return void(this._modifications=[]);const e=this.layer.modifications;this.handles.add(this.updatingHandles.addOnCollectionChange(e,(()=>this._modifications=e.toArray()),2),"modifications")},e._createClass(a,[{key:"progressiveLoadFactor",get:function(){return this.lodFactor>=1?_:1}}]),a}(y.I3SMeshView3D(h.LayerView3D(u)));t.__decorate([a.property()],g.prototype,"layer",void 0),t.__decorate([a.property({aliasOf:"layer"})],g.prototype,"i3slayer",void 0),t.__decorate([a.property()],g.prototype,"suspended",void 0),t.__decorate([a.property(p.updatingProgress)],g.prototype,"updatingProgress",void 0),t.__decorate([a.property({readOnly:!0,aliasOf:"_controller.updatingProgress"})],g.prototype,"updatingProgressValue",void 0),t.__decorate([a.property({readOnly:!0,aliasOf:"view.qualitySettings.sceneService.integratedMesh.lodFactor"})],g.prototype,"lodFactor",void 0),t.__decorate([a.property({readOnly:!0})],g.prototype,"progressiveLoadFactor",null),g=t.__decorate([n.subclass("esri.views.3d.layers.SceneLayerView3D")],g);return g}));
