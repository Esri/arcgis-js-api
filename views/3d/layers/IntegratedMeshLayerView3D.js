/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../Graphic","../../../core/maybe","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec4f64","../../../geometry/support/aaBoundingRect","./I3SMeshView3D","./interfaces","./LayerView3D","../support/updatingProperties","../terrain/interfaces","../../layers/LayerView"],(function(e,r,t,a,o,i,l,s,n,c,y,d,h,p,u,g,_,v){"use strict";const f=.2;let T=function(r){function i(){var e;return(e=r.apply(this,arguments)||this).type="integrated-mesh-3d",e.lodFactor=1,e._elevationContext="im",e._isIntegratedMesh=!0,e._supportsLabeling=!1,e.drapeTargetType=p.DrapeTargetType.WithoutRasterImage,e._overlayTexOffset=y.fromValues(-1,-1,-1,-1),e._overlayTexScale=y.create(),e._overlayColor=null,e._overlayHighlight=null,e._overlayNormal=null,e}e._inheritsLoose(i,r);var l=i.prototype;return l.setDrapingTextures=function(e){this._clearDrapingTexture(_.OverlayIndex.INNER),this._clearDrapingTexture(_.OverlayIndex.OUTER);for(const r of e){const e=r.index,t=r.extent,o=r.needsColorWithoutRasterImage?r.getValidTarget(_.RenderTargetType.ColorNoRasterImage):r.hasDrapedFeatureSource?r.getValidTarget(_.RenderTargetType.Color):null;if(a.isSome(o)&&d.area(t)>0){this._overlayTexOffset[2*e]=-t[0]/d.width(t),this._overlayTexOffset[2*e+1]=-t[1]/d.height(t),this._overlayTexScale[2*e]=1/d.width(t),this._overlayTexScale[2*e+1]=1/d.height(t);const a=r.getValidTarget(_.RenderTargetType.Highlight),i=r.getValidTarget(_.RenderTargetType.Water);this._overlayColor=o.getTexture(),this._overlayHighlight=a?a.getTexture():null,this._overlayNormal=i?i.getTexture():null}}this._forAllNodes((e=>a.isSome(e)&&this._collection.updateMaterial(e.objectHandle,(e=>this._updateMaterialOverlay(e)))))},l._clearDrapingTexture=function(e){this._overlayTexOffset[2*e]=-1,this._overlayTexOffset[2*e+1]=-1,this._overlayTexScale[2*e]=0,this._overlayTexScale[2*e+1]=0,this._overlayColor=null,this._overlayHighlight=null,this._overlayNormal=null},l._updateMaterialOverlay=function(e){e.overlayColor=this._overlayColor,e.overlayHighlight=this._overlayHighlight,e.overlayNormal=this._overlayNormal,e.overlayTexOffset=this._overlayTexOffset,e.overlayTexScale=this._overlayTexScale},l.initialize=function(){this.updatingHandles.add((()=>this.layer.modifications),(()=>this._loadModifications()),o.initial)},l._createLayerGraphic=function(){const e=new t;return e.layer=this.layer,e.sourceLayer=this.layer,e},l.canResume=function(){return r.prototype.canResume.call(this)&&(!this._controller||this._controller.rootNodeVisible)},l._loadModifications=function(){if(this.handles.remove("modifications"),a.isNone(this.layer.modifications))return void(this._modifications=[]);const e=this.layer.modifications;this.handles.add(this.updatingHandles.addOnCollectionChange((()=>e),(()=>this._modifications=e.toArray()),o.initial),"modifications")},e._createClass(i,[{key:"progressiveLoadFactor",get:function(){return this.lodFactor>=1?f:1}}]),i}(h.I3SMeshView3D(u.LayerView3D(v)));r.__decorate([i.property()],T.prototype,"layer",void 0),r.__decorate([i.property({aliasOf:"layer"})],T.prototype,"i3slayer",void 0),r.__decorate([i.property(g.updatingProgress)],T.prototype,"updatingProgress",void 0),r.__decorate([i.property({readOnly:!0,aliasOf:"_controller.updatingProgress"})],T.prototype,"updatingProgressValue",void 0),r.__decorate([i.property({readOnly:!0,aliasOf:"view.qualitySettings.sceneService.integratedMesh.lodFactor"})],T.prototype,"lodFactor",void 0),r.__decorate([i.property({readOnly:!0})],T.prototype,"progressiveLoadFactor",null),T=r.__decorate([c.subclass("esri.views.3d.layers.SceneLayerView3D")],T);return T}));
