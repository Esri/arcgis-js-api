// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../Color","../../../Graphic","../../../core/Collection","../../../core/has","../../../core/Logger","../../../core/MapUtils","../../../core/mathUtils","../../../core/maybe","../../../core/PooledArray","../../../core/promiseUtils","../../../core/scheduling","../../../core/typedArrayUtil","../../../core/unitUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators","../../../core/libs/gl-matrix-2/mat3","../../../core/libs/gl-matrix-2/mat3f32","../../../core/libs/gl-matrix-2/mat4","../../../core/libs/gl-matrix-2/mat4f64","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../../../core/libs/gl-matrix-2/vec4","../../../geometry/support/aaBoundingBox","../../../layers/graphics/controllers/I3SOnDemandController","../../../layers/support/fieldUtils","../../../layers/support/layerUtils","../../../layers/support/SceneModification","../../../renderers/visualVariables/support/visualVariableUtils","../../../support/arcadeOnDemand","../../../symbols/Symbol3D","../../../symbols/support/unitConversionUtils","./I3SMeshViewLabeler","./I3SMeshWorkerHandle","./SceneLayerWorker","./graphics/graphicUtils","./i3s/Highlights","./i3s/I3SCrossfadeHelper","./i3s/I3SElevationProvider","./i3s/I3SGeometryUtil","./i3s/I3SIntersectionHandler","./i3s/I3SProjectionUtil","./i3s/I3SUtil","./i3s/IDBCache","./support/attributeUtils","./support/layerViewUpdatingProperties","../support/debugFlags","../support/extentUtils","../support/orientedBoundingBox","../support/projectionUtils","../support/buffer/glUtil","../webgl-engine/collections/Component/SourceGeometry","../webgl-engine/core/material/RenderTexture","../webgl-engine/core/shaderLibrary/util/AlphaDiscard.glsl","../webgl-engine/lib/Texture","../webgl-engine/lib/TextureBackedBuffer/BufferManager","@dojo/framework/shim/Promise"],(function(e,t,r,i,o,a,n,s,l,d,c,u,h,p,f,_,g,m,y,b,v,M,I,S,x,C,O,w,E,N,D,F,T,R,j,A,V,P,H,G,U,B,L,k,q,z,W,K,J,Q,X,Y,Z,$,ee,te,re,ie){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.I3SMeshView3D=void 0;var oe=s.getLogger("esri.views.3d.layers.SceneLayerView3D"),ae=[1,1,1,1],ne=function(e,t,r,i,o,a,n){this.node=e,this.featureIds=t,this.objectHandle=r,this.cachedRendererVersion=i,this.attributeInfo=o,this.material=a,this.textures=n,this.lodCrossfadeTargetTime=null,this.lodCrossfadeDirection=0,this.cachedEdgeMaterials=new Array,this.cachedSymbology=null};t.I3SMeshView3D=function(t){return function(t){function i(){var e=null!==t&&t.apply(this,arguments)||this;return e._elevationProvider=null,e._intersectionHandler=null,e._nodeId2Meta=new Map,e._nodeId2MetaReloading=new Map,e._asyncModuleLoading=0,e._addTasks=new Map,e._rendererVersion=0,e._colorVariable=null,e._opacityVariable=null,e._rendererFields=null,e._symbologyFields=null,e._symbologyOverride=null,e._symbologyOverrideFields=null,e._symbolInfos=new Map,e._idbCache=new z.IDBCache("esri-scenelayer-cache","geometries"),e._labeler=null,e.holeFilling="auto",e._hasColors=!1,e._hasTextures=!1,e._hasData=!1,e.slicePlaneEnabled=!1,e._modifications=new Array,e._layerUrl="",e._cacheKeySuffix=null,e._arcade=null,e._tmpAttributeOnlyGraphic=new o(null,null,{}),e._crossfadeHelper=new G.I3SCrossfadeHelper(e),e}return r.__extends(i,t),Object.defineProperty(i.prototype,"lodCrossfadeDuration",{get:function(){return 0},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"layerUid",{get:function(){return this.i3slayer&&this.i3slayer.uid},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"sublayerUid",{get:function(){return null},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"hasTexturesOrVertexColors",{get:function(){return this._hasData?this._hasTextures||this._hasColors?"yes":"probably-not":"unknown"},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"rendererTextureUsage",{get:function(){return q.rendererNeedsTextures(this._currentRenderer)?63:44},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"elevationOffset",{get:function(){var e=null!=this.i3slayer?this.i3slayer.elevationInfo:null;if(null!=e&&"absolute-height"===e.mode){var t=_.getMetersPerVerticalUnitForSR(this.i3slayer.spatialReference),r=R.getMetersPerUnit(e.unit);return c.unwrapOr(e.offset,0)*r/t}return 0},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"uncompressedTextureDownsamplingEnabled",{get:function(){return this.view&&this.view.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled&&!this.useCompressedTextures},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"useCompressedTextures",{get:function(){var e=this.i3slayer.version,t=!n("trident")||e.major>1||1===e.major&&e.minor>3;return this.view._stage.renderView.has("s3tc")&&t},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"_enableMipMaps",{get:function(){return!this.uncompressedTextureDownsamplingEnabled},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"_enableAtlasMipMaps",{get:function(){return this._enableMipMaps},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"_atlasBiasCompensationEnabled",{get:function(){return this.view&&this.view._stage&&!this.view._stage.renderView.has("shaderTextureLOD")&&this._enableAtlasMipMaps},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"_disableAtlasAnisotropy",{get:function(){return this._atlasBiasCompensationEnabled},enumerable:!1,configurable:!0}),i.prototype.initialize=function(){var t=this;if(this._worker=new A.I3SMeshWorkerHandle(this.view.resourceController.scheduler),this.addResolvingPromise(this._worker.promise),this._worker.setLegacySchema(this.layerUid,this.i3slayer.store.defaultGeometrySchema),q.checkSceneLayerValid(this.i3slayer),q.checkSceneLayerCompatibleWithView(this.i3slayer,this.view),this._layerUrl=this.i3slayer.parsedUrl.path,this._controller=new O({layerView:this}),this.gpuMemoryEstimate=0,this.texMemoryEstimate=0,this.geoMemoryEstimate=0,this._stage=this.view._stage,this._collection=this._stage.renderView.componentObjectCollection,this._highlights=new H({collection:this._collection,forAllFeatures:function(e){return t._forAllFeatures(e,null,1)},forAllFeaturesOfNode:function(e,r){return t._forAllFeaturesOfNode(e,r)}}),this._isIntegratedMesh||!this.i3slayer.store.defaultGeometrySchema)this._hasSymbolColors=!1;else{var r=this.i3slayer.store.defaultGeometrySchema.featureAttributes;this._hasSymbolColors=!!(r&&r.faceRange&&r.id)}this._hasVertexColors=null!=this.i3slayer.store.defaultGeometrySchema.vertexAttributes.color&&(null==this.i3slayer.cachedDrawingInfo||!this.i3slayer.cachedDrawingInfo.color),this._isIntegratedMesh||(this._edgeView=this._stage.renderView.ensureEdgeView()),this._memCache=this.view.resourceController.memoryController.getMemCache(this.i3slayer.uid,(function(e){return t._deleteComponentObject(e)})),this._intersectionHandler=new L.I3SIntersectionHandler({layerUid:this.layerUid,sublayerUid:this.sublayerUid,collection:this._collection,slicePlaneEnabled:this.slicePlaneEnabled,isGround:this._isIntegratedMesh,forEach:function(e){t._nodeId2Meta.forEach((function(t){return c.isSome(t)&&e(t.node,t.objectHandle)})),t._nodeId2MetaReloading.forEach((function(t){return c.isSome(t)&&e(t.node,t.objectHandle)}))}}),this._elevationProvider=new U({layerView:this,intersectionHandler:this._intersectionHandler}),this.updatingHandles.add(this,"view.clippingArea",(function(){return t._clippingAreaChanged()}),2),this.updatingHandles.add(this,"fullOpacity",(function(e){return t._opacityChange(e)})),this.updatingHandles.add(this,"slicePlaneEnabled",(function(e){return t._slicePlaneEnabledChange(e)})),this.updatingHandles.add(this,"elevationOffset",(function(e,r){t._reloadAll(r),t._controller.invalidateVisibilityObbs()})),this.updatingHandles.add(this,"filter",(function(){return t._filterChange()}),2),this.updatingHandles.add(this,"view.qualitySettings.physicallyBasedRenderingEnabled",(function(){return t._updatePBR()}));var i=function(){t._reloadAll(),t._memCache.clear()};this.updatingHandles.add(this,"rendererTextureUsage",i),this.updatingHandles.add(this,"uncompressedTextureDownsamplingEnabled",i),this.updatingHandles.add(this,"suspended",(function(e){return t._suspendedChange(e)}),2),this.updatingHandles.add(this.i3slayer,"labelsVisible",(function(){return t._labelingChanged()}),2),this.updatingHandles.add(this.i3slayer,"labelingInfo",(function(){return t._labelingChanged()}),2),this.updatingHandles.add(this,"_modifications",(function(){return t._modificationsChanged()}),2),this.handles.add([g.init(J,"I3S_TREE_SHOW_TILES",(function(r){if(r&&!t._treeDebugger){var i=t._controller.crsIndex;new Promise((function(t,r){e(["./support/I3STreeDebugger"],t,r)})).then((function(e){var r=e.I3STreeDebugger;!t._treeDebugger&&J.I3S_TREE_SHOW_TILES&&(t._treeDebugger=new r({lv:t,view:t.view,nodeSR:i}))}))}else r||!t._treeDebugger||J.I3S_TREE_SHOW_TILES||(t._treeDebugger.destroy(),t._treeDebugger=null)})),g.init(J,"I3S_SHOW_MODIFICATIONS",(function(){return t._showModifications()}))]),this._cacheKeySuffix=q.getCacheKeySuffix(this.i3slayer.spatialReference,this.view.renderSpatialReference),this._idbCache.init().catch((function(e){return oe.warn("Failed to initialize IndexedDB cache: "+e)})),this._componentColorManager=this._hasSymbolColors?new ie.BufferManager(this._stage.renderView.renderingContext):null},i.prototype.destroy=function(){this._clearAddTasks(),this._elevationProvider&&(this._elevationProvider.layerChanged(),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null),this._intersectionHandler&&(this._stage.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null);var e=this._worker;e&&(e.destroyContext(this.i3slayer.uid).then((function(){return e.destroy()})),this._worker=null),this._removeAllNodeDataFromStage(),this._memCache.destroy(),this._memCache=null,this._collection=null,this._stage=null,this._edgeView=null,c.isSome(this._labeler)&&(this._labeler.destroy(),this._labeler=null),this._treeDebugger&&(this._treeDebugger.destroy(),this._treeDebugger=null),this._controller&&(this._controller.destroy(),this._controller=null),this._highlights.destroy(),this._nodeId2Meta=null,this._nodeId2MetaReloading=null,this._componentColorManager&&(this._componentColorManager.destroy(),this._componentColorManager=null),this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)},i.prototype.memEstimateTextureAdded=function(e){var t=e.estimatedTexMemRequired;return this.gpuMemoryEstimate+=t,this.texMemoryEstimate+=t,t},i.prototype.memEstimateTextureRemoved=function(e){var t=e.estimatedTexMemRequired;this.gpuMemoryEstimate-=t,this.texMemoryEstimate-=t},i.prototype.memEstimateGeometryAdded=function(e){var t=this._collection.getObjectGPUMemoryUsage(e);return this.gpuMemoryEstimate+=t,this.geoMemoryEstimate+=t,t},i.prototype.memEstimateGeometryRemoved=function(e){var t=this._collection.getObjectGPUMemoryUsage(e);this.gpuMemoryEstimate-=t,this.geoMemoryEstimate-=t},i.prototype.isNodeLoaded=function(e){return this._nodeId2Meta.has(e)},i.prototype.isNodeReloading=function(e){return this._nodeId2MetaReloading.has(e)},i.prototype.getUsedMemory=function(){var e=c.isSome(this._labeler)?this._labeler.usedMemory:0;return this._nodeId2Meta.forEach((function(t){return e+=c.isSome(t)?t.node.memory:0})),this._nodeId2MetaReloading.forEach((function(t){return e+=c.isSome(t)?t.node.memory:0})),e},i.prototype.getUnloadedMemory=function(){return(this._controller?this._controller.unloadedMemoryEstimate:0)+(c.isSome(this._labeler)?this._labeler.unloadedMemoryEstimate:0)},i.prototype.ignoresMemoryFactor=function(){return!1},i.prototype._labelingChanged=function(){var e=this;if(E.areLabelsVisible(this.i3slayer)&&this._supportsLabeling){if(!c.isSome(this._labeler)){var t=new j.default({view:this.view,layer:this.i3slayer,collection:this._collection});this._nodeId2Meta.forEach((function(r){return c.isSome(r)&&e._addMetaToLabeler(t,r)})),this._labeler=t}}else c.isSome(this._labeler)&&(this._labeler.destroy(),this._labeler=null)},i.prototype._loadAsyncModule=function(e){var t=this;return++this._asyncModuleLoading,e.then((function(e){return--t._asyncModuleLoading,e}),(function(e){throw--t._asyncModuleLoading,e}))},i.prototype._modificationsChanged=function(){var t=this;if(c.isNone(this._i3sModule)&&this._hasModifications)this._i3sModule=this._loadAsyncModule(new Promise((function(t,r){e(["./SceneLayerWorker"],t,r)})).then((function(e){return e.ensureWASM().then((function(){t._i3sModule=e,t._modificationsChanged()}))})));else if(!(c.isNone(this._i3sModule)||this._i3sModule instanceof Promise)){var r=this.i3slayer.uid,i=this.i3slayer.spatialReference;this._worker.setModifications(r,this._modifications,i);var o=A.toWasmModification(this._modifications,i);this._i3sModule.setModificationsSync({context:r,modifications:o,isGeodetic:i.isGeographic}),this._controller.modificationsChanged();var a=this._hasModifications?new u:null;this._nodeId2Meta.forEach((function(e,r){c.isNone(e)?t._nodeId2Meta.delete(r):e.node.hasModifications?(t._nodeId2Meta.delete(r),t._nodeId2MetaReloading.set(r,e)):c.isSome(a)&&a.push(e.node)})),c.isSome(a)&&this._nodeId2MetaReloading.forEach((function(e){return a.push(e.node)})),c.isSome(a)&&a.length>0&&(this.updateNodeModificationStatus(a),a.forEachSimple((function(e){if(2!==e.imModificationImpact){var r=t._nodeId2Meta.get(e.index);t._controller.invalidateGeometryVisibility(e.index),t._nodeId2Meta.delete(e.index),c.isSome(r)&&t._nodeId2MetaReloading.set(e.index,r)}}))),this._memCache.clear(),this._controller.restartNodeLoading(),this._showModifications()}},i.prototype._showModifications=function(){if(c.isSome(this._modificationGraphics)&&(this.view.graphics.removeMany(this._modificationGraphics),this._modificationGraphics=null),J.I3S_SHOW_MODIFICATIONS&&0!==this._modifications.length){var e={clip:[227,227,79,.8],mask:[227,139,79,.8],replace:[139,227,79,.8]},t={type:"simple-fill",outline:{color:[255,255,255],width:1}};this._modificationGraphics=new Array;for(var i=0,a=this._modifications;i<a.length;i++){var n=a[i];n.geometry.spatialReference=this.i3slayer.spatialReference;var s=r.__assign(r.__assign({},t),{color:e[n.type]});this._modificationGraphics.push(new o({geometry:n.geometry,symbol:s}))}this.view.graphics.addMany(this._modificationGraphics)}},i.prototype._addMetaToLabeler=function(e,t){var r=this;e.addNodeMeta(t,(function(e,t){return r._createAttributes(e,t)}))},i.prototype._suspendedChange=function(e){e?(this._removeAllNodeDataFromStage(),this.view.elevationProvider&&this.view.elevationProvider.unregister(this._elevationProvider),this._stage.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler)):(this.view.elevationProvider.register(this._elevationContext,this._elevationProvider),this._stage.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler))},i.prototype.getLoadedAttributes=function(e){var t=this._nodeId2Meta.get(e);if(c.isSome(t)&&c.isSome(t.attributeInfo))return t.attributeInfo.loadedAttributes},i.prototype.getAttributeData=function(e){var t=this._nodeId2Meta.get(e);if(c.isSome(t)&&c.isSome(t.attributeInfo))return t.attributeInfo.attributeData},i.prototype.setAttributeData=function(e,t){var r=this,i=this._nodeId2Meta.get(e);c.isSome(i)&&(i.attributeInfo=t,i.cachedRendererVersion=this._getInvalidRendererVersion(),i.filteredIds=null,c.isSome(this._labeler)&&this._labeler.setNodeMetaAttributes(i,(function(e,t){return r._createAttributes(e,t)})),this._updateEngineObject(i))},i.prototype.getVisibleNodes=function(){var e=new Array;return this._nodeId2Meta.forEach((function(t){return c.isSome(t)&&e.push(t.node)})),e},i.prototype.getLoadedNodeIndices=function(e){this._nodeId2Meta.forEach((function(t,r){return e.push(r)})),this._nodeId2MetaReloading.forEach((function(t,r){return e.push(r)}))},i.prototype._createTexture=function(e,t,r,i){if(c.isNone(r)||null==r.data)return null;var o,a=r.data,n=r.encoding,s=t.wrapTextures,l=1&r.usage?"opaque"===t.alphaMode?3:4:3,u=!0;if(n===q.DDS_ENCODING_STRING)o=re.DDS_ENCODING;else{var h=a;u=d.isPowerOfTwo(h.width)&&d.isPowerOfTwo(h.height)}var p=i,f=(p?this._enableAtlasMipMaps:this._enableMipMaps)&&u,_={mipmap:f,wrap:p||!s?{s:33071,t:33071}:{s:10497,t:10497},disableAnisotropy:p&&f&&this._disableAtlasAnisotropy,encoding:o,noUnpackFlip:!0,components:l},g=new re(a,e.id+"/"+r.id,_);return this._stage.add(4,g),e.memory+=this.memEstimateTextureAdded(g),g},i.prototype._getVertexBufferLayout=function(e,t){var r={hasTexture:pe(e.params.material),hasNormals:t.normal,hasRegions:t.uvRegion};return Z.glLayout($.createVertexBufferLayout(this._getGeometryParameters(r)))},i.prototype._getObjectIdField=function(){return this.i3slayer.objectIdField||"OBJECTID"},i.prototype._findGraphicNodeAndIndex=function(e){var t=W.attributeLookup(e.attributes,this._getObjectIdField()),r=null;return l.someMap(this._nodeId2Meta,(function(e){if(c.isNone(e))return!1;var i=e.featureIds.indexOf(t);return-1!==i&&(r={node:e.node,index:i},!0)})),r},i.prototype._getGraphicIndices=function(e,t){var r=this._nodeId2Meta.get(e.index);if(c.isNone(r))return[];for(var i=[],o=this._getObjectIdField(),a=0,n=t;a<n.length;a++){var s=n[a],l=W.attributeLookup(s.attributes,o),d=r.featureIds.indexOf(l);-1!==d&&i.push(d)}return i},i.prototype.whenGraphicBounds=function(e){var t=this._findGraphicNodeAndIndex(e);if(!t)return h.reject();var r=this._nodeId2Meta.get(t.node.index);if(c.isNone(r))return h.reject();var i=r.objectHandle,o=B.boundingBoxCornerPoints(t.index,this._collection,i,new Float64Array(24)),a=this.view.renderSpatialReference,n=this.view.spatialReference;if(Y.bufferToBuffer(o,a,0,o,n,0,8)){var s=C.empty();return C.expandWithBuffer(s,o,0,8),h.resolve({boundingBox:s,screenSpaceObjects:[]})}},i.prototype.whenGraphicAttributes=function(e,t){var r=this;return q.whenGraphicAttributes(this.i3slayer,e,this._getObjectIdField(),t,(function(e){for(var t=new Map,i=[],o=0,a=e;o<a.length;o++){var n=a[o],s=r._findGraphicNodeAndIndex(n),l=t.get(s.node);l||(l={node:s.node,indices:[],graphics:[]},i.push(l),t.set(s.node,l)),l.indices.push(s.index),l.graphics.push(n)}return i}),{populateObjectId:!0})},i.prototype.getGraphicFromIntersectorMetadata=function(e){if(null==e.nodeIndex||null==e.componentIndex)return null;var t=this._nodeId2Meta.get(e.nodeIndex);return c.isNone(t)||null==t.featureIds||e.componentIndex>=t.featureIds.length?null:this._createGraphic(e.componentIndex,t)},i.prototype._getCacheKey=function(e){return this._layerUrl+"/v16/"+e.id+this._cacheKeySuffix},i.prototype._getMemCacheKey=function(e,t){return void 0===t&&(t=this.elevationOffset),e+"#"+t},Object.defineProperty(i.prototype,"_idbCacheEnabled",{get:function(){return!this._controller.disableIDBCache&&0===this._modifications.length&&0===this.elevationOffset&&null!=this._cacheKeySuffix},enumerable:!1,configurable:!0}),i.prototype.loadCachedGPUData=function(e){return this._memCache.pop(this._getMemCacheKey(e.index))},i.prototype._cacheGPUData=function(e,t){void 0===t&&(t=this.elevationOffset);var r=this._controller.indexDepth-e.node.level+1;this._memCache.put(this._getMemCacheKey(e.node.index,t),e,e.node.memory,r)},i.prototype.loadMissingTextures=function(e,t,r,i){var o=this,a=e.filter((function(e,r){if(0==(e.usage&o.rendererTextureUsage))return!1;if(c.isNone(t))return!0;var i=q.selectEncoding(e.encodings,o.useCompressedTextures),a=t[r];return!!(c.isNone(a)||null==a.data||i&&a.encoding!==i.encoding)}));return 0===a.length?h.resolve(!1):r(a,i).then((function(r){for(var i=0,o=0;o<e.length;o++)i<r.length&&r[i].id===e[o].id&&(t[o]=r[i],i++);return!0}))},i.prototype.loadCachedNodeData=function(e,t,r){var i=this;return this._idbCacheEnabled?this._idbCache.get(this._getCacheKey(e),t).then((function(o){return null==o?null:o.nodeVersion!==e.version?(i._idbCache.remove(i._getCacheKey(e)),null):(e.geometryObb=o.geometryObb,i.loadMissingTextures(o.requiredTextures,o.textureData,r,t).then((function(r){return r&&i._idbCache.initialized&&c.isSome(o.textureData)&&(o.byteSize=_e(o.transformedGeometry,o.textureData),o.textureData.every(fe)&&ge(e,o)&&i._idbCache.put(i._getCacheKey(e),o).catch((function(t){return oe.warn("Failed to update node with textures in IndexedDB cache: "+e.id+": "+t)}))),h.throwIfAborted(t),o})))})):h.resolve(null)},i.prototype.addNode=function(e,t,i){var o=this;return function(e){return"geometryData"in e}(t)?this._addData(e,t.attributeDataInfo,(function(){return o._transformNode(e,t,i).then((function(a){return o._safeReschedule(i,(function(){if(c.isNone(a))return e.hasModifications=!1,o._addCachedNodeData(e,null,i);e.hasModifications=a.transformedGeometry.hasModifications;var n=a.obb,s=a.componentOffsets,l=a.featureIds,d=a.transformedGeometry,u=o._controller.crsIndex,h=o.view.renderSpatialReference,p=k.computeGlobalTransformation(e.mbs,o.elevationOffset,u,h);e.geometryObb=X.create([n.center.x,n.center.y,n.center.z],[n.extents.x,n.extents.y,n.extents.z],[n.orientation.x,n.orientation.y,n.orientation.z,n.orientation.w]),I.vec3.transformMat4(e.geometryObb.center,e.geometryObb.center,p),t.geometryData.componentOffsets=s,l&&(t.geometryData.featureIds=Array.prototype.slice.call(l));var f={nodeVersion:e.version,geometryData:t.geometryData,requiredTextures:t.requiredTextures,textureData:t.textureData,transformedGeometry:d,globalTrafo:p,geometryObb:e.geometryObb,byteSize:_e(d,t.textureData)};if(o._idbCacheEnabled&&o._idbCache.initialized&&ge(e,f)){var _=c.isSome(f.textureData)?f.textureData.map((function(e){return fe(e)?e:null})):null;o._idbCache.put(o._getCacheKey(e),r.__assign(r.__assign({},f),{textureData:_})).catch((function(t){return oe.warn("Failed to store node in IndexedDB cache: "+e.id+": "+t)}))}return o._addCachedNodeData(e,f,i)}))}))})):h.reject()},i.prototype.computeVisibilityObb=function(e){return q.computeVisibilityObb(e,this.view.renderSpatialReference,this._controller.crsIndex,this.i3slayer.spatialReference,this.elevationOffset,this._modifications)},i.prototype._transformNode=function(e,t,r){for(var i=t.geometryData.geometries,o=new Array(i.length),a=0;a<i.length;++a)o[a]=this._getVertexBufferLayout(i[a],t.geometryDescriptor);var n=e.mbs,s=this.elevationOffset,l=this._controller.crsIndex,d=this._controller.crsVertex,u=this.view.renderSpatialReference,p=k.getLocalOrigin(n,s,l),f=k.computeGlobalTransformation(n,s,l,u),_=Y.getProjectorName(l,d),g=Y.getProjectorName(d,u);if(c.isNone(_)||c.isNone(g))return h.resolve(null);var m={context:this.i3slayer.uid,geometryBuffer:t.geometryBuffer,geometryData:t.geometryData,geometryDescriptor:t.geometryDescriptor,layouts:o,localOrigin:p,globalTrafo:f,mbs:n,obb:e.serviceObb,elevationOffset:s,needNormals:!this._isIntegratedMesh&&this._controller.isMeshPyramid,normalReferenceFrame:this.i3slayer.normalReferenceFrame||"none",indexToVertexProjector:_,vertexToRenderProjector:g};return this._worker.invoke(m,r)},i.prototype.isFadingEnabled=function(){return this.lodCrossfadeDuration>0},i.prototype._setNewNodeOpacity=function(e,t){var r=this.isFadingEnabled(),i=r?0:this.fullOpacity;this.setNodeOpacity(t,i),r?this._crossfadeHelper.fadeNodeInternal(e,t,0):this._crossfadeHelper.stopNodeFadingInternal(t)},i.prototype.addCachedGPUData=function(e,t,r){if(e.geometryObb=X.clone(this._collection.getComponentObb(t.objectHandle)),this._controller.isGeometryVisible(e)){c.isSome(this._labeler)&&this._addMetaToLabeler(this._labeler,t);var i=e.index;this._addNodeMeta(i,t),this.updateNodeState(i,r),this._collection.setObjectVisibility(t.objectHandle,!0),this._updateMaterial(t),this._setNewNodeOpacity(i,t),this._updateEngineObject(t),this._highlights.objectCreated(t),this._treeDebugger&&this._treeDebugger.update()}else this._cacheGPUData(t)},i.prototype.addCachedNodeData=function(e,t,r,i){var o=this;return this._addData(e,r,(function(){return o._addCachedNodeData(e,t,i)}))},i.prototype._addCachedNodeData=function(e,t,r){var i=this;if(this.suspended||!this._controller.isGeometryVisible(e))return this._removeNodeStageData(e.index,this.elevationOffset,this._nodeId2MetaReloading),h.resolve();if(c.isNone(t))return this._addNodeMeta(e.index,null),h.resolve();var o=t.geometryData,a=t.transformedGeometry,n=t.globalTrafo,s=c.isSome(t.textureData)?t.textureData.filter((function(e){return c.isSome(e)&&0!=(e.usage&i.rendererTextureUsage)})):null;e.memory=0;var l=o.componentOffsets,d=o.geometries,u=o.featureIds,p=null,f=null;if(this._hasSymbolColors){p=this._componentColorManager.getBuffer(u.length),f=new Uint16Array(u.length);for(var _=0;_<u.length;_++)f[_]=p.acquireIndex()}var g=this._collection,m=d[0],I=a.layout,x=a.indices,C=a.interleavedVertexData,O=a.positionData,w=a.hasColors,E=this._materialParameters(m,I),N=l||new Uint32Array([0,x?x.length:C.byteLength/I[0].stride]),D={vertices:{data:C,count:C.byteLength/I[0].stride,layoutParameters:E.geometryParams},positionData:{positions:O.data,indices:O.indices},indices:x,primitiveType:4,componentOffsets:N},F=m.transformation?M.mat4f64.clone(m.transformation):M.mat4f64.create();v.mat4.multiply(F,n,F);var T=v.mat4.getTranslation(S.vec3f64.create(),F),R=y.mat3.fromMat4(b.mat3f32.create(),F),j=this.view.renderSpatialReference,A=this.view.basemapTerrain.spatialReference,V=S.vec3f64.create(),P=[1,1,1];Y.localLinearScaleFactors(T,j,P,A),Y.vectorToVector(T,j,V,A);var H=g.createObject({toMapSpace:[V[0],V[1],P[0],P[1]],geometry:D,obb:c.unwrap(e.geometryObb),transform:{position:T,rotationScale:R},visible:!1}),G={isSchematic:m.params.material.isSchematic,isOpaque:"blend"!==m.params.material.alphaMode&&m.params.material.metallicRoughness.baseColorFactor[3]>=1},U=c.isSome(s)?s.map((function(t){return i._createTexture(e,E.material,t,2===E.geometryParams.textureCoordinates)})):[];this._configureMaterial(H,m.params.material,U,s),e.memory+=this.memEstimateGeometryAdded(H);var B=this._addTasks.get(e.index),L=new ne(e,u,H,this._getInvalidRendererVersion(),B.attributeInfo,G,U);B.meta=L,!this._hasTextures&&t.requiredTextures.some((function(e){return 0!=(19&e.usage)}))&&(this._hasTextures=!0),this._hasData=!0,this._hasColors=this._hasColors||w,this._hasTextures=this._hasTextures||!!e.resources.texture,this.notifyChange("hasTexturesOrVertexColors");var k=this.slicePlaneEnabled;return this._addOrUpdateEdgeRendering(L).then((function(t){return t&&i._edgeView.updateObjectVisibility(L.objectHandle,!1),i._safeReschedule(r,(function(){var r=i._addTasks.get(e.index);if(r)if(c.isSome(i._labeler)&&i._addMetaToLabeler(i._labeler,L),i._addNodeMeta(e.index,L),r.meta=null,i.suspended)i._removeNodeStageData(e.index,i.elevationOffset);else{g.setObjectVisibility(H,!0),t&&i._edgeView.updateObjectVisibility(L.objectHandle,!0),L.attributeInfo=r.attributeInfo;var o=L.cachedRendererVersion!==i._rendererVersion,a=k!==i.slicePlaneEnabled;i._setObjectSymbolColors(L);var n=i._applyFiltersToNode(L);(o||t&&(a||n))&&i._addOrUpdateEdgeRendering(L),i.visibleGeometryChanged(L),i._highlights.objectCreated(L),i._updateMaterial(L),i._setNewNodeOpacity(e.index,L),i._treeDebugger&&i._treeDebugger.update()}}))})).catch((function(e){throw c.isSome(B.meta)&&(i._deleteComponentObject(B.meta),B.meta=null),e}))},i.prototype._addNodeMeta=function(e,t){if(this._removeNodeStageData(e,this.elevationOffset,this._nodeId2MetaReloading),this._nodeId2Meta.has(e)){oe.error("Removing duplicated node");var r=this._nodeId2Meta.get(e);c.isSome(r)&&this._deleteComponentObject(r)}this._nodeId2Meta.set(e,t)},i.prototype._safeReschedule=function(e,t){return h.throwIfAborted(e),this._controller.reschedule(e,t)},i.prototype._materialParameters=function(e,t){var r=e.params.material,i=t.some((function(e){return"uvRegion"===e.name})),o=t.some((function(e){return"normalCompressed"===e.name})),a=pe(r);return{geometryParams:this._getGeometryParameters({hasTexture:a,hasNormals:o,hasRegions:i}),material:r}},i.prototype._configureMaterial=function(e,t,r,i){var o=this,a=this.rendererTextureUsage,n=function(e){return function(e,t,r){if(c.isNone(e)||0===r)return null;for(var i=0;i<e.length;i++){var o=e[i];if(c.isSome(o)&&0!=(o.usage&r))return t[i].id}return null}(i,r,e&a)};this._collection.updateMaterial(e,(function(e){var r=t.metallicRoughness.baseColorFactor,i=d.clamp(t.metallicRoughness.baseColorFactor[3],0,1);e.baseColor=[r[0],r[1],r[2],i],e.mrrFactors=[t.metallicRoughness.metallicFactor,t.metallicRoughness.roughnessFactor,t.isSchematic?.2:.5],e.emissiveFactor=t.emissiveFactor,e.usePBR=o._usePBR(t.isSchematic),e.isIntegratedMesh=o._isIntegratedMesh,e.alphaCutoff="mask"===t.alphaMode?t.alphaCutoff:te.defaultMaskAlphaCutoff,e.alphaDiscardMode="opaque"===t.alphaMode?1:"mask"===t.alphaMode?2:3;var a=o._stage.renderView.textureRepository,s=n(33);s&&(e.baseColorTexture=new ee.RenderTexture(a,s));var l=n(2);l&&(e.metallicRoughnessTexture=new ee.RenderTexture(a,l));var c=n(16);c&&(e.emissionTexture=new ee.RenderTexture(a,c));var u=n(8);u&&(e.occlusionTexture=new ee.RenderTexture(a,u));var h=n(4);h&&(e.normalTexture=new ee.RenderTexture(a,h)),e.commonMaterialParameters.slicePlaneEnabled=o.slicePlaneEnabled,e.commonMaterialParameters.doubleSided=t.doubleSided,e.commonMaterialParameters.cullFace=t.cullFace,o._updateMaterialOverlay(e)}))},i.prototype._getGeometryParameters=function(e){return{textureCoordinates:e.hasTexture?e.hasRegions?2:1:0,colors:this._hasVertexColors,normals:e.hasNormals&&!this._isIntegratedMesh}},i.prototype._addData=function(e,t,i){var o=this,a=this._addTasks.get(e.index);return a?a.attributeInfo=t:(a=r.__assign(r.__assign({},h.createResolver()),{attributeInfo:t,meta:null}),this._addTasks.set(e.index,a),i().then(a.resolve,a.reject).then((function(){return o._addTasks.delete(e.index)})).catch((function(t){throw o._addTasks.delete(e.index),t}))),a.promise},i.prototype._clearAddTasks=function(){var e=this;this._addTasks.forEach((function(t){c.isSome(t.meta)&&(e._deleteComponentObject(t.meta),t.meta=null)})),this._addTasks.clear()},i.prototype._clippingAreaChanged=function(){var e=C.create();Q.projectToBoundingBox(this.view.clippingArea,e,this.view.renderSpatialReference)?this._clippingArea=e:this._clippingArea=null,this._filterChange(),this._controller&&this._controller.updateClippingArea(this.view.clippingArea)},i.prototype._filterChange=function(){this._applyFilters(!1)},i.prototype._applyFilters=function(e){var t=this;this._filters=this.getFilters(),e?this._controller&&this._controller.requestUpdate():this._nodeId2Meta.forEach((function(e){c.isSome(e)&&t._applyFiltersToNode(e)&&(t._addOrUpdateEdgeRendering(e),t.visibleGeometryChanged(e))}))},i.prototype.getFilters=function(){var e=this,t=[];return this._clippingArea&&t.push((function(t,r){return e._boundingboxFilter(t,r,e._clippingArea)})),t},i.prototype.addSqlFilter=function(e,t,r,i){var o=this;t&&r&&e.push((function(e,a){return o._sqlFilter(e,a,t,r,i)}))},i.prototype._sqlFilter=function(e,t,r,i,o){var a={},n=this._createLayerGraphic(a),s=this.i3slayer.objectIdField,l=t.featureIds,d=c.isSome(t.attributeInfo)&&t.attributeInfo.attributeData;i.every((function(e){return null!=d[e]||e===s}))&&q.filterInPlace(e,l,(function(e){a[s]=l[e];for(var t=0,c=i;t<c.length;t++){var u=c[t];u!==s&&(a[u]=q.getCachedAttributeValue(d[u],e))}try{if(Array.isArray(r)){for(var h=0,p=r;h<p.length;h++){if(p[h].testFeature(n))return!0}return!1}return r.testFeature(n)}catch(e){return o(e),!1}}))},i.prototype._boundingboxNodeTest=function(e,t){return Y.mbsToMbs(e.node.mbs,this._controller.crsIndex,he,this.view.renderSpatialReference),q.intersectBoundingBoxWithMbs(t,he)},i.prototype._boundingboxFeatureTest=function(e,t,r){return C.intersects(r,this._collection.getComponentAabb(e.objectHandle,t,se))},i.prototype._boundingboxFilter=function(e,t,r){var i=this,o=this._collection,a=this._boundingboxNodeTest(t,r);if(3!==a)if(0!==a){var n=o.getComponentCount(t.objectHandle);if(n.invisible+n.visible===t.featureIds.length){var s=this._transformAABB(le,r,t.objectHandle);q.filterInPlace(e,t.featureIds,(function(e){return i._boundingboxFeatureTest(t,e,s)}))}}else e.length=0},i.prototype._transformAABB=function(e,t,r){var i=this._collection.getObjectTransform(r),o=i.position,a=i.rotationScale;return e[0]=(t[0]-o[0])/a[0],e[1]=(t[1]-o[1])/a[4],e[2]=(t[2]-o[2])/a[8],e[3]=(t[3]-o[0])/a[0],e[4]=(t[4]-o[1])/a[4],e[5]=(t[5]-o[2])/a[8],e},i.prototype._addOrUpdateEdgeRendering=function(e,t){if(void 0===t&&(t=!0),!this._edgeView)return h.resolve(!1);var r=e.objectHandle,i=this._edgeView.hasObject(r),o=this._getFilteredEdgeMaterials(e),a=o.hasEdges,n=o.perFeatureEdgeMaterials,s={slicePlaneEnabled:this.slicePlaneEnabled};return a?i?(this._edgeView.updateAllComponentMaterials(r,n,s,t),this._edgeView.updateObjectVisibility(r,!0),h.resolve(!0)):this._collection.addEdges(r,this._edgeView,n,s).then((function(){return!0})):(i&&this._edgeView.removeObject(r),h.resolve(!1))},i.prototype._removeEdgeRendering=function(e){this._edgeView&&this._edgeView.hasObject(e.objectHandle)&&this._edgeView.removeObject(e.objectHandle)},i.prototype._applyFiltersToNode=function(e){return!!this._applyFiltersToNodeComponents(e)&&(c.isSome(this._labeler)&&this._labeler.applyFilterChange(e),!0)},i.prototype._applyFiltersToNodeComponents=function(e){var t=this._collection,r=0===t.getComponentCount(e.objectHandle).invisible;if(t.setAllComponentVisibilities(e.objectHandle,"all"),0===this._filters.length)return e.filteredIds=null,!r;if(this._updateCachedFilteredIds(e),e.filteredIds===e.featureIds)return!r;var i=this._computeFilteredComponentIndices(e);return t.setAllComponentVisibilities(e.objectHandle,i),!0},i.prototype._updateCachedFilteredIds=function(e){null!=e.filteredIds&&e.appliedFilters===this._filters||(e.filteredIds=this._computeFilteredIds(e),e.appliedFilters=this._filters)},i.prototype._computeFilteredIds=function(e){for(var t=e.featureIds.slice(),r=0,i=this._filters;r<i.length;r++){if((0,i[r])(t,e),0===t.length)break}return t.length===e.featureIds.length?e.featureIds:t},i.prototype._computeFilteredComponentIndices=function(e){var t=new Array;return e.featureIds.forEach((function(r,i){e.filteredIds[t.length]===r&&t.push(i)})),t},i.prototype._removeAllNodeDataFromStage=function(e){var t=this;void 0===e&&(e=this.elevationOffset),this._nodeId2Meta.forEach((function(r,i){return t._removeNodeStageData(i,e)})),this._nodeId2MetaReloading.forEach((function(r,i){return t._removeNodeStageData(i,e,t._nodeId2MetaReloading)}))},i.prototype.removeNode=function(e){var t=this.elevationOffset;this._removeNodeStageData(e,t),this._removeNodeStageData(e,t,this._nodeId2MetaReloading)},i.prototype._removeNodeStageData=function(e,t,r){void 0===r&&(r=this._nodeId2Meta);var i=r.get(e);c.isNone(i)?r.delete(e):(this._collection.setObjectVisibility(i.objectHandle,!1),this.visibleGeometryChanged(i),this._removeEdgeRendering(i),c.isSome(this._labeler)&&this._labeler.removeNodeMeta(i),r.delete(e),this._highlights.objectDeleted(i),r===this._nodeId2Meta?this._cacheGPUData(i,t):this._deleteComponentObject(i),this._treeDebugger&&this._treeDebugger.update())},i.prototype._deleteComponentObject=function(e){if(this._edgeView&&this._edgeView.removeObject(e.objectHandle),this.memEstimateGeometryRemoved(e.objectHandle),this._collection.destroyObject(e.objectHandle),e.textures)for(var t=0,r=e.textures;t<r.length;t++){var i=r[t];this.memEstimateTextureRemoved(i),this._stage.remove(4,i.id)}},i.prototype.updateNodeState=function(e,t){var r=this._nodeId2Meta.get(e);c.isSome(r)&&this._collection.updateMaterial(r.objectHandle,(function(e){return e.polygonOffsetEnabled=0===t}))},i.prototype._invalidateAllSymbols=function(){this._rendererVersion=q.addWraparound(this._rendererVersion,1),this._controller&&this._controller.requestUpdate()},i.prototype._getInvalidRendererVersion=function(){return q.addWraparound(this._rendererVersion,-1)},i.prototype._rendererChange=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,i,o,a,n,s,l,d,c,u;return r.__generator(this,(function(r){switch(r.label){case 0:return this._currentRenderer=e,this.notifyChange("rendererTextureUsage"),this._rendererVersion=q.addWraparound(this._rendererVersion,1),this._rendererFields=null,this._colorVariable=null,this._opacityVariable=null,this._invalidateAllSymbols(),e?(t=this,i=w.fixFields,o=[this.i3slayer.fields],[4,e.getRequiredFields(this.i3slayer.fields)]):[3,2];case 1:t._rendererFields=i.apply(void 0,o.concat([r.sent()])),r.label=2;case 2:return this._updateSymbologyFields(),!this._arcade&&e&&"arcadeRequired"in e&&e.arcadeRequired?(a=this,[4,F.loadArcade()]):[3,4];case 3:a._arcade=r.sent(),r.label=4;case 4:if(e&&"visualVariables"in e&&e.visualVariables)for(n=0,s=e.visualVariables;n<s.length;n++)"color"===(l=s[n]).type?this._colorVariable=l:"opacity"===l.type?this._opacityVariable=l:oe.warn("Unsupported visual variable type for 3D Object Scene Services: "+l.type);if(e)for(d=0,c=e.getSymbols();d<c.length;d++)"mesh-3d"!==(u=c[d]).type&&oe.error("Symbols of type '"+u.type+"' are not supported for 3D Object Scene Services.");return this._controller&&this._controller.requestUpdate(),[2]}}))}))},i.prototype._getCachedEdgeMaterials=function(e){return this._hasSymbolColors&&e.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(e),e.cachedEdgeMaterials},i.prototype._getSymbolColors=function(e){this._hasSymbolColors&&e.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(e);var t=e.cachedSymbology;return function(e,r){var i=5*e;x.vec4.set(r.externalColor,t[i+0]/255,t[i+1]/255,t[i+2]/255,t[i+3]/255),r.externalColorMixMode=15&t[i+4],r.castShadows=0!=(16&t[i+4]),r.pickable=0!=(32&t[i+4])}},i.prototype._getSymbolInfo=function(e,t){var r=e&&e.getSymbol(t,{arcade:this._arcade});if(!(r instanceof T))return null;var i=r.id;if(this._symbolInfos.has(i))return this._symbolInfos.get(i);var o=q.getSymbolInfo(r);return this._symbolInfos.set(i,o),o},i.prototype._setSymbologyOverride=function(e,t){this._symbologyOverride!==e&&(this._symbologyOverride=e,this._symbologyOverrideFields=t,this._invalidateAllSymbols(),this._updateSymbologyFields())},i.prototype._updateSymbologyFields=function(){this._symbologyFields=c.isSome(this._symbologyOverrideFields)&&this._symbologyOverrideFields.length>0?c.isSome(this._rendererFields)&&this._rendererFields.length>0?w.fixFields(this.i3slayer.fields,r.__spreadArrays(this._rendererFields,this._symbologyOverrideFields)):this._symbologyOverrideFields:this._rendererFields},i.prototype._updateCachedRendererData=function(e){if(e.cachedRendererVersion=this._rendererVersion,this._hasSymbolColors){var t=this._tmpAttributeOnlyGraphic,i={};t.attributes=i;var o=this._currentRenderer,a=c.isSome(e.attributeInfo)&&e.attributeInfo.attributeData,n=null!=e.featureIds?this.i3slayer.objectIdField:null,s=null!=a&&c.isSome(this._symbologyFields)&&this._symbologyFields.length>0,l=s?[]:null,d=s?[]:null;if(s&&c.isSome(this._symbologyFields))for(var u=0,h=this._symbologyFields;u<h.length;u++){var p=h[u],f=a[p];f&&(l.push(p),d.push(f))}e.cachedSymbology||(e.cachedSymbology=new Uint8Array(5*e.featureIds.length));for(var _={color:ce,castShadows:!0,pickable:!0,colorMixMode:1,edgeMaterial:null},g=this.fullOpacity,m=null,y=2,b=q.transparentEdgeMaterial,v=0,M=0;M<e.featureIds.length;M++){if(null!=n&&(i[n]=e.featureIds[M]),s)for(var I=0;I<l.length;I++)i[l[I]]=q.getCachedAttributeValue(d[I],M);var S=this._getSymbolInfo(o,t),x=null,C=null;if(o&&"visualVariables"in o){if(this._colorVariable){var O=D.getColor(this._colorVariable,t,{color:ue,arcade:this._arcade});O&&((x=ce)[0]=O.r/255,x[1]=O.g/255,x[2]=O.b/255,this._opacityVariable||null===O.a||(C=O.a))}this._opacityVariable&&(C=D.getOpacity(this._opacityVariable,t,{arcade:this._arcade}))}if(S&&S.material){var w=S.material;x=c.isNone(x)||c.isNone(C)?P.overrideColor(x,C,w.color,w.alpha,ae,ce):P.overrideColor(x,C,null,null,ae,ce)}if(c.isNone(x)&&((x=ce)[0]=1,x[1]=1,x[2]=1,x[3]=1),_.pickable=!0,_.castShadows=!S||S.castShadows,_.colorMixMode=S&&S.material?S.material.colorMixMode:1,_.edgeMaterial=S?S.edgeMaterial:null,c.isSome(this._symbologyOverride)&&(_.color=x,this._symbologyOverride(t,_),x=_.color),c.isSome(_.edgeMaterial)){var E=x[3]<=0?0:x[3]>=1&&(e.material.isOpaque||3===_.colorMixMode)?2:1;_.edgeMaterial===m&&E===y||(b=r.__assign(r.__assign({},_.edgeMaterial),{opacity:g,objectTransparency:E}),m=_.edgeMaterial,y=E),e.cachedEdgeMaterials[M]=b}else e.cachedEdgeMaterials[M]=q.transparentEdgeMaterial;e.cachedSymbology[v+0]=Math.round(255*x[0]),e.cachedSymbology[v+1]=Math.round(255*x[1]),e.cachedSymbology[v+2]=Math.round(255*x[2]),e.cachedSymbology[v+3]=Math.round(255*x[3]),e.cachedSymbology[v+4]=_.colorMixMode|+_.castShadows<<4|+_.pickable<<5,v+=5}}},i.prototype._getFilteredEdgeMaterials=function(e){var t=this,r=this._getCachedEdgeMaterials(e);if(r.forEach((function(e){return e.opacity=t.fullOpacity})),c.isNone(e.filteredIds))return{hasEdges:r.some((function(e){return e!==q.transparentEdgeMaterial})),perFeatureEdgeMaterials:r};var i=0,o=!1,a=r.map((function(t,r){return e.featureIds[r]!==e.filteredIds[i]?q.transparentEdgeMaterial:(o=o||t!==q.transparentEdgeMaterial,i++,t)}));return{hasEdges:o,perFeatureEdgeMaterials:a}},i.prototype._setObjectSymbolColors=function(e){if(this._hasSymbolColors){var t=e.objectHandle,r=this._getSymbolColors(e);this._collection.setComponentData(t,r),this._stage.renderView.setNeedsRender()}},i.prototype._reloadAll=function(e){void 0===e&&(e=this.elevationOffset),this._removeAllNodeDataFromStage(e),null!=this._controller&&this._controller.restartNodeLoading()},i.prototype._opacityChange=function(e){var t=this;this._crossfadeHelper.stopAllNodeFading(),this._nodeId2Meta.forEach((function(r){c.isNone(r)||(t._collection.updateMaterial(r.objectHandle,(function(t){return t.objectOpacity=e})),r.cachedEdgeMaterials.forEach((function(t){return t.opacity=e})),t._updateEdgeRendering(r))}))},i.prototype._updateMaterial=function(e){var t=this;this._collection.updateMaterial(e.objectHandle,(function(r){r.commonMaterialParameters.slicePlaneEnabled=t.slicePlaneEnabled,r.usePBR=t._usePBR(e.material.isSchematic),t._updateMaterialOverlay(r)}))},i.prototype._updateMaterialOverlay=function(e){},i.prototype._updateEngineObject=function(e){this._setObjectSymbolColors(e),this._applyFiltersToNode(e),this._addOrUpdateEdgeRendering(e),this.visibleGeometryChanged(e)},i.prototype._slicePlaneEnabledChange=function(e){var t=this;this._intersectionHandler&&(this._intersectionHandler.slicePlane=e),c.isSome(this._labeler)&&(this._labeler.slicePlaneEnabled=e),this._nodeId2Meta.forEach((function(r){c.isNone(r)||(t._collection.updateMaterial(r.objectHandle,(function(t){t.commonMaterialParameters.slicePlaneEnabled=e})),t._updateEdgeRendering(r,!1))}))},i.prototype._updatePBR=function(){var e=this;this._nodeId2Meta.forEach((function(t){c.isNone(t)||e._collection.updateMaterial(t.objectHandle,(function(r){r.usePBR=e._usePBR(t.material.isSchematic)}))}))},i.prototype._usePBR=function(e){return!this._isIntegratedMesh&&(!e||this.view.qualitySettings.physicallyBasedRenderingEnabled)},i.prototype._updateEdgeRendering=function(e,t){void 0===t&&(t=!0),this._edgeView&&this._edgeView.hasObject(e.objectHandle)&&this._addOrUpdateEdgeRendering(e,t)},i.prototype._forAllNodes=function(e){this._nodeId2Meta.forEach(e)},i.prototype._forAllFeatures=function(e,t,r){var i=this;void 0===r&&(r=0),l.someMap(this._nodeId2Meta,(function(o){if(c.isNone(o))return!1;if(c.isSome(t))switch(t(o)){case 0:return!0;case 2:return!1}var a=1;switch(r){case 1:a=i._forAllFeaturesOfNode(o,e);break;case 0:a=i._forVisibleFeaturesOfNode(o,e);break;case 2:a=i._forAllFeaturesOfNodeInClippingArea(o,e)}return 0===a}))},i.prototype._forAllFeaturesOfNode=function(e,t){for(var r=1,i=e.featureIds,o=0;o<i.length;o++)if(0===(r=t(i[o],o,e)))return r;return r},i.prototype._forVisibleFeaturesOfNode=function(e,t){var r=1,i=e.featureIds;return this._collection.forEachVisibleComponent(e.objectHandle,(function(o){return 1===(r=t(i[o],o,e))})),r},i.prototype._forAllFeaturesOfNodeInClippingArea=function(e,t){if(null==this._clippingArea)return this._forAllFeaturesOfNode(e,t);var r=this._boundingboxNodeTest(e,this._clippingArea);if(0===r)return 1;if(3===r)return this._forAllFeaturesOfNode(e,t);for(var i=e.featureIds,o=e.objectHandle,a=q.getClipAABB(this._clippingArea,this._collection.getObjectTransform(o)),n=0;n<i.length;n++)if(this._boundingboxFeatureTest(e,n,a)){var s=t(i[n],n,e);if(0===s)return s}return 1},i.prototype._createAttributes=function(e,t){var r={};null!=t.featureIds&&(r[this._getObjectIdField()]=t.featureIds[e]);var i=c.isSome(t.attributeInfo)&&t.attributeInfo.attributeData;if(c.isSome(i))for(var o=0,a=Object.keys(i);o<a.length;o++){var n=a[o];r[n]=q.getCachedAttributeValue(i[n],e)}return r},i.prototype._createGraphic=function(e,t){return this._createLayerGraphic(this._createAttributes(e,t))},i.prototype.highlight=function(e){var t=this,r=this._highlights;if("number"==typeof e?e=[e]:e instanceof o?e=[e]:e instanceof a&&(e=e.toArray()),Array.isArray(e)&&e.length>0){if(e[0]instanceof o){var i=e.map((function(e){return W.attributeLookup(e.attributes,t._getObjectIdField())})),n=r.acquireSet(),s=n.set,l=n.handle;return r.setFeatureIds(s,i),l}if("number"==typeof e[0]){i=e;var d=r.acquireSet();s=d.set,l=d.handle;return r.setFeatureIds(s,i),l}}return me},i.prototype.visibleGeometryChanged=function(e){var t=this;this._elevationProvider&&(this._elevationProvider.objectChanged(e.node),null==this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle=p.schedule((function(){t.emit("visible-geometry-changed"),t._visibleGeometryChangedSchedulerHandle=null}))))},Object.defineProperty(i.prototype,"performanceInfo",{get:function(){var e={displayedNumberOfFeatures:0,maximumNumberOfFeatures:0,totalNumberOfFeatures:0,core:null,index:0,nodes:this._nodeId2Meta.size,"Total GPU Memory Estimate":(this.gpuMemoryEstimate/1048576).toFixed(1)+"MB","Geometry Memory Estimate":(this.geoMemoryEstimate/1048576).toFixed(1)+"MB","Texture Memory Estimate":(this.texMemoryEstimate/1048576).toFixed(1)+"MB"};return this._controller&&(this._idbCacheEnabled&&(e.IDBCache=Math.round(100*this._idbCache.getHitRate())+"% hit"),this._controller.updateStats(e)),e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"test",{get:function(){var e=this;return{controller:this._controller,labeler:this._labeler,get visibleObjectIds(){var t=[];return e._forAllFeatures((function(e){return t.push(e),1}),null,0),t.sort((function(e,t){return e-t})),t},get numNodes(){return e._nodeId2Meta.size}}},enumerable:!1,configurable:!0}),i.prototype.getNodeOpacityByIndex=function(e){var t=this._nodeId2Meta.get(e);return this.getNodeOpacity(t)},i.prototype.getNodeOpacity=function(e){var t=0;return c.isSome(e)&&this._collection.updateMaterial(e.objectHandle,(function(e){t=e.objectOpacity})),t},i.prototype.getNodeCrossfadeMetaData=function(e){var t;return null===(t=this._nodeId2Meta)||void 0===t?void 0:t.get(e)},i.prototype.markNodeToRemove=function(e){var t=this._controller;t&&t.markNodeToRemove(e)},i.prototype.removeMarkedNodes=function(){var e=this._controller;e&&e.removeMarkedNodes()},i.prototype.foreachCrossfadeNode=function(e){var t=this._nodeId2Meta;t&&t.forEach((function(t,r){return e(r,t)}))},i.prototype.setNodeOpacityByIndex=function(e,t){var r=this._nodeId2Meta.get(e);c.isSome(r)&&this.setNodeOpacity(r,t)},i.prototype.setNodeOpacity=function(e,t){this._collection.updateMaterial(e.objectHandle,(function(e){e.objectOpacity=t})),this.setNodeEdgeOpacity(e,t)},i.prototype.setNodeEdgeOpacity=function(e,t){var r=this._getFilteredEdgeMaterials(e);if(r.hasEdges){for(var i=0,o=r.perFeatureEdgeMaterials;i<o.length;i++){o[i].opacity=t}this._addOrUpdateEdgeRendering(e)}},Object.defineProperty(i.prototype,"_hasModifications",{get:function(){return this._modifications&&this._modifications.length>0},enumerable:!1,configurable:!0}),i.prototype.updateNodeModificationStatus=function(e){var t=this,r=e.length;if(!(!this._hasModifications||r<=0||c.isNone(this._i3sModule)||this._i3sModule instanceof Promise)){var i=this.i3slayer.uid,o=function(e){if(0===e.length)return null;var t=10*e.length,r=new Float64Array(t);return e.forEachSimple((function(e,t){var i=e.serviceObb;c.isNone(i)&&(i=de,I.vec3.copy(i.center,e.mbs),i.halfSize[0]=i.halfSize[1]=i.halfSize[2]=e.mbs[3]);var o=10*t;r[o+0]=i.center[0],r[o+1]=i.center[1],r[o+2]=i.center[2],r[o+3]=i.halfSize[0],r[o+4]=i.halfSize[1],r[o+5]=i.halfSize[2],r[o+6]=i.quaternion[0],r[o+7]=i.quaternion[1],r[o+8]=i.quaternion[2],r[o+9]=i.quaternion[3]})),r}(e);if(c.isSome(o)){var a={context:i,buffer:o.buffer};this._i3sModule.filterObbsForModificationsSync(a);var n=new Float64Array(o.buffer);e.forEachSimple((function(e,r){var i=n[r],o=V.interpretObbModificationResults(i);e.imModificationImpact=o,0!==o&&t._controller.invalidateGeometryVisibility(e.index)}))}}},i.prototype.notifyUpdate=function(){this.notifyChange("updating")},i.prototype.isUpdating=function(){return!(!this._controller||!this._controller.updating)||!!this._visibleGeometryChangedSchedulerHandle||c.isSome(this._labeler)&&this._labeler.updating||this._crossfadeHelper.numFadingNodes>0||this._asyncModuleLoading>0},r.__decorate([m.property({readOnly:!0})],i.prototype,"lodCrossfadeDuration",null),r.__decorate([m.property({})],i.prototype,"_asyncModuleLoading",void 0),r.__decorate([m.property()],i.prototype,"_visibleGeometryChangedSchedulerHandle",void 0),r.__decorate([m.property()],i.prototype,"view",void 0),r.__decorate([m.property()],i.prototype,"i3slayer",void 0),r.__decorate([m.property()],i.prototype,"_controller",void 0),r.__decorate([m.property()],i.prototype,"_labeler",void 0),r.__decorate([m.property({dependsOn:["_controller.updating","_visibleGeometryChangedSchedulerHandle","_labeler.updating","_asyncModuleLoading"]})],i.prototype,"updating",void 0),r.__decorate([m.property({dependsOn:["_controller.rootNodeVisible"]})],i.prototype,"suspended",void 0),r.__decorate([m.property()],i.prototype,"holeFilling",void 0),r.__decorate([m.property(K.updatingProgress)],i.prototype,"updatingProgress",void 0),r.__decorate([m.property({readOnly:!0,aliasOf:"_controller.updatingProgress"})],i.prototype,"updatingProgressValue",void 0),r.__decorate([m.property({readOnly:!0})],i.prototype,"hasTexturesOrVertexColors",null),r.__decorate([m.property({readOnly:!0})],i.prototype,"rendererTextureUsage",null),r.__decorate([m.property({readOnly:!0,dependsOn:["i3slayer.elevationInfo"]})],i.prototype,"elevationOffset",null),r.__decorate([m.property({type:Boolean})],i.prototype,"slicePlaneEnabled",void 0),r.__decorate([m.property({dependsOn:["view.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled","useCompressedTextures"]})],i.prototype,"uncompressedTextureDownsamplingEnabled",null),r.__decorate([m.property({dependsOn:["i3slayer.version"]})],i.prototype,"useCompressedTextures",null),r.__decorate([m.property({type:[N]})],i.prototype,"_modifications",void 0),i=r.__decorate([m.subclass("esri.views.3d.layers.I3SMeshView3D")],i)}(t)};var se=C.create(),le=C.create(),de=X.create(),ce=[0,0,0,0],ue=new i([0,0,0,0]),he=[0,0,0,0];function pe(e){var t=e.metallicRoughness;return t&&t.baseColorTextureId>=0||t&&t.metallicRoughnessTextureId>=0||e.normalTextureId>=0||e.emissiveTextureId>=0||e.occlusionTextureId>=0}function fe(e){return c.isSome(e)&&f.isArrayBuffer(e.data)}function _e(e,t){var r=1024+e.interleavedVertexData.byteLength+(e.indices?e.indices.byteLength:0)+e.positionData.data.byteLength+e.positionData.indices.byteLength;if(c.isSome(t))for(var i=0,o=t;i<o.length;i++){var a=o[i];c.isSome(a)&&f.isArrayBuffer(a.data)&&(r+=a.data.byteLength)}return r}function ge(e,t){return t.byteSize>104857600?(oe.warn("Node is too big to store in IndexedDB cache: "+e.id+" ("+t.byteSize+" bytes)"),!1):t.byteSize>0}var me={remove:function(){},pause:function(){},resume:function(){}}}));