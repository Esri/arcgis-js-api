/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../geometry","../../../core/Error","../../../core/Handles","../../../core/Logger","../../../core/maybe","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec3","../../../chunks/vec3f64","../../../geometry/projection","../../../geometry/support/aaBoundingBox","../../../geometry/support/spatialReferenceUtils","./LayerView3D","./support/PopupSceneLayerView","../../layers/LayerView","../../webgl/context-util","../../../geometry/SpatialReference"],(function(e,s,t,i,o,a,r,n,l,c,h,u,d,m,y,p,b,S,w,_,f,V){"use strict";var v;!function(e){e[e.API=1]="API",e[e.VerboseAPI=2]="VerboseAPI",e[e.Error=3]="Error"}(v||(v={}));const W=m.create(),g=m.create();let x=function(s){function t(){var e;return(e=s.apply(this,arguments)||this)._suspendedHandle=null,e._usedMemory=0,e._futureMemory=0,e.type="voxel-3d",e.slicePlaneEnabled=!1,e._wasmLayerId=-1,e._handles=new o,e._dbgFlags=new Set,e}e._inheritsLoose(t,s);var l=t.prototype;return l.initialize=function(){if(this._dbgFlags.add(v.Error),"local"!==this.view.viewingMode)throw new i("voxel:unsupported-viewingMode","Voxel layers support local viewingMode only.",{});if(this.view._stage.renderView.renderingContext.type!==f.ContextType.WEBGL2)throw new i("voxel:unsupported-context","Voxel layers are supported in WebGL2 rendering contexts only.",{});if(!!!this.view._stage.renderView.renderingContext.capabilities.colorBufferFloat?.textureFloat)throw new i("voxel:missing-color-buffer-float","Voxel layers require the WebGL2 extension EXT_color_buffer_float",{});const e=this.layer.spatialReference;if(!b.equals(e,this.view.spatialReference))throw new i("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});const s=this.layer.currentVariableId,t=this.layer.getVolume(s),o=this.layer.getVariable(s);if(r.isSome(t)&&r.isSome(o)){const e=t.dimensions[0],s=t.dimensions[1],i=t.zDimension;if(i>1){const a=t.dimensions[i],r=e.size*s.size*a.size;let n=1;switch(o.renderingFormat.type){case"Int16":case"UInt16":n=2;break;case"Int32":case"UInt32":case"Float32":n=4}this._futureMemory=n*r}}const a=this.view.addVoxelLayerViewToWasm(this).then((e=>{this._wasmLayerId=e,this._suspendedHandle=n.watch((()=>this.suspended),(e=>{const s=this.view.voxelWasm;r.isSome(s)&&s.setEnabled(this,!e)}),n.initial),this._handles.add([n.watch((()=>this.layer.renderMode),(e=>this._pushRenderModeToWasm(e))),n.watch((()=>this.layer.currentVariableId),(e=>this._pushCurrentVariableIdToWasm(e))),n.watch((()=>this.layer.getSections()),(e=>this._pushSectionsToWasm(e))),n.watch((()=>this.layer.getVariableStyles()),(e=>this._pushVariableStylesToWasm(e))),n.watch((()=>this.layer.getVolumeStyles()),(e=>this._pushVolumeStylesToWasm(e))),n.watch((()=>this.layer.enableDynamicSections),(e=>this._pushEnableDynamicSectionsToWasm(e))),n.watch((()=>this.layer.enableIsosurfaces),(e=>this._pushEnableIsosurfacesToWasm(e))),n.watch((()=>this.layer.enableSections),(e=>this._pushEnableSectionsToWasm(e))),n.watch((()=>this.layer.enableSlices),(e=>this._pushEnableSlicesToWasm(e))),n.watch((()=>this.slicePlaneEnabled),(e=>this._pushAnalysisSliceToWasm(e,this.view.slicePlane))),n.watch((()=>this.view.slicePlane),(e=>this._pushAnalysisSliceToWasm(this.slicePlaneEnabled,e)))])})).catch((e=>{if(this.view.removeVoxelLayerViewFromWasm(this),this._wasmLayerId=-1,-1===e)throw new i("voxel:addLayer-failure","The voxel layer description was invalid.",{});if(-2===e)throw new i("voxel:addLayer-failure","The voxel layer web assembly module failed to download.",{})}));this.addResolvingPromise(a)},l.destroy=function(){this.view.removeVoxelLayerViewFromWasm(this),this._suspendedHandle&&(this._suspendedHandle.remove(),this._suspendedHandle=null),this._handles=r.destroyMaybe(this._handles)},l.isUpdating=function(){const e=this.view.voxelWasm;return!(this._wasmLayerId<0||!r.isSome(e))&&e.isUpdating(this._wasmLayerId)},l.updatingFlagChanged=function(){this.notifyChange("updating")},l.getUsedMemory=function(){return this._usedMemory},l.getUnloadedMemory=function(){return this._futureMemory},l.ignoresMemoryFactor=function(){return!0},l.whenGraphicBounds=function(e,s){const t=e.attributes["Voxel.WorldPosition"];if(t){const e=p.empty(),s=JSON.parse(t);if(y.projectVectorToVector(s,this.view.renderSpatialReference,g,this.view.spatialReference||V.WGS84))return p.expandWithVec3(e,g),Promise.resolve({boundingBox:e,screenSpaceObjects:[]})}return Promise.reject()},l.setUsedMemory=function(e){this._usedMemory=e,this._futureMemory=0},l.captureFrustum=function(){const e=this.view.voxelWasm;r.isSome(e)&&e.captureFrustum()},l.toggleFullVolumeExtentDraw=function(){const e=this.view.voxelWasm;r.isSome(e)&&e.toggleFullVolumeExtentDraw(this)},l.getLayerTimes=function(){let e=[];const s=this.view.voxelWasm;return r.isSome(s)&&(e=s.getLayerTimes(this)),e},l.getCurrentLayerTimeIndex=function(){let e=0;const s=this.view.voxelWasm;return r.isSome(s)&&(e=s.getCurrentLayerTimeIndex(this)),e},l._pushRenderModeToWasm=function(e){const s=this.view.voxelWasm;this._dbg(v.VerboseAPI,"VoxelLayerView3D._pushRenderModeToWasm() called, "+(r.isSome(s)?"have WASM":"don't have WASM!!!"));!!r.isSome(s)&&s.setRenderMode(this,e)||this._dbg(v.Error,"VoxelLayerView3D._pushRenderModeToWasm() failed!")},l._pushSectionsToWasm=function(e){const s=this.view.voxelWasm;this._dbg(v.VerboseAPI,"VoxelLayerView3D._pushSectionsToWasm() called, "+(r.isSome(s)?"have WASM":"don't have WASM!!!"));!!r.isSome(s)&&s.setStaticSections(this,e)||this._dbg(v.Error,"VoxelLayerView3D._pushSectionsToWasm() failed!")},l._pushCurrentVariableIdToWasm=function(e){const s=this.view.voxelWasm;this._dbg(v.VerboseAPI,"VoxelLayerView3D._pushCurrentVariableIdToWasm() called!, "+(r.isSome(s)?"have WASM":"don't have WASM!!!"));!!r.isSome(s)&&s.setCurrentVariable(this,e)||this._dbg(v.Error,"VoxelLayerView3D._pushCurrentVariableIdToWasm() failed!")},l._pushVariableStylesToWasm=function(e){const s=this.view.voxelWasm;this._dbg(v.VerboseAPI,"VoxelLayerView3D._pushVariableStylesToWasm() called, "+(r.isSome(s)?"have WASM":"don't have WASM!!!"));let t=!1;r.isSome(s)&&(t=s.setVariableStyles(this,e),t||this._dbg(v.Error,"VoxelLayerView3D._pushVariableStylesToWasm() failed!"))},l._accountForEnableSlices=function(e,s){const t=r.isSome(s)?s:this.layer.enableSlices;for(let i=0;i<e.length;++i){const s=e[i];for(const e of s.slices)e.enabled=e.enabled&&t}},l._pushVolumeStylesToWasm=function(e){const s=this.view.voxelWasm;this._dbg(v.VerboseAPI,"VoxelLayerView3D._pushVolumeStylesToWasm() called, "+(r.isSome(s)?"have WASM":"don't have WASM!!!"));let t=!1;r.isSome(s)&&(this._accountForEnableSlices(e,null),t=s.setVolumeStyles(this,e),t||this._dbg(v.Error,"VoxelLayerView3D._pushVolumeStylesToWasm() failed!"))},l._pushAnalysisSliceToWasm=function(e,s){const t=this.view.voxelWasm;this._dbg(v.VerboseAPI,"VoxelLayerView3D._pushAnalysisSliceToWasm() called, "+(r.isSome(t)?"have WASM":"don't have WASM!!!"));let i=!1;if(r.isSome(t)){if(r.isSome(s)){const o=s.origin;d.cross(W,s.basis1,s.basis2),d.normalize(W,W),i=t.setAnalysisSlice(this,e,o,W)}else d.set(W,0,0,1),i=t.setAnalysisSlice(this,!1,W,W);i||this._dbg(v.Error,"VoxelLayerView3D._pushAnalysisSliceToWasm() failed!")}},l._pushEnableDynamicSectionsToWasm=function(e){const s=this.view.voxelWasm;this._dbg(v.VerboseAPI,"VoxelLayerView3D._pushEnableDynamicSectionsToWasm() called, "+(r.isSome(s)?"have WASM":"don't have WASM!!!"));let t=!1;r.isSome(s)&&(t=s.setEnableDynamicSections(this,e),t||this._dbg(v.Error,"VoxelLayerView3D._pushEnableDynamicSectionsToWasm() failed!"))},l._pushEnableSlicesToWasm=function(e){const s=this.view.voxelWasm;this._dbg(v.VerboseAPI,"VoxelLayerView3D._pushEnableSlicesToWasm() called, "+(r.isSome(s)?"have WASM":"don't have WASM!!!"));let t=!1;if(r.isSome(s)){const i=this.layer.getVolumeStyles();this._accountForEnableSlices(i,e),t=s.setVolumeStyles(this,i),t||this._dbg(v.Error,"VoxelLayerView3D._pushEnableSlicesToWasm() failed!")}},l._pushEnableIsosurfacesToWasm=function(e){const s=this.view.voxelWasm;this._dbg(v.VerboseAPI,"VoxelLayerView3D._pushEnableIsosurfacesToWasm() called, "+(r.isSome(s)?"have WASM":"don't have WASM!!!"));let t=!1;r.isSome(s)&&(t=s.setEnableIsosurfaces(this,e),t||this._dbg(v.Error,"VoxelLayerView3D._pushEnableIsosurfacesToWasm() failed!"))},l._pushEnableSectionsToWasm=function(e){const s=this.view.voxelWasm;this._dbg(v.VerboseAPI,"VoxelLayerView3D._pushEnableSectionsToWasm() called, "+(r.isSome(s)?"have WASM":"don't have WASM!!!"));let t=!1;r.isSome(s)&&(t=s.setEnableSections(this,e),t||this._dbg(v.Error,"VoxelLayerView3D._pushEnableSectionsToWasm() failed!"))},l.whenGraphicAttributes=function(){var s=e._asyncToGenerator((function*(e,s){return e}));function t(e,t){return s.apply(this,arguments)}return t}(),l._dbg=function(e,s){this._dbgFlags.has(e)&&(e===v.Error?a.getLogger(this.declaredClass).error(s):a.getLogger(this.declaredClass).warn(s))},e._createClass(t,[{key:"baseUrl",get:function(){return this.layer.parsedUrl?.path??""}},{key:"wasmLayerId",get:function(){return this._wasmLayerId}},{key:"performanceInfo",get:function(){return{nodes:0,displayedNumberOfFeatures:0,maximumNumberOfFeatures:0,totalNumberOfFeatures:0,core:null}}}]),t}(w.PopupSceneLayerView(S.LayerView3D(_)));s.__decorate([l.property()],x.prototype,"layer",void 0),s.__decorate([l.property()],x.prototype,"baseUrl",null),s.__decorate([l.property({type:Boolean})],x.prototype,"slicePlaneEnabled",void 0),x=s.__decorate([u.subclass("esri.views.3d.layers.VoxelLayerView3D")],x);return x}));
