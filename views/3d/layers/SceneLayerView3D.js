/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../Graphic","../../../core/Logger","../../../core/maybe","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../../core/sql/WhereClause","../../../layers/support/FeatureFilter","../../../layers/support/floorFilterUtils","../../../rest/support/Query","../../../support/featureFlags","./I3SMeshView3D","./II3SMeshView3D","./LayerView3D","./i3s/attributeEditing","./i3s/I3SGeometryUtil","./i3s/I3SMeshViewFilter","./i3s/I3SNode","./i3s/I3SQueryEngine","./i3s/I3SQueryFeatureAdapter","./i3s/I3SQueryFeatureStore","./i3s/I3SUtil","./support/DefinitionExpressionSceneLayerView","./support/fieldProperties","./support/PopupSceneLayerView","./support/SceneLayerViewRequiredFields","../support/updatingProperties","../../layers/SceneLayerView","../../support/Scheduler"],(function(e,t,r,i,s,n,o,l,a,u,d,c,h,p,y,g,f,_,F,S,I,b,w,E,v,m,C,x,Q,A,L,V,j){"use strict";const q=x.defineFieldProperties();let D=function(t){function o(){var e;return(e=t.apply(this,arguments)||this).type="scene-layer-3d",e.progressiveLoadFactor=1,e._elevationContext="scene",e._isIntegratedMesh=!1,e._supportsLabeling=!0,e._interactiveEditingSessions=new Map,e._queryEngine=null,e}e._inheritsLoose(o,t);var l=o.prototype;return l.initialize=function(){this._fieldsHelper=new A.SceneLayerViewRequiredFields({layerView:this}),this.updatingHandles.add((()=>this.layer.rangeInfos),(e=>this._rangeInfosChanged(e)),n.initial),this.updatingHandles.add((()=>this.layer.renderer),(e=>this.updatingHandles.addPromise(this._rendererChange(e))),n.initial);const e=()=>this._filterChange();this.updatingHandles.add((()=>this.parsedDefinitionExpression),e),this.updatingHandles.add((()=>this.filter),e),this.updatingHandles.add((()=>this._floorFilterClause),e),this.updatingHandles.add((()=>this._excludeObjectIdsSorted),e),this.updatingHandles.add((()=>s.isSome(this.viewFilter)?this.viewFilter.sortedObjectIds:null),e),this.updatingHandles.add((()=>s.isSome(this.viewFilter)?this.viewFilter.parsedWhereClause:null),e),this.updatingHandles.add((()=>[s.isSome(this.viewFilter)?this.viewFilter.parsedGeometry:null,s.isSome(this.filter)?this.filter.spatialRelationship:null,s.isSome(this.layer.filter)?this.layer.filter.spatialRelationship:null]),(()=>this._geometryFilterChange())),this.handles.add(this.layer.on("apply-edits",(e=>this.updatingHandles.addPromise(e.result)))),this.handles.add(this.layer.on("edits",(e=>this._handleEdits(e))))},l.destroy=function(){this._fieldsHelper=s.destroyMaybe(this._fieldsHelper)},l._rangeInfosChanged=function(e){null!=e&&e.length>0&&i.getLogger(this.declaredClass).warn("Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.")},l.createQuery=function(){const e={outFields:["*"],returnGeometry:!1,outSpatialReference:this.view.spatialReference};return s.isSome(this.filter)?this.filter.createQuery(e):new p(e)},l.queryExtent=function(e,t){return this._ensureQueryEngine().executeQueryForExtent(this._ensureQuery(e),t?.signal)},l.queryFeatureCount=function(e,t){return this._ensureQueryEngine().executeQueryForCount(this._ensureQuery(e),t?.signal)},l.queryFeatures=function(e,t){return this._ensureQueryEngine().executeQuery(this._ensureQuery(e),t?.signal).then((e=>{if(!e?.features)return e;const t=this.layer;for(const r of e.features)r.layer=t,r.sourceLayer=t;return e}))},l.queryObjectIds=function(e,t){return this._ensureQueryEngine().executeQueryForIds(this._ensureQuery(e),t?.signal)},l._ensureQueryEngine=function(){return this._queryEngine||(this._queryEngine=this._createQueryEngine()),this._queryEngine},l._createQueryEngine=function(){const e=S.createGetFeatureExtent(this.view.spatialReference,this.view.renderSpatialReference,this._collection);return new w.I3SQueryEngine({layerView:this,priority:j.TaskPriority.FEATURE_QUERY_ENGINE,spatialIndex:new v.I3SQueryFeatureStore({featureAdapter:new E.I3SQueryFeatureAdapter({objectIdField:this.layer.objectIdField,attributeStorageInfo:this.layer.attributeStorageInfo,getFeatureExtent:e}),toArray:()=>{const e=new Array;return this._forAllFeatures(((t,r,i)=>(e.push({id:t,index:r,meta:i}),f.ForAllFeaturesReturnType.CONTINUE)),null,f.ForAllFeaturesVisibilityMode.ALL_IN_CLIPPING_AREA),e},forAllFeatures:(e,t)=>this._forAllFeatures(((t,r,i)=>e({id:t,index:r,meta:i})),t,f.ForAllFeaturesVisibilityMode.ALL_IN_CLIPPING_AREA),getFeatureExtent:e,sourceSpatialReference:m.getIndexCrs(this.layer),viewSpatialReference:this.view.spatialReference})})},l.highlight=function(e){const r=this._highlights;if(e instanceof p){const{set:t,handle:i}=r.acquireSet();return this.queryObjectIds(e).then((e=>r.setFeatureIds(t,e))),i}return t.prototype.highlight.call(this,e)},l.createInteractiveEditSession=function(e){return F.createInteractiveEditSession(this._attributeEditingContext,e)},l._createLayerGraphic=function(e){const t=new r(null,null,e);return t.layer=this.layer,t.sourceLayer=this.layer,t},l.canResume=function(){return t.prototype.canResume.call(this)&&(!this._controller||this._controller.rootNodeVisible)},l.getFilters=function(){const e=t.prototype.getFilters.call(this),r=this._excludeObjectIdsSorted;return s.isSome(r)&&e.push((e=>m.objectIdFilter(r,!1,e))),this._floorFilterClause&&this.addSqlFilter(e,this._floorFilterClause,this.logError),this.addSqlFilter(e,this.parsedDefinitionExpression,this.logError),s.isSome(this.viewFilter)&&this.viewFilter.addFilters(e,this.view,this._controller.crsIndex,this._collection),e},l.isUpdating=function(){return t.prototype.isUpdating.call(this)||this.layerFilterUpdating||s.isSome(this.viewFilter)&&this.viewFilter.updating||s.isSome(this.i3sOverrides)&&this.i3sOverrides.updating},l._ensureQuery=function(e){return this._addDefinitionExpressionToQuery(s.isNone(e)?this.createQuery():p.from(e))},l._handleEdits=function(e){y.sceneLayerEditingEnabled()&&F.processGeometryEdits(this._attributeEditingContext,e),F.processAttributeEdits(this._attributeEditingContext,e)},l.computeNodeFiltering=function(e){const t=this.viewFilter;return s.isNone(t)||t.isMBSGeometryVisible(e,this.view.spatialReference,this._controller.crsIndex)?b.NodeFilterImpact.Unmodified:b.NodeFilterImpact.Culled},e._createClass(o,[{key:"i3slayer",get:function(){return this.layer}},{key:"layerPopupEnabled",get:function(){return this.layer.popupEnabled}},{key:"filter",get:function(){return this._get("filter")},set:function(e){this._set("filter",I.I3SMeshViewFilter.checkSupport(e)?e:null)}},{key:"viewFilter",get:function(){const e=this.filter,t=this.layerFilter;if(s.isNone(e)&&s.isNone(t))return null;const r=this._get("viewFilter");return s.isNone(r)?new I.I3SMeshViewFilter({layerFilter:t,viewFilter:e,layerFieldsIndex:this.layer.fieldsIndex,loadAsyncModule:e=>this._loadAsyncModule(e),addSqlFilter:(e,t)=>this.addSqlFilter(e,t,this.logError)}):(r.viewFilter=e,r.layerFilter=t,r)}},{key:"requiredFields",get:function(){return this._fieldsHelper?.requiredFields??[]}},{key:"_floorFilterClause",get:function(){const e=h.getFloorFilterClause(this);return s.isSome(e)?d.WhereClause.create(e,this.layer.fieldsIndex):null}},{key:"_excludeObjectIdsSorted",get:function(){let e=this.layer.excludeObjectIds.toArray();return y.sceneLayerEditingEnabled()&&this.i3sOverrides.geometryChangedObjectIds.length>0&&(e=e.concat(this.i3sOverrides.geometryChangedObjectIds)),e.length?e.sort(((e,t)=>e-t)):null}},{key:"_objectQualitySettings",get:function(){return this.view?.qualitySettings?.sceneService?.object}},{key:"lodFactor",get:function(){return this._objectQualitySettings?.lodFactor??1}},{key:"lodCrossfadeinDuration",get:function(){return this._objectQualitySettings.lodCrossfadeinDuration??0}},{key:"lodCrossfadeoutDuration",get:function(){return this._objectQualitySettings.lodCrossfadeoutDuration??0}},{key:"lodCrossfadeUncoveredDuration",get:function(){return this._objectQualitySettings.lodCrossfadeUncoveredDuration??0}},{key:"updatingProgressValue",get:function(){return this._controller?.updatingProgress??0}},{key:"_attributeEditingContext",get:function(){return{sessions:this._interactiveEditingSessions,fieldsIndex:this.layer.fieldsIndex,objectIdField:this._getObjectIdField(),forEachNode:e=>this._forAllNodes((t=>s.isSome(t)?e(t.node,t.featureIds):null)),attributeStorageInfo:this.i3slayer.attributeStorageInfo,i3sOverrides:this.i3sOverrides,getAttributeData:e=>this.getAttributeData(e),setAttributeData:(e,t)=>this.setAttributeData(e,t),clearMemCache:()=>this.clearMemCache()}}},{key:"hasGeometryFilter",get:function(){const e=this.viewFilter;return s.isSome(e)&&s.isSome(e.parsedGeometry)}}]),o}(g.I3SMeshView3D(C.DefinitionExpressionSceneLayerView(Q.PopupSceneLayerView(_.LayerView3D(V)))));t.__decorate([o.property()],D.prototype,"i3slayer",null),t.__decorate([o.property(L.updatingProgress)],D.prototype,"updatingProgress",void 0),t.__decorate([o.property({type:c})],D.prototype,"filter",null),t.__decorate([o.property({readOnly:!0})],D.prototype,"viewFilter",null),t.__decorate([o.property(q.requiredFields)],D.prototype,"requiredFields",null),t.__decorate([o.property(q.availableFields)],D.prototype,"availableFields",void 0),t.__decorate([o.property()],D.prototype,"_fieldsHelper",void 0),t.__decorate([o.property()],D.prototype,"_floorFilterClause",null),t.__decorate([o.property()],D.prototype,"_excludeObjectIdsSorted",null),t.__decorate([o.property()],D.prototype,"_objectQualitySettings",null),t.__decorate([o.property()],D.prototype,"lodFactor",null),t.__decorate([o.property()],D.prototype,"updatingProgressValue",null),D=t.__decorate([u.subclass("esri.views.3d.layers.SceneLayerView3D")],D);return D}));
