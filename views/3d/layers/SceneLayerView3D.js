/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/has","../../../core/maybe","../../../core/Logger","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass","../../../core/urlUtils","../../../core/uuid","../../../portal/support/resourceExtension","../../../core/promiseUtils","../../../layers/support/fieldUtils","../../../Graphic","../../support/Scheduler","../../../tasks/support/Query","./LayerView3D","./support/layerViewUpdatingProperties","../../layers/support/FeatureFilter","../../layers/SceneLayerView","./i3s/I3SUtil","./i3s/I3SGeometryUtil","./I3SMeshView3D","./i3s/I3SMeshViewFilter","./i3s/I3SQueryEngine","./i3s/I3SQueryFeatureAdapter","./i3s/I3SQueryFeatureStore","./support/DefinitionExpressionSceneLayerView","./support/PopupSceneLayerView","./i3s/attributeEditing","./support/fieldProperties"],(function(e,t,r,i,s,n,o,a,l,u,d,c,p,h,y,f,g,_,F,v,S,w,b,E,I,x,Q,q,m,C,D){"use strict";const V=s.getLogger("esri.views.3d.layers.SceneLayerView3D"),L=D.defineFieldProperties();let A=function(t){function r(){var e;return(e=t.apply(this,arguments)||this).requiredFields=new Array,e.lodFactor=1,e.progressiveLoadFactor=1,e._elevationContext="scene",e._isIntegratedMesh=!1,e._supportsLabeling=!0,e._queryEngine=null,e}e._inheritsLoose(r,t);var s=r.prototype;return s.initialize=function(){for(const e of["layer.renderer","layer.labelingInfo","layer.labelsVisible","definitionExpressionFields","filter"])this.updatingHandles.add(this,e,(()=>this.updatingHandles.addPromise(this._updateRequiredFields())));this._updateRequiredFields(),this.updatingHandles.add(this.layer,"rangeInfos",(e=>this._rangeInfosChanged(e)),2),this.updatingHandles.add(this.layer,"renderer",(e=>this.updatingHandles.addPromise(this._rendererChange(e))),2);for(const e of["parsedDefinitionExpression","filter","viewFilter.parsedWhereClause","viewFilter.parsedGeometry","viewFilter.sortedObjectIds"])this.updatingHandles.add(this,e,(()=>this._filterChange()));this.handles.add(this.layer.on("apply-edits",(e=>this.updatingHandles.addPromise(e.result)))),this.handles.add(this.layer.on("edits",(e=>this._handleEdits(e))))},s.destroy=function(){},s._updateRequiredFields=async function(){const{layer:e,layer:{fields:t,renderer:r,labelsVisible:s},definitionExpressionFields:n}=this,o=new Set,a=await c.eachAlways([r?r.collectRequiredFields(o,t):null,s?p.collectLabelingFields(o,e):null,i.isSome(this.filter)?p.collectFilterFields(o,e,this.filter):null]);for(const e of a)e.error&&V.error(e.error);p.collectFields(o,t,n),this._set("requiredFields",Array.from(o).sort())},s._rangeInfosChanged=function(e){null!=e&&e.length>0&&V.warn("Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.")},s.createQuery=function(){const e={outFields:["*"],returnGeometry:!1,outSpatialReference:this.view.spatialReference};return i.isSome(this.filter)?this.filter.createQuery(e):new f(e)},s.queryExtent=function(e,t){return this._ensureQueryEngine().executeQueryForExtent(this._ensureQuery(e),null==t?void 0:t.signal)},s.queryFeatureCount=function(e,t){return this._ensureQueryEngine().executeQueryForCount(this._ensureQuery(e),null==t?void 0:t.signal)},s.queryFeatures=function(e,t){return this._ensureQueryEngine().executeQuery(this._ensureQuery(e),null==t?void 0:t.signal).then((e=>{if(null==e||!e.features)return e;const t=this.layer;for(const r of e.features)r.layer=t,r.sourceLayer=t;return e}))},s.queryObjectIds=function(e,t){return this._ensureQueryEngine().executeQueryForIds(this._ensureQuery(e),null==t?void 0:t.signal)},s._ensureQueryEngine=function(){return this._queryEngine||(this._queryEngine=this._createQueryEngine()),this._queryEngine},s._createQueryEngine=function(){const e=w.createGetFeatureExtent(this.view.spatialReference,this.view.renderSpatialReference,this._collection);return new I.default({layerView:this,task:y.Task.FEATURE_QUERY_ENGINE,spatialIndex:new Q.default({featureAdapter:new x.I3SQueryFeatureAdapter({objectIdField:this.layer.objectIdField,attributeStorageInfo:this.layer.attributeStorageInfo,getFeatureExtent:e}),forAllFeatures:(e,t)=>this._forAllFeatures(((t,r,i)=>e({id:t,index:r,meta:i})),t,2),getFeatureExtent:e,sourceSpatialReference:S.getIndexCrs(this.layer),viewSpatialReference:this.view.spatialReference})})},s.highlight=function(e){const r=this._highlights;if(e instanceof f){const{set:t,handle:i}=r.acquireSet();return this.queryObjectIds(e).then((e=>r.setFeatureIds(t,e))),i}return t.prototype.highlight.call(this,e)},s.createInteractiveEditSession=function(e){return C.createInteractiveEditSession(this.attributeEditingContext,e)},s._createLayerGraphic=function(e){const t=new h(null,null,e);return t.layer=this.layer,t.sourceLayer=this.layer,t},s.canResume=function(){return t.prototype.canResume.call(this)&&(!this._controller||this._controller.rootNodeVisible)},s.getFilters=function(){const e=t.prototype.getFilters.call(this);return this.addSqlFilter(e,this.parsedDefinitionExpression,this.logError),i.isSome(this.viewFilter)&&this.viewFilter.addFilters(e,this.view,this._controller.crsIndex,this._collection),e},s._ensureQuery=function(e){return this._addDefinitionExpressionToQuery(i.isNone(e)?this.createQuery():f.from(e))},s._handleEdits=function(e){C.processAttributeEdits(this.attributeEditingContext,e)},e._createClass(r,[{key:"filter",get:function(){return i.isSome(this.viewFilter)?this.viewFilter.filter:null},set:function(e){!i.isNone(e)&&E.I3SMeshViewFilter.checkSupport(e)?i.isSome(this.viewFilter)?this.viewFilter.filter=e:this.viewFilter=new E.I3SMeshViewFilter({filter:e,layerFieldsIndex:this.layer.fieldsIndex,loadAsyncModule:e=>this._loadAsyncModule(e),applyFilters:()=>this._applyFilters(!0),addSqlFilter:(e,t)=>this.addSqlFilter(e,t,this.logError)}):this.viewFilter=null}},{key:"lodCrossfadeinDuration",get:function(){var e,t;return null!=(e=null==(t=this.view)?void 0:t.qualitySettings.sceneService["3dObject"].lodCrossfadeinDuration)?e:0}},{key:"lodCrossfadeoutDuration",get:function(){var e,t;return null!=(e=null==(t=this.view)?void 0:t.qualitySettings.sceneService["3dObject"].lodCrossfadeoutDuration)?e:0}},{key:"lodCrossfadeUncoveredDuration",get:function(){var e,t;return null!=(e=null==(t=this.view)?void 0:t.qualitySettings.sceneService["3dObject"].lodCrossfadeUncoveredDuration)?e:0}},{key:"attributeEditingContext",get:function(){return{fieldsIndex:this.layer.fieldsIndex,objectIdField:this._getObjectIdField(),forEachNode:e=>this._forAllNodes((t=>i.isSome(t)?e(t.node,t.featureIds):null)),attributeStorageInfo:this.i3slayer.attributeStorageInfo,attributeOverrides:this.attributeOverrides,getAttributeData:e=>this.getAttributeData(e),setAttributeData:(e,t)=>this.setAttributeData(e,t),clearMemCache:()=>this.clearMemCache()}}}]),r}(b.I3SMeshView3D(q.DefinitionExpressionSceneLayerView(m.PopupSceneLayerView(g.LayerView3D(v)))));return t.__decorate([o.property()],A.prototype,"layer",void 0),t.__decorate([o.property({aliasOf:"layer"})],A.prototype,"i3slayer",void 0),t.__decorate([o.property({dependsOn:["_controller.rootNodeVisible"]})],A.prototype,"suspended",void 0),t.__decorate([o.property(_.updatingProgress)],A.prototype,"updatingProgress",void 0),t.__decorate([o.property({type:F})],A.prototype,"filter",null),t.__decorate([o.property()],A.prototype,"viewFilter",void 0),t.__decorate([o.property(L.requiredFields)],A.prototype,"requiredFields",void 0),t.__decorate([o.property(L.availableFields)],A.prototype,"availableFields",void 0),t.__decorate([o.property({readOnly:!0,aliasOf:"view.qualitySettings.sceneService.3dObject.lodFactor"})],A.prototype,"lodFactor",void 0),t.__decorate([o.property({readOnly:!0,aliasOf:"_controller.updatingProgress"})],A.prototype,"updatingProgressValue",void 0),A=t.__decorate([a.subclass("esri.views.3d.layers.SceneLayerView3D")],A),A}));
