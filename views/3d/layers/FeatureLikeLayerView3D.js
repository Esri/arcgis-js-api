/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Error","../../../core/maybe","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../../layers/graphics/hydratedFeatures","../../../layers/graphics/controllers/FeatureTileController3D","../../../rest/support/Query","../../../symbols/support/utils","./graphics/elevationAlignPointsInFeatures","./graphics/Graphics3DFeatureProcessor","./graphics/QueryEngine","./graphics/queryForSymbologySnapping","./support/HeatmapFeatureProcessor","./support/projectExtentUtils","../webgl-engine/lib/basicInterfaces","../../support/Scheduler"],(function(e,t,r,o,n,i,s,a,l,p,u,c,y,d,h,g,f,_,m,b,v,E){"use strict";const P=e=>{let a=function(e){function r(){var t;return(t=e.apply(this,arguments)||this).controller=null,t.updatePolicy=v.UpdatePolicy.SYNC,t.suspendResumeExtentMode="computed",t.slicePlaneEnabled=!1,t.fullExtentInLocalViewSpatialReference=null,t.suspendResumeExtent=null,t._controllerCreated=!1,t.clippingExtent=null,t.supportsHeightUnitConversion=!0,t._pendingController=null,t.queryEngine=null,t}t._inheritsLoose(r,e);var s=r.prototype;return s.initialize=function(){var e=this;const r=this.layer;if("isTable"in r&&r.isTable)return void this.addResolvingPromise(Promise.reject(new o("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:r})));this.addResolvingPromise(this._validateGeometryType()),this.updatingHandles.add((()=>this.layer.renderer),(e=>this._recreateProcessor(e)),i.initial),this.addResolvingPromise(t._asyncToGenerator((function*(){const t=yield b.toViewIfLocal(e);e.fullExtentInLocalViewSpatialReference=t,yield e._initializeController()}))()),this.updatingHandles.add((()=>this.updatePolicy),(e=>this.processor.preferredUpdatePolicy=e));const n=()=>this.processor.featureStore;this.queryEngine=new f.QueryEngine({context:{spatialReference:this.view.spatialReference,layer:this.layer,scheduler:this.view.resourceController.scheduler,get featureStore(){return n()},hasZ:this.hasZ,hasM:this.hasM},priority:E.TaskPriority.FEATURE_QUERY_ENGINE}),this.notifyChange("updating")},s.destroy=function(){this._destroyPendingController(),this.controller=n.destroyMaybe(this.controller),this._set("processor",n.destroyMaybe(this.processor)),this.queryEngine=n.destroyMaybe(this.queryEngine),this.loadedGraphics=null},s._destroyPendingController=function(){this._pendingController=n.destroyMaybe(this._pendingController)},s.getHit=function(e){let t=null;return this.loadedGraphics?.forEach((r=>{r.uid===e&&(t=u.hydrateGraphic(r,this.layer))})),t?{type:"graphic",graphic:t,layer:t.layer}:null},s.whenGraphicBounds=function(e,t){return this.processor?.whenGraphicBounds(e,t)},s.computeAttachmentOrigin=function(e,t){return this.processor?.computeAttachmentOrigin(e,t)},s.elevationAlignPointsInFeatures=function(){var e=t._asyncToGenerator((function*(e,t){const r=this.graphics3DProcessor;if(n.isNone(r))throw new o("featurelayerview3d:missing-processor","A Graphics3D processor is needed to resolve graphics elevation.");return h.elevationAlignPointsInFeatures(this.view,this.layer,(e=>r.getGraphics3DGraphicByObjectId(e)),e,t)}));function r(t,r){return e.apply(this,arguments)}return r}(),s.queryForSymbologySnapping=function(){var e=t._asyncToGenerator((function*(e,t){return this.symbologySnappingSupported?_.queryForSymbologySnapping(this.graphics3DProcessor,e,t):{candidates:[],sourceCandidateIndices:[]}}));function r(t,r){return e.apply(this,arguments)}return r}(),s.queryFeatures=function(e,t){return this.queryEngine.executeQuery(this._ensureQuery(e),n.get(t,"signal"))},s.queryObjectIds=function(e,t){return this.queryEngine.executeQueryForIds(this._ensureQuery(e),n.get(t,"signal"))},s.queryFeatureCount=function(e,t){return this.queryEngine.executeQueryForCount(this._ensureQuery(e),n.get(t,"signal"))},s.queryExtent=function(e,t){return this.queryEngine.executeQueryForExtent(this._ensureQuery(e),n.get(t,"signal"))},s._ensureQuery=function(e){return n.isNone(e)?this.createQuery():y.from(e)},s.highlight=function(e){return this.processor.highlight(e,this.layer.objectIdField)},s.maskOccludee=function(e){return this.processor.maskOccludee(e)},s.canResume=function(){return e.prototype.canResume.call(this)&&!this.processor?.scaleVisibilitySuspended},s.getSuspendInfo=function(){const t=e.prototype.getSuspendInfo.call(this);return this.processor?{...t,...this.processor.suspendInfo}:t},s.isUpdating=function(){return!(!this.processor||this.processor.destroyed)&&!(this._controllerCreated&&!this.controller?.updating&&this.view?.basemapTerrain?.ready&&!this.processor.updating)},s._initializeController=function(){var e=t._asyncToGenerator((function*(){const e=this.createController();this._pendingController=e,yield e.when(),this._setControllerWhenInitialized(e)}));function r(){return e.apply(this,arguments)}return r}(),s._setControllerWhenInitialized=function(){var e=t._asyncToGenerator((function*(e){try{yield this.when()}catch(t){}this._controllerCreated=!0,this.notifyChange("updating"),this.isResolved()&&!this.destroyed?(yield i.whenOnce((()=>this.view?.basemapTerrain?.ready)),this.beforeSetController(e),this._pendingController=null,this.controller=e,this.loadedGraphics=e.graphics,this.notifyChange("updating")):this._destroyPendingController()}));function r(t){return e.apply(this,arguments)}return r}(),s._updateClippingExtent=function(e){if(this.clippingExtent=e,!this.controller)return!1;switch(this.controller.type){case"stream":return!1;case"feature-tile-3d":return this.controller.extent=e,!0}},s._validateGeometryType=function(){var e=t._asyncToGenerator((function*(){switch(this.layer.geometryType){case"multipatch":case"multipoint":throw new o("featurelayerview3d:unsupported-geometry-type","Unsupported geometry type ${geometryType}",{geometryType:this.layer.geometryType})}}));function r(){return e.apply(this,arguments)}return r}(),s._recreateProcessor=function(e){const t="heatmap"===e?.type,r="heatmap"===this.processor?.type,o=this.processor;if(o&&t===r)return;const n=t?new m.HeatmapFeatureProcessor({owner:this}):new g({owner:this,frustumVisibilityEnabled:!0,scaleVisibilityEnabled:!0,filterVisibilityEnabled:!0,timeExtentEnabled:!0,elevationAlignmentEnabled:!0,elevationFeatureExpressionEnabled:!0,preferredUpdatePolicy:this.updatePolicy,updateClippingExtent:e=>this._updateClippingExtent(e)});this._set("processor",n),o?.destroy(),this.queryEngine?.clear(),this.addResolvingPromise(n.initializePromise)},s._getResourceInfo=function(){const e=this.controller instanceof c.FeatureTileController3D?this.controller:null;return{displayedNumberOfFeatures:this.loadedGraphics.length,maximumNumberOfFeatures:e?.maximumNumberOfFeatures??-1,totalNumberOfFeatures:e?.serviceDataCount??-1,nodes:0,...this.processor.performanceInfo}},t._createClass(r,[{key:"legendEnabled",get:function(){return this.canResume()&&this.processor?.legendEnabled}},{key:"graphics3DProcessor",get:function(){return"graphics-3d"===this.processor?.type?this.processor:null}},{key:"heatmapProcessor",get:function(){return"heatmap"===this.processor?.type?this.processor:null}},{key:"symbologySnappingSupported",get:function(){const e=this.layer?.renderer?.getSymbols();return e?.some(d.symbolHasExtrudeSymbolLayer)??!1}},{key:"performanceInfo",get:function(){return this._getResourceInfo()}}]),r}(e);return r.__decorate([s.property()],a.prototype,"loadedGraphics",void 0),r.__decorate([s.property()],a.prototype,"suspended",void 0),r.__decorate([s.property({readOnly:!0})],a.prototype,"legendEnabled",null),r.__decorate([s.property()],a.prototype,"updating",void 0),r.__decorate([s.property()],a.prototype,"controller",void 0),r.__decorate([s.property()],a.prototype,"processor",void 0),r.__decorate([s.property({readOnly:!0})],a.prototype,"updatePolicy",void 0),r.__decorate([s.property({readOnly:!0})],a.prototype,"suspendResumeExtentMode",void 0),r.__decorate([s.property({type:Boolean})],a.prototype,"slicePlaneEnabled",void 0),r.__decorate([s.property({readOnly:!0})],a.prototype,"suspendInfo",void 0),r.__decorate([s.property()],a.prototype,"graphics3DProcessor",null),r.__decorate([s.property()],a.prototype,"heatmapProcessor",null),r.__decorate([s.property()],a.prototype,"symbologySnappingSupported",null),a=r.__decorate([p.subclass("esri.views.3d.layers.FeatureLikeLayerView3D")],a),a};e.FeatureLikeLayerView3D=P,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
