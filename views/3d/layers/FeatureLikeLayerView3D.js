/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Error","../../../core/maybe","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../../layers/graphics/hydratedFeatures","../../../layers/graphics/controllers/FeatureTileController3D","../../../rest/support/Query","./interfaces","./graphics/Graphics3DFeatureProcessor","./graphics/QueryEngine","./support/HeatmapFeatureProcessor","./support/projectExtentUtils","../webgl-engine/lib/basicInterfaces","../../support/Scheduler"],(function(e,t,r,o,n,i,s,l,a,u,c,p,d,y,h,g,f,_,m,v,b){"use strict";const E=e=>{let l=function(e){function r(){var t;return(t=e.apply(this,arguments)||this).controller=null,t.updatePolicy=v.UpdatePolicy.SYNC,t.suspendResumeExtentMode="computed",t.slicePlaneEnabled=!1,t.drapeSourceType=h.DrapeSourceType.Features,t.fullExtentInLocalViewSpatialReference=null,t.suspendResumeExtent=null,t._controllerCreated=!1,t.clippingExtent=null,t.supportsHeightUnitConversion=!0,t.pendingController=null,t.queryEngine=null,t}t._inheritsLoose(r,e);var s=r.prototype;return s.initialize=function(){var e=this;const r=this.layer;"isTable"in r&&r.isTable?this.addResolvingPromise(Promise.reject(new o("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:r}))):(this.addResolvingPromise(this._validateGeometryType()),this.updatingHandles.add((()=>this.layer.renderer),(e=>this._recreateProcessor(e)),i.initial),this.addResolvingPromise(t._asyncToGenerator((function*(){const t=yield m.toViewIfLocal(e);e.fullExtentInLocalViewSpatialReference=t,yield e._initializeController()}))()),this.updatingHandles.add((()=>this.updatePolicy),(e=>this.processor.preferredUpdatePolicy=e)),this.queryEngine=new f.default({layerView:this,priority:b.TaskPriority.FEATURE_QUERY_ENGINE}),this.notifyChange("updating"))},s.destroy=function(){this._destroyPendingController(),this.controller=n.destroyMaybe(this.controller),this._set("processor",n.destroyMaybe(this.processor)),this.queryEngine=n.destroyMaybe(this.queryEngine),this.loadedGraphics=null},s._destroyPendingController=function(){this.pendingController=n.destroyMaybe(this.pendingController)},s.getGraphicFromGraphicUid=function(e){var t;let r=null;return null==(t=this.loadedGraphics)||t.forEach((t=>{t.uid===e&&(r=p.hydrateGraphic(t,this.layer))})),r},s.whenGraphicBounds=function(e,t){var r;return null==(r=this.processor)?void 0:r.whenGraphicBounds(e,t)},s.computeAttachmentOrigin=function(e,t){var r;return null==(r=this.processor)?void 0:r.computeAttachmentOrigin(e,t)},s.queryFeatures=function(e,t){return this.queryEngine.executeQuery(this._ensureQuery(e),n.get(t,"signal"))},s.queryObjectIds=function(e,t){return this.queryEngine.executeQueryForIds(this._ensureQuery(e),n.get(t,"signal"))},s.queryFeatureCount=function(e,t){return this.queryEngine.executeQueryForCount(this._ensureQuery(e),n.get(t,"signal"))},s.queryExtent=function(e,t){return this.queryEngine.executeQueryForExtent(this._ensureQuery(e),n.get(t,"signal"))},s._ensureQuery=function(e){return n.isNone(e)?this.createQuery():y.from(e)},s.highlight=function(e){return this.processor.highlight(e,this.layer.objectIdField)},s.maskOccludee=function(e){return this.processor.maskOccludee(e)},s.canResume=function(){var t;return e.prototype.canResume.call(this)&&!(null!=(t=this.processor)&&t.scaleVisibilitySuspended)},s.getSuspendInfo=function(){const t=e.prototype.getSuspendInfo.call(this);return this.processor?{...t,...this.processor.suspendInfo}:t},s.isUpdating=function(){var e,t,r;return!(!this.processor||this.processor.destroyed)&&!(this._controllerCreated&&(null==(e=this.controller)||!e.updating)&&null!=(t=this.view)&&null!=(r=t.basemapTerrain)&&r.ready&&!this.processor.updating)},s._initializeController=function(){var e=t._asyncToGenerator((function*(){const e=this.createController();this.pendingController=e,yield e.when(),this._setControllerWhenInitialized(e)}));function r(){return e.apply(this,arguments)}return r}(),s._setControllerWhenInitialized=function(){var e=t._asyncToGenerator((function*(e){try{yield this.when()}catch(t){}this._controllerCreated=!0,this.notifyChange("updating"),this.isResolved()&&!this.destroyed?(yield i.whenOnce((()=>{var e,t;return null==(e=this.view)||null==(t=e.basemapTerrain)?void 0:t.ready})),this.beforeSetController(e),this.pendingController=null,this.controller=e,this.loadedGraphics=e.graphics,this.notifyChange("updating")):this._destroyPendingController()}));function r(t){return e.apply(this,arguments)}return r}(),s._updateClippingExtent=function(e){if(this.clippingExtent=e,!this.controller)return!1;switch(this.controller.type){case"stream":return!1;case"feature-tile-3d":return this.controller.extent=e,!0}},s._validateGeometryType=function(){var e=t._asyncToGenerator((function*(){switch(this.layer.geometryType){case"multipatch":case"multipoint":return Promise.reject(new o("featurelayerview3d:unsupported-geometry-type","Unsupported geometry type ${geometryType}",{geometryType:this.layer.geometryType}))}}));function r(){return e.apply(this,arguments)}return r}(),s._recreateProcessor=function(e){var t,r;const o="heatmap"===(null==e?void 0:e.type),n="heatmap"===(null==(t=this.processor)?void 0:t.type),i=this.processor;if(i&&o===n)return;const s=o?new _.HeatmapFeatureProcessor({owner:this}):new g({owner:this,frustumVisibilityEnabled:!0,scaleVisibilityEnabled:!0,filterVisibilityEnabled:!0,timeExtentVisibilityEnabled:!0,elevationAlignmentEnabled:!0,elevationFeatureExpressionEnabled:!0,preferredUpdatePolicy:this.updatePolicy,updateClippingExtent:e=>this._updateClippingExtent(e)});this._set("processor",s),null==i||i.destroy(),null==(r=this.queryEngine)||r.clear(),this.addResolvingPromise(s.setup())},s._getResourceInfo=function(){var e,t;const r=this.controller instanceof d.FeatureTileController3D?this.controller:null;return{displayedNumberOfFeatures:this.loadedGraphics.length,maximumNumberOfFeatures:null!=(e=null==r?void 0:r.maximumNumberOfFeatures)?e:-1,totalNumberOfFeatures:null!=(t=null==r?void 0:r.serviceDataCount)?t:-1,nodes:0,...this.processor.performanceInfo}},t._createClass(r,[{key:"legendEnabled",get:function(){var e;return this.canResume()&&(null==(e=this.processor)?void 0:e.legendEnabled)}},{key:"graphics3DProcessor",get:function(){var e;return"graphics-3d"===(null==(e=this.processor)?void 0:e.type)?this.processor:null}},{key:"heatmapProcessor",get:function(){var e;return"heatmap"===(null==(e=this.processor)?void 0:e.type)?this.processor:null}},{key:"performanceInfo",get:function(){return this._getResourceInfo()}}]),r}(e);return r.__decorate([s.property()],l.prototype,"loadedGraphics",void 0),r.__decorate([s.property()],l.prototype,"suspended",void 0),r.__decorate([s.property({readOnly:!0})],l.prototype,"legendEnabled",null),r.__decorate([s.property()],l.prototype,"updating",void 0),r.__decorate([s.property()],l.prototype,"controller",void 0),r.__decorate([s.property()],l.prototype,"processor",void 0),r.__decorate([s.property({readOnly:!0})],l.prototype,"updatePolicy",void 0),r.__decorate([s.property({readOnly:!0})],l.prototype,"suspendResumeExtentMode",void 0),r.__decorate([s.property({type:Boolean})],l.prototype,"slicePlaneEnabled",void 0),r.__decorate([s.property({readOnly:!0})],l.prototype,"suspendInfo",void 0),r.__decorate([s.property()],l.prototype,"graphics3DProcessor",null),r.__decorate([s.property()],l.prototype,"heatmapProcessor",null),l=r.__decorate([c.subclass("esri.views.3d.layers.FeatureLikeLayerView3D")],l),l};e.FeatureLikeLayerView3D=E,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
