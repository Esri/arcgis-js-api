/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Error","../../../core/maybe","../../../core/watchUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/accessorSupport/ensureType","../../../core/Logger","../../../core/accessorSupport/decorators/subclass","../../../layers/graphics/hydratedFeatures","../../../layers/graphics/controllers/FeatureTileController3D","../../../renderers/support/renderingInfoUtils","../../../rest/support/Query","./graphics/Graphics3DFeatureLikeLayerView","./graphics/QueryEngine","./support/projectExtentUtils","../../support/Scheduler"],(function(e,t,r,i,n,s,o,a,l,u,c,p,h,d,y,g,f,m,b){"use strict";const C=e=>{let a=function(e){function r(){var t;return(t=e.apply(this,arguments)||this).controller=null,t.updatePolicy=1,t.suspendResumeExtentMode="computed",t.slicePlaneEnabled=!1,t.drapeSourceType=1,t.fullExtentInLocalViewSpatialReference=null,t.suspendResumeExtent=null,t._controllerCreated=!1,t.clippingExtent=null,t.supportsHeightUnitConversion=!0,t.pendingController=null,t.queryEngine=null,t}t._inheritsLoose(r,e);var o=r.prototype;return o.initialize=function(){const e=this.layer;"isTable"in e&&e.isTable?this.addResolvingPromise(Promise.reject(new i("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:e}))):(this._set("graphics3d",new g({owner:this,layer:e,frustumVisibilityEnabled:!0,scaleVisibilityEnabled:!0,filterVisibilityEnabled:!0,timeExtentVisibilityEnabled:!0,elevationAlignmentEnabled:!0,elevationFeatureExpressionEnabled:!0,preferredUpdatePolicy:this.updatePolicy,suspendResumeExtentMode:this.suspendResumeExtentMode,updateClippingExtent:e=>this.updateClippingExtent(e)})),this.updatingHandles.add(this,"updatePolicy",(e=>this.graphics3d.graphicsCore.preferredUpdatePolicy=e)),this.updatingHandles.add(this,"suspendResumeExtentMode",(e=>{this.graphics3d.suspendResumeExtentMode=e})),this.addResolvingPromise(this.graphics3d.setup().then((()=>this.validateGeometryType())).then((()=>this.queryEngine=new f.default({layerView:this,priority:b.TaskPriority.FEATURE_QUERY_ENGINE}))).then((()=>m.toViewIfLocal(this))).then((e=>this.fullExtentInLocalViewSpatialReference=e)).then((()=>this.initializeController()))),this.notifyChange("updating"))},o.destroy=function(){this.destroyPendingController(),this.controller=n.destroyMaybe(this.controller),this._set("graphics3d",n.destroyMaybe(this.graphics3d)),this.queryEngine=n.destroyMaybe(this.queryEngine),this.loadedGraphics=null},o.destroyPendingController=function(){this.pendingController&&(this.pendingController.destroy(),this.pendingController=null)},o.notifyGraphicGeometryChanged=function(e){this.graphics3d.graphicsCore.notifyGraphicGeometryChanged(e)},o.notifyGraphicVisibilityChanged=function(e){this.graphics3d.graphicsCore.notifyGraphicVisibilityChanged(e)},o.getRenderingInfo=function(e,t,r){const i=d.getRenderingInfo(e,{renderer:t,arcade:r});if(n.isSome(i)&&i.color){const e=i.color;e[0]=e[0]/255,e[1]=e[1]/255,e[2]=e[2]/255}return i},o.getRenderingInfoAsync=function(){var e=t._asyncToGenerator((function*(e,t,r,i){return d.getRenderingInfoAsync(e,{renderer:t,arcade:r,...i})}));function r(t,r,i,n){return e.apply(this,arguments)}return r}(),o.getGraphicFromGraphicUid=function(e){var t;let r=null;return null==(t=this.loadedGraphics)||t.forEach((t=>{t.uid===e&&(r=p.hydrateGraphic(t,this.layer))})),r},o.whenGraphicBounds=function(e,t){return this.graphics3d?this.graphics3d.graphicsCore.whenGraphicBounds(e,t):null},o.computeAttachmentOrigin=function(e,t){return this.graphics3d?this.graphics3d.graphicsCore.computeAttachmentOrigin(e,t):null},o.getSymbolLayerSize=function(e,t){return this.graphics3d?this.graphics3d.graphicsCore.getSymbolLayerSize(e,t):null},o.queryFeatures=function(e,t){return this.queryEngine.executeQuery(this._ensureQuery(e),n.get(t,"signal"))},o.queryObjectIds=function(e,t){return this.queryEngine.executeQueryForIds(this._ensureQuery(e),n.get(t,"signal"))},o.queryFeatureCount=function(e,t){return this.queryEngine.executeQueryForCount(this._ensureQuery(e),n.get(t,"signal"))},o.queryExtent=function(e,t){return this.queryEngine.executeQueryForExtent(this._ensureQuery(e),n.get(t,"signal"))},o._ensureQuery=function(e){return n.isNone(e)?this.createQuery():y.from(e)},o.highlight=function(e){return this.graphics3d.highlight(e,this.layer.objectIdField)},o.maskOccludee=function(e){return this.graphics3d.maskOccludee(e)},o.canResume=function(){return e.prototype.canResume.call(this)&&(!this.graphics3d||!this.graphics3d.suspended)},o.getSuspendInfo=function(){const t=e.prototype.getSuspendInfo.call(this);return this.graphics3d?{...t,...this.graphics3d.suspendInfo}:t},o.isUpdating=function(){var e,t;return!(!this.graphics3d||this.graphics3d.destroyed)&&!(this._controllerCreated&&(null==(e=this.controller)||!e.updating)&&null!=(t=this.view.basemapTerrain)&&t.ready&&!this.graphics3d.updating)},o.initializeController=function(){var e=t._asyncToGenerator((function*(){const e=this.createController();this.pendingController=e,yield e.when(),this.setControllerWhenInitialized(e)}));function r(){return e.apply(this,arguments)}return r}(),o.setControllerWhenInitialized=function(){var e=t._asyncToGenerator((function*(e){try{yield this.when()}catch(t){}this._controllerCreated=!0,this.notifyChange("updating"),this.isResolved()&&!this.destroyed?(yield s.whenTrueOnce(this.view,"basemapTerrain.ready"),this.beforeSetController(e),this.pendingController=null,this.controller=e,this.loadedGraphics=e.graphics,this.notifyChange("updating")):this.destroyPendingController()}));function r(t){return e.apply(this,arguments)}return r}(),o.updateClippingExtent=function(e){if(this.clippingExtent=e,!this.controller)return!1;switch(this.controller.type){case"stream":return!1;case"feature-tile-3d":return this.controller.extent=e,!0}},o.validateGeometryType=function(){switch(this.layer.geometryType){case"multipatch":case"multipoint":return Promise.reject(new i("featurelayerview3d:unsupported-geometry-type","Unsupported geometry type ${geometryType}",{geometryType:this.layer.geometryType}))}},o._getResourceInfo=function(){const e=this.controller&&this.controller instanceof h.FeatureTileController3D?this.controller:null;return{displayedNumberOfFeatures:this.loadedGraphics.length,maximumNumberOfFeatures:e?e.maximumNumberOfFeatures:-1,totalNumberOfFeatures:e?e.serviceDataCount:-1,nodes:0,core:this.graphics3d.graphicsCore.performanceInfo,elevationUpdating:this.graphics3d.elevationAlignment.updating,visibilityFrustum:!this.graphics3d.frustumVisibility.suspended,visibilityScale:!this.graphics3d.scaleVisibility.suspended}},t._createClass(r,[{key:"legendEnabled",get:function(){var e,t;return this.canResume()&&!(null!=(e=this.graphics3d)&&null!=(t=e.frustumVisibility)&&t.suspended)}},{key:"graphics3DGraphics",get:function(){return this.graphics3d?this.graphics3d.graphicsCore.graphics3DGraphics:null}},{key:"graphics3DGraphicsByObjectID",get:function(){return this.graphics3d?this.graphics3d.graphicsCore.graphics3DGraphicsByObjectID:null}},{key:"symbolUpdateType",get:function(){return this.graphics3d?this.graphics3d.graphicsCore.symbolUpdateType:null}},{key:"performanceInfo",get:function(){return this._getResourceInfo()}}]),r}(e);return r.__decorate([o.property()],a.prototype,"loadedGraphics",void 0),r.__decorate([o.property()],a.prototype,"suspended",void 0),r.__decorate([o.property({readOnly:!0})],a.prototype,"legendEnabled",null),r.__decorate([o.property()],a.prototype,"updating",void 0),r.__decorate([o.property()],a.prototype,"controller",void 0),r.__decorate([o.property()],a.prototype,"graphics3d",void 0),r.__decorate([o.property({readOnly:!0})],a.prototype,"updatePolicy",void 0),r.__decorate([o.property({readOnly:!0})],a.prototype,"suspendResumeExtentMode",void 0),r.__decorate([o.property({type:Boolean})],a.prototype,"slicePlaneEnabled",void 0),r.__decorate([o.property({readOnly:!0})],a.prototype,"suspendInfo",void 0),a=r.__decorate([c.subclass("esri.views.3d.layers.FeatureLikeLayerView3D")],a),a};e.FeatureLikeLayerView3D=C,Object.defineProperty(e,"__esModule",{value:!0})}));
