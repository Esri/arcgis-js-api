/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../../core/mathUtils","../../../../core/ObjectPool","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/projectionEllipsoid","../../../../geometry/support/plane","../../../../geometry/support/ray","./FeatureTileDescriptor3D","../../state/Frustum","../../support/FrustumExtentIntersection"],(function(e,t,i,s,r,n,u,o,a,l,c){"use strict";let d=function(){function e(e){this.renderCoordsHelper=e,this.surfaceElevation=0,this.cache=new Map,this.frustum=new l.Frustum(e),this.extendedFrustum=new l.Frustum(e),this.intersector=new c.FrustumExtentIntersection({renderCoordsHelper:e}),this.renderCoordsHelper=e}var i=e.prototype;return i.begin=function(e,t){this.surfaceElevation=t,this.aboveGround=this.renderCoordsHelper.getAltitude(e.eye)>t,this.frustum.update(e),this.shortenFrustumFarPlane(this.frustum),this.updateExtendedFrustum(e)},i.end=function(){this.cache.clear()},i.calculate=function(e){if(this.allTilesInvisible)return 0;const t=1===this.renderCoordsHelper.viewingMode&&e.lij[0]>=h&&e.lij[0]<m,i=this.getOrCalculateSingleTileVisibility(e,!t);return 0!==i&&t?this.calculateAggregatedChildrenVisibility(e):i},i.shortenFrustumFarPlane=function(e){const t=l.Frustum.nearFarLineIndices,i=e.mutablePoints;for(const r of t){const[e,t]=r,n=i[e],u=i[t];s.subtract(g,u,n),s.scale(g,g,p),s.add(i[t],n,g)}e.updatePoints(i)},i.calculateAggregatedChildrenVisibility=function(e){let t=0;const i=this.cache.get(e.id);if(null!=i)return i;const s=x.acquire();e.getChildren(s);for(const r of s){const e=this.calculate(r);if(0!==e&&(t=e,2===e))break}return x.release(s),this.cache.set(e.id,t),t},i.getOrCalculateSingleTileVisibility=function(e,t){const i=this.cache.get(e.id);if(null!=i)return i;const s=this.calculateSingleTileVisibility(e);return t&&this.cache.set(e.id,s),s},i.calculateSingleTileVisibility=function(e){if(!this.aboveGround&&1===this.renderCoordsHelper.viewingMode&&e.lij[0]<f){return 0===this.calculateSingleTileVisibilitySided(e,!1)?this.calculateSingleTileVisibilitySided(e,!0):void 0}return this.calculateSingleTileVisibilitySided(e,this.aboveGround)},i.calculateSingleTileVisibilitySided=function(e,t){this.intersector.update(e.extent,e.tilingScheme.spatialReference,this.surfaceElevation,t);const i=n.getReferenceEllipsoid(e.tilingScheme.spatialReference).radius;return this.intersector.isVisibleInFrustum(this.extendedFrustum,i)?this.intersector.isVisibleInFrustum(this.frustum,i,!0)?2:1:0},i.updateExtendedFrustum=function(e){this.extendedFrustum.update(e),this.shortenFrustumFarPlane(this.extendedFrustum);const i=this.renderCoordsHelper.worldUpAtPosition(e.eye,g);this.aboveGround||s.negate(i,i);const r=t.acosClamped(-s.dot(i,e.viewForward));if(this.allTilesInvisible=r>(Math.PI+e.fovY)/2,this.allTilesInvisible)return;if(this.hasExtendedFrustum=r>e.fovY/2,!this.hasExtendedFrustum)return;const n=this.extendedFrustumParameters(),a=this.extendedFrustum.mutablePoints;for(let t=0;t<4;t++){const e=n.pointIndices[t],i=a[e],r=this.renderCoordsHelper.getAltitude(i);if(n.needsAltitudeAdjustment(r)){switch(this.renderCoordsHelper.worldUpAtPosition(i,g),e){case 4:case 7:case 0:case 3:u.projectVector(this.extendedFrustum.planes[0],g,g);break;case 5:case 6:case 1:case 2:u.projectVector(this.extendedFrustum.planes[1],g,g)}s.scale(g,g,n.direction),this.renderCoordsHelper.intersectInfiniteManifold(o.wrap(i,g),n.zWithMargin,i)}}if(this.extendedFrustum.updatePoints(a),u.fromPoints(a[0],a[1],a[2],b),u.fromPoints(a[1],a[2],a[3],v),s.dot(u.normal(b),u.normal(v))<0){const e=this.extendedFrustum.mutablePoints;this.aboveGround?[e[0],e[1]]=[e[1],e[0]]:[e[3],e[2]]=[e[2],e[3]],this.extendedFrustum.updatePoints(e)}},i.extendedFrustumParameters=function(){return this.aboveGround?this.extendedFrustumParametersAboveSurface():this.extendedFrustumParametersBelowSurface()},i.extendedFrustumParametersAboveSurface=function(){const e=this.surfaceElevation-F;return{zWithMargin:e,pointIndices:l.Frustum.planePointIndices.bottom,direction:-1,needsAltitudeAdjustment:t=>t>e}},i.extendedFrustumParametersBelowSurface=function(){const e=this.surfaceElevation+F;return{zWithMargin:e,pointIndices:l.Frustum.planePointIndices.top,direction:1,needsAltitudeAdjustment:t=>t<e}},e}();const h=2,m=6,f=12,p=.95,F=1,g=r.create(),b=u.create(),v=u.create(),x=new i(Array,(e=>{4!==e.length&&(e[0]=new a.FeatureTileDescriptor3D,e[1]=new a.FeatureTileDescriptor3D,e[2]=new a.FeatureTileDescriptor3D,e[3]=new a.FeatureTileDescriptor3D)}),(e=>{e[0].release(),e[1].release(),e[2].release(),e[3].release()}));e.FeatureTileVisibility3D=d,Object.defineProperty(e,"__esModule",{value:!0})}));
