/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../core/mathUtils","../../../../core/ObjectPool","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/projectionEllipsoid","../../../../geometry/support/frustum","../../../../geometry/support/plane","../../../../geometry/support/ray","../../../ViewingMode","./FeatureTileDescriptor3D","../../state/Frustum","../../support/FrustumExtentIntersection"],(function(e,t,i,n,s,r,o,u,l,d,a,c,h){"use strict";let I=function(){function e(e){this.renderCoordsHelper=e,this.surfaceElevation=0,this.cache=new Map,this.frustum=new c.Frustum(e),this.extendedFrustum=new c.Frustum(e),this.intersector=new h.FrustumExtentIntersection({renderCoordsHelper:e}),this.renderCoordsHelper=e}var i=e.prototype;return i.begin=function(e,t){this.surfaceElevation=t,this.aboveGround=this.renderCoordsHelper.getAltitude(e.eye)>t,this.frustum.update(e),this._shortenFrustumFarPlane(this.frustum),this._updateExtendedFrustum(e)},i.end=function(){this.cache.clear()},i.calculate=function(e){if(this.allTilesInvisible)return a.Visibility.INVISIBLE;const t=this.renderCoordsHelper.viewingMode===d.ViewingMode.Global&&e.lij[0]>=T&&e.lij[0]<_,i=this._getOrCalculateSingleTileVisibility(e,!t);return i!==a.Visibility.INVISIBLE&&t?this._calculateAggregatedChildrenVisibility(e):i},i._shortenFrustumFarPlane=function(e){const t=c.Frustum.nearFarLineIndices,i=e.mutablePoints;for(const s of t){const[e,t]=s,r=i[e],o=i[t];n.subtract(E,o,r),n.scale(E,E,F),n.add(i[t],r,E)}e.updatePoints(i)},i._calculateAggregatedChildrenVisibility=function(e){let t=a.Visibility.INVISIBLE;const i=this.cache.get(e.id);if(null!=i)return i;const n=x.acquire();e.getChildren(n);for(const s of n){const e=this.calculate(s);if(e!==a.Visibility.INVISIBLE&&(t=e,e===a.Visibility.VISIBLE_ON_SURFACE))break}return x.release(n),this.cache.set(e.id,t),t},i._getOrCalculateSingleTileVisibility=function(e,t){const i=this.cache.get(e.id);if(null!=i)return i;const n=this._calculateSingleTileVisibility(e);return t&&this.cache.set(e.id,n),n},i._calculateSingleTileVisibility=function(e){if(!this.aboveGround&&this.renderCoordsHelper.viewingMode===d.ViewingMode.Global&&e.lij[0]<m){return this._calculateSingleTileVisibilitySided(e,!1)===a.Visibility.INVISIBLE?this._calculateSingleTileVisibilitySided(e,!0):void 0}return this._calculateSingleTileVisibilitySided(e,this.aboveGround)},i._calculateSingleTileVisibilitySided=function(e,t){this.intersector.update(e.extent,e.tilingScheme.spatialReference,this.surfaceElevation,t);const i=r.getReferenceEllipsoid(e.tilingScheme.spatialReference).radius;return this.intersector.isVisibleInFrustum(this.extendedFrustum,i)?this.intersector.isVisibleInFrustum(this.frustum,i,!0)?a.Visibility.VISIBLE_ON_SURFACE:a.Visibility.VISIBLE_WHEN_EXTENDED:a.Visibility.INVISIBLE},i._updateExtendedFrustum=function(e){this.extendedFrustum.update(e),this._shortenFrustumFarPlane(this.extendedFrustum);const i=this.renderCoordsHelper.worldUpAtPosition(e.eye,E);this.aboveGround||n.negate(i,i);const s=t.acosClamped(-n.dot(i,e.viewForward));if(this.allTilesInvisible=s>(Math.PI+e.fovY)/2,this.allTilesInvisible)return;if(this.hasExtendedFrustum=s>e.fovY/2,!this.hasExtendedFrustum)return;const r=this._extendedFrustumParameters(),d=this.extendedFrustum.mutablePoints;for(let t=0;t<4;t++){const e=r.pointIndices[t],i=d[e],s=this.renderCoordsHelper.getAltitude(i);if(r.needsAltitudeAdjustment(s)){switch(this.renderCoordsHelper.worldUpAtPosition(i,E),e){case o.PointIndex.FAR_BOTTOM_LEFT:case o.PointIndex.FAR_TOP_LEFT:case o.PointIndex.NEAR_BOTTOM_LEFT:case o.PointIndex.NEAR_TOP_LEFT:u.projectVector(this.extendedFrustum.planes[o.PlaneIndex.LEFT],E,E);break;case o.PointIndex.FAR_BOTTOM_RIGHT:case o.PointIndex.FAR_TOP_RIGHT:case o.PointIndex.NEAR_BOTTOM_RIGHT:case o.PointIndex.NEAR_TOP_RIGHT:u.projectVector(this.extendedFrustum.planes[o.PlaneIndex.RIGHT],E,E)}n.scale(E,E,r.direction),this.renderCoordsHelper.intersectInfiniteManifold(l.wrap(i,E),r.zWithMargin,i)}}if(this.extendedFrustum.updatePoints(d),u.fromPoints(d[o.PointIndex.NEAR_BOTTOM_LEFT],d[o.PointIndex.NEAR_BOTTOM_RIGHT],d[o.PointIndex.NEAR_TOP_RIGHT],p),u.fromPoints(d[o.PointIndex.NEAR_BOTTOM_RIGHT],d[o.PointIndex.NEAR_TOP_RIGHT],d[o.PointIndex.NEAR_TOP_LEFT],f),n.dot(u.normal(p),u.normal(f))<0){const e=this.extendedFrustum.mutablePoints;this.aboveGround?[e[o.PointIndex.NEAR_BOTTOM_LEFT],e[o.PointIndex.NEAR_BOTTOM_RIGHT]]=[e[o.PointIndex.NEAR_BOTTOM_RIGHT],e[o.PointIndex.NEAR_BOTTOM_LEFT]]:[e[o.PointIndex.NEAR_TOP_LEFT],e[o.PointIndex.NEAR_TOP_RIGHT]]=[e[o.PointIndex.NEAR_TOP_RIGHT],e[o.PointIndex.NEAR_TOP_LEFT]],this.extendedFrustum.updatePoints(e)}},i._extendedFrustumParameters=function(){return this.aboveGround?this._extendedFrustumParametersAboveSurface():this._extendedFrustumParametersBelowSurface()},i._extendedFrustumParametersAboveSurface=function(){const e=this.surfaceElevation-P;return{zWithMargin:e,pointIndices:c.Frustum.planePointIndices.bottom,direction:-1,needsAltitudeAdjustment:t=>t>e}},i._extendedFrustumParametersBelowSurface=function(){const e=this.surfaceElevation+P;return{zWithMargin:e,pointIndices:c.Frustum.planePointIndices.top,direction:1,needsAltitudeAdjustment:t=>t<e}},e}();const T=2,_=6,m=12,F=.95,P=1,E=s.create(),p=u.create(),f=u.create(),x=new i(Array,(e=>{4!==e.length&&(e[0]=new a.FeatureTileDescriptor3D,e[1]=new a.FeatureTileDescriptor3D,e[2]=new a.FeatureTileDescriptor3D,e[3]=new a.FeatureTileDescriptor3D)}),(e=>{e[0].release(),e[1].release(),e[2].release(),e[3].release()}));e.FeatureTileVisibility3D=I,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
