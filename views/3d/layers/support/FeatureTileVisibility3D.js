// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","../../../../core/mathUtils","../../../../core/ObjectPool","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","./FeatureTileDescriptor3D","../../state/Frustum","../../support/FrustumExtentIntersection","../../support/geometryUtils"],(function(e,t,i,r,s,n,a,u,o,l){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FeatureTileVisibility3D=void 0;var d=function(){function e(e){this.surfaceElevation=0,this.cache=new Map;var t=e.renderCoordsHelper;this.frustum=new u.Frustum({renderCoordsHelper:t}),this.extendedFrustum=new u.Frustum({renderCoordsHelper:t}),this.intersector=new o.FrustumExtentIntersection({renderCoordsHelper:t}),this.renderCoordsHelper=t}return e.prototype.begin=function(e,t){this.surfaceElevation=t,this.aboveGround=this.renderCoordsHelper.getAltitude(e.eye)>t,this.frustum.update(e),this.shortenFrustumFarPlane(this.frustum),this.updateExtendedFrustum(e,t)},e.prototype.end=function(){this.cache.clear()},e.prototype.calculate=function(e){if(this.allTilesInvisible)return 0;var t=1===this.renderCoordsHelper.viewingMode&&e.lij[0]>=c&&e.lij[0]<h,i=this.getOrCalculateSingleTileVisibility(e,!t);return 0!==i&&t?this.calculateAggregatedChildrenVisibility(e):i},e.prototype.shortenFrustumFarPlane=function(e){for(var t=u.Frustum.nearFarLineIndices,i=e.mutablePoints,r=0,n=t;r<n.length;r++){var a=n[r],o=a[0],l=a[1],d=i[o],c=i[l];s.vec3.subtract(f,c,d),s.vec3.scale(f,f,m),s.vec3.add(i[l],d,f)}e.updatePoints(i)},e.prototype.calculateAggregatedChildrenVisibility=function(e){var t=0,i=this.cache.get(e.id);if(null!=i)return i;var r=b.acquire();e.getChildren(r);for(var s=0,n=r;s<n.length;s++){var a=n[s],u=this.calculate(a);if(0!==u&&(t=u,2===u))break}return b.release(r),this.cache.set(e.id,t),t},e.prototype.getOrCalculateSingleTileVisibility=function(e,t){var i=this.cache.get(e.id);if(null!=i)return i;var r=this.calculateSingleTileVisibility(e);return t&&this.cache.set(e.id,r),r},e.prototype.calculateSingleTileVisibility=function(e){return!this.aboveGround&&1===this.renderCoordsHelper.viewingMode&&e.lij[0]<p?0===this.calculateSingleTileVisibilitySided(e,!1)?this.calculateSingleTileVisibilitySided(e,!0):void 0:this.calculateSingleTileVisibilitySided(e,this.aboveGround)},e.prototype.calculateSingleTileVisibilitySided=function(e,t){return this.intersector.update(e.extent,e.tilingScheme.spatialReference,this.surfaceElevation,t),this.intersector.isVisibleInFrustum(this.extendedFrustum)?this.intersector.isVisibleInFrustum(this.frustum,!0)?2:1:0},e.prototype.updateExtendedFrustum=function(e,t){var r,n,a=this.renderCoordsHelper;this.extendedFrustum.update(e),this.shortenFrustumFarPlane(this.extendedFrustum);var u=this.renderCoordsHelper.worldUpAtPosition(e.eye,f);this.aboveGround||s.vec3.negate(u,u);var o=i.acosClamped(-s.vec3.dot(u,e.viewForward));if(this.allTilesInvisible=o>(Math.PI+e.fovY)/2,!this.allTilesInvisible&&(this.hasExtendedFrustum=o>e.fovY/2,this.hasExtendedFrustum)){for(var d=this.extendedFrustumParameters(t),c=this.extendedFrustum.mutablePoints,h=0;h<4;h++){var p=d.pointIndices[h],m=c[p],b=a.getAltitude(m);if(d.needsAltitudeAdjustment(b)){switch(this.renderCoordsHelper.worldUpAtPosition(m,f),p){case 4:case 7:case 0:case 3:l.plane.projectVector(this.extendedFrustum.planes[0],f,f);break;case 5:case 6:case 1:case 2:l.plane.projectVector(this.extendedFrustum.planes[1],f,f)}s.vec3.scale(f,f,d.direction),this.renderCoordsHelper.intersectInfiniteManifold(l.ray.wrap(m,f),d.zWithMargin,m)}}if(this.extendedFrustum.updatePoints(c),l.plane.fromPoints(c[0],c[1],c[2],v),l.plane.fromPoints(c[1],c[2],c[3],F),s.vec3.dot(l.plane.normal(v),l.plane.normal(F))<0){var g=this.extendedFrustum.mutablePoints;this.aboveGround?(r=[g[1],g[0]],g[0]=r[0],g[1]=r[1]):(n=[g[2],g[3]],g[3]=n[0],g[2]=n[1]),this.extendedFrustum.updatePoints(g)}}},e.prototype.extendedFrustumParameters=function(e){return this.aboveGround?this.extendedFrustumParametersAboveSurface(e,1):this.extendedFrustumParametersBelowSurface(e,1)},e.prototype.extendedFrustumParametersAboveSurface=function(e,t){var i=e-t;return{zWithMargin:i,pointIndices:u.Frustum.planePointIndices.bottom,direction:-1,needsAltitudeAdjustment:function(e){return e>i}}},e.prototype.extendedFrustumParametersBelowSurface=function(e,t){var i=e+t;return{zWithMargin:i,pointIndices:u.Frustum.planePointIndices.top,direction:1,needsAltitudeAdjustment:function(e){return e<i}}},e}();t.FeatureTileVisibility3D=d;var c=2,h=6,p=12,m=.95,f=n.vec3f64.create(),v=l.plane.create(),F=l.plane.create(),b=new r(Array,(function(e){4!==e.length&&(e[0]=new a.FeatureTileDescriptor3D,e[1]=new a.FeatureTileDescriptor3D,e[2]=new a.FeatureTileDescriptor3D,e[3]=new a.FeatureTileDescriptor3D)}),(function(e){e[0].release(),e[1].release(),e[2].release(),e[3].release()}));t.default=d}));