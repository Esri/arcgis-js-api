/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/byteSizeEstimations","../../../../core/Error","../../../../core/HandleOwner","../../../../core/handleUtils","../../../../core/Logger","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/projection","../../../../geometry/support/scaleUtils","../../../../layers/graphics/dehydratedFeatures","../../../../layers/graphics/featureConversionUtils","../../../../layers/graphics/OptimizedFeature","../../../../layers/graphics/OptimizedGeometry","../../../../layers/graphics/data/FeatureStore","../../../../layers/support/fieldUtils","../../../../renderers/support/heatmapUtils","../../terrain/OverlayRenderer","../../webgl-engine/lib/basicInterfaces","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/ModelDirtyTypes","../../webgl-engine/lib/RenderGeometry","../../webgl-engine/lib/VertexAttribute","../../webgl-engine/materials/HeatmapDensityMaterial"],(function(e,t,r,a,o,i,n,s,l,u,p,d,c,m,h,y,_,f,g,F,R,v,P,b,w,H,S,G,M,k,x,T,N){"use strict";const O=s.getLogger("esri.views.3d.layers.support.HeatmapFeatureProcessor"),E=50;e.HeatmapFeatureProcessor=function(e){function r(t){var r;return(r=e.call(this,t)||this).type="heatmap",r.filterVisibility={filterChanged(){},dirty:!1},r.preferredUpdatePolicy=G.UpdatePolicy.ASYNC,r.dataExtent=null,r._renderGeometries=new Map,r._material=new N.HeatmapDensityMaterial({}),r._materialWithField=new N.HeatmapDensityMaterial({isAttributeDriven:!0}),r._fieldTotal=0,r._memoryFactor=1,r}t._inheritsLoose(r,e);var i=r.prototype;return i.initialize=function(){this._featureStore=new b({geometryType:"esriGeometryPoint",hasZ:this.hasZ,hasM:this.hasM});const{colorBufferFloat:e,textureFloat:t}=this._renderView.capabilities,{floatBufferBlendWorking:r}=this._renderView.renderingContext.driverTest;if(null==t||!t.textureFloat)throw new o("heatmap:missing-texture-float","HeatmapRenderer requires WebGL2 or the WebGL1 extension OES_texture_float.");if(null==e||!e.textureFloat)throw new o("heatmap:missing-color-buffer-float","HeatmapRenderer requires the WebGL2 extension EXT_color_buffer_float or the WebGL1 extension WEBGL_color_buffer_float.");if(null==e||!e.floatBlend)throw new o("heatmap:missing-float-blend","HeatmapRenderer requires the WebGL extension EXT_float_blend.");if(!r)throw new o("heatmap:missing-float-blend","HeatmapRenderer requires the WebGL extension EXT_float_blend. This device claims support for it, but does not actually support it.");this._memoryFactor=this.owner.view.resourceController.memoryController.memoryFactor,this.updatingHandles.addOnCollectionChange((()=>this._loadedPointGraphics),(e=>this._onLoadedFeaturesChange(e)),u.initial),this.updatingHandles.addWhen((()=>this._materialParameters),(e=>this._forEachMaterial((t=>t.setParameters(e)))),u.initial),this.updatingHandles.add((()=>this._heatmapRendererField),(()=>{this._recreate()}),u.sync),this.updatingHandles.add((()=>({fieldName:this._heatmapRendererFieldName,numeric:this._heatmapRendererFieldIsNumeric})),(({fieldName:e,numeric:t})=>{if(l.isSome(e)&&t){let t=0;this._featureStore.forEach((r=>{var a;t+=null!=(a=r.attributes[e])?a:0})),this._fieldTotal=t}else this._fieldTotal=this._featureStore.numFeatures}),u.initial),this.handles.add([u.watch((()=>({fieldName:this._heatmapRendererFieldName,field:this._heatmapRendererField})),(({fieldName:e,field:t})=>{var r;e&&!t&&O.warn(`Heatmap renderer field '${e}' for layer '${null!=(r=this.layer.title)?r:this.layer.id}' not found`)})),u.watch((()=>({field:this._heatmapRendererField,numeric:this._heatmapRendererFieldIsNumeric})),(({field:e,numeric:t})=>{var r;l.isSome(e)&&!t&&O.warn(`Heatmap renderer field '${e.name}' for layer '${null!=(r=this.layer.title)?r:this.layer.id}' does not contain numeric values and cannot be used to drive the heatmap density`)})),this.owner.view.resourceController.memoryController.events.on("quality-changed",(()=>{var e,t,r,a,o;this._memoryFactor=null!=(e=null==(t=this.owner)||null==(r=t.view)||null==(a=r.resourceController)||null==(o=a.memoryController)?void 0:o.memoryFactor)?e:1}))])},i.destroy=function(){this._overlayRenderer.removeGeometries(Array.from(this._renderGeometries.values()),this.owner,k.ModelDirty.Geometry.REMOVE),this._renderGeometries.clear(),this._material=l.disposeMaybe(this._material),this._materialWithField=l.disposeMaybe(this._materialWithField),this._featureStore.clear(),this._featureStore=null},i.whenGraphicBounds=function(){var e=t._asyncToGenerator((function*(){return null}));function r(){return e.apply(this,arguments)}return r}(),i.computeAttachmentOrigin=function(){return null},i.highlight=function(){return I},i.maskOccludee=function(){return I},i.setObjectIdVisibility=function(){},i.setup=function(){var e=t._asyncToGenerator((function*(){}));function r(){return e.apply(this,arguments)}return r}(),i._onLoadedFeaturesChange=function(e){if(!this._featuresArePoints)return;const{objectIdField:t}=this.layer;this._featureStore.removeManyById(e.removed.map((e=>F.getObjectId(e,t)))),this._featureStore.addMany(e.added.map((e=>new v.OptimizedFeature(R.convertFromPoint(new P,e.geometry),e.attributes,l.applySome(e.centroid,(e=>R.convertFromPoint(new P,e))),F.getObjectId(e,t)))));const r=e.added,a=e.removed;this._fieldTotal+=this._computeFieldTotalChange(r,a);const o=l.mapSome(a,(({uid:e})=>{const t=this._renderGeometries.get(e);return this._renderGeometries.delete(e),t})),i=r.map((e=>{const t=this._pointGraphicToRenderGeometry(e);return this._renderGeometries.set(e.uid,t),t}));o.length>0&&this._overlayRenderer.removeGeometries(o,this.owner,k.ModelDirty.Geometry.REMOVE),i.length>0&&this._overlayRenderer.addGeometries(i,this.owner,k.ModelDirty.Geometry.ADD,!0),(i.length>0||o.length>0)&&this._renderView.requestRender()},i._recreate=function(){if(!this._loadedPointGraphics)return;const e=this._loadedPointGraphics.toArray();this._onLoadedFeaturesChange({added:e,removed:e})},i._pointGraphicToRenderGeometry=function(e){const t=this._heatmapRendererFieldName,r=l.isSome(t)?this._materialWithField:this._material,a=_.create();f.projectPointToVector(e.geometry,a,this._overlaySpatialReference),a[2]=S.DRAPED_Z;const o=[[T.VertexAttribute.POSITION,{data:a,size:a.length}]],i=this._heatmapRendererFieldIsNumeric;var n;l.isSome(t)&&o.push([T.VertexAttribute.FEATUREATTRIBUTE,{data:[i&&null!=(n=e.attributes[t])?n:0],size:1}]);const s=new x.RenderGeometry(new M.Geometry(o,null,G.PrimitiveType.Point),r,{layerUid:this.layer.uid,graphicUid:e.uid});return y.copy(s.boundingSphere,a),s},i._forEachMaterial=function(e){e(this._material),e(this._materialWithField)},i._computeFieldTotalChange=function(e,t){if(l.isNone(this._heatmapRendererFieldName)||!this._heatmapRendererFieldIsNumeric)return e.length-t.length;const r=this._heatmapRendererFieldName,a=(e,t)=>{var a;return e+(null!=(a=t.attributes[r])?a:0)};return e.reduce(a,0)-t.reduce(a,0)},i._clampSearchRadius=function(e){return e>E&&O.warnOnce(`SceneView supports a maximum blurRadius of ${E} for HeatmapRenderer.`),Math.min(e,E)},t._createClass(r,[{key:"layer",get:function(){return this.owner.layer}},{key:"featureStore",get:function(){return this._featureStore}},{key:"updating",get:function(){return this.updatingHandles.updating}},{key:"updatingRemaining",get:function(){return 0}},{key:"suspendInfo",get:function(){return{}}},{key:"legendEnabled",get:function(){return!0}},{key:"displayFeatureLimit",get:function(){var e,t;const r=this._memoryFactor,a=null==(e=this.owner)||null==(t=e.view)?void 0:t.qualitySettings,o=a?Math.ceil(a.heatmap.maxTotalNumberOfFeatures*r):0;return{minimumTotalNumberOfFeatures:0,maximumTotalNumberOfFeatures:o,maximumTotalNumberOfPrimitives:o*2,maximumNumberOfFeatures:o}}},{key:"hasZ",get:function(){return"hasZ"in this.layer&&this.layer.hasZ}},{key:"hasM",get:function(){return"hasM"in this.layer&&this.layer.hasM}},{key:"scaleVisibilitySuspended",get:function(){return!1}},{key:"usedMemory",get:function(){var e,t,r,a,o;const i=this.usedMemoryPerFeature*this._featureStore.numFeatures,{R32F:n}=null==(e=this._renderView)||null==(t=e.capabilities)?void 0:t.colorBufferFloat,s=null!=n?1:4,u=4,p=null!=(r=Math.ceil((null==(a=this._overlayRenderer)||null==(o=a.overlays[0])?void 0:o.resolution)*this._densityMapPixelRatio))?r:0;return p*p*s*u+i+(l.isSome(this._heatmapRenderer)?3*Math.min(this._heatmapRenderer.blurRadius,E):0)*s*u}},{key:"usedMemoryPerFeature",get:function(){if(0===this._featureStore.numFeatures)return 0;let e=0;this._featureStore.forEach((t=>e+=a.estimateAttributesObjectSize(t.attributes))),e/=this._featureStore.numFeatures;const t=a.estimateNumberByteSize(),r=6;return r*a.estimateFixedArraySize([0,0,0],t)+r*a.estimateFixedArraySize([0,0],t)+(this._heatmapRendererFieldIsNumeric?r*t:0)+e}},{key:"unprocessedMemoryEstimate",get:function(){return 0}},{key:"performanceInfo",get:function(){return{core:{visible:this._featureStore.numFeatures,missing:0,pending:0},elevationUpdating:!1,visibilityFrustum:!0,visibilityScale:!0}}},{key:"_overlayRenderer",get:function(){return this.owner.view.basemapTerrain.overlayManager.renderer}},{key:"_overlaySpatialReference",get:function(){return l.unwrap(this._overlayRenderer.spatialReference)}},{key:"_materialParameters",get:function(){return{...this._blurRadiusParameters,...this._densityParameters,colorRampData:this._colorRampData,pixelRatio:this._densityMapPixelRatio}}},{key:"_densityParameters",get:function(){const e=this._heatmapRenderer;if(l.isNone(e))return null;return{minDensity:e.minPixelIntensity,maxDensity:e.maxPixelIntensity,fieldTotal:this._fieldTotal}}},{key:"_blurRadiusParameters",get:function(){return l.applySome(this._heatmapRenderer,(({referenceScale:e,blurRadius:t})=>({searchRadius:this._clampSearchRadius(t),resolutionForScale:0===e?0:g.getResolutionForScale(e,this.owner.view.spatialReference)})))}},{key:"_colorRampData",get:function(){return l.applySome(this._heatmapRenderer,(e=>H.generateGradient(e.colorStops)))}},{key:"_densityMapPixelRatio",get:function(){var e,t,r;const a=this._memoryFactor;return(null!=(e=null==(t=this.owner)||null==(r=t.view)?void 0:r.qualitySettings.heatmap.pixelRatio)?e:1)*Math.sqrt(a)}},{key:"_renderView",get:function(){return this.owner.view._stage.renderView}},{key:"_featuresArePoints",get:function(){return"point"===this.layer.geometryType}},{key:"_loadedPointGraphics",get:function(){return this.owner.loadedGraphics}},{key:"_heatmapRenderer",get:function(){const e=this.layer.renderer;return"heatmap"===(null==e?void 0:e.type)?e:null}},{key:"_heatmapRendererFieldName",get:function(){return l.applySome(this._heatmapRenderer,(e=>e.field))}},{key:"_heatmapRendererField",get:function(){return l.applySome(this._heatmapRendererFieldName,(e=>this.layer.fieldsIndex.get(e)))}},{key:"_heatmapRendererFieldIsNumeric",get:function(){const e=this._heatmapRendererField;return!l.isNone(e)&&w.isNumericField(e)}}]),r}(i.HandleOwner),r.__decorate([p.property()],e.HeatmapFeatureProcessor.prototype,"type",void 0),r.__decorate([p.property({constructOnly:!0})],e.HeatmapFeatureProcessor.prototype,"owner",void 0),r.__decorate([p.property()],e.HeatmapFeatureProcessor.prototype,"layer",null),r.__decorate([p.property()],e.HeatmapFeatureProcessor.prototype,"featureStore",null),r.__decorate([p.property()],e.HeatmapFeatureProcessor.prototype,"updating",null),r.__decorate([p.property()],e.HeatmapFeatureProcessor.prototype,"updatingRemaining",null),r.__decorate([p.property()],e.HeatmapFeatureProcessor.prototype,"suspendInfo",null),r.__decorate([p.property()],e.HeatmapFeatureProcessor.prototype,"legendEnabled",null),r.__decorate([p.property()],e.HeatmapFeatureProcessor.prototype,"filterVisibility",void 0),r.__decorate([p.property()],e.HeatmapFeatureProcessor.prototype,"displayFeatureLimit",null),r.__decorate([p.property()],e.HeatmapFeatureProcessor.prototype,"preferredUpdatePolicy",void 0),r.__decorate([p.property()],e.HeatmapFeatureProcessor.prototype,"hasZ",null),r.__decorate([p.property()],e.HeatmapFeatureProcessor.prototype,"hasM",null),r.__decorate([p.property()],e.HeatmapFeatureProcessor.prototype,"dataExtent",void 0),r.__decorate([p.property()],e.HeatmapFeatureProcessor.prototype,"_featureStore",void 0),r.__decorate([p.property()],e.HeatmapFeatureProcessor.prototype,"_overlayRenderer",null),r.__decorate([p.property()],e.HeatmapFeatureProcessor.prototype,"_overlaySpatialReference",null),r.__decorate([p.property()],e.HeatmapFeatureProcessor.prototype,"_materialParameters",null),r.__decorate([p.property()],e.HeatmapFeatureProcessor.prototype,"_densityParameters",null),r.__decorate([p.property()],e.HeatmapFeatureProcessor.prototype,"_blurRadiusParameters",null),r.__decorate([p.property()],e.HeatmapFeatureProcessor.prototype,"_colorRampData",null),r.__decorate([p.property()],e.HeatmapFeatureProcessor.prototype,"_densityMapPixelRatio",null),r.__decorate([p.property()],e.HeatmapFeatureProcessor.prototype,"_renderGeometries",void 0),r.__decorate([p.property()],e.HeatmapFeatureProcessor.prototype,"_material",void 0),r.__decorate([p.property()],e.HeatmapFeatureProcessor.prototype,"_materialWithField",void 0),r.__decorate([p.property()],e.HeatmapFeatureProcessor.prototype,"_renderView",null),r.__decorate([p.property()],e.HeatmapFeatureProcessor.prototype,"_featuresArePoints",null),r.__decorate([p.property()],e.HeatmapFeatureProcessor.prototype,"_loadedPointGraphics",null),r.__decorate([p.property()],e.HeatmapFeatureProcessor.prototype,"_heatmapRenderer",null),r.__decorate([p.property()],e.HeatmapFeatureProcessor.prototype,"_heatmapRendererFieldName",null),r.__decorate([p.property()],e.HeatmapFeatureProcessor.prototype,"_heatmapRendererField",null),r.__decorate([p.property()],e.HeatmapFeatureProcessor.prototype,"_heatmapRendererFieldIsNumeric",null),r.__decorate([p.property()],e.HeatmapFeatureProcessor.prototype,"_fieldTotal",void 0),r.__decorate([p.property()],e.HeatmapFeatureProcessor.prototype,"_memoryFactor",void 0),e.HeatmapFeatureProcessor=r.__decorate([h.subclass("esri.views.3d.layers.support.HeatmapFeatureProcessor")],e.HeatmapFeatureProcessor);const I=n.makeHandle();e.MAX_RADIUS=E,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
