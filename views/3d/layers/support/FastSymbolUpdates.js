/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../core/has","../../../../core/mathUtils","../../../../chunks/mat3","../../../../chunks/mat3f64","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../renderers/support/lengthUtils","../../support/debugFlags"],(function(e,t,o,i,n,s,r,l,a,u,f){"use strict";var c,p,d;function v(e){return null!=e}function z(e){return"number"==typeof e}function S(e){return"string"==typeof e}function y(e){return null==e||S(e)}function m(e,t){e&&e.push(t)}function h(e,t,o,i=r.create()){const n=e||0,l=t||0,a=o||0;return 0!==n&&s.rotateZ(i,i,-n/180*Math.PI),0!==l&&s.rotateX(i,i,l/180*Math.PI),0!==a&&s.rotateY(i,i,a/180*Math.PI),i}function T(t,o,i,n,s){const r=t.minSize,l=t.maxSize;if(t.expression)return m(s,"Could not convert size info: expression not supported"),!1;if(t.useSymbolValue){const t=n.symbolSize[i];return o.minSize[i]=t,o.maxSize[i]=t,o.offset[i]=o.minSize[i],o.factor[i]=0,o.type[i]=e.FastSizeType.DefinedSize,!0}if(v(t.field))return v(t.stops)?2===t.stops.length&&z(t.stops[0].size)&&z(t.stops[1].size)?(b(t.stops[0].size,t.stops[1].size,t.stops[0].value,t.stops[1].value,o,i),o.type[i]=e.FastSizeType.DefinedSize,!0):(m(s,"Could not convert size info: stops only supported with 2 elements"),!1):z(r)&&z(l)&&v(t.minDataValue)&&v(t.maxDataValue)?(b(r,l,t.minDataValue,t.maxDataValue,o,i),o.type[i]=e.FastSizeType.DefinedSize,!0):null!=u.meterIn[t.valueUnit]?(o.minSize[i]=-1/0,o.maxSize[i]=1/0,o.offset[i]=0,o.factor[i]=1/u.meterIn[t.valueUnit],o.type[i]=e.FastSizeType.DefinedSize,!0):"unknown"===t.valueUnit?(m(s,"Could not convert size info: proportional size not supported"),!1):(m(s,"Could not convert size info: scale-dependent size not supported"),!1);if(!v(t.field)){if(t.stops&&t.stops[0]&&z(t.stops[0].size))return o.minSize[i]=t.stops[0].size,o.maxSize[i]=t.stops[0].size,o.offset[i]=o.minSize[i],o.factor[i]=0,o.type[i]=e.FastSizeType.DefinedSize,!0;if(z(r))return o.minSize[i]=r,o.maxSize[i]=r,o.offset[i]=r,o.factor[i]=0,o.type[i]=e.FastSizeType.DefinedSize,!0}return m(s,"Could not convert size info: unsupported variant of sizeInfo"),!1}function b(e,t,o,i,n,s){const r=Math.abs(i-o)>0?(t-e)/(i-o):0;n.minSize[s]=r>0?e:t,n.maxSize[s]=r>0?t:e,n.offset[s]=e-o*r,n.factor[s]=r}function x(t,o,i,n){if(t.normalizationField||t.valueRepresentation)return m(n,"Could not convert size info: unsupported property"),null;if(!y(t.field))return m(n,"Could not convert size info: field is not a string"),null;if(o.size){if(t.field)if(o.size.field){if(t.field!==o.size.field)return m(n,"Could not convert size info: multiple fields in use"),null}else o.size.field=t.field}else o.size={field:t.field,minSize:[0,0,0],maxSize:[0,0,0],offset:[0,0,0],factor:[0,0,0],type:[e.FastSizeType.Undefined,e.FastSizeType.Undefined,e.FastSizeType.Undefined]};let s;switch(t.axis){case"width":return s=T(t,o.size,0,i,n),s?o:null;case"height":return s=T(t,o.size,2,i,n),s?o:null;case"depth":return s=T(t,o.size,1,i,n),s?o:null;case"width-and-depth":return s=T(t,o.size,0,i,n),s&&T(t,o.size,1,i,n),s?o:null;case null:case void 0:case"all":return s=T(t,o.size,0,i,n),s=s&&T(t,o.size,1,i,n),s=s&&T(t,o.size,2,i,n),s?o:null;default:return m(n,`Could not convert size info: unknown axis "${t.axis}""`),null}}function F(t,o,i){for(let s=0;s<3;++s){let i=o.unitInMeters;t.type[s]===e.FastSizeType.DefinedSize&&(i*=o.modelSize[s],t.type[s]=e.FastSizeType.DefinedScale),t.minSize[s]=t.minSize[s]/i,t.maxSize[s]=t.maxSize[s]/i,t.offset[s]=t.offset[s]/i,t.factor[s]=t.factor[s]/i}let n;if(t.type[0]!==e.FastSizeType.Undefined)n=0;else if(t.type[1]!==e.FastSizeType.Undefined)n=1;else{if(t.type[2]===e.FastSizeType.Undefined)return m(i,"No size axis contains a valid size or scale"),!1;n=2}for(let s=0;s<3;++s)t.type[s]===e.FastSizeType.Undefined&&(t.minSize[s]=t.minSize[n],t.maxSize[s]=t.maxSize[n],t.offset[s]=t.offset[n],t.factor[s]=t.factor[n],t.type[s]=t.type[n]);return!0}function C(e,t,o){e[4*t+0]=o.r/255,e[4*t+1]=o.g/255,e[4*t+2]=o.b/255,e[4*t+3]=o.a}function M(e,t,o){if(e.normalizationField)return m(o,"Could not convert color info: unsupported property"),null;if(S(e.field)){if(!e.stops)return m(o,"Could not convert color info: missing stops or colors"),null;{if(e.stops.length>8)return m(o,"Could not convert color info: too many color stops"),null;t.color={field:e.field,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};const i=e.stops;for(let e=0;e<8;++e){const o=i[Math.min(e,i.length-1)];t.color.values[e]=o.value,C(t.color.colors,e,o.color)}}}else{if(!(e.stops&&e.stops.length>=0))return m(o,"Could not convert color info: no field and no colors/stops"),null;{const o=e.stops&&e.stops.length>=0&&e.stops[0].color;t.color={field:null,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};for(let e=0;e<8;e++)t.color.values[e]=1/0,C(t.color.colors,e,o)}}return t}function g(e,t,o){if(e.normalizationField)return m(o,"Could not convert opacity info: unsupported property"),null;if(S(e.field)){if(!e.stops)return m(o,"Could not convert opacity info: missing stops or opacities"),null;{if(e.stops.length>8)return m(o,"Could not convert opacity info: too many opacity stops"),null;t.opacity={field:e.field,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0]};const i=e.stops;for(let e=0;e<8;++e){const o=i[Math.min(e,i.length-1)];t.opacity.values[e]=o.value,t.opacity.opacityValues[e]=o.opacity}}}else{if(!(e.stops&&e.stops.length>=0))return m(o,"Could not convert opacity info: no field and no opacities/stops"),null;{const o=e.stops&&e.stops.length>=0&&e.stops[0].opacity;t.opacity={field:null,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0]};for(let e=0;e<8;e++)t.opacity.values[e]=1/0,t.opacity.opacityValues[e]=o}}return t}function V(e,t,o){const i=2===o&&"arithmetic"===e.rotationType;t.offset[o]=i?90:0,t.factor[o]=i?-1:1,t.type[o]=1}function D(e,t,o){if(!S(e.field))return m(o,"Could not convert rotation info: field is not a string"),null;if(t.rotation){if(e.field)if(t.rotation.field){if(e.field!==t.rotation.field)return m(o,"Could not convert rotation info: multiple fields in use"),null}else t.rotation.field=e.field}else t.rotation={field:e.field,offset:[0,0,0],factor:[1,1,1],type:[0,0,0]};switch(e.axis){case"tilt":return V(e,t.rotation,0),t;case"roll":return V(e,t.rotation,1),t;case null:case void 0:case"heading":return V(e,t.rotation,2),t;default:return m(o,`Could not convert rotation info: unknown axis "${e.axis}""`),null}}function U(e,t,o){if(!e)return null;const i=!t.supportedTypes||!!t.supportedTypes.size,n=!t.supportedTypes||!!t.supportedTypes.color,s=!t.supportedTypes||!!t.supportedTypes.rotation,r=!!t.supportedTypes&&!!t.supportedTypes.opacity,l=e.reduce(((e,l)=>{if(!e)return e;if(l.valueExpression)return m(o,"Could not convert visual variables: arcade expressions not supported"),null;switch(l.type){case"size":return i?x(l,e,t,o):e;case"color":return n?M(l,e,o):e;case"opacity":return r?g(l,e,o):null;case"rotation":return s?D(l,e,o):e;default:return null}}),{size:null,color:null,opacity:null,rotation:null});return!(e.length>0&&l)||l.size||l.color||l.opacity||l.rotation?l&&l.size&&!F(l.size,t,o)?null:l:null}function O(e){return e&&null!=e.size}function E(e,t){if(!e)return{enabled:!1};if(f.TESTS_DISABLE_FAST_UPDATES)return{enabled:!1};const o=U(e.visualVariables,t);return o?{enabled:!0,visualVariables:o,materialParameters:A(o,t),requiresShaderTransformation:O(o)}:{enabled:!1}}function k(e,t,o){if(!t||!e.enabled)return!1;const i=e.visualVariables,n=U(t.visualVariables,o);return!!n&&(!!(w(i.size,n.size,"size")&&w(i.color,n.color,"color")&&w(i.rotation,n.rotation,"rotation")&&w(i.opacity,n.opacity,"opacity"))&&(e.visualVariables=n,e.materialParameters=A(n,o),e.requiresShaderTransformation=O(n),!0))}function w(e,t,o){if(!!e!=!!t)return!1;if(e&&e.field!==t.field)return!1;if(e&&"rotation"===o){const o=e,i=t;for(let e=0;e<3;e++)if(o.type[e]!==i.type[e]||o.offset[e]!==i.offset[e]||o.factor[e]!==i.factor[e])return!1}return!0}function A(e,t){const o={vvSizeEnabled:!1,vvSizeMinSize:null,vvSizeMaxSize:null,vvSizeOffset:null,vvSizeFactor:null,vvSizeValue:null,vvColorEnabled:!1,vvColorValues:null,vvColorColors:null,vvOpacityEnabled:!1,vvOpacityValues:null,vvOpacityOpacities:null,vvSymbolAnchor:null,vvSymbolRotationMatrix:null},r=O(e);return e&&e.size?(o.vvSizeEnabled=!0,o.vvSizeMinSize=e.size.minSize,o.vvSizeMaxSize=e.size.maxSize,o.vvSizeOffset=e.size.offset,o.vvSizeFactor=e.size.factor):e&&r&&(o.vvSizeValue=t.transformation.scale),e&&r&&(o.vvSymbolAnchor=t.transformation.anchor,o.vvSymbolRotationMatrix=n.create(),s.identity(I),h(t.transformation.rotation[2],t.transformation.rotation[0],t.transformation.rotation[1],I),i.fromMat4(o.vvSymbolRotationMatrix,I)),e&&e.color&&(o.vvColorEnabled=!0,o.vvColorValues=e.color.values,o.vvColorColors=e.color.colors),e&&e.opacity&&(o.vvOpacityEnabled=!0,o.vvOpacityValues=e.opacity.values,o.vvOpacityOpacities=e.opacity.opacityValues),o}e.FastSizeType=void 0,(c=e.FastSizeType||(e.FastSizeType={}))[c.Undefined=0]="Undefined",c[c.DefinedSize=1]="DefinedSize",c[c.DefinedScale=2]="DefinedScale",e.FastRotationType=void 0,(p=e.FastRotationType||(e.FastRotationType={}))[p.Undefined=0]="Undefined",p[p.DefinedAngle=1]="DefinedAngle",function(e){const t=r.create(),i=a.create();function n(e,n,r){if(!e.vvSizeEnabled)return r;s.copy(t,r);const l=e.vvSymbolRotationMatrix;s.set(I,l[0],l[1],l[2],0,l[3],l[4],l[5],0,l[6],l[7],l[8],0,0,0,0,1),s.multiply(t,t,I);for(let t=0;t<3;++t){const s=e.vvSizeOffset[t]+n[0]*e.vvSizeFactor[t];i[t]=o.clamp(s,e.vvSizeMinSize[t],e.vvSizeMaxSize[t])}return s.scale(t,t,i),s.translate(t,t,e.vvSymbolAnchor),t}function u(e,t,i){if(!t.vvSizeEnabled)return l.set(e,1,1,1);for(let n=0;n<3;++n){const s=t.vvSizeOffset[n]+i[0]*t.vvSizeFactor[n];e[n]=o.clamp(s,t.vvSizeMinSize[n],t.vvSizeMaxSize[n])}return e}e.evaluateModelTransform=n,e.evaluateModelTransformScale=u}(d||(d={}));const I=r.create(),P=d.evaluateModelTransform,R=d.evaluateModelTransformScale;e.convertVisualVariables=U,e.evaluateModelTransform=P,e.evaluateModelTransformScale=R,e.getMaterialParams=A,e.initFastSymbolUpdatesState=E,e.updateFastSymbolUpdatesState=k,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
