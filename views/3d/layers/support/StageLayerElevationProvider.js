/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import t from"../../../../core/Accessor.js";import o from"../../../../core/Evented.js";import r from"../../../../core/Handles.js";import s from"../../../../core/Logger.js";import{unwrapOr as i}from"../../../../core/maybe.js";import{getMetersPerVerticalUnitForSR as n}from"../../../../core/unitUtils.js";import{property as a}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/arrayUtils.js";import"../../../../core/has.js";import"../../../../core/accessorSupport/ensureType.js";import{subclass as l}from"../../../../core/accessorSupport/decorators/subclass.js";import{c}from"../../../../chunks/vec3.js";import{c as d}from"../../../../chunks/vec3f64.js";import{empty as m,toRect as p,expandWithVec3 as h}from"../../../../geometry/support/aaBoundingBox.js";import{empty as u}from"../../../../geometry/support/aaBoundingRect.js";import{getMetersPerUnit as f}from"../../../../symbols/support/unitConversionUtils.js";import{newIntersector as y}from"../../webgl-engine/lib/Intersector.js";import{StoreResults as v}from"../../webgl-engine/lib/IntersectorInterfaces.js";const g=s.getLogger("esri.views.3d.layers.support.StageLayerElevationProvider"),j=1;let b=class extends(o.EventedMixin(t)){constructor(e){super(e),this.elevationOffset=0,this._layerHandes=new r}initialize(){this.renderCoordsHelper=this.view.renderCoordsHelper,this.intersectLayers=[this.stageLayer],this.intersector=y(this.view.state.viewingMode),this.intersector.options.store=v.MIN;const e=this._computeLayerExtent(this.stageLayer);this.zmin=e[2],this.zmax=e[5];const t=this.stageLayer.events;this._layerHandes.add([t.on("layerObjectAdded",(e=>this._objectChanged(e.object))),t.on("layerObjectRemoved",(e=>this._objectChanged(e.object))),t.on("objectGeometryAdded",(e=>this._objectChanged(e.object))),t.on("objectGeometryRemoved",(e=>this._objectChanged(e.object))),t.on("vertexAttrsUpdated",(e=>this._objectChanged(e.object))),t.on("objectTransformation",(e=>this._objectChanged(e)))])}dispose(){this._layerHandes.destroy()}elevationInfoChanged(){const e=null!=this.layer?this.layer.elevationInfo:null;if(null!=e&&"on-the-ground"!==e.mode){const t=n(this.layer.spatialReference),o=f(e.unit);this.elevationOffset=i(e.offset,0)*o/t}else this.elevationOffset=0}getElevation(e,t,o,r){if(_[0]=e,_[1]=t,_[2]=o,!this.renderCoordsHelper.toRenderCoords(_,r,_))return g.error("could not project point for elevation alignment"),null;const s=this.elevationOffset,i=this.zmin+s,n=this.zmax+s;this.renderCoordsHelper.setAltitude(B,n,_),this.renderCoordsHelper.setAltitude(R,i,_);const a=e=>e.metadata&&e.metadata.isElevationSource;return this.intersector.reset(B,R,null),this.intersector.intersect(this.intersectLayers,null,j,null,a),this.intersector.results.min.getIntersectionPoint(_)?this.renderCoordsHelper.getAltitude(_):null}_objectChanged(e){if(!e.metadata?.isElevationSource||!this.spatialReference)return;m(x),e.metadata.lastValidElevationBB.isEmpty()||this._expandExtent(e.metadata.lastValidElevationBB.min,e.metadata.lastValidElevationBB.max,x);const t=e.boundingVolumeWorldSpace.min,o=e.boundingVolumeWorldSpace.max;this._expandExtent(t,o,x),p(x,E),this.zmin=Math.min(this.zmin,x[2]),this.zmax=Math.max(this.zmax,x[5]),C.extent=E,C.spatialReference=this.spatialReference,this.emit("elevation-change",C),c(e.metadata.lastValidElevationBB.min,t),c(e.metadata.lastValidElevationBB.max,o)}_computeLayerExtent(e){return m(x),e.objects.forAll((e=>this._expandExtent(e.boundingVolumeWorldSpace.min,e.boundingVolumeWorldSpace.max,x))),x}_expandExtent(e,t,o){for(let r=0;r<8;++r)_[0]=1&r?e[0]:t[0],_[1]=2&r?e[1]:t[1],_[2]=4&r?e[2]:t[2],this.renderCoordsHelper.fromRenderCoords(_,_,this.spatialReference),h(o,_);return o}};e([a({constructOnly:!0})],b.prototype,"layer",void 0),e([a({constructOnly:!0})],b.prototype,"stageLayer",void 0),e([a({constructOnly:!0})],b.prototype,"view",void 0),e([a({readOnly:!0,aliasOf:"view.spatialReference"})],b.prototype,"spatialReference",void 0),b=e([l("esri.views.3d.layers.support.StageLayerElevationProvider")],b);const x=m(),E=u(),C={spatialReference:null,extent:E,context:"scene"},_=d(),B=d(),R=d();export{b as StageLayerElevationProvider};
