/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Evented","../../../../core/Handles","../../../../core/Logger","../../../../core/maybe","../../../../core/unitUtils","../../../../core/accessorSupport/decorators/property","../../../../core/arrayUtils","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../symbols/support/unitConversionUtils","../../webgl-engine/lib/Intersector","../../webgl-engine/lib/IntersectorInterfaces"],(function(e,t,r,o,n,s,i,a,c,l,d,p,u,h,y,_,v,g,m,f){"use strict";const b=1;e.StageLayerElevationProvider=function(e){function r(t){var r;return(r=e.call(this,t)||this)._elevationOffset=0,r._layerHandes=new s,r}t._inheritsLoose(r,e);var o=r.prototype;return o.initialize=function(){this._renderCoordsHelper=this.view.renderCoordsHelper,this._intersectLayers=[this.stageLayer],this._intersector=m.newIntersector(this.view.state.viewingMode),this._intersector.options.store=f.StoreResults.MIN;const e=this._computeLayerExtent(this.spatialReference,this.stageLayer);this._zmin=e[2],this._zmax=e[5];const t=this.stageLayer.events;this._layerHandes.add([t.on("layerObjectAdded",(e=>this._objectChanged(e.object))),t.on("layerObjectRemoved",(e=>this._objectChanged(e.object))),t.on("objectGeometryAdded",(e=>this._objectChanged(e.object))),t.on("objectGeometryRemoved",(e=>this._objectChanged(e.object))),t.on("vertexAttrsUpdated",(e=>this._objectChanged(e.object))),t.on("objectTransformation",(e=>this._objectChanged(e)))])},o.dispose=function(){this._layerHandes.destroy()},o.elevationInfoChanged=function(){const e=null!=this.layer?this.layer.elevationInfo:null;if(null!=e&&"on-the-ground"!==e.mode){const t=c.getMetersPerVerticalUnitForSR(this.layer.spatialReference),r=g.getMetersPerUnit(e.unit);this._elevationOffset=a.unwrapOr(e.offset,0)*r/t}else this._elevationOffset=0},o.getElevation=function(e,t,r,o){if(j[0]=e,j[1]=t,j[2]=r,!this._renderCoordsHelper.toRenderCoords(j,o,j))return i.getLogger(this.declaredClass).error("could not project point for elevation alignment"),null;const n=this._elevationOffset,s=this._zmin+n,a=this._zmax+n;this._renderCoordsHelper.setAltitude(C,a,j),this._renderCoordsHelper.setAltitude(L,s,j);const c=e=>e.metadata&&e.metadata.isElevationSource;return this._intersector.reset(C,L,null),this._intersector.intersect(this._intersectLayers,null,b,null,c),this._intersector.results.min.getIntersectionPoint(j)?this._renderCoordsHelper.getAltitude(j):null},o._objectChanged=function(e){const t=this.spatialReference;if(!e.metadata?.isElevationSource||a.isNone(t))return;_.empty(x);const{lastValidElevationBB:r}=e.metadata;r.isEmpty()||this._expandExtent(t,r.min,r.max,x);const{min:o,max:n}=e.boundingVolumeWorldSpace;this._expandExtent(t,o,n,x),_.toRect(x,E),this._zmin=Math.min(this._zmin,x[2]),this._zmax=Math.max(this._zmax,x[5]),S.extent=E,S.spatialReference=t,this.emit("elevation-change",S),h.copy(r.min,o),h.copy(r.max,n)},o._computeLayerExtent=function(e,t){return _.empty(x),a.isSome(e)&&t.objects.forAll((t=>this._expandExtent(e,t.boundingVolumeWorldSpace.min,t.boundingVolumeWorldSpace.max,x))),x},o._expandExtent=function(e,t,r,o){for(let n=0;n<8;++n)j[0]=1&n?t[0]:r[0],j[1]=2&n?t[1]:r[1],j[2]=4&n?t[2]:r[2],this._renderCoordsHelper.fromRenderCoords(j,j,e),_.expandWithVec3(o,j);return o},t._createClass(r,[{key:"spatialReference",get:function(){return this.view?.spatialReference}}]),r}(n.EventedMixin(o)),r.__decorate([l.property({constructOnly:!0})],e.StageLayerElevationProvider.prototype,"layer",void 0),r.__decorate([l.property({constructOnly:!0})],e.StageLayerElevationProvider.prototype,"stageLayer",void 0),r.__decorate([l.property({constructOnly:!0})],e.StageLayerElevationProvider.prototype,"view",void 0),r.__decorate([l.property()],e.StageLayerElevationProvider.prototype,"spatialReference",null),e.StageLayerElevationProvider=r.__decorate([u.subclass("esri.views.3d.layers.support.StageLayerElevationProvider")],e.StageLayerElevationProvider);const x=_.empty(),E=v.empty(),S={spatialReference:null,extent:E,context:"scene"},j=y.create(),C=y.create(),L=y.create();Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
