/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/has","../../../../core/maybe","../../../../core/Logger","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/decorators/subclass","../../../../core/urlUtils","../../../../core/uuid","../../../../portal/support/resourceExtension","../../../../core/Accessor","../../../../core/Evented","../../../../chunks/vec3f64","../../../../chunks/vec3","../../../../core/unitUtils","../../../../geometry/support/aaBoundingRect","../../../../symbols/support/unitConversionUtils","../../../../geometry/support/aaBoundingBox","../../webgl-engine/lib/Intersector"],(function(e,t,r,o,a,i,n,s,c,l,d,p,u,y,h,v,f,g,m,b,x){"use strict";const E=i.getLogger("esri.views.3d.layers.support.StageLayerElevationProvider");e.StageLayerElevationProvider=function(e){function r(t){var r;return(r=e.call(this,t)||this).elevationOffset=0,r.layerDirtyNotificationHandle=null,r}t._inheritsLoose(r,e);var o=r.prototype;return o.initialize=function(){this.renderCoordsHelper=this.view.renderCoordsHelper,this.intersectLayers=[this.stageLayer],this.intersector=new x.Intersector(this.view.state.mode),this.intersector.options.store=0;const e=this.computeLayerExtent(this.stageLayer);this.zmin=e[2],this.zmax=e[5],this.layerDirtyNotificationHandle=this.stageLayer.on("dirty",(e=>this.stageLayerChanged(e.origin,e.dirtyType,e.subObject)))},o.dispose=function(){this.layerDirtyNotificationHandle.remove()},o.elevationInfoChanged=function(){const e=null!=this.layer?this.layer.elevationInfo:null;if(null!=e&&"on-the-ground"!==e.mode){const t=f.getMetersPerVerticalUnitForSR(this.layer.spatialReference),r=m.getMetersPerUnit(e.unit);this.elevationOffset=a.unwrapOr(e.offset,0)*r/t}else this.elevationOffset=0},o.getElevation=function(e,t,r,o){if(S[0]=e,S[1]=t,S[2]=r,!this.renderCoordsHelper.toRenderCoords(S,o,S))return E.error("could not project point for elevation alignment"),null;const a=this.elevationOffset,i=this.zmin+a,n=this.zmax+a;v.copy(O,S),v.copy(R,S),this.renderCoordsHelper.setAltitude(n,O),this.renderCoordsHelper.setAltitude(i,R);return this.intersector.reset(O,R),this.intersector.intersect(this.intersectLayers,null,null,1,null,(e=>e.metadata&&e.metadata.isElevationSource)),this.intersector.results.min.getIntersectionPoint(S)?this.renderCoordsHelper.getAltitude(S):null},o.stageLayerChanged=function(e,t,r){switch(t){case"layerObjectAdded":case"layerObjectRemoved":case"objGeometryAdded":{const e=r;e.metadata&&e.metadata.isElevationSource&&this.objectChanged(e)}break;case"objGeometryRemoved":case"vertexAttrsUpdated":case"objTransformation":{const t=e;t.metadata&&t.metadata.isElevationSource&&this.objectChanged(t)}}},o.objectChanged=function(e){if(this.spatialReference){b.empty(B),e.metadata.lastValidElevationBB.isEmpty()||this.expandExtent(e.metadata.lastValidElevationBB.bbMin,e.metadata.lastValidElevationBB.bbMax,B);const t=e.getBBMin(!1),r=e.getBBMax(!1);this.expandExtent(t,r,B),b.toRect(B,L),this.zmin=Math.min(this.zmin,B[2]),this.zmax=Math.max(this.zmax,B[5]),C.extent=L,C.spatialReference=this.spatialReference,this.emit("elevation-change",C),v.copy(e.metadata.lastValidElevationBB.bbMin,t),v.copy(e.metadata.lastValidElevationBB.bbMax,r)}},o.computeLayerExtent=function(e){b.empty(B);for(const t of e.getObjects())this.expandExtent(t.getBBMin(!1),t.getBBMax(!1),B);return B},o.expandExtent=function(e,t,r){for(let o=0;o<8;++o)S[0]=1&o?e[0]:t[0],S[1]=2&o?e[1]:t[1],S[2]=4&o?e[2]:t[2],this.renderCoordsHelper.fromRenderCoords(S,S,this.spatialReference),b.expandWithVec3(r,S);return r},r}(y.EventedMixin(u)),r.__decorate([s.property({constructOnly:!0})],e.StageLayerElevationProvider.prototype,"layer",void 0),r.__decorate([s.property({constructOnly:!0})],e.StageLayerElevationProvider.prototype,"stageLayer",void 0),r.__decorate([s.property({constructOnly:!0})],e.StageLayerElevationProvider.prototype,"view",void 0),r.__decorate([s.property({readOnly:!0,aliasOf:"view.spatialReference"})],e.StageLayerElevationProvider.prototype,"spatialReference",void 0),e.StageLayerElevationProvider=r.__decorate([c.subclass("esri.views.3d.layers.support.StageLayerElevationProvider")],e.StageLayerElevationProvider);const B=b.empty(),L=g.empty(),C={spatialReference:null,extent:L,context:"scene"},S=h.create(),O=h.create(),R=h.create();Object.defineProperty(e,"__esModule",{value:!0})}));
