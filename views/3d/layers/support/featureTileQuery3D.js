/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/accessorSupport/decorators/subclass","../../../../layers/graphics/dehydratedFeatures","../../../../rest/query/operations/query","../../support/PBFDecoder"],(function(e,r,t,o,u,s,a,n,i,y,c,l,p){"use strict";let d=function(e){function t(r){return e.call(this,r)||this}r._inheritsLoose(t,e);var o=t.prototype;return o.queryFeatureCount=function(e,r){return this.layer.queryFeatureCount(e,r)},o.destroy=function(){this._decoder=u.destroyMaybe(this._decoder)},o._createRequestOptions=function(e){return{...e,query:{...this.layer.customParameters,token:this.layer.apiKey,...e?.query}}},r._createClass(t,[{key:"queryFeaturesDehydrated",get:function(){const e=this.layer.capabilities,r=e&&e.query,t=r&&r.supportsFormatPBF,o=this.layer.parsedUrl;if(t){u.isNone(this._decoder)&&(this._decoder=new p.PBFDecoder(this.controller));const e={sourceSpatialReference:this.layer.spatialReference?.toJSON()??null,applyTransform:!0,maxStringAttributeLength:1024};return(r,t)=>l.runQuery(o,r,"pbf",this._createRequestOptions(t)).then((r=>(s.throwIfAborted(t),u.isSome(this._decoder)?this._decoder.invoke({buffer:r.data,options:e},t.signal):Promise.reject(s.createAbortError()))))}return(e,r)=>l.executeQuery(o,e,this.layer.spatialReference,this._createRequestOptions(r)).then((e=>c.fromFeatureSetJSON(e.data)))}}]),t}(o);t.__decorate([a.property({constructOnly:!0})],d.prototype,"layer",void 0),t.__decorate([a.property({constructOnly:!0})],d.prototype,"controller",void 0),t.__decorate([a.property({readOnly:!0})],d.prototype,"queryFeaturesDehydrated",null),d=t.__decorate([y.subclass("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceQuery3D")],d);let h=function(e){function t(r){return e.call(this,r)||this}r._inheritsLoose(t,e);var o=t.prototype;return o.queryFeaturesDehydrated=function(e,r){return this.layer.queryFeatures(e,r)},o.queryFeatureCount=function(e,r){return this.layer.queryFeatureCount(e,r)},t}(o);t.__decorate([a.property({constructOnly:!0})],h.prototype,"layer",void 0),t.__decorate([a.property({readOnly:!0})],h.prototype,"queryFeaturesDehydrated",null),h=t.__decorate([y.subclass("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceMeshQuery3D")],h);let f=function(e){function t(r){return e.call(this,r)||this}return r._inheritsLoose(t,e),t.prototype.queryFeaturesDehydrated=function(e,r){return this.layer.queryFeatures(e,r)},t}(o);t.__decorate([a.property({constructOnly:!0})],f.prototype,"layer",void 0),f=t.__decorate([y.subclass("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceQuery3D")],f);let _=function(e){function t(r){return e.call(this,r)||this}r._inheritsLoose(t,e);var o=t.prototype;return o.queryFeaturesDehydrated=function(e,r){return this.source.queryFeaturesJSON(e,r).then(c.fromFeatureSetJSON,(t=>{if(t&&"query-features-json:unsupported"===t.name)return this.layer.queryFeatures(e,r);throw t}))},o.queryFeatureCount=function(e,r){return this.layer.queryFeatureCount(e,r)},t}(o);function F(e,r){return"feature"===e.type&&"feature-layer"===e.source.type?u.isSome(e.infoFor3D)?new h({layer:e}):new d({layer:e,controller:r}):"feature"===e.type&&"memory"===e.source.type||"csv"===e.type||"geojson"===e.type||"oriented-imagery"===e.type||"wfs"===e.type?new _({layer:e,source:e.source}):"ogc-feature"===e.type?new f({layer:e}):null}t.__decorate([a.property({constructOnly:!0})],_.prototype,"layer",void 0),t.__decorate([a.property({constructOnly:!0})],_.prototype,"source",void 0),_=t.__decorate([y.subclass("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileClientQuery3D")],_),e.createFeatureTileQuery3D=F,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
