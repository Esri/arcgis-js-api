/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../../../core/screenUtils","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/plane","../../../../geometry/support/triangle","./FeatureTileVisibility3D","../../webgl-engine/lib/Camera"],(function(e,t,i,r,s,n,o,a,c){"use strict";let l=function(){function e(e){this.camera=new c,this.focusOnMap=[0,0],this.screenRect=s.create(),this.tileSize=e.tileSize,this.renderCoordsHelper=e.renderCoordsHelper,this.tilingScheme=e.tilingScheme,this.visibility=new a.FeatureTileVisibility3D(e.renderCoordsHelper)}var t=e.prototype;return t.begin=function(e,t,i){this.camera.copyFrom(e),this.surfaceElevation=i,this.focusOnMap[0]=t.x,this.focusOnMap[1]=t.y,s.fromValues(0,0,e.fullWidth,e.fullHeight,this.screenRect),this.visibility.begin(this.camera,i)},t.end=function(){this.visibility.end()},t.updateTile=function(e){e.measures.visibility=this.visibility.calculate(e),e.measures.distance=s.distance(e.extent,this.focusOnMap),0!==e.measures.visibility&&this.updateScreenMeasure(e)},t.updateScreenMeasure=function(e){const t=h,i=1<<t,r=e.measures.screenRect;s.empty(r);let n=0;const o=e.lij[0]+t,a=e.lij[1]<<t,c=e.lij[2]<<t,l=this.tileSizeWithBias(e),u=l*l;for(let s=0;s<i;s++)for(let t=0;t<i;t++)if(n+=this.computeScreenArea(e,o,a+s,c+t,r),n>u)return void(e.measures.shouldSplit=!0);e.measures.shouldSplit=!1},t.tileSizeWithBias=function(e){return 1===e.measures.visibility?this.tileSize*d:this.tileSize},t.computeScreenArea=function(e,t,i,r,n){const a=1===e.measures.visibility;this.projectToScreen(t,i,r,a,p),s.empty(u);for(let o=0;o<4;o++)s.expandPointInPlace(u,p[o]);return s.expand(n,u,n),o.areaPoints2d(p[0],p[1],p[2])+o.areaPoints2d(p[0],p[2],p[3])},t.projectToScreen=function(e,t,i,r,s){this.tilingScheme.ensureMaxLod(e),this.tilingScheme.getExtent(e,t,i,f),this.toRenderCoords(f,0,3,S[0]),this.toRenderCoords(f,2,3,S[1]),this.toRenderCoords(f,2,1,S[2]),this.toRenderCoords(f,0,1,S[3]),r&&(this.projectToPlane(S,this.camera.frustum[4]),this.projectToPlane(S,this.camera.frustum[3]),this.projectToPlane(S,this.camera.frustum[2]));for(let n=0;n<4;n++)this.camera.projectToRenderScreen(S[n],g),this.camera.renderToScreen(g,s[n])},t.projectToPlane=function(e,t){for(let i=0;i<4;i++)y[i]=n.signedDistance(t,e[i]);const r=Math.max(y[0],y[1],y[2],y[3]);if(r>0){const s=i.scale(m,n.normal(t),-r);for(let t=0;t<4;t++)i.add(e[t],e[t],s)}},t.toRenderCoords=function(e,t,i,r){return m[0]=e[t],m[1]=e[i],m[2]=this.surfaceElevation,this.renderCoordsHelper.toRenderCoords(m,this.tilingScheme.spatialReference,r),r},e}();const u=s.create(),h=2,d=5,p=[t.createScreenPointArray(),t.createScreenPointArray(),t.createScreenPointArray(),t.createScreenPointArray()],f=s.create(),m=r.create(),S=[r.create(),r.create(),r.create(),r.create()],y=[0,0,0,0],g=t.createRenderScreenPointArray3();e.FeatureTileMeasurements3D=l,e.default=l,Object.defineProperty(e,"__esModule",{value:!0})}));
