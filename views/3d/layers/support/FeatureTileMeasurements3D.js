/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../core/screenUtils","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/frustum","../../../../geometry/support/plane","../../../../geometry/support/triangle","./FeatureTileDescriptor3D","./FeatureTileVisibility3D","../../webgl-engine/lib/Camera"],(function(e,t,i,r,s,n,o,a,c,l,u){"use strict";let h=function(){function e(e){this._camera=new u.Camera,this._focusOnMap=[0,0],this._screenRect=s.create(),this._tileSize=e.tileSize,this._renderCoordsHelper=e.renderCoordsHelper,this._tilingScheme=e.tilingScheme,this._visibility=new l.FeatureTileVisibility3D(e.renderCoordsHelper)}var t=e.prototype;return t.begin=function(e,t,i){this._camera.copyFrom(e),this._surfaceElevation=i,this._focusOnMap[0]=t.x,this._focusOnMap[1]=t.y,s.fromValues(0,0,e.fullWidth,e.fullHeight,this._screenRect),this._visibility.begin(this._camera,i)},t.end=function(){this._visibility.end()},t.updateTile=function(e){e.measures.visibility=this._visibility.calculate(e),e.measures.distance=s.distance(e.extent,this._focusOnMap),e.measures.visibility!==c.Visibility.INVISIBLE&&this._updateScreenMeasure(e)},t._updateScreenMeasure=function(e){const t=d,i=1<<t,r=e.measures.screenRect;s.empty(r);let n=0;const o=e.lij[0]+t,a=e.lij[1]<<t,c=e.lij[2]<<t,l=this._tileSizeWithBias(e),u=l*l;for(let s=0;s<i;s++)for(let t=0;t<i;t++)if(n+=this._computeScreenArea(e,o,a+s,c+t,r),n>u)return void(e.measures.shouldSplit=!0);e.measures.shouldSplit=!1},t._tileSizeWithBias=function(e){return e.measures.visibility===c.Visibility.VISIBLE_WHEN_EXTENDED?this._tileSize*p:this._tileSize},t._computeScreenArea=function(e,t,i,r,n){const o=e.measures.visibility===c.Visibility.VISIBLE_WHEN_EXTENDED;this._projectToScreen(t,i,r,o,m),s.empty(_);for(let a=0;a<4;a++)s.expandPointInPlace(_,m[a]);return s.expand(n,_,n),a.areaPoints2d(m[0],m[1],m[2])+a.areaPoints2d(m[0],m[2],m[3])},t._projectToScreen=function(e,t,i,r,s){this._tilingScheme.ensureMaxLod(e),this._tilingScheme.getExtent(e,t,i,f),this._toRenderCoords(f,0,3,y[0]),this._toRenderCoords(f,2,3,y[1]),this._toRenderCoords(f,2,1,y[2]),this._toRenderCoords(f,0,1,y[3]),r&&(this._projectToPlane(y,this._camera.frustum[n.PlaneIndex.NEAR]),this._projectToPlane(y,this._camera.frustum[n.PlaneIndex.TOP]),this._projectToPlane(y,this._camera.frustum[n.PlaneIndex.BOTTOM]));for(let n=0;n<4;n++)this._camera.projectToRenderScreen(y[n],b),this._camera.renderToScreen(b,s[n])},t._projectToPlane=function(e,t){for(let i=0;i<4;i++)g[i]=o.signedDistance(t,e[i]);const r=Math.max(g[0],g[1],g[2],g[3]);if(r>0){const s=i.scale(S,o.normal(t),-r);for(let t=0;t<4;t++)i.add(e[t],e[t],s)}},t._toRenderCoords=function(e,t,i,r){return S[0]=e[t],S[1]=e[i],S[2]=this._surfaceElevation,this._renderCoordsHelper.toRenderCoords(S,this._tilingScheme.spatialReference,r),r},e}();const _=s.create(),d=2,p=5,m=[t.createScreenPointArray(),t.createScreenPointArray(),t.createScreenPointArray(),t.createScreenPointArray()],f=s.create(),S=r.create(),y=[r.create(),r.create(),r.create(),r.create()],g=[0,0,0,0],b=t.createRenderScreenPointArray3();e.FeatureTileMeasurements3D=h,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
