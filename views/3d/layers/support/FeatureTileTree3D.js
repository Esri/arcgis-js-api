/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Collection","../../../../core/Handles","../../../../core/Logger","../../../../core/maybe","../../../../core/PooledArray","../../../../core/watchUtils","../../../../core/accessorSupport/decorators/property","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","../../../../geometry/support/aaBoundingRect","./FeatureTileDescriptor3D","./FeatureTileMeasurements3D","../../support/extentUtils","../../../support/Scheduler"],(function(e,t,i,r,s,n,o,l,a,c,u,h,d,p,_,T,y,f,g,m){"use strict";const S=o.getLogger("esri.views.3d.layers.support.FeatureTileTree3D");e.FeatureTileTree3D=function(e){function i(t){var i;return(i=e.call(this,t)||this).tiles=new s,i.tileSize=512,i._idToTile=new Map,i._handles=new n,i._clients=new Set,i._dirty=!1,i._newTiles=new a,i}t._inheritsLoose(i,e);var r=i.prototype;return r.initialize=function(){this._handles.add(this.watch(["tilingScheme","tileSize"],(()=>this._reset()),!0)),this._handles.add(c.init(this,["tileSize","cameraOnSurface.location","tilingScheme","viewState.contentCamera","focus.location"],(()=>this._setDirty()),!0)),this.scheduler&&(this._frameWorker=this.scheduler.registerTask(m.TaskPriority.FEATURE_TILE_TREE,this))},r.destroy=function(){this._frameWorker=l.removeMaybe(this._frameWorker),this._handles=l.destroyMaybe(this._handles)},r.addClient=function(){const e=D();return this._clients.add(e),1===this._clients.size&&this._setDirty(),{remove:()=>this._removeClient(e)}},r._removeClient=function(e){this._clients.delete(e),this._hasClients||this._clear()},r._setDirty=function(){!this._hasClients||this.suspended||this._dirty||(this._frameWorker?(this._dirty=!0,this.notifyChange("updating")):this.runTask(m.noBudget))},r._clear=function(){this.tiles.removeAll(),this._idToTile.clear(),this._reset(),this._dirty=!1,this.notifyChange("updating")},r.runTask=function(e){this._dirty=!1,this._pendingTiles||(this._startUpdate(),l.isSome(this._frameWorker)&&(this._frameWorker.priority=m.TaskPriority.FEATURE_TILE_TREE_ACTIVE)),this._subdivideTilesForView(e),!this._pendingTiles&&l.isSome(this._frameWorker)&&(this._frameWorker.priority=m.TaskPriority.FEATURE_TILE_TREE),this.notifyChange("updating")},r._startUpdate=function(){if(this.suspended)return;if(!this.tilingScheme)return void this._clear();this._tileMeasurements||(this._tileMeasurements=new f.FeatureTileMeasurements3D({renderCoordsHelper:this.renderCoordsHelper,tilingScheme:this.tilingScheme,tileSize:this.tileSize}));const e=this.viewState.contentCamera;this._tileMeasurements.begin(e,this.focus.location,this.cameraOnSurface.location.z),this._pendingTiles=this._getRootTiles()},r._reset=function(){this._newTiles.clear(),this._tileMeasurements=null,this._pendingTiles=null,this._setDirty()},r._getRootTiles=function(){return this.rootTileIds.map((e=>new y.FeatureTileDescriptor3D(e[0],e[1],e[2],this.tilingScheme)))},r._purgeHorizonTiles=function(e){e.sort(((e,t)=>{const i=e.measures.screenRect,r=t.measures.screenRect;return i[1]+i[3]-(r[1]+r[3])})),T.empty(E);for(let t=0;t<e.length;t++)if(T.expand(E,e.data[t].measures.screenRect,E),T.height(E)>F)return e.data.slice(t,e.length);return[]},r._subdivideTilesForView=function(e){if(this._pendingTiles){for(;this._pendingTiles.length>0&&!e.done;){const t=this._pendingTiles.pop();e.madeProgress(),this.filterExtentRect&&!T.intersects(this.filterExtentRect,t.extent)||(this._tileMeasurements.updateTile(t),t.measures.visibility!==y.Visibility.INVISIBLE&&(t.measures.shouldSplit?(this.tilingScheme.ensureMaxLod(t.lij[0]+1),this._pendingTiles.push(...t.getChildren())):this._newTiles.push(t)))}0===this._pendingTiles.length&&(this._updateTiles(this._purgeHorizonTiles(this._newTiles)),this._newTiles.clear(),this._tileMeasurements.end(),this._pendingTiles=null)}},r._updateTiles=function(e){for(const r of this.tiles.items)r.used=!1;const t=e.filter((e=>{const t=this._idToTile.get(e.id);return t?(t.copyMeasurementsFrom(e),t.used=!0):this._idToTile.set(e.id,e),!t})),i=this.tiles.items.filter((e=>!e.used&&(this._idToTile.delete(e.id),!0)));this.tiles.removeMany(i),this.tiles.addMany(t),this._sortTiles()},r._sortTiles=function(){this.viewState.fixedContentCamera||this.tiles.sort(((e,t)=>e.measures.visibility!==t.measures.visibility?e.measures.visibility===y.Visibility.VISIBLE_ON_SURFACE?-1:1:e.measures.distance-t.measures.distance)),this.tiles.forEach(((e,t)=>e.loadPriority=t))},t._createClass(i,[{key:"tilingScheme",get:function(){const e=this.tilingSchemeOwner.tilingScheme;if(!e)return null;return e.clone()}},{key:"filterExtent",set:function(e){if(l.isSome(e)&&!e.spatialReference.equals(this.viewState.spatialReference))return void S.error("#extent","extent spatial reference needs to be in the same spatial reference as the view");const t=this._get("filterExtent");if(t===e||l.isSome(t)&&e&&t.equals(e))return;const i=l.isSome(e)?e.clone():null;this._set("filterExtent",i),this._setDirty()}},{key:"filterExtentRect",get:function(){if(l.isNone(this.filterExtent)||!this.tilingScheme)return null;const e=T.create();return g.toBoundingRect(this.filterExtent,e,this.tilingScheme.spatialReference),e}},{key:"rootTileIds",get:function(){return this.filterExtentRect?this.tilingScheme.rootTilesInExtent(this.filterExtentRect):[[0,0,0]]}},{key:"suspended",set:function(e){e!==this._get("suspended")&&(this._set("suspended",e),this._setDirty())}},{key:"updating",get:function(){return this._dirty||!!this._pendingTiles}},{key:"_hasClients",get:function(){return this._clients.size>0}},{key:"running",get:function(){return this.updating}}]),i}(r),i.__decorate([u.property({constructOnly:!0})],e.FeatureTileTree3D.prototype,"scheduler",void 0),i.__decorate([u.property({constructOnly:!0})],e.FeatureTileTree3D.prototype,"renderCoordsHelper",void 0),i.__decorate([u.property({constructOnly:!0})],e.FeatureTileTree3D.prototype,"tilingSchemeOwner",void 0),i.__decorate([u.property({constructOnly:!0})],e.FeatureTileTree3D.prototype,"cameraOnSurface",void 0),i.__decorate([u.property({constructOnly:!0})],e.FeatureTileTree3D.prototype,"focus",void 0),i.__decorate([u.property({constructOnly:!0})],e.FeatureTileTree3D.prototype,"viewState",void 0),i.__decorate([u.property({constructOnly:!0})],e.FeatureTileTree3D.prototype,"terrain",void 0),i.__decorate([u.property()],e.FeatureTileTree3D.prototype,"tiles",void 0),i.__decorate([u.property()],e.FeatureTileTree3D.prototype,"tileSize",void 0),i.__decorate([u.property({readOnly:!0})],e.FeatureTileTree3D.prototype,"tilingScheme",null),i.__decorate([u.property()],e.FeatureTileTree3D.prototype,"filterExtent",null),i.__decorate([u.property({readOnly:!0})],e.FeatureTileTree3D.prototype,"filterExtentRect",null),i.__decorate([u.property({readOnly:!0})],e.FeatureTileTree3D.prototype,"rootTileIds",null),i.__decorate([u.property({value:!1})],e.FeatureTileTree3D.prototype,"suspended",null),i.__decorate([u.property({readOnly:!0})],e.FeatureTileTree3D.prototype,"updating",null),e.FeatureTileTree3D=i.__decorate([_.subclass("esri.views.3d.layers.support.FeatureTileTree3D")],e.FeatureTileTree3D);let v=0;function D(){return v++}const E=T.create(),F=10,w=e.FeatureTileTree3D;e.default=w,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
