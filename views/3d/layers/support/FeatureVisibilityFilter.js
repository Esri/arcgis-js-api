/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/asyncUtils","../../../../core/HandleOwner","../../../../core/Logger","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/accessorSupport/decorators/subclass","../../../../layers/support/FeatureFilter","../../../../layers/support/floorFilterUtils","../graphics/QueryEngine","../../../support/Scheduler"],(function(e,t,i,r,s,a,l,o,n,u,c,p,y,_,d,h,F){"use strict";e.FeatureVisibilityFilter=function(e){function i(i){var r;return(r=e.call(this,i)||this)._updateTask=null,r._frameTask=null,r._queryEngine=null,r._updateRequested=!0,r._updateVisibility=function(){var e=t._asyncToGenerator((function*(e){if(l.isNone(r._compositedFeatureFilter)&&l.isNone(r._sceneFilter)||0===r.context.getFeatureCount())return r._frameTask.schedule((()=>r.clear()),e);try{const t=yield r._queryEngine.executeQueryForIdSet(r._compositedFeatureFilter,r._sceneFilter,e);return r._frameTask.schedule((()=>{r.context.updateFeatureVisibilities((e=>t.has(e)))}),e)}catch(t){return o.throwIfAbortError(t),a.getLogger(r.declaredClass).warn(`FeatureFilter query failed: ${t}`,{error:t}),r._frameTask.schedule((()=>{r.context.setAllFeaturesVisibility(!0)}),e)}}));return function(t){return e.apply(this,arguments)}}(),r}t._inheritsLoose(i,e);var s=i.prototype;return s.initialize=function(){const e=F.TaskPriority.FILTER_VISIBILITY,{layer:t,view:i}=this._layerView,{featureStore:r}=this.context,s="hasZ"in this._layerView&&this._layerView.hasZ,a="hasM"in this._layerView&&this._layerView.hasM;this._queryEngine=new h.QueryEngine({context:{spatialReference:i.spatialReference,layer:t,scheduler:i.resourceController.scheduler,featureStore:r,hasM:a,hasZ:s},priority:e}),this._frameTask=this._layerView.view.resourceController.scheduler.registerTask(e,this),this.updatingHandles.add((()=>[this._compositedFeatureFilter,this._sceneFilter]),(()=>this.reapply()),n.initial)},s.destroy=function(){this._updateRequested=!1,this.handles.removeAll(),this.updatingHandles.removeAll(),this.clear(),this._updateTask=l.abortMaybe(this._updateTask),this._frameTask=l.removeMaybe(this._frameTask),this._queryEngine=l.destroyMaybe(this._queryEngine),this._set("context",null)},s.reapply=function(){this._updateRequested=!0},s.clear=function(){this._queryEngine.clear(),this.context.clearFeaturesVisibility()},s.runTask=function(e){this._updateRequested&&(this._updateTask=l.abortMaybe(this._updateTask),this._updateTask=r.createTask(this._updateVisibility),this._updateRequested=!1,e.madeProgress()),this._frameTask.processQueue(e)},t._createClass(i,[{key:"updating",get:function(){return this.running||this.updatingHandles.updating||l.isSome(this._updateTask)&&!this._updateTask.finished}},{key:"running",get:function(){return this._updateRequested||this._frameTask.updating}},{key:"defaultVisibility",get:function(){return l.isNone(this._compositedFeatureFilter)&&l.isNone(this._sceneFilter)}},{key:"_featureFilter",get:function(){return"filter"in this._layerView?this._layerView.filter:null}},{key:"_sceneFilter",get:function(){return"layerFilter"in this._layerView?this._layerView.layerFilter:null}},{key:"_floorFilter",get:function(){return d.getFloorFilterClause(this._layerView)}},{key:"_timeExtent",get:function(){return"timeExtent"in this._layerView?this._layerView.timeExtent:null}},{key:"_compositedFeatureFilter",get:function(){const{_featureFilter:e,_timeExtent:t,_floorFilter:i}=this;if(l.isNone(t)&&l.isNone(i))return e;const r=l.isSome(e)?e.clone():new _;if(l.isSome(t)&&(r.timeExtent=l.isSome(r.timeExtent)?r.timeExtent.intersection(t):t),l.isSome(i)){const e=l.isNone(r.where)||""===r.where;r.where=e?i:`(${r.where}) AND (${i})`}return r}},{key:"_layerView",get:function(){return this.context.layerView}}]),i}(s.HandleOwner),i.__decorate([u.property({constructOnly:!0})],e.FeatureVisibilityFilter.prototype,"context",void 0),i.__decorate([u.property()],e.FeatureVisibilityFilter.prototype,"updating",null),i.__decorate([u.property()],e.FeatureVisibilityFilter.prototype,"running",null),i.__decorate([u.property()],e.FeatureVisibilityFilter.prototype,"defaultVisibility",null),i.__decorate([u.property()],e.FeatureVisibilityFilter.prototype,"_featureFilter",null),i.__decorate([u.property()],e.FeatureVisibilityFilter.prototype,"_sceneFilter",null),i.__decorate([u.property()],e.FeatureVisibilityFilter.prototype,"_floorFilter",null),i.__decorate([u.property()],e.FeatureVisibilityFilter.prototype,"_timeExtent",null),i.__decorate([u.property()],e.FeatureVisibilityFilter.prototype,"_compositedFeatureFilter",null),i.__decorate([u.property()],e.FeatureVisibilityFilter.prototype,"_layerView",null),i.__decorate([u.property()],e.FeatureVisibilityFilter.prototype,"_updateTask",void 0),i.__decorate([u.property()],e.FeatureVisibilityFilter.prototype,"_updateRequested",void 0),e.FeatureVisibilityFilter=i.__decorate([y.subclass("esri.views.3d.layers.support.FeatureVisibilityFilter")],e.FeatureVisibilityFilter),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
