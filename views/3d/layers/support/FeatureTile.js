/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/arrayUtils","../../../../core/maybe","../../../../geometry/support/aaBoundingRect","../../../../layers/graphics/dehydratedFeatures"],(function(t,e,i,s,u,r){"use strict";const a=16438,n=new Set;let h=function(){function h(e){this.descriptor=e,this.fetchStatus=t.FetchStatus.FETCH_NEEDED,this._features=null,this._numVertices=0,this._featureLimit=0,this.featuresMissing=!0,this._shuffled=!1,this._numFeatures=f,this._emptyFeatureRatio=0,this._estimatedSize=-1,this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._availableFields=n,this._displayingFeatures=null,this.alive=!0,this.filtered=!1}var c=h.prototype;return c.setFeatures=function(t,e,i){this._availableFields=s.unwrapOr(i,n),this._features=t,this._shuffled=!1,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0,t&&t.length>0?(this._emptyFeatureRatio=e/(t.length+e),this._numVertices=t.reduce(((t,e)=>t+r.numVertices(e.geometry)),0)):(this._emptyFeatureRatio=0,this._numVertices=0)},c.updateMemoryEstimates=function(){if(this._estimatedSize<0){if(this._estimatedSize=0,this._estimatedUnusedSize=0,this._features)for(let t=0;t<this._features.length;++t){const e=r.estimateSize(this._features[t]);this._estimatedSize+=e,t>=this.featureLimit&&(this._estimatedUnusedSize+=e)}return!0}if(this._estimatedUnusedSizeDirty){if(this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._features)for(let t=this.featureLimit;t<this._features.length;++t)this._estimatedUnusedSize+=r.estimateSize(this._features[t]);return!0}return!1},c.resetFetching=function(){this.fetchStatus=this.fetchStatus===t.FetchStatus.REFETCHING?t.FetchStatus.REFETCH_NEEDED:t.FetchStatus.FETCH_NEEDED},c.intersects=function(t){return!t||!this.descriptor.extent||(u.fromExtent(t,F),u.intersects(this.descriptor.extent,F))},c.intersectionIncludingBorrowed=function(t,e){const i=s.isSome(this.extentIncludingBorrowedFeatures)?this.extentIncludingBorrowedFeatures:this.descriptor.extent;return t||i?(t?(u.fromExtent(t,e),u.intersection(e,i,e)):u.copy(e,i),e):(u.copy(e,u.POSITIVE_INFINITY),e)},c._shuffle=function(t){this._features.sort(((e,i)=>r.getObjectId(e,t)-r.getObjectId(i,t))),i.shuffle(this._features,a),this._shuffled=!0,this._estimatedUnusedSizeDirty=!0},c.reduceFeatures=function(e,i,s){if(e<=0)return!1;if(!this._features)return this.featureLimit=0,!1;let u=!1;this.featureLimit=Math.ceil(this.numFeatures*e),this.featureLimit>this._features.length&&(this.featureLimit=this._features.length,this.fetchStatus===t.FetchStatus.DONE&&this._features.length>0&&(this.fetchStatus=t.FetchStatus.REFETCH_NEEDED,u=!0)),!this._shuffled&&e<1&&this._shuffle(s);const r=Math.max(this.featureLimit,Math.ceil(i*this.numFeatures));return this._features.length>r&&(this._features.length=r,this.featuresMissing=!0,this.fetchStatus===t.FetchStatus.FULL&&(this.fetchStatus=t.FetchStatus.DONE)),u},e._createClass(h,[{key:"displayingFeatures",get:function(){return this._displayingFeatures},set:function(t){this._displayingFeatures=t,this.extentIncludingBorrowedFeatures=null}},{key:"perTileMaximumNumberOfFeaturesExceeded",get:function(){return!this.filtered&&(this.featuresMissing||this.features&&this.featureLimit!==this.features.length)}},{key:"features",get:function(){return this._features}},{key:"featureLimit",get:function(){return this._featureLimit},set:function(t){this._featureLimit!==t&&(this._featureLimit=t,this._estimatedUnusedSizeDirty=!0)}},{key:"availableFields",get:function(){return this._availableFields}},{key:"emptyFeatureRatio",get:function(){return this._emptyFeatureRatio}},{key:"numFeatures",get:function(){return this.hasPreciseFeatureCount?this._numFeatures:this._features?this._features.length:0},set:function(t){this._numFeatures=t}},{key:"hasPreciseFeatureCount",get:function(){return this._numFeatures>f}},{key:"needsFeatureCount",get:function(){return this._numFeatures===f}},{key:"numVertices",get:function(){return this._numVertices}},{key:"id",get:function(){return this.descriptor.id}},{key:"estimatedSize",get:function(){return this.updateMemoryEstimates(),this._estimatedSize}},{key:"estimatedUnusedSize",get:function(){return this._estimatedUnusedSize}},{key:"isFetching",get:function(){return this.fetchStatus===t.FetchStatus.FETCHING||this.fetchStatus===t.FetchStatus.REFETCHING}},{key:"isRefetching",get:function(){return this.fetchStatus===t.FetchStatus.REFETCHING}},{key:"needsFetching",get:function(){return this.fetchStatus===t.FetchStatus.FETCH_NEEDED||this.fetchStatus===t.FetchStatus.REFETCH_NEEDED}},{key:"needsRefetching",get:function(){return this.fetchStatus===t.FetchStatus.REFETCH_NEEDED}},{key:"isFetched",get:function(){return this.fetchStatus===t.FetchStatus.DONE||this.fetchStatus===t.FetchStatus.FULL}},{key:"needsDisplayUpdate",get:function(){return!!this._features&&!_(this._features,this.displayingFeatures,this.featureLimit)}},{key:"cache",get:function(){return{availableFields:this._availableFields,features:this.features,numFeatures:this._numFeatures,emptyFeatureRatio:this._emptyFeatureRatio,fetchStatus:this.fetchStatus,featuresMissing:this.featuresMissing}},set:function(t){this.requestController=null,this._availableFields=t.availableFields,this._features=t.features,this._numFeatures=t.numFeatures,this._emptyFeatureRatio=t.emptyFeatureRatio,this.fetchStatus=t.fetchStatus,this.featuresMissing=t.featuresMissing,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0}}]),h}();const f=-1,c=-2;var o;function _(t,e,i){if(s.isNone(e)||s.isNone(t)||i!==e.length||i>t.length)return!1;for(let s=0;s<i;++s)if(t[s]!==e[s])return!1;return!0}t.FetchStatus=void 0,(o=t.FetchStatus||(t.FetchStatus={}))[o.FETCH_NEEDED=0]="FETCH_NEEDED",o[o.REFETCH_NEEDED=1]="REFETCH_NEEDED",o[o.FETCHING=2]="FETCHING",o[o.REFETCHING=3]="REFETCHING",o[o.DONE=4]="DONE",o[o.FULL=5]="FULL";const F=u.create();t.FAILED_FEATURE_COUNT=c,t.FeatureTile=h,Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
