// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","../../../../core/arrayUtils","../../../../core/maybe","../../../../geometry/support/aaBoundingRect","../../../../layers/graphics/dehydratedFeatures"],(function(e,t,i,r,s,u){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FAILED_FEATURE_COUNT=t.FeatureTile=void 0;var n=new Set,a=function(){function e(e){this.descriptor=e,this.fetchStatus=0,this._features=null,this._numVertices=0,this._featureLimit=0,this.featuresMissing=!0,this._shuffled=!1,this._numFeatures=h,this._emptyFeatureRatio=0,this._estimatedSize=-1,this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._availableFields=n,this.displayingFeatures=null,this.alive=!0,this.filtered=!1}return Object.defineProperty(e.prototype,"perTileMaximumNumberOfFeaturesExceeded",{get:function(){return!this.filtered&&(this.featuresMissing||this.features&&this.featureLimit!==this.features.length)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"features",{get:function(){return this._features},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"featureLimit",{get:function(){return this._featureLimit},set:function(e){this._featureLimit!==e&&(this._featureLimit=e,this._estimatedUnusedSizeDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"availableFields",{get:function(){return this._availableFields},enumerable:!1,configurable:!0}),e.prototype.setFeatures=function(e,t,i){this._availableFields=r.unwrapOr(i,n),this._features=e,this._shuffled=!1,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0,e&&e.length>0?(this._emptyFeatureRatio=t/(e.length+t),this._numVertices=e.reduce((function(e,t){return e+u.numVertices(t.geometry)}),0)):(this._emptyFeatureRatio=0,this._numVertices=0)},Object.defineProperty(e.prototype,"emptyFeatureRatio",{get:function(){return this._emptyFeatureRatio},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"numFeatures",{get:function(){return this.hasPreciseFeatureCount?this._numFeatures:this._features?this._features.length:0},set:function(e){this._numFeatures=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"hasPreciseFeatureCount",{get:function(){return this._numFeatures>h},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"needsFeatureCount",{get:function(){return this._numFeatures===h},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"numVertices",{get:function(){return this._numVertices},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"id",{get:function(){return this.descriptor.id},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"estimatedSize",{get:function(){return this.updateMemoryEstimates(),this._estimatedSize},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"estimatedUnusedSize",{get:function(){return this._estimatedUnusedSize},enumerable:!1,configurable:!0}),e.prototype.updateMemoryEstimates=function(){if(this._estimatedSize<0){if(this._estimatedSize=0,this._estimatedUnusedSize=0,this._features)for(var e=0;e<this._features.length;++e){var t=u.estimateSize(this._features[e]);this._estimatedSize+=t,e>=this.featureLimit&&(this._estimatedUnusedSize+=t)}return!0}if(this._estimatedUnusedSizeDirty){if(this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._features)for(e=this.featureLimit;e<this._features.length;++e)this._estimatedUnusedSize+=u.estimateSize(this._features[e]);return!0}return!1},Object.defineProperty(e.prototype,"isFetching",{get:function(){return 2===this.fetchStatus||3===this.fetchStatus},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isRefetching",{get:function(){return 3===this.fetchStatus},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"needsFetching",{get:function(){return 0===this.fetchStatus||1===this.fetchStatus},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"needsRefetching",{get:function(){return 1===this.fetchStatus},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isFetched",{get:function(){return 4===this.fetchStatus||5===this.fetchStatus},enumerable:!1,configurable:!0}),e.prototype.resetFetching=function(){this.fetchStatus=3===this.fetchStatus?1:0},Object.defineProperty(e.prototype,"needsDisplayUpdate",{get:function(){return!!this._features&&!function(e,t,i){if(!t||!e||i!==t.length||i>e.length)return!1;for(var r=0;r<i;++r)if(e[r]!==t[r])return!1;return!0}(this._features,this.displayingFeatures,this.featureLimit)},enumerable:!1,configurable:!0}),e.prototype.intersects=function(e){return!e||!this.descriptor.extent||(s.fromExtent(e,f),s.intersects(this.descriptor.extent,f))},e.prototype.intersection=function(e,t){return e||this.descriptor.extent?(e?(s.fromExtent(e,t),this.descriptor.extent&&s.intersection(t,this.descriptor.extent,t)):s.set(t,this.descriptor.extent),t):(s.set(t,s.POSITIVE_INFINITY),t)},e.prototype._shuffle=function(e){this._features.sort((function(t,i){return u.getObjectId(t,e)-u.getObjectId(i,e)})),i.shuffle(this._features,16438),this._shuffled=!0,this._estimatedUnusedSizeDirty=!0},e.prototype.reduceFeatures=function(e,t,i){if(e<=0)return!1;var r=!1;if(this._features){this.featureLimit=Math.ceil(this.numFeatures*e),this.featureLimit>this._features.length&&(this.featureLimit=this._features.length,4===this.fetchStatus&&this._features.length>0&&(this.fetchStatus=1,r=!0)),!this._shuffled&&e<1&&this._shuffle(i);var s=Math.max(this.featureLimit,Math.ceil(t*this.numFeatures));this._features.length>s&&(this._features.length=s,this.featuresMissing=!0,5===this.fetchStatus&&(this.fetchStatus=4))}else this.featureLimit=0;return r},Object.defineProperty(e.prototype,"cache",{get:function(){return{availableFields:this._availableFields,features:this.features,numFeatures:this._numFeatures,emptyFeatureRatio:this._emptyFeatureRatio,fetchStatus:this.fetchStatus,featuresMissing:this.featuresMissing}},set:function(e){this.requestController=null,this._availableFields=e.availableFields,this._features=e.features,this._numFeatures=e.numFeatures,this._emptyFeatureRatio=e.emptyFeatureRatio,this.fetchStatus=e.fetchStatus,this.featuresMissing=e.featuresMissing,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0},enumerable:!1,configurable:!0}),e}();t.FeatureTile=a;var h=-1;t.FAILED_FEATURE_COUNT=-2;var f=s.create()}));