/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../geometry","../../../../../core/Accessor","../../../../../core/Evented","../../../../../core/Handles","../../../../../core/handleUtils","../../../../../core/maybe","../../../../../core/promiseUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/accessorSupport/ensureType","../../../../../core/Logger","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/accessorSupport/trackingUtils","../../../../../chunks/vec3","../../../../../chunks/vec3f64","../../../../../geometry/projection","../../../../../geometry/support/aaBoundingRect","../../../../../geometry/support/ray","./LineOfSightAnalysis","./LineOfSightRayIntersector","./LineOfSightResult","../../../support/ElevationProvider","../../../webgl-engine/lib/intersectorUtilsConversions","../../../../support/Scheduler","../../../../../geometry/Point"],(function(e,t,n,i,r,o,s,a,c,l,u,h,d,p,y,g,_,v,f,m,b,A,C,S,O,T,L,I){"use strict";function E(e,t,n){return!c.isNone(n)&&(f.projectBoundingRect(e,t,R,n.spatialReference),m.containsPointObject(R,n))}e.LineOfSightController=function(e){function n(t){var n;return(n=e.call(this,t)||this)._tasks=L.ImmediateTask,n._handles=new s,n._analysisHandles=new s,n}t._inheritsLoose(n,e);var i=n.prototype;return i.initialize=function(){var e;const t=null==(e=this.view.resourceController)?void 0:e.scheduler;t&&(this._tasks=t.registerTask(L.TaskPriority.LINE_OF_SIGHT_TOOL));this._handles.add([this._connectObserver(),this._connectAnalyses(),this._connectTargets()]),this._intersector=new C.LineOfSightRayIntersector({view:this.view})},i.destroy=function(){this._handles.destroy(),this._analysisHandles.destroy(),this._analyses.removeAll()},i.getLineOfSightComputationDependencies=function(e){const{inputPoints:t}=e;return{inputPoints:t}},i.computeAnalysis=function(e){const{analysis:t}=e,{inputPoints:n,computationResult:i}=t,{observerAdjusted:r,targetAdjusted:o}=n,{start:s,end:a}=i;_.copy(s,r),_.copy(a,o);this._canComputeAnalysis(t)?this._computeAnalysisIntersection(e):this._interpolateAnalysisIntersection(e),t.updateComputationResults(),this.emit("result-changed",{target:e.analysis.target,result:t.result})},i._adjustStartEndPositions=function(e){const t=this._screenPixelSize,n=this.view,{inputPoints:i}=e,{observer:r,observerSurfaceNormal:o,target:s,targetSurfaceNormal:a,observerAdjusted:l,targetAdjusted:u}=i,h=w;c.isSome(o)?_.copy(h,o):_.subtract(h,s,r);const d=t;_.normalize(h,h),_.scale(h,h,Math.min(d,1)),_.add(l,r,h),c.isSome(a)?_.copy(h,a):_.subtract(h,r,s);const p=n.state.camera.computeScreenPixelSizeAt(s);_.normalize(h,h),_.scale(h,h,Math.min(p,1)),_.add(u,s,h)},i._computeAnalysisIntersection=function({analysis:e,interpolationInfo:t}){const{view:n}=this,{sceneIntersectionHelper:i,renderCoordsHelper:r}=n;if(c.isNone(i))return;const o=this._intersector.intersector,{computationResult:s,inputPoints:a}=e,{observer:l,target:u}=a,{start:h,end:d}=s,p=b.fromPoints(h,d,k);i.intersectToolIntersectorRay(p,o);const y=s.intersection,g=w,v=!!o.results.min&&o.results.min.getIntersectionPoint(y);let f=!0;if(v){_.copy(t.originalIntersection,y),_.copy(t.originalObserver,h),_.copy(t.originalTarget,d),r.fromRenderCoords(y,g,n.spatialReference);const e=1-_.dist(d,u)/_.dist(h,u);f=_.dist(l,y)>=e*_.dist(l,u)}const m=new I(g,n.spatialReference);{const{result:t,target:i}=e;c.isSome(t)?(t.target=i,t.intersectedGraphic=f?null:T.toGraphic(o.results.min,n),t.intersectedLocation=f?null:m,t.visible=!!v&&f):e.result=new S.LineOfSightResult({target:i,elevationAlignedTargetLocation:e.elevationAlignedTargetLocation,intersectedGraphic:f?null:T.toGraphic(o.results.min,n),intersectedLocation:f?null:m,visible:!!v&&f})}s.isValid=a.isValid=!0,s.isTargetVisible=f},i._interpolateAnalysisIntersection=function({analysis:e,interpolationInfo:t}){const{computationResult:n,inputPoints:i}=e,{start:r,end:o,intersection:s}=n,{originalIntersection:a,originalObserver:c,originalTarget:l}=t;if(_.copy(s,a),i.isValid){const e=w,t=_.dist(c,a)/_.dist(c,l);_.sub(e,r,c),_.scale(e,e,1-t),_.add(s,s,e),_.sub(e,o,l),_.scale(e,e,t),_.add(s,s,e),n.isValid=!0}else e.result=new S.LineOfSightResult,n.isValid=!1,n.isTargetVisible=!1},i._canComputeAnalysis=function(e){const t=this.layerViewData.elevationAlignedObserver,n=this.view.frustum;if(c.isNone(t)||c.isNone(e.target)||c.isNone(n))return!1;const{observerAdjusted:i,targetAdjusted:r}=e.inputPoints,o=n.intersectsPoint(i),s=n.intersectsPoint(r);return o&&s},i._onObserverChange=function(e){if(c.isNone(e))return this.layer.targets.removeAll(),void(this.layerViewData.elevationAlignedObserver=null);this.layerViewData.elevationAlignedObserver=this._applyElevationAlignment(e,this.layer.intersection);const t=v.create();this.view.renderCoordsHelper.toRenderCoords(this.layerViewData.elevationAlignedObserver,t),this._observerEngineLocation=t,this.priority=L.TaskPriority.LINE_OF_SIGHT_TOOL_INTERACTIVE},i._applyElevationAlignment=function(e,t){if(e.hasZ&&(c.isNone(t)||"Graphic"===t.type))return e;const n=e.clone();return n.z=c.unwrapOr(O.getElevationAtPoint(this.view.elevationProvider,n),0),n},i._onObserverChangeForAnalysis=function(e){e.inputPoints.isValid=!1},i._onObserverEngineForAnalysis=function(e,t,n){const{inputPoints:i}=e;if(_.copy(i.observer,t),c.isSome(n)){const e=this._intersector.updateFromIntersectionResult(n);c.isSome(e)&&this.view.renderCoordsHelper.toRenderCoords(e,i.observer),i.observerSurfaceNormal=v.clone(n.normal)}else i.observerSurfaceNormal=null;this._adjustStartEndPositions(e),e.updateInputPoints(),this.priority=L.TaskPriority.LINE_OF_SIGHT_TOOL_INTERACTIVE},i._onTargetLocationChange=function(e,t,n){const{inputPoints:i}=e;if(i.isValid=!1,c.isSome(t)){if(e.elevationAlignedTargetLocation=this._applyElevationAlignment(t,n),this.view.renderCoordsHelper.toRenderCoords(e.elevationAlignedTargetLocation,i.target),c.isSome(n)){const e=this._intersector.updateFromIntersectionResult(n);c.isSome(e)&&this.view.renderCoordsHelper.toRenderCoords(e,i.target),i.targetSurfaceNormal=v.clone(n.normal)}else i.targetSurfaceNormal=null;this._adjustStartEndPositions(e),e.updateInputPoints()}this.priority=L.TaskPriority.LINE_OF_SIGHT_TOOL_INTERACTIVE},i._connectAnalysisToTarget=function(e){return g.reactionInit((()=>({analysis:e,targetLocation:e.target.location,targetIntersection:e.target.intersection})),(({analysis:e,targetLocation:t,targetIntersection:n})=>{c.isSome(t)&&this._onTargetLocationChange(e,t,n)}))},i._connectAnalysisToObserver=function(e){return g.reactionInit((()=>({analysis:e,observer:this.layerViewData.elevationAlignedObserver})),(({analysis:e})=>{this._onObserverChangeForAnalysis(e)}))},i._connectAnalysisToObserverEngine=function(e){return g.reactionInit((()=>({analysis:e,observer:this._observerEngineLocation,observerIntersection:this.layer.intersection})),(({analysis:e,observer:t,observerIntersection:n})=>{this._onObserverEngineForAnalysis(e,t,n)}))},i._connectAnalysisToCamera=function(e){return g.reaction((()=>({camera:this.view.state.camera,isDirty:this._isCameraDirty})),(({isDirty:t})=>{e.inputPoints.isValid&&!t||e.updateInputPoints()}))},i._connectAnalysisToElevation=function(e){return this.view.elevationProvider.on("elevation-change",(t=>{if(!this._canComputeAnalysis(e))return;const n=this.layer.observer;E(t.extent,t.spatialReference,n)&&this._onObserverChange(n);const i=e.target;c.isSome(i)&&E(t.extent,t.spatialReference,i.location)&&e.onElevationChange()}))},i._connectAnalysisForCompute=function(e){var n=this;let i=c.none;const r={analysis:e,interpolationInfo:{originalIntersection:v.create(),originalObserver:v.create(),originalTarget:v.create()}};return a.handlesGroup([g.reactionInit((()=>this.getLineOfSightComputationDependencies(e)),(()=>{i=c.abortMaybe(i),i=l.createTask(function(){var e=t._asyncToGenerator((function*(e){yield l.ignoreAbortErrors(n._tasks.schedule((()=>n.computeAnalysis(r)),e))}));return function(t){return e.apply(this,arguments)}}())})),a.makeHandle((()=>i=c.abortMaybe(i)))])},i._connectAnalysis=function(e){const t=this._analysisHandles;t.has(e)||t.add([this._connectAnalysisToTarget(e),this._connectAnalysisToObserver(e),this._connectAnalysisToObserverEngine(e),this._connectAnalysisToCamera(e),this._connectAnalysisToElevation(e),this._connectAnalysisForCompute(e)])},i._disconnectAnalysis=function(e){this._analysisHandles.remove(e)},i._onAnalysesCollectionChange=function(e){e.added.forEach((e=>this._connectAnalysis(e))),e.removed.forEach((e=>this._disconnectAnalysis(e)))},i._onTargetsChange=function(e){return this._analyses.removeAll(),e.items.length>0&&e.forEach((e=>this._addTarget(e))),e.on("change",(e=>this._onTargetCollectionChange(e)))},i._onTargetCollectionChange=function(e){e.added.forEach((e=>this._addTarget(e))),e.removed.forEach((e=>this._removeTarget(e)))},i._onCursorTargetChange=function(e,t){c.isSome(t)&&this._removeTarget(t),c.isSome(e)&&this._addTarget(e)},i._addTarget=function(e){const t=this._analyses;t.some((t=>t.target===e))||t.add(new A.LineOfSightAnalysis({target:e}))},i._removeTarget=function(e){const t=this._analyses,n=t.find((t=>t.target===e));t.remove(n)},i._connectObserver=function(){return a.handlesGroup([g.reactionInit((()=>this.layer.observer),(e=>this._onObserverChange(e)))])},i._connectAnalyses=function(){let e=null;return a.handlesGroup([g.reactionInit((()=>this._analyses),(t=>{e=c.removeMaybe(e),e=t.on("change",(e=>this._onAnalysesCollectionChange(e))),t.forEach((e=>this._connectAnalysis(e)))})),a.makeHandle((()=>e=c.removeMaybe(e)))])},i._connectTargets=function(){let e=null;return a.handlesGroup([g.reactionInit((()=>this.layer.targets),(t=>{e=c.removeMaybe(e),e=this._onTargetsChange(t)})),g.reactionInit((()=>this.layerViewData.cursorTarget),((e,t)=>{this._onCursorTargetChange(e,t)})),a.makeHandle((()=>{e=c.removeMaybe(e)}))])},t._createClass(n,[{key:"updating",get:function(){return this._tasks.updating}},{key:"priority",get:function(){return this._tasks.priority},set:function(e){this._tasks.priority=e}},{key:"_analyses",get:function(){return this.layerViewData.analyses}},{key:"_observerEngineLocation",get:function(){return this.layerViewData.observerEngineLocation},set:function(e){this.layerViewData.observerEngineLocation=e}},{key:"_screenPixelSize",get:function(){return this.view.state.camera.computeScreenPixelSizeAt(this._observerEngineLocation)}},{key:"_isCameraDirty",get:function(){const e=this.layerViewData.elevationAlignedObserver,{view:t}=this,{renderCoordsHelper:n}=t;if(c.isNone(e)||c.isNone(n))return!1;const i=w;n.toRenderCoords(e,i);const r=t.state.camera.computeScreenPixelSizeAt(i);return Math.abs((r-this._screenPixelSize)/this._screenPixelSize)>P}}]),n}(o.EventedMixin(r)),n.__decorate([u.property({constructOnly:!0})],e.LineOfSightController.prototype,"layer",void 0),n.__decorate([u.property({constructOnly:!0})],e.LineOfSightController.prototype,"layerViewData",void 0),n.__decorate([u.property({constructOnly:!0})],e.LineOfSightController.prototype,"view",void 0),n.__decorate([u.property()],e.LineOfSightController.prototype,"updating",null),n.__decorate([u.property()],e.LineOfSightController.prototype,"priority",null),n.__decorate([u.property()],e.LineOfSightController.prototype,"_analyses",null),n.__decorate([u.property()],e.LineOfSightController.prototype,"_observerEngineLocation",null),n.__decorate([u.property()],e.LineOfSightController.prototype,"_screenPixelSize",null),n.__decorate([u.property()],e.LineOfSightController.prototype,"_tasks",void 0),n.__decorate([u.property()],e.LineOfSightController.prototype,"_isCameraDirty",null),e.LineOfSightController=n.__decorate([y.subclass("esri.views.3d.layers.analysis.LineOfSight.LineOfSightController")],e.LineOfSightController);const P=.1,w=v.create(),k=b.create(),R=m.empty();Object.defineProperty(e,"__esModule",{value:!0})}));
