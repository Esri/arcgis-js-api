/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../Color","../../../../../core/Accessor","../../../../../core/Handles","../../../../../core/handleUtils","../../../../../core/maybe","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/accessorSupport/ensureType","../../../../../core/Logger","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/accessorSupport/trackingUtils","../../../../../chunks/mat4f64","../../../../../chunks/vec3","../../../../../chunks/vec3f64","../../../interactive/visualElements/LineVisualElement"],(function(e,t,n,i,o,r,s,a,l,c,u,d,y,h,f,m,p,g){"use strict";e.LineOfSightView=function(e){function n(t){var n;return(n=e.call(this,t)||this)._handle=null,n._analysisHandles=new r,n}t._inheritsLoose(n,e);var o=n.prototype;return o.initialize=function(){this._handle=this._connectAnalyses()},o.destroy=function(){this._handle=a.removeMaybe(this._handle),this._analysisHandles=a.destroyMaybe(this._analysisHandles)},o.createLineOfSightVisualization=function(){const e=this._configuration,t={view:this.view,attached:!0,width:e.outerWidth,innerWidth:e.innerWidth};return{visibleLineVisualElement:new g.LineVisualElement({...t,color:i.toUnitRGBA(e.visibleOuterColor),innerColor:i.toUnitRGBA(e.visibleInnerColor)}),occludedLineVisualElement:new g.LineVisualElement({...t,color:i.toUnitRGBA(e.occludedOuterColor),innerColor:i.toUnitRGBA(e.occludedInnerColor)}),undefinedLineVisualElement:new g.LineVisualElement({...t,color:i.toUnitRGBA(e.undefinedOuterColor),innerColor:i.toUnitRGBA(e.undefinedInnerColor)})}},o.destroyLineOfSightVisualization=function(e){e.visibleLineVisualElement=a.destroyMaybe(e.visibleLineVisualElement),e.occludedLineVisualElement=a.destroyMaybe(e.occludedLineVisualElement),e.undefinedLineVisualElement=a.destroyMaybe(e.undefinedLineVisualElement)},o.updateLineOfSightVisualization=function(e,t){const n=this._configuration,{computationResult:o,inputPoints:r}=e,{start:s,end:a,intersection:l,isValid:c,isTargetVisible:u}=o,{observer:d}=r,y=v;y[12]=d[0],y[13]=d[1],y[14]=d[2];const h=m.subtract(_,s,d),f=m.subtract(V,a,d),g=m.subtract(L,l,d),{visibleLineVisualElement:O,occludedLineVisualElement:b,undefinedLineVisualElement:A}=t;O.geometry=null,b.geometry=null,A.geometry=null,c?u?(O.geometry=[[p.fromArray(h),p.fromArray(f)]],O.transform=y,O.color=i.toUnitRGBA(n.visibleOuterColor)):(O.geometry=[[p.fromArray(h),p.fromArray(g)]],O.transform=y,O.color=i.toUnitRGBA(n.occludedOuterColor),b.geometry=[[p.fromArray(g),p.fromArray(f)]],b.transform=y):(A.geometry=[[p.fromArray(h),p.fromArray(f)]],A.transform=y)},o.getLineOfSightVisualizationDependencies=function(e){const{computationResult:t}=e,{occludedOuterColor:n,visibleOuterColor:i}=this._configuration;return{computationResult:t,occludedOuterColor:n,visibleOuterColor:i}},o._connectAnalysis=function(e){const t=this._analysisHandles;if(t.has(e))return;const n=this.createLineOfSightVisualization();t.add([h.reactionInit((()=>this.getLineOfSightVisualizationDependencies(e)),(()=>this.updateLineOfSightVisualization(e,n))),s.makeHandle((()=>this.destroyLineOfSightVisualization(n)))])},o._disconnectAnalysis=function(e){this._analysisHandles.remove(e)},o._connectAnalyses=function(){let e=null;return s.handlesGroup([h.reactionInit((()=>this._analyses),(t=>{e=a.removeMaybe(e),e=t.on("change",(e=>this._onAnalysesCollectionChange(e))),this._onAnalysesCollectionChange({target:t,added:t.items,removed:[],moved:[]})})),s.makeHandle((()=>e=a.removeMaybe(e)))])},o._onAnalysesCollectionChange=function(e){e.added.forEach((e=>this._connectAnalysis(e))),e.removed.forEach((e=>this._disconnectAnalysis(e)))},t._createClass(n,[{key:"_analyses",get:function(){return this.layerViewData.analyses}},{key:"_configuration",get:function(){return this.layerViewData.configuration}}]),n}(o),n.__decorate([l.property({constructOnly:!0})],e.LineOfSightView.prototype,"layer",void 0),n.__decorate([l.property({constructOnly:!0})],e.LineOfSightView.prototype,"view",void 0),n.__decorate([l.property({constructOnly:!0})],e.LineOfSightView.prototype,"layerViewData",void 0),n.__decorate([l.property()],e.LineOfSightView.prototype,"_analyses",null),n.__decorate([l.property()],e.LineOfSightView.prototype,"_configuration",null),e.LineOfSightView=n.__decorate([y.subclass("esri.views.3d.layers.analysis.LineOfSight.LineOfSightView")],e.LineOfSightView);const _=p.create(),V=p.create(),L=p.create(),v=f.create();Object.defineProperty(e,"__esModule",{value:!0})}));
