/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../Color","../../../../../core/Accessor","../../../../../core/Handles","../../../../../core/handleUtils","../../../../../core/mathUtils","../../../../../core/maybe","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/accessorSupport/ensureType","../../../../../core/Logger","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/accessorSupport/trackingUtils","../../../../../chunks/mat4f64","../../../../../chunks/vec3","../../../../../chunks/vec3f64","../../../interactive/visualElements/LineVisualElement"],(function(e,i,t,n,o,r,s,l,a,c,u,y,d,p,h,f,m,_,O){"use strict";e.LineOfSightView=function(e){function t(i){var t;return(t=e.call(this,i)||this)._handle=null,t._analysisHandles=new r,t}i._inheritsLoose(t,e);var o=t.prototype;return o.initialize=function(){this._handle=this._connectAnalyses()},o.destroy=function(){this._handle=a.removeMaybe(this._handle),this._analysisHandles=a.destroyMaybe(this._analysisHandles)},o.createLineOfSightVisualization=function(){const e=this._configuration,i=this._opacity,t={view:this.view,attached:!0,width:e.outerWidth,innerWidth:e.innerWidth},o=n.toUnitRGBA(e.visibleOuterColor);l.applyOpacity(o,o,i);const r=n.toUnitRGBA(e.visibleInnerColor);l.applyOpacity(r,r,i);const s=n.toUnitRGBA(e.occludedOuterColor);l.applyOpacity(s,s,i);const a=n.toUnitRGBA(e.occludedInnerColor);l.applyOpacity(a,a,i);const c=n.toUnitRGBA(e.undefinedOuterColor);l.applyOpacity(c,c,i);const u=n.toUnitRGBA(e.undefinedInnerColor);l.applyOpacity(u,u,i);return{visibleLineVisualElement:new O.LineVisualElement({...t,color:o,innerColor:r}),occludedLineVisualElement:new O.LineVisualElement({...t,color:s,innerColor:a}),undefinedLineVisualElement:new O.LineVisualElement({...t,color:c,innerColor:u})}},o.destroyLineOfSightVisualization=function(e){e.visibleLineVisualElement=a.destroyMaybe(e.visibleLineVisualElement),e.occludedLineVisualElement=a.destroyMaybe(e.occludedLineVisualElement),e.undefinedLineVisualElement=a.destroyMaybe(e.undefinedLineVisualElement)},o.updateLineOfSightVisualization=function(e,i){const t=this.visible,o=this._configuration,{computationResult:r,inputPoints:s}=e,{start:a,end:c,intersection:u,isValid:y,isTargetVisible:d}=r,{observer:p}=s,h=b;h[12]=p[0],h[13]=p[1],h[14]=p[2];const f=m.subtract(V,a,p),O=m.subtract(g,c,p),L=m.subtract(v,u,p),{visibleLineVisualElement:A,occludedLineVisualElement:C,undefinedLineVisualElement:w}=i;if(!t)return A.visible=!1,C.visible=!1,void(w.visible=!1);if(A.visible=!0,C.visible=!0,w.visible=!0,A.geometry=null,C.geometry=null,w.geometry=null,y)if(d){A.geometry=[[_.fromArray(f),_.fromArray(O)]],A.transform=h;const e=n.toUnitRGBA(o.visibleOuterColor);A.color=l.applyOpacity(e,e,this._opacity)}else{A.geometry=[[_.fromArray(f),_.fromArray(L)]],A.transform=h;const e=n.toUnitRGBA(o.occludedOuterColor);A.color=l.applyOpacity(e,e,this._opacity),C.geometry=[[_.fromArray(L),_.fromArray(O)]],C.transform=h}else w.geometry=[[_.fromArray(f),_.fromArray(O)]],w.transform=h},o.updateVisualizationOpacity=function(e,i){const t=this._configuration,o=this._opacity,r=n.toUnitRGBA(t.visibleOuterColor);l.applyOpacity(r,r,o);const s=n.toUnitRGBA(t.visibleInnerColor);l.applyOpacity(s,s,o);const a=n.toUnitRGBA(t.occludedOuterColor);l.applyOpacity(a,a,o);const c=n.toUnitRGBA(t.occludedInnerColor);l.applyOpacity(c,c,o);const u=n.toUnitRGBA(t.undefinedOuterColor);l.applyOpacity(u,u,o);const y=n.toUnitRGBA(t.undefinedInnerColor);l.applyOpacity(y,y,o),i.visibleLineVisualElement.color=e.computationResult.isTargetVisible?r:a,i.visibleLineVisualElement.innerColor=s,i.occludedLineVisualElement.color=a,i.occludedLineVisualElement.innerColor=c,i.undefinedLineVisualElement.color=u,i.undefinedLineVisualElement.innerColor=y},o.getLineOfSightVisualizationDependencies=function(e){const{computationResult:i}=e,{occludedOuterColor:t,visibleOuterColor:n}=this._configuration;return{computationResult:i,occludedOuterColor:t,visibleOuterColor:n,visible:this.visible}},o._connectAnalysis=function(e){const i=this._analysisHandles;if(i.has(e))return;const t=this.createLineOfSightVisualization();i.add([h.reactionInit((()=>this.getLineOfSightVisualizationDependencies(e)),(()=>this.updateLineOfSightVisualization(e,t))),h.reaction((()=>this._opacity),(()=>this.updateVisualizationOpacity(e,t))),s.makeHandle((()=>this.destroyLineOfSightVisualization(t)))],e)},o._disconnectAnalysis=function(e){this._analysisHandles.remove(e)},o._connectAnalyses=function(){let e=null;return s.handlesGroup([h.reactionInit((()=>this._analyses),(i=>{e=a.removeMaybe(e),e=i.on("change",(e=>this._onAnalysesCollectionChange(e))),this._onAnalysesCollectionChange({target:i,added:i.items,removed:[],moved:[]})})),s.makeHandle((()=>e=a.removeMaybe(e)))])},o._onAnalysesCollectionChange=function(e){e.added.forEach((e=>this._connectAnalysis(e))),e.removed.forEach((e=>this._disconnectAnalysis(e)))},i._createClass(t,[{key:"visible",get:function(){return this.layerView.visible&&!this.layerView.suspended}},{key:"_analyses",get:function(){return this.layerView.layerViewData.analyses}},{key:"_configuration",get:function(){return this.layerView.layerViewData.configuration}},{key:"_opacity",get:function(){return this.layerView.fullOpacity}}]),t}(o),t.__decorate([c.property({constructOnly:!0})],e.LineOfSightView.prototype,"layer",void 0),t.__decorate([c.property({constructOnly:!0})],e.LineOfSightView.prototype,"layerView",void 0),t.__decorate([c.property({constructOnly:!0})],e.LineOfSightView.prototype,"view",void 0),t.__decorate([c.property({readOnly:!0})],e.LineOfSightView.prototype,"visible",null),t.__decorate([c.property()],e.LineOfSightView.prototype,"_analyses",null),t.__decorate([c.property()],e.LineOfSightView.prototype,"_configuration",null),t.__decorate([c.property()],e.LineOfSightView.prototype,"_opacity",null),e.LineOfSightView=t.__decorate([p.subclass("esri.views.3d.layers.analysis.LineOfSight.LineOfSightView")],e.LineOfSightView);const V=_.create(),g=_.create(),v=_.create(),b=f.create();Object.defineProperty(e,"__esModule",{value:!0})}));
