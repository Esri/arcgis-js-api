/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../intl","../../../../../core/Accessor","../../../../../core/Handles","../../../../../core/mathUtils","../../../../../core/maybe","../../../../../core/quantityFormatUtils","../../../../../core/screenUtils","../../../../../core/unitUtils","../../../../../core/watchUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/accessorSupport/ensureType","../../../../../core/Logger","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/accessorSupport/trackingUtils","../../../../../chunks/vec2","../../../../../chunks/vec3","../../../../../chunks/vec3f64","../../../../../chunks/vec4f32","../../../../../geometry/projectionEllipsoid","../../../interactive/visualElements/LabelVisualElement","../../../interactive/visualElements/LineVisualElement","../../../interactive/visualElements/MeasurementArrowVisualElement","../../../interactive/visualElements/RightAngleQuadVisualElement","../../../interactive/visualElements/support/Segment","../support/viewUtils","../../../webgl-engine/materials/lineStippleUtils","../../../../../intl/locale","../../../../../intl/messages"],(function(e,t,i,n,s,r,a,o,l,c,d,u,h,m,g,p,_,L,v,y,b,w,V,f,S,M,D,E,P,z,A,O){"use strict";function C(e,t,i,n,s){const r=R,o=H;s.projectToRenderScreen(i,r),s.projectToRenderScreen(t,o);const l={segment:"bottom",horizontal:"top",vertical:r[0]<o[0]?"left":"right"};{const n=T,r=j;if(P.screenSpaceTangent(e,i,n,s),P.screenSpaceTangent(e,t,r,s),v.dot(n,r)>=x){const e=a.sign(n[1])===a.sign(r[1]);l.segment=e?f.mirrorPosition(l.vertical):l.vertical}else{const e=U;P.screenSpaceTangent(i,t,e,s),v.dot(e,r)>=x&&(l.segment=a.sign(e[0])===a.sign(r[0])?f.mirrorPosition(l.horizontal):l.horizontal)}}if(2===n){const e=e=>"top"===e?"bottom":"top";l.segment=e(l.segment),l.horizontal=e(l.horizontal),l.vertical=e(l.vertical)}return l}e.DirectLineMeasurementView=function(e){function i(t){var i;return(i=e.call(this,t)||this)._params={...k},i._handles=new r,i._segmentVisualElement=null,i._triangleVisualElement=null,i._rightAngleQuad=null,i._projectedGeodesicLine=null,i._geodesicStartHint=null,i._geodesicEndHint=null,i._segmentLabel=null,i._verticalLabel=null,i._horizontalLabel=null,i._startPosition=b.create(),i._endPosition=b.create(),i._cornerPosition=b.create(),i._startPositionAtSeaLevel=b.create(),i._endPositionAtSeaLevel=b.create(),i._state=0,i._segmentLabelDisplayedMeasurement=1,i._triangleOrientationOverride=null,i.messages=null,i.viewMode=0,i.visualizedMeasurement=0,i.actualVisualizedMeasurement=1,i.visualElementOrientation=0,i.triangleCollapseRatioThreshold=.03,i}t._inheritsLoose(i,e);var n=i.prototype;return n.initialize=function(){this._handles.add(u.whenOnce(this.view,"ready",(()=>this._initialize()),!0))},n._initialize=function(){var e=this;switch(this._state){case 1:throw new Error("invalid state");case 2:return}const i=this._params,n={attached:!0,view:this.view};this._segmentVisualElement=new M.MeasurementArrowVisualElement({...n,geometry:null,renderOccluded:4}),this._triangleVisualElement=new S.LineVisualElement({...n,width:i.triangleLineWidth,color:i.triangleColor,renderOccluded:4}),this._rightAngleQuad=new D.RightAngleQuadVisualElement({...n,color:G,renderOccluded:4});const s={...n,polygonOffset:!0,stippleIntegerRepeats:!1,renderOccluded:4};this._projectedGeodesicLine=new S.LineVisualElement({...s,width:i.geodesicProjectionLineWidth,color:i.geodesicProjectionLineColor,stipplePattern:z.createStipplePatternSimple(i.guideStippleLengthPixels)}),this._geodesicStartHint=new S.LineVisualElement({...s,width:i.guideLineWidth,color:i.geodesicProjectionLineColor,stipplePattern:z.createStipplePatternSimple(i.guideStippleLengthPixels)}),this._geodesicEndHint=new S.LineVisualElement({...s,width:i.guideLineWidth,color:i.geodesicProjectionLineColor,stipplePattern:z.createStipplePatternSimple(i.guideStippleLengthPixels)}),this._segmentLabel=new f.LabelVisualElement({...n,fontSize:i.direcLabelFontSize}),this._verticalLabel=new f.LabelVisualElement({...n,fontSize:i.verticalLabelFontSize}),this._horizontalLabel=new f.LabelVisualElement({...n,fontSize:i.horizontalLabelFontSize}),this._handles.add([L.autorun((()=>this._updateGeometryAndViewMode())),L.autorun((()=>this._updateVisualElementVisibility())),L.autorun((()=>this._updateLabelText())),L.autorun((()=>this._updateLabelVisibility())),L.autorun((()=>this._updateSegmentStripeLength())),A.onLocaleChange(t._asyncToGenerator((function*(){return e._updateMessageBundle()})))]),this._state=1,this._updateMessageBundle()},n.destroy=function(){2!==this._state&&(this._handles=o.destroyMaybe(this._handles),this._segmentVisualElement=o.destroyMaybe(this._segmentVisualElement),this._triangleVisualElement=o.destroyMaybe(this._triangleVisualElement),this._rightAngleQuad=o.destroyMaybe(this._rightAngleQuad),this._projectedGeodesicLine=o.destroyMaybe(this._projectedGeodesicLine),this._geodesicStartHint=o.destroyMaybe(this._geodesicStartHint),this._geodesicEndHint=o.destroyMaybe(this._geodesicEndHint),this._segmentLabel=o.destroyMaybe(this._segmentLabel),this._verticalLabel=o.destroyMaybe(this._verticalLabel),this._horizontalLabel=o.destroyMaybe(this._horizontalLabel),this.set("view",null),this._state=2)},n.whenReady=function(){var e=t._asyncToGenerator((function*(){yield u.whenOnce(this,"ready")}));function i(){return e.apply(this,arguments)}return i}(),n.whenMessages=function(){var e=t._asyncToGenerator((function*(){yield this.whenReady(),yield u.whenOnce(this,"messages")}));function i(){return e.apply(this,arguments)}return i}(),n._updateVisualElementVisibility=function(){if(this._segmentVisualElement.visible=!1,this._triangleVisualElement.visible=!1,this._rightAngleQuad.visible=!1,this._projectedGeodesicLine.visible=!1,this._geodesicStartHint.visible=!1,this._geodesicEndHint.visible=!1,this.visible)switch(this.viewMode){case 0:break;case 1:this._segmentVisualElement.visible=!0;break;case 2:this._segmentVisualElement.visible=!0,this._triangleVisualElement.visible=!0,this._rightAngleQuad.visible=!0;break;case 3:this._segmentVisualElement.visible=!0,this._projectedGeodesicLine.visible=!0,this._geodesicStartHint.visible=!0,this._geodesicEndHint.visible=!0}},n._updateGeometryAndViewMode=function(){const e=this.view.renderCoordsHelper,{startPoint:t,endPoint:i}=this.layer;if(o.isNone(t)||o.isNone(i)||t.equals(i)){this.viewMode=0;const e=this.visualizedMeasurement,t=0===e;return void(this.actualVisualizedMeasurement=t?1:e)}e.toRenderCoords(t,this._startPosition),e.toRenderCoords(i,this._endPosition);const n=this._getActualVisualElementsOrientation(),s=this._updateActualVisualizedMeasurement();this.viewMode=this._computeViewMode(s);let r=this._startPosition,a=this._endPosition;const l=1===n?1:-1,c=l*(e.getAltitude(a)-e.getAltitude(r));c<0&&(r=this._endPosition,a=this._startPosition);const d=2===s?new E.GeodesicSegment(this._startPosition,this._endPosition,e.spatialReference):new E.EuclideanSegment(this._startPosition,this._endPosition);switch(this._segmentVisualElement.geometry=d,this._updateSegmentStripeLength(),this._segmentLabelDisplayedMeasurement=s,this.viewMode){case 1:this._updateSegment(d,n);break;case 2:this._updateSegmentAndTriangle(d,n,r,a,l,c);break;case 3:this._updateSegmentAndProjection(n)}},n._updateSegment=function(e,t){this._segmentLabel.anchor=1===t?"top":"bottom",this._segmentLabel.geometry={type:"segment",segment:e,sampleLocation:"center"}},n._updateSegmentAndTriangle=function(e,t,i,n,s,r){const a=this.view,o=a.renderCoordsHelper,l=a.state.camera,c=this._cornerPosition;o.worldUpAtPosition(i,c),y.scale(c,c,s*Math.abs(r)),y.add(c,c,i),this._triangleVisualElement.geometry=[[[i[0],i[1],i[2]],[c[0],c[1],c[2]],[n[0],n[1],n[2]]]],this._rightAngleQuad.geometry={previous:i,center:c,next:n};const d=new E.EuclideanSegment(i,c),u=new E.EuclideanSegment(c,n),h=C(i,n,c,t,l);this._segmentLabel.anchor=h.segment,this._segmentLabel.geometry={type:"segment",segment:e,sampleLocation:"center"},this._verticalLabel.geometry={type:"segment",segment:d,sampleLocation:"center"},this._verticalLabel.anchor=h.vertical,this._horizontalLabel.geometry={type:"segment",segment:u,sampleLocation:"center"},this._horizontalLabel.anchor=h.horizontal},n._updateSegmentAndProjection=function(e){const t=this.view.renderCoordsHelper;t.setAltitude(this._startPositionAtSeaLevel,0,this._startPosition),t.setAltitude(this._endPositionAtSeaLevel,0,this._endPosition);const i=new E.GeodesicSegment(this._startPositionAtSeaLevel,this._endPositionAtSeaLevel,t.spatialReference);this._projectedGeodesicLine.setGeometryFromSegment(i),this._geodesicStartHint.setGeometryFromSegment(new E.EuclideanSegment(this._startPositionAtSeaLevel,this._startPosition)),this._geodesicEndHint.setGeometryFromSegment(new E.EuclideanSegment(this._endPositionAtSeaLevel,this._endPosition)),this._segmentLabel.geometry={type:"segment",segment:i,sampleLocation:"center"},this._segmentLabel.anchor=1===e?"top":"bottom"},n._updateLabelText=function(){if(1!==this._state)return;const e=this._segmentLabel,t=this._horizontalLabel,i=this._verticalLabel,n=this.messages,s=this.layerView.result;if(o.isNone(s)||o.isNone(n))return e.text=null,t.text=null,void(i.text=null);const r=this._getLabelsText(n,s),a=1===this._segmentLabelDisplayedMeasurement;e.text=a?r.euclideanDistance:r.geodesicDistance,t.text=r.horizontalDistance,i.text=r.verticalDistance,this.notifyChange("labels")},n._updateLabelVisibility=function(){if(1!==this._state)return;const e=this._segmentLabel,t=this._horizontalLabel,i=this._verticalLabel;if(e.visible=!1,t.visible=!1,i.visible=!1,this.visible)switch(this.viewMode){case 1:e.visible=!0;break;case 2:e.visible=!0,t.visible=!0,i.visible=!0;break;case 3:e.visible=!0}},n._getLabelsText=function(e,{directDistance:t,horizontalDistance:i,verticalDistance:n,geodesicDistance:s,geodesicAngle:r}){const a=this.layerView.unit,o=e=>({euclideanDistance:"",geodesicDistance:"",horizontalDistance:"",verticalDistance:"",...e});switch(a){case"metric":return o({euclideanDistance:t&&l.formatMetricLength(e,t),geodesicDistance:s&&l.formatMetricLength(e,s),horizontalDistance:i&&l.formatMetricLength(e,i),verticalDistance:n&&l.formatMetricVerticalLength(e,n)});case"imperial":return o({euclideanDistance:t&&l.formatImperialLength(e,t),geodesicDistance:s&&l.formatImperialLength(e,s),horizontalDistance:i&&l.formatImperialLength(e,i),verticalDistance:n&&l.formatImperialVerticalLength(e,n)});case"degrees":{const t=r&&l.formatDecimal(e,r,"degrees");return o({euclideanDistance:t,geodesicDistance:t,horizontalDistance:t})}case"degrees-minutes-seconds":return o({horizontalDistance:r&&l.formatDMS(r)});default:return o({euclideanDistance:t&&l.formatDecimal(e,t,a),geodesicDistance:s&&l.formatDecimal(e,s,a),horizontalDistance:i&&l.formatDecimal(e,i,a),verticalDistance:n&&l.formatDecimal(e,n,a)})}},n._updateSegmentStripeLength=function(){const e=this._measurementArrowStripeLength,t=this._segmentVisualElement;o.isSome(e)?(t.stripeLength=e,t.stripesEnabled=!0):t.stripesEnabled=!1},n._computeViewMode=function(e){if(2===e){if(!this._geodesicDistanceExceeded)return 1;if(this._requiresGeodesicGuideAt(this._startPosition)||this._requiresGeodesicGuideAt(this._endPosition))return 3}const t=this.layerView.result;if(o.isNone(t))return 1;const{verticalDistance:i,horizontalDistance:n}=t,s=i.value,r=n.value;return Math.min(s/r,r/s)<this.triangleCollapseRatioThreshold?1:2},n._getActualVisualElementsOrientation=function(){if(o.isSome(this._triangleOrientationOverride))return this._triangleOrientationOverride;const e=this.visualElementOrientation;return 0===e?this.view.state.camera.aboveGround?1:2:e},n._updateActualVisualizedMeasurement=function(){if(0===this.visualizedMeasurement){this.actualVisualizedMeasurement=1;const e=this.layerView.unit;"degrees"!==e&&"degrees-minutes-seconds"!==e||(this.actualVisualizedMeasurement=2),this._geodesicDistanceExceeded&&(this.actualVisualizedMeasurement=2)}else this.actualVisualizedMeasurement=this.visualizedMeasurement;return this.actualVisualizedMeasurement},n._requiresGeodesicGuideAt=function(e){const t=this.view;if(!t.state)return!1;const i=t.state.camera,n=t.renderCoordsHelper,s=i.computeScreenPixelSizeAt(e);return n.getAltitude(e)/s>=10},n._updateMessageBundle=function(){O.fetchMessageBundle("esri/core/t9n/Units").then((e=>{this.messages=e,this.view&&this._updateLabelText()}))},t._createClass(i,[{key:"_geodesicDistanceExceeded",get:function(){var e;const t=this.layerView.result;return o.isSome(t)&&(null==(e=t.horizontalDistance)?void 0:e.value)>this.layer.geodesicDistanceThreshold}},{key:"ready",get:function(){return 1===this._state}},{key:"visible",get:function(){return this.layerView.visible&&!this.layerView.suspended}},{key:"allowVisualElementsOrientationChange",get:function(){return o.isNone(this._triangleOrientationOverride)},set:function(e){o.isNone(this._triangleOrientationOverride)!==e&&(o.isNone(this._triangleOrientationOverride)?this._triangleOrientationOverride=this._getActualVisualElementsOrientation():this._triangleOrientationOverride=null)}},{key:"labels",get:function(){return 2===this.actualVisualizedMeasurement?{direct:this._horizontalLabel,horizontal:this._segmentLabel,vertical:this._verticalLabel}:{direct:this._segmentLabel,horizontal:this._horizontalLabel,vertical:this._verticalLabel}}},{key:"testData",get:function(){return{labels:this.labels,stripeLength:this._segmentVisualElement.stripeLength}}},{key:"_measurementArrowStripeLength",get:function(){const e=this.view,{result:t,unit:i}=this.layerView;let n=null;if(o.isSome(t)){const e=t.directDistance;switch(i){case"metric":n=e&&e.toUnit("meters");break;case"imperial":n=e&&e.toUnit(d.preferredImperialLengthUnit(e.value,e.unit));break;case"degrees":case"degrees-minutes-seconds":{const e=t.geodesicAngle;n=e&&e.toUnit("degrees");break}default:n=e&&e.toUnit(i)}}if(n){let t=1;return t=a.nextHighestPowerOfTen(n.value/30),t*="degrees"===n.unit?V.getReferenceEllipsoid(e.spatialReference).metersPerDegree:d.convertUnit(1,n.unit,"meters"),t}return null}}]),i}(s),i.__decorate([h.property()],e.DirectLineMeasurementView.prototype,"_state",void 0),i.__decorate([h.property()],e.DirectLineMeasurementView.prototype,"_segmentLabelDisplayedMeasurement",void 0),i.__decorate([h.property()],e.DirectLineMeasurementView.prototype,"_triangleOrientationOverride",void 0),i.__decorate([h.property()],e.DirectLineMeasurementView.prototype,"_geodesicDistanceExceeded",null),i.__decorate([h.property()],e.DirectLineMeasurementView.prototype,"messages",void 0),i.__decorate([h.property()],e.DirectLineMeasurementView.prototype,"view",void 0),i.__decorate([h.property()],e.DirectLineMeasurementView.prototype,"layer",void 0),i.__decorate([h.property()],e.DirectLineMeasurementView.prototype,"layerView",void 0),i.__decorate([h.property({readOnly:!0})],e.DirectLineMeasurementView.prototype,"ready",null),i.__decorate([h.property({readOnly:!0})],e.DirectLineMeasurementView.prototype,"visible",null),i.__decorate([h.property()],e.DirectLineMeasurementView.prototype,"viewMode",void 0),i.__decorate([h.property()],e.DirectLineMeasurementView.prototype,"visualizedMeasurement",void 0),i.__decorate([h.property()],e.DirectLineMeasurementView.prototype,"actualVisualizedMeasurement",void 0),i.__decorate([h.property()],e.DirectLineMeasurementView.prototype,"visualElementOrientation",void 0),i.__decorate([h.property()],e.DirectLineMeasurementView.prototype,"triangleCollapseRatioThreshold",void 0),i.__decorate([h.property()],e.DirectLineMeasurementView.prototype,"allowVisualElementsOrientationChange",null),i.__decorate([h.property()],e.DirectLineMeasurementView.prototype,"labels",null),i.__decorate([h.property()],e.DirectLineMeasurementView.prototype,"testData",null),i.__decorate([h.property()],e.DirectLineMeasurementView.prototype,"_measurementArrowStripeLength",null),e.DirectLineMeasurementView=i.__decorate([_.subclass("esri.views.3d.layers.DirectLineMeasurement.DirectLineMeasurementView")],e.DirectLineMeasurementView);const G=w.fromValues(1,.5,0,.75),k={laserLineGlowColor:[1,.5,0],laserLineGlowWidth:8,laserLineGlowFalloff:8,laserLineInnerColor:[1,1,1],laserLineInnerWidth:.75,laserLineGlobalAlpha:.75,laserLineEnabled:!0,handleColor:[1,.5,0],handleOpacity:.5,handleRadius:5,triangleColor:G,triangleLineWidth:3,triangleCornerSize:32,triangleSubdivisions:128,arrowWidth:16,arrowOutlineColor:[1,.5,0,1],arrowOutlineWidth:.2,arrowStripeEvenColor:[1,1,1,1],arrowStripeOddColor:[1,.5,0,1],arrowStripeLength:16,arrowSubdivisions:128,geodesicProjectionLineWidth:2,geodesicProjectionLineColor:G,guideLineWidth:2,guideLineColor:G,guideStippleLengthPixels:6,labelDistance:25,direcLabelFontSize:16,horizontalLabelFontSize:12,verticalLabelFontSize:12},x=Math.cos(a.deg2rad(12)),R=c.createRenderScreenPointArray3(),H=c.createRenderScreenPointArray3(),T=c.createRenderScreenPointArray(),j=c.createRenderScreenPointArray(),U=c.createRenderScreenPointArray();Object.defineProperty(e,"__esModule",{value:!0})}));
