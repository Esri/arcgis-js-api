/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import s from"../../../core/Logger.js";import{isSome as e}from"../../../core/maybe.js";import t from"../../../core/PooledArray.js";import{WorkerHandle as o}from"../../../core/workers/WorkerHandle.js";import{canProjectWithoutEngine as p,projectVectorToVector as r}from"../../../geometry/projection.js";import{ModificationType as h}from"../../../libs/i3s/enums.js";const i=s.getLogger("esri.views.3d.layers.I3SMeshWorkerHandle");class u extends o{constructor(s){super("SceneLayerWorker","process",{process:s=>[s.geometryBuffer]},s,{hasInitialize:!0})}setModifications(s,e,t,o){const p={context:s,modifications:c(e,t,o),isGeodetic:o.isGeographic};this.broadcast(p,"setModifications")}setLegacySchema(s,e){const t=JSON.stringify(e);this.broadcast({context:s,jsonSchema:t},"setLegacySchema")}destroyContext(s){return this.broadcast(s,"destroyContext")}}const n=new t({deallocator:null}),a=[0,0,0];function c(s,t,o){n.clear();let u=1/0,c=1/0,f=-1/0,l=-1/0,m=!1;for(const e of t){const s="clip"===e.type?h.Inside:"mask"===e.type?h.Outside:h.Replace,t=e.geometry;let d=s=>s;if(t.spatialReference){if(!p(t.spatialReference,o)){i.warn("Can't project modification polygon into layer spatial reference, ignoring modification");continue}d=s=>(r(s,t.spatialReference,a,o),a)}else t.hasZ||(a[2]=0,d=s=>(a[0]=s[0],a[1]=s[1],a));m=m||s===h.Outside,n.push(s),n.push(t.rings.length);for(const e of t.rings){n.push(e.length);for(const s of e){const e=d(s);n.push(e[0]),n.push(e[1]),n.push(e[2]),u=Math.min(u,e[0]),c=Math.min(c,e[1]),f=Math.max(f,e[0]),l=Math.max(l,e[1])}}}if(e(s))if(m){const e=1e-4;n.push(h.Inside),n.push(2),n.push(4),n.push(u-e),n.push(c-e),n.push(0),n.push(f+e),n.push(c-e),n.push(0),n.push(f+e),n.push(l+e),n.push(0),n.push(u-e),n.push(l+e),n.push(0),n.push(4),n.push(s[0]),n.push(s[1]),n.push(0),n.push(s[2]),n.push(s[1]),n.push(0),n.push(s[2]),n.push(s[3]),n.push(0),n.push(s[0]),n.push(s[3]),n.push(0)}else n.push(h.Outside),n.push(1),n.push(4),n.push(s[0]),n.push(s[1]),n.push(0),n.push(s[2]),n.push(s[1]),n.push(0),n.push(s[2]),n.push(s[3]),n.push(0),n.push(s[0]),n.push(s[3]),n.push(0);n.push(h.Finished);const d=new Float64Array(n.length);for(let e=0;e<n.length;++e)d[e]=n.getItemAt(e);return d}export{u as I3SMeshWorkerHandle,c as toWasmModification};
