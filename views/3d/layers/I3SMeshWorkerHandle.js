/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/Logger","../../../core/maybe","../../../core/PooledArray","../../../core/workers/WorkerHandle","../../../geometry/projection","../../../libs/i3s/enums"],(function(e,s,t,o,i,n,r,u){"use strict";const p=t.getLogger("esri.views.3d.layers.I3SMeshWorkerHandle");let h=function(e){function t(s){return e.call(this,"SceneLayerWorker","process",s,{hasInitialize:!0})||this}s._inheritsLoose(t,e);var o=t.prototype;return o.getTransferList=function(e){return[e.geometryBuffer]},o.setModifications=function(e,s,t,o){const i={context:e,modifications:l(s,t,o),isGeodetic:o.isGeographic};this.broadcast(i,"setModifications")},o.setLegacySchema=function(e,s){const t=JSON.stringify(s);this.broadcast({context:e,jsonSchema:t},"setLegacySchema")},o.destroyContext=function(e){return this.broadcast(e,"destroyContext")},t}(n.WorkerHandle);const c=new i({deallocator:null}),a=[0,0,0];function l(e,s,t){c.clear();let i=1/0,n=1/0,h=-1/0,l=-1/0,f=!1;for(const o of s){const e="clip"===o.type?u.ModificationType.Inside:"mask"===o.type?u.ModificationType.Outside:u.ModificationType.Replace,s=o.geometry;let d=e=>e;if(s.spatialReference){if(!r.canProjectWithoutEngine(s.spatialReference,t)){p.warn("Can't project modification polygon into layer spatial reference, ignoring modification");continue}d=e=>(r.projectVectorToVector(e,s.spatialReference,a,t),a)}else s.hasZ||(a[2]=0,d=e=>(a[0]=e[0],a[1]=e[1],a));f=f||e===u.ModificationType.Outside,c.push(e),c.push(s.rings.length);for(const t of s.rings){c.push(t.length);for(const e of t){const s=d(e);c.push(s[0]),c.push(s[1]),c.push(s[2]),i=Math.min(i,s[0]),n=Math.min(n,s[1]),h=Math.max(h,s[0]),l=Math.max(l,s[1])}}}if(o.isSome(e))if(f){const s=1e-4;c.push(u.ModificationType.Inside),c.push(2),c.push(4),c.push(i-s),c.push(n-s),c.push(0),c.push(h+s),c.push(n-s),c.push(0),c.push(h+s),c.push(l+s),c.push(0),c.push(i-s),c.push(l+s),c.push(0),c.push(4),c.push(e[0]),c.push(e[1]),c.push(0),c.push(e[2]),c.push(e[1]),c.push(0),c.push(e[2]),c.push(e[3]),c.push(0),c.push(e[0]),c.push(e[3]),c.push(0)}else c.push(u.ModificationType.Outside),c.push(1),c.push(4),c.push(e[0]),c.push(e[1]),c.push(0),c.push(e[2]),c.push(e[1]),c.push(0),c.push(e[2]),c.push(e[3]),c.push(0),c.push(e[0]),c.push(e[3]),c.push(0);c.push(u.ModificationType.Finished);const d=new Float64Array(c.length);for(let o=0;o<c.length;++o)d[o]=c.getItemAt(o);return d}e.I3SMeshWorkerHandle=h,e.toWasmModification=l,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
