/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["require","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Collection","../../../core/has","../../../core/Error","../../../core/maybe","../../../core/promiseUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass","./LayerView3D","../../layers/LayerView"],(function(e,s,i,a,t,n,r,o,l,y,c,u){"use strict";const d=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"})),w="analysis-view-handles";let h=function(i){function t(e){var s;return(s=i.call(this,e)||this).type="analysis-3d",s.allAnalysisViews=new a,s._creatingViewCount=0,s._analysisViewCreationTasks=new Map,s._analysisModules={"area-measurement":{module:null},"direct-line-measurement":{module:null},"line-of-sight":{module:null},slice:{module:null}},s}s._inheritsLoose(t,i);var l=t.prototype;return l.initialize=function(){for(const e of this.layer.analyses)this._createAnalysisView(e);this.handles.add([this.layer.analyses.on("after-add",(e=>{this._createAnalysisView(e.item)})),this.layer.analyses.on("after-remove",(e=>{const s=this.allAnalysisViews.removeAt(this.allAnalysisViews.findIndex((s=>s.analysis===e.item)));r.isSome(s)&&s.destroy();const i=this._analysisViewCreationTasks.get(e.item);r.isSome(i)&&(i.abort(),this._analysisViewCreationTasks.delete(e.item))}))],w)},l.destroy=function(){this.handles.remove(w),this.allAnalysisViews.drain((e=>e.destroy())),this._analysisViewCreationTasks.clear(),this._creatingViewCount=0},l.whenAnalysisView=function(e){const s=this._analysisViewCreationTasks.get(e);if(r.isSome(s))return s.promise;const i=new n("layerview:no-analysisview-for-analysis","The analysis has not been added to the AnalysisLayer of this layer view",{analysis:e});return Promise.reject(i)},l.isUpdating=function(){return 0!==this._creatingViewCount||this.allAnalysisViews.some((e=>e.updating))},l._createAnalysisView=function(e){this._analysisViewCreationTasks.set(e,o.createTask((s=>this._createAnalysisViewPromise(e,s))))},l._createAnalysisViewPromise=function(){var e=s._asyncToGenerator((function*(e,s){this._creatingViewCount+=1;const i=e.type,a=this._analysisModules[i];if(r.isNone(a.module)){const e=yield this._loadAnalysisModule(i);a.module=e}const t=new a.module.default({analysis:e,view:this.view,parent:this});if(yield t.when(),this._creatingViewCount-=1,o.isAborted(s))throw t.destroy(),new n("layerview:no-analysisview-for-analysis","The analysis has not been added to the AnalysisLayer of this layer view",{analysis:e});return this.allAnalysisViews.add(t),t}));function i(s,i){return e.apply(this,arguments)}return i}(),l._loadAnalysisModule=function(s){switch(s){case"area-measurement":return new Promise(((s,i)=>e(["../analysis/AreaMeasurementAnalysisView3D"],(e=>s(d(e))),i)));case"direct-line-measurement":return new Promise(((s,i)=>e(["../analysis/DirectLineMeasurementAnalysisView3D"],(e=>s(d(e))),i)));case"line-of-sight":return new Promise(((s,i)=>e(["../analysis/LineOfSightAnalysisView3D"],(e=>s(d(e))),i)));case"slice":return new Promise(((s,i)=>e(["../analysis/SliceAnalysisView3D"],(e=>s(d(e))),i)));default:return null}},t}(c.LayerView3D(u));i.__decorate([l.property()],h.prototype,"type",void 0),i.__decorate([l.property()],h.prototype,"layer",void 0),i.__decorate([l.property()],h.prototype,"allAnalysisViews",void 0),i.__decorate([l.property()],h.prototype,"_creatingViewCount",void 0),h=i.__decorate([y.subclass("esri.views.3d.layers.AnalysisLayerView3D")],h);return h}));
