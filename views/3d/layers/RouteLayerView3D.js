/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../Graphic","../../../core/Collection","../../../core/CollectionFlattener","../../../core/maybe","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","./interfaces","./LayerView3D","./graphics/GraphicsProcessor","./support/projectExtentUtils","../support/EventedSet","../webgl-engine/lib/basicInterfaces","../../layers/LayerView"],(function(e,t,r,i,o,s,n,a,l,c,u,p,d,h,y,f,m,g,v){"use strict";let b=function(t){function a(){var e;return(e=t.apply(this,arguments)||this).type="route-3d",e.loadedGraphics=new m.EventedSet,e._byObjectID=new Map,e.slicePlaneEnabled=!1,e.drapeSourceType=d.DrapeSourceType.Features,e.fullExtentInLocalViewSpatialReference=null,e}e._inheritsLoose(a,t);var l=a.prototype;return l.initialize=function(){this._set("processor",new y.GraphicsProcessor({owner:this,scaleVisibilityEnabled:!0,frustumVisibilityEnabled:!0})),this.addResolvingPromise(this.processor.setup()),this.updatingHandles.addOnCollectionChange((()=>this._routeItems),(e=>this._routeItemsChanged(e))),this.addResolvingPromise(f.toViewIfLocal(this).then((e=>this.fullExtentInLocalViewSpatialReference=e))),this.handles.add(n.when((()=>{var e,t;return null==(e=this.view)||null==(t=e.basemapTerrain)?void 0:t.ready}),(()=>()=>this.notifyChange("updating")),{once:!0}))},l.destroy=function(){this.handles.removeAll(),this.updatingHandles.removeAll(),this._set("processor",s.destroyMaybe(this.processor))},l._routeItemsChanged=function(e){e.removed.length&&this.loadedGraphics.removeMany(e.removed.map((e=>{const t=this._byObjectID.get(e);return this._byObjectID.delete(e),t}))),this.loadedGraphics.addMany(e.added.map((e=>{const t=r.fromJSON(e.toPortalJSON());return this._byObjectID.set(e,t),t})))},l.getSuspendInfo=function(){var e,r,i,o;const s=t.prototype.getSuspendInfo.call(this);return s.outsideScaleRange=null!=(e=null==(r=this.processor)?void 0:r.scaleVisibilitySuspended)&&e,s.outsideOfView=null!=(i=null==(o=this.processor)?void 0:o.frustumVisibilitySuspended)&&i,s},l.fetchPopupFeatures=function(){var t=e._asyncToGenerator((function*(e,t){return s.isSome(t)?t.clientGraphics:null}));function r(e,r){return t.apply(this,arguments)}return r}(),l.getGraphicFromGraphicUid=function(e){return this.processor.getGraphicFromGraphicUid(e)},l.whenGraphicBounds=function(e,t){return this.processor.whenGraphicBounds(e,t)},l.computeAttachmentOrigin=function(e,t){var r;return null==(r=this.processor)?void 0:r.computeAttachmentOrigin(e,t)},l.getSymbolLayerSize=function(e,t){return this.processor.getSymbolLayerSize(e,t)},l.queryGraphics=function(){var t=e._asyncToGenerator((function*(){return new i(this.loadedGraphics.toArray())}));function r(){return t.apply(this,arguments)}return r}(),l.maskOccludee=function(e){return this.processor.maskOccludee(e)},l.highlight=function(e){return this.processor.highlight(e)},l.canResume=function(){var e;return t.prototype.canResume.call(this)&&!(null!=(e=this.processor)&&e.scaleVisibilitySuspended)},l.isUpdating=function(){var e,t,r;return!(!(null!=(e=this.processor)&&e.updating||null==(t=this.view)||null==(r=t.basemapTerrain))&&r.ready)},e._createClass(a,[{key:"_routeItems",get:function(){return new o({getCollections:()=>[this.layer.pointBarriers,this.layer.polygonBarriers,this.layer.polylineBarriers,this.layer.stops,this.layer.directionLines,this.layer.directionPoints,s.isSome(this.layer.routeInfo)?new i([this.layer.routeInfo]):null]})}},{key:"legendEnabled",get:function(){var e;return this.canResume()&&!(null!=(e=this.processor)&&e.frustumVisibilitySuspended)}},{key:"updatePolicy",get:function(){var e;return(null==(e=this.processor)?void 0:e.graphicsCore.effectiveUpdatePolicy)||g.UpdatePolicy.SYNC}},{key:"performanceInfo",get:function(){var e,t,r;return{displayedNumberOfFeatures:this.loadedGraphics.length,maximumNumberOfFeatures:-1,totalNumberOfFeatures:-1,nodes:0,core:null,updating:this.updating,elevationUpdating:null!=(e=null==(t=this.processor)?void 0:t.elevationAlignment.updating)&&e,visibilityFrustum:!(null!=(r=this.processor)&&r.frustumVisibilitySuspended)}}}]),a}(h.LayerView3D(v));t.__decorate([a.property()],b.prototype,"_routeItems",null),t.__decorate([a.property()],b.prototype,"loadedGraphics",void 0),t.__decorate([a.property({readOnly:!0})],b.prototype,"legendEnabled",null),t.__decorate([a.property()],b.prototype,"layer",void 0),t.__decorate([a.property({readOnly:!0})],b.prototype,"processor",void 0),t.__decorate([a.property({type:Boolean})],b.prototype,"slicePlaneEnabled",void 0),b=t.__decorate([p.subclass("esri.views.3d.layers.RouteLayerView3D")],b);return b}));
