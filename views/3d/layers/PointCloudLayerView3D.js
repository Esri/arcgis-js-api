/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/has","../../../core/typedArrayUtil","../../../core/maybe","../../../core/Logger","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass","../../../core/urlUtils","../../../core/uuid","../../../portal/support/resourceExtension","../../../core/promiseUtils","../../../core/Collection","../../../layers/support/CodedValue","../../../layers/support/CodedValueDomain","../../../layers/support/domains","../../../layers/support/fieldUtils","../../../core/screenUtils","../../../core/asyncUtils","../../../chunks/vec3","../../../core/unitUtils","../../../geometry/support/aaBoundingRect","../../../geometry/projection","../../../symbols/support/unitConversionUtils","../../../layers/support/PromiseQueue","../../support/Scheduler","../../../geometry/support/aaBoundingBox","../../support/layerViewUtils","../../../layers/graphics/dehydratedFeatures","../../../chunks/vec3f32","../support/geometryUtils","../support/extentUtils","./LayerView3D","./support/layerViewUpdatingProperties","../../layers/LayerView","../support/orientedBoundingBox","./i3s/I3SUtil","./PointCloudWorkerHandle","./i3s/LoDUtil","./i3s/PagedNodeIndex","./i3s/PointCloudRendererUtil","./i3s/PointCloudWorkerUtil","./i3s/PointGraphic","./i3s/PointRenderer","./support/PopupSceneLayerView"],(function(e,t,i,r,o,n,s,a,d,l,u,h,c,p,_,f,g,y,m,b,w,P,N,x,v,S,C,A,k,I,V,R,L,U,F,Q,D,O,z,W,M,E,B,G,H,q){"use strict";const T=n.getLogger("esri.views.3d.layers.PointCloudLayerView3D"),$=R.plane.create();let j=function(t){function i(){var e;return(e=t.apply(this,arguments)||this).maximumPointCount=4e6,e.slicePlaneEnabled=!1,e._renderer=null,e._rendererAdded=!1,e._renderedNodes=new Set,e._nodeScales=new Map,e._updateViewNeeded=!0,e._lodFactor=1,e._maxLoggedBoxWarnings=5,e._pageMultiplier=1,e._nodeLoadEpoch=0,e._indexQueue=[],e._workQueue=new Array,e._idleQueue=new S,e._indexPagesLoading=new Map,e._loadingNodes=new Map,e._recalcWork=!0,e._layerIsVisible=!1,e._codedDomainPopulationPromise=null,e._codedDomainPopulationAbortController=null,e._totalWork=0,e._index=null,e._loadingInitNodePage=!1,e._nodeIdArray=[],e}e._inheritsLoose(i,t);var n=i.prototype;return n.initialize=function(){const e=this.view.resourceController,t=e.scheduler;this._worker=new z.PointCloudWorkerHandle(t),this.addResolvingPromise(this._worker.promise),this._tmpPoint=I.makeDehydratedPoint(0,0,0,this.layer.spatialReference),O.checkPointCloudLayerValid(this.layer),O.checkPointCloudLayerCompatibleWithView(this.layer,this.view),this._indexRequester=e.createStreamDataRequester(2),this._dataRequester=e.createStreamDataRequester(3),this._initRenderer();const i=this._initNodePages(),r=this.view.resourceController.memoryController;this._memCache=r.getMemCache(this.layer.uid),this.updatingHandles.add(this,"_clippingBox",(()=>this._setUpdateViewNeeded()),2),this.updatingHandles.add(this,"_elevationOffset",(()=>this._elevationOffsetChanged()),2),this.updatingHandles.add(this.layer,"renderer",(()=>this._rendererChanged()),2),this.updatingHandles.add(this.layer,"filters",(()=>this._reload()),2),this.updatingHandles.add(this.layer,"outFields",(()=>this._reload()),2),this.updatingHandles.add(this.layer,"scaleRangeId",(()=>this._setUpdateViewNeeded())),this.updatingHandles.add(this,"clippingArea",(()=>this._setUpdateViewNeeded()),2),this.updatingHandles.add(this.view.state,"camera",(()=>this._setUpdateViewNeeded())),this.handles.add([this.view.basemapTerrain.on("scale-change",(e=>this._scaleUpdateHandler(e))),r.events.on("quality-changed",(()=>this._setUpdateViewNeeded()))]),this.addResolvingPromise(i),this.when((()=>{this.handles.add([t.registerTask(C.Task.POINT_CLOUD_LAYER,(e=>this._process(e)),(()=>this._needsUpdate())),t.registerIdleStateCallbacks((()=>this._idleBegin()),(()=>this._idleEnd())),this.updatingHandles.add(this,"suspended",(e=>{e?this._clearNodeState():this._setUpdateViewNeeded()}),2)])}),(()=>{this.updatingHandles.removeAll(),this.handles.removeAll()}))},n._setUpdateViewNeeded=function(){this._updateViewNeeded=!0,this._updateLoading()},n.destroy=function(){this.cancelLoading(),this._worker&&(this._worker.destroy(),this._worker=null),this._destroyRenderer(),this._memCache.destroy(),this._memCache=null,this._codedDomainPopulationAbortController&&(this._codedDomainPopulationAbortController.abort(),this._codedDomainPopulationAbortController=null),this._codedDomainPopulationPromise=null},n._initRenderer=function(){this._renderer=new H.PointRenderer({createGraphic:(e,t,i)=>this._createGraphic(e,t,i)}),this._renderer.layerUid=this.layer.uid,this.updatingHandles.add(this,"_clippingBox",(e=>this._renderer.clippingBox=e),2),this.updatingHandles.add(this,"suspended",(e=>this._setPointsVisible(!e)),2),this.updatingHandles.add(this,"pointScale",(e=>this._renderer.scaleFactor=e),2),this._renderer.minSizePx=Math.sqrt(2),this.updatingHandles.add(this,"useRealWorldSymbolSizes",(e=>this._renderer.useRealWorldSymbolSizes=e),2),this.updatingHandles.add(this,"pointSize",(e=>{const t=m.pt2px(e);this._renderer.size=e,this._renderer.sizePx=t}),2),this.updatingHandles.add(this,"slicePlaneEnabled",(e=>this._renderer.slicePlane=e),2),this.updatingHandles.add(this,"inverseDensity",(()=>this._setUpdateViewNeeded()),2),this.updatingHandles.add(this,"maximumPointCount",(()=>this._setUpdateViewNeeded()),2),this.updatingHandles.add(this.view,"qualitySettings.sceneService.pointCloud.lodFactor",(e=>{this._lodFactor=e,this._setUpdateViewNeeded()}),2)},n._destroyRenderer=function(){this._renderer.removeAll(),this._setPointsVisible(!1)},n._createGraphic=function(e,t,i){const r=o.isSome(e.pointIdFilterMap)?e.pointIdFilterMap[t]:t,n=this.view.computeMapPointFromVec3d(i),s=this._createGraphicAttributes(e,r);return new G.PointGraphic({pointCloudMetadata:{nodeId:e.id,pointIndexInNode:t,attributePointIndexInNode:r,epoch:this._nodeLoadEpoch},geometry:n,attributes:s,layer:this.layer,sourceLayer:this.layer})},n._createGraphicAttributes=function(e,t){const i={};for(const r of e.attributes)this._encodeGraphicAttribute(r.attributeInfo,r.values,t,i);return i},n._encodeGraphicAttribute=function(e,t,i,r){const o=e.storageInfo&&e.storageInfo.attributeValues,n=o?o.valuesPerElement:1;if(1===n)r[e.name]=t[i];else if("UInt8"===o.valueType&&n<=4){let o=0;const s=i*n;for(let e=s;e<s+n;e++)o=(o<<8)+t[e];r[e.name]=o}else r[e.name]=void 0},n._setPointsVisible=function(e){e&&!this._rendererAdded?(this.view._stage.addRenderPlugin([4],this._renderer),this._rendererAdded=!0):!e&&this._rendererAdded&&(this.view._stage.removeRenderPlugin(this._renderer),this._rendererAdded=!1)},n._rendererChanged=function(){this._renderer.useFixedSizes=E.rendererUsesFixedSizes(this.layer.renderer),this._reload()},n._reload=function(){this._clearNodeState(),this._memCache.clear(),this._setUpdateViewNeeded()},n._elevationOffsetChanged=function(){this._clearNodeState(),this._memCache.clear(),this._initNodePages()},n._scaleUpdateHandler=function(e){this.layer.minScale||this.layer.maxScale?x.projectBoundingRect(e.extent,e.spatialReference,J,this.layer.spatialReference)&&(this._nodeScales.forEach(((t,i)=>{if(!this._renderedNodes.has(i))return void this._nodeScales.delete(i);const r=this._index.getNode(i);N.containsPoint(J,r.obb.center)&&this._nodeScales.set(i,e.scale)})),this._setUpdateViewNeeded()):this._nodeScales.clear()},n.displayNodes=function(e){this._workQueue=W.nodeDiff([...this._renderedNodes],e,this._index),W.sortFrontToBack(this._workQueue,this.view.state.camera.viewForward,this._index),W.splitWorkEntries(this._workQueue,8,this._index),this._updateQueues(),this._totalWork=this._computeWork(),this._updateLoading(),this._layerIsVisible=e.length>0||this._loadingInitNodePage,this.notifyChange("suspended")},n.cancelLoading=function(){this._cancelNodeLoading(),this._cancelIndexLoading()},n._cancelNodeLoading=function(){const e=new Array;this._loadingNodes.forEach((({abortController:t})=>e.push(t))),this._loadingNodes.clear();for(const t of e)t.abort();this._workQueue=[],this._idleQueue.cancelAll(),this._totalWork=this._computeWork(),this._updateLoading()},n._updateQueues=function(){const e=new Set;this._workQueue.forEach((t=>t.load.forEach((t=>e.add(t)))));const t=new Array,i=new Map;this._loadingNodes.forEach(((r,o)=>{e.has(o)?i.set(o,r):t.push(r)})),this._loadingNodes=i;for(const{abortController:e}of t)e.abort();this._workQueue=this._workQueue.filter((e=>{for(const t of e.load)if(this._loadingNodes.has(t))return this._recalcWork=!0,!1;return!0})),this._totalWork=this._computeWork(),this._updateLoading()},n._cancelIndexLoading=function(){this._indexQueue=[],this._indexPagesLoading.forEach((({abortController:e})=>e.abort())),this._indexPagesLoading.clear(),this._totalWork=this._computeWork(),this._updateLoading()},n._clearNodeState=function(){this._nodeLoadEpoch++,this._renderedNodes.forEach((e=>this._removeFromRenderer(e))),this._cancelNodeLoading()},n._idleBegin=function(){this._setUpdateViewNeeded()},n._idleEnd=function(){this._setUpdateViewNeeded()},n._needsUpdate=function(){return this.suspended?this._updateViewNeeded:this._updateViewNeeded||this._indexQueue.length>0||this._workQueue.length>0||this._idleQueue.length>0},n._process=function(e){if(this.suspended){if(this._updateViewNeeded){this._updateViewNeeded=!1;const e=this._isRootNodeVisible();e!==this._layerIsVisible&&(this._layerIsVisible=e,this.notifyChange("suspended")),this._updateLoading()}}else{for(e.run((()=>this._updateWorkQueues()));this._indexQueue.length>0&&e.run((()=>this._processIndexQueue())););for(this._processWorkQueue(e);this._idleQueue.length>0&&e.run((()=>this._idleQueue.process())););}},n._processIndexQueue=function(){const e=this._indexQueue.shift(),t=this._loadNodePage(e);return this._indexPagesLoading.set(e,t),t.promise.then((t=>{this._index.addPage(e,t,this._elevationOffset),this._setUpdateViewNeeded()})).then((()=>{this._indexPagesLoading.delete(e)}),(()=>{this._indexPagesLoading.delete(e)})),!0},n._processWorkQueue=function(e){for(;!e.done;){const t=this._scheduleWorkEntry();if(o.isNone(t))return;this._processWorkEntry(t),e.madeProgress()}},n._scheduleWorkEntry=function(){let e=this._workQueue.length;for(;e--;){const e=this._workQueue.shift();if(!e.remove.find((e=>!this._renderedNodes.has(e))))return e;this._workQueue.push(e)}return null},n._processWorkEntry=function(e){if(0!==e.load.length)c.all(e.load.map((e=>{const t=c.createAbortController(),i=this._memCache.pop(e.toString());return o.isSome(i)?this._loadingNodes.set(e,{abortController:t,promise:c.resolve(i)}):this._loadingNodes.has(e)||this._loadingNodes.set(e,{abortController:t,promise:this.loadNode(e,t.signal)}),this._loadingNodes.get(e).promise}))).then((t=>{for(let i=0;i<e.load.length;i++)if(t[i]){const r=this._setupRendererData(e.load[i],t[i]);this._addToRenderer(r)}for(const t of e.remove)this._removeFromRenderer(t)})).catch((()=>{})).then((()=>{for(const t of e.load)this._loadingNodes.delete(t);this._updateLoading(),this._recalcWork&&0===this._idleQueue.length&&0===this._indexQueue.length&&0===this._loadingNodes.size&&(this._recalcWork=!1,this._setUpdateViewNeeded())})),this._updateLoading();else for(const t of e.remove)this._removeFromRenderer(t)},n.populateClassCodeCodedDomain=async function(e,t){const i="CLASS_CODE",r=this.layer.fieldsIndex.get(i);if(!r||r.domain)return;if(-1===e.indexOf(r.name))return;const o=await b.result(this.layer.queryCachedStatistics(i,{signal:t}));if(!1===o.ok)return;const n=o.value,s=n&&n.labels&&n.labels.labels;s&&Array.isArray(s)&&(r.domain=new f({name:"CLASS_CODE",codedValues:s.map((e=>new _.default({code:e.value,name:e.label})))}))},n.prepareFetchPopupFeatures=async function(e){return this._codedDomainPopulationPromise||(this._codedDomainPopulationAbortController=c.createAbortController(),this._codedDomainPopulationPromise=this.populateClassCodeCodedDomain(e,this._codedDomainPopulationAbortController.signal).then((()=>{this._codedDomainPopulationAbortController=null}))),this._codedDomainPopulationPromise},n.whenGraphicAttributes=async function(e,t){const i=this._splitGraphicsPerNode(e),r=this.layer.attributeStorageInfo,o=t.map((e=>E.getAttributeInfo(r,e))),n=async(e,t)=>{const i=this._index.getNode(t);await b.forEach(o,(async t=>{const r=t.useElevation?await this._loadElevationAttributeFromGeometry(i.resourceId):await this._loadAndParseAttribute(i,t);if(r)for(const i of e)if(this._isValidPointGraphic(i)){const e=i.pointCloudMetadata.attributePointIndexInNode;this._encodeGraphicAttribute(t,r,e,i.attributes)}}))},s=[];return i.forEach(((e,t)=>{s.push(n(e,t))})),await c.eachAlways(s),e},n._isValidPointGraphic=function(e){return e instanceof G.PointGraphic&&e.pointCloudMetadata&&e.pointCloudMetadata.epoch===this._nodeLoadEpoch},n._splitGraphicsPerNode=function(e){const t=new Map;for(const i of e){if(!this._isValidPointGraphic(i))continue;const e=i.pointCloudMetadata,r=t.get(e.nodeId);r?r.push(i):t.set(e.nodeId,[i])}return t},n._loadAndParseAttribute=async function(e,t){const i=await this._loadAttribute(e.resourceId,t,null);return o.isSome(i)?B.getAttributeValues({attributeInfo:t,buffer:i},null,e.vertexCount):null},n._loadElevationAttributeFromGeometry=async function(e){const t=this.layer.store.defaultGeometrySchema,i=B.readGeometry(t,await this._loadGeometry(e,null));return B.elevationFromPositions(i,i.length/3)},n.highlight=function(e){if(!e)return{remove(){}};const t=p.isCollection(e)?e.toArray():Array.isArray(e)?e:[e];return this._renderer.highlight(t.map((e=>this._graphicToPointDefinition(e))))},n._graphicToPointDefinition=function(e){if(!this._isValidPointGraphic(e))return null;const{nodeId:t,pointIndexInNode:i}=e.pointCloudMetadata;return null!=t&&null!=i?{nodeId:t,pointId:i}:null},n._computeWork=function(){let e=0;for(const t of this._workQueue)e+=t.load.length+t.remove.length;return e+=this._loadingNodes.size,e+=(this._indexQueue.length+this._indexPagesLoading.size)*this._index.pageSize,e+=this._loadingInitNodePage?100:0,e+=this._updateViewNeeded?100:0,e},n._updateLoading=function(){this.notifyChange("updating"),this.notifyChange("updatingProgressValue")},n.canResume=function(){return t.prototype.canResume.call(this)&&this._layerIsVisible},n.isUpdating=function(){return this.suspended?this._updateViewNeeded:this._computeWork()>0},n._initNodePages=function(){const e=this.layer.store.index,t=e.nodesPerPage||e.nodePerIndexBlock;return this._index=new M(this.layer.spatialReference,this.view.renderCoordsHelper.spatialReference,t),this._cancelIndexLoading(),this._traverseVisible=this._index.createVisibilityTraverse(),this._loadingInitNodePage=!0,this._layerIsVisible=!0,this.notifyChange("suspended"),this._updateLoading(),this._pageMultiplier=null!=e.nodesPerPage?1:e.nodePerIndexBlock,this._loadNodePage(0).promise.then((e=>{this._index.addPage(0,e,this._elevationOffset),this._loadingInitNodePage=!1,this._setUpdateViewNeeded()}))},n._loadNodePage=function(e){const t=c.createAbortController(),i=`${this.baseUrl}/nodepages/${e*this._pageMultiplier}`;return{promise:this._requestNodePage(i,t.signal).then((t=>t.nodes.map(((t,i)=>({resourceId:null!=t.resourceId?t.resourceId:e*this._index.pageSize+i,obb:t.obb,firstChild:t.firstChild,childCount:t.childCount,vertexCount:null!=t.vertexCount?t.vertexCount:t.pointCount,lodThreshold:null!=t.lodThreshold?t.lodThreshold:t.effectiveArea}))))),abortController:t}},n._updateWorkQueues=function(){if(!this._updateViewNeeded)return!1;let e=this.inverseDensity/this._lodFactor*this._getLodMemoryFactor();const t=this.maximumPointCount*this._lodFactor*this._getLodMemoryFactor();let i=this._computeNodesForMinimumDensity(e),r=this._computePointCount(i),o=Math.sqrt(r/(.75*t));for(;r>t;)e*=o,i=this._computeNodesForMinimumDensity(e),r=this._computePointCount(i),o=Math.sqrt(2);return this.displayNodes(i),this._updateViewNeeded=!1,this._updateLoading(),!0},n._computePointCount=function(e){let t=0;for(let i=0;i<e.length;i++){const r=this._index.getNode(e[i]);r&&(t+=r.vertexCount)}return t},n._getLodMemoryFactor=function(){return this.view.resourceController.memoryController.memoryFactor},n._isRootNodeVisible=function(){let e=!1;return this._traverseVisible({frustumPlanes:this.view.state.camera.frustum.planes,clippingBox:this._clippingBox},{predicate:(t,i,r)=>(e=r,!1),pageMiss:()=>{}}),e},n._computeNodesForMinimumDensity=function(e){const t=this.view.state.camera,i=t.frustum,r=this._clippingBox,o=t.viewForward,n=w.dot(o,t.eye),s=R.plane.fromNormalAndOffset(o,-n,$),a=t.perScreenPixelRatio/2,d=e*e,l=this._nodeIdArray;l.length=0;const{minScale:u,maxScale:h}=k.extractSafeScaleBounds(this.layer),c=0===u&&0===h?e=>l.push(e):e=>{const t=this._getScale(e);k.scaleBoundsPredicate(t,u,h)&&l.push(e)};return this._traverseVisible({frustumPlanes:i.planes,clippingBox:r},{predicate:(e,t,i)=>{if(!i)return!1;if(0===t.childCount)return c(e),!1;const r=this._index.getRenderObb(e);return!(this._computeAveragePixelArea(r,t.lodThreshold,t.vertexCount,s,a)<=d)||(c(e),!1)},pageMiss:(e,t)=>{c(e),this._indexQueue.indexOf(t)<0&&this._indexQueue.push(t)}}),l},n._getScale=function(e){let t=this._nodeScales.get(e);if(null==t){const i=this._index.getNode(e).obb.center;this._tmpPoint.x=i[0],this._tmpPoint.y=i[1],this._tmpPoint.z=i[2],t=this.view.basemapTerrain.getScale(this._tmpPoint),this._nodeScales.set(e,t)}return t},n._computeAveragePixelArea=function(e,t,i,r,o){const n=Math.max(1e-7,D.minimumDistancePlane(e,r));return t/(n*n)/(4*o*o)/i},n.loadNode=function(e,t){try{return this.loadNodeAsync(e,t)}catch(e){throw c.isAbortError(e)||T.error(e),e}},n.loadAdditionalUserAttributes=async function(e,t,i){const r=this.layer.outFields;if(!r)return[];const n=y.unpackFieldNames(this.layer.fields,r),s=new Set(e.map((e=>o.isSome(e)?e.name:null))),a=this.layer.attributeStorageInfo,d=[];for(const e of n){if(s.has(e))continue;const i=E.getAttributeInfo(a,e);i&&d.push(t(i))}const l=await c.eachAlwaysValues(d);return c.throwIfAborted(i),o.mapSome(l,(e=>e))},n.loadNodeAsync=async function(e,t){const i=this._index.getNode(e),r=E.getRendererInfo(this.layer),n=E.getFilterInfo(this.layer),s=i.resourceId,a=async e=>{if(o.isNone(e))return null;if(e.useElevation)return{attributeInfo:e,buffer:null};const i=await this._loadAttribute(s,e,t);return o.isSome(i)?{attributeInfo:e,buffer:i}:null};return this._idleQueue.push((async()=>{const i=this._loadGeometry(s,t),{primaryAttribute:o,modulationAttribute:d}=r,l=a(o),u=a(d),h=n.map((e=>e.attributeInfo)),p=h.map((e=>a(e))),_=this.loadAdditionalUserAttributes([o,d,...h],a,t),[f,g,y,m,b]=await c.all([i,l,u,c.all(p),_]);c.throwIfAborted(t);const w={geometryBuffer:f,primaryAttributeData:g,modulationAttributeData:y,filterAttributesData:m,userAttributesData:b,schema:this.layer.store.defaultGeometrySchema,rendererInfo:r,filterInfo:n,obb:this._index.getRenderObb(e),elevationOffset:this._elevationOffset,inSR:this.layer.spatialReference.toJSON(),outSR:this.view.renderCoordsHelper.spatialReference.toJSON()};return this._worker.invoke(w,t)}),t)},n._loadGeometry=async function(e,t){return this._requestData(`${this.baseUrl}/nodes/${e}/geometries/0`,t)},n._loadAttribute=async function(e,t,i){if(o.isNone(t)||!t.storageInfo)return null;const r=t.storageInfo.key;return this._requestData(`${this.baseUrl}/nodes/${e}/attributes/${r}`,i)},n._requestNodePage=function(e,t){return this._indexRequester.request(e,"json",{query:{f:"json"},signal:t})},n._requestData=function(e,t){return this._dataRequester.request(e,"binary",{signal:t})},n._removeFromRenderer=function(e){if(this._renderedNodes.has(e)){const t=this._renderer.removeNode(e);this._renderedNodes.delete(e),this._nodeScales.delete(e),this._memCache.put(t.id.toString(),t,function(e){return 5*e.coordinates.length+128}(t))}},n._addToRenderer=function(e){this._renderedNodes.has(e.id)||(this._renderedNodes.add(e.id),this._renderer.addNode(e))},n._setupRendererData=function(e,t){const i=this._index.getNode(e),r=Math.sqrt(i.lodThreshold/i.vertexCount),o=this._index.getRenderObb(e);if(H.PointRenderer.isInstanceOfNode(t))return t.splatSize=r,t.obb=o,t.origin=V.clone(t.obb.center),t;const n=1.001;if(t.obb.halfSize[0]>o.halfSize[0]*n||t.obb.halfSize[1]>o.halfSize[1]*n||t.obb.halfSize[2]>o.halfSize[2]*n){if(this._maxLoggedBoxWarnings>0){const i=e=>`[${e.halfSize[0]}, ${e.halfSize[1]}, ${e.halfSize[2]}]`;T.warn(`Node ${e} reported bounding box too small. got ${i(o)} but points cover ${i(t.obb)}`),0==--this._maxLoggedBoxWarnings&&T.warn("  Too many bounding box errors, stopping reporting for this layer.")}this._index.setRenderObb(e,t.obb)}return{id:e,coordinates:t.points,origin:V.clone(o.center),rgb:t.rgb,attributes:t.attributes,pointIdFilterMap:t.pointIdFilterMap,highlights:null,splatSize:r,obb:o,isLeaf:0===i.childCount}},n.getUsedMemory=function(){let e=0;return this._renderer.forEachNode((t=>{e+=Y,e+=r.estimateSize(t.coordinates);for(const i of t.attributes){const t=i.values;r.isArrayBuffer(t.buffer)&&(e+=r.estimateSize(t))}})),e},n.getUnloadedMemory=function(){const e=this._renderedNodes.size;if(e<4)return 0;const t=[...this._renderedNodes].reduce(((e,t)=>e+this._index.getNode(t).vertexCount));let i=this._loadingNodes.size;for(let e=0;e<this._workQueue.length;e++)i+=this._workQueue[e].load.length,i-=this._workQueue[e].remove.length;if(i<0)return 0;return i*t/e*((this.getUsedMemory()-e*Y)/t)+i*Y},n.ignoresMemoryFactor=function(){return!1},e._createClass(i,[{key:"pointScale",get:function(){const e=E.getSplatSizeAlgorithm(this.layer&&this.layer.renderer);return e&&null!=e.scaleFactor?e.scaleFactor:1}},{key:"useRealWorldSymbolSizes",get:function(){const e=E.getFixedSizeAlgorithm(this.layer&&this.layer.renderer);return!(!e||null==e.useRealWorldSymbolSizes)&&e.useRealWorldSymbolSizes}},{key:"pointSize",get:function(){const e=E.getFixedSizeAlgorithm(this.layer&&this.layer.renderer);return e&&null!=e.size?e.size:0}},{key:"inverseDensity",get:function(){return this.layer&&this.layer.renderer?96/this.layer.renderer.pointsPerInch:5}},{key:"availableFields",get:function(){const e=E.getRendererInfo(this.layer),t=new Set;e.primaryAttribute&&t.add(e.primaryAttribute.name),e.modulationAttribute&&t.add(e.primaryAttribute.name);const i=E.getFilterInfo(this.layer);if(i)for(const e of i)t.add(e.attributeInfo.name);if(this.layer.outFields)for(const e of y.unpackFieldNames(this.layer.fields,this.layer.outFields))t.add(e);return Array.from(t)}},{key:"_clippingBox",get:function(){if(!this.view||!this.view.clippingArea)return null;const e=A.create(),t=this.view.renderSpatialReference;return L.projectToBoundingBox(this.view.clippingArea,e,t)?e:null}},{key:"_elevationOffset",get:function(){const e=this.layer&&this.layer.elevationInfo;if(e&&"absolute-height"===e.mode){const t=P.getMetersPerVerticalUnitForSR(this.layer.spatialReference),i=v.getMetersPerUnit(e.unit);return o.unwrapOr(e.offset,0)*i/t}return 0}},{key:"updatingProgressValue",get:function(){if(this.suspended)return this._updateViewNeeded?0:1;const e=this._computeWork();return 1-Math.min(this._totalWork,e)/this._totalWork}},{key:"performanceInfo",get:function(){return{nodes:this._renderedNodes.size,displayedNumberOfFeatures:[...this._renderedNodes].reduce(((e,t)=>e+this._index.getNode(t).vertexCount),0),maximumNumberOfFeatures:this.maximumPointCount,totalNumberOfFeatures:-1,core:null,"Loading Nodes":this._loadingNodes.size,"Index Queue":this._indexQueue.length,"Work Queue":this._workQueue.length,"Idle Queue":this._idleQueue.length}}},{key:"test",get:function(){return{index:this._index,visibleNodes:this._renderedNodes}}}]),i}(q.PopupSceneLayerView(U.LayerView3D(Q)));t.__decorate([a.property()],j.prototype,"layer",void 0),t.__decorate([a.property({readOnly:!0,aliasOf:"layer.parsedUrl.path"})],j.prototype,"baseUrl",void 0),t.__decorate([a.property({readOnly:!0,dependsOn:["layer.renderer"]})],j.prototype,"pointScale",null),t.__decorate([a.property({readOnly:!0,dependsOn:["layer.renderer"]})],j.prototype,"useRealWorldSymbolSizes",null),t.__decorate([a.property({readOnly:!0,dependsOn:["layer.renderer"]})],j.prototype,"pointSize",null),t.__decorate([a.property({readOnly:!0,dependsOn:["layer.renderer"]})],j.prototype,"inverseDensity",null),t.__decorate([a.property()],j.prototype,"maximumPointCount",void 0),t.__decorate([a.property({readOnly:!0,dependsOn:["layer.renderer","layer.filters","layer.outFields"]})],j.prototype,"availableFields",null),t.__decorate([a.property({readOnly:!0,dependsOn:["view.clippingArea"]})],j.prototype,"_clippingBox",null),t.__decorate([a.property({readOnly:!0,dependsOn:["layer.elevationInfo"]})],j.prototype,"_elevationOffset",null),t.__decorate([a.property({type:Boolean})],j.prototype,"slicePlaneEnabled",void 0),t.__decorate([a.property()],j.prototype,"updating",void 0),t.__decorate([a.property(F.updatingProgress)],j.prototype,"updatingProgress",void 0),t.__decorate([a.property({readOnly:!0,dependsOn:["suspended"]})],j.prototype,"updatingProgressValue",null),j=t.__decorate([d.subclass("esri.views.3d.layers.PointCloudLayerView3D")],j);const J=N.create(),Y=160;return j}));
