// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../core/arrayUtils","../../../core/arrayUtils","../../../core/asyncUtils","../../../core/Collection","../../../core/Logger","../../../core/maybe","../../../core/promiseUtils","../../../core/screenUtils","../../../core/SetUtils","../../../core/typedArrayUtil","../../../core/unitUtils","../../../core/accessorSupport/decorators","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f32","../../../geometry/support/aaBoundingBox","../../../geometry/support/aaBoundingRect","../../../layers/graphics/dehydratedFeatures","../../../layers/support/CodedValue","../../../layers/support/domains","../../../layers/support/fieldUtils","../../../layers/support/PromiseQueue","../../../symbols/support/unitConversionUtils","./LayerView3D","./PointCloudWorkerHandle","./i3s/I3SUtil","./i3s/LoDUtil","./i3s/PagedNodeIndex","./i3s/PointCloudRendererUtil","./i3s/PointCloudWorkerUtil","./i3s/PointGraphic","./i3s/PointRenderer","./support/layerViewUpdatingProperties","./support/PopupSceneLayerView","../support/extentUtils","../support/geometryUtils","../support/orientedBoundingBox","../support/projectionUtils","../../layers/LayerView","../../support/layerViewUtils","../../support/Scheduler"],(function(e,t,r,i,n,o,a,s,d,u,l,h,p,c,_,f,g,y,m,v,b,w,P,N,x,S,C,A,I,k,V,O,R,L,U,F,D,Q,z,W,M,E,B){"use strict";var G=s.getLogger("esri.views.3d.layers.PointCloudLayerView3D"),H=Q.plane.create(),q=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.maximumPointCount=4e6,t.slicePlaneEnabled=!1,t._renderer=null,t._rendererAdded=!1,t._renderedNodes=new Set,t._nodeScales=new Map,t._updateViewNeeded=!0,t._lodFactor=1,t._maxLoggedBoxWarnings=5,t._pageMultiplier=1,t._nodeLoadEpoch=0,t._indexQueue=[],t._workQueue=new Array,t._idleQueue=new N.default,t._indexPagesLoading=new Map,t._loadingNodes=new Map,t._recalcWork=!0,t._layerIsVisible=!1,t._codedDomainPopulationPromise=null,t._codedDomainPopulationAbortController=null,t._totalWork=0,t._index=null,t._loadingInitNodePage=!1,t._nodeIdArray=[],t}return r.__extends(t,e),Object.defineProperty(t.prototype,"pointScale",{get:function(){var e=V.getSplatSizeAlgorithm(this.layer&&this.layer.renderer);return e&&null!=e.scaleFactor?e.scaleFactor:1},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"useRealWorldSymbolSizes",{get:function(){var e=V.getFixedSizeAlgorithm(this.layer&&this.layer.renderer);return!(!e||null==e.useRealWorldSymbolSizes)&&e.useRealWorldSymbolSizes},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"pointSize",{get:function(){var e=V.getFixedSizeAlgorithm(this.layer&&this.layer.renderer);return e&&null!=e.size?e.size:0},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"inverseDensity",{get:function(){return this.layer&&this.layer.renderer?96/this.layer.renderer.pointsPerInch:5},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"availableFields",{get:function(){var e=V.getRendererInfo(this.layer),t=new Set;e.primaryAttribute&&t.add(e.primaryAttribute.name),e.modulationAttribute&&t.add(e.primaryAttribute.name);var r=V.getFilterInfo(this.layer);if(r)for(var i=0,n=r;i<n.length;i++){var o=n[i];t.add(o.attributeInfo.name)}if(this.layer.outFields)for(var a=0,s=P.unpackFieldNames(this.layer.fields,this.layer.outFields);a<s.length;a++){var d=s[a];t.add(d)}return h.valuesOfSet(t)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"_clippingBox",{get:function(){if(!this.view||!this.view.clippingArea)return null;var e=y.create(),t=this.view.renderSpatialReference;return D.projectToBoundingBox(this.view.clippingArea,e,t)?e:null},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"_elevationOffset",{get:function(){var e=this.layer&&this.layer.elevationInfo;if(e&&"absolute-height"===e.mode){var t=c.getMetersPerVerticalUnitForSR(this.layer.spatialReference),r=x.getMetersPerUnit(e.unit);return d.unwrapOr(e.offset,0)*r/t}return 0},enumerable:!1,configurable:!0}),t.prototype.initialize=function(){var e=this,t=this.view.resourceController,r=t.scheduler;this._worker=new C.PointCloudWorkerHandle(r),this.addResolvingPromise(this._worker.promise),this._tmpPoint=v.makeDehydratedPoint(0,0,0,this.layer.spatialReference),A.checkPointCloudLayerValid(this.layer),A.checkPointCloudLayerCompatibleWithView(this.layer,this.view),this._streamDataRequester=t.createStreamDataRequester(2),this._initRenderer();var i=this._initNodePages(),n=this.view.resourceController.memoryController;this._memCache=n.getMemCache(this.layer.uid),this.updatingHandles.add(this,"_clippingBox",(function(){return e._setUpdateViewNeeded()}),2),this.updatingHandles.add(this,"_elevationOffset",(function(){return e._elevationOffsetChanged()}),2),this.updatingHandles.add(this.layer,"renderer",(function(){return e._rendererChanged()}),2),this.updatingHandles.add(this.layer,"filters",(function(){return e._reload()}),2),this.updatingHandles.add(this.layer,"outFields",(function(){return e._reload()}),2),this.updatingHandles.add(this.layer,"scaleRangeId",(function(){return e._setUpdateViewNeeded()})),this.updatingHandles.add(this,"clippingArea",(function(){return e._setUpdateViewNeeded()}),2),this.updatingHandles.add(this.view.state,"camera",(function(){return e._setUpdateViewNeeded()})),this.handles.add([this.view.basemapTerrain.on("scale-change",(function(t){return e._scaleUpdateHandler(t)})),n.events.on("quality-changed",(function(){return e._setUpdateViewNeeded()}))]),this.addResolvingPromise(i),this.when((function(){e.handles.add([r.registerTask(B.Task.POINT_CLOUD_LAYER,(function(t){return e._process(t)}),(function(){return e._needsUpdate()})),r.registerIdleStateCallbacks((function(){return e._idleBegin()}),(function(){return e._idleEnd()})),e.updatingHandles.add(e,"suspended",(function(t){t?e._clearNodeState():e._setUpdateViewNeeded()}),2)])}),(function(){e.updatingHandles.removeAll(),e.handles.removeAll()}))},t.prototype._setUpdateViewNeeded=function(){this._updateViewNeeded=!0,this._updateLoading()},t.prototype.destroy=function(){this.cancelLoading(),this._worker&&(this._worker.destroy(),this._worker=null),this._destroyRenderer(),this._memCache.destroy(),this._memCache=null,this._codedDomainPopulationAbortController&&(this._codedDomainPopulationAbortController.abort(),this._codedDomainPopulationAbortController=null),this._codedDomainPopulationPromise=null},t.prototype._initRenderer=function(){var e=this;this._renderer=new L.PointRenderer({createGraphic:function(t,r,i){return e._createGraphic(t,r,i)}}),this._renderer.layerUid=this.layer.uid,this.updatingHandles.add(this,"_clippingBox",(function(t){return e._renderer.clippingBox=t}),2),this.updatingHandles.add(this,"suspended",(function(t){return e._setPointsVisible(!t)}),2),this.updatingHandles.add(this,"pointScale",(function(t){return e._renderer.scaleFactor=t}),2),this._renderer.minSizePx=Math.sqrt(2),this.updatingHandles.add(this,"useRealWorldSymbolSizes",(function(t){return e._renderer.useRealWorldSymbolSizes=t}),2),this.updatingHandles.add(this,"pointSize",(function(t){var r=l.pt2px(t);e._renderer.size=t,e._renderer.sizePx=r}),2),this.updatingHandles.add(this,"slicePlaneEnabled",(function(t){return e._renderer.slicePlane=t}),2),this.updatingHandles.add(this,"inverseDensity",(function(){return e._setUpdateViewNeeded()}),2),this.updatingHandles.add(this,"maximumPointCount",(function(){return e._setUpdateViewNeeded()}),2),this.updatingHandles.add(this.view,"qualitySettings.sceneService.pointCloud.lodFactor",(function(t){e._lodFactor=t,e._setUpdateViewNeeded()}),2)},t.prototype._destroyRenderer=function(){this._renderer.removeAll(),this._setPointsVisible(!1)},t.prototype._createGraphic=function(e,t,r){var i=d.isSome(e.pointIdFilterMap)?e.pointIdFilterMap[t]:t,n=this.view.computeMapPointFromVec3d(r),o=this._createGraphicAttributes(e,i);return new R.PointGraphic({pointCloudMetadata:{nodeId:e.id,pointIndexInNode:t,attributePointIndexInNode:i,epoch:this._nodeLoadEpoch},geometry:n,attributes:o,layer:this.layer,sourceLayer:this.layer})},t.prototype._createGraphicAttributes=function(e,t){for(var r={},i=0,n=e.attributes;i<n.length;i++){var o=n[i];this._encodeGraphicAttribute(o.attributeInfo,o.values,t,r)}return r},t.prototype._encodeGraphicAttribute=function(e,t,r,i){var n=e.storageInfo&&e.storageInfo.attributeValues,o=n?n.valuesPerElement:1;if(1===o)i[e.name]=t[r];else if("UInt8"===n.valueType&&o<=4){for(var a=0,s=r*o,d=s;d<s+o;d++)a=(a<<8)+t[d];i[e.name]=a}else i[e.name]=void 0},t.prototype._setPointsVisible=function(e){e&&!this._rendererAdded?(this.view._stage.addRenderPlugin([4],this._renderer),this._rendererAdded=!0):!e&&this._rendererAdded&&(this.view._stage.removeRenderPlugin(this._renderer),this._rendererAdded=!1)},t.prototype._rendererChanged=function(){this._renderer.useFixedSizes=V.rendererUsesFixedSizes(this.layer.renderer),this._reload()},t.prototype._reload=function(){this._clearNodeState(),this._memCache.clear(),this._setUpdateViewNeeded()},t.prototype._elevationOffsetChanged=function(){this._clearNodeState(),this._memCache.clear(),this._initNodePages()},t.prototype._scaleUpdateHandler=function(e){var t=this;this.layer.minScale||this.layer.maxScale?W.boundingRectToBoundingRect(e.extent,e.spatialReference,T,this.layer.spatialReference)&&(this._nodeScales.forEach((function(r,i){if(t._renderedNodes.has(i)){var n=t._index.getNode(i);m.containsPoint(T,n.obb.center)&&t._nodeScales.set(i,e.scale)}else t._nodeScales.delete(i)})),this._setUpdateViewNeeded()):this._nodeScales.clear()},t.prototype.displayNodes=function(e){this._workQueue=I.nodeDiff(i.keysOfSet(this._renderedNodes),e,this._index),I.sortFrontToBack(this._workQueue,this.view.state.camera.viewForward,this._index),I.splitWorkEntries(this._workQueue,8,this._index),this._updateQueues(),this._totalWork=this._computeWork(),this._updateLoading(),this._layerIsVisible=e.length>0||this._loadingInitNodePage,this.notifyChange("suspended")},t.prototype.cancelLoading=function(){this._cancelNodeLoading(),this._cancelIndexLoading()},t.prototype._cancelNodeLoading=function(){var e=new Array;this._loadingNodes.forEach((function(t){var r=t.abortController;return e.push(r)})),this._loadingNodes.clear();for(var t=0,r=e;t<r.length;t++){r[t].abort()}this._workQueue=[],this._idleQueue.cancelAll(),this._totalWork=this._computeWork(),this._updateLoading()},t.prototype._updateQueues=function(){var e=this,t=new Set;this._workQueue.forEach((function(e){return e.load.forEach((function(e){return t.add(e)}))}));var r=new Array,i=new Map;this._loadingNodes.forEach((function(e,n){t.has(n)?i.set(n,e):r.push(e)})),this._loadingNodes=i;for(var n=0,o=r;n<o.length;n++){o[n].abortController.abort()}this._workQueue=this._workQueue.filter((function(t){for(var r=0,i=t.load;r<i.length;r++){var n=i[r];if(e._loadingNodes.has(n))return e._recalcWork=!0,!1}return!0})),this._totalWork=this._computeWork(),this._updateLoading()},t.prototype._cancelIndexLoading=function(){this._indexQueue=[],this._indexPagesLoading.forEach((function(e){return e.abortController.abort()})),this._indexPagesLoading.clear(),this._totalWork=this._computeWork(),this._updateLoading()},t.prototype._clearNodeState=function(){var e=this;this._nodeLoadEpoch++,this._renderedNodes.forEach((function(t){return e._removeFromRenderer(t)})),this._cancelNodeLoading()},t.prototype._idleBegin=function(){this._setUpdateViewNeeded()},t.prototype._idleEnd=function(){this._setUpdateViewNeeded()},t.prototype._needsUpdate=function(){return this.suspended?this._updateViewNeeded:this._updateViewNeeded||this._indexQueue.length>0||this._workQueue.length>0||this._idleQueue.length>0},t.prototype._process=function(e){var t=this;if(this.suspended){if(this._updateViewNeeded){this._updateViewNeeded=!1;var r=this._isRootNodeVisible();r!==this._layerIsVisible&&(this._layerIsVisible=r,this.notifyChange("suspended")),this._updateLoading()}}else{for(e.run((function(){return t._updateWorkQueues()}));this._indexQueue.length>0&&e.run((function(){return t._processIndexQueue()})););for(this._processWorkQueue(e);this._idleQueue.length>0&&e.run((function(){return t._idleQueue.process()})););}},t.prototype._processIndexQueue=function(){var e=this,t=this._indexQueue.shift(),r=this._loadNodePage(t);return this._indexPagesLoading.set(t,r),r.promise.then((function(r){e._index.addPage(t,r,e._elevationOffset),e._setUpdateViewNeeded()})).then((function(){e._indexPagesLoading.delete(t)}),(function(){e._indexPagesLoading.delete(t)})),!0},t.prototype._processWorkQueue=function(e){for(;!e.done;){var t=this._scheduleWorkEntry();if(d.isNone(t))return;this._processWorkEntry(t),e.madeProgress()}},t.prototype._scheduleWorkEntry=function(){for(var e=this,t=this._workQueue.length;t--;){var r=this._workQueue.shift();if(!n.find(r.remove,(function(t){return!e._renderedNodes.has(t)})))return r;this._workQueue.push(r)}return null},t.prototype._processWorkEntry=function(e){var t=this;if(0!==e.load.length)u.all(e.load.map((function(e){var r=u.createAbortController(),i=t._memCache.pop(e.toString());return d.isSome(i)?t._loadingNodes.set(e,{abortController:r,promise:u.resolve(i)}):t._loadingNodes.has(e)||t._loadingNodes.set(e,{abortController:r,promise:t.loadNode(e,r.signal)}),t._loadingNodes.get(e).promise}))).then((function(r){for(var i=0;i<e.load.length;i++)if(r[i]){var n=t._setupRendererData(e.load[i],r[i]);t._addToRenderer(n)}for(var o=0,a=e.remove;o<a.length;o++){var s=a[o];t._removeFromRenderer(s)}})).catch((function(){})).then((function(){for(var r=0,i=e.load;r<i.length;r++){var n=i[r];t._loadingNodes.delete(n)}t._updateLoading(),t._recalcWork&&0===t._idleQueue.length&&0===t._indexQueue.length&&0===t._loadingNodes.size&&(t._recalcWork=!1,t._setUpdateViewNeeded())})),this._updateLoading();else for(var r=0,i=e.remove;r<i.length;r++){var n=i[r];this._removeFromRenderer(n)}},t.prototype.populateClassCodeCodedDomain=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var i,n,a,s;return r.__generator(this,(function(r){switch(r.label){case 0:return"CLASS_CODE",!(i=this.layer.fieldsIndex.get("CLASS_CODE"))||i.domain?[2]:-1===e.indexOf(i.name)?[2]:[4,o.result(this.layer.queryCachedStatistics("CLASS_CODE",{signal:t}))];case 1:return!1===(n=r.sent()).ok?[2]:(a=n.value,(s=a&&a.labels&&a.labels.labels)&&Array.isArray(s)?(i.domain=new w.CodedValueDomain({name:"CLASS_CODE",codedValues:s.map((function(e){return new b.default({code:e.value,name:e.label})}))}),[2]):[2])}}))}))},t.prototype.prepareFetchPopupFeatures=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t=this;return r.__generator(this,(function(r){return this._codedDomainPopulationPromise||(this._codedDomainPopulationAbortController=u.createAbortController(),this._codedDomainPopulationPromise=this.populateClassCodeCodedDomain(e,this._codedDomainPopulationAbortController.signal).then((function(){t._codedDomainPopulationAbortController=null}))),[2,this._codedDomainPopulationPromise]}))}))},t.prototype.whenGraphicAttributes=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var i,n,a,s,d,l=this;return r.__generator(this,(function(h){switch(h.label){case 0:return i=this._splitGraphicsPerNode(e),n=this.layer.attributeStorageInfo,a=t.map((function(e){return V.getAttributeInfo(n,e)})),s=function(e,t){return r.__awaiter(l,void 0,void 0,(function(){var i,n=this;return r.__generator(this,(function(s){switch(s.label){case 0:return i=this._index.getNode(t),[4,o.forEach(a,(function(t){return r.__awaiter(n,void 0,void 0,(function(){var n,o,a,s,d,u;return r.__generator(this,(function(r){switch(r.label){case 0:return t.useElevation?[4,this._loadElevationAttributeFromGeometry(i.resourceId)]:[3,2];case 1:return o=r.sent(),[3,4];case 2:return[4,this._loadAndParseAttribute(i,t)];case 3:o=r.sent(),r.label=4;case 4:if(!(n=o))return[2];for(a=0,s=e;a<s.length;a++)d=s[a],this._isValidPointGraphic(d)&&(u=d.pointCloudMetadata.attributePointIndexInNode,this._encodeGraphicAttribute(t,n,u,d.attributes));return[2]}}))}))}))];case 1:return s.sent(),[2]}}))}))},d=[],i.forEach((function(e,t){d.push(s(e,t))})),[4,u.eachAlways(d)];case 1:return h.sent(),[2,e]}}))}))},t.prototype._isValidPointGraphic=function(e){return e instanceof R.PointGraphic&&e.pointCloudMetadata&&e.pointCloudMetadata.epoch===this._nodeLoadEpoch},t.prototype._splitGraphicsPerNode=function(e){for(var t=new Map,r=0,i=e;r<i.length;r++){var n=i[r];if(this._isValidPointGraphic(n)){var o=n.pointCloudMetadata,a=t.get(o.nodeId);a?a.push(n):t.set(o.nodeId,[n])}}return t},t.prototype._loadAndParseAttribute=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var i;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,this._loadAttribute(e.resourceId,t,null)];case 1:return i=r.sent(),[2,d.isSome(i)?O.getAttributeValues({attributeInfo:t,buffer:i},null,e.vertexCount):null]}}))}))},t.prototype._loadElevationAttributeFromGeometry=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,i,n,o;return r.__generator(this,(function(r){switch(r.label){case 0:return t=this.layer.store.defaultGeometrySchema,n=O.readGeometry,o=[t],[4,this._loadGeometry(e,null)];case 1:return i=n.apply(void 0,o.concat([r.sent()])),[2,O.elevationFromPositions(i,i.length/3)]}}))}))},t.prototype.highlight=function(e){var t=this;if(!e)return{remove:function(){},pause:function(){},resume:function(){}};var r=a.isCollection(e)?e.toArray():Array.isArray(e)?e:[e];return this._renderer.highlight(r.map((function(e){return t._graphicToPointDefinition(e)})))},t.prototype._graphicToPointDefinition=function(e){if(!this._isValidPointGraphic(e))return null;var t=e.pointCloudMetadata,r=t.nodeId,i=t.pointIndexInNode;return null!=r&&null!=i?{nodeId:r,pointId:i}:null},t.prototype._computeWork=function(){for(var e=0,t=0,r=this._workQueue;t<r.length;t++){var i=r[t];e+=i.load.length+i.remove.length}return e+=this._loadingNodes.size,e+=(this._indexQueue.length+this._indexPagesLoading.size)*this._index.pageSize,e+=this._loadingInitNodePage?100:0,e+=this._updateViewNeeded?100:0},Object.defineProperty(t.prototype,"updatingProgressValue",{get:function(){if(this.suspended)return this._updateViewNeeded?0:1;var e=this._computeWork();return 1-Math.min(this._totalWork,e)/this._totalWork},enumerable:!1,configurable:!0}),t.prototype._updateLoading=function(){this.notifyChange("updating"),this.notifyChange("updatingProgressValue")},t.prototype.canResume=function(){return e.prototype.canResume.call(this)&&this._layerIsVisible},t.prototype.isUpdating=function(){return this.suspended?this._updateViewNeeded:this._computeWork()>0},t.prototype._initNodePages=function(){var e=this,t=this.layer.store.index,r=t.nodesPerPage||t.nodePerIndexBlock;return this._index=new k(this.layer.spatialReference,this.view.renderCoordsHelper.spatialReference,r),this._cancelIndexLoading(),this._traverseVisible=this._index.createVisibilityTraverse(),this._loadingInitNodePage=!0,this._layerIsVisible=!0,this.notifyChange("suspended"),this._updateLoading(),this._pageMultiplier=null!=t.nodesPerPage?1:t.nodePerIndexBlock,this._loadNodePage(0).promise.then((function(t){e._index.addPage(0,t,e._elevationOffset),e._loadingInitNodePage=!1,e._setUpdateViewNeeded()}))},t.prototype._loadNodePage=function(e){var t=this,r=u.createAbortController(),i=this.baseUrl+"/nodepages/"+e*this._pageMultiplier;return{promise:this._requestJSON(i,r.signal).then((function(r){return r.nodes.map((function(r,i){return{resourceId:null!=r.resourceId?r.resourceId:e*t._index.pageSize+i,obb:r.obb,firstChild:r.firstChild,childCount:r.childCount,vertexCount:null!=r.vertexCount?r.vertexCount:r.pointCount,lodThreshold:null!=r.lodThreshold?r.lodThreshold:r.effectiveArea}}))})),abortController:r}},t.prototype._updateWorkQueues=function(){if(!this._updateViewNeeded)return!1;for(var e=this.inverseDensity/this._lodFactor*this._getLodMemoryFactor(),t=this.maximumPointCount*this._lodFactor*this._getLodMemoryFactor(),r=this._computeNodesForMinimumDensity(e),i=this._computePointCount(r),n=Math.sqrt(i/(.75*t));i>t;)e*=n,r=this._computeNodesForMinimumDensity(e),i=this._computePointCount(r),n=Math.sqrt(2);return this.displayNodes(r),this._updateViewNeeded=!1,this._updateLoading(),!0},t.prototype._computePointCount=function(e){for(var t=0,r=0;r<e.length;r++){var i=this._index.getNode(e[r]);i&&(t+=i.vertexCount)}return t},t.prototype._getLodMemoryFactor=function(){return this.view.resourceController.memoryController.memoryFactor},t.prototype._isRootNodeVisible=function(){var e=!1;return this._traverseVisible({frustumPlanes:this.view.state.camera.frustum.planes,clippingBox:this._clippingBox},{predicate:function(t,r,i){return e=i,!1},pageMiss:function(){}}),e},t.prototype._computeNodesForMinimumDensity=function(e){var t=this,r=this.view.state.camera,i=r.frustum,n=this._clippingBox,o=r.viewForward,a=f.vec3.dot(o,r.eye),s=Q.plane.fromNormalAndOffset(o,-a,H),d=r.perScreenPixelRatio/2,u=e*e,l=this._nodeIdArray;l.length=0;var h=E.extractSafeScaleBounds(this.layer),p=h.minScale,c=h.maxScale,_=0===p&&0===c?function(e){return l.push(e)}:function(e){var r=t._getScale(e);E.scaleBoundsPredicate(r,p,c)&&l.push(e)};return this._traverseVisible({frustumPlanes:i.planes,clippingBox:n},{predicate:function(e,r,i){if(!i)return!1;if(0===r.childCount)return _(e),!1;var n=t._index.getRenderObb(e);return!(t._computeAveragePixelArea(n,r.lodThreshold,r.vertexCount,s,d)<=u)||(_(e),!1)},pageMiss:function(e,r){_(e),t._indexQueue.indexOf(r)<0&&t._indexQueue.push(r)}}),l},t.prototype._getScale=function(e){var t=this._nodeScales.get(e);if(null==t){var r=this._index.getNode(e).obb.center;this._tmpPoint.x=r[0],this._tmpPoint.y=r[1],this._tmpPoint.z=r[2],t=this.view.basemapTerrain.getScale(this._tmpPoint),this._nodeScales.set(e,t)}return t},t.prototype._computeAveragePixelArea=function(e,t,r,i,n){var o=Math.max(1e-7,z.minimumDistancePlane(e,i));return t/(o*o)/(4*n*n)/r},t.prototype.loadNode=function(e,t){try{return this.loadNodeAsync(e,t)}catch(e){throw u.isAbortError(e)||G.error(e),e}},t.prototype.loadAdditionalUserAttributes=function(e,t,i){return r.__awaiter(this,void 0,void 0,(function(){var n,o,a,s,l,p,c,_,f,g;return r.__generator(this,(function(r){switch(r.label){case 0:if(!(n=this.layer.outFields))return[2,[]];for(o=P.unpackFieldNames(this.layer.fields,n),a=h.SetFromValues(e.map((function(e){return d.isSome(e)?e.name:null}))),s=this.layer.attributeStorageInfo,l=[],p=0,c=o;p<c.length;p++)_=c[p],a.has(_)||(f=V.getAttributeInfo(s,_))&&l.push(t(f));return[4,u.eachAlwaysValues(l)];case 1:return g=r.sent(),u.throwIfAborted(i),[2,d.mapSome(g,(function(e){return e}))]}}))}))},t.prototype.loadNodeAsync=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var i,n,o,a,s,l=this;return r.__generator(this,(function(h){return i=this._index.getNode(e),n=V.getRendererInfo(this.layer),o=V.getFilterInfo(this.layer),a=i.resourceId,s=function(e){return r.__awaiter(l,void 0,void 0,(function(){var i;return r.__generator(this,(function(r){switch(r.label){case 0:return d.isNone(e)?[2,null]:e.useElevation?[2,{attributeInfo:e,buffer:null}]:[4,this._loadAttribute(a,e,t)];case 1:return i=r.sent(),[2,d.isSome(i)?{attributeInfo:e,buffer:i}:null]}}))}))},[2,this._idleQueue.push((function(){return r.__awaiter(l,void 0,void 0,(function(){var i,d,l,h,p,c,_,f,g,y,m,v,b,w,P;return r.__generator(this,(function(N){switch(N.label){case 0:return i=this._loadGeometry(a,t),d=n.primaryAttribute,l=n.modulationAttribute,h=s(d),p=s(l),c=o.map((function(e){return e.attributeInfo})),_=c.map((function(e){return s(e)})),f=this.loadAdditionalUserAttributes(r.__spreadArrays([d,l],c),s,t),[4,u.all([i,h,p,u.all(_),f])];case 1:return g=N.sent(),y=g[0],m=g[1],v=g[2],b=g[3],w=g[4],u.throwIfAborted(t),P={geometryBuffer:y,primaryAttributeData:m,modulationAttributeData:v,filterAttributesData:b,userAttributesData:w,schema:this.layer.store.defaultGeometrySchema,rendererInfo:n,filterInfo:o,obb:this._index.getRenderObb(e),elevationOffset:this._elevationOffset,inSR:this.layer.spatialReference.toJSON(),outSR:this.view.renderCoordsHelper.spatialReference.toJSON()},[2,this._worker.invoke(P,t)]}}))}))}))]}))}))},t.prototype._loadGeometry=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(r){return[2,this._requestBinary(this.baseUrl+"/nodes/"+e+"/geometries/0",t)]}))}))},t.prototype._loadAttribute=function(e,t,i){return r.__awaiter(this,void 0,void 0,(function(){var n;return r.__generator(this,(function(r){return d.isNone(t)||!t.storageInfo?[2,null]:(n=t.storageInfo.key,[2,this._requestBinary(this.baseUrl+"/nodes/"+e+"/attributes/"+n,i)])}))}))},t.prototype._requestJSON=function(e,t){return this._streamDataRequester.request(e,"json",{query:{f:"json"},signal:t})},t.prototype._requestBinary=function(e,t){return this._streamDataRequester.request(e,"binary",{signal:t})},t.prototype._removeFromRenderer=function(e){if(this._renderedNodes.has(e)){var t=this._renderer.removeNode(e);this._renderedNodes.delete(e),this._nodeScales.delete(e),this._memCache.put(t.id.toString(),t,function(e){return 5*e.coordinates.length+128}(t))}},t.prototype._addToRenderer=function(e){this._renderedNodes.has(e.id)||(this._renderedNodes.add(e.id),this._renderer.addNode(e))},t.prototype._setupRendererData=function(e,t){var r=this._index.getNode(e),i=Math.sqrt(r.lodThreshold/r.vertexCount),n=this._index.getRenderObb(e);if(L.PointRenderer.isInstanceOfNode(t))return t.splatSize=i,t.obb=n,t.origin=g.vec3f32.clone(t.obb.center),t;if(t.obb.halfSize[0]>1.001*n.halfSize[0]||t.obb.halfSize[1]>1.001*n.halfSize[1]||t.obb.halfSize[2]>1.001*n.halfSize[2]){if(this._maxLoggedBoxWarnings>0){var o=function(e){return"["+e.halfSize[0]+", "+e.halfSize[1]+", "+e.halfSize[2]+"]"};G.warn("Node "+e+" reported bounding box too small. got "+o(n)+" but points cover "+o(t.obb)),0==--this._maxLoggedBoxWarnings&&G.warn("  Too many bounding box errors, stopping reporting for this layer.")}this._index.setRenderObb(e,t.obb)}return{id:e,coordinates:t.points,origin:g.vec3f32.clone(n.center),rgb:t.rgb,attributes:t.attributes,pointIdFilterMap:t.pointIdFilterMap,highlights:null,splatSize:i,obb:n,isLeaf:0===r.childCount}},t.prototype.getUsedMemory=function(){var e=0;return this._renderer.forEachNode((function(t){e+=j,e+=p.estimateSize(t.coordinates);for(var r=0,i=t.attributes;r<i.length;r++){var n=i[r].values;p.isArrayBuffer(n.buffer)&&(e+=p.estimateSize(n))}})),e},t.prototype.getUnloadedMemory=function(){var e=this,t=this._renderedNodes.size;if(t<4)return 0;for(var r=i.keysOfSet(this._renderedNodes).reduce((function(t,r){return t+e._index.getNode(r).vertexCount})),n=this._loadingNodes.size,o=0;o<this._workQueue.length;o++)n+=this._workQueue[o].load.length,n-=this._workQueue[o].remove.length;return n<0?0:n*r/t*((this.getUsedMemory()-t*j)/r)+n*j},t.prototype.ignoresMemoryFactor=function(){return!1},Object.defineProperty(t.prototype,"performanceInfo",{get:function(){var e=this;return{nodes:this._renderedNodes.size,displayedNumberOfFeatures:i.keysOfSet(this._renderedNodes).reduce((function(t,r){return t+e._index.getNode(r).vertexCount}),0),maximumNumberOfFeatures:this.maximumPointCount,totalNumberOfFeatures:-1,core:null,"Loading Nodes":this._loadingNodes.size,"Index Queue":this._indexQueue.length,"Work Queue":this._workQueue.length,"Idle Queue":this._idleQueue.length}},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"test",{get:function(){return{index:this._index,visibleNodes:this._renderedNodes}},enumerable:!1,configurable:!0}),r.__decorate([_.property()],t.prototype,"layer",void 0),r.__decorate([_.property({readOnly:!0,aliasOf:"layer.parsedUrl.path"})],t.prototype,"baseUrl",void 0),r.__decorate([_.property({readOnly:!0,dependsOn:["layer.renderer"]})],t.prototype,"pointScale",null),r.__decorate([_.property({readOnly:!0,dependsOn:["layer.renderer"]})],t.prototype,"useRealWorldSymbolSizes",null),r.__decorate([_.property({readOnly:!0,dependsOn:["layer.renderer"]})],t.prototype,"pointSize",null),r.__decorate([_.property({readOnly:!0,dependsOn:["layer.renderer"]})],t.prototype,"inverseDensity",null),r.__decorate([_.property()],t.prototype,"maximumPointCount",void 0),r.__decorate([_.property({readOnly:!0,dependsOn:["layer.renderer","layer.filters","layer.outFields"]})],t.prototype,"availableFields",null),r.__decorate([_.property({readOnly:!0,dependsOn:["view.clippingArea"]})],t.prototype,"_clippingBox",null),r.__decorate([_.property({readOnly:!0,dependsOn:["layer.elevationInfo"]})],t.prototype,"_elevationOffset",null),r.__decorate([_.property({type:Boolean})],t.prototype,"slicePlaneEnabled",void 0),r.__decorate([_.property()],t.prototype,"updating",void 0),r.__decorate([_.property(U.updatingProgress)],t.prototype,"updatingProgress",void 0),r.__decorate([_.property({readOnly:!0,dependsOn:["suspended"]})],t.prototype,"updatingProgressValue",null),t=r.__decorate([_.subclass("esri.views.3d.layers.PointCloudLayerView3D")],t)}(F.PopupSceneLayerView(S.LayerView3D(M)));var T=m.create(),j=160;return q}));