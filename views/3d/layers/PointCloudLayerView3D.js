// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/extendsHelper","../../../core/tsSupport/decorateHelper","../../../core/accessorSupport/decorators","../../../core/HandleRegistry","../../../core/watchUtils","../../../core/promiseUtils","../../../core/Logger","../../../core/screenUtils","../../../geometry/support/scaleUtils","../../../symbols/support/unitConversionUtils","../../../request","../support/projectionUtils","../support/orientedBoundingBox","./LayerView3D","./support/LayerViewUpdatingPercentage","../lib/glMatrix","./i3s/I3SBinaryReader","./i3s/I3SUtil","./i3s/PointCloudRendererUtil","./i3s/PointRenderer","./i3s/PagedNodeIndex","./i3s/LoDUtil","./i3s/LEPCC","./i3s/IdleQueue","dojo/promise/all","dojo/errors/CancelError","../webgl-engine/lib/RenderSlot"],function(e,t,r,n,i,o,d,s,a,u,l,p,h,c,_,f,g,y,v,m,x,b,w,N,P,S,I,C,R){function O(e){var t=[];return e.forEach(function(e){return t.push(e)}),t}var k=a.getLogger("esri.views.3d.layers.PointCloudLayerView3D"),Q=8,L=8,V=y.vec4d.create(),F=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.maximumPointCount=4e6,t._renderer=null,t._rendererAdded=!1,t._renderedNodes=new Set,t._updateViewNeeded=!0,t._idleUpdatesEnabled=!0,t._lodFactor=1,t._handles=new o,t._indexQueue=[],t._workQueue=[],t._idleQueue=new S.IdleQueue,t._indexPagesLoading=new Map,t._loadingNodes=new Map,t._layerIsVisible=!1,t._totalWork=0,t._index=null,t._loadingInitNodePage=!1,t._nodeIdArray=[],t}return r(t,e),Object.defineProperty(t.prototype,"pointScale",{get:function(){var e=x.getSplatSizeAlgorithm(this.layer.renderer),t=1;return e&&null!=e.scaleFactor?e.scaleFactor:t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"pointMinSize",{get:function(){return x.getMinSize(this.layer.renderer)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"useRealWorldSymbolSizes",{get:function(){var e=x.getFixedSizeAlgorithm(this.layer.renderer),t=!1;return e&&null!=e.useRealWorldSymbolSizes?e.useRealWorldSymbolSizes:t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"pointSize",{get:function(){var e=x.getFixedSizeAlgorithm(this.layer.renderer),t=0;return e&&null!=e.size?e.size:t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"inverseDensity",{get:function(){var e=96;return this.layer.renderer?1*e/this.layer.renderer.pointsPerInch:5},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"_clippingBox",{get:function(){var e=[],t=this.view.renderSpatialReference;return c.extentToBoundingBox(this.view.clippingArea,e,t)?e:null},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"_elevationOffset",{get:function(){var e=this.layer.elevationInfo;if(e&&"absolute-height"===e.mode){var t=l.getMetersPerVerticalUnitForSR(this.layer.spatialReference),r=p.getMetersPerUnit(e.unit);return(e.offset||0)*r/t}return 0},enumerable:!0,configurable:!0}),t.prototype.initialize=function(){var e=this;m.checkPointCloudLayerValid(this.layer),m.checkPointCloudLayerCompatibleWithView(this.layer,this.view),this._initRenderer();var t=this._initNodePages(),r={idleBegin:function(){return e._idleBegin()},idleEnd:function(){return e._idleEnd()},needsUpdate:function(){return!0},idleFrame:function(t){return e._idleFrame(t)}},n={idleBegin:function(){return e._idleBegin()},idleEnd:function(){return e._idleEnd()},needsUpdate:function(){return e._updateViewNeeded||e._workQueue.length>0},idleFrame:function(t){return e._idleFrameWhileSuspended(t)}};t.then(function(){e._handles.add(d.init(e,"suspended",function(t){t?(e.view.resourceController.deregisterIdleFrameWorker(e),e.view.resourceController.registerIdleFrameWorker(e,n)):(e.view.resourceController.deregisterIdleFrameWorker(e),e.view.resourceController.registerIdleFrameWorker(e,r))}))}),this._handles.add(d.init(this,"_clippingBox",function(){return e._updateViewNeeded=!0})),this._handles.add(d.init(this.layer,"elevationInfo",function(){return e._elevationInfoChanged()})),this._handles.add(d.init(this,"_elevationOffset",function(){return e._elevationOffsetChanged()})),this._handles.add(d.init(this.layer,"renderer",function(){return e._rendererChanged()})),this.addResolvingPromise(t)},t.prototype.destroy=function(){this.view.resourceController.deregisterIdleFrameWorker(this),this._handles.destroy(),this._destroyRenderer()},t.prototype._initRenderer=function(){var e=this;this._renderer=new b,this._renderer.layerUid=this.layer.uid,this._handles.add(d.init(this,"_clippingBox",function(t){e._renderer.clippingBox=t})),this._handles.add(d.init(this,"_clippingBox",function(t){e._renderer.clippingBox=t})),this._handles.add(d.init(this,"suspended",function(t){e._setPointsVisible(!t)})),this._handles.add(d.init(this,"pointScale",function(t){e._renderer.scaleFactor=t})),this._handles.add(d.init(this,"pointMinSize",function(t){var r=u.pt2px(t);e._renderer.minSizePx=r})),this._handles.add(d.init(this,"useRealWorldSymbolSizes",function(t){e._renderer.useRealWorldSymbolSizes=t})),this._handles.add(d.init(this,"pointSize",function(t){var r=u.pt2px(t);e._renderer.size=t,e._renderer.sizePx=r})),this._handles.add(d.init(this,["inverseDensity","maximumPointCount"],function(){e._updateViewNeeded=!0})),this._handles.add(d.init(this.view,"qualitySettings.sceneService.pointCloud.lodFactor",function(t){e._lodFactor=t,e._updateViewNeeded=!0}))},t.prototype._destroyRenderer=function(){this._setPointsVisible(!1)},t.prototype._setPointsVisible=function(e){e&&!this._rendererAdded?(this.view._stage.addExternalRenderer([R.OPAQUE_EXTERNAL],this._renderer),this._rendererAdded=!0):!e&&this._rendererAdded&&(this.view._stage.removeExternalRenderer(this._renderer),this._rendererAdded=!1)},t.prototype._rendererChanged=function(){this._clearNodeState(),this._renderer.useFixedSizes=x.rendererUsesFixedSizes(this.layer.renderer),this._updateViewNeeded=!0},t.prototype._elevationInfoChanged=function(){var e=this.layer.elevationInfo&&this.layer.elevationInfo.unit;e&&!p.supportsUnit(e)&&k.warn("elevationInfo.unit","'"+e+"' is not a valid unit")},t.prototype._elevationOffsetChanged=function(){var e=this;this._clearNodeState(),this._initNodePages().then(function(){e._updateViewNeeded=!0})},t.prototype.displayNodes=function(e){this._cancelNodeLoading(),this._workQueue=N.nodeDiff(O(this._renderedNodes),e,this._index),N.sortFrontToBack(this._workQueue,this.view.state.camera.viewForward,this._index),this._totalWork=this._computeWork(),this._updateLoading(),this._layerIsVisible=e.length>0,this.notifyChange("suspended")},t.prototype.cancelLoading=function(){this._cancelNodeLoading(),this._cancelIndexLoading()},t.prototype._cancelNodeLoading=function(){var e=[];this._loadingNodes.forEach(function(t){return e.push(t)}),this._loadingNodes.clear();for(var t=0,r=e;t<r.length;t++){var n=r[t];n.cancel()}this._workQueue=[],this._idleQueue.cancelAll(),this._totalWork=this._computeWork(),this._updateLoading()},t.prototype._cancelIndexLoading=function(){this._indexQueue=[],this._indexPagesLoading.forEach(function(e){return e.cancel()}),this._indexPagesLoading.clear(),this._totalWork=this._computeWork(),this._updateLoading()},t.prototype._clearNodeState=function(){var e=this;this._renderedNodes.forEach(function(t){return e._removeFromRenderer(t)}),this._cancelNodeLoading()},t.prototype._idleBegin=function(){this._idleUpdatesEnabled&&(this._updateViewNeeded=!1,this.updateViewWhenIdle())},t.prototype._idleEnd=function(){this.cancelLoading()},t.prototype._idleFrame=function(e){if(this._idleUpdatesEnabled){for(this._updateViewNeeded&&!e.done()&&(this._updateViewNeeded=!1,this.updateViewWhenIdle());this._indexQueue.length>0&&!e.done();)this._processIndexQueue();for(;this._workQueue.length>0&&this._canSchedule(this._workQueue[0])&&!e.done();)this._processWorkQueue();for(;this._idleQueue.length()>0&&!e.done();)this._idleQueue.process()}},t.prototype._idleFrameWhileSuspended=function(e){if(this._idleUpdatesEnabled)for(this._updateViewNeeded&&!e.done()&&(this._updateViewNeeded=!1,this.updateViewWhenIdle());this._workQueue.length>0&&!e.done();)this._processWorkQueueRemoveOnly()},t.prototype._processIndexQueue=function(){var e=this,t=this._indexQueue.shift();this._indexPagesLoading.set(t,this._loadNodePage(t)),this._indexPagesLoading.get(t).then(function(r){e._index.addPage(t,r,e._elevationOffset),e._updateViewNeeded=!0}).always(function(){e._indexPagesLoading["delete"](t)})},t.prototype._canSchedule=function(e){if(this._loadingNodes.size>=L)return!1;for(var t=0;t<e.remove.length;t++)if(!this._renderedNodes.has(e.remove[t]))return!1;return!0},t.prototype._processWorkQueue=function(){var e=this,t=this._workQueue.shift();if(0!==t.load.length){var r=t.load.length>Q&&1===t.remove.length;if(r){var n=N.splitWorkEntry(t,this._index);t=n[0];for(var i=1;i<n.length;i++)this._workQueue.push(n[i])}I(t.load.map(function(t){return e._loadingNodes.has(t)||e._loadingNodes.set(t,e.loadNode(t)),e._loadingNodes.get(t)})).then(function(r){for(var n=0;n<t.load.length;n++)e._addToRenderer(t.load[n],r[n]);for(var n=0;n<t.remove.length;n++)e._removeFromRenderer(t.remove[n])}).always(function(){for(var r=0;r<t.load.length;r++)e._loadingNodes["delete"](t.load[r]);e._updateLoading()}),this._updateLoading()}else for(var i=0;i<t.remove.length;i++)this._removeFromRenderer(t.remove[i])},t.prototype._processWorkQueueRemoveOnly=function(){for(var e=this._workQueue.shift(),t=0;t<e.remove.length;t++)this._removeFromRenderer(e.remove[t]);this._updateLoading()},t.prototype._computeWork=function(){for(var e=0,t=0;t<this._workQueue.length;t++)e+=this._workQueue[t].load.length;return e+=this._loadingNodes.size,e+=(this._indexQueue.length+this._indexPagesLoading.size)*this._index.pageSize,e+=this._loadingInitNodePage?100:0,e+=this._updateViewNeeded?100:0},Object.defineProperty(t.prototype,"updating",{get:function(){var e=this._computeWork();return e>0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updatingPercentageValue",{get:function(){var e=this._computeWork();return 100*Math.max(0,this._totalWork-e)/this._totalWork},enumerable:!0,configurable:!0}),t.prototype._updateLoading=function(){this.notifyChange("updating"),this.notifyChange("updatingPercentageValue")},t.prototype.canResume=function(){return this.inherited(arguments)&&this._layerIsVisible},t.prototype._initNodePages=function(){var e=this;return this._index=new w(this.layer.spatialReference,this.view.renderCoordsHelper.spatialReference,this.layer.store.index.nodePerIndexBlock),this._cancelIndexLoading(),this._traverseVisible=this._index.createVisibilityTraverse(),this._loadingInitNodePage=!0,this._updateLoading(),this._loadNodePage(0).then(function(t){e._index.addPage(0,t,e._elevationOffset),e._loadingInitNodePage=!1,e._updateLoading()})},t.prototype._loadNodePage=function(e){var t=e*this._index.pageSize,r=this.baseUrl+"/nodepages/"+t;return this._requestJSON(r).then(function(e){return e.data.nodes})},t.prototype.updateViewWhenIdle=function(){for(var e=this.inverseDensity/this._lodFactor,t=this.maximumPointCount*this._lodFactor,r=this._computeNodesForMinimumDensity(e),n=this._computePointCount(r),i=Math.sqrt(n/(.75*t));n>t;)e*=i,r=this._computeNodesForMinimumDensity(e),n=this._computePointCount(r),i=Math.sqrt(2);this.displayNodes(r)},t.prototype._computePointCount=function(e){for(var t=0,r=0;r<e.length;r++){var n=this._index.getNode(e[r]);n&&(t+=n.pointCount)}return t},t.prototype._computeNodesForMinimumDensity=function(e){var t=this,r=this.view.state.camera,n=r.frustumPlanes,i=this._clippingBox,o=r.viewForward,d=y.vec3d.dot(o,r.eye),s=y.vec4d.set4(o[0],o[1],o[2],-d,V),a=r.perPixelRatio,u=e*e,l=this._nodeIdArray;return l.length=0,this._traverseVisible({frustumPlanes:n,clippingBox:i},{predicate:function(e,r,n){if(!n)return!1;if(0===r.childCount)return l.push(e),!1;var i=t._index.getRenderObb(e),o=t._computeAveragePixelArea(i,r.effectiveArea,r.pointCount,s,a);return u>=o?(l.push(e),!1):!0},pageMiss:function(e,r){l.push(e),t._indexQueue.indexOf(r)<0&&t._indexQueue.push(r)}}),l},t.prototype._computeAveragePixelArea=function(e,t,r,n,i){var o=1e-7,d=Math.max(o,_.minimumDistancePlane(e,n)),s=t/(d*d)/(4*i*i);return s/r},t.prototype.loadNode=function(e){var t=this,r=this._index.getNode(e),n=x.getRendererInfo(this.layer),i=[];return this._idleQueue.push().then(function(){var o=null!=r.resourceId?r.resourceId:e,d=t.loadGeometry(o),s=t.loadAttribute(o,n.primaryAttribute),a=t.loadAttribute(o,n.modulationAttribute);return i=[d,s,a],I(i)}).then(function(e){var i=e[0],o=e[1],d=e[2],s=t.layer.store.defaultGeometrySchema,a=t.readGeometry(s,i),u=x.evaluateRenderer(n,o,d,a,r.pointCount);return t._idleQueue.push().then(function(){return{positions:a,rgb:u}})}).then(function(r){var n=r.positions,i=r.rgb,o=y.vec3.create(t._index.getRenderCenter(e));t._applyElevationOffsetInPlace(n,t._elevationOffset);var d=t._transformCoordinates(n,o),s={origin:d.origin,points:d.points,rgb:i};return s}).otherwise(function(e){if(e instanceof C)for(var t=0,r=i;t<r.length;t++){var n=r[t];n.cancel()}return s.reject(e)})},t.prototype.readGeometry=function(e,t){if(null==e.encoding||""===e.encoding){for(var r=v.createGeometryDataIndex(t,e,!1),n=v.createTypedView(t,r.vertexAttributes.position),i=r.header.fields,o=[i.offsetX,i.offsetY,i.offsetZ],d=[i.scaleX,i.scaleY,i.scaleZ],s=n.length/3,a=new Float64Array(3*s),u=0;s>u;u++)a[3*u]=n[3*u]*d[0]+o[0],a[3*u+1]=n[3*u+1]*d[1]+o[1],a[3*u+2]=n[3*u+2]*d[2]+o[2];return a}return"lepcc-xyz"===e.encoding?P.decodeXYZ(t).result:void 0},t.prototype.loadGeometry=function(e){var t=this.baseUrl+"/nodes/"+e+"/geometries/0";return this._requestBinary(t).then(function(e){return e.data})},t.prototype.loadAttribute=function(e,t){if(!t||!t.storageInfo)return s.resolve(null);var r=t.storageInfo.key,n=this.baseUrl+"/nodes/"+e+"/attributes/"+r;return this._requestBinary(n).then(function(e){return e.data})},t.prototype._requestJSON=function(e){return h(e,{query:{f:"json"},responseType:"json"})},t.prototype._requestBinary=function(e){return h(e,{responseType:"array-buffer"})},t.prototype._removeFromRenderer=function(e){this._renderedNodes.has(e)&&(this._renderer.removeNode(""+e),this._renderedNodes["delete"](e))},t.prototype._addToRenderer=function(e,t){if(!this._renderedNodes.has(e)){this._renderedNodes.add(e);var r=this._index.getNode(e),n=this._index.getRenderObb(e),i=Math.sqrt(r.effectiveArea/r.pointCount);this._renderer.addNode({id:""+e,coordinates:t.points,origin:t.origin,rgb:t.rgb,splatSize:i,obb:n,isLeaf:0===r.childCount})}},t.prototype._transformCoordinates=function(e,t){var r=e.length/3,n=this.layer.spatialReference,i=this.view.renderCoordsHelper.spatialReference;if(!c.bufferToBuffer(e,n,0,e,i,0,r))throw Error("Can't reproject");for(var o=new Float32Array(3*r),d=0;r>d;d++)o[3*d]=e[3*d]-t[0],o[3*d+1]=e[3*d+1]-t[1],o[3*d+2]=e[3*d+2]-t[2];return{points:o,origin:t}},t.prototype._applyElevationOffsetInPlace=function(e,t){var r=e.length/3;if(0!==t)for(var n=0;r>n;n++)e[3*n+2]+=t},t.prototype.getStats=function(){var e=this;return{"Rendered Nodes":this._renderedNodes.size,"Rendered Points":O(this._renderedNodes).reduce(function(t,r){return t+e._index.getNode(r).pointCount},0),"Loading Nodes":this._loadingNodes.size,"Index Queue":this._indexQueue.length,"Work Queue":this._workQueue.length}},n([i.property()],t.prototype,"layer",void 0),n([i.property({readOnly:!0,aliasOf:"layer.parsedUrl.path"})],t.prototype,"baseUrl",void 0),n([i.property({readOnly:!0,dependsOn:["layer.renderer"]})],t.prototype,"pointScale",null),n([i.property({readOnly:!0,dependsOn:["layer.renderer"]})],t.prototype,"pointMinSize",null),n([i.property({readOnly:!0,dependsOn:["layer.renderer"]})],t.prototype,"useRealWorldSymbolSizes",null),n([i.property({readOnly:!0,dependsOn:["layer.renderer"]})],t.prototype,"pointSize",null),n([i.property({readOnly:!0,dependsOn:["layer.renderer"]})],t.prototype,"inverseDensity",null),n([i.property()],t.prototype,"maximumPointCount",void 0),n([i.property({readOnly:!0,dependsOn:["view.clippingArea"]})],t.prototype,"_clippingBox",null),n([i.property({readOnly:!0,dependsOn:["layer.elevationInfo"]})],t.prototype,"_elevationOffset",null),n([i.property()],t.prototype,"updating",null),n([i.property()],t.prototype,"updatingPercentageValue",null),t=n([i.subclass("esri.views.3d.layers.PointCloudLayerView3D")],t)}(i.declared(f,g));return F});