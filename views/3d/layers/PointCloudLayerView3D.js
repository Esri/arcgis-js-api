// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../request","../../../core/arrayUtils","../../../core/arrayUtils","../../../core/Logger","../../../core/promiseUtils","../../../core/screenUtils","../../../core/unitUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f32","../../../geometry/support/aaBoundingBox","../../../geometry/support/aaBoundingRect","../../../layers/graphics/dehydratedFeatures","../../../layers/support/PromiseQueue","../../../symbols/support/unitConversionUtils","./LayerView3D","./PointCloudWorker","./i3s/I3SUtil","./i3s/LoDUtil","./i3s/PagedNodeIndex","./i3s/PointCloudRendererUtil","./i3s/PointRenderer","./support/layerViewUpdatingProperties","../support/geometryUtils","../support/orientedBoundingBox","../support/projectionUtils","../../support/layerViewUtils"],function(e,t,r,i,n,o,s,a,d,u,l,h,p,c,_,f,g,y,m,v,b,x,N,w,P,S,C,k,V,Q,R,O){function U(e){return 5*e.coordinates.length+128}var z=a.getLogger("esri.views.3d.layers.PointCloudLayerView3D"),L=V.plane.create(),I=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.maximumPointCount=4e6,t.slicePlaneEnabled=!1,t._renderer=null,t._rendererAdded=!1,t._renderedNodes=new Set,t._nodeScales=new Map,t._updateViewNeeded=!0,t._lodFactor=1,t._worker=new x.PointCloudWorker,t._maxLoggedBoxWarnings=5,t._pageMultiplier=1,t._indexQueue=[],t._workQueue=[],t._idleQueue=new m.PromiseQueue,t._indexPagesLoading=new Map,t._loadingNodes=new Map,t._layerIsVisible=!1,t._totalWork=0,t._index=null,t._loadingInitNodePage=!1,t._nodeIdArray=[],t}return r(t,e),Object.defineProperty(t.prototype,"pointScale",{get:function(){var e=S.getSplatSizeAlgorithm(this.layer.renderer);return e&&null!=e.scaleFactor?e.scaleFactor:1},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"useRealWorldSymbolSizes",{get:function(){var e=S.getFixedSizeAlgorithm(this.layer.renderer);return!(!e||null==e.useRealWorldSymbolSizes)&&e.useRealWorldSymbolSizes},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"pointSize",{get:function(){var e=S.getFixedSizeAlgorithm(this.layer.renderer);return e&&null!=e.size?e.size:0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"inverseDensity",{get:function(){return this.layer.renderer?96/this.layer.renderer.pointsPerInch:5},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"_clippingBox",{get:function(){var e=f.create(),t=this.view.renderSpatialReference;return R.extentToBoundingBox(this.view.clippingArea,e,t)?e:null},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"_elevationOffset",{get:function(){var e=this.layer.elevationInfo;if(e&&"absolute-height"===e.mode){var t=l.getMetersPerVerticalUnitForSR(this.layer.spatialReference),r=v.getMetersPerUnit(e.unit);return(e.offset||0)*r/t}return 0},enumerable:!0,configurable:!0}),t.prototype.initialize=function(){var e=this;this._tmpPoint=y.makeDehydratedPoint(0,0,0,this.layer.spatialReference),N.checkPointCloudLayerValid(this.layer),N.checkPointCloudLayerCompatibleWithView(this.layer,this.view),this._initRenderer();var t=this._initNodePages(),r=this.view.resourceController.memoryController;this._memCache=r.getMemCache(this.layer.uid),this.handles.add([h.init(this,"_clippingBox",function(){return e._setUpdateViewNeeded()}),h.init(this,"_elevationOffset",function(){return e._elevationOffsetChanged()}),h.init(this.layer,"renderer",function(){return e._rendererChanged()}),h.init(this.layer,"filters",function(){return e._filterChanged()}),this.view.basemapTerrain.on("scale-change",function(t){return e._scaleUpdateHandler(t)}),this.layer.watch(["minScale","maxScale"],function(){return e._setUpdateViewNeeded()}),h.init(this,"clippingArea",function(){e._setUpdateViewNeeded()}),this.view.state.watch("camera",function(){return e._setUpdateViewNeeded()}),r.events.on("quality-changed",function(){return e._setUpdateViewNeeded()})]),this.addResolvingPromise(t);var i=this.view.resourceController.scheduler;this.when(function(){e.handles.add([i.registerTask(2,function(t){return e._process(t)},function(){return e._needsUpdate()}),i.registerIdleStateCallbacks(function(){return e._idleBegin()},function(){return e._idleEnd()}),h.init(e,"suspended",function(t){t?e._clearNodeState():e._setUpdateViewNeeded()})])})},t.prototype._setUpdateViewNeeded=function(){this._updateViewNeeded=!0,this._updateLoading()},t.prototype.destroy=function(){this.cancelLoading(),this._worker.destroy(),this._worker=null,this._destroyRenderer(),this._memCache.destroy(),this._memCache=null},t.prototype._initRenderer=function(){var e=this;this._renderer=new C,this._renderer.layerUid=this.layer.uid,this.handles.add(h.init(this,"_clippingBox",function(t){return e._renderer.clippingBox=t})),this.handles.add(h.init(this,"suspended",function(t){return e._setPointsVisible(!t)})),this.handles.add(h.init(this,"pointScale",function(t){return e._renderer.scaleFactor=t})),this._renderer.minSizePx=Math.sqrt(2),this.handles.add(h.init(this,"useRealWorldSymbolSizes",function(t){return e._renderer.useRealWorldSymbolSizes=t})),this.handles.add(h.init(this,"pointSize",function(t){var r=u.pt2px(t);e._renderer.size=t,e._renderer.sizePx=r})),this.handles.add(h.init(this,"slicePlaneEnabled",function(t){return e._renderer.slicePlaneEnabled=t})),this.handles.add(h.init(this,["inverseDensity","maximumPointCount"],function(){return e._setUpdateViewNeeded()})),this.handles.add(h.init(this.view,"qualitySettings.sceneService.pointCloud.lodFactor",function(t){e._lodFactor=t,e._setUpdateViewNeeded()}))},t.prototype._destroyRenderer=function(){this._renderer.removeAll(),this._setPointsVisible(!1)},t.prototype._setPointsVisible=function(e){e&&!this._rendererAdded?(this.view._stage.addRenderPlugin([6],this._renderer),this._rendererAdded=!0):!e&&this._rendererAdded&&(this.view._stage.removeRenderPlugin(this._renderer),this._rendererAdded=!1)},t.prototype._rendererChanged=function(){this._clearNodeState(),this._memCache.clear(),this._renderer.useFixedSizes=S.rendererUsesFixedSizes(this.layer.renderer),this._setUpdateViewNeeded()},t.prototype._filterChanged=function(){this._clearNodeState(),this._memCache.clear(),this._setUpdateViewNeeded()},t.prototype._elevationOffsetChanged=function(){this._clearNodeState(),this._memCache.clear(),this._initNodePages()},t.prototype._scaleUpdateHandler=function(e){var t=this;if(!this.layer.minScale&&!this.layer.maxScale)return void this._nodeScales.clear();R.boundingRectToBoundingRect(e.extent,e.spatialReference,W,this.layer.spatialReference)&&(this._nodeScales.forEach(function(r,i){if(!t._renderedNodes.has(i))return void t._nodeScales.delete(i);var n=t._index.getNode(i);g.containsPoint(W,n.obb.center)&&t._nodeScales.set(i,e.scale)}),this._setUpdateViewNeeded())},t.prototype.displayNodes=function(e){this._workQueue=w.nodeDiff(o.keysOfSet(this._renderedNodes),e,this._index),w.sortFrontToBack(this._workQueue,this.view.state.camera.viewForward,this._index),w.splitWorkEntries(this._workQueue,8,this._index),this._updateQueues(),this._totalWork=this._computeWork(),this._updateLoading(),this._layerIsVisible=e.length>0||this._loadingInitNodePage,this.notifyChange("suspended")},t.prototype.cancelLoading=function(){this._cancelNodeLoading(),this._cancelIndexLoading()},t.prototype._cancelNodeLoading=function(){var e=[];this._loadingNodes.forEach(function(t){var r=t.abortController;return e.push(r)}),this._loadingNodes.clear();for(var t=0,r=e;t<r.length;t++){r[t].abort()}this._workQueue=[],this._idleQueue.cancelAll(),this._totalWork=this._computeWork(),this._updateLoading()},t.prototype._updateQueues=function(){var e=this,t=new Set;this._workQueue.forEach(function(e){e.load.forEach(function(e){t.add(e)})});var r=[],i=new Map;this._loadingNodes.forEach(function(e,n){t.has(n)?i.set(n,e):r.push(e)}),this._loadingNodes=i;for(var n=0,o=r;n<o.length;n++){o[n].abortController.abort()}this._workQueue=this._workQueue.filter(function(t){for(var r=0,i=t.load;r<i.length;r++){var n=i[r];if(e._loadingNodes.has(n))return!1}return!0}),this._totalWork=this._computeWork(),this._updateLoading()},t.prototype._cancelIndexLoading=function(){this._indexQueue=[],this._indexPagesLoading.forEach(function(e){return e.abortController.abort()}),this._indexPagesLoading.clear(),this._totalWork=this._computeWork(),this._updateLoading()},t.prototype._clearNodeState=function(){var e=this;this._renderedNodes.forEach(function(t){return e._removeFromRenderer(t)}),this._cancelNodeLoading()},t.prototype._idleBegin=function(){this._setUpdateViewNeeded()},t.prototype._idleEnd=function(){this._setUpdateViewNeeded()},t.prototype._needsUpdate=function(){return this.suspended?this._updateViewNeeded:this._updateViewNeeded||this._indexQueue.length>0||this._workQueue.length>0||this._idleQueue.length>0},t.prototype._process=function(e){var t=this;if(this.suspended){if(this._updateViewNeeded){this._updateViewNeeded=!1;var r=this._isRootNodeVisible();r!==this._layerIsVisible&&(this._layerIsVisible=r,this.notifyChange("suspended"))}}else{for(e.run(function(){return t._updateWorkQueues()});this._indexQueue.length>0&&e.run(function(){return t._processIndexQueue()}););for(this._processWorkQueue(e);this._idleQueue.length>0&&e.run(function(){return t._idleQueue.process()}););}},t.prototype._processIndexQueue=function(){var e=this,t=this._indexQueue.shift(),r=this._loadNodePage(t);return this._indexPagesLoading.set(t,r),r.promise.then(function(r){e._index.addPage(t,r,e._elevationOffset),e._setUpdateViewNeeded()}).then(function(){e._indexPagesLoading.delete(t)},function(){e._indexPagesLoading.delete(t)}),!0},t.prototype._processWorkQueue=function(e){for(;!e.done;){var t=this._scheduleWorkEntry();if(!t)return;this._processWorkEntry(t),e.madeProgress()}},t.prototype._scheduleWorkEntry=function(){var e=this;if(this._loadingNodes.size>=8)return null;for(var t=0;t<this._workQueue.length;++t){var r=this._workQueue[t];if(!s.find(r.remove,function(t){return!e._renderedNodes.has(t)})){for(var i=t;i>0;--i)this._workQueue[i]=this._workQueue[i-1];return this._workQueue.shift(),r}}return null},t.prototype._processWorkEntry=function(e){var t=this;if(0!==e.load.length)d.all(e.load.map(function(e){var r=d.createAbortController(),i=t._memCache.pop(e.toString());return i?t._loadingNodes.set(e,{abortController:r,promise:d.resolve(i)}):t._loadingNodes.has(e)||t._loadingNodes.set(e,{abortController:r,promise:t.loadNode(e,r.signal)}),t._loadingNodes.get(e).promise})).then(function(r){for(var i=0;i<e.load.length;i++)if(r[i]){var n=t._setupRendererData(e.load[i],r[i]);t._addToRenderer(n)}for(var i=0;i<e.remove.length;i++)t._removeFromRenderer(e.remove[i])}).catch(function(){}).then(function(){for(var r=0;r<e.load.length;r++)t._loadingNodes.delete(e.load[r]);t._updateLoading()}),this._updateLoading();else for(var r=0;r<e.remove.length;r++)this._removeFromRenderer(e.remove[r])},t.prototype._computeWork=function(){for(var e=0,t=0;t<this._workQueue.length;t++)e+=this._workQueue[t].load.length;return e+=this._loadingNodes.size,e+=(this._indexQueue.length+this._indexPagesLoading.size)*this._index.pageSize,e+=this._loadingInitNodePage?100:0,e+=this._updateViewNeeded?100:0},Object.defineProperty(t.prototype,"updatingPercentageValue",{get:function(){var e=this._computeWork();return 100*Math.min(this._totalWork,e)/this._totalWork},enumerable:!0,configurable:!0}),t.prototype._updateLoading=function(){this.notifyChange("updating"),this.notifyChange("updatingPercentageValue")},t.prototype.canResume=function(){return this.inherited(arguments)&&this._layerIsVisible},t.prototype.isUpdating=function(){return this._computeWork()>0},t.prototype._initNodePages=function(){var e=this,t=this.layer.store.index,r=t.nodesPerPage||t.nodePerIndexBlock;return this._index=new P(this.layer.spatialReference,this.view.renderCoordsHelper.spatialReference,r),this._cancelIndexLoading(),this._traverseVisible=this._index.createVisibilityTraverse(),this._loadingInitNodePage=!0,this._layerIsVisible=!0,this.notifyChange("suspended"),this._updateLoading(),this._pageMultiplier=null!=t.nodesPerPage?1:t.nodePerIndexBlock,this._loadNodePage(0).promise.then(function(t){e._index.addPage(0,t,e._elevationOffset),e._loadingInitNodePage=!1,e._setUpdateViewNeeded()})},t.prototype._loadNodePage=function(e){var t=this,r=d.createAbortController(),i=this.baseUrl+"/nodepages/"+e*this._pageMultiplier;return{promise:this._requestJSON(i,r.signal).then(function(r){return r.data.nodes.map(function(r,i){return{resourceId:null!=r.resourceId?r.resourceId:e*t._index.pageSize+i,obb:r.obb,firstChild:r.firstChild,childCount:r.childCount,vertexCount:null!=r.vertexCount?r.vertexCount:r.pointCount,lodThreshold:null!=r.lodThreshold?r.lodThreshold:r.effectiveArea}})}),abortController:r}},t.prototype._updateWorkQueues=function(){if(!this._updateViewNeeded)return!1;for(var e=this.inverseDensity/this._lodFactor*this._getLodMemoryFactor(),t=this.maximumPointCount*this._lodFactor*this._getLodMemoryFactor(),r=this._computeNodesForMinimumDensity(e),i=this._computePointCount(r),n=Math.sqrt(i/(.75*t));i>t;)e*=n,r=this._computeNodesForMinimumDensity(e),i=this._computePointCount(r),n=Math.sqrt(2);return this.displayNodes(r),this._updateViewNeeded=!1,this._updateLoading(),!0},t.prototype._computePointCount=function(e){for(var t=0,r=0;r<e.length;r++){var i=this._index.getNode(e[r]);i&&(t+=i.vertexCount)}return t},t.prototype._getLodMemoryFactor=function(){return this.view.resourceController.memoryController.memoryFactor},t.prototype._isRootNodeVisible=function(){var e=!1;return this._traverseVisible({frustumPlanes:this.view.state.camera.frustum.planes,clippingBox:this._clippingBox},{predicate:function(t,r,i){return e=i,!1},pageMiss:function(e,t){}}),e},t.prototype._computeNodesForMinimumDensity=function(e){var t=this,r=this.view.state.camera,i=r.frustum,n=this._clippingBox,o=r.viewForward,s=c.vec3.dot(o,r.eye),a=V.plane.fromNormalAndOffset(o,-s,L),d=r.perScreenPixelRatio/2,u=e*e,l=this._nodeIdArray;l.length=0;var h=O.extractSafeScaleBounds(this.layer),p=h.minScale,_=h.maxScale,f=0===p&&0===_?function(e){return l.push(e)}:function(e){var r=t._getScale(e);O.scaleBoundsPredicate(r,p,_)&&l.push(e)};return this._traverseVisible({frustumPlanes:i.planes,clippingBox:n},{predicate:function(e,r,i){if(!i)return!1;if(0===r.childCount)return f(e),!1;var n=t._index.getRenderObb(e);return!(t._computeAveragePixelArea(n,r.lodThreshold,r.vertexCount,a,d)<=u&&(f(e),1))},pageMiss:function(e,r){f(e),t._indexQueue.indexOf(r)<0&&t._indexQueue.push(r)}}),l},t.prototype._getScale=function(e){var t=this._nodeScales.get(e);if(null==t){var r=this._index.getNode(e),i=r.obb.center;this._tmpPoint.x=i[0],this._tmpPoint.y=i[1],this._tmpPoint.z=i[2],t=this.view.basemapTerrain.getScale(this._tmpPoint),this._nodeScales.set(e,t)}return t},t.prototype._computeAveragePixelArea=function(e,t,r,i,n){var o=Math.max(1e-7,Q.minimumDistancePlane(e,i));return t/(o*o)/(4*n*n)/r},t.prototype.loadNode=function(e,t){var r=this,i=this._index.getNode(e),n=S.getRendererInfo(this.layer),o=S.getFilterInfo(this.layer),s=i.resourceId,a=[],u=function(e){var i=r.loadAttribute(s,e,t);return a.push(i),i};return this._idleQueue.push().then(function(){var e=r.loadGeometry(s,t);a.push(e);var i=u(n.primaryAttribute),l=u(n.modulationAttribute),h=o.map(function(e){return u(e.attributeInfo)});return d.all([e,i,l,d.all(h)])}).then(function(i){var s=i[0],a=i[1],d=i[2],u=i[3],l=[s];a&&l.push(a),d&&l.push(d);for(var h=0,p=u;h<p.length;h++){var c=p[h];l.push(c)}var _={geometryBuffer:s,primaryAttribute:a,modulationAttribute:d,filterAttributes:u,schema:r.layer.store.defaultGeometrySchema,rendererInfo:n,filterInfo:o,obb:r._index.getRenderObb(e),elevationOffset:r._elevationOffset,inSR:r.layer.spatialReference.toJSON(),outSR:r.view.renderCoordsHelper.spatialReference.toJSON()};return r._worker.transform(_,l,t)}).catch(function(e){return d.isAbortError(e)||z.error(e),d.reject(e)})},t.prototype.loadGeometry=function(e,t){var r=this.baseUrl+"/nodes/"+e+"/geometries/0";return this._requestBinary(r,t).then(function(e){return e.data})},t.prototype.loadAttribute=function(e,t,r){if(!t||!t.storageInfo)return d.resolve(null);var i=t.storageInfo.key,n=this.baseUrl+"/nodes/"+e+"/attributes/"+i;return this._requestBinary(n,r).then(function(e){return e.data})},t.prototype._requestJSON=function(e,t){return n(e,{query:{f:"json"},responseType:"json",signal:t})},t.prototype._requestBinary=function(e,t){return n(e,{responseType:"array-buffer",signal:t})},t.prototype._removeFromRenderer=function(e){if(this._renderedNodes.has(e)){var t=this._renderer.removeNode(e);this._renderedNodes.delete(e),this._nodeScales.delete(e),this._memCache.put(t.id.toString(),t,U(t))}},t.prototype._addToRenderer=function(e){this._renderedNodes.has(e.id)||(this._renderedNodes.add(e.id),this._renderer.addNode(e))},t.prototype._setupRendererData=function(e,t){var r=this._index.getNode(e),i=Math.sqrt(r.lodThreshold/r.vertexCount),n=this._index.getRenderObb(e);if(C.isInstanceOfNode(t))return t.splatSize=i,t.obb=n,t.origin=_.vec3f32.clone(t.obb.center),t;if(t.obb.halfSize[0]>n.halfSize[0]||t.obb.halfSize[1]>n.halfSize[1]||t.obb.halfSize[2]>n.halfSize[2]){if(this._maxLoggedBoxWarnings>0){var o=function(e){return"["+e.halfSize[0]+", "+e.halfSize[1]+", "+e.halfSize[2]+"]"};z.warn("Node "+e+" reported bounding box too small. got "+o(n)+" but points cover "+o(t.obb)),0==--this._maxLoggedBoxWarnings&&z.warn("  Too many bounding box errors, stopping reporting for this layer.")}this._index.setRenderObb(e,t.obb)}return{id:e,coordinates:t.points,origin:_.vec3f32.clone(n.center),rgb:t.rgb,splatSize:i,obb:n,isLeaf:0===r.childCount}},t.prototype.getUsedMemory=function(){var e=this;return o.keysOfSet(this._renderedNodes).reduce(function(t,r){return t+15*e._index.getNode(r).vertexCount+128},0)},t.prototype.getUnloadedMemory=function(){var e=this,t=this._renderedNodes.size;if(t<4)return 0;for(var r=o.keysOfSet(this._renderedNodes).reduce(function(t,r){return t+e._index.getNode(r).vertexCount}),i=this._loadingNodes.size,n=0;n<this._workQueue.length;n++)i+=this._workQueue[n].load.length,i-=this._workQueue[n].remove.length;return i<0?0:i*r/t*15+128*i},t.prototype.ignoresMemoryFactor=function(){return!1},t.prototype.getStats=function(){var e=this;return{"Rendered Nodes":this._renderedNodes.size,"Rendered Points":o.keysOfSet(this._renderedNodes).reduce(function(t,r){return t+e._index.getNode(r).vertexCount},0),"Loading Nodes":this._loadingNodes.size,"Index Queue":this._indexQueue.length,"Work Queue":this._workQueue.length,"Idle Queue":this._idleQueue.length}},i([p.property()],t.prototype,"layer",void 0),i([p.property({readOnly:!0,aliasOf:"layer.parsedUrl.path"})],t.prototype,"baseUrl",void 0),i([p.property({readOnly:!0,dependsOn:["layer.renderer"]})],t.prototype,"pointScale",null),i([p.property({readOnly:!0,dependsOn:["layer.renderer"]})],t.prototype,"useRealWorldSymbolSizes",null),i([p.property({readOnly:!0,dependsOn:["layer.renderer"]})],t.prototype,"pointSize",null),i([p.property({readOnly:!0,dependsOn:["layer.renderer"]})],t.prototype,"inverseDensity",null),i([p.property()],t.prototype,"maximumPointCount",void 0),i([p.property({readOnly:!0,dependsOn:["view.clippingArea"]})],t.prototype,"_clippingBox",null),i([p.property({readOnly:!0,dependsOn:["layer.elevationInfo"]})],t.prototype,"_elevationOffset",null),i([p.property({type:Boolean})],t.prototype,"slicePlaneEnabled",void 0),i([p.property(k.updatingPercentage)],t.prototype,"updatingPercentage",void 0),i([p.property({readOnly:!0})],t.prototype,"updatingPercentageValue",null),t=i([p.subclass("esri.views.3d.layers.PointCloudLayerView3D")],t)}(p.declared(b)),W=g.create();return I});