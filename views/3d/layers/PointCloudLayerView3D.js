/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/asyncUtils","../../../core/Collection","../../../core/Logger","../../../core/maybe","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/screenUtils","../../../core/typedArrayUtil","../../../core/unitUtils","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec3","../../../chunks/vec3f32","../../../geometry/projection","../../../geometry/support/aaBoundingBox","../../../geometry/support/aaBoundingRect","../../../geometry/support/plane","../../../layers/graphics/dehydratedFeatures","../../../layers/support/CodedValue","../../../layers/support/CodedValueDomain","../../../layers/support/Domain","../../../layers/support/InheritedDomain","../../../layers/support/RangeDomain","../../../layers/support/fieldUtils","../../../layers/support/PromiseQueue","../../../symbols/support/unitConversionUtils","./LayerView3D","./PointCloudWorkerHandle","./i3s/I3SUtil","./i3s/LoDUtil","./i3s/PagedNodeIndex","./i3s/PointCloudRendererUtil","./i3s/PointCloudWorkerUtil","./i3s/PointGraphic","./i3s/PointRenderer","./support/PopupSceneLayerView","../support/extentUtils","../support/index","../support/orientedBoundingBox","../support/updatingProperties","../webgl-engine/lib/RenderSlot","../../layers/LayerView","../../support/layerViewUtils","../../support/Scheduler"],(function(e,t,i,r,n,o,s,a,d,l,u,h,c,p,_,f,g,y,m,b,P,N,v,w,x,S,C,A,k,I,V,R,L,F,U,D,Q,z,W,G,M,O,T,E,B,H,q,$,j){"use strict";const J=n.getLogger("esri.views.3d.layers.PointCloudLayerView3D"),K=8,X=N.create();let Y=function(t){function n(){var e;return(e=t.apply(this,arguments)||this).type="point-cloud-3d",e.maximumPointCount=4e6,e.slicePlaneEnabled=!1,e._renderer=null,e._rendererAdded=!1,e._renderedNodes=new Set,e._nodeScales=new Map,e._updateViewNeeded=!0,e._lodFactor=1,e._maxLoggedBoxWarnings=5,e._pageMultiplier=1,e._nodeLoadEpoch=0,e._indexQueue=[],e._workQueue=new Array,e._idleQueue=new I.PromiseQueue,e._indexPagesLoading=new Map,e._loadingNodes=new Map,e._recalcWork=!0,e._layerIsVisible=!1,e._codedDomainPopulationPromise=null,e._codedDomainPopulationAbortController=null,e._totalWork=0,e._index=null,e._loadingInitNodePage=!1,e._nodeIdArray=[],e}e._inheritsLoose(n,t);var h=n.prototype;return h.initialize=function(){const e=this.view.resourceController;this._worker=new L.PointCloudWorkerHandle((t=>e.schedule(t))),this.addResolvingPromise(this._worker.promise),this._tmpPoint=v.makeDehydratedPoint(0,0,0,this.layer.spatialReference),F.checkPointCloudLayerValid(this.layer),F.checkPointCloudLayerCompatibleWithView(this.layer,this.view),this._indexRequester=e.createStreamDataRequester(T.ClientType.I3S_INDEX),this._dataRequester=e.createStreamDataRequester(T.ClientType.I3S_DATA),this._initRenderer();const t=this._initNodePages(),i=this.view.resourceController.memoryController;this._memCache=i.newCache(this.layer.uid),this.updatingHandles.add((()=>this._clippingBox),(()=>this._setUpdateViewNeeded()),a.initial),this.updatingHandles.add((()=>this._elevationOffset),(()=>this._elevationOffsetChanged()),a.initial),this.updatingHandles.add((()=>this.layer.renderer),(()=>this._rendererChanged()),a.initial),this.updatingHandles.add((()=>this.layer.filters),(()=>this._reload()),a.initial),this.updatingHandles.add((()=>this.layer.outFields),(()=>this._reload()),a.initial),this.updatingHandles.add((()=>this.layer.effectiveScaleRange),(()=>this._setUpdateViewNeeded())),this.updatingHandles.add((()=>this.view.state.contentCamera),(()=>this._setUpdateViewNeeded())),this.handles.add([this.view.basemapTerrain.on("scale-change",(e=>this._scaleUpdateHandler(e))),i.events.on("quality-changed",(()=>this._setUpdateViewNeeded()))]),this.addResolvingPromise(t),this.when((()=>{this.handles.add([e.scheduler.registerTask(j.TaskPriority.POINT_CLOUD_LAYER,this),e.scheduler.registerIdleStateCallbacks((()=>this._idleBegin()),(()=>this._idleEnd())),this.updatingHandles.add((()=>this.suspended),(e=>{e?this._clearNodeState():this._setUpdateViewNeeded()}),a.initial)])}),(()=>{this.updatingHandles.removeAll(),this.handles.removeAll()}))},h._setUpdateViewNeeded=function(){this._updateViewNeeded=!0,this._updateLoading()},h.destroy=function(){this.cancelLoading(),this._worker&&(this._worker.destroy(),this._worker=null),this._destroyRenderer(),this._memCache.destroy(),this._memCache=null,this._codedDomainPopulationAbortController&&(this._codedDomainPopulationAbortController.abort(),this._codedDomainPopulationAbortController=null),this._codedDomainPopulationPromise=null},h._initRenderer=function(){this._renderer=new G.PointRenderer({createGraphic:(e,t,i)=>this._createGraphic(e,t,i)}),this._renderer.layerUid=this.layer.uid,this.updatingHandles.add((()=>this._clippingBox),(e=>this._renderer.clippingBox=e),a.initial),this.updatingHandles.add((()=>this.suspended),(e=>this._setPointsVisible(!e)),a.initial),this.updatingHandles.add((()=>this.pointScale),(e=>this._renderer.scaleFactor=e),a.initial),this._renderer.minSizePx=Math.sqrt(2),this.updatingHandles.add((()=>this.useRealWorldSymbolSizes),(e=>this._renderer.useRealWorldSymbolSizes=e),a.initial),this.updatingHandles.add((()=>this.pointSize),(e=>{const t=d.pt2px(e);this._renderer.size=e,this._renderer.sizePx=t}),a.initial),this.updatingHandles.add((()=>this.slicePlaneEnabled),(e=>this._renderer.slicePlaneEnabled=e),a.initial),this.updatingHandles.add((()=>this.inverseDensity),(()=>this._setUpdateViewNeeded()),a.initial),this.updatingHandles.add((()=>this.maximumPointCount),(()=>this._setUpdateViewNeeded()),a.initial),this.updatingHandles.add((()=>this.view.qualitySettings.sceneService.pointCloud.lodFactor),(e=>{this._lodFactor=e,this._setUpdateViewNeeded()}),a.initial)},h._destroyRenderer=function(){this._renderer.removeAll(),this._setPointsVisible(!1)},h._createGraphic=function(e,t,i){const r=o.isSome(e.pointIdFilterMap)?e.pointIdFilterMap[t]:t,n=this.view.computeMapPointFromVec3d(i),s=this._createGraphicAttributes(e,r);return new W.PointGraphic({pointCloudMetadata:{nodeId:e.id,pointIndexInNode:t,attributePointIndexInNode:r,epoch:this._nodeLoadEpoch},geometry:n,attributes:s,layer:this.layer,sourceLayer:this.layer})},h._createGraphicAttributes=function(e,t){const i={};for(const r of e.attributes)this._encodeGraphicAttribute(r.attributeInfo,r.values,t,i);return i},h._encodeGraphicAttribute=function(e,t,i,r){const n=e.storageInfo&&e.storageInfo.attributeValues,o=n?n.valuesPerElement:1;if(1===o)r[e.name]=t[i];else if("UInt8"===n.valueType&&o<=4){let n=0;const s=i*o;for(let e=s;e<s+o;e++)n=(n<<8)+t[e];r[e.name]=n}else r[e.name]=void 0},h._setPointsVisible=function(e){e&&!this._rendererAdded?(this.view._stage.addRenderPlugin([H.RenderSlot.OPAQUE_PLUGIN],this._renderer),this._rendererAdded=!0):!e&&this._rendererAdded&&(this.view._stage.removeRenderPlugin(this._renderer),this._rendererAdded=!1)},h._rendererChanged=function(){this._renderer.useFixedSizes=Q.rendererUsesFixedSizes(this.layer.renderer),this._reload()},h._reload=function(){this._clearNodeState(),this._memCache.clear(),this._setUpdateViewNeeded()},h._elevationOffsetChanged=function(){this._clearNodeState(),this._memCache.clear(),this._initNodePages()},h._scaleUpdateHandler=function(e){const t=this.layer.effectiveScaleRange;$.isScaleRangeActive(t.minScale,t.maxScale)?m.projectBoundingRect(e.extent,e.spatialReference,te,this.layer.spatialReference)&&(this._nodeScales.forEach(((t,i)=>{if(!this._renderedNodes.has(i))return void this._nodeScales.delete(i);const r=this._index.getNode(i);P.containsPoint(te,r.obb.center)&&this._nodeScales.set(i,e.scale)})),this._setUpdateViewNeeded()):this._nodeScales.clear()},h._displayNodes=function(e){this._workQueue=U.nodeDiff([...this._renderedNodes],e,this._index),U.sortFrontToBack(this._workQueue,this.view.state.contentCamera.viewForward,this._index),U.splitWorkEntries(this._workQueue,K,this._index),this._updateQueues(),this._totalWork=this._computeWork(),this._updateLoading(),this._layerIsVisible=e.length>0||this._loadingInitNodePage,this.notifyChange("suspended")},h.cancelLoading=function(){this._cancelNodeLoading(),this._cancelIndexLoading()},h._cancelNodeLoading=function(){const e=new Array;this._loadingNodes.forEach((({abortController:t})=>e.push(t))),this._loadingNodes.clear();for(const t of e)t.abort();this._workQueue=[],this._idleQueue.cancelAll(),this._totalWork=this._computeWork(),this._updateLoading()},h._updateQueues=function(){const e=new Set;this._workQueue.forEach((t=>t.load.forEach((t=>e.add(t)))));const t=new Array,i=new Map;this._loadingNodes.forEach(((r,n)=>{e.has(n)?i.set(n,r):t.push(r)})),this._loadingNodes=i;for(const{abortController:r}of t)r.abort();this._workQueue=this._workQueue.filter((e=>{for(const t of e.load)if(this._loadingNodes.has(t))return this._recalcWork=!0,!1;return!0})),this._totalWork=this._computeWork(),this._updateLoading()},h._cancelIndexLoading=function(){this._indexQueue=[],this._indexPagesLoading.forEach((({abortController:e})=>e.abort())),this._indexPagesLoading.clear(),this._totalWork=this._computeWork(),this._updateLoading()},h._clearNodeState=function(){this._nodeLoadEpoch++,this._renderedNodes.forEach((e=>this._removeFromRenderer(e))),this._cancelNodeLoading()},h._idleBegin=function(){this._setUpdateViewNeeded()},h._idleEnd=function(){this._setUpdateViewNeeded()},h.runTask=function(e){if(this.suspended){if(this._updateViewNeeded){this._updateViewNeeded=!1;const e=this._isRootNodeVisible();e!==this._layerIsVisible&&(this._layerIsVisible=e,this.notifyChange("suspended")),this._updateLoading()}}else{for(e.run((()=>this._updateWorkQueues()));this._indexQueue.length>0&&e.run((()=>this._processIndexQueue())););this._processWorkQueue(e),this._idleQueue.runTask(e)}},h._processIndexQueue=function(){const e=this._indexQueue.shift(),t=this._loadNodePage(e);return this._indexPagesLoading.set(e,t),t.promise.then((t=>{this._index.addPage(e,t,this._elevationOffset),this._setUpdateViewNeeded()})).then((()=>{this._indexPagesLoading.delete(e)}),(()=>{this._indexPagesLoading.delete(e)})),!0},h._processWorkQueue=function(e){for(;!e.done;){const t=this._scheduleWorkEntry();if(o.isNone(t))return;this._processWorkEntry(t),e.madeProgress()}},h._scheduleWorkEntry=function(){let e=this._workQueue.length;for(;e--;){const e=this._workQueue.shift();if(!e.remove.find((e=>!this._renderedNodes.has(e))))return e;this._workQueue.push(e)}return null},h._processWorkEntry=function(e){if(0!==e.load.length)Promise.all(e.load.map((e=>{const t=new AbortController,i=this._memCache.pop(e.toString());return o.isSome(i)?this._loadingNodes.set(e,{abortController:t,promise:Promise.resolve(i)}):this._loadingNodes.has(e)||this._loadingNodes.set(e,{abortController:t,promise:this._loadNode(e,t.signal)}),this._loadingNodes.get(e).promise}))).then((t=>{for(let i=0;i<e.load.length;i++)if(t[i]){const r=this._setupRendererData(e.load[i],t[i]);this._addToRenderer(r)}for(const i of e.remove)this._removeFromRenderer(i)})).catch((()=>{})).then((()=>{for(const t of e.load)this._loadingNodes.delete(t);this._updateLoading(),this._recalcWork&&!this._idleQueue.running&&0===this._indexQueue.length&&0===this._loadingNodes.size&&(this._recalcWork=!1,this._setUpdateViewNeeded())})),this._updateLoading();else for(const t of e.remove)this._removeFromRenderer(t)},h._populateClassCodeCodedDomain=function(){var t=e._asyncToGenerator((function*(e,t){const r="CLASS_CODE",n=this.layer.fieldsIndex.get(r);if(!n||n.domain)return;if(-1===e.indexOf(n.name))return;const o=yield i.result(this.layer.queryCachedStatistics(r,{signal:t}));if(!1===o.ok)return;const s=o.value,a=s&&s.labels&&s.labels.labels;a&&Array.isArray(a)&&(n.domain=new x({name:"CLASS_CODE",codedValues:a.map((e=>new w.default({code:e.value,name:e.label})))}))}));function r(e,i){return t.apply(this,arguments)}return r}(),h.prepareFetchPopupFeatures=function(){var t=e._asyncToGenerator((function*(e){return this._codedDomainPopulationPromise||(this._codedDomainPopulationAbortController=new AbortController,this._codedDomainPopulationPromise=this._populateClassCodeCodedDomain(e,this._codedDomainPopulationAbortController.signal).then((()=>{this._codedDomainPopulationAbortController=null}))),this._codedDomainPopulationPromise}));function i(e){return t.apply(this,arguments)}return i}(),h.whenGraphicAttributes=function(){var t=e._asyncToGenerator((function*(t,r){var n=this;const o=this._splitGraphicsPerNode(t),a=this.layer.attributeStorageInfo,d=r.map((e=>Q.getAttributeInfo(a,e))),l=function(){var t=e._asyncToGenerator((function*(t,r){const o=n._index.getNode(r);yield i.forEach(d,function(){var i=e._asyncToGenerator((function*(e){const i=e.useElevation?yield n._loadElevationAttributeFromGeometry(o.resourceId):yield n._loadAndParseAttribute(o,e);if(i)for(const r of t)if(n._isValidPointGraphic(r)){const t=r.pointCloudMetadata.attributePointIndexInNode;n._encodeGraphicAttribute(e,i,t,r.attributes)}}));return function(e){return i.apply(this,arguments)}}())}));return function(e,i){return t.apply(this,arguments)}}(),u=[];return o.forEach(((e,t)=>{u.push(l(e,t))})),yield s.eachAlways(u),t}));function r(e,i){return t.apply(this,arguments)}return r}(),h._isValidPointGraphic=function(e){return e instanceof W.PointGraphic&&e.pointCloudMetadata&&e.pointCloudMetadata.epoch===this._nodeLoadEpoch},h._splitGraphicsPerNode=function(e){const t=new Map;for(const i of e){if(!this._isValidPointGraphic(i))continue;const e=i.pointCloudMetadata,r=t.get(e.nodeId);r?r.push(i):t.set(e.nodeId,[i])}return t},h._loadAndParseAttribute=function(){var t=e._asyncToGenerator((function*(e,t){const i=yield this._loadAttribute(e.resourceId,t,null);return o.isSome(i)?z.getAttributeValues({attributeInfo:t,buffer:i},null,e.vertexCount):null}));function i(e,i){return t.apply(this,arguments)}return i}(),h._loadElevationAttributeFromGeometry=function(){var t=e._asyncToGenerator((function*(e){const t=this.layer.store.defaultGeometrySchema,i=z.readGeometry(t,yield this._loadGeometry(e,null));return z.elevationFromPositions(i,i.length/3)}));function i(e){return t.apply(this,arguments)}return i}(),h.highlight=function(e){if(!e)return{remove(){}};const t=r.isCollection(e)?e.toArray():Array.isArray(e)?e:[e];return this._renderer.highlight(t.map((e=>this._graphicToPointDefinition(e))))},h._graphicToPointDefinition=function(e){if(!this._isValidPointGraphic(e))return null;const{nodeId:t,pointIndexInNode:i}=e.pointCloudMetadata;return null!=t&&null!=i?{nodeId:t,pointId:i}:null},h._computeWork=function(){let e=0;for(const t of this._workQueue)e+=t.load.length+t.remove.length;return e+=this._loadingNodes.size,e+=(this._indexQueue.length+this._indexPagesLoading.size)*this._index.pageSize,e+=this._loadingInitNodePage?100:0,e+=this._updateViewNeeded?100:0,e},h._updateLoading=function(){this.notifyChange("updating"),this.notifyChange("updatingProgressValue")},h.canResume=function(){return t.prototype.canResume.call(this)&&this._layerIsVisible},h.isUpdating=function(){return this.suspended?this._updateViewNeeded:this._computeWork()>0},h._initNodePages=function(){const e=this.layer.store.index,t=e.nodesPerPage||e.nodePerIndexBlock;return this._index=new D(this.layer.spatialReference,this.view.renderCoordsHelper.spatialReference,t),this._cancelIndexLoading(),this._traverseVisible=this._index.createVisibilityTraverse(),this._loadingInitNodePage=!0,this._layerIsVisible=!0,this.notifyChange("suspended"),this._updateLoading(),this._pageMultiplier=null!=e.nodesPerPage?1:e.nodePerIndexBlock,this._loadNodePage(0).promise.then((e=>{this._index.addPage(0,e,this._elevationOffset),this._loadingInitNodePage=!1,this._setUpdateViewNeeded()}))},h._loadNodePage=function(e){const t=new AbortController,i=`${this.baseUrl}/nodepages/${e*this._pageMultiplier}`;return{promise:this._requestNodePage(i,t.signal).then((t=>t.nodes.map(((t,i)=>({resourceId:null!=t.resourceId?t.resourceId:e*this._index.pageSize+i,obb:t.obb,firstChild:t.firstChild,childCount:t.childCount,vertexCount:null!=t.vertexCount?t.vertexCount:t.pointCount,lodThreshold:null!=t.lodThreshold?t.lodThreshold:t.effectiveArea}))))),abortController:t}},h._updateWorkQueues=function(){if(!this._updateViewNeeded)return!1;let e=this.inverseDensity/this._lodFactor*this._getLodMemoryFactor();const t=this.maximumPointCount*this._lodFactor*this._getLodMemoryFactor();let i=this._computeNodesForMinimumDensity(e),r=this._computePointCount(i),n=Math.sqrt(r/(.75*t));for(;r>t;)e*=n,i=this._computeNodesForMinimumDensity(e),r=this._computePointCount(i),n=Math.sqrt(2);return this._displayNodes(i),this._updateViewNeeded=!1,this._updateLoading(),!0},h._computePointCount=function(e){let t=0;for(let i=0;i<e.length;i++){const r=this._index.getNode(e[i]);r&&(t+=r.vertexCount)}return t},h._getLodMemoryFactor=function(){return this.view.resourceController.memoryController.memoryFactor},h._isRootNodeVisible=function(){let e=!1;return this._traverseVisible({frustum:this.view.state.contentCamera.frustum,clippingBox:this._clippingBox},{predicate:(t,i,r)=>(e=r,!1),pageMiss:()=>{}}),e},h._computeNodesForMinimumDensity=function(e){const t=this.view.state.contentCamera,i=t.frustum,r=this._clippingBox,n=t.viewForward,o=g.dot(n,t.eye),s=N.fromNormalAndOffset(n,-o,X),a=t.perScreenPixelRatio/2,d=e*e,l=this._nodeIdArray;l.length=0;const{minScale:u,maxScale:h}=$.extractSafeScaleBounds(this.layer),c=0===u&&0===h?e=>l.push(e):e=>{const t=this._getScale(e);$.scaleBoundsPredicate(t,u,h)&&l.push(e)};return this._traverseVisible({frustum:i,clippingBox:r},{predicate:(e,t,i)=>{if(!i)return!1;if(0===t.childCount)return c(e),!1;const r=this._index.getRenderObb(e);return!(this._computeAveragePixelArea(r,t.lodThreshold,t.vertexCount,s,a)<=d)||(c(e),!1)},pageMiss:(e,t)=>{c(e),this._indexQueue.indexOf(t)<0&&this._indexQueue.push(t)}}),l},h._getScale=function(e){let t=this._nodeScales.get(e);if(null==t){const i=this._index.getNode(e).obb.center;this._tmpPoint.x=i[0],this._tmpPoint.y=i[1],this._tmpPoint.z=i[2],t=this.view.basemapTerrain.getScale(this._tmpPoint),this._nodeScales.set(e,t)}return t},h._computeAveragePixelArea=function(e,t,i,r,n){const o=1e-7,s=Math.max(o,E.minimumDistancePlane(e,r));return t/(s*s)/(4*n*n)/i},h._loadNode=function(e,t){try{return this._loadNodeAsync(e,t)}catch(i){throw s.isAbortError(i)||J.error(i),i}},h._loadAdditionalUserAttributes=function(){var t=e._asyncToGenerator((function*(e,t,i){const r=this.layer.outFields;if(!r)return[];const n=k.unpackFieldNames(this.layer.fieldsIndex,r),a=new Set(e.map((e=>o.isSome(e)?e.name:null))),d=this.layer.attributeStorageInfo,l=[];for(const o of n){if(a.has(o))continue;const e=Q.getAttributeInfo(d,o);e&&l.push(t(e))}const u=yield s.eachAlwaysValues(l);return s.throwIfAborted(i),o.mapSome(u,(e=>e))}));function i(e,i,r){return t.apply(this,arguments)}return i}(),h._loadNodeAsync=function(){var t=e._asyncToGenerator((function*(t,i){var r=this;const n=this._index.getNode(t),a=Q.getRendererInfo(this.layer),d=Q.getFilterInfo(this.layer),l=n.resourceId,u=function(){var t=e._asyncToGenerator((function*(e){if(o.isNone(e))return null;if(e.useElevation)return{attributeInfo:e,buffer:null};const t=yield r._loadAttribute(l,e,i);return o.isSome(t)?{attributeInfo:e,buffer:t}:null}));return function(e){return t.apply(this,arguments)}}();return this._idleQueue.push(e._asyncToGenerator((function*(){const e=r._loadGeometry(l,i),{primaryAttribute:n,modulationAttribute:o}=a,h=u(n),c=u(o),p=d.map((e=>e.attributeInfo)),_=p.map((e=>u(e))),f=r._loadAdditionalUserAttributes([n,o,...p],u,i),[g,y,m,b,P]=yield Promise.all([e,h,c,Promise.all(_),f]);s.throwIfAborted(i);const N={geometryBuffer:g,primaryAttributeData:y,modulationAttributeData:m,filterAttributesData:b,userAttributesData:P,schema:r.layer.store.defaultGeometrySchema,rendererInfo:a,filterInfo:d,obb:r._index.getRenderObb(t),elevationOffset:r._elevationOffset,inSR:r.layer.spatialReference.toJSON(),outSR:r.view.renderCoordsHelper.spatialReference.toJSON()};return r._worker.invoke(N,i)})),i)}));function i(e,i){return t.apply(this,arguments)}return i}(),h._loadGeometry=function(){var t=e._asyncToGenerator((function*(e,t){return this._requestData(`${this.baseUrl}/nodes/${e}/geometries/0`,t)}));function i(e,i){return t.apply(this,arguments)}return i}(),h._loadAttribute=function(){var t=e._asyncToGenerator((function*(e,t,i){if(o.isNone(t)||!t.storageInfo)return null;const r=t.storageInfo.key;return this._requestData(`${this.baseUrl}/nodes/${e}/attributes/${r}`,i)}));function i(e,i,r){return t.apply(this,arguments)}return i}(),h._requestNodePage=function(e,t){const i={f:"json",token:this.layer.apiKey};return this._indexRequester.request(e,"json",{query:i,signal:t})},h._requestData=function(e,t){return this._dataRequester.request(e,"binary",{query:{token:this.layer.apiKey},signal:t})},h._removeFromRenderer=function(e){if(this._renderedNodes.has(e)){const t=this._renderer.removeNode(e);this._renderedNodes.delete(e),this._nodeScales.delete(e),this._memCache.put(t.id.toString(),t,ee(t))}},h._addToRenderer=function(e){this._renderedNodes.has(e.id)||(this._renderedNodes.add(e.id),this._renderer.addNode(e))},h._setupRendererData=function(e,t){const i=this._index.getNode(e),r=Math.sqrt(i.lodThreshold/i.vertexCount),n=this._index.getRenderObb(e);if(G.isInstanceOfNode(t))return t.splatSize=r,t.obb=n,t.origin=y.clone(t.obb.center),t;const o=.01*Math.max(n.halfSize[0],n.halfSize[1],n.halfSize[2]);if(t.obb.halfSize[0]>n.halfSize[0]+o||t.obb.halfSize[1]>n.halfSize[1]+o||t.obb.halfSize[2]>n.halfSize[2]+o){if(this._maxLoggedBoxWarnings>0){const i=e=>`[${e.halfSize[0]}, ${e.halfSize[1]}, ${e.halfSize[2]}]`;J.warn(`Node ${e} reported bounding box too small. got ${i(n)} but points cover ${i(t.obb)}`),0==--this._maxLoggedBoxWarnings&&J.warn("  Too many bounding box errors, stopping reporting for this layer.")}this._index.setRenderObb(e,t.obb)}return{id:e,coordinates:t.points,origin:y.clone(n.center),rgb:t.rgb,attributes:t.attributes,pointIdFilterMap:t.pointIdFilterMap,highlights:null,splatSize:r,obb:n,isLeaf:0===i.childCount}},h.getUsedMemory=function(){let e=0;return this._renderer.forEachNode((t=>{e+=ie,e+=l.estimateSize(t.coordinates);for(const i of t.attributes){const t=i.values;l.isArrayBuffer(t.buffer)&&(e+=l.estimateSize(t))}})),e},h.getUnloadedMemory=function(){const e=this._renderedNodes.size;if(e<4)return 0;const t=[...this._renderedNodes].reduce(((e,t)=>e+this._index.getNode(t).vertexCount));let i=this._loadingNodes.size;for(let r=0;r<this._workQueue.length;r++)i+=this._workQueue[r].load.length,i-=this._workQueue[r].remove.length;if(i<0)return 0;return i*t/e*((this.getUsedMemory()-e*ie)/t)+i*ie},h.ignoresMemoryFactor=function(){return!1},e._createClass(n,[{key:"pointScale",get:function(){const e=Q.getSplatSizeAlgorithm(this.layer&&this.layer.renderer),t=1;return e&&null!=e.scaleFactor?e.scaleFactor:t}},{key:"useRealWorldSymbolSizes",get:function(){const e=Q.getFixedSizeAlgorithm(this.layer&&this.layer.renderer),t=!1;return e&&null!=e.useRealWorldSymbolSizes?e.useRealWorldSymbolSizes:t}},{key:"pointSize",get:function(){const e=Q.getFixedSizeAlgorithm(this.layer&&this.layer.renderer),t=0;return e&&null!=e.size?e.size:t}},{key:"inverseDensity",get:function(){const e=96;return this.layer&&this.layer.renderer?1*e/this.layer.renderer.pointsPerInch:5}},{key:"availableFields",get:function(){const e=Q.getRendererInfo(this.layer),t=new Set;e.primaryAttribute&&t.add(e.primaryAttribute.name),e.modulationAttribute&&t.add(e.primaryAttribute.name);const i=Q.getFilterInfo(this.layer);if(i)for(const r of i)t.add(r.attributeInfo.name);if(this.layer.outFields)for(const r of k.unpackFieldNames(this.layer.fieldsIndex,this.layer.outFields))t.add(r);return Array.from(t)}},{key:"_clippingBox",get:function(){if(!this.view||!this.view.clippingArea)return null;const e=b.create(),t=this.view.renderSpatialReference;return O.projectToBoundingBox(this.view.clippingArea,e,t)?e:null}},{key:"_elevationOffset",get:function(){const e=this.layer&&this.layer.elevationInfo;if(e&&"absolute-height"===e.mode){const t=u.getMetersPerVerticalUnitForSR(this.layer.spatialReference),i=V.getMetersPerUnit(e.unit);return o.unwrapOr(e.offset,0)*i/t}return 0}},{key:"running",get:function(){return this.suspended?this._updateViewNeeded:this._updateViewNeeded||this._indexQueue.length>0||this._workQueue.length>0||this._idleQueue.running}},{key:"updatingProgressValue",get:function(){if(this.suspended)return this._updateViewNeeded?0:1;const e=this._computeWork();return 1-Math.min(this._totalWork,e)/this._totalWork}},{key:"performanceInfo",get:function(){return{nodes:this._renderedNodes.size,displayedNumberOfFeatures:[...this._renderedNodes].reduce(((e,t)=>e+this._index.getNode(t).vertexCount),0),maximumNumberOfFeatures:this.maximumPointCount,totalNumberOfFeatures:-1,core:null,"Loading Nodes":this._loadingNodes.size,"Index Queue":this._indexQueue.length,"Work Queue":this._workQueue.length,"Idle Queue":this._idleQueue.length}}},{key:"test",get:function(){return{index:this._index,visibleNodes:this._renderedNodes}}}]),n}(M.PopupSceneLayerView(R.LayerView3D(q)));t.__decorate([h.property()],Y.prototype,"layer",void 0),t.__decorate([h.property({readOnly:!0,aliasOf:"layer.parsedUrl.path"})],Y.prototype,"baseUrl",void 0),t.__decorate([h.property({readOnly:!0})],Y.prototype,"pointScale",null),t.__decorate([h.property({readOnly:!0})],Y.prototype,"useRealWorldSymbolSizes",null),t.__decorate([h.property({readOnly:!0})],Y.prototype,"pointSize",null),t.__decorate([h.property({readOnly:!0})],Y.prototype,"inverseDensity",null),t.__decorate([h.property()],Y.prototype,"maximumPointCount",void 0),t.__decorate([h.property({readOnly:!0})],Y.prototype,"availableFields",null),t.__decorate([h.property({readOnly:!0})],Y.prototype,"_clippingBox",null),t.__decorate([h.property({readOnly:!0})],Y.prototype,"_elevationOffset",null),t.__decorate([h.property({type:Boolean})],Y.prototype,"slicePlaneEnabled",void 0),t.__decorate([h.property()],Y.prototype,"updating",void 0),t.__decorate([h.property(B.updatingProgress)],Y.prototype,"updatingProgress",void 0),t.__decorate([h.property({readOnly:!0})],Y.prototype,"updatingProgressValue",null),Y=t.__decorate([f.subclass("esri.views.3d.layers.PointCloudLayerView3D")],Y);const Z=Y;function ee(e){return 5*e.coordinates.length+128}const te=P.create(),ie=160;return Z}));
