/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Collection","../../../core/Logger","../../../core/maybe","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../../layers/support/layerUtils","./LayerView3D","./TiledLayerView3D","../../layers/LayerView","../../layers/RefreshableLayerView"],(function(e,t,i,r,s,o,a,n,l,c,h,p,d,u,f){"use strict";let y=function(t){function a(){var e;return(e=t.apply(this,arguments)||this).type="wmts-3d",e}e._inheritsLoose(a,t);var n=a.prototype;return n._getCompatibleTileInfoMatrixSet=function(e,t=!1){const o=h.getTileMaxtrixSetFromActiveLayer(this.layer);if(s.isSome(o)){if(i.isCollection(o)){const i=o.find((i=>{const o=e(i);return s.isSome(o)&&(t?r.getLogger(this.declaredClass).error("The selected tile matrix set is not compatible with the view",o):this.addResolvingPromise(Promise.reject(o))),null==o}));return i}const a=e(o);return s.isSome(a)&&(t?r.getLogger(this.declaredClass).error("The selected tile matrix set is not compatible with the view",a):this.addResolvingPromise(Promise.reject(a))),o}return null},n.initialize=function(){this._getCompatibleTileInfoMatrixSet((e=>this._getTileInfoSupportError(e.tileInfo,e.fullExtent)));const e=o.whenOnce((()=>this.view?.basemapTerrain?.tilingSchemeLocked)).then((()=>{const e=this._getCompatibleTileInfoMatrixSet((e=>this._getTileInfoSupportError(e.tileInfo,e.fullExtent)||this._getTileInfoCompatibilityError(e.tileInfo,this.view.basemapTerrain.tilingScheme)));s.isNone(e)||(this.layer.activeLayer.tileMatrixSetId!==e.id&&(this.layer.activeLayer.tileMatrixSetId=e.id),this.tileInfo=e.tileInfo,this.layer.fullExtent=e.fullExtent)}));this.addResolvingPromise(e),this.when((()=>this._postInitialize()))},n.refresh=function(){this.emit("data-changed")},n.canResume=function(){if(!t.prototype.canResume.call(this))return!1;const e=this.layer.activeLayer.tileMatrixSet;return e&&!this._getTileInfoError(e.tileInfo,e.fullExtent)},n.doRefresh=function(){var t=e._asyncToGenerator((function*(){this.suspended||this.emit("data-changed")}));function i(){return t.apply(this,arguments)}return i}(),n._postInitialize=function(){this.updatingHandles.add((()=>this.layer?.activeLayer?.styleId),(()=>this.refresh())),this.updatingHandles.add((()=>this.layer?.activeLayer),(e=>{const t=this._getCompatibleTileInfoMatrixSet((e=>this._getTileInfoSupportError(e.tileInfo,e.fullExtent)||this._getTileInfoCompatibilityError(e.tileInfo,this.view.basemapTerrain.tilingScheme)),!0);s.isSome(t)&&e.tileMatrixSetId!==t.id&&(this.layer.activeLayer.tileMatrixSetId=t.id),this.notifyChange("suspended"),this.canResume()&&this.refresh()}))},n._getTileInfoError=function(e,t){return this._getTileInfoSupportError(e,t)||this._getTileInfoCompatibilityError(e,this.view.basemapTerrain.tilingScheme)},e._createClass(a,[{key:"hasMixedImageFormats",get:function(){return!0}}]),a}(f(d.TiledLayerView3D(p.LayerView3D(u))));t.__decorate([a.property({readOnly:!0})],y.prototype,"hasMixedImageFormats",null),t.__decorate([a.property()],y.prototype,"layer",void 0),t.__decorate([a.property()],y.prototype,"suspended",void 0),y=t.__decorate([c.subclass("esri.views.3d.layers.WMTSLayerView3d")],y);return y}));
