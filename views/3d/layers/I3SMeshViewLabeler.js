/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/has","../../../core/maybe","../../../core/Logger","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass","../../../core/urlUtils","../../../core/uuid","../../../portal/support/resourceExtension","../../../core/Accessor","../../../symbols/PointSymbol3D","../../../symbols","../../../Graphic","../../../chunks/vec3f64","../../../core/Handles","../../../core/accessorSupport/diffUtils","../../../layers/graphics/dehydratedFeatures","./graphics/Graphics3DCore","./graphics/Graphics3DScaleVisibility","./i3s/I3SGeometryUtil","../support/LimitGraphicsMap"],(function(e,i,t,r,s,o,a,n,l,c,p,d,h,u,y,g,_,b,f,v,C,m,w){"use strict";let I=function(i){function t(e){var t;return(t=i.call(this,e)||this).loadedGraphics=new w.LimitGraphicsMap(5e4),t.slicePlaneEnabled=!1,t._renderingInfo={symbol:new h},t._handles=new _,t._graphicsByNode=new Map,t._scaleVisibility=null,t}e._inheritsLoose(t,i);var s=t.prototype;return s.initialize=function(){this._graphicsCore=new v.Graphics3DCore({owner:this,layer:this.layer,preferredUpdatePolicy:1,elevationFeatureExpressionEnabled:!1,graphicSymbolSupported:!1,getRenderingInfoWithoutRenderer:!0,hasZ:!0,hasM:!1});const e=this.view.basemapTerrain;this._scaleVisibility=new C({layerScaleEnabled:!1}),this._scaleVisibility.setup(this,this.layer,((e,i,t)=>this._graphicsCore.spatialIndex.queryGraphicUIDsInExtent(e,i,t)),this._graphicsCore,e);const i=this.view.labeler.addGraphicsOwner(this._graphicsCore,this._scaleVisibility,{emptySymbolLabelSupported:!0,elevationInfoOverride:{mode:"absolute-height",offset:0},disablePlacement:{logEntityDescription:"3D Object Scene Layer features"}}),t=this.view.deconflictor.addGraphicsOwner(this._graphicsCore);this._graphicsCore.setup({labeler:i,deconflictor:t,scaleVisibility:this._scaleVisibility}).then((()=>{this._graphicsCore.startCreateGraphics()})).catch((()=>{})),this._handles.add([this.layer.watch("labelingInfo",((e,i)=>{b.diff(e,i)&&this._graphicsCore.updateLabelingInfo()}))])},s.destroy=function(){this._handles&&(this._handles.destroy(),this._handles=null),null!=this._scaleVisibility&&(this._scaleVisibility.destroy(),this._scaleVisibility=null),null!=this._graphicsCore&&(this._graphicsCore.destroy(),this._graphicsCore=null),this.loadedGraphics.destroy(),this.view=null},s.addNodeMeta=function(e,i){let t=0;const s=e.filteredIds,o=e.featureIds.map(((o,a)=>{m.boundingBoxTop(a,this.collection,e.objectHandle,V);const n=f.makeDehydratedPoint(0,0,0,this.view.spatialReference);this.view.renderCoordsHelper.fromRenderCoords(V,n);const l=i(a,e);let c=!1;return r.isNone(s)?c=!0:t<s.length&&o===s[t]&&(c=!0,t++),{objectId:o,uid:y.generateUID(),attributes:l,visible:c,geometry:n}}));this.loadedGraphics.addMany(o),this._graphicsByNode.set(e.node.index,o)},s.setNodeMetaAttributes=function(e,i){const t=this._graphicsByNode.get(e.node.index),r=new Array(t.length);for(let s=0;s<t.length;s++){const o=t[s];o.attributes=i(s,e),r[s]=o.uid}this._graphicsCore.updateLabelingInfo(r)},s.applyFilterChange=function(e){const i=this._graphicsByNode.get(e.node.index);if(i)if(r.isNone(e.filteredIds))for(const t of i)t.visible||(t.visible=!0,G.graphic=t,G.property="visible",G.oldValue=!1,G.newValue=!0,this._graphicsCore.graphicUpdateHandler(G));else{let t=0;for(const r of i){const i=r.visible;t<e.filteredIds.length&&r.objectId===e.filteredIds[t]?(r.visible=!0,t++):r.visible=!1,i!==r.visible&&(G.graphic=r,G.property="visible",G.oldValue=i,G.newValue=r.visible,this._graphicsCore.graphicUpdateHandler(G))}}},s.removeNodeMeta=function(e){this.loadedGraphics.removeManyByObjectId(e.featureIds)},s.getRenderingInfo=function(){return this._renderingInfo},s.notifyGraphicGeometryChanged=function(){},s.notifyGraphicVisibilityChanged=function(){},e._createClass(t,[{key:"usedMemory",get:function(){return this._graphicsCore.usedMemory}},{key:"unloadedMemoryEstimate",get:function(){return this._graphicsCore.unprocessedMemoryEstimate}},{key:"test",get:function(){return{graphicsCore:this._graphicsCore}}}]),t}(d);i.__decorate([a.property()],I.prototype,"view",void 0),i.__decorate([a.property()],I.prototype,"layer",void 0),i.__decorate([a.property()],I.prototype,"collection",void 0),i.__decorate([a.property()],I.prototype,"loadedGraphics",void 0),i.__decorate([a.property({aliasOf:"_graphicsCore.updating"})],I.prototype,"updating",void 0),i.__decorate([a.property()],I.prototype,"slicePlaneEnabled",void 0),i.__decorate([a.property()],I.prototype,"_graphicsCore",void 0),I=i.__decorate([n.subclass("esri.views.3d.layers.I3SMeshViewLabeler")],I);const G={graphic:null,property:null,oldValue:null,newValue:null},V=g.create();return I}));
