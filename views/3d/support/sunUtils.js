/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../core/mathUtils","../../../chunks/vec3f64","../../../chunks/vec3","../../../chunks/mat4","../../../chunks/mat4f64","../../../chunks/SunCalc"],(function(t,e,i,n,a,o,l){"use strict";const u={local:{altitude:1500,ambientAtNight:.1,ambientAtNoon:.45,ambientAtTwilight:.2,diffuseAtNoon:.65,diffuseAtTwilight:.7},global:{altitude:8e5,ambient:.015,diffuse:.75},planarDirection:{localAltitude:1e4,globalAltitude:1e6,globalAngles:{azimuth:1.3*Math.PI,altitude:.6*Math.PI}}};const s=o.create(),c={azimuth:0,altitude:0},r={ambient:{color:i.create(),intensity:0},diffuse:{color:i.create(),intensity:0,direction:i.create()},globalFactor:0,noonFactor:0};function f(t,e,i,n){const a=[];for(let o=0;o<i.length;o++)a[o]=(n[o]-i[o])*t/e+i[o];return a}t.computeColorAndIntensity=function(t,a){const o=a[2],s=r;n.set(s.ambient.color,1,1,1),s.ambient.intensity=u.global.ambient,n.set(s.diffuse.color,1,1,1),s.diffuse.intensity=u.global.diffuse;let c=(Math.abs(o)-u.local.altitude)/(u.global.altitude-u.local.altitude);c=e.clamp(c,0,1),s.globalFactor=c;const d=l.SunCalc.getTimes(t,a[1],a[0]);if(c<1){const a=function(t,e){const n=t.valueOf();let a,o;e.polarException===l.SunCalc.POLAR_EXCEPTION.MIDNIGHT_SUN?(a=n-60*(t.getHours()+48)*60*1e3-60*t.getMinutes()*1e3,o=a+432e6):e.polarException===l.SunCalc.POLAR_EXCEPTION.POLAR_NIGHT?(a=n-2,o=n-1):(a=e.sunrise.valueOf(),o=e.sunset.valueOf());const s=o-a,c=a+s/2,r=s/4,d=c-r,m=c+r,b=.06*s,g=a-b/2,h=a+b/2,A=o-b/2,p=o+b/2,y=u.local,N=[.01,y.ambientAtNight],O=[.8,.8,1],P=[.01,.01,.01],C=[y.diffuseAtTwilight,y.ambientAtTwilight],E=[1,.75,.75],I=[.8,.8,1],M=[.9*y.diffuseAtNoon,y.ambientAtNoon],T=[1,.98,.98],S=[.98,.98,1],_=[y.diffuseAtNoon,y.ambientAtNoon],v=[1,1,1],z=[1,1,1],D=M,H=T,L=S,R=C,X=E,k=I;let w,x,F=[0,0],G=[0,0,0],U=[0,0,0];n<g||n>p?(F=N,G=P,U=O,x="night"):n<h?(w=h-g,F=f(n-g,w,N,C),G=f(n-g,w,P,E),U=f(n-g,w,O,I),x="sun rising"):n<d?(w=d-h,F=f(n-h,w,C,M),G=f(n-h,w,E,T),U=f(n-h,w,I,S),x="early morning"):n<c?(w=c-d,F=f(n-d,w,M,_),G=f(n-d,w,T,v),U=f(n-d,w,S,z),x="late morning"):n<m?(w=m-c,F=f(n-c,w,_,D),G=f(n-c,w,v,H),U=f(n-c,w,z,L),x="early afternoon"):n<A?(w=A-m,F=f(n-m,w,D,R),G=f(n-m,w,H,X),U=f(n-m,w,L,k),x="late afternoon"):n<p&&(w=p-A,F=f(n-A,w,R,N),G=f(n-A,w,X,P),U=f(n-A,w,k,O),x="sun setting");return{diffuse:{intensity:F[0],color:i.fromValues(G[0],G[1],G[2])},ambient:{intensity:F[1],color:i.fromValues(U[0],U[1],U[2])},timeOfDay:x}}(t,d);n.lerp(s.ambient.color,a.ambient.color,s.ambient.color,c),s.ambient.intensity=e.lerp(a.ambient.intensity,s.ambient.intensity,c),n.lerp(s.diffuse.color,a.diffuse.color,s.diffuse.color,c),s.diffuse.intensity=e.lerp(a.diffuse.intensity,s.diffuse.intensity,c)}return s.noonFactor=function(t,i){const n=t.valueOf();let a,o;i.polarException===l.SunCalc.POLAR_EXCEPTION.MIDNIGHT_SUN?(a=n-60*(t.getHours()+48)*60*1e3-60*t.getMinutes()*1e3,o=a+432e6):i.polarException===l.SunCalc.POLAR_EXCEPTION.POLAR_NIGHT?(a=n-2,o=n-1):(a=i.sunrise.valueOf(),o=i.sunset.valueOf());const u=a+(o-a)/2;return 1-e.clamp(Math.abs(n-u)/432e5,0,1)}(t,d),s},t.computeDirection=function(t,o,r,f){f||(f=i.create());const d=c,m=a.identity(s);if("global"===r)l.SunCalc.getPosition(t,0,0,d),n.set(f,0,0,-1),a.rotateX(m,m,-d.azimuth),a.rotateY(m,m,-d.altitude),n.transformMat4(f,f,m);else{const i=u.planarDirection,s=i.globalAngles,c=o[2];let r=(Math.abs(c)-i.localAltitude)/(i.globalAltitude-i.localAltitude);r=e.clamp(r,0,1),r<1?(l.SunCalc.getPosition(t,o[1],o[0],d),d.azimuth=(1-r)*d.azimuth+r*s.azimuth,d.altitude=(1-r)*d.altitude+r*s.altitude):(d.azimuth=s.azimuth,d.altitude=s.altitude),n.set(f,0,-1,0),a.rotateZ(m,m,-d.azimuth),a.rotateX(m,m,-d.altitude),n.transformMat4(f,f,m)}return f},t.computeShadowsEnabled=function(t,e){if("global"===e)return!0;{const e=u.planarDirection,i=t[2];return Math.abs(i)<e.localAltitude}},t.settings=u,Object.defineProperty(t,"__esModule",{value:!0})}));
