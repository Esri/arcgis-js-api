// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","../../../core/mathUtils","../../../core/libs/gl-matrix-2/mat4","../../../core/libs/gl-matrix-2/mat4f64","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../lib/SunCalc"],(function(t,e,i,a,n,o,l,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.computeShadowsEnabled=e.computeDirection=e.computeColorAndIntensity=e.settings=void 0,e.settings={local:{altitude:1500,ambientAtNight:.1,ambientAtNoon:.45,ambientAtTwilight:.2,diffuseAtNoon:.65,diffuseAtTwilight:.7},global:{altitude:8e5,ambient:.015,diffuse:.75},planarDirection:{localAltitude:1e4,globalAltitude:1e6,globalAngles:{azimuth:1.3*Math.PI,altitude:.6*Math.PI}}},e.computeColorAndIntensity=function(t,a){var n=a[2],s=c;o.vec3.set(s.ambient.color,1,1,1),s.ambient.intensity=e.settings.global.ambient,o.vec3.set(s.diffuse.color,1,1,1),s.diffuse.intensity=e.settings.global.diffuse;var u=(Math.abs(n)-e.settings.local.altitude)/(e.settings.global.altitude-e.settings.local.altitude);u=i.clamp(u,0,1),s.globalFactor=u;var m=r.getTimes(t,a[1],a[0]);if(u<1){var d=function(t,i){var a,n,o=t.valueOf();i.polarException===r.POLAR_EXCEPTION.MIDNIGHT_SUN?(a=o-60*(t.getHours()+48)*60*1e3-60*t.getMinutes()*1e3,n=a+432e6):i.polarException===r.POLAR_EXCEPTION.POLAR_NIGHT?(a=o-2,n=o-1):(a=i.sunrise.valueOf(),n=i.sunset.valueOf());var s,u,c=n-a,m=a+c/2,d=c/4,g=m-d,b=m+d,v=.06*c,A=a-v/2,h=a+v/2,p=n-v/2,y=n+v/2,N=e.settings.local,O=[.01,N.ambientAtNight],P=[.8,.8,1],E=[.01,.01,.01],I=[N.diffuseAtTwilight,N.ambientAtTwilight],M=[1,.75,.75],T=[.8,.8,1],_=[.9*N.diffuseAtNoon,N.ambientAtNoon],x=[1,.98,.98],z=[.98,.98,1],D=[N.diffuseAtNoon,N.ambientAtNoon],C=[1,1,1],w=[1,1,1],H=_,L=x,R=z,X=I,S=M,F=T,G=[0,0],U=[0,0,0],V=[0,0,0];o<A||o>y?(G=O,U=E,V=P,u="night"):o<h?(G=f(o-A,s=h-A,O,I),U=f(o-A,s,E,M),V=f(o-A,s,P,T),u="sun rising"):o<g?(G=f(o-h,s=g-h,I,_),U=f(o-h,s,M,x),V=f(o-h,s,T,z),u="early morning"):o<m?(G=f(o-g,s=m-g,_,D),U=f(o-g,s,x,C),V=f(o-g,s,z,w),u="late morning"):o<b?(G=f(o-m,s=b-m,D,H),U=f(o-m,s,C,L),V=f(o-m,s,w,R),u="early afternoon"):o<p?(G=f(o-b,s=p-b,H,X),U=f(o-b,s,L,S),V=f(o-b,s,R,F),u="late afternoon"):o<y&&(G=f(o-p,s=y-p,X,O),U=f(o-p,s,S,E),V=f(o-p,s,F,P),u="sun setting");return{diffuse:{intensity:G[0],color:l.vec3f64.fromValues(U[0],U[1],U[2])},ambient:{intensity:G[1],color:l.vec3f64.fromValues(V[0],V[1],V[2])},timeOfDay:u}}(t,m);o.vec3.lerp(s.ambient.color,d.ambient.color,s.ambient.color,u),s.ambient.intensity=i.lerp(d.ambient.intensity,s.ambient.intensity,u),o.vec3.lerp(s.diffuse.color,d.diffuse.color,s.diffuse.color,u),s.diffuse.intensity=i.lerp(d.diffuse.intensity,s.diffuse.intensity,u)}return s.noonFactor=function(t,e){var a,n,o=t.valueOf();e.polarException===r.POLAR_EXCEPTION.MIDNIGHT_SUN?(a=o-60*(t.getHours()+48)*60*1e3-60*t.getMinutes()*1e3,n=a+432e6):e.polarException===r.POLAR_EXCEPTION.POLAR_NIGHT?(a=o-2,n=o-1):(a=e.sunrise.valueOf(),n=e.sunset.valueOf());var l=a+(n-a)/2;return 1-i.clamp(Math.abs(o-l)/432e5,0,1)}(t,m),s},e.computeDirection=function(t,n,c,f){f||(f=l.vec3f64.create());var m=u,d=a.mat4.identity(s);if("global"===c)r.getPosition(t,0,0,m),o.vec3.set(f,0,0,-1),a.mat4.rotateX(d,d,-m.azimuth),a.mat4.rotateY(d,d,-m.altitude),o.vec3.transformMat4(f,f,d);else{var g=e.settings.planarDirection,b=g.globalAngles,v=n[2],A=(Math.abs(v)-g.localAltitude)/(g.globalAltitude-g.localAltitude);(A=i.clamp(A,0,1))<1?(r.getPosition(t,n[1],n[0],m),m.azimuth=(1-A)*m.azimuth+A*b.azimuth,m.altitude=(1-A)*m.altitude+A*b.altitude):(m.azimuth=b.azimuth,m.altitude=b.altitude),o.vec3.set(f,0,-1,0),a.mat4.rotateZ(d,d,-m.azimuth),a.mat4.rotateX(d,d,-m.altitude),o.vec3.transformMat4(f,f,d)}return f},e.computeShadowsEnabled=function(t,i){if("global"===i)return!0;var a=e.settings.planarDirection,n=t[2];return Math.abs(n)<a.localAltitude};var s=n.mat4f64.create(),u={azimuth:0,altitude:0},c={ambient:{color:l.vec3f64.create(),intensity:0},diffuse:{color:l.vec3f64.create(),intensity:0,direction:l.vec3f64.create()},globalFactor:0,noonFactor:0};function f(t,e,i,a){for(var n=[],o=0;o<i.length;o++)n[o]=(a[o]-i[o])*t/e+i[o];return n}}));