/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../core/mathUtils","../../../core/maybe","../../../chunks/mat4","../../../chunks/mat4f64","../../../chunks/vec3","../../../chunks/vec3f64","../../ViewingMode","../../../chunks/SunCalc","./mathUtils"],(function(t,e,i,n,o,a,l,r,c,s){"use strict";const u={local:{altitude:1500,ambientAtNight:.1,ambientAtNoon:.45,ambientAtTwilight:.2,directAtNoon:.65,directAtTwilight:.7},global:{altitude:8e5,ambient:.015,direct:.75},planarDirection:{localAltitude:1e4,globalAltitude:1e6,globalAngles:{azimuth:1.3*Math.PI,altitude:.6*Math.PI}}};function m(t,n,o,r,s,m){a.set(m.ambient.color,1,1,1),m.ambient.intensity=u.global.ambient,a.set(m.direct.color,1,1,1),m.direct.intensity=u.global.direct;const h=n[2],f=e.clamp((Math.abs(h)-u.local.altitude)/(u.global.altitude-u.local.altitude),0,1);let b;if(m.globalFactor=f,i.isSome(t)&&(b=c.SunCalc.getTimes(t,n[1],n[0])),f<1){let n;if(i.isSome(t))n=T(t,b,r);else{const t=M(r);n={direct:{intensity:u.local.directAtNoon*t.direct,color:l.fromValues(1,1,1)},ambient:{intensity:u.local.ambientAtNoon*t.ambient,color:l.fromValues(1,1,1)},timeOfDay:"early afternoon"}}a.lerp(m.ambient.color,n.ambient.color,m.ambient.color,f),m.ambient.intensity=e.lerp(n.ambient.intensity,m.ambient.intensity,f),a.lerp(m.direct.color,n.direct.color,m.direct.color,f),m.direct.intensity=e.lerp(n.direct.intensity,m.direct.intensity,f),m.specularStrength="rainy"===r||"snowy"===r||"foggy"===r?0:1,m.environmentStrength="rainy"===r?.7:"snowy"===r||"foggy"===r?.75:1}m.noonFactor=i.isSome(t)?S(t,b):1,i.isSome(t)?g(t,n,o,m.direct.directionToLightSource):d(s,o,m.direct.directionToLightSource)}function d(t,e,i){e===r.ViewingMode.Global?a.normalize(V,t.eye):a.set(V,0,0,1),a.scale(x,t.viewForward,-1);const o=s.angle(x,V),l=Math.max(o-2*P,0),c=.85*l/(l+1),u=Math.max(P,o-P-c);n.fromRotation(O,-u,t.viewRight),a.transformMat4(i,x,O),a.add(i,i,a.scale(z,t.viewRight,C)),a.normalize(i,i)}function g(t,i,o,l){const s=A,m=n.identity(p);if(o===r.ViewingMode.Global)c.SunCalc.getPosition(t,0,0,s),a.set(l,0,0,-1),n.rotateX(m,m,-s.azimuth),n.rotateY(m,m,-s.altitude),a.transformMat4(l,l,m);else{const o=u.planarDirection,r=o.globalAngles,d=i[2];let g=(Math.abs(d)-o.localAltitude)/(o.globalAltitude-o.localAltitude);g=e.clamp(g,0,1),g<1?(c.SunCalc.getPosition(t,i[1],i[0],s),s.azimuth=(1-g)*s.azimuth+g*r.azimuth,s.altitude=(1-g)*s.altitude+g*r.altitude):(s.azimuth=r.azimuth,s.altitude=r.altitude),a.set(l,0,-1,0),n.rotateZ(m,m,-s.azimuth),n.rotateX(m,m,-s.altitude),a.transformMat4(l,l,m)}}function h(t,e){if(e===r.ViewingMode.Global)return!0;const i=u.planarDirection;return Math.abs(t)<i.localAltitude}function f(t,e,i,n,o){const a=t.getTime(),r=e.getTime()-a,c=Math.floor(r/i)+1,s=new Array(c);for(let u=0;u<c;++u)N.setTime(a+i*u),s[u]=l.create(),g(N,n,o,s[u]);return s}const b=l.fromValues(.5773502691896258,-.5773502691896258,.5773502691896258);let y=function(){this.ambient={color:l.fromValues(1,1,1),intensity:.55},this.direct={color:l.fromValues(1,1,1),intensity:.55,directionToLightSource:l.clone(b)},this.noonFactor=.5,this.globalFactor=0,this.specularStrength=1,this.environmentStrength=1};const p=o.create(),A={azimuth:0,altitude:0};function S(t,i){const n=t.valueOf();let o,a;i.polarException===c.SunCalc.PolarException.MIDNIGHT_SUN?(o=n-60*(t.getHours()+48)*60*1e3-60*t.getMinutes()*1e3,a=o+432e6):i.polarException===c.SunCalc.PolarException.POLAR_NIGHT?(o=n-2,a=n-1):(o=i.sunrise.valueOf(),a=i.sunset.valueOf());const l=o+(a-o)/2;return 1-e.clamp(Math.abs(n-l)/432e5,0,1)}function M(t){switch(t){case"disabled":case"sunny":case"cloudy":return{direct:1,ambient:1};case"rainy":return{direct:.4,ambient:1.2};case"snowy":return{direct:.5,ambient:1.3};case"foggy":return{direct:.2,ambient:1.6}}}function w(t,e){const i=(t[0]+t[1]+t[2])/3;for(let n=0;n<3;n++)t[n]=t[n]+(i-t[n])*e;return t}function T(t,e,i){const n=t.valueOf();let o,a;e.polarException===c.SunCalc.PolarException.MIDNIGHT_SUN?(o=n-60*(t.getHours()+48)*60*1e3-60*t.getMinutes()*1e3,a=o+432e6):e.polarException===c.SunCalc.PolarException.POLAR_NIGHT?(o=n-2,a=n-1):(o=e.sunrise.valueOf(),a=e.sunset.valueOf());const r=a-o,s=o+r/2,m=r/4,d=s-m,g=s+m,h=.06*r,f=o-h/2,b=o+h/2,y=a-h/2,p=a+h/2,A=u.local,S=[.01,A.ambientAtNight],T=[.8,.8,1],N=[.01,.01,.01],O=[A.directAtTwilight,A.ambientAtTwilight],V=[1,.6,.5],x=[.8,.8,1],z=[.9*A.directAtNoon,A.ambientAtNoon],P=[1,.98,.98],C=[.98,.98,1],D=[A.directAtNoon,A.ambientAtNoon],I=[1,1,1],E=[1,1,1],G=z,H=P,L=C,_=O,k=V,F=x;let R,U,X=[0,0],j=[0,0,0],Y=[0,0,0];n<f||n>p?(X=S,j=N,Y=T,U="night"):n<b?(R=b-f,X=v(n-f,R,S,O),j=v(n-f,R,N,V),Y=v(n-f,R,T,x),U="sun rising"):n<d?(R=d-b,X=v(n-b,R,O,z),j=v(n-b,R,V,P),Y=v(n-b,R,x,C),U="early morning"):n<s?(R=s-d,X=v(n-d,R,z,D),j=v(n-d,R,P,I),Y=v(n-d,R,C,E),U="late morning"):n<g?(R=g-s,X=v(n-s,R,D,G),j=v(n-s,R,I,H),Y=v(n-s,R,E,L),U="early afternoon"):n<y?(R=y-g,X=v(n-g,R,G,_),j=v(n-g,R,H,k),Y=v(n-g,R,L,F),U="late afternoon"):n<p&&(R=p-y,X=v(n-y,R,_,S),j=v(n-y,R,k,N),Y=v(n-y,R,F,T),U="sun setting");let Z=0;switch(i){case"rainy":case"foggy":Z=.9;case"snowy":Z=.5}Z>0&&(j=w(j,Z),Y=w(Y,Z));const q=l.fromValues(j[0],j[1],j[2]),B=l.fromValues(Y[0],Y[1],Y[2]),J=M(i);return{direct:{intensity:X[0]*J.direct,color:q},ambient:{intensity:X[1]*J.ambient,color:B},timeOfDay:U}}function v(t,e,i,n){const o=[];for(let a=0;a<i.length;a++)o[a]=(n[a]-i[a])*t/e+i[a];return o}const N=new Date(0),O=o.create(),V=l.create(),x=l.create(),z=l.create(),P=.25,C=.2;t.ColorAndIntensity=y,t.computeColorAndIntensity=m,t.computeDirectionsOverTime=f,t.computeShadowsEnabled=h,t.computeVirtualLightDirection=d,Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
