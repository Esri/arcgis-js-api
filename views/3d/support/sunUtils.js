/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{lerp as t,clamp as e}from"../../../core/mathUtils.js";import{d as i,i as n,r as o,o as a,g as r}from"../../../chunks/mat4.js";import{c as l}from"../../../chunks/mat4f64.js";import{s as c,h as s,n as u,g as m,m as d,a as g}from"../../../chunks/vec3.js";import{f as h,c as b,a as f}from"../../../chunks/vec3f64.js";import{ViewingMode as y}from"../../ViewingMode.js";import{S as p}from"../../../chunks/SunCalc.js";import{angle as A}from"./mathUtils.js";const w={local:{altitude:1500,ambientAtNight:.1,ambientAtNoon:.45,ambientAtTwilight:.2,directAtNoon:.65,directAtTwilight:.7},global:{altitude:8e5,ambient:.015,direct:.75},planarDirection:{localAltitude:1e4,globalAltitude:1e6,globalAngles:{azimuth:1.3*Math.PI,altitude:.6*Math.PI}}};function N(i,n,o,a,r,l,u){c(u.ambient.color,1,1,1),u.ambient.intensity=w.global.ambient,c(u.direct.color,1,1,1),u.direct.intensity=w.global.direct;const m=n[2],d=e((Math.abs(m)-w.local.altitude)/(w.global.altitude-w.local.altitude),0,1);let g;if(u.globalFactor=d,"sun"===l&&(g=p.getTimes(i,n[1],n[0])),d<1){let e;if("sun"===l)e=I(i,g,a);else{const t=D(a);e={direct:{intensity:w.local.directAtNoon*t.direct,color:h(1,1,1)},ambient:{intensity:w.local.ambientAtNoon*t.ambient,color:h(1,1,1)},timeOfDay:"early afternoon"}}s(u.ambient.color,e.ambient.color,u.ambient.color,d),u.ambient.intensity=t(e.ambient.intensity,u.ambient.intensity,d),s(u.direct.color,e.direct.color,u.direct.color,d),u.direct.intensity=t(e.direct.intensity,u.direct.intensity,d),u.specularStrength="rainy"===a||"snowy"===a||"foggy"===a?0:1,u.environmentStrength="rainy"===a?.7:"snowy"===a||"foggy"===a?.75:1}u.noonFactor="sun"===l?j(i,g):1,"sun"===l?M(i,n,o,u.direct.directionToLightSource):T(r,o,u.direct.directionToLightSource)}function T(t,e,n){e===y.Global?u(F,t.eye):c(F,0,0,1),m(L,t.viewForward,-1);const o=A(L,F),a=Math.max(o-2*U,0),r=.85*a/(a+1),l=Math.max(U,o-U-r);i(k,-l,t.viewRight),d(n,L,k),g(n,n,m(R,t.viewRight,_)),u(n,n)}function M(t,i,l,s){const u=z,m=n(P);if(l===y.Global)p.getPosition(t,0,0,u),c(s,0,0,-1),o(m,m,-u.azimuth),a(m,m,-u.altitude),d(s,s,m);else{const n=w.planarDirection,a=n.globalAngles,l=i[2];let g=(Math.abs(l)-n.localAltitude)/(n.globalAltitude-n.localAltitude);g=e(g,0,1),g<1?(p.getPosition(t,i[1],i[0],u),u.azimuth=(1-g)*u.azimuth+g*a.azimuth,u.altitude=(1-g)*u.altitude+g*a.altitude):(u.azimuth=a.azimuth,u.altitude=a.altitude),c(s,0,-1,0),r(m,m,-u.azimuth),o(m,m,-u.altitude),d(s,s,m)}}function v(t,e){if(e===y.Global)return!0;const i=w.planarDirection;return Math.abs(t)<i.localAltitude}function x(t,e,i,n,o){const a=t.getTime(),r=e.getTime()-a,l=Math.floor(r/i)+1,c=new Array(l);for(let s=0;s<l;++s)H.setTime(a+i*s),c[s]=b(),M(H,n,o,c[s]);return c}const S=h(.5773502691896258,-.5773502691896258,.5773502691896258);class O{constructor(){this.ambient={color:h(1,1,1),intensity:.55},this.direct={color:h(1,1,1),intensity:.55,directionToLightSource:f(S)},this.noonFactor=.5,this.globalFactor=0,this.specularStrength=1,this.environmentStrength=1}}const P=l(),z={azimuth:0,altitude:0};function j(t,i){const n=t.valueOf();let o,a;i.polarException===p.PolarException.MIDNIGHT_SUN?(o=n-60*(t.getHours()+48)*60*1e3-60*t.getMinutes()*1e3,a=o+432e6):i.polarException===p.PolarException.POLAR_NIGHT?(o=n-2,a=n-1):(o=i.sunrise.valueOf(),a=i.sunset.valueOf());const r=o+(a-o)/2;return 1-e(Math.abs(n-r)/432e5,0,1)}function D(t){switch(t){case"disabled":case"sunny":case"cloudy":return{direct:1,ambient:1};case"rainy":return{direct:.4,ambient:1.2};case"snowy":return{direct:.5,ambient:1.3};case"foggy":return{direct:.2,ambient:1.6}}}function E(t,e){const i=(t[0]+t[1]+t[2])/3;for(let n=0;n<3;n++)t[n]=t[n]+(i-t[n])*e;return t}function I(t,e,i){const n=t.valueOf();let o,a;e.polarException===p.PolarException.MIDNIGHT_SUN?(o=n-60*(t.getHours()+48)*60*1e3-60*t.getMinutes()*1e3,a=o+432e6):e.polarException===p.PolarException.POLAR_NIGHT?(o=n-2,a=n-1):(o=e.sunrise.valueOf(),a=e.sunset.valueOf());const r=a-o,l=o+r/2,c=r/4,s=l-c,u=l+c,m=.06*r,d=o-m/2,g=o+m/2,b=a-m/2,f=a+m/2,y=w.local,A=[.01,y.ambientAtNight],N=[.8,.8,1],T=[.01,.01,.01],M=[y.directAtTwilight,y.ambientAtTwilight],v=[1,.6,.5],x=[.8,.8,1],S=[.9*y.directAtNoon,y.ambientAtNoon],O=[1,.98,.98],P=[.98,.98,1],z=[y.directAtNoon,y.ambientAtNoon],j=[1,1,1],I=[1,1,1],H=S,k=O,F=P,L=M,R=v,U=x;let _,C,V=[0,0],q=[0,0,0],B=[0,0,0];n<d||n>f?(V=A,q=T,B=N,C="night"):n<g?(_=g-d,V=G(n-d,_,A,M),q=G(n-d,_,T,v),B=G(n-d,_,N,x),C="sun rising"):n<s?(_=s-g,V=G(n-g,_,M,S),q=G(n-g,_,v,O),B=G(n-g,_,x,P),C="early morning"):n<l?(_=l-s,V=G(n-s,_,S,z),q=G(n-s,_,O,j),B=G(n-s,_,P,I),C="late morning"):n<u?(_=u-l,V=G(n-l,_,z,H),q=G(n-l,_,j,k),B=G(n-l,_,I,F),C="early afternoon"):n<b?(_=b-u,V=G(n-u,_,H,L),q=G(n-u,_,k,R),B=G(n-u,_,F,U),C="late afternoon"):n<f&&(_=f-b,V=G(n-b,_,L,A),q=G(n-b,_,R,T),B=G(n-b,_,U,N),C="sun setting");let J=0;switch(i){case"rainy":case"foggy":J=.9;case"snowy":J=.5}J>0&&(q=E(q,J),B=E(B,J));const K=h(q[0],q[1],q[2]),Q=h(B[0],B[1],B[2]),W=D(i);return{direct:{intensity:V[0]*W.direct,color:K},ambient:{intensity:V[1]*W.ambient,color:Q},timeOfDay:C}}function G(t,e,i,n){const o=[];for(let a=0;a<i.length;a++)o[a]=(n[a]-i[a])*t/e+i[a];return o}const H=new Date(0),k=l(),F=b(),L=b(),R=b(),U=.25,_=.2;export{O as ColorAndIntensity,N as computeColorAndIntensity,x as computeDirectionsOverTime,v as computeShadowsEnabled};
