/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/maybe","../../../core/urlUtils","../../../core/promiseUtils","../../support/Scheduler","../webgl-engine/lib/WebGLDriverTest","../webgl-engine/lib/Texture"],(function(e,t,r,s,u,n,o,i){"use strict";let l=function(){function e(e,t,s,u){this._streamDataRequester=e,this._stage=t,this._textureOptions=s,this._textureRequests=new Map,this._frameTask=r.isSome(u)?u.registerTask(n.Task.TEXTURE_UNLOAD,(e=>this._frameTask.processQueue(e)),(()=>!1)):n.ImmediateTask}var l=e.prototype;return l.destroy=function(){this._frameTask.remove(),this._textureRequests.forEach((e=>this.releaseTextureRequest(e))),this._textureRequests.clear()},l.fromUrl=async function(e,t,s){u.throwIfAborted(s);const n=r.isSome(s)&&s.signal,o=this.makeUid(e,t);let i=this._textureRequests.get(o);if(!i){const r=u.createAbortController(),s=this._streamDataRequester.request(e,"image",{uid:o,signal:r.signal});i={referenceCount:0,texture:null,textureAsync:null,abortController:r},this._textureRequests.set(o,i),i.textureAsync=s.then((r=>{const s=this.createTexture(e,r,t);return i.texture=s,i.abortController=null,this.addToStage(s),{uid:o,texture:s}}),(e=>{throw i.abortController=null,e}))}return i.referenceCount++,new Promise(((e,t)=>{u.onAbort(n,(()=>{t(u.createAbortError())})),i.textureAsync.then(e,t)})).catch((e=>{throw this.release(o),e}))},l.fromData=function(e,t){const r=this.makeUid(e);let s=this._textureRequests.get(r);return s||(s={referenceCount:0,texture:t(),textureAsync:null,abortController:null},this.addToStage(s.texture),this._textureRequests.set(r,s)),s.referenceCount++,{uid:r,texture:s.texture}},l.release=function(e){if(!this._textureRequests)return;const t=this._textureRequests.get(e);t?(t.referenceCount<1&&console.warn("TextureCollection: reference count is < 1 for "+e),t.referenceCount--,t.referenceCount<1&&this._frameTask.schedule((()=>this.releaseNow(e)))):console.warn(`TextureCollection: texture doesn't exist: '${e}'`)},l.releaseNow=function(e){if(!this._textureRequests)return;const t=this._textureRequests.get(e);!t||t.referenceCount>0||(this.releaseTextureRequest(t),this._textureRequests.delete(e))},l.releaseTextureRequest=function(e){e.texture?this.removeFromStage(e.texture):e.abortController&&(e.abortController.abort(),e.abortController=null)},l.createTexture=function(e,t,r){const u={...this._textureOptions,powerOfTwoResizeMode:2};if(s.isSVG(e)){if(r||0===t.width&&0===t.height){const e=t.width?t.height/t.width:1;r=r||64,e>1?(t.width=Math.round(r/e),t.height=r):(t.width=r,t.height=Math.round(r*e))}this._stage.renderView&&o.testWebGLDriver(this._stage.renderView.renderingContext).svgAlwaysPremultipliesAlpha&&(u.preMultiplyAlpha=!1)}return u.width=t.width,u.height=t.height,new i.Texture(t,u)},l.addToStage=function(e){this._stage.add(e)},l.removeFromStage=function(e){this._stage.remove(e)},l.makeUid=function(e,t){return null!=t?`${e}.${t}px`:e},t._createClass(e,[{key:"test",get:function(){return{textureRequests:this._textureRequests}}}]),e}();e.TextureCollection=l,e.default=l,Object.defineProperty(e,"__esModule",{value:!0})}));
