/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
const t=1e-6,n=[0,0,0],r=[0,0,0];function i(t,i){const{data:s,size:e}=t,a=s.length/e;if(a<=0)return;const c=new H(t);L(n,c.minProj,c.maxProj),R(n,n,.5),Q(r,c.maxProj,c.minProj);const h=K(r),u=new J;u.quality=h,a<14&&(t={data:new Float64Array(c.buffer,112,42),size:3});const f=[0,0,0],m=[0,0,0],P=[0,0,0],j=[0,0,0],b=[0,0,0],x=[0,0,0],I=[0,0,0];switch(o(c,t,I,f,m,P,j,b,x,u)){case 1:return void z(n,r,i);case 2:return void G(t,j,i)}l(t,I,f,m,P,j,b,x,u),O(t,u.b0,u.b1,u.b2,Y,_);const N=[0,0,0];Q(N,_,Y),u.quality=K(N),u.quality<h?C(u.b0,u.b1,u.b2,Y,_,N,i):z(n,r,i)}function o(n,r,i,o,s,e,a,c,h,u){if(P(n,o,s),$(o,s)<t)return 1;Q(a,o,s),X(a,a);return b(r,o,a,e)<t?2:(Q(c,s,e),X(c,c),Q(h,e,o),X(h,h),W(i,c,a),X(i,i),d(r,i,a,c,h,u),0)}const s=[0,0,0],e=[0,0,0],a=[0,0,0],c=[0,0,0],h=[0,0,0],u=[0,0,0],f=[0,0,0],m=[0,0,0];function l(t,n,r,i,o,l,P,j,b){I(t,n,r,s,e),void 0!==s[0]&&(Q(a,s,r),X(a,a),Q(c,s,i),X(c,c),Q(h,s,o),X(h,h),W(u,c,l),X(u,u),W(f,h,P),X(f,f),W(m,a,j),X(m,m),d(t,u,l,c,a,b),d(t,f,P,h,c,b),d(t,m,j,a,h,b)),void 0!==e[0]&&(Q(a,e,r),X(a,a),Q(c,e,i),X(c,c),Q(h,e,o),X(h,h),W(u,c,l),X(u,u),W(f,h,P),X(f,f),W(m,a,j),X(m,m),d(t,u,l,c,a,b),d(t,f,P,h,c,b),d(t,m,j,a,h,b))}function P(t,n,r){let i=$(t.maxVert[0],t.minVert[0]),o=0;for(let s=1;s<7;++s){const n=$(t.maxVert[s],t.minVert[s]);n>i&&(i=n,o=s)}U(n,t.minVert[o]),U(r,t.maxVert[o])}const j=[0,0,0];function b(t,n,r,i){const{data:o,size:s}=t;let e=Number.NEGATIVE_INFINITY,a=0;for(let c=0;c<o.length;c+=s){j[0]=o[c]-n[0],j[1]=o[c+1]-n[1],j[2]=o[c+2]-n[2];const t=r[0]*j[0]+r[1]*j[1]+r[2]*j[2],i=r[0]*r[0]+r[1]*r[1]+r[2]*r[2],s=j[0]*j[0]+j[1]*j[1]+j[2]*j[2]-t*t/i;s>e&&(e=s,a=c)}return U(i,o,a),e}const x=[0,0];function I(n,r,i,o,s){T(n,r,x,s,o);const e=tt(i,r);x[1]-t<=e&&(o[0]=void 0),x[0]+t>=e&&(s[0]=void 0)}const N=[0,0,0],V=[0,0,0],y=[0,0,0],q=[0,0,0],w=[0,0,0],A=[0,0,0];function d(n,r,i,o,s,e){if(Z(r)<t)return;W(N,i,r),W(V,o,r),W(y,s,r),F(n,r,x),w[1]=x[0],q[1]=x[1],A[1]=q[1]-w[1];const a=[i,o,s],c=[N,V,y];for(let t=0;t<3;++t){F(n,a[t],x),w[0]=x[0],q[0]=x[1],F(n,c[t],x),w[2]=x[0],q[2]=x[1],A[0]=q[0]-w[0],A[2]=q[2]-w[2];const i=K(A);i<e.quality&&(U(e.b0,a[t]),U(e.b1,r),U(e.b2,c[t]),e.quality=i)}}const M=[0,0,0];function F(t,n,r){const{data:i,size:o}=t;r[0]=Number.POSITIVE_INFINITY,r[1]=Number.NEGATIVE_INFINITY;for(let s=0;s<i.length;s+=o){const t=i[s]*n[0]+i[s+1]*n[1]+i[s+2]*n[2];r[0]=Math.min(r[0],t),r[1]=Math.max(r[1],t)}}function T(t,n,r,i,o){const{data:s,size:e}=t;U(i,s),U(o,i),r[0]=tt(M,n),r[1]=r[0];for(let a=e;a<s.length;a+=e){const t=s[a]*n[0]+s[a+1]*n[1]+s[a+2]*n[2];t<r[0]&&(r[0]=t,U(i,s,a)),t>r[1]&&(r[1]=t,U(o,s,a))}}function z(t,n,r){U(r.center,t),R(r.halfSize,n,.5),r.quaternion[0]=0,r.quaternion[1]=0,r.quaternion[2]=0,r.quaternion[3]=1}const E=[0,0,0],v=[0,0,0],g=[0,0,0],Y=[0,0,0],_=[0,0,0],S=[0,0,0];function G(n,r,i){U(E,r),Math.abs(r[0])>Math.abs(r[1])&&Math.abs(r[0])>Math.abs(r[2])?E[0]=0:Math.abs(r[1])>Math.abs(r[2])?E[1]=0:E[2]=0,Z(E)<t&&(E[0]=E[1]=E[2]=1),W(v,r,E),X(v,v),W(g,r,v),X(g,g),O(n,r,v,g,Y,_),Q(S,_,Y),C(r,v,g,Y,_,S,i)}function O(t,n,r,i,o,s){F(t,n,x),o[0]=x[0],s[0]=x[1],F(t,r,x),o[1]=x[0],s[1]=x[1],F(t,i,x),o[2]=x[0],s[2]=x[1]}const p=[0,0,0],B=[1,0,0,0,1,0,0,0,1],k=[0,0,0];function C(t,n,r,i,o,s,e){B[0]=t[0],B[1]=t[1],B[2]=t[2],B[3]=n[0],B[4]=n[1],B[5]=n[2],B[6]=r[0],B[7]=r[1],B[8]=r[2],nt(e.quaternion,B),L(k,i,o),R(k,k,.5),R(e.center,t,k[0]),R(p,n,k[1]),L(e.center,e.center,p),R(p,r,k[2]),L(e.center,e.center,p),R(e.halfSize,s,.5)}const D=7;class H{constructor(t){this.minVert=new Array(D),this.maxVert=new Array(D);const n=64*D;this.buffer=new ArrayBuffer(n);let r=0;this.minProj=new Float64Array(this.buffer,r,D),r+=8*D,this.maxProj=new Float64Array(this.buffer,r,D),r+=8*D;for(let a=0;a<D;++a)this.minVert[a]=new Float64Array(this.buffer,r,3),r+=24;for(let a=0;a<D;++a)this.maxVert[a]=new Float64Array(this.buffer,r,3),r+=24;for(let a=0;a<D;++a)this.minProj[a]=Number.POSITIVE_INFINITY,this.maxProj[a]=Number.NEGATIVE_INFINITY;const i=new Array(D),o=new Array(D),{data:s,size:e}=t;for(let a=0;a<s.length;a+=e){let t=s[a];t<this.minProj[0]&&(this.minProj[0]=t,i[0]=a),t>this.maxProj[0]&&(this.maxProj[0]=t,o[0]=a),t=s[a+1],t<this.minProj[1]&&(this.minProj[1]=t,i[1]=a),t>this.maxProj[1]&&(this.maxProj[1]=t,o[1]=a),t=s[a+2],t<this.minProj[2]&&(this.minProj[2]=t,i[2]=a),t>this.maxProj[2]&&(this.maxProj[2]=t,o[2]=a),t=s[a]+s[a+1]+s[a+2],t<this.minProj[3]&&(this.minProj[3]=t,i[3]=a),t>this.maxProj[3]&&(this.maxProj[3]=t,o[3]=a),t=s[a]+s[a+1]-s[a+2],t<this.minProj[4]&&(this.minProj[4]=t,i[4]=a),t>this.maxProj[4]&&(this.maxProj[4]=t,o[4]=a),t=s[a]-s[a+1]+s[a+2],t<this.minProj[5]&&(this.minProj[5]=t,i[5]=a),t>this.maxProj[5]&&(this.maxProj[5]=t,o[5]=a),t=s[a]-s[a+1]-s[a+2],t<this.minProj[6]&&(this.minProj[6]=t,i[6]=a),t>this.maxProj[6]&&(this.maxProj[6]=t,o[6]=a)}for(let a=0;a<D;++a){let t=i[a];U(this.minVert[a],s,t),t=o[a],U(this.maxVert[a],s,t)}}}class J{constructor(){this.b0=[1,0,0],this.b1=[0,1,0],this.b2=[0,0,1],this.quality=0}}function K(t){return t[0]*t[1]+t[0]*t[2]+t[1]*t[2]}function L(t,n,r){t[0]=n[0]+r[0],t[1]=n[1]+r[1],t[2]=n[2]+r[2]}function Q(t,n,r){t[0]=n[0]-r[0],t[1]=n[1]-r[1],t[2]=n[2]-r[2]}function R(t,n,r){t[0]=n[0]*r,t[1]=n[1]*r,t[2]=n[2]*r}function U(t,n,r=0){t[0]=n[r+0],t[1]=n[r+1],t[2]=n[r+2]}function W(t,n,r){const i=n[0],o=n[1],s=n[2],e=r[0],a=r[1],c=r[2];t[0]=o*c-s*a,t[1]=s*e-i*c,t[2]=i*a-o*e}function X(t,n){const r=n[0]*n[0]+n[1]*n[1]+n[2]*n[2];if(r>0){const i=1/Math.sqrt(r);t[0]=n[0]*i,t[1]=n[1]*i,t[2]=n[2]*i}}function Z(t){return t[0]*t[0]+t[1]*t[1]+t[2]*t[2]}function $(t,n){const r=n[0]-t[0],i=n[1]-t[1],o=n[2]-t[2];return r*r+i*i+o*o}function tt(t,n){return t[0]*n[0]+t[1]*n[1]+t[2]*n[2]}function nt(t,n){const r=n[0]+n[4]+n[8];if(r>0){let i=Math.sqrt(r+1);t[3]=.5*i,i=.5/i,t[0]=(n[5]-n[7])*i,t[1]=(n[6]-n[2])*i,t[2]=(n[1]-n[3])*i}else{let r=0;n[4]>n[0]&&(r=1),n[8]>n[3*r+r]&&(r=2);const i=(r+1)%3,o=(r+2)%3;let s=Math.sqrt(n[3*r+r]-n[3*i+i]-n[3*o+o]+1);t[r]=.5*s,s=.5/s,t[3]=(n[3*i+o]-n[3*o+i])*s,t[i]=(n[3*i+r]+n[3*r+i])*s,t[o]=(n[3*o+r]+n[3*r+o])*s}}export{i as computeOBB};
