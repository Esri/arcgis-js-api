// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","../../../../core/compilerUtils","../../../../core/Logger","../../../../core/mathUtils","../../../../core/ObjectStack","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../mathUtils","../stack","./lineSegment","./plane","./ray","./vector"],(function(e,t,n,i,r,a,s,o,c,v,l,u,d,g,f,b){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UP=t.normal=t.rotate=t.transform=t.equals=t.setAltitudeAt=t.altitudeAt=t.axisAt=t.extrusionContainsPoint=t.distanceToSilhouette=t.distance=t.distance2=t.projectPointLocal=t.projectPoint=t.closestPoint=t.closestPointOnSilhouette=t.intersectRayClosestSilhouette=t.intersectRay=t.fromAABoundingRect=t.setExtent=t.elevate=t.updateUnboundedPlane=t.fromValues=t.copy=t.wrap=t.create=t.BoundedPlaneClass=void 0;var p=i.getLogger("esri.views.3d.support.geometryUtils.boundedPlane"),m=function(){this.plane=g.create(),this.origin=v.vec3f64.create(),this.basis1=v.vec3f64.create(),this.basis2=v.vec3f64.create()};function h(e){return void 0===e&&(e=t.UP),{plane:g.create(e.plane),origin:v.vec3f64.clone(e.origin),basis1:v.vec3f64.clone(e.basis1),basis2:v.vec3f64.clone(e.basis2)}}function P(e,t){return void 0===t&&(t=h()),y(e.origin,e.basis1,e.basis2,t)}function y(e,t,n,i){return void 0===i&&(i=h()),c.vec3.copy(i.origin,e),c.vec3.copy(i.basis1,t),c.vec3.copy(i.basis2,n),I(i),function(e,t){Math.abs(c.vec3.dot(e.basis1,e.basis2)/(c.vec3.length(e.basis1)*c.vec3.length(e.basis2)))>1e-6&&p.warn(t,"Provided basis vectors are not perpendicular");Math.abs(c.vec3.dot(e.basis1,O(e)))>1e-6&&p.warn(t,"Basis vectors and plane normal are not perpendicular");Math.abs(-c.vec3.dot(O(e),e.origin)-e.plane[3])>1e-6&&p.warn(t,"Plane offset is not consistent with plane origin")}(i,"fromValues()"),i}function I(e){g.fromVectorsAndPoint(e.basis2,e.basis1,e.origin,e.plane)}function S(e,t,n){e!==n&&P(e,n);var i=c.vec3.scale(u.sv3d.get(),O(e),t);return c.vec3.add(n.origin,n.origin,i),n.plane[3]-=t,n}function M(e,t){void 0===t&&(t=h());var n=(e[2]-e[0])/2,i=(e[3]-e[1])/2;return c.vec3.set(t.origin,e[0]+n,e[1]+i,0),c.vec3.set(t.basis1,n,0,0),c.vec3.set(t.basis2,0,i,0),g.fromValues(0,0,1,0,t.plane),t}function j(e,t,n){return!!g.intersectRay(e.plane,t,n)&&T(e,n)}function x(e,t,n){var i=U.get();E(e,t,i,U.get());for(var a=Number.POSITIVE_INFINITY,s=0,o=_;s<o.length;s++){var v=C(e,o[s],k.get()),d=u.sv3d.get();if(g.intersectLineSegment(i,v,d)){var f=l.directionFromTo(u.sv3d.get(),t.origin,d),b=Math.abs(r.acosClamped(c.vec3.dot(t.direction,f)));b<a&&(a=b,c.vec3.copy(n,d))}}return a===Number.POSITIVE_INFINITY?A(e,t,n):n}function A(e,t,n){if(j(e,t,n))return n;var i=U.get(),r=U.get();E(e,t,i,r);for(var a=Number.POSITIVE_INFINITY,s=0,o=_;s<o.length;s++){var v=C(e,o[s],k.get()),l=u.sv3d.get();if(g.intersectLineSegmentClamp(i,v,l)){var d=f.distance2(t,l);if(!g.isPointInside(r,l))continue;d<a&&(a=d,c.vec3.copy(n,l))}}return w(e,t.origin)<a&&V(e,t.origin,n),n}function V(e,t,n){var i=g.projectPoint(e.plane,t,u.sv3d.get()),r=d.projectPointClamp(q(e,e.basis1),i,-1,1,u.sv3d.get()),a=d.projectPointClamp(q(e,e.basis2),i,-1,1,u.sv3d.get());return c.vec3.subtract(n,c.vec3.add(u.sv3d.get(),r,a),e.origin),n}function N(e,t,n){var i=e.origin,r=e.basis1,a=e.basis2,s=c.vec3.subtract(u.sv3d.get(),t,i),o=b.projectPointSignedLength(r,s),v=b.projectPointSignedLength(a,s),l=b.projectPointSignedLength(O(e),s);return c.vec3.set(n,o,v,l)}function w(e,t){var n=N(e,t,u.sv3d.get()),i=e.basis1,r=e.basis2,a=c.vec3.length(i),s=c.vec3.length(r),o=Math.max(Math.abs(n[0])-a,0),v=Math.max(Math.abs(n[1])-s,0),l=n[2];return o*o+v*v+l*l}function L(e,t){var n=-e.plane[3];return b.projectPointSignedLength(O(e),t)-n}function O(e){return g.normal(e.plane)}function T(e,t){var n=c.vec3.subtract(u.sv3d.get(),t,e.origin),i=c.vec3.squaredLength(e.basis1),r=c.vec3.squaredLength(e.basis2),a=c.vec3.dot(e.basis1,n),s=c.vec3.dot(e.basis2,n);return-a-i<0&&a-i<0&&-s-r<0&&s-r<0}function q(e,t){var n=k.get();return c.vec3.copy(n.origin,e.origin),c.vec3.copy(n.vector,t),n}function C(e,t,n){var i=e.basis1,r=e.basis2,a=e.origin,s=c.vec3.scale(u.sv3d.get(),i,t.origin[0]),o=c.vec3.scale(u.sv3d.get(),r,t.origin[1]);c.vec3.add(n.origin,s,o),c.vec3.add(n.origin,n.origin,a);var v=c.vec3.scale(u.sv3d.get(),i,t.direction[0]),l=c.vec3.scale(u.sv3d.get(),r,t.direction[1]);return c.vec3.scale(n.vector,c.vec3.add(v,v,l),2),n}function E(e,t,n,i){var r=O(e);g.fromVectorsAndPoint(r,t.direction,t.origin,n),g.fromVectorsAndPoint(g.normal(n),r,t.origin,i)}t.BoundedPlaneClass=m,t.create=h,t.wrap=function(e,t,n){var i=F.get();return i.origin=e,i.basis1=t,i.basis2=n,i.plane=g.wrap(0,0,0,0),I(i),i},t.copy=P,t.fromValues=y,t.updateUnboundedPlane=I,t.elevate=S,t.setExtent=function(e,t,n){return M(t,n),S(n,L(e,e.origin),n),n},t.fromAABoundingRect=M,t.intersectRay=j,t.intersectRayClosestSilhouette=function(e,t,n){if(j(e,t,n))return n;var i=x(e,t,u.sv3d.get());return c.vec3.add(n,t.origin,c.vec3.scale(u.sv3d.get(),t.direction,c.vec3.distance(t.origin,i)/c.vec3.length(t.direction))),n},t.closestPointOnSilhouette=x,t.closestPoint=A,t.projectPoint=V,t.projectPointLocal=N,t.distance2=w,t.distance=function(e,t){return Math.sqrt(w(e,t))},t.distanceToSilhouette=function(e,t){for(var n=Number.NEGATIVE_INFINITY,i=0,r=_;i<r.length;i++){var a=C(e,r[i],k.get()),s=d.distance2(a,t);s>n&&(n=s)}return Math.sqrt(n)},t.extrusionContainsPoint=function(e,t){return g.isPointInside(e.plane,t)&&T(e,t)},t.axisAt=function(e,t,i,r){return function(e,t,i){switch(t){case 0:c.vec3.copy(i,e.basis1),c.vec3.normalize(i,i);break;case 1:c.vec3.copy(i,e.basis2),c.vec3.normalize(i,i);break;case 2:c.vec3.copy(i,O(e));break;default:n.neverReached(t)}return i}(e,i,r)},t.altitudeAt=L,t.setAltitudeAt=function(e,t,n,i){var r=L(e,t),a=c.vec3.scale(R,O(e),n-r);return c.vec3.add(i,t,a),i},t.equals=function(e,t){return c.vec3.exactEquals(e.basis1,t.basis1)&&c.vec3.exactEquals(e.basis2,t.basis2)&&c.vec3.exactEquals(e.origin,t.origin)},t.transform=function(e,t,n){return e!==n&&P(e,n),s.mat4.invert(B,t),s.mat4.transpose(B,B),c.vec3.transformMat4(n.basis1,e.basis1,B),c.vec3.transformMat4(n.basis2,e.basis2,B),c.vec3.transformMat4(g.normal(n.plane),g.normal(e.plane),B),c.vec3.transformMat4(n.origin,e.origin,t),g.setOffsetFromPoint(n.plane,n.origin,n.plane),n},t.rotate=function(e,t,n,i){return e!==i&&P(e,i),s.mat4.rotate(Y,s.mat4.identity(Y),t,n),c.vec3.transformMat4(i.basis1,e.basis1,Y),c.vec3.transformMat4(i.basis2,e.basis2,Y),I(i),i},t.normal=O,t.UP={plane:g.create(),origin:v.vec3f64.fromValues(0,0,0),basis1:v.vec3f64.fromValues(1,0,0),basis2:v.vec3f64.fromValues(0,1,0)};var U=new a.ObjectStack(g.create),k=new a.ObjectStack(d.create),R=v.vec3f64.create(),F=new a.ObjectStack((function(){return{origin:null,basis1:null,basis2:null,plane:null}})),_=[{origin:[-1,-1],direction:[1,0]},{origin:[1,-1],direction:[0,1]},{origin:[1,1],direction:[-1,0]},{origin:[-1,1],direction:[0,-1]}],B=o.mat4f64.create(),Y=o.mat4f64.create()}));