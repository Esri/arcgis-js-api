/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import t from"../../../core/Accessor.js";import s from"../../../core/Evented.js";import{destroyMaybe as r,isNone as i,isSome as o}from"../../../core/maybe.js";import{createResolver as n,isAbortError as a}from"../../../core/promiseUtils.js";import{property as l}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/arrayUtils.js";import"../../../core/has.js";import"../../../core/accessorSupport/ensureType.js";import{subclass as c}from"../../../core/accessorSupport/decorators/subclass.js";import{ElevationQuery as h}from"../layers/graphics/ElevationQuery.js";let u=class extends(s.EventedMixin(t)){constructor(e){super(e),this.im=new Array,this.ground=new Array,this.scene=new Array,this.handles=new Map,this.lastElevationQuery=null,this.elevationCacheEnabled=!1}destroy(){this._elevationQuery=r(this._elevationQuery)}get elevationQuery(){return i(this._elevationQuery)&&(this._elevationQuery=new h(this.view.resourceController.scheduler,this.view.spatialReference,(()=>this.view.map&&this.view.map.ground),{maximumAutoTileRequests:4})),this._elevationQuery}enableElevationCache(e){e||(this.lastElevationQuery=null),this.elevationCacheEnabled=e}getElevation(e,t,s,r,o){if(this.elevationCacheEnabled&&null!=this.lastElevationQuery){const i=this.lastElevationQuery;if(e===i.x&&t===i.y&&s===i.z&&r.equals(i.spatialReference)&&o===i.queryContext)return i.result}let n=null;return n=p(n,this.im,e,t,s,r,o),i(n)&&(n=p(n,this.ground,e,t,s,r,o)),"scene"===o&&(n=p(n,this.scene,e,t,s,r,o)),this.elevationCacheEnabled&&(this.lastElevationQuery={x:e,y:t,z:s,spatialReference:r,queryContext:o,result:n}),n}queryElevation(e,t,s,r,i,o=null,l=0){const c=n();return this.elevationQuery.queryElevation(e,t,o,l).then((o=>{"scene"===i&&(o=p(o,this.scene,e,t,s,r,i)),c.resolve(o)})).catch((o=>{a(o)?c.reject(o):c.resolve(this.getElevation(e,t,s,r,i))})),c.promise}register(e,t){this.handles.set(t,t.on("elevation-change",(e=>this.emit("elevation-change",e)))),this[e].push(t)}unregister(e){this.handles.has(e)&&(this.handles.get(e).remove(),this.handles.delete(e));for(const t of[this.im,this.ground,this.scene]){const s=t.indexOf(e);s>-1&&t.splice(s,1)}}};function p(e,t,s,r,i,n,a){for(const l of t){const t=l.getElevation(s,r,i,n,a);o(t)&&(e=o(e)?Math.max(t,e):t)}return e}e([l({constructOnly:!0})],u.prototype,"view",void 0),e([l({readOnly:!0,aliasOf:"view.basemapTerrain.spatialReference"})],u.prototype,"spatialReference",void 0),u=e([c("esri.views.3d.support.CombinedElevationProvider")],u);export{u as CombinedElevationProvider};
