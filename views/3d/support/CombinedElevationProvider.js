/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/Evented","../../../core/maybe","../../../core/promiseUtils","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../../geometry/support/spatialReferenceUtils","../layers/graphics/ElevationQuery"],(function(e,t,r,i,n,o,s,a,l,c,u,h,v){"use strict";function d(e,t,r,i,n,s,a){for(const l of t){const t=l.getElevation(r,i,n,s,a);o.isSome(t)&&(e=o.isSome(e)?Math.max(t,e):t)}return e}e.CombinedElevationProvider=function(e){function r(t){var r;return(r=e.call(this,t)||this)._im=new Array,r._ground=new Array,r._scene=new Array,r._handles=new Map,r.lastElevationQuery=null,r.elevationCacheEnabled=!1,r}t._inheritsLoose(r,e);var i=r.prototype;return i.destroy=function(){this._elevationQueryCached=o.destroyMaybe(this._elevationQueryCached)},i.enableElevationCache=function(e){e||(this.lastElevationQuery=null),this.elevationCacheEnabled=e},i.getElevation=function(e,t,r,i,n){if(this.elevationCacheEnabled&&null!=this.lastElevationQuery){const o=this.lastElevationQuery;if(e===o.x&&t===o.y&&r===o.z&&h.equals(i,o.spatialReference)&&n===o.queryContext)return o.result}let s=null;return s=d(s,this._im,e,t,r,i,n),o.isNone(s)&&(s=d(s,this._ground,e,t,r,i,n)),"scene"===n&&(s=d(s,this._scene,e,t,r,i,n)),this.elevationCacheEnabled&&(this.lastElevationQuery={x:e,y:t,z:r,spatialReference:i,queryContext:n,result:s}),s},i.queryElevation=function(e,t,r,i,n,o=null,a=0){const l=s.createResolver();return this._elevationQuery.queryElevation(e,t,o,a).then((o=>{"scene"===n&&(o=d(o,this._scene,e,t,r,i,n)),l.resolve(o)})).catch((o=>{s.isAbortError(o)?l.reject(o):l.resolve(this.getElevation(e,t,r,i,n))})),l.promise},i.register=function(e,t){this._handles.set(t,t.on("elevation-change",(e=>this.emit("elevation-change",e)))),this._providersFromContext(e).push(t)},i.unregister=function(e){this._handles.has(e)&&(this._handles.get(e).remove(),this._handles.delete(e));for(const t of[this._im,this._ground,this._scene]){const r=t.indexOf(e);r>-1&&t.splice(r,1)}},i._providersFromContext=function(e){switch(e){case"ground":return this._ground;case"im":return this._im;case"scene":return this._scene}},t._createClass(r,[{key:"spatialReference",get:function(){return this.view?.basemapTerrain?.spatialReference}},{key:"_elevationQuery",get:function(){return o.isNone(this._elevationQueryCached)&&(this._elevationQueryCached=new v.ElevationQuery(this.view.resourceController.scheduler,this.view.spatialReference,(()=>this.view.map&&this.view.map.ground),{maximumAutoTileRequests:4})),this._elevationQueryCached}}]),r}(n.EventedMixin(i)),r.__decorate([a.property({constructOnly:!0})],e.CombinedElevationProvider.prototype,"view",void 0),r.__decorate([a.property()],e.CombinedElevationProvider.prototype,"spatialReference",null),e.CombinedElevationProvider=r.__decorate([u.subclass("esri.views.3d.support.CombinedElevationProvider")],e.CombinedElevationProvider),Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
