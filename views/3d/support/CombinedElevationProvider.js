/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/Evented","../../../core/maybe","../../../core/promiseUtils","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../layers/graphics/ElevationQuery"],(function(e,t,r,i,n,o,s,a,l,c,u,h,v){"use strict";function d(e,t,r,i,n,s,a){for(const l of t){const t=l.getElevation(r,i,n,s,a);o.isSome(t)&&(e=o.isSome(e)?Math.max(t,e):t)}return e}e.CombinedElevationProvider=function(e){function r(t){var r;return(r=e.call(this,t)||this).im=new Array,r.ground=new Array,r.scene=new Array,r.handles=new Map,r.lastElevationQuery=null,r.elevationCacheEnabled=!1,r}t._inheritsLoose(r,e);var i=r.prototype;return i.destroy=function(){this._elevationQuery=o.destroyMaybe(this._elevationQuery)},i.enableElevationCache=function(e){e||(this.lastElevationQuery=null),this.elevationCacheEnabled=e},i.getElevation=function(e,t,r,i,n){if(this.elevationCacheEnabled&&null!=this.lastElevationQuery){const o=this.lastElevationQuery;if(e===o.x&&t===o.y&&r===o.z&&i.equals(o.spatialReference)&&n===o.queryContext)return o.result}let s=null;return s=d(s,this.im,e,t,r,i,n),o.isNone(s)&&(s=d(s,this.ground,e,t,r,i,n)),"scene"===n&&(s=d(s,this.scene,e,t,r,i,n)),this.elevationCacheEnabled&&(this.lastElevationQuery={x:e,y:t,z:r,spatialReference:i,queryContext:n,result:s}),s},i.queryElevation=function(e,t,r,i,n,o=null,a=0){const l=s.createResolver();return this.elevationQuery.queryElevation(e,t,o,a).then((o=>{"scene"===n&&(o=d(o,this.scene,e,t,r,i,n)),l.resolve(o)})).catch((o=>{s.isAbortError(o)?l.reject(o):l.resolve(this.getElevation(e,t,r,i,n))})),l.promise},i.register=function(e,t){this.handles.set(t,t.on("elevation-change",(e=>this.emit("elevation-change",e)))),this[e].push(t)},i.unregister=function(e){this.handles.has(e)&&(this.handles.get(e).remove(),this.handles.delete(e));for(const t of[this.im,this.ground,this.scene]){const r=t.indexOf(e);r>-1&&t.splice(r,1)}},t._createClass(r,[{key:"elevationQuery",get:function(){return o.isNone(this._elevationQuery)&&(this._elevationQuery=new v.ElevationQuery(this.view.resourceController.scheduler,this.view.spatialReference,(()=>this.view.map&&this.view.map.ground),{maximumAutoTileRequests:4})),this._elevationQuery}}]),r}(n.EventedMixin(i)),r.__decorate([a.property({constructOnly:!0})],e.CombinedElevationProvider.prototype,"view",void 0),r.__decorate([a.property({readOnly:!0,aliasOf:"view.basemapTerrain.spatialReference"})],e.CombinedElevationProvider.prototype,"spatialReference",void 0),e.CombinedElevationProvider=r.__decorate([h.subclass("esri.views.3d.support.CombinedElevationProvider")],e.CombinedElevationProvider),Object.defineProperty(e,"__esModule",{value:!0})}));
