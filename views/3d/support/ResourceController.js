/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/Handles","../../../core/maybe","../../../core/scheduling","../../../core/time","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/accessorSupport/ensureType","../../../core/Logger","../../../core/accessorSupport/decorators/subclass","./index","./MemoryController","./StreamDataLoader","../../support/Scheduler"],(function(e,t,r,o,s,a,n,i,l,u,c,d,h,_,p,m,y){"use strict";function C(e,t=(()=>performance.now())){return new g.ResourceController({view:e,now:t})}var g;e.ResourceControllerMain=function(e){function r(){var t;return(t=e.apply(this,arguments)||this).updating=!1,t}return t._inheritsLoose(r,e),r}(o),r.__decorate([l.property({readOnly:!0})],e.ResourceControllerMain.prototype,"updating",void 0),e.ResourceControllerMain=r.__decorate([h.subclass("esri.views.3d.support.ResourceController")],e.ResourceControllerMain),function(o){let u=function(e){function r(){var t;return(t=e.apply(this,arguments)||this)._scheduler=null,t._memoryController=null,t._streamDataLoader=null,t._cameraChangeTime=0,t._handles=new s,t._frameTask=null,t._scheduleTask=y.ImmediateTask,t}t._inheritsLoose(r,e);var o=r.prototype;return o.initialize=function(){this._cameraChangeTime=this.now(),this._scheduler=y.newScheduler(this.now),this._memoryController=p.newMemoryController(this.view),this._streamDataLoader=new m.default,this._streamDataLoader.setup(_.maxDownloadSlots,_.downloadSlotsPerClient,this._scheduler),this._handles.add([this.view.watch("state.camera",((e,t)=>this._cameraChangedHandler(e,t)),!0),this.view.watch("stationary",(()=>this._stationaryChangedHandler())),this._memoryController.events.on("updating-changed",(()=>this.notifyChange("updating")))]),this._frameTask=n.addFrameTask({update:e=>this.frame(e)}),this._scheduleTask=this._scheduler.registerTask(y.TaskPriority.RESOURCE_CONTROLLER)},o.destroy=function(){this._handles=a.destroyMaybe(this._handles),this._scheduleTask.remove(),this._frameTask=a.removeMaybe(this._frameTask),this._streamDataLoader=a.destroyMaybe(this._streamDataLoader),this._memoryController=a.destroyMaybe(this._memoryController),this._scheduler=a.destroyMaybe(this._scheduler)},o.schedule=function(e,t,r){return this._scheduleTask.schedule(e,t,r)},o.createStreamDataRequester=function(e){const t=this._streamDataLoader;return{request:(r,o,s)=>t.request(r,o,e,s),get busy(){return!t.hasDownloadSlots(e)}}},o.frame=function(e){this.view.suspended||this.view.stateManager&&(this.view.stateManager.step(i.SecondsFromMilliseconds(e.deltaTime)),!this._scheduler)||(this._scheduler.state=this.state,this._scheduler.updateBudget(e)?(this._memoryController.update(),this._scheduler.frame()):this._memoryController.updating&&this._memoryController.update())},o._cameraChangedHandler=function(e,t){e&&t&&e.almostEquals(t)||(this._cameraChangeTime=this._scheduler.now,this._scheduler.state=this.state)},o._stationaryChangedHandler=function(){this.memoryController.resetStableQuality()},t._createClass(r,[{key:"updating",get:function(){var e,t;return!!(null!=(e=this._memoryController)&&e.updating||null!=(t=this._streamDataLoader)&&t.updating)}},{key:"scheduler",get:function(){return this._scheduler}},{key:"memoryController",get:function(){return this._memoryController}},{key:"state",get:function(){const e=this.view;return e.animation?0:e.interacting||this._scheduler.now-this._cameraChangeTime<=c?1:2}},{key:"test",get:function(){return{getQueueStats:e=>this._streamDataLoader.test.loadQueue.getStatsForType(e),state:this.state}}}]),r}(e.ResourceControllerMain);r.__decorate([l.property({constructOnly:!0})],u.prototype,"view",void 0),r.__decorate([l.property({constructOnly:!0})],u.prototype,"now",void 0),r.__decorate([l.property()],u.prototype,"_scheduler",void 0),r.__decorate([l.property()],u.prototype,"_memoryController",void 0),r.__decorate([l.property()],u.prototype,"_streamDataLoader",void 0),r.__decorate([l.property({readOnly:!0})],u.prototype,"updating",null),u=r.__decorate([h.subclass("esri.views.3d.support.ResourceController")],u),o.ResourceController=u;const c=300}(g||(g={})),e.newResourceController=C,Object.defineProperty(e,"__esModule",{value:!0})}));
