/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/Handles","../../../core/maybe","../../../core/reactiveUtils","../../../core/scheduling","../../../core/time","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","./index","./MemoryController","./StreamDataLoader","../../support/Scheduler"],(function(e,t,r,s,o,a,i,n,l,d,u,c,h,_,p,y,m){"use strict";let f=function(e){function r(){var t;return(t=e.apply(this,arguments)||this).updating=!1,t}return t._inheritsLoose(r,e),r}(s);function g(e){return new v({view:e})}r.__decorate([d.property({readOnly:!0})],f.prototype,"updating",void 0),f=r.__decorate([h.subclass("esri.views.3d.support.ResourceControllerMain")],f);let v=function(e){function r(){var t;return(t=e.apply(this,arguments)||this)._scheduler=null,t._memoryController=null,t._streamDataLoader=null,t._scheduleTask=m.ImmediateTask,t._handles=new o,t._frameTask=null,t}t._inheritsLoose(r,e);var s=r.prototype;return s.initialize=function(){this._scheduler=m.newScheduler(),this._memoryController=p.newMemoryController(this.view),this._streamDataLoader=new y.StreamDataLoader,this._streamDataLoader.setup(_.maxDownloadSlots,_.downloadSlotsPerClient,this._scheduler),this._handles.add([i.watch((()=>this.view.state?.mode),(e=>this._scheduler.state=e),i.sync),i.watch((()=>this.view.stationary),(()=>this._stationaryChangedHandler()))]),this._frameTask=n.addFrameTask({update:e=>this._frame(e)}),this._scheduleTask=this._scheduler.registerTask(m.TaskPriority.RESOURCE_CONTROLLER)},s.destroy=function(){this._handles=a.destroyMaybe(this._handles),this._scheduleTask.remove(),this._frameTask=a.removeMaybe(this._frameTask),this._streamDataLoader=a.destroyMaybe(this._streamDataLoader),this._memoryController=a.destroyMaybe(this._memoryController),this._scheduler=a.destroyMaybe(this._scheduler)},s.schedule=function(e,t,r){return this._scheduleTask.schedule(e,t,r)},s.createStreamDataRequester=function(e){const t=this._streamDataLoader;return{request:(r,s,o)=>t.request(r,s,e,o),get busy(){return!t.hasDownloadSlots(e)}}},s._frame=function(e){this.view.suspended||this.view.stateManager&&(this.view.stateManager.step(l.secondsFromMilliseconds(e.deltaTime)),!this._scheduler)||(this._scheduler.updateBudget(e)?(this._memoryController.update(),this._scheduler.frame()):this._memoryController.updating&&this._memoryController.update())},s._stationaryChangedHandler=function(){this.memoryController.resetStableQuality()},t._createClass(r,[{key:"updating",get:function(){return!!(this._memoryController?.updating||this._streamDataLoader?.updating||this._scheduleTask?.updating)}},{key:"scheduler",get:function(){return this._scheduler}},{key:"memoryController",get:function(){return this._memoryController}},{key:"test",get:function(){return{getQueueStats:e=>this._streamDataLoader.test.loadQueue.getStatsForType(e)}}}]),r}(f);r.__decorate([d.property({constructOnly:!0})],v.prototype,"view",void 0),r.__decorate([d.property()],v.prototype,"_scheduler",void 0),r.__decorate([d.property()],v.prototype,"_memoryController",void 0),r.__decorate([d.property()],v.prototype,"_streamDataLoader",void 0),r.__decorate([d.property()],v.prototype,"_scheduleTask",void 0),r.__decorate([d.property({readOnly:!0})],v.prototype,"updating",null),v=r.__decorate([h.subclass("esri.views.3d.support.ResourceControllerImpl")],v);const C=100;e.INTERACTING_TIMEOUT=C,e.newResourceController=g,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
