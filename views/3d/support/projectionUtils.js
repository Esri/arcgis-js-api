// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","../../../core/mathUtils","../../../core/maybe","../../../core/unitUtils","../../../core/libs/gl-matrix-2/mat4","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../../../geometry/SpatialReference","../../../geometry/support/aaBoundingRect","../../../geometry/support/geodesicConstants","../webgl-engine/lib/BufferVectorMath"],(function(e,t,r,a,n,o,i,c,s,u,l,f){"use strict";var h,p,M,R,E,d,v,T;function S(e,t,r,a){return!(e.length<2)&&(2===e.length&&(D[0]=e[0],D[1]=e[1],D[2]=0,e=D),g(e,t,0,r,a,0,1))}function g(e,t,r,n,o,i,c){void 0===c&&(c=1);var s=N(t,o,Y);if(a.isNone(s))return!1;if(s===I){if(e===n&&r===i)return!0;for(var u=r+3*c,l=r,f=i;l<u;l++,f++)n[f]=e[l];return!0}var h=r+3*c;for(l=r,f=i;l<h;l+=3,f+=3)s(e,l,n,f);return!0}function m(e,r){return r.spatialReference===e?r.spatialReferenceId:(r.spatialReference=e,"metersPerUnit"in r&&(r.metersPerUnit=n.getMetersPerUnitForSR(e,1)),e.wkt===t.SphericalECEFSpatialReference.wkt?r.spatialReferenceId=1:e.isWGS84?r.spatialReferenceId=2:e.isWebMercator?r.spatialReferenceId=3:e.wkt===t.WGS84ECEFSpatialReference.wkt?r.spatialReferenceId=4:4490===e.wkid?r.spatialReferenceId=5:r.spatialReferenceId=0)}function I(e,t,r,a){e!==r&&(r[a++]=e[t++],r[a++]=e[t++],r[a]=e[t])}function b(e,t,r,a){r[a++]=B*(e[t++]/l.earthRadius),r[a++]=B*(Math.PI/2-2*Math.atan(Math.exp(-1*e[t++]/l.earthRadius))),r[a]=e[t]}function C(e,t,r,a){b(e,t,r,a),w(r,a,r,a)}function G(e,t,r,a){b(e,t,r,a),A(r,a,r,a)}function P(e,t,a,n){var o=.4999999*Math.PI,i=r.clamp(V*e[t+1],-o,o),c=Math.sin(i);a[n++]=V*e[t]*l.earthRadius,a[n++]=l.halfEarthRadius*Math.log((1+c)/(1-c)),a[n]=e[t+2]}function w(e,t,r,a){var n=l.earthRadius+e[t+2],o=V*e[t+1],i=V*e[t],c=Math.cos(o);r[a++]=Math.cos(i)*c*n,r[a++]=Math.sin(i)*c*n,r[a]=Math.sin(o)*n}function F(e,t,a,n){var o=f.Vec3Compact.length(e,t),i=r.asinClamped(e[t+2]/(0===o?1:o)),c=Math.atan2(e[t+1],e[t]);a[n++]=B*c,a[n++]=B*i,a[n]=o-l.earthRadius}function W(e,t,r,a){F(e,t,r,a),P(r,a,r,a)}function U(e,t,r,a){F(e,t,r,a),A(r,a,r,a)}function A(e,t,r,a){var n=l.earthEllipsoidConstants,o=V*e[t],i=V*e[t+1],c=e[t+2],s=Math.sin(i),u=Math.cos(i),f=n.a/Math.sqrt(1-n.e2*s*s);r[a++]=(f+c)*u*Math.cos(o),r[a++]=(f+c)*u*Math.sin(o),r[a++]=(f*(1-n.e2)+c)*s}function j(e,t,r,a){var n,o,i,c,s,u,f,h,p,M,R,E,d,v,T,S,g,m,I,b,C,G=l.earthEllipsoidConstants,P=e[t],w=e[t+1],F=e[t+2];n=Math.abs(F),o=P*P+w*w,i=Math.sqrt(o),c=o+F*F,s=Math.sqrt(c),b=Math.atan2(w,P),u=F*F/c,f=o/c,v=G.a2/s,T=G.a3-G.a4/s,f>.3?(h=n/s*(1+f*(G.a1+v+u*T)/s),I=Math.asin(h),M=h*h,p=Math.sqrt(1-M)):(p=i/s*(1-u*(G.a5-v-f*T)/s),I=Math.acos(p),M=1-p*p,h=Math.sqrt(M)),R=1-G.e2*M,E=G.a/Math.sqrt(R),I+=m=(S=p*(T=n-(d=G.a6*E)*h)-h*(v=i-E*p))/(d/R+(g=p*v+h*T)),C=g+S*m/2,F<0&&(I=-I),r[a++]=B*b,r[a++]=B*I,r[a]=C}function L(e,t,r,a){j(e,t,r,a),w(r,a,r,a)}function O(e,t,r,a){j(e,t,r,a),P(r,a,r,a)}Object.defineProperty(t,"__esModule",{value:!0}),t.getProjector=t.wgs84ComparableLonLatToECEF=t.vectorToWGS84ComparableLonLat=t.canProjectToWGS84ComparableLonLat=t.webMercator=t.boundingRectToBoundingRect=t.mbsToMbs=t.transformDirection=t.computeLinearTransformation=t.localLinearScaleFactors=t.bufferToBuffer=t.xyzToVector=t.pathsToPaths=t.vectorToVector=t.getProjectorName=t.canProject=t.WGS84ECEFSpatialReference=t.SphericalECEFSpatialReference=void 0,t.SphericalECEFSpatialReference=new s({wkt:'GEOCCS["Spherical geocentric",\n  DATUM["Not specified",\n    SPHEROID["Sphere",'+l.earthRadius+',0]],\n  PRIMEM["Greenwich",0.0,\n    AUTHORITY["EPSG","8901"]],\n  UNIT["m",1.0],\n  AXIS["Geocentric X",OTHER],\n  AXIS["Geocentric Y",EAST],\n  AXIS["Geocentric Z",NORTH]\n]'}),t.WGS84ECEFSpatialReference=new s({wkt:'GEOCCS["WGS 84",\n  DATUM["WGS_1984",\n    SPHEROID["WGS 84",6378137,298.257223563,\n      AUTHORITY["EPSG","7030"]],\n    AUTHORITY["EPSG","6326"]],\n  PRIMEM["Greenwich",0,\n    AUTHORITY["EPSG","8901"]],\n  UNIT["m",1.0,\n    AUTHORITY["EPSG","9001"]],\n  AXIS["Geocentric X",OTHER],\n  AXIS["Geocentric Y",OTHER],\n  AXIS["Geocentric Z",NORTH],\n  AUTHORITY["EPSG","4978"]\n]'}),t.canProject=function(e,t){return!!N(e,t,Y)},t.getProjectorName=function(e,t){var r=N(e,t,Y);return r===I?"copy3":r===w?"wgs84ToSphericalECEF":r===P?"wgs84ToWebMercator":r===A?"wgs84ToWGS84ECEF":r===b?"webMercatorToWGS84":r===C?"webMercatorToSphericalECEF":r===G?"webMercatorToWGS84ECEF":r===j?"wgs84ECEFToWGS84":r===L?"wgs84ECEFToSphericalECEF":r===O?"wgs84ECEFToWebMercator":r===F?"sphericalECEFToWGS84":r===W?"sphericalECEFToWebMercator":r===U?"sphericalECEFToWGS84ECEF":null},t.vectorToVector=S,t.pathsToPaths=function(e,t,r,a,n,o,i){void 0===i&&(i=0);for(var c=new Array,s=0,u=e;s<u.length;s++)for(var l=0,f=E=u[s];l<f.length;l++){var h=f[l];c.push(h[0],h[1],t?h[2]:i)}if(!g(c,a,0,c,o,0,c.length/3))return!1;var p=0;n.length=0;for(var M=0,R=e;M<R.length;M++){for(var E=R[M],d=new Array,v=0,T=E;v<T.length;v++){h=T[v];t&&r?d.push([c[p++],c[p++],c[p++],h[3]]):t?d.push([c[p++],c[p++],c[p++]]):r?(d.push([c[p++],c[p++],h[2]]),p++):(d.push([c[p++],c[p++]]),p++)}n.push(d)}return!0},t.xyzToVector=function(e,t,r,a,n,o){return D[0]=e,D[1]=t,D[2]=r,g(D,a,0,n,o,0,1)},t.bufferToBuffer=g,t.localLinearScaleFactors=function(e,t,r,a){var n=m(t,x),o=m(a,X);if(n===o&&0!==n||t.equals(a))return r[0]=1,r[1]=1,r[2]=1,!0;if(1===n){var c=i.vec3.length(e),s=c/Math.sqrt(e[0]*e[0]+e[1]*e[1]),u=c/l.earthRadius;if(3===o)return r[0]=s*u,r[1]=s*u,r[2]=1,!0;if(2===o||5===o){var f=180/(l.earthRadius*Math.PI);return r[0]=f*s*u,r[1]=f*u,r[2]=1,!0}}return!1},t.computeLinearTransformation=function(e,t,r,n){var i=m(e,x),c=m(n,X);if(i===c&&1!==c&&(0!==i||e.equals(n)))return o.mat4.identity(r),o.mat4.translate(r,r,t),!0;if(1===c){var s=y[i][6],u=y[6][c];if(a.isNone(s)||a.isNone(u))return!1;s(t,0,_,0),u(_,0,z,0);var l=V*_[0],f=V*_[1],h=Math.sin(l),p=Math.cos(l),M=Math.sin(f),R=Math.cos(f),E=r;return E[0]=-h,E[4]=-M*p,E[8]=R*p,E[12]=z[0],E[1]=p,E[5]=-M*h,E[9]=R*h,E[13]=z[1],E[2]=0,E[6]=R,E[10]=M,E[14]=z[2],E[3]=0,E[7]=0,E[11]=0,E[15]=1,!0}if(3===c&&(2===i||1===i)){s=y[i][6];if(a.isNone(s))return!1;s(t,0,_,0);var d=V*_[1];P(_,0,z,0),o.mat4.identity(r),o.mat4.translate(r,r,z);var v=1/Math.cos(d);return o.mat4.scale(r,r,[v,v,1]),!0}return!1},t.transformDirection=function(e,t,r,a,n){i.vec3.copy(Z,e),i.vec3.add(J,e,t),S(Z,r,Z,n),S(J,r,J,n),i.vec3.subtract(a,J,Z),i.vec3.normalize(a,a)},t.mbsToMbs=function(e,t,r,n){var o=H(t,n,k);if(o.projector===I)return r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],!0;if(a.isNone(o.projector))return!1;var i=o.source,c=o.dest;if(3===c.spatialReferenceId){var s=y[i.spatialReferenceId][2];if(a.isNone(s))return!1;s(e,0,_,0);var u=Math.abs(V*_[1])+Math.asin(e[3]/(l.earthRadius+e[2]));if(P(_,0,r,0),u>.9999*Math.PI)r[3]=Number.MAX_VALUE;else{var f=1/Math.cos(u);r[3]=f*e[3]}return!0}return o.projector(e,0,r,0),r[3]=e[3]*i.metersPerUnit/c.metersPerUnit,!0},t.boundingRectToBoundingRect=function(e,t,r,a){return null!=e&&(t.equals(a)?(u.set(r,e),!0):(D[0]=e[0],D[1]=e[1],D[2]=0,!!g(D,t,0,D,a,0,1)&&(r[0]=D[0],r[1]=D[1],D[0]=e[2],D[1]=e[3],D[2]=0,!!g(D,t,0,D,a,0,1)&&(r[2]=D[0],r[3]=D[1],!0))))},function(e){e.x2lon=function(e){return e/l.earthRadius},e.y2lat=function(e){return Math.PI/2-2*Math.atan(Math.exp(-1*e/l.earthRadius))},e.lon2x=function(e){return e*l.earthRadius},e.lat2y=function(e){var t=Math.sin(e);return l.earthRadius/2*Math.log((1+t)/(1-t))}}(t.webMercator||(t.webMercator={})),t.canProjectToWGS84ComparableLonLat=function(e){var t=m(e,x);return!!y[t][6]},t.vectorToWGS84ComparableLonLat=function(e,t,r){var n=m(t,x),o=y[n][6];return!a.isNone(o)&&(o(e,0,D,0),r!==D&&(r[0]=D[0],r[1]=D[1],r.length>2&&(r[2]=D[2])),!0)},t.wgs84ComparableLonLatToECEF=function(e,t,r,a){void 0===a&&(a=0);var n=l.earthRadius+a,o=Math.cos(r);e[0]=Math.cos(t)*o*n,e[1]=Math.sin(t)*o*n,e[2]=Math.sin(r)*n};var y=((h={})[2]=((p={})[5]=null,p[6]=I,p[1]=w,p[0]=null,p[3]=P,p[2]=I,p[4]=A,p),h[5]=((M={})[5]=I,M[6]=I,M[1]=w,M[0]=null,M[3]=null,M[2]=null,M[4]=A,M),h[3]=((R={})[5]=null,R[6]=b,R[1]=C,R[0]=null,R[3]=I,R[2]=b,R[4]=G,R),h[4]=((E={})[5]=j,E[6]=j,E[1]=L,E[0]=null,E[3]=O,E[2]=j,E[4]=I,E),h[1]=((d={})[5]=F,d[6]=F,d[1]=I,d[0]=null,d[3]=W,d[2]=F,d[4]=U,d),h[0]=((v={})[5]=null,v[6]=null,v[1]=null,v[0]=I,v[3]=null,v[2]=null,v[4]=null,v),h[6]=((T={})[5]=null,T[6]=I,T[1]=w,T[0]=null,T[3]=null,T[2]=I,T[4]=A,T),h);function N(e,t,r){return void 0===r&&(r=q()),H(e,t,r).projector}function H(e,t,r){if(r.source.spatialReference===e&&r.dest.spatialReference===t)return r;var a=m(e,r.source),n=m(t,r.dest);return 0===a&&0===n?e.equals(t)?r.projector=I:r.projector=null:r.projector=y[a][n],r}function q(){return{source:{spatialReference:null,spatialReferenceId:0,metersPerUnit:1},dest:{spatialReference:null,spatialReferenceId:0,metersPerUnit:1},projector:I}}t.getProjector=N;var x={spatialReference:null,spatialReferenceId:0},X={spatialReference:null,spatialReferenceId:0},Y=q(),k=q(),V=r.deg2rad(1),B=r.rad2deg(1),D=c.vec3f64.create(),_=c.vec3f64.create(),z=c.vec3f64.create(),Z=c.vec3f64.create(),J=c.vec3f64.create()}));