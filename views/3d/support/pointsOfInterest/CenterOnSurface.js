/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/has","../../../../core/Logger","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/decorators/subclass","../../../../core/urlUtils","../../../../core/uuid","../../../../portal/support/resourceExtension","../../../../geometry/Point","../../../../core/mathUtils","../../../../chunks/vec3f64","../../../../chunks/vec3","../../../../geometry/projectionEllipsoid","../debugFlags","../PropertiesPool","./PointOfInterest"],(function(e,t,r,s,i,a,n,o,c,u,l,d,p,f,h,_,S,y,A){"use strict";const g=Array;e.CenterOnSurface=function(e){function r(r){var s;return(s=e.call(this,r)||this)._propertiesPool=new y.PropertiesPool({location:d,renderLocation:g},t._assertThisInitialized(s)),s._currentSurfaceAltitude=0,s._latestSurfaceAltitude=0,s.distance=0,s.renderLocation=f.create(),s.updating=!1,s}t._inheritsLoose(r,e);var s=r.prototype;return s.initialize=function(){this._frameWorker=this.scheduler.registerTask(this.task,(()=>this._measureSurfaceAltitude()),(()=>this.updating)),this._measureSurfaceAltitude()},s.destroy=function(){this._frameWorker&&(this._frameWorker.remove(),this._frameWorker=null),this._propertiesPool.destroy(),this._propertiesPool=null},s.updateRenderLocation=function(){this._set("updating",!0),this._updateRenderLocation()},s.update=function(){this._measureSurfaceAltitude(),this._updateRenderLocation()},s._measureSurfaceAltitude=function(){this._latestSurfaceAltitude=this.estimateSurfaceAltitudeAtCenter(),this._updateRenderLocation(),this._set("updating",!1)},s._updateRenderLocation=function(){const e=m;let t=this.calculateSurfaceIntersection(this._currentSurfaceAltitude,e);const r=this._currentSurfaceAltitude!==this._latestSurfaceAltitude;!t&&r&&(t=this.calculateSurfaceIntersection(this._latestSurfaceAltitude,e),t&&(this._currentSurfaceAltitude=this._latestSurfaceAltitude));const s=C;if(t&&this.latestSurfaceAltitudeChangesDistanceSignificantly(e,s)&&(h.copy(e,s),this._currentSurfaceAltitude=this._latestSurfaceAltitude),t){const t=h.distance(this.state.camera.eye,e);t!==this._get("distance")&&this._set("distance",t)}else{const t=this.state.camera;h.scale(e,t.viewForward,this._get("distance")),h.add(e,e,t.eye)}h.exactEquals(this._get("renderLocation"),e)||this._set("renderLocation",h.copy(this._propertiesPool.get("renderLocation"),e))},s.calculateSurfaceIntersection=function(e,t){const r=this.state.camera;if(!this.renderCoordsHelper.intersectManifold(r.ray,e,t))return!1;if(this.state.isGlobal){const s=_.getReferenceEllipsoid(this.renderCoordsHelper.spatialReference).radius,i=s+e,a=h.squaredLength(r.eye),n=a<i*i,o=h.distance(r.eye,t);if(n&&o>s/4){const e=i-Math.sqrt(a);return h.scale(t,r.viewForward,e),h.add(t,t,r.eye),!0}}else{const e=this.surface.ready&&this.surface.extent;e&&(t[0]=p.clamp(t[0],e[0],e[2]),t[1]=p.clamp(t[1],e[1],e[3]))}return!0},s.latestSurfaceAltitudeChangesDistanceSignificantly=function(e,t){if(this._latestSurfaceAltitude===this._currentSurfaceAltitude||null==e)return!1;if(this.calculateSurfaceIntersection(this._latestSurfaceAltitude,t)){const r=this.state.camera.eye,s=h.distance(r,e),i=h.distance(r,t),a=Math.abs(i-s);if(S.TESTS_DISABLE_UPDATE_THRESHOLDS)return!0;if(a/s>O)return!0}return!1},t._createClass(r,[{key:"location",get:function(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}},{key:"estimatedSurfaceAltitude",get:function(){return this._latestSurfaceAltitude}}]),r}(A.PointOfInterest),r.__decorate([n.property({constructOnly:!0})],e.CenterOnSurface.prototype,"scheduler",void 0),r.__decorate([n.property({constructOnly:!0})],e.CenterOnSurface.prototype,"task",void 0),r.__decorate([n.property({readOnly:!0})],e.CenterOnSurface.prototype,"distance",void 0),r.__decorate([n.property({constructOnly:!0})],e.CenterOnSurface.prototype,"estimateSurfaceAltitudeAtCenter",void 0),r.__decorate([n.property({readOnly:!0,dependsOn:["renderLocation"]})],e.CenterOnSurface.prototype,"location",null),r.__decorate([n.property({readOnly:!0})],e.CenterOnSurface.prototype,"renderLocation",void 0),r.__decorate([n.property({readOnly:!0})],e.CenterOnSurface.prototype,"updating",void 0),e.CenterOnSurface=r.__decorate([o.subclass("esri.views.3d.support.CenterOnSurface")],e.CenterOnSurface);const O=.05,m=f.create(),C=f.create();var L=e.CenterOnSurface;e.default=L,Object.defineProperty(e,"__esModule",{value:!0})}));
