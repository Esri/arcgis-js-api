/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{_ as t}from"../../../../chunks/tslib.es6.js";import{clamp as e}from"../../../../core/mathUtils.js";import{removeMaybe as r,destroyMaybe as s,isSome as i}from"../../../../core/maybe.js";import{property as o}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/arrayUtils.js";import"../../../../core/has.js";import"../../../../core/accessorSupport/ensureType.js";import{subclass as a}from"../../../../core/accessorSupport/decorators/subclass.js";import{c,i as n,g as u,a as l,k as p,p as d}from"../../../../chunks/vec3.js";import{c as h}from"../../../../chunks/vec3f64.js";import f from"../../../../geometry/Point.js";import{projectBoundingRect as m}from"../../../../geometry/projection.js";import{getReferenceEllipsoid as _}from"../../../../geometry/projectionEllipsoid.js";import{create as y}from"../../../../geometry/support/aaBoundingRect.js";import S from"../debugFlags.js";import{PropertiesPool as g}from"../PropertiesPool.js";import{PointOfInterest as A}from"./PointOfInterest.js";const j=Array;let k=class extends A{constructor(t){super(t),this._propertiesPool=new g({location:f,renderLocation:j},this),this._currentSurfaceAltitude=0,this._latestSurfaceAltitude=0,this.cameraName="camera",this.distance=0,this.renderLocation=h(),this.updating=!1}initialize(){this._frameWorker=this.scheduler.registerTask(this.task,this),this.runTask()}destroy(){this._frameWorker=r(this._frameWorker),this._propertiesPool=s(this._propertiesPool)}get _camera(){return this.state[this.cameraName]}get location(){const t=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,t,this.state.spatialReference),t}updateRenderLocation(){this.updating=!0,this._updateRenderLocation()}get estimatedSurfaceAltitude(){return this._latestSurfaceAltitude}get running(){return this.updating}runTask(){this._latestSurfaceAltitude=this.estimateSurfaceAltitudeAtCenter(),this._updateRenderLocation(),this.updating=!1}_updateRenderLocation(){const t=L;let e=this._calculateSurfaceIntersection(this._currentSurfaceAltitude,t);const r=this._currentSurfaceAltitude!==this._latestSurfaceAltitude;!e&&r&&(e=this._calculateSurfaceIntersection(this._latestSurfaceAltitude,t),e&&(this._currentSurfaceAltitude=this._latestSurfaceAltitude));const s=C;e&&this._latestSurfaceAltitudeChangesDistanceSignificantly(t,s)&&(c(t,s),this._currentSurfaceAltitude=this._latestSurfaceAltitude),e?this.distance=n(this._camera.eye,t):(u(t,this._camera.viewForward,this._get("distance")),l(t,t,this._camera.eye)),p(this._get("renderLocation"),t)||this._set("renderLocation",c(this._propertiesPool.get("renderLocation"),t))}_calculateSurfaceIntersection(t,r){const s=this._camera;if(!this.renderCoordsHelper.intersectManifold(s.ray,t,r))return!1;if(this.state.isGlobal){const e=_(this.renderCoordsHelper.spatialReference).radius,i=e+t,o=d(s.eye),a=o<i*i,c=n(s.eye,r);if(a&&c>e/4){const t=i-Math.sqrt(o);return u(r,s.viewForward,t),l(r,r,s.eye),!0}}else{const t=this.surface.ready?this.surface.extent:null;i(t)&&m(t,this.surface.spatialReference,O,this.renderCoordsHelper.spatialReference)&&(r[0]=e(r[0],O[0],O[2]),r[1]=e(r[1],O[1],O[3]))}return!0}_latestSurfaceAltitudeChangesDistanceSignificantly(t,e){if(this._latestSurfaceAltitude===this._currentSurfaceAltitude||null==t)return!1;if(this._calculateSurfaceIntersection(this._latestSurfaceAltitude,e)){if(S.TESTS_DISABLE_OPTIMIZATIONS)return!0;const r=this._camera.eye,s=n(r,t),i=n(r,e);if(Math.abs(i-s)/s>v)return!0}return!1}};t([o({constructOnly:!0})],k.prototype,"scheduler",void 0),t([o({constructOnly:!0})],k.prototype,"task",void 0),t([o({constructOnly:!0})],k.prototype,"cameraName",void 0),t([o()],k.prototype,"distance",void 0),t([o({constructOnly:!0})],k.prototype,"estimateSurfaceAltitudeAtCenter",void 0),t([o({readOnly:!0})],k.prototype,"location",null),t([o({readOnly:!0})],k.prototype,"renderLocation",void 0),t([o()],k.prototype,"updating",void 0),k=t([a("esri.views.3d.support.CenterOnSurface")],k);const v=.05,L=h(),C=h(),O=y();export{k as CenterOnSurface};
