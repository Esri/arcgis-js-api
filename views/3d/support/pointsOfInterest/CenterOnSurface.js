/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/mathUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/accessorSupport/ensureType","../../../../core/Logger","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/Point","../../../../geometry/projectionEllipsoid","../debugFlags","../PropertiesPool","./PointOfInterest"],(function(e,t,r,i,s,n,a,o,c,u,l,d,p,f,h,_){"use strict";const S=Array;e.CenterOnSurface=function(e){function r(r){var i;return(i=e.call(this,r)||this)._propertiesPool=new h.PropertiesPool({location:d,renderLocation:S},t._assertThisInitialized(i)),i._currentSurfaceAltitude=0,i._latestSurfaceAltitude=0,i.distance=0,i.renderLocation=l.create(),i.updating=!1,i}t._inheritsLoose(r,e);var s=r.prototype;return s.initialize=function(){this._frameWorker=this.scheduler.registerTask(this.task,this),this.runTask()},s.destroy=function(){this._frameWorker&&(this._frameWorker.remove(),this._frameWorker=null),this._propertiesPool.destroy(),this._propertiesPool=null},s.updateRenderLocation=function(){this.updating=!0,this._updateRenderLocation()},s.runTask=function(){this._latestSurfaceAltitude=this.estimateSurfaceAltitudeAtCenter(),this._updateRenderLocation(),this.updating=!1},s._updateRenderLocation=function(){const e=g;let t=this.calculateSurfaceIntersection(this._currentSurfaceAltitude,e);const r=this._currentSurfaceAltitude!==this._latestSurfaceAltitude;!t&&r&&(t=this.calculateSurfaceIntersection(this._latestSurfaceAltitude,e),t&&(this._currentSurfaceAltitude=this._latestSurfaceAltitude));const i=A;if(t&&this.latestSurfaceAltitudeChangesDistanceSignificantly(e,i)&&(u.copy(e,i),this._currentSurfaceAltitude=this._latestSurfaceAltitude),t)this.distance=u.distance(this.state.camera.eye,e);else{const t=this.state.camera;u.scale(e,t.viewForward,this._get("distance")),u.add(e,e,t.eye)}u.exactEquals(this._get("renderLocation"),e)||this._set("renderLocation",u.copy(this._propertiesPool.get("renderLocation"),e))},s.calculateSurfaceIntersection=function(e,t){const r=this.state.camera;if(!this.renderCoordsHelper.intersectManifold(r.ray,e,t))return!1;if(this.state.isGlobal){const i=p.getReferenceEllipsoid(this.renderCoordsHelper.spatialReference).radius,s=i+e,n=u.squaredLength(r.eye),a=n<s*s,o=u.distance(r.eye,t);if(a&&o>i/4){const e=s-Math.sqrt(n);return u.scale(t,r.viewForward,e),u.add(t,t,r.eye),!0}}else{const e=this.surface.ready&&this.surface.extent;e&&(t[0]=i.clamp(t[0],e[0],e[2]),t[1]=i.clamp(t[1],e[1],e[3]))}return!0},s.latestSurfaceAltitudeChangesDistanceSignificantly=function(e,t){if(this._latestSurfaceAltitude===this._currentSurfaceAltitude||null==e)return!1;if(this.calculateSurfaceIntersection(this._latestSurfaceAltitude,t)){if(f.TESTS_DISABLE_UPDATE_THRESHOLDS)return!0;const r=this.state.camera.eye,i=u.distance(r,e),s=u.distance(r,t);if(Math.abs(s-i)/i>y)return!0}return!1},t._createClass(r,[{key:"location",get:function(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}},{key:"estimatedSurfaceAltitude",get:function(){return this._latestSurfaceAltitude}},{key:"running",get:function(){return this.updating}}]),r}(_.PointOfInterest),r.__decorate([s.property({constructOnly:!0})],e.CenterOnSurface.prototype,"scheduler",void 0),r.__decorate([s.property({constructOnly:!0})],e.CenterOnSurface.prototype,"task",void 0),r.__decorate([s.property()],e.CenterOnSurface.prototype,"distance",void 0),r.__decorate([s.property({constructOnly:!0})],e.CenterOnSurface.prototype,"estimateSurfaceAltitudeAtCenter",void 0),r.__decorate([s.property({readOnly:!0})],e.CenterOnSurface.prototype,"location",null),r.__decorate([s.property({readOnly:!0})],e.CenterOnSurface.prototype,"renderLocation",void 0),r.__decorate([s.property()],e.CenterOnSurface.prototype,"updating",void 0),e.CenterOnSurface=r.__decorate([c.subclass("esri.views.3d.support.CenterOnSurface")],e.CenterOnSurface);const y=.05,g=l.create(),A=l.create();var C=e.CenterOnSurface;e.default=C,Object.defineProperty(e,"__esModule",{value:!0})}));
