/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/mathUtils","../../../../core/screenUtils","../../../../core/accessorSupport/decorators/property","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/Point","../../../../geometry/support/ray","../PropertiesPool","./PointOfInterest","../../webgl-engine/lib/Camera","../../../support/Scheduler"],(function(e,t,r,o,n,i,s,c,a,d,u,p,l,h,y,_,f,g){"use strict";const P=Array;e.Focus=function(e){function r(r){var o;return(o=e.call(this,r)||this)._propertiesPool=new y.PropertiesPool({location:l,renderLocation:P},t._assertThisInitialized(o)),o._dirty=!0,o.renderLocation=o._propertiesPool.get("renderLocation"),o}t._inheritsLoose(r,e);var i=r.prototype;return i.initialize=function(){this.handles.add([this.centerOnSurface.watch("renderLocation",(()=>this.updateRenderLocation())),this.state.watch("contentCamera",(()=>this.updateRenderLocation()))]),this.scheduler&&this.handles.add(this.scheduler.registerTask(g.TaskPriority.POINT_OF_INTEREST_FREQUENT,this))},i.destroy=function(){this._propertiesPool.destroy(),this._propertiesPool=null},i.runTask=function(){const e=this._get("renderLocation"),t=this.centerOnSurface.renderLocation,r=this.renderCoordsHelper,n=this.state.contentCamera;this._dirty=!1,r.worldUpAtPosition(t,S);const i=Math.max(0,(Math.acos(u.dot(S,n.viewForward))-.5*Math.PI)*(n.aboveGround?1:-1));if(Number.isNaN(i)){if(!e||!u.equals(e,t)){const e=this._propertiesPool.get("renderLocation");u.copy(e,t),this._set("renderLocation",e)}return}const s=1-o.clamp(i/(.5*Math.PI),0,1),c=s*s*s;this._calculateScreenHorizontalEdgeOnSurface(L);const a=this._propertiesPool.get("renderLocation");u.lerp(a,t,L,c),e&&u.equals(e,a)||this._set("renderLocation",a)},i._calculateScreenHorizontalEdgeOnSurface=function(e){const t=this.state.contentCamera,r=t.getRenderCenter(n.createRenderScreenPointArray3());if(r[1]=t.aboveGround?t.padding[f.PaddingSide.BOTTOM]:t.fullHeight-t.padding[f.PaddingSide.TOP],this.estimateSurfaceIntersectionAtRenderPoint(r,e))return e;const o=this.renderCoordsHelper.getAltitude(this.centerOnSurface.renderLocation);if(t.unprojectFromRenderScreen(r,O)){u.subtract(O,O,t.eye);const r=u.normalize(O,O);if(this.renderCoordsHelper.intersectManifold(h.wrap(t.eye,r),o,e))return e}return this.renderCoordsHelper.setAltitude(e,o,t.eye)},i.updateRenderLocation=function(){this._dirty=!0},t._createClass(r,[{key:"updating",get:function(){return this._dirty||this.centerOnSurface.updating}},{key:"location",get:function(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}},{key:"running",get:function(){return this._dirty}}]),r}(_.PointOfInterest),r.__decorate([i.property()],e.Focus.prototype,"_dirty",void 0),r.__decorate([i.property({constructOnly:!0})],e.Focus.prototype,"scheduler",void 0),r.__decorate([i.property({constructOnly:!0})],e.Focus.prototype,"centerOnSurface",void 0),r.__decorate([i.property({constructOnly:!0})],e.Focus.prototype,"estimateSurfaceIntersectionAtRenderPoint",void 0),r.__decorate([i.property({readOnly:!0})],e.Focus.prototype,"updating",null),r.__decorate([i.property({readOnly:!0})],e.Focus.prototype,"location",null),r.__decorate([i.property({readOnly:!0})],e.Focus.prototype,"renderLocation",void 0),e.Focus=r.__decorate([d.subclass("esri.views.3d.support.CenterOnSurface")],e.Focus);const S=p.create(),O=p.create(),L=p.create(),m=e.Focus;e.default=m,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
