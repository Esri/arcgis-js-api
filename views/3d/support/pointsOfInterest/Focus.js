/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import{clamp as t}from"../../../../core/mathUtils.js";import{watch as r}from"../../../../core/reactiveUtils.js";import{createRenderScreenPointArray3 as o}from"../../../../core/screenUtils.js";import{property as s}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/arrayUtils.js";import"../../../../core/has.js";import"../../../../core/accessorSupport/ensureType.js";import{subclass as i}from"../../../../core/accessorSupport/decorators/subclass.js";import{e as n,z as a,c,h as d,b as p,n as l}from"../../../../chunks/vec3.js";import{c as h}from"../../../../chunks/vec3f64.js";import u from"../../../../geometry/Point.js";import{wrap as m}from"../../../../geometry/support/ray.js";import{PropertiesPool as f}from"../PropertiesPool.js";import{PointOfInterest as y}from"./PointOfInterest.js";import{PaddingSide as g}from"../../webgl-engine/lib/Camera.js";import{TaskPriority as _}from"../../../support/Scheduler.js";const O=Array;let j=class extends y{constructor(e){super(e),this._propertiesPool=new f({location:u,renderLocation:O},this),this._dirty=!0,this.renderLocation=this._propertiesPool.get("renderLocation")}initialize(){this.handles.add([r((()=>this.centerOnSurface.renderLocation),(()=>this.updateRenderLocation())),r((()=>this.state.contentCamera),(()=>this.updateRenderLocation()))]),this.scheduler&&this.handles.add(this.scheduler.registerTask(_.POINT_OF_INTEREST_FREQUENT,this))}destroy(){this._propertiesPool.destroy(),this._propertiesPool=null}get updating(){return this._dirty||this.centerOnSurface.updating}get location(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}get running(){return this._dirty}runTask(){const e=this._get("renderLocation"),r=this.centerOnSurface.renderLocation,o=this.renderCoordsHelper,s=this.state.contentCamera;this._dirty=!1,o.worldUpAtPosition(r,P);const i=Math.max(0,(Math.acos(n(P,s.viewForward))-.5*Math.PI)*(s.aboveGround?1:-1));if(Number.isNaN(i)){if(!e||!a(e,r)){const e=this._propertiesPool.get("renderLocation");c(e,r),this._set("renderLocation",e)}return}const p=1-t(i/(.5*Math.PI),0,1),l=p*p*p;this._calculateScreenHorizontalEdgeOnSurface(L);const h=this._propertiesPool.get("renderLocation");d(h,r,L,l),e&&a(e,h)||this._set("renderLocation",h)}_calculateScreenHorizontalEdgeOnSurface(e){const t=this.state.contentCamera,r=t.getRenderCenter(o());if(r[1]=t.aboveGround?t.padding[g.BOTTOM]:t.fullHeight-t.padding[g.TOP],this.estimateSurfaceIntersectionAtRenderPoint(r,e))return e;const s=this.renderCoordsHelper.getAltitude(this.centerOnSurface.renderLocation);if(t.unprojectFromRenderScreen(r,S)){p(S,S,t.eye);const r=l(S,S);if(this.renderCoordsHelper.intersectManifold(m(t.eye,r),s,e))return e}return this.renderCoordsHelper.setAltitude(e,s,t.eye)}updateRenderLocation(){this._dirty=!0}};e([s()],j.prototype,"_dirty",void 0),e([s({constructOnly:!0})],j.prototype,"scheduler",void 0),e([s({constructOnly:!0})],j.prototype,"centerOnSurface",void 0),e([s({constructOnly:!0})],j.prototype,"estimateSurfaceIntersectionAtRenderPoint",void 0),e([s({readOnly:!0})],j.prototype,"updating",null),e([s({readOnly:!0})],j.prototype,"location",null),e([s({readOnly:!0})],j.prototype,"renderLocation",void 0),j=e([i("esri.views.3d.support.CenterOnSurface")],j);const P=h(),S=h(),L=h();export{j as Focus};
