/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/has","../../../../core/Logger","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/decorators/subclass","../../../../core/urlUtils","../../../../core/uuid","../../../../portal/support/resourceExtension","../../../../core/promiseUtils","../../../../geometry/Point","../../../../chunks/vec3f64","../../../../chunks/vec3","../../../../core/watchUtils","../PropertiesPool","./PointOfInterest"],(function(e,t,r,o,n,i,a,s,u,c,d,l,p,h,_,y,f,g){"use strict";const m=Array;e.CameraOnSurface=function(e){function r(r){var o;return(o=e.call(this,r)||this)._dirty=!1,o._propertiesPool=new f.PropertiesPool({location:p,renderLocation:m},t._assertThisInitialized(o)),o._estimatedSurfaceAltitude=0,o._pendingElevationQueryController=null,o.renderLocation=h.create(),o}t._inheritsLoose(r,e);var o=r.prototype;return o.initialize=function(){if(this.scheduler&&this.handles.add(this.scheduler.registerTask(this.task,(()=>this._measureSurfaceAltitude()),(()=>this._needsUpdate()))),this._measureSurfaceAltitude(),this.map){const e=()=>this._setDirty();this.handles.add([y.on(this.map,"ground.layers","change",e,e,e)])}},o.destroy=function(){this._cancelPendingRequest(),this._propertiesPool.destroy(),this._propertiesPool=null},o.updateRenderLocation=function(){this._setDirty(),this._updateRenderLocation()},o.update=function(){this._measureSurfaceAltitude(),this._updateRenderLocation()},o._setDirty=function(){this._dirty||(this._dirty=!0,this.notifyChange("updating"))},o._needsUpdate=function(){return!this._pendingElevationQueryController&&this._dirty},o._cancelPendingRequest=function(){const e=this._pendingElevationQueryController;e&&(this._pendingElevationQueryController=null,e.abort(),this.notifyChange("updating"))},o._measureSurfaceAltitude=function(){if(this._cancelPendingRequest(),this._dirty=!1,this.notifyChange("updating"),!this.map||!this.map.ground)return void this._updateSurfaceAltitude(0);this.renderCoordsHelper.fromRenderCoords(this.state.camera.eye,S,this.state.spatialReference);let e=l.createAbortController();this.map.ground.queryElevation(S,{signal:e.signal}).then((e=>this._updateSurfaceAltitude(e.geometry.z))).catch((e=>{l.isAbortError(e)||this._updateSurfaceAltitude(0)})).catch((()=>{})).then((()=>{this._pendingElevationQueryController===e&&(this._pendingElevationQueryController=null,this.notifyChange("updating")),e=null})),this._pendingElevationQueryController=e},o._updateSurfaceAltitude=function(e){this._estimatedSurfaceAltitude!==e&&(this._estimatedSurfaceAltitude=e,this._updateRenderLocation())},o._updateRenderLocation=function(){_.copy(C,this.state.camera.eye),this.renderCoordsHelper.setAltitude(this._estimatedSurfaceAltitude,C),_.exactEquals(this._get("renderLocation"),C)||this._set("renderLocation",_.copy(this._propertiesPool.get("renderLocation"),C))},t._createClass(r,[{key:"location",get:function(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}},{key:"updating",get:function(){return this._dirty||null!=this._pendingElevationQueryController}}]),r}(g.PointOfInterest),r.__decorate([a.property({constructOnly:!0})],e.CameraOnSurface.prototype,"scheduler",void 0),r.__decorate([a.property({constructOnly:!0})],e.CameraOnSurface.prototype,"task",void 0),r.__decorate([a.property({readOnly:!0,dependsOn:["renderLocation"]})],e.CameraOnSurface.prototype,"location",null),r.__decorate([a.property({constructOnly:!0})],e.CameraOnSurface.prototype,"map",void 0),r.__decorate([a.property({readOnly:!0})],e.CameraOnSurface.prototype,"renderLocation",void 0),r.__decorate([a.property({readOnly:!0})],e.CameraOnSurface.prototype,"updating",null),e.CameraOnSurface=r.__decorate([s.subclass("esri.views.3d.support.CameraOnSurface")],e.CameraOnSurface);const C=h.create(),S=new p;var v=e.CameraOnSurface;e.default=v,Object.defineProperty(e,"__esModule",{value:!0})}));
