/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Handles","../../../../core/maybe","../../../../core/watchUtils","../../../../core/accessorSupport/decorators/property","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/support/ray","../debugFlags","../debugUtils","../PropertiesPool","../geometryUtils/ray","./CameraOnSurface","./CenterOnSurface","./ContentGeometryUpdates","./Focus","./StableSurfaceCenter","./SurfaceGeometryUpdates","../../webgl-engine/lib/Intersector","../../webgl-engine/lib/IntersectorInterfaces","../../webgl-engine/lib/verticalOffsetUtils","../../../support/Scheduler"],(function(e,t,r,n,s,i,o,a,c,u,d,h,f,p,_,l,y,O,C,I,m,A,S,w,P,g,v,T,b){"use strict";e.PointsOfInterest=function(e){function r(r){var n;return(n=e.call(this,r)||this)._handles=new s,n._tmpRay=_.create(),n._centerRayDirty=!0,n._surfaceAltitudeAtCenter=0,n._surfaceAltitudeAtCenterDirty=!0,n._contentAltitudeAtCenter=0,n._contentAltitudeAtCenterDirty=!0,n._propertiesPool=new O.PropertiesPool({renderPointOfView:R},t._assertThisInitialized(n)),n.renderPointOfView=p.create(),n._pois=new Array,n._debugCenters=new Map,n}t._inheritsLoose(r,e);var n=r.prototype;return n.initialize=function(){var e;const{state:t,basemapTerrain:r,renderCoordsHelper:n,map:s}=this.view;this._surfaceIntersector=g.newIntersector(t.viewingMode),t.isGlobal?this._surfaceIntersector.options.backfacesTerrain=!1:this._surfaceIntersector.options.backfacesTerrain=!0,this._surfaceIntersector.options.invisibleTerrain=!1,this._surfaceIntersector.options.store=v.StoreResults.MIN,this._contentIntersector=g.newIntersector(t.viewingMode);const a=()=>this._estimateSurfaceAltitudeAtCenter(),c=this.view.resourceController.scheduler,u=i.unwrap(null==(e=this.view.basemapTerrain)?void 0:e.elevationQueryCache),d={state:t,scheduler:c,surface:r,renderCoordsHelper:n};this._set("centerOnSurfaceInfrequent",new m.default({...d,task:b.TaskPriority.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:a})),this._set("centerOnSurfaceFrequent",new m.default({...d,task:b.TaskPriority.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:a})),this._set("contentCenterOnSurface",new m.default({...d,task:b.TaskPriority.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:a,cameraName:"contentCamera"})),this._set("centerOnContent",new m.default({...d,task:b.TaskPriority.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:()=>this._estimateContentAltitudeAtCenter()})),this._set("cameraOnSurface",new I.default({...d,cache:u,task:b.TaskPriority.POINT_OF_INTEREST_INFREQUENT,map:s})),this._set("contentCameraOnSurface",new I.default({...d,cache:u,task:b.TaskPriority.POINT_OF_INTEREST_INFREQUENT,map:s,cameraName:"contentCamera"})),this._set("surfaceGeometryUpdates",new P.SurfaceGeometryUpdates({...d,centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]})),this._set("contentGeometryUpdates",new A.ContentGeometryUpdates({contentLayerViews:this.view.allLayerViews,renderCoordsHelper:n})),this._set("surfaceOrigin",new w.StableSurfaceCenter({cache:u,view:this.view})),this._set("focus",new S.default({state:t,scheduler:c,surface:r,renderCoordsHelper:n,centerOnSurface:this.contentCenterOnSurface,estimateSurfaceIntersectionAtRenderPoint:(e,t)=>this._estimateSurfaceIntersectionAtRenderPoint(e,this.view.state.contentCamera,t)})),this._pois.push(this.centerOnContent,this.centerOnSurfaceFrequent,this.centerOnSurfaceInfrequent,this.contentCenterOnSurface,this.cameraOnSurface,this.contentCameraOnSurface,this.focus);const h=this.view.graphics;this._debugCenters.set(this.centerOnContent,new y.PointGraphics(h,"red","CenterOnContent")),this._debugCenters.set(this.centerOnSurfaceFrequent,new y.PointGraphics(h,"red","CenterOnSurface")),this._debugCenters.set(this.centerOnSurfaceInfrequent,new y.PointGraphics(h,"red","CenterOnSurface")),this._debugCenters.set(this.contentCenterOnSurface,new y.PointGraphics(h,"red","ContentCenterOnSurface")),this._debugCenters.set(this.cameraOnSurface,new y.PointGraphics(h,"blue","CameraOnSurface")),this._debugCenters.set(this.contentCameraOnSurface,new y.PointGraphics(h,"blue","ContentCameraOnSurface")),this._debugCenters.set(this.focus,new y.PointGraphics(h,"green","Focus")),this._handles.add([t.watch("camera",(e=>this._cameraChanged(e)),!0),r.watch("extent",(()=>this._updateCenterPointsOfInterest())),o.whenFalse(r,"updating",(()=>this._updateCenterPointsOfInterest()),!0),this.surfaceGeometryUpdates.events.on("request-update",(()=>this._updateCenterPointsOfInterest())),this.contentGeometryUpdates.events.on("request-update",(()=>this._updateCenterOnContent())),o.init(l,"SHOW_POI",(e=>this._setDebug(e)))]),this._cameraChanged(this.view.state.camera);for(const i of this._pois)i.runTask()},n.destroy=function(){this._setDebug(!1),this._handles.destroy(),this._propertiesPool.destroy();for(const e of this._pois)e.destroy();this.surfaceOrigin.destroy()},n._estimateContentAltitudeAtCenter=function(){if(!this._contentAltitudeAtCenterDirty)return this._contentAltitudeAtCenter;this._contentAltitudeAtCenterDirty=!1;const e=this.centerRay;return i.isNone(e)||(this.view.sceneIntersectionHelper.intersectRay(e,this._contentIntersector,N,U)?this._contentAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(N):this._contentAltitudeAtCenter=this._estimateSurfaceAltitudeAtCenter()),this._contentAltitudeAtCenter},n._estimateSurfaceAltitudeAtCenter=function(){if(!this.view.basemapTerrain)return 0;if(!this._surfaceAltitudeAtCenterDirty)return this._surfaceAltitudeAtCenter;this._surfaceAltitudeAtCenterDirty=!1;const e=this.centerRay;if(i.isNone(e))return this._surfaceAltitudeAtCenter;const t=e.origin,r=f.add(N,e.origin,e.direction);return this._surfaceIntersector.resetWithRay(e,this.view.state.camera),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,t,r),this._surfaceIntersector.results.min.getIntersectionPoint(N)&&(this._surfaceAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(N)),this._surfaceAltitudeAtCenter},n._estimateSurfaceIntersectionAtRenderPoint=function(e,t,r){const n=C.fromRenderAtEye(t,e,E);if(i.isNone(n))return null;const s=n.origin,o=f.add(N,n.origin,n.direction);return this._surfaceIntersector.resetWithRay(n,t),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,s,o),this._surfaceIntersector.results.min.getIntersectionPoint(r)?r:null},n._cameraChanged=function(e){this._updateCenterPointsOfInterest();const t=e.eye;f.exactEquals(this.renderPointOfView,t)||this._set("renderPointOfView",f.copy(this._propertiesPool.get("renderPointOfView"),t))},n._updateCenterPointsOfInterest=function(){this._centerRayDirty=!0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenterDirty=!0;for(const e of this._pois)e.updateRenderLocation()},n._updateCenterOnContent=function(){this._contentAltitudeAtCenterDirty=!0,this.centerOnContent.updateRenderLocation()},n._setDebug=function(e){if(!e)return this._debugCenters.forEach((e=>e.hide())),void this._handles.remove("debug");for(const t of this._pois)this._handles.add(o.init(t,"renderLocation",(e=>this._debugCenters.get(t).show(e,t.renderCoordsHelper.spatialReference))),"debug")},t._createClass(r,[{key:"updating",get:function(){var e;return!!(null!=(e=this.surfaceGeometryUpdates)&&e.updating||this._pois.some((e=>e.updating)))}},{key:"centerRay",get:function(){return this._centerRayDirty&&(this._centerRay=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(this.view.state.camera,this._tmpRay),this._centerRayDirty=!1),this._centerRay}},{key:"test",get:function(){return{update:()=>{this.surfaceGeometryUpdates.runTask();for(const e of this._pois)e.runTask()},surfaceGeometryUpdates:this.surfaceGeometryUpdates}}}]),r}(n),r.__decorate([a.property({readOnly:!0})],e.PointsOfInterest.prototype,"centerOnContent",void 0),r.__decorate([a.property({readOnly:!0})],e.PointsOfInterest.prototype,"centerOnSurfaceFrequent",void 0),r.__decorate([a.property({readOnly:!0})],e.PointsOfInterest.prototype,"centerOnSurfaceInfrequent",void 0),r.__decorate([a.property({readOnly:!0})],e.PointsOfInterest.prototype,"contentCenterOnSurface",void 0),r.__decorate([a.property({readOnly:!0})],e.PointsOfInterest.prototype,"cameraOnSurface",void 0),r.__decorate([a.property({readOnly:!0})],e.PointsOfInterest.prototype,"contentCameraOnSurface",void 0),r.__decorate([a.property({readOnly:!0})],e.PointsOfInterest.prototype,"focus",void 0),r.__decorate([a.property({readOnly:!0})],e.PointsOfInterest.prototype,"renderPointOfView",void 0),r.__decorate([a.property({readOnly:!0})],e.PointsOfInterest.prototype,"surfaceOrigin",void 0),r.__decorate([a.property({readOnly:!0})],e.PointsOfInterest.prototype,"contentGeometryUpdates",void 0),r.__decorate([a.property({readOnly:!0})],e.PointsOfInterest.prototype,"surfaceGeometryUpdates",void 0),r.__decorate([a.property({constructOnly:!0})],e.PointsOfInterest.prototype,"view",void 0),r.__decorate([a.property({readOnly:!0})],e.PointsOfInterest.prototype,"updating",null),e.PointsOfInterest=r.__decorate([h.subclass("esri.views.3d.support.PointsOfInterest")],e.PointsOfInterest);const R=Array,N=p.create(),E=_.create(),U={exclude:new Set([T.TERRAIN_ID])},k=e.PointsOfInterest;e.default=k,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
