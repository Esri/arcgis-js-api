/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../../core/compilerUtils","../../../core/mathUtils","../../../chunks/mat4","../../../chunks/mat4f64","../../../chunks/vec3","../../../chunks/vec3f64","../../../geometry/projection","../../../geometry/projectionEllipsoid","../../../geometry/support/aaBoundingBox","../../../geometry/support/aaBoundingRect","../../../geometry/support/lineSegment","../../../geometry/support/plane","../../../geometry/support/ray","./intersectionUtils"],(function(e,t,i,n,r,o,s,c,a,l,d,h,p,u,g){"use strict";const x=.5*Math.PI,f=x/Math.PI*180;let m=function(){function e(e){this.renderCoordsHelper=e.renderCoordsHelper,this.extent=new Array(4),this.planes=new Array(6),this.maxSpan=0,this.center={origin:s.create(),direction:s.create()};for(let t=0;t<4;t++)this.extent[t]={origin:s.create(),direction:s.create(),cap:{next:null,direction:s.create()}},this.planes[t]=p.create();this.planes[4]=p.create(),this.planes[5]=p.create(),this.planesWithoutFar=this.planes.slice(0,5)}var r=e.prototype;return r.update=function(e,t,i,n=!0){const r=this.extent;this.toRenderBoundingExtent(e,t,i),o.add(this.center.origin,r[0].origin,r[2].origin),o.scale(this.center.origin,this.center.origin,.5),this.renderCoordsHelper.worldUpAtPosition(this.center.origin,this.center.direction),n||o.scale(this.center.direction,this.center.direction,-1);for(let s=0;s<4;s++){const e=r[s];this.renderCoordsHelper.worldUpAtPosition(e.origin,e.direction);const t=r[3===s?0:s+1];e.cap.next=t.origin,o.direction(e.cap.direction,e.origin,t.origin),p.fromVectorsAndPoint(e.direction,e.cap.direction,e.origin,this.planes[s]),n||o.scale(e.direction,e.direction,-1)}p.fromVectorsAndPoint(r[0].cap.direction,r[1].cap.direction,r[0].origin,this.planes[4]),n?p.negate(this.planes[4],this.planes[5]):(p.copy(this.planes[4],this.planes[5]),p.negate(this.planes[4],this.planes[4])),this.maxSpan=Math.max(Math.abs(e[0]-e[2]),Math.abs(e[1]-e[3])),this.maxSpanSpatialReference=t,this.minGlobalAltitude=.9*a.getReferenceEllipsoid(this.maxSpanSpatialReference).radius},r.isVisibleInFrustum=function(e,t,i=!1){if(null==e)return!1;if(1===this.renderCoordsHelper.viewingMode){const i=this.maxSpanSpatialReference.isGeographic?f:x*t;if(this.maxSpan>i)return!0;if(e.altitude>=this.minGlobalAltitude)return this.isVisibleInFrustumGlobal(e)}if(0===this.maxSpan){const t=this.extent[0];return!(i||!e.intersectsRay(u.wrap(t.origin,t.direction)))}for(let r=0;r<this.extent.length;r++){const t=this.extent[r];if(!i&&e.intersectsRay(u.wrap(t.origin,t.direction)))return!0;if(e.intersectsLineSegment(h.fromPoints(t.origin,t.cap.next,B),t.cap.direction))return!0}const n=i?this.planes:this.planesWithoutFar;for(let r=0;r<e.lines.length;r++){const t=e.lines[r];if(g.frustumLineSegment(n,t.origin,t.endpoint,t.direction))return!0}return!1},r.toRenderBoundingExtentGlobal=function(e,t,r){const s=5;d.center(e,R),R[2]=r,c.computeTranslationToOriginAndRotation(t,R,b,this.renderCoordsHelper.spatialReference),n.invert(S,b),l.empty(M);for(const{x0:n,x1:a,y0:d,y1:h}of y)for(let p=0;p<s;p++){const u=p/(s-1);R[0]=i.lerp(e[n],e[a],u),R[1]=i.lerp(e[d],e[h],u),R[2]=r,c.projectVectorToVector(R,t,R,this.renderCoordsHelper.spatialReference),o.transformMat4(R,R,S),l.expandWithVec3(M,R)}o.set(this.extent[0].origin,M[0],M[1],M[2]),o.set(this.extent[1].origin,M[3],M[1],M[2]),o.set(this.extent[2].origin,M[3],M[4],M[2]),o.set(this.extent[3].origin,M[0],M[4],M[2]);for(let i=0;i<4;++i)o.transformMat4(this.extent[i].origin,this.extent[i].origin,b)},r.toRenderBoundingExtentLocal=function(e,t,i){c.projectBoundingRect(e,t,w,this.renderCoordsHelper.spatialReference),o.set(this.extent[0].origin,w[0],w[1],i),o.set(this.extent[1].origin,w[2],w[1],i),o.set(this.extent[2].origin,w[2],w[3],i),o.set(this.extent[3].origin,w[0],w[3],i)},r.toRenderBoundingExtent=function(e,i,n){switch(this.renderCoordsHelper.viewingMode){case 1:this.toRenderBoundingExtentGlobal(e,i,n);break;case 2:this.toRenderBoundingExtentLocal(e,i,n);break;default:t.neverReached(this.renderCoordsHelper.viewingMode)}},r.isVisibleInFrustumGlobal=function(e){if(o.dot(this.center.direction,e.direction)<0)return!0;for(let t=0;t<4;t++){const i=this.extent[t];if(o.dot(i.direction,e.direction)<0)return!0}return!1},e}();const y=[{x0:0,y0:1,x1:2,y1:1},{x0:0,y0:3,x1:2,y1:3},{x0:0,y0:1,x1:0,y1:3},{x0:2,y0:1,x1:2,y1:3}],R=s.create(),b=r.create(),S=r.create(),M=l.create(),w=d.create(),B=h.create();e.FrustumExtentIntersection=m,e.default=m,Object.defineProperty(e,"__esModule",{value:!0})}));
