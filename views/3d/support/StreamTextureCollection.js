/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{isSome as e}from"../../../core/maybe.js";import{throwIfAborted as t,onAbort as r,createAbortError as s}from"../../../core/promiseUtils.js";import{isSVG as i}from"../../../core/urlUtils.js";import{TextureCollection as o}from"./TextureCollection.js";import{PowerOfTwoResizeMode as n}from"../webgl-engine/lib/basicInterfaces.js";import{Texture as a}from"../webgl-engine/lib/Texture.js";class h extends o{constructor(e,t,r,s){super(t,s),this._streamDataRequester=e,this._parameters=r}async fromUrl(i,o,n){t(n);const a=e(n)&&n.signal,h=this.makeUid(i,o);let l=this._textureRequests.get(h);if(!l){const e=new AbortController,t=this._streamDataRequester.request(i,"image",{uid:h,signal:e.signal});l={referenceCount:0,texture:null,textureAsync:null,abortController:e},this._textureRequests.set(h,l),l.textureAsync=t.then((async e=>{const t=this._createTexture(i,e,o);return l.texture=t,l.abortController=null,this._stage.add(t),await this._stage.load(t),{uid:h,texture:t,release:()=>this._release(h)}}),(e=>{throw l.abortController=null,e}))}return l.referenceCount++,new Promise(((e,t)=>{r(a,(()=>{t(s())})),l.textureAsync.then(e,t)})).catch((e=>{throw this._release(h),e}))}_createTexture(e,t,r){const s={...this._parameters,powerOfTwoResizeMode:n.PAD};if(i(e)){if(r||0===t.width&&0===t.height){const e=t.width?t.height/t.width:1;r=r||64,e>1?(t.width=Math.round(r/e),t.height=r):(t.width=r,t.height=Math.round(r*e))}this._stage.renderView&&this._stage.renderView.renderingContext.driverTest.svgAlwaysPremultipliesAlpha&&(s.preMultiplyAlpha=!1)}return s.width=t.width,s.height=t.height,new a(t,s)}}export{h as StreamTextureCollection};
