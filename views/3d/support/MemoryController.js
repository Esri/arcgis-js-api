/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/Evented","../../../core/Logger","../../../core/maybe","../../../core/MemCache","../layers/support/MemoryManagedLayerView"],(function(e,t,i,s,a,r,n){"use strict";const o=s.getLogger("esri.views.3d.support.MemoryController");function h(e){return new d(e)}const u=1,y=1,l=.75,_=.6,m=1.3;let d=function(){function e(e){this._view=e,this.events=new i,this.minQuality=.1,this._maxMemory=500,this._additionalCacheMemory=100,this._quality=1,this._stableQuality=0,this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._memoryUsed=0,this._memoryPredicted=0,this._cacheStorage=new r.MemCacheStorage,this._numQualityChanges=0,this._updating=!1}var s=e.prototype;return s.destroy=function(){this.events=null,this._cacheStorage.destroy()},s.newCache=function(e,t){return new r.MemCache(e,this._cacheStorage,t)},s.disableMemCache=function(){this._additionalCacheMemory=-4096},s.resetStableQuality=function(){this._stableQuality=0},s.update=function(){if(this._updateMemory(),this._memoryPredicted<=0&&!this._updating)return;let e=this._layersUpdating();if(this._memoryPredicted<_&&this._canFastRecover)this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(u);else if(e)(this._memoryPredicted>1.1*y||this._memoryUsed>y)&&(this._stableQuality>0?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._quality>this.minQuality&&this._downscaleMemoryUsed<this._memoryUsed&&(this._updateQuality(this._quality/m),this._downscaleMemoryUsed=this._memoryUsed,this._canFastRecover=!1));else if(this._downscaleMemoryUsed=0,this._memoryUsed>y)this._stableQuality=0,this._canFastRecover=!1,e=this._updateQuality(this._quality/m),this._downscaleMemoryUsed=this._memoryPredicted;else if(this._stableQuality!==this._quality)if(this._memoryUsed<l&&this._quality<u){this._stableQuality=this._quality;const t=.05;e=this._updateQuality(this._quality+t)}else this._quality<1&&(this._canFastRecover=!0);this.updating!==e&&(this._updating=e,this.events.emit("updating-changed",this.updating))},s._updateQuality=function(e){return(e=Math.min(Math.max(e,this.minQuality),u))!==this._quality&&(this._quality=e,this.events.emit("quality-changed",this._quality),++this._numQualityChanges,!0)},s._layersUpdating=function(){return this._view.allLayerViews.some((e=>!!e.updating))},s._updateMemory=function(){let e=0,t=0;this._view.basemapTerrain&&this._view.basemapTerrain.getUsedMemory&&(e+=this._view.basemapTerrain.getUsedMemory());const i=this._view._stage&&this._view._stage.renderView&&this._view._stage.renderView.edgeView;a.isSome(i)&&(e+=i.usedMemory),this._view.allLayerViews&&this._view.allLayerViews.forEach((i=>{if(n.isMemoryManagedLayerView(i)){const s=i.ignoresMemoryFactor()?this._quality:1;e+=i.getUsedMemory()*s,t+=i.getUnloadedMemory()*s}}));const s=null==this._warnMemoryUsage||Math.round(10*e)!==Math.round(10*this._warnMemoryUsage),r=1048576*this._maxMemory;if(e>r&&s){this._warnMemoryUsage=e;const i=e=>(e/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB",s=Math.round(100*this._quality);o.warn(`Memory Limit exceeded! Limit: ${i(r)} Current: ${i(e)} Projected: ${i(e+t)} Quality: ${s}%`)}this._memoryUsed=e/r,this._memoryPredicted=(e+t)/r;const h=r-e;this._cacheStorage.maxSize=Math.max(0,h+1048576*this._additionalCacheMemory),this.events.emit("memory-used",this._memoryUsed)},t._createClass(e,[{key:"maxMemory",get:function(){return this._maxMemory},set:function(e){null!=e&&e>0&&(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<e&&this._updateQuality(u),this._maxMemory=e)}},{key:"additionalCacheMemory",set:function(e){null!=e&&e>=0&&(this._additionalCacheMemory=e)}},{key:"memoryFactor",get:function(){return this._quality}},{key:"updating",get:function(){return this._updating}},{key:"usedMemory",get:function(){return this._memoryUsed}},{key:"test",get:function(){const e=this;return{cacheStorage:this._cacheStorage,resetQualityChanges:()=>{const t=e._numQualityChanges;return e._numQualityChanges=0,t}}}}]),e}();e.newMemoryController=h,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
