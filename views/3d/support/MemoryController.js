/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/Logger","../../../core/maybe","../../../core/MemCache","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../layers/support/MemoryManagedLayerView"],(function(e,t,i,r,a,o,s,n,y,u,c,l){"use strict";function _(e){return new g({view:e})}const d=1,h=1,m=.75,p=.6,M=1.3;let g=function(e){function i(t){var i;return(i=e.call(this,t)||this)._quality=1,i._memoryUsed=0,i._updating=!1,i.minQuality=.1,i._stableQuality=0,i._downscaleMemoryUsed=0,i._canFastRecover=!1,i._memoryPredicted=0,i._cacheStorage=new s.MemCacheStorage,i._warnMemoryUsage=null,i._numQualityChanges=0,i._maxMemory=500,i._additionalCacheMemory=100,i}t._inheritsLoose(i,e);var r=i.prototype;return r.destroy=function(){this._cacheStorage.destroy()},r.newCache=function(e,t){return new s.MemCache(e,this._cacheStorage,t)},r.resetStableQuality=function(){this._stableQuality=0},r.disableMemCache=function(){this.additionalCacheMemory=-4096},r.update=function(){if(this._updateMemory(),this._memoryPredicted<=0&&!this._updating)return;let e=this._layersUpdating();if(this._memoryPredicted<p&&this._canFastRecover)this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(d);else if(e)(this._memoryPredicted>1.1*h||this._memoryUsed>h)&&(this._stableQuality>0?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._quality>this.minQuality&&this._downscaleMemoryUsed<this._memoryUsed&&(this._updateQuality(this._quality/M),this._downscaleMemoryUsed=this._memoryUsed,this._canFastRecover=!1));else if(this._downscaleMemoryUsed=0,this._memoryUsed>h)this._stableQuality=0,this._canFastRecover=!1,e=this._updateQuality(this._quality/M),this._downscaleMemoryUsed=this._memoryPredicted;else if(this._stableQuality!==this._quality)if(this._memoryUsed<m&&this._quality<d){this._stableQuality=this._quality;const t=.05;e=this._updateQuality(this._quality+t)}else this._quality<1&&(this._canFastRecover=!0);this._updating=e},r._updateQuality=function(e){return(e=Math.min(Math.max(e,this.minQuality),d))!==this._quality&&(this._quality=e,++this._numQualityChanges,!0)},r._layersUpdating=function(){return this.view.allLayerViews.some((e=>!!e.updating))},r._updateMemory=function(){let e=0,t=0;this.view.basemapTerrain&&this.view.basemapTerrain.getUsedMemory&&(e+=this.view.basemapTerrain.getUsedMemory());const i=this.view._stage&&this.view._stage.renderView&&this.view._stage.renderView.edgeView;o.isSome(i)&&(e+=i.usedMemory),this.view.allLayerViews&&this.view.allLayerViews.forEach((i=>{if(l.isMemoryManagedLayerView(i)){const r=i.ignoresMemoryFactor()?this._quality:1;e+=i.getUsedMemory()*r,t+=i.getUnloadedMemory()*r}}));const r=o.isNone(this._warnMemoryUsage)||Math.round(10*e)!==Math.round(10*this._warnMemoryUsage),s=1048576*this.maxMemory;if(e>s&&r){this._warnMemoryUsage=e;const i=e=>(e/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB",r=Math.round(100*this._quality);a.getLogger(this.declaredClass).warn(`Memory Limit exceeded! Limit: ${i(s)} Current: ${i(e)} Projected: ${i(e+t)} Quality: ${r}%`)}this._memoryUsed=e/s,this._memoryPredicted=(e+t)/s;const n=s-e;this._cacheStorage.maxSize=Math.max(0,n+1048576*this.additionalCacheMemory)},t._createClass(i,[{key:"maxMemory",get:function(){return this._maxMemory},set:function(e){null==e||e<=0||(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<e&&this._updateQuality(d),this._maxMemory=e)}},{key:"additionalCacheMemory",get:function(){return this._additionalCacheMemory},set:function(e){null!=e&&e>=0&&(this._additionalCacheMemory=e)}},{key:"memoryFactor",get:function(){return this._quality}},{key:"updating",get:function(){return this._updating}},{key:"usedMemory",get:function(){return this._memoryUsed}},{key:"test",get:function(){const e=this;return{cacheStorage:this._cacheStorage,resetQualityChanges:()=>{const t=e._numQualityChanges;return e._numQualityChanges=0,t}}}}]),i}(r);i.__decorate([n.property({constructOnly:!0})],g.prototype,"view",void 0),i.__decorate([n.property()],g.prototype,"maxMemory",null),i.__decorate([n.property()],g.prototype,"additionalCacheMemory",null),i.__decorate([n.property()],g.prototype,"memoryFactor",null),i.__decorate([n.property()],g.prototype,"updating",null),i.__decorate([n.property()],g.prototype,"usedMemory",null),i.__decorate([n.property()],g.prototype,"_quality",void 0),i.__decorate([n.property()],g.prototype,"_memoryUsed",void 0),i.__decorate([n.property()],g.prototype,"_updating",void 0),i.__decorate([n.property()],g.prototype,"_stableQuality",void 0),i.__decorate([n.property()],g.prototype,"_maxMemory",void 0),i.__decorate([n.property()],g.prototype,"_additionalCacheMemory",void 0),g=i.__decorate([c.subclass("esri.views.3d.support.MemoryControllerImpl")],g),e.newMemoryController=_,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
