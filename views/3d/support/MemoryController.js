/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{_ as t}from"../../../chunks/tslib.es6.js";import e from"../../../core/Accessor.js";import i from"../../../core/Logger.js";import{isSome as s}from"../../../core/maybe.js";import{MemCacheStorage as r,MemCache as a}from"../../../core/MemCache.js";import{property as o}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/arrayUtils.js";import"../../../core/has.js";import"../../../core/accessorSupport/ensureType.js";import{subclass as h}from"../../../core/accessorSupport/decorators/subclass.js";import{isMemoryManagedLayerView as m}from"../layers/support/MemoryManagedLayerView.js";const y=i.getLogger("esri.views.3d.support.MemoryController");function l(t){return new p({view:t})}const n=1,d=1,u=.75,c=.6,_=1.3;let p=class extends e{constructor(t){super(t),this._quality=1,this._memoryUsed=0,this._updating=!1,this.minQuality=.1,this._stableQuality=0,this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._memoryPredicted=0,this._cacheStorage=new r,this._numQualityChanges=0,this._maxMemory=500,this._additionalCacheMemory=100}destroy(){this._cacheStorage.destroy()}set maxMemory(t){null==t||t<=0||(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<t&&this._updateQuality(n),this._maxMemory=t)}get maxMemory(){return this._maxMemory}set additionalCacheMemory(t){null!=t&&t>=0&&(this._additionalCacheMemory=t)}get additionalCacheMemory(){return this._additionalCacheMemory}get memoryFactor(){return this._quality}get updating(){return this._updating}get usedMemory(){return this._memoryUsed}newCache(t,e){return new a(t,this._cacheStorage,e)}resetStableQuality(){this._stableQuality=0}disableMemCache(){this.additionalCacheMemory=-4096}update(){if(this._updateMemory(),this._memoryPredicted<=0&&!this._updating)return;let t=this._layersUpdating();if(this._memoryPredicted<c&&this._canFastRecover)this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(n);else if(t)(this._memoryPredicted>1.1*d||this._memoryUsed>d)&&(this._stableQuality>0?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._quality>this.minQuality&&this._downscaleMemoryUsed<this._memoryUsed&&(this._updateQuality(this._quality/_),this._downscaleMemoryUsed=this._memoryUsed,this._canFastRecover=!1));else if(this._downscaleMemoryUsed=0,this._memoryUsed>d)this._stableQuality=0,this._canFastRecover=!1,t=this._updateQuality(this._quality/_),this._downscaleMemoryUsed=this._memoryPredicted;else if(this._stableQuality!==this._quality)if(this._memoryUsed<u&&this._quality<n){this._stableQuality=this._quality;const e=.05;t=this._updateQuality(this._quality+e)}else this._quality<1&&(this._canFastRecover=!0);this._updating=t}_updateQuality(t){return(t=Math.min(Math.max(t,this.minQuality),n))!==this._quality&&(this._quality=t,++this._numQualityChanges,!0)}_layersUpdating(){return this.view.allLayerViews.some((t=>!!t.updating))}_updateMemory(){let t=0,e=0;this.view.basemapTerrain&&this.view.basemapTerrain.getUsedMemory&&(t+=this.view.basemapTerrain.getUsedMemory());const i=this.view._stage&&this.view._stage.renderView&&this.view._stage.renderView.edgeView;s(i)&&(t+=i.usedMemory),this.view.allLayerViews&&this.view.allLayerViews.forEach((i=>{if(m(i)){const s=i.ignoresMemoryFactor()?this._quality:1;t+=i.getUsedMemory()*s,e+=i.getUnloadedMemory()*s}}));const r=null==this._warnMemoryUsage||Math.round(10*t)!==Math.round(10*this._warnMemoryUsage),a=1048576*this.maxMemory;if(t>a&&r){this._warnMemoryUsage=t;const i=t=>(t/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB",s=Math.round(100*this._quality);y.warn(`Memory Limit exceeded! Limit: ${i(a)} Current: ${i(t)} Projected: ${i(t+e)} Quality: ${s}%`)}this._memoryUsed=t/a,this._memoryPredicted=(t+e)/a;const o=a-t;this._cacheStorage.maxSize=Math.max(0,o+1048576*this.additionalCacheMemory)}get test(){const t=this;return{cacheStorage:this._cacheStorage,resetQualityChanges:()=>{const e=t._numQualityChanges;return t._numQualityChanges=0,e}}}};t([o({constructOnly:!0})],p.prototype,"view",void 0),t([o()],p.prototype,"maxMemory",null),t([o()],p.prototype,"additionalCacheMemory",null),t([o()],p.prototype,"memoryFactor",null),t([o()],p.prototype,"updating",null),t([o()],p.prototype,"usedMemory",null),t([o()],p.prototype,"_quality",void 0),t([o()],p.prototype,"_memoryUsed",void 0),t([o()],p.prototype,"_updating",void 0),t([o()],p.prototype,"_stableQuality",void 0),t([o()],p.prototype,"_maxMemory",void 0),t([o()],p.prototype,"_additionalCacheMemory",void 0),p=t([h("esri.views.3d.support.MemoryController")],p);export{l as newMemoryController};
