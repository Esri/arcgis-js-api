/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/maybe","../../../core/Logger","../../../core/Evented","../../../core/MemCache","../layers/support/MemoryManagedLayerView"],(function(e,t,i,s,a,r,n){"use strict";const o=s.getLogger("esri.views.3d.support.MemoryController");let h=function(){function e(e){this._view=e,this.events=new a,this.minQuality=.1,this._maxMemory=500,this._additionalCacheMemory=100,this._quality=1,this._stableQuality=0,this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._memoryUsed=0,this._memoryPredicted=0,this._cacheStorage=new r.MemCacheStorage,this._numQualityChanges=0,this._updating=!1}var s=e.prototype;return s.destroy=function(){this.events=null},s.getMemCache=function(e,t){return new r.MemCache(e,this._cacheStorage,t)},s.disableMemCache=function(){this._additionalCacheMemory=-4096},s.resetStableQuality=function(){this._stableQuality=0},s.update=function(){if(this._updateMemory(),this._memoryPredicted<=0&&!this._updating)return;let e=this._layersUpdating();if(this._memoryPredicted<.6&&this._canFastRecover)this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(1);else if(e)(this._memoryPredicted>1.1||this._memoryUsed>1)&&(this._stableQuality>0?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._quality>this.minQuality&&this._downscaleMemoryUsed<this._memoryUsed&&(this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._memoryUsed,this._canFastRecover=!1));else if(this._downscaleMemoryUsed=0,this._memoryUsed>1)this._stableQuality=0,this._canFastRecover=!1,e=this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._memoryPredicted;else if(this._stableQuality!==this._quality)if(this._memoryUsed<.75&&this._quality<1){this._stableQuality=this._quality;const t=.05;e=this._updateQuality(this._quality+t)}else this._quality<1&&(this._canFastRecover=!0);this.updating!==e&&(this._updating=e,this.events.emit("updating-changed",this.updating))},s._updateQuality=function(e){return(e=Math.min(Math.max(e,this.minQuality),1))!==this._quality&&(this._quality=e,this.events.emit("quality-changed",this._quality),++this._numQualityChanges,!0)},s._layersUpdating=function(){return this._view.allLayerViews.some((e=>!!e.updating))},s._updateMemory=function(){let e=0,t=0;this._view.basemapTerrain&&this._view.basemapTerrain.getUsedMemory&&(e+=this._view.basemapTerrain.getUsedMemory());const s=this._view._stage&&this._view._stage.renderView&&this._view._stage.renderView.edgeView;i.isSome(s)&&(e+=s.getUsedMemory()),this._view.allLayerViews&&this._view.allLayerViews.forEach((i=>{if(n.isMemoryManagedLayerView(i)){const s=i.ignoresMemoryFactor()?this._quality:1;e+=i.getUsedMemory()*s,t+=i.getUnloadedMemory()*s}}));const a=null==this._warnMemoryUsage||Math.round(10*e)!==Math.round(10*this._warnMemoryUsage),r=1048576*this._maxMemory;if(e>r&&a){this._warnMemoryUsage=e;const i=e=>(e/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB",s=Math.round(100*this._quality);o.warn(`Memory Limit exceeded! Limit: ${i(r)} Current: ${i(e)} Projected: ${i(e+t)} Quality: ${s}%`)}this._memoryUsed=e/r,this._memoryPredicted=(e+t)/r;const h=r-e;this._cacheStorage.maxSize=Math.max(0,h+1048576*this._additionalCacheMemory),this.events.emit("memory-used",this._memoryUsed)},t._createClass(e,[{key:"maxMemory",set:function(e){null!=e&&e>0&&(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<e&&this._updateQuality(1),this._maxMemory=e)},get:function(){return this._maxMemory}},{key:"additionalCacheMemory",set:function(e){null!=e&&e>=0&&(this._additionalCacheMemory=e)}},{key:"memoryFactor",get:function(){return this._quality}},{key:"updating",get:function(){return this._updating}},{key:"usedMemory",get:function(){return this._memoryUsed}},{key:"test",get:function(){return{cacheStorage:this._cacheStorage,numQualityChanges:this._numQualityChanges}}}]),e}();e.newMemoryController=function(e){return new h(e)},Object.defineProperty(e,"__esModule",{value:!0})}));
