/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/mathUtils","../../../core/maybe","../../../chunks/vec2f64","../../../chunks/vec3","../../../chunks/vec3f64","../../../chunks/vec4","../../../chunks/vec4f64","../../../geometry/support/clipRay","../../../geometry/support/frustum","../../../geometry/support/lineSegment","../../../geometry/support/plane","../../../geometry/support/ray","../../../chunks/sphere","./LaserlinePathData","../webgl-engine/lib/glUtil3D","../webgl-engine/lib/RenderSlot","../webgl-engine/lib/Util","../webgl-engine/materials/internal/MaterialUtil","../webgl-engine/shaders/LaserlinePathTechnique","../webgl-engine/shaders/LaserlineTechnique","../../webgl/enums"],(function(e,t,i,n,s,a,r,c,h,l,o,_,d,u,f,p,g,m,b,P,V,E,L){"use strict";const q=r.create(),S=h.create(),D={glowColor:[1,.5,0],glowWidth:8,glowFalloff:8,innerColor:[1,1,1],innerWidth:1,globalAlpha:.75,angleCutoff:i.deg2rad(6),globalAlphaContrastBoost:2};function y(e,t,i,n){const s=q,r=S;a.transformMat4(s,t,n),a.copy(r,i),r[3]=0,c.transformMat4(r,r,n),d.fromPositionAndNormal(s,r,e)}let M=function(){function e(e,t={},i={contrastControlEnabled:!1}){this._renderCoordsHelper=e,this._config=i,this._technique=null,this._projInfo=h.create(),this._zScale=s.create(),this._heightManifoldEnabled=!1,this._heightManifoldTarget=r.create(),this._pointDistanceEnabled=!1,this._pointDistanceOrigin=r.create(),this._pointDistanceTarget=r.create(),this._lineVerticalPlaneEnabled=!1,this._lineVerticalPlaneSegment=_.create(),this._intersectsLineEnabled=!1,this._intersectsLineSegment=_.create(),this._intersectsLineRadius=3,this._intersectsLineInfinite=!1,this._pathVerticalPlaneEnabled=!1,this._pathVerticalPlaneData=null,this._pathTechnique=null,this.canRender=!0,this._tempNormal=r.create(),this._tempDir=r.create(),this._tempUp=r.create(),this._tempVec3A=r.create(),this._tempVec3B=r.create(),this._tempVec4=h.create(),this._tempPlane=d.create(),this._tempSphere=f.create(),this._params=P.copyParameters(t,D)}var i=e.prototype;return i.setParameters=function(e){P.updateParameters(this._params,e)&&this._requestRender()},i.initializeRenderContext=function(e){this._context=e;const t=e.renderContext.rctx;this._quadVAO=g.createQuadVAO(t),this._techniqueRepository=e.shaderTechniqueRepository,this._techniqueConfig=new E.LaserlineTechniqueConfiguration;const i=new V.LaserlinePathTechniqueConfiguration;i.contrastControlEnabled=this._config.contrastControlEnabled,this._pathTechnique=this._techniqueRepository.acquire(V.LaserlinePathTechnique,i)},i.uninitializeRenderContext=function(){this._quadVAO=n.disposeMaybe(this._quadVAO),this._technique=n.releaseMaybe(this._technique),this._pathVerticalPlaneData=n.disposeMaybe(this._pathVerticalPlaneData),this._pathTechnique=n.releaseMaybe(this._pathTechnique)},i.prepareTechnique=function(){return this.heightManifoldEnabled||this.pointDistanceEnabled||this.lineVerticalPlaneSegment||this.intersectsLineEnabled?(this._techniqueConfig.heightManifoldEnabled=this.heightManifoldEnabled,this._techniqueConfig.lineVerticalPlaneEnabled=this.lineVerticalPlaneEnabled,this._techniqueConfig.pointDistanceEnabled=this.pointDistanceEnabled,this._techniqueConfig.intersectsLineEnabled=this.intersectsLineEnabled,this._techniqueConfig.contrastControlEnabled=this._config.contrastControlEnabled,this._technique=this._techniqueRepository.releaseAndAcquire(E.LaserlineTechnique,this._techniqueConfig,this._technique),this._technique):this._pathTechnique},i.render=function(e,t){const i=e.camera;b.inverseProjectionInfo(i.projectionMatrix,i.fullWidth,i.fullHeight,this._projInfo,this._zScale),(this.heightManifoldEnabled||this.pointDistanceEnabled||this.lineVerticalPlaneSegment||this.intersectsLineEnabled)&&this._renderUnified(e,t),this.pathVerticalPlaneEnabled&&this._renderPath(e)},i._renderUnified=function(e,t){const i=e.rctx,n=i.useTechnique(t);this._bindGlobalUniforms(e,n),this._bindHeightManifoldUniforms(e,n),this._bindPointDistanceUniforms(e,n),this._bindLineVerticalPlaneUniforms(e,n),this._bindIntersectsLineUniforms(e,n),t.bind(this._params,e.camera),i.bindVAO(this._quadVAO),i.drawArrays(L.PrimitiveType.TRIANGLE_STRIP,0,4)},i._renderPath=function(e){if(n.isNone(this._pathVerticalPlaneData)||n.isNone(this._pathTechnique))return;const t=e.rctx,i=this._pathTechnique,s=t.useTechnique(i);this._bindGlobalUniforms(e,s),i.bind(this._params,this._pathVerticalPlaneData.origin,e.camera),this._pathVerticalPlaneData.draw(e.rctx)},i._bindHeightManifoldUniforms=function(e,t){if(!this.heightManifoldEnabled)return;const i=this._tempVec3A,n=this._tempPlane;this._renderCoordsHelper.worldUpAtPosition(this._heightManifoldTarget,i),y(n,this._heightManifoldTarget,i,e.camera.viewMatrix),t.setUniform4fv("heightPlane",n)},i._bindPointDistanceUniforms=function(e,t){if(!this._pointDistanceEnabled)return;const i=e.camera,n=this._tempSphere;a.copy(n,this._pointDistanceOrigin),a.transformMat4(n,n,i.viewMatrix),n[3]=a.distance(this._pointDistanceOrigin,this._pointDistanceTarget),t.setUniform4f("pointDistanceSphere",n[0],n[1],n[2],n[3])},i._bindLineVerticalPlaneUniforms=function(e,t){if(!this._lineVerticalPlaneEnabled)return;const i=this._renderCoordsHelper,n=e.camera,s=this._tempPlane,r=this._tempVec3A,c=this._tempUp,h=this._tempDir,l=this._tempNormal;_.pointAt(this._lineVerticalPlaneSegment,.5,r),i.worldUpAtPosition(r,c),a.normalize(h,this._lineVerticalPlaneSegment.vector),a.cross(l,c,h),a.normalize(l,l),y(s,this._lineVerticalPlaneSegment.origin,l,n.viewMatrix),t.setUniform4fv("lineVerticalPlane",s);const o=this._tempVec3A;a.copy(o,this._lineVerticalPlaneSegment.origin),i.setAltitude(o,0),a.transformMat4(o,o,n.viewMatrix),t.setUniform3fv("lineVerticalStart",o);const d=this._tempVec3B;a.add(d,this._lineVerticalPlaneSegment.origin,this._lineVerticalPlaneSegment.vector),i.setAltitude(d,0),a.transformMat4(d,d,n.viewMatrix),t.setUniform3fv("lineVerticalEnd",d)},i._bindIntersectsLineUniforms=function(e,t){if(!this._intersectsLineEnabled)return;const i=T,n=U;if(this._intersectsLineInfinite){const t=e.camera;if(l.fromRay(u.wrap(this._intersectsLineSegment.origin,this._intersectsLineSegment.vector),R),R.c0=-Number.MAX_VALUE,!o.intersectClipRay(t.frustum,R))return;l.getStart(R,i),l.getEnd(R,n)}else a.copy(i,this._intersectsLineSegment.origin),a.add(n,this._intersectsLineSegment.origin,this._intersectsLineSegment.vector);const s=this._tempVec3A;a.transformMat4(s,i,e.camera.viewMatrix),t.setUniform3fv("intersectsLineStart",s);const r=this._tempVec4;a.copy(r,this._intersectsLineSegment.vector),this._tempVec4[3]=0,c.transformMat4(this._tempVec4,this._tempVec4,e.camera.viewMatrix),a.transformMat4(n,n,e.camera.viewMatrix),t.setUniform3fv("intersectsLineEnd",n),a.normalize(r,r),t.setUniform3f("intersectsLineDirection",r[0],r[1],r[2]),t.setUniform1f("intersectsLineRadius",this._intersectsLineRadius)},i._bindGlobalUniforms=function(e,t){const i=e.camera;t.setUniform4fv("projInfo",this._projInfo),t.setUniform2fv("zScale",this._zScale),t.setUniform2fv("nearFar",i.nearFar),this._heightManifoldEnabled?t.setUniform1f("maxPixelDistance",2*i.computeScreenPixelSizeAt(this._heightManifoldTarget)):this._pointDistanceEnabled?t.setUniform1f("maxPixelDistance",2*i.computeScreenPixelSizeAt(this._pointDistanceTarget)):this._lineVerticalPlaneEnabled&&t.setUniform1f("maxPixelDistance",2*i.computeScreenPixelSizeAt(this._lineVerticalPlaneSegment.origin)),t.bindTexture(e.offscreenRenderingHelper.linearDepthTexture,"depthMap"),t.bindTexture(e.offscreenRenderingHelper.mainColorTexture,"frameColor")},i._requestRender=function(){this._context&&this._context.requestRender()},t._createClass(e,[{key:"renderSlots",get:function(){return[this._config.contrastControlEnabled?m.RenderSlot.LASERLINES_CONTRAST_CONTROL:m.RenderSlot.LASERLINES]}},{key:"needsLinearDepth",get:function(){return!0}},{key:"heightManifoldEnabled",get:function(){return this._heightManifoldEnabled},set:function(e){this._heightManifoldEnabled!==e&&(this._heightManifoldEnabled=e,this._requestRender())}},{key:"heightManifoldTarget",get:function(){return this._heightManifoldTarget},set:function(e){a.copy(this._heightManifoldTarget,e),this._requestRender()}},{key:"pointDistanceEnabled",get:function(){return this._pointDistanceEnabled},set:function(e){e!==this._pointDistanceEnabled&&(this._pointDistanceEnabled=e,this._requestRender())}},{key:"pointDistanceTarget",get:function(){return this._pointDistanceTarget},set:function(e){a.copy(this._pointDistanceTarget,e),this._requestRender()}},{key:"pointDistanceOrigin",get:function(){return this._pointDistanceOrigin},set:function(e){a.copy(this._pointDistanceOrigin,e),this._requestRender()}},{key:"lineVerticalPlaneEnabled",get:function(){return this._lineVerticalPlaneEnabled},set:function(e){e!==this._lineVerticalPlaneEnabled&&(this._lineVerticalPlaneEnabled=e,this._requestRender())}},{key:"lineVerticalPlaneSegment",get:function(){return this._lineVerticalPlaneSegment},set:function(e){_.copy(e,this._lineVerticalPlaneSegment),this._requestRender()}},{key:"intersectsLineEnabled",get:function(){return this._intersectsLineEnabled},set:function(e){e!==this._intersectsLineEnabled&&(this._intersectsLineEnabled=e,this._requestRender())}},{key:"intersectsLineSegment",get:function(){return this._intersectsLineSegment},set:function(e){_.copy(e,this._intersectsLineSegment),this._requestRender()}},{key:"intersectsLineRadius",get:function(){return this._intersectsLineRadius},set:function(e){e!==this._intersectsLineRadius&&(this._intersectsLineRadius=e,this._requestRender())}},{key:"intersectsLineInfinite",get:function(){return this._intersectsLineInfinite},set:function(e){e!==this._intersectsLineInfinite&&(this._intersectsLineInfinite=e,this._requestRender())}},{key:"pathVerticalPlaneEnabled",get:function(){return this._pathVerticalPlaneEnabled},set:function(e){e!==this._pathVerticalPlaneEnabled&&(this._pathVerticalPlaneEnabled=e,n.isSome(this._pathVerticalPlaneData)&&this._requestRender())}},{key:"pathVerticalPlaneVertices",set:function(e){n.isNone(this._pathVerticalPlaneData)&&(this._pathVerticalPlaneData=new p.LaserlinePathData(this._renderCoordsHelper)),this._pathVerticalPlaneData.vertices=e,this.pathVerticalPlaneEnabled&&this._requestRender()}},{key:"pathVerticalPlaneBuffers",set:function(e){n.isNone(this._pathVerticalPlaneData)&&(this._pathVerticalPlaneData=new p.LaserlinePathData(this._renderCoordsHelper)),this._pathVerticalPlaneData.buffers=e,this.pathVerticalPlaneEnabled&&this._requestRender()}}]),e}();const R=l.create(),T=r.create(),U=r.create();e.LaserLineRenderer=M,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
