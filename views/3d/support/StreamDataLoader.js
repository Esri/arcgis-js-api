/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/has","../../../core/lang","../../../core/maybe","../../../core/Logger","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass","../../../core/Error","../../../core/urlUtils","../../../core/uuid","../../../portal/support/resourceExtension","../../../core/arrayUtils","../../../core/promiseUtils","../../../core/Accessor","../../../request","../../support/Scheduler","../webgl-engine/lib/Util","./AsyncWorkerQueue","./StreamDataLoaderTask"],(function(e,t,r,s,a,o,n,u,i,l,c,d,h,p,g,k,f,b,y,m,L,Q){"use strict";e.StreamDataLoader=function(e){function r(){var t;return(t=e.apply(this,arguments)||this).tasks=new Map,t.onLoadQueue=new Array,t.doneQueue=new Array,t.updating=!1,t}t._inheritsLoose(r,e);var s=r.prototype;return s.setup=function(e,t,r){this.loadQueue=new L.AsyncWorkerQueue(((e,t)=>this.startLoading(e,t)),((e,t)=>this.doneLoadingCallback(e,t)),e,t),r&&(this.taskHandle=r.registerTask(y.Task.STREAM_DATA_LOADER,(e=>this.update(e)),(()=>this.doneQueue.length>0||this.onLoadQueue.length>0)))},s.destroy=function(){this.taskHandle&&(this.taskHandle.remove(),this.taskHandle=null),this.tasks.forEach((e=>{e.abortController&&e.abortController.abort()})),this.loadQueue.destroy(),this.loadQueue=null,this.onLoadQueue=null,this.doneQueue=null,this.tasks=null},s.hasDownloadSlots=function(e){return this.loadQueue.hasQuota(e)},s.request=function(e,t,r,s={}){const a=k.createResolver();a.__signal=o.isSome(s)?s.signal:null;const n=this.createOrUpdateTask(e,t,r,s,a);return k.onAbort(s,(()=>this.cancelRequest(n,a))),a.promise},s.createTask=function(e,t,r,s,a,o){const n=new Q(e,t,r,s,a);return this.updateTask(n,o),this.tasks.set(a,n),1===this.tasks.size&&this._set("updating",!0),this.loadQueue.push(n),n},s.cancelRequest=function(e,t){g.removeUnordered(e.resolvers,t),t.reject(k.createAbortError()),0===e.resolvers.length&&(2===e.status&&(e.status=4,this.loadQueue.cancel(e),e.abortController.abort(),e.request=null,e.abortController=null),e.status=4,this.tasks.delete(e.key),0===this.tasks.size&&this._set("updating",!1))},s.taskKey=function(e,t,r){return`${e}:${t}:${r}`},s.updateTask=function(e,t){e.resolvers.push(t)},s.createOrUpdateTask=function(e,t,r,s,a){const n=o.isSome(s)&&s.uid||e,u=this.taskKey(n,t,r),i=this.tasks.get(u);return i?(this.updateTask(i,a),i):this.createTask(e,s,t,r,u,a)},s.doneLoadingCallback=function(e,t){this.loadQueue&&(m.assert(2===e.status),e.status=3,this.taskHandle?this.doneQueue.push({task:e,err:t}):this.doneLoading(e,t))},s.update=function(e){for(;!e.done&&this.onLoadQueue.length>0;){const t=this.onLoadQueue.shift();k.throwIfAborted(t.task.abortController),t.task.abortController=null,t.callback(t.task),e.madeProgress()}for(;!e.done&&this.doneQueue.length>0;){const t=this.doneQueue.shift();3!==t.task.status&&(t.err=t.err||k.createAbortError()),this.doneLoading(t.task,t.err),e.madeProgress()}},s.doneLoading=function(e,t){let r=e.result instanceof HTMLImageElement?0:e.resolvers.length;for(const s of e.resolvers)if(t)k.isAbortError(t)?s.reject(t):s.reject(new c("stream-data-loader:request-error",`Failed to request resource at '${e.url}'. ${t}`,{url:e.url,error:t}));else{--r;const t=r<=0?e.result:a.clone(e.result);s.resolve(t)}this.tasks.delete(e.key),0===this.tasks.size&&this._set("updating",!1)},s.startLoading=function(e,t){if(4===e.status)return!1;let r,s;switch(e.startTime=performance.now(),e.status=2,e.docType){case"binary":s="array-buffer",r=0;break;case"image":s="image";break;case"image+type":s="array-buffer";break;default:s="json"}e.abortController=k.createAbortController();const a=e.abortController.signal;e.request=b(e.url,{...e.options,responseType:s,timeout:r,signal:a});let o=()=>{};const n=r=>{e.duration=performance.now()-e.startTime,e.size=r instanceof ArrayBuffer?r.byteLength:e.size||0,e.result=r,this.taskHandle?this.onLoadQueue.push({callback:t,task:e}):(e.abortController=null,t(e))},u=r=>{2===e.status&&t(e,r),o()};return"image+type"!==e.docType?(e.request.then((e=>n(e.data)),u),!0):(e.request.then((t=>{const i=t.data,l=function(e){if(e.byteLength<2)return"unknown";const t=new Uint8Array(e,0,e.byteLength);if(137===t[0]&&80===t[1])return"image/png";if(71===t[0]&&73===t[1])return"image/gif";if(66===t[0]&&77===t[1])return"image/bmp";if(255===t[0]&&216===t[1])return"image/jpeg";return"unknown"}(i);if(s="image",e.size=i.byteLength,"unknown"===l)return e.request=b(e.url,{responseType:s,timeout:r,signal:a}),void e.request.then((e=>n(e.data)),u);const c=new Blob([i],{type:l}),d=window.URL.createObjectURL(c);o=()=>window.URL.revokeObjectURL(d),e.request=b(d,{responseType:s,timeout:r,signal:a}),e.request.then((e=>n(new w(e.data,l,o))),u)}),u),!0)},t._createClass(r,[{key:"test",get:function(){return{loadQueue:this.loadQueue}}}]),r}(f),r.__decorate([i.property({readOnly:!0})],e.StreamDataLoader.prototype,"updating",void 0),e.StreamDataLoader=r.__decorate([l.subclass("esri.views.3d.support.StreamDataLoader")],e.StreamDataLoader);let w=function(){function e(e,t,r){this.image=e,this.type=t,this.release=r}return t._createClass(e,[{key:"isOpaque",get:function(){return"image/jpeg"===this.type}}]),e}();var T=e.StreamDataLoader;e.ImageWithType=w,e.default=T,Object.defineProperty(e,"__esModule",{value:!0})}));
