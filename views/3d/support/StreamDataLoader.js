/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../request","../../../core/Accessor","../../../core/arrayUtils","../../../core/Error","../../../core/lang","../../../core/maybe","../../../core/promiseUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","./AsyncWorkerQueue","../webgl-engine/lib/Util","../../support/Scheduler"],(function(e,t,s,r,a,o,n,u,i,l,c,d,h,_,p,k){"use strict";e.StreamDataLoader=function(s){function a(){var e;return(e=s.apply(this,arguments)||this)._tasks=new Map,e._onLoadQueue=new Array,e._doneQueue=new Array,e.updating=!1,e}t._inheritsLoose(a,s);var c=a.prototype;return c.setup=function(e,t,s){this._loadQueue=new _.AsyncWorkerQueue(((e,t)=>this._startLoading(e,t)),((e,t)=>this._doneLoadingCB(e,t)),e,t),s&&(this._frameTask=s.registerTask(k.TaskPriority.STREAM_DATA_LOADER,this))},c.destroy=function(){this._frameTask=i.removeMaybe(this._frameTask),this._tasks.forEach((e=>i.abortMaybe(e.abortController))),this._loadQueue=i.destroyMaybe(this._loadQueue),this._onLoadQueue=null,this._doneQueue=null,this._tasks=null},c.hasDownloadSlots=function(e){return this._loadQueue.hasQuota(e)},c.request=function(e,t,s,r={}){const a=l.createResolver();a.__signal=i.isSome(r)?r.signal:null;const o=this._createOrUpdateTask(e,t,s,r,a);return l.onAbort(r,(()=>this._cancelRequest(o,a))),a.promise},c._createTask=function(e,t,s,r,a,o){const n=new m(e,t,s,r,a);return this._updateTask(n,o),this._tasks.set(a,n),1===this._tasks.size&&this._set("updating",!0),this._loadQueue.push(n),n},c._cancelRequest=function(t,s){o.removeUnordered(t.resolvers,s),s.reject(l.createAbortError()),0===t.resolvers.length&&(t.status===e.TaskStatus.DOWNLOADING&&(t.status=e.TaskStatus.CANCELLED,this._loadQueue.cancel(t),t.abortController.abort(),t.request=null,t.abortController=null),t.status=e.TaskStatus.CANCELLED,this._tasks.delete(t.key),0===this._tasks.size&&this._set("updating",!1))},c._updateTask=function(e,t){e.resolvers.push(t)},c._createOrUpdateTask=function(e,t,s,r,a){const o=y(i.isSome(r)&&r.uid||e,t,s),n=this._tasks.get(o);return n?(this._updateTask(n,a),n):this._createTask(e,r,t,s,o,a)},c._doneLoadingCB=function(t,s){this._loadQueue&&(p.assert(t.status===e.TaskStatus.DOWNLOADING),t.status=e.TaskStatus.DOWNLOADED,this._frameTask?this._doneQueue.push({task:t,err:s}):this._doneLoading(t,s))},c.runTask=function(t){for(;!t.done&&this._onLoadQueue.length>0;){const e=this._onLoadQueue.shift();l.throwIfAborted(e.task.abortController),e.task.abortController=null,e.callback(e.task),t.madeProgress()}for(;!t.done&&this._doneQueue.length>0;){const s=this._doneQueue.shift();s.task.status!==e.TaskStatus.DOWNLOADED&&(s.err=s.err||l.createAbortError()),this._doneLoading(s.task,s.err),t.madeProgress()}},c._doneLoading=function(e,t){if(t&&!l.isAbortError(t)&&e.numRetries>0)return--e.numRetries,void this._loadQueue.push(e);let s=e.result instanceof HTMLImageElement?0:e.resolvers.length;for(const r of e.resolvers)if(t)l.isAbortError(t)?r.reject(t):r.reject(new n("stream-data-loader:request-error",`Failed to request resource at '${e.url}'. ${t}`,{url:e.url,error:t}));else{--s;const t=s<=0?e.result:u.clone(e.result);r.resolve(t)}this._tasks.delete(e.key),0===this._tasks.size&&this._set("updating",!1)},c._startLoading=function(t,s){if(t.status===e.TaskStatus.CANCELLED)return!1;let a,o;switch(t.startTime=performance.now(),t.status=e.TaskStatus.DOWNLOADING,t.docType){case"binary":o="array-buffer",a=0;break;case"image":o="image";break;case"image+type":o="array-buffer";break;default:o="json"}t.abortController=new AbortController;const n=t.abortController.signal;t.request=r(t.url,{...t.options,responseType:o,timeout:a,signal:n});let u=()=>{};const i=e=>{t.duration=performance.now()-t.startTime,t.size=e instanceof ArrayBuffer?e.byteLength:t.size||0,t.result=e,this._frameTask?this._onLoadQueue.push({callback:s,task:t}):(t.abortController=null,s(t))},l=r=>{t.status===e.TaskStatus.DOWNLOADING&&s(t,r),u()};return"image+type"!==t.docType?(t.request.then((e=>i(e.data)),l),!0):(t.request.then((e=>{const s=e.data,c=f(s);if(o="image",t.size=s.byteLength,"unknown"===c)return t.request=r(t.url,{responseType:o,timeout:a,signal:n}),void t.request.then((e=>i(e.data)),l);const d=new Blob([s],{type:c}),h=window.URL.createObjectURL(d);u=()=>window.URL.revokeObjectURL(h),t.request=r(h,{responseType:o,timeout:a,signal:n}),t.request.then((e=>i(new L(e.data,c,u))),l)}),l),!0)},t._createClass(a,[{key:"running",get:function(){return this._doneQueue.length>0||this._onLoadQueue.length>0}},{key:"test",get:function(){return{loadQueue:this._loadQueue}}}]),a}(a),s.__decorate([c.property({readOnly:!0})],e.StreamDataLoader.prototype,"updating",void 0),e.StreamDataLoader=s.__decorate([h.subclass("esri.views.3d.support.StreamDataLoader")],e.StreamDataLoader);const g={numRetries:0};function f(e){if(e.byteLength<2)return"unknown";const t=new Uint8Array(e,0,e.byteLength);return 137===t[0]&&80===t[1]?"image/png":71===t[0]&&73===t[1]?"image/gif":66===t[0]&&77===t[1]?"image/bmp":255===t[0]&&216===t[1]?"image/jpeg":"unknown"}let L=function(){function e(e,t,s){this.image=e,this.type=t,this.release=s}return t._createClass(e,[{key:"isOpaque",get:function(){return"image/jpeg"===this.type}}]),e}(),m=function(s){function r(t,r,a,o,n){var u;return(u=s.call(this,o)||this).url=t,u.options=r,u.docType=a,u.key=n,u.result=null,u.status=e.TaskStatus.QUEUED,u.request=null,u.abortController=null,u.resolvers=new Array,u.startTime=0,u.numRetries=g.numRetries,u}return t._inheritsLoose(r,s),r}(_.BaseTask);function y(e,t,s){return`${e}:${t}:${s}`}var b;e.TaskStatus=void 0,(b=e.TaskStatus||(e.TaskStatus={}))[b.QUEUED=1]="QUEUED",b[b.DOWNLOADING=2]="DOWNLOADING",b[b.DOWNLOADED=3]="DOWNLOADED",b[b.CANCELLED=4]="CANCELLED",e.ImageWithType=L,e.test=g,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
