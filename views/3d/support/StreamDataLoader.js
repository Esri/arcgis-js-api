// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../request","../../../core/Accessor","../../../core/arrayUtils","../../../core/Error","../../../core/lang","../../../core/maybe","../../../core/promiseUtils","../../../core/accessorSupport/decorators","./AsyncWorkerQueue","./StreamDataLoaderTask","../webgl-engine/lib/Util","../../../views/support/Scheduler"],(function(e,t,r,n,a,o,s,u,i,l,c,d,p,h,f){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ImageWithType=t.StreamDataLoader=void 0;var g=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.tasks=new Map,t.onLoadQueue=new Array,t.doneQueue=new Array,t.updating=!1,t}return r.__extends(t,e),t.prototype.setup=function(e,t,r){var n=this;this.loadQueue=new d.AsyncWorkerQueue((function(e,t){return n.startLoading(e,t)}),(function(e,t){return n.doneLoadingCallback(e,t)}),e,t),r&&(this.taskHandle=r.registerTask(f.Task.STREAM_DATA_LOADER,(function(e){return n.update(e)}),(function(){return n.doneQueue.length>0||n.onLoadQueue.length>0})))},t.prototype.destroy=function(){this.taskHandle&&(this.taskHandle.remove(),this.taskHandle=null),this.tasks.forEach((function(e){e.abortController&&e.abortController.abort()})),this.loadQueue.clear(),this.loadQueue=null,this.onLoadQueue=null,this.doneQueue=null,this.tasks=null},Object.defineProperty(t.prototype,"busy",{get:function(){return this.loadQueue.busy},enumerable:!1,configurable:!0}),t.prototype.request=function(e,t,r,n){var a=this;void 0===n&&(n={});var o=l.createResolver();o.__signal=i.isSome(n)?n.signal:null;var s=this.createOrUpdateTask(e,t,r,n,o);return l.onAbort(n,(function(){return a.cancelRequest(s,o)})),o.promise},t.prototype.createTask=function(e,t,r,n,a,o){var s=new p.default(e,t,r,n,a);return this.updateTask(s,o),this.tasks.set(a,s),1===this.tasks.size&&this._set("updating",!0),this.loadQueue.push(s),s},t.prototype.cancelRequest=function(e,t){o.removeUnordered(e.resolvers,t),t.reject(l.createAbortError()),0===e.resolvers.length&&(2===e.status&&(e.status=4,this.loadQueue.cancel(e),e.abortController.abort(),e.request=null,e.abortController=null),e.status=4,this.tasks.delete(e.key),0===this.tasks.size&&this._set("updating",!1))},t.prototype.taskKey=function(e,t,r){return e+":"+t+":"+r},t.prototype.updateTask=function(e,t){e.resolvers.push(t)},t.prototype.createOrUpdateTask=function(e,t,r,n,a){var o=i.isSome(n)&&n.uid||e,s=this.taskKey(o,t,r),u=this.tasks.get(s);return u?(this.updateTask(u,a),u):this.createTask(e,n,t,r,s,a)},t.prototype.doneLoadingCallback=function(e,t){this.loadQueue&&(h.assert(2===e.status),e.status=3,this.taskHandle?this.doneQueue.push({task:e,err:t}):this.doneLoading(e,t))},t.prototype.update=function(e){for(;!e.done&&this.onLoadQueue.length>0;){var t=this.onLoadQueue.shift();l.throwIfAborted(t.task.abortController),t.task.abortController=null,t.callback(t.task),e.madeProgress()}for(;!e.done&&this.doneQueue.length>0;){var r=this.doneQueue.shift();3!==r.task.status&&(r.err=r.err||l.createAbortError()),this.doneLoading(r.task,r.err),e.madeProgress()}},t.prototype.doneLoading=function(e,t){for(var r=e.result instanceof HTMLImageElement?0:e.resolvers.length,n=0,a=e.resolvers;n<a.length;n++){var o=a[n];if(t)l.isAbortError(t)?o.reject(t):o.reject(new s("stream-data-loader:request-error","Failed to request resource at '"+e.url+"'. "+t,{url:e.url,error:t}));else{var i=--r<=0?e.result:u.clone(e.result);o.resolve(i)}}this.tasks.delete(e.key),0===this.tasks.size&&this._set("updating",!1)},t.prototype.startLoading=function(e,t){var a,o,s=this;if(4===e.status)return!1;switch(e.startTime=performance.now(),e.status=2,e.docType){case"binary":o="array-buffer",a=0;break;case"image":o="image";break;case"image+type":o="array-buffer";break;default:o="json"}e.abortController=l.createAbortController();var u=e.abortController.signal;e.request=n(e.url,r.__assign(r.__assign({},e.options),{responseType:o,timeout:a,signal:u}));var i=function(){},c=function(r){e.duration=performance.now()-e.startTime,e.size=r instanceof ArrayBuffer?r.byteLength:e.size||0,e.result=r,s.taskHandle?s.onLoadQueue.push({callback:t,task:e}):(e.abortController=null,t(e))},d=function(r){2===e.status&&t(e,r),i()};return"image+type"!==e.docType?(e.request.then((function(e){return c(e.data)}),d),!0):(e.request.then((function(t){var r=t.data,s=function(e){if(e.byteLength<2)return"unknown";var t=new Uint8Array(e,0,e.byteLength);if(137===t[0]&&80===t[1])return"image/png";if(71===t[0]&&73===t[1])return"image/gif";if(66===t[0]&&77===t[1])return"image/bmp";if(255===t[0]&&216===t[1])return"image/jpeg";return"unknown"}(r);if(o="image",e.size=r.byteLength,"unknown"===s)return e.request=n(e.url,{responseType:o,timeout:a,signal:u}),void e.request.then((function(e){return c(e.data)}),d);var l=new Blob([r],{type:s}),p=window.URL.createObjectURL(l);i=function(){return window.URL.revokeObjectURL(p)},e.request=n(p,{responseType:o,timeout:a,signal:u}),e.request.then((function(e){return c(new y(e.data,s,i))}),d)}),d),!0)},Object.defineProperty(t.prototype,"test",{get:function(){return{loadQueue:this.loadQueue}},enumerable:!1,configurable:!0}),r.__decorate([c.property({readOnly:!0})],t.prototype,"updating",void 0),t=r.__decorate([c.subclass("esri.views.3d.support.StreamDataLoader")],t)}(a);t.StreamDataLoader=g;var y=function(){function e(e,t,r){this.image=e,this.type=t,this.release=r}return Object.defineProperty(e.prototype,"isOpaque",{get:function(){return"image/jpeg"===this.type},enumerable:!1,configurable:!0}),e}();t.ImageWithType=y,t.default=g}));