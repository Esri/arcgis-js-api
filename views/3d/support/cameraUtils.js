/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../core/maybe","../../../core/Logger","../../../core/promiseUtils","../../../geometry/SpatialReference","../../../geometry/Point","../../../core/mathUtils","../../../chunks/vec3f64","../../../chunks/vec3","./mathUtils","../../../Camera","../../../geometry/projectionEllipsoid","../../../geometry/projection","../../support/spatialReferenceSupport","../../../geometry/support/scaleUtils","./ElevationProvider","./earthUtils","../camera/intersectionUtils","../../../chunks/cameraUtilsPlanar","../../../chunks/cameraUtilsSpherical"],(function(e,t,n,r,o,i,a,c,l,s,u,f,d,p,m,v,g,h,y,T){"use strict";const x=n.getLogger("esri.views.3d.support.cameraUtils"),R=39.37,S=96,w=1,M=8,C=5,P=1,j=c.create(),z=c.create(),V={heading:0,tilt:0},b=new i,U=new s.Cyclical(-20037508.342788905,20037508.342788905),E=new s.Cyclical(-180,180);function A(e){return e.spatialReference||o.WGS84}function N(e){return"global"===e.viewingMode?T.cameraUtilsSpherical:y.cameraUtilsPlanar}function H(e,t,n,r,o){return N(e).headingTiltToDirectionUp(t,n,r,o)}function O(e,n){if(t.isNone(n))return null;const r=e.renderSpatialReference,o=N(e).headingTiltToDirectionUp,i=c.create();if(!d.projectPointToVector(n.position,i,r))return null;const s=o(i,n.heading,n.tilt);l.scale(s.direction,s.direction,e.state.camera.distance),l.add(s.direction,s.direction,i);const u=h.cameraOnContentAlongViewDirection(e,i,s.direction,s.up);return u.fov=a.deg2rad(n.fov),u}const D=c.create();function I(e,n,r){const c=e.renderSpatialReference,l=q(e,n.eye,n.viewForward,n.up,V);let s=A(e);return d.projectVectorToVector(n.eye,c,D,s)||(s=o.WGS84,d.projectVectorToVector(n.eye,c,D,s)),t.isNone(r)?new u(new i(D,s),l.heading,l.tilt,a.rad2deg(n.fov)):(r.position.x=D[0],r.position.y=D[1],r.position.z=D[2],r.position.spatialReference=s,r.heading=l.heading,r.tilt=l.tilt,r.fov=a.rad2deg(n.fov),r)}function k(e,t,n){const r=e.state.camera,o=r.width/2/r.pixelRatio;1===e.renderCoordsHelper.viewingMode&&null!=n&&(t*=Math.cos(a.deg2rad(n))),t/=e.renderCoordsHelper.unitInMeters;return o/(S*R/t)/Math.tan(r.fovX/2)}function F(e,t,n){const r=e.state.camera,o=t*Math.tan(r.fovX/2),i=r.width/2/r.pixelRatio;let c=S*R/(i/o);return 1===e.renderCoordsHelper.viewingMode&&(c/=Math.cos(a.deg2rad(n))),c*=e.renderCoordsHelper.unitInMeters,c}function L(e,t,n,r,o,i){return G(e,t,k(e,n,t.latitude),r,o,i)}function G(e,n,r,o,i,a){if(fe(a)){const c=new ue(a.signal);return _(e,o.heading,o.tilt,n,r,i,c),void c.resolver.promise.then((n=>{const r=ie(e,n,o.fov);if(!t.isNone(r))return a.resolver.resolve(r);a.resolver.reject()}),(e=>a.resolver.reject(e)))}const c=_(e,o.heading,o.tilt,n,r,i);return ie(e,c,o.fov,a)}function q(e,t,n,r,o){return N(e).directionToHeadingTilt(t,n,r,o)}function W(e,n){return!!(e.basemapTerrain&&e.renderCoordsHelper.fromRenderCoords(n,b,e.spatialReference)&&t.unwrapOr(v.getElevationAtPoint(e.elevationProvider,b),0)>b.z-P)}async function X(e,n,r){if(!e.renderCoordsHelper.fromRenderCoords(n,b,e.spatialReference))return!1;const o=await e.elevationProvider.queryElevation(b.x,b.y,b.z,b.spatialReference,"ground",r);return t.unwrapOr(o,0)>b.z-P}async function Y(e,n,r){const o=c.create();if(n)if(n instanceof i){if(d.projectPointToVector(n,o,e.renderSpatialReference),null==n.z&&null!=e.basemapTerrain){const i=await e.elevationProvider.queryElevation(n.x,n.y,n.z,n.spatialReference,"ground",r);return t.isSome(i)&&e.renderCoordsHelper.setAltitude(i,o),o}}else l.copy(o,n);else l.copy(o,e.state.camera.center);return o}function Z(e,n){const r=c.create();if(n&&n instanceof i){if(d.projectPointToVector(n,r,e.renderSpatialReference),null==n.z&&null!=e.basemapTerrain){const o=v.getElevationAtPoint(e.elevationProvider,n);t.isSome(o)&&e.renderCoordsHelper.setAltitude(o,r)}}else n?l.copy(r,n):l.copy(r,e.state.camera.center);return r}function _(e,t,n,r,o,a,c){const l=r&&r instanceof i?r:null;if(fe(c))return Y(e,r,c.signal).then((r=>{B(e,t,n,l,r,o,a,c)}),(e=>c.resolver.reject(e))),null;const s=Z(e,r);return B(e,t,n,l,s,o,a,c)}function B(e,n,r,o,i,a,l,s){if(t.isNone(o)){const n=e.renderSpatialReference;if(o=d.projectVectorToPoint(i,n,A(e)),t.isNone(o))return null}a=Math.max(a,e.state.constraints.minimumPoiDistance);const u=$(e,n,r,i,a,l),f=(0,N(e).eyeForCenterWithHeadingTilt)(i,a,u.heading,u.tilt);if(1===l&&"global"===e.viewingMode&&r>0){const t=()=>{const t=re(e,i,a,ne(e,a,r,i));return B(e,n,t,o,i,a,l=r-t<1?0:1,s)},u=e.map.ground.navigationConstraint;if(!u||"stay-above"===u.type){if(W(e,f.eye))return t();if(fe(s))return X(e,f.eye,s.signal).then((e=>e?t():(s.resolver.resolve({eye:f.eye,up:f.up,center:c.clone(i),heading:f.heading,tilt:f.tilt}),null))),null}}const p=!s||fe(s)?{center:c.create(),eye:c.create(),up:c.create(),tilt:0,heading:0}:s;return p.eye=f.eye,p.up=f.up,p.center=c.clone(i),p.heading=f.heading,p.tilt=f.tilt,fe(s)&&s.resolver.resolve(p),p}function J(e,n,r,o,a,c=null){let l,s,u,d,m=0;null!=n.zmax&&null!=n.zmin&&(l=(n.zmax+n.zmin)/2,m=n.zmax-n.zmin);if("global"===e.viewingMode){if(!p.isSpatialReferenceSupported(n.spatialReference,"global"))return fe(c)&&c.resolver.reject(),null;const e=new i(n.xmin,n.ymin,n.spatialReference),t=new i(n.xmax,n.ymax,n.spatialReference),r=n.spatialReference.isGeographic?E:U;s=new i(r.center(e.x,t.x),(t.y+e.y)/2,n.spatialReference),null!=l&&(s.z=l);const o=f.getReferenceEllipsoid(n.spatialReference),a=g.getGreatCircleSpanAt(s,e,t);u=a.lon,d=a.lat,r.diff(e.x,t.x)>r.range/2&&(u+=o.halfCircumference),u=Math.min(u,o.halfCircumference),d=Math.min(d,o.halfCircumference)}else{const t=A(e);u=n.xmax-n.xmin,d=n.ymax-n.ymin,s=new i({x:n.xmin+.5*u,y:n.ymin+.5*d,z:l,spatialReference:t})}const v=e.state.camera,h=1/Math.tan(v.fovX/2),y=1/Math.tan(v.fovY/2),T=1/Math.tan(v.fov/2),x=Math.max(.5*u*h,.5*d*y,.5*m*T)/w;if(fe(c)){const n=new ue(c.signal);return _(e,r,o,s,x,a,n),void n.resolver.promise.then((n=>{const r=ie(e,n,e.camera.fov);if(!t.isNone(r))return c.resolver.resolve(r);c.resolver.reject()}),(e=>c.resolver.reject(e)))}const R=_(e,r,o,s,x,a);return ie(e,R,e.camera.fov,c)}function K(e,n,r){const o=e.renderSpatialReference,i=d.projectVectorToPoint(r,o,A(e));if(t.isNone(i))return null;const a=Math.tan(n.fovX/2),c=Math.tan(n.fovY/2),s=l.dist(n.eye,r),u=2*s*a*w,f=2*s*c*w;return"global"===e.viewingMode?T.toExtent(e,i,u,f):y.toExtent(e,i,u,f)}function Q(e,n,r){const o=e.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(r/o)/Math.LN2>M)return!0;const i=e.renderSpatialReference,a=A(e),c=d.projectVectorToPoint(n,i,a),l=d.projectVectorToPoint(e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,i,a);if(t.isNone(c)||t.isNone(l))return!1;const s=Math.tan(.5*e.state.camera.fov)*o;return l.distance(c)/s>C}function $(e,t,n,r,o,i){let a=0;return 1===i&&Q(e,r,o)?(t=0,a=te(e,o,n,r)):a=oe(e,r,o,n),a=e.state.constraints.clampTilt(o,a),{heading:t,tilt:n=re(e,r,o,a)}}const ee=.7;function te(e,t,n,r){const o=e.state.constraints.tilt(t);o.max=Math.min(o.max,.5*Math.PI);const i=o.min*(1-ee)+o.max*ee,a=oe(e,r,t,n);return Math.min(a,i)}function ne(e,t,n,r){const o=e.state.constraints.tilt(t);let i=oe(e,r,t,n);return i=Math.min(i,.5*Math.PI),o.min*(1-ee)+i*ee}function re(e,t,n,r){return N(e).lookAtTiltToEyeTilt(r,t,n)}function oe(e,t,n,r){return N(e).eyeTiltToLookAtTilt(r,t,n)}function ie(e,n,r,o){if(t.isNone(n))return null;const i=e.renderSpatialReference,a=d.projectVectorToPoint(n.eye,i,A(e));return t.isNone(a)?null:t.isSome(o)?(o.position=a,o.heading=n.heading,o.tilt=n.tilt,o.fov=r,o):new u(a,n.heading,n.tilt,r)}function ae(e,t){var n;const r=null==(n=e.basemapTerrain)?void 0:n.tilingScheme;if(r)return r.levelAtScale(t);x.error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")}function ce(e,t){var n;const r=null==(n=e.basemapTerrain)?void 0:n.tilingScheme;if(r)return r.scaleAtLevel(t);x.error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")}function le(e,t){return e.spatialReference?m.getResolutionForScale(t,e.spatialReference):void 0}function se(e,t,n){const r=e.renderSpatialReference;let i,a;t||(t=e.state.camera);const c=o.WGS84;return t instanceof u?(i=t.position.latitude,d.projectPointToVector(t.position,j,r),d.projectPointToVector(n,z,r),a=l.distance(j,z)):(d.projectVectorToVector(t.center,r,z,c),i=z[1],a=t.distance),F(e,a,i)}let ue=function(e){this.signal=e,this.resolver=r.createResolver()};function fe(e){return e&&"resolver"in e}e.AsyncContext=ue,e.computeScale=se,e.directionToHeadingTilt=q,e.distanceToScale=F,e.externalToInternal=O,e.fromCenterDistance=G,e.fromCenterScale=L,e.fromExtent=J,e.getObserverForPointAtDistance=_,e.headingTiltToDirectionUp=H,e.internalToExternal=I,e.observerToCamera=ie,e.scaleToDistance=k,e.scaleToResolution=le,e.scaleToZoom=ae,e.toExtent=K,e.zoomToScale=ce,Object.defineProperty(e,"__esModule",{value:!0})}));
