/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../Camera","../../../core/Cyclical","../../../core/Logger","../../../core/mathUtils","../../../core/maybe","../../../core/promiseUtils","../../../chunks/vec3","../../../chunks/vec3f64","../../../geometry/ellipsoidUtils","../../../geometry/Point","../../../geometry/projection","../../../geometry/SpatialReference","../../ViewingMode","../camera/intersectionUtils","../../../chunks/cameraUtilsPlanar","../../../chunks/cameraUtilsSpherical","./earthUtils","./ElevationProvider","../../support/spatialReferenceSupport"],(function(e,t,n,r,o,i,a,c,l,s,u,f,d,p,m,v,g,h,y,T,M){"use strict";const S=o.getLogger("esri.views.3d.support.cameraUtils"),x=39.37,R=96,w=1,C=8,P=5,z=1,j=s.create(),O={heading:0,tilt:0},b=new f,V=new r.Cyclical(-20037508.342788905,20037508.342788905),U=new r.Cyclical(-180,180);var A;function D(e){return e.spatialReference||p.WGS84}function E(e){return"global"===e.viewingMode?h.cameraUtilsSpherical:g.cameraUtilsPlanar}function H(e,t,n,r,o){return E(e).headingTiltToDirectionUp(t,n,r,o)}function N(e,t){if(a.isNone(t))return null;const n=e.renderSpatialReference,r=E(e).headingTiltToDirectionUp,o=s.create();if(!d.projectPointToVector(t.position,o,n))return null;const c=r(o,t.heading,t.tilt);l.scale(c.direction,c.direction,e.state.camera.distance),l.add(c.direction,c.direction,o);const u=v.cameraOnContentAlongViewDirection(e,o,c.direction,c.up);return u.fov=i.deg2rad(t.fov),u}e.OrientationMode=void 0,(A=e.OrientationMode||(e.OrientationMode={}))[A.LOCKED=0]="LOCKED",A[A.ADJUST=1]="ADJUST";const G=s.create();function L(e,t,r){const o=e.renderSpatialReference,c=J(e,t.eye,t.viewForward,t.up,O);let l=D(e);return d.projectVectorToVector(t.eye,o,G,l)||(l=p.WGS84,d.projectVectorToVector(t.eye,o,G,l)),a.isNone(r)?new n(new f(G,l),c.heading,c.tilt,i.rad2deg(t.fov)):(r.position.x=G[0],r.position.y=G[1],r.position.z=G[2],r.position.spatialReference=l,r.heading=c.heading,r.tilt=c.tilt,r.fov=i.rad2deg(t.fov),r)}function k(e,t,n){const r=e.state.camera,o=r.width/2/r.pixelRatio;e.renderCoordsHelper.viewingMode===m.ViewingMode.Global&&null!=n&&(t*=Math.cos(i.deg2rad(n))),t/=e.renderCoordsHelper.unitInMeters;return o/(R*x/t)/Math.tan(r.fovX/2)}function I(e,t,n){const r=e.state.camera,o=t*Math.tan(r.fovX/2),a=r.width/2/r.pixelRatio;let c=R*x/(a/o);return e.renderCoordsHelper.viewingMode===m.ViewingMode.Global&&null!=n&&(c/=Math.cos(i.deg2rad(n))),c*=e.renderCoordsHelper.unitInMeters,c}function q(e,t,n,r,o,i){return F(e,t,k(e,n,t.latitude),r,o,i)}function F(e,t,n,r,o,i){if(pe(i)){const c=new de(i.signal);return B(e,r.heading,r.tilt,t,n,o,c),void c.resolver.promise.then((t=>{const n=le(e,t,r.fov);if(!a.isNone(n))return i.resolver.resolve(n);i.resolver.reject()}),(e=>i.resolver.reject(e)))}const c=B(e,r.heading,r.tilt,t,n,o);return le(e,c,r.fov,i)}function J(e,t,n,r,o){return E(e).directionToHeadingTilt(t,n,r,o)}function W(e,t){return!!(e.basemapTerrain&&e.renderCoordsHelper.fromRenderCoords(t,b,e.spatialReference)&&e.elevationProvider&&a.unwrapOr(T.getElevationAtPoint(e.elevationProvider,b),0)>(b.z??0)-z)}function X(e,t,n){return K.apply(this,arguments)}function K(){return(K=t._asyncToGenerator((function*(e,t,n){if(!e.renderCoordsHelper.fromRenderCoords(t,b,e.spatialReference)||!e.elevationProvider)return!1;const r=b.z??0,o=yield e.elevationProvider.queryElevation(b.x,b.y,r,b.spatialReference,"ground",n);return a.unwrapOr(o,0)>r-z}))).apply(this,arguments)}function _(e,t,n){return Y.apply(this,arguments)}function Y(){return(Y=t._asyncToGenerator((function*(e,t,n){const r=s.create();if(t)if(t instanceof f){if(d.projectPointToVector(t,r,e.renderSpatialReference),null==t.z&&null!=e.basemapTerrain&&null!=e.elevationProvider){const o=yield e.elevationProvider.queryElevation(t.x,t.y,t.z??0,t.spatialReference,"ground",n);return a.isSome(o)&&e.renderCoordsHelper.setAltitude(r,o),r}}else l.copy(r,t);else l.copy(r,e.state.camera.center);return r}))).apply(this,arguments)}function Z(e,t){const n=s.create();if(t&&t instanceof f){if(d.projectPointToVector(t,n,e.renderSpatialReference),null==t.z&&null!=e.basemapTerrain&&null!=e.elevationProvider){const r=T.getElevationAtPoint(e.elevationProvider,t);a.isSome(r)&&e.renderCoordsHelper.setAltitude(n,r)}}else t?l.copy(n,t):l.copy(n,e.state.camera.center);return n}function B(e,t,n,r,o,i,a){const c=r&&r instanceof f?r:null;if(pe(a))return _(e,r,a.signal).then((r=>{Q(e,t,n,c,r,o,i,a)}),(e=>a.resolver.reject(e))),null;const l=Z(e,r);return Q(e,t,n,c,l,o,i,a)}function Q(t,n,r,o,i,c,l,u){if(a.isNone(o)){const e=t.renderSpatialReference;if(o=d.projectVectorToPoint(i,e,D(t)),a.isNone(o))return null}c=Math.max(c,t.state.constraints.minimumPoiDistance);const f=ne(t,n,r,i,c,l),p=(0,E(t).eyeForCenterWithHeadingTilt)(i,c,f.heading,f.tilt);if(l===e.OrientationMode.ADJUST&&"global"===t.viewingMode&&r>0){const a=()=>{const a=ae(t,i,c,ie(t,c,r,i));return l=r-a<1?e.OrientationMode.LOCKED:e.OrientationMode.ADJUST,Q(t,n,a,o,i,c,l,u)},f=t.map.ground.navigationConstraint;if(!f||"stay-above"===f.type){if(W(t,p.eye))return a();if(pe(u))return X(t,p.eye,u.signal).then((e=>e?a():(u.resolver.resolve({eye:p.eye,up:p.up,center:s.clone(i),heading:p.heading,tilt:p.tilt}),null))),null}}const m=!u||pe(u)?{center:s.create(),eye:s.create(),up:s.create(),tilt:0,heading:0}:u;return m.eye=p.eye,m.up=p.up,m.center=s.clone(i),m.heading=p.heading,m.tilt=p.tilt,pe(u)&&u.resolver.resolve(m),m}function $(e,t,n,r,o,i=null){let c,l,s;if(e.state.isGlobal){if(!M.isSpatialReferenceSupported(t.spatialReference,m.ViewingMode.Global))return pe(i)&&i.resolver.reject(),null;const e=new f(t.xmin,t.ymin,t.spatialReference),n=new f(t.xmax,t.ymax,t.spatialReference),r=t.spatialReference.isGeographic?U:V;c=new f({x:r.center(e.x,n.x),y:(n.y+e.y)/2,z:null!=t.zmax&&null!=t.zmin?(t.zmax+t.zmin)/2:void 0,spatialReference:t.spatialReference});const o=u.getReferenceEllipsoid(t.spatialReference),a=y.getGreatCircleSpanAt(c,e,n);l=a.lon,s=a.lat,r.diff(e.x,n.x)>r.range/2&&(l+=o.halfCircumference),l=Math.min(l,o.halfCircumference),s=Math.min(s,o.halfCircumference)}else{const n=a.unwrapOr(e.renderSpatialReference,t.spatialReference);n.equals(t.spatialReference)||(t=d.project(t,n)),l=t.xmax-t.xmin,s=t.ymax-t.ymin;const r=null!=t.zmax&&null!=t.zmin?(t.zmax+t.zmin)/2:void 0;c=new f({x:t.xmin+.5*l,y:t.ymin+.5*s,z:r,spatialReference:n})}const p=null!=t.zmax&&null!=t.zmin?t.zmax-t.zmin:0,v=e.state.camera,g=1/Math.tan(v.fovX/2),h=1/Math.tan(v.fovY/2),T=1/Math.tan(v.fov/2),S=Math.max(.5*l*g,.5*s*h,.5*p*T)/w;if(pe(i)){const t=new de(i.signal);return B(e,n,r,c,S,o,t),void t.resolver.promise.then((t=>{const n=le(e,t,e.camera.fov);if(!a.isNone(n))return i.resolver.resolve(n);i.resolver.reject()}),(e=>i.resolver.reject(e)))}const x=B(e,n,r,c,S,o);return le(e,x,e.camera.fov,i)}function ee(e,t,n){const r=e.renderSpatialReference,o=d.projectVectorToPoint(n,r,D(e));if(a.isNone(o))return null;const i=Math.tan(t.fovX/2),c=Math.tan(t.fovY/2),s=l.dist(t.eye,n),u=2*s*i*w,f=2*s*c*w;return"global"===e.viewingMode?h.toExtent(e,o,u,f):g.toExtent(e,o,u,f)}function te(e,t,n){const r=e.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(n/r)/Math.LN2>C)return!0;const o=e.renderSpatialReference,i=D(e),c=d.projectVectorToPoint(t,o,i),l=d.projectVectorToPoint(e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,o,i);if(a.isNone(c)||a.isNone(l))return!1;const s=Math.tan(.5*e.state.camera.fov)*r;return l.distance(c)/s>P}function ne(t,n,r,o,i,a){let c=0;return a===e.OrientationMode.ADJUST&&te(t,o,i)?(n=0,c=oe(t,i,r,o)):c=ce(t,o,i,r),c=t.state.constraints.clampTilt(i,c),{heading:n,tilt:r=ae(t,o,i,c)}}const re=.7;function oe(e,t,n,r){const o=ce(e,r,t,n);if(!e.state.constraints.tilt)return o;const i=e.state.constraints.tilt(t);i.max=Math.min(i.max,.5*Math.PI);const a=i.min*(1-re)+i.max*re;return Math.min(o,a)}function ie(e,t,n,r){let o=ce(e,r,t,n);if(!e.state.constraints.tilt)return o;const i=e.state.constraints.tilt(t);return o=Math.min(o,.5*Math.PI),i.min*(1-re)+o*re}function ae(e,t,n,r){return E(e).lookAtTiltToEyeTilt(r,t,n)}function ce(e,t,n,r){return E(e).eyeTiltToLookAtTilt(r,t,n)}function le(e,t,r,o){if(a.isNone(t))return null;const i=e.renderSpatialReference,c=d.projectVectorToPoint(t.eye,i,D(e));return a.isNone(c)?null:a.isSome(o)?(o.position=c,o.heading=t.heading,o.tilt=t.tilt,o.fov=r,o):new n(c,t.heading,t.tilt,r)}function se(e,t){const n=e.basemapTerrain?.tilingScheme;if(n)return n.levelAtScale(t);S.error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")}function ue(e,t){const n=e.basemapTerrain?.tilingScheme;if(n)return n.scaleAtLevel(t);S.error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")}function fe(e,t){return d.projectVectorToVector(t.center,e.renderSpatialReference,j,p.WGS84),I(e,t.distance,j[1])}let de=function(e){this.signal=e,this.resolver=c.createResolver()};function pe(e){return e&&"resolver"in e}e.AsyncContext=de,e.computeScale=fe,e.directionToHeadingTilt=J,e.distanceToScale=I,e.externalToInternal=N,e.fromCenterDistance=F,e.fromCenterScale=q,e.fromExtent=$,e.getObserverForPointAtDistance=B,e.headingTiltToDirectionUp=H,e.internalToExternal=L,e.observerToCamera=le,e.scaleToDistance=k,e.scaleToZoom=se,e.toExtent=ee,e.zoomToScale=ue,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
