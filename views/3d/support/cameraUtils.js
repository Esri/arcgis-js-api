/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../Camera","../../../core/Logger","../../../core/mathUtils","../../../core/maybe","../../../core/promiseUtils","../../../chunks/vec3","../../../chunks/vec3f64","../../../geometry/Point","../../../geometry/projection","../../../geometry/projectionEllipsoid","../../../geometry/SpatialReference","../../../geometry/support/scaleUtils","../camera/intersectionUtils","../../../chunks/cameraUtilsPlanar","../../../chunks/cameraUtilsSpherical","./earthUtils","./ElevationProvider","./mathUtils","../../support/spatialReferenceSupport"],(function(e,t,n,r,o,i,a,c,l,s,u,f,p,d,m,v,h,g,y,T,R){"use strict";const x=r.getLogger("esri.views.3d.support.cameraUtils"),S=39.37,M=96,w=1,C=8,P=5,j=1,z=l.create(),V=l.create(),b={heading:0,tilt:0},U=new s,E=new T.Cyclical(-20037508.342788905,20037508.342788905),A=new T.Cyclical(-180,180);function H(e){return e.spatialReference||p.WGS84}function N(e){return"global"===e.viewingMode?h.cameraUtilsSpherical:v.cameraUtilsPlanar}function O(e,t,n,r,o){return N(e).headingTiltToDirectionUp(t,n,r,o)}function D(e,t){if(i.isNone(t))return null;const n=e.renderSpatialReference,r=N(e).headingTiltToDirectionUp,a=l.create();if(!u.projectPointToVector(t.position,a,n))return null;const s=r(a,t.heading,t.tilt);c.scale(s.direction,s.direction,e.state.camera.distance),c.add(s.direction,s.direction,a);const f=m.cameraOnContentAlongViewDirection(e,a,s.direction,s.up);return f.fov=o.deg2rad(t.fov),f}const k=l.create();function G(e,t,r){const a=e.renderSpatialReference,c=_(e,t.eye,t.viewForward,t.up,b);let l=H(e);return u.projectVectorToVector(t.eye,a,k,l)||(l=p.WGS84,u.projectVectorToVector(t.eye,a,k,l)),i.isNone(r)?new n(new s(k,l),c.heading,c.tilt,o.rad2deg(t.fov)):(r.position.x=k[0],r.position.y=k[1],r.position.z=k[2],r.position.spatialReference=l,r.heading=c.heading,r.tilt=c.tilt,r.fov=o.rad2deg(t.fov),r)}function I(e,t,n){const r=e.state.camera,i=r.width/2/r.pixelRatio;1===e.renderCoordsHelper.viewingMode&&null!=n&&(t*=Math.cos(o.deg2rad(n))),t/=e.renderCoordsHelper.unitInMeters;return i/(M*S/t)/Math.tan(r.fovX/2)}function F(e,t,n){const r=e.state.camera,i=t*Math.tan(r.fovX/2),a=r.width/2/r.pixelRatio;let c=M*S/(a/i);return 1===e.renderCoordsHelper.viewingMode&&(c/=Math.cos(o.deg2rad(n))),c*=e.renderCoordsHelper.unitInMeters,c}function L(e,t,n,r,o,i){return q(e,t,I(e,n,t.latitude),r,o,i)}function q(e,t,n,r,o,a){if(me(a)){const c=new de(a.signal);return K(e,r.heading,r.tilt,t,n,o,c),void c.resolver.promise.then((t=>{const n=le(e,t,r.fov);if(!i.isNone(n))return a.resolver.resolve(n);a.resolver.reject()}),(e=>a.resolver.reject(e)))}const c=K(e,r.heading,r.tilt,t,n,o);return le(e,c,r.fov,a)}function _(e,t,n,r,o){return N(e).directionToHeadingTilt(t,n,r,o)}function W(e,t){return!!(e.basemapTerrain&&e.renderCoordsHelper.fromRenderCoords(t,U,e.spatialReference)&&i.unwrapOr(y.getElevationAtPoint(e.elevationProvider,U),0)>U.z-j)}function X(e,t,n){return Y.apply(this,arguments)}function Y(){return(Y=t._asyncToGenerator((function*(e,t,n){if(!e.renderCoordsHelper.fromRenderCoords(t,U,e.spatialReference))return!1;const r=yield e.elevationProvider.queryElevation(U.x,U.y,U.z,U.spatialReference,"ground",n);return i.unwrapOr(r,0)>U.z-j}))).apply(this,arguments)}function Z(e,t,n){return B.apply(this,arguments)}function B(){return(B=t._asyncToGenerator((function*(e,t,n){const r=l.create();if(t)if(t instanceof s){if(u.projectPointToVector(t,r,e.renderSpatialReference),null==t.z&&null!=e.basemapTerrain){const o=yield e.elevationProvider.queryElevation(t.x,t.y,t.z,t.spatialReference,"ground",n);return i.isSome(o)&&e.renderCoordsHelper.setAltitude(r,o),r}}else c.copy(r,t);else c.copy(r,e.state.camera.center);return r}))).apply(this,arguments)}function J(e,t){const n=l.create();if(t&&t instanceof s){if(u.projectPointToVector(t,n,e.renderSpatialReference),null==t.z&&null!=e.basemapTerrain){const r=y.getElevationAtPoint(e.elevationProvider,t);i.isSome(r)&&e.renderCoordsHelper.setAltitude(n,r)}}else t?c.copy(n,t):c.copy(n,e.state.camera.center);return n}function K(e,t,n,r,o,i,a){const c=r&&r instanceof s?r:null;if(me(a))return Z(e,r,a.signal).then((r=>{Q(e,t,n,c,r,o,i,a)}),(e=>a.resolver.reject(e))),null;const l=J(e,r);return Q(e,t,n,c,l,o,i,a)}function Q(e,t,n,r,o,a,c,s){if(i.isNone(r)){const t=e.renderSpatialReference;if(r=u.projectVectorToPoint(o,t,H(e)),i.isNone(r))return null}a=Math.max(a,e.state.constraints.minimumPoiDistance);const f=ne(e,t,n,o,a,c),p=(0,N(e).eyeForCenterWithHeadingTilt)(o,a,f.heading,f.tilt);if(1===c&&"global"===e.viewingMode&&n>0){const i=()=>{const i=ae(e,o,a,ie(e,a,n,o));return Q(e,t,i,r,o,a,c=n-i<1?0:1,s)},u=e.map.ground.navigationConstraint;if(!u||"stay-above"===u.type){if(W(e,p.eye))return i();if(me(s))return X(e,p.eye,s.signal).then((e=>e?i():(s.resolver.resolve({eye:p.eye,up:p.up,center:l.clone(o),heading:p.heading,tilt:p.tilt}),null))),null}}const d=!s||me(s)?{center:l.create(),eye:l.create(),up:l.create(),tilt:0,heading:0}:s;return d.eye=p.eye,d.up=p.up,d.center=l.clone(o),d.heading=p.heading,d.tilt=p.tilt,me(s)&&s.resolver.resolve(d),d}function $(e,t,n,r,o,a=null){const c=null!=t.zmax&&null!=t.zmin;let l,p,d;if("global"===e.viewingMode){if(!R.isSpatialReferenceSupported(t.spatialReference,"global"))return me(a)&&a.resolver.reject(),null;const e=new s(t.xmin,t.ymin,t.spatialReference),n=new s(t.xmax,t.ymax,t.spatialReference),r=t.spatialReference.isGeographic?A:E;l=new s({x:r.center(e.x,n.x),y:(n.y+e.y)/2,z:c?(t.zmax+t.zmin)/2:null,spatialReference:t.spatialReference});const o=f.getReferenceEllipsoid(t.spatialReference),i=g.getGreatCircleSpanAt(l,e,n);p=i.lon,d=i.lat,r.diff(e.x,n.x)>r.range/2&&(p+=o.halfCircumference),p=Math.min(p,o.halfCircumference),d=Math.min(d,o.halfCircumference)}else{const n=i.unwrapOr(e.renderSpatialReference,t.spatialReference);n.equals(t.spatialReference)||(t=u.project(t,n)),p=t.xmax-t.xmin,d=t.ymax-t.ymin;const r=c?(t.zmax+t.zmin)/2:null;l=new s({x:t.xmin+.5*p,y:t.ymin+.5*d,z:r,spatialReference:n})}const m=c?t.zmax-t.zmin:0,v=e.state.camera,h=1/Math.tan(v.fovX/2),y=1/Math.tan(v.fovY/2),T=1/Math.tan(v.fov/2),x=Math.max(.5*p*h,.5*d*y,.5*m*T)/w;if(me(a)){const t=new de(a.signal);return K(e,n,r,l,x,o,t),void t.resolver.promise.then((t=>{const n=le(e,t,e.camera.fov);if(!i.isNone(n))return a.resolver.resolve(n);a.resolver.reject()}),(e=>a.resolver.reject(e)))}const S=K(e,n,r,l,x,o);return le(e,S,e.camera.fov,a)}function ee(e,t,n){const r=e.renderSpatialReference,o=u.projectVectorToPoint(n,r,H(e));if(i.isNone(o))return null;const a=Math.tan(t.fovX/2),l=Math.tan(t.fovY/2),s=c.dist(t.eye,n),f=2*s*a*w,p=2*s*l*w;return"global"===e.viewingMode?h.toExtent(e,o,f,p):v.toExtent(e,o,f,p)}function te(e,t,n){const r=e.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(n/r)/Math.LN2>C)return!0;const o=e.renderSpatialReference,a=H(e),c=u.projectVectorToPoint(t,o,a),l=u.projectVectorToPoint(e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,o,a);if(i.isNone(c)||i.isNone(l))return!1;const s=Math.tan(.5*e.state.camera.fov)*r;return l.distance(c)/s>P}function ne(e,t,n,r,o,i){let a=0;return 1===i&&te(e,r,o)?(t=0,a=oe(e,o,n,r)):a=ce(e,r,o,n),a=e.state.constraints.clampTilt(o,a),{heading:t,tilt:n=ae(e,r,o,a)}}const re=.7;function oe(e,t,n,r){const o=e.state.constraints.tilt(t);o.max=Math.min(o.max,.5*Math.PI);const i=o.min*(1-re)+o.max*re,a=ce(e,r,t,n);return Math.min(a,i)}function ie(e,t,n,r){const o=e.state.constraints.tilt(t);let i=ce(e,r,t,n);return i=Math.min(i,.5*Math.PI),o.min*(1-re)+i*re}function ae(e,t,n,r){return N(e).lookAtTiltToEyeTilt(r,t,n)}function ce(e,t,n,r){return N(e).eyeTiltToLookAtTilt(r,t,n)}function le(e,t,r,o){if(i.isNone(t))return null;const a=e.renderSpatialReference,c=u.projectVectorToPoint(t.eye,a,H(e));return i.isNone(c)?null:i.isSome(o)?(o.position=c,o.heading=t.heading,o.tilt=t.tilt,o.fov=r,o):new n(c,t.heading,t.tilt,r)}function se(e,t){var n;const r=null==(n=e.basemapTerrain)?void 0:n.tilingScheme;if(r)return r.levelAtScale(t);x.error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")}function ue(e,t){var n;const r=null==(n=e.basemapTerrain)?void 0:n.tilingScheme;if(r)return r.scaleAtLevel(t);x.error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")}function fe(e,t){return e.spatialReference?d.getResolutionForScale(t,e.spatialReference):void 0}function pe(e,t,r){const o=e.renderSpatialReference;let i,a;t||(t=e.state.camera);const l=p.WGS84;return t instanceof n?(i=t.position.latitude,u.projectPointToVector(t.position,z,o),u.projectPointToVector(r,V,o),a=c.distance(z,V)):(u.projectVectorToVector(t.center,o,V,l),i=V[1],a=t.distance),F(e,a,i)}let de=function(e){this.signal=e,this.resolver=a.createResolver()};function me(e){return e&&"resolver"in e}e.AsyncContext=de,e.computeScale=pe,e.directionToHeadingTilt=_,e.distanceToScale=F,e.externalToInternal=D,e.fromCenterDistance=q,e.fromCenterScale=L,e.fromExtent=$,e.getObserverForPointAtDistance=K,e.headingTiltToDirectionUp=O,e.internalToExternal=G,e.observerToCamera=le,e.scaleToDistance=I,e.scaleToResolution=fe,e.scaleToZoom=se,e.toExtent=ee,e.zoomToScale=ue,Object.defineProperty(e,"__esModule",{value:!0})}));
