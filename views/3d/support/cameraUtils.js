/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../core/maybe","../../../core/Logger","../../../core/promiseUtils","../../../geometry/SpatialReference","../../../geometry/Point","../../../core/mathUtils","../../../chunks/vec3f64","../../../chunks/vec3","./mathUtils","../../../Camera","../../../geometry/projectionEllipsoid","../../../geometry/projection","../../support/spatialReferenceSupport","../../../geometry/support/scaleUtils","./ElevationProvider","./earthUtils","../camera/intersectionUtils","../../../chunks/cameraUtilsPlanar","../../../chunks/cameraUtilsSpherical"],(function(e,t,n,r,o,i,a,c,l,s,u,f,p,d,m,g,v,h,T,y){"use strict";const x=n.getLogger("esri.views.3d.support.cameraUtils"),R=c.create(),S=c.create(),M=c.create(),w={heading:0,tilt:0},P=new i,C=new s.Cyclical(-20037508.342788905,20037508.342788905),j=new s.Cyclical(-180,180);function b(e){return e.spatialReference||o.WGS84}function z(e){return"global"===e.viewingMode?y.cameraUtilsSpherical:T.cameraUtilsPlanar}const V=c.create();function U(e,t,n){const r=e.state.camera,o=r.fovX,i=r.width/2/r.pixelRatio;"global"===e.viewingMode&&null!=n&&(t*=Math.cos(a.deg2rad(n)));return i/(3779.5199999999995/(t/=e.renderCoordsHelper.unitInMeters))/Math.tan(o/2)}function E(e,t,n){const r=e.state.camera,o=r.fovX,i=t*Math.tan(o/2);let c=3779.5199999999995/(r.width/2/r.pixelRatio/i);return"global"===e.viewingMode&&(c/=Math.cos(a.deg2rad(n))),c*=e.renderCoordsHelper.unitInMeters,c}function A(e,n,r,o,i,a){if(G(a)){const c=new L(a.signal);return N(e,o.heading,o.tilt,n,r,i,c),void c.resolver.promise.then((n=>{const r=F(e,n,o.fov);if(!t.isNone(r))return a.resolver.resolve(r);a.resolver.reject()}),(e=>a.resolver.reject(e)))}const c=N(e,o.heading,o.tilt,n,r,i);return F(e,c,o.fov,a)}function H(e,t,n,r,o){return z(e).directionToHeadingTilt(t,n,r,o)}function N(e,t,n,r,o,a,s){const u=r&&r instanceof i?r:null;if(G(s))return async function(e,t,n){const r=c.create();if(t)if(t instanceof i){if(p.projectPointToVector(t,r,e.renderSpatialReference),null==t.z&&null!=e.basemapTerrain){const o=await e.elevationProvider.queryElevation(t.x,t.y,t.z,t.spatialReference,"ground",n);return null!=o&&e.renderCoordsHelper.setAltitude(o,r),r}}else l.copy(r,t);else l.copy(r,e.state.camera.center);return r}(e,r,s.signal).then((r=>{D(e,t,n,u,r,o,a,s)}),(e=>s.resolver.reject(e))),null;const f=function(e,t){const n=c.create();if(t&&t instanceof i){if(p.projectPointToVector(t,n,e.renderSpatialReference),null==t.z&&null!=e.basemapTerrain){const r=g.getElevationAtPoint(e.elevationProvider,t);null!=r&&e.renderCoordsHelper.setAltitude(r,n)}}else t?l.copy(n,t):l.copy(n,e.state.camera.center);return n}(e,r);return D(e,t,n,u,f,o,a,s)}function D(e,n,r,o,i,a,l,s){if(!o){const t=e.renderSpatialReference,n=b(e);if(!(o=p.projectVectorToPoint(i,t,n)))return null}a=Math.max(a,e.state.constraints.minimumPoiDistance);const u=function(e,n,r,o,i,a){let c=0;1===a&&function(e,n,r){const o=e.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(r/o)/Math.LN2>8)return!0;const i=e.renderSpatialReference,a=b(e),c=p.projectVectorToPoint(n,i,a),l=p.projectVectorToPoint(e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,i,a);if(t.isNone(c)||t.isNone(l))return!1;const s=Math.tan(.5*e.state.camera.fov)*o;return l.distance(c)/s>5}(e,o,i)?(n=0,c=function(e,t,n,r){const o=e.state.constraints.tilt(t);o.max=Math.min(o.max,.5*Math.PI);const i=o.min*(1-I)+o.max*I,a=k(e,r,t,n);return Math.min(a,i)}(e,i,r,o)):c=k(e,o,i,r);return c=e.state.constraints.clampTilt(i,c),r=O(e,o,i,c),{heading:n,tilt:r}}(e,n,r,i,a,l),f=(0,z(e).eyeForCenterWithHeadingTilt)(i,a,u.heading,u.tilt);if(1===l&&"global"===e.viewingMode&&r>0){const t=()=>{const t=O(e,i,a,function(e,t,n,r){const o=e.state.constraints.tilt(t);let i=k(e,r,t,n);return i=Math.min(i,.5*Math.PI),o.min*(1-I)+i*I}(e,a,r,i));return D(e,n,t,o,i,a,l=r-t<1?0:1,s)},u=e.map.ground.navigationConstraint;if(!u||"stay-above"===u.type){if(function(e,t){return!!(e.basemapTerrain&&e.renderCoordsHelper.fromRenderCoords(t,P,e.spatialReference)&&g.getElevationAtPoint(e.elevationProvider,P)>P.z-1)}(e,f.eye))return t();if(G(s))return async function(e,t,n){return!!e.renderCoordsHelper.fromRenderCoords(t,P,e.spatialReference)&&await e.elevationProvider.queryElevation(P.x,P.y,P.z,P.spatialReference,"ground",n)>P.z-1}(e,f.eye,s.signal).then((e=>e?t():(s.resolver.resolve({eye:f.eye,up:f.up,center:c.clone(i),heading:f.heading,tilt:f.tilt}),null))),null}}const d=!s||G(s)?{center:c.create(),eye:c.create(),up:c.create(),tilt:0,heading:0}:s;return d.eye=f.eye,d.up=f.up,d.center=c.clone(i),d.heading=f.heading,d.tilt=f.tilt,G(s)&&s.resolver.resolve(d),d}const I=.7;function O(e,t,n,r){return z(e).lookAtTiltToEyeTilt(r,t,n)}function k(e,t,n,r){return z(e).eyeTiltToLookAtTilt(r,t,n)}function F(e,n,r,o){if(t.isNone(n))return null;const i=e.renderSpatialReference,a=b(e),c=p.projectVectorToPoint(n.eye,i,a);return t.isNone(c)?null:t.isSome(o)?(o.position=c,o.heading=n.heading,o.tilt=n.tilt,o.fov=r,o):new u(c,n.heading,n.tilt,r)}let L=function(e){this.signal=e,this.resolver=r.createResolver()};function G(e){return e&&"resolver"in e}e.AsyncContext=L,e.computeScale=function(e,t,n){const r=e.renderSpatialReference;let i,a;t||(t=e.state.camera);const c=o.WGS84;return t instanceof u?(i=t.position.latitude,p.projectPointToVector(t.position,R,r),p.projectPointToVector(n,S,r),a=l.distance(R,S)):(p.projectVectorToVector(t.center,r,S,c),i=S[1],a=t.distance),E(e,a,i)},e.directionToHeadingTilt=H,e.distanceToScale=E,e.externalToInternal=function(e,t){const n=e.renderSpatialReference,r=z(e).headingTiltToDirectionUp,o=c.create();if(!p.projectPointToVector(t.position,o,n))return null;const i=r(o,t.heading,t.tilt);l.scale(i.direction,i.direction,e.state.camera.distance),l.add(i.direction,i.direction,o);const s=h.cameraOnContentAlongViewDirection(e,o,i.direction,i.up);return s.fov=a.deg2rad(t.fov),s},e.fromCenterDistance=A,e.fromCenterScale=function(e,t,n,r,o,i){return A(e,t,U(e,n,t.latitude),r,o,i)},e.fromExtent=function(e,n,r,o,a,c=null){let l,s,u,p,m=0;if(null!=n.zmax&&null!=n.zmin&&(l=(n.zmax+n.zmin)/2,m=n.zmax-n.zmin),"global"===e.viewingMode){if(!d.isSpatialReferenceSupported(n.spatialReference,"global"))return G(c)&&c.resolver.reject(),null;const e=new i(n.xmin,n.ymin,n.spatialReference),t=new i(n.xmax,n.ymax,n.spatialReference),r=n.spatialReference.isGeographic?j:C;s=new i(r.center(e.x,t.x),(t.y+e.y)/2,n.spatialReference),null!=l&&(s.z=l);const o=f.getReferenceEllipsoid(n.spatialReference),a=v.getGreatCircleSpanAt(s,e,t);u=a.lon,p=a.lat,r.diff(e.x,t.x)>r.range/2&&(u+=o.halfCircumference),u=Math.min(u,o.halfCircumference),p=Math.min(p,o.halfCircumference)}else{const t=b(e);u=n.xmax-n.xmin,p=n.ymax-n.ymin,s=new i({x:n.xmin+.5*u,y:n.ymin+.5*p,z:l,spatialReference:t})}const g=e.state.camera,h=1/Math.tan(g.fovX/2),T=1/Math.tan(g.fovY/2),y=1/Math.tan(g.fov/2),x=Math.max(.5*u*h,.5*p*T,.5*m*y)/1;if(G(c)){const n=new L(c.signal);return N(e,r,o,s,x,a,n),void n.resolver.promise.then((n=>{const r=F(e,n,e.camera.fov);if(!t.isNone(r))return c.resolver.resolve(r);c.resolver.reject()}),(e=>c.resolver.reject(e)))}const R=N(e,r,o,s,x,a);return F(e,R,e.camera.fov,c)},e.getObserverForPointAtDistance=N,e.headingTiltToDirectionUp=function(e,t,n,r,o){return z(e).headingTiltToDirectionUp(t,n,r,o)},e.internalToExternal=function(e,n,r){const c=e.renderSpatialReference,s=l.copy(M,n.viewForward),f=H(e,n.eye,s,n.up,w);let d=b(e);return p.projectVectorToVector(n.eye,c,V,d)||(d=o.WGS84,p.projectVectorToVector(n.eye,c,V,d)),t.isNone(r)?new u(new i(V,d),f.heading,f.tilt,a.rad2deg(n.fov)):(r.position.x=V[0],r.position.y=V[1],r.position.z=V[2],r.position.spatialReference=d,r.heading=f.heading,r.tilt=f.tilt,r.fov=a.rad2deg(n.fov),r)},e.observerToCamera=F,e.scaleToDistance=U,e.scaleToResolution=function(e,t){return e.spatialReference?m.getResolutionForScale(t,e.spatialReference):void 0},e.scaleToZoom=function(e,t){const n=e.basemapTerrain&&e.basemapTerrain.tilingScheme;if(n)return n.levelAtScale(t);x.error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")},e.toExtent=function(e,n,r){const o=e.renderSpatialReference,i=l.dist(n.eye,r),a=p.projectVectorToPoint(r,o,b(e));if(t.isNone(a))return null;const c=2*i*Math.tan(n.fovX/2)*1,s=2*i*Math.tan(n.fovY/2)*1;return"global"===e.viewingMode?y.toExtent(e,a,c,s):T.toExtent(e,a,c,s)},e.zoomToScale=function(e,t){const n=e.basemapTerrain&&e.basemapTerrain.tilingScheme;if(n)return n.scaleAtLevel(t);x.error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")},Object.defineProperty(e,"__esModule",{value:!0})}));
