/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../Camera","../../../core/Cyclical","../../../core/Logger","../../../core/mathUtils","../../../core/maybe","../../../core/promiseUtils","../../../chunks/vec3","../../../chunks/vec3f64","../../../geometry/Point","../../../geometry/projection","../../../geometry/projectionEllipsoid","../../../geometry/SpatialReference","../../ViewingMode","../camera/intersectionUtils","../../../chunks/cameraUtilsPlanar","../../../chunks/cameraUtilsSpherical","./earthUtils","./ElevationProvider","../../support/spatialReferenceSupport"],(function(e,t,n,r,o,i,a,c,l,s,u,f,d,p,m,g,h,v,y,T,M){"use strict";const S=o.getLogger("esri.views.3d.support.cameraUtils"),x=39.37,R=96,w=1,C=8,P=5,j=1,z=s.create(),V=s.create(),O={heading:0,tilt:0},b=new u,A=new r.Cyclical(-20037508.342788905,20037508.342788905),U=new r.Cyclical(-180,180);var D;function E(e){return e.spatialReference||p.WGS84}function H(e){return"global"===e.viewingMode?v.cameraUtilsSpherical:h.cameraUtilsPlanar}function N(e,t,n,r,o){return H(e).headingTiltToDirectionUp(t,n,r,o)}function G(e,t){if(a.isNone(t))return null;const n=e.renderSpatialReference,r=H(e).headingTiltToDirectionUp,o=s.create();if(!f.projectPointToVector(t.position,o,n))return null;const c=r(o,t.heading,t.tilt);l.scale(c.direction,c.direction,e.state.camera.distance),l.add(c.direction,c.direction,o);const u=g.cameraOnContentAlongViewDirection(e,o,c.direction,c.up);return u.fov=i.deg2rad(t.fov),u}e.OrientationMode=void 0,(D=e.OrientationMode||(e.OrientationMode={}))[D.LOCKED=0]="LOCKED",D[D.ADJUST=1]="ADJUST";const L=s.create();function k(e,t,r){const o=e.renderSpatialReference,c=_(e,t.eye,t.viewForward,t.up,O);let l=E(e);return f.projectVectorToVector(t.eye,o,L,l)||(l=p.WGS84,f.projectVectorToVector(t.eye,o,L,l)),a.isNone(r)?new n(new u(L,l),c.heading,c.tilt,i.rad2deg(t.fov)):(r.position.x=L[0],r.position.y=L[1],r.position.z=L[2],r.position.spatialReference=l,r.heading=c.heading,r.tilt=c.tilt,r.fov=i.rad2deg(t.fov),r)}function I(e,t,n){const r=e.state.camera,o=r.width/2/r.pixelRatio;e.renderCoordsHelper.viewingMode===m.ViewingMode.Global&&null!=n&&(t*=Math.cos(i.deg2rad(n))),t/=e.renderCoordsHelper.unitInMeters;return o/(R*x/t)/Math.tan(r.fovX/2)}function q(e,t,n){const r=e.state.camera,o=t*Math.tan(r.fovX/2),a=r.width/2/r.pixelRatio;let c=R*x/(a/o);return e.renderCoordsHelper.viewingMode===m.ViewingMode.Global&&(c/=Math.cos(i.deg2rad(n))),c*=e.renderCoordsHelper.unitInMeters,c}function F(e,t,n,r,o,i){return J(e,t,I(e,n,t.latitude),r,o,i)}function J(e,t,n,r,o,i){if(me(i)){const c=new pe(i.signal);return Q(e,r.heading,r.tilt,t,n,o,c),void c.resolver.promise.then((t=>{const n=se(e,t,r.fov);if(!a.isNone(n))return i.resolver.resolve(n);i.resolver.reject()}),(e=>i.resolver.reject(e)))}const c=Q(e,r.heading,r.tilt,t,n,o);return se(e,c,r.fov,i)}function _(e,t,n,r,o){return H(e).directionToHeadingTilt(t,n,r,o)}function W(e,t){return!!(e.basemapTerrain&&e.renderCoordsHelper.fromRenderCoords(t,b,e.spatialReference)&&a.unwrapOr(T.getElevationAtPoint(e.elevationProvider,b),0)>b.z-j)}function X(e,t,n){return K.apply(this,arguments)}function K(){return(K=t._asyncToGenerator((function*(e,t,n){if(!e.renderCoordsHelper.fromRenderCoords(t,b,e.spatialReference))return!1;const r=yield e.elevationProvider.queryElevation(b.x,b.y,b.z,b.spatialReference,"ground",n);return a.unwrapOr(r,0)>b.z-j}))).apply(this,arguments)}function Y(e,t,n){return Z.apply(this,arguments)}function Z(){return(Z=t._asyncToGenerator((function*(e,t,n){const r=s.create();if(t)if(t instanceof u){if(f.projectPointToVector(t,r,e.renderSpatialReference),null==t.z&&null!=e.basemapTerrain){const o=yield e.elevationProvider.queryElevation(t.x,t.y,t.z,t.spatialReference,"ground",n);return a.isSome(o)&&e.renderCoordsHelper.setAltitude(r,o),r}}else l.copy(r,t);else l.copy(r,e.state.camera.center);return r}))).apply(this,arguments)}function B(e,t){const n=s.create();if(t&&t instanceof u){if(f.projectPointToVector(t,n,e.renderSpatialReference),null==t.z&&null!=e.basemapTerrain){const r=T.getElevationAtPoint(e.elevationProvider,t);a.isSome(r)&&e.renderCoordsHelper.setAltitude(n,r)}}else t?l.copy(n,t):l.copy(n,e.state.camera.center);return n}function Q(e,t,n,r,o,i,a){const c=r&&r instanceof u?r:null;if(me(a))return Y(e,r,a.signal).then((r=>{$(e,t,n,c,r,o,i,a)}),(e=>a.resolver.reject(e))),null;const l=B(e,r);return $(e,t,n,c,l,o,i,a)}function $(t,n,r,o,i,c,l,u){if(a.isNone(o)){const e=t.renderSpatialReference;if(o=f.projectVectorToPoint(i,e,E(t)),a.isNone(o))return null}c=Math.max(c,t.state.constraints.minimumPoiDistance);const d=re(t,n,r,i,c,l),p=(0,H(t).eyeForCenterWithHeadingTilt)(i,c,d.heading,d.tilt);if(l===e.OrientationMode.ADJUST&&"global"===t.viewingMode&&r>0){const a=()=>{const a=ce(t,i,c,ae(t,c,r,i));return l=r-a<1?e.OrientationMode.LOCKED:e.OrientationMode.ADJUST,$(t,n,a,o,i,c,l,u)},f=t.map.ground.navigationConstraint;if(!f||"stay-above"===f.type){if(W(t,p.eye))return a();if(me(u))return X(t,p.eye,u.signal).then((e=>e?a():(u.resolver.resolve({eye:p.eye,up:p.up,center:s.clone(i),heading:p.heading,tilt:p.tilt}),null))),null}}const m=!u||me(u)?{center:s.create(),eye:s.create(),up:s.create(),tilt:0,heading:0}:u;return m.eye=p.eye,m.up=p.up,m.center=s.clone(i),m.heading=p.heading,m.tilt=p.tilt,me(u)&&u.resolver.resolve(m),m}function ee(e,t,n,r,o,i=null){const c=null!=t.zmax&&null!=t.zmin;let l,s,p;if(e.state.isGlobal){if(!M.isSpatialReferenceSupported(t.spatialReference,m.ViewingMode.Global))return me(i)&&i.resolver.reject(),null;const e=new u(t.xmin,t.ymin,t.spatialReference),n=new u(t.xmax,t.ymax,t.spatialReference),r=t.spatialReference.isGeographic?U:A;l=new u({x:r.center(e.x,n.x),y:(n.y+e.y)/2,z:c?(t.zmax+t.zmin)/2:null,spatialReference:t.spatialReference});const o=d.getReferenceEllipsoid(t.spatialReference),a=y.getGreatCircleSpanAt(l,e,n);s=a.lon,p=a.lat,r.diff(e.x,n.x)>r.range/2&&(s+=o.halfCircumference),s=Math.min(s,o.halfCircumference),p=Math.min(p,o.halfCircumference)}else{const n=a.unwrapOr(e.renderSpatialReference,t.spatialReference);n.equals(t.spatialReference)||(t=f.project(t,n)),s=t.xmax-t.xmin,p=t.ymax-t.ymin;const r=c?(t.zmax+t.zmin)/2:null;l=new u({x:t.xmin+.5*s,y:t.ymin+.5*p,z:r,spatialReference:n})}const g=c?t.zmax-t.zmin:0,h=e.state.camera,v=1/Math.tan(h.fovX/2),T=1/Math.tan(h.fovY/2),S=1/Math.tan(h.fov/2),x=Math.max(.5*s*v,.5*p*T,.5*g*S)/w;if(me(i)){const t=new pe(i.signal);return Q(e,n,r,l,x,o,t),void t.resolver.promise.then((t=>{const n=se(e,t,e.camera.fov);if(!a.isNone(n))return i.resolver.resolve(n);i.resolver.reject()}),(e=>i.resolver.reject(e)))}const R=Q(e,n,r,l,x,o);return se(e,R,e.camera.fov,i)}function te(e,t,n){const r=e.renderSpatialReference,o=f.projectVectorToPoint(n,r,E(e));if(a.isNone(o))return null;const i=Math.tan(t.fovX/2),c=Math.tan(t.fovY/2),s=l.dist(t.eye,n),u=2*s*i*w,d=2*s*c*w;return"global"===e.viewingMode?v.toExtent(e,o,u,d):h.toExtent(e,o,u,d)}function ne(e,t,n){const r=e.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(n/r)/Math.LN2>C)return!0;const o=e.renderSpatialReference,i=E(e),c=f.projectVectorToPoint(t,o,i),l=f.projectVectorToPoint(e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,o,i);if(a.isNone(c)||a.isNone(l))return!1;const s=Math.tan(.5*e.state.camera.fov)*r;return l.distance(c)/s>P}function re(t,n,r,o,i,a){let c=0;return a===e.OrientationMode.ADJUST&&ne(t,o,i)?(n=0,c=ie(t,i,r,o)):c=le(t,o,i,r),c=t.state.constraints.clampTilt(i,c),{heading:n,tilt:r=ce(t,o,i,c)}}const oe=.7;function ie(e,t,n,r){const o=e.state.constraints.tilt(t);o.max=Math.min(o.max,.5*Math.PI);const i=o.min*(1-oe)+o.max*oe,a=le(e,r,t,n);return Math.min(a,i)}function ae(e,t,n,r){const o=e.state.constraints.tilt(t);let i=le(e,r,t,n);return i=Math.min(i,.5*Math.PI),o.min*(1-oe)+i*oe}function ce(e,t,n,r){return H(e).lookAtTiltToEyeTilt(r,t,n)}function le(e,t,n,r){return H(e).eyeTiltToLookAtTilt(r,t,n)}function se(e,t,r,o){if(a.isNone(t))return null;const i=e.renderSpatialReference,c=f.projectVectorToPoint(t.eye,i,E(e));return a.isNone(c)?null:a.isSome(o)?(o.position=c,o.heading=t.heading,o.tilt=t.tilt,o.fov=r,o):new n(c,t.heading,t.tilt,r)}function ue(e,t){const n=e.basemapTerrain?.tilingScheme;if(n)return n.levelAtScale(t);S.error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")}function fe(e,t){const n=e.basemapTerrain?.tilingScheme;if(n)return n.scaleAtLevel(t);S.error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")}function de(e,t,r){const o=e.renderSpatialReference;let i,a;t||(t=e.state.camera);const c=p.WGS84;return t instanceof n?(i=t.position.latitude,f.projectPointToVector(t.position,z,o),f.projectPointToVector(r,V,o),a=l.distance(z,V)):(f.projectVectorToVector(t.center,o,V,c),i=V[1],a=t.distance),q(e,a,i)}let pe=function(e){this.signal=e,this.resolver=c.createResolver()};function me(e){return e&&"resolver"in e}e.AsyncContext=pe,e.computeScale=de,e.directionToHeadingTilt=_,e.distanceToScale=q,e.externalToInternal=G,e.fromCenterDistance=J,e.fromCenterScale=F,e.fromExtent=ee,e.getObserverForPointAtDistance=Q,e.headingTiltToDirectionUp=N,e.internalToExternal=k,e.observerToCamera=se,e.scaleToDistance=I,e.scaleToZoom=ue,e.toExtent=te,e.zoomToScale=fe,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
