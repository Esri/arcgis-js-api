// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../Camera","../../../core/Logger","../../../core/mathUtils","../../../core/promiseUtils","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../../../geometry/Point","../../../geometry/SpatialReference","../../../geometry/support/geodesicConstants","../../../geometry/support/scaleUtils","../camera/intersectionUtils","./cameraUtilsPlanar","./cameraUtilsSpherical","./earthUtils","./ElevationProvider","./mathUtils","./pointUtils","./projectionUtils","../../support/spatialReferenceSupport"],(function(e,t,r,n,i,a,o,c,l,s,u,f,v,d,p,m,g,h,T,y,x,R){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isAsyncContext=t.createAsyncContext=t.computeScale=t.scaleToResolution=t.zoomToScale=t.scaleToZoom=t.observerToCamera=t.toExtent=t.fromExtent=t.getObserverForPointAtDistance=t.directionToHeadingTilt=t.fromCenterDistance=t.fromCenterScale=t.distanceToScale=t.scaleToDistance=t.internalToExternal=t.externalToInternal=t.headingTiltToDirectionUp=void 0;var S=i.getLogger("esri.views.3d.support.cameraUtils"),C=l.vec3f64.create(),M=l.vec3f64.create(),w=l.vec3f64.create(),b={heading:0,tilt:0},z=new s,P=new T.Cyclical(-20037508.342788905,20037508.342788905),E=new T.Cyclical(-180,180);function A(e){return e.spatialReference||u.WGS84}function U(e){return"global"===e.viewingMode?m:p}function D(e,t,r){var n=e.state.camera,i=n.fovX,o=n.width/2/n.pixelRatio;"global"===e.viewingMode&&null!=r&&(t*=Math.cos(a.deg2rad(r)));return o/(96*39.37/(t/=e.renderCoordsHelper.unitInMeters))/Math.tan(i/2)}function H(e,t,r){var n=e.state.camera,i=n.fovX,o=t*Math.tan(i/2),c=96*39.37/(n.width/2/n.pixelRatio/o);return"global"===e.viewingMode&&(c/=Math.cos(a.deg2rad(r))),c*=e.renderCoordsHelper.unitInMeters}function _(e,t,r,n,i,a){if(G(a)){var o=q(a.signal);return I(e,n.heading,n.tilt,t,r,i,o),void o.resolver.promise.then((function(t){return a.resolver.resolve(L(e,t,n.fov))}),(function(e){return a.resolver.reject(e)}))}var c=I(e,n.heading,n.tilt,t,r,i);return L(e,c,n.fov,a)}function V(e,t,r,n,i){return U(e).directionToHeadingTilt(t,r,n,i)}function I(e,t,n,i,a,o,u){var f=i&&i instanceof s?i:null;if(!G(u)){var v=function(e,t){var r=l.vec3f64.create();if(t&&t instanceof s){if(y.pointToVector(t,r,e.renderSpatialReference),null==t.z&&null!=e.basemapTerrain){var n=h.getElevationAtPoint(e.elevationProvider,t);null!=n&&e.renderCoordsHelper.setAltitude(n,r)}}else t?c.vec3.copy(r,t):c.vec3.copy(r,e.state.camera.center);return r}(e,i);return O(e,t,n,f,v,a,o,u)}(function(e,t,n){return r.__awaiter(this,void 0,void 0,(function(){var i,a;return r.__generator(this,(function(r){switch(r.label){case 0:return i=l.vec3f64.create(),t?[3,1]:(c.vec3.copy(i,e.state.camera.center),[3,5]);case 1:return t instanceof s?(y.pointToVector(t,i,e.renderSpatialReference),null!=t.z||null==e.basemapTerrain?[3,3]:[4,e.elevationProvider.queryElevation(t.x,t.y,t.z,t.spatialReference,"ground",n)]):[3,4];case 2:return null!=(a=r.sent())&&e.renderCoordsHelper.setAltitude(a,i),[2,i];case 3:return[3,5];case 4:c.vec3.copy(i,t),r.label=5;case 5:return[2,i]}}))}))})(e,i,u.signal).then((function(r){O(e,t,n,f,r,a,o,u)}),(function(e){return u.resolver.reject(e)}))}function O(e,t,n,i,a,o,c,s){if(!i){var u=e.renderSpatialReference,f=A(e);i=y.vectorToPoint(a,u,f)}o=Math.max(o,e.state.constraints.minimumPoiDistance);var v=function(e,t,r,n,i,a){var o=0;1===a&&function(e,t,r){var n=e.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(r/n)/Math.LN2>8)return!0;var i=e.renderSpatialReference,a=A(e),o=y.vectorToPoint(t,i,a),c=y.vectorToPoint(e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,i,a),l=Math.tan(.5*e.state.camera.fov)*n;return c.distance(o)/l>5}(e,n,i)?(t=0,o=function(e,t,r,n){var i=e.state.constraints.tilt(t);i.max=Math.min(i.max,.5*Math.PI);var a=i.min*(1-.7)+.7*i.max,o=j(e,n,t,r);return Math.min(o,a)}(e,i,r,n)):o=j(e,n,i,r);return o=e.state.constraints.clampTilt(i,o),r=F(e,n,i,o),{heading:t,tilt:r}}(e,t,n,a,o,c),d=(0,U(e).eyeForCenterWithHeadingTilt)(a,o,v.heading,v.tilt);if(1===c&&"global"===e.viewingMode&&n>0){var p=function(){var r=F(e,a,o,function(e,t,r,n){var i=e.state.constraints.tilt(t),a=j(e,n,t,r);return a=Math.min(a,.5*Math.PI),i.min*(1-.7)+.7*a}(e,o,n,a));return O(e,t,r,i,a,o,c=n-r<1?0:1,s)},m=e.map.ground.navigationConstraint;if(!m||"stay-above"===m.type){if(function(e,t){return!!(e.basemapTerrain&&e.renderCoordsHelper.fromRenderCoords(t,z,e.spatialReference)&&h.getElevationAtPoint(e.elevationProvider,z)>z.z-1)}(e,d.eye))return p();if(G(s))return void function(e,t,n){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(r){switch(r.label){case 0:return e.renderCoordsHelper.fromRenderCoords(t,z,e.spatialReference)?[4,e.elevationProvider.queryElevation(z.x,z.y,z.z,z.spatialReference,"ground",n)]:[2,!1];case 1:return[2,r.sent()>z.z-1]}}))}))}(e,d.eye,s.signal).then((function(e){if(e)return p();s.resolver.resolve({eye:d.eye,up:d.up,center:l.vec3f64.clone(a),heading:d.heading,tilt:d.tilt})}))}}var g=!s||G(s)?{center:l.vec3f64.create(),eye:l.vec3f64.create(),up:l.vec3f64.create(),tilt:0,heading:0}:s;return g.eye=d.eye,g.up=d.up,g.center=l.vec3f64.clone(a),g.heading=d.heading,g.tilt=d.tilt,G(s)&&s.resolver.resolve(g),g}t.headingTiltToDirectionUp=function(e,t,r,n,i){return U(e).headingTiltToDirectionUp(t,r,n,i)},t.externalToInternal=function(e,t){var r=e.renderSpatialReference,n=U(e).headingTiltToDirectionUp,i=l.vec3f64.create();if(!y.pointToVector(t.position,i,r))return null;var o=n(i,t.heading,t.tilt);c.vec3.scale(o.direction,o.direction,e.state.camera.distance),c.vec3.add(o.direction,o.direction,i);var s=d.cameraOnContentAlongViewDirection(e,i,o.direction,o.up);return s.fov=a.deg2rad(t.fov),s},t.internalToExternal=function(e,t,r){var i=e.renderSpatialReference,o=c.vec3.copy(w,t.viewForward),l=V(e,t.eye,o,t.up,b),f=A(e);return x.vectorToVector(t.eye,i,C,f)||(f=u.WGS84,x.vectorToVector(t.eye,i,C,f)),r?(r.position.x=C[0],r.position.y=C[1],r.position.z=C[2],r.position.spatialReference=f,r.heading=l.heading,r.tilt=l.tilt,r.fov=a.rad2deg(t.fov),r):new n(new s(C,f),l.heading,l.tilt,a.rad2deg(t.fov))},t.scaleToDistance=D,t.distanceToScale=H,t.fromCenterScale=function(e,t,r,n,i,a){return _(e,t,D(e,r,t.latitude),n,i,a)},t.fromCenterDistance=_,t.directionToHeadingTilt=V,t.getObserverForPointAtDistance=I,t.fromExtent=function(e,t,r,n,i,a){var o,c,l,u,v=0;if(null!=t.zmax&&null!=t.zmin&&(o=(t.zmax+t.zmin)/2,v=t.zmax-t.zmin),"global"===e.viewingMode){if(!R.isSpatialReferenceSupported(t.spatialReference,"global"))return G(a)&&a.resolver.reject(),null;var d=new s(t.xmin,t.ymin,t.spatialReference),p=new s(t.xmax,t.ymax,t.spatialReference),m=t.spatialReference.isGeographic?E:P;c=new s(m.center(d.x,p.x),(p.y+d.y)/2,t.spatialReference),null!=o&&(c.z=o);var h=g.getGreatCircleSpanAt(c,d,p);l=h.lon,u=h.lat,m.diff(d.x,p.x)>m.range/2&&(l+=f.halfEarthCircumference),l=Math.min(l,f.halfEarthCircumference),u=Math.min(u,f.halfEarthCircumference)}else{var T=A(e);l=t.xmax-t.xmin,u=t.ymax-t.ymin,c=new s({x:t.xmin+.5*l,y:t.ymin+.5*u,z:o,spatialReference:T})}var y=e.state.camera,x=1/Math.tan(y.fovX/2),S=1/Math.tan(y.fovY/2),C=1/Math.tan(y.fov/2),M=Math.max(.5*l*x,.5*u*S,.5*v*C)/1;if(G(a)){var w=q(a.signal);return I(e,r,n,c,M,i,w),void w.resolver.promise.then((function(t){return a.resolver.resolve(L(e,t,e.camera.fov))}),(function(e){return a.resolver.reject(e)}))}var b=I(e,r,n,c,M,i);return L(e,b,e.camera.fov,a)},t.toExtent=function(e,t,r){var n=e.renderSpatialReference,i=c.vec3.dist(t.eye,r),a=y.vectorToPoint(r,n,A(e)),o=2*i*Math.tan(t.fovX/2)*1,l=2*i*Math.tan(t.fovY/2)*1;return"global"===e.viewingMode?m.toExtent(e,a,o,l):p.toExtent(e,a,o,l)};function F(e,t,r,n){return U(e).lookAtTiltToEyeTilt(n,t,r)}function j(e,t,r,n){return U(e).eyeTiltToLookAtTilt(n,t,r)}function L(e,t,r,i){var a=e.renderSpatialReference,o=A(e),c=y.vectorToPoint(t.eye,a,o);return c?i?(i.position=c,i.heading=t.heading,i.tilt=t.tilt,i.fov=r,i):new n(c,t.heading,t.tilt,r):null}function q(e){return{resolver:o.createResolver(),signal:e}}function G(e){return e&&"resolver"in e}t.observerToCamera=L,t.scaleToZoom=function(e,t){var r=e.basemapTerrain&&e.basemapTerrain.tilingScheme;if(r)return r.levelAtScale(t);S.error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")},t.zoomToScale=function(e,t){var r=e.basemapTerrain&&e.basemapTerrain.tilingScheme;if(r)return r.scaleAtLevel(t);S.error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")},t.scaleToResolution=function(e,t){return e.spatialReference?v.getResolutionForScale(t,e.spatialReference):void 0},t.computeScale=function(e,t,r){var i,a,o=e.renderSpatialReference;t||(t=e.state.camera);var l=u.WGS84;return t instanceof n?(i=t.position.latitude,y.pointToVector(t.position,C,o),y.pointToVector(r,M,o),a=c.vec3.distance(C,M)):(x.vectorToVector(t.center,o,M,l),i=M[1],a=t.distance),H(e,a,i)},t.createAsyncContext=q,t.isAsyncContext=G}));