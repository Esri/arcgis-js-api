// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","../../../core/libs/gl-matrix-2/mat3","../../../core/libs/gl-matrix-2/mat3f64","../../../core/libs/gl-matrix-2/quat","../../../core/libs/gl-matrix-2/quatf32","../../../core/libs/gl-matrix-2/quatf64","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f32","../../../core/libs/gl-matrix-2/vec3f64","../../../core/libs/gl-matrix-2/vec4","../../../core/libs/gl-matrix-2/vec4f64","../../../geometry/support/aaBoundingBox","./dito","./geometryUtils"],(function(e,a,t,r,n,i,c,o,f,l,u,s,h,m,v){"use strict";Object.defineProperty(a,"__esModule",{value:!0}),a.corners=a.projectedRadius=a.projectedArea=a.intersectLine=a.isVisible=a.maximumDistancePlane=a.minimumDistancePlane=a.toAaBoundingBox=a.intersectPlane=a.compute=a.set=a.clone=a.create=a.ObbArray=void 0;var b=c.quatf64.create(),z=l.vec3f64.create(),S=l.vec3f64.create(),p=s.vec4f64.create(),d=r.mat3f64.create(),M=function(e){var a=56*e;this.buffer=new ArrayBuffer(a),this.obbs=new Array(e);for(var t=0;t<e;t++)this.obbs[t]={center:l.vec3f64.createView(this.buffer,56*t+0),halfSize:f.vec3f32.createView(this.buffer,56*t+24),quaternion:i.quatf32.createView(this.buffer,56*t+36)}};function g(e,a,t){return void 0===e&&(e=[0,0,0]),void 0===a&&(a=[-1,-1,-1]),void 0===t&&(t=[0,0,0,1]),{center:l.vec3f64.clone(e),halfSize:f.vec3f32.clone(a),quaternion:i.quatf32.clone(t)}}function q(e,a){var t=v.plane.signedDistance(a,e.center),r=D(e,v.plane.normal(a));return t>r?1:t<-r?-1:0}a.ObbArray=M,a.create=g,a.clone=function(e){return g(e.center,e.halfSize,e.quaternion)},a.set=function(e,a){o.vec3.copy(a.center,e.center),o.vec3.copy(a.halfSize,e.halfSize),n.quat.copy(a.quaternion,e.quaternion)},a.compute=function(e,a){return a=a||g(),m.computeOBB(e,a),a},a.intersectPlane=q,a.toAaBoundingBox=function(e,a){a||(a=h.create());var r=t.mat3.fromQuat(d,e.quaternion),n=e.halfSize[0]*Math.abs(r[0])+e.halfSize[1]*Math.abs(r[3])+e.halfSize[2]*Math.abs(r[6]),i=e.halfSize[0]*Math.abs(r[1])+e.halfSize[1]*Math.abs(r[4])+e.halfSize[2]*Math.abs(r[7]),c=e.halfSize[0]*Math.abs(r[2])+e.halfSize[1]*Math.abs(r[5])+e.halfSize[2]*Math.abs(r[8]);return a[0]=e.center[0]-n,a[1]=e.center[1]-i,a[2]=e.center[2]-c,a[3]=e.center[0]+n,a[4]=e.center[1]+i,a[5]=e.center[2]+c,a},a.minimumDistancePlane=function(e,a){return v.plane.signedDistance(a,e.center)-D(e,v.plane.normal(a))},a.maximumDistancePlane=function(e,a){return v.plane.signedDistance(a,e.center)+D(e,v.plane.normal(a))},a.isVisible=function(e,a){return q(e,a.planes[0])<=0&&q(e,a.planes[1])<=0&&q(e,a.planes[2])<=0&&q(e,a.planes[3])<=0&&q(e,a.planes[4])<=0&&q(e,a.planes[5])<=0},a.intersectLine=function(e,a,t,r){void 0===r&&(r=0),n.quat.conjugate(b,e.quaternion),o.vec3.subtract(z,a,e.center);for(var i=o.vec3.transformQuat(z,z,b),c=o.vec3.transformQuat(S,t,b),f=-1/0,l=1/0,u=0;u<3;u++)if(Math.abs(c[u])>1e-6){var s=(r+e.halfSize[u]-i[u])/c[u],h=(-r-e.halfSize[u]-i[u])/c[u];f=Math.max(f,Math.min(s,h)),l=Math.min(l,Math.max(s,h))}else if(i[u]>e.halfSize[u]+r||i[u]<-e.halfSize[u]-r)return!1;return f<=l},a.projectedArea=function(e,a,r,i,c){n.quat.conjugate(b,e.quaternion),o.vec3.sub(z,a,e.center),o.vec3.transformQuat(z,z,b);var f=z[0]<-e.halfSize[0]?-1:z[0]>e.halfSize[0]?1:0,l=z[1]<-e.halfSize[1]?-1:z[1]>e.halfSize[1]?1:0,s=z[2]<-e.halfSize[2]?-1:z[2]>e.halfSize[2]?1:0,h=Math.abs(f)+Math.abs(l)+Math.abs(s);if(0===h)return 1/0;var m=1===h?4:6,v=6*(f+3*l+9*s+13);t.mat3.fromQuat(d,e.quaternion),t.mat3.scale(d,d,e.halfSize);for(var S=0;S<m;S++){var M=j[v+S];o.vec3.set(z,((1&M)<<1)-1,(2&M)-1,((4&M)>>1)-1),o.vec3.transformMat3(z,z,d),o.vec3.add(p,e.center,z),p[3]=1,u.vec4.transformMat4(p,p,r);var g=1/Math.max(1e-6,p[3]);B[2*S]=p[0]*g,B[2*S+1]=p[1]*g}var q=2*m-2,x=B[0]*(B[3]-B[q+1])+B[q]*(B[1]-B[q-1]);for(S=2;S<q;S+=2)x+=B[S]*(B[S+3]-B[S-1]);return Math.abs(x)*i*c*.125};var x,y,A,B=[.1,.2,.3,.4,.5,.6,.7,.8,.9,1,1.1,1.2],j=(x=new Int8Array(162),y=0,(A=function(e){for(var a=0;a<e.length;a++)x[y+a]=e[a];y+=6})([6,2,3,1,5,4]),A([0,2,3,1,5,4]),A([0,2,3,7,5,4]),A([0,1,3,2,6,4]),A([0,1,3,2,0,0]),A([0,1,5,7,3,2]),A([0,1,3,7,6,4]),A([0,1,3,7,6,2]),A([0,1,5,7,6,2]),A([0,1,5,4,6,2]),A([0,1,5,4,0,0]),A([0,1,3,7,5,4]),A([0,2,6,4,0,0]),A([0,0,0,0,0,0]),A([1,3,7,5,0,0]),A([2,3,7,6,4,0]),A([2,3,7,6,0,0]),A([2,3,1,5,7,6]),A([0,1,5,7,6,2]),A([0,1,5,7,6,4]),A([0,1,3,7,6,4]),A([4,5,7,6,2,0]),A([4,5,7,6,0,0]),A([4,5,1,3,7,6]),A([0,2,3,7,5,4]),A([6,2,3,7,5,4]),A([6,2,3,1,5,4]),x);function D(e,a){n.quat.conjugate(b,e.quaternion),o.vec3.transformQuat(z,a,b);var t=e.halfSize;return Math.abs(z[0]*t[0])+Math.abs(z[1]*t[1])+Math.abs(z[2]*t[2])}a.projectedRadius=D,a.corners=function(e,a){for(var t=0;t<8;++t){var r=a[t];r[0]=1&t?-e.halfSize[0]:e.halfSize[0],r[1]=2&t?-e.halfSize[1]:e.halfSize[1],r[2]=4&t?-e.halfSize[2]:e.halfSize[2],o.vec3.transformQuat(r,r,e.quaternion),o.vec3.add(r,r,e.center)}}}));