// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../core/libs/gl-matrix-2/mat3","../../../core/libs/gl-matrix-2/mat3f64","../../../core/libs/gl-matrix-2/quat","../../../core/libs/gl-matrix-2/quatf32","../../../core/libs/gl-matrix-2/quatf64","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f32","../../../core/libs/gl-matrix-2/vec3f64","../../../core/libs/gl-matrix-2/vec4","../../../core/libs/gl-matrix-2/vec4f64","../../../geometry/support/aaBoundingBox","./dito","./geometryUtils"],function(e,a,t,r,n,i,c,f,o,u,l,s,h,v,b){function m(e,a,t){return{center:u.vec3f64.clone(e),halfSize:o.vec3f32.clone(a),quaternion:i.quatf32.clone(t)}}function z(e){return m(e.center,e.halfSize,e.quaternion)}function S(e,a){f.vec3.copy(a.center,e.center),f.vec3.copy(a.halfSize,e.halfSize),n.quat.copy(a.quaternion,e.quaternion)}function M(e,a){return a||(a=m([0,0,0],[-1,-1,-1],[0,0,0,1])),v.computeOBB(e,a),a}function g(e,a){var t=b.plane.signedDistance(a,e.center),r=w(e,a);return t>r?1:t<-r?-1:0}function q(e,a){a||(a=h.create());var r=t.mat3.fromQuat(P,e.quaternion),n=e.halfSize[0]*Math.abs(r[0])+e.halfSize[1]*Math.abs(r[3])+e.halfSize[2]*Math.abs(r[6]),i=e.halfSize[0]*Math.abs(r[1])+e.halfSize[1]*Math.abs(r[4])+e.halfSize[2]*Math.abs(r[7]),c=e.halfSize[0]*Math.abs(r[2])+e.halfSize[1]*Math.abs(r[5])+e.halfSize[2]*Math.abs(r[8]);return a[0]=e.center[0]-n,a[1]=e.center[1]-i,a[2]=e.center[2]-c,a[3]=e.center[0]+n,a[4]=e.center[1]+i,a[5]=e.center[2]+c,a}function p(e,a){return b.plane.signedDistance(a,e.center)-w(e,a)}function x(e,a){return b.plane.signedDistance(a,e.center)+w(e,a)}function d(e,a){return g(e,a.planes[0])<=0&&g(e,a.planes[1])<=0&&g(e,a.planes[2])<=0&&g(e,a.planes[3])<=0&&g(e,a.planes[4])<=0&&g(e,a.planes[5])<=0}function y(e,a,t,r){void 0===r&&(r=0),n.quat.conjugate(A,e.quaternion),f.vec3.subtract(Q,a,e.center);for(var i=f.vec3.transformQuat(Q,Q,A),c=f.vec3.transformQuat(j,t,A),o=-1/0,u=1/0,l=0;l<3;l++)if(Math.abs(c[l])>1e-6){var s=(r+e.halfSize[l]-i[l])/c[l],h=(-r-e.halfSize[l]-i[l])/c[l];o=Math.max(o,Math.min(s,h)),u=Math.min(u,Math.max(s,h))}else if(i[l]>e.halfSize[l]+r||i[l]<-e.halfSize[l]-r)return!1;return o<=u}function B(e,a,r,i,c){n.quat.conjugate(A,e.quaternion),f.vec3.sub(Q,a,e.center),f.vec3.transformQuat(Q,Q,A);var o=Q[0]<-e.halfSize[0]?-1:Q[0]>e.halfSize[0]?1:0,u=Q[1]<-e.halfSize[1]?-1:Q[1]>e.halfSize[1]?1:0,s=Q[2]<-e.halfSize[2]?-1:Q[2]>e.halfSize[2]?1:0,h=Math.abs(o)+Math.abs(u)+Math.abs(s);if(0===h)return 1/0;var v=1===h?4:6,b=6*(o+3*u+9*s+13);t.mat3.fromQuat(P,e.quaternion),t.mat3.scale(P,P,e.halfSize);for(var m=0;m<v;m++){var z=_[b+m];f.vec3.set(Q,((1&z)<<1)-1,(2&z)-1,((4&z)>>1)-1),f.vec3.transformMat3(Q,Q,P),f.vec3.add(D,e.center,Q),D[3]=1,l.vec4.transformMat4(D,D,r);var S=1/Math.max(1e-6,D[3]);O[2*m]=D[0]*S,O[2*m+1]=D[1]*S}for(var M=2*v-2,g=O[0]*(O[3]-O[M+1])+O[M]*(O[1]-O[M-1]),m=2;m<M;m+=2)g+=O[m]*(O[m+3]-O[m-1]);return Math.abs(g)*i*c*.125}function w(e,a){n.quat.conjugate(A,e.quaternion),f.vec3.transformQuat(Q,a,A);var t=e.halfSize;return Math.abs(Q[0]*t[0])+Math.abs(Q[1]*t[1])+Math.abs(Q[2]*t[2])}Object.defineProperty(a,"__esModule",{value:!0});var A=c.quatf64.create(),Q=u.vec3f64.create(),j=u.vec3f64.create(),D=s.vec4f64.create(),P=r.mat3f64.create(),V=function(){function e(e){var a=56*e;this.buffer=new ArrayBuffer(a),this.obbs=new Array(e);for(var t=0;t<e;t++)this.obbs[t]={center:u.vec3f64.createView(this.buffer,56*t+0),halfSize:o.vec3f32.createView(this.buffer,56*t+24),quaternion:i.quatf32.createView(this.buffer,56*t+36)}}return e}();a.ObbArray=V,a.create=m,a.clone=z,a.set=S,a.compute=M,a.intersectPlane=g,a.toAaBoundingBox=q,a.minimumDistancePlane=p,a.maximumDistancePlane=x,a.isVisible=d,a.intersectLine=y,a.projectedArea=B;var O=[.1,.2,.3,.4,.5,.6,.7,.8,.9,1,1.1,1.2],_=function(){var e=new Int8Array(162),a=0,t=function(t){for(var r=0;r<t.length;r++)e[a+r]=t[r];a+=6};return t([6,2,3,1,5,4]),t([0,2,3,1,5,4]),t([0,2,3,7,5,4]),t([0,1,3,2,6,4]),t([0,1,3,2,0,0]),t([0,1,5,7,3,2]),t([0,1,3,7,6,4]),t([0,1,3,7,6,2]),t([0,1,5,7,6,2]),t([0,1,5,4,6,2]),t([0,1,5,4,0,0]),t([0,1,3,7,5,4]),t([0,2,6,4,0,0]),t([0,0,0,0,0,0]),t([1,3,7,5,0,0]),t([2,3,7,6,4,0]),t([2,3,7,6,0,0]),t([2,3,1,5,7,6]),t([0,1,5,7,6,2]),t([0,1,5,7,6,4]),t([0,1,3,7,6,4]),t([4,5,7,6,2,0]),t([4,5,7,6,0,0]),t([4,5,1,3,7,6]),t([0,2,3,7,5,4]),t([6,2,3,7,5,4]),t([6,2,3,1,5,4]),e}()});