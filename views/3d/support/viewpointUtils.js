/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../core/has","../../../core/maybe","../../../core/Error","../../../core/promiseUtils","../../../geometry/SpatialReference","../../../geometry/Geometry","../../../geometry/support/webMercatorUtils","../../../geometry/Point","../../../geometry/Extent","../../../geometry","../../../Graphic","../../../core/asyncUtils","../../../chunks/vec3f64","../../../chunks/vec3","./mathUtils","../../../Camera","../../../Viewpoint","../../../geometry/support/aaBoundingRect","../../../geometry/projection","../../../chunks/mat3f64","../../../chunks/mat4f64","../../../chunks/mat3","../../../geometry/support/aaBoundingBox","./ElevationProvider","./geometryUtils","../camera/intersectionUtils","./cameraUtils"],(function(e,t,n,a,r,o,i,c,s,l,u,m,f,p,g,h,y,d,x,w,v,R,b,S,T,G,z,A){"use strict";const j=.66;function P(e){return 360-h.cyclicalDeg.normalize(e)}function B(e){return h.cyclicalDeg.normalize(360-e)}function V(e){return n.isSome(e)&&e.resolver&&e.resolver.reject(),null}function M(e,t){return n.isSome(e)&&e.resolver&&e.resolver.resolve(t),t}function C(e,t,a,r=null){if(!t)return V(r);const i=e.spatialReference||o.WGS84;if(n.isSome(t.camera)){const e=t.get("camera.position.spatialReference");if(!c.canProject(e,i))return V(r);const n=t.camera.clone();return e.equals(i)||(n.position=c.project(n.position,i)),M(r,n)}if(n.isNone(t.targetGeometry))return V(r);const s=t.get("targetGeometry.spatialReference");if(s&&!c.canProject(s,i))return V(r);const l=A.internalToExternal(e,e.state.camera);let u=1;if(null!=t.rotation&&(l.heading=P(t.rotation),u=0),null!=a&&(l.tilt=a),"point"===t.targetGeometry.type){const n=t.targetGeometry;let a;const o=t.targetGeometry.clone();return a=null!=t.scale?A.scaleToDistance(e,t.scale,n.latitude):e.state.camera.distance,A.fromCenterDistance(e,o,a,l,u,r)}const m=t.targetGeometry.extent;return A.fromExtent(e,m,l.heading,l.tilt,u,r)}function k(e,t,a=null){return n.isNone(a)&&(a=new d),O(e,null,t.clone(),a)}async function E(e,t,n){const r=K(e,t);if(!r)throw new a("viewpointutils-create:no-target","Missing target for creating viewpoint");const o=new y({fov:e.camera.fov}),i=new d({camera:o});if(r.target instanceof d){return Q(await I(e,r.target,r,n,i))}if(r.target instanceof y)return Q(q(e,r.target,i));const c=null!=r.scale||null!=r.zoom;if(r.target instanceof l){const t=r.target.xmin===r.target.xmax||r.target.ymin===r.target.ymax;return Q(c||t?await _(e,r,r.target.center,o,n,i):await L(e,r,r.target,o,n,i))}const s={boundingBox:S.empty(),hasZ:!1,screenSpaceObjects:[]},u=c?D(e,r):void 0;if(await W(e,r.target,u,s),isFinite(s.boundingBox[0])){let t;if(S.center(s.boundingBox,te),ue.x=te[0],ue.y=te[1],ue.z=te[2],ue.spatialReference=e.spatialReference,isFinite(ue.z)&&s.hasZ?t=S.isPoint(s.boundingBox):(ue.z=void 0,t=x.isPoint(S.toRect(s.boundingBox,oe))),c||t)return Q(await _(e,r,ue,o,n,i));const a=ee(e,s.screenSpaceObjects);return Q(await J(e,r,ue,s.boundingBox,a,o,n,i))}return r.position?Q(Y(e,r,o,i)):Q(await $(e,r,o,n,i))}function Z(e,t){return null==t.scale&&null!=t.zoom?A.zoomToScale(e,t.zoom):t.scale}function D(e,t){return A.scaleToResolution(e,Z(e,t))}function F(e,t){let n=!1;return null!=t.heading?(e.heading=t.heading,n=!0):null!=t.rotation&&(e.heading=P(t.rotation),n=!0),null!=t.tilt&&(e.tilt=t.tilt,n=!0),null!=t.fov&&(e.fov=t.fov),n}function O(e,t,a,r){const i=e.spatialReference||o.WGS84;return t=n.isSome(t)?t:A.externalToInternal(e,a),n.isNone(t)||(r.targetGeometry=w.projectVectorToPoint(t.center,e.renderSpatialReference,i),r.scale=A.computeScale(e,t),r.rotation=B(a.heading),r.camera=a),r}function N(e,t,r){if(!t)return;if(!c.canProject(t.spatialReference,e.spatialReference))throw new a("viewpointutils:incompatible-spatialreference",`Spatial reference (${t.spatialReference?t.spatialReference.wkid:"unknown"}) is incompatible with the view (${e.spatialReference.wkid})`,{geometry:t});const o=[];if(!t.hasZ&&e.basemapTerrain){let a;switch(t.type){case"point":a=t;break;case"multipoint":case"polyline":case"mesh":a=t.extent.center;break;case"extent":a=t.center;break;case"polygon":a=t.centroid}a&&c.canProject(a,e.basemapTerrain.spatialReference)?te[2]=n.unwrapOr(T.getElevationAtPoint(e.elevationProvider,a),0):te[2]=0}(0,me[t.type])(t,(e=>{o.push(e[0],e[1],e[2])}),te);const i=o.length/3;if(0===i)return;const s=new Array(o.length);if(w.projectBuffer(o,t.spatialReference,0,s,e.spatialReference,0,i)){t.hasZ&&(r.hasZ=!0);for(let e=0;e<s.length;e+=3)t.hasZ?(te[0]=s[e+0],te[1]=s[e+1],te[2]=s[e+2]):(te[0]=s[e+0],te[1]=s[e+1]),S.expandWithVec3(r.boundingBox,te)}}async function U(e,t,a,r){const o=await f.result(e.whenViewForGraphic(t));if(!1===o.ok||n.isNone(o.value)||!("whenGraphicBounds"in o.value))return void N(e,t.geometry,r);const i=o.value,c=await f.result(i.whenGraphicBounds(t,{minDemResolution:a}));if(!1===c.ok)return void N(e,t.geometry,r);const{screenSpaceObjects:s,boundingBox:l}=c.value;S.expandWithAABB(r.boundingBox,l),s&&s.forEach((e=>{r.screenSpaceObjects.push(e)})),isFinite(l[2])&&(r.hasZ=!0)}async function W(e,t,n,a){if(Array.isArray(t)&&2===t.length){const n=t[0],r=t[1];if("number"==typeof n&&"number"==typeof r)return ue.x=n,ue.y=r,ue.z=void 0,ue.spatialReference=e.spatialReference.isGeographic?e.spatialReference:o.WGS84,void N(e,ue,a)}t&&"function"==typeof t.map?await r.eachAlways(t.map((t=>W(e,t,n,a)))):t instanceof i?N(e,t,a):t instanceof m&&await U(e,t,n,a)}async function I(e,t,a,r,o){if(n.isSome(t.camera))return q(e,t.camera,o);o.scale=t.scale,o.rotation=t.rotation,o.targetGeometry=n.isSome(t.targetGeometry)?t.targetGeometry.clone():null,o.camera=null,null!=a.heading?o.rotation=B(a.heading):null!=a.rotation&&(o.rotation=a.rotation);const i=Z(e,a);null!=i&&(o.scale=i);const c=new A.AsyncContext(r);return C(e,o,a.tilt,c),o.camera=await c.resolver.promise,o}function q(e,t,n){const a=e.spatialReference,r=t.position.spatialReference;return c.canProject(r,a)?((t=t.clone()).fov=e.camera.fov,r.equals(a)||(t.position=c.project(t.position,a)),O(e,null,t,n)):null}function H(e,t,n,a,r,o){const i=e.renderSpatialReference;return w.projectPointToVector(n.position,ce,i),w.projectPointToVector(t,se,i),o.targetGeometry=new s(t),r.position=new s(n.position),g.subtract(ie,se,ce),A.directionToHeadingTilt(e,ce,ie,a.up,r),o.scale=A.distanceToScale(e,g.distance(ce,se),o.targetGeometry.latitude),o.rotation=B(r.heading),o.camera=r,o}async function _(e,t,r,o,i,c){if(n.isNone(r))throw new a("createfromcenter","invalid point");c.targetGeometry=r.clone();const s=z.cameraOnContentAlongViewDirection(e);if(t.position)return H(e,c.targetGeometry,t,s,o,c);if(t.zoomFactor){const n=s.distance/t.zoomFactor,a=g.scale(te,s.viewForward,-n);g.add(s.eye,s.center,a),s.markViewDirty(),c.scale=A.distanceToScale(e,n,r.latitude)}A.internalToExternal(e,s,o);const l=F(o,t)?0:1;if(!t.zoomFactor){c.scale=Z(e,t),null==c.scale&&(w.projectPointToVector(r,te,e.renderSpatialReference),G.frustum.intersectsPoint(s.frustum,te)?c.scale=A.distanceToScale(e,g.distance(s.eye,te),r.latitude):c.scale=A.computeScale(e,s));const n=new A.AsyncContext(i);A.fromCenterScale(e,c.targetGeometry,c.scale,o,l,n),c.camera=await n.resolver.promise}return c}function Y(e,t,n,a){const r=z.cameraOnContentAlongViewDirection(e);return g.copy(ie,r.viewForward),A.directionToHeadingTilt(e,r.eye,ie,r.up,le),n.position=new s(t.position),n.heading=null!=t.heading?t.heading:le.heading,n.tilt=null!=t.tilt?t.tilt:le.tilt,O(e,null,n,a)}async function $(e,t,n,a,r){const o=z.cameraOnContentAlongViewDirection(e);return _(e,t,w.projectVectorToPoint(o.center,e.renderSpatialReference,e.spatialReference),n,a,r)}async function L(e,t,n,a,r,o){o.targetGeometry=n.clone();const i=z.cameraOnContentAlongViewDirection(e);A.internalToExternal(e,i,a);const c=F(a,t)?0:1,s=new A.AsyncContext(r);return A.fromExtent(e,n,a.heading,a.tilt,c,s),o.camera=await s.resolver.promise,o}function X(e,t,a,r,o){let i=0;a.hasZ?i=a.z:e.basemapTerrain&&(i=n.unwrap(T.getElevationAtPoint(e.elevationProvider,a))),g.set(te,a.x,a.y,i),w.computeLinearTransformation(e.spatialReference,te,ne,e.renderSpatialReference),b.fromMat4(ae,ne),b.transpose(ae,ae),S.empty(re);const c=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];for(let n=0;n<c.length;n++){const t=c[n];let a=r[t[2]];isFinite(a)||(a=i),g.set(te,r[t[0]],r[t[1]],a),w.projectVectorToVector(te,e.spatialReference,te,e.renderSpatialReference),S.expandWithVec3(re,g.transformMat3(te,te,ae))}const s=S.width(re),l=S.height(re),u=S.depth(re),m=1/Math.tan(t.fovX/2),f=1/Math.tan(t.fovY/2),p=.5*Math.sqrt(s*s+u*u)*Math.max(f,m)+.5*l,h=.5*l*f+.5*Math.max(s,u);return Math.max(p,h)/o}async function J(e,t,n,a,r,o,i,c){c.targetGeometry=n.clone();const s=z.cameraOnContentAlongViewDirection(e),l=X(e,s,n,a,r);A.internalToExternal(e,s,o);const u=F(o,t)?0:1;c.scale=A.distanceToScale(e,l,c.targetGeometry.latitude);const m=new A.AsyncContext(i);return A.fromCenterScale(e,c.targetGeometry,c.scale,o,u,m),c.camera=await m.resolver.promise,c}function K(e,t){if(!t||!e.spatialReference)return null;const n={target:null};if("declaredClass"in t||Array.isArray(t))n.target=t;else{for(const e in t)n[e]=t[e];t.center&&!n.target&&(n.target=t.center)}return n}function Q(e){return e&&n.isSome(e.camera)&&(e.rotation=B(e.camera.heading)),e}function ee(e,t){const n=j;if(!t.length)return n;let a=Number.NEGATIVE_INFINITY;for(let r=0;r<t.length;r++){const e=t[r].screenSpaceBoundingRect;a=Math.max(a,Math.abs(e[0]),Math.abs(e[1]),Math.abs(e[2]),Math.abs(e[3]))}return n-a/Math.min(e.width,e.height)*2}const te=p.create(),ne=R.create(),ae=v.create(),re=S.create(),oe=x.create(),ie=p.create(),ce=p.create(),se=p.create(),le={heading:0,tilt:0},ue=new s,me={point(e,t,n){n[0]=e.x,n[1]=e.y,e.hasZ&&(n[2]=e.z),t(n)},polygon(e,t,n){const a=e.hasZ;for(let r=0;r<e.rings.length;r++){const o=e.rings[r];for(let e=0;e<o.length;e++)n[0]=o[e][0],n[1]=o[e][1],a&&(n[2]=o[e][2]),t(n)}},polyline(e,t,n){const a=e.hasZ;for(let r=0;r<e.paths.length;r++){const o=e.paths[r];for(let e=0;e<o.length;e++)n[0]=o[e][0],n[1]=o[e][1],a&&(n[2]=o[e][2]),t(n)}},multipoint(e,t,n){const a=e.points,r=e.hasZ;for(let o=0;o<a.length;o++)n[0]=a[o][0],n[1]=a[o][1],r&&(n[2]=a[o][2]),t(n)},extent(e,t,n){e.hasZ?(t(g.set(n,e.xmin,e.ymin,e.zmin)),t(g.set(n,e.xmax,e.ymin,e.zmin)),t(g.set(n,e.xmin,e.ymax,e.zmin)),t(g.set(n,e.xmax,e.ymax,e.zmin)),t(g.set(n,e.xmin,e.ymin,e.zmax)),t(g.set(n,e.xmax,e.ymin,e.zmax)),t(g.set(n,e.xmin,e.ymax,e.zmax)),t(g.set(n,e.xmax,e.ymax,e.zmax))):(t(g.set(n,e.xmin,e.ymin,n[2])),t(g.set(n,e.xmax,e.ymin,n[2])),t(g.set(n,e.xmin,e.ymax,n[2])),t(g.set(n,e.xmax,e.ymax,n[2])))},mesh(e,t,n){const a=e.vertexAttributes&&e.vertexAttributes.position;if(a)for(let r=0;r<a.length;r+=3)t(g.set(n,a[r+0],a[r+1],a[r+2]))}};e.create=E,e.fromCamera=k,e.headingToRotation=B,e.rotationToHeading=P,e.toCamera=C,Object.defineProperty(e,"__esModule",{value:!0})}));
