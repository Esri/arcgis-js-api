/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../Camera","../../../geometry","../../../Graphic","../../../Viewpoint","../../../core/asyncUtils","../../../core/has","../../../core/Cyclical","../../../core/Error","../../../core/maybe","../../../core/promiseUtils","../../../chunks/mat3","../../../chunks/mat3f64","../../../chunks/mat4f64","../../../chunks/vec3","../../../chunks/vec3f64","../../../geometry/projection","../../../geometry/support/aaBoundingBox","../../../geometry/support/aaBoundingRect","../../../geometry/support/frustum","../../../geometry/support/scaleUtils","../../../geometry/support/webMercatorUtils","../camera/intersectionUtils","./cameraUtils","./ElevationProvider","../../../geometry/Point","../../../geometry/SpatialReference","../../../geometry/Extent","../../../geometry/Geometry"],(function(e,t,n,r,o,a,i,c,s,l,u,m,p,f,g,y,h,d,x,v,w,T,S,b,G,R,A,M,O,z){"use strict";const C=.66;function j(e){return 360-s.cyclicalDegrees.normalize(e)}function B(e){return s.cyclicalDegrees.normalize(360-e)}function P(e){return u.isSome(e)&&e.resolver&&e.resolver.reject(),null}function D(e,t){return u.isSome(e)&&e.resolver&&e.resolver.resolve(t),t}function E(e,t,n,r=null){if(!t)return P(r);const o=e.spatialReference||M.WGS84;if(u.isSome(t.camera)){const e=S.project(t.camera.position,o);if(u.isNone(e))return P(r);const n=t.camera.clone();return n.position=e,D(r,n)}if(u.isNone(t.targetGeometry))return P(r);const a=t.get("targetGeometry.spatialReference");if(a&&!S.canProject(a,o))return P(r);const i=G.internalToExternal(e,e.state.camera);let c=G.OrientationMode.ADJUST;if(null!=t.rotation&&(i.heading=j(t.rotation),c=G.OrientationMode.LOCKED),null!=n&&(i.tilt=n),"point"===t.targetGeometry.type){const n=t.targetGeometry;let o;const a=t.targetGeometry.clone();return o=null!=t.scale?G.scaleToDistance(e,t.scale,n.latitude):e.state.camera.distance,G.fromCenterDistance(e,a,o,i,c,r)}const s=t.targetGeometry.extent;return G.fromExtent(e,s,i.heading,i.tilt,c,r)}function V(e,t,n=null){return u.isNone(n)&&(n=new a),U(e,null,t.clone(),n)}function k(e,t,n){return Z.apply(this,arguments)}function Z(){return(Z=t._asyncToGenerator((function*(e,t,r){const o=se(e,t);if(!o)throw new l("viewpointutils-create:no-target","Missing target for creating viewpoint");const i=new n({fov:e.camera.fov}),c=new a({camera:i});if(o.target instanceof a){return le(yield L(e,o.target,o,r,c))}if(o.target instanceof n)return le($(e,o.target,c));const s=null!=o.scale||null!=o.zoom;if(o.target instanceof O){const t=o.target.xmin===o.target.xmax||o.target.ymin===o.target.ymax;return le(s||t?yield X(e,o,o.target.center,i,r,c):yield re(e,o,o.target,i,r,c))}const u={boundingBox:x.empty(),hasZ:!1,screenSpaceObjects:[]},m=s?_(e,o):void 0;if(yield J(e,o.target,m,u),isFinite(u.boundingBox[0])){let t;if(x.center(u.boundingBox,me),we.x=me[0],we.y=me[1],we.z=me[2],we.spatialReference=e.spatialReference,isFinite(we.z)&&u.hasZ?t=x.isPoint(u.boundingBox):(we.z=void 0,t=v.isPoint(x.toRect(u.boundingBox,ye))),s||t)return le(yield X(e,o,we,i,r,c));const n=ue(e,u.screenSpaceObjects);return le(yield ie(e,o,we,u.boundingBox,n,i,r,c))}return o.position?le(ee(e,o,i,c)):le(yield te(e,o,i,r,c))}))).apply(this,arguments)}function F(e,t){return null==t.scale&&null!=t.zoom?G.zoomToScale(e,t.zoom):t.scale}function _(e,t){return T.getResolutionInMetersForScale(F(e,t))}function N(e,t){let n=!1;return null!=t.heading?(e.heading=t.heading,n=!0):null!=t.rotation&&(e.heading=j(t.rotation),n=!0),null!=t.tilt&&(e.tilt=t.tilt,n=!0),null!=t.fov&&(e.fov=t.fov),n}function U(e,t,n,r){const o=e.spatialReference||M.WGS84;return t=u.isSome(t)?t:G.externalToInternal(e,n),u.isNone(t)||(r.targetGeometry=d.projectVectorToPoint(t.center,e.renderSpatialReference,o),r.scale=G.computeScale(e,t),r.rotation=B(n.heading),r.camera=n),r}function I(e,t,n){const r=()=>new l("viewpointutils:invalid-geometry","The target is missing a valid geometry");if(!t)throw r();if(!S.canProject(t.spatialReference,e.spatialReference))throw new l("viewpointutils:incompatible-spatialreference",`Spatial reference (${t.spatialReference?t.spatialReference.wkid:"unknown"}) is incompatible with the view (${e.spatialReference.wkid})`,{geometry:t});const o=[];if(!t.hasZ&&e.basemapTerrain){let n;switch(t.type){case"point":n=t;break;case"multipoint":case"polyline":n=t.extent?.center;break;case"mesh":n=t.origin;break;case"extent":n=t.center;break;case"polygon":n=t.centroid}n&&u.isSome(e.basemapTerrain.spatialReference)&&S.canProject(n,e.basemapTerrain.spatialReference)?me[2]=u.unwrapOr(R.getElevationAtPoint(e.elevationProvider,n),0):me[2]=0}(0,Te[t.type])(t,(e=>{o.push(e[0],e[1],e[2])}),me);const a=o.length/3;if(0===a)throw r();const i=new Array(o.length);if(d.projectBuffer(o,t.spatialReference,0,i,e.spatialReference,0,a)){t.hasZ&&(n.hasZ=!0);for(let e=0;e<i.length;e+=3)t.hasZ?(me[0]=i[e+0],me[1]=i[e+1],me[2]=i[e+2]):(me[0]=i[e+0],me[1]=i[e+1]),x.expandWithVec3(n.boundingBox,me)}}function W(e,t,n,r){return H.apply(this,arguments)}function H(){return(H=t._asyncToGenerator((function*(e,t,n,r){const o=yield i.result(e.whenViewForGraphic(t));if(!1===o.ok||u.isNone(o.value)||!("whenGraphicBounds"in o.value))return void I(e,t.geometry,r);const a=o.value,c=yield i.result(a.whenGraphicBounds(t,{minDemResolution:n}));if(!1===c.ok)return void I(e,t.geometry,r);const{screenSpaceObjects:s,boundingBox:l}=c.value;x.expandWithAABB(r.boundingBox,l),s&&s.forEach((e=>{r.screenSpaceObjects.push(e)})),isFinite(l[2])&&(r.hasZ=!0)}))).apply(this,arguments)}function J(e,t,n,r){return K.apply(this,arguments)}function K(){return(K=t._asyncToGenerator((function*(e,t,n,r){if(Array.isArray(t)&&2===t.length){const n=t[0],o=t[1];if("number"==typeof n&&"number"==typeof o)return we.x=n,we.y=o,we.z=void 0,we.spatialReference=e.spatialReference.isGeographic?e.spatialReference:M.WGS84,void I(e,we,r)}t&&"function"==typeof t.map?yield m.eachAlways(t.map((t=>J(e,t,n,r)))):t instanceof z?I(e,t,r):t instanceof o&&(yield W(e,t,n,r))}))).apply(this,arguments)}function L(e,t,n,r,o){return Y.apply(this,arguments)}function Y(){return(Y=t._asyncToGenerator((function*(e,t,n,r,o){if(u.isSome(t.camera))return $(e,t.camera,o);o.scale=t.scale,o.rotation=t.rotation,o.targetGeometry=u.isSome(t.targetGeometry)?t.targetGeometry.clone():null,o.camera=null,null!=n.heading?o.rotation=B(n.heading):null!=n.rotation&&(o.rotation=n.rotation);const a=F(e,n);null!=a&&(o.scale=a);const i=new G.AsyncContext(r);return E(e,o,n.tilt,i),o.camera=yield i.resolver.promise,o}))).apply(this,arguments)}function $(e,t,n){const r=e.spatialReference,o=S.project(t.position,r);return u.isNone(o)?null:((t=t.clone()).fov=e.camera.fov,t.position=o,U(e,null,t,n))}function q(e,t,n,r,o,a){const i=e.renderSpatialReference;return d.projectPointToVector(n.position,de,i),d.projectPointToVector(t,xe,i),a.targetGeometry=new A(t),o.position=new A(n.position),y.subtract(he,xe,de),G.directionToHeadingTilt(e,de,he,r.up,o),a.scale=G.distanceToScale(e,y.distance(de,xe),a.targetGeometry.latitude),a.rotation=B(o.heading),a.camera=o,a}function X(e,t,n,r,o,a){return Q.apply(this,arguments)}function Q(){return(Q=t._asyncToGenerator((function*(e,t,n,r,o,a){if(u.isNone(n))throw new l("createfromcenter","invalid point");a.targetGeometry=n.clone();const i=b.cameraOnContentAlongViewDirection(e);if(t.position)return q(e,a.targetGeometry,t,i,r,a);if(t.zoomFactor){const r=i.distance/t.zoomFactor,o=y.scale(me,i.viewForward,-r);i.eye=y.add(me,i.center,o),a.scale=G.distanceToScale(e,r,n.latitude)}G.internalToExternal(e,i,r);const c=N(r,t)?G.OrientationMode.LOCKED:G.OrientationMode.ADJUST;if(!t.zoomFactor){a.scale=F(e,t),null==a.scale&&(d.projectPointToVector(n,me,e.renderSpatialReference),w.intersectsPoint(i.frustum,me)?a.scale=G.distanceToScale(e,y.distance(i.eye,me),n.latitude):a.scale=G.computeScale(e,i));const s=new G.AsyncContext(o);G.fromCenterScale(e,a.targetGeometry,a.scale,r,c,s),a.camera=yield s.resolver.promise}return a}))).apply(this,arguments)}function ee(e,t,n,r){const o=b.cameraOnContentAlongViewDirection(e);return y.copy(he,o.viewForward),G.directionToHeadingTilt(e,o.eye,he,o.up,ve),n.position=new A(t.position),n.heading=null!=t.heading?t.heading:ve.heading,n.tilt=null!=t.tilt?t.tilt:ve.tilt,U(e,null,n,r)}function te(e,t,n,r,o){return ne.apply(this,arguments)}function ne(){return(ne=t._asyncToGenerator((function*(e,t,n,r,o){const a=b.cameraOnContentAlongViewDirection(e);return X(e,t,d.projectVectorToPoint(a.center,e.renderSpatialReference,e.spatialReference),n,r,o)}))).apply(this,arguments)}function re(e,t,n,r,o,a){return oe.apply(this,arguments)}function oe(){return(oe=t._asyncToGenerator((function*(e,t,n,r,o,a){a.targetGeometry=n.clone();const i=b.cameraOnContentAlongViewDirection(e);G.internalToExternal(e,i,r);const c=N(r,t)?G.OrientationMode.LOCKED:G.OrientationMode.ADJUST,s=new G.AsyncContext(o);return G.fromExtent(e,n,r.heading,r.tilt,c,s),a.camera=yield s.resolver.promise,a}))).apply(this,arguments)}function ae(e,t,n,r,o){let a=0;n.hasZ?a=n.z:e.basemapTerrain&&(a=u.unwrap(R.getElevationAtPoint(e.elevationProvider,n))),y.set(me,n.x,n.y,a),d.computeTranslationToOriginAndRotation(e.spatialReference,me,pe,e.renderSpatialReference),p.fromMat4(fe,pe),p.transpose(fe,fe),x.empty(ge);const i=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];for(let u=0;u<i.length;u++){const t=i[u];let n=r[t[2]];isFinite(n)||(n=a),y.set(me,r[t[0]],r[t[1]],n),d.projectVectorToVector(me,e.spatialReference,me,e.renderSpatialReference),x.expandWithVec3(ge,y.transformMat3(me,me,fe))}const c=x.width(ge),s=x.height(ge),l=x.depth(ge),m=1/Math.tan(t.fovX/2),f=1/Math.tan(t.fovY/2),g=.5*Math.sqrt(c*c+l*l)*Math.max(f,m)+.5*s,h=.5*s*f+.5*Math.max(c,l);return Math.max(g,h)/o}function ie(e,t,n,r,o,a,i,c){return ce.apply(this,arguments)}function ce(){return(ce=t._asyncToGenerator((function*(e,t,n,r,o,a,i,c){c.targetGeometry=n.clone();const s=b.cameraOnContentAlongViewDirection(e),l=ae(e,s,n,r,o);G.internalToExternal(e,s,a);const u=N(a,t)?G.OrientationMode.LOCKED:G.OrientationMode.ADJUST;c.scale=G.distanceToScale(e,l,c.targetGeometry.latitude);const m=new G.AsyncContext(i);return G.fromCenterScale(e,c.targetGeometry,c.scale,a,u,m),c.camera=yield m.resolver.promise,c}))).apply(this,arguments)}function se(e,t){if(!t||!e.spatialReference)return null;const n={target:null};if("declaredClass"in t||Array.isArray(t))n.target=t;else{for(const e in t)n[e]=t[e];t.center&&!n.target&&(n.target=t.center)}return n}function le(e){return e&&u.isSome(e.camera)&&(e.rotation=B(e.camera.heading)),e}function ue(e,t){const n=C;if(!t.length)return n;let r=Number.NEGATIVE_INFINITY;for(let o=0;o<t.length;o++){const e=t[o].screenSpaceBoundingRect;r=Math.max(r,Math.abs(e[0]),Math.abs(e[1]),Math.abs(e[2]),Math.abs(e[3]))}return n-r/Math.min(e.width,e.height)*2}const me=h.create(),pe=g.create(),fe=f.create(),ge=x.create(),ye=v.create(),he=h.create(),de=h.create(),xe=h.create(),ve={heading:0,tilt:0},we=new A,Te={point(e,t,n){n[0]=e.x,n[1]=e.y,e.hasZ&&(n[2]=e.z),t(n)},polygon(e,t,n){const r=e.hasZ;for(let o=0;o<e.rings.length;o++){const a=e.rings[o];for(let e=0;e<a.length;e++)n[0]=a[e][0],n[1]=a[e][1],r&&(n[2]=a[e][2]),t(n)}},polyline(e,t,n){const r=e.hasZ;for(let o=0;o<e.paths.length;o++){const a=e.paths[o];for(let e=0;e<a.length;e++)n[0]=a[e][0],n[1]=a[e][1],r&&(n[2]=a[e][2]),t(n)}},multipoint(e,t,n){const r=e.points,o=e.hasZ;for(let a=0;a<r.length;a++)n[0]=r[a][0],n[1]=r[a][1],o&&(n[2]=r[a][2]),t(n)},extent(e,t,n){e.hasZ?(t(y.set(n,e.xmin,e.ymin,e.zmin)),t(y.set(n,e.xmax,e.ymin,e.zmin)),t(y.set(n,e.xmin,e.ymax,e.zmin)),t(y.set(n,e.xmax,e.ymax,e.zmin)),t(y.set(n,e.xmin,e.ymin,e.zmax)),t(y.set(n,e.xmax,e.ymin,e.zmax)),t(y.set(n,e.xmin,e.ymax,e.zmax)),t(y.set(n,e.xmax,e.ymax,e.zmax))):(t(y.set(n,e.xmin,e.ymin,n[2])),t(y.set(n,e.xmax,e.ymin,n[2])),t(y.set(n,e.xmin,e.ymax,n[2])),t(y.set(n,e.xmax,e.ymax,n[2])))},mesh(e,t,n){const r=e.vertexAttributes&&e.vertexAttributes.position;if(r)for(let o=0;o<r.length;o+=3)t(y.set(n,r[o+0],r[o+1],r[o+2]))}};e.create=k,e.fromCamera=V,e.headingToRotation=B,e.rotationToHeading=j,e.toCamera=E,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
