/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/has","../core/Logger","../core/accessorSupport/ensureType","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/subclass","../core/urlUtils","../core/uuid","../portal/support/resourceExtension","../core/Evented","../core/Handles","./layers/RefreshableLayerView"],(function(e,r,t,i,s,a,n,c,l,o,h,u,v){"use strict";const y=6e3;let d=function(r){function t(){var e;return(e=r.apply(this,arguments)||this)._handles=new u,e._currentTick=0,e}e._inheritsLoose(t,r);var i=t.prototype;return i.initialize=function(){this._handles.add([this.view.allLayerViews.on("after-changes",(()=>{this.notifyChange("tickInterval"),this._handles.remove("layerViewsUpdating"),this._handles.add(this._getLayerViewHandles(),"layerViewsUpdating")})),this.watch("tickInterval",(()=>this._restartTicking())),this.watch("view.ready",(()=>this._restartTicking()))]),this._restartTicking()},i.destroy=function(){this._handles&&(this._handles.destroy(),this._handles=null,this._intervalID&&clearInterval(this._intervalID),this._currentTick=0)},i._restartTicking=function(){this._currentTick=0,this._intervalID&&clearInterval(this._intervalID),this.get("view.ready")&&this.tickInterval&&(this._intervalID=setInterval((()=>{const e=Date.now();this._currentTick+=this.tickInterval,this.view.allLayerViews.forEach((r=>{if(v.isRefreshableLayerView(r)){const t=Math.round(6e4*r.refreshInterval),i=this._currentTick%t==0,s=e-r.refreshTimestamp<.9*y;t&&i&&!s&&(r.refresh(e),this.emit("refresh",{layerView:r,timestamp:e,trigger:"interval"}))}}))}),this.tickInterval))},i._getLayerViewHandles=function(){const e=[],r=()=>this.notifyChange("tickInterval");return this.view.allLayerViews.forEach((t=>{v.isRefreshableLayerView(t)&&t.layer&&e.push(t.watch("refreshInterval",r),t.layer.on("refresh",(()=>{const e=Date.now();t.refresh(e),this.emit("refresh",{layerView:t,timestamp:e,trigger:"layer-refresh"})})))})),e},i._getCommonInterval=function(e){const r=(e,t)=>isNaN(e)||isNaN(t)?0:t<=0?e:r(t,e%t);return e.toArray().reduce(((e,t)=>r(Math.round(6e4*t.refreshInterval),e)),0)},e._createClass(t,[{key:"tickInterval",get:function(){const e=this.view.allLayerViews.filter((e=>v.isRefreshableLayerView(e)));return this._getCommonInterval(e)}}]),t}(h.EventedAccessor);return r.__decorate([a.property()],d.prototype,"view",void 0),r.__decorate([a.property({readOnly:!0})],d.prototype,"tickInterval",null),d=r.__decorate([n.subclass("esri.views.RefreshManager")],d),d}));
