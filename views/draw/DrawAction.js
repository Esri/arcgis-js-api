/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/has","../../core/maybe","../../core/Logger","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/subclass","../../core/urlUtils","../../core/uuid","../../portal/support/resourceExtension","../../core/promiseUtils","../../core/Evented","../../core/screenUtils","../../layers/graphics/dehydratedFeatures","../2d/interactive/SnappingVisualizer2D","../interactive/coordinateHelper","../interactive/editGeometry/EditGeometry","../interactive/editGeometry/EditGeometryHelper","../interactive/snapping/SnappingContext"],(function(e,t,n,o,r,i,s,a,p,c,d,l,u,h,y,_,m,g,v,f){"use strict";let x=function(t){function n(e){var n,o;return(o=t.call(this,e)||this)._hasZ=null,o._snappingTask=null,o._stagedVertex=null,o._stagedVertexUnsnapped=null,o._lastVertexUnsnapped=null,o._nativeEventHistory={undoStack:[],redoStack:[]},o.interactiveUndoDisabled=!1,o.history=[],o.redoHistory=[],o.snapToScene=!1,o.view=null,o.elevationInfo=null,o.defaultZ=0,o._coordinateHelper=m.createCoordinateHelper(e.hasZ,!1,e.view.spatialReference,"local"),o._snappingManager=e.snappingManager,o._editGeometry=new v.EditGeometryHelper(new g.EditGeometry(o._coordinateHelper),null!=(n=e.editGeometryType)?n:"polygon"),o._snappingContext=new f.SnappingContext({geometry:o._editGeometry,elevationInfo:{mode:"on-the-ground",offset:0},pointer:"mouse",visualizer:new _.SnappingVisualizer2D}),o._activeComponent=new g.Component(o._editGeometry.editGeometry),o._editGeometry.editGeometry.components.push(o._activeComponent),o}e._inheritsLoose(n,t);var r=n.prototype;return r.destroy=function(){this._snappingTask=o.abortMaybe(this._snappingTask),o.isSome(this._snappingManager)&&this._snappingManager.doneSnapping(),this._editGeometry.destroy()},r.canUndo=function(){return this._editGeometry.editGeometry.canUndo},r.canRedo=function(){return this._editGeometry.editGeometry.canRedo},r.undo=function(){this.canUndo()&&this._editGeometry.undo()},r.redo=function(){this.canRedo()&&this._editGeometry.redo()},r.getCoordsFromScreenPoint=function(e){const t=this.screenToMap(e);return o.isSome(t)?t.hasZ?[t.x,t.y,t.z]:[t.x,t.y]:null},r.getCoordsAndPointFromScreenPoint=function(e){const t=this.screenToMap(e);return o.isSome(t)?t.hasZ?{vertex:[t.x,t.y,t.z],mapPoint:t}:{vertex:[t.x,t.y],mapPoint:t}:null},r._pushCursorVertex=function(e){const t=y.makeDehydratedPoint(e[0],e[1],null,this.view.spatialReference);this._stagedVertexUnsnapped=t,o.isNone(this._snappingManager)?this._stagedVertex=t:(this._stagedVertex=this._snappingManager.update(t,this._snappingContext),this._snappingTask=l.createTask((async e=>{if(o.isSome(this._snappingManager)){const n=await this._snappingManager.snap(t,this._snappingContext,e);return n.valid&&(this._stagedVertex=n.apply(),this.notifyChange("vertices")),n}return null})))},r._popCursorVertex=function(){this._stagedVertex=null,this._stagedVertexUnsnapped=null,this.notifyChange("vertices")},r.getGeometryZValue=function(){return this.defaultZ},r.screenToMap=function(e){let t=null;if("3d"===this.view.type)if(this.hasZ){const n=o.unwrapOr(this.elevationInfo,S);t=this.view.sceneIntersectionHelper.intersectElevationFromScreen(h.createScreenPointArray(e.x,e.y),n,this.getGeometryZValue())}else{const n=o.unwrapOr(this.elevationInfo,G);t=this.view.sceneIntersectionHelper.intersectElevationFromScreen(h.createScreenPointArray(e.x,e.y),n,0),o.isSome(t)&&(t.z=void 0)}else t=this.view.toMap(e),o.isSome(t)&&(t.z=this.hasZ?this.getGeometryZValue():void 0);return t},r._isDuplicateOfLastVertex=function(e){const t=this._editGeometry.editGeometry.components[0].getLastVertex();if(o.isSome(t)&&e[0]===t[0]&&e[1]===t[1])return!0;const{x:n,y:r}=this._coordinateHelper.createDehydratedPoint(e);return!(!o.isSome(this._lastVertexUnsnapped)||n!==this._lastVertexUnsnapped.x||r!==this._lastVertexUnsnapped.y)},e._createClass(n,[{key:"_committedVertices",get:function(){return this._editGeometry.editGeometry.components[0].vertices.map((e=>e.pos))}},{key:"vertices",get:function(){return o.isSome(this._stagedVertex)?[...this._committedVertices,this._coordinateHelper.pointToArray(this._stagedVertex)]:this._committedVertices}},{key:"hasZ",get:function(){return o.isSome(this._hasZ)?this._hasZ:"3d"===this.view.type},set:function(e){this._hasZ=e,this.notifyChange("hasZ")}}]),n}(u.EventedAccessor);t.__decorate([s.property({readOnly:!0})],x.prototype,"vertices",null),t.__decorate([s.property({type:Boolean,nonNullable:!0})],x.prototype,"interactiveUndoDisabled",void 0),t.__decorate([s.property({readOnly:!0})],x.prototype,"history",void 0),t.__decorate([s.property({readOnly:!0})],x.prototype,"redoHistory",void 0),t.__decorate([s.property()],x.prototype,"snapToScene",void 0),t.__decorate([s.property()],x.prototype,"view",void 0),t.__decorate([s.property()],x.prototype,"elevationInfo",void 0),t.__decorate([s.property({nonNullable:!0})],x.prototype,"defaultZ",void 0),t.__decorate([s.property()],x.prototype,"hasZ",null),x=t.__decorate([a.subclass("esri.views.draw.DrawAction")],x);const S={mode:"absolute-height",offset:0},G={mode:"on-the-ground",offset:0};return x}));
