/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/Evented","../../core/Handles","../../core/lang","../../core/maybe","../../core/promiseUtils","../../core/screenUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass","../../layers/GraphicsLayer","../../layers/graphics/dehydratedFeatures","../ViewingMode","../2d/interactive/SnappingVisualizer2D","../interactive/coordinateHelper","../interactive/editGeometry/EditGeometry","../interactive/editGeometry/EditGeometryOperations","../interactive/snapping/SnappingContext","../interactive/snapping/SnappingOperation"],(function(e,t,n,i,o,r,s,a,p,d,c,l,_,h,u,y,g,v,m,f){"use strict";var w;let S=w=function(t){function n(e){var n;return(n=t.call(this,e)||this)._hasZ=null,n._cursorScreenPoint=null,n._activePointerId=null,n._stagedVertexUnsnapped=null,n._lastVertexUnsnapped=null,n._handles=new i,n._viewHandlesKey="view-handles",n._undoRedoHandlesKey="undo-redo-handles",n._drawToolHandlesKey="draw-tool",n._nativeEventHistory={undoStack:[],redoStack:[]},n.interactiveUndoDisabled=!1,n.history=[],n.redoHistory=[],n.snapToScene=!1,n.view=null,n.elevationInfo=null,n.defaultZ=0,n._coordinateHelper=y.createCoordinateHelper(e.hasZ,!1,e.view.spatialReference),n._snappingManager=e.snappingManager,n._editGeometryOperations=new v.EditGeometryOperations(new g.EditGeometry(e.editGeometryType??"polygon",n._coordinateHelper)),n._snappingGraphicsLayer=new l({id:w.SNAPPING_GRAPHICS_LAYER_ID,listMode:"hide",internal:!0}),n._snappingContext=new m.SnappingContext({editGeometryOperations:n._editGeometryOperations,elevationInfo:{mode:"on-the-ground",offset:0},pointer:"mouse",visualizer:new u.SnappingVisualizer2D(n._snappingGraphicsLayer)}),n._activeComponent=new g.Component(e.view.spatialReference,h.ViewingMode.Local),n._editGeometryOperations.data.components.push(n._activeComponent),n}e._inheritsLoose(n,t);var p=n.prototype;return p.normalizeCtorArgs=function(e){const t={...e};return delete t.editGeometryType,t},p.initialize=function(){this._snappingOperation=new f.SnappingOperation({view:this.view}),"2d"===this.view.type&&this.view.map.layers.add(this._snappingGraphicsLayer)},p.destroy=function(){this._handles.destroy(),this.view.map.layers.remove(this._snappingGraphicsLayer),this._snappingGraphicsLayer.destroy(),r.isSome(this._snappingManager)&&this._snappingManager.doneSnapping(),this._snappingOperation=r.destroyMaybe(this._snappingOperation),this._editGeometryOperations.destroy()},p.canUndo=function(){return this._editGeometryOperations.canUndo},p.canRedo=function(){return this._editGeometryOperations.canRedo},p.undo=function(){this.canUndo&&this._editGeometryOperations.undo()},p.redo=function(){this.canRedo&&this._editGeometryOperations.redo()},p.getCoordsFromScreenPoint=function(e){const t=this.screenToMap(e);return r.isNone(t)?null:t.hasZ?[t.x,t.y,t.z]:[t.x,t.y]},p.getCoordsAndPointFromScreenPoint=function(e){const t=this.screenToMap(e);return r.isNone(t)?null:t.hasZ?{vertex:[t.x,t.y,t.z],mapPoint:t}:{vertex:[t.x,t.y],mapPoint:t}},p.screenToMap=function(e){let t=null;if("3d"===this.view.type)if(this.hasZ){const n=r.unwrapOr(this.elevationInfo,x);t=this.view.sceneIntersectionHelper.intersectElevationFromScreen(a.createScreenPointArray(e.x,e.y),n,this._getGeometryZValue())}else{const n=r.unwrapOr(this.elevationInfo,G);t=this.view.sceneIntersectionHelper.intersectElevationFromScreen(a.createScreenPointArray(e.x,e.y),n,0),r.isSome(t)&&(t.z=void 0)}else t=this.view.toMap(e),r.isSome(t)&&(t.z=this.hasZ?this._getGeometryZValue():void 0);return t},p._pushCursorVertex=function(e,t){const n=_.makeDehydratedPoint(e[0],e[1],null,this.view.spatialReference);this._stagedVertexUnsnapped=n;const i=this._snappingManager;if(r.isNone(i))return this._stagedVertex=n,void t();s.ignoreAbortErrors(this._snappingOperation.snap({point:n},i,this._snappingContext)).then((()=>{t()}))},p._popCursorVertex=function(){this._stagedVertexUnsnapped=null,this._stagedVertex=null},p._getGeometryZValue=function(){return this.defaultZ},p._abortSnapping=function(){this._snappingOperation.abort()},p._isDuplicateOfLastVertex=function(e){const t=this._editGeometryOperations.data.components[0].getLastVertex();if(r.isSome(t)&&e[0]===t[0]&&e[1]===t[1])return!0;const{x:n,y:i}=this._coordinateHelper.vectorToDehydratedPoint(e);return!(!r.isSome(this._lastVertexUnsnapped)||n!==this._lastVertexUnsnapped.x||i!==this._lastVertexUnsnapped.y)},p._shouldHandlePointerEvent=function(e){return this._isPrimaryPointerAction(e)&&(r.isNone(this._activePointerId)||this._activePointerId===e.pointerId)},p._vertexAddHandler=function(e){const t=r.isSome(this._stagedVertex)?this._coordinateHelper.pointToArray(this._stagedVertex):this.getCoordsFromScreenPoint(this._cursorScreenPoint);r.isSome(t)&&this._addVertex(t,e.native)},p._drawCompleteHandler=function(e){this._completeDrawing(e.native)},p._isPrimaryPointerAction=function(e){return"mouse"!==e.pointerType||0===e.button},e._createClass(n,[{key:"_committedVertices",get:function(){return this._editGeometryOperations.data.components[0].vertices.map((e=>e.pos))}},{key:"vertices",get:function(){return r.isSome(this._stagedVertex)?[...this._committedVertices,this._coordinateHelper.pointToArray(this._stagedVertex)]:this._committedVertices}},{key:"hasZ",get:function(){return r.isSome(this._hasZ)?this._hasZ:"3d"===this.view.type},set:function(e){this._hasZ=e,this.notifyChange("hasZ")}},{key:"_stagedVertex",get:function(){return this._snappingOperation.stagedPoint},set:function(e){this._snappingOperation.stagedPoint=o.clone(e)}}]),n}(n.EventedAccessor);S.SNAPPING_GRAPHICS_LAYER_ID="DrawAction-snapping-graphics-layer",t.__decorate([p.property({readOnly:!0})],S.prototype,"vertices",null),t.__decorate([p.property({type:Boolean,nonNullable:!0})],S.prototype,"interactiveUndoDisabled",void 0),t.__decorate([p.property({readOnly:!0})],S.prototype,"history",void 0),t.__decorate([p.property({readOnly:!0})],S.prototype,"redoHistory",void 0),t.__decorate([p.property()],S.prototype,"snapToScene",void 0),t.__decorate([p.property()],S.prototype,"view",void 0),t.__decorate([p.property()],S.prototype,"elevationInfo",void 0),t.__decorate([p.property({nonNullable:!0})],S.prototype,"defaultZ",void 0),t.__decorate([p.property()],S.prototype,"hasZ",null),t.__decorate([p.property()],S.prototype,"_snappingOperation",void 0),t.__decorate([p.property()],S.prototype,"_stagedVertex",null),S=w=t.__decorate([c.subclass("esri.views.draw.DrawAction")],S);const x={mode:"absolute-height",offset:0},G={mode:"on-the-ground",offset:0};return S}));
