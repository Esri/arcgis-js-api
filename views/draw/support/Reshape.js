/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../geometry","../../../Graphic","../../../core/Collection","../../../core/Evented","../../../core/Handles","../../../core/maybe","../../../core/promiseUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/accessorSupport/ensureType","../../../core/Logger","../../../core/accessorSupport/decorators/subclass","../../../geometry/support/coordsUtils","../../../layers/GraphicsLayer","../../../symbols/SimpleMarkerSymbol","../../2d/interactive/SnappingVisualizer2D","./drawUtils","./GraphicMover","./layerUtils","./settings","../../input/InputManager","../../interactive/keybindings","../../interactive/editGeometry/EditGeometryHelper","../../interactive/snapping/SnappingContext","../../../geometry/Point"],(function(e,t,i,s,o,r,n,c,a,h,p,l,d,v,y,_,m,u,g,f,x,G,b,V,M,S,w,k){"use strict";let E=function(e,t,i){this.graphic=e,this.mover=t,this.selected=i,this.type="reshape-start"},I=function(e,t,i){this.graphic=e,this.mover=t,this.selected=i,this.type="reshape"},C=function(e,t,i){this.graphic=e,this.mover=t,this.selected=i,this.type="reshape-stop"},H=function(e,t,i){this.mover=e,this.dx=t,this.dy=i,this.type="move-start"},O=function(e,t,i){this.mover=e,this.dx=t,this.dy=i,this.type="move"},R=function(e,t,i){this.mover=e,this.dx=t,this.dy=i,this.type="move-stop"},T=function(e){this.added=e,this.type="vertex-select"},A=function(e){this.removed=e,this.type="vertex-deselect"},U=function(e,t,i,s){this.added=e,this.graphic=t,this.oldGraphic=i,this.vertices=s,this.type="vertex-add"},D=function(e,t,i,s){this.removed=e,this.graphic=t,this.oldGraphic=i,this.vertices=s,this.type="vertex-remove"};const F=b.settings.reshapeGraphics,z={vertices:{default:new u({style:"circle",size:F.vertex.size,color:F.vertex.color,outline:{color:F.vertex.outlineColor,width:1}}),hover:new u({style:"circle",size:F.vertex.hoverSize,color:F.vertex.hoverColor,outline:{color:F.vertex.hoverOutlineColor,width:1}}),selected:new u({style:"circle",size:F.selected.size,color:F.selected.color,outline:{color:F.selected.outlineColor,width:1}})},midpoints:{default:new u({style:"circle",size:F.midpoint.size,color:F.midpoint.color,outline:{color:F.midpoint.outlineColor,width:1}}),hover:new u({style:"circle",size:F.midpoint.size,color:F.midpoint.color,outline:{color:F.midpoint.outlineColor,width:1}})}};let L=function(t){function i(e){var i;return(i=t.call(this,e)||this)._activeOperationInfo=null,i._handles=new n,i._graphicAttributes={esriSketchTool:"box"},i._mover=null,i._snappingTask=null,i._stagedVertex=null,i._viewHandles=new n,i.callbacks={onReshapeStart(){},onReshape(){},onReshapeStop(){},onMoveStart(){},onMove(){},onMoveStop(){},onGraphicClick(){}},i.enableMidpoints=!0,i.enableMovement=!0,i.enableVertices=!0,i.graphic=null,i.vertexGraphics=new o,i.layer=null,i.midpointGraphics=new o,i.midpointSymbol=new u({style:"circle",size:6,color:[200,200,200],outline:{color:[100,100,100],width:1}}),i.selectedVertices=[],i.snappingManager=null,i.type="reshape",i.view=null,i}e._inheritsLoose(i,t);var r=i.prototype;return r.initialize=function(){this._setup(),this._handles.add([h.whenOnce(this,"view.ready",(()=>{const{layer:e,view:t}=this;G.addUniqueLayer(t,e),this._viewHandles.add([t.on("key-down",(e=>this._keyDownHandler(e)),V.ViewEventPriorities.TOOL)])})),h.pausable(this,"graphic",(()=>this.refresh())),h.pausable(this,"layer",((e,t)=>{t&&(this._clearSelection(),this._resetGraphics(t)),this.refresh()})),h.pausable(this,"enableMidpoints",(()=>{this.refresh()}))])},r.destroy=function(){var e;this._reset(),null==(e=this._mover)||e.destroy(),this._mover=null,this._handles=c.destroyMaybe(this._handles),this._viewHandles=c.destroyMaybe(this._viewHandles)},r.isUIGraphic=function(e){const t=[];return this.graphic&&t.push(this.graphic),t.concat(this.vertexGraphics.items,this.midpointGraphics.items),t.length&&t.includes(e)},r.refresh=function(){this._reset(),this._setup()},r.reset=function(){this.graphic=null},r.clearSelection=function(){this._clearSelection()},r.removeSelectedVertices=function(){this.selectedVertices.length&&this._removeVertices(this.selectedVertices)},r._setup=function(){const{graphic:e,layer:t}=this;e&&t&&!c.isNone(e.geometry)&&(this._setupGraphics(),this._setupMover())},r._setUpGeometryHelper=function(){const e=this.graphic.geometry;c.isNone(e)||"point"!==e.type&&"polygon"!==e.type&&"polyline"!==e.type||(this._geometryHelper=S.EditGeometryHelper.fromGeometry(e,"local"))},r._saveSnappingContextForHandle=function(e,t){var i;this._snappingGraphicsLayer=new m({listMode:"hide",internal:!0,title:"Reshape snapping layer"}),this.view.map.layers.add(this._snappingGraphicsLayer),this._snappingContext=new w.SnappingContext({geometry:this._geometryHelper,elevationInfo:{mode:"on-the-ground",offset:0},pointer:(null==(i=t.viewEvent)?void 0:i.pointerType)||"mouse",excludeFeature:this.graphic,visualizer:new g.SnappingVisualizer2D(this._snappingGraphicsLayer),vertexHandle:this._getVertexFromEditGeometry(e)})},r._reset=function(){this._clearSelection(),this._resetGraphics(),this._resetSnappingStateVars(),this._activeOperationInfo=null,this._mover&&this._mover.destroy(),this._mover=null,this.view.cursor="default"},r._resetSnappingStateVars=function(){var e;c.isSome(this.snappingManager)&&this.snappingManager.doneSnapping(),c.isSome(this._snappingGraphicsLayer)&&(this.view.map.layers.remove(this._snappingGraphicsLayer),this._snappingGraphicsLayer.destroy()),null==(e=this._geometryHelper)||e.destroy(),this._geometryHelper=null,this._snappingTask=c.abortMaybe(this._snappingTask),this._snappingTask=null,this._snappingContext=null,this._stagedVertex=null},r._resetGraphics=function(e){this._removeMidpointGraphics(e),this._removeVertexGraphics(e),this._set("selectedVertices",[])},r._removeMidpointGraphics=function(e){const t=e||this.layer;t&&t.removeMany(this.midpointGraphics.items),this.midpointGraphics.items.forEach((e=>e.destroy())),this.midpointGraphics.removeAll()},r._removeVertexGraphics=function(e){const t=e||this.layer;t&&t.removeMany(this.vertexGraphics.items),this.vertexGraphics.items.forEach((e=>e.destroy())),this.vertexGraphics.removeAll()},r._getCoordinatesForUI=function(e){const t=_.geometryToCoordinates(e.clone());if("polygon"===e.type)for(const i of t){const e=i[i.length-1];i[0][0]===e[0]&&i[0][1]===e[1]&&i.length>2&&i.pop()}return t},r._setupGraphics=function(){const e=this.graphic.geometry;if(c.isSome(e)&&("polyline"===e.type||"polygon"===e.type)){const t=this._getCoordinatesForUI(e);this.enableMidpoints&&this._setUpMidpointGraphics(t),this.enableVertices&&this._setUpVertexGraphics(t)}},r._setUpMidpointGraphics=function(e){this._removeMidpointGraphics();const t=this._createMidpointGraphics(e);this.midpointGraphics.addMany(t),this.layer.addMany(t)},r._setUpVertexGraphics=function(e){this._removeVertexGraphics();const t=this._createVertexGraphics(e);this.vertexGraphics.addMany(t),this._storeRelatedVertexIndices(),this.layer.addMany(t)},r._createVertexGraphics=function(e){const{_graphicAttributes:t,symbols:i,view:{spatialReference:o}}=this,r=[];return null==e||e.forEach(((e,n)=>{e.forEach(((e,c)=>{var a;const[h,p]=e;r.push(new s({geometry:new k({x:h,y:p,spatialReference:o}),symbol:null==i||null==(a=i.vertices)?void 0:a.default,attributes:{...t,pathIndex:n,pointIndex:c}}))}))})),r},r._createMidpointGraphics=function(e){const{_graphicAttributes:t,symbols:i,view:{spatialReference:o}}=this,r=[];return null==e||e.forEach(((e,n)=>{e.forEach(((a,h)=>{const[p,l]=a,d=e[h+1]?h+1:0;if("polygon"===c.get(this.graphic.geometry,"type")||0!==d){const[c,a]=e[d],[v,y]=_.getMidpoint([p,l],[c,a]);r.push(new s({geometry:new k({x:v,y,spatialReference:o}),symbol:i.midpoints.default,attributes:{...t,pathIndex:n,pointIndexStart:h,pointIndexEnd:d}}))}}))})),r},r._storeRelatedVertexIndices=function(){const e=this.vertexGraphics.items;if(!e)return;const t=e.map((({geometry:e})=>({x:e.x,y:e.y})));for(let i=0;i<t.length;i++){const s=[];for(let e=0;e<t.length;e++){if(i===e)continue;const o=t[i],r=t[e];o.x===r.x&&o.y===r.y&&s.push(e)}e[i].attributes.relatedGraphicIndices=s}},r._setupMover=function(){const{enableMovement:e,graphic:t,midpointGraphics:i,vertexGraphics:s,view:o}=this,r="point"===c.get(t.geometry,"type"),n=s.concat(i).items;e&&n.push(t),this._mover=new x({enableMoveAllGraphics:!1,indicatorsEnabled:r,graphics:n,view:o,callbacks:{onGraphicClick:e=>this._onGraphicClickCallback(e),onGraphicMoveStart:e=>this._onGraphicMoveStartCallback(e),onGraphicMove:e=>this._onGraphicMoveCallback(e),onGraphicMoveStop:e=>this._onGraphicMoveStopCallback(e),onGraphicPointerOver:e=>this._onGraphicPointerOverCallback(e),onGraphicPointerOut:e=>this._onGraphicPointerOutCallback(e)}})},r._onGraphicClickCallback=function(e){e.viewEvent.stopPropagation();const t=e.graphic;if(t===this.graphic)this.clearSelection(),this.emit("graphic-click",e),this.callbacks.onGraphicClick&&this.callbacks.onGraphicClick(e);else if(this._isMidpoint(t)){if(2===e.viewEvent.button)return;const i=this.graphic.clone(),s=this._createVertexFromMidpoint(t);this.refresh(),this._emitVertexAddEvent([t],i,s)}else if(this._isVertex(t))if(e.viewEvent.stopPropagation(),2===e.viewEvent.button)this._removeVertices(t);else{e.viewEvent.native.shiftKey||this._clearSelection(),this.selectedVertices.includes(t)?this._removeFromSelection(t,!0):this._addToSelection(t)}},r._setUpOperation=function(e){const{graphic:t,dx:i,dy:s}=e,o=t===this.graphic;this._resetSnappingStateVars(),this._setUpGeometryHelper(),this._saveSnappingContextForHandle(t,e),this._activeOperationInfo={target:this.graphic,mover:t,operationType:o?"move":"reshape",totalDx:i,totalDy:s}},r._onGraphicMoveStartCallback=function(e){const t=e.graphic,{dx:i,dy:s}=e;if(t===this.graphic)return this._clearSelection(),this._resetGraphics(),this._setUpOperation(e),this._emitMoveStartEvent(i,s),void("point"===this._geometryHelper.geometry.type&&this._onHandleMove(t,i,s,e,(()=>this._emitMoveEvent(i,s))));if(!this.selectedVertices.includes(t)){if(this._clearSelection(),this._isMidpoint(t)){const e=this.graphic.clone(),i=this._createVertexFromMidpoint(t);this._emitVertexAddEvent([t],e,i)}this._addToSelection(t)}this._setUpOperation(e),this._emitReshapeStartEvent(t),this._onHandleMove(t,i,s,e,(()=>this._emitReshapeEvent(t)))},r._onGraphicMoveCallback=function(e){const{graphic:t,dx:i,dy:s}=e;this._activeOperationInfo.totalDx+=i,this._activeOperationInfo.totalDy+=s;const{operationType:o}=this._activeOperationInfo,{geometry:r}=this._geometryHelper;"move"===o?"point"===r.type?this._onHandleMove(t,i,s,e,(()=>this._emitMoveEvent(i,s))):this._emitMoveEvent(i,s):this._onHandleMove(t,i,s,e,(()=>this._emitReshapeEvent(t)))},r._onGraphicMoveStopCallback=function(e){const{graphic:t,dx:i,dy:s}=e;this._activeOperationInfo.totalDx+=i,this._activeOperationInfo.totalDy+=s,t===this.graphic?(this._emitMoveStopEvent(),this.refresh()):(this._onHandleMove(t,i,s,e,(()=>this._emitReshapeStopEvent(t))),this._resetSnappingStateVars(),this._activeOperationInfo=null,this._isMidpoint(t)&&this.refresh())},r._updateMidpointGraphicLocations=function(e){for(const t of this.midpointGraphics){const{pathIndex:i,pointIndexStart:s,pointIndexEnd:o}=t.attributes,[r,n]=e[i][s],[c,a]=e[i][o],[h,p]=_.getMidpoint([r,n],[c,a]);t.geometry=new k({x:h,y:p,spatialReference:this.view.spatialReference})}},r._getIndicesForVertexGraphic=function({attributes:e}){return[(null==e?void 0:e.pathIndex)||0,(null==e?void 0:e.pointIndex)||0]},r._getVertexFromEditGeometry=function(e){var t;const[i,s]=this._getIndicesForVertexGraphic(e);return null==(t=this._geometryHelper)?void 0:t.editGeometry.components[i].vertices[s]},r._onHandleMove=function(t,i,s,o,r){var n=this;c.abortMaybe(this._snappingTask);const h=t.geometry,p="graphic-move-stop"===o.type;if(c.isSome(this.snappingManager)&&this.selectedVertices.length<2&&!p){const o=this.snappingManager;this._stagedVertex=o.update(h,this._snappingContext),this._syncGeometryAfterVertexMove(t,new k(this._stagedVertex),i,s,p),r(),this._snappingTask=a.createTask(function(){var c=e._asyncToGenerator((function*(e){const c=yield o.snap(h,n._snappingContext,e);c.valid&&(n._stagedVertex=c.apply(),n._syncGeometryAfterVertexMove(t,new k(n._stagedVertex),i,s,p),r())}));return function(e){return c.apply(this,arguments)}}())}else{const e=c.isSome(this._stagedVertex)?new k(this._stagedVertex):h;this._syncGeometryAfterVertexMove(t,e,i,s,p),r()}},r._syncGeometryAfterVertexMove=function(){var t=e._asyncToGenerator((function*(e,t,i,s,o=!1){const r=this._geometryHelper.geometry;if("point"===r.type)e.geometry=t;else{const{x:n,y:c}=t,[a,h]=this._getIndicesForVertexGraphic(e);let p=_.geometryToCoordinates(r);const l=p[a].length-1;p[a][h]=[n,c],"polygon"===r.type&&(0===h?p[a][l]=[n,c]:h===l&&(p[a][0]=[n,c])),this._isVertex(e)&&(p=this._moveRelatedCoordinates(p,e,n,c),p=this._moveSelectedHandleCoordinates(p,e,i,s,"polygon"===r.type),this._updateMidpointGraphicLocations(p)),this.graphic.geometry=r.clone(),this._syncEditGeometryAfterVertexMove(e,n,c),o&&(this._mover?this._mover.updateGeometry(this._mover.graphics.indexOf(e),t):e.geometry=t)}}));function i(e,i,s,o){return t.apply(this,arguments)}return i}(),r._moveRelatedCoordinates=function(e,t,i,s){const{relatedGraphicIndices:o}=t.attributes;for(const r of o){const o=this.vertexGraphics.getItemAt(r),{pathIndex:n,pointIndex:c}=o.attributes;e[n][c]=[i,s],o.geometry=t.geometry}return e},r._moveSelectedHandleCoordinates=function(e,t,i,s,o){for(const r of this.selectedVertices)if(r!==t){const{pathIndex:t,pointIndex:n,relatedGraphicIndices:c}=r.attributes,a=f.cloneMove(r.geometry,i,s,this.view),h=e[t].length-1;e[t][n]=[a.x,a.y],r.geometry=a,o&&(0===n?e[t][h]=[a.x,a.y]:n===h&&(e[t][0]=[a.x,a.y]));for(const i of c){const t=this.vertexGraphics.getItemAt(i),{pathIndex:s,pointIndex:o}=t.attributes;e[s][o]=[a.x,a.y],t.geometry=a}}return e},r._syncEditGeometryAfterVertexMove=function(e,t,i){const s=this._getVertexFromEditGeometry(e),o=t-s.pos[0],r=i-s.pos[1];this._geometryHelper.moveVertices([s],o,r,0)},r._onGraphicPointerOverCallback=function(e){const t=e.graphic;this._isVertex(t)&&!this._isSelected(t)&&(t.symbol=this.symbols.vertices.hover),this._updateHoverCursor(t)},r._onGraphicPointerOutCallback=function(e){const t=e.graphic;this._isVertex(t)&&!this._isSelected(t)&&(t.symbol=this.symbols.vertices.default),this.view.cursor="default"},r._createVertexFromMidpoint=function(e){const{_graphicAttributes:t,graphic:i}=this,s=i.geometry;if(c.isNone(s)||"polygon"!==s.type&&"polyline"!==s.type)return[];const o=s.clone(),r=[],{pathIndex:n,pointIndexStart:a,pointIndexEnd:h}=e.attributes,{x:p,y:l}=e.geometry,d=0===h?a+1:h,v=_.geometryToCoordinates(o);return v[n].splice(d,0,[p,l]),e.attributes={...t,pathIndex:n,pointIndex:d,relatedGraphicIndices:[]},r.push({coordinates:v[n][d],componentIndex:n,vertexIndex:d}),this.graphic.geometry=o,r},r._addToSelection=function(e){e instanceof s&&(e=[e]);for(const t of e)t.symbol=this.symbols.vertices.selected;this._set("selectedVertices",this.selectedVertices.concat(e)),this._emitSelectEvent(e)},r._removeFromSelection=function(e,t){const{vertices:i}=this.symbols,o=t?i.hover:i.default;e instanceof s&&(e=[e]);for(const s of e)this.selectedVertices.splice(this.selectedVertices.indexOf(s),1),this._set("selectedVertices",this.selectedVertices),s.set("symbol",o);this._emitDeselectEvent(e)},r._clearSelection=function(){if(this.selectedVertices.length){const e=this.selectedVertices;for(const t of this.selectedVertices)t.set("symbol",this.symbols.vertices.default);this._set("selectedVertices",[]),this._emitDeselectEvent(e)}},r._keyDownHandler=function(e){M.SKETCH_KEYS.delete.includes(e.key)&&!e.repeat&&this.selectedVertices.length&&this._removeVertices(this.selectedVertices)},r._removeVertices=function(e){const t=this.graphic.geometry;if(c.isNone(t)||"polygon"!==t.type&&"polyline"!==t.type)return;if("polygon"===t.type&&this.vertexGraphics.length<4||this.vertexGraphics.length<3)return;e instanceof s&&(e=[e]);const i=this.graphic.clone(),o=t.clone(),r=_.geometryToCoordinates(o),n=[];e instanceof s&&(e=[e]);for(const s of e){const{x:e,y:t}=s.geometry;for(let i=0;i<r.length;i++){const s=r[i];for(let o=0;o<s.length;o++){const[c,a]=s[o];e===c&&t===a&&(n.push({coordinates:r[i][o],componentIndex:i,vertexIndex:o}),r[i].splice(Number(o),1))}}}if("polygon"===o.type)for(const s of r){const[e,t]=s[0],[i,o]=s[s.length-1];(1===s.length||s.length<3&&e===i&&t===o)&&r.splice(r.indexOf(s),1),s.length>2&&(e!==i||t!==o)&&s.push(s[0])}else for(const s of r)1===s.length&&r.splice(r.indexOf(s),1);this.graphic.geometry=o,this.refresh(),this._emitVertexRemoveEvent(e,i,n)},r._isVertex=function(e){return this.vertexGraphics.includes(e)},r._isSelected=function(e){return this._isVertex(e)&&this.selectedVertices.includes(e)},r._isMidpoint=function(e){return this.midpointGraphics.includes(e)},r._updateHoverCursor=function(e){this.view.cursor=this._isMidpoint(e)?"copy":"move"},r._emitMoveStartEvent=function(e,t){const i=new H(this.graphic,e,t);this.emit("move-start",i),this.callbacks.onMoveStart&&this.callbacks.onMoveStart(i)},r._emitMoveEvent=function(e,t){const i=new O(this.graphic,e,t);this.emit("move",i),this.callbacks.onMove&&this.callbacks.onMove(i)},r._emitMoveStopEvent=function(){const{totalDx:e,totalDy:t}=this._activeOperationInfo,i=new R(this.graphic,e,t);this.emit("move-stop",i),this.callbacks.onMoveStop&&this.callbacks.onMoveStop(i)},r._emitReshapeStartEvent=function(e){const t=new E(this.graphic,e,this.selectedVertices);this.emit("reshape-start",t),this.callbacks.onReshapeStart&&this.callbacks.onReshapeStart(t)},r._emitReshapeEvent=function(e){const t=new I(this.graphic,e,this.selectedVertices);this.emit("reshape",t),this.callbacks.onReshape&&this.callbacks.onReshape(t)},r._emitReshapeStopEvent=function(e){const t=new C(this.graphic,e,this.selectedVertices);this.emit("reshape-stop",t),this.callbacks.onReshapeStop&&this.callbacks.onReshapeStop(t)},r._emitSelectEvent=function(e){const t=new T(e);this.emit("select",t),this.callbacks.onVertexSelect&&this.callbacks.onVertexSelect(t)},r._emitDeselectEvent=function(e){const t=new A(e);this.emit("deselect",t),this.callbacks.onVertexDeselect&&this.callbacks.onVertexDeselect(t)},r._emitVertexAddEvent=function(e,t,i){const s=new U(e,this.graphic,t,i);this.emit("vertex-add",s),this.callbacks.onVertexAdd&&this.callbacks.onVertexAdd(s)},r._emitVertexRemoveEvent=function(e,t,i){const s=new D(e,this.graphic,t,i);this.emit("vertex-remove",s),this.callbacks.onVertexRemove&&this.callbacks.onVertexRemove(s)},e._createClass(i,[{key:"state",get:function(){const e=!!this.get("view.ready"),t=!(!this.get("graphic")||!this.get("layer"));return e&&t?"active":e?"ready":"disabled"}},{key:"symbols",set:function(e){const{midpoints:t=z.midpoints,vertices:i=z.vertices}=e||{};this._set("symbols",{midpoints:t,vertices:i})}}]),i}(r.EventedAccessor);return t.__decorate([p.property()],L.prototype,"callbacks",void 0),t.__decorate([p.property()],L.prototype,"enableMidpoints",void 0),t.__decorate([p.property()],L.prototype,"enableMovement",void 0),t.__decorate([p.property()],L.prototype,"enableVertices",void 0),t.__decorate([p.property()],L.prototype,"graphic",void 0),t.__decorate([p.property({readOnly:!0})],L.prototype,"vertexGraphics",void 0),t.__decorate([p.property()],L.prototype,"layer",void 0),t.__decorate([p.property({readOnly:!0})],L.prototype,"midpointGraphics",void 0),t.__decorate([p.property()],L.prototype,"midpointSymbol",void 0),t.__decorate([p.property({readOnly:!0})],L.prototype,"selectedVertices",void 0),t.__decorate([p.property()],L.prototype,"snappingManager",void 0),t.__decorate([p.property({readOnly:!0})],L.prototype,"state",null),t.__decorate([p.property({value:z})],L.prototype,"symbols",null),t.__decorate([p.property({readOnly:!0})],L.prototype,"type",void 0),t.__decorate([p.property()],L.prototype,"view",void 0),L=t.__decorate([y.subclass("esri.views.draw.support.Reshape")],L),L}));
