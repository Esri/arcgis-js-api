// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../geometry","../../../Graphic","../../../core/Evented","../../../core/Handles","../../../core/maybe","../../../core/watchUtils","../../../core/accessorSupport/decorators","../../../geometry/support/coordsUtils","../../../symbols/SimpleMarkerSymbol","./drawUtils","./GraphicMover","./layerUtils","../../input/InputManager"],(function(e,t,i,r,o,n,s,a,h,c,p,l,d,v,y,u){"use strict";var _=function(e,t,i){this.graphic=e,this.mover=t,this.selected=i,this.type="reshape-start"},f=function(e,t,i){this.graphic=e,this.mover=t,this.selected=i,this.type="reshape"},m=function(e,t,i){this.graphic=e,this.mover=t,this.selected=i,this.type="reshape-stop"},g=function(e,t,i){this.mover=e,this.dx=t,this.dy=i,this.type="move-start"},b=function(e,t,i){this.mover=e,this.dx=t,this.dy=i,this.type="move"},x=function(e,t,i){this.mover=e,this.dx=t,this.dy=i,this.type="move-stop"},G=function(e){this.added=e,this.type="vertex-select"},S=function(e){this.removed=e,this.type="vertex-deselect"},w=function(e,t,i,r){this.added=e,this.graphic=t,this.oldGraphic=i,this.vertices=r,this.type="vertex-add"},M=function(e,t,i,r){this.removed=e,this.graphic=t,this.oldGraphic=i,this.vertices=r,this.type="vertex-remove"},H={removeVertex:["Backspace","Delete"]};return function(e){function t(t){var i=e.call(this,t)||this;return i._handles=new s,i._graphicAttributes={esriSketchTool:"box"},i._mover=null,i._viewHandles=new s,i._totalDx=0,i._totalDy=0,i.type="reshape",i.callbacks={onReshapeStart:function(){},onReshape:function(){},onReshapeStop:function(){},onMoveStart:function(){},onMove:function(){},onMoveStop:function(){}},i.graphic=null,i.handleGraphics=[],i.handleHoverSymbol=new l({style:"circle",size:8,color:[33,205,255],outline:{color:[0,12,255],width:1}}),i.handleSelectionSymbol=new l({style:"circle",size:8,color:[255,255,255],outline:{color:[0,12,255],width:1}}),i.handleSymbol=new l({style:"circle",size:6,color:[33,205,255],outline:{color:[0,12,255],width:1}}),i.layer=null,i.midpointGraphics=[],i.midpointSymbol=new l({style:"circle",size:6,color:[200,200,200],outline:{color:[100,100,100],width:1}}),i.enableMidpoints=!0,i.selectedHandles=[],i.view=null,i}return i.__extends(t,e),t.prototype.initialize=function(){var e=this;this._setup(),this._handles.add([h.whenOnce(this,"view.ready",(function(){var t=e,i=t.layer,r=t.view;y.addUniqueLayer(r,i),e._viewHandles.add([r.on("key-down",(function(t){return e._keyDownHandler(t)}),u.ViewEventPriorities.TOOL)])})),h.pausable(this,"graphic",(function(){return e.refresh()})),h.pausable(this,"layer",(function(t,i){i&&(e._clearSelection(),e._resetGraphics(i)),e.refresh()})),h.pausable(this,"enableMidpoints",(function(){e.refresh()}))])},t.prototype.destroy=function(){this._reset(),this._mover&&this._mover.destroy(),this._mover=null,this._handles.removeAll(),this._handles=null,this._viewHandles.removeAll(),this._viewHandles=null},Object.defineProperty(t.prototype,"state",{get:function(){var e=!!this.get("view.ready"),t=!(!this.get("graphic")||!this.get("layer"));return e&&t?"active":e?"ready":"disabled"},enumerable:!1,configurable:!0}),t.prototype.isUIGraphic=function(e){var t=[];return this.graphic&&t.push(this.graphic),t.concat(this.handleGraphics,this.midpointGraphics),t.length&&t.indexOf(e)>-1},t.prototype.refresh=function(){this._reset(),this._setup()},t.prototype.reset=function(){this.graphic=null},t.prototype.clearSelection=function(){this._clearSelection()},t.prototype.removeSelectedHandles=function(){this.selectedHandles.length&&this._removeVertex(this.selectedHandles)},t.prototype._setup=function(){this.graphic&&this.layer&&(this._setupGraphics(),this._setupMover())},t.prototype._reset=function(){this._clearSelection(),this._resetGraphicStateVars(),this._resetGraphics(),this._mover&&this._mover.destroy(),this._mover=null,this.view.cursor="default"},t.prototype._resetGraphicStateVars=function(){this._totalDx=0,this._totalDy=0},t.prototype._resetGraphics=function(e){var t=e||this.layer;t&&(t.removeMany(this.handleGraphics),t.removeMany(this.midpointGraphics)),this.handleGraphics.forEach((function(e){return e.destroy()})),this.midpointGraphics.forEach((function(e){return e.destroy()})),this._set("handleGraphics",[]),this._set("midpointGraphics",[]),this._set("selectedHandles",[])},t.prototype._setupGraphics=function(){var e=a.unwrap(this.graphic.geometry),t=p.geometryToCoordinates(e.clone());if("polygon"===e.type)for(var i=0,r=t;i<r.length;i++){var o=r[i],n=o[o.length-1];o[0][0]===n[0]&&o[0][1]===n[1]&&o.length>2&&o.pop()}this._set("handleGraphics",this._createHandleGraphics(t)),this.enableMidpoints&&this._set("midpointGraphics",this._createMidpointGraphics(t)),this._saveRelatedIndices(this.handleGraphics),this.layer.addMany(this.midpointGraphics),this.layer.addMany(this.handleGraphics)},t.prototype._createHandleGraphics=function(e){var t=this._graphicAttributes,n=this.handleSymbol,s=this.view.spatialReference,a=[];return null==e||e.forEach((function(e,h){e.forEach((function(e,c){var p=e[0],l=e[1];a.push(new o({geometry:new r.Point({x:p,y:l,spatialReference:s}),symbol:n,attributes:i.__assign(i.__assign({},t),{pathIndex:h,pointIndex:c})}))}))})),a},t.prototype._createMidpointGraphics=function(e){var t=this,n=this._graphicAttributes,s=this.midpointSymbol,h=this.view.spatialReference,c=[];return null==e||e.forEach((function(e,l){e.forEach((function(d,v){var y=d[0],u=d[1],_=e[v+1]?v+1:0;if("polygon"===a.get(t.graphic.geometry,"type")||0!==_){var f=e[_],m=f[0],g=f[1],b=p.getMidpoint([y,u],[m,g]),x=b[0],G=b[1];c.push(new o({geometry:new r.Point({x:x,y:G,spatialReference:h}),symbol:s,attributes:i.__assign(i.__assign({},n),{pathIndex:l,pointIndexStart:v,pointIndexEnd:_})}))}}))})),c},t.prototype._saveRelatedIndices=function(e){if(e)for(var t=e.map((function(e){var t=e.geometry;return{x:t.x,y:t.y}})),i=0;i<t.length;i++){for(var r=[],o=0;o<t.length;o++)if(i!==o){var n=t[i],s=t[o];n.x===s.x&&n.y===s.y&&r.push(o)}e[i].attributes.relatedGraphicIndices=r}},t.prototype._setupMover=function(){var e=this;this._mover=new v({enableMoveAllGraphics:!1,graphics:[].concat(this.handleGraphics,this.graphic,this.midpointGraphics),view:this.view,callbacks:{onGraphicClick:function(t){return e._onGraphicClickCallback(t)},onGraphicMoveStart:function(t){return e._onGraphicMoveStartCallback(t)},onGraphicMove:function(t){return e._onGraphicMoveCallback(t)},onGraphicMoveStop:function(t){return e._onGraphicMoveStopCallback(t)},onGraphicPointerOver:function(t){return e._onGraphicPointerOverCallback(t)},onGraphicPointerOut:function(t){return e._onGraphicPointerOutCallback(t)}}})},t.prototype._onGraphicClickCallback=function(e){var t=e.graphic;if(t!==this.graphic){if(this.midpointGraphics.indexOf(t)>-1){if(e.viewEvent.stopPropagation(),2===e.viewEvent.button)return;var i=this.graphic.clone(),r=this._createHandleFromMidpoint(t);this.refresh(),this._emitVertexAddEvent([t],i,r)}else if(this.handleGraphics.indexOf(t)>-1){if(e.viewEvent.stopPropagation(),2===e.viewEvent.button)this._removeVertex(t);else e.viewEvent.native.shiftKey||this._clearSelection(),-1===this.selectedHandles.indexOf(t)?this._addToSelection(t):this._removeFromSelection(t,!0)}}else this.clearSelection()},t.prototype._onGraphicMoveStartCallback=function(e){var t=e.graphic;if(this._resetGraphicStateVars(),t===this.graphic){var i=e.dx,r=e.dy;return this.handleGraphics.forEach((function(e){return e.visible=!1})),this.midpointGraphics.forEach((function(e){return e.visible=!1})),this._clearSelection(),void this._emitMoveStartEvent(i,r)}if(this.midpointGraphics.indexOf(t)>-1){this._clearSelection();var o=this.graphic.clone(),n=this._createHandleFromMidpoint(t);this._emitVertexAddEvent([t],o,n),this._addToSelection(t)}else-1===this.selectedHandles.indexOf(t)&&(this._clearSelection(),this._addToSelection(t));this._emitReshapeStartEvent(t)},t.prototype._onGraphicMoveCallback=function(e){var t=e.graphic,i=e.dx,r=e.dy;this._totalDx+=i,this._totalDy+=r,t===this.graphic?this._emitMoveEvent(i,r):(this._syncGeometryAfterHandleMove(t,i,r),this._emitReshapeEvent(t))},t.prototype._onGraphicMoveStopCallback=function(e){var t=e.graphic,i=e.dx,r=e.dy;if(this._totalDx+=i,this._totalDy+=r,t===this.graphic){for(var o=0,n=[].concat(this.handleGraphics,this.midpointGraphics);o<n.length;o++){n[o].visible=!0}this._syncGraphicsWithGeometry(),this._emitMoveStopEvent()}else this._syncGeometryAfterHandleMove(t,i,r),this.midpointGraphics.indexOf(t)>-1&&this.refresh(),this._emitReshapeStopEvent(t);this._resetGraphicStateVars()},t.prototype._syncGraphicsWithGeometry=function(){var e=this.graphic.geometry,t="polyline"===e.type?e.paths:e.rings;this._updateHandleGraphicLocations(t),this._updateMidpointGraphicLocations(t)},t.prototype._updateHandleGraphicLocations=function(e){for(var t=0,i=this.handleGraphics;t<i.length;t++){var o=i[t],n=o.attributes,s=n.pathIndex,a=n.pointIndex,h=e[s][a],c=h[0],p=h[1];o.set("geometry",new r.Point(c,p,this.view.spatialReference))}},t.prototype._updateMidpointGraphicLocations=function(e){for(var t=0,i=this.midpointGraphics;t<i.length;t++){var o=i[t],n=o.attributes,s=n.pathIndex,a=n.pointIndexStart,h=n.pointIndexEnd,c=e[s][a],l=c[0],d=c[1],v=e[s][h],y=v[0],u=v[1],_=p.getMidpoint([l,d],[y,u]),f=_[0],m=_[1];o.geometry=new r.Point({x:f,y:m,spatialReference:this.view.spatialReference})}},t.prototype._syncGeometryAfterHandleMove=function(e,t,i){var r=a.unwrap(this.graphic.geometry).clone(),o="polyline"===r.type?r.paths:r.rings,n=e.attributes,s=n.pathIndex,h=n.pointIndex,c=e.geometry,p=c.x,l=c.y,v=o[s].length-1;if(o[s][h]=[p,l],"polygon"===r.type&&(0===h?o[s][v]=[p,l]:h===v&&(o[s][0]=[p,l])),this.handleGraphics.indexOf(e)>-1){for(var y=0,u=e.attributes.relatedGraphicIndices;y<u.length;y++){var _=u[y],f=(R=this.handleGraphics[_]).attributes,m=f.pathIndex,g=f.pointIndex;o[m][g]=[p,l],R.geometry=e.geometry}for(var b=0,x=this.selectedHandles;b<x.length;b++){var G=x[b];if(G!==e){var S=G.attributes,w=S.pathIndex,M=S.pointIndex,H=S.relatedGraphicIndices,k=d.cloneMove(G.geometry,t,i,this.view),E=o[w].length-1;o[w][M]=[k.x,k.y],G.geometry=k,"polygon"===r.type&&(0===M?o[w][E]=[k.x,k.y]:M===E&&(o[w][0]=[k.x,k.y]));for(var I=0,O=H;I<O.length;I++){_=O[I];var R,V=(R=this.handleGraphics[_]).attributes,D=V.pathIndex,A=V.pointIndex;o[D][A]=[k.x,k.y],R.geometry=k}}}this._updateMidpointGraphicLocations(o)}this.graphic.geometry=r},t.prototype._onGraphicPointerOverCallback=function(e){var t=e.graphic;this.handleGraphics.indexOf(t)>-1&&-1===this.selectedHandles.indexOf(t)&&(t.symbol=this.handleHoverSymbol),this.view.cursor="pointer"},t.prototype._onGraphicPointerOutCallback=function(e){var t=e.graphic;this.handleGraphics.indexOf(t)>-1&&-1===this.selectedHandles.indexOf(t)&&(t.symbol=this.handleSymbol),this.view.cursor="default"},t.prototype._createHandleFromMidpoint=function(e){var t=this._graphicAttributes,r=[],o=a.unwrap(this.graphic.geometry).clone(),n=e.attributes,s=n.pathIndex,h=n.pointIndexStart,c=n.pointIndexEnd,p=e.geometry,l=p.x,d=p.y,v=0===c?h+1:c,y="polyline"===o.type?o.paths:o.rings;return y[s].splice(v,0,[l,d]),e.attributes=i.__assign(i.__assign({},t),{pathIndex:s,pointIndex:v,relatedGraphicIndices:[]}),r.push({coordinates:y[s][v],componentIndex:s,vertexIndex:v}),this.graphic.geometry=o,r},t.prototype._removeHandles=function(e){var t=a.unwrap(this.graphic.geometry).clone(),i="polygon"===t.type?t.rings:t.paths,r=[];e instanceof o&&(e=[e]);for(var n=0,s=e;n<s.length;n++)for(var h=s[n].geometry,c=h.x,p=h.y,l=0;l<i.length;l++)for(var d=i[l],v=0;v<d.length;v++){var y=d[v],u=y[0],_=y[1];c===u&&p===_&&(r.push({coordinates:i[l][v],componentIndex:l,vertexIndex:v}),i[l].splice(Number(v),1))}if("polygon"===t.type)for(var f=0,m=i;f<m.length;f++){var g=m[f],b=g[0],x=(c=b[0],p=b[1],g[g.length-1]),G=x[0],S=x[1];(1===g.length||g.length<3&&c===G&&p===S)&&i.splice(i.indexOf(g),1),g.length>2&&(c!==G||p!==S)&&g.push(g[0])}else for(var w=0,M=i;w<M.length;w++){var H=M[w];1===H.length&&i.splice(i.indexOf(H),1)}return this.graphic.geometry=t,r},t.prototype._addToSelection=function(e){e instanceof o&&(e=[e]);for(var t=0,i=e;t<i.length;t++){i[t].symbol=this.handleSelectionSymbol}this._set("selectedHandles",this.selectedHandles.concat(e)),this._emitSelectEvent(e)},t.prototype._removeFromSelection=function(e,t){var i=t?this.handleHoverSymbol:this.handleSymbol;e instanceof o&&(e=[e]);for(var r=0,n=e;r<n.length;r++){var s=n[r];this.selectedHandles.splice(this.selectedHandles.indexOf(s),1),this._set("selectedHandles",this.selectedHandles),s.symbol=i}this._emitDeselectEvent(e)},t.prototype._clearSelection=function(){if(this.selectedHandles.length){for(var e=this.selectedHandles,t=0,i=this.selectedHandles;t<i.length;t++){var r=i[t];r&&(r.symbol=this.handleSymbol)}this._set("selectedHandles",[]),this._emitDeselectEvent(e)}},t.prototype._keyDownHandler=function(e){H.removeVertex.indexOf(e.key)>-1&&!e.repeat&&this.selectedHandles.length&&this._removeVertex(this.selectedHandles)},t.prototype._removeVertex=function(e){if(!("polygon"===this.graphic.geometry.type&&this.handleGraphics.length<4||this.handleGraphics.length<3)){var t=this.graphic.clone();e instanceof o&&(e=[e]);var i=this._removeHandles(e);this.refresh(),this._emitVertexRemoveEvent(e,t,i)}},t.prototype._emitMoveStartEvent=function(e,t){var i=new g(this.graphic,e,t);this.emit("move-start",i),this.callbacks.onMoveStart&&this.callbacks.onMoveStart(i)},t.prototype._emitMoveEvent=function(e,t){var i=new b(this.graphic,e,t);this.emit("move",i),this.callbacks.onMove&&this.callbacks.onMove(i)},t.prototype._emitMoveStopEvent=function(){var e=new x(this.graphic,this._totalDx,this._totalDy);this.emit("move-stop",e),this.callbacks.onMoveStop&&this.callbacks.onMoveStop(e)},t.prototype._emitReshapeStartEvent=function(e){var t=new _(this.graphic,e,this.selectedHandles);this.emit("reshape-start",t),this.callbacks.onReshapeStart&&this.callbacks.onReshapeStart(t)},t.prototype._emitReshapeEvent=function(e){var t=new f(this.graphic,e,this.selectedHandles);this.emit("reshape",t),this.callbacks.onReshape&&this.callbacks.onReshape(t)},t.prototype._emitReshapeStopEvent=function(e){var t=new m(this.graphic,e,this.selectedHandles);this.emit("reshape-stop",t),this.callbacks.onReshapeStop&&this.callbacks.onReshapeStop(t)},t.prototype._emitSelectEvent=function(e){var t=new G(e);this.emit("select",t),this.callbacks.onVertexSelect&&this.callbacks.onVertexSelect(t)},t.prototype._emitDeselectEvent=function(e){var t=new S(e);this.emit("deselect",t),this.callbacks.onVertexDeselect&&this.callbacks.onVertexDeselect(t)},t.prototype._emitVertexAddEvent=function(e,t,i){var r=new w(e,this.graphic,t,i);this.emit("vertex-add",r),this.callbacks.onVertexAdd&&this.callbacks.onVertexAdd(r)},t.prototype._emitVertexRemoveEvent=function(e,t,i){var r=new M(e,this.graphic,t,i);this.emit("vertex-remove",r),this.callbacks.onVertexRemove&&this.callbacks.onVertexRemove(r)},i.__decorate([c.property({readOnly:!0})],t.prototype,"type",void 0),i.__decorate([c.property()],t.prototype,"callbacks",void 0),i.__decorate([c.property()],t.prototype,"graphic",void 0),i.__decorate([c.property({readOnly:!0})],t.prototype,"handleGraphics",void 0),i.__decorate([c.property()],t.prototype,"handleHoverSymbol",void 0),i.__decorate([c.property()],t.prototype,"handleSelectionSymbol",void 0),i.__decorate([c.property()],t.prototype,"handleSymbol",void 0),i.__decorate([c.property()],t.prototype,"layer",void 0),i.__decorate([c.property({readOnly:!0})],t.prototype,"midpointGraphics",void 0),i.__decorate([c.property()],t.prototype,"midpointSymbol",void 0),i.__decorate([c.property()],t.prototype,"enableMidpoints",void 0),i.__decorate([c.property({readOnly:!0})],t.prototype,"selectedHandles",void 0),i.__decorate([c.property({dependsOn:["view.ready","graphic","layer"],readOnly:!0})],t.prototype,"state",null),i.__decorate([c.property()],t.prototype,"view",void 0),t=i.__decorate([c.subclass("esri.views.draw.support.Reshape")],t)}(n.EventedAccessor)}));