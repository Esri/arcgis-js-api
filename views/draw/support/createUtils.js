/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/lang","../../../core/maybe","../../../core/arrayUtils","../../../geometry/support/spatialReferenceUtils","../../../geometry/Point","../../../geometry/Multipoint","../../../geometry/support/coordsUtils","../../../geometry/Polygon","../../../geometry/Polyline","../../../geometry","../../../chunks/vec3f64","../../../chunks/vec3","../../../core/unitUtils","../../../chunks/quatf64","../../../geometry/Circle","../../../chunks/quat","../../../geometry/geometryEngine","../../../chunks/mat2d","../../../chunks/mat2df64"],(function(e,t,r,n,a,o,s,i,l,c,u,f,p,m,h,y,d,x,g,R,M){"use strict";function w(e,t,r=null){return n.isSome(r)?[e,t,r]:[e,t]}function S(e,t,r=null){return n.isSome(r)?{x:e,y:t,z:r}:{x:e,y:t}}let v=function(){function e(e){this.spatialReference=e}return e.prototype.mapToLocalMultiple=function(e){return e.map((e=>this.mapToLocal(e)))},t._createClass(e,[{key:"doUnnormalization",get:function(){return!1}}]),e}(),T=function(e){function r(t,r,n=null){var a;return(a=e.call(this,r)||this).defaultZ=n,a.transform=M.create(),a.transformInv=M.create(),a.transform=M.clone(t),R.invert(a.transformInv,a.transform),a}t._inheritsLoose(r,e);var n=r.prototype;return n.makeMapPoint=function(e,t){return w(e,t,this.defaultZ)},n.mapToLocal=function(e){return S(this.transform[0]*e[0]+this.transform[2]*e[1]+this.transform[4],this.transform[1]*e[0]+this.transform[3]*e[1]+this.transform[5])},n.localToMap=function(e){return w(this.transformInv[0]*e.x+this.transformInv[2]*e.y+this.transformInv[4],this.transformInv[1]*e.x+this.transformInv[3]*e.y+this.transformInv[5],this.defaultZ)},r}(v),W=function(e){function r(t,r){var n;(n=e.call(this,t.spatialReference)||this).view=t,n.defaultZ=null,n.pWS=p.create(),n.tangentFrameUpWS=p.create(),n.tangentFrameRightWS=p.create(),n.tangentFrameForwardWS=p.create(),n.localFrameRightWS=p.create(),n.localFrameUpWS=p.create(),n.worldToLocalTransform=y.create(),n.localToWorldTransform=y.create(),n.scale=1,n.scale=t.resolution,n.referenceMapPoint=r,n.defaultZ=r.hasZ?r.z:null;const a=t.state.camera.viewRight;n.view.renderCoordsHelper.toRenderCoords(n.referenceMapPoint,n.pWS),n.view.renderCoordsHelper.worldBasisAtPosition(n.pWS,0,n.tangentFrameRightWS),n.view.renderCoordsHelper.worldBasisAtPosition(n.pWS,1,n.tangentFrameUpWS),n.view.renderCoordsHelper.worldBasisAtPosition(n.pWS,2,n.tangentFrameForwardWS);const o=p.create();return m.scale(o,n.tangentFrameForwardWS,m.dot(a,n.tangentFrameForwardWS)),m.subtract(n.localFrameRightWS,a,o),m.normalize(n.localFrameRightWS,n.localFrameRightWS),m.cross(n.localFrameUpWS,n.tangentFrameForwardWS,n.localFrameRightWS),x.rotationTo(n.worldToLocalTransform,n.localFrameRightWS,n.tangentFrameRightWS),x.invert(n.localToWorldTransform,n.worldToLocalTransform),n}t._inheritsLoose(r,e);var n=r.prototype;return n.makeMapPoint=function(e,t){return w(e,t,this.defaultZ)},n.mapToLocal=function(e){const t=p.create();this.view.renderCoordsHelper.toRenderCoords(new s({x:e[0],y:e[1],spatialReference:this.spatialReference}),t),m.transformQuat(t,t,this.worldToLocalTransform);const r=this.view.renderCoordsHelper.fromRenderCoords(t,this.view.spatialReference);return S(r.x/this.scale,r.y/this.scale)},n.localToMap=function(e){const t=p.create();this.view.renderCoordsHelper.toRenderCoords(new s({x:e.x*this.scale,y:e.y*this.scale,spatialReference:this.spatialReference}),t),m.transformQuat(t,t,this.localToWorldTransform);const r=this.view.renderCoordsHelper.fromRenderCoords(t,this.view.spatialReference);return w(r.x,r.y,this.defaultZ)},t._createClass(r,[{key:"doUnnormalization",get:function(){return"global"===this.view.viewingMode}}]),r}(v);function C(e,t){const r=new s({x:e[0],y:e[1],spatialReference:t});return e.length>2&&(r.z=e[2]),r}function F(e,t,n,s=!0){const i=r.clone(e);i.forEach((e=>{const t=e[0],r=e[e.length-1];a.equals(t,r)&&1!==e.length||e.push(e[0])}));let u=new c({rings:i,spatialReference:t});return u.rings.forEach((e=>{l.isClockwise(e,!1,!1)||e.reverse()})),n&&l.unnormalizeGeometryOnDatelineCrossing(u),s&&u.isSelfIntersecting&&o.isValid(t)&&(u=g.simplify(u)),u}e.AffineCoordinateSystem=T,e.SceneViewCoordinateSystem=W,e.SurfaceCoordinateSystem=v,e.createCircle=function(e,t,r,n){const a=t.mapToLocalMultiple(e);let s=null,i=null;if(r)s=a[0],i=a[1];else{const e=a[0],t=a[1],r=Math.round(t.x-e.x),n=Math.round(t.y-e.y),o=Math.max(Math.abs(r),Math.abs(n));s=S(r>0?e.x+o/2:e.x-o/2,n>0?e.y+o/2:e.y-o/2),i=S(Math.abs(r)>Math.abs(n)?s.x-o/2:s.x,Math.abs(r)>Math.abs(n)?s.y:s.y-o/2)}const c=t.localToMap(s),u=t.localToMap(i);t.doUnnormalization&&l.unnormalizeVerticesOnDatelineCrossing([[c,u]],t.spatialReference);const f=C(c,t.spatialReference),p=C(u,t.spatialReference),m=h.getMetersPerUnitForSR(t.spatialReference);let y=0;if(o.isValid(t.spatialReference))y=m*g.distance(f,p,null);else{const e=s.x-i.x,t=s.y-i.y;y=m*Math.sqrt(e*e+t*t)*(n||1)}const x=new d({center:f,radius:y,radiusUnit:"meters",spatialReference:t.spatialReference});return F(x.rings,x.spatialReference,!1)},e.createEllipse=function(e,t,r){const n=t.mapToLocalMultiple(e),a=n[0],o=n[1],s=Math.round(o.x-a.x),i=Math.round(o.y-a.y),l=S(r?a.x:a.x+s/2,r?a.y:a.y+i/2),c=r?s:s/2,u=r?i:i/2,f=[],p=2*Math.PI/60;for(let e=0;e<60;e++){const t=Math.cos(e*p),r=Math.sin(e*p),n=S(c*t+l.x,u*r+l.y);f.push(n)}return f.push(f[0]),F([f.map((e=>t.localToMap(e)))],t.spatialReference,t.doUnnormalization,!1)},e.createMultipoint=function(e,t){return new i({points:e,spatialReference:t})},e.createPoint=C,e.createPolygon=F,e.createPolyline=function(e,t,r){const n=new u({paths:e,spatialReference:t});return r&&l.unnormalizeGeometryOnDatelineCrossing(n),n},e.createRectangle=function(e,t,r){let n=t.mapToLocalMultiple(e);if(1===n.length){const e=48,t=n[0];n=[S(t.x-e,t.y+e),S(t.x+e,t.y-e),S(t.x+e,t.y-e),S(t.x-e,t.y+e)]}const a=[],o={x:n[0].x,y:n[0].y},s={x:n[1].x,y:n[1].y};if(r){const e=Math.round(s.x-o.x),t=Math.round(s.y-o.y);a.push(S(o.x-e,o.y-t),S(s.x,o.y-t),S(s.x,s.y),S(o.x-e,s.y))}else a.push(S(o.x,o.y),S(s.x,o.y),S(s.x,s.y),S(o.x,s.y));return F([a.map((e=>t.localToMap(e)))],t.spatialReference,t.doUnnormalization,!0)},e.createSquare=function(e,t,r){const n=t.mapToLocalMultiple(e),a=[],o={x:n[0].x,y:n[0].y},s=n[1].x,i=n[1].y,l=Math.round(s-o.x),c=Math.round(i-o.y),u=Math.max(Math.abs(l),Math.abs(c));if(r){const e={x:o.x+u,y:o.y+u},t={x:o.x-u,y:o.y-u};a.push(S(e.x,t.y),S(t.x,t.y),S(t.x,e.y),S(e.x,e.y))}else{const e={x:l>0?o.x+u:o.x-u,y:c>0?o.y+u:o.y-u};a.push(S(o.x,o.y),S(e.x,o.y),S(e.x,e.y),S(o.x,e.y))}return F([a.map((e=>t.localToMap(e)))],t.spatialReference,t.doUnnormalization,!0)},e.createViewAlignedCoordinateSystem=function(e,t){if("2d"===e.type)return new T(e.state.transform,e.spatialReference,t.length>2?t[2]:null);if("3d"===e.type){const r=t.length>2?new s({x:t[0],y:t[1],z:t[2],spatialReference:e.spatialReference}):new s({x:t[0],y:t[1],spatialReference:e.spatialReference});return new W(e,r)}return null},e.makeMapPoint=w,e.makeSurfacePoint=S,Object.defineProperty(e,"__esModule",{value:!0})}));
