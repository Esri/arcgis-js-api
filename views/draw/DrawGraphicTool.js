/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../Graphic","../../core/has","../../core/Evented","../../core/HandleOwner","../../core/handleUtils","../../core/maybe","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/Logger","../../core/accessorSupport/decorators/subclass","../../layers/GraphicsLayer","./support/createUtils","./support/surfaceCoordinateSystems","../interactive/InteractiveToolBase"],(function(e,t,r,i,o,a,n,s,c,l,p,h,d,u,y,m,g){"use strict";e.DrawGraphicTool=function(e){function r(t){var r;return(r=e.call(this,t)||this)._graphic=null,r.defaultZ=0,r.geometryType=null,r.hasZ=!0,r.mode=null,r.snappingManager=null,r.snapToScene=!1,r}t._inheritsLoose(r,e);var o=r.prototype;return o.initialize=function(){this.internalGraphicsLayer=new u({listMode:"hide",internal:!0}),this.view.map.layers.add(this.internalGraphicsLayer),this.drawOperation=this.makeDrawOperation(),this.handles.add([this.drawOperation.on("vertex-add",(e=>this.onVertexAdd(e))),this.drawOperation.on("vertex-remove",(e=>this.onVertexRemove(e))),this.drawOperation.on("vertex-update",(e=>this.onVertexUpdate(e))),this.drawOperation.on("cursor-update",(e=>this.onCursorUpdate(e))),this.drawOperation.on("complete",(e=>this.onComplete(e)))]),this.complete()},o.destroy=function(){this.drawOperation=c.destroyMaybe(this.drawOperation),this._destroyAllVisualisations(),this.view.map.remove(this.internalGraphicsLayer),this.internalGraphicsLayer=c.destroyMaybe(this.internalGraphicsLayer),this._set("view",null)},o.completeCreateOperation=function(){this.drawOperation.complete()},o.onInputEvent=function(e){this.drawOperation.onInputEvent(e)},o.redo=function(){this.drawOperation.redo()},o.reset=function(){},o.undo=function(){this.drawOperation.undo()},o._createGraphic=function(e){this._graphic=new i({geometry:e,symbol:this.graphicSymbol}),this.internalGraphicsLayer.add(this._graphic),this.handles.add(this.initializeGraphic(this._graphic)),this.notifyChange("graphic"),this.handles.add(s.makeHandle((()=>{c.isSome(this._graphic)&&(this.internalGraphicsLayer.remove(this._graphic),this._graphic=c.destroyMaybe(this._graphic))})),v)},o._destroyAllVisualisations=function(){this.handles.remove(w.outline),this.handles.remove(w.regularVertices),this.handles.remove(w.activeVertex),this.handles.remove(v)},o._getCreateOperationGeometry=function(e={operationComplete:!1}){if(null==this.drawOperation||0===this.drawOperation.numVertices)return null;const t=this.drawOperation.stagedVertex,r=this.drawOperation.committedVertices,i=r.slice();c.isSome(t)&&i.push(this.drawOperation.coordinateHelper.pointToArray(t));const o=c.isSome(t)?this.drawOperation.coordinateHelper.pointToArray(t):r.splice(-1)[0],a={regularVertices:null,activeVertex:null,full:null,outline:null},n=i.length,s=this.drawOperation.spatialReference,l="3d"===this.view.type&&"global"===this.view.viewingMode;switch(this.geometryType){case"point":a.regularVertices=r,a.activeVertex=o,a.full=this.drawOperation.coordinateHelper.arrayToPoint(i[0]);break;case"multipoint":a.regularVertices=r,a.activeVertex=o,n>0&&(a.full=y.createMultipoint(i,s));break;case"polyline":a.regularVertices=r,a.activeVertex=o,n>0&&(a.full=y.createPolyline([i],s,l));break;case"polygon":a.regularVertices=r,a.activeVertex=o,n>0&&(a.full=y.createPolygon([i],s,l,!0));break;case"circle":if(n>0){const t=m.createViewAlignedCoordinateSystem(this.view,i[0]);if(1===n&&e.operationComplete){const e=i[0],r=t.makeMapPoint(e[0]+f*this.view.resolution,e[1]);a.full=y.createCircle([e,r],t,!0)}else 2===n&&(a.full=this.forceUniformSize?y.createCircle(i,t,this.centered):y.createEllipse(i,t,this.centered))}break;case"rectangle":if(n>0){const t=m.createViewAlignedCoordinateSystem(this.view,i[0]);if(1===n&&e.operationComplete){const e=i[0],r=t.makeMapPoint(e[0]+f*this.view.resolution,e[1]);a.full=y.createSquare([e,r],t,!0)}else 2===n&&(a.full=this.forceUniformSize?y.createSquare(i,t,this.centered):y.createRectangle(i,t,this.centered))}break;default:return null}switch(this.geometryType){case"point":case"multipoint":break;case"polyline":case"polygon":n>1&&(a.outline=y.createPolyline([i],s,l));break;case"circle":case"rectangle":c.isSome(a.full)&&"polygon"===a.full.type&&(a.outline=y.createPolygon(a.full.rings,s,l))}return a},o.initializeGraphic=function(e){return null},o.onComplete=function(e){this._updateGraphic();let t=null;if(this.drawOperation.isCompleted){const e=this._getCreateOperationGeometry({operationComplete:!0});c.isSome(e)&&(t=new i({geometry:e.full,symbol:this.graphicSymbol,sourceLayer:this.internalGraphicsLayer,...this.graphicProperties}))}this.emit("complete",{graphic:t,...e})},o.onCursorUpdate=function(e){this._updateGraphic(),this.emit("cursor-update",e)},o.onDeactivate=function(){this.drawOperation.isCompleted||this.drawOperation.cancel()},o.onVertexAdd=function(e){this._updateGraphic(),this.emit("vertex-add",e)},o.onVertexRemove=function(e){this._updateGraphic(),this.emit("vertex-remove",e)},o.onVertexUpdate=function(e){this._updateGraphic(),this.emit("vertex-update",e)},o._updateGraphic=function(){const e=this._getCreateOperationGeometry();c.isNone(e)?this._destroyAllVisualisations():(c.isSome(e.outline)?this.handles.add(this.onOutlineChanged(e.outline),w.outline):this.handles.remove(w.outline),c.isSome(e.regularVertices)?this.handles.add(this.onRegularVerticesChanged(e.regularVertices),w.regularVertices):this.handles.remove(w.regularVertices),c.isSome(e.activeVertex)?this.handles.add(this.onActiveVertexChanged(e.activeVertex),w.activeVertex):this.handles.remove(w.activeVertex),c.isSome(e.full)?c.isNone(this._graphic)?this._createGraphic(e.full):this._graphic.geometry=e.full:this.handles.remove(v))},t._createClass(r,[{key:"canRedo",get:function(){return this.drawOperation.canRedo}},{key:"canUndo",get:function(){return this.drawOperation.canUndo}},{key:"centered",set:function(e){this._set("centered",e),this._updateGraphic()}},{key:"enabled",set:function(e){this.drawOperation.interactive=e,this._set("enabled",e)}},{key:"forceUniformSize",set:function(e){this._set("forceUniformSize",e),this._updateGraphic()}},{key:"graphic",get:function(){return this._graphic}},{key:"graphicSymbol",set:function(e){this._set("graphicSymbol",e),c.isSome(this._graphic)&&(this._graphic.symbol=e)}},{key:"updating",get:function(){var e,t;return null!=(e=null==(t=this.drawOperation)?void 0:t.updating)&&e}}]),r}(n.HandleOwnerMixin(a.EventedMixin(g.InteractiveToolBase))),r.__decorate([l.property({value:!0})],e.DrawGraphicTool.prototype,"centered",null),r.__decorate([l.property({nonNullable:!0})],e.DrawGraphicTool.prototype,"defaultZ",void 0),r.__decorate([l.property()],e.DrawGraphicTool.prototype,"drawOperation",void 0),r.__decorate([l.property({value:!0})],e.DrawGraphicTool.prototype,"enabled",null),r.__decorate([l.property({value:!0})],e.DrawGraphicTool.prototype,"forceUniformSize",null),r.__decorate([l.property({constructOnly:!0})],e.DrawGraphicTool.prototype,"geometryType",void 0),r.__decorate([l.property()],e.DrawGraphicTool.prototype,"graphic",null),r.__decorate([l.property({constructOnly:!0})],e.DrawGraphicTool.prototype,"graphicProperties",void 0),r.__decorate([l.property()],e.DrawGraphicTool.prototype,"graphicSymbol",null),r.__decorate([l.property({constructOnly:!0})],e.DrawGraphicTool.prototype,"hasZ",void 0),r.__decorate([l.property({constructOnly:!0})],e.DrawGraphicTool.prototype,"mode",void 0),r.__decorate([l.property()],e.DrawGraphicTool.prototype,"snappingManager",void 0),r.__decorate([l.property()],e.DrawGraphicTool.prototype,"snapToScene",void 0),r.__decorate([l.property({readOnly:!0})],e.DrawGraphicTool.prototype,"type",void 0),r.__decorate([l.property({readOnly:!0})],e.DrawGraphicTool.prototype,"updating",null),r.__decorate([l.property({constructOnly:!0,nonNullable:!0})],e.DrawGraphicTool.prototype,"view",void 0),e.DrawGraphicTool=r.__decorate([d.subclass("esri.views.draw.DrawGraphicTool")],e.DrawGraphicTool);const v="create-operation-graphic",w={outline:"outline-visual",regularVertices:"regular-vertices-visual",activeVertex:"active-vertex-visual"};function _(e){switch(e){case"point":case"polyline":case"polygon":case"multipoint":return e;case"circle":case"rectangle":return"segment";default:return null}}const f=48;e.geometryTypeToDrawOperationGeometryType=_,Object.defineProperty(e,"__esModule",{value:!0})}));
