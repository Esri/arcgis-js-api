// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../Camera","../geometry","../Graphic","../Ground","../Viewpoint","../core/Collection","../core/domUtils","../core/Error","../core/events","../core/has","../core/Logger","../core/maybe","../core/promiseUtils","../core/scheduling","../core/watchUtils","../core/workers","./../core/screenUtils","../core/accessorSupport/decorators","../core/accessorSupport/ensureType","../core/libs/gl-matrix-2/vec3f64","../geometry/HeightModelInfo","../geometry/support/aaBoundingRect","../geometry/support/scaleUtils","../geometry/support/webMercatorUtils","../layers/support/layerUtils","./BreakpointsOwner","./DOMContainer","./GroundView","./PopupView","./View","./ViewAnimation","./3d/layerViewModuleImportUtils","./3d/constraints/Constraints","./3d/environment/SceneViewEnvironment","./3d/environment/SceneViewEnvironmentManager","./3d/input/SceneInputManager","./3d/layers/graphics/GraphicsDeconflictor","./3d/layers/graphics/Labeler","./3d/layers/graphics/ObjectResourceCache","./3d/layers/support/FeatureTileTree3D","./3d/state/ViewState","./3d/state/ViewStateManager","./3d/state/helpers/SceneIntersectionHelper","./3d/support/CombinedElevationProvider","./3d/support/debugFlags","./3d/support/DisplayQualityProfile","./3d/support/ElevationProvider","./3d/support/geometryUtils","./3d/support/HighlightOptions","./3d/support/MapCoordsHelper","./3d/support/pointUtils","./3d/support/projectionUtils","./3d/support/PropertiesPool","./3d/support/QualitySettings","./3d/support/RenderCoordsHelper","./3d/support/ResourceController","./3d/support/SceneViewPerformanceInfo","./3d/support/SharedSymbolResources","./3d/support/geometryUtils/boundedPlane","./3d/support/pointsOfInterest/PointsOfInterest","./3d/terrain/TerrainSurface","./3d/terrain/terrainUtils","./3d/webgl-engine/Stage","./3d/webgl-engine/lib/Intersector","./3d/webgl-engine/lib/intersectorUtils","./support/layerViewUtils","./support/screenshotUtils","./support/spatialReferenceSupport","./support/WebGLRequirements","./ui/3d/DefaultUI3D","../webscene/Environment","@dojo/framework/shim/Promise"],(function(e,t,r,i,n,a,o,s,p,l,d,c,u,h,g,y,f,m,_,v,w,b,S,R,x,O,T,M,P,C,E,V,I,H,L,G,A,D,U,F,j,N,W,z,q,k,B,Q,K,Z,J,X,Y,$,ee,te,re,ie,ne,ae,oe,se,pe,le,de,ce,ue,he,ge,ye,fe,me,_e,ve){"use strict";var we=h.getLogger("esri.views.SceneView"),be=function(t){function h(e){var i=t.call(this,e)||this;i._clippingArea=null,i._userClippingArea=null,i._initialDefaultSpatialReference=null,i._defaults={},i._externallySet={environment:!1},i._createGraphicsViewController=null,i._resolveWhenReady=[],i.propertiesPool=new te.default({slicePlane:se.BoundedPlaneClass},i),i._resourceController=ne.newResourceController(i),i._defaultToMapOptions={include:new Set},i._defaultHitTestOptions={exclude:new Set},i.deconflictor=new F.GraphicsDeconflictor({view:i}),i.labeler=new j.Labeler({view:i,deconflictor:i.deconflictor.labels}),i.sharedSymbolResources=null,i.basemapTerrain=null,i.elevationProvider=null,i.camera=null,i.canvas=null,i.center=null,i.constraints=new G.default,i.environmentManager=new D.default,i.extent=null,i.windowDevicePixelRatio=1,i.fullOpacity=1,i.graphicsView=null,i.groundView=null,i.navigating=!1,i.map=null,i.screenSizePerspectiveEnabled=!0,i.state=new z.default,i.scale=null,i.spatialReference=null,i.isHeightModelInfoRequired=!0,i.alphaCompositingEnabled=!1,i.supersampleScreenhotsEnabled=!0,i.type="3d",i.ui=new _e,i._numUpdating=0,i._lastUpdateTime=0,i.updatingProgress=.5,i.viewpoint=null,i.zoom=null,i.highlightOptions=new X,_.initialize(),i.handles.add(m.init(i,"viewingMode",(function(e){return i.state.viewingMode=e}),!0)),e&&e.environment||(i._defaults.environment=new A,i.environment=i._defaults.environment);var n=function(){i.notifyChange("dataExtent"),i.updatingChanged(),i.map&&i.map.allLayers.forEach((function(e){return r.__awaiter(i,void 0,void 0,(function(){return r.__generator(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,e.when()];case 1:return t.sent(),[3,3];case 2:return t.sent(),[3,3];case 3:return this.updatingChanged(),[2]}}))}))}))};i.handles.add([m.on(i,"map.allLayers","after-changes",n,n,n,!0),i.allLayerViews.on("after-changes",(function(){return i._updateUpdatingMonitors()})),i.watch("map",(function(e){e&&e.load&&e.load().catch((function(){}))}))]),i.inputManager=new U({view:i});return i.stateManager=new q.ViewStateManager({view:i,updateDevicePixelRatio:function(){var e=window.devicePixelRatio;e!==i.windowDevicePixelRatio&&(i.windowDevicePixelRatio=e,i.notifyChange("pixelRatio"))}}),i}return r.__extends(h,t),h.prototype.initialize=function(){var e=this;this.groundView=new E({view:this}),this._updateUpdatingMonitors();var t=function(){return e._updateDefaultToMapOptions()};this.handles.add(m.on(this,"map.allLayers","after-changes",t,t,t)),this.updatingHandles.add(this.qualitySettings,"memoryLimit",(function(t){e.resourceController&&(e.resourceController.memoryController.maxMemory=t)}),2),this.updatingHandles.add(this.qualitySettings,"additionalCacheMemory",(function(t){e.resourceController&&(e.resourceController.memoryController.additionalCacheMemory=t)}),2),this.updatingHandles.add(this.qualitySettings,"frameRate",(function(e){return f.setFrameDuration(e>0?1e3/Math.ceil(e):0)}),2),this.updatingHandles.add(Q,"SCENEVIEW_LOCKING_LOG",(function(t){return e.defaultsFromMap.logDebugInformation=t}),2),this.updatingHandles.add(this,"map.ground",t,3),this.updatingHandles.add(this,"map.ground.opacity",(function(){return e._updateDefaultHitTestOptions()}),3),this.handles.add(this.watch("spatialReference",(function(){return e.notifyChange("clippingArea")}),!0))},h.prototype.destroy=function(){this.destroyed||(this.invalidate(),this.activeTool=null,this.layerViewManager.clear(),this._exitSurface(),this._disposeGraphicsView(),this.sharedSymbolResources&&(this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null),this.labeler.destroy(),this._set("labeler",null),this.deconflictor.destroy(),this._set("deconflictor",null),this._resourceController.destroy(),this._resourceController=null,this.stateManager.destroy(),this._set("stateManager",null),this.inputManager.destroy(),this._set("inputManager",null),this.propertiesPool.destroy(),this.handles.remove("updatingMonitors"),this.environmentManager.destroy(),this._set("environmentManager",null),this.groundView.destroy(),this.groundView=null)},Object.defineProperty(h.prototype,"renderSpatialReference",{get:function(){return this.renderCoordsHelper?this.renderCoordsHelper.spatialReference:null},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"clippingArea",{get:function(){if("global"===this.viewingMode)return null;var e=this._userClippingArea||this.get("map.clippingArea");if(!(!!this._userClippingArea||this.get("map.clippingEnabled"))||!e)return this._clippingArea=null,null;if(!(e instanceof n.Extent))return we.error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea;if(this.spatialReference){if(!T.canProject(e.spatialReference,this.spatialReference))return we.error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea;e=T.project(e,this.spatialReference)}return this._clippingArea&&e&&this._clippingArea.equals(e)?this._clippingArea:(this._clippingArea=e,e)},set:function(e){this.ready&&"global"===this.viewingMode&&e?we.error("#clippingArea=","Clipping area is only supported in local viewingMode"):(this._userClippingArea=e,this.notifyChange("clippingArea"))},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"dataExtent",{get:function(){var e=[],t=this.spatialReference||n.SpatialReference.WGS84,r=this.clippingArea;r&&(r=T.project(r,t));var i=function(i){if(i){var n=T.project(i,t);n&&(r&&!(n=n.intersection(r))||e.push(n))}},a=this.basemapTerrain;if(a&&a.spatialReference&&i(new n.Extent({xmin:a.extent[0],ymin:a.extent[1],zmin:0,xmax:a.extent[2],ymax:a.extent[3],zmax:0,spatialReference:a.spatialReference})),this.map&&this.map.allLayers.forEach((function(e){return i(e.fullExtent)})),0===e.length)return new n.Extent({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0,spatialReference:t});var o=e.reduce((function(e,t){return e.union(t)}));return o.hasZ?(o.zmin=Math.min(0,o.zmin),o.zmax=Math.max(0,o.zmax)):(o.zmin=0,o.zmax=0),o},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"environment",{set:function(e){e!==this._defaults.environment&&(this._externallySet.environment=!0),this._set("environment",e)},enumerable:!1,configurable:!0}),h.prototype.castEnvironment=function(e){return e?e instanceof A?e:e instanceof ve?null!=this.environment?this.environment.cloneWithWebsceneEnvironment(e):A.fromWebsceneEnvironment(e):b.ensureType(A,e):new A},Object.defineProperty(h.prototype,"pixelRatio",{get:function(){return Math.min(this.windowDevicePixelRatio,this.maximumPixelRatio)},set:function(e){g.isSome(e)?this._override("pixelRatio",e):this._clearOverride("pixelRatio")},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"maximumPixelRatio",{get:function(){var e=1/0,t=this.qualitySettings,r=t.maximumPixelRatio,i=t.maximumRenderResolution;if(null!=r&&(e=Math.min(e,r)),null!=i){var n=i/Math.max(this.width,this.height);e=Math.min(e,n)}return e},set:function(e){g.isSome(e)?this._override("maximumPixelRatio",e):this._clearOverride("maximumPixelRatio")},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"groundExtent",{get:function(){var e=this._get("basemapTerrain");if(e&&e.spatialReference){var t=e.extent;return new n.Extent({xmin:t[0],ymin:t[1],xmax:t[2],ymax:t[3],spatialReference:e.spatialReference})}var r=this.spatialReference||n.SpatialReference.WGS84;return new n.Extent({spatialReference:r})},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"initialExtentRequired",{get:function(){return this.stateManager&&!this.stateManager.hasInitialView},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"interacting",{get:function(){return this.navigating||g.isSome(this.activeTool)},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"stationary",{get:function(){return!this.animation&&!this.resizing&&(g.isNone(this.state)||this.state.stationary)},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"qualityProfile",{get:function(){return this._get("qualityProfile")||K.getDefaultProfile()},set:function(e){K.isValidProfile(e)&&(K.apply(e,this.qualitySettings),this._set("qualityProfile",e))},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"slicePlane",{set:function(e){if(this._stage.renderView.setRenderParameters({slicePlane:e}),g.isNone(e))this._set("slicePlane",null);else{var t=this.propertiesPool.get("slicePlane");J.boundedPlane.copy(e,t),this._set("slicePlane",t)}},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"resolution",{get:function(){return null!=this.spatialReference?O.getResolutionForScale(this.scale,this.spatialReference):0},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"heightModelInfo",{get:function(){var e=this.getDefaultHeightModelInfo();return null!=e?R.deriveUnitFromSR(e,this.spatialReference):null},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"updating",{get:function(){var e=0,t=0,r=!1;this.allLayerViews.forEach((function(i){if(i.isFulfilled()){if(i.updating){if(r=!0,i.suspended)return;++t,e+="updatingProgress"in i?i.updatingProgress:.5}}else++t}));for(var i=0,n=[this.graphicsView,this.basemapView,this.basemapTerrain,this.layerViewManager,this._resourceController,this._stage&&this._stage.renderView,this.featureTiles,this.pointsOfInterest,this.environmentManager,this.overlay,this.updatingHandles,this.featureTreeDebugger];i<n.length;i++){var a=n[i];if(g.isSome(a)&&a.updating){t+=.1,e+=.05}}for(var o=0,s=[this.deconflictor,this.labeler];o<s.length;o++){a=s[o];g.isSome(a)&&a.updating&&(++t,e+=a.updatingProgress)}if((r=!!(r||t>0||!this.ready||!this.stationary||this._createGraphicsViewController||this.inputManager&&this.inputManager.hasPendingInputs||this.map&&this.map.allLayers&&this.map.allLayers.some((function(e){return!e.isFulfilled()}))))?(this._numUpdating=Math.max(t,this._numUpdating),e+=this._numUpdating-t):this._numUpdating=0,this._numUpdating>0?e/=this._numUpdating:e=r?.5:1,this._get("updatingProgress")!==e){var p=this._resourceController.scheduler.now;if(e<1){var l=Math.min((p-this._lastUpdateTime)/2e3,1);e=this.updatingProgress*(1-l)+e*l}this._set("updatingProgress",e),this._lastUpdateTime=r&&e<1?p:0}return r},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"viewingMode",{get:function(){var e=this.get("map.initialViewProperties.viewingMode");if(!e){var t=this.spatialReference;e=!t||fe.isSpatialReferenceSupported(t,"global")?"global":"local"}return e},set:function(e){if(this.ready)we.error("#viewingMode","viewingMode cannot be set once view is ready");else{["local","global"].indexOf(e)>=0?this._override("viewingMode",e):void 0===e&&this._clearOverride("viewingMode")}},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"resourceController",{get:function(){return this._resourceController},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"performanceInfo",{get:function(){return new ae(this)},enumerable:!1,configurable:!0}),h.prototype.on=function(e,r,i,n){var a=this.viewEvents.on(e,r,i,n);return a||t.prototype.on.call(this,e,r)},h.prototype.hasEventListener=function(e){return t.prototype.hasEventListener.call(this,e)||this.viewEvents.hasHandler(e)},h.prototype.toMap=function(e,t){if(!this.ready)return we.error("#toMap()","Scene view cannot be used before it is ready"),null;var r=t?this._externalToInternalIntersectOptions(t):this._defaultToMapOptions,i=g.isSome(r.graphics)&&(g.isSome(r.graphics.include)||g.isSome(r.graphics.exclude)),n=v.isSupportedScreenPointEvent(e)?v.createScreenPointFromSupportedEvent(this,e):e,a=v.screenPointObjectToArray(n);r.enableDraped=r.include&&!r.include.has(he.TERRAIN_ID)||r.exclude&&r.exclude.has(he.TERRAIN_ID);var o=this.sceneIntersectionHelper,s=new ue.Intersector(this.state.mode);if(s.options.selectionMode=!0,s.options.store=i?2:0,o.intersectIntersectorScreen(a,s,r),i){for(var p=0,l=s.results.all;p<l.length;p++){var d=l[p],c=d.toGraphic(this);if(g.isNone(c))return this._intersectResultToMapPoint(d);if(this._testGraphicUidFilter(r.graphics,c))return this._intersectResultToMapPoint(d)}return null}return this._intersectResultToMapPoint(s.results.min)},h.prototype.toScreen=function(e){if(!this.ready)return we.error("#toScreen()","Scene view cannot be used before it is ready"),null;var t=null==e.z&&Z.getElevationAtPoint(this.elevationProvider,e)||0;return $.pointToVector(e,Re,this.renderSpatialReference,t),this.engineToScreen(Re)},h.prototype.pixelSizeAt=function(e){return this.ready?e?($.pointToVector(e,Re,this.renderSpatialReference),this.state.camera.computeScreenPixelSizeAt(Re)):0:(we.error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null)},h.prototype.hitTest=function(e,t){if(!this.ready)return we.error("#hitTest()","Scene view cannot be used before it is ready"),null;var r=v.isSupportedScreenPointEvent(e)?v.createScreenPointFromSupportedEvent(this,e):e,i=v.createScreenPointArray(r.x,r.y),n=t?this._externalToInternalIntersectOptions(t):this._defaultHitTestOptions;n.requiresGroundFeedback=!0,n.enableDraped=!0;var a=new ue.Intersector(this.state.mode);a.options.selectionMode=!0,a.options.store=2,this.sceneIntersectionHelper.intersectIntersectorScreen(i,a,n);var o=this._intersectResultsToHits(a.results.all,n.graphics),s=a.results.ground,p=s.toOwner(this),l=g.isSome(p)&&"type"in p&&"integrated-mesh"===p.type?p:null,d={screenPoint:r,results:o,ground:{mapPoint:this._intersectResultToMapPoint(s),distance:s.hasIntersectionPoint?s.distanceInRenderSpace:0,layer:l}};return Q.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(d.intersector=a),y.resolve(d)},h.prototype.popupHitTest=function(e){return this.hitTest(e).then((function(t){for(var r=[],i=t.results.length?t.results[0].distance:0,n=0,a=t.results;n<a.length;n++){var o=a[n];if(o.distance!==i)break;r.push(o)}var s=null;return!(0===r.length||Math.abs(i-t.ground.distance)<1e-5)||t.ground.layer&&"integrated-mesh"===t.ground.layer.type||(s=t.ground.mapPoint),{results:r,screenPoint:e,mapPoint:s}}))},h.prototype.goTo=function(e,t){return this.stateManager.goTo(e,t)},h.prototype.whenLayerView=function(e){return t.prototype.whenLayerView.call(this,e)},h.prototype.takeScreenshot=function(e){var t=this;return this.whenReady().then((function(){var r=ye.toRenderSettings(e,t);return r.pixelRatio/=t.pixelRatio,t._stage.renderView.takeScreenshot(ye.screenshotSuperSampleSettings(r,t.supersampleScreenhotsEnabled,t.padding))}))},h.prototype.importLayerView=function(e){return L.layerView3DImporter.importLayerView(e)},h.prototype.hasLayerViewModule=function(e){return L.layerView3DImporter.hasLayerViewModule(e)},h.prototype.forceDOMReadyCycle=function(){this.forceReadyCycle()},h.prototype.getDefaultSpatialReference=function(){return this.get("map.initialViewProperties.spatialReference")||this.get("defaultsFromMap.spatialReference")||this.get("defaultsFromMap.isSpatialReferenceDone")&&this._initialDefaultSpatialReference||null},h.prototype.validate=function(){return r.__awaiter(this,void 0,void 0,(function(){var e;return r.__generator(this,(function(t){if(e=me.check(),u("safari")&&u("safari")<9&&(e=new d("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:u("safari")})),g.isSome(e))throw we.warn("#validate()",e.message),e;return[2]}))}))},h.prototype.isSpatialReferenceSupported=function(e,t,r){var i=e.isGeographic,n=e.isWebMercator,a=fe.isSpatialReferenceSupported(e,"global"),o="local"===this.viewingMode,s=!(!this._isOverridden("viewingMode")&&!this.get("map.initialViewProperties.viewingMode"));if(s){if(o&&i)return r&&r("Layer "+t.id+" is ignored because it is GCS and viewing mode is local"),!1;if(!o&&!a)return r&&r("Layer "+t.id+" is ignored because its spatial reference is not supported in global viewing mode"),!1}else if(i&&!a)return r&&r("Layer "+t.id+" is ignored because its spatial reference is geographic but unsupported"),!1;if(t)if(M.isTiledLayer(t)){var p,l=void 0;if(s)l=null!=(p=de.getTiledLayerInfo(t,e,this.state.mode)).tileInfo;else null==(p=de.getTiledLayerInfo(t,e,1)).tileInfo&&null!=(p=de.getTiledLayerInfo(t,e,2)).tileInfo&&n&&!this.ready&&(this.viewingMode="local"),l=null!=p.tileInfo;if(!l)return r&&r("Layer "+t.id+" is ignored because it is tiled but\n            its tiling scheme is not supported or compatible with the viewing mode"),!1}else if((e.isWGS84||n)&&!o)return null==this._initialDefaultSpatialReference&&(this._initialDefaultSpatialReference=e),s||this.ready||(this.viewingMode="global",r&&r("Viewing mode locked to global due to reprojectable layer "+t.id)),r&&r("Layer "+t.id+" is ignored because it supports server-side reprojection"),!1;return!0},h.prototype.whenReady=function(){var e=this;return y.create((function(t){e.ready?t(e):e._resolveWhenReady.push(t)}))},h.prototype.computeMapPointFromVec3d=function(e,t){var r=this.spatialReference||n.SpatialReference.WGS84;return ee.vectorToVector(e,this.renderSpatialReference,e,r)||(r=n.SpatialReference.WGS84,ee.vectorToVector(e,this.renderSpatialReference,e,r)),t?(t.x=e[0],t.y=e[1],t.z=e[2],t.spatialReference=r):t=new n.Point(e,r),t},h.prototype.engineToScreen=function(e,t){var r=v.createRenderScreenPointArray3();this.state.camera.projectPoint(e,r);var i=v.screenPointArrayToObject(r);return v.renderToScreen(this,i,t)},h.prototype.flushDisplayModifications=function(){this._stage.processDirty()},h.prototype.trackGraphicState=function(e){if(!e.graphic)return we.error("trackGraphicState","GraphicState.graphic must not be null or undefined to start tracking"),null;var t=this.getViewForGraphic(e.graphic),r=null,i=!1,n=function(t){!i&&g.isSome(t)&&"graphics3d"in t&&t.graphics3d&&t.graphics3d.graphicsCore&&(r=t.graphics3d.graphicsCore.trackGraphicState(e))};return g.isSome(t)?n(t):this.whenViewForGraphic(e.graphic,{waitForLayer:!0}).then((function(e){return n(e)}),(function(){})).catch((function(){})),{remove:function(){i=!0,g.isSome(r)&&(r.remove(),r=null)}}},h.prototype.maskOccludee=function(e){if(!e)return we.error("maskOccludee","GraphicState.graphic must not be null or undefined to mask an occludee"),null;var t=this.getViewForGraphic(e),r=null,i=!1,n=function(t){!i&&g.isSome(t)&&"graphics3d"in t&&ge.occludeesSupported(t)&&(r=t.occlude(e))};return g.isSome(t)?n(t):this.whenViewForGraphic(e,{waitForLayer:!0}).then((function(e){return n(e)}),(function(){})).catch((function(){})),{remove:function(){i=!0,g.isSome(r)&&(r.remove(),r=null)}}},h.prototype.getViewForGraphic=function(e){return e.layer===this.graphics?this.graphicsView:e.layer?this.allLayerViews.find((function(t){return t.layer===e.layer})):null},h.prototype.graphicChanged=function(e){g.isSome(this.graphicsView)&&this.graphicsView.graphicChanged(e)},h.prototype.whenViewForGraphic=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var i=this;return r.__generator(this,(function(r){switch(r.label){case 0:return e.layer!==this?[3,2]:[4,m.whenOnce(this,"graphicsView")];case 1:return r.sent(),[2,this.graphicsView];case 2:if(!e.layer||!this.map)throw new d("no-view-for-graphic");return t&&t.waitForLayer&&!this.map.allLayers.includes(e.layer)?[2,y.create((function(t,r){var n=i.map.allLayers.on("change",(function(a){-1!==a.added.indexOf(e.layer)&&(n.remove(),i.whenLayerView(e.layer).then(t,r))}))}))]:[2,this.whenLayerView(e.layer)]}}))}))},h.prototype._intersectResultToMapPoint=function(e,t){if(e.getIntersectionPoint(Re)){t=this.computeMapPointFromVec3d(Re,t);var r=this.basemapTerrain;return"TerrainRenderer"===e.intersector&&r&&(t.z=Z.getElevationAtPoint(r,t)||0),t}return null},h.prototype._intersectResultsToHits=function(e,t){for(var r=new Array,i=null,n=0;n<e.length;n++){var a=e[n],o=a.toOwner(this);if(g.isSome(o)&&(o===this.map.ground||"type"in o&&"integrated-mesh"===o.type))break;var s=a.toGraphic(this);if(g.isSome(s)){if(g.isNone(i)&&n!==e.length-1&&(i=new Set),g.isSome(i)){var p=this._getGraphicFilterUid(s);if(i.has(p))continue;i.add(p)}if(this._testGraphicUidFilter(t,s)){var l=this._intersectResultToMapPoint(a),d=a.distanceInRenderSpace;r.push({graphic:s,mapPoint:l,distance:d})}}}return r},h.prototype._getGraphicFilterUid=function(e){if(e.layer&&"objectIdField"in e.layer){var t=e.attributes[e.layer.objectIdField];if(t)return"o-"+e.layer.id+"-"+t}return"u-"+e.uid},h.prototype._testGraphicUidFilter=function(e,t){var r=this._getGraphicFilterUid(t);return g.isNone(e)||(g.isNone(e.include)||e.include.has(r))&&(g.isNone(e.exclude)||!e.exclude.has(r))},h.prototype._externalToInternalRenderItems=function(e,t,r){var i=this;return void 0===r&&(r={layerUids:null,graphicUids:null}),e?(e instanceof a?(!function(e,t){e.graphicUids||(e.graphicUids=new Set);e.graphicUids.add(t)}(r,this._getGraphicFilterUid(e)),0===t&&(g.isSome(this.graphicsView)&&e.layer===this?Se(r,this.graphicsView.mockLayerId):e.layer&&Se(r,e.layer.uid))):"forEach"in e?e.forEach((function(e){Array.isArray(e)?i._externalToInternalRenderItems(e,t,r):p.isCollection(e)?e===i.graphics&&g.isSome(i.graphicsView)?Se(r,i.graphicsView.mockLayerId):i._externalToInternalRenderItems(e,t,r):e instanceof o?e===i.map.ground&&Se(r,he.TERRAIN_ID):i._externalToInternalRenderItems(e,t,r)})):Se(r,e.uid),r):r},h.prototype._externalToInternalIntersectOptions=function(e){var t=this._externalToInternalRenderItems(e.include,0),r=this._externalToInternalRenderItems(e.exclude,1);return{include:t.layerUids,exclude:r.layerUids,graphics:{include:t.graphicUids,exclude:r.graphicUids}}},h.prototype._viewingModeToManifold=function(e){switch(e){case"global":return"spherical";case"local":return"planar"}},h.prototype._initBasemapTerrain=function(e){this._set("basemapTerrain",new le({view:this,manifold:this._viewingModeToManifold(e)})),this._set("elevationProvider",new B.CombinedElevationProvider({view:this})),this.elevationProvider.register("ground",this.basemapTerrain)},h.prototype._exitBasemapTerrain=function(){this.basemapTerrain&&(this.elevationProvider.unregister(this.basemapTerrain),this.elevationProvider.destroy(),this._set("elevationProvider",null),this.basemapTerrain.destroy(),this._set("basemapTerrain",null))},h.prototype._initGlobe=function(t){var r=this;this._initCoordinateSystem(),this.state.init(t,this.spatialReference),this._initBasemapTerrain(t),this._set("pointsOfInterest",new pe.default({view:this})),this._set("featureTiles",new W.default({renderCoordsHelper:this.renderCoordsHelper,cameraOnSurface:this.pointsOfInterest.cameraOnSurface,focus:this.pointsOfInterest.focus,tilingSchemeOwner:this.basemapTerrain,viewState:this.state,scheduler:this._resourceController.scheduler}));var i=function(){var e=r.basemapTerrain&&r.basemapTerrain.extent;if(r.clippingArea||e)if(e&&r.basemapTerrain.spatialReference){var t=x.toExtent(r.basemapTerrain.extent,r.basemapTerrain.spatialReference);r.clippingArea?r.featureTiles.filterExtent=t.intersection(r.clippingArea):r.featureTiles.filterExtent=t}else r.featureTiles.filterExtent=r.clippingArea;else r.featureTiles.filterExtent=null};this.handles.add([this.updatingHandles.add(Q,"FEATURE_TILE_TREE_SHOW_TILES",(function(t){t&&r.featureTiles&&!r.featureTreeDebugger?r.updatingHandles.addPromise(new Promise((function(t,r){e(["./3d/layers/support/FeatureTileTree3DDebugger"],t,r)}))).then((function(e){var t=e.FeatureTileTree3DDebugger;!r.featureTreeDebugger&&Q.FEATURE_TILE_TREE_SHOW_TILES&&(r.featureTreeDebugger=new t({view:r}))})):t||!r.featureTreeDebugger||Q.FEATURE_TILE_TREE_SHOW_TILES||(r.featureTreeDebugger.destroy(),r.featureTreeDebugger=null)}),3),this.updatingHandles.add(this,"clippingArea",i,3),this.updatingHandles.add(this,"basemapTerrain.extent",i,3)],"feature-tiles"),this.stateManager.init()},h.prototype._exitGlobe=function(){this.state&&(this.stateManager.deinit(),this.handles.remove("render-coords-helper"),this.handles.remove("feature-tiles"),this.featureTiles.destroy(),this._set("featureTiles",null),this.pointsOfInterest.destroy(),this._set("pointsOfInterest",null),this._exitBasemapTerrain(),this.state.exit(),this._exitCoordinateSystem())},h.prototype._initCoordinateSystem=function(){var e=this;if(this.spatialReference){var t=this.spatialReference;this.mapCoordsHelper&&this.mapCoordsHelper.spatialReference.equals(t)||this._set("mapCoordsHelper",new Y.default(this.map,t));var r="global"===this.viewingMode,i=r?ee.SphericalECEFSpatialReference:t;i!==this.renderSpatialReference&&(this._set("renderCoordsHelper",ie.RenderCoordsHelper.createMode(this.state.mode,i)),r||this.handles.add(this.watch("basemapTerrain.extent",(function(t){0===t[0]&&0===t[1]&&0===t[2]&&0===t[3]||(e.renderCoordsHelper.extent=t)}),!0),"render-coords-helper"),this.sceneIntersectionHelper&&this.sceneIntersectionHelper.setTolerance(ue.Intersector.DEFAULT_TOLERANCE/this.renderCoordsHelper.unitInMeters))}else this._set("mapCoordsHelper",null),this._set("renderCoordsHelper",null)},h.prototype._exitCoordinateSystem=function(){this.mapCoordsHelper&&(this.handles.remove("render-coords-helper"),this._set("renderCoordsHelper",null),this._set("mapCoordsHelper",null))},h.prototype.updatingChanged=function(){this.notifyChange("updating")},h.prototype._updateUpdatingMonitors=function(){var e=this;this.handles.remove("updatingMonitors"),this.allLayerViews.forEach((function(t){t.destroyed||(e.handles.add([t.watch(["updating","updatingProgress"],(function(){return e.updatingChanged()}),!0)],"updatingMonitors"),t.when((function(){return e.updatingChanged()}),(function(){return e.updatingChanged()})))})),this.updatingChanged()},h.prototype._renderScreenshotOverlay=function(e,t){if(this.overlay&&this.overlay.hasVisibleItems){var r=e.getContext("2d");r.putImageData(t,0,0),this.overlay.renderCanvas(e);for(var i=r.getImageData(0,0,t.width,t.height),n=0;n<i.data.length;n++)t.data[n]=i.data[n]}},h.prototype._initStage=function(){var e=this,t={renderContext:this.renderContext,deactivatedWebGLExtensions:this.deactivatedWebGLExtensions,debugWebGLExtensions:this.debugWebGLExtensions,viewingMode:this.state.mode,alpha:this.alphaCompositingEnabled,canvas:this.renderCanvas,screenshot:{renderOverlay:function(t,r){return e._renderScreenshotOverlay(t,r)}}},r=new k.SceneIntersectionHelper(this.state.mode,{forEachLayer:function(t){e._stage.getLayers().forEach(t)}},this);this._set("sceneIntersectionHelper",r);var i=l.byId(this.surface);this._stage=new ce.Stage({scheduler:this.resourceController.scheduler,viewingMode:this.state.mode,container:i,options:t,sceneIntersectionHelper:r}),this._lostWebGLContextHandle=c.on(this._stage.renderView.getCanvas(),"webglcontextlost",(function(){return e.fatalError=new d("webgl-context-lost")})),this.handles.add(this.updatingHandles.add(this.qualitySettings,"antialiasingEnabled",(function(){e._stage.renderView.setRenderParameters({antialiasingEnabled:e.qualitySettings.antialiasingEnabled})}),2),"stage");for(var n=function(){e._stage.renderView.setRenderParameters({defaultHighlightOptions:X.toEngineOptions(e.highlightOptions)})},a=0,o=["highlightOptions","highlightOptions.color","highlightOptions.haloColor","highlightOptions.haloOpacity","highlightOptions.fillOpacity"];a<o.length;a++){var s=o[a];this.handles.add(this.updatingHandles.add(this,s,n),"stage")}n(),this.renderCoordsHelper&&this.sceneIntersectionHelper.setTolerance(ue.Intersector.DEFAULT_TOLERANCE/this.renderCoordsHelper.unitInMeters),this._set("canvas",this._stage.renderView.getCanvas())},h.prototype._exitStage=function(){this._set("sceneIntersectionHelper",null),this._stage.destroy(),this._stage=null,this._lostWebGLContextHandle.remove(),this._lostWebGLContextHandle=null,this.handles.remove("stage"),this._set("canvas",null)},h.prototype._initSurface=function(){this._exitSurface(),this._initStage(),this._initGlobe(this.viewingMode),this.sharedSymbolResources=new oe.default({stage:this._stage,viewingMode:this.state.mode,resourceController:this._resourceController,pointsOfInterest:this.pointsOfInterest,viewState:this.state,objectResourceCache:new N.ObjectResourceCache})},h.prototype._exitSurface=function(){this.sharedSymbolResources&&(this.sharedSymbolResources.objectResourceCache.destroy(),this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null,this._exitGlobe(),this._exitStage())},h.prototype._createGraphicsViewIfNeeded=function(){var e=this;if(!this.graphicsView&&!this._createGraphicsViewController&&0!==this.graphics.length){this.handles.remove("graphics-view"),this._createGraphicsViewController=y.createAbortController();var t=function(){e._createGraphicsViewController=null,e.updatingChanged()};this._createGraphicsViewAsync(this._createGraphicsViewController.signal).then(t,t),this.updatingChanged()}},h.prototype._createGraphicsViewAsync=function(t){return r.__awaiter(this,void 0,void 0,(function(){var i;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,new Promise((function(t,r){e(["./3d/layers/GraphicsView3D"],t,r)}))];case 1:return i=r.sent(),y.throwIfAborted(t),[4,m.whenTrueOnce(this.basemapTerrain,"ready",t)];case 2:return r.sent(),this._set("graphicsView",new i({view:this})),[2]}}))}))},h.prototype._disposeGraphicsView=function(){this._createGraphicsViewController&&(this._createGraphicsViewController.abort(),this._createGraphicsViewController=null),this.handles.remove("graphics-view"),g.isSome(this.graphicsView)&&(this.handles.remove(this.graphicsView.mockLayerId),this.graphicsView.destroy(),this._set("graphicsView",null))},h.prototype._startup=function(){var e=this;if("global"===this.viewingMode&&(this._clippingArea=null),this._set("ready",!0),this._initSurface(),this.handles.add(m.on(this,"graphics","after-changes",(function(){return e._createGraphicsViewIfNeeded()})),"graphics-view"),this._createGraphicsViewIfNeeded(),!this._externallySet.environment){var t=this.get("map.initialViewProperties.environment");t&&(this.environment=t)}this.labeler.setup(),this.environmentManager.connectView(this),this.inputManager.connect();var r=this._resolveWhenReady;this._resolveWhenReady=[],r.forEach((function(t){return t(e)}))},h.prototype._teardown=function(){this._initialDefaultSpatialReference=null,this.inputManager.disconnect(),this.environmentManager.disconnectView(),this.labeler.dispose(),this._disposeGraphicsView(),this.handles.remove("graphics-view"),this._exitSurface(),this._set("ready",!1)},h.prototype._updateDefaultToMapOptions=function(){if(this._defaultToMapOptions.include.clear(),this.map){this.map.ground&&this._defaultToMapOptions.include.add(he.TERRAIN_ID);for(var e=0,t=this.map.allLayers.items;e<t.length;e++){var r=t[e];"integrated-mesh"===r.type&&this._defaultToMapOptions.include.add(r.uid)}}},h.prototype._updateDefaultHitTestOptions=function(){if(this._defaultHitTestOptions.exclude.clear(),this.map){this.map.ground&&this.map.ground.opacity<1&&this._defaultHitTestOptions.exclude.add(he.TERRAIN_ID);for(var e=0,t=this.map.allLayers.items;e<t.length;e++){var r=t[e];"integrated-mesh"===r.type&&r.opacity<1&&this._defaultToMapOptions.exclude.add(r.uid)}}},r.__decorate([w.property()],h.prototype,"_resourceController",void 0),r.__decorate([w.property()],h.prototype,"_stage",void 0),r.__decorate([w.property({readOnly:!0})],h.prototype,"deconflictor",void 0),r.__decorate([w.property({readOnly:!0})],h.prototype,"labeler",void 0),r.__decorate([w.property({type:H,readOnly:!0,aliasOf:"state.animation"})],h.prototype,"animation",void 0),r.__decorate([w.property({readOnly:!0})],h.prototype,"basemapTerrain",void 0),r.__decorate([w.property({readOnly:!0})],h.prototype,"elevationProvider",void 0),r.__decorate([w.property({type:i,aliasOf:"stateManager.camera"})],h.prototype,"camera",void 0),r.__decorate([w.property({readOnly:!0})],h.prototype,"canvas",void 0),r.__decorate([w.property({type:n.Point,aliasOf:"stateManager.center"})],h.prototype,"center",void 0),r.__decorate([w.property({type:n.Extent,dependsOn:["map.clippingArea?","map.clippingEnabled?","viewingMode"]})],h.prototype,"clippingArea",null),r.__decorate([w.property({type:G.default})],h.prototype,"constraints",void 0),r.__decorate([w.property({type:n.Extent,dependsOn:["basemapTerrain.extent","clippingArea","map"],readOnly:!0})],h.prototype,"dataExtent",null),r.__decorate([w.property({value:null,type:A})],h.prototype,"environment",null),r.__decorate([w.cast("environment")],h.prototype,"castEnvironment",null),r.__decorate([w.property({readOnly:!0})],h.prototype,"environmentManager",void 0),r.__decorate([w.property({type:n.Extent,aliasOf:"stateManager.extent"})],h.prototype,"extent",void 0),r.__decorate([w.property({readOnly:!0,aliasOf:"stateManager.screenCenter"})],h.prototype,"screenCenter",void 0),r.__decorate([w.property({type:Number,dependsOn:["maximumPixelRatio"]})],h.prototype,"pixelRatio",null),r.__decorate([w.property({type:Number,dependsOn:["qualitySettings.maximumPixelRatio","qualitySettings.maximumRenderResolution","size"]})],h.prototype,"maximumPixelRatio",null),r.__decorate([w.property({aliasOf:"stateManager.frustum"})],h.prototype,"frustum",void 0),r.__decorate([w.property({type:Number,readOnly:!0})],h.prototype,"fullOpacity",void 0),r.__decorate([w.property({readOnly:!0})],h.prototype,"graphicsView",void 0),r.__decorate([w.property({type:n.Extent,dependsOn:["basemapTerrain.extent"],readOnly:!0})],h.prototype,"groundExtent",null),r.__decorate([w.property()],h.prototype,"groundView",void 0),r.__decorate([w.property({type:Boolean,dependsOn:["stateManager.hasInitialView"]})],h.prototype,"initialExtentRequired",null),r.__decorate([w.property({type:Boolean,dependsOn:["navigating","activeTool"],readOnly:!0})],h.prototype,"interacting",null),r.__decorate([w.property({dependsOn:["animation","resizing","state.stationary"]})],h.prototype,"stationary",null),r.__decorate([w.property({aliasOf:"state.navigating"})],h.prototype,"navigating",void 0),r.__decorate([w.property()],h.prototype,"map",void 0),r.__decorate([w.property({readOnly:!0})],h.prototype,"mapCoordsHelper",void 0),r.__decorate([w.property({aliasOf:"stateManager.padding"})],h.prototype,"padding",void 0),r.__decorate([w.property({type:pe.default,readOnly:!0})],h.prototype,"pointsOfInterest",void 0),r.__decorate([w.property({type:W.default,readOnly:!0})],h.prototype,"featureTiles",void 0),r.__decorate([w.property()],h.prototype,"featureTreeDebugger",void 0),r.__decorate([w.property({type:Boolean})],h.prototype,"screenSizePerspectiveEnabled",void 0),r.__decorate([w.property({constructOnly:!0})],h.prototype,"deactivatedWebGLExtensions",void 0),r.__decorate([w.property({constructOnly:!0})],h.prototype,"debugWebGLExtensions",void 0),r.__decorate([w.property({constructOnly:!0})],h.prototype,"renderCanvas",void 0),r.__decorate([w.property({constructOnly:!0})],h.prototype,"state",void 0),r.__decorate([w.property({readOnly:!0})],h.prototype,"inputManager",void 0),r.__decorate([w.property({readOnly:!0})],h.prototype,"stateManager",void 0),r.__decorate([w.property({type:["low","medium","high"]})],h.prototype,"qualityProfile",null),r.__decorate([w.property({type:re,get:function(){var e=this._get("qualitySettings");return e||(e=new re,K.apply(this.qualityProfile,e)),e}})],h.prototype,"qualitySettings",void 0),r.__decorate([w.property()],h.prototype,"slicePlane",null),r.__decorate([w.property({dependsOn:["viewingMode"]})],h.prototype,"preconditionsReady",void 0),r.__decorate([w.property({readOnly:!0})],h.prototype,"renderCoordsHelper",void 0),r.__decorate([w.property({readOnly:!0})],h.prototype,"sceneIntersectionHelper",void 0),r.__decorate([w.property({type:Number,dependsOn:["scale","spatialReference"],readOnly:!0})],h.prototype,"resolution",null),r.__decorate([w.property({type:Number,aliasOf:"stateManager.scale"})],h.prototype,"scale",void 0),r.__decorate([w.property()],h.prototype,"heightModelInfo",null),r.__decorate([w.property({dependsOn:["map.initialViewProperties?.spatialReference","defaultsFromMap.isSpatialReferenceDone"]})],h.prototype,"spatialReference",void 0),r.__decorate([w.property({type:Boolean,constructOnly:!0})],h.prototype,"alphaCompositingEnabled",void 0),r.__decorate([w.property({type:Boolean})],h.prototype,"supersampleScreenhotsEnabled",void 0),r.__decorate([w.property({readOnly:!0})],h.prototype,"type",void 0),r.__decorate([w.property({type:_e})],h.prototype,"ui",void 0),r.__decorate([w.property({type:Boolean,readOnly:!0,dependsOn:["graphicsView.updating","basemapView.updating","basemapTerrain.updating","layerViewManager.updating","_resourceController.updating","_stage.renderView.updating","featureTiles.updating","pointsOfInterest.updating","environmentManager.updating","overlay.updating","updatingHandles.updating","featureTreeDebugger.updating","labeler.updating","deconflictor.updating","ready","stationary","inputManager.hasPendingInputs"]})],h.prototype,"updating",null),r.__decorate([w.property({type:Number,readOnly:!0,dependsOn:["updating"]})],h.prototype,"updatingProgress",void 0),r.__decorate([w.property({type:["global","local"],dependsOn:["map.initialViewProperties?.viewingMode","spatialReference"]})],h.prototype,"viewingMode",null),r.__decorate([w.property({type:s,aliasOf:"stateManager.viewpoint"})],h.prototype,"viewpoint",void 0),r.__decorate([w.property({type:Number,aliasOf:"stateManager.zoom"})],h.prototype,"zoom",void 0),r.__decorate([w.property({type:X})],h.prototype,"highlightOptions",void 0),h=r.__decorate([w.subclass("esri.views.SceneView")],h)}(P.BreakpointsOwner(C.DOMContainer(V.PopupView(I))));function Se(e,t){e.layerUids||(e.layerUids=new Set),e.layerUids.add(t)}var Re=S.vec3f64.create();return be}));