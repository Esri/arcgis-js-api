// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../core/mathUtils","../../core/maybe"],(function(t,e,i,o,r){"use strict";return function(){function t(e,o,a){void 0===a&&(a=null),this._context=null,this._glName=null,this._id=-1,this._descriptor=void 0,this._samplingModeDirty=!1,this._wrapModeDirty=!1,this._boundToUnits=new Set,this._context=e,this._descriptor=i.__assign({target:3553,samplingMode:9729,wrapMode:10497,flipped:!1,hasMipmap:!1,isOpaque:!1,unpackAlignment:4,preMultiplyAlpha:!1},o),this._id=++t._nextId,r.isSome(e.instanceCounter)&&e.instanceCounter.increment(0,this),this.setData(a)}return Object.defineProperty(t.prototype,"id",{get:function(){return this._id},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"glName",{get:function(){return this._glName},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"descriptor",{get:function(){return this._descriptor},enumerable:!1,configurable:!0}),t.prototype.dispose=function(){var t=this;if(this._context&&this._context.gl){if(this._glName){var e=this._context.gl;this._boundToUnits.forEach((function(e){t._context.bindTexture(null,e)})),e.deleteTexture(this._glName),this._glName=null}r.isSome(this._context.instanceCounter)&&this._context.instanceCounter.decrement(0,this),this._context=null}},t.prototype.release=function(){this.dispose()},t.prototype.resize=function(t,e){var i=this._descriptor;i.width===t&&i.height===e||(i.width=t,i.height=e,this.setData(null))},t.prototype.setData=function(e){if(this._context&&this._context.gl){var i=this._context.gl;this._glName||(this._glName=i.createTexture()),void 0===e&&(e=null),null===e&&(this._descriptor.width=this._descriptor.width||4,this._descriptor.height=this._descriptor.height||4);var o=this._context.getBoundTexture(0);this._context.bindTexture(this,0);var a=this._descriptor;t._validateTexture(a),i.pixelStorei(i.UNPACK_ALIGNMENT,a.unpackAlignment),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,a.flipped?1:0),i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,a.preMultiplyAlpha?1:0);var n=a.pixelFormat,s=a.internalFormat?a.internalFormat:n;if(e instanceof ImageData||e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement){var p=e.width,h=e.height;e instanceof HTMLVideoElement&&(p=e.videoWidth,h=e.videoHeight),a.width&&a.height&&console.assert(p===a.width&&h===a.height),i.texImage2D(i.TEXTURE_2D,0,s,n,a.dataType,e),a.hasMipmap&&this.generateMipmap(),void 0===a.width&&(a.width=p),void 0===a.height&&(a.height=h)}else{null!=a.width&&null!=a.height||console.error("Width and height must be specified!"),i.DEPTH24_STENCIL8&&s===i.DEPTH_STENCIL&&(s=i.DEPTH24_STENCIL8);p=a.width,h=a.height;if(function(t){return r.isSome(t)&&"type"in t&&"compressed"===t.type}(e)){var d=Math.round(Math.log(Math.max(p,h))/Math.LN2)+1;a.hasMipmap=a.hasMipmap&&d===e.levels.length;for(var l=0;;++l){var _=e.levels[Math.min(l,e.levels.length-1)];if(i.compressedTexImage2D(i.TEXTURE_2D,l,s,p,h,0,_),1===p&&1===h||!a.hasMipmap)break;p=Math.max(1,p>>1),h=Math.max(1,h>>1)}}else if(r.isSome(e))i.texImage2D(i.TEXTURE_2D,0,s,p,h,0,n,a.dataType,e),a.hasMipmap&&this.generateMipmap();else for(l=0;i.texImage2D(i.TEXTURE_2D,l,s,p,h,0,n,a.dataType,null),(1!==p||1!==h)&&a.hasMipmap;++l)p=Math.max(1,p>>1),h=Math.max(1,h>>1)}t._applySamplingMode(i,this._descriptor),t._applyWrapMode(i,this._descriptor),t._applyAnisotropicFilteringParameters(this._context,this._descriptor),this._context.bindTexture(o,0)}},t.prototype.updateData=function(t,e,i,o,r,a){a||console.error("An attempt to use uninitialized data!"),this._glName||console.error("An attempt to update uninitialized texture!");var n=this._context.gl,s=this._descriptor,p=this._context.getBoundTexture(0);this._context.bindTexture(this,0),(e<0||i<0||o>s.width||r>s.height||e+o>s.width||i+r>s.height)&&console.error("An attempt to update out of bounds of the texture!"),n.pixelStorei(n.UNPACK_ALIGNMENT,s.unpackAlignment),n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,s.flipped?1:0),n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,s.preMultiplyAlpha?1:0),a instanceof ImageData||a instanceof HTMLImageElement||a instanceof HTMLCanvasElement||a instanceof HTMLVideoElement?n.texSubImage2D(n.TEXTURE_2D,t,e,i,s.pixelFormat,s.dataType,a):n.texSubImage2D(n.TEXTURE_2D,t,e,i,o,r,s.pixelFormat,s.dataType,a),this._context.bindTexture(p,0)},t.prototype.generateMipmap=function(){var e=this._descriptor;e.hasMipmap||(e.hasMipmap=!0,this._samplingModeDirty=!0,t._validateTexture(e)),9729===e.samplingMode?(this._samplingModeDirty=!0,e.samplingMode=9985):9728===e.samplingMode&&(this._samplingModeDirty=!0,e.samplingMode=9984);var i=this._context.getBoundTexture(0);this._context.bindTexture(this,0);var o=this._context.gl;o.generateMipmap(o.TEXTURE_2D),this._context.bindTexture(i,0)},t.prototype.setSamplingMode=function(e){e!==this._descriptor.samplingMode&&(this._descriptor.samplingMode=e,t._validateTexture(this._descriptor),this._samplingModeDirty=!0)},t.prototype.setWrapMode=function(e){e!==this._descriptor.wrapMode&&(this._descriptor.wrapMode=e,t._validateTexture(this._descriptor),this._wrapModeDirty=!0)},t.prototype.applyChanges=function(){var e=this._context.gl,i=this._descriptor;this._samplingModeDirty&&(t._applySamplingMode(e,i),this._samplingModeDirty=!1),this._wrapModeDirty&&(t._applyWrapMode(e,i),this._wrapModeDirty=!1)},t.prototype.setBoundToUnit=function(t,e){e?this._boundToUnits.add(t):this._boundToUnits.delete(t)},t._validateTexture=function(t){(t.width<0||t.height<0)&&console.error("Negative dimension parameters are not allowed!"),o.isPowerOfTwo(t.width)&&o.isPowerOfTwo(t.height)||("number"==typeof t.wrapMode?33071!==t.wrapMode&&console.error("Non-power-of-two textures must have a wrap mode of CLAMP_TO_EDGE!"):33071===t.wrapMode.s&&33071===t.wrapMode.t||console.error("Non-power-of-two textures must have a wrap mode of CLAMP_TO_EDGE!"),t.hasMipmap&&console.error("Mipmapping requires power-of-two textures!"))},t._applySamplingMode=function(t,e){var i=e.samplingMode,o=e.samplingMode;9985===i||9987===i?(i=9729,e.hasMipmap||(o=9729)):9984!==i&&9986!==i||(i=9728,e.hasMipmap||(o=9728)),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,o)},t._applyWrapMode=function(t,e){"number"==typeof e.wrapMode?(t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,e.wrapMode),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,e.wrapMode)):(t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,e.wrapMode.s),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,e.wrapMode.t))},t._applyAnisotropicFilteringParameters=function(t,e){if(null!=e.maxAnisotropy){var i=t.capabilities.textureFilterAnisotropic;if(i){var o=t.gl;o.texParameterf(o.TEXTURE_2D,i.TEXTURE_MAX_ANISOTROPY,e.maxAnisotropy)}}},t._nextId=0,t}()}));