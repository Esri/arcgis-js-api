/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../core/has","../../core/mathUtils","../../core/maybe","./checkWebGLError","./context-util","./enums"],(function(e,t,i,r,o,a,n,s){"use strict";const l={target:s.TextureType.TEXTURE_2D,samplingMode:s.TextureSamplingMode.LINEAR,wrapMode:s.TextureWrapMode.REPEAT,flipped:!1,hasMipmap:!1,isOpaque:!1,unpackAlignment:4,preMultiplyAlpha:!1,isImmutable:!1},p=4;let h=function(){function e(e,t,i=null){this._context=e,this.type="texture",this._glName=null,this._samplingModeDirty=!1,this._wrapModeDirty=!1,this._wasImmutablyAllocated=!1,e.instanceCounter.increment(s.ResourceType.Texture,this),this._descriptor={...l,...t};for(const r in l){void 0===this._descriptor[r]&&(this._descriptor[r]=l[r])}if(e.type!==n.ContextType.WEBGL2&&(this._descriptor.isImmutable&&(this._descriptor.isImmutable=!1),T(this._descriptor.target)))throw new Error("3D and array textures are not supported in WebGL1");this._descriptor.target===s.TextureType.TEXTURE_CUBE_MAP?this._setDataCubeMap(i):this.setData(i)}var i=e.prototype;return i.dispose=function(){this._context.gl&&this._glName&&(this._context.unbindTexture(this),this._context.gl.deleteTexture(this._glName),this._glName=null,this._context.instanceCounter.decrement(s.ResourceType.Texture,this))},i.release=function(){this.dispose()},i.resize=function(e,t){const i=this._descriptor;if(i.width!==e||i.height!==t){if(this._wasImmutablyAllocated)throw new Error("Immutable textures can't be resized!");i.width=e,i.height=t,this._descriptor.target===s.TextureType.TEXTURE_CUBE_MAP?this._setDataCubeMap(null):this.setData(null)}},i._setDataCubeMap=function(e=null){for(let t=s.TextureType.TEXTURE_CUBE_MAP_POSITIVE_X;t<=s.TextureType.TEXTURE_CUBE_MAP_NEGATIVE_Z;t++)this._setData(e,t)},i.setData=function(e){this._setData(e)},i._setData=function(t,i){if(!this._context||!this._context.gl)return;const r=this._context.gl;this._glName||(this._glName=r.createTexture()),void 0===t&&(t=null);const n=this._descriptor,s=i??n.target,l=T(s);null===t&&(n.width=n.width||p,n.height=n.height||p,l&&(n.depth=n.depth??1));const h=this._context.bindTexture(this,e.TEXTURE_UNIT_FOR_UPDATES);this._context.setActiveTexture(e.TEXTURE_UNIT_FOR_UPDATES),e._validateTexture(this._context,n),this._configurePixelStorage(),a.checkWebGLError(r);const u=n.pixelFormat;let m=n.internalFormat??this._deriveInternalFormat(u,n.dataType);if(c(t)){let e=t.width,i=t.height;const o=1;t instanceof HTMLVideoElement&&(e=t.videoWidth,i=t.videoHeight),n.width&&n.height,l&&n.depth,n.isImmutable&&!this._wasImmutablyAllocated&&this._texStorage(s,m,n.hasMipmap,e,i,o),this._texImage(s,0,m,e,i,o,t),a.checkWebGLError(r),n.hasMipmap&&this.generateMipmap(),void 0===n.width&&(n.width=e),void 0===n.height&&(n.height=i),l&&void 0===n.depth&&(n.depth=o)}else{const{width:e,height:i,depth:p}=n;if(null==e||null==i)throw new Error("Width and height must be specified!");if(l&&null==p)throw new Error("Depth must be specified!");if(n.isImmutable&&!this._wasImmutablyAllocated&&this._texStorage(s,m,n.hasMipmap,e,i,p),r.DEPTH24_STENCIL8&&m===r.DEPTH_STENCIL&&(m=r.DEPTH24_STENCIL8),d(t)){const a=t.levels,l=x(s,e,i,p),h=Math.min(l-1,a.length-1);o.isSome(this._context.gl2)?r.texParameteri(n.target,this._context.gl2.TEXTURE_MAX_LEVEL,h):n.hasMipmap=n.hasMipmap&&l===a.length;const u=m;if(!_(u))throw new Error("Attempting to use compressed data with an umcompressed format!");this._forEachMipmapLevel(((e,t,i,r)=>{const o=a[Math.min(e,a.length-1)];this._compressedTexImage(s,e,u,t,i,r,o)}),h)}else o.isSome(t)?(this._texImage(s,0,m,e,i,p,t),a.checkWebGLError(r),n.hasMipmap&&this.generateMipmap()):this._forEachMipmapLevel(((e,t,i,o)=>{this._texImage(s,e,m,t,i,o,null),a.checkWebGLError(r)}))}e._applySamplingMode(r,this._descriptor),e._applyWrapMode(r,this._descriptor),e._applyAnisotropicFilteringParameters(this._context,this._descriptor),a.checkWebGLError(r),this._context.bindTexture(h,e.TEXTURE_UNIT_FOR_UPDATES)},i.updateData=function(t,i,r,a,n,s,l=0){s||console.error("An attempt to use uninitialized data!"),this._glName||console.error("An attempt to update uninitialized texture!");const p=this._context.gl,h=this._descriptor,{pixelFormat:u,dataType:_,target:m,isImmutable:T}=h,x=h.internalFormat??this._deriveInternalFormat(u,_);if(T&&!this._wasImmutablyAllocated)throw new Error("Cannot update immutable texture before allocation!");const g=this._context.bindTexture(this,e.TEXTURE_UNIT_FOR_UPDATES,!0);if((i<0||r<0||a>h.width||n>h.height||i+a>h.width||r+n>h.height)&&console.error("An attempt to update out of bounds of the texture!"),this._configurePixelStorage(),l){if(o.isNone(this._context.gl2))return void console.error("Webgl2 must be enabled to use dataRowOffset!");p.pixelStorei(this._context.gl2.UNPACK_SKIP_ROWS,l)}if(c(s)?o.isSome(this._context.gl2)?this._context.gl2.texSubImage2D(m,t,i,r,a,n,u,_,s):p.texSubImage2D(m,t,i,r,u,_,s):d(s)?p.compressedTexSubImage2D(m,t,i,r,a,n,x,s.levels[t]):p.texSubImage2D(m,t,i,r,a,n,u,_,s),l){if(o.isNone(this._context.gl2))return void console.error("Webgl2 must be enabled to use dataRowOffset!");p.pixelStorei(this._context.gl2.UNPACK_SKIP_ROWS,0)}this._context.bindTexture(g,e.TEXTURE_UNIT_FOR_UPDATES)},i.updateData3D=function(t,i,r,a,n,s,l,p){p||console.error("An attempt to use uninitialized data!"),this._glName||console.error("An attempt to update uninitialized texture!");const h=this._context.gl2;if(o.isNone(h))throw new Error("3D textures are not supported in WebGL1");const u=this._descriptor,{pixelFormat:_,dataType:m,isImmutable:c,target:x}=u,g=u.internalFormat??this._deriveInternalFormat(_,m);if(c&&!this._wasImmutablyAllocated)throw new Error("Cannot update immutable texture before allocation!");T(x)||console.warn("Attempting to set 3D texture data on a non-3D texture");const E=this._context.bindTexture(this,e.TEXTURE_UNIT_FOR_UPDATES);if(this._context.setActiveTexture(e.TEXTURE_UNIT_FOR_UPDATES),(i<0||r<0||a<0||n>u.width||s>u.height||l>u.depth||i+n>u.width||r+s>u.height||a+l>u.depth)&&console.error("An attempt to update out of bounds of the texture!"),this._configurePixelStorage(),d(p))p=p.levels[t],h.compressedTexSubImage3D(x,t,i,r,a,n,s,l,g,p);else{const e=p;h.texSubImage3D(x,t,i,r,a,n,s,l,_,m,e)}this._context.bindTexture(E,e.TEXTURE_UNIT_FOR_UPDATES)},i.generateMipmap=function(){const t=this._descriptor;if(!t.hasMipmap){if(this._wasImmutablyAllocated)throw new Error("Cannot add mipmaps to immutable texture after allocation");t.hasMipmap=!0,this._samplingModeDirty=!0,e._validateTexture(this._context,t)}t.samplingMode===s.TextureSamplingMode.LINEAR?(this._samplingModeDirty=!0,t.samplingMode=s.TextureSamplingMode.LINEAR_MIPMAP_NEAREST):t.samplingMode===s.TextureSamplingMode.NEAREST&&(this._samplingModeDirty=!0,t.samplingMode=s.TextureSamplingMode.NEAREST_MIPMAP_NEAREST);const i=this._context.bindTexture(this,e.TEXTURE_UNIT_FOR_UPDATES);this._context.setActiveTexture(e.TEXTURE_UNIT_FOR_UPDATES);this._context.gl.generateMipmap(t.target),this._context.bindTexture(i,e.TEXTURE_UNIT_FOR_UPDATES)},i.setSamplingMode=function(e){e!==this._descriptor.samplingMode&&(this._descriptor.samplingMode=e,this._samplingModeDirty=!0)},i.setWrapMode=function(t){t!==this._descriptor.wrapMode&&(this._descriptor.wrapMode=t,e._validateTexture(this._context,this._descriptor),this._wrapModeDirty=!0)},i.applyChanges=function(){const t=this._context.gl,i=this._descriptor;this._samplingModeDirty&&(e._applySamplingMode(t,i),this._samplingModeDirty=!1),this._wrapModeDirty&&(e._applyWrapMode(t,i),this._wrapModeDirty=!1)},i._deriveInternalFormat=function(e,t){if(this._context.type===n.ContextType.WEBGL1)return e;switch(t){case s.PixelType.FLOAT:switch(e){case s.PixelFormat.RGBA:return s.SizedPixelFormat.RGBA32F;case s.PixelFormat.RGB:return s.SizedPixelFormat.RGB32F;default:throw new Error("Unable to derive format")}case s.PixelType.UNSIGNED_BYTE:switch(e){case s.PixelFormat.RGBA:return s.SizedPixelFormat.RGBA8;case s.PixelFormat.RGB:return s.SizedPixelFormat.RGB8}default:return e}},i._configurePixelStorage=function(){const e=this._context.gl,{unpackAlignment:t,flipped:i,preMultiplyAlpha:r}=this._descriptor;e.pixelStorei(e.UNPACK_ALIGNMENT,t),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,i?1:0),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,r?1:0)},i._texStorage=function(e,t,i,r,a,n){const s=this._context.gl2;if(o.isNone(s))throw new Error("Immutable textures are not supported in WebGL1");if(!u(t))throw new Error("Immutable textures must have a sized internal format");if(!this._descriptor.isImmutable)return;const l=i?x(e,r,a,n):1;if(T(e)){if(null==n)throw new Error("Missing depth dimension for 3D texture upload");s.texStorage3D(e,l,t,r,a,n)}else s.texStorage2D(e,l,t,r,a);this._wasImmutablyAllocated=!0},i._texImage=function(e,t,i,r,a,s,l){const p=this._context.gl;let h=null;const u=this._context.type===n.ContextType.WEBGL2,_=T(e),{isImmutable:d,pixelFormat:m,dataType:x}=this._descriptor;if(u&&(h=p),u||!c(l))if(d){if(o.isSome(l)){const i=l;if(_){if(null==s)throw new Error("Missing depth dimension for 3D texture upload");h.texSubImage3D(e,t,0,0,0,r,a,s,m,x,i)}else p.texSubImage2D(e,t,0,0,r,a,m,x,i)}}else{const n=o.unwrap(l);if(_){if(null==s)throw new Error("Missing depth dimension for 3D texture upload");h.texImage3D(e,t,i,r,a,s,0,m,x,n)}else p.texImage2D(e,t,i,r,a,0,m,x,n)}else p.texImage2D(e,0,i,m,x,l)},i._compressedTexImage=function(e,t,i,r,a,s,l){const p=this._context.gl;let h=null;const u=T(e),_=this._descriptor.isImmutable;if(u){if(this._context.type!==n.ContextType.WEBGL2)throw new Error("3D textures are not supported in WebGL1");h=p}if(_){if(o.isSome(l))if(u){if(null==s)throw new Error("Missing depth dimension for 3D texture upload");h.compressedTexSubImage3D(e,t,0,0,0,r,a,s,i,l)}else p.compressedTexSubImage2D(e,t,0,0,r,a,i,l)}else if(u){if(null==s)throw new Error("Missing depth dimension for 3D texture upload");h.compressedTexImage3D(e,t,i,r,a,s,0,l)}else p.compressedTexImage2D(e,t,i,r,a,0,l)},i._forEachMipmapLevel=function(e,t=1/0){let{width:i,height:r,depth:o,hasMipmap:a,target:n}=this._descriptor;const l=n===s.TextureType.TEXTURE_3D;if(null==i||null==r||l&&null==o)throw new Error("Missing texture dimensions for mipmap calculation");for(let s=0;e(s,i,r,o),a&&(1!==i||1!==r||l&&1!==o)&&!(s>=t);++s)i=Math.max(1,i>>1),r=Math.max(1,r>>1),l&&(o=Math.max(1,o>>1))},e._validateTexture=function(e,t){(null!=t.width&&t.width<0||null!=t.height&&t.height<0||null!=t.depth&&t.depth<0)&&console.error("Negative dimension parameters are not allowed!");const i=e.type===n.ContextType.WEBGL2,o=null!=t.width&&r.isPowerOfTwo(t.width)&&null!=t.height&&r.isPowerOfTwo(t.height);i||!t.isImmutable&&!T(t.target)||console.error("Immutable and 3D-like textures are not supported in WebGL1!"),i||o||("number"==typeof t.wrapMode?t.wrapMode!==s.TextureWrapMode.CLAMP_TO_EDGE&&console.error("Non-power-of-two textures must have a wrap mode of CLAMP_TO_EDGE!"):t.wrapMode.s===s.TextureWrapMode.CLAMP_TO_EDGE&&t.wrapMode.t===s.TextureWrapMode.CLAMP_TO_EDGE||console.error("Non-power-of-two textures must have a wrap mode of CLAMP_TO_EDGE!"),t.hasMipmap&&console.error("Mipmapping requires power-of-two textures!"))},e._applySamplingMode=function(e,t){let i=t.samplingMode,r=t.samplingMode;i===s.TextureSamplingMode.LINEAR_MIPMAP_NEAREST||i===s.TextureSamplingMode.LINEAR_MIPMAP_LINEAR?(i=s.TextureSamplingMode.LINEAR,t.hasMipmap||(r=s.TextureSamplingMode.LINEAR)):i!==s.TextureSamplingMode.NEAREST_MIPMAP_NEAREST&&i!==s.TextureSamplingMode.NEAREST_MIPMAP_LINEAR||(i=s.TextureSamplingMode.NEAREST,t.hasMipmap||(r=s.TextureSamplingMode.NEAREST)),e.texParameteri(t.target,e.TEXTURE_MAG_FILTER,i),e.texParameteri(t.target,e.TEXTURE_MIN_FILTER,r)},e._applyWrapMode=function(e,t){"number"==typeof t.wrapMode?(e.texParameteri(t.target,e.TEXTURE_WRAP_S,t.wrapMode),e.texParameteri(t.target,e.TEXTURE_WRAP_T,t.wrapMode)):(e.texParameteri(t.target,e.TEXTURE_WRAP_S,t.wrapMode.s),e.texParameteri(t.target,e.TEXTURE_WRAP_T,t.wrapMode.t))},e._applyAnisotropicFilteringParameters=function(e,t){const i=e.capabilities.textureFilterAnisotropic;if(!i)return;e.gl.texParameterf(t.target,i.TEXTURE_MAX_ANISOTROPY,t.maxAnisotropy??1)},t._createClass(e,[{key:"glName",get:function(){return this._glName}},{key:"descriptor",get:function(){return this._descriptor}},{key:"isDirty",get:function(){return this._samplingModeDirty||this._wrapModeDirty}}]),e}();function u(e){return e in s.SizedPixelFormat}function _(e){return e in s.CompressedTextureFormat}function d(e){return o.isSome(e)&&"type"in e&&"compressed"===e.type}function m(e){return o.isSome(e)&&"byteLength"in e}function c(e){return o.isSome(e)&&!d(e)&&!m(e)}function T(e){return e===s.TextureType.TEXTURE_3D||e===s.TextureType.TEXTURE_2D_ARRAY}function x(e,t,i,r=1){let o=Math.max(t,i);return e===s.TextureType.TEXTURE_3D&&(o=Math.max(o,r)),Math.round(Math.log(o)/Math.LN2)+1}h.TEXTURE_UNIT_FOR_UPDATES=0,e.Texture=h,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
