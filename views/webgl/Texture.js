/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../core/maybe","../../core/mathUtils","./capabilities/isWebGL2Context"],(function(t,e,i,o){"use strict";const a=4,n=0;function s(t){return e.isSome(t)&&"type"in t&&"compressed"===t.type}return function(){function r(t,e,i=null){this._context=null,this._glName=null,this._descriptor=void 0,this._samplingModeDirty=!1,this._wrapModeDirty=!1,t.instanceCounter.increment(0,this),this._context=t,this._descriptor={target:3553,samplingMode:9729,wrapMode:10497,flipped:!1,hasMipmap:!1,isOpaque:!1,unpackAlignment:4,preMultiplyAlpha:!1,...e},this.setData(i)}var p=r.prototype;return p.dispose=function(){if(this._context&&this._context.gl){if(this._glName){const t=this._context.gl;this._context.unbindTextureAllUnits(this),t.deleteTexture(this._glName),this._glName=null}this._context.instanceCounter.decrement(0,this),this._context=null}},p.release=function(){this.dispose()},p.resize=function(t,e){const i=this._descriptor;i.width===t&&i.height===e||(i.width=t,i.height=e,this.setData(null))},p.setData=function(t){if(!this._context||!this._context.gl)return;const i=this._context.gl;this._glName||(this._glName=i.createTexture()),void 0===t&&(t=null),null===t&&(this._descriptor.width=this._descriptor.width||a,this._descriptor.height=this._descriptor.height||a);const o=this._context.getBoundTexture(n);this._context.bindTexture(this,n);const p=this._descriptor;r._validateTexture(this._context,p),i.pixelStorei(i.UNPACK_ALIGNMENT,p.unpackAlignment),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,p.flipped?1:0),i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,p.preMultiplyAlpha?1:0);const h=p.pixelFormat;let l=p.internalFormat?p.internalFormat:h;if(t instanceof ImageData||t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||t instanceof HTMLVideoElement){let e=t.width,o=t.height;t instanceof HTMLVideoElement&&(e=t.videoWidth,o=t.videoHeight),p.width&&p.height&&console.assert(e===p.width&&o===p.height),i.texImage2D(i.TEXTURE_2D,0,l,h,p.dataType,t),p.hasMipmap&&this.generateMipmap(),void 0===p.width&&(p.width=e),void 0===p.height&&(p.height=o)}else{null!=p.width&&null!=p.height||console.error("Width and height must be specified!"),i.DEPTH24_STENCIL8&&l===i.DEPTH_STENCIL&&(l=i.DEPTH24_STENCIL8);let o=p.width,a=p.height;if(s(t)){const e=Math.round(Math.log(Math.max(o,a))/Math.LN2)+1;p.hasMipmap=p.hasMipmap&&e===t.levels.length;for(let n=0;;++n){const e=t.levels[Math.min(n,t.levels.length-1)];if(i.compressedTexImage2D(i.TEXTURE_2D,n,l,o,a,0,e),1===o&&1===a||!p.hasMipmap)break;o=Math.max(1,o>>1),a=Math.max(1,a>>1)}}else if(e.isSome(t))i.texImage2D(i.TEXTURE_2D,0,l,o,a,0,h,p.dataType,t),p.hasMipmap&&this.generateMipmap();else for(let t=0;i.texImage2D(i.TEXTURE_2D,t,l,o,a,0,h,p.dataType,null),(1!==o||1!==a)&&p.hasMipmap;++t)o=Math.max(1,o>>1),a=Math.max(1,a>>1)}r._applySamplingMode(i,this._descriptor),r._applyWrapMode(i,this._descriptor),r._applyAnisotropicFilteringParameters(this._context,this._descriptor),o&&this._context.bindTexture(o,n)},p.updateData=function(t,e,i,o,a,s){s||console.error("An attempt to use uninitialized data!"),this._glName||console.error("An attempt to update uninitialized texture!");const r=this._context.gl,p=this._descriptor,h=this._context.getBoundTexture(n);this._context.bindTexture(this,n),(e<0||i<0||o>p.width||a>p.height||e+o>p.width||i+a>p.height)&&console.error("An attempt to update out of bounds of the texture!"),r.pixelStorei(r.UNPACK_ALIGNMENT,p.unpackAlignment),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,p.flipped?1:0),r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,p.preMultiplyAlpha?1:0),s instanceof ImageData||s instanceof HTMLImageElement||s instanceof HTMLCanvasElement||s instanceof HTMLVideoElement?r.texSubImage2D(r.TEXTURE_2D,t,e,i,p.pixelFormat,p.dataType,s):r.texSubImage2D(r.TEXTURE_2D,t,e,i,o,a,p.pixelFormat,p.dataType,s),this._context.bindTexture(h,n)},p.generateMipmap=function(){const t=this._descriptor;t.hasMipmap||(t.hasMipmap=!0,this._samplingModeDirty=!0,r._validateTexture(this._context,t)),9729===t.samplingMode?(this._samplingModeDirty=!0,t.samplingMode=9985):9728===t.samplingMode&&(this._samplingModeDirty=!0,t.samplingMode=9984);const e=this._context.getBoundTexture(n);this._context.bindTexture(this,n);const i=this._context.gl;i.generateMipmap(i.TEXTURE_2D),this._context.bindTexture(e,n)},p.setSamplingMode=function(t){t!==this._descriptor.samplingMode&&(this._descriptor.samplingMode=t,r._validateTexture(this._context,this._descriptor),this._samplingModeDirty=!0)},p.setWrapMode=function(t){t!==this._descriptor.wrapMode&&(this._descriptor.wrapMode=t,r._validateTexture(this._context,this._descriptor),this._wrapModeDirty=!0)},p.applyChanges=function(){const t=this._context.gl,e=this._descriptor;this._samplingModeDirty&&(r._applySamplingMode(t,e),this._samplingModeDirty=!1),this._wrapModeDirty&&(r._applyWrapMode(t,e),this._wrapModeDirty=!1)},r._validateTexture=function(t,e){(e.width<0||e.height<0)&&console.error("Negative dimension parameters are not allowed!");const a=i.isPowerOfTwo(e.width)&&i.isPowerOfTwo(e.height);o(t.gl)||a||("number"==typeof e.wrapMode?33071!==e.wrapMode&&console.error("Non-power-of-two textures must have a wrap mode of CLAMP_TO_EDGE!"):33071===e.wrapMode.s&&33071===e.wrapMode.t||console.error("Non-power-of-two textures must have a wrap mode of CLAMP_TO_EDGE!"),e.hasMipmap&&console.error("Mipmapping requires power-of-two textures!"))},r._applySamplingMode=function(t,e){let i=e.samplingMode,o=e.samplingMode;9985===i||9987===i?(i=9729,e.hasMipmap||(o=9729)):9984!==i&&9986!==i||(i=9728,e.hasMipmap||(o=9728)),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,o)},r._applyWrapMode=function(t,e){"number"==typeof e.wrapMode?(t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,e.wrapMode),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,e.wrapMode)):(t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,e.wrapMode.s),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,e.wrapMode.t))},r._applyAnisotropicFilteringParameters=function(t,e){if(null==e.maxAnisotropy)return;const i=t.capabilities.textureFilterAnisotropic;if(!i)return;const o=t.gl;o.texParameterf(o.TEXTURE_2D,i.TEXTURE_MAX_ANISOTROPY,e.maxAnisotropy)},t._createClass(r,[{key:"glName",get:function(){return this._glName}},{key:"descriptor",get:function(){return this._descriptor}}]),r}()}));
