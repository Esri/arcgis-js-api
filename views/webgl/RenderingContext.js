/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../core/maybe","./checkWebGLError","./enums","./InstanceCounter","./renderState","./Texture","./WebGLDriverTest","./capabilities/isWebGL2Context","./capabilities/load"],(function(t,e,i,s,n,a,l,r,h,c,o){"use strict";let u=function(){function t(t,e){this.gl=t,this.instanceCounter=new a.InstanceCounter,this._blendEnabled=!1,this._blendColorState={r:0,g:0,b:0,a:0},this._blendFunctionState={srcRGB:1,dstRGB:0,srcAlpha:1,dstAlpha:0},this._blendEquationState={mode:32774,modeAlpha:32774},this._colorMaskState={r:!0,g:!0,b:!0,a:!0},this._polygonCullingEnabled=!1,this._cullFace=1029,this._frontFace=2305,this._scissorTestEnabled=!1,this._scissorRect={x:0,y:0,width:0,height:0},this._depthTestEnabled=!1,this._depthFunction=513,this._clearDepth=1,this._depthWriteEnabled=!0,this._depthRange={zNear:0,zFar:1},this._viewport=null,this._stencilTestEnabled=!1,this._polygonOffsetFillEnabled=!1,this._polygonOffset=[0,0],this._stencilFunction={face:1032,func:519,ref:0,mask:1},this._clearStencil=0,this._stencilWriteMask=1,this._stencilOperation={face:1032,fail:7680,zFail:7680,zPass:7680},this._clearColor={r:0,g:0,b:0,a:0},this._activeShaderProgram=null,this._activeVertexBuffer=null,this._activeIndexBuffer=null,this._activeFramebuffer=null,this._activeRenderbuffer=null,this._activeTextureUnit=0,this._textureUnitMap=new Array,this._numOfDrawCalls=0,this._numOfTriangles=0,this.webglVersion=c(t)?"webgl2":"webgl","webgl"===this.webglVersion&&this.gl.getExtension("OES_element_index_uint"),this._capabilities=o.loadCapabilities(t,e),this._parameters=this._loadParameters(e);const i=this.gl.getParameter(this.gl.VIEWPORT);this._viewport={x:i[0],y:i[1],width:i[2],height:i[3]},this._stateTracker=new l.StateTracker({setBlending:t=>{if(t){this.setBlendingEnabled(!0),this.setBlendEquationSeparate(t.opRgb,t.opAlpha),this.setBlendFunctionSeparate(t.srcRgb,t.dstRgb,t.srcAlpha,t.dstAlpha);const e=t.color;this.setBlendColor(e.r,e.g,e.b,e.a)}else this.setBlendingEnabled(!1)},setCulling:t=>{t?(this.setFaceCullingEnabled(!0),this.setCullFace(t.face),this.setFrontFace(t.mode)):this.setFaceCullingEnabled(!1)},setPolygonOffset:t=>{t?(this.setPolygonOffsetFillEnabled(!0),this.setPolygonOffset(t.factor,t.units)):this.setPolygonOffsetFillEnabled(!1)},setDepthTest:t=>{t?(this.setDepthTestEnabled(!0),this.setDepthFunction(t.func)):this.setDepthTestEnabled(!1)},setStencilTest:t=>{if(t){this.setStencilTestEnabled(!0);const e=t.function;this.setStencilFunction(e.func,e.ref,e.mask);const i=t.operation;this.setStencilOp(i.fail,i.zFail,i.zPass)}else this.setStencilTestEnabled(!1)},setDepthWrite:t=>{t?(this.setDepthWriteEnabled(!0),this.setDepthRange(t.zNear,t.zFar)):this.setDepthWriteEnabled(!1)},setColorWrite:t=>{t?this.setColorMask(t.r,t.g,t.b,t.a):this.setColorMask(!1,!1,!1,!1)},setStencilWrite:t=>{t?this.setStencilWriteMask(t.mask):this.setStencilWriteMask(0)}}),this.enforceState(),this.driverTest=new h.WebGLDriverTest(this)}var u=t.prototype;return u.dispose=function(){this.bindVAO(null),this.unbindBuffer(34962),this.unbindBuffer(34963),this._textureUnitMap.length=0,s.webglDebugEnabled()&&this.instanceCounter.printResourceCount()},u.setPipelineState=function(t){this._stateTracker.setPipeline(t)},u.setBlendingEnabled=function(t){this._blendEnabled!==t&&(!0===t?this.gl.enable(this.gl.BLEND):this.gl.disable(this.gl.BLEND),this._blendEnabled=t,this._stateTracker.invalidateBlending())},u.externalProgramUpdate=function(){var t;null==(t=this._activeShaderProgram)||t.stop(),this._activeShaderProgram=null},u.externalTextureUnitUpdate=function(t,e){for(let i=0;i<t.length;++i)this._textureUnitMap[t[i]]=null;e>=0&&(this._activeTextureUnit=e)},u.externalVertexArrayObjectUpdate=function(){const t=this.capabilities.vao;t&&(t.bindVertexArray(null),this._activeVertexArrayObject=null),this._activeVertexBuffer=null,this._activeIndexBuffer=null},u.externalVertexBufferUpdate=function(){this._activeVertexBuffer=null},u.externalIndexBufferUpdate=function(){this._activeIndexBuffer=null},u.setBlendColor=function(t,e,i,s){t===this._blendColorState.r&&e===this._blendColorState.g&&i===this._blendColorState.b&&s===this._blendColorState.a||(this.gl.blendColor(t,e,i,s),this._blendColorState.r=t,this._blendColorState.g=e,this._blendColorState.b=i,this._blendColorState.a=s,this._stateTracker.invalidateBlending())},u.setBlendFunction=function(t,e){t===this._blendFunctionState.srcRGB&&e===this._blendFunctionState.dstRGB||(this.gl.blendFunc(t,e),this._blendFunctionState.srcRGB=t,this._blendFunctionState.srcAlpha=t,this._blendFunctionState.dstRGB=e,this._blendFunctionState.dstAlpha=e,this._stateTracker.invalidateBlending())},u.setBlendFunctionSeparate=function(t,e,i,s){this._blendFunctionState.srcRGB===t&&this._blendFunctionState.srcAlpha===i&&this._blendFunctionState.dstRGB===e&&this._blendFunctionState.dstAlpha===s||(this.gl.blendFuncSeparate(t,e,i,s),this._blendFunctionState.srcRGB=t,this._blendFunctionState.srcAlpha=i,this._blendFunctionState.dstRGB=e,this._blendFunctionState.dstAlpha=s,this._stateTracker.invalidateBlending())},u.setBlendEquation=function(t){this._blendEquationState.mode!==t&&(this.gl.blendEquation(t),this._blendEquationState.mode=t,this._blendEquationState.modeAlpha=t,this._stateTracker.invalidateBlending())},u.setBlendEquationSeparate=function(t,e){this._blendEquationState.mode===t&&this._blendEquationState.modeAlpha===e||(this.gl.blendEquationSeparate(t,e),this._blendEquationState.mode=t,this._blendEquationState.modeAlpha=e,this._stateTracker.invalidateBlending())},u.setColorMask=function(t,e,i,s){this._colorMaskState.r===t&&this._colorMaskState.g===e&&this._colorMaskState.b===i&&this._colorMaskState.a===s||(this.gl.colorMask(t,e,i,s),this._colorMaskState.r=t,this._colorMaskState.g=e,this._colorMaskState.b=i,this._colorMaskState.a=s,this._stateTracker.invalidateColorWrite())},u.setClearColor=function(t,e,i,s){this._clearColor.r===t&&this._clearColor.g===e&&this._clearColor.b===i&&this._clearColor.a===s||(this.gl.clearColor(t,e,i,s),this._clearColor.r=t,this._clearColor.g=e,this._clearColor.b=i,this._clearColor.a=s)},u.setFaceCullingEnabled=function(t){this._polygonCullingEnabled!==t&&(!0===t?this.gl.enable(this.gl.CULL_FACE):this.gl.disable(this.gl.CULL_FACE),this._polygonCullingEnabled=t,this._stateTracker.invalidateCulling())},u.setPolygonOffsetFillEnabled=function(t){this._polygonOffsetFillEnabled!==t&&(!0===t?this.gl.enable(this.gl.POLYGON_OFFSET_FILL):this.gl.disable(this.gl.POLYGON_OFFSET_FILL),this._polygonOffsetFillEnabled=t,this._stateTracker.invalidatePolygonOffset())},u.setPolygonOffset=function(t,e){this._polygonOffset[0]===t&&this._polygonOffset[1]===e||(this._polygonOffset[0]=t,this._polygonOffset[1]=e,this.gl.polygonOffset(t,e),this._stateTracker.invalidatePolygonOffset())},u.setCullFace=function(t){this._cullFace!==t&&(this.gl.cullFace(t),this._cullFace=t,this._stateTracker.invalidateCulling())},u.setFrontFace=function(t){this._frontFace!==t&&(this.gl.frontFace(t),this._frontFace=t,this._stateTracker.invalidateCulling())},u.setScissorTestEnabled=function(t){this._scissorTestEnabled!==t&&(!0===t?this.gl.enable(this.gl.SCISSOR_TEST):this.gl.disable(this.gl.SCISSOR_TEST),this._scissorTestEnabled=t)},u.setScissorRect=function(t,e,i,s){this._scissorRect.x===t&&this._scissorRect.y===e&&this._scissorRect.width===i&&this._scissorRect.height===s||(this.gl.scissor(t,e,i,s),this._scissorRect.x=t,this._scissorRect.y=e,this._scissorRect.width=i,this._scissorRect.height=s)},u.setDepthTestEnabled=function(t){this._depthTestEnabled!==t&&(!0===t?this.gl.enable(this.gl.DEPTH_TEST):this.gl.disable(this.gl.DEPTH_TEST),this._depthTestEnabled=t,this._stateTracker.invalidateDepthTest())},u.setClearDepth=function(t){this._clearDepth!==t&&(this.gl.clearDepth(t),this._clearDepth=t)},u.setDepthFunction=function(t){this._depthFunction!==t&&(this.gl.depthFunc(t),this._depthFunction=t,this._stateTracker.invalidateDepthTest())},u.setDepthWriteEnabled=function(t){this._depthWriteEnabled!==t&&(this.gl.depthMask(t),this._depthWriteEnabled=t,this._stateTracker.invalidateDepthWrite())},u.setDepthRange=function(t,e){this._depthRange.zNear===t&&this._depthRange.zFar===e||(this.gl.depthRange(t,e),this._depthRange.zNear=t,this._depthRange.zFar=e,this._stateTracker.invalidateDepthWrite())},u.setStencilTestEnabled=function(t){this._stencilTestEnabled!==t&&(!0===t?this.gl.enable(this.gl.STENCIL_TEST):this.gl.disable(this.gl.STENCIL_TEST),this._stencilTestEnabled=t,this._stateTracker.invalidateStencilTest())},u.setClearStencil=function(t){t!==this._clearStencil&&(this.gl.clearStencil(t),this._clearStencil=t)},u.setStencilFunction=function(t,e,i){this._stencilFunction.func===t&&this._stencilFunction.ref===e&&this._stencilFunction.mask===i||(this.gl.stencilFunc(t,e,i),this._stencilFunction.face=1032,this._stencilFunction.func=t,this._stencilFunction.ref=e,this._stencilFunction.mask=i,this._stateTracker.invalidateStencilTest())},u.setStencilFunctionSeparate=function(t,e,i,s){this._stencilFunction.face===t&&this._stencilFunction.func===e&&this._stencilFunction.ref===i&&this._stencilFunction.mask===s||(this.gl.stencilFuncSeparate(t,e,i,s),this._stencilFunction.face=t,this._stencilFunction.func=e,this._stencilFunction.ref=i,this._stencilFunction.mask=s,this._stateTracker.invalidateStencilTest())},u.setStencilWriteMask=function(t){this._stencilWriteMask!==t&&(this.gl.stencilMask(t),this._stencilWriteMask=t,this._stateTracker.invalidateStencilWrite())},u.setStencilOp=function(t,e,i){this._stencilOperation.fail===t&&this._stencilOperation.zFail===e&&this._stencilOperation.zPass===i||(this.gl.stencilOp(t,e,i),this._stencilOperation.face=1032,this._stencilOperation.fail=t,this._stencilOperation.zFail=e,this._stencilOperation.zPass=i,this._stateTracker.invalidateStencilTest())},u.setStencilOpSeparate=function(t,e,i,s){this._stencilOperation.face===t&&this._stencilOperation.fail===e&&this._stencilOperation.zFail===i&&this._stencilOperation.zPass===s||(this.gl.stencilOpSeparate(t,e,i,s),this._stencilOperation.face=t,this._stencilOperation.face=t,this._stencilOperation.fail=e,this._stencilOperation.zFail=i,this._stencilOperation.zPass=s,this._stateTracker.invalidateStencilTest())},u.setActiveTexture=function(t,e=!1){const i=this._activeTextureUnit;return t>=0&&(e||t!==this._activeTextureUnit)&&(this.gl.activeTexture(n.BASE_TEXTURE_UNIT+t),this._activeTextureUnit=t),i},u.clear=function(t){t&&this.gl.clear(t)},u.clearSafe=function(t,e=255){t&&(16384&t&&this.setColorMask(!0,!0,!0,!0),256&t&&this.setDepthWriteEnabled(!0),1024&t&&this.setStencilWriteMask(e),this.gl.clear(t))},u.drawArrays=function(t,e,i){s.webglDebugEnabled()&&(this._numOfDrawCalls++,this._numOfTriangles+=d(t,i)),this.gl.drawArrays(t,e,i)},u.drawElements=function(t,e,i,n){s.webglDebugEnabled()&&(this._numOfDrawCalls++,this._numOfTriangles+=d(t,e)),this.gl.drawElements(t,e,i,n)},u.logIno=function(){s.webglDebugEnabled()&&console.log(`DrawCalls: ${this._numOfDrawCalls}, Triangles: ${this._numOfTriangles}`)},u.setViewport=function(t,e,i,s){i=Math.max(Math.round(i),1),s=Math.max(Math.round(s),1);const n=this._viewport;n.x===t&&n.y===e&&n.width===i&&n.height===s||(n.x=t,n.y=e,n.width=i,n.height=s,this.gl.viewport(t,e,i,s))},u.getViewport=function(){return{x:this._viewport.x,y:this._viewport.y,width:this._viewport.width,height:this._viewport.height}},u.useProgram=function(t){var e,i;this._activeShaderProgram!==t&&(null==(e=this._activeShaderProgram)||e.stop(),this._activeShaderProgram=t,this.gl.useProgram(null!=(i=null==t?void 0:t.glName)?i:null))},u.bindTexture=function(t,e,s=!1){(e>=this.parameters.maxTextureImageUnits||e<0)&&console.error("Input texture unit is out of range of available units!");const n=this._textureUnitMap[e];return i.isNone(t)||null==t.glName?(i.isSome(n)&&(this.setActiveTexture(e,s),this.gl.bindTexture(n.descriptor.target,null)),this._textureUnitMap[e]=null,n):s||n!==t?(this.setActiveTexture(e,s),this.gl.bindTexture(t.descriptor.target,t.glName),t.applyChanges(),this._textureUnitMap[e]=t,n):(t.isDirty&&(this.setActiveTexture(e,s),t.applyChanges()),n)},u.unbindTextureAllUnits=function(t){for(let e=0;e<this.parameters.maxTextureImageUnits;e++)this._textureUnitMap[e]===t&&(this.bindTexture(null,e),this._textureUnitMap[e]=null)},u.bindFramebuffer=function(t,e=!1,s=3553){if(i.isNone(t))return this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),void(this._activeFramebuffer=null);(e||this._activeFramebuffer!==t)&&(t.initializeAndBind(s),this._activeFramebuffer=t)},u.bindBuffer=function(t){t&&(34962===t.bufferType?this._activeVertexBuffer=_(this.gl,t,t.bufferType,this._activeVertexBuffer):this._activeIndexBuffer=_(this.gl,t,t.bufferType,this._activeIndexBuffer))},u.bindRenderbuffer=function(t){const e=this.gl;t||(e.bindRenderbuffer(e.RENDERBUFFER,null),this._activeRenderbuffer=null),this._activeRenderbuffer!==t&&(e.bindRenderbuffer(e.RENDERBUFFER,t.glName),this._activeRenderbuffer=t)},u.unbindBuffer=function(t){34962===t?this._activeVertexBuffer=_(this.gl,null,t,this._activeVertexBuffer):this._activeIndexBuffer=_(this.gl,null,t,this._activeIndexBuffer)},u.bindVAO=function(t=null){i.isNone(t)?this._activeVertexArrayObject&&(this._activeVertexArrayObject.unbind(),this._activeVertexArrayObject=null):this._activeVertexArrayObject!==t&&(t.bind(),this._activeVertexArrayObject=t)},u.getBoundFramebufferObject=function(){return this._activeFramebuffer},u.getBoundVAO=function(){return this._activeVertexArrayObject},u.resetState=function(){this.useProgram(null),this.bindVAO(null),this.bindFramebuffer(null),this.unbindBuffer(34962),this.unbindBuffer(34963);for(let t=0;t<this.parameters.maxTextureImageUnits;++t)this.bindTexture(null,t);this.setBlendingEnabled(!1),this.setBlendFunction(1,0),this.setBlendEquation(32774),this.setBlendColor(0,0,0,0),this.setFaceCullingEnabled(!1),this.setCullFace(1029),this.setFrontFace(2305),this.setPolygonOffsetFillEnabled(!1),this.setPolygonOffset(0,0),this.setScissorTestEnabled(!1),this.setScissorRect(0,0,this.gl.canvas.width,this.gl.canvas.height),this.setDepthTestEnabled(!1),this.setDepthFunction(513),this.setDepthRange(0,1),this.setStencilTestEnabled(!1),this.setStencilFunction(519,0,0),this.setStencilOp(7680,7680,7680),this.setClearColor(0,0,0,0),this.setClearDepth(1),this.setClearStencil(0),this.setColorMask(!0,!0,!0,!0),this.setStencilWriteMask(4294967295),this.setDepthWriteEnabled(!0),this.setViewport(0,0,this.gl.canvas.width,this.gl.canvas.height)},u.enforceState=function(){var t,e,a,l;const r=this.gl,h=this.capabilities.vao;h&&h.bindVertexArray(null);for(let i=0;i<this.parameters.maxVertexAttributes;i++)r.disableVertexAttribArray(i);if(this._activeVertexBuffer?r.bindBuffer(this._activeVertexBuffer.bufferType,this._activeVertexBuffer.glName):r.bindBuffer(34962,null),this._activeIndexBuffer?r.bindBuffer(this._activeIndexBuffer.bufferType,this._activeIndexBuffer.glName):r.bindBuffer(34963,null),h&&this._activeVertexArrayObject){const t=this._activeVertexArrayObject;this._activeVertexArrayObject&&(this._activeVertexArrayObject.unbind(),this._activeVertexArrayObject=null),this.bindVAO(t)}r.bindFramebuffer(r.FRAMEBUFFER,null!=(t=null==(e=this._activeFramebuffer)?void 0:e.glName)?t:null),r.useProgram(null!=(a=null==(l=this._activeShaderProgram)?void 0:l.glName)?a:null),r.blendColor(this._blendColorState.r,this._blendColorState.g,this._blendColorState.b,this._blendColorState.a),r.bindRenderbuffer(r.RENDERBUFFER,this._activeRenderbuffer?this._activeRenderbuffer.glName:null),!0===this._blendEnabled?r.enable(this.gl.BLEND):r.disable(this.gl.BLEND),r.blendEquationSeparate(this._blendEquationState.mode,this._blendEquationState.modeAlpha),r.blendFuncSeparate(this._blendFunctionState.srcRGB,this._blendFunctionState.dstRGB,this._blendFunctionState.srcAlpha,this._blendFunctionState.dstAlpha),r.clearColor(this._clearColor.r,this._clearColor.g,this._clearColor.b,this._clearColor.a),r.clearDepth(this._clearDepth),r.clearStencil(this._clearStencil),r.colorMask(this._colorMaskState.r,this._colorMaskState.g,this._colorMaskState.b,this._colorMaskState.a),r.cullFace(this._cullFace),r.depthFunc(this._depthFunction),r.depthRange(this._depthRange.zNear,this._depthRange.zFar),!0===this._depthTestEnabled?r.enable(r.DEPTH_TEST):r.disable(r.DEPTH_TEST),r.depthMask(this._depthWriteEnabled),r.frontFace(this._frontFace),r.lineWidth(1),!0===this._polygonCullingEnabled?r.enable(r.CULL_FACE):r.disable(r.CULL_FACE),r.polygonOffset(this._polygonOffset[0],this._polygonOffset[1]),!0===this._polygonOffsetFillEnabled?r.enable(r.POLYGON_OFFSET_FILL):r.disable(r.POLYGON_OFFSET_FILL),r.scissor(this._scissorRect.x,this._scissorRect.y,this._scissorRect.width,this._scissorRect.height),!0===this._scissorTestEnabled?r.enable(r.SCISSOR_TEST):r.disable(r.SCISSOR_TEST),r.stencilFunc(this._stencilFunction.func,this._stencilFunction.ref,this._stencilFunction.mask),r.stencilOpSeparate(this._stencilOperation.face,this._stencilOperation.fail,this._stencilOperation.zFail,this._stencilOperation.zPass),!0===this._stencilTestEnabled?r.enable(r.STENCIL_TEST):r.disable(r.STENCIL_TEST),r.stencilMask(this._stencilWriteMask);for(let s=0;s<this.parameters.maxTextureImageUnits;s++){r.activeTexture(n.BASE_TEXTURE_UNIT+s),r.bindTexture(3553,null),r.bindTexture(34067,null),c(r)&&r.bindTexture(32879,null);const t=this._textureUnitMap[s];i.isSome(t)&&r.bindTexture(t.descriptor.target,t.glName)}r.activeTexture(n.BASE_TEXTURE_UNIT+this._activeTextureUnit),r.viewport(this._viewport.x,this._viewport.y,this._viewport.width,this._viewport.height),s.webglDebugEnabled()&&(this._numOfDrawCalls=0,this._numOfTriangles=0)},u._loadParameters=function(t){var e;const i=this.capabilities.textureFilterAnisotropic,s=null!=(e=t.maxAnisotropy)?e:1/0,n={versionString:this.gl.getParameter(this.gl.VERSION),maxVertexTextureImageUnits:this.gl.getParameter(this.gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxVertexAttributes:this.gl.getParameter(this.gl.MAX_VERTEX_ATTRIBS),maxMaxAnisotropy:i?Math.min(this.gl.getParameter(i.MAX_TEXTURE_MAX_ANISOTROPY),s):1,maxTextureImageUnits:this.gl.getParameter(this.gl.MAX_TEXTURE_IMAGE_UNITS),maxTextureSize:this.gl.getParameter(this.gl.MAX_TEXTURE_SIZE)};return r.TEXTURE_UNIT_FOR_UPDATES=n.maxTextureImageUnits-1,n},e._createClass(t,[{key:"contextAttributes",get:function(){return this.gl.getContextAttributes()}},{key:"parameters",get:function(){return this._parameters}},{key:"capabilities",get:function(){return this._capabilities}}]),t}();function _(t,e,i,s){return e?s!==e&&t.bindBuffer(i,e.glName):t.bindBuffer(i,null),e}function d(t,e){switch(t){case 0:return 2*e;case 4:return e/3;case 5:case 6:return e-2;default:return 0}}t.RenderingContext=u,Object.defineProperty(t,"__esModule",{value:!0})}));
