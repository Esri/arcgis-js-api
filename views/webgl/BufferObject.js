/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../core/arrayUtils","../../core/Logger","../../core/maybe","../../core/typedArrayUtil","./checkWebGLError","./context-util","./enums"],(function(e,t,r,i,n,s,f,o,u){"use strict";const a=i.getLogger("esri.views.webgl.BufferObject");function c(e){return r.isArrayLike(e)}let h=function(){function e(e,t,r,i){this._context=e,this.bufferType=t,this.usage=r,this._glName=null,this._size=-1,this._indexType=void 0,e.instanceCounter.increment(u.ResourceType.Buffer,this),this._glName=this._context.gl.createBuffer(),f.checkWebGLError(this._context.gl),i&&this.setData(i)}e.createIndex=function(t,r,i){return new e(t,u.BufferType.ELEMENT_ARRAY_BUFFER,r,i)},e.createVertex=function(t,r,i){return new e(t,u.BufferType.ARRAY_BUFFER,r,i)},e.createUniform=function(t,r,i){if(t.type!==o.ContextType.WEBGL2)throw new Error("Uniform buffers are supported in WebGL2 only!");return new e(t,u.BufferType.UNIFORM_BUFFER,r,i)},e.createPixelPack=function(t,r=u.Usage.STREAM_READ,i){if(t.type!==o.ContextType.WEBGL2)throw new Error("Pixel pack buffers are supported in WebGL2 only!");const n=new e(t,u.BufferType.PIXEL_PACK_BUFFER,r);return i&&n.setSize(i),n},e.createPixelUnpack=function(t,r=u.Usage.STREAM_DRAW,i){if(t.type!==o.ContextType.WEBGL2)throw new Error("Pixel unpack buffers are supported in WebGL2 only!");return new e(t,u.BufferType.PIXEL_UNPACK_BUFFER,r,i)};var r=e.prototype;return r.dispose=function(){var e;if(null!=(e=this._context)&&e.gl){if(this._glName){this._context.gl.deleteBuffer(this._glName),this._glName=null}this._context.instanceCounter.decrement(u.ResourceType.Buffer,this),this._context=null}else this._glName&&a.warn("Leaked WebGL buffer object")},r.setSize=function(e,t=null){if(e<=0&&a.error("Buffer size needs to be positive!"),this.bufferType===u.BufferType.ELEMENT_ARRAY_BUFFER&&n.isSome(t))switch(this._indexType=t,t){case u.DataType.UNSIGNED_SHORT:e*=2;break;case u.DataType.UNSIGNED_INT:e*=4}this._setBufferData(e)},r.setData=function(e){if(!e)return;let t=e.byteLength;this.bufferType===u.BufferType.ELEMENT_ARRAY_BUFFER&&(s.isUint16Array(e)&&(t/=2,this._indexType=u.DataType.UNSIGNED_SHORT),s.isUint32Array(e)&&(t/=4,this._indexType=u.DataType.UNSIGNED_INT)),this._setBufferData(t,e)},r._setBufferData=function(e,t=null){this._size=e;const r=this._context.getBoundVAO();this._isVAOAware&&this._context.bindVAO(null),this._context.bindBuffer(this);const i=this._context.gl;n.isSome(t)?i.bufferData(this.bufferType,t,this.usage):i.bufferData(this.bufferType,e,this.usage),f.checkWebGLError(i),this._isVAOAware&&this._context.bindVAO(r)},r.setSubData=function(e,t=0,r=0,i=e.byteLength){if(!e)return;(t<0||t>=this._size)&&a.error("offset is out of range!");let n=t,o=r,c=i,h=e.byteLength;this.bufferType===u.BufferType.ELEMENT_ARRAY_BUFFER&&(s.isUint16Array(e)?(h/=2,n*=2,o*=2,c*=2):s.isUint32Array(e)&&(h/=4,n*=4,o*=4,c*=4)),void 0===i&&(i=h-1),r>=i&&a.error("end must be bigger than start!"),t+r-i>this._size&&a.error("An attempt to write beyond the end of the buffer!");const _=this._context.getBoundVAO();this._isVAOAware&&this._context.bindVAO(null),this._context.bindBuffer(this);const b=this._context.gl,y=ArrayBuffer.isView(e)?e.buffer:e,l=0===o&&c===e.byteLength?y:y.slice(o,c);b.bufferSubData(this.bufferType,n,l),f.checkWebGLError(b),this._isVAOAware&&this._context.bindVAO(_)},r.setSubDataFromView=function(e,t,r,i){if(!e)return;(t<0||t>=this._size)&&a.error("offset is out of range!"),r>=i&&a.error("end must be bigger than start!"),t+r-i>this._size&&a.error("An attempt to write beyond the end of the buffer!");const n=this._context.getBoundVAO();this._isVAOAware&&this._context.bindVAO(null),this._context.bindBuffer(this);const s=this._context.gl;if(this._context.type===o.ContextType.WEBGL2)s.bufferSubData(this.bufferType,t*e.BYTES_PER_ELEMENT,e,r,i-r);else{const n=0===r&&i===e.length?e:e.subarray(r,i);s.bufferSubData(this.bufferType,t*e.BYTES_PER_ELEMENT,n)}f.checkWebGLError(s),this._isVAOAware&&this._context.bindVAO(n)},r.getSubData=function(e,t=0,r,i){if(this._context.type!==o.ContextType.WEBGL2)return void a.error("Get buffer subdata is supported in WebGL2 only!");if(r<0||i<0)return void a.error("Problem getting subdata: offset and length were less than zero!");const n=c(e)?e.BYTES_PER_ELEMENT:1;if(n*((null!=r?r:0)+(null!=i?i:0))>e.byteLength)return void a.error("Problem getting subdata: offset and length exceeded destination size!");t+n*(null!=i?i:0)>this.byteSize&&a.warn("Potential problem getting subdata: requested data exceeds buffer size!");const s=this._context.gl;this._context.bindBuffer(this,u.BufferType.COPY_READ_BUFFER),s.getBufferSubData(u.BufferType.COPY_READ_BUFFER,t,e,r,i),this._context.unbindBuffer(u.BufferType.COPY_READ_BUFFER)},r.getSubDataAsync=function(){var e=t._asyncToGenerator((function*(e,t=0,r,i){this._context.type===o.ContextType.WEBGL2?(yield this._context.clientWaitAsync(),this.getSubData(e,t,r,i)):a.error("Get buffer subdata is supported in WebGL2 only!")}));function r(t){return e.apply(this,arguments)}return r}(),t._createClass(e,[{key:"glName",get:function(){return this._glName}},{key:"size",get:function(){return this._size}},{key:"indexType",get:function(){return this._indexType}},{key:"byteSize",get:function(){return this.bufferType===u.BufferType.ELEMENT_ARRAY_BUFFER?this._indexType===u.DataType.UNSIGNED_INT?4*this._size:2*this._size:this._size}},{key:"_isVAOAware",get:function(){return this.bufferType===u.BufferType.ELEMENT_ARRAY_BUFFER||this.bufferType===u.BufferType.ARRAY_BUFFER}}]),e}();e.BufferObject=h,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
