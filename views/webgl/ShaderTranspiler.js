/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../core/has","../../core/maybe","./enums","./reservedWordsGLSL3","./testUtils","../../chunks/builtins"],(function(t,e,a,r,n,o,i){"use strict";var s=999,c=9999,d=0,p=1,u=2,f=3,l=4,h=5,y=6,g=7,w=8,b=9,k=10,m=11,E=["block-comment","line-comment","preprocessor","operator","integer","float","ident","builtin","keyword","whitespace","eof","integer"];function _(){var t,e,a,r=0,n=0,o=s,_=[],v=[],T=1,S=0,j=0,x=!1,D=!1,R="";return function(t){return v=[],null!==t?G(t.replace?t.replace(/\r\n/g,"\n"):t):X()};function A(t){t.length&&v.push({type:E[o],data:t,position:j,line:T,column:S})}function G(e){var i;for(r=0,a=(R+=e).length;t=R[r],r<a;){switch(i=r,o){case d:r=H();break;case p:r=C();break;case u:r=M();break;case f:r=P();break;case l:r=N();break;case m:r=V();break;case h:r=$();break;case c:r=z();break;case b:r=L();break;case s:r=F()}if(i!==r)if("\n"===R[i])S=0,++T;else++S}return n+=r,R=R.slice(r),v}function X(t){return _.length&&A(_.join("")),o=k,A("(eof)"),v}function F(){return _=_.length?[]:_,"/"===e&&"*"===t?(j=n+r-1,o=d,e=t,r+1):"/"===e&&"/"===t?(j=n+r-1,o=p,e=t,r+1):"#"===t?(o=u,j=n+r,r):/\s/.test(t)?(o=b,j=n+r,r):(x=/\d/.test(t),D=/[^\w_]/.test(t),j=n+r,o=x?l:D?f:c,r)}function L(){return/[^\s]/g.test(t)?(A(_.join("")),o=s,r):(_.push(t),e=t,r+1)}function M(){return"\r"!==t&&"\n"!==t||"\\"===e?(_.push(t),e=t,r+1):(A(_.join("")),o=s,r)}function C(){return M()}function H(){return"/"===t&&"*"===e?(_.push(t),A(_.join("")),o=s,r+1):(_.push(t),e=t,r+1)}function P(){if("."===e&&/\d/.test(t))return o=h,r;if("/"===e&&"*"===t)return o=d,r;if("/"===e&&"/"===t)return o=p,r;if("."===t&&_.length){for(;O(_););return o=h,r}if(";"===t||")"===t||"("===t){if(_.length)for(;O(_););return A(t),o=s,r+1}var a=2===_.length&&"="!==t;if(/[\w_\d\s]/.test(t)||a){for(;O(_););return o=s,r}return _.push(t),e=t,r+1}function O(t){for(var e,a,r=0;;){if(e=i.operators.indexOf(t.slice(0,t.length+r).join("")),a=i.operators[e],-1===e){if(r--+t.length>0)continue;a=t.slice(0,1).join("")}return A(a),j+=a.length,(_=_.slice(a.length)).length}}function V(){return/[^a-fA-F0-9]/.test(t)?(A(_.join("")),o=s,r):(_.push(t),e=t,r+1)}function N(){return"."===t||/[eE]/.test(t)?(_.push(t),o=h,e=t,r+1):"x"===t&&1===_.length&&"0"===_[0]?(o=m,_.push(t),e=t,r+1):/[^\d]/.test(t)?(A(_.join("")),o=s,r):(_.push(t),e=t,r+1)}function $(){return"f"===t&&(_.push(t),e=t,r+=1),/[eE]/.test(t)||"-"===t&&/[eE]/.test(e)?(_.push(t),e=t,r+1):/[^\d]/.test(t)?(A(_.join("")),o=s,r):(_.push(t),e=t,r+1)}function z(){if(/[^\d\w_]/.test(t)){var a=_.join("");return o=i.literals.indexOf(a)>-1?w:i.builtins.indexOf(a)>-1?g:y,A(_.join("")),o=s,r}return _.push(t),e=t,r+1}}function v(t){var e=_(),a=[];return a=(a=a.concat(e(t))).concat(e(null))}function T(t){return v(t)}function S(t){return t.map((t=>"eof"!==t.type?t.data:"")).join("")}const j=["GL_OES_standard_derivatives","GL_EXT_frag_depth","GL_EXT_draw_buffers","GL_EXT_shader_texture_lod"];function x(t,e="100",a="300 es"){const r=/^\s*\#version\s+([0-9]+(\s+[a-zA-Z]+)?)\s*/;for(const n of t)if("preprocessor"===n.type){const t=r.exec(n.data);if(t){const r=t[1].replace(/\s\s+/g," ");if(r===a)return r;if(r===e)return n.data="#version "+a,e;throw new Error("unknown glsl version: "+r)}}return t.splice(0,0,{type:"preprocessor",data:"#version "+a},{type:"whitespace",data:"\n"}),null}function D(t,e){for(let a=e-1;a>=0;a--){const e=t[a];if("whitespace"!==e.type&&"block-comment"!==e.type){if("keyword"!==e.type)break;if("attribute"===e.data||"in"===e.data)return!0}}return!1}function R(t,e,a,r){r=r||a;for(const n of t)if("ident"===n.type&&n.data===a){r in e?e[r]++:e[r]=0;return R(t,e,r+"_"+e[r],r)}return a}function A(t,e,a="afterVersion"){function r(t,e){for(let a=e;a<t.length;a++){const e=t[a];if("operator"===e.type&&";"===e.data)return a}return null}function n(t){let e=-1,n=0,o=-1;for(let i=0;i<t.length;i++){const s=t[i];if("preprocessor"===s.type&&(s.data.match(/\#(if|ifdef|ifndef)\s+.+/)?++n:s.data.match(/\#endif\s*.*/)&&--n),"afterVersion"!==a&&"afterPrecision"!==a||"preprocessor"===s.type&&/^#version/.test(s.data)&&(o=Math.max(o,i)),"afterPrecision"===a&&"keyword"===s.type&&"precision"===s.data){const e=r(t,i);if(null===e)throw new Error("precision statement not followed by any semicolons!");o=Math.max(o,e)}e<o&&0===n&&(e=i)}return e+1}const o={data:"\n",type:"whitespace"},i=e=>e<t.length&&/[^\r\n]$/.test(t[e].data);let s=n(t);i(s-1)&&t.splice(s++,0,o);for(const c of e)t.splice(s++,0,c);i(s-1)&&i(s)&&t.splice(s,0,o)}function G(t,e,a,r="lowp"){A(t,[{type:"keyword",data:"out"},{type:"whitespace",data:" "},{type:"keyword",data:r},{type:"whitespace",data:" "},{type:"keyword",data:a},{type:"whitespace",data:" "},{type:"ident",data:e},{type:"operator",data:";"}],"afterPrecision")}function X(t,e,a,r,n="lowp"){A(t,[{type:"keyword",data:"layout"},{type:"operator",data:"("},{type:"keyword",data:"location"},{type:"whitespace",data:" "},{type:"operator",data:"="},{type:"whitespace",data:" "},{type:"integer",data:r.toString()},{type:"operator",data:")"},{type:"whitespace",data:" "},{type:"keyword",data:"out"},{type:"whitespace",data:" "},{type:"keyword",data:n},{type:"whitespace",data:" "},{type:"keyword",data:a},{type:"whitespace",data:" "},{type:"ident",data:e},{type:"operator",data:";"}],"afterPrecision")}function F(t,e){let a,r,n=-1;for(let o=e;o<t.length;o++){const e=t[o];if("operator"===e.type&&("["===e.data&&(a=o),"]"===e.data)){r=o;break}"integer"===e.type&&(n=parseInt(e.data,10))}return a&&r&&t.splice(a,r-a+1),n}function L(t,e){const o=C(t);if(a.isSome(o))return o;const i=T(t);if("300 es"===x(i,"100","300 es"))return t;let s=null,c=null;const d={},p={};for(let a=0;a<i.length;++a){const t=i[a];switch(t.type){case"keyword":e===r.ShaderType.VERTEX_SHADER&&"attribute"===t.data?t.data="in":"varying"===t.data&&(t.data=e===r.ShaderType.VERTEX_SHADER?"out":"in");break;case"builtin":if(/^texture(2D|Cube)(Proj)?(Lod|Grad)?(EXT)?$/.test(t.data.trim())&&(t.data=t.data.replace(/(2D|Cube|EXT)/g,"")),e===r.ShaderType.FRAGMENT_SHADER&&"gl_FragColor"===t.data&&(s||(s=R(i,d,"fragColor"),G(i,s,"vec4")),t.data=s),e===r.ShaderType.FRAGMENT_SHADER&&"gl_FragData"===t.data){const e=F(i,a+1),r=R(i,d,"fragData");X(i,r,"vec4",e,"mediump"),t.data=r}else e===r.ShaderType.FRAGMENT_SHADER&&"gl_FragDepthEXT"===t.data&&(c||(c=R(i,d,"gl_FragDepth")),t.data=c);break;case"ident":if(n.includes(t.data)){if(e===r.ShaderType.VERTEX_SHADER&&D(i,a))throw new Error("attribute in vertex shader uses a name that is a reserved word in glsl 300 es");t.data in p||(p[t.data]=R(i,d,t.data)),t.data=p[t.data]}}}for(let a=i.length-1;a>=0;--a){const t=i[a];if("preprocessor"===t.type){const e=t.data.match(/\#extension\s+(.*)\:/);if(e&&e[1]&&j.includes(e[1].trim())){const t=i[a+1];i.splice(a,t&&"whitespace"===t.type?2:1)}const r=t.data.match(/\#ifdef\s+(.*)/);r&&r[1]&&j.includes(r[1].trim())&&(t.data="#if 1");const n=t.data.match(/\#ifndef\s+(.*)/);n&&n[1]&&j.includes(n[1].trim())&&(t.data="#if 0")}}return H(t,S(i))}const M=new Map;function C(t){return o.shaderTranspiler.enableCache?M.get(t):null}function H(t,e){return o.shaderTranspiler.enableCache&&M.set(t,e),e}t.transpileShader=L,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
