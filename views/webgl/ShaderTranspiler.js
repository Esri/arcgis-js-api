/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../core/has","../../core/maybe","./enums","./reservedWordsGLSL3","./testUtils","../../chunks/builtins"],(function(e,t,a,r,n,o,i){"use strict";var s=999,c=9999,d=0,p=1,u=2,f=3,l=4,h=5,y=6,g=7,w=8,b=9,k=10,_=11,m=["block-comment","line-comment","preprocessor","operator","integer","float","ident","builtin","keyword","whitespace","eof","integer"];function E(){var e,t,a,r=0,n=0,o=s,E=[],v=[],T=1,S=0,j=0,x=!1,D=!1,R="";return function(e){return v=[],null!==e?G(e.replace?e.replace(/\r\n/g,"\n"):e):X()};function A(e){e.length&&v.push({type:m[o],data:e,position:j,line:T,column:S})}function G(t){var i;for(r=0,a=(R+=t).length;e=R[r],r<a;){switch(i=r,o){case d:r=H();break;case p:r=C();break;case u:r=L();break;case f:r=P();break;case l:r=N();break;case _:r=V();break;case h:r=$();break;case c:r=z();break;case b:r=M();break;case s:r=F()}if(i!==r)if("\n"===R[i])S=0,++T;else++S}return n+=r,R=R.slice(r),v}function X(e){return E.length&&A(E.join("")),o=k,A("(eof)"),v}function F(){return E=E.length?[]:E,"/"===t&&"*"===e?(j=n+r-1,o=d,t=e,r+1):"/"===t&&"/"===e?(j=n+r-1,o=p,t=e,r+1):"#"===e?(o=u,j=n+r,r):/\s/.test(e)?(o=b,j=n+r,r):(x=/\d/.test(e),D=/[^\w_]/.test(e),j=n+r,o=x?l:D?f:c,r)}function M(){return/[^\s]/g.test(e)?(A(E.join("")),o=s,r):(E.push(e),t=e,r+1)}function L(){return"\r"!==e&&"\n"!==e||"\\"===t?(E.push(e),t=e,r+1):(A(E.join("")),o=s,r)}function C(){return L()}function H(){return"/"===e&&"*"===t?(E.push(e),A(E.join("")),o=s,r+1):(E.push(e),t=e,r+1)}function P(){if("."===t&&/\d/.test(e))return o=h,r;if("/"===t&&"*"===e)return o=d,r;if("/"===t&&"/"===e)return o=p,r;if("."===e&&E.length){for(;O(E););return o=h,r}if(";"===e||")"===e||"("===e){if(E.length)for(;O(E););return A(e),o=s,r+1}var a=2===E.length&&"="!==e;if(/[\w_\d\s]/.test(e)||a){for(;O(E););return o=s,r}return E.push(e),t=e,r+1}function O(e){for(var t,a,r=0;;){if(t=i.operators.indexOf(e.slice(0,e.length+r).join("")),a=i.operators[t],-1===t){if(r--+e.length>0)continue;a=e.slice(0,1).join("")}return A(a),j+=a.length,(E=E.slice(a.length)).length}}function V(){return/[^a-fA-F0-9]/.test(e)?(A(E.join("")),o=s,r):(E.push(e),t=e,r+1)}function N(){return"."===e||/[eE]/.test(e)?(E.push(e),o=h,t=e,r+1):"x"===e&&1===E.length&&"0"===E[0]?(o=_,E.push(e),t=e,r+1):/[^\d]/.test(e)?(A(E.join("")),o=s,r):(E.push(e),t=e,r+1)}function $(){return"f"===e&&(E.push(e),t=e,r+=1),/[eE]/.test(e)||"-"===e&&/[eE]/.test(t)?(E.push(e),t=e,r+1):/[^\d]/.test(e)?(A(E.join("")),o=s,r):(E.push(e),t=e,r+1)}function z(){if(/[^\d\w_]/.test(e)){var a=E.join("");return o=i.literals.indexOf(a)>-1?w:i.builtins.indexOf(a)>-1?g:y,A(E.join("")),o=s,r}return E.push(e),t=e,r+1}}function v(e){var t=E(),a=[];return a=(a=a.concat(t(e))).concat(t(null))}function T(e){return v(e)}function S(e){return e.map((e=>"eof"!==e.type?e.data:"")).join("")}const j=["GL_OES_standard_derivatives","GL_EXT_frag_depth","GL_EXT_draw_buffers","GL_EXT_shader_texture_lod"];function x(e,t="100",a="300 es"){const r=/^\s*\#version\s+([0-9]+(\s+[a-zA-Z]+)?)\s*/;for(const n of e)if("preprocessor"===n.type){const e=r.exec(n.data);if(e){const r=e[1].replace(/\s\s+/g," ");if(r===a)return r;if(r===t)return n.data="#version "+a,t;throw new Error("unknown glsl version: "+r)}}return e.splice(0,0,{type:"preprocessor",data:"#version "+a},{type:"whitespace",data:"\n"}),null}function D(e,t){for(let a=t-1;a>=0;a--){const t=e[a];if("whitespace"!==t.type&&"block-comment"!==t.type){if("keyword"!==t.type)break;if("attribute"===t.data||"in"===t.data)return!0}}return!1}function R(e,t,a,r){r=r||a;for(const n of e)if("ident"===n.type&&n.data===a){r in t?t[r]++:t[r]=0;return R(e,t,r+"_"+t[r],r)}return a}function A(e,t,a="afterVersion"){function r(e,t){for(let a=t;a<e.length;a++){const t=e[a];if("operator"===t.type&&";"===t.data)return a}return null}function n(e){let t=-1,n=0,o=-1;for(let i=0;i<e.length;i++){const s=e[i];if("preprocessor"===s.type&&(s.data.match(/\#(if|ifdef|ifndef)\s+.+/)?++n:s.data.match(/\#endif\s*.*/)&&--n),"afterVersion"!==a&&"afterPrecision"!==a||"preprocessor"===s.type&&/^#version/.test(s.data)&&(o=Math.max(o,i)),"afterPrecision"===a&&"keyword"===s.type&&"precision"===s.data){const t=r(e,i);if(null===t)throw new Error("precision statement not followed by any semicolons!");o=Math.max(o,t)}t<o&&0===n&&(t=i)}return t+1}const o={data:"\n",type:"whitespace"},i=t=>t<e.length&&/[^\r\n]$/.test(e[t].data);let s=n(e);i(s-1)&&e.splice(s++,0,o);for(const c of t)e.splice(s++,0,c);i(s-1)&&i(s)&&e.splice(s,0,o)}function G(e,t,a,r="lowp"){A(e,[{type:"keyword",data:"out"},{type:"whitespace",data:" "},{type:"keyword",data:r},{type:"whitespace",data:" "},{type:"keyword",data:a},{type:"whitespace",data:" "},{type:"ident",data:t},{type:"operator",data:";"}],"afterPrecision")}function X(e,t,a,r,n="lowp"){A(e,[{type:"keyword",data:"layout"},{type:"operator",data:"("},{type:"keyword",data:"location"},{type:"whitespace",data:" "},{type:"operator",data:"="},{type:"whitespace",data:" "},{type:"integer",data:r.toString()},{type:"operator",data:")"},{type:"whitespace",data:" "},{type:"keyword",data:"out"},{type:"whitespace",data:" "},{type:"keyword",data:n},{type:"whitespace",data:" "},{type:"keyword",data:a},{type:"whitespace",data:" "},{type:"ident",data:t},{type:"operator",data:";"}],"afterPrecision")}function F(e,t){let a,r,n=-1;for(let o=t;o<e.length;o++){const t=e[o];if("operator"===t.type&&("["===t.data&&(a=o),"]"===t.data)){r=o;break}"integer"===t.type&&(n=parseInt(t.data,10))}return a&&r&&e.splice(a,r-a+1),n}function M(e,t){const o=C(e);if(a.isSome(o))return o;const i=T(e);if("300 es"===x(i,"100","300 es"))return e;let s=null,c=null;const d={},p={};for(let a=0;a<i.length;++a){const e=i[a];switch(e.type){case"keyword":t===r.ShaderType.VERTEX_SHADER&&"attribute"===e.data?e.data="in":"varying"===e.data&&(e.data=t===r.ShaderType.VERTEX_SHADER?"out":"in");break;case"builtin":if(/^texture(2D|Cube)(Proj)?(Lod|Grad)?(EXT)?$/.test(e.data.trim())&&(e.data=e.data.replace(/(2D|Cube|EXT)/g,"")),t===r.ShaderType.FRAGMENT_SHADER&&"gl_FragColor"===e.data&&(s||(s=R(i,d,"fragColor"),G(i,s,"vec4")),e.data=s),t===r.ShaderType.FRAGMENT_SHADER&&"gl_FragData"===e.data){const t=F(i,a+1),r=R(i,d,"fragData");X(i,r,"vec4",t,"mediump"),e.data=r}else t===r.ShaderType.FRAGMENT_SHADER&&"gl_FragDepthEXT"===e.data&&(c||(c=R(i,d,"gl_FragDepth")),e.data=c);break;case"ident":if(n.includes(e.data)){if(t===r.ShaderType.VERTEX_SHADER&&D(i,a))throw new Error("attribute in vertex shader uses a name that is a reserved word in glsl 300 es");e.data in p||(p[e.data]=R(i,d,e.data)),e.data=p[e.data]}}}for(let a=i.length-1;a>=0;--a){const e=i[a];if("preprocessor"===e.type){const t=e.data.match(/\#extension\s+(.*)\:/);if(t&&t[1]&&j.includes(t[1].trim())){const e=i[a+1];i.splice(a,e&&"whitespace"===e.type?2:1)}const r=e.data.match(/\#ifdef\s+(.*)/);r&&r[1]&&j.includes(r[1].trim())&&(e.data="#if 1");const n=e.data.match(/\#ifndef\s+(.*)/);n&&n[1]&&j.includes(n[1].trim())&&(e.data="#if 0")}}return H(e,S(i))}const L=new Map;function C(e){return o.shaderTranspiler.enableCache?L.get(e):null}function H(e,t){return o.shaderTranspiler.enableCache&&L.set(e,t),t}e.transpileShader=M,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
