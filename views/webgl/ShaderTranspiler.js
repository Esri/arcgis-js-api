// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","./reservedWordsGLSL3","./lib/glsl-tokenizer/string"],(function(e,t,a,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.transpileShader=void 0;var i=["GL_OES_standard_derivatives","GL_EXT_frag_depth","GL_EXT_draw_buffers","GL_EXT_shader_texture_lod"];function n(e,t){for(var a=t-1;a>=0;a--){var r=e[a];if("whitespace"!==r.type&&"block-comment"!==r.type){if("keyword"!==r.type)break;if("attribute"===r.data||"in"===r.data)return!0}}return!1}function d(e,t,a,r){r=r||a;for(var i=0,n=e;i<n.length;i++){var o=n[i];if("ident"===o.type&&o.data===a)return r in t?t[r]++:t[r]=0,d(e,t,r+"_"+t[r],r)}return a}function o(e,t,a){function r(e,t){for(var a=t;a<e.length;a++){var r=e[a];if("operator"===r.type&&";"===r.data)return a}return null}void 0===a&&(a="afterVersion");var i={data:"\n",type:"whitespace"},n=function(t){return t<e.length&&/[^\r\n]$/.test(e[t].data)},d=function(e){for(var t=-1,i=0,n=-1,d=0;d<e.length;d++){var o=e[d];if("preprocessor"===o.type&&(o.data.match(/\#(if|ifdef|ifndef)\s+.+/)?++i:o.data.match(/\#endif\s*.*/)&&--i),"afterVersion"!==a&&"afterPrecision"!==a||"preprocessor"===o.type&&/^#version/.test(o.data)&&(n=Math.max(n,d)),"afterPrecision"===a&&"keyword"===o.type&&"precision"===o.data){var p=r(e,d);if(null===p)throw new Error("precision statement not followed by any semicolons!");n=Math.max(n,p)}t<n&&0===i&&(t=d)}return t+1}(e);n(d-1)&&e.splice(d++,0,i);for(var o=0,p=t;o<p.length;o++){var s=p[o];e.splice(d++,0,s)}n(d-1)&&n(d)&&e.splice(d,0,i)}function p(e,t,a,r){void 0===r&&(r="lowp"),o(e,[{type:"keyword",data:"out"},{type:"whitespace",data:" "},{type:"keyword",data:r},{type:"whitespace",data:" "},{type:"keyword",data:a},{type:"whitespace",data:" "},{type:"ident",data:t},{type:"operator",data:";"}],"afterPrecision")}function s(e,t,a,r,i){void 0===i&&(i="lowp"),o(e,[{type:"keyword",data:"layout"},{type:"operator",data:"("},{type:"keyword",data:"location"},{type:"whitespace",data:" "},{type:"operator",data:"="},{type:"whitespace",data:" "},{type:"integer",data:r.toString()},{type:"operator",data:")"},{type:"whitespace",data:" "},{type:"keyword",data:"out"},{type:"whitespace",data:" "},{type:"keyword",data:i},{type:"whitespace",data:" "},{type:"keyword",data:a},{type:"whitespace",data:" "},{type:"ident",data:t},{type:"operator",data:";"}],"afterPrecision")}function f(e,t){for(var a,r,i=-1,n=t;n<e.length;n++){var d=e[n];if("operator"===d.type&&("["===d.data&&(a=n),"]"===d.data)){r=n;break}"integer"===d.type&&(i=parseInt(d.data,10))}return a&&r&&e.splice(a,r-a+1),i}t.transpileShader=function(e,t){var o=function(e){return r(e)}(e);if("300 es"===function(e,t,a){void 0===t&&(t="100"),void 0===a&&(a="300 es");for(var r=/^\s*\#version\s+([0-9]+(\s+[a-zA-Z]+)?)\s*/,i=0,n=e;i<n.length;i++){var d=n[i];if("preprocessor"===d.type){var o=r.exec(d.data);if(o){var p=o[1].replace(/\s\s+/g," ");if(p===a)return p;if(p===t)return d.data="#version "+a,t;throw new Error("unknown glsl version: "+p)}}}return e.splice(0,0,{type:"preprocessor",data:"#version "+a},{type:"whitespace",data:"\n"}),null}(o,"100","300 es"))throw new Error("shader is already glsl 300 es");for(var c=null,y=null,l={},u={},v=0;v<o.length;++v){switch((g=o[v]).type){case"keyword":"vertex"===t&&"attribute"===g.data?g.data="in":"varying"===g.data&&(g.data="vertex"===t?"out":"in");break;case"builtin":if(/^texture(2D|Cube)(Proj)?(Lod|Grad)?(EXT)?$/.test(g.data.trim())&&(g.data=g.data.replace(/(2D|Cube|EXT)/g,"")),"fragment"===t&&"gl_FragColor"===g.data&&(c||p(o,c=d(o,l,"fragColor"),"vec4"),g.data=c),"fragment"===t&&"gl_FragData"===g.data){var h=f(o,v+1),w=d(o,l,"fragData");s(o,w,"vec4",h,"mediump"),g.data=w}else"fragment"===t&&"gl_FragDepthEXT"===g.data&&(y||(y=d(o,l,"gl_FragDepth")),g.data=y);break;case"ident":if(a.indexOf(g.data)>=0){if("vertex"===t&&n(o,v))throw new Error("attribute in vertex shader uses a name that is a reserved word in glsl 300 es");g.data in u||(u[g.data]=d(o,l,g.data)),g.data=u[g.data]}}}for(v=o.length-1;v>=0;--v){var g;if("preprocessor"===(g=o[v]).type){var m=g.data.match(/\#extension\s+(.*)\:/);if(m&&m[1]&&i.indexOf(m[1].trim())>=0){var _=o[v+1];o.splice(v,_&&"whitespace"===_.type?2:1)}var k=g.data.match(/\#ifdef\s+(.*)/);k&&k[1]&&i.indexOf(k[1].trim())>=0&&(g.data="#if 1");var b=g.data.match(/\#ifndef\s+(.*)/);b&&b[1]&&i.indexOf(b[1].trim())>=0&&(g.data="#if 0")}}return function(e){return e.map((function(e){return"eof"!==e.type?e.data:""})).join("")}(o)}}));