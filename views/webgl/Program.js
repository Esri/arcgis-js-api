/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../core/has","../../core/maybe","./checkWebGLError","./context-util","./enums","./ShaderTranspiler"],(function(t,o,i,n,e,r,s,a){"use strict";const f=4294967295;let h=function(){function t(t,o,i,n,f=new Map){this._context=t,this._locations=n,this._uniformBlockBindings=f,this._refCount=1,this._compiled=!1,this._nameToUniformLocation={},this._nameToUniform1={},this._nameToUniform1v={},this._nameToUniform2={},this._nameToUniform3={},this._nameToUniform4={},this._nameToUniformMatrix3={},this._nameToUniformMatrix4={},t||console.error("RenderingContext isn't initialized!"),0===o.length&&console.error("Shaders source should not be empty!"),this._context.type===r.ContextType.WEBGL2&&(o=a.transpileShader(o,s.ShaderType.VERTEX_SHADER),i=a.transpileShader(i,s.ShaderType.FRAGMENT_SHADER)),this._vShader=c(this._context,s.ShaderType.VERTEX_SHADER,o),this._fShader=c(this._context,s.ShaderType.FRAGMENT_SHADER,i),this._vShader&&this._fShader||console.error("Error loading shaders!"),this._context.instanceCounter.increment(s.ResourceType.Shader,this),e.webglValidateShadersEnabled()&&(this.vertexShader=o,this.fragmentShader=i)}var i=t.prototype;return i.dispose=function(){if(--this._refCount>0)return;const t=this._context.gl;this._vShader&&(t.deleteShader(this._vShader),this._vShader=null,this._context.instanceCounter.decrement(s.ResourceType.Shader,this)),this._fShader&&(t.deleteShader(this._fShader),this._fShader=null),this._glName&&(t.deleteProgram(this._glName),this._glName=null,this._context.instanceCounter.decrement(s.ResourceType.Program,this))},i.ref=function(){++this._refCount},i._getUniformLocation=function(t){return void 0===this._nameToUniformLocation[t]&&(this._nameToUniformLocation[t]=this._context.gl.getUniformLocation(this.glName,t)),this._nameToUniformLocation[t]},i.hasUniform=function(t){return null!==this._getUniformLocation(t)},i.setUniform1i=function(t,o){const i=this._nameToUniform1[t];if(void 0===i||o!==i){this._context.gl.uniform1i(this._getUniformLocation(t),o),this._nameToUniform1[t]=o}},i.setUniform1iv=function(t,o){const i=this._nameToUniform1v[t];if(m(i,o)){this._context.gl.uniform1iv(this._getUniformLocation(t),o),void 0===i?this._nameToUniform1v[t]=Array.from(o):g(o,i)}},i.setUniform2iv=function(t,o){const i=this._nameToUniform2[t];if(m(i,o)){this._context.gl.uniform2iv(this._getUniformLocation(t),o),void 0===i?this._nameToUniform2[t]=Array.from(o):g(o,i)}},i.setUniform3iv=function(t,o){const i=this._nameToUniform3[t];if(m(i,o)){this._context.gl.uniform3iv(this._getUniformLocation(t),o),void 0===i?this._nameToUniform3[t]=Array.from(o):g(o,i)}},i.setUniform4iv=function(t,o){const i=this._nameToUniform4[t];if(m(i,o)){this._context.gl.uniform4iv(this._getUniformLocation(t),o),void 0===i?this._nameToUniform4[t]=Array.from(o):g(o,i)}},i.setUniform1f=function(t,o){const i=this._nameToUniform1[t];if(void 0===i||o!==i){this._context.gl.uniform1f(this._getUniformLocation(t),o),this._nameToUniform1[t]=o}},i.setUniform1fv=function(t,o){const i=this._nameToUniform1v[t];if(m(i,o)){this._context.gl.uniform1fv(this._getUniformLocation(t),o),void 0===i?this._nameToUniform1v[t]=Array.from(o):g(o,i)}},i.setUniform2f=function(t,o,i){const n=this._nameToUniform2[t];if(void 0===n||o!==n[0]||i!==n[1]){this._context.gl.uniform2f(this._getUniformLocation(t),o,i),void 0===n?this._nameToUniform2[t]=[o,i]:(n[0]=o,n[1]=i)}},i.setUniform2fv=function(t,o){const i=this._nameToUniform2[t];if(m(i,o)){this._context.gl.uniform2fv(this._getUniformLocation(t),o),void 0===i?this._nameToUniform2[t]=Array.from(o):g(o,i)}},i.setUniform3f=function(t,o,i,n){const e=this._nameToUniform3[t];if(void 0===e||o!==e[0]||i!==e[1]||n!==e[2]){this._context.gl.uniform3f(this._getUniformLocation(t),o,i,n),void 0===e?this._nameToUniform3[t]=[o,i,n]:(e[0]=o,e[1]=i,e[2]=n)}},i.setUniform3fv=function(t,o){const i=this._nameToUniform3[t];if(m(i,o)){this._context.gl.uniform3fv(this._getUniformLocation(t),o),void 0===i?this._nameToUniform3[t]=Array.from(o):g(o,i)}},i.setUniform4f=function(t,o,i,n,e){const r=this._nameToUniform4[t];if(void 0===r||o!==r[0]||i!==r[1]||n!==r[2]||e!==r[3]){this._context.gl.uniform4f(this._getUniformLocation(t),o,i,n,e),void 0===r?this._nameToUniform4[t]=[o,i,n,e]:(r[0]=o,r[1]=i,r[2]=n,r[3]=e)}},i.setUniform4fv=function(t,o){const i=this._nameToUniform4[t];if(m(i,o)){this._context.gl.uniform4fv(this._getUniformLocation(t),o),void 0===i?this._nameToUniform4[t]=Array.from(o):g(o,i)}},i.setUniformMatrix3fv=function(t,o,i=!1){const n=this._nameToUniformMatrix3[t];if(u(n,o)){this._context.gl.uniformMatrix3fv(this._getUniformLocation(t),i,o),void 0===n?this._nameToUniformMatrix3[t]=Array.from(o):g(o,n)}},i.setUniformMatrix4fv=function(t,o,i=!1){const n=this._nameToUniformMatrix4[t];if(d(n,o)){this._context.gl.uniformMatrix4fv(this._getUniformLocation(t),i,o),void 0===n?this._nameToUniformMatrix4[t]=Array.from(o):g(o,n)}},i.stop=function(){},o._createClass(t,[{key:"glName",get:function(){if(n.isSome(this._glName))return this._glName;if(n.isNone(this._vShader))return null;const t=this._context.gl,o=t.createProgram();if(t.attachShader(o,this._vShader),t.attachShader(o,this._fShader),this._locations.forEach(((i,n)=>t.bindAttribLocation(o,i,n))),t.linkProgram(o),e.webglValidateShadersEnabled()&&!t.getProgramParameter(o,t.LINK_STATUS)&&console.error(`Could not link shader\nvalidated: ${t.getProgramParameter(o,t.VALIDATE_STATUS)}, gl error ${t.getError()}, vertex: ${t.getShaderParameter(this._vShader,t.COMPILE_STATUS)}, fragment: ${t.getShaderParameter(this._fShader,t.COMPILE_STATUS)}, info log: ${t.getProgramInfoLog(o)}, vertex source: ${this.vertexShader}, fragment source: ${this.fragmentShader}`),this._context.type===r.ContextType.WEBGL2){const i=t;for(const[t,n]of this._uniformBlockBindings){const e=i.getUniformBlockIndex(o,t);e<f&&i.uniformBlockBinding(o,e,n)}}return this._glName=o,this._context.instanceCounter.increment(s.ResourceType.Program,this),o}},{key:"hasGLName",get:function(){return n.isSome(this._glName)}},{key:"isCompiled",get:function(){if(this._compiled)return!0;const t=this._context.gl.getExtension("KHR_parallel_shader_compile");return null==t?(this._compiled=!0,!0):(this._compiled=!!this._context.gl.getProgramParameter(this.glName,t.COMPLETION_STATUS_KHR),this._compiled)}}]),t}();function m(t,o){if(n.isNone(t)||t.length!==o.length)return!0;for(let i=0;i<t.length;++i)if(t[i]!==o[i])return!0;return!1}function c(t,o,i){const n=t.gl,a=n.createShader(o);return n.shaderSource(a,i),n.compileShader(a),e.webglValidateShadersEnabled()&&!n.getShaderParameter(a,n.COMPILE_STATUS)&&(console.error("Compile error in ".concat(o===s.ShaderType.VERTEX_SHADER?"vertex":"fragment"," shader")),console.error(n.getShaderInfoLog(a)),console.error(_(i)),t.type===r.ContextType.WEBGL2&&(console.log("Shader source before transpilation:"),console.log(i))),a}function _(t){let o=2;return t.replace(/\n/g,(()=>"\n"+l(o++)+":"))}function l(t){return t>=1e3?t.toString():("  "+t).slice(-3)}function g(t,o){for(let i=0;i<t.length;++i)o[i]=t[i]}function u(t,o){return!!n.isNone(t)||(9!==t.length?m(t,o):9!==t.length||t[0]!==o[0]||t[1]!==o[1]||t[2]!==o[2]||t[3]!==o[3]||t[4]!==o[4]||t[5]!==o[5]||t[6]!==o[6]||t[7]!==o[7]||t[8]!==o[8])}function d(t,o){return!!n.isNone(t)||(16!==t.length?m(t,o):16!==t.length||t[0]!==o[0]||t[1]!==o[1]||t[2]!==o[2]||t[3]!==o[3]||t[4]!==o[4]||t[5]!==o[5]||t[6]!==o[6]||t[7]!==o[7]||t[8]!==o[8]||t[9]!==o[9]||t[10]!==o[10]||t[11]!==o[11]||t[12]!==o[12]||t[13]!==o[13]||t[14]!==o[14]||t[15]!==o[15])}t.Program=h,Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
