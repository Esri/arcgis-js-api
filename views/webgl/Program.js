/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../core/arrayUtils","../../core/has","../../core/maybe","./checkWebGLError","./context-util","./enums","./ShaderTranspiler"],(function(t,e,n,o,i,r,s,a,h){"use strict";const m=4294967295;let f=function(){function t(t,e,n,o,i=new Map){this._context=t,this._locations=o,this._uniformBlockBindings=i,this._refCount=1,this._compiled=!1,this._nameToUniformLocation={},this._nameToUniform1={},this._nameToUniform1v=new Map,this._nameToUniform2=new Map,this._nameToUniform3=new Map,this._nameToUniform4=new Map,this._nameToUniformMatrix3=new Map,this._nameToUniformMatrix4=new Map,t||console.error("RenderingContext isn't initialized!"),0===e.length&&console.error("Shaders source should not be empty!"),this._context.type===s.ContextType.WEBGL2&&(e=h.transpileShader(e,a.ShaderType.VERTEX_SHADER),n=h.transpileShader(n,a.ShaderType.FRAGMENT_SHADER)),this._vShader=c(this._context,a.ShaderType.VERTEX_SHADER,e),this._fShader=c(this._context,a.ShaderType.FRAGMENT_SHADER,n),this._vShader&&this._fShader||console.error("Error loading shaders!"),this._context.instanceCounter.increment(a.ResourceType.Shader,this),r.webglValidateShadersEnabled()&&(this.vertexShader=e,this.fragmentShader=n);const f=this._context.gl,_=f.createProgram();if(f.attachShader(_,this._vShader),f.attachShader(_,this._fShader),this._locations.forEach(((t,e)=>f.bindAttribLocation(_,t,e))),f.linkProgram(_),r.webglValidateShadersEnabled()&&!f.getProgramParameter(_,f.LINK_STATUS)&&console.error(`Could not link shader\nvalidated: ${f.getProgramParameter(_,f.VALIDATE_STATUS)}, gl error ${f.getError()}, vertex: ${f.getShaderParameter(this._vShader,f.COMPILE_STATUS)}, fragment: ${f.getShaderParameter(this._fShader,f.COMPILE_STATUS)}, info log: ${f.getProgramInfoLog(_)}, vertex source: ${this.vertexShader}, fragment source: ${this.fragmentShader}`),this._context.type===s.ContextType.WEBGL2){const t=f;for(const[e,n]of this._uniformBlockBindings){const o=t.getUniformBlockIndex(_,e);o<m&&t.uniformBlockBinding(_,o,n)}}this._glName=_,this._context.instanceCounter.increment(a.ResourceType.Program,this)}var n=t.prototype;return n.dispose=function(){if(--this._refCount>0)return;const t=this._context.gl;this._vShader&&(t.deleteShader(this._vShader),this._vShader=null,this._context.instanceCounter.decrement(a.ResourceType.Shader,this)),this._fShader&&(t.deleteShader(this._fShader),this._fShader=null),this._glName&&(t.deleteProgram(this._glName),this._glName=null,this._context.instanceCounter.decrement(a.ResourceType.Program,this))},n.ref=function(){++this._refCount},n._getUniformLocation=function(t){return void 0===this._nameToUniformLocation[t]&&i.isSome(this.glName)&&(++u.numUniforms,this._nameToUniformLocation[t]=this._context.gl.getUniformLocation(this.glName,t)),this._nameToUniformLocation[t]},n.hasUniform=function(t){return null!==this._getUniformLocation(t)},n.setUniform1i=function(t,e){const n=this._nameToUniform1[t];void 0!==n&&e===n||(this._context.gl.uniform1i(this._getUniformLocation(t),e),this._nameToUniform1[t]=e)},n.setUniform1iv=function(t,e){g(this._nameToUniform1v,t,e)&&this._context.gl.uniform1iv(this._getUniformLocation(t),e)},n.setUniform2iv=function(t,e){g(this._nameToUniform2,t,e)&&this._context.gl.uniform2iv(this._getUniformLocation(t),e)},n.setUniform3iv=function(t,e){g(this._nameToUniform3,t,e)&&this._context.gl.uniform3iv(this._getUniformLocation(t),e)},n.setUniform4iv=function(t,e){g(this._nameToUniform4,t,e)&&this._context.gl.uniform4iv(this._getUniformLocation(t),e)},n.setUniform1f=function(t,e){const n=this._nameToUniform1[t];void 0!==n&&e===n||(this._context.gl.uniform1f(this._getUniformLocation(t),e),this._nameToUniform1[t]=e)},n.setUniform1fv=function(t,e){g(this._nameToUniform1v,t,e)&&this._context.gl.uniform1fv(this._getUniformLocation(t),e)},n.setUniform2f=function(t,e,n){const o=this._nameToUniform2.get(t);void 0===o?(this._context.gl.uniform2f(this._getUniformLocation(t),e,n),this._nameToUniform2.set(t,[e,n])):e===o[0]&&n===o[1]||(this._context.gl.uniform2f(this._getUniformLocation(t),e,n),o[0]=e,o[1]=n)},n.setUniform2fv=function(t,e){g(this._nameToUniform2,t,e)&&this._context.gl.uniform2fv(this._getUniformLocation(t),e)},n.setUniform3f=function(t,e,n,o){const i=this._nameToUniform3.get(t);void 0===i?(this._context.gl.uniform3f(this._getUniformLocation(t),e,n,o),this._nameToUniform3[t]=[e,n,o]):e===i[0]&&n===i[1]&&o===i[2]||(this._context.gl.uniform3f(this._getUniformLocation(t),e,n,o),i[0]=e,i[1]=n,i[2]=o)},n.setUniform3fv=function(t,e){g(this._nameToUniform3,t,e)&&this._context.gl.uniform3fv(this._getUniformLocation(t),e)},n.setUniform4f=function(t,e,n,o,i){const r=this._nameToUniform4.get(t);void 0===r?(this._context.gl.uniform4f(this._getUniformLocation(t),e,n,o,i),this._nameToUniform4.set(t,[e,n,o,i])):void 0!==r&&e===r[0]&&n===r[1]&&o===r[2]&&i===r[3]||(this._context.gl.uniform4f(this._getUniformLocation(t),e,n,o,i),r[0]=e,r[1]=n,r[2]=o,r[3]=i)},n.setUniform4fv=function(t,e){g(this._nameToUniform4,t,e)&&this._context.gl.uniform4fv(this._getUniformLocation(t),e)},n.setUniformMatrix3fv=function(t,e,n=!1){g(this._nameToUniformMatrix3,t,e)&&this._context.gl.uniformMatrix3fv(this._getUniformLocation(t),n,e)},n.setUniformMatrix4fv=function(t,e,n=!1){g(this._nameToUniformMatrix4,t,e)&&this._context.gl.uniformMatrix4fv(this._getUniformLocation(t),n,e)},n.stop=function(){},e._createClass(t,[{key:"glName",get:function(){return this._glName}},{key:"hasGLName",get:function(){return i.isSome(this._glName)}},{key:"compiled",get:function(){if(this._compiled)return!0;const t=this._context.gl.getExtension("KHR_parallel_shader_compile");return null==t||i.isNone(this.glName)?(this._compiled=!0,!0):(this._compiled=!!this._context.gl.getProgramParameter(this.glName,t.COMPLETION_STATUS_KHR),this._compiled)}}]),t}();function c(t,e,n){const o=t.gl,i=o.createShader(e);return o.shaderSource(i,n),o.compileShader(i),r.webglValidateShadersEnabled()&&!o.getShaderParameter(i,o.COMPILE_STATUS)&&(console.error("Compile error in ".concat(e===a.ShaderType.VERTEX_SHADER?"vertex":"fragment"," shader")),console.error(o.getShaderInfoLog(i)),console.error(_(n))),u.enabled&&(u.compiledLOC+=n.match(/\n/g).length+1),i}function _(t){let e=2;return t.replace(/\n/g,(()=>"\n"+l(e++)+":"))}function l(t){return t>=1e3?t.toString():("  "+t).slice(-3)}function g(t,e,o){const i=t.get(e);return i?n.update(i,o):(t.set(e,Array.from(o)),!0)}const u={compiledLOC:0,numUniforms:0,enabled:!1};t.Program=f,t.test=u,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
