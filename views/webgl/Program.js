// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","../../core/has","../../core/maybe","./ShaderTranspiler"],(function(t,o,i,r,e){"use strict";var n=i("esri-debug-messages");function a(t,o){if(r.isNone(t)||t.length!==o.length)return!0;for(var i=0;i<t.length;++i)if(t[i]!==o[i])return!0;return!1}return function(){function t(o,i,e,n,a){if(void 0===a&&(a={}),this._context=null,this._glName=null,this._locations={},this._id=void 0,this._initialized=!1,this._vShader=null,this._fShader=null,this._defines={},this._nameToUniformLocation={},this._nameToAttribLocation={},this._nameToUniform1={},this._nameToUniform1v={},this._nameToUniform2={},this._nameToUniform3={},this._nameToUniform4={},this._nameToUniformMatrix3={},this._nameToUniformMatrix4={},o||console.error("RenderingContext isn't initialized!"),0===i.length&&console.error("Shaders source should not be empty!"),this._context=o,this._vertexShaderSource=i,this._fragmentShaderSource=e,Array.isArray(a))for(var s=0,h=a;s<h.length;s++){var m=h[s];this._defines[m]="1"}else this._defines=a;this._id=t._nextId++,this._locations=n,r.isSome(o.instanceCounter)&&o.instanceCounter.increment(3,this)}return Object.defineProperty(t.prototype,"id",{get:function(){return this._id},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"glName",{get:function(){return this._glName},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"locations",{get:function(){return this._locations},enumerable:!1,configurable:!0}),t.prototype.getDefine=function(t){return this._defines[t]},t.prototype.dispose=function(){if(this._context){var t=this._context.gl;if(this._vShader){var o=this._vShader;t.deleteShader(o),this._vShader=null}if(this._fShader){var i=this._fShader;t.deleteShader(i),this._fShader=null}this._glName&&(t.deleteProgram(this._glName),this._glName=null),r.isSome(this._context.instanceCounter)&&this._context.instanceCounter.decrement(3,this),this._context=null}},t.prototype.initialize=function(){if(!this._initialized){this._vShader=this._loadShader(35633),this._fShader=this._loadShader(35632),this._vShader&&this._fShader||console.error("Error loading shaders!");var t=this._context.gl,o=t.createProgram();for(var r in t.attachShader(o,this._vShader),t.attachShader(o,this._fShader),this._locations){var e=this._locations[r];t.bindAttribLocation(o,e,r)}t.linkProgram(o),i("esri-validate-shaders")&&!t.getProgramParameter(o,t.LINK_STATUS)&&console.error("Could not initialize shader\nVALIDATE_STATUS: "+t.getProgramParameter(o,t.VALIDATE_STATUS)+", gl error ["+t.getError()+"]infoLog: "+t.getProgramInfoLog(o)),this._glName=o,this._initialized=!0}},t.prototype.getUniformLocation=function(t){return this.initialize(),void 0===this._nameToUniformLocation[t]&&(this._nameToUniformLocation[t]=this._context.gl.getUniformLocation(this._glName,t)),this._nameToUniformLocation[t]},t.prototype.hasUniform=function(t){return null!==this.getUniformLocation(t)},t.prototype.getAttribLocation=function(t){return this.initialize(),void 0===this._nameToAttribLocation[t]&&(this._nameToAttribLocation[t]=this._context.gl.getAttribLocation(this._glName,t)),this._nameToAttribLocation[t]},t.prototype.setUniform1i=function(t,o){var i=this._nameToUniform1[t];void 0!==i&&o===i||(this._context.bindProgram(this),this._context.gl.uniform1i(this.getUniformLocation(t),o),this._nameToUniform1[t]=o)},t.prototype.setUniform1iv=function(o,i){var r=this._nameToUniform1v[o];a(r,i)&&(this._context.bindProgram(this),this._context.gl.uniform1iv(this.getUniformLocation(o),i),void 0===r?this._nameToUniform1v[o]=t._arrayCopy(i):t._arrayAssign(i,r))},t.prototype.setUniform2iv=function(o,i){n&&i.length%2!=0&&console.error("Value array must have even number of elements!");var r=this._nameToUniform2[o];a(r,i)&&(this._context.bindProgram(this),this._context.gl.uniform2iv(this.getUniformLocation(o),i),void 0===r?this._nameToUniform2[o]=t._arrayCopy(i):t._arrayAssign(i,r))},t.prototype.setUniform3iv=function(o,i){n&&i.length%3!=0&&console.error("Value array must contain sets of three values!");var r=this._nameToUniform3[o];a(r,i)&&(this._context.bindProgram(this),this._context.gl.uniform3iv(this.getUniformLocation(o),i),void 0===r?this._nameToUniform3[o]=t._arrayCopy(i):t._arrayAssign(i,r))},t.prototype.setUniform4iv=function(o,i){n&&i.length%4!=0&&console.error("Value array must contain sets of four values!");var r=this._nameToUniform4[o];a(r,i)&&(this._context.bindProgram(this),this._context.gl.uniform4iv(this.getUniformLocation(o),i),void 0===r?this._nameToUniform4[o]=t._arrayCopy(i):t._arrayAssign(i,r))},t.prototype.setUniform1f=function(t,o){var i=this._nameToUniform1[t];void 0!==i&&o===i||(this._context.bindProgram(this),this._context.gl.uniform1f(this.getUniformLocation(t),o),this._nameToUniform1[t]=o)},t.prototype.setUniform1fv=function(o,i){var r=this._nameToUniform1v[o];a(r,i)&&(this._context.bindProgram(this),this._context.gl.uniform1fv(this.getUniformLocation(o),i),void 0===r?this._nameToUniform1v[o]=t._arrayCopy(i):t._arrayAssign(i,r))},t.prototype.setUniform2f=function(t,o,i){var r=this._nameToUniform2[t];void 0!==r&&o===r[0]&&i===r[1]||(this._context.bindProgram(this),this._context.gl.uniform2f(this.getUniformLocation(t),o,i),void 0===r?this._nameToUniform2[t]=[o,i]:(r[0]=o,r[1]=i))},t.prototype.setUniform2fv=function(o,i){n&&i.length%2!=0&&console.error("Value array must have even number of elements!");var r=this._nameToUniform2[o];a(r,i)&&(this._context.bindProgram(this),this._context.gl.uniform2fv(this.getUniformLocation(o),i),void 0===r?this._nameToUniform2[o]=t._arrayCopy(i):t._arrayAssign(i,r))},t.prototype.setUniform3f=function(t,o,i,r){var e=this._nameToUniform3[t];void 0!==e&&o===e[0]&&i===e[1]&&r===e[2]||(this._context.bindProgram(this),this._context.gl.uniform3f(this.getUniformLocation(t),o,i,r),void 0===e?this._nameToUniform3[t]=[o,i,r]:(e[0]=o,e[1]=i,e[2]=r))},t.prototype.setUniform3fv=function(o,i){n&&i.length%3!=0&&console.error("Value array must contain sets of three values!");var r=this._nameToUniform3[o];a(r,i)&&(this._context.bindProgram(this),this._context.gl.uniform3fv(this.getUniformLocation(o),i),void 0===r?this._nameToUniform3[o]=t._arrayCopy(i):t._arrayAssign(i,r))},t.prototype.setUniform4f=function(t,o,i,r,e){var n=this._nameToUniform4[t];void 0!==n&&o===n[0]&&i===n[1]&&r===n[2]&&e===n[3]||(this._context.bindProgram(this),this._context.gl.uniform4f(this.getUniformLocation(t),o,i,r,e),void 0===n?this._nameToUniform4[t]=[o,i,r,e]:(n[0]=o,n[1]=i,n[2]=r,n[3]=e))},t.prototype.setUniform4fv=function(o,i){n&&i.length%4!=0&&console.error("Value array must contain sets of four values!");var r=this._nameToUniform4[o];a(r,i)&&(this._context.bindProgram(this),this._context.gl.uniform4fv(this.getUniformLocation(o),i),void 0===r?this._nameToUniform4[o]=t._arrayCopy(i):t._arrayAssign(i,r))},t.prototype.setUniformMatrix3fv=function(o,i,e){void 0===e&&(e=!1),n&&i.length%9!=0&&console.error("Matrix array must contain sets ot 9 elements!");var s=this._nameToUniformMatrix3[o];(function(t,o){if(r.isNone(t))return!0;if(9!==t.length)return a(t,o);n&&9!==o.length&&console.error("Matrix object must contain 16 elements!");return 9!==t.length||t[0]!==o[0]||t[1]!==o[1]||t[2]!==o[2]||t[3]!==o[3]||t[4]!==o[4]||t[5]!==o[5]||t[6]!==o[6]||t[7]!==o[7]||t[8]!==o[8]})(s,i)&&(this._context.bindProgram(this),this._context.gl.uniformMatrix3fv(this.getUniformLocation(o),e,i),void 0===s?this._nameToUniformMatrix3[o]=t._arrayCopy(i):t._arrayAssign(i,s))},t.prototype.setUniformMatrix4fv=function(o,i,e){void 0===e&&(e=!1),n&&i.length%16!=0&&console.error("Matrix array must contain sets ot 16 elements!");var s=this._nameToUniformMatrix4[o];(function(t,o){if(r.isNone(t))return!0;if(16!==t.length)return a(t,o);n&&16!==o.length&&console.error("Matrix object must contain 16 elements!");return 16!==t.length||t[0]!==o[0]||t[1]!==o[1]||t[2]!==o[2]||t[3]!==o[3]||t[4]!==o[4]||t[5]!==o[5]||t[6]!==o[6]||t[7]!==o[7]||t[8]!==o[8]||t[9]!==o[9]||t[10]!==o[10]||t[11]!==o[11]||t[12]!==o[12]||t[13]!==o[13]||t[14]!==o[14]||t[15]!==o[15]})(s,i)&&(this._context.bindProgram(this),this._context.gl.uniformMatrix4fv(this.getUniformLocation(o),e,i),void 0===s?this._nameToUniformMatrix4[o]=t._arrayCopy(i):t._arrayAssign(i,s))},t.prototype.assertCompatibleVertexAttributeLocations=function(t){var o=t.locations===this.locations;return o||console.error("VertexAttributeLocations are incompatible"),o},t._padToThree=function(t){var o=t.toString();return t<1e3&&(o=("  "+t).slice(-3)),o},t.prototype._addLineNumbers=function(o){var i=2;return o.replace(/\n/g,(function(){return"\n"+t._padToThree(i++)+":"}))},t.prototype._loadShader=function(t){var o=35633===t,r=o?this._vertexShaderSource:this._fragmentShaderSource,n=r,a="";for(var s in this._defines)a+="#define "+s+" "+this._defines[s]+"\n";n=a+n,"webgl2"===this._context.contextVersion&&(n=e.transpileShader(n,o?"vertex":"fragment"));var h=this._context.gl,m=h.createShader(t);return h.shaderSource(m,n),h.compileShader(m),i("esri-validate-shaders")&&!h.getShaderParameter(m,h.COMPILE_STATUS)&&(console.error("Compile error in ".concat(o?"vertex":"fragment"," shader")),console.error(h.getShaderInfoLog(m)),console.error(this._addLineNumbers(n)),"webgl2"===this._context.contextVersion&&(console.log("Shader source before transpilation:"),console.log(r))),m},t._arrayCopy=function(t){for(var o=[],i=0;i<t.length;++i)o.push(t[i]);return o},t._arrayAssign=function(t,o){for(var i=0;i<t.length;++i)o[i]=t[i]},t._nextId=0,t}()}));