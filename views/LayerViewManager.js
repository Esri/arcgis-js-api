/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/has","../core/maybe","../core/Logger","../core/accessorSupport/ensureType","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/subclass","../core/Error","../core/urlUtils","../core/uuid","../portal/support/resourceExtension","../core/promiseUtils","../core/scheduling","../core/CollectionFlattener","../core/watchUtils","./support/WatchUpdatingTracking","../core/HandleOwner","../core/MapUtils"],(function(e,r,t,a,i,o,s,l,n,y,c,p,d,w,h,u,_,f,m){"use strict";const v=i.getLogger("esri.views.LayerViewManager");let g=function(){function r(e,r,t){this.layer=e,this.view=r,this.layerViewImporter=t,this._controller=d.createAbortController(),this._deferred=d.createDeferred(),this._started=!1,this.done=!1,d.onAbort(this._controller.signal,(()=>{const r=new n("cancelled:layerview-create","layerview creation cancelled",{layer:e});this._deferred.reject(r)}))}var t=r.prototype;return t.destroy=function(){this._controller.abort();const{layerView:e}=this;if(!e)return;const{layer:r,view:t}=this;r.emit("layerview-destroy",{view:t,layerView:e}),t.emit("layerview-destroy",{layer:r,layerView:e}),this.done=!0,this.layer=null,this.layerView=null,this.view=null,this.layerViewImporter=null},t.start=async function(){if(this._started)return;this._started=!0;const{_controller:{signal:e},layer:r,view:t}=this;this._map=t.map;try{var i,o;let s,l;if(await r.load({signal:e}),"prefetchResources"in r&&await r.prefetchResources({signal:e}),r.createLayerView)s=await r.createLayerView(t,{signal:e});else{if(!this.layerViewImporter.hasLayerViewModule(r))throw new n("layer:view-not-supported","No layerview implementation was found");const a=await this.layerViewImporter.importLayerView(r);d.throwIfAborted(e),s="default"in a?new a.default({layer:r,view:t}):new a({layer:r,view:t})}const y=()=>{l=a.removeMaybe(l),s.destroy(),s.layer=null,s.parent=null,s.view=null,this.done=!0};l=d.onAbort(e,y),d.throwIfAborted(e);try{await s.when()}catch(e){throw y(),e}if(!(null==(i=this._map)||null==(o=i.allLayers)?void 0:o.includes(r)))return y(),void this._deferred.reject(new n("view:no-layerview-for-layer","The layer has been removed from the map",{layer:r}));this.layerView=s,r.emit("layerview-create",{view:t,layerView:s}),t.emit("layerview-create",{layer:r,layerView:s}),this.done=!0,this._deferred.resolve(s)}catch(e){r.emit("layerview-create-error",{view:t,error:e}),t.emit("layerview-create-error",{layer:r,error:e}),this.done=!0,this._deferred.reject(new n("layerview:create-error","layerview creation failed",{layer:r,error:e}))}},e._createClass(r,[{key:"promise",get:function(){return this._deferred.promise}}]),r}(),V=function(r){function t(t){var i;return(i=r.call(this,t)||this)._layerLayerViewInfoMap=new Map,i._watchUpdatingTracking=new _.WatchUpdatingTracking,i.supportsGround=!0,i._preloadLayerViewModules=()=>{var e;const r=null==(e=i.view.map)?void 0:e.allLayers;if(r)for(const e of r)i.layerViewImporter.hasLayerViewModule(e)&&i.layerViewImporter.importLayerView(e)},i._reschedule=()=>(a.isNone(i._workPromise)&&(i._workPromise=d.createDeferred()),i.handles.remove("reschedule"),i.handles.add(w.schedule(i._doWork),"reschedule"),i._workPromise.promise),i._doWork=()=>{var r,t,o;const s=i.view.map;if(i._map!==s&&(i.clear(),i._map=s),a.isNone(i._workPromise))return void i.notifyChange("updating");i.handles.remove("reschedule"),i.handles.remove("collection-change");const l=new h({root:e._assertThisInitialized(i),rootCollectionNames:i._rootCollectionNames,getChildrenFunction:e=>e.layers});if(!l)return i._workPromise.resolve(),void(i._workPromise=null);for(const e of l)i._createLayerView(e);i._refreshCollections();for(const[e,r]of i._layerLayerViewInfoMap)l.includes(e)||(i._layerLayerViewInfoMap.delete(r.layer),r.destroy());const n=l.filter((e=>"group"===e.type)).map((e=>e.layers)),y=[null==s||null==(r=s.ground)?void 0:r.layers,null==s||null==(t=s.basemap)?void 0:t.baseLayers,null==s||null==(o=s.basemap)?void 0:o.referenceLayers,null==s?void 0:s.layers,...n].filter((e=>!!e));i.handles.add(y.map((e=>i._watchUpdatingTracking.addOnCollectionChange(e,i._reschedule))),"collection-change"),i._workPromise.resolve(),i._workPromise=null},i}e._inheritsLoose(t,r);var i=t.prototype;return i.initialize=function(){this.handles.add([u.on(this,"view.map.allLayers","change",this._preloadLayerViewModules,this._preloadLayerViewModules),u.init(this.view,["map.basemap","map.ground","map.layers","ready"],this._reschedule,!0)]),this._preloadLayerViewModules(),this._reschedule()},i.destroy=function(){this.clear(),this._watchUpdatingTracking.destroy(),this._map=null},i.clear=function(){if(!this.destroyed){for(const e of this._layerLayerViewInfoMap.values())e.destroy();this._layerLayerViewInfoMap.clear(),this._refreshCollections()}},i.whenLayerView=async function(e){return await this._reschedule(),this._layerLayerViewInfoMap.has(e)?this._layerLayerViewInfoMap.get(e).promise:d.reject(new n("view:no-layerview-for-layer","No layerview has been found for the layer",{layer:e}))},i._refreshCollections=function(){for(const[e,r]of this._layersToLayerViews)this._populateLayerViewsOwners(this.get(e),this.get(r),this.view);this.notifyChange("updating")},i._populateLayerViewsOwners=function(e,r,t){if(!e||!r)return void(r&&r.removeAll());let a=0;for(const i of e){const e=this._layerLayerViewInfoMap.get(i);if(!e||!e.layerView)continue;const o=e.layerView;o.layer=i,o.parent=t,r.getItemAt(a)!==o&&r.splice(a,0,o),i.layers&&this._populateLayerViewsOwners(i.layers,o.layerViews,o),a+=1}a<r.length&&r.splice(a,r.length)},i._createLayerView=function(e){if(this._layerLayerViewInfoMap.has(e))return this.view.ready&&this._layerLayerViewInfoMap.get(e).start(),void this.notifyChange("updating");e.load().catch((()=>{})),this.layerViewImporter.hasLayerViewModule(e)&&this.layerViewImporter.importLayerView(e);const r=new g(e,this.view,this.layerViewImporter);r.promise.then((()=>this._refreshCollections()),(r=>{var t,a;r&&(d.isAbortError(r)||"cancelled:layerview-create"===r.name)||v.error(`Failed to create layerview for layer title:'${null!=(t=e.title)?t:"no title"}', id:'${null!=(a=e.id)?a:"no id"}' of type '${e.type}'.`,{layer:e,error:r});this._refreshCollections()})),this._layerLayerViewInfoMap.set(e,r),this.view.ready&&r.start(),this.notifyChange("updating")},e._createClass(t,[{key:"_layersToLayerViews",get:function(){const e=[["view.map.basemap.baseLayers","view.basemapView.baseLayerViews"],["view.map.layers","view.layerViews"],["view.map.basemap.referenceLayers","view.basemapView.referenceLayerViews"]];return this.supportsGround&&e.push(["view.map.ground.layers","view.groundView.layerViews"]),new Map(e)}},{key:"_rootCollectionNames",get:function(){return Array.from(this._layersToLayerViews.keys())}},{key:"updating",get:function(){return!(!a.isSome(this._workPromise)&&!this._watchUpdatingTracking.updating)||m.someMap(this._layerLayerViewInfoMap,(e=>!e.done))}}]),t}(f.HandleOwner);return r.__decorate([s.property()],V.prototype,"_workPromise",void 0),r.__decorate([s.property({readOnly:!0})],V.prototype,"_watchUpdatingTracking",void 0),r.__decorate([s.property({dependsOn:["supportsGround"],readOnly:!0})],V.prototype,"_layersToLayerViews",null),r.__decorate([s.property({dependsOn:["_layersToLayerViews"],readOnly:!0})],V.prototype,"_rootCollectionNames",null),r.__decorate([s.property()],V.prototype,"layerViewImporter",void 0),r.__decorate([s.property()],V.prototype,"supportsGround",void 0),r.__decorate([s.property({readOnly:!0,dependsOn:["_workPromise","_watchUpdatingTracking.updating"]})],V.prototype,"updating",null),r.__decorate([s.property({constructOnly:!0})],V.prototype,"view",void 0),V=r.__decorate([l.subclass("esri.views.LayerViewManager")],V),V}));
