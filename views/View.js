/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../Map","../TimeExtent","../core/Accessor","../core/asyncUtils","../core/Collection","../core/CollectionFlattener","../core/Error","../core/Evented","../core/HandleOwner","../core/handleUtils","../core/Loadable","../core/Logger","../core/maybe","../core/Promise","../core/promiseUtils","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/ensureType","../core/arrayUtils","../core/accessorSupport/decorators/subclass","../core/support/OwningCollection","../geometry/Extent","../geometry/HeightModelInfo","../geometry/SpatialReference","../geometry/support/spatialReferenceUtils","../support/AnalysesCollection","../support/GraphicsCollection","../time/TimeReference","./BasemapView","./LayerViewManager","./Magnifier","./ToolViewManager","./input/Input","./input/ViewEvents","./navigation/Navigation","./support/DefaultsFromMap"],(function(e,t,r,a,i,o,n,s,l,p,d,c,y,u,h,f,_,g,w,m,v,M,V,R,S,F,b,C,k,L,O,E,x,I,T,P,q,z){"use strict";var D;let G=D=function(t){function r(r){var a;return(a=t.call(this,r)||this)._userSpatialReference=null,a._cursor=null,a.allLayerViews=new s({getCollections:()=>[a.basemapView?.baseLayerViews,a.groundView?.layerViews,a.layerViews,a.basemapView?.referenceLayerViews],getChildrenFunction:e=>e.layerViews}),a.groundView=null,a.basemapView=null,a.fatalError=null,a.graphics=new k.GraphicsCollection,a.analyses=new C.AnalysesCollection,a.typeSpecificPreconditionsReady=!0,a.layerViews=new n,a.magnifier=new x,a.padding={left:0,top:0,right:0,bottom:0},a.ready=!1,a.spatialReferenceWarningDelay=1e3,a.supportsGround=!0,a.timeExtent=null,a.timeReference=new L,a.type=null,a.scale=null,a.updating=!1,a.initialExtentRequired=!0,a.input=new T,a.navigation=new q,a.layerViewManager=null,a.analysisViewManager=null,a.isHeightModelInfoRequired=!1,a.width=null,a.height=null,a.resizing=!1,a.suspended=!1,a.viewEvents=new P.ViewEvents(e._assertThisInitialized(a)),a.persistableViewModels=new n,a._isValid=!1,a._readyCycleForced=!1,a._currentSpatialReference=null,a.handles.add(g.watch((()=>a.preconditionsReady),(t=>{t?(a._currentSpatialReference=a.spatialReference,D.views.add(e._assertThisInitialized(a))):(a._currentSpatialReference=null,D.views.remove(e._assertThisInitialized(a))),a.notifyChange("spatialReference"),!t&&a.ready?(a.toolViewManager?.detach(),h.isSome(a.analysisViewManager)&&a.analysisViewManager.detach(),a.layerViewManager?.clear(),a._teardown()):t&&!a.ready&&(a._startup(),h.isSome(a.analysisViewManager)&&a.analysisViewManager.attach(),a.toolViewManager.attach())}),g.sync)),a}e._inheritsLoose(r,t);var a=r.prototype;return a.initialize=function(){this.addResolvingPromise(this.validate().then((()=>(this._isValid=!0,g.whenOnce((()=>this.ready)))))),this.basemapView=new O.BasemapView({view:this}),this.layerViewManager=new E({view:this,layerViewImporter:{importLayerView:e=>this.importLayerView(e),hasLayerViewModule:e=>this.hasLayerViewModule(e)},supportsGround:this.supportsGround}),this.toolViewManager=new I({view:this}),this._setupSpatialReferenceLogger(),this.handles.add([g.watch((()=>this.initialExtentRequired),(e=>this.defaultsFromMap.required={...this.defaultsFromMap.required,extent:e}),{sync:!0,initial:!0}),g.watch((()=>this.ready),(e=>{this.defaultsFromMap&&(this.defaultsFromMap.suspended=e,this.defaultsFromMap.userSpatialReference=e?this.spatialReference:this._userSpatialReference)}),{sync:!0}),g.watch((()=>this._userSpatialReference),(e=>{this.defaultsFromMap&&(this.defaultsFromMap.userSpatialReference=e)}),{sync:!0,initial:!0})])},a._setupSpatialReferenceLogger=function(){var t=this;let r=null;this.handles.add([g.watch((()=>this.defaultsFromMap?.ready),(a=>{const i=this.map?.allLayers.length>0;if(a&&!this.spatialReference&&i){if(h.isSome(r))return;const a=c.makeHandle((()=>r=h.abortMaybe(r)));r=o.createTask(function(){var a=e._asyncToGenerator((function*(e){try{yield _.after(t.spatialReferenceWarningDelay,null,e)}catch{return}finally{r=null}u.getLogger(t.declaredClass).warn("#spatialReference","no spatial reference could be derived from the currently added map layers")}));return function(e){return a.apply(this,arguments)}}()),this.handles.add(a,"spatial-reference-logger-task")}else this.handles.remove("spatial-reference-logger-task")}),{sync:!0})])},a.destroy=function(){if(this.destroyed)return;this.viewEvents.destroy(),this.allLayerViews.destroy(),this.navigation&&(this.navigation.destroy(),this._set("navigation",null)),this.graphics=h.destroyMaybe(this.graphics),this.analyses=h.destroyMaybe(this.analyses),this.handles.remove("defaultsFromMap"),this.defaultsFromMap.destroy(),this._set("defaultsFromMap",null),h.destroyMaybe(this.analysisViewManager),this.toolViewManager=h.destroyMaybe(this.toolViewManager),this.layerViewManager=h.destroyMaybe(this.layerViewManager),this.basemapView=h.destroyMaybe(this.basemapView),this.invalidate(),this._emitter.clear(),this.handles.removeAll();const e=this.map;this.map=null,e?.destroy()},a._startup=function(){this._set("ready",!0)},a._teardown=function(){this._set("ready",!1)},a.whenReady=function(){return Promise.resolve(this)},a.toMap=function(){return u.getLogger(this.declaredClass).error("#toMap()","Not implemented on this instance of View"),null},a._spatialReferenceChanged=function(e){},a.whenLayerView=function(e){return this.layerViewManager.whenLayerView(e)},a.getDefaultSpatialReference=function(){return this.defaultsFromMap?.spatialReference},a.getDefaultHeightModelInfo=function(){return(this.map&&"heightModelInfo"in this.map?this.map.heightModelInfo:void 0)??this.defaultsFromMap?.heightModelInfo??null},a.importLayerView=function(e){throw new l("importLayerView() not implemented")},a.hasLayerViewModule=function(e){return!1},a.validate=function(){var t=e._asyncToGenerator((function*(){}));function r(){return t.apply(this,arguments)}return r}(),a.invalidate=function(){this._isValid=!1},a.getSpatialReferenceSupport=function(){return{constraints:null}},a._validateSpatialReference=function(e){return h.isSome(this.getSpatialReferenceSupport({spatialReference:e}))},a.when=function(e,r){return this.isResolved()&&!this.ready&&u.getLogger(this.declaredClass).warn("#when()","Calling view.when() while the view is no longer ready but was already resolved once will resolve immediately. Use reactiveUtils.whenOnce(() => view.ready).then(...) instead."),t.prototype.when.call(this,e,r)},a.forceReadyCycle=function(){this.ready&&(g.when((()=>!1===this.preconditionsReady),(()=>this._readyCycleForced=!1),{once:!0}),this._readyCycleForced=!0)},a.addAndActivateTool=function(e){this.toolViewManager.tools.add(e),this.activeTool=e},a.tryFatalErrorRecovery=function(){this.fatalError=null},e._createClass(r,[{key:"activeTool",get:function(){return this.toolViewManager?.activeTool},set:function(e){this.toolViewManager&&(this.toolViewManager.activeTool=e)}},{key:"animation",get:function(){return this._get("animation")},set:function(e){this._set("animation",e)}},{key:"center",get:function(){return null}},{key:"_defaultsFromMapSettings",get:function(){return{}}},{key:"defaultsFromMap",get:function(){return new z.DefaultsFromMap({required:{tileInfo:!1,heightModelInfo:!1,extent:!1},map:()=>this.map,getSpatialReferenceSupport:e=>this.getSpatialReferenceSupport(e),...this._defaultsFromMapSettings})}},{key:"extent",get:function(){return this._get("extent")},set:function(e){this._set("extent",e)}},{key:"heightModelInfo",get:function(){return this.getDefaultHeightModelInfo()}},{key:"interacting",get:function(){return this.navigating}},{key:"navigating",get:function(){return!1}},{key:"preconditionsReady",get:function(){return!(this.fatalError||!this._isValid||this._readyCycleForced||!this.map||y.isLoadable(this.map)&&!this.map.loaded||0===this.width||0===this.height||!this.spatialReference||!this._validateSpatialReference(this.spatialReference)||!this._currentSpatialReference&&!this.defaultsFromMap?.ready||!this.typeSpecificPreconditionsReady)}},{key:"resolution",get:function(){return 0}},{key:"map",set:function(e){e!==this._get("map")&&(e?.destroyed&&(u.getLogger(this.declaredClass).warn("#map","The provided map is already destroyed",{map:e}),e=null),y.isLoadable(e)&&e.load().catch((()=>{})),this.constructed&&(this.forceReadyCycle(),this._currentSpatialReference=null),this._set("map",e))}},{key:"spatialReference",get:function(){let e=this._userSpatialReference||this._currentSpatialReference||this.getDefaultSpatialReference()||null;return e&&this.defaultsFromMap?.required?.heightModelInfo&&(e=e.clone(),e.vcsWkid=this.defaultsFromMap.vcsWkid,e.latestVcsWkid=this.defaultsFromMap.latestVcsWkid),e},set:function(e){const t=!b.equals(e,this._get("spatialReference"));this._set("_userSpatialReference",e),t&&(this._set("spatialReference",e),this._spatialReferenceChanged(e))}},{key:"stationary",get:function(){return!this.animation&&!this.navigating&&!this.resizing}},{key:"tools",get:function(){return this.toolViewManager?.tools}},{key:"initialExtent",get:function(){return this.defaultsFromMap?.extent}},{key:"cursor",get:function(){const e=this.toolViewManager?this.toolViewManager.cursor:null;return h.isSome(e)?e:this._cursor||"default"},set:function(e){this._cursor=e,this.notifyChange("cursor")}},{key:"size",get:function(){return[this.width,this.height]}}]),r}(d.HandleOwnerMixin(p.EventedMixin(f.EsriPromiseMixin(i))));G.views=new n,t.__decorate([w.property()],G.prototype,"_userSpatialReference",void 0),t.__decorate([w.property()],G.prototype,"activeTool",null),t.__decorate([w.property({readOnly:!0})],G.prototype,"allLayerViews",void 0),t.__decorate([w.property()],G.prototype,"groundView",void 0),t.__decorate([w.property()],G.prototype,"animation",null),t.__decorate([w.property()],G.prototype,"basemapView",void 0),t.__decorate([w.property()],G.prototype,"center",null),t.__decorate([w.property({readOnly:!0})],G.prototype,"_defaultsFromMapSettings",null),t.__decorate([w.property()],G.prototype,"defaultsFromMap",null),t.__decorate([w.property()],G.prototype,"fatalError",void 0),t.__decorate([w.property({type:R})],G.prototype,"extent",null),t.__decorate([w.property(V.owningCollectionProperty(k.GraphicsCollection,"graphics"))],G.prototype,"graphics",void 0),t.__decorate([w.property(V.owningCollectionProperty(C.AnalysesCollection,"analyses"))],G.prototype,"analyses",void 0),t.__decorate([w.property({readOnly:!0,type:S})],G.prototype,"heightModelInfo",null),t.__decorate([w.property({readOnly:!0})],G.prototype,"interacting",null),t.__decorate([w.property({readOnly:!0})],G.prototype,"navigating",null),t.__decorate([w.property({readOnly:!0,dependsOn:["fatalError","_isValid","_readyCycleForced","map","map.loaded?","width","height","spatialReference","_currentSpatialReference","defaultsFromMap.ready","typeSpecificPreconditionsReady"]})],G.prototype,"preconditionsReady",null),t.__decorate([w.property({readOnly:!0})],G.prototype,"typeSpecificPreconditionsReady",void 0),t.__decorate([w.property({type:n,readOnly:!0})],G.prototype,"layerViews",void 0),t.__decorate([w.property()],G.prototype,"resolution",null),t.__decorate([w.property({type:x})],G.prototype,"magnifier",void 0),t.__decorate([w.property({value:null,type:r})],G.prototype,"map",null),t.__decorate([w.property()],G.prototype,"padding",void 0),t.__decorate([w.property({readOnly:!0})],G.prototype,"ready",void 0),t.__decorate([w.property({type:F})],G.prototype,"spatialReference",null),t.__decorate([w.property()],G.prototype,"spatialReferenceWarningDelay",void 0),t.__decorate([w.property()],G.prototype,"stationary",null),t.__decorate([w.property({readOnly:!0})],G.prototype,"supportsGround",void 0),t.__decorate([w.property({type:a})],G.prototype,"timeExtent",void 0),t.__decorate([w.property({type:L,nonNullable:!0})],G.prototype,"timeReference",void 0),t.__decorate([w.property()],G.prototype,"tools",null),t.__decorate([w.property()],G.prototype,"toolViewManager",void 0),t.__decorate([w.property({readOnly:!0})],G.prototype,"type",void 0),t.__decorate([w.property({type:Number})],G.prototype,"scale",void 0),t.__decorate([w.property({readOnly:!0})],G.prototype,"updating",void 0),t.__decorate([w.property({readOnly:!0})],G.prototype,"initialExtentRequired",void 0),t.__decorate([w.property({readOnly:!0})],G.prototype,"initialExtent",null),t.__decorate([w.property()],G.prototype,"cursor",null),t.__decorate([w.property({readOnly:!0})],G.prototype,"input",void 0),t.__decorate([w.property({type:q,nonNullable:!0})],G.prototype,"navigation",void 0),t.__decorate([w.property()],G.prototype,"layerViewManager",void 0),t.__decorate([w.property()],G.prototype,"analysisViewManager",void 0),t.__decorate([w.property()],G.prototype,"width",void 0),t.__decorate([w.property()],G.prototype,"height",void 0),t.__decorate([w.property({readOnly:!0})],G.prototype,"resizing",void 0),t.__decorate([w.property({value:null,readOnly:!0})],G.prototype,"size",null),t.__decorate([w.property({readOnly:!0})],G.prototype,"suspended",void 0),t.__decorate([w.property({readOnly:!0})],G.prototype,"viewEvents",void 0),t.__decorate([w.property({readOnly:!0})],G.prototype,"persistableViewModels",void 0),t.__decorate([w.property()],G.prototype,"_isValid",void 0),t.__decorate([w.property()],G.prototype,"_readyCycleForced",void 0),t.__decorate([w.property()],G.prototype,"_currentSpatialReference",void 0),G=D=t.__decorate([M.subclass("esri.views.View")],G);return G}));
