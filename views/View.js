/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/has","../core/maybe","../core/Logger","../core/accessorSupport/ensureType","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/aliasOf","../core/accessorSupport/decorators/subclass","../core/Error","../core/urlUtils","../core/uuid","../portal/support/resourceExtension","../core/promiseUtils","../core/scheduling","../core/Accessor","../geometry/support/spatialReferenceUtils","../geometry/SpatialReference","../geometry/Extent","../core/Evented","../core/Collection","../core/Promise","../core/Loadable","../core/CollectionFlattener","../Map","../TimeExtent","../core/watchUtils","../geometry/HeightModelInfo","../core/HandleOwner","../support/GraphicsCollection","./BasemapView","./LayerViewManager","./Magnifier","./RefreshManager","./input/ViewEvents","./ToolViewManager","./input/Input","./navigation/Navigation","./support/DefaultsFromMap"],(function(e,t,r,i,a,o,n,s,l,p,d,c,y,u,h,f,_,w,g,m,v,M,V,R,F,O,E,I,S,C,b,x,L,k,T,z,D,q,H){"use strict";var W;const P=a.getLogger("esri.views.View");let U=W=function(t){function r(r){var i;return(i=t.call(this,r)||this)._userSpatialReference=null,i._cursor=null,i.allLayerViews=new R({root:e._assertThisInitialized(i),rootCollectionNames:["basemapView.baseLayerViews","groundView?.layerViews","layerViews","basemapView.referenceLayerViews"],getChildrenFunction:e=>e.layerViews}),i.animation=null,i.basemapView=null,i.defaultsFromMap=new H({view:e._assertThisInitialized(i)}),i.fatalError=null,i.extent=null,i.graphics=new C.default,i.navigating=!1,i.layerViews=new v,i.magnifier=new L,i.padding={left:0,top:0,right:0,bottom:0},i.ready=!1,i.spatialReferenceWarningDelay=1e3,i.supportsGround=!0,i.timeExtent=null,i.type=null,i.scale=null,i.updating=!1,i.initialExtentRequired=!0,i.renderContext=null,i.input=new D,i.navigation=new q,i.layerViewManager=null,i.refreshManager=null,i.isHeightModelInfoRequired=!1,i.width=null,i.height=null,i.resizing=!1,i.suspended=!1,i.viewEvents=new T.ViewEvents(e._assertThisInitialized(i)),i.persistableViewModels=new v,i._isValid=!1,i._readyCycleForced=!1,i.handles.add(i.watch("preconditionsReady",(t=>{t?(i._currentSpatialReference=i.spatialReference,W.views.add(e._assertThisInitialized(i))):(i._currentSpatialReference=null,W.views.remove(e._assertThisInitialized(i))),i.notifyChange("spatialReference"),!t&&i.ready?(i.layerViewManager.clear(),i.toolViewManager.detach(),i._teardown()):t&&!i.ready&&(i._startup(),i.toolViewManager.attach())}),!0)),i}e._inheritsLoose(r,t);var a=r.prototype;return a.initialize=function(){let e;this.addResolvingPromise(this.validate().then((()=>(this._isValid=!0,E.whenOnce(this,"ready"))))),this.basemapView=new b.BasemapView({view:this}),this.layerViewManager=new x({view:this,layerViewImporter:{importLayerView:e=>this.importLayerView(e),hasLayerViewModule:e=>this.hasLayerViewModule(e)},supportsGround:this.supportsGround}),this.refreshManager=new k({view:this}),this.toolViewManager=new z({view:this}),this._resetInitialViewPropertiesFromContent(),E.init(this.defaultsFromMap,"isSpatialReferenceDone",(t=>{const r=!!(this.map&&this.map.allLayers.length>0);if(t&&!this.spatialReference&&r||!e){if(t&&!this.spatialReference&&r&&!e){const t=e=u.after(this.spatialReferenceWarningDelay);e.then((()=>{t===e&&P.warn("#spatialReference","no spatial reference could be derived from the currently added map layers")})).catch((()=>{}))}}else e=null}),!0)},a.destroy=function(){if(this.destroyed)return;this.viewEvents.destroy(),this.allLayerViews.destroy(),this.navigation&&(this.navigation.destroy(),this._set("navigation",null)),this.graphics.destroy(),this.graphics=null,this.handles.remove("defaultsFromMap"),this.defaultsFromMap.destroy(),this._set("defaultsFromMap",null),this.toolViewManager.destroy(),this.toolViewManager=null,this.refreshManager.destroy(),this.refreshManager=null,this.layerViewManager.destroy(),this.layerViewManager=null,this.basemapView.destroy(),this.basemapView=null,this.invalidate(),this._emitter.clear(),this.handles.removeAll();const e=this.map;this.map=null,null==e||e.destroy()},a._startup=function(){this._set("ready",!0)},a._teardown=function(){this._set("ready",!1)},a.whenReady=function(){return u.resolve()},a.toMap=function(){return P.error("#toMap()","Not implemented on this instance of View"),null},a.whenLayerView=function(e){return this.layerViewManager.whenLayerView(e)},a.getDefaultSpatialReference=function(){return this.get("defaultsFromMap.spatialReference")},a.getDefaultHeightModelInfo=function(){return this.get("map.supportsHeightModelInfo")&&this.get("map.heightModelInfo")||this.get("defaultsFromMap.heightModelInfo")||null},a.importLayerView=function(e){throw new p("importLayerView() not implemented")},a.hasLayerViewModule=function(e){return!1},a.validate=async function(){},a.invalidate=function(){this._isValid=!1},a.isSpatialReferenceSupported=function(e,t,r){return!0},a.isTileInfoRequired=function(){return!1},a.when=function(e,r){return this.isResolved()&&!this.ready&&P.warn("#when()",'Calling view.when() while the view is no longer ready but was already resolved once will resolve immediately. Use watchUtils.whenOnce(view, "ready").then(...) instead.'),t.prototype.when.call(this,e,r)},a.forceReadyCycle=function(){this.ready&&(this._readyCycleForced=!0,E.whenFalseOnce(this,"preconditionsReady",(()=>this._readyCycleForced=!1)))},a.createTool=function(e,t,r){return this.toolViewManager.createTool(e,t,r)},a.tryFatalErrorRecovery=function(){this.fatalError=null},a._resetInitialViewPropertiesFromContent=function(){if(!this.defaultsFromMap)return;const e=()=>this.defaultsFromMap&&this.defaultsFromMap.start();this.defaultsFromMap.reset(),this._currentSpatialReference=null,this.notifyChange("spatialReference"),this.handles.remove("defaultsFromMap"),this.handles.add([E.watch(this,"spatialReference",((t,r)=>{_.equals(t,r)||e()})),E.watch(this,"initialExtentRequired",e),h.schedule(e)],"defaultsFromMap")},e._createClass(r,[{key:"heightModelInfo",get:function(){return this.getDefaultHeightModelInfo()}},{key:"interacting",get:function(){return this.navigating}},{key:"preconditionsReady",get:function(){return!!(!this.fatalError&&this._isValid&&!this._readyCycleForced&&this.map&&(!V.isLoadable(this.map)||this.map.loaded)&&0!==this.width&&0!==this.height&&this.spatialReference&&this.isSpatialReferenceSupported(this.spatialReference)&&(this._currentSpatialReference||!this.initialExtentRequired||this.initialExtent||this.defaultsFromMap&&this.defaultsFromMap.isSpatialReferenceDone)&&this.defaultsFromMap&&this.defaultsFromMap.isTileInfoDone)}},{key:"map",set:function(e){var t;e!==this._get("map")&&(null!=(t=e)&&t.destroyed&&(P.warn("#map","The provided map is already destroyed",{map:e}),e=null),V.isLoadable(e)&&e.load().catch((()=>{})),this.initialized&&(this.forceReadyCycle(),this._resetInitialViewPropertiesFromContent()),this._set("map",e))}},{key:"spatialReference",get:function(){let e=this._userSpatialReference||this._currentSpatialReference||this.getDefaultSpatialReference()||null;return e&&this.isHeightModelInfoRequired&&this.defaultsFromMap&&(e=e.clone(),e.vcsWkid=this.defaultsFromMap.vcsWkid,e.latestVcsWkid=this.defaultsFromMap.latestVcsWkid),e},set:function(e){this._userSpatialReference=e,this._set("spatialReference",e)}},{key:"stationary",get:function(){return!this.animation&&!this.navigating&&!this.resizing}},{key:"initialExtent",get:function(){return this.defaultsFromMap&&this.defaultsFromMap.extent}},{key:"cursor",get:function(){const e=this.toolViewManager?this.toolViewManager.cursor:null;return i.isSome(e)?e:this._cursor||"default"},set:function(e){this._cursor=e,this.notifyChange("cursor")}},{key:"size",get:function(){return[this.width,this.height]}}]),r}(S.HandleOwnerMixin(m.EventedMixin(M.EsriPromiseMixin(f))));return U.views=new v,t.__decorate([s.aliasOf("toolViewManager.activeTool")],U.prototype,"activeTool",void 0),t.__decorate([n.property({readOnly:!0})],U.prototype,"allLayerViews",void 0),t.__decorate([n.property()],U.prototype,"animation",void 0),t.__decorate([n.property()],U.prototype,"basemapView",void 0),t.__decorate([n.property()],U.prototype,"defaultsFromMap",void 0),t.__decorate([n.property()],U.prototype,"fatalError",void 0),t.__decorate([n.property({type:g})],U.prototype,"extent",void 0),t.__decorate([n.property(C.graphicsCollectionProperty())],U.prototype,"graphics",void 0),t.__decorate([n.property({readOnly:!0,type:I,dependsOn:["map.heightModelInfo?","defaultsFromMap.heightModelInfo"],autoTracked:!1})],U.prototype,"heightModelInfo",null),t.__decorate([n.property({readOnly:!0,dependsOn:["navigating"]})],U.prototype,"interacting",null),t.__decorate([n.property({readOnly:!0})],U.prototype,"navigating",void 0),t.__decorate([n.property({readOnly:!0,dependsOn:["fatalError","_isValid","_readyCycleForced","map","map.loaded?","width","height","spatialReference","_currentSpatialReference","initialExtentRequired","initialExtent","defaultsFromMap.isSpatialReferenceDone","defaultsFromMap.isTileInfoDone"],autoTracked:!1})],U.prototype,"preconditionsReady",null),t.__decorate([n.property({type:v,readOnly:!0})],U.prototype,"layerViews",void 0),t.__decorate([n.property({type:L})],U.prototype,"magnifier",void 0),t.__decorate([n.property({value:null,type:F})],U.prototype,"map",null),t.__decorate([n.property()],U.prototype,"padding",void 0),t.__decorate([n.property({readOnly:!0})],U.prototype,"ready",void 0),t.__decorate([n.property({type:w,dependsOn:["defaultsFromMap.spatialReference","defaultsFromMap.vcsWkid","defaultsFromMap.latestVcsWkid"]})],U.prototype,"spatialReference",null),t.__decorate([n.property()],U.prototype,"spatialReferenceWarningDelay",void 0),t.__decorate([n.property({dependsOn:["animation","navigating","resizing"]})],U.prototype,"stationary",null),t.__decorate([n.property({readOnly:!0})],U.prototype,"supportsGround",void 0),t.__decorate([n.property({type:O})],U.prototype,"timeExtent",void 0),t.__decorate([s.aliasOf("toolViewManager.tools")],U.prototype,"tools",void 0),t.__decorate([n.property()],U.prototype,"toolViewManager",void 0),t.__decorate([n.property({readOnly:!0})],U.prototype,"type",void 0),t.__decorate([n.property({type:Number})],U.prototype,"scale",void 0),t.__decorate([n.property({readOnly:!0})],U.prototype,"updating",void 0),t.__decorate([n.property({readOnly:!0})],U.prototype,"initialExtentRequired",void 0),t.__decorate([n.property({readOnly:!0,type:g,dependsOn:["defaultsFromMap.extent"]})],U.prototype,"initialExtent",null),t.__decorate([n.property({dependsOn:["toolViewManager.cursor"]})],U.prototype,"cursor",null),t.__decorate([n.property()],U.prototype,"renderContext",void 0),t.__decorate([n.property({readOnly:!0})],U.prototype,"input",void 0),t.__decorate([n.property({type:q,nonNullable:!0})],U.prototype,"navigation",void 0),t.__decorate([n.property()],U.prototype,"layerViewManager",void 0),t.__decorate([n.property()],U.prototype,"width",void 0),t.__decorate([n.property()],U.prototype,"height",void 0),t.__decorate([n.property({readOnly:!0})],U.prototype,"resizing",void 0),t.__decorate([n.property({value:null,dependsOn:["width","height"],readOnly:!0})],U.prototype,"size",null),t.__decorate([n.property({readOnly:!0})],U.prototype,"suspended",void 0),t.__decorate([n.property({readOnly:!0})],U.prototype,"viewEvents",void 0),t.__decorate([n.property({readOnly:!0})],U.prototype,"persistableViewModels",void 0),t.__decorate([n.property()],U.prototype,"_isValid",void 0),t.__decorate([n.property()],U.prototype,"_readyCycleForced",void 0),t.__decorate([n.property()],U.prototype,"_currentSpatialReference",void 0),U=W=t.__decorate([l.subclass("esri.views.View")],U),U}));
