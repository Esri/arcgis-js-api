/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../Map","../TimeExtent","../core/Accessor","../core/Collection","../core/CollectionFlattener","../core/Error","../core/Evented","../core/HandleOwner","../core/Loadable","../core/Logger","../core/maybe","../core/Promise","../core/promiseUtils","../core/scheduling","../core/watchUtils","../core/accessorSupport/decorators/aliasOf","../core/has","../core/accessorSupport/ensureType","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/subclass","../geometry/Extent","../geometry/HeightModelInfo","../geometry/SpatialReference","../geometry/support/spatialReferenceUtils","../support/GraphicsCollection","./BasemapView","./LayerViewManager","./Magnifier","./ToolViewManager","./input/Input","./input/ViewEvents","./navigation/Navigation","./support/DefaultsFromMap"],(function(e,t,r,i,o,a,n,s,l,p,d,c,y,u,h,f,_,w,g,v,m,M,V,R,F,E,O,b,S,I,C,L,x,T,k){"use strict";var D;const z=c.getLogger("esri.views.View");let q=D=function(t){function r(r){var i;return(i=t.call(this,r)||this)._userSpatialReference=null,i._cursor=null,i.allLayerViews=new n({getCollections:()=>{var e,t,r;return[null==(e=i.basemapView)?void 0:e.baseLayerViews,null==(t=i.groundView)?void 0:t.layerViews,i.layerViews,null==(r=i.basemapView)?void 0:r.referenceLayerViews]},getChildrenFunction:e=>e.layerViews}),i.groundView=null,i.animation=null,i.basemapView=null,i.defaultsFromMap=new k({view:e._assertThisInitialized(i)}),i.fatalError=null,i.extent=null,i.graphics=new O.default,i.navigating=!1,i.layerViews=new a,i.magnifier=new I,i.padding={left:0,top:0,right:0,bottom:0},i.ready=!1,i.spatialReferenceWarningDelay=1e3,i.supportsGround=!0,i.timeExtent=null,i.type=null,i.scale=null,i.updating=!1,i.initialExtentRequired=!0,i.input=new L,i.navigation=new T,i.layerViewManager=null,i.isHeightModelInfoRequired=!1,i.width=null,i.height=null,i.resizing=!1,i.suspended=!1,i.viewEvents=new x.ViewEvents(e._assertThisInitialized(i)),i.persistableViewModels=new a,i._isValid=!1,i._readyCycleForced=!1,i.handles.add(i.watch("preconditionsReady",(t=>{t?(i._currentSpatialReference=i.spatialReference,D.views.add(e._assertThisInitialized(i))):(i._currentSpatialReference=null,D.views.remove(e._assertThisInitialized(i))),i.notifyChange("spatialReference"),!t&&i.ready?(i.layerViewManager.clear(),i.toolViewManager.detach(),i._teardown()):t&&!i.ready&&(i._startup(),i.toolViewManager.attach())}),!0)),i}e._inheritsLoose(r,t);var i=r.prototype;return i.initialize=function(){let e;this.addResolvingPromise(this.validate().then((()=>(this._isValid=!0,_.whenOnce(this,"ready"))))),this.basemapView=new b.BasemapView({view:this}),this.layerViewManager=new S({view:this,layerViewImporter:{importLayerView:e=>this.importLayerView(e),hasLayerViewModule:e=>this.hasLayerViewModule(e)},supportsGround:this.supportsGround}),this.toolViewManager=new C({view:this}),this._resetInitialViewPropertiesFromContent(),_.init(this.defaultsFromMap,"isSpatialReferenceDone",(t=>{const r=!!(this.map&&this.map.allLayers.length>0);if(t&&!this.spatialReference&&r||!e){if(t&&!this.spatialReference&&r&&!e){const t=e=h.after(this.spatialReferenceWarningDelay);e.then((()=>{t===e&&z.warn("#spatialReference","no spatial reference could be derived from the currently added map layers")})).catch((()=>{}))}}else e=null}),!0)},i.destroy=function(){if(this.destroyed)return;this.viewEvents.destroy(),this.allLayerViews.destroy(),this.navigation&&(this.navigation.destroy(),this._set("navigation",null)),this.graphics=y.destroyMaybe(this.graphics),this.handles.remove("defaultsFromMap"),this.defaultsFromMap.destroy(),this._set("defaultsFromMap",null),this.toolViewManager=y.destroyMaybe(this.toolViewManager),this.layerViewManager=y.destroyMaybe(this.layerViewManager),this.basemapView=y.destroyMaybe(this.basemapView),this.invalidate(),this._emitter.clear(),this.handles.removeAll();const e=this.map;this.map=null,null==e||e.destroy()},i._startup=function(){this._set("ready",!0)},i._teardown=function(){this._set("ready",!1)},i.whenReady=function(){return Promise.resolve(this)},i.toMap=function(){return z.error("#toMap()","Not implemented on this instance of View"),null},i.whenLayerView=function(e){return this.layerViewManager.whenLayerView(e)},i.getDefaultSpatialReference=function(){return this.get("defaultsFromMap.spatialReference")},i.getDefaultHeightModelInfo=function(){return this.get("map.supportsHeightModelInfo")&&this.get("map.heightModelInfo")||this.get("defaultsFromMap.heightModelInfo")||null},i.importLayerView=function(e){throw new s("importLayerView() not implemented")},i.hasLayerViewModule=function(e){return!1},i.validate=function(){var t=e._asyncToGenerator((function*(){}));function r(){return t.apply(this,arguments)}return r}(),i.invalidate=function(){this._isValid=!1},i.isSpatialReferenceSupported=function(e,t,r){return!0},i.isTileInfoRequired=function(){return!1},i.when=function(e,r){return this.isResolved()&&!this.ready&&z.warn("#when()",'Calling view.when() while the view is no longer ready but was already resolved once will resolve immediately. Use watchUtils.whenOnce(view, "ready").then(...) instead.'),t.prototype.when.call(this,e,r)},i.forceReadyCycle=function(){this.ready&&(this._readyCycleForced=!0,_.whenFalseOnce(this,"preconditionsReady",(()=>this._readyCycleForced=!1)))},i.addAndActivateTool=function(e){this.toolViewManager.tools.add(e),this.activeTool=e},i.tryFatalErrorRecovery=function(){this.fatalError=null},i._resetInitialViewPropertiesFromContent=function(){if(!this.defaultsFromMap)return;const e=()=>this.defaultsFromMap&&this.defaultsFromMap.start();this.defaultsFromMap.reset(),this._currentSpatialReference=null,this.notifyChange("spatialReference"),this.handles.remove("defaultsFromMap"),this.handles.add([_.watch(this,"spatialReference",((t,r)=>{E.equals(t,r)||e()})),_.watch(this,"initialExtentRequired",e),f.schedule(e)],"defaultsFromMap")},e._createClass(r,[{key:"heightModelInfo",get:function(){return this.getDefaultHeightModelInfo()}},{key:"interacting",get:function(){return this.navigating}},{key:"preconditionsReady",get:function(){return!!(!this.fatalError&&this._isValid&&!this._readyCycleForced&&this.map&&(!d.isLoadable(this.map)||this.map.loaded)&&0!==this.width&&0!==this.height&&this.spatialReference&&this.isSpatialReferenceSupported(this.spatialReference)&&(this._currentSpatialReference||!this.initialExtentRequired||this.initialExtent||this.defaultsFromMap&&this.defaultsFromMap.isSpatialReferenceDone)&&this.defaultsFromMap&&this.defaultsFromMap.isTileInfoDone)}},{key:"map",set:function(e){var t;e!==this._get("map")&&(null!=(t=e)&&t.destroyed&&(z.warn("#map","The provided map is already destroyed",{map:e}),e=null),d.isLoadable(e)&&e.load().catch((()=>{})),this.initialized&&(this.forceReadyCycle(),this._resetInitialViewPropertiesFromContent()),this._set("map",e))}},{key:"spatialReference",get:function(){let e=this._userSpatialReference||this._currentSpatialReference||this.getDefaultSpatialReference()||null;return e&&this.isHeightModelInfoRequired&&this.defaultsFromMap&&(e=e.clone(),e.vcsWkid=this.defaultsFromMap.vcsWkid,e.latestVcsWkid=this.defaultsFromMap.latestVcsWkid),e},set:function(e){this._userSpatialReference=e,this._set("spatialReference",e)}},{key:"stationary",get:function(){return!this.animation&&!this.navigating&&!this.resizing}},{key:"initialExtent",get:function(){return this.defaultsFromMap&&this.defaultsFromMap.extent}},{key:"cursor",get:function(){const e=this.toolViewManager?this.toolViewManager.cursor:null;return y.isSome(e)?e:this._cursor||"default"},set:function(e){this._cursor=e,this.notifyChange("cursor")}},{key:"size",get:function(){return[this.width,this.height]}}]),r}(p.HandleOwnerMixin(l.EventedMixin(u.EsriPromiseMixin(o))));return q.views=new a,t.__decorate([w.aliasOf("toolViewManager.activeTool")],q.prototype,"activeTool",void 0),t.__decorate([m.property({readOnly:!0})],q.prototype,"allLayerViews",void 0),t.__decorate([m.property()],q.prototype,"groundView",void 0),t.__decorate([m.property()],q.prototype,"animation",void 0),t.__decorate([m.property()],q.prototype,"basemapView",void 0),t.__decorate([m.property()],q.prototype,"defaultsFromMap",void 0),t.__decorate([m.property()],q.prototype,"fatalError",void 0),t.__decorate([m.property({type:V})],q.prototype,"extent",void 0),t.__decorate([m.property(O.graphicsCollectionProperty())],q.prototype,"graphics",void 0),t.__decorate([m.property({readOnly:!0,type:R,dependsOn:["map.heightModelInfo?","defaultsFromMap.heightModelInfo"]})],q.prototype,"heightModelInfo",null),t.__decorate([m.property({readOnly:!0})],q.prototype,"interacting",null),t.__decorate([m.property({readOnly:!0})],q.prototype,"navigating",void 0),t.__decorate([m.property({readOnly:!0,dependsOn:["fatalError","_isValid","_readyCycleForced","map","map.loaded?","width","height","spatialReference","_currentSpatialReference","initialExtentRequired","initialExtent","defaultsFromMap.isSpatialReferenceDone","defaultsFromMap.isTileInfoDone"]})],q.prototype,"preconditionsReady",null),t.__decorate([m.property({type:a,readOnly:!0})],q.prototype,"layerViews",void 0),t.__decorate([m.property({type:I})],q.prototype,"magnifier",void 0),t.__decorate([m.property({value:null,type:r})],q.prototype,"map",null),t.__decorate([m.property()],q.prototype,"padding",void 0),t.__decorate([m.property({readOnly:!0})],q.prototype,"ready",void 0),t.__decorate([m.property({type:F})],q.prototype,"spatialReference",null),t.__decorate([m.property()],q.prototype,"spatialReferenceWarningDelay",void 0),t.__decorate([m.property()],q.prototype,"stationary",null),t.__decorate([m.property({readOnly:!0})],q.prototype,"supportsGround",void 0),t.__decorate([m.property({type:i})],q.prototype,"timeExtent",void 0),t.__decorate([w.aliasOf("toolViewManager.tools")],q.prototype,"tools",void 0),t.__decorate([m.property()],q.prototype,"toolViewManager",void 0),t.__decorate([m.property({readOnly:!0})],q.prototype,"type",void 0),t.__decorate([m.property({type:Number})],q.prototype,"scale",void 0),t.__decorate([m.property({readOnly:!0})],q.prototype,"updating",void 0),t.__decorate([m.property({readOnly:!0})],q.prototype,"initialExtentRequired",void 0),t.__decorate([m.property({readOnly:!0,type:V})],q.prototype,"initialExtent",null),t.__decorate([m.property()],q.prototype,"cursor",null),t.__decorate([m.property({readOnly:!0})],q.prototype,"input",void 0),t.__decorate([m.property({type:T,nonNullable:!0})],q.prototype,"navigation",void 0),t.__decorate([m.property()],q.prototype,"layerViewManager",void 0),t.__decorate([m.property()],q.prototype,"width",void 0),t.__decorate([m.property()],q.prototype,"height",void 0),t.__decorate([m.property({readOnly:!0})],q.prototype,"resizing",void 0),t.__decorate([m.property({value:null,readOnly:!0})],q.prototype,"size",null),t.__decorate([m.property({readOnly:!0})],q.prototype,"suspended",void 0),t.__decorate([m.property({readOnly:!0})],q.prototype,"viewEvents",void 0),t.__decorate([m.property({readOnly:!0})],q.prototype,"persistableViewModels",void 0),t.__decorate([m.property()],q.prototype,"_isValid",void 0),t.__decorate([m.property()],q.prototype,"_readyCycleForced",void 0),t.__decorate([m.property()],q.prototype,"_currentSpatialReference",void 0),q=D=t.__decorate([M.subclass("esri.views.View")],q),q}));
