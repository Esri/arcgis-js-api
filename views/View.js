// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../Map","../TimeExtent","../core/Accessor","../core/Collection","../core/CollectionFlattener","../core/Error","../core/Evented","../core/HandleOwner","../core/Loadable","../core/Logger","../core/maybe","../core/Promise","../core/promiseUtils","../core/scheduling","../core/watchUtils","../core/accessorSupport/decorators","../geometry/Extent","../geometry/HeightModelInfo","../geometry/SpatialReference","../geometry/support/spatialReferenceUtils","../support/GraphicsCollection","./BasemapView","./LayerViewManager","./RefreshManager","./ToolViewManager","./input/Input","./input/ViewEvents","./navigation/Navigation","./support/DefaultsFromMap"],(function(e,t,r,o,i,a,n,p,l,s,d,c,y,u,h,f,_,g,w,m,v,M,V,R,b,F,O,E,x,C,S,L){"use strict";var I=y.getLogger("esri.views.View");return function(e){function t(t){var r=e.call(this,t)||this;return r._userSpatialReference=null,r._cursor=null,r.allLayerViews=new p({root:r,rootCollectionNames:["basemapView.baseLayerViews","groundView?.layerViews","layerViews","basemapView.referenceLayerViews"],getChildrenFunction:function(e){return e.layerViews}}),r.animation=null,r.basemapView=null,r.defaultsFromMap=new L({view:r}),r.fatalError=null,r.extent=null,r.graphics=new R.default,r.navigating=!1,r.layerViews=new n,r.padding={left:0,top:0,right:0,bottom:0},r.ready=!1,r.spatialReferenceWarningDelay=1e3,r.timeExtent=null,r.type=null,r.scale=null,r.updating=!1,r.initialExtentRequired=!0,r.renderContext=null,r.input=new x,r.navigation=new S,r.layerViewManager=null,r.refreshManager=null,r.isHeightModelInfoRequired=!1,r.width=null,r.height=null,r.resizing=!1,r.suspended=!1,r.viewEvents=new C.ViewEvents(r),r._isValid=!1,r._readyCycleForced=!1,r.handles.add(r.watch("preconditionsReady",(function(e){e?(r._currentSpatialReference=r.spatialReference,a.views.add(r)):(r._currentSpatialReference=null,a.views.remove(r)),r.notifyChange("spatialReference"),!e&&r.ready?(r.layerViewManager.clear(),r.toolViewManager.detach(),r._teardown()):e&&!r.ready&&(r._startup(),r.toolViewManager.attach())}),!0)),r}var a;return r.__extends(t,e),a=t,t.prototype.initialize=function(){var e,t=this;this.addResolvingPromise(this.validate().then((function(){return t._isValid=!0,g.whenOnce(t,"ready")}))),this.basemapView=new b.BasemapView({view:this}),this.layerViewManager=new F.default({view:this,layerViewImporter:{importLayerView:function(e){return t.importLayerView(e)},hasLayerViewModule:function(e){return t.hasLayerViewModule(e)}}}),this.refreshManager=new O({view:this}),this.toolViewManager=new E({view:this}),this._resetInitialViewPropertiesFromContent(),g.init(this.defaultsFromMap,"isSpatialReferenceDone",(function(r){var o=!!(t.map&&t.map.allLayers.length>0);if(r&&!t.spatialReference&&o||!e){if(r&&!t.spatialReference&&o&&!e){var i=e=f.after(t.spatialReferenceWarningDelay);e.then((function(){i===e&&I.warn("#spatialReference","no spatial reference could be derived from the currently added map layers")})).catch((function(){}))}}else e=null}),!0)},t.prototype.destroy=function(){if(!this.destroyed){this.viewEvents.destroy(),this.allLayerViews.destroy(),this.navigation&&(this.navigation.destroy(),this._set("navigation",null)),this.graphics.destroy(),this.graphics=null,this.handles.remove("defaultsFromMap"),this.defaultsFromMap.destroy(),this._set("defaultsFromMap",null),this.toolViewManager.destroy(),this.toolViewManager=null,this.refreshManager.destroy(),this.refreshManager=null,this.layerViewManager.destroy(),this.layerViewManager=null,this.basemapView.destroy(),this.basemapView=null,this.invalidate(),this._emitter.clear(),this.handles.removeAll();var e=this.map;this.map=null,null==e||e.destroy()}},t.prototype._startup=function(){this._set("ready",!0)},t.prototype._teardown=function(){this._set("ready",!1)},t.prototype.whenReady=function(){return f.resolve()},t.prototype.toMap=function(){return I.error("#toMap()","Not implemented on this instance of View"),null},Object.defineProperty(t.prototype,"heightModelInfo",{get:function(){return this.getDefaultHeightModelInfo()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"interacting",{get:function(){return this.navigating},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"preconditionsReady",{get:function(){return!!(!this.fatalError&&this._isValid&&!this._readyCycleForced&&this.map&&(!c.isLoadable(this.map)||this.map.loaded)&&0!==this.width&&0!==this.height&&this.spatialReference&&this.isSpatialReferenceSupported(this.spatialReference)&&(this._currentSpatialReference||!this.initialExtentRequired||this.initialExtent||this.defaultsFromMap&&this.defaultsFromMap.isSpatialReferenceDone)&&this.defaultsFromMap&&this.defaultsFromMap.isTileInfoDone)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"map",{set:function(e){e!==this._get("map")&&((null==e?void 0:e.destroyed)&&(I.warn("#map","The provided map is already destroyed",{map:e}),e=null),c.isLoadable(e)&&e.load().catch((function(){})),this.initialized&&(this.forceReadyCycle(),this._resetInitialViewPropertiesFromContent()),this._set("map",e))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"spatialReference",{get:function(){var e=this._userSpatialReference||this._currentSpatialReference||this.getDefaultSpatialReference()||null;return e&&this.isHeightModelInfoRequired&&this.defaultsFromMap&&((e=e.clone()).vcsWkid=this.defaultsFromMap.vcsWkid,e.latestVcsWkid=this.defaultsFromMap.latestVcsWkid),e},set:function(e){this._userSpatialReference=e,this._set("spatialReference",e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"stationary",{get:function(){return!this.animation&&!this.navigating&&!this.resizing},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"initialExtent",{get:function(){return this.defaultsFromMap&&this.defaultsFromMap.extent},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"cursor",{get:function(){var e=this.toolViewManager?this.toolViewManager.cursor:null;return u.isSome(e)?e:this._cursor||"default"},set:function(e){this._cursor=e,this.notifyChange("cursor")},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"size",{get:function(){return[this.width,this.height]},enumerable:!1,configurable:!0}),t.prototype.whenLayerView=function(e){return this.layerViewManager.whenLayerView(e)},t.prototype.getDefaultSpatialReference=function(){return this.get("defaultsFromMap.spatialReference")},t.prototype.getDefaultHeightModelInfo=function(){return this.get("map.supportsHeightModelInfo")&&this.get("map.heightModelInfo")||this.get("defaultsFromMap.heightModelInfo")||null},t.prototype.importLayerView=function(e){throw new l("importLayerView() not implemented")},t.prototype.hasLayerViewModule=function(e){return!1},t.prototype.validate=function(){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){return[2]}))}))},t.prototype.invalidate=function(){this._isValid=!1},t.prototype.isSpatialReferenceSupported=function(e,t,r){return!0},t.prototype.isTileInfoRequired=function(){return!1},t.prototype.when=function(t,r){return this.isResolved()&&!this.ready&&I.warn("#when()",'Calling view.when() while the view is no longer ready but was already resolved once will resolve immediately. Use watchUtils.whenOnce(view, "ready").then(...) instead.'),e.prototype.when.call(this,t,r)},t.prototype.forceReadyCycle=function(){var e=this;this.ready&&(this._readyCycleForced=!0,g.whenFalseOnce(this,"preconditionsReady",(function(){return e._readyCycleForced=!1})))},t.prototype.createTool=function(e,t,r){return this.toolViewManager.createTool(e,t,r)},t.prototype.tryFatalErrorRecovery=function(){this.fatalError=null},t.prototype._resetInitialViewPropertiesFromContent=function(){var e=this;if(this.defaultsFromMap){var t=function(){return e.defaultsFromMap&&e.defaultsFromMap.start()};this.defaultsFromMap.reset(),this._currentSpatialReference=null,this.notifyChange("spatialReference"),this.handles.remove("defaultsFromMap"),this.handles.add([g.watch(this,"spatialReference",(function(e,r){V.equals(e,r)||t()})),g.watch(this,"initialExtentRequired",t),_.schedule(t)],"defaultsFromMap")}},t.views=new n,r.__decorate([w.aliasOf("toolViewManager.activeTool")],t.prototype,"activeTool",void 0),r.__decorate([w.property({readOnly:!0})],t.prototype,"allLayerViews",void 0),r.__decorate([w.property()],t.prototype,"animation",void 0),r.__decorate([w.property()],t.prototype,"basemapView",void 0),r.__decorate([w.property()],t.prototype,"defaultsFromMap",void 0),r.__decorate([w.property()],t.prototype,"fatalError",void 0),r.__decorate([w.property({type:m})],t.prototype,"extent",void 0),r.__decorate([w.property(R.graphicsCollectionProperty)],t.prototype,"graphics",void 0),r.__decorate([w.property({readOnly:!0,type:v,dependsOn:["map.heightModelInfo?","defaultsFromMap.heightModelInfo"]})],t.prototype,"heightModelInfo",null),r.__decorate([w.property({readOnly:!0,dependsOn:["navigating"]})],t.prototype,"interacting",null),r.__decorate([w.property({readOnly:!0})],t.prototype,"navigating",void 0),r.__decorate([w.property({readOnly:!0,dependsOn:["fatalError","_isValid","_readyCycleForced","map","map.loaded?","width","height","spatialReference","_currentSpatialReference","initialExtentRequired","initialExtent","defaultsFromMap.isSpatialReferenceDone","defaultsFromMap.isTileInfoDone"]})],t.prototype,"preconditionsReady",null),r.__decorate([w.property({type:n,readOnly:!0})],t.prototype,"layerViews",void 0),r.__decorate([w.property({value:null,type:o})],t.prototype,"map",null),r.__decorate([w.property()],t.prototype,"padding",void 0),r.__decorate([w.property({readOnly:!0})],t.prototype,"ready",void 0),r.__decorate([w.property({type:M,dependsOn:["defaultsFromMap.spatialReference","defaultsFromMap.vcsWkid","defaultsFromMap.latestVcsWkid"]})],t.prototype,"spatialReference",null),r.__decorate([w.property()],t.prototype,"spatialReferenceWarningDelay",void 0),r.__decorate([w.property({dependsOn:["animation","navigating","resizing"]})],t.prototype,"stationary",null),r.__decorate([w.property({type:i})],t.prototype,"timeExtent",void 0),r.__decorate([w.aliasOf("toolViewManager.tools")],t.prototype,"tools",void 0),r.__decorate([w.property()],t.prototype,"toolViewManager",void 0),r.__decorate([w.property({readOnly:!0})],t.prototype,"type",void 0),r.__decorate([w.property({type:Number})],t.prototype,"scale",void 0),r.__decorate([w.property({readOnly:!0})],t.prototype,"updating",void 0),r.__decorate([w.property({readOnly:!0})],t.prototype,"initialExtentRequired",void 0),r.__decorate([w.property({readOnly:!0,type:m,dependsOn:["defaultsFromMap.extent"]})],t.prototype,"initialExtent",null),r.__decorate([w.property({dependsOn:["toolViewManager.cursor"]})],t.prototype,"cursor",null),r.__decorate([w.property()],t.prototype,"renderContext",void 0),r.__decorate([w.property({readOnly:!0})],t.prototype,"input",void 0),r.__decorate([w.property({type:S,nonNullable:!0})],t.prototype,"navigation",void 0),r.__decorate([w.property()],t.prototype,"layerViewManager",void 0),r.__decorate([w.property()],t.prototype,"width",void 0),r.__decorate([w.property()],t.prototype,"height",void 0),r.__decorate([w.property({readOnly:!0})],t.prototype,"resizing",void 0),r.__decorate([w.property({value:null,dependsOn:["width","height"],readOnly:!0})],t.prototype,"size",null),r.__decorate([w.property({readOnly:!0})],t.prototype,"suspended",void 0),r.__decorate([w.property({readOnly:!0})],t.prototype,"viewEvents",void 0),r.__decorate([w.property()],t.prototype,"_isValid",void 0),r.__decorate([w.property()],t.prototype,"_readyCycleForced",void 0),r.__decorate([w.property()],t.prototype,"_currentSpatialReference",void 0),t=a=r.__decorate([w.subclass("esri.views.View")],t)}(d.HandleOwnerMixin(s.EventedMixin(h.EsriPromiseMixin(a))))}));