// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.5/esri/copyright.txt for details.

define(["require","exports","../2d/engine/webgl/Geometry","./GeometryUtils","./Conflict"],function(t,e,n,i,o){Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e,n,i,o){void 0===n&&(n=0),void 0===i&&(i=-1),void 0===o&&(o=c),this.x=t,this.y=e,this.angle=n,this.segment=i,this.minzoom=o}return t}();e.Anchor=r;var a=function(){function t(t,e,n){this.glyph=t,this.x=e,this.y=n}return t}();e.ShapedGlyph=a;var l=function(){function t(t,e,n,o,r,a,l){void 0===r&&(r=!1),void 0===a&&(a=c),void 0===l&&(l=i.C_INFINITY),this.anchor=t,this.labelAngle=e,this.glyphAngle=n,this.page=o,this.upsideDown=r,this.minzoom=a,this.maxzoom=l}return t}(),h=function(){function t(t,e,n,i,o,r,a,l,h,s){this.tl=t,this.tr=e,this.bl=n,this.br=i,this.mosaicRect=o,this.labelAngle=r,this.anchor=a,this.minzoom=l,this.maxzoom=h,this.page=s}return t}();e.PlacedSymbol=h;var s=function(){function t(t,e){this.footprint=t,this.shapes=e}return t}();e.Placement=s;var c=.5,p=2,g=function(){function t(){this.mapAngle=0,this._conflictEngine=new o.ConflictEngine}return t.prototype.reset=function(){this._conflictEngine.reset()},t.prototype.setAngle=function(t){this.mapAngle=t,this._conflictEngine.setAngle(t)},t.prototype.getIconPlacement=function(t,e,r,a,l,p){var g=e.width/e.pixelRatio,m=e.height/e.pixelRatio,f=l.offset[0]-g/2,u=l.offset[1]-m/2,I=f+g,d=u+m,y=e.rect,x=f-2,_=u-2,w=x+y.width/e.pixelRatio,v=_+y.height/e.pixelRatio,N=new n.Point(x,_),P=new n.Point(w,v),A=new n.Point(x,v),E=new n.Point(w,_),T=l.rotate*i.C_DEG_TO_RAD,b=1===l.rotationAlignment;if(t.segment>=0&&!b&&(T+=t.angle),0!==T){var C=Math.cos(T),M=Math.sin(T);N.rotate(C,M),P.rotate(C,M),A.rotate(C,M),E.rotate(C,M)}var z=8,F=l.padding*z,G=new n.Point(t.x,t.y),Y=new o.Footprint(this.mapAngle,F,b);Y.addBox(G,new o.Box(f,u,I,d),r,T,c,i.C_INFINITY);var B=new h(N,E,A,P,y,0,G,c,i.C_INFINITY,0),O=new s(Y,[B]),R=c;return l.allowOverlap||(R=this._conflictEngine.getMinZoom(O.footprint,R,p,b)),Y.minzoom=R,O},t.prototype.getTextPlacement=function(t,e,r,a,g,m,f,u){for(var I,d=new n.Point(t.x,t.y),y=f.rotate*i.C_DEG_TO_RAD,x=0===f.rotationAlignment,_=f.keepUpright,w=c,v=!x,N=v?0:t.angle,P=t.segment>=0&&x,A=8,E=f.padding*A,T=new o.Footprint(this.mapAngle,E,v),b=[],C=4,M=!P,z=Number.POSITIVE_INFINITY,F=Number.NEGATIVE_INFINITY,G=z,Y=F,B=P?_:x&&_,O=[],R=0,D=r;R<D.length;R++){var q=D[R],S=a[q.glyph];if(S&&!S.rect.isEmpty){var V=S.rect,k=S.metrics,U=S.page;M&&(I&&I!==q.y&&(T.addBox(d,new o.Box(z,G,F,Y),g,y,c,i.C_INFINITY),z=Number.POSITIVE_INFINITY,F=Number.NEGATIVE_INFINITY,G=z,Y=F),I=q.y);var Z=[];if(P){var j=.5*S.metrics.width,H=(e.x+q.x+k.left-C+j)*g;if(w=this._placeGlyph(t,w,H,m,t.segment,1,U,Z),_&&(w=this._placeGlyph(t,w,H,m,t.segment,-1,U,Z)),w>=p)break}else Z.push(new l(d,N,N,U)),x&&_&&Z.push(new l(d,N+i.C_PI,N+i.C_PI,U,!0));for(var J=q.x+e.x+k.left,K=q.y+e.y-k.top,L=J+k.width,Q=K+k.height,W=new n.Point(J-C,K-C),X=new n.Point(W.x+V.width,W.y+V.height),$=new n.Point(W.x,X.y),tt=new n.Point(X.x,W.y),et=0,nt=Z;et<nt.length;et++){var it=nt[et],ot=W.clone(),rt=$.clone(),at=tt.clone(),lt=X.clone(),ht=K,st=Q,ct=it.glyphAngle+y;if(0!==ct){var pt=Math.cos(ct),gt=Math.sin(ct);ot.rotate(pt,gt),lt.rotate(pt,gt),rt.rotate(pt,gt),at.rotate(pt,gt)}b.push(new h(ot,at,rt,lt,V,it.labelAngle,it.anchor,it.minzoom,it.maxzoom,it.page)),(!B||this._legible(it.labelAngle))&&(M?(z>J&&(z=J),G>ht&&(G=ht),L>F&&(F=L),st>Y&&(Y=st)):it.minzoom<p&&T.addBox(it.anchor,new o.Box(J,ht,L,st),g,ct,it.minzoom,it.maxzoom)),O.push(it)}}}if(w>=p)return null;M&&T.addBox(d,new o.Box(z,G,F,Y),g,y,c,i.C_INFINITY);var mt=new s(T,b);return f.allowOverlap||(w=this._conflictEngine.getMinZoom(mt.footprint,w,u,v)),T.minzoom=w,mt},t.prototype.add=function(t){this._conflictEngine.add(t.footprint)},t.prototype._legible=function(t){var e=i.radToByte(t);return 65>e||e>=193},t.prototype._placeGlyph=function(t,e,o,r,a,h,s,c){var p=h,g=0>p?i.positiveMod(t.angle+i.C_PI,i.C_2PI):t.angle,m=this._legible(g),f=0;0>o&&(p*=-1,o*=-1,f=i.C_PI),p>0&&++a;var u=new n.Point(t.x,t.y),I=r[a],d=i.C_INFINITY;if(r.length<=a)return d;for(;;){var y=I.x-u.x,x=I.y-u.y,_=Math.sqrt(y*y+x*x),w=Math.max(o/_,e),v=y/_,N=x/_,P=i.positiveMod(Math.atan2(N,v)+f,i.C_2PI);if(c.push(new l(u,g,P,s,m,w,d)),e>=w)return w;u=I.clone();do{if(a+=p,r.length<=a||0>a)return w;I=r[a]}while(u.isEqual(I));var A=I.x-u.x,E=I.y-u.y,T=Math.sqrt(A*A+E*E);A*=_/T,E*=_/T,u.x-=A,u.y-=E,d=w}},t}();e.PlacementEngine=g});