/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../Graphic","../../core/Error","../../core/maybe","../../core/accessorSupport/decorators/property","../../core/arrayUtils","../../core/has","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass","../../layers/support/commonProperties","../../layers/support/rasterFunctions/rasterProjectionHelper","./support/popupUtils"],(function(e,t,r,i,o,n,a,s,l,u,p,c,f,m){"use strict";const y=e=>{let s=function(e){function r(){var t;return(t=e.apply(this,arguments)||this)._rasterFieldPrefix="Raster.",t.layer=null,t.view=null,t.fullExtent=null,t.tileInfo=null,t.datumTransformation=null,t}t._inheritsLoose(r,e);var a=r.prototype;return a.fetchPopupFeatures=function(){var e=t._asyncToGenerator((function*(e,t){const{layer:r}=this;if(!e)return Promise.reject(new o("imageryTileLayerView:fetchPopupFeatures","Nothing to fetch without area",{layer:r}));const{popupEnabled:a}=r,s=m.getFetchPopupTemplate(r,t);if(!a||!n.isSome(s))throw new o("imageryTileLayerView:fetchPopupFeatures","Missing required popupTemplate or popupEnabled",{popupEnabled:a,popupTemplate:s});const l=[],{value:u,magdirValue:p}=yield r.identify(e,{timeExtent:this.timeExtent});let c="";if(u&&u.length){var f,y;c="imagery-tile"===r.type&&r.hasStandardTime()&&null!=u[0]?u.map((e=>r.getStandardTimeValue(e))).join(", "):u.join(", ");const e={ObjectId:0},t="Raster.ServicePixelValue";e[t]=this._formatAttributeValue(c,t);const o=null==(f=r.rasterInfo)||null==(y=f.attributeTable)?void 0:y.features;if(o&&o.length>0){const t=o.filter((e=>{const t=e.attributes.value||e.attributes.Value||e.attributes.VALUE;return String(t)===c}));if(t.length>0){const r=t[0];if(r)for(const t in r.attributes)if(r.attributes.hasOwnProperty(t)){const i=this._rasterFieldPrefix+t;e[i]=this._formatAttributeValue(r.attributes[t],i)}}}const n=r.rasterInfo.dataType;"vector-magdir"!==n&&"vector-uv"!==n||(e["Raster.Magnitude"]=null==p?void 0:p[0],e["Raster.Direction"]=null==p?void 0:p[1]);const a=new i(this.fullExtent.clone(),null,e);a.layer=r,a.sourceLayer=a.layer,l.push(a)}return l}));function r(t,r){return e.apply(this,arguments)}return r}(),a.updateFullExtent=function(){const e=this.layer.tileInfo;if(!(e&&e.spatialReference))return Promise.reject(new o("layerview:tiling-information-missing","The layer doesn't provide tiling information",{layer:this.layer}));if(n.isNone(this.layer.fullExtent))return Promise.reject(new o("layerview:extent-missing","The layer doesn't provide a full extent.",{layer:this.layer}));const t=f.getDefaultDatumTransformationForDataset(this.layer.fullExtent,this.view.spatialReference,!1),r=f.projectExtent(this.layer.fullExtent,this.view.spatialReference,t);return null==r?Promise.reject(new o("layerview:projection-not-supported","The layer extent cannot be projected to the view's spatial reference",{layer:this.layer})):(this._set("fullExtent",r),this.datumTransformation||(this.datumTransformation=f.getDefaultDatumTransformationForDataset(this.layer.fullExtent,this.view.spatialReference,!0)),Promise.resolve())},a._formatAttributeValue=function(e,t){if("string"==typeof e){const r=this.layer.popupTemplate&&this.layer.popupTemplate.fieldInfos,i=this._getFieldInfo(r,t),o=i&&i.format;if(o){let t,r;return e.trim().indexOf(",")>-1?(t=",",r=t+" ",this._formatDelimitedString(e,t,r,o)):e.trim().indexOf(" ")>-1?(t=r=" ",this._formatDelimitedString(e,t,r,o)):this._formatNumberFromString(e,o)}}return e},a._getFieldInfo=function(e,t){if(!e||!e.length||!t)return;const r=t.toLowerCase();let i;return e.some((e=>!(!e.fieldName||e.fieldName.toLowerCase()!==r&&e.fieldName.toLowerCase()!==r.replace(/ /g,"_"))&&(i=e,!0))),i},a._formatDelimitedString=function(e,t,r,i){return e&&t&&r&&i?e.trim().split(t).map((e=>this._formatNumberFromString(e,i))).join(r):e},a._formatNumberFromString=function(e,t){if(!e||!t)return e;const r=Number(e);return isNaN(r)?e:t.format(r)},t._createClass(r,[{key:"hasTilingEffects",get:function(){return this.layer.renderer&&"dynamicRangeAdjustment"in this.layer.renderer&&this.layer.renderer.dynamicRangeAdjustment}}]),r}(e);return r.__decorate([a.property()],s.prototype,"layer",void 0),r.__decorate([a.property(c.combinedViewLayerTimeExtentProperty)],s.prototype,"timeExtent",void 0),r.__decorate([a.property()],s.prototype,"view",void 0),r.__decorate([a.property()],s.prototype,"fullExtent",void 0),r.__decorate([a.property()],s.prototype,"tileInfo",void 0),r.__decorate([a.property({readOnly:!0})],s.prototype,"hasTilingEffects",null),s=r.__decorate([p.subclass("esri.views.layers.ImageryTileLayerView")],s),s};e.ImageryTileLayerView=y,e.default=y,Object.defineProperty(e,"__esModule",{value:!0})}));
