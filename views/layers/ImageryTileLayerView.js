// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../Graphic","../../core/Error","../../core/maybe","../../core/promiseUtils","../../core/accessorSupport/decorators","../../layers/graphics/data/projectionSupport","../../layers/support/rasterFunctions/rasterProjectionHelper","./support/popupUtils"],(function(e,t,r,i,o,n,a,l,u,s,p){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ImageryTileLayerView=void 0,t.ImageryTileLayerView=function(e){return function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._rasterFieldPrefix="Raster.",t.layer=null,t.view=null,t.fullExtent=null,t.tileInfo=null,t.datumTransformation=null,t}return r.__extends(t,e),Object.defineProperty(t.prototype,"hasTilingEffects",{get:function(){return this.layer.renderer&&"dynamicRangeAdjustment"in this.layer.renderer&&this.layer.renderer.dynamicRangeAdjustment},enumerable:!1,configurable:!0}),t.prototype.fetchPopupFeatures=function(e,t){var l,u;return r.__awaiter(this,void 0,void 0,(function(){var s,f,c,y,d,m,h,v,_,g,w,b,T;return r.__generator(this,(function(r){switch(r.label){case 0:if(s=this.layer,!e)return[2,a.reject(new o("imageryTileLayerView:fetchPopupFeatures","Nothing to fetch without area",{layer:s}))];if(f=s.popupEnabled,c=p.getFetchPopupTemplate(s,t),!f||!n.isSome(c))throw new o("imageryTileLayerView:fetchPopupFeatures","Missing required popupTemplate or popupEnabled",{popupEnabled:f,popupTemplate:c});return y=[],[4,s.identify(e)];case 1:if(d=r.sent().value){if(m=d.join(", "),"Raster.ServicePixelValue",(h={ObjectId:0})["Raster.ServicePixelValue"]=this._formatAttributeValue(m,"Raster.ServicePixelValue"),(v=null===(u=null===(l=s.rasterInfo)||void 0===l?void 0:l.attributeTable)||void 0===u?void 0:u.features)&&v.length>0&&(_=v.filter((function(e){var t=e.attributes.value||e.attributes.Value||e.attributes.VALUE;return String(t)===m}))).length>0&&(g=_[0]))for(w in g.attributes)g.attributes.hasOwnProperty(w)&&(b=this._rasterFieldPrefix+w,h[b]=this._formatAttributeValue(g.attributes[w],b));(T=new i(this.fullExtent.clone(),null,h)).layer=s,T.sourceLayer=T.layer,y.push(T)}return[2,y]}}))}))},t.prototype.updateFullExtent=function(){var e,t=this.layer.tileInfo;t&&t.spatialReference||(e=new o("layerview:tiling-information-missing","The layer doesn't provide tiling information",{layer:this.layer}));var r=this.view.spatialReference;if(u.doesBrowserSupportProjection(r,this.layer.spatialReference)){var i=s.projectExtent(this.layer.fullExtent,r,this.datumTransformation);null==i&&(e=new o("layerview:projection-not-supported","The layer extent cannot be projected to the view's spatial reference",{layer:this.layer})),this._set("fullExtent",i)}else e=new o("layerview:projection-not-supported","The layer requires projection engine, which is not supported in current browser",{layer:this.layer});return e?a.reject(e):a.resolve()},t.prototype._formatAttributeValue=function(e,t){if("string"==typeof e){var r=this.layer.popupTemplate&&this.layer.popupTemplate.fieldInfos,i=this._getFieldInfo(r,t),o=i&&i.format;if(o){var n=void 0,a=void 0;return e.trim().indexOf(",")>-1?(a=(n=",")+" ",this._formatDelimitedString(e,n,a,o)):e.trim().indexOf(" ")>-1?(n=a=" ",this._formatDelimitedString(e,n,a,o)):this._formatNumberFromString(e,o)}}return e},t.prototype._getFieldInfo=function(e,t){if(e&&e.length&&t){var r=t.toLowerCase(),i=void 0;return e.some((function(e){return!(!e.fieldName||e.fieldName.toLowerCase()!==r&&e.fieldName.toLowerCase()!==r.replace(/ /g,"_"))&&(i=e,!0)})),i}},t.prototype._formatDelimitedString=function(e,t,r,i){var o=this;return e&&t&&r&&i?e.trim().split(t).map((function(e){return o._formatNumberFromString(e,i)})).join(r):e},t.prototype._formatNumberFromString=function(e,t){if(!e||!t)return e;var r=Number(e);return isNaN(r)?e:t.format(r)},r.__decorate([l.property()],t.prototype,"layer",void 0),r.__decorate([l.property()],t.prototype,"view",void 0),r.__decorate([l.property()],t.prototype,"fullExtent",void 0),r.__decorate([l.property()],t.prototype,"tileInfo",void 0),r.__decorate([l.property({readOnly:!0,dependsOn:["layer.renderer"]})],t.prototype,"hasTilingEffects",null),t=r.__decorate([l.subclass("esri.views.layers.ImageryTileLayerView")],t)}(e)}}));