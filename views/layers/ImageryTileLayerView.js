/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/has","../../core/maybe","../../core/Logger","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/subclass","../../core/Error","../../core/urlUtils","../../core/uuid","../../portal/support/resourceExtension","../../core/promiseUtils","../../Graphic","../../layers/support/rasterFunctions/rasterProjectionHelper","./support/popupUtils"],(function(e,t,r,i,o,n,a,s,l,u,p,c,f,y,d,m,h){"use strict";e.ImageryTileLayerView=e=>{let i=function(e){function r(){var t;return(t=e.apply(this,arguments)||this)._rasterFieldPrefix="Raster.",t.layer=null,t.view=null,t.fullExtent=null,t.tileInfo=null,t.datumTransformation=null,t}t._inheritsLoose(r,e);var i=r.prototype;return i.fetchPopupFeatures=async function(e,t){const{layer:r}=this;if(!e)return y.reject(new u("imageryTileLayerView:fetchPopupFeatures","Nothing to fetch without area",{layer:r}));const{popupEnabled:i}=r,n=h.getFetchPopupTemplate(r,t);if(!i||!o.isSome(n))throw new u("imageryTileLayerView:fetchPopupFeatures","Missing required popupTemplate or popupEnabled",{popupEnabled:i,popupTemplate:n});const a=[],{value:s}=await r.identify(e);if(s){var l,p;const e=s.join(", "),t={ObjectId:0},i="Raster.ServicePixelValue";t[i]=this._formatAttributeValue(e,i);const o=null==(l=r.rasterInfo)||null==(p=l.attributeTable)?void 0:p.features;if(o&&o.length>0){const r=o.filter((t=>{const r=t.attributes.value||t.attributes.Value||t.attributes.VALUE;return String(r)===e}));if(r.length>0){const e=r[0];if(e)for(const r in e.attributes)if(e.attributes.hasOwnProperty(r)){const i=this._rasterFieldPrefix+r;t[i]=this._formatAttributeValue(e.attributes[r],i)}}}const n=new d(this.fullExtent.clone(),null,t);n.layer=r,n.sourceLayer=n.layer,a.push(n)}return a},i.updateFullExtent=function(){const e=this.layer.tileInfo;let t;e&&e.spatialReference||(t=new u("layerview:tiling-information-missing","The layer doesn't provide tiling information",{layer:this.layer}));const r=m.projectExtent(this.layer.fullExtent,this.view.spatialReference,this.datumTransformation);return null==r&&(t=new u("layerview:projection-not-supported","The layer extent cannot be projected to the view's spatial reference",{layer:this.layer})),this._set("fullExtent",r),t?y.reject(t):y.resolve()},i._formatAttributeValue=function(e,t){if("string"==typeof e){const r=this.layer.popupTemplate&&this.layer.popupTemplate.fieldInfos,i=this._getFieldInfo(r,t),o=i&&i.format;if(o){let t,r;return e.trim().indexOf(",")>-1?(t=",",r=t+" ",this._formatDelimitedString(e,t,r,o)):e.trim().indexOf(" ")>-1?(t=r=" ",this._formatDelimitedString(e,t,r,o)):this._formatNumberFromString(e,o)}}return e},i._getFieldInfo=function(e,t){if(!e||!e.length||!t)return;const r=t.toLowerCase();let i;return e.some((e=>!(!e.fieldName||e.fieldName.toLowerCase()!==r&&e.fieldName.toLowerCase()!==r.replace(/ /g,"_"))&&(i=e,!0))),i},i._formatDelimitedString=function(e,t,r,i){return e&&t&&r&&i?e.trim().split(t).map((e=>this._formatNumberFromString(e,i))).join(r):e},i._formatNumberFromString=function(e,t){if(!e||!t)return e;const r=Number(e);return isNaN(r)?e:t.format(r)},t._createClass(r,[{key:"hasTilingEffects",get:function(){return this.layer.renderer&&"dynamicRangeAdjustment"in this.layer.renderer&&this.layer.renderer.dynamicRangeAdjustment}}]),r}(e);return r.__decorate([s.property()],i.prototype,"layer",void 0),r.__decorate([s.property()],i.prototype,"view",void 0),r.__decorate([s.property()],i.prototype,"fullExtent",void 0),r.__decorate([s.property()],i.prototype,"tileInfo",void 0),r.__decorate([s.property({readOnly:!0,dependsOn:["layer.renderer"]})],i.prototype,"hasTilingEffects",null),i=r.__decorate([l.subclass("esri.views.layers.ImageryTileLayerView")],i),i},Object.defineProperty(e,"__esModule",{value:!0})}));
