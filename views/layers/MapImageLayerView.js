/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/has","../../core/maybe","../../core/Logger","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/subclass","../../core/Error","../../core/urlUtils","../../core/uuid","../../portal/support/resourceExtension","../../core/promiseUtils","../../support/arcadeOnDemand","../../renderers/support/clickToleranceUtils","./support/popupUtils"],(function(e,r,t,a,o,s,p,c,l,u,i,n,d,y,m,h,f){"use strict";e.MapImageLayerView=e=>{let a=function(e){function t(){return e.apply(this,arguments)||this}r._inheritsLoose(t,e);var a=t.prototype;return a.fetchPopupFeatures=async function(e,r){const{layer:t}=this;if(!e)return y.reject(new u("mapimagelayerview:fetchPopupFeatures","Nothing to fetch without area",{layer:t}));const a=this.get("view.scale"),s=[],p=async e=>{const t=0===e.minScale||a<=e.minScale,c=0===e.maxScale||a>=e.maxScale;if(e.visible&&t&&c)if(e.sublayers)e.sublayers.forEach(p);else if(e.popupEnabled){const t=f.getFetchPopupTemplate(e,{...r,defaultPopupTemplateEnabled:!1});o.isSome(t)&&s.push({sublayer:e,popupTemplate:t})}},c=t.sublayers.toArray().map(p);await y.all(c);const l=s.map((async({sublayer:t,popupTemplate:a})=>{await t.load().catch((()=>{}));const s=t.createQuery(),p=o.isSome(r)?r.event:null,c=h.calculateTolerance({renderer:t.renderer,event:p}),l=this.createFetchPopupFeaturesQueryGeometry(e,c);s.geometry=l,s.outFields=await f.getRequiredFields(t,a);const u=await this._loadArcadeModules(a);u&&u.arcadeUtils.hasGeometryOperations(a)||(s.maxAllowableOffset=l.width/c);return(await t.queryFeatures(s)).features}));return(await y.eachAlways(l)).reduce(((e,r)=>r.value?[...e,...r.value]:e),[]).filter((e=>null!=e))},a.canResume=function(){var r,t;return!!e.prototype.canResume.call(this)&&(null==(r=this.imageParameters)||null==(t=r.timeExtent)||!t.isEmpty)},a._loadArcadeModules=function(e){if(e.get("expressionInfos.length"))return m.loadArcade()},t}(e);return t.__decorate([c.property()],a.prototype,"imageParameters",void 0),t.__decorate([c.property()],a.prototype,"layer",void 0),t.__decorate([c.property({dependsOn:["imageParameters.timeExtent"]})],a.prototype,"suspended",void 0),a=t.__decorate([l.subclass("esri.views.layers.MapImageLayerView")],a),a},Object.defineProperty(e,"__esModule",{value:!0})}));
