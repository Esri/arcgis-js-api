/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/has","../../core/maybe","../../core/Logger","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/subclass","../../core/Error","../../core/urlUtils","../../core/uuid","../../portal/support/resourceExtension","../../core/promiseUtils","../../support/arcadeOnDemand","../../layers/support/commonProperties","../../layers/support/ExportImageParameters","../../renderers/support/clickToleranceUtils","./support/popupUtils"],(function(e,r,t,a,o,s,p,i,n,c,l,u,m,y,d,h,f,g,x){"use strict";const P=e=>{let a=function(e){function t(){return e.apply(this,arguments)||this}r._inheritsLoose(t,e);var a=t.prototype;return a.initialize=function(){this.exportImageParameters=new f.ExportImageParameters({layer:this.layer})},a.destroy=function(){this.exportImageParameters.destroy(),this.exportImageParameters=null},a.fetchPopupFeatures=async function(e,r){const{layer:t}=this;if(!e)return Promise.reject(new c("mapimagelayerview:fetchPopupFeatures","Nothing to fetch without area",{layer:t}));const a=this.get("view.scale"),s=[],p=async e=>{const t=0===e.minScale||a<=e.minScale,i=0===e.maxScale||a>=e.maxScale;if(e.visible&&t&&i)if(e.sublayers)e.sublayers.forEach(p);else if(e.popupEnabled){const t=x.getFetchPopupTemplate(e,{...r,defaultPopupTemplateEnabled:!1});o.isSome(t)&&s.unshift({sublayer:e,popupTemplate:t})}},i=t.sublayers.toArray().reverse().map(p);await Promise.all(i);const n=s.map((async({sublayer:t,popupTemplate:a})=>{await t.load().catch((()=>{}));const s=t.createQuery(),p=o.isSome(r)?r.event:null,i=g.calculateTolerance({renderer:t.renderer,event:p}),n=this.createFetchPopupFeaturesQueryGeometry(e,i);s.geometry=n,s.outFields=await x.getRequiredFields(t,a);const c=await this._loadArcadeModules(a);c&&c.arcadeUtils.hasGeometryOperations(a)||(s.maxAllowableOffset=n.width/i);return(await t.queryFeatures(s)).features}));return(await y.eachAlways(n)).reduce(((e,r)=>r.value?[...e,...r.value]:e),[]).filter((e=>null!=e))},a.canResume=function(){var r;return!!e.prototype.canResume.call(this)&&(null==(r=this.timeExtent)||!r.isEmpty)},a._loadArcadeModules=function(e){if(e.get("expressionInfos.length"))return d.loadArcade()},r._createClass(t,[{key:"exportImageVersion",get:function(){var e;return null==(e=this.exportImageParameters)||e.commitProperty("version"),this.commitProperty("timeExtent"),(this._get("exportImageVersion")||0)+1}}]),t}(e);return t.__decorate([i.property()],a.prototype,"exportImageParameters",void 0),t.__decorate([i.property({readOnly:!0})],a.prototype,"exportImageVersion",null),t.__decorate([i.property()],a.prototype,"layer",void 0),t.__decorate([i.property()],a.prototype,"suspended",void 0),t.__decorate([i.property(h.combinedViewLayerTimeExtentProperty)],a.prototype,"timeExtent",void 0),a=t.__decorate([n.subclass("esri.views.layers.MapImageLayerView")],a),a};e.MapImageLayerView=P,e.default=P,Object.defineProperty(e,"__esModule",{value:!0})}));
