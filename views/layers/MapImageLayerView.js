/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["require","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../symbols","../../core/Error","../../core/has","../../core/MapUtils","../../core/maybe","../../core/promiseUtils","../../core/reactiveUtils","../../core/unitUtils","../../core/accessorSupport/decorators/property","../../core/arrayUtils","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass","../../geometry/Extent","../../geometry/support/scaleUtils","../../layers/support/commonProperties","../../layers/support/ExportImageParameters","../../layers/support/floorFilterUtils","../../renderers/support/clickToleranceUtils","../../rest/identify","../../rest/support/IdentifyParameters","../../support/arcadeOnDemand","../../support/GraphicsCollection","./support/popupUtils","../../symbols/SimpleMarkerSymbol"],(function(e,t,r,s,i,o,a,n,l,u,c,p,y,h,d,f,m,g,_,v,b,P,w,x,G,F,T){"use strict";let I=null;const R=s=>{let y=function(r){function s(){var e;return(e=r.apply(this,arguments)||this)._featuresResolutions=new WeakMap,e.highlightGraphics=new G.GraphicsCollection,e.updateHighlightedFeatures=l.debounce(function(){var r=t._asyncToGenerator((function*(t){e.destroyed||e.updatingHandles.addPromise(e._updateHighlightedFeaturesGeometries(t).catch((()=>{})))}));return function(e){return r.apply(this,arguments)}}()),e}t._inheritsLoose(s,r);var p=s.prototype;return p.initialize=function(){this.exportImageParameters=new _.ExportImageParameters({layer:this.layer}),this.handles.add([u.on((()=>this.highlightGraphics),"change",(e=>{this.updatingHandles.addPromise(this._updateHighlightedFeaturesSymbols(e.added).catch((()=>{}))),this.updateHighlightedFeatures(this._highlightGeometriesResolution)}))])},p.destroy=function(){this.exportImageParameters.destroy(),this.exportImageParameters=null},p.fetchPopupFeatures=function(){var e=t._asyncToGenerator((function*(e,t){const{layer:r}=this;if(!e)throw new i("mapimagelayer:fetchPopupFeatures","Nothing to fetch without area",{layer:r});const s=this.layer.capabilities?.operations?.supportsQuery??!0;if(!((this.layer.capabilities?.operations?.supportsIdentify??!0)&&this.layer.version>=10.5)&&!s)throw new i("mapimagelayer:fetchPopupFeatures-not-supported","query operation is disabled for this service",{layer:r});return s?this._fetchPopupFeaturesUsingQueries(e,t):this._fetchPopupFeaturesUsingIdentify(e,t)}));function r(t,r){return e.apply(this,arguments)}return r}(),p.canResume=function(){return!!r.prototype.canResume.call(this)&&!this.timeExtent?.isEmpty},p._updateHighlightedFeaturesSymbols=function(){var r=t._asyncToGenerator((function*(r){var s=this;for(const i of r){const r="renderer"in i.sourceLayer&&i.sourceLayer.renderer;"geometryType"in i.sourceLayer&&"point"===i.sourceLayer.geometryType&&r&&"getSymbolAsync"in r&&r.getSymbolAsync(i).then(function(){var o=t._asyncToGenerator((function*(t){let o="width"in t&&"height"in t&&null!=t.width&&null!=t.height?Math.max(t.width,t.height):"size"in t?t.size:null;const a="visualVariables"in r&&r.visualVariables?.find((e=>"size"===e.type));a&&(I||(I=(yield new Promise(((t,r)=>e(["../../renderers/visualVariables/support/visualVariableUtils"],t,r)))).getSize),o=I(a,i,{view:s.view.type,scale:s.view.scale,shape:"simple-marker"===t.type?t.style:null})),s.highlightGraphics.includes(i)&&(i.symbol=new T({style:"square",size:o,xoffset:"xoffset"in t?t.xoffset:0,yoffset:"yoffset"in t?t.yoffset:0}),i.visible=!0,s.highlightGraphicUpdated(i,"symbol"))}));return function(e){return o.apply(this,arguments)}}())}}));function s(e){return r.apply(this,arguments)}return s}(),p._updateHighlightedFeaturesGeometries=function(){var e=t._asyncToGenerator((function*(e){this._highlightGeometriesResolution=e;const t=this.highlightGraphics;if(!t.length||!this.layer.capabilities.operations.supportsQuery)return;const r=this._getTargetResolution(e),s=new Map;for(const n of t)if(!this._featuresResolutions.has(n)||this._featuresResolutions.get(n)>r){const e=n.sourceLayer;a.getOrCreateMapValue(s,e,(()=>new Map)).set(n.getObjectId(),n)}const i=Array.from(s,(([e,t])=>{const s=e.createQuery();return s.objectIds=[...t.keys()],s.outFields=[e.objectIdField],s.returnGeometry=!0,s.maxAllowableOffset=r,s.outSpatialReference=this.view.spatialReference,e.queryFeatures(s)})),o=yield Promise.all(i);if(!this.destroyed)for(const{features:a}of o)for(const e of a){const t=e.sourceLayer,i=s.get(t).get(e.getObjectId());i&&this.highlightGraphics.includes(i)&&(i.geometry=e.geometry,this.highlightGraphicUpdated(i,"geometry"),this._featuresResolutions.set(i,r))}}));function r(t){return e.apply(this,arguments)}return r}(),p._getTargetResolution=function(e){const t=e*c.getMetersPerUnitForSR(this.view.spatialReference),r=t/16;return r<=10?0:e/t*r},p._fetchPopupFeaturesUsingIdentify=function(){var e=t._asyncToGenerator((function*(e,t){const r=yield this._createIdentifyParameters(e,t);if(n.isNone(r))return[];const{results:s}=yield P.identify(this.layer.parsedUrl,r);return s.map((e=>e.feature))}));function r(t,r){return e.apply(this,arguments)}return r}(),p._createIdentifyParameters=function(){var e=t._asyncToGenerator((function*(e,t){const{floors:r,spatialReference:s,scale:i}=this.view,a=n.isSome(t)?t.event:null,l=yield this._collectPopupProviders(this.layer.sublayers,i,t);if(!l.length)return null;yield Promise.all(l.map((({sublayer:e})=>e.load().catch((()=>{})))));const u=Math.min(o("mapimagelayer-popup-identify-max-tolerance"),this.layer.allSublayers.reduce(((e,t)=>t.renderer?b.calculateTolerance({renderer:t.renderer,event:a}):e),2)),c=this.createFetchPopupFeaturesQueryGeometry(e,u),p=m.getResolutionForScale(i,s),y=Math.round(c.width/p),h=new f({xmin:c.center.x-p*y,ymin:c.center.y-p*y,xmax:c.center.x+p*y,ymax:c.center.y+p*y,spatialReference:c.spatialReference});return new w({floors:r,gdbVersion:this.layer.gdbVersion,geometry:e,height:y,layerOption:"popup",mapExtent:h,returnGeometry:!0,spatialReference:s,sublayers:this.layer.sublayers,timeExtent:this.timeExtent,tolerance:u,width:y})}));function r(t,r){return e.apply(this,arguments)}return r}(),p._fetchPopupFeaturesUsingQueries=function(){var e=t._asyncToGenerator((function*(e,r){var s=this;const i=yield this._collectPopupProviders(this.layer.sublayers,this.view.scale,r),o=n.isSome(r)?r.event:null,a=i.map(function(){var r=t._asyncToGenerator((function*({sublayer:t,popupTemplate:r}){yield t.load().catch((()=>{}));const i=t.createQuery(),a=b.calculateTolerance({renderer:t.renderer,event:o}),l=s.createFetchPopupFeaturesQueryGeometry(e,a);if(i.geometry=l,i.outFields=yield F.getRequiredFields(t,r),i.timeExtent=s.timeExtent,"floors"in s.view){const e=s.view?.floors?.clone(),r=v.getLayerFloorFilterClause(e,t);n.isSome(r)&&(i.where=i.where?`(${i.where}) AND (${r})`:r)}const u=s._getTargetResolution(l.width/a),c=yield s._loadArcadeModules(r),p="point"===t.geometryType||c&&c.arcadeUtils.hasGeometryOperations(r);p||(i.maxAllowableOffset=u);const{features:y}=yield t.queryFeatures(i),h=p?0:u;for(const e of y)s._featuresResolutions.set(e,h);return y}));return function(e){return r.apply(this,arguments)}}());return(yield l.eachAlways(a)).reverse().reduce(((e,t)=>t.value?[...e,...t.value]:e),[]).filter((e=>null!=e))}));function r(t,r){return e.apply(this,arguments)}return r}(),p._collectPopupProviders=function(){var e=t._asyncToGenerator((function*(e,r,s){const i=[],o=function(){var e=t._asyncToGenerator((function*(e){const t=0===e.minScale||r<=e.minScale,a=0===e.maxScale||r>=e.maxScale;if(e.visible&&t&&a)if(e.sublayers)e.sublayers.forEach(o);else if(e.popupEnabled){const t=F.getFetchPopupTemplate(e,{...s,defaultPopupTemplateEnabled:!1});n.isSome(t)&&i.unshift({sublayer:e,popupTemplate:t})}}));return function(t){return e.apply(this,arguments)}}(),a=e.toArray().reverse().map(o);return yield Promise.all(a),i}));function r(t,r,s){return e.apply(this,arguments)}return r}(),p._loadArcadeModules=function(e){if(e.expressionInfos?.length||Array.isArray(e.content)&&e.content.some((e=>"expression"===e.type)))return x.loadArcade()},t._createClass(s,[{key:"exportImageVersion",get:function(){return this.exportImageParameters?.commitProperty("version"),this.commitProperty("timeExtent"),(this._get("exportImageVersion")||0)+1}}]),s}(s);return r.__decorate([p.property()],y.prototype,"highlightGraphics",void 0),r.__decorate([p.property()],y.prototype,"exportImageParameters",void 0),r.__decorate([p.property({readOnly:!0})],y.prototype,"exportImageVersion",null),r.__decorate([p.property()],y.prototype,"layer",void 0),r.__decorate([p.property()],y.prototype,"suspended",void 0),r.__decorate([p.property(g.combinedViewLayerTimeExtentProperty)],y.prototype,"timeExtent",void 0),y=r.__decorate([d.subclass("esri.views.layers.MapImageLayerView")],y),y};return R}));
