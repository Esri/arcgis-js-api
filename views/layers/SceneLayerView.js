/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["require","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/Logger","../../core/maybe","../../core/maybeUpdating","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/arrayUtils","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass","../../geometry/projection","./LayerView"],(function(e,t,r,n,o,i,l,a,s,c,p,u,y){"use strict";const d="esri.views.layers.SceneLayerView",g=n.getLogger(d);let m=function(r){function n(){var e;return(e=r.apply(this,arguments)||this).layer=null,e.filter=null,e._geometryEngine=null,e._projectionEngineLoaded=!1,e}t._inheritsLoose(n,r);var a=n.prototype;return a.initialize=function(){var r=this;l.whenOnce((()=>!this._geometryEngine&&o.isSome(this.layer.filter)&&this.layer.filter.geometries.length)).then(t._asyncToGenerator((function*(){return r._geometryEngine=yield new Promise(((t,r)=>e(["../../geometry/geometryEngine"],t,r)))}))),this._projectionEngineLoaded=u.isLoaded(),l.whenOnce((()=>!this._projectionEngineLoaded&&this._filterNeedsProjectionEngine)).then(t._asyncToGenerator((function*(){yield u.load(),r._projectionEngineLoaded=!0})))},a.highlight=function(e){throw new Error("Not implemented")},a.queryFeatures=function(e,t){throw new Error("Not implemented")},a.queryObjectIds=function(e,t){throw new Error("Not implemented")},a.queryFeatureCount=function(e,t){throw new Error("Not implemented")},a.createQuery=function(){throw new Error("Not implemented")},a.queryExtent=function(e,t){throw new Error("Not implemented")},t._createClass(n,[{key:"availableFields",get:function(){return[]}},{key:"maximumNumberOfFeatures",get:function(){return 0},set:function(e){throw new Error("Not implemented")}},{key:"maximumNumberOfFeaturesExceeded",get:function(){return!1}},{key:"layerFilter",get:function(){return i.unwrapUpdating(this._layerFilter)}},{key:"_layerFilter",get:function(){const e=this.layer.filter;if(o.isNone(e)||e.geometries.length<1)return null;const t=this._geometryEngine;if(o.isNone(t)||!this._projectionEngineLoaded&&this._filterNeedsProjectionEngine)return i.updating;const r=e.geometries.getItemAt(0).spatialReference,n=e.geometries.toArray().map((e=>{try{e=t.simplify(e)}catch(n){return g.warnOncePerTick("Failed to simplify scene filter mask polygon. Polygon will be ignored."),null}if(null==e)return null;if(e.spatialReference.equals(r))return e;try{return u.project(e,r)}catch(n){return g.warnOncePerTick("Failed to project scene filter mask polygon. Polygon will be ignored."),null}})).filter((e=>null!=e)).sort(((e,t)=>e.extent.xmin-t.extent.xmin)),l=new Set,a=new Array,s=new Array;for(let o of n){const e=o.extent.xmin;if(a.length=0,l.forEach((r=>{if(e>=r.extent.xmax)return s.push(r),void l.delete(r);o.extent.ymin<=r.extent.ymax&&o.extent.ymax>=r.extent.ymin&&t.intersects(o,r)&&a.push(r)})),a.length>0){a.push(o);try{o=t.union(a)}catch(c){g.warnOncePerTick("Failed to unify filter mask polygons. Polygon will be ignored.");continue}a.pop(),a.forEach((e=>l.delete(e)))}l.add(o)}return l.forEach((e=>s.push(e))),s.length>0?{spatialRelationship:e.spatialRelationship,geometries:s}:null}},{key:"_filterNeedsProjectionEngine",get:function(){const e=this.layer.filter;if(o.isNone(e)||e.geometries.length<=1)return!1;const t=e.geometries.getItemAt(0).spatialReference;return e.geometries.some((({spatialReference:e})=>!e.equals(t)&&!u.canProjectWithoutEngine(e,t)))}},{key:"layerFilterUpdating",get:function(){return i.isUpdating(this._layerFilter)}}]),n}(y);r.__decorate([a.property()],m.prototype,"layer",void 0),r.__decorate([a.property()],m.prototype,"availableFields",null),r.__decorate([a.property()],m.prototype,"maximumNumberOfFeatures",null),r.__decorate([a.property({readOnly:!0})],m.prototype,"maximumNumberOfFeaturesExceeded",null),r.__decorate([a.property()],m.prototype,"filter",void 0),r.__decorate([a.property({readOnly:!0})],m.prototype,"layerFilter",null),r.__decorate([a.property({readOnly:!0})],m.prototype,"_layerFilter",null),r.__decorate([a.property()],m.prototype,"_geometryEngine",void 0),r.__decorate([a.property()],m.prototype,"_projectionEngineLoaded",void 0),r.__decorate([a.property()],m.prototype,"_filterNeedsProjectionEngine",null),r.__decorate([a.property()],m.prototype,"layerFilterUpdating",null),m=r.__decorate([p.subclass(d)],m);return m}));
