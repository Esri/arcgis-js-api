/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/has","../../core/maybe","../../core/Logger","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/subclass","../../core/Error","../../core/urlUtils","../../core/uuid","../../portal/support/resourceExtension","../../core/promiseUtils","../../support/arcadeOnDemand","../../layers/support/fieldUtils","../../core/watchUtils","../../layers/support/commonProperties","../../tasks/support/Query","./support/FeatureFilter","./support/FeatureEffect","./support/popupUtils"],(function(e,t,r,i,o,s,l,n,a,u,p,c,d,f,y,m,h,F,_,g,w,v){"use strict";const x=s.getLogger("esri.views.layers.FeatureLayerView"),E=e=>{let i=function(e){function r(...t){var r;return(r=e.call(this,...t)||this)._updatingRequiredFieldsPromise=null,r.effect=null,r.filter=null,r.timeExtent=null,r.layer=null,r.requiredFields=[],r.view=null,r}t._inheritsLoose(r,e);var i=r.prototype;return i.initialize=function(){h.init(this,["layer.renderer","layer.labelingInfo","layer.elevationInfo.featureExpressionInfo","layer.displayField","filter","effect","layer.timeInfo","layer.floorInfo","timeExtent"],(()=>this._handleRequiredFieldsChange()),!0),h.on(this,"view.floors","change",(()=>this._handleRequiredFieldsChange()))},i.highlight=function(e){throw new Error("missing implementation")},i.createQuery=function(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},t=o.isSome(this.filter)?this.filter.createQuery(e):new _(e);return o.isSome(this.timeExtent)&&(t.timeExtent=o.isSome(t.timeExtent)?t.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),t},i.queryFeatures=function(e,t){throw new Error("missing implementation")},i.queryObjectIds=function(e,t){throw new Error("missing implementation")},i.queryFeatureCount=function(e,t){throw new Error("missing implementation")},i.queryExtent=function(e,t){throw new Error("missing implementation")},i._loadArcadeModules=function(e){if(e.get("expressionInfos.length"))return y.loadArcade()},i._handleRequiredFieldsChange=function(){const e=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",e),e.then((()=>{this._updatingRequiredFieldsPromise===e&&this._set("_updatingRequiredFieldsPromise",null)}))},i._updateRequiredFields=async function(){if(!this.layer||!this.view)return;const e="3d"===this.view.type,{layer:t,layer:{fields:r,objectIdField:i,renderer:s,displayField:l}}=this,n=t.featureReduction,a=new Set,u=await f.eachAlways([s?s.collectRequiredFields(a,r):null,m.collectLabelingFields(a,t),e?m.collectElevationFields(a,t):null,o.isSome(this.filter)?m.collectFilterFields(a,t,this.filter):null,this.effect?m.collectFilterFields(a,t,this.effect.filter):null,n?m.collectFeatureReductionFields(a,t,n):null]);t.timeInfo&&this.timeExtent&&m.collectFields(a,t.fields,[t.timeInfo.startField,t.timeInfo.endField]),"feature"===t.type&&t.floorInfo&&m.collectFields(a,t.fields,[t.floorInfo.floorField]);for(const o of u)o.error&&x.error(o.error);m.collectField(a,r,i),e&&l&&m.collectField(a,r,l);const p=Array.from(a).sort();this._set("requiredFields",p)},i.validateFetchPopupFeatures=function(e){const{layer:t,layer:{popupEnabled:r}}=this;if(!r)return new u("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:t});return v.getFetchPopupTemplate(this.layer,e)?void 0:new u("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:t})},i.fetchClientPopupFeatures=async function(e){const t=o.isSome(e)?e.clientGraphics:null;if(!t||0===t.length)return Promise.resolve([]);const r=[],i=[],{layer:s}=this,l=v.getFetchPopupTemplate(s,e);if(!o.isSome(l))return Promise.resolve([]);const n=await this._loadArcadeModules(l),a=n&&n.arcadeUtils.hasGeometryOperations(l),u=await this.createPopupQuery(e),p=m.unpackFieldNames(s.fields,u.outFields);for(const o of t)a||!m.featureHasFields(p,o)?i.push(o):r.push(o);return"stream"===s.type||0===i.length?Promise.resolve(r):(u.objectIds=i.map((e=>e.attributes[s.objectIdField])),s.queryFeatures(u).then((e=>r.concat(e.features))).catch((()=>i)))},i.createPopupQuery=async function(e){const t=this.layer,r=t.createQuery(),i=v.getFetchPopupTemplate(t,e),s=o.isSome(i)&&await this._loadArcadeModules(i),l=o.isSome(i)&&s&&s.arcadeUtils.hasGeometryOperations(i),n=!("point"!==t.geometryType&&!l);return r.returnGeometry=n,r.returnZ=n,r.returnM=n,r.outFields=await v.getRequiredFields(this.layer,i),r.outSpatialReference=this.view.spatialReference,r},i.canResume=function(){return!!e.prototype.canResume.call(this)&&(!o.isSome(this.timeExtent)||!this.timeExtent.isEmpty)},t._createClass(r,[{key:"availableFields",get:function(){const{layer:e,layer:{fields:t},requiredFields:r}=this;return"outFields"in e&&e.outFields?m.fixFields(t,[...m.unpackFieldNames(t,e.outFields),...r]):m.fixFields(t,r)}},{key:"maximumNumberOfFeatures",get:function(){return 0},set:function(e){x.error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}},{key:"maximumNumberOfFeaturesExceeded",get:function(){return!1}}]),r}(e);return r.__decorate([n.property()],i.prototype,"_updatingRequiredFieldsPromise",void 0),r.__decorate([n.property({readOnly:!0})],i.prototype,"availableFields",null),r.__decorate([n.property({type:w})],i.prototype,"effect",void 0),r.__decorate([n.property({type:g})],i.prototype,"filter",void 0),r.__decorate([n.property(F.combinedViewLayerTimeExtentProperty)],i.prototype,"timeExtent",void 0),r.__decorate([n.property()],i.prototype,"layer",void 0),r.__decorate([n.property({type:Number})],i.prototype,"maximumNumberOfFeatures",null),r.__decorate([n.property({readOnly:!0,type:Boolean})],i.prototype,"maximumNumberOfFeaturesExceeded",null),r.__decorate([n.property({readOnly:!0})],i.prototype,"requiredFields",void 0),r.__decorate([n.property()],i.prototype,"suspended",void 0),r.__decorate([n.property()],i.prototype,"view",void 0),i=r.__decorate([a.subclass("esri.views.layers.FeatureLayerView")],i),i};e.FeatureLayerView=E,e.default=E,Object.defineProperty(e,"__esModule",{value:!0})}));
