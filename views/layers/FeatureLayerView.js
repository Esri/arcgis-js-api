/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/Error","../../core/Logger","../../core/maybe","../../core/promiseUtils","../../core/watchUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass","../../layers/support/commonProperties","../../layers/support/fieldUtils","../../rest/support/Query","../../support/arcadeOnDemand","./support/FeatureEffect","./support/FeatureFilter","./support/popupUtils","../support/floorFilterUtils"],(function(e,t,r,i,o,n,l,s,a,u,c,p,d,y,f,h,m,F,_,g){"use strict";const w=o.getLogger("esri.views.layers.FeatureLayerView"),v=e=>{let o=function(e){function r(...t){var r;return(r=e.call(this,...t)||this)._updatingRequiredFieldsPromise=null,r.effect=null,r.filter=null,r.timeExtent=null,r.layer=null,r.requiredFields=[],r.view=null,r}t._inheritsLoose(r,e);var o=r.prototype;return o.initialize=function(){s.init(this,["layer.renderer","layer.labelingInfo","layer.elevationInfo.featureExpressionInfo","layer.displayField","filter","effect","layer.timeInfo","layer.floorInfo","timeExtent"],(()=>this._handleRequiredFieldsChange()),!0),s.on(this,"view.floors","change",(()=>this._handleRequiredFieldsChange())),s.on(this,"layer.sublayer","change",(()=>this._handleRequiredFieldsChange()))},o.highlight=function(e){throw new Error("missing implementation")},o.createQuery=function(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},t=n.isSome(this.filter)?this.filter.createQuery(e):new f(e);if("feature"===this.layer.type){const e=g.getFloorFilterClause(this);n.isSome(e)&&(t.where=t.where?`(${t.where}) AND (${e})`:e)}return n.isSome(this.timeExtent)&&(t.timeExtent=n.isSome(t.timeExtent)?t.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),t},o.queryFeatures=function(e,t){throw new Error("missing implementation")},o.queryObjectIds=function(e,t){throw new Error("missing implementation")},o.queryFeatureCount=function(e,t){throw new Error("missing implementation")},o.queryExtent=function(e,t){throw new Error("missing implementation")},o._loadArcadeModules=function(e){if(e.get("expressionInfos.length"))return h.loadArcade()},o._handleRequiredFieldsChange=function(){const e=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",e),e.then((()=>{this._updatingRequiredFieldsPromise===e&&this._set("_updatingRequiredFieldsPromise",null)}))},o._updateRequiredFields=function(){var e=t._asyncToGenerator((function*(){if(!this.layer||!this.view)return;const e="3d"===this.view.type,{layer:t,layer:{fieldsIndex:r,objectIdField:i}}=this,o="renderer"in t&&t.renderer,s="orderBy"in t&&t.orderBy,a=t.featureReduction,u=new Set,c=yield l.eachAlways([o?o.collectRequiredFields(u,r):null,y.collectLabelingFields(u,t),e?y.collectElevationFields(u,t):null,n.isSome(this.filter)?y.collectFilterFields(u,t,this.filter):null,this.effect?y.collectFilterFields(u,t,this.effect.filter):null,a?y.collectFeatureReductionFields(u,t,a):null,s?y.collectOrderByInfos(u,t,s):null]);if(t.timeInfo&&this.timeExtent&&y.collectFields(u,t.fieldsIndex,[t.timeInfo.startField,t.timeInfo.endField]),"feature"===t.type&&t.floorInfo&&y.collectFields(u,t.fieldsIndex,[t.floorInfo.floorField]),"subtype-group"===t.type){y.collectField(u,r,t.subtypeField);const e=t.sublayers.map((e=>{var t;return Promise.all([null==(t=e.renderer)?void 0:t.collectRequiredFields(u,r),y.collectLabelingFields(u,e)])}));yield l.eachAlways(e)}for(const n of c)n.error&&w.error(n.error);y.collectField(u,r,i),e&&"displayField"in t&&t.displayField&&y.collectField(u,r,t.displayField);const p=Array.from(u).sort();this._set("requiredFields",p)}));function r(){return e.apply(this,arguments)}return r}(),o.validateFetchPopupFeatures=function(e){if(n.isNone(e))return null;for(const t of e.clientGraphics){const r=t.layer;if("popupEnabled"in r&&!r.popupEnabled)return new i("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:r});if("popupTemplate"in r){if(!_.getFetchPopupTemplate(r,e))return new i("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:r})}}},o.fetchClientPopupFeatures=function(){var e=t._asyncToGenerator((function*(e){const t=n.isSome(e)?e.clientGraphics:null;if(!t||0===t.length)return Promise.resolve([]);const r=[],i=[],o=yield this.createPopupQuery(e);for(const l of t){const{layer:t}=l;if(!("popupEnabled"in t))continue;const s=y.unpackFieldNames(this.layer.fieldsIndex,o.outFields),a=_.getFetchPopupTemplate(t,e);if(!n.isSome(a))continue;const u=yield this._loadArcadeModules(a);u&&u.arcadeUtils.hasGeometryOperations(a)||!y.featureHasFields(s,l)?i.push(l):r.push(l)}return"stream"===this.layer.type||0===i.length?Promise.resolve(r):(o.objectIds=i.map((e=>e.attributes[this.layer.objectIdField])),this.layer.queryFeatures(o).then((e=>r.concat(e.features))).catch((()=>i)))}));function r(t){return e.apply(this,arguments)}return r}(),o.createPopupQuery=function(){var e=t._asyncToGenerator((function*(e){const t=this.layer.createQuery(),r=new Set;let i=!1;const o=n.isSome(e)&&e.clientGraphics?e.clientGraphics.map((e=>e.layer)):[this.layer];for(const l of o){if(!("popupEnabled"in l))continue;const t=_.getFetchPopupTemplate(l,e);if(!n.isSome(t))continue;const o=yield this._loadArcadeModules(t),s=o&&o.arcadeUtils.hasGeometryOperations(t);i=!("point"!==this.layer.geometryType&&!s);const a=yield _.getRequiredFields(this.layer,t);for(const e of a)r.add(e)}if(t.returnGeometry=i,t.returnZ=i,t.returnM=i,t.outFields=Array.from(r),t.outSpatialReference=this.view.spatialReference,"feature"===this.layer.type){const e=g.getFloorFilterClause(this);n.isSome(e)&&(t.where=t.where?`(${t.where}) AND (${e})`:e)}return t}));function r(t){return e.apply(this,arguments)}return r}(),o.canResume=function(){return!!e.prototype.canResume.call(this)&&(!n.isSome(this.timeExtent)||!this.timeExtent.isEmpty)},t._createClass(r,[{key:"availableFields",get:function(){const{layer:e,layer:{fieldsIndex:t},requiredFields:r}=this;return"outFields"in e&&e.outFields?y.fixFields(t,[...y.unpackFieldNames(t,e.outFields),...r]):y.fixFields(t,r)}},{key:"maximumNumberOfFeatures",get:function(){return 0},set:function(e){w.error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}},{key:"maximumNumberOfFeaturesExceeded",get:function(){return!1}}]),r}(e);return r.__decorate([a.property()],o.prototype,"_updatingRequiredFieldsPromise",void 0),r.__decorate([a.property({readOnly:!0})],o.prototype,"availableFields",null),r.__decorate([a.property({type:m})],o.prototype,"effect",void 0),r.__decorate([a.property({type:F})],o.prototype,"filter",void 0),r.__decorate([a.property(d.combinedViewLayerTimeExtentProperty)],o.prototype,"timeExtent",void 0),r.__decorate([a.property()],o.prototype,"layer",void 0),r.__decorate([a.property({type:Number})],o.prototype,"maximumNumberOfFeatures",null),r.__decorate([a.property({readOnly:!0,type:Boolean})],o.prototype,"maximumNumberOfFeaturesExceeded",null),r.__decorate([a.property({readOnly:!0})],o.prototype,"requiredFields",void 0),r.__decorate([a.property()],o.prototype,"suspended",void 0),r.__decorate([a.property()],o.prototype,"view",void 0),o=r.__decorate([p.subclass("esri.views.layers.FeatureLayerView")],o),o};e.FeatureLayerView=v,e.default=v,Object.defineProperty(e,"__esModule",{value:!0})}));
