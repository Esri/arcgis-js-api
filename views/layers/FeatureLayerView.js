/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/has","../../core/maybe","../../core/Logger","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/subclass","../../core/Error","../../core/urlUtils","../../core/uuid","../../portal/support/resourceExtension","../../core/promiseUtils","../../support/arcadeOnDemand","../../layers/support/fieldUtils","../../core/watchUtils","../../layers/support/commonProperties","../../tasks/support/Query","./support/FeatureFilter","./support/FeatureEffect","./support/popupUtils"],(function(e,t,r,i,o,s,n,l,a,u,p,c,d,y,m,f,h,F,_,g,w,v){"use strict";const x=s.getLogger("esri.views.layers.FeatureLayerView");e.FeatureLayerView=e=>{let i=function(e){function r(...t){var r;return(r=e.call(this,...t)||this)._updatingRequiredFieldsPromise=null,r.effect=null,r.filter=null,r.timeExtent=null,r.layer=null,r.requiredFields=[],r.view=null,r}t._inheritsLoose(r,e);var i=r.prototype;return i.initialize=function(){h.init(this,["layer.renderer","layer.labelingInfo","layer.elevationInfo.featureExpressionInfo","layer.displayField","filter","effect","layer.timeInfo","timeExtent"],(()=>this._handleRequiredFieldsChange()),!0)},i.highlight=function(e){throw new Error("missing implementation")},i.createQuery=function(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},t=o.isSome(this.filter)?this.filter.createQuery(e):new _(e);return o.isSome(this.timeExtent)&&(t.timeExtent=o.isSome(t.timeExtent)?t.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),t},i.queryFeatures=function(e,t){throw new Error("missing implementation")},i.queryObjectIds=function(e,t){throw new Error("missing implementation")},i.queryFeatureCount=function(e,t){throw new Error("missing implementation")},i.queryExtent=function(e,t){throw new Error("missing implementation")},i._loadArcadeModules=function(e){if(e.get("expressionInfos.length"))return m.loadArcade()},i._handleRequiredFieldsChange=function(){const e=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",e),e.then((()=>{this._updatingRequiredFieldsPromise===e&&this._set("_updatingRequiredFieldsPromise",null)}))},i._updateRequiredFields=async function(){if(!this.layer||!this.view)return;const e="3d"===this.view.type,{layer:t,layer:{fields:r,objectIdField:i,renderer:s,displayField:n}}=this,l=t.featureReduction,a=new Set,u=await y.eachAlways([s?s.collectRequiredFields(a,r):null,f.collectLabelingFields(a,t),e?f.collectElevationFields(a,t):null,o.isSome(this.filter)?f.collectFilterFields(a,t,this.filter):null,this.effect?f.collectFilterFields(a,t,this.effect.filter):null,l?f.collectFeatureReductionFields(a,t,l):null]);t.timeInfo&&this.timeExtent&&f.collectFields(a,t.fields,[t.timeInfo.startField,t.timeInfo.endField]);for(const e of u)e.error&&x.error(e.error);f.collectField(a,r,i),e&&n&&f.collectField(a,r,n);const p=Array.from(a).sort();this._set("requiredFields",p)},i.validateFetchPopupFeatures=function(e){const{layer:t,layer:{popupEnabled:r}}=this;if(!r)return new u("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:t});return v.getFetchPopupTemplate(this.layer,e)?void 0:new u("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:t})},i.fetchClientPopupFeatures=async function(e){const t=o.isSome(e)?e.clientGraphics:null;if(!t||0===t.length)return y.resolve([]);const r=[],i=[],{layer:s}=this,n=v.getFetchPopupTemplate(s,e);if(!o.isSome(n))return y.resolve([]);const l=await this._loadArcadeModules(n),a=l&&l.arcadeUtils.hasGeometryOperations(n),u=await this.createPopupQuery(e),p=f.unpackFieldNames(s.fields,u.outFields);for(const e of t)a||!f.featureHasFields(p,e)?i.push(e):r.push(e);return"stream"===s.type||0===i.length?y.resolve(r):(u.objectIds=i.map((e=>e.attributes[s.objectIdField])),s.queryFeatures(u).then((e=>r.concat(e.features))).catch((()=>i)))},i.createPopupQuery=async function(e){const t=this.layer,r=t.createQuery(),i=v.getFetchPopupTemplate(t,e),s=o.isSome(i)&&await this._loadArcadeModules(i),n=o.isSome(i)&&s&&s.arcadeUtils.hasGeometryOperations(i),l=!("point"!==t.geometryType&&!n);return r.returnGeometry=l,r.returnZ=l,r.returnM=l,r.outFields=await v.getRequiredFields(this.layer,i),r.outSpatialReference=this.view.spatialReference,r},i.canResume=function(){return!!e.prototype.canResume.call(this)&&(!o.isSome(this.timeExtent)||!this.timeExtent.isEmpty)},t._createClass(r,[{key:"availableFields",get:function(){const{layer:e,layer:{fields:t},requiredFields:r}=this;return"outFields"in e&&e.outFields?f.fixFields(t,[...f.unpackFieldNames(t,e.outFields),...r]):f.fixFields(t,r)}},{key:"maximumNumberOfFeatures",get:function(){return 0},set:function(e){x.error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}},{key:"maximumNumberOfFeaturesExceeded",get:function(){return!1}}]),r}(e);return r.__decorate([l.property()],i.prototype,"_updatingRequiredFieldsPromise",void 0),r.__decorate([l.property({readOnly:!0,dependsOn:["layer.outFields?","requiredFields"]})],i.prototype,"availableFields",null),r.__decorate([l.property({type:w})],i.prototype,"effect",void 0),r.__decorate([l.property({type:g})],i.prototype,"filter",void 0),r.__decorate([l.property(F.combinedViewLayerTimeExtentProperty)],i.prototype,"timeExtent",void 0),r.__decorate([l.property()],i.prototype,"layer",void 0),r.__decorate([l.property({type:Number})],i.prototype,"maximumNumberOfFeatures",null),r.__decorate([l.property({readOnly:!0,type:Boolean})],i.prototype,"maximumNumberOfFeaturesExceeded",null),r.__decorate([l.property({readOnly:!0})],i.prototype,"requiredFields",void 0),r.__decorate([l.property({dependsOn:["timeExtent"]})],i.prototype,"suspended",void 0),r.__decorate([l.property()],i.prototype,"view",void 0),i=r.__decorate([a.subclass("esri.views.layers.FeatureLayerView")],i),i},Object.defineProperty(e,"__esModule",{value:!0})}));
