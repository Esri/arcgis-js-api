/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/Error","../../core/Logger","../../core/maybe","../../core/promiseUtils","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/accessorSupport/decorators/subclass","../../layers/support/commonProperties","../../layers/support/FeatureEffect","../../layers/support/FeatureFilter","../../layers/support/fieldUtils","../../layers/support/floorFilterUtils","../../rest/support/Query","../../support/arcadeOnDemand","./support/popupUtils"],(function(e,t,r,i,o,n,l,s,a,u,c,p,d,f,y,h,m,F,g){"use strict";const _="esri.views.layers.FeatureLayerView",w=i.getLogger(_),b=i=>{let a=function(t){function i(...e){var r;return(r=t.call(this,...e)||this)._updatingRequiredFieldsPromise=null,r.filter=null,r.timeExtent=null,r.layer=null,r.requiredFields=[],r.view=null,r}e._inheritsLoose(i,t);var s=i.prototype;return s.initialize=function(){this.handles.add([l.watch((()=>{const e=this.layer;return[e?.elevationInfo?.featureExpressionInfo,e&&"displayField"in e?e.displayField:null,e&&"timeInfo"in e&&e.timeInfo,e&&"renderer"in e&&e.renderer,e&&"labelingInfo"in e&&e.labelingInfo,e&&"floorInfo"in e&&e.floorInfo,this.filter,this.featureEffect,this.timeExtent]}),(()=>this._handleRequiredFieldsChange()),l.syncAndInitial),l.on((()=>this.view?.floors),"change",(()=>this._handleRequiredFieldsChange())),l.on((()=>{const e=this.layer;return e&&"sublayers"in e?e.sublayers:null}),"change",(()=>this._handleRequiredFieldsChange()))])},s.highlight=function(e){throw new Error("missing implementation")},s.createQuery=function(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},t=o.isSome(this.filter)?this.filter.createQuery(e):new m(e);if("feature"===this.layer.type){const e=h.getFloorFilterClause(this);o.isSome(e)&&(t.where=t.where?`(${t.where}) AND (${e})`:e)}return o.isSome(this.timeExtent)&&(t.timeExtent=o.isSome(t.timeExtent)?t.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),t},s.createAggregateQuery=function(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};return new m(e)},s.queryFeatures=function(e,t){throw new Error("missing implementation")},s.queryObjectIds=function(e,t){throw new Error("missing implementation")},s.queryFeatureCount=function(e,t){throw new Error("missing implementation")},s.queryExtent=function(e,t){throw new Error("missing implementation")},s.fetchPopupFeatures=function(){var t=e._asyncToGenerator((function*(e,t){const r=this.validateFetchPopupFeatures(t);if(r)throw r;return this.fetchClientPopupFeatures(t)}));function r(e,r){return t.apply(this,arguments)}return r}(),s._loadArcadeModules=function(e){return e.get("expressionInfos.length")||Array.isArray(e.content)&&e.content.some((e=>"expression"===e.type))?F.loadArcade():Promise.resolve()},s._handleRequiredFieldsChange=function(){const e=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",e),e.then((()=>{this._updatingRequiredFieldsPromise===e&&this._set("_updatingRequiredFieldsPromise",null)}))},s._updateRequiredFields=function(){var t=e._asyncToGenerator((function*(){if(!this.layer||!this.view)return;const e="3d"===this.view.type,{layer:t,layer:{fieldsIndex:r,objectIdField:i}}=this,l="renderer"in t&&t.renderer,s="orderBy"in t&&t.orderBy,a="featureReduction"in t?t.featureReduction:null,u=new Set,c=yield n.eachAlways([l?l.collectRequiredFields(u,r):null,y.collectLabelingFields(u,t),e?y.collectElevationFields(u,t):null,o.isSome(this.filter)?y.collectFilterFields(u,t,this.filter):null,o.isSome(this.featureEffect)?y.collectFilterFields(u,t,this.featureEffect.filter):null,a?y.collectFeatureReductionFields(u,t,a):null,s?y.collectOrderByInfos(u,t,s):null]);if("timeInfo"in t&&t.timeInfo&&this.timeExtent&&y.collectFields(u,t.fieldsIndex,[t.timeInfo.startField,t.timeInfo.endField]),"feature"===t.type&&(t.floorInfo&&y.collectFields(u,t.fieldsIndex,[t.floorInfo.floorField]),e&&o.isSome(t.infoFor3D)&&(null==t.globalIdField&&w.error("globalIdField missing on 3DObjectFeatureLayer"),y.collectFields(u,t.fieldsIndex,[t.globalIdField]))),"subtype-group"===t.type){y.collectField(u,r,t.subtypeField);const e=t.sublayers.map((e=>Promise.all([e.renderer?.collectRequiredFields(u,r),y.collectLabelingFields(u,e)])));yield n.eachAlways(e)}for(const o of c)o.error&&w.error(o.error);y.collectField(u,r,i),e&&"displayField"in t&&t.displayField&&y.collectField(u,r,t.displayField);const p=Array.from(u).sort();this._set("requiredFields",p)}));function r(){return t.apply(this,arguments)}return r}(),s.validateFetchPopupFeatures=function(e){if(o.isNone(e))return null;for(const t of e.clientGraphics??[]){const i=t.layer;if("popupEnabled"in i&&!i.popupEnabled)return new r("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:i});if(t.isAggregate){const e="featureReduction"in i?i.featureReduction:null;if(!(e&&"popupTemplate"in e&&e.popupEnabled&&e.popupTemplate))return new r("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:i})}else if("popupTemplate"in i){if(!g.getFetchPopupTemplate(i,e))return new r("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:i})}}},s.fetchClientPopupFeatures=function(){var t=e._asyncToGenerator((function*(e){const t=o.isSome(e)?e.clientGraphics:null;if(!t||0===t.length)return[];const r=new Array(t.length),i=new Map,n=yield this.createPopupQuery(e);for(let l=0;l<t.length;l++){const s=t[l];if(s.isAggregate){r[l]=s;continue}const a=s.layer;if(!("popupEnabled"in a))continue;const u=y.unpackFieldNames(this.layer.fieldsIndex,n.outFields),c=g.getFetchPopupTemplate(a,e);if(o.isNone(c))continue;const p=yield this._loadArcadeModules(c);p&&p.arcadeUtils.hasGeometryOperations(c)||!y.featureHasFields(u,s)?i.set(s.getObjectId(),{graphic:s,index:l}):r[l]=s}if("stream"===this.layer.type||0===i.size)return r.filter(Boolean);n.objectIds=Array.from(i.keys());try{const e=yield this.layer.queryFeatures(n);for(const t of e.features){const{graphic:{geometry:e},index:o}=i.get(t.getObjectId());t.geometry||(t.geometry=e),r[o]=t}}catch{}return r.filter(Boolean)}));function r(e){return t.apply(this,arguments)}return r}(),s.createPopupQuery=function(){var t=e._asyncToGenerator((function*(e){const t=this.layer.createQuery(),r=new Set;let i=!1;const n=o.isSome(e)&&e.clientGraphics?e.clientGraphics.map((e=>e.layer)):[this.layer];for(const l of n){if(!("popupEnabled"in l))continue;const t=g.getFetchPopupTemplate(l,e);if(o.isNone(t))continue;const n=yield this._loadArcadeModules(t),s=n&&n.arcadeUtils.hasGeometryOperations(t);i=!("point"!==this.layer.geometryType&&!s);const a=yield g.getRequiredFields(this.layer,t);for(const e of a)r.add(e)}if(t.returnGeometry=i,t.returnZ=i,t.returnM=i,t.outFields=Array.from(r),t.outSpatialReference=this.view.spatialReference,"feature"===this.layer.type){const e=h.getFloorFilterClause(this);o.isSome(e)&&(t.where=t.where?`(${t.where}) AND (${e})`:e)}return t}));function r(e){return t.apply(this,arguments)}return r}(),s.canResume=function(){return!!t.prototype.canResume.call(this)&&(!o.isSome(this.timeExtent)||!this.timeExtent.isEmpty)},e._createClass(i,[{key:"availableFields",get:function(){const{layer:e,layer:{fieldsIndex:t},requiredFields:r}=this;return"outFields"in e&&e.outFields?y.fixFields(t,[...y.unpackFieldNames(t,e.outFields),...r]):y.fixFields(t,r)}},{key:"featureEffect",get:function(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null},set:function(e){this._override("featureEffect",e)}},{key:"maximumNumberOfFeatures",get:function(){return 0},set:function(e){w.error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}},{key:"maximumNumberOfFeaturesExceeded",get:function(){return!1}}]),i}(i);return t.__decorate([s.property()],a.prototype,"_updatingRequiredFieldsPromise",void 0),t.__decorate([s.property({readOnly:!0})],a.prototype,"availableFields",null),t.__decorate([s.property({type:d})],a.prototype,"featureEffect",null),t.__decorate([s.property({type:f})],a.prototype,"filter",void 0),t.__decorate([s.property(p.combinedViewLayerTimeExtentProperty)],a.prototype,"timeExtent",void 0),t.__decorate([s.property()],a.prototype,"layer",void 0),t.__decorate([s.property({type:Number})],a.prototype,"maximumNumberOfFeatures",null),t.__decorate([s.property({readOnly:!0,type:Boolean})],a.prototype,"maximumNumberOfFeaturesExceeded",null),t.__decorate([s.property({readOnly:!0})],a.prototype,"requiredFields",void 0),t.__decorate([s.property()],a.prototype,"suspended",void 0),t.__decorate([s.property()],a.prototype,"view",void 0),a=t.__decorate([c.subclass(_)],a),a};return b}));
