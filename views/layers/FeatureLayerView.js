/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/deprecate","../../core/Error","../../core/Logger","../../core/maybe","../../core/promiseUtils","../../core/watchUtils","../../core/accessorSupport/decorators/property","../../core/arrayUtils","../../core/has","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass","../../layers/support/commonProperties","../../layers/support/FeatureEffect","../../layers/support/FeatureFilter","../../layers/support/fieldUtils","../../rest/support/Query","../../support/arcadeOnDemand","./support/popupUtils","../support/floorFilterUtils"],(function(e,t,r,i,o,n,l,s,a,u,c,p,d,f,y,h,m,F,g,_,w,E){"use strict";const v=n.getLogger("esri.views.layers.FeatureLayerView"),b=e=>{let n=function(e){function r(...t){var r;return(r=e.call(this,...t)||this)._updatingRequiredFieldsPromise=null,r.filter=null,r.timeExtent=null,r.layer=null,r.requiredFields=[],r.view=null,r}t._inheritsLoose(r,e);var n=r.prototype;return n.initialize=function(){a.init(this,["layer.renderer","layer.labelingInfo","layer.elevationInfo.featureExpressionInfo","layer.displayField","filter","featureEffect","layer.timeInfo","layer.floorInfo","timeExtent"],(()=>this._handleRequiredFieldsChange()),!0),a.on(this,"view.floors","change",(()=>this._handleRequiredFieldsChange())),a.on(this,"layer.sublayer","change",(()=>this._handleRequiredFieldsChange()))},n.highlight=function(e){throw new Error("missing implementation")},n.createQuery=function(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},t=l.isSome(this.filter)?this.filter.createQuery(e):new g(e);if("feature"===this.layer.type){const e=E.getFloorFilterClause(this);l.isSome(e)&&(t.where=t.where?`(${t.where}) AND (${e})`:e)}return l.isSome(this.timeExtent)&&(t.timeExtent=l.isSome(t.timeExtent)?t.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),t},n.queryFeatures=function(e,t){throw new Error("missing implementation")},n.queryObjectIds=function(e,t){throw new Error("missing implementation")},n.queryFeatureCount=function(e,t){throw new Error("missing implementation")},n.queryExtent=function(e,t){throw new Error("missing implementation")},n.fetchPopupFeatures=function(){var e=t._asyncToGenerator((function*(e,t){const r=this.validateFetchPopupFeatures(t);if(r)throw r;return this.fetchClientPopupFeatures(t)}));function r(t,r){return e.apply(this,arguments)}return r}(),n._loadArcadeModules=function(e){if(e.get("expressionInfos.length")||Array.isArray(e.content)&&e.content.some((e=>"expression"===e.type)))return _.loadArcade()},n._handleRequiredFieldsChange=function(){const e=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",e),e.then((()=>{this._updatingRequiredFieldsPromise===e&&this._set("_updatingRequiredFieldsPromise",null)}))},n._updateRequiredFields=function(){var e=t._asyncToGenerator((function*(){if(!this.layer||!this.view)return;const e="3d"===this.view.type,{layer:t,layer:{fieldsIndex:r,objectIdField:i}}=this,o="renderer"in t&&t.renderer,n="orderBy"in t&&t.orderBy,a=t.featureReduction,u=new Set,c=yield s.eachAlways([o?o.collectRequiredFields(u,r):null,F.collectLabelingFields(u,t),e?F.collectElevationFields(u,t):null,l.isSome(this.filter)?F.collectFilterFields(u,t,this.filter):null,l.isSome(this.featureEffect)?F.collectFilterFields(u,t,this.featureEffect.filter):null,a?F.collectFeatureReductionFields(u,t,a):null,n?F.collectOrderByInfos(u,t,n):null]);if(t.timeInfo&&this.timeExtent&&F.collectFields(u,t.fieldsIndex,[t.timeInfo.startField,t.timeInfo.endField]),"feature"===t.type&&t.floorInfo&&F.collectFields(u,t.fieldsIndex,[t.floorInfo.floorField]),"subtype-group"===t.type){F.collectField(u,r,t.subtypeField);const e=t.sublayers.map((e=>{var t;return Promise.all([null==(t=e.renderer)?void 0:t.collectRequiredFields(u,r),F.collectLabelingFields(u,e)])}));yield s.eachAlways(e)}for(const l of c)l.error&&v.error(l.error);F.collectField(u,r,i),e&&"displayField"in t&&t.displayField&&F.collectField(u,r,t.displayField);const p=Array.from(u).sort();this._set("requiredFields",p)}));function r(){return e.apply(this,arguments)}return r}(),n.validateFetchPopupFeatures=function(e){if(l.isNone(e))return null;for(const t of e.clientGraphics){const r=t.layer;if("popupEnabled"in r&&!r.popupEnabled)return new o("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:r});if("popupTemplate"in r){if(!w.getFetchPopupTemplate(r,e))return new o("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:r})}if(t.isAggregate&&!(r.featureReduction&&"popupTemplate"in r.featureReduction&&r.featureReduction.popupEnabled&&r.featureReduction.popupTemplate))return new o("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:r})}},n.fetchClientPopupFeatures=function(){var e=t._asyncToGenerator((function*(e){const t=l.isSome(e)?e.clientGraphics:null;if(!t||0===t.length)return[];const r=new Array(t.length),i=new Map,o=yield this.createPopupQuery(e);for(let n=0;n<t.length;n++){const s=t[n];if(s.isAggregate){r[n]=s;continue}const{layer:a}=s;if(!("popupEnabled"in a))continue;const u=F.unpackFieldNames(this.layer.fieldsIndex,o.outFields),c=w.getFetchPopupTemplate(a,e);if(!l.isSome(c))continue;const p=yield this._loadArcadeModules(c);p&&p.arcadeUtils.hasGeometryOperations(c)||!F.featureHasFields(u,s)?i.set(s.getObjectId(),n):r[n]=s}if("stream"===this.layer.type||0===i.size)return r.filter(Boolean);o.objectIds=Array.from(i.keys());try{const e=yield this.layer.queryFeatures(o);for(const t of e.features){r[i.get(t.getObjectId())]=t}}catch{}return r.filter(Boolean)}));function r(t){return e.apply(this,arguments)}return r}(),n.createPopupQuery=function(){var e=t._asyncToGenerator((function*(e){const t=this.layer.createQuery(),r=new Set;let i=!1;const o=l.isSome(e)&&e.clientGraphics?e.clientGraphics.map((e=>e.layer)):[this.layer];for(const n of o){if(!("popupEnabled"in n))continue;const t=w.getFetchPopupTemplate(n,e);if(!l.isSome(t))continue;const o=yield this._loadArcadeModules(t),s=o&&o.arcadeUtils.hasGeometryOperations(t);i=!("point"!==this.layer.geometryType&&!s);const a=yield w.getRequiredFields(this.layer,t);for(const e of a)r.add(e)}if(t.returnGeometry=i,t.returnZ=i,t.returnM=i,t.outFields=Array.from(r),t.outSpatialReference=this.view.spatialReference,"feature"===this.layer.type){const e=E.getFloorFilterClause(this);l.isSome(e)&&(t.where=t.where?`(${t.where}) AND (${e})`:e)}return t}));function r(t){return e.apply(this,arguments)}return r}(),n.canResume=function(){return!!e.prototype.canResume.call(this)&&(!l.isSome(this.timeExtent)||!this.timeExtent.isEmpty)},t._createClass(r,[{key:"availableFields",get:function(){const{layer:e,layer:{fieldsIndex:t},requiredFields:r}=this;return"outFields"in e&&e.outFields?F.fixFields(t,[...F.unpackFieldNames(t,e.outFields),...r]):F.fixFields(t,r)}},{key:"effect",get:function(){return i.deprecatedProperty(v,"effect",{replacement:"featureEffect",version:"4.22"}),this.featureEffect},set:function(e){i.deprecatedProperty(v,"effect",{replacement:"featureEffect",version:"4.22"}),this.featureEffect=e}},{key:"featureEffect",get:function(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null},set:function(e){void 0!==e?this._override("featureEffect",e):this._clearOverride("featureEffect")}},{key:"maximumNumberOfFeatures",get:function(){return 0},set:function(e){v.error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}},{key:"maximumNumberOfFeaturesExceeded",get:function(){return!1}}]),r}(e);return r.__decorate([u.property()],n.prototype,"_updatingRequiredFieldsPromise",void 0),r.__decorate([u.property({readOnly:!0})],n.prototype,"availableFields",null),r.__decorate([u.property()],n.prototype,"effect",null),r.__decorate([u.property({type:h})],n.prototype,"featureEffect",null),r.__decorate([u.property({type:m})],n.prototype,"filter",void 0),r.__decorate([u.property(y.combinedViewLayerTimeExtentProperty)],n.prototype,"timeExtent",void 0),r.__decorate([u.property()],n.prototype,"layer",void 0),r.__decorate([u.property({type:Number})],n.prototype,"maximumNumberOfFeatures",null),r.__decorate([u.property({readOnly:!0,type:Boolean})],n.prototype,"maximumNumberOfFeaturesExceeded",null),r.__decorate([u.property({readOnly:!0})],n.prototype,"requiredFields",void 0),r.__decorate([u.property()],n.prototype,"suspended",void 0),r.__decorate([u.property()],n.prototype,"view",void 0),n=r.__decorate([f.subclass("esri.views.layers.FeatureLayerView")],n),n};e.FeatureLayerView=b,e.default=b,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
