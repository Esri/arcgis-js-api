/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/lang","../../../core/Logger","../../../core/Error","../../../colorUtils","./effects","./parser"],(function(e,t,s,n,r,f,c,i){"use strict";let l=function(){function e(e=200){this.duration=e,this._from=null,this._to=null,this._final=null,this._current=[],this._time=0,this._effect="",this._effects=[],this._scale=0}var r=e.prototype;return r.transitionStep=function(e,t){this._applyTimeTransition(e),this._updateForScale(t)},r._transitionTo=function(e){this.scale>0&&_(this._current,e,this.scale)?(this._final=e,this._to=s.clone(e),g(this._current,this._to,this.scale),this._from=s.clone(this._current),this._time=0):(this._from=this._to=this._final=null,this._current=e),this._effects=this._current[0]?s.clone(this._current[0].effects):[]},r._applyTimeTransition=function(e){if(!this._to)return;this._time+=e;const t=Math.min(1,this._time/this.duration);for(let e=0;e<this._current.length;e++){const s=this._current[e],n=this._from[e],r=this._to[e];s.scale=p(n.scale,r.scale,t);for(let e=0;e<s.effects.length;e++){const f=s.effects[e],c=n.effects[e],i=r.effects[e];f.interpolate(c,i,t)}}1===t&&(this._current=this._final,this._effects=this._current[0]?s.clone(this._current[0].effects):[],this._from=this._to=this._final=null)},r._updateForScale=function(e){if(0===this._current.length)return;this._scale=e;const t=this._current,s=this._current.length-1;let n,r,f=1;if(1===t.length||e>=t[0].scale)r=n=t[0].effects;else if(e<=t[s].scale)r=n=t[s].effects;else for(let c=0;c<s;c++){const s=t[c],i=t[c+1];if(s.scale>=e&&i.scale<=e){f=(e-s.scale)/(i.scale-s.scale),n=s.effects,r=i.effects;break}}for(let e=0;e<this._effects.length;e++){this._effects[e].interpolate(n[e],r[e],f)}},t._createClass(e,[{key:"effect",get:function(){return this._effect},set:function(e){if(e=e||"",this._effect===e)return;this._effect=e;const t=o(e);Array.isArray(t)?this._transitionTo(t):(this._transitionTo([]),n.getLogger("esri.views.layers.effects.EffectList").warn("Invalid Effect",{effect:e,error:t}))}},{key:"hasEffects",get:function(){return this.transitioning||!!this._effects.length}},{key:"effects",get:function(){return this._effects}},{key:"scale",get:function(){return this._scale}},{key:"transitioning",get:function(){return null!==this._to}}]),e}();function o(e){if(!e)return[];if("string"==typeof e){const t=i.parse(e);return t.error?t.error:[{scale:-1,effects:t.effects}]}const t=[];for(const s of e){if(!isFinite(s.scale)||s.scale<=0)return new r("effect:invalid-scale","scale must be finite and greater than 0",{stop:s});const e=i.parse(s.value);if(e.error)return e.error;t.push({scale:s.scale,effects:e.effects})}t.sort(((e,t)=>t.effects.length-e.effects.length));for(let e=0;e<t.length-1;e++){if(!h(t[e].effects,t[e+1].effects))return new r("effect:interpolation-impossible","Cannot interpolate by scale between 2 lists of mixed effects",{a:t[e].effects,b:t[e+1].effects});u(t[e].effects,t[e+1].effects)}return t.sort(((e,t)=>t.scale-e.scale)),t}function a(e){switch(e.type){case"grayscale":case"sepia":case"invert":return new c.ColorMatrixEffect(e.type,0);case"saturate":case"brightness":case"contrast":return new c.ColorMatrixEffect(e.type,1);case"opacity":return new c.OpacityEffect(1);case"hue-rotate":return new c.HueRotateEffect(0);case"blur":return new c.BlurEffect(0);case"drop-shadow":return new c.DropShadowEffect(0,0,0,[...f.getNamedColor("transparent")]);case"bloom":return new c.BloomEffect(0,0,0)}}function h(e,t){const s=e.length>t.length?e:t;return(e.length>t.length?t:e).every(((e,t)=>e.type===s[t].type))}function u(e,t){const s=e.length>t.length?e:t,n=e.length>t.length?t:e;for(let e=n.length;e<s.length;e++)n.push(a(s[e]))}function _(e,t,s){var n,r,f,c;if(null==(n=e[0])||!n.effects||null==(r=t[0])||!r.effects)return!0;return!((-1===(null==(f=e[0])?void 0:f.scale)||-1===(null==(c=t[0])?void 0:c.scale))&&(e.length>1||t.length>1)&&s<=0)&&h(e[0].effects,t[0].effects)}function g(e,t,s){var n,r;const f=e.length>t.length?e:t,c=e.length>t.length?t:e,i=c[c.length-1],l=null!=(n=null==i?void 0:i.scale)?n:s,o=null!=(r=null==i?void 0:i.effects)?r:[];for(let e=c.length;e<f.length;e++)c.push({scale:l,effects:[...o]});for(let e=0;e<f.length;e++)c[e].scale=-1===c[e].scale?s:c[e].scale,f[e].scale=-1===f[e].scale?s:f[e].scale,u(c[e].effects,f[e].effects)}function p(e,t,s){return e+(t-e)*s}e.canInterpolateEffectStops=_,e.canInterpolateEffects=h,e.convertEffectToStops=o,e.default=l,e.normalizeEffectStops=g,e.normalizeEffects=u,Object.defineProperty(e,"__esModule",{value:!0})}));
