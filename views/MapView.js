/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["require","../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../Graphic","../core/Collection","../core/CollectionFlattener","../core/Error","../core/has","../core/iteratorUtils","../core/Logger","../core/maybe","../core/watchUtils","../core/workers/workers","../core/accessorSupport/decorators/property","../core/arrayUtils","../core/accessorSupport/ensureType","../core/accessorSupport/decorators/subclass","./BreakpointsOwner","./DOMContainer","./MapViewBase","./2d/input/MapViewInputManager","./2d/support/HighlightOptions","./support/createScreenshotPlan","./support/screenshotUtils","./support/screenUtils","./support/WebGLRequirements","./ui/2d/DefaultUI2D","../webmap/background/ColorBackground"],(function(e,t,i,r,n,a,s,o,l,p,c,h,u,d,g,y,w,f,_,m,v,V,b,M,S,O,k,L){"use strict";const C=p.getLogger("esri.views.MapView");let E,x,P,N,G,R;function T(){return W.apply(this,arguments)}function W(){return(W=t._asyncToGenerator((function*(){const[,{GraphicsView2D:t,GraphicContainer:i,LabelManager:r,MapViewNavigation:n,MagnifierView2D:a,Stage:s}]=yield Promise.all([new Promise(((t,i)=>e(["./webgl"],t,i))),new Promise(((t,i)=>e(["./2d/mapViewDeps"],t,i)))]);x=t,P=i,N=r,G=n,R=a,E=s}))).apply(this,arguments)}let q=function(e){function i(i){var r;return(r=e.call(this,i)||this)._magnifierView=null,r._stage=null,r._resolveWhenReady=[],r.rootLayerViews=new a({getCollections:()=>{var e,t;return[null==(e=r.basemapView)?void 0:e.baseLayerViews,r.layerViews,null==(t=r.basemapView)?void 0:t.referenceLayerViews]},getChildrenFunction:()=>null}),r.floors=new n,r.graphicsView=null,r.highlightOptions=new V,r.inputManager=new v({view:t._assertThisInitialized(r)}),r.mapViewNavigation=null,r.supersampleScreenshotsEnabled=!1,r.ui=new k,r.rendering=!1,u.initialize(),r}t._inheritsLoose(i,e);var r=i.prototype;return r.destroy=function(){this.rootLayerViews.destroy(),this.inputManager.destroy(),this._set("inputManager",null)},r.toMap=function(t){if(S.isSupportedScreenPointEvent(t)){const i=S.createScreenPointFromSupportedEvent(this,t);return e.prototype.toMap.call(this,i)}return e.prototype.toMap.call(this,t)},r.hitTest=function(){var e=t._asyncToGenerator((function*(e,t){const i=S.isSupportedScreenPointEvent(e)?S.createScreenPointFromSupportedEvent(this,e):e;if(!this.ready||isNaN(i.x)||isNaN(i.y))return{screenPoint:i,results:[]};let r=new Set,n=!1,a=null,s=null;null!=t&&t.include?B(t.include,D(this,(e=>r.add(e)),(e=>{a||(a=new Set),a.add(e)}),(e=>r.add(e)),(()=>n=!0))):(n=!0,r=new Set(this.allLayerViews)),null!=t&&t.exclude&&B(t.exclude,D(this,(e=>r.delete(e)),(e=>{s||(s=new Set),s.add(e)})));const o=this.allLayerViews.filter((e=>!e.suspended&&r.has(e))).reverse(),l=this.toMap(i);let p=(yield Promise.all([n?this.graphicsView.hitTest(l):null,...o.map((e=>e.hitTest(l,i)))])).filter(c.isSome).flat();return a&&(p=p.filter((e=>a.has(U(e))))),s&&(p=p.filter((e=>!s.has(U(e))))),{screenPoint:i,results:p.map((e=>({mapPoint:l,graphic:e})))}}));function i(t,i){return e.apply(this,arguments)}return i}(),r.takeScreenshot=function(e){e=e||{};const t=this.supersampleScreenshotsEnabled?Math.min(4,M.getMaximumResolutionScale(this.size,Math.min(4096,this._stage.context.parameters.maxTextureSize))):1;let i;e.layers?(i=[],e.layers.forEach((e=>{const t=this.allLayerViews.find((t=>t.layer.id===e.id));t&&"container"in t&&t.container&&i.push(t.container)}))):i=this._stage.children;const{format:r,quality:n}=M.getFormatAndQuality(e.format,e.quality),a=b(e,t,this.size,this.padding,r,n,i,e.rotation);return this._stage.takeScreenshot(a)},r.on=function(t,i,r,n){const a=this.inputManager&&this.viewEvents.on(t,i,r,n);return a||e.prototype.on.call(this,t,i)},r.hasEventListener=function(t){return e.prototype.hasEventListener.call(this,t)||this.viewEvents.hasHandler(t)},r.whenLayerView=function(t){return e.prototype.whenLayerView.call(this,t)},r.graphicChanged=function(e){if(this.graphicsView){this.graphicsView.graphicUpdateHandler(e)}},r.whenReady=function(){return new Promise((e=>{this.ready?e(this):this._resolveWhenReady.push(e)}))},r.forceDOMReadyCycle=function(){this.forceReadyCycle()},r.validate=function(){let e=O.check({checkMajorWebPerformanceCaveat:!1});return o("safari")&&o("safari")<9&&(e=new s("mapview:browser-not-supported","This browser is not supported by MapView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:o("safari")})),c.isSome(e)?(C.warn("#validate()",e.message),Promise.reject(e)):T()},r._startup=function(){this.timeline.begin("MapView Startup"),e.prototype._startup.call(this),this.graphics.owner=this;const t={disabledExtensions:this.deactivatedWebGLExtensions,debugWebGLExtensions:this.debugWebGLExtensions},i=new E(this.surface,{canvas:this.renderCanvas,supersampleScreenshots:this.supersampleScreenshotsEnabled,contextOptions:t,renderingOptions:this.renderingOptions,timeline:this.timeline}),r=new x({view:this,graphics:this.graphics,requestUpdateCallback:()=>this.requestUpdate(),container:new P(this.featuresTilingScheme)}),n=new G({view:this,animationManager:this.animationManager}),a=new N({view:this});this._magnifierView=new R,this._magnifierView.magnifier=this.magnifier,this._stage=i,this.frameTask.graphicsView=r,this._set("graphicsView",r),this._set("mapViewNavigation",n),this._set("labelManager",a),this.handles.add([this.rootLayerViews.on("change",(()=>this._updateStageChildren())),i.on("post-render",(()=>this._set("rendering",i.renderRequested))),i.on("will-render",(()=>this._set("rendering",i.renderRequested))),i.on("webgl-error",(e=>this.fatalError=e.error)),h.init(this,"stationary",(e=>i.stationary=e),!0),h.init(this,"state.id",(()=>i.state=this.state),!0),h.init(this,"background",(e=>{i.background=e,this._magnifierView.background=e}),!0),h.init(this,"magnifier",(e=>this._magnifierView.magnifier=e),!0),h.init(this,"renderingOptions",(e=>i.renderingOptions=e),!0),h.init(this,"highlightOptions",(()=>i.highlightOptions=this.highlightOptions),!0)],"map-view"),i.state=this.state,this._updateStageChildren();const s=this._resolveWhenReady;this._resolveWhenReady=[],s.forEach((e=>e(this))),this.timeline.end("MapView Startup")},r._teardown=function(){this.handles.remove("map-view"),this.layerViewManager.clear(),this.labelManager.destroy(),this._magnifierView.destroy(),this._stage.destroy();this.graphicsView.destroy(),this.mapViewNavigation.destroy(),this._stage=null,this._set("graphicsView",null),this._magnifierView=null,this._set("labelManager",null),this._set("mapViewNavigation",null),this.graphics.owner=null,e.prototype._teardown.call(this)},r._updateStageChildren=function(){this._stage.removeAllChildren(),this.rootLayerViews.forEach((e=>{this._stage.addChild(e.container)}));const e=this.graphicsView;this._stage.addChild(e.container),this._stage.addChild(this._magnifierView)},t._createClass(i,[{key:"background",get:function(){return this.get("map.initialViewProperties.background")||null},set:function(e){void 0===e?this._clearOverride("background"):this._override("background",e)}},{key:"resourceManager",get:function(){return this._stage.resourceManager}},{key:"textureManager",get:function(){return this._stage.painter.textureManager}},{key:"navigating",get:function(){return!(!this.mapViewNavigation||!this.mapViewNavigation.interacting)}}]),i}(f.BreakpointsOwner(_.DOMContainer(m)));i.__decorate([d.property({type:L})],q.prototype,"background",null),i.__decorate([d.property()],q.prototype,"floors",void 0),i.__decorate([d.property()],q.prototype,"graphicsView",void 0),i.__decorate([d.property({type:V})],q.prototype,"highlightOptions",void 0),i.__decorate([d.property({readOnly:!0})],q.prototype,"inputManager",void 0),i.__decorate([d.property({readOnly:!0})],q.prototype,"resourceManager",null),i.__decorate([d.property({readOnly:!0})],q.prototype,"textureManager",null),i.__decorate([d.property({readOnly:!0})],q.prototype,"mapViewNavigation",void 0),i.__decorate([d.property({type:Boolean})],q.prototype,"navigating",null),i.__decorate([d.property({type:Boolean,constructOnly:!0})],q.prototype,"supersampleScreenshotsEnabled",void 0),i.__decorate([d.property({type:k})],q.prototype,"ui",void 0),i.__decorate([d.property({readOnly:!0})],q.prototype,"rendering",void 0),i.__decorate([d.property({constructOnly:!0})],q.prototype,"renderCanvas",void 0),i.__decorate([d.property({constructOnly:!0})],q.prototype,"deactivatedWebGLExtensions",void 0),i.__decorate([d.property({constructOnly:!0})],q.prototype,"debugWebGLExtensions",void 0),q=i.__decorate([w.subclass("esri.views.MapView")],q);function U(e){const t=e.getObjectId();var i,r,n,a;return t?`${null!=(i=null!=(r=null==(n=e.layer)?void 0:n.uid)?r:null==(a=e.sourceLayer)?void 0:a.uid)?i:"MapView"}/${t}`:`"MapView/${e.uid}`}function D(e,t,i,n,a){return s=>{if(s instanceof r){if(s.layer===e)null==a||a();else{const t=e.allLayerViews.find((e=>e.layer===s.layer));t&&(null==n||n(t))}i(U(s))}else{const i=e.allLayerViews.find((e=>e.layer===s));i&&t(i)}}}function B(e,t){if(e)if(l.isIterable(e))for(const i of e)if(l.isIterable(i))for(const e of i)t(e);else t(i);else t(e)}return q}));
