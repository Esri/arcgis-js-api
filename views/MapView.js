/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["require","../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../Graphic","../core/Collection","../core/CollectionFlattener","../core/Error","../core/has","../core/Logger","../core/maybe","../core/watchUtils","../core/workers/workers","../core/accessorSupport/decorators/property","../core/accessorSupport/ensureType","../core/accessorSupport/decorators/subclass","./BreakpointsOwner","./DOMContainer","./MapViewBase","./2d/input/MapViewInputManager","./2d/support/HighlightOptions","./support/screenshotUtils","./support/screenUtils","./support/WebGLRequirements","./ui/2d/DefaultUI2D","../webmap/background/ColorBackground"],(function(e,t,i,r,n,s,a,o,p,h,c,l,d,u,g,y,w,_,f,v,m,V,b,M,S){"use strict";const k=p.getLogger("esri.views.MapView");let O,C,E,L,P,x;function N(){return R.apply(this,arguments)}function R(){return(R=t._asyncToGenerator((function*(){const[,{GraphicsView2D:t,GraphicContainer:i,LabelManager:r,MapViewNavigation:n,MagnifierView2D:s,Stage:a}]=yield Promise.all([new Promise((function(t,i){e(["./webgl"],t,i)})),new Promise((function(t,i){e(["./2d/mapViewDeps"],t,i)}))]);C=t,E=i,L=r,P=n,x=s,O=a}))).apply(this,arguments)}function W(e){return e instanceof r}function G(e,t,i){if(e)if(Array.isArray(e)||n.isCollection(e)){if(0===e.length)return;e.forEach((e=>G(e,t,i)))}else W(e)?t.add(e):i.add(e)}let T=function(e){function i(i){var r;return(r=e.call(this,i)||this)._magnifierView=null,r._stage=null,r._resolveWhenReady=[],r.rootLayerViews=new s({getCollections:()=>{var e,t;return[null==(e=r.basemapView)?void 0:e.baseLayerViews,r.layerViews,null==(t=r.basemapView)?void 0:t.referenceLayerViews]},getChildrenFunction:()=>null}),r.floors=new n,r.graphicsView=null,r.highlightOptions=new v,r.inputManager=new f({view:t._assertThisInitialized(r)}),r.mapViewNavigation=null,r.supersampleScreenhotsEnabled=!1,r.ui=new M,r.rendering=!1,l.initialize(),r}t._inheritsLoose(i,e);var r=i.prototype;return r.destroy=function(){this.rootLayerViews.destroy(),this.inputManager.destroy(),this._set("inputManager",null)},r.toMap=function(t){if(V.isSupportedScreenPointEvent(t)){const i=V.createScreenPointFromSupportedEvent(this,t);return e.prototype.toMap.call(this,i)}return e.prototype.toMap.call(this,t)},r.hitTest=function(e,t){const i=V.isSupportedScreenPointEvent(e)?V.createScreenPointFromSupportedEvent(this,e):e;if(!this.ready||isNaN(i.x)||isNaN(i.y))return Promise.resolve({screenPoint:i,results:[]});const r=this.toMap(i),n=[this.graphicsView];n.push.apply(n,this.allLayerViews.toArray().reverse());const s=new Set,a=new Set,o=new Set,p=new Set;return t&&(G(t&&t.include,s,o),G(t&&t.exclude,a,p)),Promise.all(n.map((e=>!e||!e.hitTest||o.size>0&&!e.layer||o.size>0&&e.layer&&!o.has(e.layer)||p.size>0&&e.layer&&p.has(e.layer)?null:e.hitTest(i.x,i.y)))).then((e=>({screenPoint:i,results:e.filter((e=>null!=e&&(!(s.size>0)||s.has(e))&&(!(a.size>0)||!a.has(e)))).map((e=>({mapPoint:r,graphic:e})))})))},r.takeScreenshot=function(e){return this.ready?this._stage.takeScreenshot(m.toRenderSettings(e,this),this.allLayerViews):Promise.reject("Map view cannot be used before it is ready")},r.on=function(t,i,r,n){const s=this.inputManager&&this.viewEvents.on(t,i,r,n);return s||e.prototype.on.call(this,t,i)},r.hasEventListener=function(t){return e.prototype.hasEventListener.call(this,t)||this.viewEvents.hasHandler(t)},r.whenLayerView=function(t){return e.prototype.whenLayerView.call(this,t)},r.graphicChanged=function(e){if(this.graphicsView){this.graphicsView.graphicUpdateHandler(e)}},r.whenReady=function(){return new Promise((e=>{this.ready?e(this):this._resolveWhenReady.push(e)}))},r.forceDOMReadyCycle=function(){this.forceReadyCycle()},r.validate=function(){let e=b.check({checkMajorWebPerformanceCaveat:!1});return o("safari")&&o("safari")<9&&(e=new a("mapview:browser-not-supported","This browser is not supported by MapView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:o("safari")})),h.isSome(e)?(k.warn("#validate()",e.message),Promise.reject(e)):N()},r._startup=function(){this.timeline.begin("MapView Startup"),e.prototype._startup.call(this),this.graphics.owner=this;const t={disabledExtensions:this.deactivatedWebGLExtensions,debugWebGLExtensions:this.debugWebGLExtensions},i=new O(this.surface,{canvas:this.renderCanvas,supersampleScreenshots:this.supersampleScreenhotsEnabled,contextOptions:t,renderingOptions:this.renderingOptions,timeline:this.timeline}),r=new C({view:this,graphics:this.graphics,requestUpdateCallback:()=>this.requestUpdate(),container:new E(this.featuresTilingScheme)}),n=new P({view:this,animationManager:this.animationManager}),s=new L({view:this});this._magnifierView=new x,this._magnifierView.magnifier=this.magnifier,this._stage=i,this.frameTask.graphicsView=r,this._set("graphicsView",r),this._set("mapViewNavigation",n),this._set("labelManager",s),this.handles.add([this.rootLayerViews.on("change",(()=>this._updateStageChildren())),i.on("post-render",(()=>this._set("rendering",i.renderRequested))),i.on("will-render",(()=>this._set("rendering",i.renderRequested))),i.on("webgl-error",(e=>this.fatalError=e.error)),c.init(this,"stationary",(e=>i.stationary=e),!0),c.init(this,"state.id",(()=>i.state=this.state),!0),c.init(this,"background",(e=>{i.background=e,this._magnifierView.background=e}),!0),c.init(this,"magnifier",(e=>this._magnifierView.magnifier=e),!0),c.init(this,"renderingOptions",(e=>i.renderingOptions=e),!0),c.init(this,"highlightOptions",(()=>i.highlightOptions=this.highlightOptions),!0)],"map-view"),i.state=this.state,this._updateStageChildren();const a=this._resolveWhenReady;this._resolveWhenReady=[],a.forEach((e=>e(this))),this.timeline.end("MapView Startup")},r._teardown=function(){this.handles.remove("map-view"),this.layerViewManager.clear(),this.labelManager.destroy(),this._magnifierView.destroy(),this._stage.destroy();this.graphicsView.destroy(),this.mapViewNavigation.destroy(),this._stage=null,this._set("graphicsView",null),this._magnifierView=null,this._set("labelManager",null),this._set("mapViewNavigation",null),this.graphics.owner=null,e.prototype._teardown.call(this)},r._updateStageChildren=function(){this._stage.removeAllChildren(),this.rootLayerViews.forEach((e=>{this._stage.addChild(e.container)}));const e=this.graphicsView;this._stage.addChild(e.container),this._stage.addChild(this._magnifierView)},t._createClass(i,[{key:"background",get:function(){return this.get("map.initialViewProperties.background")||null},set:function(e){void 0===e?this._clearOverride("background"):this._override("background",e)}},{key:"textureManager",get:function(){return this._stage.painter.textureManager}},{key:"navigating",get:function(){return!(!this.mapViewNavigation||!this.mapViewNavigation.interacting)}}]),i}(y.BreakpointsOwner(w.DOMContainer(_)));return i.__decorate([d.property({type:S})],T.prototype,"background",null),i.__decorate([d.property()],T.prototype,"floors",void 0),i.__decorate([d.property()],T.prototype,"graphicsView",void 0),i.__decorate([d.property({type:v})],T.prototype,"highlightOptions",void 0),i.__decorate([d.property({readOnly:!0})],T.prototype,"inputManager",void 0),i.__decorate([d.property({readOnly:!0})],T.prototype,"textureManager",null),i.__decorate([d.property({readOnly:!0})],T.prototype,"mapViewNavigation",void 0),i.__decorate([d.property({type:Boolean})],T.prototype,"navigating",null),i.__decorate([d.property({type:Boolean,constructOnly:!0})],T.prototype,"supersampleScreenhotsEnabled",void 0),i.__decorate([d.property({type:M})],T.prototype,"ui",void 0),i.__decorate([d.property({readOnly:!0})],T.prototype,"rendering",void 0),i.__decorate([d.property({constructOnly:!0})],T.prototype,"renderCanvas",void 0),i.__decorate([d.property({constructOnly:!0})],T.prototype,"deactivatedWebGLExtensions",void 0),i.__decorate([d.property({constructOnly:!0})],T.prototype,"debugWebGLExtensions",void 0),T=i.__decorate([g.subclass("esri.views.MapView")],T),T}));
