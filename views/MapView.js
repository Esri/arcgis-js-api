// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../Graphic","../core/Collection","../core/CollectionFlattener","../core/Error","../core/has","../core/Logger","../core/maybe","../core/promiseUtils","../core/screenUtils","../core/watchUtils","../core/workers","../core/accessorSupport/decorators","./BreakpointsOwner","./DOMContainer","./Magnifier","./MapViewBase","./2d/input/MapViewInputManager","./2d/support/HighlightOptions","./support/screenshotUtils","./support/WebGLRequirements","./ui/2d/DefaultUI2D","../webmap/background/ColorBackground","@dojo/framework/shim/Promise"],(function(e,t,r,i,n,a,o,s,p,c,u,h,l,d,g,y,w,f,v,_,m,V,b,M,O){var S,C,E,L,k,P=p.getLogger("esri.views.MapView");function x(e,t,r){if(e)if(Array.isArray(e)||n.isCollection(e)){if(0===e.length)return;e.forEach((function(e){return x(e,t,r)}))}else!function(e){return e instanceof i}(e)?r.add(e):t.add(e)}return function(t){function i(e){var r=t.call(this,e)||this;return r._magnifierView=null,r._stage=null,r._resolveWhenReady=[],r.rootLayerViews=new a({root:r,rootCollectionNames:["basemapView.baseLayerViews","layerViews","basemapView.referenceLayerViews"],getChildrenFunction:function(e){return null}}),r.graphicsView=null,r.highlightOptions=new m,r.magnifier=new f,r.inputManager=new _({view:r}),r.mapViewNavigation=null,r.supersampleScreenhotsEnabled=!0,r.ui=new M,r.rendering=!1,d.initialize(),r}return r.__extends(i,t),i.prototype.destroy=function(){this.rootLayerViews.destroy(),this.inputManager.destroy(),this._set("inputManager",null)},Object.defineProperty(i.prototype,"background",{get:function(){return this.get("map.initialViewProperties.background")||null},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"textureManager",{get:function(){return this._stage.painter.textureManager},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"navigating",{get:function(){return!(!this.mapViewNavigation||!this.mapViewNavigation.interacting)},enumerable:!0,configurable:!0}),i.prototype.toMap=function(e){if(h.isSupportedScreenPointEvent(e)){var r=h.createScreenPointFromSupportedEvent(this,e);return t.prototype.toMap.call(this,r)}return t.prototype.toMap.call(this,e)},i.prototype.hitTest=function(e,t){var r=h.isSupportedScreenPointEvent(e)?h.createScreenPointFromSupportedEvent(this,e):e;if(!this.ready||isNaN(r.x)||isNaN(r.y))return u.resolve({screenPoint:r,results:[]});var i=this.toMap(r),n=[this.graphicsView];n.push.apply(n,this.allLayerViews.toArray().reverse());var a=new Set,o=new Set,s=new Set,p=new Set;return t&&(x(t&&t.include,a,s),x(t&&t.exclude,o,p)),u.all(n.map((function(e){return!e||!e.hitTest||s.size>0&&!e.layer||s.size>0&&e.layer&&!s.has(e.layer)||p.size>0&&e.layer&&p.has(e.layer)?null:e.hitTest(r.x,r.y)}))).then((function(e){return{screenPoint:r,results:e.filter((function(e){return null!=e&&(!(a.size>0)||a.has(e))&&(!(o.size>0)||!o.has(e))})).map((function(e){return{mapPoint:i,graphic:e}}))}}))},i.prototype.takeScreenshot=function(e){return this.ready?this._stage.takeScreenshot(V.toRenderSettings(e,this),this.allLayerViews):u.reject("Map view cannot be used before it is ready")},i.prototype.on=function(e,r,i,n){var a=this.inputManager&&this.viewEvents.on(e,r,i,n);return a||t.prototype.on.call(this,e,r)},i.prototype.hasEventListener=function(e){return t.prototype.hasEventListener.call(this,e)||this.viewEvents.hasHandler(e)},i.prototype.whenLayerView=function(e){return t.prototype.whenLayerView.call(this,e)},i.prototype.graphicChanged=function(e){this.graphicsView&&this.graphicsView.graphicUpdateHandler(e)},i.prototype.whenReady=function(){var e=this;return u.create((function(t){e.ready?t(e):e._resolveWhenReady.push(t)}))},i.prototype.forceDOMReadyCycle=function(){this.forceReadyCycle()},i.prototype.validate=function(){var t=b.check({checkMajorWebPerformanceCaveat:!1});return s("safari")&&s("safari")<9&&(t=new o("mapview:browser-not-supported","This browser is not supported by MapView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:s("safari")})),c.isSome(t)?(P.warn("#validate()",t.message),u.reject(t)):function(){return r.__awaiter(this,void 0,void 0,(function(){var t,i,n,a,o,s,p;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,Promise.all([new Promise((function(t,r){e(["./webgl"],t,r)})),new Promise((function(t,r){e(["./2d/mapViewDeps"],t,r)})),new Promise((function(t,r){e(["./2d/engine"],t,r)}))])];case 1:return t=r.sent(),i=t[1],n=i.GraphicsView2D,a=i.LabelManager,o=i.MapViewNavigation,s=i.MagnifierView2D,p=t[2].Stage,C=n,E=a,L=o,k=s,S=p,[2]}}))}))}()},i.prototype._startup=function(){var e=this;this.timeline.begin("MapView Startup"),t.prototype._startup.call(this),this.graphics.owner=this;var r={deactivatedWebGLExtensions:this.deactivatedWebGLExtensions,debugWebGLExtensions:this.debugWebGLExtensions},i=new S(this.surface,{canvas:this.renderCanvas,supersampleScreenshots:this.supersampleScreenhotsEnabled,contextOptions:r,renderingOptions:this.renderingOptions,timeline:this.timeline}),n=new C({view:this,graphics:this.graphics,requestUpdateCallback:function(){return e.requestUpdate()}}),a=new L({view:this,animationManager:this.animationManager}),o=new E({view:this});this._magnifierView=new k,this._magnifierView.magnifier=this.magnifier,this._stage=i,this.frameTask.graphicsView=n,this._set("graphicsView",n),this._set("mapViewNavigation",a),this._set("labelManager",o),this.handles.add([this.rootLayerViews.on("change",(function(){return e._updateStageChildren()})),i.on("post-render",(function(){return e._set("rendering",i.renderRequested)})),i.on("will-render",(function(){return e._set("rendering",i.renderRequested)})),i.on("webgl-error",(function(t){return e.fatalError=t.error})),l.init(this,"stationary",(function(e){return i.stationary=e}),!0),l.init(this,"state.id",(function(){return i.state=e.state}),!0),l.init(this,"background",(function(e){return i.background=e}),!0),l.init(this,"magnifier",(function(t){return e._magnifierView.magnifier=t}),!0),l.init(this,"renderingOptions",(function(e){return i.renderingOptions=e}),!0),l.init(this,"highlightOptions",(function(){return i.highlightOptions=e.highlightOptions}),!0)],"map-view"),i.state=this.state,i.background=this.background,this._updateStageChildren();var s=this._resolveWhenReady;this._resolveWhenReady=[],s.forEach((function(t){return t(e)})),this.timeline.end("MapView Startup")},i.prototype._teardown=function(){this.handles.remove("map-view"),this.layerViewManager.clear(),this.labelManager.destroy(),this._magnifierView.destroy(),this._stage.destroy(),this.graphicsView.destroy(),this.mapViewNavigation.destroy(),this._stage=null,this._set("graphicsView",null),this._magnifierView=null,this._set("labelManager",null),this._set("mapViewNavigation",null),this.graphics.owner=null,t.prototype._teardown.call(this)},i.prototype._updateStageChildren=function(){var e=this;this._stage.removeAllChildren(),this.rootLayerViews.forEach((function(t){e._stage.addChild(t.container)}));var t=this.graphicsView;this._stage.addChild(t.container),this._stage.addChild(this._magnifierView)},r.__decorate([g.property({type:O,dependsOn:["map.initialViewProperties?.background"]})],i.prototype,"background",null),r.__decorate([g.property()],i.prototype,"graphicsView",void 0),r.__decorate([g.property({type:m})],i.prototype,"highlightOptions",void 0),r.__decorate([g.property({type:f})],i.prototype,"magnifier",void 0),r.__decorate([g.property({readOnly:!0})],i.prototype,"inputManager",void 0),r.__decorate([g.property({readOnly:!0})],i.prototype,"textureManager",null),r.__decorate([g.property({readOnly:!0})],i.prototype,"mapViewNavigation",void 0),r.__decorate([g.property({dependsOn:["mapViewNavigation.interacting"],type:Boolean})],i.prototype,"navigating",null),r.__decorate([g.property({type:Boolean,constructOnly:!0})],i.prototype,"supersampleScreenhotsEnabled",void 0),r.__decorate([g.property({type:M})],i.prototype,"ui",void 0),r.__decorate([g.property({readOnly:!0})],i.prototype,"rendering",void 0),r.__decorate([g.property({constructOnly:!0})],i.prototype,"renderCanvas",void 0),r.__decorate([g.property({constructOnly:!0})],i.prototype,"deactivatedWebGLExtensions",void 0),r.__decorate([g.property({constructOnly:!0})],i.prototype,"debugWebGLExtensions",void 0),i=r.__decorate([g.subclass("esri.views.MapView")],i)}(y.BreakpointsOwner(w.DOMContainer(v)))}));