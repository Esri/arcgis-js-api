/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/arrayUtils","../core/maybe","../core/promiseUtils","../core/Logger","../core/accessorSupport/ensureType","../core/has","../core/accessorSupport/set","../core/accessorSupport/decorators/subclass"],(function(e,r,i,t,s,a,p,n,o,c,u){"use strict";const l=e=>{let p=function(e){function i(){return e.apply(this,arguments)||this}r._inheritsLoose(i,e);var p=i.prototype;return p.fetchPopupFeatures=function(){var e=r._asyncToGenerator((function*(e,r){yield this.when();const{location:i,queryArea:s,layerViewsAndGraphics:p,clientOnlyGraphics:n}=yield this._prepareFetchPopupFeatures(e,r),o=Promise.resolve(n),c=this._queryLayerPopupFeatures(s,p,r),u=c.map((e=>e.promise));return{location:i,clientOnlyGraphics:n,allGraphicsPromise:a.eachAlwaysValues([o,...u]).then(t.flatten),promisesPerLayerView:c}}));function i(r,i){return e.apply(this,arguments)}return i}(),p._queryLayerPopupFeatures=function(e,r,i){return r.map((({layerView:r,graphics:t})=>{const a={clientGraphics:t,event:s.isSome(i)?i.event:null,signal:s.isSome(i)?i.signal:null,defaultPopupTemplateEnabled:!!s.isSome(i)&&!!i.defaultPopupTemplateEnabled},p=r.fetchPopupFeatures(e,a);return{layerView:r,promise:p}}))},p._isValidPopupGraphic=function(e,r){return e&&!!e.getEffectivePopupTemplate(s.isSome(r)&&r.defaultPopupTemplateEnabled)},p._prepareFetchPopupFeatures=function(){var e=r._asyncToGenerator((function*(e,r){const{clientGraphics:i,queryArea:t,location:s}=yield this._popupHitTestGraphics(e,r),a=this._getFetchPopupLayerViews(),{layerViewsAndGraphics:p,clientOnlyGraphics:n}=this._graphicsPerFetchPopupLayerView(i,a);return{clientOnlyGraphics:n,layerViewsAndGraphics:p,queryArea:t,location:s}}));function i(r,i){return e.apply(this,arguments)}return i}(),p._popupHitTestGraphics=function(){var e=r._asyncToGenerator((function*(e,r){const{results:i,mapPoint:t}=yield this.popupHitTest(e),s=i.filter((e=>this._isValidPopupGraphic(e.graphic,r))),a=s.length?s[0].mapPoint:null;return{clientGraphics:s.map((e=>e.graphic)),queryArea:t,location:t||a}}));function i(r,i){return e.apply(this,arguments)}return i}(),p._getFetchPopupLayerViews=function(){const e=[];return this.allLayerViews.forEach((r=>{this._isValidPopupLayerView(r)&&e.push(r)})),s.isSome(this.graphicsView)&&this._isValidPopupLayerView(this.graphicsView)&&e.push(this.graphicsView),e.reverse()},p._isValidPopupLayerView=function(e){return s.isSome(e)&&(!("layer"in e)||!e.suspended)&&"fetchPopupFeatures"in e},p._graphicsPerFetchPopupLayerView=function(e,r){const i=[],t=new Map,s=r.map((e=>{const r=[];return"layer"in e?t.set(e.layer,r):t.set(e.graphics,r),{layerView:e,graphics:r}}));for(const a of e){const e=t.get(a.layer)||t.get(a.sourceLayer)||null;e?e.push(a):i.push(a)}return{layerViewsAndGraphics:s,clientOnlyGraphics:i}},i}(e);return p=i.__decorate([u.subclass("esri.views.PopupView")],p),p};e.PopupView=l,Object.defineProperty(e,"__esModule",{value:!0})}));
