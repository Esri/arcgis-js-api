/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/has","../core/maybe","../core/Logger","../core/accessorSupport/ensureType","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/subclass","../core/urlUtils","../core/uuid","../portal/support/resourceExtension","../core/arrayUtils","../core/promiseUtils"],(function(e,r,i,s,t,a,p,o,n,c,u,l,h,y){"use strict";const w=e=>{let s=function(e){function i(){return e.apply(this,arguments)||this}r._inheritsLoose(i,e);var s=i.prototype;return s.fetchPopupFeatures=async function(e,r){await this.when();const{location:i,queryArea:s,layerViewsAndGraphics:t,clientOnlyGraphics:a}=await this._prepareFetchPopupFeatures(e,r),p=Promise.resolve(a),o=this._queryLayerPopupFeatures({queryArea:s,layerViewsAndGraphics:t,options:r}),n=o.map((e=>e.promise));return{location:i,clientOnlyGraphics:a,allGraphicsPromise:y.eachAlwaysValues([p,...n]).then(h.flatten),promisesPerLayerView:o}},s._queryLayerPopupFeatures=function({queryArea:e,layerViewsAndGraphics:r,options:i}){return r.map((({layerView:r,graphics:s})=>{const a={clientGraphics:s,event:t.isSome(i)?i.event:null,signal:t.isSome(i)?i.signal:null,defaultPopupTemplateEnabled:!!t.isSome(i)&&!!i.defaultPopupTemplateEnabled},p=r.fetchPopupFeatures(e,a);return{layerView:r,promise:p}}))},s._isValidPopupGraphic=function(e,r){return e&&!!e.getEffectivePopupTemplate(t.isSome(r)&&r.defaultPopupTemplateEnabled)},s._prepareFetchPopupFeatures=async function(e,r){const{clientGraphics:i,queryArea:s,location:t}=await this._popupHitTestGraphics(e,r),a=this._getFetchPopupLayerViews(),{layerViewsAndGraphics:p,clientOnlyGraphics:o}=this._graphicsPerFetchPopupLayerView(i,a);return{clientOnlyGraphics:o,layerViewsAndGraphics:p,queryArea:s,location:t}},s._popupHitTestGraphics=async function(e,r){const{results:i,mapPoint:s}=await this.popupHitTest(e),t=i.filter((e=>this._isValidPopupGraphic(e.graphic,r))),a=t.length?t[0].mapPoint:null;return{clientGraphics:t.map((e=>e.graphic)),queryArea:s,location:s||a}},s._getFetchPopupLayerViews=function(){const e=[];return this.allLayerViews.forEach((r=>{this._isValidPopupLayerView(r)&&e.push(r)})),t.isSome(this.graphicsView)&&this._isValidPopupLayerView(this.graphicsView)&&e.push(this.graphicsView),e.reverse()},s._isValidPopupLayerView=function(e){return t.isSome(e)&&(!("layer"in e)||!e.suspended)&&"fetchPopupFeatures"in e},s._graphicsPerFetchPopupLayerView=function(e,r){const i=[],s=new Map,t=r.map((e=>{const r=[];return"layer"in e?s.set(e.layer,r):s.set(e.graphics,r),{layerView:e,graphics:r}}));for(const a of e){const e=s.get(a.layer)||null;e?e.push(a):i.push(a)}return{layerViewsAndGraphics:t,clientOnlyGraphics:i}},i}(e);return s=i.__decorate([n.subclass("esri.views.PopupView")],s),s};e.PopupView=w,Object.defineProperty(e,"__esModule",{value:!0})}));
