/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../geometry","../Viewpoint","../core/Error","../core/Logger","../core/maybe","../core/promiseUtils","../core/screenUtils","../core/watchUtils","../core/accessorSupport/decorators/property","../core/has","../core/accessorSupport/ensureType","../core/accessorSupport/decorators/subclass","../geometry/support/webMercatorUtils","../layers/support/TileInfo","./PopupView","./View","./ViewAnimation","./2d/AnimationManager","./2d/FrameTask","./2d/layerViewModuleImportUtils","./2d/MapViewConstraints","./2d/PaddedViewState","./2d/tiling/PagedTileQueue","./2d/tiling/TileInfoView","./2d/tiling/TileKey","./2d/tiling/TileQueue","./2d/tiling/TileStrategy","./2d/viewpointUtils","./2d/layers/features/support/TileStore","./2d/support/Timeline","../geometry/Point","../geometry/Extent","../geometry/SpatialReference"],(function(t,e,i,n,s,r,a,o,p,l,c,h,d,u,y,_,m,f,g,w,v,T,V,S,z,R,b,x,k,O,M,I,P,A,E){"use strict";const G=r.getLogger("esri.views.MapView");function N(t){return t&&"esri.Viewpoint"===t.declaredClass}const L=160;let q=function(e){function i(i){var n;(n=e.call(this,i)||this)._stationaryTimer=null,n.frameTask=new v(t._assertThisInitialized(n)),n.featuresTilingScheme=null,n.fullOpacity=1,n.graphicsView=null,n.initialExtent=null,n.labelManager=null,n.renderingOptions={samplingMode:"dynamic",edgeLabelsVisible:!0,labelsAnimationTime:125,labelCollisionsEnabled:!0},n.resizeAlign="center",n.supportsGround=!1,n.timeline=new I.Timeline,n.type="2d",n.constraints=new V,n.padding={top:0,right:0,bottom:0,left:0};const s=n.handles,r=()=>n.notifyChange("updating");return s.add([n.watch("viewpoint",(()=>{n._lastStationaryEventTimestamp=performance.now(),n._flipStationary(L)}),!0),n.on("resize",(t=>n._resizeHandler(t))),n.watch("animationManager.animation",(t=>{n.animation=t})),n.allLayerViews.on("change",(()=>{r(),s.remove("map-view-base-layerViewsUpdating"),s.add(n.allLayerViews.map((t=>t.watch("updating",r))),"map-view-base-layerViewsUpdating")}))],"map-view-base"),n}t._inheritsLoose(i,e);var r=i.prototype;return r.destroy=function(){this.destroyed||(this._set("preconditionsReady",!1),this._gotoTask=this.frameTask=null)},r.goTo=function(t,e){if(t)return this.animation&&(this.animation=null),this._createAnimation(),l.whenTrueOnce(this,"ready",e&&e.signal).then((()=>{const i={animate:!0,...e},n=O.createAsync(t,this);return this.animation.update(n),this._gotoTask={},i.animate?this._gotoAnimated(n,i):this._gotoImmediate(n,i)}));G.error("#goTo()","target cannot be null or undefined")},r.hitTest=function(t){return Promise.reject("Should be implemented by subclasses")},r.popupHitTest=function(t){return this.hitTest(t).then((e=>({...e,mapPoint:this.toMap(t)})))},r.toMap=function(t){if(!this.ready)return null;const e=[0,0],[i,n]=this.state.toMap(e,[t.x,t.y]),s=this.spatialReference;return new P({x:i,y:n,spatialReference:s})},r.isTileInfoRequired=function(){return!0},r.toScreen=function(t){if(!this.ready)return null;const e=this._normalizeInput(t),i=[e.x,e.y];return this.state.toScreen(i,i),p.createScreenPoint(i[0],i[1])},r.pixelSizeAt=function(){return this.ready?this.state.resolution:(G.error("#pixelSizeAt()","Map view cannot be used before it is ready"),null)},r.requestUpdate=function(){this.ready&&this.frameTask.requestUpdate()},r.getDefaultSpatialReference=function(){return this.get("map.initialViewProperties.spatialReference")||this.get("defaultsFromMap.spatialReference")||null},r.isSpatialReferenceSupported=function(t,e){return!(!e&&!this._get("ready"))||null!==this._getDefaultViewpoint()},r.importLayerView=function(t){return T.layerView2DImporter.importLayerView(t)},r.hasLayerViewModule=function(t){return T.layerView2DImporter.hasLayerViewModule(t)},r._createAnimation=function(){return this.animation&&!this.animation.done||(this.animation=new g),this.animation},r._cancellableGoTo=function(t,e,i){const n=()=>t===this._gotoTask,s=i.then((()=>{n()&&(this.animation=null)})).catch((t=>{throw n()&&(this.animation=null,e.done||(e.stop(),this.frameTask.animationInProgress=!1)),t})),r=new Promise((t=>t(s)));return e.when().catch((()=>{n()&&r.cancel&&r.cancel()})),r},r._gotoImmediate=function(t,e){const i=this._gotoTask,n=this.animation,r=t.then((t=>{if(o.throwIfAborted(e),i!==this._gotoTask)throw new s("view:goto-interrupted","Goto was interrupted");this.viewpoint=n.target=t,n.finish()}));return this._cancellableGoTo(i,n,r)},r._gotoAnimated=function(t,e){const i=this._gotoTask,n=this.animation,r=t.then((t=>{if(o.throwIfAborted(e),i!==this._gotoTask)throw new s("view:goto-interrupted","Goto was interrupted");return n.update(t),this.animationManager.animate(n,this.viewpoint,e),n.when().then((()=>{}),(()=>{}))}));return this._cancellableGoTo(i,n,r)},r._resizeHandler=function(t){const e=this.state;if(!e)return;let i=this.state.paddedViewState.viewpoint;const n=this.state.paddedViewState.size.concat();e.size=[t.width,t.height],O.resize(i,i,n,this.state.paddedViewState.size,this.resizeAlign),i=this.constraints.constrain(i,null),this.state.viewpoint=i},r._startup=function(){const t=this._getDefaultViewpoint();this.constraints.view=this,this.constraints.fit(t),this._set("animationManager",new w({view:this})),this._set("state",new S({padding:this._get("padding"),size:this.size,viewpoint:t})),this._set("featuresTilingScheme",new R(_.create({spatialReference:this.spatialReference,size:512,numLODs:36}))),this._set("ready",!0),this.frameTask&&this.frameTask.start()},r._teardown=function(){this.frameTask&&this.frameTask.stop(),this._set("ready",!1),this._stationaryTimer&&(clearTimeout(this._stationaryTimer),this._stationaryTimer=null);const{center:[t,e],spatialReference:i,rotation:n,scale:s}=this.state.paddedViewState,r=new P({x:t,y:e,spatialReference:i});this._set("viewpoint",null),this._set("extent",null),this._set("center",r),this._set("zoom",-1),this._set("rotation",n),this._set("scale",s),this._set("spatialReference",i),this.constraints.view=null,this.animationManager.destroy(),this._set("animationManager",null),this._set("state",null),this.animation=null},r._flipStationary=function(t){return null!==this._stationaryTimer||(this._stationaryTimer=setTimeout((()=>{this._stationaryTimer=null;const t=performance.now()-this._lastStationaryEventTimestamp;t<L&&(this._stationaryTimer=this._flipStationary(t))}),t)),this._stationaryTimer},r._normalizeInput=function(t,e=this.spatialReference){const i=t&&t.targetGeometry||t;return e?i?e.equals(i.spatialReference)?t:y.canProject(i,e)?N(t)?(t.targetGeometry=y.project(i,e),t):y.project(i,e):null:null:t},r._getDefaultViewpoint=function(){const t=this.constraints,e={zoom:this._get("zoom"),scale:this._get("scale"),center:this._normalizeInput(this._get("center")),extent:this._normalizeInput(this._get("extent")),rotation:this._get("rotation"),viewpoint:this._normalizeInput(this._get("viewpoint")),spatialReference:this._userSpatialReference};t.effectiveLODs?-1!==e.zoom&&(e.scale=t.zoomToScale(e.zoom)):e.zoom=-1;let i=null,s=null,r=0;const o=e.viewpoint&&e.viewpoint.rotation,p=e.viewpoint&&e.viewpoint.targetGeometry;a.isSome(p)&&("extent"===p.type?i=p:"point"===p.type&&(s=p,r=e.viewpoint.scale));const l=this._normalizeInput(this.get("map.initialViewProperties.viewpoint.targetGeometry.extent")),c=this._normalizeInput(this.initialExtent),h=e.extent||i||l||c,d=e.center||s||h&&h.center,u=this.get("map.initialViewProperties.viewpoint.scale"),y=e.scale||r||u||h&&O.extentToScale(h,this.size),_=this.get("map.initialViewProperties.viewpoint.rotation"),m=e.rotation||o||_||0;return d&&y?new n({targetGeometry:d,scale:y,rotation:m}):null},t._createClass(i,[{key:"animation",set:function(t){const e=this._get("animation");if(t===e)return;if(e&&e.stop(),!t||t.isFulfilled())return void this._set("animation",null);this._set("animation",t),this.frameTask.animationInProgress=!0;const i=()=>{t===this._get("animation")&&(this._set("animation",null),this.frameTask.requestFrame()),this.frameTask.animationInProgress=!1};t.when(i,i)}},{key:"center",get:function(){if(!this.ready)return this._get("center");const{center:t,spatialReference:e}=this.state.paddedViewState;return new P({x:t[0],y:t[1],spatialReference:e})},set:function(t){if(null==t)return;if(!this._normalizeInput(t))return void G.error("#center",`incompatible spatialReference ${JSON.stringify(t.spatialReference)} with view's spatialReference ${JSON.stringify(this.spatialReference)}`);if(!this.ready)return this._set("center",t),void this.notifyChange("initialExtentRequired");const e=this.viewpoint;O.centerAt(e,e,t),this.viewpoint=e}},{key:"constraints",set:function(t){const e=this._get("constraints");e&&(this.handles.remove("map-view-base-constraints"),e.destroy()),this._set("constraints",t),t&&(t.view=this,this.ready&&(this.state.viewpoint=t.fit(this.state.paddedViewState.viewpoint)),this.handles.add(t.on("update",(()=>{this.ready&&this.state&&(this.state.viewpoint=t.fit(this.state.paddedViewState.viewpoint))})),"map-view-base-constraints"))}},{key:"extent",get:function(){return this.ready?this.state.paddedViewState.extent.clone():this._get("extent")},set:function(t){if(null==t)return;const e=this._normalizeInput(t);if(!e)return void G.error("#center",`incompatible spatialReference ${JSON.stringify(t.spatialReference)} with view's spatialReference ${JSON.stringify(this.spatialReference)}`);if(!e.width||!e.height)return void G.error("#extent","invalid extent size");if(!this.ready)return this._set("extent",e),this._set("center",null),this._set("viewpoint",null),this._set("scale",0),this._set("zoom",-1),void this.notifyChange("initialExtentRequired");const i=this.viewpoint;O.setExtent(i,i,e,this.size,{constraints:this.constraints}),this.viewpoint=i}},{key:"graphicsTileStore",get:function(){return new M(this.featuresTilingScheme)}},{key:"initialExtentRequired",get:function(){const{extent:t,center:e,scale:i,viewpoint:n,zoom:s}=this;return!this.get("map.initialViewProperties.viewpoint")&&(!t&&((!e||0===i&&-1===s)&&!n))}},{key:"padding",get:function(){return this.ready?this.state.padding:this._get("padding")},set:function(t){this.ready?(this.state.padding=t,this._set("padding",this.state.padding)):this._set("padding",t)}},{key:"resolution",get:function(){return this.state?this.state.resolution:0}},{key:"rotation",get:function(){return this.ready?this.state.rotation:this._get("rotation")},set:function(t){if(isNaN(t))return;if(!this.ready)return void this._set("rotation",t);const e=this.viewpoint;O.rotateTo(e,e,t),this.viewpoint=e}},{key:"scale",get:function(){return this.ready?this.state.scale:this._get("scale")},set:function(t){if(!t||isNaN(t))return;if(!this.ready){this._set("scale",t),this._set("zoom",-1);const e=this._get("extent");return e&&(this._set("extent",null),this._set("center",e.center)),void this.notifyChange("initialExtentRequired")}const e=this.viewpoint;O.scaleTo(e,e,t),this.viewpoint=e}},{key:"stationary",get:function(){return!(this.animation||this.navigating||this._get("resizing")||this._stationaryTimer)}},{key:"updating",get:function(){return!this.destroyed&&(!0===this.get("layerViewManager.updating")||!0===this.get("labelManager.updating")||!0===this.get("graphicsView.updating")||this.allLayerViews.some((t=>!t.destroyed&&!("layerViews"in t)&&!0===t.updating)))}},{key:"viewpoint",get:function(){if(!this.ready)return this._get("viewpoint");const t=this.state.paddedViewState;return t&&t.viewpoint.clone()},set:function(t){if(null==t)return;const e=this._normalizeInput(t);if(!e)return void(!t.scale||isNaN(t.scale)?G.error("#viewpoint",`invalid scale value of ${t.scale}`):a.isNone(t.targetGeometry)?G.error("#viewpoint","geometry not defined"):G.error("#viewpoint",`incompatible spatialReference ${JSON.stringify(t.targetGeometry.spatialReference)} with view's spatialReference ${JSON.stringify(this.spatialReference)}`));if(!this.ready)return this._set("viewpoint",e),this._set("extent",null),this._set("center",null),this._set("zoom",-1),this._set("scale",0),void this.notifyChange("initialExtentRequired");const i=new n({targetGeometry:new P,scale:0,rotation:0});O.copy(i,e),this.constraints.constrain(i,this.state.paddedViewState.viewpoint),this.state.viewpoint=i,this.frameTask.requestFrame(),this._set("viewpoint",i)}},{key:"zoom",get:function(){return this.ready?this.constraints.scaleToZoom(this.scale):this._get("zoom")},set:function(t){if(null==t)return;if(!this.ready){this.notifyChange("initialExtentRequired"),this._set("zoom",t),this._set("scale",0);const e=this._get("extent");e&&(this._set("extent",null),this._set("center",e.center))}if(!this.constraints.effectiveLODs)return;const e=this.viewpoint;O.scaleTo(e,e,this.constraints.zoomToScale(t)),this.viewpoint=e,this._set("zoom",this.constraints.scaleToZoom(this.scale))}}]),i}(m.PopupView(f));return e.__decorate([c.property()],q.prototype,"_stationaryTimer",void 0),e.__decorate([c.property()],q.prototype,"animation",null),e.__decorate([c.property({readOnly:!0})],q.prototype,"animationManager",void 0),e.__decorate([c.property({value:null,type:P,dependsOn:["state.id","ready"]})],q.prototype,"center",null),e.__decorate([c.property({type:V})],q.prototype,"constraints",null),e.__decorate([c.property({value:null,type:A,dependsOn:["state.id","ready"]})],q.prototype,"extent",null),e.__decorate([c.property({readOnly:!0})],q.prototype,"featuresTilingScheme",void 0),e.__decorate([c.property()],q.prototype,"fullOpacity",void 0),e.__decorate([c.property({readOnly:!0})],q.prototype,"graphicsTileStore",null),e.__decorate([c.property()],q.prototype,"graphicsView",void 0),e.__decorate([c.property({type:A})],q.prototype,"initialExtent",void 0),e.__decorate([c.property({dependsOn:["map.initialViewProperties?.viewpoint"]})],q.prototype,"initialExtentRequired",null),e.__decorate([c.property()],q.prototype,"labelManager",void 0),e.__decorate([c.property({value:{top:0,right:0,bottom:0,left:0},cast:t=>({top:0,right:0,bottom:0,left:0,...t})})],q.prototype,"padding",null),e.__decorate([c.property({type:Object})],q.prototype,"renderingOptions",void 0),e.__decorate([c.property()],q.prototype,"resizeAlign",void 0),e.__decorate([c.property({readOnly:!0,dependsOn:["state.id"]})],q.prototype,"resolution",null),e.__decorate([c.property({value:0,type:Number,dependsOn:["state.id","ready"]})],q.prototype,"rotation",null),e.__decorate([c.property({value:0,type:Number,dependsOn:["state.id","ready"]})],q.prototype,"scale",null),e.__decorate([c.property({type:E,dependsOn:["map.initialViewProperties?.spatialReference","defaultsFromMap.isSpatialReferenceDone"]})],q.prototype,"spatialReference",void 0),e.__decorate([c.property({readOnly:!0})],q.prototype,"state",void 0),e.__decorate([c.property({dependsOn:["animation","navigating","resizing","_stationaryTimer"]})],q.prototype,"stationary",null),e.__decorate([c.property({readOnly:!0})],q.prototype,"supportsGround",void 0),e.__decorate([c.property({type:I.Timeline,readOnly:!0})],q.prototype,"timeline",void 0),e.__decorate([c.property({readOnly:!0})],q.prototype,"type",void 0),e.__decorate([c.property({readOnly:!0,dependsOn:["layerViewManager.updating","labelManager.updating","graphicsView?.updating"]})],q.prototype,"updating",null),e.__decorate([c.property({value:null,type:n,dependsOn:["state.id","ready"]})],q.prototype,"viewpoint",null),e.__decorate([c.property({value:-1,dependsOn:["state.id"]})],q.prototype,"zoom",null),q=e.__decorate([u.subclass("esri.views.MapViewBase")],q),q}));
