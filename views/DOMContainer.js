/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/domUtils","../core/reactiveUtils","../core/scheduling","../core/accessorSupport/decorators/property","../core/arrayUtils","../core/has","../core/accessorSupport/ensureType","../core/accessorSupport/decorators/subclass","./overlay/ViewOverlay","../widgets/Popup"],(function(e,t,s,i,r,n,o,a,d,u,c,h,l){"use strict";const p=[0,0];function _(e){const t=(e.ownerDocument||window.document).defaultView,s=e.getBoundingClientRect();return p[0]=s.left+t.pageXOffset,p[1]=s.top+t.pageYOffset,p}function y(e){e&&(i.empty(e),e.parentNode&&e.parentNode.removeChild(e))}function f(e){const t=document.createElement("div");return e.appendChild(t),t}const v=16,g=750,m=512,w=2,C=e=>{let a=function(e){function s(...t){var s;return(s=e.call(this,...t)||this)._freqInfo={freq:v,time:g},s._overlayRenderTaskHandle=null,s.height=0,s.position=null,s.resizing=!1,s.root=null,s.surface=null,s.suspended=!0,s.ui=null,s.userContent=null,s.width=0,s.widthBreakpoint=null,s.handles.add([s.watch("cursor",(e=>{const t=s.surface;t&&t.setAttribute("data-cursor",e)})),s.watch("interacting",(e=>{const t=s.surface;t&&t.setAttribute("data-interacting",e.toString())}))]),s}t._inheritsLoose(s,e);var o=s.prototype;return o.initialize=function(){this.handles.add(this.watch("ui",((e,t)=>this._handleUIChange(e,t)))),this._wireUI(this.ui),this.handles.add([this.on("focus",(()=>this.notifyChange("focused"))),this.on("blur",(()=>this.notifyChange("focused")))])},o.destroy=function(){this.destroyed||(this.ui&&(this.ui.destroy(),this.ui=null),this.popup&&!this.popup.destroyed&&this.popup.destroy(),this.container=null)},o.blur=function(){this.surface&&this.surface.blur()},o.focus=function(){this.surface&&this.surface.focus()},o.pageToContainer=function(e,t,s){const i=this.position;return e-=i[0],t-=i[1],s?(s[0]=e,s[1]=t):s=[e,t],s},o.containerToPage=function(e,t,s){const i=this.position;return e+=i[0],t+=i[1],s?(s[0]=e,s[1]=t):s=[e,t],s},o._handleUIChange=function(e,t){t&&(this.handles.remove("ui"),t.destroy()),e&&this._wireUI(e),this._set("ui",e)},o._wireUI=function(e){this.handles.remove("ui"),e&&(e.view=this,this.handles.add([r.watch((()=>this.root),(t=>{e.container=t?f(t):null}),r.initial),r.watch((()=>this.popup),((t,s)=>{const i="popup",r="manual";s&&e.remove(s,i),t&&(t.view=e.view,e.add(t,{key:i,position:r}))}),r.initial)],"ui"))},o._stopMeasuring=function(){this.handles.remove("measuring"),this._get("resizing")&&this._set("resizing",!1)},o._startMeasuring=function(){const e=this._freqInfo;e.freq=v,e.time=g,this.handles.add([(()=>{const t=()=>{e.freq=v,e.time=g};return window.addEventListener("resize",t),{remove(){window.removeEventListener("resize",t)}}})(),n.addFrameTask({prepare:e=>{const t=this._measure(),s=this._freqInfo;if(s.time+=e.deltaTime,t&&(s.freq=v,this._get("resizing")||this._set("resizing",!0)),s.time<s.freq)return;s.time=0;const i=this._position();s.freq=i||t?v:Math.min(g,s.freq*w),!t&&s.freq>=m&&this._get("resizing")&&this._set("resizing",!1)}})],"measuring"),this._measure(),this._position()},o._measure=function(){const e=this.container,t=e?e.clientWidth:0,s=e?e.clientHeight:0;if(0===t||0===s)return this.suspended||this._set("suspended",!0),!1;const i=this.width,r=this.height;return t===i&&s===r?(this.suspended&&this._set("suspended",!1),!1):(this._set("width",t),this._set("height",s),this.suspended&&this._set("suspended",!1),this.emit("resize",{oldWidth:i,oldHeight:r,width:t,height:s}),!0)},o._position=function(){const e=this.container,t=this.position,s=_(e);return(!t||s[0]!==t[0]||s[1]!==t[1])&&(this._set("position",[s[0],s[1]]),!0)},o.forceDOMReadyCycle=function(){},t._createClass(s,[{key:"container",set:function(e){const t=this._get("container");if(t===e)return;const s="dom-size";if(this.handles.remove(s),this._stopMeasuring(),t&&(t.classList.remove("esri-view"),this._overlayRenderTaskHandle&&(this._overlayRenderTaskHandle.remove(),this._overlayRenderTaskHandle=null),this.overlay.destroy(),this._set("overlay",null),y(this.root),this._set("root",null),i.reparent(this.userContent,t),y(this.userContent),this._set("userContent",null)),e){e.classList.add("esri-view");const t=document.createElement("div");t.className="esri-view-user-storage",i.reparent(e,t),e.appendChild(t),this._set("userContent",t);const o=document.createElement("div");o.className="esri-view-root",e.insertBefore(o,e.firstChild),this._set("root",o);const a=document.createElement("div");a.className="esri-view-surface",a.setAttribute("role","application"),a.tabIndex=0,o.appendChild(a),this._set("surface",a);const d=new h;o.appendChild(d.surface),this._set("overlay",d),d.watch("needsRender",(e=>{e&&!this._overlayRenderTaskHandle?this._overlayRenderTaskHandle=n.addFrameTask({render:()=>{this.overlay.render()}}):this._overlayRenderTaskHandle&&(this._overlayRenderTaskHandle.remove(),this._overlayRenderTaskHandle=null)})),this.forceDOMReadyCycle(),this.handles.add(r.watch((()=>this.size),(e=>{const[t,s]=e,i="esri-view-surface--inset-outline";t>=document.body.clientWidth||s>=document.body.clientHeight?a.classList.add(i):a.classList.remove(i)}),r.initial),s),this._set("container",e),this._startMeasuring()}else this._set("width",0),this._set("height",0),this._set("position",null),this._set("suspended",!0),this._set("surface",null),this._set("container",null)}},{key:"focused",get:function(){const e=document.activeElement===this.surface;return document.hasFocus()&&e}},{key:"popup",get:function(){return this._get("popup")||new l({view:this})},set:function(e){const t=this._get("popup");t&&t!==e&&t.destroy(),this._set("popup",e)}},{key:"size",get:function(){return[this.width,this.height]}}]),s}(e);return s.__decorate([o.property({value:null,cast:e=>i.byId(e)})],a.prototype,"container",null),s.__decorate([o.property({readOnly:!0})],a.prototype,"focused",null),s.__decorate([o.property({readOnly:!0})],a.prototype,"height",void 0),s.__decorate([o.property({type:l})],a.prototype,"popup",null),s.__decorate([o.property({type:h})],a.prototype,"overlay",void 0),s.__decorate([o.property({readOnly:!0})],a.prototype,"position",void 0),s.__decorate([o.property({readOnly:!0})],a.prototype,"resizing",void 0),s.__decorate([o.property({readOnly:!0})],a.prototype,"root",void 0),s.__decorate([o.property({value:null,readOnly:!0})],a.prototype,"size",null),s.__decorate([o.property({readOnly:!0})],a.prototype,"surface",void 0),s.__decorate([o.property({readOnly:!0})],a.prototype,"suspended",void 0),s.__decorate([o.property()],a.prototype,"ui",void 0),s.__decorate([o.property({readOnly:!0})],a.prototype,"userContent",void 0),s.__decorate([o.property({readOnly:!0})],a.prototype,"width",void 0),s.__decorate([o.property()],a.prototype,"widthBreakpoint",void 0),a=s.__decorate([c.subclass("esri.views.DOMContainer")],a),a};function k(e){return e&&"focus"in e}e.DOMContainer=C,e.isDOMContainer=k,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
