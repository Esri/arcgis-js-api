/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/has","../core/Logger","../core/accessorSupport/ensureType","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/subclass","../core/urlUtils","../core/uuid","../portal/support/resourceExtension","../core/scheduling","../core/watchUtils","../core/domUtils","./overlay/ViewOverlay","../widgets/Popup"],(function(e,t,s,i,r,n,o,a,d,u,c,h,p,l,_,y){"use strict";const f=[0,0];function v(e){const t=(e.ownerDocument||window.document).defaultView,s=e.getBoundingClientRect();return f[0]=s.left+t.pageXOffset,f[1]=s.top+t.pageYOffset,f}function g(e){e&&(l.empty(e),e.parentNode&&e.parentNode.removeChild(e))}const m=750;e.DOMContainer=e=>{let i=function(e){function s(...t){var s;return(s=e.call(this,...t)||this)._freqInfo={freq:16,time:m},s._overlayRenderTaskHandle=null,s.height=0,s.position=null,s.resizing=!1,s.root=null,s.surface=null,s.suspended=!0,s.ui=null,s.userContent=null,s.width=0,s.widthBreakpoint=null,s.handles.add([s.watch("cursor",(e=>{const t=s.surface;t&&t.setAttribute("data-cursor",e)})),s.watch("interacting",(e=>{const t=s.surface;t&&t.setAttribute("data-interacting",e.toString())}))]),s}t._inheritsLoose(s,e);var i=s.prototype;return i.initialize=function(){this.handles.add(this.watch("ui",((e,t)=>this._handleUIChange(e,t)))),this._wireUI(this.ui),this.handles.add([this.on("focus",(()=>this.notifyChange("focused"))),this.on("blur",(()=>this.notifyChange("focused")))])},i.destroy=function(){this.destroyed||(this.ui&&(this.ui.destroy(),this.ui=null),this.popup&&!this.popup.destroyed&&this.popup.destroy(),this.container=null)},i.blur=function(){this.surface&&this.surface.blur()},i.focus=function(){this.surface&&this.surface.focus()},i.pageToContainer=function(e,t,s){const i=this.position;return e-=i[0],t-=i[1],s?(s[0]=e,s[1]=t):s=[e,t],s},i.containerToPage=function(e,t,s){const i=this.position;return e+=i[0],t+=i[1],s?(s[0]=e,s[1]=t):s=[e,t],s},i._handleUIChange=function(e,t){t&&(this.handles.remove("ui"),t.destroy()),e&&this._wireUI(e),this._set("ui",e)},i._wireUI=function(e){this.handles.remove("ui"),e&&(e.view=this,this.handles.add([p.init(this,"root",(t=>{e.container=t?function(e){const t=document.createElement("div");return e.appendChild(t),t}(t):null})),p.init(this,"popup",((t,s)=>{const i="popup";s&&e.remove(s,i),t&&(t.view=e.view,e.add(t,{key:i,position:"manual"}))}))],"ui"))},i._stopMeasuring=function(){this.handles.remove("measuring"),this._get("resizing")&&this._set("resizing",!1)},i._startMeasuring=function(){const e=this._freqInfo;e.freq=16,e.time=m,this.handles.add([(()=>{const t=()=>{e.freq=16,e.time=m};return window.addEventListener("resize",t),{remove(){window.removeEventListener("resize",t)}}})(),h.addFrameTask({prepare:e=>{const t=this._measure(),s=this._freqInfo;if(s.time+=e.deltaTime,t&&(s.freq=16,this._get("resizing")||this._set("resizing",!0)),s.time<s.freq)return;s.time=0;const i=this._position();s.freq=i||t?16:Math.min(m,2*s.freq),!t&&s.freq>=512&&this._get("resizing")&&this._set("resizing",!1)}})],"measuring"),this._measure(),this._position()},i._measure=function(){const e=this.container,t=e?e.clientWidth:0,s=e?e.clientHeight:0;if(0===t||0===s)return this.suspended||this._set("suspended",!0),!1;const i=this.width,r=this.height;return t===i&&s===r?(this.suspended&&this._set("suspended",!1),!1):(this._set("width",t),this._set("height",s),this.suspended&&this._set("suspended",!1),this.emit("resize",{oldWidth:i,oldHeight:r,width:t,height:s}),!0)},i._position=function(){const e=this.container,t=this.position,s=v(e);return(!t||s[0]!==t[0]||s[1]!==t[1])&&(this._set("position",[s[0],s[1]]),!0)},i.forceDOMReadyCycle=function(){},t._createClass(s,[{key:"container",set:function(e){const t=this._get("container");if(t===e)return;const s="dom-size";if(this.handles.remove(s),this._stopMeasuring(),t&&(t.classList.remove("esri-view"),this._overlayRenderTaskHandle&&(this._overlayRenderTaskHandle.remove(),this._overlayRenderTaskHandle=null),this.overlay.destroy(),this._set("overlay",null),g(this.root),this._set("root",null),l.reparent(this.userContent,t),g(this.userContent),this._set("userContent",null)),e){e.classList.add("esri-view");const t=document.createElement("div");t.className="esri-view-user-storage",l.reparent(e,t),e.appendChild(t),this._set("userContent",t);const i=document.createElement("div");i.className="esri-view-root",e.insertBefore(i,e.firstChild),this._set("root",i);const r=document.createElement("div");r.className="esri-view-surface",r.setAttribute("role","application"),r.tabIndex=0,i.appendChild(r),this._set("surface",r);const n=new _;i.appendChild(n.surface),this._set("overlay",n),n.watch("needsRender",(e=>{e&&!this._overlayRenderTaskHandle?this._overlayRenderTaskHandle=h.addFrameTask({render:()=>{this.overlay.render()}}):this._overlayRenderTaskHandle&&(this._overlayRenderTaskHandle.remove(),this._overlayRenderTaskHandle=null)})),this.forceDOMReadyCycle(),this.handles.add(p.init(this,"size",(e=>{const[t,s]=e,i="esri-view-surface--inset-outline";t>=document.body.clientWidth||s>=document.body.clientHeight?r.classList.add(i):r.classList.remove(i)})),s),this._set("container",e),this._startMeasuring()}else this._set("width",0),this._set("height",0),this._set("position",null),this._set("suspended",!0),this._set("surface",null),this._set("container",null)}},{key:"focused",get:function(){const e=document.activeElement===this.surface;return document.hasFocus()&&e}},{key:"popup",get:function(){return this._get("popup")||new y({view:this})},set:function(e){const t=this._get("popup");t&&t!==e&&t.destroy(),this._set("popup",e)}},{key:"size",get:function(){return[this.width,this.height]}}]),s}(e);return s.__decorate([o.property({value:null,cast:e=>l.byId(e)})],i.prototype,"container",null),s.__decorate([o.property({readOnly:!0,dependsOn:["surface"]})],i.prototype,"focused",null),s.__decorate([o.property({readOnly:!0})],i.prototype,"height",void 0),s.__decorate([o.property({type:y})],i.prototype,"popup",null),s.__decorate([o.property({type:_})],i.prototype,"overlay",void 0),s.__decorate([o.property({readOnly:!0})],i.prototype,"position",void 0),s.__decorate([o.property({readOnly:!0})],i.prototype,"resizing",void 0),s.__decorate([o.property({readOnly:!0})],i.prototype,"root",void 0),s.__decorate([o.property({value:null,dependsOn:["width","height"],readOnly:!0})],i.prototype,"size",null),s.__decorate([o.property({readOnly:!0})],i.prototype,"surface",void 0),s.__decorate([o.property({readOnly:!0})],i.prototype,"suspended",void 0),s.__decorate([o.property()],i.prototype,"ui",void 0),s.__decorate([o.property({readOnly:!0})],i.prototype,"userContent",void 0),s.__decorate([o.property({readOnly:!0})],i.prototype,"width",void 0),s.__decorate([o.property()],i.prototype,"widthBreakpoint",void 0),i=s.__decorate([a.subclass("esri.views.DOMContainer")],i),i},e.isDOMContainer=function(e){return e&&"focus"in e},Object.defineProperty(e,"__esModule",{value:!0})}));
