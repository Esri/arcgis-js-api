/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/Accessor","../core/Collection","../core/HandleOwner","../core/Logger","../core/maybe","../core/promiseUtils","../core/watchUtils","../core/accessorSupport/decorators/property","../core/has","../core/accessorSupport/ensureType","../core/accessorSupport/decorators/subclass","./input/InputManager","./input/ViewEvents","./interactive/interactiveToolUtils","./interactive/ToolViewManagerManipulatorState"],(function(t,o,e,i,a,r,n,s,l,c,h,u,d,p,v,T,_){"use strict";const f=r.getLogger("esri.views.ToolViewManager"),m="manipulators",g="tools";let w=function(o){function i(t){var e;return(e=o.call(this,t)||this)._creatingTool=null,e._manipulatorState=new _,e.tools=T.newToolCollection(),e.cursor=null,e._forEachTool=t=>{if(!n.isSome(e._creatingTool)||!t(e._creatingTool))for(const o of e.tools.items)if(t(o))return},e}t._inheritsLoose(i,o);var a=i.prototype;return a.initialize=function(){this.handles.add([this.view.on(v.eventTypes,(t=>{this._handleInputEvent(t)}),p.ViewEventPriorities.TOOL),this.tools.on("before-add",(t=>{const o=t.item;null==o||this.tools.includes(o)?t.preventDefault():null==o.created||o.created||(f.error("tools","Tool can not be added to view before it has been created"),t.preventDefault())})),this.tools.on("before-remove",(({item:t})=>{this._manipulatorState.clearPointers(t,this._forEachTool)})),this.tools.on("change",(()=>{this._refreshToolWatchers()}))])},a.destroy=function(){this._forEachTool((t=>t.destroy()))},a.createTool=function(){var o=t._asyncToGenerator((function*(o,i,a){var r=this;const c="Tool creation was interrupted by another tool being created",{abortHandle:h,tool:u}=yield this.updatingHandles.addPromise(t._asyncToGenerator((function*(){yield r.view.whenReady(),s.throwIfAborted(a,c);const t=s.onAbort(a,(()=>r.activeTool=null)),e=T.evaluateToolConstructorArguments(i),n=new o({...e,view:r.view});return yield n.whenCreationStarted(),s.throwIfAborted(a,c),{abortHandle:t,tool:n}}))());return this._rejectCreatingTool(c),this._creatingTool=u,u.attach(),this._refreshToolWatchers(),T.setActive(u,!0),yield u.when(),n.isSome(h)&&h.remove(),this._creatingTool=null,s.throwIfAborted(a,c),this.tools.add(u),u instanceof e&&null!=u.completed&&l.whenOnce(u,"completed").then((()=>{T.setActive(u,!1)})),u}));function i(t,e,i){return o.apply(this,arguments)}return i}(),a.attach=function(){this._forEachTool((t=>t.attach())),"3d"===this.view.type?this.handles.add([this.view.state.watch("camera",(()=>{this.forEachManipulator((t=>{null!=t.onViewChange&&t.onViewChange()}))})),this.view.elevationProvider.on("elevation-change",(t=>{this.forEachManipulator((o=>{null!=o.onElevationChange&&o.onElevationChange(t)}))}))],m):this.handles.add(this.view.watch("extent",(()=>{this.forEachManipulator((t=>{null!=t.onViewChange&&t.onViewChange()}))})))},a.detach=function(){this.activeTool=null,this._forEachTool((t=>{t.detach(),t.destroy()})),this.tools.removeAll(),this.handles.remove(m)},a.forEachManipulator=function(t){this._forEachTool((o=>{o.manipulators&&o.manipulators.forEach((({manipulator:e})=>t(e,o)))}))},a._handleInputEvent=function(t){let o=!1;const e={...t,stopPropagation:()=>{o=!0,t.stopPropagation()}};n.isSome(this.activeTool)?this.activeTool.handleInputEvent&&this.activeTool.handleInputEvent(e):this._forEachTool((t=>{!o&&!1!==t.visible&&t.handleInputEvent&&t.handleInputEvent(e)})),!o&&"key-down"===t.type&&"Escape"===t.key&&this.activeTool&&(t.stopPropagation(),this.activeTool=null),this._manipulatorState.handleInputEvent(e,{forEachTool:this._forEachTool,activeTool:this.activeTool,setActiveTool:t=>{this.activeTool=t},creatingTool:this._creatingTool,view:this.view}),!o&&n.isSome(this.activeTool)&&this.activeTool.handleInputEventAfter&&this.activeTool.handleInputEventAfter(e),this._manipulatorState.handleHoverEvent(e,this._forEachTool),this._updateCursor()},a._refreshToolWatchers=function(){this.handles.remove(g),this._forEachTool((t=>{if(t instanceof e){const o=l.watch(t,["cursor","visible","editable"],(()=>{T.areToolManipulatorsEditable(t)||this._manipulatorState.clearPointers(t,this._forEachTool),this._updateCursor()}));this.handles.add(o,g)}t.manipulators&&this.handles.add(t.manipulators.on("change",(o=>{o.removed.forEach((({id:o})=>{this._manipulatorState.clearPointers(t,this._forEachTool,!0,o)})),this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()})),g)})),this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()},a._updateCursor=function(){let t=null;this._forEachTool((o=>null!=o.cursor&&!1!==o.visible&&(t=o.cursor,!0))),t||(t=this._manipulatorState.cursor),this._get("cursor")!==t&&this._set("cursor",t)},a._rejectCreatingTool=function(t){const o=this._creatingTool;n.isNone(o)||(this._manipulatorState.clearPointers(o,this._forEachTool),o.rejectCreation&&o.rejectCreation(s.createAbortError(t)),T.setActive(o,!1),"destroyed"!==o.toolState&&o.destroy(),this._creatingTool=null,this._refreshToolWatchers())},a._removeIncompleteTools=function(t){this.tools.filter((o=>(n.isNone(t)||o!==t)&&null!=o.completed&&!o.completed)).forEach((t=>{this.tools.remove(t)}))},t._createClass(i,[{key:"activeTool",set:function(t){!n.isSome(t)||this.view.ready?(T.swap(this,t,(o=>{this._set("activeTool",o),this._removeIncompleteTools(t),this._forEachTool((t=>{const o=n.isNone(this.activeTool)||t===this.activeTool;t.setEditableFlag&&t.setEditableFlag(1,o);const e=T.areToolManipulatorsEditable(t);!n.isNone(this.activeTool)&&e||this._manipulatorState.clearPointers(t,this._forEachTool,!e)})),this._updateCursor()})),this._creatingTool!==t&&this._rejectCreatingTool()):f.error("#activeTool=","cannot set active tool while view is not ready")}},{key:"updating",get:function(){return this.updatingHandles.updating||this.tools.some((t=>t.updating))}}]),i}(a.HandleOwner);return o.__decorate([c.property({constructOnly:!0,nonNullable:!0})],w.prototype,"view",void 0),o.__decorate([c.property({value:null})],w.prototype,"activeTool",null),o.__decorate([c.property({readOnly:!0,type:i})],w.prototype,"tools",void 0),o.__decorate([c.property({readOnly:!0})],w.prototype,"cursor",void 0),o.__decorate([c.property({readOnly:!0})],w.prototype,"updating",null),w=o.__decorate([d.subclass("esri.views.ToolViewManager")],w),w}));
