/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/Accessor","../core/Collection","../core/HandleOwner","../core/Logger","../core/maybe","../core/watchUtils","../core/accessorSupport/decorators/property","../core/has","../core/accessorSupport/ensureType","../core/accessorSupport/decorators/subclass","./input/InputManager","./input/ViewEvents","./interactive/interactiveToolUtils","./interactive/ToolViewManagerManipulatorState"],(function(t,o,e,i,a,r,s,n,l,h,c,u,p,d,v,_){"use strict";const f=r.getLogger("esri.views.ToolViewManager"),T="manipulators",m="tools";let E=function(o){function a(t){var e;return(e=o.call(this,t)||this)._manipulatorState=new _,e.tools=new i,e.cursor=null,e._forEachTool=t=>{for(const o of e.tools.items)if(t(o))return},e}t._inheritsLoose(a,o);var r=a.prototype;return r.initialize=function(){this.handles.add([this.view.on(d.eventTypes,(t=>{this._handleInputEvent(t)}),p.ViewEventPriorities.TOOL),...v.getToolAttachDetachHandles(this.tools),this.tools.on("before-add",(t=>{const o=t.item;if(null==o||this.tools.includes(o))return f.warn("Tool is either already in the list of tools or tool is `null`. Not adding tool."),void t.preventDefault()})),this.tools.on("before-remove",(({item:t})=>{this._manipulatorState.clearPointers(t,this._forEachTool)})),this.tools.on("change",(()=>{this._refreshToolWatchers()}))])},r.destroy=function(){this._forEachTool((t=>t.destroy()))},r.attach=function(){this._forEachTool((t=>t.attach())),"3d"===this.view.type?this.handles.add([this.view.state.watch("camera",(()=>{this._forEachManipulator((t=>{null!=t.onViewChange&&t.onViewChange()}))})),this.view.elevationProvider.on("elevation-change",(t=>{this._forEachManipulator((o=>{null!=o.onElevationChange&&o.onElevationChange(t)}))}))],T):this.handles.add(this.view.watch("extent",(()=>{this._forEachManipulator((t=>{null!=t.onViewChange&&t.onViewChange()}))})))},r.detach=function(){s.isSome(this.activeTool)&&(this.activeTool=null),this._forEachTool((t=>{t.detach(),t.destroy()})),this.tools.removeAll(),this.handles.remove(T)},r._forEachManipulator=function(t){this._forEachTool((o=>{o.manipulators&&o.manipulators.forEach((({manipulator:e})=>t(e,o)))}))},r._handleInputEvent=function(t){let o=!1;const e={...t,stopPropagation:()=>{o=!0,t.stopPropagation()}};s.isSome(this.activeTool)?this.activeTool.handleInputEvent&&this.activeTool.handleInputEvent(e):this._forEachTool((t=>{!o&&t.attached&&t.visible&&t.handleInputEvent(e)})),!o&&"key-down"===t.type&&"Escape"===t.key&&this.activeTool&&(t.stopPropagation(),this.activeTool=null),this._manipulatorState.handleInputEvent(e,{forEachTool:this._forEachTool,activeTool:this.activeTool,setActiveTool:t=>{this.activeTool=t},view:this.view}),!o&&s.isSome(this.activeTool)&&this.activeTool.handleInputEventAfter(e),this._manipulatorState.handleHoverEvent(e,this._forEachTool),this._updateCursor()},r._refreshToolWatchers=function(){this.handles.remove(m),this._forEachTool((t=>{if(t instanceof e){const o=n.watch(t,["cursor","visible","editable"],(()=>{v.areToolManipulatorsEditable(t)||this._manipulatorState.clearPointers(t,this._forEachTool),this._updateCursor()}));this.handles.add(o,m)}t.manipulators&&this.handles.add(t.manipulators.on("change",(o=>{o.removed.forEach((({id:o})=>{this._manipulatorState.clearPointers(t,this._forEachTool,!0,o)})),this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()})),m)})),this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()},r._updateCursor=function(){let t=this._manipulatorState.cursor;this._forEachTool((o=>!(!s.isSome(o.cursor)||!o.visible)&&(t=o.cursor,!0))),this._get("cursor")!==t&&this._set("cursor",t)},r._removeIncompleteTools=function(t){this.tools.filter((o=>(s.isNone(t)||o!==t)&&!o.completed)).forEach((t=>{this.tools.remove(t),t.destroy()}))},t._createClass(a,[{key:"activeTool",set:function(t){if(s.isSome(t)&&!this.view.ready)return void f.error("Cannot set active tool while view is not ready.");if(t===this.activeTool)return void f.warn("Tool is already active - ignoring activation request.");s.isSome(this.activeTool)&&this.activeTool.deactivate(),s.isSome(t)&&t.activate(),this._set("activeTool",t),this._removeIncompleteTools(t);const o=s.isNone(this.activeTool);for(const e of this.tools){e.setEditableFlag(1,o||e===this.activeTool);const t=v.areToolManipulatorsEditable(e);!o&&t||this._manipulatorState.clearPointers(e,this._forEachTool,!t)}this._updateCursor()}},{key:"updating",get:function(){return this.updatingHandles.updating||this.tools.some((t=>t.updating))}}]),a}(a.HandleOwner);return o.__decorate([l.property({constructOnly:!0,nonNullable:!0})],E.prototype,"view",void 0),o.__decorate([l.property({value:null})],E.prototype,"activeTool",null),o.__decorate([l.property({readOnly:!0,type:i})],E.prototype,"tools",void 0),o.__decorate([l.property({readOnly:!0})],E.prototype,"cursor",void 0),o.__decorate([l.property({readOnly:!0})],E.prototype,"updating",null),E=o.__decorate([u.subclass("esri.views.ToolViewManager")],E),E}));
