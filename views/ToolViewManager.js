// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../core/Accessor","../core/Collection","../core/Handles","../core/Logger","../core/maybe","../core/promiseUtils","../core/watchUtils","../core/accessorSupport/decorators","./input/InputManager","./input/ViewEvents","./interactive/interactiveToolUtils","./interactive/ToolViewManagerManipulatorState"],(function(t,o,e,n,r,i,a,l,s,c,u,h,p,v,d){"use strict";var f=a.getLogger("esri.views.ToolViewManager");return function(t){function o(o){var e=t.call(this,o)||this;return e._handles=new i,e._creatingTool=null,e._manipulatorState=new d.default,e.tools=v.newToolCollection(),e.cursor=null,e._forEachTool=function(t){if(!l.isSome(e._creatingTool)||!t(e._creatingTool))for(var o=0,n=e.tools.items;o<n.length;o++){if(t(n[o]))return}},e}return e.__extends(o,t),o.prototype.initialize=function(){var t=this;this._handles.add([this.view.on(p.eventTypes,(function(o){t._handleInputEvent(o)}),h.ViewEventPriorities.TOOL),this.tools.on("before-add",(function(o){var e=o.item;null==e||t.tools.includes(e)?o.preventDefault():null==e.created||e.created||(f.error("tools","Tool can not be added to view before it has been created"),o.preventDefault())})),this.tools.on("before-remove",(function(o){var e=o.item;t._manipulatorState.clearPointers(e,t._forEachTool)})),this.tools.on("change",(function(){t._refreshToolWatchers()}))])},o.prototype.destroy=function(){this._forEachTool((function(t){return t.destroy()})),this._handles.destroy(),this._handles=null},Object.defineProperty(o.prototype,"activeTool",{set:function(t){var o=this;!l.isSome(t)||this.view.ready?(v.swap(this,t,(function(e){o._set("activeTool",e),o._removeIncompleteTools(t),o._forEachTool((function(t){var e=l.isNone(o.activeTool)||t===o.activeTool;t.setEditableFlag&&t.setEditableFlag(1,e);var n=v.areToolManipulatorsEditable(t);!l.isNone(o.activeTool)&&n||o._manipulatorState.clearPointers(t,o._forEachTool,!n)})),o._updateCursor()})),this._creatingTool!==t&&this._rejectCreatingTool()):f.error("#activeTool=","cannot set active tool while view is not ready")},enumerable:!1,configurable:!0}),o.prototype.createTool=function(t,o,r){return e.__awaiter(this,void 0,void 0,(function(){var i,a,u,h,p=this;return e.__generator(this,(function(d){switch(d.label){case 0:return[4,this.view.whenReady()];case 1:if(d.sent(),i="Tool creation was interrupted by another tool being created",s.isAborted(r))throw s.createAbortError(i);return a=v.evaluateToolConstructorArguments(o),u=new t(e.__assign(e.__assign({},a),{view:this.view})),h=s.onAbort(r,(function(){return p.activeTool=null})),this._rejectCreatingTool(i),this._creatingTool=u,u.attach(),this._refreshToolWatchers(),v.setActive(u,!0),[4,u.when()];case 2:return d.sent(),l.isSome(h)&&h.remove(),this._creatingTool=null,this.tools.add(u),u instanceof n&&null!=u.completed&&c.whenOnce(u,"completed").then((function(){v.setActive(u,!1)})),[2,u]}}))}))},o.prototype.attach=function(){var t=this;this._forEachTool((function(t){return t.attach()})),"3d"===this.view.type?this._handles.add([this.view.state.watch("camera",(function(){t.forEachManipulator((function(t){null!=t.onViewChange&&t.onViewChange()}))})),this.view.elevationProvider.on("elevation-change",(function(o){t.forEachManipulator((function(t){null!=t.onElevationChange&&t.onElevationChange(o)}))}))],"manipulators"):this._handles.add(this.view.watch("extent",(function(){t.forEachManipulator((function(t){null!=t.onViewChange&&t.onViewChange()}))})))},o.prototype.detach=function(){this.activeTool=null,this._forEachTool((function(t){t.detach(),t.destroy()})),this.tools.removeAll(),this._handles.remove("manipulators")},o.prototype.forEachManipulator=function(t){this._forEachTool((function(o){o.manipulators&&o.manipulators.forEach((function(e){var n=e.manipulator;return t(n,o)}))}))},o.prototype._handleInputEvent=function(t){var o=this,n=!1,r=e.__assign(e.__assign({},t),{stopPropagation:function(){n=!0,t.stopPropagation()}});l.isSome(this.activeTool)?this.activeTool.handleInputEvent&&this.activeTool.handleInputEvent(r):this._forEachTool((function(t){!n&&!1!==t.visible&&t.handleInputEvent&&t.handleInputEvent(r)})),!n&&"key-down"===t.type&&"Escape"===t.key&&this.activeTool&&(t.stopPropagation(),this.activeTool=null),this._manipulatorState.handleInputEvent(r,{forEachTool:this._forEachTool,activeTool:this.activeTool,setActiveTool:function(t){o.activeTool=t},creatingTool:this._creatingTool,view:this.view}),!n&&l.isSome(this.activeTool)&&this.activeTool.handleInputEventAfter&&this.activeTool.handleInputEventAfter(r),this._manipulatorState.handleHoverEvent(r,this._forEachTool),this._updateCursor()},o.prototype._refreshToolWatchers=function(){var t=this;this._handles.remove("tools"),this._forEachTool((function(o){if(o instanceof n){var e=c.watch(o,["cursor","visible","editable"],(function(){v.areToolManipulatorsEditable(o)||t._manipulatorState.clearPointers(o,t._forEachTool),t._updateCursor()}));t._handles.add(e,"tools")}o.manipulators&&t._handles.add(o.manipulators.on("change",(function(e){e.removed.forEach((function(e){var n=e.id;t._manipulatorState.clearPointers(o,t._forEachTool,!0,n)})),t._manipulatorState.updateHoveredStateFromKnownPointers(t._forEachTool),t._updateCursor()})),"tools")})),this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()},o.prototype._updateCursor=function(){var t=null;this._forEachTool((function(o){return null!=o.cursor&&!1!==o.visible&&(t=o.cursor,!0)})),t||(t=this._manipulatorState.cursor),this._get("cursor")!==t&&this._set("cursor",t)},o.prototype._rejectCreatingTool=function(t){var o=this._creatingTool;l.isNone(o)||(this._manipulatorState.clearPointers(o,this._forEachTool),o.rejectCreation&&o.rejectCreation(s.createAbortError(t)),o.destroy(),this._creatingTool=null,this._refreshToolWatchers())},o.prototype._removeIncompleteTools=function(t){var o=this;this.tools.filter((function(o){return(l.isNone(t)||o!==t)&&null!=o.completed&&!o.completed})).forEach((function(t){o.tools.remove(t)}))},e.__decorate([u.property({constructOnly:!0,nonNullable:!0})],o.prototype,"view",void 0),e.__decorate([u.property({value:null})],o.prototype,"activeTool",null),e.__decorate([u.property({readOnly:!0,type:r})],o.prototype,"tools",void 0),e.__decorate([u.property({readOnly:!0})],o.prototype,"cursor",void 0),o=e.__decorate([u.subclass("esri.views.ToolViewManager")],o)}(n)}));