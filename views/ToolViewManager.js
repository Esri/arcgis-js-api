/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/Accessor","../core/Collection","../core/HandleOwner","../core/handleUtils","../core/Logger","../core/maybe","../core/watchUtils","../core/accessorSupport/decorators/property","../core/arrayUtils","../core/has","../core/accessorSupport/ensureType","../core/accessorSupport/decorators/subclass","./3d/support/TextureCollection","./input/InputManager","./input/ViewEvents","./interactive/interactiveToolUtils","./interactive/interfaces","./interactive/ToolViewManagerManipulatorState"],(function(t,e,o,i,a,r,s,n,l,c,h,u,p,d,v,_,f,T,m,E){"use strict";const w=s.getLogger("esri.views.ToolViewManager"),g="attached",y="tools";let S=function(e){function a(t){var o;return(o=e.call(this,t)||this)._manipulatorState=new E,o.tools=new i,o.cursor=null,o._forEachTool=t=>{for(const e of o.tools.items)if(t(e))return},o}t._inheritsLoose(a,e);var s=a.prototype;return s.initialize=function(){this.handles.add([this.view.on(f.eventTypes,(t=>{this._handleInputEvent(t)}),_.ViewEventPriorities.TOOL),...T.getToolCollectionHandles(this.tools),this.tools.on("before-remove",(({item:t})=>{this._manipulatorState.clearPointers(t,this._forEachTool)})),this.tools.on("change",(()=>{this._refreshToolWatchers()}))])},s.destroy=function(){this.detach(),this.handles.removeAll()},s.attach=function(){"3d"===this.view.type?(this._set("textures",new v.TextureCollection(this.view._stage,this.view.resourceController.scheduler)),this.handles.add([this.view.state.watch("camera",(()=>{this._forEachManipulator((t=>{null!=t.onViewChange&&t.onViewChange()}))})),this.view.elevationProvider.on("elevation-change",(t=>{this._forEachManipulator((e=>{null!=e.onElevationChange&&e.onElevationChange(t)}))})),r.makeHandle((()=>this._set("textures",n.destroyMaybe(this.textures))))],g)):this.handles.add(this.view.watch("extent",(()=>{this._forEachManipulator((t=>{null!=t.onViewChange&&t.onViewChange()}))})))},s.detach=function(){n.isSome(this.activeTool)&&(this.activeTool=null),this.tools.removeAll(),this.handles.remove(g)},s._forEachManipulator=function(t){this._forEachTool((e=>{e.manipulators&&e.manipulators.forEach((({manipulator:o})=>t(o,e)))}))},s._handleInputEvent=function(t){let e=!1;const o={...t,stopPropagation:()=>{e=!0,t.stopPropagation()}};n.isSome(this.activeTool)?this.activeTool.handleInputEvent&&this.activeTool.handleInputEvent(o):this._forEachTool((t=>{!e&&t.visible&&t.handleInputEvent(o)})),!e&&"key-down"===t.type&&"Escape"===t.key&&this.activeTool&&(t.stopPropagation(),this.activeTool=null),this._manipulatorState.handleInputEvent(o,{forEachTool:this._forEachTool,activeTool:this.activeTool,setActiveTool:t=>{this.activeTool=t},view:this.view}),!e&&n.isSome(this.activeTool)&&this.activeTool.handleInputEventAfter(o),this._manipulatorState.handleHoverEvent(o,this._forEachTool),this._updateCursor()},s._refreshToolWatchers=function(){this.handles.remove(y),this._forEachTool((t=>{if(t instanceof o){const e=l.watch(t,["cursor","visible","editable"],(()=>{T.areToolManipulatorsEditable(t)||this._manipulatorState.clearPointers(t,this._forEachTool),this._updateCursor()}));this.handles.add(e,y)}t.manipulators&&this.handles.add(t.manipulators.on("change",(e=>{e.removed.forEach((({id:e})=>{this._manipulatorState.clearPointers(t,this._forEachTool,!0,e)})),this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()})),y)})),this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()},s._updateCursor=function(){let t=this._manipulatorState.cursor;this._forEachTool((e=>!(!n.isSome(e.cursor)||!e.visible)&&(t=e.cursor,!0))),this._get("cursor")!==t&&this._set("cursor",t)},s._removeIncompleteTools=function(t){this.tools.filter((e=>(n.isNone(t)||e!==t)&&!e.created)).forEach((t=>{this.tools.remove(t)}))},t._createClass(a,[{key:"activeTool",set:function(t){if(n.isSome(t)&&!this.view.ready)return void w.error("Cannot set active tool while view is not ready.");if(t===this.activeTool)return void(n.isSome(t)&&w.warn("Tool is already active - ignoring activation request."));const e=this.activeTool;this._set("activeTool",t),n.isSome(e)&&e.deactivate(),n.isSome(t)&&t.activate(),this._removeIncompleteTools(t);const o=n.isNone(this.activeTool);for(const i of this.tools){i.setEditableFlag(m.EditableFlag.MANAGER,o||i===this.activeTool);const t=T.areToolManipulatorsEditable(i);!o&&t||this._manipulatorState.clearPointers(i,this._forEachTool,!t)}this._updateCursor()}},{key:"updating",get:function(){var t,e;return this.updatingHandles.updating||this.tools.some((t=>t.updating))||null!=(t=null==(e=this.textures)?void 0:e.updating)&&t}}]),a}(a.HandleOwner);e.__decorate([c.property({constructOnly:!0,nonNullable:!0})],S.prototype,"view",void 0),e.__decorate([c.property({readOnly:!0,nonNullable:!0})],S.prototype,"textures",void 0),e.__decorate([c.property({value:null})],S.prototype,"activeTool",null),e.__decorate([c.property({readOnly:!0,type:i})],S.prototype,"tools",void 0),e.__decorate([c.property({readOnly:!0})],S.prototype,"cursor",void 0),e.__decorate([c.property({readOnly:!0})],S.prototype,"updating",null),S=e.__decorate([d.subclass("esri.views.ToolViewManager")],S);return S}));
