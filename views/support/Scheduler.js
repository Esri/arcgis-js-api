// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","@dojo/framework/shim/number","../../core/Accessor","../../core/Logger","../../core/maybe","../../core/PooledArray","../../core/promiseUtils","../../core/watchUtils","../../core/accessorSupport/decorators","../../layers/support/PromiseQueue","./debugFlags"],(function(e,t,r,i,n,s,o,u,a,d,_,h,c){"use strict";var l;Object.defineProperty(t,"__esModule",{value:!0}),t.noBudget=t.TaskState=t.TestTaskHandle=t.getTaskPriority=t.taskPriorities=t.Task=t.newScheduler=void 0;var p,E=s.getLogger("esri.views.support.Scheduler");function f(e){return e in t.taskPriorities?t.taskPriorities[e]:"number"==typeof e?e:1}t.newScheduler=function(e){return new g.Scheduler(e)},function(e){e.REMOTE_CLIENT="remote client",e.STREAM_DATA_LOADER="stream data loader",e.ELEVATION_QUERY="elevation query",e.TERRAIN_SURFACE="terrain surface",e.SURFACE_GEOMETRY_UPDATES="surface geometry updates",e.I3S_CONTROLLER="I3S controller",e.POINT_CLOUD_LAYER="point cloud",e.FEATURE_TILE_FETCHER="feature fetcher",e.FEATURE_FETCH_QUEUE="feature fetch queue",e.GRAPHICS_CORE="Graphics3D",e.LABELER="labeler",e.GRAPHICS_DECONFLICTOR="graphics deconflictor",e.FILTER_VISIBILITY="Graphics3D filter visibility",e.FEATURE_QUERY_ENGINE="feature query",e.SCALE_VISIBILITY="Graphics3D scale visibility",e.FRUSTUM_VISIBILITY="Graphics3D frustum visibility",e.POINT_OF_INTEREST_FREQUENT="POI frequent",e.POINT_OF_INTEREST_INFREQUENT="POI infrequent",e.FEATURE_TILE_TREE="feature tile tree",e.FEATURE_TILE_TREE_ACTIVE="fast feature tile tree",e.ELEVATION_ALIGNMENT="elevation alignment",e.TEXT_TEXTURE_ATLAS="text texture atlas",e.TEXTURE_UNLOAD="texture unload",e.OVERLAY_MANAGER="overlay manager",e.LINE_OF_SIGHT_TOOL="line of sight tool",e.LINE_OF_SIGHT_TOOL_INTERACTIVE="interactive line of sight tool",e.ELEVATION_PROFILE="elevation profile",e[e.TEST_PRIO=1]="TEST_PRIO"}(p=t.Task||(t.Task={})),t.taskPriorities=((l={})[p.REMOTE_CLIENT]=1,l[p.STREAM_DATA_LOADER]=1,l[p.FEATURE_FETCH_QUEUE]=1,l[p.ELEVATION_QUERY]=1,l[p.TERRAIN_SURFACE]=2,l[p.SURFACE_GEOMETRY_UPDATES]=2,l[p.I3S_CONTROLLER]=4,l[p.POINT_CLOUD_LAYER]=4,l[p.FEATURE_TILE_FETCHER]=4,l[p.GRAPHICS_CORE]=6,l[p.LABELER]=6,l[p.GRAPHICS_DECONFLICTOR]=6,l[p.FILTER_VISIBILITY]=8,l[p.FEATURE_QUERY_ENGINE]=8,l[p.SCALE_VISIBILITY]=8,l[p.FRUSTUM_VISIBILITY]=8,l[p.POINT_OF_INTEREST_FREQUENT]=6,l[p.POINT_OF_INTEREST_INFREQUENT]=30,l[p.FEATURE_TILE_TREE]=16,l[p.FEATURE_TILE_TREE_ACTIVE]=1,l[p.ELEVATION_ALIGNMENT]=12,l[p.TEXT_TEXTURE_ATLAS]=12,l[p.TEXTURE_UNLOAD]=12,l[p.OVERLAY_MANAGER]=12,l[p.LINE_OF_SIGHT_TOOL]=16,l[p.LINE_OF_SIGHT_TOOL_INTERACTIVE]=1,l),t.getTaskPriority=f;var T=function(){function e(){}return e.prototype.remove=function(){},e.prototype.schedule=function(e){return a.when(e())},e.prototype.reschedule=function(e){return a.when(e())},e}();t.TestTaskHandle=T;var g,b,I;!function(e){var i=function(){function e(e){var t=this;this._now=e,this._budget=null,this._state=1,this._tasks=new u,this._runQueue=new u,this._load=0,this._idleStateCallbacks=new u,this._idleUpdatesStartFired=!1,this._maxReschedule=y,this._forceTask=!1,this._safetyBudget=0,this._debug=!1,this._debugHandle=d.init(c,"SCHEDULER_LOG_SLOW_TASKS",(function(e){return t._debug=e})),this._budget=new l(e);var r,i=this;this._test={get state(){return o.isNone(r)?i._state:r},set state(e){r=e},FRAME_SAFETY_BUDGET:5,INTERACTING_BUDGET:1e3/30,IDLE_BUDGET:100,get budget(){return i._budget.budget},usedBudget:0,startTime:0,updateTask:function(e){return t._updateTask(e)},getState:function(e){return t._getState(e)},getRuntime:function(e){return t._getRuntime(e)}}}return e.prototype.destroy=function(){this._debugHandle&&this._debugHandle.remove()},e.prototype.registerTask=function(e,t,r){var i=f(e),n=new s(this,e,t,r,i);return this._tasks.push(n),n},e.prototype.registerIdleStateCallbacks=function(e,t){var r=this,i={idleBegin:e,idleEnd:t};this._idleStateCallbacks.push(i),2===this.state&&this._idleUpdatesStartFired&&i.idleBegin();var n=this;return{remove:function(){return r._removeIdleStateCallbacks(i)},set idleBegin(e){n._idleUpdatesStartFired&&(i.idleEnd(),2===n._state&&e()),i.idleBegin=e},set idleEnd(e){i.idleEnd=e}}},Object.defineProperty(e.prototype,"now",{get:function(){return this._now()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"load",{get:function(){return this._load},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"state",{get:function(){return o.isNone(this._test.state)?this._state:this._test.state},set:function(e){this._state!==e&&(this._state=e,2!==this.state&&this._idleUpdatesStartFired&&(this._idleUpdatesStartFired=!1,this._idleStateCallbacks.forEachSimple((function(e){return e.idleEnd()}))))},enumerable:!1,configurable:!0}),e.prototype.updateBudget=function(e){this._test.usedBudget=0,this._test.startTime=e.elapsedFrameTime,this._safetyBudget=5;var t=e.frameDuration,r=1;switch(this.state){case 2:this._safetyBudget=0,t=Math.max(100,e.frameDuration),r=30;break;case 1:t=Math.max(1e3/30,e.frameDuration)}return t-=e.elapsedFrameTime+this._safetyBudget,2!==this.state&&t<0&&!this._forceTask?(this._forceTask=!0,!1):(t=Math.max(t,r),this._budget.reset(t,this.state),this._maxReschedule=y,this._updateLoad(),this._schedule())},e.prototype.frame=function(){switch(this._forceTask=!1,this.state){case 2:this._idleUpdatesStartFired||(this._idleUpdatesStartFired=!0,this._idleStateCallbacks.forEachSimple((function(e){return e.idleBegin()}))),this._runIdle();break;case 1:this._runInteracting();break;default:this._runAnimating()}this._test.usedBudget=this._budget.elapsed},e.prototype._removeIdleStateCallbacks=function(e){this._idleUpdatesStartFired&&e.idleEnd(),this._idleStateCallbacks.removeUnordered(e)},e.prototype.removeTask=function(e){this._tasks.removeUnordered(e),this._runQueue.removeUnordered(e)},e.prototype._updateTask=function(e){this._tasks.forEachSimple((function(t){t.name===e&&t.setPriority(e)}))},e.prototype._getState=function(e){if(this._runQueue.some((function(t){return t.name===e})))return b.SCHEDULED;var t=b.IDLE;return this._tasks.forEachSimple((function(r){r.name===e&&r.needsUpdate&&(r.schedulePriority<=1?t=b.READY:t!==b.READY&&(t=b.WAITING))})),t},e.prototype._getRuntime=function(e){var t=0;return this._tasks.forEachSimple((function(r){r.name===e&&(t+=r.runtime)})),t},e.prototype._runIdle=function(){this._run()},e.prototype._runInteracting=function(){this._run()},e.prototype._runAnimating=function(){this._run()},e.prototype._updateLoad=function(){var e=this._tasks.reduce((function(e,t){return t.needsUpdate?++e:e}),0);this._load=.9*this._load+e*(1-.9)},e.prototype._schedule=function(){var e=this;if(this._maxReschedule<=0)return!1;this._runQueue.filterInPlace((function(e){return!!e.needsUpdate||(e.schedulePriority=e.priority,!1)}));for(var t=function(){var t=!1,i=0;if(r._tasks.forEachSimple((function(r){if(0!==r.schedulePriority&&r.needsUpdate)switch(t=!0,i=Math.max(i,r.priority),r.schedulePriority){case 1:r.schedulePriority=0,e._runQueue.push(r);break;default:--r.schedulePriority}})),!t)return{value:!1};r._maxReschedule===y&&(r._maxReschedule=i),--r._maxReschedule},r=this;0===this._runQueue.length;){var i=t();if("object"==typeof i)return i.value}return!0},e.prototype._run=function(){do{for(;this._runQueue.length>0;){var e=this._runQueue.pop();this._budget.resetProgress();var t=this._budget.now();try{e.processQueue(this._budget),!this._budget.done&&e.needsUpdate&&e.update(this._budget)}catch(t){E.error('Exception in task "'+e.name+'"',t)}if(e.schedulePriority=e.priority,e.runtime+=this._budget.now()-t,this._debug&&this._budget.elapsed>2*this._budget.budget&&console.log("Task",e.name,"used",this._budget.elapsed,"of max",this._budget.budget,"ms"),this._budget.remaining<=0)return}}while(this._schedule())},Object.defineProperty(e.prototype,"test",{get:function(){return this._test},enumerable:!1,configurable:!0}),e}();e.Scheduler=i;var s=function(e){function i(t,r,i,n,s){var o=e.call(this,{})||this;return o._scheduler=t,o.name=r,o.update=i,o._needsUpdateCB=n,o._priority=s,o.runtime=0,o._queue=new h.default,o.updating=!1,o.schedulePriority=o._priority,o}return r.__extends(i,e),i.prototype.normalizeCtorArgs=function(){return{}},i.prototype.remove=function(){this.processQueue(t.noBudget),this._scheduler.removeTask(this)},Object.defineProperty(i.prototype,"priority",{get:function(){return this._priority},enumerable:!1,configurable:!0}),i.prototype.setPriority=function(e){this.name=e,this._priority=f(e),0!==this.schedulePriority&&(this.schedulePriority=this._priority)},Object.defineProperty(i.prototype,"task",{get:function(){return this.name},set:function(e){this.setPriority(e)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"needsUpdate",{get:function(){return this._queue.length>0||this._needsUpdateCB()},enumerable:!1,configurable:!0}),i.prototype.schedule=function(e,t){return this.updating=!0,this._queue.push((function(){return a.throwIfAborted(t),e()}))},i.prototype.reschedule=function(e,t){return this.updating=!0,this._queue.unshift((function(){return a.throwIfAborted(t),e()}))},i.prototype.processQueue=function(e){for(;!e.done&&this._queue.process();)e.madeProgress();0===this._queue.length&&(this.updating=!1)},r.__decorate([_.property()],i.prototype,"updating",void 0),i=r.__decorate([_.subclass("esri.views.support.SchedulerTask")],i)}(n),l=function(){function e(e){this.now=e,this._begin=0,this._budget=0,this._state=2,this._didWork=!1,this._enabled=!0}return e.prototype.run=function(e){return!this.done&&(!0===e()&&(this._didWork=!0),!0)},Object.defineProperty(e.prototype,"done",{get:function(){return this._didWork&&this.elapsed>=this._budget&&this._enabled},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"budget",{get:function(){return this._budget},enumerable:!1,configurable:!0}),e.prototype.madeProgress=function(){this._didWork=!0},Object.defineProperty(e.prototype,"state",{get:function(){return this._state},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"enabled",{get:function(){return this._enabled},set:function(e){this._enabled=e},enumerable:!1,configurable:!0}),e.prototype.reset=function(e,t){this._begin=this.now(),this._budget=e,this._state=t,this._didWork=!1},Object.defineProperty(e.prototype,"remaining",{get:function(){return Math.max(this._budget-this.elapsed,0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"elapsed",{get:function(){return this.now()-this._begin},enumerable:!1,configurable:!0}),e.prototype.resetProgress=function(){this._didWork=!1},Object.defineProperty(e.prototype,"hasProgressed",{get:function(){return this._didWork},enumerable:!1,configurable:!0}),e}();e.Budget=l}(g||(g={})),function(e){e.SCHEDULED="s",e.READY="r",e.WAITING="w",e.IDLE="i"}(b=t.TaskState||(t.TaskState={})),t.noBudget=((I=new g.Budget((function(){return performance.now()}))).enabled=!1,I);var y=i.MAX_SAFE_INTEGER}));