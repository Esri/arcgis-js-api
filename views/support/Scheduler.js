// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","@dojo/framework/shim/number","../../core/Logger","../../core/maybe","../../core/now","../../core/PooledArray","../../core/watchUtils","./debugFlags"],(function(e,t,r,i,n,s,u,a,o){var _;Object.defineProperty(t,"__esModule",{value:!0});var d,h=i.getLogger("esri.views.support.Scheduler");function c(e){return e in t.taskPriorities?t.taskPriorities[e]:"number"==typeof e?e:1}t.newScheduler=function(e){return new E.Scheduler(e)},function(e){e.REMOTE_CLIENT="remote client",e.STREAM_DATA_LOADER="stream data loader",e.TERRAIN_SURFACE="terrain surface",e.SURFACE_GEOMETRY_UPDATES="surface geometry updates",e.I3S_CONTROLLER="I3S controller",e.POINT_CLOUD_LAYER="point cloud",e.FEATURE_TILE_FETCHER="feature fetcher",e.FEATURE_FETCH_QUEUE="feature fetch queue",e.GRAPHICS_CORE="Graphics3D",e.LABELER="labeler",e.GRAPHICS_DECONFLICTOR="graphics deconflictor",e.FILTER_VISIBILITY="Graphics3D filter visibility",e.FEATURE_QUERY_ENGINE="feature query",e.SCALE_VISIBILITY="Graphics3D scale visibility",e.FRUSTUM_VISIBILITY="Graphics3D frustum visibility",e.POINT_OF_INTEREST_FREQUENT="POI frequent",e.POINT_OF_INTEREST_INFREQUENT="POI infrequent",e.FEATURE_TILE_TREE="feature tile tree",e.FEATURE_TILE_TREE_ACTIVE="fast feature tile tree",e.ELEVATION_ALIGNMENT="elevation alignment",e.TEXT_TEXTURE_ATLAS="text texture atlas",e.OVERLAY_MANAGER="overlay manager",e.LINE_OF_SIGHT_TOOL="line of sight tool",e.LINE_OF_SIGHT_TOOL_INTERACTIVE="interactive line of sight tool",e[e.TEST_PRIO=1]="TEST_PRIO"}(d=t.Task||(t.Task={})),t.taskPriorities=((_={})[d.REMOTE_CLIENT]=1,_[d.STREAM_DATA_LOADER]=1,_[d.FEATURE_FETCH_QUEUE]=1,_[d.TERRAIN_SURFACE]=2,_[d.SURFACE_GEOMETRY_UPDATES]=2,_[d.I3S_CONTROLLER]=4,_[d.POINT_CLOUD_LAYER]=4,_[d.FEATURE_TILE_FETCHER]=4,_[d.GRAPHICS_CORE]=6,_[d.LABELER]=6,_[d.GRAPHICS_DECONFLICTOR]=6,_[d.FILTER_VISIBILITY]=8,_[d.FEATURE_QUERY_ENGINE]=8,_[d.SCALE_VISIBILITY]=8,_[d.FRUSTUM_VISIBILITY]=8,_[d.POINT_OF_INTEREST_FREQUENT]=6,_[d.POINT_OF_INTEREST_INFREQUENT]=30,_[d.FEATURE_TILE_TREE]=16,_[d.FEATURE_TILE_TREE_ACTIVE]=1,_[d.ELEVATION_ALIGNMENT]=12,_[d.TEXT_TEXTURE_ATLAS]=12,_[d.OVERLAY_MANAGER]=12,_[d.LINE_OF_SIGHT_TOOL]=16,_[d.LINE_OF_SIGHT_TOOL_INTERACTIVE]=1,_),t.getTaskPriority=c;var E,l,f;!function(e){var t=function(){function t(t){var r=this;this._now=t,this._budget=null,this._state=1,this._tasks=new u,this._runQueue=new u,this._load=0,this._idleStateCallbacks=new u,this._idleUpdatesStartFired=!1,this._maxReschedule=p,this._forceTask=!1,this._safetyBudget=0,this._debug=!1,this._debugHandle=a.init(o,"SCHEDULER_LOG_SLOW_TASKS",(function(e){return r._debug=e})),this._budget=new e.Budget(t);var i=this;this._test={state:void 0,FRAME_SAFETY_BUDGET:5,idleBudget:100,get budget(){return i._budget.budget},usedBudget:0,startTime:0,updateTask:function(e){return r._updateTask(e)},getState:function(e){return r._getState(e)},getRuntime:function(e){return r._getRuntime(e)}}}return t.prototype.destroy=function(){this._debugHandle&&this._debugHandle.remove()},t.prototype.registerTask=function(e,t,i){var n=this,s=c(e),u=new r(e,t,i,s);return this._tasks.push(u),{remove:function(){return n._removeTask(u)},set task(e){u.setPriority(e)}}},t.prototype.registerIdleStateCallbacks=function(e,t){var r=this,i={idleBegin:e,idleEnd:t};this._idleStateCallbacks.push(i),2===this.state&&this._idleUpdatesStartFired&&i.idleBegin();var n=this;return{remove:function(){return r._removeIdleStateCallbacks(i)},set idleBegin(e){n._idleUpdatesStartFired&&(i.idleEnd(),2===n._state&&e()),i.idleBegin=e},set idleEnd(e){i.idleEnd=e}}},Object.defineProperty(t.prototype,"now",{get:function(){return this._now()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"load",{get:function(){return this._load},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"state",{get:function(){return n.isNone(this._test.state)?this._state:this._test.state},set:function(e){this._state!==e&&(this._state=e,2!==this.state&&this._idleUpdatesStartFired&&(this._idleUpdatesStartFired=!1,this._idleStateCallbacks.forEach((function(e){return e.idleEnd()}))))},enumerable:!0,configurable:!0}),t.prototype.updateBudget=function(e){this._test.usedBudget=0,this._test.startTime=e.elapsedFrameTime,this._safetyBudget=5;var t=e.frameDuration,r=1;switch(this.state){case 2:this._safetyBudget=0,t=Math.max(100,e.frameDuration),r=30;break;case 1:t=Math.max(1e3/30,e.frameDuration)}return t-=e.elapsedFrameTime+this._safetyBudget,2!==this.state&&t<0&&!this._forceTask?(this._forceTask=!0,!1):(t=Math.max(t,r),this._budget.reset(t,this.state),this._maxReschedule=p,this._updateLoad(),this._schedule())},t.prototype.frame=function(){switch(this._forceTask=!1,this.state){case 2:this._idleUpdatesStartFired||(this._idleUpdatesStartFired=!0,this._idleStateCallbacks.forEach((function(e){return e.idleBegin()}))),this._runIdle();break;case 1:this._runInteracting();break;default:this._runAnimating()}this._test.usedBudget=this._budget.elapsed},t.prototype._removeIdleStateCallbacks=function(e){this._idleUpdatesStartFired&&e.idleEnd(),this._idleStateCallbacks.removeUnordered(e)},t.prototype._removeTask=function(e){this._tasks.removeUnordered(e),this._runQueue.removeUnordered(e)},t.prototype._updateTask=function(e){this._tasks.forEach((function(t){t.name===e&&t.setPriority(e)}))},t.prototype._getState=function(e){if(this._runQueue.some((function(t){return t.name===e})))return l.SCHEDULED;var t=l.IDLE;return this._tasks.forEach((function(r){r.name===e&&r.needsUpdate()&&(r.schedule<=1?t=l.READY:t!==l.READY&&(t=l.WAITING))})),t},t.prototype._getRuntime=function(e){var t=0;return this._tasks.forEach((function(r){r.name===e&&(t+=r.runtime)})),t},t.prototype._runIdle=function(){this._run()},t.prototype._runInteracting=function(){this._run()},t.prototype._runAnimating=function(){this._run()},t.prototype._updateLoad=function(){var e=0;this._tasks.forEach((function(t){return t.needsUpdate()?++e:e})),this._load=.9*this._load+e*(1-.9)},t.prototype._schedule=function(){var e=this;if(this._maxReschedule<=0)return!1;this._runQueue.filterInPlace((function(e){return!!e.needsUpdate()||(e.schedule=e.priority,!1)}));for(var t=function(){var t=!1,i=0;if(r._tasks.forEach((function(r){if(0!==r.schedule&&r.needsUpdate())switch(t=!0,i=Math.max(i,r.priority),r.schedule){case 1:r.schedule=0,e._runQueue.push(r);break;default:--r.schedule}})),!t)return{value:!1};r._maxReschedule===p&&(r._maxReschedule=i),--r._maxReschedule},r=this;0===this._runQueue.length;){var i=t();if("object"==typeof i)return i.value}return!0},t.prototype._run=function(){do{for(;this._runQueue.length>0;){var e=this._runQueue.pop();this._budget.resetProgress();var t=this._budget.now();try{e.update(this._budget)}catch(t){h.error('Exception in task "'+e.name+'"',t)}if(e.schedule=e.priority,e.runtime+=this._budget.now()-t,this._debug&&this._budget.elapsed>2*this._budget.budget&&console.log("Task",e.name,"used",this._budget.elapsed,"of max",this._budget.budget,"ms"),this._budget.remaining<=0)return}}while(this._schedule())},Object.defineProperty(t.prototype,"test",{get:function(){return this._test},enumerable:!0,configurable:!0}),t}();e.Scheduler=t;var r=function(){function e(e,t,r,i){this.name=e,this.update=t,this.needsUpdate=r,this._priority=i,this.runtime=0,this.schedule=this._priority}return Object.defineProperty(e.prototype,"priority",{get:function(){return this._priority},enumerable:!0,configurable:!0}),e.prototype.setPriority=function(e){this.name=e,this._priority=c(e),0!==this.schedule&&(this.schedule=this._priority)},e}(),i=function(){function e(e){this.now=e,this._begin=0,this._budget=0,this._state=2,this._didWork=!1,this._enabled=!0}return e.prototype.run=function(e){return!this.done&&(!0===e()&&(this._didWork=!0),!0)},Object.defineProperty(e.prototype,"done",{get:function(){return this._didWork&&this.elapsed>=this._budget&&this._enabled},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"budget",{get:function(){return this._budget},enumerable:!0,configurable:!0}),e.prototype.madeProgress=function(){this._didWork=!0},Object.defineProperty(e.prototype,"state",{get:function(){return this._state},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"enabled",{get:function(){return this._enabled},set:function(e){this._enabled=e},enumerable:!0,configurable:!0}),e.prototype.reset=function(e,t){this._begin=this.now(),this._budget=e,this._state=t,this._didWork=!1},Object.defineProperty(e.prototype,"remaining",{get:function(){return Math.max(this._budget-this.elapsed,0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"elapsed",{get:function(){return this.now()-this._begin},enumerable:!0,configurable:!0}),e.prototype.resetProgress=function(){this._didWork=!1},Object.defineProperty(e.prototype,"hasProgressed",{get:function(){return this._didWork},enumerable:!0,configurable:!0}),e}();e.Budget=i}(E||(E={})),function(e){e.SCHEDULED="s",e.READY="r",e.WAITING="w",e.IDLE="i"}(l=t.TaskState||(t.TaskState={})),t.noBudget=((f=new E.Budget(s)).enabled=!1,f);var p=r.MAX_SAFE_INTEGER}));