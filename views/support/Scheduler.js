/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/has","../../core/maybe","../../core/Logger","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/subclass","../../core/urlUtils","../../core/uuid","../../portal/support/resourceExtension","../../core/PerformanceSampler","../../core/PooledArray","../../core/promiseUtils","../../core/Accessor","../../core/watchUtils","../../layers/support/PromiseQueue","./debugFlags"],(function(e,t,s,i,r,n,a,u,o,_,d,h,c,l,T,E,f,g,p){"use strict";const I=n.getLogger("esri.views.support.Scheduler");var k;(k=e.Task||(e.Task={})).REMOTE_CLIENT="remote client",k.STREAM_DATA_LOADER="stream loader",k.ELEVATION_QUERY="elevation query",k.TERRAIN_SURFACE="terrain surface",k.SURFACE_GEOMETRY_UPDATES="surface geometry updates",k.GRAPHICS_CORE="Graphics3D",k.I3S_CONTROLLER="I3S",k.POINT_CLOUD_LAYER="point cloud",k.FEATURE_TILE_FETCHER="feature fetcher",k.FEATURE_FETCH_QUEUE="feature fetch queue",k.LABELER="labeler",k.GRAPHICS_DECONFLICTOR="graphics deconflictor",k.FILTER_VISIBILITY="Graphics3D filter visibility",k.FEATURE_QUERY_ENGINE="feature query",k.SCALE_VISIBILITY="Graphics3D scale visibility",k.FRUSTUM_VISIBILITY="Graphics3D frustum visibility",k.POINT_OF_INTEREST_FREQUENT="POI frequent",k.POINT_OF_INTEREST_INFREQUENT="POI infrequent",k.FEATURE_TILE_TREE="feature tile tree",k.FEATURE_TILE_TREE_ACTIVE="fast feature tile tree",k.ELEVATION_ALIGNMENT="elevation alignment",k.TEXT_TEXTURE_ATLAS="text texture atlas",k.TEXTURE_UNLOAD="texture unload",k.OVERLAY_MANAGER="overlay manager",k.LINE_OF_SIGHT_TOOL="line of sight tool",k.LINE_OF_SIGHT_TOOL_INTERACTIVE="interactive line of sight tool",k.ELEVATION_PROFILE="elevation profile",k[k.TEST_PRIO=1]="TEST_PRIO";const R={[e.Task.REMOTE_CLIENT]:1,[e.Task.STREAM_DATA_LOADER]:1,[e.Task.FEATURE_FETCH_QUEUE]:1,[e.Task.ELEVATION_QUERY]:1,[e.Task.TERRAIN_SURFACE]:2,[e.Task.SURFACE_GEOMETRY_UPDATES]:2,[e.Task.GRAPHICS_CORE]:3,[e.Task.I3S_CONTROLLER]:4,[e.Task.POINT_CLOUD_LAYER]:4,[e.Task.FEATURE_TILE_FETCHER]:4,[e.Task.LABELER]:8,[e.Task.GRAPHICS_DECONFLICTOR]:8,[e.Task.FILTER_VISIBILITY]:8,[e.Task.FEATURE_QUERY_ENGINE]:8,[e.Task.SCALE_VISIBILITY]:8,[e.Task.FRUSTUM_VISIBILITY]:8,[e.Task.POINT_OF_INTEREST_FREQUENT]:6,[e.Task.POINT_OF_INTEREST_INFREQUENT]:30,[e.Task.FEATURE_TILE_TREE]:16,[e.Task.FEATURE_TILE_TREE_ACTIVE]:1,[e.Task.ELEVATION_ALIGNMENT]:12,[e.Task.TEXT_TEXTURE_ATLAS]:12,[e.Task.TEXTURE_UNLOAD]:12,[e.Task.OVERLAY_MANAGER]:12,[e.Task.LINE_OF_SIGHT_TOOL]:16,[e.Task.LINE_OF_SIGHT_TOOL_INTERACTIVE]:1};function m(e){return e in R?R[e]:"number"==typeof e?e:1}const A=1e3/30;var S,b;!function(i){let n=function(){function s(t){this._now=t,this.updating=!0,this.performanceInfo={total:new c("total"),tasks:new Array},this._budget=null,this._state=1,this._tasks=new l,this._runQueue=new l,this._load=0,this._idleStateCallbacks=new l,this._idleUpdatesStartFired=!1,this._maxReschedule=y,this._forceTask=!1,this._safetyBudget=0,this._debug=!1,this._debugHandle=f.init(p,"SCHEDULER_LOG_SLOW_TASKS",(e=>this._debug=e)),this._budget=new _(t),N.length=0;for(const t in e.Task)O.set(e.Task[t],this.performanceInfo.tasks.length),this.performanceInfo.tasks.push(new c(e.Task[t])),N.push(0);let s;const i=this;this._test={get state(){return r.isNone(s)?i._state:s},set state(e){s=e},FRAME_SAFETY_BUDGET:5,INTERACTING_BUDGET:A,IDLE_BUDGET:100,get budget(){return i._budget.budget},usedBudget:0,updateTask:e=>this._updateTask(e),getState:e=>this._getState(e),getRuntime:e=>this._getRuntime(e),resetRuntimes:()=>this._resetRuntimes(),getRunning:()=>this._getRunning()}}var i=s.prototype;return i.destroy=function(){this._debugHandle&&this._debugHandle.remove()},i.registerTask=function(e,t,s){const i=m(e),r=new a(this,e,t,s,i);return this._tasks.push(r),r},i.registerIdleStateCallbacks=function(e,t){const s={idleBegin:e,idleEnd:t};this._idleStateCallbacks.push(s),2===this.state&&this._idleUpdatesStartFired&&s.idleBegin();const i=this;return{remove:()=>this._removeIdleStateCallbacks(s),set idleBegin(e){i._idleUpdatesStartFired&&(s.idleEnd(),2===i._state&&e()),s.idleBegin=e},set idleEnd(e){s.idleEnd=e}}},i.updateBudget=function(e){this._test.usedBudget=0,this._safetyBudget=5;let t=e.frameDuration,s=1;switch(this.state){case 2:this._safetyBudget=0,t=Math.max(100,e.frameDuration),s=30;break;case 1:t=Math.max(A,e.frameDuration)}return t-=e.elapsedFrameTime+this._safetyBudget,2!==this.state&&t<0&&!this._forceTask?(this._forceTask=!0,!1):(t=Math.max(t,s),this._budget.reset(t,this.state),this._maxReschedule=y,this._updateLoad(),this._schedule())},i.frame=function(){switch(this._forceTask=!1,this.state){case 2:this._idleUpdatesStartFired||(this._idleUpdatesStartFired=!0,this._idleStateCallbacks.forAll((e=>e.idleBegin()))),this._runIdle();break;case 1:this._runInteracting();break;default:this._runAnimating()}this._test.usedBudget=this._budget.elapsed},i._removeIdleStateCallbacks=function(e){this._idleUpdatesStartFired&&e.idleEnd(),this._idleStateCallbacks.removeUnordered(e)},i.removeTask=function(e){this._tasks.removeUnordered(e),this._runQueue.removeUnordered(e)},i._updateTask=function(e){this._tasks.forAll((t=>{t.name===e&&t.setPriority(e)}))},i._getState=function(t){if(this._runQueue.some((e=>e.name===t)))return e.TaskState.SCHEDULED;let s=e.TaskState.IDLE;return this._tasks.forAll((i=>{i.name===t&&i.needsUpdate&&(i.schedulePriority<=1?s=e.TaskState.READY:s!==e.TaskState.READY&&(s=e.TaskState.WAITING))})),s},i._getRuntime=function(e){let t=0;return this._tasks.forAll((s=>{s.name===e&&(t+=s.runtime)})),t},i._resetRuntimes=function(){this._tasks.forAll((e=>e.runtime=0))},i._getRunning=function(){const e=new Map;if(this._tasks.forAll((t=>{t.needsUpdate&&e.set(t.name,(e.get(t.name)||0)+1)})),0===e.size)return null;let t="";return e.forEach(((e,s)=>{t+=e>1?` ${e}x ${s}`:` ${s}`})),t},i._runIdle=function(){this._run()},i._runInteracting=function(){this._run()},i._runAnimating=function(){this._run()},i._updateLoad=function(){const e=this._tasks.reduce(((e,t)=>t.needsUpdate?++e:e),0);this._load=.9*this._load+e*(1-.9)},i._schedule=function(){if(this._maxReschedule<=0)return!1;for(this._runQueue.filterInPlace((e=>!!e.needsUpdate||(e.schedulePriority=e.priority,!1)));0===this._runQueue.length;){let e=!1,t=0;if(this._tasks.forAll((s=>{if(0!==s.schedulePriority&&s.needsUpdate)switch(e=!0,t=Math.max(t,s.priority),s.schedulePriority){case 1:s.schedulePriority=0,this._runQueue.push(s);break;default:--s.schedulePriority}})),!e)return this.updating=!1,!1;this._maxReschedule===y&&(this._maxReschedule=t),--this._maxReschedule}return this.updating=!0,!0},i._run=function(){const e=this._budget.now();for(let e=0;e<N.length;++e)N[e]=0;do{for(;this._runQueue.length>0;){const t=this._budget.now(),s=this._runQueue.pop();this._budget.resetProgress();try{s.processQueue(this._budget),!this._budget.done&&s.needsUpdate&&s.update(this._budget)}catch(e){I.error(`Exception in task "${s.name}"`,e)}s.schedulePriority=s.priority;const i=this._budget.now()-t;if(s.runtime+=i,N[O.get(s.task)]+=i,this._debug&&this._budget.elapsed>2*this._budget.budget&&console.log("Task",s.name,"used",this._budget.elapsed,"of max",this._budget.budget,"ms"),this._budget.remaining<=0)return void this._recordFrameTaskTimes(N,this._budget.now()-e)}}while(this._schedule());this._recordFrameTaskTimes(N,this._budget.now()-e)},i._recordFrameTaskTimes=function(e,t){for(let t=0;t<e.length;++t)this.performanceInfo.tasks[t].record(e[t]);this.performanceInfo.total.record(t)},t._createClass(s,[{key:"now",get:function(){return this._now()}},{key:"load",get:function(){return this._load}},{key:"state",set:function(e){this._state!==e&&(this._state=e,2!==this.state&&this._idleUpdatesStartFired&&(this._idleUpdatesStartFired=!1,this._idleStateCallbacks.forAll((e=>e.idleEnd()))))},get:function(){return r.isNone(this._test.state)?this._state:this._test.state}},{key:"test",get:function(){return this._test}}]),s}();i.Scheduler=n;let a=function(e){function s(t,s,i,r,n){var a;return(a=e.call(this,{})||this)._scheduler=t,a.name=s,a.update=i,a._needsUpdateCB=r,a._priority=n,a.runtime=0,a._queue=new g,a.updating=!1,a.schedulePriority=a._priority,a}t._inheritsLoose(s,e);var i=s.prototype;return i.normalizeCtorArgs=function(){return{}},i.remove=function(){this.processQueue(L),this._scheduler.removeTask(this)},i.setPriority=function(e){this.name=e,this._priority=m(e),0!==this.schedulePriority&&(this.schedulePriority=this._priority)},i.schedule=function(e,t){return this.updating=!0,this._queue.push(e,t)},i.reschedule=function(e,t){return this.updating=!0,this._queue.unshift(e,t)},i.processQueue=function(e){for(;!e.done&&this._queue.process();)e.madeProgress();0===this._queue.length&&(this.updating=!1)},t._createClass(s,[{key:"priority",get:function(){return this._priority}},{key:"task",get:function(){return this.name},set:function(e){this.setPriority(e)}},{key:"needsUpdate",get:function(){return this._queue.length>0||this._needsUpdateCB()}}]),s}(E);s.__decorate([u.property()],a.prototype,"updating",void 0),a=s.__decorate([o.subclass("esri.views.support.SchedulerTask")],a);let _=function(){function e(e){this.now=e,this._begin=0,this._budget=0,this._state=2,this._didWork=!1,this._enabled=!0}var s=e.prototype;return s.run=function(e){return!this.done&&(!0===e()&&(this._didWork=!0),!0)},s.madeProgress=function(){this._didWork=!0},s.reset=function(e,t){this._begin=this.now(),this._budget=e,this._state=t,this._didWork=!1},s.resetProgress=function(){this._didWork=!1},t._createClass(e,[{key:"done",get:function(){return this._didWork&&this.elapsed>=this._budget&&this._enabled}},{key:"budget",get:function(){return this._budget}},{key:"state",get:function(){return this._state}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"remaining",get:function(){return Math.max(this._budget-this.elapsed,0)}},{key:"elapsed",get:function(){return this.now()-this._begin}},{key:"hasProgressed",get:function(){return this._didWork}}]),e}();i.Budget=_}(S||(S={})),(b=e.TaskState||(e.TaskState={})).SCHEDULED="s",b.READY="r",b.WAITING="w",b.IDLE="i";const L=(()=>{const e=new S.Budget((()=>performance.now()));return e.enabled=!1,e})();const U=new(function(){function e(){}var t=e.prototype;return t.remove=function(){},t.schedule=function(e){return T.when(e())},t.reschedule=function(e){return T.when(e())},e}()),y=Number.MAX_SAFE_INTEGER,O=new Map,N=new Array;e.ImmediateTask=U,e.getTaskPriority=m,e.newScheduler=function(e){return new S.Scheduler(e)},e.noBudget=L,e.taskPriorities=R,Object.defineProperty(e,"__esModule",{value:!0})}));
